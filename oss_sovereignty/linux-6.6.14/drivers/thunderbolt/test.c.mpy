{
  "module_name": "test.c",
  "hash_id": "3464bff014cbf358b0361d3456ee20bf8c16ea8c3c798e3da91f5168cb22861e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thunderbolt/test.c",
  "human_readable_source": "\n \n\n#include <kunit/test.h>\n#include <linux/idr.h>\n\n#include \"tb.h\"\n#include \"tunnel.h\"\n\nstatic int __ida_init(struct kunit_resource *res, void *context)\n{\n\tstruct ida *ida = context;\n\n\tida_init(ida);\n\tres->data = ida;\n\treturn 0;\n}\n\nstatic void __ida_destroy(struct kunit_resource *res)\n{\n\tstruct ida *ida = res->data;\n\n\tida_destroy(ida);\n}\n\nstatic void kunit_ida_init(struct kunit *test, struct ida *ida)\n{\n\tkunit_alloc_resource(test, __ida_init, __ida_destroy, GFP_KERNEL, ida);\n}\n\nstatic struct tb_switch *alloc_switch(struct kunit *test, u64 route,\n\t\t\t\t      u8 upstream_port, u8 max_port_number)\n{\n\tstruct tb_switch *sw;\n\tsize_t size;\n\tint i;\n\n\tsw = kunit_kzalloc(test, sizeof(*sw), GFP_KERNEL);\n\tif (!sw)\n\t\treturn NULL;\n\n\tsw->config.upstream_port_number = upstream_port;\n\tsw->config.depth = tb_route_length(route);\n\tsw->config.route_hi = upper_32_bits(route);\n\tsw->config.route_lo = lower_32_bits(route);\n\tsw->config.enabled = 0;\n\tsw->config.max_port_number = max_port_number;\n\n\tsize = (sw->config.max_port_number + 1) * sizeof(*sw->ports);\n\tsw->ports = kunit_kzalloc(test, size, GFP_KERNEL);\n\tif (!sw->ports)\n\t\treturn NULL;\n\n\tfor (i = 0; i <= sw->config.max_port_number; i++) {\n\t\tsw->ports[i].sw = sw;\n\t\tsw->ports[i].port = i;\n\t\tsw->ports[i].config.port_number = i;\n\t\tif (i) {\n\t\t\tkunit_ida_init(test, &sw->ports[i].in_hopids);\n\t\t\tkunit_ida_init(test, &sw->ports[i].out_hopids);\n\t\t}\n\t}\n\n\treturn sw;\n}\n\nstatic struct tb_switch *alloc_host(struct kunit *test)\n{\n\tstruct tb_switch *sw;\n\n\tsw = alloc_switch(test, 0, 7, 13);\n\tif (!sw)\n\t\treturn NULL;\n\n\tsw->config.vendor_id = 0x8086;\n\tsw->config.device_id = 0x9a1b;\n\n\tsw->ports[0].config.type = TB_TYPE_PORT;\n\tsw->ports[0].config.max_in_hop_id = 7;\n\tsw->ports[0].config.max_out_hop_id = 7;\n\n\tsw->ports[1].config.type = TB_TYPE_PORT;\n\tsw->ports[1].config.max_in_hop_id = 19;\n\tsw->ports[1].config.max_out_hop_id = 19;\n\tsw->ports[1].total_credits = 60;\n\tsw->ports[1].ctl_credits = 2;\n\tsw->ports[1].dual_link_port = &sw->ports[2];\n\n\tsw->ports[2].config.type = TB_TYPE_PORT;\n\tsw->ports[2].config.max_in_hop_id = 19;\n\tsw->ports[2].config.max_out_hop_id = 19;\n\tsw->ports[2].total_credits = 60;\n\tsw->ports[2].ctl_credits = 2;\n\tsw->ports[2].dual_link_port = &sw->ports[1];\n\tsw->ports[2].link_nr = 1;\n\n\tsw->ports[3].config.type = TB_TYPE_PORT;\n\tsw->ports[3].config.max_in_hop_id = 19;\n\tsw->ports[3].config.max_out_hop_id = 19;\n\tsw->ports[3].total_credits = 60;\n\tsw->ports[3].ctl_credits = 2;\n\tsw->ports[3].dual_link_port = &sw->ports[4];\n\n\tsw->ports[4].config.type = TB_TYPE_PORT;\n\tsw->ports[4].config.max_in_hop_id = 19;\n\tsw->ports[4].config.max_out_hop_id = 19;\n\tsw->ports[4].total_credits = 60;\n\tsw->ports[4].ctl_credits = 2;\n\tsw->ports[4].dual_link_port = &sw->ports[3];\n\tsw->ports[4].link_nr = 1;\n\n\tsw->ports[5].config.type = TB_TYPE_DP_HDMI_IN;\n\tsw->ports[5].config.max_in_hop_id = 9;\n\tsw->ports[5].config.max_out_hop_id = 9;\n\tsw->ports[5].cap_adap = -1;\n\n\tsw->ports[6].config.type = TB_TYPE_DP_HDMI_IN;\n\tsw->ports[6].config.max_in_hop_id = 9;\n\tsw->ports[6].config.max_out_hop_id = 9;\n\tsw->ports[6].cap_adap = -1;\n\n\tsw->ports[7].config.type = TB_TYPE_NHI;\n\tsw->ports[7].config.max_in_hop_id = 11;\n\tsw->ports[7].config.max_out_hop_id = 11;\n\tsw->ports[7].config.nfc_credits = 0x41800000;\n\n\tsw->ports[8].config.type = TB_TYPE_PCIE_DOWN;\n\tsw->ports[8].config.max_in_hop_id = 8;\n\tsw->ports[8].config.max_out_hop_id = 8;\n\n\tsw->ports[9].config.type = TB_TYPE_PCIE_DOWN;\n\tsw->ports[9].config.max_in_hop_id = 8;\n\tsw->ports[9].config.max_out_hop_id = 8;\n\n\tsw->ports[10].disabled = true;\n\tsw->ports[11].disabled = true;\n\n\tsw->ports[12].config.type = TB_TYPE_USB3_DOWN;\n\tsw->ports[12].config.max_in_hop_id = 8;\n\tsw->ports[12].config.max_out_hop_id = 8;\n\n\tsw->ports[13].config.type = TB_TYPE_USB3_DOWN;\n\tsw->ports[13].config.max_in_hop_id = 8;\n\tsw->ports[13].config.max_out_hop_id = 8;\n\n\treturn sw;\n}\n\nstatic struct tb_switch *alloc_host_usb4(struct kunit *test)\n{\n\tstruct tb_switch *sw;\n\n\tsw = alloc_host(test);\n\tif (!sw)\n\t\treturn NULL;\n\n\tsw->generation = 4;\n\tsw->credit_allocation = true;\n\tsw->max_usb3_credits = 32;\n\tsw->min_dp_aux_credits = 1;\n\tsw->min_dp_main_credits = 0;\n\tsw->max_pcie_credits = 64;\n\tsw->max_dma_credits = 14;\n\n\treturn sw;\n}\n\nstatic struct tb_switch *alloc_host_br(struct kunit *test)\n{\n\tstruct tb_switch *sw;\n\n\tsw = alloc_host_usb4(test);\n\tif (!sw)\n\t\treturn NULL;\n\n\tsw->ports[10].config.type = TB_TYPE_DP_HDMI_IN;\n\tsw->ports[10].config.max_in_hop_id = 9;\n\tsw->ports[10].config.max_out_hop_id = 9;\n\tsw->ports[10].cap_adap = -1;\n\tsw->ports[10].disabled = false;\n\n\treturn sw;\n}\n\nstatic struct tb_switch *alloc_dev_default(struct kunit *test,\n\t\t\t\t\t   struct tb_switch *parent,\n\t\t\t\t\t   u64 route, bool bonded)\n{\n\tstruct tb_port *port, *upstream_port;\n\tstruct tb_switch *sw;\n\n\tsw = alloc_switch(test, route, 1, 19);\n\tif (!sw)\n\t\treturn NULL;\n\n\tsw->config.vendor_id = 0x8086;\n\tsw->config.device_id = 0x15ef;\n\n\tsw->ports[0].config.type = TB_TYPE_PORT;\n\tsw->ports[0].config.max_in_hop_id = 8;\n\tsw->ports[0].config.max_out_hop_id = 8;\n\n\tsw->ports[1].config.type = TB_TYPE_PORT;\n\tsw->ports[1].config.max_in_hop_id = 19;\n\tsw->ports[1].config.max_out_hop_id = 19;\n\tsw->ports[1].total_credits = 60;\n\tsw->ports[1].ctl_credits = 2;\n\tsw->ports[1].dual_link_port = &sw->ports[2];\n\n\tsw->ports[2].config.type = TB_TYPE_PORT;\n\tsw->ports[2].config.max_in_hop_id = 19;\n\tsw->ports[2].config.max_out_hop_id = 19;\n\tsw->ports[2].total_credits = 60;\n\tsw->ports[2].ctl_credits = 2;\n\tsw->ports[2].dual_link_port = &sw->ports[1];\n\tsw->ports[2].link_nr = 1;\n\n\tsw->ports[3].config.type = TB_TYPE_PORT;\n\tsw->ports[3].config.max_in_hop_id = 19;\n\tsw->ports[3].config.max_out_hop_id = 19;\n\tsw->ports[3].total_credits = 60;\n\tsw->ports[3].ctl_credits = 2;\n\tsw->ports[3].dual_link_port = &sw->ports[4];\n\n\tsw->ports[4].config.type = TB_TYPE_PORT;\n\tsw->ports[4].config.max_in_hop_id = 19;\n\tsw->ports[4].config.max_out_hop_id = 19;\n\tsw->ports[4].total_credits = 60;\n\tsw->ports[4].ctl_credits = 2;\n\tsw->ports[4].dual_link_port = &sw->ports[3];\n\tsw->ports[4].link_nr = 1;\n\n\tsw->ports[5].config.type = TB_TYPE_PORT;\n\tsw->ports[5].config.max_in_hop_id = 19;\n\tsw->ports[5].config.max_out_hop_id = 19;\n\tsw->ports[5].total_credits = 60;\n\tsw->ports[5].ctl_credits = 2;\n\tsw->ports[5].dual_link_port = &sw->ports[6];\n\n\tsw->ports[6].config.type = TB_TYPE_PORT;\n\tsw->ports[6].config.max_in_hop_id = 19;\n\tsw->ports[6].config.max_out_hop_id = 19;\n\tsw->ports[6].total_credits = 60;\n\tsw->ports[6].ctl_credits = 2;\n\tsw->ports[6].dual_link_port = &sw->ports[5];\n\tsw->ports[6].link_nr = 1;\n\n\tsw->ports[7].config.type = TB_TYPE_PORT;\n\tsw->ports[7].config.max_in_hop_id = 19;\n\tsw->ports[7].config.max_out_hop_id = 19;\n\tsw->ports[7].total_credits = 60;\n\tsw->ports[7].ctl_credits = 2;\n\tsw->ports[7].dual_link_port = &sw->ports[8];\n\n\tsw->ports[8].config.type = TB_TYPE_PORT;\n\tsw->ports[8].config.max_in_hop_id = 19;\n\tsw->ports[8].config.max_out_hop_id = 19;\n\tsw->ports[8].total_credits = 60;\n\tsw->ports[8].ctl_credits = 2;\n\tsw->ports[8].dual_link_port = &sw->ports[7];\n\tsw->ports[8].link_nr = 1;\n\n\tsw->ports[9].config.type = TB_TYPE_PCIE_UP;\n\tsw->ports[9].config.max_in_hop_id = 8;\n\tsw->ports[9].config.max_out_hop_id = 8;\n\n\tsw->ports[10].config.type = TB_TYPE_PCIE_DOWN;\n\tsw->ports[10].config.max_in_hop_id = 8;\n\tsw->ports[10].config.max_out_hop_id = 8;\n\n\tsw->ports[11].config.type = TB_TYPE_PCIE_DOWN;\n\tsw->ports[11].config.max_in_hop_id = 8;\n\tsw->ports[11].config.max_out_hop_id = 8;\n\n\tsw->ports[12].config.type = TB_TYPE_PCIE_DOWN;\n\tsw->ports[12].config.max_in_hop_id = 8;\n\tsw->ports[12].config.max_out_hop_id = 8;\n\n\tsw->ports[13].config.type = TB_TYPE_DP_HDMI_OUT;\n\tsw->ports[13].config.max_in_hop_id = 9;\n\tsw->ports[13].config.max_out_hop_id = 9;\n\tsw->ports[13].cap_adap = -1;\n\n\tsw->ports[14].config.type = TB_TYPE_DP_HDMI_OUT;\n\tsw->ports[14].config.max_in_hop_id = 9;\n\tsw->ports[14].config.max_out_hop_id = 9;\n\tsw->ports[14].cap_adap = -1;\n\n\tsw->ports[15].disabled = true;\n\n\tsw->ports[16].config.type = TB_TYPE_USB3_UP;\n\tsw->ports[16].config.max_in_hop_id = 8;\n\tsw->ports[16].config.max_out_hop_id = 8;\n\n\tsw->ports[17].config.type = TB_TYPE_USB3_DOWN;\n\tsw->ports[17].config.max_in_hop_id = 8;\n\tsw->ports[17].config.max_out_hop_id = 8;\n\n\tsw->ports[18].config.type = TB_TYPE_USB3_DOWN;\n\tsw->ports[18].config.max_in_hop_id = 8;\n\tsw->ports[18].config.max_out_hop_id = 8;\n\n\tsw->ports[19].config.type = TB_TYPE_USB3_DOWN;\n\tsw->ports[19].config.max_in_hop_id = 8;\n\tsw->ports[19].config.max_out_hop_id = 8;\n\n\tif (!parent)\n\t\treturn sw;\n\n\t \n\tupstream_port = tb_upstream_port(sw);\n\tport = tb_port_at(route, parent);\n\tport->remote = upstream_port;\n\tupstream_port->remote = port;\n\tif (port->dual_link_port && upstream_port->dual_link_port) {\n\t\tport->dual_link_port->remote = upstream_port->dual_link_port;\n\t\tupstream_port->dual_link_port->remote = port->dual_link_port;\n\n\t\tif (bonded) {\n\t\t\t \n\t\t\tport->bonded = true;\n\t\t\tport->total_credits *= 2;\n\t\t\tport->dual_link_port->bonded = true;\n\t\t\tport->dual_link_port->total_credits = 0;\n\t\t\tupstream_port->bonded = true;\n\t\t\tupstream_port->total_credits *= 2;\n\t\t\tupstream_port->dual_link_port->bonded = true;\n\t\t\tupstream_port->dual_link_port->total_credits = 0;\n\t\t}\n\t}\n\n\treturn sw;\n}\n\nstatic struct tb_switch *alloc_dev_with_dpin(struct kunit *test,\n\t\t\t\t\t     struct tb_switch *parent,\n\t\t\t\t\t     u64 route, bool bonded)\n{\n\tstruct tb_switch *sw;\n\n\tsw = alloc_dev_default(test, parent, route, bonded);\n\tif (!sw)\n\t\treturn NULL;\n\n\tsw->ports[13].config.type = TB_TYPE_DP_HDMI_IN;\n\tsw->ports[13].config.max_in_hop_id = 9;\n\tsw->ports[13].config.max_out_hop_id = 9;\n\n\tsw->ports[14].config.type = TB_TYPE_DP_HDMI_IN;\n\tsw->ports[14].config.max_in_hop_id = 9;\n\tsw->ports[14].config.max_out_hop_id = 9;\n\n\treturn sw;\n}\n\nstatic struct tb_switch *alloc_dev_without_dp(struct kunit *test,\n\t\t\t\t\t      struct tb_switch *parent,\n\t\t\t\t\t      u64 route, bool bonded)\n{\n\tstruct tb_switch *sw;\n\tint i;\n\n\tsw = alloc_dev_default(test, parent, route, bonded);\n\tif (!sw)\n\t\treturn NULL;\n\t \n\tfor (i = 5; i <= 8; i++)\n\t\tsw->ports[i].disabled = true;\n\n\tfor (i = 11; i <= 14; i++)\n\t\tsw->ports[i].disabled = true;\n\n\tsw->ports[13].cap_adap = 0;\n\tsw->ports[14].cap_adap = 0;\n\n\tfor (i = 18; i <= 19; i++)\n\t\tsw->ports[i].disabled = true;\n\n\tsw->generation = 4;\n\tsw->credit_allocation = true;\n\tsw->max_usb3_credits = 109;\n\tsw->min_dp_aux_credits = 0;\n\tsw->min_dp_main_credits = 0;\n\tsw->max_pcie_credits = 30;\n\tsw->max_dma_credits = 1;\n\n\treturn sw;\n}\n\nstatic struct tb_switch *alloc_dev_usb4(struct kunit *test,\n\t\t\t\t\tstruct tb_switch *parent,\n\t\t\t\t\tu64 route, bool bonded)\n{\n\tstruct tb_switch *sw;\n\n\tsw = alloc_dev_default(test, parent, route, bonded);\n\tif (!sw)\n\t\treturn NULL;\n\n\tsw->generation = 4;\n\tsw->credit_allocation = true;\n\tsw->max_usb3_credits = 14;\n\tsw->min_dp_aux_credits = 1;\n\tsw->min_dp_main_credits = 18;\n\tsw->max_pcie_credits = 32;\n\tsw->max_dma_credits = 14;\n\n\treturn sw;\n}\n\nstatic void tb_test_path_basic(struct kunit *test)\n{\n\tstruct tb_port *src_port, *dst_port, *p;\n\tstruct tb_switch *host;\n\n\thost = alloc_host(test);\n\n\tsrc_port = &host->ports[5];\n\tdst_port = src_port;\n\n\tp = tb_next_port_on_path(src_port, dst_port, NULL);\n\tKUNIT_EXPECT_PTR_EQ(test, p, dst_port);\n\n\tp = tb_next_port_on_path(src_port, dst_port, p);\n\tKUNIT_EXPECT_TRUE(test, !p);\n}\n\nstatic void tb_test_path_not_connected_walk(struct kunit *test)\n{\n\tstruct tb_port *src_port, *dst_port, *p;\n\tstruct tb_switch *host, *dev;\n\n\thost = alloc_host(test);\n\t \n\tdev = alloc_dev_default(test, NULL, 3, true);\n\n\tsrc_port = &host->ports[12];\n\tdst_port = &dev->ports[16];\n\n\tp = tb_next_port_on_path(src_port, dst_port, NULL);\n\tKUNIT_EXPECT_PTR_EQ(test, p, src_port);\n\n\tp = tb_next_port_on_path(src_port, dst_port, p);\n\tKUNIT_EXPECT_PTR_EQ(test, p, &host->ports[3]);\n\n\tp = tb_next_port_on_path(src_port, dst_port, p);\n\tKUNIT_EXPECT_TRUE(test, !p);\n\n\t \n\n\tp = tb_next_port_on_path(dst_port, src_port, NULL);\n\tKUNIT_EXPECT_PTR_EQ(test, p, dst_port);\n\n\tp = tb_next_port_on_path(dst_port, src_port, p);\n\tKUNIT_EXPECT_PTR_EQ(test, p, &dev->ports[1]);\n\n\tp = tb_next_port_on_path(dst_port, src_port, p);\n\tKUNIT_EXPECT_TRUE(test, !p);\n}\n\nstruct port_expectation {\n\tu64 route;\n\tu8 port;\n\tenum tb_port_type type;\n};\n\nstatic void tb_test_path_single_hop_walk(struct kunit *test)\n{\n\t \n\tstatic const struct port_expectation test_data[] = {\n\t\t{ .route = 0x0, .port = 8, .type = TB_TYPE_PCIE_DOWN },\n\t\t{ .route = 0x0, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x1, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x1, .port = 9, .type = TB_TYPE_PCIE_UP },\n\t};\n\tstruct tb_port *src_port, *dst_port, *p;\n\tstruct tb_switch *host, *dev;\n\tint i;\n\n\thost = alloc_host(test);\n\tdev = alloc_dev_default(test, host, 1, true);\n\n\tsrc_port = &host->ports[8];\n\tdst_port = &dev->ports[9];\n\n\t \n\n\ti = 0;\n\ttb_for_each_port_on_path(src_port, dst_port, p) {\n\t\tKUNIT_EXPECT_TRUE(test, i < ARRAY_SIZE(test_data));\n\t\tKUNIT_EXPECT_EQ(test, tb_route(p->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, p->port, test_data[i].port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)p->config.type,\n\t\t\t\ttest_data[i].type);\n\t\ti++;\n\t}\n\n\tKUNIT_EXPECT_EQ(test, i, ARRAY_SIZE(test_data));\n\n\ti = ARRAY_SIZE(test_data) - 1;\n\ttb_for_each_port_on_path(dst_port, src_port, p) {\n\t\tKUNIT_EXPECT_TRUE(test, i < ARRAY_SIZE(test_data));\n\t\tKUNIT_EXPECT_EQ(test, tb_route(p->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, p->port, test_data[i].port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)p->config.type,\n\t\t\t\ttest_data[i].type);\n\t\ti--;\n\t}\n\n\tKUNIT_EXPECT_EQ(test, i, -1);\n}\n\nstatic void tb_test_path_daisy_chain_walk(struct kunit *test)\n{\n\t \n\tstatic const struct port_expectation test_data[] = {\n\t\t{ .route = 0x0, .port = 5, .type = TB_TYPE_DP_HDMI_IN },\n\t\t{ .route = 0x0, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x1, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x1, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x301, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x301, .port = 13, .type = TB_TYPE_DP_HDMI_OUT },\n\t};\n\tstruct tb_port *src_port, *dst_port, *p;\n\tstruct tb_switch *host, *dev1, *dev2;\n\tint i;\n\n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\tdev2 = alloc_dev_default(test, dev1, 0x301, true);\n\n\tsrc_port = &host->ports[5];\n\tdst_port = &dev2->ports[13];\n\n\t \n\n\ti = 0;\n\ttb_for_each_port_on_path(src_port, dst_port, p) {\n\t\tKUNIT_EXPECT_TRUE(test, i < ARRAY_SIZE(test_data));\n\t\tKUNIT_EXPECT_EQ(test, tb_route(p->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, p->port, test_data[i].port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)p->config.type,\n\t\t\t\ttest_data[i].type);\n\t\ti++;\n\t}\n\n\tKUNIT_EXPECT_EQ(test, i, ARRAY_SIZE(test_data));\n\n\ti = ARRAY_SIZE(test_data) - 1;\n\ttb_for_each_port_on_path(dst_port, src_port, p) {\n\t\tKUNIT_EXPECT_TRUE(test, i < ARRAY_SIZE(test_data));\n\t\tKUNIT_EXPECT_EQ(test, tb_route(p->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, p->port, test_data[i].port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)p->config.type,\n\t\t\t\ttest_data[i].type);\n\t\ti--;\n\t}\n\n\tKUNIT_EXPECT_EQ(test, i, -1);\n}\n\nstatic void tb_test_path_simple_tree_walk(struct kunit *test)\n{\n\t \n\tstatic const struct port_expectation test_data[] = {\n\t\t{ .route = 0x0, .port = 5, .type = TB_TYPE_DP_HDMI_IN },\n\t\t{ .route = 0x0, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x1, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x1, .port = 5, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x501, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x501, .port = 13, .type = TB_TYPE_DP_HDMI_OUT },\n\t};\n\tstruct tb_port *src_port, *dst_port, *p;\n\tstruct tb_switch *host, *dev1, *dev3;\n\tint i;\n\n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\talloc_dev_default(test, dev1, 0x301, true);\n\tdev3 = alloc_dev_default(test, dev1, 0x501, true);\n\talloc_dev_default(test, dev1, 0x701, true);\n\n\tsrc_port = &host->ports[5];\n\tdst_port = &dev3->ports[13];\n\n\t \n\n\ti = 0;\n\ttb_for_each_port_on_path(src_port, dst_port, p) {\n\t\tKUNIT_EXPECT_TRUE(test, i < ARRAY_SIZE(test_data));\n\t\tKUNIT_EXPECT_EQ(test, tb_route(p->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, p->port, test_data[i].port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)p->config.type,\n\t\t\t\ttest_data[i].type);\n\t\ti++;\n\t}\n\n\tKUNIT_EXPECT_EQ(test, i, ARRAY_SIZE(test_data));\n\n\ti = ARRAY_SIZE(test_data) - 1;\n\ttb_for_each_port_on_path(dst_port, src_port, p) {\n\t\tKUNIT_EXPECT_TRUE(test, i < ARRAY_SIZE(test_data));\n\t\tKUNIT_EXPECT_EQ(test, tb_route(p->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, p->port, test_data[i].port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)p->config.type,\n\t\t\t\ttest_data[i].type);\n\t\ti--;\n\t}\n\n\tKUNIT_EXPECT_EQ(test, i, -1);\n}\n\nstatic void tb_test_path_complex_tree_walk(struct kunit *test)\n{\n\t \n\tstatic const struct port_expectation test_data[] = {\n\t\t{ .route = 0x50301, .port = 13, .type = TB_TYPE_DP_HDMI_IN },\n\t\t{ .route = 0x50301, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x301, .port = 5, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x301, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x1, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x1, .port = 7, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x701, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x701, .port = 7, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x70701, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x70701, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x3070701, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x3070701, .port = 5, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x503070701, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x503070701, .port = 14, .type = TB_TYPE_DP_HDMI_OUT },\n\t};\n\tstruct tb_switch *host, *dev1, *dev2, *dev3, *dev5, *dev6, *dev7, *dev9;\n\tstruct tb_port *src_port, *dst_port, *p;\n\tint i;\n\n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\tdev2 = alloc_dev_default(test, dev1, 0x301, true);\n\tdev3 = alloc_dev_with_dpin(test, dev2, 0x50301, true);\n\talloc_dev_default(test, dev1, 0x501, true);\n\tdev5 = alloc_dev_default(test, dev1, 0x701, true);\n\tdev6 = alloc_dev_default(test, dev5, 0x70701, true);\n\tdev7 = alloc_dev_default(test, dev6, 0x3070701, true);\n\talloc_dev_default(test, dev7, 0x303070701, true);\n\tdev9 = alloc_dev_default(test, dev7, 0x503070701, true);\n\n\tsrc_port = &dev3->ports[13];\n\tdst_port = &dev9->ports[14];\n\n\t \n\n\ti = 0;\n\ttb_for_each_port_on_path(src_port, dst_port, p) {\n\t\tKUNIT_EXPECT_TRUE(test, i < ARRAY_SIZE(test_data));\n\t\tKUNIT_EXPECT_EQ(test, tb_route(p->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, p->port, test_data[i].port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)p->config.type,\n\t\t\t\ttest_data[i].type);\n\t\ti++;\n\t}\n\n\tKUNIT_EXPECT_EQ(test, i, ARRAY_SIZE(test_data));\n\n\ti = ARRAY_SIZE(test_data) - 1;\n\ttb_for_each_port_on_path(dst_port, src_port, p) {\n\t\tKUNIT_EXPECT_TRUE(test, i < ARRAY_SIZE(test_data));\n\t\tKUNIT_EXPECT_EQ(test, tb_route(p->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, p->port, test_data[i].port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)p->config.type,\n\t\t\t\ttest_data[i].type);\n\t\ti--;\n\t}\n\n\tKUNIT_EXPECT_EQ(test, i, -1);\n}\n\nstatic void tb_test_path_max_length_walk(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev1, *dev2, *dev3, *dev4, *dev5, *dev6;\n\tstruct tb_switch *dev7, *dev8, *dev9, *dev10, *dev11, *dev12;\n\tstruct tb_port *src_port, *dst_port, *p;\n\tint i;\n\n\t \n\tstatic const struct port_expectation test_data[] = {\n\t\t{ .route = 0x30303030301, .port = 13, .type = TB_TYPE_DP_HDMI_IN },\n\t\t{ .route = 0x30303030301, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x303030301, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x303030301, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x3030301, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x3030301, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x30301, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x30301, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x301, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x301, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x1, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x1, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x0, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x0, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x3, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x3, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x303, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x303, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x30303, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x30303, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x3030303, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x3030303, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x303030303, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x303030303, .port = 3, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x30303030303, .port = 1, .type = TB_TYPE_PORT },\n\t\t{ .route = 0x30303030303, .port = 13, .type = TB_TYPE_DP_HDMI_OUT },\n\t};\n\n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\tdev2 = alloc_dev_default(test, dev1, 0x301, true);\n\tdev3 = alloc_dev_default(test, dev2, 0x30301, true);\n\tdev4 = alloc_dev_default(test, dev3, 0x3030301, true);\n\tdev5 = alloc_dev_default(test, dev4, 0x303030301, true);\n\tdev6 = alloc_dev_with_dpin(test, dev5, 0x30303030301, true);\n\tdev7 = alloc_dev_default(test, host, 0x3, true);\n\tdev8 = alloc_dev_default(test, dev7, 0x303, true);\n\tdev9 = alloc_dev_default(test, dev8, 0x30303, true);\n\tdev10 = alloc_dev_default(test, dev9, 0x3030303, true);\n\tdev11 = alloc_dev_default(test, dev10, 0x303030303, true);\n\tdev12 = alloc_dev_default(test, dev11, 0x30303030303, true);\n\n\tsrc_port = &dev6->ports[13];\n\tdst_port = &dev12->ports[13];\n\n\t \n\n\ti = 0;\n\ttb_for_each_port_on_path(src_port, dst_port, p) {\n\t\tKUNIT_EXPECT_TRUE(test, i < ARRAY_SIZE(test_data));\n\t\tKUNIT_EXPECT_EQ(test, tb_route(p->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, p->port, test_data[i].port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)p->config.type,\n\t\t\t\ttest_data[i].type);\n\t\ti++;\n\t}\n\n\tKUNIT_EXPECT_EQ(test, i, ARRAY_SIZE(test_data));\n\n\ti = ARRAY_SIZE(test_data) - 1;\n\ttb_for_each_port_on_path(dst_port, src_port, p) {\n\t\tKUNIT_EXPECT_TRUE(test, i < ARRAY_SIZE(test_data));\n\t\tKUNIT_EXPECT_EQ(test, tb_route(p->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, p->port, test_data[i].port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)p->config.type,\n\t\t\t\ttest_data[i].type);\n\t\ti--;\n\t}\n\n\tKUNIT_EXPECT_EQ(test, i, -1);\n}\n\nstatic void tb_test_path_not_connected(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev1, *dev2;\n\tstruct tb_port *down, *up;\n\tstruct tb_path *path;\n\n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x3, false);\n\t \n\tdev2 = alloc_dev_default(test, NULL, 0x303, false);\n\n\tdown = &dev1->ports[10];\n\tup = &dev2->ports[9];\n\n\tpath = tb_path_alloc(NULL, down, 8, up, 8, 0, \"PCIe Down\");\n\tKUNIT_ASSERT_NULL(test, path);\n\tpath = tb_path_alloc(NULL, down, 8, up, 8, 1, \"PCIe Down\");\n\tKUNIT_ASSERT_NULL(test, path);\n}\n\nstruct hop_expectation {\n\tu64 route;\n\tu8 in_port;\n\tenum tb_port_type in_type;\n\tu8 out_port;\n\tenum tb_port_type out_type;\n};\n\nstatic void tb_test_path_not_bonded_lane0(struct kunit *test)\n{\n\t \n\tstatic const struct hop_expectation test_data[] = {\n\t\t{\n\t\t\t.route = 0x0,\n\t\t\t.in_port = 9,\n\t\t\t.in_type = TB_TYPE_PCIE_DOWN,\n\t\t\t.out_port = 3,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x3,\n\t\t\t.in_port = 1,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 9,\n\t\t\t.out_type = TB_TYPE_PCIE_UP,\n\t\t},\n\t};\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *down, *up;\n\tstruct tb_path *path;\n\tint i;\n\n\thost = alloc_host(test);\n\tdev = alloc_dev_default(test, host, 0x3, false);\n\n\tdown = &host->ports[9];\n\tup = &dev->ports[9];\n\n\tpath = tb_path_alloc(NULL, down, 8, up, 8, 0, \"PCIe Down\");\n\tKUNIT_ASSERT_NOT_NULL(test, path);\n\tKUNIT_ASSERT_EQ(test, path->path_length, ARRAY_SIZE(test_data));\n\tfor (i = 0; i < ARRAY_SIZE(test_data); i++) {\n\t\tconst struct tb_port *in_port, *out_port;\n\n\t\tin_port = path->hops[i].in_port;\n\t\tout_port = path->hops[i].out_port;\n\n\t\tKUNIT_EXPECT_EQ(test, tb_route(in_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, in_port->port, test_data[i].in_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)in_port->config.type,\n\t\t\t\ttest_data[i].in_type);\n\t\tKUNIT_EXPECT_EQ(test, tb_route(out_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, out_port->port, test_data[i].out_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)out_port->config.type,\n\t\t\t\ttest_data[i].out_type);\n\t}\n\ttb_path_free(path);\n}\n\nstatic void tb_test_path_not_bonded_lane1(struct kunit *test)\n{\n\t \n\tstatic const struct hop_expectation test_data[] = {\n\t\t{\n\t\t\t.route = 0x0,\n\t\t\t.in_port = 5,\n\t\t\t.in_type = TB_TYPE_DP_HDMI_IN,\n\t\t\t.out_port = 2,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x1,\n\t\t\t.in_port = 2,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 13,\n\t\t\t.out_type = TB_TYPE_DP_HDMI_OUT,\n\t\t},\n\t};\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *in, *out;\n\tstruct tb_path *path;\n\tint i;\n\n\thost = alloc_host(test);\n\tdev = alloc_dev_default(test, host, 0x1, false);\n\n\tin = &host->ports[5];\n\tout = &dev->ports[13];\n\n\tpath = tb_path_alloc(NULL, in, 9, out, 9, 1, \"Video\");\n\tKUNIT_ASSERT_NOT_NULL(test, path);\n\tKUNIT_ASSERT_EQ(test, path->path_length, ARRAY_SIZE(test_data));\n\tfor (i = 0; i < ARRAY_SIZE(test_data); i++) {\n\t\tconst struct tb_port *in_port, *out_port;\n\n\t\tin_port = path->hops[i].in_port;\n\t\tout_port = path->hops[i].out_port;\n\n\t\tKUNIT_EXPECT_EQ(test, tb_route(in_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, in_port->port, test_data[i].in_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)in_port->config.type,\n\t\t\t\ttest_data[i].in_type);\n\t\tKUNIT_EXPECT_EQ(test, tb_route(out_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, out_port->port, test_data[i].out_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)out_port->config.type,\n\t\t\t\ttest_data[i].out_type);\n\t}\n\ttb_path_free(path);\n}\n\nstatic void tb_test_path_not_bonded_lane1_chain(struct kunit *test)\n{\n\t \n\tstatic const struct hop_expectation test_data[] = {\n\t\t{\n\t\t\t.route = 0x0,\n\t\t\t.in_port = 5,\n\t\t\t.in_type = TB_TYPE_DP_HDMI_IN,\n\t\t\t.out_port = 2,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x1,\n\t\t\t.in_port = 2,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 8,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x701,\n\t\t\t.in_port = 2,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 6,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x50701,\n\t\t\t.in_port = 2,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 13,\n\t\t\t.out_type = TB_TYPE_DP_HDMI_OUT,\n\t\t},\n\t};\n\tstruct tb_switch *host, *dev1, *dev2, *dev3;\n\tstruct tb_port *in, *out;\n\tstruct tb_path *path;\n\tint i;\n\n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, false);\n\tdev2 = alloc_dev_default(test, dev1, 0x701, false);\n\tdev3 = alloc_dev_default(test, dev2, 0x50701, false);\n\n\tin = &host->ports[5];\n\tout = &dev3->ports[13];\n\n\tpath = tb_path_alloc(NULL, in, 9, out, 9, 1, \"Video\");\n\tKUNIT_ASSERT_NOT_NULL(test, path);\n\tKUNIT_ASSERT_EQ(test, path->path_length, ARRAY_SIZE(test_data));\n\tfor (i = 0; i < ARRAY_SIZE(test_data); i++) {\n\t\tconst struct tb_port *in_port, *out_port;\n\n\t\tin_port = path->hops[i].in_port;\n\t\tout_port = path->hops[i].out_port;\n\n\t\tKUNIT_EXPECT_EQ(test, tb_route(in_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, in_port->port, test_data[i].in_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)in_port->config.type,\n\t\t\t\ttest_data[i].in_type);\n\t\tKUNIT_EXPECT_EQ(test, tb_route(out_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, out_port->port, test_data[i].out_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)out_port->config.type,\n\t\t\t\ttest_data[i].out_type);\n\t}\n\ttb_path_free(path);\n}\n\nstatic void tb_test_path_not_bonded_lane1_chain_reverse(struct kunit *test)\n{\n\t \n\tstatic const struct hop_expectation test_data[] = {\n\t\t{\n\t\t\t.route = 0x50701,\n\t\t\t.in_port = 13,\n\t\t\t.in_type = TB_TYPE_DP_HDMI_IN,\n\t\t\t.out_port = 2,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x701,\n\t\t\t.in_port = 6,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 2,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x1,\n\t\t\t.in_port = 8,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 2,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x0,\n\t\t\t.in_port = 2,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 5,\n\t\t\t.out_type = TB_TYPE_DP_HDMI_IN,\n\t\t},\n\t};\n\tstruct tb_switch *host, *dev1, *dev2, *dev3;\n\tstruct tb_port *in, *out;\n\tstruct tb_path *path;\n\tint i;\n\n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, false);\n\tdev2 = alloc_dev_default(test, dev1, 0x701, false);\n\tdev3 = alloc_dev_with_dpin(test, dev2, 0x50701, false);\n\n\tin = &dev3->ports[13];\n\tout = &host->ports[5];\n\n\tpath = tb_path_alloc(NULL, in, 9, out, 9, 1, \"Video\");\n\tKUNIT_ASSERT_NOT_NULL(test, path);\n\tKUNIT_ASSERT_EQ(test, path->path_length, ARRAY_SIZE(test_data));\n\tfor (i = 0; i < ARRAY_SIZE(test_data); i++) {\n\t\tconst struct tb_port *in_port, *out_port;\n\n\t\tin_port = path->hops[i].in_port;\n\t\tout_port = path->hops[i].out_port;\n\n\t\tKUNIT_EXPECT_EQ(test, tb_route(in_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, in_port->port, test_data[i].in_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)in_port->config.type,\n\t\t\t\ttest_data[i].in_type);\n\t\tKUNIT_EXPECT_EQ(test, tb_route(out_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, out_port->port, test_data[i].out_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)out_port->config.type,\n\t\t\t\ttest_data[i].out_type);\n\t}\n\ttb_path_free(path);\n}\n\nstatic void tb_test_path_mixed_chain(struct kunit *test)\n{\n\t \n\tstatic const struct hop_expectation test_data[] = {\n\t\t{\n\t\t\t.route = 0x0,\n\t\t\t.in_port = 5,\n\t\t\t.in_type = TB_TYPE_DP_HDMI_IN,\n\t\t\t.out_port = 1,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x1,\n\t\t\t.in_port = 1,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 8,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x701,\n\t\t\t.in_port = 2,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 6,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x50701,\n\t\t\t.in_port = 2,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 3,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x3050701,\n\t\t\t.in_port = 1,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 13,\n\t\t\t.out_type = TB_TYPE_DP_HDMI_OUT,\n\t\t},\n\t};\n\tstruct tb_switch *host, *dev1, *dev2, *dev3, *dev4;\n\tstruct tb_port *in, *out;\n\tstruct tb_path *path;\n\tint i;\n\n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\tdev2 = alloc_dev_default(test, dev1, 0x701, false);\n\tdev3 = alloc_dev_default(test, dev2, 0x50701, false);\n\tdev4 = alloc_dev_default(test, dev3, 0x3050701, true);\n\n\tin = &host->ports[5];\n\tout = &dev4->ports[13];\n\n\tpath = tb_path_alloc(NULL, in, 9, out, 9, 1, \"Video\");\n\tKUNIT_ASSERT_NOT_NULL(test, path);\n\tKUNIT_ASSERT_EQ(test, path->path_length, ARRAY_SIZE(test_data));\n\tfor (i = 0; i < ARRAY_SIZE(test_data); i++) {\n\t\tconst struct tb_port *in_port, *out_port;\n\n\t\tin_port = path->hops[i].in_port;\n\t\tout_port = path->hops[i].out_port;\n\n\t\tKUNIT_EXPECT_EQ(test, tb_route(in_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, in_port->port, test_data[i].in_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)in_port->config.type,\n\t\t\t\ttest_data[i].in_type);\n\t\tKUNIT_EXPECT_EQ(test, tb_route(out_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, out_port->port, test_data[i].out_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)out_port->config.type,\n\t\t\t\ttest_data[i].out_type);\n\t}\n\ttb_path_free(path);\n}\n\nstatic void tb_test_path_mixed_chain_reverse(struct kunit *test)\n{\n\t \n\tstatic const struct hop_expectation test_data[] = {\n\t\t{\n\t\t\t.route = 0x3050701,\n\t\t\t.in_port = 13,\n\t\t\t.in_type = TB_TYPE_DP_HDMI_OUT,\n\t\t\t.out_port = 1,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x50701,\n\t\t\t.in_port = 3,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 2,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x701,\n\t\t\t.in_port = 6,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 2,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x1,\n\t\t\t.in_port = 8,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 1,\n\t\t\t.out_type = TB_TYPE_PORT,\n\t\t},\n\t\t{\n\t\t\t.route = 0x0,\n\t\t\t.in_port = 1,\n\t\t\t.in_type = TB_TYPE_PORT,\n\t\t\t.out_port = 5,\n\t\t\t.out_type = TB_TYPE_DP_HDMI_IN,\n\t\t},\n\t};\n\tstruct tb_switch *host, *dev1, *dev2, *dev3, *dev4;\n\tstruct tb_port *in, *out;\n\tstruct tb_path *path;\n\tint i;\n\n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\tdev2 = alloc_dev_default(test, dev1, 0x701, false);\n\tdev3 = alloc_dev_default(test, dev2, 0x50701, false);\n\tdev4 = alloc_dev_default(test, dev3, 0x3050701, true);\n\n\tin = &dev4->ports[13];\n\tout = &host->ports[5];\n\n\tpath = tb_path_alloc(NULL, in, 9, out, 9, 1, \"Video\");\n\tKUNIT_ASSERT_NOT_NULL(test, path);\n\tKUNIT_ASSERT_EQ(test, path->path_length, ARRAY_SIZE(test_data));\n\tfor (i = 0; i < ARRAY_SIZE(test_data); i++) {\n\t\tconst struct tb_port *in_port, *out_port;\n\n\t\tin_port = path->hops[i].in_port;\n\t\tout_port = path->hops[i].out_port;\n\n\t\tKUNIT_EXPECT_EQ(test, tb_route(in_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, in_port->port, test_data[i].in_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)in_port->config.type,\n\t\t\t\ttest_data[i].in_type);\n\t\tKUNIT_EXPECT_EQ(test, tb_route(out_port->sw), test_data[i].route);\n\t\tKUNIT_EXPECT_EQ(test, out_port->port, test_data[i].out_port);\n\t\tKUNIT_EXPECT_EQ(test, (enum tb_port_type)out_port->config.type,\n\t\t\t\ttest_data[i].out_type);\n\t}\n\ttb_path_free(path);\n}\n\nstatic void tb_test_tunnel_pcie(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev1, *dev2;\n\tstruct tb_tunnel *tunnel1, *tunnel2;\n\tstruct tb_port *down, *up;\n\n\t \n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\tdev2 = alloc_dev_default(test, dev1, 0x501, true);\n\n\tdown = &host->ports[8];\n\tup = &dev1->ports[9];\n\ttunnel1 = tb_tunnel_alloc_pci(NULL, up, down);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel1);\n\tKUNIT_EXPECT_EQ(test, tunnel1->type, TB_TUNNEL_PCI);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->src_port, down);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->dst_port, up);\n\tKUNIT_ASSERT_EQ(test, tunnel1->npaths, 2);\n\tKUNIT_ASSERT_EQ(test, tunnel1->paths[0]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->paths[0]->hops[0].in_port, down);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->paths[0]->hops[1].out_port, up);\n\tKUNIT_ASSERT_EQ(test, tunnel1->paths[1]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->paths[1]->hops[0].in_port, up);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->paths[1]->hops[1].out_port, down);\n\n\tdown = &dev1->ports[10];\n\tup = &dev2->ports[9];\n\ttunnel2 = tb_tunnel_alloc_pci(NULL, up, down);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel2);\n\tKUNIT_EXPECT_EQ(test, tunnel2->type, TB_TUNNEL_PCI);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->src_port, down);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->dst_port, up);\n\tKUNIT_ASSERT_EQ(test, tunnel2->npaths, 2);\n\tKUNIT_ASSERT_EQ(test, tunnel2->paths[0]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->paths[0]->hops[0].in_port, down);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->paths[0]->hops[1].out_port, up);\n\tKUNIT_ASSERT_EQ(test, tunnel2->paths[1]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->paths[1]->hops[0].in_port, up);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->paths[1]->hops[1].out_port, down);\n\n\ttb_tunnel_free(tunnel2);\n\ttb_tunnel_free(tunnel1);\n}\n\nstatic void tb_test_tunnel_dp(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *in, *out;\n\tstruct tb_tunnel *tunnel;\n\n\t \n\thost = alloc_host(test);\n\tdev = alloc_dev_default(test, host, 0x3, true);\n\n\tin = &host->ports[5];\n\tout = &dev->ports[13];\n\n\ttunnel = tb_tunnel_alloc_dp(NULL, in, out, 1, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_EXPECT_EQ(test, tunnel->type, TB_TUNNEL_DP);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->src_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->dst_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, 3);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[0]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].in_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[1].out_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[1]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[0].in_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[1].out_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[2]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[2]->hops[0].in_port, out);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[2]->hops[1].out_port, in);\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_tunnel_dp_chain(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev1, *dev4;\n\tstruct tb_port *in, *out;\n\tstruct tb_tunnel *tunnel;\n\n\t \n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\talloc_dev_default(test, dev1, 0x301, true);\n\talloc_dev_default(test, dev1, 0x501, true);\n\tdev4 = alloc_dev_default(test, dev1, 0x701, true);\n\n\tin = &host->ports[5];\n\tout = &dev4->ports[14];\n\n\ttunnel = tb_tunnel_alloc_dp(NULL, in, out, 1, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_EXPECT_EQ(test, tunnel->type, TB_TUNNEL_DP);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->src_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->dst_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, 3);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[0]->path_length, 3);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].in_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[2].out_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[1]->path_length, 3);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[0].in_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[2].out_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[2]->path_length, 3);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[2]->hops[0].in_port, out);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[2]->hops[2].out_port, in);\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_tunnel_dp_tree(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev1, *dev2, *dev3, *dev5;\n\tstruct tb_port *in, *out;\n\tstruct tb_tunnel *tunnel;\n\n\t \n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x3, true);\n\tdev2 = alloc_dev_with_dpin(test, dev1, 0x303, true);\n\tdev3 = alloc_dev_default(test, dev1, 0x503, true);\n\talloc_dev_default(test, dev1, 0x703, true);\n\tdev5 = alloc_dev_default(test, dev3, 0x50503, true);\n\n\tin = &dev2->ports[13];\n\tout = &dev5->ports[13];\n\n\ttunnel = tb_tunnel_alloc_dp(NULL, in, out, 1, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_EXPECT_EQ(test, tunnel->type, TB_TUNNEL_DP);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->src_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->dst_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, 3);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[0]->path_length, 4);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].in_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[3].out_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[1]->path_length, 4);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[0].in_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[3].out_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[2]->path_length, 4);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[2]->hops[0].in_port, out);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[2]->hops[3].out_port, in);\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_tunnel_dp_max_length(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev1, *dev2, *dev3, *dev4, *dev5, *dev6;\n\tstruct tb_switch *dev7, *dev8, *dev9, *dev10, *dev11, *dev12;\n\tstruct tb_port *in, *out;\n\tstruct tb_tunnel *tunnel;\n\n\t \n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\tdev2 = alloc_dev_default(test, dev1, 0x301, true);\n\tdev3 = alloc_dev_default(test, dev2, 0x30301, true);\n\tdev4 = alloc_dev_default(test, dev3, 0x3030301, true);\n\tdev5 = alloc_dev_default(test, dev4, 0x303030301, true);\n\tdev6 = alloc_dev_with_dpin(test, dev5, 0x30303030301, true);\n\tdev7 = alloc_dev_default(test, host, 0x3, true);\n\tdev8 = alloc_dev_default(test, dev7, 0x303, true);\n\tdev9 = alloc_dev_default(test, dev8, 0x30303, true);\n\tdev10 = alloc_dev_default(test, dev9, 0x3030303, true);\n\tdev11 = alloc_dev_default(test, dev10, 0x303030303, true);\n\tdev12 = alloc_dev_default(test, dev11, 0x30303030303, true);\n\n\tin = &dev6->ports[13];\n\tout = &dev12->ports[13];\n\n\ttunnel = tb_tunnel_alloc_dp(NULL, in, out, 1, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_EXPECT_EQ(test, tunnel->type, TB_TUNNEL_DP);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->src_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->dst_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, 3);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[0]->path_length, 13);\n\t \n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].in_port, in);\n\t \n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[6].in_port,\n\t\t\t    &host->ports[1]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[6].out_port,\n\t\t\t    &host->ports[3]);\n\t \n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[12].out_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[1]->path_length, 13);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[0].in_port, in);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[6].in_port,\n\t\t\t    &host->ports[1]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[6].out_port,\n\t\t\t    &host->ports[3]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[12].out_port, out);\n\tKUNIT_ASSERT_EQ(test, tunnel->paths[2]->path_length, 13);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[2]->hops[0].in_port, out);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[2]->hops[6].in_port,\n\t\t\t    &host->ports[3]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[2]->hops[6].out_port,\n\t\t\t    &host->ports[1]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[2]->hops[12].out_port, in);\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_tunnel_3dp(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev1, *dev2, *dev3, *dev4, *dev5;\n\tstruct tb_port *in1, *in2, *in3, *out1, *out2, *out3;\n\tstruct tb_tunnel *tunnel1, *tunnel2, *tunnel3;\n\n\t \n\thost = alloc_host_br(test);\n\tdev1 = alloc_dev_default(test, host, 0x3, true);\n\tdev2 = alloc_dev_default(test, dev1, 0x303, true);\n\tdev3 = alloc_dev_default(test, dev1, 0x503, true);\n\tdev4 = alloc_dev_default(test, dev1, 0x703, true);\n\tdev5 = alloc_dev_default(test, dev3, 0x50503, true);\n\n\tin1 = &host->ports[5];\n\tin2 = &host->ports[6];\n\tin3 = &host->ports[10];\n\n\tout1 = &dev2->ports[13];\n\tout2 = &dev5->ports[13];\n\tout3 = &dev4->ports[14];\n\n\ttunnel1 = tb_tunnel_alloc_dp(NULL, in1, out1, 1, 0, 0);\n\tKUNIT_ASSERT_TRUE(test, tunnel1 != NULL);\n\tKUNIT_EXPECT_EQ(test, tunnel1->type, TB_TUNNEL_DP);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->src_port, in1);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->dst_port, out1);\n\tKUNIT_ASSERT_EQ(test, tunnel1->npaths, 3);\n\tKUNIT_ASSERT_EQ(test, tunnel1->paths[0]->path_length, 3);\n\n\ttunnel2 = tb_tunnel_alloc_dp(NULL, in2, out2, 1, 0, 0);\n\tKUNIT_ASSERT_TRUE(test, tunnel2 != NULL);\n\tKUNIT_EXPECT_EQ(test, tunnel2->type, TB_TUNNEL_DP);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->src_port, in2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->dst_port, out2);\n\tKUNIT_ASSERT_EQ(test, tunnel2->npaths, 3);\n\tKUNIT_ASSERT_EQ(test, tunnel2->paths[0]->path_length, 4);\n\n\ttunnel3 = tb_tunnel_alloc_dp(NULL, in3, out3, 1, 0, 0);\n\tKUNIT_ASSERT_TRUE(test, tunnel3 != NULL);\n\tKUNIT_EXPECT_EQ(test, tunnel3->type, TB_TUNNEL_DP);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel3->src_port, in3);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel3->dst_port, out3);\n\tKUNIT_ASSERT_EQ(test, tunnel3->npaths, 3);\n\tKUNIT_ASSERT_EQ(test, tunnel3->paths[0]->path_length, 3);\n\n\ttb_tunnel_free(tunnel2);\n\ttb_tunnel_free(tunnel1);\n}\n\nstatic void tb_test_tunnel_usb3(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev1, *dev2;\n\tstruct tb_tunnel *tunnel1, *tunnel2;\n\tstruct tb_port *down, *up;\n\n\t \n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\tdev2 = alloc_dev_default(test, dev1, 0x701, true);\n\n\tdown = &host->ports[12];\n\tup = &dev1->ports[16];\n\ttunnel1 = tb_tunnel_alloc_usb3(NULL, up, down, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel1);\n\tKUNIT_EXPECT_EQ(test, tunnel1->type, TB_TUNNEL_USB3);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->src_port, down);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->dst_port, up);\n\tKUNIT_ASSERT_EQ(test, tunnel1->npaths, 2);\n\tKUNIT_ASSERT_EQ(test, tunnel1->paths[0]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->paths[0]->hops[0].in_port, down);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->paths[0]->hops[1].out_port, up);\n\tKUNIT_ASSERT_EQ(test, tunnel1->paths[1]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->paths[1]->hops[0].in_port, up);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel1->paths[1]->hops[1].out_port, down);\n\n\tdown = &dev1->ports[17];\n\tup = &dev2->ports[16];\n\ttunnel2 = tb_tunnel_alloc_usb3(NULL, up, down, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel2);\n\tKUNIT_EXPECT_EQ(test, tunnel2->type, TB_TUNNEL_USB3);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->src_port, down);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->dst_port, up);\n\tKUNIT_ASSERT_EQ(test, tunnel2->npaths, 2);\n\tKUNIT_ASSERT_EQ(test, tunnel2->paths[0]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->paths[0]->hops[0].in_port, down);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->paths[0]->hops[1].out_port, up);\n\tKUNIT_ASSERT_EQ(test, tunnel2->paths[1]->path_length, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->paths[1]->hops[0].in_port, up);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel2->paths[1]->hops[1].out_port, down);\n\n\ttb_tunnel_free(tunnel2);\n\ttb_tunnel_free(tunnel1);\n}\n\nstatic void tb_test_tunnel_port_on_path(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev1, *dev2, *dev3, *dev4, *dev5;\n\tstruct tb_port *in, *out, *port;\n\tstruct tb_tunnel *dp_tunnel;\n\n\t \n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x3, true);\n\tdev2 = alloc_dev_with_dpin(test, dev1, 0x303, true);\n\tdev3 = alloc_dev_default(test, dev1, 0x503, true);\n\tdev4 = alloc_dev_default(test, dev1, 0x703, true);\n\tdev5 = alloc_dev_default(test, dev3, 0x50503, true);\n\n\tin = &dev2->ports[13];\n\tout = &dev5->ports[13];\n\n\tdp_tunnel = tb_tunnel_alloc_dp(NULL, in, out, 1, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, dp_tunnel);\n\n\tKUNIT_EXPECT_TRUE(test, tb_tunnel_port_on_path(dp_tunnel, in));\n\tKUNIT_EXPECT_TRUE(test, tb_tunnel_port_on_path(dp_tunnel, out));\n\n\tport = &host->ports[8];\n\tKUNIT_EXPECT_FALSE(test, tb_tunnel_port_on_path(dp_tunnel, port));\n\n\tport = &host->ports[3];\n\tKUNIT_EXPECT_FALSE(test, tb_tunnel_port_on_path(dp_tunnel, port));\n\n\tport = &dev1->ports[1];\n\tKUNIT_EXPECT_FALSE(test, tb_tunnel_port_on_path(dp_tunnel, port));\n\n\tport = &dev1->ports[3];\n\tKUNIT_EXPECT_TRUE(test, tb_tunnel_port_on_path(dp_tunnel, port));\n\n\tport = &dev1->ports[5];\n\tKUNIT_EXPECT_TRUE(test, tb_tunnel_port_on_path(dp_tunnel, port));\n\n\tport = &dev1->ports[7];\n\tKUNIT_EXPECT_FALSE(test, tb_tunnel_port_on_path(dp_tunnel, port));\n\n\tport = &dev3->ports[1];\n\tKUNIT_EXPECT_TRUE(test, tb_tunnel_port_on_path(dp_tunnel, port));\n\n\tport = &dev5->ports[1];\n\tKUNIT_EXPECT_TRUE(test, tb_tunnel_port_on_path(dp_tunnel, port));\n\n\tport = &dev4->ports[1];\n\tKUNIT_EXPECT_FALSE(test, tb_tunnel_port_on_path(dp_tunnel, port));\n\n\ttb_tunnel_free(dp_tunnel);\n}\n\nstatic void tb_test_tunnel_dma(struct kunit *test)\n{\n\tstruct tb_port *nhi, *port;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_switch *host;\n\n\t \n\thost = alloc_host(test);\n\tnhi = &host->ports[7];\n\tport = &host->ports[1];\n\n\ttunnel = tb_tunnel_alloc_dma(NULL, nhi, port, 8, 1, 8, 1);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_EXPECT_EQ(test, tunnel->type, TB_TUNNEL_DMA);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->src_port, nhi);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->dst_port, port);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, 2);\n\t \n\tKUNIT_ASSERT_EQ(test, tunnel->paths[0]->path_length, 1);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].in_port, port);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[0]->hops[0].in_hop_index, 8);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].out_port, nhi);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[0]->hops[0].next_hop_index, 1);\n\t \n\tKUNIT_ASSERT_EQ(test, tunnel->paths[1]->path_length, 1);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[0].in_port, nhi);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[1]->hops[0].in_hop_index, 1);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[0].out_port, port);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[1]->hops[0].next_hop_index, 8);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_tunnel_dma_rx(struct kunit *test)\n{\n\tstruct tb_port *nhi, *port;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_switch *host;\n\n\t \n\thost = alloc_host(test);\n\tnhi = &host->ports[7];\n\tport = &host->ports[1];\n\n\ttunnel = tb_tunnel_alloc_dma(NULL, nhi, port, -1, -1, 15, 2);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_EXPECT_EQ(test, tunnel->type, TB_TUNNEL_DMA);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->src_port, nhi);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->dst_port, port);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, 1);\n\t \n\tKUNIT_ASSERT_EQ(test, tunnel->paths[0]->path_length, 1);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].in_port, port);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[0]->hops[0].in_hop_index, 15);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].out_port, nhi);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[0]->hops[0].next_hop_index, 2);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_tunnel_dma_tx(struct kunit *test)\n{\n\tstruct tb_port *nhi, *port;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_switch *host;\n\n\t \n\thost = alloc_host(test);\n\tnhi = &host->ports[7];\n\tport = &host->ports[1];\n\n\ttunnel = tb_tunnel_alloc_dma(NULL, nhi, port, 15, 2, -1, -1);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_EXPECT_EQ(test, tunnel->type, TB_TUNNEL_DMA);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->src_port, nhi);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->dst_port, port);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, 1);\n\t \n\tKUNIT_ASSERT_EQ(test, tunnel->paths[0]->path_length, 1);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].in_port, nhi);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[0]->hops[0].in_hop_index, 2);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].out_port, port);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[0]->hops[0].next_hop_index, 15);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_tunnel_dma_chain(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev1, *dev2;\n\tstruct tb_port *nhi, *port;\n\tstruct tb_tunnel *tunnel;\n\n\t \n\thost = alloc_host(test);\n\tdev1 = alloc_dev_default(test, host, 0x1, true);\n\tdev2 = alloc_dev_default(test, dev1, 0x701, true);\n\n\tnhi = &host->ports[7];\n\tport = &dev2->ports[3];\n\ttunnel = tb_tunnel_alloc_dma(NULL, nhi, port, 8, 1, 8, 1);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_EXPECT_EQ(test, tunnel->type, TB_TUNNEL_DMA);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->src_port, nhi);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->dst_port, port);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, 2);\n\t \n\tKUNIT_ASSERT_EQ(test, tunnel->paths[0]->path_length, 3);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].in_port, port);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[0]->hops[0].in_hop_index, 8);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[0].out_port,\n\t\t\t    &dev2->ports[1]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[1].in_port,\n\t\t\t    &dev1->ports[7]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[1].out_port,\n\t\t\t    &dev1->ports[1]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[2].in_port,\n\t\t\t    &host->ports[1]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[0]->hops[2].out_port, nhi);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[0]->hops[2].next_hop_index, 1);\n\t \n\tKUNIT_ASSERT_EQ(test, tunnel->paths[1]->path_length, 3);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[0].in_port, nhi);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[1]->hops[0].in_hop_index, 1);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[1].in_port,\n\t\t\t    &dev1->ports[1]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[1].out_port,\n\t\t\t    &dev1->ports[7]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[2].in_port,\n\t\t\t    &dev2->ports[1]);\n\tKUNIT_EXPECT_PTR_EQ(test, tunnel->paths[1]->hops[2].out_port, port);\n\tKUNIT_EXPECT_EQ(test, tunnel->paths[1]->hops[2].next_hop_index, 8);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_tunnel_dma_match(struct kunit *test)\n{\n\tstruct tb_port *nhi, *port;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_switch *host;\n\n\thost = alloc_host(test);\n\tnhi = &host->ports[7];\n\tport = &host->ports[1];\n\n\ttunnel = tb_tunnel_alloc_dma(NULL, nhi, port, 15, 1, 15, 1);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, 15, 1, 15, 1));\n\tKUNIT_ASSERT_FALSE(test, tb_tunnel_match_dma(tunnel, 8, 1, 15, 1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, -1, 15, 1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, 15, 1, -1, -1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, 15, -1, -1, -1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, 1, -1, -1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, -1, 15, -1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, -1, -1, 1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, -1, -1, -1));\n\tKUNIT_ASSERT_FALSE(test, tb_tunnel_match_dma(tunnel, 8, -1, 8, -1));\n\n\ttb_tunnel_free(tunnel);\n\n\ttunnel = tb_tunnel_alloc_dma(NULL, nhi, port, 15, 1, -1, -1);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, 15, 1, -1, -1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, 15, -1, -1, -1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, 1, -1, -1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, -1, -1, -1));\n\tKUNIT_ASSERT_FALSE(test, tb_tunnel_match_dma(tunnel, 15, 1, 15, 1));\n\tKUNIT_ASSERT_FALSE(test, tb_tunnel_match_dma(tunnel, -1, -1, 15, 1));\n\tKUNIT_ASSERT_FALSE(test, tb_tunnel_match_dma(tunnel, 15, 11, -1, -1));\n\n\ttb_tunnel_free(tunnel);\n\n\ttunnel = tb_tunnel_alloc_dma(NULL, nhi, port, -1, -1, 15, 11);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, -1, 15, 11));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, -1, 15, -1));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, -1, -1, 11));\n\tKUNIT_ASSERT_TRUE(test, tb_tunnel_match_dma(tunnel, -1, -1, -1, -1));\n\tKUNIT_ASSERT_FALSE(test, tb_tunnel_match_dma(tunnel, -1, -1, 15, 1));\n\tKUNIT_ASSERT_FALSE(test, tb_tunnel_match_dma(tunnel, -1, -1, 10, 11));\n\tKUNIT_ASSERT_FALSE(test, tb_tunnel_match_dma(tunnel, 15, 11, -1, -1));\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_credit_alloc_legacy_not_bonded(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *up, *down;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_path *path;\n\n\thost = alloc_host(test);\n\tdev = alloc_dev_default(test, host, 0x1, false);\n\n\tdown = &host->ports[8];\n\tup = &dev->ports[9];\n\ttunnel = tb_tunnel_alloc_pci(NULL, up, down);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, (size_t)2);\n\n\tpath = tunnel->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 16U);\n\n\tpath = tunnel->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 16U);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_credit_alloc_legacy_bonded(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *up, *down;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_path *path;\n\n\thost = alloc_host(test);\n\tdev = alloc_dev_default(test, host, 0x1, true);\n\n\tdown = &host->ports[8];\n\tup = &dev->ports[9];\n\ttunnel = tb_tunnel_alloc_pci(NULL, up, down);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, (size_t)2);\n\n\tpath = tunnel->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 32U);\n\n\tpath = tunnel->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 32U);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_credit_alloc_pcie(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *up, *down;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_path *path;\n\n\thost = alloc_host_usb4(test);\n\tdev = alloc_dev_usb4(test, host, 0x1, true);\n\n\tdown = &host->ports[8];\n\tup = &dev->ports[9];\n\ttunnel = tb_tunnel_alloc_pci(NULL, up, down);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, (size_t)2);\n\n\tpath = tunnel->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 32U);\n\n\tpath = tunnel->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 64U);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_credit_alloc_without_dp(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *up, *down;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_path *path;\n\n\thost = alloc_host_usb4(test);\n\tdev = alloc_dev_without_dp(test, host, 0x1, true);\n\n\t \n\tdown = &host->ports[8];\n\tup = &dev->ports[9];\n\ttunnel = tb_tunnel_alloc_pci(NULL, up, down);\n\tKUNIT_ASSERT_TRUE(test, tunnel != NULL);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, (size_t)2);\n\n\t \n\tpath = tunnel->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 9U);\n\n\t \n\tpath = tunnel->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 64U);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_credit_alloc_dp(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *in, *out;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_path *path;\n\n\thost = alloc_host_usb4(test);\n\tdev = alloc_dev_usb4(test, host, 0x1, true);\n\n\tin = &host->ports[5];\n\tout = &dev->ports[14];\n\n\ttunnel = tb_tunnel_alloc_dp(NULL, in, out, 1, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, (size_t)3);\n\n\t \n\tpath = tunnel->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 12U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 18U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 0U);\n\n\t \n\tpath = tunnel->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 1U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 1U);\n\n\t \n\tpath = tunnel->paths[2];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 1U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 1U);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_credit_alloc_usb3(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *up, *down;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_path *path;\n\n\thost = alloc_host_usb4(test);\n\tdev = alloc_dev_usb4(test, host, 0x1, true);\n\n\tdown = &host->ports[12];\n\tup = &dev->ports[16];\n\ttunnel = tb_tunnel_alloc_usb3(NULL, up, down, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, (size_t)2);\n\n\tpath = tunnel->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 14U);\n\n\tpath = tunnel->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 32U);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_credit_alloc_dma(struct kunit *test)\n{\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *nhi, *port;\n\tstruct tb_tunnel *tunnel;\n\tstruct tb_path *path;\n\n\thost = alloc_host_usb4(test);\n\tdev = alloc_dev_usb4(test, host, 0x1, true);\n\n\tnhi = &host->ports[7];\n\tport = &dev->ports[3];\n\n\ttunnel = tb_tunnel_alloc_dma(NULL, nhi, port, 8, 1, 8, 1);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel);\n\tKUNIT_ASSERT_EQ(test, tunnel->npaths, (size_t)2);\n\n\t \n\tpath = tunnel->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 14U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 14U);\n\n\t \n\tpath = tunnel->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 14U);\n\n\ttb_tunnel_free(tunnel);\n}\n\nstatic void tb_test_credit_alloc_dma_multiple(struct kunit *test)\n{\n\tstruct tb_tunnel *tunnel1, *tunnel2, *tunnel3;\n\tstruct tb_switch *host, *dev;\n\tstruct tb_port *nhi, *port;\n\tstruct tb_path *path;\n\n\thost = alloc_host_usb4(test);\n\tdev = alloc_dev_usb4(test, host, 0x1, true);\n\n\tnhi = &host->ports[7];\n\tport = &dev->ports[3];\n\n\t \n\ttunnel1 = tb_tunnel_alloc_dma(NULL, nhi, port, 8, 1, 8, 1);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel1);\n\tKUNIT_ASSERT_EQ(test, tunnel1->npaths, (size_t)2);\n\n\tpath = tunnel1->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 14U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 14U);\n\n\tpath = tunnel1->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 14U);\n\n\ttunnel2 = tb_tunnel_alloc_dma(NULL, nhi, port, 9, 2, 9, 2);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel2);\n\tKUNIT_ASSERT_EQ(test, tunnel2->npaths, (size_t)2);\n\n\tpath = tunnel2->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 14U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 1U);\n\n\tpath = tunnel2->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 1U);\n\n\ttunnel3 = tb_tunnel_alloc_dma(NULL, nhi, port, 10, 3, 10, 3);\n\tKUNIT_ASSERT_NULL(test, tunnel3);\n\n\t \n\ttb_tunnel_free(tunnel1);\n\n\ttunnel3 = tb_tunnel_alloc_dma(NULL, nhi, port, 10, 3, 10, 3);\n\tKUNIT_ASSERT_NOT_NULL(test, tunnel3);\n\n\tpath = tunnel3->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 14U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 14U);\n\n\tpath = tunnel3->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 14U);\n\n\ttb_tunnel_free(tunnel3);\n\ttb_tunnel_free(tunnel2);\n}\n\nstatic struct tb_tunnel *TB_TEST_PCIE_TUNNEL(struct kunit *test,\n\t\t\tstruct tb_switch *host, struct tb_switch *dev)\n{\n\tstruct tb_port *up, *down;\n\tstruct tb_tunnel *pcie_tunnel;\n\tstruct tb_path *path;\n\n\tdown = &host->ports[8];\n\tup = &dev->ports[9];\n\tpcie_tunnel = tb_tunnel_alloc_pci(NULL, up, down);\n\tKUNIT_ASSERT_NOT_NULL(test, pcie_tunnel);\n\tKUNIT_ASSERT_EQ(test, pcie_tunnel->npaths, (size_t)2);\n\n\tpath = pcie_tunnel->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 32U);\n\n\tpath = pcie_tunnel->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 64U);\n\n\treturn pcie_tunnel;\n}\n\nstatic struct tb_tunnel *TB_TEST_DP_TUNNEL1(struct kunit *test,\n\t\t\tstruct tb_switch *host, struct tb_switch *dev)\n{\n\tstruct tb_port *in, *out;\n\tstruct tb_tunnel *dp_tunnel1;\n\tstruct tb_path *path;\n\n\tin = &host->ports[5];\n\tout = &dev->ports[13];\n\tdp_tunnel1 = tb_tunnel_alloc_dp(NULL, in, out, 1, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, dp_tunnel1);\n\tKUNIT_ASSERT_EQ(test, dp_tunnel1->npaths, (size_t)3);\n\n\tpath = dp_tunnel1->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 12U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 18U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 0U);\n\n\tpath = dp_tunnel1->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 1U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 1U);\n\n\tpath = dp_tunnel1->paths[2];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 1U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 1U);\n\n\treturn dp_tunnel1;\n}\n\nstatic struct tb_tunnel *TB_TEST_DP_TUNNEL2(struct kunit *test,\n\t\t\tstruct tb_switch *host, struct tb_switch *dev)\n{\n\tstruct tb_port *in, *out;\n\tstruct tb_tunnel *dp_tunnel2;\n\tstruct tb_path *path;\n\n\tin = &host->ports[6];\n\tout = &dev->ports[14];\n\tdp_tunnel2 = tb_tunnel_alloc_dp(NULL, in, out, 1, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, dp_tunnel2);\n\tKUNIT_ASSERT_EQ(test, dp_tunnel2->npaths, (size_t)3);\n\n\tpath = dp_tunnel2->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 12U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 18U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 0U);\n\n\tpath = dp_tunnel2->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 1U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 1U);\n\n\tpath = dp_tunnel2->paths[2];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 1U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 1U);\n\n\treturn dp_tunnel2;\n}\n\nstatic struct tb_tunnel *TB_TEST_USB3_TUNNEL(struct kunit *test,\n\t\t\tstruct tb_switch *host, struct tb_switch *dev)\n{\n\tstruct tb_port *up, *down;\n\tstruct tb_tunnel *usb3_tunnel;\n\tstruct tb_path *path;\n\n\tdown = &host->ports[12];\n\tup = &dev->ports[16];\n\tusb3_tunnel = tb_tunnel_alloc_usb3(NULL, up, down, 0, 0);\n\tKUNIT_ASSERT_NOT_NULL(test, usb3_tunnel);\n\tKUNIT_ASSERT_EQ(test, usb3_tunnel->npaths, (size_t)2);\n\n\tpath = usb3_tunnel->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 14U);\n\n\tpath = usb3_tunnel->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 7U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 32U);\n\n\treturn usb3_tunnel;\n}\n\nstatic struct tb_tunnel *TB_TEST_DMA_TUNNEL1(struct kunit *test,\n\t\t\tstruct tb_switch *host, struct tb_switch *dev)\n{\n\tstruct tb_port *nhi, *port;\n\tstruct tb_tunnel *dma_tunnel1;\n\tstruct tb_path *path;\n\n\tnhi = &host->ports[7];\n\tport = &dev->ports[3];\n\tdma_tunnel1 = tb_tunnel_alloc_dma(NULL, nhi, port, 8, 1, 8, 1);\n\tKUNIT_ASSERT_NOT_NULL(test, dma_tunnel1);\n\tKUNIT_ASSERT_EQ(test, dma_tunnel1->npaths, (size_t)2);\n\n\tpath = dma_tunnel1->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 14U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 14U);\n\n\tpath = dma_tunnel1->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 14U);\n\n\treturn dma_tunnel1;\n}\n\nstatic struct tb_tunnel *TB_TEST_DMA_TUNNEL2(struct kunit *test,\n\t\t\tstruct tb_switch *host, struct tb_switch *dev)\n{\n\tstruct tb_port *nhi, *port;\n\tstruct tb_tunnel *dma_tunnel2;\n\tstruct tb_path *path;\n\n\tnhi = &host->ports[7];\n\tport = &dev->ports[3];\n\tdma_tunnel2 = tb_tunnel_alloc_dma(NULL, nhi, port, 9, 2, 9, 2);\n\tKUNIT_ASSERT_NOT_NULL(test, dma_tunnel2);\n\tKUNIT_ASSERT_EQ(test, dma_tunnel2->npaths, (size_t)2);\n\n\tpath = dma_tunnel2->paths[0];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 14U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 1U);\n\n\tpath = dma_tunnel2->paths[1];\n\tKUNIT_ASSERT_EQ(test, path->path_length, 2);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[0].initial_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].nfc_credits, 0U);\n\tKUNIT_EXPECT_EQ(test, path->hops[1].initial_credits, 1U);\n\n\treturn dma_tunnel2;\n}\n\nstatic void tb_test_credit_alloc_all(struct kunit *test)\n{\n\tstruct tb_tunnel *pcie_tunnel, *dp_tunnel1, *dp_tunnel2, *usb3_tunnel;\n\tstruct tb_tunnel *dma_tunnel1, *dma_tunnel2;\n\tstruct tb_switch *host, *dev;\n\n\t \n\n\thost = alloc_host_usb4(test);\n\tdev = alloc_dev_usb4(test, host, 0x1, true);\n\n\tpcie_tunnel = TB_TEST_PCIE_TUNNEL(test, host, dev);\n\tdp_tunnel1 = TB_TEST_DP_TUNNEL1(test, host, dev);\n\tdp_tunnel2 = TB_TEST_DP_TUNNEL2(test, host, dev);\n\tusb3_tunnel = TB_TEST_USB3_TUNNEL(test, host, dev);\n\tdma_tunnel1 = TB_TEST_DMA_TUNNEL1(test, host, dev);\n\tdma_tunnel2 = TB_TEST_DMA_TUNNEL2(test, host, dev);\n\n\ttb_tunnel_free(dma_tunnel2);\n\ttb_tunnel_free(dma_tunnel1);\n\ttb_tunnel_free(usb3_tunnel);\n\ttb_tunnel_free(dp_tunnel2);\n\ttb_tunnel_free(dp_tunnel1);\n\ttb_tunnel_free(pcie_tunnel);\n}\n\nstatic const u32 root_directory[] = {\n\t0x55584401,\t \n\t0x00000018,\t \n\t0x76656e64,\t \n\t0x6f726964,\t \n\t0x76000001,\t \n\t0x00000a27,\t \n\t0x76656e64,\t \n\t0x6f726964,\t \n\t0x74000003,\t \n\t0x0000001a,\t \n\t0x64657669,\t \n\t0x63656964,\t \n\t0x76000001,\t \n\t0x0000000a,\t \n\t0x64657669,\t \n\t0x63656964,\t \n\t0x74000003,\t \n\t0x0000001d,\t \n\t0x64657669,\t \n\t0x63657276,\t \n\t0x76000001,\t \n\t0x80000100,\t \n\t0x6e657477,\t \n\t0x6f726b00,\t \n\t0x44000014,\t \n\t0x00000021,\t \n\t0x4170706c,\t \n\t0x6520496e,\t \n\t0x632e0000,\t \n\t0x4d616369,\t \n\t0x6e746f73,\t \n\t0x68000000,\t \n\t0x00000000,\t \n\t0xca8961c6,\t \n\t0x9541ce1c,\t \n\t0x5949b8bd,\t \n\t0x4f5a5f2e,\t \n\t0x70727463,\t \n\t0x69640000,\t \n\t0x76000001,\t \n\t0x00000001,\t \n\t0x70727463,\t \n\t0x76657273,\t \n\t0x76000001,\t \n\t0x00000001,\t \n\t0x70727463,\t \n\t0x72657673,\t \n\t0x76000001,\t \n\t0x00000001,\t \n\t0x70727463,\t \n\t0x73746e73,\t \n\t0x76000001,\t \n\t0x00000000,\t \n};\n\nstatic const uuid_t network_dir_uuid =\n\tUUID_INIT(0xc66189ca, 0x1cce, 0x4195,\n\t\t  0xbd, 0xb8, 0x49, 0x59, 0x2e, 0x5f, 0x5a, 0x4f);\n\nstatic void tb_test_property_parse(struct kunit *test)\n{\n\tstruct tb_property_dir *dir, *network_dir;\n\tstruct tb_property *p;\n\n\tdir = tb_property_parse_dir(root_directory, ARRAY_SIZE(root_directory));\n\tKUNIT_ASSERT_NOT_NULL(test, dir);\n\n\tp = tb_property_find(dir, \"foo\", TB_PROPERTY_TYPE_TEXT);\n\tKUNIT_ASSERT_NULL(test, p);\n\n\tp = tb_property_find(dir, \"vendorid\", TB_PROPERTY_TYPE_TEXT);\n\tKUNIT_ASSERT_NOT_NULL(test, p);\n\tKUNIT_EXPECT_STREQ(test, p->value.text, \"Apple Inc.\");\n\n\tp = tb_property_find(dir, \"vendorid\", TB_PROPERTY_TYPE_VALUE);\n\tKUNIT_ASSERT_NOT_NULL(test, p);\n\tKUNIT_EXPECT_EQ(test, p->value.immediate, 0xa27);\n\n\tp = tb_property_find(dir, \"deviceid\", TB_PROPERTY_TYPE_TEXT);\n\tKUNIT_ASSERT_NOT_NULL(test, p);\n\tKUNIT_EXPECT_STREQ(test, p->value.text, \"Macintosh\");\n\n\tp = tb_property_find(dir, \"deviceid\", TB_PROPERTY_TYPE_VALUE);\n\tKUNIT_ASSERT_NOT_NULL(test, p);\n\tKUNIT_EXPECT_EQ(test, p->value.immediate, 0xa);\n\n\tp = tb_property_find(dir, \"missing\", TB_PROPERTY_TYPE_DIRECTORY);\n\tKUNIT_ASSERT_NULL(test, p);\n\n\tp = tb_property_find(dir, \"network\", TB_PROPERTY_TYPE_DIRECTORY);\n\tKUNIT_ASSERT_NOT_NULL(test, p);\n\n\tnetwork_dir = p->value.dir;\n\tKUNIT_EXPECT_TRUE(test, uuid_equal(network_dir->uuid, &network_dir_uuid));\n\n\tp = tb_property_find(network_dir, \"prtcid\", TB_PROPERTY_TYPE_VALUE);\n\tKUNIT_ASSERT_NOT_NULL(test, p);\n\tKUNIT_EXPECT_EQ(test, p->value.immediate, 0x1);\n\n\tp = tb_property_find(network_dir, \"prtcvers\", TB_PROPERTY_TYPE_VALUE);\n\tKUNIT_ASSERT_NOT_NULL(test, p);\n\tKUNIT_EXPECT_EQ(test, p->value.immediate, 0x1);\n\n\tp = tb_property_find(network_dir, \"prtcrevs\", TB_PROPERTY_TYPE_VALUE);\n\tKUNIT_ASSERT_NOT_NULL(test, p);\n\tKUNIT_EXPECT_EQ(test, p->value.immediate, 0x1);\n\n\tp = tb_property_find(network_dir, \"prtcstns\", TB_PROPERTY_TYPE_VALUE);\n\tKUNIT_ASSERT_NOT_NULL(test, p);\n\tKUNIT_EXPECT_EQ(test, p->value.immediate, 0x0);\n\n\tp = tb_property_find(network_dir, \"deviceid\", TB_PROPERTY_TYPE_VALUE);\n\tKUNIT_EXPECT_TRUE(test, !p);\n\tp = tb_property_find(network_dir, \"deviceid\", TB_PROPERTY_TYPE_TEXT);\n\tKUNIT_EXPECT_TRUE(test, !p);\n\n\ttb_property_free_dir(dir);\n}\n\nstatic void tb_test_property_format(struct kunit *test)\n{\n\tstruct tb_property_dir *dir;\n\tssize_t block_len;\n\tu32 *block;\n\tint ret, i;\n\n\tdir = tb_property_parse_dir(root_directory, ARRAY_SIZE(root_directory));\n\tKUNIT_ASSERT_NOT_NULL(test, dir);\n\n\tret = tb_property_format_dir(dir, NULL, 0);\n\tKUNIT_ASSERT_EQ(test, ret, ARRAY_SIZE(root_directory));\n\n\tblock_len = ret;\n\n\tblock = kunit_kzalloc(test, block_len * sizeof(u32), GFP_KERNEL);\n\tKUNIT_ASSERT_NOT_NULL(test, block);\n\n\tret = tb_property_format_dir(dir, block, block_len);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\tfor (i = 0; i < ARRAY_SIZE(root_directory); i++)\n\t\tKUNIT_EXPECT_EQ(test, root_directory[i], block[i]);\n\n\ttb_property_free_dir(dir);\n}\n\nstatic void compare_dirs(struct kunit *test, struct tb_property_dir *d1,\n\t\t\t struct tb_property_dir *d2)\n{\n\tstruct tb_property *p1, *p2, *tmp;\n\tint n1, n2, i;\n\n\tif (d1->uuid) {\n\t\tKUNIT_ASSERT_NOT_NULL(test, d2->uuid);\n\t\tKUNIT_ASSERT_TRUE(test, uuid_equal(d1->uuid, d2->uuid));\n\t} else {\n\t\tKUNIT_ASSERT_NULL(test, d2->uuid);\n\t}\n\n\tn1 = 0;\n\ttb_property_for_each(d1, tmp)\n\t\tn1++;\n\tKUNIT_ASSERT_NE(test, n1, 0);\n\n\tn2 = 0;\n\ttb_property_for_each(d2, tmp)\n\t\tn2++;\n\tKUNIT_ASSERT_NE(test, n2, 0);\n\n\tKUNIT_ASSERT_EQ(test, n1, n2);\n\n\tp1 = NULL;\n\tp2 = NULL;\n\tfor (i = 0; i < n1; i++) {\n\t\tp1 = tb_property_get_next(d1, p1);\n\t\tKUNIT_ASSERT_NOT_NULL(test, p1);\n\t\tp2 = tb_property_get_next(d2, p2);\n\t\tKUNIT_ASSERT_NOT_NULL(test, p2);\n\n\t\tKUNIT_ASSERT_STREQ(test, &p1->key[0], &p2->key[0]);\n\t\tKUNIT_ASSERT_EQ(test, p1->type, p2->type);\n\t\tKUNIT_ASSERT_EQ(test, p1->length, p2->length);\n\n\t\tswitch (p1->type) {\n\t\tcase TB_PROPERTY_TYPE_DIRECTORY:\n\t\t\tKUNIT_ASSERT_NOT_NULL(test, p1->value.dir);\n\t\t\tKUNIT_ASSERT_NOT_NULL(test, p2->value.dir);\n\t\t\tcompare_dirs(test, p1->value.dir, p2->value.dir);\n\t\t\tbreak;\n\n\t\tcase TB_PROPERTY_TYPE_DATA:\n\t\t\tKUNIT_ASSERT_NOT_NULL(test, p1->value.data);\n\t\t\tKUNIT_ASSERT_NOT_NULL(test, p2->value.data);\n\t\t\tKUNIT_ASSERT_TRUE(test,\n\t\t\t\t!memcmp(p1->value.data, p2->value.data,\n\t\t\t\t\tp1->length * 4)\n\t\t\t);\n\t\t\tbreak;\n\n\t\tcase TB_PROPERTY_TYPE_TEXT:\n\t\t\tKUNIT_ASSERT_NOT_NULL(test, p1->value.text);\n\t\t\tKUNIT_ASSERT_NOT_NULL(test, p2->value.text);\n\t\t\tKUNIT_ASSERT_STREQ(test, p1->value.text, p2->value.text);\n\t\t\tbreak;\n\n\t\tcase TB_PROPERTY_TYPE_VALUE:\n\t\t\tKUNIT_ASSERT_EQ(test, p1->value.immediate,\n\t\t\t\t\tp2->value.immediate);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tKUNIT_FAIL(test, \"unexpected property type\");\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic void tb_test_property_copy(struct kunit *test)\n{\n\tstruct tb_property_dir *src, *dst;\n\tu32 *block;\n\tint ret, i;\n\n\tsrc = tb_property_parse_dir(root_directory, ARRAY_SIZE(root_directory));\n\tKUNIT_ASSERT_NOT_NULL(test, src);\n\n\tdst = tb_property_copy_dir(src);\n\tKUNIT_ASSERT_NOT_NULL(test, dst);\n\n\t \n\tcompare_dirs(test, src, dst);\n\n\t \n\tret = tb_property_format_dir(dst, NULL, 0);\n\tKUNIT_ASSERT_EQ(test, ret, ARRAY_SIZE(root_directory));\n\n\tblock = kunit_kzalloc(test, sizeof(root_directory), GFP_KERNEL);\n\tKUNIT_ASSERT_NOT_NULL(test, block);\n\n\tret = tb_property_format_dir(dst, block, ARRAY_SIZE(root_directory));\n\tKUNIT_EXPECT_TRUE(test, !ret);\n\n\tfor (i = 0; i < ARRAY_SIZE(root_directory); i++)\n\t\tKUNIT_EXPECT_EQ(test, root_directory[i], block[i]);\n\n\ttb_property_free_dir(dst);\n\ttb_property_free_dir(src);\n}\n\nstatic struct kunit_case tb_test_cases[] = {\n\tKUNIT_CASE(tb_test_path_basic),\n\tKUNIT_CASE(tb_test_path_not_connected_walk),\n\tKUNIT_CASE(tb_test_path_single_hop_walk),\n\tKUNIT_CASE(tb_test_path_daisy_chain_walk),\n\tKUNIT_CASE(tb_test_path_simple_tree_walk),\n\tKUNIT_CASE(tb_test_path_complex_tree_walk),\n\tKUNIT_CASE(tb_test_path_max_length_walk),\n\tKUNIT_CASE(tb_test_path_not_connected),\n\tKUNIT_CASE(tb_test_path_not_bonded_lane0),\n\tKUNIT_CASE(tb_test_path_not_bonded_lane1),\n\tKUNIT_CASE(tb_test_path_not_bonded_lane1_chain),\n\tKUNIT_CASE(tb_test_path_not_bonded_lane1_chain_reverse),\n\tKUNIT_CASE(tb_test_path_mixed_chain),\n\tKUNIT_CASE(tb_test_path_mixed_chain_reverse),\n\tKUNIT_CASE(tb_test_tunnel_pcie),\n\tKUNIT_CASE(tb_test_tunnel_dp),\n\tKUNIT_CASE(tb_test_tunnel_dp_chain),\n\tKUNIT_CASE(tb_test_tunnel_dp_tree),\n\tKUNIT_CASE(tb_test_tunnel_dp_max_length),\n\tKUNIT_CASE(tb_test_tunnel_3dp),\n\tKUNIT_CASE(tb_test_tunnel_port_on_path),\n\tKUNIT_CASE(tb_test_tunnel_usb3),\n\tKUNIT_CASE(tb_test_tunnel_dma),\n\tKUNIT_CASE(tb_test_tunnel_dma_rx),\n\tKUNIT_CASE(tb_test_tunnel_dma_tx),\n\tKUNIT_CASE(tb_test_tunnel_dma_chain),\n\tKUNIT_CASE(tb_test_tunnel_dma_match),\n\tKUNIT_CASE(tb_test_credit_alloc_legacy_not_bonded),\n\tKUNIT_CASE(tb_test_credit_alloc_legacy_bonded),\n\tKUNIT_CASE(tb_test_credit_alloc_pcie),\n\tKUNIT_CASE(tb_test_credit_alloc_without_dp),\n\tKUNIT_CASE(tb_test_credit_alloc_dp),\n\tKUNIT_CASE(tb_test_credit_alloc_usb3),\n\tKUNIT_CASE(tb_test_credit_alloc_dma),\n\tKUNIT_CASE(tb_test_credit_alloc_dma_multiple),\n\tKUNIT_CASE(tb_test_credit_alloc_all),\n\tKUNIT_CASE(tb_test_property_parse),\n\tKUNIT_CASE(tb_test_property_format),\n\tKUNIT_CASE(tb_test_property_copy),\n\t{ }\n};\n\nstatic struct kunit_suite tb_test_suite = {\n\t.name = \"thunderbolt\",\n\t.test_cases = tb_test_cases,\n};\n\nkunit_test_suite(tb_test_suite);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}