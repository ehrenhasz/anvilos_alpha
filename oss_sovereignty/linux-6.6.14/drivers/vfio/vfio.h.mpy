{
  "module_name": "vfio.h",
  "hash_id": "02ba2ce566b5974eb5d7ab7508e9cfeb3bdad2d7c7713262f88076a2295f64d2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vfio/vfio.h",
  "human_readable_source": " \n \n#ifndef __VFIO_VFIO_H__\n#define __VFIO_VFIO_H__\n\n#include <linux/file.h>\n#include <linux/device.h>\n#include <linux/cdev.h>\n#include <linux/module.h>\n#include <linux/vfio.h>\n\nstruct iommufd_ctx;\nstruct iommu_group;\nstruct vfio_container;\n\nstruct vfio_device_file {\n\tstruct vfio_device *device;\n\tstruct vfio_group *group;\n\n\tu8 access_granted;\n\tu32 devid;  \n\tspinlock_t kvm_ref_lock;  \n\tstruct kvm *kvm;\n\tstruct iommufd_ctx *iommufd;  \n};\n\nvoid vfio_device_put_registration(struct vfio_device *device);\nbool vfio_device_try_get_registration(struct vfio_device *device);\nint vfio_df_open(struct vfio_device_file *df);\nvoid vfio_df_close(struct vfio_device_file *df);\nstruct vfio_device_file *\nvfio_allocate_device_file(struct vfio_device *device);\n\nextern const struct file_operations vfio_device_fops;\n\n#ifdef CONFIG_VFIO_NOIOMMU\nextern bool vfio_noiommu __read_mostly;\n#else\nenum { vfio_noiommu = false };\n#endif\n\nenum vfio_group_type {\n\t \n\tVFIO_IOMMU,\n\n\t \n\tVFIO_EMULATED_IOMMU,\n\n\t \n\tVFIO_NO_IOMMU,\n};\n\n#if IS_ENABLED(CONFIG_VFIO_GROUP)\nstruct vfio_group {\n\tstruct device \t\t\tdev;\n\tstruct cdev\t\t\tcdev;\n\t \n\trefcount_t\t\t\tdrivers;\n\tunsigned int\t\t\tcontainer_users;\n\tstruct iommu_group\t\t*iommu_group;\n\tstruct vfio_container\t\t*container;\n\tstruct list_head\t\tdevice_list;\n\tstruct mutex\t\t\tdevice_lock;\n\tstruct list_head\t\tvfio_next;\n#if IS_ENABLED(CONFIG_VFIO_CONTAINER)\n\tstruct list_head\t\tcontainer_next;\n#endif\n\tenum vfio_group_type\t\ttype;\n\tstruct mutex\t\t\tgroup_lock;\n\tstruct kvm\t\t\t*kvm;\n\tstruct file\t\t\t*opened_file;\n\tstruct blocking_notifier_head\tnotifier;\n\tstruct iommufd_ctx\t\t*iommufd;\n\tspinlock_t\t\t\tkvm_ref_lock;\n\tunsigned int\t\t\tcdev_device_open_cnt;\n};\n\nint vfio_device_block_group(struct vfio_device *device);\nvoid vfio_device_unblock_group(struct vfio_device *device);\nint vfio_device_set_group(struct vfio_device *device,\n\t\t\t  enum vfio_group_type type);\nvoid vfio_device_remove_group(struct vfio_device *device);\nvoid vfio_device_group_register(struct vfio_device *device);\nvoid vfio_device_group_unregister(struct vfio_device *device);\nint vfio_device_group_use_iommu(struct vfio_device *device);\nvoid vfio_device_group_unuse_iommu(struct vfio_device *device);\nvoid vfio_df_group_close(struct vfio_device_file *df);\nstruct vfio_group *vfio_group_from_file(struct file *file);\nbool vfio_group_enforced_coherent(struct vfio_group *group);\nvoid vfio_group_set_kvm(struct vfio_group *group, struct kvm *kvm);\nbool vfio_device_has_container(struct vfio_device *device);\nint __init vfio_group_init(void);\nvoid vfio_group_cleanup(void);\n\nstatic inline bool vfio_device_is_noiommu(struct vfio_device *vdev)\n{\n\treturn IS_ENABLED(CONFIG_VFIO_NOIOMMU) &&\n\t       vdev->group->type == VFIO_NO_IOMMU;\n}\n#else\nstruct vfio_group;\n\nstatic inline int vfio_device_block_group(struct vfio_device *device)\n{\n\treturn 0;\n}\n\nstatic inline void vfio_device_unblock_group(struct vfio_device *device)\n{\n}\n\nstatic inline int vfio_device_set_group(struct vfio_device *device,\n\t\t\t\t\tenum vfio_group_type type)\n{\n\treturn 0;\n}\n\nstatic inline void vfio_device_remove_group(struct vfio_device *device)\n{\n}\n\nstatic inline void vfio_device_group_register(struct vfio_device *device)\n{\n}\n\nstatic inline void vfio_device_group_unregister(struct vfio_device *device)\n{\n}\n\nstatic inline int vfio_device_group_use_iommu(struct vfio_device *device)\n{\n\treturn -EOPNOTSUPP;\n}\n\nstatic inline void vfio_device_group_unuse_iommu(struct vfio_device *device)\n{\n}\n\nstatic inline void vfio_df_group_close(struct vfio_device_file *df)\n{\n}\n\nstatic inline struct vfio_group *vfio_group_from_file(struct file *file)\n{\n\treturn NULL;\n}\n\nstatic inline bool vfio_group_enforced_coherent(struct vfio_group *group)\n{\n\treturn true;\n}\n\nstatic inline void vfio_group_set_kvm(struct vfio_group *group, struct kvm *kvm)\n{\n}\n\nstatic inline bool vfio_device_has_container(struct vfio_device *device)\n{\n\treturn false;\n}\n\nstatic inline int __init vfio_group_init(void)\n{\n\treturn 0;\n}\n\nstatic inline void vfio_group_cleanup(void)\n{\n}\n\nstatic inline bool vfio_device_is_noiommu(struct vfio_device *vdev)\n{\n\treturn false;\n}\n#endif  \n\n#if IS_ENABLED(CONFIG_VFIO_CONTAINER)\n \nstruct vfio_iommu_driver_ops {\n\tchar\t\t*name;\n\tstruct module\t*owner;\n\tvoid\t\t*(*open)(unsigned long arg);\n\tvoid\t\t(*release)(void *iommu_data);\n\tlong\t\t(*ioctl)(void *iommu_data, unsigned int cmd,\n\t\t\t\t unsigned long arg);\n\tint\t\t(*attach_group)(void *iommu_data,\n\t\t\t\t\tstruct iommu_group *group,\n\t\t\t\t\tenum vfio_group_type);\n\tvoid\t\t(*detach_group)(void *iommu_data,\n\t\t\t\t\tstruct iommu_group *group);\n\tint\t\t(*pin_pages)(void *iommu_data,\n\t\t\t\t     struct iommu_group *group,\n\t\t\t\t     dma_addr_t user_iova,\n\t\t\t\t     int npage, int prot,\n\t\t\t\t     struct page **pages);\n\tvoid\t\t(*unpin_pages)(void *iommu_data,\n\t\t\t\t       dma_addr_t user_iova, int npage);\n\tvoid\t\t(*register_device)(void *iommu_data,\n\t\t\t\t\t   struct vfio_device *vdev);\n\tvoid\t\t(*unregister_device)(void *iommu_data,\n\t\t\t\t\t     struct vfio_device *vdev);\n\tint\t\t(*dma_rw)(void *iommu_data, dma_addr_t user_iova,\n\t\t\t\t  void *data, size_t count, bool write);\n\tstruct iommu_domain *(*group_iommu_domain)(void *iommu_data,\n\t\t\t\t\t\t   struct iommu_group *group);\n};\n\nstruct vfio_iommu_driver {\n\tconst struct vfio_iommu_driver_ops\t*ops;\n\tstruct list_head\t\t\tvfio_next;\n};\n\nint vfio_register_iommu_driver(const struct vfio_iommu_driver_ops *ops);\nvoid vfio_unregister_iommu_driver(const struct vfio_iommu_driver_ops *ops);\n\nstruct vfio_container *vfio_container_from_file(struct file *filep);\nint vfio_group_use_container(struct vfio_group *group);\nvoid vfio_group_unuse_container(struct vfio_group *group);\nint vfio_container_attach_group(struct vfio_container *container,\n\t\t\t\tstruct vfio_group *group);\nvoid vfio_group_detach_container(struct vfio_group *group);\nvoid vfio_device_container_register(struct vfio_device *device);\nvoid vfio_device_container_unregister(struct vfio_device *device);\nint vfio_device_container_pin_pages(struct vfio_device *device,\n\t\t\t\t    dma_addr_t iova, int npage,\n\t\t\t\t    int prot, struct page **pages);\nvoid vfio_device_container_unpin_pages(struct vfio_device *device,\n\t\t\t\t       dma_addr_t iova, int npage);\nint vfio_device_container_dma_rw(struct vfio_device *device,\n\t\t\t\t dma_addr_t iova, void *data,\n\t\t\t\t size_t len, bool write);\n\nint __init vfio_container_init(void);\nvoid vfio_container_cleanup(void);\n#else\nstatic inline struct vfio_container *\nvfio_container_from_file(struct file *filep)\n{\n\treturn NULL;\n}\n\nstatic inline int vfio_group_use_container(struct vfio_group *group)\n{\n\treturn -EOPNOTSUPP;\n}\n\nstatic inline void vfio_group_unuse_container(struct vfio_group *group)\n{\n}\n\nstatic inline int vfio_container_attach_group(struct vfio_container *container,\n\t\t\t\t\t      struct vfio_group *group)\n{\n\treturn -EOPNOTSUPP;\n}\n\nstatic inline void vfio_group_detach_container(struct vfio_group *group)\n{\n}\n\nstatic inline void vfio_device_container_register(struct vfio_device *device)\n{\n}\n\nstatic inline void vfio_device_container_unregister(struct vfio_device *device)\n{\n}\n\nstatic inline int vfio_device_container_pin_pages(struct vfio_device *device,\n\t\t\t\t\t\t  dma_addr_t iova, int npage,\n\t\t\t\t\t\t  int prot, struct page **pages)\n{\n\treturn -EOPNOTSUPP;\n}\n\nstatic inline void vfio_device_container_unpin_pages(struct vfio_device *device,\n\t\t\t\t\t\t     dma_addr_t iova, int npage)\n{\n}\n\nstatic inline int vfio_device_container_dma_rw(struct vfio_device *device,\n\t\t\t\t\t       dma_addr_t iova, void *data,\n\t\t\t\t\t       size_t len, bool write)\n{\n\treturn -EOPNOTSUPP;\n}\n\nstatic inline int vfio_container_init(void)\n{\n\treturn 0;\n}\nstatic inline void vfio_container_cleanup(void)\n{\n}\n#endif\n\n#if IS_ENABLED(CONFIG_IOMMUFD)\nbool vfio_iommufd_device_has_compat_ioas(struct vfio_device *vdev,\n\t\t\t\t\t struct iommufd_ctx *ictx);\nint vfio_df_iommufd_bind(struct vfio_device_file *df);\nvoid vfio_df_iommufd_unbind(struct vfio_device_file *df);\nint vfio_iommufd_compat_attach_ioas(struct vfio_device *device,\n\t\t\t\t    struct iommufd_ctx *ictx);\n#else\nstatic inline bool\nvfio_iommufd_device_has_compat_ioas(struct vfio_device *vdev,\n\t\t\t\t    struct iommufd_ctx *ictx)\n{\n\treturn false;\n}\n\nstatic inline int vfio_df_iommufd_bind(struct vfio_device_file *fd)\n{\n\treturn -EOPNOTSUPP;\n}\n\nstatic inline void vfio_df_iommufd_unbind(struct vfio_device_file *df)\n{\n}\n\nstatic inline int\nvfio_iommufd_compat_attach_ioas(struct vfio_device *device,\n\t\t\t\tstruct iommufd_ctx *ictx)\n{\n\treturn -EOPNOTSUPP;\n}\n#endif\n\nint vfio_df_ioctl_attach_pt(struct vfio_device_file *df,\n\t\t\t    struct vfio_device_attach_iommufd_pt __user *arg);\nint vfio_df_ioctl_detach_pt(struct vfio_device_file *df,\n\t\t\t    struct vfio_device_detach_iommufd_pt __user *arg);\n\n#if IS_ENABLED(CONFIG_VFIO_DEVICE_CDEV)\nvoid vfio_init_device_cdev(struct vfio_device *device);\n\nstatic inline int vfio_device_add(struct vfio_device *device)\n{\n\t \n\tif (vfio_device_is_noiommu(device))\n\t\treturn device_add(&device->device);\n\tvfio_init_device_cdev(device);\n\treturn cdev_device_add(&device->cdev, &device->device);\n}\n\nstatic inline void vfio_device_del(struct vfio_device *device)\n{\n\tif (vfio_device_is_noiommu(device))\n\t\tdevice_del(&device->device);\n\telse\n\t\tcdev_device_del(&device->cdev, &device->device);\n}\n\nint vfio_device_fops_cdev_open(struct inode *inode, struct file *filep);\nlong vfio_df_ioctl_bind_iommufd(struct vfio_device_file *df,\n\t\t\t\tstruct vfio_device_bind_iommufd __user *arg);\nvoid vfio_df_unbind_iommufd(struct vfio_device_file *df);\nint vfio_cdev_init(struct class *device_class);\nvoid vfio_cdev_cleanup(void);\n#else\nstatic inline void vfio_init_device_cdev(struct vfio_device *device)\n{\n}\n\nstatic inline int vfio_device_add(struct vfio_device *device)\n{\n\treturn device_add(&device->device);\n}\n\nstatic inline void vfio_device_del(struct vfio_device *device)\n{\n\tdevice_del(&device->device);\n}\n\nstatic inline int vfio_device_fops_cdev_open(struct inode *inode,\n\t\t\t\t\t     struct file *filep)\n{\n\treturn 0;\n}\n\nstatic inline long vfio_df_ioctl_bind_iommufd(struct vfio_device_file *df,\n\t\t\t\t\t      struct vfio_device_bind_iommufd __user *arg)\n{\n\treturn -ENOTTY;\n}\n\nstatic inline void vfio_df_unbind_iommufd(struct vfio_device_file *df)\n{\n}\n\nstatic inline int vfio_cdev_init(struct class *device_class)\n{\n\treturn 0;\n}\n\nstatic inline void vfio_cdev_cleanup(void)\n{\n}\n#endif  \n\n#if IS_ENABLED(CONFIG_VFIO_VIRQFD)\nint __init vfio_virqfd_init(void);\nvoid vfio_virqfd_exit(void);\n#else\nstatic inline int __init vfio_virqfd_init(void)\n{\n\treturn 0;\n}\nstatic inline void vfio_virqfd_exit(void)\n{\n}\n#endif\n\n#ifdef CONFIG_HAVE_KVM\nvoid vfio_device_get_kvm_safe(struct vfio_device *device, struct kvm *kvm);\nvoid vfio_device_put_kvm(struct vfio_device *device);\n#else\nstatic inline void vfio_device_get_kvm_safe(struct vfio_device *device,\n\t\t\t\t\t    struct kvm *kvm)\n{\n}\n\nstatic inline void vfio_device_put_kvm(struct vfio_device *device)\n{\n}\n#endif\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}