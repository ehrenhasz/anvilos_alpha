{
  "module_name": "vfio_platform_bcmflexrm.c",
  "hash_id": "21cfecd2454bc594af349d03a25f34ad0388fdee708c38dee19272c7f0b6f042",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vfio/platform/reset/vfio_platform_bcmflexrm.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n\n#include \"../vfio_platform_private.h\"\n\n \n#define RING_REGS_SIZE\t\t\t\t\t0x10000\n#define RING_VER_MAGIC\t\t\t\t\t0x76303031\n\n \n#define RING_VER\t\t\t\t\t0x000\n#define RING_CONTROL\t\t\t\t\t0x034\n#define RING_FLUSH_DONE\t\t\t\t\t0x038\n\n \n#define CONTROL_FLUSH_SHIFT\t\t\t\t5\n\n \n#define FLUSH_DONE_MASK\t\t\t\t\t0x1\n\nstatic int vfio_platform_bcmflexrm_shutdown(void __iomem *ring)\n{\n\tunsigned int timeout;\n\n\t \n\twritel_relaxed(0x0, ring + RING_CONTROL);\n\n\t \n\ttimeout = 1000;  \n\twritel_relaxed(BIT(CONTROL_FLUSH_SHIFT), ring + RING_CONTROL);\n\tdo {\n\t\tif (readl_relaxed(ring + RING_FLUSH_DONE) &\n\t\t    FLUSH_DONE_MASK)\n\t\t\tbreak;\n\t\tmdelay(1);\n\t} while (--timeout);\n\tif (!timeout)\n\t\treturn -ETIMEDOUT;\n\n\t \n\ttimeout = 1000;  \n\twritel_relaxed(0x0, ring + RING_CONTROL);\n\tdo {\n\t\tif (!(readl_relaxed(ring + RING_FLUSH_DONE) &\n\t\t      FLUSH_DONE_MASK))\n\t\t\tbreak;\n\t\tmdelay(1);\n\t} while (--timeout);\n\tif (!timeout)\n\t\treturn -ETIMEDOUT;\n\n\treturn 0;\n}\n\nstatic int vfio_platform_bcmflexrm_reset(struct vfio_platform_device *vdev)\n{\n\tvoid __iomem *ring;\n\tint rc = 0, ret = 0, ring_num = 0;\n\tstruct vfio_platform_region *reg = &vdev->regions[0];\n\n\t \n\tif (!reg->ioaddr) {\n\t\treg->ioaddr = ioremap(reg->addr, reg->size);\n\t\tif (!reg->ioaddr)\n\t\t\treturn -ENOMEM;\n\t}\n\n\t \n\tfor (ring = reg->ioaddr;\n\t     ring < (reg->ioaddr + reg->size); ring += RING_REGS_SIZE) {\n\t\tif (readl_relaxed(ring + RING_VER) == RING_VER_MAGIC) {\n\t\t\trc = vfio_platform_bcmflexrm_shutdown(ring);\n\t\t\tif (rc) {\n\t\t\t\tdev_warn(vdev->device,\n\t\t\t\t\t \"FlexRM ring%d shutdown error %d\\n\",\n\t\t\t\t\t ring_num, rc);\n\t\t\t\tret |= rc;\n\t\t\t}\n\t\t\tring_num++;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nmodule_vfio_reset_handler(\"brcm,iproc-flexrm-mbox\",\n\t\t\t  vfio_platform_bcmflexrm_reset);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Anup Patel <anup.patel@broadcom.com>\");\nMODULE_DESCRIPTION(\"Reset support for Broadcom FlexRM VFIO platform device\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}