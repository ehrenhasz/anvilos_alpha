{
  "module_name": "vfio_amba.c",
  "hash_id": "8c78e301ca91694cf00ba1ac59953f22a341def1c776e6568d9f52b64f41d98c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vfio/platform/vfio_amba.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/vfio.h>\n#include <linux/pm_runtime.h>\n#include <linux/amba/bus.h>\n\n#include \"vfio_platform_private.h\"\n\n#define DRIVER_VERSION  \"0.10\"\n#define DRIVER_AUTHOR   \"Antonios Motakis <a.motakis@virtualopensystems.com>\"\n#define DRIVER_DESC     \"VFIO for AMBA devices - User Level meta-driver\"\n\n \n\nstatic struct resource *get_amba_resource(struct vfio_platform_device *vdev,\n\t\t\t\t\t  int i)\n{\n\tstruct amba_device *adev = (struct amba_device *) vdev->opaque;\n\n\tif (i == 0)\n\t\treturn &adev->res;\n\n\treturn NULL;\n}\n\nstatic int get_amba_irq(struct vfio_platform_device *vdev, int i)\n{\n\tstruct amba_device *adev = (struct amba_device *) vdev->opaque;\n\tint ret = 0;\n\n\tif (i < AMBA_NR_IRQS)\n\t\tret = adev->irq[i];\n\n\t \n\treturn ret ? ret : -ENXIO;\n}\n\nstatic int vfio_amba_init_dev(struct vfio_device *core_vdev)\n{\n\tstruct vfio_platform_device *vdev =\n\t\tcontainer_of(core_vdev, struct vfio_platform_device, vdev);\n\tstruct amba_device *adev = to_amba_device(core_vdev->dev);\n\tint ret;\n\n\tvdev->name = kasprintf(GFP_KERNEL, \"vfio-amba-%08x\", adev->periphid);\n\tif (!vdev->name)\n\t\treturn -ENOMEM;\n\n\tvdev->opaque = (void *) adev;\n\tvdev->flags = VFIO_DEVICE_FLAGS_AMBA;\n\tvdev->get_resource = get_amba_resource;\n\tvdev->get_irq = get_amba_irq;\n\tvdev->reset_required = false;\n\n\tret = vfio_platform_init_common(vdev);\n\tif (ret)\n\t\tkfree(vdev->name);\n\treturn ret;\n}\n\nstatic const struct vfio_device_ops vfio_amba_ops;\nstatic int vfio_amba_probe(struct amba_device *adev, const struct amba_id *id)\n{\n\tstruct vfio_platform_device *vdev;\n\tint ret;\n\n\tvdev = vfio_alloc_device(vfio_platform_device, vdev, &adev->dev,\n\t\t\t\t &vfio_amba_ops);\n\tif (IS_ERR(vdev))\n\t\treturn PTR_ERR(vdev);\n\n\tret = vfio_register_group_dev(&vdev->vdev);\n\tif (ret)\n\t\tgoto out_put_vdev;\n\n\tpm_runtime_enable(&adev->dev);\n\tdev_set_drvdata(&adev->dev, vdev);\n\treturn 0;\n\nout_put_vdev:\n\tvfio_put_device(&vdev->vdev);\n\treturn ret;\n}\n\nstatic void vfio_amba_release_dev(struct vfio_device *core_vdev)\n{\n\tstruct vfio_platform_device *vdev =\n\t\tcontainer_of(core_vdev, struct vfio_platform_device, vdev);\n\n\tvfio_platform_release_common(vdev);\n\tkfree(vdev->name);\n}\n\nstatic void vfio_amba_remove(struct amba_device *adev)\n{\n\tstruct vfio_platform_device *vdev = dev_get_drvdata(&adev->dev);\n\n\tvfio_unregister_group_dev(&vdev->vdev);\n\tpm_runtime_disable(vdev->device);\n\tvfio_put_device(&vdev->vdev);\n}\n\nstatic const struct vfio_device_ops vfio_amba_ops = {\n\t.name\t\t= \"vfio-amba\",\n\t.init\t\t= vfio_amba_init_dev,\n\t.release\t= vfio_amba_release_dev,\n\t.open_device\t= vfio_platform_open_device,\n\t.close_device\t= vfio_platform_close_device,\n\t.ioctl\t\t= vfio_platform_ioctl,\n\t.read\t\t= vfio_platform_read,\n\t.write\t\t= vfio_platform_write,\n\t.mmap\t\t= vfio_platform_mmap,\n\t.bind_iommufd\t= vfio_iommufd_physical_bind,\n\t.unbind_iommufd\t= vfio_iommufd_physical_unbind,\n\t.attach_ioas\t= vfio_iommufd_physical_attach_ioas,\n\t.detach_ioas\t= vfio_iommufd_physical_detach_ioas,\n};\n\nstatic const struct amba_id pl330_ids[] = {\n\t{ 0, 0 },\n};\n\nMODULE_DEVICE_TABLE(amba, pl330_ids);\n\nstatic struct amba_driver vfio_amba_driver = {\n\t.probe = vfio_amba_probe,\n\t.remove = vfio_amba_remove,\n\t.id_table = pl330_ids,\n\t.drv = {\n\t\t.name = \"vfio-amba\",\n\t\t.owner = THIS_MODULE,\n\t},\n\t.driver_managed_dma = true,\n};\n\nmodule_amba_driver(vfio_amba_driver);\n\nMODULE_VERSION(DRIVER_VERSION);\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(DRIVER_AUTHOR);\nMODULE_DESCRIPTION(DRIVER_DESC);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}