{
  "module_name": "vfio_platform.c",
  "hash_id": "b378bb715af6b2dc992a6ba69a5d9f5f3dce041981c845f2023d77956878d3a6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vfio/platform/vfio_platform.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/vfio.h>\n#include <linux/pm_runtime.h>\n#include <linux/platform_device.h>\n\n#include \"vfio_platform_private.h\"\n\n#define DRIVER_VERSION  \"0.10\"\n#define DRIVER_AUTHOR   \"Antonios Motakis <a.motakis@virtualopensystems.com>\"\n#define DRIVER_DESC     \"VFIO for platform devices - User Level meta-driver\"\n\nstatic bool reset_required = true;\nmodule_param(reset_required, bool, 0444);\nMODULE_PARM_DESC(reset_required, \"override reset requirement (default: 1)\");\n\n \n\nstatic struct resource *get_platform_resource(struct vfio_platform_device *vdev,\n\t\t\t\t\t      int num)\n{\n\tstruct platform_device *dev = (struct platform_device *) vdev->opaque;\n\n\treturn platform_get_mem_or_io(dev, num);\n}\n\nstatic int get_platform_irq(struct vfio_platform_device *vdev, int i)\n{\n\tstruct platform_device *pdev = (struct platform_device *) vdev->opaque;\n\n\treturn platform_get_irq_optional(pdev, i);\n}\n\nstatic int vfio_platform_init_dev(struct vfio_device *core_vdev)\n{\n\tstruct vfio_platform_device *vdev =\n\t\tcontainer_of(core_vdev, struct vfio_platform_device, vdev);\n\tstruct platform_device *pdev = to_platform_device(core_vdev->dev);\n\n\tvdev->opaque = (void *) pdev;\n\tvdev->name = pdev->name;\n\tvdev->flags = VFIO_DEVICE_FLAGS_PLATFORM;\n\tvdev->get_resource = get_platform_resource;\n\tvdev->get_irq = get_platform_irq;\n\tvdev->reset_required = reset_required;\n\n\treturn vfio_platform_init_common(vdev);\n}\n\nstatic const struct vfio_device_ops vfio_platform_ops;\nstatic int vfio_platform_probe(struct platform_device *pdev)\n{\n\tstruct vfio_platform_device *vdev;\n\tint ret;\n\n\tvdev = vfio_alloc_device(vfio_platform_device, vdev, &pdev->dev,\n\t\t\t\t &vfio_platform_ops);\n\tif (IS_ERR(vdev))\n\t\treturn PTR_ERR(vdev);\n\n\tret = vfio_register_group_dev(&vdev->vdev);\n\tif (ret)\n\t\tgoto out_put_vdev;\n\n\tpm_runtime_enable(&pdev->dev);\n\tdev_set_drvdata(&pdev->dev, vdev);\n\treturn 0;\n\nout_put_vdev:\n\tvfio_put_device(&vdev->vdev);\n\treturn ret;\n}\n\nstatic void vfio_platform_release_dev(struct vfio_device *core_vdev)\n{\n\tstruct vfio_platform_device *vdev =\n\t\tcontainer_of(core_vdev, struct vfio_platform_device, vdev);\n\n\tvfio_platform_release_common(vdev);\n}\n\nstatic int vfio_platform_remove(struct platform_device *pdev)\n{\n\tstruct vfio_platform_device *vdev = dev_get_drvdata(&pdev->dev);\n\n\tvfio_unregister_group_dev(&vdev->vdev);\n\tpm_runtime_disable(vdev->device);\n\tvfio_put_device(&vdev->vdev);\n\treturn 0;\n}\n\nstatic const struct vfio_device_ops vfio_platform_ops = {\n\t.name\t\t= \"vfio-platform\",\n\t.init\t\t= vfio_platform_init_dev,\n\t.release\t= vfio_platform_release_dev,\n\t.open_device\t= vfio_platform_open_device,\n\t.close_device\t= vfio_platform_close_device,\n\t.ioctl\t\t= vfio_platform_ioctl,\n\t.read\t\t= vfio_platform_read,\n\t.write\t\t= vfio_platform_write,\n\t.mmap\t\t= vfio_platform_mmap,\n\t.bind_iommufd\t= vfio_iommufd_physical_bind,\n\t.unbind_iommufd\t= vfio_iommufd_physical_unbind,\n\t.attach_ioas\t= vfio_iommufd_physical_attach_ioas,\n\t.detach_ioas\t= vfio_iommufd_physical_detach_ioas,\n};\n\nstatic struct platform_driver vfio_platform_driver = {\n\t.probe\t\t= vfio_platform_probe,\n\t.remove\t\t= vfio_platform_remove,\n\t.driver\t= {\n\t\t.name\t= \"vfio-platform\",\n\t},\n\t.driver_managed_dma = true,\n};\n\nmodule_platform_driver(vfio_platform_driver);\n\nMODULE_VERSION(DRIVER_VERSION);\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(DRIVER_AUTHOR);\nMODULE_DESCRIPTION(DRIVER_DESC);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}