{
  "module_name": "cmd.h",
  "hash_id": "af3e6692faf86a5184bbda9769e10d6f4524aaa300e3f2fbe8a4de18ffa10f56",
  "original_prompt": "Ingested from linux-6.6.14/drivers/vfio/pci/mlx5/cmd.h",
  "human_readable_source": " \n \n\n#ifndef MLX5_VFIO_CMD_H\n#define MLX5_VFIO_CMD_H\n\n#include <linux/kernel.h>\n#include <linux/vfio_pci_core.h>\n#include <linux/mlx5/driver.h>\n#include <linux/mlx5/vport.h>\n#include <linux/mlx5/cq.h>\n#include <linux/mlx5/qp.h>\n\n#define MLX5VF_PRE_COPY_SUPP(mvdev) \\\n\t((mvdev)->core_device.vdev.migration_flags & VFIO_MIGRATION_PRE_COPY)\n\nenum mlx5_vf_migf_state {\n\tMLX5_MIGF_STATE_ERROR = 1,\n\tMLX5_MIGF_STATE_PRE_COPY_ERROR,\n\tMLX5_MIGF_STATE_PRE_COPY,\n\tMLX5_MIGF_STATE_SAVE_LAST,\n\tMLX5_MIGF_STATE_COMPLETE,\n};\n\nenum mlx5_vf_load_state {\n\tMLX5_VF_LOAD_STATE_READ_IMAGE_NO_HEADER,\n\tMLX5_VF_LOAD_STATE_READ_HEADER,\n\tMLX5_VF_LOAD_STATE_PREP_HEADER_DATA,\n\tMLX5_VF_LOAD_STATE_READ_HEADER_DATA,\n\tMLX5_VF_LOAD_STATE_PREP_IMAGE,\n\tMLX5_VF_LOAD_STATE_READ_IMAGE,\n\tMLX5_VF_LOAD_STATE_LOAD_IMAGE,\n};\n\nstruct mlx5_vf_migration_tag_stop_copy_data {\n\t__le64 stop_copy_size;\n};\n\nenum mlx5_vf_migf_header_flags {\n\tMLX5_MIGF_HEADER_FLAGS_TAG_MANDATORY = 0,\n\tMLX5_MIGF_HEADER_FLAGS_TAG_OPTIONAL = 1 << 0,\n};\n\nenum mlx5_vf_migf_header_tag {\n\tMLX5_MIGF_HEADER_TAG_FW_DATA = 0,\n\tMLX5_MIGF_HEADER_TAG_STOP_COPY_SIZE = 1 << 0,\n};\n\nstruct mlx5_vf_migration_header {\n\t__le64 record_size;\n\t \n\t__le32 flags;  \n\t__le32 tag;  \n\t__u8 data[];  \n};\n\nstruct mlx5_vhca_data_buffer {\n\tstruct sg_append_table table;\n\tloff_t start_pos;\n\tu64 length;\n\tu64 allocated_length;\n\tu32 mkey;\n\tenum dma_data_direction dma_dir;\n\tu8 dmaed:1;\n\tstruct list_head buf_elm;\n\tstruct mlx5_vf_migration_file *migf;\n\t \n\tstruct scatterlist *last_offset_sg;\n\tunsigned int sg_last_entry;\n\tunsigned long last_offset;\n};\n\nstruct mlx5vf_async_data {\n\tstruct mlx5_async_work cb_work;\n\tstruct work_struct work;\n\tstruct mlx5_vhca_data_buffer *buf;\n\tstruct mlx5_vhca_data_buffer *header_buf;\n\tint status;\n\tu8 last_chunk:1;\n\tvoid *out;\n};\n\nstruct mlx5_vf_migration_file {\n\tstruct file *filp;\n\tstruct mutex lock;\n\tenum mlx5_vf_migf_state state;\n\n\tenum mlx5_vf_load_state load_state;\n\tu32 pdn;\n\tloff_t max_pos;\n\tu64 record_size;\n\tu32 record_tag;\n\tu64 stop_copy_prep_size;\n\tu64 pre_copy_initial_bytes;\n\tstruct mlx5_vhca_data_buffer *buf;\n\tstruct mlx5_vhca_data_buffer *buf_header;\n\tspinlock_t list_lock;\n\tstruct list_head buf_list;\n\tstruct list_head avail_list;\n\tstruct mlx5vf_pci_core_device *mvdev;\n\twait_queue_head_t poll_wait;\n\tstruct completion save_comp;\n\tstruct mlx5_async_ctx async_ctx;\n\tstruct mlx5vf_async_data async_data;\n};\n\nstruct mlx5_vhca_cq_buf {\n\tstruct mlx5_frag_buf_ctrl fbc;\n\tstruct mlx5_frag_buf frag_buf;\n\tint cqe_size;\n\tint nent;\n};\n\nstruct mlx5_vhca_cq {\n\tstruct mlx5_vhca_cq_buf buf;\n\tstruct mlx5_db db;\n\tstruct mlx5_core_cq mcq;\n\tsize_t ncqe;\n};\n\nstruct mlx5_vhca_recv_buf {\n\tu32 npages;\n\tstruct page **page_list;\n\tdma_addr_t *dma_addrs;\n\tu32 next_rq_offset;\n\tu32 mkey;\n};\n\nstruct mlx5_vhca_qp {\n\tstruct mlx5_frag_buf buf;\n\tstruct mlx5_db db;\n\tstruct mlx5_vhca_recv_buf recv_buf;\n\tu32 tracked_page_size;\n\tu32 max_msg_size;\n\tu32 qpn;\n\tstruct {\n\t\tunsigned int pc;\n\t\tunsigned int cc;\n\t\tunsigned int wqe_cnt;\n\t\t__be32 *db;\n\t\tstruct mlx5_frag_buf_ctrl fbc;\n\t} rq;\n};\n\nstruct mlx5_vhca_page_tracker {\n\tu32 id;\n\tu32 pdn;\n\tu8 is_err:1;\n\tstruct mlx5_uars_page *uar;\n\tstruct mlx5_vhca_cq cq;\n\tstruct mlx5_vhca_qp *host_qp;\n\tstruct mlx5_vhca_qp *fw_qp;\n\tstruct mlx5_nb nb;\n\tint status;\n};\n\nstruct mlx5vf_pci_core_device {\n\tstruct vfio_pci_core_device core_device;\n\tint vf_id;\n\tu16 vhca_id;\n\tu8 migrate_cap:1;\n\tu8 deferred_reset:1;\n\tu8 mdev_detach:1;\n\tu8 log_active:1;\n\tstruct completion tracker_comp;\n\t \n\tstruct mutex state_mutex;\n\tenum vfio_device_mig_state mig_state;\n\t \n\tspinlock_t reset_lock;\n\tstruct mlx5_vf_migration_file *resuming_migf;\n\tstruct mlx5_vf_migration_file *saving_migf;\n\tstruct mlx5_vhca_page_tracker tracker;\n\tstruct workqueue_struct *cb_wq;\n\tstruct notifier_block nb;\n\tstruct mlx5_core_dev *mdev;\n};\n\nenum {\n\tMLX5VF_QUERY_INC = (1UL << 0),\n\tMLX5VF_QUERY_FINAL = (1UL << 1),\n};\n\nint mlx5vf_cmd_suspend_vhca(struct mlx5vf_pci_core_device *mvdev, u16 op_mod);\nint mlx5vf_cmd_resume_vhca(struct mlx5vf_pci_core_device *mvdev, u16 op_mod);\nint mlx5vf_cmd_query_vhca_migration_state(struct mlx5vf_pci_core_device *mvdev,\n\t\t\t\t\t  size_t *state_size, u8 query_flags);\nvoid mlx5vf_cmd_set_migratable(struct mlx5vf_pci_core_device *mvdev,\n\t\t\t       const struct vfio_migration_ops *mig_ops,\n\t\t\t       const struct vfio_log_ops *log_ops);\nvoid mlx5vf_cmd_remove_migratable(struct mlx5vf_pci_core_device *mvdev);\nvoid mlx5vf_cmd_close_migratable(struct mlx5vf_pci_core_device *mvdev);\nint mlx5vf_cmd_save_vhca_state(struct mlx5vf_pci_core_device *mvdev,\n\t\t\t       struct mlx5_vf_migration_file *migf,\n\t\t\t       struct mlx5_vhca_data_buffer *buf, bool inc,\n\t\t\t       bool track);\nint mlx5vf_cmd_load_vhca_state(struct mlx5vf_pci_core_device *mvdev,\n\t\t\t       struct mlx5_vf_migration_file *migf,\n\t\t\t       struct mlx5_vhca_data_buffer *buf);\nint mlx5vf_cmd_alloc_pd(struct mlx5_vf_migration_file *migf);\nvoid mlx5vf_cmd_dealloc_pd(struct mlx5_vf_migration_file *migf);\nvoid mlx5fv_cmd_clean_migf_resources(struct mlx5_vf_migration_file *migf);\nstruct mlx5_vhca_data_buffer *\nmlx5vf_alloc_data_buffer(struct mlx5_vf_migration_file *migf,\n\t\t\t size_t length, enum dma_data_direction dma_dir);\nvoid mlx5vf_free_data_buffer(struct mlx5_vhca_data_buffer *buf);\nstruct mlx5_vhca_data_buffer *\nmlx5vf_get_data_buffer(struct mlx5_vf_migration_file *migf,\n\t\t       size_t length, enum dma_data_direction dma_dir);\nvoid mlx5vf_put_data_buffer(struct mlx5_vhca_data_buffer *buf);\nint mlx5vf_add_migration_pages(struct mlx5_vhca_data_buffer *buf,\n\t\t\t       unsigned int npages);\nstruct page *mlx5vf_get_migration_page(struct mlx5_vhca_data_buffer *buf,\n\t\t\t\t       unsigned long offset);\nvoid mlx5vf_state_mutex_unlock(struct mlx5vf_pci_core_device *mvdev);\nvoid mlx5vf_disable_fds(struct mlx5vf_pci_core_device *mvdev);\nvoid mlx5vf_mig_file_cleanup_cb(struct work_struct *_work);\nint mlx5vf_start_page_tracker(struct vfio_device *vdev,\n\t\tstruct rb_root_cached *ranges, u32 nnodes, u64 *page_size);\nint mlx5vf_stop_page_tracker(struct vfio_device *vdev);\nint mlx5vf_tracker_read_and_clear(struct vfio_device *vdev, unsigned long iova,\n\t\t\tunsigned long length, struct iova_bitmap *dirty);\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}