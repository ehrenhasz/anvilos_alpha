{
  "module_name": "svc_watchdog.c",
  "hash_id": "4ae45ead4386ef3d6455435b6a53b1e06ba5b7402136eb775f6cc4389baa3322",
  "original_prompt": "Ingested from linux-6.6.14/drivers/greybus/svc_watchdog.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/suspend.h>\n#include <linux/workqueue.h>\n#include <linux/greybus.h>\n\n#define SVC_WATCHDOG_PERIOD\t(2 * HZ)\n\nstruct gb_svc_watchdog {\n\tstruct delayed_work\twork;\n\tstruct gb_svc\t\t*svc;\n\tbool\t\t\tenabled;\n\tstruct notifier_block pm_notifier;\n};\n\nstatic struct delayed_work reset_work;\n\nstatic int svc_watchdog_pm_notifier(struct notifier_block *notifier,\n\t\t\t\t    unsigned long pm_event, void *unused)\n{\n\tstruct gb_svc_watchdog *watchdog =\n\t\tcontainer_of(notifier, struct gb_svc_watchdog, pm_notifier);\n\n\tswitch (pm_event) {\n\tcase PM_SUSPEND_PREPARE:\n\t\tgb_svc_watchdog_disable(watchdog->svc);\n\t\tbreak;\n\tcase PM_POST_SUSPEND:\n\t\tgb_svc_watchdog_enable(watchdog->svc);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn NOTIFY_DONE;\n}\n\nstatic void greybus_reset(struct work_struct *work)\n{\n\tstatic char const start_path[] = \"/system/bin/start\";\n\tstatic char *envp[] = {\n\t\t\"HOME=/\",\n\t\t\"PATH=/sbin:/vendor/bin:/system/sbin:/system/bin:/system/xbin\",\n\t\tNULL,\n\t};\n\tstatic char *argv[] = {\n\t\t(char *)start_path,\n\t\t\"unipro_reset\",\n\t\tNULL,\n\t};\n\n\tpr_err(\"svc_watchdog: calling \\\"%s %s\\\" to reset greybus network!\\n\",\n\t       argv[0], argv[1]);\n\tcall_usermodehelper(start_path, argv, envp, UMH_WAIT_EXEC);\n}\n\nstatic void do_work(struct work_struct *work)\n{\n\tstruct gb_svc_watchdog *watchdog;\n\tstruct gb_svc *svc;\n\tint retval;\n\n\twatchdog = container_of(work, struct gb_svc_watchdog, work.work);\n\tsvc = watchdog->svc;\n\n\tdev_dbg(&svc->dev, \"%s: ping.\\n\", __func__);\n\tretval = gb_svc_ping(svc);\n\tif (retval) {\n\t\t \n\t\tdev_err(&svc->dev,\n\t\t\t\"SVC ping has returned %d, something is wrong!!!\\n\",\n\t\t\tretval);\n\n\t\tif (svc->action == GB_SVC_WATCHDOG_BITE_PANIC_KERNEL) {\n\t\t\tpanic(\"SVC is not responding\\n\");\n\t\t} else if (svc->action == GB_SVC_WATCHDOG_BITE_RESET_UNIPRO) {\n\t\t\tdev_err(&svc->dev, \"Resetting the greybus network, watch out!!!\\n\");\n\n\t\t\tINIT_DELAYED_WORK(&reset_work, greybus_reset);\n\t\t\tschedule_delayed_work(&reset_work, HZ / 2);\n\n\t\t\t \n\t\t\twatchdog->enabled = false;\n\t\t}\n\t}\n\n\t \n\tif (watchdog->enabled)\n\t\tschedule_delayed_work(&watchdog->work, SVC_WATCHDOG_PERIOD);\n}\n\nint gb_svc_watchdog_create(struct gb_svc *svc)\n{\n\tstruct gb_svc_watchdog *watchdog;\n\tint retval;\n\n\tif (svc->watchdog)\n\t\treturn 0;\n\n\twatchdog = kmalloc(sizeof(*watchdog), GFP_KERNEL);\n\tif (!watchdog)\n\t\treturn -ENOMEM;\n\n\twatchdog->enabled = false;\n\twatchdog->svc = svc;\n\tINIT_DELAYED_WORK(&watchdog->work, do_work);\n\tsvc->watchdog = watchdog;\n\n\twatchdog->pm_notifier.notifier_call = svc_watchdog_pm_notifier;\n\tretval = register_pm_notifier(&watchdog->pm_notifier);\n\tif (retval) {\n\t\tdev_err(&svc->dev, \"error registering pm notifier(%d)\\n\",\n\t\t\tretval);\n\t\tgoto svc_watchdog_create_err;\n\t}\n\n\tretval = gb_svc_watchdog_enable(svc);\n\tif (retval) {\n\t\tdev_err(&svc->dev, \"error enabling watchdog (%d)\\n\", retval);\n\t\tunregister_pm_notifier(&watchdog->pm_notifier);\n\t\tgoto svc_watchdog_create_err;\n\t}\n\treturn retval;\n\nsvc_watchdog_create_err:\n\tsvc->watchdog = NULL;\n\tkfree(watchdog);\n\n\treturn retval;\n}\n\nvoid gb_svc_watchdog_destroy(struct gb_svc *svc)\n{\n\tstruct gb_svc_watchdog *watchdog = svc->watchdog;\n\n\tif (!watchdog)\n\t\treturn;\n\n\tunregister_pm_notifier(&watchdog->pm_notifier);\n\tgb_svc_watchdog_disable(svc);\n\tsvc->watchdog = NULL;\n\tkfree(watchdog);\n}\n\nbool gb_svc_watchdog_enabled(struct gb_svc *svc)\n{\n\tif (!svc || !svc->watchdog)\n\t\treturn false;\n\treturn svc->watchdog->enabled;\n}\n\nint gb_svc_watchdog_enable(struct gb_svc *svc)\n{\n\tstruct gb_svc_watchdog *watchdog;\n\n\tif (!svc->watchdog)\n\t\treturn -ENODEV;\n\n\twatchdog = svc->watchdog;\n\tif (watchdog->enabled)\n\t\treturn 0;\n\n\twatchdog->enabled = true;\n\tschedule_delayed_work(&watchdog->work, SVC_WATCHDOG_PERIOD);\n\treturn 0;\n}\n\nint gb_svc_watchdog_disable(struct gb_svc *svc)\n{\n\tstruct gb_svc_watchdog *watchdog;\n\n\tif (!svc->watchdog)\n\t\treturn -ENODEV;\n\n\twatchdog = svc->watchdog;\n\tif (!watchdog->enabled)\n\t\treturn 0;\n\n\twatchdog->enabled = false;\n\tcancel_delayed_work_sync(&watchdog->work);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}