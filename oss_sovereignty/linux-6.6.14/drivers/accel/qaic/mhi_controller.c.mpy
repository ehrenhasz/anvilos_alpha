{
  "module_name": "mhi_controller.c",
  "hash_id": "71ba30fbe33d64433807cb20b5a53f6b5d220ef7c167c53d49f4ede046cc0682",
  "original_prompt": "Ingested from linux-6.6.14/drivers/accel/qaic/mhi_controller.c",
  "human_readable_source": "\n\n \n \n\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/memblock.h>\n#include <linux/mhi.h>\n#include <linux/moduleparam.h>\n#include <linux/pci.h>\n#include <linux/sizes.h>\n\n#include \"mhi_controller.h\"\n#include \"qaic.h\"\n\n#define MAX_RESET_TIME_SEC 25\n\nstatic unsigned int mhi_timeout_ms = 2000;  \nmodule_param(mhi_timeout_ms, uint, 0600);\nMODULE_PARM_DESC(mhi_timeout_ms, \"MHI controller timeout value\");\n\nstatic struct mhi_channel_config aic100_channels[] = {\n\t{\n\t\t.name = \"QAIC_LOOPBACK\",\n\t\t.num = 0,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_LOOPBACK\",\n\t\t.num = 1,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_SAHARA\",\n\t\t.num = 2,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_SBL,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_SAHARA\",\n\t\t.num = 3,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_SBL,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_DIAG\",\n\t\t.num = 4,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_DIAG\",\n\t\t.num = 5,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_SSR\",\n\t\t.num = 6,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_SSR\",\n\t\t.num = 7,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_QDSS\",\n\t\t.num = 8,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_QDSS\",\n\t\t.num = 9,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_CONTROL\",\n\t\t.num = 10,\n\t\t.num_elements = 128,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_CONTROL\",\n\t\t.num = 11,\n\t\t.num_elements = 128,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_LOGGING\",\n\t\t.num = 12,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_SBL,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_LOGGING\",\n\t\t.num = 13,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_SBL,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_STATUS\",\n\t\t.num = 14,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_STATUS\",\n\t\t.num = 15,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_TELEMETRY\",\n\t\t.num = 16,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_TELEMETRY\",\n\t\t.num = 17,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_DEBUG\",\n\t\t.num = 18,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_DEBUG\",\n\t\t.num = 19,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.name = \"QAIC_TIMESYNC\",\n\t\t.num = 20,\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_TO_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_SBL | MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n\t{\n\t\t.num = 21,\n\t\t.name = \"QAIC_TIMESYNC\",\n\t\t.num_elements = 32,\n\t\t.local_elements = 0,\n\t\t.event_ring = 0,\n\t\t.dir = DMA_FROM_DEVICE,\n\t\t.ee_mask = MHI_CH_EE_SBL | MHI_CH_EE_AMSS,\n\t\t.pollcfg = 0,\n\t\t.doorbell = MHI_DB_BRST_DISABLE,\n\t\t.lpm_notify = false,\n\t\t.offload_channel = false,\n\t\t.doorbell_mode_switch = false,\n\t\t.auto_queue = false,\n\t\t.wake_capable = false,\n\t},\n};\n\nstatic struct mhi_event_config aic100_events[] = {\n\t{\n\t\t.num_elements = 32,\n\t\t.irq_moderation_ms = 0,\n\t\t.irq = 0,\n\t\t.channel = U32_MAX,\n\t\t.priority = 1,\n\t\t.mode = MHI_DB_BRST_DISABLE,\n\t\t.data_type = MHI_ER_CTRL,\n\t\t.hardware_event = false,\n\t\t.client_managed = false,\n\t\t.offload_channel = false,\n\t},\n};\n\nstatic struct mhi_controller_config aic100_config = {\n\t.max_channels = 128,\n\t.timeout_ms = 0,  \n\t.buf_len = 0,\n\t.num_channels = ARRAY_SIZE(aic100_channels),\n\t.ch_cfg = aic100_channels,\n\t.num_events = ARRAY_SIZE(aic100_events),\n\t.event_cfg = aic100_events,\n\t.use_bounce_buf = false,\n\t.m2_no_db = false,\n};\n\nstatic int mhi_read_reg(struct mhi_controller *mhi_cntrl, void __iomem *addr, u32 *out)\n{\n\tu32 tmp;\n\n\t \n\tif (addr - mhi_cntrl->regs == 0x224) {\n\t\t*out = 0x60110200;\n\t\treturn 0;\n\t}\n\n\ttmp = readl_relaxed(addr);\n\tif (tmp == U32_MAX)\n\t\treturn -EIO;\n\n\t*out = tmp;\n\n\treturn 0;\n}\n\nstatic void mhi_write_reg(struct mhi_controller *mhi_cntrl, void __iomem *addr, u32 val)\n{\n\twritel_relaxed(val, addr);\n}\n\nstatic int mhi_runtime_get(struct mhi_controller *mhi_cntrl)\n{\n\treturn 0;\n}\n\nstatic void mhi_runtime_put(struct mhi_controller *mhi_cntrl)\n{\n}\n\nstatic void mhi_status_cb(struct mhi_controller *mhi_cntrl, enum mhi_callback reason)\n{\n\tstruct qaic_device *qdev = pci_get_drvdata(to_pci_dev(mhi_cntrl->cntrl_dev));\n\n\t \n\tif (reason == MHI_CB_FATAL_ERROR)\n\t\tpci_err(qdev->pdev, \"Fatal error received from device. Attempting to recover\\n\");\n\t \n\tif (reason == MHI_CB_SYS_ERROR)\n\t\tqaic_dev_reset_clean_local_state(qdev, true);\n}\n\nstatic int mhi_reset_and_async_power_up(struct mhi_controller *mhi_cntrl)\n{\n\tu8 time_sec = 1;\n\tint current_ee;\n\tint ret;\n\n\t \n\tmhi_soc_reset(mhi_cntrl);\n\n\t \n\tdo {\n\t\tmsleep(1000);\n\t\tcurrent_ee = mhi_get_exec_env(mhi_cntrl);\n\t} while (current_ee != MHI_EE_PBL && time_sec++ <= MAX_RESET_TIME_SEC);\n\n\t \n\tif (current_ee == MHI_EE_PBL)\n\t\tret = mhi_async_power_up(mhi_cntrl);\n\telse\n\t\tret = -EIO;\n\n\treturn ret;\n}\n\nstruct mhi_controller *qaic_mhi_register_controller(struct pci_dev *pci_dev, void __iomem *mhi_bar,\n\t\t\t\t\t\t    int mhi_irq)\n{\n\tstruct mhi_controller *mhi_cntrl;\n\tint ret;\n\n\tmhi_cntrl = devm_kzalloc(&pci_dev->dev, sizeof(*mhi_cntrl), GFP_KERNEL);\n\tif (!mhi_cntrl)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tmhi_cntrl->cntrl_dev = &pci_dev->dev;\n\n\t \n\tmhi_cntrl->iova_start = 0;\n\tmhi_cntrl->iova_stop = PHYS_ADDR_MAX - 1;\n\tmhi_cntrl->status_cb = mhi_status_cb;\n\tmhi_cntrl->runtime_get = mhi_runtime_get;\n\tmhi_cntrl->runtime_put = mhi_runtime_put;\n\tmhi_cntrl->read_reg = mhi_read_reg;\n\tmhi_cntrl->write_reg = mhi_write_reg;\n\tmhi_cntrl->regs = mhi_bar;\n\tmhi_cntrl->reg_len = SZ_4K;\n\tmhi_cntrl->nr_irqs = 1;\n\tmhi_cntrl->irq = devm_kmalloc(&pci_dev->dev, sizeof(*mhi_cntrl->irq), GFP_KERNEL);\n\n\tif (!mhi_cntrl->irq)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tmhi_cntrl->irq[0] = mhi_irq;\n\tmhi_cntrl->fw_image = \"qcom/aic100/sbl.bin\";\n\n\t \n\taic100_config.timeout_ms = mhi_timeout_ms;\n\tret = mhi_register_controller(mhi_cntrl, &aic100_config);\n\tif (ret) {\n\t\tpci_err(pci_dev, \"mhi_register_controller failed %d\\n\", ret);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\tret = mhi_prepare_for_power_up(mhi_cntrl);\n\tif (ret) {\n\t\tpci_err(pci_dev, \"mhi_prepare_for_power_up failed %d\\n\", ret);\n\t\tgoto prepare_power_up_fail;\n\t}\n\n\tret = mhi_async_power_up(mhi_cntrl);\n\t \n\tif (ret == -EIO && MHI_EE_SBL == mhi_get_exec_env(mhi_cntrl)) {\n\t\tpci_err(pci_dev, \"Found device in SBL at MHI init. Attempting a reset.\\n\");\n\t\tret = mhi_reset_and_async_power_up(mhi_cntrl);\n\t}\n\n\tif (ret) {\n\t\tpci_err(pci_dev, \"mhi_async_power_up failed %d\\n\", ret);\n\t\tgoto power_up_fail;\n\t}\n\n\treturn mhi_cntrl;\n\npower_up_fail:\n\tmhi_unprepare_after_power_down(mhi_cntrl);\nprepare_power_up_fail:\n\tmhi_unregister_controller(mhi_cntrl);\n\treturn ERR_PTR(ret);\n}\n\nvoid qaic_mhi_free_controller(struct mhi_controller *mhi_cntrl, bool link_up)\n{\n\tmhi_power_down(mhi_cntrl, link_up);\n\tmhi_unprepare_after_power_down(mhi_cntrl);\n\tmhi_unregister_controller(mhi_cntrl);\n}\n\nvoid qaic_mhi_start_reset(struct mhi_controller *mhi_cntrl)\n{\n\tmhi_power_down(mhi_cntrl, true);\n}\n\nvoid qaic_mhi_reset_done(struct mhi_controller *mhi_cntrl)\n{\n\tstruct pci_dev *pci_dev = container_of(mhi_cntrl->cntrl_dev, struct pci_dev, dev);\n\tint ret;\n\n\tret = mhi_async_power_up(mhi_cntrl);\n\tif (ret)\n\t\tpci_err(pci_dev, \"mhi_async_power_up failed after reset %d\\n\", ret);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}