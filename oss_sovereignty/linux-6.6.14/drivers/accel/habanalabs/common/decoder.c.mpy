{
  "module_name": "decoder.c",
  "hash_id": "7b966d20b720118761bc115b52743f322b952add658dad60762a9822d938e19a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/accel/habanalabs/common/decoder.c",
  "human_readable_source": "\n\n \n\n#include \"habanalabs.h\"\n\n#define VCMD_CONTROL_OFFSET\t\t\t0x40\t \n#define VCMD_IRQ_STATUS_OFFSET\t\t\t0x44\t \n\n#define VCMD_IRQ_STATUS_ENDCMD_MASK\t\t0x1\n#define VCMD_IRQ_STATUS_BUSERR_MASK\t\t0x2\n#define VCMD_IRQ_STATUS_TIMEOUT_MASK\t\t0x4\n#define VCMD_IRQ_STATUS_CMDERR_MASK\t\t0x8\n#define VCMD_IRQ_STATUS_ABORT_MASK\t\t0x10\n#define VCMD_IRQ_STATUS_RESET_MASK\t\t0x20\n\nstatic void dec_print_abnrm_intr_source(struct hl_device *hdev, u32 irq_status)\n{\n\tconst char *format = \"abnormal interrupt source:%s%s%s%s%s%s\\n\";\n\tchar *intr_source[6] = {\"Unknown\", \"\", \"\", \"\", \"\", \"\"};\n\tint i = 0;\n\n\tif (!irq_status)\n\t\treturn;\n\n\tif (irq_status & VCMD_IRQ_STATUS_ENDCMD_MASK)\n\t\tintr_source[i++] = \" ENDCMD\";\n\tif (irq_status & VCMD_IRQ_STATUS_BUSERR_MASK)\n\t\tintr_source[i++] = \" BUSERR\";\n\tif (irq_status & VCMD_IRQ_STATUS_TIMEOUT_MASK)\n\t\tintr_source[i++] = \" TIMEOUT\";\n\tif (irq_status & VCMD_IRQ_STATUS_CMDERR_MASK)\n\t\tintr_source[i++] = \" CMDERR\";\n\tif (irq_status & VCMD_IRQ_STATUS_ABORT_MASK)\n\t\tintr_source[i++] = \" ABORT\";\n\tif (irq_status & VCMD_IRQ_STATUS_RESET_MASK)\n\t\tintr_source[i++] = \" RESET\";\n\n\tdev_err(hdev->dev, format, intr_source[0], intr_source[1],\n\t\tintr_source[2], intr_source[3], intr_source[4], intr_source[5]);\n}\n\nstatic void dec_abnrm_intr_work(struct work_struct *work)\n{\n\tstruct hl_dec *dec = container_of(work, struct hl_dec, abnrm_intr_work);\n\tstruct hl_device *hdev = dec->hdev;\n\tu32 irq_status, event_mask = 0;\n\tbool reset_required = false;\n\n\tirq_status = RREG32(dec->base_addr + VCMD_IRQ_STATUS_OFFSET);\n\n\tdev_err(hdev->dev, \"Decoder abnormal interrupt %#x, core %d\\n\", irq_status, dec->core_id);\n\n\tdec_print_abnrm_intr_source(hdev, irq_status);\n\n\t \n\tWREG32(dec->base_addr + VCMD_IRQ_STATUS_OFFSET, irq_status);\n\n\t \n\tRREG32(dec->base_addr + VCMD_IRQ_STATUS_OFFSET);\n\n\tif (irq_status & VCMD_IRQ_STATUS_TIMEOUT_MASK) {\n\t\treset_required = true;\n\t\tevent_mask |= HL_NOTIFIER_EVENT_GENERAL_HW_ERR;\n\t}\n\n\tif (irq_status & VCMD_IRQ_STATUS_CMDERR_MASK)\n\t\tevent_mask |= HL_NOTIFIER_EVENT_UNDEFINED_OPCODE;\n\n\tif (irq_status & (VCMD_IRQ_STATUS_ENDCMD_MASK |\n\t\t\t\tVCMD_IRQ_STATUS_BUSERR_MASK |\n\t\t\t\tVCMD_IRQ_STATUS_ABORT_MASK))\n\t\tevent_mask |= HL_NOTIFIER_EVENT_USER_ENGINE_ERR;\n\n\tif (reset_required) {\n\t\tevent_mask |= HL_NOTIFIER_EVENT_DEVICE_RESET;\n\t\thl_device_cond_reset(hdev, 0, event_mask);\n\t} else if (event_mask) {\n\t\thl_notifier_event_send_all(hdev, event_mask);\n\t}\n}\n\nvoid hl_dec_fini(struct hl_device *hdev)\n{\n\tkfree(hdev->dec);\n}\n\nint hl_dec_init(struct hl_device *hdev)\n{\n\tstruct asic_fixed_properties *prop = &hdev->asic_prop;\n\tstruct hl_dec *dec;\n\tint rc, j;\n\n\t \n\tif (!prop->max_dec)\n\t\treturn 0;\n\n\thdev->dec = kcalloc(prop->max_dec, sizeof(struct hl_dec), GFP_KERNEL);\n\tif (!hdev->dec)\n\t\treturn -ENOMEM;\n\n\tfor (j = 0 ; j < prop->max_dec ; j++) {\n\t\tdec = hdev->dec + j;\n\n\t\tdec->hdev = hdev;\n\t\tINIT_WORK(&dec->abnrm_intr_work, dec_abnrm_intr_work);\n\t\tdec->core_id = j;\n\t\tdec->base_addr = hdev->asic_funcs->get_dec_base_addr(hdev, j);\n\t\tif (!dec->base_addr) {\n\t\t\tdev_err(hdev->dev, \"Invalid base address of decoder %d\\n\", j);\n\t\t\trc = -EINVAL;\n\t\t\tgoto err_dec_fini;\n\t\t}\n\t}\n\n\treturn 0;\n\nerr_dec_fini:\n\thl_dec_fini(hdev);\n\n\treturn rc;\n}\n\nvoid hl_dec_ctx_fini(struct hl_ctx *ctx)\n{\n\tstruct hl_device *hdev = ctx->hdev;\n\tstruct asic_fixed_properties *prop = &hdev->asic_prop;\n\tstruct hl_dec *dec;\n\tint j;\n\n\tfor (j = 0 ; j < prop->max_dec ; j++) {\n\t\tif (!!(prop->decoder_enabled_mask & BIT(j))) {\n\t\t\tdec = hdev->dec + j;\n\t\t\t \n\t\t\tWREG32(dec->base_addr + VCMD_CONTROL_OFFSET, 0);\n\t\t}\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}