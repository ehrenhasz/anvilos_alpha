{
  "module_name": "ivpu_debugfs.c",
  "hash_id": "be96ecbd2d0ffa3af54cff5e0e775881739509177ad206e28442f1e3273dcd57",
  "original_prompt": "Ingested from linux-6.6.14/drivers/accel/ivpu/ivpu_debugfs.c",
  "human_readable_source": "\n \n\n#include <drm/drm_debugfs.h>\n#include <drm/drm_file.h>\n#include <drm/drm_print.h>\n\n#include <uapi/drm/ivpu_accel.h>\n\n#include \"ivpu_debugfs.h\"\n#include \"ivpu_drv.h\"\n#include \"ivpu_fw.h\"\n#include \"ivpu_fw_log.h\"\n#include \"ivpu_gem.h\"\n#include \"ivpu_jsm_msg.h\"\n#include \"ivpu_pm.h\"\n\nstatic int bo_list_show(struct seq_file *s, void *v)\n{\n\tstruct drm_info_node *node = (struct drm_info_node *)s->private;\n\tstruct drm_printer p = drm_seq_file_printer(s);\n\n\tivpu_bo_list(node->minor->dev, &p);\n\n\treturn 0;\n}\n\nstatic int fw_name_show(struct seq_file *s, void *v)\n{\n\tstruct drm_info_node *node = (struct drm_info_node *)s->private;\n\tstruct ivpu_device *vdev = to_ivpu_device(node->minor->dev);\n\n\tseq_printf(s, \"%s\\n\", vdev->fw->name);\n\treturn 0;\n}\n\nstatic int fw_trace_capability_show(struct seq_file *s, void *v)\n{\n\tstruct drm_info_node *node = (struct drm_info_node *)s->private;\n\tstruct ivpu_device *vdev = to_ivpu_device(node->minor->dev);\n\tu64 trace_hw_component_mask;\n\tu32 trace_destination_mask;\n\tint ret;\n\n\tret = ivpu_jsm_trace_get_capability(vdev, &trace_destination_mask,\n\t\t\t\t\t    &trace_hw_component_mask);\n\tif (!ret) {\n\t\tseq_printf(s,\n\t\t\t   \"trace_destination_mask:  %#18x\\n\"\n\t\t\t   \"trace_hw_component_mask: %#18llx\\n\",\n\t\t\t   trace_destination_mask, trace_hw_component_mask);\n\t}\n\treturn 0;\n}\n\nstatic int fw_trace_config_show(struct seq_file *s, void *v)\n{\n\tstruct drm_info_node *node = (struct drm_info_node *)s->private;\n\tstruct ivpu_device *vdev = to_ivpu_device(node->minor->dev);\n\t \n\tu32 trace_level = vdev->fw->trace_level;\n\tu32 trace_destination_mask = vdev->fw->trace_destination_mask;\n\tu64 trace_hw_component_mask = vdev->fw->trace_hw_component_mask;\n\n\tseq_printf(s,\n\t\t   \"trace_level:             %#18x\\n\"\n\t\t   \"trace_destination_mask:  %#18x\\n\"\n\t\t   \"trace_hw_component_mask: %#18llx\\n\",\n\t\t   trace_level, trace_destination_mask, trace_hw_component_mask);\n\n\treturn 0;\n}\n\nstatic int last_bootmode_show(struct seq_file *s, void *v)\n{\n\tstruct drm_info_node *node = (struct drm_info_node *)s->private;\n\tstruct ivpu_device *vdev = to_ivpu_device(node->minor->dev);\n\n\tseq_printf(s, \"%s\\n\", (vdev->pm->is_warmboot) ? \"warmboot\" : \"coldboot\");\n\n\treturn 0;\n}\n\nstatic int reset_counter_show(struct seq_file *s, void *v)\n{\n\tstruct drm_info_node *node = (struct drm_info_node *)s->private;\n\tstruct ivpu_device *vdev = to_ivpu_device(node->minor->dev);\n\n\tseq_printf(s, \"%d\\n\", atomic_read(&vdev->pm->reset_counter));\n\treturn 0;\n}\n\nstatic int reset_pending_show(struct seq_file *s, void *v)\n{\n\tstruct drm_info_node *node = (struct drm_info_node *)s->private;\n\tstruct ivpu_device *vdev = to_ivpu_device(node->minor->dev);\n\n\tseq_printf(s, \"%d\\n\", atomic_read(&vdev->pm->in_reset));\n\treturn 0;\n}\n\nstatic const struct drm_info_list vdev_debugfs_list[] = {\n\t{\"bo_list\", bo_list_show, 0},\n\t{\"fw_name\", fw_name_show, 0},\n\t{\"fw_trace_capability\", fw_trace_capability_show, 0},\n\t{\"fw_trace_config\", fw_trace_config_show, 0},\n\t{\"last_bootmode\", last_bootmode_show, 0},\n\t{\"reset_counter\", reset_counter_show, 0},\n\t{\"reset_pending\", reset_pending_show, 0},\n};\n\nstatic int fw_log_show(struct seq_file *s, void *v)\n{\n\tstruct ivpu_device *vdev = s->private;\n\tstruct drm_printer p = drm_seq_file_printer(s);\n\n\tivpu_fw_log_print(vdev, true, &p);\n\treturn 0;\n}\n\nstatic int fw_log_fops_open(struct inode *inode, struct file *file)\n{\n\treturn single_open(file, fw_log_show, inode->i_private);\n}\n\nstatic ssize_t\nfw_log_fops_write(struct file *file, const char __user *user_buf, size_t size, loff_t *pos)\n{\n\tstruct seq_file *s = file->private_data;\n\tstruct ivpu_device *vdev = s->private;\n\n\tif (!size)\n\t\treturn -EINVAL;\n\n\tivpu_fw_log_clear(vdev);\n\treturn size;\n}\n\nstatic const struct file_operations fw_log_fops = {\n\t.owner = THIS_MODULE,\n\t.open = fw_log_fops_open,\n\t.write = fw_log_fops_write,\n\t.read = seq_read,\n\t.llseek = seq_lseek,\n\t.release = single_release,\n};\n\nstatic ssize_t\nfw_trace_destination_mask_fops_write(struct file *file, const char __user *user_buf,\n\t\t\t\t     size_t size, loff_t *pos)\n{\n\tstruct ivpu_device *vdev = file->private_data;\n\tstruct ivpu_fw_info *fw = vdev->fw;\n\tu32 trace_destination_mask;\n\tint ret;\n\n\tret = kstrtou32_from_user(user_buf, size, 0, &trace_destination_mask);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfw->trace_destination_mask = trace_destination_mask;\n\n\tivpu_jsm_trace_set_config(vdev, fw->trace_level, trace_destination_mask,\n\t\t\t\t  fw->trace_hw_component_mask);\n\n\treturn size;\n}\n\nstatic const struct file_operations fw_trace_destination_mask_fops = {\n\t.owner = THIS_MODULE,\n\t.open = simple_open,\n\t.write = fw_trace_destination_mask_fops_write,\n};\n\nstatic ssize_t\nfw_trace_hw_comp_mask_fops_write(struct file *file, const char __user *user_buf,\n\t\t\t\t size_t size, loff_t *pos)\n{\n\tstruct ivpu_device *vdev = file->private_data;\n\tstruct ivpu_fw_info *fw = vdev->fw;\n\tu64 trace_hw_component_mask;\n\tint ret;\n\n\tret = kstrtou64_from_user(user_buf, size, 0, &trace_hw_component_mask);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfw->trace_hw_component_mask = trace_hw_component_mask;\n\n\tivpu_jsm_trace_set_config(vdev, fw->trace_level, fw->trace_destination_mask,\n\t\t\t\t  trace_hw_component_mask);\n\n\treturn size;\n}\n\nstatic const struct file_operations fw_trace_hw_comp_mask_fops = {\n\t.owner = THIS_MODULE,\n\t.open = simple_open,\n\t.write = fw_trace_hw_comp_mask_fops_write,\n};\n\nstatic ssize_t\nfw_trace_level_fops_write(struct file *file, const char __user *user_buf, size_t size, loff_t *pos)\n{\n\tstruct ivpu_device *vdev = file->private_data;\n\tstruct ivpu_fw_info *fw = vdev->fw;\n\tu32 trace_level;\n\tint ret;\n\n\tret = kstrtou32_from_user(user_buf, size, 0, &trace_level);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfw->trace_level = trace_level;\n\n\tivpu_jsm_trace_set_config(vdev, trace_level, fw->trace_destination_mask,\n\t\t\t\t  fw->trace_hw_component_mask);\n\n\treturn size;\n}\n\nstatic const struct file_operations fw_trace_level_fops = {\n\t.owner = THIS_MODULE,\n\t.open = simple_open,\n\t.write = fw_trace_level_fops_write,\n};\n\nstatic ssize_t\nivpu_reset_engine_fn(struct file *file, const char __user *user_buf, size_t size, loff_t *pos)\n{\n\tstruct ivpu_device *vdev = file->private_data;\n\n\tif (!size)\n\t\treturn -EINVAL;\n\n\tif (ivpu_jsm_reset_engine(vdev, DRM_IVPU_ENGINE_COMPUTE))\n\t\treturn -ENODEV;\n\tif (ivpu_jsm_reset_engine(vdev, DRM_IVPU_ENGINE_COPY))\n\t\treturn -ENODEV;\n\n\treturn size;\n}\n\nstatic ssize_t\nivpu_force_recovery_fn(struct file *file, const char __user *user_buf, size_t size, loff_t *pos)\n{\n\tstruct ivpu_device *vdev = file->private_data;\n\n\tif (!size)\n\t\treturn -EINVAL;\n\n\tivpu_pm_schedule_recovery(vdev);\n\treturn size;\n}\n\nstatic const struct file_operations ivpu_force_recovery_fops = {\n\t.owner = THIS_MODULE,\n\t.open = simple_open,\n\t.write = ivpu_force_recovery_fn,\n};\n\nstatic const struct file_operations ivpu_reset_engine_fops = {\n\t.owner = THIS_MODULE,\n\t.open = simple_open,\n\t.write = ivpu_reset_engine_fn,\n};\n\nvoid ivpu_debugfs_init(struct drm_minor *minor)\n{\n\tstruct ivpu_device *vdev = to_ivpu_device(minor->dev);\n\n\tdrm_debugfs_create_files(vdev_debugfs_list, ARRAY_SIZE(vdev_debugfs_list),\n\t\t\t\t minor->debugfs_root, minor);\n\n\tdebugfs_create_file(\"force_recovery\", 0200, minor->debugfs_root, vdev,\n\t\t\t    &ivpu_force_recovery_fops);\n\n\tdebugfs_create_file(\"fw_log\", 0644, minor->debugfs_root, vdev,\n\t\t\t    &fw_log_fops);\n\tdebugfs_create_file(\"fw_trace_destination_mask\", 0200, minor->debugfs_root, vdev,\n\t\t\t    &fw_trace_destination_mask_fops);\n\tdebugfs_create_file(\"fw_trace_hw_comp_mask\", 0200, minor->debugfs_root, vdev,\n\t\t\t    &fw_trace_hw_comp_mask_fops);\n\tdebugfs_create_file(\"fw_trace_level\", 0200, minor->debugfs_root, vdev,\n\t\t\t    &fw_trace_level_fops);\n\n\tdebugfs_create_file(\"reset_engine\", 0200, minor->debugfs_root, vdev,\n\t\t\t    &ivpu_reset_engine_fops);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}