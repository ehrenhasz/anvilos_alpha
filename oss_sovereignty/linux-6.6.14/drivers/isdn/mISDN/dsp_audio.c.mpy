{
  "module_name": "dsp_audio.c",
  "hash_id": "7e07b8832d7588cfd9e5ce88422299bc0ec27dc38380e2268497944e9ffe3c2a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/isdn/mISDN/dsp_audio.c",
  "human_readable_source": " \n\n#include <linux/delay.h>\n#include <linux/mISDNif.h>\n#include <linux/mISDNdsp.h>\n#include <linux/export.h>\n#include <linux/bitrev.h>\n#include \"core.h\"\n#include \"dsp.h\"\n\n \ns32 dsp_audio_ulaw_to_s32[256];\n \ns32 dsp_audio_alaw_to_s32[256];\n\ns32 *dsp_audio_law_to_s32;\nEXPORT_SYMBOL(dsp_audio_law_to_s32);\n\n \nu8 dsp_audio_s16_to_law[65536];\nEXPORT_SYMBOL(dsp_audio_s16_to_law);\n\n \nu8 dsp_audio_alaw_to_ulaw[256];\n \nstatic u8 dsp_audio_ulaw_to_alaw[256];\nu8 dsp_silence;\n\n\n \n\n#define AMI_MASK 0x55\n\nstatic inline unsigned char linear2alaw(short int linear)\n{\n\tint mask;\n\tint seg;\n\tint pcm_val;\n\tstatic int seg_end[8] = {\n\t\t0xFF, 0x1FF, 0x3FF, 0x7FF, 0xFFF, 0x1FFF, 0x3FFF, 0x7FFF\n\t};\n\n\tpcm_val = linear;\n\tif (pcm_val >= 0) {\n\t\t \n\t\tmask = AMI_MASK | 0x80;\n\t} else {\n\t\t \n\t\tmask = AMI_MASK;\n\t\tpcm_val = -pcm_val;\n\t}\n\n\t \n\tfor (seg = 0; seg < 8; seg++) {\n\t\tif (pcm_val <= seg_end[seg])\n\t\t\tbreak;\n\t}\n\t \n\treturn  ((seg << 4) |\n\t\t ((pcm_val >> ((seg)  ?  (seg + 3)  :  4)) & 0x0F)) ^ mask;\n}\n\n\nstatic inline short int alaw2linear(unsigned char alaw)\n{\n\tint i;\n\tint seg;\n\n\talaw ^= AMI_MASK;\n\ti = ((alaw & 0x0F) << 4) + 8  ;\n\tseg = (((int) alaw & 0x70) >> 4);\n\tif (seg)\n\t\ti = (i + 0x100) << (seg - 1);\n\treturn (short int) ((alaw & 0x80)  ?  i  :  -i);\n}\n\nstatic inline short int ulaw2linear(unsigned char ulaw)\n{\n\tshort mu, e, f, y;\n\tstatic short etab[] = {0, 132, 396, 924, 1980, 4092, 8316, 16764};\n\n\tmu = 255 - ulaw;\n\te = (mu & 0x70) / 16;\n\tf = mu & 0x0f;\n\ty = f * (1 << (e + 3));\n\ty += etab[e];\n\tif (mu & 0x80)\n\t\ty = -y;\n\treturn y;\n}\n\n#define BIAS 0x84    \n\nstatic unsigned char linear2ulaw(short sample)\n{\n\tstatic int exp_lut[256] = {\n\t\t0, 0, 1, 1, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3, 3,\n\t\t4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,\n\t\t5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,\n\t\t5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,\n\t\t6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,\n\t\t6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,\n\t\t6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,\n\t\t6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,\n\t\t7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,\n\t\t7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,\n\t\t7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,\n\t\t7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,\n\t\t7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,\n\t\t7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,\n\t\t7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7,\n\t\t7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7, 7};\n\tint sign, exponent, mantissa;\n\tunsigned char ulawbyte;\n\n\t \n\tsign = (sample >> 8) & 0x80;\t   \n\tif (sign != 0)\n\t\tsample = -sample;\t       \n\n\t \n\tsample = sample + BIAS;\n\texponent = exp_lut[(sample >> 7) & 0xFF];\n\tmantissa = (sample >> (exponent + 3)) & 0x0F;\n\tulawbyte = ~(sign | (exponent << 4) | mantissa);\n\n\treturn ulawbyte;\n}\n\nvoid dsp_audio_generate_law_tables(void)\n{\n\tint i;\n\tfor (i = 0; i < 256; i++)\n\t\tdsp_audio_alaw_to_s32[i] = alaw2linear(bitrev8((u8)i));\n\n\tfor (i = 0; i < 256; i++)\n\t\tdsp_audio_ulaw_to_s32[i] = ulaw2linear(bitrev8((u8)i));\n\n\tfor (i = 0; i < 256; i++) {\n\t\tdsp_audio_alaw_to_ulaw[i] =\n\t\t\tlinear2ulaw(dsp_audio_alaw_to_s32[i]);\n\t\tdsp_audio_ulaw_to_alaw[i] =\n\t\t\tlinear2alaw(dsp_audio_ulaw_to_s32[i]);\n\t}\n}\n\nvoid\ndsp_audio_generate_s2law_table(void)\n{\n\tint i;\n\n\tif (dsp_options & DSP_OPT_ULAW) {\n\t\t \n\t\tfor (i = -32768; i < 32768; i++) {\n\t\t\tdsp_audio_s16_to_law[i & 0xffff] =\n\t\t\t\tbitrev8(linear2ulaw(i));\n\t\t}\n\t} else {\n\t\t \n\t\tfor (i = -32768; i < 32768; i++) {\n\t\t\tdsp_audio_s16_to_law[i & 0xffff] =\n\t\t\t\tbitrev8(linear2alaw(i));\n\t\t}\n\t}\n}\n\n\n \nu8 dsp_audio_seven2law[128];\nu8 dsp_audio_law2seven[256];\n\n \n\nvoid\ndsp_audio_generate_seven(void)\n{\n\tint i, j, k;\n\tu8 spl;\n\tu8 sorted_alaw[256];\n\n\t \n\tfor (i = 0; i < 256; i++) {\n\t\tj = 0;\n\t\tfor (k = 0; k < 256; k++) {\n\t\t\tif (dsp_audio_alaw_to_s32[k]\n\t\t\t    < dsp_audio_alaw_to_s32[i])\n\t\t\t\tj++;\n\t\t}\n\t\tsorted_alaw[j] = i;\n\t}\n\n\t \n\tfor (i = 0; i < 256; i++) {\n\t\t \n\t\tspl = i;\n\t\tif (dsp_options & DSP_OPT_ULAW)\n\t\t\tspl = dsp_audio_ulaw_to_alaw[i];\n\t\t \n\t\tfor (j = 0; j < 256; j++) {\n\t\t\tif (sorted_alaw[j] == spl)\n\t\t\t\tbreak;\n\t\t}\n\t\t \n\t\tdsp_audio_law2seven[i] = j >> 1;\n\t}\n\tfor (i = 0; i < 128; i++) {\n\t\tspl = sorted_alaw[i << 1];\n\t\tif (dsp_options & DSP_OPT_ULAW)\n\t\t\tspl = dsp_audio_alaw_to_ulaw[spl];\n\t\tdsp_audio_seven2law[i] = spl;\n\t}\n}\n\n\n \nu8 dsp_audio_mix_law[65536];\n\n \n\nvoid\ndsp_audio_generate_mix_table(void)\n{\n\tint i, j;\n\ts32 sample;\n\n\ti = 0;\n\twhile (i < 256) {\n\t\tj = 0;\n\t\twhile (j < 256) {\n\t\t\tsample = dsp_audio_law_to_s32[i];\n\t\t\tsample += dsp_audio_law_to_s32[j];\n\t\t\tif (sample > 32767)\n\t\t\t\tsample = 32767;\n\t\t\tif (sample < -32768)\n\t\t\t\tsample = -32768;\n\t\t\tdsp_audio_mix_law[(i << 8) | j] =\n\t\t\t\tdsp_audio_s16_to_law[sample & 0xffff];\n\t\t\tj++;\n\t\t}\n\t\ti++;\n\t}\n}\n\n\n \n\nstatic u8 dsp_audio_reduce8[256];\nstatic u8 dsp_audio_reduce7[256];\nstatic u8 dsp_audio_reduce6[256];\nstatic u8 dsp_audio_reduce5[256];\nstatic u8 dsp_audio_reduce4[256];\nstatic u8 dsp_audio_reduce3[256];\nstatic u8 dsp_audio_reduce2[256];\nstatic u8 dsp_audio_reduce1[256];\nstatic u8 dsp_audio_increase1[256];\nstatic u8 dsp_audio_increase2[256];\nstatic u8 dsp_audio_increase3[256];\nstatic u8 dsp_audio_increase4[256];\nstatic u8 dsp_audio_increase5[256];\nstatic u8 dsp_audio_increase6[256];\nstatic u8 dsp_audio_increase7[256];\nstatic u8 dsp_audio_increase8[256];\n\nstatic u8 *dsp_audio_volume_change[16] = {\n\tdsp_audio_reduce8,\n\tdsp_audio_reduce7,\n\tdsp_audio_reduce6,\n\tdsp_audio_reduce5,\n\tdsp_audio_reduce4,\n\tdsp_audio_reduce3,\n\tdsp_audio_reduce2,\n\tdsp_audio_reduce1,\n\tdsp_audio_increase1,\n\tdsp_audio_increase2,\n\tdsp_audio_increase3,\n\tdsp_audio_increase4,\n\tdsp_audio_increase5,\n\tdsp_audio_increase6,\n\tdsp_audio_increase7,\n\tdsp_audio_increase8,\n};\n\nvoid\ndsp_audio_generate_volume_changes(void)\n{\n\tregister s32 sample;\n\tint i;\n\tint num[]   = { 110, 125, 150, 175, 200, 300, 400, 500 };\n\tint denum[] = { 100, 100, 100, 100, 100, 100, 100, 100 };\n\n\ti = 0;\n\twhile (i < 256) {\n\t\tdsp_audio_reduce8[i] = dsp_audio_s16_to_law[\n\t\t\t(dsp_audio_law_to_s32[i] * denum[7] / num[7]) & 0xffff];\n\t\tdsp_audio_reduce7[i] = dsp_audio_s16_to_law[\n\t\t\t(dsp_audio_law_to_s32[i] * denum[6] / num[6]) & 0xffff];\n\t\tdsp_audio_reduce6[i] = dsp_audio_s16_to_law[\n\t\t\t(dsp_audio_law_to_s32[i] * denum[5] / num[5]) & 0xffff];\n\t\tdsp_audio_reduce5[i] = dsp_audio_s16_to_law[\n\t\t\t(dsp_audio_law_to_s32[i] * denum[4] / num[4]) & 0xffff];\n\t\tdsp_audio_reduce4[i] = dsp_audio_s16_to_law[\n\t\t\t(dsp_audio_law_to_s32[i] * denum[3] / num[3]) & 0xffff];\n\t\tdsp_audio_reduce3[i] = dsp_audio_s16_to_law[\n\t\t\t(dsp_audio_law_to_s32[i] * denum[2] / num[2]) & 0xffff];\n\t\tdsp_audio_reduce2[i] = dsp_audio_s16_to_law[\n\t\t\t(dsp_audio_law_to_s32[i] * denum[1] / num[1]) & 0xffff];\n\t\tdsp_audio_reduce1[i] = dsp_audio_s16_to_law[\n\t\t\t(dsp_audio_law_to_s32[i] * denum[0] / num[0]) & 0xffff];\n\t\tsample = dsp_audio_law_to_s32[i] * num[0] / denum[0];\n\t\tif (sample < -32768)\n\t\t\tsample = -32768;\n\t\telse if (sample > 32767)\n\t\t\tsample = 32767;\n\t\tdsp_audio_increase1[i] = dsp_audio_s16_to_law[sample & 0xffff];\n\t\tsample = dsp_audio_law_to_s32[i] * num[1] / denum[1];\n\t\tif (sample < -32768)\n\t\t\tsample = -32768;\n\t\telse if (sample > 32767)\n\t\t\tsample = 32767;\n\t\tdsp_audio_increase2[i] = dsp_audio_s16_to_law[sample & 0xffff];\n\t\tsample = dsp_audio_law_to_s32[i] * num[2] / denum[2];\n\t\tif (sample < -32768)\n\t\t\tsample = -32768;\n\t\telse if (sample > 32767)\n\t\t\tsample = 32767;\n\t\tdsp_audio_increase3[i] = dsp_audio_s16_to_law[sample & 0xffff];\n\t\tsample = dsp_audio_law_to_s32[i] * num[3] / denum[3];\n\t\tif (sample < -32768)\n\t\t\tsample = -32768;\n\t\telse if (sample > 32767)\n\t\t\tsample = 32767;\n\t\tdsp_audio_increase4[i] = dsp_audio_s16_to_law[sample & 0xffff];\n\t\tsample = dsp_audio_law_to_s32[i] * num[4] / denum[4];\n\t\tif (sample < -32768)\n\t\t\tsample = -32768;\n\t\telse if (sample > 32767)\n\t\t\tsample = 32767;\n\t\tdsp_audio_increase5[i] = dsp_audio_s16_to_law[sample & 0xffff];\n\t\tsample = dsp_audio_law_to_s32[i] * num[5] / denum[5];\n\t\tif (sample < -32768)\n\t\t\tsample = -32768;\n\t\telse if (sample > 32767)\n\t\t\tsample = 32767;\n\t\tdsp_audio_increase6[i] = dsp_audio_s16_to_law[sample & 0xffff];\n\t\tsample = dsp_audio_law_to_s32[i] * num[6] / denum[6];\n\t\tif (sample < -32768)\n\t\t\tsample = -32768;\n\t\telse if (sample > 32767)\n\t\t\tsample = 32767;\n\t\tdsp_audio_increase7[i] = dsp_audio_s16_to_law[sample & 0xffff];\n\t\tsample = dsp_audio_law_to_s32[i] * num[7] / denum[7];\n\t\tif (sample < -32768)\n\t\t\tsample = -32768;\n\t\telse if (sample > 32767)\n\t\t\tsample = 32767;\n\t\tdsp_audio_increase8[i] = dsp_audio_s16_to_law[sample & 0xffff];\n\n\t\ti++;\n\t}\n}\n\n\n \n\n \nvoid\ndsp_change_volume(struct sk_buff *skb, int volume)\n{\n\tu8 *volume_change;\n\tint i, ii;\n\tu8 *p;\n\tint shift;\n\n\tif (volume == 0)\n\t\treturn;\n\n\t \n\tif (volume < 0) {\n\t\tshift = volume + 8;\n\t\tif (shift < 0)\n\t\t\tshift = 0;\n\t} else {\n\t\tshift = volume + 7;\n\t\tif (shift > 15)\n\t\t\tshift = 15;\n\t}\n\tvolume_change = dsp_audio_volume_change[shift];\n\ti = 0;\n\tii = skb->len;\n\tp = skb->data;\n\t \n\twhile (i < ii) {\n\t\t*p = volume_change[*p];\n\t\tp++;\n\t\ti++;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}