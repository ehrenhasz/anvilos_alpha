{
  "module_name": "isdnhdlc.c",
  "hash_id": "33a1378026a308069cfff55ecd243a4bc39b277dcc99c28308d8da3375979022",
  "original_prompt": "Ingested from linux-6.6.14/drivers/isdn/hardware/mISDN/isdnhdlc.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/crc-ccitt.h>\n#include <linux/bitrev.h>\n#include \"isdnhdlc.h\"\n\n \n\nMODULE_AUTHOR(\"Wolfgang M\u00fces <wolfgang@iksw-muees.de>, \"\n\t      \"Frode Isaksen <fisaksen@bewan.com>, \"\n\t      \"Kai Germaschewski <kai.germaschewski@gmx.de>\");\nMODULE_DESCRIPTION(\"General purpose ISDN HDLC decoder\");\nMODULE_LICENSE(\"GPL\");\n\n \n\nenum {\n\tHDLC_FAST_IDLE, HDLC_GET_FLAG_B0, HDLC_GETFLAG_B1A6, HDLC_GETFLAG_B7,\n\tHDLC_GET_DATA, HDLC_FAST_FLAG\n};\n\nenum {\n\tHDLC_SEND_DATA, HDLC_SEND_CRC1, HDLC_SEND_FAST_FLAG,\n\tHDLC_SEND_FIRST_FLAG, HDLC_SEND_CRC2, HDLC_SEND_CLOSING_FLAG,\n\tHDLC_SEND_IDLE1, HDLC_SEND_FAST_IDLE, HDLC_SENDFLAG_B0,\n\tHDLC_SENDFLAG_B1A6, HDLC_SENDFLAG_B7, STOPPED, HDLC_SENDFLAG_ONE\n};\n\nvoid isdnhdlc_rcv_init(struct isdnhdlc_vars *hdlc, u32 features)\n{\n\tmemset(hdlc, 0, sizeof(struct isdnhdlc_vars));\n\thdlc->state = HDLC_GET_DATA;\n\tif (features & HDLC_56KBIT)\n\t\thdlc->do_adapt56 = 1;\n\tif (features & HDLC_BITREVERSE)\n\t\thdlc->do_bitreverse = 1;\n}\nEXPORT_SYMBOL(isdnhdlc_out_init);\n\nvoid isdnhdlc_out_init(struct isdnhdlc_vars *hdlc, u32 features)\n{\n\tmemset(hdlc, 0, sizeof(struct isdnhdlc_vars));\n\tif (features & HDLC_DCHANNEL) {\n\t\thdlc->dchannel = 1;\n\t\thdlc->state = HDLC_SEND_FIRST_FLAG;\n\t} else {\n\t\thdlc->dchannel = 0;\n\t\thdlc->state = HDLC_SEND_FAST_FLAG;\n\t\thdlc->ffvalue = 0x7e;\n\t}\n\thdlc->cbin = 0x7e;\n\tif (features & HDLC_56KBIT) {\n\t\thdlc->do_adapt56 = 1;\n\t\thdlc->state = HDLC_SENDFLAG_B0;\n\t} else\n\t\thdlc->data_bits = 8;\n\tif (features & HDLC_BITREVERSE)\n\t\thdlc->do_bitreverse = 1;\n}\nEXPORT_SYMBOL(isdnhdlc_rcv_init);\n\nstatic int\ncheck_frame(struct isdnhdlc_vars *hdlc)\n{\n\tint status;\n\n\tif (hdlc->dstpos < 2)\t \n\t\tstatus = -HDLC_FRAMING_ERROR;\n\telse if (hdlc->crc != 0xf0b8)\t \n\t\tstatus = -HDLC_CRC_ERROR;\n\telse {\n\t\t \n\t\thdlc->dstpos -= 2;\n\t\t \n\t\tstatus = hdlc->dstpos;\n\t}\n\treturn status;\n}\n\n \nint isdnhdlc_decode(struct isdnhdlc_vars *hdlc, const u8 *src, int slen,\n\t\t    int *count, u8 *dst, int dsize)\n{\n\tint status = 0;\n\n\tstatic const unsigned char fast_flag[] = {\n\t\t0x00, 0x00, 0x00, 0x20, 0x30, 0x38, 0x3c, 0x3e, 0x3f\n\t};\n\n\tstatic const unsigned char fast_flag_value[] = {\n\t\t0x00, 0x7e, 0xfc, 0xf9, 0xf3, 0xe7, 0xcf, 0x9f, 0x3f\n\t};\n\n\tstatic const unsigned char fast_abort[] = {\n\t\t0x00, 0x00, 0x80, 0xc0, 0xe0, 0xf0, 0xf8, 0xfc, 0xfe, 0xff\n\t};\n\n#define handle_fast_flag(h)\t\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\tif (h->cbin == fast_flag[h->bit_shift]) {\t\t\\\n\t\t\th->ffvalue = fast_flag_value[h->bit_shift];\t\\\n\t\t\th->state = HDLC_FAST_FLAG;\t\t\t\\\n\t\t\th->ffbit_shift = h->bit_shift;\t\t\t\\\n\t\t\th->bit_shift = 1;\t\t\t\t\\\n\t\t} else {\t\t\t\t\t\t\\\n\t\t\th->state = HDLC_GET_DATA;\t\t\t\\\n\t\t\th->data_received = 0;\t\t\t\t\\\n\t\t}\t\t\t\t\t\t\t\\\n\t} while (0)\n\n#define handle_abort(h)\t\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\th->shift_reg = fast_abort[h->ffbit_shift - 1];\t\\\n\t\th->hdlc_bits1 = h->ffbit_shift - 2;\t\t\\\n\t\tif (h->hdlc_bits1 < 0)\t\t\t\t\\\n\t\t\th->hdlc_bits1 = 0;\t\t\t\\\n\t\th->data_bits = h->ffbit_shift - 1;\t\t\\\n\t\th->state = HDLC_GET_DATA;\t\t\t\\\n\t\th->data_received = 0;\t\t\t\t\\\n\t} while (0)\n\n\t*count = slen;\n\n\twhile (slen > 0) {\n\t\tif (hdlc->bit_shift == 0) {\n\t\t\t \n\t\t\tif (hdlc->do_bitreverse == 0)\n\t\t\t\thdlc->cbin = bitrev8(*src++);\n\t\t\telse\n\t\t\t\thdlc->cbin = *src++;\n\t\t\tslen--;\n\t\t\thdlc->bit_shift = 8;\n\t\t\tif (hdlc->do_adapt56)\n\t\t\t\thdlc->bit_shift--;\n\t\t}\n\n\t\tswitch (hdlc->state) {\n\t\tcase STOPPED:\n\t\t\treturn 0;\n\t\tcase HDLC_FAST_IDLE:\n\t\t\tif (hdlc->cbin == 0xff) {\n\t\t\t\thdlc->bit_shift = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\thdlc->state = HDLC_GET_FLAG_B0;\n\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\thdlc->bit_shift = 8;\n\t\t\tbreak;\n\t\tcase HDLC_GET_FLAG_B0:\n\t\t\tif (!(hdlc->cbin & 0x80)) {\n\t\t\t\thdlc->state = HDLC_GETFLAG_B1A6;\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t} else {\n\t\t\t\tif ((!hdlc->do_adapt56) &&\n\t\t\t\t    (++hdlc->hdlc_bits1 >= 8) &&\n\t\t\t\t    (hdlc->bit_shift == 1))\n\t\t\t\t\thdlc->state = HDLC_FAST_IDLE;\n\t\t\t}\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->bit_shift--;\n\t\t\tbreak;\n\t\tcase HDLC_GETFLAG_B1A6:\n\t\t\tif (hdlc->cbin & 0x80) {\n\t\t\t\thdlc->hdlc_bits1++;\n\t\t\t\tif (hdlc->hdlc_bits1 == 6)\n\t\t\t\t\thdlc->state = HDLC_GETFLAG_B7;\n\t\t\t} else\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->bit_shift--;\n\t\t\tbreak;\n\t\tcase HDLC_GETFLAG_B7:\n\t\t\tif (hdlc->cbin & 0x80) {\n\t\t\t\thdlc->state = HDLC_GET_FLAG_B0;\n\t\t\t} else {\n\t\t\t\thdlc->state = HDLC_GET_DATA;\n\t\t\t\thdlc->crc = 0xffff;\n\t\t\t\thdlc->shift_reg = 0;\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\thdlc->data_bits = 0;\n\t\t\t\thdlc->data_received = 0;\n\t\t\t}\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->bit_shift--;\n\t\t\tbreak;\n\t\tcase HDLC_GET_DATA:\n\t\t\tif (hdlc->cbin & 0x80) {\n\t\t\t\thdlc->hdlc_bits1++;\n\t\t\t\tswitch (hdlc->hdlc_bits1) {\n\t\t\t\tcase 6:\n\t\t\t\t\tbreak;\n\t\t\t\tcase 7:\n\t\t\t\t\tif (hdlc->data_received)\n\t\t\t\t\t\t \n\t\t\t\t\t\tstatus = -HDLC_FRAMING_ERROR;\n\t\t\t\t\tif (!hdlc->do_adapt56) {\n\t\t\t\t\t\tif (hdlc->cbin == fast_abort\n\t\t\t\t\t\t    [hdlc->bit_shift + 1]) {\n\t\t\t\t\t\t\thdlc->state =\n\t\t\t\t\t\t\t\tHDLC_FAST_IDLE;\n\t\t\t\t\t\t\thdlc->bit_shift = 1;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else\n\t\t\t\t\t\thdlc->state = HDLC_GET_FLAG_B0;\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\thdlc->shift_reg >>= 1;\n\t\t\t\t\thdlc->shift_reg |= 0x80;\n\t\t\t\t\thdlc->data_bits++;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tswitch (hdlc->hdlc_bits1) {\n\t\t\t\tcase 5:\n\t\t\t\t\tbreak;\n\t\t\t\tcase 6:\n\t\t\t\t\tif (hdlc->data_received)\n\t\t\t\t\t\tstatus = check_frame(hdlc);\n\t\t\t\t\thdlc->crc = 0xffff;\n\t\t\t\t\thdlc->shift_reg = 0;\n\t\t\t\t\thdlc->data_bits = 0;\n\t\t\t\t\tif (!hdlc->do_adapt56)\n\t\t\t\t\t\thandle_fast_flag(hdlc);\n\t\t\t\t\telse {\n\t\t\t\t\t\thdlc->state = HDLC_GET_DATA;\n\t\t\t\t\t\thdlc->data_received = 0;\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t\tdefault:\n\t\t\t\t\thdlc->shift_reg >>= 1;\n\t\t\t\t\thdlc->data_bits++;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t}\n\t\t\tif (status) {\n\t\t\t\thdlc->dstpos = 0;\n\t\t\t\t*count -= slen;\n\t\t\t\thdlc->cbin <<= 1;\n\t\t\t\thdlc->bit_shift--;\n\t\t\t\treturn status;\n\t\t\t}\n\t\t\tif (hdlc->data_bits == 8) {\n\t\t\t\thdlc->data_bits = 0;\n\t\t\t\thdlc->data_received = 1;\n\t\t\t\thdlc->crc = crc_ccitt_byte(hdlc->crc,\n\t\t\t\t\t\t\t   hdlc->shift_reg);\n\n\t\t\t\t \n\t\t\t\tif (hdlc->dstpos < dsize)\n\t\t\t\t\tdst[hdlc->dstpos++] = hdlc->shift_reg;\n\t\t\t\telse {\n\t\t\t\t\t \n\t\t\t\t\tstatus = -HDLC_LENGTH_ERROR;\n\t\t\t\t\thdlc->dstpos = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->bit_shift--;\n\t\t\tbreak;\n\t\tcase HDLC_FAST_FLAG:\n\t\t\tif (hdlc->cbin == hdlc->ffvalue) {\n\t\t\t\thdlc->bit_shift = 0;\n\t\t\t\tbreak;\n\t\t\t} else {\n\t\t\t\tif (hdlc->cbin == 0xff) {\n\t\t\t\t\thdlc->state = HDLC_FAST_IDLE;\n\t\t\t\t\thdlc->bit_shift = 0;\n\t\t\t\t} else if (hdlc->ffbit_shift == 8) {\n\t\t\t\t\thdlc->state = HDLC_GETFLAG_B7;\n\t\t\t\t\tbreak;\n\t\t\t\t} else\n\t\t\t\t\thandle_abort(hdlc);\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\t*count -= slen;\n\treturn 0;\n}\nEXPORT_SYMBOL(isdnhdlc_decode);\n \nint isdnhdlc_encode(struct isdnhdlc_vars *hdlc, const u8 *src, u16 slen,\n\t\t    int *count, u8 *dst, int dsize)\n{\n\tstatic const unsigned char xfast_flag_value[] = {\n\t\t0x7e, 0x3f, 0x9f, 0xcf, 0xe7, 0xf3, 0xf9, 0xfc, 0x7e\n\t};\n\n\tint len = 0;\n\n\t*count = slen;\n\n\t \n\tif ((slen == 1) && (hdlc->state == HDLC_SEND_FAST_FLAG))\n\t\thdlc->state = HDLC_SENDFLAG_ONE;\n\twhile (dsize > 0) {\n\t\tif (hdlc->bit_shift == 0) {\n\t\t\tif (slen && !hdlc->do_closing) {\n\t\t\t\thdlc->shift_reg = *src++;\n\t\t\t\tslen--;\n\t\t\t\tif (slen == 0)\n\t\t\t\t\t \n\t\t\t\t\thdlc->do_closing = 1;\n\t\t\t\thdlc->bit_shift = 8;\n\t\t\t} else {\n\t\t\t\tif (hdlc->state == HDLC_SEND_DATA) {\n\t\t\t\t\tif (hdlc->data_received) {\n\t\t\t\t\t\thdlc->state = HDLC_SEND_CRC1;\n\t\t\t\t\t\thdlc->crc ^= 0xffff;\n\t\t\t\t\t\thdlc->bit_shift = 8;\n\t\t\t\t\t\thdlc->shift_reg =\n\t\t\t\t\t\t\thdlc->crc & 0xff;\n\t\t\t\t\t} else if (!hdlc->do_adapt56)\n\t\t\t\t\t\thdlc->state =\n\t\t\t\t\t\t\tHDLC_SEND_FAST_FLAG;\n\t\t\t\t\telse\n\t\t\t\t\t\thdlc->state =\n\t\t\t\t\t\t\tHDLC_SENDFLAG_B0;\n\t\t\t\t}\n\n\t\t\t}\n\t\t}\n\n\t\tswitch (hdlc->state) {\n\t\tcase STOPPED:\n\t\t\twhile (dsize--)\n\t\t\t\t*dst++ = 0xff;\n\t\t\treturn dsize;\n\t\tcase HDLC_SEND_FAST_FLAG:\n\t\t\thdlc->do_closing = 0;\n\t\t\tif (slen == 0) {\n\t\t\t\t \n\t\t\t\tif (hdlc->do_bitreverse == 0)\n\t\t\t\t\t*dst++ = bitrev8(hdlc->ffvalue);\n\t\t\t\telse\n\t\t\t\t\t*dst++ = hdlc->ffvalue;\n\t\t\t\tlen++;\n\t\t\t\tdsize--;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tfallthrough;\n\t\tcase HDLC_SENDFLAG_ONE:\n\t\t\tif (hdlc->bit_shift == 8) {\n\t\t\t\thdlc->cbin = hdlc->ffvalue >>\n\t\t\t\t\t(8 - hdlc->data_bits);\n\t\t\t\thdlc->state = HDLC_SEND_DATA;\n\t\t\t\thdlc->crc = 0xffff;\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\thdlc->data_received = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase HDLC_SENDFLAG_B0:\n\t\t\thdlc->do_closing = 0;\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->data_bits++;\n\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\thdlc->state = HDLC_SENDFLAG_B1A6;\n\t\t\tbreak;\n\t\tcase HDLC_SENDFLAG_B1A6:\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->data_bits++;\n\t\t\thdlc->cbin++;\n\t\t\tif (++hdlc->hdlc_bits1 == 6)\n\t\t\t\thdlc->state = HDLC_SENDFLAG_B7;\n\t\t\tbreak;\n\t\tcase HDLC_SENDFLAG_B7:\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->data_bits++;\n\t\t\tif (slen == 0) {\n\t\t\t\thdlc->state = HDLC_SENDFLAG_B0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (hdlc->bit_shift == 8) {\n\t\t\t\thdlc->state = HDLC_SEND_DATA;\n\t\t\t\thdlc->crc = 0xffff;\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\thdlc->data_received = 1;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase HDLC_SEND_FIRST_FLAG:\n\t\t\thdlc->data_received = 1;\n\t\t\tif (hdlc->data_bits == 8) {\n\t\t\t\thdlc->state = HDLC_SEND_DATA;\n\t\t\t\thdlc->crc = 0xffff;\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->data_bits++;\n\t\t\tif (hdlc->shift_reg & 0x01)\n\t\t\t\thdlc->cbin++;\n\t\t\thdlc->shift_reg >>= 1;\n\t\t\thdlc->bit_shift--;\n\t\t\tif (hdlc->bit_shift == 0) {\n\t\t\t\thdlc->state = HDLC_SEND_DATA;\n\t\t\t\thdlc->crc = 0xffff;\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase HDLC_SEND_DATA:\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->data_bits++;\n\t\t\tif (hdlc->hdlc_bits1 == 5) {\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (hdlc->bit_shift == 8)\n\t\t\t\thdlc->crc = crc_ccitt_byte(hdlc->crc,\n\t\t\t\t\t\t\t   hdlc->shift_reg);\n\t\t\tif (hdlc->shift_reg & 0x01) {\n\t\t\t\thdlc->hdlc_bits1++;\n\t\t\t\thdlc->cbin++;\n\t\t\t\thdlc->shift_reg >>= 1;\n\t\t\t\thdlc->bit_shift--;\n\t\t\t} else {\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\thdlc->shift_reg >>= 1;\n\t\t\t\thdlc->bit_shift--;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase HDLC_SEND_CRC1:\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->data_bits++;\n\t\t\tif (hdlc->hdlc_bits1 == 5) {\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (hdlc->shift_reg & 0x01) {\n\t\t\t\thdlc->hdlc_bits1++;\n\t\t\t\thdlc->cbin++;\n\t\t\t\thdlc->shift_reg >>= 1;\n\t\t\t\thdlc->bit_shift--;\n\t\t\t} else {\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\thdlc->shift_reg >>= 1;\n\t\t\t\thdlc->bit_shift--;\n\t\t\t}\n\t\t\tif (hdlc->bit_shift == 0) {\n\t\t\t\thdlc->shift_reg = (hdlc->crc >> 8);\n\t\t\t\thdlc->state = HDLC_SEND_CRC2;\n\t\t\t\thdlc->bit_shift = 8;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase HDLC_SEND_CRC2:\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->data_bits++;\n\t\t\tif (hdlc->hdlc_bits1 == 5) {\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (hdlc->shift_reg & 0x01) {\n\t\t\t\thdlc->hdlc_bits1++;\n\t\t\t\thdlc->cbin++;\n\t\t\t\thdlc->shift_reg >>= 1;\n\t\t\t\thdlc->bit_shift--;\n\t\t\t} else {\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\thdlc->shift_reg >>= 1;\n\t\t\t\thdlc->bit_shift--;\n\t\t\t}\n\t\t\tif (hdlc->bit_shift == 0) {\n\t\t\t\thdlc->shift_reg = 0x7e;\n\t\t\t\thdlc->state = HDLC_SEND_CLOSING_FLAG;\n\t\t\t\thdlc->bit_shift = 8;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase HDLC_SEND_CLOSING_FLAG:\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->data_bits++;\n\t\t\tif (hdlc->hdlc_bits1 == 5) {\n\t\t\t\thdlc->hdlc_bits1 = 0;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (hdlc->shift_reg & 0x01)\n\t\t\t\thdlc->cbin++;\n\t\t\thdlc->shift_reg >>= 1;\n\t\t\thdlc->bit_shift--;\n\t\t\tif (hdlc->bit_shift == 0) {\n\t\t\t\thdlc->ffvalue =\n\t\t\t\t\txfast_flag_value[hdlc->data_bits];\n\t\t\t\tif (hdlc->dchannel) {\n\t\t\t\t\thdlc->ffvalue = 0x7e;\n\t\t\t\t\thdlc->state = HDLC_SEND_IDLE1;\n\t\t\t\t\thdlc->bit_shift = 8-hdlc->data_bits;\n\t\t\t\t\tif (hdlc->bit_shift == 0)\n\t\t\t\t\t\thdlc->state =\n\t\t\t\t\t\t\tHDLC_SEND_FAST_IDLE;\n\t\t\t\t} else {\n\t\t\t\t\tif (!hdlc->do_adapt56) {\n\t\t\t\t\t\thdlc->state =\n\t\t\t\t\t\t\tHDLC_SEND_FAST_FLAG;\n\t\t\t\t\t\thdlc->data_received = 0;\n\t\t\t\t\t} else {\n\t\t\t\t\t\thdlc->state = HDLC_SENDFLAG_B0;\n\t\t\t\t\t\thdlc->data_received = 0;\n\t\t\t\t\t}\n\t\t\t\t\t \n\t\t\t\t\tif (dsize > 1)\n\t\t\t\t\t\tdsize = 1;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase HDLC_SEND_IDLE1:\n\t\t\thdlc->do_closing = 0;\n\t\t\thdlc->cbin <<= 1;\n\t\t\thdlc->cbin++;\n\t\t\thdlc->data_bits++;\n\t\t\thdlc->bit_shift--;\n\t\t\tif (hdlc->bit_shift == 0) {\n\t\t\t\thdlc->state = HDLC_SEND_FAST_IDLE;\n\t\t\t\thdlc->bit_shift = 0;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase HDLC_SEND_FAST_IDLE:\n\t\t\thdlc->do_closing = 0;\n\t\t\thdlc->cbin = 0xff;\n\t\t\thdlc->data_bits = 8;\n\t\t\tif (hdlc->bit_shift == 8) {\n\t\t\t\thdlc->cbin = 0x7e;\n\t\t\t\thdlc->state = HDLC_SEND_FIRST_FLAG;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tif (hdlc->do_bitreverse == 0)\n\t\t\t\t\t*dst++ = bitrev8(hdlc->cbin);\n\t\t\t\telse\n\t\t\t\t\t*dst++ = hdlc->cbin;\n\t\t\t\thdlc->bit_shift = 0;\n\t\t\t\thdlc->data_bits = 0;\n\t\t\t\tlen++;\n\t\t\t\tdsize = 0;\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tif (hdlc->do_adapt56) {\n\t\t\tif (hdlc->data_bits == 7) {\n\t\t\t\thdlc->cbin <<= 1;\n\t\t\t\thdlc->cbin++;\n\t\t\t\thdlc->data_bits++;\n\t\t\t}\n\t\t}\n\t\tif (hdlc->data_bits == 8) {\n\t\t\t \n\t\t\tif (hdlc->do_bitreverse == 0)\n\t\t\t\t*dst++ = bitrev8(hdlc->cbin);\n\t\t\telse\n\t\t\t\t*dst++ = hdlc->cbin;\n\t\t\thdlc->data_bits = 0;\n\t\t\tlen++;\n\t\t\tdsize--;\n\t\t}\n\t}\n\t*count -= slen;\n\n\treturn len;\n}\nEXPORT_SYMBOL(isdnhdlc_encode);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}