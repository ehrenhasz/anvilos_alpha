{
  "module_name": "remoteproc_sysfs.c",
  "hash_id": "9d3bc7ace3d02cd1968583d5c5fdca39a3ee6343637df4105ca36a9363b48fb6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/remoteproc/remoteproc_sysfs.c",
  "human_readable_source": "\n \n\n#include <linux/remoteproc.h>\n#include <linux/slab.h>\n\n#include \"remoteproc_internal.h\"\n\n#define to_rproc(d) container_of(d, struct rproc, dev)\n\nstatic ssize_t recovery_show(struct device *dev,\n\t\t\t     struct device_attribute *attr, char *buf)\n{\n\tstruct rproc *rproc = to_rproc(dev);\n\n\treturn sysfs_emit(buf, \"%s\", rproc->recovery_disabled ? \"disabled\\n\" : \"enabled\\n\");\n}\n\n \nstatic ssize_t recovery_store(struct device *dev,\n\t\t\t      struct device_attribute *attr,\n\t\t\t      const char *buf, size_t count)\n{\n\tstruct rproc *rproc = to_rproc(dev);\n\n\tif (sysfs_streq(buf, \"enabled\")) {\n\t\t \n\t\trproc->recovery_disabled = false;\n\t\trproc_trigger_recovery(rproc);\n\t} else if (sysfs_streq(buf, \"disabled\")) {\n\t\trproc->recovery_disabled = true;\n\t} else if (sysfs_streq(buf, \"recover\")) {\n\t\t \n\t\trproc_trigger_recovery(rproc);\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\treturn count;\n}\nstatic DEVICE_ATTR_RW(recovery);\n\n \nstatic const char * const rproc_coredump_str[] = {\n\t[RPROC_COREDUMP_DISABLED]\t= \"disabled\",\n\t[RPROC_COREDUMP_ENABLED]\t= \"enabled\",\n\t[RPROC_COREDUMP_INLINE]\t\t= \"inline\",\n};\n\n \nstatic ssize_t coredump_show(struct device *dev,\n\t\t\t     struct device_attribute *attr, char *buf)\n{\n\tstruct rproc *rproc = to_rproc(dev);\n\n\treturn sysfs_emit(buf, \"%s\\n\", rproc_coredump_str[rproc->dump_conf]);\n}\n\n \nstatic ssize_t coredump_store(struct device *dev,\n\t\t\t      struct device_attribute *attr,\n\t\t\t      const char *buf, size_t count)\n{\n\tstruct rproc *rproc = to_rproc(dev);\n\n\tif (rproc->state == RPROC_CRASHED) {\n\t\tdev_err(&rproc->dev, \"can't change coredump configuration\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\tif (sysfs_streq(buf, \"disabled\")) {\n\t\trproc->dump_conf = RPROC_COREDUMP_DISABLED;\n\t} else if (sysfs_streq(buf, \"enabled\")) {\n\t\trproc->dump_conf = RPROC_COREDUMP_ENABLED;\n\t} else if (sysfs_streq(buf, \"inline\")) {\n\t\trproc->dump_conf = RPROC_COREDUMP_INLINE;\n\t} else {\n\t\tdev_err(&rproc->dev, \"Invalid coredump configuration\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn count;\n}\nstatic DEVICE_ATTR_RW(coredump);\n\n \nstatic ssize_t firmware_show(struct device *dev, struct device_attribute *attr,\n\t\t\t  char *buf)\n{\n\tstruct rproc *rproc = to_rproc(dev);\n\tconst char *firmware = rproc->firmware;\n\n\t \n\tif (rproc->state == RPROC_ATTACHED)\n\t\tfirmware = \"unknown\";\n\n\treturn sprintf(buf, \"%s\\n\", firmware);\n}\n\n \nstatic ssize_t firmware_store(struct device *dev,\n\t\t\t      struct device_attribute *attr,\n\t\t\t      const char *buf, size_t count)\n{\n\tstruct rproc *rproc = to_rproc(dev);\n\tint err;\n\n\terr = rproc_set_firmware(rproc, buf);\n\n\treturn err ? err : count;\n}\nstatic DEVICE_ATTR_RW(firmware);\n\n \nstatic const char * const rproc_state_string[] = {\n\t[RPROC_OFFLINE]\t\t= \"offline\",\n\t[RPROC_SUSPENDED]\t= \"suspended\",\n\t[RPROC_RUNNING]\t\t= \"running\",\n\t[RPROC_CRASHED]\t\t= \"crashed\",\n\t[RPROC_DELETED]\t\t= \"deleted\",\n\t[RPROC_ATTACHED]\t= \"attached\",\n\t[RPROC_DETACHED]\t= \"detached\",\n\t[RPROC_LAST]\t\t= \"invalid\",\n};\n\n \nstatic ssize_t state_show(struct device *dev, struct device_attribute *attr,\n\t\t\t  char *buf)\n{\n\tstruct rproc *rproc = to_rproc(dev);\n\tunsigned int state;\n\n\tstate = rproc->state > RPROC_LAST ? RPROC_LAST : rproc->state;\n\treturn sprintf(buf, \"%s\\n\", rproc_state_string[state]);\n}\n\n \nstatic ssize_t state_store(struct device *dev,\n\t\t\t      struct device_attribute *attr,\n\t\t\t      const char *buf, size_t count)\n{\n\tstruct rproc *rproc = to_rproc(dev);\n\tint ret = 0;\n\n\tif (sysfs_streq(buf, \"start\")) {\n\t\tret = rproc_boot(rproc);\n\t\tif (ret)\n\t\t\tdev_err(&rproc->dev, \"Boot failed: %d\\n\", ret);\n\t} else if (sysfs_streq(buf, \"stop\")) {\n\t\tret = rproc_shutdown(rproc);\n\t} else if (sysfs_streq(buf, \"detach\")) {\n\t\tret = rproc_detach(rproc);\n\t} else {\n\t\tdev_err(&rproc->dev, \"Unrecognised option: %s\\n\", buf);\n\t\tret = -EINVAL;\n\t}\n\treturn ret ? ret : count;\n}\nstatic DEVICE_ATTR_RW(state);\n\n \nstatic ssize_t name_show(struct device *dev, struct device_attribute *attr,\n\t\t\t char *buf)\n{\n\tstruct rproc *rproc = to_rproc(dev);\n\n\treturn sprintf(buf, \"%s\\n\", rproc->name);\n}\nstatic DEVICE_ATTR_RO(name);\n\nstatic umode_t rproc_is_visible(struct kobject *kobj, struct attribute *attr,\n\t\t\t\tint n)\n{\n\tstruct device *dev = kobj_to_dev(kobj);\n\tstruct rproc *rproc = to_rproc(dev);\n\tumode_t mode = attr->mode;\n\n\tif (rproc->sysfs_read_only && (attr == &dev_attr_recovery.attr ||\n\t\t\t\t       attr == &dev_attr_firmware.attr ||\n\t\t\t\t       attr == &dev_attr_state.attr ||\n\t\t\t\t       attr == &dev_attr_coredump.attr))\n\t\tmode = 0444;\n\n\treturn mode;\n}\n\nstatic struct attribute *rproc_attrs[] = {\n\t&dev_attr_coredump.attr,\n\t&dev_attr_recovery.attr,\n\t&dev_attr_firmware.attr,\n\t&dev_attr_state.attr,\n\t&dev_attr_name.attr,\n\tNULL\n};\n\nstatic const struct attribute_group rproc_devgroup = {\n\t.attrs = rproc_attrs,\n\t.is_visible = rproc_is_visible,\n};\n\nstatic const struct attribute_group *rproc_devgroups[] = {\n\t&rproc_devgroup,\n\tNULL\n};\n\nstruct class rproc_class = {\n\t.name\t\t= \"remoteproc\",\n\t.dev_groups\t= rproc_devgroups,\n};\n\nint __init rproc_init_sysfs(void)\n{\n\t \n\tint err = class_register(&rproc_class);\n\n\tif (err)\n\t\tpr_err(\"remoteproc: unable to register class\\n\");\n\treturn err;\n}\n\nvoid __exit rproc_exit_sysfs(void)\n{\n\tclass_unregister(&rproc_class);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}