{
  "module_name": "extcon-max77693.c",
  "hash_id": "cfd6a276b29b55dc41dea1a1f9b0b6703bb341509ff4afa2d138582ec127c836",
  "original_prompt": "Ingested from linux-6.6.14/drivers/extcon/extcon-max77693.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/devm-helpers.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/i2c.h>\n#include <linux/slab.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/mfd/max77693.h>\n#include <linux/mfd/max77693-common.h>\n#include <linux/mfd/max77693-private.h>\n#include <linux/extcon-provider.h>\n#include <linux/regmap.h>\n#include <linux/irqdomain.h>\n\n#define\tDEV_NAME\t\t\t\"max77693-muic\"\n#define\tDELAY_MS_DEFAULT\t\t20000\t\t \n\n \nstatic struct max77693_reg_data default_init_data[] = {\n\t{\n\t\t \n\t\t.addr = MAX77693_MUIC_REG_STATUS2,\n\t\t.data = MAX77693_STATUS2_CHGDETRUN_MASK,\n\t}, {\n\t\t \n\t\t.addr = MAX77693_MUIC_REG_INTMASK1,\n\t\t.data = INTMASK1_ADC1K_MASK\n\t\t\t| INTMASK1_ADC_MASK,\n\t}, {\n\t\t \n\t\t.addr = MAX77693_MUIC_REG_INTMASK2,\n\t\t.data = INTMASK2_CHGTYP_MASK,\n\t}, {\n\t\t \n\t\t.addr = MAX77693_MUIC_REG_INTMASK3,\n\t\t.data = 0x0,\n\t}, {\n\t\t \n\t\t.addr = MAX77693_MUIC_REG_CDETCTRL2,\n\t\t.data = CDETCTRL2_VIDRMEN_MASK\n\t\t\t| CDETCTRL2_DXOVPEN_MASK,\n\t},\n};\n\nenum max77693_muic_adc_debounce_time {\n\tADC_DEBOUNCE_TIME_5MS = 0,\n\tADC_DEBOUNCE_TIME_10MS,\n\tADC_DEBOUNCE_TIME_25MS,\n\tADC_DEBOUNCE_TIME_38_62MS,\n};\n\nstruct max77693_muic_info {\n\tstruct device *dev;\n\tstruct max77693_dev *max77693;\n\tstruct extcon_dev *edev;\n\tint prev_cable_type;\n\tint prev_cable_type_gnd;\n\tint prev_chg_type;\n\tint prev_button_type;\n\tu8 status[2];\n\n\tint irq;\n\tstruct work_struct irq_work;\n\tstruct mutex mutex;\n\n\t \n\tstruct delayed_work wq_detcable;\n\n\t \n\tstruct input_dev *dock;\n\n\t \n\tint path_usb;\n\tint path_uart;\n};\n\nenum max77693_muic_cable_group {\n\tMAX77693_CABLE_GROUP_ADC = 0,\n\tMAX77693_CABLE_GROUP_ADC_GND,\n\tMAX77693_CABLE_GROUP_CHG,\n\tMAX77693_CABLE_GROUP_VBVOLT,\n};\n\nenum max77693_muic_charger_type {\n\tMAX77693_CHARGER_TYPE_NONE = 0,\n\tMAX77693_CHARGER_TYPE_USB,\n\tMAX77693_CHARGER_TYPE_DOWNSTREAM_PORT,\n\tMAX77693_CHARGER_TYPE_DEDICATED_CHG,\n\tMAX77693_CHARGER_TYPE_APPLE_500MA,\n\tMAX77693_CHARGER_TYPE_APPLE_1A_2A,\n\tMAX77693_CHARGER_TYPE_DEAD_BATTERY = 7,\n};\n\n \nstruct max77693_muic_irq {\n\tunsigned int irq;\n\tconst char *name;\n\tunsigned int virq;\n};\n\nstatic struct max77693_muic_irq muic_irqs[] = {\n\t{ MAX77693_MUIC_IRQ_INT1_ADC,\t\t\"muic-ADC\" },\n\t{ MAX77693_MUIC_IRQ_INT1_ADC_LOW,\t\"muic-ADCLOW\" },\n\t{ MAX77693_MUIC_IRQ_INT1_ADC_ERR,\t\"muic-ADCError\" },\n\t{ MAX77693_MUIC_IRQ_INT1_ADC1K,\t\t\"muic-ADC1K\" },\n\t{ MAX77693_MUIC_IRQ_INT2_CHGTYP,\t\"muic-CHGTYP\" },\n\t{ MAX77693_MUIC_IRQ_INT2_CHGDETREUN,\t\"muic-CHGDETREUN\" },\n\t{ MAX77693_MUIC_IRQ_INT2_DCDTMR,\t\"muic-DCDTMR\" },\n\t{ MAX77693_MUIC_IRQ_INT2_DXOVP,\t\t\"muic-DXOVP\" },\n\t{ MAX77693_MUIC_IRQ_INT2_VBVOLT,\t\"muic-VBVOLT\" },\n\t{ MAX77693_MUIC_IRQ_INT2_VIDRM,\t\t\"muic-VIDRM\" },\n\t{ MAX77693_MUIC_IRQ_INT3_EOC,\t\t\"muic-EOC\" },\n\t{ MAX77693_MUIC_IRQ_INT3_CGMBC,\t\t\"muic-CGMBC\" },\n\t{ MAX77693_MUIC_IRQ_INT3_OVP,\t\t\"muic-OVP\" },\n\t{ MAX77693_MUIC_IRQ_INT3_MBCCHG_ERR,\t\"muic-MBCCHG_ERR\" },\n\t{ MAX77693_MUIC_IRQ_INT3_CHG_ENABLED,\t\"muic-CHG_ENABLED\" },\n\t{ MAX77693_MUIC_IRQ_INT3_BAT_DET,\t\"muic-BAT_DET\" },\n};\n\n \nenum max77693_muic_acc_type {\n\tMAX77693_MUIC_ADC_GROUND = 0x0,\n\tMAX77693_MUIC_ADC_SEND_END_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S1_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S2_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S3_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S4_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S5_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S6_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S7_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S8_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S9_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S10_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S11_BUTTON,\n\tMAX77693_MUIC_ADC_REMOTE_S12_BUTTON,\n\tMAX77693_MUIC_ADC_RESERVED_ACC_1,\n\tMAX77693_MUIC_ADC_RESERVED_ACC_2,\n\tMAX77693_MUIC_ADC_RESERVED_ACC_3,\n\tMAX77693_MUIC_ADC_RESERVED_ACC_4,\n\tMAX77693_MUIC_ADC_RESERVED_ACC_5,\n\tMAX77693_MUIC_ADC_CEA936_AUDIO,\n\tMAX77693_MUIC_ADC_PHONE_POWERED_DEV,\n\tMAX77693_MUIC_ADC_TTY_CONVERTER,\n\tMAX77693_MUIC_ADC_UART_CABLE,\n\tMAX77693_MUIC_ADC_CEA936A_TYPE1_CHG,\n\tMAX77693_MUIC_ADC_FACTORY_MODE_USB_OFF,\n\tMAX77693_MUIC_ADC_FACTORY_MODE_USB_ON,\n\tMAX77693_MUIC_ADC_AV_CABLE_NOLOAD,\n\tMAX77693_MUIC_ADC_CEA936A_TYPE2_CHG,\n\tMAX77693_MUIC_ADC_FACTORY_MODE_UART_OFF,\n\tMAX77693_MUIC_ADC_FACTORY_MODE_UART_ON,\n\tMAX77693_MUIC_ADC_AUDIO_MODE_REMOTE,\n\tMAX77693_MUIC_ADC_OPEN,\n\n\t \n\t\t\t\t\t\t \n\tMAX77693_MUIC_GND_USB_HOST = 0x100,\t \n\tMAX77693_MUIC_GND_USB_HOST_VB = 0x104,\t \n\tMAX77693_MUIC_GND_AV_CABLE_LOAD = 0x102, \n\tMAX77693_MUIC_GND_MHL = 0x103,\t\t \n\tMAX77693_MUIC_GND_MHL_VB = 0x107,\t \n};\n\n \nstatic const unsigned int max77693_extcon_cable[] = {\n\tEXTCON_USB,\n\tEXTCON_USB_HOST,\n\tEXTCON_CHG_USB_SDP,\n\tEXTCON_CHG_USB_DCP,\n\tEXTCON_CHG_USB_FAST,\n\tEXTCON_CHG_USB_SLOW,\n\tEXTCON_CHG_USB_CDP,\n\tEXTCON_DISP_MHL,\n\tEXTCON_JIG,\n\tEXTCON_DOCK,\n\tEXTCON_NONE,\n};\n\n \nstatic int max77693_muic_set_debounce_time(struct max77693_muic_info *info,\n\t\tenum max77693_muic_adc_debounce_time time)\n{\n\tint ret;\n\n\tswitch (time) {\n\tcase ADC_DEBOUNCE_TIME_5MS:\n\tcase ADC_DEBOUNCE_TIME_10MS:\n\tcase ADC_DEBOUNCE_TIME_25MS:\n\tcase ADC_DEBOUNCE_TIME_38_62MS:\n\t\t \n\t\tret = regmap_write(info->max77693->regmap_muic,\n\t\t\t\t  MAX77693_MUIC_REG_CTRL3,\n\t\t\t\t  time << MAX77693_CONTROL3_ADCDBSET_SHIFT);\n\t\tif (ret) {\n\t\t\tdev_err(info->dev, \"failed to set ADC debounce time\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev, \"invalid ADC debounce time\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n};\n\n \nstatic int max77693_muic_set_path(struct max77693_muic_info *info,\n\t\tu8 val, bool attached)\n{\n\tint ret;\n\tunsigned int ctrl1, ctrl2 = 0;\n\n\tif (attached)\n\t\tctrl1 = val;\n\telse\n\t\tctrl1 = MAX77693_CONTROL1_SW_OPEN;\n\n\tret = regmap_update_bits(info->max77693->regmap_muic,\n\t\t\tMAX77693_MUIC_REG_CTRL1, COMP_SW_MASK, ctrl1);\n\tif (ret < 0) {\n\t\tdev_err(info->dev, \"failed to update MUIC register\\n\");\n\t\treturn ret;\n\t}\n\n\tif (attached)\n\t\tctrl2 |= MAX77693_CONTROL2_CPEN_MASK;\t \n\telse\n\t\tctrl2 |= MAX77693_CONTROL2_LOWPWR_MASK;\t \n\n\tret = regmap_update_bits(info->max77693->regmap_muic,\n\t\t\tMAX77693_MUIC_REG_CTRL2,\n\t\t\tMAX77693_CONTROL2_LOWPWR_MASK | MAX77693_CONTROL2_CPEN_MASK,\n\t\t\tctrl2);\n\tif (ret < 0) {\n\t\tdev_err(info->dev, \"failed to update MUIC register\\n\");\n\t\treturn ret;\n\t}\n\n\tdev_info(info->dev,\n\t\t\"CONTROL1 : 0x%02x, CONTROL2 : 0x%02x, state : %s\\n\",\n\t\tctrl1, ctrl2, attached ? \"attached\" : \"detached\");\n\n\treturn 0;\n}\n\n \nstatic int max77693_muic_get_cable_type(struct max77693_muic_info *info,\n\t\tenum max77693_muic_cable_group group, bool *attached)\n{\n\tint cable_type = 0;\n\tint adc;\n\tint adc1k;\n\tint adclow;\n\tint vbvolt;\n\tint chg_type;\n\n\tswitch (group) {\n\tcase MAX77693_CABLE_GROUP_ADC:\n\t\t \n\t\tadc = info->status[0] & MAX77693_STATUS1_ADC_MASK;\n\t\tadc >>= MAX77693_STATUS1_ADC_SHIFT;\n\n\t\t \n\t\tif (adc == MAX77693_MUIC_ADC_OPEN) {\n\t\t\t*attached = false;\n\n\t\t\tcable_type = info->prev_cable_type;\n\t\t\tinfo->prev_cable_type = MAX77693_MUIC_ADC_OPEN;\n\t\t} else {\n\t\t\t*attached = true;\n\n\t\t\tcable_type = info->prev_cable_type = adc;\n\t\t}\n\t\tbreak;\n\tcase MAX77693_CABLE_GROUP_ADC_GND:\n\t\t \n\t\tadc = info->status[0] & MAX77693_STATUS1_ADC_MASK;\n\t\tadc >>= MAX77693_STATUS1_ADC_SHIFT;\n\n\t\t \n\t\tif (adc == MAX77693_MUIC_ADC_OPEN) {\n\t\t\t*attached = false;\n\n\t\t\tcable_type = info->prev_cable_type_gnd;\n\t\t\tinfo->prev_cable_type_gnd = MAX77693_MUIC_ADC_OPEN;\n\t\t} else {\n\t\t\t*attached = true;\n\n\t\t\tadclow = info->status[0] & MAX77693_STATUS1_ADCLOW_MASK;\n\t\t\tadclow >>= MAX77693_STATUS1_ADCLOW_SHIFT;\n\t\t\tadc1k = info->status[0] & MAX77693_STATUS1_ADC1K_MASK;\n\t\t\tadc1k >>= MAX77693_STATUS1_ADC1K_SHIFT;\n\n\t\t\tvbvolt = info->status[1] & MAX77693_STATUS2_VBVOLT_MASK;\n\t\t\tvbvolt >>= MAX77693_STATUS2_VBVOLT_SHIFT;\n\n\t\t\t \n\t\t\tcable_type = ((0x1 << 8)\n\t\t\t\t\t| (vbvolt << 2)\n\t\t\t\t\t| (adclow << 1)\n\t\t\t\t\t| adc1k);\n\n\t\t\tinfo->prev_cable_type = adc;\n\t\t\tinfo->prev_cable_type_gnd = cable_type;\n\t\t}\n\n\t\tbreak;\n\tcase MAX77693_CABLE_GROUP_CHG:\n\t\t \n\t\tchg_type = info->status[1] & MAX77693_STATUS2_CHGTYP_MASK;\n\t\tchg_type >>= MAX77693_STATUS2_CHGTYP_SHIFT;\n\n\t\tif (chg_type == MAX77693_CHARGER_TYPE_NONE) {\n\t\t\t*attached = false;\n\n\t\t\tcable_type = info->prev_chg_type;\n\t\t\tinfo->prev_chg_type = MAX77693_CHARGER_TYPE_NONE;\n\t\t} else {\n\t\t\t*attached = true;\n\n\t\t\t \n\t\t\tcable_type = info->prev_chg_type = chg_type;\n\t\t}\n\n\t\tbreak;\n\tcase MAX77693_CABLE_GROUP_VBVOLT:\n\t\t \n\t\tadc = info->status[0] & MAX77693_STATUS1_ADC_MASK;\n\t\tadc >>= MAX77693_STATUS1_ADC_SHIFT;\n\t\tchg_type = info->status[1] & MAX77693_STATUS2_CHGTYP_MASK;\n\t\tchg_type >>= MAX77693_STATUS2_CHGTYP_SHIFT;\n\n\t\tif (adc == MAX77693_MUIC_ADC_OPEN\n\t\t\t\t&& chg_type == MAX77693_CHARGER_TYPE_NONE)\n\t\t\t*attached = false;\n\t\telse\n\t\t\t*attached = true;\n\n\t\t \n\t\tvbvolt = info->status[1] & MAX77693_STATUS2_VBVOLT_MASK;\n\t\tvbvolt >>= MAX77693_STATUS2_VBVOLT_SHIFT;\n\n\t\tcable_type = vbvolt;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev, \"Unknown cable group (%d)\\n\", group);\n\t\tcable_type = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn cable_type;\n}\n\nstatic int max77693_muic_dock_handler(struct max77693_muic_info *info,\n\t\tint cable_type, bool attached)\n{\n\tint ret = 0;\n\tint vbvolt;\n\tbool cable_attached;\n\tunsigned int dock_id;\n\n\tdev_info(info->dev,\n\t\t\"external connector is %s (adc:0x%02x)\\n\",\n\t\tattached ? \"attached\" : \"detached\", cable_type);\n\n\tswitch (cable_type) {\n\tcase MAX77693_MUIC_ADC_RESERVED_ACC_3:\t\t \n\t\t \n\t\tvbvolt = max77693_muic_get_cable_type(info,\n\t\t\t\tMAX77693_CABLE_GROUP_VBVOLT, &cable_attached);\n\t\tif (attached && !vbvolt) {\n\t\t\tdev_warn(info->dev,\n\t\t\t\t\"Cannot detect external power supply\\n\");\n\t\t\treturn 0;\n\t\t}\n\n\t\t \n\t\tret = max77693_muic_set_path(info, info->path_usb, attached);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\textcon_set_state_sync(info->edev, EXTCON_DOCK, attached);\n\t\textcon_set_state_sync(info->edev, EXTCON_DISP_MHL, attached);\n\t\tgoto out;\n\tcase MAX77693_MUIC_ADC_AUDIO_MODE_REMOTE:\t \n\t\tdock_id = EXTCON_DOCK;\n\t\tbreak;\n\tcase MAX77693_MUIC_ADC_AV_CABLE_NOLOAD:\t\t \n\t\tdock_id = EXTCON_DOCK;\n\t\tif (!attached) {\n\t\t\textcon_set_state_sync(info->edev, EXTCON_USB, false);\n\t\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_SDP,\n\t\t\t\t\t\tfalse);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev, \"failed to detect %s dock device\\n\",\n\t\t\tattached ? \"attached\" : \"detached\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tret = max77693_muic_set_path(info, MAX77693_CONTROL1_SW_AUDIO,\n\t\t\t\t\tattached);\n\tif (ret < 0)\n\t\treturn ret;\n\textcon_set_state_sync(info->edev, dock_id, attached);\n\nout:\n\treturn 0;\n}\n\nstatic int max77693_muic_dock_button_handler(struct max77693_muic_info *info,\n\t\tint button_type, bool attached)\n{\n\tstruct input_dev *dock = info->dock;\n\tunsigned int code;\n\n\tswitch (button_type) {\n\tcase MAX77693_MUIC_ADC_REMOTE_S3_BUTTON-1\n\t\t... MAX77693_MUIC_ADC_REMOTE_S3_BUTTON+1:\n\t\t \n\t\tcode = KEY_PREVIOUSSONG;\n\t\tbreak;\n\tcase MAX77693_MUIC_ADC_REMOTE_S7_BUTTON-1\n\t\t... MAX77693_MUIC_ADC_REMOTE_S7_BUTTON+1:\n\t\t \n\t\tcode = KEY_NEXTSONG;\n\t\tbreak;\n\tcase MAX77693_MUIC_ADC_REMOTE_S9_BUTTON:\n\t\t \n\t\tcode = KEY_VOLUMEDOWN;\n\t\tbreak;\n\tcase MAX77693_MUIC_ADC_REMOTE_S10_BUTTON:\n\t\t \n\t\tcode = KEY_VOLUMEUP;\n\t\tbreak;\n\tcase MAX77693_MUIC_ADC_REMOTE_S12_BUTTON-1\n\t\t... MAX77693_MUIC_ADC_REMOTE_S12_BUTTON+1:\n\t\t \n\t\tcode = KEY_PLAYPAUSE;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev,\n\t\t\t\"failed to detect %s key (adc:0x%x)\\n\",\n\t\t\tattached ? \"pressed\" : \"released\", button_type);\n\t\treturn -EINVAL;\n\t}\n\n\tinput_event(dock, EV_KEY, code, attached);\n\tinput_sync(dock);\n\n\treturn 0;\n}\n\nstatic int max77693_muic_adc_ground_handler(struct max77693_muic_info *info)\n{\n\tint cable_type_gnd;\n\tint ret = 0;\n\tbool attached;\n\n\tcable_type_gnd = max77693_muic_get_cable_type(info,\n\t\t\t\tMAX77693_CABLE_GROUP_ADC_GND, &attached);\n\n\tswitch (cable_type_gnd) {\n\tcase MAX77693_MUIC_GND_USB_HOST:\n\tcase MAX77693_MUIC_GND_USB_HOST_VB:\n\t\t \n\t\tret = max77693_muic_set_path(info, MAX77693_CONTROL1_SW_USB,\n\t\t\t\t\t\tattached);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\textcon_set_state_sync(info->edev, EXTCON_USB_HOST, attached);\n\t\tbreak;\n\tcase MAX77693_MUIC_GND_AV_CABLE_LOAD:\n\t\t \n\t\tret = max77693_muic_set_path(info, MAX77693_CONTROL1_SW_AUDIO,\n\t\t\t\t\t\tattached);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\textcon_set_state_sync(info->edev, EXTCON_USB, attached);\n\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_SDP,\n\t\t\t\t\tattached);\n\t\tbreak;\n\tcase MAX77693_MUIC_GND_MHL:\n\tcase MAX77693_MUIC_GND_MHL_VB:\n\t\t \n\t\textcon_set_state_sync(info->edev, EXTCON_DISP_MHL, attached);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev, \"failed to detect %s cable of gnd type\\n\",\n\t\t\tattached ? \"attached\" : \"detached\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77693_muic_jig_handler(struct max77693_muic_info *info,\n\t\tint cable_type, bool attached)\n{\n\tint ret = 0;\n\tu8 path = MAX77693_CONTROL1_SW_OPEN;\n\n\tdev_info(info->dev,\n\t\t\"external connector is %s (adc:0x%02x)\\n\",\n\t\tattached ? \"attached\" : \"detached\", cable_type);\n\n\tswitch (cable_type) {\n\tcase MAX77693_MUIC_ADC_FACTORY_MODE_USB_OFF:\t \n\tcase MAX77693_MUIC_ADC_FACTORY_MODE_USB_ON:\t \n\t\t \n\t\tpath = MAX77693_CONTROL1_SW_USB;\n\t\tbreak;\n\tcase MAX77693_MUIC_ADC_FACTORY_MODE_UART_OFF:\t \n\tcase MAX77693_MUIC_ADC_FACTORY_MODE_UART_ON:\t \n\t\t \n\t\tpath = MAX77693_CONTROL1_SW_UART;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev, \"failed to detect %s jig cable\\n\",\n\t\t\tattached ? \"attached\" : \"detached\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = max77693_muic_set_path(info, path, attached);\n\tif (ret < 0)\n\t\treturn ret;\n\n\textcon_set_state_sync(info->edev, EXTCON_JIG, attached);\n\n\treturn 0;\n}\n\nstatic int max77693_muic_adc_handler(struct max77693_muic_info *info)\n{\n\tint cable_type;\n\tint button_type;\n\tbool attached;\n\tint ret = 0;\n\n\t \n\tcable_type = max77693_muic_get_cable_type(info,\n\t\t\t\tMAX77693_CABLE_GROUP_ADC, &attached);\n\n\tdev_info(info->dev,\n\t\t\"external connector is %s (adc:0x%02x, prev_adc:0x%x)\\n\",\n\t\tattached ? \"attached\" : \"detached\", cable_type,\n\t\tinfo->prev_cable_type);\n\n\tswitch (cable_type) {\n\tcase MAX77693_MUIC_ADC_GROUND:\n\t\t \n\t\tmax77693_muic_adc_ground_handler(info);\n\t\tbreak;\n\tcase MAX77693_MUIC_ADC_FACTORY_MODE_USB_OFF:\n\tcase MAX77693_MUIC_ADC_FACTORY_MODE_USB_ON:\n\tcase MAX77693_MUIC_ADC_FACTORY_MODE_UART_OFF:\n\tcase MAX77693_MUIC_ADC_FACTORY_MODE_UART_ON:\n\t\t \n\t\tret = max77693_muic_jig_handler(info, cable_type, attached);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase MAX77693_MUIC_ADC_RESERVED_ACC_3:\t\t \n\tcase MAX77693_MUIC_ADC_AUDIO_MODE_REMOTE:\t \n\tcase MAX77693_MUIC_ADC_AV_CABLE_NOLOAD:\t\t \n\t\t \n\t\tret = max77693_muic_dock_handler(info, cable_type, attached);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase MAX77693_MUIC_ADC_REMOTE_S3_BUTTON:       \n\tcase MAX77693_MUIC_ADC_REMOTE_S7_BUTTON:       \n\tcase MAX77693_MUIC_ADC_REMOTE_S9_BUTTON:       \n\tcase MAX77693_MUIC_ADC_REMOTE_S10_BUTTON:      \n\tcase MAX77693_MUIC_ADC_REMOTE_S12_BUTTON:      \n\t\t \n\t\tif (attached)\n\t\t\tbutton_type = info->prev_button_type = cable_type;\n\t\telse\n\t\t\tbutton_type = info->prev_button_type;\n\n\t\tret = max77693_muic_dock_button_handler(info, button_type,\n\t\t\t\t\t\t\tattached);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase MAX77693_MUIC_ADC_SEND_END_BUTTON:\n\tcase MAX77693_MUIC_ADC_REMOTE_S1_BUTTON:\n\tcase MAX77693_MUIC_ADC_REMOTE_S2_BUTTON:\n\tcase MAX77693_MUIC_ADC_REMOTE_S4_BUTTON:\n\tcase MAX77693_MUIC_ADC_REMOTE_S5_BUTTON:\n\tcase MAX77693_MUIC_ADC_REMOTE_S6_BUTTON:\n\tcase MAX77693_MUIC_ADC_REMOTE_S8_BUTTON:\n\tcase MAX77693_MUIC_ADC_REMOTE_S11_BUTTON:\n\tcase MAX77693_MUIC_ADC_RESERVED_ACC_1:\n\tcase MAX77693_MUIC_ADC_RESERVED_ACC_2:\n\tcase MAX77693_MUIC_ADC_RESERVED_ACC_4:\n\tcase MAX77693_MUIC_ADC_RESERVED_ACC_5:\n\tcase MAX77693_MUIC_ADC_CEA936_AUDIO:\n\tcase MAX77693_MUIC_ADC_PHONE_POWERED_DEV:\n\tcase MAX77693_MUIC_ADC_TTY_CONVERTER:\n\tcase MAX77693_MUIC_ADC_UART_CABLE:\n\tcase MAX77693_MUIC_ADC_CEA936A_TYPE1_CHG:\n\tcase MAX77693_MUIC_ADC_CEA936A_TYPE2_CHG:\n\t\t \n\t\tdev_info(info->dev,\n\t\t\t\"accessory is %s but it isn't used (adc:0x%x)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\", cable_type);\n\t\treturn -EAGAIN;\n\tdefault:\n\t\tdev_err(info->dev,\n\t\t\t\"failed to detect %s accessory (adc:0x%x)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\", cable_type);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77693_muic_chg_handler(struct max77693_muic_info *info)\n{\n\tint chg_type;\n\tint cable_type_gnd;\n\tint cable_type;\n\tbool attached;\n\tbool cable_attached;\n\tint ret = 0;\n\n\tchg_type = max77693_muic_get_cable_type(info,\n\t\t\t\tMAX77693_CABLE_GROUP_CHG, &attached);\n\n\tdev_info(info->dev,\n\t\t\"external connector is %s(chg_type:0x%x, prev_chg_type:0x%x)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\",\n\t\t\tchg_type, info->prev_chg_type);\n\n\tswitch (chg_type) {\n\tcase MAX77693_CHARGER_TYPE_USB:\n\tcase MAX77693_CHARGER_TYPE_DEDICATED_CHG:\n\tcase MAX77693_CHARGER_TYPE_NONE:\n\t\t \n\t\tcable_type_gnd = max77693_muic_get_cable_type(info,\n\t\t\t\t\tMAX77693_CABLE_GROUP_ADC_GND,\n\t\t\t\t\t&cable_attached);\n\t\tswitch (cable_type_gnd) {\n\t\tcase MAX77693_MUIC_GND_MHL:\n\t\tcase MAX77693_MUIC_GND_MHL_VB:\n\t\t\t \n\t\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_DCP,\n\t\t\t\t\t\tattached);\n\t\t\textcon_set_state_sync(info->edev, EXTCON_DISP_MHL,\n\t\t\t\t\t\tcable_attached);\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tcable_type = max77693_muic_get_cable_type(info,\n\t\t\t\t\tMAX77693_CABLE_GROUP_ADC,\n\t\t\t\t\t&cable_attached);\n\t\tswitch (cable_type) {\n\t\tcase MAX77693_MUIC_ADC_AV_CABLE_NOLOAD:\t\t \n\t\t\t \n\t\t\textcon_set_state_sync(info->edev, EXTCON_USB,\n\t\t\t\t\t\tattached);\n\t\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_SDP,\n\t\t\t\t\t\tattached);\n\n\t\t\tif (!cable_attached)\n\t\t\t\textcon_set_state_sync(info->edev, EXTCON_DOCK,\n\t\t\t\t\t\t\tcable_attached);\n\t\t\tbreak;\n\t\tcase MAX77693_MUIC_ADC_RESERVED_ACC_3:\t\t \n\t\t\t \n\t\t\tret = max77693_muic_set_path(info, info->path_usb,\n\t\t\t\t\t\t    attached);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\n\t\t\textcon_set_state_sync(info->edev, EXTCON_DOCK,\n\t\t\t\t\t\tattached);\n\t\t\textcon_set_state_sync(info->edev, EXTCON_DISP_MHL,\n\t\t\t\t\t\tattached);\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tswitch (chg_type) {\n\t\tcase MAX77693_CHARGER_TYPE_NONE:\n\t\t\t \n\t\t\tbreak;\n\t\tcase MAX77693_CHARGER_TYPE_USB:\n\t\t\t \n\t\t\tret = max77693_muic_set_path(info, info->path_usb,\n\t\t\t\t\t\t    attached);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\n\t\t\textcon_set_state_sync(info->edev, EXTCON_USB,\n\t\t\t\t\t\tattached);\n\t\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_SDP,\n\t\t\t\t\t\tattached);\n\t\t\tbreak;\n\t\tcase MAX77693_CHARGER_TYPE_DEDICATED_CHG:\n\t\t\t \n\t\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_DCP,\n\t\t\t\t\t\tattached);\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase MAX77693_CHARGER_TYPE_DOWNSTREAM_PORT:\n\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_CDP,\n\t\t\t\t\tattached);\n\t\tbreak;\n\tcase MAX77693_CHARGER_TYPE_APPLE_500MA:\n\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_SLOW,\n\t\t\t\t\tattached);\n\t\tbreak;\n\tcase MAX77693_CHARGER_TYPE_APPLE_1A_2A:\n\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_FAST,\n\t\t\t\t\tattached);\n\t\tbreak;\n\tcase MAX77693_CHARGER_TYPE_DEAD_BATTERY:\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev,\n\t\t\t\"failed to detect %s accessory (chg_type:0x%x)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\", chg_type);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void max77693_muic_irq_work(struct work_struct *work)\n{\n\tstruct max77693_muic_info *info = container_of(work,\n\t\t\tstruct max77693_muic_info, irq_work);\n\tint irq_type = -1;\n\tint i, ret = 0;\n\n\tif (!info->edev)\n\t\treturn;\n\n\tmutex_lock(&info->mutex);\n\n\tfor (i = 0; i < ARRAY_SIZE(muic_irqs); i++)\n\t\tif (info->irq == muic_irqs[i].virq)\n\t\t\tirq_type = muic_irqs[i].irq;\n\n\tret = regmap_bulk_read(info->max77693->regmap_muic,\n\t\t\tMAX77693_MUIC_REG_STATUS1, info->status, 2);\n\tif (ret) {\n\t\tdev_err(info->dev, \"failed to read MUIC register\\n\");\n\t\tmutex_unlock(&info->mutex);\n\t\treturn;\n\t}\n\n\tswitch (irq_type) {\n\tcase MAX77693_MUIC_IRQ_INT1_ADC:\n\tcase MAX77693_MUIC_IRQ_INT1_ADC_LOW:\n\tcase MAX77693_MUIC_IRQ_INT1_ADC_ERR:\n\tcase MAX77693_MUIC_IRQ_INT1_ADC1K:\n\t\t \n\t\tret = max77693_muic_adc_handler(info);\n\t\tbreak;\n\tcase MAX77693_MUIC_IRQ_INT2_CHGTYP:\n\tcase MAX77693_MUIC_IRQ_INT2_CHGDETREUN:\n\tcase MAX77693_MUIC_IRQ_INT2_DCDTMR:\n\tcase MAX77693_MUIC_IRQ_INT2_DXOVP:\n\tcase MAX77693_MUIC_IRQ_INT2_VBVOLT:\n\tcase MAX77693_MUIC_IRQ_INT2_VIDRM:\n\t\t \n\t\tret = max77693_muic_chg_handler(info);\n\t\tbreak;\n\tcase MAX77693_MUIC_IRQ_INT3_EOC:\n\tcase MAX77693_MUIC_IRQ_INT3_CGMBC:\n\tcase MAX77693_MUIC_IRQ_INT3_OVP:\n\tcase MAX77693_MUIC_IRQ_INT3_MBCCHG_ERR:\n\tcase MAX77693_MUIC_IRQ_INT3_CHG_ENABLED:\n\tcase MAX77693_MUIC_IRQ_INT3_BAT_DET:\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev, \"muic interrupt: irq %d occurred\\n\",\n\t\t\t\tirq_type);\n\t\tmutex_unlock(&info->mutex);\n\t\treturn;\n\t}\n\n\tif (ret < 0)\n\t\tdev_err(info->dev, \"failed to handle MUIC interrupt\\n\");\n\n\tmutex_unlock(&info->mutex);\n}\n\nstatic irqreturn_t max77693_muic_irq_handler(int irq, void *data)\n{\n\tstruct max77693_muic_info *info = data;\n\n\tinfo->irq = irq;\n\tschedule_work(&info->irq_work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic const struct regmap_config max77693_muic_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n};\n\nstatic int max77693_muic_detect_accessory(struct max77693_muic_info *info)\n{\n\tint ret = 0;\n\tint adc;\n\tint chg_type;\n\tbool attached;\n\n\tmutex_lock(&info->mutex);\n\n\t \n\tret = regmap_bulk_read(info->max77693->regmap_muic,\n\t\t\tMAX77693_MUIC_REG_STATUS1, info->status, 2);\n\tif (ret) {\n\t\tdev_err(info->dev, \"failed to read MUIC register\\n\");\n\t\tmutex_unlock(&info->mutex);\n\t\treturn ret;\n\t}\n\n\tadc = max77693_muic_get_cable_type(info, MAX77693_CABLE_GROUP_ADC,\n\t\t\t\t\t&attached);\n\tif (attached && adc != MAX77693_MUIC_ADC_OPEN) {\n\t\tret = max77693_muic_adc_handler(info);\n\t\tif (ret < 0) {\n\t\t\tdev_err(info->dev, \"Cannot detect accessory\\n\");\n\t\t\tmutex_unlock(&info->mutex);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tchg_type = max77693_muic_get_cable_type(info, MAX77693_CABLE_GROUP_CHG,\n\t\t\t\t\t&attached);\n\tif (attached && chg_type != MAX77693_CHARGER_TYPE_NONE) {\n\t\tret = max77693_muic_chg_handler(info);\n\t\tif (ret < 0) {\n\t\t\tdev_err(info->dev, \"Cannot detect charger accessory\\n\");\n\t\t\tmutex_unlock(&info->mutex);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tmutex_unlock(&info->mutex);\n\n\treturn 0;\n}\n\nstatic void max77693_muic_detect_cable_wq(struct work_struct *work)\n{\n\tstruct max77693_muic_info *info = container_of(to_delayed_work(work),\n\t\t\t\tstruct max77693_muic_info, wq_detcable);\n\n\tmax77693_muic_detect_accessory(info);\n}\n\nstatic int max77693_muic_probe(struct platform_device *pdev)\n{\n\tstruct max77693_dev *max77693 = dev_get_drvdata(pdev->dev.parent);\n\tstruct max77693_platform_data *pdata = dev_get_platdata(max77693->dev);\n\tstruct max77693_muic_info *info;\n\tstruct max77693_reg_data *init_data;\n\tint num_init_data;\n\tint delay_jiffies;\n\tint cable_type;\n\tbool attached;\n\tint ret;\n\tint i;\n\tunsigned int id;\n\n\tinfo = devm_kzalloc(&pdev->dev, sizeof(struct max77693_muic_info),\n\t\t\t\t   GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tinfo->dev = &pdev->dev;\n\tinfo->max77693 = max77693;\n\tif (info->max77693->regmap_muic) {\n\t\tdev_dbg(&pdev->dev, \"allocate register map\\n\");\n\t} else {\n\t\tinfo->max77693->regmap_muic = devm_regmap_init_i2c(\n\t\t\t\t\t\tinfo->max77693->i2c_muic,\n\t\t\t\t\t\t&max77693_muic_regmap_config);\n\t\tif (IS_ERR(info->max77693->regmap_muic)) {\n\t\t\tret = PTR_ERR(info->max77693->regmap_muic);\n\t\t\tdev_err(max77693->dev,\n\t\t\t\t\"failed to allocate register map: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tinfo->dock = devm_input_allocate_device(&pdev->dev);\n\tif (!info->dock) {\n\t\tdev_err(&pdev->dev, \"%s: failed to allocate input\\n\", __func__);\n\t\treturn -ENOMEM;\n\t}\n\tinfo->dock->name = \"max77693-muic/dock\";\n\tinfo->dock->phys = \"max77693-muic/extcon\";\n\tinfo->dock->dev.parent = &pdev->dev;\n\n\t__set_bit(EV_REP, info->dock->evbit);\n\n\tinput_set_capability(info->dock, EV_KEY, KEY_VOLUMEUP);\n\tinput_set_capability(info->dock, EV_KEY, KEY_VOLUMEDOWN);\n\tinput_set_capability(info->dock, EV_KEY, KEY_PLAYPAUSE);\n\tinput_set_capability(info->dock, EV_KEY, KEY_PREVIOUSSONG);\n\tinput_set_capability(info->dock, EV_KEY, KEY_NEXTSONG);\n\n\tret = input_register_device(info->dock);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"Cannot register input device error(%d)\\n\",\n\t\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tplatform_set_drvdata(pdev, info);\n\tmutex_init(&info->mutex);\n\n\tret = devm_work_autocancel(&pdev->dev, &info->irq_work,\n\t\t\t\t   max77693_muic_irq_work);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(muic_irqs); i++) {\n\t\tstruct max77693_muic_irq *muic_irq = &muic_irqs[i];\n\t\tint virq;\n\n\t\tvirq = regmap_irq_get_virq(max77693->irq_data_muic,\n\t\t\t\t\tmuic_irq->irq);\n\t\tif (virq <= 0)\n\t\t\treturn -EINVAL;\n\t\tmuic_irq->virq = virq;\n\n\t\tret = devm_request_threaded_irq(&pdev->dev, virq, NULL,\n\t\t\t\tmax77693_muic_irq_handler,\n\t\t\t\tIRQF_NO_SUSPEND,\n\t\t\t\tmuic_irq->name, info);\n\t\tif (ret) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"failed: irq request (IRQ: %d, error :%d)\\n\",\n\t\t\t\tmuic_irq->irq, ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tinfo->edev = devm_extcon_dev_allocate(&pdev->dev,\n\t\t\t\t\t      max77693_extcon_cable);\n\tif (IS_ERR(info->edev)) {\n\t\tdev_err(&pdev->dev, \"failed to allocate memory for extcon\\n\");\n\t\treturn PTR_ERR(info->edev);\n\t}\n\n\tret = devm_extcon_dev_register(&pdev->dev, info->edev);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to register extcon device\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tif (pdata && pdata->muic_data) {\n\t\tinit_data = pdata->muic_data->init_data;\n\t\tnum_init_data = pdata->muic_data->num_init_data;\n\t} else {\n\t\tinit_data = default_init_data;\n\t\tnum_init_data = ARRAY_SIZE(default_init_data);\n\t}\n\n\tfor (i = 0; i < num_init_data; i++) {\n\t\tregmap_write(info->max77693->regmap_muic,\n\t\t\t\tinit_data[i].addr,\n\t\t\t\tinit_data[i].data);\n\t}\n\n\tif (pdata && pdata->muic_data) {\n\t\tstruct max77693_muic_platform_data *muic_pdata\n\t\t\t\t\t\t   = pdata->muic_data;\n\n\t\t \n\t\tif (muic_pdata->path_uart)\n\t\t\tinfo->path_uart = muic_pdata->path_uart;\n\t\telse\n\t\t\tinfo->path_uart = MAX77693_CONTROL1_SW_UART;\n\n\t\tif (muic_pdata->path_usb)\n\t\t\tinfo->path_usb = muic_pdata->path_usb;\n\t\telse\n\t\t\tinfo->path_usb = MAX77693_CONTROL1_SW_USB;\n\n\t\t \n\t\tif (muic_pdata->detcable_delay_ms)\n\t\t\tdelay_jiffies =\n\t\t\t\tmsecs_to_jiffies(muic_pdata->detcable_delay_ms);\n\t\telse\n\t\t\tdelay_jiffies = msecs_to_jiffies(DELAY_MS_DEFAULT);\n\t} else {\n\t\tinfo->path_usb = MAX77693_CONTROL1_SW_USB;\n\t\tinfo->path_uart = MAX77693_CONTROL1_SW_UART;\n\t\tdelay_jiffies = msecs_to_jiffies(DELAY_MS_DEFAULT);\n\t}\n\n\t \n\tret = regmap_bulk_read(info->max77693->regmap_muic,\n\t\t\tMAX77693_MUIC_REG_STATUS1, info->status, 2);\n\tif (ret) {\n\t\tdev_err(info->dev, \"failed to read MUIC register\\n\");\n\t\treturn ret;\n\t}\n\tcable_type = max77693_muic_get_cable_type(info,\n\t\t\t\t\t   MAX77693_CABLE_GROUP_ADC, &attached);\n\tif (attached && (cable_type == MAX77693_MUIC_ADC_FACTORY_MODE_UART_ON ||\n\t\t\t cable_type == MAX77693_MUIC_ADC_FACTORY_MODE_UART_OFF))\n\t\tmax77693_muic_set_path(info, info->path_uart, true);\n\n\t \n\tret = regmap_read(info->max77693->regmap_muic,\n\t\t\tMAX77693_MUIC_REG_ID, &id);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"failed to read revision number\\n\");\n\t\treturn ret;\n\t}\n\tdev_info(info->dev, \"device ID : 0x%x\\n\", id);\n\n\t \n\tmax77693_muic_set_debounce_time(info, ADC_DEBOUNCE_TIME_25MS);\n\n\t \n\tINIT_DELAYED_WORK(&info->wq_detcable, max77693_muic_detect_cable_wq);\n\tqueue_delayed_work(system_power_efficient_wq, &info->wq_detcable,\n\t\t\tdelay_jiffies);\n\n\treturn ret;\n}\n\nstatic struct platform_driver max77693_muic_driver = {\n\t.driver\t\t= {\n\t\t.name\t= DEV_NAME,\n\t},\n\t.probe\t\t= max77693_muic_probe,\n};\n\nmodule_platform_driver(max77693_muic_driver);\n\nMODULE_DESCRIPTION(\"Maxim MAX77693 Extcon driver\");\nMODULE_AUTHOR(\"Chanwoo Choi <cw00.choi@samsung.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:max77693-muic\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}