{
  "module_name": "extcon-max77843.c",
  "hash_id": "bc4aac36fadfd94664be93193d5a58d5d3ece03b2f217c7d7872ec21f43fea20",
  "original_prompt": "Ingested from linux-6.6.14/drivers/extcon/extcon-max77843.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/extcon-provider.h>\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/mfd/max77693-common.h>\n#include <linux/mfd/max77843-private.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/workqueue.h>\n\n#define DELAY_MS_DEFAULT\t\t15000\t \n\nenum max77843_muic_status {\n\tMAX77843_MUIC_STATUS1 = 0,\n\tMAX77843_MUIC_STATUS2,\n\tMAX77843_MUIC_STATUS3,\n\n\tMAX77843_MUIC_STATUS_NUM,\n};\n\nstruct max77843_muic_info {\n\tstruct device *dev;\n\tstruct max77693_dev *max77843;\n\tstruct extcon_dev *edev;\n\n\tstruct mutex mutex;\n\tstruct work_struct irq_work;\n\tstruct delayed_work wq_detcable;\n\n\tu8 status[MAX77843_MUIC_STATUS_NUM];\n\tint prev_cable_type;\n\tint prev_chg_type;\n\tint prev_gnd_type;\n\n\tbool irq_adc;\n\tbool irq_chg;\n};\n\nenum max77843_muic_cable_group {\n\tMAX77843_CABLE_GROUP_ADC = 0,\n\tMAX77843_CABLE_GROUP_ADC_GND,\n\tMAX77843_CABLE_GROUP_CHG,\n};\n\nenum max77843_muic_adc_debounce_time {\n\tMAX77843_DEBOUNCE_TIME_5MS = 0,\n\tMAX77843_DEBOUNCE_TIME_10MS,\n\tMAX77843_DEBOUNCE_TIME_25MS,\n\tMAX77843_DEBOUNCE_TIME_38_62MS,\n};\n\n \nenum max77843_muic_accessory_type {\n\tMAX77843_MUIC_ADC_GROUND = 0,\n\tMAX77843_MUIC_ADC_SEND_END_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S1_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S2_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S3_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S4_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S5_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S6_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S7_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S8_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S9_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S10_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S11_BUTTON,\n\tMAX77843_MUIC_ADC_REMOTE_S12_BUTTON,\n\tMAX77843_MUIC_ADC_RESERVED_ACC_1,\n\tMAX77843_MUIC_ADC_RESERVED_ACC_2,\n\tMAX77843_MUIC_ADC_RESERVED_ACC_3,  \n\tMAX77843_MUIC_ADC_RESERVED_ACC_4,\n\tMAX77843_MUIC_ADC_RESERVED_ACC_5,\n\tMAX77843_MUIC_ADC_AUDIO_DEVICE_TYPE2,\n\tMAX77843_MUIC_ADC_PHONE_POWERED_DEV,\n\tMAX77843_MUIC_ADC_TTY_CONVERTER,\n\tMAX77843_MUIC_ADC_UART_CABLE,\n\tMAX77843_MUIC_ADC_CEA936A_TYPE1_CHG,\n\tMAX77843_MUIC_ADC_FACTORY_MODE_USB_OFF,\n\tMAX77843_MUIC_ADC_FACTORY_MODE_USB_ON,\n\tMAX77843_MUIC_ADC_AV_CABLE_NOLOAD,\n\tMAX77843_MUIC_ADC_CEA936A_TYPE2_CHG,\n\tMAX77843_MUIC_ADC_FACTORY_MODE_UART_OFF,\n\tMAX77843_MUIC_ADC_FACTORY_MODE_UART_ON,\n\tMAX77843_MUIC_ADC_AUDIO_DEVICE_TYPE1,\n\tMAX77843_MUIC_ADC_OPEN,\n\n\t \n\t\t\t\t\t\t \n\tMAX77843_MUIC_GND_USB_HOST = 0x100,\t \n\tMAX77843_MUIC_GND_USB_HOST_VB = 0x101,\t \n\tMAX77843_MUIC_GND_MHL = 0x102,\t\t \n\tMAX77843_MUIC_GND_MHL_VB = 0x103,\t \n};\n\n \nenum max77843_muic_charger_type {\n\tMAX77843_MUIC_CHG_NONE = 0,\n\tMAX77843_MUIC_CHG_USB,\n\tMAX77843_MUIC_CHG_DOWNSTREAM,\n\tMAX77843_MUIC_CHG_DEDICATED,\n\tMAX77843_MUIC_CHG_SPECIAL_500MA,\n\tMAX77843_MUIC_CHG_SPECIAL_1A,\n\tMAX77843_MUIC_CHG_SPECIAL_BIAS,\n\tMAX77843_MUIC_CHG_RESERVED,\n\tMAX77843_MUIC_CHG_GND,\n\tMAX77843_MUIC_CHG_DOCK,\n};\n\nstatic const unsigned int max77843_extcon_cable[] = {\n\tEXTCON_USB,\n\tEXTCON_USB_HOST,\n\tEXTCON_CHG_USB_SDP,\n\tEXTCON_CHG_USB_DCP,\n\tEXTCON_CHG_USB_CDP,\n\tEXTCON_CHG_USB_FAST,\n\tEXTCON_CHG_USB_SLOW,\n\tEXTCON_DISP_MHL,\n\tEXTCON_DOCK,\n\tEXTCON_JIG,\n\tEXTCON_NONE,\n};\n\nstruct max77843_muic_irq {\n\tunsigned int irq;\n\tconst char *name;\n\tunsigned int virq;\n};\n\nstatic struct max77843_muic_irq max77843_muic_irqs[] = {\n\t{ MAX77843_MUIC_IRQ_INT1_ADC,\t\t\"MUIC-ADC\" },\n\t{ MAX77843_MUIC_IRQ_INT1_ADCERROR,\t\"MUIC-ADC_ERROR\" },\n\t{ MAX77843_MUIC_IRQ_INT1_ADC1K,\t\t\"MUIC-ADC1K\" },\n\t{ MAX77843_MUIC_IRQ_INT2_CHGTYP,\t\"MUIC-CHGTYP\" },\n\t{ MAX77843_MUIC_IRQ_INT2_CHGDETRUN,\t\"MUIC-CHGDETRUN\" },\n\t{ MAX77843_MUIC_IRQ_INT2_DCDTMR,\t\"MUIC-DCDTMR\" },\n\t{ MAX77843_MUIC_IRQ_INT2_DXOVP,\t\t\"MUIC-DXOVP\" },\n\t{ MAX77843_MUIC_IRQ_INT2_VBVOLT,\t\"MUIC-VBVOLT\" },\n\t{ MAX77843_MUIC_IRQ_INT3_VBADC,\t\t\"MUIC-VBADC\" },\n\t{ MAX77843_MUIC_IRQ_INT3_VDNMON,\t\"MUIC-VDNMON\" },\n\t{ MAX77843_MUIC_IRQ_INT3_DNRES,\t\t\"MUIC-DNRES\" },\n\t{ MAX77843_MUIC_IRQ_INT3_MPNACK,\t\"MUIC-MPNACK\"},\n\t{ MAX77843_MUIC_IRQ_INT3_MRXBUFOW,\t\"MUIC-MRXBUFOW\"},\n\t{ MAX77843_MUIC_IRQ_INT3_MRXTRF,\t\"MUIC-MRXTRF\"},\n\t{ MAX77843_MUIC_IRQ_INT3_MRXPERR,\t\"MUIC-MRXPERR\"},\n\t{ MAX77843_MUIC_IRQ_INT3_MRXRDY,\t\"MUIC-MRXRDY\"},\n};\n\nstatic const struct regmap_config max77843_muic_regmap_config = {\n\t.reg_bits       = 8,\n\t.val_bits       = 8,\n\t.max_register   = MAX77843_MUIC_REG_END,\n};\n\nstatic const struct regmap_irq max77843_muic_irq[] = {\n\t \n\t{ .reg_offset = 0, .mask = MAX77843_MUIC_ADC, },\n\t{ .reg_offset = 0, .mask = MAX77843_MUIC_ADCERROR, },\n\t{ .reg_offset = 0, .mask = MAX77843_MUIC_ADC1K, },\n\n\t \n\t{ .reg_offset = 1, .mask = MAX77843_MUIC_CHGTYP, },\n\t{ .reg_offset = 1, .mask = MAX77843_MUIC_CHGDETRUN, },\n\t{ .reg_offset = 1, .mask = MAX77843_MUIC_DCDTMR, },\n\t{ .reg_offset = 1, .mask = MAX77843_MUIC_DXOVP, },\n\t{ .reg_offset = 1, .mask = MAX77843_MUIC_VBVOLT, },\n\n\t \n\t{ .reg_offset = 2, .mask = MAX77843_MUIC_VBADC, },\n\t{ .reg_offset = 2, .mask = MAX77843_MUIC_VDNMON, },\n\t{ .reg_offset = 2, .mask = MAX77843_MUIC_DNRES, },\n\t{ .reg_offset = 2, .mask = MAX77843_MUIC_MPNACK, },\n\t{ .reg_offset = 2, .mask = MAX77843_MUIC_MRXBUFOW, },\n\t{ .reg_offset = 2, .mask = MAX77843_MUIC_MRXTRF, },\n\t{ .reg_offset = 2, .mask = MAX77843_MUIC_MRXPERR, },\n\t{ .reg_offset = 2, .mask = MAX77843_MUIC_MRXRDY, },\n};\n\nstatic const struct regmap_irq_chip max77843_muic_irq_chip = {\n\t.name           = \"max77843-muic\",\n\t.status_base    = MAX77843_MUIC_REG_INT1,\n\t.unmask_base    = MAX77843_MUIC_REG_INTMASK1,\n\t.num_regs       = 3,\n\t.irqs           = max77843_muic_irq,\n\t.num_irqs       = ARRAY_SIZE(max77843_muic_irq),\n};\n\nstatic int max77843_muic_set_path(struct max77843_muic_info *info,\n\t\tu8 val, bool attached, bool nobccomp)\n{\n\tstruct max77693_dev *max77843 = info->max77843;\n\tint ret = 0;\n\tunsigned int ctrl1, ctrl2;\n\n\tif (attached)\n\t\tctrl1 = val;\n\telse\n\t\tctrl1 = MAX77843_MUIC_CONTROL1_SW_OPEN;\n\tif (nobccomp) {\n\t\t \n\t\tctrl1 |= MAX77843_MUIC_CONTROL1_NOBCCOMP_MASK;\n\t}\n\n\tret = regmap_update_bits(max77843->regmap_muic,\n\t\t\tMAX77843_MUIC_REG_CONTROL1,\n\t\t\tMAX77843_MUIC_CONTROL1_COM_SW |\n\t\t\t\tMAX77843_MUIC_CONTROL1_NOBCCOMP_MASK,\n\t\t\tctrl1);\n\tif (ret < 0) {\n\t\tdev_err(info->dev, \"Cannot switch MUIC port\\n\");\n\t\treturn ret;\n\t}\n\n\tif (attached)\n\t\tctrl2 = MAX77843_MUIC_CONTROL2_CPEN_MASK;\n\telse\n\t\tctrl2 = MAX77843_MUIC_CONTROL2_LOWPWR_MASK;\n\n\tret = regmap_update_bits(max77843->regmap_muic,\n\t\t\tMAX77843_MUIC_REG_CONTROL2,\n\t\t\tMAX77843_MUIC_CONTROL2_LOWPWR_MASK |\n\t\t\tMAX77843_MUIC_CONTROL2_CPEN_MASK, ctrl2);\n\tif (ret < 0) {\n\t\tdev_err(info->dev, \"Cannot update lowpower mode\\n\");\n\t\treturn ret;\n\t}\n\n\tdev_dbg(info->dev,\n\t\t\"CONTROL1 : 0x%02x, CONTROL2 : 0x%02x, state : %s\\n\",\n\t\tctrl1, ctrl2, attached ? \"attached\" : \"detached\");\n\n\treturn 0;\n}\n\nstatic void max77843_charger_set_otg_vbus(struct max77843_muic_info *info,\n\t\t bool on)\n{\n\tstruct max77693_dev *max77843 = info->max77843;\n\tunsigned int cnfg00;\n\n\tif (on)\n\t\tcnfg00 = MAX77843_CHG_OTG_MASK | MAX77843_CHG_BOOST_MASK;\n\telse\n\t\tcnfg00 = MAX77843_CHG_ENABLE | MAX77843_CHG_BUCK_MASK;\n\n\tregmap_update_bits(max77843->regmap_chg, MAX77843_CHG_REG_CHG_CNFG_00,\n\t\t\t   MAX77843_CHG_MODE_MASK, cnfg00);\n}\n\nstatic int max77843_muic_get_cable_type(struct max77843_muic_info *info,\n\t\tenum max77843_muic_cable_group group, bool *attached)\n{\n\tint adc, chg_type, cable_type, gnd_type;\n\n\tadc = info->status[MAX77843_MUIC_STATUS1] &\n\t\t\tMAX77843_MUIC_STATUS1_ADC_MASK;\n\tadc >>= MAX77843_MUIC_STATUS1_ADC_SHIFT;\n\n\tswitch (group) {\n\tcase MAX77843_CABLE_GROUP_ADC:\n\t\tif (adc == MAX77843_MUIC_ADC_OPEN) {\n\t\t\t*attached = false;\n\t\t\tcable_type = info->prev_cable_type;\n\t\t\tinfo->prev_cable_type = MAX77843_MUIC_ADC_OPEN;\n\t\t} else {\n\t\t\t*attached = true;\n\t\t\tcable_type = info->prev_cable_type = adc;\n\t\t}\n\t\tbreak;\n\tcase MAX77843_CABLE_GROUP_CHG:\n\t\tchg_type = info->status[MAX77843_MUIC_STATUS2] &\n\t\t\t\tMAX77843_MUIC_STATUS2_CHGTYP_MASK;\n\n\t\t \n\t\tif (adc == MAX77843_MUIC_ADC_GROUND) {\n\t\t\tif (chg_type == MAX77843_MUIC_CHG_NONE) {\n\t\t\t\t \n\t\t\t\t*attached = false;\n\t\t\t\tcable_type = info->prev_chg_type;\n\t\t\t\tinfo->prev_chg_type = MAX77843_MUIC_CHG_NONE;\n\t\t\t} else {\n\n\t\t\t\t \n\t\t\t\t*attached = true;\n\t\t\t\tcable_type = MAX77843_MUIC_CHG_GND;\n\t\t\t\tinfo->prev_chg_type = MAX77843_MUIC_CHG_GND;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tif (adc == MAX77843_MUIC_ADC_RESERVED_ACC_3) {  \n\t\t\tif (chg_type == MAX77843_MUIC_CHG_NONE) {\n\t\t\t\t*attached = false;\n\t\t\t\tcable_type = info->prev_chg_type;\n\t\t\t\tinfo->prev_chg_type = MAX77843_MUIC_CHG_NONE;\n\t\t\t} else {\n\t\t\t\t*attached = true;\n\t\t\t\tcable_type = MAX77843_MUIC_CHG_DOCK;\n\t\t\t\tinfo->prev_chg_type = MAX77843_MUIC_CHG_DOCK;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tif (chg_type == MAX77843_MUIC_CHG_NONE) {\n\t\t\t*attached = false;\n\t\t\tcable_type = info->prev_chg_type;\n\t\t\tinfo->prev_chg_type = MAX77843_MUIC_CHG_NONE;\n\t\t} else {\n\t\t\t*attached = true;\n\t\t\tcable_type = info->prev_chg_type = chg_type;\n\t\t}\n\t\tbreak;\n\tcase MAX77843_CABLE_GROUP_ADC_GND:\n\t\tif (adc == MAX77843_MUIC_ADC_OPEN) {\n\t\t\t*attached = false;\n\t\t\tcable_type = info->prev_gnd_type;\n\t\t\tinfo->prev_gnd_type = MAX77843_MUIC_ADC_OPEN;\n\t\t} else {\n\t\t\t*attached = true;\n\n\t\t\t \n\t\t\t \n\t\t\tgnd_type = (info->status[MAX77843_MUIC_STATUS1] &\n\t\t\t\t\tMAX77843_MUIC_STATUS1_ADC1K_MASK);\n\n\t\t\t \n\t\t\tgnd_type |= (info->status[MAX77843_MUIC_STATUS2] &\n\t\t\t\t\tMAX77843_MUIC_STATUS2_VBVOLT_MASK);\n\t\t\tgnd_type >>= MAX77843_MUIC_STATUS2_VBVOLT_SHIFT;\n\n\t\t\t \n\t\t\tgnd_type |= MAX77843_MUIC_GND_USB_HOST;\n\t\t\tcable_type = info->prev_gnd_type = gnd_type;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev, \"Unknown cable group (%d)\\n\", group);\n\t\tcable_type = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn cable_type;\n}\n\nstatic int max77843_muic_adc_gnd_handler(struct max77843_muic_info *info)\n{\n\tint ret, gnd_cable_type;\n\tbool attached;\n\n\tgnd_cable_type = max77843_muic_get_cable_type(info,\n\t\t\tMAX77843_CABLE_GROUP_ADC_GND, &attached);\n\tdev_dbg(info->dev, \"external connector is %s (gnd:0x%02x)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\", gnd_cable_type);\n\n\tswitch (gnd_cable_type) {\n\tcase MAX77843_MUIC_GND_USB_HOST:\n\tcase MAX77843_MUIC_GND_USB_HOST_VB:\n\t\tret = max77843_muic_set_path(info,\n\t\t\t\t\t     MAX77843_MUIC_CONTROL1_SW_USB,\n\t\t\t\t\t     attached, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\textcon_set_state_sync(info->edev, EXTCON_USB_HOST, attached);\n\t\tmax77843_charger_set_otg_vbus(info, attached);\n\t\tbreak;\n\tcase MAX77843_MUIC_GND_MHL_VB:\n\tcase MAX77843_MUIC_GND_MHL:\n\t\tret = max77843_muic_set_path(info,\n\t\t\t\t\t     MAX77843_MUIC_CONTROL1_SW_OPEN,\n\t\t\t\t\t     attached, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\textcon_set_state_sync(info->edev, EXTCON_DISP_MHL, attached);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev, \"failed to detect %s accessory(gnd:0x%x)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\", gnd_cable_type);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77843_muic_jig_handler(struct max77843_muic_info *info,\n\t\tint cable_type, bool attached)\n{\n\tint ret;\n\tu8 path = MAX77843_MUIC_CONTROL1_SW_OPEN;\n\n\tdev_dbg(info->dev, \"external connector is %s (adc:0x%02x)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\", cable_type);\n\n\tswitch (cable_type) {\n\tcase MAX77843_MUIC_ADC_FACTORY_MODE_USB_OFF:\n\tcase MAX77843_MUIC_ADC_FACTORY_MODE_USB_ON:\n\t\tpath = MAX77843_MUIC_CONTROL1_SW_USB;\n\t\tbreak;\n\tcase MAX77843_MUIC_ADC_FACTORY_MODE_UART_OFF:\n\t\tpath = MAX77843_MUIC_CONTROL1_SW_UART;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = max77843_muic_set_path(info, path, attached, false);\n\tif (ret < 0)\n\t\treturn ret;\n\n\textcon_set_state_sync(info->edev, EXTCON_JIG, attached);\n\n\treturn 0;\n}\n\nstatic int max77843_muic_dock_handler(struct max77843_muic_info *info,\n\t\tbool attached)\n{\n\tint ret;\n\n\tdev_dbg(info->dev, \"external connector is %s (adc: 0x10)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\");\n\n\tret = max77843_muic_set_path(info, MAX77843_MUIC_CONTROL1_SW_USB,\n\t\t\t\t     attached, attached);\n\tif (ret < 0)\n\t\treturn ret;\n\n\textcon_set_state_sync(info->edev, EXTCON_DISP_MHL, attached);\n\textcon_set_state_sync(info->edev, EXTCON_USB_HOST, attached);\n\textcon_set_state_sync(info->edev, EXTCON_DOCK, attached);\n\n\treturn 0;\n}\n\nstatic int max77843_muic_adc_handler(struct max77843_muic_info *info)\n{\n\tint ret, cable_type;\n\tbool attached;\n\n\tcable_type = max77843_muic_get_cable_type(info,\n\t\t\tMAX77843_CABLE_GROUP_ADC, &attached);\n\n\tdev_dbg(info->dev,\n\t\t\"external connector is %s (adc:0x%02x, prev_adc:0x%x)\\n\",\n\t\tattached ? \"attached\" : \"detached\", cable_type,\n\t\tinfo->prev_cable_type);\n\n\tswitch (cable_type) {\n\tcase MAX77843_MUIC_ADC_RESERVED_ACC_3:  \n\t\tret = max77843_muic_dock_handler(info, attached);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase MAX77843_MUIC_ADC_GROUND:\n\t\tret = max77843_muic_adc_gnd_handler(info);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase MAX77843_MUIC_ADC_FACTORY_MODE_USB_OFF:\n\tcase MAX77843_MUIC_ADC_FACTORY_MODE_USB_ON:\n\tcase MAX77843_MUIC_ADC_FACTORY_MODE_UART_OFF:\n\t\tret = max77843_muic_jig_handler(info, cable_type, attached);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbreak;\n\tcase MAX77843_MUIC_ADC_SEND_END_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S1_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S2_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S3_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S4_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S5_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S6_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S7_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S8_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S9_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S10_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S11_BUTTON:\n\tcase MAX77843_MUIC_ADC_REMOTE_S12_BUTTON:\n\tcase MAX77843_MUIC_ADC_RESERVED_ACC_1:\n\tcase MAX77843_MUIC_ADC_RESERVED_ACC_2:\n\tcase MAX77843_MUIC_ADC_RESERVED_ACC_4:\n\tcase MAX77843_MUIC_ADC_RESERVED_ACC_5:\n\tcase MAX77843_MUIC_ADC_AUDIO_DEVICE_TYPE2:\n\tcase MAX77843_MUIC_ADC_PHONE_POWERED_DEV:\n\tcase MAX77843_MUIC_ADC_TTY_CONVERTER:\n\tcase MAX77843_MUIC_ADC_UART_CABLE:\n\tcase MAX77843_MUIC_ADC_CEA936A_TYPE1_CHG:\n\tcase MAX77843_MUIC_ADC_AV_CABLE_NOLOAD:\n\tcase MAX77843_MUIC_ADC_CEA936A_TYPE2_CHG:\n\tcase MAX77843_MUIC_ADC_FACTORY_MODE_UART_ON:\n\tcase MAX77843_MUIC_ADC_AUDIO_DEVICE_TYPE1:\n\tcase MAX77843_MUIC_ADC_OPEN:\n\t\tdev_err(info->dev,\n\t\t\t\"accessory is %s but it isn't used (adc:0x%x)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\", cable_type);\n\t\treturn -EAGAIN;\n\tdefault:\n\t\tdev_err(info->dev,\n\t\t\t\"failed to detect %s accessory (adc:0x%x)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\", cable_type);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77843_muic_chg_handler(struct max77843_muic_info *info)\n{\n\tint ret, chg_type, gnd_type;\n\tbool attached;\n\n\tchg_type = max77843_muic_get_cable_type(info,\n\t\t\tMAX77843_CABLE_GROUP_CHG, &attached);\n\n\tdev_dbg(info->dev,\n\t\t\"external connector is %s(chg_type:0x%x, prev_chg_type:0x%x)\\n\",\n\t\tattached ? \"attached\" : \"detached\",\n\t\tchg_type, info->prev_chg_type);\n\n\tswitch (chg_type) {\n\tcase MAX77843_MUIC_CHG_USB:\n\t\tret = max77843_muic_set_path(info,\n\t\t\t\t\t     MAX77843_MUIC_CONTROL1_SW_USB,\n\t\t\t\t\t     attached, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\textcon_set_state_sync(info->edev, EXTCON_USB, attached);\n\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_SDP,\n\t\t\t\t\tattached);\n\t\tbreak;\n\tcase MAX77843_MUIC_CHG_DOWNSTREAM:\n\t\tret = max77843_muic_set_path(info,\n\t\t\t\t\t     MAX77843_MUIC_CONTROL1_SW_OPEN,\n\t\t\t\t\t     attached, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_CDP,\n\t\t\t\t\tattached);\n\t\tbreak;\n\tcase MAX77843_MUIC_CHG_DEDICATED:\n\t\tret = max77843_muic_set_path(info,\n\t\t\t\t\t     MAX77843_MUIC_CONTROL1_SW_OPEN,\n\t\t\t\t\t     attached, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_DCP,\n\t\t\t\t\tattached);\n\t\tbreak;\n\tcase MAX77843_MUIC_CHG_SPECIAL_500MA:\n\t\tret = max77843_muic_set_path(info,\n\t\t\t\t\t     MAX77843_MUIC_CONTROL1_SW_OPEN,\n\t\t\t\t\t     attached, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_SLOW,\n\t\t\t\t\tattached);\n\t\tbreak;\n\tcase MAX77843_MUIC_CHG_SPECIAL_1A:\n\t\tret = max77843_muic_set_path(info,\n\t\t\t\t\t     MAX77843_MUIC_CONTROL1_SW_OPEN,\n\t\t\t\t\t     attached, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_FAST,\n\t\t\t\t\tattached);\n\t\tbreak;\n\tcase MAX77843_MUIC_CHG_GND:\n\t\tgnd_type = max77843_muic_get_cable_type(info,\n\t\t\t\tMAX77843_CABLE_GROUP_ADC_GND, &attached);\n\n\t\t \n\t\tif (gnd_type == MAX77843_MUIC_GND_MHL_VB)\n\t\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_DCP,\n\t\t\t\t\t\ttrue);\n\t\telse if (gnd_type == MAX77843_MUIC_GND_MHL)\n\t\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_DCP,\n\t\t\t\t\t\tfalse);\n\t\tbreak;\n\tcase MAX77843_MUIC_CHG_DOCK:\n\t\textcon_set_state_sync(info->edev, EXTCON_CHG_USB_DCP, attached);\n\t\tbreak;\n\tcase MAX77843_MUIC_CHG_NONE:\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev,\n\t\t\t\"failed to detect %s accessory (chg_type:0x%x)\\n\",\n\t\t\tattached ? \"attached\" : \"detached\", chg_type);\n\n\t\tmax77843_muic_set_path(info, MAX77843_MUIC_CONTROL1_SW_OPEN,\n\t\t\t\t       attached, false);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void max77843_muic_irq_work(struct work_struct *work)\n{\n\tstruct max77843_muic_info *info = container_of(work,\n\t\t\tstruct max77843_muic_info, irq_work);\n\tstruct max77693_dev *max77843 = info->max77843;\n\tint ret = 0;\n\n\tmutex_lock(&info->mutex);\n\n\tret = regmap_bulk_read(max77843->regmap_muic,\n\t\t\tMAX77843_MUIC_REG_STATUS1, info->status,\n\t\t\tMAX77843_MUIC_STATUS_NUM);\n\tif (ret) {\n\t\tdev_err(info->dev, \"Cannot read STATUS registers\\n\");\n\t\tmutex_unlock(&info->mutex);\n\t\treturn;\n\t}\n\n\tif (info->irq_adc) {\n\t\tret = max77843_muic_adc_handler(info);\n\t\tif (ret)\n\t\t\tdev_err(info->dev, \"Unknown cable type\\n\");\n\t\tinfo->irq_adc = false;\n\t}\n\n\tif (info->irq_chg) {\n\t\tret = max77843_muic_chg_handler(info);\n\t\tif (ret)\n\t\t\tdev_err(info->dev, \"Unknown charger type\\n\");\n\t\tinfo->irq_chg = false;\n\t}\n\n\tmutex_unlock(&info->mutex);\n}\n\nstatic irqreturn_t max77843_muic_irq_handler(int irq, void *data)\n{\n\tstruct max77843_muic_info *info = data;\n\tint i, irq_type = -1;\n\n\tfor (i = 0; i < ARRAY_SIZE(max77843_muic_irqs); i++)\n\t\tif (irq == max77843_muic_irqs[i].virq)\n\t\t\tirq_type = max77843_muic_irqs[i].irq;\n\n\tswitch (irq_type) {\n\tcase MAX77843_MUIC_IRQ_INT1_ADC:\n\tcase MAX77843_MUIC_IRQ_INT1_ADCERROR:\n\tcase MAX77843_MUIC_IRQ_INT1_ADC1K:\n\t\tinfo->irq_adc = true;\n\t\tbreak;\n\tcase MAX77843_MUIC_IRQ_INT2_CHGTYP:\n\tcase MAX77843_MUIC_IRQ_INT2_CHGDETRUN:\n\tcase MAX77843_MUIC_IRQ_INT2_DCDTMR:\n\tcase MAX77843_MUIC_IRQ_INT2_DXOVP:\n\tcase MAX77843_MUIC_IRQ_INT2_VBVOLT:\n\t\tinfo->irq_chg = true;\n\t\tbreak;\n\tcase MAX77843_MUIC_IRQ_INT3_VBADC:\n\tcase MAX77843_MUIC_IRQ_INT3_VDNMON:\n\tcase MAX77843_MUIC_IRQ_INT3_DNRES:\n\tcase MAX77843_MUIC_IRQ_INT3_MPNACK:\n\tcase MAX77843_MUIC_IRQ_INT3_MRXBUFOW:\n\tcase MAX77843_MUIC_IRQ_INT3_MRXTRF:\n\tcase MAX77843_MUIC_IRQ_INT3_MRXPERR:\n\tcase MAX77843_MUIC_IRQ_INT3_MRXRDY:\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev, \"Cannot recognize IRQ(%d)\\n\", irq_type);\n\t\tbreak;\n\t}\n\n\tschedule_work(&info->irq_work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void max77843_muic_detect_cable_wq(struct work_struct *work)\n{\n\tstruct max77843_muic_info *info = container_of(to_delayed_work(work),\n\t\t\tstruct max77843_muic_info, wq_detcable);\n\tstruct max77693_dev *max77843 = info->max77843;\n\tint chg_type, adc, ret;\n\tbool attached;\n\n\tmutex_lock(&info->mutex);\n\n\tret = regmap_bulk_read(max77843->regmap_muic,\n\t\t\tMAX77843_MUIC_REG_STATUS1, info->status,\n\t\t\tMAX77843_MUIC_STATUS_NUM);\n\tif (ret) {\n\t\tdev_err(info->dev, \"Cannot read STATUS registers\\n\");\n\t\tgoto err_cable_wq;\n\t}\n\n\tadc = max77843_muic_get_cable_type(info,\n\t\t\tMAX77843_CABLE_GROUP_ADC, &attached);\n\tif (attached && adc != MAX77843_MUIC_ADC_OPEN) {\n\t\tret = max77843_muic_adc_handler(info);\n\t\tif (ret < 0) {\n\t\t\tdev_err(info->dev, \"Cannot detect accessory\\n\");\n\t\t\tgoto err_cable_wq;\n\t\t}\n\t}\n\n\tchg_type = max77843_muic_get_cable_type(info,\n\t\t\tMAX77843_CABLE_GROUP_CHG, &attached);\n\tif (attached && chg_type != MAX77843_MUIC_CHG_NONE) {\n\t\tret = max77843_muic_chg_handler(info);\n\t\tif (ret < 0) {\n\t\t\tdev_err(info->dev, \"Cannot detect charger accessory\\n\");\n\t\t\tgoto err_cable_wq;\n\t\t}\n\t}\n\nerr_cable_wq:\n\tmutex_unlock(&info->mutex);\n}\n\nstatic int max77843_muic_set_debounce_time(struct max77843_muic_info *info,\n\t\tenum max77843_muic_adc_debounce_time time)\n{\n\tstruct max77693_dev *max77843 = info->max77843;\n\tint ret;\n\n\tswitch (time) {\n\tcase MAX77843_DEBOUNCE_TIME_5MS:\n\tcase MAX77843_DEBOUNCE_TIME_10MS:\n\tcase MAX77843_DEBOUNCE_TIME_25MS:\n\tcase MAX77843_DEBOUNCE_TIME_38_62MS:\n\t\tret = regmap_update_bits(max77843->regmap_muic,\n\t\t\t\tMAX77843_MUIC_REG_CONTROL4,\n\t\t\t\tMAX77843_MUIC_CONTROL4_ADCDBSET_MASK,\n\t\t\t\ttime << MAX77843_MUIC_CONTROL4_ADCDBSET_SHIFT);\n\t\tif (ret < 0) {\n\t\t\tdev_err(info->dev, \"Cannot write MUIC regmap\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tdev_err(info->dev, \"Invalid ADC debounce time\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77843_init_muic_regmap(struct max77693_dev *max77843)\n{\n\tint ret;\n\n\tmax77843->i2c_muic = i2c_new_dummy_device(max77843->i2c->adapter,\n\t\t\tI2C_ADDR_MUIC);\n\tif (IS_ERR(max77843->i2c_muic)) {\n\t\tdev_err(&max77843->i2c->dev,\n\t\t\t\t\"Cannot allocate I2C device for MUIC\\n\");\n\t\treturn PTR_ERR(max77843->i2c_muic);\n\t}\n\n\ti2c_set_clientdata(max77843->i2c_muic, max77843);\n\n\tmax77843->regmap_muic = devm_regmap_init_i2c(max77843->i2c_muic,\n\t\t\t&max77843_muic_regmap_config);\n\tif (IS_ERR(max77843->regmap_muic)) {\n\t\tret = PTR_ERR(max77843->regmap_muic);\n\t\tgoto err_muic_i2c;\n\t}\n\n\tret = regmap_add_irq_chip(max77843->regmap_muic, max77843->irq,\n\t\t\tIRQF_TRIGGER_LOW | IRQF_ONESHOT | IRQF_SHARED,\n\t\t\t0, &max77843_muic_irq_chip, &max77843->irq_data_muic);\n\tif (ret < 0) {\n\t\tdev_err(&max77843->i2c->dev, \"Cannot add MUIC IRQ chip\\n\");\n\t\tgoto err_muic_i2c;\n\t}\n\n\treturn 0;\n\nerr_muic_i2c:\n\ti2c_unregister_device(max77843->i2c_muic);\n\n\treturn ret;\n}\n\nstatic int max77843_muic_probe(struct platform_device *pdev)\n{\n\tstruct max77693_dev *max77843 = dev_get_drvdata(pdev->dev.parent);\n\tstruct max77843_muic_info *info;\n\tunsigned int id;\n\tint cable_type;\n\tbool attached;\n\tint i, ret;\n\n\tinfo = devm_kzalloc(&pdev->dev, sizeof(*info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tinfo->dev = &pdev->dev;\n\tinfo->max77843 = max77843;\n\n\tplatform_set_drvdata(pdev, info);\n\tmutex_init(&info->mutex);\n\n\t \n\tret = max77843_init_muic_regmap(max77843);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to init MUIC regmap\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_update_bits(max77843->regmap_muic,\n\t\t\tMAX77843_MUIC_REG_CONTROL4,\n\t\t\tMAX77843_MUIC_CONTROL4_USBAUTO_MASK |\n\t\t\tMAX77843_MUIC_CONTROL4_FCTAUTO_MASK,\n\t\t\tCONTROL4_AUTO_DISABLE);\n\n\t \n\tinfo->edev = devm_extcon_dev_allocate(&pdev->dev,\n\t\t\tmax77843_extcon_cable);\n\tif (IS_ERR(info->edev)) {\n\t\tdev_err(&pdev->dev, \"Failed to allocate memory for extcon\\n\");\n\t\tret = PTR_ERR(info->edev);\n\t\tgoto err_muic_irq;\n\t}\n\n\tret = devm_extcon_dev_register(&pdev->dev, info->edev);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to register extcon device\\n\");\n\t\tgoto err_muic_irq;\n\t}\n\n\t \n\tmax77843_muic_set_debounce_time(info, MAX77843_DEBOUNCE_TIME_25MS);\n\n\t \n\tret = regmap_bulk_read(max77843->regmap_muic,\n\t\t\tMAX77843_MUIC_REG_STATUS1, info->status,\n\t\t\tMAX77843_MUIC_STATUS_NUM);\n\tif (ret) {\n\t\tdev_err(info->dev, \"Cannot read STATUS registers\\n\");\n\t\tgoto err_muic_irq;\n\t}\n\tcable_type = max77843_muic_get_cable_type(info, MAX77843_CABLE_GROUP_ADC,\n\t\t\t\t\t &attached);\n\tif (attached && cable_type == MAX77843_MUIC_ADC_FACTORY_MODE_UART_OFF)\n\t\tmax77843_muic_set_path(info, MAX77843_MUIC_CONTROL1_SW_UART,\n\t\t\t\t       true, false);\n\n\t \n\tret = regmap_read(max77843->regmap_muic, MAX77843_MUIC_REG_ID, &id);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"Failed to read revision number\\n\");\n\t\tgoto err_muic_irq;\n\t}\n\tdev_info(info->dev, \"MUIC device ID : 0x%x\\n\", id);\n\n\t \n\tINIT_WORK(&info->irq_work, max77843_muic_irq_work);\n\n\t \n\tret = regmap_bulk_read(max77843->regmap_muic,\n\t\t\tMAX77843_MUIC_REG_INT1, info->status,\n\t\t\tMAX77843_MUIC_STATUS_NUM);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to Clear IRQ bits\\n\");\n\t\tgoto err_muic_irq;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(max77843_muic_irqs); i++) {\n\t\tstruct max77843_muic_irq *muic_irq = &max77843_muic_irqs[i];\n\t\tint virq = 0;\n\n\t\tvirq = regmap_irq_get_virq(max77843->irq_data_muic,\n\t\t\t\tmuic_irq->irq);\n\t\tif (virq <= 0) {\n\t\t\tret = -EINVAL;\n\t\t\tgoto err_muic_irq;\n\t\t}\n\t\tmuic_irq->virq = virq;\n\n\t\tret = devm_request_threaded_irq(&pdev->dev, virq, NULL,\n\t\t\t\tmax77843_muic_irq_handler, IRQF_NO_SUSPEND,\n\t\t\t\tmuic_irq->name, info);\n\t\tif (ret) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"Failed to request irq (IRQ: %d, error: %d)\\n\",\n\t\t\t\tmuic_irq->irq, ret);\n\t\t\tgoto err_muic_irq;\n\t\t}\n\t}\n\n\t \n\tINIT_DELAYED_WORK(&info->wq_detcable, max77843_muic_detect_cable_wq);\n\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t&info->wq_detcable, msecs_to_jiffies(DELAY_MS_DEFAULT));\n\n\treturn 0;\n\nerr_muic_irq:\n\tregmap_del_irq_chip(max77843->irq, max77843->irq_data_muic);\n\ti2c_unregister_device(max77843->i2c_muic);\n\n\treturn ret;\n}\n\nstatic int max77843_muic_remove(struct platform_device *pdev)\n{\n\tstruct max77843_muic_info *info = platform_get_drvdata(pdev);\n\tstruct max77693_dev *max77843 = info->max77843;\n\n\tcancel_work_sync(&info->irq_work);\n\tregmap_del_irq_chip(max77843->irq, max77843->irq_data_muic);\n\ti2c_unregister_device(max77843->i2c_muic);\n\n\treturn 0;\n}\n\nstatic const struct platform_device_id max77843_muic_id[] = {\n\t{ \"max77843-muic\", },\n\t{   },\n};\nMODULE_DEVICE_TABLE(platform, max77843_muic_id);\n\nstatic struct platform_driver max77843_muic_driver = {\n\t.driver\t\t= {\n\t\t.name\t\t= \"max77843-muic\",\n\t},\n\t.probe\t\t= max77843_muic_probe,\n\t.remove\t\t= max77843_muic_remove,\n\t.id_table\t= max77843_muic_id,\n};\n\nstatic int __init max77843_muic_init(void)\n{\n\treturn platform_driver_register(&max77843_muic_driver);\n}\nsubsys_initcall(max77843_muic_init);\n\nMODULE_DESCRIPTION(\"Maxim MAX77843 Extcon driver\");\nMODULE_AUTHOR(\"Jaewon Kim <jaewon02.kim@samsung.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}