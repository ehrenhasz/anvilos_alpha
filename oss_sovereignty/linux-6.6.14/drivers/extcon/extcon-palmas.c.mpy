{
  "module_name": "extcon-palmas.c",
  "hash_id": "2b87f11937becd28e3611b6b5a3121352ee008cff045575bd5a0985a0b62da72",
  "original_prompt": "Ingested from linux-6.6.14/drivers/extcon/extcon-palmas.c",
  "human_readable_source": "\n \n\n#include <linux/devm-helpers.h>\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/err.h>\n#include <linux/mfd/palmas.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/gpio/consumer.h>\n#include <linux/workqueue.h>\n\n#define USB_GPIO_DEBOUNCE_MS\t20\t \n\nstatic const unsigned int palmas_extcon_cable[] = {\n\tEXTCON_USB,\n\tEXTCON_USB_HOST,\n\tEXTCON_NONE,\n};\n\nstatic void palmas_usb_wakeup(struct palmas *palmas, int enable)\n{\n\tif (enable)\n\t\tpalmas_write(palmas, PALMAS_USB_OTG_BASE, PALMAS_USB_WAKEUP,\n\t\t\tPALMAS_USB_WAKEUP_ID_WK_UP_COMP);\n\telse\n\t\tpalmas_write(palmas, PALMAS_USB_OTG_BASE, PALMAS_USB_WAKEUP, 0);\n}\n\nstatic irqreturn_t palmas_vbus_irq_handler(int irq, void *_palmas_usb)\n{\n\tstruct palmas_usb *palmas_usb = _palmas_usb;\n\tstruct extcon_dev *edev = palmas_usb->edev;\n\tunsigned int vbus_line_state;\n\n\tpalmas_read(palmas_usb->palmas, PALMAS_INTERRUPT_BASE,\n\t\tPALMAS_INT3_LINE_STATE, &vbus_line_state);\n\n\tif (vbus_line_state & PALMAS_INT3_LINE_STATE_VBUS) {\n\t\tif (palmas_usb->linkstat != PALMAS_USB_STATE_VBUS) {\n\t\t\tpalmas_usb->linkstat = PALMAS_USB_STATE_VBUS;\n\t\t\textcon_set_state_sync(edev, EXTCON_USB, true);\n\t\t\tdev_dbg(palmas_usb->dev, \"USB cable is attached\\n\");\n\t\t} else {\n\t\t\tdev_dbg(palmas_usb->dev,\n\t\t\t\t\"Spurious connect event detected\\n\");\n\t\t}\n\t} else if (!(vbus_line_state & PALMAS_INT3_LINE_STATE_VBUS)) {\n\t\tif (palmas_usb->linkstat == PALMAS_USB_STATE_VBUS) {\n\t\t\tpalmas_usb->linkstat = PALMAS_USB_STATE_DISCONNECT;\n\t\t\textcon_set_state_sync(edev, EXTCON_USB, false);\n\t\t\tdev_dbg(palmas_usb->dev, \"USB cable is detached\\n\");\n\t\t} else {\n\t\t\tdev_dbg(palmas_usb->dev,\n\t\t\t\t\"Spurious disconnect event detected\\n\");\n\t\t}\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t palmas_id_irq_handler(int irq, void *_palmas_usb)\n{\n\tunsigned int set, id_src;\n\tstruct palmas_usb *palmas_usb = _palmas_usb;\n\tstruct extcon_dev *edev = palmas_usb->edev;\n\n\tpalmas_read(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\n\t\tPALMAS_USB_ID_INT_LATCH_SET, &set);\n\tpalmas_read(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\n\t\tPALMAS_USB_ID_INT_SRC, &id_src);\n\n\tif ((set & PALMAS_USB_ID_INT_SRC_ID_GND) &&\n\t\t\t\t(id_src & PALMAS_USB_ID_INT_SRC_ID_GND)) {\n\t\tpalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\n\t\t\tPALMAS_USB_ID_INT_LATCH_CLR,\n\t\t\tPALMAS_USB_ID_INT_EN_HI_CLR_ID_GND);\n\t\tpalmas_usb->linkstat = PALMAS_USB_STATE_ID;\n\t\textcon_set_state_sync(edev, EXTCON_USB_HOST, true);\n\t\tdev_dbg(palmas_usb->dev, \"USB-HOST cable is attached\\n\");\n\t} else if ((set & PALMAS_USB_ID_INT_SRC_ID_FLOAT) &&\n\t\t\t\t(id_src & PALMAS_USB_ID_INT_SRC_ID_FLOAT)) {\n\t\tpalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\n\t\t\tPALMAS_USB_ID_INT_LATCH_CLR,\n\t\t\tPALMAS_USB_ID_INT_EN_HI_CLR_ID_FLOAT);\n\t\tpalmas_usb->linkstat = PALMAS_USB_STATE_DISCONNECT;\n\t\textcon_set_state_sync(edev, EXTCON_USB_HOST, false);\n\t\tdev_dbg(palmas_usb->dev, \"USB-HOST cable is detached\\n\");\n\t} else if ((palmas_usb->linkstat == PALMAS_USB_STATE_ID) &&\n\t\t\t\t(!(set & PALMAS_USB_ID_INT_SRC_ID_GND))) {\n\t\tpalmas_usb->linkstat = PALMAS_USB_STATE_DISCONNECT;\n\t\textcon_set_state_sync(edev, EXTCON_USB_HOST, false);\n\t\tdev_dbg(palmas_usb->dev, \"USB-HOST cable is detached\\n\");\n\t} else if ((palmas_usb->linkstat == PALMAS_USB_STATE_DISCONNECT) &&\n\t\t\t\t(id_src & PALMAS_USB_ID_INT_SRC_ID_GND)) {\n\t\tpalmas_usb->linkstat = PALMAS_USB_STATE_ID;\n\t\textcon_set_state_sync(edev, EXTCON_USB_HOST, true);\n\t\tdev_dbg(palmas_usb->dev, \"USB-HOST cable is attached\\n\");\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void palmas_gpio_id_detect(struct work_struct *work)\n{\n\tint id;\n\tstruct palmas_usb *palmas_usb = container_of(to_delayed_work(work),\n\t\t\t\t\t\t     struct palmas_usb,\n\t\t\t\t\t\t     wq_detectid);\n\tstruct extcon_dev *edev = palmas_usb->edev;\n\n\tif (!palmas_usb->id_gpiod)\n\t\treturn;\n\n\tid = gpiod_get_value_cansleep(palmas_usb->id_gpiod);\n\n\tif (id) {\n\t\textcon_set_state_sync(edev, EXTCON_USB_HOST, false);\n\t\tdev_dbg(palmas_usb->dev, \"USB-HOST cable is detached\\n\");\n\t} else {\n\t\textcon_set_state_sync(edev, EXTCON_USB_HOST, true);\n\t\tdev_dbg(palmas_usb->dev, \"USB-HOST cable is attached\\n\");\n\t}\n}\n\nstatic irqreturn_t palmas_gpio_id_irq_handler(int irq, void *_palmas_usb)\n{\n\tstruct palmas_usb *palmas_usb = _palmas_usb;\n\n\tqueue_delayed_work(system_power_efficient_wq, &palmas_usb->wq_detectid,\n\t\t\t   palmas_usb->sw_debounce_jiffies);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void palmas_enable_irq(struct palmas_usb *palmas_usb)\n{\n\tpalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\n\t\tPALMAS_USB_VBUS_CTRL_SET,\n\t\tPALMAS_USB_VBUS_CTRL_SET_VBUS_ACT_COMP);\n\n\tif (palmas_usb->enable_id_detection) {\n\t\tpalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\n\t\t\t     PALMAS_USB_ID_CTRL_SET,\n\t\t\t     PALMAS_USB_ID_CTRL_SET_ID_ACT_COMP);\n\n\t\tpalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\n\t\t\t     PALMAS_USB_ID_INT_EN_HI_SET,\n\t\t\t     PALMAS_USB_ID_INT_EN_HI_SET_ID_GND |\n\t\t\t     PALMAS_USB_ID_INT_EN_HI_SET_ID_FLOAT);\n\t}\n\n\tif (palmas_usb->enable_vbus_detection)\n\t\tpalmas_vbus_irq_handler(palmas_usb->vbus_irq, palmas_usb);\n\n\t \n\tif (palmas_usb->enable_id_detection) {\n\t\tmsleep(30);\n\t\tpalmas_id_irq_handler(palmas_usb->id_irq, palmas_usb);\n\t}\n}\n\nstatic int palmas_usb_probe(struct platform_device *pdev)\n{\n\tstruct palmas *palmas = dev_get_drvdata(pdev->dev.parent);\n\tstruct palmas_usb_platform_data\t*pdata = dev_get_platdata(&pdev->dev);\n\tstruct device_node *node = pdev->dev.of_node;\n\tstruct palmas_usb *palmas_usb;\n\tint status;\n\n\tif (!palmas) {\n\t\tdev_err(&pdev->dev, \"failed to get valid parent\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tpalmas_usb = devm_kzalloc(&pdev->dev, sizeof(*palmas_usb), GFP_KERNEL);\n\tif (!palmas_usb)\n\t\treturn -ENOMEM;\n\n\tif (node && !pdata) {\n\t\tpalmas_usb->wakeup = of_property_read_bool(node, \"ti,wakeup\");\n\t\tpalmas_usb->enable_id_detection = of_property_read_bool(node,\n\t\t\t\t\t\t\"ti,enable-id-detection\");\n\t\tpalmas_usb->enable_vbus_detection = of_property_read_bool(node,\n\t\t\t\t\t\t\"ti,enable-vbus-detection\");\n\t} else {\n\t\tpalmas_usb->wakeup = true;\n\t\tpalmas_usb->enable_id_detection = true;\n\t\tpalmas_usb->enable_vbus_detection = true;\n\n\t\tif (pdata)\n\t\t\tpalmas_usb->wakeup = pdata->wakeup;\n\t}\n\n\tpalmas_usb->id_gpiod = devm_gpiod_get_optional(&pdev->dev, \"id\",\n\t\t\t\t\t\t\tGPIOD_IN);\n\tif (IS_ERR(palmas_usb->id_gpiod))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(palmas_usb->id_gpiod),\n\t\t\t\t     \"failed to get id gpio\\n\");\n\n\tpalmas_usb->vbus_gpiod = devm_gpiod_get_optional(&pdev->dev, \"vbus\",\n\t\t\t\t\t\t\tGPIOD_IN);\n\tif (IS_ERR(palmas_usb->vbus_gpiod))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(palmas_usb->vbus_gpiod),\n\t\t\t\t     \"failed to get id gpio\\n\");\n\n\tif (palmas_usb->enable_id_detection && palmas_usb->id_gpiod) {\n\t\tpalmas_usb->enable_id_detection = false;\n\t\tpalmas_usb->enable_gpio_id_detection = true;\n\t}\n\n\tif (palmas_usb->enable_vbus_detection && palmas_usb->vbus_gpiod) {\n\t\tpalmas_usb->enable_vbus_detection = false;\n\t\tpalmas_usb->enable_gpio_vbus_detection = true;\n\t}\n\n\tif (palmas_usb->enable_gpio_id_detection) {\n\t\tu32 debounce;\n\n\t\tif (of_property_read_u32(node, \"debounce-delay-ms\", &debounce))\n\t\t\tdebounce = USB_GPIO_DEBOUNCE_MS;\n\n\t\tstatus = gpiod_set_debounce(palmas_usb->id_gpiod,\n\t\t\t\t\t    debounce * 1000);\n\t\tif (status < 0)\n\t\t\tpalmas_usb->sw_debounce_jiffies = msecs_to_jiffies(debounce);\n\t}\n\n\tstatus = devm_delayed_work_autocancel(&pdev->dev,\n\t\t\t\t\t      &palmas_usb->wq_detectid,\n\t\t\t\t\t      palmas_gpio_id_detect);\n\tif (status)\n\t\treturn status;\n\n\tpalmas->usb = palmas_usb;\n\tpalmas_usb->palmas = palmas;\n\n\tpalmas_usb->dev\t = &pdev->dev;\n\n\tpalmas_usb_wakeup(palmas, palmas_usb->wakeup);\n\n\tplatform_set_drvdata(pdev, palmas_usb);\n\n\tpalmas_usb->edev = devm_extcon_dev_allocate(&pdev->dev,\n\t\t\t\t\t\t    palmas_extcon_cable);\n\tif (IS_ERR(palmas_usb->edev)) {\n\t\tdev_err(&pdev->dev, \"failed to allocate extcon device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tstatus = devm_extcon_dev_register(&pdev->dev, palmas_usb->edev);\n\tif (status) {\n\t\tdev_err(&pdev->dev, \"failed to register extcon device\\n\");\n\t\treturn status;\n\t}\n\n\tif (palmas_usb->enable_id_detection) {\n\t\tpalmas_usb->id_otg_irq = regmap_irq_get_virq(palmas->irq_data,\n\t\t\t\t\t\t\t     PALMAS_ID_OTG_IRQ);\n\t\tpalmas_usb->id_irq = regmap_irq_get_virq(palmas->irq_data,\n\t\t\t\t\t\t\t PALMAS_ID_IRQ);\n\t\tstatus = devm_request_threaded_irq(palmas_usb->dev,\n\t\t\t\tpalmas_usb->id_irq,\n\t\t\t\tNULL, palmas_id_irq_handler,\n\t\t\t\tIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\n\t\t\t\tIRQF_ONESHOT,\n\t\t\t\t\"palmas_usb_id\", palmas_usb);\n\t\tif (status < 0) {\n\t\t\tdev_err(&pdev->dev, \"can't get IRQ %d, err %d\\n\",\n\t\t\t\t\tpalmas_usb->id_irq, status);\n\t\t\treturn status;\n\t\t}\n\t} else if (palmas_usb->enable_gpio_id_detection) {\n\t\tpalmas_usb->gpio_id_irq = gpiod_to_irq(palmas_usb->id_gpiod);\n\t\tif (palmas_usb->gpio_id_irq < 0) {\n\t\t\tdev_err(&pdev->dev, \"failed to get id irq\\n\");\n\t\t\treturn palmas_usb->gpio_id_irq;\n\t\t}\n\t\tstatus = devm_request_threaded_irq(&pdev->dev,\n\t\t\t\t\t\t   palmas_usb->gpio_id_irq,\n\t\t\t\t\t\t   NULL,\n\t\t\t\t\t\t   palmas_gpio_id_irq_handler,\n\t\t\t\t\t\t   IRQF_TRIGGER_RISING |\n\t\t\t\t\t\t   IRQF_TRIGGER_FALLING |\n\t\t\t\t\t\t   IRQF_ONESHOT,\n\t\t\t\t\t\t   \"palmas_usb_id\",\n\t\t\t\t\t\t   palmas_usb);\n\t\tif (status < 0) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"failed to request handler for id irq\\n\");\n\t\t\treturn status;\n\t\t}\n\t}\n\n\tif (palmas_usb->enable_vbus_detection) {\n\t\tpalmas_usb->vbus_otg_irq = regmap_irq_get_virq(palmas->irq_data,\n\t\t\t\t\t\t       PALMAS_VBUS_OTG_IRQ);\n\t\tpalmas_usb->vbus_irq = regmap_irq_get_virq(palmas->irq_data,\n\t\t\t\t\t\t\t   PALMAS_VBUS_IRQ);\n\t\tstatus = devm_request_threaded_irq(palmas_usb->dev,\n\t\t\t\tpalmas_usb->vbus_irq, NULL,\n\t\t\t\tpalmas_vbus_irq_handler,\n\t\t\t\tIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\n\t\t\t\tIRQF_ONESHOT,\n\t\t\t\t\"palmas_usb_vbus\", palmas_usb);\n\t\tif (status < 0) {\n\t\t\tdev_err(&pdev->dev, \"can't get IRQ %d, err %d\\n\",\n\t\t\t\t\tpalmas_usb->vbus_irq, status);\n\t\t\treturn status;\n\t\t}\n\t} else if (palmas_usb->enable_gpio_vbus_detection) {\n\t\t \n\t\tstatus = palmas_update_bits(palmas,\n\t\t\tPALMAS_PU_PD_OD_BASE,\n\t\t\tPALMAS_PRIMARY_SECONDARY_PAD1,\n\t\t\tPALMAS_PRIMARY_SECONDARY_PAD1_GPIO_1_MASK,\n\t\t\t(1 << PALMAS_PRIMARY_SECONDARY_PAD1_GPIO_1_SHIFT));\n\t\tif (status < 0) {\n\t\t\tdev_err(&pdev->dev, \"can't remux GPIO1\\n\");\n\t\t\treturn status;\n\t\t}\n\n\t\tpalmas_usb->vbus_otg_irq = regmap_irq_get_virq(palmas->irq_data,\n\t\t\t\t\t\t       PALMAS_VBUS_OTG_IRQ);\n\t\tpalmas_usb->gpio_vbus_irq = gpiod_to_irq(palmas_usb->vbus_gpiod);\n\t\tif (palmas_usb->gpio_vbus_irq < 0) {\n\t\t\tdev_err(&pdev->dev, \"failed to get vbus irq\\n\");\n\t\t\treturn palmas_usb->gpio_vbus_irq;\n\t\t}\n\t\tstatus = devm_request_threaded_irq(&pdev->dev,\n\t\t\t\t\t\tpalmas_usb->gpio_vbus_irq,\n\t\t\t\t\t\tNULL,\n\t\t\t\t\t\tpalmas_vbus_irq_handler,\n\t\t\t\t\t\tIRQF_TRIGGER_FALLING |\n\t\t\t\t\t\tIRQF_TRIGGER_RISING |\n\t\t\t\t\t\tIRQF_ONESHOT,\n\t\t\t\t\t\t\"palmas_usb_vbus\",\n\t\t\t\t\t\tpalmas_usb);\n\t\tif (status < 0) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"failed to request handler for vbus irq\\n\");\n\t\t\treturn status;\n\t\t}\n\t}\n\n\tpalmas_enable_irq(palmas_usb);\n\t \n\tif (palmas_usb->enable_gpio_vbus_detection)\n\t\tpalmas_vbus_irq_handler(palmas_usb->gpio_vbus_irq, palmas_usb);\n\tpalmas_gpio_id_detect(&palmas_usb->wq_detectid.work);\n\tdevice_set_wakeup_capable(&pdev->dev, true);\n\treturn 0;\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int palmas_usb_suspend(struct device *dev)\n{\n\tstruct palmas_usb *palmas_usb = dev_get_drvdata(dev);\n\n\tif (device_may_wakeup(dev)) {\n\t\tif (palmas_usb->enable_vbus_detection)\n\t\t\tenable_irq_wake(palmas_usb->vbus_irq);\n\t\tif (palmas_usb->enable_gpio_vbus_detection)\n\t\t\tenable_irq_wake(palmas_usb->gpio_vbus_irq);\n\t\tif (palmas_usb->enable_id_detection)\n\t\t\tenable_irq_wake(palmas_usb->id_irq);\n\t\tif (palmas_usb->enable_gpio_id_detection)\n\t\t\tenable_irq_wake(palmas_usb->gpio_id_irq);\n\t}\n\treturn 0;\n}\n\nstatic int palmas_usb_resume(struct device *dev)\n{\n\tstruct palmas_usb *palmas_usb = dev_get_drvdata(dev);\n\n\tif (device_may_wakeup(dev)) {\n\t\tif (palmas_usb->enable_vbus_detection)\n\t\t\tdisable_irq_wake(palmas_usb->vbus_irq);\n\t\tif (palmas_usb->enable_gpio_vbus_detection)\n\t\t\tdisable_irq_wake(palmas_usb->gpio_vbus_irq);\n\t\tif (palmas_usb->enable_id_detection)\n\t\t\tdisable_irq_wake(palmas_usb->id_irq);\n\t\tif (palmas_usb->enable_gpio_id_detection)\n\t\t\tdisable_irq_wake(palmas_usb->gpio_id_irq);\n\t}\n\n\t \n\tif (palmas_usb->enable_gpio_vbus_detection)\n\t\tpalmas_vbus_irq_handler(palmas_usb->gpio_vbus_irq, palmas_usb);\n\tpalmas_gpio_id_detect(&palmas_usb->wq_detectid.work);\n\n\treturn 0;\n};\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(palmas_pm_ops, palmas_usb_suspend, palmas_usb_resume);\n\nstatic const struct of_device_id of_palmas_match_tbl[] = {\n\t{ .compatible = \"ti,palmas-usb\", },\n\t{ .compatible = \"ti,palmas-usb-vid\", },\n\t{ .compatible = \"ti,twl6035-usb\", },\n\t{ .compatible = \"ti,twl6035-usb-vid\", },\n\t{   }\n};\n\nstatic struct platform_driver palmas_usb_driver = {\n\t.probe = palmas_usb_probe,\n\t.driver = {\n\t\t.name = \"palmas-usb\",\n\t\t.of_match_table = of_palmas_match_tbl,\n\t\t.pm = &palmas_pm_ops,\n\t},\n};\n\nmodule_platform_driver(palmas_usb_driver);\n\nMODULE_ALIAS(\"platform:palmas-usb\");\nMODULE_AUTHOR(\"Graeme Gregory <gg@slimlogic.co.uk>\");\nMODULE_DESCRIPTION(\"Palmas USB transceiver driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(of, of_palmas_match_tbl);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}