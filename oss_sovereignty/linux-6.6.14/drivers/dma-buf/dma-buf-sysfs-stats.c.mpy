{
  "module_name": "dma-buf-sysfs-stats.c",
  "hash_id": "be39b4db5349bc6a90118a8c7d0091e183f1c5943adcca9b8faac15385c6dc28",
  "original_prompt": "Ingested from linux-6.6.14/drivers/dma-buf/dma-buf-sysfs-stats.c",
  "human_readable_source": "\n \n\n#include <linux/dma-buf.h>\n#include <linux/dma-resv.h>\n#include <linux/kobject.h>\n#include <linux/printk.h>\n#include <linux/slab.h>\n#include <linux/sysfs.h>\n\n#include \"dma-buf-sysfs-stats.h\"\n\n#define to_dma_buf_entry_from_kobj(x) container_of(x, struct dma_buf_sysfs_entry, kobj)\n\n \n\nstruct dma_buf_stats_attribute {\n\tstruct attribute attr;\n\tssize_t (*show)(struct dma_buf *dmabuf,\n\t\t\tstruct dma_buf_stats_attribute *attr, char *buf);\n};\n#define to_dma_buf_stats_attr(x) container_of(x, struct dma_buf_stats_attribute, attr)\n\nstatic ssize_t dma_buf_stats_attribute_show(struct kobject *kobj,\n\t\t\t\t\t    struct attribute *attr,\n\t\t\t\t\t    char *buf)\n{\n\tstruct dma_buf_stats_attribute *attribute;\n\tstruct dma_buf_sysfs_entry *sysfs_entry;\n\tstruct dma_buf *dmabuf;\n\n\tattribute = to_dma_buf_stats_attr(attr);\n\tsysfs_entry = to_dma_buf_entry_from_kobj(kobj);\n\tdmabuf = sysfs_entry->dmabuf;\n\n\tif (!dmabuf || !attribute->show)\n\t\treturn -EIO;\n\n\treturn attribute->show(dmabuf, attribute, buf);\n}\n\nstatic const struct sysfs_ops dma_buf_stats_sysfs_ops = {\n\t.show = dma_buf_stats_attribute_show,\n};\n\nstatic ssize_t exporter_name_show(struct dma_buf *dmabuf,\n\t\t\t\t  struct dma_buf_stats_attribute *attr,\n\t\t\t\t  char *buf)\n{\n\treturn sysfs_emit(buf, \"%s\\n\", dmabuf->exp_name);\n}\n\nstatic ssize_t size_show(struct dma_buf *dmabuf,\n\t\t\t struct dma_buf_stats_attribute *attr,\n\t\t\t char *buf)\n{\n\treturn sysfs_emit(buf, \"%zu\\n\", dmabuf->size);\n}\n\nstatic struct dma_buf_stats_attribute exporter_name_attribute =\n\t__ATTR_RO(exporter_name);\nstatic struct dma_buf_stats_attribute size_attribute = __ATTR_RO(size);\n\nstatic struct attribute *dma_buf_stats_default_attrs[] = {\n\t&exporter_name_attribute.attr,\n\t&size_attribute.attr,\n\tNULL,\n};\nATTRIBUTE_GROUPS(dma_buf_stats_default);\n\nstatic void dma_buf_sysfs_release(struct kobject *kobj)\n{\n\tstruct dma_buf_sysfs_entry *sysfs_entry;\n\n\tsysfs_entry = to_dma_buf_entry_from_kobj(kobj);\n\tkfree(sysfs_entry);\n}\n\nstatic const struct kobj_type dma_buf_ktype = {\n\t.sysfs_ops = &dma_buf_stats_sysfs_ops,\n\t.release = dma_buf_sysfs_release,\n\t.default_groups = dma_buf_stats_default_groups,\n};\n\nvoid dma_buf_stats_teardown(struct dma_buf *dmabuf)\n{\n\tstruct dma_buf_sysfs_entry *sysfs_entry;\n\n\tsysfs_entry = dmabuf->sysfs_entry;\n\tif (!sysfs_entry)\n\t\treturn;\n\n\tkobject_del(&sysfs_entry->kobj);\n\tkobject_put(&sysfs_entry->kobj);\n}\n\n\n \nstatic int dmabuf_sysfs_uevent_filter(const struct kobject *kobj)\n{\n\treturn 0;\n}\n\nstatic const struct kset_uevent_ops dmabuf_sysfs_no_uevent_ops = {\n\t.filter = dmabuf_sysfs_uevent_filter,\n};\n\nstatic struct kset *dma_buf_stats_kset;\nstatic struct kset *dma_buf_per_buffer_stats_kset;\nint dma_buf_init_sysfs_statistics(void)\n{\n\tdma_buf_stats_kset = kset_create_and_add(\"dmabuf\",\n\t\t\t\t\t\t &dmabuf_sysfs_no_uevent_ops,\n\t\t\t\t\t\t kernel_kobj);\n\tif (!dma_buf_stats_kset)\n\t\treturn -ENOMEM;\n\n\tdma_buf_per_buffer_stats_kset = kset_create_and_add(\"buffers\",\n\t\t\t\t\t\t\t    &dmabuf_sysfs_no_uevent_ops,\n\t\t\t\t\t\t\t    &dma_buf_stats_kset->kobj);\n\tif (!dma_buf_per_buffer_stats_kset) {\n\t\tkset_unregister(dma_buf_stats_kset);\n\t\treturn -ENOMEM;\n\t}\n\n\treturn 0;\n}\n\nvoid dma_buf_uninit_sysfs_statistics(void)\n{\n\tkset_unregister(dma_buf_per_buffer_stats_kset);\n\tkset_unregister(dma_buf_stats_kset);\n}\n\nint dma_buf_stats_setup(struct dma_buf *dmabuf, struct file *file)\n{\n\tstruct dma_buf_sysfs_entry *sysfs_entry;\n\tint ret;\n\n\tif (!dmabuf->exp_name) {\n\t\tpr_err(\"exporter name must not be empty if stats needed\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tsysfs_entry = kzalloc(sizeof(struct dma_buf_sysfs_entry), GFP_KERNEL);\n\tif (!sysfs_entry)\n\t\treturn -ENOMEM;\n\n\tsysfs_entry->kobj.kset = dma_buf_per_buffer_stats_kset;\n\tsysfs_entry->dmabuf = dmabuf;\n\n\tdmabuf->sysfs_entry = sysfs_entry;\n\n\t \n\tret = kobject_init_and_add(&sysfs_entry->kobj, &dma_buf_ktype, NULL,\n\t\t\t\t   \"%lu\", file_inode(file)->i_ino);\n\tif (ret)\n\t\tgoto err_sysfs_dmabuf;\n\n\treturn 0;\n\nerr_sysfs_dmabuf:\n\tkobject_put(&sysfs_entry->kobj);\n\tdmabuf->sysfs_entry = NULL;\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}