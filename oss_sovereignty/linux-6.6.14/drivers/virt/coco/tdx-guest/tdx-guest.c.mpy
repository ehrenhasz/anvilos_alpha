{
  "module_name": "tdx-guest.c",
  "hash_id": "886045d416a49fb9c59f303a2d11a0d6f43bc45f1b013ae7d63f7b1e4ea6bdd0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/virt/coco/tdx-guest/tdx-guest.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/miscdevice.h>\n#include <linux/mm.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/string.h>\n#include <linux/uaccess.h>\n\n#include <uapi/linux/tdx-guest.h>\n\n#include <asm/cpu_device_id.h>\n#include <asm/tdx.h>\n\nstatic long tdx_get_report0(struct tdx_report_req __user *req)\n{\n\tu8 *reportdata, *tdreport;\n\tlong ret;\n\n\treportdata = kmalloc(TDX_REPORTDATA_LEN, GFP_KERNEL);\n\tif (!reportdata)\n\t\treturn -ENOMEM;\n\n\ttdreport = kzalloc(TDX_REPORT_LEN, GFP_KERNEL);\n\tif (!tdreport) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tif (copy_from_user(reportdata, req->reportdata, TDX_REPORTDATA_LEN)) {\n\t\tret = -EFAULT;\n\t\tgoto out;\n\t}\n\n\t \n\tret = tdx_mcall_get_report0(reportdata, tdreport);\n\tif (ret)\n\t\tgoto out;\n\n\tif (copy_to_user(req->tdreport, tdreport, TDX_REPORT_LEN))\n\t\tret = -EFAULT;\n\nout:\n\tkfree(reportdata);\n\tkfree(tdreport);\n\n\treturn ret;\n}\n\nstatic long tdx_guest_ioctl(struct file *file, unsigned int cmd,\n\t\t\t    unsigned long arg)\n{\n\tswitch (cmd) {\n\tcase TDX_CMD_GET_REPORT0:\n\t\treturn tdx_get_report0((struct tdx_report_req __user *)arg);\n\tdefault:\n\t\treturn -ENOTTY;\n\t}\n}\n\nstatic const struct file_operations tdx_guest_fops = {\n\t.owner = THIS_MODULE,\n\t.unlocked_ioctl = tdx_guest_ioctl,\n\t.llseek = no_llseek,\n};\n\nstatic struct miscdevice tdx_misc_dev = {\n\t.name = KBUILD_MODNAME,\n\t.minor = MISC_DYNAMIC_MINOR,\n\t.fops = &tdx_guest_fops,\n};\n\nstatic const struct x86_cpu_id tdx_guest_ids[] = {\n\tX86_MATCH_FEATURE(X86_FEATURE_TDX_GUEST, NULL),\n\t{}\n};\nMODULE_DEVICE_TABLE(x86cpu, tdx_guest_ids);\n\nstatic int __init tdx_guest_init(void)\n{\n\tif (!x86_match_cpu(tdx_guest_ids))\n\t\treturn -ENODEV;\n\n\treturn misc_register(&tdx_misc_dev);\n}\nmodule_init(tdx_guest_init);\n\nstatic void __exit tdx_guest_exit(void)\n{\n\tmisc_deregister(&tdx_misc_dev);\n}\nmodule_exit(tdx_guest_exit);\n\nMODULE_AUTHOR(\"Kuppuswamy Sathyanarayanan <sathyanarayanan.kuppuswamy@linux.intel.com>\");\nMODULE_DESCRIPTION(\"TDX Guest Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}