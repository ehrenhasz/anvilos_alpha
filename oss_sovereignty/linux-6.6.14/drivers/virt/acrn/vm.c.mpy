{
  "module_name": "vm.c",
  "hash_id": "cb26c2ba30f1e8079f5155e62ca09edbc1b0bac3118dac549b238ab380a5f621",
  "original_prompt": "Ingested from linux-6.6.14/drivers/virt/acrn/vm.c",
  "human_readable_source": "\n \n#include <linux/io.h>\n#include <linux/mm.h>\n#include <linux/slab.h>\n\n#include \"acrn_drv.h\"\n\n \nLIST_HEAD(acrn_vm_list);\n \nDEFINE_RWLOCK(acrn_vm_list_lock);\n\nstruct acrn_vm *acrn_vm_create(struct acrn_vm *vm,\n\t\t\t       struct acrn_vm_creation *vm_param)\n{\n\tint ret;\n\n\tret = hcall_create_vm(virt_to_phys(vm_param));\n\tif (ret < 0 || vm_param->vmid == ACRN_INVALID_VMID) {\n\t\tdev_err(acrn_dev.this_device,\n\t\t\t\"Failed to create VM! Error: %d\\n\", ret);\n\t\treturn NULL;\n\t}\n\n\tmutex_init(&vm->regions_mapping_lock);\n\tINIT_LIST_HEAD(&vm->ioreq_clients);\n\tspin_lock_init(&vm->ioreq_clients_lock);\n\tvm->vmid = vm_param->vmid;\n\tvm->vcpu_num = vm_param->vcpu_num;\n\n\tif (acrn_ioreq_init(vm, vm_param->ioreq_buf) < 0) {\n\t\thcall_destroy_vm(vm_param->vmid);\n\t\tvm->vmid = ACRN_INVALID_VMID;\n\t\treturn NULL;\n\t}\n\n\twrite_lock_bh(&acrn_vm_list_lock);\n\tlist_add(&vm->list, &acrn_vm_list);\n\twrite_unlock_bh(&acrn_vm_list_lock);\n\n\tacrn_ioeventfd_init(vm);\n\tacrn_irqfd_init(vm);\n\tdev_dbg(acrn_dev.this_device, \"VM %u created.\\n\", vm->vmid);\n\treturn vm;\n}\n\nint acrn_vm_destroy(struct acrn_vm *vm)\n{\n\tint ret;\n\n\tif (vm->vmid == ACRN_INVALID_VMID ||\n\t    test_and_set_bit(ACRN_VM_FLAG_DESTROYED, &vm->flags))\n\t\treturn 0;\n\n\tret = hcall_destroy_vm(vm->vmid);\n\tif (ret < 0) {\n\t\tdev_err(acrn_dev.this_device,\n\t\t\t\"Failed to destroy VM %u\\n\", vm->vmid);\n\t\tclear_bit(ACRN_VM_FLAG_DESTROYED, &vm->flags);\n\t\treturn ret;\n\t}\n\n\t \n\twrite_lock_bh(&acrn_vm_list_lock);\n\tlist_del_init(&vm->list);\n\twrite_unlock_bh(&acrn_vm_list_lock);\n\n\tacrn_ioeventfd_deinit(vm);\n\tacrn_irqfd_deinit(vm);\n\tacrn_ioreq_deinit(vm);\n\n\tif (vm->monitor_page) {\n\t\tput_page(vm->monitor_page);\n\t\tvm->monitor_page = NULL;\n\t}\n\n\tacrn_vm_all_ram_unmap(vm);\n\n\tdev_dbg(acrn_dev.this_device, \"VM %u destroyed.\\n\", vm->vmid);\n\tvm->vmid = ACRN_INVALID_VMID;\n\treturn 0;\n}\n\n \nint acrn_msi_inject(struct acrn_vm *vm, u64 msi_addr, u64 msi_data)\n{\n\tstruct acrn_msi_entry *msi;\n\tint ret;\n\n\t \n\tmsi = kzalloc(sizeof(*msi), GFP_ATOMIC);\n\tif (!msi)\n\t\treturn -ENOMEM;\n\n\t \n\tmsi->msi_addr = msi_addr;\n\tmsi->msi_data = msi_data;\n\tret = hcall_inject_msi(vm->vmid, virt_to_phys(msi));\n\tif (ret < 0)\n\t\tdev_err(acrn_dev.this_device,\n\t\t\t\"Failed to inject MSI to VM %u!\\n\", vm->vmid);\n\tkfree(msi);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}