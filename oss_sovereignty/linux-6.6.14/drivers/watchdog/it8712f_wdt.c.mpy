{
  "module_name": "it8712f_wdt.c",
  "hash_id": "9fdf9c405edbf7bc1e5207f4e145355fd1be005e08f50963493d08eccfe2774b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/it8712f_wdt.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/init.h>\n#include <linux/miscdevice.h>\n#include <linux/watchdog.h>\n#include <linux/notifier.h>\n#include <linux/reboot.h>\n#include <linux/fs.h>\n#include <linux/spinlock.h>\n#include <linux/uaccess.h>\n#include <linux/io.h>\n#include <linux/ioport.h>\n\n#define NAME \"it8712f_wdt\"\n\nMODULE_AUTHOR(\"Jorge Boncompte - DTI2 <jorge@dti2.net>\");\nMODULE_DESCRIPTION(\"IT8712F Watchdog Driver\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int max_units = 255;\nstatic int margin = 60;\t\t \nmodule_param(margin, int, 0);\nMODULE_PARM_DESC(margin, \"Watchdog margin in seconds\");\n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout, \"Disable watchdog shutdown on close\");\n\nstatic unsigned long wdt_open;\nstatic unsigned expect_close;\nstatic unsigned char revision;\n\n \nstatic unsigned short address;\n\n#define\tREG\t\t0x2e\t \n#define\tVAL\t\t0x2f\t \n\n#define\tLDN\t\t0x07\t \n#define\tDEVID\t\t0x20\t \n#define\tDEVREV\t\t0x22\t \n#define ACT_REG\t\t0x30\t \n#define BASE_REG\t0x60\t \n\n#define IT8712F_DEVID\t0x8712\n\n#define LDN_GPIO\t0x07\t \n#define LDN_GAME\t0x09\t \n\n#define WDT_CONTROL\t0x71\t \n#define WDT_CONFIG\t0x72\t \n#define WDT_TIMEOUT\t0x73\t \n\n#define WDT_RESET_GAME\t0x10\t \n#define WDT_RESET_KBD\t0x20\t \n#define WDT_RESET_MOUSE\t0x40\t \n#define WDT_RESET_CIR\t0x80\t \n\n#define WDT_UNIT_SEC\t0x80\t \n\n#define WDT_OUT_PWROK\t0x10\t \n#define WDT_OUT_KRST\t0x40\t \n\nstatic int wdt_control_reg = WDT_RESET_GAME;\nmodule_param(wdt_control_reg, int, 0);\nMODULE_PARM_DESC(wdt_control_reg, \"Value to write to watchdog control \"\n\t\t\"register. The default WDT_RESET_GAME resets the timer on \"\n\t\t\"game port reads that this driver generates. You can also \"\n\t\t\"use KBD, MOUSE or CIR if you have some external way to \"\n\t\t\"generate those interrupts.\");\n\nstatic int superio_inb(int reg)\n{\n\toutb(reg, REG);\n\treturn inb(VAL);\n}\n\nstatic void superio_outb(int val, int reg)\n{\n\toutb(reg, REG);\n\toutb(val, VAL);\n}\n\nstatic int superio_inw(int reg)\n{\n\tint val;\n\toutb(reg++, REG);\n\tval = inb(VAL) << 8;\n\toutb(reg, REG);\n\tval |= inb(VAL);\n\treturn val;\n}\n\nstatic inline void superio_select(int ldn)\n{\n\toutb(LDN, REG);\n\toutb(ldn, VAL);\n}\n\nstatic inline int superio_enter(void)\n{\n\t \n\tif (!request_muxed_region(REG, 2, NAME))\n\t\treturn -EBUSY;\n\n\toutb(0x87, REG);\n\toutb(0x01, REG);\n\toutb(0x55, REG);\n\toutb(0x55, REG);\n\treturn 0;\n}\n\nstatic inline void superio_exit(void)\n{\n\toutb(0x02, REG);\n\toutb(0x02, VAL);\n\trelease_region(REG, 2);\n}\n\nstatic inline void it8712f_wdt_ping(void)\n{\n\tif (wdt_control_reg & WDT_RESET_GAME)\n\t\tinb(address);\n}\n\nstatic void it8712f_wdt_update_margin(void)\n{\n\tint config = WDT_OUT_KRST | WDT_OUT_PWROK;\n\tint units = margin;\n\n\t \n\tif (units <= max_units) {\n\t\tconfig |= WDT_UNIT_SEC;  \n\t\tpr_info(\"timer margin %d seconds\\n\", units);\n\t} else {\n\t\tunits /= 60;\n\t\tpr_info(\"timer margin %d minutes\\n\", units);\n\t}\n\tsuperio_outb(config, WDT_CONFIG);\n\n\tif (revision >= 0x08)\n\t\tsuperio_outb(units >> 8, WDT_TIMEOUT + 1);\n\tsuperio_outb(units, WDT_TIMEOUT);\n}\n\nstatic int it8712f_wdt_get_status(void)\n{\n\tif (superio_inb(WDT_CONTROL) & 0x01)\n\t\treturn WDIOF_CARDRESET;\n\telse\n\t\treturn 0;\n}\n\nstatic int it8712f_wdt_enable(void)\n{\n\tint ret = superio_enter();\n\tif (ret)\n\t\treturn ret;\n\n\tpr_debug(\"enabling watchdog timer\\n\");\n\tsuperio_select(LDN_GPIO);\n\n\tsuperio_outb(wdt_control_reg, WDT_CONTROL);\n\n\tit8712f_wdt_update_margin();\n\n\tsuperio_exit();\n\n\tit8712f_wdt_ping();\n\n\treturn 0;\n}\n\nstatic int it8712f_wdt_disable(void)\n{\n\tint ret = superio_enter();\n\tif (ret)\n\t\treturn ret;\n\n\tpr_debug(\"disabling watchdog timer\\n\");\n\tsuperio_select(LDN_GPIO);\n\n\tsuperio_outb(0, WDT_CONFIG);\n\tsuperio_outb(0, WDT_CONTROL);\n\tif (revision >= 0x08)\n\t\tsuperio_outb(0, WDT_TIMEOUT + 1);\n\tsuperio_outb(0, WDT_TIMEOUT);\n\n\tsuperio_exit();\n\treturn 0;\n}\n\nstatic int it8712f_wdt_notify(struct notifier_block *this,\n\t\t    unsigned long code, void *unused)\n{\n\tif (code == SYS_HALT || code == SYS_POWER_OFF)\n\t\tif (!nowayout)\n\t\t\tit8712f_wdt_disable();\n\n\treturn NOTIFY_DONE;\n}\n\nstatic struct notifier_block it8712f_wdt_notifier = {\n\t.notifier_call = it8712f_wdt_notify,\n};\n\nstatic ssize_t it8712f_wdt_write(struct file *file, const char __user *data,\n\t\t\t\t\tsize_t len, loff_t *ppos)\n{\n\t \n\tif (len) {\n\t\tsize_t i;\n\n\t\tit8712f_wdt_ping();\n\n\t\texpect_close = 0;\n\t\tfor (i = 0; i < len; ++i) {\n\t\t\tchar c;\n\t\t\tif (get_user(c, data + i))\n\t\t\t\treturn -EFAULT;\n\t\t\tif (c == 'V')\n\t\t\t\texpect_close = 42;\n\t\t}\n\t}\n\n\treturn len;\n}\n\nstatic long it8712f_wdt_ioctl(struct file *file, unsigned int cmd,\n\t\t\t\t\t\t\tunsigned long arg)\n{\n\tvoid __user *argp = (void __user *)arg;\n\tint __user *p = argp;\n\tstatic const struct watchdog_info ident = {\n\t\t.identity = \"IT8712F Watchdog\",\n\t\t.firmware_version = 1,\n\t\t.options = WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING |\n\t\t\t\t\t\tWDIOF_MAGICCLOSE,\n\t};\n\tint value;\n\tint ret;\n\n\tswitch (cmd) {\n\tcase WDIOC_GETSUPPORT:\n\t\tif (copy_to_user(argp, &ident, sizeof(ident)))\n\t\t\treturn -EFAULT;\n\t\treturn 0;\n\tcase WDIOC_GETSTATUS:\n\t\tret = superio_enter();\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tsuperio_select(LDN_GPIO);\n\n\t\tvalue = it8712f_wdt_get_status();\n\n\t\tsuperio_exit();\n\n\t\treturn put_user(value, p);\n\tcase WDIOC_GETBOOTSTATUS:\n\t\treturn put_user(0, p);\n\tcase WDIOC_KEEPALIVE:\n\t\tit8712f_wdt_ping();\n\t\treturn 0;\n\tcase WDIOC_SETTIMEOUT:\n\t\tif (get_user(value, p))\n\t\t\treturn -EFAULT;\n\t\tif (value < 1)\n\t\t\treturn -EINVAL;\n\t\tif (value > (max_units * 60))\n\t\t\treturn -EINVAL;\n\t\tmargin = value;\n\t\tret = superio_enter();\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tsuperio_select(LDN_GPIO);\n\n\t\tit8712f_wdt_update_margin();\n\n\t\tsuperio_exit();\n\t\tit8712f_wdt_ping();\n\t\tfallthrough;\n\tcase WDIOC_GETTIMEOUT:\n\t\tif (put_user(margin, p))\n\t\t\treturn -EFAULT;\n\t\treturn 0;\n\tdefault:\n\t\treturn -ENOTTY;\n\t}\n}\n\nstatic int it8712f_wdt_open(struct inode *inode, struct file *file)\n{\n\tint ret;\n\t \n\tif (test_and_set_bit(0, &wdt_open))\n\t\treturn -EBUSY;\n\n\tret = it8712f_wdt_enable();\n\tif (ret)\n\t\treturn ret;\n\treturn stream_open(inode, file);\n}\n\nstatic int it8712f_wdt_release(struct inode *inode, struct file *file)\n{\n\tif (expect_close != 42) {\n\t\tpr_warn(\"watchdog device closed unexpectedly, will not disable the watchdog timer\\n\");\n\t} else if (!nowayout) {\n\t\tif (it8712f_wdt_disable())\n\t\t\tpr_warn(\"Watchdog disable failed\\n\");\n\t}\n\texpect_close = 0;\n\tclear_bit(0, &wdt_open);\n\n\treturn 0;\n}\n\nstatic const struct file_operations it8712f_wdt_fops = {\n\t.owner = THIS_MODULE,\n\t.llseek = no_llseek,\n\t.write = it8712f_wdt_write,\n\t.unlocked_ioctl = it8712f_wdt_ioctl,\n\t.compat_ioctl = compat_ptr_ioctl,\n\t.open = it8712f_wdt_open,\n\t.release = it8712f_wdt_release,\n};\n\nstatic struct miscdevice it8712f_wdt_miscdev = {\n\t.minor = WATCHDOG_MINOR,\n\t.name = \"watchdog\",\n\t.fops = &it8712f_wdt_fops,\n};\n\nstatic int __init it8712f_wdt_find(unsigned short *address)\n{\n\tint err = -ENODEV;\n\tint chip_type;\n\tint ret = superio_enter();\n\tif (ret)\n\t\treturn ret;\n\n\tchip_type = superio_inw(DEVID);\n\tif (chip_type != IT8712F_DEVID)\n\t\tgoto exit;\n\n\tsuperio_select(LDN_GAME);\n\tsuperio_outb(1, ACT_REG);\n\tif (!(superio_inb(ACT_REG) & 0x01)) {\n\t\tpr_err(\"Device not activated, skipping\\n\");\n\t\tgoto exit;\n\t}\n\n\t*address = superio_inw(BASE_REG);\n\tif (*address == 0) {\n\t\tpr_err(\"Base address not set, skipping\\n\");\n\t\tgoto exit;\n\t}\n\n\terr = 0;\n\trevision = superio_inb(DEVREV) & 0x0f;\n\n\t \n\tif (revision >= 0x08)\n\t\tmax_units = 65535;\n\n\tif (margin > (max_units * 60))\n\t\tmargin = (max_units * 60);\n\n\tpr_info(\"Found IT%04xF chip revision %d - using DogFood address 0x%x\\n\",\n\t\tchip_type, revision, *address);\n\nexit:\n\tsuperio_exit();\n\treturn err;\n}\n\nstatic int __init it8712f_wdt_init(void)\n{\n\tint err = 0;\n\n\tif (it8712f_wdt_find(&address))\n\t\treturn -ENODEV;\n\n\tif (!request_region(address, 1, \"IT8712F Watchdog\")) {\n\t\tpr_warn(\"watchdog I/O region busy\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\terr = it8712f_wdt_disable();\n\tif (err) {\n\t\tpr_err(\"unable to disable watchdog timer\\n\");\n\t\tgoto out;\n\t}\n\n\terr = register_reboot_notifier(&it8712f_wdt_notifier);\n\tif (err) {\n\t\tpr_err(\"unable to register reboot notifier\\n\");\n\t\tgoto out;\n\t}\n\n\terr = misc_register(&it8712f_wdt_miscdev);\n\tif (err) {\n\t\tpr_err(\"cannot register miscdev on minor=%d (err=%d)\\n\",\n\t\t       WATCHDOG_MINOR, err);\n\t\tgoto reboot_out;\n\t}\n\n\treturn 0;\n\n\nreboot_out:\n\tunregister_reboot_notifier(&it8712f_wdt_notifier);\nout:\n\trelease_region(address, 1);\n\treturn err;\n}\n\nstatic void __exit it8712f_wdt_exit(void)\n{\n\tmisc_deregister(&it8712f_wdt_miscdev);\n\tunregister_reboot_notifier(&it8712f_wdt_notifier);\n\trelease_region(address, 1);\n}\n\nmodule_init(it8712f_wdt_init);\nmodule_exit(it8712f_wdt_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}