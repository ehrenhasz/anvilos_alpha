{
  "module_name": "pc87413_wdt.c",
  "hash_id": "24d8838ae2db477b5bacef5b8b28e62c07fcd6b8cc7a8205bf1aab60f74680bb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/pc87413_wdt.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/miscdevice.h>\n#include <linux/watchdog.h>\n#include <linux/ioport.h>\n#include <linux/delay.h>\n#include <linux/notifier.h>\n#include <linux/fs.h>\n#include <linux/reboot.h>\n#include <linux/init.h>\n#include <linux/spinlock.h>\n#include <linux/moduleparam.h>\n#include <linux/io.h>\n#include <linux/uaccess.h>\n\n\n \n\n#define DEFAULT_TIMEOUT     1\t\t \n#define MAX_TIMEOUT         255\n\n#define VERSION             \"1.1\"\n#define MODNAME             \"pc87413 WDT\"\n#define DPFX                MODNAME \" - DEBUG: \"\n\n#define WDT_INDEX_IO_PORT   (io+0)\t \n#define WDT_DATA_IO_PORT    (WDT_INDEX_IO_PORT+1)\n#define SWC_LDN             0x04\n#define SIOCFG2             0x22\t \n#define WDCTL               0x10\t \n#define WDTO                0x11\t \n#define WDCFG               0x12\t \n\n#define IO_DEFAULT\t0x2E\t\t \n\nstatic int io = IO_DEFAULT;\nstatic int swc_base_addr = -1;\n\nstatic int timeout = DEFAULT_TIMEOUT;\t \nstatic unsigned long timer_enabled;\t \n\nstatic char expect_close;\t\t \n\nstatic DEFINE_SPINLOCK(io_lock);\t \n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\n\n \n\n \n\nstatic inline void pc87413_select_wdt_out(void)\n{\n\tunsigned int cr_data = 0;\n\n\t \n\n\toutb_p(SIOCFG2, WDT_INDEX_IO_PORT);\n\n\tcr_data = inb(WDT_DATA_IO_PORT);\n\n\tcr_data |= 0x80;  \n\toutb_p(SIOCFG2, WDT_INDEX_IO_PORT);\n\n\toutb_p(cr_data, WDT_DATA_IO_PORT);\n\n#ifdef DEBUG\n\tpr_info(DPFX\n\t\t\"Select multiple pin,pin55,as WDT output: Bit7 to 1: %d\\n\",\n\t\t\t\t\t\t\t\tcr_data);\n#endif\n}\n\n \n\nstatic inline void pc87413_enable_swc(void)\n{\n\tunsigned int cr_data = 0;\n\n\t \n\n\toutb_p(0x07, WDT_INDEX_IO_PORT);\t \n\toutb_p(SWC_LDN, WDT_DATA_IO_PORT);\n\n\toutb_p(0x30, WDT_INDEX_IO_PORT);\t \n\tcr_data = inb(WDT_DATA_IO_PORT);\n\tcr_data |= 0x01;\t\t\t \n\toutb_p(0x30, WDT_INDEX_IO_PORT);\n\toutb_p(cr_data, WDT_DATA_IO_PORT);\t \n\n#ifdef DEBUG\n\tpr_info(DPFX \"pc87413 - Enable SWC functions\\n\");\n#endif\n}\n\n \n\nstatic void pc87413_get_swc_base_addr(void)\n{\n\tunsigned char addr_l, addr_h = 0;\n\n\t \n\n\toutb_p(0x60, WDT_INDEX_IO_PORT);\t \n\taddr_h = inb(WDT_DATA_IO_PORT);\n\n\toutb_p(0x61, WDT_INDEX_IO_PORT);\t \n\n\taddr_l = inb(WDT_DATA_IO_PORT);\n\n\tswc_base_addr = (addr_h << 8) + addr_l;\n#ifdef DEBUG\n\tpr_info(DPFX\n\t\t\"Read SWC I/O Base Address: low %d, high %d, res %d\\n\",\n\t\t\t\t\t\taddr_l, addr_h, swc_base_addr);\n#endif\n}\n\n \n\nstatic inline void pc87413_swc_bank3(void)\n{\n\t \n\toutb_p(inb(swc_base_addr + 0x0f) | 0x03, swc_base_addr + 0x0f);\n#ifdef DEBUG\n\tpr_info(DPFX \"Select Bank3 of SWC\\n\");\n#endif\n}\n\n \n\nstatic inline void pc87413_programm_wdto(char pc87413_time)\n{\n\t \n\toutb_p(pc87413_time, swc_base_addr + WDTO);\n#ifdef DEBUG\n\tpr_info(DPFX \"Set WDTO to %d minutes\\n\", pc87413_time);\n#endif\n}\n\n \n\nstatic inline void pc87413_enable_wden(void)\n{\n\t \n\toutb_p(inb(swc_base_addr + WDCTL) | 0x01, swc_base_addr + WDCTL);\n#ifdef DEBUG\n\tpr_info(DPFX \"Enable WDEN\\n\");\n#endif\n}\n\n \nstatic inline void pc87413_enable_sw_wd_tren(void)\n{\n\t \n\toutb_p(inb(swc_base_addr + WDCFG) | 0x80, swc_base_addr + WDCFG);\n#ifdef DEBUG\n\tpr_info(DPFX \"Enable SW_WD_TREN\\n\");\n#endif\n}\n\n \n\nstatic inline void pc87413_disable_sw_wd_tren(void)\n{\n\t \n\toutb_p(inb(swc_base_addr + WDCFG) & 0x7f, swc_base_addr + WDCFG);\n#ifdef DEBUG\n\tpr_info(DPFX \"pc87413 - Disable SW_WD_TREN\\n\");\n#endif\n}\n\n \n\nstatic inline void pc87413_enable_sw_wd_trg(void)\n{\n\t \n\toutb_p(inb(swc_base_addr + WDCTL) | 0x80, swc_base_addr + WDCTL);\n#ifdef DEBUG\n\tpr_info(DPFX \"pc87413 - Enable SW_WD_TRG\\n\");\n#endif\n}\n\n \n\nstatic inline void pc87413_disable_sw_wd_trg(void)\n{\n\t \n\toutb_p(inb(swc_base_addr + WDCTL) & 0x7f, swc_base_addr + WDCTL);\n#ifdef DEBUG\n\tpr_info(DPFX \"Disable SW_WD_TRG\\n\");\n#endif\n}\n\n \n\n \n\nstatic void pc87413_enable(void)\n{\n\tspin_lock(&io_lock);\n\n\tpc87413_swc_bank3();\n\tpc87413_programm_wdto(timeout);\n\tpc87413_enable_wden();\n\tpc87413_enable_sw_wd_tren();\n\tpc87413_enable_sw_wd_trg();\n\n\tspin_unlock(&io_lock);\n}\n\n \n\nstatic void pc87413_disable(void)\n{\n\tspin_lock(&io_lock);\n\n\tpc87413_swc_bank3();\n\tpc87413_disable_sw_wd_tren();\n\tpc87413_disable_sw_wd_trg();\n\tpc87413_programm_wdto(0);\n\n\tspin_unlock(&io_lock);\n}\n\n \n\nstatic void pc87413_refresh(void)\n{\n\tspin_lock(&io_lock);\n\n\tpc87413_swc_bank3();\n\tpc87413_disable_sw_wd_tren();\n\tpc87413_disable_sw_wd_trg();\n\tpc87413_programm_wdto(timeout);\n\tpc87413_enable_wden();\n\tpc87413_enable_sw_wd_tren();\n\tpc87413_enable_sw_wd_trg();\n\n\tspin_unlock(&io_lock);\n}\n\n \n\n \n\nstatic int pc87413_open(struct inode *inode, struct file *file)\n{\n\t \n\n\tif (test_and_set_bit(0, &timer_enabled))\n\t\treturn -EBUSY;\n\n\tif (nowayout)\n\t\t__module_get(THIS_MODULE);\n\n\t \n\tpc87413_refresh();\n\n\tpr_info(\"Watchdog enabled. Timeout set to %d minute(s).\\n\", timeout);\n\n\treturn stream_open(inode, file);\n}\n\n \n\nstatic int pc87413_release(struct inode *inode, struct file *file)\n{\n\t \n\n\tif (expect_close == 42) {\n\t\tpc87413_disable();\n\t\tpr_info(\"Watchdog disabled, sleeping again...\\n\");\n\t} else {\n\t\tpr_crit(\"Unexpected close, not stopping watchdog!\\n\");\n\t\tpc87413_refresh();\n\t}\n\tclear_bit(0, &timer_enabled);\n\texpect_close = 0;\n\treturn 0;\n}\n\n \n\n\nstatic int pc87413_status(void)\n{\n\t  return 0;  \n}\n\n \n\nstatic ssize_t pc87413_write(struct file *file, const char __user *data,\n\t\t\t     size_t len, loff_t *ppos)\n{\n\t \n\tif (len) {\n\t\tif (!nowayout) {\n\t\t\tsize_t i;\n\n\t\t\t \n\t\t\texpect_close = 0;\n\n\t\t\t \n\t\t\tfor (i = 0; i != len; i++) {\n\t\t\t\tchar c;\n\t\t\t\tif (get_user(c, data + i))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tif (c == 'V')\n\t\t\t\t\texpect_close = 42;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tpc87413_refresh();\n\t}\n\treturn len;\n}\n\n \n\nstatic long pc87413_ioctl(struct file *file, unsigned int cmd,\n\t\t\t\t\t\tunsigned long arg)\n{\n\tint new_timeout;\n\n\tunion {\n\t\tstruct watchdog_info __user *ident;\n\t\tint __user *i;\n\t} uarg;\n\n\tstatic const struct watchdog_info ident = {\n\t\t.options          = WDIOF_KEEPALIVEPING |\n\t\t\t\t    WDIOF_SETTIMEOUT |\n\t\t\t\t    WDIOF_MAGICCLOSE,\n\t\t.firmware_version = 1,\n\t\t.identity         = \"PC87413(HF/F) watchdog\",\n\t};\n\n\tuarg.i = (int __user *)arg;\n\n\tswitch (cmd) {\n\tcase WDIOC_GETSUPPORT:\n\t\treturn copy_to_user(uarg.ident, &ident,\n\t\t\t\t\tsizeof(ident)) ? -EFAULT : 0;\n\tcase WDIOC_GETSTATUS:\n\t\treturn put_user(pc87413_status(), uarg.i);\n\tcase WDIOC_GETBOOTSTATUS:\n\t\treturn put_user(0, uarg.i);\n\tcase WDIOC_SETOPTIONS:\n\t{\n\t\tint options, retval = -EINVAL;\n\t\tif (get_user(options, uarg.i))\n\t\t\treturn -EFAULT;\n\t\tif (options & WDIOS_DISABLECARD) {\n\t\t\tpc87413_disable();\n\t\t\tretval = 0;\n\t\t}\n\t\tif (options & WDIOS_ENABLECARD) {\n\t\t\tpc87413_enable();\n\t\t\tretval = 0;\n\t\t}\n\t\treturn retval;\n\t}\n\tcase WDIOC_KEEPALIVE:\n\t\tpc87413_refresh();\n#ifdef DEBUG\n\t\tpr_info(DPFX \"keepalive\\n\");\n#endif\n\t\treturn 0;\n\tcase WDIOC_SETTIMEOUT:\n\t\tif (get_user(new_timeout, uarg.i))\n\t\t\treturn -EFAULT;\n\t\t \n\t\tnew_timeout /= 60;\n\t\tif (new_timeout < 0 || new_timeout > MAX_TIMEOUT)\n\t\t\treturn -EINVAL;\n\t\ttimeout = new_timeout;\n\t\tpc87413_refresh();\n\t\tfallthrough;\t \n\tcase WDIOC_GETTIMEOUT:\n\t\tnew_timeout = timeout * 60;\n\t\treturn put_user(new_timeout, uarg.i);\n\tdefault:\n\t\treturn -ENOTTY;\n\t}\n}\n\n \n\n \n\nstatic int pc87413_notify_sys(struct notifier_block *this,\n\t\t\t      unsigned long code,\n\t\t\t      void *unused)\n{\n\tif (code == SYS_DOWN || code == SYS_HALT)\n\t\t \n\t\tpc87413_disable();\n\treturn NOTIFY_DONE;\n}\n\n \n\nstatic const struct file_operations pc87413_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.llseek\t\t= no_llseek,\n\t.write\t\t= pc87413_write,\n\t.unlocked_ioctl\t= pc87413_ioctl,\n\t.compat_ioctl\t= compat_ptr_ioctl,\n\t.open\t\t= pc87413_open,\n\t.release\t= pc87413_release,\n};\n\nstatic struct notifier_block pc87413_notifier = {\n\t.notifier_call  = pc87413_notify_sys,\n};\n\nstatic struct miscdevice pc87413_miscdev = {\n\t.minor          = WATCHDOG_MINOR,\n\t.name           = \"watchdog\",\n\t.fops           = &pc87413_fops,\n};\n\n \n\n \n\nstatic int __init pc87413_init(void)\n{\n\tint ret;\n\n\tpr_info(\"Version \" VERSION \" at io 0x%X\\n\",\n\t\t\t\t\t\t\tWDT_INDEX_IO_PORT);\n\n\tif (!request_muxed_region(io, 2, MODNAME))\n\t\treturn -EBUSY;\n\n\tret = register_reboot_notifier(&pc87413_notifier);\n\tif (ret != 0)\n\t\tpr_err(\"cannot register reboot notifier (err=%d)\\n\", ret);\n\n\tret = misc_register(&pc87413_miscdev);\n\tif (ret != 0) {\n\t\tpr_err(\"cannot register miscdev on minor=%d (err=%d)\\n\",\n\t\t       WATCHDOG_MINOR, ret);\n\t\tgoto reboot_unreg;\n\t}\n\tpr_info(\"initialized. timeout=%d min\\n\", timeout);\n\n\tpc87413_select_wdt_out();\n\tpc87413_enable_swc();\n\tpc87413_get_swc_base_addr();\n\n\tif (!request_region(swc_base_addr, 0x20, MODNAME)) {\n\t\tpr_err(\"cannot request SWC region at 0x%x\\n\", swc_base_addr);\n\t\tret = -EBUSY;\n\t\tgoto misc_unreg;\n\t}\n\n\tpc87413_enable();\n\n\trelease_region(io, 2);\n\treturn 0;\n\nmisc_unreg:\n\tmisc_deregister(&pc87413_miscdev);\nreboot_unreg:\n\tunregister_reboot_notifier(&pc87413_notifier);\n\trelease_region(io, 2);\n\treturn ret;\n}\n\n \n\nstatic void __exit pc87413_exit(void)\n{\n\t \n\tif (!nowayout) {\n\t\tpc87413_disable();\n\t\tpr_info(\"Watchdog disabled\\n\");\n\t}\n\n\tmisc_deregister(&pc87413_miscdev);\n\tunregister_reboot_notifier(&pc87413_notifier);\n\trelease_region(swc_base_addr, 0x20);\n\n\tpr_info(\"watchdog component driver removed\\n\");\n}\n\nmodule_init(pc87413_init);\nmodule_exit(pc87413_exit);\n\nMODULE_AUTHOR(\"Sven Anders <anders@anduras.de>\");\nMODULE_AUTHOR(\"Marcus Junker <junker@anduras.de>\");\nMODULE_DESCRIPTION(\"PC87413 WDT driver\");\nMODULE_LICENSE(\"GPL\");\n\nmodule_param_hw(io, int, ioport, 0);\nMODULE_PARM_DESC(io, MODNAME \" I/O port (default: \"\n\t\t\t\t\t__MODULE_STRING(IO_DEFAULT) \").\");\n\nmodule_param(timeout, int, 0);\nMODULE_PARM_DESC(timeout,\n\t\t\"Watchdog timeout in minutes (default=\"\n\t\t\t\t__MODULE_STRING(DEFAULT_TIMEOUT) \").\");\n\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout,\n\t\t\"Watchdog cannot be stopped once started (default=\"\n\t\t\t\t__MODULE_STRING(WATCHDOG_NOWAYOUT) \")\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}