{
  "module_name": "rzn1_wdt.c",
  "hash_id": "66bd16dba6a6eefb0909cd1fe336f7bd982becd5c5534186fd4ae08f0288ce9d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/rzn1_wdt.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n#include <linux/platform_device.h>\n#include <linux/reboot.h>\n#include <linux/watchdog.h>\n\n#define DEFAULT_TIMEOUT\t\t60\n\n#define RZN1_WDT_RETRIGGER\t\t\t0x0\n#define RZN1_WDT_RETRIGGER_RELOAD_VAL\t\t0\n#define RZN1_WDT_RETRIGGER_RELOAD_VAL_MASK\t0xfff\n#define RZN1_WDT_RETRIGGER_PRESCALE\t\tBIT(12)\n#define RZN1_WDT_RETRIGGER_ENABLE\t\tBIT(13)\n#define RZN1_WDT_RETRIGGER_WDSI\t\t\t(0x2 << 14)\n\n#define RZN1_WDT_PRESCALER\t\t\t16384\n#define RZN1_WDT_MAX\t\t\t\t4095\n\nstruct rzn1_watchdog {\n\tstruct watchdog_device\t\twdtdev;\n\tvoid __iomem\t\t\t*base;\n\tunsigned long\t\t\tclk_rate_khz;\n};\n\nstatic inline uint32_t max_heart_beat_ms(unsigned long clk_rate_khz)\n{\n\treturn (RZN1_WDT_MAX * RZN1_WDT_PRESCALER) / clk_rate_khz;\n}\n\nstatic inline uint32_t compute_reload_value(uint32_t tick_ms,\n\t\t\t\t\t    unsigned long clk_rate_khz)\n{\n\treturn (tick_ms * clk_rate_khz) / RZN1_WDT_PRESCALER;\n}\n\nstatic int rzn1_wdt_ping(struct watchdog_device *w)\n{\n\tstruct rzn1_watchdog *wdt = watchdog_get_drvdata(w);\n\n\t \n\twritel(0, wdt->base + RZN1_WDT_RETRIGGER);\n\n\treturn 0;\n}\n\nstatic int rzn1_wdt_start(struct watchdog_device *w)\n{\n\tstruct rzn1_watchdog *wdt = watchdog_get_drvdata(w);\n\tu32 val;\n\n\t \n\tval = RZN1_WDT_RETRIGGER_WDSI;\n\tval |= RZN1_WDT_RETRIGGER_ENABLE;\n\tval |= RZN1_WDT_RETRIGGER_PRESCALE;\n\tval |= compute_reload_value(w->max_hw_heartbeat_ms, wdt->clk_rate_khz);\n\twritel(val, wdt->base + RZN1_WDT_RETRIGGER);\n\n\treturn 0;\n}\n\nstatic irqreturn_t rzn1_wdt_irq(int irq, void *_wdt)\n{\n\tpr_crit(\"RZN1 Watchdog. Initiating system reboot\\n\");\n\temergency_restart();\n\n\treturn IRQ_HANDLED;\n}\n\nstatic struct watchdog_info rzn1_wdt_info = {\n\t.identity = \"RZ/N1 Watchdog\",\n\t.options = WDIOF_MAGICCLOSE | WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING,\n};\n\nstatic const struct watchdog_ops rzn1_wdt_ops = {\n\t.owner = THIS_MODULE,\n\t.start = rzn1_wdt_start,\n\t.ping = rzn1_wdt_ping,\n};\n\nstatic int rzn1_wdt_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct rzn1_watchdog *wdt;\n\tstruct device_node *np = dev->of_node;\n\tstruct clk *clk;\n\tunsigned long clk_rate;\n\tint ret;\n\tint irq;\n\n\twdt = devm_kzalloc(dev, sizeof(*wdt), GFP_KERNEL);\n\tif (!wdt)\n\t\treturn -ENOMEM;\n\n\twdt->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(wdt->base))\n\t\treturn PTR_ERR(wdt->base);\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\tret = devm_request_irq(dev, irq, rzn1_wdt_irq, 0,\n\t\t\t       np->name, wdt);\n\tif (ret) {\n\t\tdev_err(dev, \"failed to request irq %d\\n\", irq);\n\t\treturn ret;\n\t}\n\n\tclk = devm_clk_get_enabled(dev, NULL);\n\tif (IS_ERR(clk)) {\n\t\tdev_err(dev, \"failed to get the clock\\n\");\n\t\treturn PTR_ERR(clk);\n\t}\n\n\tclk_rate = clk_get_rate(clk);\n\tif (!clk_rate) {\n\t\tdev_err(dev, \"failed to get the clock rate\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\twdt->clk_rate_khz = clk_rate / 1000;\n\twdt->wdtdev.info = &rzn1_wdt_info,\n\twdt->wdtdev.ops = &rzn1_wdt_ops,\n\twdt->wdtdev.status = WATCHDOG_NOWAYOUT_INIT_STATUS,\n\twdt->wdtdev.parent = dev;\n\t \n\twdt->wdtdev.max_hw_heartbeat_ms = max_heart_beat_ms(wdt->clk_rate_khz);\n\tif (wdt->wdtdev.max_hw_heartbeat_ms > 1000)\n\t\twdt->wdtdev.max_hw_heartbeat_ms = 1000;\n\n\twdt->wdtdev.timeout = DEFAULT_TIMEOUT;\n\tret = watchdog_init_timeout(&wdt->wdtdev, 0, dev);\n\tif (ret)\n\t\treturn ret;\n\n\twatchdog_set_drvdata(&wdt->wdtdev, wdt);\n\n\treturn devm_watchdog_register_device(dev, &wdt->wdtdev);\n}\n\n\nstatic const struct of_device_id rzn1_wdt_match[] = {\n\t{ .compatible = \"renesas,rzn1-wdt\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, rzn1_wdt_match);\n\nstatic struct platform_driver rzn1_wdt_driver = {\n\t.probe\t\t= rzn1_wdt_probe,\n\t.driver\t\t= {\n\t\t.name\t\t= KBUILD_MODNAME,\n\t\t.of_match_table\t= rzn1_wdt_match,\n\t},\n};\n\nmodule_platform_driver(rzn1_wdt_driver);\n\nMODULE_DESCRIPTION(\"Renesas RZ/N1 hardware watchdog\");\nMODULE_AUTHOR(\"Phil Edworthy <phil.edworthy@renesas.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}