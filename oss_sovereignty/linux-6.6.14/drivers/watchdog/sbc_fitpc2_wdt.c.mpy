{
  "module_name": "sbc_fitpc2_wdt.c",
  "hash_id": "c241e75fe25f84ff7874731df6a452739f6ef703ad6ee9760f9deee627331fea",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/sbc_fitpc2_wdt.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \" WATCHDOG: \" fmt\n\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/miscdevice.h>\n#include <linux/watchdog.h>\n#include <linux/ioport.h>\n#include <linux/delay.h>\n#include <linux/fs.h>\n#include <linux/init.h>\n#include <linux/moduleparam.h>\n#include <linux/dmi.h>\n#include <linux/io.h>\n#include <linux/uaccess.h>\n\n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nstatic unsigned int margin = 60;\t \nstatic unsigned long wdt_status;\nstatic DEFINE_MUTEX(wdt_lock);\n\n#define WDT_IN_USE\t\t0\n#define WDT_OK_TO_CLOSE\t\t1\n\n#define COMMAND_PORT\t\t0x4c\n#define DATA_PORT\t\t0x48\n\n#define IFACE_ON_COMMAND\t1\n#define REBOOT_COMMAND\t\t2\n\n#define WATCHDOG_NAME\t\t\"SBC-FITPC2 Watchdog\"\n\nstatic void wdt_send_data(unsigned char command, unsigned char data)\n{\n\toutb(data, DATA_PORT);\n\tmsleep(200);\n\toutb(command, COMMAND_PORT);\n\tmsleep(100);\n}\n\nstatic void wdt_enable(void)\n{\n\tmutex_lock(&wdt_lock);\n\twdt_send_data(IFACE_ON_COMMAND, 1);\n\twdt_send_data(REBOOT_COMMAND, margin);\n\tmutex_unlock(&wdt_lock);\n}\n\nstatic void wdt_disable(void)\n{\n\tmutex_lock(&wdt_lock);\n\twdt_send_data(IFACE_ON_COMMAND, 0);\n\twdt_send_data(REBOOT_COMMAND, 0);\n\tmutex_unlock(&wdt_lock);\n}\n\nstatic int fitpc2_wdt_open(struct inode *inode, struct file *file)\n{\n\tif (test_and_set_bit(WDT_IN_USE, &wdt_status))\n\t\treturn -EBUSY;\n\n\tclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\n\n\twdt_enable();\n\n\treturn stream_open(inode, file);\n}\n\nstatic ssize_t fitpc2_wdt_write(struct file *file, const char __user *data,\n\t\t\t\t\t\tsize_t len, loff_t *ppos)\n{\n\tsize_t i;\n\n\tif (!len)\n\t\treturn 0;\n\n\tif (nowayout) {\n\t\tlen = 0;\n\t\tgoto out;\n\t}\n\n\tclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\n\n\tfor (i = 0; i != len; i++) {\n\t\tchar c;\n\n\t\tif (get_user(c, data + i))\n\t\t\treturn -EFAULT;\n\n\t\tif (c == 'V')\n\t\t\tset_bit(WDT_OK_TO_CLOSE, &wdt_status);\n\t}\n\nout:\n\twdt_enable();\n\n\treturn len;\n}\n\n\nstatic const struct watchdog_info ident = {\n\t.options\t= WDIOF_MAGICCLOSE | WDIOF_SETTIMEOUT |\n\t\t\t\tWDIOF_KEEPALIVEPING,\n\t.identity\t= WATCHDOG_NAME,\n};\n\n\nstatic long fitpc2_wdt_ioctl(struct file *file, unsigned int cmd,\n\t\t\t\t\t\t\tunsigned long arg)\n{\n\tint ret = -ENOTTY;\n\tint time;\n\n\tswitch (cmd) {\n\tcase WDIOC_GETSUPPORT:\n\t\tret = copy_to_user((struct watchdog_info __user *)arg, &ident,\n\t\t\t\t   sizeof(ident)) ? -EFAULT : 0;\n\t\tbreak;\n\n\tcase WDIOC_GETSTATUS:\n\t\tret = put_user(0, (int __user *)arg);\n\t\tbreak;\n\n\tcase WDIOC_GETBOOTSTATUS:\n\t\tret = put_user(0, (int __user *)arg);\n\t\tbreak;\n\n\tcase WDIOC_KEEPALIVE:\n\t\twdt_enable();\n\t\tret = 0;\n\t\tbreak;\n\n\tcase WDIOC_SETTIMEOUT:\n\t\tret = get_user(time, (int __user *)arg);\n\t\tif (ret)\n\t\t\tbreak;\n\n\t\tif (time < 31 || time > 255) {\n\t\t\tret = -EINVAL;\n\t\t\tbreak;\n\t\t}\n\n\t\tmargin = time;\n\t\twdt_enable();\n\t\tfallthrough;\n\n\tcase WDIOC_GETTIMEOUT:\n\t\tret = put_user(margin, (int __user *)arg);\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic int fitpc2_wdt_release(struct inode *inode, struct file *file)\n{\n\tif (test_bit(WDT_OK_TO_CLOSE, &wdt_status)) {\n\t\twdt_disable();\n\t\tpr_info(\"Device disabled\\n\");\n\t} else {\n\t\tpr_warn(\"Device closed unexpectedly - timer will not stop\\n\");\n\t\twdt_enable();\n\t}\n\n\tclear_bit(WDT_IN_USE, &wdt_status);\n\tclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\n\n\treturn 0;\n}\n\n\nstatic const struct file_operations fitpc2_wdt_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.llseek\t\t= no_llseek,\n\t.write\t\t= fitpc2_wdt_write,\n\t.unlocked_ioctl\t= fitpc2_wdt_ioctl,\n\t.compat_ioctl\t= compat_ptr_ioctl,\n\t.open\t\t= fitpc2_wdt_open,\n\t.release\t= fitpc2_wdt_release,\n};\n\nstatic struct miscdevice fitpc2_wdt_miscdev = {\n\t.minor\t\t= WATCHDOG_MINOR,\n\t.name\t\t= \"watchdog\",\n\t.fops\t\t= &fitpc2_wdt_fops,\n};\n\nstatic int __init fitpc2_wdt_init(void)\n{\n\tint err;\n\tconst char *brd_name;\n\n\tbrd_name = dmi_get_system_info(DMI_BOARD_NAME);\n\n\tif (!brd_name || !strstr(brd_name, \"SBC-FITPC2\"))\n\t\treturn -ENODEV;\n\n\tpr_info(\"%s found\\n\", brd_name);\n\n\tif (!request_region(COMMAND_PORT, 1, WATCHDOG_NAME)) {\n\t\tpr_err(\"I/O address 0x%04x already in use\\n\", COMMAND_PORT);\n\t\treturn -EIO;\n\t}\n\n\tif (!request_region(DATA_PORT, 1, WATCHDOG_NAME)) {\n\t\tpr_err(\"I/O address 0x%04x already in use\\n\", DATA_PORT);\n\t\terr = -EIO;\n\t\tgoto err_data_port;\n\t}\n\n\tif (margin < 31 || margin > 255) {\n\t\tpr_err(\"margin must be in range 31 - 255 seconds, you tried to set %d\\n\",\n\t\t       margin);\n\t\terr = -EINVAL;\n\t\tgoto err_margin;\n\t}\n\n\terr = misc_register(&fitpc2_wdt_miscdev);\n\tif (err) {\n\t\tpr_err(\"cannot register miscdev on minor=%d (err=%d)\\n\",\n\t\t       WATCHDOG_MINOR, err);\n\t\tgoto err_margin;\n\t}\n\n\treturn 0;\n\nerr_margin:\n\trelease_region(DATA_PORT, 1);\nerr_data_port:\n\trelease_region(COMMAND_PORT, 1);\n\n\treturn err;\n}\n\nstatic void __exit fitpc2_wdt_exit(void)\n{\n\tmisc_deregister(&fitpc2_wdt_miscdev);\n\trelease_region(DATA_PORT, 1);\n\trelease_region(COMMAND_PORT, 1);\n}\n\nmodule_init(fitpc2_wdt_init);\nmodule_exit(fitpc2_wdt_exit);\n\nMODULE_AUTHOR(\"Denis Turischev <denis@compulab.co.il>\");\nMODULE_DESCRIPTION(\"SBC-FITPC2 Watchdog\");\n\nmodule_param(margin, int, 0);\nMODULE_PARM_DESC(margin, \"Watchdog margin in seconds (default 60s)\");\n\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout, \"Watchdog cannot be stopped once started\");\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}