{
  "module_name": "max77620_wdt.c",
  "hash_id": "4fbbabcfa69c21b4d3c19772dbfb8c53a4f8b8367c58823c7191146a2cdc6d39",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/max77620_wdt.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/mfd/max77620.h>\n#include <linux/mfd/max77714.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n#include <linux/watchdog.h>\n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\n\n \nstruct max77620_variant {\n\tu8 reg_onoff_cnfg2;\n\tu8 reg_cnfg_glbl2;\n\tu8 reg_cnfg_glbl3;\n\tu8 wdtc_mask;\n\tu8 bit_wd_rst_wk;\n\tu8 cnfg_glbl2_cfg_bits;\n};\n\nstruct max77620_wdt {\n\tstruct device\t\t\t*dev;\n\tstruct regmap\t\t\t*rmap;\n\tconst struct max77620_variant\t*drv_data;\n\tstruct watchdog_device\t\twdt_dev;\n};\n\nstatic const struct max77620_variant max77620_wdt_data = {\n\t.reg_onoff_cnfg2     = MAX77620_REG_ONOFFCNFG2,\n\t.reg_cnfg_glbl2      = MAX77620_REG_CNFGGLBL2,\n\t.reg_cnfg_glbl3      = MAX77620_REG_CNFGGLBL3,\n\t.wdtc_mask           = MAX77620_WDTC_MASK,\n\t.bit_wd_rst_wk       = MAX77620_ONOFFCNFG2_WD_RST_WK,\n\t \n\t.cnfg_glbl2_cfg_bits = MAX77620_WDTSLPC | MAX77620_WDTOFFC,\n};\n\nstatic const struct max77620_variant max77714_wdt_data = {\n\t.reg_onoff_cnfg2     = MAX77714_CNFG2_ONOFF,\n\t.reg_cnfg_glbl2      = MAX77714_CNFG_GLBL2,\n\t.reg_cnfg_glbl3      = MAX77714_CNFG_GLBL3,\n\t.wdtc_mask           = MAX77714_WDTC,\n\t.bit_wd_rst_wk       = MAX77714_WD_RST_WK,\n\t \n\t.cnfg_glbl2_cfg_bits = MAX77714_WDTSLPC,\n};\n\nstatic int max77620_wdt_start(struct watchdog_device *wdt_dev)\n{\n\tstruct max77620_wdt *wdt = watchdog_get_drvdata(wdt_dev);\n\n\treturn regmap_update_bits(wdt->rmap, wdt->drv_data->reg_cnfg_glbl2,\n\t\t\t\t  MAX77620_WDTEN, MAX77620_WDTEN);\n}\n\nstatic int max77620_wdt_stop(struct watchdog_device *wdt_dev)\n{\n\tstruct max77620_wdt *wdt = watchdog_get_drvdata(wdt_dev);\n\n\treturn regmap_update_bits(wdt->rmap, wdt->drv_data->reg_cnfg_glbl2,\n\t\t\t\t  MAX77620_WDTEN, 0);\n}\n\nstatic int max77620_wdt_ping(struct watchdog_device *wdt_dev)\n{\n\tstruct max77620_wdt *wdt = watchdog_get_drvdata(wdt_dev);\n\n\treturn regmap_update_bits(wdt->rmap, wdt->drv_data->reg_cnfg_glbl3,\n\t\t\t\t  wdt->drv_data->wdtc_mask, 0x1);\n}\n\nstatic int max77620_wdt_set_timeout(struct watchdog_device *wdt_dev,\n\t\t\t\t    unsigned int timeout)\n{\n\tstruct max77620_wdt *wdt = watchdog_get_drvdata(wdt_dev);\n\tunsigned int wdt_timeout;\n\tu8 regval;\n\tint ret;\n\n\tswitch (timeout) {\n\tcase 0 ... 2:\n\t\tregval = MAX77620_TWD_2s;\n\t\twdt_timeout = 2;\n\t\tbreak;\n\n\tcase 3 ... 16:\n\t\tregval = MAX77620_TWD_16s;\n\t\twdt_timeout = 16;\n\t\tbreak;\n\n\tcase 17 ... 64:\n\t\tregval = MAX77620_TWD_64s;\n\t\twdt_timeout = 64;\n\t\tbreak;\n\n\tdefault:\n\t\tregval = MAX77620_TWD_128s;\n\t\twdt_timeout = 128;\n\t\tbreak;\n\t}\n\n\t \n\tret = regmap_update_bits(wdt->rmap, wdt->drv_data->reg_cnfg_glbl3,\n\t\t\t\t wdt->drv_data->wdtc_mask, 0x1);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_update_bits(wdt->rmap, wdt->drv_data->reg_cnfg_glbl2,\n\t\t\t\t MAX77620_TWD_MASK, regval);\n\tif (ret < 0)\n\t\treturn ret;\n\n\twdt_dev->timeout = wdt_timeout;\n\n\treturn 0;\n}\n\nstatic const struct watchdog_info max77620_wdt_info = {\n\t.identity = \"max77620-watchdog\",\n\t.options = WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING | WDIOF_MAGICCLOSE,\n};\n\nstatic const struct watchdog_ops max77620_wdt_ops = {\n\t.start\t\t= max77620_wdt_start,\n\t.stop\t\t= max77620_wdt_stop,\n\t.ping\t\t= max77620_wdt_ping,\n\t.set_timeout\t= max77620_wdt_set_timeout,\n};\n\nstatic int max77620_wdt_probe(struct platform_device *pdev)\n{\n\tconst struct platform_device_id *id = platform_get_device_id(pdev);\n\tstruct device *dev = &pdev->dev;\n\tstruct max77620_wdt *wdt;\n\tstruct watchdog_device *wdt_dev;\n\tunsigned int regval;\n\tint ret;\n\n\twdt = devm_kzalloc(dev, sizeof(*wdt), GFP_KERNEL);\n\tif (!wdt)\n\t\treturn -ENOMEM;\n\n\twdt->dev = dev;\n\twdt->drv_data = (const struct max77620_variant *) id->driver_data;\n\n\twdt->rmap = dev_get_regmap(dev->parent, NULL);\n\tif (!wdt->rmap) {\n\t\tdev_err(wdt->dev, \"Failed to get parent regmap\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\twdt_dev = &wdt->wdt_dev;\n\twdt_dev->info = &max77620_wdt_info;\n\twdt_dev->ops = &max77620_wdt_ops;\n\twdt_dev->min_timeout = 2;\n\twdt_dev->max_timeout = 128;\n\twdt_dev->max_hw_heartbeat_ms = 128 * 1000;\n\n\tplatform_set_drvdata(pdev, wdt);\n\n\t \n\tret = regmap_update_bits(wdt->rmap, wdt->drv_data->reg_onoff_cnfg2,\n\t\t\t\t wdt->drv_data->bit_wd_rst_wk,\n\t\t\t\t wdt->drv_data->bit_wd_rst_wk);\n\tif (ret < 0) {\n\t\tdev_err(wdt->dev, \"Failed to set WD_RST_WK: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_update_bits(wdt->rmap, wdt->drv_data->reg_cnfg_glbl2,\n\t\t\t\t wdt->drv_data->cnfg_glbl2_cfg_bits,\n\t\t\t\t wdt->drv_data->cnfg_glbl2_cfg_bits);\n\tif (ret < 0) {\n\t\tdev_err(wdt->dev, \"Failed to set WDT OFF mode: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_read(wdt->rmap, wdt->drv_data->reg_cnfg_glbl2, &regval);\n\tif (ret < 0) {\n\t\tdev_err(wdt->dev, \"Failed to read WDT CFG register: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tswitch (regval & MAX77620_TWD_MASK) {\n\tcase MAX77620_TWD_2s:\n\t\twdt_dev->timeout = 2;\n\t\tbreak;\n\tcase MAX77620_TWD_16s:\n\t\twdt_dev->timeout = 16;\n\t\tbreak;\n\tcase MAX77620_TWD_64s:\n\t\twdt_dev->timeout = 64;\n\t\tbreak;\n\tdefault:\n\t\twdt_dev->timeout = 128;\n\t\tbreak;\n\t}\n\n\tif (regval & MAX77620_WDTEN)\n\t\tset_bit(WDOG_HW_RUNNING, &wdt_dev->status);\n\n\twatchdog_set_nowayout(wdt_dev, nowayout);\n\twatchdog_set_drvdata(wdt_dev, wdt);\n\n\twatchdog_stop_on_unregister(wdt_dev);\n\treturn devm_watchdog_register_device(dev, wdt_dev);\n}\n\nstatic const struct platform_device_id max77620_wdt_devtype[] = {\n\t{ \"max77620-watchdog\", (kernel_ulong_t)&max77620_wdt_data },\n\t{ \"max77714-watchdog\", (kernel_ulong_t)&max77714_wdt_data },\n\t{ },\n};\nMODULE_DEVICE_TABLE(platform, max77620_wdt_devtype);\n\nstatic struct platform_driver max77620_wdt_driver = {\n\t.driver\t= {\n\t\t.name\t= \"max77620-watchdog\",\n\t},\n\t.probe\t= max77620_wdt_probe,\n\t.id_table = max77620_wdt_devtype,\n};\n\nmodule_platform_driver(max77620_wdt_driver);\n\nMODULE_DESCRIPTION(\"Max77620 watchdog timer driver\");\n\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout, \"Watchdog cannot be stopped once started \"\n\t\"(default=\" __MODULE_STRING(WATCHDOG_NOWAYOUT) \")\");\n\nMODULE_AUTHOR(\"Laxman Dewangan <ldewangan@nvidia.com>\");\nMODULE_AUTHOR(\"Luca Ceresoli <luca.ceresoli@bootlin.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}