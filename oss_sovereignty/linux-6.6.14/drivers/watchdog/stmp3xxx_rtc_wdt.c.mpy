{
  "module_name": "stmp3xxx_rtc_wdt.c",
  "hash_id": "949b4ee7abc28c154931e7dcb44395fdae4a3a58e77a38a5f6e4064465f69225",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/stmp3xxx_rtc_wdt.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/watchdog.h>\n#include <linux/platform_device.h>\n#include <linux/stmp3xxx_rtc_wdt.h>\n#include <linux/notifier.h>\n#include <linux/reboot.h>\n\n#define WDOG_TICK_RATE 1000  \n#define STMP3XXX_DEFAULT_TIMEOUT 19\n#define STMP3XXX_MAX_TIMEOUT (UINT_MAX / WDOG_TICK_RATE)\n\nstatic int heartbeat = STMP3XXX_DEFAULT_TIMEOUT;\nmodule_param(heartbeat, uint, 0);\nMODULE_PARM_DESC(heartbeat, \"Watchdog heartbeat period in seconds from 1 to \"\n\t\t __MODULE_STRING(STMP3XXX_MAX_TIMEOUT) \", default \"\n\t\t __MODULE_STRING(STMP3XXX_DEFAULT_TIMEOUT));\n\nstatic int wdt_start(struct watchdog_device *wdd)\n{\n\tstruct device *dev = watchdog_get_drvdata(wdd);\n\tstruct stmp3xxx_wdt_pdata *pdata = dev_get_platdata(dev);\n\n\tpdata->wdt_set_timeout(dev->parent, wdd->timeout * WDOG_TICK_RATE);\n\treturn 0;\n}\n\nstatic int wdt_stop(struct watchdog_device *wdd)\n{\n\tstruct device *dev = watchdog_get_drvdata(wdd);\n\tstruct stmp3xxx_wdt_pdata *pdata = dev_get_platdata(dev);\n\n\tpdata->wdt_set_timeout(dev->parent, 0);\n\treturn 0;\n}\n\nstatic int wdt_set_timeout(struct watchdog_device *wdd, unsigned new_timeout)\n{\n\twdd->timeout = new_timeout;\n\treturn wdt_start(wdd);\n}\n\nstatic const struct watchdog_info stmp3xxx_wdt_ident = {\n\t.options = WDIOF_MAGICCLOSE | WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING,\n\t.identity = \"STMP3XXX RTC Watchdog\",\n};\n\nstatic const struct watchdog_ops stmp3xxx_wdt_ops = {\n\t.owner = THIS_MODULE,\n\t.start = wdt_start,\n\t.stop = wdt_stop,\n\t.set_timeout = wdt_set_timeout,\n};\n\nstatic struct watchdog_device stmp3xxx_wdd = {\n\t.info = &stmp3xxx_wdt_ident,\n\t.ops = &stmp3xxx_wdt_ops,\n\t.min_timeout = 1,\n\t.max_timeout = STMP3XXX_MAX_TIMEOUT,\n\t.status = WATCHDOG_NOWAYOUT_INIT_STATUS,\n};\n\nstatic int wdt_notify_sys(struct notifier_block *nb, unsigned long code,\n\t\t\t  void *unused)\n{\n\tswitch (code) {\n\tcase SYS_DOWN:\t \n\t\tbreak;\n\tcase SYS_HALT:\t \n\tcase SYS_POWER_OFF:\n\t\twdt_stop(&stmp3xxx_wdd);\n\t\tbreak;\n\t}\n\n\treturn NOTIFY_DONE;\n}\n\nstatic struct notifier_block wdt_notifier = {\n\t.notifier_call = wdt_notify_sys,\n};\n\nstatic int stmp3xxx_wdt_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tint ret;\n\n\twatchdog_set_drvdata(&stmp3xxx_wdd, dev);\n\n\tstmp3xxx_wdd.timeout = clamp_t(unsigned, heartbeat, 1, STMP3XXX_MAX_TIMEOUT);\n\tstmp3xxx_wdd.parent = dev;\n\n\tret = devm_watchdog_register_device(dev, &stmp3xxx_wdd);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (register_reboot_notifier(&wdt_notifier))\n\t\tdev_warn(dev, \"cannot register reboot notifier\\n\");\n\n\tdev_info(dev, \"initialized watchdog with heartbeat %ds\\n\",\n\t\t stmp3xxx_wdd.timeout);\n\treturn 0;\n}\n\nstatic void stmp3xxx_wdt_remove(struct platform_device *pdev)\n{\n\tunregister_reboot_notifier(&wdt_notifier);\n}\n\nstatic int __maybe_unused stmp3xxx_wdt_suspend(struct device *dev)\n{\n\tstruct watchdog_device *wdd = &stmp3xxx_wdd;\n\n\tif (watchdog_active(wdd))\n\t\treturn wdt_stop(wdd);\n\n\treturn 0;\n}\n\nstatic int __maybe_unused stmp3xxx_wdt_resume(struct device *dev)\n{\n\tstruct watchdog_device *wdd = &stmp3xxx_wdd;\n\n\tif (watchdog_active(wdd))\n\t\treturn wdt_start(wdd);\n\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(stmp3xxx_wdt_pm_ops,\n\t\t\t stmp3xxx_wdt_suspend, stmp3xxx_wdt_resume);\n\nstatic struct platform_driver stmp3xxx_wdt_driver = {\n\t.driver = {\n\t\t.name = \"stmp3xxx_rtc_wdt\",\n\t\t.pm = &stmp3xxx_wdt_pm_ops,\n\t},\n\t.probe = stmp3xxx_wdt_probe,\n\t.remove_new = stmp3xxx_wdt_remove,\n};\nmodule_platform_driver(stmp3xxx_wdt_driver);\n\nMODULE_DESCRIPTION(\"STMP3XXX RTC Watchdog Driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Wolfram Sang <kernel@pengutronix.de>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}