{
  "module_name": "ts72xx_wdt.c",
  "hash_id": "67b87506a44263a4063a2a9c4fbcf6cdcf7dc9c6ed5e702a6c3fe0c85e67a3ad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/ts72xx_wdt.c",
  "human_readable_source": "\n \n\n#include <linux/platform_device.h>\n#include <linux/module.h>\n#include <linux/watchdog.h>\n#include <linux/io.h>\n\n#define TS72XX_WDT_DEFAULT_TIMEOUT\t30\n\nstatic int timeout;\nmodule_param(timeout, int, 0);\nMODULE_PARM_DESC(timeout, \"Watchdog timeout in seconds.\");\n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout, \"Disable watchdog shutdown on close\");\n\n \n#define TS72XX_WDT_CTRL_DISABLE\t\t0x00\n#define TS72XX_WDT_CTRL_250MS\t\t0x01\n#define TS72XX_WDT_CTRL_500MS\t\t0x02\n#define TS72XX_WDT_CTRL_1SEC\t\t0x03\n#define TS72XX_WDT_CTRL_RESERVED\t0x04\n#define TS72XX_WDT_CTRL_2SEC\t\t0x05\n#define TS72XX_WDT_CTRL_4SEC\t\t0x06\n#define TS72XX_WDT_CTRL_8SEC\t\t0x07\n\n \n#define TS72XX_WDT_FEED_VAL\t\t0x05\n\nstruct ts72xx_wdt_priv {\n\tvoid __iomem\t*control_reg;\n\tvoid __iomem\t*feed_reg;\n\tstruct watchdog_device wdd;\n\tunsigned char regval;\n};\n\nstatic int ts72xx_wdt_start(struct watchdog_device *wdd)\n{\n\tstruct ts72xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\n\n\twriteb(TS72XX_WDT_FEED_VAL, priv->feed_reg);\n\twriteb(priv->regval, priv->control_reg);\n\n\treturn 0;\n}\n\nstatic int ts72xx_wdt_stop(struct watchdog_device *wdd)\n{\n\tstruct ts72xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\n\n\twriteb(TS72XX_WDT_FEED_VAL, priv->feed_reg);\n\twriteb(TS72XX_WDT_CTRL_DISABLE, priv->control_reg);\n\n\treturn 0;\n}\n\nstatic int ts72xx_wdt_ping(struct watchdog_device *wdd)\n{\n\tstruct ts72xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\n\n\twriteb(TS72XX_WDT_FEED_VAL, priv->feed_reg);\n\n\treturn 0;\n}\n\nstatic int ts72xx_wdt_settimeout(struct watchdog_device *wdd, unsigned int to)\n{\n\tstruct ts72xx_wdt_priv *priv = watchdog_get_drvdata(wdd);\n\n\tif (to == 1) {\n\t\tpriv->regval = TS72XX_WDT_CTRL_1SEC;\n\t} else if (to == 2) {\n\t\tpriv->regval = TS72XX_WDT_CTRL_2SEC;\n\t} else if (to <= 4) {\n\t\tpriv->regval = TS72XX_WDT_CTRL_4SEC;\n\t\tto = 4;\n\t} else {\n\t\tpriv->regval = TS72XX_WDT_CTRL_8SEC;\n\t\tif (to <= 8)\n\t\t\tto = 8;\n\t}\n\n\twdd->timeout = to;\n\n\tif (watchdog_active(wdd)) {\n\t\tts72xx_wdt_stop(wdd);\n\t\tts72xx_wdt_start(wdd);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct watchdog_info ts72xx_wdt_ident = {\n\t.options\t\t= WDIOF_KEEPALIVEPING |\n\t\t\t\t  WDIOF_SETTIMEOUT |\n\t\t\t\t  WDIOF_MAGICCLOSE,\n\t.firmware_version\t= 1,\n\t.identity\t\t= \"TS-72XX WDT\",\n};\n\nstatic const struct watchdog_ops ts72xx_wdt_ops = {\n\t.owner\t\t= THIS_MODULE,\n\t.start\t\t= ts72xx_wdt_start,\n\t.stop\t\t= ts72xx_wdt_stop,\n\t.ping\t\t= ts72xx_wdt_ping,\n\t.set_timeout\t= ts72xx_wdt_settimeout,\n};\n\nstatic int ts72xx_wdt_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct ts72xx_wdt_priv *priv;\n\tstruct watchdog_device *wdd;\n\tint ret;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->control_reg = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(priv->control_reg))\n\t\treturn PTR_ERR(priv->control_reg);\n\n\tpriv->feed_reg = devm_platform_ioremap_resource(pdev, 1);\n\tif (IS_ERR(priv->feed_reg))\n\t\treturn PTR_ERR(priv->feed_reg);\n\n\twdd = &priv->wdd;\n\twdd->info = &ts72xx_wdt_ident;\n\twdd->ops = &ts72xx_wdt_ops;\n\twdd->min_timeout = 1;\n\twdd->max_hw_heartbeat_ms = 8000;\n\twdd->parent = dev;\n\n\twatchdog_set_nowayout(wdd, nowayout);\n\n\twdd->timeout = TS72XX_WDT_DEFAULT_TIMEOUT;\n\twatchdog_init_timeout(wdd, timeout, dev);\n\n\twatchdog_set_drvdata(wdd, priv);\n\n\tret = devm_watchdog_register_device(dev, wdd);\n\tif (ret)\n\t\treturn ret;\n\n\tdev_info(dev, \"TS-72xx Watchdog driver\\n\");\n\n\treturn 0;\n}\n\nstatic struct platform_driver ts72xx_wdt_driver = {\n\t.probe\t\t= ts72xx_wdt_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"ts72xx-wdt\",\n\t},\n};\n\nmodule_platform_driver(ts72xx_wdt_driver);\n\nMODULE_AUTHOR(\"Mika Westerberg <mika.westerberg@iki.fi>\");\nMODULE_DESCRIPTION(\"TS-72xx SBC Watchdog\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:ts72xx-wdt\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}