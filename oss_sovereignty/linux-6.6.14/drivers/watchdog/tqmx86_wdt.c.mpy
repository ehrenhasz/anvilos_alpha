{
  "module_name": "tqmx86_wdt.c",
  "hash_id": "1f3937e11e6d1f1de4f72d8687750249142024c1efa03f8c2cc7e3bc458fcc6b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/tqmx86_wdt.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/log2.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/timer.h>\n#include <linux/watchdog.h>\n\n \n#define WDT_TIMEOUT 32\n\nstatic unsigned int timeout;\nmodule_param(timeout, uint, 0);\nMODULE_PARM_DESC(timeout,\n\t\"Watchdog timeout in seconds. (1<=timeout<=4096, default=\"\n\t\t\t\t__MODULE_STRING(WDT_TIMEOUT) \")\");\nstruct tqmx86_wdt {\n\tstruct watchdog_device wdd;\n\tvoid __iomem *io_base;\n};\n\n#define TQMX86_WDCFG\t0x00  \n#define TQMX86_WDCS\t0x01  \n\nstatic int tqmx86_wdt_start(struct watchdog_device *wdd)\n{\n\tstruct tqmx86_wdt *priv = watchdog_get_drvdata(wdd);\n\n\tiowrite8(0x81, priv->io_base + TQMX86_WDCS);\n\n\treturn 0;\n}\n\nstatic int tqmx86_wdt_set_timeout(struct watchdog_device *wdd, unsigned int t)\n{\n\tstruct tqmx86_wdt *priv = watchdog_get_drvdata(wdd);\n\tu8 val;\n\n\tt = roundup_pow_of_two(t);\n\tval = ilog2(t) | 0x90;\n\tval += 3;  \n\tiowrite8(val, priv->io_base + TQMX86_WDCFG);\n\n\twdd->timeout = t;\n\n\treturn 0;\n}\n\nstatic const struct watchdog_info tqmx86_wdt_info = {\n\t.options\t= WDIOF_SETTIMEOUT |\n\t\t\t  WDIOF_KEEPALIVEPING,\n\t.identity\t= \"TQMx86 Watchdog\",\n};\n\nstatic const struct watchdog_ops tqmx86_wdt_ops = {\n\t.owner\t\t= THIS_MODULE,\n\t.start\t\t= tqmx86_wdt_start,\n\t.set_timeout\t= tqmx86_wdt_set_timeout,\n};\n\nstatic int tqmx86_wdt_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct tqmx86_wdt *priv;\n\tstruct resource *res;\n\tint err;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tres = platform_get_resource(pdev, IORESOURCE_IO, 0);\n\tif (!res)\n\t\treturn -ENODEV;\n\n\tpriv->io_base = devm_ioport_map(dev, res->start, resource_size(res));\n\tif (!priv->io_base)\n\t\treturn -ENOMEM;\n\n\twatchdog_set_drvdata(&priv->wdd, priv);\n\n\tpriv->wdd.parent = dev;\n\tpriv->wdd.info = &tqmx86_wdt_info;\n\tpriv->wdd.ops = &tqmx86_wdt_ops;\n\tpriv->wdd.min_timeout = 1;\n\tpriv->wdd.max_timeout = 4096;\n\tpriv->wdd.max_hw_heartbeat_ms = 4096*1000;\n\tpriv->wdd.timeout = WDT_TIMEOUT;\n\n\twatchdog_init_timeout(&priv->wdd, timeout, dev);\n\twatchdog_set_nowayout(&priv->wdd, WATCHDOG_NOWAYOUT);\n\n\ttqmx86_wdt_set_timeout(&priv->wdd, priv->wdd.timeout);\n\n\terr = devm_watchdog_register_device(dev, &priv->wdd);\n\tif (err)\n\t\treturn err;\n\n\tdev_info(dev, \"TQMx86 watchdog\\n\");\n\n\treturn 0;\n}\n\nstatic struct platform_driver tqmx86_wdt_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"tqmx86-wdt\",\n\t},\n\t.probe\t\t= tqmx86_wdt_probe,\n};\n\nmodule_platform_driver(tqmx86_wdt_driver);\n\nMODULE_AUTHOR(\"Andrew Lunn <andrew@lunn.ch>\");\nMODULE_DESCRIPTION(\"TQMx86 Watchdog\");\nMODULE_ALIAS(\"platform:tqmx86-wdt\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}