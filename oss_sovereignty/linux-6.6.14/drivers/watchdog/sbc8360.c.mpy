{
  "module_name": "sbc8360.c",
  "hash_id": "969501731f046b9f8767206e6679d4630f3be7a9a7a23aff078579d0606bb493",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/sbc8360.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/miscdevice.h>\n#include <linux/watchdog.h>\n#include <linux/ioport.h>\n#include <linux/delay.h>\n#include <linux/notifier.h>\n#include <linux/fs.h>\n#include <linux/reboot.h>\n#include <linux/init.h>\n#include <linux/spinlock.h>\n#include <linux/moduleparam.h>\n#include <linux/io.h>\n#include <linux/uaccess.h>\n\n\nstatic unsigned long sbc8360_is_open;\nstatic char expect_close;\n\n \n\nstatic int wd_times[64][2] = {\n\t{0, 1},\t\t\t \n\t{1, 1},\t\t\t \n\t{2, 1},\t\t\t \n\t{3, 1},\t\t\t \n\t{4, 1},\t\t\t \n\t{5, 1},\t\t\t \n\t{6, 1},\t\t\t \n\t{7, 1},\t\t\t \n\t{8, 1},\t\t\t \n\t{9, 1},\t\t\t \n\t{0xA, 1},\t\t \n\t{0xB, 1},\t\t \n\t{0xC, 1},\t\t \n\t{0xD, 1},\t\t \n\t{0xE, 1},\t\t \n\t{0xF, 1},\t\t \n\t{0, 2},\t\t\t \n\t{1, 2},\t\t\t \n\t{2, 2},\t\t\t \n\t{3, 2},\t\t\t \n\t{4, 2},\t\t\t \n\t{5, 2},\t\t\t \n\t{6, 2},\t\t\t \n\t{7, 2},\t\t\t \n\t{8, 2},\t\t\t \n\t{9, 2},\t\t\t \n\t{0xA, 2},\t\t \n\t{0xB, 2},\t\t \n\t{0xC, 2},\t\t \n\t{0xD, 2},\t\t \n\t{0xE, 2},\t\t \n\t{0xF, 2},\t\t \n\t{0, 3},\t\t\t \n\t{1, 3},\t\t\t \n\t{2, 3},\t\t\t \n\t{3, 3},\t\t\t \n\t{4, 3},\t\t\t \n\t{5, 3},\t\t\t \n\t{6, 3},\t\t\t \n\t{7, 3},\t\t\t \n\t{8, 3},\t\t\t \n\t{9, 3},\t\t\t \n\t{0xA, 3},\t\t \n\t{0xB, 3},\t\t \n\t{0xC, 3},\t\t \n\t{0xD, 3},\t\t \n\t{0xE, 3},\t\t \n\t{0xF, 3},\t\t \n\t{0, 4},\t\t\t \n\t{1, 4},\t\t\t \n\t{2, 4},\t\t\t \n\t{3, 4},\t\t\t \n\t{4, 4},\t\t\t \n\t{5, 4},\t\t\t \n\t{6, 4},\t\t\t \n\t{7, 4},\t\t\t \n\t{8, 4},\t\t\t \n\t{9, 4},\t\t\t \n\t{0xA, 4},\t\t \n\t{0xB, 4},\t\t \n\t{0xC, 4},\t\t \n\t{0xD, 4},\t\t \n\t{0xE, 4},\t\t \n\t{0xF, 4}\t\t \n};\n\n#define SBC8360_ENABLE 0x120\n#define SBC8360_BASETIME 0x121\n\nstatic int timeout = 27;\nstatic int wd_margin = 0xB;\nstatic int wd_multiplier = 2;\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\n\nmodule_param(timeout, int, 0);\nMODULE_PARM_DESC(timeout, \"Index into timeout table (0-63) (default=27 (60s))\");\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout,\n\t\t \"Watchdog cannot be stopped once started (default=\"\n\t\t\t\t__MODULE_STRING(WATCHDOG_NOWAYOUT) \")\");\n\n \n\n \nstatic void sbc8360_activate(void)\n{\n\t \n\toutb(0x0A, SBC8360_ENABLE);\n\tmsleep_interruptible(100);\n\toutb(0x0B, SBC8360_ENABLE);\n\tmsleep_interruptible(100);\n\t \n\toutb(wd_multiplier, SBC8360_ENABLE);\n\tmsleep_interruptible(100);\n\t \n}\n\n \nstatic void sbc8360_ping(void)\n{\n\t \n\toutb(wd_margin, SBC8360_BASETIME);\n}\n\n \nstatic void sbc8360_stop(void)\n{\n\t \n\toutb(0, SBC8360_ENABLE);\n}\n\n \nstatic ssize_t sbc8360_write(struct file *file, const char __user *buf,\n\t\t\t     size_t count, loff_t *ppos)\n{\n\tif (count) {\n\t\tif (!nowayout) {\n\t\t\tsize_t i;\n\n\t\t\t \n\t\t\texpect_close = 0;\n\n\t\t\tfor (i = 0; i != count; i++) {\n\t\t\t\tchar c;\n\t\t\t\tif (get_user(c, buf + i))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tif (c == 'V')\n\t\t\t\t\texpect_close = 42;\n\t\t\t}\n\t\t}\n\t\tsbc8360_ping();\n\t}\n\treturn count;\n}\n\nstatic int sbc8360_open(struct inode *inode, struct file *file)\n{\n\tif (test_and_set_bit(0, &sbc8360_is_open))\n\t\treturn -EBUSY;\n\tif (nowayout)\n\t\t__module_get(THIS_MODULE);\n\n\t \n\tsbc8360_activate();\n\tsbc8360_ping();\n\treturn stream_open(inode, file);\n}\n\nstatic int sbc8360_close(struct inode *inode, struct file *file)\n{\n\tif (expect_close == 42)\n\t\tsbc8360_stop();\n\telse\n\t\tpr_crit(\"SBC8360 device closed unexpectedly.  SBC8360 will not stop!\\n\");\n\n\tclear_bit(0, &sbc8360_is_open);\n\texpect_close = 0;\n\treturn 0;\n}\n\n \n\nstatic int sbc8360_notify_sys(struct notifier_block *this, unsigned long code,\n\t\t\t      void *unused)\n{\n\tif (code == SYS_DOWN || code == SYS_HALT)\n\t\tsbc8360_stop();\t \n\n\treturn NOTIFY_DONE;\n}\n\n \n\nstatic const struct file_operations sbc8360_fops = {\n\t.owner = THIS_MODULE,\n\t.llseek = no_llseek,\n\t.write = sbc8360_write,\n\t.open = sbc8360_open,\n\t.release = sbc8360_close,\n};\n\nstatic struct miscdevice sbc8360_miscdev = {\n\t.minor = WATCHDOG_MINOR,\n\t.name = \"watchdog\",\n\t.fops = &sbc8360_fops,\n};\n\n \n\nstatic struct notifier_block sbc8360_notifier = {\n\t.notifier_call = sbc8360_notify_sys,\n};\n\nstatic int __init sbc8360_init(void)\n{\n\tint res;\n\tunsigned long int mseconds = 60000;\n\n\tif (timeout < 0 || timeout > 63) {\n\t\tpr_err(\"Invalid timeout index (must be 0-63)\\n\");\n\t\tres = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tif (!request_region(SBC8360_ENABLE, 1, \"SBC8360\")) {\n\t\tpr_err(\"ENABLE method I/O %X is not available\\n\",\n\t\t       SBC8360_ENABLE);\n\t\tres = -EIO;\n\t\tgoto out;\n\t}\n\tif (!request_region(SBC8360_BASETIME, 1, \"SBC8360\")) {\n\t\tpr_err(\"BASETIME method I/O %X is not available\\n\",\n\t\t       SBC8360_BASETIME);\n\t\tres = -EIO;\n\t\tgoto out_nobasetimereg;\n\t}\n\n\tres = register_reboot_notifier(&sbc8360_notifier);\n\tif (res) {\n\t\tpr_err(\"Failed to register reboot notifier\\n\");\n\t\tgoto out_noreboot;\n\t}\n\n\tres = misc_register(&sbc8360_miscdev);\n\tif (res) {\n\t\tpr_err(\"failed to register misc device\\n\");\n\t\tgoto out_nomisc;\n\t}\n\n\twd_margin = wd_times[timeout][0];\n\twd_multiplier = wd_times[timeout][1];\n\n\tif (wd_multiplier == 1)\n\t\tmseconds = (wd_margin + 1) * 500;\n\telse if (wd_multiplier == 2)\n\t\tmseconds = (wd_margin + 1) * 5000;\n\telse if (wd_multiplier == 3)\n\t\tmseconds = (wd_margin + 1) * 50000;\n\telse if (wd_multiplier == 4)\n\t\tmseconds = (wd_margin + 1) * 100000;\n\n\t \n\tpr_info(\"Timeout set at %ld ms\\n\", mseconds);\n\n\treturn 0;\n\nout_nomisc:\n\tunregister_reboot_notifier(&sbc8360_notifier);\nout_noreboot:\n\trelease_region(SBC8360_BASETIME, 1);\nout_nobasetimereg:\n\trelease_region(SBC8360_ENABLE, 1);\nout:\n\treturn res;\n}\n\nstatic void __exit sbc8360_exit(void)\n{\n\tmisc_deregister(&sbc8360_miscdev);\n\tunregister_reboot_notifier(&sbc8360_notifier);\n\trelease_region(SBC8360_ENABLE, 1);\n\trelease_region(SBC8360_BASETIME, 1);\n}\n\nmodule_init(sbc8360_init);\nmodule_exit(sbc8360_exit);\n\nMODULE_AUTHOR(\"Ian E. Morgan <imorgan@webcon.ca>\");\nMODULE_DESCRIPTION(\"SBC8360 watchdog driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_VERSION(\"1.01\");\n\n \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}