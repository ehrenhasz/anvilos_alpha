{
  "module_name": "loongson1_wdt.c",
  "hash_id": "29e2832104de60dfc100c3f4aa280f93b9bb533aa7b8e3597abad8f0fc8c4792",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/loongson1_wdt.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/watchdog.h>\n\n \n#define WDT_EN\t\t\t0x0\n#define WDT_TIMER\t\t0x4\n#define WDT_SET\t\t\t0x8\n\n#define DEFAULT_HEARTBEAT\t30\n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nmodule_param(nowayout, bool, 0444);\n\nstatic unsigned int heartbeat;\nmodule_param(heartbeat, uint, 0444);\n\nstruct ls1x_wdt_drvdata {\n\tvoid __iomem *base;\n\tstruct clk *clk;\n\tunsigned long clk_rate;\n\tstruct watchdog_device wdt;\n};\n\nstatic int ls1x_wdt_ping(struct watchdog_device *wdt_dev)\n{\n\tstruct ls1x_wdt_drvdata *drvdata = watchdog_get_drvdata(wdt_dev);\n\n\twritel(0x1, drvdata->base + WDT_SET);\n\n\treturn 0;\n}\n\nstatic int ls1x_wdt_set_timeout(struct watchdog_device *wdt_dev,\n\t\t\t\tunsigned int timeout)\n{\n\tstruct ls1x_wdt_drvdata *drvdata = watchdog_get_drvdata(wdt_dev);\n\tunsigned int max_hw_heartbeat = wdt_dev->max_hw_heartbeat_ms / 1000;\n\tunsigned int counts;\n\n\twdt_dev->timeout = timeout;\n\n\tcounts = drvdata->clk_rate * min(timeout, max_hw_heartbeat);\n\twritel(counts, drvdata->base + WDT_TIMER);\n\n\treturn 0;\n}\n\nstatic int ls1x_wdt_start(struct watchdog_device *wdt_dev)\n{\n\tstruct ls1x_wdt_drvdata *drvdata = watchdog_get_drvdata(wdt_dev);\n\n\twritel(0x1, drvdata->base + WDT_EN);\n\n\treturn 0;\n}\n\nstatic int ls1x_wdt_stop(struct watchdog_device *wdt_dev)\n{\n\tstruct ls1x_wdt_drvdata *drvdata = watchdog_get_drvdata(wdt_dev);\n\n\twritel(0x0, drvdata->base + WDT_EN);\n\n\treturn 0;\n}\n\nstatic int ls1x_wdt_restart(struct watchdog_device *wdt_dev,\n\t\t\t    unsigned long action, void *data)\n{\n\tstruct ls1x_wdt_drvdata *drvdata = watchdog_get_drvdata(wdt_dev);\n\n\twritel(0x1, drvdata->base + WDT_EN);\n\twritel(0x1, drvdata->base + WDT_TIMER);\n\twritel(0x1, drvdata->base + WDT_SET);\n\n\treturn 0;\n}\n\nstatic const struct watchdog_info ls1x_wdt_info = {\n\t.options = WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING | WDIOF_MAGICCLOSE,\n\t.identity = \"Loongson1 Watchdog\",\n};\n\nstatic const struct watchdog_ops ls1x_wdt_ops = {\n\t.owner = THIS_MODULE,\n\t.start = ls1x_wdt_start,\n\t.stop = ls1x_wdt_stop,\n\t.ping = ls1x_wdt_ping,\n\t.set_timeout = ls1x_wdt_set_timeout,\n\t.restart = ls1x_wdt_restart,\n};\n\nstatic int ls1x_wdt_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct ls1x_wdt_drvdata *drvdata;\n\tstruct watchdog_device *ls1x_wdt;\n\tunsigned long clk_rate;\n\tint err;\n\n\tdrvdata = devm_kzalloc(dev, sizeof(*drvdata), GFP_KERNEL);\n\tif (!drvdata)\n\t\treturn -ENOMEM;\n\n\tdrvdata->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(drvdata->base))\n\t\treturn PTR_ERR(drvdata->base);\n\n\tdrvdata->clk = devm_clk_get_enabled(dev, NULL);\n\tif (IS_ERR(drvdata->clk))\n\t\treturn PTR_ERR(drvdata->clk);\n\n\tclk_rate = clk_get_rate(drvdata->clk);\n\tif (!clk_rate)\n\t\treturn -EINVAL;\n\tdrvdata->clk_rate = clk_rate;\n\n\tls1x_wdt = &drvdata->wdt;\n\tls1x_wdt->info = &ls1x_wdt_info;\n\tls1x_wdt->ops = &ls1x_wdt_ops;\n\tls1x_wdt->timeout = DEFAULT_HEARTBEAT;\n\tls1x_wdt->min_timeout = 1;\n\tls1x_wdt->max_hw_heartbeat_ms = U32_MAX / clk_rate * 1000;\n\tls1x_wdt->parent = dev;\n\n\twatchdog_init_timeout(ls1x_wdt, heartbeat, dev);\n\twatchdog_set_nowayout(ls1x_wdt, nowayout);\n\twatchdog_set_drvdata(ls1x_wdt, drvdata);\n\n\terr = devm_watchdog_register_device(dev, &drvdata->wdt);\n\tif (err)\n\t\treturn err;\n\n\tplatform_set_drvdata(pdev, drvdata);\n\n\tdev_info(dev, \"Loongson1 Watchdog driver registered\\n\");\n\n\treturn 0;\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id ls1x_wdt_dt_ids[] = {\n\t{ .compatible = \"loongson,ls1b-wdt\", },\n\t{ .compatible = \"loongson,ls1c-wdt\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, ls1x_wdt_dt_ids);\n#endif\n\nstatic struct platform_driver ls1x_wdt_driver = {\n\t.probe = ls1x_wdt_probe,\n\t.driver = {\n\t\t.name = \"ls1x-wdt\",\n\t\t.of_match_table = of_match_ptr(ls1x_wdt_dt_ids),\n\t},\n};\n\nmodule_platform_driver(ls1x_wdt_driver);\n\nMODULE_AUTHOR(\"Yang Ling <gnaygnil@gmail.com>\");\nMODULE_DESCRIPTION(\"Loongson1 Watchdog Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}