{
  "module_name": "booke_wdt.c",
  "hash_id": "912526ded554fb9c01b97f1182fdd77bb2a38cdeef6cf29afae102fa01bdd78b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/booke_wdt.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/smp.h>\n#include <linux/watchdog.h>\n\n#include <asm/reg_booke.h>\n#include <asm/time.h>\n#include <asm/div64.h>\n\n \n\n\n#ifdef\tCONFIG_PPC_E500\n#define WDTP(x)\t\t((((x)&0x3)<<30)|(((x)&0x3c)<<15))\n#define WDTP_MASK\t(WDTP(0x3f))\n#else\n#define WDTP(x)\t\t(TCR_WP(x))\n#define WDTP_MASK\t(TCR_WP_MASK)\n#endif\n\nstatic bool booke_wdt_enabled;\nmodule_param(booke_wdt_enabled, bool, 0);\nstatic int  booke_wdt_period = CONFIG_BOOKE_WDT_DEFAULT_TIMEOUT;\nmodule_param(booke_wdt_period, int, 0);\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout,\n\t\t\"Watchdog cannot be stopped once started (default=\"\n\t\t\t\t__MODULE_STRING(WATCHDOG_NOWAYOUT) \")\");\n\n#ifdef CONFIG_PPC_E500\n\n \nstatic unsigned long long period_to_sec(unsigned int period)\n{\n\tunsigned long long tmp = 1ULL << (64 - period);\n\tunsigned long tmp2 = ppc_tb_freq;\n\n\t \n\ttmp2 = tmp2 / 5 * 2;\n\n\tdo_div(tmp, tmp2);\n\treturn tmp;\n}\n\n \nstatic unsigned int sec_to_period(unsigned int secs)\n{\n\tunsigned int period;\n\tfor (period = 63; period > 0; period--) {\n\t\tif (period_to_sec(period) >= secs)\n\t\t\treturn period;\n\t}\n\treturn 0;\n}\n\n#define MAX_WDT_TIMEOUT\t\tperiod_to_sec(1)\n\n#else  \n\nstatic unsigned long long period_to_sec(unsigned int period)\n{\n\treturn period;\n}\n\nstatic unsigned int sec_to_period(unsigned int secs)\n{\n\treturn secs;\n}\n\n#define MAX_WDT_TIMEOUT\t\t3\t \n\n#endif  \n\nstatic void __booke_wdt_set(void *data)\n{\n\tu32 val;\n\tstruct watchdog_device *wdog = data;\n\n\tval = mfspr(SPRN_TCR);\n\tval &= ~WDTP_MASK;\n\tval |= WDTP(sec_to_period(wdog->timeout));\n\n\tmtspr(SPRN_TCR, val);\n}\n\nstatic void booke_wdt_set(void *data)\n{\n\ton_each_cpu(__booke_wdt_set, data, 0);\n}\n\nstatic void __booke_wdt_ping(void *data)\n{\n\tmtspr(SPRN_TSR, TSR_ENW|TSR_WIS);\n}\n\nstatic int booke_wdt_ping(struct watchdog_device *wdog)\n{\n\ton_each_cpu(__booke_wdt_ping, NULL, 0);\n\n\treturn 0;\n}\n\nstatic void __booke_wdt_enable(void *data)\n{\n\tu32 val;\n\tstruct watchdog_device *wdog = data;\n\n\t \n\t__booke_wdt_ping(NULL);\n\tval = mfspr(SPRN_TCR);\n\tval &= ~WDTP_MASK;\n\tval |= (TCR_WIE|TCR_WRC(WRC_CHIP)|WDTP(sec_to_period(wdog->timeout)));\n\n\tmtspr(SPRN_TCR, val);\n}\n\n \nstatic void __booke_wdt_disable(void *data)\n{\n\tu32 val;\n\n\tval = mfspr(SPRN_TCR);\n\tval &= ~(TCR_WIE | WDTP_MASK);\n\tmtspr(SPRN_TCR, val);\n\n\t \n\t__booke_wdt_ping(NULL);\n\n}\n\nstatic int booke_wdt_start(struct watchdog_device *wdog)\n{\n\ton_each_cpu(__booke_wdt_enable, wdog, 0);\n\tpr_debug(\"watchdog enabled (timeout = %u sec)\\n\", wdog->timeout);\n\n\treturn 0;\n}\n\nstatic int booke_wdt_stop(struct watchdog_device *wdog)\n{\n\ton_each_cpu(__booke_wdt_disable, NULL, 0);\n\tpr_debug(\"watchdog disabled\\n\");\n\n\treturn 0;\n}\n\nstatic int booke_wdt_set_timeout(struct watchdog_device *wdt_dev,\n\t\t\t\t unsigned int timeout)\n{\n\twdt_dev->timeout = timeout;\n\tbooke_wdt_set(wdt_dev);\n\n\treturn 0;\n}\n\nstatic struct watchdog_info booke_wdt_info __ro_after_init = {\n\t.options = WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING,\n\t.identity = \"PowerPC Book-E Watchdog\",\n};\n\nstatic const struct watchdog_ops booke_wdt_ops = {\n\t.owner = THIS_MODULE,\n\t.start = booke_wdt_start,\n\t.stop = booke_wdt_stop,\n\t.ping = booke_wdt_ping,\n\t.set_timeout = booke_wdt_set_timeout,\n};\n\nstatic struct watchdog_device booke_wdt_dev = {\n\t.info = &booke_wdt_info,\n\t.ops = &booke_wdt_ops,\n\t.min_timeout = 1,\n};\n\nstatic void __exit booke_wdt_exit(void)\n{\n\twatchdog_unregister_device(&booke_wdt_dev);\n}\n\nstatic int __init booke_wdt_init(void)\n{\n\tint ret = 0;\n\n\tpr_info(\"powerpc book-e watchdog driver loaded\\n\");\n\tbooke_wdt_info.firmware_version = cur_cpu_spec->pvr_value;\n\tbooke_wdt_set_timeout(&booke_wdt_dev,\n\t\t\t      period_to_sec(booke_wdt_period));\n\twatchdog_set_nowayout(&booke_wdt_dev, nowayout);\n\tbooke_wdt_dev.max_timeout = MAX_WDT_TIMEOUT;\n\tif (booke_wdt_enabled)\n\t\tbooke_wdt_start(&booke_wdt_dev);\n\n\tret = watchdog_register_device(&booke_wdt_dev);\n\n\treturn ret;\n}\n\nmodule_init(booke_wdt_init);\nmodule_exit(booke_wdt_exit);\n\nMODULE_ALIAS(\"booke_wdt\");\nMODULE_DESCRIPTION(\"PowerPC Book-E watchdog driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}