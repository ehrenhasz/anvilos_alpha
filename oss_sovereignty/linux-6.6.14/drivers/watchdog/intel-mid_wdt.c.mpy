{
  "module_name": "intel-mid_wdt.c",
  "hash_id": "3d5316a47a135bbd5f8e0e05032fca6a56e322ec11177a91a58e8caab6337841",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/intel-mid_wdt.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/nmi.h>\n#include <linux/platform_device.h>\n#include <linux/watchdog.h>\n#include <linux/platform_data/intel-mid_wdt.h>\n\n#include <asm/intel_scu_ipc.h>\n#include <asm/intel-mid.h>\n\n#define IPC_WATCHDOG 0xf8\n\n#define MID_WDT_PRETIMEOUT\t\t15\n#define MID_WDT_TIMEOUT_MIN\t\t(1 + MID_WDT_PRETIMEOUT)\n#define MID_WDT_TIMEOUT_MAX\t\t170\n#define MID_WDT_DEFAULT_TIMEOUT\t\t90\n\n \nenum {\n\tSCU_WATCHDOG_START = 0,\n\tSCU_WATCHDOG_STOP,\n\tSCU_WATCHDOG_KEEPALIVE,\n};\n\nstruct mid_wdt {\n\tstruct watchdog_device wd;\n\tstruct device *dev;\n\tstruct intel_scu_ipc_dev *scu;\n};\n\nstatic inline int\nwdt_command(struct mid_wdt *mid, int sub, const void *in, size_t inlen, size_t size)\n{\n\tstruct intel_scu_ipc_dev *scu = mid->scu;\n\n\treturn intel_scu_ipc_dev_command_with_size(scu, IPC_WATCHDOG, sub, in,\n\t\t\t\t\t\t   inlen, size, NULL, 0);\n}\n\nstatic int wdt_start(struct watchdog_device *wd)\n{\n\tstruct mid_wdt *mid = watchdog_get_drvdata(wd);\n\tint ret, in_size;\n\tint timeout = wd->timeout;\n\tstruct ipc_wd_start {\n\t\tu32 pretimeout;\n\t\tu32 timeout;\n\t} ipc_wd_start = { timeout - MID_WDT_PRETIMEOUT, timeout };\n\n\t \n\tin_size = DIV_ROUND_UP(sizeof(ipc_wd_start), 4);\n\n\tret = wdt_command(mid, SCU_WATCHDOG_START, &ipc_wd_start,\n\t\t\t  sizeof(ipc_wd_start), in_size);\n\tif (ret)\n\t\tdev_crit(mid->dev, \"error starting watchdog: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int wdt_ping(struct watchdog_device *wd)\n{\n\tstruct mid_wdt *mid = watchdog_get_drvdata(wd);\n\tint ret;\n\n\tret = wdt_command(mid, SCU_WATCHDOG_KEEPALIVE, NULL, 0, 0);\n\tif (ret)\n\t\tdev_crit(mid->dev, \"Error executing keepalive: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int wdt_stop(struct watchdog_device *wd)\n{\n\tstruct mid_wdt *mid = watchdog_get_drvdata(wd);\n\tint ret;\n\n\tret = wdt_command(mid, SCU_WATCHDOG_STOP, NULL, 0, 0);\n\tif (ret)\n\t\tdev_crit(mid->dev, \"Error stopping watchdog: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic irqreturn_t mid_wdt_irq(int irq, void *dev_id)\n{\n\tpanic(\"Kernel Watchdog\");\n\n\t \n\treturn IRQ_HANDLED;\n}\n\nstatic const struct watchdog_info mid_wdt_info = {\n\t.identity = \"Intel MID SCU watchdog\",\n\t.options = WDIOF_KEEPALIVEPING | WDIOF_SETTIMEOUT | WDIOF_MAGICCLOSE,\n};\n\nstatic const struct watchdog_ops mid_wdt_ops = {\n\t.owner = THIS_MODULE,\n\t.start = wdt_start,\n\t.stop = wdt_stop,\n\t.ping = wdt_ping,\n};\n\nstatic int mid_wdt_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct watchdog_device *wdt_dev;\n\tstruct intel_mid_wdt_pdata *pdata = dev->platform_data;\n\tstruct mid_wdt *mid;\n\tint ret;\n\n\tif (!pdata) {\n\t\tdev_err(dev, \"missing platform data\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (pdata->probe) {\n\t\tret = pdata->probe(pdev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tmid = devm_kzalloc(dev, sizeof(*mid), GFP_KERNEL);\n\tif (!mid)\n\t\treturn -ENOMEM;\n\n\tmid->dev = dev;\n\twdt_dev = &mid->wd;\n\n\twdt_dev->info = &mid_wdt_info;\n\twdt_dev->ops = &mid_wdt_ops;\n\twdt_dev->min_timeout = MID_WDT_TIMEOUT_MIN;\n\twdt_dev->max_timeout = MID_WDT_TIMEOUT_MAX;\n\twdt_dev->timeout = MID_WDT_DEFAULT_TIMEOUT;\n\twdt_dev->parent = dev;\n\n\twatchdog_set_nowayout(wdt_dev, WATCHDOG_NOWAYOUT);\n\twatchdog_set_drvdata(wdt_dev, mid);\n\n\tmid->scu = devm_intel_scu_ipc_dev_get(dev);\n\tif (!mid->scu)\n\t\treturn -EPROBE_DEFER;\n\n\tret = devm_request_irq(dev, pdata->irq, mid_wdt_irq,\n\t\t\t       IRQF_SHARED | IRQF_NO_SUSPEND, \"watchdog\",\n\t\t\t       wdt_dev);\n\tif (ret) {\n\t\tdev_err(dev, \"error requesting warning irq %d\\n\", pdata->irq);\n\t\treturn ret;\n\t}\n\n\t \n\tret = wdt_start(wdt_dev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tset_bit(WDOG_HW_RUNNING, &wdt_dev->status);\n\n\tret = devm_watchdog_register_device(dev, wdt_dev);\n\tif (ret)\n\t\treturn ret;\n\n\tdev_info(dev, \"Intel MID watchdog device probed\\n\");\n\n\treturn 0;\n}\n\nstatic struct platform_driver mid_wdt_driver = {\n\t.probe\t\t= mid_wdt_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"intel_mid_wdt\",\n\t},\n};\n\nmodule_platform_driver(mid_wdt_driver);\n\nMODULE_AUTHOR(\"David Cohen <david.a.cohen@linux.intel.com>\");\nMODULE_DESCRIPTION(\"Watchdog Driver for Intel MID platform\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:intel_mid_wdt\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}