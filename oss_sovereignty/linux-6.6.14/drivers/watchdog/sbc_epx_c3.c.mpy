{
  "module_name": "sbc_epx_c3.c",
  "hash_id": "16dfbc84dddcc2bb1cdbe23fc94a0c449fc94f9bdb59bd6b61f5afc33c1fe3a5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/sbc_epx_c3.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/fs.h>\n#include <linux/mm.h>\n#include <linux/miscdevice.h>\n#include <linux/watchdog.h>\n#include <linux/notifier.h>\n#include <linux/reboot.h>\n#include <linux/init.h>\n#include <linux/ioport.h>\n#include <linux/uaccess.h>\n#include <linux/io.h>\n\nstatic int epx_c3_alive;\n\n#define WATCHDOG_TIMEOUT 1\t\t \n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout, \"Watchdog cannot be stopped once started (default=\"\n\t\t\t\t\t__MODULE_STRING(WATCHDOG_NOWAYOUT) \")\");\n\n#define EPXC3_WATCHDOG_CTL_REG 0x1ee  \n#define EPXC3_WATCHDOG_PET_REG 0x1ef  \n\nstatic void epx_c3_start(void)\n{\n\toutb(1, EPXC3_WATCHDOG_CTL_REG);\n}\n\nstatic void epx_c3_stop(void)\n{\n\n\toutb(0, EPXC3_WATCHDOG_CTL_REG);\n\n\tpr_info(\"Stopped watchdog timer\\n\");\n}\n\nstatic void epx_c3_pet(void)\n{\n\toutb(1, EPXC3_WATCHDOG_PET_REG);\n}\n\n \nstatic int epx_c3_open(struct inode *inode, struct file *file)\n{\n\tif (epx_c3_alive)\n\t\treturn -EBUSY;\n\n\tif (nowayout)\n\t\t__module_get(THIS_MODULE);\n\n\t \n\tepx_c3_start();\n\tepx_c3_pet();\n\n\tepx_c3_alive = 1;\n\tpr_info(\"Started watchdog timer\\n\");\n\n\treturn stream_open(inode, file);\n}\n\nstatic int epx_c3_release(struct inode *inode, struct file *file)\n{\n\t \n\tif (!nowayout)\n\t\tepx_c3_stop();\t\t \n\n\tepx_c3_alive = 0;\n\n\treturn 0;\n}\n\nstatic ssize_t epx_c3_write(struct file *file, const char __user *data,\n\t\t\tsize_t len, loff_t *ppos)\n{\n\t \n\tif (len)\n\t\tepx_c3_pet();\n\treturn len;\n}\n\nstatic long epx_c3_ioctl(struct file *file, unsigned int cmd,\n\t\t\t\t\t\tunsigned long arg)\n{\n\tint options, retval = -EINVAL;\n\tint __user *argp = (void __user *)arg;\n\tstatic const struct watchdog_info ident = {\n\t\t.options\t\t= WDIOF_KEEPALIVEPING,\n\t\t.firmware_version\t= 0,\n\t\t.identity\t\t= \"Winsystems EPX-C3 H/W Watchdog\",\n\t};\n\n\tswitch (cmd) {\n\tcase WDIOC_GETSUPPORT:\n\t\tif (copy_to_user(argp, &ident, sizeof(ident)))\n\t\t\treturn -EFAULT;\n\t\treturn 0;\n\tcase WDIOC_GETSTATUS:\n\tcase WDIOC_GETBOOTSTATUS:\n\t\treturn put_user(0, argp);\n\tcase WDIOC_SETOPTIONS:\n\t\tif (get_user(options, argp))\n\t\t\treturn -EFAULT;\n\n\t\tif (options & WDIOS_DISABLECARD) {\n\t\t\tepx_c3_stop();\n\t\t\tretval = 0;\n\t\t}\n\n\t\tif (options & WDIOS_ENABLECARD) {\n\t\t\tepx_c3_start();\n\t\t\tretval = 0;\n\t\t}\n\n\t\treturn retval;\n\tcase WDIOC_KEEPALIVE:\n\t\tepx_c3_pet();\n\t\treturn 0;\n\tcase WDIOC_GETTIMEOUT:\n\t\treturn put_user(WATCHDOG_TIMEOUT, argp);\n\tdefault:\n\t\treturn -ENOTTY;\n\t}\n}\n\nstatic int epx_c3_notify_sys(struct notifier_block *this, unsigned long code,\n\t\t\t\tvoid *unused)\n{\n\tif (code == SYS_DOWN || code == SYS_HALT)\n\t\tepx_c3_stop();\t\t \n\n\treturn NOTIFY_DONE;\n}\n\nstatic const struct file_operations epx_c3_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.llseek\t\t= no_llseek,\n\t.write\t\t= epx_c3_write,\n\t.unlocked_ioctl\t= epx_c3_ioctl,\n\t.compat_ioctl\t= compat_ptr_ioctl,\n\t.open\t\t= epx_c3_open,\n\t.release\t= epx_c3_release,\n};\n\nstatic struct miscdevice epx_c3_miscdev = {\n\t.minor\t\t= WATCHDOG_MINOR,\n\t.name\t\t= \"watchdog\",\n\t.fops\t\t= &epx_c3_fops,\n};\n\nstatic struct notifier_block epx_c3_notifier = {\n\t.notifier_call = epx_c3_notify_sys,\n};\n\nstatic int __init watchdog_init(void)\n{\n\tint ret;\n\n\tif (!request_region(EPXC3_WATCHDOG_CTL_REG, 2, \"epxc3_watchdog\"))\n\t\treturn -EBUSY;\n\n\tret = register_reboot_notifier(&epx_c3_notifier);\n\tif (ret) {\n\t\tpr_err(\"cannot register reboot notifier (err=%d)\\n\", ret);\n\t\tgoto out;\n\t}\n\n\tret = misc_register(&epx_c3_miscdev);\n\tif (ret) {\n\t\tpr_err(\"cannot register miscdev on minor=%d (err=%d)\\n\",\n\t\t       WATCHDOG_MINOR, ret);\n\t\tunregister_reboot_notifier(&epx_c3_notifier);\n\t\tgoto out;\n\t}\n\n\tpr_info(\"Hardware Watchdog Timer for Winsystems EPX-C3 SBC: 0.1\\n\");\n\n\treturn 0;\n\nout:\n\trelease_region(EPXC3_WATCHDOG_CTL_REG, 2);\n\treturn ret;\n}\n\nstatic void __exit watchdog_exit(void)\n{\n\tmisc_deregister(&epx_c3_miscdev);\n\tunregister_reboot_notifier(&epx_c3_notifier);\n\trelease_region(EPXC3_WATCHDOG_CTL_REG, 2);\n}\n\nmodule_init(watchdog_init);\nmodule_exit(watchdog_exit);\n\nMODULE_AUTHOR(\"Calin A. Culianu <calin@ajvar.org>\");\nMODULE_DESCRIPTION(\"Hardware Watchdog Device for Winsystems EPX-C3 SBC.  \"\n\t\"Note that there is no way to probe for this device -- \"\n\t\"so only use it if you are *sure* you are running on this specific \"\n\t\"SBC system from Winsystems!  It writes to IO ports 0x1ee and 0x1ef!\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}