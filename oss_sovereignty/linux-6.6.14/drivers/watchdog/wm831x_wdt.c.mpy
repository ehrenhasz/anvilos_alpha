{
  "module_name": "wm831x_wdt.c",
  "hash_id": "1d9f6920af51eb5b57ae02eacdc3524497f9e1df0848eaa5a120f7d2176953f9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/wm831x_wdt.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/platform_device.h>\n#include <linux/watchdog.h>\n#include <linux/uaccess.h>\n\n#include <linux/mfd/wm831x/core.h>\n#include <linux/mfd/wm831x/pdata.h>\n#include <linux/mfd/wm831x/watchdog.h>\n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout,\n\t\t \"Watchdog cannot be stopped once started (default=\"\n\t\t __MODULE_STRING(WATCHDOG_NOWAYOUT) \")\");\n\nstruct wm831x_wdt_drvdata {\n\tstruct watchdog_device wdt;\n\tstruct wm831x *wm831x;\n\tstruct mutex lock;\n\tint update_state;\n};\n\n \nstatic struct {\n\tunsigned int time;   \n\tu16 val;             \n} wm831x_wdt_cfgs[] = {\n\t{  1, 2 },\n\t{  2, 3 },\n\t{  4, 4 },\n\t{  8, 5 },\n\t{ 16, 6 },\n\t{ 32, 7 },\n\t{ 33, 7 },   \n};\n\nstatic int wm831x_wdt_start(struct watchdog_device *wdt_dev)\n{\n\tstruct wm831x_wdt_drvdata *driver_data = watchdog_get_drvdata(wdt_dev);\n\tstruct wm831x *wm831x = driver_data->wm831x;\n\tint ret;\n\n\tmutex_lock(&driver_data->lock);\n\n\tret = wm831x_reg_unlock(wm831x);\n\tif (ret == 0) {\n\t\tret = wm831x_set_bits(wm831x, WM831X_WATCHDOG,\n\t\t\t\t      WM831X_WDOG_ENA, WM831X_WDOG_ENA);\n\t\twm831x_reg_lock(wm831x);\n\t} else {\n\t\tdev_err(wm831x->dev, \"Failed to unlock security key: %d\\n\",\n\t\t\tret);\n\t}\n\n\tmutex_unlock(&driver_data->lock);\n\n\treturn ret;\n}\n\nstatic int wm831x_wdt_stop(struct watchdog_device *wdt_dev)\n{\n\tstruct wm831x_wdt_drvdata *driver_data = watchdog_get_drvdata(wdt_dev);\n\tstruct wm831x *wm831x = driver_data->wm831x;\n\tint ret;\n\n\tmutex_lock(&driver_data->lock);\n\n\tret = wm831x_reg_unlock(wm831x);\n\tif (ret == 0) {\n\t\tret = wm831x_set_bits(wm831x, WM831X_WATCHDOG,\n\t\t\t\t      WM831X_WDOG_ENA, 0);\n\t\twm831x_reg_lock(wm831x);\n\t} else {\n\t\tdev_err(wm831x->dev, \"Failed to unlock security key: %d\\n\",\n\t\t\tret);\n\t}\n\n\tmutex_unlock(&driver_data->lock);\n\n\treturn ret;\n}\n\nstatic int wm831x_wdt_ping(struct watchdog_device *wdt_dev)\n{\n\tstruct wm831x_wdt_drvdata *driver_data = watchdog_get_drvdata(wdt_dev);\n\tstruct wm831x *wm831x = driver_data->wm831x;\n\tint ret;\n\tu16 reg;\n\n\tmutex_lock(&driver_data->lock);\n\n\treg = wm831x_reg_read(wm831x, WM831X_WATCHDOG);\n\n\tif (!(reg & WM831X_WDOG_RST_SRC)) {\n\t\tdev_err(wm831x->dev, \"Hardware watchdog update unsupported\\n\");\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\treg |= WM831X_WDOG_RESET;\n\n\tret = wm831x_reg_unlock(wm831x);\n\tif (ret == 0) {\n\t\tret = wm831x_reg_write(wm831x, WM831X_WATCHDOG, reg);\n\t\twm831x_reg_lock(wm831x);\n\t} else {\n\t\tdev_err(wm831x->dev, \"Failed to unlock security key: %d\\n\",\n\t\t\tret);\n\t}\n\nout:\n\tmutex_unlock(&driver_data->lock);\n\n\treturn ret;\n}\n\nstatic int wm831x_wdt_set_timeout(struct watchdog_device *wdt_dev,\n\t\t\t\t  unsigned int timeout)\n{\n\tstruct wm831x_wdt_drvdata *driver_data = watchdog_get_drvdata(wdt_dev);\n\tstruct wm831x *wm831x = driver_data->wm831x;\n\tint ret, i;\n\n\tfor (i = 0; i < ARRAY_SIZE(wm831x_wdt_cfgs); i++)\n\t\tif (wm831x_wdt_cfgs[i].time == timeout)\n\t\t\tbreak;\n\tif (i == ARRAY_SIZE(wm831x_wdt_cfgs))\n\t\treturn -EINVAL;\n\n\tret = wm831x_reg_unlock(wm831x);\n\tif (ret == 0) {\n\t\tret = wm831x_set_bits(wm831x, WM831X_WATCHDOG,\n\t\t\t\t      WM831X_WDOG_TO_MASK,\n\t\t\t\t      wm831x_wdt_cfgs[i].val);\n\t\twm831x_reg_lock(wm831x);\n\t} else {\n\t\tdev_err(wm831x->dev, \"Failed to unlock security key: %d\\n\",\n\t\t\tret);\n\t}\n\n\twdt_dev->timeout = timeout;\n\n\treturn ret;\n}\n\nstatic const struct watchdog_info wm831x_wdt_info = {\n\t.options = WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING | WDIOF_MAGICCLOSE,\n\t.identity = \"WM831x Watchdog\",\n};\n\nstatic const struct watchdog_ops wm831x_wdt_ops = {\n\t.owner = THIS_MODULE,\n\t.start = wm831x_wdt_start,\n\t.stop = wm831x_wdt_stop,\n\t.ping = wm831x_wdt_ping,\n\t.set_timeout = wm831x_wdt_set_timeout,\n};\n\nstatic int wm831x_wdt_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct wm831x *wm831x = dev_get_drvdata(dev->parent);\n\tstruct wm831x_pdata *chip_pdata = dev_get_platdata(dev->parent);\n\tstruct wm831x_watchdog_pdata *pdata;\n\tstruct wm831x_wdt_drvdata *driver_data;\n\tstruct watchdog_device *wm831x_wdt;\n\tint reg, ret, i;\n\n\tret = wm831x_reg_read(wm831x, WM831X_WATCHDOG);\n\tif (ret < 0) {\n\t\tdev_err(wm831x->dev, \"Failed to read watchdog status: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\treg = ret;\n\n\tif (reg & WM831X_WDOG_DEBUG)\n\t\tdev_warn(wm831x->dev, \"Watchdog is paused\\n\");\n\n\tdriver_data = devm_kzalloc(dev, sizeof(*driver_data), GFP_KERNEL);\n\tif (!driver_data)\n\t\treturn -ENOMEM;\n\n\tmutex_init(&driver_data->lock);\n\tdriver_data->wm831x = wm831x;\n\n\twm831x_wdt = &driver_data->wdt;\n\n\twm831x_wdt->info = &wm831x_wdt_info;\n\twm831x_wdt->ops = &wm831x_wdt_ops;\n\twm831x_wdt->parent = dev;\n\twatchdog_set_nowayout(wm831x_wdt, nowayout);\n\twatchdog_set_drvdata(wm831x_wdt, driver_data);\n\n\treg = wm831x_reg_read(wm831x, WM831X_WATCHDOG);\n\treg &= WM831X_WDOG_TO_MASK;\n\tfor (i = 0; i < ARRAY_SIZE(wm831x_wdt_cfgs); i++)\n\t\tif (wm831x_wdt_cfgs[i].val == reg)\n\t\t\tbreak;\n\tif (i == ARRAY_SIZE(wm831x_wdt_cfgs))\n\t\tdev_warn(wm831x->dev,\n\t\t\t \"Unknown watchdog timeout: %x\\n\", reg);\n\telse\n\t\twm831x_wdt->timeout = wm831x_wdt_cfgs[i].time;\n\n\t \n\tif (chip_pdata)\n\t\tpdata = chip_pdata->watchdog;\n\telse\n\t\tpdata = NULL;\n\n\tif (pdata) {\n\t\treg &= ~(WM831X_WDOG_SECACT_MASK | WM831X_WDOG_PRIMACT_MASK |\n\t\t\t WM831X_WDOG_RST_SRC);\n\n\t\treg |= pdata->primary << WM831X_WDOG_PRIMACT_SHIFT;\n\t\treg |= pdata->secondary << WM831X_WDOG_SECACT_SHIFT;\n\t\treg |= pdata->software << WM831X_WDOG_RST_SRC_SHIFT;\n\n\t\tret = wm831x_reg_unlock(wm831x);\n\t\tif (ret == 0) {\n\t\t\tret = wm831x_reg_write(wm831x, WM831X_WATCHDOG, reg);\n\t\t\twm831x_reg_lock(wm831x);\n\t\t} else {\n\t\t\tdev_err(wm831x->dev,\n\t\t\t\t\"Failed to unlock security key: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn devm_watchdog_register_device(dev, &driver_data->wdt);\n}\n\nstatic struct platform_driver wm831x_wdt_driver = {\n\t.probe = wm831x_wdt_probe,\n\t.driver = {\n\t\t.name = \"wm831x-watchdog\",\n\t},\n};\n\nmodule_platform_driver(wm831x_wdt_driver);\n\nMODULE_AUTHOR(\"Mark Brown\");\nMODULE_DESCRIPTION(\"WM831x Watchdog\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:wm831x-watchdog\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}