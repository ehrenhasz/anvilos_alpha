{
  "module_name": "geodewdt.c",
  "hash_id": "f55c688591a792b48db85e9e6a7f24f4d44fd6a70b0b63092665d15feb48f767",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/geodewdt.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/types.h>\n#include <linux/miscdevice.h>\n#include <linux/watchdog.h>\n#include <linux/fs.h>\n#include <linux/platform_device.h>\n#include <linux/reboot.h>\n#include <linux/uaccess.h>\n\n#include <linux/cs5535.h>\n\n#define GEODEWDT_HZ 500\n#define GEODEWDT_SCALE 6\n#define GEODEWDT_MAX_SECONDS 131\n\n#define WDT_FLAGS_OPEN 1\n#define WDT_FLAGS_ORPHAN 2\n\n#define DRV_NAME \"geodewdt\"\n#define WATCHDOG_NAME \"Geode GX/LX WDT\"\n#define WATCHDOG_TIMEOUT 60\n\nstatic int timeout = WATCHDOG_TIMEOUT;\nmodule_param(timeout, int, 0);\nMODULE_PARM_DESC(timeout,\n\t\"Watchdog timeout in seconds. 1<= timeout <=131, default=\"\n\t\t\t\t__MODULE_STRING(WATCHDOG_TIMEOUT) \".\");\n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout,\n\t\"Watchdog cannot be stopped once started (default=\"\n\t\t\t\t__MODULE_STRING(WATCHDOG_NOWAYOUT) \")\");\n\nstatic struct platform_device *geodewdt_platform_device;\nstatic unsigned long wdt_flags;\nstatic struct cs5535_mfgpt_timer *wdt_timer;\nstatic int safe_close;\n\nstatic void geodewdt_ping(void)\n{\n\t \n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP, 0);\n\n\t \n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_COUNTER, 0);\n\n\t \n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP, MFGPT_SETUP_CNTEN);\n}\n\nstatic void geodewdt_disable(void)\n{\n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP, 0);\n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_COUNTER, 0);\n}\n\nstatic int geodewdt_set_heartbeat(int val)\n{\n\tif (val < 1 || val > GEODEWDT_MAX_SECONDS)\n\t\treturn -EINVAL;\n\n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP, 0);\n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_CMP2, val * GEODEWDT_HZ);\n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_COUNTER, 0);\n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP, MFGPT_SETUP_CNTEN);\n\n\ttimeout = val;\n\treturn 0;\n}\n\nstatic int geodewdt_open(struct inode *inode, struct file *file)\n{\n\tif (test_and_set_bit(WDT_FLAGS_OPEN, &wdt_flags))\n\t\treturn -EBUSY;\n\n\tif (!test_and_clear_bit(WDT_FLAGS_ORPHAN, &wdt_flags))\n\t\t__module_get(THIS_MODULE);\n\n\tgeodewdt_ping();\n\treturn stream_open(inode, file);\n}\n\nstatic int geodewdt_release(struct inode *inode, struct file *file)\n{\n\tif (safe_close) {\n\t\tgeodewdt_disable();\n\t\tmodule_put(THIS_MODULE);\n\t} else {\n\t\tpr_crit(\"Unexpected close - watchdog is not stopping\\n\");\n\t\tgeodewdt_ping();\n\n\t\tset_bit(WDT_FLAGS_ORPHAN, &wdt_flags);\n\t}\n\n\tclear_bit(WDT_FLAGS_OPEN, &wdt_flags);\n\tsafe_close = 0;\n\treturn 0;\n}\n\nstatic ssize_t geodewdt_write(struct file *file, const char __user *data,\n\t\t\t\tsize_t len, loff_t *ppos)\n{\n\tif (len) {\n\t\tif (!nowayout) {\n\t\t\tsize_t i;\n\t\t\tsafe_close = 0;\n\n\t\t\tfor (i = 0; i != len; i++) {\n\t\t\t\tchar c;\n\n\t\t\t\tif (get_user(c, data + i))\n\t\t\t\t\treturn -EFAULT;\n\n\t\t\t\tif (c == 'V')\n\t\t\t\t\tsafe_close = 1;\n\t\t\t}\n\t\t}\n\n\t\tgeodewdt_ping();\n\t}\n\treturn len;\n}\n\nstatic long geodewdt_ioctl(struct file *file, unsigned int cmd,\n\t\t\t\tunsigned long arg)\n{\n\tvoid __user *argp = (void __user *)arg;\n\tint __user *p = argp;\n\tint interval;\n\n\tstatic const struct watchdog_info ident = {\n\t\t.options = WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING\n\t\t| WDIOF_MAGICCLOSE,\n\t\t.firmware_version =     1,\n\t\t.identity =             WATCHDOG_NAME,\n\t};\n\n\tswitch (cmd) {\n\tcase WDIOC_GETSUPPORT:\n\t\treturn copy_to_user(argp, &ident,\n\t\t\t\t    sizeof(ident)) ? -EFAULT : 0;\n\tcase WDIOC_GETSTATUS:\n\tcase WDIOC_GETBOOTSTATUS:\n\t\treturn put_user(0, p);\n\n\tcase WDIOC_SETOPTIONS:\n\t{\n\t\tint options, ret = -EINVAL;\n\n\t\tif (get_user(options, p))\n\t\t\treturn -EFAULT;\n\n\t\tif (options & WDIOS_DISABLECARD) {\n\t\t\tgeodewdt_disable();\n\t\t\tret = 0;\n\t\t}\n\n\t\tif (options & WDIOS_ENABLECARD) {\n\t\t\tgeodewdt_ping();\n\t\t\tret = 0;\n\t\t}\n\n\t\treturn ret;\n\t}\n\tcase WDIOC_KEEPALIVE:\n\t\tgeodewdt_ping();\n\t\treturn 0;\n\n\tcase WDIOC_SETTIMEOUT:\n\t\tif (get_user(interval, p))\n\t\t\treturn -EFAULT;\n\n\t\tif (geodewdt_set_heartbeat(interval))\n\t\t\treturn -EINVAL;\n\t\tfallthrough;\n\tcase WDIOC_GETTIMEOUT:\n\t\treturn put_user(timeout, p);\n\n\tdefault:\n\t\treturn -ENOTTY;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct file_operations geodewdt_fops = {\n\t.owner          = THIS_MODULE,\n\t.llseek         = no_llseek,\n\t.write          = geodewdt_write,\n\t.unlocked_ioctl = geodewdt_ioctl,\n\t.compat_ioctl\t= compat_ptr_ioctl,\n\t.open           = geodewdt_open,\n\t.release        = geodewdt_release,\n};\n\nstatic struct miscdevice geodewdt_miscdev = {\n\t.minor = WATCHDOG_MINOR,\n\t.name = \"watchdog\",\n\t.fops = &geodewdt_fops,\n};\n\nstatic int __init geodewdt_probe(struct platform_device *dev)\n{\n\tint ret;\n\n\twdt_timer = cs5535_mfgpt_alloc_timer(MFGPT_TIMER_ANY, MFGPT_DOMAIN_WORKING);\n\tif (!wdt_timer) {\n\t\tpr_err(\"No timers were available\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\t \n\n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_SETUP,\n\t\t\t  GEODEWDT_SCALE | (3 << 8));\n\n\t \n\tcs5535_mfgpt_toggle_event(wdt_timer, MFGPT_CMP2, MFGPT_EVENT_RESET, 1);\n\n\t \n\n\tcs5535_mfgpt_write(wdt_timer, MFGPT_REG_CMP2,\n\t\ttimeout * GEODEWDT_HZ);\n\n\tret = misc_register(&geodewdt_miscdev);\n\n\treturn ret;\n}\n\nstatic void geodewdt_remove(struct platform_device *dev)\n{\n\tmisc_deregister(&geodewdt_miscdev);\n}\n\nstatic void geodewdt_shutdown(struct platform_device *dev)\n{\n\tgeodewdt_disable();\n}\n\nstatic struct platform_driver geodewdt_driver = {\n\t.remove_new\t= geodewdt_remove,\n\t.shutdown\t= geodewdt_shutdown,\n\t.driver\t\t= {\n\t\t.name\t= DRV_NAME,\n\t},\n};\n\nstatic int __init geodewdt_init(void)\n{\n\tint ret;\n\n\tgeodewdt_platform_device = platform_device_register_simple(DRV_NAME,\n\t\t\t\t\t\t\t\t-1, NULL, 0);\n\tif (IS_ERR(geodewdt_platform_device))\n\t\treturn PTR_ERR(geodewdt_platform_device);\n\n\tret = platform_driver_probe(&geodewdt_driver, geodewdt_probe);\n\tif (ret)\n\t\tgoto err;\n\n\treturn 0;\nerr:\n\tplatform_device_unregister(geodewdt_platform_device);\n\treturn ret;\n}\n\nstatic void __exit geodewdt_exit(void)\n{\n\tplatform_device_unregister(geodewdt_platform_device);\n\tplatform_driver_unregister(&geodewdt_driver);\n}\n\nmodule_init(geodewdt_init);\nmodule_exit(geodewdt_exit);\n\nMODULE_AUTHOR(\"Advanced Micro Devices, Inc\");\nMODULE_DESCRIPTION(\"Geode GX/LX Watchdog Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}