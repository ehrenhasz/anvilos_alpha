{
  "module_name": "wm8350_wdt.c",
  "hash_id": "b119609b1966878fd39cf4ba154aea57285dc57d1bc277edae5dee656fa6eb79",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/wm8350_wdt.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/types.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/watchdog.h>\n#include <linux/uaccess.h>\n#include <linux/mfd/wm8350/core.h>\n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout,\n\t\t \"Watchdog cannot be stopped once started (default=\"\n\t\t __MODULE_STRING(WATCHDOG_NOWAYOUT) \")\");\n\nstatic DEFINE_MUTEX(wdt_mutex);\n\nstatic struct {\n\tunsigned int time;   \n\tu16 val;\t     \n} wm8350_wdt_cfgs[] = {\n\t{ 1, 0x02 },\n\t{ 2, 0x04 },\n\t{ 4, 0x05 },\n};\n\nstatic int wm8350_wdt_set_timeout(struct watchdog_device *wdt_dev,\n\t\t\t\t  unsigned int timeout)\n{\n\tstruct wm8350 *wm8350 = watchdog_get_drvdata(wdt_dev);\n\tint ret, i;\n\tu16 reg;\n\n\tfor (i = 0; i < ARRAY_SIZE(wm8350_wdt_cfgs); i++)\n\t\tif (wm8350_wdt_cfgs[i].time == timeout)\n\t\t\tbreak;\n\tif (i == ARRAY_SIZE(wm8350_wdt_cfgs))\n\t\treturn -EINVAL;\n\n\tmutex_lock(&wdt_mutex);\n\twm8350_reg_unlock(wm8350);\n\n\treg = wm8350_reg_read(wm8350, WM8350_SYSTEM_CONTROL_2);\n\treg &= ~WM8350_WDOG_TO_MASK;\n\treg |= wm8350_wdt_cfgs[i].val;\n\tret = wm8350_reg_write(wm8350, WM8350_SYSTEM_CONTROL_2, reg);\n\n\twm8350_reg_lock(wm8350);\n\tmutex_unlock(&wdt_mutex);\n\n\twdt_dev->timeout = timeout;\n\treturn ret;\n}\n\nstatic int wm8350_wdt_start(struct watchdog_device *wdt_dev)\n{\n\tstruct wm8350 *wm8350 = watchdog_get_drvdata(wdt_dev);\n\tint ret;\n\tu16 reg;\n\n\tmutex_lock(&wdt_mutex);\n\twm8350_reg_unlock(wm8350);\n\n\treg = wm8350_reg_read(wm8350, WM8350_SYSTEM_CONTROL_2);\n\treg &= ~WM8350_WDOG_MODE_MASK;\n\treg |= 0x20;\n\tret = wm8350_reg_write(wm8350, WM8350_SYSTEM_CONTROL_2, reg);\n\n\twm8350_reg_lock(wm8350);\n\tmutex_unlock(&wdt_mutex);\n\n\treturn ret;\n}\n\nstatic int wm8350_wdt_stop(struct watchdog_device *wdt_dev)\n{\n\tstruct wm8350 *wm8350 = watchdog_get_drvdata(wdt_dev);\n\tint ret;\n\tu16 reg;\n\n\tmutex_lock(&wdt_mutex);\n\twm8350_reg_unlock(wm8350);\n\n\treg = wm8350_reg_read(wm8350, WM8350_SYSTEM_CONTROL_2);\n\treg &= ~WM8350_WDOG_MODE_MASK;\n\tret = wm8350_reg_write(wm8350, WM8350_SYSTEM_CONTROL_2, reg);\n\n\twm8350_reg_lock(wm8350);\n\tmutex_unlock(&wdt_mutex);\n\n\treturn ret;\n}\n\nstatic int wm8350_wdt_ping(struct watchdog_device *wdt_dev)\n{\n\tstruct wm8350 *wm8350 = watchdog_get_drvdata(wdt_dev);\n\tint ret;\n\tu16 reg;\n\n\tmutex_lock(&wdt_mutex);\n\n\treg = wm8350_reg_read(wm8350, WM8350_SYSTEM_CONTROL_2);\n\tret = wm8350_reg_write(wm8350, WM8350_SYSTEM_CONTROL_2, reg);\n\n\tmutex_unlock(&wdt_mutex);\n\n\treturn ret;\n}\n\nstatic const struct watchdog_info wm8350_wdt_info = {\n\t.options = WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING | WDIOF_MAGICCLOSE,\n\t.identity = \"WM8350 Watchdog\",\n};\n\nstatic const struct watchdog_ops wm8350_wdt_ops = {\n\t.owner = THIS_MODULE,\n\t.start = wm8350_wdt_start,\n\t.stop = wm8350_wdt_stop,\n\t.ping = wm8350_wdt_ping,\n\t.set_timeout = wm8350_wdt_set_timeout,\n};\n\nstatic struct watchdog_device wm8350_wdt = {\n\t.info = &wm8350_wdt_info,\n\t.ops = &wm8350_wdt_ops,\n\t.timeout = 4,\n\t.min_timeout = 1,\n\t.max_timeout = 4,\n};\n\nstatic int wm8350_wdt_probe(struct platform_device *pdev)\n{\n\tstruct wm8350 *wm8350 = platform_get_drvdata(pdev);\n\n\tif (!wm8350) {\n\t\tpr_err(\"No driver data supplied\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\twatchdog_set_nowayout(&wm8350_wdt, nowayout);\n\twatchdog_set_drvdata(&wm8350_wdt, wm8350);\n\twm8350_wdt.parent = &pdev->dev;\n\n\t \n\twm8350_wdt_set_timeout(&wm8350_wdt, 4);\n\n\treturn devm_watchdog_register_device(&pdev->dev, &wm8350_wdt);\n}\n\nstatic struct platform_driver wm8350_wdt_driver = {\n\t.probe = wm8350_wdt_probe,\n\t.driver = {\n\t\t.name = \"wm8350-wdt\",\n\t},\n};\n\nmodule_platform_driver(wm8350_wdt_driver);\n\nMODULE_AUTHOR(\"Mark Brown\");\nMODULE_DESCRIPTION(\"WM8350 Watchdog\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:wm8350-wdt\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}