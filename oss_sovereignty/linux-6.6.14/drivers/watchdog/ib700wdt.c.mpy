{
  "module_name": "ib700wdt.c",
  "hash_id": "6b0194d00b7f42db397c4ad1327714f3f5412042d3969a7c639b3b05cfff43a2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/ib700wdt.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/miscdevice.h>\n#include <linux/watchdog.h>\n#include <linux/ioport.h>\n#include <linux/fs.h>\n#include <linux/init.h>\n#include <linux/spinlock.h>\n#include <linux/moduleparam.h>\n#include <linux/platform_device.h>\n#include <linux/io.h>\n#include <linux/uaccess.h>\n\n\nstatic struct platform_device *ibwdt_platform_device;\nstatic unsigned long ibwdt_is_open;\nstatic DEFINE_SPINLOCK(ibwdt_lock);\nstatic char expect_close;\n\n \n#define DRV_NAME \"ib700wdt\"\n\n \n\n#define WDT_STOP 0x441\n#define WDT_START 0x443\n\n \n#define WATCHDOG_TIMEOUT 30\t\t \nstatic int timeout = WATCHDOG_TIMEOUT;\t \nmodule_param(timeout, int, 0);\nMODULE_PARM_DESC(timeout,\n\t\"Watchdog timeout in seconds. 0<= timeout <=30, default=\"\n\t\t__MODULE_STRING(WATCHDOG_TIMEOUT) \".\");\n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout,\n\t\t\"Watchdog cannot be stopped once started (default=\"\n\t\t\t\t__MODULE_STRING(WATCHDOG_NOWAYOUT) \")\");\n\n\n \n\nstatic void ibwdt_ping(void)\n{\n\tint wd_margin = 15 - ((timeout + 1) / 2);\n\n\tspin_lock(&ibwdt_lock);\n\n\t \n\toutb_p(wd_margin, WDT_START);\n\n\tspin_unlock(&ibwdt_lock);\n}\n\nstatic void ibwdt_disable(void)\n{\n\tspin_lock(&ibwdt_lock);\n\toutb_p(0, WDT_STOP);\n\tspin_unlock(&ibwdt_lock);\n}\n\nstatic int ibwdt_set_heartbeat(int t)\n{\n\tif (t < 0 || t > 30)\n\t\treturn -EINVAL;\n\n\ttimeout = t;\n\treturn 0;\n}\n\n \n\nstatic ssize_t ibwdt_write(struct file *file, const char __user *buf,\n\t\t\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tif (count) {\n\t\tif (!nowayout) {\n\t\t\tsize_t i;\n\n\t\t\t \n\t\t\texpect_close = 0;\n\n\t\t\tfor (i = 0; i != count; i++) {\n\t\t\t\tchar c;\n\t\t\t\tif (get_user(c, buf + i))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tif (c == 'V')\n\t\t\t\t\texpect_close = 42;\n\t\t\t}\n\t\t}\n\t\tibwdt_ping();\n\t}\n\treturn count;\n}\n\nstatic long ibwdt_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\n{\n\tint new_margin;\n\tvoid __user *argp = (void __user *)arg;\n\tint __user *p = argp;\n\n\tstatic const struct watchdog_info ident = {\n\t\t.options = WDIOF_KEEPALIVEPING | WDIOF_SETTIMEOUT\n\t\t\t\t\t\t\t| WDIOF_MAGICCLOSE,\n\t\t.firmware_version = 1,\n\t\t.identity = \"IB700 WDT\",\n\t};\n\n\tswitch (cmd) {\n\tcase WDIOC_GETSUPPORT:\n\t\tif (copy_to_user(argp, &ident, sizeof(ident)))\n\t\t\treturn -EFAULT;\n\t\tbreak;\n\n\tcase WDIOC_GETSTATUS:\n\tcase WDIOC_GETBOOTSTATUS:\n\t\treturn put_user(0, p);\n\n\tcase WDIOC_SETOPTIONS:\n\t{\n\t\tint options, retval = -EINVAL;\n\n\t\tif (get_user(options, p))\n\t\t\treturn -EFAULT;\n\n\t\tif (options & WDIOS_DISABLECARD) {\n\t\t\tibwdt_disable();\n\t\t\tretval = 0;\n\t\t}\n\t\tif (options & WDIOS_ENABLECARD) {\n\t\t\tibwdt_ping();\n\t\t\tretval = 0;\n\t\t}\n\t\treturn retval;\n\t}\n\tcase WDIOC_KEEPALIVE:\n\t\tibwdt_ping();\n\t\tbreak;\n\n\tcase WDIOC_SETTIMEOUT:\n\t\tif (get_user(new_margin, p))\n\t\t\treturn -EFAULT;\n\t\tif (ibwdt_set_heartbeat(new_margin))\n\t\t\treturn -EINVAL;\n\t\tibwdt_ping();\n\t\tfallthrough;\n\n\tcase WDIOC_GETTIMEOUT:\n\t\treturn put_user(timeout, p);\n\n\tdefault:\n\t\treturn -ENOTTY;\n\t}\n\treturn 0;\n}\n\nstatic int ibwdt_open(struct inode *inode, struct file *file)\n{\n\tif (test_and_set_bit(0, &ibwdt_is_open))\n\t\treturn -EBUSY;\n\tif (nowayout)\n\t\t__module_get(THIS_MODULE);\n\n\t \n\tibwdt_ping();\n\treturn stream_open(inode, file);\n}\n\nstatic int ibwdt_close(struct inode *inode, struct file *file)\n{\n\tif (expect_close == 42) {\n\t\tibwdt_disable();\n\t} else {\n\t\tpr_crit(\"WDT device closed unexpectedly.  WDT will not stop!\\n\");\n\t\tibwdt_ping();\n\t}\n\tclear_bit(0, &ibwdt_is_open);\n\texpect_close = 0;\n\treturn 0;\n}\n\n \n\nstatic const struct file_operations ibwdt_fops = {\n\t.owner\t\t= THIS_MODULE,\n\t.llseek\t\t= no_llseek,\n\t.write\t\t= ibwdt_write,\n\t.unlocked_ioctl\t= ibwdt_ioctl,\n\t.compat_ioctl\t= compat_ptr_ioctl,\n\t.open\t\t= ibwdt_open,\n\t.release\t= ibwdt_close,\n};\n\nstatic struct miscdevice ibwdt_miscdev = {\n\t.minor = WATCHDOG_MINOR,\n\t.name = \"watchdog\",\n\t.fops = &ibwdt_fops,\n};\n\n \n\nstatic int __init ibwdt_probe(struct platform_device *dev)\n{\n\tint res;\n\n#if WDT_START != WDT_STOP\n\tif (!request_region(WDT_STOP, 1, \"IB700 WDT\")) {\n\t\tpr_err(\"STOP method I/O %X is not available\\n\", WDT_STOP);\n\t\tres = -EIO;\n\t\tgoto out_nostopreg;\n\t}\n#endif\n\n\tif (!request_region(WDT_START, 1, \"IB700 WDT\")) {\n\t\tpr_err(\"START method I/O %X is not available\\n\", WDT_START);\n\t\tres = -EIO;\n\t\tgoto out_nostartreg;\n\t}\n\n\t \n\tif (ibwdt_set_heartbeat(timeout)) {\n\t\tibwdt_set_heartbeat(WATCHDOG_TIMEOUT);\n\t\tpr_info(\"timeout value must be 0<=x<=30, using %d\\n\", timeout);\n\t}\n\n\tres = misc_register(&ibwdt_miscdev);\n\tif (res) {\n\t\tpr_err(\"failed to register misc device\\n\");\n\t\tgoto out_nomisc;\n\t}\n\treturn 0;\n\nout_nomisc:\n\trelease_region(WDT_START, 1);\nout_nostartreg:\n#if WDT_START != WDT_STOP\n\trelease_region(WDT_STOP, 1);\n#endif\nout_nostopreg:\n\treturn res;\n}\n\nstatic void ibwdt_remove(struct platform_device *dev)\n{\n\tmisc_deregister(&ibwdt_miscdev);\n\trelease_region(WDT_START, 1);\n#if WDT_START != WDT_STOP\n\trelease_region(WDT_STOP, 1);\n#endif\n}\n\nstatic void ibwdt_shutdown(struct platform_device *dev)\n{\n\t \n\tibwdt_disable();\n}\n\nstatic struct platform_driver ibwdt_driver = {\n\t.remove_new\t= ibwdt_remove,\n\t.shutdown\t= ibwdt_shutdown,\n\t.driver\t\t= {\n\t\t.name\t= DRV_NAME,\n\t},\n};\n\nstatic int __init ibwdt_init(void)\n{\n\tint err;\n\n\tpr_info(\"WDT driver for IB700 single board computer initialising\\n\");\n\n\tibwdt_platform_device = platform_device_register_simple(DRV_NAME,\n\t\t\t\t\t\t\t\t-1, NULL, 0);\n\tif (IS_ERR(ibwdt_platform_device))\n\t\treturn PTR_ERR(ibwdt_platform_device);\n\n\terr = platform_driver_probe(&ibwdt_driver, ibwdt_probe);\n\tif (err)\n\t\tgoto unreg_platform_device;\n\n\treturn 0;\n\nunreg_platform_device:\n\tplatform_device_unregister(ibwdt_platform_device);\n\treturn err;\n}\n\nstatic void __exit ibwdt_exit(void)\n{\n\tplatform_device_unregister(ibwdt_platform_device);\n\tplatform_driver_unregister(&ibwdt_driver);\n\tpr_info(\"Watchdog Module Unloaded\\n\");\n}\n\nmodule_init(ibwdt_init);\nmodule_exit(ibwdt_exit);\n\nMODULE_AUTHOR(\"Charles Howes <chowes@vsol.net>\");\nMODULE_DESCRIPTION(\"IB700 SBC watchdog driver\");\nMODULE_LICENSE(\"GPL\");\n\n \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}