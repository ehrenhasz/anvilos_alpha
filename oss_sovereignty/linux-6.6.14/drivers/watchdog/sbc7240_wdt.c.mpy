{
  "module_name": "sbc7240_wdt.c",
  "hash_id": "62dd89be89941cfa75769d4cdfe5e0ec81032fbf0ca39fd523c824c4721a1ea2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/sbc7240_wdt.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/fs.h>\n#include <linux/init.h>\n#include <linux/ioport.h>\n#include <linux/jiffies.h>\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/miscdevice.h>\n#include <linux/notifier.h>\n#include <linux/reboot.h>\n#include <linux/types.h>\n#include <linux/watchdog.h>\n#include <linux/io.h>\n#include <linux/uaccess.h>\n#include <linux/atomic.h>\n\n#define SBC7240_ENABLE_PORT\t\t0x443\n#define SBC7240_DISABLE_PORT\t\t0x043\n#define SBC7240_SET_TIMEOUT_PORT\tSBC7240_ENABLE_PORT\n#define SBC7240_MAGIC_CHAR\t\t'V'\n\n#define SBC7240_TIMEOUT\t\t30\n#define SBC7240_MAX_TIMEOUT\t\t255\nstatic int timeout = SBC7240_TIMEOUT;\t \nmodule_param(timeout, int, 0);\nMODULE_PARM_DESC(timeout, \"Watchdog timeout in seconds. (1<=timeout<=\"\n\t\t __MODULE_STRING(SBC7240_MAX_TIMEOUT) \", default=\"\n\t\t __MODULE_STRING(SBC7240_TIMEOUT) \")\");\n\nstatic bool nowayout = WATCHDOG_NOWAYOUT;\nmodule_param(nowayout, bool, 0);\nMODULE_PARM_DESC(nowayout, \"Disable watchdog when closing device file\");\n\n#define SBC7240_OPEN_STATUS_BIT\t\t0\n#define SBC7240_ENABLED_STATUS_BIT\t1\n#define SBC7240_EXPECT_CLOSE_STATUS_BIT\t2\nstatic unsigned long wdt_status;\n\n \n\nstatic void wdt_disable(void)\n{\n\t \n\tif (test_and_clear_bit(SBC7240_ENABLED_STATUS_BIT, &wdt_status)) {\n\t\tinb_p(SBC7240_DISABLE_PORT);\n\t\tpr_info(\"Watchdog timer is now disabled\\n\");\n\t}\n}\n\nstatic void wdt_enable(void)\n{\n\t \n\tif (!test_and_set_bit(SBC7240_ENABLED_STATUS_BIT, &wdt_status)) {\n\t\tinb_p(SBC7240_ENABLE_PORT);\n\t\tpr_info(\"Watchdog timer is now enabled\\n\");\n\t}\n}\n\nstatic int wdt_set_timeout(int t)\n{\n\tif (t < 1 || t > SBC7240_MAX_TIMEOUT) {\n\t\tpr_err(\"timeout value must be 1<=x<=%d\\n\", SBC7240_MAX_TIMEOUT);\n\t\treturn -1;\n\t}\n\t \n\toutb_p((unsigned)t, SBC7240_SET_TIMEOUT_PORT);\n\ttimeout = t;\n\tpr_info(\"timeout set to %d seconds\\n\", t);\n\treturn 0;\n}\n\n \nstatic inline void wdt_keepalive(void)\n{\n\tif (test_bit(SBC7240_ENABLED_STATUS_BIT, &wdt_status))\n\t\tinb_p(SBC7240_ENABLE_PORT);\n}\n\n \nstatic ssize_t fop_write(struct file *file, const char __user *buf,\n\t\t\t size_t count, loff_t *ppos)\n{\n\tsize_t i;\n\tchar c;\n\n\tif (count) {\n\t\tif (!nowayout) {\n\t\t\tclear_bit(SBC7240_EXPECT_CLOSE_STATUS_BIT,\n\t\t\t\t&wdt_status);\n\n\t\t\t \n\t\t\tfor (i = 0; i != count; i++) {\n\t\t\t\tif (get_user(c, buf + i))\n\t\t\t\t\treturn -EFAULT;\n\t\t\t\tif (c == SBC7240_MAGIC_CHAR) {\n\t\t\t\t\tset_bit(SBC7240_EXPECT_CLOSE_STATUS_BIT,\n\t\t\t\t\t\t&wdt_status);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\twdt_keepalive();\n\t}\n\n\treturn count;\n}\n\nstatic int fop_open(struct inode *inode, struct file *file)\n{\n\tif (test_and_set_bit(SBC7240_OPEN_STATUS_BIT, &wdt_status))\n\t\treturn -EBUSY;\n\n\twdt_enable();\n\n\treturn stream_open(inode, file);\n}\n\nstatic int fop_close(struct inode *inode, struct file *file)\n{\n\tif (test_and_clear_bit(SBC7240_EXPECT_CLOSE_STATUS_BIT, &wdt_status)\n\t    || !nowayout) {\n\t\twdt_disable();\n\t} else {\n\t\tpr_crit(\"Unexpected close, not stopping watchdog!\\n\");\n\t\twdt_keepalive();\n\t}\n\n\tclear_bit(SBC7240_OPEN_STATUS_BIT, &wdt_status);\n\treturn 0;\n}\n\nstatic const struct watchdog_info ident = {\n\t.options = WDIOF_KEEPALIVEPING|\n\t\t   WDIOF_SETTIMEOUT|\n\t\t   WDIOF_MAGICCLOSE,\n\t.firmware_version = 1,\n\t.identity = \"SBC7240\",\n};\n\n\nstatic long fop_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\n{\n\tswitch (cmd) {\n\tcase WDIOC_GETSUPPORT:\n\t\treturn copy_to_user((void __user *)arg, &ident, sizeof(ident))\n\t\t\t\t\t\t ? -EFAULT : 0;\n\tcase WDIOC_GETSTATUS:\n\tcase WDIOC_GETBOOTSTATUS:\n\t\treturn put_user(0, (int __user *)arg);\n\tcase WDIOC_SETOPTIONS:\n\t{\n\t\tint options;\n\t\tint retval = -EINVAL;\n\n\t\tif (get_user(options, (int __user *)arg))\n\t\t\treturn -EFAULT;\n\n\t\tif (options & WDIOS_DISABLECARD) {\n\t\t\twdt_disable();\n\t\t\tretval = 0;\n\t\t}\n\n\t\tif (options & WDIOS_ENABLECARD) {\n\t\t\twdt_enable();\n\t\t\tretval = 0;\n\t\t}\n\n\t\treturn retval;\n\t}\n\tcase WDIOC_KEEPALIVE:\n\t\twdt_keepalive();\n\t\treturn 0;\n\tcase WDIOC_SETTIMEOUT:\n\t{\n\t\tint new_timeout;\n\n\t\tif (get_user(new_timeout, (int __user *)arg))\n\t\t\treturn -EFAULT;\n\n\t\tif (wdt_set_timeout(new_timeout))\n\t\t\treturn -EINVAL;\n\t}\n\t\tfallthrough;\n\tcase WDIOC_GETTIMEOUT:\n\t\treturn put_user(timeout, (int __user *)arg);\n\tdefault:\n\t\treturn -ENOTTY;\n\t}\n}\n\nstatic const struct file_operations wdt_fops = {\n\t.owner = THIS_MODULE,\n\t.llseek = no_llseek,\n\t.write = fop_write,\n\t.open = fop_open,\n\t.release = fop_close,\n\t.unlocked_ioctl = fop_ioctl,\n\t.compat_ioctl = compat_ptr_ioctl,\n};\n\nstatic struct miscdevice wdt_miscdev = {\n\t.minor = WATCHDOG_MINOR,\n\t.name = \"watchdog\",\n\t.fops = &wdt_fops,\n};\n\n \n\nstatic int wdt_notify_sys(struct notifier_block *this, unsigned long code,\n\t\t\t  void *unused)\n{\n\tif (code == SYS_DOWN || code == SYS_HALT)\n\t\twdt_disable();\n\treturn NOTIFY_DONE;\n}\n\nstatic struct notifier_block wdt_notifier = {\n\t.notifier_call = wdt_notify_sys,\n};\n\nstatic void __exit sbc7240_wdt_unload(void)\n{\n\tpr_info(\"Removing watchdog\\n\");\n\tmisc_deregister(&wdt_miscdev);\n\n\tunregister_reboot_notifier(&wdt_notifier);\n\trelease_region(SBC7240_ENABLE_PORT, 1);\n}\n\nstatic int __init sbc7240_wdt_init(void)\n{\n\tint rc = -EBUSY;\n\n\tif (!request_region(SBC7240_ENABLE_PORT, 1, \"SBC7240 WDT\")) {\n\t\tpr_err(\"I/O address 0x%04x already in use\\n\",\n\t\t       SBC7240_ENABLE_PORT);\n\t\trc = -EIO;\n\t\tgoto err_out;\n\t}\n\n\t \n\n\tif (timeout < 1 || timeout > SBC7240_MAX_TIMEOUT) {\n\t\ttimeout = SBC7240_TIMEOUT;\n\t\tpr_info(\"timeout value must be 1<=x<=%d, using %d\\n\",\n\t\t\tSBC7240_MAX_TIMEOUT, timeout);\n\t}\n\twdt_set_timeout(timeout);\n\twdt_disable();\n\n\trc = register_reboot_notifier(&wdt_notifier);\n\tif (rc) {\n\t\tpr_err(\"cannot register reboot notifier (err=%d)\\n\", rc);\n\t\tgoto err_out_region;\n\t}\n\n\trc = misc_register(&wdt_miscdev);\n\tif (rc) {\n\t\tpr_err(\"cannot register miscdev on minor=%d (err=%d)\\n\",\n\t\t       wdt_miscdev.minor, rc);\n\t\tgoto err_out_reboot_notifier;\n\t}\n\n\tpr_info(\"Watchdog driver for SBC7240 initialised (nowayout=%d)\\n\",\n\t\tnowayout);\n\n\treturn 0;\n\nerr_out_reboot_notifier:\n\tunregister_reboot_notifier(&wdt_notifier);\nerr_out_region:\n\trelease_region(SBC7240_ENABLE_PORT, 1);\nerr_out:\n\treturn rc;\n}\n\nmodule_init(sbc7240_wdt_init);\nmodule_exit(sbc7240_wdt_unload);\n\nMODULE_AUTHOR(\"Gilles Gigan\");\nMODULE_DESCRIPTION(\"Watchdog device driver for single board\"\n\t\t   \" computers EPIC Nano 7240 from iEi\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}