{
  "module_name": "moxart_wdt.c",
  "hash_id": "1227e880bbe72b2ef034b4ccc975f0b7325240096e84947cc91667e74e612e5e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/watchdog/moxart_wdt.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/watchdog.h>\n#include <linux/moduleparam.h>\n\n#define REG_COUNT\t\t\t0x4\n#define REG_MODE\t\t\t0x8\n#define REG_ENABLE\t\t\t0xC\n\nstruct moxart_wdt_dev {\n\tstruct watchdog_device dev;\n\tvoid __iomem *base;\n\tunsigned int clock_frequency;\n};\n\nstatic int heartbeat;\n\nstatic int moxart_wdt_restart(struct watchdog_device *wdt_dev,\n\t\t\t      unsigned long action, void *data)\n{\n\tstruct moxart_wdt_dev *moxart_wdt = watchdog_get_drvdata(wdt_dev);\n\n\twritel(1, moxart_wdt->base + REG_COUNT);\n\twritel(0x5ab9, moxart_wdt->base + REG_MODE);\n\twritel(0x03, moxart_wdt->base + REG_ENABLE);\n\n\treturn 0;\n}\n\nstatic int moxart_wdt_stop(struct watchdog_device *wdt_dev)\n{\n\tstruct moxart_wdt_dev *moxart_wdt = watchdog_get_drvdata(wdt_dev);\n\n\twritel(0, moxart_wdt->base + REG_ENABLE);\n\n\treturn 0;\n}\n\nstatic int moxart_wdt_start(struct watchdog_device *wdt_dev)\n{\n\tstruct moxart_wdt_dev *moxart_wdt = watchdog_get_drvdata(wdt_dev);\n\n\twritel(moxart_wdt->clock_frequency * wdt_dev->timeout,\n\t       moxart_wdt->base + REG_COUNT);\n\twritel(0x5ab9, moxart_wdt->base + REG_MODE);\n\twritel(0x03, moxart_wdt->base + REG_ENABLE);\n\n\treturn 0;\n}\n\nstatic int moxart_wdt_set_timeout(struct watchdog_device *wdt_dev,\n\t\t\t\t  unsigned int timeout)\n{\n\twdt_dev->timeout = timeout;\n\n\treturn 0;\n}\n\nstatic const struct watchdog_info moxart_wdt_info = {\n\t.identity       = \"moxart-wdt\",\n\t.options        = WDIOF_SETTIMEOUT | WDIOF_KEEPALIVEPING |\n\t\t\t  WDIOF_MAGICCLOSE,\n};\n\nstatic const struct watchdog_ops moxart_wdt_ops = {\n\t.owner          = THIS_MODULE,\n\t.start          = moxart_wdt_start,\n\t.stop           = moxart_wdt_stop,\n\t.set_timeout    = moxart_wdt_set_timeout,\n\t.restart        = moxart_wdt_restart,\n};\n\nstatic int moxart_wdt_probe(struct platform_device *pdev)\n{\n\tstruct moxart_wdt_dev *moxart_wdt;\n\tstruct device *dev = &pdev->dev;\n\tstruct clk *clk;\n\tint err;\n\tunsigned int max_timeout;\n\tbool nowayout = WATCHDOG_NOWAYOUT;\n\n\tmoxart_wdt = devm_kzalloc(dev, sizeof(*moxart_wdt), GFP_KERNEL);\n\tif (!moxart_wdt)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, moxart_wdt);\n\n\tmoxart_wdt->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(moxart_wdt->base))\n\t\treturn PTR_ERR(moxart_wdt->base);\n\n\tclk = devm_clk_get(dev, NULL);\n\tif (IS_ERR(clk)) {\n\t\tpr_err(\"%s: of_clk_get failed\\n\", __func__);\n\t\treturn PTR_ERR(clk);\n\t}\n\n\tmoxart_wdt->clock_frequency = clk_get_rate(clk);\n\tif (moxart_wdt->clock_frequency == 0) {\n\t\tpr_err(\"%s: incorrect clock frequency\\n\", __func__);\n\t\treturn -EINVAL;\n\t}\n\n\tmax_timeout = UINT_MAX / moxart_wdt->clock_frequency;\n\n\tmoxart_wdt->dev.info = &moxart_wdt_info;\n\tmoxart_wdt->dev.ops = &moxart_wdt_ops;\n\tmoxart_wdt->dev.timeout = max_timeout;\n\tmoxart_wdt->dev.min_timeout = 1;\n\tmoxart_wdt->dev.max_timeout = max_timeout;\n\tmoxart_wdt->dev.parent = dev;\n\n\twatchdog_init_timeout(&moxart_wdt->dev, heartbeat, dev);\n\twatchdog_set_nowayout(&moxart_wdt->dev, nowayout);\n\twatchdog_set_restart_priority(&moxart_wdt->dev, 128);\n\n\twatchdog_set_drvdata(&moxart_wdt->dev, moxart_wdt);\n\n\twatchdog_stop_on_unregister(&moxart_wdt->dev);\n\terr = devm_watchdog_register_device(dev, &moxart_wdt->dev);\n\tif (err)\n\t\treturn err;\n\n\tdev_dbg(dev, \"Watchdog enabled (heartbeat=%d sec, nowayout=%d)\\n\",\n\t\tmoxart_wdt->dev.timeout, nowayout);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id moxart_watchdog_match[] = {\n\t{ .compatible = \"moxa,moxart-watchdog\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, moxart_watchdog_match);\n\nstatic struct platform_driver moxart_wdt_driver = {\n\t.probe      = moxart_wdt_probe,\n\t.driver     = {\n\t\t.name\t\t= \"moxart-watchdog\",\n\t\t.of_match_table\t= moxart_watchdog_match,\n\t},\n};\nmodule_platform_driver(moxart_wdt_driver);\n\nmodule_param(heartbeat, int, 0);\nMODULE_PARM_DESC(heartbeat, \"Watchdog heartbeat in seconds\");\n\nMODULE_DESCRIPTION(\"MOXART watchdog driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Jonas Jensen <jonas.jensen@gmail.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}