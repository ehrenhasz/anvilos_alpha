{
  "module_name": "ts73xx-fpga.c",
  "hash_id": "2c23072c9f7ce97ae547f3c20b9abf76ec3f2b04d900071f54f58fa0798dd1de",
  "original_prompt": "Ingested from linux-6.6.14/drivers/fpga/ts73xx-fpga.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/string.h>\n#include <linux/iopoll.h>\n#include <linux/fpga/fpga-mgr.h>\n\n#define TS73XX_FPGA_DATA_REG\t\t0\n#define TS73XX_FPGA_CONFIG_REG\t\t1\n\n#define TS73XX_FPGA_WRITE_DONE\t\t0x1\n#define TS73XX_FPGA_WRITE_DONE_TIMEOUT\t1000\t \n#define TS73XX_FPGA_RESET\t\t0x2\n#define TS73XX_FPGA_RESET_LOW_DELAY\t30\t \n#define TS73XX_FPGA_RESET_HIGH_DELAY\t80\t \n#define TS73XX_FPGA_LOAD_OK\t\t0x4\n#define TS73XX_FPGA_CONFIG_LOAD\t\t0x8\n\nstruct ts73xx_fpga_priv {\n\tvoid __iomem\t*io_base;\n\tstruct device\t*dev;\n};\n\nstatic int ts73xx_fpga_write_init(struct fpga_manager *mgr,\n\t\t\t\t  struct fpga_image_info *info,\n\t\t\t\t  const char *buf, size_t count)\n{\n\tstruct ts73xx_fpga_priv *priv = mgr->priv;\n\n\t \n\twriteb(0, priv->io_base + TS73XX_FPGA_CONFIG_REG);\n\tudelay(TS73XX_FPGA_RESET_LOW_DELAY);\n\twriteb(TS73XX_FPGA_RESET, priv->io_base + TS73XX_FPGA_CONFIG_REG);\n\tudelay(TS73XX_FPGA_RESET_HIGH_DELAY);\n\n\treturn 0;\n}\n\nstatic int ts73xx_fpga_write(struct fpga_manager *mgr, const char *buf,\n\t\t\t     size_t count)\n{\n\tstruct ts73xx_fpga_priv *priv = mgr->priv;\n\tsize_t i = 0;\n\tint ret;\n\tu8 reg;\n\n\twhile (count--) {\n\t\tret = readb_poll_timeout(priv->io_base + TS73XX_FPGA_CONFIG_REG,\n\t\t\t\t\t reg, !(reg & TS73XX_FPGA_WRITE_DONE),\n\t\t\t\t\t 1, TS73XX_FPGA_WRITE_DONE_TIMEOUT);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\twriteb(buf[i], priv->io_base + TS73XX_FPGA_DATA_REG);\n\t\ti++;\n\t}\n\n\treturn 0;\n}\n\nstatic int ts73xx_fpga_write_complete(struct fpga_manager *mgr,\n\t\t\t\t      struct fpga_image_info *info)\n{\n\tstruct ts73xx_fpga_priv *priv = mgr->priv;\n\tu8 reg;\n\n\tusleep_range(1000, 2000);\n\treg = readb(priv->io_base + TS73XX_FPGA_CONFIG_REG);\n\treg |= TS73XX_FPGA_CONFIG_LOAD;\n\twriteb(reg, priv->io_base + TS73XX_FPGA_CONFIG_REG);\n\n\tusleep_range(1000, 2000);\n\treg = readb(priv->io_base + TS73XX_FPGA_CONFIG_REG);\n\treg &= ~TS73XX_FPGA_CONFIG_LOAD;\n\twriteb(reg, priv->io_base + TS73XX_FPGA_CONFIG_REG);\n\n\treg = readb(priv->io_base + TS73XX_FPGA_CONFIG_REG);\n\tif ((reg & TS73XX_FPGA_LOAD_OK) != TS73XX_FPGA_LOAD_OK)\n\t\treturn -ETIMEDOUT;\n\n\treturn 0;\n}\n\nstatic const struct fpga_manager_ops ts73xx_fpga_ops = {\n\t.write_init\t= ts73xx_fpga_write_init,\n\t.write\t\t= ts73xx_fpga_write,\n\t.write_complete\t= ts73xx_fpga_write_complete,\n};\n\nstatic int ts73xx_fpga_probe(struct platform_device *pdev)\n{\n\tstruct device *kdev = &pdev->dev;\n\tstruct ts73xx_fpga_priv *priv;\n\tstruct fpga_manager *mgr;\n\n\tpriv = devm_kzalloc(kdev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = kdev;\n\n\tpriv->io_base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(priv->io_base))\n\t\treturn PTR_ERR(priv->io_base);\n\n\tmgr = devm_fpga_mgr_register(kdev, \"TS-73xx FPGA Manager\",\n\t\t\t\t     &ts73xx_fpga_ops, priv);\n\treturn PTR_ERR_OR_ZERO(mgr);\n}\n\nstatic struct platform_driver ts73xx_fpga_driver = {\n\t.driver\t= {\n\t\t.name\t= \"ts73xx-fpga-mgr\",\n\t},\n\t.probe\t= ts73xx_fpga_probe,\n};\nmodule_platform_driver(ts73xx_fpga_driver);\n\nMODULE_AUTHOR(\"Florian Fainelli <f.fainelli@gmail.com>\");\nMODULE_DESCRIPTION(\"TS-73xx FPGA Manager driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}