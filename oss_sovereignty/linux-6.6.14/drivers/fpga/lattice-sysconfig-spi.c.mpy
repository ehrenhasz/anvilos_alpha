{
  "module_name": "lattice-sysconfig-spi.c",
  "hash_id": "e49d5c3cfbb94cf0be9b2333d46305b9c0c5bc69a02d92869128af4d9d843432",
  "original_prompt": "Ingested from linux-6.6.14/drivers/fpga/lattice-sysconfig-spi.c",
  "human_readable_source": "\n \n\n#include <linux/of.h>\n#include <linux/spi/spi.h>\n\n#include \"lattice-sysconfig.h\"\n\nstatic const u32 ecp5_spi_max_speed_hz = 60000000;\n\nstatic int sysconfig_spi_cmd_transfer(struct sysconfig_priv *priv,\n\t\t\t\t      const void *tx_buf, size_t tx_len,\n\t\t\t\t      void *rx_buf, size_t rx_len)\n{\n\tstruct spi_device *spi = to_spi_device(priv->dev);\n\n\treturn spi_write_then_read(spi, tx_buf, tx_len, rx_buf, rx_len);\n}\n\nstatic int sysconfig_spi_bitstream_burst_init(struct sysconfig_priv *priv)\n{\n\tconst u8 lsc_bitstream_burst[] = SYSCONFIG_LSC_BITSTREAM_BURST;\n\tstruct spi_device *spi = to_spi_device(priv->dev);\n\tstruct spi_transfer xfer = {};\n\tstruct spi_message msg;\n\tsize_t buf_len;\n\tvoid *buf;\n\tint ret;\n\n\tbuf_len = sizeof(lsc_bitstream_burst);\n\n\tbuf = kmemdup(lsc_bitstream_burst, buf_len, GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\txfer.len = buf_len;\n\txfer.tx_buf = buf;\n\txfer.cs_change = 1;\n\n\tspi_message_init_with_transfers(&msg, &xfer, 1);\n\n\t \n\tspi_bus_lock(spi->controller);\n\n\tret = spi_sync_locked(spi, &msg);\n\tif (ret)\n\t\tspi_bus_unlock(spi->controller);\n\n\tkfree(buf);\n\n\treturn ret;\n}\n\nstatic int sysconfig_spi_bitstream_burst_write(struct sysconfig_priv *priv,\n\t\t\t\t\t       const char *buf, size_t len)\n{\n\tstruct spi_device *spi = to_spi_device(priv->dev);\n\tstruct spi_transfer xfer = {\n\t\t.tx_buf = buf,\n\t\t.len = len,\n\t\t.cs_change = 1,\n\t};\n\tstruct spi_message msg;\n\n\tspi_message_init_with_transfers(&msg, &xfer, 1);\n\n\treturn spi_sync_locked(spi, &msg);\n}\n\nstatic int sysconfig_spi_bitstream_burst_complete(struct sysconfig_priv *priv)\n{\n\tstruct spi_device *spi = to_spi_device(priv->dev);\n\n\t \n\tspi_bus_unlock(spi->controller);\n\n\t \n\treturn spi_write(spi, NULL, 0);\n}\n\nstatic int sysconfig_spi_probe(struct spi_device *spi)\n{\n\tconst struct spi_device_id *dev_id;\n\tstruct device *dev = &spi->dev;\n\tstruct sysconfig_priv *priv;\n\tconst u32 *spi_max_speed;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tspi_max_speed = device_get_match_data(dev);\n\tif (!spi_max_speed) {\n\t\tdev_id = spi_get_device_id(spi);\n\t\tif (!dev_id)\n\t\t\treturn -ENODEV;\n\n\t\tspi_max_speed = (const u32 *)dev_id->driver_data;\n\t}\n\n\tif (!spi_max_speed)\n\t\treturn -EINVAL;\n\n\tif (spi->max_speed_hz > *spi_max_speed) {\n\t\tdev_err(dev, \"SPI speed %u is too high, maximum speed is %u\\n\",\n\t\t\tspi->max_speed_hz, *spi_max_speed);\n\t\treturn -EINVAL;\n\t}\n\n\tpriv->dev = dev;\n\tpriv->command_transfer = sysconfig_spi_cmd_transfer;\n\tpriv->bitstream_burst_write_init = sysconfig_spi_bitstream_burst_init;\n\tpriv->bitstream_burst_write = sysconfig_spi_bitstream_burst_write;\n\tpriv->bitstream_burst_write_complete = sysconfig_spi_bitstream_burst_complete;\n\n\treturn sysconfig_probe(priv);\n}\n\nstatic const struct spi_device_id sysconfig_spi_ids[] = {\n\t{\n\t\t.name = \"sysconfig-ecp5\",\n\t\t.driver_data = (kernel_ulong_t)&ecp5_spi_max_speed_hz,\n\t}, {},\n};\nMODULE_DEVICE_TABLE(spi, sysconfig_spi_ids);\n\n#if IS_ENABLED(CONFIG_OF)\nstatic const struct of_device_id sysconfig_of_ids[] = {\n\t{\n\t\t.compatible = \"lattice,sysconfig-ecp5\",\n\t\t.data = &ecp5_spi_max_speed_hz,\n\t}, {},\n};\nMODULE_DEVICE_TABLE(of, sysconfig_of_ids);\n#endif  \n\nstatic struct spi_driver lattice_sysconfig_driver = {\n\t.probe = sysconfig_spi_probe,\n\t.id_table = sysconfig_spi_ids,\n\t.driver = {\n\t\t.name = \"lattice_sysconfig_spi_fpga_mgr\",\n\t\t.of_match_table = of_match_ptr(sysconfig_of_ids),\n\t},\n};\nmodule_spi_driver(lattice_sysconfig_driver);\n\nMODULE_DESCRIPTION(\"Lattice sysCONFIG Slave SPI FPGA Manager\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}