{
  "module_name": "zynqmp-fpga.c",
  "hash_id": "cf8f6feae8656caeb20a90de81d0d51644848474ee1bab2b7b9c6a4f9469137f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/fpga/zynqmp-fpga.c",
  "human_readable_source": "\n \n\n#include <linux/dma-mapping.h>\n#include <linux/fpga/fpga-mgr.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of_address.h>\n#include <linux/string.h>\n#include <linux/firmware/xlnx-zynqmp.h>\n\n \n#define IXR_FPGA_DONE_MASK\tBIT(3)\n\n \nstruct zynqmp_fpga_priv {\n\tstruct device *dev;\n\tu32 flags;\n};\n\nstatic int zynqmp_fpga_ops_write_init(struct fpga_manager *mgr,\n\t\t\t\t      struct fpga_image_info *info,\n\t\t\t\t      const char *buf, size_t size)\n{\n\tstruct zynqmp_fpga_priv *priv;\n\n\tpriv = mgr->priv;\n\tpriv->flags = info->flags;\n\n\treturn 0;\n}\n\nstatic int zynqmp_fpga_ops_write(struct fpga_manager *mgr,\n\t\t\t\t const char *buf, size_t size)\n{\n\tstruct zynqmp_fpga_priv *priv;\n\tdma_addr_t dma_addr;\n\tu32 eemi_flags = 0;\n\tchar *kbuf;\n\tint ret;\n\n\tpriv = mgr->priv;\n\n\tkbuf = dma_alloc_coherent(priv->dev, size, &dma_addr, GFP_KERNEL);\n\tif (!kbuf)\n\t\treturn -ENOMEM;\n\n\tmemcpy(kbuf, buf, size);\n\n\twmb();  \n\n\tif (priv->flags & FPGA_MGR_PARTIAL_RECONFIG)\n\t\teemi_flags |= XILINX_ZYNQMP_PM_FPGA_PARTIAL;\n\n\tret = zynqmp_pm_fpga_load(dma_addr, size, eemi_flags);\n\n\tdma_free_coherent(priv->dev, size, kbuf, dma_addr);\n\n\treturn ret;\n}\n\nstatic enum fpga_mgr_states zynqmp_fpga_ops_state(struct fpga_manager *mgr)\n{\n\tu32 status = 0;\n\n\tzynqmp_pm_fpga_get_status(&status);\n\tif (status & IXR_FPGA_DONE_MASK)\n\t\treturn FPGA_MGR_STATE_OPERATING;\n\n\treturn FPGA_MGR_STATE_UNKNOWN;\n}\n\nstatic ssize_t status_show(struct device *dev,\n\t\t\t   struct device_attribute *attr, char *buf)\n{\n\tu32 status;\n\tint ret;\n\n\tret = zynqmp_pm_fpga_get_config_status(&status);\n\tif (ret)\n\t\treturn ret;\n\n\treturn sysfs_emit(buf, \"0x%x\\n\", status);\n}\nstatic DEVICE_ATTR_RO(status);\n\nstatic struct attribute *zynqmp_fpga_attrs[] = {\n\t&dev_attr_status.attr,\n\tNULL,\n};\nATTRIBUTE_GROUPS(zynqmp_fpga);\n\nstatic const struct fpga_manager_ops zynqmp_fpga_ops = {\n\t.state = zynqmp_fpga_ops_state,\n\t.write_init = zynqmp_fpga_ops_write_init,\n\t.write = zynqmp_fpga_ops_write,\n};\n\nstatic int zynqmp_fpga_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct zynqmp_fpga_priv *priv;\n\tstruct fpga_manager *mgr;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = dev;\n\n\tmgr = devm_fpga_mgr_register(dev, \"Xilinx ZynqMP FPGA Manager\",\n\t\t\t\t     &zynqmp_fpga_ops, priv);\n\treturn PTR_ERR_OR_ZERO(mgr);\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id zynqmp_fpga_of_match[] = {\n\t{ .compatible = \"xlnx,zynqmp-pcap-fpga\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, zynqmp_fpga_of_match);\n#endif\n\nstatic struct platform_driver zynqmp_fpga_driver = {\n\t.probe = zynqmp_fpga_probe,\n\t.driver = {\n\t\t.name = \"zynqmp_fpga_manager\",\n\t\t.of_match_table = of_match_ptr(zynqmp_fpga_of_match),\n\t\t.dev_groups = zynqmp_fpga_groups,\n\t},\n};\n\nmodule_platform_driver(zynqmp_fpga_driver);\n\nMODULE_AUTHOR(\"Nava kishore Manne <navam@xilinx.com>\");\nMODULE_DESCRIPTION(\"Xilinx ZynqMp FPGA Manager\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}