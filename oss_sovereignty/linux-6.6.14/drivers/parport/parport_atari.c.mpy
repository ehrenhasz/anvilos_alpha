{
  "module_name": "parport_atari.c",
  "hash_id": "409a53a60bea85e8098c5ea2996ea5e9672f0c3aec94fff72481b16172a61230",
  "original_prompt": "Ingested from linux-6.6.14/drivers/parport/parport_atari.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/parport.h>\n#include <linux/interrupt.h>\n#include <asm/setup.h>\n#include <asm/atarihw.h>\n#include <asm/irq.h>\n#include <asm/atariints.h>\n\nstatic struct parport *this_port;\n\nstatic unsigned char\nparport_atari_read_data(struct parport *p)\n{\n\tunsigned long flags;\n\tunsigned char data;\n\n\tlocal_irq_save(flags);\n\tsound_ym.rd_data_reg_sel = 15;\n\tdata = sound_ym.rd_data_reg_sel;\n\tlocal_irq_restore(flags);\n\treturn data;\n}\n\nstatic void\nparport_atari_write_data(struct parport *p, unsigned char data)\n{\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\tsound_ym.rd_data_reg_sel = 15;\n\tsound_ym.wd_data = data;\n\tlocal_irq_restore(flags);\n}\n\nstatic unsigned char\nparport_atari_read_control(struct parport *p)\n{\n\tunsigned long flags;\n\tunsigned char control = 0;\n\n\tlocal_irq_save(flags);\n\tsound_ym.rd_data_reg_sel = 14;\n\tif (!(sound_ym.rd_data_reg_sel & (1 << 5)))\n\t\tcontrol = PARPORT_CONTROL_STROBE;\n\tlocal_irq_restore(flags);\n\treturn control;\n}\n\nstatic void\nparport_atari_write_control(struct parport *p, unsigned char control)\n{\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\tsound_ym.rd_data_reg_sel = 14;\n\tif (control & PARPORT_CONTROL_STROBE)\n\t\tsound_ym.wd_data = sound_ym.rd_data_reg_sel & ~(1 << 5);\n\telse\n\t\tsound_ym.wd_data = sound_ym.rd_data_reg_sel | (1 << 5);\n\tlocal_irq_restore(flags);\n}\n\nstatic unsigned char\nparport_atari_frob_control(struct parport *p, unsigned char mask,\n\t\t\t   unsigned char val)\n{\n\tunsigned char old = parport_atari_read_control(p);\n\tparport_atari_write_control(p, (old & ~mask) ^ val);\n\treturn old;\n}\n\nstatic unsigned char\nparport_atari_read_status(struct parport *p)\n{\n\treturn ((st_mfp.par_dt_reg & 1 ? 0 : PARPORT_STATUS_BUSY) |\n\t\tPARPORT_STATUS_SELECT | PARPORT_STATUS_ERROR);\n}\n\nstatic void\nparport_atari_init_state(struct pardevice *d, struct parport_state *s)\n{\n}\n\nstatic void\nparport_atari_save_state(struct parport *p, struct parport_state *s)\n{\n}\n\nstatic void\nparport_atari_restore_state(struct parport *p, struct parport_state *s)\n{\n}\n\nstatic void\nparport_atari_enable_irq(struct parport *p)\n{\n\tenable_irq(IRQ_MFP_BUSY);\n}\n\nstatic void\nparport_atari_disable_irq(struct parport *p)\n{\n\tdisable_irq(IRQ_MFP_BUSY);\n}\n\nstatic void\nparport_atari_data_forward(struct parport *p)\n{\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\t \n\tsound_ym.rd_data_reg_sel = 7;\n\tsound_ym.wd_data = sound_ym.rd_data_reg_sel | 0x40;\n\tlocal_irq_restore(flags);\n}\n\nstatic void\nparport_atari_data_reverse(struct parport *p)\n{\n}\n\nstatic struct parport_operations parport_atari_ops = {\n\t.write_data\t= parport_atari_write_data,\n\t.read_data\t= parport_atari_read_data,\n\n\t.write_control\t= parport_atari_write_control,\n\t.read_control\t= parport_atari_read_control,\n\t.frob_control\t= parport_atari_frob_control,\n\n\t.read_status\t= parport_atari_read_status,\n\n\t.enable_irq\t= parport_atari_enable_irq,\n\t.disable_irq\t= parport_atari_disable_irq,\n\n\t.data_forward\t= parport_atari_data_forward,\n\t.data_reverse\t= parport_atari_data_reverse,\n\n\t.init_state\t= parport_atari_init_state,\n\t.save_state\t= parport_atari_save_state,\n\t.restore_state\t= parport_atari_restore_state,\n\n\t.epp_write_data\t= parport_ieee1284_epp_write_data,\n\t.epp_read_data\t= parport_ieee1284_epp_read_data,\n\t.epp_write_addr\t= parport_ieee1284_epp_write_addr,\n\t.epp_read_addr\t= parport_ieee1284_epp_read_addr,\n\n\t.ecp_write_data\t= parport_ieee1284_ecp_write_data,\n\t.ecp_read_data\t= parport_ieee1284_ecp_read_data,\n\t.ecp_write_addr\t= parport_ieee1284_ecp_write_addr,\n\n\t.compat_write_data\t= parport_ieee1284_write_compat,\n\t.nibble_read_data\t= parport_ieee1284_read_nibble,\n\t.byte_read_data\t\t= parport_ieee1284_read_byte,\n\n\t.owner\t\t= THIS_MODULE,\n};\n\n\nstatic int __init parport_atari_init(void)\n{\n\tstruct parport *p;\n\tunsigned long flags;\n\n\tif (MACH_IS_ATARI) {\n\t\tlocal_irq_save(flags);\n\t\t \n\t\tsound_ym.rd_data_reg_sel = 7;\n\t\tsound_ym.wd_data = (sound_ym.rd_data_reg_sel & 0x3f) | 0xc0;\n\t\t \n\t\tsound_ym.rd_data_reg_sel = 14;\n\t\tsound_ym.wd_data = sound_ym.rd_data_reg_sel | (1 << 5);\n\t\tlocal_irq_restore(flags);\n\t\t \n\t\tst_mfp.data_dir &= ~1;\n\t\t \n\t\tst_mfp.active_edge &= ~1;\n\t\tp = parport_register_port((unsigned long)&sound_ym.wd_data,\n\t\t\t\t\t  IRQ_MFP_BUSY, PARPORT_DMA_NONE,\n\t\t\t\t\t  &parport_atari_ops);\n\t\tif (!p)\n\t\t\treturn -ENODEV;\n\t\tif (request_irq(IRQ_MFP_BUSY, parport_irq_handler, 0, p->name,\n\t\t\t\tp)) {\n\t\t\tparport_put_port (p);\n\t\t\treturn -ENODEV;\n\t\t}\n\n\t\tthis_port = p;\n\t\tpr_info(\"%s: Atari built-in port using irq\\n\", p->name);\n\t\tparport_announce_port (p);\n\n\t\treturn 0;\n\t}\n\treturn -ENODEV;\n}\n\nstatic void __exit parport_atari_exit(void)\n{\n\tparport_remove_port(this_port);\n\tif (this_port->irq != PARPORT_IRQ_NONE)\n\t\tfree_irq(IRQ_MFP_BUSY, this_port);\n\tparport_put_port(this_port);\n}\n\nMODULE_AUTHOR(\"Andreas Schwab\");\nMODULE_DESCRIPTION(\"Parport Driver for Atari builtin Port\");\nMODULE_LICENSE(\"GPL\");\n\nmodule_init(parport_atari_init)\nmodule_exit(parport_atari_exit)\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}