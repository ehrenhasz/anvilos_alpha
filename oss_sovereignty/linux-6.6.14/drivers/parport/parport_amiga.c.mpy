{
  "module_name": "parport_amiga.c",
  "hash_id": "11e3255b07cdb95d4fdccd394d25ee7881194dc284f9fb416a48b946c36da3f9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/parport/parport_amiga.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/parport.h>\n#include <linux/ioport.h>\n#include <linux/interrupt.h>\n#include <linux/platform_device.h>\n\n#include <asm/setup.h>\n#include <asm/amigahw.h>\n#include <asm/irq.h>\n#include <asm/io.h>\n#include <asm/amigaints.h>\n\n#undef DEBUG\n\nstatic void amiga_write_data(struct parport *p, unsigned char data)\n{\n\tpr_debug(\"write_data %c\\n\", data);\n\t \n\tciaa.prb = data;\n\tmb();\n}\n\nstatic unsigned char amiga_read_data(struct parport *p)\n{\n\t \n\treturn ciaa.prb;\n}\n\nstatic unsigned char control_amiga_to_pc(unsigned char control)\n{\n\treturn PARPORT_CONTROL_SELECT |\n\t      PARPORT_CONTROL_AUTOFD | PARPORT_CONTROL_STROBE;\n\t \n}\n\nstatic void amiga_write_control(struct parport *p, unsigned char control)\n{\n\tpr_debug(\"write_control %02x\\n\", control);\n\t \n}\n\t\nstatic unsigned char amiga_read_control( struct parport *p)\n{\n\tpr_debug(\"read_control\\n\");\n\treturn control_amiga_to_pc(0);\n}\n\nstatic unsigned char amiga_frob_control( struct parport *p, unsigned char mask, unsigned char val)\n{\n\tunsigned char old;\n\n\tpr_debug(\"frob_control mask %02x, value %02x\\n\", mask, val);\n\told = amiga_read_control(p);\n\tamiga_write_control(p, (old & ~mask) ^ val);\n\treturn old;\n}\n\nstatic unsigned char status_amiga_to_pc(unsigned char status)\n{\n\tunsigned char ret = PARPORT_STATUS_BUSY | PARPORT_STATUS_ACK | PARPORT_STATUS_ERROR;\n\n\tif (status & 1)  \n\t\tret &= ~PARPORT_STATUS_BUSY;\n\tif (status & 2)  \n\t\tret |= PARPORT_STATUS_PAPEROUT;\n\tif (status & 4)  \n\t\tret |= PARPORT_STATUS_SELECT;\n\t \n\n\treturn ret;\n}\n\nstatic unsigned char amiga_read_status(struct parport *p)\n{\n\tunsigned char status;\n\n\tstatus = status_amiga_to_pc(ciab.pra & 7);\n\tpr_debug(\"read_status %02x\\n\", status);\n\treturn status;\n}\n\nstatic void amiga_enable_irq(struct parport *p)\n{\n\tenable_irq(IRQ_AMIGA_CIAA_FLG);\n}\n\nstatic void amiga_disable_irq(struct parport *p)\n{\n\tdisable_irq(IRQ_AMIGA_CIAA_FLG);\n}\n\nstatic void amiga_data_forward(struct parport *p)\n{\n\tpr_debug(\"forward\\n\");\n\tciaa.ddrb = 0xff;  \n\tmb();\n}\n\nstatic void amiga_data_reverse(struct parport *p)\n{\n\tpr_debug(\"reverse\\n\");\n\tciaa.ddrb = 0;  \n\tmb();\n}\n\nstatic void amiga_init_state(struct pardevice *dev, struct parport_state *s)\n{\n\ts->u.amiga.data = 0;\n\ts->u.amiga.datadir = 255;\n\ts->u.amiga.status = 0;\n\ts->u.amiga.statusdir = 0;\n}\n\nstatic void amiga_save_state(struct parport *p, struct parport_state *s)\n{\n\tmb();\n\ts->u.amiga.data = ciaa.prb;\n\ts->u.amiga.datadir = ciaa.ddrb;\n\ts->u.amiga.status = ciab.pra & 7;\n\ts->u.amiga.statusdir = ciab.ddra & 7;\n\tmb();\n}\n\nstatic void amiga_restore_state(struct parport *p, struct parport_state *s)\n{\n\tmb();\n\tciaa.prb = s->u.amiga.data;\n\tciaa.ddrb = s->u.amiga.datadir;\n\tciab.pra |= (ciab.pra & 0xf8) | s->u.amiga.status;\n\tciab.ddra |= (ciab.ddra & 0xf8) | s->u.amiga.statusdir;\n\tmb();\n}\n\nstatic struct parport_operations pp_amiga_ops = {\n\t.write_data\t= amiga_write_data,\n\t.read_data\t= amiga_read_data,\n\n\t.write_control\t= amiga_write_control,\n\t.read_control\t= amiga_read_control,\n\t.frob_control\t= amiga_frob_control,\n\n\t.read_status\t= amiga_read_status,\n\n\t.enable_irq\t= amiga_enable_irq,\n\t.disable_irq\t= amiga_disable_irq,\n\n\t.data_forward\t= amiga_data_forward,\n\t.data_reverse\t= amiga_data_reverse,\n\n\t.init_state\t= amiga_init_state,\n\t.save_state\t= amiga_save_state,\n\t.restore_state\t= amiga_restore_state,\n\n\t.epp_write_data\t= parport_ieee1284_epp_write_data,\n\t.epp_read_data\t= parport_ieee1284_epp_read_data,\n\t.epp_write_addr\t= parport_ieee1284_epp_write_addr,\n\t.epp_read_addr\t= parport_ieee1284_epp_read_addr,\n\n\t.ecp_write_data\t= parport_ieee1284_ecp_write_data,\n\t.ecp_read_data\t= parport_ieee1284_ecp_read_data,\n\t.ecp_write_addr\t= parport_ieee1284_ecp_write_addr,\n\n\t.compat_write_data\t= parport_ieee1284_write_compat,\n\t.nibble_read_data\t= parport_ieee1284_read_nibble,\n\t.byte_read_data\t\t= parport_ieee1284_read_byte,\n\n\t.owner\t\t= THIS_MODULE,\n};\n\n \n\nstatic int __init amiga_parallel_probe(struct platform_device *pdev)\n{\n\tstruct parport *p;\n\tint err;\n\n\tciaa.ddrb = 0xff;\n\tciab.ddra &= 0xf8;\n\tmb();\n\n\tp = parport_register_port((unsigned long)&ciaa.prb, IRQ_AMIGA_CIAA_FLG,\n\t\t\t\t   PARPORT_DMA_NONE, &pp_amiga_ops);\n\tif (!p)\n\t\treturn -EBUSY;\n\n\terr = request_irq(IRQ_AMIGA_CIAA_FLG, parport_irq_handler, 0, p->name,\n\t\t\t  p);\n\tif (err)\n\t\tgoto out_irq;\n\n\tpr_info(\"%s: Amiga built-in port using irq\\n\", p->name);\n\t \n\tparport_announce_port(p);\n\n\tplatform_set_drvdata(pdev, p);\n\n\treturn 0;\n\nout_irq:\n\tparport_put_port(p);\n\treturn err;\n}\n\nstatic int __exit amiga_parallel_remove(struct platform_device *pdev)\n{\n\tstruct parport *port = platform_get_drvdata(pdev);\n\n\tparport_remove_port(port);\n\tif (port->irq != PARPORT_IRQ_NONE)\n\t\tfree_irq(IRQ_AMIGA_CIAA_FLG, port);\n\tparport_put_port(port);\n\treturn 0;\n}\n\nstatic struct platform_driver amiga_parallel_driver = {\n\t.remove = __exit_p(amiga_parallel_remove),\n\t.driver   = {\n\t\t.name\t= \"amiga-parallel\",\n\t},\n};\n\nmodule_platform_driver_probe(amiga_parallel_driver, amiga_parallel_probe);\n\nMODULE_AUTHOR(\"Joerg Dorchain <joerg@dorchain.net>\");\nMODULE_DESCRIPTION(\"Parport Driver for Amiga builtin Port\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:amiga-parallel\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}