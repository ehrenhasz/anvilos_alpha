{
  "module_name": "iscsi_target_tmr.c",
  "hash_id": "fe491882ea14ec843f6747817f13dc97f5339be146f40254fe9101b5d1f379cb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/target/iscsi/iscsi_target_tmr.c",
  "human_readable_source": "\n \n\n#include <asm/unaligned.h>\n#include <scsi/scsi_proto.h>\n#include <scsi/iscsi_proto.h>\n#include <target/target_core_base.h>\n#include <target/target_core_fabric.h>\n#include <target/iscsi/iscsi_transport.h>\n\n#include <target/iscsi/iscsi_target_core.h>\n#include \"iscsi_target_seq_pdu_list.h\"\n#include \"iscsi_target_datain_values.h\"\n#include \"iscsi_target_device.h\"\n#include \"iscsi_target_erl0.h\"\n#include \"iscsi_target_erl1.h\"\n#include \"iscsi_target_erl2.h\"\n#include \"iscsi_target_tmr.h\"\n#include \"iscsi_target_tpg.h\"\n#include \"iscsi_target_util.h\"\n#include \"iscsi_target.h\"\n\nu8 iscsit_tmr_abort_task(\n\tstruct iscsit_cmd *cmd,\n\tunsigned char *buf)\n{\n\tstruct iscsit_cmd *ref_cmd;\n\tstruct iscsit_conn *conn = cmd->conn;\n\tstruct iscsi_tmr_req *tmr_req = cmd->tmr_req;\n\tstruct se_tmr_req *se_tmr = cmd->se_cmd.se_tmr_req;\n\tstruct iscsi_tm *hdr = (struct iscsi_tm *) buf;\n\n\tref_cmd = iscsit_find_cmd_from_itt(conn, hdr->rtt);\n\tif (!ref_cmd) {\n\t\tpr_err(\"Unable to locate RefTaskTag: 0x%08x on CID:\"\n\t\t\t\" %hu.\\n\", hdr->rtt, conn->cid);\n\t\treturn (iscsi_sna_gte(be32_to_cpu(hdr->refcmdsn), conn->sess->exp_cmd_sn) &&\n\t\t\tiscsi_sna_lte(be32_to_cpu(hdr->refcmdsn), (u32) atomic_read(&conn->sess->max_cmd_sn))) ?\n\t\t\tISCSI_TMF_RSP_COMPLETE : ISCSI_TMF_RSP_NO_TASK;\n\t}\n\tif (ref_cmd->cmd_sn != be32_to_cpu(hdr->refcmdsn)) {\n\t\tpr_err(\"RefCmdSN 0x%08x does not equal\"\n\t\t\t\" task's CmdSN 0x%08x. Rejecting ABORT_TASK.\\n\",\n\t\t\thdr->refcmdsn, ref_cmd->cmd_sn);\n\t\treturn ISCSI_TMF_RSP_REJECTED;\n\t}\n\n\tse_tmr->ref_task_tag\t\t= (__force u32)hdr->rtt;\n\ttmr_req->ref_cmd\t\t= ref_cmd;\n\ttmr_req->exp_data_sn\t\t= be32_to_cpu(hdr->exp_datasn);\n\n\treturn ISCSI_TMF_RSP_COMPLETE;\n}\n\n \nint iscsit_tmr_task_warm_reset(\n\tstruct iscsit_conn *conn,\n\tstruct iscsi_tmr_req *tmr_req,\n\tunsigned char *buf)\n{\n\tstruct iscsit_session *sess = conn->sess;\n\tstruct iscsi_node_attrib *na = iscsit_tpg_get_node_attrib(sess);\n\n\tif (!na->tmr_warm_reset) {\n\t\tpr_err(\"TMR Opcode TARGET_WARM_RESET authorization\"\n\t\t\t\" failed for Initiator Node: %s\\n\",\n\t\t\tsess->se_sess->se_node_acl->initiatorname);\n\t\treturn -1;\n\t}\n\t \n\treturn 0;\n}\n\nint iscsit_tmr_task_cold_reset(\n\tstruct iscsit_conn *conn,\n\tstruct iscsi_tmr_req *tmr_req,\n\tunsigned char *buf)\n{\n\tstruct iscsit_session *sess = conn->sess;\n\tstruct iscsi_node_attrib *na = iscsit_tpg_get_node_attrib(sess);\n\n\tif (!na->tmr_cold_reset) {\n\t\tpr_err(\"TMR Opcode TARGET_COLD_RESET authorization\"\n\t\t\t\" failed for Initiator Node: %s\\n\",\n\t\t\tsess->se_sess->se_node_acl->initiatorname);\n\t\treturn -1;\n\t}\n\t \n\treturn 0;\n}\n\nu8 iscsit_tmr_task_reassign(\n\tstruct iscsit_cmd *cmd,\n\tunsigned char *buf)\n{\n\tstruct iscsit_cmd *ref_cmd = NULL;\n\tstruct iscsit_conn *conn = cmd->conn;\n\tstruct iscsi_conn_recovery *cr = NULL;\n\tstruct iscsi_tmr_req *tmr_req = cmd->tmr_req;\n\tstruct se_tmr_req *se_tmr = cmd->se_cmd.se_tmr_req;\n\tstruct iscsi_tm *hdr = (struct iscsi_tm *) buf;\n\tu64 ret, ref_lun;\n\n\tpr_debug(\"Got TASK_REASSIGN TMR ITT: 0x%08x,\"\n\t\t\" RefTaskTag: 0x%08x, ExpDataSN: 0x%08x, CID: %hu\\n\",\n\t\thdr->itt, hdr->rtt, hdr->exp_datasn, conn->cid);\n\n\tif (conn->sess->sess_ops->ErrorRecoveryLevel != 2) {\n\t\tpr_err(\"TMR TASK_REASSIGN not supported in ERL<2,\"\n\t\t\t\t\" ignoring request.\\n\");\n\t\treturn ISCSI_TMF_RSP_NOT_SUPPORTED;\n\t}\n\n\tret = iscsit_find_cmd_for_recovery(conn->sess, &ref_cmd, &cr, hdr->rtt);\n\tif (ret == -2) {\n\t\tpr_err(\"Command ITT: 0x%08x is still alligent to CID:\"\n\t\t\t\" %hu\\n\", ref_cmd->init_task_tag, cr->cid);\n\t\treturn ISCSI_TMF_RSP_TASK_ALLEGIANT;\n\t} else if (ret == -1) {\n\t\tpr_err(\"Unable to locate RefTaskTag: 0x%08x in\"\n\t\t\t\" connection recovery command list.\\n\", hdr->rtt);\n\t\treturn ISCSI_TMF_RSP_NO_TASK;\n\t}\n\t \n\tif (cr->maxrecvdatasegmentlength !=\n\t    conn->conn_ops->MaxRecvDataSegmentLength) {\n\t\tpr_err(\"Unable to perform connection recovery for\"\n\t\t\t\" differing MaxRecvDataSegmentLength, rejecting\"\n\t\t\t\" TMR TASK_REASSIGN.\\n\");\n\t\treturn ISCSI_TMF_RSP_REJECTED;\n\t}\n\tif (cr->maxxmitdatasegmentlength !=\n\t    conn->conn_ops->MaxXmitDataSegmentLength) {\n\t\tpr_err(\"Unable to perform connection recovery for\"\n\t\t\t\" differing MaxXmitDataSegmentLength, rejecting\"\n\t\t\t\" TMR TASK_REASSIGN.\\n\");\n\t\treturn ISCSI_TMF_RSP_REJECTED;\n\t}\n\n\tref_lun = scsilun_to_int(&hdr->lun);\n\tif (ref_lun != ref_cmd->se_cmd.orig_fe_lun) {\n\t\tpr_err(\"Unable to perform connection recovery for\"\n\t\t\t\" differing ref_lun: %llu ref_cmd orig_fe_lun: %llu\\n\",\n\t\t\tref_lun, ref_cmd->se_cmd.orig_fe_lun);\n\t\treturn ISCSI_TMF_RSP_REJECTED;\n\t}\n\n\tse_tmr->ref_task_tag\t\t= (__force u32)hdr->rtt;\n\ttmr_req->ref_cmd\t\t= ref_cmd;\n\ttmr_req->exp_data_sn\t\t= be32_to_cpu(hdr->exp_datasn);\n\ttmr_req->conn_recovery\t\t= cr;\n\ttmr_req->task_reassign\t\t= 1;\n\t \n\treturn ISCSI_TMF_RSP_COMPLETE;\n}\n\nstatic void iscsit_task_reassign_remove_cmd(\n\tstruct iscsit_cmd *cmd,\n\tstruct iscsi_conn_recovery *cr,\n\tstruct iscsit_session *sess)\n{\n\tint ret;\n\n\tspin_lock(&cr->conn_recovery_cmd_lock);\n\tret = iscsit_remove_cmd_from_connection_recovery(cmd, sess);\n\tspin_unlock(&cr->conn_recovery_cmd_lock);\n\tif (!ret) {\n\t\tpr_debug(\"iSCSI connection recovery successful for CID:\"\n\t\t\t\" %hu on SID: %u\\n\", cr->cid, sess->sid);\n\t\tiscsit_remove_active_connection_recovery_entry(cr, sess);\n\t}\n}\n\nstatic int iscsit_task_reassign_complete_nop_out(\n\tstruct iscsi_tmr_req *tmr_req,\n\tstruct iscsit_conn *conn)\n{\n\tstruct iscsit_cmd *cmd = tmr_req->ref_cmd;\n\tstruct iscsi_conn_recovery *cr;\n\n\tif (!cmd->cr) {\n\t\tpr_err(\"struct iscsi_conn_recovery pointer for ITT: 0x%08x\"\n\t\t\t\" is NULL!\\n\", cmd->init_task_tag);\n\t\treturn -1;\n\t}\n\tcr = cmd->cr;\n\n\t \n\tcmd->stat_sn = cmd->exp_stat_sn = 0;\n\n\tiscsit_task_reassign_remove_cmd(cmd, cr, conn->sess);\n\n\tspin_lock_bh(&conn->cmd_lock);\n\tlist_add_tail(&cmd->i_conn_node, &conn->conn_cmd_list);\n\tspin_unlock_bh(&conn->cmd_lock);\n\n\tcmd->i_state = ISTATE_SEND_NOPIN;\n\tiscsit_add_cmd_to_response_queue(cmd, conn, cmd->i_state);\n\treturn 0;\n}\n\nstatic int iscsit_task_reassign_complete_write(\n\tstruct iscsit_cmd *cmd,\n\tstruct iscsi_tmr_req *tmr_req)\n{\n\tint no_build_r2ts = 0;\n\tu32 length = 0, offset = 0;\n\tstruct iscsit_conn *conn = cmd->conn;\n\tstruct se_cmd *se_cmd = &cmd->se_cmd;\n\t \n\tif (!tmr_req->exp_data_sn) {\n\t\tcmd->cmd_flags &= ~ICF_GOT_DATACK_SNACK;\n\t\tcmd->acked_data_sn = 0;\n\t} else {\n\t\tcmd->cmd_flags |= ICF_GOT_DATACK_SNACK;\n\t\tcmd->acked_data_sn = (tmr_req->exp_data_sn - 1);\n\t}\n\n\t \n\tif (cmd->cmd_flags & ICF_GOT_LAST_DATAOUT) {\n\t\tif (!(cmd->se_cmd.transport_state & CMD_T_SENT)) {\n\t\t\tpr_debug(\"WRITE ITT: 0x%08x: t_state: %d\"\n\t\t\t\t\" never sent to transport\\n\",\n\t\t\t\tcmd->init_task_tag, cmd->se_cmd.t_state);\n\t\t\ttarget_execute_cmd(se_cmd);\n\t\t\treturn 0;\n\t\t}\n\n\t\tcmd->i_state = ISTATE_SEND_STATUS;\n\t\tiscsit_add_cmd_to_response_queue(cmd, conn, cmd->i_state);\n\t\treturn 0;\n\t}\n\n\t \n\tif (cmd->unsolicited_data) {\n\t\tcmd->unsolicited_data = 0;\n\n\t\toffset = cmd->next_burst_len = cmd->write_data_done;\n\n\t\tif ((conn->sess->sess_ops->FirstBurstLength - offset) >=\n\t\t     cmd->se_cmd.data_length) {\n\t\t\tno_build_r2ts = 1;\n\t\t\tlength = (cmd->se_cmd.data_length - offset);\n\t\t} else\n\t\t\tlength = (conn->sess->sess_ops->FirstBurstLength - offset);\n\n\t\tspin_lock_bh(&cmd->r2t_lock);\n\t\tif (iscsit_add_r2t_to_list(cmd, offset, length, 0, 0) < 0) {\n\t\t\tspin_unlock_bh(&cmd->r2t_lock);\n\t\t\treturn -1;\n\t\t}\n\t\tcmd->outstanding_r2ts++;\n\t\tspin_unlock_bh(&cmd->r2t_lock);\n\n\t\tif (no_build_r2ts)\n\t\t\treturn 0;\n\t}\n\t \n\treturn conn->conn_transport->iscsit_get_dataout(conn, cmd, true);\n}\n\nstatic int iscsit_task_reassign_complete_read(\n\tstruct iscsit_cmd *cmd,\n\tstruct iscsi_tmr_req *tmr_req)\n{\n\tstruct iscsit_conn *conn = cmd->conn;\n\tstruct iscsi_datain_req *dr;\n\tstruct se_cmd *se_cmd = &cmd->se_cmd;\n\t \n\tif (!tmr_req->exp_data_sn) {\n\t\tcmd->cmd_flags &= ~ICF_GOT_DATACK_SNACK;\n\t\tcmd->acked_data_sn = 0;\n\t} else {\n\t\tcmd->cmd_flags |= ICF_GOT_DATACK_SNACK;\n\t\tcmd->acked_data_sn = (tmr_req->exp_data_sn - 1);\n\t}\n\n\tif (!(cmd->se_cmd.transport_state & CMD_T_SENT)) {\n\t\tpr_debug(\"READ ITT: 0x%08x: t_state: %d never sent to\"\n\t\t\t\" transport\\n\", cmd->init_task_tag,\n\t\t\tcmd->se_cmd.t_state);\n\t\ttransport_handle_cdb_direct(se_cmd);\n\t\treturn 0;\n\t}\n\n\tif (!(se_cmd->transport_state & CMD_T_COMPLETE)) {\n\t\tpr_err(\"READ ITT: 0x%08x: t_state: %d, never returned\"\n\t\t\t\" from transport\\n\", cmd->init_task_tag,\n\t\t\tcmd->se_cmd.t_state);\n\t\treturn -1;\n\t}\n\n\tdr = iscsit_allocate_datain_req();\n\tif (!dr)\n\t\treturn -1;\n\t \n\tdr->data_sn = dr->begrun = tmr_req->exp_data_sn;\n\tdr->runlength = 0;\n\tdr->generate_recovery_values = 1;\n\tdr->recovery = DATAIN_CONNECTION_RECOVERY;\n\n\tiscsit_attach_datain_req(cmd, dr);\n\n\tcmd->i_state = ISTATE_SEND_DATAIN;\n\tiscsit_add_cmd_to_response_queue(cmd, conn, cmd->i_state);\n\treturn 0;\n}\n\nstatic int iscsit_task_reassign_complete_none(\n\tstruct iscsit_cmd *cmd,\n\tstruct iscsi_tmr_req *tmr_req)\n{\n\tstruct iscsit_conn *conn = cmd->conn;\n\n\tcmd->i_state = ISTATE_SEND_STATUS;\n\tiscsit_add_cmd_to_response_queue(cmd, conn, cmd->i_state);\n\treturn 0;\n}\n\nstatic int iscsit_task_reassign_complete_scsi_cmnd(\n\tstruct iscsi_tmr_req *tmr_req,\n\tstruct iscsit_conn *conn)\n{\n\tstruct iscsit_cmd *cmd = tmr_req->ref_cmd;\n\tstruct iscsi_conn_recovery *cr;\n\n\tif (!cmd->cr) {\n\t\tpr_err(\"struct iscsi_conn_recovery pointer for ITT: 0x%08x\"\n\t\t\t\" is NULL!\\n\", cmd->init_task_tag);\n\t\treturn -1;\n\t}\n\tcr = cmd->cr;\n\n\t \n\tcmd->stat_sn = cmd->exp_stat_sn = 0;\n\n\tiscsit_task_reassign_remove_cmd(cmd, cr, conn->sess);\n\n\tspin_lock_bh(&conn->cmd_lock);\n\tlist_add_tail(&cmd->i_conn_node, &conn->conn_cmd_list);\n\tspin_unlock_bh(&conn->cmd_lock);\n\n\tif (cmd->se_cmd.se_cmd_flags & SCF_SENT_CHECK_CONDITION) {\n\t\tcmd->i_state = ISTATE_SEND_STATUS;\n\t\tiscsit_add_cmd_to_response_queue(cmd, conn, cmd->i_state);\n\t\treturn 0;\n\t}\n\n\tswitch (cmd->data_direction) {\n\tcase DMA_TO_DEVICE:\n\t\treturn iscsit_task_reassign_complete_write(cmd, tmr_req);\n\tcase DMA_FROM_DEVICE:\n\t\treturn iscsit_task_reassign_complete_read(cmd, tmr_req);\n\tcase DMA_NONE:\n\t\treturn iscsit_task_reassign_complete_none(cmd, tmr_req);\n\tdefault:\n\t\tpr_err(\"Unknown cmd->data_direction: 0x%02x\\n\",\n\t\t\t\tcmd->data_direction);\n\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\nstatic int iscsit_task_reassign_complete(\n\tstruct iscsi_tmr_req *tmr_req,\n\tstruct iscsit_conn *conn)\n{\n\tstruct iscsit_cmd *cmd;\n\tint ret = 0;\n\n\tif (!tmr_req->ref_cmd) {\n\t\tpr_err(\"TMR Request is missing a RefCmd struct iscsit_cmd.\\n\");\n\t\treturn -1;\n\t}\n\tcmd = tmr_req->ref_cmd;\n\n\tcmd->conn = conn;\n\n\tswitch (cmd->iscsi_opcode) {\n\tcase ISCSI_OP_NOOP_OUT:\n\t\tret = iscsit_task_reassign_complete_nop_out(tmr_req, conn);\n\t\tbreak;\n\tcase ISCSI_OP_SCSI_CMD:\n\t\tret = iscsit_task_reassign_complete_scsi_cmnd(tmr_req, conn);\n\t\tbreak;\n\tdefault:\n\t\t pr_err(\"Illegal iSCSI Opcode 0x%02x during\"\n\t\t\t\" command reallegiance\\n\", cmd->iscsi_opcode);\n\t\treturn -1;\n\t}\n\n\tif (ret != 0)\n\t\treturn ret;\n\n\tpr_debug(\"Completed connection reallegiance for Opcode: 0x%02x,\"\n\t\t\" ITT: 0x%08x to CID: %hu.\\n\", cmd->iscsi_opcode,\n\t\t\tcmd->init_task_tag, conn->cid);\n\n\treturn 0;\n}\n\n \nint iscsit_tmr_post_handler(struct iscsit_cmd *cmd, struct iscsit_conn *conn)\n{\n\tstruct iscsi_tmr_req *tmr_req = cmd->tmr_req;\n\tstruct se_tmr_req *se_tmr = cmd->se_cmd.se_tmr_req;\n\n\tif (tmr_req->task_reassign &&\n\t   (se_tmr->response == ISCSI_TMF_RSP_COMPLETE))\n\t\treturn iscsit_task_reassign_complete(tmr_req, conn);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(iscsit_tmr_post_handler);\n\n \nstatic int iscsit_task_reassign_prepare_read(\n\tstruct iscsi_tmr_req *tmr_req,\n\tstruct iscsit_conn *conn)\n{\n\treturn 0;\n}\n\nstatic void iscsit_task_reassign_prepare_unsolicited_dataout(\n\tstruct iscsit_cmd *cmd,\n\tstruct iscsit_conn *conn)\n{\n\tint i, j;\n\tstruct iscsi_pdu *pdu = NULL;\n\tstruct iscsi_seq *seq = NULL;\n\n\tif (conn->sess->sess_ops->DataSequenceInOrder) {\n\t\tcmd->data_sn = 0;\n\n\t\tif (cmd->immediate_data)\n\t\t\tcmd->r2t_offset += (cmd->first_burst_len -\n\t\t\t\tcmd->seq_start_offset);\n\n\t\tif (conn->sess->sess_ops->DataPDUInOrder) {\n\t\t\tcmd->write_data_done -= (cmd->immediate_data) ?\n\t\t\t\t\t\t(cmd->first_burst_len -\n\t\t\t\t\t\t cmd->seq_start_offset) :\n\t\t\t\t\t\t cmd->first_burst_len;\n\t\t\tcmd->first_burst_len = 0;\n\t\t\treturn;\n\t\t}\n\n\t\tfor (i = 0; i < cmd->pdu_count; i++) {\n\t\t\tpdu = &cmd->pdu_list[i];\n\n\t\t\tif (pdu->status != ISCSI_PDU_RECEIVED_OK)\n\t\t\t\tcontinue;\n\n\t\t\tif ((pdu->offset >= cmd->seq_start_offset) &&\n\t\t\t   ((pdu->offset + pdu->length) <=\n\t\t\t     cmd->seq_end_offset)) {\n\t\t\t\tcmd->first_burst_len -= pdu->length;\n\t\t\t\tcmd->write_data_done -= pdu->length;\n\t\t\t\tpdu->status = ISCSI_PDU_NOT_RECEIVED;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tfor (i = 0; i < cmd->seq_count; i++) {\n\t\t\tseq = &cmd->seq_list[i];\n\n\t\t\tif (seq->type != SEQTYPE_UNSOLICITED)\n\t\t\t\tcontinue;\n\n\t\t\tcmd->write_data_done -=\n\t\t\t\t\t(seq->offset - seq->orig_offset);\n\t\t\tcmd->first_burst_len = 0;\n\t\t\tseq->data_sn = 0;\n\t\t\tseq->offset = seq->orig_offset;\n\t\t\tseq->next_burst_len = 0;\n\t\t\tseq->status = DATAOUT_SEQUENCE_WITHIN_COMMAND_RECOVERY;\n\n\t\t\tif (conn->sess->sess_ops->DataPDUInOrder)\n\t\t\t\tcontinue;\n\n\t\t\tfor (j = 0; j < seq->pdu_count; j++) {\n\t\t\t\tpdu = &cmd->pdu_list[j+seq->pdu_start];\n\n\t\t\t\tif (pdu->status != ISCSI_PDU_RECEIVED_OK)\n\t\t\t\t\tcontinue;\n\n\t\t\t\tpdu->status = ISCSI_PDU_NOT_RECEIVED;\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic int iscsit_task_reassign_prepare_write(\n\tstruct iscsi_tmr_req *tmr_req,\n\tstruct iscsit_conn *conn)\n{\n\tstruct iscsit_cmd *cmd = tmr_req->ref_cmd;\n\tstruct iscsi_pdu *pdu = NULL;\n\tstruct iscsi_r2t *r2t = NULL, *r2t_tmp;\n\tint first_incomplete_r2t = 1, i = 0;\n\n\t \n\tif (cmd->unsolicited_data)\n\t\tiscsit_task_reassign_prepare_unsolicited_dataout(cmd, conn);\n\n\t \n\tif (!tmr_req->exp_data_sn)\n\t\tgoto drop_unacknowledged_r2ts;\n\n\t \n\tspin_lock_bh(&cmd->r2t_lock);\n\tif (list_empty(&cmd->cmd_r2t_list)) {\n\t\tspin_unlock_bh(&cmd->r2t_lock);\n\t\treturn -1;\n\t}\n\n\tlist_for_each_entry(r2t, &cmd->cmd_r2t_list, r2t_list) {\n\n\t\tif (r2t->r2t_sn >= tmr_req->exp_data_sn)\n\t\t\tcontinue;\n\t\t \n\t\tif (r2t->seq_complete)\n\t\t\tcontinue;\n\n\t\tif (r2t->recovery_r2t)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (conn->sess->sess_ops->DataSequenceInOrder) {\n\t\t\tif (!first_incomplete_r2t) {\n\t\t\t\tcmd->r2t_offset -= r2t->xfer_len;\n\t\t\t\tgoto next;\n\t\t\t}\n\n\t\t\tif (conn->sess->sess_ops->DataPDUInOrder) {\n\t\t\t\tcmd->data_sn = 0;\n\t\t\t\tcmd->r2t_offset -= (r2t->xfer_len -\n\t\t\t\t\tcmd->next_burst_len);\n\t\t\t\tfirst_incomplete_r2t = 0;\n\t\t\t\tgoto next;\n\t\t\t}\n\n\t\t\tcmd->data_sn = 0;\n\t\t\tcmd->r2t_offset -= r2t->xfer_len;\n\n\t\t\tfor (i = 0; i < cmd->pdu_count; i++) {\n\t\t\t\tpdu = &cmd->pdu_list[i];\n\n\t\t\t\tif (pdu->status != ISCSI_PDU_RECEIVED_OK)\n\t\t\t\t\tcontinue;\n\n\t\t\t\tif ((pdu->offset >= r2t->offset) &&\n\t\t\t\t    (pdu->offset < (r2t->offset +\n\t\t\t\t\t\tr2t->xfer_len))) {\n\t\t\t\t\tcmd->next_burst_len -= pdu->length;\n\t\t\t\t\tcmd->write_data_done -= pdu->length;\n\t\t\t\t\tpdu->status = ISCSI_PDU_NOT_RECEIVED;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfirst_incomplete_r2t = 0;\n\t\t} else {\n\t\t\tstruct iscsi_seq *seq;\n\n\t\t\tseq = iscsit_get_seq_holder(cmd, r2t->offset,\n\t\t\t\t\tr2t->xfer_len);\n\t\t\tif (!seq) {\n\t\t\t\tspin_unlock_bh(&cmd->r2t_lock);\n\t\t\t\treturn -1;\n\t\t\t}\n\n\t\t\tcmd->write_data_done -=\n\t\t\t\t\t(seq->offset - seq->orig_offset);\n\t\t\tseq->data_sn = 0;\n\t\t\tseq->offset = seq->orig_offset;\n\t\t\tseq->next_burst_len = 0;\n\t\t\tseq->status = DATAOUT_SEQUENCE_WITHIN_COMMAND_RECOVERY;\n\n\t\t\tcmd->seq_send_order--;\n\n\t\t\tif (conn->sess->sess_ops->DataPDUInOrder)\n\t\t\t\tgoto next;\n\n\t\t\tfor (i = 0; i < seq->pdu_count; i++) {\n\t\t\t\tpdu = &cmd->pdu_list[i+seq->pdu_start];\n\n\t\t\t\tif (pdu->status != ISCSI_PDU_RECEIVED_OK)\n\t\t\t\t\tcontinue;\n\n\t\t\t\tpdu->status = ISCSI_PDU_NOT_RECEIVED;\n\t\t\t}\n\t\t}\n\nnext:\n\t\tcmd->outstanding_r2ts--;\n\t}\n\tspin_unlock_bh(&cmd->r2t_lock);\n\n\t \ndrop_unacknowledged_r2ts:\n\n\tcmd->cmd_flags &= ~ICF_SENT_LAST_R2T;\n\tcmd->r2t_sn = tmr_req->exp_data_sn;\n\n\tspin_lock_bh(&cmd->r2t_lock);\n\tlist_for_each_entry_safe(r2t, r2t_tmp, &cmd->cmd_r2t_list, r2t_list) {\n\t\t \n\t\tif (r2t->r2t_sn < tmr_req->exp_data_sn)\n\t\t\tcontinue;\n\n\t\tif (r2t->seq_complete) {\n\t\t\tpr_err(\"Initiator is requesting R2Ts from\"\n\t\t\t\t\" R2TSN: 0x%08x, but R2TSN: 0x%08x, Offset: %u,\"\n\t\t\t\t\" Length: %u is already complete.\"\n\t\t\t\t\"   BAD INITIATOR ERL=2 IMPLEMENTATION!\\n\",\n\t\t\t\ttmr_req->exp_data_sn, r2t->r2t_sn,\n\t\t\t\tr2t->offset, r2t->xfer_len);\n\t\t\tspin_unlock_bh(&cmd->r2t_lock);\n\t\t\treturn -1;\n\t\t}\n\n\t\tif (r2t->recovery_r2t) {\n\t\t\tiscsit_free_r2t(r2t, cmd);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif (conn->sess->sess_ops->DataSequenceInOrder)\n\t\t\tcmd->r2t_offset -= r2t->xfer_len;\n\t\telse\n\t\t\tcmd->seq_send_order--;\n\n\t\tcmd->outstanding_r2ts--;\n\t\tiscsit_free_r2t(r2t, cmd);\n\t}\n\tspin_unlock_bh(&cmd->r2t_lock);\n\n\treturn 0;\n}\n\n \nint iscsit_check_task_reassign_expdatasn(\n\tstruct iscsi_tmr_req *tmr_req,\n\tstruct iscsit_conn *conn)\n{\n\tstruct iscsit_cmd *ref_cmd = tmr_req->ref_cmd;\n\n\tif (ref_cmd->iscsi_opcode != ISCSI_OP_SCSI_CMD)\n\t\treturn 0;\n\n\tif (ref_cmd->se_cmd.se_cmd_flags & SCF_SENT_CHECK_CONDITION)\n\t\treturn 0;\n\n\tif (ref_cmd->data_direction == DMA_NONE)\n\t\treturn 0;\n\n\t \n\tif (ref_cmd->data_direction == DMA_FROM_DEVICE) {\n\t\tif (tmr_req->exp_data_sn > ref_cmd->data_sn) {\n\t\t\tpr_err(\"Received ExpDataSN: 0x%08x for READ\"\n\t\t\t\t\" in TMR TASK_REASSIGN greater than command's\"\n\t\t\t\t\" DataSN: 0x%08x.\\n\", tmr_req->exp_data_sn,\n\t\t\t\tref_cmd->data_sn);\n\t\t\treturn -1;\n\t\t}\n\t\tif ((ref_cmd->cmd_flags & ICF_GOT_DATACK_SNACK) &&\n\t\t    (tmr_req->exp_data_sn <= ref_cmd->acked_data_sn)) {\n\t\t\tpr_err(\"Received ExpDataSN: 0x%08x for READ\"\n\t\t\t\t\" in TMR TASK_REASSIGN for previously\"\n\t\t\t\t\" acknowledged DataIN: 0x%08x,\"\n\t\t\t\t\" protocol error\\n\", tmr_req->exp_data_sn,\n\t\t\t\tref_cmd->acked_data_sn);\n\t\t\treturn -1;\n\t\t}\n\t\treturn iscsit_task_reassign_prepare_read(tmr_req, conn);\n\t}\n\n\t \n\tif (ref_cmd->data_direction == DMA_TO_DEVICE) {\n\t\tif (tmr_req->exp_data_sn > ref_cmd->r2t_sn) {\n\t\t\tpr_err(\"Received ExpDataSN: 0x%08x for WRITE\"\n\t\t\t\t\" in TMR TASK_REASSIGN greater than command's\"\n\t\t\t\t\" R2TSN: 0x%08x.\\n\", tmr_req->exp_data_sn,\n\t\t\t\t\tref_cmd->r2t_sn);\n\t\t\treturn -1;\n\t\t}\n\t\treturn iscsit_task_reassign_prepare_write(tmr_req, conn);\n\t}\n\n\tpr_err(\"Unknown iSCSI data_direction: 0x%02x\\n\",\n\t\t\tref_cmd->data_direction);\n\n\treturn -1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}