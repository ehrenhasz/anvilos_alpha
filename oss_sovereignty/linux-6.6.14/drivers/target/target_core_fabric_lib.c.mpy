{
  "module_name": "target_core_fabric_lib.c",
  "hash_id": "a713235e5978361246a5abb6f88029a83594cdcc7b833842570d20502b1d53b4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/target/target_core_fabric_lib.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/ctype.h>\n#include <linux/spinlock.h>\n#include <linux/export.h>\n#include <asm/unaligned.h>\n\n#include <scsi/scsi_proto.h>\n\n#include <target/target_core_base.h>\n#include <target/target_core_fabric.h>\n\n#include \"target_core_internal.h\"\n#include \"target_core_pr.h\"\n\n\nstatic int sas_get_pr_transport_id(\n\tstruct se_node_acl *nacl,\n\tint *format_code,\n\tunsigned char *buf)\n{\n\tint ret;\n\n\t \n\tret = hex2bin(&buf[4], &nacl->initiatorname[4], 8);\n\tif (ret) {\n\t\tpr_debug(\"%s: invalid hex string\\n\", __func__);\n\t\treturn ret;\n\t}\n\n\treturn 24;\n}\n\nstatic int fc_get_pr_transport_id(\n\tstruct se_node_acl *se_nacl,\n\tint *format_code,\n\tunsigned char *buf)\n{\n\tunsigned char *ptr;\n\tint i, ret;\n\tu32 off = 8;\n\n\t \n\tptr = &se_nacl->initiatorname[0];\n\tfor (i = 0; i < 23; ) {\n\t\tif (!strncmp(&ptr[i], \":\", 1)) {\n\t\t\ti++;\n\t\t\tcontinue;\n\t\t}\n\t\tret = hex2bin(&buf[off++], &ptr[i], 1);\n\t\tif (ret < 0) {\n\t\t\tpr_debug(\"%s: invalid hex string\\n\", __func__);\n\t\t\treturn ret;\n\t\t}\n\t\ti += 2;\n\t}\n\t \n\treturn 24;\n}\n\nstatic int sbp_get_pr_transport_id(\n\tstruct se_node_acl *nacl,\n\tint *format_code,\n\tunsigned char *buf)\n{\n\tint ret;\n\n\tret = hex2bin(&buf[8], nacl->initiatorname, 8);\n\tif (ret) {\n\t\tpr_debug(\"%s: invalid hex string\\n\", __func__);\n\t\treturn ret;\n\t}\n\n\treturn 24;\n}\n\nstatic int srp_get_pr_transport_id(\n\tstruct se_node_acl *nacl,\n\tint *format_code,\n\tunsigned char *buf)\n{\n\tconst char *p;\n\tunsigned len, count, leading_zero_bytes;\n\tint rc;\n\n\tp = nacl->initiatorname;\n\tif (strncasecmp(p, \"0x\", 2) == 0)\n\t\tp += 2;\n\tlen = strlen(p);\n\tif (len % 2)\n\t\treturn -EINVAL;\n\n\tcount = min(len / 2, 16U);\n\tleading_zero_bytes = 16 - count;\n\tmemset(buf + 8, 0, leading_zero_bytes);\n\trc = hex2bin(buf + 8 + leading_zero_bytes, p, count);\n\tif (rc < 0) {\n\t\tpr_debug(\"hex2bin failed for %s: %d\\n\", p, rc);\n\t\treturn rc;\n\t}\n\n\treturn 24;\n}\n\nstatic int iscsi_get_pr_transport_id(\n\tstruct se_node_acl *se_nacl,\n\tstruct t10_pr_registration *pr_reg,\n\tint *format_code,\n\tunsigned char *buf)\n{\n\tu32 off = 4, padding = 0;\n\tint isid_len;\n\tu16 len = 0;\n\n\tspin_lock_irq(&se_nacl->nacl_sess_lock);\n\t \n\tlen = sprintf(&buf[off], \"%s\", se_nacl->initiatorname);\n\toff += len;\n\tif ((*format_code == 1) && (pr_reg->isid_present_at_reg)) {\n\t\t \n\t\tbuf[0] |= 0x40;\n\t\t \n\t\tbuf[off++] = 0x2c;  \n\t\tbuf[off++] = 0x69;  \n\t\tbuf[off++] = 0x2c;  \n\t\tbuf[off++] = 0x30;  \n\t\tbuf[off++] = 0x78;  \n\t\tlen += 5;\n\n\t\tisid_len = sprintf(buf + off, \"%s\", pr_reg->pr_reg_isid);\n\t\toff += isid_len;\n\t\tlen += isid_len;\n\t}\n\tbuf[off] = '\\0';\n\tlen += 1;\n\tspin_unlock_irq(&se_nacl->nacl_sess_lock);\n\t \n\tpadding = ((-len) & 3);\n\tif (padding != 0)\n\t\tlen += padding;\n\n\tput_unaligned_be16(len, &buf[2]);\n\t \n\tlen += 4;\n\n\treturn len;\n}\n\nstatic int iscsi_get_pr_transport_id_len(\n\tstruct se_node_acl *se_nacl,\n\tstruct t10_pr_registration *pr_reg,\n\tint *format_code)\n{\n\tu32 len = 0, padding = 0;\n\n\tspin_lock_irq(&se_nacl->nacl_sess_lock);\n\tlen = strlen(se_nacl->initiatorname);\n\t \n\tlen++;\n\t \n\tif (pr_reg->isid_present_at_reg) {\n\t\tlen += 5;  \n\t\tlen += strlen(pr_reg->pr_reg_isid);\n\t\t*format_code = 1;\n\t} else\n\t\t*format_code = 0;\n\tspin_unlock_irq(&se_nacl->nacl_sess_lock);\n\t \n\tpadding = ((-len) & 3);\n\tif (padding != 0)\n\t\tlen += padding;\n\t \n\tlen += 4;\n\n\treturn len;\n}\n\nstatic char *iscsi_parse_pr_out_transport_id(\n\tstruct se_portal_group *se_tpg,\n\tchar *buf,\n\tu32 *out_tid_len,\n\tchar **port_nexus_ptr)\n{\n\tchar *p;\n\tint i;\n\tu8 format_code = (buf[0] & 0xc0);\n\t \n\tif ((format_code != 0x00) && (format_code != 0x40)) {\n\t\tpr_err(\"Illegal format code: 0x%02x for iSCSI\"\n\t\t\t\" Initiator Transport ID\\n\", format_code);\n\t\treturn NULL;\n\t}\n\t \n\tif (out_tid_len) {\n\t\t \n\t\t*out_tid_len = get_unaligned_be16(&buf[2]);\n\t\t \n\t\t*out_tid_len += 4;\n\t}\n\n\t \n\tif (format_code == 0x40) {\n\t\tp = strstr(&buf[4], \",i,0x\");\n\t\tif (!p) {\n\t\t\tpr_err(\"Unable to locate \\\",i,0x\\\" separator\"\n\t\t\t\t\" for Initiator port identifier: %s\\n\",\n\t\t\t\t&buf[4]);\n\t\t\treturn NULL;\n\t\t}\n\t\t*p = '\\0';  \n\t\tp += 5;  \n\n\t\t*port_nexus_ptr = p;\n\t\t \n\t\tfor (i = 0; i < 12; i++) {\n\t\t\t \n\t\t\tif (*p == '\\0')\n\t\t\t\tbreak;\n\n\t\t\tif (isdigit(*p)) {\n\t\t\t\tp++;\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\t*p = tolower(*p);\n\t\t\tp++;\n\t\t}\n\t} else\n\t\t*port_nexus_ptr = NULL;\n\n\treturn &buf[4];\n}\n\nint target_get_pr_transport_id_len(struct se_node_acl *nacl,\n\t\tstruct t10_pr_registration *pr_reg, int *format_code)\n{\n\tswitch (nacl->se_tpg->proto_id) {\n\tcase SCSI_PROTOCOL_FCP:\n\tcase SCSI_PROTOCOL_SBP:\n\tcase SCSI_PROTOCOL_SRP:\n\tcase SCSI_PROTOCOL_SAS:\n\t\tbreak;\n\tcase SCSI_PROTOCOL_ISCSI:\n\t\treturn iscsi_get_pr_transport_id_len(nacl, pr_reg, format_code);\n\tdefault:\n\t\tpr_err(\"Unknown proto_id: 0x%02x\\n\", nacl->se_tpg->proto_id);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\t*format_code = 0;\n\treturn 24;\n}\n\nint target_get_pr_transport_id(struct se_node_acl *nacl,\n\t\tstruct t10_pr_registration *pr_reg, int *format_code,\n\t\tunsigned char *buf)\n{\n\tswitch (nacl->se_tpg->proto_id) {\n\tcase SCSI_PROTOCOL_SAS:\n\t\treturn sas_get_pr_transport_id(nacl, format_code, buf);\n\tcase SCSI_PROTOCOL_SBP:\n\t\treturn sbp_get_pr_transport_id(nacl, format_code, buf);\n\tcase SCSI_PROTOCOL_SRP:\n\t\treturn srp_get_pr_transport_id(nacl, format_code, buf);\n\tcase SCSI_PROTOCOL_FCP:\n\t\treturn fc_get_pr_transport_id(nacl, format_code, buf);\n\tcase SCSI_PROTOCOL_ISCSI:\n\t\treturn iscsi_get_pr_transport_id(nacl, pr_reg, format_code,\n\t\t\t\tbuf);\n\tdefault:\n\t\tpr_err(\"Unknown proto_id: 0x%02x\\n\", nacl->se_tpg->proto_id);\n\t\treturn -EINVAL;\n\t}\n}\n\nconst char *target_parse_pr_out_transport_id(struct se_portal_group *tpg,\n\t\tchar *buf, u32 *out_tid_len, char **port_nexus_ptr)\n{\n\tu32 offset;\n\n\tswitch (tpg->proto_id) {\n\tcase SCSI_PROTOCOL_SAS:\n\t\t \n\t\toffset = 4;\n\t\tbreak;\n\tcase SCSI_PROTOCOL_SBP:\n\tcase SCSI_PROTOCOL_SRP:\n\tcase SCSI_PROTOCOL_FCP:\n\t\toffset = 8;\n\t\tbreak;\n\tcase SCSI_PROTOCOL_ISCSI:\n\t\treturn iscsi_parse_pr_out_transport_id(tpg, buf, out_tid_len,\n\t\t\t\t\tport_nexus_ptr);\n\tdefault:\n\t\tpr_err(\"Unknown proto_id: 0x%02x\\n\", tpg->proto_id);\n\t\treturn NULL;\n\t}\n\n\t*port_nexus_ptr = NULL;\n\t*out_tid_len = 24;\n\treturn buf + offset;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}