{
  "module_name": "coresight-sysfs.c",
  "hash_id": "47b8fe11f83f8fd73b284f703c3ffc744e915f8448bbc8c94acccab234cef750",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwtracing/coresight/coresight-sysfs.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/kernel.h>\n\n#include \"coresight-priv.h\"\n\n \nstatic ssize_t nr_links_show(struct device *dev,\n\t\t\t     struct device_attribute *attr,\n\t\t\t     char *buf)\n{\n\tstruct coresight_device *csdev = to_coresight_device(dev);\n\n\treturn sprintf(buf, \"%d\\n\", csdev->nr_links);\n}\nstatic DEVICE_ATTR_RO(nr_links);\n\nstatic struct attribute *coresight_conns_attrs[] = {\n\t&dev_attr_nr_links.attr,\n\tNULL,\n};\n\nstatic struct attribute_group coresight_conns_group = {\n\t.attrs = coresight_conns_attrs,\n\t.name = \"connections\",\n};\n\n \nint coresight_create_conns_sysfs_group(struct coresight_device *csdev)\n{\n\tint ret = 0;\n\n\tif (!csdev)\n\t\treturn -EINVAL;\n\n\tret = sysfs_create_group(&csdev->dev.kobj, &coresight_conns_group);\n\tif (ret)\n\t\treturn ret;\n\n\tcsdev->has_conns_grp = true;\n\treturn ret;\n}\n\nvoid coresight_remove_conns_sysfs_group(struct coresight_device *csdev)\n{\n\tif (!csdev)\n\t\treturn;\n\n\tif (csdev->has_conns_grp) {\n\t\tsysfs_remove_group(&csdev->dev.kobj, &coresight_conns_group);\n\t\tcsdev->has_conns_grp = false;\n\t}\n}\n\nint coresight_add_sysfs_link(struct coresight_sysfs_link *info)\n{\n\tint ret = 0;\n\n\tif (!info)\n\t\treturn -EINVAL;\n\tif (!info->orig || !info->target ||\n\t    !info->orig_name || !info->target_name)\n\t\treturn -EINVAL;\n\tif (!info->orig->has_conns_grp || !info->target->has_conns_grp)\n\t\treturn -EINVAL;\n\n\t \n\tret = sysfs_add_link_to_group(&info->orig->dev.kobj,\n\t\t\t\t      coresight_conns_group.name,\n\t\t\t\t      &info->target->dev.kobj,\n\t\t\t\t      info->orig_name);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = sysfs_add_link_to_group(&info->target->dev.kobj,\n\t\t\t\t      coresight_conns_group.name,\n\t\t\t\t      &info->orig->dev.kobj,\n\t\t\t\t      info->target_name);\n\n\t \n\tif (ret) {\n\t\tsysfs_remove_link_from_group(&info->orig->dev.kobj,\n\t\t\t\t\t     coresight_conns_group.name,\n\t\t\t\t\t     info->orig_name);\n\t} else {\n\t\tinfo->orig->nr_links++;\n\t\tinfo->target->nr_links++;\n\t}\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(coresight_add_sysfs_link);\n\nvoid coresight_remove_sysfs_link(struct coresight_sysfs_link *info)\n{\n\tif (!info)\n\t\treturn;\n\tif (!info->orig || !info->target ||\n\t    !info->orig_name || !info->target_name)\n\t\treturn;\n\n\tsysfs_remove_link_from_group(&info->orig->dev.kobj,\n\t\t\t\t     coresight_conns_group.name,\n\t\t\t\t     info->orig_name);\n\n\tsysfs_remove_link_from_group(&info->target->dev.kobj,\n\t\t\t\t     coresight_conns_group.name,\n\t\t\t\t     info->target_name);\n\n\tinfo->orig->nr_links--;\n\tinfo->target->nr_links--;\n}\nEXPORT_SYMBOL_GPL(coresight_remove_sysfs_link);\n\n \nint coresight_make_links(struct coresight_device *orig,\n\t\t\t struct coresight_connection *conn,\n\t\t\t struct coresight_device *target)\n{\n\tint ret = -ENOMEM;\n\tchar *outs = NULL, *ins = NULL;\n\tstruct coresight_sysfs_link *link = NULL;\n\n\t \n\tif (conn->dest_port == -1 && conn->src_port == -1)\n\t\treturn 0;\n\n\tdo {\n\t\touts = devm_kasprintf(&orig->dev, GFP_KERNEL,\n\t\t\t\t      \"out:%d\", conn->src_port);\n\t\tif (!outs)\n\t\t\tbreak;\n\t\tins = devm_kasprintf(&target->dev, GFP_KERNEL,\n\t\t\t\t     \"in:%d\", conn->dest_port);\n\t\tif (!ins)\n\t\t\tbreak;\n\t\tlink = devm_kzalloc(&orig->dev,\n\t\t\t\t    sizeof(struct coresight_sysfs_link),\n\t\t\t\t    GFP_KERNEL);\n\t\tif (!link)\n\t\t\tbreak;\n\n\t\tlink->orig = orig;\n\t\tlink->target = target;\n\t\tlink->orig_name = outs;\n\t\tlink->target_name = ins;\n\n\t\tret = coresight_add_sysfs_link(link);\n\t\tif (ret)\n\t\t\tbreak;\n\n\t\tconn->link = link;\n\t\treturn 0;\n\t} while (0);\n\n\treturn ret;\n}\n\n \nvoid coresight_remove_links(struct coresight_device *orig,\n\t\t\t    struct coresight_connection *conn)\n{\n\tif (!orig || !conn->link)\n\t\treturn;\n\n\tcoresight_remove_sysfs_link(conn->link);\n\n\tdevm_kfree(&conn->dest_dev->dev, conn->link->target_name);\n\tdevm_kfree(&orig->dev, conn->link->orig_name);\n\tdevm_kfree(&orig->dev, conn->link);\n\tconn->link = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}