{
  "module_name": "coresight-config.c",
  "hash_id": "e86d8ed4bf872d728bd938ff588e1f7cf2021dc178e8ab7225adc5b3dc881ec6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwtracing/coresight/coresight-config.c",
  "human_readable_source": "\n \n\n#include <linux/sysfs.h>\n#include \"coresight-config.h\"\n#include \"coresight-priv.h\"\n\n \n\n \nstatic void cscfg_set_reg(struct cscfg_regval_csdev *reg_csdev)\n{\n\tu32 *p_val32 = (u32 *)reg_csdev->driver_regval;\n\tu32 tmp32 = reg_csdev->reg_desc.val32;\n\n\tif (reg_csdev->reg_desc.type & CS_CFG_REG_TYPE_VAL_64BIT) {\n\t\t*((u64 *)reg_csdev->driver_regval) = reg_csdev->reg_desc.val64;\n\t\treturn;\n\t}\n\n\tif (reg_csdev->reg_desc.type & CS_CFG_REG_TYPE_VAL_MASK) {\n\t\ttmp32 = *p_val32;\n\t\ttmp32 &= ~reg_csdev->reg_desc.mask32;\n\t\ttmp32 |= reg_csdev->reg_desc.val32 & reg_csdev->reg_desc.mask32;\n\t}\n\t*p_val32 = tmp32;\n}\n\n \nstatic void cscfg_save_reg(struct cscfg_regval_csdev *reg_csdev)\n{\n\tif (!(reg_csdev->reg_desc.type & CS_CFG_REG_TYPE_VAL_SAVE))\n\t\treturn;\n\tif (reg_csdev->reg_desc.type & CS_CFG_REG_TYPE_VAL_64BIT)\n\t\treg_csdev->reg_desc.val64 = *(u64 *)(reg_csdev->driver_regval);\n\telse\n\t\treg_csdev->reg_desc.val32 = *(u32 *)(reg_csdev->driver_regval);\n}\n\n \nstatic void cscfg_init_reg_param(struct cscfg_feature_csdev *feat_csdev,\n\t\t\t\t struct cscfg_regval_desc *reg_desc,\n\t\t\t\t struct cscfg_regval_csdev *reg_csdev)\n{\n\tstruct cscfg_parameter_csdev *param_csdev;\n\n\t \n\tparam_csdev = &feat_csdev->params_csdev[reg_desc->param_idx];\n\tparam_csdev->reg_csdev = reg_csdev;\n\tparam_csdev->val64 = reg_csdev->reg_desc.type & CS_CFG_REG_TYPE_VAL_64BIT;\n\n\tif (param_csdev->val64)\n\t\treg_csdev->reg_desc.val64 = param_csdev->current_value;\n\telse\n\t\treg_csdev->reg_desc.val32 = (u32)param_csdev->current_value;\n}\n\n \nstatic int cscfg_set_on_enable(struct cscfg_feature_csdev *feat_csdev)\n{\n\tunsigned long flags;\n\tint i;\n\n\tspin_lock_irqsave(feat_csdev->drv_spinlock, flags);\n\tfor (i = 0; i < feat_csdev->nr_regs; i++)\n\t\tcscfg_set_reg(&feat_csdev->regs_csdev[i]);\n\tspin_unlock_irqrestore(feat_csdev->drv_spinlock, flags);\n\tdev_dbg(&feat_csdev->csdev->dev, \"Feature %s: %s\",\n\t\tfeat_csdev->feat_desc->name, \"set on enable\");\n\treturn 0;\n}\n\n \nstatic void cscfg_save_on_disable(struct cscfg_feature_csdev *feat_csdev)\n{\n\tunsigned long flags;\n\tint i;\n\n\tspin_lock_irqsave(feat_csdev->drv_spinlock, flags);\n\tfor (i = 0; i < feat_csdev->nr_regs; i++)\n\t\tcscfg_save_reg(&feat_csdev->regs_csdev[i]);\n\tspin_unlock_irqrestore(feat_csdev->drv_spinlock, flags);\n\tdev_dbg(&feat_csdev->csdev->dev, \"Feature %s: %s\",\n\t\tfeat_csdev->feat_desc->name, \"save on disable\");\n}\n\n \nvoid cscfg_reset_feat(struct cscfg_feature_csdev *feat_csdev)\n{\n\tstruct cscfg_regval_desc *reg_desc;\n\tstruct cscfg_regval_csdev *reg_csdev;\n\tint i;\n\n\t \n\tfor (i = 0; i < feat_csdev->nr_params; i++)\n\t\tfeat_csdev->params_csdev[i].current_value =\n\t\t\tfeat_csdev->feat_desc->params_desc[i].value;\n\n\tfor (i = 0; i < feat_csdev->nr_regs; i++) {\n\t\treg_desc = &feat_csdev->feat_desc->regs_desc[i];\n\t\treg_csdev = &feat_csdev->regs_csdev[i];\n\t\treg_csdev->reg_desc.type = reg_desc->type;\n\n\t\t \n\t\tif (reg_desc->type & CS_CFG_REG_TYPE_VAL_PARAM)\n\t\t\tcscfg_init_reg_param(feat_csdev, reg_desc, reg_csdev);\n\t\telse\n\t\t\t \n\t\t\treg_csdev->reg_desc.val64 = reg_desc->val64;\n\t}\n}\n\n \nstatic int cscfg_update_presets(struct cscfg_config_csdev *config_csdev, int preset)\n{\n\tint i, j, val_idx = 0, nr_cfg_params;\n\tstruct cscfg_parameter_csdev *param_csdev;\n\tstruct cscfg_feature_csdev *feat_csdev;\n\tconst struct cscfg_config_desc *config_desc = config_csdev->config_desc;\n\tconst char *name;\n\tconst u64 *preset_base;\n\tu64 val;\n\n\t \n\tif (preset < 1 || preset > config_desc->nr_presets)\n\t\treturn -EINVAL;\n\t \n\tnr_cfg_params = config_desc->nr_total_params;\n\tpreset_base = &config_desc->presets[(preset - 1) * nr_cfg_params];\n\tfor (i = 0; i < config_csdev->nr_feat; i++) {\n\t\tfeat_csdev = config_csdev->feats_csdev[i];\n\t\tif (!feat_csdev->nr_params)\n\t\t\tcontinue;\n\n\t\tfor (j = 0; j < feat_csdev->nr_params; j++) {\n\t\t\tparam_csdev = &feat_csdev->params_csdev[j];\n\t\t\tname = feat_csdev->feat_desc->params_desc[j].name;\n\t\t\tval = preset_base[val_idx++];\n\t\t\tif (param_csdev->val64) {\n\t\t\t\tdev_dbg(&config_csdev->csdev->dev,\n\t\t\t\t\t\"set param %s (%lld)\", name, val);\n\t\t\t\tparam_csdev->reg_csdev->reg_desc.val64 = val;\n\t\t\t} else {\n\t\t\t\tparam_csdev->reg_csdev->reg_desc.val32 = (u32)val;\n\t\t\t\tdev_dbg(&config_csdev->csdev->dev,\n\t\t\t\t\t\"set param %s (%d)\", name, (u32)val);\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tif (val_idx >= nr_cfg_params)\n\t\t\tbreak;\n\t}\n\treturn 0;\n}\n\n \nstatic int cscfg_update_curr_params(struct cscfg_config_csdev *config_csdev)\n{\n\tint i, j;\n\tstruct cscfg_feature_csdev *feat_csdev;\n\tstruct cscfg_parameter_csdev *param_csdev;\n\tconst char *name;\n\tu64 val;\n\n\tfor (i = 0; i < config_csdev->nr_feat; i++) {\n\t\tfeat_csdev = config_csdev->feats_csdev[i];\n\t\tif (!feat_csdev->nr_params)\n\t\t\tcontinue;\n\t\tfor (j = 0; j < feat_csdev->nr_params; j++) {\n\t\t\tparam_csdev = &feat_csdev->params_csdev[j];\n\t\t\tname = feat_csdev->feat_desc->params_desc[j].name;\n\t\t\tval = param_csdev->current_value;\n\t\t\tif (param_csdev->val64) {\n\t\t\t\tdev_dbg(&config_csdev->csdev->dev,\n\t\t\t\t\t\"set param %s (%lld)\", name, val);\n\t\t\t\tparam_csdev->reg_csdev->reg_desc.val64 = val;\n\t\t\t} else {\n\t\t\t\tparam_csdev->reg_csdev->reg_desc.val32 = (u32)val;\n\t\t\t\tdev_dbg(&config_csdev->csdev->dev,\n\t\t\t\t\t\"set param %s (%d)\", name, (u32)val);\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n}\n\n \nstatic int cscfg_prog_config(struct cscfg_config_csdev *config_csdev, bool enable)\n{\n\tint i, err = 0;\n\tstruct cscfg_feature_csdev *feat_csdev;\n\tstruct coresight_device *csdev;\n\n\tfor (i = 0; i < config_csdev->nr_feat; i++) {\n\t\tfeat_csdev = config_csdev->feats_csdev[i];\n\t\tcsdev = feat_csdev->csdev;\n\t\tdev_dbg(&csdev->dev, \"cfg %s;  %s feature:%s\", config_csdev->config_desc->name,\n\t\t\tenable ? \"enable\" : \"disable\", feat_csdev->feat_desc->name);\n\n\t\tif (enable)\n\t\t\terr = cscfg_set_on_enable(feat_csdev);\n\t\telse\n\t\t\tcscfg_save_on_disable(feat_csdev);\n\n\t\tif (err)\n\t\t\tbreak;\n\t}\n\treturn err;\n}\n\n \nint cscfg_csdev_enable_config(struct cscfg_config_csdev *config_csdev, int preset)\n{\n\tint err = 0;\n\n\tif (preset)\n\t\terr = cscfg_update_presets(config_csdev, preset);\n\telse\n\t\terr = cscfg_update_curr_params(config_csdev);\n\tif (!err)\n\t\terr = cscfg_prog_config(config_csdev, true);\n\treturn err;\n}\n\nvoid cscfg_csdev_disable_config(struct cscfg_config_csdev *config_csdev)\n{\n\tcscfg_prog_config(config_csdev, false);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}