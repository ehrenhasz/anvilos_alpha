{
  "module_name": "heartbeat.c",
  "hash_id": "a49ad211cbc15711a0b2868da22f010737c623c9157618de59a8f67d7126cdea",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwtracing/stm/heartbeat.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/hrtimer.h>\n#include <linux/slab.h>\n#include <linux/stm.h>\n\n#define STM_HEARTBEAT_MAX\t32\n\nstatic int nr_devs = 4;\nstatic int interval_ms = 10;\n\nmodule_param(nr_devs, int, 0400);\nmodule_param(interval_ms, int, 0600);\n\nstatic struct stm_heartbeat {\n\tstruct stm_source_data\tdata;\n\tstruct hrtimer\t\thrtimer;\n\tunsigned int\t\tactive;\n} stm_heartbeat[STM_HEARTBEAT_MAX];\n\nstatic const char str[] = \"heartbeat stm source driver is here to serve you\";\n\nstatic enum hrtimer_restart stm_heartbeat_hrtimer_handler(struct hrtimer *hr)\n{\n\tstruct stm_heartbeat *heartbeat = container_of(hr, struct stm_heartbeat,\n\t\t\t\t\t\t       hrtimer);\n\n\tstm_source_write(&heartbeat->data, 0, str, sizeof str);\n\tif (heartbeat->active)\n\t\thrtimer_forward_now(hr, ms_to_ktime(interval_ms));\n\n\treturn heartbeat->active ? HRTIMER_RESTART : HRTIMER_NORESTART;\n}\n\nstatic int stm_heartbeat_link(struct stm_source_data *data)\n{\n\tstruct stm_heartbeat *heartbeat =\n\t\tcontainer_of(data, struct stm_heartbeat, data);\n\n\theartbeat->active = 1;\n\thrtimer_start(&heartbeat->hrtimer, ms_to_ktime(interval_ms),\n\t\t      HRTIMER_MODE_ABS);\n\n\treturn 0;\n}\n\nstatic void stm_heartbeat_unlink(struct stm_source_data *data)\n{\n\tstruct stm_heartbeat *heartbeat =\n\t\tcontainer_of(data, struct stm_heartbeat, data);\n\n\theartbeat->active = 0;\n\thrtimer_cancel(&heartbeat->hrtimer);\n}\n\nstatic int stm_heartbeat_init(void)\n{\n\tint i, ret;\n\n\tif (nr_devs < 0 || nr_devs > STM_HEARTBEAT_MAX)\n\t\treturn -EINVAL;\n\n\tfor (i = 0; i < nr_devs; i++) {\n\t\tstm_heartbeat[i].data.name =\n\t\t\tkasprintf(GFP_KERNEL, \"heartbeat.%d\", i);\n\t\tif (!stm_heartbeat[i].data.name) {\n\t\t\tret = -ENOMEM;\n\t\t\tgoto fail_unregister;\n\t\t}\n\n\t\tstm_heartbeat[i].data.nr_chans\t= 1;\n\t\tstm_heartbeat[i].data.link\t= stm_heartbeat_link;\n\t\tstm_heartbeat[i].data.unlink\t= stm_heartbeat_unlink;\n\t\thrtimer_init(&stm_heartbeat[i].hrtimer, CLOCK_MONOTONIC,\n\t\t\t     HRTIMER_MODE_ABS);\n\t\tstm_heartbeat[i].hrtimer.function =\n\t\t\tstm_heartbeat_hrtimer_handler;\n\n\t\tret = stm_source_register_device(NULL, &stm_heartbeat[i].data);\n\t\tif (ret)\n\t\t\tgoto fail_free;\n\t}\n\n\treturn 0;\n\nfail_unregister:\n\tfor (i--; i >= 0; i--) {\n\t\tstm_source_unregister_device(&stm_heartbeat[i].data);\nfail_free:\n\t\tkfree(stm_heartbeat[i].data.name);\n\t}\n\n\treturn ret;\n}\n\nstatic void stm_heartbeat_exit(void)\n{\n\tint i;\n\n\tfor (i = 0; i < nr_devs; i++) {\n\t\tstm_source_unregister_device(&stm_heartbeat[i].data);\n\t\tkfree(stm_heartbeat[i].data.name);\n\t}\n}\n\nmodule_init(stm_heartbeat_init);\nmodule_exit(stm_heartbeat_exit);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"stm_heartbeat driver\");\nMODULE_AUTHOR(\"Alexander Shishkin <alexander.shishkin@linux.intel.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}