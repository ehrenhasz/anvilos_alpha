{
  "module_name": "sram-exec.c",
  "hash_id": "828452f50c4433b71abb1dafa99685d104c78a0f63cba9739188ec3bcf42a6ca",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/sram-exec.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/genalloc.h>\n#include <linux/mm.h>\n#include <linux/sram.h>\n#include <linux/set_memory.h>\n\n#include <asm/fncpy.h>\n\n#include \"sram.h\"\n\nstatic DEFINE_MUTEX(exec_pool_list_mutex);\nstatic LIST_HEAD(exec_pool_list);\n\nint sram_check_protect_exec(struct sram_dev *sram, struct sram_reserve *block,\n\t\t\t    struct sram_partition *part)\n{\n\tunsigned long base = (unsigned long)part->base;\n\tunsigned long end = base + block->size;\n\n\tif (!PAGE_ALIGNED(base) || !PAGE_ALIGNED(end)) {\n\t\tdev_err(sram->dev,\n\t\t\t\"SRAM pool marked with 'protect-exec' is not page aligned and will not be created.\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\treturn 0;\n}\n\nint sram_add_protect_exec(struct sram_partition *part)\n{\n\tmutex_lock(&exec_pool_list_mutex);\n\tlist_add_tail(&part->list, &exec_pool_list);\n\tmutex_unlock(&exec_pool_list_mutex);\n\n\treturn 0;\n}\n\n \nvoid *sram_exec_copy(struct gen_pool *pool, void *dst, void *src,\n\t\t     size_t size)\n{\n\tstruct sram_partition *part = NULL, *p;\n\tunsigned long base;\n\tint pages;\n\tvoid *dst_cpy;\n\tint ret;\n\n\tmutex_lock(&exec_pool_list_mutex);\n\tlist_for_each_entry(p, &exec_pool_list, list) {\n\t\tif (p->pool == pool)\n\t\t\tpart = p;\n\t}\n\tmutex_unlock(&exec_pool_list_mutex);\n\n\tif (!part)\n\t\treturn NULL;\n\n\tif (!gen_pool_has_addr(pool, (unsigned long)dst, size))\n\t\treturn NULL;\n\n\tbase = (unsigned long)part->base;\n\tpages = PAGE_ALIGN(size) / PAGE_SIZE;\n\n\tmutex_lock(&part->lock);\n\n\tret = set_memory_nx((unsigned long)base, pages);\n\tif (ret)\n\t\tgoto error_out;\n\tret = set_memory_rw((unsigned long)base, pages);\n\tif (ret)\n\t\tgoto error_out;\n\n\tdst_cpy = fncpy(dst, src, size);\n\n\tret = set_memory_rox((unsigned long)base, pages);\n\tif (ret)\n\t\tgoto error_out;\n\n\tmutex_unlock(&part->lock);\n\n\treturn dst_cpy;\n\nerror_out:\n\tmutex_unlock(&part->lock);\n\treturn NULL;\n}\nEXPORT_SYMBOL_GPL(sram_exec_copy);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}