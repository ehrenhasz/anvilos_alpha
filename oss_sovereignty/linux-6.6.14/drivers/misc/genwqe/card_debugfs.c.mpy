{
  "module_name": "card_debugfs.c",
  "hash_id": "1dff25058b08331639916523126e87afb3741fff2e65e0b51418f0bc5a51afd1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/genwqe/card_debugfs.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/debugfs.h>\n#include <linux/seq_file.h>\n#include <linux/uaccess.h>\n\n#include \"card_base.h\"\n#include \"card_ddcb.h\"\n\nstatic void dbg_uidn_show(struct seq_file *s, struct genwqe_reg *regs,\n\t\t\t  int entries)\n{\n\tunsigned int i;\n\tu32 v_hi, v_lo;\n\n\tfor (i = 0; i < entries; i++) {\n\t\tv_hi = (regs[i].val >> 32) & 0xffffffff;\n\t\tv_lo = (regs[i].val)       & 0xffffffff;\n\n\t\tseq_printf(s, \"  0x%08x 0x%08x 0x%08x 0x%08x EXT_ERR_REC\\n\",\n\t\t\t   regs[i].addr, regs[i].idx, v_hi, v_lo);\n\t}\n}\n\nstatic int curr_dbg_uidn_show(struct seq_file *s, void *unused, int uid)\n{\n\tstruct genwqe_dev *cd = s->private;\n\tint entries;\n\tstruct genwqe_reg *regs;\n\n\tentries = genwqe_ffdc_buff_size(cd, uid);\n\tif (entries < 0)\n\t\treturn -EINVAL;\n\n\tif (entries == 0)\n\t\treturn 0;\n\n\tregs = kcalloc(entries, sizeof(*regs), GFP_KERNEL);\n\tif (regs == NULL)\n\t\treturn -ENOMEM;\n\n\tgenwqe_stop_traps(cd);  \n\tgenwqe_ffdc_buff_read(cd, uid, regs, entries);\n\tgenwqe_start_traps(cd);\n\n\tdbg_uidn_show(s, regs, entries);\n\tkfree(regs);\n\treturn 0;\n}\n\nstatic int curr_dbg_uid0_show(struct seq_file *s, void *unused)\n{\n\treturn curr_dbg_uidn_show(s, unused, 0);\n}\n\nDEFINE_SHOW_ATTRIBUTE(curr_dbg_uid0);\n\nstatic int curr_dbg_uid1_show(struct seq_file *s, void *unused)\n{\n\treturn curr_dbg_uidn_show(s, unused, 1);\n}\n\nDEFINE_SHOW_ATTRIBUTE(curr_dbg_uid1);\n\nstatic int curr_dbg_uid2_show(struct seq_file *s, void *unused)\n{\n\treturn curr_dbg_uidn_show(s, unused, 2);\n}\n\nDEFINE_SHOW_ATTRIBUTE(curr_dbg_uid2);\n\nstatic int prev_dbg_uidn_show(struct seq_file *s, void *unused, int uid)\n{\n\tstruct genwqe_dev *cd = s->private;\n\n\tdbg_uidn_show(s, cd->ffdc[uid].regs,  cd->ffdc[uid].entries);\n\treturn 0;\n}\n\nstatic int prev_dbg_uid0_show(struct seq_file *s, void *unused)\n{\n\treturn prev_dbg_uidn_show(s, unused, 0);\n}\n\nDEFINE_SHOW_ATTRIBUTE(prev_dbg_uid0);\n\nstatic int prev_dbg_uid1_show(struct seq_file *s, void *unused)\n{\n\treturn prev_dbg_uidn_show(s, unused, 1);\n}\n\nDEFINE_SHOW_ATTRIBUTE(prev_dbg_uid1);\n\nstatic int prev_dbg_uid2_show(struct seq_file *s, void *unused)\n{\n\treturn prev_dbg_uidn_show(s, unused, 2);\n}\n\nDEFINE_SHOW_ATTRIBUTE(prev_dbg_uid2);\n\nstatic int curr_regs_show(struct seq_file *s, void *unused)\n{\n\tstruct genwqe_dev *cd = s->private;\n\tunsigned int i;\n\tstruct genwqe_reg *regs;\n\n\tregs = kcalloc(GENWQE_FFDC_REGS, sizeof(*regs), GFP_KERNEL);\n\tif (regs == NULL)\n\t\treturn -ENOMEM;\n\n\tgenwqe_stop_traps(cd);\n\tgenwqe_read_ffdc_regs(cd, regs, GENWQE_FFDC_REGS, 1);\n\tgenwqe_start_traps(cd);\n\n\tfor (i = 0; i < GENWQE_FFDC_REGS; i++) {\n\t\tif (regs[i].addr == 0xffffffff)\n\t\t\tbreak;   \n\n\t\tif (regs[i].val == 0x0ull)\n\t\t\tcontinue;   \n\n\t\tseq_printf(s, \"  0x%08x 0x%016llx\\n\",\n\t\t\t   regs[i].addr, regs[i].val);\n\t}\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(curr_regs);\n\nstatic int prev_regs_show(struct seq_file *s, void *unused)\n{\n\tstruct genwqe_dev *cd = s->private;\n\tunsigned int i;\n\tstruct genwqe_reg *regs = cd->ffdc[GENWQE_DBG_REGS].regs;\n\n\tif (regs == NULL)\n\t\treturn -EINVAL;\n\n\tfor (i = 0; i < GENWQE_FFDC_REGS; i++) {\n\t\tif (regs[i].addr == 0xffffffff)\n\t\t\tbreak;   \n\n\t\tif (regs[i].val == 0x0ull)\n\t\t\tcontinue;   \n\n\t\tseq_printf(s, \"  0x%08x 0x%016llx\\n\",\n\t\t\t   regs[i].addr, regs[i].val);\n\t}\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(prev_regs);\n\nstatic int jtimer_show(struct seq_file *s, void *unused)\n{\n\tstruct genwqe_dev *cd = s->private;\n\tunsigned int vf_num;\n\tu64 jtimer;\n\n\tjtimer = genwqe_read_vreg(cd, IO_SLC_VF_APPJOB_TIMEOUT, 0);\n\tseq_printf(s, \"  PF   0x%016llx %d msec\\n\", jtimer,\n\t\t   GENWQE_PF_JOBTIMEOUT_MSEC);\n\n\tfor (vf_num = 0; vf_num < cd->num_vfs; vf_num++) {\n\t\tjtimer = genwqe_read_vreg(cd, IO_SLC_VF_APPJOB_TIMEOUT,\n\t\t\t\t\t  vf_num + 1);\n\t\tseq_printf(s, \"  VF%-2d 0x%016llx %d msec\\n\", vf_num, jtimer,\n\t\t\t   cd->vf_jobtimeout_msec[vf_num]);\n\t}\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(jtimer);\n\nstatic int queue_working_time_show(struct seq_file *s, void *unused)\n{\n\tstruct genwqe_dev *cd = s->private;\n\tunsigned int vf_num;\n\tu64 t;\n\n\tt = genwqe_read_vreg(cd, IO_SLC_VF_QUEUE_WTIME, 0);\n\tseq_printf(s, \"  PF   0x%016llx\\n\", t);\n\n\tfor (vf_num = 0; vf_num < cd->num_vfs; vf_num++) {\n\t\tt = genwqe_read_vreg(cd, IO_SLC_VF_QUEUE_WTIME, vf_num + 1);\n\t\tseq_printf(s, \"  VF%-2d 0x%016llx\\n\", vf_num, t);\n\t}\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(queue_working_time);\n\nstatic int ddcb_info_show(struct seq_file *s, void *unused)\n{\n\tstruct genwqe_dev *cd = s->private;\n\tunsigned int i;\n\tstruct ddcb_queue *queue;\n\tstruct ddcb *pddcb;\n\n\tqueue = &cd->queue;\n\tseq_puts(s, \"DDCB QUEUE:\\n\");\n\tseq_printf(s, \"  ddcb_max:            %d\\n\"\n\t\t   \"  ddcb_daddr:          %016llx - %016llx\\n\"\n\t\t   \"  ddcb_vaddr:          %p\\n\"\n\t\t   \"  ddcbs_in_flight:     %u\\n\"\n\t\t   \"  ddcbs_max_in_flight: %u\\n\"\n\t\t   \"  ddcbs_completed:     %u\\n\"\n\t\t   \"  return_on_busy:      %u\\n\"\n\t\t   \"  wait_on_busy:        %u\\n\"\n\t\t   \"  irqs_processed:      %u\\n\",\n\t\t   queue->ddcb_max, (long long)queue->ddcb_daddr,\n\t\t   (long long)queue->ddcb_daddr +\n\t\t   (queue->ddcb_max * DDCB_LENGTH),\n\t\t   queue->ddcb_vaddr, queue->ddcbs_in_flight,\n\t\t   queue->ddcbs_max_in_flight, queue->ddcbs_completed,\n\t\t   queue->return_on_busy, queue->wait_on_busy,\n\t\t   cd->irqs_processed);\n\n\t \n\tseq_printf(s, \"  0x%08x 0x%016llx IO_QUEUE_CONFIG\\n\"\n\t\t   \"  0x%08x 0x%016llx IO_QUEUE_STATUS\\n\"\n\t\t   \"  0x%08x 0x%016llx IO_QUEUE_SEGMENT\\n\"\n\t\t   \"  0x%08x 0x%016llx IO_QUEUE_INITSQN\\n\"\n\t\t   \"  0x%08x 0x%016llx IO_QUEUE_WRAP\\n\"\n\t\t   \"  0x%08x 0x%016llx IO_QUEUE_OFFSET\\n\"\n\t\t   \"  0x%08x 0x%016llx IO_QUEUE_WTIME\\n\"\n\t\t   \"  0x%08x 0x%016llx IO_QUEUE_ERRCNTS\\n\"\n\t\t   \"  0x%08x 0x%016llx IO_QUEUE_LRW\\n\",\n\t\t   queue->IO_QUEUE_CONFIG,\n\t\t   __genwqe_readq(cd, queue->IO_QUEUE_CONFIG),\n\t\t   queue->IO_QUEUE_STATUS,\n\t\t   __genwqe_readq(cd, queue->IO_QUEUE_STATUS),\n\t\t   queue->IO_QUEUE_SEGMENT,\n\t\t   __genwqe_readq(cd, queue->IO_QUEUE_SEGMENT),\n\t\t   queue->IO_QUEUE_INITSQN,\n\t\t   __genwqe_readq(cd, queue->IO_QUEUE_INITSQN),\n\t\t   queue->IO_QUEUE_WRAP,\n\t\t   __genwqe_readq(cd, queue->IO_QUEUE_WRAP),\n\t\t   queue->IO_QUEUE_OFFSET,\n\t\t   __genwqe_readq(cd, queue->IO_QUEUE_OFFSET),\n\t\t   queue->IO_QUEUE_WTIME,\n\t\t   __genwqe_readq(cd, queue->IO_QUEUE_WTIME),\n\t\t   queue->IO_QUEUE_ERRCNTS,\n\t\t   __genwqe_readq(cd, queue->IO_QUEUE_ERRCNTS),\n\t\t   queue->IO_QUEUE_LRW,\n\t\t   __genwqe_readq(cd, queue->IO_QUEUE_LRW));\n\n\tseq_printf(s, \"DDCB list (ddcb_act=%d/ddcb_next=%d):\\n\",\n\t\t   queue->ddcb_act, queue->ddcb_next);\n\n\tpddcb = queue->ddcb_vaddr;\n\tfor (i = 0; i < queue->ddcb_max; i++) {\n\t\tseq_printf(s, \"  %-3d: RETC=%03x SEQ=%04x HSI/SHI=%02x/%02x \",\n\t\t\t   i, be16_to_cpu(pddcb->retc_16),\n\t\t\t   be16_to_cpu(pddcb->seqnum_16),\n\t\t\t   pddcb->hsi, pddcb->shi);\n\t\tseq_printf(s, \"PRIV=%06llx CMD=%02x\\n\",\n\t\t\t   be64_to_cpu(pddcb->priv_64), pddcb->cmd);\n\t\tpddcb++;\n\t}\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(ddcb_info);\n\nstatic int info_show(struct seq_file *s, void *unused)\n{\n\tstruct genwqe_dev *cd = s->private;\n\tu64 app_id, slu_id, bitstream = -1;\n\tstruct pci_dev *pci_dev = cd->pci_dev;\n\n\tslu_id = __genwqe_readq(cd, IO_SLU_UNITCFG);\n\tapp_id = __genwqe_readq(cd, IO_APP_UNITCFG);\n\n\tif (genwqe_is_privileged(cd))\n\t\tbitstream = __genwqe_readq(cd, IO_SLU_BITSTREAM);\n\n\tseq_printf(s, \"%s driver version: %s\\n\"\n\t\t   \"    Device Name/Type: %s %s CardIdx: %d\\n\"\n\t\t   \"    SLU/APP Config  : 0x%016llx/0x%016llx\\n\"\n\t\t   \"    Build Date      : %u/%x/%u\\n\"\n\t\t   \"    Base Clock      : %u MHz\\n\"\n\t\t   \"    Arch/SVN Release: %u/%llx\\n\"\n\t\t   \"    Bitstream       : %llx\\n\",\n\t\t   GENWQE_DEVNAME, DRV_VERSION, dev_name(&pci_dev->dev),\n\t\t   genwqe_is_privileged(cd) ?\n\t\t   \"Physical\" : \"Virtual or no SR-IOV\",\n\t\t   cd->card_idx, slu_id, app_id,\n\t\t   (u16)((slu_id >> 12) & 0x0fLLU),\t    \n\t\t   (u16)((slu_id >>  4) & 0xffLLU),\t    \n\t\t   (u16)((slu_id >> 16) & 0x0fLLU) + 2010,  \n\t\t   genwqe_base_clock_frequency(cd),\n\t\t   (u16)((slu_id >> 32) & 0xffLLU), slu_id >> 40,\n\t\t   bitstream);\n\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(info);\n\nvoid genwqe_init_debugfs(struct genwqe_dev *cd)\n{\n\tstruct dentry *root;\n\tchar card_name[64];\n\tchar name[64];\n\tunsigned int i;\n\n\tsprintf(card_name, \"%s%d_card\", GENWQE_DEVNAME, cd->card_idx);\n\n\troot = debugfs_create_dir(card_name, cd->debugfs_genwqe);\n\n\t \n\tdebugfs_create_file(\"ddcb_info\", S_IRUGO, root, cd, &ddcb_info_fops);\n\tdebugfs_create_file(\"info\", S_IRUGO, root, cd, &info_fops);\n\tdebugfs_create_x64(\"err_inject\", 0666, root, &cd->err_inject);\n\tdebugfs_create_u32(\"ddcb_software_timeout\", 0666, root,\n\t\t\t   &cd->ddcb_software_timeout);\n\tdebugfs_create_u32(\"kill_timeout\", 0666, root, &cd->kill_timeout);\n\n\t \n\tif (!genwqe_is_privileged(cd)) {\n\t\tcd->debugfs_root = root;\n\t\treturn;\n\t}\n\n\tdebugfs_create_file(\"curr_regs\", S_IRUGO, root, cd, &curr_regs_fops);\n\tdebugfs_create_file(\"curr_dbg_uid0\", S_IRUGO, root, cd,\n\t\t\t    &curr_dbg_uid0_fops);\n\tdebugfs_create_file(\"curr_dbg_uid1\", S_IRUGO, root, cd,\n\t\t\t    &curr_dbg_uid1_fops);\n\tdebugfs_create_file(\"curr_dbg_uid2\", S_IRUGO, root, cd,\n\t\t\t    &curr_dbg_uid2_fops);\n\tdebugfs_create_file(\"prev_regs\", S_IRUGO, root, cd, &prev_regs_fops);\n\tdebugfs_create_file(\"prev_dbg_uid0\", S_IRUGO, root, cd,\n\t\t\t    &prev_dbg_uid0_fops);\n\tdebugfs_create_file(\"prev_dbg_uid1\", S_IRUGO, root, cd,\n\t\t\t    &prev_dbg_uid1_fops);\n\tdebugfs_create_file(\"prev_dbg_uid2\", S_IRUGO, root, cd,\n\t\t\t    &prev_dbg_uid2_fops);\n\n\tfor (i = 0; i <  GENWQE_MAX_VFS; i++) {\n\t\tsprintf(name, \"vf%u_jobtimeout_msec\", i);\n\t\tdebugfs_create_u32(name, 0666, root,\n\t\t\t\t   &cd->vf_jobtimeout_msec[i]);\n\t}\n\n\tdebugfs_create_file(\"jobtimer\", S_IRUGO, root, cd, &jtimer_fops);\n\tdebugfs_create_file(\"queue_working_time\", S_IRUGO, root, cd,\n\t\t\t    &queue_working_time_fops);\n\tdebugfs_create_u32(\"skip_recovery\", 0666, root, &cd->skip_recovery);\n\tdebugfs_create_u32(\"use_platform_recovery\", 0666, root,\n\t\t\t   &cd->use_platform_recovery);\n\n\tcd->debugfs_root = root;\n}\n\nvoid genqwe_exit_debugfs(struct genwqe_dev *cd)\n{\n\tdebugfs_remove_recursive(cd->debugfs_root);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}