{
  "module_name": "tps6594-esm.c",
  "hash_id": "6d0d0c3a791cb5d9b1575f02566bc158091575e41a765d8e90038bd4a2363995",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/tps6594-esm.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include <linux/regmap.h>\n\n#include <linux/mfd/tps6594.h>\n\n#define TPS6594_DEV_REV_1 0x08\n\nstatic irqreturn_t tps6594_esm_isr(int irq, void *dev_id)\n{\n\tstruct platform_device *pdev = dev_id;\n\tint i;\n\n\tfor (i = 0 ; i < pdev->num_resources ; i++) {\n\t\tif (irq == platform_get_irq_byname(pdev, pdev->resource[i].name)) {\n\t\t\tdev_err(pdev->dev.parent, \"%s error detected\\n\", pdev->resource[i].name);\n\t\t\treturn IRQ_HANDLED;\n\t\t}\n\t}\n\n\treturn IRQ_NONE;\n}\n\nstatic int tps6594_esm_probe(struct platform_device *pdev)\n{\n\tstruct tps6594 *tps = dev_get_drvdata(pdev->dev.parent);\n\tstruct device *dev = &pdev->dev;\n\tunsigned int rev;\n\tint irq;\n\tint ret;\n\tint i;\n\n\t \n\tret = regmap_read(tps->regmap, TPS6594_REG_DEV_REV, &rev);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret,\n\t\t\t\t     \"Failed to read PMIC revision\\n\");\n\tif (rev == TPS6594_DEV_REV_1)\n\t\treturn dev_err_probe(dev, -ENODEV,\n\t\t\t      \"ESM not supported for revision 1 PMIC\\n\");\n\n\tfor (i = 0; i < pdev->num_resources; i++) {\n\t\tirq = platform_get_irq_byname(pdev, pdev->resource[i].name);\n\t\tif (irq < 0)\n\t\t\treturn irq;\n\n\t\tret = devm_request_threaded_irq(dev, irq, NULL,\n\t\t\t\t\t\ttps6594_esm_isr, IRQF_ONESHOT,\n\t\t\t\t\t\tpdev->resource[i].name, pdev);\n\t\tif (ret)\n\t\t\treturn dev_err_probe(dev, ret, \"Failed to request irq\\n\");\n\t}\n\n\tret = regmap_set_bits(tps->regmap, TPS6594_REG_ESM_SOC_MODE_CFG,\n\t\t\t      TPS6594_BIT_ESM_SOC_EN | TPS6594_BIT_ESM_SOC_ENDRV);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to configure ESM\\n\");\n\n\tret = regmap_set_bits(tps->regmap, TPS6594_REG_ESM_SOC_START_REG,\n\t\t\t      TPS6594_BIT_ESM_SOC_START);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to start ESM\\n\");\n\n\tpm_runtime_enable(dev);\n\tpm_runtime_get_sync(dev);\n\n\treturn 0;\n}\n\nstatic void tps6594_esm_remove(struct platform_device *pdev)\n{\n\tstruct tps6594 *tps = dev_get_drvdata(pdev->dev.parent);\n\tstruct device *dev = &pdev->dev;\n\tint ret;\n\n\tret = regmap_clear_bits(tps->regmap, TPS6594_REG_ESM_SOC_START_REG,\n\t\t\t\tTPS6594_BIT_ESM_SOC_START);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to stop ESM\\n\");\n\t\tgoto out;\n\t}\n\n\tret = regmap_clear_bits(tps->regmap, TPS6594_REG_ESM_SOC_MODE_CFG,\n\t\t\t\tTPS6594_BIT_ESM_SOC_EN | TPS6594_BIT_ESM_SOC_ENDRV);\n\tif (ret)\n\t\tdev_err(dev, \"Failed to unconfigure ESM\\n\");\n\nout:\n\tpm_runtime_put_sync(dev);\n\tpm_runtime_disable(dev);\n}\n\nstatic int tps6594_esm_suspend(struct device *dev)\n{\n\tstruct tps6594 *tps = dev_get_drvdata(dev->parent);\n\tint ret;\n\n\tret = regmap_clear_bits(tps->regmap, TPS6594_REG_ESM_SOC_START_REG,\n\t\t\t\tTPS6594_BIT_ESM_SOC_START);\n\n\tpm_runtime_put_sync(dev);\n\n\treturn ret;\n}\n\nstatic int tps6594_esm_resume(struct device *dev)\n{\n\tstruct tps6594 *tps = dev_get_drvdata(dev->parent);\n\n\tpm_runtime_get_sync(dev);\n\n\treturn regmap_set_bits(tps->regmap, TPS6594_REG_ESM_SOC_START_REG,\n\t\t\t       TPS6594_BIT_ESM_SOC_START);\n}\n\nstatic DEFINE_SIMPLE_DEV_PM_OPS(tps6594_esm_pm_ops, tps6594_esm_suspend, tps6594_esm_resume);\n\nstatic struct platform_driver tps6594_esm_driver = {\n\t.driver\t= {\n\t\t.name = \"tps6594-esm\",\n\t\t.pm = pm_sleep_ptr(&tps6594_esm_pm_ops),\n\t},\n\t.probe = tps6594_esm_probe,\n\t.remove_new = tps6594_esm_remove,\n};\n\nmodule_platform_driver(tps6594_esm_driver);\n\nMODULE_ALIAS(\"platform:tps6594-esm\");\nMODULE_AUTHOR(\"Julien Panis <jpanis@baylibre.com>\");\nMODULE_DESCRIPTION(\"TPS6594 Error Signal Monitor Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}