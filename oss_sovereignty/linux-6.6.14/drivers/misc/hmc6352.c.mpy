{
  "module_name": "hmc6352.c",
  "hash_id": "0d79fa31242892d3ee685aa133078cdc498246fd5ddc71e45c60381f36ec65b0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/hmc6352.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/i2c.h>\n#include <linux/err.h>\n#include <linux/delay.h>\n#include <linux/sysfs.h>\n#include <linux/nospec.h>\n\nstatic DEFINE_MUTEX(compass_mutex);\n\nstatic int compass_command(struct i2c_client *c, u8 cmd)\n{\n\tint ret = i2c_master_send(c, &cmd, 1);\n\tif (ret < 0)\n\t\tdev_warn(&c->dev, \"command '%c' failed.\\n\", cmd);\n\treturn ret;\n}\n\nstatic int compass_store(struct device *dev, const char *buf, size_t count,\n\t\t\tconst char *map)\n{\n\tstruct i2c_client *c = to_i2c_client(dev);\n\tint ret;\n\tunsigned long val;\n\n\tret = kstrtoul(buf, 10, &val);\n\tif (ret)\n\t\treturn ret;\n\tif (val >= strlen(map))\n\t\treturn -EINVAL;\n\tval = array_index_nospec(val, strlen(map));\n\tmutex_lock(&compass_mutex);\n\tret = compass_command(c, map[val]);\n\tmutex_unlock(&compass_mutex);\n\tif (ret < 0)\n\t\treturn ret;\n\treturn count;\n}\n\nstatic ssize_t compass_calibration_store(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t count)\n{\n\treturn compass_store(dev, buf, count, \"EC\");\n}\n\nstatic ssize_t compass_power_mode_store(struct device *dev,\n\t\tstruct device_attribute *attr, const  char *buf, size_t count)\n{\n\treturn compass_store(dev, buf, count, \"SW\");\n}\n\nstatic ssize_t compass_heading_data_show(struct device *dev,\n\t\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct i2c_client *client = to_i2c_client(dev);\n\tunsigned char i2c_data[2];\n\tint ret;\n\n\tmutex_lock(&compass_mutex);\n\tret = compass_command(client, 'A');\n\tif (ret != 1) {\n\t\tmutex_unlock(&compass_mutex);\n\t\treturn ret;\n\t}\n\tmsleep(10);  \n\tret = i2c_master_recv(client, i2c_data, 2);\n\tmutex_unlock(&compass_mutex);\n\tif (ret < 0) {\n\t\tdev_warn(dev, \"i2c read data cmd failed\\n\");\n\t\treturn ret;\n\t}\n\tret = (i2c_data[0] << 8) | i2c_data[1];\n\treturn sprintf(buf, \"%d.%d\\n\", ret/10, ret%10);\n}\n\n\nstatic DEVICE_ATTR(heading0_input, S_IRUGO, compass_heading_data_show, NULL);\nstatic DEVICE_ATTR(calibration, S_IWUSR, NULL, compass_calibration_store);\nstatic DEVICE_ATTR(power_state, S_IWUSR, NULL, compass_power_mode_store);\n\nstatic struct attribute *mid_att_compass[] = {\n\t&dev_attr_heading0_input.attr,\n\t&dev_attr_calibration.attr,\n\t&dev_attr_power_state.attr,\n\tNULL\n};\n\nstatic const struct attribute_group m_compass_gr = {\n\t.name = \"hmc6352\",\n\t.attrs = mid_att_compass\n};\n\nstatic int hmc6352_probe(struct i2c_client *client)\n{\n\tint res;\n\n\tres = sysfs_create_group(&client->dev.kobj, &m_compass_gr);\n\tif (res) {\n\t\tdev_err(&client->dev, \"device_create_file failed\\n\");\n\t\treturn res;\n\t}\n\tdev_info(&client->dev, \"%s HMC6352 compass chip found\\n\",\n\t\t\t\t\t\t\tclient->name);\n\treturn 0;\n}\n\nstatic void hmc6352_remove(struct i2c_client *client)\n{\n\tsysfs_remove_group(&client->dev.kobj, &m_compass_gr);\n}\n\nstatic const struct i2c_device_id hmc6352_id[] = {\n\t{ \"hmc6352\", 0 },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(i2c, hmc6352_id);\n\nstatic struct i2c_driver hmc6352_driver = {\n\t.driver = {\n\t\t.name = \"hmc6352\",\n\t},\n\t.probe = hmc6352_probe,\n\t.remove = hmc6352_remove,\n\t.id_table = hmc6352_id,\n};\n\nmodule_i2c_driver(hmc6352_driver);\n\nMODULE_AUTHOR(\"Kalhan Trisal <kalhan.trisal@intel.com\");\nMODULE_DESCRIPTION(\"hmc6352 Compass Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}