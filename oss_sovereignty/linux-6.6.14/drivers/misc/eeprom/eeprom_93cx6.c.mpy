{
  "module_name": "eeprom_93cx6.c",
  "hash_id": "29e7386e6fd156a7ed886d9af11f5b25bfc7387316d166e86cae33a6c0025177",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/eeprom/eeprom_93cx6.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/eeprom_93cx6.h>\n\nMODULE_AUTHOR(\"http://rt2x00.serialmonkey.com\");\nMODULE_VERSION(\"1.0\");\nMODULE_DESCRIPTION(\"EEPROM 93cx6 chip driver\");\nMODULE_LICENSE(\"GPL\");\n\nstatic inline void eeprom_93cx6_pulse_high(struct eeprom_93cx6 *eeprom)\n{\n\teeprom->reg_data_clock = 1;\n\teeprom->register_write(eeprom);\n\n\t \n\tndelay(450);\n}\n\nstatic inline void eeprom_93cx6_pulse_low(struct eeprom_93cx6 *eeprom)\n{\n\teeprom->reg_data_clock = 0;\n\teeprom->register_write(eeprom);\n\n\t \n\tndelay(450);\n}\n\nstatic void eeprom_93cx6_startup(struct eeprom_93cx6 *eeprom)\n{\n\t \n\teeprom->register_read(eeprom);\n\teeprom->reg_data_in = 0;\n\teeprom->reg_data_out = 0;\n\teeprom->reg_data_clock = 0;\n\teeprom->reg_chip_select = 1;\n\teeprom->drive_data = 1;\n\teeprom->register_write(eeprom);\n\n\t \n\teeprom_93cx6_pulse_high(eeprom);\n\teeprom_93cx6_pulse_low(eeprom);\n}\n\nstatic void eeprom_93cx6_cleanup(struct eeprom_93cx6 *eeprom)\n{\n\t \n\teeprom->register_read(eeprom);\n\teeprom->reg_data_in = 0;\n\teeprom->reg_chip_select = 0;\n\teeprom->register_write(eeprom);\n\n\t \n\teeprom_93cx6_pulse_high(eeprom);\n\teeprom_93cx6_pulse_low(eeprom);\n}\n\nstatic void eeprom_93cx6_write_bits(struct eeprom_93cx6 *eeprom,\n\tconst u16 data, const u16 count)\n{\n\tunsigned int i;\n\n\teeprom->register_read(eeprom);\n\n\t \n\teeprom->reg_data_in = 0;\n\teeprom->reg_data_out = 0;\n\teeprom->drive_data = 1;\n\n\t \n\tfor (i = count; i > 0; i--) {\n\t\t \n\t\teeprom->reg_data_in = !!(data & (1 << (i - 1)));\n\n\t\t \n\t\teeprom->register_write(eeprom);\n\n\t\t \n\t\teeprom_93cx6_pulse_high(eeprom);\n\t\teeprom_93cx6_pulse_low(eeprom);\n\t}\n\n\teeprom->reg_data_in = 0;\n\teeprom->register_write(eeprom);\n}\n\nstatic void eeprom_93cx6_read_bits(struct eeprom_93cx6 *eeprom,\n\tu16 *data, const u16 count)\n{\n\tunsigned int i;\n\tu16 buf = 0;\n\n\teeprom->register_read(eeprom);\n\n\t \n\teeprom->reg_data_in = 0;\n\teeprom->reg_data_out = 0;\n\teeprom->drive_data = 0;\n\n\t \n\tfor (i = count; i > 0; i--) {\n\t\teeprom_93cx6_pulse_high(eeprom);\n\n\t\teeprom->register_read(eeprom);\n\n\t\t \n\t\teeprom->reg_data_in = 0;\n\n\t\t \n\t\tif (eeprom->reg_data_out)\n\t\t\tbuf |= (1 << (i - 1));\n\n\t\teeprom_93cx6_pulse_low(eeprom);\n\t}\n\n\t*data = buf;\n}\n\n \nvoid eeprom_93cx6_read(struct eeprom_93cx6 *eeprom, const u8 word,\n\tu16 *data)\n{\n\tu16 command;\n\n\t \n\teeprom_93cx6_startup(eeprom);\n\n\t \n\tcommand = (PCI_EEPROM_READ_OPCODE << eeprom->width) | word;\n\teeprom_93cx6_write_bits(eeprom, command,\n\t\tPCI_EEPROM_WIDTH_OPCODE + eeprom->width);\n\n\t \n\teeprom_93cx6_read_bits(eeprom, data, 16);\n\n\t \n\teeprom_93cx6_cleanup(eeprom);\n}\nEXPORT_SYMBOL_GPL(eeprom_93cx6_read);\n\n \nvoid eeprom_93cx6_multiread(struct eeprom_93cx6 *eeprom, const u8 word,\n\t__le16 *data, const u16 words)\n{\n\tunsigned int i;\n\tu16 tmp;\n\n\tfor (i = 0; i < words; i++) {\n\t\ttmp = 0;\n\t\teeprom_93cx6_read(eeprom, word + i, &tmp);\n\t\tdata[i] = cpu_to_le16(tmp);\n\t}\n}\nEXPORT_SYMBOL_GPL(eeprom_93cx6_multiread);\n\n \nvoid eeprom_93cx6_readb(struct eeprom_93cx6 *eeprom, const u8 byte,\n\tu8 *data)\n{\n\tu16 command;\n\tu16 tmp;\n\n\t \n\teeprom_93cx6_startup(eeprom);\n\n\t \n\tcommand = (PCI_EEPROM_READ_OPCODE << (eeprom->width + 1)) | byte;\n\teeprom_93cx6_write_bits(eeprom, command,\n\t\tPCI_EEPROM_WIDTH_OPCODE + eeprom->width + 1);\n\n\t \n\teeprom_93cx6_read_bits(eeprom, &tmp, 8);\n\t*data = tmp & 0xff;\n\n\t \n\teeprom_93cx6_cleanup(eeprom);\n}\nEXPORT_SYMBOL_GPL(eeprom_93cx6_readb);\n\n \nvoid eeprom_93cx6_multireadb(struct eeprom_93cx6 *eeprom, const u8 byte,\n\tu8 *data, const u16 bytes)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < bytes; i++)\n\t\teeprom_93cx6_readb(eeprom, byte + i, &data[i]);\n}\nEXPORT_SYMBOL_GPL(eeprom_93cx6_multireadb);\n\n \nvoid eeprom_93cx6_wren(struct eeprom_93cx6 *eeprom, bool enable)\n{\n\tu16 command;\n\n\t \n\teeprom_93cx6_startup(eeprom);\n\n\t \n\n\tcommand = enable ? PCI_EEPROM_EWEN_OPCODE : PCI_EEPROM_EWDS_OPCODE;\n\tcommand <<= (eeprom->width - 2);\n\n\teeprom_93cx6_write_bits(eeprom, command,\n\t\t\t\tPCI_EEPROM_WIDTH_OPCODE + eeprom->width);\n\n\teeprom_93cx6_cleanup(eeprom);\n}\nEXPORT_SYMBOL_GPL(eeprom_93cx6_wren);\n\n \nvoid eeprom_93cx6_write(struct eeprom_93cx6 *eeprom, u8 addr, u16 data)\n{\n\tint timeout = 100;\n\tu16 command;\n\n\t \n\teeprom_93cx6_startup(eeprom);\n\n\tcommand = PCI_EEPROM_WRITE_OPCODE << eeprom->width;\n\tcommand |= addr;\n\n\t \n\teeprom_93cx6_write_bits(eeprom, command,\n\t\t\t\tPCI_EEPROM_WIDTH_OPCODE + eeprom->width);\n\n\t \n\teeprom_93cx6_write_bits(eeprom, data, 16);\n\n\t \n\teeprom->drive_data = 0;\n\teeprom->reg_chip_select = 1;\n\teeprom->register_write(eeprom);\n\n\t \n\tusleep_range(1000, 2000);\n\n\t \n\n\twhile (true) {\n\t\teeprom->register_read(eeprom);\n\n\t\tif (eeprom->reg_data_out)\n\t\t\tbreak;\n\n\t\tusleep_range(1000, 2000);\n\n\t\tif (--timeout <= 0) {\n\t\t\tprintk(KERN_ERR \"%s: timeout\\n\", __func__);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\teeprom_93cx6_cleanup(eeprom);\n}\nEXPORT_SYMBOL_GPL(eeprom_93cx6_write);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}