{
  "module_name": "fortify.c",
  "hash_id": "52893fe8e05e065e7982ee067bf165a46d929c093bccfef3ac3b70ac25880e93",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/lkdtm/fortify.c",
  "human_readable_source": "\n \n#include \"lkdtm.h\"\n#include <linux/string.h>\n#include <linux/slab.h>\n\nstatic volatile int fortify_scratch_space;\n\nstatic void lkdtm_FORTIFY_STR_OBJECT(void)\n{\n\tstruct target {\n\t\tchar a[10];\n\t\tint foo;\n\t} target[3] = {};\n\t \n\tvolatile int size = 20;\n\n\tpr_info(\"trying to strcmp() past the end of a struct\\n\");\n\n\tstrncpy(target[0].a, target[1].a, size);\n\n\t \n\tfortify_scratch_space = target[0].a[3];\n\n\tpr_err(\"FAIL: fortify did not block a strncpy() object write overflow!\\n\");\n\tpr_expected_config(CONFIG_FORTIFY_SOURCE);\n}\n\nstatic void lkdtm_FORTIFY_STR_MEMBER(void)\n{\n\tstruct target {\n\t\tchar a[10];\n\t\tchar b[10];\n\t} target;\n\tvolatile int size = 20;\n\tchar *src;\n\n\tsrc = kmalloc(size, GFP_KERNEL);\n\tstrscpy(src, \"over ten bytes\", size);\n\tsize = strlen(src) + 1;\n\n\tpr_info(\"trying to strncpy() past the end of a struct member...\\n\");\n\n\t \n\tstrncpy(target.a, src, size);\n\n\t \n\tfortify_scratch_space = target.a[3];\n\n\tpr_err(\"FAIL: fortify did not block a strncpy() struct member write overflow!\\n\");\n\tpr_expected_config(CONFIG_FORTIFY_SOURCE);\n\n\tkfree(src);\n}\n\nstatic void lkdtm_FORTIFY_MEM_OBJECT(void)\n{\n\tint before[10];\n\tstruct target {\n\t\tchar a[10];\n\t\tint foo;\n\t} target = {};\n\tint after[10];\n\t \n\tvolatile int size = 20;\n\n\tmemset(before, 0, sizeof(before));\n\tmemset(after, 0, sizeof(after));\n\tfortify_scratch_space = before[5];\n\tfortify_scratch_space = after[5];\n\n\tpr_info(\"trying to memcpy() past the end of a struct\\n\");\n\n\tpr_info(\"0: %zu\\n\", __builtin_object_size(&target, 0));\n\tpr_info(\"1: %zu\\n\", __builtin_object_size(&target, 1));\n\tpr_info(\"s: %d\\n\", size);\n\tmemcpy(&target, &before, size);\n\n\t \n\tfortify_scratch_space = target.a[3];\n\n\tpr_err(\"FAIL: fortify did not block a memcpy() object write overflow!\\n\");\n\tpr_expected_config(CONFIG_FORTIFY_SOURCE);\n}\n\nstatic void lkdtm_FORTIFY_MEM_MEMBER(void)\n{\n\tstruct target {\n\t\tchar a[10];\n\t\tchar b[10];\n\t} target;\n\tvolatile int size = 20;\n\tchar *src;\n\n\tsrc = kmalloc(size, GFP_KERNEL);\n\tstrscpy(src, \"over ten bytes\", size);\n\tsize = strlen(src) + 1;\n\n\tpr_info(\"trying to memcpy() past the end of a struct member...\\n\");\n\n\t \n\tmemcpy(target.a, src, size);\n\n\t \n\tfortify_scratch_space = target.a[3];\n\n\tpr_err(\"FAIL: fortify did not block a memcpy() struct member write overflow!\\n\");\n\tpr_expected_config(CONFIG_FORTIFY_SOURCE);\n\n\tkfree(src);\n}\n\n \nstatic void lkdtm_FORTIFY_STRSCPY(void)\n{\n\tchar *src;\n\tchar dst[5];\n\n\tstruct {\n\t\tunion {\n\t\t\tchar big[10];\n\t\t\tchar src[5];\n\t\t};\n\t} weird = { .big = \"hello!\" };\n\tchar weird_dst[sizeof(weird.src) + 1];\n\n\tsrc = kstrdup(\"foobar\", GFP_KERNEL);\n\n\tif (src == NULL)\n\t\treturn;\n\n\t \n\tif (strscpy(dst, src, 0) != -E2BIG)\n\t\tpr_warn(\"FAIL: strscpy() of 0 length did not return -E2BIG\\n\");\n\n\t \n\tif (strscpy(dst, src, sizeof(dst)) != -E2BIG)\n\t\tpr_warn(\"FAIL: strscpy() did not return -E2BIG while src is truncated\\n\");\n\n\t \n\tif (strncmp(dst, \"foob\", sizeof(dst)) != 0)\n\t\tpr_warn(\"FAIL: after strscpy() dst does not contain \\\"foob\\\" but \\\"%s\\\"\\n\",\n\t\t\tdst);\n\n\t \n\tsrc[3] = '\\0';\n\n\t \n\tif (strscpy(dst, src, sizeof(dst)) != 3)\n\t\tpr_warn(\"FAIL: strscpy() did not return 3 while src was copied entirely truncated\\n\");\n\n\t \n\tif (strncmp(dst, \"foo\", sizeof(dst)) != 0)\n\t\tpr_warn(\"FAIL: after strscpy() dst does not contain \\\"foo\\\" but \\\"%s\\\"\\n\",\n\t\t\tdst);\n\n\t \n\tstrscpy(weird_dst, weird.src, sizeof(weird_dst));\n\n\tif (strcmp(weird_dst, \"hello\") != 0)\n\t\tpr_warn(\"FAIL: after strscpy() weird_dst does not contain \\\"hello\\\" but \\\"%s\\\"\\n\",\n\t\t\tweird_dst);\n\n\t \n\tsrc[3] = 'b';\n\n\t \n\tstrscpy(dst, src, strlen(src));\n\n\tpr_err(\"FAIL: strscpy() overflow not detected!\\n\");\n\tpr_expected_config(CONFIG_FORTIFY_SOURCE);\n\n\tkfree(src);\n}\n\nstatic struct crashtype crashtypes[] = {\n\tCRASHTYPE(FORTIFY_STR_OBJECT),\n\tCRASHTYPE(FORTIFY_STR_MEMBER),\n\tCRASHTYPE(FORTIFY_MEM_OBJECT),\n\tCRASHTYPE(FORTIFY_MEM_MEMBER),\n\tCRASHTYPE(FORTIFY_STRSCPY),\n};\n\nstruct crashtype_category fortify_crashtypes = {\n\t.crashtypes = crashtypes,\n\t.len\t    = ARRAY_SIZE(crashtypes),\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}