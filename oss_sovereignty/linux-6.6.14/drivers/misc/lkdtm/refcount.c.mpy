{
  "module_name": "refcount.c",
  "hash_id": "f7893f895c00d14d3d84faf05ab368d1942e2ef520f26ad1eeb135c73ffa76a8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/lkdtm/refcount.c",
  "human_readable_source": "\n \n#include \"lkdtm.h\"\n#include <linux/refcount.h>\n\nstatic void overflow_check(refcount_t *ref)\n{\n\tswitch (refcount_read(ref)) {\n\tcase REFCOUNT_SATURATED:\n\t\tpr_info(\"Overflow detected: saturated\\n\");\n\t\tbreak;\n\tcase REFCOUNT_MAX:\n\t\tpr_warn(\"Overflow detected: unsafely reset to max\\n\");\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"Fail: refcount wrapped to %d\\n\", refcount_read(ref));\n\t}\n}\n\n \nstatic void lkdtm_REFCOUNT_INC_OVERFLOW(void)\n{\n\trefcount_t over = REFCOUNT_INIT(REFCOUNT_MAX - 1);\n\n\tpr_info(\"attempting good refcount_inc() without overflow\\n\");\n\trefcount_dec(&over);\n\trefcount_inc(&over);\n\n\tpr_info(\"attempting bad refcount_inc() overflow\\n\");\n\trefcount_inc(&over);\n\trefcount_inc(&over);\n\n\toverflow_check(&over);\n}\n\n \nstatic void lkdtm_REFCOUNT_ADD_OVERFLOW(void)\n{\n\trefcount_t over = REFCOUNT_INIT(REFCOUNT_MAX - 1);\n\n\tpr_info(\"attempting good refcount_add() without overflow\\n\");\n\trefcount_dec(&over);\n\trefcount_dec(&over);\n\trefcount_dec(&over);\n\trefcount_dec(&over);\n\trefcount_add(4, &over);\n\n\tpr_info(\"attempting bad refcount_add() overflow\\n\");\n\trefcount_add(4, &over);\n\n\toverflow_check(&over);\n}\n\n \nstatic void lkdtm_REFCOUNT_INC_NOT_ZERO_OVERFLOW(void)\n{\n\trefcount_t over = REFCOUNT_INIT(REFCOUNT_MAX);\n\n\tpr_info(\"attempting bad refcount_inc_not_zero() overflow\\n\");\n\tif (!refcount_inc_not_zero(&over))\n\t\tpr_warn(\"Weird: refcount_inc_not_zero() reported zero\\n\");\n\n\toverflow_check(&over);\n}\n\n \nstatic void lkdtm_REFCOUNT_ADD_NOT_ZERO_OVERFLOW(void)\n{\n\trefcount_t over = REFCOUNT_INIT(REFCOUNT_MAX);\n\n\tpr_info(\"attempting bad refcount_add_not_zero() overflow\\n\");\n\tif (!refcount_add_not_zero(6, &over))\n\t\tpr_warn(\"Weird: refcount_add_not_zero() reported zero\\n\");\n\n\toverflow_check(&over);\n}\n\nstatic void check_zero(refcount_t *ref)\n{\n\tswitch (refcount_read(ref)) {\n\tcase REFCOUNT_SATURATED:\n\t\tpr_info(\"Zero detected: saturated\\n\");\n\t\tbreak;\n\tcase REFCOUNT_MAX:\n\t\tpr_warn(\"Zero detected: unsafely reset to max\\n\");\n\t\tbreak;\n\tcase 0:\n\t\tpr_warn(\"Still at zero: refcount_inc/add() must not inc-from-0\\n\");\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"Fail: refcount went crazy: %d\\n\", refcount_read(ref));\n\t}\n}\n\n \nstatic void lkdtm_REFCOUNT_DEC_ZERO(void)\n{\n\trefcount_t zero = REFCOUNT_INIT(2);\n\n\tpr_info(\"attempting good refcount_dec()\\n\");\n\trefcount_dec(&zero);\n\n\tpr_info(\"attempting bad refcount_dec() to zero\\n\");\n\trefcount_dec(&zero);\n\n\tcheck_zero(&zero);\n}\n\nstatic void check_negative(refcount_t *ref, int start)\n{\n\t \n\tif (refcount_read(ref) == start) {\n\t\tpr_warn(\"Still at %d: refcount_inc/add() must not inc-from-0\\n\",\n\t\t\tstart);\n\t\treturn;\n\t}\n\n\tswitch (refcount_read(ref)) {\n\tcase REFCOUNT_SATURATED:\n\t\tpr_info(\"Negative detected: saturated\\n\");\n\t\tbreak;\n\tcase REFCOUNT_MAX:\n\t\tpr_warn(\"Negative detected: unsafely reset to max\\n\");\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"Fail: refcount went crazy: %d\\n\", refcount_read(ref));\n\t}\n}\n\n \nstatic void lkdtm_REFCOUNT_DEC_NEGATIVE(void)\n{\n\trefcount_t neg = REFCOUNT_INIT(0);\n\n\tpr_info(\"attempting bad refcount_dec() below zero\\n\");\n\trefcount_dec(&neg);\n\n\tcheck_negative(&neg, 0);\n}\n\n \nstatic void lkdtm_REFCOUNT_DEC_AND_TEST_NEGATIVE(void)\n{\n\trefcount_t neg = REFCOUNT_INIT(0);\n\n\tpr_info(\"attempting bad refcount_dec_and_test() below zero\\n\");\n\tif (refcount_dec_and_test(&neg))\n\t\tpr_warn(\"Weird: refcount_dec_and_test() reported zero\\n\");\n\n\tcheck_negative(&neg, 0);\n}\n\n \nstatic void lkdtm_REFCOUNT_SUB_AND_TEST_NEGATIVE(void)\n{\n\trefcount_t neg = REFCOUNT_INIT(3);\n\n\tpr_info(\"attempting bad refcount_sub_and_test() below zero\\n\");\n\tif (refcount_sub_and_test(5, &neg))\n\t\tpr_warn(\"Weird: refcount_sub_and_test() reported zero\\n\");\n\n\tcheck_negative(&neg, 3);\n}\n\nstatic void check_from_zero(refcount_t *ref)\n{\n\tswitch (refcount_read(ref)) {\n\tcase 0:\n\t\tpr_info(\"Zero detected: stayed at zero\\n\");\n\t\tbreak;\n\tcase REFCOUNT_SATURATED:\n\t\tpr_info(\"Zero detected: saturated\\n\");\n\t\tbreak;\n\tcase REFCOUNT_MAX:\n\t\tpr_warn(\"Zero detected: unsafely reset to max\\n\");\n\t\tbreak;\n\tdefault:\n\t\tpr_info(\"Fail: zero not detected, incremented to %d\\n\",\n\t\t\trefcount_read(ref));\n\t}\n}\n\n \nstatic void lkdtm_REFCOUNT_INC_ZERO(void)\n{\n\trefcount_t zero = REFCOUNT_INIT(0);\n\n\tpr_info(\"attempting safe refcount_inc_not_zero() from zero\\n\");\n\tif (!refcount_inc_not_zero(&zero)) {\n\t\tpr_info(\"Good: zero detected\\n\");\n\t\tif (refcount_read(&zero) == 0)\n\t\t\tpr_info(\"Correctly stayed at zero\\n\");\n\t\telse\n\t\t\tpr_err(\"Fail: refcount went past zero!\\n\");\n\t} else {\n\t\tpr_err(\"Fail: Zero not detected!?\\n\");\n\t}\n\n\tpr_info(\"attempting bad refcount_inc() from zero\\n\");\n\trefcount_inc(&zero);\n\n\tcheck_from_zero(&zero);\n}\n\n \nstatic void lkdtm_REFCOUNT_ADD_ZERO(void)\n{\n\trefcount_t zero = REFCOUNT_INIT(0);\n\n\tpr_info(\"attempting safe refcount_add_not_zero() from zero\\n\");\n\tif (!refcount_add_not_zero(3, &zero)) {\n\t\tpr_info(\"Good: zero detected\\n\");\n\t\tif (refcount_read(&zero) == 0)\n\t\t\tpr_info(\"Correctly stayed at zero\\n\");\n\t\telse\n\t\t\tpr_err(\"Fail: refcount went past zero\\n\");\n\t} else {\n\t\tpr_err(\"Fail: Zero not detected!?\\n\");\n\t}\n\n\tpr_info(\"attempting bad refcount_add() from zero\\n\");\n\trefcount_add(3, &zero);\n\n\tcheck_from_zero(&zero);\n}\n\nstatic void check_saturated(refcount_t *ref)\n{\n\tswitch (refcount_read(ref)) {\n\tcase REFCOUNT_SATURATED:\n\t\tpr_info(\"Saturation detected: still saturated\\n\");\n\t\tbreak;\n\tcase REFCOUNT_MAX:\n\t\tpr_warn(\"Saturation detected: unsafely reset to max\\n\");\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"Fail: refcount went crazy: %d\\n\", refcount_read(ref));\n\t}\n}\n\n \nstatic void lkdtm_REFCOUNT_INC_SATURATED(void)\n{\n\trefcount_t sat = REFCOUNT_INIT(REFCOUNT_SATURATED);\n\n\tpr_info(\"attempting bad refcount_inc() from saturated\\n\");\n\trefcount_inc(&sat);\n\n\tcheck_saturated(&sat);\n}\n\n \nstatic void lkdtm_REFCOUNT_DEC_SATURATED(void)\n{\n\trefcount_t sat = REFCOUNT_INIT(REFCOUNT_SATURATED);\n\n\tpr_info(\"attempting bad refcount_dec() from saturated\\n\");\n\trefcount_dec(&sat);\n\n\tcheck_saturated(&sat);\n}\n\n \nstatic void lkdtm_REFCOUNT_ADD_SATURATED(void)\n{\n\trefcount_t sat = REFCOUNT_INIT(REFCOUNT_SATURATED);\n\n\tpr_info(\"attempting bad refcount_dec() from saturated\\n\");\n\trefcount_add(8, &sat);\n\n\tcheck_saturated(&sat);\n}\n\n \nstatic void lkdtm_REFCOUNT_INC_NOT_ZERO_SATURATED(void)\n{\n\trefcount_t sat = REFCOUNT_INIT(REFCOUNT_SATURATED);\n\n\tpr_info(\"attempting bad refcount_inc_not_zero() from saturated\\n\");\n\tif (!refcount_inc_not_zero(&sat))\n\t\tpr_warn(\"Weird: refcount_inc_not_zero() reported zero\\n\");\n\n\tcheck_saturated(&sat);\n}\n\n \nstatic void lkdtm_REFCOUNT_ADD_NOT_ZERO_SATURATED(void)\n{\n\trefcount_t sat = REFCOUNT_INIT(REFCOUNT_SATURATED);\n\n\tpr_info(\"attempting bad refcount_add_not_zero() from saturated\\n\");\n\tif (!refcount_add_not_zero(7, &sat))\n\t\tpr_warn(\"Weird: refcount_add_not_zero() reported zero\\n\");\n\n\tcheck_saturated(&sat);\n}\n\n \nstatic void lkdtm_REFCOUNT_DEC_AND_TEST_SATURATED(void)\n{\n\trefcount_t sat = REFCOUNT_INIT(REFCOUNT_SATURATED);\n\n\tpr_info(\"attempting bad refcount_dec_and_test() from saturated\\n\");\n\tif (refcount_dec_and_test(&sat))\n\t\tpr_warn(\"Weird: refcount_dec_and_test() reported zero\\n\");\n\n\tcheck_saturated(&sat);\n}\n\n \nstatic void lkdtm_REFCOUNT_SUB_AND_TEST_SATURATED(void)\n{\n\trefcount_t sat = REFCOUNT_INIT(REFCOUNT_SATURATED);\n\n\tpr_info(\"attempting bad refcount_sub_and_test() from saturated\\n\");\n\tif (refcount_sub_and_test(8, &sat))\n\t\tpr_warn(\"Weird: refcount_sub_and_test() reported zero\\n\");\n\n\tcheck_saturated(&sat);\n}\n\n \nstatic void lkdtm_ATOMIC_TIMING(void)\n{\n\tunsigned int i;\n\tatomic_t count = ATOMIC_INIT(1);\n\n\tfor (i = 0; i < INT_MAX - 1; i++)\n\t\tatomic_inc(&count);\n\n\tfor (i = INT_MAX; i > 0; i--)\n\t\tif (atomic_dec_and_test(&count))\n\t\t\tbreak;\n\n\tif (i != 1)\n\t\tpr_err(\"atomic timing: out of sync up/down cycle: %u\\n\", i - 1);\n\telse\n\t\tpr_info(\"atomic timing: done\\n\");\n}\n\n \nstatic void lkdtm_REFCOUNT_TIMING(void)\n{\n\tunsigned int i;\n\trefcount_t count = REFCOUNT_INIT(1);\n\n\tfor (i = 0; i < INT_MAX - 1; i++)\n\t\trefcount_inc(&count);\n\n\tfor (i = INT_MAX; i > 0; i--)\n\t\tif (refcount_dec_and_test(&count))\n\t\t\tbreak;\n\n\tif (i != 1)\n\t\tpr_err(\"refcount: out of sync up/down cycle: %u\\n\", i - 1);\n\telse\n\t\tpr_info(\"refcount timing: done\\n\");\n}\n\nstatic struct crashtype crashtypes[] = {\n\tCRASHTYPE(REFCOUNT_INC_OVERFLOW),\n\tCRASHTYPE(REFCOUNT_ADD_OVERFLOW),\n\tCRASHTYPE(REFCOUNT_INC_NOT_ZERO_OVERFLOW),\n\tCRASHTYPE(REFCOUNT_ADD_NOT_ZERO_OVERFLOW),\n\tCRASHTYPE(REFCOUNT_DEC_ZERO),\n\tCRASHTYPE(REFCOUNT_DEC_NEGATIVE),\n\tCRASHTYPE(REFCOUNT_DEC_AND_TEST_NEGATIVE),\n\tCRASHTYPE(REFCOUNT_SUB_AND_TEST_NEGATIVE),\n\tCRASHTYPE(REFCOUNT_INC_ZERO),\n\tCRASHTYPE(REFCOUNT_ADD_ZERO),\n\tCRASHTYPE(REFCOUNT_INC_SATURATED),\n\tCRASHTYPE(REFCOUNT_DEC_SATURATED),\n\tCRASHTYPE(REFCOUNT_ADD_SATURATED),\n\tCRASHTYPE(REFCOUNT_INC_NOT_ZERO_SATURATED),\n\tCRASHTYPE(REFCOUNT_ADD_NOT_ZERO_SATURATED),\n\tCRASHTYPE(REFCOUNT_DEC_AND_TEST_SATURATED),\n\tCRASHTYPE(REFCOUNT_SUB_AND_TEST_SATURATED),\n\tCRASHTYPE(ATOMIC_TIMING),\n\tCRASHTYPE(REFCOUNT_TIMING),\n};\n\nstruct crashtype_category refcount_crashtypes = {\n\t.crashtypes = crashtypes,\n\t.len\t    = ARRAY_SIZE(crashtypes),\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}