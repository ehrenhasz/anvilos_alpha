{
  "module_name": "xp_uv.c",
  "hash_id": "77cf102250470fb1aaf963411eb7a65cb1c3140d9607a2d100faa713f37a8e69",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/sgi-xp/xp_uv.c",
  "human_readable_source": " \n\n \n\n#include <linux/device.h>\n#include <asm/uv/uv_hub.h>\n#if defined CONFIG_X86_64\n#include <asm/uv/bios.h>\n#elif defined CONFIG_IA64_SGI_UV\n#include <asm/sn/sn_sal.h>\n#endif\n#include \"../sgi-gru/grukservices.h\"\n#include \"xp.h\"\n\n \nstatic unsigned long\nxp_pa_uv(void *addr)\n{\n\treturn uv_gpa(addr);\n}\n\n \nstatic unsigned long\nxp_socket_pa_uv(unsigned long gpa)\n{\n\treturn uv_gpa_to_soc_phys_ram(gpa);\n}\n\nstatic enum xp_retval\nxp_remote_mmr_read(unsigned long dst_gpa, const unsigned long src_gpa,\n\t\t   size_t len)\n{\n\tint ret;\n\tunsigned long *dst_va = __va(uv_gpa_to_soc_phys_ram(dst_gpa));\n\n\tBUG_ON(!uv_gpa_in_mmr_space(src_gpa));\n\tBUG_ON(len != 8);\n\n\tret = gru_read_gpa(dst_va, src_gpa);\n\tif (ret == 0)\n\t\treturn xpSuccess;\n\n\tdev_err(xp, \"gru_read_gpa() failed, dst_gpa=0x%016lx src_gpa=0x%016lx \"\n\t\t\"len=%ld\\n\", dst_gpa, src_gpa, len);\n\treturn xpGruCopyError;\n}\n\n\nstatic enum xp_retval\nxp_remote_memcpy_uv(unsigned long dst_gpa, const unsigned long src_gpa,\n\t\t    size_t len)\n{\n\tint ret;\n\n\tif (uv_gpa_in_mmr_space(src_gpa))\n\t\treturn xp_remote_mmr_read(dst_gpa, src_gpa, len);\n\n\tret = gru_copy_gpa(dst_gpa, src_gpa, len);\n\tif (ret == 0)\n\t\treturn xpSuccess;\n\n\tdev_err(xp, \"gru_copy_gpa() failed, dst_gpa=0x%016lx src_gpa=0x%016lx \"\n\t\t\"len=%ld\\n\", dst_gpa, src_gpa, len);\n\treturn xpGruCopyError;\n}\n\nstatic int\nxp_cpu_to_nasid_uv(int cpuid)\n{\n\t \n\treturn UV_PNODE_TO_NASID(uv_cpu_to_pnode(cpuid));\n}\n\nstatic enum xp_retval\nxp_expand_memprotect_uv(unsigned long phys_addr, unsigned long size)\n{\n\tint ret;\n\n#if defined CONFIG_X86_64\n\tret = uv_bios_change_memprotect(phys_addr, size, UV_MEMPROT_ALLOW_RW);\n\tif (ret != BIOS_STATUS_SUCCESS) {\n\t\tdev_err(xp, \"uv_bios_change_memprotect(,, \"\n\t\t\t\"UV_MEMPROT_ALLOW_RW) failed, ret=%d\\n\", ret);\n\t\treturn xpBiosError;\n\t}\n\n#elif defined CONFIG_IA64_SGI_UV\n\tu64 nasid_array;\n\n\tret = sn_change_memprotect(phys_addr, size, SN_MEMPROT_ACCESS_CLASS_1,\n\t\t\t\t   &nasid_array);\n\tif (ret != 0) {\n\t\tdev_err(xp, \"sn_change_memprotect(,, \"\n\t\t\t\"SN_MEMPROT_ACCESS_CLASS_1,) failed ret=%d\\n\", ret);\n\t\treturn xpSalError;\n\t}\n#else\n\t#error not a supported configuration\n#endif\n\treturn xpSuccess;\n}\n\nstatic enum xp_retval\nxp_restrict_memprotect_uv(unsigned long phys_addr, unsigned long size)\n{\n\tint ret;\n\n#if defined CONFIG_X86_64\n\tret = uv_bios_change_memprotect(phys_addr, size,\n\t\t\t\t\tUV_MEMPROT_RESTRICT_ACCESS);\n\tif (ret != BIOS_STATUS_SUCCESS) {\n\t\tdev_err(xp, \"uv_bios_change_memprotect(,, \"\n\t\t\t\"UV_MEMPROT_RESTRICT_ACCESS) failed, ret=%d\\n\", ret);\n\t\treturn xpBiosError;\n\t}\n\n#elif defined CONFIG_IA64_SGI_UV\n\tu64 nasid_array;\n\n\tret = sn_change_memprotect(phys_addr, size, SN_MEMPROT_ACCESS_CLASS_0,\n\t\t\t\t   &nasid_array);\n\tif (ret != 0) {\n\t\tdev_err(xp, \"sn_change_memprotect(,, \"\n\t\t\t\"SN_MEMPROT_ACCESS_CLASS_0,) failed ret=%d\\n\", ret);\n\t\treturn xpSalError;\n\t}\n#else\n\t#error not a supported configuration\n#endif\n\treturn xpSuccess;\n}\n\nenum xp_retval\nxp_init_uv(void)\n{\n\tWARN_ON(!is_uv_system());\n\tif (!is_uv_system())\n\t\treturn xpUnsupported;\n\n\txp_max_npartitions = XP_MAX_NPARTITIONS_UV;\n#ifdef CONFIG_X86\n\txp_partition_id = sn_partition_id;\n\txp_region_size = sn_region_size;\n#endif\n\txp_pa = xp_pa_uv;\n\txp_socket_pa = xp_socket_pa_uv;\n\txp_remote_memcpy = xp_remote_memcpy_uv;\n\txp_cpu_to_nasid = xp_cpu_to_nasid_uv;\n\txp_expand_memprotect = xp_expand_memprotect_uv;\n\txp_restrict_memprotect = xp_restrict_memprotect_uv;\n\n\treturn xpSuccess;\n}\n\nvoid\nxp_exit_uv(void)\n{\n\tWARN_ON(!is_uv_system());\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}