{
  "module_name": "sgbuf2.c",
  "hash_id": "988363c43822a50d075e5e8988349832d874344be2681ef4c16ecbc9cc85d0b5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/cb710/sgbuf2.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/cb710.h>\n\nstatic bool sg_dwiter_next(struct sg_mapping_iter *miter)\n{\n\tif (sg_miter_next(miter)) {\n\t\tmiter->consumed = 0;\n\t\treturn true;\n\t} else\n\t\treturn false;\n}\n\nstatic bool sg_dwiter_is_at_end(struct sg_mapping_iter *miter)\n{\n\treturn miter->length == miter->consumed && !sg_dwiter_next(miter);\n}\n\nstatic uint32_t sg_dwiter_read_buffer(struct sg_mapping_iter *miter)\n{\n\tsize_t len, left = 4;\n\tuint32_t data;\n\tvoid *addr = &data;\n\n\tdo {\n\t\tlen = min(miter->length - miter->consumed, left);\n\t\tmemcpy(addr, miter->addr + miter->consumed, len);\n\t\tmiter->consumed += len;\n\t\tleft -= len;\n\t\tif (!left)\n\t\t\treturn data;\n\t\taddr += len;\n\t} while (sg_dwiter_next(miter));\n\n\tmemset(addr, 0, left);\n\treturn data;\n}\n\nstatic inline bool needs_unaligned_copy(const void *ptr)\n{\n#ifdef CONFIG_HAVE_EFFICIENT_UNALIGNED_ACCESS\n\treturn false;\n#else\n\treturn ((uintptr_t)ptr & 3) != 0;\n#endif\n}\n\nstatic bool sg_dwiter_get_next_block(struct sg_mapping_iter *miter, uint32_t **ptr)\n{\n\tsize_t len;\n\n\tif (sg_dwiter_is_at_end(miter))\n\t\treturn true;\n\n\tlen = miter->length - miter->consumed;\n\n\tif (likely(len >= 4 && !needs_unaligned_copy(\n\t\t\tmiter->addr + miter->consumed))) {\n\t\t*ptr = miter->addr + miter->consumed;\n\t\tmiter->consumed += 4;\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n \nuint32_t cb710_sg_dwiter_read_next_block(struct sg_mapping_iter *miter)\n{\n\tuint32_t *ptr = NULL;\n\n\tif (likely(sg_dwiter_get_next_block(miter, &ptr)))\n\t\treturn ptr ? *ptr : 0;\n\n\treturn sg_dwiter_read_buffer(miter);\n}\nEXPORT_SYMBOL_GPL(cb710_sg_dwiter_read_next_block);\n\nstatic void sg_dwiter_write_slow(struct sg_mapping_iter *miter, uint32_t data)\n{\n\tsize_t len, left = 4;\n\tvoid *addr = &data;\n\n\tdo {\n\t\tlen = min(miter->length - miter->consumed, left);\n\t\tmemcpy(miter->addr, addr, len);\n\t\tmiter->consumed += len;\n\t\tleft -= len;\n\t\tif (!left)\n\t\t\treturn;\n\t\taddr += len;\n\t} while (sg_dwiter_next(miter));\n}\n\n \nvoid cb710_sg_dwiter_write_next_block(struct sg_mapping_iter *miter, uint32_t data)\n{\n\tuint32_t *ptr = NULL;\n\n\tif (likely(sg_dwiter_get_next_block(miter, &ptr))) {\n\t\tif (ptr)\n\t\t\t*ptr = data;\n\t\telse\n\t\t\treturn;\n\t} else\n\t\tsg_dwiter_write_slow(miter, data);\n}\nEXPORT_SYMBOL_GPL(cb710_sg_dwiter_write_next_block);\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}