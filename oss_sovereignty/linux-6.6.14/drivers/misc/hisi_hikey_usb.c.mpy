{
  "module_name": "hisi_hikey_usb.c",
  "hash_id": "c4789388e4f0cbb32270042274d8d1a8c5332c2f14724049079face27ec9ac76",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/hisi_hikey_usb.c",
  "human_readable_source": "\n \n\n#include <linux/gpio/consumer.h>\n#include <linux/kernel.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/notifier.h>\n#include <linux/of_gpio.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/regulator/consumer.h>\n#include <linux/slab.h>\n#include <linux/usb/role.h>\n\n#define DEVICE_DRIVER_NAME \"hisi_hikey_usb\"\n\n#define HUB_VBUS_POWER_ON 1\n#define HUB_VBUS_POWER_OFF 0\n#define USB_SWITCH_TO_HUB 1\n#define USB_SWITCH_TO_TYPEC 0\n#define TYPEC_VBUS_POWER_ON 1\n#define TYPEC_VBUS_POWER_OFF 0\n\nstruct hisi_hikey_usb {\n\tstruct device *dev;\n\tstruct gpio_desc *otg_switch;\n\tstruct gpio_desc *typec_vbus;\n\tstruct gpio_desc *reset;\n\n\tstruct regulator *regulator;\n\n\tstruct usb_role_switch *hub_role_sw;\n\n\tstruct usb_role_switch *dev_role_sw;\n\tenum usb_role role;\n\n\tstruct mutex lock;\n\tstruct work_struct work;\n\n\tstruct notifier_block nb;\n};\n\nstatic void hub_power_ctrl(struct hisi_hikey_usb *hisi_hikey_usb, int value)\n{\n\tint ret, status;\n\n\tif (!hisi_hikey_usb->regulator)\n\t\treturn;\n\n\tstatus = regulator_is_enabled(hisi_hikey_usb->regulator);\n\tif (status == !!value)\n\t\treturn;\n\n\tif (value)\n\t\tret = regulator_enable(hisi_hikey_usb->regulator);\n\telse\n\t\tret = regulator_disable(hisi_hikey_usb->regulator);\n\n\tif (ret)\n\t\tdev_err(hisi_hikey_usb->dev,\n\t\t\t\"Can't switch regulator state to %s\\n\",\n\t\t\tvalue ? \"enabled\" : \"disabled\");\n}\n\nstatic void usb_switch_ctrl(struct hisi_hikey_usb *hisi_hikey_usb,\n\t\t\t    int switch_to)\n{\n\tif (!hisi_hikey_usb->otg_switch)\n\t\treturn;\n\n\tgpiod_set_value_cansleep(hisi_hikey_usb->otg_switch, switch_to);\n}\n\nstatic void usb_typec_power_ctrl(struct hisi_hikey_usb *hisi_hikey_usb,\n\t\t\t\t int value)\n{\n\tif (!hisi_hikey_usb->typec_vbus)\n\t\treturn;\n\n\tgpiod_set_value_cansleep(hisi_hikey_usb->typec_vbus, value);\n}\n\nstatic void relay_set_role_switch(struct work_struct *work)\n{\n\tstruct hisi_hikey_usb *hisi_hikey_usb = container_of(work,\n\t\t\t\t\t\t\tstruct hisi_hikey_usb,\n\t\t\t\t\t\t\twork);\n\tstruct usb_role_switch *sw;\n\tenum usb_role role;\n\n\tif (!hisi_hikey_usb || !hisi_hikey_usb->dev_role_sw)\n\t\treturn;\n\n\tmutex_lock(&hisi_hikey_usb->lock);\n\tswitch (hisi_hikey_usb->role) {\n\tcase USB_ROLE_NONE:\n\t\tusb_typec_power_ctrl(hisi_hikey_usb, TYPEC_VBUS_POWER_OFF);\n\t\tusb_switch_ctrl(hisi_hikey_usb, USB_SWITCH_TO_HUB);\n\t\thub_power_ctrl(hisi_hikey_usb, HUB_VBUS_POWER_ON);\n\t\tbreak;\n\tcase USB_ROLE_HOST:\n\t\thub_power_ctrl(hisi_hikey_usb, HUB_VBUS_POWER_OFF);\n\t\tusb_switch_ctrl(hisi_hikey_usb, USB_SWITCH_TO_TYPEC);\n\t\tusb_typec_power_ctrl(hisi_hikey_usb, TYPEC_VBUS_POWER_ON);\n\t\tbreak;\n\tcase USB_ROLE_DEVICE:\n\t\thub_power_ctrl(hisi_hikey_usb, HUB_VBUS_POWER_OFF);\n\t\tusb_typec_power_ctrl(hisi_hikey_usb, TYPEC_VBUS_POWER_OFF);\n\t\tusb_switch_ctrl(hisi_hikey_usb, USB_SWITCH_TO_TYPEC);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tsw = hisi_hikey_usb->dev_role_sw;\n\trole = hisi_hikey_usb->role;\n\tmutex_unlock(&hisi_hikey_usb->lock);\n\n\tusb_role_switch_set_role(sw, role);\n}\n\nstatic int hub_usb_role_switch_set(struct usb_role_switch *sw, enum usb_role role)\n{\n\tstruct hisi_hikey_usb *hisi_hikey_usb = usb_role_switch_get_drvdata(sw);\n\n\tif (!hisi_hikey_usb || !hisi_hikey_usb->dev_role_sw)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&hisi_hikey_usb->lock);\n\thisi_hikey_usb->role = role;\n\tmutex_unlock(&hisi_hikey_usb->lock);\n\n\tschedule_work(&hisi_hikey_usb->work);\n\n\treturn 0;\n}\n\nstatic int hisi_hikey_usb_of_role_switch(struct platform_device *pdev,\n\t\t\t\t\t struct hisi_hikey_usb *hisi_hikey_usb)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct usb_role_switch_desc hub_role_switch = {NULL};\n\n\tif (!device_property_read_bool(dev, \"usb-role-switch\"))\n\t\treturn 0;\n\n\thisi_hikey_usb->otg_switch = devm_gpiod_get(dev, \"otg-switch\",\n\t\t\t\t\t\t    GPIOD_OUT_HIGH);\n\tif (IS_ERR(hisi_hikey_usb->otg_switch)) {\n\t\tdev_err(dev, \"get otg-switch failed with error %ld\\n\",\n\t\t\tPTR_ERR(hisi_hikey_usb->otg_switch));\n\t\treturn PTR_ERR(hisi_hikey_usb->otg_switch);\n\t}\n\n\thisi_hikey_usb->typec_vbus = devm_gpiod_get(dev, \"typec-vbus\",\n\t\t\t\t\t\t    GPIOD_OUT_LOW);\n\tif (IS_ERR(hisi_hikey_usb->typec_vbus)) {\n\t\tdev_err(dev, \"get typec-vbus failed with error %ld\\n\",\n\t\t\tPTR_ERR(hisi_hikey_usb->typec_vbus));\n\t\treturn PTR_ERR(hisi_hikey_usb->typec_vbus);\n\t}\n\n\thisi_hikey_usb->reset = devm_gpiod_get_optional(dev,\n\t\t\t\t\t\t\t\"hub-reset-en\",\n\t\t\t\t\t\t\tGPIOD_OUT_HIGH);\n\tif (IS_ERR(hisi_hikey_usb->reset)) {\n\t\tdev_err(dev, \"get hub-reset-en failed with error %ld\\n\",\n\t\t\tPTR_ERR(hisi_hikey_usb->reset));\n\t\treturn PTR_ERR(hisi_hikey_usb->reset);\n\t}\n\n\thisi_hikey_usb->dev_role_sw = usb_role_switch_get(dev);\n\tif (!hisi_hikey_usb->dev_role_sw)\n\t\treturn -EPROBE_DEFER;\n\tif (IS_ERR(hisi_hikey_usb->dev_role_sw)) {\n\t\tdev_err(dev, \"get device role switch failed with error %ld\\n\",\n\t\t\tPTR_ERR(hisi_hikey_usb->dev_role_sw));\n\t\treturn PTR_ERR(hisi_hikey_usb->dev_role_sw);\n\t}\n\n\tINIT_WORK(&hisi_hikey_usb->work, relay_set_role_switch);\n\n\thub_role_switch.fwnode = dev_fwnode(dev);\n\thub_role_switch.set = hub_usb_role_switch_set;\n\thub_role_switch.driver_data = hisi_hikey_usb;\n\n\thisi_hikey_usb->hub_role_sw = usb_role_switch_register(dev,\n\t\t\t\t\t\t\t       &hub_role_switch);\n\n\tif (IS_ERR(hisi_hikey_usb->hub_role_sw)) {\n\t\tdev_err(dev,\n\t\t\t\"failed to register hub role with error %ld\\n\",\n\t\t\tPTR_ERR(hisi_hikey_usb->hub_role_sw));\n\t\tusb_role_switch_put(hisi_hikey_usb->dev_role_sw);\n\t\treturn PTR_ERR(hisi_hikey_usb->hub_role_sw);\n\t}\n\n\treturn 0;\n}\n\nstatic int hisi_hikey_usb_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct hisi_hikey_usb *hisi_hikey_usb;\n\tint ret;\n\n\thisi_hikey_usb = devm_kzalloc(dev, sizeof(*hisi_hikey_usb), GFP_KERNEL);\n\tif (!hisi_hikey_usb)\n\t\treturn -ENOMEM;\n\n\thisi_hikey_usb->dev = &pdev->dev;\n\tmutex_init(&hisi_hikey_usb->lock);\n\n\thisi_hikey_usb->regulator = devm_regulator_get(dev, \"hub-vdd\");\n\tif (IS_ERR(hisi_hikey_usb->regulator)) {\n\t\tif (PTR_ERR(hisi_hikey_usb->regulator) == -EPROBE_DEFER) {\n\t\t\tdev_info(dev, \"waiting for hub-vdd-supply\\n\");\n\t\t\treturn PTR_ERR(hisi_hikey_usb->regulator);\n\t\t}\n\t\tdev_err(dev, \"get hub-vdd-supply failed with error %ld\\n\",\n\t\t\tPTR_ERR(hisi_hikey_usb->regulator));\n\t\treturn PTR_ERR(hisi_hikey_usb->regulator);\n\t}\n\n\tret = hisi_hikey_usb_of_role_switch(pdev, hisi_hikey_usb);\n\tif (ret)\n\t\treturn ret;\n\n\tplatform_set_drvdata(pdev, hisi_hikey_usb);\n\n\treturn 0;\n}\n\nstatic int  hisi_hikey_usb_remove(struct platform_device *pdev)\n{\n\tstruct hisi_hikey_usb *hisi_hikey_usb = platform_get_drvdata(pdev);\n\n\tif (hisi_hikey_usb->hub_role_sw) {\n\t\tusb_role_switch_unregister(hisi_hikey_usb->hub_role_sw);\n\n\t\tif (hisi_hikey_usb->dev_role_sw)\n\t\t\tusb_role_switch_put(hisi_hikey_usb->dev_role_sw);\n\t} else {\n\t\thub_power_ctrl(hisi_hikey_usb, HUB_VBUS_POWER_OFF);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id id_table_hisi_hikey_usb[] = {\n\t{ .compatible = \"hisilicon,usbhub\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, id_table_hisi_hikey_usb);\n\nstatic struct platform_driver hisi_hikey_usb_driver = {\n\t.probe = hisi_hikey_usb_probe,\n\t.remove = hisi_hikey_usb_remove,\n\t.driver = {\n\t\t.name = DEVICE_DRIVER_NAME,\n\t\t.of_match_table = id_table_hisi_hikey_usb,\n\t},\n};\n\nmodule_platform_driver(hisi_hikey_usb_driver);\n\nMODULE_AUTHOR(\"Yu Chen <chenyu56@huawei.com>\");\nMODULE_DESCRIPTION(\"Driver Support for USB functionality of Hikey\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}