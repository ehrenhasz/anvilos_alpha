{
  "module_name": "lis3lv02d_spi.c",
  "hash_id": "31407427617c7e9ede752f4668b64a466f194fb1e501703259a5877952e78a30",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/lis3lv02d/lis3lv02d_spi.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/err.h>\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/workqueue.h>\n#include <linux/spi/spi.h>\n#include <linux/pm.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/of_device.h>\n\n#include \"lis3lv02d.h\"\n\n#define DRV_NAME \t\"lis3lv02d_spi\"\n#define LIS3_SPI_READ\t0x80\n\nstatic int lis3_spi_read(struct lis3lv02d *lis3, int reg, u8 *v)\n{\n\tstruct spi_device *spi = lis3->bus_priv;\n\tint ret = spi_w8r8(spi, reg | LIS3_SPI_READ);\n\tif (ret < 0)\n\t\treturn -EINVAL;\n\n\t*v = (u8) ret;\n\treturn 0;\n}\n\nstatic int lis3_spi_write(struct lis3lv02d *lis3, int reg, u8 val)\n{\n\tu8 tmp[2] = { reg, val };\n\tstruct spi_device *spi = lis3->bus_priv;\n\treturn spi_write(spi, tmp, sizeof(tmp));\n}\n\nstatic int lis3_spi_init(struct lis3lv02d *lis3)\n{\n\tu8 reg;\n\tint ret;\n\n\t \n\tret = lis3->read(lis3, CTRL_REG1, &reg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treg |= CTRL1_PD0 | CTRL1_Xen | CTRL1_Yen | CTRL1_Zen;\n\treturn lis3->write(lis3, CTRL_REG1, reg);\n}\n\nstatic union axis_conversion lis3lv02d_axis_normal =\n\t{ .as_array = { 1, 2, 3 } };\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id lis302dl_spi_dt_ids[] = {\n\t{ .compatible = \"st,lis302dl-spi\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, lis302dl_spi_dt_ids);\n#endif\n\nstatic int lis302dl_spi_probe(struct spi_device *spi)\n{\n\tint ret;\n\n\tspi->bits_per_word = 8;\n\tspi->mode = SPI_MODE_0;\n\tret = spi_setup(spi);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tlis3_dev.bus_priv\t= spi;\n\tlis3_dev.init\t\t= lis3_spi_init;\n\tlis3_dev.read\t\t= lis3_spi_read;\n\tlis3_dev.write\t\t= lis3_spi_write;\n\tlis3_dev.irq\t\t= spi->irq;\n\tlis3_dev.ac\t\t= lis3lv02d_axis_normal;\n\tlis3_dev.pdata\t\t= spi->dev.platform_data;\n\n#ifdef CONFIG_OF\n\tif (of_match_device(lis302dl_spi_dt_ids, &spi->dev)) {\n\t\tlis3_dev.of_node = spi->dev.of_node;\n\t\tret = lis3lv02d_init_dt(&lis3_dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n#endif\n\tspi_set_drvdata(spi, &lis3_dev);\n\n\treturn lis3lv02d_init_device(&lis3_dev);\n}\n\nstatic void lis302dl_spi_remove(struct spi_device *spi)\n{\n\tstruct lis3lv02d *lis3 = spi_get_drvdata(spi);\n\tlis3lv02d_joystick_disable(lis3);\n\tlis3lv02d_poweroff(lis3);\n\n\tlis3lv02d_remove_fs(&lis3_dev);\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int lis3lv02d_spi_suspend(struct device *dev)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tstruct lis3lv02d *lis3 = spi_get_drvdata(spi);\n\n\tif (!lis3->pdata || !lis3->pdata->wakeup_flags)\n\t\tlis3lv02d_poweroff(&lis3_dev);\n\n\treturn 0;\n}\n\nstatic int lis3lv02d_spi_resume(struct device *dev)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tstruct lis3lv02d *lis3 = spi_get_drvdata(spi);\n\n\tif (!lis3->pdata || !lis3->pdata->wakeup_flags)\n\t\tlis3lv02d_poweron(lis3);\n\n\treturn 0;\n}\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(lis3lv02d_spi_pm, lis3lv02d_spi_suspend,\n\t\t\t lis3lv02d_spi_resume);\n\nstatic struct spi_driver lis302dl_spi_driver = {\n\t.driver\t = {\n\t\t.name   = DRV_NAME,\n\t\t.pm\t= &lis3lv02d_spi_pm,\n\t\t.of_match_table = of_match_ptr(lis302dl_spi_dt_ids),\n\t},\n\t.probe\t= lis302dl_spi_probe,\n\t.remove\t= lis302dl_spi_remove,\n};\n\nmodule_spi_driver(lis302dl_spi_driver);\n\nMODULE_AUTHOR(\"Daniel Mack <daniel@caiaq.de>\");\nMODULE_DESCRIPTION(\"lis3lv02d SPI glue layer\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"spi:\" DRV_NAME);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}