{
  "module_name": "heartbeat.c",
  "hash_id": "879d48e5cedc795666676463da327c52fbe6a13bb149b47358faee03bf6cd8bc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/ibmasm/heartbeat.c",
  "human_readable_source": "\n\n \n\n#include <linux/notifier.h>\n#include <linux/panic_notifier.h>\n#include \"ibmasm.h\"\n#include \"dot_command.h\"\n#include \"lowlevel.h\"\n\nstatic int suspend_heartbeats = 0;\n\n \nstatic int panic_happened(struct notifier_block *n, unsigned long val, void *v)\n{\n\tsuspend_heartbeats = 1;\n\treturn 0;\n}\n\nstatic struct notifier_block panic_notifier = { panic_happened, NULL, 1 };\n\nvoid ibmasm_register_panic_notifier(void)\n{\n\tatomic_notifier_chain_register(&panic_notifier_list, &panic_notifier);\n}\n\nvoid ibmasm_unregister_panic_notifier(void)\n{\n\tatomic_notifier_chain_unregister(&panic_notifier_list,\n\t\t\t&panic_notifier);\n}\n\n\nint ibmasm_heartbeat_init(struct service_processor *sp)\n{\n\tsp->heartbeat = ibmasm_new_command(sp, HEARTBEAT_BUFFER_SIZE);\n\tif (sp->heartbeat == NULL)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\nvoid ibmasm_heartbeat_exit(struct service_processor *sp)\n{\n\tchar tsbuf[32];\n\n\tdbg(\"%s:%d at %s\\n\", __func__, __LINE__, get_timestamp(tsbuf));\n\tibmasm_wait_for_response(sp->heartbeat, IBMASM_CMD_TIMEOUT_NORMAL);\n\tdbg(\"%s:%d at %s\\n\", __func__, __LINE__, get_timestamp(tsbuf));\n\tsuspend_heartbeats = 1;\n\tcommand_put(sp->heartbeat);\n}\n\nvoid ibmasm_receive_heartbeat(struct service_processor *sp,  void *message, size_t size)\n{\n\tstruct command *cmd = sp->heartbeat;\n\tstruct dot_command_header *header = (struct dot_command_header *)cmd->buffer;\n\tchar tsbuf[32];\n\n\tdbg(\"%s:%d at %s\\n\", __func__, __LINE__, get_timestamp(tsbuf));\n\tif (suspend_heartbeats)\n\t\treturn;\n\n\t \n\tcmd->status = IBMASM_CMD_PENDING;\n\tsize = min(size, cmd->buffer_size);\n\tmemcpy_fromio(cmd->buffer, message, size);\n\theader->type = sp_write;\n\tibmasm_exec_command(sp, cmd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}