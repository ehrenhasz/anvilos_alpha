{
  "module_name": "rts5227.c",
  "hash_id": "65798452f0c00d0d3ab7315c64a28f5211dff5cdcfbf0e65262ac8d7abd910cd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/cardreader/rts5227.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/rtsx_pci.h>\n\n#include \"rtsx_pcr.h\"\n\nstatic u8 rts5227_get_ic_version(struct rtsx_pcr *pcr)\n{\n\tu8 val;\n\n\trtsx_pci_read_register(pcr, DUMMY_REG_RESET_0, &val);\n\treturn val & 0x0F;\n}\n\nstatic void rts5227_fill_driving(struct rtsx_pcr *pcr, u8 voltage)\n{\n\tu8 driving_3v3[4][3] = {\n\t\t{0x13, 0x13, 0x13},\n\t\t{0x96, 0x96, 0x96},\n\t\t{0x7F, 0x7F, 0x7F},\n\t\t{0x96, 0x96, 0x96},\n\t};\n\tu8 driving_1v8[4][3] = {\n\t\t{0x99, 0x99, 0x99},\n\t\t{0xAA, 0xAA, 0xAA},\n\t\t{0xFE, 0xFE, 0xFE},\n\t\t{0xB3, 0xB3, 0xB3},\n\t};\n\tu8 (*driving)[3], drive_sel;\n\n\tif (voltage == OUTPUT_3V3) {\n\t\tdriving = driving_3v3;\n\t\tdrive_sel = pcr->sd30_drive_sel_3v3;\n\t} else {\n\t\tdriving = driving_1v8;\n\t\tdrive_sel = pcr->sd30_drive_sel_1v8;\n\t}\n\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_CLK_DRIVE_SEL,\n\t\t\t0xFF, driving[drive_sel][0]);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_CMD_DRIVE_SEL,\n\t\t\t0xFF, driving[drive_sel][1]);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DAT_DRIVE_SEL,\n\t\t\t0xFF, driving[drive_sel][2]);\n}\n\nstatic void rts5227_fetch_vendor_settings(struct rtsx_pcr *pcr)\n{\n\tstruct pci_dev *pdev = pcr->pci;\n\tu32 reg;\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG1, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG1, reg);\n\n\tif (!rtsx_vendor_setting_valid(reg))\n\t\treturn;\n\n\tpcr->aspm_en = rtsx_reg_to_aspm(reg);\n\tpcr->sd30_drive_sel_1v8 = rtsx_reg_to_sd30_drive_sel_1v8(reg);\n\tpcr->card_drive_sel &= 0x3F;\n\tpcr->card_drive_sel |= rtsx_reg_to_card_drive_sel(reg);\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG2, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG2, reg);\n\tif (CHK_PCI_PID(pcr, 0x522A))\n\t\tpcr->rtd3_en = rtsx_reg_to_rtd3(reg);\n\tif (rtsx_check_mmc_support(reg))\n\t\tpcr->extra_caps |= EXTRA_CAPS_NO_MMC;\n\tpcr->sd30_drive_sel_3v3 = rtsx_reg_to_sd30_drive_sel_3v3(reg);\n\tif (rtsx_reg_check_reverse_socket(reg))\n\t\tpcr->flags |= PCR_REVERSE_SOCKET;\n}\n\nstatic void rts5227_init_from_cfg(struct rtsx_pcr *pcr)\n{\n\tstruct rtsx_cr_option *option = &pcr->option;\n\n\tif (CHK_PCI_PID(pcr, 0x522A)) {\n\t\tif (rtsx_check_dev_flag(pcr, ASPM_L1_1_EN | ASPM_L1_2_EN\n\t\t\t\t| PM_L1_1_EN | PM_L1_2_EN))\n\t\t\trtsx_pci_disable_oobs_polling(pcr);\n\t\telse\n\t\t\trtsx_pci_enable_oobs_polling(pcr);\n\t}\n\n\tif (option->ltr_en) {\n\t\tif (option->ltr_enabled)\n\t\t\trtsx_set_ltr_latency(pcr, option->ltr_active_latency);\n\t}\n}\n\nstatic int rts5227_extra_init_hw(struct rtsx_pcr *pcr)\n{\n\tu16 cap;\n\tstruct rtsx_cr_option *option = &pcr->option;\n\n\trts5227_init_from_cfg(pcr);\n\trtsx_pci_init_cmd(pcr);\n\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, GPIO_CTL, 0x02, 0x02);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, ASPM_FORCE_CTL, 0x3F, 0);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x00);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x01);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, OLT_LED_CTL, 0x0F, 0x02);\n\t \n\tpcie_capability_read_word(pcr->pci, PCI_EXP_DEVCTL2, &cap);\n\tif (cap & PCI_EXP_DEVCTL2_LTR_EN)\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LTR_CTL, 0xFF, 0xA3);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, OBFF_CFG, 0x03, 0x03);\n\t \n\trts5227_fill_driving(pcr, OUTPUT_3V3);\n\t \n\tif (pcr->flags & PCR_REVERSE_SOCKET)\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0x30, 0x30);\n\telse\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0x30, 0x00);\n\n\tif (CHK_PCI_PID(pcr, 0x522A))\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, RTS522A_AUTOLOAD_CFG1,\n\t\t\tCD_RESUME_EN_MASK, CD_RESUME_EN_MASK);\n\n\tif (pcr->rtd3_en) {\n\t\tif (CHK_PCI_PID(pcr, 0x522A)) {\n\t\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, RTS522A_PM_CTRL3, 0x01, 0x01);\n\t\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, RTS522A_PME_FORCE_CTL, 0x30, 0x30);\n\t\t} else {\n\t\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PM_CTRL3, 0x01, 0x01);\n\t\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PME_FORCE_CTL, 0xFF, 0x33);\n\t\t}\n\t} else {\n\t\tif (CHK_PCI_PID(pcr, 0x522A)) {\n\t\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, RTS522A_PM_CTRL3, 0x01, 0x00);\n\t\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, RTS522A_PME_FORCE_CTL, 0x30, 0x20);\n\t\t} else {\n\t\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PME_FORCE_CTL, 0xFF, 0x30);\n\t\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PM_CTRL3, 0x01, 0x00);\n\t\t}\n\t}\n\n\tif (option->force_clkreq_0)\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG,\n\t\t\t\tFORCE_CLKREQ_DELINK_MASK, FORCE_CLKREQ_LOW);\n\telse\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG,\n\t\t\t\tFORCE_CLKREQ_DELINK_MASK, FORCE_CLKREQ_HIGH);\n\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, pcr->reg_pm_ctrl3, 0x10, 0x00);\n\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rts5227_optimize_phy(struct rtsx_pcr *pcr)\n{\n\tint err;\n\n\terr = rtsx_pci_write_register(pcr, PM_CTRL3, D3_DELINK_MODE_EN, 0x00);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\treturn rtsx_pci_write_phy_register(pcr, 0x00, 0xBA42);\n}\n\nstatic int rts5227_turn_on_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x02);\n}\n\nstatic int rts5227_turn_off_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x00);\n}\n\nstatic int rts5227_enable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x08);\n}\n\nstatic int rts5227_disable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x00);\n}\n\nstatic int rts5227_card_power_on(struct rtsx_pcr *pcr, int card)\n{\n\tint err;\n\n\tif (pcr->option.ocp_en)\n\t\trtsx_pci_enable_ocp(pcr);\n\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\n\t\t\tSD_POWER_MASK, SD_PARTIAL_POWER_ON);\n\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\tLDO3318_PWR_MASK, 0x02);\n\n\terr = rtsx_pci_send_cmd(pcr, 100);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\tmsleep(20);\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\n\t\t\tSD_POWER_MASK, SD_POWER_ON);\n\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\tLDO3318_PWR_MASK, 0x06);\n\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_OE,\n\t\t\tSD_OUTPUT_EN, SD_OUTPUT_EN);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_OE,\n\t\t\tMS_OUTPUT_EN, MS_OUTPUT_EN);\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rts5227_card_power_off(struct rtsx_pcr *pcr, int card)\n{\n\tif (pcr->option.ocp_en)\n\t\trtsx_pci_disable_ocp(pcr);\n\n\trtsx_pci_write_register(pcr, CARD_PWR_CTL, SD_POWER_MASK |\n\t\t\tPMOS_STRG_MASK, SD_POWER_OFF | PMOS_STRG_400mA);\n\trtsx_pci_write_register(pcr, PWR_GATE_CTRL, LDO3318_PWR_MASK, 0X00);\n\n\treturn 0;\n}\n\nstatic int rts5227_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\n{\n\tint err;\n\n\tif (voltage == OUTPUT_3V3) {\n\t\terr = rtsx_pci_write_phy_register(pcr, 0x08, 0x4FC0 | 0x24);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t} else if (voltage == OUTPUT_1V8) {\n\t\terr = rtsx_pci_write_phy_register(pcr, 0x11, 0x3C02);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = rtsx_pci_write_phy_register(pcr, 0x08, 0x4C80 | 0x24);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\t \n\trtsx_pci_init_cmd(pcr);\n\trts5227_fill_driving(pcr, voltage);\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic const struct pcr_ops rts5227_pcr_ops = {\n\t.fetch_vendor_settings = rts5227_fetch_vendor_settings,\n\t.extra_init_hw = rts5227_extra_init_hw,\n\t.optimize_phy = rts5227_optimize_phy,\n\t.turn_on_led = rts5227_turn_on_led,\n\t.turn_off_led = rts5227_turn_off_led,\n\t.enable_auto_blink = rts5227_enable_auto_blink,\n\t.disable_auto_blink = rts5227_disable_auto_blink,\n\t.card_power_on = rts5227_card_power_on,\n\t.card_power_off = rts5227_card_power_off,\n\t.switch_output_voltage = rts5227_switch_output_voltage,\n\t.cd_deglitch = NULL,\n\t.conv_clk_and_div_n = NULL,\n};\n\n \nstatic const u32 rts5227_sd_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xE9),\n\t0,\n};\n\n \nstatic const u32 rts5227_sd_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xD5),\n\t0,\n};\n\n \nstatic const u32 rts5227_ms_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x15),\n\t0,\n};\n\n \nstatic const u32 rts5227_ms_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x15),\n\t0,\n};\n\nvoid rts5227_init_params(struct rtsx_pcr *pcr)\n{\n\tpcr->extra_caps = EXTRA_CAPS_SD_SDR50 | EXTRA_CAPS_SD_SDR104;\n\tpcr->num_slots = 2;\n\tpcr->ops = &rts5227_pcr_ops;\n\n\tpcr->flags = 0;\n\tpcr->card_drive_sel = RTSX_CARD_DRIVE_DEFAULT;\n\tpcr->sd30_drive_sel_1v8 = CFG_DRIVER_TYPE_B;\n\tpcr->sd30_drive_sel_3v3 = CFG_DRIVER_TYPE_B;\n\tpcr->aspm_en = ASPM_L1_EN;\n\tpcr->aspm_mode = ASPM_MODE_CFG;\n\tpcr->tx_initial_phase = SET_CLOCK_PHASE(27, 27, 15);\n\tpcr->rx_initial_phase = SET_CLOCK_PHASE(30, 7, 7);\n\n\tpcr->ic_version = rts5227_get_ic_version(pcr);\n\tpcr->sd_pull_ctl_enable_tbl = rts5227_sd_pull_ctl_enable_tbl;\n\tpcr->sd_pull_ctl_disable_tbl = rts5227_sd_pull_ctl_disable_tbl;\n\tpcr->ms_pull_ctl_enable_tbl = rts5227_ms_pull_ctl_enable_tbl;\n\tpcr->ms_pull_ctl_disable_tbl = rts5227_ms_pull_ctl_disable_tbl;\n\n\tpcr->reg_pm_ctrl3 = PM_CTRL3;\n}\n\nstatic int rts522a_optimize_phy(struct rtsx_pcr *pcr)\n{\n\tint err;\n\n\terr = rtsx_pci_write_register(pcr, RTS522A_PM_CTRL3, D3_DELINK_MODE_EN,\n\t\t0x00);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (is_version(pcr, 0x522A, IC_VER_A)) {\n\t\terr = rtsx_pci_write_phy_register(pcr, PHY_RCR2,\n\t\t\tPHY_RCR2_INIT_27S);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\trtsx_pci_write_phy_register(pcr, PHY_RCR1, PHY_RCR1_INIT_27S);\n\t\trtsx_pci_write_phy_register(pcr, PHY_FLD0, PHY_FLD0_INIT_27S);\n\t\trtsx_pci_write_phy_register(pcr, PHY_FLD3, PHY_FLD3_INIT_27S);\n\t\trtsx_pci_write_phy_register(pcr, PHY_FLD4, PHY_FLD4_INIT_27S);\n\t}\n\n\treturn 0;\n}\n\nstatic int rts522a_extra_init_hw(struct rtsx_pcr *pcr)\n{\n\trts5227_extra_init_hw(pcr);\n\n\t \n\tif (!pcr->card_exist)\n\t\trtsx_pci_write_register(pcr, FPDCTL, OC_POWER_DOWN,\n\t\t\t\tOC_POWER_DOWN);\n\n\trtsx_pci_write_register(pcr, FUNC_FORCE_CTL, FUNC_FORCE_UPME_XMT_DBG,\n\t\tFUNC_FORCE_UPME_XMT_DBG);\n\trtsx_pci_write_register(pcr, PCLK_CTL, 0x04, 0x04);\n\trtsx_pci_write_register(pcr, PM_EVENT_DEBUG, PME_DEBUG_0, PME_DEBUG_0);\n\trtsx_pci_write_register(pcr, PM_CLK_FORCE_CTL, 0xFF, 0x11);\n\n\treturn 0;\n}\n\nstatic int rts522a_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\n{\n\tint err;\n\n\tif (voltage == OUTPUT_3V3) {\n\t\terr = rtsx_pci_write_phy_register(pcr, 0x08, 0x57E4);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t} else if (voltage == OUTPUT_1V8) {\n\t\terr = rtsx_pci_write_phy_register(pcr, 0x11, 0x3C02);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = rtsx_pci_write_phy_register(pcr, 0x08, 0x54A4);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\t \n\trtsx_pci_init_cmd(pcr);\n\trts5227_fill_driving(pcr, voltage);\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic void rts522a_force_power_down(struct rtsx_pcr *pcr, u8 pm_state, bool runtime)\n{\n\t \n\trtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 1, MASK_8_BIT_DEF, 0);\n\trtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 2, MASK_8_BIT_DEF, 0);\n\trtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 3,\n\t\t\t\tRELINK_TIME_MASK, 0);\n\n\trtsx_pci_write_register(pcr, RTS522A_PM_CTRL3,\n\t\t\tD3_DELINK_MODE_EN, D3_DELINK_MODE_EN);\n\n\tif (!runtime) {\n\t\trtsx_pci_write_register(pcr, RTS522A_AUTOLOAD_CFG1,\n\t\t\t\tCD_RESUME_EN_MASK, 0);\n\t\trtsx_pci_write_register(pcr, RTS522A_PM_CTRL3, 0x01, 0x00);\n\t\trtsx_pci_write_register(pcr, RTS522A_PME_FORCE_CTL, 0x30, 0x20);\n\t}\n\n\trtsx_pci_write_register(pcr, FPDCTL, ALL_POWER_DOWN, ALL_POWER_DOWN);\n}\n\n\nstatic void rts522a_set_l1off_cfg_sub_d0(struct rtsx_pcr *pcr, int active)\n{\n\tstruct rtsx_cr_option *option = &pcr->option;\n\tint aspm_L1_1, aspm_L1_2;\n\tu8 val = 0;\n\n\taspm_L1_1 = rtsx_check_dev_flag(pcr, ASPM_L1_1_EN);\n\taspm_L1_2 = rtsx_check_dev_flag(pcr, ASPM_L1_2_EN);\n\n\tif (active) {\n\t\t \n\t\tif (aspm_L1_1)\n\t\t\tval = option->ltr_l1off_snooze_sspwrgate;\n\t} else {\n\t\t \n\t\tif (aspm_L1_2)\n\t\t\tval = option->ltr_l1off_sspwrgate;\n\t}\n\n\trtsx_set_l1off_sub(pcr, val);\n}\n\n \nstatic const struct pcr_ops rts522a_pcr_ops = {\n\t.fetch_vendor_settings = rts5227_fetch_vendor_settings,\n\t.extra_init_hw = rts522a_extra_init_hw,\n\t.optimize_phy = rts522a_optimize_phy,\n\t.turn_on_led = rts5227_turn_on_led,\n\t.turn_off_led = rts5227_turn_off_led,\n\t.enable_auto_blink = rts5227_enable_auto_blink,\n\t.disable_auto_blink = rts5227_disable_auto_blink,\n\t.card_power_on = rts5227_card_power_on,\n\t.card_power_off = rts5227_card_power_off,\n\t.switch_output_voltage = rts522a_switch_output_voltage,\n\t.force_power_down = rts522a_force_power_down,\n\t.cd_deglitch = NULL,\n\t.conv_clk_and_div_n = NULL,\n\t.set_l1off_cfg_sub_d0 = rts522a_set_l1off_cfg_sub_d0,\n};\n\nvoid rts522a_init_params(struct rtsx_pcr *pcr)\n{\n\tstruct rtsx_cr_option *option = &pcr->option;\n\n\trts5227_init_params(pcr);\n\tpcr->ops = &rts522a_pcr_ops;\n\tpcr->aspm_mode = ASPM_MODE_REG;\n\tpcr->tx_initial_phase = SET_CLOCK_PHASE(20, 20, 11);\n\tpcr->reg_pm_ctrl3 = RTS522A_PM_CTRL3;\n\n\toption->dev_flags = LTR_L1SS_PWR_GATE_EN;\n\toption->ltr_en = true;\n\n\t \n\toption->ltr_active_latency = LTR_ACTIVE_LATENCY_DEF;\n\toption->ltr_idle_latency = LTR_IDLE_LATENCY_DEF;\n\toption->ltr_l1off_latency = LTR_L1OFF_LATENCY_DEF;\n\toption->l1_snooze_delay = L1_SNOOZE_DELAY_DEF;\n\toption->ltr_l1off_sspwrgate = 0x7F;\n\toption->ltr_l1off_snooze_sspwrgate = 0x78;\n\n\tpcr->option.ocp_en = 1;\n\tif (pcr->option.ocp_en)\n\t\tpcr->hw_param.interrupt_en |= SD_OC_INT_EN;\n\tpcr->hw_param.ocp_glitch = SD_OCP_GLITCH_10M;\n\tpcr->option.sd_800mA_ocp_thd = RTS522A_OCP_THD_800;\n\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}