{
  "module_name": "rts5249.c",
  "hash_id": "41021b52b34a039b8c2baefdfdb986c47eca531ceacd2b70d5f87207b1976265",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/cardreader/rts5249.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/rtsx_pci.h>\n\n#include \"rtsx_pcr.h\"\n\nstatic u8 rts5249_get_ic_version(struct rtsx_pcr *pcr)\n{\n\tu8 val;\n\n\trtsx_pci_read_register(pcr, DUMMY_REG_RESET_0, &val);\n\treturn val & 0x0F;\n}\n\nstatic void rts5249_fill_driving(struct rtsx_pcr *pcr, u8 voltage)\n{\n\tu8 driving_3v3[4][3] = {\n\t\t{0x11, 0x11, 0x18},\n\t\t{0x55, 0x55, 0x5C},\n\t\t{0xFF, 0xFF, 0xFF},\n\t\t{0x96, 0x96, 0x96},\n\t};\n\tu8 driving_1v8[4][3] = {\n\t\t{0xC4, 0xC4, 0xC4},\n\t\t{0x3C, 0x3C, 0x3C},\n\t\t{0xFE, 0xFE, 0xFE},\n\t\t{0xB3, 0xB3, 0xB3},\n\t};\n\tu8 (*driving)[3], drive_sel;\n\n\tif (voltage == OUTPUT_3V3) {\n\t\tdriving = driving_3v3;\n\t\tdrive_sel = pcr->sd30_drive_sel_3v3;\n\t} else {\n\t\tdriving = driving_1v8;\n\t\tdrive_sel = pcr->sd30_drive_sel_1v8;\n\t}\n\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_CLK_DRIVE_SEL,\n\t\t\t0xFF, driving[drive_sel][0]);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_CMD_DRIVE_SEL,\n\t\t\t0xFF, driving[drive_sel][1]);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DAT_DRIVE_SEL,\n\t\t\t0xFF, driving[drive_sel][2]);\n}\n\nstatic void rtsx_base_fetch_vendor_settings(struct rtsx_pcr *pcr)\n{\n\tstruct pci_dev *pdev = pcr->pci;\n\tu32 reg;\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG1, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG1, reg);\n\n\tif (!rtsx_vendor_setting_valid(reg)) {\n\t\tpcr_dbg(pcr, \"skip fetch vendor setting\\n\");\n\t\treturn;\n\t}\n\n\tpcr->aspm_en = rtsx_reg_to_aspm(reg);\n\tpcr->sd30_drive_sel_1v8 = rtsx_reg_to_sd30_drive_sel_1v8(reg);\n\tpcr->card_drive_sel &= 0x3F;\n\tpcr->card_drive_sel |= rtsx_reg_to_card_drive_sel(reg);\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG2, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG2, reg);\n\n\tif (CHK_PCI_PID(pcr, PID_524A) || CHK_PCI_PID(pcr, PID_525A))\n\t\tpcr->rtd3_en = rtsx_reg_to_rtd3_uhsii(reg);\n\n\tif (rtsx_check_mmc_support(reg))\n\t\tpcr->extra_caps |= EXTRA_CAPS_NO_MMC;\n\tpcr->sd30_drive_sel_3v3 = rtsx_reg_to_sd30_drive_sel_3v3(reg);\n\tif (rtsx_reg_check_reverse_socket(reg))\n\t\tpcr->flags |= PCR_REVERSE_SOCKET;\n}\n\nstatic void rts5249_init_from_cfg(struct rtsx_pcr *pcr)\n{\n\tstruct rtsx_cr_option *option = &(pcr->option);\n\n\tif (CHK_PCI_PID(pcr, PID_524A) || CHK_PCI_PID(pcr, PID_525A)) {\n\t\tif (rtsx_check_dev_flag(pcr, ASPM_L1_1_EN | ASPM_L1_2_EN\n\t\t\t\t| PM_L1_1_EN | PM_L1_2_EN))\n\t\t\trtsx_pci_disable_oobs_polling(pcr);\n\t\telse\n\t\t\trtsx_pci_enable_oobs_polling(pcr);\n\t}\n\n\tif (option->ltr_en) {\n\t\tif (option->ltr_enabled)\n\t\t\trtsx_set_ltr_latency(pcr, option->ltr_active_latency);\n\t}\n}\n\nstatic void rts52xa_force_power_down(struct rtsx_pcr *pcr, u8 pm_state, bool runtime)\n{\n\t \n\trtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 1, MASK_8_BIT_DEF, 0);\n\trtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 2, MASK_8_BIT_DEF, 0);\n\trtsx_pci_write_register(pcr, AUTOLOAD_CFG_BASE + 3,\n\t\t\t\tRELINK_TIME_MASK, 0);\n\n\trtsx_pci_write_register(pcr, RTS524A_PM_CTRL3,\n\t\t\tD3_DELINK_MODE_EN, D3_DELINK_MODE_EN);\n\n\tif (!runtime) {\n\t\trtsx_pci_write_register(pcr, RTS524A_AUTOLOAD_CFG1,\n\t\t\t\tCD_RESUME_EN_MASK, 0);\n\t\trtsx_pci_write_register(pcr, RTS524A_PM_CTRL3, 0x01, 0x00);\n\t\trtsx_pci_write_register(pcr, RTS524A_PME_FORCE_CTL, 0x30, 0x20);\n\t}\n\n\trtsx_pci_write_register(pcr, FPDCTL, ALL_POWER_DOWN, ALL_POWER_DOWN);\n}\n\nstatic void rts52xa_save_content_from_efuse(struct rtsx_pcr *pcr)\n{\n\tu8 cnt, sv;\n\tu16 j = 0;\n\tu8 tmp;\n\tu8 val;\n\tint i;\n\n\trtsx_pci_write_register(pcr, RTS524A_PME_FORCE_CTL,\n\t\t\t\tREG_EFUSE_BYPASS | REG_EFUSE_POR, REG_EFUSE_POR);\n\tudelay(1);\n\n\tpcr_dbg(pcr, \"Enable efuse por!\");\n\tpcr_dbg(pcr, \"save efuse to autoload\");\n\n\trtsx_pci_write_register(pcr, RTS525A_EFUSE_ADD, REG_EFUSE_ADD_MASK, 0x00);\n\trtsx_pci_write_register(pcr, RTS525A_EFUSE_CTL,\n\t\t\t\tREG_EFUSE_ENABLE | REG_EFUSE_MODE, REG_EFUSE_ENABLE);\n\t \n\tfor (j = 0; j < 1024; j++) {\n\t\trtsx_pci_read_register(pcr, RTS525A_EFUSE_CTL, &tmp);\n\t\tif ((tmp & 0x80) == 0)\n\t\t\tbreak;\n\t}\n\trtsx_pci_read_register(pcr, RTS525A_EFUSE_DATA, &val);\n\tcnt = val & 0x0F;\n\tsv = val & 0x10;\n\n\tif (sv) {\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\trtsx_pci_write_register(pcr, RTS525A_EFUSE_ADD,\n\t\t\t\tREG_EFUSE_ADD_MASK, 0x04 + i);\n\t\t\trtsx_pci_write_register(pcr, RTS525A_EFUSE_CTL,\n\t\t\t\tREG_EFUSE_ENABLE | REG_EFUSE_MODE, REG_EFUSE_ENABLE);\n\t\t\t \n\t\t\tfor (j = 0; j < 1024; j++) {\n\t\t\t\trtsx_pci_read_register(pcr, RTS525A_EFUSE_CTL, &tmp);\n\t\t\t\tif ((tmp & 0x80) == 0)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\trtsx_pci_read_register(pcr, RTS525A_EFUSE_DATA, &val);\n\t\t\trtsx_pci_write_register(pcr, 0xFF04 + i, 0xFF, val);\n\t\t}\n\t} else {\n\t\trtsx_pci_write_register(pcr, 0xFF04, 0xFF, (u8)PCI_VID(pcr));\n\t\trtsx_pci_write_register(pcr, 0xFF05, 0xFF, (u8)(PCI_VID(pcr) >> 8));\n\t\trtsx_pci_write_register(pcr, 0xFF06, 0xFF, (u8)PCI_PID(pcr));\n\t\trtsx_pci_write_register(pcr, 0xFF07, 0xFF, (u8)(PCI_PID(pcr) >> 8));\n\t}\n\n\tfor (i = 0; i < cnt * 4; i++) {\n\t\tif (sv)\n\t\t\trtsx_pci_write_register(pcr, RTS525A_EFUSE_ADD,\n\t\t\t\tREG_EFUSE_ADD_MASK, 0x08 + i);\n\t\telse\n\t\t\trtsx_pci_write_register(pcr, RTS525A_EFUSE_ADD,\n\t\t\t\tREG_EFUSE_ADD_MASK, 0x04 + i);\n\t\trtsx_pci_write_register(pcr, RTS525A_EFUSE_CTL,\n\t\t\t\tREG_EFUSE_ENABLE | REG_EFUSE_MODE, REG_EFUSE_ENABLE);\n\t\t \n\t\tfor (j = 0; j < 1024; j++) {\n\t\t\trtsx_pci_read_register(pcr, RTS525A_EFUSE_CTL, &tmp);\n\t\t\tif ((tmp & 0x80) == 0)\n\t\t\t\tbreak;\n\t\t}\n\t\trtsx_pci_read_register(pcr, RTS525A_EFUSE_DATA, &val);\n\t\trtsx_pci_write_register(pcr, 0xFF08 + i, 0xFF, val);\n\t}\n\trtsx_pci_write_register(pcr, 0xFF00, 0xFF, (cnt & 0x7F) | 0x80);\n\trtsx_pci_write_register(pcr, RTS524A_PME_FORCE_CTL,\n\t\tREG_EFUSE_BYPASS | REG_EFUSE_POR, REG_EFUSE_BYPASS);\n\tpcr_dbg(pcr, \"Disable efuse por!\");\n}\n\nstatic void rts52xa_save_content_to_autoload_space(struct rtsx_pcr *pcr)\n{\n\tu8 val;\n\n\trtsx_pci_read_register(pcr, RESET_LOAD_REG, &val);\n\tif (val & 0x02) {\n\t\trtsx_pci_read_register(pcr, RTS525A_BIOS_CFG, &val);\n\t\tif (val & RTS525A_LOAD_BIOS_FLAG) {\n\t\t\trtsx_pci_write_register(pcr, RTS525A_BIOS_CFG,\n\t\t\t\tRTS525A_LOAD_BIOS_FLAG, RTS525A_CLEAR_BIOS_FLAG);\n\n\t\t\trtsx_pci_write_register(pcr, RTS524A_PME_FORCE_CTL,\n\t\t\t\tREG_EFUSE_POWER_MASK, REG_EFUSE_POWERON);\n\n\t\t\tpcr_dbg(pcr, \"Power ON efuse!\");\n\t\t\tmdelay(1);\n\t\t\trts52xa_save_content_from_efuse(pcr);\n\t\t} else {\n\t\t\trtsx_pci_read_register(pcr, RTS524A_PME_FORCE_CTL, &val);\n\t\t\tif (!(val & 0x08))\n\t\t\t\trts52xa_save_content_from_efuse(pcr);\n\t\t}\n\t} else {\n\t\tpcr_dbg(pcr, \"Load from autoload\");\n\t\trtsx_pci_write_register(pcr, 0xFF00, 0xFF, 0x80);\n\t\trtsx_pci_write_register(pcr, 0xFF04, 0xFF, (u8)PCI_VID(pcr));\n\t\trtsx_pci_write_register(pcr, 0xFF05, 0xFF, (u8)(PCI_VID(pcr) >> 8));\n\t\trtsx_pci_write_register(pcr, 0xFF06, 0xFF, (u8)PCI_PID(pcr));\n\t\trtsx_pci_write_register(pcr, 0xFF07, 0xFF, (u8)(PCI_PID(pcr) >> 8));\n\t}\n}\n\nstatic int rts5249_extra_init_hw(struct rtsx_pcr *pcr)\n{\n\tstruct rtsx_cr_option *option = &(pcr->option);\n\n\trts5249_init_from_cfg(pcr);\n\n\trtsx_pci_init_cmd(pcr);\n\n\tif (CHK_PCI_PID(pcr, PID_524A) || CHK_PCI_PID(pcr, PID_525A))\n\t\trts52xa_save_content_to_autoload_space(pcr);\n\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, L1SUB_CONFIG3, 0xFF, 0x00);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, GPIO_CTL, 0x02, 0x02);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, ASPM_FORCE_CTL, 0x3F, 0);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x00);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x01);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, OLT_LED_CTL, 0x0F, 0x02);\n\t \n\trts5249_fill_driving(pcr, OUTPUT_3V3);\n\tif (pcr->flags & PCR_REVERSE_SOCKET)\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0xB0, 0xB0);\n\telse\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0xB0, 0x80);\n\n\trtsx_pci_send_cmd(pcr, CMD_TIMEOUT_DEF);\n\n\tif (CHK_PCI_PID(pcr, PID_524A) || CHK_PCI_PID(pcr, PID_525A)) {\n\t\trtsx_pci_write_register(pcr, REG_VREF, PWD_SUSPND_EN, PWD_SUSPND_EN);\n\t\trtsx_pci_write_register(pcr, RTS524A_AUTOLOAD_CFG1,\n\t\t\tCD_RESUME_EN_MASK, CD_RESUME_EN_MASK);\n\t}\n\n\tif (pcr->rtd3_en) {\n\t\tif (CHK_PCI_PID(pcr, PID_524A) || CHK_PCI_PID(pcr, PID_525A)) {\n\t\t\trtsx_pci_write_register(pcr, RTS524A_PM_CTRL3, 0x01, 0x01);\n\t\t\trtsx_pci_write_register(pcr, RTS524A_PME_FORCE_CTL, 0x30, 0x30);\n\t\t} else {\n\t\t\trtsx_pci_write_register(pcr, PM_CTRL3, 0x01, 0x01);\n\t\t\trtsx_pci_write_register(pcr, PME_FORCE_CTL, 0xFF, 0x33);\n\t\t}\n\t} else {\n\t\tif (CHK_PCI_PID(pcr, PID_524A) || CHK_PCI_PID(pcr, PID_525A)) {\n\t\t\trtsx_pci_write_register(pcr, RTS524A_PM_CTRL3, 0x01, 0x00);\n\t\t\trtsx_pci_write_register(pcr, RTS524A_PME_FORCE_CTL, 0x30, 0x20);\n\t\t} else {\n\t\t\trtsx_pci_write_register(pcr, PME_FORCE_CTL, 0xFF, 0x30);\n\t\t\trtsx_pci_write_register(pcr, PM_CTRL3, 0x01, 0x00);\n\t\t}\n\t}\n\n\n\t \n\tif (option->force_clkreq_0)\n\t\trtsx_pci_write_register(pcr, PETXCFG,\n\t\t\tFORCE_CLKREQ_DELINK_MASK, FORCE_CLKREQ_LOW);\n\telse\n\t\trtsx_pci_write_register(pcr, PETXCFG,\n\t\t\tFORCE_CLKREQ_DELINK_MASK, FORCE_CLKREQ_HIGH);\n\n\trtsx_pci_write_register(pcr, pcr->reg_pm_ctrl3, 0x10, 0x00);\n\tif (CHK_PCI_PID(pcr, PID_524A) || CHK_PCI_PID(pcr, PID_525A)) {\n\t\trtsx_pci_write_register(pcr, RTS524A_PME_FORCE_CTL,\n\t\t\t\tREG_EFUSE_POWER_MASK, REG_EFUSE_POWEROFF);\n\t\tpcr_dbg(pcr, \"Power OFF efuse!\");\n\t}\n\n\treturn 0;\n}\n\nstatic int rts5249_optimize_phy(struct rtsx_pcr *pcr)\n{\n\tint err;\n\n\terr = rtsx_pci_write_register(pcr, PM_CTRL3, D3_DELINK_MODE_EN, 0x00);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = rtsx_pci_write_phy_register(pcr, PHY_REV,\n\t\t\tPHY_REV_RESV | PHY_REV_RXIDLE_LATCHED |\n\t\t\tPHY_REV_P1_EN | PHY_REV_RXIDLE_EN |\n\t\t\tPHY_REV_CLKREQ_TX_EN | PHY_REV_RX_PWST |\n\t\t\tPHY_REV_CLKREQ_DT_1_0 | PHY_REV_STOP_CLKRD |\n\t\t\tPHY_REV_STOP_CLKWR);\n\tif (err < 0)\n\t\treturn err;\n\n\tmsleep(1);\n\n\terr = rtsx_pci_write_phy_register(pcr, PHY_BPCR,\n\t\t\tPHY_BPCR_IBRXSEL | PHY_BPCR_IBTXSEL |\n\t\t\tPHY_BPCR_IB_FILTER | PHY_BPCR_CMIRROR_EN);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = rtsx_pci_write_phy_register(pcr, PHY_PCR,\n\t\t\tPHY_PCR_FORCE_CODE | PHY_PCR_OOBS_CALI_50 |\n\t\t\tPHY_PCR_OOBS_VCM_08 | PHY_PCR_OOBS_SEN_90 |\n\t\t\tPHY_PCR_RSSI_EN | PHY_PCR_RX10K);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = rtsx_pci_write_phy_register(pcr, PHY_RCR2,\n\t\t\tPHY_RCR2_EMPHASE_EN | PHY_RCR2_NADJR |\n\t\t\tPHY_RCR2_CDR_SR_2 | PHY_RCR2_FREQSEL_12 |\n\t\t\tPHY_RCR2_CDR_SC_12P | PHY_RCR2_CALIB_LATE);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = rtsx_pci_write_phy_register(pcr, PHY_FLD4,\n\t\t\tPHY_FLD4_FLDEN_SEL | PHY_FLD4_REQ_REF |\n\t\t\tPHY_FLD4_RXAMP_OFF | PHY_FLD4_REQ_ADDA |\n\t\t\tPHY_FLD4_BER_COUNT | PHY_FLD4_BER_TIMER |\n\t\t\tPHY_FLD4_BER_CHK_EN);\n\tif (err < 0)\n\t\treturn err;\n\terr = rtsx_pci_write_phy_register(pcr, PHY_RDR,\n\t\t\tPHY_RDR_RXDSEL_1_9 | PHY_SSC_AUTO_PWD);\n\tif (err < 0)\n\t\treturn err;\n\terr = rtsx_pci_write_phy_register(pcr, PHY_RCR1,\n\t\t\tPHY_RCR1_ADP_TIME_4 | PHY_RCR1_VCO_COARSE);\n\tif (err < 0)\n\t\treturn err;\n\terr = rtsx_pci_write_phy_register(pcr, PHY_FLD3,\n\t\t\tPHY_FLD3_TIMER_4 | PHY_FLD3_TIMER_6 |\n\t\t\tPHY_FLD3_RXDELINK);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn rtsx_pci_write_phy_register(pcr, PHY_TUNE,\n\t\t\tPHY_TUNE_TUNEREF_1_0 | PHY_TUNE_VBGSEL_1252 |\n\t\t\tPHY_TUNE_SDBUS_33 | PHY_TUNE_TUNED18 |\n\t\t\tPHY_TUNE_TUNED12 | PHY_TUNE_TUNEA12);\n}\n\nstatic int rtsx_base_turn_on_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x02);\n}\n\nstatic int rtsx_base_turn_off_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x00);\n}\n\nstatic int rtsx_base_enable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x08);\n}\n\nstatic int rtsx_base_disable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x00);\n}\n\nstatic int rtsx_base_card_power_on(struct rtsx_pcr *pcr, int card)\n{\n\tint err;\n\tstruct rtsx_cr_option *option = &pcr->option;\n\n\tif (option->ocp_en)\n\t\trtsx_pci_enable_ocp(pcr);\n\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\n\t\t\tSD_POWER_MASK, SD_VCC_PARTIAL_POWER_ON);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\tLDO3318_PWR_MASK, 0x02);\n\terr = rtsx_pci_send_cmd(pcr, 100);\n\tif (err < 0)\n\t\treturn err;\n\n\tmsleep(5);\n\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\n\t\t\tSD_POWER_MASK, SD_VCC_POWER_ON);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\tLDO3318_PWR_MASK, 0x06);\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rtsx_base_card_power_off(struct rtsx_pcr *pcr, int card)\n{\n\tstruct rtsx_cr_option *option = &pcr->option;\n\n\tif (option->ocp_en)\n\t\trtsx_pci_disable_ocp(pcr);\n\n\trtsx_pci_write_register(pcr, CARD_PWR_CTL, SD_POWER_MASK, SD_POWER_OFF);\n\n\trtsx_pci_write_register(pcr, PWR_GATE_CTRL, LDO3318_PWR_MASK, 0x00);\n\treturn 0;\n}\n\nstatic int rtsx_base_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\n{\n\tint err;\n\tu16 append;\n\n\tswitch (voltage) {\n\tcase OUTPUT_3V3:\n\t\terr = rtsx_pci_update_phy(pcr, PHY_TUNE, PHY_TUNE_VOLTAGE_MASK,\n\t\t\tPHY_TUNE_VOLTAGE_3V3);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\tcase OUTPUT_1V8:\n\t\tappend = PHY_TUNE_D18_1V8;\n\t\tif (CHK_PCI_PID(pcr, 0x5249)) {\n\t\t\terr = rtsx_pci_update_phy(pcr, PHY_BACR,\n\t\t\t\tPHY_BACR_BASIC_MASK, 0);\n\t\t\tif (err < 0)\n\t\t\t\treturn err;\n\t\t\tappend = PHY_TUNE_D18_1V7;\n\t\t}\n\n\t\terr = rtsx_pci_update_phy(pcr, PHY_TUNE, PHY_TUNE_VOLTAGE_MASK,\n\t\t\tappend);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tbreak;\n\tdefault:\n\t\tpcr_dbg(pcr, \"unknown output voltage %d\\n\", voltage);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\trtsx_pci_init_cmd(pcr);\n\trts5249_fill_driving(pcr, voltage);\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic const struct pcr_ops rts5249_pcr_ops = {\n\t.fetch_vendor_settings = rtsx_base_fetch_vendor_settings,\n\t.extra_init_hw = rts5249_extra_init_hw,\n\t.optimize_phy = rts5249_optimize_phy,\n\t.turn_on_led = rtsx_base_turn_on_led,\n\t.turn_off_led = rtsx_base_turn_off_led,\n\t.enable_auto_blink = rtsx_base_enable_auto_blink,\n\t.disable_auto_blink = rtsx_base_disable_auto_blink,\n\t.card_power_on = rtsx_base_card_power_on,\n\t.card_power_off = rtsx_base_card_power_off,\n\t.switch_output_voltage = rtsx_base_switch_output_voltage,\n};\n\n \nstatic const u32 rts5249_sd_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x66),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xE9),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0xAA),\n\t0,\n};\n\n \nstatic const u32 rts5249_sd_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x66),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xD5),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x55),\n\t0,\n};\n\n \nstatic const u32 rts5249_ms_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x15),\n\t0,\n};\n\n \nstatic const u32 rts5249_ms_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x15),\n\t0,\n};\n\nvoid rts5249_init_params(struct rtsx_pcr *pcr)\n{\n\tstruct rtsx_cr_option *option = &(pcr->option);\n\n\tpcr->extra_caps = EXTRA_CAPS_SD_SDR50 | EXTRA_CAPS_SD_SDR104;\n\tpcr->num_slots = 2;\n\tpcr->ops = &rts5249_pcr_ops;\n\n\tpcr->flags = 0;\n\tpcr->card_drive_sel = RTSX_CARD_DRIVE_DEFAULT;\n\tpcr->sd30_drive_sel_1v8 = CFG_DRIVER_TYPE_B;\n\tpcr->sd30_drive_sel_3v3 = CFG_DRIVER_TYPE_B;\n\tpcr->aspm_en = ASPM_L1_EN;\n\tpcr->aspm_mode = ASPM_MODE_CFG;\n\tpcr->tx_initial_phase = SET_CLOCK_PHASE(1, 29, 16);\n\tpcr->rx_initial_phase = SET_CLOCK_PHASE(24, 6, 5);\n\n\tpcr->ic_version = rts5249_get_ic_version(pcr);\n\tpcr->sd_pull_ctl_enable_tbl = rts5249_sd_pull_ctl_enable_tbl;\n\tpcr->sd_pull_ctl_disable_tbl = rts5249_sd_pull_ctl_disable_tbl;\n\tpcr->ms_pull_ctl_enable_tbl = rts5249_ms_pull_ctl_enable_tbl;\n\tpcr->ms_pull_ctl_disable_tbl = rts5249_ms_pull_ctl_disable_tbl;\n\n\tpcr->reg_pm_ctrl3 = PM_CTRL3;\n\n\toption->dev_flags = (LTR_L1SS_PWR_GATE_CHECK_CARD_EN\n\t\t\t\t| LTR_L1SS_PWR_GATE_EN);\n\toption->ltr_en = true;\n\n\t \n\toption->ltr_active_latency = LTR_ACTIVE_LATENCY_DEF;\n\toption->ltr_idle_latency = LTR_IDLE_LATENCY_DEF;\n\toption->ltr_l1off_latency = LTR_L1OFF_LATENCY_DEF;\n\toption->l1_snooze_delay = L1_SNOOZE_DELAY_DEF;\n\toption->ltr_l1off_sspwrgate = LTR_L1OFF_SSPWRGATE_5249_DEF;\n\toption->ltr_l1off_snooze_sspwrgate =\n\t\tLTR_L1OFF_SNOOZE_SSPWRGATE_5249_DEF;\n}\n\nstatic int rts524a_write_phy(struct rtsx_pcr *pcr, u8 addr, u16 val)\n{\n\taddr = addr & 0x80 ? (addr & 0x7F) | 0x40 : addr;\n\n\treturn __rtsx_pci_write_phy_register(pcr, addr, val);\n}\n\nstatic int rts524a_read_phy(struct rtsx_pcr *pcr, u8 addr, u16 *val)\n{\n\taddr = addr & 0x80 ? (addr & 0x7F) | 0x40 : addr;\n\n\treturn __rtsx_pci_read_phy_register(pcr, addr, val);\n}\n\nstatic int rts524a_optimize_phy(struct rtsx_pcr *pcr)\n{\n\tint err;\n\n\terr = rtsx_pci_write_register(pcr, RTS524A_PM_CTRL3,\n\t\tD3_DELINK_MODE_EN, 0x00);\n\tif (err < 0)\n\t\treturn err;\n\n\trtsx_pci_write_phy_register(pcr, PHY_PCR,\n\t\tPHY_PCR_FORCE_CODE | PHY_PCR_OOBS_CALI_50 |\n\t\tPHY_PCR_OOBS_VCM_08 | PHY_PCR_OOBS_SEN_90 | PHY_PCR_RSSI_EN);\n\trtsx_pci_write_phy_register(pcr, PHY_SSCCR3,\n\t\tPHY_SSCCR3_STEP_IN | PHY_SSCCR3_CHECK_DELAY);\n\n\tif (is_version(pcr, 0x524A, IC_VER_A)) {\n\t\trtsx_pci_write_phy_register(pcr, PHY_SSCCR3,\n\t\t\tPHY_SSCCR3_STEP_IN | PHY_SSCCR3_CHECK_DELAY);\n\t\trtsx_pci_write_phy_register(pcr, PHY_SSCCR2,\n\t\t\tPHY_SSCCR2_PLL_NCODE | PHY_SSCCR2_TIME0 |\n\t\t\tPHY_SSCCR2_TIME2_WIDTH);\n\t\trtsx_pci_write_phy_register(pcr, PHY_ANA1A,\n\t\t\tPHY_ANA1A_TXR_LOOPBACK | PHY_ANA1A_RXT_BIST |\n\t\t\tPHY_ANA1A_TXR_BIST | PHY_ANA1A_REV);\n\t\trtsx_pci_write_phy_register(pcr, PHY_ANA1D,\n\t\t\tPHY_ANA1D_DEBUG_ADDR);\n\t\trtsx_pci_write_phy_register(pcr, PHY_DIG1E,\n\t\t\tPHY_DIG1E_REV | PHY_DIG1E_D0_X_D1 |\n\t\t\tPHY_DIG1E_RX_ON_HOST | PHY_DIG1E_RCLK_REF_HOST |\n\t\t\tPHY_DIG1E_RCLK_TX_EN_KEEP |\n\t\t\tPHY_DIG1E_RCLK_TX_TERM_KEEP |\n\t\t\tPHY_DIG1E_RCLK_RX_EIDLE_ON | PHY_DIG1E_TX_TERM_KEEP |\n\t\t\tPHY_DIG1E_RX_TERM_KEEP | PHY_DIG1E_TX_EN_KEEP |\n\t\t\tPHY_DIG1E_RX_EN_KEEP);\n\t}\n\n\trtsx_pci_write_phy_register(pcr, PHY_ANA08,\n\t\tPHY_ANA08_RX_EQ_DCGAIN | PHY_ANA08_SEL_RX_EN |\n\t\tPHY_ANA08_RX_EQ_VAL | PHY_ANA08_SCP | PHY_ANA08_SEL_IPI);\n\n\treturn 0;\n}\n\nstatic int rts524a_extra_init_hw(struct rtsx_pcr *pcr)\n{\n\trts5249_extra_init_hw(pcr);\n\n\trtsx_pci_write_register(pcr, FUNC_FORCE_CTL,\n\t\tFORCE_ASPM_L1_EN, FORCE_ASPM_L1_EN);\n\trtsx_pci_write_register(pcr, PM_EVENT_DEBUG, PME_DEBUG_0, PME_DEBUG_0);\n\trtsx_pci_write_register(pcr, LDO_VCC_CFG1, LDO_VCC_LMT_EN,\n\t\tLDO_VCC_LMT_EN);\n\trtsx_pci_write_register(pcr, PCLK_CTL, PCLK_MODE_SEL, PCLK_MODE_SEL);\n\tif (is_version(pcr, 0x524A, IC_VER_A)) {\n\t\trtsx_pci_write_register(pcr, LDO_DV18_CFG,\n\t\t\tLDO_DV18_SR_MASK, LDO_DV18_SR_DF);\n\t\trtsx_pci_write_register(pcr, LDO_VCC_CFG1,\n\t\t\tLDO_VCC_REF_TUNE_MASK, LDO_VCC_REF_1V2);\n\t\trtsx_pci_write_register(pcr, LDO_VIO_CFG,\n\t\t\tLDO_VIO_REF_TUNE_MASK, LDO_VIO_REF_1V2);\n\t\trtsx_pci_write_register(pcr, LDO_VIO_CFG,\n\t\t\tLDO_VIO_SR_MASK, LDO_VIO_SR_DF);\n\t\trtsx_pci_write_register(pcr, LDO_DV12S_CFG,\n\t\t\tLDO_REF12_TUNE_MASK, LDO_REF12_TUNE_DF);\n\t\trtsx_pci_write_register(pcr, SD40_LDO_CTL1,\n\t\t\tSD40_VIO_TUNE_MASK, SD40_VIO_TUNE_1V7);\n\t}\n\n\treturn 0;\n}\n\nstatic void rts5250_set_l1off_cfg_sub_d0(struct rtsx_pcr *pcr, int active)\n{\n\tstruct rtsx_cr_option *option = &(pcr->option);\n\n\tu32 interrupt = rtsx_pci_readl(pcr, RTSX_BIPR);\n\tint card_exist = (interrupt & SD_EXIST) | (interrupt & MS_EXIST);\n\tint aspm_L1_1, aspm_L1_2;\n\tu8 val = 0;\n\n\taspm_L1_1 = rtsx_check_dev_flag(pcr, ASPM_L1_1_EN);\n\taspm_L1_2 = rtsx_check_dev_flag(pcr, ASPM_L1_2_EN);\n\n\tif (active) {\n\t\t \n\t\tif (aspm_L1_1)\n\t\t\tval = option->ltr_l1off_snooze_sspwrgate;\n\t} else {\n\t\t \n\t\tif (aspm_L1_2)\n\t\t\tval = option->ltr_l1off_sspwrgate;\n\t}\n\n\tif (aspm_L1_1 || aspm_L1_2) {\n\t\tif (rtsx_check_dev_flag(pcr,\n\t\t\t\t\tLTR_L1SS_PWR_GATE_CHECK_CARD_EN)) {\n\t\t\tif (card_exist)\n\t\t\t\tval &= ~L1OFF_MBIAS2_EN_5250;\n\t\t\telse\n\t\t\t\tval |= L1OFF_MBIAS2_EN_5250;\n\t\t}\n\t}\n\trtsx_set_l1off_sub(pcr, val);\n}\n\nstatic const struct pcr_ops rts524a_pcr_ops = {\n\t.write_phy = rts524a_write_phy,\n\t.read_phy = rts524a_read_phy,\n\t.fetch_vendor_settings = rtsx_base_fetch_vendor_settings,\n\t.extra_init_hw = rts524a_extra_init_hw,\n\t.optimize_phy = rts524a_optimize_phy,\n\t.turn_on_led = rtsx_base_turn_on_led,\n\t.turn_off_led = rtsx_base_turn_off_led,\n\t.enable_auto_blink = rtsx_base_enable_auto_blink,\n\t.disable_auto_blink = rtsx_base_disable_auto_blink,\n\t.card_power_on = rtsx_base_card_power_on,\n\t.card_power_off = rtsx_base_card_power_off,\n\t.switch_output_voltage = rtsx_base_switch_output_voltage,\n\t.force_power_down = rts52xa_force_power_down,\n\t.set_l1off_cfg_sub_d0 = rts5250_set_l1off_cfg_sub_d0,\n};\n\nvoid rts524a_init_params(struct rtsx_pcr *pcr)\n{\n\trts5249_init_params(pcr);\n\tpcr->aspm_mode = ASPM_MODE_REG;\n\tpcr->tx_initial_phase = SET_CLOCK_PHASE(27, 29, 11);\n\tpcr->option.ltr_l1off_sspwrgate = LTR_L1OFF_SSPWRGATE_5250_DEF;\n\tpcr->option.ltr_l1off_snooze_sspwrgate =\n\t\tLTR_L1OFF_SNOOZE_SSPWRGATE_5250_DEF;\n\n\tpcr->reg_pm_ctrl3 = RTS524A_PM_CTRL3;\n\tpcr->ops = &rts524a_pcr_ops;\n\n\tpcr->option.ocp_en = 1;\n\tif (pcr->option.ocp_en)\n\t\tpcr->hw_param.interrupt_en |= SD_OC_INT_EN;\n\tpcr->hw_param.ocp_glitch = SD_OCP_GLITCH_10M;\n\tpcr->option.sd_800mA_ocp_thd = RTS524A_OCP_THD_800;\n\n}\n\nstatic int rts525a_card_power_on(struct rtsx_pcr *pcr, int card)\n{\n\trtsx_pci_write_register(pcr, LDO_VCC_CFG1,\n\t\tLDO_VCC_TUNE_MASK, LDO_VCC_3V3);\n\treturn rtsx_base_card_power_on(pcr, card);\n}\n\nstatic int rts525a_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\n{\n\tswitch (voltage) {\n\tcase OUTPUT_3V3:\n\t\trtsx_pci_write_register(pcr, LDO_CONFIG2,\n\t\t\tLDO_D3318_MASK, LDO_D3318_33V);\n\t\trtsx_pci_write_register(pcr, SD_PAD_CTL, SD_IO_USING_1V8, 0);\n\t\tbreak;\n\tcase OUTPUT_1V8:\n\t\trtsx_pci_write_register(pcr, LDO_CONFIG2,\n\t\t\tLDO_D3318_MASK, LDO_D3318_18V);\n\t\trtsx_pci_write_register(pcr, SD_PAD_CTL, SD_IO_USING_1V8,\n\t\t\tSD_IO_USING_1V8);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\trtsx_pci_init_cmd(pcr);\n\trts5249_fill_driving(pcr, voltage);\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rts525a_optimize_phy(struct rtsx_pcr *pcr)\n{\n\tint err;\n\n\terr = rtsx_pci_write_register(pcr, RTS524A_PM_CTRL3,\n\t\tD3_DELINK_MODE_EN, 0x00);\n\tif (err < 0)\n\t\treturn err;\n\n\trtsx_pci_write_phy_register(pcr, _PHY_FLD0,\n\t\t_PHY_FLD0_CLK_REQ_20C | _PHY_FLD0_RX_IDLE_EN |\n\t\t_PHY_FLD0_BIT_ERR_RSTN | _PHY_FLD0_BER_COUNT |\n\t\t_PHY_FLD0_BER_TIMER | _PHY_FLD0_CHECK_EN);\n\n\trtsx_pci_write_phy_register(pcr, _PHY_ANA03,\n\t\t_PHY_ANA03_TIMER_MAX | _PHY_ANA03_OOBS_DEB_EN |\n\t\t_PHY_CMU_DEBUG_EN);\n\n\tif (is_version(pcr, 0x525A, IC_VER_A))\n\t\trtsx_pci_write_phy_register(pcr, _PHY_REV0,\n\t\t\t_PHY_REV0_FILTER_OUT | _PHY_REV0_CDR_BYPASS_PFD |\n\t\t\t_PHY_REV0_CDR_RX_IDLE_BYPASS);\n\n\treturn 0;\n}\n\nstatic int rts525a_extra_init_hw(struct rtsx_pcr *pcr)\n{\n\trts5249_extra_init_hw(pcr);\n\n\trtsx_pci_write_register(pcr, RTS5250_CLK_CFG3, RTS525A_CFG_MEM_PD, RTS525A_CFG_MEM_PD);\n\n\trtsx_pci_write_register(pcr, PCLK_CTL, PCLK_MODE_SEL, PCLK_MODE_SEL);\n\tif (is_version(pcr, 0x525A, IC_VER_A)) {\n\t\trtsx_pci_write_register(pcr, L1SUB_CONFIG2,\n\t\t\tL1SUB_AUTO_CFG, L1SUB_AUTO_CFG);\n\t\trtsx_pci_write_register(pcr, RREF_CFG,\n\t\t\tRREF_VBGSEL_MASK, RREF_VBGSEL_1V25);\n\t\trtsx_pci_write_register(pcr, LDO_VIO_CFG,\n\t\t\tLDO_VIO_TUNE_MASK, LDO_VIO_1V7);\n\t\trtsx_pci_write_register(pcr, LDO_DV12S_CFG,\n\t\t\tLDO_D12_TUNE_MASK, LDO_D12_TUNE_DF);\n\t\trtsx_pci_write_register(pcr, LDO_AV12S_CFG,\n\t\t\tLDO_AV12S_TUNE_MASK, LDO_AV12S_TUNE_DF);\n\t\trtsx_pci_write_register(pcr, LDO_VCC_CFG0,\n\t\t\tLDO_VCC_LMTVTH_MASK, LDO_VCC_LMTVTH_2A);\n\t\trtsx_pci_write_register(pcr, OOBS_CONFIG,\n\t\t\tOOBS_AUTOK_DIS | OOBS_VAL_MASK, 0x89);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct pcr_ops rts525a_pcr_ops = {\n\t.fetch_vendor_settings = rtsx_base_fetch_vendor_settings,\n\t.extra_init_hw = rts525a_extra_init_hw,\n\t.optimize_phy = rts525a_optimize_phy,\n\t.turn_on_led = rtsx_base_turn_on_led,\n\t.turn_off_led = rtsx_base_turn_off_led,\n\t.enable_auto_blink = rtsx_base_enable_auto_blink,\n\t.disable_auto_blink = rtsx_base_disable_auto_blink,\n\t.card_power_on = rts525a_card_power_on,\n\t.card_power_off = rtsx_base_card_power_off,\n\t.switch_output_voltage = rts525a_switch_output_voltage,\n\t.force_power_down = rts52xa_force_power_down,\n\t.set_l1off_cfg_sub_d0 = rts5250_set_l1off_cfg_sub_d0,\n};\n\nvoid rts525a_init_params(struct rtsx_pcr *pcr)\n{\n\trts5249_init_params(pcr);\n\tpcr->aspm_mode = ASPM_MODE_REG;\n\tpcr->tx_initial_phase = SET_CLOCK_PHASE(25, 29, 11);\n\tpcr->option.ltr_l1off_sspwrgate = LTR_L1OFF_SSPWRGATE_5250_DEF;\n\tpcr->option.ltr_l1off_snooze_sspwrgate =\n\t\tLTR_L1OFF_SNOOZE_SSPWRGATE_5250_DEF;\n\n\tpcr->reg_pm_ctrl3 = RTS524A_PM_CTRL3;\n\tpcr->ops = &rts525a_pcr_ops;\n\n\tpcr->option.ocp_en = 1;\n\tif (pcr->option.ocp_en)\n\t\tpcr->hw_param.interrupt_en |= SD_OC_INT_EN;\n\tpcr->hw_param.ocp_glitch = SD_OCP_GLITCH_10M;\n\tpcr->option.sd_800mA_ocp_thd = RTS525A_OCP_THD_800;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}