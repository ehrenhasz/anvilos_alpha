{
  "module_name": "rts5209.c",
  "hash_id": "79f6186ad42f1ce46f009db5852d58893bb0f28393b40d2401c79d36c0e14601",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/cardreader/rts5209.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/rtsx_pci.h>\n\n#include \"rtsx_pcr.h\"\n\nstatic u8 rts5209_get_ic_version(struct rtsx_pcr *pcr)\n{\n\tu8 val;\n\n\tval = rtsx_pci_readb(pcr, 0x1C);\n\treturn val & 0x0F;\n}\n\nstatic void rts5209_fetch_vendor_settings(struct rtsx_pcr *pcr)\n{\n\tstruct pci_dev *pdev = pcr->pci;\n\tu32 reg;\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG1, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG1, reg);\n\n\tif (rts5209_vendor_setting1_valid(reg)) {\n\t\tif (rts5209_reg_check_ms_pmos(reg))\n\t\t\tpcr->flags |= PCR_MS_PMOS;\n\t\tpcr->aspm_en = rts5209_reg_to_aspm(reg);\n\t}\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG2, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG2, reg);\n\n\tif (rts5209_vendor_setting2_valid(reg)) {\n\t\tpcr->sd30_drive_sel_1v8 =\n\t\t\trts5209_reg_to_sd30_drive_sel_1v8(reg);\n\t\tpcr->sd30_drive_sel_3v3 =\n\t\t\trts5209_reg_to_sd30_drive_sel_3v3(reg);\n\t\tpcr->card_drive_sel = rts5209_reg_to_card_drive_sel(reg);\n\t}\n}\n\nstatic void rts5209_force_power_down(struct rtsx_pcr *pcr, u8 pm_state, bool runtime)\n{\n\trtsx_pci_write_register(pcr, FPDCTL, 0x07, 0x07);\n}\n\nstatic int rts5209_extra_init_hw(struct rtsx_pcr *pcr)\n{\n\trtsx_pci_init_cmd(pcr);\n\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_GPIO, 0xFF, 0x03);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, ASPM_FORCE_CTL, 0x3F, 0);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0x08, 0x08);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_GPIO_DIR, 0xFF, 0x03);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DRIVE_SEL,\n\t\t\t0xFF, pcr->sd30_drive_sel_3v3);\n\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rts5209_optimize_phy(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_phy_register(pcr, 0x00, 0xB966);\n}\n\nstatic int rts5209_turn_on_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, CARD_GPIO, 0x01, 0x00);\n}\n\nstatic int rts5209_turn_off_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, CARD_GPIO, 0x01, 0x01);\n}\n\nstatic int rts5209_enable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, CARD_AUTO_BLINK, 0xFF, 0x0D);\n}\n\nstatic int rts5209_disable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, CARD_AUTO_BLINK, 0x08, 0x00);\n}\n\nstatic int rts5209_card_power_on(struct rtsx_pcr *pcr, int card)\n{\n\tint err;\n\tu8 pwr_mask, partial_pwr_on, pwr_on;\n\n\tpwr_mask = SD_POWER_MASK;\n\tpartial_pwr_on = SD_PARTIAL_POWER_ON;\n\tpwr_on = SD_POWER_ON;\n\n\tif ((pcr->flags & PCR_MS_PMOS) && (card == RTSX_MS_CARD)) {\n\t\tpwr_mask = MS_POWER_MASK;\n\t\tpartial_pwr_on = MS_PARTIAL_POWER_ON;\n\t\tpwr_on = MS_POWER_ON;\n\t}\n\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\n\t\t\tpwr_mask, partial_pwr_on);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\tLDO3318_PWR_MASK, 0x04);\n\terr = rtsx_pci_send_cmd(pcr, 100);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\tudelay(150);\n\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL, pwr_mask, pwr_on);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\tLDO3318_PWR_MASK, 0x00);\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rts5209_card_power_off(struct rtsx_pcr *pcr, int card)\n{\n\tu8 pwr_mask, pwr_off;\n\n\tpwr_mask = SD_POWER_MASK;\n\tpwr_off = SD_POWER_OFF;\n\n\tif ((pcr->flags & PCR_MS_PMOS) && (card == RTSX_MS_CARD)) {\n\t\tpwr_mask = MS_POWER_MASK;\n\t\tpwr_off = MS_POWER_OFF;\n\t}\n\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\n\t\t\tpwr_mask | PMOS_STRG_MASK, pwr_off | PMOS_STRG_400mA);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\tLDO3318_PWR_MASK, 0x06);\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rts5209_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\n{\n\tint err;\n\n\tif (voltage == OUTPUT_3V3) {\n\t\terr = rtsx_pci_write_register(pcr,\n\t\t\t\tSD30_DRIVE_SEL, 0x07, pcr->sd30_drive_sel_3v3);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = rtsx_pci_write_phy_register(pcr, 0x08, 0x4FC0 | 0x24);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t} else if (voltage == OUTPUT_1V8) {\n\t\terr = rtsx_pci_write_register(pcr,\n\t\t\t\tSD30_DRIVE_SEL, 0x07, pcr->sd30_drive_sel_1v8);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = rtsx_pci_write_phy_register(pcr, 0x08, 0x4C40 | 0x24);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct pcr_ops rts5209_pcr_ops = {\n\t.fetch_vendor_settings = rts5209_fetch_vendor_settings,\n\t.extra_init_hw = rts5209_extra_init_hw,\n\t.optimize_phy = rts5209_optimize_phy,\n\t.turn_on_led = rts5209_turn_on_led,\n\t.turn_off_led = rts5209_turn_off_led,\n\t.enable_auto_blink = rts5209_enable_auto_blink,\n\t.disable_auto_blink = rts5209_disable_auto_blink,\n\t.card_power_on = rts5209_card_power_on,\n\t.card_power_off = rts5209_card_power_off,\n\t.switch_output_voltage = rts5209_switch_output_voltage,\n\t.cd_deglitch = NULL,\n\t.conv_clk_and_div_n = NULL,\n\t.force_power_down = rts5209_force_power_down,\n};\n\n \nstatic const u32 rts5209_sd_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xE9),\n\t0,\n};\n\n \nstatic const u32 rts5209_sd_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xD5),\n\t0,\n};\n\n \nstatic const u32 rts5209_ms_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x15),\n\t0,\n};\n\n \nstatic const u32 rts5209_ms_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x15),\n\t0,\n};\n\nvoid rts5209_init_params(struct rtsx_pcr *pcr)\n{\n\tpcr->extra_caps = EXTRA_CAPS_SD_SDR50 |\n\t\tEXTRA_CAPS_SD_SDR104 | EXTRA_CAPS_MMC_8BIT;\n\tpcr->num_slots = 2;\n\tpcr->ops = &rts5209_pcr_ops;\n\n\tpcr->flags = 0;\n\tpcr->card_drive_sel = RTS5209_CARD_DRIVE_DEFAULT;\n\tpcr->sd30_drive_sel_1v8 = DRIVER_TYPE_B;\n\tpcr->sd30_drive_sel_3v3 = DRIVER_TYPE_D;\n\tpcr->aspm_en = ASPM_L1_EN;\n\tpcr->aspm_mode = ASPM_MODE_CFG;\n\tpcr->tx_initial_phase = SET_CLOCK_PHASE(27, 27, 16);\n\tpcr->rx_initial_phase = SET_CLOCK_PHASE(24, 6, 5);\n\n\tpcr->ic_version = rts5209_get_ic_version(pcr);\n\tpcr->sd_pull_ctl_enable_tbl = rts5209_sd_pull_ctl_enable_tbl;\n\tpcr->sd_pull_ctl_disable_tbl = rts5209_sd_pull_ctl_disable_tbl;\n\tpcr->ms_pull_ctl_enable_tbl = rts5209_ms_pull_ctl_enable_tbl;\n\tpcr->ms_pull_ctl_disable_tbl = rts5209_ms_pull_ctl_disable_tbl;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}