{
  "module_name": "rts5229.c",
  "hash_id": "cb61fadb9088c9ef015ce4acf721eaccff8c3036e0cf28f638c0317b842926a4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/cardreader/rts5229.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/rtsx_pci.h>\n\n#include \"rtsx_pcr.h\"\n\nstatic u8 rts5229_get_ic_version(struct rtsx_pcr *pcr)\n{\n\tu8 val;\n\n\trtsx_pci_read_register(pcr, DUMMY_REG_RESET_0, &val);\n\treturn val & 0x0F;\n}\n\nstatic void rts5229_fetch_vendor_settings(struct rtsx_pcr *pcr)\n{\n\tstruct pci_dev *pdev = pcr->pci;\n\tu32 reg;\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG1, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG1, reg);\n\n\tif (!rtsx_vendor_setting_valid(reg))\n\t\treturn;\n\n\tpcr->aspm_en = rtsx_reg_to_aspm(reg);\n\tpcr->sd30_drive_sel_1v8 =\n\t\tmap_sd_drive(rtsx_reg_to_sd30_drive_sel_1v8(reg));\n\tpcr->card_drive_sel &= 0x3F;\n\tpcr->card_drive_sel |= rtsx_reg_to_card_drive_sel(reg);\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG2, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG2, reg);\n\tpcr->sd30_drive_sel_3v3 =\n\t\tmap_sd_drive(rtsx_reg_to_sd30_drive_sel_3v3(reg));\n}\n\nstatic void rts5229_force_power_down(struct rtsx_pcr *pcr, u8 pm_state, bool runtime)\n{\n\trtsx_pci_write_register(pcr, FPDCTL, 0x03, 0x03);\n}\n\nstatic int rts5229_extra_init_hw(struct rtsx_pcr *pcr)\n{\n\trtsx_pci_init_cmd(pcr);\n\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, GPIO_CTL, 0x02, 0x02);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, ASPM_FORCE_CTL, 0x3F, 0);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0x08, 0x08);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x00);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x01);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, OLT_LED_CTL, 0x0F, 0x02);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DRIVE_SEL,\n\t\t\t0xFF, pcr->sd30_drive_sel_3v3);\n\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rts5229_optimize_phy(struct rtsx_pcr *pcr)\n{\n\t \n\treturn rtsx_pci_write_phy_register(pcr, 0x00, 0xBA42);\n}\n\nstatic int rts5229_turn_on_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x02);\n}\n\nstatic int rts5229_turn_off_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x00);\n}\n\nstatic int rts5229_enable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x08);\n}\n\nstatic int rts5229_disable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x00);\n}\n\nstatic int rts5229_card_power_on(struct rtsx_pcr *pcr, int card)\n{\n\tint err;\n\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\n\t\t\tSD_POWER_MASK, SD_PARTIAL_POWER_ON);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\tLDO3318_PWR_MASK, 0x02);\n\terr = rtsx_pci_send_cmd(pcr, 100);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\tudelay(150);\n\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\n\t\t\tSD_POWER_MASK, SD_POWER_ON);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\tLDO3318_PWR_MASK, 0x06);\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rts5229_card_power_off(struct rtsx_pcr *pcr, int card)\n{\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\n\t\t\tSD_POWER_MASK | PMOS_STRG_MASK,\n\t\t\tSD_POWER_OFF | PMOS_STRG_400mA);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\tLDO3318_PWR_MASK, 0x00);\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rts5229_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\n{\n\tint err;\n\n\tif (voltage == OUTPUT_3V3) {\n\t\terr = rtsx_pci_write_register(pcr,\n\t\t\t\tSD30_DRIVE_SEL, 0x07, pcr->sd30_drive_sel_3v3);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = rtsx_pci_write_phy_register(pcr, 0x08, 0x4FC0 | 0x24);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t} else if (voltage == OUTPUT_1V8) {\n\t\terr = rtsx_pci_write_register(pcr,\n\t\t\t\tSD30_DRIVE_SEL, 0x07, pcr->sd30_drive_sel_1v8);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\terr = rtsx_pci_write_phy_register(pcr, 0x08, 0x4C40 | 0x24);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct pcr_ops rts5229_pcr_ops = {\n\t.fetch_vendor_settings = rts5229_fetch_vendor_settings,\n\t.extra_init_hw = rts5229_extra_init_hw,\n\t.optimize_phy = rts5229_optimize_phy,\n\t.turn_on_led = rts5229_turn_on_led,\n\t.turn_off_led = rts5229_turn_off_led,\n\t.enable_auto_blink = rts5229_enable_auto_blink,\n\t.disable_auto_blink = rts5229_disable_auto_blink,\n\t.card_power_on = rts5229_card_power_on,\n\t.card_power_off = rts5229_card_power_off,\n\t.switch_output_voltage = rts5229_switch_output_voltage,\n\t.cd_deglitch = NULL,\n\t.conv_clk_and_div_n = NULL,\n\t.force_power_down = rts5229_force_power_down,\n};\n\n \nstatic const u32 rts5229_sd_pull_ctl_enable_tbl1[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xE9),\n\t0,\n};\n\n \nstatic const u32 rts5229_sd_pull_ctl_enable_tbl2[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xD9),\n\t0,\n};\n\n \nstatic const u32 rts5229_sd_pull_ctl_disable_tbl1[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xD5),\n\t0,\n};\n\n \nstatic const u32 rts5229_sd_pull_ctl_disable_tbl2[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xE5),\n\t0,\n};\n\n \nstatic const u32 rts5229_ms_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x15),\n\t0,\n};\n\n \nstatic const u32 rts5229_ms_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x15),\n\t0,\n};\n\nvoid rts5229_init_params(struct rtsx_pcr *pcr)\n{\n\tpcr->extra_caps = EXTRA_CAPS_SD_SDR50 | EXTRA_CAPS_SD_SDR104;\n\tpcr->num_slots = 2;\n\tpcr->ops = &rts5229_pcr_ops;\n\n\tpcr->flags = 0;\n\tpcr->card_drive_sel = RTSX_CARD_DRIVE_DEFAULT;\n\tpcr->sd30_drive_sel_1v8 = DRIVER_TYPE_B;\n\tpcr->sd30_drive_sel_3v3 = DRIVER_TYPE_D;\n\tpcr->aspm_en = ASPM_L1_EN;\n\tpcr->aspm_mode = ASPM_MODE_CFG;\n\tpcr->tx_initial_phase = SET_CLOCK_PHASE(27, 27, 15);\n\tpcr->rx_initial_phase = SET_CLOCK_PHASE(30, 6, 6);\n\n\tpcr->ic_version = rts5229_get_ic_version(pcr);\n\tif (pcr->ic_version == IC_VER_C) {\n\t\tpcr->sd_pull_ctl_enable_tbl = rts5229_sd_pull_ctl_enable_tbl2;\n\t\tpcr->sd_pull_ctl_disable_tbl = rts5229_sd_pull_ctl_disable_tbl2;\n\t} else {\n\t\tpcr->sd_pull_ctl_enable_tbl = rts5229_sd_pull_ctl_enable_tbl1;\n\t\tpcr->sd_pull_ctl_disable_tbl = rts5229_sd_pull_ctl_disable_tbl1;\n\t}\n\tpcr->ms_pull_ctl_enable_tbl = rts5229_ms_pull_ctl_enable_tbl;\n\tpcr->ms_pull_ctl_disable_tbl = rts5229_ms_pull_ctl_disable_tbl;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}