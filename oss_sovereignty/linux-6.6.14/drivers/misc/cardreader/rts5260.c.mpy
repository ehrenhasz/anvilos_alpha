{
  "module_name": "rts5260.c",
  "hash_id": "27e50ad44b5478247cd09d878650a94c1a180bcccaccf4bc451942e052f75258",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/cardreader/rts5260.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/rtsx_pci.h>\n\n#include \"rts5260.h\"\n#include \"rtsx_pcr.h\"\n\nstatic u8 rts5260_get_ic_version(struct rtsx_pcr *pcr)\n{\n\tu8 val;\n\n\trtsx_pci_read_register(pcr, DUMMY_REG_RESET_0, &val);\n\treturn val & IC_VERSION_MASK;\n}\n\nstatic void rts5260_fill_driving(struct rtsx_pcr *pcr, u8 voltage)\n{\n\tu8 driving_3v3[4][3] = {\n\t\t{0x11, 0x11, 0x11},\n\t\t{0x22, 0x22, 0x22},\n\t\t{0x55, 0x55, 0x55},\n\t\t{0x33, 0x33, 0x33},\n\t};\n\tu8 driving_1v8[4][3] = {\n\t\t{0x35, 0x33, 0x33},\n\t\t{0x8A, 0x88, 0x88},\n\t\t{0xBD, 0xBB, 0xBB},\n\t\t{0x9B, 0x99, 0x99},\n\t};\n\tu8 (*driving)[3], drive_sel;\n\n\tif (voltage == OUTPUT_3V3) {\n\t\tdriving = driving_3v3;\n\t\tdrive_sel = pcr->sd30_drive_sel_3v3;\n\t} else {\n\t\tdriving = driving_1v8;\n\t\tdrive_sel = pcr->sd30_drive_sel_1v8;\n\t}\n\n\trtsx_pci_write_register(pcr, SD30_CLK_DRIVE_SEL,\n\t\t\t 0xFF, driving[drive_sel][0]);\n\n\trtsx_pci_write_register(pcr, SD30_CMD_DRIVE_SEL,\n\t\t\t 0xFF, driving[drive_sel][1]);\n\n\trtsx_pci_write_register(pcr, SD30_DAT_DRIVE_SEL,\n\t\t\t 0xFF, driving[drive_sel][2]);\n}\n\nstatic void rtsx_base_fetch_vendor_settings(struct rtsx_pcr *pcr)\n{\n\tstruct pci_dev *pdev = pcr->pci;\n\tu32 reg;\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG1, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG1, reg);\n\n\tif (!rtsx_vendor_setting_valid(reg)) {\n\t\tpcr_dbg(pcr, \"skip fetch vendor setting\\n\");\n\t\treturn;\n\t}\n\n\tpcr->aspm_en = rtsx_reg_to_aspm(reg);\n\tpcr->sd30_drive_sel_1v8 = rtsx_reg_to_sd30_drive_sel_1v8(reg);\n\tpcr->card_drive_sel &= 0x3F;\n\tpcr->card_drive_sel |= rtsx_reg_to_card_drive_sel(reg);\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG2, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG2, reg);\n\tif (rtsx_check_mmc_support(reg))\n\t\tpcr->extra_caps |= EXTRA_CAPS_NO_MMC;\n\tpcr->sd30_drive_sel_3v3 = rtsx_reg_to_sd30_drive_sel_3v3(reg);\n\tif (rtsx_reg_check_reverse_socket(reg))\n\t\tpcr->flags |= PCR_REVERSE_SOCKET;\n}\n\nstatic int rtsx_base_enable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, OLT_LED_CTL,\n\t\tLED_SHINE_MASK, LED_SHINE_EN);\n}\n\nstatic int rtsx_base_disable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, OLT_LED_CTL,\n\t\tLED_SHINE_MASK, LED_SHINE_DISABLE);\n}\n\nstatic int rts5260_turn_on_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, RTS5260_REG_GPIO_CTL0,\n\t\tRTS5260_REG_GPIO_MASK, RTS5260_REG_GPIO_ON);\n}\n\nstatic int rts5260_turn_off_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, RTS5260_REG_GPIO_CTL0,\n\t\tRTS5260_REG_GPIO_MASK, RTS5260_REG_GPIO_OFF);\n}\n\n \nstatic const u32 rts5260_sd_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x66),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xE9),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0xAA),\n\t0,\n};\n\n \nstatic const u32 rts5260_sd_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x66),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xD5),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x55),\n\t0,\n};\n\n \nstatic const u32 rts5260_ms_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x15),\n\t0,\n};\n\n \nstatic const u32 rts5260_ms_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x15),\n\t0,\n};\n\nstatic int sd_set_sample_push_timing_sd30(struct rtsx_pcr *pcr)\n{\n\trtsx_pci_write_register(pcr, SD_CFG1, SD_MODE_SELECT_MASK\n\t\t| SD_ASYNC_FIFO_NOT_RST, SD_30_MODE | SD_ASYNC_FIFO_NOT_RST);\n\trtsx_pci_write_register(pcr, CLK_CTL, CLK_LOW_FREQ, CLK_LOW_FREQ);\n\trtsx_pci_write_register(pcr, CARD_CLK_SOURCE, 0xFF,\n\t\t\tCRC_VAR_CLK0 | SD30_FIX_CLK | SAMPLE_VAR_CLK1);\n\trtsx_pci_write_register(pcr, CLK_CTL, CLK_LOW_FREQ, 0);\n\n\treturn 0;\n}\n\nstatic int rts5260_card_power_on(struct rtsx_pcr *pcr, int card)\n{\n\tstruct rtsx_cr_option *option = &pcr->option;\n\n\tif (option->ocp_en)\n\t\trtsx_pci_enable_ocp(pcr);\n\n\n\trtsx_pci_write_register(pcr, LDO_CONFIG2, DV331812_VDD1, DV331812_VDD1);\n\trtsx_pci_write_register(pcr, LDO_VCC_CFG0,\n\t\t\t RTS5260_DVCC_TUNE_MASK, RTS5260_DVCC_33);\n\n\trtsx_pci_write_register(pcr, LDO_VCC_CFG1, LDO_POW_SDVDD1_MASK,\n\t\t\tLDO_POW_SDVDD1_ON);\n\n\trtsx_pci_write_register(pcr, LDO_CONFIG2,\n\t\t\t DV331812_POWERON, DV331812_POWERON);\n\tmsleep(20);\n\n\tif (pcr->extra_caps & EXTRA_CAPS_SD_SDR50 ||\n\t    pcr->extra_caps & EXTRA_CAPS_SD_SDR104)\n\t\tsd_set_sample_push_timing_sd30(pcr);\n\n\t \n\trtsx_pci_write_register(pcr, SD_CFG1, 0xFF,\n\t\t\t\tSD_CLK_DIVIDE_128 | SD_20_MODE);\n\n\trtsx_pci_write_register(pcr, SD_SAMPLE_POINT_CTL,\n\t\t\t\t0xFF, SD20_RX_POS_EDGE);\n\trtsx_pci_write_register(pcr, SD_PUSH_POINT_CTL, 0xFF, 0);\n\trtsx_pci_write_register(pcr, CARD_STOP, SD_STOP | SD_CLR_ERR,\n\t\t\t\tSD_STOP | SD_CLR_ERR);\n\n\t \n\trtsx_pci_write_register(pcr, SD_CFG3, SD30_CLK_END_EN, 0);\n\trtsx_pci_write_register(pcr, REG_SD_STOP_SDCLK_CFG,\n\t\t\tSD30_CLK_STOP_CFG_EN | SD30_CLK_STOP_CFG1 |\n\t\t\tSD30_CLK_STOP_CFG0, 0);\n\n\trtsx_pci_write_register(pcr, REG_PRE_RW_MODE, EN_INFINITE_MODE, 0);\n\n\treturn 0;\n}\n\nstatic int rts5260_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\n{\n\tswitch (voltage) {\n\tcase OUTPUT_3V3:\n\t\trtsx_pci_write_register(pcr, LDO_CONFIG2,\n\t\t\t\t\tDV331812_VDD1, DV331812_VDD1);\n\t\trtsx_pci_write_register(pcr, LDO_DV18_CFG,\n\t\t\t\t\tDV331812_MASK, DV331812_33);\n\t\trtsx_pci_write_register(pcr, SD_PAD_CTL, SD_IO_USING_1V8, 0);\n\t\tbreak;\n\tcase OUTPUT_1V8:\n\t\trtsx_pci_write_register(pcr, LDO_CONFIG2,\n\t\t\t\t\tDV331812_VDD1, DV331812_VDD1);\n\t\trtsx_pci_write_register(pcr, LDO_DV18_CFG,\n\t\t\t\t\tDV331812_MASK, DV331812_17);\n\t\trtsx_pci_write_register(pcr, SD_PAD_CTL, SD_IO_USING_1V8,\n\t\t\t\t\tSD_IO_USING_1V8);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\trts5260_fill_driving(pcr, voltage);\n\n\treturn 0;\n}\n\nstatic void rts5260_stop_cmd(struct rtsx_pcr *pcr)\n{\n\trtsx_pci_writel(pcr, RTSX_HCBCTLR, STOP_CMD);\n\trtsx_pci_writel(pcr, RTSX_HDBCTLR, STOP_DMA);\n\trtsx_pci_write_register(pcr, RTS5260_DMA_RST_CTL_0,\n\t\t\t\tRTS5260_DMA_RST | RTS5260_ADMA3_RST,\n\t\t\t\tRTS5260_DMA_RST | RTS5260_ADMA3_RST);\n\trtsx_pci_write_register(pcr, RBCTL, RB_FLUSH, RB_FLUSH);\n}\n\nstatic void rts5260_card_before_power_off(struct rtsx_pcr *pcr)\n{\n\trts5260_stop_cmd(pcr);\n\trts5260_switch_output_voltage(pcr, OUTPUT_3V3);\n\n}\n\nstatic int rts5260_card_power_off(struct rtsx_pcr *pcr, int card)\n{\n\tint err = 0;\n\n\trts5260_card_before_power_off(pcr);\n\terr = rtsx_pci_write_register(pcr, LDO_VCC_CFG1,\n\t\t\t LDO_POW_SDVDD1_MASK, LDO_POW_SDVDD1_OFF);\n\terr = rtsx_pci_write_register(pcr, LDO_CONFIG2,\n\t\t\t DV331812_POWERON, DV331812_POWEROFF);\n\tif (pcr->option.ocp_en)\n\t\trtsx_pci_disable_ocp(pcr);\n\n\treturn err;\n}\n\nstatic void rts5260_init_ocp(struct rtsx_pcr *pcr)\n{\n\tstruct rtsx_cr_option *option = &pcr->option;\n\n\tif (option->ocp_en) {\n\t\tu8 mask, val;\n\n\n\t\trtsx_pci_write_register(pcr, RTS5260_DVCC_CTRL,\n\t\t\t\tRTS5260_DVCC_OCP_THD_MASK,\n\t\t\t\toption->sd_800mA_ocp_thd);\n\n\t\trtsx_pci_write_register(pcr, RTS5260_DV331812_CFG,\n\t\t\t\tRTS5260_DV331812_OCP_THD_MASK,\n\t\t\t\tRTS5260_DV331812_OCP_THD_270);\n\n\t\tmask = SD_OCP_GLITCH_MASK;\n\t\tval = pcr->hw_param.ocp_glitch;\n\t\trtsx_pci_write_register(pcr, REG_OCPGLITCH, mask, val);\n\t\trtsx_pci_write_register(pcr, RTS5260_DVCC_CTRL,\n\t\t\t\t\tRTS5260_DVCC_OCP_EN |\n\t\t\t\t\tRTS5260_DVCC_OCP_CL_EN,\n\t\t\t\t\tRTS5260_DVCC_OCP_EN |\n\t\t\t\t\tRTS5260_DVCC_OCP_CL_EN);\n\n\t\trtsx_pci_enable_ocp(pcr);\n\t} else {\n\t\trtsx_pci_write_register(pcr, RTS5260_DVCC_CTRL,\n\t\t\t\t\tRTS5260_DVCC_OCP_EN |\n\t\t\t\t\tRTS5260_DVCC_OCP_CL_EN, 0);\n\t}\n}\n\nstatic void rts5260_enable_ocp(struct rtsx_pcr *pcr)\n{\n\tu8 val = 0;\n\n\tval = SD_OCP_INT_EN | SD_DETECT_EN;\n\trtsx_pci_write_register(pcr, REG_OCPCTL, 0xFF, val);\n\n}\n\nstatic void rts5260_disable_ocp(struct rtsx_pcr *pcr)\n{\n\tu8 mask = 0;\n\n\tmask = SD_OCP_INT_EN | SD_DETECT_EN;\n\trtsx_pci_write_register(pcr, REG_OCPCTL, mask, 0);\n\n}\n\n\nstatic int rts5260_get_ocpstat(struct rtsx_pcr *pcr, u8 *val)\n{\n\treturn rtsx_pci_read_register(pcr, REG_OCPSTAT, val);\n}\n\nstatic int rts5260_get_ocpstat2(struct rtsx_pcr *pcr, u8 *val)\n{\n\treturn rtsx_pci_read_register(pcr, REG_DV3318_OCPSTAT, val);\n}\n\nstatic void rts5260_clear_ocpstat(struct rtsx_pcr *pcr)\n{\n\tu8 mask = 0;\n\tu8 val = 0;\n\n\tmask = SD_OCP_INT_CLR | SD_OC_CLR;\n\tval = SD_OCP_INT_CLR | SD_OC_CLR;\n\n\trtsx_pci_write_register(pcr, REG_OCPCTL, mask, val);\n\trtsx_pci_write_register(pcr, REG_DV3318_OCPCTL,\n\t\t\t\tDV3318_OCP_INT_CLR | DV3318_OCP_CLR,\n\t\t\t\tDV3318_OCP_INT_CLR | DV3318_OCP_CLR);\n\tudelay(10);\n\trtsx_pci_write_register(pcr, REG_OCPCTL, mask, 0);\n\trtsx_pci_write_register(pcr, REG_DV3318_OCPCTL,\n\t\t\t\tDV3318_OCP_INT_CLR | DV3318_OCP_CLR, 0);\n}\n\nstatic void rts5260_process_ocp(struct rtsx_pcr *pcr)\n{\n\tif (!pcr->option.ocp_en)\n\t\treturn;\n\n\trtsx_pci_get_ocpstat(pcr, &pcr->ocp_stat);\n\trts5260_get_ocpstat2(pcr, &pcr->ocp_stat2);\n\n\tif ((pcr->ocp_stat & (SD_OC_NOW | SD_OC_EVER)) ||\n\t\t(pcr->ocp_stat2 & (DV3318_OCP_NOW | DV3318_OCP_EVER))) {\n\t\trtsx_pci_card_power_off(pcr, RTSX_SD_CARD);\n\t\trtsx_pci_write_register(pcr, CARD_OE, SD_OUTPUT_EN, 0);\n\t\trtsx_pci_clear_ocpstat(pcr);\n\t\tpcr->ocp_stat = 0;\n\t\tpcr->ocp_stat2 = 0;\n\t}\n\n}\n\nstatic int rts5260_init_hw(struct rtsx_pcr *pcr)\n{\n\tint err;\n\n\trtsx_pci_init_cmd(pcr);\n\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, L1SUB_CONFIG1,\n\t\t\t AUX_CLK_ACTIVE_SEL_MASK, MAC_CKSW_DONE);\n\t \n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, L1SUB_CONFIG3, 0xFF, 0x00);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PM_CLK_FORCE_CTL,\n\t\t\t CLK_PM_EN, CLK_PM_EN);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWD_SUSPEND_EN, 0xFF, 0xFF);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\n\t\t\t PWR_GATE_EN, PWR_GATE_EN);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, REG_VREF,\n\t\t\t PWD_SUSPND_EN, PWD_SUSPND_EN);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, RBCTL,\n\t\t\t U_AUTO_DMA_EN_MASK, U_AUTO_DMA_DISABLE);\n\n\tif (pcr->flags & PCR_REVERSE_SOCKET)\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0xB0, 0xB0);\n\telse\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PETXCFG, 0xB0, 0x80);\n\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, OBFF_CFG,\n\t\t\t OBFF_EN_MASK, OBFF_DISABLE);\n\n\terr = rtsx_pci_send_cmd(pcr, CMD_TIMEOUT_DEF);\n\tif (err < 0)\n\t\treturn err;\n\n\trtsx_pci_init_ocp(pcr);\n\n\treturn 0;\n}\n\nstatic void rts5260_pwr_saving_setting(struct rtsx_pcr *pcr)\n{\n\tint lss_l1_1, lss_l1_2;\n\n\tlss_l1_1 = rtsx_check_dev_flag(pcr, ASPM_L1_1_EN)\n\t\t\t| rtsx_check_dev_flag(pcr, PM_L1_1_EN);\n\tlss_l1_2 = rtsx_check_dev_flag(pcr, ASPM_L1_2_EN)\n\t\t\t| rtsx_check_dev_flag(pcr, PM_L1_2_EN);\n\n\trtsx_pci_write_register(pcr, ASPM_FORCE_CTL, 0xFF, 0);\n\tif (lss_l1_2) {\n\t\tpcr_dbg(pcr, \"Set parameters for L1.2.\");\n\t\trtsx_pci_write_register(pcr, PWR_GLOBAL_CTRL,\n\t\t\t\t\t0xFF, PCIE_L1_2_EN);\n\t\trtsx_pci_write_register(pcr, RTS5260_DVCC_CTRL,\n\t\t\t\t\tRTS5260_DVCC_OCP_EN |\n\t\t\t\t\tRTS5260_DVCC_OCP_CL_EN,\n\t\t\t\t\tRTS5260_DVCC_OCP_EN |\n\t\t\t\t\tRTS5260_DVCC_OCP_CL_EN);\n\n\t\trtsx_pci_write_register(pcr, PWR_FE_CTL,\n\t\t\t\t\t0xFF, PCIE_L1_2_PD_FE_EN);\n\t} else if (lss_l1_1) {\n\t\tpcr_dbg(pcr, \"Set parameters for L1.1.\");\n\t\trtsx_pci_write_register(pcr, PWR_GLOBAL_CTRL,\n\t\t\t\t\t0xFF, PCIE_L1_1_EN);\n\t\trtsx_pci_write_register(pcr, PWR_FE_CTL,\n\t\t\t\t\t0xFF, PCIE_L1_1_PD_FE_EN);\n\t} else {\n\t\tpcr_dbg(pcr, \"Set parameters for L1.\");\n\t\trtsx_pci_write_register(pcr, PWR_GLOBAL_CTRL,\n\t\t\t\t\t0xFF, PCIE_L1_0_EN);\n\t\trtsx_pci_write_register(pcr, PWR_FE_CTL,\n\t\t\t\t\t0xFF, PCIE_L1_0_PD_FE_EN);\n\t}\n\n\trtsx_pci_write_register(pcr, CFG_L1_0_PCIE_DPHY_RET_VALUE,\n\t\t\t\t0xFF, CFG_L1_0_RET_VALUE_DEFAULT);\n\trtsx_pci_write_register(pcr, CFG_L1_0_PCIE_MAC_RET_VALUE,\n\t\t\t\t0xFF, CFG_L1_0_RET_VALUE_DEFAULT);\n\trtsx_pci_write_register(pcr, CFG_L1_0_CRC_SD30_RET_VALUE,\n\t\t\t\t0xFF, CFG_L1_0_RET_VALUE_DEFAULT);\n\trtsx_pci_write_register(pcr, CFG_L1_0_CRC_SD40_RET_VALUE,\n\t\t\t\t0xFF, CFG_L1_0_RET_VALUE_DEFAULT);\n\trtsx_pci_write_register(pcr, CFG_L1_0_SYS_RET_VALUE,\n\t\t\t\t0xFF, CFG_L1_0_RET_VALUE_DEFAULT);\n\t \n\trtsx_pci_write_register(pcr, CFG_PCIE_APHY_OFF_0,\n\t\t\t\t0xFF, CFG_PCIE_APHY_OFF_0_DEFAULT);\n\trtsx_pci_write_register(pcr, CFG_PCIE_APHY_OFF_1,\n\t\t\t\t0xFF, CFG_PCIE_APHY_OFF_1_DEFAULT);\n\trtsx_pci_write_register(pcr, CFG_PCIE_APHY_OFF_2,\n\t\t\t\t0xFF, CFG_PCIE_APHY_OFF_2_DEFAULT);\n\trtsx_pci_write_register(pcr, CFG_PCIE_APHY_OFF_3,\n\t\t\t\t0xFF, CFG_PCIE_APHY_OFF_3_DEFAULT);\n\t \n\trtsx_pci_write_register(pcr, PWC_CDR, 0xFF, PWC_CDR_DEFAULT);\n\t \n\trtsx_pci_write_register(pcr, CFG_LP_FPWM_VALUE,\n\t\t\t\t0xFF, CFG_LP_FPWM_VALUE_DEFAULT);\n\t \n\trtsx_pci_write_register(pcr, CFG_L1_0_CRC_MISC_RET_VALUE,\n\t\t\t\t0xFF, CFG_L1_0_CRC_MISC_RET_VALUE_DEFAULT);\n}\n\nstatic void rts5260_init_from_cfg(struct rtsx_pcr *pcr)\n{\n\tstruct rtsx_cr_option *option = &pcr->option;\n\n\trts5260_pwr_saving_setting(pcr);\n\n\tif (option->ltr_en) {\n\t\tif (option->ltr_enabled)\n\t\t\trtsx_set_ltr_latency(pcr, option->ltr_active_latency);\n\t}\n}\n\nstatic int rts5260_extra_init_hw(struct rtsx_pcr *pcr)\n{\n\tstruct rtsx_cr_option *option = &pcr->option;\n\n\t \n\trtsx_pci_write_register(pcr, 0xFC03, 0x7F, 0x07);\n\trtsx_pci_write_register(pcr, SSC_DIV_N_0, 0xFF, 0x5D);\n\n\trts5260_init_from_cfg(pcr);\n\n\t \n\trtsx_pci_write_register(pcr, RTS5260_AUTOLOAD_CFG4,\n\t\t\t\t0xFF, RTS5260_MIMO_DISABLE);\n\t \n\trtsx_pci_write_register(pcr, LDO_VCC_CFG0,\n\t\t\t\tRTS5260_DVCC_TUNE_MASK, RTS5260_DVCC_33);\n\n\trtsx_pci_write_register(pcr, PCLK_CTL, PCLK_MODE_SEL, PCLK_MODE_SEL);\n\n\trts5260_init_hw(pcr);\n\n\t \n\tif (option->force_clkreq_0)\n\t\trtsx_pci_write_register(pcr, PETXCFG,\n\t\t\t\t FORCE_CLKREQ_DELINK_MASK, FORCE_CLKREQ_LOW);\n\telse\n\t\trtsx_pci_write_register(pcr, PETXCFG,\n\t\t\t\t FORCE_CLKREQ_DELINK_MASK, FORCE_CLKREQ_HIGH);\n\n\trtsx_pci_write_register(pcr, pcr->reg_pm_ctrl3, 0x10, 0x00);\n\n\treturn 0;\n}\n\nstatic void rts5260_set_l1off_cfg_sub_d0(struct rtsx_pcr *pcr, int active)\n{\n\tstruct rtsx_cr_option *option = &pcr->option;\n\tu32 interrupt = rtsx_pci_readl(pcr, RTSX_BIPR);\n\tint card_exist = (interrupt & SD_EXIST) | (interrupt & MS_EXIST);\n\tint aspm_L1_1, aspm_L1_2;\n\tu8 val = 0;\n\n\taspm_L1_1 = rtsx_check_dev_flag(pcr, ASPM_L1_1_EN);\n\taspm_L1_2 = rtsx_check_dev_flag(pcr, ASPM_L1_2_EN);\n\n\tif (active) {\n\t\t \n\t\tif (aspm_L1_1)\n\t\t\tval = option->ltr_l1off_snooze_sspwrgate;\n\t} else {\n\t\t \n\t\tif (aspm_L1_2)\n\t\t\tval = option->ltr_l1off_sspwrgate;\n\t}\n\n\tif (aspm_L1_1 || aspm_L1_2) {\n\t\tif (rtsx_check_dev_flag(pcr,\n\t\t\t\t\tLTR_L1SS_PWR_GATE_CHECK_CARD_EN)) {\n\t\t\tif (card_exist)\n\t\t\t\tval &= ~L1OFF_MBIAS2_EN_5250;\n\t\t\telse\n\t\t\t\tval |= L1OFF_MBIAS2_EN_5250;\n\t\t}\n\t}\n\trtsx_set_l1off_sub(pcr, val);\n}\n\nstatic const struct pcr_ops rts5260_pcr_ops = {\n\t.fetch_vendor_settings = rtsx_base_fetch_vendor_settings,\n\t.turn_on_led = rts5260_turn_on_led,\n\t.turn_off_led = rts5260_turn_off_led,\n\t.extra_init_hw = rts5260_extra_init_hw,\n\t.enable_auto_blink = rtsx_base_enable_auto_blink,\n\t.disable_auto_blink = rtsx_base_disable_auto_blink,\n\t.card_power_on = rts5260_card_power_on,\n\t.card_power_off = rts5260_card_power_off,\n\t.switch_output_voltage = rts5260_switch_output_voltage,\n\t.stop_cmd = rts5260_stop_cmd,\n\t.set_l1off_cfg_sub_d0 = rts5260_set_l1off_cfg_sub_d0,\n\t.enable_ocp = rts5260_enable_ocp,\n\t.disable_ocp = rts5260_disable_ocp,\n\t.init_ocp = rts5260_init_ocp,\n\t.process_ocp = rts5260_process_ocp,\n\t.get_ocpstat = rts5260_get_ocpstat,\n\t.clear_ocpstat = rts5260_clear_ocpstat,\n};\n\nvoid rts5260_init_params(struct rtsx_pcr *pcr)\n{\n\tstruct rtsx_cr_option *option = &pcr->option;\n\tstruct rtsx_hw_param *hw_param = &pcr->hw_param;\n\n\tpcr->extra_caps = EXTRA_CAPS_SD_SDR50 | EXTRA_CAPS_SD_SDR104;\n\tpcr->num_slots = 2;\n\n\tpcr->flags = 0;\n\tpcr->card_drive_sel = RTSX_CARD_DRIVE_DEFAULT;\n\tpcr->sd30_drive_sel_1v8 = CFG_DRIVER_TYPE_B;\n\tpcr->sd30_drive_sel_3v3 = CFG_DRIVER_TYPE_B;\n\tpcr->aspm_en = ASPM_L1_EN;\n\tpcr->aspm_mode = ASPM_MODE_REG;\n\tpcr->tx_initial_phase = SET_CLOCK_PHASE(27, 29, 11);\n\tpcr->rx_initial_phase = SET_CLOCK_PHASE(24, 6, 5);\n\n\tpcr->ic_version = rts5260_get_ic_version(pcr);\n\tpcr->sd_pull_ctl_enable_tbl = rts5260_sd_pull_ctl_enable_tbl;\n\tpcr->sd_pull_ctl_disable_tbl = rts5260_sd_pull_ctl_disable_tbl;\n\tpcr->ms_pull_ctl_enable_tbl = rts5260_ms_pull_ctl_enable_tbl;\n\tpcr->ms_pull_ctl_disable_tbl = rts5260_ms_pull_ctl_disable_tbl;\n\n\tpcr->reg_pm_ctrl3 = RTS524A_PM_CTRL3;\n\n\tpcr->ops = &rts5260_pcr_ops;\n\n\toption->dev_flags = (LTR_L1SS_PWR_GATE_CHECK_CARD_EN\n\t\t\t\t| LTR_L1SS_PWR_GATE_EN);\n\toption->ltr_en = true;\n\n\t \n\toption->ltr_active_latency = LTR_ACTIVE_LATENCY_DEF;\n\toption->ltr_idle_latency = LTR_IDLE_LATENCY_DEF;\n\toption->ltr_l1off_latency = LTR_L1OFF_LATENCY_DEF;\n\toption->l1_snooze_delay = L1_SNOOZE_DELAY_DEF;\n\toption->ltr_l1off_sspwrgate = LTR_L1OFF_SSPWRGATE_5250_DEF;\n\toption->ltr_l1off_snooze_sspwrgate =\n\t\tLTR_L1OFF_SNOOZE_SSPWRGATE_5250_DEF;\n\n\toption->ocp_en = 1;\n\tif (option->ocp_en)\n\t\thw_param->interrupt_en |= SD_OC_INT_EN;\n\thw_param->ocp_glitch =  SD_OCP_GLITCH_100U | SDVIO_OCP_GLITCH_800U;\n\toption->sd_400mA_ocp_thd = RTS5260_DVCC_OCP_THD_550;\n\toption->sd_800mA_ocp_thd = RTS5260_DVCC_OCP_THD_970;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}