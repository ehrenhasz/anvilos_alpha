{
  "module_name": "rtl8411.c",
  "hash_id": "d839dcbbe4f07ee9ad88666983d733c4c617dc6ec648aa1fb351e5f5b47c0942",
  "original_prompt": "Ingested from linux-6.6.14/drivers/misc/cardreader/rtl8411.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/bitops.h>\n#include <linux/delay.h>\n#include <linux/rtsx_pci.h>\n\n#include \"rtsx_pcr.h\"\n\nstatic u8 rtl8411_get_ic_version(struct rtsx_pcr *pcr)\n{\n\tu8 val;\n\n\trtsx_pci_read_register(pcr, SYS_VER, &val);\n\treturn val & 0x0F;\n}\n\nstatic int rtl8411b_is_qfn48(struct rtsx_pcr *pcr)\n{\n\tu8 val = 0;\n\n\trtsx_pci_read_register(pcr, RTL8411B_PACKAGE_MODE, &val);\n\n\tif (val & 0x2)\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\nstatic void rtl8411_fetch_vendor_settings(struct rtsx_pcr *pcr)\n{\n\tstruct pci_dev *pdev = pcr->pci;\n\tu32 reg1 = 0;\n\tu8 reg3 = 0;\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG1, &reg1);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG1, reg1);\n\n\tif (!rtsx_vendor_setting_valid(reg1))\n\t\treturn;\n\n\tpcr->aspm_en = rtsx_reg_to_aspm(reg1);\n\tpcr->sd30_drive_sel_1v8 =\n\t\tmap_sd_drive(rtsx_reg_to_sd30_drive_sel_1v8(reg1));\n\tpcr->card_drive_sel &= 0x3F;\n\tpcr->card_drive_sel |= rtsx_reg_to_card_drive_sel(reg1);\n\n\tpci_read_config_byte(pdev, PCR_SETTING_REG3, &reg3);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG3, reg3);\n\tpcr->sd30_drive_sel_3v3 = rtl8411_reg_to_sd30_drive_sel_3v3(reg3);\n}\n\nstatic void rtl8411b_fetch_vendor_settings(struct rtsx_pcr *pcr)\n{\n\tstruct pci_dev *pdev = pcr->pci;\n\tu32 reg = 0;\n\n\tpci_read_config_dword(pdev, PCR_SETTING_REG1, &reg);\n\tpcr_dbg(pcr, \"Cfg 0x%x: 0x%x\\n\", PCR_SETTING_REG1, reg);\n\n\tif (!rtsx_vendor_setting_valid(reg))\n\t\treturn;\n\n\tpcr->aspm_en = rtsx_reg_to_aspm(reg);\n\tpcr->sd30_drive_sel_1v8 =\n\t\tmap_sd_drive(rtsx_reg_to_sd30_drive_sel_1v8(reg));\n\tpcr->sd30_drive_sel_3v3 =\n\t\tmap_sd_drive(rtl8411b_reg_to_sd30_drive_sel_3v3(reg));\n}\n\nstatic void rtl8411_force_power_down(struct rtsx_pcr *pcr, u8 pm_state, bool runtime)\n{\n\trtsx_pci_write_register(pcr, FPDCTL, 0x07, 0x07);\n}\n\nstatic int rtl8411_extra_init_hw(struct rtsx_pcr *pcr)\n{\n\trtsx_pci_init_cmd(pcr);\n\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DRIVE_SEL,\n\t\t\t0xFF, pcr->sd30_drive_sel_3v3);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CD_PAD_CTL,\n\t\t\tCD_DISABLE_MASK | CD_AUTO_DISABLE, CD_ENABLE);\n\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rtl8411b_extra_init_hw(struct rtsx_pcr *pcr)\n{\n\trtsx_pci_init_cmd(pcr);\n\n\tif (rtl8411b_is_qfn48(pcr))\n\t\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD,\n\t\t\t\tCARD_PULL_CTL3, 0xFF, 0xF5);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DRIVE_SEL,\n\t\t\t0xFF, pcr->sd30_drive_sel_3v3);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CD_PAD_CTL,\n\t\t\tCD_DISABLE_MASK | CD_AUTO_DISABLE, CD_ENABLE);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, FUNC_FORCE_CTL,\n\t\t\t0x06, 0x00);\n\n\treturn rtsx_pci_send_cmd(pcr, 100);\n}\n\nstatic int rtl8411_turn_on_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, CARD_GPIO, 0x01, 0x00);\n}\n\nstatic int rtl8411_turn_off_led(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, CARD_GPIO, 0x01, 0x01);\n}\n\nstatic int rtl8411_enable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, CARD_AUTO_BLINK, 0xFF, 0x0D);\n}\n\nstatic int rtl8411_disable_auto_blink(struct rtsx_pcr *pcr)\n{\n\treturn rtsx_pci_write_register(pcr, CARD_AUTO_BLINK, 0x08, 0x00);\n}\n\nstatic int rtl8411_card_power_on(struct rtsx_pcr *pcr, int card)\n{\n\tint err;\n\n\trtsx_pci_init_cmd(pcr);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\n\t\t\tBPP_POWER_MASK, BPP_POWER_5_PERCENT_ON);\n\trtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_CTL,\n\t\t\tBPP_LDO_POWB, BPP_LDO_SUSPEND);\n\terr = rtsx_pci_send_cmd(pcr, 100);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\tudelay(150);\n\n\terr = rtsx_pci_write_register(pcr, CARD_PWR_CTL,\n\t\t\tBPP_POWER_MASK, BPP_POWER_10_PERCENT_ON);\n\tif (err < 0)\n\t\treturn err;\n\n\tudelay(150);\n\n\terr = rtsx_pci_write_register(pcr, CARD_PWR_CTL,\n\t\t\tBPP_POWER_MASK, BPP_POWER_15_PERCENT_ON);\n\tif (err < 0)\n\t\treturn err;\n\n\tudelay(150);\n\n\terr = rtsx_pci_write_register(pcr, CARD_PWR_CTL,\n\t\t\tBPP_POWER_MASK, BPP_POWER_ON);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn rtsx_pci_write_register(pcr, LDO_CTL, BPP_LDO_POWB, BPP_LDO_ON);\n}\n\nstatic int rtl8411_card_power_off(struct rtsx_pcr *pcr, int card)\n{\n\tint err;\n\n\terr = rtsx_pci_write_register(pcr, CARD_PWR_CTL,\n\t\t\tBPP_POWER_MASK, BPP_POWER_OFF);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn rtsx_pci_write_register(pcr, LDO_CTL,\n\t\t\tBPP_LDO_POWB, BPP_LDO_SUSPEND);\n}\n\nstatic int rtl8411_do_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage,\n\t\tint bpp_tuned18_shift, int bpp_asic_1v8)\n{\n\tu8 mask, val;\n\tint err;\n\n\tmask = (BPP_REG_TUNED18 << bpp_tuned18_shift) | BPP_PAD_MASK;\n\tif (voltage == OUTPUT_3V3) {\n\t\terr = rtsx_pci_write_register(pcr,\n\t\t\t\tSD30_DRIVE_SEL, 0x07, pcr->sd30_drive_sel_3v3);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tval = (BPP_ASIC_3V3 << bpp_tuned18_shift) | BPP_PAD_3V3;\n\t} else if (voltage == OUTPUT_1V8) {\n\t\terr = rtsx_pci_write_register(pcr,\n\t\t\t\tSD30_DRIVE_SEL, 0x07, pcr->sd30_drive_sel_1v8);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tval = (bpp_asic_1v8 << bpp_tuned18_shift) | BPP_PAD_1V8;\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\treturn rtsx_pci_write_register(pcr, LDO_CTL, mask, val);\n}\n\nstatic int rtl8411_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\n{\n\treturn rtl8411_do_switch_output_voltage(pcr, voltage,\n\t\t\tBPP_TUNED18_SHIFT_8411, BPP_ASIC_1V8);\n}\n\nstatic int rtl8402_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\n{\n\treturn rtl8411_do_switch_output_voltage(pcr, voltage,\n\t\t\tBPP_TUNED18_SHIFT_8402, BPP_ASIC_2V0);\n}\n\nstatic unsigned int rtl8411_cd_deglitch(struct rtsx_pcr *pcr)\n{\n\tunsigned int card_exist;\n\n\tcard_exist = rtsx_pci_readl(pcr, RTSX_BIPR);\n\tcard_exist &= CARD_EXIST;\n\tif (!card_exist) {\n\t\t \n\t\trtsx_pci_write_register(pcr, CD_PAD_CTL,\n\t\t\t\tCD_DISABLE_MASK, CD_ENABLE);\n\t\t \n\t\trtsx_pci_write_register(pcr, EFUSE_CONTENT, 0xe0, 0x00);\n\t\treturn 0;\n\t}\n\n\tif (hweight32(card_exist) > 1) {\n\t\trtsx_pci_write_register(pcr, CARD_PWR_CTL,\n\t\t\t\tBPP_POWER_MASK, BPP_POWER_5_PERCENT_ON);\n\t\tmsleep(100);\n\n\t\tcard_exist = rtsx_pci_readl(pcr, RTSX_BIPR);\n\t\tif (card_exist & MS_EXIST)\n\t\t\tcard_exist = MS_EXIST;\n\t\telse if (card_exist & SD_EXIST)\n\t\t\tcard_exist = SD_EXIST;\n\t\telse\n\t\t\tcard_exist = 0;\n\n\t\trtsx_pci_write_register(pcr, CARD_PWR_CTL,\n\t\t\t\tBPP_POWER_MASK, BPP_POWER_OFF);\n\n\t\tpcr_dbg(pcr, \"After CD deglitch, card_exist = 0x%x\\n\",\n\t\t\tcard_exist);\n\t}\n\n\tif (card_exist & MS_EXIST) {\n\t\t \n\t\trtsx_pci_write_register(pcr, EFUSE_CONTENT, 0xe0, 0x40);\n\t\trtsx_pci_write_register(pcr, CD_PAD_CTL,\n\t\t\t\tCD_DISABLE_MASK, MS_CD_EN_ONLY);\n\t} else if (card_exist & SD_EXIST) {\n\t\t \n\t\trtsx_pci_write_register(pcr, EFUSE_CONTENT, 0xe0, 0x80);\n\t\trtsx_pci_write_register(pcr, CD_PAD_CTL,\n\t\t\t\tCD_DISABLE_MASK, SD_CD_EN_ONLY);\n\t}\n\n\treturn card_exist;\n}\n\nstatic int rtl8411_conv_clk_and_div_n(int input, int dir)\n{\n\tint output;\n\n\tif (dir == CLK_TO_DIV_N)\n\t\toutput = input * 4 / 5 - 2;\n\telse\n\t\toutput = (input + 2) * 5 / 4;\n\n\treturn output;\n}\n\nstatic const struct pcr_ops rtl8411_pcr_ops = {\n\t.fetch_vendor_settings = rtl8411_fetch_vendor_settings,\n\t.extra_init_hw = rtl8411_extra_init_hw,\n\t.optimize_phy = NULL,\n\t.turn_on_led = rtl8411_turn_on_led,\n\t.turn_off_led = rtl8411_turn_off_led,\n\t.enable_auto_blink = rtl8411_enable_auto_blink,\n\t.disable_auto_blink = rtl8411_disable_auto_blink,\n\t.card_power_on = rtl8411_card_power_on,\n\t.card_power_off = rtl8411_card_power_off,\n\t.switch_output_voltage = rtl8411_switch_output_voltage,\n\t.cd_deglitch = rtl8411_cd_deglitch,\n\t.conv_clk_and_div_n = rtl8411_conv_clk_and_div_n,\n\t.force_power_down = rtl8411_force_power_down,\n};\n\nstatic const struct pcr_ops rtl8402_pcr_ops = {\n\t.fetch_vendor_settings = rtl8411_fetch_vendor_settings,\n\t.extra_init_hw = rtl8411_extra_init_hw,\n\t.optimize_phy = NULL,\n\t.turn_on_led = rtl8411_turn_on_led,\n\t.turn_off_led = rtl8411_turn_off_led,\n\t.enable_auto_blink = rtl8411_enable_auto_blink,\n\t.disable_auto_blink = rtl8411_disable_auto_blink,\n\t.card_power_on = rtl8411_card_power_on,\n\t.card_power_off = rtl8411_card_power_off,\n\t.switch_output_voltage = rtl8402_switch_output_voltage,\n\t.cd_deglitch = rtl8411_cd_deglitch,\n\t.conv_clk_and_div_n = rtl8411_conv_clk_and_div_n,\n\t.force_power_down = rtl8411_force_power_down,\n};\n\nstatic const struct pcr_ops rtl8411b_pcr_ops = {\n\t.fetch_vendor_settings = rtl8411b_fetch_vendor_settings,\n\t.extra_init_hw = rtl8411b_extra_init_hw,\n\t.optimize_phy = NULL,\n\t.turn_on_led = rtl8411_turn_on_led,\n\t.turn_off_led = rtl8411_turn_off_led,\n\t.enable_auto_blink = rtl8411_enable_auto_blink,\n\t.disable_auto_blink = rtl8411_disable_auto_blink,\n\t.card_power_on = rtl8411_card_power_on,\n\t.card_power_off = rtl8411_card_power_off,\n\t.switch_output_voltage = rtl8411_switch_output_voltage,\n\t.cd_deglitch = rtl8411_cd_deglitch,\n\t.conv_clk_and_div_n = rtl8411_conv_clk_and_div_n,\n\t.force_power_down = rtl8411_force_power_down,\n};\n\n \nstatic const u32 rtl8411_sd_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0xA9),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x09),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x09),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04),\n\t0,\n};\n\n \nstatic const u32 rtl8411_sd_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x65),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x95),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x09),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x05),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04),\n\t0,\n};\n\n \nstatic const u32 rtl8411_ms_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x65),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x95),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x05),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x05),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04),\n\t0,\n};\n\n \nstatic const u32 rtl8411_ms_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x65),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x95),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x09),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x05),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04),\n\t0,\n};\n\nstatic const u32 rtl8411b_qfn64_sd_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x09 | 0xD0),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x09 | 0x50),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x05 | 0x50),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04 | 0x11),\n\t0,\n};\n\nstatic const u32 rtl8411b_qfn48_sd_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0xAA),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x69 | 0x90),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x08 | 0x11),\n\t0,\n};\n\nstatic const u32 rtl8411b_qfn64_sd_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x65),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x05 | 0xD0),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x09 | 0x50),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x05 | 0x50),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04 | 0x11),\n\t0,\n};\n\nstatic const u32 rtl8411b_qfn48_sd_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x65 | 0x90),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04 | 0x11),\n\t0,\n};\n\nstatic const u32 rtl8411b_qfn64_ms_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x65),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x05 | 0xD0),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x05 | 0x50),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x05 | 0x50),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04 | 0x11),\n\t0,\n};\n\nstatic const u32 rtl8411b_qfn48_ms_pull_ctl_enable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x65 | 0x90),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04 | 0x11),\n\t0,\n};\n\nstatic const u32 rtl8411b_qfn64_ms_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL1, 0x65),\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x05 | 0xD0),\n\tRTSX_REG_PAIR(CARD_PULL_CTL4, 0x09 | 0x50),\n\tRTSX_REG_PAIR(CARD_PULL_CTL5, 0x05 | 0x50),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04 | 0x11),\n\t0,\n};\n\nstatic const u32 rtl8411b_qfn48_ms_pull_ctl_disable_tbl[] = {\n\tRTSX_REG_PAIR(CARD_PULL_CTL2, 0x55),\n\tRTSX_REG_PAIR(CARD_PULL_CTL3, 0x65 | 0x90),\n\tRTSX_REG_PAIR(CARD_PULL_CTL6, 0x04 | 0x11),\n\t0,\n};\n\nstatic void rtl8411_init_common_params(struct rtsx_pcr *pcr)\n{\n\tpcr->extra_caps = EXTRA_CAPS_SD_SDR50 | EXTRA_CAPS_SD_SDR104;\n\tpcr->num_slots = 2;\n\tpcr->flags = 0;\n\tpcr->card_drive_sel = RTL8411_CARD_DRIVE_DEFAULT;\n\tpcr->sd30_drive_sel_1v8 = DRIVER_TYPE_B;\n\tpcr->sd30_drive_sel_3v3 = DRIVER_TYPE_D;\n\tpcr->aspm_en = ASPM_L1_EN;\n\tpcr->aspm_mode = ASPM_MODE_CFG;\n\tpcr->tx_initial_phase = SET_CLOCK_PHASE(23, 7, 14);\n\tpcr->rx_initial_phase = SET_CLOCK_PHASE(4, 3, 10);\n\tpcr->ic_version = rtl8411_get_ic_version(pcr);\n}\n\nvoid rtl8411_init_params(struct rtsx_pcr *pcr)\n{\n\trtl8411_init_common_params(pcr);\n\tpcr->ops = &rtl8411_pcr_ops;\n\tset_pull_ctrl_tables(pcr, rtl8411);\n}\n\nvoid rtl8411b_init_params(struct rtsx_pcr *pcr)\n{\n\trtl8411_init_common_params(pcr);\n\tpcr->ops = &rtl8411b_pcr_ops;\n\tif (rtl8411b_is_qfn48(pcr))\n\t\tset_pull_ctrl_tables(pcr, rtl8411b_qfn48);\n\telse\n\t\tset_pull_ctrl_tables(pcr, rtl8411b_qfn64);\n}\n\nvoid rtl8402_init_params(struct rtsx_pcr *pcr)\n{\n\trtl8411_init_common_params(pcr);\n\tpcr->ops = &rtl8402_pcr_ops;\n\tset_pull_ctrl_tables(pcr, rtl8411);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}