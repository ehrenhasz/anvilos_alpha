{
  "module_name": "rtc-mt2712.c",
  "hash_id": "568958e9ddb2cd443ea214d1a9aa10d496787511f05e05fa299895d50c6df4c0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-mt2712.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/irqdomain.h>\n#include <linux/module.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n#include <linux/platform_device.h>\n#include <linux/rtc.h>\n\n#define MT2712_BBPU\t\t0x0000\n#define MT2712_BBPU_CLRPKY\tBIT(4)\n#define MT2712_BBPU_RELOAD\tBIT(5)\n#define MT2712_BBPU_CBUSY\tBIT(6)\n#define MT2712_BBPU_KEY\t\t(0x43 << 8)\n\n#define MT2712_IRQ_STA\t\t0x0004\n#define MT2712_IRQ_STA_AL\tBIT(0)\n#define MT2712_IRQ_STA_TC\tBIT(1)\n\n#define MT2712_IRQ_EN\t\t0x0008\n#define MT2712_IRQ_EN_AL\tBIT(0)\n#define MT2712_IRQ_EN_TC\tBIT(1)\n#define MT2712_IRQ_EN_ONESHOT\tBIT(2)\n\n#define MT2712_CII_EN\t\t0x000c\n\n#define MT2712_AL_MASK\t\t0x0010\n#define MT2712_AL_MASK_DOW\tBIT(4)\n\n#define MT2712_TC_SEC\t\t0x0014\n#define MT2712_TC_MIN\t\t0x0018\n#define MT2712_TC_HOU\t\t0x001c\n#define MT2712_TC_DOM\t\t0x0020\n#define MT2712_TC_DOW\t\t0x0024\n#define MT2712_TC_MTH\t\t0x0028\n#define MT2712_TC_YEA\t\t0x002c\n\n#define MT2712_AL_SEC\t\t0x0030\n#define MT2712_AL_MIN\t\t0x0034\n#define MT2712_AL_HOU\t\t0x0038\n#define MT2712_AL_DOM\t\t0x003c\n#define MT2712_AL_DOW\t\t0x0040\n#define MT2712_AL_MTH\t\t0x0044\n#define MT2712_AL_YEA\t\t0x0048\n\n#define MT2712_SEC_MASK\t\t0x003f\n#define MT2712_MIN_MASK\t\t0x003f\n#define MT2712_HOU_MASK\t\t0x001f\n#define MT2712_DOM_MASK\t\t0x001f\n#define MT2712_DOW_MASK\t\t0x0007\n#define MT2712_MTH_MASK\t\t0x000f\n#define MT2712_YEA_MASK\t\t0x007f\n\n#define MT2712_POWERKEY1\t0x004c\n#define MT2712_POWERKEY2\t0x0050\n#define MT2712_POWERKEY1_KEY\t0xa357\n#define MT2712_POWERKEY2_KEY\t0x67d2\n\n#define MT2712_CON0\t\t0x005c\n#define MT2712_CON1\t\t0x0060\n\n#define MT2712_PROT\t\t0x0070\n#define MT2712_PROT_UNLOCK1\t0x9136\n#define MT2712_PROT_UNLOCK2\t0x586a\n\n#define MT2712_WRTGR\t\t0x0078\n\n#define MT2712_RTC_TIMESTAMP_END_2127\t4985971199LL\n\nstruct mt2712_rtc {\n\tstruct rtc_device\t*rtc;\n\tvoid __iomem\t\t*base;\n\tint\t\t\tirq;\n\tu8\t\t\tirq_wake_enabled;\n\tu8\t\t\tpowerlost;\n};\n\nstatic inline u32 mt2712_readl(struct mt2712_rtc *mt2712_rtc, u32 reg)\n{\n\treturn readl(mt2712_rtc->base + reg);\n}\n\nstatic inline void mt2712_writel(struct mt2712_rtc *mt2712_rtc,\n\t\t\t\t u32 reg, u32 val)\n{\n\twritel(val, mt2712_rtc->base + reg);\n}\n\nstatic void mt2712_rtc_write_trigger(struct mt2712_rtc *mt2712_rtc)\n{\n\tunsigned long timeout = jiffies + HZ / 10;\n\n\tmt2712_writel(mt2712_rtc, MT2712_WRTGR, 1);\n\twhile (1) {\n\t\tif (!(mt2712_readl(mt2712_rtc, MT2712_BBPU)\n\t\t\t\t\t& MT2712_BBPU_CBUSY))\n\t\t\tbreak;\n\n\t\tif (time_after(jiffies, timeout)) {\n\t\t\tdev_err(&mt2712_rtc->rtc->dev,\n\t\t\t\t\"%s time out!\\n\", __func__);\n\t\t\tbreak;\n\t\t}\n\t\tcpu_relax();\n\t}\n}\n\nstatic void mt2712_rtc_writeif_unlock(struct mt2712_rtc *mt2712_rtc)\n{\n\tmt2712_writel(mt2712_rtc, MT2712_PROT, MT2712_PROT_UNLOCK1);\n\tmt2712_rtc_write_trigger(mt2712_rtc);\n\tmt2712_writel(mt2712_rtc, MT2712_PROT, MT2712_PROT_UNLOCK2);\n\tmt2712_rtc_write_trigger(mt2712_rtc);\n}\n\nstatic irqreturn_t rtc_irq_handler_thread(int irq, void *data)\n{\n\tstruct mt2712_rtc *mt2712_rtc = data;\n\tu16 irqsta;\n\n\t \n\tirqsta = mt2712_readl(mt2712_rtc, MT2712_IRQ_STA);\n\tif (irqsta & MT2712_IRQ_STA_AL) {\n\t\trtc_update_irq(mt2712_rtc->rtc, 1, RTC_IRQF | RTC_AF);\n\t\treturn IRQ_HANDLED;\n\t}\n\n\treturn IRQ_NONE;\n}\n\nstatic void __mt2712_rtc_read_time(struct mt2712_rtc *mt2712_rtc,\n\t\t\t\t   struct rtc_time *tm, int *sec)\n{\n\ttm->tm_sec  = mt2712_readl(mt2712_rtc, MT2712_TC_SEC)\n\t\t\t& MT2712_SEC_MASK;\n\ttm->tm_min  = mt2712_readl(mt2712_rtc, MT2712_TC_MIN)\n\t\t\t& MT2712_MIN_MASK;\n\ttm->tm_hour = mt2712_readl(mt2712_rtc, MT2712_TC_HOU)\n\t\t\t& MT2712_HOU_MASK;\n\ttm->tm_mday = mt2712_readl(mt2712_rtc, MT2712_TC_DOM)\n\t\t\t& MT2712_DOM_MASK;\n\ttm->tm_mon  = (mt2712_readl(mt2712_rtc, MT2712_TC_MTH) - 1)\n\t\t\t& MT2712_MTH_MASK;\n\ttm->tm_year = (mt2712_readl(mt2712_rtc, MT2712_TC_YEA) + 100)\n\t\t\t& MT2712_YEA_MASK;\n\n\t*sec = mt2712_readl(mt2712_rtc, MT2712_TC_SEC) & MT2712_SEC_MASK;\n}\n\nstatic int mt2712_rtc_read_time(struct device *dev, struct rtc_time *tm)\n{\n\tstruct mt2712_rtc *mt2712_rtc = dev_get_drvdata(dev);\n\tint sec;\n\n\tif (mt2712_rtc->powerlost)\n\t\treturn -EINVAL;\n\n\tdo {\n\t\t__mt2712_rtc_read_time(mt2712_rtc, tm, &sec);\n\t} while (sec < tm->tm_sec);\t \n\n\treturn 0;\n}\n\nstatic int mt2712_rtc_set_time(struct device *dev, struct rtc_time *tm)\n{\n\tstruct mt2712_rtc *mt2712_rtc = dev_get_drvdata(dev);\n\n\tmt2712_writel(mt2712_rtc, MT2712_TC_SEC, tm->tm_sec  & MT2712_SEC_MASK);\n\tmt2712_writel(mt2712_rtc, MT2712_TC_MIN, tm->tm_min  & MT2712_MIN_MASK);\n\tmt2712_writel(mt2712_rtc, MT2712_TC_HOU, tm->tm_hour & MT2712_HOU_MASK);\n\tmt2712_writel(mt2712_rtc, MT2712_TC_DOM, tm->tm_mday & MT2712_DOM_MASK);\n\tmt2712_writel(mt2712_rtc, MT2712_TC_MTH,\n\t\t      (tm->tm_mon + 1) & MT2712_MTH_MASK);\n\tmt2712_writel(mt2712_rtc, MT2712_TC_YEA,\n\t\t      (tm->tm_year - 100) & MT2712_YEA_MASK);\n\n\tmt2712_rtc_write_trigger(mt2712_rtc);\n\n\tif (mt2712_rtc->powerlost)\n\t\tmt2712_rtc->powerlost = false;\n\n\treturn 0;\n}\n\nstatic int mt2712_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\n{\n\tstruct mt2712_rtc *mt2712_rtc = dev_get_drvdata(dev);\n\tstruct rtc_time *tm = &alm->time;\n\tu16 irqen;\n\n\tirqen = mt2712_readl(mt2712_rtc, MT2712_IRQ_EN);\n\talm->enabled = !!(irqen & MT2712_IRQ_EN_AL);\n\n\ttm->tm_sec  = mt2712_readl(mt2712_rtc, MT2712_AL_SEC) & MT2712_SEC_MASK;\n\ttm->tm_min  = mt2712_readl(mt2712_rtc, MT2712_AL_MIN) & MT2712_MIN_MASK;\n\ttm->tm_hour = mt2712_readl(mt2712_rtc, MT2712_AL_HOU) & MT2712_HOU_MASK;\n\ttm->tm_mday = mt2712_readl(mt2712_rtc, MT2712_AL_DOM) & MT2712_DOM_MASK;\n\ttm->tm_mon  = (mt2712_readl(mt2712_rtc, MT2712_AL_MTH) - 1)\n\t\t      & MT2712_MTH_MASK;\n\ttm->tm_year = (mt2712_readl(mt2712_rtc, MT2712_AL_YEA) + 100)\n\t\t      & MT2712_YEA_MASK;\n\n\treturn 0;\n}\n\nstatic int mt2712_rtc_alarm_irq_enable(struct device *dev,\n\t\t\t\t       unsigned int enabled)\n{\n\tstruct mt2712_rtc *mt2712_rtc = dev_get_drvdata(dev);\n\tu16 irqen;\n\n\tirqen = mt2712_readl(mt2712_rtc, MT2712_IRQ_EN);\n\tif (enabled)\n\t\tirqen |= MT2712_IRQ_EN_AL;\n\telse\n\t\tirqen &= ~MT2712_IRQ_EN_AL;\n\tmt2712_writel(mt2712_rtc, MT2712_IRQ_EN, irqen);\n\tmt2712_rtc_write_trigger(mt2712_rtc);\n\n\treturn 0;\n}\n\nstatic int mt2712_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\n{\n\tstruct mt2712_rtc *mt2712_rtc = dev_get_drvdata(dev);\n\tstruct rtc_time *tm = &alm->time;\n\n\tdev_dbg(&mt2712_rtc->rtc->dev, \"set al time: %ptR, alm en: %d\\n\",\n\t\ttm, alm->enabled);\n\n\tmt2712_writel(mt2712_rtc, MT2712_AL_SEC,\n\t\t      (mt2712_readl(mt2712_rtc, MT2712_AL_SEC)\n\t\t       & ~(MT2712_SEC_MASK)) | (tm->tm_sec  & MT2712_SEC_MASK));\n\tmt2712_writel(mt2712_rtc, MT2712_AL_MIN,\n\t\t      (mt2712_readl(mt2712_rtc, MT2712_AL_MIN)\n\t\t       & ~(MT2712_MIN_MASK)) | (tm->tm_min  & MT2712_MIN_MASK));\n\tmt2712_writel(mt2712_rtc, MT2712_AL_HOU,\n\t\t      (mt2712_readl(mt2712_rtc, MT2712_AL_HOU)\n\t\t       & ~(MT2712_HOU_MASK)) | (tm->tm_hour & MT2712_HOU_MASK));\n\tmt2712_writel(mt2712_rtc, MT2712_AL_DOM,\n\t\t      (mt2712_readl(mt2712_rtc, MT2712_AL_DOM)\n\t\t       & ~(MT2712_DOM_MASK)) | (tm->tm_mday & MT2712_DOM_MASK));\n\tmt2712_writel(mt2712_rtc, MT2712_AL_MTH,\n\t\t      (mt2712_readl(mt2712_rtc, MT2712_AL_MTH)\n\t\t       & ~(MT2712_MTH_MASK))\n\t\t      | ((tm->tm_mon + 1) & MT2712_MTH_MASK));\n\tmt2712_writel(mt2712_rtc, MT2712_AL_YEA,\n\t\t      (mt2712_readl(mt2712_rtc, MT2712_AL_YEA)\n\t\t       & ~(MT2712_YEA_MASK))\n\t\t      | ((tm->tm_year - 100) & MT2712_YEA_MASK));\n\n\t \n\tmt2712_writel(mt2712_rtc, MT2712_AL_MASK, MT2712_AL_MASK_DOW);\n\tmt2712_rtc_write_trigger(mt2712_rtc);\n\n\tmt2712_rtc_alarm_irq_enable(dev, alm->enabled);\n\n\treturn 0;\n}\n\n \nstatic void mt2712_rtc_hw_init(struct mt2712_rtc *mt2712_rtc)\n{\n\tu32 p1, p2;\n\n\tmt2712_writel(mt2712_rtc, MT2712_BBPU,\n\t\t      MT2712_BBPU_KEY | MT2712_BBPU_RELOAD);\n\n\tmt2712_writel(mt2712_rtc, MT2712_CII_EN, 0);\n\tmt2712_writel(mt2712_rtc, MT2712_AL_MASK, 0);\n\t \n\tmt2712_writel(mt2712_rtc, MT2712_CON0, 0x4848);\n\tmt2712_writel(mt2712_rtc, MT2712_CON1, 0x0048);\n\n\tmt2712_rtc_write_trigger(mt2712_rtc);\n\n\tp1 = mt2712_readl(mt2712_rtc, MT2712_POWERKEY1);\n\tp2 = mt2712_readl(mt2712_rtc, MT2712_POWERKEY2);\n\tif (p1 != MT2712_POWERKEY1_KEY || p2 != MT2712_POWERKEY2_KEY) {\n\t\tmt2712_rtc->powerlost = true;\n\t\tdev_dbg(&mt2712_rtc->rtc->dev,\n\t\t\t\"powerkey not set (lost power)\\n\");\n\t} else {\n\t\tmt2712_rtc->powerlost = false;\n\t}\n\n\t \n\tmt2712_writel(mt2712_rtc, MT2712_POWERKEY1, MT2712_POWERKEY1_KEY);\n\tmt2712_writel(mt2712_rtc, MT2712_POWERKEY2, MT2712_POWERKEY2_KEY);\n\tmt2712_rtc_write_trigger(mt2712_rtc);\n\n\tmt2712_rtc_writeif_unlock(mt2712_rtc);\n}\n\nstatic const struct rtc_class_ops mt2712_rtc_ops = {\n\t.read_time\t= mt2712_rtc_read_time,\n\t.set_time\t= mt2712_rtc_set_time,\n\t.read_alarm\t= mt2712_rtc_read_alarm,\n\t.set_alarm\t= mt2712_rtc_set_alarm,\n\t.alarm_irq_enable = mt2712_rtc_alarm_irq_enable,\n};\n\nstatic int mt2712_rtc_probe(struct platform_device *pdev)\n{\n\tstruct mt2712_rtc *mt2712_rtc;\n\tint ret;\n\n\tmt2712_rtc = devm_kzalloc(&pdev->dev,\n\t\t\t\t  sizeof(struct mt2712_rtc), GFP_KERNEL);\n\tif (!mt2712_rtc)\n\t\treturn -ENOMEM;\n\n\tmt2712_rtc->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(mt2712_rtc->base))\n\t\treturn PTR_ERR(mt2712_rtc->base);\n\n\t \n\tmt2712_rtc_hw_init(mt2712_rtc);\n\n\tmt2712_rtc->irq = platform_get_irq(pdev, 0);\n\tif (mt2712_rtc->irq < 0)\n\t\treturn mt2712_rtc->irq;\n\n\tplatform_set_drvdata(pdev, mt2712_rtc);\n\n\tmt2712_rtc->rtc = devm_rtc_allocate_device(&pdev->dev);\n\tif (IS_ERR(mt2712_rtc->rtc))\n\t\treturn PTR_ERR(mt2712_rtc->rtc);\n\n\tret = devm_request_threaded_irq(&pdev->dev, mt2712_rtc->irq, NULL,\n\t\t\t\t\trtc_irq_handler_thread,\n\t\t\t\t\tIRQF_ONESHOT | IRQF_TRIGGER_LOW,\n\t\t\t\t\tdev_name(&mt2712_rtc->rtc->dev),\n\t\t\t\t\tmt2712_rtc);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Failed to request alarm IRQ: %d: %d\\n\",\n\t\t\tmt2712_rtc->irq, ret);\n\t\treturn ret;\n\t}\n\n\tdevice_init_wakeup(&pdev->dev, true);\n\n\tmt2712_rtc->rtc->ops = &mt2712_rtc_ops;\n\tmt2712_rtc->rtc->range_min = RTC_TIMESTAMP_BEGIN_2000;\n\tmt2712_rtc->rtc->range_max = MT2712_RTC_TIMESTAMP_END_2127;\n\n\treturn devm_rtc_register_device(mt2712_rtc->rtc);\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int mt2712_rtc_suspend(struct device *dev)\n{\n\tint wake_status = 0;\n\tstruct mt2712_rtc *mt2712_rtc = dev_get_drvdata(dev);\n\n\tif (device_may_wakeup(dev)) {\n\t\twake_status = enable_irq_wake(mt2712_rtc->irq);\n\t\tif (!wake_status)\n\t\t\tmt2712_rtc->irq_wake_enabled = true;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt2712_rtc_resume(struct device *dev)\n{\n\tint wake_status = 0;\n\tstruct mt2712_rtc *mt2712_rtc = dev_get_drvdata(dev);\n\n\tif (device_may_wakeup(dev) && mt2712_rtc->irq_wake_enabled) {\n\t\twake_status = disable_irq_wake(mt2712_rtc->irq);\n\t\tif (!wake_status)\n\t\t\tmt2712_rtc->irq_wake_enabled = false;\n\t}\n\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(mt2712_pm_ops, mt2712_rtc_suspend,\n\t\t\t mt2712_rtc_resume);\n#endif\n\nstatic const struct of_device_id mt2712_rtc_of_match[] = {\n\t{ .compatible = \"mediatek,mt2712-rtc\", },\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(of, mt2712_rtc_of_match);\n\nstatic struct platform_driver mt2712_rtc_driver = {\n\t.driver = {\n\t\t.name = \"mt2712-rtc\",\n\t\t.of_match_table = mt2712_rtc_of_match,\n#ifdef CONFIG_PM_SLEEP\n\t\t.pm = &mt2712_pm_ops,\n#endif\n\t},\n\t.probe  = mt2712_rtc_probe,\n};\n\nmodule_platform_driver(mt2712_rtc_driver);\n\nMODULE_DESCRIPTION(\"MediaTek MT2712 SoC based RTC Driver\");\nMODULE_AUTHOR(\"Ran Bi <ran.bi@mediatek.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}