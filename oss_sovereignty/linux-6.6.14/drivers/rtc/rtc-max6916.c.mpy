{
  "module_name": "rtc-max6916.c",
  "hash_id": "e3996bbbda9338c988c7ff762133b867fc3ad79723992f0268f8c2678f3f8ec1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-max6916.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/platform_device.h>\n#include <linux/rtc.h>\n#include <linux/spi/spi.h>\n#include <linux/bcd.h>\n\n \n\n#define MAX6916_SECONDS_REG\t0x01\n#define MAX6916_MINUTES_REG\t0x02\n#define MAX6916_HOURS_REG\t0x03\n#define MAX6916_DATE_REG\t0x04\n#define MAX6916_MONTH_REG\t0x05\n#define MAX6916_DAY_REG\t0x06\n#define MAX6916_YEAR_REG\t0x07\n#define MAX6916_CONTROL_REG\t0x08\n#define MAX6916_STATUS_REG\t0x0C\n#define MAX6916_CLOCK_BURST\t0x3F\n\nstatic int max6916_read_reg(struct device *dev, unsigned char address,\n\t\t\t    unsigned char *data)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\n\t*data = address | 0x80;\n\n\treturn spi_write_then_read(spi, data, 1, data, 1);\n}\n\nstatic int max6916_write_reg(struct device *dev, unsigned char address,\n\t\t\t     unsigned char data)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tunsigned char buf[2];\n\n\tbuf[0] = address & 0x7F;\n\tbuf[1] = data;\n\n\treturn spi_write_then_read(spi, buf, 2, NULL, 0);\n}\n\nstatic int max6916_read_time(struct device *dev, struct rtc_time *dt)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tint err;\n\tunsigned char buf[8];\n\n\tbuf[0] = MAX6916_CLOCK_BURST | 0x80;\n\n\terr = spi_write_then_read(spi, buf, 1, buf, 8);\n\n\tif (err)\n\t\treturn err;\n\n\tdt->tm_sec = bcd2bin(buf[0]);\n\tdt->tm_min = bcd2bin(buf[1]);\n\tdt->tm_hour = bcd2bin(buf[2] & 0x3F);\n\tdt->tm_mday = bcd2bin(buf[3]);\n\tdt->tm_mon = bcd2bin(buf[4]) - 1;\n\tdt->tm_wday = bcd2bin(buf[5]) - 1;\n\tdt->tm_year = bcd2bin(buf[6]) + 100;\n\n\treturn 0;\n}\n\nstatic int max6916_set_time(struct device *dev, struct rtc_time *dt)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tunsigned char buf[9];\n\n\tif (dt->tm_year < 100 || dt->tm_year > 199) {\n\t\tdev_err(&spi->dev, \"Year must be between 2000 and 2099. It's %d.\\n\",\n\t\t\tdt->tm_year + 1900);\n\t\treturn -EINVAL;\n\t}\n\n\tbuf[0] = MAX6916_CLOCK_BURST & 0x7F;\n\tbuf[1] = bin2bcd(dt->tm_sec);\n\tbuf[2] = bin2bcd(dt->tm_min);\n\tbuf[3] = (bin2bcd(dt->tm_hour) & 0X3F);\n\tbuf[4] = bin2bcd(dt->tm_mday);\n\tbuf[5] = bin2bcd(dt->tm_mon + 1);\n\tbuf[6] = bin2bcd(dt->tm_wday + 1);\n\tbuf[7] = bin2bcd(dt->tm_year % 100);\n\tbuf[8] = bin2bcd(0x00);\n\n\t \n\treturn spi_write_then_read(spi, buf, 9, NULL, 0);\n}\n\nstatic const struct rtc_class_ops max6916_rtc_ops = {\n\t.read_time = max6916_read_time,\n\t.set_time = max6916_set_time,\n};\n\nstatic int max6916_probe(struct spi_device *spi)\n{\n\tstruct rtc_device *rtc;\n\tunsigned char data;\n\tint res;\n\n\t \n\tspi->mode = SPI_MODE_3;\n\tspi->bits_per_word = 8;\n\tspi_setup(spi);\n\n\t \n\tres = max6916_read_reg(&spi->dev, MAX6916_SECONDS_REG, &data);\n\tif (res)\n\t\treturn res;\n\n\t \n\tmax6916_read_reg(&spi->dev, MAX6916_CONTROL_REG, &data);\n\tdata = data & ~(1 << 7);\n\tmax6916_write_reg(&spi->dev, MAX6916_CONTROL_REG, data);\n\n\t \n\tmax6916_read_reg(&spi->dev, MAX6916_STATUS_REG, &data);\n\tdata = data & 0x1B;\n\tmax6916_write_reg(&spi->dev, MAX6916_STATUS_REG, data);\n\n\t \n\tmax6916_read_reg(&spi->dev, MAX6916_CONTROL_REG, &data);\n\tdev_info(&spi->dev, \"MAX6916 RTC CTRL Reg = 0x%02x\\n\", data);\n\n\tmax6916_read_reg(&spi->dev, MAX6916_STATUS_REG, &data);\n\tdev_info(&spi->dev, \"MAX6916 RTC Status Reg = 0x%02x\\n\", data);\n\n\trtc = devm_rtc_device_register(&spi->dev, \"max6916\",\n\t\t\t\t       &max6916_rtc_ops, THIS_MODULE);\n\tif (IS_ERR(rtc))\n\t\treturn PTR_ERR(rtc);\n\n\tspi_set_drvdata(spi, rtc);\n\n\treturn 0;\n}\n\nstatic struct spi_driver max6916_driver = {\n\t.driver = {\n\t\t.name = \"max6916\",\n\t},\n\t.probe = max6916_probe,\n};\nmodule_spi_driver(max6916_driver);\n\nMODULE_DESCRIPTION(\"MAX6916 SPI RTC DRIVER\");\nMODULE_AUTHOR(\"Venkat Prashanth B U <venkat.prashanth2498@gmail.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}