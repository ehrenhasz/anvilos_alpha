{
  "module_name": "rtc-wilco-ec.c",
  "hash_id": "d06538fc11ec0bae77e127bdc0c2472d7d5e8d745fef175a38ccf8247ed34b10",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-wilco-ec.c",
  "human_readable_source": "\n \n\n#include <linux/bcd.h>\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/platform_data/wilco-ec.h>\n#include <linux/rtc.h>\n#include <linux/timekeeping.h>\n\n#define EC_COMMAND_CMOS\t\t\t0x7c\n#define EC_CMOS_TOD_WRITE\t\t0x02\n#define EC_CMOS_TOD_READ\t\t0x08\n\n \nstruct ec_rtc_read_request {\n\tu8 command;\n\tu8 reserved;\n\tu8 param;\n} __packed;\nstatic struct ec_rtc_read_request read_rq = {\n\t.command = EC_COMMAND_CMOS,\n\t.param = EC_CMOS_TOD_READ,\n};\n\n \nstruct ec_rtc_read_response {\n\tu8 reserved;\n\tu8 second;\n\tu8 minute;\n\tu8 hour;\n\tu8 day;\n\tu8 month;\n\tu8 year;\n\tu8 century;\n} __packed;\n\n \nstruct ec_rtc_write_request {\n\tu8 command;\n\tu8 reserved;\n\tu8 param;\n\tu8 century;\n\tu8 year;\n\tu8 month;\n\tu8 day;\n\tu8 hour;\n\tu8 minute;\n\tu8 second;\n\tu8 weekday;\n} __packed;\n\nstatic int wilco_ec_rtc_read(struct device *dev, struct rtc_time *tm)\n{\n\tstruct wilco_ec_device *ec = dev_get_drvdata(dev->parent);\n\tstruct ec_rtc_read_response rtc;\n\tstruct wilco_ec_message msg;\n\tint ret;\n\n\tmemset(&msg, 0, sizeof(msg));\n\tmsg.type = WILCO_EC_MSG_LEGACY;\n\tmsg.request_data = &read_rq;\n\tmsg.request_size = sizeof(read_rq);\n\tmsg.response_data = &rtc;\n\tmsg.response_size = sizeof(rtc);\n\n\tret = wilco_ec_mailbox(ec, &msg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\ttm->tm_sec\t= rtc.second;\n\ttm->tm_min\t= rtc.minute;\n\ttm->tm_hour\t= rtc.hour;\n\ttm->tm_mday\t= rtc.day;\n\ttm->tm_mon\t= rtc.month - 1;\n\ttm->tm_year\t= rtc.year + (rtc.century * 100) - 1900;\n\t \n\n\tif (rtc_valid_tm(tm)) {\n\t\tdev_err(dev, \"Time from RTC is invalid: %ptRr\\n\", tm);\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nstatic int wilco_ec_rtc_write(struct device *dev, struct rtc_time *tm)\n{\n\tstruct wilco_ec_device *ec = dev_get_drvdata(dev->parent);\n\tstruct ec_rtc_write_request rtc;\n\tstruct wilco_ec_message msg;\n\tint year = tm->tm_year + 1900;\n\t \n\tint wday = tm->tm_wday == 6 ? 0 : tm->tm_wday + 1;\n\tint ret;\n\n\trtc.command\t= EC_COMMAND_CMOS;\n\trtc.param\t= EC_CMOS_TOD_WRITE;\n\trtc.century\t= bin2bcd(year / 100);\n\trtc.year\t= bin2bcd(year % 100);\n\trtc.month\t= bin2bcd(tm->tm_mon + 1);\n\trtc.day\t\t= bin2bcd(tm->tm_mday);\n\trtc.hour\t= bin2bcd(tm->tm_hour);\n\trtc.minute\t= bin2bcd(tm->tm_min);\n\trtc.second\t= bin2bcd(tm->tm_sec);\n\trtc.weekday\t= bin2bcd(wday);\n\n\tmemset(&msg, 0, sizeof(msg));\n\tmsg.type = WILCO_EC_MSG_LEGACY;\n\tmsg.request_data = &rtc;\n\tmsg.request_size = sizeof(rtc);\n\n\tret = wilco_ec_mailbox(ec, &msg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic const struct rtc_class_ops wilco_ec_rtc_ops = {\n\t.read_time = wilco_ec_rtc_read,\n\t.set_time = wilco_ec_rtc_write,\n};\n\nstatic int wilco_ec_rtc_probe(struct platform_device *pdev)\n{\n\tstruct rtc_device *rtc;\n\n\trtc = devm_rtc_allocate_device(&pdev->dev);\n\tif (IS_ERR(rtc))\n\t\treturn PTR_ERR(rtc);\n\n\trtc->ops = &wilco_ec_rtc_ops;\n\t \n\trtc->range_min = RTC_TIMESTAMP_BEGIN_2000;\n\trtc->range_max = RTC_TIMESTAMP_END_2099;\n\trtc->owner = THIS_MODULE;\n\n\treturn devm_rtc_register_device(rtc);\n}\n\nstatic struct platform_driver wilco_ec_rtc_driver = {\n\t.driver = {\n\t\t.name = \"rtc-wilco-ec\",\n\t},\n\t.probe = wilco_ec_rtc_probe,\n};\n\nmodule_platform_driver(wilco_ec_rtc_driver);\n\nMODULE_ALIAS(\"platform:rtc-wilco-ec\");\nMODULE_AUTHOR(\"Nick Crews <ncrews@chromium.org>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Wilco EC RTC driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}