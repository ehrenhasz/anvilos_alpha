{
  "module_name": "rtc-m41t94.c",
  "hash_id": "4e04487cbcef9a4de016ba0a6fd3d9beb9e766cdfae0cf4a2e6c1e093a65f732",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-m41t94.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/rtc.h>\n#include <linux/spi/spi.h>\n#include <linux/bcd.h>\n\n#define M41T94_REG_SECONDS\t0x01\n#define M41T94_REG_MINUTES\t0x02\n#define M41T94_REG_HOURS\t0x03\n#define M41T94_REG_WDAY\t\t0x04\n#define M41T94_REG_DAY\t\t0x05\n#define M41T94_REG_MONTH\t0x06\n#define M41T94_REG_YEAR\t\t0x07\n#define M41T94_REG_HT\t\t0x0c\n\n#define M41T94_BIT_HALT\t\t0x40\n#define M41T94_BIT_STOP\t\t0x80\n#define M41T94_BIT_CB\t\t0x40\n#define M41T94_BIT_CEB\t\t0x80\n\nstatic int m41t94_set_time(struct device *dev, struct rtc_time *tm)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tu8 buf[8];  \n\n\tdev_dbg(dev, \"%s secs=%d, mins=%d, \"\n\t\t\"hours=%d, mday=%d, mon=%d, year=%d, wday=%d\\n\",\n\t\t\"write\", tm->tm_sec, tm->tm_min,\n\t\ttm->tm_hour, tm->tm_mday,\n\t\ttm->tm_mon, tm->tm_year, tm->tm_wday);\n\n\tbuf[0] = 0x80 | M41T94_REG_SECONDS;  \n\tbuf[M41T94_REG_SECONDS] = bin2bcd(tm->tm_sec);\n\tbuf[M41T94_REG_MINUTES] = bin2bcd(tm->tm_min);\n\tbuf[M41T94_REG_HOURS]   = bin2bcd(tm->tm_hour);\n\tbuf[M41T94_REG_WDAY]    = bin2bcd(tm->tm_wday + 1);\n\tbuf[M41T94_REG_DAY]     = bin2bcd(tm->tm_mday);\n\tbuf[M41T94_REG_MONTH]   = bin2bcd(tm->tm_mon + 1);\n\n\tbuf[M41T94_REG_HOURS] |= M41T94_BIT_CEB;\n\tif (tm->tm_year >= 100)\n\t\tbuf[M41T94_REG_HOURS] |= M41T94_BIT_CB;\n\tbuf[M41T94_REG_YEAR] = bin2bcd(tm->tm_year % 100);\n\n\treturn spi_write(spi, buf, 8);\n}\n\nstatic int m41t94_read_time(struct device *dev, struct rtc_time *tm)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tu8 buf[2];\n\tint ret, hour;\n\n\t \n\tret = spi_w8r8(spi, M41T94_REG_HT);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret & M41T94_BIT_HALT) {\n\t\tbuf[0] = 0x80 | M41T94_REG_HT;\n\t\tbuf[1] = ret & ~M41T94_BIT_HALT;\n\t\tspi_write(spi, buf, 2);\n\t}\n\n\t \n\tret = spi_w8r8(spi, M41T94_REG_SECONDS);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret & M41T94_BIT_STOP) {\n\t\tbuf[0] = 0x80 | M41T94_REG_SECONDS;\n\t\tbuf[1] = ret & ~M41T94_BIT_STOP;\n\t\tspi_write(spi, buf, 2);\n\t}\n\n\ttm->tm_sec  = bcd2bin(spi_w8r8(spi, M41T94_REG_SECONDS));\n\ttm->tm_min  = bcd2bin(spi_w8r8(spi, M41T94_REG_MINUTES));\n\thour = spi_w8r8(spi, M41T94_REG_HOURS);\n\ttm->tm_hour = bcd2bin(hour & 0x3f);\n\ttm->tm_wday = bcd2bin(spi_w8r8(spi, M41T94_REG_WDAY)) - 1;\n\ttm->tm_mday = bcd2bin(spi_w8r8(spi, M41T94_REG_DAY));\n\ttm->tm_mon  = bcd2bin(spi_w8r8(spi, M41T94_REG_MONTH)) - 1;\n\ttm->tm_year = bcd2bin(spi_w8r8(spi, M41T94_REG_YEAR));\n\tif ((hour & M41T94_BIT_CB) || !(hour & M41T94_BIT_CEB))\n\t\ttm->tm_year += 100;\n\n\tdev_dbg(dev, \"%s secs=%d, mins=%d, \"\n\t\t\"hours=%d, mday=%d, mon=%d, year=%d, wday=%d\\n\",\n\t\t\"read\", tm->tm_sec, tm->tm_min,\n\t\ttm->tm_hour, tm->tm_mday,\n\t\ttm->tm_mon, tm->tm_year, tm->tm_wday);\n\n\treturn 0;\n}\n\nstatic const struct rtc_class_ops m41t94_rtc_ops = {\n\t.read_time\t= m41t94_read_time,\n\t.set_time\t= m41t94_set_time,\n};\n\nstatic struct spi_driver m41t94_driver;\n\nstatic int m41t94_probe(struct spi_device *spi)\n{\n\tstruct rtc_device *rtc;\n\tint res;\n\n\tspi->bits_per_word = 8;\n\tspi_setup(spi);\n\n\tres = spi_w8r8(spi, M41T94_REG_SECONDS);\n\tif (res < 0) {\n\t\tdev_err(&spi->dev, \"not found.\\n\");\n\t\treturn res;\n\t}\n\n\trtc = devm_rtc_device_register(&spi->dev, m41t94_driver.driver.name,\n\t\t\t\t\t&m41t94_rtc_ops, THIS_MODULE);\n\tif (IS_ERR(rtc))\n\t\treturn PTR_ERR(rtc);\n\n\tspi_set_drvdata(spi, rtc);\n\n\treturn 0;\n}\n\nstatic struct spi_driver m41t94_driver = {\n\t.driver = {\n\t\t.name\t= \"rtc-m41t94\",\n\t},\n\t.probe\t= m41t94_probe,\n};\n\nmodule_spi_driver(m41t94_driver);\n\nMODULE_AUTHOR(\"Kim B. Heino <Kim.Heino@bluegiga.com>\");\nMODULE_DESCRIPTION(\"Driver for ST M41T94 SPI RTC\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"spi:rtc-m41t94\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}