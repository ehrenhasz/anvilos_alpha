{
  "module_name": "rtc-r9701.c",
  "hash_id": "00915d3cbdee0b9c783e202d0bb42982fcf9a0486549a85b5d8e48e318e38be6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-r9701.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/device.h>\n#include <linux/init.h>\n#include <linux/rtc.h>\n#include <linux/spi/spi.h>\n#include <linux/bcd.h>\n#include <linux/delay.h>\n#include <linux/bitops.h>\n\n#define RSECCNT\t0x00\t \n#define RMINCNT\t0x01\t \n#define RHRCNT\t0x02\t \n#define RWKCNT\t0x03\t \n#define RDAYCNT\t0x04\t \n#define RMONCNT\t0x05\t \n#define RYRCNT\t0x06\t \n#define R100CNT\t0x07\t \n#define RMINAR\t0x08\t \n#define RHRAR\t0x09\t \n#define RWKAR\t0x0a\t \n#define RTIMCNT\t0x0c\t \n#define REXT\t0x0d\t \n#define RFLAG\t0x0e\t \n#define RCR\t0x0f\t \n\nstatic int write_reg(struct device *dev, int address, unsigned char data)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tunsigned char buf[2];\n\n\tbuf[0] = address & 0x7f;\n\tbuf[1] = data;\n\n\treturn spi_write(spi, buf, ARRAY_SIZE(buf));\n}\n\nstatic int read_regs(struct device *dev, unsigned char *regs, int no_regs)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tu8 txbuf[1], rxbuf[1];\n\tint k, ret;\n\n\tret = 0;\n\n\tfor (k = 0; ret == 0 && k < no_regs; k++) {\n\t\ttxbuf[0] = 0x80 | regs[k];\n\t\tret = spi_write_then_read(spi, txbuf, 1, rxbuf, 1);\n\t\tregs[k] = rxbuf[0];\n\t}\n\n\treturn ret;\n}\n\nstatic int r9701_get_datetime(struct device *dev, struct rtc_time *dt)\n{\n\tint ret;\n\tunsigned char buf[] = { RSECCNT, RMINCNT, RHRCNT,\n\t\t\t\tRDAYCNT, RMONCNT, RYRCNT };\n\n\tret = read_regs(dev, buf, ARRAY_SIZE(buf));\n\tif (ret)\n\t\treturn ret;\n\n\tdt->tm_sec = bcd2bin(buf[0]);  \n\tdt->tm_min = bcd2bin(buf[1]);  \n\tdt->tm_hour = bcd2bin(buf[2]);  \n\n\tdt->tm_mday = bcd2bin(buf[3]);  \n\tdt->tm_mon = bcd2bin(buf[4]) - 1;  \n\tdt->tm_year = bcd2bin(buf[5]) + 100;  \n\n\treturn 0;\n}\n\nstatic int r9701_set_datetime(struct device *dev, struct rtc_time *dt)\n{\n\tint ret;\n\n\tret = write_reg(dev, RHRCNT, bin2bcd(dt->tm_hour));\n\tret = ret ? ret : write_reg(dev, RMINCNT, bin2bcd(dt->tm_min));\n\tret = ret ? ret : write_reg(dev, RSECCNT, bin2bcd(dt->tm_sec));\n\tret = ret ? ret : write_reg(dev, RDAYCNT, bin2bcd(dt->tm_mday));\n\tret = ret ? ret : write_reg(dev, RMONCNT, bin2bcd(dt->tm_mon + 1));\n\tret = ret ? ret : write_reg(dev, RYRCNT, bin2bcd(dt->tm_year - 100));\n\n\treturn ret;\n}\n\nstatic const struct rtc_class_ops r9701_rtc_ops = {\n\t.read_time\t= r9701_get_datetime,\n\t.set_time\t= r9701_set_datetime,\n};\n\nstatic int r9701_probe(struct spi_device *spi)\n{\n\tstruct rtc_device *rtc;\n\tunsigned char tmp;\n\tint res;\n\n\ttmp = R100CNT;\n\tres = read_regs(&spi->dev, &tmp, 1);\n\tif (res || tmp != 0x20) {\n\t\tdev_err(&spi->dev, \"cannot read RTC register\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\trtc = devm_rtc_allocate_device(&spi->dev);\n\tif (IS_ERR(rtc))\n\t\treturn PTR_ERR(rtc);\n\n\tspi_set_drvdata(spi, rtc);\n\trtc->ops = &r9701_rtc_ops;\n\trtc->range_min = RTC_TIMESTAMP_BEGIN_2000;\n\trtc->range_max = RTC_TIMESTAMP_END_2099;\n\n\treturn devm_rtc_register_device(rtc);\n}\n\nstatic struct spi_driver r9701_driver = {\n\t.driver = {\n\t\t.name\t= \"rtc-r9701\",\n\t},\n\t.probe\t= r9701_probe,\n};\n\nmodule_spi_driver(r9701_driver);\n\nMODULE_DESCRIPTION(\"r9701 spi RTC driver\");\nMODULE_AUTHOR(\"Magnus Damm <damm@opensource.se>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"spi:rtc-r9701\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}