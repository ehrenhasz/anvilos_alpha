{
  "module_name": "rtc-max6902.c",
  "hash_id": "f4e5ed849ffa78b83b1866e6c59d28a07f57a483b4e74c3b773b3b0d3beeea98",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-max6902.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/init.h>\n#include <linux/rtc.h>\n#include <linux/spi/spi.h>\n#include <linux/bcd.h>\n\n#define MAX6902_REG_SECONDS\t\t0x01\n#define MAX6902_REG_MINUTES\t\t0x03\n#define MAX6902_REG_HOURS\t\t0x05\n#define MAX6902_REG_DATE\t\t0x07\n#define MAX6902_REG_MONTH\t\t0x09\n#define MAX6902_REG_DAY\t\t\t0x0B\n#define MAX6902_REG_YEAR\t\t0x0D\n#define MAX6902_REG_CONTROL\t\t0x0F\n#define MAX6902_REG_CENTURY\t\t0x13\n\nstatic int max6902_set_reg(struct device *dev, unsigned char address,\n\t\t\t\tunsigned char data)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tunsigned char buf[2];\n\n\t \n\tbuf[0] = address & 0x7f;\n\tbuf[1] = data;\n\n\treturn spi_write_then_read(spi, buf, 2, NULL, 0);\n}\n\nstatic int max6902_get_reg(struct device *dev, unsigned char address,\n\t\t\t\tunsigned char *data)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\n\t \n\t*data = address | 0x80;\n\n\treturn spi_write_then_read(spi, data, 1, data, 1);\n}\n\nstatic int max6902_read_time(struct device *dev, struct rtc_time *dt)\n{\n\tint err, century;\n\tstruct spi_device *spi = to_spi_device(dev);\n\tunsigned char buf[8];\n\n\tbuf[0] = 0xbf;\t \n\n\terr = spi_write_then_read(spi, buf, 1, buf, 8);\n\tif (err != 0)\n\t\treturn err;\n\n\t \n\tdt->tm_sec\t= bcd2bin(buf[0]);\n\tdt->tm_min\t= bcd2bin(buf[1]);\n\tdt->tm_hour\t= bcd2bin(buf[2]);\n\tdt->tm_mday\t= bcd2bin(buf[3]);\n\tdt->tm_mon\t= bcd2bin(buf[4]) - 1;\n\tdt->tm_wday\t= bcd2bin(buf[5]);\n\tdt->tm_year\t= bcd2bin(buf[6]);\n\n\t \n\terr = max6902_get_reg(dev, MAX6902_REG_CENTURY, &buf[0]);\n\tif (err != 0)\n\t\treturn err;\n\n\tcentury = bcd2bin(buf[0]) * 100;\n\n\tdt->tm_year += century;\n\tdt->tm_year -= 1900;\n\n\treturn 0;\n}\n\nstatic int max6902_set_time(struct device *dev, struct rtc_time *dt)\n{\n\tdt->tm_year = dt->tm_year + 1900;\n\n\t \n\tmax6902_set_reg(dev, MAX6902_REG_CONTROL, 0);\n\n\tmax6902_set_reg(dev, MAX6902_REG_SECONDS, bin2bcd(dt->tm_sec));\n\tmax6902_set_reg(dev, MAX6902_REG_MINUTES, bin2bcd(dt->tm_min));\n\tmax6902_set_reg(dev, MAX6902_REG_HOURS, bin2bcd(dt->tm_hour));\n\n\tmax6902_set_reg(dev, MAX6902_REG_DATE, bin2bcd(dt->tm_mday));\n\tmax6902_set_reg(dev, MAX6902_REG_MONTH, bin2bcd(dt->tm_mon + 1));\n\tmax6902_set_reg(dev, MAX6902_REG_DAY, bin2bcd(dt->tm_wday));\n\tmax6902_set_reg(dev, MAX6902_REG_YEAR, bin2bcd(dt->tm_year % 100));\n\tmax6902_set_reg(dev, MAX6902_REG_CENTURY, bin2bcd(dt->tm_year / 100));\n\n\t \n\t \n\n\t \n\tmax6902_set_reg(dev, MAX6902_REG_CONTROL, 0x80);\n\n\treturn 0;\n}\n\nstatic const struct rtc_class_ops max6902_rtc_ops = {\n\t.read_time\t= max6902_read_time,\n\t.set_time\t= max6902_set_time,\n};\n\nstatic int max6902_probe(struct spi_device *spi)\n{\n\tstruct rtc_device *rtc;\n\tunsigned char tmp;\n\tint res;\n\n\tspi->mode = SPI_MODE_3;\n\tspi->bits_per_word = 8;\n\tspi_setup(spi);\n\n\tres = max6902_get_reg(&spi->dev, MAX6902_REG_SECONDS, &tmp);\n\tif (res != 0)\n\t\treturn res;\n\n\trtc = devm_rtc_device_register(&spi->dev, \"max6902\",\n\t\t\t\t&max6902_rtc_ops, THIS_MODULE);\n\tif (IS_ERR(rtc))\n\t\treturn PTR_ERR(rtc);\n\n\tspi_set_drvdata(spi, rtc);\n\treturn 0;\n}\n\nstatic struct spi_driver max6902_driver = {\n\t.driver = {\n\t\t.name\t= \"rtc-max6902\",\n\t},\n\t.probe\t= max6902_probe,\n};\n\nmodule_spi_driver(max6902_driver);\n\nMODULE_DESCRIPTION(\"max6902 spi RTC driver\");\nMODULE_AUTHOR(\"Raphael Assenat\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"spi:rtc-max6902\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}