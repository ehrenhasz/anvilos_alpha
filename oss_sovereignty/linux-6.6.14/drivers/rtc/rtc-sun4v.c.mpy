{
  "module_name": "rtc-sun4v.c",
  "hash_id": "820dc7fa1badafe199655395bb3deca800ee45baa3d96f1ae7a06755f596bcf5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-sun4v.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/rtc.h>\n#include <linux/platform_device.h>\n\n#include <asm/hypervisor.h>\n\nstatic unsigned long hypervisor_get_time(void)\n{\n\tunsigned long ret, time;\n\tint retries = 10000;\n\nretry:\n\tret = sun4v_tod_get(&time);\n\tif (ret == HV_EOK)\n\t\treturn time;\n\tif (ret == HV_EWOULDBLOCK) {\n\t\tif (--retries > 0) {\n\t\t\tudelay(100);\n\t\t\tgoto retry;\n\t\t}\n\t\tpr_warn(\"tod_get() timed out.\\n\");\n\t\treturn 0;\n\t}\n\tpr_warn(\"tod_get() not supported.\\n\");\n\treturn 0;\n}\n\nstatic int sun4v_read_time(struct device *dev, struct rtc_time *tm)\n{\n\trtc_time64_to_tm(hypervisor_get_time(), tm);\n\treturn 0;\n}\n\nstatic int hypervisor_set_time(unsigned long secs)\n{\n\tunsigned long ret;\n\tint retries = 10000;\n\nretry:\n\tret = sun4v_tod_set(secs);\n\tif (ret == HV_EOK)\n\t\treturn 0;\n\tif (ret == HV_EWOULDBLOCK) {\n\t\tif (--retries > 0) {\n\t\t\tudelay(100);\n\t\t\tgoto retry;\n\t\t}\n\t\tpr_warn(\"tod_set() timed out.\\n\");\n\t\treturn -EAGAIN;\n\t}\n\tpr_warn(\"tod_set() not supported.\\n\");\n\treturn -EOPNOTSUPP;\n}\n\nstatic int sun4v_set_time(struct device *dev, struct rtc_time *tm)\n{\n\treturn hypervisor_set_time(rtc_tm_to_time64(tm));\n}\n\nstatic const struct rtc_class_ops sun4v_rtc_ops = {\n\t.read_time\t= sun4v_read_time,\n\t.set_time\t= sun4v_set_time,\n};\n\nstatic int __init sun4v_rtc_probe(struct platform_device *pdev)\n{\n\tstruct rtc_device *rtc;\n\n\trtc = devm_rtc_allocate_device(&pdev->dev);\n\tif (IS_ERR(rtc))\n\t\treturn PTR_ERR(rtc);\n\n\trtc->ops = &sun4v_rtc_ops;\n\trtc->range_max = U64_MAX;\n\tplatform_set_drvdata(pdev, rtc);\n\n\treturn devm_rtc_register_device(rtc);\n}\n\nstatic struct platform_driver sun4v_rtc_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"rtc-sun4v\",\n\t},\n};\n\nbuiltin_platform_driver_probe(sun4v_rtc_driver, sun4v_rtc_probe);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}