{
  "module_name": "rtc-imx-sc.c",
  "hash_id": "fdd39f9dcfadb456292939613017662e30595673c13fc063bfba3a04f7986ede",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-imx-sc.c",
  "human_readable_source": "\n \n\n#include <dt-bindings/firmware/imx/rsrc.h>\n#include <linux/arm-smccc.h>\n#include <linux/firmware/imx/sci.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/rtc.h>\n\n#define IMX_SC_TIMER_FUNC_GET_RTC_SEC1970\t9\n#define IMX_SC_TIMER_FUNC_SET_RTC_ALARM\t\t8\n#define IMX_SC_TIMER_FUNC_SET_RTC_TIME\t\t6\n\n#define IMX_SIP_SRTC\t\t\t0xC2000002\n#define IMX_SIP_SRTC_SET_TIME\t\t0x0\n\n#define SC_IRQ_GROUP_RTC    2\n#define SC_IRQ_RTC          1\n\nstatic struct imx_sc_ipc *rtc_ipc_handle;\nstatic struct rtc_device *imx_sc_rtc;\n\nstruct imx_sc_msg_timer_get_rtc_time {\n\tstruct imx_sc_rpc_msg hdr;\n\tu32 time;\n} __packed;\n\nstruct imx_sc_msg_timer_rtc_set_alarm {\n\tstruct imx_sc_rpc_msg hdr;\n\tu16 year;\n\tu8 mon;\n\tu8 day;\n\tu8 hour;\n\tu8 min;\n\tu8 sec;\n} __packed __aligned(4);\n\nstatic int imx_sc_rtc_read_time(struct device *dev, struct rtc_time *tm)\n{\n\tstruct imx_sc_msg_timer_get_rtc_time msg;\n\tstruct imx_sc_rpc_msg *hdr = &msg.hdr;\n\tint ret;\n\n\thdr->ver = IMX_SC_RPC_VERSION;\n\thdr->svc = IMX_SC_RPC_SVC_TIMER;\n\thdr->func = IMX_SC_TIMER_FUNC_GET_RTC_SEC1970;\n\thdr->size = 1;\n\n\tret = imx_scu_call_rpc(rtc_ipc_handle, &msg, true);\n\tif (ret) {\n\t\tdev_err(dev, \"read rtc time failed, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\trtc_time64_to_tm(msg.time, tm);\n\n\treturn 0;\n}\n\nstatic int imx_sc_rtc_set_time(struct device *dev, struct rtc_time *tm)\n{\n\tstruct arm_smccc_res res;\n\n\t \n\tarm_smccc_smc(IMX_SIP_SRTC, IMX_SIP_SRTC_SET_TIME,\n\t\t      ((tm->tm_year + 1900) << 16) | (tm->tm_mon + 1),\n\t\t      (tm->tm_mday << 16) | tm->tm_hour,\n\t\t      (tm->tm_min << 16) | tm->tm_sec,\n\t\t      0, 0, 0, &res);\n\n\treturn res.a0;\n}\n\nstatic int imx_sc_rtc_alarm_irq_enable(struct device *dev, unsigned int enable)\n{\n\treturn imx_scu_irq_group_enable(SC_IRQ_GROUP_RTC, SC_IRQ_RTC, enable);\n}\n\nstatic int imx_sc_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\n{\n\tstruct imx_sc_msg_timer_rtc_set_alarm msg;\n\tstruct imx_sc_rpc_msg *hdr = &msg.hdr;\n\tint ret;\n\tstruct rtc_time *alrm_tm = &alrm->time;\n\n\thdr->ver = IMX_SC_RPC_VERSION;\n\thdr->svc = IMX_SC_RPC_SVC_TIMER;\n\thdr->func = IMX_SC_TIMER_FUNC_SET_RTC_ALARM;\n\thdr->size = 3;\n\n\tmsg.year = alrm_tm->tm_year + 1900;\n\tmsg.mon = alrm_tm->tm_mon + 1;\n\tmsg.day = alrm_tm->tm_mday;\n\tmsg.hour = alrm_tm->tm_hour;\n\tmsg.min = alrm_tm->tm_min;\n\tmsg.sec = alrm_tm->tm_sec;\n\n\tret = imx_scu_call_rpc(rtc_ipc_handle, &msg, true);\n\tif (ret) {\n\t\tdev_err(dev, \"set rtc alarm failed, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = imx_sc_rtc_alarm_irq_enable(dev, alrm->enabled);\n\tif (ret) {\n\t\tdev_err(dev, \"enable rtc alarm failed, ret %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct rtc_class_ops imx_sc_rtc_ops = {\n\t.read_time = imx_sc_rtc_read_time,\n\t.set_time = imx_sc_rtc_set_time,\n\t.set_alarm = imx_sc_rtc_set_alarm,\n\t.alarm_irq_enable = imx_sc_rtc_alarm_irq_enable,\n};\n\nstatic int imx_sc_rtc_alarm_notify(struct notifier_block *nb,\n\t\t\t\t\tunsigned long event, void *group)\n{\n\t \n\tif (!((event & SC_IRQ_RTC) && (*(u8 *)group == SC_IRQ_GROUP_RTC)))\n\t\treturn 0;\n\n\trtc_update_irq(imx_sc_rtc, 1, RTC_IRQF | RTC_AF);\n\n\treturn 0;\n}\n\nstatic struct notifier_block imx_sc_rtc_alarm_sc_notifier = {\n\t.notifier_call = imx_sc_rtc_alarm_notify,\n};\n\nstatic int imx_sc_rtc_probe(struct platform_device *pdev)\n{\n\tint ret;\n\n\tret = imx_scu_get_handle(&rtc_ipc_handle);\n\tif (ret)\n\t\treturn ret;\n\n\tdevice_init_wakeup(&pdev->dev, true);\n\n\timx_sc_rtc = devm_rtc_allocate_device(&pdev->dev);\n\tif (IS_ERR(imx_sc_rtc))\n\t\treturn PTR_ERR(imx_sc_rtc);\n\n\timx_sc_rtc->ops = &imx_sc_rtc_ops;\n\timx_sc_rtc->range_min = 0;\n\timx_sc_rtc->range_max = U32_MAX;\n\n\tret = devm_rtc_register_device(imx_sc_rtc);\n\tif (ret)\n\t\treturn ret;\n\n\timx_scu_irq_register_notifier(&imx_sc_rtc_alarm_sc_notifier);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id imx_sc_dt_ids[] = {\n\t{ .compatible = \"fsl,imx8qxp-sc-rtc\", },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, imx_sc_dt_ids);\n\nstatic struct platform_driver imx_sc_rtc_driver = {\n\t.driver = {\n\t\t.name\t= \"imx-sc-rtc\",\n\t\t.of_match_table = imx_sc_dt_ids,\n\t},\n\t.probe\t\t= imx_sc_rtc_probe,\n};\nmodule_platform_driver(imx_sc_rtc_driver);\n\nMODULE_AUTHOR(\"Anson Huang <Anson.Huang@nxp.com>\");\nMODULE_DESCRIPTION(\"NXP i.MX System Controller RTC Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}