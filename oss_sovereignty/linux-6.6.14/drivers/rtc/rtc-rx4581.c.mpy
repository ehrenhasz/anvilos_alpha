{
  "module_name": "rtc-rx4581.c",
  "hash_id": "d0aebe822b3072a49ea775fadfeedd630d4bf1c6c468fa94d33ea147f8b320c5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-rx4581.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/platform_device.h>\n#include <linux/init.h>\n#include <linux/rtc.h>\n#include <linux/spi/spi.h>\n#include <linux/bcd.h>\n\n#define RX4581_REG_SC\t\t0x00  \n#define RX4581_REG_MN\t\t0x01  \n#define RX4581_REG_HR\t\t0x02  \n#define RX4581_REG_DW\t\t0x03  \n#define RX4581_REG_DM\t\t0x04  \n#define RX4581_REG_MO\t\t0x05  \n#define RX4581_REG_YR\t\t0x06  \n#define RX4581_REG_RAM\t\t0x07  \n#define RX4581_REG_AMN\t\t0x08  \n#define RX4581_REG_AHR\t\t0x09  \n#define RX4581_REG_ADM\t\t0x0A\n#define RX4581_REG_ADW\t\t0x0A\n#define RX4581_REG_TMR0\t\t0x0B\n#define RX4581_REG_TMR1\t\t0x0C\n#define RX4581_REG_EXT\t\t0x0D  \n#define RX4581_REG_FLAG\t\t0x0E  \n#define RX4581_REG_CTRL\t\t0x0F  \n\n\n \n#define RX4581_FLAG_UF\t\t0x20  \n#define RX4581_FLAG_TF\t\t0x10  \n#define RX4581_FLAG_AF\t\t0x08  \n#define RX4581_FLAG_VLF\t\t0x02  \n\n \n#define RX4581_CTRL_UIE\t\t0x20  \n#define RX4581_CTRL_TIE\t\t0x10  \n#define RX4581_CTRL_AIE\t\t0x08  \n#define RX4581_CTRL_STOP\t0x02  \n#define RX4581_CTRL_RESET\t0x01  \n\nstatic int rx4581_set_reg(struct device *dev, unsigned char address,\n\t\t\t\tunsigned char data)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tunsigned char buf[2];\n\n\t \n\tbuf[0] = address & 0x0f;\n\tbuf[1] = data;\n\n\treturn spi_write_then_read(spi, buf, 2, NULL, 0);\n}\n\nstatic int rx4581_get_reg(struct device *dev, unsigned char address,\n\t\t\t\tunsigned char *data)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\n\t \n\t*data = address | 0x80;\n\n\treturn spi_write_then_read(spi, data, 1, data, 1);\n}\n\n \nstatic int rx4581_get_datetime(struct device *dev, struct rtc_time *tm)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tunsigned char date[7];\n\tunsigned char data;\n\tint err;\n\n\t \n\terr = rx4581_get_reg(dev, RX4581_REG_FLAG, &data);\n\tif (err != 0) {\n\t\tdev_err(dev, \"Unable to read device flags\\n\");\n\t\treturn -EIO;\n\t}\n\n\tdo {\n\t\t \n\t\tif (data & RX4581_FLAG_UF) {\n\t\t\terr = rx4581_set_reg(dev,\n\t\t\t\tRX4581_REG_FLAG, (data & ~RX4581_FLAG_UF));\n\t\t\tif (err != 0) {\n\t\t\t\tdev_err(dev, \"Unable to write device \"\n\t\t\t\t\t\"flags\\n\");\n\t\t\t\treturn -EIO;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tdate[0] = 0x80;\n\t\terr = spi_write_then_read(spi, date, 1, date, 7);\n\t\tif (err < 0) {\n\t\t\tdev_err(dev, \"Unable to read date\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\n\t\t \n\t\terr = rx4581_get_reg(dev, RX4581_REG_FLAG, &data);\n\t\tif (err != 0) {\n\t\t\tdev_err(dev, \"Unable to read device flags\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t} while (data & RX4581_FLAG_UF);\n\n\tif (data & RX4581_FLAG_VLF)\n\t\tdev_info(dev,\n\t\t\t\"low voltage detected, date/time is not reliable.\\n\");\n\n\tdev_dbg(dev,\n\t\t\"%s: raw data is sec=%02x, min=%02x, hr=%02x, \"\n\t\t\"wday=%02x, mday=%02x, mon=%02x, year=%02x\\n\",\n\t\t__func__,\n\t\tdate[0], date[1], date[2], date[3], date[4], date[5], date[6]);\n\n\ttm->tm_sec = bcd2bin(date[RX4581_REG_SC] & 0x7F);\n\ttm->tm_min = bcd2bin(date[RX4581_REG_MN] & 0x7F);\n\ttm->tm_hour = bcd2bin(date[RX4581_REG_HR] & 0x3F);  \n\ttm->tm_wday = ilog2(date[RX4581_REG_DW] & 0x7F);\n\ttm->tm_mday = bcd2bin(date[RX4581_REG_DM] & 0x3F);\n\ttm->tm_mon = bcd2bin(date[RX4581_REG_MO] & 0x1F) - 1;  \n\ttm->tm_year = bcd2bin(date[RX4581_REG_YR]);\n\tif (tm->tm_year < 70)\n\t\ttm->tm_year += 100;\t \n\n\n\tdev_dbg(dev, \"%s: tm is secs=%d, mins=%d, hours=%d, \"\n\t\t\"mday=%d, mon=%d, year=%d, wday=%d\\n\",\n\t\t__func__,\n\t\ttm->tm_sec, tm->tm_min, tm->tm_hour,\n\t\ttm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\n\n\treturn 0;\n}\n\nstatic int rx4581_set_datetime(struct device *dev, struct rtc_time *tm)\n{\n\tstruct spi_device *spi = to_spi_device(dev);\n\tint err;\n\tunsigned char buf[8], data;\n\n\tdev_dbg(dev, \"%s: secs=%d, mins=%d, hours=%d, \"\n\t\t\"mday=%d, mon=%d, year=%d, wday=%d\\n\",\n\t\t__func__,\n\t\ttm->tm_sec, tm->tm_min, tm->tm_hour,\n\t\ttm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\n\n\tbuf[0] = 0x00;\n\t \n\tbuf[RX4581_REG_SC+1] = bin2bcd(tm->tm_sec);\n\tbuf[RX4581_REG_MN+1] = bin2bcd(tm->tm_min);\n\tbuf[RX4581_REG_HR+1] = bin2bcd(tm->tm_hour);\n\n\tbuf[RX4581_REG_DM+1] = bin2bcd(tm->tm_mday);\n\n\t \n\tbuf[RX4581_REG_MO+1] = bin2bcd(tm->tm_mon + 1);\n\n\t \n\tbuf[RX4581_REG_YR+1] = bin2bcd(tm->tm_year % 100);\n\tbuf[RX4581_REG_DW+1] = (0x1 << tm->tm_wday);\n\n\t \n\terr = rx4581_get_reg(dev, RX4581_REG_CTRL, &data);\n\tif (err != 0) {\n\t\tdev_err(dev, \"Unable to read control register\\n\");\n\t\treturn -EIO;\n\t}\n\n\terr = rx4581_set_reg(dev, RX4581_REG_CTRL,\n\t\t(data | RX4581_CTRL_STOP));\n\tif (err != 0) {\n\t\tdev_err(dev, \"Unable to write control register\\n\");\n\t\treturn -EIO;\n\t}\n\n\t \n\terr = spi_write_then_read(spi, buf, 8, NULL, 0);\n\tif (err != 0) {\n\t\tdev_err(dev, \"Unable to write to date registers\\n\");\n\t\treturn -EIO;\n\t}\n\n\t \n\terr = rx4581_get_reg(dev, RX4581_REG_FLAG, &data);\n\tif (err != 0) {\n\t\tdev_err(dev, \"Unable to read flag register\\n\");\n\t\treturn -EIO;\n\t}\n\n\terr = rx4581_set_reg(dev, RX4581_REG_FLAG,\n\t\t(data & ~(RX4581_FLAG_VLF)));\n\tif (err != 0) {\n\t\tdev_err(dev, \"Unable to write flag register\\n\");\n\t\treturn -EIO;\n\t}\n\n\t \n\terr = rx4581_get_reg(dev, RX4581_REG_CTRL, &data);\n\tif (err != 0) {\n\t\tdev_err(dev, \"Unable to read control register\\n\");\n\t\treturn -EIO;\n\t}\n\n\terr = rx4581_set_reg(dev, RX4581_REG_CTRL,\n\t\t(data & ~(RX4581_CTRL_STOP)));\n\tif (err != 0) {\n\t\tdev_err(dev, \"Unable to write control register\\n\");\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct rtc_class_ops rx4581_rtc_ops = {\n\t.read_time\t= rx4581_get_datetime,\n\t.set_time\t= rx4581_set_datetime,\n};\n\nstatic int rx4581_probe(struct spi_device *spi)\n{\n\tstruct rtc_device *rtc;\n\tunsigned char tmp;\n\tint res;\n\n\tres = rx4581_get_reg(&spi->dev, RX4581_REG_SC, &tmp);\n\tif (res != 0)\n\t\treturn res;\n\n\trtc = devm_rtc_device_register(&spi->dev, \"rx4581\",\n\t\t\t\t&rx4581_rtc_ops, THIS_MODULE);\n\tif (IS_ERR(rtc))\n\t\treturn PTR_ERR(rtc);\n\n\tspi_set_drvdata(spi, rtc);\n\treturn 0;\n}\n\nstatic const struct spi_device_id rx4581_id[] = {\n\t{ \"rx4581\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(spi, rx4581_id);\n\nstatic struct spi_driver rx4581_driver = {\n\t.driver = {\n\t\t.name\t= \"rtc-rx4581\",\n\t},\n\t.probe\t= rx4581_probe,\n\t.id_table = rx4581_id,\n};\n\nmodule_spi_driver(rx4581_driver);\n\nMODULE_DESCRIPTION(\"rx4581 spi RTC driver\");\nMODULE_AUTHOR(\"Torben Hohn\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"spi:rtc-rx4581\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}