{
  "module_name": "rtc-ds1347.c",
  "hash_id": "5c5f23a3bf02d98b186197b047e56909ef52fd55418cbddd1b6f0cd95611c564",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-ds1347.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/platform_device.h>\n#include <linux/rtc.h>\n#include <linux/spi/spi.h>\n#include <linux/bcd.h>\n#include <linux/regmap.h>\n\n \n\n#define DS1347_SECONDS_REG\t0x01\n#define DS1347_MINUTES_REG\t0x03\n#define DS1347_HOURS_REG\t0x05\n#define DS1347_DATE_REG\t\t0x07\n#define DS1347_MONTH_REG\t0x09\n#define DS1347_DAY_REG\t\t0x0B\n#define DS1347_YEAR_REG\t\t0x0D\n#define DS1347_CONTROL_REG\t0x0F\n#define DS1347_CENTURY_REG\t0x13\n#define DS1347_STATUS_REG\t0x17\n#define DS1347_CLOCK_BURST\t0x3F\n\n#define DS1347_WP_BIT\t\tBIT(7)\n\n#define DS1347_NEOSC_BIT\tBIT(7)\n#define DS1347_OSF_BIT\t\tBIT(2)\n\nstatic const struct regmap_range ds1347_ranges[] = {\n\t{\n\t\t.range_min = DS1347_SECONDS_REG,\n\t\t.range_max = DS1347_STATUS_REG,\n\t},\n};\n\nstatic const struct regmap_access_table ds1347_access_table = {\n\t.yes_ranges = ds1347_ranges,\n\t.n_yes_ranges = ARRAY_SIZE(ds1347_ranges),\n};\n\nstatic int ds1347_read_time(struct device *dev, struct rtc_time *dt)\n{\n\tstruct regmap *map = dev_get_drvdata(dev);\n\tunsigned int status, century, secs;\n\tunsigned char buf[8];\n\tint err;\n\n\terr = regmap_read(map, DS1347_STATUS_REG, &status);\n\tif (err)\n\t\treturn err;\n\n\tif (status & DS1347_OSF_BIT)\n\t\treturn -EINVAL;\n\n\tdo {\n\t\terr = regmap_bulk_read(map, DS1347_CLOCK_BURST, buf, 8);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = regmap_read(map, DS1347_CENTURY_REG, &century);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = regmap_read(map, DS1347_SECONDS_REG, &secs);\n\t\tif (err)\n\t\t\treturn err;\n\t} while (buf[0] != secs);\n\n\tdt->tm_sec = bcd2bin(buf[0]);\n\tdt->tm_min = bcd2bin(buf[1] & 0x7f);\n\tdt->tm_hour = bcd2bin(buf[2] & 0x3F);\n\tdt->tm_mday = bcd2bin(buf[3]);\n\tdt->tm_mon = bcd2bin(buf[4]) - 1;\n\tdt->tm_wday = bcd2bin(buf[5]) - 1;\n\tdt->tm_year = (bcd2bin(century) * 100) + bcd2bin(buf[6]) - 1900;\n\n\treturn 0;\n}\n\nstatic int ds1347_set_time(struct device *dev, struct rtc_time *dt)\n{\n\tstruct regmap *map = dev_get_drvdata(dev);\n\tunsigned int century;\n\tunsigned char buf[8];\n\tint err;\n\n\terr = regmap_update_bits(map, DS1347_STATUS_REG,\n\t\t\t\t DS1347_NEOSC_BIT, DS1347_NEOSC_BIT);\n\tif (err)\n\t\treturn err;\n\n\tbuf[0] = bin2bcd(dt->tm_sec);\n\tbuf[1] = bin2bcd(dt->tm_min);\n\tbuf[2] = (bin2bcd(dt->tm_hour) & 0x3F);\n\tbuf[3] = bin2bcd(dt->tm_mday);\n\tbuf[4] = bin2bcd(dt->tm_mon + 1);\n\tbuf[5] = bin2bcd(dt->tm_wday + 1);\n\tbuf[6] = bin2bcd(dt->tm_year % 100);\n\tbuf[7] = bin2bcd(0x00);\n\n\terr = regmap_bulk_write(map, DS1347_CLOCK_BURST, buf, 8);\n\tif (err)\n\t\treturn err;\n\n\tcentury = (dt->tm_year / 100) + 19;\n\terr = regmap_write(map, DS1347_CENTURY_REG, bin2bcd(century));\n\tif (err)\n\t\treturn err;\n\n\treturn regmap_update_bits(map, DS1347_STATUS_REG,\n\t\t\t\t  DS1347_NEOSC_BIT | DS1347_OSF_BIT, 0);\n}\n\nstatic const struct rtc_class_ops ds1347_rtc_ops = {\n\t.read_time = ds1347_read_time,\n\t.set_time = ds1347_set_time,\n};\n\nstatic int ds1347_probe(struct spi_device *spi)\n{\n\tstruct rtc_device *rtc;\n\tstruct regmap_config config;\n\tstruct regmap *map;\n\tint err;\n\n\tmemset(&config, 0, sizeof(config));\n\tconfig.reg_bits = 8;\n\tconfig.val_bits = 8;\n\tconfig.read_flag_mask = 0x80;\n\tconfig.max_register = 0x3F;\n\tconfig.wr_table = &ds1347_access_table;\n\n\t \n\tspi->mode = SPI_MODE_3;\n\tspi->bits_per_word = 8;\n\tspi_setup(spi);\n\n\tmap = devm_regmap_init_spi(spi, &config);\n\n\tif (IS_ERR(map)) {\n\t\tdev_err(&spi->dev, \"ds1347 regmap init spi failed\\n\");\n\t\treturn PTR_ERR(map);\n\t}\n\n\tspi_set_drvdata(spi, map);\n\n\t \n\terr = regmap_update_bits(map, DS1347_CONTROL_REG, DS1347_WP_BIT, 0);\n\tif (err)\n\t\treturn err;\n\n\trtc = devm_rtc_allocate_device(&spi->dev);\n\tif (IS_ERR(rtc))\n\t\treturn PTR_ERR(rtc);\n\n\trtc->ops = &ds1347_rtc_ops;\n\trtc->range_min = RTC_TIMESTAMP_BEGIN_0000;\n\trtc->range_max = RTC_TIMESTAMP_END_9999;\n\n\treturn devm_rtc_register_device(rtc);\n}\n\nstatic struct spi_driver ds1347_driver = {\n\t.driver = {\n\t\t.name = \"ds1347\",\n\t},\n\t.probe = ds1347_probe,\n};\n\nmodule_spi_driver(ds1347_driver);\n\nMODULE_DESCRIPTION(\"DS1347 SPI RTC DRIVER\");\nMODULE_AUTHOR(\"Raghavendra C Ganiga <ravi23ganiga@gmail.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}