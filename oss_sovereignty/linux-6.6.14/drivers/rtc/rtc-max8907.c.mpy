{
  "module_name": "rtc-max8907.c",
  "hash_id": "66c27db4ccfd3be342bf45c943089b4811c1014922c61b393c2ce60ad3caac51",
  "original_prompt": "Ingested from linux-6.6.14/drivers/rtc/rtc-max8907.c",
  "human_readable_source": "\n \n\n#include <linux/bcd.h>\n#include <linux/mfd/max8907.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/rtc.h>\n#include <linux/slab.h>\n\nenum {\n\tRTC_SEC = 0,\n\tRTC_MIN,\n\tRTC_HOUR,\n\tRTC_WEEKDAY,\n\tRTC_DATE,\n\tRTC_MONTH,\n\tRTC_YEAR1,\n\tRTC_YEAR2,\n};\n\n#define TIME_NUM\t\t\t8\n#define ALARM_1SEC\t\t\t(1 << 7)\n#define HOUR_12\t\t\t\t(1 << 7)\n#define HOUR_AM_PM\t\t\t(1 << 5)\n#define ALARM0_IRQ\t\t\t(1 << 3)\n#define ALARM1_IRQ\t\t\t(1 << 2)\n#define ALARM0_STATUS\t\t\t(1 << 2)\n#define ALARM1_STATUS\t\t\t(1 << 1)\n\nstruct max8907_rtc {\n\tstruct max8907\t\t*max8907;\n\tstruct regmap\t\t*regmap;\n\tstruct rtc_device\t*rtc_dev;\n\tint\t\t\tirq;\n};\n\nstatic irqreturn_t max8907_irq_handler(int irq, void *data)\n{\n\tstruct max8907_rtc *rtc = data;\n\n\tregmap_write(rtc->regmap, MAX8907_REG_ALARM0_CNTL, 0);\n\n\trtc_update_irq(rtc->rtc_dev, 1, RTC_IRQF | RTC_AF);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void regs_to_tm(u8 *regs, struct rtc_time *tm)\n{\n\ttm->tm_year = bcd2bin(regs[RTC_YEAR2]) * 100 +\n\t\tbcd2bin(regs[RTC_YEAR1]) - 1900;\n\ttm->tm_mon = bcd2bin(regs[RTC_MONTH] & 0x1f) - 1;\n\ttm->tm_mday = bcd2bin(regs[RTC_DATE] & 0x3f);\n\ttm->tm_wday = (regs[RTC_WEEKDAY] & 0x07);\n\tif (regs[RTC_HOUR] & HOUR_12) {\n\t\ttm->tm_hour = bcd2bin(regs[RTC_HOUR] & 0x01f);\n\t\tif (tm->tm_hour == 12)\n\t\t\ttm->tm_hour = 0;\n\t\tif (regs[RTC_HOUR] & HOUR_AM_PM)\n\t\t\ttm->tm_hour += 12;\n\t} else {\n\t\ttm->tm_hour = bcd2bin(regs[RTC_HOUR] & 0x03f);\n\t}\n\ttm->tm_min = bcd2bin(regs[RTC_MIN] & 0x7f);\n\ttm->tm_sec = bcd2bin(regs[RTC_SEC] & 0x7f);\n}\n\nstatic void tm_to_regs(struct rtc_time *tm, u8 *regs)\n{\n\tu8 high, low;\n\n\thigh = (tm->tm_year + 1900) / 100;\n\tlow = tm->tm_year % 100;\n\tregs[RTC_YEAR2] = bin2bcd(high);\n\tregs[RTC_YEAR1] = bin2bcd(low);\n\tregs[RTC_MONTH] = bin2bcd(tm->tm_mon + 1);\n\tregs[RTC_DATE] = bin2bcd(tm->tm_mday);\n\tregs[RTC_WEEKDAY] = tm->tm_wday;\n\tregs[RTC_HOUR] = bin2bcd(tm->tm_hour);\n\tregs[RTC_MIN] = bin2bcd(tm->tm_min);\n\tregs[RTC_SEC] = bin2bcd(tm->tm_sec);\n}\n\nstatic int max8907_rtc_read_time(struct device *dev, struct rtc_time *tm)\n{\n\tstruct max8907_rtc *rtc = dev_get_drvdata(dev);\n\tu8 regs[TIME_NUM];\n\tint ret;\n\n\tret = regmap_bulk_read(rtc->regmap, MAX8907_REG_RTC_SEC, regs,\n\t\t\t       TIME_NUM);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tregs_to_tm(regs, tm);\n\n\treturn 0;\n}\n\nstatic int max8907_rtc_set_time(struct device *dev, struct rtc_time *tm)\n{\n\tstruct max8907_rtc *rtc = dev_get_drvdata(dev);\n\tu8 regs[TIME_NUM];\n\n\ttm_to_regs(tm, regs);\n\n\treturn regmap_bulk_write(rtc->regmap, MAX8907_REG_RTC_SEC, regs,\n\t\t\t\t TIME_NUM);\n}\n\nstatic int max8907_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\n{\n\tstruct max8907_rtc *rtc = dev_get_drvdata(dev);\n\tu8 regs[TIME_NUM];\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_bulk_read(rtc->regmap, MAX8907_REG_ALARM0_SEC, regs,\n\t\t\t       TIME_NUM);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tregs_to_tm(regs, &alrm->time);\n\n\tret = regmap_read(rtc->regmap, MAX8907_REG_ALARM0_CNTL, &val);\n\tif (ret < 0)\n\t\treturn ret;\n\n\talrm->enabled = !!(val & 0x7f);\n\n\treturn 0;\n}\n\nstatic int max8907_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\n{\n\tstruct max8907_rtc *rtc = dev_get_drvdata(dev);\n\tu8 regs[TIME_NUM];\n\tint ret;\n\n\ttm_to_regs(&alrm->time, regs);\n\n\t \n\tret = regmap_write(rtc->regmap, MAX8907_REG_ALARM0_CNTL, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_bulk_write(rtc->regmap, MAX8907_REG_ALARM0_SEC, regs,\n\t\t\t\tTIME_NUM);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (alrm->enabled)\n\t\tret = regmap_write(rtc->regmap, MAX8907_REG_ALARM0_CNTL, 0x77);\n\n\treturn ret;\n}\n\nstatic const struct rtc_class_ops max8907_rtc_ops = {\n\t.read_time\t= max8907_rtc_read_time,\n\t.set_time\t= max8907_rtc_set_time,\n\t.read_alarm\t= max8907_rtc_read_alarm,\n\t.set_alarm\t= max8907_rtc_set_alarm,\n};\n\nstatic int max8907_rtc_probe(struct platform_device *pdev)\n{\n\tstruct max8907 *max8907 = dev_get_drvdata(pdev->dev.parent);\n\tstruct max8907_rtc *rtc;\n\tint ret;\n\n\trtc = devm_kzalloc(&pdev->dev, sizeof(*rtc), GFP_KERNEL);\n\tif (!rtc)\n\t\treturn -ENOMEM;\n\tplatform_set_drvdata(pdev, rtc);\n\n\trtc->max8907 = max8907;\n\trtc->regmap = max8907->regmap_rtc;\n\n\trtc->rtc_dev = devm_rtc_device_register(&pdev->dev, \"max8907-rtc\",\n\t\t\t\t\t&max8907_rtc_ops, THIS_MODULE);\n\tif (IS_ERR(rtc->rtc_dev)) {\n\t\tret = PTR_ERR(rtc->rtc_dev);\n\t\tdev_err(&pdev->dev, \"Failed to register RTC device: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\trtc->irq = regmap_irq_get_virq(max8907->irqc_rtc,\n\t\t\t\t       MAX8907_IRQ_RTC_ALARM0);\n\tif (rtc->irq < 0)\n\t\treturn rtc->irq;\n\n\tret = devm_request_threaded_irq(&pdev->dev, rtc->irq, NULL,\n\t\t\t\tmax8907_irq_handler,\n\t\t\t\tIRQF_ONESHOT, \"max8907-alarm0\", rtc);\n\tif (ret < 0)\n\t\tdev_err(&pdev->dev, \"Failed to request IRQ%d: %d\\n\",\n\t\t\trtc->irq, ret);\n\n\treturn ret;\n}\n\nstatic struct platform_driver max8907_rtc_driver = {\n\t.driver = {\n\t\t.name = \"max8907-rtc\",\n\t},\n\t.probe = max8907_rtc_probe,\n};\nmodule_platform_driver(max8907_rtc_driver);\n\nMODULE_DESCRIPTION(\"Maxim MAX8907 RTC driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}