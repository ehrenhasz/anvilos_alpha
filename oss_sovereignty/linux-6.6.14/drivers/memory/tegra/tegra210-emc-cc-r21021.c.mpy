{
  "module_name": "tegra210-emc-cc-r21021.c",
  "hash_id": "6a565b42e3ae2d2eec541339cc7fe5bc1b4a00f5af97e211f8a0470fb8900149",
  "original_prompt": "Ingested from linux-6.6.14/drivers/memory/tegra/tegra210-emc-cc-r21021.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/io.h>\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/of.h>\n\n#include <soc/tegra/mc.h>\n\n#include \"tegra210-emc.h\"\n#include \"tegra210-mc.h\"\n\n \n#define INFO            (1 << 0)\n#define STEPS           (1 << 1)\n#define SUB_STEPS       (1 << 2)\n#define PRELOCK         (1 << 3)\n#define PRELOCK_STEPS   (1 << 4)\n#define ACTIVE_EN       (1 << 5)\n#define PRAMP_UP        (1 << 6)\n#define PRAMP_DN        (1 << 7)\n#define EMA_WRITES      (1 << 10)\n#define EMA_UPDATES     (1 << 11)\n#define PER_TRAIN       (1 << 16)\n#define CC_PRINT        (1 << 17)\n#define CCFIFO          (1 << 29)\n#define REGS            (1 << 30)\n#define REG_LISTS       (1 << 31)\n\n#define emc_dbg(emc, flags, ...) dev_dbg(emc->dev, __VA_ARGS__)\n\n#define DVFS_CLOCK_CHANGE_VERSION\t21021\n#define EMC_PRELOCK_VERSION\t\t2101\n\nenum {\n\tDVFS_SEQUENCE = 1,\n\tWRITE_TRAINING_SEQUENCE = 2,\n\tPERIODIC_TRAINING_SEQUENCE = 3,\n\tDVFS_PT1 = 10,\n\tDVFS_UPDATE = 11,\n\tTRAINING_PT1 = 12,\n\tTRAINING_UPDATE = 13,\n\tPERIODIC_TRAINING_UPDATE = 14\n};\n\n \n#define PTFV_DQSOSC_MOVAVG_C0D0U0_INDEX\t\t0\n#define PTFV_DQSOSC_MOVAVG_C0D0U1_INDEX\t\t1\n#define PTFV_DQSOSC_MOVAVG_C0D1U0_INDEX\t\t2\n#define PTFV_DQSOSC_MOVAVG_C0D1U1_INDEX\t\t3\n#define PTFV_DQSOSC_MOVAVG_C1D0U0_INDEX\t\t4\n#define PTFV_DQSOSC_MOVAVG_C1D0U1_INDEX\t\t5\n#define PTFV_DQSOSC_MOVAVG_C1D1U0_INDEX\t\t6\n#define PTFV_DQSOSC_MOVAVG_C1D1U1_INDEX\t\t7\n#define PTFV_DVFS_SAMPLES_INDEX\t\t\t9\n#define PTFV_MOVAVG_WEIGHT_INDEX\t\t10\n#define PTFV_CONFIG_CTRL_INDEX\t\t\t11\n\n#define PTFV_CONFIG_CTRL_USE_PREVIOUS_EMA\t(1 << 0)\n\n \n#define MOVAVG_PRECISION_FACTOR\t\t100\n\n \n#define __AVERAGE_PTFV(dev)\t\t\t\t\t\t\\\n\t({ next->ptfv_list[PTFV_DQSOSC_MOVAVG_ ## dev ## _INDEX] =\t\\\n\t   next->ptfv_list[PTFV_DQSOSC_MOVAVG_ ## dev ## _INDEX] /\t\\\n\t   next->ptfv_list[PTFV_DVFS_SAMPLES_INDEX]; })\n\n \n#define __INCREMENT_PTFV(dev, val)\t\t\t\t\t\\\n\t({ next->ptfv_list[PTFV_DQSOSC_MOVAVG_ ## dev ## _INDEX] +=\t\\\n\t   ((val) * MOVAVG_PRECISION_FACTOR); })\n\n \n#define __MOVAVG_AC(timing, dev)\t\t\t\t\t\\\n\t((timing)->ptfv_list[PTFV_DQSOSC_MOVAVG_ ## dev ## _INDEX] /\t\\\n\t MOVAVG_PRECISION_FACTOR)\n\n \n#define __WEIGHTED_UPDATE_PTFV(dev, nval)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\tint w = PTFV_MOVAVG_WEIGHT_INDEX;\t\t\t\\\n\t\tint dqs = PTFV_DQSOSC_MOVAVG_ ## dev ## _INDEX;\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t\tnext->ptfv_list[dqs] =\t\t\t\t\t\\\n\t\t\t((nval * MOVAVG_PRECISION_FACTOR) +\t\t\\\n\t\t\t (next->ptfv_list[dqs] *\t\t\t\\\n\t\t\t  next->ptfv_list[w])) /\t\t\t\\\n\t\t\t(next->ptfv_list[w] + 1);\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t\temc_dbg(emc, EMA_UPDATES, \"%s: (s=%lu) EMA: %u\\n\",\t\\\n\t\t\t__stringify(dev), nval, next->ptfv_list[dqs]);\t\\\n\t} while (0)\n\n \n#define __MOVAVG(timing, dev)                      \\\n\t((timing)->ptfv_list[PTFV_DQSOSC_MOVAVG_ ## dev ## _INDEX])\n\nstatic u32 update_clock_tree_delay(struct tegra210_emc *emc, int type)\n{\n\tbool periodic_training_update = type == PERIODIC_TRAINING_UPDATE;\n\tstruct tegra210_emc_timing *last = emc->last;\n\tstruct tegra210_emc_timing *next = emc->next;\n\tu32 last_timing_rate_mhz = last->rate / 1000;\n\tu32 next_timing_rate_mhz = next->rate / 1000;\n\tbool dvfs_update = type == DVFS_UPDATE;\n\ts32 tdel = 0, tmdel = 0, adel = 0;\n\tbool dvfs_pt1 = type == DVFS_PT1;\n\tunsigned long cval = 0;\n\tu32 temp[2][2], value;\n\tunsigned int i;\n\n\t \n\tif (dvfs_pt1 || periodic_training_update) {\n\t\tvalue = tegra210_emc_mrr_read(emc, 2, 19);\n\n\t\tfor (i = 0; i < emc->num_channels; i++) {\n\t\t\ttemp[i][0] = (value & 0x00ff) << 8;\n\t\t\ttemp[i][1] = (value & 0xff00) << 0;\n\t\t\tvalue >>= 16;\n\t\t}\n\n\t\t \n\t\tvalue = tegra210_emc_mrr_read(emc, 2, 18);\n\n\t\tfor (i = 0; i < emc->num_channels; i++) {\n\t\t\ttemp[i][0] |= (value & 0x00ff) >> 0;\n\t\t\ttemp[i][1] |= (value & 0xff00) >> 8;\n\t\t\tvalue >>= 16;\n\t\t}\n\t}\n\n\tif (dvfs_pt1 || periodic_training_update) {\n\t\tcval = tegra210_emc_actual_osc_clocks(last->run_clocks);\n\t\tcval *= 1000000;\n\t\tcval /= last_timing_rate_mhz * 2 * temp[0][0];\n\t}\n\n\tif (dvfs_pt1)\n\t\t__INCREMENT_PTFV(C0D0U0, cval);\n\telse if (dvfs_update)\n\t\t__AVERAGE_PTFV(C0D0U0);\n\telse if (periodic_training_update)\n\t\t__WEIGHTED_UPDATE_PTFV(C0D0U0, cval);\n\n\tif (dvfs_update || periodic_training_update) {\n\t\ttdel = next->current_dram_clktree[C0D0U0] -\n\t\t\t\t__MOVAVG_AC(next, C0D0U0);\n\t\ttmdel = (tdel < 0) ? -1 * tdel : tdel;\n\t\tadel = tmdel;\n\n\t\tif (tmdel * 128 * next_timing_rate_mhz / 1000000 >\n\t\t    next->tree_margin)\n\t\t\tnext->current_dram_clktree[C0D0U0] =\n\t\t\t\t__MOVAVG_AC(next, C0D0U0);\n\t}\n\n\tif (dvfs_pt1 || periodic_training_update) {\n\t\tcval = tegra210_emc_actual_osc_clocks(last->run_clocks);\n\t\tcval *= 1000000;\n\t\tcval /= last_timing_rate_mhz * 2 * temp[0][1];\n\t}\n\n\tif (dvfs_pt1)\n\t\t__INCREMENT_PTFV(C0D0U1, cval);\n\telse if (dvfs_update)\n\t\t__AVERAGE_PTFV(C0D0U1);\n\telse if (periodic_training_update)\n\t\t__WEIGHTED_UPDATE_PTFV(C0D0U1, cval);\n\n\tif (dvfs_update || periodic_training_update) {\n\t\ttdel = next->current_dram_clktree[C0D0U1] -\n\t\t\t\t__MOVAVG_AC(next, C0D0U1);\n\t\ttmdel = (tdel < 0) ? -1 * tdel : tdel;\n\n\t\tif (tmdel > adel)\n\t\t\tadel = tmdel;\n\n\t\tif (tmdel * 128 * next_timing_rate_mhz / 1000000 >\n\t\t    next->tree_margin)\n\t\t\tnext->current_dram_clktree[C0D0U1] =\n\t\t\t\t__MOVAVG_AC(next, C0D0U1);\n\t}\n\n\tif (emc->num_channels > 1) {\n\t\tif (dvfs_pt1 || periodic_training_update) {\n\t\t\tcval = tegra210_emc_actual_osc_clocks(last->run_clocks);\n\t\t\tcval *= 1000000;\n\t\t\tcval /= last_timing_rate_mhz * 2 * temp[1][0];\n\t\t}\n\n\t\tif (dvfs_pt1)\n\t\t\t__INCREMENT_PTFV(C1D0U0, cval);\n\t\telse if (dvfs_update)\n\t\t\t__AVERAGE_PTFV(C1D0U0);\n\t\telse if (periodic_training_update)\n\t\t\t__WEIGHTED_UPDATE_PTFV(C1D0U0, cval);\n\n\t\tif (dvfs_update || periodic_training_update) {\n\t\t\ttdel = next->current_dram_clktree[C1D0U0] -\n\t\t\t\t\t__MOVAVG_AC(next, C1D0U0);\n\t\t\ttmdel = (tdel < 0) ? -1 * tdel : tdel;\n\n\t\t\tif (tmdel > adel)\n\t\t\t\tadel = tmdel;\n\n\t\t\tif (tmdel * 128 * next_timing_rate_mhz / 1000000 >\n\t\t\t    next->tree_margin)\n\t\t\t\tnext->current_dram_clktree[C1D0U0] =\n\t\t\t\t\t__MOVAVG_AC(next, C1D0U0);\n\t\t}\n\n\t\tif (dvfs_pt1 || periodic_training_update) {\n\t\t\tcval = tegra210_emc_actual_osc_clocks(last->run_clocks);\n\t\t\tcval *= 1000000;\n\t\t\tcval /= last_timing_rate_mhz * 2 * temp[1][1];\n\t\t}\n\n\t\tif (dvfs_pt1)\n\t\t\t__INCREMENT_PTFV(C1D0U1, cval);\n\t\telse if (dvfs_update)\n\t\t\t__AVERAGE_PTFV(C1D0U1);\n\t\telse if (periodic_training_update)\n\t\t\t__WEIGHTED_UPDATE_PTFV(C1D0U1, cval);\n\n\t\tif (dvfs_update || periodic_training_update) {\n\t\t\ttdel = next->current_dram_clktree[C1D0U1] -\n\t\t\t\t\t__MOVAVG_AC(next, C1D0U1);\n\t\t\ttmdel = (tdel < 0) ? -1 * tdel : tdel;\n\n\t\t\tif (tmdel > adel)\n\t\t\t\tadel = tmdel;\n\n\t\t\tif (tmdel * 128 * next_timing_rate_mhz / 1000000 >\n\t\t\t    next->tree_margin)\n\t\t\t\tnext->current_dram_clktree[C1D0U1] =\n\t\t\t\t\t__MOVAVG_AC(next, C1D0U1);\n\t\t}\n\t}\n\n\tif (emc->num_devices < 2)\n\t\tgoto done;\n\n\t \n\tif (dvfs_pt1 || periodic_training_update) {\n\t\tvalue = tegra210_emc_mrr_read(emc, 1, 19);\n\n\t\tfor (i = 0; i < emc->num_channels; i++) {\n\t\t\ttemp[i][0] = (value & 0x00ff) << 8;\n\t\t\ttemp[i][1] = (value & 0xff00) << 0;\n\t\t\tvalue >>= 16;\n\t\t}\n\n\t\t \n\t\tvalue = tegra210_emc_mrr_read(emc, 1, 18);\n\n\t\tfor (i = 0; i < emc->num_channels; i++) {\n\t\t\ttemp[i][0] |= (value & 0x00ff) >> 0;\n\t\t\ttemp[i][1] |= (value & 0xff00) >> 8;\n\t\t\tvalue >>= 16;\n\t\t}\n\t}\n\n\tif (dvfs_pt1 || periodic_training_update) {\n\t\tcval = tegra210_emc_actual_osc_clocks(last->run_clocks);\n\t\tcval *= 1000000;\n\t\tcval /= last_timing_rate_mhz * 2 * temp[0][0];\n\t}\n\n\tif (dvfs_pt1)\n\t\t__INCREMENT_PTFV(C0D1U0, cval);\n\telse if (dvfs_update)\n\t\t__AVERAGE_PTFV(C0D1U0);\n\telse if (periodic_training_update)\n\t\t__WEIGHTED_UPDATE_PTFV(C0D1U0, cval);\n\n\tif (dvfs_update || periodic_training_update) {\n\t\ttdel = next->current_dram_clktree[C0D1U0] -\n\t\t\t\t__MOVAVG_AC(next, C0D1U0);\n\t\ttmdel = (tdel < 0) ? -1 * tdel : tdel;\n\n\t\tif (tmdel > adel)\n\t\t\tadel = tmdel;\n\n\t\tif (tmdel * 128 * next_timing_rate_mhz / 1000000 >\n\t\t    next->tree_margin)\n\t\t\tnext->current_dram_clktree[C0D1U0] =\n\t\t\t\t__MOVAVG_AC(next, C0D1U0);\n\t}\n\n\tif (dvfs_pt1 || periodic_training_update) {\n\t\tcval = tegra210_emc_actual_osc_clocks(last->run_clocks);\n\t\tcval *= 1000000;\n\t\tcval /= last_timing_rate_mhz * 2 * temp[0][1];\n\t}\n\n\tif (dvfs_pt1)\n\t\t__INCREMENT_PTFV(C0D1U1, cval);\n\telse if (dvfs_update)\n\t\t__AVERAGE_PTFV(C0D1U1);\n\telse if (periodic_training_update)\n\t\t__WEIGHTED_UPDATE_PTFV(C0D1U1, cval);\n\n\tif (dvfs_update || periodic_training_update) {\n\t\ttdel = next->current_dram_clktree[C0D1U1] -\n\t\t\t\t__MOVAVG_AC(next, C0D1U1);\n\t\ttmdel = (tdel < 0) ? -1 * tdel : tdel;\n\n\t\tif (tmdel > adel)\n\t\t\tadel = tmdel;\n\n\t\tif (tmdel * 128 * next_timing_rate_mhz / 1000000 >\n\t\t    next->tree_margin)\n\t\t\tnext->current_dram_clktree[C0D1U1] =\n\t\t\t\t__MOVAVG_AC(next, C0D1U1);\n\t}\n\n\tif (emc->num_channels > 1) {\n\t\tif (dvfs_pt1 || periodic_training_update) {\n\t\t\tcval = tegra210_emc_actual_osc_clocks(last->run_clocks);\n\t\t\tcval *= 1000000;\n\t\t\tcval /= last_timing_rate_mhz * 2 * temp[1][0];\n\t\t}\n\n\t\tif (dvfs_pt1)\n\t\t\t__INCREMENT_PTFV(C1D1U0, cval);\n\t\telse if (dvfs_update)\n\t\t\t__AVERAGE_PTFV(C1D1U0);\n\t\telse if (periodic_training_update)\n\t\t\t__WEIGHTED_UPDATE_PTFV(C1D1U0, cval);\n\n\t\tif (dvfs_update || periodic_training_update) {\n\t\t\ttdel = next->current_dram_clktree[C1D1U0] -\n\t\t\t\t\t__MOVAVG_AC(next, C1D1U0);\n\t\t\ttmdel = (tdel < 0) ? -1 * tdel : tdel;\n\n\t\t\tif (tmdel > adel)\n\t\t\t\tadel = tmdel;\n\n\t\t\tif (tmdel * 128 * next_timing_rate_mhz / 1000000 >\n\t\t\t    next->tree_margin)\n\t\t\t\tnext->current_dram_clktree[C1D1U0] =\n\t\t\t\t\t__MOVAVG_AC(next, C1D1U0);\n\t\t}\n\n\t\tif (dvfs_pt1 || periodic_training_update) {\n\t\t\tcval = tegra210_emc_actual_osc_clocks(last->run_clocks);\n\t\t\tcval *= 1000000;\n\t\t\tcval /= last_timing_rate_mhz * 2 * temp[1][1];\n\t\t}\n\n\t\tif (dvfs_pt1)\n\t\t\t__INCREMENT_PTFV(C1D1U1, cval);\n\t\telse if (dvfs_update)\n\t\t\t__AVERAGE_PTFV(C1D1U1);\n\t\telse if (periodic_training_update)\n\t\t\t__WEIGHTED_UPDATE_PTFV(C1D1U1, cval);\n\n\t\tif (dvfs_update || periodic_training_update) {\n\t\t\ttdel = next->current_dram_clktree[C1D1U1] -\n\t\t\t\t\t__MOVAVG_AC(next, C1D1U1);\n\t\t\ttmdel = (tdel < 0) ? -1 * tdel : tdel;\n\n\t\t\tif (tmdel > adel)\n\t\t\t\tadel = tmdel;\n\n\t\t\tif (tmdel * 128 * next_timing_rate_mhz / 1000000 >\n\t\t\t    next->tree_margin)\n\t\t\t\tnext->current_dram_clktree[C1D1U1] =\n\t\t\t\t\t__MOVAVG_AC(next, C1D1U1);\n\t\t}\n\t}\n\ndone:\n\treturn adel;\n}\n\nstatic u32 periodic_compensation_handler(struct tegra210_emc *emc, u32 type,\n\t\t\t\t\t struct tegra210_emc_timing *last,\n\t\t\t\t\t struct tegra210_emc_timing *next)\n{\n#define __COPY_EMA(nt, lt, dev)\t\t\t\t\t\t\\\n\t({ __MOVAVG(nt, dev) = __MOVAVG(lt, dev) *\t\t\t\\\n\t   (nt)->ptfv_list[PTFV_DVFS_SAMPLES_INDEX]; })\n\n\tu32 i, adel = 0, samples = next->ptfv_list[PTFV_DVFS_SAMPLES_INDEX];\n\tu32 delay;\n\n\tdelay = tegra210_emc_actual_osc_clocks(last->run_clocks);\n\tdelay *= 1000;\n\tdelay = 2 + (delay / last->rate);\n\n\tif (!next->periodic_training)\n\t\treturn 0;\n\n\tif (type == DVFS_SEQUENCE) {\n\t\tif (last->periodic_training &&\n\t\t    (next->ptfv_list[PTFV_CONFIG_CTRL_INDEX] &\n\t\t     PTFV_CONFIG_CTRL_USE_PREVIOUS_EMA)) {\n\t\t\t \n\t\t\t__COPY_EMA(next, last, C0D0U0);\n\t\t\t__COPY_EMA(next, last, C0D0U1);\n\t\t\t__COPY_EMA(next, last, C1D0U0);\n\t\t\t__COPY_EMA(next, last, C1D0U1);\n\t\t\t__COPY_EMA(next, last, C0D1U0);\n\t\t\t__COPY_EMA(next, last, C0D1U1);\n\t\t\t__COPY_EMA(next, last, C1D1U0);\n\t\t\t__COPY_EMA(next, last, C1D1U1);\n\t\t} else {\n\t\t\t \n\t\t\t__MOVAVG(next, C0D0U0) = 0;\n\t\t\t__MOVAVG(next, C0D0U1) = 0;\n\t\t\t__MOVAVG(next, C1D0U0) = 0;\n\t\t\t__MOVAVG(next, C1D0U1) = 0;\n\t\t\t__MOVAVG(next, C0D1U0) = 0;\n\t\t\t__MOVAVG(next, C0D1U1) = 0;\n\t\t\t__MOVAVG(next, C1D1U0) = 0;\n\t\t\t__MOVAVG(next, C1D1U1) = 0;\n\n\t\t\tfor (i = 0; i < samples; i++) {\n\t\t\t\ttegra210_emc_start_periodic_compensation(emc);\n\t\t\t\tudelay(delay);\n\n\t\t\t\t \n\t\t\t\tadel = update_clock_tree_delay(emc, DVFS_PT1);\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tadel = update_clock_tree_delay(emc, DVFS_UPDATE);\n\t}\n\n\tif (type == PERIODIC_TRAINING_SEQUENCE) {\n\t\ttegra210_emc_start_periodic_compensation(emc);\n\t\tudelay(delay);\n\n\t\tadel = update_clock_tree_delay(emc, PERIODIC_TRAINING_UPDATE);\n\t}\n\n\treturn adel;\n}\n\nstatic u32 tegra210_emc_r21021_periodic_compensation(struct tegra210_emc *emc)\n{\n\tu32 emc_cfg, emc_cfg_o, emc_cfg_update, del, value;\n\tstatic const u32 list[] = {\n\t\tEMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_0,\n\t\tEMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_1,\n\t\tEMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_2,\n\t\tEMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_3,\n\t\tEMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_0,\n\t\tEMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_1,\n\t\tEMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_2,\n\t\tEMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_3,\n\t\tEMC_DATA_BRLSHFT_0,\n\t\tEMC_DATA_BRLSHFT_1\n\t};\n\tstruct tegra210_emc_timing *last = emc->last;\n\tunsigned int items = ARRAY_SIZE(list), i;\n\tunsigned long delay;\n\n\tif (last->periodic_training) {\n\t\temc_dbg(emc, PER_TRAIN, \"Periodic training starting\\n\");\n\n\t\tvalue = emc_readl(emc, EMC_DBG);\n\t\temc_cfg_o = emc_readl(emc, EMC_CFG);\n\t\temc_cfg = emc_cfg_o & ~(EMC_CFG_DYN_SELF_REF |\n\t\t\t\t\tEMC_CFG_DRAM_ACPD |\n\t\t\t\t\tEMC_CFG_DRAM_CLKSTOP_PD);\n\n\n\t\t \n\t\temc_writel(emc, emc_cfg, EMC_CFG);\n\n\t\t \n\t\ttegra210_emc_dll_disable(emc);\n\n\t\tfor (i = 0; i < emc->num_channels; i++)\n\t\t\ttegra210_emc_wait_for_update(emc, i, EMC_EMC_STATUS,\n\t\t\t\t\t\t     EMC_EMC_STATUS_DRAM_IN_POWERDOWN_MASK,\n\t\t\t\t\t\t     0);\n\n\t\tfor (i = 0; i < emc->num_channels; i++)\n\t\t\ttegra210_emc_wait_for_update(emc, i, EMC_EMC_STATUS,\n\t\t\t\t\t\t     EMC_EMC_STATUS_DRAM_IN_SELF_REFRESH_MASK,\n\t\t\t\t\t\t     0);\n\n\t\temc_cfg_update = value = emc_readl(emc, EMC_CFG_UPDATE);\n\t\tvalue &= ~EMC_CFG_UPDATE_UPDATE_DLL_IN_UPDATE_MASK;\n\t\tvalue |= (2 << EMC_CFG_UPDATE_UPDATE_DLL_IN_UPDATE_SHIFT);\n\t\temc_writel(emc, value, EMC_CFG_UPDATE);\n\n\t\t \n\t\ttegra210_emc_start_periodic_compensation(emc);\n\n\t\t \n\t\tdelay = tegra210_emc_actual_osc_clocks(last->run_clocks);\n\t\tdelay *= 1000;\n\t\tdelay /= last->rate + 1;\n\t\tudelay(delay);\n\n\t\t \n\t\tdel = periodic_compensation_handler(emc,\n\t\t\t\t\t\t    PERIODIC_TRAINING_SEQUENCE,\n\t\t\t\t\t\t    last, last);\n\n\t\t \n\t\tif (last->tree_margin < ((del * 128 * (last->rate / 1000)) / 1000000)) {\n\t\t\tfor (i = 0; i < items; i++) {\n\t\t\t\tvalue = tegra210_emc_compensate(last, list[i]);\n\t\t\t\temc_dbg(emc, EMA_WRITES, \"0x%08x <= 0x%08x\\n\",\n\t\t\t\t\tlist[i], value);\n\t\t\t\temc_writel(emc, value, list[i]);\n\t\t\t}\n\t\t}\n\n\t\temc_writel(emc, emc_cfg_o, EMC_CFG);\n\n\t\t \n\t\ttegra210_emc_timing_update(emc);\n\n\t\t \n\t\temc_writel(emc, emc_cfg_update, EMC_CFG_UPDATE);\n\n\t\t \n\t\ttegra210_emc_dll_enable(emc);\n\t}\n\n\treturn 0;\n}\n\n \nstatic void tegra210_emc_r21021_set_clock(struct tegra210_emc *emc, u32 clksrc)\n{\n\t \n\tstatic bool fsp_for_next_freq;\n\t \n\tconst bool save_restore_clkstop_pd = true;\n\tconst u32 zqcal_before_cc_cutoff = 2400;\n\tconst bool cya_allow_ref_cc = false;\n\tconst bool cya_issue_pc_ref = false;\n\tconst bool opt_cc_short_zcal = true;\n\tconst bool ref_b4_sref_en = false;\n\tconst u32 tZQCAL_lpddr4 = 1000000;\n\tconst bool opt_short_zcal = true;\n\tconst bool opt_do_sw_qrst = true;\n\tconst u32 opt_dvfs_mode = MAN_SR;\n\t \n\tstruct tegra210_emc_timing *fake, *last = emc->last, *next = emc->next;\n\tu32 tRTM, RP_war, R2P_war, TRPab_war, deltaTWATM, W2P_war, tRPST;\n\tu32 mr13_flip_fspwr, mr13_flip_fspop, ramp_up_wait, ramp_down_wait;\n\tu32 zq_wait_long, zq_latch_dvfs_wait_time, tZQCAL_lpddr4_fc_adj;\n\tu32 emc_auto_cal_config, auto_cal_en, emc_cfg, emc_sel_dpd_ctrl;\n\tu32 tFC_lpddr4 = 1000 * next->dram_timings[T_FC_LPDDR4];\n\tu32 bg_reg_mode_change, enable_bglp_reg, enable_bg_reg;\n\tbool opt_zcal_en_cc = false, is_lpddr3 = false;\n\tbool compensate_trimmer_applicable = false;\n\tu32 emc_dbg, emc_cfg_pipe_clk, emc_pin;\n\tu32 src_clk_period, dst_clk_period;  \n\tbool shared_zq_resistor = false;\n\tu32 value, dram_type;\n\tu32 opt_dll_mode = 0;\n\tunsigned long delay;\n\tunsigned int i;\n\n\temc_dbg(emc, INFO, \"Running clock change.\\n\");\n\n\t \n\tfake = tegra210_emc_find_timing(emc, last->rate * 1000UL);\n\tfsp_for_next_freq = !fsp_for_next_freq;\n\n\tvalue = emc_readl(emc, EMC_FBIO_CFG5) & EMC_FBIO_CFG5_DRAM_TYPE_MASK;\n\tdram_type = value >> EMC_FBIO_CFG5_DRAM_TYPE_SHIFT;\n\n\tif (last->burst_regs[EMC_ZCAL_WAIT_CNT_INDEX] & BIT(31))\n\t\tshared_zq_resistor = true;\n\n\tif ((next->burst_regs[EMC_ZCAL_INTERVAL_INDEX] != 0 &&\n\t     last->burst_regs[EMC_ZCAL_INTERVAL_INDEX] == 0) ||\n\t    dram_type == DRAM_TYPE_LPDDR4)\n\t\topt_zcal_en_cc = true;\n\n\tif (dram_type == DRAM_TYPE_DDR3)\n\t\topt_dll_mode = tegra210_emc_get_dll_state(next);\n\n\tif ((next->burst_regs[EMC_FBIO_CFG5_INDEX] & BIT(25)) &&\n\t    (dram_type == DRAM_TYPE_LPDDR2))\n\t\tis_lpddr3 = true;\n\n\temc_readl(emc, EMC_CFG);\n\temc_readl(emc, EMC_AUTO_CAL_CONFIG);\n\n\tsrc_clk_period = 1000000000 / last->rate;\n\tdst_clk_period = 1000000000 / next->rate;\n\n\tif (dst_clk_period <= zqcal_before_cc_cutoff)\n\t\ttZQCAL_lpddr4_fc_adj = tZQCAL_lpddr4 - tFC_lpddr4;\n\telse\n\t\ttZQCAL_lpddr4_fc_adj = tZQCAL_lpddr4;\n\n\ttZQCAL_lpddr4_fc_adj /= dst_clk_period;\n\n\temc_dbg = emc_readl(emc, EMC_DBG);\n\temc_pin = emc_readl(emc, EMC_PIN);\n\temc_cfg_pipe_clk = emc_readl(emc, EMC_CFG_PIPE_CLK);\n\n\temc_cfg = next->burst_regs[EMC_CFG_INDEX];\n\temc_cfg &= ~(EMC_CFG_DYN_SELF_REF | EMC_CFG_DRAM_ACPD |\n\t\t     EMC_CFG_DRAM_CLKSTOP_SR | EMC_CFG_DRAM_CLKSTOP_PD);\n\temc_sel_dpd_ctrl = next->emc_sel_dpd_ctrl;\n\temc_sel_dpd_ctrl &= ~(EMC_SEL_DPD_CTRL_CLK_SEL_DPD_EN |\n\t\t\t      EMC_SEL_DPD_CTRL_CA_SEL_DPD_EN |\n\t\t\t      EMC_SEL_DPD_CTRL_RESET_SEL_DPD_EN |\n\t\t\t      EMC_SEL_DPD_CTRL_ODT_SEL_DPD_EN |\n\t\t\t      EMC_SEL_DPD_CTRL_DATA_SEL_DPD_EN);\n\n\temc_dbg(emc, INFO, \"Clock change version: %d\\n\",\n\t\tDVFS_CLOCK_CHANGE_VERSION);\n\temc_dbg(emc, INFO, \"DRAM type = %d\\n\", dram_type);\n\temc_dbg(emc, INFO, \"DRAM dev #: %u\\n\", emc->num_devices);\n\temc_dbg(emc, INFO, \"Next EMC clksrc: 0x%08x\\n\", clksrc);\n\temc_dbg(emc, INFO, \"DLL clksrc:      0x%08x\\n\", next->dll_clk_src);\n\temc_dbg(emc, INFO, \"last rate: %u, next rate %u\\n\", last->rate,\n\t\tnext->rate);\n\temc_dbg(emc, INFO, \"last period: %u, next period: %u\\n\",\n\t\tsrc_clk_period, dst_clk_period);\n\temc_dbg(emc, INFO, \"  shared_zq_resistor: %d\\n\", !!shared_zq_resistor);\n\temc_dbg(emc, INFO, \"  num_channels: %u\\n\", emc->num_channels);\n\temc_dbg(emc, INFO, \"  opt_dll_mode: %d\\n\", opt_dll_mode);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 1\\n\");\n\temc_dbg(emc, STEPS, \"Step 1.1: Disable DLL temporarily.\\n\");\n\n\tvalue = emc_readl(emc, EMC_CFG_DIG_DLL);\n\tvalue &= ~EMC_CFG_DIG_DLL_CFG_DLL_EN;\n\temc_writel(emc, value, EMC_CFG_DIG_DLL);\n\n\ttegra210_emc_timing_update(emc);\n\n\tfor (i = 0; i < emc->num_channels; i++)\n\t\ttegra210_emc_wait_for_update(emc, i, EMC_CFG_DIG_DLL,\n\t\t\t\t\t     EMC_CFG_DIG_DLL_CFG_DLL_EN, 0);\n\n\temc_dbg(emc, STEPS, \"Step 1.2: Disable AUTOCAL temporarily.\\n\");\n\n\temc_auto_cal_config = next->emc_auto_cal_config;\n\tauto_cal_en = emc_auto_cal_config & EMC_AUTO_CAL_CONFIG_AUTO_CAL_ENABLE;\n\temc_auto_cal_config &= ~EMC_AUTO_CAL_CONFIG_AUTO_CAL_START;\n\temc_auto_cal_config |= EMC_AUTO_CAL_CONFIG_AUTO_CAL_MEASURE_STALL;\n\temc_auto_cal_config |= EMC_AUTO_CAL_CONFIG_AUTO_CAL_UPDATE_STALL;\n\temc_auto_cal_config |= auto_cal_en;\n\temc_writel(emc, emc_auto_cal_config, EMC_AUTO_CAL_CONFIG);\n\temc_readl(emc, EMC_AUTO_CAL_CONFIG);  \n\n\temc_dbg(emc, STEPS, \"Step 1.3: Disable other power features.\\n\");\n\n\ttegra210_emc_set_shadow_bypass(emc, ACTIVE);\n\temc_writel(emc, emc_cfg, EMC_CFG);\n\temc_writel(emc, emc_sel_dpd_ctrl, EMC_SEL_DPD_CTRL);\n\ttegra210_emc_set_shadow_bypass(emc, ASSEMBLY);\n\n\tif (next->periodic_training) {\n\t\ttegra210_emc_reset_dram_clktree_values(next);\n\n\t\tfor (i = 0; i < emc->num_channels; i++)\n\t\t\ttegra210_emc_wait_for_update(emc, i, EMC_EMC_STATUS,\n\t\t\t\t\t\t     EMC_EMC_STATUS_DRAM_IN_POWERDOWN_MASK,\n\t\t\t\t\t\t     0);\n\n\t\tfor (i = 0; i < emc->num_channels; i++)\n\t\t\ttegra210_emc_wait_for_update(emc, i, EMC_EMC_STATUS,\n\t\t\t\t\t\t     EMC_EMC_STATUS_DRAM_IN_SELF_REFRESH_MASK,\n\t\t\t\t\t\t     0);\n\n\t\ttegra210_emc_start_periodic_compensation(emc);\n\n\t\tdelay = 1000 * tegra210_emc_actual_osc_clocks(last->run_clocks);\n\t\tudelay((delay / last->rate) + 2);\n\n\t\tvalue = periodic_compensation_handler(emc, DVFS_SEQUENCE, fake,\n\t\t\t\t\t\t      next);\n\t\tvalue = (value * 128 * next->rate / 1000) / 1000000;\n\n\t\tif (next->periodic_training && value > next->tree_margin)\n\t\t\tcompensate_trimmer_applicable = true;\n\t}\n\n\temc_writel(emc, EMC_INTSTATUS_CLKCHANGE_COMPLETE, EMC_INTSTATUS);\n\ttegra210_emc_set_shadow_bypass(emc, ACTIVE);\n\temc_writel(emc, emc_cfg, EMC_CFG);\n\temc_writel(emc, emc_sel_dpd_ctrl, EMC_SEL_DPD_CTRL);\n\temc_writel(emc, emc_cfg_pipe_clk | EMC_CFG_PIPE_CLK_CLK_ALWAYS_ON,\n\t\t   EMC_CFG_PIPE_CLK);\n\temc_writel(emc, next->emc_fdpd_ctrl_cmd_no_ramp &\n\t\t\t~EMC_FDPD_CTRL_CMD_NO_RAMP_CMD_DPD_NO_RAMP_ENABLE,\n\t\t   EMC_FDPD_CTRL_CMD_NO_RAMP);\n\n\tbg_reg_mode_change =\n\t\t((next->burst_regs[EMC_PMACRO_BG_BIAS_CTRL_0_INDEX] &\n\t\t  EMC_PMACRO_BG_BIAS_CTRL_0_BGLP_E_PWRD) ^\n\t\t (last->burst_regs[EMC_PMACRO_BG_BIAS_CTRL_0_INDEX] &\n\t\t  EMC_PMACRO_BG_BIAS_CTRL_0_BGLP_E_PWRD)) ||\n\t\t((next->burst_regs[EMC_PMACRO_BG_BIAS_CTRL_0_INDEX] &\n\t\t  EMC_PMACRO_BG_BIAS_CTRL_0_BG_E_PWRD) ^\n\t\t (last->burst_regs[EMC_PMACRO_BG_BIAS_CTRL_0_INDEX] &\n\t\t  EMC_PMACRO_BG_BIAS_CTRL_0_BG_E_PWRD));\n\tenable_bglp_reg =\n\t\t(next->burst_regs[EMC_PMACRO_BG_BIAS_CTRL_0_INDEX] &\n\t\t EMC_PMACRO_BG_BIAS_CTRL_0_BGLP_E_PWRD) == 0;\n\tenable_bg_reg =\n\t\t(next->burst_regs[EMC_PMACRO_BG_BIAS_CTRL_0_INDEX] &\n\t\t EMC_PMACRO_BG_BIAS_CTRL_0_BG_E_PWRD) == 0;\n\n\tif (bg_reg_mode_change) {\n\t\tif (enable_bg_reg)\n\t\t\temc_writel(emc, last->burst_regs\n\t\t\t\t   [EMC_PMACRO_BG_BIAS_CTRL_0_INDEX] &\n\t\t\t\t   ~EMC_PMACRO_BG_BIAS_CTRL_0_BG_E_PWRD,\n\t\t\t\t   EMC_PMACRO_BG_BIAS_CTRL_0);\n\n\t\tif (enable_bglp_reg)\n\t\t\temc_writel(emc, last->burst_regs\n\t\t\t\t   [EMC_PMACRO_BG_BIAS_CTRL_0_INDEX] &\n\t\t\t\t   ~EMC_PMACRO_BG_BIAS_CTRL_0_BGLP_E_PWRD,\n\t\t\t\t   EMC_PMACRO_BG_BIAS_CTRL_0);\n\t}\n\n\t \n\tif ((((last->burst_regs[EMC_PMACRO_DATA_PAD_TX_CTRL_INDEX] &\n\t       EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQ_E_IVREF) == 0) &&\n\t     ((next->burst_regs[EMC_PMACRO_DATA_PAD_TX_CTRL_INDEX] &\n\t       EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQ_E_IVREF) == 1)) ||\n\t    (((last->burst_regs[EMC_PMACRO_DATA_PAD_TX_CTRL_INDEX] &\n\t       EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQS_E_IVREF) == 0) &&\n\t     ((next->burst_regs[EMC_PMACRO_DATA_PAD_TX_CTRL_INDEX] &\n\t       EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQS_E_IVREF) != 0))) {\n\t\tu32 pad_tx_ctrl =\n\t\t    next->burst_regs[EMC_PMACRO_DATA_PAD_TX_CTRL_INDEX];\n\t\tu32 last_pad_tx_ctrl =\n\t\t    last->burst_regs[EMC_PMACRO_DATA_PAD_TX_CTRL_INDEX];\n\t\tu32 next_dq_e_ivref, next_dqs_e_ivref;\n\n\t\tnext_dqs_e_ivref = pad_tx_ctrl &\n\t\t\t\t   EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQS_E_IVREF;\n\t\tnext_dq_e_ivref = pad_tx_ctrl &\n\t\t\t\t  EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQ_E_IVREF;\n\t\tvalue = (last_pad_tx_ctrl &\n\t\t\t\t~EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQ_E_IVREF &\n\t\t\t\t~EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQS_E_IVREF) |\n\t\t\tnext_dq_e_ivref | next_dqs_e_ivref;\n\t\temc_writel(emc, value, EMC_PMACRO_DATA_PAD_TX_CTRL);\n\t\tudelay(1);\n\t} else if (bg_reg_mode_change) {\n\t\tudelay(1);\n\t}\n\n\ttegra210_emc_set_shadow_bypass(emc, ASSEMBLY);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 2\\n\");\n\n\tif (next->burst_regs[EMC_CFG_DIG_DLL_INDEX] &\n\t    EMC_CFG_DIG_DLL_CFG_DLL_EN) {\n\t\temc_dbg(emc, INFO, \"Prelock enabled for target frequency.\\n\");\n\t\tvalue = tegra210_emc_dll_prelock(emc, clksrc);\n\t\temc_dbg(emc, INFO, \"DLL out: 0x%03x\\n\", value);\n\t} else {\n\t\temc_dbg(emc, INFO, \"Disabling DLL for target frequency.\\n\");\n\t\ttegra210_emc_dll_disable(emc);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 3\\n\");\n\n\ttegra210_emc_set_shadow_bypass(emc, ACTIVE);\n\temc_writel(emc, next->emc_auto_cal_config2, EMC_AUTO_CAL_CONFIG2);\n\temc_writel(emc, next->emc_auto_cal_config3, EMC_AUTO_CAL_CONFIG3);\n\temc_writel(emc, next->emc_auto_cal_config4, EMC_AUTO_CAL_CONFIG4);\n\temc_writel(emc, next->emc_auto_cal_config5, EMC_AUTO_CAL_CONFIG5);\n\temc_writel(emc, next->emc_auto_cal_config6, EMC_AUTO_CAL_CONFIG6);\n\temc_writel(emc, next->emc_auto_cal_config7, EMC_AUTO_CAL_CONFIG7);\n\temc_writel(emc, next->emc_auto_cal_config8, EMC_AUTO_CAL_CONFIG8);\n\ttegra210_emc_set_shadow_bypass(emc, ASSEMBLY);\n\n\temc_auto_cal_config |= (EMC_AUTO_CAL_CONFIG_AUTO_CAL_COMPUTE_START |\n\t\t\t\tauto_cal_en);\n\temc_writel(emc, emc_auto_cal_config, EMC_AUTO_CAL_CONFIG);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 4\\n\");\n\n\tif (src_clk_period > 50000 && dram_type == DRAM_TYPE_LPDDR4)\n\t\tccfifo_writel(emc, 1, EMC_SELF_REF, 0);\n\telse\n\t\temc_writel(emc, next->emc_cfg_2, EMC_CFG_2);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 5\\n\");\n\n\tif (dram_type == DRAM_TYPE_LPDDR4)\n\t\tzq_wait_long = max((u32)1, div_o3(1000000, dst_clk_period));\n\telse if (dram_type == DRAM_TYPE_LPDDR2 || is_lpddr3)\n\t\tzq_wait_long = max(next->min_mrs_wait,\n\t\t\t\t   div_o3(360000, dst_clk_period)) + 4;\n\telse if (dram_type == DRAM_TYPE_DDR3)\n\t\tzq_wait_long = max((u32)256,\n\t\t\t\t   div_o3(320000, dst_clk_period) + 2);\n\telse\n\t\tzq_wait_long = 0;\n\n\t \n\temc_dbg(emc, STEPS, \"Step 6\\n\");\n\n\t \n\temc_dbg(emc, STEPS, \"Step 7\\n\");\n\temc_dbg(emc, SUB_STEPS, \"Step 7.1: Bug 200024907 - Patch RP R2P\");\n\n\t \n\tif (dram_type == DRAM_TYPE_LPDDR4) {\n\t\tu32 nRTP = 16;\n\n\t\tif (src_clk_period >= 1000000 / 1866)  \n\t\t\tnRTP = 14;\n\n\t\tif (src_clk_period >= 1000000 / 1600)  \n\t\t\tnRTP = 12;\n\n\t\tif (src_clk_period >= 1000000 / 1333)  \n\t\t\tnRTP = 10;\n\n\t\tif (src_clk_period >= 1000000 / 1066)  \n\t\t\tnRTP = 8;\n\n\t\tdeltaTWATM = max_t(u32, div_o3(7500, src_clk_period), 8);\n\n\t\t \n\t\ttRPST = (last->emc_mrw & 0x80) >> 7;\n\t\ttRTM = fake->dram_timings[RL] + div_o3(3600, src_clk_period) +\n\t\t\tmax_t(u32, div_o3(7500, src_clk_period), 8) + tRPST +\n\t\t\t1 + nRTP;\n\n\t\temc_dbg(emc, INFO, \"tRTM = %u, EMC_RP = %u\\n\", tRTM,\n\t\t\tnext->burst_regs[EMC_RP_INDEX]);\n\n\t\tif (last->burst_regs[EMC_RP_INDEX] < tRTM) {\n\t\t\tif (tRTM > (last->burst_regs[EMC_R2P_INDEX] +\n\t\t\t\t    last->burst_regs[EMC_RP_INDEX])) {\n\t\t\t\tR2P_war = tRTM - last->burst_regs[EMC_RP_INDEX];\n\t\t\t\tRP_war = last->burst_regs[EMC_RP_INDEX];\n\t\t\t\tTRPab_war = last->burst_regs[EMC_TRPAB_INDEX];\n\n\t\t\t\tif (R2P_war > 63) {\n\t\t\t\t\tRP_war = R2P_war +\n\t\t\t\t\t\t last->burst_regs[EMC_RP_INDEX] - 63;\n\n\t\t\t\t\tif (TRPab_war < RP_war)\n\t\t\t\t\t\tTRPab_war = RP_war;\n\n\t\t\t\t\tR2P_war = 63;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tR2P_war = last->burst_regs[EMC_R2P_INDEX];\n\t\t\t\tRP_war = last->burst_regs[EMC_RP_INDEX];\n\t\t\t\tTRPab_war = last->burst_regs[EMC_TRPAB_INDEX];\n\t\t\t}\n\n\t\t\tif (RP_war < deltaTWATM) {\n\t\t\t\tW2P_war = last->burst_regs[EMC_W2P_INDEX]\n\t\t\t\t\t  + deltaTWATM - RP_war;\n\t\t\t\tif (W2P_war > 63) {\n\t\t\t\t\tRP_war = RP_war + W2P_war - 63;\n\t\t\t\t\tif (TRPab_war < RP_war)\n\t\t\t\t\t\tTRPab_war = RP_war;\n\t\t\t\t\tW2P_war = 63;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tW2P_war = last->burst_regs[\n\t\t\t\t\t  EMC_W2P_INDEX];\n\t\t\t}\n\n\t\t\tif ((last->burst_regs[EMC_W2P_INDEX] ^ W2P_war) ||\n\t\t\t    (last->burst_regs[EMC_R2P_INDEX] ^ R2P_war) ||\n\t\t\t    (last->burst_regs[EMC_RP_INDEX] ^ RP_war) ||\n\t\t\t    (last->burst_regs[EMC_TRPAB_INDEX] ^ TRPab_war)) {\n\t\t\t\temc_writel(emc, RP_war, EMC_RP);\n\t\t\t\temc_writel(emc, R2P_war, EMC_R2P);\n\t\t\t\temc_writel(emc, W2P_war, EMC_W2P);\n\t\t\t\temc_writel(emc, TRPab_war, EMC_TRPAB);\n\t\t\t}\n\n\t\t\ttegra210_emc_timing_update(emc);\n\t\t} else {\n\t\t\temc_dbg(emc, INFO, \"Skipped WAR\\n\");\n\t\t}\n\t}\n\n\tif (!fsp_for_next_freq) {\n\t\tmr13_flip_fspwr = (next->emc_mrw3 & 0xffffff3f) | 0x80;\n\t\tmr13_flip_fspop = (next->emc_mrw3 & 0xffffff3f) | 0x00;\n\t} else {\n\t\tmr13_flip_fspwr = (next->emc_mrw3 & 0xffffff3f) | 0x40;\n\t\tmr13_flip_fspop = (next->emc_mrw3 & 0xffffff3f) | 0xc0;\n\t}\n\n\tif (dram_type == DRAM_TYPE_LPDDR4) {\n\t\temc_writel(emc, mr13_flip_fspwr, EMC_MRW3);\n\t\temc_writel(emc, next->emc_mrw, EMC_MRW);\n\t\temc_writel(emc, next->emc_mrw2, EMC_MRW2);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 8\\n\");\n\temc_dbg(emc, SUB_STEPS, \"Writing burst_regs\\n\");\n\n\tfor (i = 0; i < next->num_burst; i++) {\n\t\tconst u16 *offsets = emc->offsets->burst;\n\t\tu16 offset;\n\n\t\tif (!offsets[i])\n\t\t\tcontinue;\n\n\t\tvalue = next->burst_regs[i];\n\t\toffset = offsets[i];\n\n\t\tif (dram_type != DRAM_TYPE_LPDDR4 &&\n\t\t    (offset == EMC_MRW6 || offset == EMC_MRW7 ||\n\t\t     offset == EMC_MRW8 || offset == EMC_MRW9 ||\n\t\t     offset == EMC_MRW10 || offset == EMC_MRW11 ||\n\t\t     offset == EMC_MRW12 || offset == EMC_MRW13 ||\n\t\t     offset == EMC_MRW14 || offset == EMC_MRW15 ||\n\t\t     offset == EMC_TRAINING_CTRL))\n\t\t\tcontinue;\n\n\t\t \n\t\tif (offset == EMC_CFG) {\n\t\t\tvalue &= ~EMC_CFG_DRAM_ACPD;\n\t\t\tvalue &= ~EMC_CFG_DYN_SELF_REF;\n\n\t\t\tif (dram_type == DRAM_TYPE_LPDDR4) {\n\t\t\t\tvalue &= ~EMC_CFG_DRAM_CLKSTOP_SR;\n\t\t\t\tvalue &= ~EMC_CFG_DRAM_CLKSTOP_PD;\n\t\t\t}\n\t\t} else if (offset == EMC_MRS_WAIT_CNT &&\n\t\t\t   dram_type == DRAM_TYPE_LPDDR2 &&\n\t\t\t   opt_zcal_en_cc && !opt_cc_short_zcal &&\n\t\t\t   opt_short_zcal) {\n\t\t\tvalue = (value & ~(EMC_MRS_WAIT_CNT_SHORT_WAIT_MASK <<\n\t\t\t\t\t   EMC_MRS_WAIT_CNT_SHORT_WAIT_SHIFT)) |\n\t\t\t\t((zq_wait_long & EMC_MRS_WAIT_CNT_SHORT_WAIT_MASK) <<\n\t\t\t\t\t\t EMC_MRS_WAIT_CNT_SHORT_WAIT_SHIFT);\n\t\t} else if (offset == EMC_ZCAL_WAIT_CNT &&\n\t\t\t   dram_type == DRAM_TYPE_DDR3 && opt_zcal_en_cc &&\n\t\t\t   !opt_cc_short_zcal && opt_short_zcal) {\n\t\t\tvalue = (value & ~(EMC_ZCAL_WAIT_CNT_ZCAL_WAIT_CNT_MASK <<\n\t\t\t\t\t   EMC_ZCAL_WAIT_CNT_ZCAL_WAIT_CNT_SHIFT)) |\n\t\t\t\t((zq_wait_long & EMC_ZCAL_WAIT_CNT_ZCAL_WAIT_CNT_MASK) <<\n\t\t\t\t\t\t EMC_MRS_WAIT_CNT_SHORT_WAIT_SHIFT);\n\t\t} else if (offset == EMC_ZCAL_INTERVAL && opt_zcal_en_cc) {\n\t\t\tvalue = 0;  \n\t\t} else if (offset == EMC_PMACRO_AUTOCAL_CFG_COMMON) {\n\t\t\tvalue |= EMC_PMACRO_AUTOCAL_CFG_COMMON_E_CAL_BYPASS_DVFS;\n\t\t} else if (offset == EMC_PMACRO_DATA_PAD_TX_CTRL) {\n\t\t\tvalue &= ~(EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQSP_TX_E_DCC |\n\t\t\t\t   EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQSN_TX_E_DCC |\n\t\t\t\t   EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_DQ_TX_E_DCC |\n\t\t\t\t   EMC_PMACRO_DATA_PAD_TX_CTRL_DATA_CMD_TX_E_DCC);\n\t\t} else if (offset == EMC_PMACRO_CMD_PAD_TX_CTRL) {\n\t\t\tvalue |= EMC_PMACRO_CMD_PAD_TX_CTRL_CMD_DQ_TX_DRVFORCEON;\n\t\t\tvalue &= ~(EMC_PMACRO_CMD_PAD_TX_CTRL_CMD_DQSP_TX_E_DCC |\n\t\t\t\t   EMC_PMACRO_CMD_PAD_TX_CTRL_CMD_DQSN_TX_E_DCC |\n\t\t\t\t   EMC_PMACRO_CMD_PAD_TX_CTRL_CMD_DQ_TX_E_DCC |\n\t\t\t\t   EMC_PMACRO_CMD_PAD_TX_CTRL_CMD_CMD_TX_E_DCC);\n\t\t} else if (offset == EMC_PMACRO_BRICK_CTRL_RFU1) {\n\t\t\tvalue &= 0xf800f800;\n\t\t} else if (offset == EMC_PMACRO_COMMON_PAD_TX_CTRL) {\n\t\t\tvalue &= 0xfffffff0;\n\t\t}\n\n\t\temc_writel(emc, value, offset);\n\t}\n\n\t \n\ttegra210_emc_adjust_timing(emc, next);\n\n\tif (dram_type == DRAM_TYPE_LPDDR4) {\n\t\tvalue = (23 << EMC_MRW_MRW_MA_SHIFT) |\n\t\t\t(next->run_clocks & EMC_MRW_MRW_OP_MASK);\n\t\temc_writel(emc, value, EMC_MRW);\n\t}\n\n\t \n\temc_dbg(emc, SUB_STEPS, \"Writing burst_regs_per_ch\\n\");\n\n\tfor (i = 0; i < next->num_burst_per_ch; i++) {\n\t\tconst struct tegra210_emc_per_channel_regs *burst =\n\t\t\t\temc->offsets->burst_per_channel;\n\n\t\tif (!burst[i].offset)\n\t\t\tcontinue;\n\n\t\tif (dram_type != DRAM_TYPE_LPDDR4 &&\n\t\t    (burst[i].offset == EMC_MRW6 ||\n\t\t     burst[i].offset == EMC_MRW7 ||\n\t\t     burst[i].offset == EMC_MRW8 ||\n\t\t     burst[i].offset == EMC_MRW9 ||\n\t\t     burst[i].offset == EMC_MRW10 ||\n\t\t     burst[i].offset == EMC_MRW11 ||\n\t\t     burst[i].offset == EMC_MRW12 ||\n\t\t     burst[i].offset == EMC_MRW13 ||\n\t\t     burst[i].offset == EMC_MRW14 ||\n\t\t     burst[i].offset == EMC_MRW15))\n\t\t\tcontinue;\n\n\t\t \n\t\tif (emc->num_channels < 2 && burst[i].bank >= 1)\n\t\t\tcontinue;\n\n\t\temc_dbg(emc, REG_LISTS, \"(%u) 0x%08x => 0x%08x\\n\", i,\n\t\t\tnext->burst_reg_per_ch[i], burst[i].offset);\n\t\temc_channel_writel(emc, burst[i].bank,\n\t\t\t\t   next->burst_reg_per_ch[i],\n\t\t\t\t   burst[i].offset);\n\t}\n\n\t \n\temc_dbg(emc, SUB_STEPS, \"Writing vref_regs\\n\");\n\n\tfor (i = 0; i < next->vref_num; i++) {\n\t\tconst struct tegra210_emc_per_channel_regs *vref =\n\t\t\t\t\temc->offsets->vref_per_channel;\n\n\t\tif (!vref[i].offset)\n\t\t\tcontinue;\n\n\t\tif (emc->num_channels < 2 && vref[i].bank >= 1)\n\t\t\tcontinue;\n\n\t\temc_dbg(emc, REG_LISTS, \"(%u) 0x%08x => 0x%08x\\n\", i,\n\t\t\tnext->vref_perch_regs[i], vref[i].offset);\n\t\temc_channel_writel(emc, vref[i].bank, next->vref_perch_regs[i],\n\t\t\t\t   vref[i].offset);\n\t}\n\n\t \n\temc_dbg(emc, SUB_STEPS, \"Writing trim_regs\\n\");\n\n\tfor (i = 0; i < next->num_trim; i++) {\n\t\tconst u16 *offsets = emc->offsets->trim;\n\n\t\tif (!offsets[i])\n\t\t\tcontinue;\n\n\t\tif (compensate_trimmer_applicable &&\n\t\t    (offsets[i] == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_0 ||\n\t\t     offsets[i] == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_1 ||\n\t\t     offsets[i] == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_2 ||\n\t\t     offsets[i] == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_3 ||\n\t\t     offsets[i] == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_0 ||\n\t\t     offsets[i] == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_1 ||\n\t\t     offsets[i] == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_2 ||\n\t\t     offsets[i] == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_3 ||\n\t\t     offsets[i] == EMC_DATA_BRLSHFT_0 ||\n\t\t     offsets[i] == EMC_DATA_BRLSHFT_1)) {\n\t\t\tvalue = tegra210_emc_compensate(next, offsets[i]);\n\t\t\temc_dbg(emc, REG_LISTS, \"(%u) 0x%08x => 0x%08x\\n\", i,\n\t\t\t\tvalue, offsets[i]);\n\t\t\temc_dbg(emc, EMA_WRITES, \"0x%08x <= 0x%08x\\n\",\n\t\t\t\t(u32)(u64)offsets[i], value);\n\t\t\temc_writel(emc, value, offsets[i]);\n\t\t} else {\n\t\t\temc_dbg(emc, REG_LISTS, \"(%u) 0x%08x => 0x%08x\\n\", i,\n\t\t\t\tnext->trim_regs[i], offsets[i]);\n\t\t\temc_writel(emc, next->trim_regs[i], offsets[i]);\n\t\t}\n\t}\n\n\t \n\temc_dbg(emc, SUB_STEPS, \"Writing trim_regs_per_ch\\n\");\n\n\tfor (i = 0; i < next->num_trim_per_ch; i++) {\n\t\tconst struct tegra210_emc_per_channel_regs *trim =\n\t\t\t\t&emc->offsets->trim_per_channel[0];\n\t\tunsigned int offset;\n\n\t\tif (!trim[i].offset)\n\t\t\tcontinue;\n\n\t\tif (emc->num_channels < 2 && trim[i].bank >= 1)\n\t\t\tcontinue;\n\n\t\toffset = trim[i].offset;\n\n\t\tif (compensate_trimmer_applicable &&\n\t\t    (offset == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_0 ||\n\t\t     offset == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_1 ||\n\t\t     offset == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_2 ||\n\t\t     offset == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK0_3 ||\n\t\t     offset == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_0 ||\n\t\t     offset == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_1 ||\n\t\t     offset == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_2 ||\n\t\t     offset == EMC_PMACRO_OB_DDLL_LONG_DQ_RANK1_3 ||\n\t\t     offset == EMC_DATA_BRLSHFT_0 ||\n\t\t     offset == EMC_DATA_BRLSHFT_1)) {\n\t\t\tvalue = tegra210_emc_compensate(next, offset);\n\t\t\temc_dbg(emc, REG_LISTS, \"(%u) 0x%08x => 0x%08x\\n\", i,\n\t\t\t\tvalue, offset);\n\t\t\temc_dbg(emc, EMA_WRITES, \"0x%08x <= 0x%08x\\n\", offset,\n\t\t\t\tvalue);\n\t\t\temc_channel_writel(emc, trim[i].bank, value, offset);\n\t\t} else {\n\t\t\temc_dbg(emc, REG_LISTS, \"(%u) 0x%08x => 0x%08x\\n\", i,\n\t\t\t\tnext->trim_perch_regs[i], offset);\n\t\t\temc_channel_writel(emc, trim[i].bank,\n\t\t\t\t\t   next->trim_perch_regs[i], offset);\n\t\t}\n\t}\n\n\temc_dbg(emc, SUB_STEPS, \"Writing burst_mc_regs\\n\");\n\n\tfor (i = 0; i < next->num_mc_regs; i++) {\n\t\tconst u16 *offsets = emc->offsets->burst_mc;\n\t\tu32 *values = next->burst_mc_regs;\n\n\t\temc_dbg(emc, REG_LISTS, \"(%u) 0x%08x => 0x%08x\\n\", i,\n\t\t\tvalues[i], offsets[i]);\n\t\tmc_writel(emc->mc, values[i], offsets[i]);\n\t}\n\n\t \n\tif (next->rate < last->rate) {\n\t\tconst u16 *la = emc->offsets->la_scale;\n\n\t\temc_dbg(emc, SUB_STEPS, \"Writing la_scale_regs\\n\");\n\n\t\tfor (i = 0; i < next->num_up_down; i++) {\n\t\t\temc_dbg(emc, REG_LISTS, \"(%u) 0x%08x => 0x%08x\\n\", i,\n\t\t\t\tnext->la_scale_regs[i], la[i]);\n\t\t\tmc_writel(emc->mc, next->la_scale_regs[i], la[i]);\n\t\t}\n\t}\n\n\t \n\tmc_readl(emc->mc, MC_EMEM_ADR_CFG);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 9\\n\");\n\n\tvalue = next->burst_regs[EMC_ZCAL_WAIT_CNT_INDEX];\n\tvalue &= ~EMC_ZCAL_WAIT_CNT_ZCAL_WAIT_CNT_MASK;\n\n\tif (dram_type == DRAM_TYPE_LPDDR4) {\n\t\temc_writel(emc, 0, EMC_ZCAL_INTERVAL);\n\t\temc_writel(emc, value, EMC_ZCAL_WAIT_CNT);\n\n\t\tvalue = emc_dbg | (EMC_DBG_WRITE_MUX_ACTIVE |\n\t\t\t\t   EMC_DBG_WRITE_ACTIVE_ONLY);\n\n\t\temc_writel(emc, value, EMC_DBG);\n\t\temc_writel(emc, 0, EMC_ZCAL_INTERVAL);\n\t\temc_writel(emc, emc_dbg, EMC_DBG);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 10\\n\");\n\n\tif (opt_dvfs_mode == MAN_SR || dram_type == DRAM_TYPE_LPDDR4) {\n\t\tif (dram_type == DRAM_TYPE_LPDDR4)\n\t\t\tccfifo_writel(emc, 0x101, EMC_SELF_REF, 0);\n\t\telse\n\t\t\tccfifo_writel(emc, 0x1, EMC_SELF_REF, 0);\n\n\t\tif (dram_type == DRAM_TYPE_LPDDR4 &&\n\t\t    dst_clk_period <= zqcal_before_cc_cutoff) {\n\t\t\tccfifo_writel(emc, mr13_flip_fspwr ^ 0x40, EMC_MRW3, 0);\n\t\t\tccfifo_writel(emc, (next->burst_regs[EMC_MRW6_INDEX] &\n\t\t\t\t\t\t0xFFFF3F3F) |\n\t\t\t\t\t   (last->burst_regs[EMC_MRW6_INDEX] &\n\t\t\t\t\t\t0x0000C0C0), EMC_MRW6, 0);\n\t\t\tccfifo_writel(emc, (next->burst_regs[EMC_MRW14_INDEX] &\n\t\t\t\t\t\t0xFFFF0707) |\n\t\t\t\t\t   (last->burst_regs[EMC_MRW14_INDEX] &\n\t\t\t\t\t\t0x00003838), EMC_MRW14, 0);\n\n\t\t\tif (emc->num_devices > 1) {\n\t\t\t\tccfifo_writel(emc,\n\t\t\t\t      (next->burst_regs[EMC_MRW7_INDEX] &\n\t\t\t\t       0xFFFF3F3F) |\n\t\t\t\t      (last->burst_regs[EMC_MRW7_INDEX] &\n\t\t\t\t       0x0000C0C0), EMC_MRW7, 0);\n\t\t\t\tccfifo_writel(emc,\n\t\t\t\t     (next->burst_regs[EMC_MRW15_INDEX] &\n\t\t\t\t      0xFFFF0707) |\n\t\t\t\t     (last->burst_regs[EMC_MRW15_INDEX] &\n\t\t\t\t      0x00003838), EMC_MRW15, 0);\n\t\t\t}\n\n\t\t\tif (opt_zcal_en_cc) {\n\t\t\t\tif (emc->num_devices < 2)\n\t\t\t\t\tccfifo_writel(emc,\n\t\t\t\t\t\t2UL << EMC_ZQ_CAL_DEV_SEL_SHIFT\n\t\t\t\t\t\t| EMC_ZQ_CAL_ZQ_CAL_CMD,\n\t\t\t\t\t\tEMC_ZQ_CAL, 0);\n\t\t\t\telse if (shared_zq_resistor)\n\t\t\t\t\tccfifo_writel(emc,\n\t\t\t\t\t\t2UL << EMC_ZQ_CAL_DEV_SEL_SHIFT\n\t\t\t\t\t\t| EMC_ZQ_CAL_ZQ_CAL_CMD,\n\t\t\t\t\t\tEMC_ZQ_CAL, 0);\n\t\t\t\telse\n\t\t\t\t\tccfifo_writel(emc,\n\t\t\t\t\t\t      EMC_ZQ_CAL_ZQ_CAL_CMD,\n\t\t\t\t\t\t      EMC_ZQ_CAL, 0);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (dram_type == DRAM_TYPE_LPDDR4) {\n\t\tvalue = (1000 * fake->dram_timings[T_RP]) / src_clk_period;\n\t\tccfifo_writel(emc, mr13_flip_fspop | 0x8, EMC_MRW3, value);\n\t\tccfifo_writel(emc, 0, 0, tFC_lpddr4 / src_clk_period);\n\t}\n\n\tif (dram_type == DRAM_TYPE_LPDDR4 || opt_dvfs_mode != MAN_SR) {\n\t\tdelay = 30;\n\n\t\tif (cya_allow_ref_cc) {\n\t\t\tdelay += (1000 * fake->dram_timings[T_RP]) /\n\t\t\t\t\tsrc_clk_period;\n\t\t\tdelay += 4000 * fake->dram_timings[T_RFC];\n\t\t}\n\n\t\tccfifo_writel(emc, emc_pin & ~(EMC_PIN_PIN_CKE_PER_DEV |\n\t\t\t\t\t       EMC_PIN_PIN_CKEB |\n\t\t\t\t\t       EMC_PIN_PIN_CKE),\n\t\t\t      EMC_PIN, delay);\n\t}\n\n\t \n\tvalue = 1;\n\n\tif (ref_b4_sref_en)\n\t\tvalue++;\n\n\tif (cya_allow_ref_cc)\n\t\tvalue++;\n\n\tif (cya_issue_pc_ref)\n\t\tvalue++;\n\n\tif (dram_type != DRAM_TYPE_LPDDR4) {\n\t\tdelay = ((1000 * fake->dram_timings[T_RP] / src_clk_period) +\n\t\t\t (1000 * fake->dram_timings[T_RFC] / src_clk_period));\n\t\tdelay = value * delay + 20;\n\t} else {\n\t\tdelay = 0;\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 11\\n\");\n\n\tccfifo_writel(emc, 0x0, EMC_CFG_SYNC, delay);\n\n\tvalue = emc_dbg | EMC_DBG_WRITE_MUX_ACTIVE | EMC_DBG_WRITE_ACTIVE_ONLY;\n\tccfifo_writel(emc, value, EMC_DBG, 0);\n\n\tramp_down_wait = tegra210_emc_dvfs_power_ramp_down(emc, src_clk_period,\n\t\t\t\t\t\t\t   0);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 12\\n\");\n\n\tccfifo_writel(emc, 1, EMC_STALL_THEN_EXE_AFTER_CLKCHANGE, 0);\n\tvalue &= ~EMC_DBG_WRITE_ACTIVE_ONLY;\n\tccfifo_writel(emc, value, EMC_DBG, 0);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 13\\n\");\n\n\tramp_up_wait = tegra210_emc_dvfs_power_ramp_up(emc, dst_clk_period, 0);\n\tccfifo_writel(emc, emc_dbg, EMC_DBG, 0);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 14\\n\");\n\n\tif (dram_type == DRAM_TYPE_LPDDR4) {\n\t\tvalue = emc_pin | EMC_PIN_PIN_CKE;\n\n\t\tif (emc->num_devices <= 1)\n\t\t\tvalue &= ~(EMC_PIN_PIN_CKEB | EMC_PIN_PIN_CKE_PER_DEV);\n\t\telse\n\t\t\tvalue |= EMC_PIN_PIN_CKEB | EMC_PIN_PIN_CKE_PER_DEV;\n\n\t\tccfifo_writel(emc, value, EMC_PIN, 0);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 15\\n\");\n\n\tif (dst_clk_period <= zqcal_before_cc_cutoff) {\n\t\ts32 t = (s32)(ramp_up_wait + ramp_down_wait) /\n\t\t\t(s32)dst_clk_period;\n\t\tzq_latch_dvfs_wait_time = (s32)tZQCAL_lpddr4_fc_adj - t;\n\t} else {\n\t\tzq_latch_dvfs_wait_time = tZQCAL_lpddr4_fc_adj -\n\t\t\tdiv_o3(1000 * next->dram_timings[T_PDEX],\n\t\t\t       dst_clk_period);\n\t}\n\n\temc_dbg(emc, INFO, \"tZQCAL_lpddr4_fc_adj = %u\\n\", tZQCAL_lpddr4_fc_adj);\n\temc_dbg(emc, INFO, \"dst_clk_period = %u\\n\",\n\t\tdst_clk_period);\n\temc_dbg(emc, INFO, \"next->dram_timings[T_PDEX] = %u\\n\",\n\t\tnext->dram_timings[T_PDEX]);\n\temc_dbg(emc, INFO, \"zq_latch_dvfs_wait_time = %d\\n\",\n\t\tmax_t(s32, 0, zq_latch_dvfs_wait_time));\n\n\tif (dram_type == DRAM_TYPE_LPDDR4 && opt_zcal_en_cc) {\n\t\tdelay = div_o3(1000 * next->dram_timings[T_PDEX],\n\t\t\t       dst_clk_period);\n\n\t\tif (emc->num_devices < 2) {\n\t\t\tif (dst_clk_period > zqcal_before_cc_cutoff)\n\t\t\t\tccfifo_writel(emc,\n\t\t\t\t\t      2UL << EMC_ZQ_CAL_DEV_SEL_SHIFT |\n\t\t\t\t\t      EMC_ZQ_CAL_ZQ_CAL_CMD, EMC_ZQ_CAL,\n\t\t\t\t\t      delay);\n\n\t\t\tvalue = (mr13_flip_fspop & 0xfffffff7) | 0x0c000000;\n\t\t\tccfifo_writel(emc, value, EMC_MRW3, delay);\n\t\t\tccfifo_writel(emc, 0, EMC_SELF_REF, 0);\n\t\t\tccfifo_writel(emc, 0, EMC_REF, 0);\n\t\t\tccfifo_writel(emc, 2UL << EMC_ZQ_CAL_DEV_SEL_SHIFT |\n\t\t\t\t      EMC_ZQ_CAL_ZQ_LATCH_CMD,\n\t\t\t\t      EMC_ZQ_CAL,\n\t\t\t\t      max_t(s32, 0, zq_latch_dvfs_wait_time));\n\t\t} else if (shared_zq_resistor) {\n\t\t\tif (dst_clk_period > zqcal_before_cc_cutoff)\n\t\t\t\tccfifo_writel(emc,\n\t\t\t\t\t      2UL << EMC_ZQ_CAL_DEV_SEL_SHIFT |\n\t\t\t\t\t      EMC_ZQ_CAL_ZQ_CAL_CMD, EMC_ZQ_CAL,\n\t\t\t\t\t      delay);\n\n\t\t\tccfifo_writel(emc, 2UL << EMC_ZQ_CAL_DEV_SEL_SHIFT |\n\t\t\t\t      EMC_ZQ_CAL_ZQ_LATCH_CMD, EMC_ZQ_CAL,\n\t\t\t\t      max_t(s32, 0, zq_latch_dvfs_wait_time) +\n\t\t\t\t\tdelay);\n\t\t\tccfifo_writel(emc, 1UL << EMC_ZQ_CAL_DEV_SEL_SHIFT |\n\t\t\t\t      EMC_ZQ_CAL_ZQ_LATCH_CMD,\n\t\t\t\t      EMC_ZQ_CAL, 0);\n\n\t\t\tvalue = (mr13_flip_fspop & 0xfffffff7) | 0x0c000000;\n\t\t\tccfifo_writel(emc, value, EMC_MRW3, 0);\n\t\t\tccfifo_writel(emc, 0, EMC_SELF_REF, 0);\n\t\t\tccfifo_writel(emc, 0, EMC_REF, 0);\n\n\t\t\tccfifo_writel(emc, 1UL << EMC_ZQ_CAL_DEV_SEL_SHIFT |\n\t\t\t\t      EMC_ZQ_CAL_ZQ_LATCH_CMD, EMC_ZQ_CAL,\n\t\t\t\t      tZQCAL_lpddr4 / dst_clk_period);\n\t\t} else {\n\t\t\tif (dst_clk_period > zqcal_before_cc_cutoff)\n\t\t\t\tccfifo_writel(emc, EMC_ZQ_CAL_ZQ_CAL_CMD,\n\t\t\t\t\t      EMC_ZQ_CAL, delay);\n\n\t\t\tvalue = (mr13_flip_fspop & 0xfffffff7) | 0x0c000000;\n\t\t\tccfifo_writel(emc, value, EMC_MRW3, delay);\n\t\t\tccfifo_writel(emc, 0, EMC_SELF_REF, 0);\n\t\t\tccfifo_writel(emc, 0, EMC_REF, 0);\n\n\t\t\tccfifo_writel(emc, EMC_ZQ_CAL_ZQ_LATCH_CMD, EMC_ZQ_CAL,\n\t\t\t\t      max_t(s32, 0, zq_latch_dvfs_wait_time));\n\t\t}\n\t}\n\n\t \n\tccfifo_writel(emc, 0, 0, 10);\n\n\t \n\n\t \n\temc_dbg(emc, STEPS, \"Step 17\\n\");\n\n\tif (opt_dvfs_mode == MAN_SR && dram_type != DRAM_TYPE_LPDDR4)\n\t\tccfifo_writel(emc, 0, EMC_SELF_REF, 0);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 18\\n\");\n\n\tif (dram_type == DRAM_TYPE_LPDDR2) {\n\t\tccfifo_writel(emc, next->emc_mrw2, EMC_MRW2, 0);\n\t\tccfifo_writel(emc, next->emc_mrw,  EMC_MRW,  0);\n\t\tif (is_lpddr3)\n\t\t\tccfifo_writel(emc, next->emc_mrw4, EMC_MRW4, 0);\n\t} else if (dram_type == DRAM_TYPE_DDR3) {\n\t\tif (opt_dll_mode)\n\t\t\tccfifo_writel(emc, next->emc_emrs &\n\t\t\t\t      ~EMC_EMRS_USE_EMRS_LONG_CNT, EMC_EMRS, 0);\n\t\tccfifo_writel(emc, next->emc_emrs2 &\n\t\t\t      ~EMC_EMRS2_USE_EMRS2_LONG_CNT, EMC_EMRS2, 0);\n\t\tccfifo_writel(emc, next->emc_mrs |\n\t\t\t      EMC_EMRS_USE_EMRS_LONG_CNT, EMC_MRS, 0);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 19\\n\");\n\n\tif (opt_zcal_en_cc) {\n\t\tif (dram_type == DRAM_TYPE_LPDDR2) {\n\t\t\tvalue = opt_cc_short_zcal ? 90000 : 360000;\n\t\t\tvalue = div_o3(value, dst_clk_period);\n\t\t\tvalue = value <<\n\t\t\t\tEMC_MRS_WAIT_CNT2_MRS_EXT2_WAIT_CNT_SHIFT |\n\t\t\t\tvalue <<\n\t\t\t\tEMC_MRS_WAIT_CNT2_MRS_EXT1_WAIT_CNT_SHIFT;\n\t\t\tccfifo_writel(emc, value, EMC_MRS_WAIT_CNT2, 0);\n\n\t\t\tvalue = opt_cc_short_zcal ? 0x56 : 0xab;\n\t\t\tccfifo_writel(emc, 2 << EMC_MRW_MRW_DEV_SELECTN_SHIFT |\n\t\t\t\t\t   EMC_MRW_USE_MRW_EXT_CNT |\n\t\t\t\t\t   10 << EMC_MRW_MRW_MA_SHIFT |\n\t\t\t\t\t   value << EMC_MRW_MRW_OP_SHIFT,\n\t\t\t\t      EMC_MRW, 0);\n\n\t\t\tif (emc->num_devices > 1) {\n\t\t\t\tvalue = 1 << EMC_MRW_MRW_DEV_SELECTN_SHIFT |\n\t\t\t\t\tEMC_MRW_USE_MRW_EXT_CNT |\n\t\t\t\t\t10 << EMC_MRW_MRW_MA_SHIFT |\n\t\t\t\t\tvalue << EMC_MRW_MRW_OP_SHIFT;\n\t\t\t\tccfifo_writel(emc, value, EMC_MRW, 0);\n\t\t\t}\n\t\t} else if (dram_type == DRAM_TYPE_DDR3) {\n\t\t\tvalue = opt_cc_short_zcal ? 0 : EMC_ZQ_CAL_LONG;\n\n\t\t\tccfifo_writel(emc, value |\n\t\t\t\t\t   2 << EMC_ZQ_CAL_DEV_SEL_SHIFT |\n\t\t\t\t\t   EMC_ZQ_CAL_ZQ_CAL_CMD, EMC_ZQ_CAL,\n\t\t\t\t\t   0);\n\n\t\t\tif (emc->num_devices > 1) {\n\t\t\t\tvalue = value | 1 << EMC_ZQ_CAL_DEV_SEL_SHIFT |\n\t\t\t\t\t\tEMC_ZQ_CAL_ZQ_CAL_CMD;\n\t\t\t\tccfifo_writel(emc, value, EMC_ZQ_CAL, 0);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (bg_reg_mode_change) {\n\t\ttegra210_emc_set_shadow_bypass(emc, ACTIVE);\n\n\t\tif (ramp_up_wait <= 1250000)\n\t\t\tdelay = (1250000 - ramp_up_wait) / dst_clk_period;\n\t\telse\n\t\t\tdelay = 0;\n\n\t\tccfifo_writel(emc,\n\t\t\t      next->burst_regs[EMC_PMACRO_BG_BIAS_CTRL_0_INDEX],\n\t\t\t      EMC_PMACRO_BG_BIAS_CTRL_0, delay);\n\t\ttegra210_emc_set_shadow_bypass(emc, ASSEMBLY);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 20\\n\");\n\n\tif (dram_type != DRAM_TYPE_LPDDR4)\n\t\tccfifo_writel(emc, 0, EMC_REF, 0);\n\n\tif (opt_do_sw_qrst) {\n\t\tccfifo_writel(emc, 1, EMC_ISSUE_QRST, 0);\n\t\tccfifo_writel(emc, 0, EMC_ISSUE_QRST, 2);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 21\\n\");\n\n\tif (save_restore_clkstop_pd || opt_zcal_en_cc) {\n\t\tccfifo_writel(emc, emc_dbg | EMC_DBG_WRITE_MUX_ACTIVE,\n\t\t\t      EMC_DBG, 0);\n\t\tif (opt_zcal_en_cc && dram_type != DRAM_TYPE_LPDDR4)\n\t\t\tccfifo_writel(emc, next->burst_regs[EMC_ZCAL_INTERVAL_INDEX],\n\t\t\t\t      EMC_ZCAL_INTERVAL, 0);\n\n\t\tif (save_restore_clkstop_pd)\n\t\t\tccfifo_writel(emc, next->burst_regs[EMC_CFG_INDEX] &\n\t\t\t\t\t\t~EMC_CFG_DYN_SELF_REF,\n\t\t\t\t      EMC_CFG, 0);\n\t\tccfifo_writel(emc, emc_dbg, EMC_DBG, 0);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 22\\n\");\n\n\tccfifo_writel(emc, emc_cfg_pipe_clk, EMC_CFG_PIPE_CLK, 0);\n\n\tif (bg_reg_mode_change) {\n\t\tif (enable_bg_reg)\n\t\t\temc_writel(emc,\n\t\t\t\t   next->burst_regs[EMC_PMACRO_BG_BIAS_CTRL_0_INDEX] &\n\t\t\t\t\t~EMC_PMACRO_BG_BIAS_CTRL_0_BGLP_E_PWRD,\n\t\t\t\t   EMC_PMACRO_BG_BIAS_CTRL_0);\n\t\telse\n\t\t\temc_writel(emc,\n\t\t\t\t   next->burst_regs[EMC_PMACRO_BG_BIAS_CTRL_0_INDEX] &\n\t\t\t\t\t~EMC_PMACRO_BG_BIAS_CTRL_0_BG_E_PWRD,\n\t\t\t\t   EMC_PMACRO_BG_BIAS_CTRL_0);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 23\\n\");\n\n\tvalue = emc_readl(emc, EMC_CFG_DIG_DLL);\n\tvalue |= EMC_CFG_DIG_DLL_CFG_DLL_STALL_ALL_TRAFFIC;\n\tvalue &= ~EMC_CFG_DIG_DLL_CFG_DLL_STALL_RW_UNTIL_LOCK;\n\tvalue &= ~EMC_CFG_DIG_DLL_CFG_DLL_STALL_ALL_UNTIL_LOCK;\n\tvalue &= ~EMC_CFG_DIG_DLL_CFG_DLL_EN;\n\tvalue = (value & ~EMC_CFG_DIG_DLL_CFG_DLL_MODE_MASK) |\n\t\t(2 << EMC_CFG_DIG_DLL_CFG_DLL_MODE_SHIFT);\n\temc_writel(emc, value, EMC_CFG_DIG_DLL);\n\n\ttegra210_emc_do_clock_change(emc, clksrc);\n\n\t \n\n\t \n\temc_dbg(emc, STEPS, \"Step 25\\n\");\n\n\tif (next->rate > last->rate) {\n\t\tfor (i = 0; i < next->num_up_down; i++)\n\t\t\tmc_writel(emc->mc, next->la_scale_regs[i],\n\t\t\t\t  emc->offsets->la_scale[i]);\n\n\t\ttegra210_emc_timing_update(emc);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 26\\n\");\n\n\tif (dram_type == DRAM_TYPE_LPDDR4) {\n\t\ttegra210_emc_set_shadow_bypass(emc, ACTIVE);\n\t\temc_writel(emc, next->burst_regs[EMC_ZCAL_WAIT_CNT_INDEX],\n\t\t\t   EMC_ZCAL_WAIT_CNT);\n\t\temc_writel(emc, next->burst_regs[EMC_ZCAL_INTERVAL_INDEX],\n\t\t\t   EMC_ZCAL_INTERVAL);\n\t\ttegra210_emc_set_shadow_bypass(emc, ASSEMBLY);\n\t}\n\n\tif (dram_type != DRAM_TYPE_LPDDR4 && opt_zcal_en_cc &&\n\t    !opt_short_zcal && opt_cc_short_zcal) {\n\t\tudelay(2);\n\n\t\ttegra210_emc_set_shadow_bypass(emc, ACTIVE);\n\t\tif (dram_type == DRAM_TYPE_LPDDR2)\n\t\t\temc_writel(emc, next->burst_regs[EMC_MRS_WAIT_CNT_INDEX],\n\t\t\t\t   EMC_MRS_WAIT_CNT);\n\t\telse if (dram_type == DRAM_TYPE_DDR3)\n\t\t\temc_writel(emc, next->burst_regs[EMC_ZCAL_WAIT_CNT_INDEX],\n\t\t\t\t   EMC_ZCAL_WAIT_CNT);\n\t\ttegra210_emc_set_shadow_bypass(emc, ASSEMBLY);\n\t}\n\n\t \n\temc_dbg(emc, STEPS, \"Step 27\\n\");\n\n\ttegra210_emc_set_shadow_bypass(emc, ACTIVE);\n\temc_writel(emc, next->burst_regs[EMC_CFG_INDEX], EMC_CFG);\n\ttegra210_emc_set_shadow_bypass(emc, ASSEMBLY);\n\temc_writel(emc, next->emc_fdpd_ctrl_cmd_no_ramp,\n\t\t   EMC_FDPD_CTRL_CMD_NO_RAMP);\n\temc_writel(emc, next->emc_sel_dpd_ctrl, EMC_SEL_DPD_CTRL);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 28\\n\");\n\n\ttegra210_emc_set_shadow_bypass(emc, ACTIVE);\n\temc_writel(emc,\n\t\t   next->burst_regs[EMC_PMACRO_AUTOCAL_CFG_COMMON_INDEX],\n\t\t   EMC_PMACRO_AUTOCAL_CFG_COMMON);\n\ttegra210_emc_set_shadow_bypass(emc, ASSEMBLY);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 29\\n\");\n\n\temc_writel(emc, EMC_PMACRO_CFG_PM_GLOBAL_0_DISABLE_CFG_BYTE0 |\n\t\t   EMC_PMACRO_CFG_PM_GLOBAL_0_DISABLE_CFG_BYTE1 |\n\t\t   EMC_PMACRO_CFG_PM_GLOBAL_0_DISABLE_CFG_BYTE2 |\n\t\t   EMC_PMACRO_CFG_PM_GLOBAL_0_DISABLE_CFG_BYTE3 |\n\t\t   EMC_PMACRO_CFG_PM_GLOBAL_0_DISABLE_CFG_BYTE4 |\n\t\t   EMC_PMACRO_CFG_PM_GLOBAL_0_DISABLE_CFG_BYTE5 |\n\t\t   EMC_PMACRO_CFG_PM_GLOBAL_0_DISABLE_CFG_BYTE6 |\n\t\t   EMC_PMACRO_CFG_PM_GLOBAL_0_DISABLE_CFG_BYTE7,\n\t\t   EMC_PMACRO_CFG_PM_GLOBAL_0);\n\temc_writel(emc, EMC_PMACRO_TRAINING_CTRL_0_CH0_TRAINING_E_WRPTR,\n\t\t   EMC_PMACRO_TRAINING_CTRL_0);\n\temc_writel(emc, EMC_PMACRO_TRAINING_CTRL_1_CH1_TRAINING_E_WRPTR,\n\t\t   EMC_PMACRO_TRAINING_CTRL_1);\n\temc_writel(emc, 0, EMC_PMACRO_CFG_PM_GLOBAL_0);\n\n\t \n\temc_dbg(emc, STEPS, \"Step 30: Re-enable DLL and AUTOCAL\\n\");\n\n\tif (next->burst_regs[EMC_CFG_DIG_DLL_INDEX] & EMC_CFG_DIG_DLL_CFG_DLL_EN) {\n\t\tvalue = emc_readl(emc, EMC_CFG_DIG_DLL);\n\t\tvalue |=  EMC_CFG_DIG_DLL_CFG_DLL_STALL_ALL_TRAFFIC;\n\t\tvalue |=  EMC_CFG_DIG_DLL_CFG_DLL_EN;\n\t\tvalue &= ~EMC_CFG_DIG_DLL_CFG_DLL_STALL_RW_UNTIL_LOCK;\n\t\tvalue &= ~EMC_CFG_DIG_DLL_CFG_DLL_STALL_ALL_UNTIL_LOCK;\n\t\tvalue = (value & ~EMC_CFG_DIG_DLL_CFG_DLL_MODE_MASK) |\n\t\t\t(2 << EMC_CFG_DIG_DLL_CFG_DLL_MODE_SHIFT);\n\t\temc_writel(emc, value, EMC_CFG_DIG_DLL);\n\t\ttegra210_emc_timing_update(emc);\n\t}\n\n\temc_writel(emc, next->emc_auto_cal_config, EMC_AUTO_CAL_CONFIG);\n\n\t \n}\n\nconst struct tegra210_emc_sequence tegra210_emc_r21021 = {\n\t.revision = 0x7,\n\t.set_clock = tegra210_emc_r21021_set_clock,\n\t.periodic_compensation = tegra210_emc_r21021_periodic_compensation,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}