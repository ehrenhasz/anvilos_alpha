{
  "module_name": "hisi_thermal.c",
  "hash_id": "6642050c820c57795542fc24be4d7000f50301563636918f2e5074ac5dae713c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/hisi_thermal.c",
  "human_readable_source": "\n \n\n#include <linux/cpufreq.h>\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/io.h>\n#include <linux/thermal.h>\n\n#define HI6220_TEMP0_LAG\t\t\t(0x0)\n#define HI6220_TEMP0_TH\t\t\t\t(0x4)\n#define HI6220_TEMP0_RST_TH\t\t\t(0x8)\n#define HI6220_TEMP0_CFG\t\t\t(0xC)\n#define HI6220_TEMP0_CFG_SS_MSK\t\t\t(0xF000)\n#define HI6220_TEMP0_CFG_HDAK_MSK\t\t(0x30)\n#define HI6220_TEMP0_EN\t\t\t\t(0x10)\n#define HI6220_TEMP0_INT_EN\t\t\t(0x14)\n#define HI6220_TEMP0_INT_CLR\t\t\t(0x18)\n#define HI6220_TEMP0_RST_MSK\t\t\t(0x1C)\n#define HI6220_TEMP0_VALUE\t\t\t(0x28)\n\n#define HI3660_OFFSET(chan)\t\t((chan) * 0x40)\n#define HI3660_TEMP(chan)\t\t(HI3660_OFFSET(chan) + 0x1C)\n#define HI3660_TH(chan)\t\t\t(HI3660_OFFSET(chan) + 0x20)\n#define HI3660_LAG(chan)\t\t(HI3660_OFFSET(chan) + 0x28)\n#define HI3660_INT_EN(chan)\t\t(HI3660_OFFSET(chan) + 0x2C)\n#define HI3660_INT_CLR(chan)\t\t(HI3660_OFFSET(chan) + 0x30)\n\n#define HI6220_TEMP_BASE\t\t\t(-60000)\n#define HI6220_TEMP_RESET\t\t\t(100000)\n#define HI6220_TEMP_STEP\t\t\t(785)\n#define HI6220_TEMP_LAG\t\t\t\t(3500)\n\n#define HI3660_TEMP_BASE\t\t(-63780)\n#define HI3660_TEMP_STEP\t\t(205)\n#define HI3660_TEMP_LAG\t\t\t(4000)\n\n#define HI6220_CLUSTER0_SENSOR\t\t2\n#define HI6220_CLUSTER1_SENSOR\t\t1\n\n#define HI3660_LITTLE_SENSOR\t\t0\n#define HI3660_BIG_SENSOR\t\t1\n#define HI3660_G3D_SENSOR\t\t2\n#define HI3660_MODEM_SENSOR\t\t3\n\nstruct hisi_thermal_data;\n\nstruct hisi_thermal_sensor {\n\tstruct hisi_thermal_data *data;\n\tstruct thermal_zone_device *tzd;\n\tconst char *irq_name;\n\tuint32_t id;\n\tuint32_t thres_temp;\n};\n\nstruct hisi_thermal_ops {\n\tint (*get_temp)(struct hisi_thermal_sensor *sensor);\n\tint (*enable_sensor)(struct hisi_thermal_sensor *sensor);\n\tint (*disable_sensor)(struct hisi_thermal_sensor *sensor);\n\tint (*irq_handler)(struct hisi_thermal_sensor *sensor);\n\tint (*probe)(struct hisi_thermal_data *data);\n};\n\nstruct hisi_thermal_data {\n\tconst struct hisi_thermal_ops *ops;\n\tstruct hisi_thermal_sensor *sensor;\n\tstruct platform_device *pdev;\n\tstruct clk *clk;\n\tvoid __iomem *regs;\n\tint nr_sensors;\n};\n\n \nstatic inline int hi6220_thermal_step_to_temp(int step)\n{\n\treturn HI6220_TEMP_BASE + (step * HI6220_TEMP_STEP);\n}\n\nstatic inline int hi6220_thermal_temp_to_step(int temp)\n{\n\treturn DIV_ROUND_UP(temp - HI6220_TEMP_BASE, HI6220_TEMP_STEP);\n}\n\n \nstatic inline int hi3660_thermal_step_to_temp(int step)\n{\n\treturn HI3660_TEMP_BASE + step * HI3660_TEMP_STEP;\n}\n\nstatic inline int hi3660_thermal_temp_to_step(int temp)\n{\n\treturn DIV_ROUND_UP(temp - HI3660_TEMP_BASE, HI3660_TEMP_STEP);\n}\n\n \nstatic inline void hi6220_thermal_set_lag(void __iomem *addr, int value)\n{\n\twritel(DIV_ROUND_UP(value, HI6220_TEMP_STEP) & 0x1F,\n\t\t\taddr + HI6220_TEMP0_LAG);\n}\n\nstatic inline void hi6220_thermal_alarm_clear(void __iomem *addr, int value)\n{\n\twritel(value, addr + HI6220_TEMP0_INT_CLR);\n}\n\nstatic inline void hi6220_thermal_alarm_enable(void __iomem *addr, int value)\n{\n\twritel(value, addr + HI6220_TEMP0_INT_EN);\n}\n\nstatic inline void hi6220_thermal_alarm_set(void __iomem *addr, int temp)\n{\n\twritel(hi6220_thermal_temp_to_step(temp) | 0x0FFFFFF00,\n\t       addr + HI6220_TEMP0_TH);\n}\n\nstatic inline void hi6220_thermal_reset_set(void __iomem *addr, int temp)\n{\n\twritel(hi6220_thermal_temp_to_step(temp), addr + HI6220_TEMP0_RST_TH);\n}\n\nstatic inline void hi6220_thermal_reset_enable(void __iomem *addr, int value)\n{\n\twritel(value, addr + HI6220_TEMP0_RST_MSK);\n}\n\nstatic inline void hi6220_thermal_enable(void __iomem *addr, int value)\n{\n\twritel(value, addr + HI6220_TEMP0_EN);\n}\n\nstatic inline int hi6220_thermal_get_temperature(void __iomem *addr)\n{\n\treturn hi6220_thermal_step_to_temp(readl(addr + HI6220_TEMP0_VALUE));\n}\n\n \nstatic inline void hi3660_thermal_set_lag(void __iomem *addr,\n\t\t\t\t\t  int id, int value)\n{\n\twritel(DIV_ROUND_UP(value, HI3660_TEMP_STEP) & 0x7F,\n\t\t\taddr + HI3660_LAG(id));\n}\n\nstatic inline void hi3660_thermal_alarm_clear(void __iomem *addr,\n\t\t\t\t\t      int id, int value)\n{\n\twritel(value, addr + HI3660_INT_CLR(id));\n}\n\nstatic inline void hi3660_thermal_alarm_enable(void __iomem *addr,\n\t\t\t\t\t       int id, int value)\n{\n\twritel(value, addr + HI3660_INT_EN(id));\n}\n\nstatic inline void hi3660_thermal_alarm_set(void __iomem *addr,\n\t\t\t\t\t    int id, int value)\n{\n\twritel(value, addr + HI3660_TH(id));\n}\n\nstatic inline int hi3660_thermal_get_temperature(void __iomem *addr, int id)\n{\n\treturn hi3660_thermal_step_to_temp(readl(addr + HI3660_TEMP(id)));\n}\n\n \nstatic inline void hi6220_thermal_sensor_select(void __iomem *addr, int sensor)\n{\n\twritel((readl(addr + HI6220_TEMP0_CFG) & ~HI6220_TEMP0_CFG_SS_MSK) |\n\t       (sensor << 12), addr + HI6220_TEMP0_CFG);\n}\n\n \nstatic inline void hi6220_thermal_hdak_set(void __iomem *addr, int value)\n{\n\twritel((readl(addr + HI6220_TEMP0_CFG) & ~HI6220_TEMP0_CFG_HDAK_MSK) |\n\t       (value << 4), addr + HI6220_TEMP0_CFG);\n}\n\nstatic int hi6220_thermal_irq_handler(struct hisi_thermal_sensor *sensor)\n{\n\tstruct hisi_thermal_data *data = sensor->data;\n\n\thi6220_thermal_alarm_clear(data->regs, 1);\n\treturn 0;\n}\n\nstatic int hi3660_thermal_irq_handler(struct hisi_thermal_sensor *sensor)\n{\n\tstruct hisi_thermal_data *data = sensor->data;\n\n\thi3660_thermal_alarm_clear(data->regs, sensor->id, 1);\n\treturn 0;\n}\n\nstatic int hi6220_thermal_get_temp(struct hisi_thermal_sensor *sensor)\n{\n\tstruct hisi_thermal_data *data = sensor->data;\n\n\treturn hi6220_thermal_get_temperature(data->regs);\n}\n\nstatic int hi3660_thermal_get_temp(struct hisi_thermal_sensor *sensor)\n{\n\tstruct hisi_thermal_data *data = sensor->data;\n\n\treturn hi3660_thermal_get_temperature(data->regs, sensor->id);\n}\n\nstatic int hi6220_thermal_disable_sensor(struct hisi_thermal_sensor *sensor)\n{\n\tstruct hisi_thermal_data *data = sensor->data;\n\n\t \n\thi6220_thermal_enable(data->regs, 0);\n\thi6220_thermal_alarm_enable(data->regs, 0);\n\thi6220_thermal_reset_enable(data->regs, 0);\n\n\tclk_disable_unprepare(data->clk);\n\n\treturn 0;\n}\n\nstatic int hi3660_thermal_disable_sensor(struct hisi_thermal_sensor *sensor)\n{\n\tstruct hisi_thermal_data *data = sensor->data;\n\n\t \n\thi3660_thermal_alarm_enable(data->regs, sensor->id, 0);\n\treturn 0;\n}\n\nstatic int hi6220_thermal_enable_sensor(struct hisi_thermal_sensor *sensor)\n{\n\tstruct hisi_thermal_data *data = sensor->data;\n\tint ret;\n\n\t \n\tret = clk_prepare_enable(data->clk);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\thi6220_thermal_reset_enable(data->regs, 0);\n\thi6220_thermal_enable(data->regs, 0);\n\n\t \n\thi6220_thermal_sensor_select(data->regs, sensor->id);\n\n\t \n\thi6220_thermal_hdak_set(data->regs, 0);\n\n\t \n\thi6220_thermal_set_lag(data->regs, HI6220_TEMP_LAG);\n\n\t \n\thi6220_thermal_alarm_set(data->regs, sensor->thres_temp);\n\n\thi6220_thermal_reset_set(data->regs, HI6220_TEMP_RESET);\n\n\t \n\thi6220_thermal_reset_enable(data->regs, 1);\n\thi6220_thermal_enable(data->regs, 1);\n\n\thi6220_thermal_alarm_clear(data->regs, 0);\n\thi6220_thermal_alarm_enable(data->regs, 1);\n\n\treturn 0;\n}\n\nstatic int hi3660_thermal_enable_sensor(struct hisi_thermal_sensor *sensor)\n{\n\tunsigned int value;\n\tstruct hisi_thermal_data *data = sensor->data;\n\n\t \n\thi3660_thermal_alarm_enable(data->regs, sensor->id, 0);\n\n\t \n\thi3660_thermal_set_lag(data->regs, sensor->id, HI3660_TEMP_LAG);\n\n\t \n\tvalue = hi3660_thermal_temp_to_step(sensor->thres_temp);\n\thi3660_thermal_alarm_set(data->regs, sensor->id, value);\n\n\t \n\thi3660_thermal_alarm_clear(data->regs, sensor->id, 1);\n\thi3660_thermal_alarm_enable(data->regs, sensor->id, 1);\n\n\treturn 0;\n}\n\nstatic int hi6220_thermal_probe(struct hisi_thermal_data *data)\n{\n\tstruct platform_device *pdev = data->pdev;\n\tstruct device *dev = &pdev->dev;\n\tint ret;\n\n\tdata->clk = devm_clk_get(dev, \"thermal_clk\");\n\tif (IS_ERR(data->clk)) {\n\t\tret = PTR_ERR(data->clk);\n\t\tif (ret != -EPROBE_DEFER)\n\t\t\tdev_err(dev, \"failed to get thermal clk: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tdata->sensor = devm_kzalloc(dev, sizeof(*data->sensor), GFP_KERNEL);\n\tif (!data->sensor)\n\t\treturn -ENOMEM;\n\n\tdata->sensor[0].id = HI6220_CLUSTER0_SENSOR;\n\tdata->sensor[0].irq_name = \"tsensor_intr\";\n\tdata->sensor[0].data = data;\n\tdata->nr_sensors = 1;\n\n\treturn 0;\n}\n\nstatic int hi3660_thermal_probe(struct hisi_thermal_data *data)\n{\n\tstruct platform_device *pdev = data->pdev;\n\tstruct device *dev = &pdev->dev;\n\n\tdata->nr_sensors = 1;\n\n\tdata->sensor = devm_kzalloc(dev, sizeof(*data->sensor) *\n\t\t\t\t    data->nr_sensors, GFP_KERNEL);\n\tif (!data->sensor)\n\t\treturn -ENOMEM;\n\n\tdata->sensor[0].id = HI3660_BIG_SENSOR;\n\tdata->sensor[0].irq_name = \"tsensor_a73\";\n\tdata->sensor[0].data = data;\n\n\treturn 0;\n}\n\nstatic int hisi_thermal_get_temp(struct thermal_zone_device *tz, int *temp)\n{\n\tstruct hisi_thermal_sensor *sensor = thermal_zone_device_priv(tz);\n\tstruct hisi_thermal_data *data = sensor->data;\n\n\t*temp = data->ops->get_temp(sensor);\n\n\treturn 0;\n}\n\nstatic const struct thermal_zone_device_ops hisi_of_thermal_ops = {\n\t.get_temp = hisi_thermal_get_temp,\n};\n\nstatic irqreturn_t hisi_thermal_alarm_irq_thread(int irq, void *dev)\n{\n\tstruct hisi_thermal_sensor *sensor = dev;\n\tstruct hisi_thermal_data *data = sensor->data;\n\tint temp = 0;\n\n\tdata->ops->irq_handler(sensor);\n\n\ttemp = data->ops->get_temp(sensor);\n\n\tif (temp >= sensor->thres_temp) {\n\t\tdev_crit(&data->pdev->dev,\n\t\t\t \"sensor <%d> THERMAL ALARM: %d > %d\\n\",\n\t\t\t sensor->id, temp, sensor->thres_temp);\n\n\t\tthermal_zone_device_update(sensor->tzd,\n\t\t\t\t\t   THERMAL_EVENT_UNSPECIFIED);\n\n\t} else {\n\t\tdev_crit(&data->pdev->dev,\n\t\t\t \"sensor <%d> THERMAL ALARM stopped: %d < %d\\n\",\n\t\t\t sensor->id, temp, sensor->thres_temp);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int hisi_thermal_register_sensor(struct platform_device *pdev,\n\t\t\t\t\tstruct hisi_thermal_sensor *sensor)\n{\n\tint ret, i;\n\tstruct thermal_trip trip;\n\n\tsensor->tzd = devm_thermal_of_zone_register(&pdev->dev,\n\t\t\t\t\t\t    sensor->id, sensor,\n\t\t\t\t\t\t    &hisi_of_thermal_ops);\n\tif (IS_ERR(sensor->tzd)) {\n\t\tret = PTR_ERR(sensor->tzd);\n\t\tsensor->tzd = NULL;\n\t\tdev_err(&pdev->dev, \"failed to register sensor id %d: %d\\n\",\n\t\t\tsensor->id, ret);\n\t\treturn ret;\n\t}\n\n\tfor (i = 0; i < thermal_zone_get_num_trips(sensor->tzd); i++) {\n\n\t\tthermal_zone_get_trip(sensor->tzd, i, &trip);\n\n\t\tif (trip.type == THERMAL_TRIP_PASSIVE) {\n\t\t\tsensor->thres_temp = trip.temperature;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct hisi_thermal_ops hi6220_ops = {\n\t.get_temp\t= hi6220_thermal_get_temp,\n\t.enable_sensor\t= hi6220_thermal_enable_sensor,\n\t.disable_sensor\t= hi6220_thermal_disable_sensor,\n\t.irq_handler\t= hi6220_thermal_irq_handler,\n\t.probe\t\t= hi6220_thermal_probe,\n};\n\nstatic const struct hisi_thermal_ops hi3660_ops = {\n\t.get_temp\t= hi3660_thermal_get_temp,\n\t.enable_sensor\t= hi3660_thermal_enable_sensor,\n\t.disable_sensor\t= hi3660_thermal_disable_sensor,\n\t.irq_handler\t= hi3660_thermal_irq_handler,\n\t.probe\t\t= hi3660_thermal_probe,\n};\n\nstatic const struct of_device_id of_hisi_thermal_match[] = {\n\t{\n\t\t.compatible = \"hisilicon,tsensor\",\n\t\t.data = &hi6220_ops,\n\t},\n\t{\n\t\t.compatible = \"hisilicon,hi3660-tsensor\",\n\t\t.data = &hi3660_ops,\n\t},\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, of_hisi_thermal_match);\n\nstatic void hisi_thermal_toggle_sensor(struct hisi_thermal_sensor *sensor,\n\t\t\t\t       bool on)\n{\n\tstruct thermal_zone_device *tzd = sensor->tzd;\n\n\tif (on)\n\t\tthermal_zone_device_enable(tzd);\n\telse\n\t\tthermal_zone_device_disable(tzd);\n}\n\nstatic int hisi_thermal_probe(struct platform_device *pdev)\n{\n\tstruct hisi_thermal_data *data;\n\tstruct device *dev = &pdev->dev;\n\tint i, ret;\n\n\tdata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tdata->pdev = pdev;\n\tplatform_set_drvdata(pdev, data);\n\tdata->ops = of_device_get_match_data(dev);\n\n\tdata->regs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(data->regs))\n\t\treturn PTR_ERR(data->regs);\n\n\tret = data->ops->probe(data);\n\tif (ret)\n\t\treturn ret;\n\n\tfor (i = 0; i < data->nr_sensors; i++) {\n\t\tstruct hisi_thermal_sensor *sensor = &data->sensor[i];\n\n\t\tret = hisi_thermal_register_sensor(pdev, sensor);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"failed to register thermal sensor: %d\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = platform_get_irq(pdev, 0);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tret = devm_request_threaded_irq(dev, ret, NULL,\n\t\t\t\t\t\thisi_thermal_alarm_irq_thread,\n\t\t\t\t\t\tIRQF_ONESHOT, sensor->irq_name,\n\t\t\t\t\t\tsensor);\n\t\tif (ret < 0) {\n\t\t\tdev_err(dev, \"Failed to request alarm irq: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = data->ops->enable_sensor(sensor);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to setup the sensor: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\thisi_thermal_toggle_sensor(sensor, true);\n\t}\n\n\treturn 0;\n}\n\nstatic int hisi_thermal_remove(struct platform_device *pdev)\n{\n\tstruct hisi_thermal_data *data = platform_get_drvdata(pdev);\n\tint i;\n\n\tfor (i = 0; i < data->nr_sensors; i++) {\n\t\tstruct hisi_thermal_sensor *sensor = &data->sensor[i];\n\n\t\thisi_thermal_toggle_sensor(sensor, false);\n\t\tdata->ops->disable_sensor(sensor);\n\t}\n\n\treturn 0;\n}\n\nstatic int hisi_thermal_suspend(struct device *dev)\n{\n\tstruct hisi_thermal_data *data = dev_get_drvdata(dev);\n\tint i;\n\n\tfor (i = 0; i < data->nr_sensors; i++)\n\t\tdata->ops->disable_sensor(&data->sensor[i]);\n\n\treturn 0;\n}\n\nstatic int hisi_thermal_resume(struct device *dev)\n{\n\tstruct hisi_thermal_data *data = dev_get_drvdata(dev);\n\tint i, ret = 0;\n\n\tfor (i = 0; i < data->nr_sensors; i++)\n\t\tret |= data->ops->enable_sensor(&data->sensor[i]);\n\n\treturn ret;\n}\n\nstatic DEFINE_SIMPLE_DEV_PM_OPS(hisi_thermal_pm_ops,\n\t\t\t hisi_thermal_suspend, hisi_thermal_resume);\n\nstatic struct platform_driver hisi_thermal_driver = {\n\t.driver = {\n\t\t.name\t\t= \"hisi_thermal\",\n\t\t.pm\t\t= pm_sleep_ptr(&hisi_thermal_pm_ops),\n\t\t.of_match_table = of_hisi_thermal_match,\n\t},\n\t.probe\t= hisi_thermal_probe,\n\t.remove\t= hisi_thermal_remove,\n};\n\nmodule_platform_driver(hisi_thermal_driver);\n\nMODULE_AUTHOR(\"Xinwei Kong <kong.kongxinwei@hisilicon.com>\");\nMODULE_AUTHOR(\"Leo Yan <leo.yan@linaro.org>\");\nMODULE_DESCRIPTION(\"HiSilicon thermal driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}