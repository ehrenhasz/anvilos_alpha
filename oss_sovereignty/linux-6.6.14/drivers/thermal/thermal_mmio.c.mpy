{
  "module_name": "thermal_mmio.c",
  "hash_id": "3b469e47364b2c048db22170fa4a2a185f90e1a3c03b49d0156cad4aac92d7b3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/thermal_mmio.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/of_address.h>\n#include <linux/platform_device.h>\n#include <linux/thermal.h>\n\nstruct thermal_mmio {\n\tvoid __iomem *mmio_base;\n\tu32 (*read_mmio)(void __iomem *mmio_base);\n\tu32 mask;\n\tint factor;\n};\n\nstatic u32 thermal_mmio_readb(void __iomem *mmio_base)\n{\n\treturn readb(mmio_base);\n}\n\nstatic int thermal_mmio_get_temperature(struct thermal_zone_device *tz, int *temp)\n{\n\tint t;\n\tstruct thermal_mmio *sensor = thermal_zone_device_priv(tz);\n\n\tt = sensor->read_mmio(sensor->mmio_base) & sensor->mask;\n\tt *= sensor->factor;\n\n\t*temp = t;\n\n\treturn 0;\n}\n\nstatic const struct thermal_zone_device_ops thermal_mmio_ops = {\n\t.get_temp = thermal_mmio_get_temperature,\n};\n\nstatic int thermal_mmio_probe(struct platform_device *pdev)\n{\n\tstruct thermal_mmio *sensor;\n\tint (*sensor_init_func)(struct platform_device *pdev,\n\t\t\t\tstruct thermal_mmio *sensor);\n\tstruct thermal_zone_device *thermal_zone;\n\tint ret;\n\tint temperature;\n\n\tsensor = devm_kzalloc(&pdev->dev, sizeof(*sensor), GFP_KERNEL);\n\tif (!sensor)\n\t\treturn -ENOMEM;\n\n\tsensor->mmio_base = devm_platform_get_and_ioremap_resource(pdev, 0, NULL);\n\tif (IS_ERR(sensor->mmio_base))\n\t\treturn PTR_ERR(sensor->mmio_base);\n\n\tsensor_init_func = device_get_match_data(&pdev->dev);\n\tif (sensor_init_func) {\n\t\tret = sensor_init_func(pdev, sensor);\n\t\tif (ret) {\n\t\t\tdev_err(&pdev->dev,\n\t\t\t\t\"failed to initialize sensor (%d)\\n\",\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tthermal_zone = devm_thermal_of_zone_register(&pdev->dev,\n\t\t\t\t\t\t     0,\n\t\t\t\t\t\t     sensor,\n\t\t\t\t\t\t     &thermal_mmio_ops);\n\tif (IS_ERR(thermal_zone)) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"failed to register sensor (%ld)\\n\",\n\t\t\tPTR_ERR(thermal_zone));\n\t\treturn PTR_ERR(thermal_zone);\n\t}\n\n\tthermal_mmio_get_temperature(thermal_zone, &temperature);\n\tdev_info(&pdev->dev,\n\t\t \"thermal mmio sensor %s registered, current temperature: %d\\n\",\n\t\t pdev->name, temperature);\n\n\treturn 0;\n}\n\nstatic int al_thermal_init(struct platform_device *pdev,\n\t\t\t   struct thermal_mmio *sensor)\n{\n\tsensor->read_mmio = thermal_mmio_readb;\n\tsensor->mask = 0xff;\n\tsensor->factor = 1000;\n\n\treturn 0;\n}\n\nstatic const struct of_device_id thermal_mmio_id_table[] = {\n\t{ .compatible = \"amazon,al-thermal\", .data = al_thermal_init},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, thermal_mmio_id_table);\n\nstatic struct platform_driver thermal_mmio_driver = {\n\t.probe = thermal_mmio_probe,\n\t.driver = {\n\t\t.name = \"thermal-mmio\",\n\t\t.of_match_table = thermal_mmio_id_table,\n\t},\n};\n\nmodule_platform_driver(thermal_mmio_driver);\n\nMODULE_AUTHOR(\"Talel Shenhar <talel@amazon.com>\");\nMODULE_DESCRIPTION(\"Thermal MMIO Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}