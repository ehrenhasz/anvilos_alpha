{
  "module_name": "loongson2_thermal.c",
  "hash_id": "931858c81710f1ef91c985cbabc6ee2669a5f5303403f06b992c87e178008ae9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/loongson2_thermal.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/minmax.h>\n#include <linux/module.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n#include <linux/thermal.h>\n#include <linux/units.h>\n#include \"thermal_hwmon.h\"\n\n#define LOONGSON2_MAX_SENSOR_SEL_NUM\t\t\t3\n\n#define LOONGSON2_THSENS_CTRL_HI_REG\t\t\t0x0\n#define LOONGSON2_THSENS_CTRL_LOW_REG\t\t\t0x8\n#define LOONGSON2_THSENS_STATUS_REG\t\t\t0x10\n#define LOONGSON2_THSENS_OUT_REG\t\t\t0x14\n\n#define LOONGSON2_THSENS_INT_LO\t\t\t\tBIT(0)\n#define LOONGSON2_THSENS_INT_HIGH\t\t\tBIT(1)\n#define LOONGSON2_THSENS_OUT_MASK\t\t\t0xFF\n\nstruct loongson2_thermal_chip_data {\n\tunsigned int\tthermal_sensor_sel;\n};\n\nstruct loongson2_thermal_data {\n\tvoid __iomem\t*regs;\n\tconst struct loongson2_thermal_chip_data *chip_data;\n};\n\nstatic int loongson2_thermal_set(struct loongson2_thermal_data *data,\n\t\t\t\t\tint low, int high, bool enable)\n{\n\tu64 reg_ctrl = 0;\n\tint reg_off = data->chip_data->thermal_sensor_sel * 2;\n\n\tlow = clamp(-40, low, high);\n\thigh = clamp(125, low, high);\n\n\tlow += HECTO;\n\thigh += HECTO;\n\n\treg_ctrl = low;\n\treg_ctrl |= enable ? 0x100 : 0;\n\twritew(reg_ctrl, data->regs + LOONGSON2_THSENS_CTRL_LOW_REG + reg_off);\n\n\treg_ctrl = high;\n\treg_ctrl |= enable ? 0x100 : 0;\n\twritew(reg_ctrl, data->regs + LOONGSON2_THSENS_CTRL_HI_REG + reg_off);\n\n\treturn 0;\n}\n\nstatic int loongson2_thermal_get_temp(struct thermal_zone_device *tz, int *temp)\n{\n\tu32 reg_val;\n\tstruct loongson2_thermal_data *data = thermal_zone_device_priv(tz);\n\n\treg_val = readl(data->regs + LOONGSON2_THSENS_OUT_REG);\n\t*temp = ((reg_val & LOONGSON2_THSENS_OUT_MASK) - HECTO) * KILO;\n\n\treturn 0;\n}\n\nstatic irqreturn_t loongson2_thermal_irq_thread(int irq, void *dev)\n{\n\tstruct thermal_zone_device *tzd = dev;\n\tstruct loongson2_thermal_data *data = thermal_zone_device_priv(tzd);\n\n\twriteb(LOONGSON2_THSENS_INT_LO | LOONGSON2_THSENS_INT_HIGH, data->regs +\n\t\tLOONGSON2_THSENS_STATUS_REG);\n\n\tthermal_zone_device_update(tzd, THERMAL_EVENT_UNSPECIFIED);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int loongson2_thermal_set_trips(struct thermal_zone_device *tz, int low, int high)\n{\n\tstruct loongson2_thermal_data *data = thermal_zone_device_priv(tz);\n\n\treturn loongson2_thermal_set(data, low/MILLI, high/MILLI, true);\n}\n\nstatic const struct thermal_zone_device_ops loongson2_of_thermal_ops = {\n\t.get_temp = loongson2_thermal_get_temp,\n\t.set_trips = loongson2_thermal_set_trips,\n};\n\nstatic int loongson2_thermal_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct loongson2_thermal_data *data;\n\tstruct thermal_zone_device *tzd;\n\tint ret, irq, i;\n\n\tdata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tdata->chip_data = device_get_match_data(dev);\n\n\tdata->regs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(data->regs))\n\t\treturn PTR_ERR(data->regs);\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\twriteb(LOONGSON2_THSENS_INT_LO | LOONGSON2_THSENS_INT_HIGH, data->regs +\n\t\tLOONGSON2_THSENS_STATUS_REG);\n\n\tloongson2_thermal_set(data, 0, 0, false);\n\n\tfor (i = 0; i <= LOONGSON2_MAX_SENSOR_SEL_NUM; i++) {\n\t\ttzd = devm_thermal_of_zone_register(dev, i, data,\n\t\t\t&loongson2_of_thermal_ops);\n\n\t\tif (!IS_ERR(tzd))\n\t\t\tbreak;\n\n\t\tif (PTR_ERR(tzd) != -ENODEV)\n\t\t\tcontinue;\n\n\t\treturn dev_err_probe(dev, PTR_ERR(tzd), \"failed to register\");\n\t}\n\n\tret = devm_request_threaded_irq(dev, irq, NULL, loongson2_thermal_irq_thread,\n\t\t\tIRQF_ONESHOT, \"loongson2_thermal\", tzd);\n\tif (ret < 0)\n\t\treturn dev_err_probe(dev, ret, \"failed to request alarm irq\\n\");\n\n\tdevm_thermal_add_hwmon_sysfs(dev, tzd);\n\n\treturn 0;\n}\n\nstatic const struct loongson2_thermal_chip_data loongson2_thermal_ls2k1000_data = {\n\t.thermal_sensor_sel = 0,\n};\n\nstatic const struct of_device_id of_loongson2_thermal_match[] = {\n\t{\n\t\t.compatible = \"loongson,ls2k1000-thermal\",\n\t\t.data = &loongson2_thermal_ls2k1000_data,\n\t},\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, of_loongson2_thermal_match);\n\nstatic struct platform_driver loongson2_thermal_driver = {\n\t.driver = {\n\t\t.name\t\t= \"loongson2_thermal\",\n\t\t.of_match_table = of_loongson2_thermal_match,\n\t},\n\t.probe\t= loongson2_thermal_probe,\n};\nmodule_platform_driver(loongson2_thermal_driver);\n\nMODULE_DESCRIPTION(\"Loongson2 thermal driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}