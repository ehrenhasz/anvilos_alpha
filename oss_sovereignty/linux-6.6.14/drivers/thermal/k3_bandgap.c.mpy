{
  "module_name": "k3_bandgap.c",
  "hash_id": "ea1fc34d944d3558db5e55ba9ed517d671ffa91c850323e3e1a02375184b6930",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/k3_bandgap.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include <linux/thermal.h>\n#include <linux/types.h>\n\n#include \"thermal_hwmon.h\"\n\n#define K3_VTM_DEVINFO_PWR0_OFFSET\t\t0x4\n#define K3_VTM_DEVINFO_PWR0_TEMPSENS_CT_MASK\t0xf0\n#define K3_VTM_TMPSENS0_CTRL_OFFSET\t0x80\n#define K3_VTM_REGS_PER_TS\t\t\t0x10\n#define K3_VTM_TS_STAT_DTEMP_MASK\t0x3ff\n#define K3_VTM_TMPSENS_CTRL_CBIASSEL\tBIT(0)\n#define K3_VTM_TMPSENS_CTRL_SOC\t\tBIT(5)\n#define K3_VTM_TMPSENS_CTRL_CLRZ\t\tBIT(6)\n#define K3_VTM_TMPSENS_CTRL_CLKON_REQ\tBIT(7)\n\n#define K3_VTM_ADC_BEGIN_VAL\t\t540\n#define K3_VTM_ADC_END_VAL\t\t944\n\nstatic const int k3_adc_to_temp[] = {\n\t-40000, -40000, -40000, -40000, -39800, -39400, -39000, -38600, -38200,\n\t-37800, -37400, -37000, -36600, -36200, -35800, -35300, -34700, -34200,\n\t-33800, -33400, -33000, -32600, -32200, -31800, -31400, -31000, -30600,\n\t-30200, -29800, -29400, -29000, -28600, -28200, -27700, -27100, -26600,\n\t-26200, -25800, -25400, -25000, -24600, -24200, -23800, -23400, -23000,\n\t-22600, -22200, -21800, -21400, -21000, -20500, -19900, -19400, -19000,\n\t-18600, -18200, -17800, -17400, -17000, -16600, -16200, -15800, -15400,\n\t-15000, -14600, -14200, -13800, -13400, -13000, -12500, -11900, -11400,\n\t-11000, -10600, -10200, -9800, -9400, -9000, -8600, -8200, -7800, -7400,\n\t-7000, -6600, -6200, -5800, -5400, -5000, -4500, -3900, -3400, -3000,\n\t-2600, -2200, -1800, -1400, -1000, -600, -200, 200, 600, 1000, 1400,\n\t1800, 2200, 2600, 3000, 3400, 3900, 4500, 5000, 5400, 5800, 6200, 6600,\n\t7000, 7400, 7800, 8200, 8600, 9000, 9400, 9800, 10200, 10600, 11000,\n\t11400, 11800, 12200, 12700, 13300, 13800, 14200, 14600, 15000, 15400,\n\t15800, 16200, 16600, 17000, 17400, 17800, 18200, 18600, 19000, 19400,\n\t19800, 20200, 20600, 21000, 21400, 21900, 22500, 23000, 23400, 23800,\n\t24200, 24600, 25000, 25400, 25800, 26200, 26600, 27000, 27400, 27800,\n\t28200, 28600, 29000, 29400, 29800, 30200, 30600, 31000, 31400, 31900,\n\t32500, 33000, 33400, 33800, 34200, 34600, 35000, 35400, 35800, 36200,\n\t36600, 37000, 37400, 37800, 38200, 38600, 39000, 39400, 39800, 40200,\n\t40600, 41000, 41400, 41800, 42200, 42600, 43100, 43700, 44200, 44600,\n\t45000, 45400, 45800, 46200, 46600, 47000, 47400, 47800, 48200, 48600,\n\t49000, 49400, 49800, 50200, 50600, 51000, 51400, 51800, 52200, 52600,\n\t53000, 53400, 53800, 54200, 54600, 55000, 55400, 55900, 56500, 57000,\n\t57400, 57800, 58200, 58600, 59000, 59400, 59800, 60200, 60600, 61000,\n\t61400, 61800, 62200, 62600, 63000, 63400, 63800, 64200, 64600, 65000,\n\t65400, 65800, 66200, 66600, 67000, 67400, 67800, 68200, 68600, 69000,\n\t69400, 69800, 70200, 70600, 71000, 71500, 72100, 72600, 73000, 73400,\n\t73800, 74200, 74600, 75000, 75400, 75800, 76200, 76600, 77000, 77400,\n\t77800, 78200, 78600, 79000, 79400, 79800, 80200, 80600, 81000, 81400,\n\t81800, 82200, 82600, 83000, 83400, 83800, 84200, 84600, 85000, 85400,\n\t85800, 86200, 86600, 87000, 87400, 87800, 88200, 88600, 89000, 89400,\n\t89800, 90200, 90600, 91000, 91400, 91800, 92200, 92600, 93000, 93400,\n\t93800, 94200, 94600, 95000, 95400, 95800, 96200, 96600, 97000, 97500,\n\t98100, 98600, 99000, 99400, 99800, 100200, 100600, 101000, 101400,\n\t101800, 102200, 102600, 103000, 103400, 103800, 104200, 104600, 105000,\n\t105400, 105800, 106200, 106600, 107000, 107400, 107800, 108200, 108600,\n\t109000, 109400, 109800, 110200, 110600, 111000, 111400, 111800, 112200,\n\t112600, 113000, 113400, 113800, 114200, 114600, 115000, 115400, 115800,\n\t116200, 116600, 117000, 117400, 117800, 118200, 118600, 119000, 119400,\n\t119800, 120200, 120600, 121000, 121400, 121800, 122200, 122600, 123000,\n\t123400, 123800, 124200, 124600, 124900, 125000,\n};\n\nstruct k3_bandgap {\n\tvoid __iomem *base;\n\tconst struct k3_bandgap_data *conf;\n};\n\n \nstruct k3_thermal_data {\n\tstruct thermal_zone_device *tzd;\n\tstruct k3_bandgap *bgp;\n\tint sensor_id;\n\tu32 ctrl_offset;\n\tu32 stat_offset;\n};\n\nstatic unsigned int vtm_get_best_value(unsigned int s0, unsigned int s1,\n\t\t\t\t       unsigned int s2)\n{\n\tint d01 = abs(s0 - s1);\n\tint d02 = abs(s0 - s2);\n\tint d12 = abs(s1 - s2);\n\n\tif (d01 <= d02 && d01 <= d12)\n\t\treturn (s0 + s1) / 2;\n\n\tif (d02 <= d01 && d02 <= d12)\n\t\treturn (s0 + s2) / 2;\n\n\treturn (s1 + s2) / 2;\n}\n\nstatic int k3_bgp_read_temp(struct k3_thermal_data *devdata,\n\t\t\t    int *temp)\n{\n\tstruct k3_bandgap *bgp;\n\tunsigned int dtemp, s0, s1, s2;\n\n\tbgp = devdata->bgp;\n\n\t \n\ts0 = readl(bgp->base + devdata->stat_offset) &\n\t\tK3_VTM_TS_STAT_DTEMP_MASK;\n\ts1 = readl(bgp->base + devdata->stat_offset) &\n\t\tK3_VTM_TS_STAT_DTEMP_MASK;\n\ts2 = readl(bgp->base + devdata->stat_offset) &\n\t\tK3_VTM_TS_STAT_DTEMP_MASK;\n\tdtemp = vtm_get_best_value(s0, s1, s2);\n\n\tif (dtemp < K3_VTM_ADC_BEGIN_VAL || dtemp > K3_VTM_ADC_END_VAL)\n\t\treturn -EINVAL;\n\n\t*temp = k3_adc_to_temp[dtemp - K3_VTM_ADC_BEGIN_VAL];\n\n\treturn 0;\n}\n\nstatic int k3_thermal_get_temp(struct thermal_zone_device *tz, int *temp)\n{\n\tstruct k3_thermal_data *data = thermal_zone_device_priv(tz);\n\tint ret = 0;\n\n\tret = k3_bgp_read_temp(data, temp);\n\tif (ret)\n\t\treturn ret;\n\n\treturn ret;\n}\n\nstatic const struct thermal_zone_device_ops k3_of_thermal_ops = {\n\t.get_temp = k3_thermal_get_temp,\n};\n\nstatic const struct of_device_id of_k3_bandgap_match[];\n\nstatic int k3_bandgap_probe(struct platform_device *pdev)\n{\n\tint ret = 0, cnt, val, id;\n\tstruct resource *res;\n\tstruct device *dev = &pdev->dev;\n\tstruct k3_bandgap *bgp;\n\tstruct k3_thermal_data *data;\n\n\tif (ARRAY_SIZE(k3_adc_to_temp) != (K3_VTM_ADC_END_VAL + 1 -\n\t\t\t\t\t\tK3_VTM_ADC_BEGIN_VAL))\n\t\treturn -EINVAL;\n\n\tbgp = devm_kzalloc(&pdev->dev, sizeof(*bgp), GFP_KERNEL);\n\tif (!bgp)\n\t\treturn -ENOMEM;\n\n\tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tbgp->base = devm_ioremap_resource(dev, res);\n\tif (IS_ERR(bgp->base))\n\t\treturn PTR_ERR(bgp->base);\n\n\tpm_runtime_enable(dev);\n\tret = pm_runtime_get_sync(dev);\n\tif (ret < 0) {\n\t\tpm_runtime_put_noidle(dev);\n\t\tpm_runtime_disable(dev);\n\t\treturn ret;\n\t}\n\n\t \n\tval = readl(bgp->base + K3_VTM_DEVINFO_PWR0_OFFSET);\n\tcnt = val & K3_VTM_DEVINFO_PWR0_TEMPSENS_CT_MASK;\n\tcnt >>= __ffs(K3_VTM_DEVINFO_PWR0_TEMPSENS_CT_MASK);\n\n\tdata = devm_kcalloc(dev, cnt, sizeof(*data), GFP_KERNEL);\n\tif (!data) {\n\t\tret = -ENOMEM;\n\t\tgoto err_alloc;\n\t}\n\n\t \n\tfor (id = 0; id < cnt; id++) {\n\t\tdata[id].sensor_id = id;\n\t\tdata[id].bgp = bgp;\n\t\tdata[id].ctrl_offset = K3_VTM_TMPSENS0_CTRL_OFFSET +\n\t\t\t\t\tid * K3_VTM_REGS_PER_TS;\n\t\tdata[id].stat_offset = data[id].ctrl_offset + 0x8;\n\n\t\tval = readl(data[id].bgp->base + data[id].ctrl_offset);\n\t\tval |= (K3_VTM_TMPSENS_CTRL_SOC |\n\t\t\tK3_VTM_TMPSENS_CTRL_CLRZ |\n\t\t\tK3_VTM_TMPSENS_CTRL_CLKON_REQ);\n\t\tval &= ~K3_VTM_TMPSENS_CTRL_CBIASSEL;\n\t\twritel(val, data[id].bgp->base + data[id].ctrl_offset);\n\n\t\tdata[id].tzd =\n\t\tdevm_thermal_of_zone_register(dev, id,\n\t\t\t\t\t      &data[id],\n\t\t\t\t\t      &k3_of_thermal_ops);\n\t\tif (IS_ERR(data[id].tzd)) {\n\t\t\tdev_err(dev, \"thermal zone device is NULL\\n\");\n\t\t\tret = PTR_ERR(data[id].tzd);\n\t\t\tgoto err_alloc;\n\t\t}\n\n\t\tdevm_thermal_add_hwmon_sysfs(dev, data[id].tzd);\n\t}\n\n\n\treturn 0;\n\nerr_alloc:\n\tpm_runtime_put_sync(dev);\n\tpm_runtime_disable(dev);\n\n\treturn ret;\n}\n\nstatic int k3_bandgap_remove(struct platform_device *pdev)\n{\n\tpm_runtime_put_sync(&pdev->dev);\n\tpm_runtime_disable(&pdev->dev);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id of_k3_bandgap_match[] = {\n\t{\n\t\t.compatible = \"ti,am654-vtm\",\n\t},\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, of_k3_bandgap_match);\n\nstatic struct platform_driver k3_bandgap_sensor_driver = {\n\t.probe = k3_bandgap_probe,\n\t.remove = k3_bandgap_remove,\n\t.driver = {\n\t\t.name = \"k3-soc-thermal\",\n\t\t.of_match_table\t= of_k3_bandgap_match,\n\t},\n};\n\nmodule_platform_driver(k3_bandgap_sensor_driver);\n\nMODULE_DESCRIPTION(\"K3 bandgap temperature sensor driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"J Keerthy <j-keerthy@ti.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}