{
  "module_name": "da9062-thermal.c",
  "hash_id": "6d9c0f1863c4b4e973c462eed5046f48718323375a72acbda3853f64f5d9e936",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/da9062-thermal.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/errno.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/thermal.h>\n#include <linux/workqueue.h>\n\n#include <linux/mfd/da9062/core.h>\n#include <linux/mfd/da9062/registers.h>\n\n \n#define DA9062_DEFAULT_POLLING_MS_PERIOD\t3000\n#define DA9062_MAX_POLLING_MS_PERIOD\t\t10000\n#define DA9062_MIN_POLLING_MS_PERIOD\t\t1000\n\n#define DA9062_MILLI_CELSIUS(t)\t\t\t((t) * 1000)\n\nstatic unsigned int pp_tmp = DA9062_DEFAULT_POLLING_MS_PERIOD;\n\nstruct da9062_thermal_config {\n\tconst char *name;\n};\n\nstruct da9062_thermal {\n\tstruct da9062 *hw;\n\tstruct delayed_work work;\n\tstruct thermal_zone_device *zone;\n\tstruct mutex lock;  \n\tint temperature;\n\tint irq;\n\tconst struct da9062_thermal_config *config;\n\tstruct device *dev;\n};\n\nstatic void da9062_thermal_poll_on(struct work_struct *work)\n{\n\tstruct da9062_thermal *thermal = container_of(work,\n\t\t\t\t\t\tstruct da9062_thermal,\n\t\t\t\t\t\twork.work);\n\tunsigned long delay;\n\tunsigned int val;\n\tint ret;\n\n\t \n\tret = regmap_write(thermal->hw->regmap,\n\t\t\t   DA9062AA_EVENT_B,\n\t\t\t   DA9062AA_E_TEMP_MASK);\n\tif (ret < 0) {\n\t\tdev_err(thermal->dev,\n\t\t\t\"Cannot clear the TJUNC temperature status\\n\");\n\t\tgoto err_enable_irq;\n\t}\n\n\t \n\tret = regmap_read(thermal->hw->regmap,\n\t\t\t  DA9062AA_EVENT_B,\n\t\t\t  &val);\n\tif (ret < 0) {\n\t\tdev_err(thermal->dev,\n\t\t\t\"Cannot check the TJUNC temperature status\\n\");\n\t\tgoto err_enable_irq;\n\t}\n\n\tif (val & DA9062AA_E_TEMP_MASK) {\n\t\tmutex_lock(&thermal->lock);\n\t\tthermal->temperature = DA9062_MILLI_CELSIUS(125);\n\t\tmutex_unlock(&thermal->lock);\n\t\tthermal_zone_device_update(thermal->zone,\n\t\t\t\t\t   THERMAL_EVENT_UNSPECIFIED);\n\n\t\t \n\t\tdelay = round_jiffies(msecs_to_jiffies(pp_tmp));\n\t\tqueue_delayed_work(system_freezable_wq, &thermal->work, delay);\n\t\treturn;\n\t}\n\n\tmutex_lock(&thermal->lock);\n\tthermal->temperature = DA9062_MILLI_CELSIUS(0);\n\tmutex_unlock(&thermal->lock);\n\tthermal_zone_device_update(thermal->zone,\n\t\t\t\t   THERMAL_EVENT_UNSPECIFIED);\n\nerr_enable_irq:\n\tenable_irq(thermal->irq);\n}\n\nstatic irqreturn_t da9062_thermal_irq_handler(int irq, void *data)\n{\n\tstruct da9062_thermal *thermal = data;\n\n\tdisable_irq_nosync(thermal->irq);\n\tqueue_delayed_work(system_freezable_wq, &thermal->work, 0);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int da9062_thermal_get_temp(struct thermal_zone_device *z,\n\t\t\t\t   int *temp)\n{\n\tstruct da9062_thermal *thermal = thermal_zone_device_priv(z);\n\n\tmutex_lock(&thermal->lock);\n\t*temp = thermal->temperature;\n\tmutex_unlock(&thermal->lock);\n\n\treturn 0;\n}\n\nstatic struct thermal_zone_device_ops da9062_thermal_ops = {\n\t.get_temp\t= da9062_thermal_get_temp,\n};\n\nstatic struct thermal_trip trips[] = {\n\t{ .temperature = DA9062_MILLI_CELSIUS(125), .type = THERMAL_TRIP_HOT },\n};\n\nstatic const struct da9062_thermal_config da9062_config = {\n\t.name = \"da9062-thermal\",\n};\n\nstatic const struct of_device_id da9062_compatible_reg_id_table[] = {\n\t{ .compatible = \"dlg,da9062-thermal\", .data = &da9062_config },\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(of, da9062_compatible_reg_id_table);\n\nstatic int da9062_thermal_probe(struct platform_device *pdev)\n{\n\tstruct da9062 *chip = dev_get_drvdata(pdev->dev.parent);\n\tstruct da9062_thermal *thermal;\n\tconst struct of_device_id *match;\n\tint ret = 0;\n\n\tmatch = of_match_node(da9062_compatible_reg_id_table,\n\t\t\t      pdev->dev.of_node);\n\tif (!match)\n\t\treturn -ENXIO;\n\n\tif (pdev->dev.of_node) {\n\t\tif (!of_property_read_u32(pdev->dev.of_node,\n\t\t\t\t\t  \"polling-delay-passive\",\n\t\t\t\t\t  &pp_tmp)) {\n\t\t\tif (pp_tmp < DA9062_MIN_POLLING_MS_PERIOD ||\n\t\t\t    pp_tmp > DA9062_MAX_POLLING_MS_PERIOD) {\n\t\t\t\tdev_warn(&pdev->dev,\n\t\t\t\t\t \"Out-of-range polling period %d ms\\n\",\n\t\t\t\t\t pp_tmp);\n\t\t\t\tpp_tmp = DA9062_DEFAULT_POLLING_MS_PERIOD;\n\t\t\t}\n\t\t}\n\t}\n\n\tthermal = devm_kzalloc(&pdev->dev, sizeof(struct da9062_thermal),\n\t\t\t       GFP_KERNEL);\n\tif (!thermal) {\n\t\tret = -ENOMEM;\n\t\tgoto err;\n\t}\n\n\tthermal->config = match->data;\n\tthermal->hw = chip;\n\tthermal->dev = &pdev->dev;\n\n\tINIT_DELAYED_WORK(&thermal->work, da9062_thermal_poll_on);\n\tmutex_init(&thermal->lock);\n\n\tthermal->zone = thermal_zone_device_register_with_trips(thermal->config->name,\n\t\t\t\t\t\t\t\ttrips, ARRAY_SIZE(trips), 0, thermal,\n\t\t\t\t\t\t\t\t&da9062_thermal_ops, NULL, pp_tmp,\n\t\t\t\t\t\t\t\t0);\n\tif (IS_ERR(thermal->zone)) {\n\t\tdev_err(&pdev->dev, \"Cannot register thermal zone device\\n\");\n\t\tret = PTR_ERR(thermal->zone);\n\t\tgoto err;\n\t}\n\tret = thermal_zone_device_enable(thermal->zone);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Cannot enable thermal zone device\\n\");\n\t\tgoto err_zone;\n\t}\n\n\tdev_dbg(&pdev->dev,\n\t\t\"TJUNC temperature polling period set at %d ms\\n\", pp_tmp);\n\n\tret = platform_get_irq_byname(pdev, \"THERMAL\");\n\tif (ret < 0)\n\t\tgoto err_zone;\n\n\tthermal->irq = ret;\n\n\tret = request_threaded_irq(thermal->irq, NULL,\n\t\t\t\t   da9062_thermal_irq_handler,\n\t\t\t\t   IRQF_TRIGGER_LOW | IRQF_ONESHOT,\n\t\t\t\t   \"THERMAL\", thermal);\n\tif (ret) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Failed to request thermal device IRQ.\\n\");\n\t\tgoto err_zone;\n\t}\n\n\tplatform_set_drvdata(pdev, thermal);\n\treturn 0;\n\nerr_zone:\n\tthermal_zone_device_unregister(thermal->zone);\nerr:\n\treturn ret;\n}\n\nstatic int da9062_thermal_remove(struct platform_device *pdev)\n{\n\tstruct\tda9062_thermal *thermal = platform_get_drvdata(pdev);\n\n\tfree_irq(thermal->irq, thermal);\n\tcancel_delayed_work_sync(&thermal->work);\n\tthermal_zone_device_unregister(thermal->zone);\n\treturn 0;\n}\n\nstatic struct platform_driver da9062_thermal_driver = {\n\t.probe\t= da9062_thermal_probe,\n\t.remove\t= da9062_thermal_remove,\n\t.driver\t= {\n\t\t.name\t= \"da9062-thermal\",\n\t\t.of_match_table = da9062_compatible_reg_id_table,\n\t},\n};\n\nmodule_platform_driver(da9062_thermal_driver);\n\nMODULE_AUTHOR(\"Steve Twiss\");\nMODULE_DESCRIPTION(\"Thermal TJUNC device driver for Dialog DA9062 and DA9061\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:da9062-thermal\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}