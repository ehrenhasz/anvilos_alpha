{
  "module_name": "tsens-8960.c",
  "hash_id": "c3476a1c2b9ff64f6e651d91b106c6b88522c86c63179edcf2ff4b9183c2634b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/qcom/tsens-8960.c",
  "human_readable_source": "\n \n\n#include <linux/platform_device.h>\n#include <linux/delay.h>\n#include <linux/bitops.h>\n#include <linux/regmap.h>\n#include <linux/thermal.h>\n#include \"tsens.h\"\n\n#define CONFIG_ADDR\t\t0x3640\n#define CONFIG_ADDR_8660\t0x3620\n \n#define CONFIG\t\t\t0x9b\n#define CONFIG_MASK\t\t0xf\n#define CONFIG_8660\t\t1\n#define CONFIG_SHIFT_8660\t28\n#define CONFIG_MASK_8660\t(3 << CONFIG_SHIFT_8660)\n\n#define CNTL_ADDR\t\t0x3620\n \n#define EN\t\t\tBIT(0)\n#define SW_RST\t\t\tBIT(1)\n\n#define MEASURE_PERIOD\t\tBIT(18)\n#define SLP_CLK_ENA\t\tBIT(26)\n#define SLP_CLK_ENA_8660\tBIT(24)\n#define SENSOR0_SHIFT\t\t3\n\n#define THRESHOLD_ADDR\t\t0x3624\n\n#define INT_STATUS_ADDR\t\t0x363c\n\n#define S0_STATUS_OFF\t\t0x3628\n#define S1_STATUS_OFF\t\t0x362c\n#define S2_STATUS_OFF\t\t0x3630\n#define S3_STATUS_OFF\t\t0x3634\n#define S4_STATUS_OFF\t\t0x3638\n#define S5_STATUS_OFF\t\t0x3664   \n#define S6_STATUS_OFF\t\t0x3668\n#define S7_STATUS_OFF\t\t0x366c\n#define S8_STATUS_OFF\t\t0x3670\n#define S9_STATUS_OFF\t\t0x3674\n#define S10_STATUS_OFF\t\t0x3678\n\n \nstatic u32 tsens_msm8960_slope[] = {\n\t\t\t826, 826, 804, 826,\n\t\t\t761, 782, 782, 849,\n\t\t\t782, 849, 782\n\t\t\t};\n\nstatic int suspend_8960(struct tsens_priv *priv)\n{\n\tint ret;\n\tunsigned int mask;\n\tstruct regmap *map = priv->tm_map;\n\n\tret = regmap_read(map, THRESHOLD_ADDR, &priv->ctx.threshold);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_read(map, CNTL_ADDR, &priv->ctx.control);\n\tif (ret)\n\t\treturn ret;\n\n\tif (priv->num_sensors > 1)\n\t\tmask = SLP_CLK_ENA | EN;\n\telse\n\t\tmask = SLP_CLK_ENA_8660 | EN;\n\n\tret = regmap_update_bits(map, CNTL_ADDR, mask, 0);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int resume_8960(struct tsens_priv *priv)\n{\n\tint ret;\n\tstruct regmap *map = priv->tm_map;\n\n\tret = regmap_update_bits(map, CNTL_ADDR, SW_RST, SW_RST);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (priv->num_sensors > 1) {\n\t\tret = regmap_update_bits(map, CONFIG_ADDR, CONFIG_MASK, CONFIG);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = regmap_write(map, THRESHOLD_ADDR, priv->ctx.threshold);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_write(map, CNTL_ADDR, priv->ctx.control);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int enable_8960(struct tsens_priv *priv, int id)\n{\n\tint ret;\n\tu32 reg, mask = BIT(id);\n\n\tret = regmap_read(priv->tm_map, CNTL_ADDR, &reg);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (id > 5)\n\t\tmask = GENMASK(10, 6);\n\n\tmask <<= SENSOR0_SHIFT;\n\n\t \n\tif ((reg & mask) == mask)\n\t\treturn 0;\n\n\tret = regmap_write(priv->tm_map, CNTL_ADDR, reg | SW_RST);\n\tif (ret)\n\t\treturn ret;\n\n\treg |= MEASURE_PERIOD;\n\n\tif (priv->num_sensors > 1)\n\t\treg |= mask | SLP_CLK_ENA | EN;\n\telse\n\t\treg |= mask | SLP_CLK_ENA_8660 | EN;\n\n\tret = regmap_write(priv->tm_map, CNTL_ADDR, reg);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic void disable_8960(struct tsens_priv *priv)\n{\n\tint ret;\n\tu32 reg_cntl;\n\tu32 mask;\n\n\tmask = GENMASK(priv->num_sensors - 1, 0);\n\tmask <<= SENSOR0_SHIFT;\n\tmask |= EN;\n\n\tret = regmap_read(priv->tm_map, CNTL_ADDR, &reg_cntl);\n\tif (ret)\n\t\treturn;\n\n\treg_cntl &= ~mask;\n\n\tif (priv->num_sensors > 1)\n\t\treg_cntl &= ~SLP_CLK_ENA;\n\telse\n\t\treg_cntl &= ~SLP_CLK_ENA_8660;\n\n\tregmap_write(priv->tm_map, CNTL_ADDR, reg_cntl);\n}\n\nstatic int calibrate_8960(struct tsens_priv *priv)\n{\n\tint i;\n\tchar *data;\n\tu32 p1[11];\n\n\tdata = qfprom_read(priv->dev, \"calib\");\n\tif (IS_ERR(data))\n\t\tdata = qfprom_read(priv->dev, \"calib_backup\");\n\tif (IS_ERR(data))\n\t\treturn PTR_ERR(data);\n\n\tfor (i = 0; i < priv->num_sensors; i++) {\n\t\tp1[i] = data[i];\n\t\tpriv->sensor[i].slope = tsens_msm8960_slope[i];\n\t}\n\n\tcompute_intercept_slope(priv, p1, NULL, ONE_PT_CALIB);\n\n\tkfree(data);\n\n\treturn 0;\n}\n\nstatic const struct reg_field tsens_8960_regfields[MAX_REGFIELDS] = {\n\t \n\t \n\n\t \n\t[TSENS_EN]     = REG_FIELD(CNTL_ADDR,  0, 0),\n\t[TSENS_SW_RST] = REG_FIELD(CNTL_ADDR,  1, 1),\n\t \n\t[SENSOR_EN]    = REG_FIELD(CNTL_ADDR,  3, 7),\n\n\t \n\t \n\t \n\n\t \n\t[LOW_THRESH_0]   = REG_FIELD(THRESHOLD_ADDR,  0,  7),\n\t[UP_THRESH_0]    = REG_FIELD(THRESHOLD_ADDR,  8, 15),\n\t \n\t[CRIT_THRESH_1]   = REG_FIELD(THRESHOLD_ADDR, 16, 23),\n\t[CRIT_THRESH_0]   = REG_FIELD(THRESHOLD_ADDR, 24, 31),\n\n\t \n\t \n\t[LOW_INT_CLEAR_0]   = REG_FIELD(CNTL_ADDR,  9,  9),\n\t[UP_INT_CLEAR_0]    = REG_FIELD(CNTL_ADDR, 10, 10),\n\n\t \n\n\t \n\t[LAST_TEMP_0]  = REG_FIELD(S0_STATUS_OFF,  0,  7),\n\t[LAST_TEMP_1]  = REG_FIELD(S1_STATUS_OFF,  0,  7),\n\t[LAST_TEMP_2]  = REG_FIELD(S2_STATUS_OFF,  0,  7),\n\t[LAST_TEMP_3]  = REG_FIELD(S3_STATUS_OFF,  0,  7),\n\t[LAST_TEMP_4]  = REG_FIELD(S4_STATUS_OFF,  0,  7),\n\t[LAST_TEMP_5]  = REG_FIELD(S5_STATUS_OFF,  0,  7),\n\t[LAST_TEMP_6]  = REG_FIELD(S6_STATUS_OFF,  0,  7),\n\t[LAST_TEMP_7]  = REG_FIELD(S7_STATUS_OFF,  0,  7),\n\t[LAST_TEMP_8]  = REG_FIELD(S8_STATUS_OFF,  0,  7),\n\t[LAST_TEMP_9]  = REG_FIELD(S9_STATUS_OFF,  0,  7),\n\t[LAST_TEMP_10] = REG_FIELD(S10_STATUS_OFF, 0,  7),\n\n\t \n\t \n\t[MIN_STATUS_0] = REG_FIELD(INT_STATUS_ADDR, 0, 0),\n\t[LOWER_STATUS_0] = REG_FIELD(INT_STATUS_ADDR, 1, 1),\n\t[UPPER_STATUS_0] = REG_FIELD(INT_STATUS_ADDR, 2, 2),\n\t \n\t[MAX_STATUS_0] = REG_FIELD(INT_STATUS_ADDR, 3, 3),\n\n\t \n\t[TRDY] = REG_FIELD(INT_STATUS_ADDR, 7, 7),\n};\n\nstatic const struct tsens_ops ops_8960 = {\n\t.init\t\t= init_common,\n\t.calibrate\t= calibrate_8960,\n\t.get_temp\t= get_temp_common,\n\t.enable\t\t= enable_8960,\n\t.disable\t= disable_8960,\n\t.suspend\t= suspend_8960,\n\t.resume\t\t= resume_8960,\n};\n\nstatic struct tsens_features tsens_8960_feat = {\n\t.ver_major\t= VER_0,\n\t.crit_int\t= 0,\n\t.combo_int\t= 0,\n\t.adc\t\t= 1,\n\t.srot_split\t= 0,\n\t.max_sensors\t= 11,\n\t.trip_min_temp\t= -40000,\n\t.trip_max_temp\t= 120000,\n};\n\nstruct tsens_plat_data data_8960 = {\n\t.num_sensors\t= 11,\n\t.ops\t\t= &ops_8960,\n\t.feat\t\t= &tsens_8960_feat,\n\t.fields\t\t= tsens_8960_regfields,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}