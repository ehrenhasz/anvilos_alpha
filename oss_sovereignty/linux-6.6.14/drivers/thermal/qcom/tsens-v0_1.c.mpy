{
  "module_name": "tsens-v0_1.c",
  "hash_id": "66b7e3099d8dcb756684e846d45a1fdede88c06a5c290a6889b432abb770f47d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/qcom/tsens-v0_1.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/nvmem-consumer.h>\n#include <linux/platform_device.h>\n#include \"tsens.h\"\n\n \n#define SROT_CTRL_OFF 0x0000\n\n \n#define TM_INT_EN_OFF\t\t\t\t0x0000\n#define TM_Sn_UPPER_LOWER_STATUS_CTRL_OFF\t0x0004\n#define TM_Sn_STATUS_OFF\t\t\t0x0030\n#define TM_TRDY_OFF\t\t\t\t0x005c\n\n \n#define BKP_SEL\t\t\t0x3\n#define BKP_REDUN_SEL\t\t0xe0000000\n\n#define BIT_APPEND\t\t0x3\n\nstatic struct tsens_legacy_calibration_format tsens_8916_nvmem = {\n\t.base_len = 7,\n\t.base_shift = 3,\n\t.sp_len = 5,\n\t.mode = { 0, 29, 1 },\n\t.invalid = { 0, 31, 1 },\n\t.base = { { 0, 0 }, { 1, 25 } },\n\t.sp = {\n\t\t{ { 0, 7 },  { 0, 12 } },\n\t\t{ { 0, 17 }, { 0, 22 } },\n\t\t{ { 0, 27 }, { 1, 0 } },\n\t\t{ { 1, 5 },  { 1, 10 } },\n\t\t{ { 1, 15 }, { 1, 20 } },\n\t},\n};\n\nstatic struct tsens_legacy_calibration_format tsens_8974_nvmem = {\n\t.base_len = 8,\n\t.base_shift = 2,\n\t.sp_len = 6,\n\t.mode = { 1, 30 },\n\t.invalid = { 3, 30 },\n\t.base = { { 0, 0 }, { 2, 12 } },\n\t.sp = {\n\t\t{ { 0, 8 },  { 2, 20 } },\n\t\t{ { 0, 14 }, { 2, 26 } },\n\t\t{ { 0, 20 }, { 3, 0 } },\n\t\t{ { 0, 26 }, { 3, 6 } },\n\t\t{ { 1, 0 },  { 3, 12 } },\n\t\t{ { 1, 6 },  { 3, 18 } },\n\t\t{ { 1, 12 }, { 3, 24 } },\n\t\t{ { 1, 18 }, { 4, 0 } },\n\t\t{ { 1, 24 }, { 4, 6 } },\n\t\t{ { 2, 0 },  { 4, 12 } },\n\t\t{ { 2, 6 },  { 4, 18 } },\n\t},\n};\n\nstatic struct tsens_legacy_calibration_format tsens_8974_backup_nvmem = {\n\t.base_len = 8,\n\t.base_shift = 2,\n\t.sp_len = 6,\n\t.mode = { 4, 30, 1 },\n\t.invalid = { 5, 30, 1 },\n\t.base = { { 0, 0 }, { 2, 18 } },\n\t.sp = {\n\t\t{ { 0, 8 },  { 2, 26 } },\n\t\t{ { 0, 14 }, { 3, 0 } },\n\t\t{ { 0, 20 }, { 3, 6 } },\n\t\t{ { 0, 26 }, { 3, 12 } },\n\t\t{ { 1, 0 },  { 3, 18 } },\n\t\t{ { 1, 6 },  { 3, 24, 1 } },\n\t\t{ { 1, 12 }, { 4, 0, 1 } },\n\t\t{ { 1, 18 }, { 4, 6, 1 } },\n\t\t{ { 2, 0 },  { 4, 12, 1 } },\n\t\t{ { 2, 6 },  { 4, 18, 1 } },\n\t\t{ { 2, 12 }, { 4, 24, 1 } },\n\t},\n};\n\nstatic int calibrate_8916(struct tsens_priv *priv)\n{\n\tu32 p1[5], p2[5];\n\tu32 *qfprom_cdata, *qfprom_csel;\n\tint mode, ret;\n\n\tret = tsens_calibrate_nvmem(priv, 3);\n\tif (!ret)\n\t\treturn 0;\n\n\tqfprom_cdata = (u32 *)qfprom_read(priv->dev, \"calib\");\n\tif (IS_ERR(qfprom_cdata))\n\t\treturn PTR_ERR(qfprom_cdata);\n\n\tqfprom_csel = (u32 *)qfprom_read(priv->dev, \"calib_sel\");\n\tif (IS_ERR(qfprom_csel)) {\n\t\tkfree(qfprom_cdata);\n\t\treturn PTR_ERR(qfprom_csel);\n\t}\n\n\tmode = tsens_read_calibration_legacy(priv, &tsens_8916_nvmem,\n\t\t\t\t\t     p1, p2,\n\t\t\t\t\t     qfprom_cdata, qfprom_csel);\n\n\tcompute_intercept_slope(priv, p1, p2, mode);\n\tkfree(qfprom_cdata);\n\tkfree(qfprom_csel);\n\n\treturn 0;\n}\n\nstatic void fixup_8974_points(int mode, u32 *p1, u32 *p2)\n{\n\tint i;\n\n\tif (mode == NO_PT_CALIB) {\n\t\tp1[0] += 2;\n\t\tp1[1] += 9;\n\t\tp1[2] += 3;\n\t\tp1[3] += 9;\n\t\tp1[4] += 5;\n\t\tp1[5] += 9;\n\t\tp1[6] += 7;\n\t\tp1[7] += 10;\n\t\tp1[8] += 8;\n\t\tp1[9] += 9;\n\t\tp1[10] += 8;\n\t} else {\n\t\tfor (i = 0; i < 11; i++) {\n\t\t\t \n\t\t\tp1[i] += BIT_APPEND;\n\t\t\tp2[i] += BIT_APPEND;\n\t\t}\n\t}\n\n}\n\nstatic int calibrate_8974_nvmem(struct tsens_priv *priv)\n{\n\tu32 p1[11], p2[11];\n\tu32 backup;\n\tint ret, mode;\n\n\tret = nvmem_cell_read_variable_le_u32(priv->dev, \"use_backup\", &backup);\n\tif (ret == -ENOENT)\n\t\tdev_warn(priv->dev, \"Please migrate to separate nvmem cells for calibration data\\n\");\n\tif (ret < 0)\n\t\treturn ret;\n\n\tmode = tsens_read_calibration(priv, 2, p1, p2, backup == BKP_SEL);\n\tif (mode < 0)\n\t\treturn mode;\n\n\tfixup_8974_points(mode, p1, p2);\n\n\tcompute_intercept_slope(priv, p1, p2, mode);\n\n\treturn 0;\n}\n\nstatic int calibrate_8974(struct tsens_priv *priv)\n{\n\tu32 p1[11], p2[11];\n\tu32 *calib, *bkp;\n\tu32 calib_redun_sel;\n\tint mode, ret;\n\n\tret = calibrate_8974_nvmem(priv);\n\tif (ret == 0)\n\t\treturn 0;\n\n\tcalib = (u32 *)qfprom_read(priv->dev, \"calib\");\n\tif (IS_ERR(calib))\n\t\treturn PTR_ERR(calib);\n\n\tbkp = (u32 *)qfprom_read(priv->dev, \"calib_backup\");\n\tif (IS_ERR(bkp)) {\n\t\tkfree(calib);\n\t\treturn PTR_ERR(bkp);\n\t}\n\n\tcalib_redun_sel = FIELD_GET(BKP_REDUN_SEL, bkp[1]);\n\n\tif (calib_redun_sel == BKP_SEL)\n\t\tmode = tsens_read_calibration_legacy(priv, &tsens_8974_backup_nvmem,\n\t\t\t\t\t\t     p1, p2,\n\t\t\t\t\t\t     bkp, calib);\n\telse\n\t\tmode = tsens_read_calibration_legacy(priv, &tsens_8974_nvmem,\n\t\t\t\t\t\t     p1, p2,\n\t\t\t\t\t\t     calib, NULL);\n\n\tfixup_8974_points(mode, p1, p2);\n\n\tcompute_intercept_slope(priv, p1, p2, mode);\n\tkfree(calib);\n\tkfree(bkp);\n\n\treturn 0;\n}\n\nstatic int __init init_8226(struct tsens_priv *priv)\n{\n\tpriv->sensor[0].slope = 2901;\n\tpriv->sensor[1].slope = 2846;\n\tpriv->sensor[2].slope = 3038;\n\tpriv->sensor[3].slope = 2955;\n\tpriv->sensor[4].slope = 2901;\n\tpriv->sensor[5].slope = 2846;\n\n\treturn init_common(priv);\n}\n\nstatic int __init init_8909(struct tsens_priv *priv)\n{\n\tint i;\n\n\tfor (i = 0; i < priv->num_sensors; ++i)\n\t\tpriv->sensor[i].slope = 3000;\n\n\tpriv->sensor[0].p1_calib_offset = 0;\n\tpriv->sensor[0].p2_calib_offset = 0;\n\tpriv->sensor[1].p1_calib_offset = -10;\n\tpriv->sensor[1].p2_calib_offset = -6;\n\tpriv->sensor[2].p1_calib_offset = 0;\n\tpriv->sensor[2].p2_calib_offset = 0;\n\tpriv->sensor[3].p1_calib_offset = -9;\n\tpriv->sensor[3].p2_calib_offset = -9;\n\tpriv->sensor[4].p1_calib_offset = -8;\n\tpriv->sensor[4].p2_calib_offset = -10;\n\n\treturn init_common(priv);\n}\n\nstatic int __init init_8939(struct tsens_priv *priv) {\n\tpriv->sensor[0].slope = 2911;\n\tpriv->sensor[1].slope = 2789;\n\tpriv->sensor[2].slope = 2906;\n\tpriv->sensor[3].slope = 2763;\n\tpriv->sensor[4].slope = 2922;\n\tpriv->sensor[5].slope = 2867;\n\tpriv->sensor[6].slope = 2833;\n\tpriv->sensor[7].slope = 2838;\n\tpriv->sensor[8].slope = 2840;\n\t \n\n\treturn init_common(priv);\n}\n\nstatic int __init init_9607(struct tsens_priv *priv)\n{\n\tint i;\n\n\tfor (i = 0; i < priv->num_sensors; ++i)\n\t\tpriv->sensor[i].slope = 3000;\n\n\tpriv->sensor[0].p1_calib_offset = 1;\n\tpriv->sensor[0].p2_calib_offset = 1;\n\tpriv->sensor[1].p1_calib_offset = -4;\n\tpriv->sensor[1].p2_calib_offset = -2;\n\tpriv->sensor[2].p1_calib_offset = 4;\n\tpriv->sensor[2].p2_calib_offset = 8;\n\tpriv->sensor[3].p1_calib_offset = -3;\n\tpriv->sensor[3].p2_calib_offset = -5;\n\tpriv->sensor[4].p1_calib_offset = -4;\n\tpriv->sensor[4].p2_calib_offset = -4;\n\n\treturn init_common(priv);\n}\n\n \n\nstatic struct tsens_features tsens_v0_1_feat = {\n\t.ver_major\t= VER_0_1,\n\t.crit_int\t= 0,\n\t.combo_int\t= 0,\n\t.adc\t\t= 1,\n\t.srot_split\t= 1,\n\t.max_sensors\t= 11,\n\t.trip_min_temp\t= -40000,\n\t.trip_max_temp\t= 120000,\n};\n\nstatic const struct reg_field tsens_v0_1_regfields[MAX_REGFIELDS] = {\n\t \n\t \n\n\t \n\t[TSENS_EN]     = REG_FIELD(SROT_CTRL_OFF, 0,  0),\n\t[TSENS_SW_RST] = REG_FIELD(SROT_CTRL_OFF, 1,  1),\n\n\t \n\t \n\t[INT_EN] = REG_FIELD(TM_INT_EN_OFF, 0, 0),\n\n\t \n\tREG_FIELD_FOR_EACH_SENSOR11(LOW_THRESH,    TM_Sn_UPPER_LOWER_STATUS_CTRL_OFF,  0,  9),\n\tREG_FIELD_FOR_EACH_SENSOR11(UP_THRESH,     TM_Sn_UPPER_LOWER_STATUS_CTRL_OFF, 10, 19),\n\n\t \n\tREG_FIELD_FOR_EACH_SENSOR11(LOW_INT_CLEAR, TM_Sn_UPPER_LOWER_STATUS_CTRL_OFF, 20, 20),\n\tREG_FIELD_FOR_EACH_SENSOR11(UP_INT_CLEAR,  TM_Sn_UPPER_LOWER_STATUS_CTRL_OFF, 21, 21),\n\n\t \n\n\t \n\tREG_FIELD_FOR_EACH_SENSOR11(LAST_TEMP,    TM_Sn_STATUS_OFF,  0,  9),\n\t \n\t \n\tREG_FIELD_FOR_EACH_SENSOR11(MIN_STATUS,   TM_Sn_STATUS_OFF, 10, 10),\n\tREG_FIELD_FOR_EACH_SENSOR11(LOWER_STATUS, TM_Sn_STATUS_OFF, 11, 11),\n\tREG_FIELD_FOR_EACH_SENSOR11(UPPER_STATUS, TM_Sn_STATUS_OFF, 12, 12),\n\t \n\tREG_FIELD_FOR_EACH_SENSOR11(MAX_STATUS,   TM_Sn_STATUS_OFF, 13, 13),\n\n\t \n\t[TRDY] = REG_FIELD(TM_TRDY_OFF, 0, 0),\n};\n\nstatic const struct tsens_ops ops_v0_1 = {\n\t.init\t\t= init_common,\n\t.calibrate\t= tsens_calibrate_common,\n\t.get_temp\t= get_temp_common,\n};\n\nstatic const struct tsens_ops ops_8226 = {\n\t.init\t\t= init_8226,\n\t.calibrate\t= tsens_calibrate_common,\n\t.get_temp\t= get_temp_common,\n};\n\nstruct tsens_plat_data data_8226 = {\n\t.num_sensors\t= 6,\n\t.ops\t\t= &ops_8226,\n\t.feat\t\t= &tsens_v0_1_feat,\n\t.fields\t= tsens_v0_1_regfields,\n};\n\nstatic const struct tsens_ops ops_8909 = {\n\t.init\t\t= init_8909,\n\t.calibrate\t= tsens_calibrate_common,\n\t.get_temp\t= get_temp_common,\n};\n\nstruct tsens_plat_data data_8909 = {\n\t.num_sensors\t= 5,\n\t.ops\t\t= &ops_8909,\n\t.feat\t\t= &tsens_v0_1_feat,\n\t.fields\t= tsens_v0_1_regfields,\n};\n\nstatic const struct tsens_ops ops_8916 = {\n\t.init\t\t= init_common,\n\t.calibrate\t= calibrate_8916,\n\t.get_temp\t= get_temp_common,\n};\n\nstruct tsens_plat_data data_8916 = {\n\t.num_sensors\t= 5,\n\t.ops\t\t= &ops_8916,\n\t.hw_ids\t\t= (unsigned int []){0, 1, 2, 4, 5 },\n\n\t.feat\t\t= &tsens_v0_1_feat,\n\t.fields\t= tsens_v0_1_regfields,\n};\n\nstatic const struct tsens_ops ops_8939 = {\n\t.init\t\t= init_8939,\n\t.calibrate\t= tsens_calibrate_common,\n\t.get_temp\t= get_temp_common,\n};\n\nstruct tsens_plat_data data_8939 = {\n\t.num_sensors\t= 9,\n\t.ops\t\t= &ops_8939,\n\t.hw_ids\t\t= (unsigned int []){ 0, 1, 2, 3, 5, 6, 7, 8, 9,   },\n\n\t.feat\t\t= &tsens_v0_1_feat,\n\t.fields\t= tsens_v0_1_regfields,\n};\n\nstatic const struct tsens_ops ops_8974 = {\n\t.init\t\t= init_common,\n\t.calibrate\t= calibrate_8974,\n\t.get_temp\t= get_temp_common,\n};\n\nstruct tsens_plat_data data_8974 = {\n\t.num_sensors\t= 11,\n\t.ops\t\t= &ops_8974,\n\t.feat\t\t= &tsens_v0_1_feat,\n\t.fields\t= tsens_v0_1_regfields,\n};\n\nstatic const struct tsens_ops ops_9607 = {\n\t.init\t\t= init_9607,\n\t.calibrate\t= tsens_calibrate_common,\n\t.get_temp\t= get_temp_common,\n};\n\nstruct tsens_plat_data data_9607 = {\n\t.num_sensors\t= 5,\n\t.ops\t\t= &ops_9607,\n\t.feat\t\t= &tsens_v0_1_feat,\n\t.fields\t= tsens_v0_1_regfields,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}