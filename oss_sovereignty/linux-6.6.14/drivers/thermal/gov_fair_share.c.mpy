{
  "module_name": "gov_fair_share.c",
  "hash_id": "82875fdaadf98b23ae1001856c2ef3180942e9728c5b681d1570e3f4106c8e36",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/gov_fair_share.c",
  "human_readable_source": "\n \n\n#include <linux/thermal.h>\n#include \"thermal_trace.h\"\n\n#include \"thermal_core.h\"\n\n \nstatic int get_trip_level(struct thermal_zone_device *tz)\n{\n\tstruct thermal_trip trip;\n\tint count;\n\n\tfor (count = 0; count < tz->num_trips; count++) {\n\t\t__thermal_zone_get_trip(tz, count, &trip);\n\t\tif (tz->temperature < trip.temperature)\n\t\t\tbreak;\n\t}\n\n\t \n\tif (count > 0)\n\t\ttrace_thermal_zone_trip(tz, count - 1, trip.type);\n\n\treturn count;\n}\n\nstatic long get_target_state(struct thermal_zone_device *tz,\n\t\tstruct thermal_cooling_device *cdev, int percentage, int level)\n{\n\treturn (long)(percentage * level * cdev->max_state) / (100 * tz->num_trips);\n}\n\n \nstatic int fair_share_throttle(struct thermal_zone_device *tz, int trip)\n{\n\tstruct thermal_instance *instance;\n\tint total_weight = 0;\n\tint total_instance = 0;\n\tint cur_trip_level = get_trip_level(tz);\n\n\tlockdep_assert_held(&tz->lock);\n\n\tlist_for_each_entry(instance, &tz->thermal_instances, tz_node) {\n\t\tif (instance->trip != trip)\n\t\t\tcontinue;\n\n\t\ttotal_weight += instance->weight;\n\t\ttotal_instance++;\n\t}\n\n\tlist_for_each_entry(instance, &tz->thermal_instances, tz_node) {\n\t\tint percentage;\n\t\tstruct thermal_cooling_device *cdev = instance->cdev;\n\n\t\tif (instance->trip != trip)\n\t\t\tcontinue;\n\n\t\tif (!total_weight)\n\t\t\tpercentage = 100 / total_instance;\n\t\telse\n\t\t\tpercentage = (instance->weight * 100) / total_weight;\n\n\t\tinstance->target = get_target_state(tz, cdev, percentage,\n\t\t\t\t\t\t    cur_trip_level);\n\n\t\tmutex_lock(&cdev->lock);\n\t\t__thermal_cdev_update(cdev);\n\t\tmutex_unlock(&cdev->lock);\n\t}\n\n\treturn 0;\n}\n\nstatic struct thermal_governor thermal_gov_fair_share = {\n\t.name\t\t= \"fair_share\",\n\t.throttle\t= fair_share_throttle,\n};\nTHERMAL_GOVERNOR_DECLARE(thermal_gov_fair_share);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}