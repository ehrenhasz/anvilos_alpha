{
  "module_name": "rcar_gen3_thermal.c",
  "hash_id": "6f853a8c1c3b55413c9105b26dc5df7521ccbd2bb9ffe29bf1596fb6220f2ee5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/rcar_gen3_thermal.c",
  "human_readable_source": "\n \n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include <linux/thermal.h>\n\n#include \"thermal_hwmon.h\"\n\n \n#define REG_GEN3_IRQSTR\t\t0x04\n#define REG_GEN3_IRQMSK\t\t0x08\n#define REG_GEN3_IRQCTL\t\t0x0C\n#define REG_GEN3_IRQEN\t\t0x10\n#define REG_GEN3_IRQTEMP1\t0x14\n#define REG_GEN3_IRQTEMP2\t0x18\n#define REG_GEN3_IRQTEMP3\t0x1C\n#define REG_GEN3_THCTR\t\t0x20\n#define REG_GEN3_TEMP\t\t0x28\n#define REG_GEN3_THCODE1\t0x50\n#define REG_GEN3_THCODE2\t0x54\n#define REG_GEN3_THCODE3\t0x58\n#define REG_GEN3_PTAT1\t\t0x5c\n#define REG_GEN3_PTAT2\t\t0x60\n#define REG_GEN3_PTAT3\t\t0x64\n#define REG_GEN3_THSCP\t\t0x68\n#define REG_GEN4_THSFMON00\t0x180\n#define REG_GEN4_THSFMON01\t0x184\n#define REG_GEN4_THSFMON02\t0x188\n#define REG_GEN4_THSFMON15\t0x1BC\n#define REG_GEN4_THSFMON16\t0x1C0\n#define REG_GEN4_THSFMON17\t0x1C4\n\n \n#define IRQ_TEMP1\t\tBIT(0)\n#define IRQ_TEMP2\t\tBIT(1)\n#define IRQ_TEMP3\t\tBIT(2)\n#define IRQ_TEMPD1\t\tBIT(3)\n#define IRQ_TEMPD2\t\tBIT(4)\n#define IRQ_TEMPD3\t\tBIT(5)\n\n \n#define THCTR_PONM\tBIT(6)\n#define THCTR_THSST\tBIT(0)\n\n \n#define THSCP_COR_PARA_VLD\t(BIT(15) | BIT(14))\n\n#define CTEMP_MASK\t0xFFF\n\n#define MCELSIUS(temp)\t((temp) * 1000)\n#define GEN3_FUSE_MASK\t0xFFF\n#define GEN4_FUSE_MASK\t0xFFF\n\n#define TSC_MAX_NUM\t5\n\n \nstruct equation_coefs {\n\tint a1;\n\tint b1;\n\tint a2;\n\tint b2;\n};\n\nstruct rcar_gen3_thermal_priv;\n\nstruct rcar_thermal_info {\n\tint ths_tj_1;\n\tvoid (*read_fuses)(struct rcar_gen3_thermal_priv *priv);\n};\n\nstruct rcar_gen3_thermal_tsc {\n\tvoid __iomem *base;\n\tstruct thermal_zone_device *zone;\n\tstruct equation_coefs coef;\n\tint tj_t;\n\tint thcode[3];\n};\n\nstruct rcar_gen3_thermal_priv {\n\tstruct rcar_gen3_thermal_tsc *tscs[TSC_MAX_NUM];\n\tstruct thermal_zone_device_ops ops;\n\tunsigned int num_tscs;\n\tint ptat[3];\n\tconst struct rcar_thermal_info *info;\n};\n\nstatic inline u32 rcar_gen3_thermal_read(struct rcar_gen3_thermal_tsc *tsc,\n\t\t\t\t\t u32 reg)\n{\n\treturn ioread32(tsc->base + reg);\n}\n\nstatic inline void rcar_gen3_thermal_write(struct rcar_gen3_thermal_tsc *tsc,\n\t\t\t\t\t   u32 reg, u32 data)\n{\n\tiowrite32(data, tsc->base + reg);\n}\n\n \n\n#define FIXPT_SHIFT 7\n#define FIXPT_INT(_x) ((_x) << FIXPT_SHIFT)\n#define INT_FIXPT(_x) ((_x) >> FIXPT_SHIFT)\n#define FIXPT_DIV(_a, _b) DIV_ROUND_CLOSEST(((_a) << FIXPT_SHIFT), (_b))\n#define FIXPT_TO_MCELSIUS(_x) ((_x) * 1000 >> FIXPT_SHIFT)\n\n#define RCAR3_THERMAL_GRAN 500  \n\n \n#define TJ_3 -41\n\nstatic void rcar_gen3_thermal_calc_coefs(struct rcar_gen3_thermal_priv *priv,\n\t\t\t\t\t struct rcar_gen3_thermal_tsc *tsc,\n\t\t\t\t\t int ths_tj_1)\n{\n\t \n\n\t \n\ttsc->tj_t = (FIXPT_INT((priv->ptat[1] - priv->ptat[2]) * (ths_tj_1 - TJ_3))\n\t\t     / (priv->ptat[0] - priv->ptat[2])) + FIXPT_INT(TJ_3);\n\n\ttsc->coef.a1 = FIXPT_DIV(FIXPT_INT(tsc->thcode[1] - tsc->thcode[2]),\n\t\t\t\t tsc->tj_t - FIXPT_INT(TJ_3));\n\ttsc->coef.b1 = FIXPT_INT(tsc->thcode[2]) - tsc->coef.a1 * TJ_3;\n\n\ttsc->coef.a2 = FIXPT_DIV(FIXPT_INT(tsc->thcode[1] - tsc->thcode[0]),\n\t\t\t\t tsc->tj_t - FIXPT_INT(ths_tj_1));\n\ttsc->coef.b2 = FIXPT_INT(tsc->thcode[0]) - tsc->coef.a2 * ths_tj_1;\n}\n\nstatic int rcar_gen3_thermal_round(int temp)\n{\n\tint result, round_offs;\n\n\tround_offs = temp >= 0 ? RCAR3_THERMAL_GRAN / 2 :\n\t\t-RCAR3_THERMAL_GRAN / 2;\n\tresult = (temp + round_offs) / RCAR3_THERMAL_GRAN;\n\treturn result * RCAR3_THERMAL_GRAN;\n}\n\nstatic int rcar_gen3_thermal_get_temp(struct thermal_zone_device *tz, int *temp)\n{\n\tstruct rcar_gen3_thermal_tsc *tsc = thermal_zone_device_priv(tz);\n\tint mcelsius, val;\n\tint reg;\n\n\t \n\treg = rcar_gen3_thermal_read(tsc, REG_GEN3_TEMP) & CTEMP_MASK;\n\n\tif (reg <= tsc->thcode[1])\n\t\tval = FIXPT_DIV(FIXPT_INT(reg) - tsc->coef.b1,\n\t\t\t\ttsc->coef.a1);\n\telse\n\t\tval = FIXPT_DIV(FIXPT_INT(reg) - tsc->coef.b2,\n\t\t\t\ttsc->coef.a2);\n\tmcelsius = FIXPT_TO_MCELSIUS(val);\n\n\t \n\n\t \n\t*temp = rcar_gen3_thermal_round(mcelsius);\n\n\treturn 0;\n}\n\nstatic int rcar_gen3_thermal_mcelsius_to_temp(struct rcar_gen3_thermal_tsc *tsc,\n\t\t\t\t\t      int mcelsius)\n{\n\tint celsius, val;\n\n\tcelsius = DIV_ROUND_CLOSEST(mcelsius, 1000);\n\tif (celsius <= INT_FIXPT(tsc->tj_t))\n\t\tval = celsius * tsc->coef.a1 + tsc->coef.b1;\n\telse\n\t\tval = celsius * tsc->coef.a2 + tsc->coef.b2;\n\n\treturn INT_FIXPT(val);\n}\n\nstatic int rcar_gen3_thermal_set_trips(struct thermal_zone_device *tz, int low, int high)\n{\n\tstruct rcar_gen3_thermal_tsc *tsc = thermal_zone_device_priv(tz);\n\tu32 irqmsk = 0;\n\n\tif (low != -INT_MAX) {\n\t\tirqmsk |= IRQ_TEMPD1;\n\t\trcar_gen3_thermal_write(tsc, REG_GEN3_IRQTEMP1,\n\t\t\t\t\trcar_gen3_thermal_mcelsius_to_temp(tsc, low));\n\t}\n\n\tif (high != INT_MAX) {\n\t\tirqmsk |= IRQ_TEMP2;\n\t\trcar_gen3_thermal_write(tsc, REG_GEN3_IRQTEMP2,\n\t\t\t\t\trcar_gen3_thermal_mcelsius_to_temp(tsc, high));\n\t}\n\n\trcar_gen3_thermal_write(tsc, REG_GEN3_IRQMSK, irqmsk);\n\n\treturn 0;\n}\n\nstatic const struct thermal_zone_device_ops rcar_gen3_tz_of_ops = {\n\t.get_temp\t= rcar_gen3_thermal_get_temp,\n\t.set_trips\t= rcar_gen3_thermal_set_trips,\n};\n\nstatic irqreturn_t rcar_gen3_thermal_irq(int irq, void *data)\n{\n\tstruct rcar_gen3_thermal_priv *priv = data;\n\tunsigned int i;\n\tu32 status;\n\n\tfor (i = 0; i < priv->num_tscs; i++) {\n\t\tstatus = rcar_gen3_thermal_read(priv->tscs[i], REG_GEN3_IRQSTR);\n\t\trcar_gen3_thermal_write(priv->tscs[i], REG_GEN3_IRQSTR, 0);\n\t\tif (status && priv->tscs[i]->zone)\n\t\t\tthermal_zone_device_update(priv->tscs[i]->zone,\n\t\t\t\t\t\t   THERMAL_EVENT_UNSPECIFIED);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rcar_gen3_thermal_read_fuses_gen3(struct rcar_gen3_thermal_priv *priv)\n{\n\tunsigned int i;\n\n\t \n\tpriv->ptat[0] = rcar_gen3_thermal_read(priv->tscs[0], REG_GEN3_PTAT1) &\n\t\tGEN3_FUSE_MASK;\n\tpriv->ptat[1] = rcar_gen3_thermal_read(priv->tscs[0], REG_GEN3_PTAT2) &\n\t\tGEN3_FUSE_MASK;\n\tpriv->ptat[2] = rcar_gen3_thermal_read(priv->tscs[0], REG_GEN3_PTAT3) &\n\t\tGEN3_FUSE_MASK;\n\n\tfor (i = 0; i < priv->num_tscs; i++) {\n\t\tstruct rcar_gen3_thermal_tsc *tsc = priv->tscs[i];\n\n\t\ttsc->thcode[0] = rcar_gen3_thermal_read(tsc, REG_GEN3_THCODE1) &\n\t\t\tGEN3_FUSE_MASK;\n\t\ttsc->thcode[1] = rcar_gen3_thermal_read(tsc, REG_GEN3_THCODE2) &\n\t\t\tGEN3_FUSE_MASK;\n\t\ttsc->thcode[2] = rcar_gen3_thermal_read(tsc, REG_GEN3_THCODE3) &\n\t\t\tGEN3_FUSE_MASK;\n\t}\n}\n\nstatic void rcar_gen3_thermal_read_fuses_gen4(struct rcar_gen3_thermal_priv *priv)\n{\n\tunsigned int i;\n\n\t \n\tpriv->ptat[0] = rcar_gen3_thermal_read(priv->tscs[0], REG_GEN4_THSFMON16) &\n\t\tGEN4_FUSE_MASK;\n\tpriv->ptat[1] = rcar_gen3_thermal_read(priv->tscs[0], REG_GEN4_THSFMON17) &\n\t\tGEN4_FUSE_MASK;\n\tpriv->ptat[2] = rcar_gen3_thermal_read(priv->tscs[0], REG_GEN4_THSFMON15) &\n\t\tGEN4_FUSE_MASK;\n\n\tfor (i = 0; i < priv->num_tscs; i++) {\n\t\tstruct rcar_gen3_thermal_tsc *tsc = priv->tscs[i];\n\n\t\ttsc->thcode[0] = rcar_gen3_thermal_read(tsc, REG_GEN4_THSFMON01) &\n\t\t\tGEN4_FUSE_MASK;\n\t\ttsc->thcode[1] = rcar_gen3_thermal_read(tsc, REG_GEN4_THSFMON02) &\n\t\t\tGEN4_FUSE_MASK;\n\t\ttsc->thcode[2] = rcar_gen3_thermal_read(tsc, REG_GEN4_THSFMON00) &\n\t\t\tGEN4_FUSE_MASK;\n\t}\n}\n\nstatic bool rcar_gen3_thermal_read_fuses(struct rcar_gen3_thermal_priv *priv)\n{\n\tunsigned int i;\n\tu32 thscp;\n\n\t \n\tthscp = rcar_gen3_thermal_read(priv->tscs[0], REG_GEN3_THSCP);\n\tif (!priv->info->read_fuses ||\n\t    (thscp & THSCP_COR_PARA_VLD) != THSCP_COR_PARA_VLD) {\n\t\t \n\t\tstatic const int thcodes[TSC_MAX_NUM][3] = {\n\t\t\t{ 3397, 2800, 2221 },\n\t\t\t{ 3393, 2795, 2216 },\n\t\t\t{ 3389, 2805, 2237 },\n\t\t\t{ 3415, 2694, 2195 },\n\t\t\t{ 3356, 2724, 2244 },\n\t\t};\n\n\t\tpriv->ptat[0] = 2631;\n\t\tpriv->ptat[1] = 1509;\n\t\tpriv->ptat[2] = 435;\n\n\t\tfor (i = 0; i < priv->num_tscs; i++) {\n\t\t\tstruct rcar_gen3_thermal_tsc *tsc = priv->tscs[i];\n\n\t\t\ttsc->thcode[0] = thcodes[i][0];\n\t\t\ttsc->thcode[1] = thcodes[i][1];\n\t\t\ttsc->thcode[2] = thcodes[i][2];\n\t\t}\n\n\t\treturn false;\n\t}\n\n\tpriv->info->read_fuses(priv);\n\treturn true;\n}\n\nstatic void rcar_gen3_thermal_init(struct rcar_gen3_thermal_priv *priv,\n\t\t\t\t   struct rcar_gen3_thermal_tsc *tsc)\n{\n\tu32 reg_val;\n\n\treg_val = rcar_gen3_thermal_read(tsc, REG_GEN3_THCTR);\n\treg_val &= ~THCTR_PONM;\n\trcar_gen3_thermal_write(tsc, REG_GEN3_THCTR, reg_val);\n\n\tusleep_range(1000, 2000);\n\n\trcar_gen3_thermal_write(tsc, REG_GEN3_IRQCTL, 0);\n\trcar_gen3_thermal_write(tsc, REG_GEN3_IRQMSK, 0);\n\tif (priv->ops.set_trips)\n\t\trcar_gen3_thermal_write(tsc, REG_GEN3_IRQEN,\n\t\t\t\t\tIRQ_TEMPD1 | IRQ_TEMP2);\n\n\treg_val = rcar_gen3_thermal_read(tsc, REG_GEN3_THCTR);\n\treg_val |= THCTR_THSST;\n\trcar_gen3_thermal_write(tsc, REG_GEN3_THCTR, reg_val);\n\n\tusleep_range(1000, 2000);\n}\n\nstatic const struct rcar_thermal_info rcar_m3w_thermal_info = {\n\t.ths_tj_1 = 116,\n\t.read_fuses = rcar_gen3_thermal_read_fuses_gen3,\n};\n\nstatic const struct rcar_thermal_info rcar_gen3_thermal_info = {\n\t.ths_tj_1 = 126,\n\t.read_fuses = rcar_gen3_thermal_read_fuses_gen3,\n};\n\nstatic const struct rcar_thermal_info rcar_gen4_thermal_info = {\n\t.ths_tj_1 = 126,\n\t.read_fuses = rcar_gen3_thermal_read_fuses_gen4,\n};\n\nstatic const struct of_device_id rcar_gen3_thermal_dt_ids[] = {\n\t{\n\t\t.compatible = \"renesas,r8a774a1-thermal\",\n\t\t.data = &rcar_m3w_thermal_info,\n\t},\n\t{\n\t\t.compatible = \"renesas,r8a774b1-thermal\",\n\t\t.data = &rcar_gen3_thermal_info,\n\t},\n\t{\n\t\t.compatible = \"renesas,r8a774e1-thermal\",\n\t\t.data = &rcar_gen3_thermal_info,\n\t},\n\t{\n\t\t.compatible = \"renesas,r8a7795-thermal\",\n\t\t.data = &rcar_gen3_thermal_info,\n\t},\n\t{\n\t\t.compatible = \"renesas,r8a7796-thermal\",\n\t\t.data = &rcar_m3w_thermal_info,\n\t},\n\t{\n\t\t.compatible = \"renesas,r8a77961-thermal\",\n\t\t.data = &rcar_m3w_thermal_info,\n\t},\n\t{\n\t\t.compatible = \"renesas,r8a77965-thermal\",\n\t\t.data = &rcar_gen3_thermal_info,\n\t},\n\t{\n\t\t.compatible = \"renesas,r8a77980-thermal\",\n\t\t.data = &rcar_gen3_thermal_info,\n\t},\n\t{\n\t\t.compatible = \"renesas,r8a779a0-thermal\",\n\t\t.data = &rcar_gen3_thermal_info,\n\t},\n\t{\n\t\t.compatible = \"renesas,r8a779f0-thermal\",\n\t\t.data = &rcar_gen4_thermal_info,\n\t},\n\t{\n\t\t.compatible = \"renesas,r8a779g0-thermal\",\n\t\t.data = &rcar_gen4_thermal_info,\n\t},\n\t{},\n};\nMODULE_DEVICE_TABLE(of, rcar_gen3_thermal_dt_ids);\n\nstatic int rcar_gen3_thermal_remove(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\n\tpm_runtime_put(dev);\n\tpm_runtime_disable(dev);\n\n\treturn 0;\n}\n\nstatic void rcar_gen3_hwmon_action(void *data)\n{\n\tstruct thermal_zone_device *zone = data;\n\n\tthermal_remove_hwmon_sysfs(zone);\n}\n\nstatic int rcar_gen3_thermal_request_irqs(struct rcar_gen3_thermal_priv *priv,\n\t\t\t\t\t  struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tunsigned int i;\n\tchar *irqname;\n\tint ret, irq;\n\n\tfor (i = 0; i < 2; i++) {\n\t\tirq = platform_get_irq_optional(pdev, i);\n\t\tif (irq < 0)\n\t\t\treturn irq;\n\n\t\tirqname = devm_kasprintf(dev, GFP_KERNEL, \"%s:ch%d\",\n\t\t\t\t\t dev_name(dev), i);\n\t\tif (!irqname)\n\t\t\treturn -ENOMEM;\n\n\t\tret = devm_request_threaded_irq(dev, irq, NULL,\n\t\t\t\t\t\trcar_gen3_thermal_irq,\n\t\t\t\t\t\tIRQF_ONESHOT, irqname, priv);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int rcar_gen3_thermal_probe(struct platform_device *pdev)\n{\n\tstruct rcar_gen3_thermal_priv *priv;\n\tstruct device *dev = &pdev->dev;\n\tstruct resource *res;\n\tstruct thermal_zone_device *zone;\n\tunsigned int i;\n\tint ret;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->ops = rcar_gen3_tz_of_ops;\n\n\tpriv->info = of_device_get_match_data(dev);\n\tplatform_set_drvdata(pdev, priv);\n\n\tif (rcar_gen3_thermal_request_irqs(priv, pdev))\n\t\tpriv->ops.set_trips = NULL;\n\n\tpm_runtime_enable(dev);\n\tpm_runtime_get_sync(dev);\n\n\tfor (i = 0; i < TSC_MAX_NUM; i++) {\n\t\tstruct rcar_gen3_thermal_tsc *tsc;\n\n\t\tres = platform_get_resource(pdev, IORESOURCE_MEM, i);\n\t\tif (!res)\n\t\t\tbreak;\n\n\t\ttsc = devm_kzalloc(dev, sizeof(*tsc), GFP_KERNEL);\n\t\tif (!tsc) {\n\t\t\tret = -ENOMEM;\n\t\t\tgoto error_unregister;\n\t\t}\n\n\t\ttsc->base = devm_ioremap_resource(dev, res);\n\t\tif (IS_ERR(tsc->base)) {\n\t\t\tret = PTR_ERR(tsc->base);\n\t\t\tgoto error_unregister;\n\t\t}\n\n\t\tpriv->tscs[i] = tsc;\n\t}\n\n\tpriv->num_tscs = i;\n\n\tif (!rcar_gen3_thermal_read_fuses(priv))\n\t\tdev_info(dev, \"No calibration values fused, fallback to driver values\\n\");\n\n\tfor (i = 0; i < priv->num_tscs; i++) {\n\t\tstruct rcar_gen3_thermal_tsc *tsc = priv->tscs[i];\n\n\t\trcar_gen3_thermal_init(priv, tsc);\n\t\trcar_gen3_thermal_calc_coefs(priv, tsc, priv->info->ths_tj_1);\n\n\t\tzone = devm_thermal_of_zone_register(dev, i, tsc, &priv->ops);\n\t\tif (IS_ERR(zone)) {\n\t\t\tdev_err(dev, \"Sensor %u: Can't register thermal zone\\n\", i);\n\t\t\tret = PTR_ERR(zone);\n\t\t\tgoto error_unregister;\n\t\t}\n\t\ttsc->zone = zone;\n\n\t\tret = thermal_add_hwmon_sysfs(tsc->zone);\n\t\tif (ret)\n\t\t\tgoto error_unregister;\n\n\t\tret = devm_add_action_or_reset(dev, rcar_gen3_hwmon_action, zone);\n\t\tif (ret)\n\t\t\tgoto error_unregister;\n\n\t\tret = thermal_zone_get_num_trips(tsc->zone);\n\t\tif (ret < 0)\n\t\t\tgoto error_unregister;\n\n\t\tdev_info(dev, \"Sensor %u: Loaded %d trip points\\n\", i, ret);\n\t}\n\n\tif (!priv->num_tscs) {\n\t\tret = -ENODEV;\n\t\tgoto error_unregister;\n\t}\n\n\treturn 0;\n\nerror_unregister:\n\trcar_gen3_thermal_remove(pdev);\n\n\treturn ret;\n}\n\nstatic int __maybe_unused rcar_gen3_thermal_resume(struct device *dev)\n{\n\tstruct rcar_gen3_thermal_priv *priv = dev_get_drvdata(dev);\n\tunsigned int i;\n\n\tfor (i = 0; i < priv->num_tscs; i++) {\n\t\tstruct rcar_gen3_thermal_tsc *tsc = priv->tscs[i];\n\n\t\trcar_gen3_thermal_init(priv, tsc);\n\t}\n\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(rcar_gen3_thermal_pm_ops, NULL,\n\t\t\t rcar_gen3_thermal_resume);\n\nstatic struct platform_driver rcar_gen3_thermal_driver = {\n\t.driver\t= {\n\t\t.name\t= \"rcar_gen3_thermal\",\n\t\t.pm = &rcar_gen3_thermal_pm_ops,\n\t\t.of_match_table = rcar_gen3_thermal_dt_ids,\n\t},\n\t.probe\t\t= rcar_gen3_thermal_probe,\n\t.remove\t\t= rcar_gen3_thermal_remove,\n};\nmodule_platform_driver(rcar_gen3_thermal_driver);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"R-Car Gen3 THS thermal sensor driver\");\nMODULE_AUTHOR(\"Wolfram Sang <wsa+renesas@sang-engineering.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}