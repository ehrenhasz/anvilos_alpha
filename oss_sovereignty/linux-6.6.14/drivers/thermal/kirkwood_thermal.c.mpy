{
  "module_name": "kirkwood_thermal.c",
  "hash_id": "8ab7ef7d44d84a74fa45c803e5ac2ae9dae22ebaad32fe0529d08b4b60a5f800",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/kirkwood_thermal.c",
  "human_readable_source": "\n \n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/thermal.h>\n\n#define KIRKWOOD_THERMAL_VALID_OFFSET\t9\n#define KIRKWOOD_THERMAL_VALID_MASK\t0x1\n#define KIRKWOOD_THERMAL_TEMP_OFFSET\t10\n#define KIRKWOOD_THERMAL_TEMP_MASK\t0x1FF\n\n \nstruct kirkwood_thermal_priv {\n\tvoid __iomem *sensor;\n};\n\nstatic int kirkwood_get_temp(struct thermal_zone_device *thermal,\n\t\t\t  int *temp)\n{\n\tunsigned long reg;\n\tstruct kirkwood_thermal_priv *priv = thermal_zone_device_priv(thermal);\n\n\treg = readl_relaxed(priv->sensor);\n\n\t \n\tif (!((reg >> KIRKWOOD_THERMAL_VALID_OFFSET) &\n\t    KIRKWOOD_THERMAL_VALID_MASK))\n\t\treturn -EIO;\n\n\t \n\treg = (reg >> KIRKWOOD_THERMAL_TEMP_OFFSET) &\n\t\tKIRKWOOD_THERMAL_TEMP_MASK;\n\t*temp = ((3220000000UL - (10000000UL * reg)) / 13625);\n\n\treturn 0;\n}\n\nstatic struct thermal_zone_device_ops ops = {\n\t.get_temp = kirkwood_get_temp,\n};\n\nstatic const struct of_device_id kirkwood_thermal_id_table[] = {\n\t{ .compatible = \"marvell,kirkwood-thermal\" },\n\t{}\n};\n\nstatic int kirkwood_thermal_probe(struct platform_device *pdev)\n{\n\tstruct thermal_zone_device *thermal = NULL;\n\tstruct kirkwood_thermal_priv *priv;\n\tint ret;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->sensor = devm_platform_get_and_ioremap_resource(pdev, 0, NULL);\n\tif (IS_ERR(priv->sensor))\n\t\treturn PTR_ERR(priv->sensor);\n\n\tthermal = thermal_tripless_zone_device_register(\"kirkwood_thermal\",\n\t\t\t\t\t\t\tpriv, &ops, NULL);\n\tif (IS_ERR(thermal)) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Failed to register thermal zone device\\n\");\n\t\treturn PTR_ERR(thermal);\n\t}\n\tret = thermal_zone_device_enable(thermal);\n\tif (ret) {\n\t\tthermal_zone_device_unregister(thermal);\n\t\tdev_err(&pdev->dev, \"Failed to enable thermal zone device\\n\");\n\t\treturn ret;\n\t}\n\n\tplatform_set_drvdata(pdev, thermal);\n\n\treturn 0;\n}\n\nstatic int kirkwood_thermal_exit(struct platform_device *pdev)\n{\n\tstruct thermal_zone_device *kirkwood_thermal =\n\t\tplatform_get_drvdata(pdev);\n\n\tthermal_zone_device_unregister(kirkwood_thermal);\n\n\treturn 0;\n}\n\nMODULE_DEVICE_TABLE(of, kirkwood_thermal_id_table);\n\nstatic struct platform_driver kirkwood_thermal_driver = {\n\t.probe = kirkwood_thermal_probe,\n\t.remove = kirkwood_thermal_exit,\n\t.driver = {\n\t\t.name = \"kirkwood_thermal\",\n\t\t.of_match_table = kirkwood_thermal_id_table,\n\t},\n};\n\nmodule_platform_driver(kirkwood_thermal_driver);\n\nMODULE_AUTHOR(\"Nobuhiro Iwamatsu <iwamatsu@nigauri.org>\");\nMODULE_DESCRIPTION(\"kirkwood thermal driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}