{
  "module_name": "ns-thermal.c",
  "hash_id": "a97109d2e980f784fef4dc6fd97b9ff70d8633eb7db1c48e9fd6b46cc0c6bc79",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/broadcom/ns-thermal.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/of_address.h>\n#include <linux/platform_device.h>\n#include <linux/thermal.h>\n\n#define PVTMON_CONTROL0\t\t\t\t\t0x00\n#define PVTMON_CONTROL0_SEL_MASK\t\t\t0x0000000e\n#define PVTMON_CONTROL0_SEL_TEMP_MONITOR\t\t0x00000000\n#define PVTMON_CONTROL0_SEL_TEST_MODE\t\t\t0x0000000e\n#define PVTMON_STATUS\t\t\t\t\t0x08\n\nstatic int ns_thermal_get_temp(struct thermal_zone_device *tz, int *temp)\n{\n\tvoid __iomem *pvtmon = thermal_zone_device_priv(tz);\n\tint offset = thermal_zone_get_offset(tz);\n\tint slope = thermal_zone_get_slope(tz);\n\tu32 val;\n\n\tval = readl(pvtmon + PVTMON_CONTROL0);\n\tif ((val & PVTMON_CONTROL0_SEL_MASK) != PVTMON_CONTROL0_SEL_TEMP_MONITOR) {\n\t\t \n\t\tval &= ~PVTMON_CONTROL0_SEL_MASK;\n\n\t\t \n\t\tval |= PVTMON_CONTROL0_SEL_TEMP_MONITOR;\n\n\t\twritel(val, pvtmon + PVTMON_CONTROL0);\n\t}\n\n\tval = readl(pvtmon + PVTMON_STATUS);\n\t*temp = slope * val + offset;\n\n\treturn 0;\n}\n\nstatic const struct thermal_zone_device_ops ns_thermal_ops = {\n\t.get_temp = ns_thermal_get_temp,\n};\n\nstatic int ns_thermal_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct thermal_zone_device *tz;\n\tvoid __iomem *pvtmon;\n\n\tpvtmon = of_iomap(dev_of_node(dev), 0);\n\tif (WARN_ON(!pvtmon))\n\t\treturn -ENOENT;\n\n\ttz = devm_thermal_of_zone_register(dev, 0,\n\t\t\t\t\t   pvtmon,\n\t\t\t\t\t   &ns_thermal_ops);\n\tif (IS_ERR(tz)) {\n\t\tiounmap(pvtmon);\n\t\treturn PTR_ERR(tz);\n\t}\n\n\tplatform_set_drvdata(pdev, pvtmon);\n\n\treturn 0;\n}\n\nstatic int ns_thermal_remove(struct platform_device *pdev)\n{\n\tvoid __iomem *pvtmon = platform_get_drvdata(pdev);\n\n\tiounmap(pvtmon);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id ns_thermal_of_match[] = {\n\t{ .compatible = \"brcm,ns-thermal\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, ns_thermal_of_match);\n\nstatic struct platform_driver ns_thermal_driver = {\n\t.probe\t\t= ns_thermal_probe,\n\t.remove\t\t= ns_thermal_remove,\n\t.driver = {\n\t\t.name = \"ns-thermal\",\n\t\t.of_match_table = ns_thermal_of_match,\n\t},\n};\nmodule_platform_driver(ns_thermal_driver);\n\nMODULE_AUTHOR(\"Rafa\u0142 Mi\u0142ecki <rafal@milecki.pl>\");\nMODULE_DESCRIPTION(\"Northstar thermal driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}