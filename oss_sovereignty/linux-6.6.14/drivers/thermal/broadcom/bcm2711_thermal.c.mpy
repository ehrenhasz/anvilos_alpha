{
  "module_name": "bcm2711_thermal.c",
  "hash_id": "3312bac6aa210f968e0bb49d9962b94f3014d06228906c2229c0e7f49b227a00",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/broadcom/bcm2711_thermal.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/clk.h>\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/thermal.h>\n\n#include \"../thermal_hwmon.h\"\n\n#define AVS_RO_TEMP_STATUS\t\t0x200\n#define AVS_RO_TEMP_STATUS_VALID_MSK\t(BIT(16) | BIT(10))\n#define AVS_RO_TEMP_STATUS_DATA_MSK\tGENMASK(9, 0)\n\nstruct bcm2711_thermal_priv {\n\tstruct regmap *regmap;\n\tstruct thermal_zone_device *thermal;\n};\n\nstatic int bcm2711_get_temp(struct thermal_zone_device *tz, int *temp)\n{\n\tstruct bcm2711_thermal_priv *priv = thermal_zone_device_priv(tz);\n\tint slope = thermal_zone_get_slope(tz);\n\tint offset = thermal_zone_get_offset(tz);\n\tu32 val;\n\tint ret;\n\n\tret = regmap_read(priv->regmap, AVS_RO_TEMP_STATUS, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!(val & AVS_RO_TEMP_STATUS_VALID_MSK))\n\t\treturn -EIO;\n\n\tval &= AVS_RO_TEMP_STATUS_DATA_MSK;\n\n\t \n\t*temp = slope * val + offset;\n\n\treturn 0;\n}\n\nstatic const struct thermal_zone_device_ops bcm2711_thermal_of_ops = {\n\t.get_temp\t= bcm2711_get_temp,\n};\n\nstatic const struct of_device_id bcm2711_thermal_id_table[] = {\n\t{ .compatible = \"brcm,bcm2711-thermal\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, bcm2711_thermal_id_table);\n\nstatic int bcm2711_thermal_probe(struct platform_device *pdev)\n{\n\tstruct thermal_zone_device *thermal;\n\tstruct bcm2711_thermal_priv *priv;\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *parent;\n\tstruct regmap *regmap;\n\tint ret;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\t \n\tparent = of_get_parent(dev->of_node);  \n\tregmap = syscon_node_to_regmap(parent);\n\tof_node_put(parent);\n\tif (IS_ERR(regmap)) {\n\t\tret = PTR_ERR(regmap);\n\t\tdev_err(dev, \"failed to get regmap: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tpriv->regmap = regmap;\n\n\tthermal = devm_thermal_of_zone_register(dev, 0, priv,\n\t\t\t\t\t\t&bcm2711_thermal_of_ops);\n\tif (IS_ERR(thermal)) {\n\t\tret = PTR_ERR(thermal);\n\t\tdev_err(dev, \"could not register sensor: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tpriv->thermal = thermal;\n\n\treturn thermal_add_hwmon_sysfs(thermal);\n}\n\nstatic struct platform_driver bcm2711_thermal_driver = {\n\t.probe = bcm2711_thermal_probe,\n\t.driver = {\n\t\t.name = \"bcm2711_thermal\",\n\t\t.of_match_table = bcm2711_thermal_id_table,\n\t},\n};\nmodule_platform_driver(bcm2711_thermal_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Stefan Wahren\");\nMODULE_DESCRIPTION(\"Broadcom AVS RO thermal sensor driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}