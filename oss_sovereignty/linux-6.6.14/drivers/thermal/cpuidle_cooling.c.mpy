{
  "module_name": "cpuidle_cooling.c",
  "hash_id": "f7e125217127f123135981b9ace4cb76a874df7484c7ded0c2a4b09dd1ff8035",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/cpuidle_cooling.c",
  "human_readable_source": "\n \n#define pr_fmt(fmt) \"cpuidle cooling: \" fmt\n\n#include <linux/cpu.h>\n#include <linux/cpu_cooling.h>\n#include <linux/cpuidle.h>\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/idle_inject.h>\n#include <linux/of.h>\n#include <linux/slab.h>\n#include <linux/thermal.h>\n\n \nstruct cpuidle_cooling_device {\n\tstruct idle_inject_device *ii_dev;\n\tunsigned long state;\n};\n\n \nstatic unsigned int cpuidle_cooling_runtime(unsigned int idle_duration_us,\n\t\t\t\t\t    unsigned long state)\n{\n\tif (!state)\n\t\treturn 0;\n\n\treturn ((idle_duration_us * 100) / state) - idle_duration_us;\n}\n\n \nstatic int cpuidle_cooling_get_max_state(struct thermal_cooling_device *cdev,\n\t\t\t\t\t unsigned long *state)\n{\n\t \n\t*state = 100;\n\n\treturn 0;\n}\n\n \nstatic int cpuidle_cooling_get_cur_state(struct thermal_cooling_device *cdev,\n\t\t\t\t\t unsigned long *state)\n{\n\tstruct cpuidle_cooling_device *idle_cdev = cdev->devdata;\n\n\t*state = idle_cdev->state;\n\n\treturn 0;\n}\n\n \nstatic int cpuidle_cooling_set_cur_state(struct thermal_cooling_device *cdev,\n\t\t\t\t\t unsigned long state)\n{\n\tstruct cpuidle_cooling_device *idle_cdev = cdev->devdata;\n\tstruct idle_inject_device *ii_dev = idle_cdev->ii_dev;\n\tunsigned long current_state = idle_cdev->state;\n\tunsigned int runtime_us, idle_duration_us;\n\n\tidle_cdev->state = state;\n\n\tidle_inject_get_duration(ii_dev, &runtime_us, &idle_duration_us);\n\n\truntime_us = cpuidle_cooling_runtime(idle_duration_us, state);\n\n\tidle_inject_set_duration(ii_dev, runtime_us, idle_duration_us);\n\n\tif (current_state == 0 && state > 0) {\n\t\tidle_inject_start(ii_dev);\n\t} else if (current_state > 0 && !state)  {\n\t\tidle_inject_stop(ii_dev);\n\t}\n\n\treturn 0;\n}\n\n \nstatic struct thermal_cooling_device_ops cpuidle_cooling_ops = {\n\t.get_max_state = cpuidle_cooling_get_max_state,\n\t.get_cur_state = cpuidle_cooling_get_cur_state,\n\t.set_cur_state = cpuidle_cooling_set_cur_state,\n};\n\n \nstatic int __cpuidle_cooling_register(struct device_node *np,\n\t\t\t\t      struct cpuidle_driver *drv)\n{\n\tstruct idle_inject_device *ii_dev;\n\tstruct cpuidle_cooling_device *idle_cdev;\n\tstruct thermal_cooling_device *cdev;\n\tstruct device *dev;\n\tunsigned int idle_duration_us = TICK_USEC;\n\tunsigned int latency_us = UINT_MAX;\n\tchar *name;\n\tint ret;\n\n\tidle_cdev = kzalloc(sizeof(*idle_cdev), GFP_KERNEL);\n\tif (!idle_cdev) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tii_dev = idle_inject_register(drv->cpumask);\n\tif (!ii_dev) {\n\t\tret = -EINVAL;\n\t\tgoto out_kfree;\n\t}\n\n\tof_property_read_u32(np, \"duration-us\", &idle_duration_us);\n\tof_property_read_u32(np, \"exit-latency-us\", &latency_us);\n\n\tidle_inject_set_duration(ii_dev, TICK_USEC, idle_duration_us);\n\tidle_inject_set_latency(ii_dev, latency_us);\n\n\tidle_cdev->ii_dev = ii_dev;\n\n\tdev = get_cpu_device(cpumask_first(drv->cpumask));\n\n\tname = kasprintf(GFP_KERNEL, \"idle-%s\", dev_name(dev));\n\tif (!name) {\n\t\tret = -ENOMEM;\n\t\tgoto out_unregister;\n\t}\n\n\tcdev = thermal_of_cooling_device_register(np, name, idle_cdev,\n\t\t\t\t\t\t  &cpuidle_cooling_ops);\n\tif (IS_ERR(cdev)) {\n\t\tret = PTR_ERR(cdev);\n\t\tgoto out_kfree_name;\n\t}\n\n\tpr_debug(\"%s: Idle injection set with idle duration=%u, latency=%u\\n\",\n\t\t name, idle_duration_us, latency_us);\n\n\tkfree(name);\n\n\treturn 0;\n\nout_kfree_name:\n\tkfree(name);\nout_unregister:\n\tidle_inject_unregister(ii_dev);\nout_kfree:\n\tkfree(idle_cdev);\nout:\n\treturn ret;\n}\n\n \nvoid cpuidle_cooling_register(struct cpuidle_driver *drv)\n{\n\tstruct device_node *cooling_node;\n\tstruct device_node *cpu_node;\n\tint cpu, ret;\n\n\tfor_each_cpu(cpu, drv->cpumask) {\n\n\t\tcpu_node = of_cpu_device_node_get(cpu);\n\n\t\tcooling_node = of_get_child_by_name(cpu_node, \"thermal-idle\");\n\n\t\tof_node_put(cpu_node);\n\n\t\tif (!cooling_node) {\n\t\t\tpr_debug(\"'thermal-idle' node not found for cpu%d\\n\", cpu);\n\t\t\tcontinue;\n\t\t}\n\n\t\tret = __cpuidle_cooling_register(cooling_node, drv);\n\n\t\tof_node_put(cooling_node);\n\n\t\tif (ret) {\n\t\t\tpr_err(\"Failed to register the cpuidle cooling device\" \\\n\t\t\t       \"for cpu%d: %d\\n\", cpu, ret);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}