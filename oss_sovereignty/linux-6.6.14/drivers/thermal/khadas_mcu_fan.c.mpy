{
  "module_name": "khadas_mcu_fan.c",
  "hash_id": "088d445d9c7f885b92da5348cbcfa582cebaac40a05ec91f6b5aca3ac272835b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/khadas_mcu_fan.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/mfd/khadas-mcu.h>\n#include <linux/regmap.h>\n#include <linux/sysfs.h>\n#include <linux/thermal.h>\n\n#define MAX_LEVEL 3\n\nstruct khadas_mcu_fan_ctx {\n\tstruct khadas_mcu *mcu;\n\tunsigned int level;\n\tstruct thermal_cooling_device *cdev;\n};\n\nstatic int khadas_mcu_fan_set_level(struct khadas_mcu_fan_ctx *ctx,\n\t\t\t\t    unsigned int level)\n{\n\tint ret;\n\n\tret = regmap_write(ctx->mcu->regmap, KHADAS_MCU_CMD_FAN_STATUS_CTRL_REG,\n\t\t\t   level);\n\tif (ret)\n\t\treturn ret;\n\n\tctx->level = level;\n\n\treturn 0;\n}\n\nstatic int khadas_mcu_fan_get_max_state(struct thermal_cooling_device *cdev,\n\t\t\t\t\tunsigned long *state)\n{\n\t*state = MAX_LEVEL;\n\n\treturn 0;\n}\n\nstatic int khadas_mcu_fan_get_cur_state(struct thermal_cooling_device *cdev,\n\t\t\t\t\tunsigned long *state)\n{\n\tstruct khadas_mcu_fan_ctx *ctx = cdev->devdata;\n\n\t*state = ctx->level;\n\n\treturn 0;\n}\n\nstatic int\nkhadas_mcu_fan_set_cur_state(struct thermal_cooling_device *cdev,\n\t\t\t     unsigned long state)\n{\n\tstruct khadas_mcu_fan_ctx *ctx = cdev->devdata;\n\n\tif (state > MAX_LEVEL)\n\t\treturn -EINVAL;\n\n\tif (state == ctx->level)\n\t\treturn 0;\n\n\treturn khadas_mcu_fan_set_level(ctx, state);\n}\n\nstatic const struct thermal_cooling_device_ops khadas_mcu_fan_cooling_ops = {\n\t.get_max_state = khadas_mcu_fan_get_max_state,\n\t.get_cur_state = khadas_mcu_fan_get_cur_state,\n\t.set_cur_state = khadas_mcu_fan_set_cur_state,\n};\n\nstatic int khadas_mcu_fan_probe(struct platform_device *pdev)\n{\n\tstruct khadas_mcu *mcu = dev_get_drvdata(pdev->dev.parent);\n\tstruct thermal_cooling_device *cdev;\n\tstruct device *dev = &pdev->dev;\n\tstruct khadas_mcu_fan_ctx *ctx;\n\tint ret;\n\n\tctx = devm_kzalloc(dev, sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\tctx->mcu = mcu;\n\tplatform_set_drvdata(pdev, ctx);\n\n\tcdev = devm_thermal_of_cooling_device_register(dev->parent,\n\t\t\tdev->parent->of_node, \"khadas-mcu-fan\", ctx,\n\t\t\t&khadas_mcu_fan_cooling_ops);\n\tif (IS_ERR(cdev)) {\n\t\tret = PTR_ERR(cdev);\n\t\tdev_err(dev, \"Failed to register khadas-mcu-fan as cooling device: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\tctx->cdev = cdev;\n\n\treturn 0;\n}\n\nstatic void khadas_mcu_fan_shutdown(struct platform_device *pdev)\n{\n\tstruct khadas_mcu_fan_ctx *ctx = platform_get_drvdata(pdev);\n\n\tkhadas_mcu_fan_set_level(ctx, 0);\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int khadas_mcu_fan_suspend(struct device *dev)\n{\n\tstruct khadas_mcu_fan_ctx *ctx = dev_get_drvdata(dev);\n\tunsigned int level_save = ctx->level;\n\tint ret;\n\n\tret = khadas_mcu_fan_set_level(ctx, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tctx->level = level_save;\n\n\treturn 0;\n}\n\nstatic int khadas_mcu_fan_resume(struct device *dev)\n{\n\tstruct khadas_mcu_fan_ctx *ctx = dev_get_drvdata(dev);\n\n\treturn khadas_mcu_fan_set_level(ctx, ctx->level);\n}\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(khadas_mcu_fan_pm, khadas_mcu_fan_suspend,\n\t\t\t khadas_mcu_fan_resume);\n\nstatic const struct platform_device_id khadas_mcu_fan_id_table[] = {\n\t{ .name = \"khadas-mcu-fan-ctrl\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(platform, khadas_mcu_fan_id_table);\n\nstatic struct platform_driver khadas_mcu_fan_driver = {\n\t.probe\t\t= khadas_mcu_fan_probe,\n\t.shutdown\t= khadas_mcu_fan_shutdown,\n\t.driver\t= {\n\t\t.name\t\t= \"khadas-mcu-fan-ctrl\",\n\t\t.pm\t\t= &khadas_mcu_fan_pm,\n\t},\n\t.id_table\t= khadas_mcu_fan_id_table,\n};\n\nmodule_platform_driver(khadas_mcu_fan_driver);\n\nMODULE_AUTHOR(\"Neil Armstrong <narmstrong@baylibre.com>\");\nMODULE_DESCRIPTION(\"Khadas MCU FAN driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}