{
  "module_name": "thermal_trip.c",
  "hash_id": "ada761103bd16d6d692393d115034c42be3cfe4183fbfd0a0c008d7e1a020eb8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/thermal_trip.c",
  "human_readable_source": "\n \n#include \"thermal_core.h\"\n\nint for_each_thermal_trip(struct thermal_zone_device *tz,\n\t\t\t  int (*cb)(struct thermal_trip *, void *),\n\t\t\t  void *data)\n{\n\tint i, ret;\n\n\tlockdep_assert_held(&tz->lock);\n\n\tif (!tz->trips)\n\t\treturn -ENODATA;\n\n\tfor (i = 0; i < tz->num_trips; i++) {\n\t\tret = cb(&tz->trips[i], data);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(for_each_thermal_trip);\n\nint thermal_zone_get_num_trips(struct thermal_zone_device *tz)\n{\n\treturn tz->num_trips;\n}\nEXPORT_SYMBOL_GPL(thermal_zone_get_num_trips);\n\n \nvoid __thermal_zone_set_trips(struct thermal_zone_device *tz)\n{\n\tstruct thermal_trip trip;\n\tint low = -INT_MAX, high = INT_MAX;\n\tbool same_trip = false;\n\tint i, ret;\n\n\tlockdep_assert_held(&tz->lock);\n\n\tif (!tz->ops->set_trips)\n\t\treturn;\n\n\tfor (i = 0; i < tz->num_trips; i++) {\n\t\tbool low_set = false;\n\t\tint trip_low;\n\n\t\tret = __thermal_zone_get_trip(tz, i , &trip);\n\t\tif (ret)\n\t\t\treturn;\n\n\t\ttrip_low = trip.temperature - trip.hysteresis;\n\n\t\tif (trip_low < tz->temperature && trip_low > low) {\n\t\t\tlow = trip_low;\n\t\t\tlow_set = true;\n\t\t\tsame_trip = false;\n\t\t}\n\n\t\tif (trip.temperature > tz->temperature &&\n\t\t    trip.temperature < high) {\n\t\t\thigh = trip.temperature;\n\t\t\tsame_trip = low_set;\n\t\t}\n\t}\n\n\t \n\tif (tz->prev_low_trip == low && tz->prev_high_trip == high)\n\t\treturn;\n\n\t \n\tif (same_trip && (tz->prev_low_trip != -INT_MAX ||\n\t    tz->prev_high_trip != INT_MAX))\n\t\treturn;\n\n\ttz->prev_low_trip = low;\n\ttz->prev_high_trip = high;\n\n\tdev_dbg(&tz->device,\n\t\t\"new temperature boundaries: %d < x < %d\\n\", low, high);\n\n\t \n\tret = tz->ops->set_trips(tz, low, high);\n\tif (ret)\n\t\tdev_err(&tz->device, \"Failed to set trips: %d\\n\", ret);\n}\n\nint __thermal_zone_get_trip(struct thermal_zone_device *tz, int trip_id,\n\t\t\t    struct thermal_trip *trip)\n{\n\tif (!tz || !tz->trips || trip_id < 0 || trip_id >= tz->num_trips || !trip)\n\t\treturn -EINVAL;\n\n\t*trip = tz->trips[trip_id];\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(__thermal_zone_get_trip);\n\nint thermal_zone_get_trip(struct thermal_zone_device *tz, int trip_id,\n\t\t\t  struct thermal_trip *trip)\n{\n\tint ret;\n\n\tmutex_lock(&tz->lock);\n\tret = __thermal_zone_get_trip(tz, trip_id, trip);\n\tmutex_unlock(&tz->lock);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(thermal_zone_get_trip);\n\nint thermal_zone_set_trip(struct thermal_zone_device *tz, int trip_id,\n\t\t\t  const struct thermal_trip *trip)\n{\n\tstruct thermal_trip t;\n\tint ret;\n\n\tif (!tz->ops->set_trip_temp && !tz->ops->set_trip_hyst && !tz->trips)\n\t\treturn -EINVAL;\n\n\tret = __thermal_zone_get_trip(tz, trip_id, &t);\n\tif (ret)\n\t\treturn ret;\n\n\tif (t.type != trip->type)\n\t\treturn -EINVAL;\n\n\tif (t.temperature != trip->temperature && tz->ops->set_trip_temp) {\n\t\tret = tz->ops->set_trip_temp(tz, trip_id, trip->temperature);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (t.hysteresis != trip->hysteresis && tz->ops->set_trip_hyst) {\n\t\tret = tz->ops->set_trip_hyst(tz, trip_id, trip->hysteresis);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (tz->trips && (t.temperature != trip->temperature || t.hysteresis != trip->hysteresis))\n\t\ttz->trips[trip_id] = *trip;\n\n\tthermal_notify_tz_trip_change(tz->id, trip_id, trip->type,\n\t\t\t\t      trip->temperature, trip->hysteresis);\n\n\t__thermal_zone_device_update(tz, THERMAL_TRIP_CHANGED);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}