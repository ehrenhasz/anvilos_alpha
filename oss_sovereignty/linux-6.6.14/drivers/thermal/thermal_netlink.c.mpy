{
  "module_name": "thermal_netlink.c",
  "hash_id": "5e2205c7f2f9a002572ef7ebe7d9ecfd0b94f37dd4b81ab296451540a1467d4f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/thermal_netlink.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <net/genetlink.h>\n#include <uapi/linux/thermal.h>\n\n#include \"thermal_core.h\"\n\nstatic const struct genl_multicast_group thermal_genl_mcgrps[] = {\n\t{ .name = THERMAL_GENL_SAMPLING_GROUP_NAME, },\n\t{ .name = THERMAL_GENL_EVENT_GROUP_NAME,  },\n};\n\nstatic const struct nla_policy thermal_genl_policy[THERMAL_GENL_ATTR_MAX + 1] = {\n\t \n\t[THERMAL_GENL_ATTR_TZ]\t\t\t= { .type = NLA_NESTED },\n\t[THERMAL_GENL_ATTR_TZ_ID]\t\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_TZ_TEMP]\t\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_TZ_TRIP]\t\t= { .type = NLA_NESTED },\n\t[THERMAL_GENL_ATTR_TZ_TRIP_ID]\t\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_TZ_TRIP_TEMP]\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_TZ_TRIP_TYPE]\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_TZ_TRIP_HYST]\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_TZ_MODE]\t\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_TZ_CDEV_WEIGHT]\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_TZ_NAME]\t\t= { .type = NLA_STRING,\n\t\t\t\t\t\t    .len = THERMAL_NAME_LENGTH },\n\t \n\t[THERMAL_GENL_ATTR_TZ_GOV]\t\t= { .type = NLA_NESTED },\n\t[THERMAL_GENL_ATTR_TZ_GOV_NAME]\t\t= { .type = NLA_STRING,\n\t\t\t\t\t\t    .len = THERMAL_NAME_LENGTH },\n\t \n\t[THERMAL_GENL_ATTR_CDEV]\t\t= { .type = NLA_NESTED },\n\t[THERMAL_GENL_ATTR_CDEV_ID]\t\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_CDEV_CUR_STATE]\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_CDEV_MAX_STATE]\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_CDEV_NAME]\t\t= { .type = NLA_STRING,\n\t\t\t\t\t\t    .len = THERMAL_NAME_LENGTH },\n\t \n\t[THERMAL_GENL_ATTR_CPU_CAPABILITY]\t\t= { .type = NLA_NESTED },\n\t[THERMAL_GENL_ATTR_CPU_CAPABILITY_ID]\t\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_CPU_CAPABILITY_PERFORMANCE]\t= { .type = NLA_U32 },\n\t[THERMAL_GENL_ATTR_CPU_CAPABILITY_EFFICIENCY]\t= { .type = NLA_U32 },\n};\n\nstruct param {\n\tstruct nlattr **attrs;\n\tstruct sk_buff *msg;\n\tconst char *name;\n\tint tz_id;\n\tint cdev_id;\n\tint trip_id;\n\tint trip_temp;\n\tint trip_type;\n\tint trip_hyst;\n\tint temp;\n\tint cdev_state;\n\tint cdev_max_state;\n\tstruct thermal_genl_cpu_caps *cpu_capabilities;\n\tint cpu_capabilities_count;\n};\n\ntypedef int (*cb_t)(struct param *);\n\nstatic struct genl_family thermal_gnl_family;\n\n \n\nint thermal_genl_sampling_temp(int id, int temp)\n{\n\tstruct sk_buff *skb;\n\tvoid *hdr;\n\n\tskb = genlmsg_new(NLMSG_GOODSIZE, GFP_KERNEL);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\thdr = genlmsg_put(skb, 0, 0, &thermal_gnl_family, 0,\n\t\t\t  THERMAL_GENL_SAMPLING_TEMP);\n\tif (!hdr)\n\t\tgoto out_free;\n\n\tif (nla_put_u32(skb, THERMAL_GENL_ATTR_TZ_ID, id))\n\t\tgoto out_cancel;\n\n\tif (nla_put_u32(skb, THERMAL_GENL_ATTR_TZ_TEMP, temp))\n\t\tgoto out_cancel;\n\n\tgenlmsg_end(skb, hdr);\n\n\tgenlmsg_multicast(&thermal_gnl_family, skb, 0, 0, GFP_KERNEL);\n\n\treturn 0;\nout_cancel:\n\tgenlmsg_cancel(skb, hdr);\nout_free:\n\tnlmsg_free(skb);\n\n\treturn -EMSGSIZE;\n}\n\n \n\nstatic int thermal_genl_event_tz_create(struct param *p)\n{\n\tif (nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_ID, p->tz_id) ||\n\t    nla_put_string(p->msg, THERMAL_GENL_ATTR_TZ_NAME, p->name))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_event_tz(struct param *p)\n{\n\tif (nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_ID, p->tz_id))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_event_tz_trip_up(struct param *p)\n{\n\tif (nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_ID, p->tz_id) ||\n\t    nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_TRIP_ID, p->trip_id) ||\n\t    nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_TEMP, p->temp))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_event_tz_trip_add(struct param *p)\n{\n\tif (nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_ID, p->tz_id) ||\n\t    nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_TRIP_ID, p->trip_id) ||\n\t    nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_TRIP_TYPE, p->trip_type) ||\n\t    nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_TRIP_TEMP, p->trip_temp) ||\n\t    nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_TRIP_HYST, p->trip_hyst))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_event_tz_trip_delete(struct param *p)\n{\n\tif (nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_ID, p->tz_id) ||\n\t    nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_TRIP_ID, p->trip_id))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_event_cdev_add(struct param *p)\n{\n\tif (nla_put_string(p->msg, THERMAL_GENL_ATTR_CDEV_NAME,\n\t\t\t   p->name) ||\n\t    nla_put_u32(p->msg, THERMAL_GENL_ATTR_CDEV_ID,\n\t\t\tp->cdev_id) ||\n\t    nla_put_u32(p->msg, THERMAL_GENL_ATTR_CDEV_MAX_STATE,\n\t\t\tp->cdev_max_state))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_event_cdev_delete(struct param *p)\n{\n\tif (nla_put_u32(p->msg, THERMAL_GENL_ATTR_CDEV_ID, p->cdev_id))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_event_cdev_state_update(struct param *p)\n{\n\tif (nla_put_u32(p->msg, THERMAL_GENL_ATTR_CDEV_ID,\n\t\t\tp->cdev_id) ||\n\t    nla_put_u32(p->msg, THERMAL_GENL_ATTR_CDEV_CUR_STATE,\n\t\t\tp->cdev_state))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_event_gov_change(struct param *p)\n{\n\tif (nla_put_u32(p->msg, THERMAL_GENL_ATTR_TZ_ID, p->tz_id) ||\n\t    nla_put_string(p->msg, THERMAL_GENL_ATTR_GOV_NAME, p->name))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_event_cpu_capability_change(struct param *p)\n{\n\tstruct thermal_genl_cpu_caps *cpu_cap = p->cpu_capabilities;\n\tstruct sk_buff *msg = p->msg;\n\tstruct nlattr *start_cap;\n\tint i;\n\n\tstart_cap = nla_nest_start(msg, THERMAL_GENL_ATTR_CPU_CAPABILITY);\n\tif (!start_cap)\n\t\treturn -EMSGSIZE;\n\n\tfor (i = 0; i < p->cpu_capabilities_count; ++i) {\n\t\tif (nla_put_u32(msg, THERMAL_GENL_ATTR_CPU_CAPABILITY_ID,\n\t\t\t\tcpu_cap->cpu))\n\t\t\tgoto out_cancel_nest;\n\n\t\tif (nla_put_u32(msg, THERMAL_GENL_ATTR_CPU_CAPABILITY_PERFORMANCE,\n\t\t\t\tcpu_cap->performance))\n\t\t\tgoto out_cancel_nest;\n\n\t\tif (nla_put_u32(msg, THERMAL_GENL_ATTR_CPU_CAPABILITY_EFFICIENCY,\n\t\t\t\tcpu_cap->efficiency))\n\t\t\tgoto out_cancel_nest;\n\n\t\t++cpu_cap;\n\t}\n\n\tnla_nest_end(msg, start_cap);\n\n\treturn 0;\nout_cancel_nest:\n\tnla_nest_cancel(msg, start_cap);\n\n\treturn -EMSGSIZE;\n}\n\nint thermal_genl_event_tz_delete(struct param *p)\n\t__attribute__((alias(\"thermal_genl_event_tz\")));\n\nint thermal_genl_event_tz_enable(struct param *p)\n\t__attribute__((alias(\"thermal_genl_event_tz\")));\n\nint thermal_genl_event_tz_disable(struct param *p)\n\t__attribute__((alias(\"thermal_genl_event_tz\")));\n\nint thermal_genl_event_tz_trip_down(struct param *p)\n\t__attribute__((alias(\"thermal_genl_event_tz_trip_up\")));\n\nint thermal_genl_event_tz_trip_change(struct param *p)\n\t__attribute__((alias(\"thermal_genl_event_tz_trip_add\")));\n\nstatic cb_t event_cb[] = {\n\t[THERMAL_GENL_EVENT_TZ_CREATE]\t\t= thermal_genl_event_tz_create,\n\t[THERMAL_GENL_EVENT_TZ_DELETE]\t\t= thermal_genl_event_tz_delete,\n\t[THERMAL_GENL_EVENT_TZ_ENABLE]\t\t= thermal_genl_event_tz_enable,\n\t[THERMAL_GENL_EVENT_TZ_DISABLE]\t\t= thermal_genl_event_tz_disable,\n\t[THERMAL_GENL_EVENT_TZ_TRIP_UP]\t\t= thermal_genl_event_tz_trip_up,\n\t[THERMAL_GENL_EVENT_TZ_TRIP_DOWN]\t= thermal_genl_event_tz_trip_down,\n\t[THERMAL_GENL_EVENT_TZ_TRIP_CHANGE]\t= thermal_genl_event_tz_trip_change,\n\t[THERMAL_GENL_EVENT_TZ_TRIP_ADD]\t= thermal_genl_event_tz_trip_add,\n\t[THERMAL_GENL_EVENT_TZ_TRIP_DELETE]\t= thermal_genl_event_tz_trip_delete,\n\t[THERMAL_GENL_EVENT_CDEV_ADD]\t\t= thermal_genl_event_cdev_add,\n\t[THERMAL_GENL_EVENT_CDEV_DELETE]\t= thermal_genl_event_cdev_delete,\n\t[THERMAL_GENL_EVENT_CDEV_STATE_UPDATE]\t= thermal_genl_event_cdev_state_update,\n\t[THERMAL_GENL_EVENT_TZ_GOV_CHANGE]\t= thermal_genl_event_gov_change,\n\t[THERMAL_GENL_EVENT_CPU_CAPABILITY_CHANGE] = thermal_genl_event_cpu_capability_change,\n};\n\n \nstatic int thermal_genl_send_event(enum thermal_genl_event event,\n\t\t\t\t   struct param *p)\n{\n\tstruct sk_buff *msg;\n\tint ret = -EMSGSIZE;\n\tvoid *hdr;\n\n\tmsg = genlmsg_new(NLMSG_GOODSIZE, GFP_KERNEL);\n\tif (!msg)\n\t\treturn -ENOMEM;\n\tp->msg = msg;\n\n\thdr = genlmsg_put(msg, 0, 0, &thermal_gnl_family, 0, event);\n\tif (!hdr)\n\t\tgoto out_free_msg;\n\n\tret = event_cb[event](p);\n\tif (ret)\n\t\tgoto out_cancel_msg;\n\n\tgenlmsg_end(msg, hdr);\n\n\tgenlmsg_multicast(&thermal_gnl_family, msg, 0, 1, GFP_KERNEL);\n\n\treturn 0;\n\nout_cancel_msg:\n\tgenlmsg_cancel(msg, hdr);\nout_free_msg:\n\tnlmsg_free(msg);\n\n\treturn ret;\n}\n\nint thermal_notify_tz_create(int tz_id, const char *name)\n{\n\tstruct param p = { .tz_id = tz_id, .name = name };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_TZ_CREATE, &p);\n}\n\nint thermal_notify_tz_delete(int tz_id)\n{\n\tstruct param p = { .tz_id = tz_id };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_TZ_DELETE, &p);\n}\n\nint thermal_notify_tz_enable(int tz_id)\n{\n\tstruct param p = { .tz_id = tz_id };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_TZ_ENABLE, &p);\n}\n\nint thermal_notify_tz_disable(int tz_id)\n{\n\tstruct param p = { .tz_id = tz_id };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_TZ_DISABLE, &p);\n}\n\nint thermal_notify_tz_trip_down(int tz_id, int trip_id, int temp)\n{\n\tstruct param p = { .tz_id = tz_id, .trip_id = trip_id, .temp = temp };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_TZ_TRIP_DOWN, &p);\n}\n\nint thermal_notify_tz_trip_up(int tz_id, int trip_id, int temp)\n{\n\tstruct param p = { .tz_id = tz_id, .trip_id = trip_id, .temp = temp };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_TZ_TRIP_UP, &p);\n}\n\nint thermal_notify_tz_trip_add(int tz_id, int trip_id, int trip_type,\n\t\t\t       int trip_temp, int trip_hyst)\n{\n\tstruct param p = { .tz_id = tz_id, .trip_id = trip_id,\n\t\t\t   .trip_type = trip_type, .trip_temp = trip_temp,\n\t\t\t   .trip_hyst = trip_hyst };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_TZ_TRIP_ADD, &p);\n}\n\nint thermal_notify_tz_trip_delete(int tz_id, int trip_id)\n{\n\tstruct param p = { .tz_id = tz_id, .trip_id = trip_id };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_TZ_TRIP_DELETE, &p);\n}\n\nint thermal_notify_tz_trip_change(int tz_id, int trip_id, int trip_type,\n\t\t\t\t  int trip_temp, int trip_hyst)\n{\n\tstruct param p = { .tz_id = tz_id, .trip_id = trip_id,\n\t\t\t   .trip_type = trip_type, .trip_temp = trip_temp,\n\t\t\t   .trip_hyst = trip_hyst };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_TZ_TRIP_CHANGE, &p);\n}\n\nint thermal_notify_cdev_state_update(int cdev_id, int cdev_state)\n{\n\tstruct param p = { .cdev_id = cdev_id, .cdev_state = cdev_state };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_CDEV_STATE_UPDATE, &p);\n}\n\nint thermal_notify_cdev_add(int cdev_id, const char *name, int cdev_max_state)\n{\n\tstruct param p = { .cdev_id = cdev_id, .name = name,\n\t\t\t   .cdev_max_state = cdev_max_state };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_CDEV_ADD, &p);\n}\n\nint thermal_notify_cdev_delete(int cdev_id)\n{\n\tstruct param p = { .cdev_id = cdev_id };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_CDEV_DELETE, &p);\n}\n\nint thermal_notify_tz_gov_change(int tz_id, const char *name)\n{\n\tstruct param p = { .tz_id = tz_id, .name = name };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_TZ_GOV_CHANGE, &p);\n}\n\nint thermal_genl_cpu_capability_event(int count,\n\t\t\t\t      struct thermal_genl_cpu_caps *caps)\n{\n\tstruct param p = { .cpu_capabilities_count = count, .cpu_capabilities = caps };\n\n\treturn thermal_genl_send_event(THERMAL_GENL_EVENT_CPU_CAPABILITY_CHANGE, &p);\n}\nEXPORT_SYMBOL_GPL(thermal_genl_cpu_capability_event);\n\n \n\nstatic int __thermal_genl_cmd_tz_get_id(struct thermal_zone_device *tz,\n\t\t\t\t\tvoid *data)\n{\n\tstruct sk_buff *msg = data;\n\n\tif (nla_put_u32(msg, THERMAL_GENL_ATTR_TZ_ID, tz->id) ||\n\t    nla_put_string(msg, THERMAL_GENL_ATTR_TZ_NAME, tz->type))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_cmd_tz_get_id(struct param *p)\n{\n\tstruct sk_buff *msg = p->msg;\n\tstruct nlattr *start_tz;\n\tint ret;\n\n\tstart_tz = nla_nest_start(msg, THERMAL_GENL_ATTR_TZ);\n\tif (!start_tz)\n\t\treturn -EMSGSIZE;\n\n\tret = for_each_thermal_zone(__thermal_genl_cmd_tz_get_id, msg);\n\tif (ret)\n\t\tgoto out_cancel_nest;\n\n\tnla_nest_end(msg, start_tz);\n\n\treturn 0;\n\nout_cancel_nest:\n\tnla_nest_cancel(msg, start_tz);\n\n\treturn ret;\n}\n\nstatic int thermal_genl_cmd_tz_get_trip(struct param *p)\n{\n\tstruct sk_buff *msg = p->msg;\n\tstruct thermal_zone_device *tz;\n\tstruct nlattr *start_trip;\n\tstruct thermal_trip trip;\n\tint ret, i, id;\n\n\tif (!p->attrs[THERMAL_GENL_ATTR_TZ_ID])\n\t\treturn -EINVAL;\n\n\tid = nla_get_u32(p->attrs[THERMAL_GENL_ATTR_TZ_ID]);\n\n\ttz = thermal_zone_get_by_id(id);\n\tif (!tz)\n\t\treturn -EINVAL;\n\n\tstart_trip = nla_nest_start(msg, THERMAL_GENL_ATTR_TZ_TRIP);\n\tif (!start_trip)\n\t\treturn -EMSGSIZE;\n\n\tmutex_lock(&tz->lock);\n\n\tfor (i = 0; i < tz->num_trips; i++) {\n\n\t\tret = __thermal_zone_get_trip(tz, i, &trip);\n\t\tif (ret)\n\t\t\tgoto out_cancel_nest;\n\n\t\tif (nla_put_u32(msg, THERMAL_GENL_ATTR_TZ_TRIP_ID, i) ||\n\t\t    nla_put_u32(msg, THERMAL_GENL_ATTR_TZ_TRIP_TYPE, trip.type) ||\n\t\t    nla_put_u32(msg, THERMAL_GENL_ATTR_TZ_TRIP_TEMP, trip.temperature) ||\n\t\t    nla_put_u32(msg, THERMAL_GENL_ATTR_TZ_TRIP_HYST, trip.hysteresis))\n\t\t\tgoto out_cancel_nest;\n\t}\n\n\tmutex_unlock(&tz->lock);\n\n\tnla_nest_end(msg, start_trip);\n\n\treturn 0;\n\nout_cancel_nest:\n\tmutex_unlock(&tz->lock);\n\n\treturn -EMSGSIZE;\n}\n\nstatic int thermal_genl_cmd_tz_get_temp(struct param *p)\n{\n\tstruct sk_buff *msg = p->msg;\n\tstruct thermal_zone_device *tz;\n\tint temp, ret, id;\n\n\tif (!p->attrs[THERMAL_GENL_ATTR_TZ_ID])\n\t\treturn -EINVAL;\n\n\tid = nla_get_u32(p->attrs[THERMAL_GENL_ATTR_TZ_ID]);\n\n\ttz = thermal_zone_get_by_id(id);\n\tif (!tz)\n\t\treturn -EINVAL;\n\n\tret = thermal_zone_get_temp(tz, &temp);\n\tif (ret)\n\t\treturn ret;\n\n\tif (nla_put_u32(msg, THERMAL_GENL_ATTR_TZ_ID, id) ||\n\t    nla_put_u32(msg, THERMAL_GENL_ATTR_TZ_TEMP, temp))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_cmd_tz_get_gov(struct param *p)\n{\n\tstruct sk_buff *msg = p->msg;\n\tstruct thermal_zone_device *tz;\n\tint id, ret = 0;\n\n\tif (!p->attrs[THERMAL_GENL_ATTR_TZ_ID])\n\t\treturn -EINVAL;\n\n\tid = nla_get_u32(p->attrs[THERMAL_GENL_ATTR_TZ_ID]);\n\n\ttz = thermal_zone_get_by_id(id);\n\tif (!tz)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&tz->lock);\n\n\tif (nla_put_u32(msg, THERMAL_GENL_ATTR_TZ_ID, id) ||\n\t    nla_put_string(msg, THERMAL_GENL_ATTR_TZ_GOV_NAME,\n\t\t\t   tz->governor->name))\n\t\tret = -EMSGSIZE;\n\n\tmutex_unlock(&tz->lock);\n\n\treturn ret;\n}\n\nstatic int __thermal_genl_cmd_cdev_get(struct thermal_cooling_device *cdev,\n\t\t\t\t       void *data)\n{\n\tstruct sk_buff *msg = data;\n\n\tif (nla_put_u32(msg, THERMAL_GENL_ATTR_CDEV_ID, cdev->id))\n\t\treturn -EMSGSIZE;\n\n\tif (nla_put_string(msg, THERMAL_GENL_ATTR_CDEV_NAME, cdev->type))\n\t\treturn -EMSGSIZE;\n\n\treturn 0;\n}\n\nstatic int thermal_genl_cmd_cdev_get(struct param *p)\n{\n\tstruct sk_buff *msg = p->msg;\n\tstruct nlattr *start_cdev;\n\tint ret;\n\n\tstart_cdev = nla_nest_start(msg, THERMAL_GENL_ATTR_CDEV);\n\tif (!start_cdev)\n\t\treturn -EMSGSIZE;\n\n\tret = for_each_thermal_cooling_device(__thermal_genl_cmd_cdev_get, msg);\n\tif (ret)\n\t\tgoto out_cancel_nest;\n\n\tnla_nest_end(msg, start_cdev);\n\n\treturn 0;\nout_cancel_nest:\n\tnla_nest_cancel(msg, start_cdev);\n\n\treturn ret;\n}\n\nstatic cb_t cmd_cb[] = {\n\t[THERMAL_GENL_CMD_TZ_GET_ID]\t= thermal_genl_cmd_tz_get_id,\n\t[THERMAL_GENL_CMD_TZ_GET_TRIP]\t= thermal_genl_cmd_tz_get_trip,\n\t[THERMAL_GENL_CMD_TZ_GET_TEMP]\t= thermal_genl_cmd_tz_get_temp,\n\t[THERMAL_GENL_CMD_TZ_GET_GOV]\t= thermal_genl_cmd_tz_get_gov,\n\t[THERMAL_GENL_CMD_CDEV_GET]\t= thermal_genl_cmd_cdev_get,\n};\n\nstatic int thermal_genl_cmd_dumpit(struct sk_buff *skb,\n\t\t\t\t   struct netlink_callback *cb)\n{\n\tstruct param p = { .msg = skb };\n\tconst struct genl_dumpit_info *info = genl_dumpit_info(cb);\n\tint cmd = info->op.cmd;\n\tint ret;\n\tvoid *hdr;\n\n\thdr = genlmsg_put(skb, 0, 0, &thermal_gnl_family, 0, cmd);\n\tif (!hdr)\n\t\treturn -EMSGSIZE;\n\n\tret = cmd_cb[cmd](&p);\n\tif (ret)\n\t\tgoto out_cancel_msg;\n\n\tgenlmsg_end(skb, hdr);\n\n\treturn 0;\n\nout_cancel_msg:\n\tgenlmsg_cancel(skb, hdr);\n\n\treturn ret;\n}\n\nstatic int thermal_genl_cmd_doit(struct sk_buff *skb,\n\t\t\t\t struct genl_info *info)\n{\n\tstruct param p = { .attrs = info->attrs };\n\tstruct sk_buff *msg;\n\tvoid *hdr;\n\tint cmd = info->genlhdr->cmd;\n\tint ret = -EMSGSIZE;\n\n\tmsg = genlmsg_new(NLMSG_GOODSIZE, GFP_KERNEL);\n\tif (!msg)\n\t\treturn -ENOMEM;\n\tp.msg = msg;\n\n\thdr = genlmsg_put_reply(msg, info, &thermal_gnl_family, 0, cmd);\n\tif (!hdr)\n\t\tgoto out_free_msg;\n\n\tret = cmd_cb[cmd](&p);\n\tif (ret)\n\t\tgoto out_cancel_msg;\n\n\tgenlmsg_end(msg, hdr);\n\n\treturn genlmsg_reply(msg, info);\n\nout_cancel_msg:\n\tgenlmsg_cancel(msg, hdr);\nout_free_msg:\n\tnlmsg_free(msg);\n\n\treturn ret;\n}\n\nstatic const struct genl_small_ops thermal_genl_ops[] = {\n\t{\n\t\t.cmd = THERMAL_GENL_CMD_TZ_GET_ID,\n\t\t.validate = GENL_DONT_VALIDATE_STRICT | GENL_DONT_VALIDATE_DUMP,\n\t\t.dumpit = thermal_genl_cmd_dumpit,\n\t},\n\t{\n\t\t.cmd = THERMAL_GENL_CMD_TZ_GET_TRIP,\n\t\t.validate = GENL_DONT_VALIDATE_STRICT | GENL_DONT_VALIDATE_DUMP,\n\t\t.doit = thermal_genl_cmd_doit,\n\t},\n\t{\n\t\t.cmd = THERMAL_GENL_CMD_TZ_GET_TEMP,\n\t\t.validate = GENL_DONT_VALIDATE_STRICT | GENL_DONT_VALIDATE_DUMP,\n\t\t.doit = thermal_genl_cmd_doit,\n\t},\n\t{\n\t\t.cmd = THERMAL_GENL_CMD_TZ_GET_GOV,\n\t\t.validate = GENL_DONT_VALIDATE_STRICT | GENL_DONT_VALIDATE_DUMP,\n\t\t.doit = thermal_genl_cmd_doit,\n\t},\n\t{\n\t\t.cmd = THERMAL_GENL_CMD_CDEV_GET,\n\t\t.validate = GENL_DONT_VALIDATE_STRICT | GENL_DONT_VALIDATE_DUMP,\n\t\t.dumpit = thermal_genl_cmd_dumpit,\n\t},\n};\n\nstatic struct genl_family thermal_gnl_family __ro_after_init = {\n\t.hdrsize\t= 0,\n\t.name\t\t= THERMAL_GENL_FAMILY_NAME,\n\t.version\t= THERMAL_GENL_VERSION,\n\t.maxattr\t= THERMAL_GENL_ATTR_MAX,\n\t.policy\t\t= thermal_genl_policy,\n\t.small_ops\t= thermal_genl_ops,\n\t.n_small_ops\t= ARRAY_SIZE(thermal_genl_ops),\n\t.resv_start_op\t= THERMAL_GENL_CMD_CDEV_GET + 1,\n\t.mcgrps\t\t= thermal_genl_mcgrps,\n\t.n_mcgrps\t= ARRAY_SIZE(thermal_genl_mcgrps),\n};\n\nint __init thermal_netlink_init(void)\n{\n\treturn genl_register_family(&thermal_gnl_family);\n}\n\nvoid __init thermal_netlink_exit(void)\n{\n\tgenl_unregister_family(&thermal_gnl_family);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}