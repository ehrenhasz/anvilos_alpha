{
  "module_name": "soctherm-fuse.c",
  "hash_id": "50cbcf5036fbe36b5146a1cee1b159cfb978fc0269ba422e434cd5693e3b5284",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/tegra/soctherm-fuse.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <soc/tegra/fuse.h>\n\n#include \"soctherm.h\"\n\n#define NOMINAL_CALIB_FT\t\t\t105\n#define NOMINAL_CALIB_CP\t\t\t25\n\n#define FUSE_TSENSOR_CALIB_CP_TS_BASE_MASK\t0x1fff\n#define FUSE_TSENSOR_CALIB_FT_TS_BASE_MASK\t(0x1fff << 13)\n#define FUSE_TSENSOR_CALIB_FT_TS_BASE_SHIFT\t13\n\n#define FUSE_TSENSOR_COMMON\t\t\t0x180\n\n \n\n#define CALIB_COEFFICIENT 1000000LL\n\n \nstatic s64 div64_s64_precise(s64 a, s32 b)\n{\n\ts64 r, al;\n\n\t \n\tal = a << 16;\n\n\tr = div64_s64(al * 2 + 1, 2 * b);\n\treturn r >> 16;\n}\n\nint tegra_calc_shared_calib(const struct tegra_soctherm_fuse *tfuse,\n\t\t\t    struct tsensor_shared_calib *shared)\n{\n\tu32 val;\n\ts32 shifted_cp, shifted_ft;\n\tint err;\n\n\terr = tegra_fuse_readl(FUSE_TSENSOR_COMMON, &val);\n\tif (err)\n\t\treturn err;\n\n\tshared->base_cp = (val & tfuse->fuse_base_cp_mask) >>\n\t\t\t  tfuse->fuse_base_cp_shift;\n\tshared->base_ft = (val & tfuse->fuse_base_ft_mask) >>\n\t\t\t  tfuse->fuse_base_ft_shift;\n\n\tshifted_ft = (val & tfuse->fuse_shift_ft_mask) >>\n\t\t     tfuse->fuse_shift_ft_shift;\n\tshifted_ft = sign_extend32(shifted_ft, 4);\n\n\tif (tfuse->fuse_spare_realignment) {\n\t\terr = tegra_fuse_readl(tfuse->fuse_spare_realignment, &val);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tshifted_cp = sign_extend32(val, 5);\n\n\tshared->actual_temp_cp = 2 * NOMINAL_CALIB_CP + shifted_cp;\n\tshared->actual_temp_ft = 2 * NOMINAL_CALIB_FT + shifted_ft;\n\n\treturn 0;\n}\n\nint tegra_calc_tsensor_calib(const struct tegra_tsensor *sensor,\n\t\t\t     const struct tsensor_shared_calib *shared,\n\t\t\t     u32 *calibration)\n{\n\tconst struct tegra_tsensor_group *sensor_group;\n\tu32 val, calib;\n\ts32 actual_tsensor_ft, actual_tsensor_cp;\n\ts32 delta_sens, delta_temp;\n\ts32 mult, div;\n\ts16 therma, thermb;\n\ts64 temp;\n\tint err;\n\n\tsensor_group = sensor->group;\n\n\terr = tegra_fuse_readl(sensor->calib_fuse_offset, &val);\n\tif (err)\n\t\treturn err;\n\n\tactual_tsensor_cp = (shared->base_cp * 64) + sign_extend32(val, 12);\n\tval = (val & FUSE_TSENSOR_CALIB_FT_TS_BASE_MASK) >>\n\t      FUSE_TSENSOR_CALIB_FT_TS_BASE_SHIFT;\n\tactual_tsensor_ft = (shared->base_ft * 32) + sign_extend32(val, 12);\n\n\tdelta_sens = actual_tsensor_ft - actual_tsensor_cp;\n\tdelta_temp = shared->actual_temp_ft - shared->actual_temp_cp;\n\n\tmult = sensor_group->pdiv * sensor->config->tsample_ate;\n\tdiv = sensor->config->tsample * sensor_group->pdiv_ate;\n\n\ttemp = (s64)delta_temp * (1LL << 13) * mult;\n\ttherma = div64_s64_precise(temp, (s64)delta_sens * div);\n\n\ttemp = ((s64)actual_tsensor_ft * shared->actual_temp_cp) -\n\t\t((s64)actual_tsensor_cp * shared->actual_temp_ft);\n\tthermb = div64_s64_precise(temp, delta_sens);\n\n\ttemp = (s64)therma * sensor->fuse_corr_alpha;\n\ttherma = div64_s64_precise(temp, CALIB_COEFFICIENT);\n\n\ttemp = (s64)thermb * sensor->fuse_corr_alpha + sensor->fuse_corr_beta;\n\tthermb = div64_s64_precise(temp, CALIB_COEFFICIENT);\n\n\tcalib = ((u16)therma << SENSOR_CONFIG2_THERMA_SHIFT) |\n\t\t((u16)thermb << SENSOR_CONFIG2_THERMB_SHIFT);\n\n\t*calibration = calib;\n\n\treturn 0;\n}\n\nMODULE_AUTHOR(\"Wei Ni <wni@nvidia.com>\");\nMODULE_DESCRIPTION(\"Tegra SOCTHERM fuse management\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}