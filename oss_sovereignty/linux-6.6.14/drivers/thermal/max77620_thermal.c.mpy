{
  "module_name": "max77620_thermal.c",
  "hash_id": "94f49482c22de1a9e583cbb21f5bb106747dfa91515815e5a107d19efc62e75b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/max77620_thermal.c",
  "human_readable_source": "\n \n\n#include <linux/irq.h>\n#include <linux/interrupt.h>\n#include <linux/mfd/max77620.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n#include <linux/thermal.h>\n\n#define MAX77620_NORMAL_OPERATING_TEMP\t100000\n#define MAX77620_TJALARM1_TEMP\t\t120000\n#define MAX77620_TJALARM2_TEMP\t\t140000\n\nstruct max77620_therm_info {\n\tstruct device\t\t\t*dev;\n\tstruct regmap\t\t\t*rmap;\n\tstruct thermal_zone_device\t*tz_device;\n\tint\t\t\t\tirq_tjalarm1;\n\tint\t\t\t\tirq_tjalarm2;\n};\n\n \n\nstatic int max77620_thermal_read_temp(struct thermal_zone_device *tz, int *temp)\n{\n\tstruct max77620_therm_info *mtherm = thermal_zone_device_priv(tz);\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(mtherm->rmap, MAX77620_REG_STATLBT, &val);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (val & MAX77620_IRQ_TJALRM2_MASK)\n\t\t*temp = MAX77620_TJALARM2_TEMP;\n\telse if (val & MAX77620_IRQ_TJALRM1_MASK)\n\t\t*temp = MAX77620_TJALARM1_TEMP;\n\telse\n\t\t*temp = MAX77620_NORMAL_OPERATING_TEMP;\n\n\treturn 0;\n}\n\nstatic const struct thermal_zone_device_ops max77620_thermal_ops = {\n\t.get_temp = max77620_thermal_read_temp,\n};\n\nstatic irqreturn_t max77620_thermal_irq(int irq, void *data)\n{\n\tstruct max77620_therm_info *mtherm = data;\n\n\tif (irq == mtherm->irq_tjalarm1)\n\t\tdev_warn(mtherm->dev, \"Junction Temp Alarm1(120C) occurred\\n\");\n\telse if (irq == mtherm->irq_tjalarm2)\n\t\tdev_crit(mtherm->dev, \"Junction Temp Alarm2(140C) occurred\\n\");\n\n\tthermal_zone_device_update(mtherm->tz_device,\n\t\t\t\t   THERMAL_EVENT_UNSPECIFIED);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int max77620_thermal_probe(struct platform_device *pdev)\n{\n\tstruct max77620_therm_info *mtherm;\n\tint ret;\n\n\tmtherm = devm_kzalloc(&pdev->dev, sizeof(*mtherm), GFP_KERNEL);\n\tif (!mtherm)\n\t\treturn -ENOMEM;\n\n\tmtherm->irq_tjalarm1 = platform_get_irq(pdev, 0);\n\tmtherm->irq_tjalarm2 = platform_get_irq(pdev, 1);\n\tif ((mtherm->irq_tjalarm1 < 0) || (mtherm->irq_tjalarm2 < 0)) {\n\t\tdev_err(&pdev->dev, \"Alarm irq number not available\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tmtherm->dev = &pdev->dev;\n\tmtherm->rmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!mtherm->rmap) {\n\t\tdev_err(&pdev->dev, \"Failed to get parent regmap\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tdevice_set_of_node_from_dev(&pdev->dev, pdev->dev.parent);\n\n\tmtherm->tz_device = devm_thermal_of_zone_register(&pdev->dev, 0,\n\t\t\t\tmtherm, &max77620_thermal_ops);\n\tif (IS_ERR(mtherm->tz_device)) {\n\t\tret = PTR_ERR(mtherm->tz_device);\n\t\tdev_err(&pdev->dev, \"Failed to register thermal zone: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tret = devm_request_threaded_irq(&pdev->dev, mtherm->irq_tjalarm1, NULL,\n\t\t\t\t\tmax77620_thermal_irq,\n\t\t\t\t\tIRQF_ONESHOT | IRQF_SHARED,\n\t\t\t\t\tdev_name(&pdev->dev), mtherm);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"Failed to request irq1: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_request_threaded_irq(&pdev->dev, mtherm->irq_tjalarm2, NULL,\n\t\t\t\t\tmax77620_thermal_irq,\n\t\t\t\t\tIRQF_ONESHOT | IRQF_SHARED,\n\t\t\t\t\tdev_name(&pdev->dev), mtherm);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"Failed to request irq2: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_device_id max77620_thermal_devtype[] = {\n\t{ .name = \"max77620-thermal\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(platform, max77620_thermal_devtype);\n\nstatic struct platform_driver max77620_thermal_driver = {\n\t.driver = {\n\t\t.name = \"max77620-thermal\",\n\t},\n\t.probe = max77620_thermal_probe,\n\t.id_table = max77620_thermal_devtype,\n};\n\nmodule_platform_driver(max77620_thermal_driver);\n\nMODULE_DESCRIPTION(\"Max77620 Junction temperature Thermal driver\");\nMODULE_AUTHOR(\"Laxman Dewangan <ldewangan@nvidia.com>\");\nMODULE_AUTHOR(\"Mallikarjun Kasoju <mkasoju@nvidia.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}