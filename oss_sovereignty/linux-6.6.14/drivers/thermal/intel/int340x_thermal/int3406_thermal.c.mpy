{
  "module_name": "int3406_thermal.c",
  "hash_id": "5b5cab8696c7196aa7e9f5a44a647442e6245a527b02b579bdb64b668e10a20f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/intel/int340x_thermal/int3406_thermal.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/acpi.h>\n#include <linux/backlight.h>\n#include <linux/thermal.h>\n#include <acpi/video.h>\n\n#define INT3406_BRIGHTNESS_LIMITS_CHANGED\t0x80\n\nstruct int3406_thermal_data {\n\tint upper_limit;\n\tint lower_limit;\n\tacpi_handle handle;\n\tstruct acpi_video_device_brightness *br;\n\tstruct backlight_device *raw_bd;\n\tstruct thermal_cooling_device *cooling_dev;\n};\n\n \n#define ACPI_TO_RAW(v, d) (d->raw_bd->props.max_brightness * v / 100)\n#define RAW_TO_ACPI(v, d) (v * 100 / d->raw_bd->props.max_brightness)\n\nstatic int\nint3406_thermal_get_max_state(struct thermal_cooling_device *cooling_dev,\n\t\t\t      unsigned long *state)\n{\n\tstruct int3406_thermal_data *d = cooling_dev->devdata;\n\n\t*state = d->upper_limit - d->lower_limit;\n\treturn 0;\n}\n\nstatic int\nint3406_thermal_set_cur_state(struct thermal_cooling_device *cooling_dev,\n\t\t\t      unsigned long state)\n{\n\tstruct int3406_thermal_data *d = cooling_dev->devdata;\n\tint acpi_level, raw_level;\n\n\tif (state > d->upper_limit - d->lower_limit)\n\t\treturn -EINVAL;\n\n\tacpi_level = d->br->levels[d->upper_limit - state];\n\n\traw_level = ACPI_TO_RAW(acpi_level, d);\n\n\treturn backlight_device_set_brightness(d->raw_bd, raw_level);\n}\n\nstatic int\nint3406_thermal_get_cur_state(struct thermal_cooling_device *cooling_dev,\n\t\t\t      unsigned long *state)\n{\n\tstruct int3406_thermal_data *d = cooling_dev->devdata;\n\tint acpi_level;\n\tint index;\n\n\tacpi_level = RAW_TO_ACPI(d->raw_bd->props.brightness, d);\n\n\t \n\tfor (index = d->lower_limit; index < d->upper_limit; index++) {\n\t\tif (acpi_level <= d->br->levels[index])\n\t\t\tbreak;\n\t}\n\n\t*state = d->upper_limit - index;\n\treturn 0;\n}\n\nstatic const struct thermal_cooling_device_ops video_cooling_ops = {\n\t.get_max_state = int3406_thermal_get_max_state,\n\t.get_cur_state = int3406_thermal_get_cur_state,\n\t.set_cur_state = int3406_thermal_set_cur_state,\n};\n\nstatic int int3406_thermal_get_index(int *array, int nr, int value)\n{\n\tint i;\n\n\tfor (i = 2; i < nr; i++) {\n\t\tif (array[i] == value)\n\t\t\tbreak;\n\t}\n\treturn i == nr ? -ENOENT : i;\n}\n\nstatic void int3406_thermal_get_limit(struct int3406_thermal_data *d)\n{\n\tacpi_status status;\n\tunsigned long long lower_limit, upper_limit;\n\n\tstatus = acpi_evaluate_integer(d->handle, \"DDDL\", NULL, &lower_limit);\n\tif (ACPI_SUCCESS(status))\n\t\td->lower_limit = int3406_thermal_get_index(d->br->levels,\n\t\t\t\t\td->br->count, lower_limit);\n\n\tstatus = acpi_evaluate_integer(d->handle, \"DDPC\", NULL, &upper_limit);\n\tif (ACPI_SUCCESS(status))\n\t\td->upper_limit = int3406_thermal_get_index(d->br->levels,\n\t\t\t\t\td->br->count, upper_limit);\n\n\t \n\td->lower_limit = d->lower_limit > 0 ? d->lower_limit : 2;\n\td->upper_limit = d->upper_limit > 0 ? d->upper_limit : d->br->count - 1;\n}\n\nstatic void int3406_notify(acpi_handle handle, u32 event, void *data)\n{\n\tif (event == INT3406_BRIGHTNESS_LIMITS_CHANGED)\n\t\tint3406_thermal_get_limit(data);\n}\n\nstatic int int3406_thermal_probe(struct platform_device *pdev)\n{\n\tstruct acpi_device *adev = ACPI_COMPANION(&pdev->dev);\n\tstruct int3406_thermal_data *d;\n\tstruct backlight_device *bd;\n\tint ret;\n\n\tif (!ACPI_HANDLE(&pdev->dev))\n\t\treturn -ENODEV;\n\n\td = devm_kzalloc(&pdev->dev, sizeof(*d), GFP_KERNEL);\n\tif (!d)\n\t\treturn -ENOMEM;\n\td->handle = ACPI_HANDLE(&pdev->dev);\n\n\tbd = backlight_device_get_by_type(BACKLIGHT_RAW);\n\tif (!bd)\n\t\treturn -ENODEV;\n\td->raw_bd = bd;\n\n\tret = acpi_video_get_levels(ACPI_COMPANION(&pdev->dev), &d->br, NULL);\n\tif (ret)\n\t\treturn ret;\n\n\tint3406_thermal_get_limit(d);\n\n\td->cooling_dev = thermal_cooling_device_register(acpi_device_bid(adev),\n\t\t\t\t\t\t\t d, &video_cooling_ops);\n\tif (IS_ERR(d->cooling_dev))\n\t\tgoto err;\n\n\tret = acpi_install_notify_handler(adev->handle, ACPI_DEVICE_NOTIFY,\n\t\t\t\t\t  int3406_notify, d);\n\tif (ret)\n\t\tgoto err_cdev;\n\n\tplatform_set_drvdata(pdev, d);\n\n\treturn 0;\n\nerr_cdev:\n\tthermal_cooling_device_unregister(d->cooling_dev);\nerr:\n\tkfree(d->br);\n\treturn -ENODEV;\n}\n\nstatic int int3406_thermal_remove(struct platform_device *pdev)\n{\n\tstruct int3406_thermal_data *d = platform_get_drvdata(pdev);\n\n\tthermal_cooling_device_unregister(d->cooling_dev);\n\tkfree(d->br);\n\treturn 0;\n}\n\nstatic const struct acpi_device_id int3406_thermal_match[] = {\n\t{\"INT3406\", 0},\n\t{}\n};\n\nMODULE_DEVICE_TABLE(acpi, int3406_thermal_match);\n\nstatic struct platform_driver int3406_thermal_driver = {\n\t.probe = int3406_thermal_probe,\n\t.remove = int3406_thermal_remove,\n\t.driver = {\n\t\t   .name = \"int3406 thermal\",\n\t\t   .acpi_match_table = int3406_thermal_match,\n\t\t   },\n};\n\nmodule_platform_driver(int3406_thermal_driver);\n\nMODULE_DESCRIPTION(\"INT3406 Thermal driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}