{
  "module_name": "processor_thermal_rfim.c",
  "hash_id": "d0583f00d35f3c96eeba13e0142241420ee34cb69ea14f49e272ced55b3b742c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/intel/int340x_thermal/processor_thermal_rfim.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include \"processor_thermal_device.h\"\n\nMODULE_IMPORT_NS(INT340X_THERMAL);\n\nstruct mmio_reg {\n\tint read_only;\n\tu32 offset;\n\tint bits;\n\tu16 mask;\n\tu16 shift;\n};\n\n \nstatic const char * const fivr_strings[] = {\n\t\"vco_ref_code_lo\",\n\t\"vco_ref_code_hi\",\n\t\"spread_spectrum_pct\",\n\t\"spread_spectrum_clk_enable\",\n\t\"rfi_vco_ref_code\",\n\t\"fivr_fffc_rev\",\n\tNULL\n};\n\nstatic const struct mmio_reg tgl_fivr_mmio_regs[] = {\n\t{ 0, 0x5A18, 3, 0x7, 11},  \n\t{ 0, 0x5A18, 8, 0xFF, 16},  \n\t{ 0, 0x5A08, 8, 0xFF, 0},  \n\t{ 0, 0x5A08, 1, 0x1, 8},  \n\t{ 1, 0x5A10, 12, 0xFFF, 0},  \n\t{ 1, 0x5A14, 2, 0x3, 1},  \n};\n\nstatic const char * const dlvr_strings[] = {\n\t\"dlvr_spread_spectrum_pct\",\n\t\"dlvr_control_mode\",\n\t\"dlvr_control_lock\",\n\t\"dlvr_rfim_enable\",\n\t\"dlvr_freq_select\",\n\t\"dlvr_hardware_rev\",\n\t\"dlvr_freq_mhz\",\n\t\"dlvr_pll_busy\",\n\tNULL\n};\n\nstatic const struct mmio_reg dlvr_mmio_regs[] = {\n\t{ 0, 0x15A08, 5, 0x1F, 0},  \n\t{ 0, 0x15A08, 1, 0x1, 5},  \n\t{ 0, 0x15A08, 1, 0x1, 6},  \n\t{ 0, 0x15A08, 1, 0x1, 7},  \n\t{ 0, 0x15A08, 12, 0xFFF, 8},  \n\t{ 1, 0x15A10, 2, 0x3, 30},  \n\t{ 1, 0x15A10, 16, 0xFFFF, 0},  \n\t{ 1, 0x15A10, 1, 0x1, 16},  \n};\n\n \nstatic const char * const dvfs_strings[] = {\n\t\"rfi_restriction_run_busy\",\n\t\"rfi_restriction_err_code\",\n\t\"rfi_restriction_data_rate\",\n\t\"rfi_restriction_data_rate_base\",\n\t\"ddr_data_rate_point_0\",\n\t\"ddr_data_rate_point_1\",\n\t\"ddr_data_rate_point_2\",\n\t\"ddr_data_rate_point_3\",\n\t\"rfi_disable\",\n\tNULL\n};\n\nstatic const struct mmio_reg adl_dvfs_mmio_regs[] = {\n\t{ 0, 0x5A38, 1, 0x1, 31},  \n\t{ 0, 0x5A38, 7, 0x7F, 24},  \n\t{ 0, 0x5A38, 8, 0xFF, 16},  \n\t{ 0, 0x5A38, 16, 0xFFFF, 0},  \n\t{ 0, 0x5A30, 10, 0x3FF, 0},  \n\t{ 0, 0x5A30, 10, 0x3FF, 10},  \n\t{ 0, 0x5A30, 10, 0x3FF, 20},  \n\t{ 0, 0x5A30, 10, 0x3FF, 30},  \n\t{ 0, 0x5A40, 1, 0x1, 0},  \n};\n\n#define RFIM_SHOW(suffix, table)\\\nstatic ssize_t suffix##_show(struct device *dev,\\\n\t\t\t      struct device_attribute *attr,\\\n\t\t\t      char *buf)\\\n{\\\n\tstruct proc_thermal_device *proc_priv;\\\n\tstruct pci_dev *pdev = to_pci_dev(dev);\\\n\tconst struct mmio_reg *mmio_regs;\\\n\tconst char **match_strs;\\\n\tu32 reg_val;\\\n\tint ret;\\\n\\\n\tproc_priv = pci_get_drvdata(pdev);\\\n\tif (table == 1) {\\\n\t\tmatch_strs = (const char **)dvfs_strings;\\\n\t\tmmio_regs = adl_dvfs_mmio_regs;\\\n\t} else if (table == 2) { \\\n\t\tmatch_strs = (const char **)dlvr_strings;\\\n\t\tmmio_regs = dlvr_mmio_regs;\\\n\t} else {\\\n\t\tmatch_strs = (const char **)fivr_strings;\\\n\t\tmmio_regs = tgl_fivr_mmio_regs;\\\n\t} \\\n\tret = match_string(match_strs, -1, attr->attr.name);\\\n\tif (ret < 0)\\\n\t\treturn ret;\\\n\treg_val = readl((void __iomem *) (proc_priv->mmio_base + mmio_regs[ret].offset));\\\n\tret = (reg_val >> mmio_regs[ret].shift) & mmio_regs[ret].mask;\\\n\treturn sprintf(buf, \"%u\\n\", ret);\\\n}\n\n#define RFIM_STORE(suffix, table)\\\nstatic ssize_t suffix##_store(struct device *dev,\\\n\t\t\t       struct device_attribute *attr,\\\n\t\t\t       const char *buf, size_t count)\\\n{\\\n\tstruct proc_thermal_device *proc_priv;\\\n\tstruct pci_dev *pdev = to_pci_dev(dev);\\\n\tunsigned int input;\\\n\tconst char **match_strs;\\\n\tconst struct mmio_reg *mmio_regs;\\\n\tint ret, err;\\\n\tu32 reg_val;\\\n\tu32 mask;\\\n\\\n\tproc_priv = pci_get_drvdata(pdev);\\\n\tif (table == 1) {\\\n\t\tmatch_strs = (const char **)dvfs_strings;\\\n\t\tmmio_regs = adl_dvfs_mmio_regs;\\\n\t} else if (table == 2) { \\\n\t\tmatch_strs = (const char **)dlvr_strings;\\\n\t\tmmio_regs = dlvr_mmio_regs;\\\n\t} else {\\\n\t\tmatch_strs = (const char **)fivr_strings;\\\n\t\tmmio_regs = tgl_fivr_mmio_regs;\\\n\t} \\\n\t\\\n\tret = match_string(match_strs, -1, attr->attr.name);\\\n\tif (ret < 0)\\\n\t\treturn ret;\\\n\tif (mmio_regs[ret].read_only)\\\n\t\treturn -EPERM;\\\n\terr = kstrtouint(buf, 10, &input);\\\n\tif (err)\\\n\t\treturn err;\\\n\tmask = GENMASK(mmio_regs[ret].shift + mmio_regs[ret].bits - 1, mmio_regs[ret].shift);\\\n\treg_val = readl((void __iomem *) (proc_priv->mmio_base + mmio_regs[ret].offset));\\\n\treg_val &= ~mask;\\\n\treg_val |= (input << mmio_regs[ret].shift);\\\n\twritel(reg_val, (void __iomem *) (proc_priv->mmio_base + mmio_regs[ret].offset));\\\n\treturn count;\\\n}\n\nRFIM_SHOW(vco_ref_code_lo, 0)\nRFIM_SHOW(vco_ref_code_hi, 0)\nRFIM_SHOW(spread_spectrum_pct, 0)\nRFIM_SHOW(spread_spectrum_clk_enable, 0)\nRFIM_SHOW(rfi_vco_ref_code, 0)\nRFIM_SHOW(fivr_fffc_rev, 0)\n\nRFIM_STORE(vco_ref_code_lo, 0)\nRFIM_STORE(vco_ref_code_hi, 0)\nRFIM_STORE(spread_spectrum_pct, 0)\nRFIM_STORE(spread_spectrum_clk_enable, 0)\nRFIM_STORE(rfi_vco_ref_code, 0)\nRFIM_STORE(fivr_fffc_rev, 0)\n\nRFIM_SHOW(dlvr_spread_spectrum_pct, 2)\nRFIM_SHOW(dlvr_control_mode, 2)\nRFIM_SHOW(dlvr_control_lock, 2)\nRFIM_SHOW(dlvr_hardware_rev, 2)\nRFIM_SHOW(dlvr_freq_mhz, 2)\nRFIM_SHOW(dlvr_pll_busy, 2)\nRFIM_SHOW(dlvr_freq_select, 2)\nRFIM_SHOW(dlvr_rfim_enable, 2)\n\nRFIM_STORE(dlvr_spread_spectrum_pct, 2)\nRFIM_STORE(dlvr_rfim_enable, 2)\nRFIM_STORE(dlvr_freq_select, 2)\nRFIM_STORE(dlvr_control_mode, 2)\nRFIM_STORE(dlvr_control_lock, 2)\n\nstatic DEVICE_ATTR_RW(dlvr_spread_spectrum_pct);\nstatic DEVICE_ATTR_RW(dlvr_control_mode);\nstatic DEVICE_ATTR_RW(dlvr_control_lock);\nstatic DEVICE_ATTR_RW(dlvr_freq_select);\nstatic DEVICE_ATTR_RO(dlvr_hardware_rev);\nstatic DEVICE_ATTR_RO(dlvr_freq_mhz);\nstatic DEVICE_ATTR_RO(dlvr_pll_busy);\nstatic DEVICE_ATTR_RW(dlvr_rfim_enable);\n\nstatic struct attribute *dlvr_attrs[] = {\n\t&dev_attr_dlvr_spread_spectrum_pct.attr,\n\t&dev_attr_dlvr_control_mode.attr,\n\t&dev_attr_dlvr_control_lock.attr,\n\t&dev_attr_dlvr_freq_select.attr,\n\t&dev_attr_dlvr_hardware_rev.attr,\n\t&dev_attr_dlvr_freq_mhz.attr,\n\t&dev_attr_dlvr_pll_busy.attr,\n\t&dev_attr_dlvr_rfim_enable.attr,\n\tNULL\n};\n\nstatic const struct attribute_group dlvr_attribute_group = {\n\t.attrs = dlvr_attrs,\n\t.name = \"dlvr\"\n};\n\nstatic DEVICE_ATTR_RW(vco_ref_code_lo);\nstatic DEVICE_ATTR_RW(vco_ref_code_hi);\nstatic DEVICE_ATTR_RW(spread_spectrum_pct);\nstatic DEVICE_ATTR_RW(spread_spectrum_clk_enable);\nstatic DEVICE_ATTR_RW(rfi_vco_ref_code);\nstatic DEVICE_ATTR_RW(fivr_fffc_rev);\n\nstatic struct attribute *fivr_attrs[] = {\n\t&dev_attr_vco_ref_code_lo.attr,\n\t&dev_attr_vco_ref_code_hi.attr,\n\t&dev_attr_spread_spectrum_pct.attr,\n\t&dev_attr_spread_spectrum_clk_enable.attr,\n\t&dev_attr_rfi_vco_ref_code.attr,\n\t&dev_attr_fivr_fffc_rev.attr,\n\tNULL\n};\n\nstatic const struct attribute_group fivr_attribute_group = {\n\t.attrs = fivr_attrs,\n\t.name = \"fivr\"\n};\n\nRFIM_SHOW(rfi_restriction_run_busy, 1)\nRFIM_SHOW(rfi_restriction_err_code, 1)\nRFIM_SHOW(rfi_restriction_data_rate, 1)\nRFIM_SHOW(rfi_restriction_data_rate_base, 1)\nRFIM_SHOW(ddr_data_rate_point_0, 1)\nRFIM_SHOW(ddr_data_rate_point_1, 1)\nRFIM_SHOW(ddr_data_rate_point_2, 1)\nRFIM_SHOW(ddr_data_rate_point_3, 1)\nRFIM_SHOW(rfi_disable, 1)\n\nRFIM_STORE(rfi_restriction_run_busy, 1)\nRFIM_STORE(rfi_restriction_err_code, 1)\nRFIM_STORE(rfi_restriction_data_rate, 1)\nRFIM_STORE(rfi_restriction_data_rate_base, 1)\nRFIM_STORE(rfi_disable, 1)\n\nstatic DEVICE_ATTR_RW(rfi_restriction_run_busy);\nstatic DEVICE_ATTR_RW(rfi_restriction_err_code);\nstatic DEVICE_ATTR_RW(rfi_restriction_data_rate);\nstatic DEVICE_ATTR_RW(rfi_restriction_data_rate_base);\nstatic DEVICE_ATTR_RO(ddr_data_rate_point_0);\nstatic DEVICE_ATTR_RO(ddr_data_rate_point_1);\nstatic DEVICE_ATTR_RO(ddr_data_rate_point_2);\nstatic DEVICE_ATTR_RO(ddr_data_rate_point_3);\nstatic DEVICE_ATTR_RW(rfi_disable);\n\nstatic ssize_t rfi_restriction_store(struct device *dev,\n\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t     const char *buf, size_t count)\n{\n\tu16 id = 0x0008;\n\tu32 input;\n\tint ret;\n\n\tret = kstrtou32(buf, 10, &input);\n\tif (ret)\n\t\treturn ret;\n\n\tret = processor_thermal_send_mbox_write_cmd(to_pci_dev(dev), id, input);\n\tif (ret)\n\t\treturn ret;\n\n\treturn count;\n}\n\nstatic ssize_t rfi_restriction_show(struct device *dev,\n\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t    char *buf)\n{\n\tu16 id = 0x0007;\n\tu64 resp;\n\tint ret;\n\n\tret = processor_thermal_send_mbox_read_cmd(to_pci_dev(dev), id, &resp);\n\tif (ret)\n\t\treturn ret;\n\n\treturn sprintf(buf, \"%llu\\n\", resp);\n}\n\nstatic ssize_t ddr_data_rate_show(struct device *dev,\n\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t  char *buf)\n{\n\tu16 id = 0x0107;\n\tu64 resp;\n\tint ret;\n\n\tret = processor_thermal_send_mbox_read_cmd(to_pci_dev(dev), id, &resp);\n\tif (ret)\n\t\treturn ret;\n\n\treturn sprintf(buf, \"%llu\\n\", resp);\n}\n\nstatic DEVICE_ATTR_RW(rfi_restriction);\nstatic DEVICE_ATTR_RO(ddr_data_rate);\n\nstatic struct attribute *dvfs_attrs[] = {\n\t&dev_attr_rfi_restriction_run_busy.attr,\n\t&dev_attr_rfi_restriction_err_code.attr,\n\t&dev_attr_rfi_restriction_data_rate.attr,\n\t&dev_attr_rfi_restriction_data_rate_base.attr,\n\t&dev_attr_ddr_data_rate_point_0.attr,\n\t&dev_attr_ddr_data_rate_point_1.attr,\n\t&dev_attr_ddr_data_rate_point_2.attr,\n\t&dev_attr_ddr_data_rate_point_3.attr,\n\t&dev_attr_rfi_disable.attr,\n\t&dev_attr_ddr_data_rate.attr,\n\t&dev_attr_rfi_restriction.attr,\n\tNULL\n};\n\nstatic const struct attribute_group dvfs_attribute_group = {\n\t.attrs = dvfs_attrs,\n\t.name = \"dvfs\"\n};\n\nint proc_thermal_rfim_add(struct pci_dev *pdev, struct proc_thermal_device *proc_priv)\n{\n\tint ret;\n\n\tif (proc_priv->mmio_feature_mask & PROC_THERMAL_FEATURE_FIVR) {\n\t\tret = sysfs_create_group(&pdev->dev.kobj, &fivr_attribute_group);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (proc_priv->mmio_feature_mask & PROC_THERMAL_FEATURE_DLVR) {\n\t\tret = sysfs_create_group(&pdev->dev.kobj, &dlvr_attribute_group);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (proc_priv->mmio_feature_mask & PROC_THERMAL_FEATURE_DVFS) {\n\t\tret = sysfs_create_group(&pdev->dev.kobj, &dvfs_attribute_group);\n\t\tif (ret && proc_priv->mmio_feature_mask & PROC_THERMAL_FEATURE_FIVR) {\n\t\t\tsysfs_remove_group(&pdev->dev.kobj, &fivr_attribute_group);\n\t\t\treturn ret;\n\t\t}\n\t\tif (ret && proc_priv->mmio_feature_mask & PROC_THERMAL_FEATURE_DLVR) {\n\t\t\tsysfs_remove_group(&pdev->dev.kobj, &dlvr_attribute_group);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(proc_thermal_rfim_add);\n\nvoid proc_thermal_rfim_remove(struct pci_dev *pdev)\n{\n\tstruct proc_thermal_device *proc_priv = pci_get_drvdata(pdev);\n\n\tif (proc_priv->mmio_feature_mask & PROC_THERMAL_FEATURE_FIVR)\n\t\tsysfs_remove_group(&pdev->dev.kobj, &fivr_attribute_group);\n\n\tif (proc_priv->mmio_feature_mask & PROC_THERMAL_FEATURE_DLVR)\n\t\tsysfs_remove_group(&pdev->dev.kobj, &dlvr_attribute_group);\n\n\tif (proc_priv->mmio_feature_mask & PROC_THERMAL_FEATURE_DVFS)\n\t\tsysfs_remove_group(&pdev->dev.kobj, &dvfs_attribute_group);\n}\nEXPORT_SYMBOL_GPL(proc_thermal_rfim_remove);\n\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}