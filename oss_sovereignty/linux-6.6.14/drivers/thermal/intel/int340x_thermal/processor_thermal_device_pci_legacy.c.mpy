{
  "module_name": "processor_thermal_device_pci_legacy.c",
  "hash_id": "c1f0550a112c061dea431cda623a56446760251671e35939dae391629df7d9d9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/intel/int340x_thermal/processor_thermal_device_pci_legacy.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/thermal.h>\n\n#include \"int340x_thermal_zone.h\"\n#include \"processor_thermal_device.h\"\n#include \"../intel_soc_dts_iosf.h\"\n\n#define DRV_NAME \"proc_thermal\"\n\nstatic irqreturn_t proc_thermal_pci_msi_irq(int irq, void *devid)\n{\n\tstruct proc_thermal_device *proc_priv;\n\tstruct pci_dev *pdev = devid;\n\n\tproc_priv = pci_get_drvdata(pdev);\n\n\tintel_soc_dts_iosf_interrupt_handler(proc_priv->soc_dts);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int proc_thermal_pci_probe(struct pci_dev *pdev,\n\t\t\t\t  const struct pci_device_id *id)\n{\n\tstruct proc_thermal_device *proc_priv;\n\tint ret;\n\n\tret = pcim_enable_device(pdev);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"error: could not enable device\\n\");\n\t\treturn ret;\n\t}\n\n\tproc_priv = devm_kzalloc(&pdev->dev, sizeof(*proc_priv), GFP_KERNEL);\n\tif (!proc_priv)\n\t\treturn -ENOMEM;\n\n\tret = proc_thermal_add(&pdev->dev, proc_priv);\n\tif (ret)\n\t\treturn ret;\n\n\tpci_set_drvdata(pdev, proc_priv);\n\n\tif (pdev->device == PCI_DEVICE_ID_INTEL_BSW_THERMAL) {\n\t\t \n\t\tproc_priv->soc_dts = intel_soc_dts_iosf_init(\n\t\t\t\t\tINTEL_SOC_DTS_INTERRUPT_MSI, false, 0);\n\n\t\tif (!IS_ERR(proc_priv->soc_dts) && pdev->irq) {\n\t\t\tret = pci_enable_msi(pdev);\n\t\t\tif (!ret) {\n\t\t\t\tret = request_threaded_irq(pdev->irq, NULL,\n\t\t\t\t\t\tproc_thermal_pci_msi_irq,\n\t\t\t\t\t\tIRQF_ONESHOT, \"proc_thermal\",\n\t\t\t\t\t\tpdev);\n\t\t\t\tif (ret) {\n\t\t\t\t\tintel_soc_dts_iosf_exit(\n\t\t\t\t\t\t\tproc_priv->soc_dts);\n\t\t\t\t\tpci_disable_msi(pdev);\n\t\t\t\t\tproc_priv->soc_dts = NULL;\n\t\t\t\t}\n\t\t\t}\n\t\t} else\n\t\t\tdev_err(&pdev->dev, \"No auxiliary DTSs enabled\\n\");\n\t} else {\n\n\t}\n\n\tret = proc_thermal_mmio_add(pdev, proc_priv, id->driver_data);\n\tif (ret) {\n\t\tproc_thermal_remove(proc_priv);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic void proc_thermal_pci_remove(struct pci_dev *pdev)\n{\n\tstruct proc_thermal_device *proc_priv = pci_get_drvdata(pdev);\n\n\tif (proc_priv->soc_dts) {\n\t\tintel_soc_dts_iosf_exit(proc_priv->soc_dts);\n\t\tif (pdev->irq) {\n\t\t\tfree_irq(pdev->irq, pdev);\n\t\t\tpci_disable_msi(pdev);\n\t\t}\n\t}\n\n\tproc_thermal_mmio_remove(pdev, proc_priv);\n\tproc_thermal_remove(proc_priv);\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int proc_thermal_pci_suspend(struct device *dev)\n{\n\treturn proc_thermal_suspend(dev);\n}\nstatic int proc_thermal_pci_resume(struct device *dev)\n{\n\treturn proc_thermal_resume(dev);\n}\n#else\n#define proc_thermal_pci_suspend NULL\n#define proc_thermal_pci_resume NULL\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(proc_thermal_pci_pm, proc_thermal_pci_suspend,\n\t\t\t proc_thermal_pci_resume);\n\nstatic const struct pci_device_id proc_thermal_pci_ids[] = {\n\t{ PCI_DEVICE_DATA(INTEL, BDW_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, BSW_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, BXT0_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, BXT1_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, BXTX_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, BXTP_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, CNL_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, CFL_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, GLK_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, HSB_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, ICL_THERMAL, PROC_THERMAL_FEATURE_RAPL) },\n\t{ PCI_DEVICE_DATA(INTEL, JSL_THERMAL, 0) },\n\t{ PCI_DEVICE_DATA(INTEL, SKL_THERMAL, PROC_THERMAL_FEATURE_RAPL) },\n\t{ PCI_DEVICE_DATA(INTEL, TGL_THERMAL, PROC_THERMAL_FEATURE_RAPL | PROC_THERMAL_FEATURE_FIVR | PROC_THERMAL_FEATURE_MBOX) },\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(pci, proc_thermal_pci_ids);\n\nstatic struct pci_driver proc_thermal_pci_driver = {\n\t.name\t\t= DRV_NAME,\n\t.probe\t\t= proc_thermal_pci_probe,\n\t.remove\t\t= proc_thermal_pci_remove,\n\t.id_table\t= proc_thermal_pci_ids,\n\t.driver.pm\t= &proc_thermal_pci_pm,\n};\n\nmodule_pci_driver(proc_thermal_pci_driver);\n\nMODULE_AUTHOR(\"Srinivas Pandruvada <srinivas.pandruvada@linux.intel.com>\");\nMODULE_DESCRIPTION(\"Processor Thermal Reporting Device Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}