{
  "module_name": "intel_tcc_cooling.c",
  "hash_id": "13b42f09325fc88ef5015cbb19fcffa0a8272cdf4865b91098043e9475512bd3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/intel/intel_tcc_cooling.c",
  "human_readable_source": "\n \n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/device.h>\n#include <linux/intel_tcc.h>\n#include <linux/module.h>\n#include <linux/thermal.h>\n#include <asm/cpu_device_id.h>\n\n#define TCC_PROGRAMMABLE\tBIT(30)\n#define TCC_LOCKED\t\tBIT(31)\n\nstatic struct thermal_cooling_device *tcc_cdev;\n\nstatic int tcc_get_max_state(struct thermal_cooling_device *cdev, unsigned long\n\t\t\t     *state)\n{\n\t*state = 0x3f;\n\treturn 0;\n}\n\nstatic int tcc_get_cur_state(struct thermal_cooling_device *cdev, unsigned long\n\t\t\t     *state)\n{\n\tint offset = intel_tcc_get_offset(-1);\n\n\tif (offset < 0)\n\t\treturn offset;\n\n\t*state = offset;\n\treturn 0;\n}\n\nstatic int tcc_set_cur_state(struct thermal_cooling_device *cdev, unsigned long\n\t\t\t     state)\n{\n\treturn intel_tcc_set_offset(-1, (int)state);\n}\n\nstatic const struct thermal_cooling_device_ops tcc_cooling_ops = {\n\t.get_max_state = tcc_get_max_state,\n\t.get_cur_state = tcc_get_cur_state,\n\t.set_cur_state = tcc_set_cur_state,\n};\n\nstatic const struct x86_cpu_id tcc_ids[] __initconst = {\n\tX86_MATCH_INTEL_FAM6_MODEL(SKYLAKE, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(SKYLAKE_L, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(KABYLAKE, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(KABYLAKE_L, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(ICELAKE, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(ICELAKE_L, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(TIGERLAKE, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(TIGERLAKE_L, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(COMETLAKE, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(ALDERLAKE, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(ALDERLAKE_L, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(ATOM_GRACEMONT, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(RAPTORLAKE, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(RAPTORLAKE_P, NULL),\n\tX86_MATCH_INTEL_FAM6_MODEL(RAPTORLAKE_S, NULL),\n\t{}\n};\n\nMODULE_DEVICE_TABLE(x86cpu, tcc_ids);\n\nstatic int __init tcc_cooling_init(void)\n{\n\tint ret;\n\tu64 val;\n\tconst struct x86_cpu_id *id;\n\n\tint err;\n\n\tid = x86_match_cpu(tcc_ids);\n\tif (!id)\n\t\treturn -ENODEV;\n\n\terr = rdmsrl_safe(MSR_PLATFORM_INFO, &val);\n\tif (err)\n\t\treturn err;\n\n\tif (!(val & TCC_PROGRAMMABLE))\n\t\treturn -ENODEV;\n\n\terr = rdmsrl_safe(MSR_IA32_TEMPERATURE_TARGET, &val);\n\tif (err)\n\t\treturn err;\n\n\tif (val & TCC_LOCKED) {\n\t\tpr_info(\"TCC Offset locked\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tpr_info(\"Programmable TCC Offset detected\\n\");\n\n\ttcc_cdev =\n\t    thermal_cooling_device_register(\"TCC Offset\", NULL,\n\t\t\t\t\t    &tcc_cooling_ops);\n\tif (IS_ERR(tcc_cdev)) {\n\t\tret = PTR_ERR(tcc_cdev);\n\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nmodule_init(tcc_cooling_init)\n\nstatic void __exit tcc_cooling_exit(void)\n{\n\tthermal_cooling_device_unregister(tcc_cdev);\n}\n\nmodule_exit(tcc_cooling_exit)\n\nMODULE_IMPORT_NS(INTEL_TCC);\nMODULE_DESCRIPTION(\"TCC offset cooling device Driver\");\nMODULE_AUTHOR(\"Zhang Rui <rui.zhang@intel.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}