{
  "module_name": "intel_pch_thermal.c",
  "hash_id": "c70b882e2777a03d6eec50972427592e7c6aa45aab73e31b5f689a6164b48614",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/intel/intel_pch_thermal.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/delay.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/pci.h>\n#include <linux/pm.h>\n#include <linux/suspend.h>\n#include <linux/thermal.h>\n#include <linux/types.h>\n#include <linux/units.h>\n\n \n#define PCH_THERMAL_DID_HSW_1\t0x9C24  \n#define PCH_THERMAL_DID_HSW_2\t0x8C24  \n#define PCH_THERMAL_DID_WPT\t0x9CA4  \n#define PCH_THERMAL_DID_SKL\t0x9D31  \n#define PCH_THERMAL_DID_SKL_H\t0xA131  \n#define PCH_THERMAL_DID_CNL\t0x9Df9  \n#define PCH_THERMAL_DID_CNL_H\t0xA379  \n#define PCH_THERMAL_DID_CNL_LP\t0x02F9  \n#define PCH_THERMAL_DID_CML_H\t0X06F9  \n#define PCH_THERMAL_DID_LWB\t0xA1B1  \n#define PCH_THERMAL_DID_WBG\t0x8D24  \n\n \n#define WPT_TEMP\t0x0000\t \n#define WPT_TSC\t0x04\t \n#define WPT_TSS\t0x06\t \n#define WPT_TSEL\t0x08\t \n#define WPT_TSREL\t0x0A\t \n#define WPT_TSMIC\t0x0C\t \n#define WPT_CTT\t0x0010\t \n#define WPT_TSPM\t0x001C\t \n#define WPT_TAHV\t0x0014\t \n#define WPT_TALV\t0x0018\t \n#define WPT_TL\t\t0x00000040\t \n#define WPT_PHL\t0x0060\t \n#define WPT_PHLC\t0x62\t \n#define WPT_TAS\t0x80\t \n#define WPT_TSPIEN\t0x82\t \n#define WPT_TSGPEN\t0x84\t \n\n \n#define WPT_TEMP_TSR\t0x01ff\t \n#define WPT_TSC_CPDE\t0x01\t \n#define WPT_TSS_TSDSS\t0x10\t \n#define WPT_TSS_GPES\t0x08\t \n#define WPT_TSEL_ETS\t0x01     \n#define WPT_TSEL_PLDB\t0x80\t \n#define WPT_TL_TOL\t0x000001FF\t \n#define WPT_TL_T1L\t0x1ff00000\t \n#define WPT_TL_TTEN\t0x20000000\t \n\n \n#define PCH_TEMP_OFFSET\t(-50)\n#define GET_WPT_TEMP(x)\t((x) * MILLIDEGREE_PER_DEGREE / 2 + WPT_TEMP_OFFSET)\n#define WPT_TEMP_OFFSET\t(PCH_TEMP_OFFSET * MILLIDEGREE_PER_DEGREE)\n#define GET_PCH_TEMP(x)\t(((x) / 2) + PCH_TEMP_OFFSET)\n\n#define PCH_MAX_TRIPS 3  \n\n \nstatic unsigned int delay_timeout = 100;\nmodule_param(delay_timeout, int, 0644);\nMODULE_PARM_DESC(delay_timeout, \"amount of time delay for each iteration.\");\n\n \nstatic unsigned int delay_cnt = 600;\nmodule_param(delay_cnt, int, 0644);\nMODULE_PARM_DESC(delay_cnt, \"total number of iterations for time delay.\");\n\nstatic char driver_name[] = \"Intel PCH thermal driver\";\n\nstruct pch_thermal_device {\n\tvoid __iomem *hw_base;\n\tstruct pci_dev *pdev;\n\tstruct thermal_zone_device *tzd;\n\tstruct thermal_trip trips[PCH_MAX_TRIPS];\n\tbool bios_enabled;\n};\n\n#ifdef CONFIG_ACPI\n \nstatic int pch_wpt_add_acpi_psv_trip(struct pch_thermal_device *ptd, int trip)\n{\n\tstruct acpi_device *adev;\n\tint temp;\n\n\tadev = ACPI_COMPANION(&ptd->pdev->dev);\n\tif (!adev)\n\t\treturn 0;\n\n\tif (thermal_acpi_passive_trip_temp(adev, &temp) || temp <= 0)\n\t\treturn 0;\n\n\tptd->trips[trip].type = THERMAL_TRIP_PASSIVE;\n\tptd->trips[trip].temperature = temp;\n\treturn 1;\n}\n#else\nstatic int pch_wpt_add_acpi_psv_trip(struct pch_thermal_device *ptd, int trip)\n{\n\treturn 0;\n}\n#endif\n\nstatic int pch_thermal_get_temp(struct thermal_zone_device *tzd, int *temp)\n{\n\tstruct pch_thermal_device *ptd = thermal_zone_device_priv(tzd);\n\n\t*temp = GET_WPT_TEMP(WPT_TEMP_TSR & readw(ptd->hw_base + WPT_TEMP));\n\treturn 0;\n}\n\nstatic void pch_critical(struct thermal_zone_device *tzd)\n{\n\tdev_dbg(thermal_zone_device(tzd), \"%s: critical temperature reached\\n\",\n\t\tthermal_zone_device_type(tzd));\n}\n\nstatic struct thermal_zone_device_ops tzd_ops = {\n\t.get_temp = pch_thermal_get_temp,\n\t.critical = pch_critical,\n};\n\nenum pch_board_ids {\n\tPCH_BOARD_HSW = 0,\n\tPCH_BOARD_WPT,\n\tPCH_BOARD_SKL,\n\tPCH_BOARD_CNL,\n\tPCH_BOARD_CML,\n\tPCH_BOARD_LWB,\n\tPCH_BOARD_WBG,\n};\n\nstatic const char *board_names[] = {\n\t[PCH_BOARD_HSW] = \"pch_haswell\",\n\t[PCH_BOARD_WPT] = \"pch_wildcat_point\",\n\t[PCH_BOARD_SKL] = \"pch_skylake\",\n\t[PCH_BOARD_CNL] = \"pch_cannonlake\",\n\t[PCH_BOARD_CML] = \"pch_cometlake\",\n\t[PCH_BOARD_LWB] = \"pch_lewisburg\",\n\t[PCH_BOARD_WBG] = \"pch_wellsburg\",\n};\n\nstatic int intel_pch_thermal_probe(struct pci_dev *pdev,\n\t\t\t\t   const struct pci_device_id *id)\n{\n\tenum pch_board_ids board_id = id->driver_data;\n\tstruct pch_thermal_device *ptd;\n\tint nr_trips = 0;\n\tu16 trip_temp;\n\tu8 tsel;\n\tint err;\n\n\tptd = devm_kzalloc(&pdev->dev, sizeof(*ptd), GFP_KERNEL);\n\tif (!ptd)\n\t\treturn -ENOMEM;\n\n\tpci_set_drvdata(pdev, ptd);\n\tptd->pdev = pdev;\n\n\terr = pci_enable_device(pdev);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"failed to enable pci device\\n\");\n\t\treturn err;\n\t}\n\n\terr = pci_request_regions(pdev, driver_name);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"failed to request pci region\\n\");\n\t\tgoto error_disable;\n\t}\n\n\tptd->hw_base = pci_ioremap_bar(pdev, 0);\n\tif (!ptd->hw_base) {\n\t\terr = -ENOMEM;\n\t\tdev_err(&pdev->dev, \"failed to map mem base\\n\");\n\t\tgoto error_release;\n\t}\n\n\t \n\tif (WPT_TSEL_ETS & readb(ptd->hw_base + WPT_TSEL)) {\n\t\tptd->bios_enabled = true;\n\t\tgoto read_trips;\n\t}\n\n\ttsel = readb(ptd->hw_base + WPT_TSEL);\n\t \n\tif (tsel & WPT_TSEL_PLDB) {\n\t\tdev_err(&ptd->pdev->dev, \"Sensor can't be enabled\\n\");\n\t\terr = -ENODEV;\n\t\tgoto error_cleanup;\n\t}\n\n\twriteb(tsel|WPT_TSEL_ETS, ptd->hw_base + WPT_TSEL);\n\tif (!(WPT_TSEL_ETS & readb(ptd->hw_base + WPT_TSEL))) {\n\t\tdev_err(&ptd->pdev->dev, \"Sensor can't be enabled\\n\");\n\t\terr = -ENODEV;\n\t\tgoto error_cleanup;\n\t}\n\nread_trips:\n\ttrip_temp = readw(ptd->hw_base + WPT_CTT);\n\ttrip_temp &= 0x1FF;\n\tif (trip_temp) {\n\t\tptd->trips[nr_trips].temperature = GET_WPT_TEMP(trip_temp);\n\t\tptd->trips[nr_trips++].type = THERMAL_TRIP_CRITICAL;\n\t}\n\n\ttrip_temp = readw(ptd->hw_base + WPT_PHL);\n\ttrip_temp &= 0x1FF;\n\tif (trip_temp) {\n\t\tptd->trips[nr_trips].temperature = GET_WPT_TEMP(trip_temp);\n\t\tptd->trips[nr_trips++].type = THERMAL_TRIP_HOT;\n\t}\n\n\tnr_trips += pch_wpt_add_acpi_psv_trip(ptd, nr_trips);\n\n\tptd->tzd = thermal_zone_device_register_with_trips(board_names[board_id],\n\t\t\t\t\t\t\t   ptd->trips, nr_trips,\n\t\t\t\t\t\t\t   0, ptd, &tzd_ops,\n\t\t\t\t\t\t\t   NULL, 0, 0);\n\tif (IS_ERR(ptd->tzd)) {\n\t\tdev_err(&pdev->dev, \"Failed to register thermal zone %s\\n\",\n\t\t\tboard_names[board_id]);\n\t\terr = PTR_ERR(ptd->tzd);\n\t\tgoto error_cleanup;\n\t}\n\terr = thermal_zone_device_enable(ptd->tzd);\n\tif (err)\n\t\tgoto err_unregister;\n\n\treturn 0;\n\nerr_unregister:\n\tthermal_zone_device_unregister(ptd->tzd);\nerror_cleanup:\n\tiounmap(ptd->hw_base);\nerror_release:\n\tpci_release_regions(pdev);\nerror_disable:\n\tpci_disable_device(pdev);\n\tdev_err(&pdev->dev, \"pci device failed to probe\\n\");\n\treturn err;\n}\n\nstatic void intel_pch_thermal_remove(struct pci_dev *pdev)\n{\n\tstruct pch_thermal_device *ptd = pci_get_drvdata(pdev);\n\n\tthermal_zone_device_unregister(ptd->tzd);\n\tiounmap(ptd->hw_base);\n\tpci_set_drvdata(pdev, NULL);\n\tpci_release_regions(pdev);\n\tpci_disable_device(pdev);\n}\n\nstatic int intel_pch_thermal_suspend_noirq(struct device *device)\n{\n\tstruct pch_thermal_device *ptd = dev_get_drvdata(device);\n\tu16 pch_thr_temp, pch_cur_temp;\n\tint pch_delay_cnt = 0;\n\tu8 tsel;\n\n\t \n\tif (!ptd->bios_enabled) {\n\t\ttsel = readb(ptd->hw_base + WPT_TSEL);\n\t\twriteb(tsel & 0xFE, ptd->hw_base + WPT_TSEL);\n\t\treturn 0;\n\t}\n\n\t \n\tif (pm_suspend_via_firmware())\n\t\treturn 0;\n\n\t \n\tpch_thr_temp = GET_PCH_TEMP(WPT_TEMP_TSR & readw(ptd->hw_base + WPT_TSPM));\n\n\t \n\tpch_cur_temp = GET_PCH_TEMP(WPT_TEMP_TSR & readw(ptd->hw_base + WPT_TEMP));\n\n\t \n\twhile (pch_delay_cnt < delay_cnt) {\n\t\tif (pch_cur_temp < pch_thr_temp)\n\t\t\tbreak;\n\n\t\tif (pm_wakeup_pending()) {\n\t\t\tdev_warn(&ptd->pdev->dev, \"Wakeup event detected, abort cooling\\n\");\n\t\t\treturn 0;\n\t\t}\n\n\t\tpch_delay_cnt++;\n\t\tdev_dbg(&ptd->pdev->dev,\n\t\t\t\"CPU-PCH current temp [%dC] higher than the threshold temp [%dC], sleep %d times for %d ms duration\\n\",\n\t\t\tpch_cur_temp, pch_thr_temp, pch_delay_cnt, delay_timeout);\n\t\tmsleep(delay_timeout);\n\t\t \n\t\tpch_cur_temp = GET_PCH_TEMP(WPT_TEMP_TSR & readw(ptd->hw_base + WPT_TEMP));\n\t}\n\n\tif (pch_cur_temp >= pch_thr_temp)\n\t\tdev_warn(&ptd->pdev->dev,\n\t\t\t\"CPU-PCH is hot [%dC] after %d ms delay. S0ix might fail\\n\",\n\t\t\tpch_cur_temp, pch_delay_cnt * delay_timeout);\n\telse {\n\t\tif (pch_delay_cnt)\n\t\t\tdev_info(&ptd->pdev->dev,\n\t\t\t\t\"CPU-PCH is cool [%dC] after %d ms delay\\n\",\n\t\t\t\tpch_cur_temp, pch_delay_cnt * delay_timeout);\n\t\telse\n\t\t\tdev_info(&ptd->pdev->dev,\n\t\t\t\t\"CPU-PCH is cool [%dC]\\n\",\n\t\t\t\tpch_cur_temp);\n\t}\n\n\treturn 0;\n}\n\nstatic int intel_pch_thermal_resume(struct device *device)\n{\n\tstruct pch_thermal_device *ptd = dev_get_drvdata(device);\n\tu8 tsel;\n\n\tif (ptd->bios_enabled)\n\t\treturn 0;\n\n\ttsel = readb(ptd->hw_base + WPT_TSEL);\n\n\twriteb(tsel | WPT_TSEL_ETS, ptd->hw_base + WPT_TSEL);\n\n\treturn 0;\n}\n\nstatic const struct pci_device_id intel_pch_thermal_id[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_HSW_1),\n\t\t.driver_data = PCH_BOARD_HSW, },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_HSW_2),\n\t\t.driver_data = PCH_BOARD_HSW, },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_WPT),\n\t\t.driver_data = PCH_BOARD_WPT, },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_SKL),\n\t\t.driver_data = PCH_BOARD_SKL, },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_SKL_H),\n\t\t.driver_data = PCH_BOARD_SKL, },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_CNL),\n\t\t.driver_data = PCH_BOARD_CNL, },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_CNL_H),\n\t\t.driver_data = PCH_BOARD_CNL, },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_CNL_LP),\n\t\t.driver_data = PCH_BOARD_CNL, },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_CML_H),\n\t\t.driver_data = PCH_BOARD_CML, },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_LWB),\n\t\t.driver_data = PCH_BOARD_LWB, },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCH_THERMAL_DID_WBG),\n\t\t.driver_data = PCH_BOARD_WBG, },\n\t{ 0, },\n};\nMODULE_DEVICE_TABLE(pci, intel_pch_thermal_id);\n\nstatic const struct dev_pm_ops intel_pch_pm_ops = {\n\t.suspend_noirq = intel_pch_thermal_suspend_noirq,\n\t.resume = intel_pch_thermal_resume,\n};\n\nstatic struct pci_driver intel_pch_thermal_driver = {\n\t.name\t\t= \"intel_pch_thermal\",\n\t.id_table\t= intel_pch_thermal_id,\n\t.probe\t\t= intel_pch_thermal_probe,\n\t.remove\t\t= intel_pch_thermal_remove,\n\t.driver.pm\t= &intel_pch_pm_ops,\n};\n\nmodule_pci_driver(intel_pch_thermal_driver);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Intel PCH Thermal driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}