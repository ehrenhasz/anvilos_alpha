{
  "module_name": "intel_tcc.c",
  "hash_id": "afc30705fe25d8ae76253488edcd9360c6c0edde29303d354eaded1879fbf3e8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/thermal/intel/intel_tcc.c",
  "human_readable_source": "\n \n\n#include <linux/errno.h>\n#include <linux/intel_tcc.h>\n#include <asm/msr.h>\n\n \nint intel_tcc_get_tjmax(int cpu)\n{\n\tu32 low, high;\n\tint val, err;\n\n\tif (cpu < 0)\n\t\terr = rdmsr_safe(MSR_IA32_TEMPERATURE_TARGET, &low, &high);\n\telse\n\t\terr = rdmsr_safe_on_cpu(cpu, MSR_IA32_TEMPERATURE_TARGET, &low, &high);\n\tif (err)\n\t\treturn err;\n\n\tval = (low >> 16) & 0xff;\n\n\treturn val ? val : -ENODATA;\n}\nEXPORT_SYMBOL_NS_GPL(intel_tcc_get_tjmax, INTEL_TCC);\n\n \nint intel_tcc_get_offset(int cpu)\n{\n\tu32 low, high;\n\tint err;\n\n\tif (cpu < 0)\n\t\terr = rdmsr_safe(MSR_IA32_TEMPERATURE_TARGET, &low, &high);\n\telse\n\t\terr = rdmsr_safe_on_cpu(cpu, MSR_IA32_TEMPERATURE_TARGET, &low, &high);\n\tif (err)\n\t\treturn err;\n\n\treturn (low >> 24) & 0x3f;\n}\nEXPORT_SYMBOL_NS_GPL(intel_tcc_get_offset, INTEL_TCC);\n\n \n\nint intel_tcc_set_offset(int cpu, int offset)\n{\n\tu32 low, high;\n\tint err;\n\n\tif (offset < 0 || offset > 0x3f)\n\t\treturn -EINVAL;\n\n\tif (cpu < 0)\n\t\terr = rdmsr_safe(MSR_IA32_TEMPERATURE_TARGET, &low, &high);\n\telse\n\t\terr = rdmsr_safe_on_cpu(cpu, MSR_IA32_TEMPERATURE_TARGET, &low, &high);\n\tif (err)\n\t\treturn err;\n\n\t \n\tif (low & BIT(31))\n\t\treturn -EPERM;\n\n\tlow &= ~(0x3f << 24);\n\tlow |= offset << 24;\n\n\tif (cpu < 0)\n\t\treturn wrmsr_safe(MSR_IA32_TEMPERATURE_TARGET, low, high);\n\telse\n\t\treturn wrmsr_safe_on_cpu(cpu, MSR_IA32_TEMPERATURE_TARGET, low, high);\n}\nEXPORT_SYMBOL_NS_GPL(intel_tcc_set_offset, INTEL_TCC);\n\n \nint intel_tcc_get_temp(int cpu, bool pkg)\n{\n\tu32 low, high;\n\tu32 msr = pkg ? MSR_IA32_PACKAGE_THERM_STATUS : MSR_IA32_THERM_STATUS;\n\tint tjmax, temp, err;\n\n\ttjmax = intel_tcc_get_tjmax(cpu);\n\tif (tjmax < 0)\n\t\treturn tjmax;\n\n\tif (cpu < 0)\n\t\terr = rdmsr_safe(msr, &low, &high);\n\telse\n\t\terr = rdmsr_safe_on_cpu(cpu, msr, &low, &high);\n\tif (err)\n\t\treturn err;\n\n\t \n\tif (!(low & BIT(31)))\n\t\treturn -ENODATA;\n\n\ttemp = tjmax - ((low >> 16) & 0x7f);\n\n\t \n\treturn temp >= 0 ? temp : -ENODATA;\n}\nEXPORT_SYMBOL_NS_GPL(intel_tcc_get_temp, INTEL_TCC);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}