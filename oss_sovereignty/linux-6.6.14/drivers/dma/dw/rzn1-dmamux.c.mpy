{
  "module_name": "rzn1-dmamux.c",
  "hash_id": "f4296c5ec28e663a6fc28fa5c795a24a3ff3f19454061e3f828f2057e16dcdb5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/dma/dw/rzn1-dmamux.c",
  "human_readable_source": "\n \n#include <linux/bitops.h>\n#include <linux/of.h>\n#include <linux/of_dma.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n#include <linux/soc/renesas/r9a06g032-sysctrl.h>\n#include <linux/types.h>\n\n#define RNZ1_DMAMUX_NCELLS 6\n#define RZN1_DMAMUX_MAX_LINES 64\n#define RZN1_DMAMUX_LINES_PER_CTLR 16\n\nstruct rzn1_dmamux_data {\n\tstruct dma_router dmarouter;\n\tDECLARE_BITMAP(used_chans, 2 * RZN1_DMAMUX_LINES_PER_CTLR);\n};\n\nstruct rzn1_dmamux_map {\n\tunsigned int req_idx;\n};\n\nstatic void rzn1_dmamux_free(struct device *dev, void *route_data)\n{\n\tstruct rzn1_dmamux_data *dmamux = dev_get_drvdata(dev);\n\tstruct rzn1_dmamux_map *map = route_data;\n\n\tdev_dbg(dev, \"Unmapping DMAMUX request %u\\n\", map->req_idx);\n\n\tclear_bit(map->req_idx, dmamux->used_chans);\n\n\tkfree(map);\n}\n\nstatic void *rzn1_dmamux_route_allocate(struct of_phandle_args *dma_spec,\n\t\t\t\t\tstruct of_dma *ofdma)\n{\n\tstruct platform_device *pdev = of_find_device_by_node(ofdma->of_node);\n\tstruct rzn1_dmamux_data *dmamux = platform_get_drvdata(pdev);\n\tstruct rzn1_dmamux_map *map;\n\tunsigned int dmac_idx, chan, val;\n\tu32 mask;\n\tint ret;\n\n\tif (dma_spec->args_count != RNZ1_DMAMUX_NCELLS)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tmap = kzalloc(sizeof(*map), GFP_KERNEL);\n\tif (!map)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tchan = dma_spec->args[0];\n\tmap->req_idx = dma_spec->args[4];\n\tval = dma_spec->args[5];\n\tdma_spec->args_count -= 2;\n\n\tif (chan >= RZN1_DMAMUX_LINES_PER_CTLR) {\n\t\tdev_err(&pdev->dev, \"Invalid DMA request line: %u\\n\", chan);\n\t\tret = -EINVAL;\n\t\tgoto free_map;\n\t}\n\n\tif (map->req_idx >= RZN1_DMAMUX_MAX_LINES ||\n\t    (map->req_idx % RZN1_DMAMUX_LINES_PER_CTLR) != chan) {\n\t\tdev_err(&pdev->dev, \"Invalid MUX request line: %u\\n\", map->req_idx);\n\t\tret = -EINVAL;\n\t\tgoto free_map;\n\t}\n\n\tdmac_idx = map->req_idx >= RZN1_DMAMUX_LINES_PER_CTLR ? 1 : 0;\n\tdma_spec->np = of_parse_phandle(ofdma->of_node, \"dma-masters\", dmac_idx);\n\tif (!dma_spec->np) {\n\t\tdev_err(&pdev->dev, \"Can't get DMA master\\n\");\n\t\tret = -EINVAL;\n\t\tgoto free_map;\n\t}\n\n\tdev_dbg(&pdev->dev, \"Mapping DMAMUX request %u to DMAC%u request %u\\n\",\n\t\tmap->req_idx, dmac_idx, chan);\n\n\tif (test_and_set_bit(map->req_idx, dmamux->used_chans)) {\n\t\tret = -EBUSY;\n\t\tgoto free_map;\n\t}\n\n\tmask = BIT(map->req_idx);\n\tret = r9a06g032_sysctrl_set_dmamux(mask, val ? mask : 0);\n\tif (ret)\n\t\tgoto clear_bitmap;\n\n\treturn map;\n\nclear_bitmap:\n\tclear_bit(map->req_idx, dmamux->used_chans);\nfree_map:\n\tkfree(map);\n\n\treturn ERR_PTR(ret);\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id rzn1_dmac_match[] = {\n\t{ .compatible = \"renesas,rzn1-dma\" },\n\t{}\n};\n#endif\n\nstatic int rzn1_dmamux_probe(struct platform_device *pdev)\n{\n\tstruct device_node *mux_node = pdev->dev.of_node;\n\tconst struct of_device_id *match;\n\tstruct device_node *dmac_node;\n\tstruct rzn1_dmamux_data *dmamux;\n\n\tdmamux = devm_kzalloc(&pdev->dev, sizeof(*dmamux), GFP_KERNEL);\n\tif (!dmamux)\n\t\treturn -ENOMEM;\n\n\tdmac_node = of_parse_phandle(mux_node, \"dma-masters\", 0);\n\tif (!dmac_node)\n\t\treturn dev_err_probe(&pdev->dev, -ENODEV, \"Can't get DMA master node\\n\");\n\n\tmatch = of_match_node(rzn1_dmac_match, dmac_node);\n\tof_node_put(dmac_node);\n\tif (!match)\n\t\treturn dev_err_probe(&pdev->dev, -EINVAL, \"DMA master is not supported\\n\");\n\n\tdmamux->dmarouter.dev = &pdev->dev;\n\tdmamux->dmarouter.route_free = rzn1_dmamux_free;\n\n\tplatform_set_drvdata(pdev, dmamux);\n\n\treturn of_dma_router_register(mux_node, rzn1_dmamux_route_allocate,\n\t\t\t\t      &dmamux->dmarouter);\n}\n\nstatic const struct of_device_id rzn1_dmamux_match[] = {\n\t{ .compatible = \"renesas,rzn1-dmamux\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, rzn1_dmamux_match);\n\nstatic struct platform_driver rzn1_dmamux_driver = {\n\t.driver = {\n\t\t.name = \"renesas,rzn1-dmamux\",\n\t\t.of_match_table = rzn1_dmamux_match,\n\t},\n\t.probe\t= rzn1_dmamux_probe,\n};\nmodule_platform_driver(rzn1_dmamux_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Miquel Raynal <miquel.raynal@bootlin.com\");\nMODULE_DESCRIPTION(\"Renesas RZ/N1 DMAMUX driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}