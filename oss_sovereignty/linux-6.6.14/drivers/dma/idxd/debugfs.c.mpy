{
  "module_name": "debugfs.c",
  "hash_id": "635d2b93c92674b9281c9d245cadfbb623abe4860260f72b45ca93f53789d6aa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/dma/idxd/debugfs.c",
  "human_readable_source": "\n \n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/debugfs.h>\n#include <linux/io-64-nonatomic-lo-hi.h>\n#include <uapi/linux/idxd.h>\n#include \"idxd.h\"\n#include \"registers.h\"\n\nstatic struct dentry *idxd_debugfs_dir;\n\nstatic void dump_event_entry(struct idxd_device *idxd, struct seq_file *s,\n\t\t\t     u16 index, int *count, bool processed)\n{\n\tstruct idxd_evl *evl = idxd->evl;\n\tstruct dsa_evl_entry *entry;\n\tstruct dsa_completion_record *cr;\n\tu64 *raw;\n\tint i;\n\tint evl_strides = evl_ent_size(idxd) / sizeof(u64);\n\n\tentry = (struct dsa_evl_entry *)evl->log + index;\n\n\tif (!entry->e.desc_valid)\n\t\treturn;\n\n\tseq_printf(s, \"Event Log entry %d (real index %u) processed: %u\\n\",\n\t\t   *count, index, processed);\n\n\tseq_printf(s, \"desc valid %u wq idx valid %u\\n\"\n\t\t   \"batch %u fault rw %u priv %u error 0x%x\\n\"\n\t\t   \"wq idx %u op %#x pasid %u batch idx %u\\n\"\n\t\t   \"fault addr %#llx\\n\",\n\t\t   entry->e.desc_valid, entry->e.wq_idx_valid,\n\t\t   entry->e.batch, entry->e.fault_rw, entry->e.priv,\n\t\t   entry->e.error, entry->e.wq_idx, entry->e.operation,\n\t\t   entry->e.pasid, entry->e.batch_idx, entry->e.fault_addr);\n\n\tcr = &entry->cr;\n\tseq_printf(s, \"status %#x result %#x fault_info %#x bytes_completed %u\\n\"\n\t\t   \"fault addr %#llx inv flags %#x\\n\\n\",\n\t\t   cr->status, cr->result, cr->fault_info, cr->bytes_completed,\n\t\t   cr->fault_addr, cr->invalid_flags);\n\n\traw = (u64 *)entry;\n\n\tfor (i = 0; i < evl_strides; i++)\n\t\tseq_printf(s, \"entry[%d] = %#llx\\n\", i, raw[i]);\n\n\tseq_puts(s, \"\\n\");\n\t*count += 1;\n}\n\nstatic int debugfs_evl_show(struct seq_file *s, void *d)\n{\n\tstruct idxd_device *idxd = s->private;\n\tstruct idxd_evl *evl = idxd->evl;\n\tunion evl_status_reg evl_status;\n\tu16 h, t, evl_size, i;\n\tint count = 0;\n\tbool processed = true;\n\n\tif (!evl || !evl->log)\n\t\treturn 0;\n\n\tspin_lock(&evl->lock);\n\n\th = evl->head;\n\tevl_status.bits = ioread64(idxd->reg_base + IDXD_EVLSTATUS_OFFSET);\n\tt = evl_status.tail;\n\tevl_size = evl->size;\n\n\tseq_printf(s, \"Event Log head %u tail %u interrupt pending %u\\n\\n\",\n\t\t   evl_status.head, evl_status.tail, evl_status.int_pending);\n\n\ti = t;\n\twhile (1) {\n\t\ti = (i + 1) % evl_size;\n\t\tif (i == t)\n\t\t\tbreak;\n\n\t\tif (processed && i == h)\n\t\t\tprocessed = false;\n\t\tdump_event_entry(idxd, s, i, &count, processed);\n\t}\n\n\tspin_unlock(&evl->lock);\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(debugfs_evl);\n\nint idxd_device_init_debugfs(struct idxd_device *idxd)\n{\n\tif (IS_ERR_OR_NULL(idxd_debugfs_dir))\n\t\treturn 0;\n\n\tidxd->dbgfs_dir = debugfs_create_dir(dev_name(idxd_confdev(idxd)), idxd_debugfs_dir);\n\tif (IS_ERR(idxd->dbgfs_dir))\n\t\treturn PTR_ERR(idxd->dbgfs_dir);\n\n\tif (idxd->evl) {\n\t\tidxd->dbgfs_evl_file = debugfs_create_file(\"event_log\", 0400,\n\t\t\t\t\t\t\t   idxd->dbgfs_dir, idxd,\n\t\t\t\t\t\t\t   &debugfs_evl_fops);\n\t\tif (IS_ERR(idxd->dbgfs_evl_file)) {\n\t\t\tdebugfs_remove_recursive(idxd->dbgfs_dir);\n\t\t\tidxd->dbgfs_dir = NULL;\n\t\t\treturn PTR_ERR(idxd->dbgfs_evl_file);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nvoid idxd_device_remove_debugfs(struct idxd_device *idxd)\n{\n\tdebugfs_remove_recursive(idxd->dbgfs_dir);\n}\n\nint idxd_init_debugfs(void)\n{\n\tif (!debugfs_initialized())\n\t\treturn 0;\n\n\tidxd_debugfs_dir = debugfs_create_dir(KBUILD_MODNAME, NULL);\n\tif (IS_ERR(idxd_debugfs_dir))\n\t\treturn  PTR_ERR(idxd_debugfs_dir);\n\treturn 0;\n}\n\nvoid idxd_remove_debugfs(void)\n{\n\tdebugfs_remove_recursive(idxd_debugfs_dir);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}