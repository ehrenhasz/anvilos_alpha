{
  "module_name": "gen_bd.c",
  "hash_id": "22a34c8a001bd934289ee96499f6194b7db3ef0136c190ddbe8e98b2130460f7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/dma/bestcomm/gen_bd.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/types.h>\n#include <asm/errno.h>\n#include <asm/io.h>\n\n#include <asm/mpc52xx.h>\n#include <asm/mpc52xx_psc.h>\n\n#include <linux/fsl/bestcomm/bestcomm.h>\n#include <linux/fsl/bestcomm/bestcomm_priv.h>\n#include <linux/fsl/bestcomm/gen_bd.h>\n\n\n \n \n \n\n \nextern u32 bcom_gen_bd_rx_task[];\nextern u32 bcom_gen_bd_tx_task[];\n\n \nstruct bcom_gen_bd_rx_var {\n\tu32 enable;\t\t \n\tu32 fifo;\t\t \n\tu32 bd_base;\t\t \n\tu32 bd_last;\t\t \n\tu32 bd_start;\t\t \n\tu32 buffer_size;\t \n};\n\n \nstruct bcom_gen_bd_rx_inc {\n\tu16 pad0;\n\ts16 incr_bytes;\n\tu16 pad1;\n\ts16 incr_dst;\n};\n\n \nstruct bcom_gen_bd_tx_var {\n\tu32 fifo;\t\t \n\tu32 enable;\t\t \n\tu32 bd_base;\t\t \n\tu32 bd_last;\t\t \n\tu32 bd_start;\t\t \n\tu32 buffer_size;\t \n};\n\n \nstruct bcom_gen_bd_tx_inc {\n\tu16 pad0;\n\ts16 incr_bytes;\n\tu16 pad1;\n\ts16 incr_src;\n\tu16 pad2;\n\ts16 incr_src_ma;\n};\n\n \nstruct bcom_gen_bd_priv {\n\tphys_addr_t\tfifo;\n\tint\t\tinitiator;\n\tint\t\tipr;\n\tint\t\tmaxbufsize;\n};\n\n\n \n \n \n\nstruct bcom_task *\nbcom_gen_bd_rx_init(int queue_len, phys_addr_t fifo,\n\t\t\tint initiator, int ipr, int maxbufsize)\n{\n\tstruct bcom_task *tsk;\n\tstruct bcom_gen_bd_priv *priv;\n\n\ttsk = bcom_task_alloc(queue_len, sizeof(struct bcom_gen_bd),\n\t\t\tsizeof(struct bcom_gen_bd_priv));\n\tif (!tsk)\n\t\treturn NULL;\n\n\ttsk->flags = BCOM_FLAGS_NONE;\n\n\tpriv = tsk->priv;\n\tpriv->fifo\t= fifo;\n\tpriv->initiator\t= initiator;\n\tpriv->ipr\t= ipr;\n\tpriv->maxbufsize = maxbufsize;\n\n\tif (bcom_gen_bd_rx_reset(tsk)) {\n\t\tbcom_task_free(tsk);\n\t\treturn NULL;\n\t}\n\n\treturn tsk;\n}\nEXPORT_SYMBOL_GPL(bcom_gen_bd_rx_init);\n\nint\nbcom_gen_bd_rx_reset(struct bcom_task *tsk)\n{\n\tstruct bcom_gen_bd_priv *priv = tsk->priv;\n\tstruct bcom_gen_bd_rx_var *var;\n\tstruct bcom_gen_bd_rx_inc *inc;\n\n\t \n\tbcom_disable_task(tsk->tasknum);\n\n\t \n\tvar = (struct bcom_gen_bd_rx_var *) bcom_task_var(tsk->tasknum);\n\tinc = (struct bcom_gen_bd_rx_inc *) bcom_task_inc(tsk->tasknum);\n\n\tif (bcom_load_image(tsk->tasknum, bcom_gen_bd_rx_task))\n\t\treturn -1;\n\n\tvar->enable\t= bcom_eng->regs_base +\n\t\t\t\toffsetof(struct mpc52xx_sdma, tcr[tsk->tasknum]);\n\tvar->fifo\t= (u32) priv->fifo;\n\tvar->bd_base\t= tsk->bd_pa;\n\tvar->bd_last\t= tsk->bd_pa + ((tsk->num_bd-1) * tsk->bd_size);\n\tvar->bd_start\t= tsk->bd_pa;\n\tvar->buffer_size = priv->maxbufsize;\n\n\tinc->incr_bytes\t= -(s16)sizeof(u32);\n\tinc->incr_dst\t= sizeof(u32);\n\n\t \n\ttsk->index = 0;\n\ttsk->outdex = 0;\n\n\tmemset_io(tsk->bd, 0x00, tsk->num_bd * tsk->bd_size);\n\n\t \n\tbcom_set_task_pragma(tsk->tasknum, BCOM_GEN_RX_BD_PRAGMA);\n\tbcom_set_task_auto_start(tsk->tasknum, tsk->tasknum);\n\n\tout_8(&bcom_eng->regs->ipr[priv->initiator], priv->ipr);\n\tbcom_set_initiator(tsk->tasknum, priv->initiator);\n\n\tout_be32(&bcom_eng->regs->IntPend, 1<<tsk->tasknum);\t \n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(bcom_gen_bd_rx_reset);\n\nvoid\nbcom_gen_bd_rx_release(struct bcom_task *tsk)\n{\n\t \n\tbcom_task_free(tsk);\n}\nEXPORT_SYMBOL_GPL(bcom_gen_bd_rx_release);\n\n\nextern struct bcom_task *\nbcom_gen_bd_tx_init(int queue_len, phys_addr_t fifo,\n\t\t\tint initiator, int ipr)\n{\n\tstruct bcom_task *tsk;\n\tstruct bcom_gen_bd_priv *priv;\n\n\ttsk = bcom_task_alloc(queue_len, sizeof(struct bcom_gen_bd),\n\t\t\tsizeof(struct bcom_gen_bd_priv));\n\tif (!tsk)\n\t\treturn NULL;\n\n\ttsk->flags = BCOM_FLAGS_NONE;\n\n\tpriv = tsk->priv;\n\tpriv->fifo\t= fifo;\n\tpriv->initiator\t= initiator;\n\tpriv->ipr\t= ipr;\n\n\tif (bcom_gen_bd_tx_reset(tsk)) {\n\t\tbcom_task_free(tsk);\n\t\treturn NULL;\n\t}\n\n\treturn tsk;\n}\nEXPORT_SYMBOL_GPL(bcom_gen_bd_tx_init);\n\nint\nbcom_gen_bd_tx_reset(struct bcom_task *tsk)\n{\n\tstruct bcom_gen_bd_priv *priv = tsk->priv;\n\tstruct bcom_gen_bd_tx_var *var;\n\tstruct bcom_gen_bd_tx_inc *inc;\n\n\t \n\tbcom_disable_task(tsk->tasknum);\n\n\t \n\tvar = (struct bcom_gen_bd_tx_var *) bcom_task_var(tsk->tasknum);\n\tinc = (struct bcom_gen_bd_tx_inc *) bcom_task_inc(tsk->tasknum);\n\n\tif (bcom_load_image(tsk->tasknum, bcom_gen_bd_tx_task))\n\t\treturn -1;\n\n\tvar->enable\t= bcom_eng->regs_base +\n\t\t\t\toffsetof(struct mpc52xx_sdma, tcr[tsk->tasknum]);\n\tvar->fifo\t= (u32) priv->fifo;\n\tvar->bd_base\t= tsk->bd_pa;\n\tvar->bd_last\t= tsk->bd_pa + ((tsk->num_bd-1) * tsk->bd_size);\n\tvar->bd_start\t= tsk->bd_pa;\n\n\tinc->incr_bytes\t= -(s16)sizeof(u32);\n\tinc->incr_src\t= sizeof(u32);\n\tinc->incr_src_ma = sizeof(u8);\n\n\t \n\ttsk->index = 0;\n\ttsk->outdex = 0;\n\n\tmemset_io(tsk->bd, 0x00, tsk->num_bd * tsk->bd_size);\n\n\t \n\tbcom_set_task_pragma(tsk->tasknum, BCOM_GEN_TX_BD_PRAGMA);\n\tbcom_set_task_auto_start(tsk->tasknum, tsk->tasknum);\n\n\tout_8(&bcom_eng->regs->ipr[priv->initiator], priv->ipr);\n\tbcom_set_initiator(tsk->tasknum, priv->initiator);\n\n\tout_be32(&bcom_eng->regs->IntPend, 1<<tsk->tasknum);\t \n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(bcom_gen_bd_tx_reset);\n\nvoid\nbcom_gen_bd_tx_release(struct bcom_task *tsk)\n{\n\t \n\tbcom_task_free(tsk);\n}\nEXPORT_SYMBOL_GPL(bcom_gen_bd_tx_release);\n\n \n\n \nstatic struct bcom_psc_params {\n\tint rx_initiator;\n\tint rx_ipr;\n\tint tx_initiator;\n\tint tx_ipr;\n} bcom_psc_params[] = {\n\t[0] = {\n\t\t.rx_initiator = BCOM_INITIATOR_PSC1_RX,\n\t\t.rx_ipr = BCOM_IPR_PSC1_RX,\n\t\t.tx_initiator = BCOM_INITIATOR_PSC1_TX,\n\t\t.tx_ipr = BCOM_IPR_PSC1_TX,\n\t},\n\t[1] = {\n\t\t.rx_initiator = BCOM_INITIATOR_PSC2_RX,\n\t\t.rx_ipr = BCOM_IPR_PSC2_RX,\n\t\t.tx_initiator = BCOM_INITIATOR_PSC2_TX,\n\t\t.tx_ipr = BCOM_IPR_PSC2_TX,\n\t},\n\t[2] = {\n\t\t.rx_initiator = BCOM_INITIATOR_PSC3_RX,\n\t\t.rx_ipr = BCOM_IPR_PSC3_RX,\n\t\t.tx_initiator = BCOM_INITIATOR_PSC3_TX,\n\t\t.tx_ipr = BCOM_IPR_PSC3_TX,\n\t},\n\t[3] = {\n\t\t.rx_initiator = BCOM_INITIATOR_PSC4_RX,\n\t\t.rx_ipr = BCOM_IPR_PSC4_RX,\n\t\t.tx_initiator = BCOM_INITIATOR_PSC4_TX,\n\t\t.tx_ipr = BCOM_IPR_PSC4_TX,\n\t},\n\t[4] = {\n\t\t.rx_initiator = BCOM_INITIATOR_PSC5_RX,\n\t\t.rx_ipr = BCOM_IPR_PSC5_RX,\n\t\t.tx_initiator = BCOM_INITIATOR_PSC5_TX,\n\t\t.tx_ipr = BCOM_IPR_PSC5_TX,\n\t},\n\t[5] = {\n\t\t.rx_initiator = BCOM_INITIATOR_PSC6_RX,\n\t\t.rx_ipr = BCOM_IPR_PSC6_RX,\n\t\t.tx_initiator = BCOM_INITIATOR_PSC6_TX,\n\t\t.tx_ipr = BCOM_IPR_PSC6_TX,\n\t},\n};\n\n \nstruct bcom_task * bcom_psc_gen_bd_rx_init(unsigned psc_num, int queue_len,\n\t\t\t\t\t   phys_addr_t fifo, int maxbufsize)\n{\n\tif (psc_num >= MPC52xx_PSC_MAXNUM)\n\t\treturn NULL;\n\n\treturn bcom_gen_bd_rx_init(queue_len, fifo,\n\t\t\t\t   bcom_psc_params[psc_num].rx_initiator,\n\t\t\t\t   bcom_psc_params[psc_num].rx_ipr,\n\t\t\t\t   maxbufsize);\n}\nEXPORT_SYMBOL_GPL(bcom_psc_gen_bd_rx_init);\n\n \nstruct bcom_task *\nbcom_psc_gen_bd_tx_init(unsigned psc_num, int queue_len, phys_addr_t fifo)\n{\n\tstruct psc;\n\treturn bcom_gen_bd_tx_init(queue_len, fifo,\n\t\t\t\t   bcom_psc_params[psc_num].tx_initiator,\n\t\t\t\t   bcom_psc_params[psc_num].tx_ipr);\n}\nEXPORT_SYMBOL_GPL(bcom_psc_gen_bd_tx_init);\n\n\nMODULE_DESCRIPTION(\"BestComm General Buffer Descriptor tasks driver\");\nMODULE_AUTHOR(\"Jeff Gibbons <jeff.gibbons@appspec.com>\");\nMODULE_LICENSE(\"GPL v2\");\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}