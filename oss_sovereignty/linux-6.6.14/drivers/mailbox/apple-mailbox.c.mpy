{
  "module_name": "apple-mailbox.c",
  "hash_id": "09dd6b77b221583befc09aab7fd58da644040782c7a08d0fc77ad03769bca08a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mailbox/apple-mailbox.c",
  "human_readable_source": "\n \n\n#include <linux/apple-mailbox.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/gfp.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/mailbox_controller.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/spinlock.h>\n#include <linux/types.h>\n\n#define APPLE_ASC_MBOX_CONTROL_FULL  BIT(16)\n#define APPLE_ASC_MBOX_CONTROL_EMPTY BIT(17)\n\n#define APPLE_ASC_MBOX_A2I_CONTROL 0x110\n#define APPLE_ASC_MBOX_A2I_SEND0   0x800\n#define APPLE_ASC_MBOX_A2I_SEND1   0x808\n#define APPLE_ASC_MBOX_A2I_RECV0   0x810\n#define APPLE_ASC_MBOX_A2I_RECV1   0x818\n\n#define APPLE_ASC_MBOX_I2A_CONTROL 0x114\n#define APPLE_ASC_MBOX_I2A_SEND0   0x820\n#define APPLE_ASC_MBOX_I2A_SEND1   0x828\n#define APPLE_ASC_MBOX_I2A_RECV0   0x830\n#define APPLE_ASC_MBOX_I2A_RECV1   0x838\n\n#define APPLE_M3_MBOX_CONTROL_FULL  BIT(16)\n#define APPLE_M3_MBOX_CONTROL_EMPTY BIT(17)\n\n#define APPLE_M3_MBOX_A2I_CONTROL 0x50\n#define APPLE_M3_MBOX_A2I_SEND0\t  0x60\n#define APPLE_M3_MBOX_A2I_SEND1\t  0x68\n#define APPLE_M3_MBOX_A2I_RECV0\t  0x70\n#define APPLE_M3_MBOX_A2I_RECV1\t  0x78\n\n#define APPLE_M3_MBOX_I2A_CONTROL 0x80\n#define APPLE_M3_MBOX_I2A_SEND0\t  0x90\n#define APPLE_M3_MBOX_I2A_SEND1\t  0x98\n#define APPLE_M3_MBOX_I2A_RECV0\t  0xa0\n#define APPLE_M3_MBOX_I2A_RECV1\t  0xa8\n\n#define APPLE_M3_MBOX_IRQ_ENABLE\t0x48\n#define APPLE_M3_MBOX_IRQ_ACK\t\t0x4c\n#define APPLE_M3_MBOX_IRQ_A2I_EMPTY\tBIT(0)\n#define APPLE_M3_MBOX_IRQ_A2I_NOT_EMPTY BIT(1)\n#define APPLE_M3_MBOX_IRQ_I2A_EMPTY\tBIT(2)\n#define APPLE_M3_MBOX_IRQ_I2A_NOT_EMPTY BIT(3)\n\n#define APPLE_MBOX_MSG1_OUTCNT GENMASK(56, 52)\n#define APPLE_MBOX_MSG1_INCNT  GENMASK(51, 48)\n#define APPLE_MBOX_MSG1_OUTPTR GENMASK(47, 44)\n#define APPLE_MBOX_MSG1_INPTR  GENMASK(43, 40)\n#define APPLE_MBOX_MSG1_MSG    GENMASK(31, 0)\n\nstruct apple_mbox_hw {\n\tunsigned int control_full;\n\tunsigned int control_empty;\n\n\tunsigned int a2i_control;\n\tunsigned int a2i_send0;\n\tunsigned int a2i_send1;\n\n\tunsigned int i2a_control;\n\tunsigned int i2a_recv0;\n\tunsigned int i2a_recv1;\n\n\tbool has_irq_controls;\n\tunsigned int irq_enable;\n\tunsigned int irq_ack;\n\tunsigned int irq_bit_recv_not_empty;\n\tunsigned int irq_bit_send_empty;\n};\n\nstruct apple_mbox {\n\tvoid __iomem *regs;\n\tconst struct apple_mbox_hw *hw;\n\n\tint irq_recv_not_empty;\n\tint irq_send_empty;\n\n\tstruct mbox_chan chan;\n\n\tstruct device *dev;\n\tstruct mbox_controller controller;\n\tspinlock_t rx_lock;\n};\n\nstatic const struct of_device_id apple_mbox_of_match[];\n\nstatic bool apple_mbox_hw_can_send(struct apple_mbox *apple_mbox)\n{\n\tu32 mbox_ctrl =\n\t\treadl_relaxed(apple_mbox->regs + apple_mbox->hw->a2i_control);\n\n\treturn !(mbox_ctrl & apple_mbox->hw->control_full);\n}\n\nstatic bool apple_mbox_hw_send_empty(struct apple_mbox *apple_mbox)\n{\n\tu32 mbox_ctrl =\n\t\treadl_relaxed(apple_mbox->regs + apple_mbox->hw->a2i_control);\n\n\treturn mbox_ctrl & apple_mbox->hw->control_empty;\n}\n\nstatic int apple_mbox_hw_send(struct apple_mbox *apple_mbox,\n\t\t\t      struct apple_mbox_msg *msg)\n{\n\tif (!apple_mbox_hw_can_send(apple_mbox))\n\t\treturn -EBUSY;\n\n\tdev_dbg(apple_mbox->dev, \"> TX %016llx %08x\\n\", msg->msg0, msg->msg1);\n\n\twriteq_relaxed(msg->msg0, apple_mbox->regs + apple_mbox->hw->a2i_send0);\n\twriteq_relaxed(FIELD_PREP(APPLE_MBOX_MSG1_MSG, msg->msg1),\n\t\t       apple_mbox->regs + apple_mbox->hw->a2i_send1);\n\n\treturn 0;\n}\n\nstatic bool apple_mbox_hw_can_recv(struct apple_mbox *apple_mbox)\n{\n\tu32 mbox_ctrl =\n\t\treadl_relaxed(apple_mbox->regs + apple_mbox->hw->i2a_control);\n\n\treturn !(mbox_ctrl & apple_mbox->hw->control_empty);\n}\n\nstatic int apple_mbox_hw_recv(struct apple_mbox *apple_mbox,\n\t\t\t      struct apple_mbox_msg *msg)\n{\n\tif (!apple_mbox_hw_can_recv(apple_mbox))\n\t\treturn -ENOMSG;\n\n\tmsg->msg0 = readq_relaxed(apple_mbox->regs + apple_mbox->hw->i2a_recv0);\n\tmsg->msg1 = FIELD_GET(\n\t\tAPPLE_MBOX_MSG1_MSG,\n\t\treadq_relaxed(apple_mbox->regs + apple_mbox->hw->i2a_recv1));\n\n\tdev_dbg(apple_mbox->dev, \"< RX %016llx %08x\\n\", msg->msg0, msg->msg1);\n\n\treturn 0;\n}\n\nstatic int apple_mbox_chan_send_data(struct mbox_chan *chan, void *data)\n{\n\tstruct apple_mbox *apple_mbox = chan->con_priv;\n\tstruct apple_mbox_msg *msg = data;\n\tint ret;\n\n\tret = apple_mbox_hw_send(apple_mbox, msg);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (apple_mbox->hw->has_irq_controls) {\n\t\twritel_relaxed(apple_mbox->hw->irq_bit_send_empty,\n\t\t\t       apple_mbox->regs + apple_mbox->hw->irq_ack);\n\t}\n\tenable_irq(apple_mbox->irq_send_empty);\n\n\treturn 0;\n}\n\nstatic irqreturn_t apple_mbox_send_empty_irq(int irq, void *data)\n{\n\tstruct apple_mbox *apple_mbox = data;\n\n\t \n\tdisable_irq_nosync(apple_mbox->irq_send_empty);\n\tmbox_chan_txdone(&apple_mbox->chan, 0);\n\treturn IRQ_HANDLED;\n}\n\nstatic int apple_mbox_poll(struct apple_mbox *apple_mbox)\n{\n\tstruct apple_mbox_msg msg;\n\tint ret = 0;\n\n\twhile (apple_mbox_hw_recv(apple_mbox, &msg) == 0) {\n\t\tmbox_chan_received_data(&apple_mbox->chan, (void *)&msg);\n\t\tret++;\n\t}\n\n\t \n\tif (apple_mbox->hw->has_irq_controls) {\n\t\twritel_relaxed(apple_mbox->hw->irq_bit_recv_not_empty,\n\t\t\t       apple_mbox->regs + apple_mbox->hw->irq_ack);\n\t}\n\n\treturn ret;\n}\n\nstatic irqreturn_t apple_mbox_recv_irq(int irq, void *data)\n{\n\tstruct apple_mbox *apple_mbox = data;\n\n\tspin_lock(&apple_mbox->rx_lock);\n\tapple_mbox_poll(apple_mbox);\n\tspin_unlock(&apple_mbox->rx_lock);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic bool apple_mbox_chan_peek_data(struct mbox_chan *chan)\n{\n\tstruct apple_mbox *apple_mbox = chan->con_priv;\n\tunsigned long flags;\n\tint ret;\n\n\tspin_lock_irqsave(&apple_mbox->rx_lock, flags);\n\tret = apple_mbox_poll(apple_mbox);\n\tspin_unlock_irqrestore(&apple_mbox->rx_lock, flags);\n\n\treturn ret > 0;\n}\n\nstatic int apple_mbox_chan_flush(struct mbox_chan *chan, unsigned long timeout)\n{\n\tstruct apple_mbox *apple_mbox = chan->con_priv;\n\tunsigned long deadline = jiffies + msecs_to_jiffies(timeout);\n\n\twhile (time_before(jiffies, deadline)) {\n\t\tif (apple_mbox_hw_send_empty(apple_mbox)) {\n\t\t\tmbox_chan_txdone(&apple_mbox->chan, 0);\n\t\t\treturn 0;\n\t\t}\n\n\t\tudelay(1);\n\t}\n\n\treturn -ETIME;\n}\n\nstatic int apple_mbox_chan_startup(struct mbox_chan *chan)\n{\n\tstruct apple_mbox *apple_mbox = chan->con_priv;\n\n\t \n\tif (apple_mbox->hw->has_irq_controls) {\n\t\twritel_relaxed(apple_mbox->hw->irq_bit_recv_not_empty |\n\t\t\t\t       apple_mbox->hw->irq_bit_send_empty,\n\t\t\t       apple_mbox->regs + apple_mbox->hw->irq_enable);\n\t}\n\n\tenable_irq(apple_mbox->irq_recv_not_empty);\n\treturn 0;\n}\n\nstatic void apple_mbox_chan_shutdown(struct mbox_chan *chan)\n{\n\tstruct apple_mbox *apple_mbox = chan->con_priv;\n\n\tdisable_irq(apple_mbox->irq_recv_not_empty);\n}\n\nstatic const struct mbox_chan_ops apple_mbox_ops = {\n\t.send_data = apple_mbox_chan_send_data,\n\t.peek_data = apple_mbox_chan_peek_data,\n\t.flush = apple_mbox_chan_flush,\n\t.startup = apple_mbox_chan_startup,\n\t.shutdown = apple_mbox_chan_shutdown,\n};\n\nstatic struct mbox_chan *apple_mbox_of_xlate(struct mbox_controller *mbox,\n\t\t\t\t\t     const struct of_phandle_args *args)\n{\n\tif (args->args_count != 0)\n\t\treturn ERR_PTR(-EINVAL);\n\n\treturn &mbox->chans[0];\n}\n\nstatic int apple_mbox_probe(struct platform_device *pdev)\n{\n\tint ret;\n\tconst struct of_device_id *match;\n\tchar *irqname;\n\tstruct apple_mbox *mbox;\n\tstruct device *dev = &pdev->dev;\n\n\tmatch = of_match_node(apple_mbox_of_match, pdev->dev.of_node);\n\tif (!match)\n\t\treturn -EINVAL;\n\tif (!match->data)\n\t\treturn -EINVAL;\n\n\tmbox = devm_kzalloc(dev, sizeof(*mbox), GFP_KERNEL);\n\tif (!mbox)\n\t\treturn -ENOMEM;\n\tplatform_set_drvdata(pdev, mbox);\n\n\tmbox->dev = dev;\n\tmbox->regs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(mbox->regs))\n\t\treturn PTR_ERR(mbox->regs);\n\n\tmbox->hw = match->data;\n\tmbox->irq_recv_not_empty =\n\t\tplatform_get_irq_byname(pdev, \"recv-not-empty\");\n\tif (mbox->irq_recv_not_empty < 0)\n\t\treturn -ENODEV;\n\n\tmbox->irq_send_empty = platform_get_irq_byname(pdev, \"send-empty\");\n\tif (mbox->irq_send_empty < 0)\n\t\treturn -ENODEV;\n\n\tmbox->controller.dev = mbox->dev;\n\tmbox->controller.num_chans = 1;\n\tmbox->controller.chans = &mbox->chan;\n\tmbox->controller.ops = &apple_mbox_ops;\n\tmbox->controller.txdone_irq = true;\n\tmbox->controller.of_xlate = apple_mbox_of_xlate;\n\tmbox->chan.con_priv = mbox;\n\tspin_lock_init(&mbox->rx_lock);\n\n\tirqname = devm_kasprintf(dev, GFP_KERNEL, \"%s-recv\", dev_name(dev));\n\tif (!irqname)\n\t\treturn -ENOMEM;\n\n\tret = devm_request_threaded_irq(dev, mbox->irq_recv_not_empty, NULL,\n\t\t\t\t\tapple_mbox_recv_irq,\n\t\t\t\t\tIRQF_NO_AUTOEN | IRQF_ONESHOT, irqname,\n\t\t\t\t\tmbox);\n\tif (ret)\n\t\treturn ret;\n\n\tirqname = devm_kasprintf(dev, GFP_KERNEL, \"%s-send\", dev_name(dev));\n\tif (!irqname)\n\t\treturn -ENOMEM;\n\n\tret = devm_request_irq(dev, mbox->irq_send_empty,\n\t\t\t       apple_mbox_send_empty_irq, IRQF_NO_AUTOEN,\n\t\t\t       irqname, mbox);\n\tif (ret)\n\t\treturn ret;\n\n\treturn devm_mbox_controller_register(dev, &mbox->controller);\n}\n\nstatic const struct apple_mbox_hw apple_mbox_asc_hw = {\n\t.control_full = APPLE_ASC_MBOX_CONTROL_FULL,\n\t.control_empty = APPLE_ASC_MBOX_CONTROL_EMPTY,\n\n\t.a2i_control = APPLE_ASC_MBOX_A2I_CONTROL,\n\t.a2i_send0 = APPLE_ASC_MBOX_A2I_SEND0,\n\t.a2i_send1 = APPLE_ASC_MBOX_A2I_SEND1,\n\n\t.i2a_control = APPLE_ASC_MBOX_I2A_CONTROL,\n\t.i2a_recv0 = APPLE_ASC_MBOX_I2A_RECV0,\n\t.i2a_recv1 = APPLE_ASC_MBOX_I2A_RECV1,\n\n\t.has_irq_controls = false,\n};\n\nstatic const struct apple_mbox_hw apple_mbox_m3_hw = {\n\t.control_full = APPLE_M3_MBOX_CONTROL_FULL,\n\t.control_empty = APPLE_M3_MBOX_CONTROL_EMPTY,\n\n\t.a2i_control = APPLE_M3_MBOX_A2I_CONTROL,\n\t.a2i_send0 = APPLE_M3_MBOX_A2I_SEND0,\n\t.a2i_send1 = APPLE_M3_MBOX_A2I_SEND1,\n\n\t.i2a_control = APPLE_M3_MBOX_I2A_CONTROL,\n\t.i2a_recv0 = APPLE_M3_MBOX_I2A_RECV0,\n\t.i2a_recv1 = APPLE_M3_MBOX_I2A_RECV1,\n\n\t.has_irq_controls = true,\n\t.irq_enable = APPLE_M3_MBOX_IRQ_ENABLE,\n\t.irq_ack = APPLE_M3_MBOX_IRQ_ACK,\n\t.irq_bit_recv_not_empty = APPLE_M3_MBOX_IRQ_I2A_NOT_EMPTY,\n\t.irq_bit_send_empty = APPLE_M3_MBOX_IRQ_A2I_EMPTY,\n};\n\nstatic const struct of_device_id apple_mbox_of_match[] = {\n\t{ .compatible = \"apple,asc-mailbox-v4\", .data = &apple_mbox_asc_hw },\n\t{ .compatible = \"apple,m3-mailbox-v2\", .data = &apple_mbox_m3_hw },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, apple_mbox_of_match);\n\nstatic struct platform_driver apple_mbox_driver = {\n\t.driver = {\n\t\t.name = \"apple-mailbox\",\n\t\t.of_match_table = apple_mbox_of_match,\n\t},\n\t.probe = apple_mbox_probe,\n};\nmodule_platform_driver(apple_mbox_driver);\n\nMODULE_LICENSE(\"Dual MIT/GPL\");\nMODULE_AUTHOR(\"Sven Peter <sven@svenpeter.dev>\");\nMODULE_DESCRIPTION(\"Apple Mailbox driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}