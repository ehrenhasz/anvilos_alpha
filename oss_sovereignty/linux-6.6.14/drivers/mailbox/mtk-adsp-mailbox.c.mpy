{
  "module_name": "mtk-adsp-mailbox.c",
  "hash_id": "6aa7a17767e79cf73eb94f74c2eac1477310018dc116fe983d72b27656208a64",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mailbox/mtk-adsp-mailbox.c",
  "human_readable_source": "\n \n\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/iopoll.h>\n#include <linux/kernel.h>\n#include <linux/mailbox_controller.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\nstruct mtk_adsp_mbox_priv {\n\tstruct device *dev;\n\tstruct mbox_controller mbox;\n\tvoid __iomem *va_mboxreg;\n\tconst struct mtk_adsp_mbox_cfg *cfg;\n};\n\nstruct mtk_adsp_mbox_cfg {\n\tu32 set_in;\n\tu32 set_out;\n\tu32 clr_in;\n\tu32 clr_out;\n};\n\nstatic inline struct mtk_adsp_mbox_priv *get_mtk_adsp_mbox_priv(struct mbox_controller *mbox)\n{\n\treturn container_of(mbox, struct mtk_adsp_mbox_priv, mbox);\n}\n\nstatic irqreturn_t mtk_adsp_mbox_irq(int irq, void *data)\n{\n\tstruct mbox_chan *chan = data;\n\tstruct mtk_adsp_mbox_priv *priv = get_mtk_adsp_mbox_priv(chan->mbox);\n\tu32 op = readl(priv->va_mboxreg + priv->cfg->set_out);\n\n\twritel(op, priv->va_mboxreg + priv->cfg->clr_out);\n\n\treturn IRQ_WAKE_THREAD;\n}\n\nstatic irqreturn_t mtk_adsp_mbox_isr(int irq, void *data)\n{\n\tstruct mbox_chan *chan = data;\n\n\tmbox_chan_received_data(chan, NULL);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic struct mbox_chan *mtk_adsp_mbox_xlate(struct mbox_controller *mbox,\n\t\t\t\t\t     const struct of_phandle_args *sp)\n{\n\treturn mbox->chans;\n}\n\nstatic int mtk_adsp_mbox_startup(struct mbox_chan *chan)\n{\n\tstruct mtk_adsp_mbox_priv *priv = get_mtk_adsp_mbox_priv(chan->mbox);\n\n\t \n\twritel(0xFFFFFFFF, priv->va_mboxreg + priv->cfg->clr_in);\n\twritel(0xFFFFFFFF, priv->va_mboxreg + priv->cfg->clr_out);\n\n\treturn 0;\n}\n\nstatic void mtk_adsp_mbox_shutdown(struct mbox_chan *chan)\n{\n\tstruct mtk_adsp_mbox_priv *priv = get_mtk_adsp_mbox_priv(chan->mbox);\n\n\t \n\twritel(0xFFFFFFFF, priv->va_mboxreg + priv->cfg->clr_in);\n\twritel(0xFFFFFFFF, priv->va_mboxreg + priv->cfg->clr_out);\n}\n\nstatic int mtk_adsp_mbox_send_data(struct mbox_chan *chan, void *data)\n{\n\tstruct mtk_adsp_mbox_priv *priv = get_mtk_adsp_mbox_priv(chan->mbox);\n\tu32 *msg = data;\n\n\twritel(*msg, priv->va_mboxreg + priv->cfg->set_in);\n\n\treturn 0;\n}\n\nstatic bool mtk_adsp_mbox_last_tx_done(struct mbox_chan *chan)\n{\n\tstruct mtk_adsp_mbox_priv *priv = get_mtk_adsp_mbox_priv(chan->mbox);\n\n\treturn readl(priv->va_mboxreg + priv->cfg->set_in) == 0;\n}\n\nstatic const struct mbox_chan_ops mtk_adsp_mbox_chan_ops = {\n\t.send_data\t= mtk_adsp_mbox_send_data,\n\t.startup\t= mtk_adsp_mbox_startup,\n\t.shutdown\t= mtk_adsp_mbox_shutdown,\n\t.last_tx_done\t= mtk_adsp_mbox_last_tx_done,\n};\n\nstatic int mtk_adsp_mbox_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct mtk_adsp_mbox_priv *priv;\n\tconst struct mtk_adsp_mbox_cfg *cfg;\n\tstruct mbox_controller *mbox;\n\tint ret, irq;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tmbox = &priv->mbox;\n\tmbox->dev = dev;\n\tmbox->ops = &mtk_adsp_mbox_chan_ops;\n\tmbox->txdone_irq = false;\n\tmbox->txdone_poll = true;\n\tmbox->of_xlate = mtk_adsp_mbox_xlate;\n\tmbox->num_chans = 1;\n\tmbox->chans = devm_kzalloc(dev, sizeof(*mbox->chans), GFP_KERNEL);\n\tif (!mbox->chans)\n\t\treturn -ENOMEM;\n\n\tpriv->va_mboxreg = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(priv->va_mboxreg))\n\t\treturn PTR_ERR(priv->va_mboxreg);\n\n\tcfg = of_device_get_match_data(dev);\n\tif (!cfg)\n\t\treturn -EINVAL;\n\tpriv->cfg = cfg;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\tret = devm_request_threaded_irq(dev, irq, mtk_adsp_mbox_irq,\n\t\t\t\t\tmtk_adsp_mbox_isr, IRQF_TRIGGER_NONE,\n\t\t\t\t\tdev_name(dev), mbox->chans);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tplatform_set_drvdata(pdev, priv);\n\n\treturn devm_mbox_controller_register(dev, &priv->mbox);\n}\n\nstatic const struct mtk_adsp_mbox_cfg mt8186_adsp_mbox_cfg = {\n\t.set_in\t\t= 0x00,\n\t.set_out\t= 0x04,\n\t.clr_in\t\t= 0x08,\n\t.clr_out\t= 0x0C,\n};\n\nstatic const struct mtk_adsp_mbox_cfg mt8195_adsp_mbox_cfg = {\n\t.set_in\t\t= 0x00,\n\t.set_out\t= 0x1c,\n\t.clr_in\t\t= 0x04,\n\t.clr_out\t= 0x20,\n};\n\nstatic const struct of_device_id mtk_adsp_mbox_of_match[] = {\n\t{ .compatible = \"mediatek,mt8186-adsp-mbox\", .data = &mt8186_adsp_mbox_cfg },\n\t{ .compatible = \"mediatek,mt8195-adsp-mbox\", .data = &mt8195_adsp_mbox_cfg },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, mtk_adsp_mbox_of_match);\n\nstatic struct platform_driver mtk_adsp_mbox_driver = {\n\t.probe\t\t= mtk_adsp_mbox_probe,\n\t.driver = {\n\t\t.name\t= \"mtk_adsp_mbox\",\n\t\t.of_match_table = mtk_adsp_mbox_of_match,\n\t},\n};\nmodule_platform_driver(mtk_adsp_mbox_driver);\n\nMODULE_AUTHOR(\"Allen-KH Cheng <Allen-KH.Cheng@mediatek.com>\");\nMODULE_DESCRIPTION(\"MTK ADSP Mailbox Controller\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}