{
  "module_name": "mailbox-xgene-slimpro.c",
  "hash_id": "c3ec4c0e7446c348c574139d6206c8e015a41e44e291ef35dc6f4544601cbea7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mailbox/mailbox-xgene-slimpro.c",
  "human_readable_source": "\n \n#include <linux/acpi.h>\n#include <linux/delay.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/mailbox_controller.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/spinlock.h>\n\n#define MBOX_CON_NAME\t\t\t\"slimpro-mbox\"\n#define MBOX_REG_SET_OFFSET\t\t0x1000\n#define MBOX_CNT\t\t\t8\n#define MBOX_STATUS_AVAIL_MASK\t\tBIT(16)\n#define MBOX_STATUS_ACK_MASK\t\tBIT(0)\n\n \n#define REG_DB_IN\t\t0x00\n#define REG_DB_DIN0\t\t0x04\n#define REG_DB_DIN1\t\t0x08\n#define REG_DB_OUT\t\t0x10\n#define REG_DB_DOUT0\t\t0x14\n#define REG_DB_DOUT1\t\t0x18\n#define REG_DB_STAT\t\t0x20\n#define REG_DB_STATMASK\t\t0x24\n\n \nstruct slimpro_mbox_chan {\n\tstruct device\t\t*dev;\n\tstruct mbox_chan\t*chan;\n\tvoid __iomem\t\t*reg;\n\tint\t\t\tirq;\n\tu32\t\t\trx_msg[3];\n};\n\n \nstruct slimpro_mbox {\n\tstruct mbox_controller\t\tmb_ctrl;\n\tstruct slimpro_mbox_chan\tmc[MBOX_CNT];\n\tstruct mbox_chan\t\tchans[MBOX_CNT];\n};\n\nstatic void mb_chan_send_msg(struct slimpro_mbox_chan *mb_chan, u32 *msg)\n{\n\twritel(msg[1], mb_chan->reg + REG_DB_DOUT0);\n\twritel(msg[2], mb_chan->reg + REG_DB_DOUT1);\n\twritel(msg[0], mb_chan->reg + REG_DB_OUT);\n}\n\nstatic void mb_chan_recv_msg(struct slimpro_mbox_chan *mb_chan)\n{\n\tmb_chan->rx_msg[1] = readl(mb_chan->reg + REG_DB_DIN0);\n\tmb_chan->rx_msg[2] = readl(mb_chan->reg + REG_DB_DIN1);\n\tmb_chan->rx_msg[0] = readl(mb_chan->reg + REG_DB_IN);\n}\n\nstatic int mb_chan_status_ack(struct slimpro_mbox_chan *mb_chan)\n{\n\tu32 val = readl(mb_chan->reg + REG_DB_STAT);\n\n\tif (val & MBOX_STATUS_ACK_MASK) {\n\t\twritel(MBOX_STATUS_ACK_MASK, mb_chan->reg + REG_DB_STAT);\n\t\treturn 1;\n\t}\n\treturn 0;\n}\n\nstatic int mb_chan_status_avail(struct slimpro_mbox_chan *mb_chan)\n{\n\tu32 val = readl(mb_chan->reg + REG_DB_STAT);\n\n\tif (val & MBOX_STATUS_AVAIL_MASK) {\n\t\tmb_chan_recv_msg(mb_chan);\n\t\twritel(MBOX_STATUS_AVAIL_MASK, mb_chan->reg + REG_DB_STAT);\n\t\treturn 1;\n\t}\n\treturn 0;\n}\n\nstatic irqreturn_t slimpro_mbox_irq(int irq, void *id)\n{\n\tstruct slimpro_mbox_chan *mb_chan = id;\n\n\tif (mb_chan_status_ack(mb_chan))\n\t\tmbox_chan_txdone(mb_chan->chan, 0);\n\n\tif (mb_chan_status_avail(mb_chan))\n\t\tmbox_chan_received_data(mb_chan->chan, mb_chan->rx_msg);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int slimpro_mbox_send_data(struct mbox_chan *chan, void *msg)\n{\n\tstruct slimpro_mbox_chan *mb_chan = chan->con_priv;\n\n\tmb_chan_send_msg(mb_chan, msg);\n\treturn 0;\n}\n\nstatic int slimpro_mbox_startup(struct mbox_chan *chan)\n{\n\tstruct slimpro_mbox_chan *mb_chan = chan->con_priv;\n\tint rc;\n\tu32 val;\n\n\trc = devm_request_irq(mb_chan->dev, mb_chan->irq, slimpro_mbox_irq, 0,\n\t\t\t      MBOX_CON_NAME, mb_chan);\n\tif (unlikely(rc)) {\n\t\tdev_err(mb_chan->dev, \"failed to register mailbox interrupt %d\\n\",\n\t\t\tmb_chan->irq);\n\t\treturn rc;\n\t}\n\n\t \n\twritel(MBOX_STATUS_ACK_MASK | MBOX_STATUS_AVAIL_MASK,\n\t       mb_chan->reg + REG_DB_STAT);\n\t \n\tval = readl(mb_chan->reg + REG_DB_STATMASK);\n\tval &= ~(MBOX_STATUS_ACK_MASK | MBOX_STATUS_AVAIL_MASK);\n\twritel(val, mb_chan->reg + REG_DB_STATMASK);\n\n\treturn 0;\n}\n\nstatic void slimpro_mbox_shutdown(struct mbox_chan *chan)\n{\n\tstruct slimpro_mbox_chan *mb_chan = chan->con_priv;\n\tu32 val;\n\n\t \n\tval = readl(mb_chan->reg + REG_DB_STATMASK);\n\tval |= (MBOX_STATUS_ACK_MASK | MBOX_STATUS_AVAIL_MASK);\n\twritel(val, mb_chan->reg + REG_DB_STATMASK);\n\n\tdevm_free_irq(mb_chan->dev, mb_chan->irq, mb_chan);\n}\n\nstatic const struct mbox_chan_ops slimpro_mbox_ops = {\n\t.send_data = slimpro_mbox_send_data,\n\t.startup = slimpro_mbox_startup,\n\t.shutdown = slimpro_mbox_shutdown,\n};\n\nstatic int slimpro_mbox_probe(struct platform_device *pdev)\n{\n\tstruct slimpro_mbox *ctx;\n\tvoid __iomem *mb_base;\n\tint rc;\n\tint i;\n\n\tctx = devm_kzalloc(&pdev->dev, sizeof(struct slimpro_mbox), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, ctx);\n\n\tmb_base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(mb_base))\n\t\treturn PTR_ERR(mb_base);\n\n\t \n\tfor (i = 0; i < MBOX_CNT; i++) {\n\t\tctx->mc[i].irq = platform_get_irq(pdev, i);\n\t\tif (ctx->mc[i].irq < 0) {\n\t\t\tif (i == 0) {\n\t\t\t\tdev_err(&pdev->dev, \"no available IRQ\\n\");\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tdev_info(&pdev->dev, \"no IRQ for channel %d\\n\", i);\n\t\t\tbreak;\n\t\t}\n\n\t\tctx->mc[i].dev = &pdev->dev;\n\t\tctx->mc[i].reg = mb_base + i * MBOX_REG_SET_OFFSET;\n\t\tctx->mc[i].chan = &ctx->chans[i];\n\t\tctx->chans[i].con_priv = &ctx->mc[i];\n\t}\n\n\t \n\tctx->mb_ctrl.dev = &pdev->dev;\n\tctx->mb_ctrl.chans = ctx->chans;\n\tctx->mb_ctrl.txdone_irq = true;\n\tctx->mb_ctrl.ops = &slimpro_mbox_ops;\n\tctx->mb_ctrl.num_chans = i;\n\n\trc = devm_mbox_controller_register(&pdev->dev, &ctx->mb_ctrl);\n\tif (rc) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"APM X-Gene SLIMpro MailBox register failed:%d\\n\", rc);\n\t\treturn rc;\n\t}\n\n\tdev_info(&pdev->dev, \"APM X-Gene SLIMpro MailBox registered\\n\");\n\treturn 0;\n}\n\nstatic const struct of_device_id slimpro_of_match[] = {\n\t{.compatible = \"apm,xgene-slimpro-mbox\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, slimpro_of_match);\n\n#ifdef CONFIG_ACPI\nstatic const struct acpi_device_id slimpro_acpi_ids[] = {\n\t{\"APMC0D01\", 0},\n\t{}\n};\nMODULE_DEVICE_TABLE(acpi, slimpro_acpi_ids);\n#endif\n\nstatic struct platform_driver slimpro_mbox_driver = {\n\t.probe\t= slimpro_mbox_probe,\n\t.driver\t= {\n\t\t.name = \"xgene-slimpro-mbox\",\n\t\t.of_match_table = of_match_ptr(slimpro_of_match),\n\t\t.acpi_match_table = ACPI_PTR(slimpro_acpi_ids)\n\t},\n};\n\nstatic int __init slimpro_mbox_init(void)\n{\n\treturn platform_driver_register(&slimpro_mbox_driver);\n}\n\nstatic void __exit slimpro_mbox_exit(void)\n{\n\tplatform_driver_unregister(&slimpro_mbox_driver);\n}\n\nsubsys_initcall(slimpro_mbox_init);\nmodule_exit(slimpro_mbox_exit);\n\nMODULE_DESCRIPTION(\"APM X-Gene SLIMpro Mailbox Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}