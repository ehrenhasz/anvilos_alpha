{
  "module_name": "qcom-apcs-ipc-mailbox.c",
  "hash_id": "2e325886d9309b4830b71a4336525ec76e7012127be5ed9902731bfa5c25b18a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mailbox/qcom-apcs-ipc-mailbox.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/io.h>\n#include <linux/slab.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/mailbox_controller.h>\n\n#define QCOM_APCS_IPC_BITS\t32\n\nstruct qcom_apcs_ipc {\n\tstruct mbox_controller mbox;\n\tstruct mbox_chan mbox_chans[QCOM_APCS_IPC_BITS];\n\n\tstruct regmap *regmap;\n\tunsigned long offset;\n\tstruct platform_device *clk;\n};\n\nstruct qcom_apcs_ipc_data {\n\tint offset;\n\tchar *clk_name;\n};\n\nstatic const struct qcom_apcs_ipc_data ipq6018_apcs_data = {\n\t.offset = 8, .clk_name = \"qcom,apss-ipq6018-clk\"\n};\n\nstatic const struct qcom_apcs_ipc_data msm8916_apcs_data = {\n\t.offset = 8, .clk_name = \"qcom-apcs-msm8916-clk\"\n};\n\nstatic const struct qcom_apcs_ipc_data msm8994_apcs_data = {\n\t.offset = 8, .clk_name = NULL\n};\n\nstatic const struct qcom_apcs_ipc_data msm8996_apcs_data = {\n\t.offset = 16, .clk_name = \"qcom-apcs-msm8996-clk\"\n};\n\nstatic const struct qcom_apcs_ipc_data apps_shared_apcs_data = {\n\t.offset = 12, .clk_name = NULL\n};\n\nstatic const struct qcom_apcs_ipc_data sdx55_apcs_data = {\n\t.offset = 0x1008, .clk_name = \"qcom-sdx55-acps-clk\"\n};\n\nstatic const struct regmap_config apcs_regmap_config = {\n\t.reg_bits = 32,\n\t.reg_stride = 4,\n\t.val_bits = 32,\n\t.max_register = 0x1008,\n\t.fast_io = true,\n};\n\nstatic int qcom_apcs_ipc_send_data(struct mbox_chan *chan, void *data)\n{\n\tstruct qcom_apcs_ipc *apcs = container_of(chan->mbox,\n\t\t\t\t\t\t  struct qcom_apcs_ipc, mbox);\n\tunsigned long idx = (unsigned long)chan->con_priv;\n\n\treturn regmap_write(apcs->regmap, apcs->offset, BIT(idx));\n}\n\nstatic const struct mbox_chan_ops qcom_apcs_ipc_ops = {\n\t.send_data = qcom_apcs_ipc_send_data,\n};\n\nstatic int qcom_apcs_ipc_probe(struct platform_device *pdev)\n{\n\tstruct qcom_apcs_ipc *apcs;\n\tconst struct qcom_apcs_ipc_data *apcs_data;\n\tstruct regmap *regmap;\n\tvoid __iomem *base;\n\tunsigned long i;\n\tint ret;\n\n\tapcs = devm_kzalloc(&pdev->dev, sizeof(*apcs), GFP_KERNEL);\n\tif (!apcs)\n\t\treturn -ENOMEM;\n\n\tbase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(base))\n\t\treturn PTR_ERR(base);\n\n\tregmap = devm_regmap_init_mmio(&pdev->dev, base, &apcs_regmap_config);\n\tif (IS_ERR(regmap))\n\t\treturn PTR_ERR(regmap);\n\n\tapcs_data = of_device_get_match_data(&pdev->dev);\n\n\tapcs->regmap = regmap;\n\tapcs->offset = apcs_data->offset;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(apcs->mbox_chans); i++)\n\t\tapcs->mbox_chans[i].con_priv = (void *)i;\n\n\tapcs->mbox.dev = &pdev->dev;\n\tapcs->mbox.ops = &qcom_apcs_ipc_ops;\n\tapcs->mbox.chans = apcs->mbox_chans;\n\tapcs->mbox.num_chans = ARRAY_SIZE(apcs->mbox_chans);\n\n\tret = devm_mbox_controller_register(&pdev->dev, &apcs->mbox);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to register APCS IPC controller\\n\");\n\t\treturn ret;\n\t}\n\n\tif (apcs_data->clk_name) {\n\t\tapcs->clk = platform_device_register_data(&pdev->dev,\n\t\t\t\t\t\t\t  apcs_data->clk_name,\n\t\t\t\t\t\t\t  PLATFORM_DEVID_AUTO,\n\t\t\t\t\t\t\t  NULL, 0);\n\t\tif (IS_ERR(apcs->clk))\n\t\t\tdev_err(&pdev->dev, \"failed to register APCS clk\\n\");\n\t}\n\n\tplatform_set_drvdata(pdev, apcs);\n\n\treturn 0;\n}\n\nstatic int qcom_apcs_ipc_remove(struct platform_device *pdev)\n{\n\tstruct qcom_apcs_ipc *apcs = platform_get_drvdata(pdev);\n\tstruct platform_device *clk = apcs->clk;\n\n\tplatform_device_unregister(clk);\n\n\treturn 0;\n}\n\n \nstatic const struct of_device_id qcom_apcs_ipc_of_match[] = {\n\t{ .compatible = \"qcom,ipq6018-apcs-apps-global\", .data = &ipq6018_apcs_data },\n\t{ .compatible = \"qcom,msm8916-apcs-kpss-global\", .data = &msm8916_apcs_data },\n\t{ .compatible = \"qcom,msm8939-apcs-kpss-global\", .data = &msm8916_apcs_data },\n\t{ .compatible = \"qcom,msm8953-apcs-kpss-global\", .data = &msm8994_apcs_data },\n\t{ .compatible = \"qcom,msm8976-apcs-kpss-global\", .data = &msm8994_apcs_data },\n\t{ .compatible = \"qcom,msm8994-apcs-kpss-global\", .data = &msm8994_apcs_data },\n\t{ .compatible = \"qcom,msm8996-apcs-hmss-global\", .data = &msm8996_apcs_data },\n\t{ .compatible = \"qcom,msm8998-apcs-hmss-global\", .data = &msm8994_apcs_data },\n\t{ .compatible = \"qcom,qcm2290-apcs-hmss-global\", .data = &msm8994_apcs_data },\n\t{ .compatible = \"qcom,qcs404-apcs-apps-global\", .data = &msm8916_apcs_data },\n\t{ .compatible = \"qcom,sdm660-apcs-hmss-global\", .data = &msm8994_apcs_data },\n\t{ .compatible = \"qcom,sdm845-apss-shared\", .data = &apps_shared_apcs_data },\n\t{ .compatible = \"qcom,sm4250-apcs-hmss-global\", .data = &msm8994_apcs_data },\n\t{ .compatible = \"qcom,sm6125-apcs-hmss-global\", .data = &msm8994_apcs_data },\n\t{ .compatible = \"qcom,sm6115-apcs-hmss-global\", .data = &msm8994_apcs_data },\n\t{ .compatible = \"qcom,sdx55-apcs-gcc\", .data = &sdx55_apcs_data },\n\t \n\t{ .compatible = \"qcom,ipq5332-apcs-apps-global\", .data = &ipq6018_apcs_data },\n\t{ .compatible = \"qcom,ipq8074-apcs-apps-global\", .data = &ipq6018_apcs_data },\n\t{ .compatible = \"qcom,sc7180-apss-shared\", .data = &apps_shared_apcs_data },\n\t{ .compatible = \"qcom,sc8180x-apss-shared\", .data = &apps_shared_apcs_data },\n\t{ .compatible = \"qcom,sm8150-apss-shared\", .data = &apps_shared_apcs_data },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, qcom_apcs_ipc_of_match);\n\nstatic struct platform_driver qcom_apcs_ipc_driver = {\n\t.probe = qcom_apcs_ipc_probe,\n\t.remove = qcom_apcs_ipc_remove,\n\t.driver = {\n\t\t.name = \"qcom_apcs_ipc\",\n\t\t.of_match_table = qcom_apcs_ipc_of_match,\n\t},\n};\n\nstatic int __init qcom_apcs_ipc_init(void)\n{\n\treturn platform_driver_register(&qcom_apcs_ipc_driver);\n}\npostcore_initcall(qcom_apcs_ipc_init);\n\nstatic void __exit qcom_apcs_ipc_exit(void)\n{\n\tplatform_driver_unregister(&qcom_apcs_ipc_driver);\n}\nmodule_exit(qcom_apcs_ipc_exit);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Qualcomm APCS IPC driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}