{
  "module_name": "i2c-icy.c",
  "hash_id": "69b6f5313ebce7f1647dd80f152a0bbd7e894773a39a6367dc66f5c0a5bfef16",
  "original_prompt": "Ingested from linux-6.6.14/drivers/i2c/busses/i2c-icy.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/ioport.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n\n#include <linux/i2c.h>\n#include <linux/i2c-algo-pcf.h>\n\n#include <asm/amigahw.h>\n#include <asm/amigaints.h>\n#include <linux/zorro.h>\n\n#include \"../algos/i2c-algo-pcf.h\"\n\nstruct icy_i2c {\n\tstruct i2c_adapter adapter;\n\n\tvoid __iomem *reg_s0;\n\tvoid __iomem *reg_s1;\n\tstruct i2c_client *ltc2990_client;\n};\n\n \nstatic void icy_pcf_setpcf(void *data, int ctl, int val)\n{\n\tstruct icy_i2c *i2c = (struct icy_i2c *)data;\n\n\tu8 __iomem *address = ctl ? i2c->reg_s1 : i2c->reg_s0;\n\n\tz_writeb(val, address);\n}\n\nstatic int icy_pcf_getpcf(void *data, int ctl)\n{\n\tstruct icy_i2c *i2c = (struct icy_i2c *)data;\n\n\tu8 __iomem *address = ctl ? i2c->reg_s1 : i2c->reg_s0;\n\n\treturn z_readb(address);\n}\n\nstatic int icy_pcf_getown(void *data)\n{\n\treturn 0x55;\n}\n\nstatic int icy_pcf_getclock(void *data)\n{\n\treturn 0x1c;\n}\n\nstatic void icy_pcf_waitforpin(void *data)\n{\n\tusleep_range(50, 150);\n}\n\n \nstatic unsigned short const icy_ltc2990_addresses[] = {\n\t0x4c, 0x4d, 0x4e, 0x4f, I2C_CLIENT_END\n};\n\n \nstatic const u32 icy_ltc2990_meas_mode[] = {0, 3};\n\nstatic const struct property_entry icy_ltc2990_props[] = {\n\tPROPERTY_ENTRY_U32_ARRAY(\"lltc,meas-mode\", icy_ltc2990_meas_mode),\n\t{ }\n};\n\nstatic const struct software_node icy_ltc2990_node = {\n\t.properties = icy_ltc2990_props,\n};\n\nstatic int icy_probe(struct zorro_dev *z,\n\t\t     const struct zorro_device_id *ent)\n{\n\tstruct icy_i2c *i2c;\n\tstruct i2c_algo_pcf_data *algo_data;\n\tstruct i2c_board_info ltc2990_info = {\n\t\t.type\t\t= \"ltc2990\",\n\t\t.swnode\t\t= &icy_ltc2990_node,\n\t};\n\n\ti2c = devm_kzalloc(&z->dev, sizeof(*i2c), GFP_KERNEL);\n\tif (!i2c)\n\t\treturn -ENOMEM;\n\n\talgo_data = devm_kzalloc(&z->dev, sizeof(*algo_data), GFP_KERNEL);\n\tif (!algo_data)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(&z->dev, i2c);\n\ti2c->adapter.dev.parent = &z->dev;\n\ti2c->adapter.owner = THIS_MODULE;\n\t \n\ti2c->adapter.algo_data = algo_data;\n\tstrscpy(i2c->adapter.name, \"ICY I2C Zorro adapter\",\n\t\tsizeof(i2c->adapter.name));\n\n\tif (!devm_request_mem_region(&z->dev,\n\t\t\t\t     z->resource.start,\n\t\t\t\t     4, i2c->adapter.name))\n\t\treturn -ENXIO;\n\n\t \n\ti2c->reg_s0 = ZTWO_VADDR(z->resource.start);\n\ti2c->reg_s1 = ZTWO_VADDR(z->resource.start + 2);\n\n\talgo_data->data = i2c;\n\talgo_data->setpcf     = icy_pcf_setpcf;\n\talgo_data->getpcf     = icy_pcf_getpcf;\n\talgo_data->getown     = icy_pcf_getown;\n\talgo_data->getclock   = icy_pcf_getclock;\n\talgo_data->waitforpin = icy_pcf_waitforpin;\n\n\tif (i2c_pcf_add_bus(&i2c->adapter)) {\n\t\tdev_err(&z->dev, \"i2c_pcf_add_bus() failed\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\tdev_info(&z->dev, \"ICY I2C controller at %pa, IRQ not implemented\\n\",\n\t\t &z->resource.start);\n\n\t \n\ti2c->ltc2990_client = i2c_new_scanned_device(&i2c->adapter,\n\t\t\t\t\t\t     &ltc2990_info,\n\t\t\t\t\t\t     icy_ltc2990_addresses,\n\t\t\t\t\t\t     NULL);\n\treturn 0;\n}\n\nstatic void icy_remove(struct zorro_dev *z)\n{\n\tstruct icy_i2c *i2c = dev_get_drvdata(&z->dev);\n\n\ti2c_unregister_device(i2c->ltc2990_client);\n\ti2c_del_adapter(&i2c->adapter);\n}\n\nstatic const struct zorro_device_id icy_zorro_tbl[] = {\n\t{ ZORRO_ID(VMC, 15, 0), },\n\t{ 0 }\n};\n\nMODULE_DEVICE_TABLE(zorro, icy_zorro_tbl);\n\nstatic struct zorro_driver icy_driver = {\n\t.name           = \"i2c-icy\",\n\t.id_table       = icy_zorro_tbl,\n\t.probe          = icy_probe,\n\t.remove         = icy_remove,\n};\n\nmodule_driver(icy_driver,\n\t      zorro_register_driver,\n\t      zorro_unregister_driver);\n\nMODULE_AUTHOR(\"Max Staudt <max@enpas.org>\");\nMODULE_DESCRIPTION(\"I2C bus via PCF8584 on ICY Zorro card\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}