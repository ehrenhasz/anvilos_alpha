{
  "module_name": "i2c-amd756-s4882.c",
  "hash_id": "1feeb3b88b67d2f82eba620f8e27d28ace0a50eda99b7ad7457ea4294b994d16",
  "original_prompt": "Ingested from linux-6.6.14/drivers/i2c/busses/i2c-amd756-s4882.c",
  "human_readable_source": "\n \n \n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/i2c.h>\n#include <linux/mutex.h>\n\nextern struct i2c_adapter amd756_smbus;\n\nstatic struct i2c_adapter *s4882_adapter;\nstatic struct i2c_algorithm *s4882_algo;\n\n \nstatic DEFINE_MUTEX(amd756_lock);\n\nstatic s32 amd756_access_virt0(struct i2c_adapter * adap, u16 addr,\n\t\t\t       unsigned short flags, char read_write,\n\t\t\t       u8 command, int size,\n\t\t\t       union i2c_smbus_data * data)\n{\n\tint error;\n\n\t \n\tif (addr == 0x4c || (addr & 0xfc) == 0x50 || (addr & 0xfc) == 0x30\n\t || addr == 0x18)\n\t\treturn -ENXIO;\n\n\tmutex_lock(&amd756_lock);\n\n\terror = amd756_smbus.algo->smbus_xfer(adap, addr, flags, read_write,\n\t\t\t\t\t      command, size, data);\n\n\tmutex_unlock(&amd756_lock);\n\n\treturn error;\n}\n\n \nstatic u8 last_channels;\n\nstatic inline s32 amd756_access_channel(struct i2c_adapter * adap, u16 addr,\n\t\t\t\t\tunsigned short flags, char read_write,\n\t\t\t\t\tu8 command, int size,\n\t\t\t\t\tunion i2c_smbus_data * data,\n\t\t\t\t\tu8 channels)\n{\n\tint error;\n\n\t \n\tif (addr != 0x4c && (addr & 0xfc) != 0x50 && (addr & 0xfc) != 0x30)\n\t\treturn -ENXIO;\n\n\tmutex_lock(&amd756_lock);\n\n\tif (last_channels != channels) {\n\t\tunion i2c_smbus_data mplxdata;\n\t\tmplxdata.byte = channels;\n\n\t\terror = amd756_smbus.algo->smbus_xfer(adap, 0x18, 0,\n\t\t\t\t\t\t      I2C_SMBUS_WRITE, 0x01,\n\t\t\t\t\t\t      I2C_SMBUS_BYTE_DATA,\n\t\t\t\t\t\t      &mplxdata);\n\t\tif (error)\n\t\t\tgoto UNLOCK;\n\t\tlast_channels = channels;\n\t}\n\terror = amd756_smbus.algo->smbus_xfer(adap, addr, flags, read_write,\n\t\t\t\t\t      command, size, data);\n\nUNLOCK:\n\tmutex_unlock(&amd756_lock);\n\treturn error;\n}\n\nstatic s32 amd756_access_virt1(struct i2c_adapter * adap, u16 addr,\n\t\t\t       unsigned short flags, char read_write,\n\t\t\t       u8 command, int size,\n\t\t\t       union i2c_smbus_data * data)\n{\n\t \n\treturn amd756_access_channel(adap, addr, flags, read_write, command,\n\t\t\t\t     size, data, 0x03);\n}\n\nstatic s32 amd756_access_virt2(struct i2c_adapter * adap, u16 addr,\n\t\t\t       unsigned short flags, char read_write,\n\t\t\t       u8 command, int size,\n\t\t\t       union i2c_smbus_data * data)\n{\n\t \n\treturn amd756_access_channel(adap, addr, flags, read_write, command,\n\t\t\t\t     size, data, 0x24);\n}\n\nstatic s32 amd756_access_virt3(struct i2c_adapter * adap, u16 addr,\n\t\t\t       unsigned short flags, char read_write,\n\t\t\t       u8 command, int size,\n\t\t\t       union i2c_smbus_data * data)\n{\n\t \n\treturn amd756_access_channel(adap, addr, flags, read_write, command,\n\t\t\t\t     size, data, 0x48);\n}\n\nstatic s32 amd756_access_virt4(struct i2c_adapter * adap, u16 addr,\n\t\t\t       unsigned short flags, char read_write,\n\t\t\t       u8 command, int size,\n\t\t\t       union i2c_smbus_data * data)\n{\n\t \n\treturn amd756_access_channel(adap, addr, flags, read_write, command,\n\t\t\t\t     size, data, 0x90);\n}\n\nstatic int __init amd756_s4882_init(void)\n{\n\tint i, error;\n\tunion i2c_smbus_data ioconfig;\n\n\tif (!amd756_smbus.dev.parent)\n\t\treturn -ENODEV;\n\n\t \n\tioconfig.byte = 0x00;  \n\terror = i2c_smbus_xfer(&amd756_smbus, 0x18, 0, I2C_SMBUS_WRITE, 0x03,\n\t\t\t       I2C_SMBUS_BYTE_DATA, &ioconfig);\n\tif (error) {\n\t\tdev_err(&amd756_smbus.dev, \"PCA9556 configuration failed\\n\");\n\t\terror = -EIO;\n\t\tgoto ERROR0;\n\t}\n\n\t \n\ti2c_del_adapter(&amd756_smbus);\n\n\tprintk(KERN_INFO \"Enabling SMBus multiplexing for Tyan S4882\\n\");\n\t \n\tif (!(s4882_adapter = kcalloc(5, sizeof(struct i2c_adapter),\n\t\t\t\t      GFP_KERNEL))) {\n\t\terror = -ENOMEM;\n\t\tgoto ERROR1;\n\t}\n\tif (!(s4882_algo = kcalloc(5, sizeof(struct i2c_algorithm),\n\t\t\t\t   GFP_KERNEL))) {\n\t\terror = -ENOMEM;\n\t\tgoto ERROR2;\n\t}\n\n\t \n\ts4882_algo[0] = *(amd756_smbus.algo);\n\ts4882_algo[0].smbus_xfer = amd756_access_virt0;\n\ts4882_adapter[0] = amd756_smbus;\n\ts4882_adapter[0].algo = s4882_algo;\n\ts4882_adapter[0].dev.parent = amd756_smbus.dev.parent;\n\tfor (i = 1; i < 5; i++) {\n\t\ts4882_algo[i] = *(amd756_smbus.algo);\n\t\ts4882_adapter[i] = amd756_smbus;\n\t\tsnprintf(s4882_adapter[i].name, sizeof(s4882_adapter[i].name),\n\t\t\t \"SMBus 8111 adapter (CPU%d)\", i-1);\n\t\ts4882_adapter[i].algo = s4882_algo+i;\n\t\ts4882_adapter[i].dev.parent = amd756_smbus.dev.parent;\n\t}\n\ts4882_algo[1].smbus_xfer = amd756_access_virt1;\n\ts4882_algo[2].smbus_xfer = amd756_access_virt2;\n\ts4882_algo[3].smbus_xfer = amd756_access_virt3;\n\ts4882_algo[4].smbus_xfer = amd756_access_virt4;\n\n\t \n\tfor (i = 0; i < 5; i++) {\n\t\terror = i2c_add_adapter(s4882_adapter+i);\n\t\tif (error) {\n\t\t\tprintk(KERN_ERR \"i2c-amd756-s4882: \"\n\t\t\t       \"Virtual adapter %d registration \"\n\t\t\t       \"failed, module not inserted\\n\", i);\n\t\t\tfor (i--; i >= 0; i--)\n\t\t\t\ti2c_del_adapter(s4882_adapter+i);\n\t\t\tgoto ERROR3;\n\t\t}\n\t}\n\n\treturn 0;\n\nERROR3:\n\tkfree(s4882_algo);\n\ts4882_algo = NULL;\nERROR2:\n\tkfree(s4882_adapter);\n\ts4882_adapter = NULL;\nERROR1:\n\t \n\ti2c_add_adapter(&amd756_smbus);\nERROR0:\n\treturn error;\n}\n\nstatic void __exit amd756_s4882_exit(void)\n{\n\tif (s4882_adapter) {\n\t\tint i;\n\n\t\tfor (i = 0; i < 5; i++)\n\t\t\ti2c_del_adapter(s4882_adapter+i);\n\t\tkfree(s4882_adapter);\n\t\ts4882_adapter = NULL;\n\t}\n\tkfree(s4882_algo);\n\ts4882_algo = NULL;\n\n\t \n\tif (i2c_add_adapter(&amd756_smbus))\n\t\tprintk(KERN_ERR \"i2c-amd756-s4882: \"\n\t\t       \"Physical bus restoration failed\\n\");\n}\n\nMODULE_AUTHOR(\"Jean Delvare <jdelvare@suse.de>\");\nMODULE_DESCRIPTION(\"S4882 SMBus multiplexing\");\nMODULE_LICENSE(\"GPL\");\n\nmodule_init(amd756_s4882_init);\nmodule_exit(amd756_s4882_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}