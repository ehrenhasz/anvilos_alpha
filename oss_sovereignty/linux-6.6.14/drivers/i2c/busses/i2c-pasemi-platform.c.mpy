{
  "module_name": "i2c-pasemi-platform.c",
  "hash_id": "a4f80e5a382f49fde84c6e19815af218d956de5dba58e1e0611e8a8bceac416f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/i2c/busses/i2c-pasemi-platform.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/i2c.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/types.h>\n\n#include \"i2c-pasemi-core.h\"\n\nstruct pasemi_platform_i2c_data {\n\tstruct pasemi_smbus smbus;\n\tstruct clk *clk_ref;\n};\n\nstatic int\npasemi_platform_i2c_calc_clk_div(struct pasemi_platform_i2c_data *data,\n\t\t\t\t u32 frequency)\n{\n\tunsigned long clk_rate = clk_get_rate(data->clk_ref);\n\n\tif (!clk_rate)\n\t\treturn -EINVAL;\n\n\tdata->smbus.clk_div = DIV_ROUND_UP(clk_rate, 16 * frequency);\n\tif (data->smbus.clk_div < 4)\n\t\treturn dev_err_probe(data->smbus.dev, -EINVAL,\n\t\t\t\t     \"Bus frequency %d is too fast.\\n\",\n\t\t\t\t     frequency);\n\tif (data->smbus.clk_div > 0xff)\n\t\treturn dev_err_probe(data->smbus.dev, -EINVAL,\n\t\t\t\t     \"Bus frequency %d is too slow.\\n\",\n\t\t\t\t     frequency);\n\n\treturn 0;\n}\n\nstatic int pasemi_platform_i2c_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct pasemi_platform_i2c_data *data;\n\tstruct pasemi_smbus *smbus;\n\tu32 frequency;\n\tint error;\n\tint irq_num;\n\n\tdata = devm_kzalloc(dev, sizeof(struct pasemi_platform_i2c_data),\n\t\t\t    GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tsmbus = &data->smbus;\n\tsmbus->dev = dev;\n\n\tsmbus->ioaddr = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(smbus->ioaddr))\n\t\treturn PTR_ERR(smbus->ioaddr);\n\n\tif (of_property_read_u32(dev->of_node, \"clock-frequency\", &frequency))\n\t\tfrequency = I2C_MAX_STANDARD_MODE_FREQ;\n\n\tdata->clk_ref = devm_clk_get_enabled(dev, NULL);\n\tif (IS_ERR(data->clk_ref))\n\t\treturn PTR_ERR(data->clk_ref);\n\n\terror = pasemi_platform_i2c_calc_clk_div(data, frequency);\n\tif (error)\n\t\treturn error;\n\n\tsmbus->adapter.dev.of_node = pdev->dev.of_node;\n\terror = pasemi_i2c_common_probe(smbus);\n\tif (error)\n\t\treturn error;\n\n\tirq_num = platform_get_irq(pdev, 0);\n\terror = devm_request_irq(smbus->dev, irq_num, pasemi_irq_handler, 0, \"pasemi_apple_i2c\", (void *)smbus);\n\n\tif (!error)\n\t\tsmbus->use_irq = 1;\n\tplatform_set_drvdata(pdev, data);\n\n\treturn 0;\n}\n\nstatic void pasemi_platform_i2c_remove(struct platform_device *pdev) { }\n\nstatic const struct of_device_id pasemi_platform_i2c_of_match[] = {\n\t{ .compatible = \"apple,t8103-i2c\" },\n\t{ .compatible = \"apple,i2c\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, pasemi_platform_i2c_of_match);\n\nstatic struct platform_driver pasemi_platform_i2c_driver = {\n\t.driver\t= {\n\t\t.name\t\t\t= \"i2c-apple\",\n\t\t.of_match_table\t\t= pasemi_platform_i2c_of_match,\n\t},\n\t.probe\t= pasemi_platform_i2c_probe,\n\t.remove_new = pasemi_platform_i2c_remove,\n};\nmodule_platform_driver(pasemi_platform_i2c_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Sven Peter <sven@svenpeter.dev>\");\nMODULE_DESCRIPTION(\"Apple/PASemi SMBus platform driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}