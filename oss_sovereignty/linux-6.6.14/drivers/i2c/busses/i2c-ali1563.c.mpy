{
  "module_name": "i2c-ali1563.c",
  "hash_id": "06b363671440c6d4c7e8d9e479dd435191c22859e710baa7b3f2f8bd92a5cb0a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/i2c/busses/i2c-ali1563.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/i2c.h>\n#include <linux/pci.h>\n#include <linux/acpi.h>\n\n#define ALI1563_MAX_TIMEOUT\t500\n#define\tALI1563_SMBBA\t\t0x80\n#define ALI1563_SMB_IOEN\t1\n#define ALI1563_SMB_HOSTEN\t2\n#define ALI1563_SMB_IOSIZE\t16\n\n#define SMB_HST_STS\t(ali1563_smba + 0)\n#define SMB_HST_CNTL1\t(ali1563_smba + 1)\n#define SMB_HST_CNTL2\t(ali1563_smba + 2)\n#define SMB_HST_CMD\t(ali1563_smba + 3)\n#define SMB_HST_ADD\t(ali1563_smba + 4)\n#define SMB_HST_DAT0\t(ali1563_smba + 5)\n#define SMB_HST_DAT1\t(ali1563_smba + 6)\n#define SMB_BLK_DAT\t(ali1563_smba + 7)\n\n#define HST_STS_BUSY\t0x01\n#define HST_STS_INTR\t0x02\n#define HST_STS_DEVERR\t0x04\n#define HST_STS_BUSERR\t0x08\n#define HST_STS_FAIL\t0x10\n#define HST_STS_DONE\t0x80\n#define HST_STS_BAD\t0x1c\n\n\n#define HST_CNTL1_TIMEOUT\t0x80\n#define HST_CNTL1_LAST\t\t0x40\n\n#define HST_CNTL2_KILL\t\t0x04\n#define HST_CNTL2_START\t\t0x40\n#define HST_CNTL2_QUICK\t\t0x00\n#define HST_CNTL2_BYTE\t\t0x01\n#define HST_CNTL2_BYTE_DATA\t0x02\n#define HST_CNTL2_WORD_DATA\t0x03\n#define HST_CNTL2_BLOCK\t\t0x05\n\n\n#define HST_CNTL2_SIZEMASK\t0x38\n\nstatic struct pci_driver ali1563_pci_driver;\nstatic unsigned short ali1563_smba;\n\nstatic int ali1563_transaction(struct i2c_adapter *a, int size)\n{\n\tu32 data;\n\tint timeout;\n\tint status = -EIO;\n\n\tdev_dbg(&a->dev, \"Transaction (pre): STS=%02x, CNTL1=%02x, \"\n\t\t\"CNTL2=%02x, CMD=%02x, ADD=%02x, DAT0=%02x, DAT1=%02x\\n\",\n\t\tinb_p(SMB_HST_STS), inb_p(SMB_HST_CNTL1), inb_p(SMB_HST_CNTL2),\n\t\tinb_p(SMB_HST_CMD), inb_p(SMB_HST_ADD), inb_p(SMB_HST_DAT0),\n\t\tinb_p(SMB_HST_DAT1));\n\n\tdata = inb_p(SMB_HST_STS);\n\tif (data & HST_STS_BAD) {\n\t\tdev_err(&a->dev, \"ali1563: Trying to reset busy device\\n\");\n\t\toutb_p(data | HST_STS_BAD, SMB_HST_STS);\n\t\tdata = inb_p(SMB_HST_STS);\n\t\tif (data & HST_STS_BAD)\n\t\t\treturn -EBUSY;\n\t}\n\toutb_p(inb_p(SMB_HST_CNTL2) | HST_CNTL2_START, SMB_HST_CNTL2);\n\n\ttimeout = ALI1563_MAX_TIMEOUT;\n\tdo {\n\t\tmsleep(1);\n\t} while (((data = inb_p(SMB_HST_STS)) & HST_STS_BUSY) && --timeout);\n\n\tdev_dbg(&a->dev, \"Transaction (post): STS=%02x, CNTL1=%02x, \"\n\t\t\"CNTL2=%02x, CMD=%02x, ADD=%02x, DAT0=%02x, DAT1=%02x\\n\",\n\t\tinb_p(SMB_HST_STS), inb_p(SMB_HST_CNTL1), inb_p(SMB_HST_CNTL2),\n\t\tinb_p(SMB_HST_CMD), inb_p(SMB_HST_ADD), inb_p(SMB_HST_DAT0),\n\t\tinb_p(SMB_HST_DAT1));\n\n\tif (timeout && !(data & HST_STS_BAD))\n\t\treturn 0;\n\n\tif (!timeout) {\n\t\tdev_err(&a->dev, \"Timeout - Trying to KILL transaction!\\n\");\n\t\t \n\t\toutb_p(HST_CNTL2_KILL, SMB_HST_CNTL2);\n\t\tdata = inb_p(SMB_HST_STS);\n\t\tstatus = -ETIMEDOUT;\n\t}\n\n\t \n\tif (data & HST_STS_DEVERR) {\n\t\tif (size != HST_CNTL2_QUICK)\n\t\t\tdev_err(&a->dev, \"Device error!\\n\");\n\t\tstatus = -ENXIO;\n\t}\n\t \n\tif (data & HST_STS_BUSERR) {\n\t\tdev_err(&a->dev, \"Bus collision!\\n\");\n\t\t \n\t\toutb_p(HST_CNTL1_TIMEOUT, SMB_HST_CNTL1);\n\t}\n\n\tif (data & HST_STS_FAIL) {\n\t\tdev_err(&a->dev, \"Cleaning fail after KILL!\\n\");\n\t\toutb_p(0x0, SMB_HST_CNTL2);\n\t}\n\n\treturn status;\n}\n\nstatic int ali1563_block_start(struct i2c_adapter *a)\n{\n\tu32 data;\n\tint timeout;\n\tint status = -EIO;\n\n\tdev_dbg(&a->dev, \"Block (pre): STS=%02x, CNTL1=%02x, \"\n\t\t\"CNTL2=%02x, CMD=%02x, ADD=%02x, DAT0=%02x, DAT1=%02x\\n\",\n\t\tinb_p(SMB_HST_STS), inb_p(SMB_HST_CNTL1), inb_p(SMB_HST_CNTL2),\n\t\tinb_p(SMB_HST_CMD), inb_p(SMB_HST_ADD), inb_p(SMB_HST_DAT0),\n\t\tinb_p(SMB_HST_DAT1));\n\n\tdata = inb_p(SMB_HST_STS);\n\tif (data & HST_STS_BAD) {\n\t\tdev_warn(&a->dev, \"ali1563: Trying to reset busy device\\n\");\n\t\toutb_p(data | HST_STS_BAD, SMB_HST_STS);\n\t\tdata = inb_p(SMB_HST_STS);\n\t\tif (data & HST_STS_BAD)\n\t\t\treturn -EBUSY;\n\t}\n\n\t \n\toutb_p(data | HST_STS_DONE, SMB_HST_STS);\n\n\t \n\toutb_p(inb_p(SMB_HST_CNTL2) | HST_CNTL2_START, SMB_HST_CNTL2);\n\n\ttimeout = ALI1563_MAX_TIMEOUT;\n\tdo {\n\t\tmsleep(1);\n\t} while (!((data = inb_p(SMB_HST_STS)) & HST_STS_DONE) && --timeout);\n\n\tdev_dbg(&a->dev, \"Block (post): STS=%02x, CNTL1=%02x, \"\n\t\t\"CNTL2=%02x, CMD=%02x, ADD=%02x, DAT0=%02x, DAT1=%02x\\n\",\n\t\tinb_p(SMB_HST_STS), inb_p(SMB_HST_CNTL1), inb_p(SMB_HST_CNTL2),\n\t\tinb_p(SMB_HST_CMD), inb_p(SMB_HST_ADD), inb_p(SMB_HST_DAT0),\n\t\tinb_p(SMB_HST_DAT1));\n\n\tif (timeout && !(data & HST_STS_BAD))\n\t\treturn 0;\n\n\tif (timeout == 0)\n\t\tstatus = -ETIMEDOUT;\n\n\tif (data & HST_STS_DEVERR)\n\t\tstatus = -ENXIO;\n\n\tdev_err(&a->dev, \"SMBus Error: %s%s%s%s%s\\n\",\n\t\ttimeout ? \"\" : \"Timeout \",\n\t\tdata & HST_STS_FAIL ? \"Transaction Failed \" : \"\",\n\t\tdata & HST_STS_BUSERR ? \"No response or Bus Collision \" : \"\",\n\t\tdata & HST_STS_DEVERR ? \"Device Error \" : \"\",\n\t\t!(data & HST_STS_DONE) ? \"Transaction Never Finished \" : \"\");\n\treturn status;\n}\n\nstatic int ali1563_block(struct i2c_adapter *a,\n\t\t\t union i2c_smbus_data *data, u8 rw)\n{\n\tint i, len;\n\tint error = 0;\n\n\t \n\toutb_p(HST_CNTL1_LAST, SMB_HST_CNTL1);\n\n\tif (rw == I2C_SMBUS_WRITE) {\n\t\tlen = data->block[0];\n\t\tif (len < 1)\n\t\t\tlen = 1;\n\t\telse if (len > 32)\n\t\t\tlen = 32;\n\t\toutb_p(len, SMB_HST_DAT0);\n\t\toutb_p(data->block[1], SMB_BLK_DAT);\n\t} else\n\t\tlen = 32;\n\n\toutb_p(inb_p(SMB_HST_CNTL2) | HST_CNTL2_BLOCK, SMB_HST_CNTL2);\n\n\tfor (i = 0; i < len; i++) {\n\t\tif (rw == I2C_SMBUS_WRITE) {\n\t\t\toutb_p(data->block[i + 1], SMB_BLK_DAT);\n\t\t\terror = ali1563_block_start(a);\n\t\t\tif (error)\n\t\t\t\tbreak;\n\t\t} else {\n\t\t\terror = ali1563_block_start(a);\n\t\t\tif (error)\n\t\t\t\tbreak;\n\t\t\tif (i == 0) {\n\t\t\t\tlen = inb_p(SMB_HST_DAT0);\n\t\t\t\tif (len < 1)\n\t\t\t\t\tlen = 1;\n\t\t\t\telse if (len > 32)\n\t\t\t\t\tlen = 32;\n\t\t\t}\n\t\t\tdata->block[i+1] = inb_p(SMB_BLK_DAT);\n\t\t}\n\t}\n\t \n\toutb_p(HST_CNTL1_LAST, SMB_HST_CNTL1);\n\treturn error;\n}\n\nstatic s32 ali1563_access(struct i2c_adapter *a, u16 addr,\n\t\t\t  unsigned short flags, char rw, u8 cmd,\n\t\t\t  int size, union i2c_smbus_data *data)\n{\n\tint error = 0;\n\tint timeout;\n\tu32 reg;\n\n\tfor (timeout = ALI1563_MAX_TIMEOUT; timeout; timeout--) {\n\t\treg = inb_p(SMB_HST_STS);\n\t\tif (!(reg & HST_STS_BUSY))\n\t\t\tbreak;\n\t}\n\tif (!timeout)\n\t\tdev_warn(&a->dev, \"SMBus not idle. HST_STS = %02x\\n\", reg);\n\toutb_p(0xff, SMB_HST_STS);\n\n\t \n\tswitch (size) {\n\tcase I2C_SMBUS_QUICK:\n\t\tsize = HST_CNTL2_QUICK;\n\t\tbreak;\n\tcase I2C_SMBUS_BYTE:\n\t\tsize = HST_CNTL2_BYTE;\n\t\tbreak;\n\tcase I2C_SMBUS_BYTE_DATA:\n\t\tsize = HST_CNTL2_BYTE_DATA;\n\t\tbreak;\n\tcase I2C_SMBUS_WORD_DATA:\n\t\tsize = HST_CNTL2_WORD_DATA;\n\t\tbreak;\n\tcase I2C_SMBUS_BLOCK_DATA:\n\t\tsize = HST_CNTL2_BLOCK;\n\t\tbreak;\n\tdefault:\n\t\tdev_warn(&a->dev, \"Unsupported transaction %d\\n\", size);\n\t\terror = -EOPNOTSUPP;\n\t\tgoto Done;\n\t}\n\n\toutb_p(((addr & 0x7f) << 1) | (rw & 0x01), SMB_HST_ADD);\n\toutb_p((inb_p(SMB_HST_CNTL2) & ~HST_CNTL2_SIZEMASK) |\n\t       (size << 3), SMB_HST_CNTL2);\n\n\t \n\n\tswitch (size) {\n\tcase HST_CNTL2_BYTE:\n\t\tif (rw == I2C_SMBUS_WRITE)\n\t\t\t \n\t\t\toutb_p(cmd, SMB_HST_DAT0);\n\t\tbreak;\n\tcase HST_CNTL2_BYTE_DATA:\n\t\toutb_p(cmd, SMB_HST_CMD);\n\t\tif (rw == I2C_SMBUS_WRITE)\n\t\t\toutb_p(data->byte, SMB_HST_DAT0);\n\t\tbreak;\n\tcase HST_CNTL2_WORD_DATA:\n\t\toutb_p(cmd, SMB_HST_CMD);\n\t\tif (rw == I2C_SMBUS_WRITE) {\n\t\t\toutb_p(data->word & 0xff, SMB_HST_DAT0);\n\t\t\toutb_p((data->word & 0xff00) >> 8, SMB_HST_DAT1);\n\t\t}\n\t\tbreak;\n\tcase HST_CNTL2_BLOCK:\n\t\toutb_p(cmd, SMB_HST_CMD);\n\t\terror = ali1563_block(a, data, rw);\n\t\tgoto Done;\n\t}\n\n\terror = ali1563_transaction(a, size);\n\tif (error)\n\t\tgoto Done;\n\n\tif ((rw == I2C_SMBUS_WRITE) || (size == HST_CNTL2_QUICK))\n\t\tgoto Done;\n\n\tswitch (size) {\n\tcase HST_CNTL2_BYTE:\t \n\t\tdata->byte = inb_p(SMB_HST_DAT0);\n\t\tbreak;\n\tcase HST_CNTL2_BYTE_DATA:\n\t\tdata->byte = inb_p(SMB_HST_DAT0);\n\t\tbreak;\n\tcase HST_CNTL2_WORD_DATA:\n\t\tdata->word = inb_p(SMB_HST_DAT0) + (inb_p(SMB_HST_DAT1) << 8);\n\t\tbreak;\n\t}\nDone:\n\treturn error;\n}\n\nstatic u32 ali1563_func(struct i2c_adapter *a)\n{\n\treturn I2C_FUNC_SMBUS_QUICK | I2C_FUNC_SMBUS_BYTE |\n\t    I2C_FUNC_SMBUS_BYTE_DATA | I2C_FUNC_SMBUS_WORD_DATA |\n\t    I2C_FUNC_SMBUS_BLOCK_DATA;\n}\n\n\nstatic int ali1563_setup(struct pci_dev *dev)\n{\n\tu16 ctrl;\n\n\tpci_read_config_word(dev, ALI1563_SMBBA, &ctrl);\n\n\t \n\tali1563_smba = ctrl & ~(ALI1563_SMB_IOSIZE - 1);\n\tif (!ali1563_smba) {\n\t\tdev_warn(&dev->dev, \"ali1563_smba Uninitialized\\n\");\n\t\tgoto Err;\n\t}\n\n\t \n\tif (!(ctrl & ALI1563_SMB_HOSTEN)) {\n\t\tdev_warn(&dev->dev, \"Host Controller not enabled\\n\");\n\t\tgoto Err;\n\t}\n\tif (!(ctrl & ALI1563_SMB_IOEN)) {\n\t\tdev_warn(&dev->dev, \"I/O space not enabled, trying manually\\n\");\n\t\tpci_write_config_word(dev, ALI1563_SMBBA,\n\t\t\t\t      ctrl | ALI1563_SMB_IOEN);\n\t\tpci_read_config_word(dev, ALI1563_SMBBA, &ctrl);\n\t\tif (!(ctrl & ALI1563_SMB_IOEN)) {\n\t\t\tdev_err(&dev->dev,\n\t\t\t\t\"I/O space still not enabled, giving up\\n\");\n\t\t\tgoto Err;\n\t\t}\n\t}\n\n\tif (acpi_check_region(ali1563_smba, ALI1563_SMB_IOSIZE,\n\t\t\t      ali1563_pci_driver.name))\n\t\tgoto Err;\n\n\tif (!request_region(ali1563_smba, ALI1563_SMB_IOSIZE,\n\t\t\t    ali1563_pci_driver.name)) {\n\t\tdev_err(&dev->dev, \"Could not allocate I/O space at 0x%04x\\n\",\n\t\t\tali1563_smba);\n\t\tgoto Err;\n\t}\n\tdev_info(&dev->dev, \"Found ALi1563 SMBus at 0x%04x\\n\", ali1563_smba);\n\n\treturn 0;\nErr:\n\treturn -ENODEV;\n}\n\nstatic void ali1563_shutdown(struct pci_dev *dev)\n{\n\trelease_region(ali1563_smba, ALI1563_SMB_IOSIZE);\n}\n\nstatic const struct i2c_algorithm ali1563_algorithm = {\n\t.smbus_xfer\t= ali1563_access,\n\t.functionality\t= ali1563_func,\n};\n\nstatic struct i2c_adapter ali1563_adapter = {\n\t.owner\t= THIS_MODULE,\n\t.class\t= I2C_CLASS_HWMON | I2C_CLASS_SPD,\n\t.algo\t= &ali1563_algorithm,\n};\n\nstatic int ali1563_probe(struct pci_dev *dev,\n\t\t\t const struct pci_device_id *id_table)\n{\n\tint error;\n\n\terror = ali1563_setup(dev);\n\tif (error)\n\t\tgoto exit;\n\tali1563_adapter.dev.parent = &dev->dev;\n\tsnprintf(ali1563_adapter.name, sizeof(ali1563_adapter.name),\n\t\t \"SMBus ALi 1563 Adapter @ %04x\", ali1563_smba);\n\terror = i2c_add_adapter(&ali1563_adapter);\n\tif (error)\n\t\tgoto exit_shutdown;\n\treturn 0;\n\nexit_shutdown:\n\tali1563_shutdown(dev);\nexit:\n\tdev_warn(&dev->dev, \"ALi1563 SMBus probe failed (%d)\\n\", error);\n\treturn error;\n}\n\nstatic void ali1563_remove(struct pci_dev *dev)\n{\n\ti2c_del_adapter(&ali1563_adapter);\n\tali1563_shutdown(dev);\n}\n\nstatic const struct pci_device_id ali1563_id_table[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M1563) },\n\t{},\n};\n\nMODULE_DEVICE_TABLE(pci, ali1563_id_table);\n\nstatic struct pci_driver ali1563_pci_driver = {\n\t.name\t\t= \"ali1563_smbus\",\n\t.id_table\t= ali1563_id_table,\n\t.probe\t\t= ali1563_probe,\n\t.remove\t\t= ali1563_remove,\n};\n\nmodule_pci_driver(ali1563_pci_driver);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}