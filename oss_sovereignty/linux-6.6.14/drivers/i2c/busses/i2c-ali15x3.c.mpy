{
  "module_name": "i2c-ali15x3.c",
  "hash_id": "276e53c164211420eb27f61d34d19f4fe56f6917025a087a19e4d82178683e66",
  "original_prompt": "Ingested from linux-6.6.14/drivers/i2c/busses/i2c-ali15x3.c",
  "human_readable_source": "\n \n\n \n\n \n\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/kernel.h>\n#include <linux/stddef.h>\n#include <linux/ioport.h>\n#include <linux/delay.h>\n#include <linux/i2c.h>\n#include <linux/acpi.h>\n#include <linux/io.h>\n\n \n#define SMBHSTSTS\t(0 + ali15x3_smba)\n#define SMBHSTCNT\t(1 + ali15x3_smba)\n#define SMBHSTSTART\t(2 + ali15x3_smba)\n#define SMBHSTCMD\t(7 + ali15x3_smba)\n#define SMBHSTADD\t(3 + ali15x3_smba)\n#define SMBHSTDAT0\t(4 + ali15x3_smba)\n#define SMBHSTDAT1\t(5 + ali15x3_smba)\n#define SMBBLKDAT\t(6 + ali15x3_smba)\n\n \n#define SMBCOM\t\t0x004\n#define SMBBA\t\t0x014\n#define SMBATPC\t\t0x05B\t \n#define SMBHSTCFG\t0x0E0\n#define SMBSLVC\t\t0x0E1\n#define SMBCLK\t\t0x0E2\n#define SMBREV\t\t0x008\n\n \n#define MAX_TIMEOUT\t\t200\t \n#define ALI15X3_SMB_IOSIZE\t32\n\n \n#define ALI15X3_SMB_DEFAULTBASE\t0xE800\n\n \n#define ALI15X3_LOCK\t\t0x06\n\n \n#define ALI15X3_ABORT\t\t0x02\n#define ALI15X3_T_OUT\t\t0x04\n#define ALI15X3_QUICK\t\t0x00\n#define ALI15X3_BYTE\t\t0x10\n#define ALI15X3_BYTE_DATA\t0x20\n#define ALI15X3_WORD_DATA\t0x30\n#define ALI15X3_BLOCK_DATA\t0x40\n#define ALI15X3_BLOCK_CLR\t0x80\n\n \n#define ALI15X3_STS_IDLE\t0x04\n#define ALI15X3_STS_BUSY\t0x08\n#define ALI15X3_STS_DONE\t0x10\n#define ALI15X3_STS_DEV\t\t0x20\t \n#define ALI15X3_STS_COLL\t0x40\t \n#define ALI15X3_STS_TERM\t0x80\t \n#define ALI15X3_STS_ERR\t\t0xE0\t \n\n\n \nstatic u16 force_addr;\nmodule_param_hw(force_addr, ushort, ioport, 0);\nMODULE_PARM_DESC(force_addr,\n\t\t \"Initialize the base address of the i2c controller\");\n\nstatic struct pci_driver ali15x3_driver;\nstatic unsigned short ali15x3_smba;\n\nstatic int ali15x3_setup(struct pci_dev *ALI15X3_dev)\n{\n\tu16 a;\n\tunsigned char temp;\n\n\t \n\n\t \n\tpci_read_config_byte(ALI15X3_dev, SMBATPC, &temp);\n\tif (temp & ALI15X3_LOCK) {\n\t\ttemp &= ~ALI15X3_LOCK;\n\t\tpci_write_config_byte(ALI15X3_dev, SMBATPC, temp);\n\t}\n\n\t \n\tpci_read_config_word(ALI15X3_dev, SMBBA, &ali15x3_smba);\n\tali15x3_smba &= (0xffff & ~(ALI15X3_SMB_IOSIZE - 1));\n\tif (ali15x3_smba == 0 && force_addr == 0) {\n\t\tdev_err(&ALI15X3_dev->dev, \"ALI15X3_smb region uninitialized \"\n\t\t\t\"- upgrade BIOS or use force_addr=0xaddr\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif(force_addr)\n\t\tali15x3_smba = force_addr & ~(ALI15X3_SMB_IOSIZE - 1);\n\n\tif (acpi_check_region(ali15x3_smba, ALI15X3_SMB_IOSIZE,\n\t\t\t      ali15x3_driver.name))\n\t\treturn -EBUSY;\n\n\tif (!request_region(ali15x3_smba, ALI15X3_SMB_IOSIZE,\n\t\t\t    ali15x3_driver.name)) {\n\t\tdev_err(&ALI15X3_dev->dev,\n\t\t\t\"ALI15X3_smb region 0x%x already in use!\\n\",\n\t\t\tali15x3_smba);\n\t\treturn -ENODEV;\n\t}\n\n\tif(force_addr) {\n\t\tint ret;\n\n\t\tdev_info(&ALI15X3_dev->dev, \"forcing ISA address 0x%04X\\n\",\n\t\t\tali15x3_smba);\n\t\tret = pci_write_config_word(ALI15X3_dev, SMBBA, ali15x3_smba);\n\t\tif (ret != PCIBIOS_SUCCESSFUL)\n\t\t\tgoto error;\n\t\tret = pci_read_config_word(ALI15X3_dev, SMBBA, &a);\n\t\tif (ret != PCIBIOS_SUCCESSFUL)\n\t\t\tgoto error;\n\t\tif ((a & ~(ALI15X3_SMB_IOSIZE - 1)) != ali15x3_smba) {\n\t\t\t \n\t\t\tdev_err(&ALI15X3_dev->dev,\n\t\t\t\t\"force address failed - not supported?\\n\");\n\t\t\tgoto error;\n\t\t}\n\t}\n\t \n\tpci_read_config_byte(ALI15X3_dev, SMBCOM, &temp);\n\tif ((temp & 1) == 0) {\n\t\tdev_info(&ALI15X3_dev->dev, \"enabling SMBus device\\n\");\n\t\tpci_write_config_byte(ALI15X3_dev, SMBCOM, temp | 0x01);\n\t}\n\n\t \n\tpci_read_config_byte(ALI15X3_dev, SMBHSTCFG, &temp);\n\tif ((temp & 1) == 0) {\n\t\tdev_info(&ALI15X3_dev->dev, \"enabling SMBus controller\\n\");\n\t\tpci_write_config_byte(ALI15X3_dev, SMBHSTCFG, temp | 0x01);\n\t}\n\n\t \n\tpci_write_config_byte(ALI15X3_dev, SMBCLK, 0x20);\n\n\t \n\tpci_read_config_byte(ALI15X3_dev, SMBREV, &temp);\n\tdev_dbg(&ALI15X3_dev->dev, \"SMBREV = 0x%X\\n\", temp);\n\tdev_dbg(&ALI15X3_dev->dev, \"iALI15X3_smba = 0x%X\\n\", ali15x3_smba);\n\n\treturn 0;\nerror:\n\trelease_region(ali15x3_smba, ALI15X3_SMB_IOSIZE);\n\treturn -ENODEV;\n}\n\n \nstatic int ali15x3_transaction(struct i2c_adapter *adap)\n{\n\tint temp;\n\tint result = 0;\n\tint timeout = 0;\n\n\tdev_dbg(&adap->dev, \"Transaction (pre): STS=%02x, CNT=%02x, CMD=%02x, \"\n\t\t\"ADD=%02x, DAT0=%02x, DAT1=%02x\\n\", inb_p(SMBHSTSTS),\n\t\tinb_p(SMBHSTCNT), inb_p(SMBHSTCMD), inb_p(SMBHSTADD),\n\t\tinb_p(SMBHSTDAT0), inb_p(SMBHSTDAT1));\n\n\t \n\ttemp = inb_p(SMBHSTSTS);\n\n\t \n\t \n\tif (temp & ALI15X3_STS_BUSY) {\n\t \n\t \n\t \n\t\tdev_info(&adap->dev, \"Resetting entire SMB Bus to \"\n\t\t\t\"clear busy condition (%02x)\\n\", temp);\n\t\toutb_p(ALI15X3_T_OUT, SMBHSTCNT);\n\t\ttemp = inb_p(SMBHSTSTS);\n\t}\n\n\t \n\tif (temp & (ALI15X3_STS_ERR | ALI15X3_STS_BUSY)) {\n\t\t \n\t\toutb_p(0xFF, SMBHSTSTS);\n\t\tif ((temp = inb_p(SMBHSTSTS)) &\n\t\t    (ALI15X3_STS_ERR | ALI15X3_STS_BUSY)) {\n\t\t\t \n\t\t\t \n\t\t\tdev_err(&adap->dev, \"SMBus reset failed! (0x%02x) - \"\n\t\t\t\t\"controller or device on bus is probably hung\\n\",\n\t\t\t\ttemp);\n\t\t\treturn -EBUSY;\n\t\t}\n\t} else {\n\t\t \n\t\tif (temp & ALI15X3_STS_DONE) {\n\t\t\toutb_p(temp, SMBHSTSTS);\n\t\t}\n\t}\n\n\t \n\toutb_p(0xFF, SMBHSTSTART);\n\n\t \n\ttimeout = 0;\n\tdo {\n\t\tmsleep(1);\n\t\ttemp = inb_p(SMBHSTSTS);\n\t} while ((!(temp & (ALI15X3_STS_ERR | ALI15X3_STS_DONE)))\n\t\t && (timeout++ < MAX_TIMEOUT));\n\n\t \n\tif (timeout > MAX_TIMEOUT) {\n\t\tresult = -ETIMEDOUT;\n\t\tdev_err(&adap->dev, \"SMBus Timeout!\\n\");\n\t}\n\n\tif (temp & ALI15X3_STS_TERM) {\n\t\tresult = -EIO;\n\t\tdev_dbg(&adap->dev, \"Error: Failed bus transaction\\n\");\n\t}\n\n\t \n\tif (temp & ALI15X3_STS_COLL) {\n\t\tresult = -ENXIO;\n\t\tdev_dbg(&adap->dev,\n\t\t\t\"Error: no response or bus collision ADD=%02x\\n\",\n\t\t\tinb_p(SMBHSTADD));\n\t}\n\n\t \n\tif (temp & ALI15X3_STS_DEV) {\n\t\tresult = -EIO;\n\t\tdev_err(&adap->dev, \"Error: device error\\n\");\n\t}\n\tdev_dbg(&adap->dev, \"Transaction (post): STS=%02x, CNT=%02x, CMD=%02x, \"\n\t\t\"ADD=%02x, DAT0=%02x, DAT1=%02x\\n\", inb_p(SMBHSTSTS),\n\t\tinb_p(SMBHSTCNT), inb_p(SMBHSTCMD), inb_p(SMBHSTADD),\n\t\tinb_p(SMBHSTDAT0), inb_p(SMBHSTDAT1));\n\treturn result;\n}\n\n \nstatic s32 ali15x3_access(struct i2c_adapter * adap, u16 addr,\n\t\t   unsigned short flags, char read_write, u8 command,\n\t\t   int size, union i2c_smbus_data * data)\n{\n\tint i, len;\n\tint temp;\n\tint timeout;\n\n\t \n\toutb_p(0xFF, SMBHSTSTS);\n\t \n\ttemp = inb_p(SMBHSTSTS);\n\tfor (timeout = 0;\n\t     (timeout < MAX_TIMEOUT) && !(temp & ALI15X3_STS_IDLE);\n\t     timeout++) {\n\t\tmsleep(1);\n\t\ttemp = inb_p(SMBHSTSTS);\n\t}\n\tif (timeout >= MAX_TIMEOUT) {\n\t\tdev_err(&adap->dev, \"Idle wait Timeout! STS=0x%02x\\n\", temp);\n\t}\n\n\tswitch (size) {\n\tcase I2C_SMBUS_QUICK:\n\t\toutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\n\t\t       SMBHSTADD);\n\t\tsize = ALI15X3_QUICK;\n\t\tbreak;\n\tcase I2C_SMBUS_BYTE:\n\t\toutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\n\t\t       SMBHSTADD);\n\t\tif (read_write == I2C_SMBUS_WRITE)\n\t\t\toutb_p(command, SMBHSTCMD);\n\t\tsize = ALI15X3_BYTE;\n\t\tbreak;\n\tcase I2C_SMBUS_BYTE_DATA:\n\t\toutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\n\t\t       SMBHSTADD);\n\t\toutb_p(command, SMBHSTCMD);\n\t\tif (read_write == I2C_SMBUS_WRITE)\n\t\t\toutb_p(data->byte, SMBHSTDAT0);\n\t\tsize = ALI15X3_BYTE_DATA;\n\t\tbreak;\n\tcase I2C_SMBUS_WORD_DATA:\n\t\toutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\n\t\t       SMBHSTADD);\n\t\toutb_p(command, SMBHSTCMD);\n\t\tif (read_write == I2C_SMBUS_WRITE) {\n\t\t\toutb_p(data->word & 0xff, SMBHSTDAT0);\n\t\t\toutb_p((data->word & 0xff00) >> 8, SMBHSTDAT1);\n\t\t}\n\t\tsize = ALI15X3_WORD_DATA;\n\t\tbreak;\n\tcase I2C_SMBUS_BLOCK_DATA:\n\t\toutb_p(((addr & 0x7f) << 1) | (read_write & 0x01),\n\t\t       SMBHSTADD);\n\t\toutb_p(command, SMBHSTCMD);\n\t\tif (read_write == I2C_SMBUS_WRITE) {\n\t\t\tlen = data->block[0];\n\t\t\tif (len < 0) {\n\t\t\t\tlen = 0;\n\t\t\t\tdata->block[0] = len;\n\t\t\t}\n\t\t\tif (len > 32) {\n\t\t\t\tlen = 32;\n\t\t\t\tdata->block[0] = len;\n\t\t\t}\n\t\t\toutb_p(len, SMBHSTDAT0);\n\t\t\t \n\t\t\toutb_p(inb_p(SMBHSTCNT) | ALI15X3_BLOCK_CLR, SMBHSTCNT);\n\t\t\tfor (i = 1; i <= len; i++)\n\t\t\t\toutb_p(data->block[i], SMBBLKDAT);\n\t\t}\n\t\tsize = ALI15X3_BLOCK_DATA;\n\t\tbreak;\n\tdefault:\n\t\tdev_warn(&adap->dev, \"Unsupported transaction %d\\n\", size);\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\toutb_p(size, SMBHSTCNT);\t \n\n\ttemp = ali15x3_transaction(adap);\n\tif (temp)\n\t\treturn temp;\n\n\tif ((read_write == I2C_SMBUS_WRITE) || (size == ALI15X3_QUICK))\n\t\treturn 0;\n\n\n\tswitch (size) {\n\tcase ALI15X3_BYTE:\t \n\t\tdata->byte = inb_p(SMBHSTDAT0);\n\t\tbreak;\n\tcase ALI15X3_BYTE_DATA:\n\t\tdata->byte = inb_p(SMBHSTDAT0);\n\t\tbreak;\n\tcase ALI15X3_WORD_DATA:\n\t\tdata->word = inb_p(SMBHSTDAT0) + (inb_p(SMBHSTDAT1) << 8);\n\t\tbreak;\n\tcase ALI15X3_BLOCK_DATA:\n\t\tlen = inb_p(SMBHSTDAT0);\n\t\tif (len > 32)\n\t\t\tlen = 32;\n\t\tdata->block[0] = len;\n\t\t \n\t\toutb_p(inb_p(SMBHSTCNT) | ALI15X3_BLOCK_CLR, SMBHSTCNT);\n\t\tfor (i = 1; i <= data->block[0]; i++) {\n\t\t\tdata->block[i] = inb_p(SMBBLKDAT);\n\t\t\tdev_dbg(&adap->dev, \"Blk: len=%d, i=%d, data=%02x\\n\",\n\t\t\t\tlen, i, data->block[i]);\n\t\t}\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic u32 ali15x3_func(struct i2c_adapter *adapter)\n{\n\treturn I2C_FUNC_SMBUS_QUICK | I2C_FUNC_SMBUS_BYTE |\n\t    I2C_FUNC_SMBUS_BYTE_DATA | I2C_FUNC_SMBUS_WORD_DATA |\n\t    I2C_FUNC_SMBUS_BLOCK_DATA;\n}\n\nstatic const struct i2c_algorithm smbus_algorithm = {\n\t.smbus_xfer\t= ali15x3_access,\n\t.functionality\t= ali15x3_func,\n};\n\nstatic struct i2c_adapter ali15x3_adapter = {\n\t.owner\t\t= THIS_MODULE,\n\t.class          = I2C_CLASS_HWMON | I2C_CLASS_SPD,\n\t.algo\t\t= &smbus_algorithm,\n};\n\nstatic const struct pci_device_id ali15x3_ids[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M7101) },\n\t{ 0, }\n};\n\nMODULE_DEVICE_TABLE (pci, ali15x3_ids);\n\nstatic int ali15x3_probe(struct pci_dev *dev, const struct pci_device_id *id)\n{\n\tif (ali15x3_setup(dev)) {\n\t\tdev_err(&dev->dev,\n\t\t\t\"ALI15X3 not detected, module not inserted.\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tali15x3_adapter.dev.parent = &dev->dev;\n\n\tsnprintf(ali15x3_adapter.name, sizeof(ali15x3_adapter.name),\n\t\t\"SMBus ALI15X3 adapter at %04x\", ali15x3_smba);\n\treturn i2c_add_adapter(&ali15x3_adapter);\n}\n\nstatic void ali15x3_remove(struct pci_dev *dev)\n{\n\ti2c_del_adapter(&ali15x3_adapter);\n\trelease_region(ali15x3_smba, ALI15X3_SMB_IOSIZE);\n}\n\nstatic struct pci_driver ali15x3_driver = {\n\t.name\t\t= \"ali15x3_smbus\",\n\t.id_table\t= ali15x3_ids,\n\t.probe\t\t= ali15x3_probe,\n\t.remove\t\t= ali15x3_remove,\n};\n\nmodule_pci_driver(ali15x3_driver);\n\nMODULE_AUTHOR(\"Frodo Looijaard <frodol@dds.nl>\");\nMODULE_AUTHOR(\"Philip Edelbrock <phil@netroedge.com>\");\nMODULE_AUTHOR(\"Mark D. Studebaker <mdsxyz123@yahoo.com>\");\nMODULE_DESCRIPTION(\"ALI15X3 SMBus driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}