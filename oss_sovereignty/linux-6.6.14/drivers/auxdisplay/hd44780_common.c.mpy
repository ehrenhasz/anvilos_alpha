{
  "module_name": "hd44780_common.c",
  "hash_id": "49cbba281e4607295e203b37cb017f3157de2c12058eb7dfae504dbdb032adc3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/auxdisplay/hd44780_common.c",
  "human_readable_source": "\n#include <linux/module.h>\n#include <linux/sched.h>\n#include <linux/slab.h>\n\n#include \"charlcd.h\"\n#include \"hd44780_common.h\"\n\n \n#define LCD_CMD_DISPLAY_CLEAR\t0x01\t \n\n#define LCD_CMD_ENTRY_MODE\t0x04\t \n#define LCD_CMD_CURSOR_INC\t0x02\t \n\n#define LCD_CMD_DISPLAY_CTRL\t0x08\t \n#define LCD_CMD_DISPLAY_ON\t0x04\t \n#define LCD_CMD_CURSOR_ON\t0x02\t \n#define LCD_CMD_BLINK_ON\t0x01\t \n\n#define LCD_CMD_SHIFT\t\t0x10\t \n#define LCD_CMD_DISPLAY_SHIFT\t0x08\t \n#define LCD_CMD_SHIFT_RIGHT\t0x04\t \n\n#define LCD_CMD_FUNCTION_SET\t0x20\t \n#define LCD_CMD_DATA_LEN_8BITS\t0x10\t \n#define LCD_CMD_TWO_LINES\t0x08\t \n#define LCD_CMD_FONT_5X10_DOTS\t0x04\t \n\n#define LCD_CMD_SET_CGRAM_ADDR\t0x40\t \n\n#define LCD_CMD_SET_DDRAM_ADDR\t0x80\t \n\n \nstatic void long_sleep(int ms)\n{\n\tschedule_timeout_interruptible(msecs_to_jiffies(ms));\n}\n\nint hd44780_common_print(struct charlcd *lcd, int c)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\n\tif (lcd->addr.x < hdc->bwidth) {\n\t\thdc->write_data(hdc, c);\n\t\treturn 0;\n\t}\n\n\treturn 1;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_print);\n\nint hd44780_common_gotoxy(struct charlcd *lcd, unsigned int x, unsigned int y)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\tunsigned int addr;\n\n\t \n\taddr = x < hdc->bwidth ? x & (hdc->hwidth - 1) : hdc->bwidth - 1;\n\tif (y & 1)\n\t\taddr += hdc->hwidth;\n\tif (y & 2)\n\t\taddr += hdc->bwidth;\n\thdc->write_cmd(hdc, LCD_CMD_SET_DDRAM_ADDR | addr);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_gotoxy);\n\nint hd44780_common_home(struct charlcd *lcd)\n{\n\treturn hd44780_common_gotoxy(lcd, 0, 0);\n}\nEXPORT_SYMBOL_GPL(hd44780_common_home);\n\n \nint hd44780_common_clear_display(struct charlcd *lcd)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\n\thdc->write_cmd(hdc, LCD_CMD_DISPLAY_CLEAR);\n\t \n\tlong_sleep(2);\n\n\t \n\treturn hd44780_common_home(lcd);\n}\nEXPORT_SYMBOL_GPL(hd44780_common_clear_display);\n\nint hd44780_common_init_display(struct charlcd *lcd)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\n\tvoid (*write_cmd_raw)(struct hd44780_common *hdc, int cmd);\n\tu8 init;\n\n\tif (hdc->ifwidth != 4 && hdc->ifwidth != 8)\n\t\treturn -EINVAL;\n\n\thdc->hd44780_common_flags = ((lcd->height > 1) ? LCD_FLAG_N : 0) |\n\t\tLCD_FLAG_D | LCD_FLAG_C | LCD_FLAG_B;\n\n\tlong_sleep(20);\t\t \n\n\t \n\tinit = LCD_CMD_FUNCTION_SET | LCD_CMD_DATA_LEN_8BITS;\n\tif (hdc->ifwidth == 4) {\n\t\tinit >>= 4;\n\t\twrite_cmd_raw = hdc->write_cmd_raw4;\n\t} else {\n\t\twrite_cmd_raw = hdc->write_cmd;\n\t}\n\twrite_cmd_raw(hdc, init);\n\tlong_sleep(10);\n\twrite_cmd_raw(hdc, init);\n\tlong_sleep(10);\n\twrite_cmd_raw(hdc, init);\n\tlong_sleep(10);\n\n\tif (hdc->ifwidth == 4) {\n\t\t \n\t\thdc->write_cmd_raw4(hdc, LCD_CMD_FUNCTION_SET >> 4);\n\t\tlong_sleep(10);\n\t}\n\n\t \n\thdc->write_cmd(hdc,\n\t\tLCD_CMD_FUNCTION_SET |\n\t\t((hdc->ifwidth == 8) ? LCD_CMD_DATA_LEN_8BITS : 0) |\n\t\t((hdc->hd44780_common_flags & LCD_FLAG_F) ?\n\t\t\tLCD_CMD_FONT_5X10_DOTS : 0) |\n\t\t((hdc->hd44780_common_flags & LCD_FLAG_N) ?\n\t\t\tLCD_CMD_TWO_LINES : 0));\n\tlong_sleep(10);\n\n\t \n\thdc->write_cmd(hdc, LCD_CMD_DISPLAY_CTRL);\n\tlong_sleep(10);\n\n\thdc->write_cmd(hdc,\n\t\tLCD_CMD_DISPLAY_CTRL |\t \n\t\t((hdc->hd44780_common_flags & LCD_FLAG_D) ?\n\t\t\tLCD_CMD_DISPLAY_ON : 0) |\n\t\t((hdc->hd44780_common_flags & LCD_FLAG_C) ?\n\t\t\tLCD_CMD_CURSOR_ON : 0) |\n\t\t((hdc->hd44780_common_flags & LCD_FLAG_B) ?\n\t\t\tLCD_CMD_BLINK_ON : 0));\n\n\tcharlcd_backlight(lcd,\n\t\t\t(hdc->hd44780_common_flags & LCD_FLAG_L) ? 1 : 0);\n\n\tlong_sleep(10);\n\n\t \n\thdc->write_cmd(hdc, LCD_CMD_ENTRY_MODE | LCD_CMD_CURSOR_INC);\n\n\thd44780_common_clear_display(lcd);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_init_display);\n\nint hd44780_common_shift_cursor(struct charlcd *lcd, enum charlcd_shift_dir dir)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\n\tif (dir == CHARLCD_SHIFT_LEFT) {\n\t\t \n\t\tif (lcd->addr.x < hdc->bwidth)\n\t\t\thdc->write_cmd(hdc, LCD_CMD_SHIFT);\n\t} else if (dir == CHARLCD_SHIFT_RIGHT) {\n\t\t \n\t\tif (lcd->addr.x < (hdc->bwidth - 1))\n\t\t\thdc->write_cmd(hdc,\n\t\t\t\t\tLCD_CMD_SHIFT | LCD_CMD_SHIFT_RIGHT);\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_shift_cursor);\n\nint hd44780_common_shift_display(struct charlcd *lcd,\n\t\tenum charlcd_shift_dir dir)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\n\tif (dir == CHARLCD_SHIFT_LEFT)\n\t\thdc->write_cmd(hdc, LCD_CMD_SHIFT | LCD_CMD_DISPLAY_SHIFT);\n\telse if (dir == CHARLCD_SHIFT_RIGHT)\n\t\thdc->write_cmd(hdc, LCD_CMD_SHIFT | LCD_CMD_DISPLAY_SHIFT |\n\t\t\tLCD_CMD_SHIFT_RIGHT);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_shift_display);\n\nstatic void hd44780_common_set_mode(struct hd44780_common *hdc)\n{\n\thdc->write_cmd(hdc,\n\t\tLCD_CMD_DISPLAY_CTRL |\n\t\t((hdc->hd44780_common_flags & LCD_FLAG_D) ?\n\t\t\tLCD_CMD_DISPLAY_ON : 0) |\n\t\t((hdc->hd44780_common_flags & LCD_FLAG_C) ?\n\t\t\tLCD_CMD_CURSOR_ON : 0) |\n\t\t((hdc->hd44780_common_flags & LCD_FLAG_B) ?\n\t\t\tLCD_CMD_BLINK_ON : 0));\n}\n\nint hd44780_common_display(struct charlcd *lcd, enum charlcd_onoff on)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\n\tif (on == CHARLCD_ON)\n\t\thdc->hd44780_common_flags |= LCD_FLAG_D;\n\telse\n\t\thdc->hd44780_common_flags &= ~LCD_FLAG_D;\n\n\thd44780_common_set_mode(hdc);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_display);\n\nint hd44780_common_cursor(struct charlcd *lcd, enum charlcd_onoff on)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\n\tif (on == CHARLCD_ON)\n\t\thdc->hd44780_common_flags |= LCD_FLAG_C;\n\telse\n\t\thdc->hd44780_common_flags &= ~LCD_FLAG_C;\n\n\thd44780_common_set_mode(hdc);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_cursor);\n\nint hd44780_common_blink(struct charlcd *lcd, enum charlcd_onoff on)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\n\tif (on == CHARLCD_ON)\n\t\thdc->hd44780_common_flags |= LCD_FLAG_B;\n\telse\n\t\thdc->hd44780_common_flags &= ~LCD_FLAG_B;\n\n\thd44780_common_set_mode(hdc);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_blink);\n\nstatic void hd44780_common_set_function(struct hd44780_common *hdc)\n{\n\thdc->write_cmd(hdc,\n\t\tLCD_CMD_FUNCTION_SET |\n\t\t((hdc->ifwidth == 8) ? LCD_CMD_DATA_LEN_8BITS : 0) |\n\t\t((hdc->hd44780_common_flags & LCD_FLAG_F) ?\n\t\t\tLCD_CMD_FONT_5X10_DOTS : 0) |\n\t\t((hdc->hd44780_common_flags & LCD_FLAG_N) ?\n\t\t\tLCD_CMD_TWO_LINES : 0));\n}\n\nint hd44780_common_fontsize(struct charlcd *lcd, enum charlcd_fontsize size)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\n\tif (size == CHARLCD_FONTSIZE_LARGE)\n\t\thdc->hd44780_common_flags |= LCD_FLAG_F;\n\telse\n\t\thdc->hd44780_common_flags &= ~LCD_FLAG_F;\n\n\thd44780_common_set_function(hdc);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_fontsize);\n\nint hd44780_common_lines(struct charlcd *lcd, enum charlcd_lines lines)\n{\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\n\tif (lines == CHARLCD_LINES_2)\n\t\thdc->hd44780_common_flags |= LCD_FLAG_N;\n\telse\n\t\thdc->hd44780_common_flags &= ~LCD_FLAG_N;\n\n\thd44780_common_set_function(hdc);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_lines);\n\nint hd44780_common_redefine_char(struct charlcd *lcd, char *esc)\n{\n\t \n\n\tstruct hd44780_common *hdc = lcd->drvdata;\n\tunsigned char cgbytes[8];\n\tunsigned char cgaddr;\n\tint cgoffset;\n\tint shift;\n\tchar value;\n\tint addr;\n\n\tif (!strchr(esc, ';'))\n\t\treturn 0;\n\n\tesc++;\n\n\tcgaddr = *(esc++) - '0';\n\tif (cgaddr > 7)\n\t\treturn 1;\n\n\tcgoffset = 0;\n\tshift = 0;\n\tvalue = 0;\n\twhile (*esc && cgoffset < 8) {\n\t\tint half;\n\n\t\tshift ^= 4;\n\t\thalf = hex_to_bin(*esc++);\n\t\tif (half < 0)\n\t\t\tcontinue;\n\n\t\tvalue |= half << shift;\n\t\tif (shift == 0) {\n\t\t\tcgbytes[cgoffset++] = value;\n\t\t\tvalue = 0;\n\t\t}\n\t}\n\n\thdc->write_cmd(hdc, LCD_CMD_SET_CGRAM_ADDR | (cgaddr * 8));\n\tfor (addr = 0; addr < cgoffset; addr++)\n\t\thdc->write_data(hdc, cgbytes[addr]);\n\n\t \n\tlcd->ops->gotoxy(lcd, lcd->addr.x, lcd->addr.y);\n\treturn 1;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_redefine_char);\n\nstruct hd44780_common *hd44780_common_alloc(void)\n{\n\tstruct hd44780_common *hd;\n\n\thd = kzalloc(sizeof(*hd), GFP_KERNEL);\n\tif (!hd)\n\t\treturn NULL;\n\n\thd->ifwidth = 8;\n\thd->bwidth = DEFAULT_LCD_BWIDTH;\n\thd->hwidth = DEFAULT_LCD_HWIDTH;\n\treturn hd;\n}\nEXPORT_SYMBOL_GPL(hd44780_common_alloc);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}