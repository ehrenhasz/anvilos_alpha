{
  "module_name": "sja1105_devlink.c",
  "hash_id": "cb18d5ebbb5314fe4cff51d070cec1ba56ee5e7b9ef9f19765d367472678baf6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/dsa/sja1105/sja1105_devlink.c",
  "human_readable_source": "\n \n#include \"sja1105.h\"\n\n \nstatic size_t sja1105_static_config_get_max_size(struct sja1105_private *priv)\n{\n\tstruct sja1105_static_config config;\n\tenum sja1105_blk_idx blk_idx;\n\tint rc;\n\n\trc = sja1105_static_config_init(&config,\n\t\t\t\t\tpriv->info->static_ops,\n\t\t\t\t\tpriv->info->device_id);\n\tif (rc)\n\t\treturn 0;\n\n\tfor (blk_idx = 0; blk_idx < BLK_IDX_MAX; blk_idx++) {\n\t\tstruct sja1105_table *table = &config.tables[blk_idx];\n\n\t\ttable->entry_count = table->ops->max_entry_count;\n\t}\n\n\treturn sja1105_static_config_get_length(&config);\n}\n\nstatic int\nsja1105_region_static_config_snapshot(struct devlink *dl,\n\t\t\t\t      const struct devlink_region_ops *ops,\n\t\t\t\t      struct netlink_ext_ack *extack,\n\t\t\t\t      u8 **data)\n{\n\tstruct dsa_switch *ds = dsa_devlink_to_ds(dl);\n\tstruct sja1105_private *priv = ds->priv;\n\tsize_t max_len, len;\n\n\tlen = sja1105_static_config_get_length(&priv->static_config);\n\tmax_len = sja1105_static_config_get_max_size(priv);\n\n\t*data = kcalloc(max_len, sizeof(u8), GFP_KERNEL);\n\tif (!*data)\n\t\treturn -ENOMEM;\n\n\treturn static_config_buf_prepare_for_upload(priv, *data, len);\n}\n\nstatic struct devlink_region_ops sja1105_region_static_config_ops = {\n\t.name = \"static-config\",\n\t.snapshot = sja1105_region_static_config_snapshot,\n\t.destructor = kfree,\n};\n\nenum sja1105_region_id {\n\tSJA1105_REGION_STATIC_CONFIG = 0,\n};\n\nstruct sja1105_region {\n\tconst struct devlink_region_ops *ops;\n\tsize_t (*get_size)(struct sja1105_private *priv);\n};\n\nstatic struct sja1105_region sja1105_regions[] = {\n\t[SJA1105_REGION_STATIC_CONFIG] = {\n\t\t.ops = &sja1105_region_static_config_ops,\n\t\t.get_size = sja1105_static_config_get_max_size,\n\t},\n};\n\nstatic int sja1105_setup_devlink_regions(struct dsa_switch *ds)\n{\n\tint i, num_regions = ARRAY_SIZE(sja1105_regions);\n\tstruct sja1105_private *priv = ds->priv;\n\tconst struct devlink_region_ops *ops;\n\tstruct devlink_region *region;\n\tu64 size;\n\n\tpriv->regions = kcalloc(num_regions, sizeof(struct devlink_region *),\n\t\t\t\tGFP_KERNEL);\n\tif (!priv->regions)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < num_regions; i++) {\n\t\tsize = sja1105_regions[i].get_size(priv);\n\t\tops = sja1105_regions[i].ops;\n\n\t\tregion = dsa_devlink_region_create(ds, ops, 1, size);\n\t\tif (IS_ERR(region)) {\n\t\t\twhile (--i >= 0)\n\t\t\t\tdsa_devlink_region_destroy(priv->regions[i]);\n\n\t\t\tkfree(priv->regions);\n\t\t\treturn PTR_ERR(region);\n\t\t}\n\n\t\tpriv->regions[i] = region;\n\t}\n\n\treturn 0;\n}\n\nstatic void sja1105_teardown_devlink_regions(struct dsa_switch *ds)\n{\n\tint i, num_regions = ARRAY_SIZE(sja1105_regions);\n\tstruct sja1105_private *priv = ds->priv;\n\n\tfor (i = 0; i < num_regions; i++)\n\t\tdsa_devlink_region_destroy(priv->regions[i]);\n\n\tkfree(priv->regions);\n}\n\nint sja1105_devlink_info_get(struct dsa_switch *ds,\n\t\t\t     struct devlink_info_req *req,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct sja1105_private *priv = ds->priv;\n\n\treturn devlink_info_version_fixed_put(req,\n\t\t\t\t\t      DEVLINK_INFO_VERSION_GENERIC_ASIC_ID,\n\t\t\t\t\t      priv->info->name);\n}\n\nint sja1105_devlink_setup(struct dsa_switch *ds)\n{\n\treturn sja1105_setup_devlink_regions(ds);\n}\n\nvoid sja1105_devlink_teardown(struct dsa_switch *ds)\n{\n\tsja1105_teardown_devlink_regions(ds);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}