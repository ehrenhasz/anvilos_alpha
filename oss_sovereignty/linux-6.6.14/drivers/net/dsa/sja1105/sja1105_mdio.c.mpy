{
  "module_name": "sja1105_mdio.c",
  "hash_id": "6fe69897ad3e2ead0e632bbc41df8c82d5079dc587b8ffb63a79c9560a49b43e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/dsa/sja1105/sja1105_mdio.c",
  "human_readable_source": "\n \n#include <linux/pcs/pcs-xpcs.h>\n#include <linux/of_mdio.h>\n#include \"sja1105.h\"\n\n#define SJA1110_PCS_BANK_REG\t\tSJA1110_SPI_ADDR(0x3fc)\n\nint sja1105_pcs_mdio_read_c45(struct mii_bus *bus, int phy, int mmd, int reg)\n{\n\tstruct sja1105_mdio_private *mdio_priv = bus->priv;\n\tstruct sja1105_private *priv = mdio_priv->priv;\n\tu64 addr;\n\tu32 tmp;\n\tint rc;\n\n\taddr = (mmd << 16) | reg;\n\n\tif (mmd != MDIO_MMD_VEND1 && mmd != MDIO_MMD_VEND2)\n\t\treturn 0xffff;\n\n\tif (mmd == MDIO_MMD_VEND2 && (reg & GENMASK(15, 0)) == MII_PHYSID1)\n\t\treturn NXP_SJA1105_XPCS_ID >> 16;\n\tif (mmd == MDIO_MMD_VEND2 && (reg & GENMASK(15, 0)) == MII_PHYSID2)\n\t\treturn NXP_SJA1105_XPCS_ID & GENMASK(15, 0);\n\n\trc = sja1105_xfer_u32(priv, SPI_READ, addr, &tmp, NULL);\n\tif (rc < 0)\n\t\treturn rc;\n\n\treturn tmp & 0xffff;\n}\n\nint sja1105_pcs_mdio_write_c45(struct mii_bus *bus, int phy, int mmd,\n\t\t\t       int reg, u16 val)\n{\n\tstruct sja1105_mdio_private *mdio_priv = bus->priv;\n\tstruct sja1105_private *priv = mdio_priv->priv;\n\tu64 addr;\n\tu32 tmp;\n\n\taddr = (mmd << 16) | reg;\n\ttmp = val;\n\n\tif (mmd != MDIO_MMD_VEND1 && mmd != MDIO_MMD_VEND2)\n\t\treturn -EINVAL;\n\n\treturn sja1105_xfer_u32(priv, SPI_WRITE, addr, &tmp, NULL);\n}\n\nint sja1110_pcs_mdio_read_c45(struct mii_bus *bus, int phy, int mmd, int reg)\n{\n\tstruct sja1105_mdio_private *mdio_priv = bus->priv;\n\tstruct sja1105_private *priv = mdio_priv->priv;\n\tconst struct sja1105_regs *regs = priv->info->regs;\n\tint offset, bank;\n\tu64 addr;\n\tu32 tmp;\n\tint rc;\n\n\tif (regs->pcs_base[phy] == SJA1105_RSV_ADDR)\n\t\treturn -ENODEV;\n\n\taddr = (mmd << 16) | reg;\n\n\tif (mmd == MDIO_MMD_VEND2 && (reg & GENMASK(15, 0)) == MII_PHYSID1)\n\t\treturn NXP_SJA1110_XPCS_ID >> 16;\n\tif (mmd == MDIO_MMD_VEND2 && (reg & GENMASK(15, 0)) == MII_PHYSID2)\n\t\treturn NXP_SJA1110_XPCS_ID & GENMASK(15, 0);\n\n\tbank = addr >> 8;\n\toffset = addr & GENMASK(7, 0);\n\n\t \n\tif (WARN_ON(offset == 0xff))\n\t\treturn -ENODEV;\n\n\ttmp = bank;\n\n\trc = sja1105_xfer_u32(priv, SPI_WRITE,\n\t\t\t      regs->pcs_base[phy] + SJA1110_PCS_BANK_REG,\n\t\t\t      &tmp, NULL);\n\tif (rc < 0)\n\t\treturn rc;\n\n\trc = sja1105_xfer_u32(priv, SPI_READ, regs->pcs_base[phy] + offset,\n\t\t\t      &tmp, NULL);\n\tif (rc < 0)\n\t\treturn rc;\n\n\treturn tmp & 0xffff;\n}\n\nint sja1110_pcs_mdio_write_c45(struct mii_bus *bus, int phy, int reg, int mmd,\n\t\t\t       u16 val)\n{\n\tstruct sja1105_mdio_private *mdio_priv = bus->priv;\n\tstruct sja1105_private *priv = mdio_priv->priv;\n\tconst struct sja1105_regs *regs = priv->info->regs;\n\tint offset, bank;\n\tu64 addr;\n\tu32 tmp;\n\tint rc;\n\n\tif (regs->pcs_base[phy] == SJA1105_RSV_ADDR)\n\t\treturn -ENODEV;\n\n\taddr = (mmd << 16) | reg;\n\n\tbank = addr >> 8;\n\toffset = addr & GENMASK(7, 0);\n\n\t \n\tif (WARN_ON(offset == 0xff))\n\t\treturn -ENODEV;\n\n\ttmp = bank;\n\n\trc = sja1105_xfer_u32(priv, SPI_WRITE,\n\t\t\t      regs->pcs_base[phy] + SJA1110_PCS_BANK_REG,\n\t\t\t      &tmp, NULL);\n\tif (rc < 0)\n\t\treturn rc;\n\n\ttmp = val;\n\n\treturn sja1105_xfer_u32(priv, SPI_WRITE, regs->pcs_base[phy] + offset,\n\t\t\t\t&tmp, NULL);\n}\n\nenum sja1105_mdio_opcode {\n\tSJA1105_C45_ADDR = 0,\n\tSJA1105_C22 = 1,\n\tSJA1105_C45_DATA = 2,\n\tSJA1105_C45_DATA_AUTOINC = 3,\n};\n\nstatic u64 sja1105_base_t1_encode_addr(struct sja1105_private *priv,\n\t\t\t\t       int phy, enum sja1105_mdio_opcode op,\n\t\t\t\t       int xad)\n{\n\tconst struct sja1105_regs *regs = priv->info->regs;\n\n\treturn regs->mdio_100base_t1 | (phy << 7) | (op << 5) | (xad << 0);\n}\n\nstatic int sja1105_base_t1_mdio_read_c22(struct mii_bus *bus, int phy, int reg)\n{\n\tstruct sja1105_mdio_private *mdio_priv = bus->priv;\n\tstruct sja1105_private *priv = mdio_priv->priv;\n\tu64 addr;\n\tu32 tmp;\n\tint rc;\n\n\taddr = sja1105_base_t1_encode_addr(priv, phy, SJA1105_C22, reg & 0x1f);\n\n\trc = sja1105_xfer_u32(priv, SPI_READ, addr, &tmp, NULL);\n\tif (rc < 0)\n\t\treturn rc;\n\n\treturn tmp & 0xffff;\n}\n\nstatic int sja1105_base_t1_mdio_read_c45(struct mii_bus *bus, int phy,\n\t\t\t\t\t int mmd, int reg)\n{\n\tstruct sja1105_mdio_private *mdio_priv = bus->priv;\n\tstruct sja1105_private *priv = mdio_priv->priv;\n\tu64 addr;\n\tu32 tmp;\n\tint rc;\n\n\taddr = sja1105_base_t1_encode_addr(priv, phy, SJA1105_C45_ADDR, mmd);\n\n\trc = sja1105_xfer_u32(priv, SPI_WRITE, addr, &reg, NULL);\n\tif (rc < 0)\n\t\treturn rc;\n\n\taddr = sja1105_base_t1_encode_addr(priv, phy, SJA1105_C45_DATA, mmd);\n\n\trc = sja1105_xfer_u32(priv, SPI_READ, addr, &tmp, NULL);\n\tif (rc < 0)\n\t\treturn rc;\n\n\treturn tmp & 0xffff;\n}\n\nstatic int sja1105_base_t1_mdio_write_c22(struct mii_bus *bus, int phy, int reg,\n\t\t\t\t\t  u16 val)\n{\n\tstruct sja1105_mdio_private *mdio_priv = bus->priv;\n\tstruct sja1105_private *priv = mdio_priv->priv;\n\tu64 addr;\n\tu32 tmp;\n\n\taddr = sja1105_base_t1_encode_addr(priv, phy, SJA1105_C22, reg & 0x1f);\n\n\ttmp = val & 0xffff;\n\n\treturn sja1105_xfer_u32(priv, SPI_WRITE, addr, &tmp, NULL);\n}\n\nstatic int sja1105_base_t1_mdio_write_c45(struct mii_bus *bus, int phy,\n\t\t\t\t\t  int mmd, int reg, u16 val)\n{\n\tstruct sja1105_mdio_private *mdio_priv = bus->priv;\n\tstruct sja1105_private *priv = mdio_priv->priv;\n\tu64 addr;\n\tu32 tmp;\n\tint rc;\n\n\taddr = sja1105_base_t1_encode_addr(priv, phy, SJA1105_C45_ADDR, mmd);\n\n\trc = sja1105_xfer_u32(priv, SPI_WRITE, addr, &reg, NULL);\n\tif (rc < 0)\n\t\treturn rc;\n\n\taddr = sja1105_base_t1_encode_addr(priv, phy, SJA1105_C45_DATA, mmd);\n\n\ttmp = val & 0xffff;\n\n\treturn sja1105_xfer_u32(priv, SPI_WRITE, addr, &tmp, NULL);\n}\n\nstatic int sja1105_base_tx_mdio_read(struct mii_bus *bus, int phy, int reg)\n{\n\tstruct sja1105_mdio_private *mdio_priv = bus->priv;\n\tstruct sja1105_private *priv = mdio_priv->priv;\n\tconst struct sja1105_regs *regs = priv->info->regs;\n\tu32 tmp;\n\tint rc;\n\n\trc = sja1105_xfer_u32(priv, SPI_READ, regs->mdio_100base_tx + reg,\n\t\t\t      &tmp, NULL);\n\tif (rc < 0)\n\t\treturn rc;\n\n\treturn tmp & 0xffff;\n}\n\nstatic int sja1105_base_tx_mdio_write(struct mii_bus *bus, int phy, int reg,\n\t\t\t\t      u16 val)\n{\n\tstruct sja1105_mdio_private *mdio_priv = bus->priv;\n\tstruct sja1105_private *priv = mdio_priv->priv;\n\tconst struct sja1105_regs *regs = priv->info->regs;\n\tu32 tmp = val;\n\n\treturn sja1105_xfer_u32(priv, SPI_WRITE, regs->mdio_100base_tx + reg,\n\t\t\t\t&tmp, NULL);\n}\n\nstatic int sja1105_mdiobus_base_tx_register(struct sja1105_private *priv,\n\t\t\t\t\t    struct device_node *mdio_node)\n{\n\tstruct sja1105_mdio_private *mdio_priv;\n\tstruct device_node *np;\n\tstruct mii_bus *bus;\n\tint rc = 0;\n\n\tnp = of_get_compatible_child(mdio_node, \"nxp,sja1110-base-tx-mdio\");\n\tif (!np)\n\t\treturn 0;\n\n\tif (!of_device_is_available(np))\n\t\tgoto out_put_np;\n\n\tbus = mdiobus_alloc_size(sizeof(*mdio_priv));\n\tif (!bus) {\n\t\trc = -ENOMEM;\n\t\tgoto out_put_np;\n\t}\n\n\tbus->name = \"SJA1110 100base-TX MDIO bus\";\n\tsnprintf(bus->id, MII_BUS_ID_SIZE, \"%s-base-tx\",\n\t\t dev_name(priv->ds->dev));\n\tbus->read = sja1105_base_tx_mdio_read;\n\tbus->write = sja1105_base_tx_mdio_write;\n\tbus->parent = priv->ds->dev;\n\tmdio_priv = bus->priv;\n\tmdio_priv->priv = priv;\n\n\trc = of_mdiobus_register(bus, np);\n\tif (rc) {\n\t\tmdiobus_free(bus);\n\t\tgoto out_put_np;\n\t}\n\n\tpriv->mdio_base_tx = bus;\n\nout_put_np:\n\tof_node_put(np);\n\n\treturn rc;\n}\n\nstatic void sja1105_mdiobus_base_tx_unregister(struct sja1105_private *priv)\n{\n\tif (!priv->mdio_base_tx)\n\t\treturn;\n\n\tmdiobus_unregister(priv->mdio_base_tx);\n\tmdiobus_free(priv->mdio_base_tx);\n\tpriv->mdio_base_tx = NULL;\n}\n\nstatic int sja1105_mdiobus_base_t1_register(struct sja1105_private *priv,\n\t\t\t\t\t    struct device_node *mdio_node)\n{\n\tstruct sja1105_mdio_private *mdio_priv;\n\tstruct device_node *np;\n\tstruct mii_bus *bus;\n\tint rc = 0;\n\n\tnp = of_get_compatible_child(mdio_node, \"nxp,sja1110-base-t1-mdio\");\n\tif (!np)\n\t\treturn 0;\n\n\tif (!of_device_is_available(np))\n\t\tgoto out_put_np;\n\n\tbus = mdiobus_alloc_size(sizeof(*mdio_priv));\n\tif (!bus) {\n\t\trc = -ENOMEM;\n\t\tgoto out_put_np;\n\t}\n\n\tbus->name = \"SJA1110 100base-T1 MDIO bus\";\n\tsnprintf(bus->id, MII_BUS_ID_SIZE, \"%s-base-t1\",\n\t\t dev_name(priv->ds->dev));\n\tbus->read = sja1105_base_t1_mdio_read_c22;\n\tbus->write = sja1105_base_t1_mdio_write_c22;\n\tbus->read_c45 = sja1105_base_t1_mdio_read_c45;\n\tbus->write_c45 = sja1105_base_t1_mdio_write_c45;\n\tbus->parent = priv->ds->dev;\n\tmdio_priv = bus->priv;\n\tmdio_priv->priv = priv;\n\n\trc = of_mdiobus_register(bus, np);\n\tif (rc) {\n\t\tmdiobus_free(bus);\n\t\tgoto out_put_np;\n\t}\n\n\tpriv->mdio_base_t1 = bus;\n\nout_put_np:\n\tof_node_put(np);\n\n\treturn rc;\n}\n\nstatic void sja1105_mdiobus_base_t1_unregister(struct sja1105_private *priv)\n{\n\tif (!priv->mdio_base_t1)\n\t\treturn;\n\n\tmdiobus_unregister(priv->mdio_base_t1);\n\tmdiobus_free(priv->mdio_base_t1);\n\tpriv->mdio_base_t1 = NULL;\n}\n\nstatic int sja1105_mdiobus_pcs_register(struct sja1105_private *priv)\n{\n\tstruct sja1105_mdio_private *mdio_priv;\n\tstruct dsa_switch *ds = priv->ds;\n\tstruct mii_bus *bus;\n\tint rc = 0;\n\tint port;\n\n\tif (!priv->info->pcs_mdio_read_c45 || !priv->info->pcs_mdio_write_c45)\n\t\treturn 0;\n\n\tbus = mdiobus_alloc_size(sizeof(*mdio_priv));\n\tif (!bus)\n\t\treturn -ENOMEM;\n\n\tbus->name = \"SJA1105 PCS MDIO bus\";\n\tsnprintf(bus->id, MII_BUS_ID_SIZE, \"%s-pcs\",\n\t\t dev_name(ds->dev));\n\tbus->read_c45 = priv->info->pcs_mdio_read_c45;\n\tbus->write_c45 = priv->info->pcs_mdio_write_c45;\n\tbus->parent = ds->dev;\n\t \n\tbus->phy_mask = ~0;\n\tmdio_priv = bus->priv;\n\tmdio_priv->priv = priv;\n\n\trc = mdiobus_register(bus);\n\tif (rc) {\n\t\tmdiobus_free(bus);\n\t\treturn rc;\n\t}\n\n\tfor (port = 0; port < ds->num_ports; port++) {\n\t\tstruct dw_xpcs *xpcs;\n\n\t\tif (dsa_is_unused_port(ds, port))\n\t\t\tcontinue;\n\n\t\tif (priv->phy_mode[port] != PHY_INTERFACE_MODE_SGMII &&\n\t\t    priv->phy_mode[port] != PHY_INTERFACE_MODE_2500BASEX)\n\t\t\tcontinue;\n\n\t\txpcs = xpcs_create_mdiodev(bus, port, priv->phy_mode[port]);\n\t\tif (IS_ERR(xpcs)) {\n\t\t\trc = PTR_ERR(xpcs);\n\t\t\tgoto out_pcs_free;\n\t\t}\n\n\t\tpriv->xpcs[port] = xpcs;\n\t}\n\n\tpriv->mdio_pcs = bus;\n\n\treturn 0;\n\nout_pcs_free:\n\tfor (port = 0; port < ds->num_ports; port++) {\n\t\tif (!priv->xpcs[port])\n\t\t\tcontinue;\n\n\t\txpcs_destroy(priv->xpcs[port]);\n\t\tpriv->xpcs[port] = NULL;\n\t}\n\n\tmdiobus_unregister(bus);\n\tmdiobus_free(bus);\n\n\treturn rc;\n}\n\nstatic void sja1105_mdiobus_pcs_unregister(struct sja1105_private *priv)\n{\n\tstruct dsa_switch *ds = priv->ds;\n\tint port;\n\n\tif (!priv->mdio_pcs)\n\t\treturn;\n\n\tfor (port = 0; port < ds->num_ports; port++) {\n\t\tif (!priv->xpcs[port])\n\t\t\tcontinue;\n\n\t\txpcs_destroy(priv->xpcs[port]);\n\t\tpriv->xpcs[port] = NULL;\n\t}\n\n\tmdiobus_unregister(priv->mdio_pcs);\n\tmdiobus_free(priv->mdio_pcs);\n\tpriv->mdio_pcs = NULL;\n}\n\nint sja1105_mdiobus_register(struct dsa_switch *ds)\n{\n\tstruct sja1105_private *priv = ds->priv;\n\tconst struct sja1105_regs *regs = priv->info->regs;\n\tstruct device_node *switch_node = ds->dev->of_node;\n\tstruct device_node *mdio_node;\n\tint rc;\n\n\trc = sja1105_mdiobus_pcs_register(priv);\n\tif (rc)\n\t\treturn rc;\n\n\tmdio_node = of_get_child_by_name(switch_node, \"mdios\");\n\tif (!mdio_node)\n\t\treturn 0;\n\n\tif (!of_device_is_available(mdio_node))\n\t\tgoto out_put_mdio_node;\n\n\tif (regs->mdio_100base_tx != SJA1105_RSV_ADDR) {\n\t\trc = sja1105_mdiobus_base_tx_register(priv, mdio_node);\n\t\tif (rc)\n\t\t\tgoto err_put_mdio_node;\n\t}\n\n\tif (regs->mdio_100base_t1 != SJA1105_RSV_ADDR) {\n\t\trc = sja1105_mdiobus_base_t1_register(priv, mdio_node);\n\t\tif (rc)\n\t\t\tgoto err_free_base_tx_mdiobus;\n\t}\n\nout_put_mdio_node:\n\tof_node_put(mdio_node);\n\n\treturn 0;\n\nerr_free_base_tx_mdiobus:\n\tsja1105_mdiobus_base_tx_unregister(priv);\nerr_put_mdio_node:\n\tof_node_put(mdio_node);\n\tsja1105_mdiobus_pcs_unregister(priv);\n\n\treturn rc;\n}\n\nvoid sja1105_mdiobus_unregister(struct dsa_switch *ds)\n{\n\tstruct sja1105_private *priv = ds->priv;\n\n\tsja1105_mdiobus_base_t1_unregister(priv);\n\tsja1105_mdiobus_base_tx_unregister(priv);\n\tsja1105_mdiobus_pcs_unregister(priv);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}