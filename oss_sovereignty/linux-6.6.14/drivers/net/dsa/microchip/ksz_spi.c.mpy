{
  "module_name": "ksz_spi.c",
  "hash_id": "9929cb62613695bf13f0007754c3d4b0882cdc4efb29e9588f6ec3256809a697",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/dsa/microchip/ksz_spi.c",
  "human_readable_source": "\n \n\n#include <asm/unaligned.h>\n\n#include <linux/delay.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/regmap.h>\n#include <linux/spi/spi.h>\n\n#include \"ksz_common.h\"\n\n#define KSZ8795_SPI_ADDR_SHIFT\t\t\t12\n#define KSZ8795_SPI_ADDR_ALIGN\t\t\t3\n#define KSZ8795_SPI_TURNAROUND_SHIFT\t\t1\n\n#define KSZ8863_SPI_ADDR_SHIFT\t\t\t8\n#define KSZ8863_SPI_ADDR_ALIGN\t\t\t8\n#define KSZ8863_SPI_TURNAROUND_SHIFT\t\t0\n\n#define KSZ9477_SPI_ADDR_SHIFT\t\t\t24\n#define KSZ9477_SPI_ADDR_ALIGN\t\t\t3\n#define KSZ9477_SPI_TURNAROUND_SHIFT\t\t5\n\nKSZ_REGMAP_TABLE(ksz8795, 16, KSZ8795_SPI_ADDR_SHIFT,\n\t\t KSZ8795_SPI_TURNAROUND_SHIFT, KSZ8795_SPI_ADDR_ALIGN);\n\nKSZ_REGMAP_TABLE(ksz8863, 16, KSZ8863_SPI_ADDR_SHIFT,\n\t\t KSZ8863_SPI_TURNAROUND_SHIFT, KSZ8863_SPI_ADDR_ALIGN);\n\nKSZ_REGMAP_TABLE(ksz9477, 32, KSZ9477_SPI_ADDR_SHIFT,\n\t\t KSZ9477_SPI_TURNAROUND_SHIFT, KSZ9477_SPI_ADDR_ALIGN);\n\nstatic int ksz_spi_probe(struct spi_device *spi)\n{\n\tconst struct regmap_config *regmap_config;\n\tconst struct ksz_chip_data *chip;\n\tstruct device *ddev = &spi->dev;\n\tstruct regmap_config rc;\n\tstruct ksz_device *dev;\n\tint i, ret = 0;\n\n\tdev = ksz_switch_alloc(&spi->dev, spi);\n\tif (!dev)\n\t\treturn -ENOMEM;\n\n\tchip = device_get_match_data(ddev);\n\tif (!chip)\n\t\treturn -EINVAL;\n\n\tif (chip->chip_id == KSZ8830_CHIP_ID)\n\t\tregmap_config = ksz8863_regmap_config;\n\telse if (chip->chip_id == KSZ8795_CHIP_ID ||\n\t\t chip->chip_id == KSZ8794_CHIP_ID ||\n\t\t chip->chip_id == KSZ8765_CHIP_ID)\n\t\tregmap_config = ksz8795_regmap_config;\n\telse\n\t\tregmap_config = ksz9477_regmap_config;\n\n\tfor (i = 0; i < __KSZ_NUM_REGMAPS; i++) {\n\t\trc = regmap_config[i];\n\t\trc.lock_arg = &dev->regmap_mutex;\n\t\trc.wr_table = chip->wr_table;\n\t\trc.rd_table = chip->rd_table;\n\t\tdev->regmap[i] = devm_regmap_init_spi(spi, &rc);\n\n\t\tif (IS_ERR(dev->regmap[i])) {\n\t\t\treturn dev_err_probe(&spi->dev, PTR_ERR(dev->regmap[i]),\n\t\t\t\t\t     \"Failed to initialize regmap%i\\n\",\n\t\t\t\t\t     regmap_config[i].val_bits);\n\t\t}\n\t}\n\n\tif (spi->dev.platform_data)\n\t\tdev->pdata = spi->dev.platform_data;\n\n\t \n\tspi->mode = SPI_MODE_3;\n\tret = spi_setup(spi);\n\tif (ret)\n\t\treturn ret;\n\n\tdev->irq = spi->irq;\n\n\tret = ksz_switch_register(dev);\n\n\t \n\tif (ret)\n\t\treturn ret;\n\n\tspi_set_drvdata(spi, dev);\n\n\treturn 0;\n}\n\nstatic void ksz_spi_remove(struct spi_device *spi)\n{\n\tstruct ksz_device *dev = spi_get_drvdata(spi);\n\n\tif (dev)\n\t\tksz_switch_remove(dev);\n}\n\nstatic void ksz_spi_shutdown(struct spi_device *spi)\n{\n\tstruct ksz_device *dev = spi_get_drvdata(spi);\n\n\tif (!dev)\n\t\treturn;\n\n\tif (dev->dev_ops->reset)\n\t\tdev->dev_ops->reset(dev);\n\n\tdsa_switch_shutdown(dev->ds);\n\n\tspi_set_drvdata(spi, NULL);\n}\n\nstatic const struct of_device_id ksz_dt_ids[] = {\n\t{\n\t\t.compatible = \"microchip,ksz8765\",\n\t\t.data = &ksz_switch_chips[KSZ8765]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz8794\",\n\t\t.data = &ksz_switch_chips[KSZ8794]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz8795\",\n\t\t.data = &ksz_switch_chips[KSZ8795]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz8863\",\n\t\t.data = &ksz_switch_chips[KSZ8830]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz8873\",\n\t\t.data = &ksz_switch_chips[KSZ8830]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz9477\",\n\t\t.data = &ksz_switch_chips[KSZ9477]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz9896\",\n\t\t.data = &ksz_switch_chips[KSZ9896]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz9897\",\n\t\t.data = &ksz_switch_chips[KSZ9897]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz9893\",\n\t\t.data = &ksz_switch_chips[KSZ9893]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz9563\",\n\t\t.data = &ksz_switch_chips[KSZ9563]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz8563\",\n\t\t.data = &ksz_switch_chips[KSZ8563]\n\t},\n\t{\n\t\t.compatible = \"microchip,ksz9567\",\n\t\t.data = &ksz_switch_chips[KSZ9567]\n\t},\n\t{\n\t\t.compatible = \"microchip,lan9370\",\n\t\t.data = &ksz_switch_chips[LAN9370]\n\t},\n\t{\n\t\t.compatible = \"microchip,lan9371\",\n\t\t.data = &ksz_switch_chips[LAN9371]\n\t},\n\t{\n\t\t.compatible = \"microchip,lan9372\",\n\t\t.data = &ksz_switch_chips[LAN9372]\n\t},\n\t{\n\t\t.compatible = \"microchip,lan9373\",\n\t\t.data = &ksz_switch_chips[LAN9373]\n\t},\n\t{\n\t\t.compatible = \"microchip,lan9374\",\n\t\t.data = &ksz_switch_chips[LAN9374]\n\t},\n\t{},\n};\nMODULE_DEVICE_TABLE(of, ksz_dt_ids);\n\nstatic const struct spi_device_id ksz_spi_ids[] = {\n\t{ \"ksz8765\" },\n\t{ \"ksz8794\" },\n\t{ \"ksz8795\" },\n\t{ \"ksz8863\" },\n\t{ \"ksz8873\" },\n\t{ \"ksz9477\" },\n\t{ \"ksz9896\" },\n\t{ \"ksz9897\" },\n\t{ \"ksz9893\" },\n\t{ \"ksz9563\" },\n\t{ \"ksz8563\" },\n\t{ \"ksz9567\" },\n\t{ \"lan9370\" },\n\t{ \"lan9371\" },\n\t{ \"lan9372\" },\n\t{ \"lan9373\" },\n\t{ \"lan9374\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(spi, ksz_spi_ids);\n\nstatic struct spi_driver ksz_spi_driver = {\n\t.driver = {\n\t\t.name\t= \"ksz-switch\",\n\t\t.owner\t= THIS_MODULE,\n\t\t.of_match_table = ksz_dt_ids,\n\t},\n\t.id_table = ksz_spi_ids,\n\t.probe\t= ksz_spi_probe,\n\t.remove\t= ksz_spi_remove,\n\t.shutdown = ksz_spi_shutdown,\n};\n\nmodule_spi_driver(ksz_spi_driver);\n\nMODULE_ALIAS(\"spi:ksz9477\");\nMODULE_ALIAS(\"spi:ksz9896\");\nMODULE_ALIAS(\"spi:ksz9897\");\nMODULE_ALIAS(\"spi:ksz9893\");\nMODULE_ALIAS(\"spi:ksz9563\");\nMODULE_ALIAS(\"spi:ksz8563\");\nMODULE_ALIAS(\"spi:ksz9567\");\nMODULE_ALIAS(\"spi:lan937x\");\nMODULE_AUTHOR(\"Tristram Ha <Tristram.Ha@microchip.com>\");\nMODULE_DESCRIPTION(\"Microchip ksz Series Switch SPI Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}