{
  "module_name": "vitesse-vsc73xx-platform.c",
  "hash_id": "f5434f7b86df4e82f26a1686be9f8ba60f298dcaa85879c0f9e872ea75910dd3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/dsa/vitesse-vsc73xx-platform.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n\n#include \"vitesse-vsc73xx.h\"\n\n#define VSC73XX_CMD_PLATFORM_BLOCK_SHIFT\t\t14\n#define VSC73XX_CMD_PLATFORM_BLOCK_MASK\t\t\t0x7\n#define VSC73XX_CMD_PLATFORM_SUBBLOCK_SHIFT\t\t10\n#define VSC73XX_CMD_PLATFORM_SUBBLOCK_MASK\t\t0xf\n#define VSC73XX_CMD_PLATFORM_REGISTER_SHIFT\t\t2\n\n \nstruct vsc73xx_platform {\n\tstruct platform_device\t*pdev;\n\tvoid __iomem\t\t*base_addr;\n\tstruct vsc73xx\t\tvsc;\n};\n\nstatic const struct vsc73xx_ops vsc73xx_platform_ops;\n\nstatic u32 vsc73xx_make_addr(u8 block, u8 subblock, u8 reg)\n{\n\tu32 ret;\n\n\tret = (block & VSC73XX_CMD_PLATFORM_BLOCK_MASK)\n\t    << VSC73XX_CMD_PLATFORM_BLOCK_SHIFT;\n\tret |= (subblock & VSC73XX_CMD_PLATFORM_SUBBLOCK_MASK)\n\t    << VSC73XX_CMD_PLATFORM_SUBBLOCK_SHIFT;\n\tret |= reg << VSC73XX_CMD_PLATFORM_REGISTER_SHIFT;\n\n\treturn ret;\n}\n\nstatic int vsc73xx_platform_read(struct vsc73xx *vsc, u8 block, u8 subblock,\n\t\t\t\t u8 reg, u32 *val)\n{\n\tstruct vsc73xx_platform *vsc_platform = vsc->priv;\n\tu32 offset;\n\n\tif (!vsc73xx_is_addr_valid(block, subblock))\n\t\treturn -EINVAL;\n\n\toffset = vsc73xx_make_addr(block, subblock, reg);\n\t \n\t*val = ioread32be(vsc_platform->base_addr + offset);\n\n\treturn 0;\n}\n\nstatic int vsc73xx_platform_write(struct vsc73xx *vsc, u8 block, u8 subblock,\n\t\t\t\t  u8 reg, u32 val)\n{\n\tstruct vsc73xx_platform *vsc_platform = vsc->priv;\n\tu32 offset;\n\n\tif (!vsc73xx_is_addr_valid(block, subblock))\n\t\treturn -EINVAL;\n\n\toffset = vsc73xx_make_addr(block, subblock, reg);\n\tiowrite32be(val, vsc_platform->base_addr + offset);\n\n\treturn 0;\n}\n\nstatic int vsc73xx_platform_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct vsc73xx_platform *vsc_platform;\n\tint ret;\n\n\tvsc_platform = devm_kzalloc(dev, sizeof(*vsc_platform), GFP_KERNEL);\n\tif (!vsc_platform)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, vsc_platform);\n\tvsc_platform->pdev = pdev;\n\tvsc_platform->vsc.dev = dev;\n\tvsc_platform->vsc.priv = vsc_platform;\n\tvsc_platform->vsc.ops = &vsc73xx_platform_ops;\n\n\t \n\tvsc_platform->base_addr = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(vsc_platform->base_addr)) {\n\t\tdev_err(&pdev->dev, \"cannot request I/O memory space\\n\");\n\t\tret = -ENXIO;\n\t\treturn ret;\n\t}\n\n\treturn vsc73xx_probe(&vsc_platform->vsc);\n}\n\nstatic int vsc73xx_platform_remove(struct platform_device *pdev)\n{\n\tstruct vsc73xx_platform *vsc_platform = platform_get_drvdata(pdev);\n\n\tif (!vsc_platform)\n\t\treturn 0;\n\n\tvsc73xx_remove(&vsc_platform->vsc);\n\n\treturn 0;\n}\n\nstatic void vsc73xx_platform_shutdown(struct platform_device *pdev)\n{\n\tstruct vsc73xx_platform *vsc_platform = platform_get_drvdata(pdev);\n\n\tif (!vsc_platform)\n\t\treturn;\n\n\tvsc73xx_shutdown(&vsc_platform->vsc);\n\n\tplatform_set_drvdata(pdev, NULL);\n}\n\nstatic const struct vsc73xx_ops vsc73xx_platform_ops = {\n\t.read = vsc73xx_platform_read,\n\t.write = vsc73xx_platform_write,\n};\n\nstatic const struct of_device_id vsc73xx_of_match[] = {\n\t{\n\t\t.compatible = \"vitesse,vsc7385\",\n\t},\n\t{\n\t\t.compatible = \"vitesse,vsc7388\",\n\t},\n\t{\n\t\t.compatible = \"vitesse,vsc7395\",\n\t},\n\t{\n\t\t.compatible = \"vitesse,vsc7398\",\n\t},\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, vsc73xx_of_match);\n\nstatic struct platform_driver vsc73xx_platform_driver = {\n\t.probe = vsc73xx_platform_probe,\n\t.remove = vsc73xx_platform_remove,\n\t.shutdown = vsc73xx_platform_shutdown,\n\t.driver = {\n\t\t.name = \"vsc73xx-platform\",\n\t\t.of_match_table = vsc73xx_of_match,\n\t},\n};\nmodule_platform_driver(vsc73xx_platform_driver);\n\nMODULE_AUTHOR(\"Pawel Dembicki <paweldembicki@gmail.com>\");\nMODULE_DESCRIPTION(\"Vitesse VSC7385/7388/7395/7398 Platform driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}