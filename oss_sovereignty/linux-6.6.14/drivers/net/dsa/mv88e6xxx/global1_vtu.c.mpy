{
  "module_name": "global1_vtu.c",
  "hash_id": "4b4dbd74332a327f7800d8d8215463e80357a0731c39f1ddcbaf262ae32effaf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/dsa/mv88e6xxx/global1_vtu.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/interrupt.h>\n#include <linux/irqdomain.h>\n\n#include \"chip.h\"\n#include \"global1.h\"\n#include \"trace.h\"\n\n \n\nstatic int mv88e6xxx_g1_vtu_fid_read(struct mv88e6xxx_chip *chip,\n\t\t\t\t     struct mv88e6xxx_vtu_entry *entry)\n{\n\tu16 val;\n\tint err;\n\n\terr = mv88e6xxx_g1_read(chip, MV88E6352_G1_VTU_FID, &val);\n\tif (err)\n\t\treturn err;\n\n\tentry->fid = val & MV88E6352_G1_VTU_FID_MASK;\n\tentry->policy = !!(val & MV88E6352_G1_VTU_FID_VID_POLICY);\n\treturn 0;\n}\n\nstatic int mv88e6xxx_g1_vtu_fid_write(struct mv88e6xxx_chip *chip,\n\t\t\t\t      struct mv88e6xxx_vtu_entry *entry)\n{\n\tu16 val = entry->fid & MV88E6352_G1_VTU_FID_MASK;\n\n\tif (entry->policy)\n\t\tval |= MV88E6352_G1_VTU_FID_VID_POLICY;\n\n\treturn mv88e6xxx_g1_write(chip, MV88E6352_G1_VTU_FID, val);\n}\n\n \n\nstatic int mv88e6xxx_g1_vtu_sid_read(struct mv88e6xxx_chip *chip, u8 *sid)\n{\n\tu16 val;\n\tint err;\n\n\terr = mv88e6xxx_g1_read(chip, MV88E6352_G1_VTU_SID, &val);\n\tif (err)\n\t\treturn err;\n\n\t*sid = val & MV88E6352_G1_VTU_SID_MASK;\n\n\treturn 0;\n}\n\nstatic int mv88e6xxx_g1_vtu_sid_write(struct mv88e6xxx_chip *chip, u8 sid)\n{\n\tu16 val = sid & MV88E6352_G1_VTU_SID_MASK;\n\n\treturn mv88e6xxx_g1_write(chip, MV88E6352_G1_VTU_SID, val);\n}\n\n \n\nstatic int mv88e6xxx_g1_vtu_op_wait(struct mv88e6xxx_chip *chip)\n{\n\tint bit = __bf_shf(MV88E6XXX_G1_VTU_OP_BUSY);\n\n\treturn mv88e6xxx_g1_wait_bit(chip, MV88E6XXX_G1_VTU_OP, bit, 0);\n}\n\nstatic int mv88e6xxx_g1_vtu_op(struct mv88e6xxx_chip *chip, u16 op)\n{\n\tint err;\n\n\terr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_VTU_OP,\n\t\t\t\t MV88E6XXX_G1_VTU_OP_BUSY | op);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g1_vtu_op_wait(chip);\n}\n\n \n\nstatic int mv88e6xxx_g1_vtu_vid_read(struct mv88e6xxx_chip *chip,\n\t\t\t\t     bool *valid, u16 *vid)\n{\n\tu16 val;\n\tint err;\n\n\terr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_VTU_VID, &val);\n\tif (err)\n\t\treturn err;\n\n\tif (vid) {\n\t\t*vid = val & 0xfff;\n\n\t\tif (val & MV88E6390_G1_VTU_VID_PAGE)\n\t\t\t*vid |= 0x1000;\n\t}\n\n\tif (valid)\n\t\t*valid = !!(val & MV88E6XXX_G1_VTU_VID_VALID);\n\n\treturn 0;\n}\n\nstatic int mv88e6xxx_g1_vtu_vid_write(struct mv88e6xxx_chip *chip,\n\t\t\t\t      bool valid, u16 vid)\n{\n\tu16 val = vid & 0xfff;\n\n\tif (vid & 0x1000)\n\t\tval |= MV88E6390_G1_VTU_VID_PAGE;\n\n\tif (valid)\n\t\tval |= MV88E6XXX_G1_VTU_VID_VALID;\n\n\treturn mv88e6xxx_g1_write(chip, MV88E6XXX_G1_VTU_VID, val);\n}\n\n \nstatic int mv88e6185_g1_vtu_stu_data_read(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t  u16 *regs)\n{\n\tint i;\n\n\t \n\tfor (i = 0; i < 3; ++i) {\n\t\tu16 *reg = &regs[i];\n\t\tint err;\n\n\t\terr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_VTU_DATA1 + i, reg);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int mv88e6185_g1_vtu_data_read(struct mv88e6xxx_chip *chip,\n\t\t\t\t      u8 *member, u8 *state)\n{\n\tu16 regs[3];\n\tint err;\n\tint i;\n\n\terr = mv88e6185_g1_vtu_stu_data_read(chip, regs);\n\tif (err)\n\t\treturn err;\n\n\t \n\tfor (i = 0; i < mv88e6xxx_num_ports(chip); ++i) {\n\t\tunsigned int member_offset = (i % 4) * 4;\n\t\tunsigned int state_offset = member_offset + 2;\n\n\t\tif (member)\n\t\t\tmember[i] = (regs[i / 4] >> member_offset) & 0x3;\n\n\t\tif (state)\n\t\t\tstate[i] = (regs[i / 4] >> state_offset) & 0x3;\n\t}\n\n\treturn 0;\n}\n\nstatic int mv88e6185_g1_vtu_data_write(struct mv88e6xxx_chip *chip,\n\t\t\t\t       u8 *member, u8 *state)\n{\n\tu16 regs[3] = { 0 };\n\tint i;\n\n\t \n\tfor (i = 0; i < mv88e6xxx_num_ports(chip); ++i) {\n\t\tunsigned int member_offset = (i % 4) * 4;\n\t\tunsigned int state_offset = member_offset + 2;\n\n\t\tif (member)\n\t\t\tregs[i / 4] |= (member[i] & 0x3) << member_offset;\n\n\t\tif (state)\n\t\t\tregs[i / 4] |= (state[i] & 0x3) << state_offset;\n\t}\n\n\t \n\tfor (i = 0; i < 3; ++i) {\n\t\tu16 reg = regs[i];\n\t\tint err;\n\n\t\terr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_VTU_DATA1 + i, reg);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int mv88e6390_g1_vtu_data_read(struct mv88e6xxx_chip *chip, u8 *data)\n{\n\tu16 regs[2];\n\tint i;\n\n\t \n\tfor (i = 0; i < 2; ++i) {\n\t\tu16 *reg = &regs[i];\n\t\tint err;\n\n\t\terr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_VTU_DATA1 + i, reg);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\t \n\tfor (i = 0; i < mv88e6xxx_num_ports(chip); ++i) {\n\t\tunsigned int offset = (i % 8) * 2;\n\n\t\tdata[i] = (regs[i / 8] >> offset) & 0x3;\n\t}\n\n\treturn 0;\n}\n\nstatic int mv88e6390_g1_vtu_data_write(struct mv88e6xxx_chip *chip, u8 *data)\n{\n\tu16 regs[2] = { 0 };\n\tint i;\n\n\t \n\tfor (i = 0; i < mv88e6xxx_num_ports(chip); ++i) {\n\t\tunsigned int offset = (i % 8) * 2;\n\n\t\tregs[i / 8] |= (data[i] & 0x3) << offset;\n\t}\n\n\t \n\tfor (i = 0; i < 2; ++i) {\n\t\tu16 reg = regs[i];\n\t\tint err;\n\n\t\terr = mv88e6xxx_g1_write(chip, MV88E6XXX_G1_VTU_DATA1 + i, reg);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\n \n\nint mv88e6xxx_g1_vtu_getnext(struct mv88e6xxx_chip *chip,\n\t\t\t     struct mv88e6xxx_vtu_entry *entry)\n{\n\tint err;\n\n\terr = mv88e6xxx_g1_vtu_op_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\t \n\tif (!entry->valid) {\n\t\terr = mv88e6xxx_g1_vtu_vid_write(chip, false, entry->vid);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\terr = mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_VTU_GET_NEXT);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g1_vtu_vid_read(chip, &entry->valid, &entry->vid);\n}\n\nint mv88e6185_g1_vtu_getnext(struct mv88e6xxx_chip *chip,\n\t\t\t     struct mv88e6xxx_vtu_entry *entry)\n{\n\tu16 val;\n\tint err;\n\n\terr = mv88e6xxx_g1_vtu_getnext(chip, entry);\n\tif (err)\n\t\treturn err;\n\n\tif (entry->valid) {\n\t\terr = mv88e6185_g1_vtu_data_read(chip, entry->member, entry->state);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\t \n\t\terr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_VTU_OP, &val);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tentry->fid = val & 0x000f;\n\t\tentry->fid |= (val & 0x0f00) >> 4;\n\t\tentry->fid &= mv88e6xxx_num_databases(chip) - 1;\n\t}\n\n\treturn 0;\n}\n\nint mv88e6352_g1_vtu_getnext(struct mv88e6xxx_chip *chip,\n\t\t\t     struct mv88e6xxx_vtu_entry *entry)\n{\n\tint err;\n\n\t \n\terr = mv88e6xxx_g1_vtu_getnext(chip, entry);\n\tif (err)\n\t\treturn err;\n\n\tif (entry->valid) {\n\t\terr = mv88e6185_g1_vtu_data_read(chip, entry->member, NULL);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = mv88e6xxx_g1_vtu_fid_read(chip, entry);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = mv88e6xxx_g1_vtu_sid_read(chip, &entry->sid);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint mv88e6390_g1_vtu_getnext(struct mv88e6xxx_chip *chip,\n\t\t\t     struct mv88e6xxx_vtu_entry *entry)\n{\n\tint err;\n\n\t \n\terr = mv88e6xxx_g1_vtu_getnext(chip, entry);\n\tif (err)\n\t\treturn err;\n\n\tif (entry->valid) {\n\t\terr = mv88e6390_g1_vtu_data_read(chip, entry->member);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = mv88e6xxx_g1_vtu_fid_read(chip, entry);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = mv88e6xxx_g1_vtu_sid_read(chip, &entry->sid);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint mv88e6185_g1_vtu_loadpurge(struct mv88e6xxx_chip *chip,\n\t\t\t       struct mv88e6xxx_vtu_entry *entry)\n{\n\tu16 op = MV88E6XXX_G1_VTU_OP_VTU_LOAD_PURGE;\n\tint err;\n\n\terr = mv88e6xxx_g1_vtu_op_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g1_vtu_vid_write(chip, entry->valid, entry->vid);\n\tif (err)\n\t\treturn err;\n\n\tif (entry->valid) {\n\t\terr = mv88e6185_g1_vtu_data_write(chip, entry->member, entry->state);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\t \n\t\top |= entry->fid & 0x000f;\n\t\top |= (entry->fid & 0x00f0) << 4;\n\t}\n\n\treturn mv88e6xxx_g1_vtu_op(chip, op);\n}\n\nint mv88e6352_g1_vtu_loadpurge(struct mv88e6xxx_chip *chip,\n\t\t\t       struct mv88e6xxx_vtu_entry *entry)\n{\n\tint err;\n\n\terr = mv88e6xxx_g1_vtu_op_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g1_vtu_vid_write(chip, entry->valid, entry->vid);\n\tif (err)\n\t\treturn err;\n\n\tif (entry->valid) {\n\t\t \n\t\terr = mv88e6185_g1_vtu_data_write(chip, entry->member, NULL);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = mv88e6xxx_g1_vtu_fid_write(chip, entry);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = mv88e6xxx_g1_vtu_sid_write(chip, entry->sid);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\t \n\treturn mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_VTU_LOAD_PURGE);\n}\n\nint mv88e6390_g1_vtu_loadpurge(struct mv88e6xxx_chip *chip,\n\t\t\t       struct mv88e6xxx_vtu_entry *entry)\n{\n\tint err;\n\n\terr = mv88e6xxx_g1_vtu_op_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g1_vtu_vid_write(chip, entry->valid, entry->vid);\n\tif (err)\n\t\treturn err;\n\n\tif (entry->valid) {\n\t\t \n\t\terr = mv88e6390_g1_vtu_data_write(chip, entry->member);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = mv88e6xxx_g1_vtu_fid_write(chip, entry);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = mv88e6xxx_g1_vtu_sid_write(chip, entry->sid);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\t \n\treturn mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_VTU_LOAD_PURGE);\n}\n\nint mv88e6xxx_g1_vtu_flush(struct mv88e6xxx_chip *chip)\n{\n\tint err;\n\n\terr = mv88e6xxx_g1_vtu_op_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_FLUSH_ALL);\n}\n\n \n\nint mv88e6xxx_g1_stu_getnext(struct mv88e6xxx_chip *chip,\n\t\t\t     struct mv88e6xxx_stu_entry *entry)\n{\n\tint err;\n\n\terr = mv88e6xxx_g1_vtu_op_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\t \n\tif (!entry->valid) {\n\t\terr = mv88e6xxx_g1_vtu_sid_write(chip, entry->sid);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\terr = mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_STU_GET_NEXT);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g1_vtu_vid_read(chip, &entry->valid, NULL);\n\tif (err)\n\t\treturn err;\n\n\tif (entry->valid) {\n\t\terr = mv88e6xxx_g1_vtu_sid_read(chip, &entry->sid);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint mv88e6352_g1_stu_getnext(struct mv88e6xxx_chip *chip,\n\t\t\t     struct mv88e6xxx_stu_entry *entry)\n{\n\tint err;\n\n\terr = mv88e6xxx_g1_stu_getnext(chip, entry);\n\tif (err)\n\t\treturn err;\n\n\tif (!entry->valid)\n\t\treturn 0;\n\n\treturn mv88e6185_g1_vtu_data_read(chip, NULL, entry->state);\n}\n\nint mv88e6390_g1_stu_getnext(struct mv88e6xxx_chip *chip,\n\t\t\t     struct mv88e6xxx_stu_entry *entry)\n{\n\tint err;\n\n\terr = mv88e6xxx_g1_stu_getnext(chip, entry);\n\tif (err)\n\t\treturn err;\n\n\tif (!entry->valid)\n\t\treturn 0;\n\n\treturn mv88e6390_g1_vtu_data_read(chip, entry->state);\n}\n\nint mv88e6352_g1_stu_loadpurge(struct mv88e6xxx_chip *chip,\n\t\t\t       struct mv88e6xxx_stu_entry *entry)\n{\n\tint err;\n\n\terr = mv88e6xxx_g1_vtu_op_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g1_vtu_vid_write(chip, entry->valid, 0);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g1_vtu_sid_write(chip, entry->sid);\n\tif (err)\n\t\treturn err;\n\n\tif (entry->valid) {\n\t\terr = mv88e6185_g1_vtu_data_write(chip, NULL, entry->state);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\t \n\treturn mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_STU_LOAD_PURGE);\n}\n\nint mv88e6390_g1_stu_loadpurge(struct mv88e6xxx_chip *chip,\n\t\t\t       struct mv88e6xxx_stu_entry *entry)\n{\n\tint err;\n\n\terr = mv88e6xxx_g1_vtu_op_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g1_vtu_vid_write(chip, entry->valid, 0);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g1_vtu_sid_write(chip, entry->sid);\n\tif (err)\n\t\treturn err;\n\n\tif (entry->valid) {\n\t\terr = mv88e6390_g1_vtu_data_write(chip, entry->state);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\t \n\treturn mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_STU_LOAD_PURGE);\n}\n\n \n\nstatic irqreturn_t mv88e6xxx_g1_vtu_prob_irq_thread_fn(int irq, void *dev_id)\n{\n\tstruct mv88e6xxx_chip *chip = dev_id;\n\tu16 val, vid;\n\tint spid;\n\tint err;\n\n\tmv88e6xxx_reg_lock(chip);\n\n\terr = mv88e6xxx_g1_vtu_op(chip, MV88E6XXX_G1_VTU_OP_GET_CLR_VIOLATION);\n\tif (err)\n\t\tgoto out;\n\n\terr = mv88e6xxx_g1_read(chip, MV88E6XXX_G1_VTU_OP, &val);\n\tif (err)\n\t\tgoto out;\n\n\terr = mv88e6xxx_g1_vtu_vid_read(chip, NULL, &vid);\n\tif (err)\n\t\tgoto out;\n\n\tspid = val & MV88E6XXX_G1_VTU_OP_SPID_MASK;\n\n\tif (val & MV88E6XXX_G1_VTU_OP_MEMBER_VIOLATION) {\n\t\ttrace_mv88e6xxx_vtu_member_violation(chip->dev, spid, vid);\n\t\tchip->ports[spid].vtu_member_violation++;\n\t}\n\n\tif (val & MV88E6XXX_G1_VTU_OP_MISS_VIOLATION) {\n\t\ttrace_mv88e6xxx_vtu_miss_violation(chip->dev, spid, vid);\n\t\tchip->ports[spid].vtu_miss_violation++;\n\t}\n\n\tmv88e6xxx_reg_unlock(chip);\n\n\treturn IRQ_HANDLED;\n\nout:\n\tmv88e6xxx_reg_unlock(chip);\n\n\tdev_err(chip->dev, \"VTU problem: error %d while handling interrupt\\n\",\n\t\terr);\n\n\treturn IRQ_HANDLED;\n}\n\nint mv88e6xxx_g1_vtu_prob_irq_setup(struct mv88e6xxx_chip *chip)\n{\n\tint err;\n\n\tchip->vtu_prob_irq = irq_find_mapping(chip->g1_irq.domain,\n\t\t\t\t\t      MV88E6XXX_G1_STS_IRQ_VTU_PROB);\n\tif (chip->vtu_prob_irq < 0)\n\t\treturn chip->vtu_prob_irq;\n\n\tsnprintf(chip->vtu_prob_irq_name, sizeof(chip->vtu_prob_irq_name),\n\t\t \"mv88e6xxx-%s-g1-vtu-prob\", dev_name(chip->dev));\n\n\terr = request_threaded_irq(chip->vtu_prob_irq, NULL,\n\t\t\t\t   mv88e6xxx_g1_vtu_prob_irq_thread_fn,\n\t\t\t\t   IRQF_ONESHOT, chip->vtu_prob_irq_name,\n\t\t\t\t   chip);\n\tif (err)\n\t\tirq_dispose_mapping(chip->vtu_prob_irq);\n\n\treturn err;\n}\n\nvoid mv88e6xxx_g1_vtu_prob_irq_free(struct mv88e6xxx_chip *chip)\n{\n\tfree_irq(chip->vtu_prob_irq, chip);\n\tirq_dispose_mapping(chip->vtu_prob_irq);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}