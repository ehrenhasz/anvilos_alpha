{
  "module_name": "smi.c",
  "hash_id": "44433745c229d432d4a4e57301a07182cc11734a6bf8906db916018ad95c924a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/dsa/mv88e6xxx/smi.c",
  "human_readable_source": "\n \n\n#include \"chip.h\"\n#include \"smi.h\"\n\n \n\nstatic int mv88e6xxx_smi_direct_read(struct mv88e6xxx_chip *chip,\n\t\t\t\t     int dev, int reg, u16 *data)\n{\n\tint ret;\n\n\tret = mdiobus_read_nested(chip->bus, dev, reg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*data = ret & 0xffff;\n\n\treturn 0;\n}\n\nstatic int mv88e6xxx_smi_direct_write(struct mv88e6xxx_chip *chip,\n\t\t\t\t      int dev, int reg, u16 data)\n{\n\tint ret;\n\n\tret = mdiobus_write_nested(chip->bus, dev, reg, data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int mv88e6xxx_smi_direct_wait(struct mv88e6xxx_chip *chip,\n\t\t\t\t     int dev, int reg, int bit, int val)\n{\n\tconst unsigned long timeout = jiffies + msecs_to_jiffies(50);\n\tu16 data;\n\tint err;\n\tint i;\n\n\t \n\tfor (i = 0; time_before(jiffies, timeout) || (i < 2); i++) {\n\t\terr = mv88e6xxx_smi_direct_read(chip, dev, reg, &data);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tif (!!(data & BIT(bit)) == !!val)\n\t\t\treturn 0;\n\n\t\tif (i < 2)\n\t\t\tcpu_relax();\n\t\telse\n\t\t\tusleep_range(1000, 2000);\n\t}\n\n\treturn -ETIMEDOUT;\n}\n\nstatic const struct mv88e6xxx_bus_ops mv88e6xxx_smi_direct_ops = {\n\t.read = mv88e6xxx_smi_direct_read,\n\t.write = mv88e6xxx_smi_direct_write,\n};\n\nstatic int mv88e6xxx_smi_dual_direct_read(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t  int dev, int reg, u16 *data)\n{\n\treturn mv88e6xxx_smi_direct_read(chip, chip->sw_addr + dev, reg, data);\n}\n\nstatic int mv88e6xxx_smi_dual_direct_write(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t   int dev, int reg, u16 data)\n{\n\treturn mv88e6xxx_smi_direct_write(chip, chip->sw_addr + dev, reg, data);\n}\n\nstatic const struct mv88e6xxx_bus_ops mv88e6xxx_smi_dual_direct_ops = {\n\t.read = mv88e6xxx_smi_dual_direct_read,\n\t.write = mv88e6xxx_smi_dual_direct_write,\n};\n\n \n\nstatic int mv88e6xxx_smi_indirect_read(struct mv88e6xxx_chip *chip,\n\t\t\t\t       int dev, int reg, u16 *data)\n{\n\tint err;\n\n\terr = mv88e6xxx_smi_direct_write(chip, chip->sw_addr,\n\t\t\t\t\t MV88E6XXX_SMI_CMD,\n\t\t\t\t\t MV88E6XXX_SMI_CMD_BUSY |\n\t\t\t\t\t MV88E6XXX_SMI_CMD_MODE_22 |\n\t\t\t\t\t MV88E6XXX_SMI_CMD_OP_22_READ |\n\t\t\t\t\t (dev << 5) | reg);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_smi_direct_wait(chip, chip->sw_addr,\n\t\t\t\t\tMV88E6XXX_SMI_CMD, 15, 0);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_smi_direct_read(chip, chip->sw_addr,\n\t\t\t\t\t MV88E6XXX_SMI_DATA, data);\n}\n\nstatic int mv88e6xxx_smi_indirect_write(struct mv88e6xxx_chip *chip,\n\t\t\t\t\tint dev, int reg, u16 data)\n{\n\tint err;\n\n\terr = mv88e6xxx_smi_direct_write(chip, chip->sw_addr,\n\t\t\t\t\t MV88E6XXX_SMI_DATA, data);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_smi_direct_write(chip, chip->sw_addr,\n\t\t\t\t\t MV88E6XXX_SMI_CMD,\n\t\t\t\t\t MV88E6XXX_SMI_CMD_BUSY |\n\t\t\t\t\t MV88E6XXX_SMI_CMD_MODE_22 |\n\t\t\t\t\t MV88E6XXX_SMI_CMD_OP_22_WRITE |\n\t\t\t\t\t (dev << 5) | reg);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_smi_direct_wait(chip, chip->sw_addr,\n\t\t\t\t\t MV88E6XXX_SMI_CMD, 15, 0);\n}\n\nstatic int mv88e6xxx_smi_indirect_init(struct mv88e6xxx_chip *chip)\n{\n\t \n\treturn mv88e6xxx_smi_direct_wait(chip, chip->sw_addr,\n\t\t\t\t\t MV88E6XXX_SMI_CMD, 15, 0);\n}\n\nstatic const struct mv88e6xxx_bus_ops mv88e6xxx_smi_indirect_ops = {\n\t.read = mv88e6xxx_smi_indirect_read,\n\t.write = mv88e6xxx_smi_indirect_write,\n\t.init = mv88e6xxx_smi_indirect_init,\n};\n\nint mv88e6xxx_smi_init(struct mv88e6xxx_chip *chip,\n\t\t       struct mii_bus *bus, int sw_addr)\n{\n\tif (chip->info->dual_chip)\n\t\tchip->smi_ops = &mv88e6xxx_smi_dual_direct_ops;\n\telse if (sw_addr == 0)\n\t\tchip->smi_ops = &mv88e6xxx_smi_direct_ops;\n\telse if (chip->info->multi_chip)\n\t\tchip->smi_ops = &mv88e6xxx_smi_indirect_ops;\n\telse\n\t\treturn -EINVAL;\n\n\tchip->bus = bus;\n\tchip->sw_addr = sw_addr;\n\n\tif (chip->smi_ops->init)\n\t\treturn chip->smi_ops->init(chip);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}