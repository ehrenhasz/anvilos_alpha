{
  "module_name": "global2.c",
  "hash_id": "ab174f59296301ecdabeb3566850faa80db134a5840ea22195b5dcbe588b2a08",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/dsa/mv88e6xxx/global2.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/interrupt.h>\n#include <linux/irqdomain.h>\n\n#include \"chip.h\"\n#include \"global1.h\"  \n#include \"global2.h\"\n\nint mv88e6xxx_g2_read(struct mv88e6xxx_chip *chip, int reg, u16 *val)\n{\n\treturn mv88e6xxx_read(chip, chip->info->global2_addr, reg, val);\n}\n\nint mv88e6xxx_g2_write(struct mv88e6xxx_chip *chip, int reg, u16 val)\n{\n\treturn mv88e6xxx_write(chip, chip->info->global2_addr, reg, val);\n}\n\nint mv88e6xxx_g2_wait_bit(struct mv88e6xxx_chip *chip, int reg, int\n\t\t\t  bit, int val)\n{\n\treturn mv88e6xxx_wait_bit(chip, chip->info->global2_addr, reg,\n\t\t\t\t  bit, val);\n}\n\n \n\nstatic int mv88e6xxx_g2_int_source(struct mv88e6xxx_chip *chip, u16 *src)\n{\n\t \n\treturn mv88e6xxx_g2_read(chip, MV88E6XXX_G2_INT_SRC, src);\n}\n\n \n\nstatic int mv88e6xxx_g2_int_mask(struct mv88e6xxx_chip *chip, u16 mask)\n{\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_INT_MASK, mask);\n}\n\n \n\nstatic int mv88e6xxx_g2_mgmt_enable_2x(struct mv88e6xxx_chip *chip, u16 en2x)\n{\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_MGMT_EN_2X, en2x);\n}\n\n \n\nstatic int mv88e6xxx_g2_mgmt_enable_0x(struct mv88e6xxx_chip *chip, u16 en0x)\n{\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_MGMT_EN_0X, en0x);\n}\n\n \n\nstatic int mv88e6xxx_g2_switch_mgmt_rsvd2cpu(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t     bool enable)\n{\n\tu16 val;\n\tint err;\n\n\terr = mv88e6xxx_g2_read(chip, MV88E6XXX_G2_SWITCH_MGMT, &val);\n\tif (err)\n\t\treturn err;\n\n\tif (enable)\n\t\tval |= MV88E6XXX_G2_SWITCH_MGMT_RSVD2CPU;\n\telse\n\t\tval &= ~MV88E6XXX_G2_SWITCH_MGMT_RSVD2CPU;\n\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_SWITCH_MGMT, val);\n}\n\nint mv88e6185_g2_mgmt_rsvd2cpu(struct mv88e6xxx_chip *chip)\n{\n\tint err;\n\n\t \n\terr = mv88e6xxx_g2_mgmt_enable_0x(chip, 0xffff);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_switch_mgmt_rsvd2cpu(chip, true);\n}\n\nint mv88e6352_g2_mgmt_rsvd2cpu(struct mv88e6xxx_chip *chip)\n{\n\tint err;\n\n\t \n\terr = mv88e6xxx_g2_mgmt_enable_2x(chip, 0xffff);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6185_g2_mgmt_rsvd2cpu(chip);\n}\n\n \n\nint mv88e6xxx_g2_device_mapping_write(struct mv88e6xxx_chip *chip, int target,\n\t\t\t\t      int port)\n{\n\tu16 val = (target << 8) | (port & 0x1f);\n\t \n\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_DEVICE_MAPPING,\n\t\t\t\t  MV88E6XXX_G2_DEVICE_MAPPING_UPDATE | val);\n}\n\n \n\nint mv88e6xxx_g2_trunk_mask_write(struct mv88e6xxx_chip *chip, int num,\n\t\t\t\t  bool hash, u16 mask)\n{\n\tu16 val = (num << 12) | (mask & mv88e6xxx_port_mask(chip));\n\n\tif (hash)\n\t\tval |= MV88E6XXX_G2_TRUNK_MASK_HASH;\n\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_TRUNK_MASK,\n\t\t\t\t  MV88E6XXX_G2_TRUNK_MASK_UPDATE | val);\n}\n\n \n\nint mv88e6xxx_g2_trunk_mapping_write(struct mv88e6xxx_chip *chip, int id,\n\t\t\t\t     u16 map)\n{\n\tconst u16 port_mask = BIT(mv88e6xxx_num_ports(chip)) - 1;\n\tu16 val = (id << 11) | (map & port_mask);\n\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_TRUNK_MAPPING,\n\t\t\t\t  MV88E6XXX_G2_TRUNK_MAPPING_UPDATE | val);\n}\n\nint mv88e6xxx_g2_trunk_clear(struct mv88e6xxx_chip *chip)\n{\n\tconst u16 port_mask = BIT(mv88e6xxx_num_ports(chip)) - 1;\n\tint i, err;\n\n\t \n\tfor (i = 0; i < 8; ++i) {\n\t\terr = mv88e6xxx_g2_trunk_mask_write(chip, i, false, port_mask);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\t \n\tfor (i = 0; i < 16; ++i) {\n\t\terr = mv88e6xxx_g2_trunk_mapping_write(chip, i, 0);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\n \n\nstatic int mv88e6xxx_g2_irl_wait(struct mv88e6xxx_chip *chip)\n{\n\tint bit = __bf_shf(MV88E6XXX_G2_IRL_CMD_BUSY);\n\n\treturn mv88e6xxx_g2_wait_bit(chip, MV88E6XXX_G2_IRL_CMD, bit, 0);\n}\n\nstatic int mv88e6xxx_g2_irl_op(struct mv88e6xxx_chip *chip, u16 op, int port,\n\t\t\t       int res, int reg)\n{\n\tint err;\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6XXX_G2_IRL_CMD,\n\t\t\t\t MV88E6XXX_G2_IRL_CMD_BUSY | op | (port << 8) |\n\t\t\t\t (res << 5) | reg);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_irl_wait(chip);\n}\n\nint mv88e6352_g2_irl_init_all(struct mv88e6xxx_chip *chip, int port)\n{\n\treturn mv88e6xxx_g2_irl_op(chip, MV88E6352_G2_IRL_CMD_OP_INIT_ALL, port,\n\t\t\t\t   0, 0);\n}\n\nint mv88e6390_g2_irl_init_all(struct mv88e6xxx_chip *chip, int port)\n{\n\treturn mv88e6xxx_g2_irl_op(chip, MV88E6390_G2_IRL_CMD_OP_INIT_ALL, port,\n\t\t\t\t   0, 0);\n}\n\n \n\nstatic int mv88e6xxx_g2_pvt_op_wait(struct mv88e6xxx_chip *chip)\n{\n\tint bit = __bf_shf(MV88E6XXX_G2_PVT_ADDR_BUSY);\n\n\treturn mv88e6xxx_g2_wait_bit(chip, MV88E6XXX_G2_PVT_ADDR, bit, 0);\n}\n\nstatic int mv88e6xxx_g2_pvt_op(struct mv88e6xxx_chip *chip, int src_dev,\n\t\t\t       int src_port, u16 op)\n{\n\tint err;\n\n\t \n\top |= MV88E6XXX_G2_PVT_ADDR_BUSY;\n\top |= (src_dev & 0x1f) << 4;\n\top |= (src_port & 0xf);\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6XXX_G2_PVT_ADDR, op);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_pvt_op_wait(chip);\n}\n\nint mv88e6xxx_g2_pvt_read(struct mv88e6xxx_chip *chip, int src_dev,\n\t\t\t  int src_port, u16 *data)\n{\n\tint err;\n\n\terr = mv88e6xxx_g2_pvt_op_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_pvt_op(chip, src_dev, src_port,\n\t\t\t\t  MV88E6XXX_G2_PVT_ADDR_OP_READ);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_read(chip, MV88E6XXX_G2_PVT_DATA, data);\n}\n\nint mv88e6xxx_g2_pvt_write(struct mv88e6xxx_chip *chip, int src_dev,\n\t\t\t   int src_port, u16 data)\n{\n\tint err;\n\n\terr = mv88e6xxx_g2_pvt_op_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6XXX_G2_PVT_DATA, data);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_pvt_op(chip, src_dev, src_port,\n\t\t\t\t   MV88E6XXX_G2_PVT_ADDR_OP_WRITE_PVLAN);\n}\n\n \n\nstatic int mv88e6xxx_g2_switch_mac_write(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t unsigned int pointer, u8 data)\n{\n\tu16 val = (pointer << 8) | data;\n\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_SWITCH_MAC,\n\t\t\t\t  MV88E6XXX_G2_SWITCH_MAC_UPDATE | val);\n}\n\nint mv88e6xxx_g2_set_switch_mac(struct mv88e6xxx_chip *chip, u8 *addr)\n{\n\tint i, err;\n\n\tfor (i = 0; i < 6; i++) {\n\t\terr = mv88e6xxx_g2_switch_mac_write(chip, i, addr[i]);\n\t\tif (err)\n\t\t\tbreak;\n\t}\n\n\treturn err;\n}\n\n \n\nint mv88e6xxx_g2_atu_stats_set(struct mv88e6xxx_chip *chip, u16 kind, u16 bin)\n{\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_ATU_STATS,\n\t\t\t\t  kind | bin);\n}\n\nint mv88e6xxx_g2_atu_stats_get(struct mv88e6xxx_chip *chip, u16 *stats)\n{\n\treturn mv88e6xxx_g2_read(chip, MV88E6XXX_G2_ATU_STATS, stats);\n}\n\n \n\nstatic int mv88e6xxx_g2_pot_write(struct mv88e6xxx_chip *chip, int pointer,\n\t\t\t\t  u8 data)\n{\n\tu16 val = (pointer << 8) | (data & 0x7);\n\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_PRIO_OVERRIDE,\n\t\t\t\t  MV88E6XXX_G2_PRIO_OVERRIDE_UPDATE | val);\n}\n\nint mv88e6xxx_g2_pot_clear(struct mv88e6xxx_chip *chip)\n{\n\tint i, err;\n\n\t \n\tfor (i = 0; i < 16; i++) {\n\t\terr = mv88e6xxx_g2_pot_write(chip, i, 0);\n\t\tif (err)\n\t\t\tbreak;\n\t}\n\n\treturn err;\n}\n\n \n\nint mv88e6xxx_g2_eeprom_wait(struct mv88e6xxx_chip *chip)\n{\n\tint bit = __bf_shf(MV88E6XXX_G2_EEPROM_CMD_BUSY);\n\tint err;\n\n\terr = mv88e6xxx_g2_wait_bit(chip, MV88E6XXX_G2_EEPROM_CMD, bit, 0);\n\tif (err)\n\t\treturn err;\n\n\tbit = __bf_shf(MV88E6XXX_G2_EEPROM_CMD_RUNNING);\n\n\treturn mv88e6xxx_g2_wait_bit(chip, MV88E6XXX_G2_EEPROM_CMD, bit, 0);\n}\n\nstatic int mv88e6xxx_g2_eeprom_cmd(struct mv88e6xxx_chip *chip, u16 cmd)\n{\n\tint err;\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6XXX_G2_EEPROM_CMD,\n\t\t\t\t MV88E6XXX_G2_EEPROM_CMD_BUSY | cmd);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_eeprom_wait(chip);\n}\n\nstatic int mv88e6xxx_g2_eeprom_read8(struct mv88e6xxx_chip *chip,\n\t\t\t\t     u16 addr, u8 *data)\n{\n\tu16 cmd = MV88E6XXX_G2_EEPROM_CMD_OP_READ;\n\tint err;\n\n\terr = mv88e6xxx_g2_eeprom_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6390_G2_EEPROM_ADDR, addr);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_eeprom_cmd(chip, cmd);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_read(chip, MV88E6XXX_G2_EEPROM_CMD, &cmd);\n\tif (err)\n\t\treturn err;\n\n\t*data = cmd & 0xff;\n\n\treturn 0;\n}\n\nstatic int mv88e6xxx_g2_eeprom_write8(struct mv88e6xxx_chip *chip,\n\t\t\t\t      u16 addr, u8 data)\n{\n\tu16 cmd = MV88E6XXX_G2_EEPROM_CMD_OP_WRITE |\n\t\tMV88E6XXX_G2_EEPROM_CMD_WRITE_EN;\n\tint err;\n\n\terr = mv88e6xxx_g2_eeprom_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6390_G2_EEPROM_ADDR, addr);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_eeprom_cmd(chip, cmd | data);\n}\n\nstatic int mv88e6xxx_g2_eeprom_read16(struct mv88e6xxx_chip *chip,\n\t\t\t\t      u8 addr, u16 *data)\n{\n\tu16 cmd = MV88E6XXX_G2_EEPROM_CMD_OP_READ | addr;\n\tint err;\n\n\terr = mv88e6xxx_g2_eeprom_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_eeprom_cmd(chip, cmd);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_read(chip, MV88E6352_G2_EEPROM_DATA, data);\n}\n\nstatic int mv88e6xxx_g2_eeprom_write16(struct mv88e6xxx_chip *chip,\n\t\t\t\t       u8 addr, u16 data)\n{\n\tu16 cmd = MV88E6XXX_G2_EEPROM_CMD_OP_WRITE | addr;\n\tint err;\n\n\terr = mv88e6xxx_g2_eeprom_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6352_G2_EEPROM_DATA, data);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_eeprom_cmd(chip, cmd);\n}\n\nint mv88e6xxx_g2_get_eeprom8(struct mv88e6xxx_chip *chip,\n\t\t\t     struct ethtool_eeprom *eeprom, u8 *data)\n{\n\tunsigned int offset = eeprom->offset;\n\tunsigned int len = eeprom->len;\n\tint err;\n\n\teeprom->len = 0;\n\n\twhile (len) {\n\t\terr = mv88e6xxx_g2_eeprom_read8(chip, offset, data);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\teeprom->len++;\n\t\toffset++;\n\t\tdata++;\n\t\tlen--;\n\t}\n\n\treturn 0;\n}\n\nint mv88e6xxx_g2_set_eeprom8(struct mv88e6xxx_chip *chip,\n\t\t\t     struct ethtool_eeprom *eeprom, u8 *data)\n{\n\tunsigned int offset = eeprom->offset;\n\tunsigned int len = eeprom->len;\n\tint err;\n\n\teeprom->len = 0;\n\n\twhile (len) {\n\t\terr = mv88e6xxx_g2_eeprom_write8(chip, offset, *data);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\teeprom->len++;\n\t\toffset++;\n\t\tdata++;\n\t\tlen--;\n\t}\n\n\treturn 0;\n}\n\nint mv88e6xxx_g2_get_eeprom16(struct mv88e6xxx_chip *chip,\n\t\t\t      struct ethtool_eeprom *eeprom, u8 *data)\n{\n\tunsigned int offset = eeprom->offset;\n\tunsigned int len = eeprom->len;\n\tu16 val;\n\tint err;\n\n\teeprom->len = 0;\n\n\tif (offset & 1) {\n\t\terr = mv88e6xxx_g2_eeprom_read16(chip, offset >> 1, &val);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\t*data++ = (val >> 8) & 0xff;\n\n\t\toffset++;\n\t\tlen--;\n\t\teeprom->len++;\n\t}\n\n\twhile (len >= 2) {\n\t\terr = mv88e6xxx_g2_eeprom_read16(chip, offset >> 1, &val);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\t*data++ = val & 0xff;\n\t\t*data++ = (val >> 8) & 0xff;\n\n\t\toffset += 2;\n\t\tlen -= 2;\n\t\teeprom->len += 2;\n\t}\n\n\tif (len) {\n\t\terr = mv88e6xxx_g2_eeprom_read16(chip, offset >> 1, &val);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\t*data++ = val & 0xff;\n\n\t\toffset++;\n\t\tlen--;\n\t\teeprom->len++;\n\t}\n\n\treturn 0;\n}\n\nint mv88e6xxx_g2_set_eeprom16(struct mv88e6xxx_chip *chip,\n\t\t\t      struct ethtool_eeprom *eeprom, u8 *data)\n{\n\tunsigned int offset = eeprom->offset;\n\tunsigned int len = eeprom->len;\n\tu16 val;\n\tint err;\n\n\t \n\terr = mv88e6xxx_g2_read(chip, MV88E6XXX_G2_EEPROM_CMD, &val);\n\tif (err)\n\t\treturn err;\n\n\tif (!(val & MV88E6XXX_G2_EEPROM_CMD_WRITE_EN))\n\t\treturn -EROFS;\n\n\teeprom->len = 0;\n\n\tif (offset & 1) {\n\t\terr = mv88e6xxx_g2_eeprom_read16(chip, offset >> 1, &val);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tval = (*data++ << 8) | (val & 0xff);\n\n\t\terr = mv88e6xxx_g2_eeprom_write16(chip, offset >> 1, val);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\toffset++;\n\t\tlen--;\n\t\teeprom->len++;\n\t}\n\n\twhile (len >= 2) {\n\t\tval = *data++;\n\t\tval |= *data++ << 8;\n\n\t\terr = mv88e6xxx_g2_eeprom_write16(chip, offset >> 1, val);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\toffset += 2;\n\t\tlen -= 2;\n\t\teeprom->len += 2;\n\t}\n\n\tif (len) {\n\t\terr = mv88e6xxx_g2_eeprom_read16(chip, offset >> 1, &val);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tval = (val & 0xff00) | *data++;\n\n\t\terr = mv88e6xxx_g2_eeprom_write16(chip, offset >> 1, val);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\toffset++;\n\t\tlen--;\n\t\teeprom->len++;\n\t}\n\n\treturn 0;\n}\n\n \n\nstatic int mv88e6xxx_g2_smi_phy_wait(struct mv88e6xxx_chip *chip)\n{\n\tint bit = __bf_shf(MV88E6XXX_G2_SMI_PHY_CMD_BUSY);\n\n\treturn mv88e6xxx_g2_wait_bit(chip, MV88E6XXX_G2_SMI_PHY_CMD, bit, 0);\n}\n\nstatic int mv88e6xxx_g2_smi_phy_cmd(struct mv88e6xxx_chip *chip, u16 cmd)\n{\n\tint err;\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6XXX_G2_SMI_PHY_CMD,\n\t\t\t\t MV88E6XXX_G2_SMI_PHY_CMD_BUSY | cmd);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_smi_phy_wait(chip);\n}\n\nstatic int mv88e6xxx_g2_smi_phy_access(struct mv88e6xxx_chip *chip,\n\t\t\t\t       bool external, bool c45, u16 op, int dev,\n\t\t\t\t       int reg)\n{\n\tu16 cmd = op;\n\n\tif (external)\n\t\tcmd |= MV88E6390_G2_SMI_PHY_CMD_FUNC_EXTERNAL;\n\telse\n\t\tcmd |= MV88E6390_G2_SMI_PHY_CMD_FUNC_INTERNAL;  \n\n\tif (c45)\n\t\tcmd |= MV88E6XXX_G2_SMI_PHY_CMD_MODE_45;  \n\telse\n\t\tcmd |= MV88E6XXX_G2_SMI_PHY_CMD_MODE_22;\n\n\tdev <<= __bf_shf(MV88E6XXX_G2_SMI_PHY_CMD_DEV_ADDR_MASK);\n\tcmd |= dev & MV88E6XXX_G2_SMI_PHY_CMD_DEV_ADDR_MASK;\n\tcmd |= reg & MV88E6XXX_G2_SMI_PHY_CMD_REG_ADDR_MASK;\n\n\treturn mv88e6xxx_g2_smi_phy_cmd(chip, cmd);\n}\n\nstatic int mv88e6xxx_g2_smi_phy_access_c22(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t   bool external, u16 op, int dev,\n\t\t\t\t\t   int reg)\n{\n\treturn mv88e6xxx_g2_smi_phy_access(chip, external, false, op, dev, reg);\n}\n\n \nstatic int mv88e6xxx_g2_smi_phy_read_data_c22(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t      bool external, int dev, int reg,\n\t\t\t\t\t      u16 *data)\n{\n\tu16 op = MV88E6XXX_G2_SMI_PHY_CMD_OP_22_READ_DATA;\n\tint err;\n\n\terr = mv88e6xxx_g2_smi_phy_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_smi_phy_access_c22(chip, external, op, dev, reg);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_read(chip, MV88E6XXX_G2_SMI_PHY_DATA, data);\n}\n\n \nstatic int mv88e6xxx_g2_smi_phy_write_data_c22(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t       bool external, int dev, int reg,\n\t\t\t\t\t       u16 data)\n{\n\tu16 op = MV88E6XXX_G2_SMI_PHY_CMD_OP_22_WRITE_DATA;\n\tint err;\n\n\terr = mv88e6xxx_g2_smi_phy_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6XXX_G2_SMI_PHY_DATA, data);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_smi_phy_access_c22(chip, external, op, dev, reg);\n}\n\nstatic int mv88e6xxx_g2_smi_phy_access_c45(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t   bool external, u16 op, int port,\n\t\t\t\t\t   int dev)\n{\n\treturn mv88e6xxx_g2_smi_phy_access(chip, external, true, op, port, dev);\n}\n\n \nstatic int mv88e6xxx_g2_smi_phy_write_addr_c45(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t       bool external, int port, int dev,\n\t\t\t\t\t       int addr)\n{\n\tu16 op = MV88E6XXX_G2_SMI_PHY_CMD_OP_45_WRITE_ADDR;\n\tint err;\n\n\terr = mv88e6xxx_g2_smi_phy_wait(chip);\n\tif (err)\n\t\treturn err;\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6XXX_G2_SMI_PHY_DATA, addr);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_smi_phy_access_c45(chip, external, op, port, dev);\n}\n\n \nstatic int mv88e6xxx_g2_smi_phy_read_data_c45(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t      bool external, int port, int dev,\n\t\t\t\t\t      u16 *data)\n{\n\tu16 op = MV88E6XXX_G2_SMI_PHY_CMD_OP_45_READ_DATA;\n\tint err;\n\n\terr = mv88e6xxx_g2_smi_phy_access_c45(chip, external, op, port, dev);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_read(chip, MV88E6XXX_G2_SMI_PHY_DATA, data);\n}\n\nstatic int _mv88e6xxx_g2_smi_phy_read_c45(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t  bool external, int port, int devad,\n\t\t\t\t\t  int reg, u16 *data)\n{\n\tint err;\n\n\terr = mv88e6xxx_g2_smi_phy_write_addr_c45(chip, external, port, devad,\n\t\t\t\t\t\t  reg);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_smi_phy_read_data_c45(chip, external, port, devad,\n\t\t\t\t\t\t  data);\n}\n\n \nstatic int mv88e6xxx_g2_smi_phy_write_data_c45(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t       bool external, int port, int dev,\n\t\t\t\t\t       u16 data)\n{\n\tu16 op = MV88E6XXX_G2_SMI_PHY_CMD_OP_45_WRITE_DATA;\n\tint err;\n\n\terr = mv88e6xxx_g2_write(chip, MV88E6XXX_G2_SMI_PHY_DATA, data);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_smi_phy_access_c45(chip, external, op, port, dev);\n}\n\nstatic int _mv88e6xxx_g2_smi_phy_write_c45(struct mv88e6xxx_chip *chip,\n\t\t\t\t\t   bool external, int port, int devad,\n\t\t\t\t\t   int reg, u16 data)\n{\n\tint err;\n\n\terr = mv88e6xxx_g2_smi_phy_write_addr_c45(chip, external, port, devad,\n\t\t\t\t\t\t  reg);\n\tif (err)\n\t\treturn err;\n\n\treturn mv88e6xxx_g2_smi_phy_write_data_c45(chip, external, port, devad,\n\t\t\t\t\t\t   data);\n}\n\nint mv88e6xxx_g2_smi_phy_read_c22(struct mv88e6xxx_chip *chip,\n\t\t\t\t  struct mii_bus *bus,\n\t\t\t\t  int addr, int reg, u16 *val)\n{\n\tstruct mv88e6xxx_mdio_bus *mdio_bus = bus->priv;\n\tbool external = mdio_bus->external;\n\n\treturn mv88e6xxx_g2_smi_phy_read_data_c22(chip, external, addr, reg,\n\t\t\t\t\t\t  val);\n}\n\nint mv88e6xxx_g2_smi_phy_read_c45(struct mv88e6xxx_chip *chip,\n\t\t\t\t  struct mii_bus *bus, int addr, int devad,\n\t\t\t\t  int reg, u16 *val)\n{\n\tstruct mv88e6xxx_mdio_bus *mdio_bus = bus->priv;\n\tbool external = mdio_bus->external;\n\n\treturn _mv88e6xxx_g2_smi_phy_read_c45(chip, external, addr, devad, reg,\n\t\t\t\t\t      val);\n}\n\nint mv88e6xxx_g2_smi_phy_write_c22(struct mv88e6xxx_chip *chip,\n\t\t\t\t   struct mii_bus *bus, int addr, int reg,\n\t\t\t\t   u16 val)\n{\n\tstruct mv88e6xxx_mdio_bus *mdio_bus = bus->priv;\n\tbool external = mdio_bus->external;\n\n\treturn mv88e6xxx_g2_smi_phy_write_data_c22(chip, external, addr, reg,\n\t\t\t\t\t\t   val);\n}\n\nint mv88e6xxx_g2_smi_phy_write_c45(struct mv88e6xxx_chip *chip,\n\t\t\t\t   struct mii_bus *bus, int addr, int devad,\n\t\t\t\t   int reg, u16 val)\n{\n\tstruct mv88e6xxx_mdio_bus *mdio_bus = bus->priv;\n\tbool external = mdio_bus->external;\n\n\treturn _mv88e6xxx_g2_smi_phy_write_c45(chip, external, addr, devad, reg,\n\t\t\t\t\t       val);\n}\n\n \nstatic int mv88e6097_watchdog_action(struct mv88e6xxx_chip *chip, int irq)\n{\n\tu16 reg;\n\n\tmv88e6xxx_g2_read(chip, MV88E6352_G2_WDOG_CTL, &reg);\n\n\tdev_info(chip->dev, \"Watchdog event: 0x%04x\", reg);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void mv88e6097_watchdog_free(struct mv88e6xxx_chip *chip)\n{\n\tu16 reg;\n\n\tmv88e6xxx_g2_read(chip, MV88E6352_G2_WDOG_CTL, &reg);\n\n\treg &= ~(MV88E6352_G2_WDOG_CTL_EGRESS_ENABLE |\n\t\t MV88E6352_G2_WDOG_CTL_QC_ENABLE);\n\n\tmv88e6xxx_g2_write(chip, MV88E6352_G2_WDOG_CTL, reg);\n}\n\nstatic int mv88e6097_watchdog_setup(struct mv88e6xxx_chip *chip)\n{\n\treturn mv88e6xxx_g2_write(chip, MV88E6352_G2_WDOG_CTL,\n\t\t\t\t  MV88E6352_G2_WDOG_CTL_EGRESS_ENABLE |\n\t\t\t\t  MV88E6352_G2_WDOG_CTL_QC_ENABLE |\n\t\t\t\t  MV88E6352_G2_WDOG_CTL_SWRESET);\n}\n\nconst struct mv88e6xxx_irq_ops mv88e6097_watchdog_ops = {\n\t.irq_action = mv88e6097_watchdog_action,\n\t.irq_setup = mv88e6097_watchdog_setup,\n\t.irq_free = mv88e6097_watchdog_free,\n};\n\nstatic void mv88e6250_watchdog_free(struct mv88e6xxx_chip *chip)\n{\n\tu16 reg;\n\n\tmv88e6xxx_g2_read(chip, MV88E6250_G2_WDOG_CTL, &reg);\n\n\treg &= ~(MV88E6250_G2_WDOG_CTL_EGRESS_ENABLE |\n\t\t MV88E6250_G2_WDOG_CTL_QC_ENABLE);\n\n\tmv88e6xxx_g2_write(chip, MV88E6250_G2_WDOG_CTL, reg);\n}\n\nstatic int mv88e6250_watchdog_setup(struct mv88e6xxx_chip *chip)\n{\n\treturn mv88e6xxx_g2_write(chip, MV88E6250_G2_WDOG_CTL,\n\t\t\t\t  MV88E6250_G2_WDOG_CTL_EGRESS_ENABLE |\n\t\t\t\t  MV88E6250_G2_WDOG_CTL_QC_ENABLE |\n\t\t\t\t  MV88E6250_G2_WDOG_CTL_SWRESET);\n}\n\nconst struct mv88e6xxx_irq_ops mv88e6250_watchdog_ops = {\n\t.irq_action = mv88e6097_watchdog_action,\n\t.irq_setup = mv88e6250_watchdog_setup,\n\t.irq_free = mv88e6250_watchdog_free,\n};\n\nstatic int mv88e6390_watchdog_setup(struct mv88e6xxx_chip *chip)\n{\n\treturn mv88e6xxx_g2_write(chip, MV88E6390_G2_WDOG_CTL,\n\t\t\t\t  MV88E6390_G2_WDOG_CTL_UPDATE |\n\t\t\t\t  MV88E6390_G2_WDOG_CTL_PTR_INT_ENABLE |\n\t\t\t\t  MV88E6390_G2_WDOG_CTL_CUT_THROUGH |\n\t\t\t\t  MV88E6390_G2_WDOG_CTL_QUEUE_CONTROLLER |\n\t\t\t\t  MV88E6390_G2_WDOG_CTL_EGRESS |\n\t\t\t\t  MV88E6390_G2_WDOG_CTL_FORCE_IRQ);\n}\n\nstatic int mv88e6390_watchdog_action(struct mv88e6xxx_chip *chip, int irq)\n{\n\tu16 reg;\n\n\tmv88e6xxx_g2_write(chip, MV88E6390_G2_WDOG_CTL,\n\t\t\t   MV88E6390_G2_WDOG_CTL_PTR_EVENT);\n\tmv88e6xxx_g2_read(chip, MV88E6390_G2_WDOG_CTL, &reg);\n\n\tdev_info(chip->dev, \"Watchdog event: 0x%04x\",\n\t\t reg & MV88E6390_G2_WDOG_CTL_DATA_MASK);\n\n\tmv88e6xxx_g2_write(chip, MV88E6390_G2_WDOG_CTL,\n\t\t\t   MV88E6390_G2_WDOG_CTL_PTR_HISTORY);\n\tmv88e6xxx_g2_read(chip, MV88E6390_G2_WDOG_CTL, &reg);\n\n\tdev_info(chip->dev, \"Watchdog history: 0x%04x\",\n\t\t reg & MV88E6390_G2_WDOG_CTL_DATA_MASK);\n\n\t \n\tif (chip->info->ops->reset)\n\t\tchip->info->ops->reset(chip);\n\n\tmv88e6390_watchdog_setup(chip);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void mv88e6390_watchdog_free(struct mv88e6xxx_chip *chip)\n{\n\tmv88e6xxx_g2_write(chip, MV88E6390_G2_WDOG_CTL,\n\t\t\t   MV88E6390_G2_WDOG_CTL_UPDATE |\n\t\t\t   MV88E6390_G2_WDOG_CTL_PTR_INT_ENABLE);\n}\n\nconst struct mv88e6xxx_irq_ops mv88e6390_watchdog_ops = {\n\t.irq_action = mv88e6390_watchdog_action,\n\t.irq_setup = mv88e6390_watchdog_setup,\n\t.irq_free = mv88e6390_watchdog_free,\n};\n\nstatic int mv88e6393x_watchdog_action(struct mv88e6xxx_chip *chip, int irq)\n{\n\tmv88e6390_watchdog_action(chip, irq);\n\n\t \n\tmv88e6xxx_g2_write(chip, MV88E6390_G2_WDOG_CTL,\n\t\t\t   MV88E6390_G2_WDOG_CTL_UPDATE |\n\t\t\t   MV88E6390_G2_WDOG_CTL_PTR_EVENT);\n\n\treturn IRQ_HANDLED;\n}\n\nconst struct mv88e6xxx_irq_ops mv88e6393x_watchdog_ops = {\n\t.irq_action = mv88e6393x_watchdog_action,\n\t.irq_setup = mv88e6390_watchdog_setup,\n\t.irq_free = mv88e6390_watchdog_free,\n};\n\nstatic irqreturn_t mv88e6xxx_g2_watchdog_thread_fn(int irq, void *dev_id)\n{\n\tstruct mv88e6xxx_chip *chip = dev_id;\n\tirqreturn_t ret = IRQ_NONE;\n\n\tmv88e6xxx_reg_lock(chip);\n\tif (chip->info->ops->watchdog_ops->irq_action)\n\t\tret = chip->info->ops->watchdog_ops->irq_action(chip, irq);\n\tmv88e6xxx_reg_unlock(chip);\n\n\treturn ret;\n}\n\nstatic void mv88e6xxx_g2_watchdog_free(struct mv88e6xxx_chip *chip)\n{\n\tmv88e6xxx_reg_lock(chip);\n\tif (chip->info->ops->watchdog_ops->irq_free)\n\t\tchip->info->ops->watchdog_ops->irq_free(chip);\n\tmv88e6xxx_reg_unlock(chip);\n\n\tfree_irq(chip->watchdog_irq, chip);\n\tirq_dispose_mapping(chip->watchdog_irq);\n}\n\nstatic int mv88e6xxx_g2_watchdog_setup(struct mv88e6xxx_chip *chip)\n{\n\tint err;\n\n\tchip->watchdog_irq = irq_find_mapping(chip->g2_irq.domain,\n\t\t\t\t\t      MV88E6XXX_G2_INT_SOURCE_WATCHDOG);\n\tif (chip->watchdog_irq < 0)\n\t\treturn chip->watchdog_irq;\n\n\tsnprintf(chip->watchdog_irq_name, sizeof(chip->watchdog_irq_name),\n\t\t \"mv88e6xxx-%s-watchdog\", dev_name(chip->dev));\n\n\terr = request_threaded_irq(chip->watchdog_irq, NULL,\n\t\t\t\t   mv88e6xxx_g2_watchdog_thread_fn,\n\t\t\t\t   IRQF_ONESHOT | IRQF_TRIGGER_FALLING,\n\t\t\t\t   chip->watchdog_irq_name, chip);\n\tif (err)\n\t\treturn err;\n\n\tmv88e6xxx_reg_lock(chip);\n\tif (chip->info->ops->watchdog_ops->irq_setup)\n\t\terr = chip->info->ops->watchdog_ops->irq_setup(chip);\n\tmv88e6xxx_reg_unlock(chip);\n\n\treturn err;\n}\n\n \n\nstatic int mv88e6xxx_g2_misc_5_bit_port(struct mv88e6xxx_chip *chip,\n\t\t\t\t\tbool port_5_bit)\n{\n\tu16 val;\n\tint err;\n\n\terr = mv88e6xxx_g2_read(chip, MV88E6XXX_G2_MISC, &val);\n\tif (err)\n\t\treturn err;\n\n\tif (port_5_bit)\n\t\tval |= MV88E6XXX_G2_MISC_5_BIT_PORT;\n\telse\n\t\tval &= ~MV88E6XXX_G2_MISC_5_BIT_PORT;\n\n\treturn mv88e6xxx_g2_write(chip, MV88E6XXX_G2_MISC, val);\n}\n\nint mv88e6xxx_g2_misc_4_bit_port(struct mv88e6xxx_chip *chip)\n{\n\treturn mv88e6xxx_g2_misc_5_bit_port(chip, false);\n}\n\nstatic void mv88e6xxx_g2_irq_mask(struct irq_data *d)\n{\n\tstruct mv88e6xxx_chip *chip = irq_data_get_irq_chip_data(d);\n\tunsigned int n = d->hwirq;\n\n\tchip->g2_irq.masked |= (1 << n);\n}\n\nstatic void mv88e6xxx_g2_irq_unmask(struct irq_data *d)\n{\n\tstruct mv88e6xxx_chip *chip = irq_data_get_irq_chip_data(d);\n\tunsigned int n = d->hwirq;\n\n\tchip->g2_irq.masked &= ~(1 << n);\n}\n\nstatic irqreturn_t mv88e6xxx_g2_irq_thread_fn(int irq, void *dev_id)\n{\n\tstruct mv88e6xxx_chip *chip = dev_id;\n\tunsigned int nhandled = 0;\n\tunsigned int sub_irq;\n\tunsigned int n;\n\tint err;\n\tu16 reg;\n\n\tmv88e6xxx_reg_lock(chip);\n\terr = mv88e6xxx_g2_int_source(chip, &reg);\n\tmv88e6xxx_reg_unlock(chip);\n\tif (err)\n\t\tgoto out;\n\n\tfor (n = 0; n < 16; ++n) {\n\t\tif (reg & (1 << n)) {\n\t\t\tsub_irq = irq_find_mapping(chip->g2_irq.domain, n);\n\t\t\thandle_nested_irq(sub_irq);\n\t\t\t++nhandled;\n\t\t}\n\t}\nout:\n\treturn (nhandled > 0 ? IRQ_HANDLED : IRQ_NONE);\n}\n\nstatic void mv88e6xxx_g2_irq_bus_lock(struct irq_data *d)\n{\n\tstruct mv88e6xxx_chip *chip = irq_data_get_irq_chip_data(d);\n\n\tmv88e6xxx_reg_lock(chip);\n}\n\nstatic void mv88e6xxx_g2_irq_bus_sync_unlock(struct irq_data *d)\n{\n\tstruct mv88e6xxx_chip *chip = irq_data_get_irq_chip_data(d);\n\tint err;\n\n\terr = mv88e6xxx_g2_int_mask(chip, ~chip->g2_irq.masked);\n\tif (err)\n\t\tdev_err(chip->dev, \"failed to mask interrupts\\n\");\n\n\tmv88e6xxx_reg_unlock(chip);\n}\n\nstatic const struct irq_chip mv88e6xxx_g2_irq_chip = {\n\t.name\t\t\t= \"mv88e6xxx-g2\",\n\t.irq_mask\t\t= mv88e6xxx_g2_irq_mask,\n\t.irq_unmask\t\t= mv88e6xxx_g2_irq_unmask,\n\t.irq_bus_lock\t\t= mv88e6xxx_g2_irq_bus_lock,\n\t.irq_bus_sync_unlock\t= mv88e6xxx_g2_irq_bus_sync_unlock,\n};\n\nstatic int mv88e6xxx_g2_irq_domain_map(struct irq_domain *d,\n\t\t\t\t       unsigned int irq,\n\t\t\t\t       irq_hw_number_t hwirq)\n{\n\tstruct mv88e6xxx_chip *chip = d->host_data;\n\n\tirq_set_chip_data(irq, d->host_data);\n\tirq_set_chip_and_handler(irq, &chip->g2_irq.chip, handle_level_irq);\n\tirq_set_noprobe(irq);\n\n\treturn 0;\n}\n\nstatic const struct irq_domain_ops mv88e6xxx_g2_irq_domain_ops = {\n\t.map\t= mv88e6xxx_g2_irq_domain_map,\n\t.xlate\t= irq_domain_xlate_twocell,\n};\n\nvoid mv88e6xxx_g2_irq_free(struct mv88e6xxx_chip *chip)\n{\n\tint irq, virq;\n\n\tmv88e6xxx_g2_watchdog_free(chip);\n\n\tfree_irq(chip->device_irq, chip);\n\tirq_dispose_mapping(chip->device_irq);\n\n\tfor (irq = 0; irq < 16; irq++) {\n\t\tvirq = irq_find_mapping(chip->g2_irq.domain, irq);\n\t\tirq_dispose_mapping(virq);\n\t}\n\n\tirq_domain_remove(chip->g2_irq.domain);\n}\n\nint mv88e6xxx_g2_irq_setup(struct mv88e6xxx_chip *chip)\n{\n\tint err, irq, virq;\n\n\tchip->g2_irq.masked = ~0;\n\tmv88e6xxx_reg_lock(chip);\n\terr = mv88e6xxx_g2_int_mask(chip, ~chip->g2_irq.masked);\n\tmv88e6xxx_reg_unlock(chip);\n\tif (err)\n\t\treturn err;\n\n\tchip->g2_irq.domain = irq_domain_add_simple(\n\t\tchip->dev->of_node, 16, 0, &mv88e6xxx_g2_irq_domain_ops, chip);\n\tif (!chip->g2_irq.domain)\n\t\treturn -ENOMEM;\n\n\tfor (irq = 0; irq < 16; irq++)\n\t\tirq_create_mapping(chip->g2_irq.domain, irq);\n\n\tchip->g2_irq.chip = mv88e6xxx_g2_irq_chip;\n\n\tchip->device_irq = irq_find_mapping(chip->g1_irq.domain,\n\t\t\t\t\t    MV88E6XXX_G1_STS_IRQ_DEVICE);\n\tif (chip->device_irq < 0) {\n\t\terr = chip->device_irq;\n\t\tgoto out;\n\t}\n\n\tsnprintf(chip->device_irq_name, sizeof(chip->device_irq_name),\n\t\t \"mv88e6xxx-%s-g2\", dev_name(chip->dev));\n\n\terr = request_threaded_irq(chip->device_irq, NULL,\n\t\t\t\t   mv88e6xxx_g2_irq_thread_fn,\n\t\t\t\t   IRQF_ONESHOT, chip->device_irq_name, chip);\n\tif (err)\n\t\tgoto out;\n\n\treturn mv88e6xxx_g2_watchdog_setup(chip);\n\nout:\n\tfor (irq = 0; irq < 16; irq++) {\n\t\tvirq = irq_find_mapping(chip->g2_irq.domain, irq);\n\t\tirq_dispose_mapping(virq);\n\t}\n\n\tirq_domain_remove(chip->g2_irq.domain);\n\n\treturn err;\n}\n\nint mv88e6xxx_g2_irq_mdio_setup(struct mv88e6xxx_chip *chip,\n\t\t\t\tstruct mii_bus *bus)\n{\n\tint phy_start = chip->info->internal_phys_offset;\n\tint phy_end = chip->info->internal_phys_offset +\n\t\t      chip->info->num_internal_phys;\n\tint phy, irq;\n\n\tfor (phy = phy_start; phy < phy_end; phy++) {\n\t\tirq = irq_find_mapping(chip->g2_irq.domain, phy);\n\t\tif (irq < 0)\n\t\t\treturn irq;\n\n\t\tbus->irq[chip->info->phy_base_addr + phy] = irq;\n\t}\n\treturn 0;\n}\n\nvoid mv88e6xxx_g2_irq_mdio_free(struct mv88e6xxx_chip *chip,\n\t\t\t\tstruct mii_bus *bus)\n{\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}