{
  "module_name": "phy.c",
  "hash_id": "567c897a79fdf8c3682717f9cc5300d14e540fc14303cd9af46e7cde2e5818f2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/dsa/mv88e6xxx/phy.c",
  "human_readable_source": "\n \n\n#include <linux/mdio.h>\n#include <linux/module.h>\n\n#include \"chip.h\"\n#include \"phy.h\"\n\nint mv88e6165_phy_read(struct mv88e6xxx_chip *chip, struct mii_bus *bus,\n\t\t       int addr, int reg, u16 *val)\n{\n\treturn mv88e6xxx_read(chip, addr, reg, val);\n}\n\nint mv88e6165_phy_write(struct mv88e6xxx_chip *chip, struct mii_bus *bus,\n\t\t\tint addr, int reg, u16 val)\n{\n\treturn mv88e6xxx_write(chip, addr, reg, val);\n}\n\nint mv88e6xxx_phy_read(struct mv88e6xxx_chip *chip, int phy, int reg, u16 *val)\n{\n\tint addr = phy;  \n\tstruct mii_bus *bus;\n\n\tbus = mv88e6xxx_default_mdio_bus(chip);\n\tif (!bus)\n\t\treturn -EOPNOTSUPP;\n\n\tif (!chip->info->ops->phy_read)\n\t\treturn -EOPNOTSUPP;\n\n\treturn chip->info->ops->phy_read(chip, bus, addr, reg, val);\n}\n\nint mv88e6xxx_phy_write(struct mv88e6xxx_chip *chip, int phy, int reg, u16 val)\n{\n\tint addr = phy;  \n\tstruct mii_bus *bus;\n\n\tbus = mv88e6xxx_default_mdio_bus(chip);\n\tif (!bus)\n\t\treturn -EOPNOTSUPP;\n\n\tif (!chip->info->ops->phy_write)\n\t\treturn -EOPNOTSUPP;\n\n\treturn chip->info->ops->phy_write(chip, bus, addr, reg, val);\n}\n\nint mv88e6xxx_phy_read_c45(struct mv88e6xxx_chip *chip, int phy, int devad,\n\t\t\t   int reg, u16 *val)\n{\n\tint addr = phy;  \n\tstruct mii_bus *bus;\n\n\tbus = mv88e6xxx_default_mdio_bus(chip);\n\tif (!bus)\n\t\treturn -EOPNOTSUPP;\n\n\tif (!chip->info->ops->phy_read_c45)\n\t\treturn -EOPNOTSUPP;\n\n\treturn chip->info->ops->phy_read_c45(chip, bus, addr, devad, reg, val);\n}\n\nint mv88e6xxx_phy_write_c45(struct mv88e6xxx_chip *chip, int phy, int devad,\n\t\t\t    int reg, u16 val)\n{\n\tint addr = phy;  \n\tstruct mii_bus *bus;\n\n\tbus = mv88e6xxx_default_mdio_bus(chip);\n\tif (!bus)\n\t\treturn -EOPNOTSUPP;\n\n\tif (!chip->info->ops->phy_write_c45)\n\t\treturn -EOPNOTSUPP;\n\n\treturn chip->info->ops->phy_write_c45(chip, bus, addr, devad, reg, val);\n}\n\nstatic int mv88e6xxx_phy_page_get(struct mv88e6xxx_chip *chip, int phy, u8 page)\n{\n\treturn mv88e6xxx_phy_write(chip, phy, MV88E6XXX_PHY_PAGE, page);\n}\n\nstatic void mv88e6xxx_phy_page_put(struct mv88e6xxx_chip *chip, int phy)\n{\n\tint err;\n\n\t \n\terr = mv88e6xxx_phy_write(chip, phy, MV88E6XXX_PHY_PAGE,\n\t\t\t\t  MV88E6XXX_PHY_PAGE_COPPER);\n\tif (unlikely(err)) {\n\t\tdev_err(chip->dev,\n\t\t\t\"failed to restore PHY %d page Copper (%d)\\n\",\n\t\t\tphy, err);\n\t}\n}\n\nint mv88e6xxx_phy_page_read(struct mv88e6xxx_chip *chip, int phy,\n\t\t\t    u8 page, int reg, u16 *val)\n{\n\tint err;\n\n\t \n\tif (reg == MV88E6XXX_PHY_PAGE)\n\t\treturn -EINVAL;\n\n\terr = mv88e6xxx_phy_page_get(chip, phy, page);\n\tif (!err) {\n\t\terr = mv88e6xxx_phy_read(chip, phy, reg, val);\n\t\tmv88e6xxx_phy_page_put(chip, phy);\n\t}\n\n\treturn err;\n}\n\nint mv88e6xxx_phy_page_write(struct mv88e6xxx_chip *chip, int phy,\n\t\t\t     u8 page, int reg, u16 val)\n{\n\tint err;\n\n\t \n\tif (reg == MV88E6XXX_PHY_PAGE)\n\t\treturn -EINVAL;\n\n\terr = mv88e6xxx_phy_page_get(chip, phy, page);\n\tif (!err) {\n\t\terr = mv88e6xxx_phy_write(chip, phy, MV88E6XXX_PHY_PAGE, page);\n\t\tif (!err)\n\t\t\terr = mv88e6xxx_phy_write(chip, phy, reg, val);\n\n\t\tmv88e6xxx_phy_page_put(chip, phy);\n\t}\n\n\treturn err;\n}\n\nstatic int mv88e6xxx_phy_ppu_disable(struct mv88e6xxx_chip *chip)\n{\n\tif (!chip->info->ops->ppu_disable)\n\t\treturn 0;\n\n\treturn chip->info->ops->ppu_disable(chip);\n}\n\nstatic int mv88e6xxx_phy_ppu_enable(struct mv88e6xxx_chip *chip)\n{\n\tif (!chip->info->ops->ppu_enable)\n\t\treturn 0;\n\n\treturn chip->info->ops->ppu_enable(chip);\n}\n\nstatic void mv88e6xxx_phy_ppu_reenable_work(struct work_struct *ugly)\n{\n\tstruct mv88e6xxx_chip *chip;\n\n\tchip = container_of(ugly, struct mv88e6xxx_chip, ppu_work);\n\n\tmv88e6xxx_reg_lock(chip);\n\n\tif (mutex_trylock(&chip->ppu_mutex)) {\n\t\tif (mv88e6xxx_phy_ppu_enable(chip) == 0)\n\t\t\tchip->ppu_disabled = 0;\n\t\tmutex_unlock(&chip->ppu_mutex);\n\t}\n\n\tmv88e6xxx_reg_unlock(chip);\n}\n\nstatic void mv88e6xxx_phy_ppu_reenable_timer(struct timer_list *t)\n{\n\tstruct mv88e6xxx_chip *chip = from_timer(chip, t, ppu_timer);\n\n\tschedule_work(&chip->ppu_work);\n}\n\nstatic int mv88e6xxx_phy_ppu_access_get(struct mv88e6xxx_chip *chip)\n{\n\tint ret;\n\n\tmutex_lock(&chip->ppu_mutex);\n\n\t \n\tif (!chip->ppu_disabled) {\n\t\tret = mv88e6xxx_phy_ppu_disable(chip);\n\t\tif (ret < 0) {\n\t\t\tmutex_unlock(&chip->ppu_mutex);\n\t\t\treturn ret;\n\t\t}\n\t\tchip->ppu_disabled = 1;\n\t} else {\n\t\tdel_timer(&chip->ppu_timer);\n\t\tret = 0;\n\t}\n\n\treturn ret;\n}\n\nstatic void mv88e6xxx_phy_ppu_access_put(struct mv88e6xxx_chip *chip)\n{\n\t \n\tmod_timer(&chip->ppu_timer, jiffies + msecs_to_jiffies(10));\n\tmutex_unlock(&chip->ppu_mutex);\n}\n\nstatic void mv88e6xxx_phy_ppu_state_init(struct mv88e6xxx_chip *chip)\n{\n\tmutex_init(&chip->ppu_mutex);\n\tINIT_WORK(&chip->ppu_work, mv88e6xxx_phy_ppu_reenable_work);\n\ttimer_setup(&chip->ppu_timer, mv88e6xxx_phy_ppu_reenable_timer, 0);\n}\n\nstatic void mv88e6xxx_phy_ppu_state_destroy(struct mv88e6xxx_chip *chip)\n{\n\tdel_timer_sync(&chip->ppu_timer);\n}\n\nint mv88e6185_phy_ppu_read(struct mv88e6xxx_chip *chip, struct mii_bus *bus,\n\t\t\t   int addr, int reg, u16 *val)\n{\n\tint err;\n\n\terr = mv88e6xxx_phy_ppu_access_get(chip);\n\tif (!err) {\n\t\terr = mv88e6xxx_read(chip, addr, reg, val);\n\t\tmv88e6xxx_phy_ppu_access_put(chip);\n\t}\n\n\treturn err;\n}\n\nint mv88e6185_phy_ppu_write(struct mv88e6xxx_chip *chip, struct mii_bus *bus,\n\t\t\t    int addr, int reg, u16 val)\n{\n\tint err;\n\n\terr = mv88e6xxx_phy_ppu_access_get(chip);\n\tif (!err) {\n\t\terr = mv88e6xxx_write(chip, addr, reg, val);\n\t\tmv88e6xxx_phy_ppu_access_put(chip);\n\t}\n\n\treturn err;\n}\n\nvoid mv88e6xxx_phy_init(struct mv88e6xxx_chip *chip)\n{\n\tif (chip->info->ops->ppu_enable && chip->info->ops->ppu_disable)\n\t\tmv88e6xxx_phy_ppu_state_init(chip);\n}\n\nvoid mv88e6xxx_phy_destroy(struct mv88e6xxx_chip *chip)\n{\n\tif (chip->info->ops->ppu_enable && chip->info->ops->ppu_disable)\n\t\tmv88e6xxx_phy_ppu_state_destroy(chip);\n}\n\nint mv88e6xxx_phy_setup(struct mv88e6xxx_chip *chip)\n{\n\treturn mv88e6xxx_phy_ppu_enable(chip);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}