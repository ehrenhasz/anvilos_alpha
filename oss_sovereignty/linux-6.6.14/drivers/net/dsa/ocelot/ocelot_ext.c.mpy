{
  "module_name": "ocelot_ext.c",
  "hash_id": "7cdbc0d88029df0c24dd1313eaef165e29f9edf631a9096bfc2d4539cc342484",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/dsa/ocelot/ocelot_ext.c",
  "human_readable_source": "\n \n\n#include <linux/mfd/ocelot.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <soc/mscc/ocelot.h>\n#include <soc/mscc/vsc7514_regs.h>\n#include \"felix.h\"\n\n#define VSC7514_NUM_PORTS\t\t11\n\n#define OCELOT_PORT_MODE_SERDES\t\t(OCELOT_PORT_MODE_SGMII | \\\n\t\t\t\t\t OCELOT_PORT_MODE_QSGMII)\n\nstatic const u32 vsc7512_port_modes[VSC7514_NUM_PORTS] = {\n\tOCELOT_PORT_MODE_INTERNAL,\n\tOCELOT_PORT_MODE_INTERNAL,\n\tOCELOT_PORT_MODE_INTERNAL,\n\tOCELOT_PORT_MODE_INTERNAL,\n\tOCELOT_PORT_MODE_SERDES,\n\tOCELOT_PORT_MODE_SERDES,\n\tOCELOT_PORT_MODE_SERDES,\n\tOCELOT_PORT_MODE_SERDES,\n\tOCELOT_PORT_MODE_SERDES,\n\tOCELOT_PORT_MODE_SGMII,\n\tOCELOT_PORT_MODE_SERDES,\n};\n\nstatic const struct ocelot_ops ocelot_ext_ops = {\n\t.reset\t\t= ocelot_reset,\n\t.wm_enc\t\t= ocelot_wm_enc,\n\t.wm_dec\t\t= ocelot_wm_dec,\n\t.wm_stat\t= ocelot_wm_stat,\n\t.port_to_netdev\t= felix_port_to_netdev,\n\t.netdev_to_port\t= felix_netdev_to_port,\n};\n\nstatic const char * const vsc7512_resource_names[TARGET_MAX] = {\n\t[SYS] = \"sys\",\n\t[REW] = \"rew\",\n\t[S0] = \"s0\",\n\t[S1] = \"s1\",\n\t[S2] = \"s2\",\n\t[QS] = \"qs\",\n\t[QSYS] = \"qsys\",\n\t[ANA] = \"ana\",\n};\n\nstatic const struct felix_info vsc7512_info = {\n\t.resource_names\t\t\t= vsc7512_resource_names,\n\t.regfields\t\t\t= vsc7514_regfields,\n\t.map\t\t\t\t= vsc7514_regmap,\n\t.ops\t\t\t\t= &ocelot_ext_ops,\n\t.vcap\t\t\t\t= vsc7514_vcap_props,\n\t.num_mact_rows\t\t\t= 1024,\n\t.num_ports\t\t\t= VSC7514_NUM_PORTS,\n\t.num_tx_queues\t\t\t= OCELOT_NUM_TC,\n\t.port_modes\t\t\t= vsc7512_port_modes,\n\t.phylink_mac_config\t\t= ocelot_phylink_mac_config,\n\t.configure_serdes\t\t= ocelot_port_configure_serdes,\n};\n\nstatic int ocelot_ext_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct dsa_switch *ds;\n\tstruct ocelot *ocelot;\n\tstruct felix *felix;\n\tint err;\n\n\tfelix = kzalloc(sizeof(*felix), GFP_KERNEL);\n\tif (!felix)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(dev, felix);\n\n\tocelot = &felix->ocelot;\n\tocelot->dev = dev;\n\n\tocelot->num_flooding_pgids = 1;\n\n\tfelix->info = &vsc7512_info;\n\n\tds = kzalloc(sizeof(*ds), GFP_KERNEL);\n\tif (!ds) {\n\t\terr = -ENOMEM;\n\t\tdev_err_probe(dev, err, \"Failed to allocate DSA switch\\n\");\n\t\tgoto err_free_felix;\n\t}\n\n\tds->dev = dev;\n\tds->num_ports = felix->info->num_ports;\n\tds->num_tx_queues = felix->info->num_tx_queues;\n\n\tds->ops = &felix_switch_ops;\n\tds->priv = ocelot;\n\tfelix->ds = ds;\n\tfelix->tag_proto = DSA_TAG_PROTO_OCELOT;\n\n\terr = dsa_register_switch(ds);\n\tif (err) {\n\t\tdev_err_probe(dev, err, \"Failed to register DSA switch\\n\");\n\t\tgoto err_free_ds;\n\t}\n\n\treturn 0;\n\nerr_free_ds:\n\tkfree(ds);\nerr_free_felix:\n\tkfree(felix);\n\treturn err;\n}\n\nstatic int ocelot_ext_remove(struct platform_device *pdev)\n{\n\tstruct felix *felix = dev_get_drvdata(&pdev->dev);\n\n\tif (!felix)\n\t\treturn 0;\n\n\tdsa_unregister_switch(felix->ds);\n\n\tkfree(felix->ds);\n\tkfree(felix);\n\n\treturn 0;\n}\n\nstatic void ocelot_ext_shutdown(struct platform_device *pdev)\n{\n\tstruct felix *felix = dev_get_drvdata(&pdev->dev);\n\n\tif (!felix)\n\t\treturn;\n\n\tdsa_switch_shutdown(felix->ds);\n\n\tdev_set_drvdata(&pdev->dev, NULL);\n}\n\nstatic const struct of_device_id ocelot_ext_switch_of_match[] = {\n\t{ .compatible = \"mscc,vsc7512-switch\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, ocelot_ext_switch_of_match);\n\nstatic struct platform_driver ocelot_ext_switch_driver = {\n\t.driver = {\n\t\t.name = \"ocelot-ext-switch\",\n\t\t.of_match_table = ocelot_ext_switch_of_match,\n\t},\n\t.probe = ocelot_ext_probe,\n\t.remove = ocelot_ext_remove,\n\t.shutdown = ocelot_ext_shutdown,\n};\nmodule_platform_driver(ocelot_ext_switch_driver);\n\nMODULE_DESCRIPTION(\"External Ocelot Switch driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_IMPORT_NS(MFD_OCELOT);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}