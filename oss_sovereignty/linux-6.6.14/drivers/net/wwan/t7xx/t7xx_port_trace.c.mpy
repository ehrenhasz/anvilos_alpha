{
  "module_name": "t7xx_port_trace.c",
  "hash_id": "b970095a1fe97fef04638a3f858ac695e8ad142b852f60637120f84bf0b34b3f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wwan/t7xx/t7xx_port_trace.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/relay.h>\n#include <linux/skbuff.h>\n#include <linux/wwan.h>\n\n#include \"t7xx_port.h\"\n#include \"t7xx_port_proxy.h\"\n#include \"t7xx_state_monitor.h\"\n\n#define T7XX_TRC_SUB_BUFF_SIZE\t\t131072\n#define T7XX_TRC_N_SUB_BUFF\t\t32\n\nstatic struct dentry *t7xx_trace_create_buf_file_handler(const char *filename,\n\t\t\t\t\t\t\t struct dentry *parent,\n\t\t\t\t\t\t\t umode_t mode,\n\t\t\t\t\t\t\t struct rchan_buf *buf,\n\t\t\t\t\t\t\t int *is_global)\n{\n\t*is_global = 1;\n\treturn debugfs_create_file(filename, mode, parent, buf,\n\t\t\t\t   &relay_file_operations);\n}\n\nstatic int t7xx_trace_remove_buf_file_handler(struct dentry *dentry)\n{\n\tdebugfs_remove(dentry);\n\treturn 0;\n}\n\nstatic int t7xx_trace_subbuf_start_handler(struct rchan_buf *buf, void *subbuf,\n\t\t\t\t\t   void *prev_subbuf, size_t prev_padding)\n{\n\tif (relay_buf_full(buf)) {\n\t\tpr_err_ratelimited(\"Relay_buf full dropping traces\");\n\t\treturn 0;\n\t}\n\n\treturn 1;\n}\n\nstatic struct rchan_callbacks relay_callbacks = {\n\t.subbuf_start = t7xx_trace_subbuf_start_handler,\n\t.create_buf_file = t7xx_trace_create_buf_file_handler,\n\t.remove_buf_file = t7xx_trace_remove_buf_file_handler,\n};\n\nstatic void t7xx_trace_port_uninit(struct t7xx_port *port)\n{\n\tstruct dentry *debugfs_dir = port->t7xx_dev->debugfs_dir;\n\tstruct rchan *relaych = port->log.relaych;\n\n\tif (!relaych)\n\t\treturn;\n\n\trelay_close(relaych);\n\tdebugfs_remove_recursive(debugfs_dir);\n}\n\nstatic int t7xx_trace_port_recv_skb(struct t7xx_port *port, struct sk_buff *skb)\n{\n\tstruct rchan *relaych = port->log.relaych;\n\n\tif (!relaych)\n\t\treturn -EINVAL;\n\n\trelay_write(relaych, skb->data, skb->len);\n\tdev_kfree_skb(skb);\n\treturn 0;\n}\n\nstatic void t7xx_port_trace_md_state_notify(struct t7xx_port *port, unsigned int state)\n{\n\tstruct rchan *relaych = port->log.relaych;\n\tstruct dentry *debugfs_wwan_dir;\n\tstruct dentry *debugfs_dir;\n\n\tif (state != MD_STATE_READY || relaych)\n\t\treturn;\n\n\tdebugfs_wwan_dir = wwan_get_debugfs_dir(port->dev);\n\tif (IS_ERR(debugfs_wwan_dir))\n\t\treturn;\n\n\tdebugfs_dir = debugfs_create_dir(KBUILD_MODNAME, debugfs_wwan_dir);\n\tif (IS_ERR_OR_NULL(debugfs_dir)) {\n\t\twwan_put_debugfs_dir(debugfs_wwan_dir);\n\t\tdev_err(port->dev, \"Unable to create debugfs for trace\");\n\t\treturn;\n\t}\n\n\trelaych = relay_open(\"relay_ch\", debugfs_dir, T7XX_TRC_SUB_BUFF_SIZE,\n\t\t\t     T7XX_TRC_N_SUB_BUFF, &relay_callbacks, NULL);\n\tif (!relaych)\n\t\tgoto err_rm_debugfs_dir;\n\n\twwan_put_debugfs_dir(debugfs_wwan_dir);\n\tport->log.relaych = relaych;\n\tport->t7xx_dev->debugfs_dir = debugfs_dir;\n\treturn;\n\nerr_rm_debugfs_dir:\n\tdebugfs_remove_recursive(debugfs_dir);\n\twwan_put_debugfs_dir(debugfs_wwan_dir);\n\tdev_err(port->dev, \"Unable to create trace port %s\", port->port_conf->name);\n}\n\nstruct port_ops t7xx_trace_port_ops = {\n\t.recv_skb = t7xx_trace_port_recv_skb,\n\t.uninit = t7xx_trace_port_uninit,\n\t.md_state_notify = t7xx_port_trace_md_state_notify,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}