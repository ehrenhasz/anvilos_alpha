{
  "module_name": "iosm_ipc_coredump.c",
  "hash_id": "917d4fdc43cfddde0e7abd2f7f5d889581f93463970a8b0de5cd052153f58c0d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wwan/iosm/iosm_ipc_coredump.c",
  "human_readable_source": "\n \n#include <linux/vmalloc.h>\n\n#include \"iosm_ipc_coredump.h\"\n\n \nint ipc_coredump_collect(struct iosm_devlink *devlink, u8 **data, int entry,\n\t\t\t u32 region_size)\n{\n\tint ret, bytes_to_read, bytes_read = 0, i = 0;\n\ts32 remaining;\n\tu8 *data_ptr;\n\n\tdata_ptr = vmalloc(region_size);\n\tif (!data_ptr)\n\t\treturn -ENOMEM;\n\n\tremaining = devlink->cd_file_info[entry].actual_size;\n\tret = ipc_devlink_send_cmd(devlink, rpsi_cmd_coredump_get, entry);\n\tif (ret) {\n\t\tdev_err(devlink->dev, \"Send coredump_get cmd failed\");\n\t\tgoto get_cd_fail;\n\t}\n\twhile (remaining > 0) {\n\t\tbytes_to_read = min(remaining, MAX_DATA_SIZE);\n\t\tbytes_read = 0;\n\t\tret = ipc_imem_sys_devlink_read(devlink, data_ptr + i,\n\t\t\t\t\t\tbytes_to_read, &bytes_read);\n\t\tif (ret) {\n\t\t\tdev_err(devlink->dev, \"CD data read failed\");\n\t\t\tgoto get_cd_fail;\n\t\t}\n\t\tremaining -= bytes_read;\n\t\ti += bytes_read;\n\t}\n\n\t*data = data_ptr;\n\n\treturn 0;\n\nget_cd_fail:\n\tvfree(data_ptr);\n\treturn ret;\n}\n\n \nint ipc_coredump_get_list(struct iosm_devlink *devlink, u16 cmd)\n{\n\tu32 byte_read, num_entries, file_size;\n\tstruct iosm_cd_table *cd_table;\n\tu8 size[MAX_SIZE_LEN], i;\n\tchar *filename;\n\tint ret;\n\n\tcd_table = kzalloc(MAX_CD_LIST_SIZE, GFP_KERNEL);\n\tif (!cd_table) {\n\t\tret = -ENOMEM;\n\t\tgoto  cd_init_fail;\n\t}\n\n\tret = ipc_devlink_send_cmd(devlink, cmd, MAX_CD_LIST_SIZE);\n\tif (ret) {\n\t\tdev_err(devlink->dev, \"rpsi_cmd_coredump_start failed\");\n\t\tgoto cd_init_fail;\n\t}\n\n\tret = ipc_imem_sys_devlink_read(devlink, (u8 *)cd_table,\n\t\t\t\t\tMAX_CD_LIST_SIZE, &byte_read);\n\tif (ret) {\n\t\tdev_err(devlink->dev, \"Coredump data is invalid\");\n\t\tgoto cd_init_fail;\n\t}\n\n\tif (byte_read != MAX_CD_LIST_SIZE)\n\t\tgoto cd_init_fail;\n\n\tif (cmd == rpsi_cmd_coredump_start) {\n\t\tnum_entries = le32_to_cpu(cd_table->list.num_entries);\n\t\tif (num_entries == 0 || num_entries > IOSM_NOF_CD_REGION) {\n\t\t\tret = -EINVAL;\n\t\t\tgoto cd_init_fail;\n\t\t}\n\n\t\tfor (i = 0; i < num_entries; i++) {\n\t\t\tfile_size = le32_to_cpu(cd_table->list.entry[i].size);\n\t\t\tfilename = cd_table->list.entry[i].filename;\n\n\t\t\tif (file_size > devlink->cd_file_info[i].default_size) {\n\t\t\t\tret = -EINVAL;\n\t\t\t\tgoto cd_init_fail;\n\t\t\t}\n\n\t\t\tdevlink->cd_file_info[i].actual_size = file_size;\n\t\t\tdev_dbg(devlink->dev, \"file: %s actual size %d\",\n\t\t\t\tfilename, file_size);\n\t\t\tdevlink_flash_update_status_notify(devlink->devlink_ctx,\n\t\t\t\t\t\t\t   filename,\n\t\t\t\t\t\t\t   \"FILENAME\", 0, 0);\n\t\t\tsnprintf(size, sizeof(size), \"%d\", file_size);\n\t\t\tdevlink_flash_update_status_notify(devlink->devlink_ctx,\n\t\t\t\t\t\t\t   size, \"FILE SIZE\",\n\t\t\t\t\t\t\t   0, 0);\n\t\t}\n\t}\n\ncd_init_fail:\n\tkfree(cd_table);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}