{
  "module_name": "iosm_ipc_irq.c",
  "hash_id": "d43b27e60115f726b1e725aceaf2eb7c2a1ae1a6585f0c0b8a072c502bd8db84",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wwan/iosm/iosm_ipc_irq.c",
  "human_readable_source": "\n \n\n#include \"iosm_ipc_pcie.h\"\n#include \"iosm_ipc_protocol.h\"\n\nstatic void ipc_write_dbell_reg(struct iosm_pcie *ipc_pcie, int irq_n, u32 data)\n{\n\tvoid __iomem *write_reg;\n\n\t \n\twrite_reg = (void __iomem *)((u8 __iomem *)ipc_pcie->ipc_regs +\n\t\t\t\t     ipc_pcie->doorbell_write +\n\t\t\t\t     (irq_n * ipc_pcie->doorbell_reg_offset));\n\n\t \n\tiowrite32(data, write_reg);\n}\n\nvoid ipc_doorbell_fire(struct iosm_pcie *ipc_pcie, int irq_n, u32 data)\n{\n\tipc_write_dbell_reg(ipc_pcie, irq_n, data);\n}\n\n \nstatic irqreturn_t ipc_msi_interrupt(int irq, void *dev_id)\n{\n\tstruct iosm_pcie *ipc_pcie = dev_id;\n\tint instance = irq - ipc_pcie->pci->irq;\n\n\t \n\tif (instance >= ipc_pcie->nvec)\n\t\treturn IRQ_NONE;\n\n\tif (!test_bit(0, &ipc_pcie->suspend))\n\t\tipc_imem_irq_process(ipc_pcie->imem, instance);\n\n\treturn IRQ_HANDLED;\n}\n\nvoid ipc_release_irq(struct iosm_pcie *ipc_pcie)\n{\n\tstruct pci_dev *pdev = ipc_pcie->pci;\n\n\tif (pdev->msi_enabled) {\n\t\twhile (--ipc_pcie->nvec >= 0)\n\t\t\tfree_irq(pdev->irq + ipc_pcie->nvec, ipc_pcie);\n\t}\n\tpci_free_irq_vectors(pdev);\n}\n\nint ipc_acquire_irq(struct iosm_pcie *ipc_pcie)\n{\n\tstruct pci_dev *pdev = ipc_pcie->pci;\n\tint i, rc = -EINVAL;\n\n\tipc_pcie->nvec = pci_alloc_irq_vectors(pdev, IPC_MSI_VECTORS,\n\t\t\t\t\t       IPC_MSI_VECTORS, PCI_IRQ_MSI);\n\n\tif (ipc_pcie->nvec < 0) {\n\t\trc = ipc_pcie->nvec;\n\t\tgoto error;\n\t}\n\n\tif (!pdev->msi_enabled)\n\t\tgoto error;\n\n\tfor (i = 0; i < ipc_pcie->nvec; ++i) {\n\t\trc = request_threaded_irq(pdev->irq + i, NULL,\n\t\t\t\t\t  ipc_msi_interrupt, IRQF_ONESHOT,\n\t\t\t\t\t  KBUILD_MODNAME, ipc_pcie);\n\t\tif (rc) {\n\t\t\tdev_err(ipc_pcie->dev, \"unable to grab IRQ, rc=%d\", rc);\n\t\t\tipc_pcie->nvec = i;\n\t\t\tipc_release_irq(ipc_pcie);\n\t\t\tgoto error;\n\t\t}\n\t}\n\nerror:\n\treturn rc;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}