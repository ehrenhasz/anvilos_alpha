{
  "module_name": "fjes_hw.h",
  "hash_id": "ae51ce38793629f13f81f739c650a3b2f572ca5dd87283e10ce37c403303e2c3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/fjes/fjes_hw.h",
  "human_readable_source": " \n \n\n#ifndef FJES_HW_H_\n#define FJES_HW_H_\n\n#include <linux/netdevice.h>\n#include <linux/if_vlan.h>\n#include <linux/vmalloc.h>\n\n#include \"fjes_regs.h\"\n\nstruct fjes_hw;\n\n#define EP_BUFFER_SUPPORT_VLAN_MAX 4\n#define EP_BUFFER_INFO_SIZE 4096\n\n#define FJES_DEBUG_PAGE_SIZE 4096\n#define FJES_DEBUG_BUFFER_SIZE\t(16 * FJES_DEBUG_PAGE_SIZE)\n\n#define FJES_DEVICE_RESET_TIMEOUT  ((17 + 1) * 3 * 8)  \n#define FJES_COMMAND_REQ_TIMEOUT  ((5 + 1) * 3 * 8)  \n#define FJES_COMMAND_REQ_BUFF_TIMEOUT\t(60 * 3)  \n#define FJES_COMMAND_EPSTOP_WAIT_TIMEOUT\t(1)  \n\n#define FJES_CMD_REQ_ERR_INFO_PARAM  (0x0001)\n#define FJES_CMD_REQ_ERR_INFO_STATUS (0x0002)\n\n#define FJES_CMD_REQ_RES_CODE_NORMAL (0)\n#define FJES_CMD_REQ_RES_CODE_BUSY   (1)\n\n#define FJES_ZONING_STATUS_DISABLE\t(0x00)\n#define FJES_ZONING_STATUS_ENABLE\t(0x01)\n#define FJES_ZONING_STATUS_INVALID\t(0xFF)\n\n#define FJES_ZONING_ZONE_TYPE_NONE (0xFF)\n\n#define FJES_TX_DELAY_SEND_NONE\t\t(0)\n#define FJES_TX_DELAY_SEND_PENDING\t(1)\n\n#define FJES_RX_STOP_REQ_NONE\t\t(0x0)\n#define FJES_RX_STOP_REQ_DONE\t\t(0x1)\n#define FJES_RX_STOP_REQ_REQUEST\t(0x2)\n#define FJES_RX_POLL_WORK\t\t(0x4)\n#define FJES_RX_MTU_CHANGING_DONE\t(0x8)\n\n#define EP_BUFFER_SIZE \\\n\t(((sizeof(union ep_buffer_info) + (128 * (64 * 1024))) \\\n\t\t/ EP_BUFFER_INFO_SIZE) * EP_BUFFER_INFO_SIZE)\n\n#define EP_RING_NUM(buffer_size, frame_size) \\\n\t\t(u32)((buffer_size) / (frame_size))\n#define EP_RING_INDEX(_num, _max) (((_num) + (_max)) % (_max))\n#define EP_RING_INDEX_INC(_num, _max) \\\n\t((_num) = EP_RING_INDEX((_num) + 1, (_max)))\n#define EP_RING_FULL(_head, _tail, _max)\t\t\t\t\\\n\t(0 == EP_RING_INDEX(((_tail) - (_head)), (_max)))\n#define EP_RING_EMPTY(_head, _tail, _max) \\\n\t(1 == EP_RING_INDEX(((_tail) - (_head)), (_max)))\n\n#define FJES_MTU_TO_BUFFER_SIZE(mtu) \\\n\t(ETH_HLEN + VLAN_HLEN + (mtu) + ETH_FCS_LEN)\n#define FJES_MTU_TO_FRAME_SIZE(mtu) \\\n\t(sizeof(struct esmem_frame) + FJES_MTU_TO_BUFFER_SIZE(mtu))\n#define FJES_MTU_DEFINE(size) \\\n\t((size) - sizeof(struct esmem_frame) - \\\n\t(ETH_HLEN + VLAN_HLEN + ETH_FCS_LEN))\n\n#define FJES_DEV_COMMAND_INFO_REQ_LEN\t(4)\n#define FJES_DEV_COMMAND_INFO_RES_LEN(epnum) (8 + 2 * (epnum))\n#define FJES_DEV_COMMAND_SHARE_BUFFER_REQ_LEN(txb, rxb) \\\n\t(24 + (8 * ((txb) / EP_BUFFER_INFO_SIZE + (rxb) / EP_BUFFER_INFO_SIZE)))\n#define FJES_DEV_COMMAND_SHARE_BUFFER_RES_LEN\t(8)\n#define FJES_DEV_COMMAND_UNSHARE_BUFFER_REQ_LEN\t(8)\n#define FJES_DEV_COMMAND_UNSHARE_BUFFER_RES_LEN\t(8)\n\n#define FJES_DEV_REQ_BUF_SIZE(maxep) \\\n\tFJES_DEV_COMMAND_SHARE_BUFFER_REQ_LEN(EP_BUFFER_SIZE, EP_BUFFER_SIZE)\n#define FJES_DEV_RES_BUF_SIZE(maxep) \\\n\tFJES_DEV_COMMAND_INFO_RES_LEN(maxep)\n\n#define FJES_DEV_COMMAND_START_DBG_REQ_LEN(byte) \\\n\t(16 + (8 * (byte) / FJES_DEBUG_PAGE_SIZE))\n#define FJES_DEV_COMMAND_START_DBG_RES_LEN (8)\n#define FJES_DEV_COMMAND_STOP_DBG_REQ_LEN (4)\n#define FJES_DEV_COMMAND_STOP_DBG_RES_LEN (8)\n\n \nstruct esmem_frame {\n\t__le32 frame_size;\n\tu8 frame_data[];\n};\n\n \nenum ep_partner_status {\n\tEP_PARTNER_UNSHARE,\n\tEP_PARTNER_SHARED,\n\tEP_PARTNER_WAITING,\n\tEP_PARTNER_COMPLETE,\n\tEP_PARTNER_STATUS_MAX,\n};\n\n \nstruct fjes_device_shared_info {\n\tint epnum;\n\tu8 ep_status[];\n};\n\n \nunion fjes_device_command_req {\n\tstruct {\n\t\t__le32 length;\n\t} info;\n\tstruct {\n\t\t__le32 length;\n\t\t__le32 epid;\n\t\t__le64 buffer[];\n\t} share_buffer;\n\tstruct {\n\t\t__le32 length;\n\t\t__le32 epid;\n\t} unshare_buffer;\n\tstruct {\n\t\t__le32 length;\n\t\t__le32 mode;\n\t\t__le64 buffer_len;\n\t\t__le64 buffer[];\n\t} start_trace;\n\tstruct {\n\t\t__le32 length;\n\t} stop_trace;\n};\n\n \nunion fjes_device_command_res {\n\tstruct {\n\t\t__le32 length;\n\t\t__le32 code;\n\t\tstruct {\n\t\t\tu8 es_status;\n\t\t\tu8 zone;\n\t\t} info[];\n\t} info;\n\tstruct {\n\t\t__le32 length;\n\t\t__le32 code;\n\t} share_buffer;\n\tstruct {\n\t\t__le32 length;\n\t\t__le32 code;\n\t} unshare_buffer;\n\tstruct {\n\t\t__le32 length;\n\t\t__le32 code;\n\t} start_trace;\n\tstruct {\n\t\t__le32 length;\n\t\t__le32 code;\n\t} stop_trace;\n};\n\n \nenum fjes_dev_command_request_type {\n\tFJES_CMD_REQ_INFO\t\t= 0x0001,\n\tFJES_CMD_REQ_SHARE_BUFFER\t= 0x0002,\n\tFJES_CMD_REQ_UNSHARE_BUFFER\t= 0x0004,\n\tFJES_CMD_REQ_START_DEBUG\t= 0x0100,\n\tFJES_CMD_REQ_STOP_DEBUG\t\t= 0x0200,\n};\n\n \nstruct fjes_device_command_param {\n\tu32 req_len;\n\tphys_addr_t req_start;\n\tu32 res_len;\n\tphys_addr_t res_start;\n\tphys_addr_t share_start;\n};\n\n \nenum fjes_dev_command_response_e {\n\tFJES_CMD_STATUS_UNKNOWN,\n\tFJES_CMD_STATUS_NORMAL,\n\tFJES_CMD_STATUS_TIMEOUT,\n\tFJES_CMD_STATUS_ERROR_PARAM,\n\tFJES_CMD_STATUS_ERROR_STATUS,\n};\n\n \nunion ep_buffer_info {\n\tu8 raw[EP_BUFFER_INFO_SIZE];\n\n\tstruct _ep_buffer_info_common_t {\n\t\tu32 version;\n\t} common;\n\n\tstruct _ep_buffer_info_v1_t {\n\t\tu32 version;\n\t\tu32 info_size;\n\n\t\tu32 buffer_size;\n\t\tu16 count_max;\n\n\t\tu16 _rsv_1;\n\n\t\tu32 frame_max;\n\t\tu8 mac_addr[ETH_ALEN];\n\n\t\tu16 _rsv_2;\n\t\tu32 _rsv_3;\n\n\t\tu16 tx_status;\n\t\tu16 rx_status;\n\n\t\tu32 head;\n\t\tu32 tail;\n\n\t\tu16 vlan_id[EP_BUFFER_SUPPORT_VLAN_MAX];\n\n\t} v1i;\n\n};\n\n \nstruct fjes_drv_ep_stats {\n\tu64 com_regist_buf_exec;\n\tu64 com_unregist_buf_exec;\n\tu64 send_intr_rx;\n\tu64 send_intr_unshare;\n\tu64 send_intr_zoneupdate;\n\tu64 recv_intr_rx;\n\tu64 recv_intr_unshare;\n\tu64 recv_intr_stop;\n\tu64 recv_intr_zoneupdate;\n\tu64 tx_buffer_full;\n\tu64 tx_dropped_not_shared;\n\tu64 tx_dropped_ver_mismatch;\n\tu64 tx_dropped_buf_size_mismatch;\n\tu64 tx_dropped_vlanid_mismatch;\n};\n\n \nstruct ep_share_mem_info {\n\tstruct epbuf_handler {\n\t\tvoid *buffer;\n\t\tsize_t size;\n\t\tunion ep_buffer_info *info;\n\t\tu8 *ring;\n\t} tx, rx;\n\n\tstruct rtnl_link_stats64 net_stats;\n\tstruct fjes_drv_ep_stats ep_stats;\n\n\tu16 tx_status_work;\n\n\tu8 es_status;\n\tu8 zone;\n};\n\nstruct es_device_trace {\n\tu32 record_num;\n\tu32 current_record;\n\tu32 status_flag;\n\tu32 _rsv;\n\n\tstruct {\n\t\t\tu16 epid;\n\t\t\tu16 dir_offset;\n\t\t\tu32 data;\n\t\t\tu64 tsc;\n\t} record[];\n};\n\nstruct fjes_hw_info {\n\tstruct fjes_device_shared_info *share;\n\tunion fjes_device_command_req *req_buf;\n\tu64 req_buf_size;\n\tunion fjes_device_command_res *res_buf;\n\tu64 res_buf_size;\n\n\tint *my_epid;\n\tint *max_epid;\n\n\tstruct es_device_trace *trace;\n\tu64 trace_size;\n\n\tstruct mutex lock;  \n\n\tunsigned long buffer_share_bit;\n\tunsigned long buffer_unshare_reserve_bit;\n};\n\nstruct fjes_hw {\n\tvoid *back;\n\n\tunsigned long txrx_stop_req_bit;\n\tunsigned long epstop_req_bit;\n\tstruct work_struct update_zone_task;\n\tstruct work_struct epstop_task;\n\n\tint my_epid;\n\tint max_epid;\n\n\tstruct ep_share_mem_info *ep_shm_info;\n\n\tstruct fjes_hw_resource {\n\t\tu64 start;\n\t\tu64 size;\n\t\tint irq;\n\t} hw_res;\n\n\tu8 *base;\n\n\tstruct fjes_hw_info hw_info;\n\n\tspinlock_t rx_status_lock;  \n\n\tu32 debug_mode;\n};\n\nint fjes_hw_init(struct fjes_hw *);\nvoid fjes_hw_exit(struct fjes_hw *);\nint fjes_hw_reset(struct fjes_hw *);\nint fjes_hw_request_info(struct fjes_hw *);\nint fjes_hw_register_buff_addr(struct fjes_hw *, int,\n\t\t\t       struct ep_share_mem_info *);\nint fjes_hw_unregister_buff_addr(struct fjes_hw *, int);\nvoid fjes_hw_init_command_registers(struct fjes_hw *,\n\t\t\t\t    struct fjes_device_command_param *);\nvoid fjes_hw_setup_epbuf(struct epbuf_handler *, const u8 *, u32);\nint fjes_hw_raise_interrupt(struct fjes_hw *, int, enum REG_ICTL_MASK);\nvoid fjes_hw_set_irqmask(struct fjes_hw *, enum REG_ICTL_MASK, bool);\nu32 fjes_hw_capture_interrupt_status(struct fjes_hw *);\nvoid fjes_hw_raise_epstop(struct fjes_hw *);\nint fjes_hw_wait_epstop(struct fjes_hw *);\nenum ep_partner_status\n\tfjes_hw_get_partner_ep_status(struct fjes_hw *, int);\n\nbool fjes_hw_epid_is_same_zone(struct fjes_hw *, int);\nint fjes_hw_epid_is_shared(struct fjes_device_shared_info *, int);\nbool fjes_hw_check_epbuf_version(struct epbuf_handler *, u32);\nbool fjes_hw_check_mtu(struct epbuf_handler *, u32);\nbool fjes_hw_check_vlan_id(struct epbuf_handler *, u16);\nbool fjes_hw_set_vlan_id(struct epbuf_handler *, u16);\nvoid fjes_hw_del_vlan_id(struct epbuf_handler *, u16);\nbool fjes_hw_epbuf_rx_is_empty(struct epbuf_handler *);\nvoid *fjes_hw_epbuf_rx_curpkt_get_addr(struct epbuf_handler *, size_t *);\nvoid fjes_hw_epbuf_rx_curpkt_drop(struct epbuf_handler *);\nint fjes_hw_epbuf_tx_pkt_send(struct epbuf_handler *, void *, size_t);\n\nint fjes_hw_start_debug(struct fjes_hw *);\nint fjes_hw_stop_debug(struct fjes_hw *);\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}