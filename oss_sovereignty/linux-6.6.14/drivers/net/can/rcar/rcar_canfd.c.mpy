{
  "module_name": "rcar_canfd.c",
  "hash_id": "3f1a61be69322bdf91ddfada99a93de90d52c07fc2379592f83d2f9c81ff7af7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/can/rcar/rcar_canfd.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/bitmap.h>\n#include <linux/bitops.h>\n#include <linux/can/dev.h>\n#include <linux/clk.h>\n#include <linux/errno.h>\n#include <linux/ethtool.h>\n#include <linux/interrupt.h>\n#include <linux/iopoll.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/netdevice.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/reset.h>\n#include <linux/types.h>\n\n#define RCANFD_DRV_NAME\t\t\t\"rcar_canfd\"\n\n \n\n \n#define RCANFD_GRMCFG_RCMC\t\tBIT(0)\n\n \n#define RCANFD_GCFG_EEFE\t\tBIT(6)\n#define RCANFD_GCFG_CMPOC\t\tBIT(5)\t \n#define RCANFD_GCFG_DCS\t\t\tBIT(4)\n#define RCANFD_GCFG_DCE\t\t\tBIT(1)\n#define RCANFD_GCFG_TPRI\t\tBIT(0)\n\n \n#define RCANFD_GCTR_TSRST\t\tBIT(16)\n#define RCANFD_GCTR_CFMPOFIE\t\tBIT(11)\t \n#define RCANFD_GCTR_THLEIE\t\tBIT(10)\n#define RCANFD_GCTR_MEIE\t\tBIT(9)\n#define RCANFD_GCTR_DEIE\t\tBIT(8)\n#define RCANFD_GCTR_GSLPR\t\tBIT(2)\n#define RCANFD_GCTR_GMDC_MASK\t\t(0x3)\n#define RCANFD_GCTR_GMDC_GOPM\t\t(0x0)\n#define RCANFD_GCTR_GMDC_GRESET\t\t(0x1)\n#define RCANFD_GCTR_GMDC_GTEST\t\t(0x2)\n\n \n#define RCANFD_GSTS_GRAMINIT\t\tBIT(3)\n#define RCANFD_GSTS_GSLPSTS\t\tBIT(2)\n#define RCANFD_GSTS_GHLTSTS\t\tBIT(1)\n#define RCANFD_GSTS_GRSTSTS\t\tBIT(0)\n \n#define RCANFD_GSTS_GNOPM\t\t(BIT(0) | BIT(1) | BIT(2) | BIT(3))\n\n \n#define RCANFD_GERFL_EEF0_7\t\tGENMASK(23, 16)\n#define RCANFD_GERFL_EEF(ch)\t\tBIT(16 + (ch))\n#define RCANFD_GERFL_CMPOF\t\tBIT(3)\t \n#define RCANFD_GERFL_THLES\t\tBIT(2)\n#define RCANFD_GERFL_MES\t\tBIT(1)\n#define RCANFD_GERFL_DEF\t\tBIT(0)\n\n#define RCANFD_GERFL_ERR(gpriv, x) \\\n\t((x) & (reg_gen4(gpriv, RCANFD_GERFL_EEF0_7, \\\n\t\t\t RCANFD_GERFL_EEF(0) | RCANFD_GERFL_EEF(1)) | \\\n\t\tRCANFD_GERFL_MES | \\\n\t\t((gpriv)->fdmode ? RCANFD_GERFL_CMPOF : 0)))\n\n \n\n \n#define RCANFD_GAFLCFG_SETRNC(gpriv, n, x) \\\n\t(((x) & reg_gen4(gpriv, 0x1ff, 0xff)) << \\\n\t (reg_gen4(gpriv, 16, 24) - ((n) & 1) * reg_gen4(gpriv, 16, 8)))\n\n#define RCANFD_GAFLCFG_GETRNC(gpriv, n, x) \\\n\t(((x) >> (reg_gen4(gpriv, 16, 24) - ((n) & 1) * reg_gen4(gpriv, 16, 8))) & \\\n\t reg_gen4(gpriv, 0x1ff, 0xff))\n\n \n#define RCANFD_GAFLECTR_AFLDAE\t\tBIT(8)\n#define RCANFD_GAFLECTR_AFLPN(gpriv, x)\t((x) & reg_gen4(gpriv, 0x7f, 0x1f))\n\n \n#define RCANFD_GAFLID_GAFLLB\t\tBIT(29)\n\n \n#define RCANFD_GAFLP1_GAFLFDP(x)\t(1 << (x))\n\n \n\n \n#define RCANFD_CFG_SJW(x)\t\t(((x) & 0x3) << 24)\n#define RCANFD_CFG_TSEG2(x)\t\t(((x) & 0x7) << 20)\n#define RCANFD_CFG_TSEG1(x)\t\t(((x) & 0xf) << 16)\n#define RCANFD_CFG_BRP(x)\t\t(((x) & 0x3ff) << 0)\n\n \n#define RCANFD_NCFG_NTSEG2(gpriv, x) \\\n\t(((x) & reg_gen4(gpriv, 0x7f, 0x1f)) << reg_gen4(gpriv, 25, 24))\n\n#define RCANFD_NCFG_NTSEG1(gpriv, x) \\\n\t(((x) & reg_gen4(gpriv, 0xff, 0x7f)) << reg_gen4(gpriv, 17, 16))\n\n#define RCANFD_NCFG_NSJW(gpriv, x) \\\n\t(((x) & reg_gen4(gpriv, 0x7f, 0x1f)) << reg_gen4(gpriv, 10, 11))\n\n#define RCANFD_NCFG_NBRP(x)\t\t(((x) & 0x3ff) << 0)\n\n \n#define RCANFD_CCTR_CTME\t\tBIT(24)\n#define RCANFD_CCTR_ERRD\t\tBIT(23)\n#define RCANFD_CCTR_BOM_MASK\t\t(0x3 << 21)\n#define RCANFD_CCTR_BOM_ISO\t\t(0x0 << 21)\n#define RCANFD_CCTR_BOM_BENTRY\t\t(0x1 << 21)\n#define RCANFD_CCTR_BOM_BEND\t\t(0x2 << 21)\n#define RCANFD_CCTR_TDCVFIE\t\tBIT(19)\n#define RCANFD_CCTR_SOCOIE\t\tBIT(18)\n#define RCANFD_CCTR_EOCOIE\t\tBIT(17)\n#define RCANFD_CCTR_TAIE\t\tBIT(16)\n#define RCANFD_CCTR_ALIE\t\tBIT(15)\n#define RCANFD_CCTR_BLIE\t\tBIT(14)\n#define RCANFD_CCTR_OLIE\t\tBIT(13)\n#define RCANFD_CCTR_BORIE\t\tBIT(12)\n#define RCANFD_CCTR_BOEIE\t\tBIT(11)\n#define RCANFD_CCTR_EPIE\t\tBIT(10)\n#define RCANFD_CCTR_EWIE\t\tBIT(9)\n#define RCANFD_CCTR_BEIE\t\tBIT(8)\n#define RCANFD_CCTR_CSLPR\t\tBIT(2)\n#define RCANFD_CCTR_CHMDC_MASK\t\t(0x3)\n#define RCANFD_CCTR_CHDMC_COPM\t\t(0x0)\n#define RCANFD_CCTR_CHDMC_CRESET\t(0x1)\n#define RCANFD_CCTR_CHDMC_CHLT\t\t(0x2)\n\n \n#define RCANFD_CSTS_COMSTS\t\tBIT(7)\n#define RCANFD_CSTS_RECSTS\t\tBIT(6)\n#define RCANFD_CSTS_TRMSTS\t\tBIT(5)\n#define RCANFD_CSTS_BOSTS\t\tBIT(4)\n#define RCANFD_CSTS_EPSTS\t\tBIT(3)\n#define RCANFD_CSTS_SLPSTS\t\tBIT(2)\n#define RCANFD_CSTS_HLTSTS\t\tBIT(1)\n#define RCANFD_CSTS_CRSTSTS\t\tBIT(0)\n\n#define RCANFD_CSTS_TECCNT(x)\t\t(((x) >> 24) & 0xff)\n#define RCANFD_CSTS_RECCNT(x)\t\t(((x) >> 16) & 0xff)\n\n \n#define RCANFD_CERFL_ADERR\t\tBIT(14)\n#define RCANFD_CERFL_B0ERR\t\tBIT(13)\n#define RCANFD_CERFL_B1ERR\t\tBIT(12)\n#define RCANFD_CERFL_CERR\t\tBIT(11)\n#define RCANFD_CERFL_AERR\t\tBIT(10)\n#define RCANFD_CERFL_FERR\t\tBIT(9)\n#define RCANFD_CERFL_SERR\t\tBIT(8)\n#define RCANFD_CERFL_ALF\t\tBIT(7)\n#define RCANFD_CERFL_BLF\t\tBIT(6)\n#define RCANFD_CERFL_OVLF\t\tBIT(5)\n#define RCANFD_CERFL_BORF\t\tBIT(4)\n#define RCANFD_CERFL_BOEF\t\tBIT(3)\n#define RCANFD_CERFL_EPF\t\tBIT(2)\n#define RCANFD_CERFL_EWF\t\tBIT(1)\n#define RCANFD_CERFL_BEF\t\tBIT(0)\n\n#define RCANFD_CERFL_ERR(x)\t\t((x) & (0x7fff))  \n\n \n#define RCANFD_DCFG_DSJW(gpriv, x)\t(((x) & reg_gen4(gpriv, 0xf, 0x7)) << 24)\n\n#define RCANFD_DCFG_DTSEG2(gpriv, x) \\\n\t(((x) & reg_gen4(gpriv, 0x0f, 0x7)) << reg_gen4(gpriv, 16, 20))\n\n#define RCANFD_DCFG_DTSEG1(gpriv, x) \\\n\t(((x) & reg_gen4(gpriv, 0x1f, 0xf)) << reg_gen4(gpriv, 8, 16))\n\n#define RCANFD_DCFG_DBRP(x)\t\t(((x) & 0xff) << 0)\n\n \n#define RCANFD_GEN4_FDCFG_CLOE\t\tBIT(30)\n#define RCANFD_GEN4_FDCFG_FDOE\t\tBIT(28)\n#define RCANFD_FDCFG_TDCE\t\tBIT(9)\n#define RCANFD_FDCFG_TDCOC\t\tBIT(8)\n#define RCANFD_FDCFG_TDCO(x)\t\t(((x) & 0x7f) >> 16)\n\n \n#define RCANFD_RFCC_RFIM\t\tBIT(12)\n#define RCANFD_RFCC_RFDC(x)\t\t(((x) & 0x7) << 8)\n#define RCANFD_RFCC_RFPLS(x)\t\t(((x) & 0x7) << 4)\n#define RCANFD_RFCC_RFIE\t\tBIT(1)\n#define RCANFD_RFCC_RFE\t\t\tBIT(0)\n\n \n#define RCANFD_RFSTS_RFIF\t\tBIT(3)\n#define RCANFD_RFSTS_RFMLT\t\tBIT(2)\n#define RCANFD_RFSTS_RFFLL\t\tBIT(1)\n#define RCANFD_RFSTS_RFEMP\t\tBIT(0)\n\n \n#define RCANFD_RFID_RFIDE\t\tBIT(31)\n#define RCANFD_RFID_RFRTR\t\tBIT(30)\n\n \n#define RCANFD_RFPTR_RFDLC(x)\t\t(((x) >> 28) & 0xf)\n#define RCANFD_RFPTR_RFPTR(x)\t\t(((x) >> 16) & 0xfff)\n#define RCANFD_RFPTR_RFTS(x)\t\t(((x) >> 0) & 0xffff)\n\n \n#define RCANFD_RFFDSTS_RFFDF\t\tBIT(2)\n#define RCANFD_RFFDSTS_RFBRS\t\tBIT(1)\n#define RCANFD_RFFDSTS_RFESI\t\tBIT(0)\n\n \n\n \n#define RCANFD_CFCC_CFTML(gpriv, x)\t\\\n\t(((x) & reg_gen4(gpriv, 0x1f, 0xf)) << reg_gen4(gpriv, 16, 20))\n#define RCANFD_CFCC_CFM(gpriv, x)\t(((x) & 0x3) << reg_gen4(gpriv,  8, 16))\n#define RCANFD_CFCC_CFIM\t\tBIT(12)\n#define RCANFD_CFCC_CFDC(gpriv, x)\t(((x) & 0x7) << reg_gen4(gpriv, 21,  8))\n#define RCANFD_CFCC_CFPLS(x)\t\t(((x) & 0x7) << 4)\n#define RCANFD_CFCC_CFTXIE\t\tBIT(2)\n#define RCANFD_CFCC_CFE\t\t\tBIT(0)\n\n \n#define RCANFD_CFSTS_CFMC(x)\t\t(((x) >> 8) & 0xff)\n#define RCANFD_CFSTS_CFTXIF\t\tBIT(4)\n#define RCANFD_CFSTS_CFMLT\t\tBIT(2)\n#define RCANFD_CFSTS_CFFLL\t\tBIT(1)\n#define RCANFD_CFSTS_CFEMP\t\tBIT(0)\n\n \n#define RCANFD_CFID_CFIDE\t\tBIT(31)\n#define RCANFD_CFID_CFRTR\t\tBIT(30)\n#define RCANFD_CFID_CFID_MASK(x)\t((x) & 0x1fffffff)\n\n \n#define RCANFD_CFPTR_CFDLC(x)\t\t(((x) & 0xf) << 28)\n#define RCANFD_CFPTR_CFPTR(x)\t\t(((x) & 0xfff) << 16)\n#define RCANFD_CFPTR_CFTS(x)\t\t(((x) & 0xff) << 0)\n\n \n#define RCANFD_CFFDCSTS_CFFDF\t\tBIT(2)\n#define RCANFD_CFFDCSTS_CFBRS\t\tBIT(1)\n#define RCANFD_CFFDCSTS_CFESI\t\tBIT(0)\n\n \n\n \n\n \n#define RCANFD_CCFG(m)\t\t\t(0x0000 + (0x10 * (m)))\n \n#define RCANFD_CCTR(m)\t\t\t(0x0004 + (0x10 * (m)))\n \n#define RCANFD_CSTS(m)\t\t\t(0x0008 + (0x10 * (m)))\n \n#define RCANFD_CERFL(m)\t\t\t(0x000C + (0x10 * (m)))\n\n \n#define RCANFD_GCFG\t\t\t(0x0084)\n \n#define RCANFD_GCTR\t\t\t(0x0088)\n \n#define RCANFD_GSTS\t\t\t(0x008c)\n \n#define RCANFD_GERFL\t\t\t(0x0090)\n \n#define RCANFD_GTSC\t\t\t(0x0094)\n \n#define RCANFD_GAFLECTR\t\t\t(0x0098)\n \n#define RCANFD_GAFLCFG(ch)\t\t(0x009c + (0x04 * ((ch) / 2)))\n \n#define RCANFD_RMNB\t\t\t(0x00a4)\n \n#define RCANFD_RMND(y)\t\t\t(0x00a8 + (0x04 * (y)))\n\n \n#define RCANFD_RFCC(gpriv, x)\t\t(reg_gen4(gpriv, 0x00c0, 0x00b8) + (0x04 * (x)))\n \n#define RCANFD_RFSTS(gpriv, x)\t\t(RCANFD_RFCC(gpriv, x) + 0x20)\n \n#define RCANFD_RFPCTR(gpriv, x)\t\t(RCANFD_RFCC(gpriv, x) + 0x40)\n\n \n\n \n#define RCANFD_CFCC(gpriv, ch, idx) \\\n\t(reg_gen4(gpriv, 0x0120, 0x0118) + (0x0c * (ch)) + (0x04 * (idx)))\n \n#define RCANFD_CFSTS(gpriv, ch, idx) \\\n\t(reg_gen4(gpriv, 0x01e0, 0x0178) + (0x0c * (ch)) + (0x04 * (idx)))\n \n#define RCANFD_CFPCTR(gpriv, ch, idx) \\\n\t(reg_gen4(gpriv, 0x0240, 0x01d8) + (0x0c * (ch)) + (0x04 * (idx)))\n\n \n#define RCANFD_FESTS\t\t\t(0x0238)\n \n#define RCANFD_FFSTS\t\t\t(0x023c)\n \n#define RCANFD_FMSTS\t\t\t(0x0240)\n \n#define RCANFD_RFISTS\t\t\t(0x0244)\n \n#define RCANFD_CFRISTS\t\t\t(0x0248)\n \n#define RCANFD_CFTISTS\t\t\t(0x024c)\n\n \n#define RCANFD_TMC(p)\t\t\t(0x0250 + (0x01 * (p)))\n \n#define RCANFD_TMSTS(p)\t\t\t(0x02d0 + (0x01 * (p)))\n\n \n#define RCANFD_TMTRSTS(y)\t\t(0x0350 + (0x04 * (y)))\n \n#define RCANFD_TMTARSTS(y)\t\t(0x0360 + (0x04 * (y)))\n \n#define RCANFD_TMTCSTS(y)\t\t(0x0370 + (0x04 * (y)))\n \n#define RCANFD_TMTASTS(y)\t\t(0x0380 + (0x04 * (y)))\n \n#define RCANFD_TMIEC(y)\t\t\t(0x0390 + (0x04 * (y)))\n\n \n#define RCANFD_TXQCC(m)\t\t\t(0x03a0 + (0x04 * (m)))\n \n#define RCANFD_TXQSTS(m)\t\t(0x03c0 + (0x04 * (m)))\n \n#define RCANFD_TXQPCTR(m)\t\t(0x03e0 + (0x04 * (m)))\n\n \n#define RCANFD_THLCC(m)\t\t\t(0x0400 + (0x04 * (m)))\n \n#define RCANFD_THLSTS(m)\t\t(0x0420 + (0x04 * (m)))\n \n#define RCANFD_THLPCTR(m)\t\t(0x0440 + (0x04 * (m)))\n\n \n#define RCANFD_GTINTSTS0\t\t(0x0460)\n \n#define RCANFD_GTINTSTS1\t\t(0x0464)\n \n#define RCANFD_GTSTCFG\t\t\t(0x0468)\n \n#define RCANFD_GTSTCTR\t\t\t(0x046c)\n \n#define RCANFD_GLOCKK\t\t\t(0x047c)\n \n#define RCANFD_GRMCFG\t\t\t(0x04fc)\n\n \n#define RCANFD_GAFLID(offset, j)\t((offset) + (0x10 * (j)))\n \n#define RCANFD_GAFLM(offset, j)\t\t((offset) + 0x04 + (0x10 * (j)))\n \n#define RCANFD_GAFLP0(offset, j)\t((offset) + 0x08 + (0x10 * (j)))\n \n#define RCANFD_GAFLP1(offset, j)\t((offset) + 0x0c + (0x10 * (j)))\n\n \n\n \n#define RCANFD_C_GAFL_OFFSET\t\t(0x0500)\n\n \n#define RCANFD_C_RMID(q)\t\t(0x0600 + (0x10 * (q)))\n#define RCANFD_C_RMPTR(q)\t\t(0x0604 + (0x10 * (q)))\n#define RCANFD_C_RMDF0(q)\t\t(0x0608 + (0x10 * (q)))\n#define RCANFD_C_RMDF1(q)\t\t(0x060c + (0x10 * (q)))\n\n \n#define RCANFD_C_RFOFFSET\t(0x0e00)\n#define RCANFD_C_RFID(x)\t(RCANFD_C_RFOFFSET + (0x10 * (x)))\n#define RCANFD_C_RFPTR(x)\t(RCANFD_C_RFOFFSET + 0x04 + (0x10 * (x)))\n#define RCANFD_C_RFDF(x, df) \\\n\t\t(RCANFD_C_RFOFFSET + 0x08 + (0x10 * (x)) + (0x04 * (df)))\n\n \n#define RCANFD_C_CFOFFSET\t\t(0x0e80)\n\n#define RCANFD_C_CFID(ch, idx) \\\n\t(RCANFD_C_CFOFFSET + (0x30 * (ch)) + (0x10 * (idx)))\n\n#define RCANFD_C_CFPTR(ch, idx)\t\\\n\t(RCANFD_C_CFOFFSET + 0x04 + (0x30 * (ch)) + (0x10 * (idx)))\n\n#define RCANFD_C_CFDF(ch, idx, df) \\\n\t(RCANFD_C_CFOFFSET + 0x08 + (0x30 * (ch)) + (0x10 * (idx)) + (0x04 * (df)))\n\n \n#define RCANFD_C_TMID(p)\t\t(0x1000 + (0x10 * (p)))\n#define RCANFD_C_TMPTR(p)\t\t(0x1004 + (0x10 * (p)))\n#define RCANFD_C_TMDF0(p)\t\t(0x1008 + (0x10 * (p)))\n#define RCANFD_C_TMDF1(p)\t\t(0x100c + (0x10 * (p)))\n\n \n#define RCANFD_C_THLACC(m)\t\t(0x1800 + (0x04 * (m)))\n \n#define RCANFD_C_RPGACC(r)\t\t(0x1900 + (0x04 * (r)))\n\n \n#define RCANFD_GEN4_FDCFG(m)\t\t(0x1404 + (0x20 * (m)))\n\n#define RCANFD_GEN4_GAFL_OFFSET\t\t(0x1800)\n\n \n\n \n#define RCANFD_F_DCFG(gpriv, m)\t\t(reg_gen4(gpriv, 0x1400, 0x0500) + (0x20 * (m)))\n#define RCANFD_F_CFDCFG(m)\t\t(0x0504 + (0x20 * (m)))\n#define RCANFD_F_CFDCTR(m)\t\t(0x0508 + (0x20 * (m)))\n#define RCANFD_F_CFDSTS(m)\t\t(0x050c + (0x20 * (m)))\n#define RCANFD_F_CFDCRC(m)\t\t(0x0510 + (0x20 * (m)))\n\n \n#define RCANFD_F_GAFL_OFFSET\t\t(0x1000)\n\n \n#define RCANFD_F_RMID(q)\t\t(0x2000 + (0x20 * (q)))\n#define RCANFD_F_RMPTR(q)\t\t(0x2004 + (0x20 * (q)))\n#define RCANFD_F_RMFDSTS(q)\t\t(0x2008 + (0x20 * (q)))\n#define RCANFD_F_RMDF(q, b)\t\t(0x200c + (0x04 * (b)) + (0x20 * (q)))\n\n \n#define RCANFD_F_RFOFFSET(gpriv)\treg_gen4(gpriv, 0x6000, 0x3000)\n#define RCANFD_F_RFID(gpriv, x)\t\t(RCANFD_F_RFOFFSET(gpriv) + (0x80 * (x)))\n#define RCANFD_F_RFPTR(gpriv, x)\t(RCANFD_F_RFOFFSET(gpriv) + 0x04 + (0x80 * (x)))\n#define RCANFD_F_RFFDSTS(gpriv, x)\t(RCANFD_F_RFOFFSET(gpriv) + 0x08 + (0x80 * (x)))\n#define RCANFD_F_RFDF(gpriv, x, df) \\\n\t(RCANFD_F_RFOFFSET(gpriv) + 0x0c + (0x80 * (x)) + (0x04 * (df)))\n\n \n#define RCANFD_F_CFOFFSET(gpriv)\treg_gen4(gpriv, 0x6400, 0x3400)\n\n#define RCANFD_F_CFID(gpriv, ch, idx) \\\n\t(RCANFD_F_CFOFFSET(gpriv) + (0x180 * (ch)) + (0x80 * (idx)))\n\n#define RCANFD_F_CFPTR(gpriv, ch, idx) \\\n\t(RCANFD_F_CFOFFSET(gpriv) + 0x04 + (0x180 * (ch)) + (0x80 * (idx)))\n\n#define RCANFD_F_CFFDCSTS(gpriv, ch, idx) \\\n\t(RCANFD_F_CFOFFSET(gpriv) + 0x08 + (0x180 * (ch)) + (0x80 * (idx)))\n\n#define RCANFD_F_CFDF(gpriv, ch, idx, df) \\\n\t(RCANFD_F_CFOFFSET(gpriv) + 0x0c + (0x180 * (ch)) + (0x80 * (idx)) + \\\n\t (0x04 * (df)))\n\n \n#define RCANFD_F_TMID(p)\t\t(0x4000 + (0x20 * (p)))\n#define RCANFD_F_TMPTR(p)\t\t(0x4004 + (0x20 * (p)))\n#define RCANFD_F_TMFDCTR(p)\t\t(0x4008 + (0x20 * (p)))\n#define RCANFD_F_TMDF(p, b)\t\t(0x400c + (0x20 * (p)) + (0x04 * (b)))\n\n \n#define RCANFD_F_THLACC(m)\t\t(0x6000 + (0x04 * (m)))\n \n#define RCANFD_F_RPGACC(r)\t\t(0x6400 + (0x04 * (r)))\n\n \n#define RCANFD_FIFO_DEPTH\t\t8\t \n#define RCANFD_NAPI_WEIGHT\t\t8\t \n\n#define RCANFD_NUM_CHANNELS\t\t8\t \n#define RCANFD_CHANNELS_MASK\t\tBIT((RCANFD_NUM_CHANNELS) - 1)\n\n#define RCANFD_GAFL_PAGENUM(entry)\t((entry) / 16)\n#define RCANFD_CHANNEL_NUMRULES\t\t1\t \n\n \n#define RCANFD_RFFIFO_IDX\t\t0\n\n \n#define RCANFD_CFFIFO_IDX\t\t0\n\n \nenum rcar_canfd_fcanclk {\n\tRCANFD_CANFDCLK = 0,\t\t \n\tRCANFD_EXTCLK,\t\t\t \n};\n\nstruct rcar_canfd_global;\n\nstruct rcar_canfd_hw_info {\n\tu8 max_channels;\n\tu8 postdiv;\n\t \n\tunsigned shared_global_irqs:1;\t \n\tunsigned multi_channel_irqs:1;\t \n};\n\n \nstruct rcar_canfd_channel {\n\tstruct can_priv can;\t\t\t \n\tstruct net_device *ndev;\n\tstruct rcar_canfd_global *gpriv;\t \n\tvoid __iomem *base;\t\t\t \n\tstruct phy *transceiver;\t\t \n\tstruct napi_struct napi;\n\tu32 tx_head;\t\t\t\t \n\tu32 tx_tail;\t\t\t\t \n\tu32 channel;\t\t\t\t \n\tspinlock_t tx_lock;\t\t\t \n};\n\n \nstruct rcar_canfd_global {\n\tstruct rcar_canfd_channel *ch[RCANFD_NUM_CHANNELS];\n\tvoid __iomem *base;\t\t \n\tstruct platform_device *pdev;\t \n\tstruct clk *clkp;\t\t \n\tstruct clk *can_clk;\t\t \n\tenum rcar_canfd_fcanclk fcan;\t \n\tunsigned long channels_mask;\t \n\tbool fdmode;\t\t\t \n\tstruct reset_control *rstc1;\n\tstruct reset_control *rstc2;\n\tconst struct rcar_canfd_hw_info *info;\n};\n\n \nstatic const struct can_bittiming_const rcar_canfd_nom_bittiming_const = {\n\t.name = RCANFD_DRV_NAME,\n\t.tseg1_min = 2,\n\t.tseg1_max = 128,\n\t.tseg2_min = 2,\n\t.tseg2_max = 32,\n\t.sjw_max = 32,\n\t.brp_min = 1,\n\t.brp_max = 1024,\n\t.brp_inc = 1,\n};\n\n \nstatic const struct can_bittiming_const rcar_canfd_data_bittiming_const = {\n\t.name = RCANFD_DRV_NAME,\n\t.tseg1_min = 2,\n\t.tseg1_max = 16,\n\t.tseg2_min = 2,\n\t.tseg2_max = 8,\n\t.sjw_max = 8,\n\t.brp_min = 1,\n\t.brp_max = 256,\n\t.brp_inc = 1,\n};\n\n \nstatic const struct can_bittiming_const rcar_canfd_bittiming_const = {\n\t.name = RCANFD_DRV_NAME,\n\t.tseg1_min = 4,\n\t.tseg1_max = 16,\n\t.tseg2_min = 2,\n\t.tseg2_max = 8,\n\t.sjw_max = 4,\n\t.brp_min = 1,\n\t.brp_max = 1024,\n\t.brp_inc = 1,\n};\n\nstatic const struct rcar_canfd_hw_info rcar_gen3_hw_info = {\n\t.max_channels = 2,\n\t.postdiv = 2,\n\t.shared_global_irqs = 1,\n};\n\nstatic const struct rcar_canfd_hw_info rcar_gen4_hw_info = {\n\t.max_channels = 8,\n\t.postdiv = 2,\n\t.shared_global_irqs = 1,\n};\n\nstatic const struct rcar_canfd_hw_info rzg2l_hw_info = {\n\t.max_channels = 2,\n\t.postdiv = 1,\n\t.multi_channel_irqs = 1,\n};\n\n \nstatic inline bool is_gen4(struct rcar_canfd_global *gpriv)\n{\n\treturn gpriv->info == &rcar_gen4_hw_info;\n}\n\nstatic inline u32 reg_gen4(struct rcar_canfd_global *gpriv,\n\t\t\t   u32 gen4, u32 not_gen4)\n{\n\treturn is_gen4(gpriv) ? gen4 : not_gen4;\n}\n\nstatic inline void rcar_canfd_update(u32 mask, u32 val, u32 __iomem *reg)\n{\n\tu32 data = readl(reg);\n\n\tdata &= ~mask;\n\tdata |= (val & mask);\n\twritel(data, reg);\n}\n\nstatic inline u32 rcar_canfd_read(void __iomem *base, u32 offset)\n{\n\treturn readl(base + (offset));\n}\n\nstatic inline void rcar_canfd_write(void __iomem *base, u32 offset, u32 val)\n{\n\twritel(val, base + (offset));\n}\n\nstatic void rcar_canfd_set_bit(void __iomem *base, u32 reg, u32 val)\n{\n\trcar_canfd_update(val, val, base + (reg));\n}\n\nstatic void rcar_canfd_clear_bit(void __iomem *base, u32 reg, u32 val)\n{\n\trcar_canfd_update(val, 0, base + (reg));\n}\n\nstatic void rcar_canfd_update_bit(void __iomem *base, u32 reg,\n\t\t\t\t  u32 mask, u32 val)\n{\n\trcar_canfd_update(mask, val, base + (reg));\n}\n\nstatic void rcar_canfd_get_data(struct rcar_canfd_channel *priv,\n\t\t\t\tstruct canfd_frame *cf, u32 off)\n{\n\tu32 i, lwords;\n\n\tlwords = DIV_ROUND_UP(cf->len, sizeof(u32));\n\tfor (i = 0; i < lwords; i++)\n\t\t*((u32 *)cf->data + i) =\n\t\t\trcar_canfd_read(priv->base, off + (i * sizeof(u32)));\n}\n\nstatic void rcar_canfd_put_data(struct rcar_canfd_channel *priv,\n\t\t\t\tstruct canfd_frame *cf, u32 off)\n{\n\tu32 i, lwords;\n\n\tlwords = DIV_ROUND_UP(cf->len, sizeof(u32));\n\tfor (i = 0; i < lwords; i++)\n\t\trcar_canfd_write(priv->base, off + (i * sizeof(u32)),\n\t\t\t\t *((u32 *)cf->data + i));\n}\n\nstatic void rcar_canfd_tx_failure_cleanup(struct net_device *ndev)\n{\n\tu32 i;\n\n\tfor (i = 0; i < RCANFD_FIFO_DEPTH; i++)\n\t\tcan_free_echo_skb(ndev, i, NULL);\n}\n\nstatic void rcar_canfd_set_mode(struct rcar_canfd_global *gpriv)\n{\n\tif (is_gen4(gpriv)) {\n\t\tu32 ch, val = gpriv->fdmode ? RCANFD_GEN4_FDCFG_FDOE\n\t\t\t\t\t    : RCANFD_GEN4_FDCFG_CLOE;\n\n\t\tfor_each_set_bit(ch, &gpriv->channels_mask,\n\t\t\t\t gpriv->info->max_channels)\n\t\t\trcar_canfd_set_bit(gpriv->base, RCANFD_GEN4_FDCFG(ch),\n\t\t\t\t\t   val);\n\t} else {\n\t\tif (gpriv->fdmode)\n\t\t\trcar_canfd_set_bit(gpriv->base, RCANFD_GRMCFG,\n\t\t\t\t\t   RCANFD_GRMCFG_RCMC);\n\t\telse\n\t\t\trcar_canfd_clear_bit(gpriv->base, RCANFD_GRMCFG,\n\t\t\t\t\t     RCANFD_GRMCFG_RCMC);\n\t}\n}\n\nstatic int rcar_canfd_reset_controller(struct rcar_canfd_global *gpriv)\n{\n\tu32 sts, ch;\n\tint err;\n\n\t \n\terr = readl_poll_timeout((gpriv->base + RCANFD_GSTS), sts,\n\t\t\t\t !(sts & RCANFD_GSTS_GRAMINIT), 2, 500000);\n\tif (err) {\n\t\tdev_dbg(&gpriv->pdev->dev, \"global raminit failed\\n\");\n\t\treturn err;\n\t}\n\n\t \n\trcar_canfd_clear_bit(gpriv->base, RCANFD_GCTR, RCANFD_GCTR_GSLPR);\n\trcar_canfd_update_bit(gpriv->base, RCANFD_GCTR,\n\t\t\t      RCANFD_GCTR_GMDC_MASK, RCANFD_GCTR_GMDC_GRESET);\n\n\t \n\terr = readl_poll_timeout((gpriv->base + RCANFD_GSTS), sts,\n\t\t\t\t (sts & RCANFD_GSTS_GRSTSTS), 2, 500000);\n\tif (err) {\n\t\tdev_dbg(&gpriv->pdev->dev, \"global reset failed\\n\");\n\t\treturn err;\n\t}\n\n\t \n\trcar_canfd_write(gpriv->base, RCANFD_GERFL, 0x0);\n\n\t \n\trcar_canfd_set_mode(gpriv);\n\n\t \n\tfor_each_set_bit(ch, &gpriv->channels_mask, gpriv->info->max_channels) {\n\t\trcar_canfd_clear_bit(gpriv->base,\n\t\t\t\t     RCANFD_CCTR(ch), RCANFD_CCTR_CSLPR);\n\n\t\trcar_canfd_update_bit(gpriv->base, RCANFD_CCTR(ch),\n\t\t\t\t      RCANFD_CCTR_CHMDC_MASK,\n\t\t\t\t      RCANFD_CCTR_CHDMC_CRESET);\n\n\t\t \n\t\terr = readl_poll_timeout((gpriv->base + RCANFD_CSTS(ch)), sts,\n\t\t\t\t\t (sts & RCANFD_CSTS_CRSTSTS),\n\t\t\t\t\t 2, 500000);\n\t\tif (err) {\n\t\t\tdev_dbg(&gpriv->pdev->dev,\n\t\t\t\t\"channel %u reset failed\\n\", ch);\n\t\t\treturn err;\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic void rcar_canfd_configure_controller(struct rcar_canfd_global *gpriv)\n{\n\tu32 cfg, ch;\n\n\t \n\n\t \n\tcfg = RCANFD_GCFG_EEFE;\n\n\tif (gpriv->fdmode)\n\t\t \n\t\tcfg |= RCANFD_GCFG_CMPOC;\n\n\t \n\tif (gpriv->fcan != RCANFD_CANFDCLK)\n\t\tcfg |= RCANFD_GCFG_DCS;\n\n\trcar_canfd_set_bit(gpriv->base, RCANFD_GCFG, cfg);\n\n\t \n\tfor_each_set_bit(ch, &gpriv->channels_mask, gpriv->info->max_channels) {\n\t\trcar_canfd_set_bit(gpriv->base, RCANFD_CCTR(ch),\n\t\t\t\t   RCANFD_CCTR_ERRD);\n\t\trcar_canfd_update_bit(gpriv->base, RCANFD_CCTR(ch),\n\t\t\t\t      RCANFD_CCTR_BOM_MASK,\n\t\t\t\t      RCANFD_CCTR_BOM_BENTRY);\n\t}\n}\n\nstatic void rcar_canfd_configure_afl_rules(struct rcar_canfd_global *gpriv,\n\t\t\t\t\t   u32 ch)\n{\n\tu32 cfg;\n\tint offset, start, page, num_rules = RCANFD_CHANNEL_NUMRULES;\n\tu32 ridx = ch + RCANFD_RFFIFO_IDX;\n\n\tif (ch == 0) {\n\t\tstart = 0;  \n\t} else {\n\t\t \n\t\tcfg = rcar_canfd_read(gpriv->base, RCANFD_GAFLCFG(ch));\n\t\tstart = RCANFD_GAFLCFG_GETRNC(gpriv, 0, cfg);\n\t}\n\n\t \n\tpage = RCANFD_GAFL_PAGENUM(start);\n\trcar_canfd_set_bit(gpriv->base, RCANFD_GAFLECTR,\n\t\t\t   (RCANFD_GAFLECTR_AFLPN(gpriv, page) |\n\t\t\t    RCANFD_GAFLECTR_AFLDAE));\n\n\t \n\trcar_canfd_set_bit(gpriv->base, RCANFD_GAFLCFG(ch),\n\t\t\t   RCANFD_GAFLCFG_SETRNC(gpriv, ch, num_rules));\n\tif (is_gen4(gpriv))\n\t\toffset = RCANFD_GEN4_GAFL_OFFSET;\n\telse if (gpriv->fdmode)\n\t\toffset = RCANFD_F_GAFL_OFFSET;\n\telse\n\t\toffset = RCANFD_C_GAFL_OFFSET;\n\n\t \n\trcar_canfd_write(gpriv->base, RCANFD_GAFLID(offset, start), 0);\n\t \n\trcar_canfd_write(gpriv->base, RCANFD_GAFLM(offset, start), 0);\n\t \n\trcar_canfd_write(gpriv->base, RCANFD_GAFLP0(offset, start), 0);\n\t \n\trcar_canfd_set_bit(gpriv->base, RCANFD_GAFLP1(offset, start),\n\t\t\t   RCANFD_GAFLP1_GAFLFDP(ridx));\n\n\t \n\trcar_canfd_clear_bit(gpriv->base,\n\t\t\t     RCANFD_GAFLECTR, RCANFD_GAFLECTR_AFLDAE);\n}\n\nstatic void rcar_canfd_configure_rx(struct rcar_canfd_global *gpriv, u32 ch)\n{\n\t \n\tu32 cfg;\n\tu16 rfdc, rfpls;\n\n\t \n\tu32 ridx = ch + RCANFD_RFFIFO_IDX;\n\n\trfdc = 2;\t\t \n\tif (gpriv->fdmode)\n\t\trfpls = 7;\t \n\telse\n\t\trfpls = 0;\t \n\n\tcfg = (RCANFD_RFCC_RFIM | RCANFD_RFCC_RFDC(rfdc) |\n\t\tRCANFD_RFCC_RFPLS(rfpls) | RCANFD_RFCC_RFIE);\n\trcar_canfd_write(gpriv->base, RCANFD_RFCC(gpriv, ridx), cfg);\n}\n\nstatic void rcar_canfd_configure_tx(struct rcar_canfd_global *gpriv, u32 ch)\n{\n\t \n\tu32 cfg;\n\tu16 cftml, cfm, cfdc, cfpls;\n\n\tcftml = 0;\t\t \n\tcfm = 1;\t\t \n\tcfdc = 2;\t\t \n\tif (gpriv->fdmode)\n\t\tcfpls = 7;\t \n\telse\n\t\tcfpls = 0;\t \n\n\tcfg = (RCANFD_CFCC_CFTML(gpriv, cftml) | RCANFD_CFCC_CFM(gpriv, cfm) |\n\t\tRCANFD_CFCC_CFIM | RCANFD_CFCC_CFDC(gpriv, cfdc) |\n\t\tRCANFD_CFCC_CFPLS(cfpls) | RCANFD_CFCC_CFTXIE);\n\trcar_canfd_write(gpriv->base, RCANFD_CFCC(gpriv, ch, RCANFD_CFFIFO_IDX), cfg);\n\n\tif (gpriv->fdmode)\n\t\t \n\t\trcar_canfd_write(gpriv->base,\n\t\t\t\t RCANFD_F_CFFDCSTS(gpriv, ch, RCANFD_CFFIFO_IDX), 0);\n}\n\nstatic void rcar_canfd_enable_global_interrupts(struct rcar_canfd_global *gpriv)\n{\n\tu32 ctr;\n\n\t \n\trcar_canfd_write(gpriv->base, RCANFD_GERFL, 0);\n\n\t \n\tctr = RCANFD_GCTR_MEIE;\n\tif (gpriv->fdmode)\n\t\tctr |= RCANFD_GCTR_CFMPOFIE;\n\n\trcar_canfd_set_bit(gpriv->base, RCANFD_GCTR, ctr);\n}\n\nstatic void rcar_canfd_disable_global_interrupts(struct rcar_canfd_global\n\t\t\t\t\t\t *gpriv)\n{\n\t \n\trcar_canfd_write(gpriv->base, RCANFD_GCTR, 0);\n\n\t \n\trcar_canfd_write(gpriv->base, RCANFD_GERFL, 0);\n}\n\nstatic void rcar_canfd_enable_channel_interrupts(struct rcar_canfd_channel\n\t\t\t\t\t\t *priv)\n{\n\tu32 ctr, ch = priv->channel;\n\n\t \n\trcar_canfd_write(priv->base, RCANFD_CERFL(ch), 0);\n\n\t \n\tctr = (RCANFD_CCTR_TAIE |\n\t       RCANFD_CCTR_ALIE | RCANFD_CCTR_BLIE |\n\t       RCANFD_CCTR_OLIE | RCANFD_CCTR_BORIE |\n\t       RCANFD_CCTR_BOEIE | RCANFD_CCTR_EPIE |\n\t       RCANFD_CCTR_EWIE | RCANFD_CCTR_BEIE);\n\trcar_canfd_set_bit(priv->base, RCANFD_CCTR(ch), ctr);\n}\n\nstatic void rcar_canfd_disable_channel_interrupts(struct rcar_canfd_channel\n\t\t\t\t\t\t  *priv)\n{\n\tu32 ctr, ch = priv->channel;\n\n\tctr = (RCANFD_CCTR_TAIE |\n\t       RCANFD_CCTR_ALIE | RCANFD_CCTR_BLIE |\n\t       RCANFD_CCTR_OLIE | RCANFD_CCTR_BORIE |\n\t       RCANFD_CCTR_BOEIE | RCANFD_CCTR_EPIE |\n\t       RCANFD_CCTR_EWIE | RCANFD_CCTR_BEIE);\n\trcar_canfd_clear_bit(priv->base, RCANFD_CCTR(ch), ctr);\n\n\t \n\trcar_canfd_write(priv->base, RCANFD_CERFL(ch), 0);\n}\n\nstatic void rcar_canfd_global_error(struct net_device *ndev)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(ndev);\n\tstruct rcar_canfd_global *gpriv = priv->gpriv;\n\tstruct net_device_stats *stats = &ndev->stats;\n\tu32 ch = priv->channel;\n\tu32 gerfl, sts;\n\tu32 ridx = ch + RCANFD_RFFIFO_IDX;\n\n\tgerfl = rcar_canfd_read(priv->base, RCANFD_GERFL);\n\tif (gerfl & RCANFD_GERFL_EEF(ch)) {\n\t\tnetdev_dbg(ndev, \"Ch%u: ECC Error flag\\n\", ch);\n\t\tstats->tx_dropped++;\n\t}\n\tif (gerfl & RCANFD_GERFL_MES) {\n\t\tsts = rcar_canfd_read(priv->base,\n\t\t\t\t      RCANFD_CFSTS(gpriv, ch, RCANFD_CFFIFO_IDX));\n\t\tif (sts & RCANFD_CFSTS_CFMLT) {\n\t\t\tnetdev_dbg(ndev, \"Tx Message Lost flag\\n\");\n\t\t\tstats->tx_dropped++;\n\t\t\trcar_canfd_write(priv->base,\n\t\t\t\t\t RCANFD_CFSTS(gpriv, ch, RCANFD_CFFIFO_IDX),\n\t\t\t\t\t sts & ~RCANFD_CFSTS_CFMLT);\n\t\t}\n\n\t\tsts = rcar_canfd_read(priv->base, RCANFD_RFSTS(gpriv, ridx));\n\t\tif (sts & RCANFD_RFSTS_RFMLT) {\n\t\t\tnetdev_dbg(ndev, \"Rx Message Lost flag\\n\");\n\t\t\tstats->rx_dropped++;\n\t\t\trcar_canfd_write(priv->base, RCANFD_RFSTS(gpriv, ridx),\n\t\t\t\t\t sts & ~RCANFD_RFSTS_RFMLT);\n\t\t}\n\t}\n\tif (gpriv->fdmode && gerfl & RCANFD_GERFL_CMPOF) {\n\t\t \n\t\tnetdev_dbg(ndev, \"global payload overflow interrupt\\n\");\n\t}\n\n\t \n\trcar_canfd_write(priv->base, RCANFD_GERFL, 0);\n}\n\nstatic void rcar_canfd_error(struct net_device *ndev, u32 cerfl,\n\t\t\t     u16 txerr, u16 rxerr)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(ndev);\n\tstruct net_device_stats *stats = &ndev->stats;\n\tstruct can_frame *cf;\n\tstruct sk_buff *skb;\n\tu32 ch = priv->channel;\n\n\tnetdev_dbg(ndev, \"ch erfl %x txerr %u rxerr %u\\n\", cerfl, txerr, rxerr);\n\n\t \n\tskb = alloc_can_err_skb(ndev, &cf);\n\tif (!skb) {\n\t\tstats->rx_dropped++;\n\t\treturn;\n\t}\n\n\t \n\tif (cerfl & RCANFD_CERFL_BEF) {\n\t\tnetdev_dbg(ndev, \"Bus error\\n\");\n\t\tcf->can_id |= CAN_ERR_BUSERROR | CAN_ERR_PROT;\n\t\tcf->data[2] = CAN_ERR_PROT_UNSPEC;\n\t\tpriv->can.can_stats.bus_error++;\n\t}\n\tif (cerfl & RCANFD_CERFL_ADERR) {\n\t\tnetdev_dbg(ndev, \"ACK Delimiter Error\\n\");\n\t\tstats->tx_errors++;\n\t\tcf->data[3] |= CAN_ERR_PROT_LOC_ACK_DEL;\n\t}\n\tif (cerfl & RCANFD_CERFL_B0ERR) {\n\t\tnetdev_dbg(ndev, \"Bit Error (dominant)\\n\");\n\t\tstats->tx_errors++;\n\t\tcf->data[2] |= CAN_ERR_PROT_BIT0;\n\t}\n\tif (cerfl & RCANFD_CERFL_B1ERR) {\n\t\tnetdev_dbg(ndev, \"Bit Error (recessive)\\n\");\n\t\tstats->tx_errors++;\n\t\tcf->data[2] |= CAN_ERR_PROT_BIT1;\n\t}\n\tif (cerfl & RCANFD_CERFL_CERR) {\n\t\tnetdev_dbg(ndev, \"CRC Error\\n\");\n\t\tstats->rx_errors++;\n\t\tcf->data[3] |= CAN_ERR_PROT_LOC_CRC_SEQ;\n\t}\n\tif (cerfl & RCANFD_CERFL_AERR) {\n\t\tnetdev_dbg(ndev, \"ACK Error\\n\");\n\t\tstats->tx_errors++;\n\t\tcf->can_id |= CAN_ERR_ACK;\n\t\tcf->data[3] |= CAN_ERR_PROT_LOC_ACK;\n\t}\n\tif (cerfl & RCANFD_CERFL_FERR) {\n\t\tnetdev_dbg(ndev, \"Form Error\\n\");\n\t\tstats->rx_errors++;\n\t\tcf->data[2] |= CAN_ERR_PROT_FORM;\n\t}\n\tif (cerfl & RCANFD_CERFL_SERR) {\n\t\tnetdev_dbg(ndev, \"Stuff Error\\n\");\n\t\tstats->rx_errors++;\n\t\tcf->data[2] |= CAN_ERR_PROT_STUFF;\n\t}\n\tif (cerfl & RCANFD_CERFL_ALF) {\n\t\tnetdev_dbg(ndev, \"Arbitration lost Error\\n\");\n\t\tpriv->can.can_stats.arbitration_lost++;\n\t\tcf->can_id |= CAN_ERR_LOSTARB;\n\t\tcf->data[0] |= CAN_ERR_LOSTARB_UNSPEC;\n\t}\n\tif (cerfl & RCANFD_CERFL_BLF) {\n\t\tnetdev_dbg(ndev, \"Bus Lock Error\\n\");\n\t\tstats->rx_errors++;\n\t\tcf->can_id |= CAN_ERR_BUSERROR;\n\t}\n\tif (cerfl & RCANFD_CERFL_EWF) {\n\t\tnetdev_dbg(ndev, \"Error warning interrupt\\n\");\n\t\tpriv->can.state = CAN_STATE_ERROR_WARNING;\n\t\tpriv->can.can_stats.error_warning++;\n\t\tcf->can_id |= CAN_ERR_CRTL | CAN_ERR_CNT;\n\t\tcf->data[1] = txerr > rxerr ? CAN_ERR_CRTL_TX_WARNING :\n\t\t\tCAN_ERR_CRTL_RX_WARNING;\n\t\tcf->data[6] = txerr;\n\t\tcf->data[7] = rxerr;\n\t}\n\tif (cerfl & RCANFD_CERFL_EPF) {\n\t\tnetdev_dbg(ndev, \"Error passive interrupt\\n\");\n\t\tpriv->can.state = CAN_STATE_ERROR_PASSIVE;\n\t\tpriv->can.can_stats.error_passive++;\n\t\tcf->can_id |= CAN_ERR_CRTL | CAN_ERR_CNT;\n\t\tcf->data[1] = txerr > rxerr ? CAN_ERR_CRTL_TX_PASSIVE :\n\t\t\tCAN_ERR_CRTL_RX_PASSIVE;\n\t\tcf->data[6] = txerr;\n\t\tcf->data[7] = rxerr;\n\t}\n\tif (cerfl & RCANFD_CERFL_BOEF) {\n\t\tnetdev_dbg(ndev, \"Bus-off entry interrupt\\n\");\n\t\trcar_canfd_tx_failure_cleanup(ndev);\n\t\tpriv->can.state = CAN_STATE_BUS_OFF;\n\t\tpriv->can.can_stats.bus_off++;\n\t\tcan_bus_off(ndev);\n\t\tcf->can_id |= CAN_ERR_BUSOFF;\n\t}\n\tif (cerfl & RCANFD_CERFL_OVLF) {\n\t\tnetdev_dbg(ndev,\n\t\t\t   \"Overload Frame Transmission error interrupt\\n\");\n\t\tstats->tx_errors++;\n\t\tcf->can_id |= CAN_ERR_PROT;\n\t\tcf->data[2] |= CAN_ERR_PROT_OVERLOAD;\n\t}\n\n\t \n\trcar_canfd_write(priv->base, RCANFD_CERFL(ch),\n\t\t\t RCANFD_CERFL_ERR(~cerfl));\n\tnetif_rx(skb);\n}\n\nstatic void rcar_canfd_tx_done(struct net_device *ndev)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(ndev);\n\tstruct rcar_canfd_global *gpriv = priv->gpriv;\n\tstruct net_device_stats *stats = &ndev->stats;\n\tu32 sts;\n\tunsigned long flags;\n\tu32 ch = priv->channel;\n\n\tdo {\n\t\tu8 unsent, sent;\n\n\t\tsent = priv->tx_tail % RCANFD_FIFO_DEPTH;\n\t\tstats->tx_packets++;\n\t\tstats->tx_bytes += can_get_echo_skb(ndev, sent, NULL);\n\n\t\tspin_lock_irqsave(&priv->tx_lock, flags);\n\t\tpriv->tx_tail++;\n\t\tsts = rcar_canfd_read(priv->base,\n\t\t\t\t      RCANFD_CFSTS(gpriv, ch, RCANFD_CFFIFO_IDX));\n\t\tunsent = RCANFD_CFSTS_CFMC(sts);\n\n\t\t \n\t\tif (unsent != RCANFD_FIFO_DEPTH)\n\t\t\tnetif_wake_queue(ndev);\n\n\t\tif (priv->tx_head - priv->tx_tail <= unsent) {\n\t\t\tspin_unlock_irqrestore(&priv->tx_lock, flags);\n\t\t\tbreak;\n\t\t}\n\t\tspin_unlock_irqrestore(&priv->tx_lock, flags);\n\n\t} while (1);\n\n\t \n\trcar_canfd_write(priv->base, RCANFD_CFSTS(gpriv, ch, RCANFD_CFFIFO_IDX),\n\t\t\t sts & ~RCANFD_CFSTS_CFTXIF);\n}\n\nstatic void rcar_canfd_handle_global_err(struct rcar_canfd_global *gpriv, u32 ch)\n{\n\tstruct rcar_canfd_channel *priv = gpriv->ch[ch];\n\tstruct net_device *ndev = priv->ndev;\n\tu32 gerfl;\n\n\t \n\tgerfl = rcar_canfd_read(priv->base, RCANFD_GERFL);\n\tif (unlikely(RCANFD_GERFL_ERR(gpriv, gerfl)))\n\t\trcar_canfd_global_error(ndev);\n}\n\nstatic irqreturn_t rcar_canfd_global_err_interrupt(int irq, void *dev_id)\n{\n\tstruct rcar_canfd_global *gpriv = dev_id;\n\tu32 ch;\n\n\tfor_each_set_bit(ch, &gpriv->channels_mask, gpriv->info->max_channels)\n\t\trcar_canfd_handle_global_err(gpriv, ch);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rcar_canfd_handle_global_receive(struct rcar_canfd_global *gpriv, u32 ch)\n{\n\tstruct rcar_canfd_channel *priv = gpriv->ch[ch];\n\tu32 ridx = ch + RCANFD_RFFIFO_IDX;\n\tu32 sts, cc;\n\n\t \n\tsts = rcar_canfd_read(priv->base, RCANFD_RFSTS(gpriv, ridx));\n\tcc = rcar_canfd_read(priv->base, RCANFD_RFCC(gpriv, ridx));\n\tif (likely(sts & RCANFD_RFSTS_RFIF &&\n\t\t   cc & RCANFD_RFCC_RFIE)) {\n\t\tif (napi_schedule_prep(&priv->napi)) {\n\t\t\t \n\t\t\trcar_canfd_clear_bit(priv->base,\n\t\t\t\t\t     RCANFD_RFCC(gpriv, ridx),\n\t\t\t\t\t     RCANFD_RFCC_RFIE);\n\t\t\t__napi_schedule(&priv->napi);\n\t\t}\n\t}\n}\n\nstatic irqreturn_t rcar_canfd_global_receive_fifo_interrupt(int irq, void *dev_id)\n{\n\tstruct rcar_canfd_global *gpriv = dev_id;\n\tu32 ch;\n\n\tfor_each_set_bit(ch, &gpriv->channels_mask, gpriv->info->max_channels)\n\t\trcar_canfd_handle_global_receive(gpriv, ch);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t rcar_canfd_global_interrupt(int irq, void *dev_id)\n{\n\tstruct rcar_canfd_global *gpriv = dev_id;\n\tu32 ch;\n\n\t \n\tfor_each_set_bit(ch, &gpriv->channels_mask, gpriv->info->max_channels) {\n\t\trcar_canfd_handle_global_err(gpriv, ch);\n\t\trcar_canfd_handle_global_receive(gpriv, ch);\n\t}\n\treturn IRQ_HANDLED;\n}\n\nstatic void rcar_canfd_state_change(struct net_device *ndev,\n\t\t\t\t    u16 txerr, u16 rxerr)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(ndev);\n\tstruct net_device_stats *stats = &ndev->stats;\n\tenum can_state rx_state, tx_state, state = priv->can.state;\n\tstruct can_frame *cf;\n\tstruct sk_buff *skb;\n\n\t \n\tif (txerr < 96 && rxerr < 96)\n\t\tstate = CAN_STATE_ERROR_ACTIVE;\n\telse if (txerr < 128 && rxerr < 128)\n\t\tstate = CAN_STATE_ERROR_WARNING;\n\n\tif (state != priv->can.state) {\n\t\tnetdev_dbg(ndev, \"state: new %d, old %d: txerr %u, rxerr %u\\n\",\n\t\t\t   state, priv->can.state, txerr, rxerr);\n\t\tskb = alloc_can_err_skb(ndev, &cf);\n\t\tif (!skb) {\n\t\t\tstats->rx_dropped++;\n\t\t\treturn;\n\t\t}\n\t\ttx_state = txerr >= rxerr ? state : 0;\n\t\trx_state = txerr <= rxerr ? state : 0;\n\n\t\tcan_change_state(ndev, cf, tx_state, rx_state);\n\t\tnetif_rx(skb);\n\t}\n}\n\nstatic void rcar_canfd_handle_channel_tx(struct rcar_canfd_global *gpriv, u32 ch)\n{\n\tstruct rcar_canfd_channel *priv = gpriv->ch[ch];\n\tstruct net_device *ndev = priv->ndev;\n\tu32 sts;\n\n\t \n\tsts = rcar_canfd_read(priv->base,\n\t\t\t      RCANFD_CFSTS(gpriv, ch, RCANFD_CFFIFO_IDX));\n\tif (likely(sts & RCANFD_CFSTS_CFTXIF))\n\t\trcar_canfd_tx_done(ndev);\n}\n\nstatic irqreturn_t rcar_canfd_channel_tx_interrupt(int irq, void *dev_id)\n{\n\tstruct rcar_canfd_channel *priv = dev_id;\n\n\trcar_canfd_handle_channel_tx(priv->gpriv, priv->channel);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rcar_canfd_handle_channel_err(struct rcar_canfd_global *gpriv, u32 ch)\n{\n\tstruct rcar_canfd_channel *priv = gpriv->ch[ch];\n\tstruct net_device *ndev = priv->ndev;\n\tu16 txerr, rxerr;\n\tu32 sts, cerfl;\n\n\t \n\tcerfl = rcar_canfd_read(priv->base, RCANFD_CERFL(ch));\n\tsts = rcar_canfd_read(priv->base, RCANFD_CSTS(ch));\n\ttxerr = RCANFD_CSTS_TECCNT(sts);\n\trxerr = RCANFD_CSTS_RECCNT(sts);\n\tif (unlikely(RCANFD_CERFL_ERR(cerfl)))\n\t\trcar_canfd_error(ndev, cerfl, txerr, rxerr);\n\n\t \n\tif (unlikely(priv->can.state != CAN_STATE_ERROR_ACTIVE &&\n\t\t     priv->can.state != CAN_STATE_BUS_OFF))\n\t\trcar_canfd_state_change(ndev, txerr, rxerr);\n}\n\nstatic irqreturn_t rcar_canfd_channel_err_interrupt(int irq, void *dev_id)\n{\n\tstruct rcar_canfd_channel *priv = dev_id;\n\n\trcar_canfd_handle_channel_err(priv->gpriv, priv->channel);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t rcar_canfd_channel_interrupt(int irq, void *dev_id)\n{\n\tstruct rcar_canfd_global *gpriv = dev_id;\n\tu32 ch;\n\n\t \n\tfor_each_set_bit(ch, &gpriv->channels_mask, gpriv->info->max_channels) {\n\t\trcar_canfd_handle_channel_err(gpriv, ch);\n\t\trcar_canfd_handle_channel_tx(gpriv, ch);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rcar_canfd_set_bittiming(struct net_device *dev)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(dev);\n\tstruct rcar_canfd_global *gpriv = priv->gpriv;\n\tconst struct can_bittiming *bt = &priv->can.bittiming;\n\tconst struct can_bittiming *dbt = &priv->can.data_bittiming;\n\tu16 brp, sjw, tseg1, tseg2;\n\tu32 cfg;\n\tu32 ch = priv->channel;\n\n\t \n\tbrp = bt->brp - 1;\n\tsjw = bt->sjw - 1;\n\ttseg1 = bt->prop_seg + bt->phase_seg1 - 1;\n\ttseg2 = bt->phase_seg2 - 1;\n\n\tif (priv->can.ctrlmode & CAN_CTRLMODE_FD) {\n\t\t \n\t\tcfg = (RCANFD_NCFG_NTSEG1(gpriv, tseg1) | RCANFD_NCFG_NBRP(brp) |\n\t\t       RCANFD_NCFG_NSJW(gpriv, sjw) | RCANFD_NCFG_NTSEG2(gpriv, tseg2));\n\n\t\trcar_canfd_write(priv->base, RCANFD_CCFG(ch), cfg);\n\t\tnetdev_dbg(priv->ndev, \"nrate: brp %u, sjw %u, tseg1 %u, tseg2 %u\\n\",\n\t\t\t   brp, sjw, tseg1, tseg2);\n\n\t\t \n\t\tbrp = dbt->brp - 1;\n\t\tsjw = dbt->sjw - 1;\n\t\ttseg1 = dbt->prop_seg + dbt->phase_seg1 - 1;\n\t\ttseg2 = dbt->phase_seg2 - 1;\n\n\t\tcfg = (RCANFD_DCFG_DTSEG1(gpriv, tseg1) | RCANFD_DCFG_DBRP(brp) |\n\t\t       RCANFD_DCFG_DSJW(gpriv, sjw) | RCANFD_DCFG_DTSEG2(gpriv, tseg2));\n\n\t\trcar_canfd_write(priv->base, RCANFD_F_DCFG(gpriv, ch), cfg);\n\t\tnetdev_dbg(priv->ndev, \"drate: brp %u, sjw %u, tseg1 %u, tseg2 %u\\n\",\n\t\t\t   brp, sjw, tseg1, tseg2);\n\t} else {\n\t\t \n\t\tif (is_gen4(gpriv)) {\n\t\t\tcfg = (RCANFD_NCFG_NTSEG1(gpriv, tseg1) |\n\t\t\t       RCANFD_NCFG_NBRP(brp) |\n\t\t\t       RCANFD_NCFG_NSJW(gpriv, sjw) |\n\t\t\t       RCANFD_NCFG_NTSEG2(gpriv, tseg2));\n\t\t} else {\n\t\t\tcfg = (RCANFD_CFG_TSEG1(tseg1) |\n\t\t\t       RCANFD_CFG_BRP(brp) |\n\t\t\t       RCANFD_CFG_SJW(sjw) |\n\t\t\t       RCANFD_CFG_TSEG2(tseg2));\n\t\t}\n\n\t\trcar_canfd_write(priv->base, RCANFD_CCFG(ch), cfg);\n\t\tnetdev_dbg(priv->ndev,\n\t\t\t   \"rate: brp %u, sjw %u, tseg1 %u, tseg2 %u\\n\",\n\t\t\t   brp, sjw, tseg1, tseg2);\n\t}\n}\n\nstatic int rcar_canfd_start(struct net_device *ndev)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(ndev);\n\tstruct rcar_canfd_global *gpriv = priv->gpriv;\n\tint err = -EOPNOTSUPP;\n\tu32 sts, ch = priv->channel;\n\tu32 ridx = ch + RCANFD_RFFIFO_IDX;\n\n\trcar_canfd_set_bittiming(ndev);\n\n\trcar_canfd_enable_channel_interrupts(priv);\n\n\t \n\trcar_canfd_update_bit(priv->base, RCANFD_CCTR(ch),\n\t\t\t      RCANFD_CCTR_CHMDC_MASK, RCANFD_CCTR_CHDMC_COPM);\n\n\t \n\terr = readl_poll_timeout((priv->base + RCANFD_CSTS(ch)), sts,\n\t\t\t\t (sts & RCANFD_CSTS_COMSTS), 2, 500000);\n\tif (err) {\n\t\tnetdev_err(ndev, \"channel %u communication state failed\\n\", ch);\n\t\tgoto fail_mode_change;\n\t}\n\n\t \n\trcar_canfd_set_bit(priv->base, RCANFD_CFCC(gpriv, ch, RCANFD_CFFIFO_IDX),\n\t\t\t   RCANFD_CFCC_CFE);\n\trcar_canfd_set_bit(priv->base, RCANFD_RFCC(gpriv, ridx), RCANFD_RFCC_RFE);\n\n\tpriv->can.state = CAN_STATE_ERROR_ACTIVE;\n\treturn 0;\n\nfail_mode_change:\n\trcar_canfd_disable_channel_interrupts(priv);\n\treturn err;\n}\n\nstatic int rcar_canfd_open(struct net_device *ndev)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(ndev);\n\tstruct rcar_canfd_global *gpriv = priv->gpriv;\n\tint err;\n\n\terr = phy_power_on(priv->transceiver);\n\tif (err) {\n\t\tnetdev_err(ndev, \"failed to power on PHY: %pe\\n\", ERR_PTR(err));\n\t\treturn err;\n\t}\n\n\t \n\terr = clk_prepare_enable(gpriv->can_clk);\n\tif (err) {\n\t\tnetdev_err(ndev, \"failed to enable CAN clock: %pe\\n\", ERR_PTR(err));\n\t\tgoto out_phy;\n\t}\n\n\terr = open_candev(ndev);\n\tif (err) {\n\t\tnetdev_err(ndev, \"open_candev() failed: %pe\\n\", ERR_PTR(err));\n\t\tgoto out_can_clock;\n\t}\n\n\tnapi_enable(&priv->napi);\n\terr = rcar_canfd_start(ndev);\n\tif (err)\n\t\tgoto out_close;\n\tnetif_start_queue(ndev);\n\treturn 0;\nout_close:\n\tnapi_disable(&priv->napi);\n\tclose_candev(ndev);\nout_can_clock:\n\tclk_disable_unprepare(gpriv->can_clk);\nout_phy:\n\tphy_power_off(priv->transceiver);\n\treturn err;\n}\n\nstatic void rcar_canfd_stop(struct net_device *ndev)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(ndev);\n\tstruct rcar_canfd_global *gpriv = priv->gpriv;\n\tint err;\n\tu32 sts, ch = priv->channel;\n\tu32 ridx = ch + RCANFD_RFFIFO_IDX;\n\n\t \n\trcar_canfd_update_bit(priv->base, RCANFD_CCTR(ch),\n\t\t\t      RCANFD_CCTR_CHMDC_MASK, RCANFD_CCTR_CHDMC_CRESET);\n\n\t \n\terr = readl_poll_timeout((priv->base + RCANFD_CSTS(ch)), sts,\n\t\t\t\t (sts & RCANFD_CSTS_CRSTSTS), 2, 500000);\n\tif (err)\n\t\tnetdev_err(ndev, \"channel %u reset failed\\n\", ch);\n\n\trcar_canfd_disable_channel_interrupts(priv);\n\n\t \n\trcar_canfd_clear_bit(priv->base, RCANFD_CFCC(gpriv, ch, RCANFD_CFFIFO_IDX),\n\t\t\t     RCANFD_CFCC_CFE);\n\trcar_canfd_clear_bit(priv->base, RCANFD_RFCC(gpriv, ridx), RCANFD_RFCC_RFE);\n\n\t \n\tpriv->can.state = CAN_STATE_STOPPED;\n}\n\nstatic int rcar_canfd_close(struct net_device *ndev)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(ndev);\n\tstruct rcar_canfd_global *gpriv = priv->gpriv;\n\n\tnetif_stop_queue(ndev);\n\trcar_canfd_stop(ndev);\n\tnapi_disable(&priv->napi);\n\tclk_disable_unprepare(gpriv->can_clk);\n\tclose_candev(ndev);\n\tphy_power_off(priv->transceiver);\n\treturn 0;\n}\n\nstatic netdev_tx_t rcar_canfd_start_xmit(struct sk_buff *skb,\n\t\t\t\t\t struct net_device *ndev)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(ndev);\n\tstruct rcar_canfd_global *gpriv = priv->gpriv;\n\tstruct canfd_frame *cf = (struct canfd_frame *)skb->data;\n\tu32 sts = 0, id, dlc;\n\tunsigned long flags;\n\tu32 ch = priv->channel;\n\n\tif (can_dev_dropped_skb(ndev, skb))\n\t\treturn NETDEV_TX_OK;\n\n\tif (cf->can_id & CAN_EFF_FLAG) {\n\t\tid = cf->can_id & CAN_EFF_MASK;\n\t\tid |= RCANFD_CFID_CFIDE;\n\t} else {\n\t\tid = cf->can_id & CAN_SFF_MASK;\n\t}\n\n\tif (cf->can_id & CAN_RTR_FLAG)\n\t\tid |= RCANFD_CFID_CFRTR;\n\n\tdlc = RCANFD_CFPTR_CFDLC(can_fd_len2dlc(cf->len));\n\n\tif ((priv->can.ctrlmode & CAN_CTRLMODE_FD) || is_gen4(gpriv)) {\n\t\trcar_canfd_write(priv->base,\n\t\t\t\t RCANFD_F_CFID(gpriv, ch, RCANFD_CFFIFO_IDX), id);\n\t\trcar_canfd_write(priv->base,\n\t\t\t\t RCANFD_F_CFPTR(gpriv, ch, RCANFD_CFFIFO_IDX), dlc);\n\n\t\tif (can_is_canfd_skb(skb)) {\n\t\t\t \n\t\t\tsts |= RCANFD_CFFDCSTS_CFFDF;\n\t\t\tif (cf->flags & CANFD_BRS)\n\t\t\t\tsts |= RCANFD_CFFDCSTS_CFBRS;\n\n\t\t\tif (priv->can.state == CAN_STATE_ERROR_PASSIVE)\n\t\t\t\tsts |= RCANFD_CFFDCSTS_CFESI;\n\t\t}\n\n\t\trcar_canfd_write(priv->base,\n\t\t\t\t RCANFD_F_CFFDCSTS(gpriv, ch, RCANFD_CFFIFO_IDX), sts);\n\n\t\trcar_canfd_put_data(priv, cf,\n\t\t\t\t    RCANFD_F_CFDF(gpriv, ch, RCANFD_CFFIFO_IDX, 0));\n\t} else {\n\t\trcar_canfd_write(priv->base,\n\t\t\t\t RCANFD_C_CFID(ch, RCANFD_CFFIFO_IDX), id);\n\t\trcar_canfd_write(priv->base,\n\t\t\t\t RCANFD_C_CFPTR(ch, RCANFD_CFFIFO_IDX), dlc);\n\t\trcar_canfd_put_data(priv, cf,\n\t\t\t\t    RCANFD_C_CFDF(ch, RCANFD_CFFIFO_IDX, 0));\n\t}\n\n\tcan_put_echo_skb(skb, ndev, priv->tx_head % RCANFD_FIFO_DEPTH, 0);\n\n\tspin_lock_irqsave(&priv->tx_lock, flags);\n\tpriv->tx_head++;\n\n\t \n\tif (priv->tx_head - priv->tx_tail >= RCANFD_FIFO_DEPTH)\n\t\tnetif_stop_queue(ndev);\n\n\t \n\trcar_canfd_write(priv->base,\n\t\t\t RCANFD_CFPCTR(gpriv, ch, RCANFD_CFFIFO_IDX), 0xff);\n\n\tspin_unlock_irqrestore(&priv->tx_lock, flags);\n\treturn NETDEV_TX_OK;\n}\n\nstatic void rcar_canfd_rx_pkt(struct rcar_canfd_channel *priv)\n{\n\tstruct net_device_stats *stats = &priv->ndev->stats;\n\tstruct rcar_canfd_global *gpriv = priv->gpriv;\n\tstruct canfd_frame *cf;\n\tstruct sk_buff *skb;\n\tu32 sts = 0, id, dlc;\n\tu32 ch = priv->channel;\n\tu32 ridx = ch + RCANFD_RFFIFO_IDX;\n\n\tif ((priv->can.ctrlmode & CAN_CTRLMODE_FD) || is_gen4(gpriv)) {\n\t\tid = rcar_canfd_read(priv->base, RCANFD_F_RFID(gpriv, ridx));\n\t\tdlc = rcar_canfd_read(priv->base, RCANFD_F_RFPTR(gpriv, ridx));\n\n\t\tsts = rcar_canfd_read(priv->base, RCANFD_F_RFFDSTS(gpriv, ridx));\n\n\t\tif ((priv->can.ctrlmode & CAN_CTRLMODE_FD) &&\n\t\t    sts & RCANFD_RFFDSTS_RFFDF)\n\t\t\tskb = alloc_canfd_skb(priv->ndev, &cf);\n\t\telse\n\t\t\tskb = alloc_can_skb(priv->ndev,\n\t\t\t\t\t    (struct can_frame **)&cf);\n\t} else {\n\t\tid = rcar_canfd_read(priv->base, RCANFD_C_RFID(ridx));\n\t\tdlc = rcar_canfd_read(priv->base, RCANFD_C_RFPTR(ridx));\n\t\tskb = alloc_can_skb(priv->ndev, (struct can_frame **)&cf);\n\t}\n\n\tif (!skb) {\n\t\tstats->rx_dropped++;\n\t\treturn;\n\t}\n\n\tif (id & RCANFD_RFID_RFIDE)\n\t\tcf->can_id = (id & CAN_EFF_MASK) | CAN_EFF_FLAG;\n\telse\n\t\tcf->can_id = id & CAN_SFF_MASK;\n\n\tif (priv->can.ctrlmode & CAN_CTRLMODE_FD) {\n\t\tif (sts & RCANFD_RFFDSTS_RFFDF)\n\t\t\tcf->len = can_fd_dlc2len(RCANFD_RFPTR_RFDLC(dlc));\n\t\telse\n\t\t\tcf->len = can_cc_dlc2len(RCANFD_RFPTR_RFDLC(dlc));\n\n\t\tif (sts & RCANFD_RFFDSTS_RFESI) {\n\t\t\tcf->flags |= CANFD_ESI;\n\t\t\tnetdev_dbg(priv->ndev, \"ESI Error\\n\");\n\t\t}\n\n\t\tif (!(sts & RCANFD_RFFDSTS_RFFDF) && (id & RCANFD_RFID_RFRTR)) {\n\t\t\tcf->can_id |= CAN_RTR_FLAG;\n\t\t} else {\n\t\t\tif (sts & RCANFD_RFFDSTS_RFBRS)\n\t\t\t\tcf->flags |= CANFD_BRS;\n\n\t\t\trcar_canfd_get_data(priv, cf, RCANFD_F_RFDF(gpriv, ridx, 0));\n\t\t}\n\t} else {\n\t\tcf->len = can_cc_dlc2len(RCANFD_RFPTR_RFDLC(dlc));\n\t\tif (id & RCANFD_RFID_RFRTR)\n\t\t\tcf->can_id |= CAN_RTR_FLAG;\n\t\telse if (is_gen4(gpriv))\n\t\t\trcar_canfd_get_data(priv, cf, RCANFD_F_RFDF(gpriv, ridx, 0));\n\t\telse\n\t\t\trcar_canfd_get_data(priv, cf, RCANFD_C_RFDF(ridx, 0));\n\t}\n\n\t \n\trcar_canfd_write(priv->base, RCANFD_RFPCTR(gpriv, ridx), 0xff);\n\n\tif (!(cf->can_id & CAN_RTR_FLAG))\n\t\tstats->rx_bytes += cf->len;\n\tstats->rx_packets++;\n\tnetif_receive_skb(skb);\n}\n\nstatic int rcar_canfd_rx_poll(struct napi_struct *napi, int quota)\n{\n\tstruct rcar_canfd_channel *priv =\n\t\tcontainer_of(napi, struct rcar_canfd_channel, napi);\n\tstruct rcar_canfd_global *gpriv = priv->gpriv;\n\tint num_pkts;\n\tu32 sts;\n\tu32 ch = priv->channel;\n\tu32 ridx = ch + RCANFD_RFFIFO_IDX;\n\n\tfor (num_pkts = 0; num_pkts < quota; num_pkts++) {\n\t\tsts = rcar_canfd_read(priv->base, RCANFD_RFSTS(gpriv, ridx));\n\t\t \n\t\tif (sts & RCANFD_RFSTS_RFEMP)\n\t\t\tbreak;\n\n\t\trcar_canfd_rx_pkt(priv);\n\n\t\t \n\t\tif (sts & RCANFD_RFSTS_RFIF)\n\t\t\trcar_canfd_write(priv->base, RCANFD_RFSTS(gpriv, ridx),\n\t\t\t\t\t sts & ~RCANFD_RFSTS_RFIF);\n\t}\n\n\t \n\tif (num_pkts < quota) {\n\t\tif (napi_complete_done(napi, num_pkts)) {\n\t\t\t \n\t\t\trcar_canfd_set_bit(priv->base, RCANFD_RFCC(gpriv, ridx),\n\t\t\t\t\t   RCANFD_RFCC_RFIE);\n\t\t}\n\t}\n\treturn num_pkts;\n}\n\nstatic int rcar_canfd_do_set_mode(struct net_device *ndev, enum can_mode mode)\n{\n\tint err;\n\n\tswitch (mode) {\n\tcase CAN_MODE_START:\n\t\terr = rcar_canfd_start(ndev);\n\t\tif (err)\n\t\t\treturn err;\n\t\tnetif_wake_queue(ndev);\n\t\treturn 0;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int rcar_canfd_get_berr_counter(const struct net_device *dev,\n\t\t\t\t       struct can_berr_counter *bec)\n{\n\tstruct rcar_canfd_channel *priv = netdev_priv(dev);\n\tu32 val, ch = priv->channel;\n\n\t \n\tval = rcar_canfd_read(priv->base, RCANFD_CSTS(ch));\n\tbec->txerr = RCANFD_CSTS_TECCNT(val);\n\tbec->rxerr = RCANFD_CSTS_RECCNT(val);\n\treturn 0;\n}\n\nstatic const struct net_device_ops rcar_canfd_netdev_ops = {\n\t.ndo_open = rcar_canfd_open,\n\t.ndo_stop = rcar_canfd_close,\n\t.ndo_start_xmit = rcar_canfd_start_xmit,\n\t.ndo_change_mtu = can_change_mtu,\n};\n\nstatic const struct ethtool_ops rcar_canfd_ethtool_ops = {\n\t.get_ts_info = ethtool_op_get_ts_info,\n};\n\nstatic int rcar_canfd_channel_probe(struct rcar_canfd_global *gpriv, u32 ch,\n\t\t\t\t    u32 fcan_freq, struct phy *transceiver)\n{\n\tconst struct rcar_canfd_hw_info *info = gpriv->info;\n\tstruct platform_device *pdev = gpriv->pdev;\n\tstruct device *dev = &pdev->dev;\n\tstruct rcar_canfd_channel *priv;\n\tstruct net_device *ndev;\n\tint err = -ENODEV;\n\n\tndev = alloc_candev(sizeof(*priv), RCANFD_FIFO_DEPTH);\n\tif (!ndev)\n\t\treturn -ENOMEM;\n\n\tpriv = netdev_priv(ndev);\n\n\tndev->netdev_ops = &rcar_canfd_netdev_ops;\n\tndev->ethtool_ops = &rcar_canfd_ethtool_ops;\n\tndev->flags |= IFF_ECHO;\n\tpriv->ndev = ndev;\n\tpriv->base = gpriv->base;\n\tpriv->transceiver = transceiver;\n\tpriv->channel = ch;\n\tpriv->gpriv = gpriv;\n\tif (transceiver)\n\t\tpriv->can.bitrate_max = transceiver->attrs.max_link_rate;\n\tpriv->can.clock.freq = fcan_freq;\n\tdev_info(dev, \"can_clk rate is %u\\n\", priv->can.clock.freq);\n\n\tif (info->multi_channel_irqs) {\n\t\tchar *irq_name;\n\t\tint err_irq;\n\t\tint tx_irq;\n\n\t\terr_irq = platform_get_irq_byname(pdev, ch == 0 ? \"ch0_err\" : \"ch1_err\");\n\t\tif (err_irq < 0) {\n\t\t\terr = err_irq;\n\t\t\tgoto fail;\n\t\t}\n\n\t\ttx_irq = platform_get_irq_byname(pdev, ch == 0 ? \"ch0_trx\" : \"ch1_trx\");\n\t\tif (tx_irq < 0) {\n\t\t\terr = tx_irq;\n\t\t\tgoto fail;\n\t\t}\n\n\t\tirq_name = devm_kasprintf(dev, GFP_KERNEL, \"canfd.ch%d_err\",\n\t\t\t\t\t  ch);\n\t\tif (!irq_name) {\n\t\t\terr = -ENOMEM;\n\t\t\tgoto fail;\n\t\t}\n\t\terr = devm_request_irq(dev, err_irq,\n\t\t\t\t       rcar_canfd_channel_err_interrupt, 0,\n\t\t\t\t       irq_name, priv);\n\t\tif (err) {\n\t\t\tdev_err(dev, \"devm_request_irq CH Err %d failed: %pe\\n\",\n\t\t\t\terr_irq, ERR_PTR(err));\n\t\t\tgoto fail;\n\t\t}\n\t\tirq_name = devm_kasprintf(dev, GFP_KERNEL, \"canfd.ch%d_trx\",\n\t\t\t\t\t  ch);\n\t\tif (!irq_name) {\n\t\t\terr = -ENOMEM;\n\t\t\tgoto fail;\n\t\t}\n\t\terr = devm_request_irq(dev, tx_irq,\n\t\t\t\t       rcar_canfd_channel_tx_interrupt, 0,\n\t\t\t\t       irq_name, priv);\n\t\tif (err) {\n\t\t\tdev_err(dev, \"devm_request_irq Tx %d failed: %pe\\n\",\n\t\t\t\ttx_irq, ERR_PTR(err));\n\t\t\tgoto fail;\n\t\t}\n\t}\n\n\tif (gpriv->fdmode) {\n\t\tpriv->can.bittiming_const = &rcar_canfd_nom_bittiming_const;\n\t\tpriv->can.data_bittiming_const =\n\t\t\t&rcar_canfd_data_bittiming_const;\n\n\t\t \n\t\terr = can_set_static_ctrlmode(ndev, CAN_CTRLMODE_FD);\n\t\tif (err)\n\t\t\tgoto fail;\n\t\tpriv->can.ctrlmode_supported = CAN_CTRLMODE_BERR_REPORTING;\n\t} else {\n\t\t \n\t\tpriv->can.bittiming_const = &rcar_canfd_bittiming_const;\n\t\tpriv->can.ctrlmode_supported = CAN_CTRLMODE_BERR_REPORTING;\n\t}\n\n\tpriv->can.do_set_mode = rcar_canfd_do_set_mode;\n\tpriv->can.do_get_berr_counter = rcar_canfd_get_berr_counter;\n\tSET_NETDEV_DEV(ndev, dev);\n\n\tnetif_napi_add_weight(ndev, &priv->napi, rcar_canfd_rx_poll,\n\t\t\t      RCANFD_NAPI_WEIGHT);\n\tspin_lock_init(&priv->tx_lock);\n\tgpriv->ch[priv->channel] = priv;\n\terr = register_candev(ndev);\n\tif (err) {\n\t\tdev_err(dev, \"register_candev() failed: %pe\\n\", ERR_PTR(err));\n\t\tgoto fail_candev;\n\t}\n\tdev_info(dev, \"device registered (channel %u)\\n\", priv->channel);\n\treturn 0;\n\nfail_candev:\n\tnetif_napi_del(&priv->napi);\nfail:\n\tfree_candev(ndev);\n\treturn err;\n}\n\nstatic void rcar_canfd_channel_remove(struct rcar_canfd_global *gpriv, u32 ch)\n{\n\tstruct rcar_canfd_channel *priv = gpriv->ch[ch];\n\n\tif (priv) {\n\t\tunregister_candev(priv->ndev);\n\t\tnetif_napi_del(&priv->napi);\n\t\tfree_candev(priv->ndev);\n\t}\n}\n\nstatic int rcar_canfd_probe(struct platform_device *pdev)\n{\n\tstruct phy *transceivers[RCANFD_NUM_CHANNELS] = { NULL, };\n\tconst struct rcar_canfd_hw_info *info;\n\tstruct device *dev = &pdev->dev;\n\tvoid __iomem *addr;\n\tu32 sts, ch, fcan_freq;\n\tstruct rcar_canfd_global *gpriv;\n\tstruct device_node *of_child;\n\tunsigned long channels_mask = 0;\n\tint err, ch_irq, g_irq;\n\tint g_err_irq, g_recc_irq;\n\tbool fdmode = true;\t\t\t \n\tchar name[9] = \"channelX\";\n\tint i;\n\n\tinfo = of_device_get_match_data(dev);\n\n\tif (of_property_read_bool(dev->of_node, \"renesas,no-can-fd\"))\n\t\tfdmode = false;\t\t\t \n\n\tfor (i = 0; i < info->max_channels; ++i) {\n\t\tname[7] = '0' + i;\n\t\tof_child = of_get_child_by_name(dev->of_node, name);\n\t\tif (of_child && of_device_is_available(of_child)) {\n\t\t\tchannels_mask |= BIT(i);\n\t\t\ttransceivers[i] = devm_of_phy_optional_get(dev,\n\t\t\t\t\t\t\tof_child, NULL);\n\t\t}\n\t\tof_node_put(of_child);\n\t\tif (IS_ERR(transceivers[i]))\n\t\t\treturn PTR_ERR(transceivers[i]);\n\t}\n\n\tif (info->shared_global_irqs) {\n\t\tch_irq = platform_get_irq_byname_optional(pdev, \"ch_int\");\n\t\tif (ch_irq < 0) {\n\t\t\t \n\t\t\tch_irq = platform_get_irq(pdev, 0);\n\t\t\tif (ch_irq < 0)\n\t\t\t\treturn ch_irq;\n\t\t}\n\n\t\tg_irq = platform_get_irq_byname_optional(pdev, \"g_int\");\n\t\tif (g_irq < 0) {\n\t\t\t \n\t\t\tg_irq = platform_get_irq(pdev, 1);\n\t\t\tif (g_irq < 0)\n\t\t\t\treturn g_irq;\n\t\t}\n\t} else {\n\t\tg_err_irq = platform_get_irq_byname(pdev, \"g_err\");\n\t\tif (g_err_irq < 0)\n\t\t\treturn g_err_irq;\n\n\t\tg_recc_irq = platform_get_irq_byname(pdev, \"g_recc\");\n\t\tif (g_recc_irq < 0)\n\t\t\treturn g_recc_irq;\n\t}\n\n\t \n\tgpriv = devm_kzalloc(dev, sizeof(*gpriv), GFP_KERNEL);\n\tif (!gpriv)\n\t\treturn -ENOMEM;\n\n\tgpriv->pdev = pdev;\n\tgpriv->channels_mask = channels_mask;\n\tgpriv->fdmode = fdmode;\n\tgpriv->info = info;\n\n\tgpriv->rstc1 = devm_reset_control_get_optional_exclusive(dev, \"rstp_n\");\n\tif (IS_ERR(gpriv->rstc1))\n\t\treturn dev_err_probe(dev, PTR_ERR(gpriv->rstc1),\n\t\t\t\t     \"failed to get rstp_n\\n\");\n\n\tgpriv->rstc2 = devm_reset_control_get_optional_exclusive(dev, \"rstc_n\");\n\tif (IS_ERR(gpriv->rstc2))\n\t\treturn dev_err_probe(dev, PTR_ERR(gpriv->rstc2),\n\t\t\t\t     \"failed to get rstc_n\\n\");\n\n\t \n\tgpriv->clkp = devm_clk_get(dev, \"fck\");\n\tif (IS_ERR(gpriv->clkp))\n\t\treturn dev_err_probe(dev, PTR_ERR(gpriv->clkp),\n\t\t\t\t     \"cannot get peripheral clock\\n\");\n\n\t \n\tgpriv->can_clk = devm_clk_get(dev, \"can_clk\");\n\tif (IS_ERR(gpriv->can_clk) || (clk_get_rate(gpriv->can_clk) == 0)) {\n\t\tgpriv->can_clk = devm_clk_get(dev, \"canfd\");\n\t\tif (IS_ERR(gpriv->can_clk))\n\t\t\treturn dev_err_probe(dev, PTR_ERR(gpriv->can_clk),\n\t\t\t\t\t     \"cannot get canfd clock\\n\");\n\n\t\tgpriv->fcan = RCANFD_CANFDCLK;\n\n\t} else {\n\t\tgpriv->fcan = RCANFD_EXTCLK;\n\t}\n\tfcan_freq = clk_get_rate(gpriv->can_clk);\n\n\tif (gpriv->fcan == RCANFD_CANFDCLK)\n\t\t \n\t\tfcan_freq /= info->postdiv;\n\n\taddr = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(addr)) {\n\t\terr = PTR_ERR(addr);\n\t\tgoto fail_dev;\n\t}\n\tgpriv->base = addr;\n\n\t \n\tif (info->shared_global_irqs) {\n\t\terr = devm_request_irq(dev, ch_irq,\n\t\t\t\t       rcar_canfd_channel_interrupt, 0,\n\t\t\t\t       \"canfd.ch_int\", gpriv);\n\t\tif (err) {\n\t\t\tdev_err(dev, \"devm_request_irq %d failed: %pe\\n\",\n\t\t\t\tch_irq, ERR_PTR(err));\n\t\t\tgoto fail_dev;\n\t\t}\n\n\t\terr = devm_request_irq(dev, g_irq, rcar_canfd_global_interrupt,\n\t\t\t\t       0, \"canfd.g_int\", gpriv);\n\t\tif (err) {\n\t\t\tdev_err(dev, \"devm_request_irq %d failed: %pe\\n\",\n\t\t\t\tg_irq, ERR_PTR(err));\n\t\t\tgoto fail_dev;\n\t\t}\n\t} else {\n\t\terr = devm_request_irq(dev, g_recc_irq,\n\t\t\t\t       rcar_canfd_global_receive_fifo_interrupt, 0,\n\t\t\t\t       \"canfd.g_recc\", gpriv);\n\n\t\tif (err) {\n\t\t\tdev_err(dev, \"devm_request_irq %d failed: %pe\\n\",\n\t\t\t\tg_recc_irq, ERR_PTR(err));\n\t\t\tgoto fail_dev;\n\t\t}\n\n\t\terr = devm_request_irq(dev, g_err_irq,\n\t\t\t\t       rcar_canfd_global_err_interrupt, 0,\n\t\t\t\t       \"canfd.g_err\", gpriv);\n\t\tif (err) {\n\t\t\tdev_err(dev, \"devm_request_irq %d failed: %pe\\n\",\n\t\t\t\tg_err_irq, ERR_PTR(err));\n\t\t\tgoto fail_dev;\n\t\t}\n\t}\n\n\terr = reset_control_reset(gpriv->rstc1);\n\tif (err)\n\t\tgoto fail_dev;\n\terr = reset_control_reset(gpriv->rstc2);\n\tif (err) {\n\t\treset_control_assert(gpriv->rstc1);\n\t\tgoto fail_dev;\n\t}\n\n\t \n\terr = clk_prepare_enable(gpriv->clkp);\n\tif (err) {\n\t\tdev_err(dev, \"failed to enable peripheral clock: %pe\\n\",\n\t\t\tERR_PTR(err));\n\t\tgoto fail_reset;\n\t}\n\n\terr = rcar_canfd_reset_controller(gpriv);\n\tif (err) {\n\t\tdev_err(dev, \"reset controller failed: %pe\\n\", ERR_PTR(err));\n\t\tgoto fail_clk;\n\t}\n\n\t \n\trcar_canfd_configure_controller(gpriv);\n\n\t \n\tfor_each_set_bit(ch, &gpriv->channels_mask, info->max_channels) {\n\t\t \n\t\trcar_canfd_configure_rx(gpriv, ch);\n\n\t\t \n\t\trcar_canfd_configure_tx(gpriv, ch);\n\n\t\t \n\t\trcar_canfd_configure_afl_rules(gpriv, ch);\n\t}\n\n\t \n\trcar_canfd_enable_global_interrupts(gpriv);\n\n\t \n\trcar_canfd_update_bit(gpriv->base, RCANFD_GCTR, RCANFD_GCTR_GMDC_MASK,\n\t\t\t      RCANFD_GCTR_GMDC_GOPM);\n\n\t \n\terr = readl_poll_timeout((gpriv->base + RCANFD_GSTS), sts,\n\t\t\t\t !(sts & RCANFD_GSTS_GNOPM), 2, 500000);\n\tif (err) {\n\t\tdev_err(dev, \"global operational mode failed\\n\");\n\t\tgoto fail_mode;\n\t}\n\n\tfor_each_set_bit(ch, &gpriv->channels_mask, info->max_channels) {\n\t\terr = rcar_canfd_channel_probe(gpriv, ch, fcan_freq,\n\t\t\t\t\t       transceivers[ch]);\n\t\tif (err)\n\t\t\tgoto fail_channel;\n\t}\n\n\tplatform_set_drvdata(pdev, gpriv);\n\tdev_info(dev, \"global operational state (clk %d, fdmode %d)\\n\",\n\t\t gpriv->fcan, gpriv->fdmode);\n\treturn 0;\n\nfail_channel:\n\tfor_each_set_bit(ch, &gpriv->channels_mask, info->max_channels)\n\t\trcar_canfd_channel_remove(gpriv, ch);\nfail_mode:\n\trcar_canfd_disable_global_interrupts(gpriv);\nfail_clk:\n\tclk_disable_unprepare(gpriv->clkp);\nfail_reset:\n\treset_control_assert(gpriv->rstc1);\n\treset_control_assert(gpriv->rstc2);\nfail_dev:\n\treturn err;\n}\n\nstatic void rcar_canfd_remove(struct platform_device *pdev)\n{\n\tstruct rcar_canfd_global *gpriv = platform_get_drvdata(pdev);\n\tu32 ch;\n\n\trcar_canfd_reset_controller(gpriv);\n\trcar_canfd_disable_global_interrupts(gpriv);\n\n\tfor_each_set_bit(ch, &gpriv->channels_mask, gpriv->info->max_channels) {\n\t\trcar_canfd_disable_channel_interrupts(gpriv->ch[ch]);\n\t\trcar_canfd_channel_remove(gpriv, ch);\n\t}\n\n\t \n\trcar_canfd_set_bit(gpriv->base, RCANFD_GCTR, RCANFD_GCTR_GSLPR);\n\tclk_disable_unprepare(gpriv->clkp);\n\treset_control_assert(gpriv->rstc1);\n\treset_control_assert(gpriv->rstc2);\n}\n\nstatic int __maybe_unused rcar_canfd_suspend(struct device *dev)\n{\n\treturn 0;\n}\n\nstatic int __maybe_unused rcar_canfd_resume(struct device *dev)\n{\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(rcar_canfd_pm_ops, rcar_canfd_suspend,\n\t\t\t rcar_canfd_resume);\n\nstatic const __maybe_unused struct of_device_id rcar_canfd_of_table[] = {\n\t{ .compatible = \"renesas,r8a779a0-canfd\", .data = &rcar_gen4_hw_info },\n\t{ .compatible = \"renesas,rcar-gen3-canfd\", .data = &rcar_gen3_hw_info },\n\t{ .compatible = \"renesas,rcar-gen4-canfd\", .data = &rcar_gen4_hw_info },\n\t{ .compatible = \"renesas,rzg2l-canfd\", .data = &rzg2l_hw_info },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(of, rcar_canfd_of_table);\n\nstatic struct platform_driver rcar_canfd_driver = {\n\t.driver = {\n\t\t.name = RCANFD_DRV_NAME,\n\t\t.of_match_table = of_match_ptr(rcar_canfd_of_table),\n\t\t.pm = &rcar_canfd_pm_ops,\n\t},\n\t.probe = rcar_canfd_probe,\n\t.remove_new = rcar_canfd_remove,\n};\n\nmodule_platform_driver(rcar_canfd_driver);\n\nMODULE_AUTHOR(\"Ramesh Shanmugasundaram <ramesh.shanmugasundaram@bp.renesas.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"CAN FD driver for Renesas R-Car SoC\");\nMODULE_ALIAS(\"platform:\" RCANFD_DRV_NAME);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}