{
  "module_name": "mcp251xfd-timestamp.c",
  "hash_id": "10a3f77a02fe94891dbf2f2328911507371d0bcfb62b9a93479d03e584754c4c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/can/spi/mcp251xfd/mcp251xfd-timestamp.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/clocksource.h>\n#include <linux/workqueue.h>\n\n#include \"mcp251xfd.h\"\n\nstatic u64 mcp251xfd_timestamp_read(const struct cyclecounter *cc)\n{\n\tconst struct mcp251xfd_priv *priv;\n\tu32 timestamp = 0;\n\tint err;\n\n\tpriv = container_of(cc, struct mcp251xfd_priv, cc);\n\terr = mcp251xfd_get_timestamp(priv, &timestamp);\n\tif (err)\n\t\tnetdev_err(priv->ndev,\n\t\t\t   \"Error %d while reading timestamp. HW timestamps may be inaccurate.\",\n\t\t\t   err);\n\n\treturn timestamp;\n}\n\nstatic void mcp251xfd_timestamp_work(struct work_struct *work)\n{\n\tstruct delayed_work *delayed_work = to_delayed_work(work);\n\tstruct mcp251xfd_priv *priv;\n\n\tpriv = container_of(delayed_work, struct mcp251xfd_priv, timestamp);\n\ttimecounter_read(&priv->tc);\n\n\tschedule_delayed_work(&priv->timestamp,\n\t\t\t      MCP251XFD_TIMESTAMP_WORK_DELAY_SEC * HZ);\n}\n\nvoid mcp251xfd_skb_set_timestamp(const struct mcp251xfd_priv *priv,\n\t\t\t\t struct sk_buff *skb, u32 timestamp)\n{\n\tstruct skb_shared_hwtstamps *hwtstamps = skb_hwtstamps(skb);\n\tu64 ns;\n\n\tns = timecounter_cyc2time(&priv->tc, timestamp);\n\thwtstamps->hwtstamp = ns_to_ktime(ns);\n}\n\nvoid mcp251xfd_timestamp_init(struct mcp251xfd_priv *priv)\n{\n\tstruct cyclecounter *cc = &priv->cc;\n\n\tcc->read = mcp251xfd_timestamp_read;\n\tcc->mask = CYCLECOUNTER_MASK(32);\n\tcc->shift = 1;\n\tcc->mult = clocksource_hz2mult(priv->can.clock.freq, cc->shift);\n\n\ttimecounter_init(&priv->tc, &priv->cc, ktime_get_real_ns());\n\n\tINIT_DELAYED_WORK(&priv->timestamp, mcp251xfd_timestamp_work);\n\tschedule_delayed_work(&priv->timestamp,\n\t\t\t      MCP251XFD_TIMESTAMP_WORK_DELAY_SEC * HZ);\n}\n\nvoid mcp251xfd_timestamp_stop(struct mcp251xfd_priv *priv)\n{\n\tcancel_delayed_work_sync(&priv->timestamp);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}