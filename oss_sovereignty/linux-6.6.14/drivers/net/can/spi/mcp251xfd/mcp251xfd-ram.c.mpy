{
  "module_name": "mcp251xfd-ram.c",
  "hash_id": "da9c3d56851aef9785299866d33a178c59258ef68e383dcc81af936c38ab5159",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/can/spi/mcp251xfd/mcp251xfd-ram.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include \"mcp251xfd-ram.h\"\n\nstatic inline u8 can_ram_clamp(const struct can_ram_config *config,\n\t\t\t       const struct can_ram_obj_config *obj,\n\t\t\t       u8 val)\n{\n\tu8 max;\n\n\tmax = min_t(u8, obj->max, obj->fifo_num * config->fifo_depth);\n\treturn clamp(val, obj->min, max);\n}\n\nstatic u8\ncan_ram_rounddown_pow_of_two(const struct can_ram_config *config,\n\t\t\t     const struct can_ram_obj_config *obj,\n\t\t\t     const u8 coalesce, u8 val)\n{\n\tu8 fifo_num = obj->fifo_num;\n\tu8 ret = 0, i;\n\n\tval = can_ram_clamp(config, obj, val);\n\n\tif (coalesce) {\n\t\t \n\t\tret = min_t(u8, coalesce * 2, config->fifo_depth);\n\t\tval -= ret;\n\t\tfifo_num--;\n\t}\n\n\tfor (i = 0; i < fifo_num && val; i++) {\n\t\tu8 n;\n\n\t\tn = min_t(u8, rounddown_pow_of_two(val),\n\t\t\t  config->fifo_depth);\n\n\t\t \n\t\tif (n < obj->fifo_depth_min)\n\t\t\treturn ret;\n\n\t\tret += n;\n\t\tval -= n;\n\t}\n\n\treturn ret;\n}\n\nvoid can_ram_get_layout(struct can_ram_layout *layout,\n\t\t\tconst struct can_ram_config *config,\n\t\t\tconst struct ethtool_ringparam *ring,\n\t\t\tconst struct ethtool_coalesce *ec,\n\t\t\tconst bool fd_mode)\n{\n\tu8 num_rx, num_tx;\n\tu16 ram_free;\n\n\t \n\n\tnum_tx = config->tx.def[fd_mode];\n\tnum_tx = can_ram_rounddown_pow_of_two(config, &config->tx, 0, num_tx);\n\n\tram_free = config->size;\n\tram_free -= config->tx.size[fd_mode] * num_tx;\n\n\tnum_rx = ram_free / config->rx.size[fd_mode];\n\n\tlayout->default_rx = can_ram_rounddown_pow_of_two(config, &config->rx, 0, num_rx);\n\tlayout->default_tx = num_tx;\n\n\t \n\n\tram_free = config->size;\n\tram_free -= config->tx.size[fd_mode] * config->tx.min;\n\tnum_rx = ram_free / config->rx.size[fd_mode];\n\n\tram_free = config->size;\n\tram_free -= config->rx.size[fd_mode] * config->rx.min;\n\tnum_tx = ram_free / config->tx.size[fd_mode];\n\n\tlayout->max_rx = can_ram_rounddown_pow_of_two(config, &config->rx, 0, num_rx);\n\tlayout->max_tx = can_ram_rounddown_pow_of_two(config, &config->tx, 0, num_tx);\n\n\t \n\n\tif (ring) {\n\t\tu8 num_rx_coalesce = 0, num_tx_coalesce = 0;\n\n\t\tnum_rx = can_ram_rounddown_pow_of_two(config, &config->rx, 0, ring->rx_pending);\n\n\t\t \n\t\tif (ec && !(ec->rx_coalesce_usecs_irq == 0 &&\n\t\t\t    ec->rx_max_coalesced_frames_irq == 1)) {\n\t\t\tu8 max;\n\n\t\t\t \n\t\t\tmax = min_t(u8, num_rx / 2, config->fifo_depth);\n\t\t\tnum_rx_coalesce = clamp(ec->rx_max_coalesced_frames_irq,\n\t\t\t\t\t\t(u32)config->rx.fifo_depth_coalesce_min,\n\t\t\t\t\t\t(u32)max);\n\t\t\tnum_rx_coalesce = rounddown_pow_of_two(num_rx_coalesce);\n\n\t\t\tnum_rx = can_ram_rounddown_pow_of_two(config, &config->rx,\n\t\t\t\t\t\t\t      num_rx_coalesce, num_rx);\n\t\t}\n\n\t\tram_free = config->size - config->rx.size[fd_mode] * num_rx;\n\t\tnum_tx = ram_free / config->tx.size[fd_mode];\n\t\tnum_tx = min_t(u8, ring->tx_pending, num_tx);\n\t\tnum_tx = can_ram_rounddown_pow_of_two(config, &config->tx, 0, num_tx);\n\n\t\t \n\t\tif (ec && !(ec->tx_coalesce_usecs_irq == 0 &&\n\t\t\t    ec->tx_max_coalesced_frames_irq == 1)) {\n\t\t\tu8 max;\n\n\t\t\t \n\t\t\tmax = min_t(u8, num_tx / 2, config->fifo_depth);\n\t\t\tnum_tx_coalesce = clamp(ec->tx_max_coalesced_frames_irq,\n\t\t\t\t\t\t(u32)config->tx.fifo_depth_coalesce_min,\n\t\t\t\t\t\t(u32)max);\n\t\t\tnum_tx_coalesce = rounddown_pow_of_two(num_tx_coalesce);\n\n\t\t\tnum_tx = can_ram_rounddown_pow_of_two(config, &config->tx,\n\t\t\t\t\t\t\t      num_tx_coalesce, num_tx);\n\t\t}\n\n\t\tlayout->cur_rx = num_rx;\n\t\tlayout->cur_tx = num_tx;\n\t\tlayout->rx_coalesce = num_rx_coalesce;\n\t\tlayout->tx_coalesce = num_tx_coalesce;\n\t} else {\n\t\tlayout->cur_rx = layout->default_rx;\n\t\tlayout->cur_tx = layout->default_tx;\n\t\tlayout->rx_coalesce = 0;\n\t\tlayout->tx_coalesce = 0;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}