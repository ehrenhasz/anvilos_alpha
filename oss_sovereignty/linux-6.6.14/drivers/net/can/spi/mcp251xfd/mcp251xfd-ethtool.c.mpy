{
  "module_name": "mcp251xfd-ethtool.c",
  "hash_id": "871944e921e6a69767520fea95c949bc69a1ff88e67e889001ad71446fdfbd23",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/can/spi/mcp251xfd/mcp251xfd-ethtool.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n#include <linux/ethtool.h>\n\n#include \"mcp251xfd.h\"\n#include \"mcp251xfd-ram.h\"\n\nstatic void\nmcp251xfd_ring_get_ringparam(struct net_device *ndev,\n\t\t\t     struct ethtool_ringparam *ring,\n\t\t\t     struct kernel_ethtool_ringparam *kernel_ring,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\tconst struct mcp251xfd_priv *priv = netdev_priv(ndev);\n\tconst bool fd_mode = mcp251xfd_is_fd_mode(priv);\n\tstruct can_ram_layout layout;\n\n\tcan_ram_get_layout(&layout, &mcp251xfd_ram_config, NULL, NULL, fd_mode);\n\tring->rx_max_pending = layout.max_rx;\n\tring->tx_max_pending = layout.max_tx;\n\n\tring->rx_pending = priv->rx_obj_num;\n\tring->tx_pending = priv->tx->obj_num;\n}\n\nstatic int\nmcp251xfd_ring_set_ringparam(struct net_device *ndev,\n\t\t\t     struct ethtool_ringparam *ring,\n\t\t\t     struct kernel_ethtool_ringparam *kernel_ring,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct mcp251xfd_priv *priv = netdev_priv(ndev);\n\tconst bool fd_mode = mcp251xfd_is_fd_mode(priv);\n\tstruct can_ram_layout layout;\n\n\tcan_ram_get_layout(&layout, &mcp251xfd_ram_config, ring, NULL, fd_mode);\n\tif ((layout.cur_rx != priv->rx_obj_num ||\n\t     layout.cur_tx != priv->tx->obj_num) &&\n\t    netif_running(ndev))\n\t\treturn -EBUSY;\n\n\tpriv->rx_obj_num = layout.cur_rx;\n\tpriv->rx_obj_num_coalesce_irq = layout.rx_coalesce;\n\tpriv->tx->obj_num = layout.cur_tx;\n\tpriv->tx_obj_num_coalesce_irq = layout.tx_coalesce;\n\n\treturn 0;\n}\n\nstatic int mcp251xfd_ring_get_coalesce(struct net_device *ndev,\n\t\t\t\t       struct ethtool_coalesce *ec,\n\t\t\t\t       struct kernel_ethtool_coalesce *kec,\n\t\t\t\t       struct netlink_ext_ack *ext_ack)\n{\n\tstruct mcp251xfd_priv *priv = netdev_priv(ndev);\n\tu32 rx_max_frames, tx_max_frames;\n\n\t \n\tif (priv->rx_obj_num_coalesce_irq == 0)\n\t\trx_max_frames = 1;\n\telse\n\t\trx_max_frames = priv->rx_obj_num_coalesce_irq;\n\n\tec->rx_max_coalesced_frames_irq = rx_max_frames;\n\tec->rx_coalesce_usecs_irq = priv->rx_coalesce_usecs_irq;\n\n\tif (priv->tx_obj_num_coalesce_irq == 0)\n\t\ttx_max_frames = 1;\n\telse\n\t\ttx_max_frames = priv->tx_obj_num_coalesce_irq;\n\n\tec->tx_max_coalesced_frames_irq = tx_max_frames;\n\tec->tx_coalesce_usecs_irq = priv->tx_coalesce_usecs_irq;\n\n\treturn 0;\n}\n\nstatic int mcp251xfd_ring_set_coalesce(struct net_device *ndev,\n\t\t\t\t       struct ethtool_coalesce *ec,\n\t\t\t\t       struct kernel_ethtool_coalesce *kec,\n\t\t\t\t       struct netlink_ext_ack *ext_ack)\n{\n\tstruct mcp251xfd_priv *priv = netdev_priv(ndev);\n\tconst bool fd_mode = mcp251xfd_is_fd_mode(priv);\n\tconst struct ethtool_ringparam ring = {\n\t\t.rx_pending = priv->rx_obj_num,\n\t\t.tx_pending = priv->tx->obj_num,\n\t};\n\tstruct can_ram_layout layout;\n\n\tcan_ram_get_layout(&layout, &mcp251xfd_ram_config, &ring, ec, fd_mode);\n\n\tif ((layout.rx_coalesce != priv->rx_obj_num_coalesce_irq ||\n\t     ec->rx_coalesce_usecs_irq != priv->rx_coalesce_usecs_irq ||\n\t     layout.tx_coalesce != priv->tx_obj_num_coalesce_irq ||\n\t     ec->tx_coalesce_usecs_irq != priv->tx_coalesce_usecs_irq) &&\n\t    netif_running(ndev))\n\t\treturn -EBUSY;\n\n\tpriv->rx_obj_num = layout.cur_rx;\n\tpriv->rx_obj_num_coalesce_irq = layout.rx_coalesce;\n\tpriv->rx_coalesce_usecs_irq = ec->rx_coalesce_usecs_irq;\n\n\tpriv->tx->obj_num = layout.cur_tx;\n\tpriv->tx_obj_num_coalesce_irq = layout.tx_coalesce;\n\tpriv->tx_coalesce_usecs_irq = ec->tx_coalesce_usecs_irq;\n\n\treturn 0;\n}\n\nstatic const struct ethtool_ops mcp251xfd_ethtool_ops = {\n\t.supported_coalesce_params = ETHTOOL_COALESCE_RX_USECS_IRQ |\n\t\tETHTOOL_COALESCE_RX_MAX_FRAMES_IRQ |\n\t\tETHTOOL_COALESCE_TX_USECS_IRQ |\n\t\tETHTOOL_COALESCE_TX_MAX_FRAMES_IRQ,\n\t.get_ringparam = mcp251xfd_ring_get_ringparam,\n\t.set_ringparam = mcp251xfd_ring_set_ringparam,\n\t.get_coalesce = mcp251xfd_ring_get_coalesce,\n\t.set_coalesce = mcp251xfd_ring_set_coalesce,\n\t.get_ts_info = can_ethtool_op_get_ts_info_hwts,\n};\n\nvoid mcp251xfd_ethtool_init(struct mcp251xfd_priv *priv)\n{\n\tstruct can_ram_layout layout;\n\n\tpriv->ndev->ethtool_ops = &mcp251xfd_ethtool_ops;\n\n\tcan_ram_get_layout(&layout, &mcp251xfd_ram_config, NULL, NULL, false);\n\tpriv->rx_obj_num = layout.default_rx;\n\tpriv->tx->obj_num = layout.default_tx;\n\n\tpriv->rx_obj_num_coalesce_irq = 0;\n\tpriv->tx_obj_num_coalesce_irq = 0;\n\tpriv->rx_coalesce_usecs_irq = 0;\n\tpriv->tx_coalesce_usecs_irq = 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}