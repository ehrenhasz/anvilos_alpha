{
  "module_name": "tcan4x5x-regmap.c",
  "hash_id": "27ef00350ffcc2d2bc6eeed873c9c4f435519ae8aab54b6bff5eddc62aa61d6b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/can/m_can/tcan4x5x-regmap.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n#include \"tcan4x5x.h\"\n\n#define TCAN4X5X_SPI_INSTRUCTION_WRITE (0x61 << 24)\n#define TCAN4X5X_SPI_INSTRUCTION_READ (0x41 << 24)\n\n#define TCAN4X5X_MAX_REGISTER 0x87fc\n\nstatic int tcan4x5x_regmap_gather_write(void *context,\n\t\t\t\t\tconst void *reg, size_t reg_len,\n\t\t\t\t\tconst void *val, size_t val_len)\n{\n\tstruct spi_device *spi = context;\n\tstruct tcan4x5x_priv *priv = spi_get_drvdata(spi);\n\tstruct tcan4x5x_map_buf *buf_tx = &priv->map_buf_tx;\n\tstruct spi_transfer xfer[] = {\n\t\t{\n\t\t\t.tx_buf = buf_tx,\n\t\t\t.len = sizeof(buf_tx->cmd) + val_len,\n\t\t},\n\t};\n\n\tmemcpy(&buf_tx->cmd, reg, sizeof(buf_tx->cmd.cmd) +\n\t       sizeof(buf_tx->cmd.addr));\n\ttcan4x5x_spi_cmd_set_len(&buf_tx->cmd, val_len);\n\tmemcpy(buf_tx->data, val, val_len);\n\n\treturn spi_sync_transfer(spi, xfer, ARRAY_SIZE(xfer));\n}\n\nstatic int tcan4x5x_regmap_write(void *context, const void *data, size_t count)\n{\n\treturn tcan4x5x_regmap_gather_write(context, data, sizeof(__be32),\n\t\t\t\t\t    data + sizeof(__be32),\n\t\t\t\t\t    count - sizeof(__be32));\n}\n\nstatic int tcan4x5x_regmap_read(void *context,\n\t\t\t\tconst void *reg_buf, size_t reg_len,\n\t\t\t\tvoid *val_buf, size_t val_len)\n{\n\tstruct spi_device *spi = context;\n\tstruct tcan4x5x_priv *priv = spi_get_drvdata(spi);\n\tstruct tcan4x5x_map_buf *buf_rx = &priv->map_buf_rx;\n\tstruct tcan4x5x_map_buf *buf_tx = &priv->map_buf_tx;\n\tstruct spi_transfer xfer[2] = {\n\t\t{\n\t\t\t.tx_buf = buf_tx,\n\t\t}\n\t};\n\tstruct spi_message msg;\n\tint err;\n\n\tspi_message_init(&msg);\n\tspi_message_add_tail(&xfer[0], &msg);\n\n\tmemcpy(&buf_tx->cmd, reg_buf, sizeof(buf_tx->cmd.cmd) +\n\t       sizeof(buf_tx->cmd.addr));\n\ttcan4x5x_spi_cmd_set_len(&buf_tx->cmd, val_len);\n\n\tif (spi->controller->flags & SPI_CONTROLLER_HALF_DUPLEX) {\n\t\txfer[0].len = sizeof(buf_tx->cmd);\n\n\t\txfer[1].rx_buf = val_buf;\n\t\txfer[1].len = val_len;\n\t\tspi_message_add_tail(&xfer[1], &msg);\n\t} else {\n\t\txfer[0].rx_buf = buf_rx;\n\t\txfer[0].len = sizeof(buf_tx->cmd) + val_len;\n\n\t\tif (TCAN4X5X_SANITIZE_SPI)\n\t\t\tmemset(buf_tx->data, 0x0, val_len);\n\t}\n\n\terr = spi_sync(spi, &msg);\n\tif (err)\n\t\treturn err;\n\n\tif (!(spi->controller->flags & SPI_CONTROLLER_HALF_DUPLEX))\n\t\tmemcpy(val_buf, buf_rx->data, val_len);\n\n\treturn 0;\n}\n\nstatic const struct regmap_range tcan4x5x_reg_table_wr_range[] = {\n\t \n\tregmap_reg_range(0x000c, 0x0010),\n\t \n\tregmap_reg_range(0x0800, 0x080c),\n\tregmap_reg_range(0x0820, 0x0820),\n\tregmap_reg_range(0x0830, 0x0830),\n\t \n\tregmap_reg_range(0x100c, 0x102c),\n\tregmap_reg_range(0x1048, 0x1048),\n\tregmap_reg_range(0x1050, 0x105c),\n\tregmap_reg_range(0x1080, 0x1088),\n\tregmap_reg_range(0x1090, 0x1090),\n\tregmap_reg_range(0x1098, 0x10a0),\n\tregmap_reg_range(0x10a8, 0x10b0),\n\tregmap_reg_range(0x10b8, 0x10c0),\n\tregmap_reg_range(0x10c8, 0x10c8),\n\tregmap_reg_range(0x10d0, 0x10d4),\n\tregmap_reg_range(0x10e0, 0x10e4),\n\tregmap_reg_range(0x10f0, 0x10f0),\n\tregmap_reg_range(0x10f8, 0x10f8),\n\t \n\tregmap_reg_range(0x8000, 0x87fc),\n};\n\nstatic const struct regmap_range tcan4x5x_reg_table_rd_range[] = {\n\tregmap_reg_range(0x0000, 0x0010),\t \n\tregmap_reg_range(0x0800, 0x0830),\t \n\tregmap_reg_range(0x1000, 0x10fc),\t \n\tregmap_reg_range(0x8000, 0x87fc),\t \n};\n\nstatic const struct regmap_access_table tcan4x5x_reg_table_wr = {\n\t.yes_ranges = tcan4x5x_reg_table_wr_range,\n\t.n_yes_ranges = ARRAY_SIZE(tcan4x5x_reg_table_wr_range),\n};\n\nstatic const struct regmap_access_table tcan4x5x_reg_table_rd = {\n\t.yes_ranges = tcan4x5x_reg_table_rd_range,\n\t.n_yes_ranges = ARRAY_SIZE(tcan4x5x_reg_table_rd_range),\n};\n\nstatic const struct regmap_config tcan4x5x_regmap = {\n\t.reg_bits = 24,\n\t.reg_stride = 4,\n\t.pad_bits = 8,\n\t.val_bits = 32,\n\t.wr_table = &tcan4x5x_reg_table_wr,\n\t.rd_table = &tcan4x5x_reg_table_rd,\n\t.max_register = TCAN4X5X_MAX_REGISTER,\n\t.cache_type = REGCACHE_NONE,\n\t.read_flag_mask = (__force unsigned long)\n\t\tcpu_to_be32(TCAN4X5X_SPI_INSTRUCTION_READ),\n\t.write_flag_mask = (__force unsigned long)\n\t\tcpu_to_be32(TCAN4X5X_SPI_INSTRUCTION_WRITE),\n};\n\nstatic const struct regmap_bus tcan4x5x_bus = {\n\t.write = tcan4x5x_regmap_write,\n\t.gather_write = tcan4x5x_regmap_gather_write,\n\t.read = tcan4x5x_regmap_read,\n\t.reg_format_endian_default = REGMAP_ENDIAN_BIG,\n\t.val_format_endian_default = REGMAP_ENDIAN_BIG,\n\t.max_raw_read = 256,\n\t.max_raw_write = 256,\n};\n\nint tcan4x5x_regmap_init(struct tcan4x5x_priv *priv)\n{\n\tpriv->regmap = devm_regmap_init(&priv->spi->dev, &tcan4x5x_bus,\n\t\t\t\t\tpriv->spi, &tcan4x5x_regmap);\n\treturn PTR_ERR_OR_ZERO(priv->regmap);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}