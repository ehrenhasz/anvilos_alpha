{
  "module_name": "softing_cs.c",
  "hash_id": "dfc125bb53d0f7ab621bb51f2af3d4d9110c2a21e4835382aab62de94817c592",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/can/softing/softing_cs.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n\n#include <pcmcia/cistpl.h>\n#include <pcmcia/ds.h>\n\n#include \"softing_platform.h\"\n\nstatic int softingcs_index;\nstatic DEFINE_SPINLOCK(softingcs_index_lock);\n\nstatic int softingcs_reset(struct platform_device *pdev, int v);\nstatic int softingcs_enable_irq(struct platform_device *pdev, int v);\n\n \n#define MHZ (1000*1000)\nstatic const struct softing_platform_data softingcs_platform_data[] = {\n{\n\t.name = \"CANcard\",\n\t.manf = 0x0168, .prod = 0x001,\n\t.generation = 1,\n\t.nbus = 2,\n\t.freq = 16 * MHZ, .max_brp = 32, .max_sjw = 4,\n\t.dpram_size = 0x0800,\n\t.boot = {0x0000, 0x000000, fw_dir \"bcard.bin\",},\n\t.load = {0x0120, 0x00f600, fw_dir \"ldcard.bin\",},\n\t.app = {0x0010, 0x0d0000, fw_dir \"cancard.bin\",},\n\t.reset = softingcs_reset,\n\t.enable_irq = softingcs_enable_irq,\n}, {\n\t.name = \"CANcard-NEC\",\n\t.manf = 0x0168, .prod = 0x002,\n\t.generation = 1,\n\t.nbus = 2,\n\t.freq = 16 * MHZ, .max_brp = 32, .max_sjw = 4,\n\t.dpram_size = 0x0800,\n\t.boot = {0x0000, 0x000000, fw_dir \"bcard.bin\",},\n\t.load = {0x0120, 0x00f600, fw_dir \"ldcard.bin\",},\n\t.app = {0x0010, 0x0d0000, fw_dir \"cancard.bin\",},\n\t.reset = softingcs_reset,\n\t.enable_irq = softingcs_enable_irq,\n}, {\n\t.name = \"CANcard-SJA\",\n\t.manf = 0x0168, .prod = 0x004,\n\t.generation = 1,\n\t.nbus = 2,\n\t.freq = 20 * MHZ, .max_brp = 32, .max_sjw = 4,\n\t.dpram_size = 0x0800,\n\t.boot = {0x0000, 0x000000, fw_dir \"bcard.bin\",},\n\t.load = {0x0120, 0x00f600, fw_dir \"ldcard.bin\",},\n\t.app = {0x0010, 0x0d0000, fw_dir \"cansja.bin\",},\n\t.reset = softingcs_reset,\n\t.enable_irq = softingcs_enable_irq,\n}, {\n\t.name = \"CANcard-2\",\n\t.manf = 0x0168, .prod = 0x005,\n\t.generation = 2,\n\t.nbus = 2,\n\t.freq = 24 * MHZ, .max_brp = 64, .max_sjw = 4,\n\t.dpram_size = 0x1000,\n\t.boot = {0x0000, 0x000000, fw_dir \"bcard2.bin\",},\n\t.load = {0x0120, 0x00f600, fw_dir \"ldcard2.bin\",},\n\t.app = {0x0010, 0x0d0000, fw_dir \"cancrd2.bin\",},\n\t.reset = softingcs_reset,\n\t.enable_irq = NULL,\n}, {\n\t.name = \"Vector-CANcard\",\n\t.manf = 0x0168, .prod = 0x081,\n\t.generation = 1,\n\t.nbus = 2,\n\t.freq = 16 * MHZ, .max_brp = 64, .max_sjw = 4,\n\t.dpram_size = 0x0800,\n\t.boot = {0x0000, 0x000000, fw_dir \"bcard.bin\",},\n\t.load = {0x0120, 0x00f600, fw_dir \"ldcard.bin\",},\n\t.app = {0x0010, 0x0d0000, fw_dir \"cancard.bin\",},\n\t.reset = softingcs_reset,\n\t.enable_irq = softingcs_enable_irq,\n}, {\n\t.name = \"Vector-CANcard-SJA\",\n\t.manf = 0x0168, .prod = 0x084,\n\t.generation = 1,\n\t.nbus = 2,\n\t.freq = 20 * MHZ, .max_brp = 32, .max_sjw = 4,\n\t.dpram_size = 0x0800,\n\t.boot = {0x0000, 0x000000, fw_dir \"bcard.bin\",},\n\t.load = {0x0120, 0x00f600, fw_dir \"ldcard.bin\",},\n\t.app = {0x0010, 0x0d0000, fw_dir \"cansja.bin\",},\n\t.reset = softingcs_reset,\n\t.enable_irq = softingcs_enable_irq,\n}, {\n\t.name = \"Vector-CANcard-2\",\n\t.manf = 0x0168, .prod = 0x085,\n\t.generation = 2,\n\t.nbus = 2,\n\t.freq = 24 * MHZ, .max_brp = 64, .max_sjw = 4,\n\t.dpram_size = 0x1000,\n\t.boot = {0x0000, 0x000000, fw_dir \"bcard2.bin\",},\n\t.load = {0x0120, 0x00f600, fw_dir \"ldcard2.bin\",},\n\t.app = {0x0010, 0x0d0000, fw_dir \"cancrd2.bin\",},\n\t.reset = softingcs_reset,\n\t.enable_irq = NULL,\n}, {\n\t.name = \"EDICcard-NEC\",\n\t.manf = 0x0168, .prod = 0x102,\n\t.generation = 1,\n\t.nbus = 2,\n\t.freq = 16 * MHZ, .max_brp = 64, .max_sjw = 4,\n\t.dpram_size = 0x0800,\n\t.boot = {0x0000, 0x000000, fw_dir \"bcard.bin\",},\n\t.load = {0x0120, 0x00f600, fw_dir \"ldcard.bin\",},\n\t.app = {0x0010, 0x0d0000, fw_dir \"cancard.bin\",},\n\t.reset = softingcs_reset,\n\t.enable_irq = softingcs_enable_irq,\n}, {\n\t.name = \"EDICcard-2\",\n\t.manf = 0x0168, .prod = 0x105,\n\t.generation = 2,\n\t.nbus = 2,\n\t.freq = 24 * MHZ, .max_brp = 64, .max_sjw = 4,\n\t.dpram_size = 0x1000,\n\t.boot = {0x0000, 0x000000, fw_dir \"bcard2.bin\",},\n\t.load = {0x0120, 0x00f600, fw_dir \"ldcard2.bin\",},\n\t.app = {0x0010, 0x0d0000, fw_dir \"cancrd2.bin\",},\n\t.reset = softingcs_reset,\n\t.enable_irq = NULL,\n}, {\n\t0, 0,\n},\n};\n\nMODULE_FIRMWARE(fw_dir \"bcard.bin\");\nMODULE_FIRMWARE(fw_dir \"ldcard.bin\");\nMODULE_FIRMWARE(fw_dir \"cancard.bin\");\nMODULE_FIRMWARE(fw_dir \"cansja.bin\");\n\nMODULE_FIRMWARE(fw_dir \"bcard2.bin\");\nMODULE_FIRMWARE(fw_dir \"ldcard2.bin\");\nMODULE_FIRMWARE(fw_dir \"cancrd2.bin\");\n\nstatic const struct softing_platform_data\n*softingcs_find_platform_data(unsigned int manf, unsigned int prod)\n{\n\tconst struct softing_platform_data *lp;\n\n\tfor (lp = softingcs_platform_data; lp->manf; ++lp) {\n\t\tif ((lp->manf == manf) && (lp->prod == prod))\n\t\t\treturn lp;\n\t}\n\treturn NULL;\n}\n\n \nstatic int softingcs_reset(struct platform_device *pdev, int v)\n{\n\tstruct pcmcia_device *pcmcia = to_pcmcia_dev(pdev->dev.parent);\n\n\tdev_dbg(&pdev->dev, \"pcmcia config [2] %02x\\n\", v ? 0 : 0x20);\n\treturn pcmcia_write_config_byte(pcmcia, 2, v ? 0 : 0x20);\n}\n\nstatic int softingcs_enable_irq(struct platform_device *pdev, int v)\n{\n\tstruct pcmcia_device *pcmcia = to_pcmcia_dev(pdev->dev.parent);\n\n\tdev_dbg(&pdev->dev, \"pcmcia config [0] %02x\\n\", v ? 0x60 : 0);\n\treturn pcmcia_write_config_byte(pcmcia, 0, v ? 0x60 : 0);\n}\n\n \nstatic int softingcs_probe_config(struct pcmcia_device *pcmcia, void *priv_data)\n{\n\tstruct softing_platform_data *pdat = priv_data;\n\tstruct resource *pres;\n\tint memspeed = 0;\n\n\tWARN_ON(!pdat);\n\tpres = pcmcia->resource[PCMCIA_IOMEM_0];\n\tif (resource_size(pres) < 0x1000)\n\t\treturn -ERANGE;\n\n\tpres->flags |= WIN_MEMORY_TYPE_CM | WIN_ENABLE;\n\tif (pdat->generation < 2) {\n\t\tpres->flags |= WIN_USE_WAIT | WIN_DATA_WIDTH_8;\n\t\tmemspeed = 3;\n\t} else {\n\t\tpres->flags |= WIN_DATA_WIDTH_16;\n\t}\n\treturn pcmcia_request_window(pcmcia, pres, memspeed);\n}\n\nstatic void softingcs_remove(struct pcmcia_device *pcmcia)\n{\n\tstruct platform_device *pdev = pcmcia->priv;\n\n\t \n\tplatform_device_unregister(pdev);\n\t \n\tpcmcia_disable_device(pcmcia);\n}\n\n \nstatic void softingcs_pdev_release(struct device *dev)\n{\n\tstruct platform_device *pdev = to_platform_device(dev);\n\tkfree(pdev);\n}\n\nstatic int softingcs_probe(struct pcmcia_device *pcmcia)\n{\n\tint ret;\n\tstruct platform_device *pdev;\n\tconst struct softing_platform_data *pdat;\n\tstruct resource *pres;\n\tstruct dev {\n\t\tstruct platform_device pdev;\n\t\tstruct resource res[2];\n\t} *dev;\n\n\t \n\tpdat = softingcs_find_platform_data(pcmcia->manf_id, pcmcia->card_id);\n\tif (!pdat)\n\t\treturn -ENOTTY;\n\n\t \n\tpcmcia->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_IOMEM |\n\t\tCONF_AUTO_SET_VPP | CONF_AUTO_CHECK_VCC;\n\tret = pcmcia_loop_config(pcmcia, softingcs_probe_config, (void *)pdat);\n\tif (ret)\n\t\tgoto pcmcia_failed;\n\n\tret = pcmcia_enable_device(pcmcia);\n\tif (ret < 0)\n\t\tgoto pcmcia_failed;\n\n\tpres = pcmcia->resource[PCMCIA_IOMEM_0];\n\tif (!pres) {\n\t\tret = -EBADF;\n\t\tgoto pcmcia_bad;\n\t}\n\n\t \n\tdev = kzalloc(sizeof(*dev), GFP_KERNEL);\n\tif (!dev) {\n\t\tret = -ENOMEM;\n\t\tgoto mem_failed;\n\t}\n\tdev->pdev.resource = dev->res;\n\tdev->pdev.num_resources = ARRAY_SIZE(dev->res);\n\tdev->pdev.dev.release = softingcs_pdev_release;\n\n\tpdev = &dev->pdev;\n\tpdev->dev.platform_data = (void *)pdat;\n\tpdev->dev.parent = &pcmcia->dev;\n\tpcmcia->priv = pdev;\n\n\t \n\tpdev->resource[0].flags = IORESOURCE_MEM;\n\tpdev->resource[0].start = pres->start;\n\tpdev->resource[0].end = pres->end;\n\n\tpdev->resource[1].flags = IORESOURCE_IRQ;\n\tpdev->resource[1].start = pcmcia->irq;\n\tpdev->resource[1].end = pdev->resource[1].start;\n\n\t \n\tspin_lock(&softingcs_index_lock);\n\tpdev->id = softingcs_index++;\n\tspin_unlock(&softingcs_index_lock);\n\tpdev->name = \"softing\";\n\tdev_set_name(&pdev->dev, \"softingcs.%i\", pdev->id);\n\tret = platform_device_register(pdev);\n\tif (ret < 0)\n\t\tgoto platform_failed;\n\n\tdev_info(&pcmcia->dev, \"created %s\\n\", dev_name(&pdev->dev));\n\treturn 0;\n\nplatform_failed:\n\tplatform_device_put(pdev);\nmem_failed:\npcmcia_bad:\npcmcia_failed:\n\tpcmcia_disable_device(pcmcia);\n\tpcmcia->priv = NULL;\n\treturn ret;\n}\n\nstatic const struct pcmcia_device_id softingcs_ids[] = {\n\t \n\tPCMCIA_DEVICE_MANF_CARD(0x0168, 0x0001),\n\tPCMCIA_DEVICE_MANF_CARD(0x0168, 0x0002),\n\tPCMCIA_DEVICE_MANF_CARD(0x0168, 0x0004),\n\tPCMCIA_DEVICE_MANF_CARD(0x0168, 0x0005),\n\t \n\tPCMCIA_DEVICE_MANF_CARD(0x0168, 0x0081),\n\tPCMCIA_DEVICE_MANF_CARD(0x0168, 0x0084),\n\tPCMCIA_DEVICE_MANF_CARD(0x0168, 0x0085),\n\t \n\tPCMCIA_DEVICE_MANF_CARD(0x0168, 0x0102),\n\tPCMCIA_DEVICE_MANF_CARD(0x0168, 0x0105),\n\tPCMCIA_DEVICE_NULL,\n};\n\nMODULE_DEVICE_TABLE(pcmcia, softingcs_ids);\n\nstatic struct pcmcia_driver softingcs_driver = {\n\t.owner\t\t= THIS_MODULE,\n\t.name\t\t= \"softingcs\",\n\t.id_table\t= softingcs_ids,\n\t.probe\t\t= softingcs_probe,\n\t.remove\t\t= softingcs_remove,\n};\n\nmodule_pcmcia_driver(softingcs_driver);\n\nMODULE_DESCRIPTION(\"softing CANcard driver\"\n\t\t\", links PCMCIA card to softing driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}