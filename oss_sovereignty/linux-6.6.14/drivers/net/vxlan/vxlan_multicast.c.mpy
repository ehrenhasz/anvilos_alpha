{
  "module_name": "vxlan_multicast.c",
  "hash_id": "18f2442dea7844270876659e6f5cc9e0a2dc88df92dfb30b88102fe53f70974e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/vxlan/vxlan_multicast.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <net/net_namespace.h>\n#include <net/sock.h>\n#include <linux/igmp.h>\n#include <net/vxlan.h>\n\n#include \"vxlan_private.h\"\n\n \nint vxlan_igmp_join(struct vxlan_dev *vxlan, union vxlan_addr *rip,\n\t\t    int rifindex)\n{\n\tunion vxlan_addr *ip = (rip ? : &vxlan->default_dst.remote_ip);\n\tint ifindex = (rifindex ? : vxlan->default_dst.remote_ifindex);\n\tint ret = -EINVAL;\n\tstruct sock *sk;\n\n\tif (ip->sa.sa_family == AF_INET) {\n\t\tstruct vxlan_sock *sock4 = rtnl_dereference(vxlan->vn4_sock);\n\t\tstruct ip_mreqn mreq = {\n\t\t\t.imr_multiaddr.s_addr\t= ip->sin.sin_addr.s_addr,\n\t\t\t.imr_ifindex\t\t= ifindex,\n\t\t};\n\n\t\tsk = sock4->sock->sk;\n\t\tlock_sock(sk);\n\t\tret = ip_mc_join_group(sk, &mreq);\n\t\trelease_sock(sk);\n#if IS_ENABLED(CONFIG_IPV6)\n\t} else {\n\t\tstruct vxlan_sock *sock6 = rtnl_dereference(vxlan->vn6_sock);\n\n\t\tsk = sock6->sock->sk;\n\t\tlock_sock(sk);\n\t\tret = ipv6_stub->ipv6_sock_mc_join(sk, ifindex,\n\t\t\t\t\t\t   &ip->sin6.sin6_addr);\n\t\trelease_sock(sk);\n#endif\n\t}\n\n\treturn ret;\n}\n\nint vxlan_igmp_leave(struct vxlan_dev *vxlan, union vxlan_addr *rip,\n\t\t     int rifindex)\n{\n\tunion vxlan_addr *ip = (rip ? : &vxlan->default_dst.remote_ip);\n\tint ifindex = (rifindex ? : vxlan->default_dst.remote_ifindex);\n\tint ret = -EINVAL;\n\tstruct sock *sk;\n\n\tif (ip->sa.sa_family == AF_INET) {\n\t\tstruct vxlan_sock *sock4 = rtnl_dereference(vxlan->vn4_sock);\n\t\tstruct ip_mreqn mreq = {\n\t\t\t.imr_multiaddr.s_addr\t= ip->sin.sin_addr.s_addr,\n\t\t\t.imr_ifindex\t\t= ifindex,\n\t\t};\n\n\t\tsk = sock4->sock->sk;\n\t\tlock_sock(sk);\n\t\tret = ip_mc_leave_group(sk, &mreq);\n\t\trelease_sock(sk);\n#if IS_ENABLED(CONFIG_IPV6)\n\t} else {\n\t\tstruct vxlan_sock *sock6 = rtnl_dereference(vxlan->vn6_sock);\n\n\t\tsk = sock6->sock->sk;\n\t\tlock_sock(sk);\n\t\tret = ipv6_stub->ipv6_sock_mc_drop(sk, ifindex,\n\t\t\t\t\t\t   &ip->sin6.sin6_addr);\n\t\trelease_sock(sk);\n#endif\n\t}\n\n\treturn ret;\n}\n\nstatic bool vxlan_group_used_match(union vxlan_addr *ip, int ifindex,\n\t\t\t\t   union vxlan_addr *rip, int rifindex)\n{\n\tif (!vxlan_addr_multicast(rip))\n\t\treturn false;\n\n\tif (!vxlan_addr_equal(rip, ip))\n\t\treturn false;\n\n\tif (rifindex != ifindex)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic bool vxlan_group_used_by_vnifilter(struct vxlan_dev *vxlan,\n\t\t\t\t\t  union vxlan_addr *ip, int ifindex)\n{\n\tstruct vxlan_vni_group *vg = rtnl_dereference(vxlan->vnigrp);\n\tstruct vxlan_vni_node *v, *tmp;\n\n\tif (vxlan_group_used_match(ip, ifindex,\n\t\t\t\t   &vxlan->default_dst.remote_ip,\n\t\t\t\t   vxlan->default_dst.remote_ifindex))\n\t\treturn true;\n\n\tlist_for_each_entry_safe(v, tmp, &vg->vni_list, vlist) {\n\t\tif (!vxlan_addr_multicast(&v->remote_ip))\n\t\t\tcontinue;\n\n\t\tif (vxlan_group_used_match(ip, ifindex,\n\t\t\t\t\t   &v->remote_ip,\n\t\t\t\t\t   vxlan->default_dst.remote_ifindex))\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\n \nbool vxlan_group_used(struct vxlan_net *vn, struct vxlan_dev *dev,\n\t\t      __be32 vni, union vxlan_addr *rip, int rifindex)\n{\n\tunion vxlan_addr *ip = (rip ? : &dev->default_dst.remote_ip);\n\tint ifindex = (rifindex ? : dev->default_dst.remote_ifindex);\n\tstruct vxlan_dev *vxlan;\n\tstruct vxlan_sock *sock4;\n#if IS_ENABLED(CONFIG_IPV6)\n\tstruct vxlan_sock *sock6;\n#endif\n\tunsigned short family = dev->default_dst.remote_ip.sa.sa_family;\n\n\tsock4 = rtnl_dereference(dev->vn4_sock);\n\n\t \n\tif (family == AF_INET && sock4 && refcount_read(&sock4->refcnt) == 1)\n\t\treturn false;\n\n#if IS_ENABLED(CONFIG_IPV6)\n\tsock6 = rtnl_dereference(dev->vn6_sock);\n\tif (family == AF_INET6 && sock6 && refcount_read(&sock6->refcnt) == 1)\n\t\treturn false;\n#endif\n\n\tlist_for_each_entry(vxlan, &vn->vxlan_list, next) {\n\t\tif (!netif_running(vxlan->dev) || vxlan == dev)\n\t\t\tcontinue;\n\n\t\tif (family == AF_INET &&\n\t\t    rtnl_dereference(vxlan->vn4_sock) != sock4)\n\t\t\tcontinue;\n#if IS_ENABLED(CONFIG_IPV6)\n\t\tif (family == AF_INET6 &&\n\t\t    rtnl_dereference(vxlan->vn6_sock) != sock6)\n\t\t\tcontinue;\n#endif\n\t\tif (vxlan->cfg.flags & VXLAN_F_VNIFILTER) {\n\t\t\tif (!vxlan_group_used_by_vnifilter(vxlan, ip, ifindex))\n\t\t\t\tcontinue;\n\t\t} else {\n\t\t\tif (!vxlan_group_used_match(ip, ifindex,\n\t\t\t\t\t\t    &vxlan->default_dst.remote_ip,\n\t\t\t\t\t\t    vxlan->default_dst.remote_ifindex))\n\t\t\t\tcontinue;\n\t\t}\n\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic int vxlan_multicast_join_vnigrp(struct vxlan_dev *vxlan)\n{\n\tstruct vxlan_vni_group *vg = rtnl_dereference(vxlan->vnigrp);\n\tstruct vxlan_vni_node *v, *tmp, *vgood = NULL;\n\tint ret = 0;\n\n\tlist_for_each_entry_safe(v, tmp, &vg->vni_list, vlist) {\n\t\tif (!vxlan_addr_multicast(&v->remote_ip))\n\t\t\tcontinue;\n\t\t \n\t\tif (vxlan_addr_equal(&v->remote_ip,\n\t\t\t\t     &vxlan->default_dst.remote_ip))\n\t\t\tcontinue;\n\t\tret = vxlan_igmp_join(vxlan, &v->remote_ip, 0);\n\t\tif (ret == -EADDRINUSE)\n\t\t\tret = 0;\n\t\tif (ret)\n\t\t\tgoto out;\n\t\tvgood = v;\n\t}\nout:\n\tif (ret) {\n\t\tlist_for_each_entry_safe(v, tmp, &vg->vni_list, vlist) {\n\t\t\tif (!vxlan_addr_multicast(&v->remote_ip))\n\t\t\t\tcontinue;\n\t\t\tif (vxlan_addr_equal(&v->remote_ip,\n\t\t\t\t\t     &vxlan->default_dst.remote_ip))\n\t\t\t\tcontinue;\n\t\t\tvxlan_igmp_leave(vxlan, &v->remote_ip, 0);\n\t\t\tif (v == vgood)\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic int vxlan_multicast_leave_vnigrp(struct vxlan_dev *vxlan)\n{\n\tstruct vxlan_net *vn = net_generic(vxlan->net, vxlan_net_id);\n\tstruct vxlan_vni_group *vg = rtnl_dereference(vxlan->vnigrp);\n\tstruct vxlan_vni_node *v, *tmp;\n\tint last_err = 0, ret;\n\n\tlist_for_each_entry_safe(v, tmp, &vg->vni_list, vlist) {\n\t\tif (vxlan_addr_multicast(&v->remote_ip) &&\n\t\t    !vxlan_group_used(vn, vxlan, v->vni, &v->remote_ip,\n\t\t\t\t      0)) {\n\t\t\tret = vxlan_igmp_leave(vxlan, &v->remote_ip, 0);\n\t\t\tif (ret)\n\t\t\t\tlast_err = ret;\n\t\t}\n\t}\n\n\treturn last_err;\n}\n\nint vxlan_multicast_join(struct vxlan_dev *vxlan)\n{\n\tint ret = 0;\n\n\tif (vxlan_addr_multicast(&vxlan->default_dst.remote_ip)) {\n\t\tret = vxlan_igmp_join(vxlan, &vxlan->default_dst.remote_ip,\n\t\t\t\t      vxlan->default_dst.remote_ifindex);\n\t\tif (ret == -EADDRINUSE)\n\t\t\tret = 0;\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (vxlan->cfg.flags & VXLAN_F_VNIFILTER)\n\t\treturn vxlan_multicast_join_vnigrp(vxlan);\n\n\treturn 0;\n}\n\nint vxlan_multicast_leave(struct vxlan_dev *vxlan)\n{\n\tstruct vxlan_net *vn = net_generic(vxlan->net, vxlan_net_id);\n\tint ret = 0;\n\n\tif (vxlan_addr_multicast(&vxlan->default_dst.remote_ip) &&\n\t    !vxlan_group_used(vn, vxlan, 0, NULL, 0)) {\n\t\tret = vxlan_igmp_leave(vxlan, &vxlan->default_dst.remote_ip,\n\t\t\t\t       vxlan->default_dst.remote_ifindex);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (vxlan->cfg.flags & VXLAN_F_VNIFILTER)\n\t\treturn vxlan_multicast_leave_vnigrp(vxlan);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}