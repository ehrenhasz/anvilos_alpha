{
  "module_name": "mdio.c",
  "hash_id": "b3172ad798d1b469aa3cfb33a89a1f9ca6bf8af6cdbadabbbc3b29650e526b4b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/mdio.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/capability.h>\n#include <linux/errno.h>\n#include <linux/ethtool.h>\n#include <linux/mdio.h>\n#include <linux/module.h>\n\nMODULE_DESCRIPTION(\"Generic support for MDIO-compatible transceivers\");\nMODULE_AUTHOR(\"Copyright 2006-2009 Solarflare Communications Inc.\");\nMODULE_LICENSE(\"GPL\");\n\n \nint mdio45_probe(struct mdio_if_info *mdio, int prtad)\n{\n\tint mmd, stat2, devs1, devs2;\n\n\t \n\tfor (mmd = 1; mmd <= 5; mmd++) {\n\t\t \n\t\tstat2 = mdio->mdio_read(mdio->dev, prtad, mmd, MDIO_STAT2);\n\t\tif (stat2 < 0 ||\n\t\t    (stat2 & MDIO_STAT2_DEVPRST) != MDIO_STAT2_DEVPRST_VAL)\n\t\t\tcontinue;\n\n\t\t \n\t\tdevs1 = mdio->mdio_read(mdio->dev, prtad, mmd, MDIO_DEVS1);\n\t\tdevs2 = mdio->mdio_read(mdio->dev, prtad, mmd, MDIO_DEVS2);\n\t\tif (devs1 < 0 || devs2 < 0)\n\t\t\tcontinue;\n\n\t\tmdio->prtad = prtad;\n\t\tmdio->mmds = devs1 | (devs2 << 16);\n\t\treturn 0;\n\t}\n\n\treturn -ENODEV;\n}\nEXPORT_SYMBOL(mdio45_probe);\n\n \nint mdio_set_flag(const struct mdio_if_info *mdio,\n\t\t  int prtad, int devad, u16 addr, int mask,\n\t\t  bool sense)\n{\n\tint old_val = mdio->mdio_read(mdio->dev, prtad, devad, addr);\n\tint new_val;\n\n\tif (old_val < 0)\n\t\treturn old_val;\n\tif (sense)\n\t\tnew_val = old_val | mask;\n\telse\n\t\tnew_val = old_val & ~mask;\n\tif (old_val == new_val)\n\t\treturn 0;\n\treturn mdio->mdio_write(mdio->dev, prtad, devad, addr, new_val);\n}\nEXPORT_SYMBOL(mdio_set_flag);\n\n \nint mdio45_links_ok(const struct mdio_if_info *mdio, u32 mmd_mask)\n{\n\tint devad, reg;\n\n\tif (!mmd_mask) {\n\t\t \n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad,\n\t\t\t\t      MDIO_MMD_PHYXS, MDIO_STAT2);\n\t\treturn reg >= 0 && !(reg & MDIO_STAT2_RXFAULT);\n\t}\n\n\tfor (devad = 0; mmd_mask; devad++) {\n\t\tif (mmd_mask & (1 << devad)) {\n\t\t\tmmd_mask &= ~(1 << devad);\n\n\t\t\t \n\t\t\tmdio->mdio_read(mdio->dev, mdio->prtad,\n\t\t\t\t\tdevad, MDIO_STAT1);\n\t\t\tif (devad == MDIO_MMD_PMAPMD || devad == MDIO_MMD_PCS ||\n\t\t\t    devad == MDIO_MMD_PHYXS || devad == MDIO_MMD_DTEXS)\n\t\t\t\tmdio->mdio_read(mdio->dev, mdio->prtad,\n\t\t\t\t\t\tdevad, MDIO_STAT2);\n\n\t\t\t \n\t\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad,\n\t\t\t\t\t      devad, MDIO_STAT1);\n\t\t\tif (reg < 0 ||\n\t\t\t    (reg & (MDIO_STAT1_FAULT | MDIO_STAT1_LSTATUS)) !=\n\t\t\t    MDIO_STAT1_LSTATUS)\n\t\t\t\treturn false;\n\t\t}\n\t}\n\n\treturn true;\n}\nEXPORT_SYMBOL(mdio45_links_ok);\n\n \nint mdio45_nway_restart(const struct mdio_if_info *mdio)\n{\n\tif (!(mdio->mmds & MDIO_DEVS_AN))\n\t\treturn -EOPNOTSUPP;\n\n\tmdio_set_flag(mdio, mdio->prtad, MDIO_MMD_AN, MDIO_CTRL1,\n\t\t      MDIO_AN_CTRL1_RESTART, true);\n\treturn 0;\n}\nEXPORT_SYMBOL(mdio45_nway_restart);\n\nstatic u32 mdio45_get_an(const struct mdio_if_info *mdio, u16 addr)\n{\n\tu32 result = 0;\n\tint reg;\n\n\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_AN, addr);\n\tif (reg & ADVERTISE_10HALF)\n\t\tresult |= ADVERTISED_10baseT_Half;\n\tif (reg & ADVERTISE_10FULL)\n\t\tresult |= ADVERTISED_10baseT_Full;\n\tif (reg & ADVERTISE_100HALF)\n\t\tresult |= ADVERTISED_100baseT_Half;\n\tif (reg & ADVERTISE_100FULL)\n\t\tresult |= ADVERTISED_100baseT_Full;\n\tif (reg & ADVERTISE_PAUSE_CAP)\n\t\tresult |= ADVERTISED_Pause;\n\tif (reg & ADVERTISE_PAUSE_ASYM)\n\t\tresult |= ADVERTISED_Asym_Pause;\n\treturn result;\n}\n\n \nvoid mdio45_ethtool_gset_npage(const struct mdio_if_info *mdio,\n\t\t\t       struct ethtool_cmd *ecmd,\n\t\t\t       u32 npage_adv, u32 npage_lpa)\n{\n\tint reg;\n\tu32 speed;\n\n\tBUILD_BUG_ON(MDIO_SUPPORTS_C22 != ETH_MDIO_SUPPORTS_C22);\n\tBUILD_BUG_ON(MDIO_SUPPORTS_C45 != ETH_MDIO_SUPPORTS_C45);\n\n\tecmd->transceiver = XCVR_INTERNAL;\n\tecmd->phy_address = mdio->prtad;\n\tecmd->mdio_support =\n\t\tmdio->mode_support & (MDIO_SUPPORTS_C45 | MDIO_SUPPORTS_C22);\n\n\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t      MDIO_CTRL2);\n\tswitch (reg & MDIO_PMA_CTRL2_TYPE) {\n\tcase MDIO_PMA_CTRL2_10GBT:\n\tcase MDIO_PMA_CTRL2_1000BT:\n\tcase MDIO_PMA_CTRL2_100BTX:\n\tcase MDIO_PMA_CTRL2_10BT:\n\t\tecmd->port = PORT_TP;\n\t\tecmd->supported = SUPPORTED_TP;\n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t\t      MDIO_SPEED);\n\t\tif (reg & MDIO_SPEED_10G)\n\t\t\tecmd->supported |= SUPPORTED_10000baseT_Full;\n\t\tif (reg & MDIO_PMA_SPEED_1000)\n\t\t\tecmd->supported |= (SUPPORTED_1000baseT_Full |\n\t\t\t\t\t    SUPPORTED_1000baseT_Half);\n\t\tif (reg & MDIO_PMA_SPEED_100)\n\t\t\tecmd->supported |= (SUPPORTED_100baseT_Full |\n\t\t\t\t\t    SUPPORTED_100baseT_Half);\n\t\tif (reg & MDIO_PMA_SPEED_10)\n\t\t\tecmd->supported |= (SUPPORTED_10baseT_Full |\n\t\t\t\t\t    SUPPORTED_10baseT_Half);\n\t\tecmd->advertising = ADVERTISED_TP;\n\t\tbreak;\n\n\tcase MDIO_PMA_CTRL2_10GBCX4:\n\t\tecmd->port = PORT_OTHER;\n\t\tecmd->supported = 0;\n\t\tecmd->advertising = 0;\n\t\tbreak;\n\n\tcase MDIO_PMA_CTRL2_10GBKX4:\n\tcase MDIO_PMA_CTRL2_10GBKR:\n\tcase MDIO_PMA_CTRL2_1000BKX:\n\t\tecmd->port = PORT_OTHER;\n\t\tecmd->supported = SUPPORTED_Backplane;\n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t\t      MDIO_PMA_EXTABLE);\n\t\tif (reg & MDIO_PMA_EXTABLE_10GBKX4)\n\t\t\tecmd->supported |= SUPPORTED_10000baseKX4_Full;\n\t\tif (reg & MDIO_PMA_EXTABLE_10GBKR)\n\t\t\tecmd->supported |= SUPPORTED_10000baseKR_Full;\n\t\tif (reg & MDIO_PMA_EXTABLE_1000BKX)\n\t\t\tecmd->supported |= SUPPORTED_1000baseKX_Full;\n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t\t      MDIO_PMA_10GBR_FECABLE);\n\t\tif (reg & MDIO_PMA_10GBR_FECABLE_ABLE)\n\t\t\tecmd->supported |= SUPPORTED_10000baseR_FEC;\n\t\tecmd->advertising = ADVERTISED_Backplane;\n\t\tbreak;\n\n\t \n\tdefault:\n\t\tecmd->port = PORT_FIBRE;\n\t\tecmd->supported = SUPPORTED_FIBRE;\n\t\tecmd->advertising = ADVERTISED_FIBRE;\n\t\tbreak;\n\t}\n\n\tif (mdio->mmds & MDIO_DEVS_AN) {\n\t\tecmd->supported |= SUPPORTED_Autoneg;\n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_AN,\n\t\t\t\t      MDIO_CTRL1);\n\t\tif (reg & MDIO_AN_CTRL1_ENABLE) {\n\t\t\tecmd->autoneg = AUTONEG_ENABLE;\n\t\t\tecmd->advertising |=\n\t\t\t\tADVERTISED_Autoneg |\n\t\t\t\tmdio45_get_an(mdio, MDIO_AN_ADVERTISE) |\n\t\t\t\tnpage_adv;\n\t\t} else {\n\t\t\tecmd->autoneg = AUTONEG_DISABLE;\n\t\t}\n\t} else {\n\t\tecmd->autoneg = AUTONEG_DISABLE;\n\t}\n\n\tif (ecmd->autoneg) {\n\t\tu32 modes = 0;\n\t\tint an_stat = mdio->mdio_read(mdio->dev, mdio->prtad,\n\t\t\t\t\t      MDIO_MMD_AN, MDIO_STAT1);\n\n\t\t \n\t\tif (an_stat & MDIO_AN_STAT1_COMPLETE) {\n\t\t\tecmd->lp_advertising =\n\t\t\t\tmdio45_get_an(mdio, MDIO_AN_LPA) | npage_lpa;\n\t\t\tif (an_stat & MDIO_AN_STAT1_LPABLE)\n\t\t\t\tecmd->lp_advertising |= ADVERTISED_Autoneg;\n\t\t\tmodes = ecmd->advertising & ecmd->lp_advertising;\n\t\t}\n\t\tif ((modes & ~ADVERTISED_Autoneg) == 0)\n\t\t\tmodes = ecmd->advertising;\n\n\t\tif (modes & (ADVERTISED_10000baseT_Full |\n\t\t\t     ADVERTISED_10000baseKX4_Full |\n\t\t\t     ADVERTISED_10000baseKR_Full)) {\n\t\t\tspeed = SPEED_10000;\n\t\t\tecmd->duplex = DUPLEX_FULL;\n\t\t} else if (modes & (ADVERTISED_1000baseT_Full |\n\t\t\t\t    ADVERTISED_1000baseT_Half |\n\t\t\t\t    ADVERTISED_1000baseKX_Full)) {\n\t\t\tspeed = SPEED_1000;\n\t\t\tecmd->duplex = !(modes & ADVERTISED_1000baseT_Half);\n\t\t} else if (modes & (ADVERTISED_100baseT_Full |\n\t\t\t\t    ADVERTISED_100baseT_Half)) {\n\t\t\tspeed = SPEED_100;\n\t\t\tecmd->duplex = !!(modes & ADVERTISED_100baseT_Full);\n\t\t} else {\n\t\t\tspeed = SPEED_10;\n\t\t\tecmd->duplex = !!(modes & ADVERTISED_10baseT_Full);\n\t\t}\n\t} else {\n\t\t \n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t\t      MDIO_CTRL1);\n\t\tspeed = (((reg & MDIO_PMA_CTRL1_SPEED1000) ? 100 : 1)\n\t\t\t * ((reg & MDIO_PMA_CTRL1_SPEED100) ? 100 : 10));\n\t\tecmd->duplex = (reg & MDIO_CTRL1_FULLDPLX ||\n\t\t\t\tspeed == SPEED_10000);\n\t}\n\n\tethtool_cmd_speed_set(ecmd, speed);\n\n\t \n\tif (ecmd->port == PORT_TP\n\t    && (ethtool_cmd_speed(ecmd) == SPEED_10000)) {\n\t\tswitch (mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t\t\tMDIO_PMA_10GBT_SWAPPOL)) {\n\t\tcase MDIO_PMA_10GBT_SWAPPOL_ABNX | MDIO_PMA_10GBT_SWAPPOL_CDNX:\n\t\t\tecmd->eth_tp_mdix = ETH_TP_MDI;\n\t\t\tbreak;\n\t\tcase 0:\n\t\t\tecmd->eth_tp_mdix = ETH_TP_MDI_X;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\tecmd->eth_tp_mdix = ETH_TP_MDI_INVALID;\n\t\t\tbreak;\n\t\t}\n\t}\n}\nEXPORT_SYMBOL(mdio45_ethtool_gset_npage);\n\n \nvoid mdio45_ethtool_ksettings_get_npage(const struct mdio_if_info *mdio,\n\t\t\t\t\tstruct ethtool_link_ksettings *cmd,\n\t\t\t\t\tu32 npage_adv, u32 npage_lpa)\n{\n\tint reg;\n\tu32 speed, supported = 0, advertising = 0, lp_advertising = 0;\n\n\tBUILD_BUG_ON(MDIO_SUPPORTS_C22 != ETH_MDIO_SUPPORTS_C22);\n\tBUILD_BUG_ON(MDIO_SUPPORTS_C45 != ETH_MDIO_SUPPORTS_C45);\n\n\tcmd->base.phy_address = mdio->prtad;\n\tcmd->base.mdio_support =\n\t\tmdio->mode_support & (MDIO_SUPPORTS_C45 | MDIO_SUPPORTS_C22);\n\n\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t      MDIO_CTRL2);\n\tswitch (reg & MDIO_PMA_CTRL2_TYPE) {\n\tcase MDIO_PMA_CTRL2_10GBT:\n\tcase MDIO_PMA_CTRL2_1000BT:\n\tcase MDIO_PMA_CTRL2_100BTX:\n\tcase MDIO_PMA_CTRL2_10BT:\n\t\tcmd->base.port = PORT_TP;\n\t\tsupported = SUPPORTED_TP;\n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t\t      MDIO_SPEED);\n\t\tif (reg & MDIO_SPEED_10G)\n\t\t\tsupported |= SUPPORTED_10000baseT_Full;\n\t\tif (reg & MDIO_PMA_SPEED_1000)\n\t\t\tsupported |= (SUPPORTED_1000baseT_Full |\n\t\t\t\t\t    SUPPORTED_1000baseT_Half);\n\t\tif (reg & MDIO_PMA_SPEED_100)\n\t\t\tsupported |= (SUPPORTED_100baseT_Full |\n\t\t\t\t\t    SUPPORTED_100baseT_Half);\n\t\tif (reg & MDIO_PMA_SPEED_10)\n\t\t\tsupported |= (SUPPORTED_10baseT_Full |\n\t\t\t\t\t    SUPPORTED_10baseT_Half);\n\t\tadvertising = ADVERTISED_TP;\n\t\tbreak;\n\n\tcase MDIO_PMA_CTRL2_10GBCX4:\n\t\tcmd->base.port = PORT_OTHER;\n\t\tsupported = 0;\n\t\tadvertising = 0;\n\t\tbreak;\n\n\tcase MDIO_PMA_CTRL2_10GBKX4:\n\tcase MDIO_PMA_CTRL2_10GBKR:\n\tcase MDIO_PMA_CTRL2_1000BKX:\n\t\tcmd->base.port = PORT_OTHER;\n\t\tsupported = SUPPORTED_Backplane;\n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t\t      MDIO_PMA_EXTABLE);\n\t\tif (reg & MDIO_PMA_EXTABLE_10GBKX4)\n\t\t\tsupported |= SUPPORTED_10000baseKX4_Full;\n\t\tif (reg & MDIO_PMA_EXTABLE_10GBKR)\n\t\t\tsupported |= SUPPORTED_10000baseKR_Full;\n\t\tif (reg & MDIO_PMA_EXTABLE_1000BKX)\n\t\t\tsupported |= SUPPORTED_1000baseKX_Full;\n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t\t      MDIO_PMA_10GBR_FECABLE);\n\t\tif (reg & MDIO_PMA_10GBR_FECABLE_ABLE)\n\t\t\tsupported |= SUPPORTED_10000baseR_FEC;\n\t\tadvertising = ADVERTISED_Backplane;\n\t\tbreak;\n\n\t \n\tdefault:\n\t\tcmd->base.port = PORT_FIBRE;\n\t\tsupported = SUPPORTED_FIBRE;\n\t\tadvertising = ADVERTISED_FIBRE;\n\t\tbreak;\n\t}\n\n\tif (mdio->mmds & MDIO_DEVS_AN) {\n\t\tsupported |= SUPPORTED_Autoneg;\n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_AN,\n\t\t\t\t      MDIO_CTRL1);\n\t\tif (reg & MDIO_AN_CTRL1_ENABLE) {\n\t\t\tcmd->base.autoneg = AUTONEG_ENABLE;\n\t\t\tadvertising |=\n\t\t\t\tADVERTISED_Autoneg |\n\t\t\t\tmdio45_get_an(mdio, MDIO_AN_ADVERTISE) |\n\t\t\t\tnpage_adv;\n\t\t} else {\n\t\t\tcmd->base.autoneg = AUTONEG_DISABLE;\n\t\t}\n\t} else {\n\t\tcmd->base.autoneg = AUTONEG_DISABLE;\n\t}\n\n\tif (cmd->base.autoneg) {\n\t\tu32 modes = 0;\n\t\tint an_stat = mdio->mdio_read(mdio->dev, mdio->prtad,\n\t\t\t\t\t      MDIO_MMD_AN, MDIO_STAT1);\n\n\t\t \n\t\tif (an_stat & MDIO_AN_STAT1_COMPLETE) {\n\t\t\tlp_advertising =\n\t\t\t\tmdio45_get_an(mdio, MDIO_AN_LPA) | npage_lpa;\n\t\t\tif (an_stat & MDIO_AN_STAT1_LPABLE)\n\t\t\t\tlp_advertising |= ADVERTISED_Autoneg;\n\t\t\tmodes = advertising & lp_advertising;\n\t\t}\n\t\tif ((modes & ~ADVERTISED_Autoneg) == 0)\n\t\t\tmodes = advertising;\n\n\t\tif (modes & (ADVERTISED_10000baseT_Full |\n\t\t\t     ADVERTISED_10000baseKX4_Full |\n\t\t\t     ADVERTISED_10000baseKR_Full)) {\n\t\t\tspeed = SPEED_10000;\n\t\t\tcmd->base.duplex = DUPLEX_FULL;\n\t\t} else if (modes & (ADVERTISED_1000baseT_Full |\n\t\t\t\t    ADVERTISED_1000baseT_Half |\n\t\t\t\t    ADVERTISED_1000baseKX_Full)) {\n\t\t\tspeed = SPEED_1000;\n\t\t\tcmd->base.duplex = !(modes & ADVERTISED_1000baseT_Half);\n\t\t} else if (modes & (ADVERTISED_100baseT_Full |\n\t\t\t\t    ADVERTISED_100baseT_Half)) {\n\t\t\tspeed = SPEED_100;\n\t\t\tcmd->base.duplex = !!(modes & ADVERTISED_100baseT_Full);\n\t\t} else {\n\t\t\tspeed = SPEED_10;\n\t\t\tcmd->base.duplex = !!(modes & ADVERTISED_10baseT_Full);\n\t\t}\n\t} else {\n\t\t \n\t\treg = mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t\t      MDIO_CTRL1);\n\t\tspeed = (((reg & MDIO_PMA_CTRL1_SPEED1000) ? 100 : 1)\n\t\t\t * ((reg & MDIO_PMA_CTRL1_SPEED100) ? 100 : 10));\n\t\tcmd->base.duplex = (reg & MDIO_CTRL1_FULLDPLX ||\n\t\t\t\t    speed == SPEED_10000);\n\t}\n\n\tcmd->base.speed = speed;\n\n\tethtool_convert_legacy_u32_to_link_mode(cmd->link_modes.supported,\n\t\t\t\t\t\tsupported);\n\tethtool_convert_legacy_u32_to_link_mode(cmd->link_modes.advertising,\n\t\t\t\t\t\tadvertising);\n\tethtool_convert_legacy_u32_to_link_mode(cmd->link_modes.lp_advertising,\n\t\t\t\t\t\tlp_advertising);\n\n\t \n\tif (cmd->base.port == PORT_TP && (cmd->base.speed == SPEED_10000)) {\n\t\tswitch (mdio->mdio_read(mdio->dev, mdio->prtad, MDIO_MMD_PMAPMD,\n\t\t\t\t\tMDIO_PMA_10GBT_SWAPPOL)) {\n\t\tcase MDIO_PMA_10GBT_SWAPPOL_ABNX | MDIO_PMA_10GBT_SWAPPOL_CDNX:\n\t\t\tcmd->base.eth_tp_mdix = ETH_TP_MDI;\n\t\t\tbreak;\n\t\tcase 0:\n\t\t\tcmd->base.eth_tp_mdix = ETH_TP_MDI_X;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\tcmd->base.eth_tp_mdix = ETH_TP_MDI_INVALID;\n\t\t\tbreak;\n\t\t}\n\t}\n}\nEXPORT_SYMBOL(mdio45_ethtool_ksettings_get_npage);\n\n \nint mdio_mii_ioctl(const struct mdio_if_info *mdio,\n\t\t   struct mii_ioctl_data *mii_data, int cmd)\n{\n\tint prtad, devad;\n\tu16 addr = mii_data->reg_num;\n\n\t \n\tswitch (cmd) {\n\tcase SIOCGMIIPHY:\n\t\tif (mdio->prtad == MDIO_PRTAD_NONE)\n\t\t\treturn -EOPNOTSUPP;\n\t\tmii_data->phy_id = mdio->prtad;\n\t\tcmd = SIOCGMIIREG;\n\t\tbreak;\n\tcase SIOCGMIIREG:\n\tcase SIOCSMIIREG:\n\t\tbreak;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\t \n\tif ((mdio->mode_support & MDIO_SUPPORTS_C45) &&\n\t    mdio_phy_id_is_c45(mii_data->phy_id)) {\n\t\tprtad = mdio_phy_id_prtad(mii_data->phy_id);\n\t\tdevad = mdio_phy_id_devad(mii_data->phy_id);\n\t} else if ((mdio->mode_support & MDIO_SUPPORTS_C22) &&\n\t\t   mii_data->phy_id < 0x20) {\n\t\tprtad = mii_data->phy_id;\n\t\tdevad = MDIO_DEVAD_NONE;\n\t\taddr &= 0x1f;\n\t} else if ((mdio->mode_support & MDIO_EMULATE_C22) &&\n\t\t   mdio->prtad != MDIO_PRTAD_NONE &&\n\t\t   mii_data->phy_id == mdio->prtad) {\n\t\t \n\t\tprtad = mdio->prtad;\n\t\tswitch (addr) {\n\t\tcase MII_BMCR:\n\t\tcase MII_BMSR:\n\t\tcase MII_PHYSID1:\n\t\tcase MII_PHYSID2:\n\t\t\tdevad = __ffs(mdio->mmds);\n\t\t\tbreak;\n\t\tcase MII_ADVERTISE:\n\t\tcase MII_LPA:\n\t\t\tif (!(mdio->mmds & MDIO_DEVS_AN))\n\t\t\t\treturn -EINVAL;\n\t\t\tdevad = MDIO_MMD_AN;\n\t\t\tif (addr == MII_ADVERTISE)\n\t\t\t\taddr = MDIO_AN_ADVERTISE;\n\t\t\telse\n\t\t\t\taddr = MDIO_AN_LPA;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\tif (cmd == SIOCGMIIREG) {\n\t\tint rc = mdio->mdio_read(mdio->dev, prtad, devad, addr);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t\tmii_data->val_out = rc;\n\t\treturn 0;\n\t} else {\n\t\treturn mdio->mdio_write(mdio->dev, prtad, devad, addr,\n\t\t\t\t\tmii_data->val_in);\n\t}\n}\nEXPORT_SYMBOL(mdio_mii_ioctl);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}