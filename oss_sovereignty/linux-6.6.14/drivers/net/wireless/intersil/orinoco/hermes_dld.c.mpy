{
  "module_name": "hermes_dld.c",
  "hash_id": "255ea2ea4ae06b3b90a6a88176fc22a38e0d4edb9c666406558cadd12f809014",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/intersil/orinoco/hermes_dld.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include \"hermes.h\"\n#include \"hermes_dld.h\"\n\n#define PFX \"hermes_dld: \"\n\n \n#define PDI_END\t\t0x00000000\t \n#define BLOCK_END\t0xFFFFFFFF\t \n#define TEXT_END\t0x1A\t\t \n\n \n\n \nstruct dblock {\n\t__le32 addr;\t\t \n\t__le16 len;\t\t \n\tchar data[];\t\t \n} __packed;\n\n \nstruct pdr {\n\t__le32 id;\t\t \n\t__le32 addr;\t\t \n\t__le32 len;\t\t \n\tchar next[];\t\t \n} __packed;\n\n \nstruct pdi {\n\t__le16 len;\t\t \n\t__le16 id;\t\t \n\tchar data[];\t\t \n} __packed;\n\n \n\nstatic inline u32\ndblock_addr(const struct dblock *blk)\n{\n\treturn le32_to_cpu(blk->addr);\n}\n\nstatic inline u32\ndblock_len(const struct dblock *blk)\n{\n\treturn le16_to_cpu(blk->len);\n}\n\n \n\nstatic inline u32\npdr_id(const struct pdr *pdr)\n{\n\treturn le32_to_cpu(pdr->id);\n}\n\nstatic inline u32\npdr_addr(const struct pdr *pdr)\n{\n\treturn le32_to_cpu(pdr->addr);\n}\n\nstatic inline u32\npdr_len(const struct pdr *pdr)\n{\n\treturn le32_to_cpu(pdr->len);\n}\n\n \n\nstatic inline u32\npdi_id(const struct pdi *pdi)\n{\n\treturn le16_to_cpu(pdi->id);\n}\n\n \nstatic inline u32\npdi_len(const struct pdi *pdi)\n{\n\treturn 2 * (le16_to_cpu(pdi->len) - 1);\n}\n\n \n\n \nstatic const struct pdr *\nhermes_find_pdr(const struct pdr *first_pdr, u32 record_id, const void *end)\n{\n\tconst struct pdr *pdr = first_pdr;\n\n\tend -= sizeof(struct pdr);\n\n\twhile (((void *) pdr <= end) &&\n\t       (pdr_id(pdr) != PDI_END)) {\n\t\t \n\t\tif (pdr_len(pdr) < 2)\n\t\t\treturn NULL;\n\n\t\t \n\t\tif (pdr_id(pdr) == record_id)\n\t\t\treturn pdr;\n\n\t\tpdr = (struct pdr *) pdr->next;\n\t}\n\treturn NULL;\n}\n\n \nstatic const struct pdi *\nhermes_find_pdi(const struct pdi *first_pdi, u32 record_id, const void *end)\n{\n\tconst struct pdi *pdi = first_pdi;\n\n\tend -= sizeof(struct pdi);\n\n\twhile (((void *) pdi <= end) &&\n\t       (pdi_id(pdi) != PDI_END)) {\n\n\t\t \n\t\tif (pdi_id(pdi) == record_id)\n\t\t\treturn pdi;\n\n\t\tpdi = (struct pdi *) &pdi->data[pdi_len(pdi)];\n\t}\n\treturn NULL;\n}\n\n \nstatic int\nhermes_plug_pdi(struct hermes *hw, const struct pdr *first_pdr,\n\t\tconst struct pdi *pdi, const void *pdr_end)\n{\n\tconst struct pdr *pdr;\n\n\t \n\tpdr = hermes_find_pdr(first_pdr, pdi_id(pdi), pdr_end);\n\n\t \n\tif (!pdr)\n\t\treturn 0;\n\n\t \n\tif (pdi_len(pdi) != pdr_len(pdr))\n\t\treturn -EINVAL;\n\n\t \n\thw->ops->program(hw, pdi->data, pdr_addr(pdr), pdi_len(pdi));\n\n\treturn 0;\n}\n\n \nint hermes_apply_pda(struct hermes *hw,\n\t\t     const char *first_pdr,\n\t\t     const void *pdr_end,\n\t\t     const __le16 *pda,\n\t\t     const void *pda_end)\n{\n\tint ret;\n\tconst struct pdi *pdi;\n\tconst struct pdr *pdr;\n\n\tpdr = (const struct pdr *) first_pdr;\n\tpda_end -= sizeof(struct pdi);\n\n\t \n\tpdi = (const struct pdi *) (pda + 2);\n\twhile (((void *) pdi <= pda_end) &&\n\t       (pdi_id(pdi) != PDI_END)) {\n\t\tret = hermes_plug_pdi(hw, pdr, pdi, pdr_end);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tpdi = (const struct pdi *) &pdi->data[pdi_len(pdi)];\n\t}\n\treturn 0;\n}\n\n \nsize_t\nhermes_blocks_length(const char *first_block, const void *end)\n{\n\tconst struct dblock *blk = (const struct dblock *) first_block;\n\tint total_len = 0;\n\tint len;\n\n\tend -= sizeof(*blk);\n\n\t \n\twhile (((void *) blk <= end) &&\n\t       (dblock_addr(blk) != BLOCK_END)) {\n\t\tlen = dblock_len(blk);\n\t\ttotal_len += sizeof(*blk) + len;\n\t\tblk = (struct dblock *) &blk->data[len];\n\t}\n\n\treturn total_len;\n}\n\n \n\n \nint hermes_program(struct hermes *hw, const char *first_block, const void *end)\n{\n\tconst struct dblock *blk;\n\tu32 blkaddr;\n\tu32 blklen;\n\tint err = 0;\n\n\tblk = (const struct dblock *) first_block;\n\n\tif ((void *) blk > (end - sizeof(*blk)))\n\t\treturn -EIO;\n\n\tblkaddr = dblock_addr(blk);\n\tblklen = dblock_len(blk);\n\n\twhile ((blkaddr != BLOCK_END) &&\n\t       (((void *) blk + blklen) <= end)) {\n\t\tpr_debug(PFX \"Programming block of length %d \"\n\t\t\t \"to address 0x%08x\\n\", blklen, blkaddr);\n\n\t\terr = hw->ops->program(hw, blk->data, blkaddr, blklen);\n\t\tif (err)\n\t\t\tbreak;\n\n\t\tblk = (const struct dblock *) &blk->data[blklen];\n\n\t\tif ((void *) blk > (end - sizeof(*blk)))\n\t\t\treturn -EIO;\n\n\t\tblkaddr = dblock_addr(blk);\n\t\tblklen = dblock_len(blk);\n\t}\n\treturn err;\n}\n\n \n \n\n#define DEFINE_DEFAULT_PDR(pid, length, data)\t\t\t\t\\\nstatic const struct {\t\t\t\t\t\t\t\\\n\t__le16 len;\t\t\t\t\t\t\t\\\n\t__le16 id;\t\t\t\t\t\t\t\\\n\tu8 val[length];\t\t\t\t\t\t\t\\\n} __packed default_pdr_data_##pid = {\t\t\t\\\n\tcpu_to_le16((sizeof(default_pdr_data_##pid)/\t\t\t\\\n\t\t\t\tsizeof(__le16)) - 1),\t\t\t\\\n\tcpu_to_le16(pid),\t\t\t\t\t\t\\\n\tdata\t\t\t\t\t\t\t\t\\\n}\n\n#define DEFAULT_PDR(pid) default_pdr_data_##pid\n\n \nDEFINE_DEFAULT_PDR(0x0005, 10, \"\\x00\\x00\\x06\\x00\\x01\\x00\\x01\\x00\\x01\\x00\");\n\n \nDEFINE_DEFAULT_PDR(0x0108, 4, \"\\x00\\x00\\x00\\x00\");\n\n \nDEFINE_DEFAULT_PDR(0x0109, 10, \"\\x00\\x00\\x00\\x00\\x03\\x00\\x00\\x00\\x00\\x00\");\n\n \nDEFINE_DEFAULT_PDR(0x0150, 2, \"\\x00\\x3F\");\n\n \nDEFINE_DEFAULT_PDR(0x0160, 28,\n\t\t   \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"\n\t\t   \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"\n\t\t   \"\\x00\\x00\\x00\\x00\\x00\\x00\\x00\\x00\"\n\t\t   \"\\x00\\x00\\x00\\x00\");\n\n \nDEFINE_DEFAULT_PDR(0x0161, 256,\n\t\t   \"\\x3F\\x01\\x3F\\01\\x3F\\x01\\x3F\\x01\"\n\t\t   \"\\x3F\\x01\\x3F\\01\\x3F\\x01\\x3F\\x01\"\n\t\t   \"\\x3F\\x01\\x3F\\01\\x3F\\x01\\x3F\\x01\"\n\t\t   \"\\x3F\\x01\\x3F\\01\\x3F\\x01\\x3F\\x01\"\n\t\t   \"\\x3F\\x01\\x3E\\01\\x3E\\x01\\x3D\\x01\"\n\t\t   \"\\x3D\\x01\\x3C\\01\\x3C\\x01\\x3B\\x01\"\n\t\t   \"\\x3B\\x01\\x3A\\01\\x3A\\x01\\x39\\x01\"\n\t\t   \"\\x39\\x01\\x38\\01\\x38\\x01\\x37\\x01\"\n\t\t   \"\\x37\\x01\\x36\\01\\x36\\x01\\x35\\x01\"\n\t\t   \"\\x35\\x01\\x34\\01\\x34\\x01\\x33\\x01\"\n\t\t   \"\\x33\\x01\\x32\\x01\\x32\\x01\\x31\\x01\"\n\t\t   \"\\x31\\x01\\x30\\x01\\x30\\x01\\x7B\\x01\"\n\t\t   \"\\x7B\\x01\\x7A\\x01\\x7A\\x01\\x79\\x01\"\n\t\t   \"\\x79\\x01\\x78\\x01\\x78\\x01\\x77\\x01\"\n\t\t   \"\\x77\\x01\\x76\\x01\\x76\\x01\\x75\\x01\"\n\t\t   \"\\x75\\x01\\x74\\x01\\x74\\x01\\x73\\x01\"\n\t\t   \"\\x73\\x01\\x72\\x01\\x72\\x01\\x71\\x01\"\n\t\t   \"\\x71\\x01\\x70\\x01\\x70\\x01\\x68\\x01\"\n\t\t   \"\\x68\\x01\\x67\\x01\\x67\\x01\\x66\\x01\"\n\t\t   \"\\x66\\x01\\x65\\x01\\x65\\x01\\x57\\x01\"\n\t\t   \"\\x57\\x01\\x56\\x01\\x56\\x01\\x55\\x01\"\n\t\t   \"\\x55\\x01\\x54\\x01\\x54\\x01\\x53\\x01\"\n\t\t   \"\\x53\\x01\\x52\\x01\\x52\\x01\\x51\\x01\"\n\t\t   \"\\x51\\x01\\x50\\x01\\x50\\x01\\x48\\x01\"\n\t\t   \"\\x48\\x01\\x47\\x01\\x47\\x01\\x46\\x01\"\n\t\t   \"\\x46\\x01\\x45\\x01\\x45\\x01\\x44\\x01\"\n\t\t   \"\\x44\\x01\\x43\\x01\\x43\\x01\\x42\\x01\"\n\t\t   \"\\x42\\x01\\x41\\x01\\x41\\x01\\x40\\x01\"\n\t\t   \"\\x40\\x01\\x40\\x01\\x40\\x01\\x40\\x01\"\n\t\t   \"\\x40\\x01\\x40\\x01\\x40\\x01\\x40\\x01\"\n\t\t   \"\\x40\\x01\\x40\\x01\\x40\\x01\\x40\\x01\"\n\t\t   \"\\x40\\x01\\x40\\x01\\x40\\x01\\x40\\x01\");\n\n \nint hermes_apply_pda_with_defaults(struct hermes *hw,\n\t\t\t\t   const char *first_pdr,\n\t\t\t\t   const void *pdr_end,\n\t\t\t\t   const __le16 *pda,\n\t\t\t\t   const void *pda_end)\n{\n\tconst struct pdr *pdr = (const struct pdr *) first_pdr;\n\tconst struct pdi *first_pdi = (const struct pdi *) &pda[2];\n\tconst struct pdi *pdi;\n\tconst struct pdi *default_pdi = NULL;\n\tconst struct pdi *outdoor_pdi;\n\tint record_id;\n\n\tpdr_end -= sizeof(struct pdr);\n\n\twhile (((void *) pdr <= pdr_end) &&\n\t       (pdr_id(pdr) != PDI_END)) {\n\t\t \n\t\tif (pdr_len(pdr) < 2)\n\t\t\tbreak;\n\t\trecord_id = pdr_id(pdr);\n\n\t\tpdi = hermes_find_pdi(first_pdi, record_id, pda_end);\n\t\tif (pdi)\n\t\t\tpr_debug(PFX \"Found record 0x%04x at %p\\n\",\n\t\t\t\t record_id, pdi);\n\n\t\tswitch (record_id) {\n\t\tcase 0x110:  \n\t\tcase 0x120:  \n\t\t\toutdoor_pdi = hermes_find_pdi(first_pdi, record_id + 1,\n\t\t\t\t\t\t      pda_end);\n\t\t\tdefault_pdi = NULL;\n\t\t\tif (outdoor_pdi) {\n\t\t\t\tpdi = outdoor_pdi;\n\t\t\t\tpr_debug(PFX\n\t\t\t\t\t \"Using outdoor record 0x%04x at %p\\n\",\n\t\t\t\t\t record_id + 1, pdi);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 0x5:  \n\t\t\tdefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0005);\n\t\t\tbreak;\n\t\tcase 0x108:  \n\t\t\tdefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0108);\n\t\t\tbreak;\n\t\tcase 0x109:  \n\t\t\tdefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0109);\n\t\t\tbreak;\n\t\tcase 0x150:  \n\t\t\tdefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0150);\n\t\t\tbreak;\n\t\tcase 0x160:  \n\t\t\tdefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0160);\n\t\t\tbreak;\n\t\tcase 0x161:  \n\t\t\tdefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0161);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdefault_pdi = NULL;\n\t\t\tbreak;\n\t\t}\n\t\tif (!pdi && default_pdi) {\n\t\t\t \n\t\t\tpdi = default_pdi;\n\t\t\tpr_debug(PFX \"Using default record 0x%04x at %p\\n\",\n\t\t\t\t record_id, pdi);\n\t\t}\n\n\t\tif (pdi) {\n\t\t\t \n\t\t\tif ((pdi_len(pdi) == pdr_len(pdr)) &&\n\t\t\t    ((void *) pdi->data + pdi_len(pdi) < pda_end)) {\n\t\t\t\t \n\t\t\t\thw->ops->program(hw, pdi->data, pdr_addr(pdr),\n\t\t\t\t\t\t pdi_len(pdi));\n\t\t\t}\n\t\t}\n\n\t\tpdr++;\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}