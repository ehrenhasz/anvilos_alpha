{
  "module_name": "cfg.c",
  "hash_id": "1dfb7f31674217ab9e5e27e2bfddd4240164cfcba7e00f5bef9d4b04a347054f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/intersil/orinoco/cfg.c",
  "human_readable_source": " \n#include <linux/ieee80211.h>\n#include <net/cfg80211.h>\n#include \"hw.h\"\n#include \"main.h\"\n#include \"orinoco.h\"\n\n#include \"cfg.h\"\n\n \nstatic struct ieee80211_rate orinoco_rates[] = {\n\t{ .bitrate = 10 },\n\t{ .bitrate = 20 },\n\t{ .bitrate = 55 },\n\t{ .bitrate = 110 },\n};\n\nstatic const void * const orinoco_wiphy_privid = &orinoco_wiphy_privid;\n\n \nvoid orinoco_wiphy_init(struct wiphy *wiphy)\n{\n\tstruct orinoco_private *priv = wiphy_priv(wiphy);\n\n\twiphy->privid = orinoco_wiphy_privid;\n\n\tset_wiphy_dev(wiphy, priv->dev);\n}\n\n \nint orinoco_wiphy_register(struct wiphy *wiphy)\n{\n\tstruct orinoco_private *priv = wiphy_priv(wiphy);\n\tint i, channels = 0;\n\n\tif (priv->firmware_type == FIRMWARE_TYPE_AGERE)\n\t\twiphy->max_scan_ssids = 1;\n\telse\n\t\twiphy->max_scan_ssids = 0;\n\n\twiphy->interface_modes = BIT(NL80211_IFTYPE_STATION);\n\n\t \n\tif (priv->has_ibss)\n\t\twiphy->interface_modes |= BIT(NL80211_IFTYPE_ADHOC);\n\n\tif (!priv->broken_monitor || force_monitor)\n\t\twiphy->interface_modes |= BIT(NL80211_IFTYPE_MONITOR);\n\n\tpriv->band.bitrates = orinoco_rates;\n\tpriv->band.n_bitrates = ARRAY_SIZE(orinoco_rates);\n\n\t \n\tfor (i = 0; i < NUM_CHANNELS; i++) {\n\t\tif (priv->channel_mask & (1 << i)) {\n\t\t\tpriv->channels[i].center_freq =\n\t\t\t\tieee80211_channel_to_frequency(i + 1,\n\t\t\t\t\t\t\t   NL80211_BAND_2GHZ);\n\t\t\tchannels++;\n\t\t}\n\t}\n\tpriv->band.channels = priv->channels;\n\tpriv->band.n_channels = channels;\n\n\twiphy->bands[NL80211_BAND_2GHZ] = &priv->band;\n\twiphy->signal_type = CFG80211_SIGNAL_TYPE_MBM;\n\n\ti = 0;\n\tif (priv->has_wep) {\n\t\tpriv->cipher_suites[i] = WLAN_CIPHER_SUITE_WEP40;\n\t\ti++;\n\n\t\tif (priv->has_big_wep) {\n\t\t\tpriv->cipher_suites[i] = WLAN_CIPHER_SUITE_WEP104;\n\t\t\ti++;\n\t\t}\n\t}\n\tif (priv->has_wpa) {\n\t\tpriv->cipher_suites[i] = WLAN_CIPHER_SUITE_TKIP;\n\t\ti++;\n\t}\n\twiphy->cipher_suites = priv->cipher_suites;\n\twiphy->n_cipher_suites = i;\n\n\twiphy->rts_threshold = priv->rts_thresh;\n\tif (!priv->has_mwo)\n\t\twiphy->frag_threshold = priv->frag_thresh + 1;\n\twiphy->retry_short = priv->short_retry_limit;\n\twiphy->retry_long = priv->long_retry_limit;\n\n\treturn wiphy_register(wiphy);\n}\n\nstatic int orinoco_change_vif(struct wiphy *wiphy, struct net_device *dev,\n\t\t\t      enum nl80211_iftype type,\n\t\t\t      struct vif_params *params)\n{\n\tstruct orinoco_private *priv = wiphy_priv(wiphy);\n\tint err = 0;\n\tunsigned long lock;\n\n\tif (orinoco_lock(priv, &lock) != 0)\n\t\treturn -EBUSY;\n\n\tswitch (type) {\n\tcase NL80211_IFTYPE_ADHOC:\n\t\tif (!priv->has_ibss && !priv->has_port3)\n\t\t\terr = -EINVAL;\n\t\tbreak;\n\n\tcase NL80211_IFTYPE_STATION:\n\t\tbreak;\n\n\tcase NL80211_IFTYPE_MONITOR:\n\t\tif (priv->broken_monitor && !force_monitor) {\n\t\t\twiphy_warn(wiphy,\n\t\t\t\t   \"Monitor mode support is buggy in this firmware, not enabling\\n\");\n\t\t\terr = -EINVAL;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\terr = -EINVAL;\n\t}\n\n\tif (!err) {\n\t\tpriv->iw_mode = type;\n\t\tset_port_type(priv);\n\t\terr = orinoco_commit(priv);\n\t}\n\n\torinoco_unlock(priv, &lock);\n\n\treturn err;\n}\n\nstatic int orinoco_scan(struct wiphy *wiphy,\n\t\t\tstruct cfg80211_scan_request *request)\n{\n\tstruct orinoco_private *priv = wiphy_priv(wiphy);\n\tint err;\n\n\tif (!request)\n\t\treturn -EINVAL;\n\n\tif (priv->scan_request && priv->scan_request != request)\n\t\treturn -EBUSY;\n\n\tpriv->scan_request = request;\n\n\terr = orinoco_hw_trigger_scan(priv, request->ssids);\n\t \n\tif (err)\n\t\tpriv->scan_request = NULL;\n\n\treturn err;\n}\n\nstatic int orinoco_set_monitor_channel(struct wiphy *wiphy,\n\t\t\t\t       struct cfg80211_chan_def *chandef)\n{\n\tstruct orinoco_private *priv = wiphy_priv(wiphy);\n\tint err = 0;\n\tunsigned long flags;\n\tint channel;\n\n\tif (!chandef->chan)\n\t\treturn -EINVAL;\n\n\tif (cfg80211_get_chandef_type(chandef) != NL80211_CHAN_NO_HT)\n\t\treturn -EINVAL;\n\n\tif (chandef->chan->band != NL80211_BAND_2GHZ)\n\t\treturn -EINVAL;\n\n\tchannel = ieee80211_frequency_to_channel(chandef->chan->center_freq);\n\n\tif ((channel < 1) || (channel > NUM_CHANNELS) ||\n\t     !(priv->channel_mask & (1 << (channel - 1))))\n\t\treturn -EINVAL;\n\n\tif (orinoco_lock(priv, &flags) != 0)\n\t\treturn -EBUSY;\n\n\tpriv->channel = channel;\n\tif (priv->iw_mode == NL80211_IFTYPE_MONITOR) {\n\t\t \n\t\tstruct hermes *hw = &priv->hw;\n\t\terr = hw->ops->cmd_wait(hw, HERMES_CMD_TEST |\n\t\t\t\t\t    HERMES_TEST_SET_CHANNEL,\n\t\t\t\t\tchannel, NULL);\n\t}\n\torinoco_unlock(priv, &flags);\n\n\treturn err;\n}\n\nstatic int orinoco_set_wiphy_params(struct wiphy *wiphy, u32 changed)\n{\n\tstruct orinoco_private *priv = wiphy_priv(wiphy);\n\tint frag_value = -1;\n\tint rts_value = -1;\n\tint err = 0;\n\n\tif (changed & WIPHY_PARAM_RETRY_SHORT) {\n\t\t \n\t\terr = -EINVAL;\n\t}\n\n\tif (changed & WIPHY_PARAM_RETRY_LONG) {\n\t\t \n\t\terr = -EINVAL;\n\t}\n\n\tif (changed & WIPHY_PARAM_FRAG_THRESHOLD) {\n\t\t \n\t\tif (priv->has_mwo) {\n\t\t\tif (wiphy->frag_threshold == -1)\n\t\t\t\tfrag_value = 0;\n\t\t\telse {\n\t\t\t\tprintk(KERN_WARNING \"%s: Fixed fragmentation \"\n\t\t\t\t       \"is not supported on this firmware. \"\n\t\t\t\t       \"Using MWO robust instead.\\n\",\n\t\t\t\t       priv->ndev->name);\n\t\t\t\tfrag_value = 1;\n\t\t\t}\n\t\t} else {\n\t\t\tif (wiphy->frag_threshold == -1)\n\t\t\t\tfrag_value = 2346;\n\t\t\telse if ((wiphy->frag_threshold < 257) ||\n\t\t\t\t (wiphy->frag_threshold > 2347))\n\t\t\t\terr = -EINVAL;\n\t\t\telse\n\t\t\t\t \n\t\t\t\tfrag_value = wiphy->frag_threshold & ~0x1;\n\t\t}\n\t}\n\n\tif (changed & WIPHY_PARAM_RTS_THRESHOLD) {\n\t\t \n\n\t\tif (wiphy->rts_threshold == -1)\n\t\t\trts_value = 2347;\n\t\telse if (wiphy->rts_threshold > 2347)\n\t\t\terr = -EINVAL;\n\t\telse\n\t\t\trts_value = wiphy->rts_threshold;\n\t}\n\n\tif (!err) {\n\t\tunsigned long flags;\n\n\t\tif (orinoco_lock(priv, &flags) != 0)\n\t\t\treturn -EBUSY;\n\n\t\tif (frag_value >= 0) {\n\t\t\tif (priv->has_mwo)\n\t\t\t\tpriv->mwo_robust = frag_value;\n\t\t\telse\n\t\t\t\tpriv->frag_thresh = frag_value;\n\t\t}\n\t\tif (rts_value >= 0)\n\t\t\tpriv->rts_thresh = rts_value;\n\n\t\terr = orinoco_commit(priv);\n\n\t\torinoco_unlock(priv, &flags);\n\t}\n\n\treturn err;\n}\n\nconst struct cfg80211_ops orinoco_cfg_ops = {\n\t.change_virtual_intf = orinoco_change_vif,\n\t.set_monitor_channel = orinoco_set_monitor_channel,\n\t.scan = orinoco_scan,\n\t.set_wiphy_params = orinoco_set_wiphy_params,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}