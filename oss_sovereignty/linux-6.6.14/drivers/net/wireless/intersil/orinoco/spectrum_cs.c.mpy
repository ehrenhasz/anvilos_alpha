{
  "module_name": "spectrum_cs.c",
  "hash_id": "f407b7ff8504114bd0a6068e289b61ac032943119055c4b25ed9b5215b7c4298",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/intersil/orinoco/spectrum_cs.c",
  "human_readable_source": " \n\n#define DRIVER_NAME \"spectrum_cs\"\n#define PFX DRIVER_NAME \": \"\n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <pcmcia/cistpl.h>\n#include <pcmcia/cisreg.h>\n#include <pcmcia/ds.h>\n\n#include \"orinoco.h\"\n\n \n \n \n\nMODULE_AUTHOR(\"Pavel Roskin <proski@gnu.org>\");\nMODULE_DESCRIPTION(\"Driver for Symbol Spectrum24 Trilogy cards with firmware downloader\");\nMODULE_LICENSE(\"Dual MPL/GPL\");\n\n \n\n \nstatic int ignore_cis_vcc;  \nmodule_param(ignore_cis_vcc, int, 0);\nMODULE_PARM_DESC(ignore_cis_vcc, \"Allow voltage mismatch between card and socket\");\n\n \n \n \n\n \nstruct orinoco_pccard {\n\tstruct pcmcia_device\t*p_dev;\n};\n\n \n \n \n\nstatic int spectrum_cs_config(struct pcmcia_device *link);\nstatic void spectrum_cs_release(struct pcmcia_device *link);\n\n \n#define HCR_RUN\t\t0x07\t \n#define HCR_IDLE\t0x0E\t \n#define HCR_MEM16\t0x10\t \n\n\n \nstatic int\nspectrum_reset(struct pcmcia_device *link, int idle)\n{\n\tint ret;\n\tu8 save_cor;\n\tu8 ccsr;\n\n\t \n\tif (!pcmcia_dev_present(link))\n\t\treturn -ENODEV;\n\n\t \n\tret = pcmcia_read_config_byte(link, CISREG_COR, &save_cor);\n\tif (ret)\n\t\tgoto failed;\n\n\t \n\tret = pcmcia_write_config_byte(link, CISREG_COR,\n\t\t\t\t(save_cor | COR_SOFT_RESET));\n\tif (ret)\n\t\tgoto failed;\n\tudelay(1000);\n\n\t \n\tret = pcmcia_read_config_byte(link, CISREG_CCSR, &ccsr);\n\tif (ret)\n\t\tgoto failed;\n\n\t \n\tccsr = (idle ? HCR_IDLE : HCR_RUN) | (ccsr & HCR_MEM16);\n\tret = pcmcia_write_config_byte(link, CISREG_CCSR, ccsr);\n\tif (ret)\n\t\tgoto failed;\n\tudelay(1000);\n\n\t \n\tret = pcmcia_write_config_byte(link, CISREG_COR,\n\t\t\t\t(save_cor & ~COR_SOFT_RESET));\n\tif (ret)\n\t\tgoto failed;\n\tudelay(1000);\n\treturn 0;\n\nfailed:\n\treturn -ENODEV;\n}\n\n \n \n \n\nstatic int\nspectrum_cs_hard_reset(struct orinoco_private *priv)\n{\n\tstruct orinoco_pccard *card = priv->card;\n\tstruct pcmcia_device *link = card->p_dev;\n\n\t \n\tspectrum_reset(link, 0);\n\n\treturn 0;\n}\n\nstatic int\nspectrum_cs_stop_firmware(struct orinoco_private *priv, int idle)\n{\n\tstruct orinoco_pccard *card = priv->card;\n\tstruct pcmcia_device *link = card->p_dev;\n\n\treturn spectrum_reset(link, idle);\n}\n\n \n \n \n\nstatic int\nspectrum_cs_probe(struct pcmcia_device *link)\n{\n\tstruct orinoco_private *priv;\n\tstruct orinoco_pccard *card;\n\tint ret;\n\n\tpriv = alloc_orinocodev(sizeof(*card), &link->dev,\n\t\t\t\tspectrum_cs_hard_reset,\n\t\t\t\tspectrum_cs_stop_firmware);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\tcard = priv->card;\n\n\t \n\tcard->p_dev = link;\n\tlink->priv = priv;\n\n\tret = spectrum_cs_config(link);\n\tif (ret)\n\t\tgoto err_free_orinocodev;\n\n\treturn 0;\n\nerr_free_orinocodev:\n\tfree_orinocodev(priv);\n\treturn ret;\n}\n\nstatic void spectrum_cs_detach(struct pcmcia_device *link)\n{\n\tstruct orinoco_private *priv = link->priv;\n\n\torinoco_if_del(priv);\n\n\tspectrum_cs_release(link);\n\n\tfree_orinocodev(priv);\n}\t\t\t\t \n\nstatic int spectrum_cs_config_check(struct pcmcia_device *p_dev,\n\t\t\t\t    void *priv_data)\n{\n\tif (p_dev->config_index == 0)\n\t\treturn -EINVAL;\n\n\treturn pcmcia_request_io(p_dev);\n};\n\nstatic int\nspectrum_cs_config(struct pcmcia_device *link)\n{\n\tstruct orinoco_private *priv = link->priv;\n\tstruct hermes *hw = &priv->hw;\n\tint ret;\n\tvoid __iomem *mem;\n\n\tlink->config_flags |= CONF_AUTO_SET_VPP | CONF_AUTO_CHECK_VCC |\n\t\tCONF_AUTO_SET_IO | CONF_ENABLE_IRQ;\n\tif (ignore_cis_vcc)\n\t\tlink->config_flags &= ~CONF_AUTO_CHECK_VCC;\n\tret = pcmcia_loop_config(link, spectrum_cs_config_check, NULL);\n\tif (ret) {\n\t\tif (!ignore_cis_vcc)\n\t\t\tprintk(KERN_ERR PFX \"GetNextTuple(): No matching \"\n\t\t\t       \"CIS configuration.  Maybe you need the \"\n\t\t\t       \"ignore_cis_vcc=1 parameter.\\n\");\n\t\tgoto failed;\n\t}\n\n\tmem = ioport_map(link->resource[0]->start,\n\t\t\tresource_size(link->resource[0]));\n\tif (!mem)\n\t\tgoto failed;\n\n\t \n\thermes_struct_init(hw, mem, HERMES_16BIT_REGSPACING);\n\thw->eeprom_pda = true;\n\n\tret = pcmcia_request_irq(link, orinoco_interrupt);\n\tif (ret)\n\t\tgoto failed;\n\n\tret = pcmcia_enable_device(link);\n\tif (ret)\n\t\tgoto failed;\n\n\t \n\tif (spectrum_cs_hard_reset(priv) != 0)\n\t\tgoto failed;\n\n\t \n\tif (orinoco_init(priv) != 0) {\n\t\tprintk(KERN_ERR PFX \"orinoco_init() failed\\n\");\n\t\tgoto failed;\n\t}\n\n\t \n\tif (orinoco_if_add(priv, link->resource[0]->start,\n\t\t\t   link->irq, NULL) != 0) {\n\t\tprintk(KERN_ERR PFX \"orinoco_if_add() failed\\n\");\n\t\tgoto failed;\n\t}\n\n\treturn 0;\n\n failed:\n\tspectrum_cs_release(link);\n\treturn -ENODEV;\n}\t\t\t\t \n\nstatic void\nspectrum_cs_release(struct pcmcia_device *link)\n{\n\tstruct orinoco_private *priv = link->priv;\n\tunsigned long flags;\n\n\t \n\tpriv->hw.ops->lock_irqsave(&priv->lock, &flags);\n\tpriv->hw_unavailable++;\n\tpriv->hw.ops->unlock_irqrestore(&priv->lock, &flags);\n\n\tpcmcia_disable_device(link);\n\tif (priv->hw.iobase)\n\t\tioport_unmap(priv->hw.iobase);\n}\t\t\t\t \n\n\nstatic int\nspectrum_cs_suspend(struct pcmcia_device *link)\n{\n\tstruct orinoco_private *priv = link->priv;\n\n\t \n\torinoco_down(priv);\n\n\treturn 0;\n}\n\nstatic int\nspectrum_cs_resume(struct pcmcia_device *link)\n{\n\tstruct orinoco_private *priv = link->priv;\n\tint err = orinoco_up(priv);\n\n\treturn err;\n}\n\n\n \n \n \n\nstatic const struct pcmcia_device_id spectrum_cs_ids[] = {\n\tPCMCIA_DEVICE_MANF_CARD(0x026c, 0x0001),  \n\tPCMCIA_DEVICE_MANF_CARD(0x0104, 0x0001),  \n\tPCMCIA_DEVICE_PROD_ID12(\"Intel\", \"PRO/Wireless LAN PC Card\", 0x816cc815, 0x6fbf459a),  \n\tPCMCIA_DEVICE_NULL,\n};\nMODULE_DEVICE_TABLE(pcmcia, spectrum_cs_ids);\n\nstatic struct pcmcia_driver orinoco_driver = {\n\t.owner\t\t= THIS_MODULE,\n\t.name\t\t= DRIVER_NAME,\n\t.probe\t\t= spectrum_cs_probe,\n\t.remove\t\t= spectrum_cs_detach,\n\t.suspend\t= spectrum_cs_suspend,\n\t.resume\t\t= spectrum_cs_resume,\n\t.id_table       = spectrum_cs_ids,\n};\nmodule_pcmcia_driver(orinoco_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}