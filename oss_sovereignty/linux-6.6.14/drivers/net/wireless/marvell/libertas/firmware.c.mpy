{
  "module_name": "firmware.c",
  "hash_id": "f4a602d1962894d431772fbfb8d778bfb2ee7af1f3952da1584740f266570a7f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/marvell/libertas/firmware.c",
  "human_readable_source": "\n \n\n#include <linux/sched.h>\n#include <linux/firmware.h>\n#include <linux/module.h>\n\n#include \"dev.h\"\n#include \"decl.h\"\n\nstatic void load_next_firmware_from_table(struct lbs_private *private);\n\nstatic void lbs_fw_loaded(struct lbs_private *priv, int ret,\n\tconst struct firmware *helper, const struct firmware *mainfw)\n{\n\tunsigned long flags;\n\n\tlbs_deb_fw(\"firmware load complete, code %d\\n\", ret);\n\n\t \n\tpriv->fw_callback(priv, ret, helper, mainfw);\n\n\tspin_lock_irqsave(&priv->driver_lock, flags);\n\tpriv->fw_callback = NULL;\n\twake_up(&priv->fw_waitq);\n\tspin_unlock_irqrestore(&priv->driver_lock, flags);\n}\n\nstatic void do_load_firmware(struct lbs_private *priv, const char *name,\n\tvoid (*cb)(const struct firmware *fw, void *context))\n{\n\tint ret;\n\n\tlbs_deb_fw(\"Requesting %s\\n\", name);\n\tret = request_firmware_nowait(THIS_MODULE, true, name,\n\t\t\tpriv->fw_device, GFP_KERNEL, priv, cb);\n\tif (ret) {\n\t\tlbs_deb_fw(\"request_firmware_nowait error %d\\n\", ret);\n\t\tlbs_fw_loaded(priv, ret, NULL, NULL);\n\t}\n}\n\nstatic void main_firmware_cb(const struct firmware *firmware, void *context)\n{\n\tstruct lbs_private *priv = context;\n\n\tif (!firmware) {\n\t\t \n\t\tload_next_firmware_from_table(priv);\n\t\treturn;\n\t}\n\n\t \n\tlbs_fw_loaded(priv, 0, priv->helper_fw, firmware);\n\tif (priv->helper_fw) {\n\t\trelease_firmware (priv->helper_fw);\n\t\tpriv->helper_fw = NULL;\n\t}\n\trelease_firmware (firmware);\n}\n\nstatic void helper_firmware_cb(const struct firmware *firmware, void *context)\n{\n\tstruct lbs_private *priv = context;\n\n\tif (!firmware) {\n\t\t \n\t\tload_next_firmware_from_table(priv);\n\t\treturn;\n\t}\n\n\t \n\tif (priv->fw_iter->fwname) {\n\t\tpriv->helper_fw = firmware;\n\t\tdo_load_firmware(priv, priv->fw_iter->fwname, main_firmware_cb);\n\t} else {\n\t\t \n\t\tlbs_fw_loaded(priv, 0, firmware, NULL);\n\t}\n}\n\nstatic void load_next_firmware_from_table(struct lbs_private *priv)\n{\n\tconst struct lbs_fw_table *iter;\n\n\tif (!priv->fw_iter)\n\t\titer = priv->fw_table;\n\telse\n\t\titer = ++priv->fw_iter;\n\n\tif (priv->helper_fw) {\n\t\trelease_firmware(priv->helper_fw);\n\t\tpriv->helper_fw = NULL;\n\t}\n\nnext:\n\tif (!iter->helper) {\n\t\t \n\t\tlbs_fw_loaded(priv, -ENOENT, NULL, NULL);\n\t\treturn;\n\t}\n\n\tif (iter->model != priv->fw_model) {\n\t\titer++;\n\t\tgoto next;\n\t}\n\n\tpriv->fw_iter = iter;\n\tdo_load_firmware(priv, iter->helper, helper_firmware_cb);\n}\n\nvoid lbs_wait_for_firmware_load(struct lbs_private *priv)\n{\n\twait_event(priv->fw_waitq, priv->fw_callback == NULL);\n}\n\n \nint lbs_get_firmware_async(struct lbs_private *priv, struct device *device,\n\t\t\t    u32 card_model, const struct lbs_fw_table *fw_table,\n\t\t\t    lbs_fw_cb callback)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&priv->driver_lock, flags);\n\tif (priv->fw_callback) {\n\t\tlbs_deb_fw(\"firmware load already in progress\\n\");\n\t\tspin_unlock_irqrestore(&priv->driver_lock, flags);\n\t\treturn -EBUSY;\n\t}\n\n\tpriv->fw_device = device;\n\tpriv->fw_callback = callback;\n\tpriv->fw_table = fw_table;\n\tpriv->fw_iter = NULL;\n\tpriv->fw_model = card_model;\n\tspin_unlock_irqrestore(&priv->driver_lock, flags);\n\n\tlbs_deb_fw(\"Starting async firmware load\\n\");\n\tload_next_firmware_from_table(priv);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(lbs_get_firmware_async);\n\n \nint lbs_get_firmware(struct device *dev, u32 card_model,\n\t\t\tconst struct lbs_fw_table *fw_table,\n\t\t\tconst struct firmware **helper,\n\t\t\tconst struct firmware **mainfw)\n{\n\tconst struct lbs_fw_table *iter;\n\tint ret;\n\n\tBUG_ON(helper == NULL);\n\tBUG_ON(mainfw == NULL);\n\n\t \n\titer = fw_table;\n\twhile (iter && iter->helper) {\n\t\tif (iter->model != card_model)\n\t\t\tgoto next;\n\n\t\tif (*helper == NULL) {\n\t\t\tret = request_firmware(helper, iter->helper, dev);\n\t\t\tif (ret)\n\t\t\t\tgoto next;\n\n\t\t\t \n\t\t\tif (iter->fwname == NULL)\n\t\t\t\treturn 0;\n\t\t}\n\n\t\tif (*mainfw == NULL) {\n\t\t\tret = request_firmware(mainfw, iter->fwname, dev);\n\t\t\tif (ret) {\n\t\t\t\t \n\t\t\t\trelease_firmware(*helper);\n\t\t\t\t*helper = NULL;\n\t\t\t}\n\t\t}\n\n\t\tif (*helper && *mainfw)\n\t\t\treturn 0;\n\n  next:\n\t\titer++;\n\t}\n\n\t \n\trelease_firmware(*helper);\n\t*helper = NULL;\n\trelease_firmware(*mainfw);\n\t*mainfw = NULL;\n\n\treturn -ENOENT;\n}\nEXPORT_SYMBOL_GPL(lbs_get_firmware);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}