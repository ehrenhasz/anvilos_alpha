{
  "module_name": "pci_mac.c",
  "hash_id": "2806c3c658f292fbd98cd6b1f725b8b5a33c6a3abfa1930d67945f5d7becda3f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7921/pci_mac.c",
  "human_readable_source": "\n \n\n#include \"mt7921.h\"\n#include \"../dma.h\"\n#include \"../mt76_connac2_mac.h\"\n\nint mt7921e_tx_prepare_skb(struct mt76_dev *mdev, void *txwi_ptr,\n\t\t\t   enum mt76_txq_id qid, struct mt76_wcid *wcid,\n\t\t\t   struct ieee80211_sta *sta,\n\t\t\t   struct mt76_tx_info *tx_info)\n{\n\tstruct mt792x_dev *dev = container_of(mdev, struct mt792x_dev, mt76);\n\tstruct ieee80211_tx_info *info = IEEE80211_SKB_CB(tx_info->skb);\n\tstruct ieee80211_key_conf *key = info->control.hw_key;\n\tstruct mt76_connac_hw_txp *txp;\n\tstruct mt76_txwi_cache *t;\n\tint id, pid;\n\tu8 *txwi = (u8 *)txwi_ptr;\n\n\tif (unlikely(tx_info->skb->len <= ETH_HLEN))\n\t\treturn -EINVAL;\n\n\tif (!wcid)\n\t\twcid = &dev->mt76.global_wcid;\n\n\tt = (struct mt76_txwi_cache *)(txwi + mdev->drv->txwi_size);\n\tt->skb = tx_info->skb;\n\n\tid = mt76_token_consume(mdev, &t);\n\tif (id < 0)\n\t\treturn id;\n\n\tif (sta) {\n\t\tstruct mt792x_sta *msta = (struct mt792x_sta *)sta->drv_priv;\n\n\t\tif (time_after(jiffies, msta->last_txs + HZ / 4)) {\n\t\t\tinfo->flags |= IEEE80211_TX_CTL_REQ_TX_STATUS;\n\t\t\tmsta->last_txs = jiffies;\n\t\t}\n\t}\n\n\tpid = mt76_tx_status_skb_add(mdev, wcid, tx_info->skb);\n\tmt76_connac2_mac_write_txwi(mdev, txwi_ptr, tx_info->skb, wcid, key,\n\t\t\t\t    pid, qid, 0);\n\n\ttxp = (struct mt76_connac_hw_txp *)(txwi + MT_TXD_SIZE);\n\tmemset(txp, 0, sizeof(struct mt76_connac_hw_txp));\n\tmt76_connac_write_hw_txp(mdev, tx_info, txp, id);\n\n\ttx_info->skb = NULL;\n\n\treturn 0;\n}\n\nint mt7921e_mac_reset(struct mt792x_dev *dev)\n{\n\tint i, err;\n\n\tmt792xe_mcu_drv_pmctrl(dev);\n\n\tmt76_connac_free_pending_tx_skbs(&dev->pm, NULL);\n\n\tmt76_wr(dev, dev->irq_map->host_irq_enable, 0);\n\tmt76_wr(dev, MT_PCIE_MAC_INT_ENABLE, 0x0);\n\n\tset_bit(MT76_RESET, &dev->mphy.state);\n\tset_bit(MT76_MCU_RESET, &dev->mphy.state);\n\twake_up(&dev->mt76.mcu.wait);\n\tskb_queue_purge(&dev->mt76.mcu.res_q);\n\n\tmt76_txq_schedule_all(&dev->mphy);\n\n\tmt76_worker_disable(&dev->mt76.tx_worker);\n\tnapi_disable(&dev->mt76.napi[MT_RXQ_MAIN]);\n\tnapi_disable(&dev->mt76.napi[MT_RXQ_MCU]);\n\tnapi_disable(&dev->mt76.napi[MT_RXQ_MCU_WA]);\n\tnapi_disable(&dev->mt76.tx_napi);\n\n\tmt76_connac2_tx_token_put(&dev->mt76);\n\tidr_init(&dev->mt76.token);\n\n\tmt792x_wpdma_reset(dev, true);\n\n\tlocal_bh_disable();\n\tmt76_for_each_q_rx(&dev->mt76, i) {\n\t\tnapi_enable(&dev->mt76.napi[i]);\n\t\tnapi_schedule(&dev->mt76.napi[i]);\n\t}\n\tlocal_bh_enable();\n\n\tdev->fw_assert = false;\n\tclear_bit(MT76_MCU_RESET, &dev->mphy.state);\n\n\tmt76_wr(dev, dev->irq_map->host_irq_enable,\n\t\tdev->irq_map->tx.all_complete_mask |\n\t\tMT_INT_RX_DONE_ALL | MT_INT_MCU_CMD);\n\tmt76_wr(dev, MT_PCIE_MAC_INT_ENABLE, 0xff);\n\n\terr = mt7921e_driver_own(dev);\n\tif (err)\n\t\tgoto out;\n\n\terr = mt7921_run_firmware(dev);\n\tif (err)\n\t\tgoto out;\n\n\terr = mt7921_mcu_set_eeprom(dev);\n\tif (err)\n\t\tgoto out;\n\n\terr = mt7921_mac_init(dev);\n\tif (err)\n\t\tgoto out;\n\n\terr = __mt7921_start(&dev->phy);\nout:\n\tclear_bit(MT76_RESET, &dev->mphy.state);\n\n\tlocal_bh_disable();\n\tnapi_enable(&dev->mt76.tx_napi);\n\tnapi_schedule(&dev->mt76.tx_napi);\n\tlocal_bh_enable();\n\n\tmt76_worker_enable(&dev->mt76.tx_worker);\n\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}