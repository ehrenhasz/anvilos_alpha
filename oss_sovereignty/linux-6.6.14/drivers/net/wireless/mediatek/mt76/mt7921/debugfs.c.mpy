{
  "module_name": "debugfs.c",
  "hash_id": "e229962583f1445e401d9716ad5498121577c787948d1235be8f1693c9743e2e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7921/debugfs.c",
  "human_readable_source": "\n \n\n#include \"mt7921.h\"\n\nstatic int\nmt7921_reg_set(void *data, u64 val)\n{\n\tstruct mt792x_dev *dev = data;\n\n\tmt792x_mutex_acquire(dev);\n\tmt76_wr(dev, dev->mt76.debugfs_reg, val);\n\tmt792x_mutex_release(dev);\n\n\treturn 0;\n}\n\nstatic int\nmt7921_reg_get(void *data, u64 *val)\n{\n\tstruct mt792x_dev *dev = data;\n\n\tmt792x_mutex_acquire(dev);\n\t*val = mt76_rr(dev, dev->mt76.debugfs_reg);\n\tmt792x_mutex_release(dev);\n\n\treturn 0;\n}\n\nDEFINE_DEBUGFS_ATTRIBUTE(fops_regval, mt7921_reg_get, mt7921_reg_set,\n\t\t\t \"0x%08llx\\n\");\nstatic int\nmt7921_fw_debug_set(void *data, u64 val)\n{\n\tstruct mt792x_dev *dev = data;\n\n\tmt792x_mutex_acquire(dev);\n\n\tdev->fw_debug = (u8)val;\n\tmt7921_mcu_fw_log_2_host(dev, dev->fw_debug);\n\n\tmt792x_mutex_release(dev);\n\n\treturn 0;\n}\n\nstatic int\nmt7921_fw_debug_get(void *data, u64 *val)\n{\n\tstruct mt792x_dev *dev = data;\n\n\t*val = dev->fw_debug;\n\n\treturn 0;\n}\n\nDEFINE_DEBUGFS_ATTRIBUTE(fops_fw_debug, mt7921_fw_debug_get,\n\t\t\t mt7921_fw_debug_set, \"%lld\\n\");\n\nDEFINE_SHOW_ATTRIBUTE(mt792x_tx_stats);\n\nstatic void\nmt7921_seq_puts_array(struct seq_file *file, const char *str,\n\t\t      s8 *val, int len)\n{\n\tint i;\n\n\tseq_printf(file, \"%-16s:\", str);\n\tfor (i = 0; i < len; i++)\n\t\tif (val[i] == 127)\n\t\t\tseq_printf(file, \" %6s\", \"N.A\");\n\t\telse\n\t\t\tseq_printf(file, \" %6d\", val[i]);\n\tseq_puts(file, \"\\n\");\n}\n\n#define mt7921_print_txpwr_entry(prefix, rate)\t\t\t\t\\\n({\t\t\t\t\t\t\t\t\t\\\n\tmt7921_seq_puts_array(s, #prefix \" (user)\",\t\t\t\\\n\t\t\t      txpwr.data[TXPWR_USER].rate,\t\t\\\n\t\t\t      ARRAY_SIZE(txpwr.data[TXPWR_USER].rate)); \\\n\tmt7921_seq_puts_array(s, #prefix \" (eeprom)\",\t\t\t\\\n\t\t\t      txpwr.data[TXPWR_EEPROM].rate,\t\t\\\n\t\t\t      ARRAY_SIZE(txpwr.data[TXPWR_EEPROM].rate)); \\\n\tmt7921_seq_puts_array(s, #prefix \" (tmac)\",\t\t\t\\\n\t\t\t      txpwr.data[TXPWR_MAC].rate,\t\t\\\n\t\t\t      ARRAY_SIZE(txpwr.data[TXPWR_MAC].rate));\t\\\n})\n\nstatic int\nmt7921_txpwr(struct seq_file *s, void *data)\n{\n\tstruct mt792x_dev *dev = dev_get_drvdata(s->private);\n\tstruct mt7921_txpwr txpwr;\n\tint ret;\n\n\tmt792x_mutex_acquire(dev);\n\tret = mt7921_get_txpwr_info(dev, &txpwr);\n\tmt792x_mutex_release(dev);\n\n\tif (ret)\n\t\treturn ret;\n\n\tseq_printf(s, \"Tx power table (channel %d)\\n\", txpwr.ch);\n\tseq_printf(s, \"%-16s  %6s %6s %6s %6s\\n\",\n\t\t   \" \", \"1m\", \"2m\", \"5m\", \"11m\");\n\tmt7921_print_txpwr_entry(CCK, cck);\n\n\tseq_printf(s, \"%-16s  %6s %6s %6s %6s %6s %6s %6s %6s\\n\",\n\t\t   \" \", \"6m\", \"9m\", \"12m\", \"18m\", \"24m\", \"36m\",\n\t\t   \"48m\", \"54m\");\n\tmt7921_print_txpwr_entry(OFDM, ofdm);\n\n\tseq_printf(s, \"%-16s  %6s %6s %6s %6s %6s %6s %6s %6s\\n\",\n\t\t   \" \", \"mcs0\", \"mcs1\", \"mcs2\", \"mcs3\", \"mcs4\", \"mcs5\",\n\t\t   \"mcs6\", \"mcs7\");\n\tmt7921_print_txpwr_entry(HT20, ht20);\n\n\tseq_printf(s, \"%-16s  %6s %6s %6s %6s %6s %6s %6s %6s %6s\\n\",\n\t\t   \" \", \"mcs0\", \"mcs1\", \"mcs2\", \"mcs3\", \"mcs4\", \"mcs5\",\n\t\t   \"mcs6\", \"mcs7\", \"mcs32\");\n\tmt7921_print_txpwr_entry(HT40, ht40);\n\n\tseq_printf(s, \"%-16s  %6s %6s %6s %6s %6s %6s %6s %6s %6s %6s %6s %6s\\n\",\n\t\t   \" \", \"mcs0\", \"mcs1\", \"mcs2\", \"mcs3\", \"mcs4\", \"mcs5\",\n\t\t   \"mcs6\", \"mcs7\", \"mcs8\", \"mcs9\", \"mcs10\", \"mcs11\");\n\tmt7921_print_txpwr_entry(VHT20, vht20);\n\tmt7921_print_txpwr_entry(VHT40, vht40);\n\tmt7921_print_txpwr_entry(VHT80, vht80);\n\tmt7921_print_txpwr_entry(VHT160, vht160);\n\tmt7921_print_txpwr_entry(HE26, he26);\n\tmt7921_print_txpwr_entry(HE52, he52);\n\tmt7921_print_txpwr_entry(HE106, he106);\n\tmt7921_print_txpwr_entry(HE242, he242);\n\tmt7921_print_txpwr_entry(HE484, he484);\n\tmt7921_print_txpwr_entry(HE996, he996);\n\tmt7921_print_txpwr_entry(HE996x2, he996x2);\n\n\treturn 0;\n}\n\nstatic int\nmt7921_pm_set(void *data, u64 val)\n{\n\tstruct mt792x_dev *dev = data;\n\tstruct mt76_connac_pm *pm = &dev->pm;\n\n\tif (mt76_is_usb(&dev->mt76))\n\t\treturn -EOPNOTSUPP;\n\n\tmutex_lock(&dev->mt76.mutex);\n\n\tif (val == pm->enable_user)\n\t\tgoto out;\n\n\tif (!pm->enable_user) {\n\t\tpm->stats.last_wake_event = jiffies;\n\t\tpm->stats.last_doze_event = jiffies;\n\t}\n\t \n\tpm->enable = false;\n\tmt76_connac_pm_wake(&dev->mphy, pm);\n\n\tpm->enable_user = val;\n\tmt7921_set_runtime_pm(dev);\n\tmt76_connac_power_save_sched(&dev->mphy, pm);\nout:\n\tmutex_unlock(&dev->mt76.mutex);\n\n\treturn 0;\n}\n\nstatic int\nmt7921_pm_get(void *data, u64 *val)\n{\n\tstruct mt792x_dev *dev = data;\n\n\t*val = dev->pm.enable_user;\n\n\treturn 0;\n}\n\nDEFINE_DEBUGFS_ATTRIBUTE(fops_pm, mt7921_pm_get, mt7921_pm_set, \"%lld\\n\");\n\nstatic int\nmt7921_deep_sleep_set(void *data, u64 val)\n{\n\tstruct mt792x_dev *dev = data;\n\tstruct mt76_connac_pm *pm = &dev->pm;\n\tbool monitor = !!(dev->mphy.hw->conf.flags & IEEE80211_CONF_MONITOR);\n\tbool enable = !!val;\n\n\tif (mt76_is_usb(&dev->mt76))\n\t\treturn -EOPNOTSUPP;\n\n\tmt792x_mutex_acquire(dev);\n\tif (pm->ds_enable_user == enable)\n\t\tgoto out;\n\n\tpm->ds_enable_user = enable;\n\tpm->ds_enable = enable && !monitor;\n\tmt76_connac_mcu_set_deep_sleep(&dev->mt76, pm->ds_enable);\nout:\n\tmt792x_mutex_release(dev);\n\n\treturn 0;\n}\n\nstatic int\nmt7921_deep_sleep_get(void *data, u64 *val)\n{\n\tstruct mt792x_dev *dev = data;\n\n\t*val = dev->pm.ds_enable_user;\n\n\treturn 0;\n}\n\nDEFINE_DEBUGFS_ATTRIBUTE(fops_ds, mt7921_deep_sleep_get,\n\t\t\t mt7921_deep_sleep_set, \"%lld\\n\");\n\nDEFINE_DEBUGFS_ATTRIBUTE(fops_pm_idle_timeout, mt792x_pm_idle_timeout_get,\n\t\t\t mt792x_pm_idle_timeout_set, \"%lld\\n\");\n\nstatic int mt7921_chip_reset(void *data, u64 val)\n{\n\tstruct mt792x_dev *dev = data;\n\tint ret = 0;\n\n\tswitch (val) {\n\tcase 1:\n\t\t \n\t\tmt792x_reset(&dev->mt76);\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tmt792x_mutex_acquire(dev);\n\t\tret = mt76_connac_mcu_chip_config(&dev->mt76);\n\t\tmt792x_mutex_release(dev);\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nDEFINE_DEBUGFS_ATTRIBUTE(fops_reset, NULL, mt7921_chip_reset, \"%lld\\n\");\n\nstatic int\nmt7921s_sched_quota_read(struct seq_file *s, void *data)\n{\n\tstruct mt792x_dev *dev = dev_get_drvdata(s->private);\n\tstruct mt76_sdio *sdio = &dev->mt76.sdio;\n\n\tseq_printf(s, \"pse_data_quota\\t%d\\n\", sdio->sched.pse_data_quota);\n\tseq_printf(s, \"ple_data_quota\\t%d\\n\", sdio->sched.ple_data_quota);\n\tseq_printf(s, \"pse_mcu_quota\\t%d\\n\", sdio->sched.pse_mcu_quota);\n\tseq_printf(s, \"sched_deficit\\t%d\\n\", sdio->sched.deficit);\n\n\treturn 0;\n}\n\nint mt7921_init_debugfs(struct mt792x_dev *dev)\n{\n\tstruct dentry *dir;\n\n\tdir = mt76_register_debugfs_fops(&dev->mphy, &fops_regval);\n\tif (!dir)\n\t\treturn -ENOMEM;\n\n\tif (mt76_is_mmio(&dev->mt76))\n\t\tdebugfs_create_devm_seqfile(dev->mt76.dev, \"xmit-queues\",\n\t\t\t\t\t    dir, mt792x_queues_read);\n\telse\n\t\tdebugfs_create_devm_seqfile(dev->mt76.dev, \"xmit-queues\",\n\t\t\t\t\t    dir, mt76_queues_read);\n\n\tdebugfs_create_devm_seqfile(dev->mt76.dev, \"acq\", dir,\n\t\t\t\t    mt792x_queues_acq);\n\tdebugfs_create_devm_seqfile(dev->mt76.dev, \"txpower_sku\", dir,\n\t\t\t\t    mt7921_txpwr);\n\tdebugfs_create_file(\"tx_stats\", 0400, dir, dev, &mt792x_tx_stats_fops);\n\tdebugfs_create_file(\"fw_debug\", 0600, dir, dev, &fops_fw_debug);\n\tdebugfs_create_file(\"runtime-pm\", 0600, dir, dev, &fops_pm);\n\tdebugfs_create_file(\"idle-timeout\", 0600, dir, dev,\n\t\t\t    &fops_pm_idle_timeout);\n\tdebugfs_create_file(\"chip_reset\", 0600, dir, dev, &fops_reset);\n\tdebugfs_create_devm_seqfile(dev->mt76.dev, \"runtime_pm_stats\", dir,\n\t\t\t\t    mt792x_pm_stats);\n\tdebugfs_create_file(\"deep-sleep\", 0600, dir, dev, &fops_ds);\n\tif (mt76_is_sdio(&dev->mt76))\n\t\tdebugfs_create_devm_seqfile(dev->mt76.dev, \"sched-quota\", dir,\n\t\t\t\t\t    mt7921s_sched_quota_read);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}