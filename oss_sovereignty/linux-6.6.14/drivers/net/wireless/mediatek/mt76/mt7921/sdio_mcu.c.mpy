{
  "module_name": "sdio_mcu.c",
  "hash_id": "35189e0b16bc50e582fb6a07101b95f63d47a5ee551c05300befa0d30640a622",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7921/sdio_mcu.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/mmc/sdio_func.h>\n#include <linux/module.h>\n#include <linux/iopoll.h>\n\n#include \"mt7921.h\"\n#include \"../sdio.h\"\n#include \"../mt76_connac2_mac.h\"\n#include \"mcu.h\"\n#include \"regs.h\"\n\nstatic int\nmt7921s_mcu_send_message(struct mt76_dev *mdev, struct sk_buff *skb,\n\t\t\t int cmd, int *seq)\n{\n\tstruct mt792x_dev *dev = container_of(mdev, struct mt792x_dev, mt76);\n\tenum mt7921_sdio_pkt_type type = MT7921_SDIO_CMD;\n\tenum mt76_mcuq_id txq = MT_MCUQ_WM;\n\tint ret, pad;\n\n\t \n\tif (dev->fw_assert)\n\t\treturn -EBUSY;\n\n\tret = mt76_connac2_mcu_fill_message(mdev, skb, cmd, seq);\n\tif (ret)\n\t\treturn ret;\n\n\tmdev->mcu.timeout = 3 * HZ;\n\n\tif (cmd == MCU_CMD(FW_SCATTER))\n\t\ttype = MT7921_SDIO_FWDL;\n\n\tmt7921_skb_add_usb_sdio_hdr(dev, skb, type);\n\tpad = round_up(skb->len, 4) - skb->len;\n\t__skb_put_zero(skb, pad);\n\n\tret = mt76_tx_queue_skb_raw(dev, mdev->q_mcu[txq], skb, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tmt76_queue_kick(dev, mdev->q_mcu[txq]);\n\n\treturn ret;\n}\n\nstatic u32 mt7921s_read_rm3r(struct mt792x_dev *dev)\n{\n\tstruct mt76_sdio *sdio = &dev->mt76.sdio;\n\n\treturn sdio_readl(sdio->func, MCR_D2HRM3R, NULL);\n}\n\nstatic u32 mt7921s_clear_rm3r_drv_own(struct mt792x_dev *dev)\n{\n\tstruct mt76_sdio *sdio = &dev->mt76.sdio;\n\tu32 val;\n\n\tval = sdio_readl(sdio->func, MCR_D2HRM3R, NULL);\n\tif (val)\n\t\tsdio_writel(sdio->func, H2D_SW_INT_CLEAR_MAILBOX_ACK,\n\t\t\t    MCR_WSICR, NULL);\n\n\treturn val;\n}\n\nint mt7921s_mcu_init(struct mt792x_dev *dev)\n{\n\tstatic const struct mt76_mcu_ops mt7921s_mcu_ops = {\n\t\t.headroom = MT_SDIO_HDR_SIZE +\n\t\t\t    sizeof(struct mt76_connac2_mcu_txd),\n\t\t.tailroom = MT_SDIO_TAIL_SIZE,\n\t\t.mcu_skb_send_msg = mt7921s_mcu_send_message,\n\t\t.mcu_parse_response = mt7921_mcu_parse_response,\n\t\t.mcu_rr = mt76_connac_mcu_reg_rr,\n\t\t.mcu_wr = mt76_connac_mcu_reg_wr,\n\t};\n\tint ret;\n\n\tmt7921s_mcu_drv_pmctrl(dev);\n\n\tdev->mt76.mcu_ops = &mt7921s_mcu_ops;\n\n\tret = mt7921_run_firmware(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tset_bit(MT76_STATE_MCU_RUNNING, &dev->mphy.state);\n\n\treturn 0;\n}\n\nint mt7921s_mcu_drv_pmctrl(struct mt792x_dev *dev)\n{\n\tstruct sdio_func *func = dev->mt76.sdio.func;\n\tstruct mt76_phy *mphy = &dev->mt76.phy;\n\tstruct mt76_connac_pm *pm = &dev->pm;\n\tu32 status;\n\tint err;\n\n\tsdio_claim_host(func);\n\n\tsdio_writel(func, WHLPCR_FW_OWN_REQ_CLR, MCR_WHLPCR, NULL);\n\n\terr = readx_poll_timeout(mt76s_read_pcr, &dev->mt76, status,\n\t\t\t\t status & WHLPCR_IS_DRIVER_OWN, 2000, 1000000);\n\n\tif (!err && test_bit(MT76_STATE_MCU_RUNNING, &dev->mphy.state))\n\t\terr = readx_poll_timeout(mt7921s_read_rm3r, dev, status,\n\t\t\t\t\t status & D2HRM3R_IS_DRIVER_OWN,\n\t\t\t\t\t 2000, 1000000);\n\n\tsdio_release_host(func);\n\n\tif (err < 0) {\n\t\tdev_err(dev->mt76.dev, \"driver own failed\\n\");\n\t\treturn -EIO;\n\t}\n\n\tclear_bit(MT76_STATE_PM, &mphy->state);\n\n\tpm->stats.last_wake_event = jiffies;\n\tpm->stats.doze_time += pm->stats.last_wake_event -\n\t\t\t       pm->stats.last_doze_event;\n\n\treturn 0;\n}\n\nint mt7921s_mcu_fw_pmctrl(struct mt792x_dev *dev)\n{\n\tstruct sdio_func *func = dev->mt76.sdio.func;\n\tstruct mt76_phy *mphy = &dev->mt76.phy;\n\tstruct mt76_connac_pm *pm = &dev->pm;\n\tu32 status;\n\tint err;\n\n\tsdio_claim_host(func);\n\n\tif (test_bit(MT76_STATE_MCU_RUNNING, &dev->mphy.state)) {\n\t\terr = readx_poll_timeout(mt7921s_clear_rm3r_drv_own,\n\t\t\t\t\t dev, status,\n\t\t\t\t\t !(status & D2HRM3R_IS_DRIVER_OWN),\n\t\t\t\t\t 2000, 1000000);\n\t\tif (err < 0) {\n\t\t\tdev_err(dev->mt76.dev, \"mailbox ACK not cleared\\n\");\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tsdio_writel(func, WHLPCR_FW_OWN_REQ_SET, MCR_WHLPCR, NULL);\n\n\terr = readx_poll_timeout(mt76s_read_pcr, &dev->mt76, status,\n\t\t\t\t !(status & WHLPCR_IS_DRIVER_OWN), 2000, 1000000);\nout:\n\tsdio_release_host(func);\n\n\tif (err < 0) {\n\t\tdev_err(dev->mt76.dev, \"firmware own failed\\n\");\n\t\tclear_bit(MT76_STATE_PM, &mphy->state);\n\t\treturn -EIO;\n\t}\n\n\tpm->stats.last_doze_event = jiffies;\n\tpm->stats.awake_time += pm->stats.last_doze_event -\n\t\t\t\tpm->stats.last_wake_event;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}