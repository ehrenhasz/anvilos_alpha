{
  "module_name": "testmode.c",
  "hash_id": "114c436969453a502277c223462bc77956f64057fec1381660fce609e2a120b5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7921/testmode.c",
  "human_readable_source": "\n\n#include \"mt7921.h\"\n#include \"mcu.h\"\n\nenum mt7921_testmode_attr {\n\tMT7921_TM_ATTR_UNSPEC,\n\tMT7921_TM_ATTR_SET,\n\tMT7921_TM_ATTR_QUERY,\n\tMT7921_TM_ATTR_RSP,\n\n\t \n\tNUM_MT7921_TM_ATTRS,\n\tMT7921_TM_ATTR_MAX = NUM_MT7921_TM_ATTRS - 1,\n};\n\nstruct mt7921_tm_cmd {\n\tu8 action;\n\tu32 param0;\n\tu32 param1;\n};\n\nstruct mt7921_tm_evt {\n\tu32 param0;\n\tu32 param1;\n};\n\nstatic const struct nla_policy mt7921_tm_policy[NUM_MT7921_TM_ATTRS] = {\n\t[MT7921_TM_ATTR_SET] = NLA_POLICY_EXACT_LEN(sizeof(struct mt7921_tm_cmd)),\n\t[MT7921_TM_ATTR_QUERY] = NLA_POLICY_EXACT_LEN(sizeof(struct mt7921_tm_cmd)),\n};\n\nstatic int\nmt7921_tm_set(struct mt792x_dev *dev, struct mt7921_tm_cmd *req)\n{\n\tstruct mt7921_rftest_cmd cmd = {\n\t\t.action = req->action,\n\t\t.param0 = cpu_to_le32(req->param0),\n\t\t.param1 = cpu_to_le32(req->param1),\n\t};\n\tbool testmode = false, normal = false;\n\tstruct mt76_connac_pm *pm = &dev->pm;\n\tstruct mt76_phy *phy = &dev->mphy;\n\tint ret = -ENOTCONN;\n\n\tmutex_lock(&dev->mt76.mutex);\n\n\tif (req->action == TM_SWITCH_MODE) {\n\t\tif (req->param0 == MT7921_TM_NORMAL)\n\t\t\tnormal = true;\n\t\telse\n\t\t\ttestmode = true;\n\t}\n\n\tif (testmode) {\n\t\t \n\t\tpm->enable = false;\n\t\tcancel_delayed_work_sync(&pm->ps_work);\n\t\tcancel_work_sync(&pm->wake_work);\n\t\t__mt792x_mcu_drv_pmctrl(dev);\n\n\t\tphy->test.state = MT76_TM_STATE_ON;\n\t}\n\n\tif (!mt76_testmode_enabled(phy))\n\t\tgoto out;\n\n\tret = mt76_mcu_send_msg(&dev->mt76, MCU_CE_CMD(TEST_CTRL), &cmd,\n\t\t\t\tsizeof(cmd), false);\n\tif (ret)\n\t\tgoto out;\n\n\tif (normal) {\n\t\t \n\t\tphy->test.state = MT76_TM_STATE_OFF;\n\t\tpm->enable = true;\n\t}\nout:\n\tmutex_unlock(&dev->mt76.mutex);\n\n\treturn ret;\n}\n\nstatic int\nmt7921_tm_query(struct mt792x_dev *dev, struct mt7921_tm_cmd *req,\n\t\tstruct mt7921_tm_evt *evt_resp)\n{\n\tstruct mt7921_rftest_cmd cmd = {\n\t\t.action = req->action,\n\t\t.param0 = cpu_to_le32(req->param0),\n\t\t.param1 = cpu_to_le32(req->param1),\n\t};\n\tstruct mt7921_rftest_evt *evt;\n\tstruct sk_buff *skb;\n\tint ret;\n\n\tret = mt76_mcu_send_and_get_msg(&dev->mt76, MCU_CE_CMD(TEST_CTRL),\n\t\t\t\t\t&cmd, sizeof(cmd), true, &skb);\n\tif (ret)\n\t\tgoto out;\n\n\tevt = (struct mt7921_rftest_evt *)skb->data;\n\tevt_resp->param0 = le32_to_cpu(evt->param0);\n\tevt_resp->param1 = le32_to_cpu(evt->param1);\nout:\n\tdev_kfree_skb(skb);\n\n\treturn ret;\n}\n\nint mt7921_testmode_cmd(struct ieee80211_hw *hw, struct ieee80211_vif *vif,\n\t\t\tvoid *data, int len)\n{\n\tstruct nlattr *tb[NUM_MT76_TM_ATTRS];\n\tstruct mt76_phy *mphy = hw->priv;\n\tstruct mt792x_phy *phy = mphy->priv;\n\tint err;\n\n\tif (!test_bit(MT76_STATE_RUNNING, &mphy->state) ||\n\t    !(hw->conf.flags & IEEE80211_CONF_MONITOR))\n\t\treturn -ENOTCONN;\n\n\terr = nla_parse_deprecated(tb, MT76_TM_ATTR_MAX, data, len,\n\t\t\t\t   mt76_tm_policy, NULL);\n\tif (err)\n\t\treturn err;\n\n\tif (tb[MT76_TM_ATTR_DRV_DATA]) {\n\t\tstruct nlattr *drv_tb[NUM_MT7921_TM_ATTRS], *data;\n\t\tint ret;\n\n\t\tdata = tb[MT76_TM_ATTR_DRV_DATA];\n\t\tret = nla_parse_nested_deprecated(drv_tb,\n\t\t\t\t\t\t  MT7921_TM_ATTR_MAX,\n\t\t\t\t\t\t  data, mt7921_tm_policy,\n\t\t\t\t\t\t  NULL);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tdata = drv_tb[MT7921_TM_ATTR_SET];\n\t\tif (data)\n\t\t\treturn mt7921_tm_set(phy->dev, nla_data(data));\n\t}\n\n\treturn -EINVAL;\n}\n\nint mt7921_testmode_dump(struct ieee80211_hw *hw, struct sk_buff *msg,\n\t\t\t struct netlink_callback *cb, void *data, int len)\n{\n\tstruct nlattr *tb[NUM_MT76_TM_ATTRS];\n\tstruct mt76_phy *mphy = hw->priv;\n\tstruct mt792x_phy *phy = mphy->priv;\n\tint err;\n\n\tif (!test_bit(MT76_STATE_RUNNING, &mphy->state) ||\n\t    !(hw->conf.flags & IEEE80211_CONF_MONITOR) ||\n\t    !mt76_testmode_enabled(mphy))\n\t\treturn -ENOTCONN;\n\n\tif (cb->args[2]++ > 0)\n\t\treturn -ENOENT;\n\n\terr = nla_parse_deprecated(tb, MT76_TM_ATTR_MAX, data, len,\n\t\t\t\t   mt76_tm_policy, NULL);\n\tif (err)\n\t\treturn err;\n\n\tif (tb[MT76_TM_ATTR_DRV_DATA]) {\n\t\tstruct nlattr *drv_tb[NUM_MT7921_TM_ATTRS], *data;\n\t\tint ret;\n\n\t\tdata = tb[MT76_TM_ATTR_DRV_DATA];\n\t\tret = nla_parse_nested_deprecated(drv_tb,\n\t\t\t\t\t\t  MT7921_TM_ATTR_MAX,\n\t\t\t\t\t\t  data, mt7921_tm_policy,\n\t\t\t\t\t\t  NULL);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tdata = drv_tb[MT7921_TM_ATTR_QUERY];\n\t\tif (data) {\n\t\t\tstruct mt7921_tm_evt evt_resp;\n\n\t\t\terr = mt7921_tm_query(phy->dev, nla_data(data),\n\t\t\t\t\t      &evt_resp);\n\t\t\tif (err)\n\t\t\t\treturn err;\n\n\t\t\treturn nla_put(msg, MT7921_TM_ATTR_RSP,\n\t\t\t\t       sizeof(evt_resp), &evt_resp);\n\t\t}\n\t}\n\n\treturn -EINVAL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}