{
  "module_name": "pci_mcu.c",
  "hash_id": "2c4706cbe2a7cba7b7f47535f784bc65a24161ba461136fe7d162b172eb3264b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt76x0/pci_mcu.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/firmware.h>\n\n#include \"mt76x0.h\"\n#include \"mcu.h\"\n\n#define MT_MCU_IVB_ADDR\t\t(MT_MCU_ILM_ADDR + 0x54000 - MT_MCU_IVB_SIZE)\n\nstatic int mt76x0e_load_firmware(struct mt76x02_dev *dev)\n{\n\tbool is_combo_chip = mt76_chip(&dev->mt76) != 0x7610;\n\tu32 val, ilm_len, dlm_len, offset = 0;\n\tconst struct mt76x02_fw_header *hdr;\n\tconst struct firmware *fw;\n\tconst char *firmware;\n\tconst u8 *fw_payload;\n\tint len, err;\n\n\tif (is_combo_chip)\n\t\tfirmware = MT7650E_FIRMWARE;\n\telse\n\t\tfirmware = MT7610E_FIRMWARE;\n\n\terr = request_firmware(&fw, firmware, dev->mt76.dev);\n\tif (err)\n\t\treturn err;\n\n\tif (!fw || !fw->data || fw->size < sizeof(*hdr)) {\n\t\terr = -EIO;\n\t\tgoto out;\n\t}\n\n\thdr = (const struct mt76x02_fw_header *)fw->data;\n\n\tlen = sizeof(*hdr);\n\tlen += le32_to_cpu(hdr->ilm_len);\n\tlen += le32_to_cpu(hdr->dlm_len);\n\n\tif (fw->size != len) {\n\t\terr = -EIO;\n\t\tgoto out;\n\t}\n\n\tfw_payload = fw->data + sizeof(*hdr);\n\n\tval = le16_to_cpu(hdr->fw_ver);\n\tdev_info(dev->mt76.dev, \"Firmware Version: %d.%d.%02d\\n\",\n\t\t (val >> 12) & 0xf, (val >> 8) & 0xf, val & 0xf);\n\n\tval = le16_to_cpu(hdr->fw_ver);\n\tdev_dbg(dev->mt76.dev,\n\t\t\"Firmware Version: %d.%d.%02d Build: %x Build time: %.16s\\n\",\n\t\t(val >> 12) & 0xf, (val >> 8) & 0xf, val & 0xf,\n\t\tle16_to_cpu(hdr->build_ver), hdr->build_time);\n\n\tif (is_combo_chip && !mt76_poll(dev, MT_MCU_SEMAPHORE_00, 1, 1, 600)) {\n\t\tdev_err(dev->mt76.dev,\n\t\t\t\"Could not get hardware semaphore for loading fw\\n\");\n\t\terr = -ETIMEDOUT;\n\t\tgoto out;\n\t}\n\n\t \n\tmt76_wr(dev, MT_MCU_PCIE_REMAP_BASE4, 0);\n\tilm_len = le32_to_cpu(hdr->ilm_len);\n\tif (is_combo_chip) {\n\t\tilm_len -= MT_MCU_IVB_SIZE;\n\t\toffset = MT_MCU_IVB_SIZE;\n\t}\n\tdev_dbg(dev->mt76.dev, \"loading FW - ILM %u\\n\", ilm_len);\n\tmt76_wr_copy(dev, MT_MCU_ILM_ADDR + offset, fw_payload + offset,\n\t\t     ilm_len);\n\n\t \n\tif (is_combo_chip) {\n\t\tdev_dbg(dev->mt76.dev, \"loading FW - IVB %u\\n\",\n\t\t\tMT_MCU_IVB_SIZE);\n\t\tmt76_wr_copy(dev, MT_MCU_IVB_ADDR, fw_payload, MT_MCU_IVB_SIZE);\n\t}\n\n\t \n\tmt76_wr(dev, MT_MCU_PCIE_REMAP_BASE4, MT_MCU_DLM_OFFSET);\n\tdlm_len = le32_to_cpu(hdr->dlm_len);\n\tdev_dbg(dev->mt76.dev, \"loading FW - DLM %u\\n\", dlm_len);\n\tmt76_wr_copy(dev, MT_MCU_ILM_ADDR,\n\t\t     fw_payload + le32_to_cpu(hdr->ilm_len), dlm_len);\n\n\t \n\tmt76_wr(dev, MT_MCU_PCIE_REMAP_BASE4, 0);\n\tif (is_combo_chip)\n\t\tmt76_wr(dev, MT_MCU_INT_LEVEL, 0x3);\n\telse\n\t\tmt76_wr(dev, MT_MCU_RESET_CTL, 0x300);\n\n\tif (!mt76_poll_msec(dev, MT_MCU_COM_REG0, 1, 1, 1000)) {\n\t\tdev_err(dev->mt76.dev, \"Firmware failed to start\\n\");\n\t\terr = -ETIMEDOUT;\n\t\tgoto out;\n\t}\n\n\tmt76x02_set_ethtool_fwver(dev, hdr);\n\tdev_dbg(dev->mt76.dev, \"Firmware running!\\n\");\n\nout:\n\tif (is_combo_chip)\n\t\tmt76_wr(dev, MT_MCU_SEMAPHORE_00, 0x1);\n\trelease_firmware(fw);\n\n\treturn err;\n}\n\nint mt76x0e_mcu_init(struct mt76x02_dev *dev)\n{\n\tstatic const struct mt76_mcu_ops mt76x0e_mcu_ops = {\n\t\t.mcu_send_msg = mt76x02_mcu_msg_send,\n\t\t.mcu_parse_response = mt76x02_mcu_parse_response,\n\t};\n\tint err;\n\n\tdev->mt76.mcu_ops = &mt76x0e_mcu_ops;\n\n\terr = mt76x0e_load_firmware(dev);\n\tif (err < 0)\n\t\treturn err;\n\n\tset_bit(MT76_STATE_MCU_RUNNING, &dev->mphy.state);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}