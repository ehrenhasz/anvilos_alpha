{
  "module_name": "usb_mcu.c",
  "hash_id": "1adc317a226684a6cce45272a3ed543c36116e733e3fe2800c331967cb9875a8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt76x0/usb_mcu.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/firmware.h>\n#include <linux/module.h>\n\n#include \"mt76x0.h\"\n#include \"mcu.h\"\n#include \"../mt76x02_usb.h\"\n\n#define MCU_FW_URB_MAX_PAYLOAD\t\t0x38f8\n#define MCU_FW_URB_SIZE\t\t\t(MCU_FW_URB_MAX_PAYLOAD + 12)\n\nstatic int\nmt76x0u_upload_firmware(struct mt76x02_dev *dev,\n\t\t\tconst struct mt76x02_fw_header *hdr)\n{\n\tu8 *fw_payload = (u8 *)(hdr + 1);\n\tu32 ilm_len, dlm_len;\n\tvoid *ivb;\n\tint err;\n\n\tivb = kmemdup(fw_payload, MT_MCU_IVB_SIZE, GFP_KERNEL);\n\tif (!ivb)\n\t\treturn -ENOMEM;\n\n\tilm_len = le32_to_cpu(hdr->ilm_len) - MT_MCU_IVB_SIZE;\n\tdev_dbg(dev->mt76.dev, \"loading FW - ILM %u + IVB %u\\n\",\n\t\tilm_len, MT_MCU_IVB_SIZE);\n\terr = mt76x02u_mcu_fw_send_data(dev, fw_payload + MT_MCU_IVB_SIZE,\n\t\t\t\t\tilm_len, MCU_FW_URB_MAX_PAYLOAD,\n\t\t\t\t\tMT_MCU_IVB_SIZE);\n\tif (err)\n\t\tgoto out;\n\n\tdlm_len = le32_to_cpu(hdr->dlm_len);\n\tdev_dbg(dev->mt76.dev, \"loading FW - DLM %u\\n\", dlm_len);\n\terr = mt76x02u_mcu_fw_send_data(dev,\n\t\t\t\t\tfw_payload + le32_to_cpu(hdr->ilm_len),\n\t\t\t\t\tdlm_len, MCU_FW_URB_MAX_PAYLOAD,\n\t\t\t\t\tMT_MCU_DLM_OFFSET);\n\tif (err)\n\t\tgoto out;\n\n\terr = mt76u_vendor_request(&dev->mt76, MT_VEND_DEV_MODE,\n\t\t\t\t   USB_DIR_OUT | USB_TYPE_VENDOR,\n\t\t\t\t   0x12, 0, ivb, MT_MCU_IVB_SIZE);\n\tif (err < 0)\n\t\tgoto out;\n\n\tif (!mt76_poll_msec(dev, MT_MCU_COM_REG0, 1, 1, 1000)) {\n\t\tdev_err(dev->mt76.dev, \"Firmware failed to start\\n\");\n\t\terr = -ETIMEDOUT;\n\t\tgoto out;\n\t}\n\n\tdev_dbg(dev->mt76.dev, \"Firmware running!\\n\");\n\nout:\n\tkfree(ivb);\n\n\treturn err;\n}\n\nstatic int mt76x0_get_firmware(struct mt76x02_dev *dev,\n\t\t\t       const struct firmware **fw)\n{\n\tint err;\n\n\t \n\terr = firmware_request_nowarn(fw, MT7610E_FIRMWARE, dev->mt76.dev);\n\tif (err) {\n\t\tdev_info(dev->mt76.dev, \"%s not found, switching to %s\",\n\t\t\t MT7610E_FIRMWARE, MT7610U_FIRMWARE);\n\t\treturn request_firmware(fw, MT7610U_FIRMWARE,\n\t\t\t\t\tdev->mt76.dev);\n\t}\n\treturn 0;\n}\n\nstatic int mt76x0u_load_firmware(struct mt76x02_dev *dev)\n{\n\tconst struct firmware *fw;\n\tconst struct mt76x02_fw_header *hdr;\n\tint len, ret;\n\tu32 val;\n\n\tmt76_wr(dev, MT_USB_DMA_CFG, (MT_USB_DMA_CFG_RX_BULK_EN |\n\t\t\t\t      MT_USB_DMA_CFG_TX_BULK_EN));\n\n\tif (mt76x0_firmware_running(dev))\n\t\treturn 0;\n\n\tret = mt76x0_get_firmware(dev, &fw);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!fw || !fw->data || fw->size < sizeof(*hdr))\n\t\tgoto err_inv_fw;\n\n\thdr = (const struct mt76x02_fw_header *)fw->data;\n\n\tif (le32_to_cpu(hdr->ilm_len) <= MT_MCU_IVB_SIZE)\n\t\tgoto err_inv_fw;\n\n\tlen = sizeof(*hdr);\n\tlen += le32_to_cpu(hdr->ilm_len);\n\tlen += le32_to_cpu(hdr->dlm_len);\n\n\tif (fw->size != len)\n\t\tgoto err_inv_fw;\n\n\tval = le16_to_cpu(hdr->fw_ver);\n\tdev_dbg(dev->mt76.dev,\n\t\t\"Firmware Version: %d.%d.%02d Build: %x Build time: %.16s\\n\",\n\t\t(val >> 12) & 0xf, (val >> 8) & 0xf, val & 0xf,\n\t\tle16_to_cpu(hdr->build_ver), hdr->build_time);\n\n\tlen = le32_to_cpu(hdr->ilm_len);\n\n\tmt76_wr(dev, 0x1004, 0x2c);\n\n\tmt76_set(dev, MT_USB_DMA_CFG,\n\t\t (MT_USB_DMA_CFG_RX_BULK_EN | MT_USB_DMA_CFG_TX_BULK_EN) |\n\t\t FIELD_PREP(MT_USB_DMA_CFG_RX_BULK_AGG_TOUT, 0x20));\n\tmt76x02u_mcu_fw_reset(dev);\n\tusleep_range(5000, 6000);\n\n\tmt76_wr(dev, MT_FCE_PSE_CTRL, 1);\n\n\t \n\tmt76_wr(dev, MT_TX_CPU_FROM_FCE_BASE_PTR, 0x400230);\n\t \n\tmt76_wr(dev, MT_TX_CPU_FROM_FCE_MAX_COUNT, 1);\n\t \n\tmt76_wr(dev, MT_FCE_PDMA_GLOBAL_CONF, 0x44);\n\t \n\tmt76_wr(dev, MT_FCE_SKIP_FS, 3);\n\n\tval = mt76_rr(dev, MT_USB_DMA_CFG);\n\tval |= MT_USB_DMA_CFG_UDMA_TX_WL_DROP;\n\tmt76_wr(dev, MT_USB_DMA_CFG, val);\n\tval &= ~MT_USB_DMA_CFG_UDMA_TX_WL_DROP;\n\tmt76_wr(dev, MT_USB_DMA_CFG, val);\n\n\tret = mt76x0u_upload_firmware(dev, hdr);\n\tmt76x02_set_ethtool_fwver(dev, hdr);\n\trelease_firmware(fw);\n\n\tmt76_wr(dev, MT_FCE_PSE_CTRL, 1);\n\n\treturn ret;\n\nerr_inv_fw:\n\tdev_err(dev->mt76.dev, \"Invalid firmware image\\n\");\n\trelease_firmware(fw);\n\treturn -ENOENT;\n}\n\nint mt76x0u_mcu_init(struct mt76x02_dev *dev)\n{\n\tint ret;\n\n\tret = mt76x0u_load_firmware(dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tset_bit(MT76_STATE_MCU_RUNNING, &dev->mphy.state);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}