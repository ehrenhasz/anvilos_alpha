{
  "module_name": "eeprom.c",
  "hash_id": "7a7588a22144dad5ae77fe105e540981ff81e99e1bb10cececb7b64612b9d13a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7996/eeprom.c",
  "human_readable_source": "\n \n\n#include <linux/firmware.h>\n#include \"mt7996.h\"\n#include \"eeprom.h\"\n\nstatic int mt7996_check_eeprom(struct mt7996_dev *dev)\n{\n\tu8 *eeprom = dev->mt76.eeprom.data;\n\tu16 val = get_unaligned_le16(eeprom);\n\n\tswitch (val) {\n\tcase 0x7990:\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic char *mt7996_eeprom_name(struct mt7996_dev *dev)\n{\n\t \n\treturn MT7996_EEPROM_DEFAULT;\n}\n\nstatic int\nmt7996_eeprom_load_default(struct mt7996_dev *dev)\n{\n\tu8 *eeprom = dev->mt76.eeprom.data;\n\tconst struct firmware *fw = NULL;\n\tint ret;\n\n\tret = request_firmware(&fw, mt7996_eeprom_name(dev), dev->mt76.dev);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!fw || !fw->data) {\n\t\tdev_err(dev->mt76.dev, \"Invalid default bin\\n\");\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tmemcpy(eeprom, fw->data, MT7996_EEPROM_SIZE);\n\tdev->flash_mode = true;\n\nout:\n\trelease_firmware(fw);\n\n\treturn ret;\n}\n\nstatic int mt7996_eeprom_load(struct mt7996_dev *dev)\n{\n\tint ret;\n\n\tret = mt76_eeprom_init(&dev->mt76, MT7996_EEPROM_SIZE);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (ret) {\n\t\tdev->flash_mode = true;\n\t} else {\n\t\tu8 free_block_num;\n\t\tu32 block_num, i;\n\t\tu32 eeprom_blk_size = MT7996_EEPROM_BLOCK_SIZE;\n\n\t\tret = mt7996_mcu_get_eeprom_free_block(dev, &free_block_num);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\t \n\t\tif (free_block_num >= 59)\n\t\t\treturn -EINVAL;\n\n\t\t \n\t\tblock_num = DIV_ROUND_UP(MT7996_EEPROM_SIZE, eeprom_blk_size);\n\t\tfor (i = 0; i < block_num; i++) {\n\t\t\tret = mt7996_mcu_get_eeprom(dev, i * eeprom_blk_size);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn mt7996_check_eeprom(dev);\n}\n\nstatic int mt7996_eeprom_parse_efuse_hw_cap(struct mt7996_dev *dev)\n{\n#define MODE_HE_ONLY\t\tBIT(0)\n#define WTBL_SIZE_GROUP\t\tGENMASK(31, 28)\n\tu32 cap = 0;\n\tint ret;\n\n\tret = mt7996_mcu_get_chip_config(dev, &cap);\n\tif (ret)\n\t\treturn ret;\n\n\tif (cap) {\n\t\tdev->has_eht = !(cap & MODE_HE_ONLY);\n\t\tdev->wtbl_size_group = u32_get_bits(cap, WTBL_SIZE_GROUP);\n\t}\n\n\tif (dev->wtbl_size_group < 2 || dev->wtbl_size_group > 4)\n\t\tdev->wtbl_size_group = 2;  \n\n\treturn 0;\n}\n\nstatic int mt7996_eeprom_parse_band_config(struct mt7996_phy *phy)\n{\n\tu8 *eeprom = phy->dev->mt76.eeprom.data;\n\tu32 val = eeprom[MT_EE_WIFI_CONF];\n\tint ret = 0;\n\n\tswitch (phy->mt76->band_idx) {\n\tcase MT_BAND1:\n\t\tval = FIELD_GET(MT_EE_WIFI_CONF1_BAND_SEL, val);\n\t\tbreak;\n\tcase MT_BAND2:\n\t\tval = eeprom[MT_EE_WIFI_CONF + 1];\n\t\tval = FIELD_GET(MT_EE_WIFI_CONF2_BAND_SEL, val);\n\t\tbreak;\n\tdefault:\n\t\tval = FIELD_GET(MT_EE_WIFI_CONF0_BAND_SEL, val);\n\t\tbreak;\n\t}\n\n\tswitch (val) {\n\tcase MT_EE_BAND_SEL_2GHZ:\n\t\tphy->mt76->cap.has_2ghz = true;\n\t\tbreak;\n\tcase MT_EE_BAND_SEL_5GHZ:\n\t\tphy->mt76->cap.has_5ghz = true;\n\t\tbreak;\n\tcase MT_EE_BAND_SEL_6GHZ:\n\t\tphy->mt76->cap.has_6ghz = true;\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nint mt7996_eeprom_parse_hw_cap(struct mt7996_dev *dev, struct mt7996_phy *phy)\n{\n\tu8 path, nss, band_idx = phy->mt76->band_idx;\n\tu8 *eeprom = dev->mt76.eeprom.data;\n\tstruct mt76_phy *mphy = phy->mt76;\n\tint ret;\n\n\tswitch (band_idx) {\n\tcase MT_BAND1:\n\t\tpath = FIELD_GET(MT_EE_WIFI_CONF2_TX_PATH_BAND1,\n\t\t\t\t eeprom[MT_EE_WIFI_CONF + 2]);\n\t\tnss = FIELD_GET(MT_EE_WIFI_CONF5_STREAM_NUM_BAND1,\n\t\t\t\teeprom[MT_EE_WIFI_CONF + 5]);\n\t\tbreak;\n\tcase MT_BAND2:\n\t\tpath = FIELD_GET(MT_EE_WIFI_CONF2_TX_PATH_BAND2,\n\t\t\t\t eeprom[MT_EE_WIFI_CONF + 2]);\n\t\tnss = FIELD_GET(MT_EE_WIFI_CONF5_STREAM_NUM_BAND2,\n\t\t\t\teeprom[MT_EE_WIFI_CONF + 5]);\n\t\tbreak;\n\tdefault:\n\t\tpath = FIELD_GET(MT_EE_WIFI_CONF1_TX_PATH_BAND0,\n\t\t\t\t eeprom[MT_EE_WIFI_CONF + 1]);\n\t\tnss = FIELD_GET(MT_EE_WIFI_CONF4_STREAM_NUM_BAND0,\n\t\t\t\teeprom[MT_EE_WIFI_CONF + 4]);\n\t\tbreak;\n\t}\n\n\tif (!path || path > 4)\n\t\tpath = 4;\n\n\tnss = min_t(u8, min_t(u8, 4, nss), path);\n\n\tmphy->antenna_mask = BIT(nss) - 1;\n\tmphy->chainmask = (BIT(path) - 1) << dev->chainshift[band_idx];\n\tdev->chainmask |= mphy->chainmask;\n\tif (band_idx < MT_BAND2)\n\t\tdev->chainshift[band_idx + 1] = dev->chainshift[band_idx] +\n\t\t\t\t\t\thweight16(mphy->chainmask);\n\n\tret = mt7996_eeprom_parse_efuse_hw_cap(dev);\n\tif (ret)\n\t\treturn ret;\n\n\treturn mt7996_eeprom_parse_band_config(phy);\n}\n\nint mt7996_eeprom_init(struct mt7996_dev *dev)\n{\n\tint ret;\n\n\tret = mt7996_eeprom_load(dev);\n\tif (ret < 0) {\n\t\tif (ret != -EINVAL)\n\t\t\treturn ret;\n\n\t\tdev_warn(dev->mt76.dev, \"eeprom load fail, use default bin\\n\");\n\t\tret = mt7996_eeprom_load_default(dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = mt7996_eeprom_parse_hw_cap(dev, &dev->phy);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tmemcpy(dev->mphy.macaddr, dev->mt76.eeprom.data + MT_EE_MAC_ADDR, ETH_ALEN);\n\tmt76_eeprom_override(&dev->mphy);\n\n\treturn 0;\n}\n\nint mt7996_eeprom_get_target_power(struct mt7996_dev *dev,\n\t\t\t\t   struct ieee80211_channel *chan)\n{\n\tu8 *eeprom = dev->mt76.eeprom.data;\n\tint target_power;\n\n\tif (chan->band == NL80211_BAND_5GHZ)\n\t\ttarget_power = eeprom[MT_EE_TX0_POWER_5G +\n\t\t\t\t      mt7996_get_channel_group_5g(chan->hw_value)];\n\telse if (chan->band == NL80211_BAND_6GHZ)\n\t\ttarget_power = eeprom[MT_EE_TX0_POWER_6G +\n\t\t\t\t      mt7996_get_channel_group_6g(chan->hw_value)];\n\telse\n\t\ttarget_power = eeprom[MT_EE_TX0_POWER_2G];\n\n\treturn target_power;\n}\n\ns8 mt7996_eeprom_get_power_delta(struct mt7996_dev *dev, int band)\n{\n\tu8 *eeprom = dev->mt76.eeprom.data;\n\tu32 val;\n\ts8 delta;\n\n\tif (band == NL80211_BAND_5GHZ)\n\t\tval = eeprom[MT_EE_RATE_DELTA_5G];\n\telse if (band == NL80211_BAND_6GHZ)\n\t\tval = eeprom[MT_EE_RATE_DELTA_6G];\n\telse\n\t\tval = eeprom[MT_EE_RATE_DELTA_2G];\n\n\tif (!(val & MT_EE_RATE_DELTA_EN))\n\t\treturn 0;\n\n\tdelta = FIELD_GET(MT_EE_RATE_DELTA_MASK, val);\n\n\treturn val & MT_EE_RATE_DELTA_SIGN ? delta : -delta;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}