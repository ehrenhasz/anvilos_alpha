{
  "module_name": "dma.c",
  "hash_id": "e4af184c8f66c4e00c25fa1178872397b17072d30ff9cb72159afb0daff70f8b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7996/dma.c",
  "human_readable_source": "\n \n\n#include \"mt7996.h\"\n#include \"../dma.h\"\n#include \"mac.h\"\n\nstatic int mt7996_poll_tx(struct napi_struct *napi, int budget)\n{\n\tstruct mt7996_dev *dev;\n\n\tdev = container_of(napi, struct mt7996_dev, mt76.tx_napi);\n\n\tmt76_connac_tx_cleanup(&dev->mt76);\n\tif (napi_complete_done(napi, 0))\n\t\tmt7996_irq_enable(dev, MT_INT_TX_DONE_MCU);\n\n\treturn 0;\n}\n\nstatic void mt7996_dma_config(struct mt7996_dev *dev)\n{\n#define Q_CONFIG(q, wfdma, int, id) do {\t\t\\\n\tif (wfdma)\t\t\t\t\t\\\n\t\tdev->q_wfdma_mask |= (1 << (q));\t\\\n\tdev->q_int_mask[(q)] = int;\t\t\t\\\n\tdev->q_id[(q)] = id;\t\t\t\t\\\n} while (0)\n\n#define MCUQ_CONFIG(q, wfdma, int, id)\tQ_CONFIG(q, (wfdma), (int), (id))\n#define RXQ_CONFIG(q, wfdma, int, id)\tQ_CONFIG(__RXQ(q), (wfdma), (int), (id))\n#define TXQ_CONFIG(q, wfdma, int, id)\tQ_CONFIG(__TXQ(q), (wfdma), (int), (id))\n\n\t \n\tRXQ_CONFIG(MT_RXQ_MCU, WFDMA0, MT_INT_RX_DONE_WM, MT7996_RXQ_MCU_WM);\n\tRXQ_CONFIG(MT_RXQ_MCU_WA, WFDMA0, MT_INT_RX_DONE_WA, MT7996_RXQ_MCU_WA);\n\n\t \n\tRXQ_CONFIG(MT_RXQ_MAIN, WFDMA0, MT_INT_RX_DONE_BAND0, MT7996_RXQ_BAND0);\n\tRXQ_CONFIG(MT_RXQ_MAIN_WA, WFDMA0, MT_INT_RX_DONE_WA_MAIN, MT7996_RXQ_MCU_WA_MAIN);\n\n\t \n\tRXQ_CONFIG(MT_RXQ_BAND2, WFDMA0, MT_INT_RX_DONE_BAND2, MT7996_RXQ_BAND2);\n\tRXQ_CONFIG(MT_RXQ_BAND2_WA, WFDMA0, MT_INT_RX_DONE_WA_TRI, MT7996_RXQ_MCU_WA_TRI);\n\n\t \n\tTXQ_CONFIG(0, WFDMA0, MT_INT_TX_DONE_BAND0, MT7996_TXQ_BAND0);\n\tTXQ_CONFIG(1, WFDMA0, MT_INT_TX_DONE_BAND1, MT7996_TXQ_BAND1);\n\tTXQ_CONFIG(2, WFDMA0, MT_INT_TX_DONE_BAND2, MT7996_TXQ_BAND2);\n\n\t \n\tMCUQ_CONFIG(MT_MCUQ_WM, WFDMA0, MT_INT_TX_DONE_MCU_WM, MT7996_TXQ_MCU_WM);\n\tMCUQ_CONFIG(MT_MCUQ_WA, WFDMA0, MT_INT_TX_DONE_MCU_WA, MT7996_TXQ_MCU_WA);\n\tMCUQ_CONFIG(MT_MCUQ_FWDL, WFDMA0, MT_INT_TX_DONE_FWDL, MT7996_TXQ_FWDL);\n}\n\nstatic void __mt7996_dma_prefetch(struct mt7996_dev *dev, u32 ofs)\n{\n#define PREFETCH(_base, _depth)\t((_base) << 16 | (_depth))\n\t \n\tmt76_wr(dev, MT_MCUQ_EXT_CTRL(MT_MCUQ_FWDL) + ofs, PREFETCH(0x0, 0x2));\n\tmt76_wr(dev, MT_MCUQ_EXT_CTRL(MT_MCUQ_WM) + ofs, PREFETCH(0x20, 0x2));\n\tmt76_wr(dev, MT_TXQ_EXT_CTRL(0) + ofs, PREFETCH(0x40, 0x4));\n\tmt76_wr(dev, MT_TXQ_EXT_CTRL(1) + ofs, PREFETCH(0x80, 0x4));\n\tmt76_wr(dev, MT_MCUQ_EXT_CTRL(MT_MCUQ_WA) + ofs, PREFETCH(0xc0, 0x2));\n\tmt76_wr(dev, MT_TXQ_EXT_CTRL(2) + ofs, PREFETCH(0xe0, 0x4));\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_MCU) + ofs, PREFETCH(0x120, 0x2));\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_MCU_WA) + ofs, PREFETCH(0x140, 0x2));\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_MAIN_WA) + ofs, PREFETCH(0x160, 0x2));\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_BAND2_WA) + ofs, PREFETCH(0x180, 0x2));\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_MAIN) + ofs, PREFETCH(0x1a0, 0x10));\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_BAND2) + ofs, PREFETCH(0x2a0, 0x10));\n\n\tmt76_set(dev, WF_WFDMA0_GLO_CFG_EXT1 + ofs, WF_WFDMA0_GLO_CFG_EXT1_CALC_MODE);\n}\n\nvoid mt7996_dma_prefetch(struct mt7996_dev *dev)\n{\n\t__mt7996_dma_prefetch(dev, 0);\n\tif (dev->hif2)\n\t\t__mt7996_dma_prefetch(dev, MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0));\n}\n\nstatic void mt7996_dma_disable(struct mt7996_dev *dev, bool reset)\n{\n\tu32 hif1_ofs = 0;\n\n\tif (dev->hif2)\n\t\thif1_ofs = MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0);\n\n\tif (reset) {\n\t\tmt76_clear(dev, MT_WFDMA0_RST,\n\t\t\t   MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t\t   MT_WFDMA0_RST_LOGIC_RST);\n\n\t\tmt76_set(dev, MT_WFDMA0_RST,\n\t\t\t MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t\t MT_WFDMA0_RST_LOGIC_RST);\n\n\t\tif (dev->hif2) {\n\t\t\tmt76_clear(dev, MT_WFDMA0_RST + hif1_ofs,\n\t\t\t\t   MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t\t\t   MT_WFDMA0_RST_LOGIC_RST);\n\n\t\t\tmt76_set(dev, MT_WFDMA0_RST + hif1_ofs,\n\t\t\t\t MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t\t\t MT_WFDMA0_RST_LOGIC_RST);\n\t\t}\n\t}\n\n\t \n\tmt76_clear(dev, MT_WFDMA0_GLO_CFG,\n\t\t   MT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t   MT_WFDMA0_GLO_CFG_RX_DMA_EN |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\n\tif (dev->hif2) {\n\t\tmt76_clear(dev, MT_WFDMA0_GLO_CFG + hif1_ofs,\n\t\t\t   MT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t\t   MT_WFDMA0_GLO_CFG_RX_DMA_EN |\n\t\t\t   MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO |\n\t\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\t}\n}\n\nvoid mt7996_dma_start(struct mt7996_dev *dev, bool reset)\n{\n\tu32 hif1_ofs = 0;\n\tu32 irq_mask;\n\n\tif (dev->hif2)\n\t\thif1_ofs = MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0);\n\n\t \n\tif (!reset) {\n\t\tmt76_set(dev, MT_WFDMA0_GLO_CFG,\n\t\t\t MT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t\t MT_WFDMA0_GLO_CFG_RX_DMA_EN |\n\t\t\t MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t\t MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\n\t\tif (dev->hif2)\n\t\t\tmt76_set(dev, MT_WFDMA0_GLO_CFG + hif1_ofs,\n\t\t\t\t MT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t\t\t MT_WFDMA0_GLO_CFG_RX_DMA_EN |\n\t\t\t\t MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t\t\t MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\t}\n\n\t \n\tirq_mask = MT_INT_MCU_CMD;\n\tif (reset)\n\t\tgoto done;\n\n\tirq_mask = MT_INT_RX_DONE_MCU | MT_INT_TX_DONE_MCU;\n\n\tif (!dev->mphy.band_idx)\n\t\tirq_mask |= MT_INT_BAND0_RX_DONE;\n\n\tif (dev->dbdc_support)\n\t\tirq_mask |= MT_INT_BAND1_RX_DONE;\n\n\tif (dev->tbtc_support)\n\t\tirq_mask |= MT_INT_BAND2_RX_DONE;\n\ndone:\n\tmt7996_irq_enable(dev, irq_mask);\n\tmt7996_irq_disable(dev, 0);\n}\n\nstatic void mt7996_dma_enable(struct mt7996_dev *dev, bool reset)\n{\n\tu32 hif1_ofs = 0;\n\n\tif (dev->hif2)\n\t\thif1_ofs = MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0);\n\n\t \n\tmt76_wr(dev, MT_WFDMA0_RST_DTX_PTR, ~0);\n\tif (dev->hif2)\n\t\tmt76_wr(dev, MT_WFDMA0_RST_DTX_PTR + hif1_ofs, ~0);\n\n\t \n\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG0, 0);\n\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG1, 0);\n\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG2, 0);\n\n\tif (dev->hif2) {\n\t\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG0 + hif1_ofs, 0);\n\t\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG1 + hif1_ofs, 0);\n\t\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG2 + hif1_ofs, 0);\n\t}\n\n\t \n\tmt7996_dma_prefetch(dev);\n\n\t \n\tmt76_set(dev, MT_WFDMA0_BUSY_ENA,\n\t\t MT_WFDMA0_BUSY_ENA_TX_FIFO0 |\n\t\t MT_WFDMA0_BUSY_ENA_TX_FIFO1 |\n\t\t MT_WFDMA0_BUSY_ENA_RX_FIFO);\n\n\tif (dev->hif2)\n\t\tmt76_set(dev, MT_WFDMA0_BUSY_ENA + hif1_ofs,\n\t\t\t MT_WFDMA0_PCIE1_BUSY_ENA_TX_FIFO0 |\n\t\t\t MT_WFDMA0_PCIE1_BUSY_ENA_TX_FIFO1 |\n\t\t\t MT_WFDMA0_PCIE1_BUSY_ENA_RX_FIFO);\n\n\tmt76_poll(dev, MT_WFDMA_EXT_CSR_HIF_MISC,\n\t\t  MT_WFDMA_EXT_CSR_HIF_MISC_BUSY, 0, 1000);\n\n\t \n\tmt76_set(dev, WF_WFDMA0_GLO_CFG_EXT0,\n\t\t WF_WFDMA0_GLO_CFG_EXT0_RX_WB_RXD |\n\t\t WF_WFDMA0_GLO_CFG_EXT0_WED_MERGE_MODE);\n\n\t \n\tmt76_set(dev, WF_WFDMA0_GLO_CFG_EXT1,\n\t\t WF_WFDMA0_GLO_CFG_EXT1_TX_FCTRL_MODE);\n\n\tif (dev->hif2) {\n\t\t \n\t\tmt76_set(dev, WF_WFDMA0_GLO_CFG_EXT0 + hif1_ofs,\n\t\t\t WF_WFDMA0_GLO_CFG_EXT0_RX_WB_RXD |\n\t\t\t WF_WFDMA0_GLO_CFG_EXT0_WED_MERGE_MODE);\n\n\t\t \n\t\tmt76_set(dev, WF_WFDMA0_GLO_CFG_EXT1 + hif1_ofs,\n\t\t\t WF_WFDMA0_GLO_CFG_EXT1_TX_FCTRL_MODE);\n\n\t\tmt76_set(dev, MT_WFDMA_HOST_CONFIG,\n\t\t\t MT_WFDMA_HOST_CONFIG_PDMA_BAND);\n\t}\n\n\tif (dev->hif2) {\n\t\t \n\t\tmt76_set(dev, MT_WFDMA0_RX_INT_PCIE_SEL,\n\t\t\t MT_WFDMA0_RX_INT_SEL_RING3);\n\n\t\t \n\t}\n\n\tmt7996_dma_start(dev, reset);\n}\n\nint mt7996_dma_init(struct mt7996_dev *dev)\n{\n\tu32 hif1_ofs = 0;\n\tint ret;\n\n\tmt7996_dma_config(dev);\n\n\tmt76_dma_attach(&dev->mt76);\n\n\tif (dev->hif2)\n\t\thif1_ofs = MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0);\n\n\tmt7996_dma_disable(dev, true);\n\n\t \n\tret = mt76_connac_init_tx_queues(dev->phy.mt76,\n\t\t\t\t\t MT_TXQ_ID(dev->mphy.band_idx),\n\t\t\t\t\t MT7996_TX_RING_SIZE,\n\t\t\t\t\t MT_TXQ_RING_BASE(0), 0);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_init_mcu_queue(&dev->mt76, MT_MCUQ_WM,\n\t\t\t\t  MT_MCUQ_ID(MT_MCUQ_WM),\n\t\t\t\t  MT7996_TX_MCU_RING_SIZE,\n\t\t\t\t  MT_MCUQ_RING_BASE(MT_MCUQ_WM));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_init_mcu_queue(&dev->mt76, MT_MCUQ_WA,\n\t\t\t\t  MT_MCUQ_ID(MT_MCUQ_WA),\n\t\t\t\t  MT7996_TX_MCU_RING_SIZE,\n\t\t\t\t  MT_MCUQ_RING_BASE(MT_MCUQ_WA));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_init_mcu_queue(&dev->mt76, MT_MCUQ_FWDL,\n\t\t\t\t  MT_MCUQ_ID(MT_MCUQ_FWDL),\n\t\t\t\t  MT7996_TX_FWDL_RING_SIZE,\n\t\t\t\t  MT_MCUQ_RING_BASE(MT_MCUQ_FWDL));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_MCU],\n\t\t\t       MT_RXQ_ID(MT_RXQ_MCU),\n\t\t\t       MT7996_RX_MCU_RING_SIZE,\n\t\t\t       MT_RX_BUF_SIZE,\n\t\t\t       MT_RXQ_RING_BASE(MT_RXQ_MCU));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_MCU_WA],\n\t\t\t       MT_RXQ_ID(MT_RXQ_MCU_WA),\n\t\t\t       MT7996_RX_MCU_RING_SIZE_WA,\n\t\t\t       MT_RX_BUF_SIZE,\n\t\t\t       MT_RXQ_RING_BASE(MT_RXQ_MCU_WA));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_MAIN],\n\t\t\t       MT_RXQ_ID(MT_RXQ_MAIN),\n\t\t\t       MT7996_RX_RING_SIZE,\n\t\t\t       MT_RX_BUF_SIZE,\n\t\t\t       MT_RXQ_RING_BASE(MT_RXQ_MAIN));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_MAIN_WA],\n\t\t\t       MT_RXQ_ID(MT_RXQ_MAIN_WA),\n\t\t\t       MT7996_RX_MCU_RING_SIZE,\n\t\t\t       MT_RX_BUF_SIZE,\n\t\t\t       MT_RXQ_RING_BASE(MT_RXQ_MAIN_WA));\n\tif (ret)\n\t\treturn ret;\n\n\tif (dev->tbtc_support || dev->mphy.band_idx == MT_BAND2) {\n\t\t \n\t\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_BAND2],\n\t\t\t\t       MT_RXQ_ID(MT_RXQ_BAND2),\n\t\t\t\t       MT7996_RX_RING_SIZE,\n\t\t\t\t       MT_RX_BUF_SIZE,\n\t\t\t\t       MT_RXQ_RING_BASE(MT_RXQ_BAND2) + hif1_ofs);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_BAND2_WA],\n\t\t\t\t       MT_RXQ_ID(MT_RXQ_BAND2_WA),\n\t\t\t\t       MT7996_RX_MCU_RING_SIZE,\n\t\t\t\t       MT_RX_BUF_SIZE,\n\t\t\t\t       MT_RXQ_RING_BASE(MT_RXQ_BAND2_WA));\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = mt76_init_queues(dev, mt76_dma_rx_poll);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tnetif_napi_add_tx(&dev->mt76.tx_napi_dev, &dev->mt76.tx_napi,\n\t\t\t  mt7996_poll_tx);\n\tnapi_enable(&dev->mt76.tx_napi);\n\n\tmt7996_dma_enable(dev, false);\n\n\treturn 0;\n}\n\nvoid mt7996_dma_reset(struct mt7996_dev *dev, bool force)\n{\n\tstruct mt76_phy *phy2 = dev->mt76.phys[MT_BAND1];\n\tstruct mt76_phy *phy3 = dev->mt76.phys[MT_BAND2];\n\tu32 hif1_ofs = MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0);\n\tint i;\n\n\tmt76_clear(dev, MT_WFDMA0_GLO_CFG,\n\t\t   MT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t   MT_WFDMA0_GLO_CFG_RX_DMA_EN);\n\n\tif (dev->hif2)\n\t\tmt76_clear(dev, MT_WFDMA0_GLO_CFG + hif1_ofs,\n\t\t\t   MT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t\t   MT_WFDMA0_GLO_CFG_RX_DMA_EN);\n\n\tusleep_range(1000, 2000);\n\n\tfor (i = 0; i < __MT_TXQ_MAX; i++) {\n\t\tmt76_queue_tx_cleanup(dev, dev->mphy.q_tx[i], true);\n\t\tif (phy2)\n\t\t\tmt76_queue_tx_cleanup(dev, phy2->q_tx[i], true);\n\t\tif (phy3)\n\t\t\tmt76_queue_tx_cleanup(dev, phy3->q_tx[i], true);\n\t}\n\n\tfor (i = 0; i < __MT_MCUQ_MAX; i++)\n\t\tmt76_queue_tx_cleanup(dev, dev->mt76.q_mcu[i], true);\n\n\tmt76_for_each_q_rx(&dev->mt76, i)\n\t\tmt76_queue_rx_cleanup(dev, &dev->mt76.q_rx[i]);\n\n\tmt76_tx_status_check(&dev->mt76, true);\n\n\t \n\tif (force)\n\t\tmt7996_wfsys_reset(dev);\n\n\tmt7996_dma_disable(dev, force);\n\n\t \n\tfor (i = 0; i < __MT_TXQ_MAX; i++) {\n\t\tmt76_queue_reset(dev, dev->mphy.q_tx[i]);\n\t\tif (phy2)\n\t\t\tmt76_queue_reset(dev, phy2->q_tx[i]);\n\t\tif (phy3)\n\t\t\tmt76_queue_reset(dev, phy3->q_tx[i]);\n\t}\n\n\tfor (i = 0; i < __MT_MCUQ_MAX; i++)\n\t\tmt76_queue_reset(dev, dev->mt76.q_mcu[i]);\n\n\tmt76_for_each_q_rx(&dev->mt76, i) {\n\t\tmt76_queue_reset(dev, &dev->mt76.q_rx[i]);\n\t}\n\n\tmt76_tx_status_check(&dev->mt76, true);\n\n\tmt76_for_each_q_rx(&dev->mt76, i)\n\t\tmt76_queue_rx_reset(dev, i);\n\n\tmt7996_dma_enable(dev, !force);\n}\n\nvoid mt7996_dma_cleanup(struct mt7996_dev *dev)\n{\n\tmt7996_dma_disable(dev, true);\n\n\tmt76_dma_cleanup(&dev->mt76);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}