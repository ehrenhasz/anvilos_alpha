{
  "module_name": "coredump.c",
  "hash_id": "971c264394ddbd1ab0f7f15ca8935252bc926e98800ac6951666d17f529854fe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7996/coredump.c",
  "human_readable_source": "\n \n\n#include <linux/devcoredump.h>\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/utsname.h>\n#include \"coredump.h\"\n\nstatic bool coredump_memdump;\nmodule_param(coredump_memdump, bool, 0644);\nMODULE_PARM_DESC(coredump_memdump, \"Optional ability to dump firmware memory\");\n\nstatic const struct mt7996_mem_region mt7996_mem_regions[] = {\n\t{\n\t\t.start = 0x00800000,\n\t\t.len = 0x0004ffff,\n\t\t.name = \"ULM0\",\n\t},\n\t{\n\t\t.start = 0x00900000,\n\t\t.len = 0x00037fff,\n\t\t.name = \"ULM1\",\n\t},\n\t{\n\t\t.start = 0x02200000,\n\t\t.len = 0x0003ffff,\n\t\t.name = \"ULM2\",\n\t},\n\t{\n\t\t.start = 0x00400000,\n\t\t.len = 0x00067fff,\n\t\t.name = \"SRAM\",\n\t},\n\t{\n\t\t.start = 0xe0000000,\n\t\t.len = 0x0015ffff,\n\t\t.name = \"CRAM0\",\n\t},\n\t{\n\t\t.start = 0xe0160000,\n\t\t.len = 0x0011bfff,\n\t\t.name = \"CRAM1\",\n\t},\n};\n\nconst struct mt7996_mem_region*\nmt7996_coredump_get_mem_layout(struct mt7996_dev *dev, u32 *num)\n{\n\tswitch (mt76_chip(&dev->mt76)) {\n\tcase 0x7990:\n\tcase 0x7991:\n\t\t*num = ARRAY_SIZE(mt7996_mem_regions);\n\t\treturn &mt7996_mem_regions[0];\n\tdefault:\n\t\treturn NULL;\n\t}\n}\n\nstatic int mt7996_coredump_get_mem_size(struct mt7996_dev *dev)\n{\n\tconst struct mt7996_mem_region *mem_region;\n\tsize_t size = 0;\n\tu32 num;\n\tint i;\n\n\tmem_region = mt7996_coredump_get_mem_layout(dev, &num);\n\tif (!mem_region)\n\t\treturn 0;\n\n\tfor (i = 0; i < num; i++) {\n\t\tsize += mem_region->len;\n\t\tmem_region++;\n\t}\n\n\t \n\tsize += num * sizeof(struct mt7996_mem_hdr);\n\t \n\tsize = ALIGN(size, 4);\n\n\treturn size;\n}\n\nstruct mt7996_crash_data *mt7996_coredump_new(struct mt7996_dev *dev)\n{\n\tstruct mt7996_crash_data *crash_data = dev->coredump.crash_data;\n\n\tlockdep_assert_held(&dev->dump_mutex);\n\n\tif (coredump_memdump &&\n\t    !mt76_poll_msec(dev, MT_FW_DUMP_STATE, 0x3, 0x2, 500))\n\t\treturn NULL;\n\n\tguid_gen(&crash_data->guid);\n\tktime_get_real_ts64(&crash_data->timestamp);\n\n\treturn crash_data;\n}\n\nstatic void\nmt7996_coredump_fw_state(struct mt7996_dev *dev, struct mt7996_coredump *dump,\n\t\t\t bool *exception)\n{\n\tu32 count;\n\n\tcount = mt76_rr(dev, MT_FW_ASSERT_CNT);\n\n\t \n\tif (!count)\n\t\tstrscpy(dump->fw_state, \"normal\", sizeof(dump->fw_state));\n\telse\n\t\tstrscpy(dump->fw_state, \"exception\", sizeof(dump->fw_state));\n\n\t*exception = !!count;\n}\n\nstatic void\nmt7996_coredump_fw_stack(struct mt7996_dev *dev, struct mt7996_coredump *dump,\n\t\t\t bool exception)\n{\n\tu32 oldest, i, idx;\n\n\tstrscpy(dump->pc_current, \"program counter\", sizeof(dump->pc_current));\n\n\t \n\tmt76_wr(dev, MT_CONN_DBG_CTL_OUT_SEL, 0);\n\t \n\tmt76_wr(dev, MT_CONN_DBG_CTL_PC_LOG_SEL, 0x3f);\n\n\t \n\tdump->pc_stack[0] = mt76_rr(dev, MT_CONN_DBG_CTL_PC_LOG);\n\n\t \n\tif (!exception) {\n\t\tmt76_clear(dev, MT_MCU_WM_EXCP_PC_CTRL, BIT(0));\n\t\tmt76_clear(dev, MT_MCU_WM_EXCP_LR_CTRL, BIT(0));\n\t}\n\n\toldest = (u32)mt76_get_field(dev, MT_MCU_WM_EXCP_PC_CTRL,\n\t\t\t\t     GENMASK(20, 16)) + 2;\n\tfor (i = 0; i < 16; i++) {\n\t\tidx = ((oldest + 2 * i + 1) % 32);\n\t\tdump->pc_stack[i + 1] =\n\t\t\tmt76_rr(dev, MT_MCU_WM_EXCP_PC_LOG + idx * 4);\n\t}\n\n\toldest = (u32)mt76_get_field(dev, MT_MCU_WM_EXCP_LR_CTRL,\n\t\t\t\t     GENMASK(20, 16)) + 2;\n\tfor (i = 0; i < 16; i++) {\n\t\tidx = ((oldest + 2 * i + 1) % 32);\n\t\tdump->lr_stack[i] =\n\t\t\tmt76_rr(dev, MT_MCU_WM_EXCP_LR_LOG + idx * 4);\n\t}\n\n\t \n\tif (!exception) {\n\t\tmt76_set(dev, MT_MCU_WM_EXCP_PC_CTRL, BIT(0));\n\t\tmt76_set(dev, MT_MCU_WM_EXCP_LR_CTRL, BIT(0));\n\t}\n}\n\nstatic struct mt7996_coredump *mt7996_coredump_build(struct mt7996_dev *dev)\n{\n\tstruct mt7996_crash_data *crash_data = dev->coredump.crash_data;\n\tstruct mt7996_coredump *dump;\n\tstruct mt7996_coredump_mem *dump_mem;\n\tsize_t len, sofar = 0, hdr_len = sizeof(*dump);\n\tunsigned char *buf;\n\tbool exception;\n\n\tlen = hdr_len;\n\n\tif (coredump_memdump && crash_data->memdump_buf_len)\n\t\tlen += sizeof(*dump_mem) + crash_data->memdump_buf_len;\n\n\tsofar += hdr_len;\n\n\t \n\tbuf = vzalloc(len);\n\tif (!buf)\n\t\treturn NULL;\n\n\tmutex_lock(&dev->dump_mutex);\n\n\tdump = (struct mt7996_coredump *)(buf);\n\tdump->len = len;\n\n\t \n\tstrscpy(dump->magic, \"mt76-crash-dump\", sizeof(dump->magic));\n\tstrscpy(dump->kernel, init_utsname()->release, sizeof(dump->kernel));\n\tstrscpy(dump->fw_ver, dev->mt76.hw->wiphy->fw_version,\n\t\tsizeof(dump->fw_ver));\n\n\tguid_copy(&dump->guid, &crash_data->guid);\n\tdump->tv_sec = crash_data->timestamp.tv_sec;\n\tdump->tv_nsec = crash_data->timestamp.tv_nsec;\n\tdump->device_id = mt76_chip(&dev->mt76);\n\n\tmt7996_coredump_fw_state(dev, dump, &exception);\n\tmt7996_coredump_fw_stack(dev, dump, exception);\n\n\t \n\tdump_mem = (struct mt7996_coredump_mem *)(buf + sofar);\n\tdump_mem->len = crash_data->memdump_buf_len;\n\tif (coredump_memdump && crash_data->memdump_buf_len)\n\t\tmemcpy(dump_mem->data, crash_data->memdump_buf,\n\t\t       crash_data->memdump_buf_len);\n\n\tmutex_unlock(&dev->dump_mutex);\n\n\treturn dump;\n}\n\nint mt7996_coredump_submit(struct mt7996_dev *dev)\n{\n\tstruct mt7996_coredump *dump;\n\n\tdump = mt7996_coredump_build(dev);\n\tif (!dump) {\n\t\tdev_warn(dev->mt76.dev, \"no crash dump data found\\n\");\n\t\treturn -ENODATA;\n\t}\n\n\tdev_coredumpv(dev->mt76.dev, dump, dump->len, GFP_KERNEL);\n\n\treturn 0;\n}\n\nint mt7996_coredump_register(struct mt7996_dev *dev)\n{\n\tstruct mt7996_crash_data *crash_data;\n\n\tcrash_data = vzalloc(sizeof(*dev->coredump.crash_data));\n\tif (!crash_data)\n\t\treturn -ENOMEM;\n\n\tdev->coredump.crash_data = crash_data;\n\n\tif (coredump_memdump) {\n\t\tcrash_data->memdump_buf_len = mt7996_coredump_get_mem_size(dev);\n\t\tif (!crash_data->memdump_buf_len)\n\t\t\t \n\t\t\treturn 0;\n\n\t\tcrash_data->memdump_buf = vzalloc(crash_data->memdump_buf_len);\n\t\tif (!crash_data->memdump_buf) {\n\t\t\tvfree(crash_data);\n\t\t\treturn -ENOMEM;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nvoid mt7996_coredump_unregister(struct mt7996_dev *dev)\n{\n\tif (dev->coredump.crash_data->memdump_buf) {\n\t\tvfree(dev->coredump.crash_data->memdump_buf);\n\t\tdev->coredump.crash_data->memdump_buf = NULL;\n\t\tdev->coredump.crash_data->memdump_buf_len = 0;\n\t}\n\n\tvfree(dev->coredump.crash_data);\n\tdev->coredump.crash_data = NULL;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}