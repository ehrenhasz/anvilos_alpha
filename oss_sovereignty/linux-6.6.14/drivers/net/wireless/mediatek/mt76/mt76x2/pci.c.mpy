{
  "module_name": "pci.c",
  "hash_id": "0ef1246b51df733847712ef8a68f5863e45953ac51d4cffb0a788070656924a2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt76x2/pci.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n\n#include \"mt76x2.h\"\n\nstatic const struct pci_device_id mt76x2e_device_table[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MEDIATEK, 0x7662) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MEDIATEK, 0x7612) },\n\t{ PCI_DEVICE(PCI_VENDOR_ID_MEDIATEK, 0x7602) },\n\t{ },\n};\n\nstatic int\nmt76x2e_probe(struct pci_dev *pdev, const struct pci_device_id *id)\n{\n\tstatic const struct mt76_driver_ops drv_ops = {\n\t\t.txwi_size = sizeof(struct mt76x02_txwi),\n\t\t.drv_flags = MT_DRV_TX_ALIGNED4_SKBS |\n\t\t\t     MT_DRV_SW_RX_AIRTIME,\n\t\t.survey_flags = SURVEY_INFO_TIME_TX,\n\t\t.update_survey = mt76x02_update_channel,\n\t\t.tx_prepare_skb = mt76x02_tx_prepare_skb,\n\t\t.tx_complete_skb = mt76x02_tx_complete_skb,\n\t\t.rx_skb = mt76x02_queue_rx_skb,\n\t\t.rx_poll_complete = mt76x02_rx_poll_complete,\n\t\t.sta_ps = mt76x02_sta_ps,\n\t\t.sta_add = mt76x02_sta_add,\n\t\t.sta_remove = mt76x02_sta_remove,\n\t};\n\tstruct mt76x02_dev *dev;\n\tstruct mt76_dev *mdev;\n\tint ret;\n\n\tret = pcim_enable_device(pdev);\n\tif (ret)\n\t\treturn ret;\n\n\tret = pcim_iomap_regions(pdev, BIT(0), pci_name(pdev));\n\tif (ret)\n\t\treturn ret;\n\n\tpci_set_master(pdev);\n\n\tret = dma_set_mask(&pdev->dev, DMA_BIT_MASK(32));\n\tif (ret)\n\t\treturn ret;\n\n\tmdev = mt76_alloc_device(&pdev->dev, sizeof(*dev), &mt76x2_ops,\n\t\t\t\t &drv_ops);\n\tif (!mdev)\n\t\treturn -ENOMEM;\n\n\tdev = container_of(mdev, struct mt76x02_dev, mt76);\n\tmt76_mmio_init(mdev, pcim_iomap_table(pdev)[0]);\n\tmt76x2_reset_wlan(dev, false);\n\n\tmdev->rev = mt76_rr(dev, MT_ASIC_VERSION);\n\tdev_info(mdev->dev, \"ASIC revision: %08x\\n\", mdev->rev);\n\n\tmt76_wr(dev, MT_INT_MASK_CSR, 0);\n\n\tret = devm_request_irq(mdev->dev, pdev->irq, mt76x02_irq_handler,\n\t\t\t       IRQF_SHARED, KBUILD_MODNAME, dev);\n\tif (ret)\n\t\tgoto error;\n\n\tret = mt76x2_register_device(dev);\n\tif (ret)\n\t\tgoto error;\n\n\t \n\n\t \n\tmt76_rmw_field(dev, 0x15a10, 0x1f << 16, 0x9);\n\n\t \n\tmt76_rmw_field(dev, 0x15a0c, 0xfU << 28, 0xf);\n\n\t \n\tmt76_rmw_field(dev, 0x15c58, 0x3 << 6, 0x3);\n\n\tmt76_pci_disable_aspm(pdev);\n\n\treturn 0;\n\nerror:\n\tmt76_free_device(&dev->mt76);\n\n\treturn ret;\n}\n\nstatic void\nmt76x2e_remove(struct pci_dev *pdev)\n{\n\tstruct mt76_dev *mdev = pci_get_drvdata(pdev);\n\tstruct mt76x02_dev *dev = container_of(mdev, struct mt76x02_dev, mt76);\n\n\tmt76_unregister_device(mdev);\n\tmt76x2_cleanup(dev);\n\tmt76_free_device(mdev);\n}\n\nstatic int __maybe_unused\nmt76x2e_suspend(struct pci_dev *pdev, pm_message_t state)\n{\n\tstruct mt76_dev *mdev = pci_get_drvdata(pdev);\n\tint i, err;\n\n\tnapi_disable(&mdev->tx_napi);\n\ttasklet_kill(&mdev->pre_tbtt_tasklet);\n\tmt76_worker_disable(&mdev->tx_worker);\n\n\tmt76_for_each_q_rx(mdev, i)\n\t\tnapi_disable(&mdev->napi[i]);\n\n\tpci_enable_wake(pdev, pci_choose_state(pdev, state), true);\n\tpci_save_state(pdev);\n\terr = pci_set_power_state(pdev, pci_choose_state(pdev, state));\n\tif (err)\n\t\tgoto restore;\n\n\treturn 0;\n\nrestore:\n\tmt76_for_each_q_rx(mdev, i)\n\t\tnapi_enable(&mdev->napi[i]);\n\tnapi_enable(&mdev->tx_napi);\n\n\treturn err;\n}\n\nstatic int __maybe_unused\nmt76x2e_resume(struct pci_dev *pdev)\n{\n\tstruct mt76_dev *mdev = pci_get_drvdata(pdev);\n\tstruct mt76x02_dev *dev = container_of(mdev, struct mt76x02_dev, mt76);\n\tint i, err;\n\n\terr = pci_set_power_state(pdev, PCI_D0);\n\tif (err)\n\t\treturn err;\n\n\tpci_restore_state(pdev);\n\n\tmt76_worker_enable(&mdev->tx_worker);\n\n\tlocal_bh_disable();\n\tmt76_for_each_q_rx(mdev, i) {\n\t\tnapi_enable(&mdev->napi[i]);\n\t\tnapi_schedule(&mdev->napi[i]);\n\t}\n\tnapi_enable(&mdev->tx_napi);\n\tnapi_schedule(&mdev->tx_napi);\n\tlocal_bh_enable();\n\n\treturn mt76x2_resume_device(dev);\n}\n\nMODULE_DEVICE_TABLE(pci, mt76x2e_device_table);\nMODULE_FIRMWARE(MT7662_FIRMWARE);\nMODULE_FIRMWARE(MT7662_ROM_PATCH);\nMODULE_LICENSE(\"Dual BSD/GPL\");\n\nstatic struct pci_driver mt76pci_driver = {\n\t.name\t\t= KBUILD_MODNAME,\n\t.id_table\t= mt76x2e_device_table,\n\t.probe\t\t= mt76x2e_probe,\n\t.remove\t\t= mt76x2e_remove,\n#ifdef CONFIG_PM\n\t.suspend\t= mt76x2e_suspend,\n\t.resume\t\t= mt76x2e_resume,\n#endif  \n};\n\nmodule_pci_driver(mt76pci_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}