{
  "module_name": "usb_mac.c",
  "hash_id": "4a47254d857d46f4a97fd2ac1a6a0aead649c8991234a30038a23dbffc489f5d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt76x2/usb_mac.c",
  "human_readable_source": "\n \n\n#include \"mt76x2u.h\"\n#include \"eeprom.h\"\n\nstatic void mt76x2u_mac_fixup_xtal(struct mt76x02_dev *dev)\n{\n\ts8 offset = 0;\n\tu16 eep_val;\n\n\teep_val = mt76x02_eeprom_get(dev, MT_EE_XTAL_TRIM_2);\n\n\toffset = eep_val & 0x7f;\n\tif ((eep_val & 0xff) == 0xff)\n\t\toffset = 0;\n\telse if (eep_val & 0x80)\n\t\toffset = 0 - offset;\n\n\teep_val >>= 8;\n\tif (eep_val == 0x00 || eep_val == 0xff) {\n\t\teep_val = mt76x02_eeprom_get(dev, MT_EE_XTAL_TRIM_1);\n\t\teep_val &= 0xff;\n\n\t\tif (eep_val == 0x00 || eep_val == 0xff)\n\t\t\teep_val = 0x14;\n\t}\n\n\teep_val &= 0x7f;\n\tmt76_rmw_field(dev, MT_VEND_ADDR(CFG, MT_XO_CTRL5),\n\t\t       MT_XO_CTRL5_C2_VAL, eep_val + offset);\n\tmt76_set(dev, MT_VEND_ADDR(CFG, MT_XO_CTRL6), MT_XO_CTRL6_C2_CTRL);\n\n\tmt76_wr(dev, 0x504, 0x06000000);\n\tmt76_wr(dev, 0x50c, 0x08800000);\n\tmdelay(5);\n\tmt76_wr(dev, 0x504, 0x0);\n\n\t \n\tmt76_rmw_field(dev, MT_XIFS_TIME_CFG,\n\t\t       MT_XIFS_TIME_CFG_OFDM_SIFS, 0xd);\n\tmt76_rmw_field(dev, MT_BKOFF_SLOT_CFG, MT_BKOFF_SLOT_CFG_CC_DELAY, 1);\n\n\t \n\tmt76_clear(dev, MT_FCE_L2_STUFF, MT_FCE_L2_STUFF_WR_MPDU_LEN_EN);\n\n\teep_val = mt76x02_eeprom_get(dev, MT_EE_NIC_CONF_2);\n\tswitch (FIELD_GET(MT_EE_NIC_CONF_2_XTAL_OPTION, eep_val)) {\n\tcase 0:\n\t\tmt76_wr(dev, MT_XO_CTRL7, 0x5c1fee80);\n\t\tbreak;\n\tcase 1:\n\t\tmt76_wr(dev, MT_XO_CTRL7, 0x5c1feed0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nint mt76x2u_mac_reset(struct mt76x02_dev *dev)\n{\n\tmt76_wr(dev, MT_WPDMA_GLO_CFG, BIT(4) | BIT(5));\n\n\t \n\tmt76_wr(dev, MT_PBF_TX_MAX_PCNT, 0xefef3f1f);\n\tmt76_wr(dev, MT_PBF_RX_MAX_PCNT, 0xfebf);\n\n\tmt76_write_mac_initvals(dev);\n\n\tmt76_wr(dev, MT_TX_LINK_CFG, 0x1020);\n\tmt76_wr(dev, MT_AUTO_RSP_CFG, 0x13);\n\tmt76_wr(dev, MT_MAX_LEN_CFG, 0x2f00);\n\n\tmt76_wr(dev, MT_WMM_AIFSN, 0x2273);\n\tmt76_wr(dev, MT_WMM_CWMIN, 0x2344);\n\tmt76_wr(dev, MT_WMM_CWMAX, 0x34aa);\n\n\tmt76_clear(dev, MT_MAC_SYS_CTRL,\n\t\t   MT_MAC_SYS_CTRL_RESET_CSR |\n\t\t   MT_MAC_SYS_CTRL_RESET_BBP);\n\n\tif (is_mt7612(dev))\n\t\tmt76_clear(dev, MT_COEXCFG0, MT_COEXCFG0_COEX_EN);\n\n\tmt76_set(dev, MT_EXT_CCA_CFG, 0xf000);\n\tmt76_clear(dev, MT_TX_ALC_CFG_4, BIT(31));\n\n\tmt76x2u_mac_fixup_xtal(dev);\n\n\treturn 0;\n}\n\nint mt76x2u_mac_stop(struct mt76x02_dev *dev)\n{\n\tint i, count = 0, val;\n\tbool stopped = false;\n\tu32 rts_cfg;\n\n\tif (test_bit(MT76_REMOVED, &dev->mphy.state))\n\t\treturn -EIO;\n\n\trts_cfg = mt76_rr(dev, MT_TX_RTS_CFG);\n\tmt76_wr(dev, MT_TX_RTS_CFG, rts_cfg & ~MT_TX_RTS_CFG_RETRY_LIMIT);\n\n\tmt76_clear(dev, MT_TXOP_CTRL_CFG, MT_TXOP_ED_CCA_EN);\n\tmt76_clear(dev, MT_TXOP_HLDR_ET, MT_TXOP_HLDR_TX40M_BLK_EN);\n\n\t \n\tfor (i = 0; i < 2000; i++) {\n\t\tval = mt76_rr(dev, MT_VEND_ADDR(CFG, MT_USB_U3DMA_CFG));\n\t\tif (!(val & MT_USB_DMA_CFG_TX_BUSY) && i > 10)\n\t\t\tbreak;\n\t\tusleep_range(50, 100);\n\t}\n\n\t \n\tfor (i = 0; i < 200; i++) {\n\t\tif (!(mt76_rr(dev, 0x0438) & 0xffffffff) &&\n\t\t    !(mt76_rr(dev, 0x0a30) & 0x000000ff) &&\n\t\t    !(mt76_rr(dev, 0x0a34) & 0xff00ff00))\n\t\t\tbreak;\n\t\tusleep_range(10, 20);\n\t}\n\n\t \n\tmt76_clear(dev, MT_MAC_SYS_CTRL,\n\t\t   MT_MAC_SYS_CTRL_ENABLE_RX |\n\t\t   MT_MAC_SYS_CTRL_ENABLE_TX);\n\n\t \n\tfor (i = 0; i < 1000; i++) {\n\t\tif (!(mt76_rr(dev, MT_MAC_STATUS) & MT_MAC_STATUS_TX) &&\n\t\t    !mt76_rr(dev, MT_BBP(IBI, 12))) {\n\t\t\tstopped = true;\n\t\t\tbreak;\n\t\t}\n\t\tusleep_range(10, 20);\n\t}\n\n\tif (!stopped) {\n\t\tmt76_set(dev, MT_BBP(CORE, 4), BIT(1));\n\t\tmt76_clear(dev, MT_BBP(CORE, 4), BIT(1));\n\n\t\tmt76_set(dev, MT_BBP(CORE, 4), BIT(0));\n\t\tmt76_clear(dev, MT_BBP(CORE, 4), BIT(0));\n\t}\n\n\t \n\tfor (i = 0; i < 200; i++) {\n\t\tif (!(mt76_rr(dev, 0x0430) & 0x00ff0000) &&\n\t\t    !(mt76_rr(dev, 0x0a30) & 0xffffffff) &&\n\t\t    !(mt76_rr(dev, 0x0a34) & 0xffffffff) &&\n\t\t    ++count > 10)\n\t\t\tbreak;\n\t\tmsleep(50);\n\t}\n\n\tif (!mt76_poll(dev, MT_MAC_STATUS, MT_MAC_STATUS_RX, 0, 2000))\n\t\tdev_warn(dev->mt76.dev, \"MAC RX failed to stop\\n\");\n\n\t \n\tfor (i = 0; i < 2000; i++) {\n\t\tval = mt76_rr(dev, MT_VEND_ADDR(CFG, MT_USB_U3DMA_CFG));\n\t\tif (!(val & MT_USB_DMA_CFG_RX_BUSY) && i > 10)\n\t\t\tbreak;\n\t\tusleep_range(50, 100);\n\t}\n\n\tmt76_wr(dev, MT_TX_RTS_CFG, rts_cfg);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}