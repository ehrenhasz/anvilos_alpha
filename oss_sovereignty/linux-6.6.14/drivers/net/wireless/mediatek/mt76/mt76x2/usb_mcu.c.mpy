{
  "module_name": "usb_mcu.c",
  "hash_id": "6ad6c6b43542eb13f004f68bc3b24b9c319260564471caff812b6ed319de863b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt76x2/usb_mcu.c",
  "human_readable_source": "\n \n\n#include <linux/firmware.h>\n\n#include \"mt76x2u.h\"\n#include \"eeprom.h\"\n#include \"../mt76x02_usb.h\"\n\n#define MT_CMD_HDR_LEN\t\t\t4\n\n#define MCU_FW_URB_MAX_PAYLOAD\t\t0x3900\n#define MCU_ROM_PATCH_MAX_PAYLOAD\t2048\n\n#define MT76U_MCU_ILM_OFFSET\t\t0x80000\n#define MT76U_MCU_DLM_OFFSET\t\t0x110000\n#define MT76U_MCU_ROM_PATCH_OFFSET\t0x90000\n\nstatic void mt76x2u_mcu_load_ivb(struct mt76x02_dev *dev)\n{\n\tmt76u_vendor_request(&dev->mt76, MT_VEND_DEV_MODE,\n\t\t\t     USB_DIR_OUT | USB_TYPE_VENDOR,\n\t\t\t     0x12, 0, NULL, 0);\n}\n\nstatic void mt76x2u_mcu_enable_patch(struct mt76x02_dev *dev)\n{\n\tstruct mt76_usb *usb = &dev->mt76.usb;\n\tstatic const u8 data[] = {\n\t\t0x6f, 0xfc, 0x08, 0x01,\n\t\t0x20, 0x04, 0x00, 0x00,\n\t\t0x00, 0x09, 0x00,\n\t};\n\n\tmemcpy(usb->data, data, sizeof(data));\n\tmt76u_vendor_request(&dev->mt76, MT_VEND_DEV_MODE,\n\t\t\t     USB_DIR_OUT | USB_TYPE_CLASS,\n\t\t\t     0x12, 0, usb->data, sizeof(data));\n}\n\nstatic void mt76x2u_mcu_reset_wmt(struct mt76x02_dev *dev)\n{\n\tstruct mt76_usb *usb = &dev->mt76.usb;\n\tu8 data[] = {\n\t\t0x6f, 0xfc, 0x05, 0x01,\n\t\t0x07, 0x01, 0x00, 0x04\n\t};\n\n\tmemcpy(usb->data, data, sizeof(data));\n\tmt76u_vendor_request(&dev->mt76, MT_VEND_DEV_MODE,\n\t\t\t     USB_DIR_OUT | USB_TYPE_CLASS,\n\t\t\t     0x12, 0, usb->data, sizeof(data));\n}\n\nstatic int mt76x2u_mcu_load_rom_patch(struct mt76x02_dev *dev)\n{\n\tbool rom_protect = !is_mt7612(dev);\n\tstruct mt76x02_patch_header *hdr;\n\tu32 val, patch_mask, patch_reg;\n\tconst struct firmware *fw;\n\tint err;\n\n\tif (rom_protect &&\n\t    !mt76_poll_msec(dev, MT_MCU_SEMAPHORE_03, 1, 1, 600)) {\n\t\tdev_err(dev->mt76.dev,\n\t\t\t\"could not get hardware semaphore for ROM PATCH\\n\");\n\t\treturn -ETIMEDOUT;\n\t}\n\n\tif (mt76xx_rev(dev) >= MT76XX_REV_E3) {\n\t\tpatch_mask = BIT(0);\n\t\tpatch_reg = MT_MCU_CLOCK_CTL;\n\t} else {\n\t\tpatch_mask = BIT(1);\n\t\tpatch_reg = MT_MCU_COM_REG0;\n\t}\n\n\tif (rom_protect && (mt76_rr(dev, patch_reg) & patch_mask)) {\n\t\tdev_info(dev->mt76.dev, \"ROM patch already applied\\n\");\n\t\treturn 0;\n\t}\n\n\terr = request_firmware(&fw, MT7662_ROM_PATCH, dev->mt76.dev);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (!fw || !fw->data || fw->size <= sizeof(*hdr)) {\n\t\tdev_err(dev->mt76.dev, \"failed to load firmware\\n\");\n\t\terr = -EIO;\n\t\tgoto out;\n\t}\n\n\thdr = (struct mt76x02_patch_header *)fw->data;\n\tdev_info(dev->mt76.dev, \"ROM patch build: %.15s\\n\", hdr->build_time);\n\n\t \n\tval = MT_USB_DMA_CFG_RX_BULK_EN |\n\t      MT_USB_DMA_CFG_TX_BULK_EN |\n\t      FIELD_PREP(MT_USB_DMA_CFG_RX_BULK_AGG_TOUT, 0x20);\n\tmt76_wr(dev, MT_VEND_ADDR(CFG, MT_USB_U3DMA_CFG), val);\n\n\t \n\tmt76x02u_mcu_fw_reset(dev);\n\tusleep_range(5000, 10000);\n\n\t \n\tmt76_wr(dev, MT_FCE_PSE_CTRL, 0x1);\n\t \n\tmt76_wr(dev, MT_TX_CPU_FROM_FCE_BASE_PTR, 0x400230);\n\t \n\tmt76_wr(dev, MT_TX_CPU_FROM_FCE_MAX_COUNT, 0x1);\n\t \n\tmt76_wr(dev, MT_FCE_PDMA_GLOBAL_CONF, 0x44);\n\t \n\tmt76_wr(dev, MT_FCE_SKIP_FS, 0x3);\n\n\terr = mt76x02u_mcu_fw_send_data(dev, fw->data + sizeof(*hdr),\n\t\t\t\t\tfw->size - sizeof(*hdr),\n\t\t\t\t\tMCU_ROM_PATCH_MAX_PAYLOAD,\n\t\t\t\t\tMT76U_MCU_ROM_PATCH_OFFSET);\n\tif (err < 0) {\n\t\terr = -EIO;\n\t\tgoto out;\n\t}\n\n\tmt76x2u_mcu_enable_patch(dev);\n\tmt76x2u_mcu_reset_wmt(dev);\n\tmdelay(20);\n\n\tif (!mt76_poll_msec(dev, patch_reg, patch_mask, patch_mask, 100)) {\n\t\tdev_err(dev->mt76.dev, \"failed to load ROM patch\\n\");\n\t\terr = -ETIMEDOUT;\n\t}\n\nout:\n\tif (rom_protect)\n\t\tmt76_wr(dev, MT_MCU_SEMAPHORE_03, 1);\n\trelease_firmware(fw);\n\treturn err;\n}\n\nstatic int mt76x2u_mcu_load_firmware(struct mt76x02_dev *dev)\n{\n\tu32 val, dlm_offset = MT76U_MCU_DLM_OFFSET;\n\tconst struct mt76x02_fw_header *hdr;\n\tint err, len, ilm_len, dlm_len;\n\tconst struct firmware *fw;\n\n\terr = request_firmware(&fw, MT7662_FIRMWARE, dev->mt76.dev);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (!fw || !fw->data || fw->size < sizeof(*hdr)) {\n\t\terr = -EINVAL;\n\t\tgoto out;\n\t}\n\n\thdr = (const struct mt76x02_fw_header *)fw->data;\n\tilm_len = le32_to_cpu(hdr->ilm_len);\n\tdlm_len = le32_to_cpu(hdr->dlm_len);\n\tlen = sizeof(*hdr) + ilm_len + dlm_len;\n\tif (fw->size != len) {\n\t\terr = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tval = le16_to_cpu(hdr->fw_ver);\n\tdev_info(dev->mt76.dev, \"Firmware Version: %d.%d.%02d\\n\",\n\t\t (val >> 12) & 0xf, (val >> 8) & 0xf, val & 0xf);\n\n\tval = le16_to_cpu(hdr->build_ver);\n\tdev_info(dev->mt76.dev, \"Build: %x\\n\", val);\n\tdev_info(dev->mt76.dev, \"Build Time: %.16s\\n\", hdr->build_time);\n\n\t \n\tmt76x02u_mcu_fw_reset(dev);\n\tusleep_range(5000, 10000);\n\n\t \n\tval = MT_USB_DMA_CFG_RX_BULK_EN |\n\t      MT_USB_DMA_CFG_TX_BULK_EN |\n\t      FIELD_PREP(MT_USB_DMA_CFG_RX_BULK_AGG_TOUT, 0x20);\n\tmt76_wr(dev, MT_VEND_ADDR(CFG, MT_USB_U3DMA_CFG), val);\n\t \n\tmt76_wr(dev, MT_FCE_PSE_CTRL, 0x1);\n\t \n\tmt76_wr(dev, MT_TX_CPU_FROM_FCE_BASE_PTR, 0x400230);\n\t \n\tmt76_wr(dev, MT_TX_CPU_FROM_FCE_MAX_COUNT, 0x1);\n\t \n\tmt76_wr(dev, MT_FCE_PDMA_GLOBAL_CONF, 0x44);\n\t \n\tmt76_wr(dev, MT_FCE_SKIP_FS, 0x3);\n\n\t \n\terr = mt76x02u_mcu_fw_send_data(dev, fw->data + sizeof(*hdr),\n\t\t\t\t\tilm_len, MCU_FW_URB_MAX_PAYLOAD,\n\t\t\t\t\tMT76U_MCU_ILM_OFFSET);\n\tif (err < 0) {\n\t\terr = -EIO;\n\t\tgoto out;\n\t}\n\n\t \n\tif (mt76xx_rev(dev) >= MT76XX_REV_E3)\n\t\tdlm_offset += 0x800;\n\terr = mt76x02u_mcu_fw_send_data(dev, fw->data + sizeof(*hdr) + ilm_len,\n\t\t\t\t\tdlm_len, MCU_FW_URB_MAX_PAYLOAD,\n\t\t\t\t\tdlm_offset);\n\tif (err < 0) {\n\t\terr = -EIO;\n\t\tgoto out;\n\t}\n\n\tmt76x2u_mcu_load_ivb(dev);\n\tif (!mt76_poll_msec(dev, MT_MCU_COM_REG0, 1, 1, 100)) {\n\t\tdev_err(dev->mt76.dev, \"firmware failed to start\\n\");\n\t\terr = -ETIMEDOUT;\n\t\tgoto out;\n\t}\n\n\tmt76_set(dev, MT_MCU_COM_REG0, BIT(1));\n\t \n\tmt76_wr(dev, MT_FCE_PSE_CTRL, 0x1);\n\tmt76x02_set_ethtool_fwver(dev, hdr);\n\tdev_dbg(dev->mt76.dev, \"firmware running\\n\");\n\nout:\n\trelease_firmware(fw);\n\treturn err;\n}\n\nint mt76x2u_mcu_fw_init(struct mt76x02_dev *dev)\n{\n\tint err;\n\n\terr = mt76x2u_mcu_load_rom_patch(dev);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn mt76x2u_mcu_load_firmware(dev);\n}\n\nint mt76x2u_mcu_init(struct mt76x02_dev *dev)\n{\n\tint err;\n\n\terr = mt76x02_mcu_function_select(dev, Q_SELECT, 1);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn mt76x02_mcu_set_radio_state(dev, true);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}