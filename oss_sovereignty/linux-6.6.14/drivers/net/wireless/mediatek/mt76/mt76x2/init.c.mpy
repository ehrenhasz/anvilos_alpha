{
  "module_name": "init.c",
  "hash_id": "e29cf4bda893ed1cbb25b75b4f29a95a6cf2e7776f08e57607f29b5c7814e3a4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt76x2/init.c",
  "human_readable_source": "\n \n\n#include \"mt76x2.h\"\n#include \"eeprom.h\"\n#include \"../mt76x02_phy.h\"\n\nint mt76x2_set_sar_specs(struct ieee80211_hw *hw,\n\t\t\t const struct cfg80211_sar_specs *sar)\n{\n\tint err = -EINVAL, power = hw->conf.power_level * 2;\n\tstruct mt76x02_dev *dev = hw->priv;\n\tstruct mt76_phy *mphy = &dev->mphy;\n\n\tmutex_lock(&dev->mt76.mutex);\n\tif (!cfg80211_chandef_valid(&mphy->chandef))\n\t\tgoto out;\n\n\terr = mt76_init_sar_power(hw, sar);\n\tif (err)\n\t\tgoto out;\n\n\tdev->txpower_conf = mt76_get_sar_power(mphy, mphy->chandef.chan,\n\t\t\t\t\t       power);\n\t \n\tdev->txpower_conf -= 6;\n\n\tif (test_bit(MT76_STATE_RUNNING, &mphy->state))\n\t\tmt76x2_phy_set_txpower(dev);\nout:\n\tmutex_unlock(&dev->mt76.mutex);\n\n\treturn err;\n}\nEXPORT_SYMBOL_GPL(mt76x2_set_sar_specs);\n\nstatic void\nmt76x2_set_wlan_state(struct mt76x02_dev *dev, bool enable)\n{\n\tu32 val = mt76_rr(dev, MT_WLAN_FUN_CTRL);\n\n\tif (enable)\n\t\tval |= (MT_WLAN_FUN_CTRL_WLAN_EN |\n\t\t\tMT_WLAN_FUN_CTRL_WLAN_CLK_EN);\n\telse\n\t\tval &= ~(MT_WLAN_FUN_CTRL_WLAN_EN |\n\t\t\t MT_WLAN_FUN_CTRL_WLAN_CLK_EN);\n\n\tmt76_wr(dev, MT_WLAN_FUN_CTRL, val);\n\tudelay(20);\n}\n\nvoid mt76x2_reset_wlan(struct mt76x02_dev *dev, bool enable)\n{\n\tu32 val;\n\n\tif (!enable)\n\t\tgoto out;\n\n\tval = mt76_rr(dev, MT_WLAN_FUN_CTRL);\n\n\tval &= ~MT_WLAN_FUN_CTRL_FRC_WL_ANT_SEL;\n\n\tif (val & MT_WLAN_FUN_CTRL_WLAN_EN) {\n\t\tval |= MT_WLAN_FUN_CTRL_WLAN_RESET_RF;\n\t\tmt76_wr(dev, MT_WLAN_FUN_CTRL, val);\n\t\tudelay(20);\n\n\t\tval &= ~MT_WLAN_FUN_CTRL_WLAN_RESET_RF;\n\t}\n\n\tmt76_wr(dev, MT_WLAN_FUN_CTRL, val);\n\tudelay(20);\n\nout:\n\tmt76x2_set_wlan_state(dev, enable);\n}\nEXPORT_SYMBOL_GPL(mt76x2_reset_wlan);\n\nvoid mt76_write_mac_initvals(struct mt76x02_dev *dev)\n{\n#define DEFAULT_PROT_CFG_CCK\t\t\t\t\\\n\t(FIELD_PREP(MT_PROT_CFG_RATE, 0x3) |\t\t\\\n\t FIELD_PREP(MT_PROT_CFG_NAV, 1) |\t\t\\\n\t FIELD_PREP(MT_PROT_CFG_TXOP_ALLOW, 0x3f) |\t\\\n\t MT_PROT_CFG_RTS_THRESH)\n\n#define DEFAULT_PROT_CFG_OFDM\t\t\t\t\\\n\t(FIELD_PREP(MT_PROT_CFG_RATE, 0x2004) |\t\t\\\n\t FIELD_PREP(MT_PROT_CFG_NAV, 1) |\t\t\t\\\n\t FIELD_PREP(MT_PROT_CFG_TXOP_ALLOW, 0x3f) |\t\\\n\t MT_PROT_CFG_RTS_THRESH)\n\n#define DEFAULT_PROT_CFG_20\t\t\t\t\\\n\t(FIELD_PREP(MT_PROT_CFG_RATE, 0x2004) |\t\t\\\n\t FIELD_PREP(MT_PROT_CFG_CTRL, 1) |\t\t\\\n\t FIELD_PREP(MT_PROT_CFG_NAV, 1) |\t\t\t\\\n\t FIELD_PREP(MT_PROT_CFG_TXOP_ALLOW, 0x17))\n\n#define DEFAULT_PROT_CFG_40\t\t\t\t\\\n\t(FIELD_PREP(MT_PROT_CFG_RATE, 0x2084) |\t\t\\\n\t FIELD_PREP(MT_PROT_CFG_CTRL, 1) |\t\t\\\n\t FIELD_PREP(MT_PROT_CFG_NAV, 1) |\t\t\t\\\n\t FIELD_PREP(MT_PROT_CFG_TXOP_ALLOW, 0x3f))\n\n\tstatic const struct mt76_reg_pair vals[] = {\n\t\t \n\t\t{ MT_PBF_SYS_CTRL,\t\t0x00080c00 },\n\t\t{ MT_PBF_CFG,\t\t\t0x1efebcff },\n\t\t{ MT_FCE_PSE_CTRL,\t\t0x00000001 },\n\t\t{ MT_MAC_SYS_CTRL,\t\t0x00000000 },\n\t\t{ MT_MAX_LEN_CFG,\t\t0x003e3f00 },\n\t\t{ MT_AMPDU_MAX_LEN_20M1S,\t0xaaa99887 },\n\t\t{ MT_AMPDU_MAX_LEN_20M2S,\t0x000000aa },\n\t\t{ MT_XIFS_TIME_CFG,\t\t0x33a40d0a },\n\t\t{ MT_BKOFF_SLOT_CFG,\t\t0x00000209 },\n\t\t{ MT_TBTT_SYNC_CFG,\t\t0x00422010 },\n\t\t{ MT_PWR_PIN_CFG,\t\t0x00000000 },\n\t\t{ 0x1238,\t\t\t0x001700c8 },\n\t\t{ MT_TX_SW_CFG0,\t\t0x00101001 },\n\t\t{ MT_TX_SW_CFG1,\t\t0x00010000 },\n\t\t{ MT_TX_SW_CFG2,\t\t0x00000000 },\n\t\t{ MT_TXOP_CTRL_CFG,\t\t0x0400583f },\n\t\t{ MT_TX_RTS_CFG,\t\t0x00ffff20 },\n\t\t{ MT_TX_TIMEOUT_CFG,\t\t0x000a2290 },\n\t\t{ MT_TX_RETRY_CFG,\t\t0x47f01f0f },\n\t\t{ MT_EXP_ACK_TIME,\t\t0x002c00dc },\n\t\t{ MT_TX_PROT_CFG6,\t\t0xe3f42004 },\n\t\t{ MT_TX_PROT_CFG7,\t\t0xe3f42084 },\n\t\t{ MT_TX_PROT_CFG8,\t\t0xe3f42104 },\n\t\t{ MT_PIFS_TX_CFG,\t\t0x00060fff },\n\t\t{ MT_RX_FILTR_CFG,\t\t0x00015f97 },\n\t\t{ MT_LEGACY_BASIC_RATE,\t\t0x0000017f },\n\t\t{ MT_HT_BASIC_RATE,\t\t0x00004003 },\n\t\t{ MT_PN_PAD_MODE,\t\t0x00000003 },\n\t\t{ MT_TXOP_HLDR_ET,\t\t0x00000002 },\n\t\t{ 0xa44,\t\t\t0x00000000 },\n\t\t{ MT_HEADER_TRANS_CTRL_REG,\t0x00000000 },\n\t\t{ MT_TSO_CTRL,\t\t\t0x00000000 },\n\t\t{ MT_AUX_CLK_CFG,\t\t0x00000000 },\n\t\t{ MT_DACCLK_EN_DLY_CFG,\t\t0x00000000 },\n\t\t{ MT_TX_ALC_CFG_4,\t\t0x00000000 },\n\t\t{ MT_TX_ALC_VGA3,\t\t0x00000000 },\n\t\t{ MT_TX_PWR_CFG_0,\t\t0x3a3a3a3a },\n\t\t{ MT_TX_PWR_CFG_1,\t\t0x3a3a3a3a },\n\t\t{ MT_TX_PWR_CFG_2,\t\t0x3a3a3a3a },\n\t\t{ MT_TX_PWR_CFG_3,\t\t0x3a3a3a3a },\n\t\t{ MT_TX_PWR_CFG_4,\t\t0x3a3a3a3a },\n\t\t{ MT_TX_PWR_CFG_7,\t\t0x3a3a3a3a },\n\t\t{ MT_TX_PWR_CFG_8,\t\t0x0000003a },\n\t\t{ MT_TX_PWR_CFG_9,\t\t0x0000003a },\n\t\t{ MT_EFUSE_CTRL,\t\t0x0000d000 },\n\t\t{ MT_PAUSE_ENABLE_CONTROL1,\t0x0000000a },\n\t\t{ MT_FCE_WLAN_FLOW_CONTROL1,\t0x60401c18 },\n\t\t{ MT_WPDMA_DELAY_INT_CFG,\t0x94ff0000 },\n\t\t{ MT_TX_SW_CFG3,\t\t0x00000004 },\n\t\t{ MT_HT_FBK_TO_LEGACY,\t\t0x00001818 },\n\t\t{ MT_VHT_HT_FBK_CFG1,\t\t0xedcba980 },\n\t\t{ MT_PROT_AUTO_TX_CFG,\t\t0x00830083 },\n\t\t{ MT_HT_CTRL_CFG,\t\t0x000001ff },\n\t\t{ MT_TX_LINK_CFG,\t\t0x00001020 },\n\t};\n\tstruct mt76_reg_pair prot_vals[] = {\n\t\t{ MT_CCK_PROT_CFG,\t\tDEFAULT_PROT_CFG_CCK },\n\t\t{ MT_OFDM_PROT_CFG,\t\tDEFAULT_PROT_CFG_OFDM },\n\t\t{ MT_MM20_PROT_CFG,\t\tDEFAULT_PROT_CFG_20 },\n\t\t{ MT_MM40_PROT_CFG,\t\tDEFAULT_PROT_CFG_40 },\n\t\t{ MT_GF20_PROT_CFG,\t\tDEFAULT_PROT_CFG_20 },\n\t\t{ MT_GF40_PROT_CFG,\t\tDEFAULT_PROT_CFG_40 },\n\t};\n\n\tmt76_wr_rp(dev, 0, vals, ARRAY_SIZE(vals));\n\tmt76_wr_rp(dev, 0, prot_vals, ARRAY_SIZE(prot_vals));\n}\nEXPORT_SYMBOL_GPL(mt76_write_mac_initvals);\n\nvoid mt76x2_init_txpower(struct mt76x02_dev *dev,\n\t\t\t struct ieee80211_supported_band *sband)\n{\n\tstruct ieee80211_channel *chan;\n\tstruct mt76x2_tx_power_info txp;\n\tstruct mt76x02_rate_power t = {};\n\tint i;\n\n\tfor (i = 0; i < sband->n_channels; i++) {\n\t\tchan = &sband->channels[i];\n\n\t\tmt76x2_get_power_info(dev, &txp, chan);\n\t\tmt76x2_get_rate_power(dev, &t, chan);\n\n\t\tchan->orig_mpwr = mt76x02_get_max_rate_power(&t) +\n\t\t\t\t  txp.target_power;\n\t\tchan->orig_mpwr = DIV_ROUND_UP(chan->orig_mpwr, 2);\n\n\t\t \n\t\tchan->orig_mpwr += 3;\n\t\tchan->max_power = min_t(int, chan->max_reg_power,\n\t\t\t\t\tchan->orig_mpwr);\n\t}\n}\nEXPORT_SYMBOL_GPL(mt76x2_init_txpower);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}