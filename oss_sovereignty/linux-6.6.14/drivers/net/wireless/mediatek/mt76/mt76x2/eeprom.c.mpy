{
  "module_name": "eeprom.c",
  "hash_id": "5808f708c930c956b4082b1f884a23aae2c02ab0fa11ac7637990e9d308e6995",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt76x2/eeprom.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/of.h>\n#include <asm/unaligned.h>\n#include \"mt76x2.h\"\n#include \"eeprom.h\"\n\n#define EE_FIELD(_name, _value) [MT_EE_##_name] = (_value) | 1\n\nstatic int\nmt76x2_eeprom_get_macaddr(struct mt76x02_dev *dev)\n{\n\tvoid *src = dev->mt76.eeprom.data + MT_EE_MAC_ADDR;\n\n\tmemcpy(dev->mphy.macaddr, src, ETH_ALEN);\n\treturn 0;\n}\n\nstatic bool\nmt76x2_has_cal_free_data(struct mt76x02_dev *dev, u8 *efuse)\n{\n\tu16 *efuse_w = (u16 *)efuse;\n\n\tif (efuse_w[MT_EE_NIC_CONF_0] != 0)\n\t\treturn false;\n\n\tif (efuse_w[MT_EE_XTAL_TRIM_1] == 0xffff)\n\t\treturn false;\n\n\tif (efuse_w[MT_EE_TX_POWER_DELTA_BW40] != 0)\n\t\treturn false;\n\n\tif (efuse_w[MT_EE_TX_POWER_0_START_2G] == 0xffff)\n\t\treturn false;\n\n\tif (efuse_w[MT_EE_TX_POWER_0_GRP3_TX_POWER_DELTA] != 0)\n\t\treturn false;\n\n\tif (efuse_w[MT_EE_TX_POWER_0_GRP4_TSSI_SLOPE] == 0xffff)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic void\nmt76x2_apply_cal_free_data(struct mt76x02_dev *dev, u8 *efuse)\n{\n#define GROUP_5G(_id)\t\t\t\t\t\t\t   \\\n\tMT_EE_TX_POWER_0_START_5G + MT_TX_POWER_GROUP_SIZE_5G * (_id),\t   \\\n\tMT_EE_TX_POWER_0_START_5G + MT_TX_POWER_GROUP_SIZE_5G * (_id) + 1, \\\n\tMT_EE_TX_POWER_1_START_5G + MT_TX_POWER_GROUP_SIZE_5G * (_id),\t   \\\n\tMT_EE_TX_POWER_1_START_5G + MT_TX_POWER_GROUP_SIZE_5G * (_id) + 1\n\n\tstatic const u8 cal_free_bytes[] = {\n\t\tMT_EE_XTAL_TRIM_1,\n\t\tMT_EE_TX_POWER_EXT_PA_5G + 1,\n\t\tMT_EE_TX_POWER_0_START_2G,\n\t\tMT_EE_TX_POWER_0_START_2G + 1,\n\t\tMT_EE_TX_POWER_1_START_2G,\n\t\tMT_EE_TX_POWER_1_START_2G + 1,\n\t\tGROUP_5G(0),\n\t\tGROUP_5G(1),\n\t\tGROUP_5G(2),\n\t\tGROUP_5G(3),\n\t\tGROUP_5G(4),\n\t\tGROUP_5G(5),\n\t\tMT_EE_RF_2G_TSSI_OFF_TXPOWER,\n\t\tMT_EE_RF_2G_RX_HIGH_GAIN + 1,\n\t\tMT_EE_RF_5G_GRP0_1_RX_HIGH_GAIN,\n\t\tMT_EE_RF_5G_GRP0_1_RX_HIGH_GAIN + 1,\n\t\tMT_EE_RF_5G_GRP2_3_RX_HIGH_GAIN,\n\t\tMT_EE_RF_5G_GRP2_3_RX_HIGH_GAIN + 1,\n\t\tMT_EE_RF_5G_GRP4_5_RX_HIGH_GAIN,\n\t\tMT_EE_RF_5G_GRP4_5_RX_HIGH_GAIN + 1,\n\t};\n\tstruct device_node *np = dev->mt76.dev->of_node;\n\tu8 *eeprom = dev->mt76.eeprom.data;\n\tu8 prev_grp0[4] = {\n\t\teeprom[MT_EE_TX_POWER_0_START_5G],\n\t\teeprom[MT_EE_TX_POWER_0_START_5G + 1],\n\t\teeprom[MT_EE_TX_POWER_1_START_5G],\n\t\teeprom[MT_EE_TX_POWER_1_START_5G + 1]\n\t};\n\tu16 val;\n\tint i;\n\n\tif (!np || !of_property_read_bool(np, \"mediatek,eeprom-merge-otp\"))\n\t\treturn;\n\n\tif (!mt76x2_has_cal_free_data(dev, efuse))\n\t\treturn;\n\n\tfor (i = 0; i < ARRAY_SIZE(cal_free_bytes); i++) {\n\t\tint offset = cal_free_bytes[i];\n\n\t\teeprom[offset] = efuse[offset];\n\t}\n\n\tif (!(efuse[MT_EE_TX_POWER_0_START_5G] |\n\t      efuse[MT_EE_TX_POWER_0_START_5G + 1]))\n\t\tmemcpy(eeprom + MT_EE_TX_POWER_0_START_5G, prev_grp0, 2);\n\tif (!(efuse[MT_EE_TX_POWER_1_START_5G] |\n\t      efuse[MT_EE_TX_POWER_1_START_5G + 1]))\n\t\tmemcpy(eeprom + MT_EE_TX_POWER_1_START_5G, prev_grp0 + 2, 2);\n\n\tval = get_unaligned_le16(efuse + MT_EE_BT_RCAL_RESULT);\n\tif (val != 0xffff)\n\t\teeprom[MT_EE_BT_RCAL_RESULT] = val & 0xff;\n\n\tval = get_unaligned_le16(efuse + MT_EE_BT_VCDL_CALIBRATION);\n\tif (val != 0xffff)\n\t\teeprom[MT_EE_BT_VCDL_CALIBRATION + 1] = val >> 8;\n\n\tval = get_unaligned_le16(efuse + MT_EE_BT_PMUCFG);\n\tif (val != 0xffff)\n\t\teeprom[MT_EE_BT_PMUCFG] = val & 0xff;\n}\n\nstatic int mt76x2_check_eeprom(struct mt76x02_dev *dev)\n{\n\tu16 val = get_unaligned_le16(dev->mt76.eeprom.data);\n\n\tif (!val)\n\t\tval = get_unaligned_le16(dev->mt76.eeprom.data + MT_EE_PCI_ID);\n\n\tswitch (val) {\n\tcase 0x7662:\n\tcase 0x7612:\n\t\treturn 0;\n\tdefault:\n\t\tdev_err(dev->mt76.dev, \"EEPROM data check failed: %04x\\n\", val);\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int\nmt76x2_eeprom_load(struct mt76x02_dev *dev)\n{\n\tvoid *efuse;\n\tbool found;\n\tint ret;\n\n\tret = mt76_eeprom_init(&dev->mt76, MT7662_EEPROM_SIZE);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfound = ret;\n\tif (found)\n\t\tfound = !mt76x2_check_eeprom(dev);\n\n\tdev->mt76.otp.data = devm_kzalloc(dev->mt76.dev, MT7662_EEPROM_SIZE,\n\t\t\t\t\t  GFP_KERNEL);\n\tdev->mt76.otp.size = MT7662_EEPROM_SIZE;\n\tif (!dev->mt76.otp.data)\n\t\treturn -ENOMEM;\n\n\tefuse = dev->mt76.otp.data;\n\n\tif (mt76x02_get_efuse_data(dev, 0, efuse, MT7662_EEPROM_SIZE,\n\t\t\t\t   MT_EE_READ))\n\t\tgoto out;\n\n\tif (found) {\n\t\tmt76x2_apply_cal_free_data(dev, efuse);\n\t} else {\n\t\t \n\t\tfound = true;\n\t\tmemcpy(dev->mt76.eeprom.data, efuse, MT7662_EEPROM_SIZE);\n\t}\n\nout:\n\tif (!found)\n\t\treturn -ENOENT;\n\n\treturn 0;\n}\n\nstatic void\nmt76x2_set_rx_gain_group(struct mt76x02_dev *dev, u8 val)\n{\n\ts8 *dest = dev->cal.rx.high_gain;\n\n\tif (!mt76x02_field_valid(val)) {\n\t\tdest[0] = 0;\n\t\tdest[1] = 0;\n\t\treturn;\n\t}\n\n\tdest[0] = mt76x02_sign_extend(val, 4);\n\tdest[1] = mt76x02_sign_extend(val >> 4, 4);\n}\n\nstatic void\nmt76x2_set_rssi_offset(struct mt76x02_dev *dev, int chain, u8 val)\n{\n\ts8 *dest = dev->cal.rx.rssi_offset;\n\n\tif (!mt76x02_field_valid(val)) {\n\t\tdest[chain] = 0;\n\t\treturn;\n\t}\n\n\tdest[chain] = mt76x02_sign_extend_optional(val, 7);\n}\n\nstatic enum mt76x2_cal_channel_group\nmt76x2_get_cal_channel_group(int channel)\n{\n\tif (channel >= 184 && channel <= 196)\n\t\treturn MT_CH_5G_JAPAN;\n\tif (channel <= 48)\n\t\treturn MT_CH_5G_UNII_1;\n\tif (channel <= 64)\n\t\treturn MT_CH_5G_UNII_2;\n\tif (channel <= 114)\n\t\treturn MT_CH_5G_UNII_2E_1;\n\tif (channel <= 144)\n\t\treturn MT_CH_5G_UNII_2E_2;\n\treturn MT_CH_5G_UNII_3;\n}\n\nstatic u8\nmt76x2_get_5g_rx_gain(struct mt76x02_dev *dev, u8 channel)\n{\n\tenum mt76x2_cal_channel_group group;\n\n\tgroup = mt76x2_get_cal_channel_group(channel);\n\tswitch (group) {\n\tcase MT_CH_5G_JAPAN:\n\t\treturn mt76x02_eeprom_get(dev,\n\t\t\t\t\t  MT_EE_RF_5G_GRP0_1_RX_HIGH_GAIN);\n\tcase MT_CH_5G_UNII_1:\n\t\treturn mt76x02_eeprom_get(dev,\n\t\t\t\t\t  MT_EE_RF_5G_GRP0_1_RX_HIGH_GAIN) >> 8;\n\tcase MT_CH_5G_UNII_2:\n\t\treturn mt76x02_eeprom_get(dev,\n\t\t\t\t\t  MT_EE_RF_5G_GRP2_3_RX_HIGH_GAIN);\n\tcase MT_CH_5G_UNII_2E_1:\n\t\treturn mt76x02_eeprom_get(dev,\n\t\t\t\t\t  MT_EE_RF_5G_GRP2_3_RX_HIGH_GAIN) >> 8;\n\tcase MT_CH_5G_UNII_2E_2:\n\t\treturn mt76x02_eeprom_get(dev,\n\t\t\t\t\t  MT_EE_RF_5G_GRP4_5_RX_HIGH_GAIN);\n\tdefault:\n\t\treturn mt76x02_eeprom_get(dev,\n\t\t\t\t\t  MT_EE_RF_5G_GRP4_5_RX_HIGH_GAIN) >> 8;\n\t}\n}\n\nvoid mt76x2_read_rx_gain(struct mt76x02_dev *dev)\n{\n\tstruct ieee80211_channel *chan = dev->mphy.chandef.chan;\n\tint channel = chan->hw_value;\n\ts8 lna_5g[3], lna_2g;\n\tbool use_lna;\n\tu8 lna = 0;\n\tu16 val;\n\n\tif (chan->band == NL80211_BAND_2GHZ)\n\t\tval = mt76x02_eeprom_get(dev, MT_EE_RF_2G_RX_HIGH_GAIN) >> 8;\n\telse\n\t\tval = mt76x2_get_5g_rx_gain(dev, channel);\n\n\tmt76x2_set_rx_gain_group(dev, val);\n\n\tmt76x02_get_rx_gain(dev, chan->band, &val, &lna_2g, lna_5g);\n\tmt76x2_set_rssi_offset(dev, 0, val);\n\tmt76x2_set_rssi_offset(dev, 1, val >> 8);\n\n\tdev->cal.rx.mcu_gain =  (lna_2g & 0xff);\n\tdev->cal.rx.mcu_gain |= (lna_5g[0] & 0xff) << 8;\n\tdev->cal.rx.mcu_gain |= (lna_5g[1] & 0xff) << 16;\n\tdev->cal.rx.mcu_gain |= (lna_5g[2] & 0xff) << 24;\n\n\tval = mt76x02_eeprom_get(dev, MT_EE_NIC_CONF_1);\n\tif (chan->band == NL80211_BAND_2GHZ)\n\t\tuse_lna = !(val & MT_EE_NIC_CONF_1_LNA_EXT_2G);\n\telse\n\t\tuse_lna = !(val & MT_EE_NIC_CONF_1_LNA_EXT_5G);\n\n\tif (use_lna)\n\t\tlna = mt76x02_get_lna_gain(dev, &lna_2g, lna_5g, chan);\n\n\tdev->cal.rx.lna_gain = mt76x02_sign_extend(lna, 8);\n}\nEXPORT_SYMBOL_GPL(mt76x2_read_rx_gain);\n\nvoid mt76x2_get_rate_power(struct mt76x02_dev *dev, struct mt76x02_rate_power *t,\n\t\t\t   struct ieee80211_channel *chan)\n{\n\tbool is_5ghz;\n\tu16 val;\n\n\tis_5ghz = chan->band == NL80211_BAND_5GHZ;\n\n\tmemset(t, 0, sizeof(*t));\n\n\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_CCK);\n\tt->cck[0] = t->cck[1] = mt76x02_rate_power_val(val);\n\tt->cck[2] = t->cck[3] = mt76x02_rate_power_val(val >> 8);\n\n\tif (is_5ghz)\n\t\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_OFDM_5G_6M);\n\telse\n\t\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_OFDM_2G_6M);\n\tt->ofdm[0] = t->ofdm[1] = mt76x02_rate_power_val(val);\n\tt->ofdm[2] = t->ofdm[3] = mt76x02_rate_power_val(val >> 8);\n\n\tif (is_5ghz)\n\t\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_OFDM_5G_24M);\n\telse\n\t\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_OFDM_2G_24M);\n\tt->ofdm[4] = t->ofdm[5] = mt76x02_rate_power_val(val);\n\tt->ofdm[6] = t->ofdm[7] = mt76x02_rate_power_val(val >> 8);\n\n\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_HT_MCS0);\n\tt->ht[0] = t->ht[1] = mt76x02_rate_power_val(val);\n\tt->ht[2] = t->ht[3] = mt76x02_rate_power_val(val >> 8);\n\n\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_HT_MCS4);\n\tt->ht[4] = t->ht[5] = mt76x02_rate_power_val(val);\n\tt->ht[6] = t->ht[7] = mt76x02_rate_power_val(val >> 8);\n\n\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_HT_MCS8);\n\tt->ht[8] = t->ht[9] = mt76x02_rate_power_val(val);\n\tt->ht[10] = t->ht[11] = mt76x02_rate_power_val(val >> 8);\n\n\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_HT_MCS12);\n\tt->ht[12] = t->ht[13] = mt76x02_rate_power_val(val);\n\tt->ht[14] = t->ht[15] = mt76x02_rate_power_val(val >> 8);\n\n\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_VHT_MCS8);\n\tif (!is_5ghz)\n\t\tval >>= 8;\n\tt->vht[0] = t->vht[1] = mt76x02_rate_power_val(val >> 8);\n}\nEXPORT_SYMBOL_GPL(mt76x2_get_rate_power);\n\nstatic void\nmt76x2_get_power_info_2g(struct mt76x02_dev *dev,\n\t\t\t struct mt76x2_tx_power_info *t,\n\t\t\t struct ieee80211_channel *chan,\n\t\t\t int chain, int offset)\n{\n\tint channel = chan->hw_value;\n\tint delta_idx;\n\tu8 data[6];\n\tu16 val;\n\n\tif (channel < 6)\n\t\tdelta_idx = 3;\n\telse if (channel < 11)\n\t\tdelta_idx = 4;\n\telse\n\t\tdelta_idx = 5;\n\n\tmt76x02_eeprom_copy(dev, offset, data, sizeof(data));\n\n\tt->chain[chain].tssi_slope = data[0];\n\tt->chain[chain].tssi_offset = data[1];\n\tt->chain[chain].target_power = data[2];\n\tt->chain[chain].delta =\n\t\tmt76x02_sign_extend_optional(data[delta_idx], 7);\n\n\tval = mt76x02_eeprom_get(dev, MT_EE_RF_2G_TSSI_OFF_TXPOWER);\n\tt->target_power = val >> 8;\n}\n\nstatic void\nmt76x2_get_power_info_5g(struct mt76x02_dev *dev,\n\t\t\t struct mt76x2_tx_power_info *t,\n\t\t\t struct ieee80211_channel *chan,\n\t\t\t int chain, int offset)\n{\n\tint channel = chan->hw_value;\n\tenum mt76x2_cal_channel_group group;\n\tint delta_idx;\n\tu16 val;\n\tu8 data[5];\n\n\tgroup = mt76x2_get_cal_channel_group(channel);\n\toffset += group * MT_TX_POWER_GROUP_SIZE_5G;\n\n\tif (channel >= 192)\n\t\tdelta_idx = 4;\n\telse if (channel >= 184)\n\t\tdelta_idx = 3;\n\telse if (channel < 44)\n\t\tdelta_idx = 3;\n\telse if (channel < 52)\n\t\tdelta_idx = 4;\n\telse if (channel < 58)\n\t\tdelta_idx = 3;\n\telse if (channel < 98)\n\t\tdelta_idx = 4;\n\telse if (channel < 106)\n\t\tdelta_idx = 3;\n\telse if (channel < 116)\n\t\tdelta_idx = 4;\n\telse if (channel < 130)\n\t\tdelta_idx = 3;\n\telse if (channel < 149)\n\t\tdelta_idx = 4;\n\telse if (channel < 157)\n\t\tdelta_idx = 3;\n\telse\n\t\tdelta_idx = 4;\n\n\tmt76x02_eeprom_copy(dev, offset, data, sizeof(data));\n\n\tt->chain[chain].tssi_slope = data[0];\n\tt->chain[chain].tssi_offset = data[1];\n\tt->chain[chain].target_power = data[2];\n\tt->chain[chain].delta =\n\t\tmt76x02_sign_extend_optional(data[delta_idx], 7);\n\n\tval = mt76x02_eeprom_get(dev, MT_EE_RF_2G_RX_HIGH_GAIN);\n\tt->target_power = val & 0xff;\n}\n\nvoid mt76x2_get_power_info(struct mt76x02_dev *dev,\n\t\t\t   struct mt76x2_tx_power_info *t,\n\t\t\t   struct ieee80211_channel *chan)\n{\n\tu16 bw40, bw80;\n\n\tmemset(t, 0, sizeof(*t));\n\n\tbw40 = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_DELTA_BW40);\n\tbw80 = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_DELTA_BW80);\n\n\tif (chan->band == NL80211_BAND_5GHZ) {\n\t\tbw40 >>= 8;\n\t\tmt76x2_get_power_info_5g(dev, t, chan, 0,\n\t\t\t\t\t MT_EE_TX_POWER_0_START_5G);\n\t\tmt76x2_get_power_info_5g(dev, t, chan, 1,\n\t\t\t\t\t MT_EE_TX_POWER_1_START_5G);\n\t} else {\n\t\tmt76x2_get_power_info_2g(dev, t, chan, 0,\n\t\t\t\t\t MT_EE_TX_POWER_0_START_2G);\n\t\tmt76x2_get_power_info_2g(dev, t, chan, 1,\n\t\t\t\t\t MT_EE_TX_POWER_1_START_2G);\n\t}\n\n\tif (mt76x2_tssi_enabled(dev) ||\n\t    !mt76x02_field_valid(t->target_power))\n\t\tt->target_power = t->chain[0].target_power;\n\n\tt->delta_bw40 = mt76x02_rate_power_val(bw40);\n\tt->delta_bw80 = mt76x02_rate_power_val(bw80);\n}\nEXPORT_SYMBOL_GPL(mt76x2_get_power_info);\n\nint mt76x2_get_temp_comp(struct mt76x02_dev *dev, struct mt76x2_temp_comp *t)\n{\n\tenum nl80211_band band = dev->mphy.chandef.chan->band;\n\tu16 val, slope;\n\tu8 bounds;\n\n\tmemset(t, 0, sizeof(*t));\n\n\tif (!mt76x2_temp_tx_alc_enabled(dev))\n\t\treturn -EINVAL;\n\n\tif (!mt76x02_ext_pa_enabled(dev, band))\n\t\treturn -EINVAL;\n\n\tval = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_EXT_PA_5G) >> 8;\n\tt->temp_25_ref = val & 0x7f;\n\tif (band == NL80211_BAND_5GHZ) {\n\t\tslope = mt76x02_eeprom_get(dev, MT_EE_RF_TEMP_COMP_SLOPE_5G);\n\t\tbounds = mt76x02_eeprom_get(dev, MT_EE_TX_POWER_EXT_PA_5G);\n\t} else {\n\t\tslope = mt76x02_eeprom_get(dev, MT_EE_RF_TEMP_COMP_SLOPE_2G);\n\t\tbounds = mt76x02_eeprom_get(dev,\n\t\t\t\t\t    MT_EE_TX_POWER_DELTA_BW80) >> 8;\n\t}\n\n\tt->high_slope = slope & 0xff;\n\tt->low_slope = slope >> 8;\n\tt->lower_bound = 0 - (bounds & 0xf);\n\tt->upper_bound = (bounds >> 4) & 0xf;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt76x2_get_temp_comp);\n\nint mt76x2_eeprom_init(struct mt76x02_dev *dev)\n{\n\tint ret;\n\n\tret = mt76x2_eeprom_load(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tmt76x02_eeprom_parse_hw_cap(dev);\n\tmt76x2_eeprom_get_macaddr(dev);\n\tmt76_eeprom_override(&dev->mphy);\n\tdev->mphy.macaddr[0] &= ~BIT(1);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt76x2_eeprom_init);\n\nMODULE_LICENSE(\"Dual BSD/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}