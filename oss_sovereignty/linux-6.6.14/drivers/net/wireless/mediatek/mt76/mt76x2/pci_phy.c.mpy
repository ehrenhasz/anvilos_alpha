{
  "module_name": "pci_phy.c",
  "hash_id": "040876010b982cc03fd99246c9384f588b3e49cac3dff3d2248789779fbfbe28",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt76x2/pci_phy.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include \"mt76x2.h\"\n#include \"mcu.h\"\n#include \"eeprom.h\"\n#include \"../mt76x02_phy.h\"\n\nstatic bool\nmt76x2_phy_tssi_init_cal(struct mt76x02_dev *dev)\n{\n\tstruct ieee80211_channel *chan = dev->mphy.chandef.chan;\n\tu32 flag = 0;\n\n\tif (!mt76x2_tssi_enabled(dev))\n\t\treturn false;\n\n\tif (mt76x2_channel_silent(dev))\n\t\treturn false;\n\n\tif (chan->band == NL80211_BAND_5GHZ)\n\t\tflag |= BIT(0);\n\n\tif (mt76x02_ext_pa_enabled(dev, chan->band))\n\t\tflag |= BIT(8);\n\n\tmt76x02_mcu_calibrate(dev, MCU_CAL_TSSI, flag);\n\tdev->cal.tssi_cal_done = true;\n\treturn true;\n}\n\nstatic void\nmt76x2_phy_channel_calibrate(struct mt76x02_dev *dev, bool mac_stopped)\n{\n\tstruct ieee80211_channel *chan = dev->mphy.chandef.chan;\n\tbool is_5ghz = chan->band == NL80211_BAND_5GHZ;\n\n\tif (dev->cal.channel_cal_done)\n\t\treturn;\n\n\tif (mt76x2_channel_silent(dev))\n\t\treturn;\n\n\tif (!dev->cal.tssi_cal_done)\n\t\tmt76x2_phy_tssi_init_cal(dev);\n\n\tif (!mac_stopped)\n\t\tmt76x2_mac_stop(dev, false);\n\n\tif (is_5ghz)\n\t\tmt76x02_mcu_calibrate(dev, MCU_CAL_LC, 0);\n\n\tmt76x02_mcu_calibrate(dev, MCU_CAL_TX_LOFT, is_5ghz);\n\tmt76x02_mcu_calibrate(dev, MCU_CAL_TXIQ, is_5ghz);\n\tmt76x02_mcu_calibrate(dev, MCU_CAL_RXIQC_FI, is_5ghz);\n\tmt76x02_mcu_calibrate(dev, MCU_CAL_TEMP_SENSOR, 0);\n\tmt76x02_mcu_calibrate(dev, MCU_CAL_TX_SHAPING, 0);\n\n\tif (!mac_stopped)\n\t\tmt76x2_mac_resume(dev);\n\n\tmt76x2_apply_gain_adj(dev);\n\tmt76x02_edcca_init(dev);\n\n\tdev->cal.channel_cal_done = true;\n}\n\nvoid mt76x2_phy_set_antenna(struct mt76x02_dev *dev)\n{\n\tu32 val;\n\n\tval = mt76_rr(dev, MT_BBP(AGC, 0));\n\tval &= ~(BIT(4) | BIT(1));\n\tswitch (dev->mphy.antenna_mask) {\n\tcase 1:\n\t\t \n\t\tmt76_clear(dev, MT_BBP(IBI, 9), BIT(11));\n\t\tmt76_clear(dev, MT_BBP(TXBE, 5), 3);\n\t\tmt76_rmw_field(dev, MT_TX_PIN_CFG, MT_TX_PIN_CFG_TXANT, 0x3);\n\t\tmt76_rmw_field(dev, MT_BBP(CORE, 32), GENMASK(21, 20), 2);\n\t\t \n\t\tmt76_rmw_field(dev, MT_BBP(CORE, 33), GENMASK(12, 9), 4);\n\n\t\tval &= ~(BIT(3) | BIT(0));\n\t\tbreak;\n\tcase 2:\n\t\t \n\t\tmt76_clear(dev, MT_BBP(IBI, 9), BIT(11));\n\t\tmt76_rmw_field(dev, MT_BBP(TXBE, 5), 3, 1);\n\t\tmt76_rmw_field(dev, MT_TX_PIN_CFG, MT_TX_PIN_CFG_TXANT, 0xc);\n\t\tmt76_rmw_field(dev, MT_BBP(CORE, 32), GENMASK(21, 20), 1);\n\t\t \n\t\tmt76_rmw_field(dev, MT_BBP(CORE, 33), GENMASK(12, 9), 1);\n\n\t\tval &= ~BIT(3);\n\t\tval |= BIT(0);\n\t\tbreak;\n\tcase 3:\n\tdefault:\n\t\t \n\t\tmt76_set(dev, MT_BBP(IBI, 9), BIT(11));\n\t\tmt76_set(dev, MT_BBP(TXBE, 5), 3);\n\t\tmt76_rmw_field(dev, MT_TX_PIN_CFG, MT_TX_PIN_CFG_TXANT, 0xf);\n\t\tmt76_clear(dev, MT_BBP(CORE, 32), GENMASK(21, 20));\n\t\tmt76_clear(dev, MT_BBP(CORE, 33), GENMASK(12, 9));\n\n\t\tval &= ~BIT(0);\n\t\tval |= BIT(3);\n\t\tbreak;\n\t}\n\tmt76_wr(dev, MT_BBP(AGC, 0), val);\n}\n\nint mt76x2_phy_set_channel(struct mt76x02_dev *dev,\n\t\t\t   struct cfg80211_chan_def *chandef)\n{\n\tstruct ieee80211_channel *chan = chandef->chan;\n\tbool scan = test_bit(MT76_SCANNING, &dev->mphy.state);\n\tenum nl80211_band band = chan->band;\n\tu8 channel;\n\n\tu32 ext_cca_chan[4] = {\n\t\t[0] = FIELD_PREP(MT_EXT_CCA_CFG_CCA0, 0) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA1, 1) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA2, 2) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA3, 3) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA_MASK, BIT(0)),\n\t\t[1] = FIELD_PREP(MT_EXT_CCA_CFG_CCA0, 1) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA1, 0) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA2, 2) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA3, 3) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA_MASK, BIT(1)),\n\t\t[2] = FIELD_PREP(MT_EXT_CCA_CFG_CCA0, 2) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA1, 3) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA2, 1) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA3, 0) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA_MASK, BIT(2)),\n\t\t[3] = FIELD_PREP(MT_EXT_CCA_CFG_CCA0, 3) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA1, 2) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA2, 1) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA3, 0) |\n\t\t      FIELD_PREP(MT_EXT_CCA_CFG_CCA_MASK, BIT(3)),\n\t};\n\tint ch_group_index;\n\tu8 bw, bw_index;\n\tint freq, freq1;\n\tint ret;\n\n\tdev->cal.channel_cal_done = false;\n\tfreq = chandef->chan->center_freq;\n\tfreq1 = chandef->center_freq1;\n\tchannel = chan->hw_value;\n\n\tswitch (chandef->width) {\n\tcase NL80211_CHAN_WIDTH_40:\n\t\tbw = 1;\n\t\tif (freq1 > freq) {\n\t\t\tbw_index = 1;\n\t\t\tch_group_index = 0;\n\t\t} else {\n\t\t\tbw_index = 3;\n\t\t\tch_group_index = 1;\n\t\t}\n\t\tchannel += 2 - ch_group_index * 4;\n\t\tbreak;\n\tcase NL80211_CHAN_WIDTH_80:\n\t\tch_group_index = (freq - freq1 + 30) / 20;\n\t\tif (WARN_ON(ch_group_index < 0 || ch_group_index > 3))\n\t\t\tch_group_index = 0;\n\t\tbw = 2;\n\t\tbw_index = ch_group_index;\n\t\tchannel += 6 - ch_group_index * 4;\n\t\tbreak;\n\tdefault:\n\t\tbw = 0;\n\t\tbw_index = 0;\n\t\tch_group_index = 0;\n\t\tbreak;\n\t}\n\n\tmt76x2_read_rx_gain(dev);\n\tmt76x2_phy_set_txpower_regs(dev, band);\n\tmt76x2_configure_tx_delay(dev, band, bw);\n\tmt76x2_phy_set_txpower(dev);\n\n\tmt76x02_phy_set_band(dev, chan->band, ch_group_index & 1);\n\tmt76x02_phy_set_bw(dev, chandef->width, ch_group_index);\n\n\tmt76_rmw(dev, MT_EXT_CCA_CFG,\n\t\t (MT_EXT_CCA_CFG_CCA0 |\n\t\t  MT_EXT_CCA_CFG_CCA1 |\n\t\t  MT_EXT_CCA_CFG_CCA2 |\n\t\t  MT_EXT_CCA_CFG_CCA3 |\n\t\t  MT_EXT_CCA_CFG_CCA_MASK),\n\t\t ext_cca_chan[ch_group_index]);\n\n\tret = mt76x2_mcu_set_channel(dev, channel, bw, bw_index, scan);\n\tif (ret)\n\t\treturn ret;\n\n\tmt76x2_mcu_init_gain(dev, channel, dev->cal.rx.mcu_gain, true);\n\n\tmt76x2_phy_set_antenna(dev);\n\n\t \n\tif (mt76xx_rev(dev) >= MT76XX_REV_E3)\n\t\tmt76_set(dev, MT_BBP(RXO, 13), BIT(10));\n\n\tif (!dev->cal.init_cal_done) {\n\t\tu8 val = mt76x02_eeprom_get(dev, MT_EE_BT_RCAL_RESULT);\n\n\t\tif (val != 0xff)\n\t\t\tmt76x02_mcu_calibrate(dev, MCU_CAL_R, 0);\n\t}\n\n\tmt76x02_mcu_calibrate(dev, MCU_CAL_RXDCOC, channel);\n\n\t \n\tif (!dev->cal.init_cal_done)\n\t\tmt76x02_mcu_calibrate(dev, MCU_CAL_RC, 0);\n\n\tdev->cal.init_cal_done = true;\n\n\tmt76_wr(dev, MT_BBP(AGC, 61), 0xFF64A4E2);\n\tmt76_wr(dev, MT_BBP(AGC, 7), 0x08081010);\n\tmt76_wr(dev, MT_BBP(AGC, 11), 0x00000404);\n\tmt76_wr(dev, MT_BBP(AGC, 2), 0x00007070);\n\tmt76_wr(dev, MT_TXOP_CTRL_CFG, 0x04101B3F);\n\n\tif (scan)\n\t\treturn 0;\n\n\tmt76x2_phy_channel_calibrate(dev, true);\n\tmt76x02_init_agc_gain(dev);\n\n\t \n\tif (mt76x2_tssi_enabled(dev)) {\n\t\tmt76_rmw_field(dev, MT_TX_ALC_CFG_1, MT_TX_ALC_CFG_1_TEMP_COMP,\n\t\t\t       0x38);\n\t\tmt76_rmw_field(dev, MT_TX_ALC_CFG_2, MT_TX_ALC_CFG_2_TEMP_COMP,\n\t\t\t       0x38);\n\t}\n\n\tieee80211_queue_delayed_work(mt76_hw(dev), &dev->cal_work,\n\t\t\t\t     MT_CALIBRATE_INTERVAL);\n\n\treturn 0;\n}\n\nstatic void\nmt76x2_phy_temp_compensate(struct mt76x02_dev *dev)\n{\n\tstruct mt76x2_temp_comp t;\n\tint temp, db_diff;\n\n\tif (mt76x2_get_temp_comp(dev, &t))\n\t\treturn;\n\n\ttemp = mt76_get_field(dev, MT_TEMP_SENSOR, MT_TEMP_SENSOR_VAL);\n\ttemp -= t.temp_25_ref;\n\ttemp = (temp * 1789) / 1000 + 25;\n\tdev->cal.temp = temp;\n\n\tif (temp > 25)\n\t\tdb_diff = (temp - 25) / t.high_slope;\n\telse\n\t\tdb_diff = (25 - temp) / t.low_slope;\n\n\tdb_diff = min(db_diff, t.upper_bound);\n\tdb_diff = max(db_diff, t.lower_bound);\n\n\tmt76_rmw_field(dev, MT_TX_ALC_CFG_1, MT_TX_ALC_CFG_1_TEMP_COMP,\n\t\t       db_diff * 2);\n\tmt76_rmw_field(dev, MT_TX_ALC_CFG_2, MT_TX_ALC_CFG_2_TEMP_COMP,\n\t\t       db_diff * 2);\n}\n\nvoid mt76x2_phy_calibrate(struct work_struct *work)\n{\n\tstruct mt76x02_dev *dev;\n\n\tdev = container_of(work, struct mt76x02_dev, cal_work.work);\n\n\tmutex_lock(&dev->mt76.mutex);\n\n\tmt76x2_phy_channel_calibrate(dev, false);\n\tmt76x2_phy_tssi_compensate(dev);\n\tmt76x2_phy_temp_compensate(dev);\n\tmt76x2_phy_update_channel_gain(dev);\n\n\tmutex_unlock(&dev->mt76.mutex);\n\n\tieee80211_queue_delayed_work(mt76_hw(dev), &dev->cal_work,\n\t\t\t\t     MT_CALIBRATE_INTERVAL);\n}\n\nint mt76x2_phy_start(struct mt76x02_dev *dev)\n{\n\tint ret;\n\n\tret = mt76x02_mcu_set_radio_state(dev, true);\n\tif (ret)\n\t\treturn ret;\n\n\tmt76x2_mcu_load_cr(dev, MT_RF_BBP_CR, 0, 0);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}