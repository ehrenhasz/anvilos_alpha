{
  "module_name": "dma.c",
  "hash_id": "889a4d60ac8ec7dd75417a395a8ed02b432996208d124c416d55c5bfdf8a839e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7615/dma.c",
  "human_readable_source": "\n \n\n#include \"mt7615.h\"\n#include \"../dma.h\"\n#include \"mac.h\"\n\nstatic int\nmt7622_init_tx_queues_multi(struct mt7615_dev *dev)\n{\n\tstatic const u8 wmm_queue_map[] = {\n\t\t[IEEE80211_AC_BK] = MT7622_TXQ_AC0,\n\t\t[IEEE80211_AC_BE] = MT7622_TXQ_AC1,\n\t\t[IEEE80211_AC_VI] = MT7622_TXQ_AC2,\n\t\t[IEEE80211_AC_VO] = MT7622_TXQ_AC3,\n\t};\n\tint ret;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(wmm_queue_map); i++) {\n\t\tret = mt76_init_tx_queue(&dev->mphy, i, wmm_queue_map[i],\n\t\t\t\t\t MT7615_TX_RING_SIZE / 2,\n\t\t\t\t\t MT_TX_RING_BASE, 0);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = mt76_init_tx_queue(&dev->mphy, MT_TXQ_PSD, MT7622_TXQ_MGMT,\n\t\t\t\t MT7615_TX_MGMT_RING_SIZE,\n\t\t\t\t MT_TX_RING_BASE, 0);\n\tif (ret)\n\t\treturn ret;\n\n\treturn mt76_init_mcu_queue(&dev->mt76, MT_MCUQ_WM, MT7622_TXQ_MCU,\n\t\t\t\t   MT7615_TX_MCU_RING_SIZE, MT_TX_RING_BASE);\n}\n\nstatic int\nmt7615_init_tx_queues(struct mt7615_dev *dev)\n{\n\tint ret;\n\n\tret = mt76_init_mcu_queue(&dev->mt76, MT_MCUQ_FWDL, MT7615_TXQ_FWDL,\n\t\t\t\t  MT7615_TX_FWDL_RING_SIZE, MT_TX_RING_BASE);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!is_mt7615(&dev->mt76))\n\t\treturn mt7622_init_tx_queues_multi(dev);\n\n\tret = mt76_connac_init_tx_queues(&dev->mphy, 0, MT7615_TX_RING_SIZE,\n\t\t\t\t\t MT_TX_RING_BASE, 0);\n\tif (ret)\n\t\treturn ret;\n\n\treturn mt76_init_mcu_queue(&dev->mt76, MT_MCUQ_WM, MT7615_TXQ_MCU,\n\t\t\t\t   MT7615_TX_MCU_RING_SIZE, MT_TX_RING_BASE);\n}\n\nstatic int mt7615_poll_tx(struct napi_struct *napi, int budget)\n{\n\tstruct mt7615_dev *dev;\n\n\tdev = container_of(napi, struct mt7615_dev, mt76.tx_napi);\n\tif (!mt76_connac_pm_ref(&dev->mphy, &dev->pm)) {\n\t\tnapi_complete(napi);\n\t\tqueue_work(dev->mt76.wq, &dev->pm.wake_work);\n\t\treturn 0;\n\t}\n\n\tmt76_queue_tx_cleanup(dev, dev->mt76.q_mcu[MT_MCUQ_WM], false);\n\tif (napi_complete(napi))\n\t\tmt76_connac_irq_enable(&dev->mt76,\n\t\t\t\t       mt7615_tx_mcu_int_mask(dev));\n\n\tmt76_connac_pm_unref(&dev->mphy, &dev->pm);\n\n\treturn 0;\n}\n\nstatic int mt7615_poll_rx(struct napi_struct *napi, int budget)\n{\n\tstruct mt7615_dev *dev;\n\tint done;\n\n\tdev = container_of(napi->dev, struct mt7615_dev, mt76.napi_dev);\n\n\tif (!mt76_connac_pm_ref(&dev->mphy, &dev->pm)) {\n\t\tnapi_complete(napi);\n\t\tqueue_work(dev->mt76.wq, &dev->pm.wake_work);\n\t\treturn 0;\n\t}\n\tdone = mt76_dma_rx_poll(napi, budget);\n\tmt76_connac_pm_unref(&dev->mphy, &dev->pm);\n\n\treturn done;\n}\n\nint mt7615_wait_pdma_busy(struct mt7615_dev *dev)\n{\n\tstruct mt76_dev *mdev = &dev->mt76;\n\n\tif (!is_mt7663(mdev)) {\n\t\tu32 mask = MT_PDMA_TX_BUSY | MT_PDMA_RX_BUSY;\n\t\tu32 reg = mt7615_reg_map(dev, MT_PDMA_BUSY);\n\n\t\tif (!mt76_poll_msec(dev, reg, mask, 0, 1000)) {\n\t\t\tdev_err(mdev->dev, \"PDMA engine busy\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\n\t\treturn 0;\n\t}\n\n\tif (!mt76_poll_msec(dev, MT_PDMA_BUSY_STATUS,\n\t\t\t    MT_PDMA_TX_IDX_BUSY, 0, 1000)) {\n\t\tdev_err(mdev->dev, \"PDMA engine tx busy\\n\");\n\t\treturn -EIO;\n\t}\n\n\tif (!mt76_poll_msec(dev, MT_PSE_PG_INFO,\n\t\t\t    MT_PSE_SRC_CNT, 0, 1000)) {\n\t\tdev_err(mdev->dev, \"PSE engine busy\\n\");\n\t\treturn -EIO;\n\t}\n\n\tif (!mt76_poll_msec(dev, MT_PDMA_BUSY_STATUS,\n\t\t\t    MT_PDMA_BUSY_IDX, 0, 1000)) {\n\t\tdev_err(mdev->dev, \"PDMA engine busy\\n\");\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nstatic void mt7622_dma_sched_init(struct mt7615_dev *dev)\n{\n\tu32 reg = mt7615_reg_map(dev, MT_DMASHDL_BASE);\n\tint i;\n\n\tmt76_rmw(dev, reg + MT_DMASHDL_PKT_MAX_SIZE,\n\t\t MT_DMASHDL_PKT_MAX_SIZE_PLE | MT_DMASHDL_PKT_MAX_SIZE_PSE,\n\t\t FIELD_PREP(MT_DMASHDL_PKT_MAX_SIZE_PLE, 1) |\n\t\t FIELD_PREP(MT_DMASHDL_PKT_MAX_SIZE_PSE, 8));\n\n\tfor (i = 0; i <= 5; i++)\n\t\tmt76_wr(dev, reg + MT_DMASHDL_GROUP_QUOTA(i),\n\t\t\tFIELD_PREP(MT_DMASHDL_GROUP_QUOTA_MIN, 0x10) |\n\t\t\tFIELD_PREP(MT_DMASHDL_GROUP_QUOTA_MAX, 0x800));\n\n\tmt76_wr(dev, reg + MT_DMASHDL_Q_MAP(0), 0x42104210);\n\tmt76_wr(dev, reg + MT_DMASHDL_Q_MAP(1), 0x42104210);\n\tmt76_wr(dev, reg + MT_DMASHDL_Q_MAP(2), 0x5);\n\tmt76_wr(dev, reg + MT_DMASHDL_Q_MAP(3), 0);\n\n\tmt76_wr(dev, reg + MT_DMASHDL_SCHED_SET0, 0x6012345f);\n\tmt76_wr(dev, reg + MT_DMASHDL_SCHED_SET1, 0xedcba987);\n}\n\nstatic void mt7663_dma_sched_init(struct mt7615_dev *dev)\n{\n\tint i;\n\n\tmt76_rmw(dev, MT_DMA_SHDL(MT_DMASHDL_PKT_MAX_SIZE),\n\t\t MT_DMASHDL_PKT_MAX_SIZE_PLE | MT_DMASHDL_PKT_MAX_SIZE_PSE,\n\t\t FIELD_PREP(MT_DMASHDL_PKT_MAX_SIZE_PLE, 1) |\n\t\t FIELD_PREP(MT_DMASHDL_PKT_MAX_SIZE_PSE, 8));\n\n\t \n\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_REFILL), 0xffc80000);\n\t \n\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_OPTIONAL), 0x70068037);\n\n\t \n\tfor (i = 0; i < 5; i++)\n\t\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_GROUP_QUOTA(i)),\n\t\t\tFIELD_PREP(MT_DMASHDL_GROUP_QUOTA_MIN, 0x40) |\n\t\t\tFIELD_PREP(MT_DMASHDL_GROUP_QUOTA_MAX, 0x800));\n\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_GROUP_QUOTA(5)),\n\t\tFIELD_PREP(MT_DMASHDL_GROUP_QUOTA_MIN, 0x40) |\n\t\tFIELD_PREP(MT_DMASHDL_GROUP_QUOTA_MAX, 0x40));\n\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_GROUP_QUOTA(15)),\n\t\tFIELD_PREP(MT_DMASHDL_GROUP_QUOTA_MIN, 0x20) |\n\t\tFIELD_PREP(MT_DMASHDL_GROUP_QUOTA_MAX, 0x20));\n\n\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_Q_MAP(0)), 0x42104210);\n\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_Q_MAP(1)), 0x42104210);\n\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_Q_MAP(2)), 0x00050005);\n\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_Q_MAP(3)), 0);\n\t \n\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_SCHED_SET0), 0x6012345f);\n\tmt76_wr(dev, MT_DMA_SHDL(MT_DMASHDL_SCHED_SET1), 0xedcba987);\n}\n\nvoid mt7615_dma_start(struct mt7615_dev *dev)\n{\n\t \n\tmt76_set(dev, MT_WPDMA_GLO_CFG,\n\t\t MT_WPDMA_GLO_CFG_TX_DMA_EN |\n\t\t MT_WPDMA_GLO_CFG_RX_DMA_EN |\n\t\t MT_WPDMA_GLO_CFG_TX_WRITEBACK_DONE);\n\n\tif (is_mt7622(&dev->mt76))\n\t\tmt7622_dma_sched_init(dev);\n\n\tif (is_mt7663(&dev->mt76)) {\n\t\tmt7663_dma_sched_init(dev);\n\n\t\tmt76_wr(dev, MT_MCU2HOST_INT_ENABLE, MT7663_MCU_CMD_ERROR_MASK);\n\t}\n\n}\n\nint mt7615_dma_init(struct mt7615_dev *dev)\n{\n\tint rx_ring_size = MT7615_RX_RING_SIZE;\n\tu32 mask;\n\tint ret;\n\n\tmt76_dma_attach(&dev->mt76);\n\n\tmt76_wr(dev, MT_WPDMA_GLO_CFG,\n\t\tMT_WPDMA_GLO_CFG_TX_WRITEBACK_DONE |\n\t\tMT_WPDMA_GLO_CFG_FIFO_LITTLE_ENDIAN |\n\t\tMT_WPDMA_GLO_CFG_OMIT_TX_INFO);\n\n\tmt76_rmw_field(dev, MT_WPDMA_GLO_CFG,\n\t\t       MT_WPDMA_GLO_CFG_TX_BT_SIZE_BIT0, 0x1);\n\n\tmt76_rmw_field(dev, MT_WPDMA_GLO_CFG,\n\t\t       MT_WPDMA_GLO_CFG_TX_BT_SIZE_BIT21, 0x1);\n\n\tmt76_rmw_field(dev, MT_WPDMA_GLO_CFG,\n\t\t       MT_WPDMA_GLO_CFG_DMA_BURST_SIZE, 0x3);\n\n\tmt76_rmw_field(dev, MT_WPDMA_GLO_CFG,\n\t\t       MT_WPDMA_GLO_CFG_MULTI_DMA_EN, 0x3);\n\n\tif (is_mt7615(&dev->mt76)) {\n\t\tmt76_set(dev, MT_WPDMA_GLO_CFG,\n\t\t\t MT_WPDMA_GLO_CFG_FIRST_TOKEN_ONLY);\n\n\t\tmt76_wr(dev, MT_WPDMA_GLO_CFG1, 0x1);\n\t\tmt76_wr(dev, MT_WPDMA_TX_PRE_CFG, 0xf0000);\n\t\tmt76_wr(dev, MT_WPDMA_RX_PRE_CFG, 0xf7f0000);\n\t\tmt76_wr(dev, MT_WPDMA_ABT_CFG, 0x4000026);\n\t\tmt76_wr(dev, MT_WPDMA_ABT_CFG1, 0x18811881);\n\t\tmt76_set(dev, 0x7158, BIT(16));\n\t\tmt76_clear(dev, 0x7000, BIT(23));\n\t}\n\n\tmt76_wr(dev, MT_WPDMA_RST_IDX, ~0);\n\n\tret = mt7615_init_tx_queues(dev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_MCU], 1,\n\t\t\t       MT7615_RX_MCU_RING_SIZE, MT_RX_BUF_SIZE,\n\t\t\t       MT_RX_RING_BASE);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!is_mt7615(&dev->mt76))\n\t    rx_ring_size /= 2;\n\n\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_MAIN], 0,\n\t\t\t       rx_ring_size, MT_RX_BUF_SIZE, MT_RX_RING_BASE);\n\tif (ret)\n\t\treturn ret;\n\n\tmt76_wr(dev, MT_DELAY_INT_CFG, 0);\n\n\tret = mt76_init_queues(dev, mt7615_poll_rx);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tnetif_napi_add_tx(&dev->mt76.tx_napi_dev, &dev->mt76.tx_napi,\n\t\t\t  mt7615_poll_tx);\n\tnapi_enable(&dev->mt76.tx_napi);\n\n\tmt76_poll(dev, MT_WPDMA_GLO_CFG,\n\t\t  MT_WPDMA_GLO_CFG_TX_DMA_BUSY |\n\t\t  MT_WPDMA_GLO_CFG_RX_DMA_BUSY, 0, 1000);\n\n\t \n\n\tmask = MT_INT_RX_DONE_ALL | mt7615_tx_mcu_int_mask(dev);\n\tif (is_mt7663(&dev->mt76))\n\t    mask |= MT7663_INT_MCU_CMD;\n\telse\n\t    mask |= MT_INT_MCU_CMD;\n\n\tmt76_connac_irq_enable(&dev->mt76, mask);\n\n\tmt7615_dma_start(dev);\n\n\treturn 0;\n}\n\nvoid mt7615_dma_cleanup(struct mt7615_dev *dev)\n{\n\tmt76_clear(dev, MT_WPDMA_GLO_CFG,\n\t\t   MT_WPDMA_GLO_CFG_TX_DMA_EN |\n\t\t   MT_WPDMA_GLO_CFG_RX_DMA_EN);\n\tmt76_set(dev, MT_WPDMA_GLO_CFG, MT_WPDMA_GLO_CFG_SW_RESET);\n\n\tmt76_dma_cleanup(&dev->mt76);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}