{
  "module_name": "pci_init.c",
  "hash_id": "4485be221074f0ab289b775895263a2adab89e03da248c5b13cf0603ed540c36",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7615/pci_init.c",
  "human_readable_source": "\n \n\n#include <linux/etherdevice.h>\n#include \"mt7615.h\"\n#include \"mac.h\"\n#include \"eeprom.h\"\n\nstatic void mt7615_pci_init_work(struct work_struct *work)\n{\n\tstruct mt7615_dev *dev = container_of(work, struct mt7615_dev,\n\t\t\t\t\t      mcu_work);\n\tint i, ret;\n\n\tret = mt7615_mcu_init(dev);\n\tfor (i = 0; (ret == -EAGAIN) && (i < 10); i++) {\n\t\tmsleep(200);\n\t\tret = mt7615_mcu_init(dev);\n\t}\n\n\tif (ret)\n\t\treturn;\n\n\tmt7615_init_work(dev);\n}\n\nstatic int mt7615_init_hardware(struct mt7615_dev *dev)\n{\n\tu32 addr = mt7615_reg_map(dev, MT_EFUSE_BASE);\n\tint ret, idx;\n\n\tmt76_wr(dev, MT_INT_SOURCE_CSR, ~0);\n\n\tINIT_WORK(&dev->mcu_work, mt7615_pci_init_work);\n\tret = mt7615_eeprom_init(dev, addr);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (is_mt7663(&dev->mt76)) {\n\t\t \n\t\tmt76_clear(dev, MT_MCU_CIRQ_IRQ_SEL(4), BIT(1));\n\t\tmt76_set(dev, MT_MCU_CIRQ_IRQ_SEL(4), BIT(1));\n\t}\n\n\tret = mt7615_dma_init(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tset_bit(MT76_STATE_INITIALIZED, &dev->mphy.state);\n\n\t \n\tidx = mt76_wcid_alloc(dev->mt76.wcid_mask, MT7615_WTBL_STA - 1);\n\tif (idx)\n\t\treturn -ENOSPC;\n\n\tdev->mt76.global_wcid.idx = idx;\n\tdev->mt76.global_wcid.hw_key_idx = -1;\n\trcu_assign_pointer(dev->mt76.wcid[idx], &dev->mt76.global_wcid);\n\n\treturn 0;\n}\n\nint mt7615_register_device(struct mt7615_dev *dev)\n{\n\tint ret;\n\n\tmt7615_init_device(dev);\n\tINIT_WORK(&dev->reset_work, mt7615_mac_reset_work);\n\n\t \n\tif (IS_ENABLED(CONFIG_MT76_LEDS)) {\n\t\tdev->mphy.leds.cdev.brightness_set = mt7615_led_set_brightness;\n\t\tdev->mphy.leds.cdev.blink_set = mt7615_led_set_blink;\n\t}\n\n\tret = mt7622_wmac_init(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tret = mt7615_init_hardware(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tret = mt76_register_device(&dev->mt76, true, mt76_rates,\n\t\t\t\t   ARRAY_SIZE(mt76_rates));\n\tif (ret)\n\t\treturn ret;\n\n\tret = mt7615_thermal_init(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tieee80211_queue_work(mt76_hw(dev), &dev->mcu_work);\n\tmt7615_init_txpower(dev, &dev->mphy.sband_2g.sband);\n\tmt7615_init_txpower(dev, &dev->mphy.sband_5g.sband);\n\n\tif (dev->dbdc_support) {\n\t\tret = mt7615_register_ext_phy(dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn mt7615_init_debugfs(dev);\n}\n\nvoid mt7615_unregister_device(struct mt7615_dev *dev)\n{\n\tbool mcu_running;\n\n\tmcu_running = mt7615_wait_for_mcu_init(dev);\n\n\tmt7615_unregister_ext_phy(dev);\n\tmt76_unregister_device(&dev->mt76);\n\tif (mcu_running)\n\t\tmt7615_mcu_exit(dev);\n\n\tmt7615_tx_token_put(dev);\n\tmt7615_dma_cleanup(dev);\n\ttasklet_disable(&dev->mt76.irq_tasklet);\n\n\tmt76_free_device(&dev->mt76);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}