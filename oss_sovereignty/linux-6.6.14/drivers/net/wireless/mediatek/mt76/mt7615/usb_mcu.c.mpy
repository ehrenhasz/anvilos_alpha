{
  "module_name": "usb_mcu.c",
  "hash_id": "9180cddea3ba43059f13ed293570cbdb5ee4942aeb581150f156f80bbf7764ac",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7615/usb_mcu.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/module.h>\n\n#include \"mt7615.h\"\n#include \"mac.h\"\n#include \"mcu.h\"\n#include \"regs.h\"\n\nstatic int\nmt7663u_mcu_send_message(struct mt76_dev *mdev, struct sk_buff *skb,\n\t\t\t int cmd, int *seq)\n{\n\tstruct mt7615_dev *dev = container_of(mdev, struct mt7615_dev, mt76);\n\tint ret, ep, len, pad;\n\n\tmt7615_mcu_fill_msg(dev, skb, cmd, seq);\n\tif (cmd != MCU_CMD(FW_SCATTER))\n\t\tep = MT_EP_OUT_INBAND_CMD;\n\telse\n\t\tep = MT_EP_OUT_AC_BE;\n\n\tlen = skb->len;\n\tput_unaligned_le32(len, skb_push(skb, sizeof(len)));\n\tpad = round_up(skb->len, 4) + 4 - skb->len;\n\tret = mt76_skb_adjust_pad(skb, pad);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = mt76u_bulk_msg(&dev->mt76, skb->data, skb->len, NULL,\n\t\t\t     1000, ep);\n\nout:\n\tdev_kfree_skb(skb);\n\n\treturn ret;\n}\n\nint mt7663u_mcu_power_on(struct mt7615_dev *dev)\n{\n\tint ret;\n\n\tret = mt76u_vendor_request(&dev->mt76, MT_VEND_POWER_ON,\n\t\t\t\t   USB_DIR_OUT | USB_TYPE_VENDOR,\n\t\t\t\t   0x0, 0x1, NULL, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!mt76_poll_msec(dev, MT_CONN_ON_MISC,\n\t\t\t    MT_TOP_MISC2_FW_PWR_ON,\n\t\t\t    FW_STATE_PWR_ON << 1, 500)) {\n\t\tdev_err(dev->mt76.dev, \"Timeout for power on\\n\");\n\t\tret = -EIO;\n\t}\n\n\treturn 0;\n}\n\nint mt7663u_mcu_init(struct mt7615_dev *dev)\n{\n\tstatic const struct mt76_mcu_ops mt7663u_mcu_ops = {\n\t\t.headroom = MT_USB_HDR_SIZE + sizeof(struct mt7615_mcu_txd),\n\t\t.tailroom = MT_USB_TAIL_SIZE,\n\t\t.mcu_skb_send_msg = mt7663u_mcu_send_message,\n\t\t.mcu_parse_response = mt7615_mcu_parse_response,\n\t};\n\tint ret;\n\n\tdev->mt76.mcu_ops = &mt7663u_mcu_ops,\n\n\tmt76_set(dev, MT_UDMA_TX_QSEL, MT_FW_DL_EN);\n\tif (test_and_clear_bit(MT76_STATE_POWER_OFF, &dev->mphy.state)) {\n\t\tret = mt7615_mcu_restart(&dev->mt76);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (!mt76_poll_msec(dev, MT_CONN_ON_MISC,\n\t\t\t\t    MT_TOP_MISC2_FW_PWR_ON, 0, 500))\n\t\t\treturn -EIO;\n\n\t\tret = mt7663u_mcu_power_on(dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = __mt7663_load_firmware(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tmt76_clear(dev, MT_UDMA_TX_QSEL, MT_FW_DL_EN);\n\tset_bit(MT76_STATE_MCU_RUNNING, &dev->mphy.state);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}