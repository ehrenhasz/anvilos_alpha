{
  "module_name": "mt76_connac3_mac.c",
  "hash_id": "70f45baab5ed98c9b70d12d95a0df4d89de37f5ce46a8192c4e3d76a30f7c89d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt76_connac3_mac.c",
  "human_readable_source": "\n \n\n#include \"mt76_connac.h\"\n#include \"mt76_connac3_mac.h\"\n#include \"dma.h\"\n\n#define HE_BITS(f)\t\tcpu_to_le16(IEEE80211_RADIOTAP_HE_##f)\n#define HE_PREP(f, m, v)\tle16_encode_bits(le32_get_bits(v, MT_CRXV_HE_##m),\\\n\t\t\t\t\t\t IEEE80211_RADIOTAP_HE_##f)\n\nstatic void\nmt76_connac3_mac_decode_he_radiotap_ru(struct mt76_rx_status *status,\n\t\t\t\t       struct ieee80211_radiotap_he *he,\n\t\t\t\t       __le32 *rxv)\n{\n\tu32 ru = le32_get_bits(rxv[0], MT_PRXV_HE_RU_ALLOC), offs = 0;\n\n\tstatus->bw = RATE_INFO_BW_HE_RU;\n\n\tswitch (ru) {\n\tcase 0 ... 36:\n\t\tstatus->he_ru = NL80211_RATE_INFO_HE_RU_ALLOC_26;\n\t\toffs = ru;\n\t\tbreak;\n\tcase 37 ... 52:\n\t\tstatus->he_ru = NL80211_RATE_INFO_HE_RU_ALLOC_52;\n\t\toffs = ru - 37;\n\t\tbreak;\n\tcase 53 ... 60:\n\t\tstatus->he_ru = NL80211_RATE_INFO_HE_RU_ALLOC_106;\n\t\toffs = ru - 53;\n\t\tbreak;\n\tcase 61 ... 64:\n\t\tstatus->he_ru = NL80211_RATE_INFO_HE_RU_ALLOC_242;\n\t\toffs = ru - 61;\n\t\tbreak;\n\tcase 65 ... 66:\n\t\tstatus->he_ru = NL80211_RATE_INFO_HE_RU_ALLOC_484;\n\t\toffs = ru - 65;\n\t\tbreak;\n\tcase 67:\n\t\tstatus->he_ru = NL80211_RATE_INFO_HE_RU_ALLOC_996;\n\t\tbreak;\n\tcase 68:\n\t\tstatus->he_ru = NL80211_RATE_INFO_HE_RU_ALLOC_2x996;\n\t\tbreak;\n\t}\n\n\the->data1 |= HE_BITS(DATA1_BW_RU_ALLOC_KNOWN);\n\the->data2 |= HE_BITS(DATA2_RU_OFFSET_KNOWN) |\n\t\t     le16_encode_bits(offs,\n\t\t\t\t      IEEE80211_RADIOTAP_HE_DATA2_RU_OFFSET);\n}\n\n#define MU_PREP(f, v)\tle16_encode_bits(v, IEEE80211_RADIOTAP_HE_MU_##f)\nstatic void\nmt76_connac3_mac_decode_he_mu_radiotap(struct sk_buff *skb, __le32 *rxv)\n{\n\tstruct mt76_rx_status *status = (struct mt76_rx_status *)skb->cb;\n\tstatic const struct ieee80211_radiotap_he_mu mu_known = {\n\t\t.flags1 = HE_BITS(MU_FLAGS1_SIG_B_MCS_KNOWN) |\n\t\t\t  HE_BITS(MU_FLAGS1_SIG_B_DCM_KNOWN) |\n\t\t\t  HE_BITS(MU_FLAGS1_CH1_RU_KNOWN) |\n\t\t\t  HE_BITS(MU_FLAGS1_SIG_B_SYMS_USERS_KNOWN),\n\t\t.flags2 = HE_BITS(MU_FLAGS2_BW_FROM_SIG_A_BW_KNOWN),\n\t};\n\tstruct ieee80211_radiotap_he_mu *he_mu;\n\n\tstatus->flag |= RX_FLAG_RADIOTAP_HE_MU;\n\n\the_mu = skb_push(skb, sizeof(mu_known));\n\tmemcpy(he_mu, &mu_known, sizeof(mu_known));\n\n\the_mu->flags1 |= MU_PREP(FLAGS1_SIG_B_MCS, status->rate_idx);\n\tif (status->he_dcm)\n\t\the_mu->flags1 |= MU_PREP(FLAGS1_SIG_B_DCM, status->he_dcm);\n\n\the_mu->flags2 |= MU_PREP(FLAGS2_BW_FROM_SIG_A_BW, status->bw) |\n\t\t\t MU_PREP(FLAGS2_SIG_B_SYMS_USERS,\n\t\t\t\t le32_get_bits(rxv[4], MT_CRXV_HE_NUM_USER));\n\n\the_mu->ru_ch1[0] = le32_get_bits(rxv[16], MT_CRXV_HE_RU0) & 0xff;\n\n\tif (status->bw >= RATE_INFO_BW_40) {\n\t\the_mu->flags1 |= HE_BITS(MU_FLAGS1_CH2_RU_KNOWN);\n\t\the_mu->ru_ch2[0] = le32_get_bits(rxv[16], MT_CRXV_HE_RU1) & 0xff;\n\t}\n\n\tif (status->bw >= RATE_INFO_BW_80) {\n\t\tu32 ru_h, ru_l;\n\n\t\the_mu->ru_ch1[1] = le32_get_bits(rxv[16], MT_CRXV_HE_RU2) & 0xff;\n\n\t\tru_l = le32_get_bits(rxv[16], MT_CRXV_HE_RU3_L);\n\t\tru_h = le32_get_bits(rxv[17], MT_CRXV_HE_RU3_H) & 0x7;\n\t\the_mu->ru_ch2[1] = (u8)(ru_l | ru_h << 4);\n\t}\n}\n\nvoid mt76_connac3_mac_decode_he_radiotap(struct sk_buff *skb, __le32 *rxv,\n\t\t\t\t\t u8 mode)\n{\n\tstruct mt76_rx_status *status = (struct mt76_rx_status *)skb->cb;\n\tstatic const struct ieee80211_radiotap_he known = {\n\t\t.data1 = HE_BITS(DATA1_DATA_MCS_KNOWN) |\n\t\t\t HE_BITS(DATA1_DATA_DCM_KNOWN) |\n\t\t\t HE_BITS(DATA1_STBC_KNOWN) |\n\t\t\t HE_BITS(DATA1_CODING_KNOWN) |\n\t\t\t HE_BITS(DATA1_LDPC_XSYMSEG_KNOWN) |\n\t\t\t HE_BITS(DATA1_DOPPLER_KNOWN) |\n\t\t\t HE_BITS(DATA1_SPTL_REUSE_KNOWN) |\n\t\t\t HE_BITS(DATA1_BSS_COLOR_KNOWN),\n\t\t.data2 = HE_BITS(DATA2_GI_KNOWN) |\n\t\t\t HE_BITS(DATA2_TXBF_KNOWN) |\n\t\t\t HE_BITS(DATA2_PE_DISAMBIG_KNOWN) |\n\t\t\t HE_BITS(DATA2_TXOP_KNOWN),\n\t};\n\tu32 ltf_size = le32_get_bits(rxv[4], MT_CRXV_HE_LTF_SIZE) + 1;\n\tstruct ieee80211_radiotap_he *he;\n\n\tstatus->flag |= RX_FLAG_RADIOTAP_HE;\n\n\the = skb_push(skb, sizeof(known));\n\tmemcpy(he, &known, sizeof(known));\n\n\the->data3 = HE_PREP(DATA3_BSS_COLOR, BSS_COLOR, rxv[9]) |\n\t\t    HE_PREP(DATA3_LDPC_XSYMSEG, LDPC_EXT_SYM, rxv[4]);\n\the->data4 = HE_PREP(DATA4_SU_MU_SPTL_REUSE, SR_MASK, rxv[13]);\n\the->data5 = HE_PREP(DATA5_PE_DISAMBIG, PE_DISAMBIG, rxv[5]) |\n\t\t    le16_encode_bits(ltf_size,\n\t\t\t\t     IEEE80211_RADIOTAP_HE_DATA5_LTF_SIZE);\n\tif (le32_to_cpu(rxv[0]) & MT_PRXV_TXBF)\n\t\the->data5 |= HE_BITS(DATA5_TXBF);\n\the->data6 = HE_PREP(DATA6_TXOP, TXOP_DUR, rxv[9]) |\n\t\t    HE_PREP(DATA6_DOPPLER, DOPPLER, rxv[9]);\n\n\tswitch (mode) {\n\tcase MT_PHY_TYPE_HE_SU:\n\t\the->data1 |= HE_BITS(DATA1_FORMAT_SU) |\n\t\t\t     HE_BITS(DATA1_UL_DL_KNOWN) |\n\t\t\t     HE_BITS(DATA1_BEAM_CHANGE_KNOWN) |\n\t\t\t     HE_BITS(DATA1_BW_RU_ALLOC_KNOWN);\n\n\t\the->data3 |= HE_PREP(DATA3_BEAM_CHANGE, BEAM_CHNG, rxv[8]) |\n\t\t\t     HE_PREP(DATA3_UL_DL, UPLINK, rxv[5]);\n\t\tbreak;\n\tcase MT_PHY_TYPE_HE_EXT_SU:\n\t\the->data1 |= HE_BITS(DATA1_FORMAT_EXT_SU) |\n\t\t\t     HE_BITS(DATA1_UL_DL_KNOWN) |\n\t\t\t     HE_BITS(DATA1_BW_RU_ALLOC_KNOWN);\n\n\t\the->data3 |= HE_PREP(DATA3_UL_DL, UPLINK, rxv[5]);\n\t\tbreak;\n\tcase MT_PHY_TYPE_HE_MU:\n\t\the->data1 |= HE_BITS(DATA1_FORMAT_MU) |\n\t\t\t     HE_BITS(DATA1_UL_DL_KNOWN);\n\n\t\the->data3 |= HE_PREP(DATA3_UL_DL, UPLINK, rxv[5]);\n\t\the->data4 |= HE_PREP(DATA4_MU_STA_ID, MU_AID, rxv[8]);\n\n\t\tmt76_connac3_mac_decode_he_radiotap_ru(status, he, rxv);\n\t\tmt76_connac3_mac_decode_he_mu_radiotap(skb, rxv);\n\t\tbreak;\n\tcase MT_PHY_TYPE_HE_TB:\n\t\the->data1 |= HE_BITS(DATA1_FORMAT_TRIG) |\n\t\t\t     HE_BITS(DATA1_SPTL_REUSE2_KNOWN) |\n\t\t\t     HE_BITS(DATA1_SPTL_REUSE3_KNOWN) |\n\t\t\t     HE_BITS(DATA1_SPTL_REUSE4_KNOWN);\n\n\t\the->data4 |= HE_PREP(DATA4_TB_SPTL_REUSE1, SR_MASK, rxv[13]) |\n\t\t\t     HE_PREP(DATA4_TB_SPTL_REUSE2, SR1_MASK, rxv[13]) |\n\t\t\t     HE_PREP(DATA4_TB_SPTL_REUSE3, SR2_MASK, rxv[13]) |\n\t\t\t     HE_PREP(DATA4_TB_SPTL_REUSE4, SR3_MASK, rxv[13]);\n\n\t\tmt76_connac3_mac_decode_he_radiotap_ru(status, he, rxv);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL_GPL(mt76_connac3_mac_decode_he_radiotap);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}