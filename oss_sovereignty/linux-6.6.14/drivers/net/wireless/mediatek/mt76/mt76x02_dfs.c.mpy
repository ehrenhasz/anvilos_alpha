{
  "module_name": "mt76x02_dfs.c",
  "hash_id": "5cc85c30f57a0dae33f2f950bb11d8ed75649e1e3df0a15df18fa08381982e02",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt76x02_dfs.c",
  "human_readable_source": "\n \n\n#include \"mt76x02.h\"\n\n#define RADAR_SPEC(m, len, el, eh, wl, wh,\t\t\\\n\t\t   w_tolerance, tl, th, t_tolerance,\t\\\n\t\t   bl, bh, event_exp, power_jmp)\t\\\n{\t\t\t\t\t\t\t\\\n\t.mode = m,\t\t\t\t\t\\\n\t.avg_len = len,\t\t\t\t\t\\\n\t.e_low = el,\t\t\t\t\t\\\n\t.e_high = eh,\t\t\t\t\t\\\n\t.w_low = wl,\t\t\t\t\t\\\n\t.w_high = wh,\t\t\t\t\t\\\n\t.w_margin = w_tolerance,\t\t\t\\\n\t.t_low = tl,\t\t\t\t\t\\\n\t.t_high = th,\t\t\t\t\t\\\n\t.t_margin = t_tolerance,\t\t\t\\\n\t.b_low = bl,\t\t\t\t\t\\\n\t.b_high = bh,\t\t\t\t\t\\\n\t.event_expiration = event_exp,\t\t\t\\\n\t.pwr_jmp = power_jmp\t\t\t\t\\\n}\n\nstatic const struct mt76x02_radar_specs etsi_radar_specs[] = {\n\t \n\tRADAR_SPEC(0, 8, 2, 15, 106, 150, 10, 4900, 100096, 10, 0,\n\t\t   0x7fffffff, 0x155cc0, 0x19cc),\n\tRADAR_SPEC(0, 40, 4, 59, 96, 380, 150, 4900, 100096, 40, 0,\n\t\t   0x7fffffff, 0x155cc0, 0x19cc),\n\tRADAR_SPEC(3, 60, 20, 46, 300, 640, 80, 4900, 10100, 80, 0,\n\t\t   0x7fffffff, 0x155cc0, 0x19dd),\n\tRADAR_SPEC(8, 8, 2, 9, 106, 150, 32, 4900, 296704, 32, 0,\n\t\t   0x7fffffff, 0x2191c0, 0x15cc),\n\t \n\tRADAR_SPEC(0, 8, 2, 15, 106, 150, 10, 4900, 100096, 10, 0,\n\t\t   0x7fffffff, 0x155cc0, 0x19cc),\n\tRADAR_SPEC(0, 40, 4, 59, 96, 380, 150, 4900, 100096, 40, 0,\n\t\t   0x7fffffff, 0x155cc0, 0x19cc),\n\tRADAR_SPEC(3, 60, 20, 46, 300, 640, 80, 4900, 10100, 80, 0,\n\t\t   0x7fffffff, 0x155cc0, 0x19dd),\n\tRADAR_SPEC(8, 8, 2, 9, 106, 150, 32, 4900, 296704, 32, 0,\n\t\t   0x7fffffff, 0x2191c0, 0x15cc),\n\t \n\tRADAR_SPEC(0, 8, 2, 15, 106, 150, 10, 4900, 100096, 10, 0,\n\t\t   0x7fffffff, 0x155cc0, 0x19cc),\n\tRADAR_SPEC(0, 40, 4, 59, 96, 380, 150, 4900, 100096, 40, 0,\n\t\t   0x7fffffff, 0x155cc0, 0x19cc),\n\tRADAR_SPEC(3, 60, 20, 46, 300, 640, 80, 4900, 10100, 80, 0,\n\t\t   0x7fffffff, 0x155cc0, 0x19dd),\n\tRADAR_SPEC(8, 8, 2, 9, 106, 150, 32, 4900, 296704, 32, 0,\n\t\t   0x7fffffff, 0x2191c0, 0x15cc)\n};\n\nstatic const struct mt76x02_radar_specs fcc_radar_specs[] = {\n\t \n\tRADAR_SPEC(0, 8, 2, 12, 106, 150, 5, 2900, 80100, 5, 0,\n\t\t   0x7fffffff, 0xfe808, 0x13dc),\n\tRADAR_SPEC(0, 8, 2, 7, 106, 140, 5, 27600, 27900, 5, 0,\n\t\t   0x7fffffff, 0xfe808, 0x19dd),\n\tRADAR_SPEC(0, 40, 4, 54, 96, 480, 150, 2900, 80100, 40, 0,\n\t\t   0x7fffffff, 0xfe808, 0x12cc),\n\tRADAR_SPEC(2, 60, 15, 63, 640, 2080, 32, 19600, 40200, 32, 0,\n\t\t   0x3938700, 0x57bcf00, 0x1289),\n\t \n\tRADAR_SPEC(0, 8, 2, 12, 106, 150, 5, 2900, 80100, 5, 0,\n\t\t   0x7fffffff, 0xfe808, 0x13dc),\n\tRADAR_SPEC(0, 8, 2, 7, 106, 140, 5, 27600, 27900, 5, 0,\n\t\t   0x7fffffff, 0xfe808, 0x19dd),\n\tRADAR_SPEC(0, 40, 4, 54, 96, 480, 150, 2900, 80100, 40, 0,\n\t\t   0x7fffffff, 0xfe808, 0x12cc),\n\tRADAR_SPEC(2, 60, 15, 63, 640, 2080, 32, 19600, 40200, 32, 0,\n\t\t   0x3938700, 0x57bcf00, 0x1289),\n\t \n\tRADAR_SPEC(0, 8, 2, 14, 106, 150, 15, 2900, 80100, 15, 0,\n\t\t   0x7fffffff, 0xfe808, 0x16cc),\n\tRADAR_SPEC(0, 8, 2, 7, 106, 140, 5, 27600, 27900, 5, 0,\n\t\t   0x7fffffff, 0xfe808, 0x19dd),\n\tRADAR_SPEC(0, 40, 4, 54, 96, 480, 150, 2900, 80100, 40, 0,\n\t\t   0x7fffffff, 0xfe808, 0x12cc),\n\tRADAR_SPEC(2, 60, 15, 63, 640, 2080, 32, 19600, 40200, 32, 0,\n\t\t   0x3938700, 0x57bcf00, 0x1289)\n};\n\nstatic const struct mt76x02_radar_specs jp_w56_radar_specs[] = {\n\t \n\tRADAR_SPEC(0, 8, 2, 7, 106, 150, 5, 2900, 80100, 5, 0,\n\t\t   0x7fffffff, 0x14c080, 0x13dc),\n\tRADAR_SPEC(0, 8, 2, 7, 106, 140, 5, 27600, 27900, 5, 0,\n\t\t   0x7fffffff, 0x14c080, 0x19dd),\n\tRADAR_SPEC(0, 40, 4, 44, 96, 480, 150, 2900, 80100, 40, 0,\n\t\t   0x7fffffff, 0x14c080, 0x12cc),\n\tRADAR_SPEC(2, 60, 15, 48, 940, 2080, 32, 19600, 40200, 32, 0,\n\t\t   0x3938700, 0X57bcf00, 0x1289),\n\t \n\tRADAR_SPEC(0, 8, 2, 7, 106, 150, 5, 2900, 80100, 5, 0,\n\t\t   0x7fffffff, 0x14c080, 0x13dc),\n\tRADAR_SPEC(0, 8, 2, 7, 106, 140, 5, 27600, 27900, 5, 0,\n\t\t   0x7fffffff, 0x14c080, 0x19dd),\n\tRADAR_SPEC(0, 40, 4, 44, 96, 480, 150, 2900, 80100, 40, 0,\n\t\t   0x7fffffff, 0x14c080, 0x12cc),\n\tRADAR_SPEC(2, 60, 15, 48, 940, 2080, 32, 19600, 40200, 32, 0,\n\t\t   0x3938700, 0X57bcf00, 0x1289),\n\t \n\tRADAR_SPEC(0, 8, 2, 9, 106, 150, 15, 2900, 80100, 15, 0,\n\t\t   0x7fffffff, 0x14c080, 0x16cc),\n\tRADAR_SPEC(0, 8, 2, 7, 106, 140, 5, 27600, 27900, 5, 0,\n\t\t   0x7fffffff, 0x14c080, 0x19dd),\n\tRADAR_SPEC(0, 40, 4, 44, 96, 480, 150, 2900, 80100, 40, 0,\n\t\t   0x7fffffff, 0x14c080, 0x12cc),\n\tRADAR_SPEC(2, 60, 15, 48, 940, 2080, 32, 19600, 40200, 32, 0,\n\t\t   0x3938700, 0X57bcf00, 0x1289)\n};\n\nstatic const struct mt76x02_radar_specs jp_w53_radar_specs[] = {\n\t \n\tRADAR_SPEC(0, 8, 2, 9, 106, 150, 20, 28400, 77000, 20, 0,\n\t\t   0x7fffffff, 0x14c080, 0x16cc),\n\t{ 0 },\n\tRADAR_SPEC(0, 40, 4, 44, 96, 200, 150, 28400, 77000, 60, 0,\n\t\t   0x7fffffff, 0x14c080, 0x16cc),\n\t{ 0 },\n\t \n\tRADAR_SPEC(0, 8, 2, 9, 106, 150, 20, 28400, 77000, 20, 0,\n\t\t   0x7fffffff, 0x14c080, 0x16cc),\n\t{ 0 },\n\tRADAR_SPEC(0, 40, 4, 44, 96, 200, 150, 28400, 77000, 60, 0,\n\t\t   0x7fffffff, 0x14c080, 0x16cc),\n\t{ 0 },\n\t \n\tRADAR_SPEC(0, 8, 2, 9, 106, 150, 20, 28400, 77000, 20, 0,\n\t\t   0x7fffffff, 0x14c080, 0x16cc),\n\t{ 0 },\n\tRADAR_SPEC(0, 40, 4, 44, 96, 200, 150, 28400, 77000, 60, 0,\n\t\t   0x7fffffff, 0x14c080, 0x16cc),\n\t{ 0 }\n};\n\nstatic void\nmt76x02_dfs_set_capture_mode_ctrl(struct mt76x02_dev *dev, u8 enable)\n{\n\tu32 data;\n\n\tdata = (1 << 1) | enable;\n\tmt76_wr(dev, MT_BBP(DFS, 36), data);\n}\n\nstatic void mt76x02_dfs_seq_pool_put(struct mt76x02_dev *dev,\n\t\t\t\t     struct mt76x02_dfs_sequence *seq)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\n\tlist_add(&seq->head, &dfs_pd->seq_pool);\n\n\tdfs_pd->seq_stats.seq_pool_len++;\n\tdfs_pd->seq_stats.seq_len--;\n}\n\nstatic struct mt76x02_dfs_sequence *\nmt76x02_dfs_seq_pool_get(struct mt76x02_dev *dev)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\tstruct mt76x02_dfs_sequence *seq;\n\n\tif (list_empty(&dfs_pd->seq_pool)) {\n\t\tseq = devm_kzalloc(dev->mt76.dev, sizeof(*seq), GFP_ATOMIC);\n\t} else {\n\t\tseq = list_first_entry(&dfs_pd->seq_pool,\n\t\t\t\t       struct mt76x02_dfs_sequence,\n\t\t\t\t       head);\n\t\tlist_del(&seq->head);\n\t\tdfs_pd->seq_stats.seq_pool_len--;\n\t}\n\tif (seq)\n\t\tdfs_pd->seq_stats.seq_len++;\n\n\treturn seq;\n}\n\nstatic int mt76x02_dfs_get_multiple(int val, int frac, int margin)\n{\n\tint remainder, factor;\n\n\tif (!frac)\n\t\treturn 0;\n\n\tif (abs(val - frac) <= margin)\n\t\treturn 1;\n\n\tfactor = val / frac;\n\tremainder = val % frac;\n\n\tif (remainder > margin) {\n\t\tif ((frac - remainder) <= margin)\n\t\t\tfactor++;\n\t\telse\n\t\t\tfactor = 0;\n\t}\n\treturn factor;\n}\n\nstatic void mt76x02_dfs_detector_reset(struct mt76x02_dev *dev)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\tstruct mt76x02_dfs_sequence *seq, *tmp_seq;\n\tint i;\n\n\t \n\tmt76_wr(dev, MT_BBP(DFS, 1), 0xf);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(dfs_pd->event_rb); i++) {\n\t\tdfs_pd->event_rb[i].h_rb = 0;\n\t\tdfs_pd->event_rb[i].t_rb = 0;\n\t}\n\n\tlist_for_each_entry_safe(seq, tmp_seq, &dfs_pd->sequences, head) {\n\t\tlist_del_init(&seq->head);\n\t\tmt76x02_dfs_seq_pool_put(dev, seq);\n\t}\n}\n\nstatic bool mt76x02_dfs_check_chirp(struct mt76x02_dev *dev)\n{\n\tbool ret = false;\n\tu32 current_ts, delta_ts;\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\n\tcurrent_ts = mt76_rr(dev, MT_PBF_LIFE_TIMER);\n\tdelta_ts = current_ts - dfs_pd->chirp_pulse_ts;\n\tdfs_pd->chirp_pulse_ts = current_ts;\n\n\t \n\tif (delta_ts <= (12 * (1 << 20))) {\n\t\tif (++dfs_pd->chirp_pulse_cnt > 8)\n\t\t\tret = true;\n\t} else {\n\t\tdfs_pd->chirp_pulse_cnt = 1;\n\t}\n\n\treturn ret;\n}\n\nstatic void mt76x02_dfs_get_hw_pulse(struct mt76x02_dev *dev,\n\t\t\t\t     struct mt76x02_dfs_hw_pulse *pulse)\n{\n\tu32 data;\n\n\t \n\tdata = (MT_DFS_CH_EN << 16) | pulse->engine;\n\tmt76_wr(dev, MT_BBP(DFS, 0), data);\n\n\t \n\tpulse->period = mt76_rr(dev, MT_BBP(DFS, 19));\n\n\t \n\tpulse->w1 = mt76_rr(dev, MT_BBP(DFS, 20));\n\tpulse->w2 = mt76_rr(dev, MT_BBP(DFS, 23));\n\n\t \n\tpulse->burst = mt76_rr(dev, MT_BBP(DFS, 22));\n}\n\nstatic bool mt76x02_dfs_check_hw_pulse(struct mt76x02_dev *dev,\n\t\t\t\t       struct mt76x02_dfs_hw_pulse *pulse)\n{\n\tbool ret = false;\n\n\tif (!pulse->period || !pulse->w1)\n\t\treturn false;\n\n\tswitch (dev->mt76.region) {\n\tcase NL80211_DFS_FCC:\n\t\tif (pulse->engine > 3)\n\t\t\tbreak;\n\n\t\tif (pulse->engine == 3) {\n\t\t\tret = mt76x02_dfs_check_chirp(dev);\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tif (pulse->w1 < 120)\n\t\t\tret = (pulse->period >= 2900 &&\n\t\t\t       (pulse->period <= 4700 ||\n\t\t\t\tpulse->period >= 6400) &&\n\t\t\t       (pulse->period <= 6800 ||\n\t\t\t\tpulse->period >= 10200) &&\n\t\t\t       pulse->period <= 61600);\n\t\telse if (pulse->w1 < 130)  \n\t\t\tret = (pulse->period >= 2900 &&\n\t\t\t       pulse->period <= 61600);\n\t\telse\n\t\t\tret = (pulse->period >= 3500 &&\n\t\t\t       pulse->period <= 10100);\n\t\tbreak;\n\tcase NL80211_DFS_ETSI:\n\t\tif (pulse->engine >= 3)\n\t\t\tbreak;\n\n\t\tret = (pulse->period >= 4900 &&\n\t\t       (pulse->period <= 10200 ||\n\t\t\tpulse->period >= 12400) &&\n\t\t       pulse->period <= 100100);\n\t\tbreak;\n\tcase NL80211_DFS_JP:\n\t\tif (dev->mphy.chandef.chan->center_freq >= 5250 &&\n\t\t    dev->mphy.chandef.chan->center_freq <= 5350) {\n\t\t\t \n\t\t\tif (pulse->w1 <= 130)\n\t\t\t\tret = (pulse->period >= 28360 &&\n\t\t\t\t       (pulse->period <= 28700 ||\n\t\t\t\t\tpulse->period >= 76900) &&\n\t\t\t\t       pulse->period <= 76940);\n\t\t\tbreak;\n\t\t}\n\n\t\tif (pulse->engine > 3)\n\t\t\tbreak;\n\n\t\tif (pulse->engine == 3) {\n\t\t\tret = mt76x02_dfs_check_chirp(dev);\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tif (pulse->w1 < 120)\n\t\t\tret = (pulse->period >= 2900 &&\n\t\t\t       (pulse->period <= 4700 ||\n\t\t\t\tpulse->period >= 6400) &&\n\t\t\t       (pulse->period <= 6800 ||\n\t\t\t\tpulse->period >= 27560) &&\n\t\t\t       (pulse->period <= 27960 ||\n\t\t\t\tpulse->period >= 28360) &&\n\t\t\t       (pulse->period <= 28700 ||\n\t\t\t\tpulse->period >= 79900) &&\n\t\t\t       pulse->period <= 80100);\n\t\telse if (pulse->w1 < 130)  \n\t\t\tret = (pulse->period >= 2900 &&\n\t\t\t       (pulse->period <= 10100 ||\n\t\t\t\tpulse->period >= 27560) &&\n\t\t\t       (pulse->period <= 27960 ||\n\t\t\t\tpulse->period >= 28360) &&\n\t\t\t       (pulse->period <= 28700 ||\n\t\t\t\tpulse->period >= 79900) &&\n\t\t\t       pulse->period <= 80100);\n\t\telse\n\t\t\tret = (pulse->period >= 3900 &&\n\t\t\t       pulse->period <= 10100);\n\t\tbreak;\n\tcase NL80211_DFS_UNSET:\n\tdefault:\n\t\treturn false;\n\t}\n\n\treturn ret;\n}\n\nstatic bool mt76x02_dfs_fetch_event(struct mt76x02_dev *dev,\n\t\t\t\t    struct mt76x02_dfs_event *event)\n{\n\tu32 data;\n\n\t \n\tdata = mt76_rr(dev, MT_BBP(DFS, 37));\n\tif (!MT_DFS_CHECK_EVENT(data))\n\t\treturn false;\n\n\tevent->engine = MT_DFS_EVENT_ENGINE(data);\n\tdata = mt76_rr(dev, MT_BBP(DFS, 37));\n\tevent->ts = MT_DFS_EVENT_TIMESTAMP(data);\n\tdata = mt76_rr(dev, MT_BBP(DFS, 37));\n\tevent->width = MT_DFS_EVENT_WIDTH(data);\n\n\treturn true;\n}\n\nstatic bool mt76x02_dfs_check_event(struct mt76x02_dev *dev,\n\t\t\t\t    struct mt76x02_dfs_event *event)\n{\n\tif (event->engine == 2) {\n\t\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\t\tstruct mt76x02_dfs_event_rb *event_buff = &dfs_pd->event_rb[1];\n\t\tu16 last_event_idx;\n\t\tu32 delta_ts;\n\n\t\tlast_event_idx = mt76_decr(event_buff->t_rb,\n\t\t\t\t\t   MT_DFS_EVENT_BUFLEN);\n\t\tdelta_ts = event->ts - event_buff->data[last_event_idx].ts;\n\t\tif (delta_ts < MT_DFS_EVENT_TIME_MARGIN &&\n\t\t    event_buff->data[last_event_idx].width >= 200)\n\t\t\treturn false;\n\t}\n\treturn true;\n}\n\nstatic void mt76x02_dfs_queue_event(struct mt76x02_dev *dev,\n\t\t\t\t    struct mt76x02_dfs_event *event)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\tstruct mt76x02_dfs_event_rb *event_buff;\n\n\t \n\tevent_buff = event->engine == 2 ? &dfs_pd->event_rb[1]\n\t\t\t\t\t: &dfs_pd->event_rb[0];\n\tevent_buff->data[event_buff->t_rb] = *event;\n\tevent_buff->data[event_buff->t_rb].fetch_ts = jiffies;\n\n\tevent_buff->t_rb = mt76_incr(event_buff->t_rb, MT_DFS_EVENT_BUFLEN);\n\tif (event_buff->t_rb == event_buff->h_rb)\n\t\tevent_buff->h_rb = mt76_incr(event_buff->h_rb,\n\t\t\t\t\t     MT_DFS_EVENT_BUFLEN);\n}\n\nstatic int mt76x02_dfs_create_sequence(struct mt76x02_dev *dev,\n\t\t\t\t       struct mt76x02_dfs_event *event,\n\t\t\t\t       u16 cur_len)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\tstruct mt76x02_dfs_sw_detector_params *sw_params;\n\tu32 width_delta, with_sum;\n\tstruct mt76x02_dfs_sequence seq, *seq_p;\n\tstruct mt76x02_dfs_event_rb *event_rb;\n\tstruct mt76x02_dfs_event *cur_event;\n\tint i, j, end, pri, factor, cur_pri;\n\n\tevent_rb = event->engine == 2 ? &dfs_pd->event_rb[1]\n\t\t\t\t      : &dfs_pd->event_rb[0];\n\n\ti = mt76_decr(event_rb->t_rb, MT_DFS_EVENT_BUFLEN);\n\tend = mt76_decr(event_rb->h_rb, MT_DFS_EVENT_BUFLEN);\n\n\twhile (i != end) {\n\t\tcur_event = &event_rb->data[i];\n\t\twith_sum = event->width + cur_event->width;\n\n\t\tsw_params = &dfs_pd->sw_dpd_params;\n\t\tswitch (dev->mt76.region) {\n\t\tcase NL80211_DFS_FCC:\n\t\tcase NL80211_DFS_JP:\n\t\t\tif (with_sum < 600)\n\t\t\t\twidth_delta = 8;\n\t\t\telse\n\t\t\t\twidth_delta = with_sum >> 3;\n\t\t\tbreak;\n\t\tcase NL80211_DFS_ETSI:\n\t\t\tif (event->engine == 2)\n\t\t\t\twidth_delta = with_sum >> 6;\n\t\t\telse if (with_sum < 620)\n\t\t\t\twidth_delta = 24;\n\t\t\telse\n\t\t\t\twidth_delta = 8;\n\t\t\tbreak;\n\t\tcase NL80211_DFS_UNSET:\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tpri = event->ts - cur_event->ts;\n\t\tif (abs(event->width - cur_event->width) > width_delta ||\n\t\t    pri < sw_params->min_pri)\n\t\t\tgoto next;\n\n\t\tif (pri > sw_params->max_pri)\n\t\t\tbreak;\n\n\t\tseq.pri = event->ts - cur_event->ts;\n\t\tseq.first_ts = cur_event->ts;\n\t\tseq.last_ts = event->ts;\n\t\tseq.engine = event->engine;\n\t\tseq.count = 2;\n\n\t\tj = mt76_decr(i, MT_DFS_EVENT_BUFLEN);\n\t\twhile (j != end) {\n\t\t\tcur_event = &event_rb->data[j];\n\t\t\tcur_pri = event->ts - cur_event->ts;\n\t\t\tfactor = mt76x02_dfs_get_multiple(cur_pri, seq.pri,\n\t\t\t\t\t\tsw_params->pri_margin);\n\t\t\tif (factor > 0) {\n\t\t\t\tseq.first_ts = cur_event->ts;\n\t\t\t\tseq.count++;\n\t\t\t}\n\n\t\t\tj = mt76_decr(j, MT_DFS_EVENT_BUFLEN);\n\t\t}\n\t\tif (seq.count <= cur_len)\n\t\t\tgoto next;\n\n\t\tseq_p = mt76x02_dfs_seq_pool_get(dev);\n\t\tif (!seq_p)\n\t\t\treturn -ENOMEM;\n\n\t\t*seq_p = seq;\n\t\tINIT_LIST_HEAD(&seq_p->head);\n\t\tlist_add(&seq_p->head, &dfs_pd->sequences);\nnext:\n\t\ti = mt76_decr(i, MT_DFS_EVENT_BUFLEN);\n\t}\n\treturn 0;\n}\n\nstatic u16 mt76x02_dfs_add_event_to_sequence(struct mt76x02_dev *dev,\n\t\t\t\t\t     struct mt76x02_dfs_event *event)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\tstruct mt76x02_dfs_sw_detector_params *sw_params;\n\tstruct mt76x02_dfs_sequence *seq, *tmp_seq;\n\tu16 max_seq_len = 0;\n\tint factor, pri;\n\n\tsw_params = &dfs_pd->sw_dpd_params;\n\tlist_for_each_entry_safe(seq, tmp_seq, &dfs_pd->sequences, head) {\n\t\tif (event->ts > seq->first_ts + MT_DFS_SEQUENCE_WINDOW) {\n\t\t\tlist_del_init(&seq->head);\n\t\t\tmt76x02_dfs_seq_pool_put(dev, seq);\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (event->engine != seq->engine)\n\t\t\tcontinue;\n\n\t\tpri = event->ts - seq->last_ts;\n\t\tfactor = mt76x02_dfs_get_multiple(pri, seq->pri,\n\t\t\t\t\t\t  sw_params->pri_margin);\n\t\tif (factor > 0) {\n\t\t\tseq->last_ts = event->ts;\n\t\t\tseq->count++;\n\t\t\tmax_seq_len = max_t(u16, max_seq_len, seq->count);\n\t\t}\n\t}\n\treturn max_seq_len;\n}\n\nstatic bool mt76x02_dfs_check_detection(struct mt76x02_dev *dev)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\tstruct mt76x02_dfs_sequence *seq;\n\n\tif (list_empty(&dfs_pd->sequences))\n\t\treturn false;\n\n\tlist_for_each_entry(seq, &dfs_pd->sequences, head) {\n\t\tif (seq->count > MT_DFS_SEQUENCE_TH) {\n\t\t\tdfs_pd->stats[seq->engine].sw_pattern++;\n\t\t\treturn true;\n\t\t}\n\t}\n\treturn false;\n}\n\nstatic void mt76x02_dfs_add_events(struct mt76x02_dev *dev)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\tstruct mt76x02_dfs_event event;\n\tint i, seq_len;\n\n\t \n\tmt76x02_dfs_set_capture_mode_ctrl(dev, false);\n\tfor (i = 0; i < MT_DFS_EVENT_LOOP; i++) {\n\t\tif (!mt76x02_dfs_fetch_event(dev, &event))\n\t\t\tbreak;\n\n\t\tif (dfs_pd->last_event_ts > event.ts)\n\t\t\tmt76x02_dfs_detector_reset(dev);\n\t\tdfs_pd->last_event_ts = event.ts;\n\n\t\tif (!mt76x02_dfs_check_event(dev, &event))\n\t\t\tcontinue;\n\n\t\tseq_len = mt76x02_dfs_add_event_to_sequence(dev, &event);\n\t\tmt76x02_dfs_create_sequence(dev, &event, seq_len);\n\n\t\tmt76x02_dfs_queue_event(dev, &event);\n\t}\n\tmt76x02_dfs_set_capture_mode_ctrl(dev, true);\n}\n\nstatic void mt76x02_dfs_check_event_window(struct mt76x02_dev *dev)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\tstruct mt76x02_dfs_event_rb *event_buff;\n\tstruct mt76x02_dfs_event *event;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(dfs_pd->event_rb); i++) {\n\t\tevent_buff = &dfs_pd->event_rb[i];\n\n\t\twhile (event_buff->h_rb != event_buff->t_rb) {\n\t\t\tevent = &event_buff->data[event_buff->h_rb];\n\n\t\t\t \n\t\t\tif (time_is_after_jiffies(event->fetch_ts +\n\t\t\t\t\t\t  MT_DFS_EVENT_WINDOW))\n\t\t\t\tbreak;\n\t\t\tevent_buff->h_rb = mt76_incr(event_buff->h_rb,\n\t\t\t\t\t\t     MT_DFS_EVENT_BUFLEN);\n\t\t}\n\t}\n}\n\nstatic void mt76x02_dfs_tasklet(struct tasklet_struct *t)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = from_tasklet(dfs_pd, t,\n\t\t\t\t\t\t\t\t   dfs_tasklet);\n\tstruct mt76x02_dev *dev = container_of(dfs_pd, typeof(*dev), dfs_pd);\n\tu32 engine_mask;\n\tint i;\n\n\tif (test_bit(MT76_SCANNING, &dev->mphy.state))\n\t\tgoto out;\n\n\tif (time_is_before_jiffies(dfs_pd->last_sw_check +\n\t\t\t\t   MT_DFS_SW_TIMEOUT)) {\n\t\tbool radar_detected;\n\n\t\tdfs_pd->last_sw_check = jiffies;\n\n\t\tmt76x02_dfs_add_events(dev);\n\t\tradar_detected = mt76x02_dfs_check_detection(dev);\n\t\tif (radar_detected) {\n\t\t\t \n\t\t\tieee80211_radar_detected(dev->mt76.hw);\n\t\t\tmt76x02_dfs_detector_reset(dev);\n\n\t\t\treturn;\n\t\t}\n\t\tmt76x02_dfs_check_event_window(dev);\n\t}\n\n\tengine_mask = mt76_rr(dev, MT_BBP(DFS, 1));\n\tif (!(engine_mask & 0xf))\n\t\tgoto out;\n\n\tfor (i = 0; i < MT_DFS_NUM_ENGINES; i++) {\n\t\tstruct mt76x02_dfs_hw_pulse pulse;\n\n\t\tif (!(engine_mask & (1 << i)))\n\t\t\tcontinue;\n\n\t\tpulse.engine = i;\n\t\tmt76x02_dfs_get_hw_pulse(dev, &pulse);\n\n\t\tif (!mt76x02_dfs_check_hw_pulse(dev, &pulse)) {\n\t\t\tdfs_pd->stats[i].hw_pulse_discarded++;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tdfs_pd->stats[i].hw_pattern++;\n\t\tieee80211_radar_detected(dev->mt76.hw);\n\t\tmt76x02_dfs_detector_reset(dev);\n\n\t\treturn;\n\t}\n\n\t \n\tmt76_wr(dev, MT_BBP(DFS, 1), 0xf);\n\nout:\n\tmt76x02_irq_enable(dev, MT_INT_GPTIMER);\n}\n\nstatic void mt76x02_dfs_init_sw_detector(struct mt76x02_dev *dev)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\n\tswitch (dev->mt76.region) {\n\tcase NL80211_DFS_FCC:\n\t\tdfs_pd->sw_dpd_params.max_pri = MT_DFS_FCC_MAX_PRI;\n\t\tdfs_pd->sw_dpd_params.min_pri = MT_DFS_FCC_MIN_PRI;\n\t\tdfs_pd->sw_dpd_params.pri_margin = MT_DFS_PRI_MARGIN;\n\t\tbreak;\n\tcase NL80211_DFS_ETSI:\n\t\tdfs_pd->sw_dpd_params.max_pri = MT_DFS_ETSI_MAX_PRI;\n\t\tdfs_pd->sw_dpd_params.min_pri = MT_DFS_ETSI_MIN_PRI;\n\t\tdfs_pd->sw_dpd_params.pri_margin = MT_DFS_PRI_MARGIN << 2;\n\t\tbreak;\n\tcase NL80211_DFS_JP:\n\t\tdfs_pd->sw_dpd_params.max_pri = MT_DFS_JP_MAX_PRI;\n\t\tdfs_pd->sw_dpd_params.min_pri = MT_DFS_JP_MIN_PRI;\n\t\tdfs_pd->sw_dpd_params.pri_margin = MT_DFS_PRI_MARGIN;\n\t\tbreak;\n\tcase NL80211_DFS_UNSET:\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void mt76x02_dfs_set_bbp_params(struct mt76x02_dev *dev)\n{\n\tconst struct mt76x02_radar_specs *radar_specs;\n\tu8 i, shift;\n\tu32 data;\n\n\tswitch (dev->mphy.chandef.width) {\n\tcase NL80211_CHAN_WIDTH_40:\n\t\tshift = MT_DFS_NUM_ENGINES;\n\t\tbreak;\n\tcase NL80211_CHAN_WIDTH_80:\n\t\tshift = 2 * MT_DFS_NUM_ENGINES;\n\t\tbreak;\n\tdefault:\n\t\tshift = 0;\n\t\tbreak;\n\t}\n\n\tswitch (dev->mt76.region) {\n\tcase NL80211_DFS_FCC:\n\t\tradar_specs = &fcc_radar_specs[shift];\n\t\tbreak;\n\tcase NL80211_DFS_ETSI:\n\t\tradar_specs = &etsi_radar_specs[shift];\n\t\tbreak;\n\tcase NL80211_DFS_JP:\n\t\tif (dev->mphy.chandef.chan->center_freq >= 5250 &&\n\t\t    dev->mphy.chandef.chan->center_freq <= 5350)\n\t\t\tradar_specs = &jp_w53_radar_specs[shift];\n\t\telse\n\t\t\tradar_specs = &jp_w56_radar_specs[shift];\n\t\tbreak;\n\tcase NL80211_DFS_UNSET:\n\tdefault:\n\t\treturn;\n\t}\n\n\tdata = (MT_DFS_VGA_MASK << 16) |\n\t       (MT_DFS_PWR_GAIN_OFFSET << 12) |\n\t       (MT_DFS_PWR_DOWN_TIME << 8) |\n\t       (MT_DFS_SYM_ROUND << 4) |\n\t       (MT_DFS_DELTA_DELAY & 0xf);\n\tmt76_wr(dev, MT_BBP(DFS, 2), data);\n\n\tdata = (MT_DFS_RX_PE_MASK << 16) | MT_DFS_PKT_END_MASK;\n\tmt76_wr(dev, MT_BBP(DFS, 3), data);\n\n\tfor (i = 0; i < MT_DFS_NUM_ENGINES; i++) {\n\t\t \n\t\tmt76_wr(dev, MT_BBP(DFS, 0), i);\n\n\t\t \n\t\tdata = ((radar_specs[i].avg_len & 0x1ff) << 16) |\n\t\t       (radar_specs[i].mode & 0xf);\n\t\tmt76_wr(dev, MT_BBP(DFS, 4), data);\n\n\t\t \n\t\tdata = ((radar_specs[i].e_high & 0x0fff) << 16) |\n\t\t       (radar_specs[i].e_low & 0x0fff);\n\t\tmt76_wr(dev, MT_BBP(DFS, 5), data);\n\n\t\t \n\t\tmt76_wr(dev, MT_BBP(DFS, 7), radar_specs[i].t_low);\n\t\tmt76_wr(dev, MT_BBP(DFS, 9), radar_specs[i].t_high);\n\n\t\t \n\t\tmt76_wr(dev, MT_BBP(DFS, 11), radar_specs[i].b_low);\n\t\tmt76_wr(dev, MT_BBP(DFS, 13), radar_specs[i].b_high);\n\n\t\t \n\t\tdata = ((radar_specs[i].w_high & 0x0fff) << 16) |\n\t\t       (radar_specs[i].w_low & 0x0fff);\n\t\tmt76_wr(dev, MT_BBP(DFS, 14), data);\n\n\t\t \n\t\tdata = (radar_specs[i].w_margin << 16) |\n\t\t       radar_specs[i].t_margin;\n\t\tmt76_wr(dev, MT_BBP(DFS, 15), data);\n\n\t\t \n\t\tmt76_wr(dev, MT_BBP(DFS, 17), radar_specs[i].event_expiration);\n\n\t\t \n\t\tmt76_wr(dev, MT_BBP(DFS, 30), radar_specs[i].pwr_jmp);\n\t}\n\n\t \n\tmt76_wr(dev, MT_BBP(DFS, 1), 0xf);\n\tmt76_wr(dev, MT_BBP(DFS, 36), 0x3);\n\n\t \n\tmt76_wr(dev, MT_BBP(DFS, 0), MT_DFS_CH_EN << 16);\n\tmt76_wr(dev, MT_BBP(IBI, 11), 0x0c350001);\n}\n\nvoid mt76x02_phy_dfs_adjust_agc(struct mt76x02_dev *dev)\n{\n\tu32 agc_r8, agc_r4, val_r8, val_r4, dfs_r31;\n\n\tagc_r8 = mt76_rr(dev, MT_BBP(AGC, 8));\n\tagc_r4 = mt76_rr(dev, MT_BBP(AGC, 4));\n\n\tval_r8 = (agc_r8 & 0x00007e00) >> 9;\n\tval_r4 = agc_r4 & ~0x1f000000;\n\tval_r4 += (((val_r8 + 1) >> 1) << 24);\n\tmt76_wr(dev, MT_BBP(AGC, 4), val_r4);\n\n\tdfs_r31 = FIELD_GET(MT_BBP_AGC_LNA_HIGH_GAIN, val_r4);\n\tdfs_r31 += val_r8;\n\tdfs_r31 -= (agc_r8 & 0x00000038) >> 3;\n\tdfs_r31 = (dfs_r31 << 16) | 0x00000307;\n\tmt76_wr(dev, MT_BBP(DFS, 31), dfs_r31);\n\n\tif (is_mt76x2(dev)) {\n\t\tmt76_wr(dev, MT_BBP(DFS, 32), 0x00040071);\n\t} else {\n\t\t \n\t\tmt76_wr(dev, MT_BBP(DFS, 0), 0);\n\t\t \n\t\tmt76_wr(dev, MT_BBP(DFS, 0), MT_DFS_CH_EN << 16);\n\t}\n}\nEXPORT_SYMBOL_GPL(mt76x02_phy_dfs_adjust_agc);\n\nvoid mt76x02_dfs_init_params(struct mt76x02_dev *dev)\n{\n\tif (mt76_phy_dfs_state(&dev->mphy) > MT_DFS_STATE_DISABLED) {\n\t\tmt76x02_dfs_init_sw_detector(dev);\n\t\tmt76x02_dfs_set_bbp_params(dev);\n\t\t \n\t\tmt76x02_dfs_set_capture_mode_ctrl(dev, true);\n\n\t\tmt76x02_irq_enable(dev, MT_INT_GPTIMER);\n\t\tmt76_rmw_field(dev, MT_INT_TIMER_EN,\n\t\t\t       MT_INT_TIMER_EN_GP_TIMER_EN, 1);\n\t} else {\n\t\t \n\t\tmt76_wr(dev, MT_BBP(DFS, 0), 0);\n\t\t \n\t\tmt76_wr(dev, MT_BBP(DFS, 1), 0xf);\n\t\tif (mt76_chip(&dev->mt76) == 0x7610 ||\n\t\t    mt76_chip(&dev->mt76) == 0x7630)\n\t\t\tmt76_wr(dev, MT_BBP(IBI, 11), 0xfde8081);\n\t\telse\n\t\t\tmt76_wr(dev, MT_BBP(IBI, 11), 0);\n\n\t\tmt76x02_irq_disable(dev, MT_INT_GPTIMER);\n\t\tmt76_rmw_field(dev, MT_INT_TIMER_EN,\n\t\t\t       MT_INT_TIMER_EN_GP_TIMER_EN, 0);\n\t}\n}\nEXPORT_SYMBOL_GPL(mt76x02_dfs_init_params);\n\nvoid mt76x02_dfs_init_detector(struct mt76x02_dev *dev)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\n\tINIT_LIST_HEAD(&dfs_pd->sequences);\n\tINIT_LIST_HEAD(&dfs_pd->seq_pool);\n\tdev->mt76.region = NL80211_DFS_UNSET;\n\tdfs_pd->last_sw_check = jiffies;\n\ttasklet_setup(&dfs_pd->dfs_tasklet, mt76x02_dfs_tasklet);\n}\n\nstatic void\nmt76x02_dfs_set_domain(struct mt76x02_dev *dev,\n\t\t       enum nl80211_dfs_regions region)\n{\n\tstruct mt76x02_dfs_pattern_detector *dfs_pd = &dev->dfs_pd;\n\n\tmutex_lock(&dev->mt76.mutex);\n\tif (dev->mt76.region != region) {\n\t\ttasklet_disable(&dfs_pd->dfs_tasklet);\n\n\t\tdev->ed_monitor = dev->ed_monitor_enabled &&\n\t\t\t\t  region == NL80211_DFS_ETSI;\n\t\tmt76x02_edcca_init(dev);\n\n\t\tdev->mt76.region = region;\n\t\tmt76x02_dfs_init_params(dev);\n\t\ttasklet_enable(&dfs_pd->dfs_tasklet);\n\t}\n\tmutex_unlock(&dev->mt76.mutex);\n}\n\nvoid mt76x02_regd_notifier(struct wiphy *wiphy,\n\t\t\t   struct regulatory_request *request)\n{\n\tstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\n\tstruct mt76x02_dev *dev = hw->priv;\n\n\tmt76x02_dfs_set_domain(dev, request->dfs_region);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}