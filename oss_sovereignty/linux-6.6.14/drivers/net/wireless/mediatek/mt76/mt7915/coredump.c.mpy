{
  "module_name": "coredump.c",
  "hash_id": "eaea4e93035a52390e1eea675b444647d4fd448d7dba0a1775717ff447c74458",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7915/coredump.c",
  "human_readable_source": "\n \n\n#include <linux/devcoredump.h>\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/utsname.h>\n#include \"coredump.h\"\n\nstatic bool coredump_memdump;\nmodule_param(coredump_memdump, bool, 0644);\nMODULE_PARM_DESC(coredump_memdump, \"Optional ability to dump firmware memory\");\n\nstatic const struct mt7915_mem_region mt7915_mem_regions[] = {\n\t{\n\t\t.start = 0xe003b400,\n\t\t.len = 0x00003bff,\n\t\t.name = \"CRAM\",\n\t},\n};\n\nstatic const struct mt7915_mem_region mt7916_mem_regions[] = {\n\t{\n\t\t.start = 0x00800000,\n\t\t.len = 0x0005ffff,\n\t\t.name = \"ROM\",\n\t},\n\t{\n\t\t.start = 0x00900000,\n\t\t.len = 0x00013fff,\n\t\t.name = \"ULM1\",\n\t},\n\t{\n\t\t.start = 0x02200000,\n\t\t.len = 0x0004ffff,\n\t\t.name = \"ULM2\",\n\t},\n\t{\n\t\t.start = 0x02300000,\n\t\t.len = 0x0004ffff,\n\t\t.name = \"ULM3\",\n\t},\n\t{\n\t\t.start = 0x00400000,\n\t\t.len = 0x00027fff,\n\t\t.name = \"SRAM\",\n\t},\n\t{\n\t\t.start = 0xe0000000,\n\t\t.len = 0x00157fff,\n\t\t.name = \"CRAM\",\n\t},\n};\n\nstatic const struct mt7915_mem_region mt798x_mem_regions[] = {\n\t{\n\t\t.start = 0x00800000,\n\t\t.len = 0x0005ffff,\n\t\t.name = \"ROM\",\n\t},\n\t{\n\t\t.start = 0x00900000,\n\t\t.len = 0x0000ffff,\n\t\t.name = \"ULM1\",\n\t},\n\t{\n\t\t.start = 0x02200000,\n\t\t.len = 0x0004ffff,\n\t\t.name = \"ULM2\",\n\t},\n\t{\n\t\t.start = 0x02300000,\n\t\t.len = 0x0004ffff,\n\t\t.name = \"ULM3\",\n\t},\n\t{\n\t\t.start = 0x00400000,\n\t\t.len = 0x00017fff,\n\t\t.name = \"SRAM\",\n\t},\n\t{\n\t\t.start = 0xe0000000,\n\t\t.len = 0x00113fff,\n\t\t.name = \"CRAM\",\n\t},\n};\n\nconst struct mt7915_mem_region*\nmt7915_coredump_get_mem_layout(struct mt7915_dev *dev, u32 *num)\n{\n\tswitch (mt76_chip(&dev->mt76)) {\n\tcase 0x7915:\n\t\t*num = ARRAY_SIZE(mt7915_mem_regions);\n\t\treturn &mt7915_mem_regions[0];\n\tcase 0x7981:\n\tcase 0x7986:\n\t\t*num = ARRAY_SIZE(mt798x_mem_regions);\n\t\treturn &mt798x_mem_regions[0];\n\tcase 0x7916:\n\t\t*num = ARRAY_SIZE(mt7916_mem_regions);\n\t\treturn &mt7916_mem_regions[0];\n\tdefault:\n\t\treturn NULL;\n\t}\n}\n\nstatic int mt7915_coredump_get_mem_size(struct mt7915_dev *dev)\n{\n\tconst struct mt7915_mem_region *mem_region;\n\tsize_t size = 0;\n\tu32 num;\n\tint i;\n\n\tmem_region = mt7915_coredump_get_mem_layout(dev, &num);\n\tif (!mem_region)\n\t\treturn 0;\n\n\tfor (i = 0; i < num; i++) {\n\t\tsize += mem_region->len;\n\t\tmem_region++;\n\t}\n\n\t \n\tsize += num * sizeof(struct mt7915_mem_hdr);\n\t \n\tsize = ALIGN(size, 4);\n\n\treturn size;\n}\n\nstruct mt7915_crash_data *mt7915_coredump_new(struct mt7915_dev *dev)\n{\n\tstruct mt7915_crash_data *crash_data = dev->coredump.crash_data;\n\n\tlockdep_assert_held(&dev->dump_mutex);\n\n\tguid_gen(&crash_data->guid);\n\tktime_get_real_ts64(&crash_data->timestamp);\n\n\treturn crash_data;\n}\n\nstatic void\nmt7915_coredump_fw_state(struct mt7915_dev *dev, struct mt7915_coredump *dump,\n\t\t\t bool *exception)\n{\n\tu32 state, count, type;\n\n\ttype = (u32)mt76_get_field(dev, MT_FW_EXCEPT_TYPE, GENMASK(7, 0));\n\tstate = (u32)mt76_get_field(dev, MT_FW_ASSERT_STAT, GENMASK(7, 0));\n\tcount = is_mt7915(&dev->mt76) ?\n\t\t(u32)mt76_get_field(dev, MT_FW_EXCEPT_COUNT, GENMASK(15, 8)) :\n\t\t(u32)mt76_get_field(dev, MT_FW_EXCEPT_COUNT, GENMASK(7, 0));\n\n\t \n\tif (!count)\n\t\tstrscpy(dump->fw_state, \"normal\", sizeof(dump->fw_state));\n\telse if (state > 1 && (count == 1) && type == 5)\n\t\tstrscpy(dump->fw_state, \"assert\", sizeof(dump->fw_state));\n\telse if ((state > 1 && count == 1) || count > 1)\n\t\tstrscpy(dump->fw_state, \"exception\", sizeof(dump->fw_state));\n\n\t*exception = !!count;\n}\n\nstatic void\nmt7915_coredump_fw_trace(struct mt7915_dev *dev, struct mt7915_coredump *dump,\n\t\t\t bool exception)\n{\n\tu32 n, irq, sch, base = MT_FW_EINT_INFO;\n\n\t \n\tdump->last_msg_id = mt76_rr(dev, MT_FW_LAST_MSG_ID);\n\n\tn = is_mt7915(&dev->mt76) ?\n\t    (u32)mt76_get_field(dev, base, GENMASK(7, 0)) :\n\t    (u32)mt76_get_field(dev, base, GENMASK(15, 8));\n\tdump->eint_info_idx = n;\n\n\tirq = mt76_rr(dev, base + 0x8);\n\tn = is_mt7915(&dev->mt76) ?\n\t    FIELD_GET(GENMASK(7, 0), irq) : FIELD_GET(GENMASK(23, 16), irq);\n\tdump->irq_info_idx = n;\n\n\tsch = mt76_rr(dev, MT_FW_SCHED_INFO);\n\tn = is_mt7915(&dev->mt76) ?\n\t    FIELD_GET(GENMASK(7, 0), sch) : FIELD_GET(GENMASK(15, 8), sch);\n\tdump->sched_info_idx = n;\n\n\tif (exception) {\n\t\tu32 i, y;\n\n\t\t \n\t\tn = is_mt7915(&dev->mt76) ?\n\t\t    FIELD_GET(GENMASK(15, 8), sch) : FIELD_GET(GENMASK(7, 0), sch);\n\t\tn = n > 60 ? 60 : n;\n\n\t\tstrscpy(dump->trace_sched, \"(sched_info) id, time\",\n\t\t\tsizeof(dump->trace_sched));\n\n\t\tfor (y = dump->sched_info_idx, i = 0; i < n; i++, y++) {\n\t\t\tmt7915_memcpy_fromio(dev, dump->sched, base + 0xc + y * 12,\n\t\t\t\t\t     sizeof(dump->sched));\n\t\t\ty = y >= n ? 0 : y;\n\t\t}\n\n\t\t \n\t\tn = is_mt7915(&dev->mt76) ?\n\t\t    FIELD_GET(GENMASK(15, 8), irq) : FIELD_GET(GENMASK(7, 0), irq);\n\t\tn = n > 60 ? 60 : n;\n\n\t\tstrscpy(dump->trace_irq, \"(irq_info) id, time\",\n\t\t\tsizeof(dump->trace_irq));\n\n\t\tfor (y = dump->irq_info_idx, i = 0; i < n; i++, y++) {\n\t\t\tmt7915_memcpy_fromio(dev, dump->irq, base + 0x4 + y * 16,\n\t\t\t\t\t     sizeof(dump->irq));\n\t\t\ty = y >= n ? 0 : y;\n\t\t}\n\t}\n}\n\nstatic void\nmt7915_coredump_fw_stack(struct mt7915_dev *dev, struct mt7915_coredump *dump,\n\t\t\t bool exception)\n{\n\tu32 oldest, i, idx;\n\n\t \n\tif (!exception)\n\t\tmt76_clear(dev, 0x89050200, BIT(0));\n\n\toldest = (u32)mt76_get_field(dev, 0x89050200, GENMASK(20, 16)) + 2;\n\tfor (i = 0; i < 16; i++) {\n\t\tidx = ((oldest + 2 * i + 1) % 32);\n\t\tdump->call_stack[i] = mt76_rr(dev, 0x89050204 + idx * 4);\n\t}\n\n\t \n\tif (!exception)\n\t\tmt76_set(dev, 0x89050200, BIT(0));\n}\n\nstatic void\nmt7915_coredump_fw_task(struct mt7915_dev *dev, struct mt7915_coredump *dump)\n{\n\tu32 offs = is_mt7915(&dev->mt76) ? 0xe0 : 0x170;\n\n\tstrscpy(dump->task_qid, \"(task queue id) read, write\",\n\t\tsizeof(dump->task_qid));\n\n\tdump->taskq[0].read = mt76_rr(dev, MT_FW_TASK_QID1);\n\tdump->taskq[0].write = mt76_rr(dev, MT_FW_TASK_QID1 - 4);\n\tdump->taskq[1].read = mt76_rr(dev, MT_FW_TASK_QID2);\n\tdump->taskq[1].write = mt76_rr(dev, MT_FW_TASK_QID2 - 4);\n\n\tstrscpy(dump->task_info, \"(task stack) start, end, size\",\n\t\tsizeof(dump->task_info));\n\n\tdump->taski[0].start = mt76_rr(dev, MT_FW_TASK_START);\n\tdump->taski[0].end = mt76_rr(dev, MT_FW_TASK_END);\n\tdump->taski[0].size = mt76_rr(dev, MT_FW_TASK_SIZE);\n\tdump->taski[1].start = mt76_rr(dev, MT_FW_TASK_START + offs);\n\tdump->taski[1].end = mt76_rr(dev, MT_FW_TASK_END + offs);\n\tdump->taski[1].size = mt76_rr(dev, MT_FW_TASK_SIZE + offs);\n}\n\nstatic void\nmt7915_coredump_fw_context(struct mt7915_dev *dev, struct mt7915_coredump *dump)\n{\n\tu32 count, idx, id;\n\n\tcount = mt76_rr(dev, MT_FW_CIRQ_COUNT);\n\n\t \n\tif (!count) {\n\t\tstrscpy(dump->fw_context, \"(context) interrupt\",\n\t\t\tsizeof(dump->fw_context));\n\n\t\tidx = is_mt7915(&dev->mt76) ?\n\t\t      (u32)mt76_get_field(dev, MT_FW_CIRQ_IDX, GENMASK(31, 16)) :\n\t\t      (u32)mt76_get_field(dev, MT_FW_CIRQ_IDX, GENMASK(15, 0));\n\t\tdump->context.idx = idx;\n\t\tdump->context.handler = mt76_rr(dev, MT_FW_CIRQ_LISR);\n\t} else {\n\t\tidx = mt76_rr(dev, MT_FW_TASK_IDX);\n\t\tid = mt76_rr(dev, MT_FW_TASK_ID);\n\n\t\tif (!id && idx == 3) {\n\t\t\tstrscpy(dump->fw_context, \"(context) idle\",\n\t\t\t\tsizeof(dump->fw_context));\n\t\t} else if (id && idx != 3) {\n\t\t\tstrscpy(dump->fw_context, \"(context) task\",\n\t\t\t\tsizeof(dump->fw_context));\n\n\t\t\tdump->context.idx = idx;\n\t\t\tdump->context.handler = id;\n\t\t}\n\t}\n}\n\nstatic struct mt7915_coredump *mt7915_coredump_build(struct mt7915_dev *dev)\n{\n\tstruct mt7915_crash_data *crash_data = dev->coredump.crash_data;\n\tstruct mt7915_coredump *dump;\n\tstruct mt7915_coredump_mem *dump_mem;\n\tsize_t len, sofar = 0, hdr_len = sizeof(*dump);\n\tunsigned char *buf;\n\tbool exception;\n\n\tlen = hdr_len;\n\n\tif (coredump_memdump && crash_data->memdump_buf_len)\n\t\tlen += sizeof(*dump_mem) + crash_data->memdump_buf_len;\n\n\tsofar += hdr_len;\n\n\t \n\tbuf = vzalloc(len);\n\tif (!buf)\n\t\treturn NULL;\n\n\tmutex_lock(&dev->dump_mutex);\n\n\tdump = (struct mt7915_coredump *)(buf);\n\tdump->len = len;\n\n\t \n\tstrscpy(dump->magic, \"mt76-crash-dump\", sizeof(dump->magic));\n\tstrscpy(dump->kernel, init_utsname()->release, sizeof(dump->kernel));\n\tstrscpy(dump->fw_ver, dev->mt76.hw->wiphy->fw_version,\n\t\tsizeof(dump->fw_ver));\n\n\tguid_copy(&dump->guid, &crash_data->guid);\n\tdump->tv_sec = crash_data->timestamp.tv_sec;\n\tdump->tv_nsec = crash_data->timestamp.tv_nsec;\n\tdump->device_id = mt76_chip(&dev->mt76);\n\n\tmt7915_coredump_fw_state(dev, dump, &exception);\n\tmt7915_coredump_fw_trace(dev, dump, exception);\n\tmt7915_coredump_fw_task(dev, dump);\n\tmt7915_coredump_fw_context(dev, dump);\n\tmt7915_coredump_fw_stack(dev, dump, exception);\n\n\t \n\tdump_mem = (struct mt7915_coredump_mem *)(buf + sofar);\n\tdump_mem->len = crash_data->memdump_buf_len;\n\tif (coredump_memdump && crash_data->memdump_buf_len)\n\t\tmemcpy(dump_mem->data, crash_data->memdump_buf,\n\t\t       crash_data->memdump_buf_len);\n\n\tmutex_unlock(&dev->dump_mutex);\n\n\treturn dump;\n}\n\nint mt7915_coredump_submit(struct mt7915_dev *dev)\n{\n\tstruct mt7915_coredump *dump;\n\n\tdump = mt7915_coredump_build(dev);\n\tif (!dump) {\n\t\tdev_warn(dev->mt76.dev, \"no crash dump data found\\n\");\n\t\treturn -ENODATA;\n\t}\n\n\tdev_coredumpv(dev->mt76.dev, dump, dump->len, GFP_KERNEL);\n\n\treturn 0;\n}\n\nint mt7915_coredump_register(struct mt7915_dev *dev)\n{\n\tstruct mt7915_crash_data *crash_data;\n\n\tcrash_data = vzalloc(sizeof(*dev->coredump.crash_data));\n\tif (!crash_data)\n\t\treturn -ENOMEM;\n\n\tdev->coredump.crash_data = crash_data;\n\n\tif (coredump_memdump) {\n\t\tcrash_data->memdump_buf_len = mt7915_coredump_get_mem_size(dev);\n\t\tif (!crash_data->memdump_buf_len)\n\t\t\t \n\t\t\treturn 0;\n\n\t\tcrash_data->memdump_buf = vzalloc(crash_data->memdump_buf_len);\n\t\tif (!crash_data->memdump_buf) {\n\t\t\tvfree(crash_data);\n\t\t\treturn -ENOMEM;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nvoid mt7915_coredump_unregister(struct mt7915_dev *dev)\n{\n\tif (dev->coredump.crash_data->memdump_buf) {\n\t\tvfree(dev->coredump.crash_data->memdump_buf);\n\t\tdev->coredump.crash_data->memdump_buf = NULL;\n\t\tdev->coredump.crash_data->memdump_buf_len = 0;\n\t}\n\n\tvfree(dev->coredump.crash_data);\n\tdev->coredump.crash_data = NULL;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}