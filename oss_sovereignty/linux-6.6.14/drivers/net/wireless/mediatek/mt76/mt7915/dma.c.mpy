{
  "module_name": "dma.c",
  "hash_id": "0f2fde030e5f60b4832f7728c7f975db16c474a92cdefd1c8a10cb83b4229f27",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7915/dma.c",
  "human_readable_source": "\n \n\n#include \"mt7915.h\"\n#include \"../dma.h\"\n#include \"mac.h\"\n\nstatic int\nmt7915_init_tx_queues(struct mt7915_phy *phy, int idx, int n_desc, int ring_base)\n{\n\tstruct mt7915_dev *dev = phy->dev;\n\n\tif (mtk_wed_device_active(&phy->dev->mt76.mmio.wed)) {\n\t\tif (is_mt798x(&dev->mt76))\n\t\t\tring_base += MT_TXQ_ID(0) * MT_RING_SIZE;\n\t\telse\n\t\t\tring_base = MT_WED_TX_RING_BASE;\n\n\t\tidx -= MT_TXQ_ID(0);\n\t}\n\n\treturn mt76_connac_init_tx_queues(phy->mt76, idx, n_desc, ring_base,\n\t\t\t\t\t  MT_WED_Q_TX(idx));\n}\n\nstatic int mt7915_poll_tx(struct napi_struct *napi, int budget)\n{\n\tstruct mt7915_dev *dev;\n\n\tdev = container_of(napi, struct mt7915_dev, mt76.tx_napi);\n\n\tmt76_connac_tx_cleanup(&dev->mt76);\n\tif (napi_complete_done(napi, 0))\n\t\tmt7915_irq_enable(dev, MT_INT_TX_DONE_MCU);\n\n\treturn 0;\n}\n\nstatic void mt7915_dma_config(struct mt7915_dev *dev)\n{\n#define Q_CONFIG(q, wfdma, int, id) do {\t\t\\\n\t\tif (wfdma)\t\t\t\t\\\n\t\t\tdev->wfdma_mask |= (1 << (q));\t\\\n\t\tdev->q_int_mask[(q)] = int;\t\t\\\n\t\tdev->q_id[(q)] = id;\t\t\t\\\n\t} while (0)\n\n#define MCUQ_CONFIG(q, wfdma, int, id)\tQ_CONFIG(q, (wfdma), (int), (id))\n#define RXQ_CONFIG(q, wfdma, int, id)\tQ_CONFIG(__RXQ(q), (wfdma), (int), (id))\n#define TXQ_CONFIG(q, wfdma, int, id)\tQ_CONFIG(__TXQ(q), (wfdma), (int), (id))\n\n\tif (is_mt7915(&dev->mt76)) {\n\t\tRXQ_CONFIG(MT_RXQ_MAIN, WFDMA0, MT_INT_RX_DONE_BAND0,\n\t\t\t   MT7915_RXQ_BAND0);\n\t\tRXQ_CONFIG(MT_RXQ_MCU, WFDMA1, MT_INT_RX_DONE_WM,\n\t\t\t   MT7915_RXQ_MCU_WM);\n\t\tRXQ_CONFIG(MT_RXQ_MCU_WA, WFDMA1, MT_INT_RX_DONE_WA,\n\t\t\t   MT7915_RXQ_MCU_WA);\n\t\tRXQ_CONFIG(MT_RXQ_BAND1, WFDMA0, MT_INT_RX_DONE_BAND1,\n\t\t\t   MT7915_RXQ_BAND1);\n\t\tRXQ_CONFIG(MT_RXQ_BAND1_WA, WFDMA1, MT_INT_RX_DONE_WA_EXT,\n\t\t\t   MT7915_RXQ_MCU_WA_EXT);\n\t\tRXQ_CONFIG(MT_RXQ_MAIN_WA, WFDMA1, MT_INT_RX_DONE_WA_MAIN,\n\t\t\t   MT7915_RXQ_MCU_WA);\n\t\tTXQ_CONFIG(0, WFDMA1, MT_INT_TX_DONE_BAND0, MT7915_TXQ_BAND0);\n\t\tTXQ_CONFIG(1, WFDMA1, MT_INT_TX_DONE_BAND1, MT7915_TXQ_BAND1);\n\t\tMCUQ_CONFIG(MT_MCUQ_WM, WFDMA1, MT_INT_TX_DONE_MCU_WM,\n\t\t\t    MT7915_TXQ_MCU_WM);\n\t\tMCUQ_CONFIG(MT_MCUQ_WA, WFDMA1, MT_INT_TX_DONE_MCU_WA,\n\t\t\t    MT7915_TXQ_MCU_WA);\n\t\tMCUQ_CONFIG(MT_MCUQ_FWDL, WFDMA1, MT_INT_TX_DONE_FWDL,\n\t\t\t    MT7915_TXQ_FWDL);\n\t} else {\n\t\tRXQ_CONFIG(MT_RXQ_MCU, WFDMA0, MT_INT_RX_DONE_WM,\n\t\t\t   MT7916_RXQ_MCU_WM);\n\t\tRXQ_CONFIG(MT_RXQ_BAND1_WA, WFDMA0, MT_INT_RX_DONE_WA_EXT_MT7916,\n\t\t\t   MT7916_RXQ_MCU_WA_EXT);\n\t\tMCUQ_CONFIG(MT_MCUQ_WM, WFDMA0, MT_INT_TX_DONE_MCU_WM,\n\t\t\t    MT7915_TXQ_MCU_WM);\n\t\tMCUQ_CONFIG(MT_MCUQ_WA, WFDMA0, MT_INT_TX_DONE_MCU_WA_MT7916,\n\t\t\t    MT7915_TXQ_MCU_WA);\n\t\tMCUQ_CONFIG(MT_MCUQ_FWDL, WFDMA0, MT_INT_TX_DONE_FWDL,\n\t\t\t    MT7915_TXQ_FWDL);\n\n\t\tif (is_mt7916(&dev->mt76) && mtk_wed_device_active(&dev->mt76.mmio.wed)) {\n\t\t\tRXQ_CONFIG(MT_RXQ_MAIN, WFDMA0, MT_INT_WED_RX_DONE_BAND0_MT7916,\n\t\t\t\t   MT7916_RXQ_BAND0);\n\t\t\tRXQ_CONFIG(MT_RXQ_MCU_WA, WFDMA0, MT_INT_WED_RX_DONE_WA_MT7916,\n\t\t\t\t   MT7916_RXQ_MCU_WA);\n\t\t\tif (dev->hif2)\n\t\t\t\tRXQ_CONFIG(MT_RXQ_BAND1, WFDMA0,\n\t\t\t\t\t   MT_INT_RX_DONE_BAND1_MT7916,\n\t\t\t\t\t   MT7916_RXQ_BAND1);\n\t\t\telse\n\t\t\t\tRXQ_CONFIG(MT_RXQ_BAND1, WFDMA0,\n\t\t\t\t\t   MT_INT_WED_RX_DONE_BAND1_MT7916,\n\t\t\t\t\t   MT7916_RXQ_BAND1);\n\t\t\tRXQ_CONFIG(MT_RXQ_MAIN_WA, WFDMA0, MT_INT_WED_RX_DONE_WA_MAIN_MT7916,\n\t\t\t\t   MT7916_RXQ_MCU_WA_MAIN);\n\t\t\tTXQ_CONFIG(0, WFDMA0, MT_INT_WED_TX_DONE_BAND0,\n\t\t\t\t   MT7915_TXQ_BAND0);\n\t\t\tTXQ_CONFIG(1, WFDMA0, MT_INT_WED_TX_DONE_BAND1,\n\t\t\t\t   MT7915_TXQ_BAND1);\n\t\t} else {\n\t\t\tRXQ_CONFIG(MT_RXQ_MAIN, WFDMA0, MT_INT_RX_DONE_BAND0_MT7916,\n\t\t\t\t   MT7916_RXQ_BAND0);\n\t\t\tRXQ_CONFIG(MT_RXQ_MCU_WA, WFDMA0, MT_INT_RX_DONE_WA,\n\t\t\t\t   MT7916_RXQ_MCU_WA);\n\t\t\tRXQ_CONFIG(MT_RXQ_BAND1, WFDMA0, MT_INT_RX_DONE_BAND1_MT7916,\n\t\t\t\t   MT7916_RXQ_BAND1);\n\t\t\tRXQ_CONFIG(MT_RXQ_MAIN_WA, WFDMA0, MT_INT_RX_DONE_WA_MAIN_MT7916,\n\t\t\t\t   MT7916_RXQ_MCU_WA_MAIN);\n\t\t\tTXQ_CONFIG(0, WFDMA0, MT_INT_TX_DONE_BAND0,\n\t\t\t\t   MT7915_TXQ_BAND0);\n\t\t\tTXQ_CONFIG(1, WFDMA0, MT_INT_TX_DONE_BAND1,\n\t\t\t\t   MT7915_TXQ_BAND1);\n\t\t}\n\t}\n}\n\nstatic void __mt7915_dma_prefetch(struct mt7915_dev *dev, u32 ofs)\n{\n#define PREFETCH(_base, _depth)\t((_base) << 16 | (_depth))\n\tu32 base = 0;\n\n\t \n\tmt76_wr(dev, MT_MCUQ_EXT_CTRL(MT_MCUQ_FWDL) + ofs, PREFETCH(0x0, 0x4));\n\tmt76_wr(dev, MT_MCUQ_EXT_CTRL(MT_MCUQ_WM) + ofs, PREFETCH(0x40, 0x4));\n\tmt76_wr(dev, MT_TXQ_EXT_CTRL(0) + ofs, PREFETCH(0x80, 0x4));\n\tmt76_wr(dev, MT_TXQ_EXT_CTRL(1) + ofs, PREFETCH(0xc0, 0x4));\n\tmt76_wr(dev, MT_MCUQ_EXT_CTRL(MT_MCUQ_WA) + ofs, PREFETCH(0x100, 0x4));\n\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_MCU) + ofs,\n\t\tPREFETCH(0x140, 0x4));\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_MCU_WA) + ofs,\n\t\tPREFETCH(0x180, 0x4));\n\tif (!is_mt7915(&dev->mt76)) {\n\t\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_MAIN_WA) + ofs,\n\t\t\tPREFETCH(0x1c0, 0x4));\n\t\tbase = 0x40;\n\t}\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_BAND1_WA) + ofs,\n\t\tPREFETCH(0x1c0 + base, 0x4));\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_MAIN) + ofs,\n\t\tPREFETCH(0x200 + base, 0x4));\n\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_BAND1) + ofs,\n\t\tPREFETCH(0x240 + base, 0x4));\n\n\t \n\tif (is_mt7915(&dev->mt76)) {\n\t\tofs += 0x4;\n\t\tmt76_wr(dev, MT_MCUQ_EXT_CTRL(MT_MCUQ_WA) + ofs,\n\t\t\tPREFETCH(0x140, 0x0));\n\t\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_BAND1_WA) + ofs,\n\t\t\tPREFETCH(0x200 + base, 0x0));\n\t\tmt76_wr(dev, MT_RXQ_BAND1_CTRL(MT_RXQ_BAND1) + ofs,\n\t\t\tPREFETCH(0x280 + base, 0x0));\n\t}\n}\n\nvoid mt7915_dma_prefetch(struct mt7915_dev *dev)\n{\n\t__mt7915_dma_prefetch(dev, 0);\n\tif (dev->hif2)\n\t\t__mt7915_dma_prefetch(dev, MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0));\n}\n\nstatic void mt7915_dma_disable(struct mt7915_dev *dev, bool rst)\n{\n\tstruct mt76_dev *mdev = &dev->mt76;\n\tu32 hif1_ofs = 0;\n\n\tif (dev->hif2)\n\t\thif1_ofs = MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0);\n\n\t \n\tif (rst) {\n\t\tmt76_clear(dev, MT_WFDMA0_RST,\n\t\t\t   MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t\t   MT_WFDMA0_RST_LOGIC_RST);\n\n\t\tmt76_set(dev, MT_WFDMA0_RST,\n\t\t\t MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t\t MT_WFDMA0_RST_LOGIC_RST);\n\n\t\tif (is_mt7915(mdev)) {\n\t\t\tmt76_clear(dev, MT_WFDMA1_RST,\n\t\t\t\t   MT_WFDMA1_RST_DMASHDL_ALL_RST |\n\t\t\t\t   MT_WFDMA1_RST_LOGIC_RST);\n\n\t\t\tmt76_set(dev, MT_WFDMA1_RST,\n\t\t\t\t MT_WFDMA1_RST_DMASHDL_ALL_RST |\n\t\t\t\t MT_WFDMA1_RST_LOGIC_RST);\n\t\t}\n\n\t\tif (dev->hif2) {\n\t\t\tmt76_clear(dev, MT_WFDMA0_RST + hif1_ofs,\n\t\t\t\t   MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t\t\t   MT_WFDMA0_RST_LOGIC_RST);\n\n\t\t\tmt76_set(dev, MT_WFDMA0_RST + hif1_ofs,\n\t\t\t\t MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t\t\t MT_WFDMA0_RST_LOGIC_RST);\n\n\t\t\tif (is_mt7915(mdev)) {\n\t\t\t\tmt76_clear(dev, MT_WFDMA1_RST + hif1_ofs,\n\t\t\t\t\t   MT_WFDMA1_RST_DMASHDL_ALL_RST |\n\t\t\t\t\t   MT_WFDMA1_RST_LOGIC_RST);\n\n\t\t\t\tmt76_set(dev, MT_WFDMA1_RST + hif1_ofs,\n\t\t\t\t\t MT_WFDMA1_RST_DMASHDL_ALL_RST |\n\t\t\t\t\t MT_WFDMA1_RST_LOGIC_RST);\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tmt76_clear(dev, MT_WFDMA0_GLO_CFG,\n\t\t   MT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t   MT_WFDMA0_GLO_CFG_RX_DMA_EN |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\n\tif (is_mt7915(mdev))\n\t\tmt76_clear(dev, MT_WFDMA1_GLO_CFG,\n\t\t\t   MT_WFDMA1_GLO_CFG_TX_DMA_EN |\n\t\t\t   MT_WFDMA1_GLO_CFG_RX_DMA_EN |\n\t\t\t   MT_WFDMA1_GLO_CFG_OMIT_TX_INFO |\n\t\t\t   MT_WFDMA1_GLO_CFG_OMIT_RX_INFO |\n\t\t\t   MT_WFDMA1_GLO_CFG_OMIT_RX_INFO_PFET2);\n\n\tif (dev->hif2) {\n\t\tmt76_clear(dev, MT_WFDMA0_GLO_CFG + hif1_ofs,\n\t\t\t   MT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t\t   MT_WFDMA0_GLO_CFG_RX_DMA_EN |\n\t\t\t   MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO |\n\t\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\n\t\tif (is_mt7915(mdev))\n\t\t\tmt76_clear(dev, MT_WFDMA1_GLO_CFG + hif1_ofs,\n\t\t\t\t   MT_WFDMA1_GLO_CFG_TX_DMA_EN |\n\t\t\t\t   MT_WFDMA1_GLO_CFG_RX_DMA_EN |\n\t\t\t\t   MT_WFDMA1_GLO_CFG_OMIT_TX_INFO |\n\t\t\t\t   MT_WFDMA1_GLO_CFG_OMIT_RX_INFO |\n\t\t\t\t   MT_WFDMA1_GLO_CFG_OMIT_RX_INFO_PFET2);\n\t}\n}\n\nint mt7915_dma_start(struct mt7915_dev *dev, bool reset, bool wed_reset)\n{\n\tstruct mt76_dev *mdev = &dev->mt76;\n\tu32 hif1_ofs = 0;\n\tu32 irq_mask;\n\n\tif (dev->hif2)\n\t\thif1_ofs = MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0);\n\n\t \n\tif (!reset) {\n\t\tmt76_set(dev, MT_WFDMA0_GLO_CFG,\n\t\t\tMT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t\tMT_WFDMA0_GLO_CFG_RX_DMA_EN |\n\t\t\tMT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t\tMT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\n\t\tif (is_mt7915(mdev))\n\t\t\tmt76_set(dev, MT_WFDMA1_GLO_CFG,\n\t\t\t\tMT_WFDMA1_GLO_CFG_TX_DMA_EN |\n\t\t\t\tMT_WFDMA1_GLO_CFG_RX_DMA_EN |\n\t\t\t\tMT_WFDMA1_GLO_CFG_OMIT_TX_INFO |\n\t\t\t\tMT_WFDMA1_GLO_CFG_OMIT_RX_INFO);\n\n\t\tif (dev->hif2) {\n\t\t\tmt76_set(dev, MT_WFDMA0_GLO_CFG + hif1_ofs,\n\t\t\t\tMT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t\t\tMT_WFDMA0_GLO_CFG_RX_DMA_EN |\n\t\t\t\tMT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t\t\tMT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\n\t\t\tif (is_mt7915(mdev))\n\t\t\t\tmt76_set(dev, MT_WFDMA1_GLO_CFG + hif1_ofs,\n\t\t\t\t\tMT_WFDMA1_GLO_CFG_TX_DMA_EN |\n\t\t\t\t\tMT_WFDMA1_GLO_CFG_RX_DMA_EN |\n\t\t\t\t\tMT_WFDMA1_GLO_CFG_OMIT_TX_INFO |\n\t\t\t\t\tMT_WFDMA1_GLO_CFG_OMIT_RX_INFO);\n\n\t\t\tmt76_set(dev, MT_WFDMA_HOST_CONFIG,\n\t\t\t\tMT_WFDMA_HOST_CONFIG_PDMA_BAND);\n\t\t}\n\t}\n\n\t \n\tirq_mask = MT_INT_RX_DONE_MCU |\n\t\t   MT_INT_TX_DONE_MCU |\n\t\t   MT_INT_MCU_CMD;\n\n\tif (!dev->phy.mt76->band_idx)\n\t\tirq_mask |= MT_INT_BAND0_RX_DONE;\n\n\tif (dev->dbdc_support || dev->phy.mt76->band_idx)\n\t\tirq_mask |= MT_INT_BAND1_RX_DONE;\n\n\tif (mtk_wed_device_active(&dev->mt76.mmio.wed) && wed_reset) {\n\t\tu32 wed_irq_mask = irq_mask;\n\t\tint ret;\n\n\t\twed_irq_mask |= MT_INT_TX_DONE_BAND0 | MT_INT_TX_DONE_BAND1;\n\t\tif (!is_mt798x(&dev->mt76))\n\t\t\tmt76_wr(dev, MT_INT_WED_MASK_CSR, wed_irq_mask);\n\t\telse\n\t\t\tmt76_wr(dev, MT_INT_MASK_CSR, wed_irq_mask);\n\n\t\tret = mt7915_mcu_wed_enable_rx_stats(dev);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tmtk_wed_device_start(&dev->mt76.mmio.wed, wed_irq_mask);\n\t}\n\n\tirq_mask = reset ? MT_INT_MCU_CMD : irq_mask;\n\n\tmt7915_irq_enable(dev, irq_mask);\n\tmt7915_irq_disable(dev, 0);\n\n\treturn 0;\n}\n\nstatic int mt7915_dma_enable(struct mt7915_dev *dev, bool reset)\n{\n\tstruct mt76_dev *mdev = &dev->mt76;\n\tu32 hif1_ofs = 0;\n\n\tif (dev->hif2)\n\t\thif1_ofs = MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0);\n\n\t \n\tmt76_wr(dev, MT_WFDMA0_RST_DTX_PTR, ~0);\n\tif (is_mt7915(mdev))\n\t\tmt76_wr(dev, MT_WFDMA1_RST_DTX_PTR, ~0);\n\tif (dev->hif2) {\n\t\tmt76_wr(dev, MT_WFDMA0_RST_DTX_PTR + hif1_ofs, ~0);\n\t\tif (is_mt7915(mdev))\n\t\t\tmt76_wr(dev, MT_WFDMA1_RST_DTX_PTR + hif1_ofs, ~0);\n\t}\n\n\t \n\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG0, 0);\n\tif (is_mt7915(mdev)) {\n\t\tmt76_wr(dev, MT_WFDMA1_PRI_DLY_INT_CFG0, 0);\n\t} else {\n\t\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG1, 0);\n\t\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG2, 0);\n\t}\n\n\tif (dev->hif2) {\n\t\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG0 + hif1_ofs, 0);\n\t\tif (is_mt7915(mdev)) {\n\t\t\tmt76_wr(dev, MT_WFDMA1_PRI_DLY_INT_CFG0 +\n\t\t\t\thif1_ofs, 0);\n\t\t} else {\n\t\t\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG1 +\n\t\t\t\thif1_ofs, 0);\n\t\t\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG2 +\n\t\t\t\thif1_ofs, 0);\n\t\t}\n\t}\n\n\t \n\tmt7915_dma_prefetch(dev);\n\n\t \n\tmt76_set(dev, MT_WFDMA0_BUSY_ENA,\n\t\t MT_WFDMA0_BUSY_ENA_TX_FIFO0 |\n\t\t MT_WFDMA0_BUSY_ENA_TX_FIFO1 |\n\t\t MT_WFDMA0_BUSY_ENA_RX_FIFO);\n\n\tif (is_mt7915(mdev))\n\t\tmt76_set(dev, MT_WFDMA1_BUSY_ENA,\n\t\t\t MT_WFDMA1_BUSY_ENA_TX_FIFO0 |\n\t\t\t MT_WFDMA1_BUSY_ENA_TX_FIFO1 |\n\t\t\t MT_WFDMA1_BUSY_ENA_RX_FIFO);\n\n\tif (dev->hif2) {\n\t\tmt76_set(dev, MT_WFDMA0_BUSY_ENA + hif1_ofs,\n\t\t\t MT_WFDMA0_PCIE1_BUSY_ENA_TX_FIFO0 |\n\t\t\t MT_WFDMA0_PCIE1_BUSY_ENA_TX_FIFO1 |\n\t\t\t MT_WFDMA0_PCIE1_BUSY_ENA_RX_FIFO);\n\n\t\tif (is_mt7915(mdev))\n\t\t\tmt76_set(dev, MT_WFDMA1_BUSY_ENA + hif1_ofs,\n\t\t\t\t MT_WFDMA1_PCIE1_BUSY_ENA_TX_FIFO0 |\n\t\t\t\t MT_WFDMA1_PCIE1_BUSY_ENA_TX_FIFO1 |\n\t\t\t\t MT_WFDMA1_PCIE1_BUSY_ENA_RX_FIFO);\n\t}\n\n\tmt76_poll(dev, MT_WFDMA_EXT_CSR_HIF_MISC,\n\t\t  MT_WFDMA_EXT_CSR_HIF_MISC_BUSY, 0, 1000);\n\n\treturn mt7915_dma_start(dev, reset, true);\n}\n\nint mt7915_dma_init(struct mt7915_dev *dev, struct mt7915_phy *phy2)\n{\n\tstruct mt76_dev *mdev = &dev->mt76;\n\tu32 wa_rx_base, wa_rx_idx;\n\tu32 hif1_ofs = 0;\n\tint ret;\n\n\tmt7915_dma_config(dev);\n\n\tmt76_dma_attach(&dev->mt76);\n\n\tif (dev->hif2)\n\t\thif1_ofs = MT_WFDMA0_PCIE1(0) - MT_WFDMA0(0);\n\n\tmt7915_dma_disable(dev, true);\n\n\tif (mtk_wed_device_active(&mdev->mmio.wed)) {\n\t\tif (!is_mt798x(mdev)) {\n\t\t\tu8 wed_control_rx1 = is_mt7915(mdev) ? 1 : 2;\n\n\t\t\tmt76_set(dev, MT_WFDMA_HOST_CONFIG,\n\t\t\t\t MT_WFDMA_HOST_CONFIG_WED);\n\t\t\tmt76_wr(dev, MT_WFDMA_WED_RING_CONTROL,\n\t\t\t\tFIELD_PREP(MT_WFDMA_WED_RING_CONTROL_TX0, 18) |\n\t\t\t\tFIELD_PREP(MT_WFDMA_WED_RING_CONTROL_TX1, 19) |\n\t\t\t\tFIELD_PREP(MT_WFDMA_WED_RING_CONTROL_RX1,\n\t\t\t\t\t   wed_control_rx1));\n\t\t\tif (is_mt7915(mdev))\n\t\t\t\tmt76_rmw(dev, MT_WFDMA0_EXT0_CFG, MT_WFDMA0_EXT0_RXWB_KEEP,\n\t\t\t\t\t MT_WFDMA0_EXT0_RXWB_KEEP);\n\t\t}\n\t} else {\n\t\tmt76_clear(dev, MT_WFDMA_HOST_CONFIG, MT_WFDMA_HOST_CONFIG_WED);\n\t}\n\n\t \n\tret = mt7915_init_tx_queues(&dev->phy,\n\t\t\t\t    MT_TXQ_ID(dev->phy.mt76->band_idx),\n\t\t\t\t    MT7915_TX_RING_SIZE,\n\t\t\t\t    MT_TXQ_RING_BASE(0));\n\tif (ret)\n\t\treturn ret;\n\n\tif (phy2) {\n\t\tret = mt7915_init_tx_queues(phy2,\n\t\t\t\t\t    MT_TXQ_ID(phy2->mt76->band_idx),\n\t\t\t\t\t    MT7915_TX_RING_SIZE,\n\t\t\t\t\t    MT_TXQ_RING_BASE(1));\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\tret = mt76_init_mcu_queue(&dev->mt76, MT_MCUQ_WM,\n\t\t\t\t  MT_MCUQ_ID(MT_MCUQ_WM),\n\t\t\t\t  MT7915_TX_MCU_RING_SIZE,\n\t\t\t\t  MT_MCUQ_RING_BASE(MT_MCUQ_WM));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_init_mcu_queue(&dev->mt76, MT_MCUQ_WA,\n\t\t\t\t  MT_MCUQ_ID(MT_MCUQ_WA),\n\t\t\t\t  MT7915_TX_MCU_RING_SIZE,\n\t\t\t\t  MT_MCUQ_RING_BASE(MT_MCUQ_WA));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_init_mcu_queue(&dev->mt76, MT_MCUQ_FWDL,\n\t\t\t\t  MT_MCUQ_ID(MT_MCUQ_FWDL),\n\t\t\t\t  MT7915_TX_FWDL_RING_SIZE,\n\t\t\t\t  MT_MCUQ_RING_BASE(MT_MCUQ_FWDL));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_MCU],\n\t\t\t       MT_RXQ_ID(MT_RXQ_MCU),\n\t\t\t       MT7915_RX_MCU_RING_SIZE,\n\t\t\t       MT_RX_BUF_SIZE,\n\t\t\t       MT_RXQ_RING_BASE(MT_RXQ_MCU));\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (mtk_wed_device_active(&mdev->mmio.wed) && is_mt7915(mdev)) {\n\t\twa_rx_base = MT_WED_RX_RING_BASE;\n\t\twa_rx_idx = MT7915_RXQ_MCU_WA;\n\t\tdev->mt76.q_rx[MT_RXQ_MCU_WA].flags = MT_WED_Q_TXFREE;\n\t} else {\n\t\twa_rx_base = MT_RXQ_RING_BASE(MT_RXQ_MCU_WA);\n\t\twa_rx_idx = MT_RXQ_ID(MT_RXQ_MCU_WA);\n\t}\n\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_MCU_WA],\n\t\t\t       wa_rx_idx, MT7915_RX_MCU_RING_SIZE,\n\t\t\t       MT_RX_BUF_SIZE, wa_rx_base);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (!dev->phy.mt76->band_idx) {\n\t\tif (mtk_wed_device_active(&mdev->mmio.wed) &&\n\t\t    mtk_wed_get_rx_capa(&mdev->mmio.wed)) {\n\t\t\tdev->mt76.q_rx[MT_RXQ_MAIN].flags =\n\t\t\t\tMT_WED_Q_RX(MT7915_RXQ_BAND0);\n\t\t\tdev->mt76.rx_token_size += MT7915_RX_RING_SIZE;\n\t\t}\n\n\t\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_MAIN],\n\t\t\t\t       MT_RXQ_ID(MT_RXQ_MAIN),\n\t\t\t\t       MT7915_RX_RING_SIZE,\n\t\t\t\t       MT_RX_BUF_SIZE,\n\t\t\t\t       MT_RXQ_RING_BASE(MT_RXQ_MAIN));\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (!is_mt7915(mdev)) {\n\t\twa_rx_base = MT_RXQ_RING_BASE(MT_RXQ_MAIN_WA);\n\t\twa_rx_idx = MT_RXQ_ID(MT_RXQ_MAIN_WA);\n\n\t\tif (mtk_wed_device_active(&mdev->mmio.wed)) {\n\t\t\tmdev->q_rx[MT_RXQ_MAIN_WA].flags = MT_WED_Q_TXFREE;\n\t\t\tif (is_mt7916(mdev)) {\n\t\t\t\twa_rx_base =  MT_WED_RX_RING_BASE;\n\t\t\t\twa_rx_idx = MT7915_RXQ_MCU_WA;\n\t\t\t}\n\t\t}\n\n\t\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_MAIN_WA],\n\t\t\t\t       wa_rx_idx, MT7915_RX_MCU_RING_SIZE,\n\t\t\t\t       MT_RX_BUF_SIZE, wa_rx_base);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tif (dev->dbdc_support || dev->phy.mt76->band_idx) {\n\t\tif (mtk_wed_device_active(&mdev->mmio.wed) &&\n\t\t    mtk_wed_get_rx_capa(&mdev->mmio.wed)) {\n\t\t\tdev->mt76.q_rx[MT_RXQ_BAND1].flags =\n\t\t\t\tMT_WED_Q_RX(MT7915_RXQ_BAND1);\n\t\t\tdev->mt76.rx_token_size += MT7915_RX_RING_SIZE;\n\t\t}\n\n\t\t \n\t\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_BAND1],\n\t\t\t\t       MT_RXQ_ID(MT_RXQ_BAND1),\n\t\t\t\t       MT7915_RX_RING_SIZE,\n\t\t\t\t       MT_RX_BUF_SIZE,\n\t\t\t\t       MT_RXQ_RING_BASE(MT_RXQ_BAND1) + hif1_ofs);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tret = mt76_queue_alloc(dev, &dev->mt76.q_rx[MT_RXQ_BAND1_WA],\n\t\t\t\t       MT_RXQ_ID(MT_RXQ_BAND1_WA),\n\t\t\t\t       MT7915_RX_MCU_RING_SIZE,\n\t\t\t\t       MT_RX_BUF_SIZE,\n\t\t\t\t       MT_RXQ_RING_BASE(MT_RXQ_BAND1_WA) + hif1_ofs);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = mt76_init_queues(dev, mt76_dma_rx_poll);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tnetif_napi_add_tx(&dev->mt76.tx_napi_dev, &dev->mt76.tx_napi,\n\t\t\t  mt7915_poll_tx);\n\tnapi_enable(&dev->mt76.tx_napi);\n\n\tmt7915_dma_enable(dev, false);\n\n\treturn 0;\n}\n\nstatic void mt7915_dma_wed_reset(struct mt7915_dev *dev)\n{\n\tstruct mt76_dev *mdev = &dev->mt76;\n\n\tif (!test_bit(MT76_STATE_WED_RESET, &dev->mphy.state))\n\t\treturn;\n\n\tcomplete(&mdev->mmio.wed_reset);\n\n\tif (!wait_for_completion_timeout(&dev->mt76.mmio.wed_reset_complete,\n\t\t\t\t\t 3 * HZ))\n\t\tdev_err(dev->mt76.dev, \"wed reset complete timeout\\n\");\n}\n\nstatic void\nmt7915_dma_reset_tx_queue(struct mt7915_dev *dev, struct mt76_queue *q)\n{\n\tmt76_queue_reset(dev, q);\n\tif (mtk_wed_device_active(&dev->mt76.mmio.wed))\n\t\tmt76_dma_wed_setup(&dev->mt76, q, true);\n}\n\nint mt7915_dma_reset(struct mt7915_dev *dev, bool force)\n{\n\tstruct mt76_phy *mphy_ext = dev->mt76.phys[MT_BAND1];\n\tstruct mtk_wed_device *wed = &dev->mt76.mmio.wed;\n\tint i;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(dev->mt76.phy.q_tx); i++) {\n\t\tmt76_queue_tx_cleanup(dev, dev->mphy.q_tx[i], true);\n\t\tif (mphy_ext)\n\t\t\tmt76_queue_tx_cleanup(dev, mphy_ext->q_tx[i], true);\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(dev->mt76.q_mcu); i++)\n\t\tmt76_queue_tx_cleanup(dev, dev->mt76.q_mcu[i], true);\n\n\tmt76_for_each_q_rx(&dev->mt76, i)\n\t\tmt76_queue_rx_cleanup(dev, &dev->mt76.q_rx[i]);\n\n\t \n\tif (force)\n\t\tmt7915_wfsys_reset(dev);\n\n\tif (mtk_wed_device_active(wed))\n\t\tmtk_wed_device_dma_reset(wed);\n\n\tmt7915_dma_disable(dev, force);\n\tmt7915_dma_wed_reset(dev);\n\n\t \n\tfor (i = 0; i < __MT_TXQ_MAX; i++) {\n\t\tmt7915_dma_reset_tx_queue(dev, dev->mphy.q_tx[i]);\n\t\tif (mphy_ext)\n\t\t\tmt7915_dma_reset_tx_queue(dev, mphy_ext->q_tx[i]);\n\t}\n\n\tfor (i = 0; i < __MT_MCUQ_MAX; i++)\n\t\tmt76_queue_reset(dev, dev->mt76.q_mcu[i]);\n\n\tmt76_for_each_q_rx(&dev->mt76, i) {\n\t\tif (dev->mt76.q_rx[i].flags == MT_WED_Q_TXFREE)\n\t\t\tcontinue;\n\n\t\tmt76_queue_reset(dev, &dev->mt76.q_rx[i]);\n\t}\n\n\tmt76_tx_status_check(&dev->mt76, true);\n\n\tmt76_for_each_q_rx(&dev->mt76, i)\n\t\tmt76_queue_rx_reset(dev, i);\n\n\tif (mtk_wed_device_active(wed) && is_mt7915(&dev->mt76))\n\t\tmt76_rmw(dev, MT_WFDMA0_EXT0_CFG, MT_WFDMA0_EXT0_RXWB_KEEP,\n\t\t\t MT_WFDMA0_EXT0_RXWB_KEEP);\n\n\tmt7915_dma_enable(dev, !force);\n\n\treturn 0;\n}\n\nvoid mt7915_dma_cleanup(struct mt7915_dev *dev)\n{\n\tmt7915_dma_disable(dev, true);\n\n\tmt76_dma_cleanup(&dev->mt76);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}