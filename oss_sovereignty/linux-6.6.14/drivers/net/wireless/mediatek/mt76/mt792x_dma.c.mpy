{
  "module_name": "mt792x_dma.c",
  "hash_id": "ea378b64c0d23f03c211dc34483b57a1338183ae2fd985096cd00ba3207358a2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt792x_dma.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/firmware.h>\n\n#include \"mt792x.h\"\n#include \"dma.h\"\n#include \"trace.h\"\n\nirqreturn_t mt792x_irq_handler(int irq, void *dev_instance)\n{\n\tstruct mt792x_dev *dev = dev_instance;\n\n\tmt76_wr(dev, dev->irq_map->host_irq_enable, 0);\n\n\tif (!test_bit(MT76_STATE_INITIALIZED, &dev->mphy.state))\n\t\treturn IRQ_NONE;\n\n\ttasklet_schedule(&dev->mt76.irq_tasklet);\n\n\treturn IRQ_HANDLED;\n}\nEXPORT_SYMBOL_GPL(mt792x_irq_handler);\n\nvoid mt792x_irq_tasklet(unsigned long data)\n{\n\tstruct mt792x_dev *dev = (struct mt792x_dev *)data;\n\tconst struct mt792x_irq_map *irq_map = dev->irq_map;\n\tu32 intr, mask = 0;\n\n\tmt76_wr(dev, irq_map->host_irq_enable, 0);\n\n\tintr = mt76_rr(dev, MT_WFDMA0_HOST_INT_STA);\n\tintr &= dev->mt76.mmio.irqmask;\n\tmt76_wr(dev, MT_WFDMA0_HOST_INT_STA, intr);\n\n\ttrace_dev_irq(&dev->mt76, intr, dev->mt76.mmio.irqmask);\n\n\tmask |= intr & (irq_map->rx.data_complete_mask |\n\t\t\tirq_map->rx.wm_complete_mask |\n\t\t\tirq_map->rx.wm2_complete_mask);\n\tif (intr & dev->irq_map->tx.mcu_complete_mask)\n\t\tmask |= dev->irq_map->tx.mcu_complete_mask;\n\n\tif (intr & MT_INT_MCU_CMD) {\n\t\tu32 intr_sw;\n\n\t\tintr_sw = mt76_rr(dev, MT_MCU_CMD);\n\t\t \n\t\tmt76_wr(dev, MT_MCU_CMD, intr_sw);\n\t\tif (intr_sw & MT_MCU_CMD_WAKE_RX_PCIE) {\n\t\t\tmask |= irq_map->rx.data_complete_mask;\n\t\t\tintr |= irq_map->rx.data_complete_mask;\n\t\t}\n\t}\n\n\tmt76_set_irq_mask(&dev->mt76, irq_map->host_irq_enable, mask, 0);\n\n\tif (intr & dev->irq_map->tx.all_complete_mask)\n\t\tnapi_schedule(&dev->mt76.tx_napi);\n\n\tif (intr & irq_map->rx.wm_complete_mask)\n\t\tnapi_schedule(&dev->mt76.napi[MT_RXQ_MCU]);\n\n\tif (intr & irq_map->rx.wm2_complete_mask)\n\t\tnapi_schedule(&dev->mt76.napi[MT_RXQ_MCU_WA]);\n\n\tif (intr & irq_map->rx.data_complete_mask)\n\t\tnapi_schedule(&dev->mt76.napi[MT_RXQ_MAIN]);\n}\nEXPORT_SYMBOL_GPL(mt792x_irq_tasklet);\n\nvoid mt792x_rx_poll_complete(struct mt76_dev *mdev, enum mt76_rxq_id q)\n{\n\tstruct mt792x_dev *dev = container_of(mdev, struct mt792x_dev, mt76);\n\tconst struct mt792x_irq_map *irq_map = dev->irq_map;\n\n\tif (q == MT_RXQ_MAIN)\n\t\tmt76_connac_irq_enable(mdev, irq_map->rx.data_complete_mask);\n\telse if (q == MT_RXQ_MCU_WA)\n\t\tmt76_connac_irq_enable(mdev, irq_map->rx.wm2_complete_mask);\n\telse\n\t\tmt76_connac_irq_enable(mdev, irq_map->rx.wm_complete_mask);\n}\nEXPORT_SYMBOL_GPL(mt792x_rx_poll_complete);\n\n#define PREFETCH(base, depth)\t((base) << 16 | (depth))\nstatic void mt792x_dma_prefetch(struct mt792x_dev *dev)\n{\n\tmt76_wr(dev, MT_WFDMA0_RX_RING0_EXT_CTRL, PREFETCH(0x0, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_RX_RING2_EXT_CTRL, PREFETCH(0x40, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_RX_RING3_EXT_CTRL, PREFETCH(0x80, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_RX_RING4_EXT_CTRL, PREFETCH(0xc0, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_RX_RING5_EXT_CTRL, PREFETCH(0x100, 0x4));\n\n\tmt76_wr(dev, MT_WFDMA0_TX_RING0_EXT_CTRL, PREFETCH(0x140, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_TX_RING1_EXT_CTRL, PREFETCH(0x180, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_TX_RING2_EXT_CTRL, PREFETCH(0x1c0, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_TX_RING3_EXT_CTRL, PREFETCH(0x200, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_TX_RING4_EXT_CTRL, PREFETCH(0x240, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_TX_RING5_EXT_CTRL, PREFETCH(0x280, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_TX_RING6_EXT_CTRL, PREFETCH(0x2c0, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_TX_RING16_EXT_CTRL, PREFETCH(0x340, 0x4));\n\tmt76_wr(dev, MT_WFDMA0_TX_RING17_EXT_CTRL, PREFETCH(0x380, 0x4));\n}\n\nint mt792x_dma_enable(struct mt792x_dev *dev)\n{\n\t \n\tmt792x_dma_prefetch(dev);\n\n\t \n\tmt76_wr(dev, MT_WFDMA0_RST_DTX_PTR, ~0);\n\n\t \n\tmt76_wr(dev, MT_WFDMA0_PRI_DLY_INT_CFG0, 0);\n\n\tmt76_set(dev, MT_WFDMA0_GLO_CFG,\n\t\t MT_WFDMA0_GLO_CFG_TX_WB_DDONE |\n\t\t MT_WFDMA0_GLO_CFG_FIFO_LITTLE_ENDIAN |\n\t\t MT_WFDMA0_GLO_CFG_CLK_GAT_DIS |\n\t\t MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t MT_WFDMA0_GLO_CFG_CSR_DISP_BASE_PTR_CHAIN_EN |\n\t\t MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\n\tmt76_set(dev, MT_WFDMA0_GLO_CFG,\n\t\t MT_WFDMA0_GLO_CFG_TX_DMA_EN | MT_WFDMA0_GLO_CFG_RX_DMA_EN);\n\n\tmt76_set(dev, MT_WFDMA_DUMMY_CR, MT_WFDMA_NEED_REINIT);\n\n\t \n\tmt76_connac_irq_enable(&dev->mt76,\n\t\t\t       dev->irq_map->tx.all_complete_mask |\n\t\t\t       dev->irq_map->rx.data_complete_mask |\n\t\t\t       dev->irq_map->rx.wm2_complete_mask |\n\t\t\t       dev->irq_map->rx.wm_complete_mask |\n\t\t\t       MT_INT_MCU_CMD);\n\tmt76_set(dev, MT_MCU2HOST_SW_INT_ENA, MT_MCU_CMD_WAKE_RX_PCIE);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt792x_dma_enable);\n\nstatic int\nmt792x_dma_reset(struct mt792x_dev *dev, bool force)\n{\n\tint i, err;\n\n\terr = mt792x_dma_disable(dev, force);\n\tif (err)\n\t\treturn err;\n\n\t \n\tfor (i = 0; i < __MT_TXQ_MAX; i++)\n\t\tmt76_queue_reset(dev, dev->mphy.q_tx[i]);\n\n\tfor (i = 0; i < __MT_MCUQ_MAX; i++)\n\t\tmt76_queue_reset(dev, dev->mt76.q_mcu[i]);\n\n\tmt76_for_each_q_rx(&dev->mt76, i)\n\t\tmt76_queue_reset(dev, &dev->mt76.q_rx[i]);\n\n\tmt76_tx_status_check(&dev->mt76, true);\n\n\treturn mt792x_dma_enable(dev);\n}\n\nint mt792x_wpdma_reset(struct mt792x_dev *dev, bool force)\n{\n\tint i, err;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(dev->mt76.phy.q_tx); i++)\n\t\tmt76_queue_tx_cleanup(dev, dev->mphy.q_tx[i], true);\n\n\tfor (i = 0; i < ARRAY_SIZE(dev->mt76.q_mcu); i++)\n\t\tmt76_queue_tx_cleanup(dev, dev->mt76.q_mcu[i], true);\n\n\tmt76_for_each_q_rx(&dev->mt76, i)\n\t\tmt76_queue_rx_cleanup(dev, &dev->mt76.q_rx[i]);\n\n\tif (force) {\n\t\terr = mt792x_wfsys_reset(dev);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\terr = mt792x_dma_reset(dev, force);\n\tif (err)\n\t\treturn err;\n\n\tmt76_for_each_q_rx(&dev->mt76, i)\n\t\tmt76_queue_rx_reset(dev, i);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt792x_wpdma_reset);\n\nint mt792x_wpdma_reinit_cond(struct mt792x_dev *dev)\n{\n\tstruct mt76_connac_pm *pm = &dev->pm;\n\tint err;\n\n\t \n\tif (mt792x_dma_need_reinit(dev)) {\n\t\t \n\t\tmt76_wr(dev, dev->irq_map->host_irq_enable, 0);\n\t\tmt76_wr(dev, MT_PCIE_MAC_INT_ENABLE, 0x0);\n\n\t\terr = mt792x_wpdma_reset(dev, false);\n\t\tif (err) {\n\t\t\tdev_err(dev->mt76.dev, \"wpdma reset failed\\n\");\n\t\t\treturn err;\n\t\t}\n\n\t\t \n\t\tmt76_wr(dev, MT_PCIE_MAC_INT_ENABLE, 0xff);\n\t\tpm->stats.lp_wake++;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt792x_wpdma_reinit_cond);\n\nint mt792x_dma_disable(struct mt792x_dev *dev, bool force)\n{\n\t \n\tmt76_clear(dev, MT_WFDMA0_GLO_CFG,\n\t\t   MT_WFDMA0_GLO_CFG_TX_DMA_EN | MT_WFDMA0_GLO_CFG_RX_DMA_EN |\n\t\t   MT_WFDMA0_GLO_CFG_CSR_DISP_BASE_PTR_CHAIN_EN |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\n\tif (!mt76_poll_msec_tick(dev, MT_WFDMA0_GLO_CFG,\n\t\t\t\t MT_WFDMA0_GLO_CFG_TX_DMA_BUSY |\n\t\t\t\t MT_WFDMA0_GLO_CFG_RX_DMA_BUSY, 0, 100, 1))\n\t\treturn -ETIMEDOUT;\n\n\t \n\tmt76_clear(dev, MT_WFDMA0_GLO_CFG_EXT0,\n\t\t   MT_WFDMA0_CSR_TX_DMASHDL_ENABLE);\n\tmt76_set(dev, MT_DMASHDL_SW_CONTROL, MT_DMASHDL_DMASHDL_BYPASS);\n\n\tif (force) {\n\t\t \n\t\tmt76_clear(dev, MT_WFDMA0_RST,\n\t\t\t   MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t\t   MT_WFDMA0_RST_LOGIC_RST);\n\n\t\tmt76_set(dev, MT_WFDMA0_RST,\n\t\t\t MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t\t MT_WFDMA0_RST_LOGIC_RST);\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt792x_dma_disable);\n\nvoid mt792x_dma_cleanup(struct mt792x_dev *dev)\n{\n\t \n\tmt76_clear(dev, MT_WFDMA0_GLO_CFG,\n\t\t   MT_WFDMA0_GLO_CFG_TX_DMA_EN |\n\t\t   MT_WFDMA0_GLO_CFG_RX_DMA_EN |\n\t\t   MT_WFDMA0_GLO_CFG_CSR_DISP_BASE_PTR_CHAIN_EN |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_TX_INFO |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO |\n\t\t   MT_WFDMA0_GLO_CFG_OMIT_RX_INFO_PFET2);\n\n\tmt76_poll_msec_tick(dev, MT_WFDMA0_GLO_CFG,\n\t\t\t    MT_WFDMA0_GLO_CFG_TX_DMA_BUSY |\n\t\t\t    MT_WFDMA0_GLO_CFG_RX_DMA_BUSY, 0, 100, 1);\n\n\t \n\tmt76_clear(dev, MT_WFDMA0_RST,\n\t\t   MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t   MT_WFDMA0_RST_LOGIC_RST);\n\n\tmt76_set(dev, MT_WFDMA0_RST,\n\t\t MT_WFDMA0_RST_DMASHDL_ALL_RST |\n\t\t MT_WFDMA0_RST_LOGIC_RST);\n\n\tmt76_dma_cleanup(&dev->mt76);\n}\nEXPORT_SYMBOL_GPL(mt792x_dma_cleanup);\n\nint mt792x_poll_tx(struct napi_struct *napi, int budget)\n{\n\tstruct mt792x_dev *dev;\n\n\tdev = container_of(napi, struct mt792x_dev, mt76.tx_napi);\n\n\tif (!mt76_connac_pm_ref(&dev->mphy, &dev->pm)) {\n\t\tnapi_complete(napi);\n\t\tqueue_work(dev->mt76.wq, &dev->pm.wake_work);\n\t\treturn 0;\n\t}\n\n\tmt76_connac_tx_cleanup(&dev->mt76);\n\tif (napi_complete(napi))\n\t\tmt76_connac_irq_enable(&dev->mt76,\n\t\t\t\t       dev->irq_map->tx.all_complete_mask);\n\tmt76_connac_pm_unref(&dev->mphy, &dev->pm);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt792x_poll_tx);\n\nint mt792x_poll_rx(struct napi_struct *napi, int budget)\n{\n\tstruct mt792x_dev *dev;\n\tint done;\n\n\tdev = container_of(napi->dev, struct mt792x_dev, mt76.napi_dev);\n\n\tif (!mt76_connac_pm_ref(&dev->mphy, &dev->pm)) {\n\t\tnapi_complete(napi);\n\t\tqueue_work(dev->mt76.wq, &dev->pm.wake_work);\n\t\treturn 0;\n\t}\n\tdone = mt76_dma_rx_poll(napi, budget);\n\tmt76_connac_pm_unref(&dev->mphy, &dev->pm);\n\n\treturn done;\n}\nEXPORT_SYMBOL_GPL(mt792x_poll_rx);\n\nint mt792x_wfsys_reset(struct mt792x_dev *dev)\n{\n\tu32 addr = is_mt7921(&dev->mt76) ? 0x18000140 : 0x7c000140;\n\n\tmt76_clear(dev, addr, WFSYS_SW_RST_B);\n\tmsleep(50);\n\tmt76_set(dev, addr, WFSYS_SW_RST_B);\n\n\tif (!__mt76_poll_msec(&dev->mt76, addr, WFSYS_SW_INIT_DONE,\n\t\t\t      WFSYS_SW_INIT_DONE, 500))\n\t\treturn -ETIMEDOUT;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mt792x_wfsys_reset);\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}