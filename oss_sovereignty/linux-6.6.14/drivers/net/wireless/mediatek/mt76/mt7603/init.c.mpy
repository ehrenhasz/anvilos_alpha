{
  "module_name": "init.c",
  "hash_id": "9399dd630f463e04e44054b73866659e2bc7926eb00d0c106a4eb7bf438ccbd8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/mediatek/mt76/mt7603/init.c",
  "human_readable_source": "\n\n#include <linux/etherdevice.h>\n#include \"mt7603.h\"\n#include \"mac.h\"\n#include \"eeprom.h\"\n\nconst struct mt76_driver_ops mt7603_drv_ops = {\n\t.txwi_size = MT_TXD_SIZE,\n\t.drv_flags = MT_DRV_SW_RX_AIRTIME,\n\t.survey_flags = SURVEY_INFO_TIME_TX,\n\t.tx_prepare_skb = mt7603_tx_prepare_skb,\n\t.tx_complete_skb = mt7603_tx_complete_skb,\n\t.rx_skb = mt7603_queue_rx_skb,\n\t.rx_poll_complete = mt7603_rx_poll_complete,\n\t.sta_ps = mt7603_sta_ps,\n\t.sta_add = mt7603_sta_add,\n\t.sta_assoc = mt7603_sta_assoc,\n\t.sta_remove = mt7603_sta_remove,\n\t.update_survey = mt7603_update_channel,\n};\n\nstatic void\nmt7603_set_tmac_template(struct mt7603_dev *dev)\n{\n\tu32 desc[5] = {\n\t\t[1] = FIELD_PREP(MT_TXD3_REM_TX_COUNT, 0xf),\n\t\t[3] = MT_TXD5_SW_POWER_MGMT\n\t};\n\tu32 addr;\n\tint i;\n\n\taddr = mt7603_reg_map(dev, MT_CLIENT_BASE_PHYS_ADDR);\n\taddr += MT_CLIENT_TMAC_INFO_TEMPLATE;\n\tfor (i = 0; i < ARRAY_SIZE(desc); i++)\n\t\tmt76_wr(dev, addr + 4 * i, desc[i]);\n}\n\nstatic void\nmt7603_dma_sched_init(struct mt7603_dev *dev)\n{\n\tint page_size = 128;\n\tint page_count;\n\tint max_len = 1792;\n\tint max_amsdu_pages = 4096 / page_size;\n\tint max_mcu_len = 4096;\n\tint max_beacon_len = 512 * 4 + max_len;\n\tint max_mcast_pages = 4 * max_len / page_size;\n\tint reserved_count = 0;\n\tint beacon_pages;\n\tint mcu_pages;\n\tint i;\n\n\tpage_count = mt76_get_field(dev, MT_PSE_FC_P0,\n\t\t\t\t    MT_PSE_FC_P0_MAX_QUOTA);\n\tbeacon_pages = 4 * (max_beacon_len / page_size);\n\tmcu_pages = max_mcu_len / page_size;\n\n\tmt76_wr(dev, MT_PSE_FRP,\n\t\tFIELD_PREP(MT_PSE_FRP_P0, 7) |\n\t\tFIELD_PREP(MT_PSE_FRP_P1, 6) |\n\t\tFIELD_PREP(MT_PSE_FRP_P2_RQ2, 4));\n\n\tmt76_wr(dev, MT_HIGH_PRIORITY_1, 0x55555553);\n\tmt76_wr(dev, MT_HIGH_PRIORITY_2, 0x78555555);\n\n\tmt76_wr(dev, MT_QUEUE_PRIORITY_1, 0x2b1a096e);\n\tmt76_wr(dev, MT_QUEUE_PRIORITY_2, 0x785f4d3c);\n\n\tmt76_wr(dev, MT_PRIORITY_MASK, 0xffffffff);\n\n\tmt76_wr(dev, MT_SCH_1, page_count | (2 << 28));\n\tmt76_wr(dev, MT_SCH_2, max_amsdu_pages);\n\n\tfor (i = 0; i <= 4; i++)\n\t\tmt76_wr(dev, MT_PAGE_COUNT(i), max_amsdu_pages);\n\treserved_count += 5 * max_amsdu_pages;\n\n\tmt76_wr(dev, MT_PAGE_COUNT(5), mcu_pages);\n\treserved_count += mcu_pages;\n\n\tmt76_wr(dev, MT_PAGE_COUNT(7), beacon_pages);\n\treserved_count += beacon_pages;\n\n\tmt76_wr(dev, MT_PAGE_COUNT(8), max_mcast_pages);\n\treserved_count += max_mcast_pages;\n\n\tif (is_mt7603(dev))\n\t\treserved_count = 0;\n\n\tmt76_wr(dev, MT_RSV_MAX_THRESH, page_count - reserved_count);\n\n\tif (is_mt7603(dev) && mt76xx_rev(dev) >= MT7603_REV_E2) {\n\t\tmt76_wr(dev, MT_GROUP_THRESH(0),\n\t\t\tpage_count - beacon_pages - mcu_pages);\n\t\tmt76_wr(dev, MT_GROUP_THRESH(1), beacon_pages);\n\t\tmt76_wr(dev, MT_BMAP_0, 0x0080ff5f);\n\t\tmt76_wr(dev, MT_GROUP_THRESH(2), mcu_pages);\n\t\tmt76_wr(dev, MT_BMAP_1, 0x00000020);\n\t} else {\n\t\tmt76_wr(dev, MT_GROUP_THRESH(0), page_count);\n\t\tmt76_wr(dev, MT_BMAP_0, 0xffff);\n\t}\n\n\tmt76_wr(dev, MT_SCH_4, 0);\n\n\tfor (i = 0; i <= 15; i++)\n\t\tmt76_wr(dev, MT_TXTIME_THRESH(i), 0xfffff);\n\n\tmt76_set(dev, MT_SCH_4, BIT(6));\n}\n\nstatic void\nmt7603_phy_init(struct mt7603_dev *dev)\n{\n\tint rx_chains = dev->mphy.antenna_mask;\n\tint tx_chains = hweight8(rx_chains) - 1;\n\n\tmt76_rmw(dev, MT_WF_RMAC_RMCR,\n\t\t (MT_WF_RMAC_RMCR_SMPS_MODE |\n\t\t  MT_WF_RMAC_RMCR_RX_STREAMS),\n\t\t (FIELD_PREP(MT_WF_RMAC_RMCR_SMPS_MODE, 3) |\n\t\t  FIELD_PREP(MT_WF_RMAC_RMCR_RX_STREAMS, rx_chains)));\n\n\tmt76_rmw_field(dev, MT_TMAC_TCR, MT_TMAC_TCR_TX_STREAMS,\n\t\t       tx_chains);\n\n\tdev->agc0 = mt76_rr(dev, MT_AGC(0));\n\tdev->agc3 = mt76_rr(dev, MT_AGC(3));\n}\n\nstatic void\nmt7603_mac_init(struct mt7603_dev *dev)\n{\n\tu8 bc_addr[ETH_ALEN];\n\tu32 addr;\n\tint i;\n\n\tmt76_wr(dev, MT_AGG_BA_SIZE_LIMIT_0,\n\t\t(MT_AGG_SIZE_LIMIT(0) << 0 * MT_AGG_BA_SIZE_LIMIT_SHIFT) |\n\t\t(MT_AGG_SIZE_LIMIT(1) << 1 * MT_AGG_BA_SIZE_LIMIT_SHIFT) |\n\t\t(MT_AGG_SIZE_LIMIT(2) << 2 * MT_AGG_BA_SIZE_LIMIT_SHIFT) |\n\t\t(MT_AGG_SIZE_LIMIT(3) << 3 * MT_AGG_BA_SIZE_LIMIT_SHIFT));\n\n\tmt76_wr(dev, MT_AGG_BA_SIZE_LIMIT_1,\n\t\t(MT_AGG_SIZE_LIMIT(4) << 0 * MT_AGG_BA_SIZE_LIMIT_SHIFT) |\n\t\t(MT_AGG_SIZE_LIMIT(5) << 1 * MT_AGG_BA_SIZE_LIMIT_SHIFT) |\n\t\t(MT_AGG_SIZE_LIMIT(6) << 2 * MT_AGG_BA_SIZE_LIMIT_SHIFT) |\n\t\t(MT_AGG_SIZE_LIMIT(7) << 3 * MT_AGG_BA_SIZE_LIMIT_SHIFT));\n\n\tmt76_wr(dev, MT_AGG_LIMIT,\n\t\tFIELD_PREP(MT_AGG_LIMIT_AC(0), 24) |\n\t\tFIELD_PREP(MT_AGG_LIMIT_AC(1), 24) |\n\t\tFIELD_PREP(MT_AGG_LIMIT_AC(2), 24) |\n\t\tFIELD_PREP(MT_AGG_LIMIT_AC(3), 24));\n\n\tmt76_wr(dev, MT_AGG_LIMIT_1,\n\t\tFIELD_PREP(MT_AGG_LIMIT_AC(0), 24) |\n\t\tFIELD_PREP(MT_AGG_LIMIT_AC(1), 24) |\n\t\tFIELD_PREP(MT_AGG_LIMIT_AC(2), 24) |\n\t\tFIELD_PREP(MT_AGG_LIMIT_AC(3), 24));\n\n\tmt76_wr(dev, MT_AGG_CONTROL,\n\t\tFIELD_PREP(MT_AGG_CONTROL_BAR_RATE, 0x4b) |\n\t\tFIELD_PREP(MT_AGG_CONTROL_CFEND_RATE, 0x69) |\n\t\tMT_AGG_CONTROL_NO_BA_AR_RULE);\n\n\tmt76_wr(dev, MT_AGG_RETRY_CONTROL,\n\t\tFIELD_PREP(MT_AGG_RETRY_CONTROL_BAR_LIMIT, 1) |\n\t\tFIELD_PREP(MT_AGG_RETRY_CONTROL_RTS_LIMIT, 15));\n\n\tmt76_wr(dev, MT_DMA_DCR0, MT_DMA_DCR0_RX_VEC_DROP |\n\t\tFIELD_PREP(MT_DMA_DCR0_MAX_RX_LEN, 4096));\n\n\tmt76_rmw(dev, MT_DMA_VCFR0, BIT(0), BIT(13));\n\tmt76_rmw(dev, MT_DMA_TMCFR0, BIT(0) | BIT(1), BIT(13));\n\n\tmt76_clear(dev, MT_WF_RMAC_TMR_PA, BIT(31));\n\n\tmt76_set(dev, MT_WF_RMACDR, MT_WF_RMACDR_MAXLEN_20BIT);\n\tmt76_rmw(dev, MT_WF_RMAC_MAXMINLEN, 0xffffff, 0x19000);\n\n\tmt76_wr(dev, MT_WF_RFCR1, 0);\n\n\tmt76_set(dev, MT_TMAC_TCR, MT_TMAC_TCR_RX_RIFS_MODE);\n\n\tmt7603_set_tmac_template(dev);\n\n\t \n\taddr = mt7603_reg_map(dev, MT_CLIENT_BASE_PHYS_ADDR);\n\tmt76_set(dev, addr + MT_CLIENT_RXINF, MT_CLIENT_RXINF_RXSH_GROUPS);\n\n\t \n\tmt76_set(dev, MT_DMA_DCR1, GENMASK(13, 11));\n\n\tmt76_rmw_field(dev, MT_AGG_PCR_RTS, MT_AGG_PCR_RTS_PKT_THR, 3);\n\tmt76_set(dev, MT_TMAC_PCR, MT_TMAC_PCR_SPE_EN);\n\n\t \n\tmt76_rmw_field(dev, MT_TXREQ, MT_TXREQ_CCA_SRC_SEL, 2);\n\n\tmt76_wr(dev, MT_RXREQ, 4);\n\n\t \n\tmt76_wr(dev, MT_DMA_RCFR0, 0xc0000000);\n\n\t \n\tmt76_wr(dev, MT_DMA_TCFR0,\n\t\tFIELD_PREP(MT_DMA_TCFR_TXS_AGGR_TIMEOUT, 1) |  \n\t\tMT_DMA_TCFR_TXS_AGGR_COUNT);\n\n\t \n\tmt76_wr(dev, MT_DMA_TCFR1,\n\t\tFIELD_PREP(MT_DMA_TCFR_TXS_AGGR_TIMEOUT, 1) |  \n\t\tMT_DMA_TCFR_TXS_AGGR_COUNT |  \n\t\tMT_DMA_TCFR_TXS_BIT_MAP);\n\n\tmt76_wr(dev, MT_MCU_PCIE_REMAP_1, MT_PSE_WTBL_2_PHYS_ADDR);\n\n\tfor (i = 0; i < MT7603_WTBL_SIZE; i++)\n\t\tmt7603_wtbl_clear(dev, i);\n\n\teth_broadcast_addr(bc_addr);\n\tmt7603_wtbl_init(dev, MT7603_WTBL_RESERVED, -1, bc_addr);\n\tdev->global_sta.wcid.idx = MT7603_WTBL_RESERVED;\n\trcu_assign_pointer(dev->mt76.wcid[MT7603_WTBL_RESERVED],\n\t\t\t   &dev->global_sta.wcid);\n\n\tmt76_rmw_field(dev, MT_LPON_BTEIR, MT_LPON_BTEIR_MBSS_MODE, 2);\n\tmt76_rmw_field(dev, MT_WF_RMACDR, MT_WF_RMACDR_MBSSID_MASK, 2);\n\n\tmt76_wr(dev, MT_AGG_ARUCR,\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(0), 7) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(1), 2) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(2), 2) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(3), 2) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(4), 1) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(5), 1) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(6), 1) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(7), 1));\n\n\tmt76_wr(dev, MT_AGG_ARDCR,\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(0), MT7603_RATE_RETRY - 1) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(1), MT7603_RATE_RETRY - 1) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(2), MT7603_RATE_RETRY - 1) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(3), MT7603_RATE_RETRY - 1) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(4), MT7603_RATE_RETRY - 1) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(5), MT7603_RATE_RETRY - 1) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(6), MT7603_RATE_RETRY - 1) |\n\t\tFIELD_PREP(MT_AGG_ARxCR_LIMIT(7), MT7603_RATE_RETRY - 1));\n\n\tmt76_wr(dev, MT_AGG_ARCR,\n\t\t(FIELD_PREP(MT_AGG_ARCR_RTS_RATE_THR, 2) |\n\t\t MT_AGG_ARCR_RATE_DOWN_RATIO_EN |\n\t\t FIELD_PREP(MT_AGG_ARCR_RATE_DOWN_RATIO, 1) |\n\t\t FIELD_PREP(MT_AGG_ARCR_RATE_UP_EXTRA_TH, 4)));\n\n\tmt76_set(dev, MT_WTBL_RMVTCR, MT_WTBL_RMVTCR_RX_MV_MODE);\n\n\tmt76_clear(dev, MT_SEC_SCR, MT_SEC_SCR_MASK_ORDER);\n\tmt76_clear(dev, MT_SEC_SCR, BIT(18));\n\n\t \n\tfor (i = 0; i <= 4; i++)\n\t\tmt76_rmw_field(dev, MT_LPON_SBTOR(i), MT_LPON_SBTOR_TIME_OFFSET,\n\t\t\t       (i + 1) * (20 + 4096));\n}\n\nstatic int\nmt7603_init_hardware(struct mt7603_dev *dev)\n{\n\tint i, ret;\n\n\tmt76_wr(dev, MT_INT_SOURCE_CSR, ~0);\n\n\tret = mt7603_eeprom_init(dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = mt7603_dma_init(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tmt76_wr(dev, MT_WPDMA_GLO_CFG, 0x52000850);\n\tmt7603_mac_dma_start(dev);\n\tdev->rxfilter = mt76_rr(dev, MT_WF_RFCR);\n\tset_bit(MT76_STATE_INITIALIZED, &dev->mphy.state);\n\n\tfor (i = 0; i < MT7603_WTBL_SIZE; i++) {\n\t\tmt76_wr(dev, MT_PSE_RTA, MT_PSE_RTA_BUSY | MT_PSE_RTA_WRITE |\n\t\t\tFIELD_PREP(MT_PSE_RTA_TAG_ID, i));\n\t\tmt76_poll(dev, MT_PSE_RTA, MT_PSE_RTA_BUSY, 0, 5000);\n\t}\n\n\tret = mt7603_mcu_init(dev);\n\tif (ret)\n\t\treturn ret;\n\n\tmt7603_dma_sched_init(dev);\n\tmt7603_mcu_set_eeprom(dev);\n\tmt7603_phy_init(dev);\n\tmt7603_mac_init(dev);\n\n\treturn 0;\n}\n\nstatic const struct ieee80211_iface_limit if_limits[] = {\n\t{\n\t\t.max = 1,\n\t\t.types = BIT(NL80211_IFTYPE_ADHOC)\n\t}, {\n\t\t.max = MT7603_MAX_INTERFACES,\n\t\t.types = BIT(NL80211_IFTYPE_STATION) |\n#ifdef CONFIG_MAC80211_MESH\n\t\t\t BIT(NL80211_IFTYPE_MESH_POINT) |\n#endif\n\t\t\t BIT(NL80211_IFTYPE_P2P_CLIENT) |\n\t\t\t BIT(NL80211_IFTYPE_P2P_GO) |\n\t\t\t BIT(NL80211_IFTYPE_AP)\n\t },\n};\n\nstatic const struct ieee80211_iface_combination if_comb[] = {\n\t{\n\t\t.limits = if_limits,\n\t\t.n_limits = ARRAY_SIZE(if_limits),\n\t\t.max_interfaces = 4,\n\t\t.num_different_channels = 1,\n\t\t.beacon_int_infra_match = true,\n\t}\n};\n\nstatic void mt7603_led_set_config(struct mt76_phy *mphy, u8 delay_on,\n\t\t\t\t  u8 delay_off)\n{\n\tstruct mt7603_dev *dev = container_of(mphy->dev, struct mt7603_dev,\n\t\t\t\t\t      mt76);\n\tu32 val, addr;\n\n\tval = FIELD_PREP(MT_LED_STATUS_DURATION, 0xffff) |\n\t      FIELD_PREP(MT_LED_STATUS_OFF, delay_off) |\n\t      FIELD_PREP(MT_LED_STATUS_ON, delay_on);\n\n\taddr = mt7603_reg_map(dev, MT_LED_STATUS_0(mphy->leds.pin));\n\tmt76_wr(dev, addr, val);\n\taddr = mt7603_reg_map(dev, MT_LED_STATUS_1(mphy->leds.pin));\n\tmt76_wr(dev, addr, val);\n\n\tval = MT_LED_CTRL_REPLAY(mphy->leds.pin) |\n\t      MT_LED_CTRL_KICK(mphy->leds.pin);\n\tif (mphy->leds.al)\n\t\tval |= MT_LED_CTRL_POLARITY(mphy->leds.pin);\n\taddr = mt7603_reg_map(dev, MT_LED_CTRL);\n\tmt76_wr(dev, addr, val);\n}\n\nstatic int mt7603_led_set_blink(struct led_classdev *led_cdev,\n\t\t\t\tunsigned long *delay_on,\n\t\t\t\tunsigned long *delay_off)\n{\n\tstruct mt76_phy *mphy = container_of(led_cdev, struct mt76_phy,\n\t\t\t\t\t     leds.cdev);\n\tu8 delta_on, delta_off;\n\n\tdelta_off = max_t(u8, *delay_off / 10, 1);\n\tdelta_on = max_t(u8, *delay_on / 10, 1);\n\n\tmt7603_led_set_config(mphy, delta_on, delta_off);\n\treturn 0;\n}\n\nstatic void mt7603_led_set_brightness(struct led_classdev *led_cdev,\n\t\t\t\t      enum led_brightness brightness)\n{\n\tstruct mt76_phy *mphy = container_of(led_cdev, struct mt76_phy,\n\t\t\t\t\t     leds.cdev);\n\n\tif (!brightness)\n\t\tmt7603_led_set_config(mphy, 0, 0xff);\n\telse\n\t\tmt7603_led_set_config(mphy, 0xff, 0);\n}\n\nstatic u32 __mt7603_reg_addr(struct mt7603_dev *dev, u32 addr)\n{\n\tif (addr < 0x100000)\n\t\treturn addr;\n\n\treturn mt7603_reg_map(dev, addr);\n}\n\nstatic u32 mt7603_rr(struct mt76_dev *mdev, u32 offset)\n{\n\tstruct mt7603_dev *dev = container_of(mdev, struct mt7603_dev, mt76);\n\tu32 addr = __mt7603_reg_addr(dev, offset);\n\n\treturn dev->bus_ops->rr(mdev, addr);\n}\n\nstatic void mt7603_wr(struct mt76_dev *mdev, u32 offset, u32 val)\n{\n\tstruct mt7603_dev *dev = container_of(mdev, struct mt7603_dev, mt76);\n\tu32 addr = __mt7603_reg_addr(dev, offset);\n\n\tdev->bus_ops->wr(mdev, addr, val);\n}\n\nstatic u32 mt7603_rmw(struct mt76_dev *mdev, u32 offset, u32 mask, u32 val)\n{\n\tstruct mt7603_dev *dev = container_of(mdev, struct mt7603_dev, mt76);\n\tu32 addr = __mt7603_reg_addr(dev, offset);\n\n\treturn dev->bus_ops->rmw(mdev, addr, mask, val);\n}\n\nstatic void\nmt7603_regd_notifier(struct wiphy *wiphy,\n\t\t     struct regulatory_request *request)\n{\n\tstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\n\tstruct mt7603_dev *dev = hw->priv;\n\n\tdev->mt76.region = request->dfs_region;\n\tdev->ed_monitor = dev->ed_monitor_enabled &&\n\t\t\t  dev->mt76.region == NL80211_DFS_ETSI;\n}\n\nstatic int\nmt7603_txpower_signed(int val)\n{\n\tbool sign = val & BIT(6);\n\n\tif (!(val & BIT(7)))\n\t\treturn 0;\n\n\tval &= GENMASK(5, 0);\n\tif (!sign)\n\t\tval = -val;\n\n\treturn val;\n}\n\nstatic void\nmt7603_init_txpower(struct mt7603_dev *dev,\n\t\t    struct ieee80211_supported_band *sband)\n{\n\tstruct ieee80211_channel *chan;\n\tu8 *eeprom = (u8 *)dev->mt76.eeprom.data;\n\tint target_power = eeprom[MT_EE_TX_POWER_0_START_2G + 2] & ~BIT(7);\n\tu8 *rate_power = &eeprom[MT_EE_TX_POWER_CCK];\n\tbool ext_pa = eeprom[MT_EE_NIC_CONF_0 + 1] & BIT(1);\n\tint max_offset, cur_offset;\n\tint i;\n\n\tif (ext_pa && is_mt7603(dev))\n\t\ttarget_power = eeprom[MT_EE_TX_POWER_TSSI_OFF] & ~BIT(7);\n\n\tif (target_power & BIT(6))\n\t\ttarget_power = -(target_power & GENMASK(5, 0));\n\n\tmax_offset = 0;\n\tfor (i = 0; i < 14; i++) {\n\t\tcur_offset = mt7603_txpower_signed(rate_power[i]);\n\t\tmax_offset = max(max_offset, cur_offset);\n\t}\n\n\ttarget_power += max_offset;\n\n\tdev->tx_power_limit = target_power;\n\tdev->mphy.txpower_cur = target_power;\n\n\ttarget_power = DIV_ROUND_UP(target_power, 2);\n\n\t \n\tif (dev->mphy.antenna_mask & BIT(1))\n\t\ttarget_power += 3;\n\n\tfor (i = 0; i < sband->n_channels; i++) {\n\t\tchan = &sband->channels[i];\n\t\tchan->max_power = min_t(int, chan->max_reg_power, target_power);\n\t\tchan->orig_mpwr = target_power;\n\t}\n}\n\nint mt7603_register_device(struct mt7603_dev *dev)\n{\n\tstruct mt76_bus_ops *bus_ops;\n\tstruct ieee80211_hw *hw = mt76_hw(dev);\n\tstruct wiphy *wiphy = hw->wiphy;\n\tint ret;\n\n\tdev->bus_ops = dev->mt76.bus;\n\tbus_ops = devm_kmemdup(dev->mt76.dev, dev->bus_ops, sizeof(*bus_ops),\n\t\t\t       GFP_KERNEL);\n\tif (!bus_ops)\n\t\treturn -ENOMEM;\n\n\tbus_ops->rr = mt7603_rr;\n\tbus_ops->wr = mt7603_wr;\n\tbus_ops->rmw = mt7603_rmw;\n\tdev->mt76.bus = bus_ops;\n\n\tspin_lock_init(&dev->ps_lock);\n\n\tINIT_DELAYED_WORK(&dev->mphy.mac_work, mt7603_mac_work);\n\ttasklet_setup(&dev->mt76.pre_tbtt_tasklet, mt7603_pre_tbtt_tasklet);\n\n\tdev->slottime = 9;\n\tdev->sensitivity_limit = 28;\n\tdev->dynamic_sensitivity = true;\n\n\tret = mt7603_init_hardware(dev);\n\tif (ret)\n\t\treturn ret;\n\n\thw->queues = 4;\n\thw->max_rates = 3;\n\thw->max_report_rates = 7;\n\thw->max_rate_tries = 11;\n\n\thw->radiotap_timestamp.units_pos =\n\t\tIEEE80211_RADIOTAP_TIMESTAMP_UNIT_US;\n\n\thw->sta_data_size = sizeof(struct mt7603_sta);\n\thw->vif_data_size = sizeof(struct mt7603_vif);\n\n\twiphy->iface_combinations = if_comb;\n\twiphy->n_iface_combinations = ARRAY_SIZE(if_comb);\n\n\tieee80211_hw_set(hw, TX_STATUS_NO_AMPDU_LEN);\n\tieee80211_hw_set(hw, HOST_BROADCAST_PS_BUFFERING);\n\tieee80211_hw_set(hw, NEEDS_UNIQUE_STA_ADDR);\n\n\t \n\tif (IS_ENABLED(CONFIG_MT76_LEDS)) {\n\t\tdev->mphy.leds.cdev.brightness_set = mt7603_led_set_brightness;\n\t\tdev->mphy.leds.cdev.blink_set = mt7603_led_set_blink;\n\t}\n\n\twiphy->reg_notifier = mt7603_regd_notifier;\n\n\tret = mt76_register_device(&dev->mt76, true, mt76_rates,\n\t\t\t\t   ARRAY_SIZE(mt76_rates));\n\tif (ret)\n\t\treturn ret;\n\n\tmt7603_init_debugfs(dev);\n\tmt7603_init_txpower(dev, &dev->mphy.sband_2g.sband);\n\n\treturn 0;\n}\n\nvoid mt7603_unregister_device(struct mt7603_dev *dev)\n{\n\ttasklet_disable(&dev->mt76.pre_tbtt_tasklet);\n\tmt76_unregister_device(&dev->mt76);\n\tmt7603_mcu_exit(dev);\n\tmt7603_dma_cleanup(dev);\n\tmt76_free_device(&dev->mt76);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}