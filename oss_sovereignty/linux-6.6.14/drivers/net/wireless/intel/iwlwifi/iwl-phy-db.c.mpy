{
  "module_name": "iwl-phy-db.c",
  "hash_id": "ea7fc5a3cfc835f5d793c30615ac7575a61aa7150f7fe0745c108c9f6998c9b0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/intel/iwlwifi/iwl-phy-db.c",
  "human_readable_source": "\n \n#include <linux/slab.h>\n#include <linux/string.h>\n#include <linux/export.h>\n\n#include \"iwl-drv.h\"\n#include \"iwl-phy-db.h\"\n#include \"iwl-debug.h\"\n#include \"iwl-op-mode.h\"\n#include \"iwl-trans.h\"\n\nstruct iwl_phy_db_entry {\n\tu16\tsize;\n\tu8\t*data;\n};\n\n \nstruct iwl_phy_db {\n\tstruct iwl_phy_db_entry\tcfg;\n\tstruct iwl_phy_db_entry\tcalib_nch;\n\tint n_group_papd;\n\tstruct iwl_phy_db_entry\t*calib_ch_group_papd;\n\tint n_group_txp;\n\tstruct iwl_phy_db_entry\t*calib_ch_group_txp;\n\n\tstruct iwl_trans *trans;\n};\n\nenum iwl_phy_db_section_type {\n\tIWL_PHY_DB_CFG = 1,\n\tIWL_PHY_DB_CALIB_NCH,\n\tIWL_PHY_DB_UNUSED,\n\tIWL_PHY_DB_CALIB_CHG_PAPD,\n\tIWL_PHY_DB_CALIB_CHG_TXP,\n\tIWL_PHY_DB_MAX\n};\n\n#define PHY_DB_CMD 0x6c\n\n \nstruct iwl_phy_db_chg_txp {\n\t__le32 space;\n\t__le16 max_channel_idx;\n} __packed;\n\nstruct iwl_phy_db *iwl_phy_db_init(struct iwl_trans *trans)\n{\n\tstruct iwl_phy_db *phy_db = kzalloc(sizeof(struct iwl_phy_db),\n\t\t\t\t\t    GFP_KERNEL);\n\n\tif (!phy_db)\n\t\treturn phy_db;\n\n\tphy_db->trans = trans;\n\n\tphy_db->n_group_txp = -1;\n\tphy_db->n_group_papd = -1;\n\n\t \n\treturn phy_db;\n}\nIWL_EXPORT_SYMBOL(iwl_phy_db_init);\n\n \nstatic struct iwl_phy_db_entry *\niwl_phy_db_get_section(struct iwl_phy_db *phy_db,\n\t\t       enum iwl_phy_db_section_type type,\n\t\t       u16 chg_id)\n{\n\tif (!phy_db || type >= IWL_PHY_DB_MAX)\n\t\treturn NULL;\n\n\tswitch (type) {\n\tcase IWL_PHY_DB_CFG:\n\t\treturn &phy_db->cfg;\n\tcase IWL_PHY_DB_CALIB_NCH:\n\t\treturn &phy_db->calib_nch;\n\tcase IWL_PHY_DB_CALIB_CHG_PAPD:\n\t\tif (chg_id >= phy_db->n_group_papd)\n\t\t\treturn NULL;\n\t\treturn &phy_db->calib_ch_group_papd[chg_id];\n\tcase IWL_PHY_DB_CALIB_CHG_TXP:\n\t\tif (chg_id >= phy_db->n_group_txp)\n\t\t\treturn NULL;\n\t\treturn &phy_db->calib_ch_group_txp[chg_id];\n\tdefault:\n\t\treturn NULL;\n\t}\n\treturn NULL;\n}\n\nstatic void iwl_phy_db_free_section(struct iwl_phy_db *phy_db,\n\t\t\t\t    enum iwl_phy_db_section_type type,\n\t\t\t\t    u16 chg_id)\n{\n\tstruct iwl_phy_db_entry *entry =\n\t\t\t\tiwl_phy_db_get_section(phy_db, type, chg_id);\n\tif (!entry)\n\t\treturn;\n\n\tkfree(entry->data);\n\tentry->data = NULL;\n\tentry->size = 0;\n}\n\nvoid iwl_phy_db_free(struct iwl_phy_db *phy_db)\n{\n\tint i;\n\n\tif (!phy_db)\n\t\treturn;\n\n\tiwl_phy_db_free_section(phy_db, IWL_PHY_DB_CFG, 0);\n\tiwl_phy_db_free_section(phy_db, IWL_PHY_DB_CALIB_NCH, 0);\n\n\tfor (i = 0; i < phy_db->n_group_papd; i++)\n\t\tiwl_phy_db_free_section(phy_db, IWL_PHY_DB_CALIB_CHG_PAPD, i);\n\tkfree(phy_db->calib_ch_group_papd);\n\n\tfor (i = 0; i < phy_db->n_group_txp; i++)\n\t\tiwl_phy_db_free_section(phy_db, IWL_PHY_DB_CALIB_CHG_TXP, i);\n\tkfree(phy_db->calib_ch_group_txp);\n\n\tkfree(phy_db);\n}\nIWL_EXPORT_SYMBOL(iwl_phy_db_free);\n\nint iwl_phy_db_set_section(struct iwl_phy_db *phy_db,\n\t\t\t   struct iwl_rx_packet *pkt)\n{\n\tunsigned int pkt_len = iwl_rx_packet_payload_len(pkt);\n\tstruct iwl_calib_res_notif_phy_db *phy_db_notif =\n\t\t\t(struct iwl_calib_res_notif_phy_db *)pkt->data;\n\tenum iwl_phy_db_section_type type;\n\tu16 size;\n\tstruct iwl_phy_db_entry *entry;\n\tu16 chg_id = 0;\n\n\tif (pkt_len < sizeof(*phy_db_notif))\n\t\treturn -EINVAL;\n\n\ttype = le16_to_cpu(phy_db_notif->type);\n\tsize = le16_to_cpu(phy_db_notif->length);\n\n\tif (pkt_len < sizeof(*phy_db_notif) + size)\n\t\treturn -EINVAL;\n\n\tif (!phy_db)\n\t\treturn -EINVAL;\n\n\tif (type == IWL_PHY_DB_CALIB_CHG_PAPD) {\n\t\tchg_id = le16_to_cpup((__le16 *)phy_db_notif->data);\n\t\tif (phy_db && !phy_db->calib_ch_group_papd) {\n\t\t\t \n\t\t\tphy_db->calib_ch_group_papd = kcalloc(chg_id + 1,\n\t\t\t\t\t\t\t      sizeof(struct iwl_phy_db_entry),\n\t\t\t\t\t\t\t      GFP_ATOMIC);\n\t\t\tif (!phy_db->calib_ch_group_papd)\n\t\t\t\treturn -ENOMEM;\n\t\t\tphy_db->n_group_papd = chg_id + 1;\n\t\t}\n\t} else if (type == IWL_PHY_DB_CALIB_CHG_TXP) {\n\t\tchg_id = le16_to_cpup((__le16 *)phy_db_notif->data);\n\t\tif (phy_db && !phy_db->calib_ch_group_txp) {\n\t\t\t \n\t\t\tphy_db->calib_ch_group_txp = kcalloc(chg_id + 1,\n\t\t\t\t\t\t\t     sizeof(struct iwl_phy_db_entry),\n\t\t\t\t\t\t\t     GFP_ATOMIC);\n\t\t\tif (!phy_db->calib_ch_group_txp)\n\t\t\t\treturn -ENOMEM;\n\t\t\tphy_db->n_group_txp = chg_id + 1;\n\t\t}\n\t}\n\n\tentry = iwl_phy_db_get_section(phy_db, type, chg_id);\n\tif (!entry)\n\t\treturn -EINVAL;\n\n\tkfree(entry->data);\n\tentry->data = kmemdup(phy_db_notif->data, size, GFP_ATOMIC);\n\tif (!entry->data) {\n\t\tentry->size = 0;\n\t\treturn -ENOMEM;\n\t}\n\n\tentry->size = size;\n\n\tIWL_DEBUG_INFO(phy_db->trans,\n\t\t       \"%s(%d): [PHYDB]SET: Type %d , Size: %d\\n\",\n\t\t       __func__, __LINE__, type, size);\n\n\treturn 0;\n}\nIWL_EXPORT_SYMBOL(iwl_phy_db_set_section);\n\nstatic int is_valid_channel(u16 ch_id)\n{\n\tif (ch_id <= 14 ||\n\t    (36 <= ch_id && ch_id <= 64 && ch_id % 4 == 0) ||\n\t    (100 <= ch_id && ch_id <= 140 && ch_id % 4 == 0) ||\n\t    (145 <= ch_id && ch_id <= 165 && ch_id % 4 == 1))\n\t\treturn 1;\n\treturn 0;\n}\n\nstatic u8 ch_id_to_ch_index(u16 ch_id)\n{\n\tif (WARN_ON(!is_valid_channel(ch_id)))\n\t\treturn 0xff;\n\n\tif (ch_id <= 14)\n\t\treturn ch_id - 1;\n\tif (ch_id <= 64)\n\t\treturn (ch_id + 20) / 4;\n\tif (ch_id <= 140)\n\t\treturn (ch_id - 12) / 4;\n\treturn (ch_id - 13) / 4;\n}\n\n\nstatic u16 channel_id_to_papd(u16 ch_id)\n{\n\tif (WARN_ON(!is_valid_channel(ch_id)))\n\t\treturn 0xff;\n\n\tif (1 <= ch_id && ch_id <= 14)\n\t\treturn 0;\n\tif (36 <= ch_id && ch_id <= 64)\n\t\treturn 1;\n\tif (100 <= ch_id && ch_id <= 140)\n\t\treturn 2;\n\treturn 3;\n}\n\nstatic u16 channel_id_to_txp(struct iwl_phy_db *phy_db, u16 ch_id)\n{\n\tstruct iwl_phy_db_chg_txp *txp_chg;\n\tint i;\n\tu8 ch_index = ch_id_to_ch_index(ch_id);\n\tif (ch_index == 0xff)\n\t\treturn 0xff;\n\n\tfor (i = 0; i < phy_db->n_group_txp; i++) {\n\t\ttxp_chg = (void *)phy_db->calib_ch_group_txp[i].data;\n\t\tif (!txp_chg)\n\t\t\treturn 0xff;\n\t\t \n\t\tif (le16_to_cpu(txp_chg->max_channel_idx) >= ch_index)\n\t\t\treturn i;\n\t}\n\treturn 0xff;\n}\nstatic\nint iwl_phy_db_get_section_data(struct iwl_phy_db *phy_db,\n\t\t\t\tu32 type, u8 **data, u16 *size, u16 ch_id)\n{\n\tstruct iwl_phy_db_entry *entry;\n\tu16 ch_group_id = 0;\n\n\tif (!phy_db)\n\t\treturn -EINVAL;\n\n\t \n\tif (type == IWL_PHY_DB_CALIB_CHG_PAPD)\n\t\tch_group_id = channel_id_to_papd(ch_id);\n\telse if (type == IWL_PHY_DB_CALIB_CHG_TXP)\n\t\tch_group_id = channel_id_to_txp(phy_db, ch_id);\n\n\tentry = iwl_phy_db_get_section(phy_db, type, ch_group_id);\n\tif (!entry)\n\t\treturn -EINVAL;\n\n\t*data = entry->data;\n\t*size = entry->size;\n\n\tIWL_DEBUG_INFO(phy_db->trans,\n\t\t       \"%s(%d): [PHYDB] GET: Type %d , Size: %d\\n\",\n\t\t       __func__, __LINE__, type, *size);\n\n\treturn 0;\n}\n\nstatic int iwl_send_phy_db_cmd(struct iwl_phy_db *phy_db, u16 type,\n\t\t\t       u16 length, void *data)\n{\n\tstruct iwl_phy_db_cmd phy_db_cmd;\n\tstruct iwl_host_cmd cmd = {\n\t\t.id = PHY_DB_CMD,\n\t};\n\n\tIWL_DEBUG_INFO(phy_db->trans,\n\t\t       \"Sending PHY-DB hcmd of type %d, of length %d\\n\",\n\t\t       type, length);\n\n\t \n\tphy_db_cmd.type = cpu_to_le16(type);\n\tphy_db_cmd.length = cpu_to_le16(length);\n\n\t \n\tcmd.data[0] = &phy_db_cmd;\n\tcmd.len[0] = sizeof(struct iwl_phy_db_cmd);\n\tcmd.data[1] = data;\n\tcmd.len[1] = length;\n\tcmd.dataflags[1] = IWL_HCMD_DFL_NOCOPY;\n\n\treturn iwl_trans_send_cmd(phy_db->trans, &cmd);\n}\n\nstatic int iwl_phy_db_send_all_channel_groups(\n\t\t\t\t\tstruct iwl_phy_db *phy_db,\n\t\t\t\t\tenum iwl_phy_db_section_type type,\n\t\t\t\t\tu8 max_ch_groups)\n{\n\tu16 i;\n\tint err;\n\tstruct iwl_phy_db_entry *entry;\n\n\t \n\tfor (i = 0; i < max_ch_groups; i++) {\n\t\tentry = iwl_phy_db_get_section(phy_db,\n\t\t\t\t\t       type,\n\t\t\t\t\t       i);\n\t\tif (!entry)\n\t\t\treturn -EINVAL;\n\n\t\tif (!entry->size)\n\t\t\tcontinue;\n\n\t\t \n\t\terr = iwl_send_phy_db_cmd(phy_db,\n\t\t\t\t\t  type,\n\t\t\t\t\t  entry->size,\n\t\t\t\t\t  entry->data);\n\t\tif (err) {\n\t\t\tIWL_ERR(phy_db->trans,\n\t\t\t\t\"Can't SEND phy_db section %d (%d), err %d\\n\",\n\t\t\t\ttype, i, err);\n\t\t\treturn err;\n\t\t}\n\n\t\tIWL_DEBUG_INFO(phy_db->trans,\n\t\t\t       \"Sent PHY_DB HCMD, type = %d num = %d\\n\",\n\t\t\t       type, i);\n\t}\n\n\treturn 0;\n}\n\nint iwl_send_phy_db_data(struct iwl_phy_db *phy_db)\n{\n\tu8 *data = NULL;\n\tu16 size = 0;\n\tint err;\n\n\tIWL_DEBUG_INFO(phy_db->trans,\n\t\t       \"Sending phy db data and configuration to runtime image\\n\");\n\n\t \n\terr = iwl_phy_db_get_section_data(phy_db, IWL_PHY_DB_CFG,\n\t\t\t\t\t  &data, &size, 0);\n\tif (err) {\n\t\tIWL_ERR(phy_db->trans, \"Cannot get Phy DB cfg section\\n\");\n\t\treturn err;\n\t}\n\n\terr = iwl_send_phy_db_cmd(phy_db, IWL_PHY_DB_CFG, size, data);\n\tif (err) {\n\t\tIWL_ERR(phy_db->trans,\n\t\t\t\"Cannot send HCMD of  Phy DB cfg section\\n\");\n\t\treturn err;\n\t}\n\n\terr = iwl_phy_db_get_section_data(phy_db, IWL_PHY_DB_CALIB_NCH,\n\t\t\t\t\t  &data, &size, 0);\n\tif (err) {\n\t\tIWL_ERR(phy_db->trans,\n\t\t\t\"Cannot get Phy DB non specific channel section\\n\");\n\t\treturn err;\n\t}\n\n\terr = iwl_send_phy_db_cmd(phy_db, IWL_PHY_DB_CALIB_NCH, size, data);\n\tif (err) {\n\t\tIWL_ERR(phy_db->trans,\n\t\t\t\"Cannot send HCMD of Phy DB non specific channel section\\n\");\n\t\treturn err;\n\t}\n\n\t \n\terr = iwl_phy_db_send_all_channel_groups(phy_db,\n\t\t\t\t\t\t IWL_PHY_DB_CALIB_CHG_PAPD,\n\t\t\t\t\t\t phy_db->n_group_papd);\n\tif (err) {\n\t\tIWL_ERR(phy_db->trans,\n\t\t\t\"Cannot send channel specific PAPD groups\\n\");\n\t\treturn err;\n\t}\n\n\t \n\terr = iwl_phy_db_send_all_channel_groups(phy_db,\n\t\t\t\t\t\t IWL_PHY_DB_CALIB_CHG_TXP,\n\t\t\t\t\t\t phy_db->n_group_txp);\n\tif (err) {\n\t\tIWL_ERR(phy_db->trans,\n\t\t\t\"Cannot send channel specific TX power groups\\n\");\n\t\treturn err;\n\t}\n\n\tIWL_DEBUG_INFO(phy_db->trans,\n\t\t       \"Finished sending phy db non channel data\\n\");\n\treturn 0;\n}\nIWL_EXPORT_SYMBOL(iwl_send_phy_db_data);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}