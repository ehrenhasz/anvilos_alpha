{
  "module_name": "smem.c",
  "hash_id": "d9a1fc23b6bae3bb475b6f71026fffd844b23d6a9e516d620244beb9e595621f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/intel/iwlwifi/fw/smem.c",
  "human_readable_source": "\n \n#include \"iwl-drv.h\"\n#include \"runtime.h\"\n#include \"fw/api/commands.h\"\n\nstatic void iwl_parse_shared_mem_22000(struct iwl_fw_runtime *fwrt,\n\t\t\t\t       struct iwl_rx_packet *pkt)\n{\n\tstruct iwl_shared_mem_cfg *mem_cfg = (void *)pkt->data;\n\tint i, lmac;\n\tint lmac_num = le32_to_cpu(mem_cfg->lmac_num);\n\tu8 api_ver = iwl_fw_lookup_notif_ver(fwrt->fw, SYSTEM_GROUP,\n\t\t\t\t\t     SHARED_MEM_CFG_CMD, 0);\n\n\tif (WARN_ON(lmac_num > ARRAY_SIZE(mem_cfg->lmac_smem)))\n\t\treturn;\n\n\tfwrt->smem_cfg.num_lmacs = lmac_num;\n\tfwrt->smem_cfg.num_txfifo_entries =\n\t\tARRAY_SIZE(mem_cfg->lmac_smem[0].txfifo_size);\n\tfwrt->smem_cfg.rxfifo2_size = le32_to_cpu(mem_cfg->rxfifo2_size);\n\n\tif (api_ver >= 4 &&\n\t    !WARN_ON_ONCE(iwl_rx_packet_payload_len(pkt) < sizeof(*mem_cfg))) {\n\t\tfwrt->smem_cfg.rxfifo2_control_size =\n\t\t\tle32_to_cpu(mem_cfg->rxfifo2_control_size);\n\t}\n\n\tfor (lmac = 0; lmac < lmac_num; lmac++) {\n\t\tstruct iwl_shared_mem_lmac_cfg *lmac_cfg =\n\t\t\t&mem_cfg->lmac_smem[lmac];\n\n\t\tfor (i = 0; i < ARRAY_SIZE(lmac_cfg->txfifo_size); i++)\n\t\t\tfwrt->smem_cfg.lmac[lmac].txfifo_size[i] =\n\t\t\t\tle32_to_cpu(lmac_cfg->txfifo_size[i]);\n\t\tfwrt->smem_cfg.lmac[lmac].rxfifo1_size =\n\t\t\tle32_to_cpu(lmac_cfg->rxfifo1_size);\n\t}\n}\n\nstatic void iwl_parse_shared_mem(struct iwl_fw_runtime *fwrt,\n\t\t\t\t struct iwl_rx_packet *pkt)\n{\n\tstruct iwl_shared_mem_cfg_v2 *mem_cfg = (void *)pkt->data;\n\tint i;\n\n\tfwrt->smem_cfg.num_lmacs = 1;\n\n\tfwrt->smem_cfg.num_txfifo_entries = ARRAY_SIZE(mem_cfg->txfifo_size);\n\tfor (i = 0; i < ARRAY_SIZE(mem_cfg->txfifo_size); i++)\n\t\tfwrt->smem_cfg.lmac[0].txfifo_size[i] =\n\t\t\tle32_to_cpu(mem_cfg->txfifo_size[i]);\n\n\tfwrt->smem_cfg.lmac[0].rxfifo1_size =\n\t\tle32_to_cpu(mem_cfg->rxfifo_size[0]);\n\tfwrt->smem_cfg.rxfifo2_size = le32_to_cpu(mem_cfg->rxfifo_size[1]);\n\n\t \n\tif (fw_has_capa(&fwrt->fw->ucode_capa,\n\t\t\tIWL_UCODE_TLV_CAPA_EXTEND_SHARED_MEM_CFG)) {\n\t\tBUILD_BUG_ON(sizeof(fwrt->smem_cfg.internal_txfifo_size) !=\n\t\t\t     sizeof(mem_cfg->internal_txfifo_size));\n\n\t\tfwrt->smem_cfg.internal_txfifo_addr =\n\t\t\tle32_to_cpu(mem_cfg->internal_txfifo_addr);\n\n\t\tfor (i = 0;\n\t\t     i < ARRAY_SIZE(fwrt->smem_cfg.internal_txfifo_size);\n\t\t     i++)\n\t\t\tfwrt->smem_cfg.internal_txfifo_size[i] =\n\t\t\t\tle32_to_cpu(mem_cfg->internal_txfifo_size[i]);\n\t}\n}\n\nvoid iwl_get_shared_mem_conf(struct iwl_fw_runtime *fwrt)\n{\n\tstruct iwl_host_cmd cmd = {\n\t\t.flags = CMD_WANT_SKB,\n\t\t.data = { NULL, },\n\t\t.len = { 0, },\n\t};\n\tstruct iwl_rx_packet *pkt;\n\tint ret;\n\n\tif (fw_has_capa(&fwrt->fw->ucode_capa,\n\t\t\tIWL_UCODE_TLV_CAPA_EXTEND_SHARED_MEM_CFG))\n\t\tcmd.id = WIDE_ID(SYSTEM_GROUP, SHARED_MEM_CFG_CMD);\n\telse\n\t\tcmd.id = SHARED_MEM_CFG;\n\n\tret = iwl_trans_send_cmd(fwrt->trans, &cmd);\n\n\tif (ret) {\n\t\tWARN(ret != -ERFKILL,\n\t\t     \"Could not send the SMEM command: %d\\n\", ret);\n\t\treturn;\n\t}\n\n\tpkt = cmd.resp_pkt;\n\tif (fwrt->trans->trans_cfg->device_family >= IWL_DEVICE_FAMILY_22000)\n\t\tiwl_parse_shared_mem_22000(fwrt, pkt);\n\telse\n\t\tiwl_parse_shared_mem(fwrt, pkt);\n\n\tIWL_DEBUG_INFO(fwrt, \"SHARED MEM CFG: got memory offsets/sizes\\n\");\n\n\tiwl_free_resp(&cmd);\n}\nIWL_EXPORT_SYMBOL(iwl_get_shared_mem_conf);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}