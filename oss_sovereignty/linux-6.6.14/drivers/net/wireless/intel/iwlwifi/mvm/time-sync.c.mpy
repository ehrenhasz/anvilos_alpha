{
  "module_name": "time-sync.c",
  "hash_id": "3ae5eea0baf99ae6c58c7fed415d6c5ed49a8575e91bbc1b3db477c92fa5ab23",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/intel/iwlwifi/mvm/time-sync.c",
  "human_readable_source": "\n \n\n#include \"mvm.h\"\n#include \"time-sync.h\"\n#include <linux/ieee80211.h>\n\nvoid iwl_mvm_init_time_sync(struct iwl_time_sync_data *data)\n{\n\tskb_queue_head_init(&data->frame_list);\n}\n\nstatic bool iwl_mvm_is_skb_match(struct sk_buff *skb, u8 *addr, u8 dialog_token)\n{\n\tstruct ieee80211_mgmt *mgmt = (void *)skb->data;\n\tu8 skb_dialog_token;\n\n\tif (ieee80211_is_timing_measurement(skb))\n\t\tskb_dialog_token = mgmt->u.action.u.wnm_timing_msr.dialog_token;\n\telse\n\t\tskb_dialog_token = mgmt->u.action.u.ftm.dialog_token;\n\n\tif ((ether_addr_equal(mgmt->sa, addr) ||\n\t     ether_addr_equal(mgmt->da, addr)) &&\n\t    skb_dialog_token == dialog_token)\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic struct sk_buff *iwl_mvm_time_sync_find_skb(struct iwl_mvm *mvm, u8 *addr,\n\t\t\t\t\t\t  u8 dialog_token)\n{\n\tstruct sk_buff *skb;\n\n\t \n\twhile ((skb = skb_dequeue(&mvm->time_sync.frame_list))) {\n\t\tif (iwl_mvm_is_skb_match(skb, addr, dialog_token))\n\t\t\tbreak;\n\n\t\tkfree_skb(skb);\n\t\tskb = NULL;\n\t}\n\n\treturn skb;\n}\n\nstatic u64 iwl_mvm_get_64_bit(__le32 high, __le32 low)\n{\n\treturn ((u64)le32_to_cpu(high) << 32) | le32_to_cpu(low);\n}\n\nvoid iwl_mvm_time_sync_msmt_event(struct iwl_mvm *mvm,\n\t\t\t\t  struct iwl_rx_cmd_buffer *rxb)\n{\n\tstruct iwl_rx_packet *pkt = rxb_addr(rxb);\n\tstruct iwl_time_msmt_notify *notif = (void *)pkt->data;\n\tstruct ieee80211_rx_status *rx_status;\n\tstruct skb_shared_hwtstamps *shwt;\n\tu64 ts_10ns;\n\tstruct sk_buff *skb =\n\t\tiwl_mvm_time_sync_find_skb(mvm, notif->peer_addr,\n\t\t\t\t\t   le32_to_cpu(notif->dialog_token));\n\tu64 adj_time;\n\n\tif (!skb) {\n\t\tIWL_DEBUG_INFO(mvm, \"Time sync event but no pending skb\\n\");\n\t\treturn;\n\t}\n\n\tts_10ns = iwl_mvm_get_64_bit(notif->t2_hi, notif->t2_lo);\n\tadj_time = iwl_mvm_ptp_get_adj_time(mvm, ts_10ns * 10);\n\tshwt = skb_hwtstamps(skb);\n\tshwt->hwtstamp = ktime_set(0, adj_time);\n\n\tts_10ns = iwl_mvm_get_64_bit(notif->t3_hi, notif->t3_lo);\n\tadj_time = iwl_mvm_ptp_get_adj_time(mvm, ts_10ns * 10);\n\trx_status = IEEE80211_SKB_RXCB(skb);\n\trx_status->ack_tx_hwtstamp = ktime_set(0, adj_time);\n\n\tIWL_DEBUG_INFO(mvm,\n\t\t       \"Time sync: RX event - report frame t2=%llu t3=%llu\\n\",\n\t\t       ktime_to_ns(shwt->hwtstamp),\n\t\t       ktime_to_ns(rx_status->ack_tx_hwtstamp));\n\tieee80211_rx_napi(mvm->hw, NULL, skb, NULL);\n}\n\nvoid iwl_mvm_time_sync_msmt_confirm_event(struct iwl_mvm *mvm,\n\t\t\t\t\t  struct iwl_rx_cmd_buffer *rxb)\n{\n\tstruct iwl_rx_packet *pkt = rxb_addr(rxb);\n\tstruct iwl_time_msmt_cfm_notify *notif = (void *)pkt->data;\n\tstruct ieee80211_tx_status status = {};\n\tstruct skb_shared_hwtstamps *shwt;\n\tu64 ts_10ns, adj_time;\n\n\tstatus.skb =\n\t\tiwl_mvm_time_sync_find_skb(mvm, notif->peer_addr,\n\t\t\t\t\t   le32_to_cpu(notif->dialog_token));\n\n\tif (!status.skb) {\n\t\tIWL_DEBUG_INFO(mvm, \"Time sync confirm but no pending skb\\n\");\n\t\treturn;\n\t}\n\n\tts_10ns = iwl_mvm_get_64_bit(notif->t1_hi, notif->t1_lo);\n\tadj_time = iwl_mvm_ptp_get_adj_time(mvm, ts_10ns * 10);\n\tshwt = skb_hwtstamps(status.skb);\n\tshwt->hwtstamp = ktime_set(0, adj_time);\n\n\tts_10ns = iwl_mvm_get_64_bit(notif->t4_hi, notif->t4_lo);\n\tadj_time = iwl_mvm_ptp_get_adj_time(mvm, ts_10ns * 10);\n\tstatus.info = IEEE80211_SKB_CB(status.skb);\n\tstatus.ack_hwtstamp = ktime_set(0, adj_time);\n\n\tIWL_DEBUG_INFO(mvm,\n\t\t       \"Time sync: TX event - report frame t1=%llu t4=%llu\\n\",\n\t\t       ktime_to_ns(shwt->hwtstamp),\n\t\t       ktime_to_ns(status.ack_hwtstamp));\n\tieee80211_tx_status_ext(mvm->hw, &status);\n}\n\nint iwl_mvm_time_sync_config(struct iwl_mvm *mvm, const u8 *addr, u32 protocols)\n{\n\tstruct iwl_time_sync_cfg_cmd cmd = {};\n\tint err;\n\n\tlockdep_assert_held(&mvm->mutex);\n\n\tif (!fw_has_capa(&mvm->fw->ucode_capa,\n\t\t\t IWL_UCODE_TLV_CAPA_TIME_SYNC_BOTH_FTM_TM))\n\t\treturn -EINVAL;\n\n\t \n\tif (mvm->time_sync.active &&\n\t    !ether_addr_equal(addr, mvm->time_sync.peer_addr)) {\n\t\tIWL_DEBUG_INFO(mvm, \"Time sync: reject config for peer: %pM\\n\",\n\t\t\t       addr);\n\t\treturn -ENOBUFS;\n\t}\n\n\tif (protocols & ~(IWL_TIME_SYNC_PROTOCOL_TM |\n\t\t\t  IWL_TIME_SYNC_PROTOCOL_FTM))\n\t\treturn -EINVAL;\n\n\tcmd.protocols = cpu_to_le32(protocols);\n\n\tether_addr_copy(cmd.peer_addr, addr);\n\n\terr = iwl_mvm_send_cmd_pdu(mvm,\n\t\t\t\t   WIDE_ID(DATA_PATH_GROUP,\n\t\t\t\t\t   WNM_80211V_TIMING_MEASUREMENT_CONFIG_CMD),\n\t\t\t\t   0, sizeof(cmd), &cmd);\n\tif (err) {\n\t\tIWL_ERR(mvm, \"Failed to send time sync cfg cmd: %d\\n\", err);\n\t} else {\n\t\tmvm->time_sync.active = protocols != 0;\n\t\tether_addr_copy(mvm->time_sync.peer_addr, addr);\n\t\tIWL_DEBUG_INFO(mvm, \"Time sync: set peer addr=%pM\\n\", addr);\n\t}\n\n\tif (!mvm->time_sync.active)\n\t\tskb_queue_purge(&mvm->time_sync.frame_list);\n\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}