{
  "module_name": "link.c",
  "hash_id": "4f4f75d32d98a3200c7478b817503b3d248ba8a78b593d280febdc225dc06ed8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/intel/iwlwifi/mvm/link.c",
  "human_readable_source": "\n \n#include \"mvm.h\"\n#include \"time-event.h\"\n\nstatic u32 iwl_mvm_get_free_fw_link_id(struct iwl_mvm *mvm,\n\t\t\t\t       struct iwl_mvm_vif *mvm_vif)\n{\n\tu32 link_id;\n\n\tlockdep_assert_held(&mvm->mutex);\n\n\tlink_id = ffz(mvm->fw_link_ids_map);\n\n\t \n\tif (link_id > IWL_MVM_FW_MAX_LINK_ID)\n\t\treturn IWL_MVM_FW_LINK_ID_INVALID;\n\n\tmvm->fw_link_ids_map |= BIT(link_id);\n\treturn link_id;\n}\n\nstatic void iwl_mvm_release_fw_link_id(struct iwl_mvm *mvm, u32 link_id)\n{\n\tlockdep_assert_held(&mvm->mutex);\n\n\tif (!WARN_ON(link_id > IWL_MVM_FW_MAX_LINK_ID))\n\t\tmvm->fw_link_ids_map &= ~BIT(link_id);\n}\n\nstatic int iwl_mvm_link_cmd_send(struct iwl_mvm *mvm,\n\t\t\t\t struct iwl_link_config_cmd *cmd,\n\t\t\t\t enum iwl_ctxt_action action)\n{\n\tint ret;\n\n\tcmd->action = cpu_to_le32(action);\n\tret = iwl_mvm_send_cmd_pdu(mvm,\n\t\t\t\t   WIDE_ID(MAC_CONF_GROUP, LINK_CONFIG_CMD), 0,\n\t\t\t\t   sizeof(*cmd), cmd);\n\tif (ret)\n\t\tIWL_ERR(mvm, \"Failed to send LINK_CONFIG_CMD (action:%d): %d\\n\",\n\t\t\taction, ret);\n\treturn ret;\n}\n\nint iwl_mvm_add_link(struct iwl_mvm *mvm, struct ieee80211_vif *vif,\n\t\t     struct ieee80211_bss_conf *link_conf)\n{\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tunsigned int link_id = link_conf->link_id;\n\tstruct iwl_mvm_vif_link_info *link_info = mvmvif->link[link_id];\n\tstruct iwl_link_config_cmd cmd = {};\n\n\tif (WARN_ON_ONCE(!link_info))\n\t\treturn -EINVAL;\n\n\tif (link_info->fw_link_id == IWL_MVM_FW_LINK_ID_INVALID) {\n\t\tlink_info->fw_link_id = iwl_mvm_get_free_fw_link_id(mvm,\n\t\t\t\t\t\t\t\t    mvmvif);\n\t\tif (link_info->fw_link_id >= ARRAY_SIZE(mvm->link_id_to_link_conf))\n\t\t\treturn -EINVAL;\n\n\t\trcu_assign_pointer(mvm->link_id_to_link_conf[link_info->fw_link_id],\n\t\t\t\t   link_conf);\n\t}\n\n\t \n\tif (iwl_mvm_sf_update(mvm, vif, false))\n\t\treturn -EINVAL;\n\n\tcmd.link_id = cpu_to_le32(link_info->fw_link_id);\n\tcmd.mac_id = cpu_to_le32(mvmvif->id);\n\tcmd.spec_link_id = link_conf->link_id;\n\tWARN_ON_ONCE(link_info->phy_ctxt);\n\tcmd.phy_id = cpu_to_le32(FW_CTXT_INVALID);\n\n\tmemcpy(cmd.local_link_addr, link_conf->addr, ETH_ALEN);\n\n\tif (vif->type == NL80211_IFTYPE_ADHOC && link_conf->bssid)\n\t\tmemcpy(cmd.ibss_bssid_addr, link_conf->bssid, ETH_ALEN);\n\n\tcmd.listen_lmac = cpu_to_le32(link_info->listen_lmac);\n\n\treturn iwl_mvm_link_cmd_send(mvm, &cmd, FW_CTXT_ACTION_ADD);\n}\n\nint iwl_mvm_link_changed(struct iwl_mvm *mvm, struct ieee80211_vif *vif,\n\t\t\t struct ieee80211_bss_conf *link_conf,\n\t\t\t u32 changes, bool active)\n{\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tunsigned int link_id = link_conf->link_id;\n\tstruct iwl_mvm_vif_link_info *link_info = mvmvif->link[link_id];\n\tstruct iwl_mvm_phy_ctxt *phyctxt;\n\tstruct iwl_link_config_cmd cmd = {};\n\tu32 ht_flag, flags = 0, flags_mask = 0;\n\tint ret;\n\n\tif (WARN_ON_ONCE(!link_info ||\n\t\t\t link_info->fw_link_id == IWL_MVM_FW_LINK_ID_INVALID))\n\t\treturn -EINVAL;\n\n\tif (changes & LINK_CONTEXT_MODIFY_ACTIVE) {\n\t\t \n\t\tif (!link_info->phy_ctxt)\n\t\t\treturn 0;\n\n\t\t \n\t\tWARN_ON_ONCE(active == link_info->active);\n\n\t\t \n\t\tif (!active && vif->type == NL80211_IFTYPE_STATION)\n\t\t\tiwl_mvm_stop_session_protection(mvm, vif);\n\t}\n\n\tcmd.link_id = cpu_to_le32(link_info->fw_link_id);\n\n\t \n\tphyctxt = link_info->phy_ctxt;\n\tif (phyctxt)\n\t\tcmd.phy_id = cpu_to_le32(phyctxt->id);\n\telse\n\t\tcmd.phy_id = cpu_to_le32(FW_CTXT_INVALID);\n\tcmd.mac_id = cpu_to_le32(mvmvif->id);\n\n\tmemcpy(cmd.local_link_addr, link_conf->addr, ETH_ALEN);\n\n\tcmd.active = cpu_to_le32(active);\n\n\tif (vif->type == NL80211_IFTYPE_ADHOC && link_conf->bssid)\n\t\tmemcpy(cmd.ibss_bssid_addr, link_conf->bssid, ETH_ALEN);\n\n\tiwl_mvm_set_fw_basic_rates(mvm, vif, link_conf,\n\t\t\t\t   &cmd.cck_rates, &cmd.ofdm_rates);\n\n\tcmd.cck_short_preamble = cpu_to_le32(link_conf->use_short_preamble);\n\tcmd.short_slot = cpu_to_le32(link_conf->use_short_slot);\n\n\t \n\tht_flag = LINK_PROT_FLG_HT_PROT | LINK_PROT_FLG_FAT_PROT;\n\tiwl_mvm_set_fw_protection_flags(mvm, vif, link_conf,\n\t\t\t\t\t&cmd.protection_flags,\n\t\t\t\t\tht_flag, LINK_PROT_FLG_TGG_PROTECT);\n\n\tiwl_mvm_set_fw_qos_params(mvm, vif, link_conf, cmd.ac,\n\t\t\t\t  &cmd.qos_flags);\n\n\n\tcmd.bi = cpu_to_le32(link_conf->beacon_int);\n\tcmd.dtim_interval = cpu_to_le32(link_conf->beacon_int *\n\t\t\t\t\tlink_conf->dtim_period);\n\n\tif (!link_conf->he_support || iwlwifi_mod_params.disable_11ax ||\n\t    (vif->type == NL80211_IFTYPE_STATION && !vif->cfg.assoc)) {\n\t\tchanges &= ~LINK_CONTEXT_MODIFY_HE_PARAMS;\n\t\tgoto send_cmd;\n\t}\n\n\tcmd.htc_trig_based_pkt_ext = link_conf->htc_trig_based_pkt_ext;\n\n\tif (link_conf->uora_exists) {\n\t\tcmd.rand_alloc_ecwmin =\n\t\t\tlink_conf->uora_ocw_range & 0x7;\n\t\tcmd.rand_alloc_ecwmax =\n\t\t\t(link_conf->uora_ocw_range >> 3) & 0x7;\n\t}\n\n\t \n\n\tif (iwl_mvm_set_fw_mu_edca_params(mvm, mvmvif->link[link_id],\n\t\t\t\t\t  &cmd.trig_based_txf[0])) {\n\t\tflags |= LINK_FLG_MU_EDCA_CW;\n\t\tflags_mask |= LINK_FLG_MU_EDCA_CW;\n\t}\n\n\tif (changes & LINK_CONTEXT_MODIFY_EHT_PARAMS) {\n\t\tif (iwlwifi_mod_params.disable_11be ||\n\t\t    !link_conf->eht_support)\n\t\t\tchanges &= ~LINK_CONTEXT_MODIFY_EHT_PARAMS;\n\t\telse\n\t\t\tcmd.puncture_mask =\n\t\t\t\tcpu_to_le16(link_conf->eht_puncturing);\n\t}\n\n\tcmd.bss_color = link_conf->he_bss_color.color;\n\n\tif (!link_conf->he_bss_color.enabled) {\n\t\tflags |= LINK_FLG_BSS_COLOR_DIS;\n\t\tflags_mask |= LINK_FLG_BSS_COLOR_DIS;\n\t}\n\n\tcmd.frame_time_rts_th = cpu_to_le16(link_conf->frame_time_rts_th);\n\n\t \n\tif (link_info->he_ru_2mhz_block) {\n\t\tflags |= LINK_FLG_RU_2MHZ_BLOCK;\n\t\tflags_mask |= LINK_FLG_RU_2MHZ_BLOCK;\n\t}\n\n\tif (link_conf->nontransmitted) {\n\t\tether_addr_copy(cmd.ref_bssid_addr,\n\t\t\t\tlink_conf->transmitter_bssid);\n\t\tcmd.bssid_index = link_conf->bssid_index;\n\t}\n\nsend_cmd:\n\tcmd.modify_mask = cpu_to_le32(changes);\n\tcmd.flags = cpu_to_le32(flags);\n\tcmd.flags_mask = cpu_to_le32(flags_mask);\n\tcmd.spec_link_id = link_conf->link_id;\n\tcmd.listen_lmac = cpu_to_le32(link_info->listen_lmac);\n\n\tret = iwl_mvm_link_cmd_send(mvm, &cmd, FW_CTXT_ACTION_MODIFY);\n\tif (!ret && (changes & LINK_CONTEXT_MODIFY_ACTIVE))\n\t\tlink_info->active = active;\n\n\treturn ret;\n}\n\nint iwl_mvm_remove_link(struct iwl_mvm *mvm, struct ieee80211_vif *vif,\n\t\t\tstruct ieee80211_bss_conf *link_conf)\n{\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tunsigned int link_id = link_conf->link_id;\n\tstruct iwl_mvm_vif_link_info *link_info = mvmvif->link[link_id];\n\tstruct iwl_link_config_cmd cmd = {};\n\tint ret;\n\n\tif (WARN_ON(!link_info ||\n\t\t    link_info->fw_link_id >= ARRAY_SIZE(mvm->link_id_to_link_conf)))\n\t\treturn -EINVAL;\n\n\tRCU_INIT_POINTER(mvm->link_id_to_link_conf[link_info->fw_link_id],\n\t\t\t NULL);\n\tcmd.link_id = cpu_to_le32(link_info->fw_link_id);\n\tiwl_mvm_release_fw_link_id(mvm, link_info->fw_link_id);\n\tlink_info->fw_link_id = IWL_MVM_FW_LINK_ID_INVALID;\n\tcmd.spec_link_id = link_conf->link_id;\n\n\tret = iwl_mvm_link_cmd_send(mvm, &cmd, FW_CTXT_ACTION_REMOVE);\n\n\tif (!ret)\n\t\tif (iwl_mvm_sf_update(mvm, vif, true))\n\t\t\tIWL_ERR(mvm, \"Failed to update SF state\\n\");\n\n\treturn ret;\n}\n\n \nint iwl_mvm_disable_link(struct iwl_mvm *mvm, struct ieee80211_vif *vif,\n\t\t\t struct ieee80211_bss_conf *link_conf)\n{\n\tint ret;\n\n\tret = iwl_mvm_link_changed(mvm, vif, link_conf,\n\t\t\t\t   LINK_CONTEXT_MODIFY_ACTIVE, false);\n\tif (ret)\n\t\treturn ret;\n\n\tret = iwl_mvm_remove_link(mvm, vif, link_conf);\n\tif (ret)\n\t\treturn ret;\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}