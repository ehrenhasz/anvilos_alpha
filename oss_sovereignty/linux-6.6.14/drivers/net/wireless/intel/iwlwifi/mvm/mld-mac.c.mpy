{
  "module_name": "mld-mac.c",
  "hash_id": "5f70297b74323551a08ff9f0b240a3096cdf736095d7edd241e85886a7d458fe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/intel/iwlwifi/mvm/mld-mac.c",
  "human_readable_source": "\n \n#include \"mvm.h\"\n\nstatic void iwl_mvm_mld_set_he_support(struct iwl_mvm *mvm,\n\t\t\t\t       struct ieee80211_vif *vif,\n\t\t\t\t       struct iwl_mac_config_cmd *cmd)\n{\n\tif (vif->type == NL80211_IFTYPE_AP)\n\t\tcmd->he_ap_support = cpu_to_le16(1);\n\telse\n\t\tcmd->he_support = cpu_to_le16(1);\n}\n\nstatic void iwl_mvm_mld_mac_ctxt_cmd_common(struct iwl_mvm *mvm,\n\t\t\t\t\t    struct ieee80211_vif *vif,\n\t\t\t\t\t    struct iwl_mac_config_cmd *cmd,\n\t\t\t\t\t    u32 action)\n{\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tstruct ieee80211_bss_conf *link_conf;\n\tunsigned int link_id;\n\n\tcmd->id_and_color = cpu_to_le32(mvmvif->id);\n\tcmd->action = cpu_to_le32(action);\n\n\tcmd->mac_type = cpu_to_le32(iwl_mvm_get_mac_type(vif));\n\n\tmemcpy(cmd->local_mld_addr, vif->addr, ETH_ALEN);\n\n\tcmd->he_support = 0;\n\tcmd->eht_support = 0;\n\n\t \n\tcmd->filter_flags = 0;\n\n\tcmd->nic_not_ack_enabled =\n\t\tcpu_to_le32(!iwl_mvm_is_nic_ack_enabled(mvm, vif));\n\n\tif (iwlwifi_mod_params.disable_11ax)\n\t\treturn;\n\n\t \n\tif (ieee80211_vif_is_mld(vif)) {\n\t\tiwl_mvm_mld_set_he_support(mvm, vif, cmd);\n\t\tcmd->eht_support = cpu_to_le32(1);\n\t\treturn;\n\t}\n\n\trcu_read_lock();\n\tfor (link_id = 0; link_id < ARRAY_SIZE((vif)->link_conf); link_id++) {\n\t\tlink_conf = rcu_dereference(vif->link_conf[link_id]);\n\t\tif (!link_conf)\n\t\t\tcontinue;\n\n\t\tif (link_conf->he_support)\n\t\t\tiwl_mvm_mld_set_he_support(mvm, vif, cmd);\n\n\t\t \n\t\tif (!link_conf->he_support && link_conf->eht_support)\n\t\t\tcontinue;\n\n\t\tif (link_conf->eht_support) {\n\t\t\tcmd->eht_support = cpu_to_le32(1);\n\t\t\tbreak;\n\t\t}\n\t}\n\trcu_read_unlock();\n}\n\nstatic int iwl_mvm_mld_mac_ctxt_send_cmd(struct iwl_mvm *mvm,\n\t\t\t\t\t struct iwl_mac_config_cmd *cmd)\n{\n\tint ret = iwl_mvm_send_cmd_pdu(mvm,\n\t\t\t\t       WIDE_ID(MAC_CONF_GROUP, MAC_CONFIG_CMD),\n\t\t\t\t       0, sizeof(*cmd), cmd);\n\tif (ret)\n\t\tIWL_ERR(mvm, \"Failed to send MAC_CONFIG_CMD (action:%d): %d\\n\",\n\t\t\tle32_to_cpu(cmd->action), ret);\n\treturn ret;\n}\n\nstatic int iwl_mvm_mld_mac_ctxt_cmd_sta(struct iwl_mvm *mvm,\n\t\t\t\t\tstruct ieee80211_vif *vif,\n\t\t\t\t\tu32 action, bool force_assoc_off)\n{\n\tstruct iwl_mac_config_cmd cmd = {};\n\tu16 esr_transition_timeout;\n\n\tWARN_ON(vif->type != NL80211_IFTYPE_STATION);\n\n\t \n\tiwl_mvm_mld_mac_ctxt_cmd_common(mvm, vif, &cmd, action);\n\n\t \n\tcmd.filter_flags |= cpu_to_le32(MAC_CFG_FILTER_ACCEPT_GRP);\n\n\tif (vif->p2p)\n\t\tcmd.client.ctwin =\n\t\t\tiwl_mvm_mac_ctxt_cmd_p2p_sta_get_oppps_ctwin(mvm, vif);\n\n\tif (vif->cfg.assoc && !force_assoc_off) {\n\t\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\n\t\tcmd.client.is_assoc = 1;\n\n\t\tif (!mvmvif->authorized &&\n\t\t    fw_has_capa(&mvm->fw->ucode_capa,\n\t\t\t\tIWL_UCODE_TLV_CAPA_COEX_HIGH_PRIO))\n\t\t\tcmd.client.data_policy |=\n\t\t\t\tcpu_to_le16(COEX_HIGH_PRIORITY_ENABLE);\n\n\t} else {\n\t\tcmd.client.is_assoc = 0;\n\n\t\t \n\t\tcmd.filter_flags |= cpu_to_le32(MAC_CFG_FILTER_ACCEPT_BEACON);\n\t}\n\n\tcmd.client.assoc_id = cpu_to_le16(vif->cfg.aid);\n\tif (ieee80211_vif_is_mld(vif)) {\n\t\tesr_transition_timeout =\n\t\t\tu16_get_bits(vif->cfg.eml_cap,\n\t\t\t\t     IEEE80211_EML_CAP_TRANSITION_TIMEOUT);\n\n\t\tcmd.client.esr_transition_timeout =\n\t\t\tmin_t(u16, IEEE80211_EML_CAP_TRANSITION_TIMEOUT_128TU,\n\t\t\t      esr_transition_timeout);\n\t\tcmd.client.medium_sync_delay =\n\t\t\tcpu_to_le16(vif->cfg.eml_med_sync_delay);\n\t}\n\n\tif (vif->probe_req_reg && vif->cfg.assoc && vif->p2p)\n\t\tcmd.filter_flags |= cpu_to_le32(MAC_CFG_FILTER_ACCEPT_PROBE_REQ);\n\n\tif (vif->bss_conf.he_support && !iwlwifi_mod_params.disable_11ax)\n\t\tcmd.client.data_policy |=\n\t\t\tcpu_to_le16(iwl_mvm_mac_ctxt_cmd_sta_get_twt_policy(mvm, vif));\n\n\treturn iwl_mvm_mld_mac_ctxt_send_cmd(mvm, &cmd);\n}\n\nstatic int iwl_mvm_mld_mac_ctxt_cmd_listener(struct iwl_mvm *mvm,\n\t\t\t\t\t     struct ieee80211_vif *vif,\n\t\t\t\t\t     u32 action)\n{\n\tstruct iwl_mac_config_cmd cmd = {};\n\n\tWARN_ON(vif->type != NL80211_IFTYPE_MONITOR);\n\n\tiwl_mvm_mld_mac_ctxt_cmd_common(mvm, vif, &cmd, action);\n\n\tcmd.filter_flags = cpu_to_le32(MAC_CFG_FILTER_PROMISC |\n\t\t\t\t       MAC_FILTER_IN_CONTROL_AND_MGMT |\n\t\t\t\t       MAC_CFG_FILTER_ACCEPT_BEACON |\n\t\t\t\t       MAC_CFG_FILTER_ACCEPT_PROBE_REQ |\n\t\t\t\t       MAC_CFG_FILTER_ACCEPT_GRP);\n\n\treturn iwl_mvm_mld_mac_ctxt_send_cmd(mvm, &cmd);\n}\n\nstatic int iwl_mvm_mld_mac_ctxt_cmd_ibss(struct iwl_mvm *mvm,\n\t\t\t\t\t struct ieee80211_vif *vif,\n\t\t\t\t\t u32 action)\n{\n\tstruct iwl_mac_config_cmd cmd = {};\n\n\tWARN_ON(vif->type != NL80211_IFTYPE_ADHOC);\n\n\tiwl_mvm_mld_mac_ctxt_cmd_common(mvm, vif, &cmd, action);\n\n\tcmd.filter_flags = cpu_to_le32(MAC_CFG_FILTER_ACCEPT_BEACON |\n\t\t\t\t       MAC_CFG_FILTER_ACCEPT_PROBE_REQ |\n\t\t\t\t       MAC_CFG_FILTER_ACCEPT_GRP);\n\n\treturn iwl_mvm_mld_mac_ctxt_send_cmd(mvm, &cmd);\n}\n\nstatic int iwl_mvm_mld_mac_ctxt_cmd_p2p_device(struct iwl_mvm *mvm,\n\t\t\t\t\t       struct ieee80211_vif *vif,\n\t\t\t\t\t       u32 action)\n{\n\tstruct iwl_mac_config_cmd cmd = {};\n\n\tWARN_ON(vif->type != NL80211_IFTYPE_P2P_DEVICE);\n\n\tiwl_mvm_mld_mac_ctxt_cmd_common(mvm, vif, &cmd, action);\n\n\tcmd.p2p_dev.is_disc_extended =\n\t\tiwl_mac_ctxt_p2p_dev_has_extended_disc(mvm, vif);\n\n\t \n\tcmd.filter_flags = cpu_to_le32(MAC_CFG_FILTER_ACCEPT_PROBE_REQ);\n\n\treturn iwl_mvm_mld_mac_ctxt_send_cmd(mvm, &cmd);\n}\n\nstatic int iwl_mvm_mld_mac_ctxt_cmd_ap_go(struct iwl_mvm *mvm,\n\t\t\t\t\t  struct ieee80211_vif *vif,\n\t\t\t\t\t  u32 action)\n{\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tstruct iwl_mac_config_cmd cmd = {};\n\n\tWARN_ON(vif->type != NL80211_IFTYPE_AP);\n\n\t \n\tiwl_mvm_mld_mac_ctxt_cmd_common(mvm, vif, &cmd, action);\n\n\tiwl_mvm_mac_ctxt_cmd_ap_set_filter_flags(mvm, mvmvif,\n\t\t\t\t\t\t &cmd.filter_flags,\n\t\t\t\t\t\t MAC_CFG_FILTER_ACCEPT_PROBE_REQ,\n\t\t\t\t\t\t MAC_CFG_FILTER_ACCEPT_BEACON);\n\n\treturn iwl_mvm_mld_mac_ctxt_send_cmd(mvm, &cmd);\n}\n\nstatic int iwl_mvm_mld_mac_ctx_send(struct iwl_mvm *mvm,\n\t\t\t\t    struct ieee80211_vif *vif,\n\t\t\t\t    u32 action, bool force_assoc_off)\n{\n\tswitch (vif->type) {\n\tcase NL80211_IFTYPE_STATION:\n\t\treturn iwl_mvm_mld_mac_ctxt_cmd_sta(mvm, vif, action,\n\t\t\t\t\t\t    force_assoc_off);\n\tcase NL80211_IFTYPE_AP:\n\t\treturn iwl_mvm_mld_mac_ctxt_cmd_ap_go(mvm, vif, action);\n\tcase NL80211_IFTYPE_MONITOR:\n\t\treturn iwl_mvm_mld_mac_ctxt_cmd_listener(mvm, vif, action);\n\tcase NL80211_IFTYPE_P2P_DEVICE:\n\t\treturn iwl_mvm_mld_mac_ctxt_cmd_p2p_device(mvm, vif, action);\n\tcase NL80211_IFTYPE_ADHOC:\n\t\treturn iwl_mvm_mld_mac_ctxt_cmd_ibss(mvm, vif, action);\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn -EOPNOTSUPP;\n}\n\nint iwl_mvm_mld_mac_ctxt_add(struct iwl_mvm *mvm, struct ieee80211_vif *vif)\n{\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tint ret;\n\n\tif (WARN_ON_ONCE(vif->type == NL80211_IFTYPE_NAN))\n\t\treturn -EOPNOTSUPP;\n\n\tif (WARN_ONCE(mvmvif->uploaded, \"Adding active MAC %pM/%d\\n\",\n\t\t      vif->addr, ieee80211_vif_type_p2p(vif)))\n\t\treturn -EIO;\n\n\tret = iwl_mvm_mld_mac_ctx_send(mvm, vif, FW_CTXT_ACTION_ADD,\n\t\t\t\t       true);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tiwl_mvm_set_last_nonqos_seq(mvm, vif);\n\n\tmvmvif->uploaded = true;\n\treturn 0;\n}\n\nint iwl_mvm_mld_mac_ctxt_changed(struct iwl_mvm *mvm,\n\t\t\t\t struct ieee80211_vif *vif,\n\t\t\t\t bool force_assoc_off)\n{\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\n\tif (WARN_ON_ONCE(vif->type == NL80211_IFTYPE_NAN))\n\t\treturn -EOPNOTSUPP;\n\n\tif (WARN_ONCE(!mvmvif->uploaded, \"Changing inactive MAC %pM/%d\\n\",\n\t\t      vif->addr, ieee80211_vif_type_p2p(vif)))\n\t\treturn -EIO;\n\n\treturn iwl_mvm_mld_mac_ctx_send(mvm, vif, FW_CTXT_ACTION_MODIFY,\n\t\t\t\t\tforce_assoc_off);\n}\n\nint iwl_mvm_mld_mac_ctxt_remove(struct iwl_mvm *mvm, struct ieee80211_vif *vif)\n{\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tstruct iwl_mac_config_cmd cmd = {\n\t\t.action = cpu_to_le32(FW_CTXT_ACTION_REMOVE),\n\t\t.id_and_color = cpu_to_le32(mvmvif->id),\n\t};\n\tint ret;\n\n\tif (WARN_ON_ONCE(vif->type == NL80211_IFTYPE_NAN))\n\t\treturn -EOPNOTSUPP;\n\n\tif (WARN_ONCE(!mvmvif->uploaded, \"Removing inactive MAC %pM/%d\\n\",\n\t\t      vif->addr, ieee80211_vif_type_p2p(vif)))\n\t\treturn -EIO;\n\n\tret = iwl_mvm_mld_mac_ctxt_send_cmd(mvm, &cmd);\n\tif (ret)\n\t\treturn ret;\n\n\tmvmvif->uploaded = false;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}