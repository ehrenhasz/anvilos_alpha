{
  "module_name": "vendor-cmd.c",
  "hash_id": "db29cac308b83e829fb2a792eb0930ea96fb241f9adef89178b718a51d6b8e54",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/intel/iwlwifi/mvm/vendor-cmd.c",
  "human_readable_source": "\n \n#include \"mvm.h\"\n#include <linux/nl80211-vnd-intel.h>\n#include <net/netlink.h>\n\nstatic const struct nla_policy\niwl_mvm_vendor_attr_policy[NUM_IWL_MVM_VENDOR_ATTR] = {\n\t[IWL_MVM_VENDOR_ATTR_ROAMING_FORBIDDEN] = { .type = NLA_U8 },\n\t[IWL_MVM_VENDOR_ATTR_AUTH_MODE] = { .type = NLA_U32 },\n\t[IWL_MVM_VENDOR_ATTR_CHANNEL_NUM] = { .type = NLA_U8 },\n\t[IWL_MVM_VENDOR_ATTR_SSID] = { .type = NLA_BINARY,\n\t\t\t\t       .len = IEEE80211_MAX_SSID_LEN },\n\t[IWL_MVM_VENDOR_ATTR_BAND] = { .type = NLA_U8 },\n\t[IWL_MVM_VENDOR_ATTR_COLLOC_CHANNEL] = { .type = NLA_U8 },\n\t[IWL_MVM_VENDOR_ATTR_COLLOC_ADDR] = { .type = NLA_BINARY, .len = ETH_ALEN },\n};\n\nstatic int iwl_mvm_vendor_get_csme_conn_info(struct wiphy *wiphy,\n\t\t\t\t\t     struct wireless_dev *wdev,\n\t\t\t\t\t     const void *data, int data_len)\n{\n\tstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\n\tstruct iwl_mvm *mvm = IWL_MAC80211_GET_MVM(hw);\n\tstruct iwl_mvm_csme_conn_info *csme_conn_info;\n\tstruct sk_buff *skb;\n\tint err = 0;\n\n\tmutex_lock(&mvm->mutex);\n\tcsme_conn_info = iwl_mvm_get_csme_conn_info(mvm);\n\n\tif (!csme_conn_info) {\n\t\terr = -EINVAL;\n\t\tgoto out_unlock;\n\t}\n\n\tskb = cfg80211_vendor_cmd_alloc_reply_skb(wiphy, 200);\n\tif (!skb) {\n\t\terr = -ENOMEM;\n\t\tgoto out_unlock;\n\t}\n\n\tif (nla_put_u32(skb, IWL_MVM_VENDOR_ATTR_AUTH_MODE,\n\t\t\tcsme_conn_info->conn_info.auth_mode) ||\n\t    nla_put(skb, IWL_MVM_VENDOR_ATTR_SSID,\n\t\t    csme_conn_info->conn_info.ssid_len,\n\t\t    csme_conn_info->conn_info.ssid) ||\n\t    nla_put_u32(skb, IWL_MVM_VENDOR_ATTR_STA_CIPHER,\n\t\t\tcsme_conn_info->conn_info.pairwise_cipher) ||\n\t    nla_put_u8(skb, IWL_MVM_VENDOR_ATTR_CHANNEL_NUM,\n\t\t       csme_conn_info->conn_info.channel) ||\n\t    nla_put(skb, IWL_MVM_VENDOR_ATTR_ADDR, ETH_ALEN,\n\t\t    csme_conn_info->conn_info.bssid)) {\n\t\tkfree_skb(skb);\n\t\terr = -ENOBUFS;\n\t}\n\nout_unlock:\n\tmutex_unlock(&mvm->mutex);\n\tif (err)\n\t\treturn err;\n\n\treturn cfg80211_vendor_cmd_reply(skb);\n}\n\nstatic int iwl_mvm_vendor_host_get_ownership(struct wiphy *wiphy,\n\t\t\t\t\t     struct wireless_dev *wdev,\n\t\t\t\t\t     const void *data, int data_len)\n{\n\tstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\n\tstruct iwl_mvm *mvm = IWL_MAC80211_GET_MVM(hw);\n\tint ret;\n\n\tmutex_lock(&mvm->mutex);\n\tret = iwl_mvm_mei_get_ownership(mvm);\n\tmutex_unlock(&mvm->mutex);\n\n\treturn ret;\n}\n\nstatic const struct wiphy_vendor_command iwl_mvm_vendor_commands[] = {\n\t{\n\t\t.info = {\n\t\t\t.vendor_id = INTEL_OUI,\n\t\t\t.subcmd = IWL_MVM_VENDOR_CMD_GET_CSME_CONN_INFO,\n\t\t},\n\t\t.doit = iwl_mvm_vendor_get_csme_conn_info,\n\t\t.flags = WIPHY_VENDOR_CMD_NEED_WDEV,\n\t\t.policy = iwl_mvm_vendor_attr_policy,\n\t\t.maxattr = MAX_IWL_MVM_VENDOR_ATTR,\n\t},\n\t{\n\t\t.info = {\n\t\t\t.vendor_id = INTEL_OUI,\n\t\t\t.subcmd = IWL_MVM_VENDOR_CMD_HOST_GET_OWNERSHIP,\n\t\t},\n\t\t.doit = iwl_mvm_vendor_host_get_ownership,\n\t\t.flags = WIPHY_VENDOR_CMD_NEED_WDEV,\n\t\t.policy = iwl_mvm_vendor_attr_policy,\n\t\t.maxattr = MAX_IWL_MVM_VENDOR_ATTR,\n\t},\n};\n\nenum iwl_mvm_vendor_events_idx {\n         \n        IWL_MVM_VENDOR_EVENT_IDX_ROAMING_FORBIDDEN = 4,\n        NUM_IWL_MVM_VENDOR_EVENT_IDX\n};\n\nstatic const struct nl80211_vendor_cmd_info\niwl_mvm_vendor_events[NUM_IWL_MVM_VENDOR_EVENT_IDX] = {\n\t[IWL_MVM_VENDOR_EVENT_IDX_ROAMING_FORBIDDEN] = {\n\t\t.vendor_id = INTEL_OUI,\n\t\t.subcmd = IWL_MVM_VENDOR_CMD_ROAMING_FORBIDDEN_EVENT,\n\t},\n};\n\nvoid iwl_mvm_vendor_cmds_register(struct iwl_mvm *mvm)\n{\n\tmvm->hw->wiphy->vendor_commands = iwl_mvm_vendor_commands;\n\tmvm->hw->wiphy->n_vendor_commands = ARRAY_SIZE(iwl_mvm_vendor_commands);\n\tmvm->hw->wiphy->vendor_events = iwl_mvm_vendor_events;\n\tmvm->hw->wiphy->n_vendor_events = ARRAY_SIZE(iwl_mvm_vendor_events);\n}\n\nvoid iwl_mvm_send_roaming_forbidden_event(struct iwl_mvm *mvm,\n\t\t\t\t\t  struct ieee80211_vif *vif,\n\t\t\t\t\t  bool forbidden)\n{\n\tstruct sk_buff *msg =\n\t\tcfg80211_vendor_event_alloc(mvm->hw->wiphy,\n\t\t\t\t\t    ieee80211_vif_to_wdev(vif),\n\t\t\t\t\t    200, IWL_MVM_VENDOR_EVENT_IDX_ROAMING_FORBIDDEN,\n\t\t\t\t\t    GFP_ATOMIC);\n\tif (!msg)\n\t\treturn;\n\n\tif (WARN_ON(!vif))\n\t\treturn;\n\n\tif (nla_put(msg, IWL_MVM_VENDOR_ATTR_VIF_ADDR,\n\t\t    ETH_ALEN, vif->addr) ||\n\t    nla_put_u8(msg, IWL_MVM_VENDOR_ATTR_ROAMING_FORBIDDEN, forbidden))\n\t\tgoto nla_put_failure;\n\n\tcfg80211_vendor_event(msg, GFP_ATOMIC);\n\treturn;\n\n nla_put_failure:\n\tkfree_skb(msg);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}