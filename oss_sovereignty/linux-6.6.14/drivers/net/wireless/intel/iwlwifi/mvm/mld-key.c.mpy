{
  "module_name": "mld-key.c",
  "hash_id": "60e31e3b49d41592b89c80cd05e037a7759ebceb8fc6d02e2b64397b06eb753a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/intel/iwlwifi/mvm/mld-key.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <net/mac80211.h>\n#include \"mvm.h\"\n#include \"fw/api/context.h\"\n#include \"fw/api/datapath.h\"\n\nstatic u32 iwl_mvm_get_sec_sta_mask(struct iwl_mvm *mvm,\n\t\t\t\t    struct ieee80211_vif *vif,\n\t\t\t\t    struct ieee80211_sta *sta,\n\t\t\t\t    struct ieee80211_key_conf *keyconf)\n{\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tstruct iwl_mvm_vif_link_info *link_info = &mvmvif->deflink;\n\n\tlockdep_assert_held(&mvm->mutex);\n\n\tif (keyconf->link_id >= 0) {\n\t\tlink_info = mvmvif->link[keyconf->link_id];\n\t\tif (!link_info)\n\t\t\treturn 0;\n\t}\n\n\t \n\tif (vif->type == NL80211_IFTYPE_AP &&\n\t    !(keyconf->flags & IEEE80211_KEY_FLAG_PAIRWISE)) {\n\t\t \n\t\tif (keyconf->keyidx >= 4)\n\t\t\treturn BIT(link_info->bcast_sta.sta_id);\n\t\t \n\t\treturn BIT(link_info->mcast_sta.sta_id);\n\t}\n\n\t \n\tif (!sta && vif->type == NL80211_IFTYPE_STATION)\n\t\tsta = mvmvif->ap_sta;\n\n\t \n\tif (!sta && (keyconf->link_id >= 0 || !ieee80211_vif_is_mld(vif)))\n\t\treturn BIT(link_info->ap_sta_id);\n\n\t \n\n\t \n\treturn iwl_mvm_sta_fw_id_mask(mvm, sta, keyconf->link_id);\n}\n\nu32 iwl_mvm_get_sec_flags(struct iwl_mvm *mvm,\n\t\t\t  struct ieee80211_vif *vif,\n\t\t\t  struct ieee80211_sta *sta,\n\t\t\t  struct ieee80211_key_conf *keyconf)\n{\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tu32 flags = 0;\n\n\tlockdep_assert_held(&mvm->mutex);\n\n\tif (!(keyconf->flags & IEEE80211_KEY_FLAG_PAIRWISE))\n\t\tflags |= IWL_SEC_KEY_FLAG_MCAST_KEY;\n\n\tswitch (keyconf->cipher) {\n\tcase WLAN_CIPHER_SUITE_WEP104:\n\t\tflags |= IWL_SEC_KEY_FLAG_KEY_SIZE;\n\t\tfallthrough;\n\tcase WLAN_CIPHER_SUITE_WEP40:\n\t\tflags |= IWL_SEC_KEY_FLAG_CIPHER_WEP;\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_TKIP:\n\t\tflags |= IWL_SEC_KEY_FLAG_CIPHER_TKIP;\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_AES_CMAC:\n\tcase WLAN_CIPHER_SUITE_CCMP:\n\t\tflags |= IWL_SEC_KEY_FLAG_CIPHER_CCMP;\n\t\tbreak;\n\tcase WLAN_CIPHER_SUITE_GCMP_256:\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_256:\n\t\tflags |= IWL_SEC_KEY_FLAG_KEY_SIZE;\n\t\tfallthrough;\n\tcase WLAN_CIPHER_SUITE_GCMP:\n\tcase WLAN_CIPHER_SUITE_BIP_GMAC_128:\n\t\tflags |= IWL_SEC_KEY_FLAG_CIPHER_GCMP;\n\t\tbreak;\n\t}\n\n\tif (!sta && vif->type == NL80211_IFTYPE_STATION)\n\t\tsta = mvmvif->ap_sta;\n\n\t \n\tif ((!IS_ERR_OR_NULL(sta) && sta->mfp) ||\n\t    (vif->type == NL80211_IFTYPE_AP &&\n\t     (keyconf->keyidx == 4 || keyconf->keyidx == 5)))\n\t\tflags |= IWL_SEC_KEY_FLAG_MFP;\n\n\treturn flags;\n}\n\nstruct iwl_mvm_sta_key_update_data {\n\tstruct ieee80211_sta *sta;\n\tu32 old_sta_mask;\n\tu32 new_sta_mask;\n\tint err;\n};\n\nstatic void iwl_mvm_mld_update_sta_key(struct ieee80211_hw *hw,\n\t\t\t\t       struct ieee80211_vif *vif,\n\t\t\t\t       struct ieee80211_sta *sta,\n\t\t\t\t       struct ieee80211_key_conf *key,\n\t\t\t\t       void *_data)\n{\n\tu32 cmd_id = WIDE_ID(DATA_PATH_GROUP, SEC_KEY_CMD);\n\tstruct iwl_mvm_sta_key_update_data *data = _data;\n\tstruct iwl_mvm *mvm = IWL_MAC80211_GET_MVM(hw);\n\tstruct iwl_sec_key_cmd cmd = {\n\t\t.action = cpu_to_le32(FW_CTXT_ACTION_MODIFY),\n\t\t.u.modify.old_sta_mask = cpu_to_le32(data->old_sta_mask),\n\t\t.u.modify.new_sta_mask = cpu_to_le32(data->new_sta_mask),\n\t\t.u.modify.key_id = cpu_to_le32(key->keyidx),\n\t\t.u.modify.key_flags =\n\t\t\tcpu_to_le32(iwl_mvm_get_sec_flags(mvm, vif, sta, key)),\n\t};\n\tint err;\n\n\t \n\tif (sta != data->sta || key->link_id >= 0)\n\t\treturn;\n\n\terr = iwl_mvm_send_cmd_pdu(mvm, cmd_id, CMD_ASYNC, sizeof(cmd), &cmd);\n\n\tif (err)\n\t\tdata->err = err;\n}\n\nint iwl_mvm_mld_update_sta_keys(struct iwl_mvm *mvm,\n\t\t\t\tstruct ieee80211_vif *vif,\n\t\t\t\tstruct ieee80211_sta *sta,\n\t\t\t\tu32 old_sta_mask,\n\t\t\t\tu32 new_sta_mask)\n{\n\tstruct iwl_mvm_sta_key_update_data data = {\n\t\t.sta = sta,\n\t\t.old_sta_mask = old_sta_mask,\n\t\t.new_sta_mask = new_sta_mask,\n\t};\n\n\tieee80211_iter_keys_rcu(mvm->hw, vif, iwl_mvm_mld_update_sta_key,\n\t\t\t\t&data);\n\treturn data.err;\n}\n\nstatic int __iwl_mvm_sec_key_del(struct iwl_mvm *mvm, u32 sta_mask,\n\t\t\t\t u32 key_flags, u32 keyidx, u32 flags)\n{\n\tu32 cmd_id = WIDE_ID(DATA_PATH_GROUP, SEC_KEY_CMD);\n\tstruct iwl_sec_key_cmd cmd = {\n\t\t.action = cpu_to_le32(FW_CTXT_ACTION_REMOVE),\n\t\t.u.remove.sta_mask = cpu_to_le32(sta_mask),\n\t\t.u.remove.key_id = cpu_to_le32(keyidx),\n\t\t.u.remove.key_flags = cpu_to_le32(key_flags),\n\t};\n\n\treturn iwl_mvm_send_cmd_pdu(mvm, cmd_id, flags, sizeof(cmd), &cmd);\n}\n\nint iwl_mvm_mld_send_key(struct iwl_mvm *mvm, u32 sta_mask, u32 key_flags,\n\t\t\t struct ieee80211_key_conf *keyconf)\n{\n\tu32 cmd_id = WIDE_ID(DATA_PATH_GROUP, SEC_KEY_CMD);\n\tstruct iwl_sec_key_cmd cmd = {\n\t\t.action = cpu_to_le32(FW_CTXT_ACTION_ADD),\n\t\t.u.add.sta_mask = cpu_to_le32(sta_mask),\n\t\t.u.add.key_id = cpu_to_le32(keyconf->keyidx),\n\t\t.u.add.key_flags = cpu_to_le32(key_flags),\n\t\t.u.add.tx_seq = cpu_to_le64(atomic64_read(&keyconf->tx_pn)),\n\t};\n\tint max_key_len = sizeof(cmd.u.add.key);\n\tint ret;\n\n\tif (keyconf->cipher == WLAN_CIPHER_SUITE_WEP40 ||\n\t    keyconf->cipher == WLAN_CIPHER_SUITE_WEP104)\n\t\tmax_key_len -= IWL_SEC_WEP_KEY_OFFSET;\n\n\tif (WARN_ON(keyconf->keylen > max_key_len))\n\t\treturn -EINVAL;\n\n\tif (WARN_ON(!sta_mask))\n\t\treturn -EINVAL;\n\n\tif (keyconf->cipher == WLAN_CIPHER_SUITE_WEP40 ||\n\t    keyconf->cipher == WLAN_CIPHER_SUITE_WEP104)\n\t\tmemcpy(cmd.u.add.key + IWL_SEC_WEP_KEY_OFFSET, keyconf->key,\n\t\t       keyconf->keylen);\n\telse\n\t\tmemcpy(cmd.u.add.key, keyconf->key, keyconf->keylen);\n\n\tif (keyconf->cipher == WLAN_CIPHER_SUITE_TKIP) {\n\t\tmemcpy(cmd.u.add.tkip_mic_rx_key,\n\t\t       keyconf->key + NL80211_TKIP_DATA_OFFSET_RX_MIC_KEY,\n\t\t       8);\n\t\tmemcpy(cmd.u.add.tkip_mic_tx_key,\n\t\t       keyconf->key + NL80211_TKIP_DATA_OFFSET_TX_MIC_KEY,\n\t\t       8);\n\t}\n\n\tret = iwl_mvm_send_cmd_pdu(mvm, cmd_id, 0, sizeof(cmd), &cmd);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (keyconf->cipher == WLAN_CIPHER_SUITE_WEP40 ||\n\t    keyconf->cipher == WLAN_CIPHER_SUITE_WEP104) {\n\t\tcmd.u.add.key_flags ^= cpu_to_le32(IWL_SEC_KEY_FLAG_MCAST_KEY);\n\t\tret = iwl_mvm_send_cmd_pdu(mvm, cmd_id, 0, sizeof(cmd), &cmd);\n\t\tif (ret)\n\t\t\t__iwl_mvm_sec_key_del(mvm, sta_mask, key_flags,\n\t\t\t\t\t      keyconf->keyidx, 0);\n\t}\n\n\treturn ret;\n}\n\nint iwl_mvm_sec_key_add(struct iwl_mvm *mvm,\n\t\t\tstruct ieee80211_vif *vif,\n\t\t\tstruct ieee80211_sta *sta,\n\t\t\tstruct ieee80211_key_conf *keyconf)\n{\n\tu32 sta_mask = iwl_mvm_get_sec_sta_mask(mvm, vif, sta, keyconf);\n\tu32 key_flags = iwl_mvm_get_sec_flags(mvm, vif, sta, keyconf);\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tstruct iwl_mvm_vif_link_info *mvm_link = NULL;\n\tint ret;\n\n\tif (keyconf->keyidx == 4 || keyconf->keyidx == 5) {\n\t\tunsigned int link_id = 0;\n\n\t\t \n\t\tif (keyconf->link_id >= 0)\n\t\t\tlink_id = keyconf->link_id;\n\n\t\tmvm_link = mvmvif->link[link_id];\n\t\tif (WARN_ON(!mvm_link))\n\t\t\treturn -EINVAL;\n\n\t\tif (mvm_link->igtk) {\n\t\t\tIWL_DEBUG_MAC80211(mvm, \"remove old IGTK %d\\n\",\n\t\t\t\t\t   mvm_link->igtk->keyidx);\n\t\t\tret = iwl_mvm_sec_key_del(mvm, vif, sta,\n\t\t\t\t\t\t  mvm_link->igtk);\n\t\t\tif (ret)\n\t\t\t\tIWL_ERR(mvm,\n\t\t\t\t\t\"failed to remove old IGTK (ret=%d)\\n\",\n\t\t\t\t\tret);\n\t\t}\n\n\t\tWARN_ON(mvm_link->igtk);\n\t}\n\n\tret = iwl_mvm_mld_send_key(mvm, sta_mask, key_flags, keyconf);\n\tif (ret)\n\t\treturn ret;\n\n\tif (mvm_link)\n\t\tmvm_link->igtk = keyconf;\n\n\t \n\tkeyconf->hw_key_idx = 0;\n\n\treturn 0;\n}\n\nstatic int _iwl_mvm_sec_key_del(struct iwl_mvm *mvm,\n\t\t\t\tstruct ieee80211_vif *vif,\n\t\t\t\tstruct ieee80211_sta *sta,\n\t\t\t\tstruct ieee80211_key_conf *keyconf,\n\t\t\t\tu32 flags)\n{\n\tu32 sta_mask = iwl_mvm_get_sec_sta_mask(mvm, vif, sta, keyconf);\n\tu32 key_flags = iwl_mvm_get_sec_flags(mvm, vif, sta, keyconf);\n\tstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\n\tint ret;\n\n\tif (WARN_ON(!sta_mask))\n\t\treturn -EINVAL;\n\n\tif (keyconf->keyidx == 4 || keyconf->keyidx == 5) {\n\t\tstruct iwl_mvm_vif_link_info *mvm_link;\n\t\tunsigned int link_id = 0;\n\n\t\t \n\t\tif (keyconf->link_id >= 0)\n\t\t\tlink_id = keyconf->link_id;\n\n\t\tmvm_link = mvmvif->link[link_id];\n\t\tif (WARN_ON(!mvm_link))\n\t\t\treturn -EINVAL;\n\n\t\tif (mvm_link->igtk == keyconf) {\n\t\t\t \n\t\t\tmvm_link->igtk->hw_key_idx = STA_KEY_IDX_INVALID;\n\t\t\tmvm_link->igtk = NULL;\n\t\t}\n\t}\n\n\tret = __iwl_mvm_sec_key_del(mvm, sta_mask, key_flags, keyconf->keyidx,\n\t\t\t\t    flags);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (keyconf->cipher == WLAN_CIPHER_SUITE_WEP40 ||\n\t    keyconf->cipher == WLAN_CIPHER_SUITE_WEP104) {\n\t\tkey_flags ^= IWL_SEC_KEY_FLAG_MCAST_KEY;\n\t\tret = __iwl_mvm_sec_key_del(mvm, sta_mask, key_flags,\n\t\t\t\t\t    keyconf->keyidx, flags);\n\t}\n\n\treturn ret;\n}\n\nint iwl_mvm_sec_key_del(struct iwl_mvm *mvm,\n\t\t\tstruct ieee80211_vif *vif,\n\t\t\tstruct ieee80211_sta *sta,\n\t\t\tstruct ieee80211_key_conf *keyconf)\n{\n\treturn _iwl_mvm_sec_key_del(mvm, vif, sta, keyconf, 0);\n}\n\nstatic void iwl_mvm_sec_key_remove_ap_iter(struct ieee80211_hw *hw,\n\t\t\t\t\t   struct ieee80211_vif *vif,\n\t\t\t\t\t   struct ieee80211_sta *sta,\n\t\t\t\t\t   struct ieee80211_key_conf *key,\n\t\t\t\t\t   void *data)\n{\n\tstruct iwl_mvm *mvm = IWL_MAC80211_GET_MVM(hw);\n\tunsigned int link_id = (uintptr_t)data;\n\n\tif (key->hw_key_idx == STA_KEY_IDX_INVALID)\n\t\treturn;\n\n\tif (sta)\n\t\treturn;\n\n\tif (key->link_id >= 0 && key->link_id != link_id)\n\t\treturn;\n\n\t_iwl_mvm_sec_key_del(mvm, vif, NULL, key, CMD_ASYNC);\n\tkey->hw_key_idx = STA_KEY_IDX_INVALID;\n}\n\nvoid iwl_mvm_sec_key_remove_ap(struct iwl_mvm *mvm,\n\t\t\t       struct ieee80211_vif *vif,\n\t\t\t       struct iwl_mvm_vif_link_info *link,\n\t\t\t       unsigned int link_id)\n{\n\tu32 sec_key_id = WIDE_ID(DATA_PATH_GROUP, SEC_KEY_CMD);\n\tu8 sec_key_ver = iwl_fw_lookup_cmd_ver(mvm->fw, sec_key_id, 0);\n\n\tif (WARN_ON_ONCE(vif->type != NL80211_IFTYPE_STATION ||\n\t\t\t link->ap_sta_id == IWL_MVM_INVALID_STA))\n\t\treturn;\n\n\tif (!sec_key_ver)\n\t\treturn;\n\n\tieee80211_iter_keys_rcu(mvm->hw, vif,\n\t\t\t\tiwl_mvm_sec_key_remove_ap_iter,\n\t\t\t\t(void *)(uintptr_t)link_id);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}