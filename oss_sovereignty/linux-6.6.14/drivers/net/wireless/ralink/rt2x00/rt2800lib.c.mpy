{
  "module_name": "rt2800lib.c",
  "hash_id": "fda46890d75f3b5fc41b0d38e9a03884bddc7d71f0266585b92133d43f2a4a99",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ralink/rt2x00/rt2800lib.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/crc-ccitt.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n\n#include \"rt2x00.h\"\n#include \"rt2800lib.h\"\n#include \"rt2800.h\"\n\nstatic bool modparam_watchdog;\nmodule_param_named(watchdog, modparam_watchdog, bool, S_IRUGO);\nMODULE_PARM_DESC(watchdog, \"Enable watchdog to detect tx/rx hangs and reset hardware if detected\");\n\n \n#define WAIT_FOR_BBP(__dev, __reg) \\\n\trt2800_regbusy_read((__dev), BBP_CSR_CFG, BBP_CSR_CFG_BUSY, (__reg))\n#define WAIT_FOR_RFCSR(__dev, __reg) \\\n\trt2800_regbusy_read((__dev), RF_CSR_CFG, RF_CSR_CFG_BUSY, (__reg))\n#define WAIT_FOR_RFCSR_MT7620(__dev, __reg) \\\n\trt2800_regbusy_read((__dev), RF_CSR_CFG, RF_CSR_CFG_BUSY_MT7620, \\\n\t\t\t    (__reg))\n#define WAIT_FOR_RF(__dev, __reg) \\\n\trt2800_regbusy_read((__dev), RF_CSR_CFG0, RF_CSR_CFG0_BUSY, (__reg))\n#define WAIT_FOR_MCU(__dev, __reg) \\\n\trt2800_regbusy_read((__dev), H2M_MAILBOX_CSR, \\\n\t\t\t    H2M_MAILBOX_CSR_OWNER, (__reg))\n\nstatic inline bool rt2800_is_305x_soc(struct rt2x00_dev *rt2x00dev)\n{\n\t \n\tif (!rt2x00_is_soc(rt2x00dev) ||\n\t    !rt2x00_rt(rt2x00dev, RT2872))\n\t\treturn false;\n\n\t \n\tif (rt2x00_rf(rt2x00dev, RF3020) ||\n\t    rt2x00_rf(rt2x00dev, RF3021) ||\n\t    rt2x00_rf(rt2x00dev, RF3022))\n\t\treturn true;\n\n\trt2x00_warn(rt2x00dev, \"Unknown RF chipset on rt305x\\n\");\n\treturn false;\n}\n\nstatic void rt2800_bbp_write(struct rt2x00_dev *rt2x00dev,\n\t\t\t     const unsigned int word, const u8 value)\n{\n\tu32 reg;\n\n\tmutex_lock(&rt2x00dev->csr_mutex);\n\n\t \n\tif (WAIT_FOR_BBP(rt2x00dev, &reg)) {\n\t\treg = 0;\n\t\trt2x00_set_field32(&reg, BBP_CSR_CFG_VALUE, value);\n\t\trt2x00_set_field32(&reg, BBP_CSR_CFG_REGNUM, word);\n\t\trt2x00_set_field32(&reg, BBP_CSR_CFG_BUSY, 1);\n\t\trt2x00_set_field32(&reg, BBP_CSR_CFG_READ_CONTROL, 0);\n\t\trt2x00_set_field32(&reg, BBP_CSR_CFG_BBP_RW_MODE, 1);\n\n\t\trt2800_register_write_lock(rt2x00dev, BBP_CSR_CFG, reg);\n\t}\n\n\tmutex_unlock(&rt2x00dev->csr_mutex);\n}\n\nstatic u8 rt2800_bbp_read(struct rt2x00_dev *rt2x00dev, const unsigned int word)\n{\n\tu32 reg;\n\tu8 value;\n\n\tmutex_lock(&rt2x00dev->csr_mutex);\n\n\t \n\tif (WAIT_FOR_BBP(rt2x00dev, &reg)) {\n\t\treg = 0;\n\t\trt2x00_set_field32(&reg, BBP_CSR_CFG_REGNUM, word);\n\t\trt2x00_set_field32(&reg, BBP_CSR_CFG_BUSY, 1);\n\t\trt2x00_set_field32(&reg, BBP_CSR_CFG_READ_CONTROL, 1);\n\t\trt2x00_set_field32(&reg, BBP_CSR_CFG_BBP_RW_MODE, 1);\n\n\t\trt2800_register_write_lock(rt2x00dev, BBP_CSR_CFG, reg);\n\n\t\tWAIT_FOR_BBP(rt2x00dev, &reg);\n\t}\n\n\tvalue = rt2x00_get_field32(reg, BBP_CSR_CFG_VALUE);\n\n\tmutex_unlock(&rt2x00dev->csr_mutex);\n\n\treturn value;\n}\n\nstatic void rt2800_rfcsr_write(struct rt2x00_dev *rt2x00dev,\n\t\t\t       const unsigned int word, const u8 value)\n{\n\tu32 reg;\n\n\tmutex_lock(&rt2x00dev->csr_mutex);\n\n\t \n\tswitch (rt2x00dev->chip.rt) {\n\tcase RT6352:\n\t\tif (WAIT_FOR_RFCSR_MT7620(rt2x00dev, &reg)) {\n\t\t\treg = 0;\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_DATA_MT7620, value);\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_REGNUM_MT7620,\n\t\t\t\t\t   word);\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_WRITE_MT7620, 1);\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_BUSY_MT7620, 1);\n\n\t\t\trt2800_register_write_lock(rt2x00dev, RF_CSR_CFG, reg);\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tif (WAIT_FOR_RFCSR(rt2x00dev, &reg)) {\n\t\t\treg = 0;\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_DATA, value);\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_REGNUM, word);\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_WRITE, 1);\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_BUSY, 1);\n\n\t\t\trt2800_register_write_lock(rt2x00dev, RF_CSR_CFG, reg);\n\t\t}\n\t\tbreak;\n\t}\n\n\tmutex_unlock(&rt2x00dev->csr_mutex);\n}\n\nstatic void rt2800_rfcsr_write_bank(struct rt2x00_dev *rt2x00dev, const u8 bank,\n\t\t\t\t    const unsigned int reg, const u8 value)\n{\n\trt2800_rfcsr_write(rt2x00dev, (reg | (bank << 6)), value);\n}\n\nstatic void rt2800_rfcsr_write_chanreg(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t       const unsigned int reg, const u8 value)\n{\n\trt2800_rfcsr_write_bank(rt2x00dev, 4, reg, value);\n\trt2800_rfcsr_write_bank(rt2x00dev, 6, reg, value);\n}\n\nstatic void rt2800_rfcsr_write_dccal(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t     const unsigned int reg, const u8 value)\n{\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, reg, value);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, reg, value);\n}\n\nstatic void rt2800_bbp_dcoc_write(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t  const u8 reg, const u8 value)\n{\n\trt2800_bbp_write(rt2x00dev, 158, reg);\n\trt2800_bbp_write(rt2x00dev, 159, value);\n}\n\nstatic u8 rt2800_bbp_dcoc_read(struct rt2x00_dev *rt2x00dev, const u8 reg)\n{\n\trt2800_bbp_write(rt2x00dev, 158, reg);\n\treturn rt2800_bbp_read(rt2x00dev, 159);\n}\n\nstatic void rt2800_bbp_glrt_write(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t  const u8 reg, const u8 value)\n{\n\trt2800_bbp_write(rt2x00dev, 195, reg);\n\trt2800_bbp_write(rt2x00dev, 196, value);\n}\n\nstatic u8 rt2800_rfcsr_read(struct rt2x00_dev *rt2x00dev,\n\t\t\t    const unsigned int word)\n{\n\tu32 reg;\n\tu8 value;\n\n\tmutex_lock(&rt2x00dev->csr_mutex);\n\n\t \n\tswitch (rt2x00dev->chip.rt) {\n\tcase RT6352:\n\t\tif (WAIT_FOR_RFCSR_MT7620(rt2x00dev, &reg)) {\n\t\t\treg = 0;\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_REGNUM_MT7620,\n\t\t\t\t\t   word);\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_WRITE_MT7620, 0);\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_BUSY_MT7620, 1);\n\n\t\t\trt2800_register_write_lock(rt2x00dev, RF_CSR_CFG, reg);\n\n\t\t\tWAIT_FOR_RFCSR_MT7620(rt2x00dev, &reg);\n\t\t}\n\n\t\tvalue = rt2x00_get_field32(reg, RF_CSR_CFG_DATA_MT7620);\n\t\tbreak;\n\n\tdefault:\n\t\tif (WAIT_FOR_RFCSR(rt2x00dev, &reg)) {\n\t\t\treg = 0;\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_REGNUM, word);\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_WRITE, 0);\n\t\t\trt2x00_set_field32(&reg, RF_CSR_CFG_BUSY, 1);\n\n\t\t\trt2800_register_write_lock(rt2x00dev, RF_CSR_CFG, reg);\n\n\t\t\tWAIT_FOR_RFCSR(rt2x00dev, &reg);\n\t\t}\n\n\t\tvalue = rt2x00_get_field32(reg, RF_CSR_CFG_DATA);\n\t\tbreak;\n\t}\n\n\tmutex_unlock(&rt2x00dev->csr_mutex);\n\n\treturn value;\n}\n\nstatic u8 rt2800_rfcsr_read_bank(struct rt2x00_dev *rt2x00dev, const u8 bank,\n\t\t\t\t const unsigned int reg)\n{\n\treturn rt2800_rfcsr_read(rt2x00dev, (reg | (bank << 6)));\n}\n\nstatic void rt2800_rf_write(struct rt2x00_dev *rt2x00dev,\n\t\t\t    const unsigned int word, const u32 value)\n{\n\tu32 reg;\n\n\tmutex_lock(&rt2x00dev->csr_mutex);\n\n\t \n\tif (WAIT_FOR_RF(rt2x00dev, &reg)) {\n\t\treg = 0;\n\t\trt2x00_set_field32(&reg, RF_CSR_CFG0_REG_VALUE_BW, value);\n\t\trt2x00_set_field32(&reg, RF_CSR_CFG0_STANDBYMODE, 0);\n\t\trt2x00_set_field32(&reg, RF_CSR_CFG0_SEL, 0);\n\t\trt2x00_set_field32(&reg, RF_CSR_CFG0_BUSY, 1);\n\n\t\trt2800_register_write_lock(rt2x00dev, RF_CSR_CFG0, reg);\n\t\trt2x00_rf_write(rt2x00dev, word, value);\n\t}\n\n\tmutex_unlock(&rt2x00dev->csr_mutex);\n}\n\nstatic const unsigned int rt2800_eeprom_map[EEPROM_WORD_COUNT] = {\n\t[EEPROM_CHIP_ID]\t\t= 0x0000,\n\t[EEPROM_VERSION]\t\t= 0x0001,\n\t[EEPROM_MAC_ADDR_0]\t\t= 0x0002,\n\t[EEPROM_MAC_ADDR_1]\t\t= 0x0003,\n\t[EEPROM_MAC_ADDR_2]\t\t= 0x0004,\n\t[EEPROM_NIC_CONF0]\t\t= 0x001a,\n\t[EEPROM_NIC_CONF1]\t\t= 0x001b,\n\t[EEPROM_FREQ]\t\t\t= 0x001d,\n\t[EEPROM_LED_AG_CONF]\t\t= 0x001e,\n\t[EEPROM_LED_ACT_CONF]\t\t= 0x001f,\n\t[EEPROM_LED_POLARITY]\t\t= 0x0020,\n\t[EEPROM_NIC_CONF2]\t\t= 0x0021,\n\t[EEPROM_LNA]\t\t\t= 0x0022,\n\t[EEPROM_RSSI_BG]\t\t= 0x0023,\n\t[EEPROM_RSSI_BG2]\t\t= 0x0024,\n\t[EEPROM_TXMIXER_GAIN_BG]\t= 0x0024,  \n\t[EEPROM_RSSI_A]\t\t\t= 0x0025,\n\t[EEPROM_RSSI_A2]\t\t= 0x0026,\n\t[EEPROM_TXMIXER_GAIN_A]\t\t= 0x0026,  \n\t[EEPROM_EIRP_MAX_TX_POWER]\t= 0x0027,\n\t[EEPROM_TXPOWER_DELTA]\t\t= 0x0028,\n\t[EEPROM_TXPOWER_BG1]\t\t= 0x0029,\n\t[EEPROM_TXPOWER_BG2]\t\t= 0x0030,\n\t[EEPROM_TSSI_BOUND_BG1]\t\t= 0x0037,\n\t[EEPROM_TSSI_BOUND_BG2]\t\t= 0x0038,\n\t[EEPROM_TSSI_BOUND_BG3]\t\t= 0x0039,\n\t[EEPROM_TSSI_BOUND_BG4]\t\t= 0x003a,\n\t[EEPROM_TSSI_BOUND_BG5]\t\t= 0x003b,\n\t[EEPROM_TXPOWER_A1]\t\t= 0x003c,\n\t[EEPROM_TXPOWER_A2]\t\t= 0x0053,\n\t[EEPROM_TXPOWER_INIT]\t\t= 0x0068,\n\t[EEPROM_TSSI_BOUND_A1]\t\t= 0x006a,\n\t[EEPROM_TSSI_BOUND_A2]\t\t= 0x006b,\n\t[EEPROM_TSSI_BOUND_A3]\t\t= 0x006c,\n\t[EEPROM_TSSI_BOUND_A4]\t\t= 0x006d,\n\t[EEPROM_TSSI_BOUND_A5]\t\t= 0x006e,\n\t[EEPROM_TXPOWER_BYRATE]\t\t= 0x006f,\n\t[EEPROM_BBP_START]\t\t= 0x0078,\n};\n\nstatic const unsigned int rt2800_eeprom_map_ext[EEPROM_WORD_COUNT] = {\n\t[EEPROM_CHIP_ID]\t\t= 0x0000,\n\t[EEPROM_VERSION]\t\t= 0x0001,\n\t[EEPROM_MAC_ADDR_0]\t\t= 0x0002,\n\t[EEPROM_MAC_ADDR_1]\t\t= 0x0003,\n\t[EEPROM_MAC_ADDR_2]\t\t= 0x0004,\n\t[EEPROM_NIC_CONF0]\t\t= 0x001a,\n\t[EEPROM_NIC_CONF1]\t\t= 0x001b,\n\t[EEPROM_NIC_CONF2]\t\t= 0x001c,\n\t[EEPROM_EIRP_MAX_TX_POWER]\t= 0x0020,\n\t[EEPROM_FREQ]\t\t\t= 0x0022,\n\t[EEPROM_LED_AG_CONF]\t\t= 0x0023,\n\t[EEPROM_LED_ACT_CONF]\t\t= 0x0024,\n\t[EEPROM_LED_POLARITY]\t\t= 0x0025,\n\t[EEPROM_LNA]\t\t\t= 0x0026,\n\t[EEPROM_EXT_LNA2]\t\t= 0x0027,\n\t[EEPROM_RSSI_BG]\t\t= 0x0028,\n\t[EEPROM_RSSI_BG2]\t\t= 0x0029,\n\t[EEPROM_RSSI_A]\t\t\t= 0x002a,\n\t[EEPROM_RSSI_A2]\t\t= 0x002b,\n\t[EEPROM_TXPOWER_BG1]\t\t= 0x0030,\n\t[EEPROM_TXPOWER_BG2]\t\t= 0x0037,\n\t[EEPROM_EXT_TXPOWER_BG3]\t= 0x003e,\n\t[EEPROM_TSSI_BOUND_BG1]\t\t= 0x0045,\n\t[EEPROM_TSSI_BOUND_BG2]\t\t= 0x0046,\n\t[EEPROM_TSSI_BOUND_BG3]\t\t= 0x0047,\n\t[EEPROM_TSSI_BOUND_BG4]\t\t= 0x0048,\n\t[EEPROM_TSSI_BOUND_BG5]\t\t= 0x0049,\n\t[EEPROM_TXPOWER_A1]\t\t= 0x004b,\n\t[EEPROM_TXPOWER_A2]\t\t= 0x0065,\n\t[EEPROM_EXT_TXPOWER_A3]\t\t= 0x007f,\n\t[EEPROM_TSSI_BOUND_A1]\t\t= 0x009a,\n\t[EEPROM_TSSI_BOUND_A2]\t\t= 0x009b,\n\t[EEPROM_TSSI_BOUND_A3]\t\t= 0x009c,\n\t[EEPROM_TSSI_BOUND_A4]\t\t= 0x009d,\n\t[EEPROM_TSSI_BOUND_A5]\t\t= 0x009e,\n\t[EEPROM_TXPOWER_BYRATE]\t\t= 0x00a0,\n};\n\nstatic unsigned int rt2800_eeprom_word_index(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t     const enum rt2800_eeprom_word word)\n{\n\tconst unsigned int *map;\n\tunsigned int index;\n\n\tif (WARN_ONCE(word >= EEPROM_WORD_COUNT,\n\t\t      \"%s: invalid EEPROM word %d\\n\",\n\t\t      wiphy_name(rt2x00dev->hw->wiphy), word))\n\t\treturn 0;\n\n\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t    rt2x00_rt(rt2x00dev, RT3883))\n\t\tmap = rt2800_eeprom_map_ext;\n\telse\n\t\tmap = rt2800_eeprom_map;\n\n\tindex = map[word];\n\n\t \n\tWARN_ONCE(word != EEPROM_CHIP_ID && index == 0,\n\t\t  \"%s: invalid access of EEPROM word %d\\n\",\n\t\t  wiphy_name(rt2x00dev->hw->wiphy), word);\n\n\treturn index;\n}\n\nstatic void *rt2800_eeprom_addr(struct rt2x00_dev *rt2x00dev,\n\t\t\t\tconst enum rt2800_eeprom_word word)\n{\n\tunsigned int index;\n\n\tindex = rt2800_eeprom_word_index(rt2x00dev, word);\n\treturn rt2x00_eeprom_addr(rt2x00dev, index);\n}\n\nstatic u16 rt2800_eeprom_read(struct rt2x00_dev *rt2x00dev,\n\t\t\t      const enum rt2800_eeprom_word word)\n{\n\tunsigned int index;\n\n\tindex = rt2800_eeprom_word_index(rt2x00dev, word);\n\treturn rt2x00_eeprom_read(rt2x00dev, index);\n}\n\nstatic void rt2800_eeprom_write(struct rt2x00_dev *rt2x00dev,\n\t\t\t\tconst enum rt2800_eeprom_word word, u16 data)\n{\n\tunsigned int index;\n\n\tindex = rt2800_eeprom_word_index(rt2x00dev, word);\n\trt2x00_eeprom_write(rt2x00dev, index, data);\n}\n\nstatic u16 rt2800_eeprom_read_from_array(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t const enum rt2800_eeprom_word array,\n\t\t\t\t\t unsigned int offset)\n{\n\tunsigned int index;\n\n\tindex = rt2800_eeprom_word_index(rt2x00dev, array);\n\treturn rt2x00_eeprom_read(rt2x00dev, index + offset);\n}\n\nstatic int rt2800_enable_wlan_rt3290(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 reg;\n\tint i, count;\n\n\treg = rt2800_register_read(rt2x00dev, WLAN_FUN_CTRL);\n\trt2x00_set_field32(&reg, WLAN_GPIO_OUT_OE_BIT_ALL, 0xff);\n\trt2x00_set_field32(&reg, FRC_WL_ANT_SET, 1);\n\trt2x00_set_field32(&reg, WLAN_CLK_EN, 0);\n\trt2x00_set_field32(&reg, WLAN_EN, 1);\n\trt2800_register_write(rt2x00dev, WLAN_FUN_CTRL, reg);\n\n\tudelay(REGISTER_BUSY_DELAY);\n\n\tcount = 0;\n\tdo {\n\t\t \n\t\tfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\n\t\t\treg = rt2800_register_read(rt2x00dev, CMB_CTRL);\n\t\t\tif (rt2x00_get_field32(reg, PLL_LD) &&\n\t\t\t    rt2x00_get_field32(reg, XTAL_RDY))\n\t\t\t\tbreak;\n\t\t\tudelay(REGISTER_BUSY_DELAY);\n\t\t}\n\n\t\tif (i >= REGISTER_BUSY_COUNT) {\n\n\t\t\tif (count >= 10)\n\t\t\t\treturn -EIO;\n\n\t\t\trt2800_register_write(rt2x00dev, 0x58, 0x018);\n\t\t\tudelay(REGISTER_BUSY_DELAY);\n\t\t\trt2800_register_write(rt2x00dev, 0x58, 0x418);\n\t\t\tudelay(REGISTER_BUSY_DELAY);\n\t\t\trt2800_register_write(rt2x00dev, 0x58, 0x618);\n\t\t\tudelay(REGISTER_BUSY_DELAY);\n\t\t\tcount++;\n\t\t} else {\n\t\t\tcount = 0;\n\t\t}\n\n\t\treg = rt2800_register_read(rt2x00dev, WLAN_FUN_CTRL);\n\t\trt2x00_set_field32(&reg, PCIE_APP0_CLK_REQ, 0);\n\t\trt2x00_set_field32(&reg, WLAN_CLK_EN, 1);\n\t\trt2x00_set_field32(&reg, WLAN_RESET, 1);\n\t\trt2800_register_write(rt2x00dev, WLAN_FUN_CTRL, reg);\n\t\tudelay(10);\n\t\trt2x00_set_field32(&reg, WLAN_RESET, 0);\n\t\trt2800_register_write(rt2x00dev, WLAN_FUN_CTRL, reg);\n\t\tudelay(10);\n\t\trt2800_register_write(rt2x00dev, INT_SOURCE_CSR, 0x7fffffff);\n\t} while (count != 0);\n\n\treturn 0;\n}\n\nvoid rt2800_mcu_request(struct rt2x00_dev *rt2x00dev,\n\t\t\tconst u8 command, const u8 token,\n\t\t\tconst u8 arg0, const u8 arg1)\n{\n\tu32 reg;\n\n\t \n\tif (rt2x00_is_soc(rt2x00dev))\n\t\treturn;\n\n\tmutex_lock(&rt2x00dev->csr_mutex);\n\n\t \n\tif (WAIT_FOR_MCU(rt2x00dev, &reg)) {\n\t\trt2x00_set_field32(&reg, H2M_MAILBOX_CSR_OWNER, 1);\n\t\trt2x00_set_field32(&reg, H2M_MAILBOX_CSR_CMD_TOKEN, token);\n\t\trt2x00_set_field32(&reg, H2M_MAILBOX_CSR_ARG0, arg0);\n\t\trt2x00_set_field32(&reg, H2M_MAILBOX_CSR_ARG1, arg1);\n\t\trt2800_register_write_lock(rt2x00dev, H2M_MAILBOX_CSR, reg);\n\n\t\treg = 0;\n\t\trt2x00_set_field32(&reg, HOST_CMD_CSR_HOST_COMMAND, command);\n\t\trt2800_register_write_lock(rt2x00dev, HOST_CMD_CSR, reg);\n\t}\n\n\tmutex_unlock(&rt2x00dev->csr_mutex);\n}\nEXPORT_SYMBOL_GPL(rt2800_mcu_request);\n\nint rt2800_wait_csr_ready(struct rt2x00_dev *rt2x00dev)\n{\n\tunsigned int i = 0;\n\tu32 reg;\n\n\tfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\n\t\treg = rt2800_register_read(rt2x00dev, MAC_CSR0);\n\t\tif (reg && reg != ~0)\n\t\t\treturn 0;\n\t\tmsleep(1);\n\t}\n\n\trt2x00_err(rt2x00dev, \"Unstable hardware\\n\");\n\treturn -EBUSY;\n}\nEXPORT_SYMBOL_GPL(rt2800_wait_csr_ready);\n\nint rt2800_wait_wpdma_ready(struct rt2x00_dev *rt2x00dev)\n{\n\tunsigned int i;\n\tu32 reg;\n\n\t \n\tfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\n\t\treg = rt2800_register_read(rt2x00dev, WPDMA_GLO_CFG);\n\t\tif (!rt2x00_get_field32(reg, WPDMA_GLO_CFG_TX_DMA_BUSY) &&\n\t\t    !rt2x00_get_field32(reg, WPDMA_GLO_CFG_RX_DMA_BUSY))\n\t\t\treturn 0;\n\n\t\tmsleep(10);\n\t}\n\n\trt2x00_err(rt2x00dev, \"WPDMA TX/RX busy [0x%08x]\\n\", reg);\n\treturn -EACCES;\n}\nEXPORT_SYMBOL_GPL(rt2800_wait_wpdma_ready);\n\nvoid rt2800_disable_wpdma(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 reg;\n\n\treg = rt2800_register_read(rt2x00dev, WPDMA_GLO_CFG);\n\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_TX_DMA, 0);\n\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_TX_DMA_BUSY, 0);\n\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_RX_DMA, 0);\n\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_RX_DMA_BUSY, 0);\n\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_TX_WRITEBACK_DONE, 1);\n\trt2800_register_write(rt2x00dev, WPDMA_GLO_CFG, reg);\n}\nEXPORT_SYMBOL_GPL(rt2800_disable_wpdma);\n\nvoid rt2800_get_txwi_rxwi_size(struct rt2x00_dev *rt2x00dev,\n\t\t\t       unsigned short *txwi_size,\n\t\t\t       unsigned short *rxwi_size)\n{\n\tswitch (rt2x00dev->chip.rt) {\n\tcase RT3593:\n\tcase RT3883:\n\t\t*txwi_size = TXWI_DESC_SIZE_4WORDS;\n\t\t*rxwi_size = RXWI_DESC_SIZE_5WORDS;\n\t\tbreak;\n\n\tcase RT5592:\n\tcase RT6352:\n\t\t*txwi_size = TXWI_DESC_SIZE_5WORDS;\n\t\t*rxwi_size = RXWI_DESC_SIZE_6WORDS;\n\t\tbreak;\n\n\tdefault:\n\t\t*txwi_size = TXWI_DESC_SIZE_4WORDS;\n\t\t*rxwi_size = RXWI_DESC_SIZE_4WORDS;\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL_GPL(rt2800_get_txwi_rxwi_size);\n\nstatic bool rt2800_check_firmware_crc(const u8 *data, const size_t len)\n{\n\tu16 fw_crc;\n\tu16 crc;\n\n\t \n\tfw_crc = (data[len - 2] << 8 | data[len - 1]);\n\n\t \n\tcrc = crc_ccitt(~0, data, len - 2);\n\n\t \n\tcrc = swab16(crc);\n\n\treturn fw_crc == crc;\n}\n\nint rt2800_check_firmware(struct rt2x00_dev *rt2x00dev,\n\t\t\t  const u8 *data, const size_t len)\n{\n\tsize_t offset = 0;\n\tsize_t fw_len;\n\tbool multiple;\n\n\t \n\tif (rt2x00_is_usb(rt2x00dev) || rt2x00_rt(rt2x00dev, RT3290))\n\t\tfw_len = 4096;\n\telse\n\t\tfw_len = 8192;\n\n\tmultiple = true;\n\t \n\tif (len != fw_len && (!multiple || (len % fw_len) != 0))\n\t\treturn FW_BAD_LENGTH;\n\n\t \n\tif (rt2x00_is_usb(rt2x00dev) &&\n\t    !rt2x00_rt(rt2x00dev, RT2860) &&\n\t    !rt2x00_rt(rt2x00dev, RT2872) &&\n\t    !rt2x00_rt(rt2x00dev, RT3070) &&\n\t    ((len / fw_len) == 1))\n\t\treturn FW_BAD_VERSION;\n\n\t \n\twhile (offset < len) {\n\t\tif (!rt2800_check_firmware_crc(data + offset, fw_len))\n\t\t\treturn FW_BAD_CRC;\n\n\t\toffset += fw_len;\n\t}\n\n\treturn FW_OK;\n}\nEXPORT_SYMBOL_GPL(rt2800_check_firmware);\n\nint rt2800_load_firmware(struct rt2x00_dev *rt2x00dev,\n\t\t\t const u8 *data, const size_t len)\n{\n\tunsigned int i;\n\tu32 reg;\n\tint retval;\n\n\tif (rt2x00_rt(rt2x00dev, RT3290)) {\n\t\tretval = rt2800_enable_wlan_rt3290(rt2x00dev);\n\t\tif (retval)\n\t\t\treturn -EBUSY;\n\t}\n\n\t \n\trt2800_register_write(rt2x00dev, AUTOWAKEUP_CFG, 0x00000000);\n\n\t \n\tif (rt2800_wait_csr_ready(rt2x00dev))\n\t\treturn -EBUSY;\n\n\tif (rt2x00_is_pci(rt2x00dev)) {\n\t\tif (rt2x00_rt(rt2x00dev, RT3290) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3572) ||\n\t\t    rt2x00_rt(rt2x00dev, RT5390) ||\n\t\t    rt2x00_rt(rt2x00dev, RT5392)) {\n\t\t\treg = rt2800_register_read(rt2x00dev, AUX_CTRL);\n\t\t\trt2x00_set_field32(&reg, AUX_CTRL_FORCE_PCIE_CLK, 1);\n\t\t\trt2x00_set_field32(&reg, AUX_CTRL_WAKE_PCIE_EN, 1);\n\t\t\trt2800_register_write(rt2x00dev, AUX_CTRL, reg);\n\t\t}\n\t\trt2800_register_write(rt2x00dev, PWR_PIN_CFG, 0x00000002);\n\t}\n\n\trt2800_disable_wpdma(rt2x00dev);\n\n\t \n\trt2800_drv_write_firmware(rt2x00dev, data, len);\n\n\t \n\tfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\n\t\treg = rt2800_register_read(rt2x00dev, PBF_SYS_CTRL);\n\t\tif (rt2x00_get_field32(reg, PBF_SYS_CTRL_READY))\n\t\t\tbreak;\n\t\tmsleep(1);\n\t}\n\n\tif (i == REGISTER_BUSY_COUNT) {\n\t\trt2x00_err(rt2x00dev, \"PBF system register not ready\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\t \n\trt2800_disable_wpdma(rt2x00dev);\n\n\t \n\trt2800_register_write(rt2x00dev, H2M_BBP_AGENT, 0);\n\trt2800_register_write(rt2x00dev, H2M_MAILBOX_CSR, 0);\n\tif (rt2x00_is_usb(rt2x00dev)) {\n\t\trt2800_register_write(rt2x00dev, H2M_INT_SRC, 0);\n\t\trt2800_mcu_request(rt2x00dev, MCU_BOOT_SIGNAL, 0, 0, 0);\n\t}\n\tmsleep(1);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rt2800_load_firmware);\n\nvoid rt2800_write_tx_data(struct queue_entry *entry,\n\t\t\t  struct txentry_desc *txdesc)\n{\n\t__le32 *txwi = rt2800_drv_get_txwi(entry);\n\tu32 word;\n\tint i;\n\n\t \n\tword = rt2x00_desc_read(txwi, 0);\n\trt2x00_set_field32(&word, TXWI_W0_FRAG,\n\t\t\t   test_bit(ENTRY_TXD_MORE_FRAG, &txdesc->flags));\n\trt2x00_set_field32(&word, TXWI_W0_MIMO_PS,\n\t\t\t   test_bit(ENTRY_TXD_HT_MIMO_PS, &txdesc->flags));\n\trt2x00_set_field32(&word, TXWI_W0_CF_ACK, 0);\n\trt2x00_set_field32(&word, TXWI_W0_TS,\n\t\t\t   test_bit(ENTRY_TXD_REQ_TIMESTAMP, &txdesc->flags));\n\trt2x00_set_field32(&word, TXWI_W0_AMPDU,\n\t\t\t   test_bit(ENTRY_TXD_HT_AMPDU, &txdesc->flags));\n\trt2x00_set_field32(&word, TXWI_W0_MPDU_DENSITY,\n\t\t\t   txdesc->u.ht.mpdu_density);\n\trt2x00_set_field32(&word, TXWI_W0_TX_OP, txdesc->u.ht.txop);\n\trt2x00_set_field32(&word, TXWI_W0_MCS, txdesc->u.ht.mcs);\n\trt2x00_set_field32(&word, TXWI_W0_BW,\n\t\t\t   test_bit(ENTRY_TXD_HT_BW_40, &txdesc->flags));\n\trt2x00_set_field32(&word, TXWI_W0_SHORT_GI,\n\t\t\t   test_bit(ENTRY_TXD_HT_SHORT_GI, &txdesc->flags));\n\trt2x00_set_field32(&word, TXWI_W0_STBC, txdesc->u.ht.stbc);\n\trt2x00_set_field32(&word, TXWI_W0_PHYMODE, txdesc->rate_mode);\n\trt2x00_desc_write(txwi, 0, word);\n\n\tword = rt2x00_desc_read(txwi, 1);\n\trt2x00_set_field32(&word, TXWI_W1_ACK,\n\t\t\t   test_bit(ENTRY_TXD_ACK, &txdesc->flags));\n\trt2x00_set_field32(&word, TXWI_W1_NSEQ,\n\t\t\t   test_bit(ENTRY_TXD_GENERATE_SEQ, &txdesc->flags));\n\trt2x00_set_field32(&word, TXWI_W1_BW_WIN_SIZE, txdesc->u.ht.ba_size);\n\trt2x00_set_field32(&word, TXWI_W1_WIRELESS_CLI_ID,\n\t\t\t   test_bit(ENTRY_TXD_ENCRYPT, &txdesc->flags) ?\n\t\t\t   txdesc->key_idx : txdesc->u.ht.wcid);\n\trt2x00_set_field32(&word, TXWI_W1_MPDU_TOTAL_BYTE_COUNT,\n\t\t\t   txdesc->length);\n\trt2x00_set_field32(&word, TXWI_W1_PACKETID_QUEUE, entry->queue->qid);\n\trt2x00_set_field32(&word, TXWI_W1_PACKETID_ENTRY, (entry->entry_idx % 3) + 1);\n\trt2x00_desc_write(txwi, 1, word);\n\n\t \n\tfor (i = 2; i < entry->queue->winfo_size / sizeof(__le32); i++)\n\t\t_rt2x00_desc_write(txwi, i, 0);\n}\nEXPORT_SYMBOL_GPL(rt2800_write_tx_data);\n\nstatic int rt2800_agc_to_rssi(struct rt2x00_dev *rt2x00dev, u32 rxwi_w2)\n{\n\ts8 rssi0 = rt2x00_get_field32(rxwi_w2, RXWI_W2_RSSI0);\n\ts8 rssi1 = rt2x00_get_field32(rxwi_w2, RXWI_W2_RSSI1);\n\ts8 rssi2 = rt2x00_get_field32(rxwi_w2, RXWI_W2_RSSI2);\n\tu16 eeprom;\n\tu8 offset0;\n\tu8 offset1;\n\tu8 offset2;\n\n\tif (rt2x00dev->curr_band == NL80211_BAND_2GHZ) {\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_BG);\n\t\toffset0 = rt2x00_get_field16(eeprom, EEPROM_RSSI_BG_OFFSET0);\n\t\toffset1 = rt2x00_get_field16(eeprom, EEPROM_RSSI_BG_OFFSET1);\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_BG2);\n\t\toffset2 = rt2x00_get_field16(eeprom, EEPROM_RSSI_BG2_OFFSET2);\n\t} else {\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_A);\n\t\toffset0 = rt2x00_get_field16(eeprom, EEPROM_RSSI_A_OFFSET0);\n\t\toffset1 = rt2x00_get_field16(eeprom, EEPROM_RSSI_A_OFFSET1);\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_A2);\n\t\toffset2 = rt2x00_get_field16(eeprom, EEPROM_RSSI_A2_OFFSET2);\n\t}\n\n\t \n\trssi0 = (rssi0) ? (-12 - offset0 - rt2x00dev->lna_gain - rssi0) : -128;\n\trssi1 = (rssi1) ? (-12 - offset1 - rt2x00dev->lna_gain - rssi1) : -128;\n\trssi2 = (rssi2) ? (-12 - offset2 - rt2x00dev->lna_gain - rssi2) : -128;\n\n\t \n\trssi0 = max(rssi0, rssi1);\n\treturn (int)max(rssi0, rssi2);\n}\n\nvoid rt2800_process_rxwi(struct queue_entry *entry,\n\t\t\t struct rxdone_entry_desc *rxdesc)\n{\n\t__le32 *rxwi = (__le32 *) entry->skb->data;\n\tu32 word;\n\n\tword = rt2x00_desc_read(rxwi, 0);\n\n\trxdesc->cipher = rt2x00_get_field32(word, RXWI_W0_UDF);\n\trxdesc->size = rt2x00_get_field32(word, RXWI_W0_MPDU_TOTAL_BYTE_COUNT);\n\n\tword = rt2x00_desc_read(rxwi, 1);\n\n\tif (rt2x00_get_field32(word, RXWI_W1_SHORT_GI))\n\t\trxdesc->enc_flags |= RX_ENC_FLAG_SHORT_GI;\n\n\tif (rt2x00_get_field32(word, RXWI_W1_BW))\n\t\trxdesc->bw = RATE_INFO_BW_40;\n\n\t \n\trxdesc->dev_flags |= RXDONE_SIGNAL_MCS;\n\trxdesc->signal = rt2x00_get_field32(word, RXWI_W1_MCS);\n\trxdesc->rate_mode = rt2x00_get_field32(word, RXWI_W1_PHYMODE);\n\n\t \n\tif (rxdesc->rate_mode == RATE_MODE_CCK)\n\t\trxdesc->signal &= ~0x8;\n\n\tword = rt2x00_desc_read(rxwi, 2);\n\n\t \n\trxdesc->rssi = rt2800_agc_to_rssi(entry->queue->rt2x00dev, word);\n\t \n\tskb_pull(entry->skb, entry->queue->winfo_size);\n}\nEXPORT_SYMBOL_GPL(rt2800_process_rxwi);\n\nstatic void rt2800_rate_from_status(struct skb_frame_desc *skbdesc,\n\t\t\t\t    u32 status, enum nl80211_band band)\n{\n\tu8 flags = 0;\n\tu8 idx = rt2x00_get_field32(status, TX_STA_FIFO_MCS);\n\n\tswitch (rt2x00_get_field32(status, TX_STA_FIFO_PHYMODE)) {\n\tcase RATE_MODE_HT_GREENFIELD:\n\t\tflags |= IEEE80211_TX_RC_GREEN_FIELD;\n\t\tfallthrough;\n\tcase RATE_MODE_HT_MIX:\n\t\tflags |= IEEE80211_TX_RC_MCS;\n\t\tbreak;\n\tcase RATE_MODE_OFDM:\n\t\tif (band == NL80211_BAND_2GHZ)\n\t\t\tidx += 4;\n\t\tbreak;\n\tcase RATE_MODE_CCK:\n\t\tif (idx >= 8)\n\t\t\tidx -= 8;\n\t\tbreak;\n\t}\n\n\tif (rt2x00_get_field32(status, TX_STA_FIFO_BW))\n\t\tflags |= IEEE80211_TX_RC_40_MHZ_WIDTH;\n\n\tif (rt2x00_get_field32(status, TX_STA_FIFO_SGI))\n\t\tflags |= IEEE80211_TX_RC_SHORT_GI;\n\n\tskbdesc->tx_rate_idx = idx;\n\tskbdesc->tx_rate_flags = flags;\n}\n\nstatic bool rt2800_txdone_entry_check(struct queue_entry *entry, u32 reg)\n{\n\t__le32 *txwi;\n\tu32 word;\n\tint wcid, ack, pid;\n\tint tx_wcid, tx_ack, tx_pid, is_agg;\n\n\t \n\tif (test_bit(ENTRY_DATA_IO_FAILED, &entry->flags))\n\t\treturn false;\n\n\twcid\t= rt2x00_get_field32(reg, TX_STA_FIFO_WCID);\n\tack\t= rt2x00_get_field32(reg, TX_STA_FIFO_TX_ACK_REQUIRED);\n\tpid\t= rt2x00_get_field32(reg, TX_STA_FIFO_PID_TYPE);\n\tis_agg\t= rt2x00_get_field32(reg, TX_STA_FIFO_TX_AGGRE);\n\n\t \n\ttxwi = rt2800_drv_get_txwi(entry);\n\n\tword = rt2x00_desc_read(txwi, 1);\n\ttx_wcid = rt2x00_get_field32(word, TXWI_W1_WIRELESS_CLI_ID);\n\ttx_ack  = rt2x00_get_field32(word, TXWI_W1_ACK);\n\ttx_pid  = rt2x00_get_field32(word, TXWI_W1_PACKETID);\n\n\tif (wcid != tx_wcid || ack != tx_ack || (!is_agg && pid != tx_pid)) {\n\t\trt2x00_dbg(entry->queue->rt2x00dev,\n\t\t\t   \"TX status report missed for queue %d entry %d\\n\",\n\t\t\t   entry->queue->qid, entry->entry_idx);\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nvoid rt2800_txdone_entry(struct queue_entry *entry, u32 status, __le32 *txwi,\n\t\t\t bool match)\n{\n\tstruct rt2x00_dev *rt2x00dev = entry->queue->rt2x00dev;\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tstruct skb_frame_desc *skbdesc = get_skb_frame_desc(entry->skb);\n\tstruct txdone_entry_desc txdesc;\n\tu32 word;\n\tu16 mcs, real_mcs;\n\tint aggr, ampdu, wcid, ack_req;\n\n\t \n\ttxdesc.flags = 0;\n\tword = rt2x00_desc_read(txwi, 0);\n\n\tmcs = rt2x00_get_field32(word, TXWI_W0_MCS);\n\tampdu = rt2x00_get_field32(word, TXWI_W0_AMPDU);\n\n\treal_mcs = rt2x00_get_field32(status, TX_STA_FIFO_MCS);\n\taggr = rt2x00_get_field32(status, TX_STA_FIFO_TX_AGGRE);\n\twcid = rt2x00_get_field32(status, TX_STA_FIFO_WCID);\n\tack_req\t= rt2x00_get_field32(status, TX_STA_FIFO_TX_ACK_REQUIRED);\n\n\t \n\tif (unlikely((aggr == 1 && ampdu == 0 && real_mcs != mcs)) || !match) {\n\t\trt2800_rate_from_status(skbdesc, status, rt2x00dev->curr_band);\n\t\tmcs = real_mcs;\n\t}\n\n\tif (aggr == 1 || ampdu == 1)\n\t\t__set_bit(TXDONE_AMPDU, &txdesc.flags);\n\n\tif (!ack_req)\n\t\t__set_bit(TXDONE_NO_ACK_REQ, &txdesc.flags);\n\n\t \n\tif (rt2x00_get_field32(status, TX_STA_FIFO_TX_SUCCESS)) {\n\t\t \n\t\t__set_bit(TXDONE_SUCCESS, &txdesc.flags);\n\t\ttxdesc.retry = ((mcs > real_mcs) ? mcs - real_mcs : 0);\n\t} else {\n\t\t \n\t\t__set_bit(TXDONE_FAILURE, &txdesc.flags);\n\t\ttxdesc.retry = rt2x00dev->long_retry;\n\t}\n\n\t \n\tif (txdesc.retry)\n\t\t__set_bit(TXDONE_FALLBACK, &txdesc.flags);\n\n\tif (!match) {\n\t\t \n\t\trcu_read_lock();\n\t\tif (likely(wcid >= WCID_START && wcid <= WCID_END))\n\t\t\tskbdesc->sta = drv_data->wcid_to_sta[wcid - WCID_START];\n\t\telse\n\t\t\tskbdesc->sta = NULL;\n\t\trt2x00lib_txdone_nomatch(entry, &txdesc);\n\t\trcu_read_unlock();\n\t} else {\n\t\trt2x00lib_txdone(entry, &txdesc);\n\t}\n}\nEXPORT_SYMBOL_GPL(rt2800_txdone_entry);\n\nvoid rt2800_txdone(struct rt2x00_dev *rt2x00dev, unsigned int quota)\n{\n\tstruct data_queue *queue;\n\tstruct queue_entry *entry;\n\tu32 reg;\n\tu8 qid;\n\tbool match;\n\n\twhile (quota-- > 0 && kfifo_get(&rt2x00dev->txstatus_fifo, &reg)) {\n\t\t \n\t\tqid = rt2x00_get_field32(reg, TX_STA_FIFO_PID_QUEUE);\n\t\tqueue = rt2x00queue_get_tx_queue(rt2x00dev, qid);\n\n\t\tif (unlikely(rt2x00queue_empty(queue))) {\n\t\t\trt2x00_dbg(rt2x00dev, \"Got TX status for an empty queue %u, dropping\\n\",\n\t\t\t\t   qid);\n\t\t\tbreak;\n\t\t}\n\n\t\tentry = rt2x00queue_get_entry(queue, Q_INDEX_DONE);\n\n\t\tif (unlikely(test_bit(ENTRY_OWNER_DEVICE_DATA, &entry->flags) ||\n\t\t\t     !test_bit(ENTRY_DATA_STATUS_PENDING, &entry->flags))) {\n\t\t\trt2x00_warn(rt2x00dev, \"Data pending for entry %u in queue %u\\n\",\n\t\t\t\t    entry->entry_idx, qid);\n\t\t\tbreak;\n\t\t}\n\n\t\tmatch = rt2800_txdone_entry_check(entry, reg);\n\t\trt2800_txdone_entry(entry, reg, rt2800_drv_get_txwi(entry), match);\n\t}\n}\nEXPORT_SYMBOL_GPL(rt2800_txdone);\n\nstatic inline bool rt2800_entry_txstatus_timeout(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t\t struct queue_entry *entry)\n{\n\tbool ret;\n\tunsigned long tout;\n\n\tif (!test_bit(ENTRY_DATA_STATUS_PENDING, &entry->flags))\n\t\treturn false;\n\n\tif (test_bit(DEVICE_STATE_FLUSHING, &rt2x00dev->flags))\n\t\ttout = msecs_to_jiffies(50);\n\telse\n\t\ttout = msecs_to_jiffies(2000);\n\n\tret = time_after(jiffies, entry->last_action + tout);\n\tif (unlikely(ret))\n\t\trt2x00_dbg(entry->queue->rt2x00dev,\n\t\t\t   \"TX status timeout for entry %d in queue %d\\n\",\n\t\t\t   entry->entry_idx, entry->queue->qid);\n\treturn ret;\n}\n\nbool rt2800_txstatus_timeout(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct data_queue *queue;\n\tstruct queue_entry *entry;\n\n\ttx_queue_for_each(rt2x00dev, queue) {\n\t\tentry = rt2x00queue_get_entry(queue, Q_INDEX_DONE);\n\t\tif (rt2800_entry_txstatus_timeout(rt2x00dev, entry))\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\nEXPORT_SYMBOL_GPL(rt2800_txstatus_timeout);\n\n \nbool rt2800_txstatus_pending(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct data_queue *queue;\n\n\ttx_queue_for_each(rt2x00dev, queue) {\n\t\tif (rt2x00queue_get_entry(queue, Q_INDEX_DMA_DONE) !=\n\t\t    rt2x00queue_get_entry(queue, Q_INDEX_DONE))\n\t\t\treturn true;\n\t}\n\treturn false;\n}\nEXPORT_SYMBOL_GPL(rt2800_txstatus_pending);\n\nvoid rt2800_txdone_nostatus(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct data_queue *queue;\n\tstruct queue_entry *entry;\n\n\t \n\ttx_queue_for_each(rt2x00dev, queue) {\n\t\twhile (!rt2x00queue_empty(queue)) {\n\t\t\tentry = rt2x00queue_get_entry(queue, Q_INDEX_DONE);\n\n\t\t\tif (test_bit(ENTRY_OWNER_DEVICE_DATA, &entry->flags) ||\n\t\t\t    !test_bit(ENTRY_DATA_STATUS_PENDING, &entry->flags))\n\t\t\t\tbreak;\n\n\t\t\tif (test_bit(ENTRY_DATA_IO_FAILED, &entry->flags) ||\n\t\t\t    rt2800_entry_txstatus_timeout(rt2x00dev, entry))\n\t\t\t\trt2x00lib_txdone_noinfo(entry, TXDONE_FAILURE);\n\t\t\telse\n\t\t\t\tbreak;\n\t\t}\n\t}\n}\nEXPORT_SYMBOL_GPL(rt2800_txdone_nostatus);\n\nstatic int rt2800_check_hung(struct data_queue *queue)\n{\n\tunsigned int cur_idx = rt2800_drv_get_dma_done(queue);\n\n\tif (queue->wd_idx != cur_idx)\n\t\tqueue->wd_count = 0;\n\telse\n\t\tqueue->wd_count++;\n\n\treturn queue->wd_count > 16;\n}\n\nstatic void rt2800_update_survey(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct ieee80211_channel *chan = rt2x00dev->hw->conf.chandef.chan;\n\tstruct rt2x00_chan_survey *chan_survey =\n\t\t   &rt2x00dev->chan_survey[chan->hw_value];\n\n\tchan_survey->time_idle += rt2800_register_read(rt2x00dev, CH_IDLE_STA);\n\tchan_survey->time_busy += rt2800_register_read(rt2x00dev, CH_BUSY_STA);\n\tchan_survey->time_ext_busy += rt2800_register_read(rt2x00dev, CH_BUSY_STA_SEC);\n}\n\nvoid rt2800_watchdog(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct data_queue *queue;\n\tbool hung_tx = false;\n\tbool hung_rx = false;\n\n\tif (test_bit(DEVICE_STATE_SCANNING, &rt2x00dev->flags))\n\t\treturn;\n\n\trt2800_update_survey(rt2x00dev);\n\n\tqueue_for_each(rt2x00dev, queue) {\n\t\tswitch (queue->qid) {\n\t\tcase QID_AC_VO:\n\t\tcase QID_AC_VI:\n\t\tcase QID_AC_BE:\n\t\tcase QID_AC_BK:\n\t\tcase QID_MGMT:\n\t\t\tif (rt2x00queue_empty(queue))\n\t\t\t\tcontinue;\n\t\t\thung_tx = rt2800_check_hung(queue);\n\t\t\tbreak;\n\t\tcase QID_RX:\n\t\t\t \n\t\t\tif (rt2x00dev->intf_sta_count == 0)\n\t\t\t\tcontinue;\n\t\t\thung_rx = rt2800_check_hung(queue);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (hung_tx)\n\t\trt2x00_warn(rt2x00dev, \"Watchdog TX hung detected\\n\");\n\n\tif (hung_rx)\n\t\trt2x00_warn(rt2x00dev, \"Watchdog RX hung detected\\n\");\n\n\tif (hung_tx || hung_rx)\n\t\tieee80211_restart_hw(rt2x00dev->hw);\n}\nEXPORT_SYMBOL_GPL(rt2800_watchdog);\n\nstatic unsigned int rt2800_hw_beacon_base(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t  unsigned int index)\n{\n\treturn HW_BEACON_BASE(index);\n}\n\nstatic inline u8 rt2800_get_beacon_offset(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t  unsigned int index)\n{\n\treturn BEACON_BASE_TO_OFFSET(rt2800_hw_beacon_base(rt2x00dev, index));\n}\n\nstatic void rt2800_update_beacons_setup(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct data_queue *queue = rt2x00dev->bcn;\n\tstruct queue_entry *entry;\n\tint i, bcn_num = 0;\n\tu64 off, reg = 0;\n\tu32 bssid_dw1;\n\n\t \n\tfor (i = 0; i < queue->limit; i++) {\n\t\tentry = &queue->entries[i];\n\t\tif (!test_bit(ENTRY_BCN_ENABLED, &entry->flags))\n\t\t\tcontinue;\n\t\toff = rt2800_get_beacon_offset(rt2x00dev, entry->entry_idx);\n\t\treg |= off << (8 * bcn_num);\n\t\tbcn_num++;\n\t}\n\n\trt2800_register_write(rt2x00dev, BCN_OFFSET0, (u32) reg);\n\trt2800_register_write(rt2x00dev, BCN_OFFSET1, (u32) (reg >> 32));\n\n\t \n\tbssid_dw1 = rt2800_register_read(rt2x00dev, MAC_BSSID_DW1);\n\trt2x00_set_field32(&bssid_dw1, MAC_BSSID_DW1_BSS_BCN_NUM,\n\t\t\t   bcn_num > 0 ? bcn_num - 1 : 0);\n\trt2800_register_write(rt2x00dev, MAC_BSSID_DW1, bssid_dw1);\n}\n\nvoid rt2800_write_beacon(struct queue_entry *entry, struct txentry_desc *txdesc)\n{\n\tstruct rt2x00_dev *rt2x00dev = entry->queue->rt2x00dev;\n\tstruct skb_frame_desc *skbdesc = get_skb_frame_desc(entry->skb);\n\tunsigned int beacon_base;\n\tunsigned int padding_len;\n\tu32 orig_reg, reg;\n\tconst int txwi_desc_size = entry->queue->winfo_size;\n\n\t \n\treg = rt2800_register_read(rt2x00dev, BCN_TIME_CFG);\n\torig_reg = reg;\n\trt2x00_set_field32(&reg, BCN_TIME_CFG_BEACON_GEN, 0);\n\trt2800_register_write(rt2x00dev, BCN_TIME_CFG, reg);\n\n\t \n\tmemset(skb_push(entry->skb, txwi_desc_size), 0, txwi_desc_size);\n\n\t \n\tskbdesc->flags |= SKBDESC_DESC_IN_SKB;\n\tskbdesc->desc = entry->skb->data;\n\tskbdesc->desc_len = txwi_desc_size;\n\n\t \n\trt2800_write_tx_data(entry, txdesc);\n\n\t \n\trt2x00debug_dump_frame(rt2x00dev, DUMP_FRAME_BEACON, entry);\n\n\t \n\tpadding_len = roundup(entry->skb->len, 4) - entry->skb->len;\n\tif (padding_len && skb_pad(entry->skb, padding_len)) {\n\t\trt2x00_err(rt2x00dev, \"Failure padding beacon, aborting\\n\");\n\t\t \n\t\tentry->skb = NULL;\n\t\trt2800_register_write(rt2x00dev, BCN_TIME_CFG, orig_reg);\n\t\treturn;\n\t}\n\n\tbeacon_base = rt2800_hw_beacon_base(rt2x00dev, entry->entry_idx);\n\n\trt2800_register_multiwrite(rt2x00dev, beacon_base, entry->skb->data,\n\t\t\t\t   entry->skb->len + padding_len);\n\t__set_bit(ENTRY_BCN_ENABLED, &entry->flags);\n\n\t \n\trt2800_update_beacons_setup(rt2x00dev);\n\n\t \n\trt2800_register_write(rt2x00dev, BCN_TIME_CFG, orig_reg);\n\n\t \n\tdev_kfree_skb_any(entry->skb);\n\tentry->skb = NULL;\n}\nEXPORT_SYMBOL_GPL(rt2800_write_beacon);\n\nstatic inline void rt2800_clear_beacon_register(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t\tunsigned int index)\n{\n\tint i;\n\tconst int txwi_desc_size = rt2x00dev->bcn->winfo_size;\n\tunsigned int beacon_base;\n\n\tbeacon_base = rt2800_hw_beacon_base(rt2x00dev, index);\n\n\t \n\tfor (i = 0; i < txwi_desc_size; i += sizeof(__le32))\n\t\trt2800_register_write(rt2x00dev, beacon_base + i, 0);\n}\n\nvoid rt2800_clear_beacon(struct queue_entry *entry)\n{\n\tstruct rt2x00_dev *rt2x00dev = entry->queue->rt2x00dev;\n\tu32 orig_reg, reg;\n\n\t \n\torig_reg = rt2800_register_read(rt2x00dev, BCN_TIME_CFG);\n\treg = orig_reg;\n\trt2x00_set_field32(&reg, BCN_TIME_CFG_BEACON_GEN, 0);\n\trt2800_register_write(rt2x00dev, BCN_TIME_CFG, reg);\n\n\t \n\trt2800_clear_beacon_register(rt2x00dev, entry->entry_idx);\n\t__clear_bit(ENTRY_BCN_ENABLED, &entry->flags);\n\n\t \n\trt2800_update_beacons_setup(rt2x00dev);\n\t \n\trt2800_register_write(rt2x00dev, BCN_TIME_CFG, orig_reg);\n}\nEXPORT_SYMBOL_GPL(rt2800_clear_beacon);\n\n#ifdef CONFIG_RT2X00_LIB_DEBUGFS\nconst struct rt2x00debug rt2800_rt2x00debug = {\n\t.owner\t= THIS_MODULE,\n\t.csr\t= {\n\t\t.read\t\t= rt2800_register_read,\n\t\t.write\t\t= rt2800_register_write,\n\t\t.flags\t\t= RT2X00DEBUGFS_OFFSET,\n\t\t.word_base\t= CSR_REG_BASE,\n\t\t.word_size\t= sizeof(u32),\n\t\t.word_count\t= CSR_REG_SIZE / sizeof(u32),\n\t},\n\t.eeprom\t= {\n\t\t \n\t\t.read\t\t= rt2x00_eeprom_read,\n\t\t.write\t\t= rt2x00_eeprom_write,\n\t\t.word_base\t= EEPROM_BASE,\n\t\t.word_size\t= sizeof(u16),\n\t\t.word_count\t= EEPROM_SIZE / sizeof(u16),\n\t},\n\t.bbp\t= {\n\t\t.read\t\t= rt2800_bbp_read,\n\t\t.write\t\t= rt2800_bbp_write,\n\t\t.word_base\t= BBP_BASE,\n\t\t.word_size\t= sizeof(u8),\n\t\t.word_count\t= BBP_SIZE / sizeof(u8),\n\t},\n\t.rf\t= {\n\t\t.read\t\t= rt2x00_rf_read,\n\t\t.write\t\t= rt2800_rf_write,\n\t\t.word_base\t= RF_BASE,\n\t\t.word_size\t= sizeof(u32),\n\t\t.word_count\t= RF_SIZE / sizeof(u32),\n\t},\n\t.rfcsr\t= {\n\t\t.read\t\t= rt2800_rfcsr_read,\n\t\t.write\t\t= rt2800_rfcsr_write,\n\t\t.word_base\t= RFCSR_BASE,\n\t\t.word_size\t= sizeof(u8),\n\t\t.word_count\t= RFCSR_SIZE / sizeof(u8),\n\t},\n};\nEXPORT_SYMBOL_GPL(rt2800_rt2x00debug);\n#endif  \n\nint rt2800_rfkill_poll(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 reg;\n\n\tif (rt2x00_rt(rt2x00dev, RT3290)) {\n\t\treg = rt2800_register_read(rt2x00dev, WLAN_FUN_CTRL);\n\t\treturn rt2x00_get_field32(reg, WLAN_GPIO_IN_BIT0);\n\t} else {\n\t\treg = rt2800_register_read(rt2x00dev, GPIO_CTRL);\n\t\treturn rt2x00_get_field32(reg, GPIO_CTRL_VAL2);\n\t}\n}\nEXPORT_SYMBOL_GPL(rt2800_rfkill_poll);\n\n#ifdef CONFIG_RT2X00_LIB_LEDS\nstatic void rt2800_brightness_set(struct led_classdev *led_cdev,\n\t\t\t\t  enum led_brightness brightness)\n{\n\tstruct rt2x00_led *led =\n\t    container_of(led_cdev, struct rt2x00_led, led_dev);\n\tunsigned int enabled = brightness != LED_OFF;\n\tunsigned int bg_mode =\n\t    (enabled && led->rt2x00dev->curr_band == NL80211_BAND_2GHZ);\n\tunsigned int polarity =\n\t\trt2x00_get_field16(led->rt2x00dev->led_mcu_reg,\n\t\t\t\t   EEPROM_FREQ_LED_POLARITY);\n\tunsigned int ledmode =\n\t\trt2x00_get_field16(led->rt2x00dev->led_mcu_reg,\n\t\t\t\t   EEPROM_FREQ_LED_MODE);\n\tu32 reg;\n\n\t \n\tif (rt2x00_is_soc(led->rt2x00dev)) {\n\t\treg = rt2800_register_read(led->rt2x00dev, LED_CFG);\n\n\t\t \n\t\trt2x00_set_field32(&reg, LED_CFG_LED_POLAR, polarity);\n\n\t\t \n\t\tif (led->type == LED_TYPE_RADIO) {\n\t\t\trt2x00_set_field32(&reg, LED_CFG_G_LED_MODE,\n\t\t\t\t\t   enabled ? 3 : 0);\n\t\t} else if (led->type == LED_TYPE_ASSOC) {\n\t\t\trt2x00_set_field32(&reg, LED_CFG_Y_LED_MODE,\n\t\t\t\t\t   enabled ? 3 : 0);\n\t\t} else if (led->type == LED_TYPE_QUALITY) {\n\t\t\trt2x00_set_field32(&reg, LED_CFG_R_LED_MODE,\n\t\t\t\t\t   enabled ? 3 : 0);\n\t\t}\n\n\t\trt2800_register_write(led->rt2x00dev, LED_CFG, reg);\n\n\t} else {\n\t\tif (led->type == LED_TYPE_RADIO) {\n\t\t\trt2800_mcu_request(led->rt2x00dev, MCU_LED, 0xff, ledmode,\n\t\t\t\t\t      enabled ? 0x20 : 0);\n\t\t} else if (led->type == LED_TYPE_ASSOC) {\n\t\t\trt2800_mcu_request(led->rt2x00dev, MCU_LED, 0xff, ledmode,\n\t\t\t\t\t      enabled ? (bg_mode ? 0x60 : 0xa0) : 0x20);\n\t\t} else if (led->type == LED_TYPE_QUALITY) {\n\t\t\t \n\t\t\trt2800_mcu_request(led->rt2x00dev, MCU_LED_STRENGTH, 0xff,\n\t\t\t\t\t      (1 << brightness / (LED_FULL / 6)) - 1,\n\t\t\t\t\t      polarity);\n\t\t}\n\t}\n}\n\nstatic void rt2800_init_led(struct rt2x00_dev *rt2x00dev,\n\t\t     struct rt2x00_led *led, enum led_type type)\n{\n\tled->rt2x00dev = rt2x00dev;\n\tled->type = type;\n\tled->led_dev.brightness_set = rt2800_brightness_set;\n\tled->flags = LED_INITIALIZED;\n}\n#endif  \n\n \nstatic void rt2800_config_wcid(struct rt2x00_dev *rt2x00dev,\n\t\t\t       const u8 *address,\n\t\t\t       int wcid)\n{\n\tstruct mac_wcid_entry wcid_entry;\n\tu32 offset;\n\n\toffset = MAC_WCID_ENTRY(wcid);\n\n\tmemset(&wcid_entry, 0xff, sizeof(wcid_entry));\n\tif (address)\n\t\tmemcpy(wcid_entry.mac, address, ETH_ALEN);\n\n\trt2800_register_multiwrite(rt2x00dev, offset,\n\t\t\t\t      &wcid_entry, sizeof(wcid_entry));\n}\n\nstatic void rt2800_delete_wcid_attr(struct rt2x00_dev *rt2x00dev, int wcid)\n{\n\tu32 offset;\n\toffset = MAC_WCID_ATTR_ENTRY(wcid);\n\trt2800_register_write(rt2x00dev, offset, 0);\n}\n\nstatic void rt2800_config_wcid_attr_bssidx(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t   int wcid, u32 bssidx)\n{\n\tu32 offset = MAC_WCID_ATTR_ENTRY(wcid);\n\tu32 reg;\n\n\t \n\treg = rt2800_register_read(rt2x00dev, offset);\n\trt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_BSS_IDX, (bssidx & 0x7));\n\trt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_BSS_IDX_EXT,\n\t\t\t   (bssidx & 0x8) >> 3);\n\trt2800_register_write(rt2x00dev, offset, reg);\n}\n\nstatic void rt2800_config_wcid_attr_cipher(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t   struct rt2x00lib_crypto *crypto,\n\t\t\t\t\t   struct ieee80211_key_conf *key)\n{\n\tstruct mac_iveiv_entry iveiv_entry;\n\tu32 offset;\n\tu32 reg;\n\n\toffset = MAC_WCID_ATTR_ENTRY(key->hw_key_idx);\n\n\tif (crypto->cmd == SET_KEY) {\n\t\treg = rt2800_register_read(rt2x00dev, offset);\n\t\trt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_KEYTAB,\n\t\t\t\t   !!(key->flags & IEEE80211_KEY_FLAG_PAIRWISE));\n\t\t \n\t\trt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER,\n\t\t\t\t   (crypto->cipher & 0x7));\n\t\trt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER_EXT,\n\t\t\t\t   (crypto->cipher & 0x8) >> 3);\n\t\trt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_RX_WIUDF, crypto->cipher);\n\t\trt2800_register_write(rt2x00dev, offset, reg);\n\t} else {\n\t\t \n\t\treg = rt2800_register_read(rt2x00dev, offset);\n\t\trt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_KEYTAB, 0);\n\t\trt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER, 0);\n\t\trt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER_EXT, 0);\n\t\trt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_RX_WIUDF, 0);\n\t\trt2800_register_write(rt2x00dev, offset, reg);\n\t}\n\n\tif (test_bit(DEVICE_STATE_RESET, &rt2x00dev->flags))\n\t\treturn;\n\n\toffset = MAC_IVEIV_ENTRY(key->hw_key_idx);\n\n\tmemset(&iveiv_entry, 0, sizeof(iveiv_entry));\n\tif ((crypto->cipher == CIPHER_TKIP) ||\n\t    (crypto->cipher == CIPHER_TKIP_NO_MIC) ||\n\t    (crypto->cipher == CIPHER_AES))\n\t\tiveiv_entry.iv[3] |= 0x20;\n\tiveiv_entry.iv[3] |= key->keyidx << 6;\n\trt2800_register_multiwrite(rt2x00dev, offset,\n\t\t\t\t   &iveiv_entry, sizeof(iveiv_entry));\n}\n\nint rt2800_config_shared_key(struct rt2x00_dev *rt2x00dev,\n\t\t\t     struct rt2x00lib_crypto *crypto,\n\t\t\t     struct ieee80211_key_conf *key)\n{\n\tstruct hw_key_entry key_entry;\n\tstruct rt2x00_field32 field;\n\tu32 offset;\n\tu32 reg;\n\n\tif (crypto->cmd == SET_KEY) {\n\t\tkey->hw_key_idx = (4 * crypto->bssidx) + key->keyidx;\n\n\t\tmemcpy(key_entry.key, crypto->key,\n\t\t       sizeof(key_entry.key));\n\t\tmemcpy(key_entry.tx_mic, crypto->tx_mic,\n\t\t       sizeof(key_entry.tx_mic));\n\t\tmemcpy(key_entry.rx_mic, crypto->rx_mic,\n\t\t       sizeof(key_entry.rx_mic));\n\n\t\toffset = SHARED_KEY_ENTRY(key->hw_key_idx);\n\t\trt2800_register_multiwrite(rt2x00dev, offset,\n\t\t\t\t\t      &key_entry, sizeof(key_entry));\n\t}\n\n\t \n\tfield.bit_offset = 4 * (key->hw_key_idx % 8);\n\tfield.bit_mask = 0x7 << field.bit_offset;\n\n\toffset = SHARED_KEY_MODE_ENTRY(key->hw_key_idx / 8);\n\n\treg = rt2800_register_read(rt2x00dev, offset);\n\trt2x00_set_field32(&reg, field,\n\t\t\t   (crypto->cmd == SET_KEY) * crypto->cipher);\n\trt2800_register_write(rt2x00dev, offset, reg);\n\n\t \n\trt2800_config_wcid(rt2x00dev, crypto->address, key->hw_key_idx);\n\trt2800_config_wcid_attr_bssidx(rt2x00dev, key->hw_key_idx,\n\t\t\t\t       crypto->bssidx);\n\trt2800_config_wcid_attr_cipher(rt2x00dev, crypto, key);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rt2800_config_shared_key);\n\nint rt2800_config_pairwise_key(struct rt2x00_dev *rt2x00dev,\n\t\t\t       struct rt2x00lib_crypto *crypto,\n\t\t\t       struct ieee80211_key_conf *key)\n{\n\tstruct hw_key_entry key_entry;\n\tu32 offset;\n\n\tif (crypto->cmd == SET_KEY) {\n\t\t \n\t\tif (crypto->wcid > WCID_END)\n\t\t\treturn -ENOSPC;\n\t\tkey->hw_key_idx = crypto->wcid;\n\n\t\tmemcpy(key_entry.key, crypto->key,\n\t\t       sizeof(key_entry.key));\n\t\tmemcpy(key_entry.tx_mic, crypto->tx_mic,\n\t\t       sizeof(key_entry.tx_mic));\n\t\tmemcpy(key_entry.rx_mic, crypto->rx_mic,\n\t\t       sizeof(key_entry.rx_mic));\n\n\t\toffset = PAIRWISE_KEY_ENTRY(key->hw_key_idx);\n\t\trt2800_register_multiwrite(rt2x00dev, offset,\n\t\t\t\t\t      &key_entry, sizeof(key_entry));\n\t}\n\n\t \n\trt2800_config_wcid_attr_cipher(rt2x00dev, crypto, key);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rt2800_config_pairwise_key);\n\nstatic void rt2800_set_max_psdu_len(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 i, max_psdu;\n\tu32 reg;\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\n\tfor (i = 0; i < 3; i++)\n\t\tif (drv_data->ampdu_factor_cnt[i] > 0)\n\t\t\tbreak;\n\n\tmax_psdu = min(drv_data->max_psdu, i);\n\n\treg = rt2800_register_read(rt2x00dev, MAX_LEN_CFG);\n\trt2x00_set_field32(&reg, MAX_LEN_CFG_MAX_PSDU, max_psdu);\n\trt2800_register_write(rt2x00dev, MAX_LEN_CFG, reg);\n}\n\nint rt2800_sta_add(struct ieee80211_hw *hw, struct ieee80211_vif *vif,\n\t\t   struct ieee80211_sta *sta)\n{\n\tstruct rt2x00_dev *rt2x00dev = hw->priv;\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tstruct rt2x00_sta *sta_priv = sta_to_rt2x00_sta(sta);\n\tint wcid;\n\n\t \n\tif (sta->deflink.ht_cap.ht_supported) {\n\t\tdrv_data->ampdu_factor_cnt[sta->deflink.ht_cap.ampdu_factor & 3]++;\n\t\trt2800_set_max_psdu_len(rt2x00dev);\n\t}\n\n\t \n\twcid = find_first_zero_bit(drv_data->sta_ids, STA_IDS_SIZE) + WCID_START;\n\n\t \n\tsta_priv->wcid = wcid;\n\n\t \n\tif (wcid > WCID_END)\n\t\treturn 0;\n\n\t__set_bit(wcid - WCID_START, drv_data->sta_ids);\n\tdrv_data->wcid_to_sta[wcid - WCID_START] = sta;\n\n\t \n\trt2800_delete_wcid_attr(rt2x00dev, wcid);\n\trt2800_config_wcid(rt2x00dev, sta->addr, wcid);\n\trt2800_config_wcid_attr_bssidx(rt2x00dev, wcid,\n\t\t\t\t       rt2x00lib_get_bssidx(rt2x00dev, vif));\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rt2800_sta_add);\n\nint rt2800_sta_remove(struct ieee80211_hw *hw, struct ieee80211_vif *vif,\n\t\t      struct ieee80211_sta *sta)\n{\n\tstruct rt2x00_dev *rt2x00dev = hw->priv;\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tstruct rt2x00_sta *sta_priv = sta_to_rt2x00_sta(sta);\n\tint wcid = sta_priv->wcid;\n\n\tif (sta->deflink.ht_cap.ht_supported) {\n\t\tdrv_data->ampdu_factor_cnt[sta->deflink.ht_cap.ampdu_factor & 3]--;\n\t\trt2800_set_max_psdu_len(rt2x00dev);\n\t}\n\n\tif (wcid > WCID_END)\n\t\treturn 0;\n\t \n\trt2800_config_wcid(rt2x00dev, NULL, wcid);\n\tdrv_data->wcid_to_sta[wcid - WCID_START] = NULL;\n\t__clear_bit(wcid - WCID_START, drv_data->sta_ids);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rt2800_sta_remove);\n\nvoid rt2800_pre_reset_hw(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tstruct data_queue *queue = rt2x00dev->bcn;\n\tstruct queue_entry *entry;\n\tint i, wcid;\n\n\tfor (wcid = WCID_START; wcid < WCID_END; wcid++) {\n\t\tdrv_data->wcid_to_sta[wcid - WCID_START] = NULL;\n\t\t__clear_bit(wcid - WCID_START, drv_data->sta_ids);\n\t}\n\n\tfor (i = 0; i < queue->limit; i++) {\n\t\tentry = &queue->entries[i];\n\t\tclear_bit(ENTRY_BCN_ASSIGNED, &entry->flags);\n\t}\n}\nEXPORT_SYMBOL_GPL(rt2800_pre_reset_hw);\n\nvoid rt2800_config_filter(struct rt2x00_dev *rt2x00dev,\n\t\t\t  const unsigned int filter_flags)\n{\n\tu32 reg;\n\n\t \n\treg = rt2800_register_read(rt2x00dev, RX_FILTER_CFG);\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_CRC_ERROR,\n\t\t\t   !(filter_flags & FIF_FCSFAIL));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_PHY_ERROR,\n\t\t\t   !(filter_flags & FIF_PLCPFAIL));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_NOT_TO_ME,\n\t\t\t   !test_bit(CONFIG_MONITORING, &rt2x00dev->flags));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_NOT_MY_BSSD, 0);\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_VER_ERROR, 1);\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_MULTICAST,\n\t\t\t   !(filter_flags & FIF_ALLMULTI));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_BROADCAST, 0);\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_DUPLICATE, 1);\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_CF_END_ACK,\n\t\t\t   !(filter_flags & FIF_CONTROL));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_CF_END,\n\t\t\t   !(filter_flags & FIF_CONTROL));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_ACK,\n\t\t\t   !(filter_flags & FIF_CONTROL));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_CTS,\n\t\t\t   !(filter_flags & FIF_CONTROL));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_RTS,\n\t\t\t   !(filter_flags & FIF_CONTROL));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_PSPOLL,\n\t\t\t   !(filter_flags & FIF_PSPOLL));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_BA, 0);\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_BAR,\n\t\t\t   !(filter_flags & FIF_CONTROL));\n\trt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_CNTL,\n\t\t\t   !(filter_flags & FIF_CONTROL));\n\trt2800_register_write(rt2x00dev, RX_FILTER_CFG, reg);\n}\nEXPORT_SYMBOL_GPL(rt2800_config_filter);\n\nvoid rt2800_config_intf(struct rt2x00_dev *rt2x00dev, struct rt2x00_intf *intf,\n\t\t\tstruct rt2x00intf_conf *conf, const unsigned int flags)\n{\n\tu32 reg;\n\tbool update_bssid = false;\n\n\tif (flags & CONFIG_UPDATE_TYPE) {\n\t\t \n\t\treg = rt2800_register_read(rt2x00dev, BCN_TIME_CFG);\n\t\trt2x00_set_field32(&reg, BCN_TIME_CFG_TSF_SYNC, conf->sync);\n\t\trt2800_register_write(rt2x00dev, BCN_TIME_CFG, reg);\n\n\t\tif (conf->sync == TSF_SYNC_AP_NONE) {\n\t\t\t \n\t\t\treg = rt2800_register_read(rt2x00dev, TBTT_SYNC_CFG);\n\t\t\trt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_CWMIN, 0);\n\t\t\trt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_AIFSN, 1);\n\t\t\trt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_EXP_WIN, 32);\n\t\t\trt2x00_set_field32(&reg, TBTT_SYNC_CFG_TBTT_ADJUST, 0);\n\t\t\trt2800_register_write(rt2x00dev, TBTT_SYNC_CFG, reg);\n\t\t} else {\n\t\t\treg = rt2800_register_read(rt2x00dev, TBTT_SYNC_CFG);\n\t\t\trt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_CWMIN, 4);\n\t\t\trt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_AIFSN, 2);\n\t\t\trt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_EXP_WIN, 32);\n\t\t\trt2x00_set_field32(&reg, TBTT_SYNC_CFG_TBTT_ADJUST, 16);\n\t\t\trt2800_register_write(rt2x00dev, TBTT_SYNC_CFG, reg);\n\t\t}\n\t}\n\n\tif (flags & CONFIG_UPDATE_MAC) {\n\t\tif (flags & CONFIG_UPDATE_TYPE &&\n\t\t    conf->sync == TSF_SYNC_AP_NONE) {\n\t\t\t \n\t\t\tmemcpy(conf->bssid, conf->mac, sizeof(conf->mac));\n\t\t\tupdate_bssid = true;\n\t\t}\n\n\t\tif (!is_zero_ether_addr((const u8 *)conf->mac)) {\n\t\t\treg = le32_to_cpu(conf->mac[1]);\n\t\t\trt2x00_set_field32(&reg, MAC_ADDR_DW1_UNICAST_TO_ME_MASK, 0xff);\n\t\t\tconf->mac[1] = cpu_to_le32(reg);\n\t\t}\n\n\t\trt2800_register_multiwrite(rt2x00dev, MAC_ADDR_DW0,\n\t\t\t\t\t      conf->mac, sizeof(conf->mac));\n\t}\n\n\tif ((flags & CONFIG_UPDATE_BSSID) || update_bssid) {\n\t\tif (!is_zero_ether_addr((const u8 *)conf->bssid)) {\n\t\t\treg = le32_to_cpu(conf->bssid[1]);\n\t\t\trt2x00_set_field32(&reg, MAC_BSSID_DW1_BSS_ID_MASK, 3);\n\t\t\trt2x00_set_field32(&reg, MAC_BSSID_DW1_BSS_BCN_NUM, 0);\n\t\t\tconf->bssid[1] = cpu_to_le32(reg);\n\t\t}\n\n\t\trt2800_register_multiwrite(rt2x00dev, MAC_BSSID_DW0,\n\t\t\t\t\t      conf->bssid, sizeof(conf->bssid));\n\t}\n}\nEXPORT_SYMBOL_GPL(rt2800_config_intf);\n\nstatic void rt2800_config_ht_opmode(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t    struct rt2x00lib_erp *erp)\n{\n\tbool any_sta_nongf = !!(erp->ht_opmode &\n\t\t\t\tIEEE80211_HT_OP_MODE_NON_GF_STA_PRSNT);\n\tu8 protection = erp->ht_opmode & IEEE80211_HT_OP_MODE_PROTECTION;\n\tu8 mm20_mode, mm40_mode, gf20_mode, gf40_mode;\n\tu16 mm20_rate, mm40_rate, gf20_rate, gf40_rate;\n\tu32 reg;\n\n\t \n\tmm20_rate = gf20_rate = 0x4004;\n\n\t \n\tmm40_rate = gf40_rate = 0x4084;\n\n\tswitch (protection) {\n\tcase IEEE80211_HT_OP_MODE_PROTECTION_NONE:\n\t\t \n\t\tmm20_mode = mm40_mode = gf20_mode = gf40_mode = 0;\n\n\t\tbreak;\n\tcase IEEE80211_HT_OP_MODE_PROTECTION_20MHZ:\n\t\t \n\t\tmm20_mode = gf20_mode = 0;\n\t\tmm40_mode = gf40_mode = 1;\n\n\t\tbreak;\n\tcase IEEE80211_HT_OP_MODE_PROTECTION_NONMEMBER:\n\t\t \n\tcase IEEE80211_HT_OP_MODE_PROTECTION_NONHT_MIXED:\n\t\t \n\t\tmm20_mode = mm40_mode = gf20_mode = gf40_mode = 1;\n\n\t\t \n\t\tif (erp->cts_protection) {\n\t\t\t \n\t\t\tmm20_rate = mm40_rate = 0x0003;\n\t\t\tgf20_rate = gf40_rate = 0x0003;\n\t\t}\n\t\tbreak;\n\t}\n\n\t \n\tif (any_sta_nongf)\n\t\tgf20_mode = gf40_mode = 1;\n\n\t \n\treg = rt2800_register_read(rt2x00dev, MM20_PROT_CFG);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_PROTECT_RATE, mm20_rate);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_PROTECT_CTRL, mm20_mode);\n\trt2800_register_write(rt2x00dev, MM20_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, MM40_PROT_CFG);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_PROTECT_RATE, mm40_rate);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_PROTECT_CTRL, mm40_mode);\n\trt2800_register_write(rt2x00dev, MM40_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, GF20_PROT_CFG);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_PROTECT_RATE, gf20_rate);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_PROTECT_CTRL, gf20_mode);\n\trt2800_register_write(rt2x00dev, GF20_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, GF40_PROT_CFG);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_PROTECT_RATE, gf40_rate);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_PROTECT_CTRL, gf40_mode);\n\trt2800_register_write(rt2x00dev, GF40_PROT_CFG, reg);\n}\n\nvoid rt2800_config_erp(struct rt2x00_dev *rt2x00dev, struct rt2x00lib_erp *erp,\n\t\t       u32 changed)\n{\n\tu32 reg;\n\n\tif (changed & BSS_CHANGED_ERP_PREAMBLE) {\n\t\treg = rt2800_register_read(rt2x00dev, AUTO_RSP_CFG);\n\t\trt2x00_set_field32(&reg, AUTO_RSP_CFG_AR_PREAMBLE,\n\t\t\t\t   !!erp->short_preamble);\n\t\trt2800_register_write(rt2x00dev, AUTO_RSP_CFG, reg);\n\t}\n\n\tif (changed & BSS_CHANGED_ERP_CTS_PROT) {\n\t\treg = rt2800_register_read(rt2x00dev, OFDM_PROT_CFG);\n\t\trt2x00_set_field32(&reg, OFDM_PROT_CFG_PROTECT_CTRL,\n\t\t\t\t   erp->cts_protection ? 2 : 0);\n\t\trt2800_register_write(rt2x00dev, OFDM_PROT_CFG, reg);\n\t}\n\n\tif (changed & BSS_CHANGED_BASIC_RATES) {\n\t\trt2800_register_write(rt2x00dev, LEGACY_BASIC_RATE,\n\t\t\t\t      0xff0 | erp->basic_rates);\n\t\trt2800_register_write(rt2x00dev, HT_BASIC_RATE, 0x00008003);\n\t}\n\n\tif (changed & BSS_CHANGED_ERP_SLOT) {\n\t\treg = rt2800_register_read(rt2x00dev, BKOFF_SLOT_CFG);\n\t\trt2x00_set_field32(&reg, BKOFF_SLOT_CFG_SLOT_TIME,\n\t\t\t\t   erp->slot_time);\n\t\trt2800_register_write(rt2x00dev, BKOFF_SLOT_CFG, reg);\n\n\t\treg = rt2800_register_read(rt2x00dev, XIFS_TIME_CFG);\n\t\trt2x00_set_field32(&reg, XIFS_TIME_CFG_EIFS, erp->eifs);\n\t\trt2800_register_write(rt2x00dev, XIFS_TIME_CFG, reg);\n\t}\n\n\tif (changed & BSS_CHANGED_BEACON_INT) {\n\t\treg = rt2800_register_read(rt2x00dev, BCN_TIME_CFG);\n\t\trt2x00_set_field32(&reg, BCN_TIME_CFG_BEACON_INTERVAL,\n\t\t\t\t   erp->beacon_int * 16);\n\t\trt2800_register_write(rt2x00dev, BCN_TIME_CFG, reg);\n\t}\n\n\tif (changed & BSS_CHANGED_HT)\n\t\trt2800_config_ht_opmode(rt2x00dev, erp);\n}\nEXPORT_SYMBOL_GPL(rt2800_config_erp);\n\nstatic int rt2800_wait_bbp_rf_ready(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t    const struct rt2x00_field32 mask)\n{\n\tunsigned int i;\n\tu32 reg;\n\n\tfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\n\t\treg = rt2800_register_read(rt2x00dev, MAC_STATUS_CFG);\n\t\tif (!rt2x00_get_field32(reg, mask))\n\t\t\treturn 0;\n\n\t\tudelay(REGISTER_BUSY_DELAY);\n\t}\n\n\trt2x00_err(rt2x00dev, \"BBP/RF register access failed, aborting\\n\");\n\treturn -EACCES;\n}\n\nstatic int rt2800_wait_bbp_ready(struct rt2x00_dev *rt2x00dev)\n{\n\tunsigned int i;\n\tu8 value;\n\n\t \n\trt2800_register_write(rt2x00dev, H2M_BBP_AGENT, 0);\n\trt2800_register_write(rt2x00dev, H2M_MAILBOX_CSR, 0);\n\tmsleep(1);\n\n\tfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\n\t\tvalue = rt2800_bbp_read(rt2x00dev, 0);\n\t\tif ((value != 0xff) && (value != 0x00))\n\t\t\treturn 0;\n\t\tudelay(REGISTER_BUSY_DELAY);\n\t}\n\n\trt2x00_err(rt2x00dev, \"BBP register access failed, aborting\\n\");\n\treturn -EACCES;\n}\n\nstatic void rt2800_config_3572bt_ant(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 reg;\n\tu16 eeprom;\n\tu8 led_ctrl, led_g_mode, led_r_mode;\n\n\treg = rt2800_register_read(rt2x00dev, GPIO_SWITCH);\n\tif (rt2x00dev->curr_band == NL80211_BAND_5GHZ) {\n\t\trt2x00_set_field32(&reg, GPIO_SWITCH_0, 1);\n\t\trt2x00_set_field32(&reg, GPIO_SWITCH_1, 1);\n\t} else {\n\t\trt2x00_set_field32(&reg, GPIO_SWITCH_0, 0);\n\t\trt2x00_set_field32(&reg, GPIO_SWITCH_1, 0);\n\t}\n\trt2800_register_write(rt2x00dev, GPIO_SWITCH, reg);\n\n\treg = rt2800_register_read(rt2x00dev, LED_CFG);\n\tled_g_mode = rt2x00_get_field32(reg, LED_CFG_LED_POLAR) ? 3 : 0;\n\tled_r_mode = rt2x00_get_field32(reg, LED_CFG_LED_POLAR) ? 0 : 3;\n\tif (led_g_mode != rt2x00_get_field32(reg, LED_CFG_G_LED_MODE) ||\n\t    led_r_mode != rt2x00_get_field32(reg, LED_CFG_R_LED_MODE)) {\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_FREQ);\n\t\tled_ctrl = rt2x00_get_field16(eeprom, EEPROM_FREQ_LED_MODE);\n\t\tif (led_ctrl == 0 || led_ctrl > 0x40) {\n\t\t\trt2x00_set_field32(&reg, LED_CFG_G_LED_MODE, led_g_mode);\n\t\t\trt2x00_set_field32(&reg, LED_CFG_R_LED_MODE, led_r_mode);\n\t\t\trt2800_register_write(rt2x00dev, LED_CFG, reg);\n\t\t} else {\n\t\t\trt2800_mcu_request(rt2x00dev, MCU_BAND_SELECT, 0xff,\n\t\t\t\t\t   (led_g_mode << 2) | led_r_mode, 1);\n\t\t}\n\t}\n}\n\nstatic void rt2800_set_ant_diversity(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t     enum antenna ant)\n{\n\tu32 reg;\n\tu8 eesk_pin = (ant == ANTENNA_A) ? 1 : 0;\n\tu8 gpio_bit3 = (ant == ANTENNA_A) ? 0 : 1;\n\n\tif (rt2x00_is_pci(rt2x00dev)) {\n\t\treg = rt2800_register_read(rt2x00dev, E2PROM_CSR);\n\t\trt2x00_set_field32(&reg, E2PROM_CSR_DATA_CLOCK, eesk_pin);\n\t\trt2800_register_write(rt2x00dev, E2PROM_CSR, reg);\n\t} else if (rt2x00_is_usb(rt2x00dev))\n\t\trt2800_mcu_request(rt2x00dev, MCU_ANT_SELECT, 0xff,\n\t\t\t\t   eesk_pin, 0);\n\n\treg = rt2800_register_read(rt2x00dev, GPIO_CTRL);\n\trt2x00_set_field32(&reg, GPIO_CTRL_DIR3, 0);\n\trt2x00_set_field32(&reg, GPIO_CTRL_VAL3, gpio_bit3);\n\trt2800_register_write(rt2x00dev, GPIO_CTRL, reg);\n}\n\nvoid rt2800_config_ant(struct rt2x00_dev *rt2x00dev, struct antenna_setup *ant)\n{\n\tu8 r1;\n\tu8 r3;\n\tu16 eeprom;\n\n\tr1 = rt2800_bbp_read(rt2x00dev, 1);\n\tr3 = rt2800_bbp_read(rt2x00dev, 3);\n\n\tif (rt2x00_rt(rt2x00dev, RT3572) &&\n\t    rt2x00_has_cap_bt_coexist(rt2x00dev))\n\t\trt2800_config_3572bt_ant(rt2x00dev);\n\n\t \n\tswitch (ant->tx_chain_num) {\n\tcase 1:\n\t\trt2x00_set_field8(&r1, BBP1_TX_ANTENNA, 0);\n\t\tbreak;\n\tcase 2:\n\t\tif (rt2x00_rt(rt2x00dev, RT3572) &&\n\t\t    rt2x00_has_cap_bt_coexist(rt2x00dev))\n\t\t\trt2x00_set_field8(&r1, BBP1_TX_ANTENNA, 1);\n\t\telse\n\t\t\trt2x00_set_field8(&r1, BBP1_TX_ANTENNA, 2);\n\t\tbreak;\n\tcase 3:\n\t\trt2x00_set_field8(&r1, BBP1_TX_ANTENNA, 2);\n\t\tbreak;\n\t}\n\n\t \n\tswitch (ant->rx_chain_num) {\n\tcase 1:\n\t\tif (rt2x00_rt(rt2x00dev, RT3070) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3090) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3352) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3390)) {\n\t\t\teeprom = rt2800_eeprom_read(rt2x00dev,\n\t\t\t\t\t\t    EEPROM_NIC_CONF1);\n\t\t\tif (rt2x00_get_field16(eeprom,\n\t\t\t\t\t\tEEPROM_NIC_CONF1_ANT_DIVERSITY))\n\t\t\t\trt2800_set_ant_diversity(rt2x00dev,\n\t\t\t\t\t\trt2x00dev->default_ant.rx);\n\t\t}\n\t\trt2x00_set_field8(&r3, BBP3_RX_ANTENNA, 0);\n\t\tbreak;\n\tcase 2:\n\t\tif (rt2x00_rt(rt2x00dev, RT3572) &&\n\t\t    rt2x00_has_cap_bt_coexist(rt2x00dev)) {\n\t\t\trt2x00_set_field8(&r3, BBP3_RX_ADC, 1);\n\t\t\trt2x00_set_field8(&r3, BBP3_RX_ANTENNA,\n\t\t\t\trt2x00dev->curr_band == NL80211_BAND_5GHZ);\n\t\t\trt2800_set_ant_diversity(rt2x00dev, ANTENNA_B);\n\t\t} else {\n\t\t\trt2x00_set_field8(&r3, BBP3_RX_ANTENNA, 1);\n\t\t}\n\t\tbreak;\n\tcase 3:\n\t\trt2x00_set_field8(&r3, BBP3_RX_ANTENNA, 2);\n\t\tbreak;\n\t}\n\n\trt2800_bbp_write(rt2x00dev, 3, r3);\n\trt2800_bbp_write(rt2x00dev, 1, r1);\n\n\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t    rt2x00_rt(rt2x00dev, RT3883)) {\n\t\tif (ant->rx_chain_num == 1)\n\t\t\trt2800_bbp_write(rt2x00dev, 86, 0x00);\n\t\telse\n\t\t\trt2800_bbp_write(rt2x00dev, 86, 0x46);\n\t}\n}\nEXPORT_SYMBOL_GPL(rt2800_config_ant);\n\nstatic void rt2800_config_lna_gain(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t   struct rt2x00lib_conf *libconf)\n{\n\tu16 eeprom;\n\tshort lna_gain;\n\n\tif (libconf->rf.channel <= 14) {\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_LNA);\n\t\tlna_gain = rt2x00_get_field16(eeprom, EEPROM_LNA_BG);\n\t} else if (libconf->rf.channel <= 64) {\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_LNA);\n\t\tlna_gain = rt2x00_get_field16(eeprom, EEPROM_LNA_A0);\n\t} else if (libconf->rf.channel <= 128) {\n\t\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3883)) {\n\t\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_EXT_LNA2);\n\t\t\tlna_gain = rt2x00_get_field16(eeprom,\n\t\t\t\t\t\t      EEPROM_EXT_LNA2_A1);\n\t\t} else {\n\t\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_BG2);\n\t\t\tlna_gain = rt2x00_get_field16(eeprom,\n\t\t\t\t\t\t      EEPROM_RSSI_BG2_LNA_A1);\n\t\t}\n\t} else {\n\t\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3883)) {\n\t\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_EXT_LNA2);\n\t\t\tlna_gain = rt2x00_get_field16(eeprom,\n\t\t\t\t\t\t      EEPROM_EXT_LNA2_A2);\n\t\t} else {\n\t\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_A2);\n\t\t\tlna_gain = rt2x00_get_field16(eeprom,\n\t\t\t\t\t\t      EEPROM_RSSI_A2_LNA_A2);\n\t\t}\n\t}\n\n\trt2x00dev->lna_gain = lna_gain;\n}\n\nstatic inline bool rt2800_clk_is_20mhz(struct rt2x00_dev *rt2x00dev)\n{\n\treturn clk_get_rate(rt2x00dev->clk) == 20000000;\n}\n\n#define FREQ_OFFSET_BOUND\t0x5f\n\nstatic void rt2800_freq_cal_mode1(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 freq_offset, prev_freq_offset;\n\tu8 rfcsr, prev_rfcsr;\n\n\tfreq_offset = rt2x00_get_field8(rt2x00dev->freq_offset, RFCSR17_CODE);\n\tfreq_offset = min_t(u8, freq_offset, FREQ_OFFSET_BOUND);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 17);\n\tprev_rfcsr = rfcsr;\n\n\trt2x00_set_field8(&rfcsr, RFCSR17_CODE, freq_offset);\n\tif (rfcsr == prev_rfcsr)\n\t\treturn;\n\n\tif (rt2x00_is_usb(rt2x00dev)) {\n\t\trt2800_mcu_request(rt2x00dev, MCU_FREQ_OFFSET, 0xff,\n\t\t\t\t   freq_offset, prev_rfcsr);\n\t\treturn;\n\t}\n\n\tprev_freq_offset = rt2x00_get_field8(prev_rfcsr, RFCSR17_CODE);\n\twhile (prev_freq_offset != freq_offset) {\n\t\tif (prev_freq_offset < freq_offset)\n\t\t\tprev_freq_offset++;\n\t\telse\n\t\t\tprev_freq_offset--;\n\n\t\trt2x00_set_field8(&rfcsr, RFCSR17_CODE, prev_freq_offset);\n\t\trt2800_rfcsr_write(rt2x00dev, 17, rfcsr);\n\n\t\tusleep_range(1000, 1500);\n\t}\n}\n\nstatic void rt2800_config_channel_rf2xxx(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_conf *conf,\n\t\t\t\t\t struct rf_channel *rf,\n\t\t\t\t\t struct channel_info *info)\n{\n\trt2x00_set_field32(&rf->rf4, RF4_FREQ_OFFSET, rt2x00dev->freq_offset);\n\n\tif (rt2x00dev->default_ant.tx_chain_num == 1)\n\t\trt2x00_set_field32(&rf->rf2, RF2_ANTENNA_TX1, 1);\n\n\tif (rt2x00dev->default_ant.rx_chain_num == 1) {\n\t\trt2x00_set_field32(&rf->rf2, RF2_ANTENNA_RX1, 1);\n\t\trt2x00_set_field32(&rf->rf2, RF2_ANTENNA_RX2, 1);\n\t} else if (rt2x00dev->default_ant.rx_chain_num == 2)\n\t\trt2x00_set_field32(&rf->rf2, RF2_ANTENNA_RX2, 1);\n\n\tif (rf->channel > 14) {\n\t\t \n\t\trt2x00_set_field32(&rf->rf3, RF3_TXPOWER_A_7DBM_BOOST,\n\t\t\t\t   (info->default_power1 >= 0));\n\n\t\tif (info->default_power1 < 0)\n\t\t\tinfo->default_power1 += 7;\n\n\t\trt2x00_set_field32(&rf->rf3, RF3_TXPOWER_A, info->default_power1);\n\n\t\trt2x00_set_field32(&rf->rf4, RF4_TXPOWER_A_7DBM_BOOST,\n\t\t\t\t   (info->default_power2 >= 0));\n\n\t\tif (info->default_power2 < 0)\n\t\t\tinfo->default_power2 += 7;\n\n\t\trt2x00_set_field32(&rf->rf4, RF4_TXPOWER_A, info->default_power2);\n\t} else {\n\t\trt2x00_set_field32(&rf->rf3, RF3_TXPOWER_G, info->default_power1);\n\t\trt2x00_set_field32(&rf->rf4, RF4_TXPOWER_G, info->default_power2);\n\t}\n\n\trt2x00_set_field32(&rf->rf4, RF4_HT40, conf_is_ht40(conf));\n\n\trt2800_rf_write(rt2x00dev, 1, rf->rf1);\n\trt2800_rf_write(rt2x00dev, 2, rf->rf2);\n\trt2800_rf_write(rt2x00dev, 3, rf->rf3 & ~0x00000004);\n\trt2800_rf_write(rt2x00dev, 4, rf->rf4);\n\n\tudelay(200);\n\n\trt2800_rf_write(rt2x00dev, 1, rf->rf1);\n\trt2800_rf_write(rt2x00dev, 2, rf->rf2);\n\trt2800_rf_write(rt2x00dev, 3, rf->rf3 | 0x00000004);\n\trt2800_rf_write(rt2x00dev, 4, rf->rf4);\n\n\tudelay(200);\n\n\trt2800_rf_write(rt2x00dev, 1, rf->rf1);\n\trt2800_rf_write(rt2x00dev, 2, rf->rf2);\n\trt2800_rf_write(rt2x00dev, 3, rf->rf3 & ~0x00000004);\n\trt2800_rf_write(rt2x00dev, 4, rf->rf4);\n}\n\nstatic void rt2800_config_channel_rf3xxx(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_conf *conf,\n\t\t\t\t\t struct rf_channel *rf,\n\t\t\t\t\t struct channel_info *info)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu8 rfcsr, calib_tx, calib_rx;\n\n\trt2800_rfcsr_write(rt2x00dev, 2, rf->rf1);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 3);\n\trt2x00_set_field8(&rfcsr, RFCSR3_K, rf->rf3);\n\trt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 6);\n\trt2x00_set_field8(&rfcsr, RFCSR6_R1, rf->rf2);\n\trt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 12);\n\trt2x00_set_field8(&rfcsr, RFCSR12_TX_POWER, info->default_power1);\n\trt2800_rfcsr_write(rt2x00dev, 12, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 13);\n\trt2x00_set_field8(&rfcsr, RFCSR13_TX_POWER, info->default_power2);\n\trt2800_rfcsr_write(rt2x00dev, 13, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD,\n\t\t\t  rt2x00dev->default_ant.rx_chain_num <= 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD,\n\t\t\t  rt2x00dev->default_ant.rx_chain_num <= 2);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD,\n\t\t\t  rt2x00dev->default_ant.tx_chain_num <= 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD,\n\t\t\t  rt2x00dev->default_ant.tx_chain_num <= 2);\n\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 23);\n\trt2x00_set_field8(&rfcsr, RFCSR23_FREQ_OFFSET, rt2x00dev->freq_offset);\n\trt2800_rfcsr_write(rt2x00dev, 23, rfcsr);\n\n\tif (rt2x00_rt(rt2x00dev, RT3390)) {\n\t\tcalib_tx = conf_is_ht40(conf) ? 0x68 : 0x4f;\n\t\tcalib_rx = conf_is_ht40(conf) ? 0x6f : 0x4f;\n\t} else {\n\t\tif (conf_is_ht40(conf)) {\n\t\t\tcalib_tx = drv_data->calibration_bw40;\n\t\t\tcalib_rx = drv_data->calibration_bw40;\n\t\t} else {\n\t\t\tcalib_tx = drv_data->calibration_bw20;\n\t\t\tcalib_rx = drv_data->calibration_bw20;\n\t\t}\n\t}\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 24);\n\trt2x00_set_field8(&rfcsr, RFCSR24_TX_CALIB, calib_tx);\n\trt2800_rfcsr_write(rt2x00dev, 24, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 31);\n\trt2x00_set_field8(&rfcsr, RFCSR31_RX_CALIB, calib_rx);\n\trt2800_rfcsr_write(rt2x00dev, 31, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 7);\n\trt2x00_set_field8(&rfcsr, RFCSR7_RF_TUNING, 1);\n\trt2800_rfcsr_write(rt2x00dev, 7, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 30);\n\trt2x00_set_field8(&rfcsr, RFCSR30_RF_CALIBRATION, 1);\n\trt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\n\n\tusleep_range(1000, 1500);\n\n\trt2x00_set_field8(&rfcsr, RFCSR30_RF_CALIBRATION, 0);\n\trt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\n}\n\nstatic void rt2800_config_channel_rf3052(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_conf *conf,\n\t\t\t\t\t struct rf_channel *rf,\n\t\t\t\t\t struct channel_info *info)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu8 rfcsr;\n\tu32 reg;\n\n\tif (rf->channel <= 14) {\n\t\trt2800_bbp_write(rt2x00dev, 25, drv_data->bbp25);\n\t\trt2800_bbp_write(rt2x00dev, 26, drv_data->bbp26);\n\t} else {\n\t\trt2800_bbp_write(rt2x00dev, 25, 0x09);\n\t\trt2800_bbp_write(rt2x00dev, 26, 0xff);\n\t}\n\n\trt2800_rfcsr_write(rt2x00dev, 2, rf->rf1);\n\trt2800_rfcsr_write(rt2x00dev, 3, rf->rf3);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 6);\n\trt2x00_set_field8(&rfcsr, RFCSR6_R1, rf->rf2);\n\tif (rf->channel <= 14)\n\t\trt2x00_set_field8(&rfcsr, RFCSR6_TXDIV, 2);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR6_TXDIV, 1);\n\trt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 5);\n\tif (rf->channel <= 14)\n\t\trt2x00_set_field8(&rfcsr, RFCSR5_R1, 1);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR5_R1, 2);\n\trt2800_rfcsr_write(rt2x00dev, 5, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 12);\n\tif (rf->channel <= 14) {\n\t\trt2x00_set_field8(&rfcsr, RFCSR12_DR0, 3);\n\t\trt2x00_set_field8(&rfcsr, RFCSR12_TX_POWER,\n\t\t\t\t  info->default_power1);\n\t} else {\n\t\trt2x00_set_field8(&rfcsr, RFCSR12_DR0, 7);\n\t\trt2x00_set_field8(&rfcsr, RFCSR12_TX_POWER,\n\t\t\t\t(info->default_power1 & 0x3) |\n\t\t\t\t((info->default_power1 & 0xC) << 1));\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 12, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 13);\n\tif (rf->channel <= 14) {\n\t\trt2x00_set_field8(&rfcsr, RFCSR13_DR0, 3);\n\t\trt2x00_set_field8(&rfcsr, RFCSR13_TX_POWER,\n\t\t\t\t  info->default_power2);\n\t} else {\n\t\trt2x00_set_field8(&rfcsr, RFCSR13_DR0, 7);\n\t\trt2x00_set_field8(&rfcsr, RFCSR13_TX_POWER,\n\t\t\t\t(info->default_power2 & 0x3) |\n\t\t\t\t((info->default_power2 & 0xC) << 1));\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 13, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 0);\n\tif (rt2x00_has_cap_bt_coexist(rt2x00dev)) {\n\t\tif (rf->channel <= 14) {\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 1);\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 1);\n\t\t}\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 1);\n\t} else {\n\t\tswitch (rt2x00dev->default_ant.tx_chain_num) {\n\t\tcase 1:\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\n\t\t\tfallthrough;\n\t\tcase 2:\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 1);\n\t\t\tbreak;\n\t\t}\n\n\t\tswitch (rt2x00dev->default_ant.rx_chain_num) {\n\t\tcase 1:\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\n\t\t\tfallthrough;\n\t\tcase 2:\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 1);\n\t\t\tbreak;\n\t\t}\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 23);\n\trt2x00_set_field8(&rfcsr, RFCSR23_FREQ_OFFSET, rt2x00dev->freq_offset);\n\trt2800_rfcsr_write(rt2x00dev, 23, rfcsr);\n\n\tif (conf_is_ht40(conf)) {\n\t\trt2800_rfcsr_write(rt2x00dev, 24, drv_data->calibration_bw40);\n\t\trt2800_rfcsr_write(rt2x00dev, 31, drv_data->calibration_bw40);\n\t} else {\n\t\trt2800_rfcsr_write(rt2x00dev, 24, drv_data->calibration_bw20);\n\t\trt2800_rfcsr_write(rt2x00dev, 31, drv_data->calibration_bw20);\n\t}\n\n\tif (rf->channel <= 14) {\n\t\trt2800_rfcsr_write(rt2x00dev, 7, 0xd8);\n\t\trt2800_rfcsr_write(rt2x00dev, 9, 0xc3);\n\t\trt2800_rfcsr_write(rt2x00dev, 10, 0xf1);\n\t\trt2800_rfcsr_write(rt2x00dev, 11, 0xb9);\n\t\trt2800_rfcsr_write(rt2x00dev, 15, 0x53);\n\t\trfcsr = 0x4c;\n\t\trt2x00_set_field8(&rfcsr, RFCSR16_TXMIXER_GAIN,\n\t\t\t\t  drv_data->txmixer_gain_24g);\n\t\trt2800_rfcsr_write(rt2x00dev, 16, rfcsr);\n\t\trt2800_rfcsr_write(rt2x00dev, 17, 0x23);\n\t\trt2800_rfcsr_write(rt2x00dev, 19, 0x93);\n\t\trt2800_rfcsr_write(rt2x00dev, 20, 0xb3);\n\t\trt2800_rfcsr_write(rt2x00dev, 25, 0x15);\n\t\trt2800_rfcsr_write(rt2x00dev, 26, 0x85);\n\t\trt2800_rfcsr_write(rt2x00dev, 27, 0x00);\n\t\trt2800_rfcsr_write(rt2x00dev, 29, 0x9b);\n\t} else {\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 7);\n\t\trt2x00_set_field8(&rfcsr, RFCSR7_BIT2, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR7_BIT3, 0);\n\t\trt2x00_set_field8(&rfcsr, RFCSR7_BIT4, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR7_BITS67, 0);\n\t\trt2800_rfcsr_write(rt2x00dev, 7, rfcsr);\n\t\trt2800_rfcsr_write(rt2x00dev, 9, 0xc0);\n\t\trt2800_rfcsr_write(rt2x00dev, 10, 0xf1);\n\t\trt2800_rfcsr_write(rt2x00dev, 11, 0x00);\n\t\trt2800_rfcsr_write(rt2x00dev, 15, 0x43);\n\t\trfcsr = 0x7a;\n\t\trt2x00_set_field8(&rfcsr, RFCSR16_TXMIXER_GAIN,\n\t\t\t\t  drv_data->txmixer_gain_5g);\n\t\trt2800_rfcsr_write(rt2x00dev, 16, rfcsr);\n\t\trt2800_rfcsr_write(rt2x00dev, 17, 0x23);\n\t\tif (rf->channel <= 64) {\n\t\t\trt2800_rfcsr_write(rt2x00dev, 19, 0xb7);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 20, 0xf6);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 25, 0x3d);\n\t\t} else if (rf->channel <= 128) {\n\t\t\trt2800_rfcsr_write(rt2x00dev, 19, 0x74);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 20, 0xf4);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 25, 0x01);\n\t\t} else {\n\t\t\trt2800_rfcsr_write(rt2x00dev, 19, 0x72);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 20, 0xf3);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 25, 0x01);\n\t\t}\n\t\trt2800_rfcsr_write(rt2x00dev, 26, 0x87);\n\t\trt2800_rfcsr_write(rt2x00dev, 27, 0x01);\n\t\trt2800_rfcsr_write(rt2x00dev, 29, 0x9f);\n\t}\n\n\treg = rt2800_register_read(rt2x00dev, GPIO_CTRL);\n\trt2x00_set_field32(&reg, GPIO_CTRL_DIR7, 0);\n\tif (rf->channel <= 14)\n\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL7, 1);\n\telse\n\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL7, 0);\n\trt2800_register_write(rt2x00dev, GPIO_CTRL, reg);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 7);\n\trt2x00_set_field8(&rfcsr, RFCSR7_RF_TUNING, 1);\n\trt2800_rfcsr_write(rt2x00dev, 7, rfcsr);\n}\n\nstatic void rt2800_config_channel_rf3053(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_conf *conf,\n\t\t\t\t\t struct rf_channel *rf,\n\t\t\t\t\t struct channel_info *info)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu8 txrx_agc_fc;\n\tu8 txrx_h20m;\n\tu8 rfcsr;\n\tu8 bbp;\n\tconst bool txbf_enabled = false;  \n\n\t \n\tbbp = rt2800_bbp_read(rt2x00dev, 109);\n\trt2x00_set_field8(&bbp, BBP109_TX0_POWER, 0);\n\trt2x00_set_field8(&bbp, BBP109_TX1_POWER, 0);\n\trt2800_bbp_write(rt2x00dev, 109, bbp);\n\n\tbbp = rt2800_bbp_read(rt2x00dev, 110);\n\trt2x00_set_field8(&bbp, BBP110_TX2_POWER, 0);\n\trt2800_bbp_write(rt2x00dev, 110, bbp);\n\n\tif (rf->channel <= 14) {\n\t\t \n\t\trt2800_bbp_write(rt2x00dev, 25, drv_data->bbp25);\n\t\trt2800_bbp_write(rt2x00dev, 26, drv_data->bbp26);\n\t} else {\n\t\t \n\n\t\t \n\t\trt2800_bbp_write(rt2x00dev, 25, 0x09);\n\t\t \n\t\trt2800_bbp_write(rt2x00dev, 26, 0xff);\n\t}\n\n\trt2800_rfcsr_write(rt2x00dev, 8, rf->rf1);\n\trt2800_rfcsr_write(rt2x00dev, 9, rf->rf3 & 0xf);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 11);\n\trt2x00_set_field8(&rfcsr, RFCSR11_R, (rf->rf2 & 0x3));\n\trt2800_rfcsr_write(rt2x00dev, 11, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 11);\n\trt2x00_set_field8(&rfcsr, RFCSR11_PLL_IDOH, 1);\n\tif (rf->channel <= 14)\n\t\trt2x00_set_field8(&rfcsr, RFCSR11_PLL_MOD, 1);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR11_PLL_MOD, 2);\n\trt2800_rfcsr_write(rt2x00dev, 11, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 53);\n\tif (rf->channel <= 14) {\n\t\trfcsr = 0;\n\t\trt2x00_set_field8(&rfcsr, RFCSR53_TX_POWER,\n\t\t\t\t  info->default_power1 & 0x1f);\n\t} else {\n\t\tif (rt2x00_is_usb(rt2x00dev))\n\t\t\trfcsr = 0x40;\n\n\t\trt2x00_set_field8(&rfcsr, RFCSR53_TX_POWER,\n\t\t\t\t  ((info->default_power1 & 0x18) << 1) |\n\t\t\t\t  (info->default_power1 & 7));\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 53, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 55);\n\tif (rf->channel <= 14) {\n\t\trfcsr = 0;\n\t\trt2x00_set_field8(&rfcsr, RFCSR55_TX_POWER,\n\t\t\t\t  info->default_power2 & 0x1f);\n\t} else {\n\t\tif (rt2x00_is_usb(rt2x00dev))\n\t\t\trfcsr = 0x40;\n\n\t\trt2x00_set_field8(&rfcsr, RFCSR55_TX_POWER,\n\t\t\t\t  ((info->default_power2 & 0x18) << 1) |\n\t\t\t\t  (info->default_power2 & 7));\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 55, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 54);\n\tif (rf->channel <= 14) {\n\t\trfcsr = 0;\n\t\trt2x00_set_field8(&rfcsr, RFCSR54_TX_POWER,\n\t\t\t\t  info->default_power3 & 0x1f);\n\t} else {\n\t\tif (rt2x00_is_usb(rt2x00dev))\n\t\t\trfcsr = 0x40;\n\n\t\trt2x00_set_field8(&rfcsr, RFCSR54_TX_POWER,\n\t\t\t\t  ((info->default_power3 & 0x18) << 1) |\n\t\t\t\t  (info->default_power3 & 7));\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 54, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_PLL_PD, 1);\n\n\tswitch (rt2x00dev->default_ant.tx_chain_num) {\n\tcase 3:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 1);\n\t\tfallthrough;\n\tcase 2:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\n\t\tfallthrough;\n\tcase 1:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 1);\n\t\tbreak;\n\t}\n\n\tswitch (rt2x00dev->default_ant.rx_chain_num) {\n\tcase 3:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 1);\n\t\tfallthrough;\n\tcase 2:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\n\t\tfallthrough;\n\tcase 1:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 1);\n\t\tbreak;\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\n\trt2800_freq_cal_mode1(rt2x00dev);\n\n\tif (conf_is_ht40(conf)) {\n\t\ttxrx_agc_fc = rt2x00_get_field8(drv_data->calibration_bw40,\n\t\t\t\t\t\tRFCSR24_TX_AGC_FC);\n\t\ttxrx_h20m = rt2x00_get_field8(drv_data->calibration_bw40,\n\t\t\t\t\t      RFCSR24_TX_H20M);\n\t} else {\n\t\ttxrx_agc_fc = rt2x00_get_field8(drv_data->calibration_bw20,\n\t\t\t\t\t\tRFCSR24_TX_AGC_FC);\n\t\ttxrx_h20m = rt2x00_get_field8(drv_data->calibration_bw20,\n\t\t\t\t\t      RFCSR24_TX_H20M);\n\t}\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 32);\n\trt2x00_set_field8(&rfcsr, RFCSR32_TX_AGC_FC, txrx_agc_fc);\n\n\tif (rf->channel <= 14)\n\t\trfcsr = 0xa0;\n\telse\n\t\trfcsr = 0x80;\n\trt2800_rfcsr_write(rt2x00dev, 31, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 30);\n\trt2x00_set_field8(&rfcsr, RFCSR30_TX_H20M, txrx_h20m);\n\trt2x00_set_field8(&rfcsr, RFCSR30_RX_H20M, txrx_h20m);\n\trt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 36);\n\tif (rf->channel <= 14)\n\t\trt2x00_set_field8(&rfcsr, RFCSR36_RF_BS, 1);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR36_RF_BS, 0);\n\trt2800_rfcsr_write(rt2x00dev, 36, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 34);\n\tif (rf->channel <= 14)\n\t\trfcsr = 0x3c;\n\telse\n\t\trfcsr = 0x20;\n\trt2800_rfcsr_write(rt2x00dev, 34, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 12);\n\tif (rf->channel <= 14)\n\t\trfcsr = 0x1a;\n\telse\n\t\trfcsr = 0x12;\n\trt2800_rfcsr_write(rt2x00dev, 12, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 6);\n\tif (rf->channel >= 1 && rf->channel <= 14)\n\t\trt2x00_set_field8(&rfcsr, RFCSR6_VCO_IC, 1);\n\telse if (rf->channel >= 36 && rf->channel <= 64)\n\t\trt2x00_set_field8(&rfcsr, RFCSR6_VCO_IC, 2);\n\telse if (rf->channel >= 100 && rf->channel <= 128)\n\t\trt2x00_set_field8(&rfcsr, RFCSR6_VCO_IC, 2);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR6_VCO_IC, 1);\n\trt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 30);\n\trt2x00_set_field8(&rfcsr, RFCSR30_RX_VCM, 2);\n\trt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\n\n\trt2800_rfcsr_write(rt2x00dev, 46, 0x60);\n\n\tif (rf->channel <= 14) {\n\t\trt2800_rfcsr_write(rt2x00dev, 10, 0xd3);\n\t\trt2800_rfcsr_write(rt2x00dev, 13, 0x12);\n\t} else {\n\t\trt2800_rfcsr_write(rt2x00dev, 10, 0xd8);\n\t\trt2800_rfcsr_write(rt2x00dev, 13, 0x23);\n\t}\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 51);\n\trt2x00_set_field8(&rfcsr, RFCSR51_BITS01, 1);\n\trt2800_rfcsr_write(rt2x00dev, 51, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 51);\n\tif (rf->channel <= 14) {\n\t\trt2x00_set_field8(&rfcsr, RFCSR51_BITS24, 5);\n\t\trt2x00_set_field8(&rfcsr, RFCSR51_BITS57, 3);\n\t} else {\n\t\trt2x00_set_field8(&rfcsr, RFCSR51_BITS24, 4);\n\t\trt2x00_set_field8(&rfcsr, RFCSR51_BITS57, 2);\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 51, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 49);\n\tif (rf->channel <= 14)\n\t\trt2x00_set_field8(&rfcsr, RFCSR49_TX_LO1_IC, 3);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR49_TX_LO1_IC, 2);\n\n\tif (txbf_enabled)\n\t\trt2x00_set_field8(&rfcsr, RFCSR49_TX_DIV, 1);\n\n\trt2800_rfcsr_write(rt2x00dev, 49, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 50);\n\trt2x00_set_field8(&rfcsr, RFCSR50_TX_LO1_EN, 0);\n\trt2800_rfcsr_write(rt2x00dev, 50, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 57);\n\tif (rf->channel <= 14)\n\t\trt2x00_set_field8(&rfcsr, RFCSR57_DRV_CC, 0x1b);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR57_DRV_CC, 0x0f);\n\trt2800_rfcsr_write(rt2x00dev, 57, rfcsr);\n\n\tif (rf->channel <= 14) {\n\t\trt2800_rfcsr_write(rt2x00dev, 44, 0x93);\n\t\trt2800_rfcsr_write(rt2x00dev, 52, 0x45);\n\t} else {\n\t\trt2800_rfcsr_write(rt2x00dev, 44, 0x9b);\n\t\trt2800_rfcsr_write(rt2x00dev, 52, 0x05);\n\t}\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 3);\n\tif (rf->channel <= 14) {\n\t\trt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\n\t} else {\n\t\trt2x00_set_field8(&rfcsr, RFCSR3_BIT1, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR3_BIT2, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR3_BIT3, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR3_BIT4, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR3_BIT5, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\n\n\tif (rf->channel >= 1 && rf->channel <= 14) {\n\t\trfcsr = 0x23;\n\t\tif (txbf_enabled)\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR39_RX_DIV, 1);\n\t\trt2800_rfcsr_write(rt2x00dev, 39, rfcsr);\n\n\t\trt2800_rfcsr_write(rt2x00dev, 45, 0xbb);\n\t} else if (rf->channel >= 36 && rf->channel <= 64) {\n\t\trfcsr = 0x36;\n\t\tif (txbf_enabled)\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR39_RX_DIV, 1);\n\t\trt2800_rfcsr_write(rt2x00dev, 39, 0x36);\n\n\t\trt2800_rfcsr_write(rt2x00dev, 45, 0xeb);\n\t} else if (rf->channel >= 100 && rf->channel <= 128) {\n\t\trfcsr = 0x32;\n\t\tif (txbf_enabled)\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR39_RX_DIV, 1);\n\t\trt2800_rfcsr_write(rt2x00dev, 39, rfcsr);\n\n\t\trt2800_rfcsr_write(rt2x00dev, 45, 0xb3);\n\t} else {\n\t\trfcsr = 0x30;\n\t\tif (txbf_enabled)\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR39_RX_DIV, 1);\n\t\trt2800_rfcsr_write(rt2x00dev, 39, rfcsr);\n\n\t\trt2800_rfcsr_write(rt2x00dev, 45, 0x9b);\n\t}\n}\n\nstatic void rt2800_config_channel_rf3853(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_conf *conf,\n\t\t\t\t\t struct rf_channel *rf,\n\t\t\t\t\t struct channel_info *info)\n{\n\tu8 rfcsr;\n\tu8 bbp;\n\tu8 pwr1, pwr2, pwr3;\n\n\tconst bool txbf_enabled = false;  \n\n\t \n\n\tif (rf->channel <= 14)\n\t\trt2800_rfcsr_write(rt2x00dev, 6, 0x40);\n\telse if (rf->channel < 132)\n\t\trt2800_rfcsr_write(rt2x00dev, 6, 0x80);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 6, 0x40);\n\n\trt2800_rfcsr_write(rt2x00dev, 8, rf->rf1);\n\trt2800_rfcsr_write(rt2x00dev, 9, rf->rf3);\n\n\tif (rf->channel <= 14)\n\t\trt2800_rfcsr_write(rt2x00dev, 11, 0x46);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 11, 0x48);\n\n\tif (rf->channel <= 14)\n\t\trt2800_rfcsr_write(rt2x00dev, 12, 0x1a);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 12, 0x52);\n\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x12);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_PLL_PD, 1);\n\n\tswitch (rt2x00dev->default_ant.tx_chain_num) {\n\tcase 3:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 1);\n\t\tfallthrough;\n\tcase 2:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\n\t\tfallthrough;\n\tcase 1:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 1);\n\t\tbreak;\n\t}\n\n\tswitch (rt2x00dev->default_ant.rx_chain_num) {\n\tcase 3:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 1);\n\t\tfallthrough;\n\tcase 2:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\n\t\tfallthrough;\n\tcase 1:\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 1);\n\t\tbreak;\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\n\trt2800_freq_cal_mode1(rt2x00dev);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 30);\n\tif (!conf_is_ht40(conf))\n\t\trfcsr &= ~(0x06);\n\telse\n\t\trfcsr |= 0x06;\n\trt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\n\n\tif (rf->channel <= 14)\n\t\trt2800_rfcsr_write(rt2x00dev, 31, 0xa0);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 31, 0x80);\n\n\tif (conf_is_ht40(conf))\n\t\trt2800_rfcsr_write(rt2x00dev, 32, 0x80);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 32, 0xd8);\n\n\tif (rf->channel <= 14)\n\t\trt2800_rfcsr_write(rt2x00dev, 34, 0x3c);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 34, 0x20);\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 36);\n\tif (rf->channel <= 14)\n\t\trt2x00_set_field8(&rfcsr, RFCSR36_RF_BS, 1);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR36_RF_BS, 0);\n\trt2800_rfcsr_write(rt2x00dev, 36, rfcsr);\n\n\tif (rf->channel <= 14)\n\t\trfcsr = 0x23;\n\telse if (rf->channel < 100)\n\t\trfcsr = 0x36;\n\telse if (rf->channel < 132)\n\t\trfcsr = 0x32;\n\telse\n\t\trfcsr = 0x30;\n\n\tif (txbf_enabled)\n\t\trfcsr |= 0x40;\n\n\trt2800_rfcsr_write(rt2x00dev, 39, rfcsr);\n\n\tif (rf->channel <= 14)\n\t\trt2800_rfcsr_write(rt2x00dev, 44, 0x93);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 44, 0x9b);\n\n\tif (rf->channel <= 14)\n\t\trfcsr = 0xbb;\n\telse if (rf->channel < 100)\n\t\trfcsr = 0xeb;\n\telse if (rf->channel < 132)\n\t\trfcsr = 0xb3;\n\telse\n\t\trfcsr = 0x9b;\n\trt2800_rfcsr_write(rt2x00dev, 45, rfcsr);\n\n\tif (rf->channel <= 14)\n\t\trfcsr = 0x8e;\n\telse\n\t\trfcsr = 0x8a;\n\n\tif (txbf_enabled)\n\t\trfcsr |= 0x20;\n\n\trt2800_rfcsr_write(rt2x00dev, 49, rfcsr);\n\n\trt2800_rfcsr_write(rt2x00dev, 50, 0x86);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 51);\n\tif (rf->channel <= 14)\n\t\trt2800_rfcsr_write(rt2x00dev, 51, 0x75);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 51, 0x51);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 52);\n\tif (rf->channel <= 14)\n\t\trt2800_rfcsr_write(rt2x00dev, 52, 0x45);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 52, 0x05);\n\n\tif (rf->channel <= 14) {\n\t\tpwr1 = info->default_power1 & 0x1f;\n\t\tpwr2 = info->default_power2 & 0x1f;\n\t\tpwr3 = info->default_power3 & 0x1f;\n\t} else {\n\t\tpwr1 = 0x48 | ((info->default_power1 & 0x18) << 1) |\n\t\t\t(info->default_power1 & 0x7);\n\t\tpwr2 = 0x48 | ((info->default_power2 & 0x18) << 1) |\n\t\t\t(info->default_power2 & 0x7);\n\t\tpwr3 = 0x48 | ((info->default_power3 & 0x18) << 1) |\n\t\t\t(info->default_power3 & 0x7);\n\t}\n\n\trt2800_rfcsr_write(rt2x00dev, 53, pwr1);\n\trt2800_rfcsr_write(rt2x00dev, 54, pwr2);\n\trt2800_rfcsr_write(rt2x00dev, 55, pwr3);\n\n\trt2x00_dbg(rt2x00dev, \"Channel:%d, pwr1:%02x, pwr2:%02x, pwr3:%02x\\n\",\n\t\t   rf->channel, pwr1, pwr2, pwr3);\n\n\tbbp = (info->default_power1 >> 5) |\n\t      ((info->default_power2 & 0xe0) >> 1);\n\trt2800_bbp_write(rt2x00dev, 109, bbp);\n\n\tbbp = rt2800_bbp_read(rt2x00dev, 110);\n\tbbp &= 0x0f;\n\tbbp |= (info->default_power3 & 0xe0) >> 1;\n\trt2800_bbp_write(rt2x00dev, 110, bbp);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 57);\n\tif (rf->channel <= 14)\n\t\trt2800_rfcsr_write(rt2x00dev, 57, 0x6e);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 57, 0x3e);\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 3);\n\trt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\n\trt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\n\n\tudelay(2000);\n\n\tbbp = rt2800_bbp_read(rt2x00dev, 49);\n\t \n\trt2800_bbp_write(rt2x00dev, 49, bbp & 0xfe);\n\trt2800_bbp_write(rt2x00dev, 49, bbp);\n\n\t \n}\n\n#define POWER_BOUND\t\t0x27\n#define POWER_BOUND_5G\t\t0x2b\n\nstatic void rt2800_config_channel_rf3290(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_conf *conf,\n\t\t\t\t\t struct rf_channel *rf,\n\t\t\t\t\t struct channel_info *info)\n{\n\tu8 rfcsr;\n\n\trt2800_rfcsr_write(rt2x00dev, 8, rf->rf1);\n\trt2800_rfcsr_write(rt2x00dev, 9, rf->rf3);\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 11);\n\trt2x00_set_field8(&rfcsr, RFCSR11_R, rf->rf2);\n\trt2800_rfcsr_write(rt2x00dev, 11, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 49);\n\tif (info->default_power1 > POWER_BOUND)\n\t\trt2x00_set_field8(&rfcsr, RFCSR49_TX, POWER_BOUND);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR49_TX, info->default_power1);\n\trt2800_rfcsr_write(rt2x00dev, 49, rfcsr);\n\n\trt2800_freq_cal_mode1(rt2x00dev);\n\n\tif (rf->channel <= 14) {\n\t\tif (rf->channel == 6)\n\t\t\trt2800_bbp_write(rt2x00dev, 68, 0x0c);\n\t\telse\n\t\t\trt2800_bbp_write(rt2x00dev, 68, 0x0b);\n\n\t\tif (rf->channel >= 1 && rf->channel <= 6)\n\t\t\trt2800_bbp_write(rt2x00dev, 59, 0x0f);\n\t\telse if (rf->channel >= 7 && rf->channel <= 11)\n\t\t\trt2800_bbp_write(rt2x00dev, 59, 0x0e);\n\t\telse if (rf->channel >= 12 && rf->channel <= 14)\n\t\t\trt2800_bbp_write(rt2x00dev, 59, 0x0d);\n\t}\n}\n\nstatic void rt2800_config_channel_rf3322(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_conf *conf,\n\t\t\t\t\t struct rf_channel *rf,\n\t\t\t\t\t struct channel_info *info)\n{\n\tu8 rfcsr;\n\n\trt2800_rfcsr_write(rt2x00dev, 8, rf->rf1);\n\trt2800_rfcsr_write(rt2x00dev, 9, rf->rf3);\n\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x42);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x1c);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x00);\n\n\tif (info->default_power1 > POWER_BOUND)\n\t\trt2800_rfcsr_write(rt2x00dev, 47, POWER_BOUND);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 47, info->default_power1);\n\n\tif (info->default_power2 > POWER_BOUND)\n\t\trt2800_rfcsr_write(rt2x00dev, 48, POWER_BOUND);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 48, info->default_power2);\n\n\trt2800_freq_cal_mode1(rt2x00dev);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 1);\n\n\tif ( rt2x00dev->default_ant.tx_chain_num == 2 )\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 0);\n\n\tif ( rt2x00dev->default_ant.rx_chain_num == 2 )\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 0);\n\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 0);\n\n\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\n\trt2800_rfcsr_write(rt2x00dev, 31, 80);\n}\n\nstatic void rt2800_config_channel_rf53xx(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_conf *conf,\n\t\t\t\t\t struct rf_channel *rf,\n\t\t\t\t\t struct channel_info *info)\n{\n\tu8 rfcsr;\n\tint idx = rf->channel-1;\n\n\trt2800_rfcsr_write(rt2x00dev, 8, rf->rf1);\n\trt2800_rfcsr_write(rt2x00dev, 9, rf->rf3);\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 11);\n\trt2x00_set_field8(&rfcsr, RFCSR11_R, rf->rf2);\n\trt2800_rfcsr_write(rt2x00dev, 11, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 49);\n\tif (info->default_power1 > POWER_BOUND)\n\t\trt2x00_set_field8(&rfcsr, RFCSR49_TX, POWER_BOUND);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR49_TX, info->default_power1);\n\trt2800_rfcsr_write(rt2x00dev, 49, rfcsr);\n\n\tif (rt2x00_rt(rt2x00dev, RT5392)) {\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 50);\n\t\tif (info->default_power2 > POWER_BOUND)\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR50_TX, POWER_BOUND);\n\t\telse\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR50_TX,\n\t\t\t\t\t  info->default_power2);\n\t\trt2800_rfcsr_write(rt2x00dev, 50, rfcsr);\n\t}\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\tif (rt2x00_rt(rt2x00dev, RT5392)) {\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\n\t}\n\trt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_PLL_PD, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 1);\n\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\n\trt2800_freq_cal_mode1(rt2x00dev);\n\n\tif (rt2x00_has_cap_bt_coexist(rt2x00dev)) {\n\t\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F)) {\n\t\t\t \n\t\t\tstatic const u8 r55_bt_rev[] = {0x83, 0x83,\n\t\t\t\t0x83, 0x73, 0x73, 0x63, 0x53, 0x53,\n\t\t\t\t0x53, 0x43, 0x43, 0x43, 0x43, 0x43};\n\t\t\tstatic const u8 r59_bt_rev[] = {0x0e, 0x0e,\n\t\t\t\t0x0e, 0x0e, 0x0e, 0x0b, 0x0a, 0x09,\n\t\t\t\t0x07, 0x07, 0x07, 0x07, 0x07, 0x07};\n\n\t\t\trt2800_rfcsr_write(rt2x00dev, 55,\n\t\t\t\t\t   r55_bt_rev[idx]);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 59,\n\t\t\t\t\t   r59_bt_rev[idx]);\n\t\t} else {\n\t\t\tstatic const u8 r59_bt[] = {0x8b, 0x8b, 0x8b,\n\t\t\t\t0x8b, 0x8b, 0x8b, 0x8b, 0x8a, 0x89,\n\t\t\t\t0x88, 0x88, 0x86, 0x85, 0x84};\n\n\t\t\trt2800_rfcsr_write(rt2x00dev, 59, r59_bt[idx]);\n\t\t}\n\t} else {\n\t\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F)) {\n\t\t\tstatic const u8 r55_nonbt_rev[] = {0x23, 0x23,\n\t\t\t\t0x23, 0x23, 0x13, 0x13, 0x03, 0x03,\n\t\t\t\t0x03, 0x03, 0x03, 0x03, 0x03, 0x03};\n\t\t\tstatic const u8 r59_nonbt_rev[] = {0x07, 0x07,\n\t\t\t\t0x07, 0x07, 0x07, 0x07, 0x07, 0x07,\n\t\t\t\t0x07, 0x07, 0x06, 0x05, 0x04, 0x04};\n\n\t\t\trt2800_rfcsr_write(rt2x00dev, 55,\n\t\t\t\t\t   r55_nonbt_rev[idx]);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 59,\n\t\t\t\t\t   r59_nonbt_rev[idx]);\n\t\t} else if (rt2x00_rt(rt2x00dev, RT5390) ||\n\t\t\t   rt2x00_rt(rt2x00dev, RT5392) ||\n\t\t\t   rt2x00_rt(rt2x00dev, RT6352)) {\n\t\t\tstatic const u8 r59_non_bt[] = {0x8f, 0x8f,\n\t\t\t\t0x8f, 0x8f, 0x8f, 0x8f, 0x8f, 0x8d,\n\t\t\t\t0x8a, 0x88, 0x88, 0x87, 0x87, 0x86};\n\n\t\t\trt2800_rfcsr_write(rt2x00dev, 59,\n\t\t\t\t\t   r59_non_bt[idx]);\n\t\t} else if (rt2x00_rt(rt2x00dev, RT5350)) {\n\t\t\tstatic const u8 r59_non_bt[] = {0x0b, 0x0b,\n\t\t\t\t0x0b, 0x0b, 0x0b, 0x0b, 0x0b, 0x0a,\n\t\t\t\t0x0a, 0x09, 0x08, 0x07, 0x07, 0x06};\n\n\t\t\trt2800_rfcsr_write(rt2x00dev, 59,\n\t\t\t\t\t   r59_non_bt[idx]);\n\t\t}\n\t}\n}\n\nstatic void rt2800_config_channel_rf55xx(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_conf *conf,\n\t\t\t\t\t struct rf_channel *rf,\n\t\t\t\t\t struct channel_info *info)\n{\n\tu8 rfcsr, ep_reg;\n\tu32 reg;\n\tint power_bound;\n\n\t \n\tconst bool is_11b = false;\n\tconst bool is_type_ep = false;\n\n\treg = rt2800_register_read(rt2x00dev, LDO_CFG0);\n\trt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL,\n\t\t\t   (rf->channel > 14 || conf_is_ht40(conf)) ? 5 : 0);\n\trt2800_register_write(rt2x00dev, LDO_CFG0, reg);\n\n\t \n\trt2800_rfcsr_write(rt2x00dev, 8, rf->rf1 & 0xff);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev,  9);\n\trt2x00_set_field8(&rfcsr, RFCSR9_K, rf->rf2 & 0xf);\n\trt2x00_set_field8(&rfcsr, RFCSR9_N, (rf->rf1 & 0x100) >> 8);\n\trt2x00_set_field8(&rfcsr, RFCSR9_MOD, ((rf->rf3 - 8) & 0x4) >> 2);\n\trt2800_rfcsr_write(rt2x00dev, 9, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 11);\n\trt2x00_set_field8(&rfcsr, RFCSR11_R, rf->rf4 - 1);\n\trt2x00_set_field8(&rfcsr, RFCSR11_MOD, (rf->rf3 - 8) & 0x3);\n\trt2800_rfcsr_write(rt2x00dev, 11, rfcsr);\n\n\tif (rf->channel <= 14) {\n\t\trt2800_rfcsr_write(rt2x00dev, 10, 0x90);\n\t\t \n\t\trt2800_rfcsr_write(rt2x00dev, 11, 0x4A);\n\t\trt2800_rfcsr_write(rt2x00dev, 12, 0x52);\n\t\trt2800_rfcsr_write(rt2x00dev, 13, 0x42);\n\t\trt2800_rfcsr_write(rt2x00dev, 22, 0x40);\n\t\trt2800_rfcsr_write(rt2x00dev, 24, 0x4A);\n\t\trt2800_rfcsr_write(rt2x00dev, 25, 0x80);\n\t\trt2800_rfcsr_write(rt2x00dev, 27, 0x42);\n\t\trt2800_rfcsr_write(rt2x00dev, 36, 0x80);\n\t\trt2800_rfcsr_write(rt2x00dev, 37, 0x08);\n\t\trt2800_rfcsr_write(rt2x00dev, 38, 0x89);\n\t\trt2800_rfcsr_write(rt2x00dev, 39, 0x1B);\n\t\trt2800_rfcsr_write(rt2x00dev, 40, 0x0D);\n\t\trt2800_rfcsr_write(rt2x00dev, 41, 0x9B);\n\t\trt2800_rfcsr_write(rt2x00dev, 42, 0xD5);\n\t\trt2800_rfcsr_write(rt2x00dev, 43, 0x72);\n\t\trt2800_rfcsr_write(rt2x00dev, 44, 0x0E);\n\t\trt2800_rfcsr_write(rt2x00dev, 45, 0xA2);\n\t\trt2800_rfcsr_write(rt2x00dev, 46, 0x6B);\n\t\trt2800_rfcsr_write(rt2x00dev, 48, 0x10);\n\t\trt2800_rfcsr_write(rt2x00dev, 51, 0x3E);\n\t\trt2800_rfcsr_write(rt2x00dev, 52, 0x48);\n\t\trt2800_rfcsr_write(rt2x00dev, 54, 0x38);\n\t\trt2800_rfcsr_write(rt2x00dev, 56, 0xA1);\n\t\trt2800_rfcsr_write(rt2x00dev, 57, 0x00);\n\t\trt2800_rfcsr_write(rt2x00dev, 58, 0x39);\n\t\trt2800_rfcsr_write(rt2x00dev, 60, 0x45);\n\t\trt2800_rfcsr_write(rt2x00dev, 61, 0x91);\n\t\trt2800_rfcsr_write(rt2x00dev, 62, 0x39);\n\n\t\t \n\n\t\trfcsr = rf->channel <= 10 ? 0x07 : 0x06;\n\t\trt2800_rfcsr_write(rt2x00dev, 23, rfcsr);\n\t\trt2800_rfcsr_write(rt2x00dev, 59, rfcsr);\n\n\t\tif (is_11b) {\n\t\t\t \n\t\t\trt2800_rfcsr_write(rt2x00dev, 31, 0xF8);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 32, 0xC0);\n\t\t\tif (is_type_ep)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 55, 0x06);\n\t\t\telse\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 55, 0x47);\n\t\t} else {\n\t\t\t \n\t\t\tif (is_type_ep)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 55, 0x03);\n\t\t\telse\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 55, 0x43);\n\t\t}\n\n\t\tpower_bound = POWER_BOUND;\n\t\tep_reg = 0x2;\n\t} else {\n\t\trt2800_rfcsr_write(rt2x00dev, 10, 0x97);\n\t\t \n\t\trt2800_rfcsr_write(rt2x00dev, 11, 0x40);\n\t\trt2800_rfcsr_write(rt2x00dev, 25, 0xBF);\n\t\trt2800_rfcsr_write(rt2x00dev, 27, 0x42);\n\t\trt2800_rfcsr_write(rt2x00dev, 36, 0x00);\n\t\trt2800_rfcsr_write(rt2x00dev, 37, 0x04);\n\t\trt2800_rfcsr_write(rt2x00dev, 38, 0x85);\n\t\trt2800_rfcsr_write(rt2x00dev, 40, 0x42);\n\t\trt2800_rfcsr_write(rt2x00dev, 41, 0xBB);\n\t\trt2800_rfcsr_write(rt2x00dev, 42, 0xD7);\n\t\trt2800_rfcsr_write(rt2x00dev, 45, 0x41);\n\t\trt2800_rfcsr_write(rt2x00dev, 48, 0x00);\n\t\trt2800_rfcsr_write(rt2x00dev, 57, 0x77);\n\t\trt2800_rfcsr_write(rt2x00dev, 60, 0x05);\n\t\trt2800_rfcsr_write(rt2x00dev, 61, 0x01);\n\n\t\t \n\n\t\tif (rf->channel >= 36 && rf->channel <= 64) {\n\n\t\t\trt2800_rfcsr_write(rt2x00dev, 12, 0x2E);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 13, 0x22);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 22, 0x60);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 23, 0x7F);\n\t\t\tif (rf->channel <= 50)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 24, 0x09);\n\t\t\telse if (rf->channel >= 52)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 24, 0x07);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 39, 0x1C);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 43, 0x5B);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 44, 0X40);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 46, 0X00);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 51, 0xFE);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 52, 0x0C);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 54, 0xF8);\n\t\t\tif (rf->channel <= 50) {\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 55, 0x06),\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 56, 0xD3);\n\t\t\t} else if (rf->channel >= 52) {\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 55, 0x04);\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 56, 0xBB);\n\t\t\t}\n\n\t\t\trt2800_rfcsr_write(rt2x00dev, 58, 0x15);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 59, 0x7F);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 62, 0x15);\n\n\t\t} else if (rf->channel >= 100 && rf->channel <= 165) {\n\n\t\t\trt2800_rfcsr_write(rt2x00dev, 12, 0x0E);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 13, 0x42);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 22, 0x40);\n\t\t\tif (rf->channel <= 153) {\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 23, 0x3C);\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 24, 0x06);\n\t\t\t} else if (rf->channel >= 155) {\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 23, 0x38);\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 24, 0x05);\n\t\t\t}\n\t\t\tif (rf->channel <= 138) {\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 39, 0x1A);\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 43, 0x3B);\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 44, 0x20);\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 46, 0x18);\n\t\t\t} else if (rf->channel >= 140) {\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 39, 0x18);\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 43, 0x1B);\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 44, 0x10);\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 46, 0X08);\n\t\t\t}\n\t\t\tif (rf->channel <= 124)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 51, 0xFC);\n\t\t\telse if (rf->channel >= 126)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 51, 0xEC);\n\t\t\tif (rf->channel <= 138)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 52, 0x06);\n\t\t\telse if (rf->channel >= 140)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 52, 0x06);\n\t\t\trt2800_rfcsr_write(rt2x00dev, 54, 0xEB);\n\t\t\tif (rf->channel <= 138)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 55, 0x01);\n\t\t\telse if (rf->channel >= 140)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 55, 0x00);\n\t\t\tif (rf->channel <= 128)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 56, 0xBB);\n\t\t\telse if (rf->channel >= 130)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 56, 0xAB);\n\t\t\tif (rf->channel <= 116)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 58, 0x1D);\n\t\t\telse if (rf->channel >= 118)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 58, 0x15);\n\t\t\tif (rf->channel <= 138)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 59, 0x3F);\n\t\t\telse if (rf->channel >= 140)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 59, 0x7C);\n\t\t\tif (rf->channel <= 116)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 62, 0x1D);\n\t\t\telse if (rf->channel >= 118)\n\t\t\t\trt2800_rfcsr_write(rt2x00dev, 62, 0x15);\n\t\t}\n\n\t\tpower_bound = POWER_BOUND_5G;\n\t\tep_reg = 0x3;\n\t}\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 49);\n\tif (info->default_power1 > power_bound)\n\t\trt2x00_set_field8(&rfcsr, RFCSR49_TX, power_bound);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR49_TX, info->default_power1);\n\tif (is_type_ep)\n\t\trt2x00_set_field8(&rfcsr, RFCSR49_EP, ep_reg);\n\trt2800_rfcsr_write(rt2x00dev, 49, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 50);\n\tif (info->default_power2 > power_bound)\n\t\trt2x00_set_field8(&rfcsr, RFCSR50_TX, power_bound);\n\telse\n\t\trt2x00_set_field8(&rfcsr, RFCSR50_TX, info->default_power2);\n\tif (is_type_ep)\n\t\trt2x00_set_field8(&rfcsr, RFCSR50_EP, ep_reg);\n\trt2800_rfcsr_write(rt2x00dev, 50, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_PLL_PD, 1);\n\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD,\n\t\t\t  rt2x00dev->default_ant.tx_chain_num >= 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD,\n\t\t\t  rt2x00dev->default_ant.tx_chain_num == 2);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 0);\n\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD,\n\t\t\t  rt2x00dev->default_ant.rx_chain_num >= 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD,\n\t\t\t  rt2x00dev->default_ant.rx_chain_num == 2);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 0);\n\n\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0xe4);\n\n\tif (conf_is_ht40(conf))\n\t\trt2800_rfcsr_write(rt2x00dev, 30, 0x16);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 30, 0x10);\n\n\tif (!is_11b) {\n\t\trt2800_rfcsr_write(rt2x00dev, 31, 0x80);\n\t\trt2800_rfcsr_write(rt2x00dev, 32, 0x80);\n\t}\n\n\t \n\trt2800_freq_cal_mode1(rt2x00dev);\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 3);\n\trt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\n\trt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 62, 0x37 - rt2x00dev->lna_gain);\n\trt2800_bbp_write(rt2x00dev, 63, 0x37 - rt2x00dev->lna_gain);\n\trt2800_bbp_write(rt2x00dev, 64, 0x37 - rt2x00dev->lna_gain);\n\n\trt2800_bbp_write(rt2x00dev, 79, (rf->channel <= 14) ? 0x1C : 0x18);\n\trt2800_bbp_write(rt2x00dev, 80, (rf->channel <= 14) ? 0x0E : 0x08);\n\trt2800_bbp_write(rt2x00dev, 81, (rf->channel <= 14) ? 0x3A : 0x38);\n\trt2800_bbp_write(rt2x00dev, 82, (rf->channel <= 14) ? 0x62 : 0x92);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 195, 128);\n\trt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0xE0 : 0xF0);\n\trt2800_bbp_write(rt2x00dev, 195, 129);\n\trt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0x1F : 0x1E);\n\trt2800_bbp_write(rt2x00dev, 195, 130);\n\trt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0x38 : 0x28);\n\trt2800_bbp_write(rt2x00dev, 195, 131);\n\trt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0x32 : 0x20);\n\trt2800_bbp_write(rt2x00dev, 195, 133);\n\trt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0x28 : 0x7F);\n\trt2800_bbp_write(rt2x00dev, 195, 124);\n\trt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0x19 : 0x7F);\n}\n\nstatic void rt2800_config_channel_rf7620(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_conf *conf,\n\t\t\t\t\t struct rf_channel *rf,\n\t\t\t\t\t struct channel_info *info)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu8 rx_agc_fc, tx_agc_fc;\n\tu8 rfcsr;\n\n\t \n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 13);\n\trt2x00_set_field8(&rfcsr, RFCSR13_RDIV_MT7620,\n\t\t\t  rt2800_clk_is_20mhz(rt2x00dev) ? 3 : 0);\n\trt2800_rfcsr_write(rt2x00dev, 13, rfcsr);\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 20);\n\trfcsr = (rf->rf1 & 0x00ff);\n\trt2800_rfcsr_write(rt2x00dev, 20, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 21);\n\trt2x00_set_field8(&rfcsr, RFCSR21_BIT1, 0);\n\trt2800_rfcsr_write(rt2x00dev, 21, rfcsr);\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 16);\n\trt2x00_set_field8(&rfcsr, RFCSR16_RF_PLL_FREQ_SEL_MT7620, 0);\n\trt2800_rfcsr_write(rt2x00dev, 16, rfcsr);\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 22);\n\trt2x00_set_field8(&rfcsr, RFCSR22_FREQPLAN_D_MT7620, 0);\n\trt2800_rfcsr_write(rt2x00dev, 22, rfcsr);\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 17);\n\trfcsr = rf->rf2;\n\trt2800_rfcsr_write(rt2x00dev, 17, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 18);\n\trfcsr = rf->rf3;\n\trt2800_rfcsr_write(rt2x00dev, 18, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 19);\n\trt2x00_set_field8(&rfcsr, RFCSR19_K, rf->rf4);\n\trt2800_rfcsr_write(rt2x00dev, 19, rfcsr);\n\n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 16);\n\trt2x00_set_field8(&rfcsr, RFCSR16_SDM_MODE_MT7620, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 16, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 21);\n\trt2x00_set_field8(&rfcsr, RFCSR21_BIT8, 1);\n\trt2800_rfcsr_write(rt2x00dev, 21, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_TX2_EN_MT7620,\n\t\t\t  rt2x00dev->default_ant.tx_chain_num != 1);\n\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 2);\n\trt2x00_set_field8(&rfcsr, RFCSR2_TX2_EN_MT7620,\n\t\t\t  rt2x00dev->default_ant.tx_chain_num != 1);\n\trt2x00_set_field8(&rfcsr, RFCSR2_RX2_EN_MT7620,\n\t\t\t  rt2x00dev->default_ant.rx_chain_num != 1);\n\trt2800_rfcsr_write(rt2x00dev, 2, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 42);\n\trt2x00_set_field8(&rfcsr, RFCSR42_TX2_EN_MT7620,\n\t\t\t  rt2x00dev->default_ant.tx_chain_num != 1);\n\trt2800_rfcsr_write(rt2x00dev, 42, rfcsr);\n\n\t \n\tif (conf_is_ht40(conf)) {\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 6, 0x10);\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 7, 0x10);\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 8, 0x04);\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 58, 0x10);\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 59, 0x10);\n\t} else {\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 6, 0x20);\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 7, 0x20);\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 8, 0x00);\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 58, 0x20);\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 59, 0x20);\n\t}\n\n\tif (conf_is_ht40(conf)) {\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 58, 0x08);\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 59, 0x08);\n\t} else {\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 58, 0x28);\n\t\trt2800_rfcsr_write_dccal(rt2x00dev, 59, 0x28);\n\t}\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 28);\n\trt2x00_set_field8(&rfcsr, RFCSR28_CH11_HT40,\n\t\t\t  conf_is_ht40(conf) && (rf->channel == 11));\n\trt2800_rfcsr_write(rt2x00dev, 28, rfcsr);\n\n\tif (!test_bit(DEVICE_STATE_SCANNING, &rt2x00dev->flags)) {\n\t\tif (conf_is_ht40(conf)) {\n\t\t\trx_agc_fc = drv_data->rx_calibration_bw40;\n\t\t\ttx_agc_fc = drv_data->tx_calibration_bw40;\n\t\t} else {\n\t\t\trx_agc_fc = drv_data->rx_calibration_bw20;\n\t\t\ttx_agc_fc = drv_data->tx_calibration_bw20;\n\t\t}\n\t\trfcsr = rt2800_rfcsr_read_bank(rt2x00dev, 5, 6);\n\t\trfcsr &= (~0x3F);\n\t\trfcsr |= rx_agc_fc;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 6, rfcsr);\n\t\trfcsr = rt2800_rfcsr_read_bank(rt2x00dev, 5, 7);\n\t\trfcsr &= (~0x3F);\n\t\trfcsr |= rx_agc_fc;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 7, rfcsr);\n\t\trfcsr = rt2800_rfcsr_read_bank(rt2x00dev, 7, 6);\n\t\trfcsr &= (~0x3F);\n\t\trfcsr |= rx_agc_fc;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 7, 6, rfcsr);\n\t\trfcsr = rt2800_rfcsr_read_bank(rt2x00dev, 7, 7);\n\t\trfcsr &= (~0x3F);\n\t\trfcsr |= rx_agc_fc;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 7, 7, rfcsr);\n\n\t\trfcsr = rt2800_rfcsr_read_bank(rt2x00dev, 5, 58);\n\t\trfcsr &= (~0x3F);\n\t\trfcsr |= tx_agc_fc;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 58, rfcsr);\n\t\trfcsr = rt2800_rfcsr_read_bank(rt2x00dev, 5, 59);\n\t\trfcsr &= (~0x3F);\n\t\trfcsr |= tx_agc_fc;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 59, rfcsr);\n\t\trfcsr = rt2800_rfcsr_read_bank(rt2x00dev, 7, 58);\n\t\trfcsr &= (~0x3F);\n\t\trfcsr |= tx_agc_fc;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 7, 58, rfcsr);\n\t\trfcsr = rt2800_rfcsr_read_bank(rt2x00dev, 7, 59);\n\t\trfcsr &= (~0x3F);\n\t\trfcsr |= tx_agc_fc;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 7, 59, rfcsr);\n\t}\n\n\tif (conf_is_ht40(conf)) {\n\t\trt2800_bbp_glrt_write(rt2x00dev, 141, 0x10);\n\t\trt2800_bbp_glrt_write(rt2x00dev, 157, 0x2f);\n\t} else {\n\t\trt2800_bbp_glrt_write(rt2x00dev, 141, 0x1a);\n\t\trt2800_bbp_glrt_write(rt2x00dev, 157, 0x40);\n\t}\n}\n\nstatic void rt2800_config_alc_rt6352(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t     struct ieee80211_channel *chan,\n\t\t\t\t     int power_level)\n{\n\tint cur_channel = rt2x00dev->rf_channel;\n\tu16 eeprom, chan_power, rate_power, target_power;\n\tu16 tx_power[2];\n\ts8 *power_group[2];\n\tu32 mac_sys_ctrl;\n\tu32 cnt, reg;\n\tu8 bbp;\n\n\tif (WARN_ON(cur_channel < 1 || cur_channel > 14))\n\t\treturn;\n\n\t \n\tpower_level = (power_level - 3) * 2;\n\n\t \n\trate_power = rt2800_eeprom_read_from_array(rt2x00dev,\n\t\t\t\t\t\t   EEPROM_TXPOWER_BYRATE, 1);\n\trate_power &= 0x3f;\n\tpower_level -= rate_power;\n\tif (power_level < 1)\n\t\tpower_level = 1;\n\n\tpower_group[0] = rt2800_eeprom_addr(rt2x00dev, EEPROM_TXPOWER_BG1);\n\tpower_group[1] = rt2800_eeprom_addr(rt2x00dev, EEPROM_TXPOWER_BG2);\n\tfor (cnt = 0; cnt < 2; cnt++) {\n\t\tchan_power = power_group[cnt][cur_channel - 1];\n\t\tif (chan_power >= 0x20 || chan_power == 0)\n\t\t\tchan_power = 0x10;\n\t\ttx_power[cnt] = power_level < chan_power ? power_level : chan_power;\n\t}\n\n\treg = rt2800_register_read(rt2x00dev, TX_ALC_CFG_0);\n\trt2x00_set_field32(&reg, TX_ALC_CFG_0_CH_INIT_0, tx_power[0]);\n\trt2x00_set_field32(&reg, TX_ALC_CFG_0_CH_INIT_1, tx_power[1]);\n\trt2x00_set_field32(&reg, TX_ALC_CFG_0_LIMIT_0, 0x2f);\n\trt2x00_set_field32(&reg, TX_ALC_CFG_0_LIMIT_1, 0x2f);\n\n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1);\n\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_INTERNAL_TX_ALC)) {\n\t\t \n\t\ttarget_power = rt2800_eeprom_read(rt2x00dev,\n\t\t\t\t\t\t  EEPROM_TXPOWER_INIT);\n\t\trt2x00_set_field32(&reg, TX_ALC_CFG_0_CH_INIT_0, target_power);\n\t\trt2x00_set_field32(&reg, TX_ALC_CFG_0_CH_INIT_1, target_power);\n\t}\n\trt2800_register_write(rt2x00dev, TX_ALC_CFG_0, reg);\n\n\treg = rt2800_register_read(rt2x00dev, TX_ALC_CFG_1);\n\trt2x00_set_field32(&reg, TX_ALC_CFG_1_TX_TEMP_COMP, 0);\n\trt2800_register_write(rt2x00dev, TX_ALC_CFG_1, reg);\n\n\t \n\tmac_sys_ctrl = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\t \n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, 0);\n\t \n\tif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev, MAC_STATUS_CFG_BBP_RF_BUSY)))\n\t\trt2x00_warn(rt2x00dev, \"RF busy while configuring ALC\\n\");\n\n\tif (chan->center_freq > 2457) {\n\t\tbbp = rt2800_bbp_read(rt2x00dev, 30);\n\t\tbbp = 0x40;\n\t\trt2800_bbp_write(rt2x00dev, 30, bbp);\n\t\trt2800_rfcsr_write(rt2x00dev, 39, 0);\n\t\tif (rt2x00_has_cap_external_lna_bg(rt2x00dev))\n\t\t\trt2800_rfcsr_write(rt2x00dev, 42, 0xfb);\n\t\telse\n\t\t\trt2800_rfcsr_write(rt2x00dev, 42, 0x7b);\n\t} else {\n\t\tbbp = rt2800_bbp_read(rt2x00dev, 30);\n\t\tbbp = 0x1f;\n\t\trt2800_bbp_write(rt2x00dev, 30, bbp);\n\t\trt2800_rfcsr_write(rt2x00dev, 39, 0x80);\n\t\tif (rt2x00_has_cap_external_lna_bg(rt2x00dev))\n\t\t\trt2800_rfcsr_write(rt2x00dev, 42, 0xdb);\n\t\telse\n\t\t\trt2800_rfcsr_write(rt2x00dev, 42, 0x5b);\n\t}\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, mac_sys_ctrl);\n\n\trt2800_vco_calibration(rt2x00dev);\n}\n\nstatic void rt2800_bbp_write_with_rx_chain(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t   const unsigned int word,\n\t\t\t\t\t   const u8 value)\n{\n\tu8 chain, reg;\n\n\tfor (chain = 0; chain < rt2x00dev->default_ant.rx_chain_num; chain++) {\n\t\treg = rt2800_bbp_read(rt2x00dev, 27);\n\t\trt2x00_set_field8(&reg,  BBP27_RX_CHAIN_SEL, chain);\n\t\trt2800_bbp_write(rt2x00dev, 27, reg);\n\n\t\trt2800_bbp_write(rt2x00dev, word, value);\n\t}\n}\n\nstatic void rt2800_iq_calibrate(struct rt2x00_dev *rt2x00dev, int channel)\n{\n\tu8 cal;\n\n\t \n\trt2800_bbp_write(rt2x00dev, 158, 0x2c);\n\tif (channel <= 14)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev, EEPROM_IQ_GAIN_CAL_TX0_2G);\n\telse if (channel >= 36 && channel <= 64)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_GAIN_CAL_TX0_CH36_TO_CH64_5G);\n\telse if (channel >= 100 && channel <= 138)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_GAIN_CAL_TX0_CH100_TO_CH138_5G);\n\telse if (channel >= 140 && channel <= 165)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_GAIN_CAL_TX0_CH140_TO_CH165_5G);\n\telse\n\t\tcal = 0;\n\trt2800_bbp_write(rt2x00dev, 159, cal);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 158, 0x2d);\n\tif (channel <= 14)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev, EEPROM_IQ_PHASE_CAL_TX0_2G);\n\telse if (channel >= 36 && channel <= 64)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_PHASE_CAL_TX0_CH36_TO_CH64_5G);\n\telse if (channel >= 100 && channel <= 138)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_PHASE_CAL_TX0_CH100_TO_CH138_5G);\n\telse if (channel >= 140 && channel <= 165)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_PHASE_CAL_TX0_CH140_TO_CH165_5G);\n\telse\n\t\tcal = 0;\n\trt2800_bbp_write(rt2x00dev, 159, cal);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 158, 0x4a);\n\tif (channel <= 14)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev, EEPROM_IQ_GAIN_CAL_TX1_2G);\n\telse if (channel >= 36 && channel <= 64)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_GAIN_CAL_TX1_CH36_TO_CH64_5G);\n\telse if (channel >= 100 && channel <= 138)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_GAIN_CAL_TX1_CH100_TO_CH138_5G);\n\telse if (channel >= 140 && channel <= 165)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_GAIN_CAL_TX1_CH140_TO_CH165_5G);\n\telse\n\t\tcal = 0;\n\trt2800_bbp_write(rt2x00dev, 159, cal);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 158, 0x4b);\n\tif (channel <= 14)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev, EEPROM_IQ_PHASE_CAL_TX1_2G);\n\telse if (channel >= 36 && channel <= 64)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_PHASE_CAL_TX1_CH36_TO_CH64_5G);\n\telse if (channel >= 100 && channel <= 138)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_PHASE_CAL_TX1_CH100_TO_CH138_5G);\n\telse if (channel >= 140 && channel <= 165)\n\t\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t\t EEPROM_IQ_PHASE_CAL_TX1_CH140_TO_CH165_5G);\n\telse\n\t\tcal = 0;\n\trt2800_bbp_write(rt2x00dev, 159, cal);\n\n\t \n\n\t \n\trt2800_bbp_write(rt2x00dev, 158, 0x04);\n\tcal = rt2x00_eeprom_byte(rt2x00dev, EEPROM_RF_IQ_COMPENSATION_CONTROL);\n\trt2800_bbp_write(rt2x00dev, 159, cal != 0xff ? cal : 0);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 158, 0x03);\n\tcal = rt2x00_eeprom_byte(rt2x00dev,\n\t\t\t\t EEPROM_RF_IQ_IMBALANCE_COMPENSATION_CONTROL);\n\trt2800_bbp_write(rt2x00dev, 159, cal != 0xff ? cal : 0);\n}\n\nstatic s8 rt2800_txpower_to_dev(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t  unsigned int channel,\n\t\t\t\t  s8 txpower)\n{\n\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t    rt2x00_rt(rt2x00dev, RT3883))\n\t\ttxpower = rt2x00_get_field8(txpower, EEPROM_TXPOWER_ALC);\n\n\tif (channel <= 14)\n\t\treturn clamp_t(s8, txpower, MIN_G_TXPOWER, MAX_G_TXPOWER);\n\n\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t    rt2x00_rt(rt2x00dev, RT3883))\n\t\treturn clamp_t(s8, txpower, MIN_A_TXPOWER_3593,\n\t\t\t       MAX_A_TXPOWER_3593);\n\telse\n\t\treturn clamp_t(s8, txpower, MIN_A_TXPOWER, MAX_A_TXPOWER);\n}\n\nstatic void rt3883_bbp_adjust(struct rt2x00_dev *rt2x00dev,\n\t\t\t      struct rf_channel *rf)\n{\n\tu8 bbp;\n\n\tbbp = (rf->channel > 14) ? 0x48 : 0x38;\n\trt2800_bbp_write_with_rx_chain(rt2x00dev, 66, bbp);\n\n\trt2800_bbp_write(rt2x00dev, 69, 0x12);\n\n\tif (rf->channel <= 14) {\n\t\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\t} else {\n\t\t \n\t\trt2800_bbp_write(rt2x00dev, 70, 0x00);\n\t}\n\n\trt2800_bbp_write(rt2x00dev, 73, 0x10);\n\n\tif (rf->channel > 14) {\n\t\trt2800_bbp_write(rt2x00dev, 62, 0x1d);\n\t\trt2800_bbp_write(rt2x00dev, 63, 0x1d);\n\t\trt2800_bbp_write(rt2x00dev, 64, 0x1d);\n\t} else {\n\t\trt2800_bbp_write(rt2x00dev, 62, 0x2d);\n\t\trt2800_bbp_write(rt2x00dev, 63, 0x2d);\n\t\trt2800_bbp_write(rt2x00dev, 64, 0x2d);\n\t}\n}\n\nstatic void rt2800_config_channel(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t  struct ieee80211_conf *conf,\n\t\t\t\t  struct rf_channel *rf,\n\t\t\t\t  struct channel_info *info)\n{\n\tu32 reg;\n\tu32 tx_pin;\n\tu8 bbp, rfcsr;\n\n\tinfo->default_power1 = rt2800_txpower_to_dev(rt2x00dev, rf->channel,\n\t\t\t\t\t\t     info->default_power1);\n\tinfo->default_power2 = rt2800_txpower_to_dev(rt2x00dev, rf->channel,\n\t\t\t\t\t\t     info->default_power2);\n\tif (rt2x00dev->default_ant.tx_chain_num > 2)\n\t\tinfo->default_power3 =\n\t\t\trt2800_txpower_to_dev(rt2x00dev, rf->channel,\n\t\t\t\t\t      info->default_power3);\n\n\tswitch (rt2x00dev->chip.rt) {\n\tcase RT3883:\n\t\trt3883_bbp_adjust(rt2x00dev, rf);\n\t\tbreak;\n\t}\n\n\tswitch (rt2x00dev->chip.rf) {\n\tcase RF2020:\n\tcase RF3020:\n\tcase RF3021:\n\tcase RF3022:\n\tcase RF3320:\n\t\trt2800_config_channel_rf3xxx(rt2x00dev, conf, rf, info);\n\t\tbreak;\n\tcase RF3052:\n\t\trt2800_config_channel_rf3052(rt2x00dev, conf, rf, info);\n\t\tbreak;\n\tcase RF3053:\n\t\trt2800_config_channel_rf3053(rt2x00dev, conf, rf, info);\n\t\tbreak;\n\tcase RF3290:\n\t\trt2800_config_channel_rf3290(rt2x00dev, conf, rf, info);\n\t\tbreak;\n\tcase RF3322:\n\t\trt2800_config_channel_rf3322(rt2x00dev, conf, rf, info);\n\t\tbreak;\n\tcase RF3853:\n\t\trt2800_config_channel_rf3853(rt2x00dev, conf, rf, info);\n\t\tbreak;\n\tcase RF3070:\n\tcase RF5350:\n\tcase RF5360:\n\tcase RF5362:\n\tcase RF5370:\n\tcase RF5372:\n\tcase RF5390:\n\tcase RF5392:\n\t\trt2800_config_channel_rf53xx(rt2x00dev, conf, rf, info);\n\t\tbreak;\n\tcase RF5592:\n\t\trt2800_config_channel_rf55xx(rt2x00dev, conf, rf, info);\n\t\tbreak;\n\tcase RF7620:\n\t\trt2800_config_channel_rf7620(rt2x00dev, conf, rf, info);\n\t\tbreak;\n\tdefault:\n\t\trt2800_config_channel_rf2xxx(rt2x00dev, conf, rf, info);\n\t}\n\n\tif (rt2x00_rf(rt2x00dev, RF3070) ||\n\t    rt2x00_rf(rt2x00dev, RF3290) ||\n\t    rt2x00_rf(rt2x00dev, RF3322) ||\n\t    rt2x00_rf(rt2x00dev, RF5350) ||\n\t    rt2x00_rf(rt2x00dev, RF5360) ||\n\t    rt2x00_rf(rt2x00dev, RF5362) ||\n\t    rt2x00_rf(rt2x00dev, RF5370) ||\n\t    rt2x00_rf(rt2x00dev, RF5372) ||\n\t    rt2x00_rf(rt2x00dev, RF5390) ||\n\t    rt2x00_rf(rt2x00dev, RF5392)) {\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 30);\n\t\tif (rt2x00_rf(rt2x00dev, RF3322)) {\n\t\t\trt2x00_set_field8(&rfcsr, RF3322_RFCSR30_TX_H20M,\n\t\t\t\t\t  conf_is_ht40(conf));\n\t\t\trt2x00_set_field8(&rfcsr, RF3322_RFCSR30_RX_H20M,\n\t\t\t\t\t  conf_is_ht40(conf));\n\t\t} else {\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR30_TX_H20M,\n\t\t\t\t\t  conf_is_ht40(conf));\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR30_RX_H20M,\n\t\t\t\t\t  conf_is_ht40(conf));\n\t\t}\n\t\trt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\n\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 3);\n\t\trt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\n\t\trt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\n\t}\n\n\t \n\n\tif (rt2x00_rt(rt2x00dev, RT3352)) {\n\t\trt2800_bbp_write(rt2x00dev, 62, 0x37 - rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 63, 0x37 - rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 64, 0x37 - rt2x00dev->lna_gain);\n\n\t\trt2800_bbp_write(rt2x00dev, 27, 0x0);\n\t\trt2800_bbp_write(rt2x00dev, 66, 0x26 + rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 27, 0x20);\n\t\trt2800_bbp_write(rt2x00dev, 66, 0x26 + rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 86, 0x38);\n\t\trt2800_bbp_write(rt2x00dev, 83, 0x6a);\n\t} else if (rt2x00_rt(rt2x00dev, RT3593)) {\n\t\tif (rf->channel > 14) {\n\t\t\t \n\t\t\trt2800_bbp_write(rt2x00dev, 70, 0x00);\n\t\t} else {\n\t\t\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\t\t}\n\n\t\tif (conf_is_ht40(conf))\n\t\t\trt2800_bbp_write(rt2x00dev, 105, 0x04);\n\t\telse\n\t\t\trt2800_bbp_write(rt2x00dev, 105, 0x34);\n\n\t\trt2800_bbp_write(rt2x00dev, 62, 0x37 - rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 63, 0x37 - rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 64, 0x37 - rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 77, 0x98);\n\t} else if (rt2x00_rt(rt2x00dev, RT3883)) {\n\t\trt2800_bbp_write(rt2x00dev, 62, 0x37 - rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 63, 0x37 - rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 64, 0x37 - rt2x00dev->lna_gain);\n\n\t\tif (rt2x00dev->default_ant.rx_chain_num > 1)\n\t\t\trt2800_bbp_write(rt2x00dev, 86, 0x46);\n\t\telse\n\t\t\trt2800_bbp_write(rt2x00dev, 86, 0);\n\t} else {\n\t\trt2800_bbp_write(rt2x00dev, 62, 0x37 - rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 63, 0x37 - rt2x00dev->lna_gain);\n\t\trt2800_bbp_write(rt2x00dev, 64, 0x37 - rt2x00dev->lna_gain);\n\t\tif (rt2x00_rt(rt2x00dev, RT6352))\n\t\t\trt2800_bbp_write(rt2x00dev, 86, 0x38);\n\t\telse\n\t\t\trt2800_bbp_write(rt2x00dev, 86, 0);\n\t}\n\n\tif (rf->channel <= 14) {\n\t\tif (!rt2x00_rt(rt2x00dev, RT5390) &&\n\t\t    !rt2x00_rt(rt2x00dev, RT5392) &&\n\t\t    !rt2x00_rt(rt2x00dev, RT6352)) {\n\t\t\tif (rt2x00_has_cap_external_lna_bg(rt2x00dev)) {\n\t\t\t\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\t\t\t\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\t\t\t\trt2800_bbp_write(rt2x00dev, 75, 0x46);\n\t\t\t} else {\n\t\t\t\tif (rt2x00_rt(rt2x00dev, RT3593))\n\t\t\t\t\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\t\t\t\telse\n\t\t\t\t\trt2800_bbp_write(rt2x00dev, 82, 0x84);\n\t\t\t\trt2800_bbp_write(rt2x00dev, 75, 0x50);\n\t\t\t}\n\t\t\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t\t\t    rt2x00_rt(rt2x00dev, RT3883))\n\t\t\t\trt2800_bbp_write(rt2x00dev, 83, 0x8a);\n\t\t}\n\n\t} else {\n\t\tif (rt2x00_rt(rt2x00dev, RT3572))\n\t\t\trt2800_bbp_write(rt2x00dev, 82, 0x94);\n\t\telse if (rt2x00_rt(rt2x00dev, RT3593) ||\n\t\t\t rt2x00_rt(rt2x00dev, RT3883))\n\t\t\trt2800_bbp_write(rt2x00dev, 82, 0x82);\n\t\telse if (!rt2x00_rt(rt2x00dev, RT6352))\n\t\t\trt2800_bbp_write(rt2x00dev, 82, 0xf2);\n\n\t\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3883))\n\t\t\trt2800_bbp_write(rt2x00dev, 83, 0x9a);\n\n\t\tif (rt2x00_has_cap_external_lna_a(rt2x00dev))\n\t\t\trt2800_bbp_write(rt2x00dev, 75, 0x46);\n\t\telse\n\t\t\trt2800_bbp_write(rt2x00dev, 75, 0x50);\n\t}\n\n\treg = rt2800_register_read(rt2x00dev, TX_BAND_CFG);\n\trt2x00_set_field32(&reg, TX_BAND_CFG_HT40_MINUS, conf_is_ht40_minus(conf));\n\trt2x00_set_field32(&reg, TX_BAND_CFG_A, rf->channel > 14);\n\trt2x00_set_field32(&reg, TX_BAND_CFG_BG, rf->channel <= 14);\n\trt2800_register_write(rt2x00dev, TX_BAND_CFG, reg);\n\n\tif (rt2x00_rt(rt2x00dev, RT3572))\n\t\trt2800_rfcsr_write(rt2x00dev, 8, 0);\n\n\tif (rt2x00_rt(rt2x00dev, RT6352)) {\n\t\ttx_pin = rt2800_register_read(rt2x00dev, TX_PIN_CFG);\n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_RFRX_EN, 1);\n\t} else {\n\t\ttx_pin = 0;\n\t}\n\n\tswitch (rt2x00dev->default_ant.tx_chain_num) {\n\tcase 3:\n\t\t \n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A2_EN,\n\t\t\t\t   rf->channel > 14);\n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G2_EN,\n\t\t\t\t   rf->channel <= 14);\n\t\tfallthrough;\n\tcase 2:\n\t\t \n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A1_EN,\n\t\t\t\t   rf->channel > 14);\n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G1_EN,\n\t\t\t\t   rf->channel <= 14);\n\t\tfallthrough;\n\tcase 1:\n\t\t \n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A0_EN,\n\t\t\t\t   rf->channel > 14);\n\t\tif (rt2x00_has_cap_bt_coexist(rt2x00dev))\n\t\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G0_EN, 1);\n\t\telse\n\t\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G0_EN,\n\t\t\t\t\t   rf->channel <= 14);\n\t\tbreak;\n\t}\n\n\tswitch (rt2x00dev->default_ant.rx_chain_num) {\n\tcase 3:\n\t\t \n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_A2_EN, 1);\n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_G2_EN, 1);\n\t\tfallthrough;\n\tcase 2:\n\t\t \n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_A1_EN, 1);\n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_G1_EN, 1);\n\t\tfallthrough;\n\tcase 1:\n\t\t \n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_A0_EN, 1);\n\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_G0_EN, 1);\n\t\tbreak;\n\t}\n\n\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_RFTR_EN, 1);\n\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_TRSW_EN, 1);\n\n\trt2800_register_write(rt2x00dev, TX_PIN_CFG, tx_pin);\n\n\tif (rt2x00_rt(rt2x00dev, RT3572)) {\n\t\trt2800_rfcsr_write(rt2x00dev, 8, 0x80);\n\n\t\t \n\t\tif (rf->channel <= 14)\n\t\t\treg = 0x1c + (2 * rt2x00dev->lna_gain);\n\t\telse\n\t\t\treg = 0x22 + ((rt2x00dev->lna_gain * 5) / 3);\n\n\t\trt2800_bbp_write_with_rx_chain(rt2x00dev, 66, reg);\n\t}\n\n\tif (rt2x00_rt(rt2x00dev, RT3593)) {\n\t\treg = rt2800_register_read(rt2x00dev, GPIO_CTRL);\n\n\t\t \n\t\tif (rt2x00_is_usb(rt2x00dev) ||\n\t\t    rt2x00_is_pcie(rt2x00dev)) {\n\t\t\t \n\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_DIR8, 0);\n\t\t\tif (rf->channel <= 14)\n\t\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL8, 1);\n\t\t\telse\n\t\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL8, 0);\n\t\t}\n\n\t\t \n\t\tif (rt2x00_is_usb(rt2x00dev)) {\n\t\t\t \n\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_DIR4, 0);\n\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_DIR7, 0);\n\n\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL4, 1);\n\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL7, 1);\n\t\t} else if (rt2x00_is_pcie(rt2x00dev)) {\n\t\t\t \n\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_DIR4, 0);\n\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL4, 1);\n\t\t}\n\n\t\trt2800_register_write(rt2x00dev, GPIO_CTRL, reg);\n\n\t\t \n\t\tif (rf->channel <= 14)\n\t\t\treg = 0x1c + 2 * rt2x00dev->lna_gain;\n\t\telse\n\t\t\treg = 0x22 + ((rt2x00dev->lna_gain * 5) / 3);\n\n\t\trt2800_bbp_write_with_rx_chain(rt2x00dev, 66, reg);\n\n\t\tusleep_range(1000, 1500);\n\t}\n\n\tif (rt2x00_rt(rt2x00dev, RT3883)) {\n\t\tif (!conf_is_ht40(conf))\n\t\t\trt2800_bbp_write(rt2x00dev, 105, 0x34);\n\t\telse\n\t\t\trt2800_bbp_write(rt2x00dev, 105, 0x04);\n\n\t\t \n\t\tif (rf->channel <= 14)\n\t\t\treg = 0x2e + rt2x00dev->lna_gain;\n\t\telse\n\t\t\treg = 0x20 + ((rt2x00dev->lna_gain * 5) / 3);\n\n\t\trt2800_bbp_write_with_rx_chain(rt2x00dev, 66, reg);\n\n\t\tusleep_range(1000, 1500);\n\t}\n\n\tif (rt2x00_rt(rt2x00dev, RT5592) || rt2x00_rt(rt2x00dev, RT6352)) {\n\t\treg = 0x10;\n\t\tif (!conf_is_ht40(conf)) {\n\t\t\tif (rt2x00_rt(rt2x00dev, RT6352) &&\n\t\t\t    rt2x00_has_cap_external_lna_bg(rt2x00dev)) {\n\t\t\t\treg |= 0x5;\n\t\t\t} else {\n\t\t\t\treg |= 0xa;\n\t\t\t}\n\t\t}\n\t\trt2800_bbp_write(rt2x00dev, 195, 141);\n\t\trt2800_bbp_write(rt2x00dev, 196, reg);\n\n\t\t \n\t\treg = (rf->channel <= 14 ? 0x1c : 0x24) + 2*rt2x00dev->lna_gain;\n\t\trt2800_bbp_write_with_rx_chain(rt2x00dev, 66, reg);\n\n\t\tif (rt2x00_rt(rt2x00dev, RT5592))\n\t\t\trt2800_iq_calibrate(rt2x00dev, rf->channel);\n\t}\n\n\tif (rt2x00_rt(rt2x00dev, RT6352)) {\n\t\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0,\n\t\t\t     &rt2x00dev->cap_flags)) {\n\t\t\treg = rt2800_register_read(rt2x00dev, RF_CONTROL3);\n\t\t\treg |= 0x00000101;\n\t\t\trt2800_register_write(rt2x00dev, RF_CONTROL3, reg);\n\n\t\t\treg = rt2800_register_read(rt2x00dev, RF_BYPASS3);\n\t\t\treg |= 0x00000101;\n\t\t\trt2800_register_write(rt2x00dev, RF_BYPASS3, reg);\n\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 43, 0x73);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 44, 0x73);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 45, 0x73);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 46, 0x27);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 47, 0xC8);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 48, 0xA4);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 49, 0x05);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 54, 0x27);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 55, 0xC8);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 56, 0xA4);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 57, 0x05);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 58, 0x27);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 59, 0xC8);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 60, 0xA4);\n\t\t\trt2800_rfcsr_write_chanreg(rt2x00dev, 61, 0x05);\n\t\t\trt2800_rfcsr_write_dccal(rt2x00dev, 05, 0x00);\n\n\t\t\trt2800_register_write(rt2x00dev, TX0_RF_GAIN_CORRECT,\n\t\t\t\t\t      0x36303636);\n\t\t\trt2800_register_write(rt2x00dev, TX0_RF_GAIN_ATTEN,\n\t\t\t\t\t      0x6C6C6B6C);\n\t\t\trt2800_register_write(rt2x00dev, TX1_RF_GAIN_ATTEN,\n\t\t\t\t\t      0x6C6C6B6C);\n\t\t}\n\t}\n\n\tbbp = rt2800_bbp_read(rt2x00dev, 4);\n\trt2x00_set_field8(&bbp, BBP4_BANDWIDTH, 2 * conf_is_ht40(conf));\n\trt2800_bbp_write(rt2x00dev, 4, bbp);\n\n\tbbp = rt2800_bbp_read(rt2x00dev, 3);\n\trt2x00_set_field8(&bbp, BBP3_HT40_MINUS, conf_is_ht40_minus(conf));\n\trt2800_bbp_write(rt2x00dev, 3, bbp);\n\n\tif (rt2x00_rt_rev(rt2x00dev, RT2860, REV_RT2860C)) {\n\t\tif (conf_is_ht40(conf)) {\n\t\t\trt2800_bbp_write(rt2x00dev, 69, 0x1a);\n\t\t\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\t\t\trt2800_bbp_write(rt2x00dev, 73, 0x16);\n\t\t} else {\n\t\t\trt2800_bbp_write(rt2x00dev, 69, 0x16);\n\t\t\trt2800_bbp_write(rt2x00dev, 70, 0x08);\n\t\t\trt2800_bbp_write(rt2x00dev, 73, 0x11);\n\t\t}\n\t}\n\n\tusleep_range(1000, 1500);\n\n\t \n\treg = rt2800_register_read(rt2x00dev, CH_IDLE_STA);\n\treg = rt2800_register_read(rt2x00dev, CH_BUSY_STA);\n\treg = rt2800_register_read(rt2x00dev, CH_BUSY_STA_SEC);\n\n\t \n\tif (rt2x00_rt(rt2x00dev, RT3352) ||\n\t    rt2x00_rt(rt2x00dev, RT5350)) {\n\t\tbbp = rt2800_bbp_read(rt2x00dev, 49);\n\t\trt2x00_set_field8(&bbp, BBP49_UPDATE_FLAG, 0);\n\t\trt2800_bbp_write(rt2x00dev, 49, bbp);\n\t}\n}\n\nstatic int rt2800_get_gain_calibration_delta(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 tssi_bounds[9];\n\tu8 current_tssi;\n\tu16 eeprom;\n\tu8 step;\n\tint i;\n\n\t \n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1);\n\tif (!rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_EXTERNAL_TX_ALC))\n\t\treturn 0;\n\n\t \n\tif (rt2x00dev->curr_band == NL80211_BAND_2GHZ) {\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_BG1);\n\t\ttssi_bounds[0] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_BG1_MINUS4);\n\t\ttssi_bounds[1] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_BG1_MINUS3);\n\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_BG2);\n\t\ttssi_bounds[2] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_BG2_MINUS2);\n\t\ttssi_bounds[3] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_BG2_MINUS1);\n\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_BG3);\n\t\ttssi_bounds[4] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_BG3_REF);\n\t\ttssi_bounds[5] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_BG3_PLUS1);\n\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_BG4);\n\t\ttssi_bounds[6] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_BG4_PLUS2);\n\t\ttssi_bounds[7] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_BG4_PLUS3);\n\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_BG5);\n\t\ttssi_bounds[8] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_BG5_PLUS4);\n\n\t\tstep = rt2x00_get_field16(eeprom,\n\t\t\t\t\t  EEPROM_TSSI_BOUND_BG5_AGC_STEP);\n\t} else {\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_A1);\n\t\ttssi_bounds[0] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_A1_MINUS4);\n\t\ttssi_bounds[1] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_A1_MINUS3);\n\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_A2);\n\t\ttssi_bounds[2] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_A2_MINUS2);\n\t\ttssi_bounds[3] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_A2_MINUS1);\n\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_A3);\n\t\ttssi_bounds[4] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_A3_REF);\n\t\ttssi_bounds[5] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_A3_PLUS1);\n\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_A4);\n\t\ttssi_bounds[6] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_A4_PLUS2);\n\t\ttssi_bounds[7] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_A4_PLUS3);\n\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_A5);\n\t\ttssi_bounds[8] = rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_TSSI_BOUND_A5_PLUS4);\n\n\t\tstep = rt2x00_get_field16(eeprom,\n\t\t\t\t\t  EEPROM_TSSI_BOUND_A5_AGC_STEP);\n\t}\n\n\t \n\tif (tssi_bounds[4] == 0xff || step == 0xff)\n\t\treturn 0;\n\n\t \n\tcurrent_tssi = rt2800_bbp_read(rt2x00dev, 49);\n\n\t \n\tfor (i = 0; i <= 3; i++) {\n\t\tif (current_tssi > tssi_bounds[i])\n\t\t\tbreak;\n\t}\n\n\tif (i == 4) {\n\t\tfor (i = 8; i >= 5; i--) {\n\t\t\tif (current_tssi < tssi_bounds[i])\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn (i - 4) * step;\n}\n\nstatic int rt2800_get_txpower_bw_comp(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t      enum nl80211_band band)\n{\n\tu16 eeprom;\n\tu8 comp_en;\n\tu8 comp_type;\n\tint comp_value = 0;\n\n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_TXPOWER_DELTA);\n\n\t \n\tif (eeprom == 0xffff ||\n\t    !test_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags))\n\t\treturn 0;\n\n\tif (band == NL80211_BAND_2GHZ) {\n\t\tcomp_en = rt2x00_get_field16(eeprom,\n\t\t\t\t EEPROM_TXPOWER_DELTA_ENABLE_2G);\n\t\tif (comp_en) {\n\t\t\tcomp_type = rt2x00_get_field16(eeprom,\n\t\t\t\t\t   EEPROM_TXPOWER_DELTA_TYPE_2G);\n\t\t\tcomp_value = rt2x00_get_field16(eeprom,\n\t\t\t\t\t    EEPROM_TXPOWER_DELTA_VALUE_2G);\n\t\t\tif (!comp_type)\n\t\t\t\tcomp_value = -comp_value;\n\t\t}\n\t} else {\n\t\tcomp_en = rt2x00_get_field16(eeprom,\n\t\t\t\t EEPROM_TXPOWER_DELTA_ENABLE_5G);\n\t\tif (comp_en) {\n\t\t\tcomp_type = rt2x00_get_field16(eeprom,\n\t\t\t\t\t   EEPROM_TXPOWER_DELTA_TYPE_5G);\n\t\t\tcomp_value = rt2x00_get_field16(eeprom,\n\t\t\t\t\t    EEPROM_TXPOWER_DELTA_VALUE_5G);\n\t\t\tif (!comp_type)\n\t\t\t\tcomp_value = -comp_value;\n\t\t}\n\t}\n\n\treturn comp_value;\n}\n\nstatic int rt2800_get_txpower_reg_delta(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\tint power_level, int max_power)\n{\n\tint delta;\n\n\tif (rt2x00_has_cap_power_limit(rt2x00dev))\n\t\treturn 0;\n\n\t \n\tdelta = power_level - max_power;\n\treturn min(delta, 0);\n}\n\nstatic u8 rt2800_compensate_txpower(struct rt2x00_dev *rt2x00dev, int is_rate_b,\n\t\t\t\t   enum nl80211_band band, int power_level,\n\t\t\t\t   u8 txpower, int delta)\n{\n\tu16 eeprom;\n\tu8 criterion;\n\tu8 eirp_txpower;\n\tu8 eirp_txpower_criterion;\n\tu8 reg_limit;\n\n\tif (rt2x00_rt(rt2x00dev, RT3593))\n\t\treturn min_t(u8, txpower, 0xc);\n\n\tif (rt2x00_rt(rt2x00dev, RT3883))\n\t\treturn min_t(u8, txpower, 0xf);\n\n\tif (rt2x00_has_cap_power_limit(rt2x00dev)) {\n\t\t \n\t\teeprom = rt2800_eeprom_read_from_array(rt2x00dev,\n\t\t\t\t\t\t       EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t\t       1);\n\t\tcriterion = rt2x00_get_field16(eeprom,\n\t\t\t\t\t       EEPROM_TXPOWER_BYRATE_RATE0);\n\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_EIRP_MAX_TX_POWER);\n\n\t\tif (band == NL80211_BAND_2GHZ)\n\t\t\teirp_txpower_criterion = rt2x00_get_field16(eeprom,\n\t\t\t\t\t\t EEPROM_EIRP_MAX_TX_POWER_2GHZ);\n\t\telse\n\t\t\teirp_txpower_criterion = rt2x00_get_field16(eeprom,\n\t\t\t\t\t\t EEPROM_EIRP_MAX_TX_POWER_5GHZ);\n\n\t\teirp_txpower = eirp_txpower_criterion + (txpower - criterion) +\n\t\t\t       (is_rate_b ? 4 : 0) + delta;\n\n\t\treg_limit = (eirp_txpower > power_level) ?\n\t\t\t\t\t(eirp_txpower - power_level) : 0;\n\t} else\n\t\treg_limit = 0;\n\n\ttxpower = max(0, txpower + delta - reg_limit);\n\treturn min_t(u8, txpower, 0xc);\n}\n\n\nenum {\n\tTX_PWR_CFG_0_IDX,\n\tTX_PWR_CFG_1_IDX,\n\tTX_PWR_CFG_2_IDX,\n\tTX_PWR_CFG_3_IDX,\n\tTX_PWR_CFG_4_IDX,\n\tTX_PWR_CFG_5_IDX,\n\tTX_PWR_CFG_6_IDX,\n\tTX_PWR_CFG_7_IDX,\n\tTX_PWR_CFG_8_IDX,\n\tTX_PWR_CFG_9_IDX,\n\tTX_PWR_CFG_0_EXT_IDX,\n\tTX_PWR_CFG_1_EXT_IDX,\n\tTX_PWR_CFG_2_EXT_IDX,\n\tTX_PWR_CFG_3_EXT_IDX,\n\tTX_PWR_CFG_4_EXT_IDX,\n\tTX_PWR_CFG_IDX_COUNT,\n};\n\nstatic void rt2800_config_txpower_rt3593(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_channel *chan,\n\t\t\t\t\t int power_level)\n{\n\tu8 txpower;\n\tu16 eeprom;\n\tu32 regs[TX_PWR_CFG_IDX_COUNT];\n\tunsigned int offset;\n\tenum nl80211_band band = chan->band;\n\tint delta;\n\tint i;\n\n\tmemset(regs, '\\0', sizeof(regs));\n\n\t \n\n\t \n\tdelta = rt2800_get_gain_calibration_delta(rt2x00dev);\n\n\tif (band == NL80211_BAND_5GHZ)\n\t\toffset = 16;\n\telse\n\t\toffset = 0;\n\n\tif (test_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags))\n\t\toffset += 8;\n\n\t \n\teeprom = rt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t       offset);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 1, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\n\t\t\t   TX_PWR_CFG_0_CCK1_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\n\t\t\t   TX_PWR_CFG_0_CCK1_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_EXT_IDX],\n\t\t\t   TX_PWR_CFG_0_EXT_CCK1_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 1, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\n\t\t\t   TX_PWR_CFG_0_CCK5_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\n\t\t\t   TX_PWR_CFG_0_CCK5_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_EXT_IDX],\n\t\t\t   TX_PWR_CFG_0_EXT_CCK5_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\n\t\t\t   TX_PWR_CFG_0_OFDM6_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\n\t\t\t   TX_PWR_CFG_0_OFDM6_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_EXT_IDX],\n\t\t\t   TX_PWR_CFG_0_EXT_OFDM6_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE3);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\n\t\t\t   TX_PWR_CFG_0_OFDM12_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\n\t\t\t   TX_PWR_CFG_0_OFDM12_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_0_EXT_IDX],\n\t\t\t   TX_PWR_CFG_0_EXT_OFDM12_CH2, txpower);\n\n\t \n\teeprom = rt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t       offset + 1);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\n\t\t\t   TX_PWR_CFG_1_OFDM24_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\n\t\t\t   TX_PWR_CFG_1_OFDM24_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_EXT_IDX],\n\t\t\t   TX_PWR_CFG_1_EXT_OFDM24_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\n\t\t\t   TX_PWR_CFG_1_OFDM48_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\n\t\t\t   TX_PWR_CFG_1_OFDM48_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_EXT_IDX],\n\t\t\t   TX_PWR_CFG_1_EXT_OFDM48_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\n\t\t\t   TX_PWR_CFG_7_OFDM54_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\n\t\t\t   TX_PWR_CFG_7_OFDM54_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\n\t\t\t   TX_PWR_CFG_7_OFDM54_CH2, txpower);\n\n\t \n\teeprom = rt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t       offset + 2);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\n\t\t\t   TX_PWR_CFG_1_MCS0_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\n\t\t\t   TX_PWR_CFG_1_MCS0_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_EXT_IDX],\n\t\t\t   TX_PWR_CFG_1_EXT_MCS0_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\n\t\t\t   TX_PWR_CFG_1_MCS2_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\n\t\t\t   TX_PWR_CFG_1_MCS2_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_1_EXT_IDX],\n\t\t\t   TX_PWR_CFG_1_EXT_MCS2_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\n\t\t\t   TX_PWR_CFG_2_MCS4_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\n\t\t\t   TX_PWR_CFG_2_MCS4_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_EXT_IDX],\n\t\t\t   TX_PWR_CFG_2_EXT_MCS4_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE3);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\n\t\t\t   TX_PWR_CFG_2_MCS6_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\n\t\t\t   TX_PWR_CFG_2_MCS6_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_EXT_IDX],\n\t\t\t   TX_PWR_CFG_2_EXT_MCS6_CH2, txpower);\n\n\t \n\teeprom = rt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t       offset + 3);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\n\t\t\t   TX_PWR_CFG_7_MCS7_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\n\t\t\t   TX_PWR_CFG_7_MCS7_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\n\t\t\t   TX_PWR_CFG_7_MCS7_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\n\t\t\t   TX_PWR_CFG_2_MCS8_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\n\t\t\t   TX_PWR_CFG_2_MCS8_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_EXT_IDX],\n\t\t\t   TX_PWR_CFG_2_EXT_MCS8_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\n\t\t\t   TX_PWR_CFG_2_MCS10_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\n\t\t\t   TX_PWR_CFG_2_MCS10_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_2_EXT_IDX],\n\t\t\t   TX_PWR_CFG_2_EXT_MCS10_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE3);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\n\t\t\t   TX_PWR_CFG_3_MCS12_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\n\t\t\t   TX_PWR_CFG_3_MCS12_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_EXT_IDX],\n\t\t\t   TX_PWR_CFG_3_EXT_MCS12_CH2, txpower);\n\n\t \n\teeprom = rt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t       offset + 4);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\n\t\t\t   TX_PWR_CFG_3_MCS14_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\n\t\t\t   TX_PWR_CFG_3_MCS14_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_EXT_IDX],\n\t\t\t   TX_PWR_CFG_3_EXT_MCS14_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\n\t\t\t   TX_PWR_CFG_8_MCS15_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\n\t\t\t   TX_PWR_CFG_8_MCS15_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\n\t\t\t   TX_PWR_CFG_8_MCS15_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\n\t\t\t   TX_PWR_CFG_5_MCS16_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\n\t\t\t   TX_PWR_CFG_5_MCS16_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\n\t\t\t   TX_PWR_CFG_5_MCS16_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE3);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\n\t\t\t   TX_PWR_CFG_5_MCS18_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\n\t\t\t   TX_PWR_CFG_5_MCS18_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\n\t\t\t   TX_PWR_CFG_5_MCS18_CH2, txpower);\n\n\t \n\teeprom = rt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t       offset + 5);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\n\t\t\t   TX_PWR_CFG_6_MCS20_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\n\t\t\t   TX_PWR_CFG_6_MCS20_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\n\t\t\t   TX_PWR_CFG_6_MCS20_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\n\t\t\t   TX_PWR_CFG_6_MCS22_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\n\t\t\t   TX_PWR_CFG_6_MCS22_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\n\t\t\t   TX_PWR_CFG_6_MCS22_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\n\t\t\t   TX_PWR_CFG_8_MCS23_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\n\t\t\t   TX_PWR_CFG_8_MCS23_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\n\t\t\t   TX_PWR_CFG_8_MCS23_CH2, txpower);\n\n\t \n\teeprom = rt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t       offset + 6);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\n\t\t\t   TX_PWR_CFG_3_STBC0_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\n\t\t\t   TX_PWR_CFG_3_STBC0_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_EXT_IDX],\n\t\t\t   TX_PWR_CFG_3_EXT_STBC0_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\n\t\t\t   TX_PWR_CFG_3_STBC2_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\n\t\t\t   TX_PWR_CFG_3_STBC2_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_3_EXT_IDX],\n\t\t\t   TX_PWR_CFG_3_EXT_STBC2_CH2, txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_4_IDX], TX_PWR_CFG_RATE0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_4_IDX], TX_PWR_CFG_RATE1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_4_EXT_IDX], TX_PWR_CFG_RATE0,\n\t\t\t   txpower);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE3);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_4_IDX], TX_PWR_CFG_RATE2, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_4_IDX], TX_PWR_CFG_RATE3, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_4_EXT_IDX], TX_PWR_CFG_RATE2,\n\t\t\t   txpower);\n\n\t \n\teeprom = rt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t       offset + 7);\n\n\t \n\ttxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\n\ttxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\n\t\t\t\t\t    txpower, delta);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_9_IDX],\n\t\t\t   TX_PWR_CFG_9_STBC7_CH0, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_9_IDX],\n\t\t\t   TX_PWR_CFG_9_STBC7_CH1, txpower);\n\trt2x00_set_field32(&regs[TX_PWR_CFG_9_IDX],\n\t\t\t   TX_PWR_CFG_9_STBC7_CH2, txpower);\n\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_0, regs[TX_PWR_CFG_0_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_1, regs[TX_PWR_CFG_1_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_2, regs[TX_PWR_CFG_2_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_3, regs[TX_PWR_CFG_3_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_4, regs[TX_PWR_CFG_4_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_5, regs[TX_PWR_CFG_5_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_6, regs[TX_PWR_CFG_6_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_7, regs[TX_PWR_CFG_7_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_8, regs[TX_PWR_CFG_8_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_9, regs[TX_PWR_CFG_9_IDX]);\n\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_0_EXT,\n\t\t\t      regs[TX_PWR_CFG_0_EXT_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_1_EXT,\n\t\t\t      regs[TX_PWR_CFG_1_EXT_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_2_EXT,\n\t\t\t      regs[TX_PWR_CFG_2_EXT_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_3_EXT,\n\t\t\t      regs[TX_PWR_CFG_3_EXT_IDX]);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_4_EXT,\n\t\t\t      regs[TX_PWR_CFG_4_EXT_IDX]);\n\n\tfor (i = 0; i < TX_PWR_CFG_IDX_COUNT; i++)\n\t\trt2x00_dbg(rt2x00dev,\n\t\t\t   \"band:%cGHz, BW:%c0MHz, TX_PWR_CFG_%d%s = %08lx\\n\",\n\t\t\t   (band == NL80211_BAND_5GHZ) ? '5' : '2',\n\t\t\t   (test_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags)) ?\n\t\t\t\t\t\t\t\t'4' : '2',\n\t\t\t   (i > TX_PWR_CFG_9_IDX) ?\n\t\t\t\t\t(i - TX_PWR_CFG_9_IDX - 1) : i,\n\t\t\t   (i > TX_PWR_CFG_9_IDX) ? \"_EXT\" : \"\",\n\t\t\t   (unsigned long) regs[i]);\n}\n\nstatic void rt2800_config_txpower_rt6352(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_channel *chan,\n\t\t\t\t\t int power_level)\n{\n\tu32 reg, pwreg;\n\tu16 eeprom;\n\tu32 data, gdata;\n\tu8 t, i;\n\tenum nl80211_band band = chan->band;\n\tint delta;\n\n\t \n\tdelta = rt2800_get_txpower_bw_comp(rt2x00dev, band);\n\n\tif (delta)\n\t\trt2x00_warn(rt2x00dev, \"ignoring EEPROM HT40 power delta: %d\\n\",\n\t\t\t    delta);\n\n\t \n\tfor (i = 0; i < 5; i++) {\n\t\teeprom = rt2800_eeprom_read_from_array(rt2x00dev,\n\t\t\t\t\t\t       EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t\t       i * 2);\n\n\t\tdata = eeprom;\n\n\t\tt = eeprom & 0x3f;\n\t\tif (t == 32)\n\t\t\tt++;\n\n\t\tgdata = t;\n\n\t\tt = (eeprom & 0x3f00) >> 8;\n\t\tif (t == 32)\n\t\t\tt++;\n\n\t\tgdata |= (t << 8);\n\n\t\teeprom = rt2800_eeprom_read_from_array(rt2x00dev,\n\t\t\t\t\t\t       EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t\t       (i * 2) + 1);\n\n\t\tt = eeprom & 0x3f;\n\t\tif (t == 32)\n\t\t\tt++;\n\n\t\tgdata |= (t << 16);\n\n\t\tt = (eeprom & 0x3f00) >> 8;\n\t\tif (t == 32)\n\t\t\tt++;\n\n\t\tgdata |= (t << 24);\n\t\tdata |= (eeprom << 16);\n\n\t\tif (!test_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags)) {\n\t\t\t \n\t\t\tif (data != 0xffffffff)\n\t\t\t\trt2800_register_write(rt2x00dev,\n\t\t\t\t\t\t      TX_PWR_CFG_0 + (i * 4),\n\t\t\t\t\t\t      data);\n\t\t} else {\n\t\t\t \n\t\t\tif (gdata != 0xffffffff)\n\t\t\t\trt2800_register_write(rt2x00dev,\n\t\t\t\t\t\t      TX_PWR_CFG_0 + (i * 4),\n\t\t\t\t\t\t      gdata);\n\t\t}\n\t}\n\n\t \n\n\t \n\tpwreg = 0;\n\treg = rt2800_register_read(rt2x00dev, TX_PWR_CFG_1);\n\tt = rt2x00_get_field32(reg, TX_PWR_CFG_1B_48MBS);\n\trt2x00_set_field32(&pwreg, TX_PWR_CFG_7B_54MBS, t);\n\n\t \n\treg = rt2800_register_read(rt2x00dev, TX_PWR_CFG_2);\n\tt = rt2x00_get_field32(reg, TX_PWR_CFG_2B_MCS6_MCS7);\n\trt2x00_set_field32(&pwreg, TX_PWR_CFG_7B_MCS7, t);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_7, pwreg);\n\n\t \n\tpwreg = 0;\n\treg = rt2800_register_read(rt2x00dev, TX_PWR_CFG_3);\n\tt = rt2x00_get_field32(reg, TX_PWR_CFG_3B_MCS14);\n\trt2x00_set_field32(&pwreg, TX_PWR_CFG_8B_MCS15, t);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_8, pwreg);\n\n\t \n\tpwreg = 0;\n\treg = rt2800_register_read(rt2x00dev, TX_PWR_CFG_4);\n\tt = rt2x00_get_field32(reg, TX_PWR_CFG_4B_STBC_MCS6);\n\trt2x00_set_field32(&pwreg, TX_PWR_CFG_9B_STBC_MCS7, t);\n\trt2800_register_write(rt2x00dev, TX_PWR_CFG_9, pwreg);\n\n\trt2800_config_alc_rt6352(rt2x00dev, chan, power_level);\n\n\t \n}\n\n \nstatic void rt2800_config_txpower_rt28xx(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t struct ieee80211_channel *chan,\n\t\t\t\t\t int power_level)\n{\n\tu8 txpower, r1;\n\tu16 eeprom;\n\tu32 reg, offset;\n\tint i, is_rate_b, delta, power_ctrl;\n\tenum nl80211_band band = chan->band;\n\n\t \n\tdelta = rt2800_get_txpower_bw_comp(rt2x00dev, band);\n\n\t \n\tswitch (rt2x00dev->chip.rt) {\n\tcase RT2860:\n\tcase RT2872:\n\tcase RT2883:\n\tcase RT3070:\n\tcase RT3071:\n\tcase RT3090:\n\tcase RT3572:\n\t\tdelta += rt2800_get_gain_calibration_delta(rt2x00dev);\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tbreak;\n\t}\n\n\t \n\tdelta += rt2800_get_txpower_reg_delta(rt2x00dev, power_level,\n\t\t\t\t\t      chan->max_power);\n\n\t \n\tif (delta <= -12) {\n\t\tpower_ctrl = 2;\n\t\tdelta += 12;\n\t} else if (delta <= -6) {\n\t\tpower_ctrl = 1;\n\t\tdelta += 6;\n\t} else {\n\t\tpower_ctrl = 0;\n\t}\n\tr1 = rt2800_bbp_read(rt2x00dev, 1);\n\trt2x00_set_field8(&r1, BBP1_TX_POWER_CTRL, power_ctrl);\n\trt2800_bbp_write(rt2x00dev, 1, r1);\n\n\toffset = TX_PWR_CFG_0;\n\n\tfor (i = 0; i < EEPROM_TXPOWER_BYRATE_SIZE; i += 2) {\n\t\t \n\t\tif (offset > TX_PWR_CFG_4)\n\t\t\tbreak;\n\n\t\treg = rt2800_register_read(rt2x00dev, offset);\n\n\t\t \n\t\teeprom = rt2800_eeprom_read_from_array(rt2x00dev,\n\t\t\t\t\t\t       EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t\t       i);\n\n\t\tis_rate_b = i ? 0 : 1;\n\t\t \n\t\ttxpower = rt2x00_get_field16(eeprom,\n\t\t\t\t\t     EEPROM_TXPOWER_BYRATE_RATE0);\n\t\ttxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\n\t\t\t\t\t     power_level, txpower, delta);\n\t\trt2x00_set_field32(&reg, TX_PWR_CFG_RATE0, txpower);\n\n\t\t \n\t\ttxpower = rt2x00_get_field16(eeprom,\n\t\t\t\t\t     EEPROM_TXPOWER_BYRATE_RATE1);\n\t\ttxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\n\t\t\t\t\t     power_level, txpower, delta);\n\t\trt2x00_set_field32(&reg, TX_PWR_CFG_RATE1, txpower);\n\n\t\t \n\t\ttxpower = rt2x00_get_field16(eeprom,\n\t\t\t\t\t     EEPROM_TXPOWER_BYRATE_RATE2);\n\t\ttxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\n\t\t\t\t\t     power_level, txpower, delta);\n\t\trt2x00_set_field32(&reg, TX_PWR_CFG_RATE2, txpower);\n\n\t\t \n\t\ttxpower = rt2x00_get_field16(eeprom,\n\t\t\t\t\t     EEPROM_TXPOWER_BYRATE_RATE3);\n\t\ttxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\n\t\t\t\t\t     power_level, txpower, delta);\n\t\trt2x00_set_field32(&reg, TX_PWR_CFG_RATE3, txpower);\n\n\t\t \n\t\teeprom = rt2800_eeprom_read_from_array(rt2x00dev,\n\t\t\t\t\t\t       EEPROM_TXPOWER_BYRATE,\n\t\t\t\t\t\t       i + 1);\n\n\t\tis_rate_b = 0;\n\t\t \n\t\ttxpower = rt2x00_get_field16(eeprom,\n\t\t\t\t\t     EEPROM_TXPOWER_BYRATE_RATE0);\n\t\ttxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\n\t\t\t\t\t     power_level, txpower, delta);\n\t\trt2x00_set_field32(&reg, TX_PWR_CFG_RATE4, txpower);\n\n\t\t \n\t\ttxpower = rt2x00_get_field16(eeprom,\n\t\t\t\t\t     EEPROM_TXPOWER_BYRATE_RATE1);\n\t\ttxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\n\t\t\t\t\t     power_level, txpower, delta);\n\t\trt2x00_set_field32(&reg, TX_PWR_CFG_RATE5, txpower);\n\n\t\t \n\t\ttxpower = rt2x00_get_field16(eeprom,\n\t\t\t\t\t     EEPROM_TXPOWER_BYRATE_RATE2);\n\t\ttxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\n\t\t\t\t\t     power_level, txpower, delta);\n\t\trt2x00_set_field32(&reg, TX_PWR_CFG_RATE6, txpower);\n\n\t\t \n\t\ttxpower = rt2x00_get_field16(eeprom,\n\t\t\t\t\t     EEPROM_TXPOWER_BYRATE_RATE3);\n\t\ttxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\n\t\t\t\t\t     power_level, txpower, delta);\n\t\trt2x00_set_field32(&reg, TX_PWR_CFG_RATE7, txpower);\n\n\t\trt2800_register_write(rt2x00dev, offset, reg);\n\n\t\t \n\t\toffset += 4;\n\t}\n}\n\nstatic void rt2800_config_txpower(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t  struct ieee80211_channel *chan,\n\t\t\t\t  int power_level)\n{\n\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t    rt2x00_rt(rt2x00dev, RT3883))\n\t\trt2800_config_txpower_rt3593(rt2x00dev, chan, power_level);\n\telse if (rt2x00_rt(rt2x00dev, RT6352))\n\t\trt2800_config_txpower_rt6352(rt2x00dev, chan, power_level);\n\telse\n\t\trt2800_config_txpower_rt28xx(rt2x00dev, chan, power_level);\n}\n\nvoid rt2800_gain_calibration(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_config_txpower(rt2x00dev, rt2x00dev->hw->conf.chandef.chan,\n\t\t\t      rt2x00dev->tx_power);\n}\nEXPORT_SYMBOL_GPL(rt2800_gain_calibration);\n\nvoid rt2800_vco_calibration(struct rt2x00_dev *rt2x00dev)\n{\n\tu32\ttx_pin;\n\tu8\trfcsr;\n\tunsigned long min_sleep = 0;\n\n\t \n\n\ttx_pin = rt2800_register_read(rt2x00dev, TX_PIN_CFG);\n\ttx_pin &= TX_PIN_CFG_PA_PE_DISABLE;\n\trt2800_register_write(rt2x00dev, TX_PIN_CFG, tx_pin);\n\n\tswitch (rt2x00dev->chip.rf) {\n\tcase RF2020:\n\tcase RF3020:\n\tcase RF3021:\n\tcase RF3022:\n\tcase RF3320:\n\tcase RF3052:\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 7);\n\t\trt2x00_set_field8(&rfcsr, RFCSR7_RF_TUNING, 1);\n\t\trt2800_rfcsr_write(rt2x00dev, 7, rfcsr);\n\t\tbreak;\n\tcase RF3053:\n\tcase RF3070:\n\tcase RF3290:\n\tcase RF3853:\n\tcase RF5350:\n\tcase RF5360:\n\tcase RF5362:\n\tcase RF5370:\n\tcase RF5372:\n\tcase RF5390:\n\tcase RF5392:\n\tcase RF5592:\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 3);\n\t\trt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\n\t\trt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\n\t\tmin_sleep = 1000;\n\t\tbreak;\n\tcase RF7620:\n\t\trt2800_rfcsr_write(rt2x00dev, 5, 0x40);\n\t\trt2800_rfcsr_write(rt2x00dev, 4, 0x0C);\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 4);\n\t\trt2x00_set_field8(&rfcsr, RFCSR4_VCOCAL_EN, 1);\n\t\trt2800_rfcsr_write(rt2x00dev, 4, rfcsr);\n\t\tmin_sleep = 2000;\n\t\tbreak;\n\tdefault:\n\t\tWARN_ONCE(1, \"Not supported RF chipset %x for VCO recalibration\",\n\t\t\t  rt2x00dev->chip.rf);\n\t\treturn;\n\t}\n\n\tif (min_sleep > 0)\n\t\tusleep_range(min_sleep, min_sleep * 2);\n\n\ttx_pin = rt2800_register_read(rt2x00dev, TX_PIN_CFG);\n\tif (rt2x00dev->rf_channel <= 14) {\n\t\tswitch (rt2x00dev->default_ant.tx_chain_num) {\n\t\tcase 3:\n\t\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G2_EN, 1);\n\t\t\tfallthrough;\n\t\tcase 2:\n\t\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G1_EN, 1);\n\t\t\tfallthrough;\n\t\tcase 1:\n\t\tdefault:\n\t\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G0_EN, 1);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tswitch (rt2x00dev->default_ant.tx_chain_num) {\n\t\tcase 3:\n\t\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A2_EN, 1);\n\t\t\tfallthrough;\n\t\tcase 2:\n\t\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A1_EN, 1);\n\t\t\tfallthrough;\n\t\tcase 1:\n\t\tdefault:\n\t\t\trt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A0_EN, 1);\n\t\t\tbreak;\n\t\t}\n\t}\n\trt2800_register_write(rt2x00dev, TX_PIN_CFG, tx_pin);\n\n\tif (rt2x00_rt(rt2x00dev, RT6352)) {\n\t\tif (rt2x00dev->default_ant.rx_chain_num == 1) {\n\t\t\trt2800_bbp_write(rt2x00dev, 91, 0x07);\n\t\t\trt2800_bbp_write(rt2x00dev, 95, 0x1A);\n\t\t\trt2800_bbp_write(rt2x00dev, 195, 128);\n\t\t\trt2800_bbp_write(rt2x00dev, 196, 0xA0);\n\t\t\trt2800_bbp_write(rt2x00dev, 195, 170);\n\t\t\trt2800_bbp_write(rt2x00dev, 196, 0x12);\n\t\t\trt2800_bbp_write(rt2x00dev, 195, 171);\n\t\t\trt2800_bbp_write(rt2x00dev, 196, 0x10);\n\t\t} else {\n\t\t\trt2800_bbp_write(rt2x00dev, 91, 0x06);\n\t\t\trt2800_bbp_write(rt2x00dev, 95, 0x9A);\n\t\t\trt2800_bbp_write(rt2x00dev, 195, 128);\n\t\t\trt2800_bbp_write(rt2x00dev, 196, 0xE0);\n\t\t\trt2800_bbp_write(rt2x00dev, 195, 170);\n\t\t\trt2800_bbp_write(rt2x00dev, 196, 0x30);\n\t\t\trt2800_bbp_write(rt2x00dev, 195, 171);\n\t\t\trt2800_bbp_write(rt2x00dev, 196, 0x30);\n\t\t}\n\n\t\tif (rt2x00_has_cap_external_lna_bg(rt2x00dev)) {\n\t\t\trt2800_bbp_write(rt2x00dev, 75, 0x68);\n\t\t\trt2800_bbp_write(rt2x00dev, 76, 0x4C);\n\t\t\trt2800_bbp_write(rt2x00dev, 79, 0x1C);\n\t\t\trt2800_bbp_write(rt2x00dev, 80, 0x0C);\n\t\t\trt2800_bbp_write(rt2x00dev, 82, 0xB6);\n\t\t}\n\n\t\t \n\t\tusleep_range(1000, 1500);\n\t}\n}\nEXPORT_SYMBOL_GPL(rt2800_vco_calibration);\n\nstatic void rt2800_config_retry_limit(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t      struct rt2x00lib_conf *libconf)\n{\n\tu32 reg;\n\n\treg = rt2800_register_read(rt2x00dev, TX_RTY_CFG);\n\trt2x00_set_field32(&reg, TX_RTY_CFG_SHORT_RTY_LIMIT,\n\t\t\t   libconf->conf->short_frame_max_tx_count);\n\trt2x00_set_field32(&reg, TX_RTY_CFG_LONG_RTY_LIMIT,\n\t\t\t   libconf->conf->long_frame_max_tx_count);\n\trt2800_register_write(rt2x00dev, TX_RTY_CFG, reg);\n}\n\nstatic void rt2800_config_ps(struct rt2x00_dev *rt2x00dev,\n\t\t\t     struct rt2x00lib_conf *libconf)\n{\n\tenum dev_state state =\n\t    (libconf->conf->flags & IEEE80211_CONF_PS) ?\n\t\tSTATE_SLEEP : STATE_AWAKE;\n\tu32 reg;\n\n\tif (state == STATE_SLEEP) {\n\t\trt2800_register_write(rt2x00dev, AUTOWAKEUP_CFG, 0);\n\n\t\treg = rt2800_register_read(rt2x00dev, AUTOWAKEUP_CFG);\n\t\trt2x00_set_field32(&reg, AUTOWAKEUP_CFG_AUTO_LEAD_TIME, 5);\n\t\trt2x00_set_field32(&reg, AUTOWAKEUP_CFG_TBCN_BEFORE_WAKE,\n\t\t\t\t   libconf->conf->listen_interval - 1);\n\t\trt2x00_set_field32(&reg, AUTOWAKEUP_CFG_AUTOWAKE, 1);\n\t\trt2800_register_write(rt2x00dev, AUTOWAKEUP_CFG, reg);\n\n\t\trt2x00dev->ops->lib->set_device_state(rt2x00dev, state);\n\t} else {\n\t\treg = rt2800_register_read(rt2x00dev, AUTOWAKEUP_CFG);\n\t\trt2x00_set_field32(&reg, AUTOWAKEUP_CFG_AUTO_LEAD_TIME, 0);\n\t\trt2x00_set_field32(&reg, AUTOWAKEUP_CFG_TBCN_BEFORE_WAKE, 0);\n\t\trt2x00_set_field32(&reg, AUTOWAKEUP_CFG_AUTOWAKE, 0);\n\t\trt2800_register_write(rt2x00dev, AUTOWAKEUP_CFG, reg);\n\n\t\trt2x00dev->ops->lib->set_device_state(rt2x00dev, state);\n\t}\n}\n\nvoid rt2800_config(struct rt2x00_dev *rt2x00dev,\n\t\t   struct rt2x00lib_conf *libconf,\n\t\t   const unsigned int flags)\n{\n\t \n\trt2800_config_lna_gain(rt2x00dev, libconf);\n\n\tif (flags & IEEE80211_CONF_CHANGE_CHANNEL) {\n\t\t \n\t\trt2800_update_survey(rt2x00dev);\n\n\t\trt2800_config_channel(rt2x00dev, libconf->conf,\n\t\t\t\t      &libconf->rf, &libconf->channel);\n\t\trt2800_config_txpower(rt2x00dev, libconf->conf->chandef.chan,\n\t\t\t\t      libconf->conf->power_level);\n\t}\n\tif (flags & IEEE80211_CONF_CHANGE_POWER)\n\t\trt2800_config_txpower(rt2x00dev, libconf->conf->chandef.chan,\n\t\t\t\t      libconf->conf->power_level);\n\tif (flags & IEEE80211_CONF_CHANGE_RETRY_LIMITS)\n\t\trt2800_config_retry_limit(rt2x00dev, libconf);\n\tif (flags & IEEE80211_CONF_CHANGE_PS)\n\t\trt2800_config_ps(rt2x00dev, libconf);\n}\nEXPORT_SYMBOL_GPL(rt2800_config);\n\n \nvoid rt2800_link_stats(struct rt2x00_dev *rt2x00dev, struct link_qual *qual)\n{\n\tu32 reg;\n\n\t \n\treg = rt2800_register_read(rt2x00dev, RX_STA_CNT0);\n\tqual->rx_failed = rt2x00_get_field32(reg, RX_STA_CNT0_CRC_ERR);\n}\nEXPORT_SYMBOL_GPL(rt2800_link_stats);\n\nstatic u8 rt2800_get_default_vgc(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 vgc;\n\n\tif (rt2x00dev->curr_band == NL80211_BAND_2GHZ) {\n\t\tif (rt2x00_rt(rt2x00dev, RT3070) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3071) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3090) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3290) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3390) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3572) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3593) ||\n\t\t    rt2x00_rt(rt2x00dev, RT5390) ||\n\t\t    rt2x00_rt(rt2x00dev, RT5392) ||\n\t\t    rt2x00_rt(rt2x00dev, RT5592) ||\n\t\t    rt2x00_rt(rt2x00dev, RT6352))\n\t\t\tvgc = 0x1c + (2 * rt2x00dev->lna_gain);\n\t\telse\n\t\t\tvgc = 0x2e + rt2x00dev->lna_gain;\n\t} else {  \n\t\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3883))\n\t\t\tvgc = 0x20 + (rt2x00dev->lna_gain * 5) / 3;\n\t\telse if (rt2x00_rt(rt2x00dev, RT5592))\n\t\t\tvgc = 0x24 + (2 * rt2x00dev->lna_gain);\n\t\telse {\n\t\t\tif (!test_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags))\n\t\t\t\tvgc = 0x32 + (rt2x00dev->lna_gain * 5) / 3;\n\t\t\telse\n\t\t\t\tvgc = 0x3a + (rt2x00dev->lna_gain * 5) / 3;\n\t\t}\n\t}\n\n\treturn vgc;\n}\n\nstatic inline void rt2800_set_vgc(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t  struct link_qual *qual, u8 vgc_level)\n{\n\tif (qual->vgc_level != vgc_level) {\n\t\tif (rt2x00_rt(rt2x00dev, RT3572) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3593) ||\n\t\t    rt2x00_rt(rt2x00dev, RT3883) ||\n\t\t    rt2x00_rt(rt2x00dev, RT6352)) {\n\t\t\trt2800_bbp_write_with_rx_chain(rt2x00dev, 66,\n\t\t\t\t\t\t       vgc_level);\n\t\t} else if (rt2x00_rt(rt2x00dev, RT5592)) {\n\t\t\trt2800_bbp_write(rt2x00dev, 83, qual->rssi > -65 ? 0x4a : 0x7a);\n\t\t\trt2800_bbp_write_with_rx_chain(rt2x00dev, 66, vgc_level);\n\t\t} else {\n\t\t\trt2800_bbp_write(rt2x00dev, 66, vgc_level);\n\t\t}\n\n\t\tqual->vgc_level = vgc_level;\n\t\tqual->vgc_level_reg = vgc_level;\n\t}\n}\n\nvoid rt2800_reset_tuner(struct rt2x00_dev *rt2x00dev, struct link_qual *qual)\n{\n\trt2800_set_vgc(rt2x00dev, qual, rt2800_get_default_vgc(rt2x00dev));\n}\nEXPORT_SYMBOL_GPL(rt2800_reset_tuner);\n\nvoid rt2800_link_tuner(struct rt2x00_dev *rt2x00dev, struct link_qual *qual,\n\t\t       const u32 count)\n{\n\tu8 vgc;\n\n\tif (rt2x00_rt_rev(rt2x00dev, RT2860, REV_RT2860C))\n\t\treturn;\n\n\t \n\n\tvgc = rt2800_get_default_vgc(rt2x00dev);\n\n\tswitch (rt2x00dev->chip.rt) {\n\tcase RT3572:\n\tcase RT3593:\n\t\tif (qual->rssi > -65) {\n\t\t\tif (rt2x00dev->curr_band == NL80211_BAND_2GHZ)\n\t\t\t\tvgc += 0x20;\n\t\t\telse\n\t\t\t\tvgc += 0x10;\n\t\t}\n\t\tbreak;\n\n\tcase RT3883:\n\t\tif (qual->rssi > -65)\n\t\t\tvgc += 0x10;\n\t\tbreak;\n\n\tcase RT5592:\n\t\tif (qual->rssi > -65)\n\t\t\tvgc += 0x20;\n\t\tbreak;\n\n\tdefault:\n\t\tif (qual->rssi > -80)\n\t\t\tvgc += 0x10;\n\t\tbreak;\n\t}\n\n\trt2800_set_vgc(rt2x00dev, qual, vgc);\n}\nEXPORT_SYMBOL_GPL(rt2800_link_tuner);\n\n \nstatic int rt2800_init_registers(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu32 reg;\n\tu16 eeprom;\n\tunsigned int i;\n\tint ret;\n\n\trt2800_disable_wpdma(rt2x00dev);\n\n\tret = rt2800_drv_init_registers(rt2x00dev);\n\tif (ret)\n\t\treturn ret;\n\n\trt2800_register_write(rt2x00dev, LEGACY_BASIC_RATE, 0x0000013f);\n\trt2800_register_write(rt2x00dev, HT_BASIC_RATE, 0x00008003);\n\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, 0x00000000);\n\n\treg = rt2800_register_read(rt2x00dev, BCN_TIME_CFG);\n\trt2x00_set_field32(&reg, BCN_TIME_CFG_BEACON_INTERVAL, 1600);\n\trt2x00_set_field32(&reg, BCN_TIME_CFG_TSF_TICKING, 0);\n\trt2x00_set_field32(&reg, BCN_TIME_CFG_TSF_SYNC, 0);\n\trt2x00_set_field32(&reg, BCN_TIME_CFG_TBTT_ENABLE, 0);\n\trt2x00_set_field32(&reg, BCN_TIME_CFG_BEACON_GEN, 0);\n\trt2x00_set_field32(&reg, BCN_TIME_CFG_TX_TIME_COMPENSATE, 0);\n\trt2800_register_write(rt2x00dev, BCN_TIME_CFG, reg);\n\n\trt2800_config_filter(rt2x00dev, FIF_ALLMULTI);\n\n\treg = rt2800_register_read(rt2x00dev, BKOFF_SLOT_CFG);\n\trt2x00_set_field32(&reg, BKOFF_SLOT_CFG_SLOT_TIME, 9);\n\trt2x00_set_field32(&reg, BKOFF_SLOT_CFG_CC_DELAY_TIME, 2);\n\trt2800_register_write(rt2x00dev, BKOFF_SLOT_CFG, reg);\n\n\tif (rt2x00_rt(rt2x00dev, RT3290)) {\n\t\treg = rt2800_register_read(rt2x00dev, WLAN_FUN_CTRL);\n\t\tif (rt2x00_get_field32(reg, WLAN_EN) == 1) {\n\t\t\trt2x00_set_field32(&reg, PCIE_APP0_CLK_REQ, 1);\n\t\t\trt2800_register_write(rt2x00dev, WLAN_FUN_CTRL, reg);\n\t\t}\n\n\t\treg = rt2800_register_read(rt2x00dev, CMB_CTRL);\n\t\tif (!(rt2x00_get_field32(reg, LDO0_EN) == 1)) {\n\t\t\trt2x00_set_field32(&reg, LDO0_EN, 1);\n\t\t\trt2x00_set_field32(&reg, LDO_BGSEL, 3);\n\t\t\trt2800_register_write(rt2x00dev, CMB_CTRL, reg);\n\t\t}\n\n\t\treg = rt2800_register_read(rt2x00dev, OSC_CTRL);\n\t\trt2x00_set_field32(&reg, OSC_ROSC_EN, 1);\n\t\trt2x00_set_field32(&reg, OSC_CAL_REQ, 1);\n\t\trt2x00_set_field32(&reg, OSC_REF_CYCLE, 0x27);\n\t\trt2800_register_write(rt2x00dev, OSC_CTRL, reg);\n\n\t\treg = rt2800_register_read(rt2x00dev, COEX_CFG0);\n\t\trt2x00_set_field32(&reg, COEX_CFG_ANT, 0x5e);\n\t\trt2800_register_write(rt2x00dev, COEX_CFG0, reg);\n\n\t\treg = rt2800_register_read(rt2x00dev, COEX_CFG2);\n\t\trt2x00_set_field32(&reg, BT_COEX_CFG1, 0x00);\n\t\trt2x00_set_field32(&reg, BT_COEX_CFG0, 0x17);\n\t\trt2x00_set_field32(&reg, WL_COEX_CFG1, 0x93);\n\t\trt2x00_set_field32(&reg, WL_COEX_CFG0, 0x7f);\n\t\trt2800_register_write(rt2x00dev, COEX_CFG2, reg);\n\n\t\treg = rt2800_register_read(rt2x00dev, PLL_CTRL);\n\t\trt2x00_set_field32(&reg, PLL_CONTROL, 1);\n\t\trt2800_register_write(rt2x00dev, PLL_CTRL, reg);\n\t}\n\n\tif (rt2x00_rt(rt2x00dev, RT3071) ||\n\t    rt2x00_rt(rt2x00dev, RT3090) ||\n\t    rt2x00_rt(rt2x00dev, RT3290) ||\n\t    rt2x00_rt(rt2x00dev, RT3390)) {\n\n\t\tif (rt2x00_rt(rt2x00dev, RT3290))\n\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0,\n\t\t\t\t\t      0x00000404);\n\t\telse\n\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0,\n\t\t\t\t\t      0x00000400);\n\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00000000);\n\t\tif (rt2x00_rt_rev_lt(rt2x00dev, RT3071, REV_RT3071E) ||\n\t\t    rt2x00_rt_rev_lt(rt2x00dev, RT3090, REV_RT3090E) ||\n\t\t    rt2x00_rt_rev_lt(rt2x00dev, RT3390, REV_RT3390E)) {\n\t\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1);\n\t\t\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_DAC_TEST))\n\t\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2,\n\t\t\t\t\t\t      0x0000002c);\n\t\t\telse\n\t\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2,\n\t\t\t\t\t\t      0x0000000f);\n\t\t} else {\n\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000000);\n\t\t}\n\t} else if (rt2x00_rt(rt2x00dev, RT3070)) {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000400);\n\n\t\tif (rt2x00_rt_rev_lt(rt2x00dev, RT3070, REV_RT3070F)) {\n\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00000000);\n\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x0000002c);\n\t\t} else {\n\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00080606);\n\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000000);\n\t\t}\n\t} else if (rt2800_is_305x_soc(rt2x00dev)) {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000400);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00000000);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000030);\n\t} else if (rt2x00_rt(rt2x00dev, RT3352)) {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000402);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00080606);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000000);\n\t} else if (rt2x00_rt(rt2x00dev, RT3572)) {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000400);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00080606);\n\t} else if (rt2x00_rt(rt2x00dev, RT3593)) {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000402);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00000000);\n\t\tif (rt2x00_rt_rev_lt(rt2x00dev, RT3593, REV_RT3593E)) {\n\t\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1);\n\t\t\tif (rt2x00_get_field16(eeprom,\n\t\t\t\t\t       EEPROM_NIC_CONF1_DAC_TEST))\n\t\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2,\n\t\t\t\t\t\t      0x0000001f);\n\t\t\telse\n\t\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2,\n\t\t\t\t\t\t      0x0000000f);\n\t\t} else {\n\t\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2,\n\t\t\t\t\t      0x00000000);\n\t\t}\n\t} else if (rt2x00_rt(rt2x00dev, RT3883)) {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000402);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00000000);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00040000);\n\t\trt2800_register_write(rt2x00dev, TX_TXBF_CFG_0, 0x8000fc21);\n\t\trt2800_register_write(rt2x00dev, TX_TXBF_CFG_3, 0x00009c40);\n\t} else if (rt2x00_rt(rt2x00dev, RT5390) ||\n\t\t   rt2x00_rt(rt2x00dev, RT5392)) {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000404);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00080606);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000000);\n\t} else if (rt2x00_rt(rt2x00dev, RT5592)) {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000404);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00000000);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000000);\n\t} else if (rt2x00_rt(rt2x00dev, RT5350)) {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000404);\n\t} else if (rt2x00_rt(rt2x00dev, RT6352)) {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000401);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x000C0001);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000000);\n\t\trt2800_register_write(rt2x00dev, TX_ALC_VGA3, 0x00000000);\n\t\trt2800_register_write(rt2x00dev, TX0_BB_GAIN_ATTEN, 0x0);\n\t\trt2800_register_write(rt2x00dev, TX1_BB_GAIN_ATTEN, 0x0);\n\t\trt2800_register_write(rt2x00dev, TX0_RF_GAIN_ATTEN, 0x6C6C666C);\n\t\trt2800_register_write(rt2x00dev, TX1_RF_GAIN_ATTEN, 0x6C6C666C);\n\t\trt2800_register_write(rt2x00dev, TX0_RF_GAIN_CORRECT,\n\t\t\t\t      0x3630363A);\n\t\trt2800_register_write(rt2x00dev, TX1_RF_GAIN_CORRECT,\n\t\t\t\t      0x3630363A);\n\t\treg = rt2800_register_read(rt2x00dev, TX_ALC_CFG_1);\n\t\trt2x00_set_field32(&reg, TX_ALC_CFG_1_ROS_BUSY_EN, 0);\n\t\trt2800_register_write(rt2x00dev, TX_ALC_CFG_1, reg);\n\t} else {\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000000);\n\t\trt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00080606);\n\t}\n\n\treg = rt2800_register_read(rt2x00dev, TX_LINK_CFG);\n\trt2x00_set_field32(&reg, TX_LINK_CFG_REMOTE_MFB_LIFETIME, 32);\n\trt2x00_set_field32(&reg, TX_LINK_CFG_MFB_ENABLE, 0);\n\trt2x00_set_field32(&reg, TX_LINK_CFG_REMOTE_UMFS_ENABLE, 0);\n\trt2x00_set_field32(&reg, TX_LINK_CFG_TX_MRQ_EN, 0);\n\trt2x00_set_field32(&reg, TX_LINK_CFG_TX_RDG_EN, 0);\n\trt2x00_set_field32(&reg, TX_LINK_CFG_TX_CF_ACK_EN, 1);\n\trt2x00_set_field32(&reg, TX_LINK_CFG_REMOTE_MFB, 0);\n\trt2x00_set_field32(&reg, TX_LINK_CFG_REMOTE_MFS, 0);\n\trt2800_register_write(rt2x00dev, TX_LINK_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, TX_TIMEOUT_CFG);\n\trt2x00_set_field32(&reg, TX_TIMEOUT_CFG_MPDU_LIFETIME, 9);\n\trt2x00_set_field32(&reg, TX_TIMEOUT_CFG_RX_ACK_TIMEOUT, 32);\n\trt2x00_set_field32(&reg, TX_TIMEOUT_CFG_TX_OP_TIMEOUT, 10);\n\trt2800_register_write(rt2x00dev, TX_TIMEOUT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, MAX_LEN_CFG);\n\trt2x00_set_field32(&reg, MAX_LEN_CFG_MAX_MPDU, AGGREGATION_SIZE);\n\tif (rt2x00_is_usb(rt2x00dev)) {\n\t\tdrv_data->max_psdu = 3;\n\t} else if (rt2x00_rt_rev_gte(rt2x00dev, RT2872, REV_RT2872E) ||\n\t\t   rt2x00_rt(rt2x00dev, RT2883) ||\n\t\t   rt2x00_rt_rev_lt(rt2x00dev, RT3070, REV_RT3070E)) {\n\t\tdrv_data->max_psdu = 2;\n\t} else {\n\t\tdrv_data->max_psdu = 1;\n\t}\n\trt2x00_set_field32(&reg, MAX_LEN_CFG_MAX_PSDU, drv_data->max_psdu);\n\trt2x00_set_field32(&reg, MAX_LEN_CFG_MIN_PSDU, 10);\n\trt2x00_set_field32(&reg, MAX_LEN_CFG_MIN_MPDU, 10);\n\trt2800_register_write(rt2x00dev, MAX_LEN_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, LED_CFG);\n\trt2x00_set_field32(&reg, LED_CFG_ON_PERIOD, 70);\n\trt2x00_set_field32(&reg, LED_CFG_OFF_PERIOD, 30);\n\trt2x00_set_field32(&reg, LED_CFG_SLOW_BLINK_PERIOD, 3);\n\trt2x00_set_field32(&reg, LED_CFG_R_LED_MODE, 3);\n\trt2x00_set_field32(&reg, LED_CFG_G_LED_MODE, 3);\n\trt2x00_set_field32(&reg, LED_CFG_Y_LED_MODE, 3);\n\trt2x00_set_field32(&reg, LED_CFG_LED_POLAR, 1);\n\trt2800_register_write(rt2x00dev, LED_CFG, reg);\n\n\trt2800_register_write(rt2x00dev, PBF_MAX_PCNT, 0x1f3fbf9f);\n\n\treg = rt2800_register_read(rt2x00dev, TX_RTY_CFG);\n\trt2x00_set_field32(&reg, TX_RTY_CFG_SHORT_RTY_LIMIT, 2);\n\trt2x00_set_field32(&reg, TX_RTY_CFG_LONG_RTY_LIMIT, 2);\n\trt2x00_set_field32(&reg, TX_RTY_CFG_LONG_RTY_THRE, 2000);\n\trt2x00_set_field32(&reg, TX_RTY_CFG_NON_AGG_RTY_MODE, 0);\n\trt2x00_set_field32(&reg, TX_RTY_CFG_AGG_RTY_MODE, 0);\n\trt2x00_set_field32(&reg, TX_RTY_CFG_TX_AUTO_FB_ENABLE, 1);\n\trt2800_register_write(rt2x00dev, TX_RTY_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, AUTO_RSP_CFG);\n\trt2x00_set_field32(&reg, AUTO_RSP_CFG_AUTORESPONDER, 1);\n\trt2x00_set_field32(&reg, AUTO_RSP_CFG_BAC_ACK_POLICY, 1);\n\trt2x00_set_field32(&reg, AUTO_RSP_CFG_CTS_40_MMODE, 1);\n\trt2x00_set_field32(&reg, AUTO_RSP_CFG_CTS_40_MREF, 0);\n\trt2x00_set_field32(&reg, AUTO_RSP_CFG_AR_PREAMBLE, 0);\n\trt2x00_set_field32(&reg, AUTO_RSP_CFG_DUAL_CTS_EN, 0);\n\trt2x00_set_field32(&reg, AUTO_RSP_CFG_ACK_CTS_PSM_BIT, 0);\n\trt2800_register_write(rt2x00dev, AUTO_RSP_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, CCK_PROT_CFG);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_PROTECT_RATE, 3);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_PROTECT_CTRL, 0);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_PROTECT_NAV_SHORT, 1);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_CCK, 1);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_MM20, 1);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_MM40, 0);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_GF20, 1);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_GF40, 0);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_RTS_TH_EN, 1);\n\trt2800_register_write(rt2x00dev, CCK_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, OFDM_PROT_CFG);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_PROTECT_RATE, 3);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_PROTECT_CTRL, 0);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_PROTECT_NAV_SHORT, 1);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_CCK, 1);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_MM20, 1);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_MM40, 0);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_GF20, 1);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_GF40, 0);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_RTS_TH_EN, 1);\n\trt2800_register_write(rt2x00dev, OFDM_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, MM20_PROT_CFG);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_PROTECT_RATE, 0x4004);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_PROTECT_CTRL, 1);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_PROTECT_NAV_SHORT, 1);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_CCK, 0);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_MM20, 1);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_MM40, 0);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_GF20, 1);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_GF40, 0);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_RTS_TH_EN, 0);\n\trt2800_register_write(rt2x00dev, MM20_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, MM40_PROT_CFG);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_PROTECT_RATE, 0x4084);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_PROTECT_CTRL, 1);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_PROTECT_NAV_SHORT, 1);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_CCK, 0);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_MM20, 1);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_MM40, 1);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_GF20, 1);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_GF40, 1);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_RTS_TH_EN, 0);\n\trt2800_register_write(rt2x00dev, MM40_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, GF20_PROT_CFG);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_PROTECT_RATE, 0x4004);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_PROTECT_CTRL, 1);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_PROTECT_NAV_SHORT, 1);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_CCK, 0);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_MM20, 1);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_MM40, 0);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_GF20, 1);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_GF40, 0);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_RTS_TH_EN, 0);\n\trt2800_register_write(rt2x00dev, GF20_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, GF40_PROT_CFG);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_PROTECT_RATE, 0x4084);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_PROTECT_CTRL, 1);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_PROTECT_NAV_SHORT, 1);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_CCK, 0);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_MM20, 1);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_MM40, 1);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_GF20, 1);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_GF40, 1);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_RTS_TH_EN, 0);\n\trt2800_register_write(rt2x00dev, GF40_PROT_CFG, reg);\n\n\tif (rt2x00_is_usb(rt2x00dev)) {\n\t\trt2800_register_write(rt2x00dev, PBF_CFG, 0xf40006);\n\n\t\treg = rt2800_register_read(rt2x00dev, WPDMA_GLO_CFG);\n\t\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_TX_DMA, 0);\n\t\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_TX_DMA_BUSY, 0);\n\t\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_RX_DMA, 0);\n\t\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_RX_DMA_BUSY, 0);\n\t\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_WP_DMA_BURST_SIZE, 3);\n\t\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_TX_WRITEBACK_DONE, 0);\n\t\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_BIG_ENDIAN, 0);\n\t\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_RX_HDR_SCATTER, 0);\n\t\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_HDR_SEG_LEN, 0);\n\t\trt2800_register_write(rt2x00dev, WPDMA_GLO_CFG, reg);\n\t}\n\n\t \n\treg = rt2800_register_read(rt2x00dev, TXOP_CTRL_CFG);\n\trt2x00_set_field32(&reg, TXOP_CTRL_CFG_TIMEOUT_TRUN_EN, 1);\n\trt2x00_set_field32(&reg, TXOP_CTRL_CFG_AC_TRUN_EN, 1);\n\trt2x00_set_field32(&reg, TXOP_CTRL_CFG_TXRATEGRP_TRUN_EN, 1);\n\trt2x00_set_field32(&reg, TXOP_CTRL_CFG_USER_MODE_TRUN_EN, 1);\n\trt2x00_set_field32(&reg, TXOP_CTRL_CFG_MIMO_PS_TRUN_EN, 1);\n\trt2x00_set_field32(&reg, TXOP_CTRL_CFG_RESERVED_TRUN_EN, 1);\n\trt2x00_set_field32(&reg, TXOP_CTRL_CFG_LSIG_TXOP_EN, 0);\n\trt2x00_set_field32(&reg, TXOP_CTRL_CFG_EXT_CCA_EN, 0);\n\trt2x00_set_field32(&reg, TXOP_CTRL_CFG_EXT_CCA_DLY, 88);\n\trt2x00_set_field32(&reg, TXOP_CTRL_CFG_EXT_CWMIN, 0);\n\trt2800_register_write(rt2x00dev, TXOP_CTRL_CFG, reg);\n\n\treg = rt2x00_rt(rt2x00dev, RT5592) ? 0x00000082 : 0x00000002;\n\trt2800_register_write(rt2x00dev, TXOP_HLDR_ET, reg);\n\n\tif (rt2x00_rt(rt2x00dev, RT3883)) {\n\t\trt2800_register_write(rt2x00dev, TX_FBK_CFG_3S_0, 0x12111008);\n\t\trt2800_register_write(rt2x00dev, TX_FBK_CFG_3S_1, 0x16151413);\n\t}\n\n\treg = rt2800_register_read(rt2x00dev, TX_RTS_CFG);\n\trt2x00_set_field32(&reg, TX_RTS_CFG_AUTO_RTS_RETRY_LIMIT, 7);\n\trt2x00_set_field32(&reg, TX_RTS_CFG_RTS_THRES,\n\t\t\t   IEEE80211_MAX_RTS_THRESHOLD);\n\trt2x00_set_field32(&reg, TX_RTS_CFG_RTS_FBK_EN, 1);\n\trt2800_register_write(rt2x00dev, TX_RTS_CFG, reg);\n\n\trt2800_register_write(rt2x00dev, EXP_ACK_TIME, 0x002400ca);\n\n\t \n\treg = rt2800_register_read(rt2x00dev, XIFS_TIME_CFG);\n\trt2x00_set_field32(&reg, XIFS_TIME_CFG_CCKM_SIFS_TIME, 16);\n\trt2x00_set_field32(&reg, XIFS_TIME_CFG_OFDM_SIFS_TIME, 16);\n\trt2x00_set_field32(&reg, XIFS_TIME_CFG_OFDM_XIFS_TIME, 4);\n\trt2x00_set_field32(&reg, XIFS_TIME_CFG_EIFS, 314);\n\trt2x00_set_field32(&reg, XIFS_TIME_CFG_BB_RXEND_ENABLE, 1);\n\trt2800_register_write(rt2x00dev, XIFS_TIME_CFG, reg);\n\n\trt2800_register_write(rt2x00dev, PWR_PIN_CFG, 0x00000003);\n\n\t \n\tfor (i = 0; i < 4; i++)\n\t\trt2800_register_write(rt2x00dev, SHARED_KEY_MODE_ENTRY(i), 0);\n\n\tfor (i = 0; i < 256; i++) {\n\t\trt2800_config_wcid(rt2x00dev, NULL, i);\n\t\trt2800_delete_wcid_attr(rt2x00dev, i);\n\t}\n\n\t \n\tif (!test_bit(DEVICE_STATE_RESET, &rt2x00dev->flags))\n\t\tfor (i = 0; i < 256; i++)\n\t\t\trt2800_register_write(rt2x00dev, MAC_IVEIV_ENTRY(i), 0);\n\n\t \n\tfor (i = 0; i < 8; i++)\n\t\trt2800_clear_beacon_register(rt2x00dev, i);\n\n\tif (rt2x00_is_usb(rt2x00dev)) {\n\t\treg = rt2800_register_read(rt2x00dev, US_CYC_CNT);\n\t\trt2x00_set_field32(&reg, US_CYC_CNT_CLOCK_CYCLE, 30);\n\t\trt2800_register_write(rt2x00dev, US_CYC_CNT, reg);\n\t} else if (rt2x00_is_pcie(rt2x00dev)) {\n\t\treg = rt2800_register_read(rt2x00dev, US_CYC_CNT);\n\t\trt2x00_set_field32(&reg, US_CYC_CNT_CLOCK_CYCLE, 125);\n\t\trt2800_register_write(rt2x00dev, US_CYC_CNT, reg);\n\t} else if (rt2x00_is_soc(rt2x00dev)) {\n\t\tstruct clk *clk = clk_get_sys(\"bus\", NULL);\n\t\tint rate;\n\n\t\tif (IS_ERR(clk)) {\n\t\t\tclk = clk_get_sys(\"cpu\", NULL);\n\n\t\t\tif (IS_ERR(clk)) {\n\t\t\t\trate = 125;\n\t\t\t} else {\n\t\t\t\trate = clk_get_rate(clk) / 3000000;\n\t\t\t\tclk_put(clk);\n\t\t\t}\n\t\t} else {\n\t\t\trate = clk_get_rate(clk) / 1000000;\n\t\t\tclk_put(clk);\n\t\t}\n\n\t\treg = rt2800_register_read(rt2x00dev, US_CYC_CNT);\n\t\trt2x00_set_field32(&reg, US_CYC_CNT_CLOCK_CYCLE, rate);\n\t\trt2800_register_write(rt2x00dev, US_CYC_CNT, reg);\n\t}\n\n\treg = rt2800_register_read(rt2x00dev, HT_FBK_CFG0);\n\trt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS0FBK, 0);\n\trt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS1FBK, 0);\n\trt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS2FBK, 1);\n\trt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS3FBK, 2);\n\trt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS4FBK, 3);\n\trt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS5FBK, 4);\n\trt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS6FBK, 5);\n\trt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS7FBK, 6);\n\trt2800_register_write(rt2x00dev, HT_FBK_CFG0, reg);\n\n\treg = rt2800_register_read(rt2x00dev, HT_FBK_CFG1);\n\trt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS8FBK, 8);\n\trt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS9FBK, 8);\n\trt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS10FBK, 9);\n\trt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS11FBK, 10);\n\trt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS12FBK, 11);\n\trt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS13FBK, 12);\n\trt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS14FBK, 13);\n\trt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS15FBK, 14);\n\trt2800_register_write(rt2x00dev, HT_FBK_CFG1, reg);\n\n\treg = rt2800_register_read(rt2x00dev, LG_FBK_CFG0);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS0FBK, 8);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS1FBK, 8);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS2FBK, 9);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS3FBK, 10);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS4FBK, 11);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS5FBK, 12);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS6FBK, 13);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS7FBK, 14);\n\trt2800_register_write(rt2x00dev, LG_FBK_CFG0, reg);\n\n\treg = rt2800_register_read(rt2x00dev, LG_FBK_CFG1);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_CCKMCS0FBK, 0);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_CCKMCS1FBK, 0);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_CCKMCS2FBK, 1);\n\trt2x00_set_field32(&reg, LG_FBK_CFG0_CCKMCS3FBK, 2);\n\trt2800_register_write(rt2x00dev, LG_FBK_CFG1, reg);\n\n\t \n\treg = rt2800_register_read(rt2x00dev, AMPDU_BA_WINSIZE);\n\trt2x00_set_field32(&reg, AMPDU_BA_WINSIZE_FORCE_WINSIZE_ENABLE, 0);\n\trt2x00_set_field32(&reg, AMPDU_BA_WINSIZE_FORCE_WINSIZE, 0);\n\trt2800_register_write(rt2x00dev, AMPDU_BA_WINSIZE, reg);\n\n\t \n\treg = rt2800_register_read(rt2x00dev, RX_STA_CNT0);\n\treg = rt2800_register_read(rt2x00dev, RX_STA_CNT1);\n\treg = rt2800_register_read(rt2x00dev, RX_STA_CNT2);\n\treg = rt2800_register_read(rt2x00dev, TX_STA_CNT0);\n\treg = rt2800_register_read(rt2x00dev, TX_STA_CNT1);\n\treg = rt2800_register_read(rt2x00dev, TX_STA_CNT2);\n\n\t \n\treg = rt2800_register_read(rt2x00dev, INT_TIMER_CFG);\n\trt2x00_set_field32(&reg, INT_TIMER_CFG_PRE_TBTT_TIMER, 6 << 4);\n\trt2800_register_write(rt2x00dev, INT_TIMER_CFG, reg);\n\n\t \n\treg = rt2800_register_read(rt2x00dev, CH_TIME_CFG);\n\trt2x00_set_field32(&reg, CH_TIME_CFG_EIFS_BUSY, 1);\n\trt2x00_set_field32(&reg, CH_TIME_CFG_NAV_BUSY, 1);\n\trt2x00_set_field32(&reg, CH_TIME_CFG_RX_BUSY, 1);\n\trt2x00_set_field32(&reg, CH_TIME_CFG_TX_BUSY, 1);\n\trt2x00_set_field32(&reg, CH_TIME_CFG_TMR_EN, 1);\n\trt2800_register_write(rt2x00dev, CH_TIME_CFG, reg);\n\n\treturn 0;\n}\n\n\nstatic void rt2800_bbp4_mac_if_ctrl(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 value;\n\n\tvalue = rt2800_bbp_read(rt2x00dev, 4);\n\trt2x00_set_field8(&value, BBP4_MAC_IF_CTRL, 1);\n\trt2800_bbp_write(rt2x00dev, 4, value);\n}\n\nstatic void rt2800_init_freq_calibration(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_bbp_write(rt2x00dev, 142, 1);\n\trt2800_bbp_write(rt2x00dev, 143, 57);\n}\n\nstatic void rt2800_init_bbp_5592_glrt(struct rt2x00_dev *rt2x00dev)\n{\n\tstatic const u8 glrt_table[] = {\n\t\t0xE0, 0x1F, 0X38, 0x32, 0x08, 0x28, 0x19, 0x0A, 0xFF, 0x00,  \n\t\t0x16, 0x10, 0x10, 0x0B, 0x36, 0x2C, 0x26, 0x24, 0x42, 0x36,  \n\t\t0x30, 0x2D, 0x4C, 0x46, 0x3D, 0x40, 0x3E, 0x42, 0x3D, 0x40,  \n\t\t0X3C, 0x34, 0x2C, 0x2F, 0x3C, 0x35, 0x2E, 0x2A, 0x49, 0x41,  \n\t\t0x36, 0x31, 0x30, 0x30, 0x0E, 0x0D, 0x28, 0x21, 0x1C, 0x16,  \n\t\t0x50, 0x4A, 0x43, 0x40, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00,  \n\t\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,  \n\t\t0x00, 0x00, 0x7D, 0x14, 0x32, 0x2C, 0x36, 0x4C, 0x43, 0x2C,  \n\t\t0x2E, 0x36, 0x30, 0x6E,\t\t\t\t\t     \n\t};\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(glrt_table); i++) {\n\t\trt2800_bbp_write(rt2x00dev, 195, 128 + i);\n\t\trt2800_bbp_write(rt2x00dev, 196, glrt_table[i]);\n\t}\n};\n\nstatic void rt2800_init_bbp_early(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_bbp_write(rt2x00dev, 65, 0x2C);\n\trt2800_bbp_write(rt2x00dev, 66, 0x38);\n\trt2800_bbp_write(rt2x00dev, 68, 0x0B);\n\trt2800_bbp_write(rt2x00dev, 69, 0x12);\n\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\trt2800_bbp_write(rt2x00dev, 73, 0x10);\n\trt2800_bbp_write(rt2x00dev, 81, 0x37);\n\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\trt2800_bbp_write(rt2x00dev, 83, 0x6A);\n\trt2800_bbp_write(rt2x00dev, 84, 0x99);\n\trt2800_bbp_write(rt2x00dev, 86, 0x00);\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\trt2800_bbp_write(rt2x00dev, 92, 0x00);\n\trt2800_bbp_write(rt2x00dev, 103, 0x00);\n\trt2800_bbp_write(rt2x00dev, 105, 0x05);\n\trt2800_bbp_write(rt2x00dev, 106, 0x35);\n}\n\nstatic void rt2800_disable_unused_dac_adc(struct rt2x00_dev *rt2x00dev)\n{\n\tu16 eeprom;\n\tu8 value;\n\n\tvalue = rt2800_bbp_read(rt2x00dev, 138);\n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF0);\n\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_TXPATH) == 1)\n\t\tvalue |= 0x20;\n\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_RXPATH) == 1)\n\t\tvalue &= ~0x02;\n\trt2800_bbp_write(rt2x00dev, 138, value);\n}\n\nstatic void rt2800_init_bbp_305x_soc(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_bbp_write(rt2x00dev, 31, 0x08);\n\n\trt2800_bbp_write(rt2x00dev, 65, 0x2c);\n\trt2800_bbp_write(rt2x00dev, 66, 0x38);\n\n\trt2800_bbp_write(rt2x00dev, 69, 0x12);\n\trt2800_bbp_write(rt2x00dev, 73, 0x10);\n\n\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\n\trt2800_bbp_write(rt2x00dev, 78, 0x0e);\n\trt2800_bbp_write(rt2x00dev, 80, 0x08);\n\n\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\n\trt2800_bbp_write(rt2x00dev, 83, 0x6a);\n\n\trt2800_bbp_write(rt2x00dev, 84, 0x99);\n\n\trt2800_bbp_write(rt2x00dev, 86, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\n\trt2800_bbp_write(rt2x00dev, 92, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n\n\trt2800_bbp_write(rt2x00dev, 105, 0x01);\n\n\trt2800_bbp_write(rt2x00dev, 106, 0x35);\n}\n\nstatic void rt2800_init_bbp_28xx(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_bbp_write(rt2x00dev, 65, 0x2c);\n\trt2800_bbp_write(rt2x00dev, 66, 0x38);\n\n\tif (rt2x00_rt_rev(rt2x00dev, RT2860, REV_RT2860C)) {\n\t\trt2800_bbp_write(rt2x00dev, 69, 0x16);\n\t\trt2800_bbp_write(rt2x00dev, 73, 0x12);\n\t} else {\n\t\trt2800_bbp_write(rt2x00dev, 69, 0x12);\n\t\trt2800_bbp_write(rt2x00dev, 73, 0x10);\n\t}\n\n\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\n\trt2800_bbp_write(rt2x00dev, 81, 0x37);\n\n\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\n\trt2800_bbp_write(rt2x00dev, 83, 0x6a);\n\n\tif (rt2x00_rt_rev(rt2x00dev, RT2860, REV_RT2860D))\n\t\trt2800_bbp_write(rt2x00dev, 84, 0x19);\n\telse\n\t\trt2800_bbp_write(rt2x00dev, 84, 0x99);\n\n\trt2800_bbp_write(rt2x00dev, 86, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\n\trt2800_bbp_write(rt2x00dev, 92, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 103, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 105, 0x05);\n\n\trt2800_bbp_write(rt2x00dev, 106, 0x35);\n}\n\nstatic void rt2800_init_bbp_30xx(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_bbp_write(rt2x00dev, 65, 0x2c);\n\trt2800_bbp_write(rt2x00dev, 66, 0x38);\n\n\trt2800_bbp_write(rt2x00dev, 69, 0x12);\n\trt2800_bbp_write(rt2x00dev, 73, 0x10);\n\n\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\n\trt2800_bbp_write(rt2x00dev, 79, 0x13);\n\trt2800_bbp_write(rt2x00dev, 80, 0x05);\n\trt2800_bbp_write(rt2x00dev, 81, 0x33);\n\n\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\n\trt2800_bbp_write(rt2x00dev, 83, 0x6a);\n\n\trt2800_bbp_write(rt2x00dev, 84, 0x99);\n\n\trt2800_bbp_write(rt2x00dev, 86, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\n\trt2800_bbp_write(rt2x00dev, 92, 0x00);\n\n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT3070, REV_RT3070F) ||\n\t    rt2x00_rt_rev_gte(rt2x00dev, RT3071, REV_RT3071E) ||\n\t    rt2x00_rt_rev_gte(rt2x00dev, RT3090, REV_RT3090E))\n\t\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n\telse\n\t\trt2800_bbp_write(rt2x00dev, 103, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 105, 0x05);\n\n\trt2800_bbp_write(rt2x00dev, 106, 0x35);\n\n\tif (rt2x00_rt(rt2x00dev, RT3071) ||\n\t    rt2x00_rt(rt2x00dev, RT3090))\n\t\trt2800_disable_unused_dac_adc(rt2x00dev);\n}\n\nstatic void rt2800_init_bbp_3290(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 value;\n\n\trt2800_bbp4_mac_if_ctrl(rt2x00dev);\n\n\trt2800_bbp_write(rt2x00dev, 31, 0x08);\n\n\trt2800_bbp_write(rt2x00dev, 65, 0x2c);\n\trt2800_bbp_write(rt2x00dev, 66, 0x38);\n\n\trt2800_bbp_write(rt2x00dev, 68, 0x0b);\n\n\trt2800_bbp_write(rt2x00dev, 69, 0x12);\n\trt2800_bbp_write(rt2x00dev, 73, 0x13);\n\trt2800_bbp_write(rt2x00dev, 75, 0x46);\n\trt2800_bbp_write(rt2x00dev, 76, 0x28);\n\n\trt2800_bbp_write(rt2x00dev, 77, 0x58);\n\n\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\n\trt2800_bbp_write(rt2x00dev, 74, 0x0b);\n\trt2800_bbp_write(rt2x00dev, 79, 0x18);\n\trt2800_bbp_write(rt2x00dev, 80, 0x09);\n\trt2800_bbp_write(rt2x00dev, 81, 0x33);\n\n\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\n\trt2800_bbp_write(rt2x00dev, 83, 0x7a);\n\n\trt2800_bbp_write(rt2x00dev, 84, 0x9a);\n\n\trt2800_bbp_write(rt2x00dev, 86, 0x38);\n\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\n\trt2800_bbp_write(rt2x00dev, 92, 0x02);\n\n\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n\n\trt2800_bbp_write(rt2x00dev, 104, 0x92);\n\n\trt2800_bbp_write(rt2x00dev, 105, 0x1c);\n\n\trt2800_bbp_write(rt2x00dev, 106, 0x03);\n\n\trt2800_bbp_write(rt2x00dev, 128, 0x12);\n\n\trt2800_bbp_write(rt2x00dev, 67, 0x24);\n\trt2800_bbp_write(rt2x00dev, 143, 0x04);\n\trt2800_bbp_write(rt2x00dev, 142, 0x99);\n\trt2800_bbp_write(rt2x00dev, 150, 0x30);\n\trt2800_bbp_write(rt2x00dev, 151, 0x2e);\n\trt2800_bbp_write(rt2x00dev, 152, 0x20);\n\trt2800_bbp_write(rt2x00dev, 153, 0x34);\n\trt2800_bbp_write(rt2x00dev, 154, 0x40);\n\trt2800_bbp_write(rt2x00dev, 155, 0x3b);\n\trt2800_bbp_write(rt2x00dev, 253, 0x04);\n\n\tvalue = rt2800_bbp_read(rt2x00dev, 47);\n\trt2x00_set_field8(&value, BBP47_TSSI_ADC6, 1);\n\trt2800_bbp_write(rt2x00dev, 47, value);\n\n\t \n\tvalue = rt2800_bbp_read(rt2x00dev, 3);\n\trt2x00_set_field8(&value, BBP3_ADC_MODE_SWITCH, 1);\n\trt2x00_set_field8(&value, BBP3_ADC_INIT_MODE, 1);\n\trt2800_bbp_write(rt2x00dev, 3, value);\n}\n\nstatic void rt2800_init_bbp_3352(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_bbp_write(rt2x00dev, 3, 0x00);\n\trt2800_bbp_write(rt2x00dev, 4, 0x50);\n\n\trt2800_bbp_write(rt2x00dev, 31, 0x08);\n\n\trt2800_bbp_write(rt2x00dev, 47, 0x48);\n\n\trt2800_bbp_write(rt2x00dev, 65, 0x2c);\n\trt2800_bbp_write(rt2x00dev, 66, 0x38);\n\n\trt2800_bbp_write(rt2x00dev, 68, 0x0b);\n\n\trt2800_bbp_write(rt2x00dev, 69, 0x12);\n\trt2800_bbp_write(rt2x00dev, 73, 0x13);\n\trt2800_bbp_write(rt2x00dev, 75, 0x46);\n\trt2800_bbp_write(rt2x00dev, 76, 0x28);\n\n\trt2800_bbp_write(rt2x00dev, 77, 0x59);\n\n\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\n\trt2800_bbp_write(rt2x00dev, 78, 0x0e);\n\trt2800_bbp_write(rt2x00dev, 80, 0x08);\n\trt2800_bbp_write(rt2x00dev, 81, 0x37);\n\n\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\n\tif (rt2x00_rt(rt2x00dev, RT5350)) {\n\t\trt2800_bbp_write(rt2x00dev, 83, 0x7a);\n\t\trt2800_bbp_write(rt2x00dev, 84, 0x9a);\n\t} else {\n\t\trt2800_bbp_write(rt2x00dev, 83, 0x6a);\n\t\trt2800_bbp_write(rt2x00dev, 84, 0x99);\n\t}\n\n\trt2800_bbp_write(rt2x00dev, 86, 0x38);\n\n\trt2800_bbp_write(rt2x00dev, 88, 0x90);\n\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\n\trt2800_bbp_write(rt2x00dev, 92, 0x02);\n\n\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n\n\trt2800_bbp_write(rt2x00dev, 104, 0x92);\n\n\tif (rt2x00_rt(rt2x00dev, RT5350)) {\n\t\trt2800_bbp_write(rt2x00dev, 105, 0x3c);\n\t\trt2800_bbp_write(rt2x00dev, 106, 0x03);\n\t} else {\n\t\trt2800_bbp_write(rt2x00dev, 105, 0x34);\n\t\trt2800_bbp_write(rt2x00dev, 106, 0x05);\n\t}\n\n\trt2800_bbp_write(rt2x00dev, 120, 0x50);\n\n\trt2800_bbp_write(rt2x00dev, 137, 0x0f);\n\n\trt2800_bbp_write(rt2x00dev, 163, 0xbd);\n\t \n\trt2800_bbp_write(rt2x00dev, 179, 0x02);\n\trt2800_bbp_write(rt2x00dev, 180, 0x00);\n\trt2800_bbp_write(rt2x00dev, 182, 0x40);\n\trt2800_bbp_write(rt2x00dev, 180, 0x01);\n\trt2800_bbp_write(rt2x00dev, 182, 0x9c);\n\trt2800_bbp_write(rt2x00dev, 179, 0x00);\n\t \n\trt2800_bbp_write(rt2x00dev, 142, 0x04);\n\trt2800_bbp_write(rt2x00dev, 143, 0x3b);\n\trt2800_bbp_write(rt2x00dev, 142, 0x06);\n\trt2800_bbp_write(rt2x00dev, 143, 0xa0);\n\trt2800_bbp_write(rt2x00dev, 142, 0x07);\n\trt2800_bbp_write(rt2x00dev, 143, 0xa1);\n\trt2800_bbp_write(rt2x00dev, 142, 0x08);\n\trt2800_bbp_write(rt2x00dev, 143, 0xa2);\n\n\trt2800_bbp_write(rt2x00dev, 148, 0xc8);\n\n\tif (rt2x00_rt(rt2x00dev, RT5350)) {\n\t\t \n\t\trt2800_bbp_write(rt2x00dev, 150, 0x40);\n\t\t \n\t\trt2800_bbp_write(rt2x00dev, 151, 0x30);\n\t\trt2800_bbp_write(rt2x00dev, 152, 0xa3);\n\t\t \n\t\trt2800_bbp_write(rt2x00dev, 154, 0);\n\t}\n}\n\nstatic void rt2800_init_bbp_3390(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_bbp_write(rt2x00dev, 65, 0x2c);\n\trt2800_bbp_write(rt2x00dev, 66, 0x38);\n\n\trt2800_bbp_write(rt2x00dev, 69, 0x12);\n\trt2800_bbp_write(rt2x00dev, 73, 0x10);\n\n\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\n\trt2800_bbp_write(rt2x00dev, 79, 0x13);\n\trt2800_bbp_write(rt2x00dev, 80, 0x05);\n\trt2800_bbp_write(rt2x00dev, 81, 0x33);\n\n\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\n\trt2800_bbp_write(rt2x00dev, 83, 0x6a);\n\n\trt2800_bbp_write(rt2x00dev, 84, 0x99);\n\n\trt2800_bbp_write(rt2x00dev, 86, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\n\trt2800_bbp_write(rt2x00dev, 92, 0x00);\n\n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT3390, REV_RT3390E))\n\t\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n\telse\n\t\trt2800_bbp_write(rt2x00dev, 103, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 105, 0x05);\n\n\trt2800_bbp_write(rt2x00dev, 106, 0x35);\n\n\trt2800_disable_unused_dac_adc(rt2x00dev);\n}\n\nstatic void rt2800_init_bbp_3572(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_bbp_write(rt2x00dev, 31, 0x08);\n\n\trt2800_bbp_write(rt2x00dev, 65, 0x2c);\n\trt2800_bbp_write(rt2x00dev, 66, 0x38);\n\n\trt2800_bbp_write(rt2x00dev, 69, 0x12);\n\trt2800_bbp_write(rt2x00dev, 73, 0x10);\n\n\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\n\trt2800_bbp_write(rt2x00dev, 79, 0x13);\n\trt2800_bbp_write(rt2x00dev, 80, 0x05);\n\trt2800_bbp_write(rt2x00dev, 81, 0x33);\n\n\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\n\trt2800_bbp_write(rt2x00dev, 83, 0x6a);\n\n\trt2800_bbp_write(rt2x00dev, 84, 0x99);\n\n\trt2800_bbp_write(rt2x00dev, 86, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\n\trt2800_bbp_write(rt2x00dev, 92, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n\n\trt2800_bbp_write(rt2x00dev, 105, 0x05);\n\n\trt2800_bbp_write(rt2x00dev, 106, 0x35);\n\n\trt2800_disable_unused_dac_adc(rt2x00dev);\n}\n\nstatic void rt2800_init_bbp_3593(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_init_bbp_early(rt2x00dev);\n\n\trt2800_bbp_write(rt2x00dev, 79, 0x13);\n\trt2800_bbp_write(rt2x00dev, 80, 0x05);\n\trt2800_bbp_write(rt2x00dev, 81, 0x33);\n\trt2800_bbp_write(rt2x00dev, 137, 0x0f);\n\n\trt2800_bbp_write(rt2x00dev, 84, 0x19);\n\n\t \n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT3593, REV_RT3593E))\n\t\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n}\n\nstatic void rt2800_init_bbp_3883(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_init_bbp_early(rt2x00dev);\n\n\trt2800_bbp_write(rt2x00dev, 4, 0x50);\n\trt2800_bbp_write(rt2x00dev, 47, 0x48);\n\n\trt2800_bbp_write(rt2x00dev, 86, 0x46);\n\trt2800_bbp_write(rt2x00dev, 88, 0x90);\n\n\trt2800_bbp_write(rt2x00dev, 92, 0x02);\n\n\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n\trt2800_bbp_write(rt2x00dev, 104, 0x92);\n\trt2800_bbp_write(rt2x00dev, 105, 0x34);\n\trt2800_bbp_write(rt2x00dev, 106, 0x12);\n\trt2800_bbp_write(rt2x00dev, 120, 0x50);\n\trt2800_bbp_write(rt2x00dev, 137, 0x0f);\n\trt2800_bbp_write(rt2x00dev, 163, 0x9d);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 179, 0x02);\n\trt2800_bbp_write(rt2x00dev, 180, 0x00);\n\trt2800_bbp_write(rt2x00dev, 182, 0x40);\n\trt2800_bbp_write(rt2x00dev, 180, 0x01);\n\trt2800_bbp_write(rt2x00dev, 182, 0x9c);\n\n\trt2800_bbp_write(rt2x00dev, 179, 0x00);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 142, 0x04);\n\trt2800_bbp_write(rt2x00dev, 143, 0x3b);\n\trt2800_bbp_write(rt2x00dev, 142, 0x06);\n\trt2800_bbp_write(rt2x00dev, 143, 0xa0);\n\trt2800_bbp_write(rt2x00dev, 142, 0x07);\n\trt2800_bbp_write(rt2x00dev, 143, 0xa1);\n\trt2800_bbp_write(rt2x00dev, 142, 0x08);\n\trt2800_bbp_write(rt2x00dev, 143, 0xa2);\n\trt2800_bbp_write(rt2x00dev, 148, 0xc8);\n}\n\nstatic void rt2800_init_bbp_53xx(struct rt2x00_dev *rt2x00dev)\n{\n\tint ant, div_mode;\n\tu16 eeprom;\n\tu8 value;\n\n\trt2800_bbp4_mac_if_ctrl(rt2x00dev);\n\n\trt2800_bbp_write(rt2x00dev, 31, 0x08);\n\n\trt2800_bbp_write(rt2x00dev, 65, 0x2c);\n\trt2800_bbp_write(rt2x00dev, 66, 0x38);\n\n\trt2800_bbp_write(rt2x00dev, 68, 0x0b);\n\n\trt2800_bbp_write(rt2x00dev, 69, 0x12);\n\trt2800_bbp_write(rt2x00dev, 73, 0x13);\n\trt2800_bbp_write(rt2x00dev, 75, 0x46);\n\trt2800_bbp_write(rt2x00dev, 76, 0x28);\n\n\trt2800_bbp_write(rt2x00dev, 77, 0x59);\n\n\trt2800_bbp_write(rt2x00dev, 70, 0x0a);\n\n\trt2800_bbp_write(rt2x00dev, 79, 0x13);\n\trt2800_bbp_write(rt2x00dev, 80, 0x05);\n\trt2800_bbp_write(rt2x00dev, 81, 0x33);\n\n\trt2800_bbp_write(rt2x00dev, 82, 0x62);\n\n\trt2800_bbp_write(rt2x00dev, 83, 0x7a);\n\n\trt2800_bbp_write(rt2x00dev, 84, 0x9a);\n\n\trt2800_bbp_write(rt2x00dev, 86, 0x38);\n\n\tif (rt2x00_rt(rt2x00dev, RT5392))\n\t\trt2800_bbp_write(rt2x00dev, 88, 0x90);\n\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\n\trt2800_bbp_write(rt2x00dev, 92, 0x02);\n\n\tif (rt2x00_rt(rt2x00dev, RT5392)) {\n\t\trt2800_bbp_write(rt2x00dev, 95, 0x9a);\n\t\trt2800_bbp_write(rt2x00dev, 98, 0x12);\n\t}\n\n\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n\n\trt2800_bbp_write(rt2x00dev, 104, 0x92);\n\n\trt2800_bbp_write(rt2x00dev, 105, 0x3c);\n\n\tif (rt2x00_rt(rt2x00dev, RT5390))\n\t\trt2800_bbp_write(rt2x00dev, 106, 0x03);\n\telse if (rt2x00_rt(rt2x00dev, RT5392))\n\t\trt2800_bbp_write(rt2x00dev, 106, 0x12);\n\telse\n\t\tWARN_ON(1);\n\n\trt2800_bbp_write(rt2x00dev, 128, 0x12);\n\n\tif (rt2x00_rt(rt2x00dev, RT5392)) {\n\t\trt2800_bbp_write(rt2x00dev, 134, 0xd0);\n\t\trt2800_bbp_write(rt2x00dev, 135, 0xf6);\n\t}\n\n\trt2800_disable_unused_dac_adc(rt2x00dev);\n\n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1);\n\tdiv_mode = rt2x00_get_field16(eeprom,\n\t\t\t\t      EEPROM_NIC_CONF1_ANT_DIVERSITY);\n\tant = (div_mode == 3) ? 1 : 0;\n\n\t \n\tif (rt2x00_has_cap_bt_coexist(rt2x00dev)) {\n\t\tu32 reg;\n\n\t\treg = rt2800_register_read(rt2x00dev, GPIO_CTRL);\n\t\trt2x00_set_field32(&reg, GPIO_CTRL_DIR3, 0);\n\t\trt2x00_set_field32(&reg, GPIO_CTRL_DIR6, 0);\n\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL3, 0);\n\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL6, 0);\n\t\tif (ant == 0)\n\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL3, 1);\n\t\telse if (ant == 1)\n\t\t\trt2x00_set_field32(&reg, GPIO_CTRL_VAL6, 1);\n\t\trt2800_register_write(rt2x00dev, GPIO_CTRL, reg);\n\t}\n\n\t \n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390R) ||\n\t    rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5370G)) {\n\t\trt2800_bbp_write(rt2x00dev, 150, 0);  \n\t\trt2800_bbp_write(rt2x00dev, 151, 0);  \n\t\trt2800_bbp_write(rt2x00dev, 154, 0);  \n\t}\n\n\tvalue = rt2800_bbp_read(rt2x00dev, 152);\n\tif (ant == 0)\n\t\trt2x00_set_field8(&value, BBP152_RX_DEFAULT_ANT, 1);\n\telse\n\t\trt2x00_set_field8(&value, BBP152_RX_DEFAULT_ANT, 0);\n\trt2800_bbp_write(rt2x00dev, 152, value);\n\n\trt2800_init_freq_calibration(rt2x00dev);\n}\n\nstatic void rt2800_init_bbp_5592(struct rt2x00_dev *rt2x00dev)\n{\n\tint ant, div_mode;\n\tu16 eeprom;\n\tu8 value;\n\n\trt2800_init_bbp_early(rt2x00dev);\n\n\tvalue = rt2800_bbp_read(rt2x00dev, 105);\n\trt2x00_set_field8(&value, BBP105_MLD,\n\t\t\t  rt2x00dev->default_ant.rx_chain_num == 2);\n\trt2800_bbp_write(rt2x00dev, 105, value);\n\n\trt2800_bbp4_mac_if_ctrl(rt2x00dev);\n\n\trt2800_bbp_write(rt2x00dev, 20, 0x06);\n\trt2800_bbp_write(rt2x00dev, 31, 0x08);\n\trt2800_bbp_write(rt2x00dev, 65, 0x2C);\n\trt2800_bbp_write(rt2x00dev, 68, 0xDD);\n\trt2800_bbp_write(rt2x00dev, 69, 0x1A);\n\trt2800_bbp_write(rt2x00dev, 70, 0x05);\n\trt2800_bbp_write(rt2x00dev, 73, 0x13);\n\trt2800_bbp_write(rt2x00dev, 74, 0x0F);\n\trt2800_bbp_write(rt2x00dev, 75, 0x4F);\n\trt2800_bbp_write(rt2x00dev, 76, 0x28);\n\trt2800_bbp_write(rt2x00dev, 77, 0x59);\n\trt2800_bbp_write(rt2x00dev, 84, 0x9A);\n\trt2800_bbp_write(rt2x00dev, 86, 0x38);\n\trt2800_bbp_write(rt2x00dev, 88, 0x90);\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\trt2800_bbp_write(rt2x00dev, 92, 0x02);\n\trt2800_bbp_write(rt2x00dev, 95, 0x9a);\n\trt2800_bbp_write(rt2x00dev, 98, 0x12);\n\trt2800_bbp_write(rt2x00dev, 103, 0xC0);\n\trt2800_bbp_write(rt2x00dev, 104, 0x92);\n\t \n\trt2800_bbp_write(rt2x00dev, 105, 0x3C);\n\trt2800_bbp_write(rt2x00dev, 106, 0x35);\n\trt2800_bbp_write(rt2x00dev, 128, 0x12);\n\trt2800_bbp_write(rt2x00dev, 134, 0xD0);\n\trt2800_bbp_write(rt2x00dev, 135, 0xF6);\n\trt2800_bbp_write(rt2x00dev, 137, 0x0F);\n\n\t \n\trt2800_init_bbp_5592_glrt(rt2x00dev);\n\n\trt2800_bbp4_mac_if_ctrl(rt2x00dev);\n\n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1);\n\tdiv_mode = rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_ANT_DIVERSITY);\n\tant = (div_mode == 3) ? 1 : 0;\n\tvalue = rt2800_bbp_read(rt2x00dev, 152);\n\tif (ant == 0) {\n\t\t \n\t\trt2x00_set_field8(&value, BBP152_RX_DEFAULT_ANT, 1);\n\t} else {\n\t\t \n\t\trt2x00_set_field8(&value, BBP152_RX_DEFAULT_ANT, 0);\n\t}\n\trt2800_bbp_write(rt2x00dev, 152, value);\n\n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5592, REV_RT5592C)) {\n\t\tvalue = rt2800_bbp_read(rt2x00dev, 254);\n\t\trt2x00_set_field8(&value, BBP254_BIT7, 1);\n\t\trt2800_bbp_write(rt2x00dev, 254, value);\n\t}\n\n\trt2800_init_freq_calibration(rt2x00dev);\n\n\trt2800_bbp_write(rt2x00dev, 84, 0x19);\n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5592, REV_RT5592C))\n\t\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n}\n\nstatic void rt2800_init_bbp_6352(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 bbp;\n\n\t \n\tbbp = rt2800_bbp_read(rt2x00dev, 105);\n\trt2x00_set_field8(&bbp, BBP105_MLD,\n\t\t\t  rt2x00dev->default_ant.rx_chain_num == 2);\n\trt2800_bbp_write(rt2x00dev, 105, bbp);\n\n\t \n\trt2800_bbp4_mac_if_ctrl(rt2x00dev);\n\n\t \n\tbbp = rt2800_bbp_read(rt2x00dev, 1);\n\tbbp |= 0x04;\n\trt2800_bbp_write(rt2x00dev, 1, bbp);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 3, 0x08);\n\trt2800_bbp_write(rt2x00dev, 4, 0x00);  \n\trt2800_bbp_write(rt2x00dev, 6, 0x08);\n\trt2800_bbp_write(rt2x00dev, 14, 0x09);\n\trt2800_bbp_write(rt2x00dev, 15, 0xFF);\n\trt2800_bbp_write(rt2x00dev, 16, 0x01);\n\trt2800_bbp_write(rt2x00dev, 20, 0x06);\n\trt2800_bbp_write(rt2x00dev, 21, 0x00);\n\trt2800_bbp_write(rt2x00dev, 22, 0x00);\n\trt2800_bbp_write(rt2x00dev, 27, 0x00);\n\trt2800_bbp_write(rt2x00dev, 28, 0x00);\n\trt2800_bbp_write(rt2x00dev, 30, 0x00);\n\trt2800_bbp_write(rt2x00dev, 31, 0x48);\n\trt2800_bbp_write(rt2x00dev, 47, 0x40);\n\trt2800_bbp_write(rt2x00dev, 62, 0x00);\n\trt2800_bbp_write(rt2x00dev, 63, 0x00);\n\trt2800_bbp_write(rt2x00dev, 64, 0x00);\n\trt2800_bbp_write(rt2x00dev, 65, 0x2C);\n\trt2800_bbp_write(rt2x00dev, 66, 0x1C);\n\trt2800_bbp_write(rt2x00dev, 67, 0x20);\n\trt2800_bbp_write(rt2x00dev, 68, 0xDD);\n\trt2800_bbp_write(rt2x00dev, 69, 0x10);\n\trt2800_bbp_write(rt2x00dev, 70, 0x05);\n\trt2800_bbp_write(rt2x00dev, 73, 0x18);\n\trt2800_bbp_write(rt2x00dev, 74, 0x0F);\n\trt2800_bbp_write(rt2x00dev, 75, 0x60);\n\trt2800_bbp_write(rt2x00dev, 76, 0x44);\n\trt2800_bbp_write(rt2x00dev, 77, 0x59);\n\trt2800_bbp_write(rt2x00dev, 78, 0x1E);\n\trt2800_bbp_write(rt2x00dev, 79, 0x1C);\n\trt2800_bbp_write(rt2x00dev, 80, 0x0C);\n\trt2800_bbp_write(rt2x00dev, 81, 0x3A);\n\trt2800_bbp_write(rt2x00dev, 82, 0xB6);\n\trt2800_bbp_write(rt2x00dev, 83, 0x9A);\n\trt2800_bbp_write(rt2x00dev, 84, 0x9A);\n\trt2800_bbp_write(rt2x00dev, 86, 0x38);\n\trt2800_bbp_write(rt2x00dev, 88, 0x90);\n\trt2800_bbp_write(rt2x00dev, 91, 0x04);\n\trt2800_bbp_write(rt2x00dev, 92, 0x02);\n\trt2800_bbp_write(rt2x00dev, 95, 0x9A);\n\trt2800_bbp_write(rt2x00dev, 96, 0x00);\n\trt2800_bbp_write(rt2x00dev, 103, 0xC0);\n\trt2800_bbp_write(rt2x00dev, 104, 0x92);\n\t \n\trt2800_bbp_write(rt2x00dev, 105, 0x3C);\n\trt2800_bbp_write(rt2x00dev, 106, 0x12);\n\trt2800_bbp_write(rt2x00dev, 109, 0x00);\n\trt2800_bbp_write(rt2x00dev, 134, 0x10);\n\trt2800_bbp_write(rt2x00dev, 135, 0xA6);\n\trt2800_bbp_write(rt2x00dev, 137, 0x04);\n\trt2800_bbp_write(rt2x00dev, 142, 0x30);\n\trt2800_bbp_write(rt2x00dev, 143, 0xF7);\n\trt2800_bbp_write(rt2x00dev, 160, 0xEC);\n\trt2800_bbp_write(rt2x00dev, 161, 0xC4);\n\trt2800_bbp_write(rt2x00dev, 162, 0x77);\n\trt2800_bbp_write(rt2x00dev, 163, 0xF9);\n\trt2800_bbp_write(rt2x00dev, 164, 0x00);\n\trt2800_bbp_write(rt2x00dev, 165, 0x00);\n\trt2800_bbp_write(rt2x00dev, 186, 0x00);\n\trt2800_bbp_write(rt2x00dev, 187, 0x00);\n\trt2800_bbp_write(rt2x00dev, 188, 0x00);\n\trt2800_bbp_write(rt2x00dev, 186, 0x00);\n\trt2800_bbp_write(rt2x00dev, 187, 0x01);\n\trt2800_bbp_write(rt2x00dev, 188, 0x00);\n\trt2800_bbp_write(rt2x00dev, 189, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 91, 0x06);\n\trt2800_bbp_write(rt2x00dev, 92, 0x04);\n\trt2800_bbp_write(rt2x00dev, 93, 0x54);\n\trt2800_bbp_write(rt2x00dev, 99, 0x50);\n\trt2800_bbp_write(rt2x00dev, 148, 0x84);\n\trt2800_bbp_write(rt2x00dev, 167, 0x80);\n\trt2800_bbp_write(rt2x00dev, 178, 0xFF);\n\trt2800_bbp_write(rt2x00dev, 106, 0x13);\n\n\t \n\trt2800_bbp_glrt_write(rt2x00dev, 0, 0x00);\n\trt2800_bbp_glrt_write(rt2x00dev, 1, 0x14);\n\trt2800_bbp_glrt_write(rt2x00dev, 2, 0x20);\n\trt2800_bbp_glrt_write(rt2x00dev, 3, 0x0A);\n\trt2800_bbp_glrt_write(rt2x00dev, 10, 0x16);\n\trt2800_bbp_glrt_write(rt2x00dev, 11, 0x06);\n\trt2800_bbp_glrt_write(rt2x00dev, 12, 0x02);\n\trt2800_bbp_glrt_write(rt2x00dev, 13, 0x07);\n\trt2800_bbp_glrt_write(rt2x00dev, 14, 0x05);\n\trt2800_bbp_glrt_write(rt2x00dev, 15, 0x09);\n\trt2800_bbp_glrt_write(rt2x00dev, 16, 0x20);\n\trt2800_bbp_glrt_write(rt2x00dev, 17, 0x08);\n\trt2800_bbp_glrt_write(rt2x00dev, 18, 0x4A);\n\trt2800_bbp_glrt_write(rt2x00dev, 19, 0x00);\n\trt2800_bbp_glrt_write(rt2x00dev, 20, 0x00);\n\trt2800_bbp_glrt_write(rt2x00dev, 128, 0xE0);\n\trt2800_bbp_glrt_write(rt2x00dev, 129, 0x1F);\n\trt2800_bbp_glrt_write(rt2x00dev, 130, 0x4F);\n\trt2800_bbp_glrt_write(rt2x00dev, 131, 0x32);\n\trt2800_bbp_glrt_write(rt2x00dev, 132, 0x08);\n\trt2800_bbp_glrt_write(rt2x00dev, 133, 0x28);\n\trt2800_bbp_glrt_write(rt2x00dev, 134, 0x19);\n\trt2800_bbp_glrt_write(rt2x00dev, 135, 0x0A);\n\trt2800_bbp_glrt_write(rt2x00dev, 138, 0x16);\n\trt2800_bbp_glrt_write(rt2x00dev, 139, 0x10);\n\trt2800_bbp_glrt_write(rt2x00dev, 140, 0x10);\n\trt2800_bbp_glrt_write(rt2x00dev, 141, 0x1A);\n\trt2800_bbp_glrt_write(rt2x00dev, 142, 0x36);\n\trt2800_bbp_glrt_write(rt2x00dev, 143, 0x2C);\n\trt2800_bbp_glrt_write(rt2x00dev, 144, 0x26);\n\trt2800_bbp_glrt_write(rt2x00dev, 145, 0x24);\n\trt2800_bbp_glrt_write(rt2x00dev, 146, 0x42);\n\trt2800_bbp_glrt_write(rt2x00dev, 147, 0x40);\n\trt2800_bbp_glrt_write(rt2x00dev, 148, 0x30);\n\trt2800_bbp_glrt_write(rt2x00dev, 149, 0x29);\n\trt2800_bbp_glrt_write(rt2x00dev, 150, 0x4C);\n\trt2800_bbp_glrt_write(rt2x00dev, 151, 0x46);\n\trt2800_bbp_glrt_write(rt2x00dev, 152, 0x3D);\n\trt2800_bbp_glrt_write(rt2x00dev, 153, 0x40);\n\trt2800_bbp_glrt_write(rt2x00dev, 154, 0x3E);\n\trt2800_bbp_glrt_write(rt2x00dev, 155, 0x38);\n\trt2800_bbp_glrt_write(rt2x00dev, 156, 0x3D);\n\trt2800_bbp_glrt_write(rt2x00dev, 157, 0x2F);\n\trt2800_bbp_glrt_write(rt2x00dev, 158, 0x3C);\n\trt2800_bbp_glrt_write(rt2x00dev, 159, 0x34);\n\trt2800_bbp_glrt_write(rt2x00dev, 160, 0x2C);\n\trt2800_bbp_glrt_write(rt2x00dev, 161, 0x2F);\n\trt2800_bbp_glrt_write(rt2x00dev, 162, 0x3C);\n\trt2800_bbp_glrt_write(rt2x00dev, 163, 0x35);\n\trt2800_bbp_glrt_write(rt2x00dev, 164, 0x2E);\n\trt2800_bbp_glrt_write(rt2x00dev, 165, 0x2F);\n\trt2800_bbp_glrt_write(rt2x00dev, 166, 0x49);\n\trt2800_bbp_glrt_write(rt2x00dev, 167, 0x41);\n\trt2800_bbp_glrt_write(rt2x00dev, 168, 0x36);\n\trt2800_bbp_glrt_write(rt2x00dev, 169, 0x39);\n\trt2800_bbp_glrt_write(rt2x00dev, 170, 0x30);\n\trt2800_bbp_glrt_write(rt2x00dev, 171, 0x30);\n\trt2800_bbp_glrt_write(rt2x00dev, 172, 0x0E);\n\trt2800_bbp_glrt_write(rt2x00dev, 173, 0x0D);\n\trt2800_bbp_glrt_write(rt2x00dev, 174, 0x28);\n\trt2800_bbp_glrt_write(rt2x00dev, 175, 0x21);\n\trt2800_bbp_glrt_write(rt2x00dev, 176, 0x1C);\n\trt2800_bbp_glrt_write(rt2x00dev, 177, 0x16);\n\trt2800_bbp_glrt_write(rt2x00dev, 178, 0x50);\n\trt2800_bbp_glrt_write(rt2x00dev, 179, 0x4A);\n\trt2800_bbp_glrt_write(rt2x00dev, 180, 0x43);\n\trt2800_bbp_glrt_write(rt2x00dev, 181, 0x50);\n\trt2800_bbp_glrt_write(rt2x00dev, 182, 0x10);\n\trt2800_bbp_glrt_write(rt2x00dev, 183, 0x10);\n\trt2800_bbp_glrt_write(rt2x00dev, 184, 0x10);\n\trt2800_bbp_glrt_write(rt2x00dev, 185, 0x10);\n\trt2800_bbp_glrt_write(rt2x00dev, 200, 0x7D);\n\trt2800_bbp_glrt_write(rt2x00dev, 201, 0x14);\n\trt2800_bbp_glrt_write(rt2x00dev, 202, 0x32);\n\trt2800_bbp_glrt_write(rt2x00dev, 203, 0x2C);\n\trt2800_bbp_glrt_write(rt2x00dev, 204, 0x36);\n\trt2800_bbp_glrt_write(rt2x00dev, 205, 0x4C);\n\trt2800_bbp_glrt_write(rt2x00dev, 206, 0x43);\n\trt2800_bbp_glrt_write(rt2x00dev, 207, 0x2C);\n\trt2800_bbp_glrt_write(rt2x00dev, 208, 0x2E);\n\trt2800_bbp_glrt_write(rt2x00dev, 209, 0x36);\n\trt2800_bbp_glrt_write(rt2x00dev, 210, 0x30);\n\trt2800_bbp_glrt_write(rt2x00dev, 211, 0x6E);\n\n\t \n\trt2800_bbp_dcoc_write(rt2x00dev, 140, 0x0C);\n\trt2800_bbp_dcoc_write(rt2x00dev, 141, 0x00);\n\trt2800_bbp_dcoc_write(rt2x00dev, 142, 0x10);\n\trt2800_bbp_dcoc_write(rt2x00dev, 143, 0x10);\n\trt2800_bbp_dcoc_write(rt2x00dev, 144, 0x10);\n\trt2800_bbp_dcoc_write(rt2x00dev, 145, 0x10);\n\trt2800_bbp_dcoc_write(rt2x00dev, 146, 0x08);\n\trt2800_bbp_dcoc_write(rt2x00dev, 147, 0x40);\n\trt2800_bbp_dcoc_write(rt2x00dev, 148, 0x04);\n\trt2800_bbp_dcoc_write(rt2x00dev, 149, 0x04);\n\trt2800_bbp_dcoc_write(rt2x00dev, 150, 0x08);\n\trt2800_bbp_dcoc_write(rt2x00dev, 151, 0x08);\n\trt2800_bbp_dcoc_write(rt2x00dev, 152, 0x03);\n\trt2800_bbp_dcoc_write(rt2x00dev, 153, 0x03);\n\trt2800_bbp_dcoc_write(rt2x00dev, 154, 0x03);\n\trt2800_bbp_dcoc_write(rt2x00dev, 155, 0x02);\n\trt2800_bbp_dcoc_write(rt2x00dev, 156, 0x40);\n\trt2800_bbp_dcoc_write(rt2x00dev, 157, 0x40);\n\trt2800_bbp_dcoc_write(rt2x00dev, 158, 0x64);\n\trt2800_bbp_dcoc_write(rt2x00dev, 159, 0x64);\n\n\trt2800_bbp4_mac_if_ctrl(rt2x00dev);\n}\n\nstatic void rt2800_init_bbp(struct rt2x00_dev *rt2x00dev)\n{\n\tunsigned int i;\n\tu16 eeprom;\n\tu8 reg_id;\n\tu8 value;\n\n\tif (rt2800_is_305x_soc(rt2x00dev))\n\t\trt2800_init_bbp_305x_soc(rt2x00dev);\n\n\tswitch (rt2x00dev->chip.rt) {\n\tcase RT2860:\n\tcase RT2872:\n\tcase RT2883:\n\t\trt2800_init_bbp_28xx(rt2x00dev);\n\t\tbreak;\n\tcase RT3070:\n\tcase RT3071:\n\tcase RT3090:\n\t\trt2800_init_bbp_30xx(rt2x00dev);\n\t\tbreak;\n\tcase RT3290:\n\t\trt2800_init_bbp_3290(rt2x00dev);\n\t\tbreak;\n\tcase RT3352:\n\tcase RT5350:\n\t\trt2800_init_bbp_3352(rt2x00dev);\n\t\tbreak;\n\tcase RT3390:\n\t\trt2800_init_bbp_3390(rt2x00dev);\n\t\tbreak;\n\tcase RT3572:\n\t\trt2800_init_bbp_3572(rt2x00dev);\n\t\tbreak;\n\tcase RT3593:\n\t\trt2800_init_bbp_3593(rt2x00dev);\n\t\treturn;\n\tcase RT3883:\n\t\trt2800_init_bbp_3883(rt2x00dev);\n\t\treturn;\n\tcase RT5390:\n\tcase RT5392:\n\t\trt2800_init_bbp_53xx(rt2x00dev);\n\t\tbreak;\n\tcase RT5592:\n\t\trt2800_init_bbp_5592(rt2x00dev);\n\t\treturn;\n\tcase RT6352:\n\t\trt2800_init_bbp_6352(rt2x00dev);\n\t\tbreak;\n\t}\n\n\tfor (i = 0; i < EEPROM_BBP_SIZE; i++) {\n\t\teeprom = rt2800_eeprom_read_from_array(rt2x00dev,\n\t\t\t\t\t\t       EEPROM_BBP_START, i);\n\n\t\tif (eeprom != 0xffff && eeprom != 0x0000) {\n\t\t\treg_id = rt2x00_get_field16(eeprom, EEPROM_BBP_REG_ID);\n\t\t\tvalue = rt2x00_get_field16(eeprom, EEPROM_BBP_VALUE);\n\t\t\trt2800_bbp_write(rt2x00dev, reg_id, value);\n\t\t}\n\t}\n}\n\nstatic void rt2800_led_open_drain_enable(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 reg;\n\n\treg = rt2800_register_read(rt2x00dev, OPT_14_CSR);\n\trt2x00_set_field32(&reg, OPT_14_CSR_BIT0, 1);\n\trt2800_register_write(rt2x00dev, OPT_14_CSR, reg);\n}\n\nstatic u8 rt2800_init_rx_filter(struct rt2x00_dev *rt2x00dev, bool bw40,\n\t\t\t\tu8 filter_target)\n{\n\tunsigned int i;\n\tu8 bbp;\n\tu8 rfcsr;\n\tu8 passband;\n\tu8 stopband;\n\tu8 overtuned = 0;\n\tu8 rfcsr24 = (bw40) ? 0x27 : 0x07;\n\n\trt2800_rfcsr_write(rt2x00dev, 24, rfcsr24);\n\n\tbbp = rt2800_bbp_read(rt2x00dev, 4);\n\trt2x00_set_field8(&bbp, BBP4_BANDWIDTH, 2 * bw40);\n\trt2800_bbp_write(rt2x00dev, 4, bbp);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 31);\n\trt2x00_set_field8(&rfcsr, RFCSR31_RX_H20M, bw40);\n\trt2800_rfcsr_write(rt2x00dev, 31, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 22);\n\trt2x00_set_field8(&rfcsr, RFCSR22_BASEBAND_LOOPBACK, 1);\n\trt2800_rfcsr_write(rt2x00dev, 22, rfcsr);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 24, 0);\n\n\tfor (i = 0; i < 100; i++) {\n\t\trt2800_bbp_write(rt2x00dev, 25, 0x90);\n\t\tmsleep(1);\n\n\t\tpassband = rt2800_bbp_read(rt2x00dev, 55);\n\t\tif (passband)\n\t\t\tbreak;\n\t}\n\n\t \n\trt2800_bbp_write(rt2x00dev, 24, 0x06);\n\n\tfor (i = 0; i < 100; i++) {\n\t\trt2800_bbp_write(rt2x00dev, 25, 0x90);\n\t\tmsleep(1);\n\n\t\tstopband = rt2800_bbp_read(rt2x00dev, 55);\n\n\t\tif ((passband - stopband) <= filter_target) {\n\t\t\trfcsr24++;\n\t\t\tovertuned += ((passband - stopband) == filter_target);\n\t\t} else\n\t\t\tbreak;\n\n\t\trt2800_rfcsr_write(rt2x00dev, 24, rfcsr24);\n\t}\n\n\trfcsr24 -= !!overtuned;\n\n\trt2800_rfcsr_write(rt2x00dev, 24, rfcsr24);\n\treturn rfcsr24;\n}\n\nstatic void rt2800_rf_init_calibration(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t       const unsigned int rf_reg)\n{\n\tu8 rfcsr;\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, rf_reg);\n\trt2x00_set_field8(&rfcsr, FIELD8(0x80), 1);\n\trt2800_rfcsr_write(rt2x00dev, rf_reg, rfcsr);\n\tmsleep(1);\n\trt2x00_set_field8(&rfcsr, FIELD8(0x80), 0);\n\trt2800_rfcsr_write(rt2x00dev, rf_reg, rfcsr);\n}\n\nstatic void rt2800_rx_filter_calibration(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu8 filter_tgt_bw20;\n\tu8 filter_tgt_bw40;\n\tu8 rfcsr, bbp;\n\n\t \n\tif (rt2x00_rt(rt2x00dev, RT3070)) {\n\t\tfilter_tgt_bw20 = 0x16;\n\t\tfilter_tgt_bw40 = 0x19;\n\t} else {\n\t\tfilter_tgt_bw20 = 0x13;\n\t\tfilter_tgt_bw40 = 0x15;\n\t}\n\n\tdrv_data->calibration_bw20 =\n\t\trt2800_init_rx_filter(rt2x00dev, false, filter_tgt_bw20);\n\tdrv_data->calibration_bw40 =\n\t\trt2800_init_rx_filter(rt2x00dev, true, filter_tgt_bw40);\n\n\t \n\tdrv_data->bbp25 = rt2800_bbp_read(rt2x00dev, 25);\n\tdrv_data->bbp26 = rt2800_bbp_read(rt2x00dev, 26);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 24, 0);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 22);\n\trt2x00_set_field8(&rfcsr, RFCSR22_BASEBAND_LOOPBACK, 0);\n\trt2800_rfcsr_write(rt2x00dev, 22, rfcsr);\n\n\t \n\tbbp = rt2800_bbp_read(rt2x00dev, 4);\n\trt2x00_set_field8(&bbp, BBP4_BANDWIDTH, 0);\n\trt2800_bbp_write(rt2x00dev, 4, bbp);\n}\n\nstatic void rt2800_normal_mode_setup_3xxx(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu8 min_gain, rfcsr, bbp;\n\tu16 eeprom;\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 17);\n\n\trt2x00_set_field8(&rfcsr, RFCSR17_TX_LO1_EN, 0);\n\tif (rt2x00_rt(rt2x00dev, RT3070) ||\n\t    rt2x00_rt_rev_lt(rt2x00dev, RT3071, REV_RT3071E) ||\n\t    rt2x00_rt_rev_lt(rt2x00dev, RT3090, REV_RT3090E) ||\n\t    rt2x00_rt_rev_lt(rt2x00dev, RT3390, REV_RT3390E)) {\n\t\tif (!rt2x00_has_cap_external_lna_bg(rt2x00dev))\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR17_R, 1);\n\t}\n\n\tmin_gain = rt2x00_rt(rt2x00dev, RT3070) ? 1 : 2;\n\tif (drv_data->txmixer_gain_24g >= min_gain) {\n\t\trt2x00_set_field8(&rfcsr, RFCSR17_TXMIXER_GAIN,\n\t\t\t\t  drv_data->txmixer_gain_24g);\n\t}\n\n\trt2800_rfcsr_write(rt2x00dev, 17, rfcsr);\n\n\tif (rt2x00_rt(rt2x00dev, RT3090)) {\n\t\t \n\t\tbbp = rt2800_bbp_read(rt2x00dev, 138);\n\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF0);\n\t\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_RXPATH) == 1)\n\t\t\trt2x00_set_field8(&bbp, BBP138_RX_ADC1, 0);\n\t\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_TXPATH) == 1)\n\t\t\trt2x00_set_field8(&bbp, BBP138_TX_DAC1, 1);\n\t\trt2800_bbp_write(rt2x00dev, 138, bbp);\n\t}\n\n\tif (rt2x00_rt(rt2x00dev, RT3070)) {\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 27);\n\t\tif (rt2x00_rt_rev_lt(rt2x00dev, RT3070, REV_RT3070F))\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR27_R1, 3);\n\t\telse\n\t\t\trt2x00_set_field8(&rfcsr, RFCSR27_R1, 0);\n\t\trt2x00_set_field8(&rfcsr, RFCSR27_R2, 0);\n\t\trt2x00_set_field8(&rfcsr, RFCSR27_R3, 0);\n\t\trt2x00_set_field8(&rfcsr, RFCSR27_R4, 0);\n\t\trt2800_rfcsr_write(rt2x00dev, 27, rfcsr);\n\t} else if (rt2x00_rt(rt2x00dev, RT3071) ||\n\t\t   rt2x00_rt(rt2x00dev, RT3090) ||\n\t\t   rt2x00_rt(rt2x00dev, RT3390)) {\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 0);\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 0);\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\n\t\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 15);\n\t\trt2x00_set_field8(&rfcsr, RFCSR15_TX_LO2_EN, 0);\n\t\trt2800_rfcsr_write(rt2x00dev, 15, rfcsr);\n\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 20);\n\t\trt2x00_set_field8(&rfcsr, RFCSR20_RX_LO1_EN, 0);\n\t\trt2800_rfcsr_write(rt2x00dev, 20, rfcsr);\n\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 21);\n\t\trt2x00_set_field8(&rfcsr, RFCSR21_RX_LO2_EN, 0);\n\t\trt2800_rfcsr_write(rt2x00dev, 21, rfcsr);\n\t}\n}\n\nstatic void rt2800_normal_mode_setup_3593(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu8 rfcsr;\n\tu8 tx_gain;\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 50);\n\trt2x00_set_field8(&rfcsr, RFCSR50_TX_LO2_EN, 0);\n\trt2800_rfcsr_write(rt2x00dev, 50, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 51);\n\ttx_gain = rt2x00_get_field8(drv_data->txmixer_gain_24g,\n\t\t\t\t    RFCSR17_TXMIXER_GAIN);\n\trt2x00_set_field8(&rfcsr, RFCSR51_BITS24, tx_gain);\n\trt2800_rfcsr_write(rt2x00dev, 51, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 38);\n\trt2x00_set_field8(&rfcsr, RFCSR38_RX_LO1_EN, 0);\n\trt2800_rfcsr_write(rt2x00dev, 38, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 39);\n\trt2x00_set_field8(&rfcsr, RFCSR39_RX_LO2_EN, 0);\n\trt2800_rfcsr_write(rt2x00dev, 39, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_PLL_PD, 1);\n\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 30);\n\trt2x00_set_field8(&rfcsr, RFCSR30_RX_VCM, 2);\n\trt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\n\n\t \n}\n\nstatic void rt2800_normal_mode_setup_5xxx(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 reg;\n\tu16 eeprom;\n\n\t \n\treg = rt2800_bbp_read(rt2x00dev, 138);\n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF0);\n\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_RXPATH) == 1)\n\t\trt2x00_set_field8(&reg, BBP138_RX_ADC1, 0);\n\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_TXPATH) == 1)\n\t\trt2x00_set_field8(&reg, BBP138_TX_DAC1, 1);\n\trt2800_bbp_write(rt2x00dev, 138, reg);\n\n\treg = rt2800_rfcsr_read(rt2x00dev, 38);\n\trt2x00_set_field8(&reg, RFCSR38_RX_LO1_EN, 0);\n\trt2800_rfcsr_write(rt2x00dev, 38, reg);\n\n\treg = rt2800_rfcsr_read(rt2x00dev, 39);\n\trt2x00_set_field8(&reg, RFCSR39_RX_LO2_EN, 0);\n\trt2800_rfcsr_write(rt2x00dev, 39, reg);\n\n\trt2800_bbp4_mac_if_ctrl(rt2x00dev);\n\n\treg = rt2800_rfcsr_read(rt2x00dev, 30);\n\trt2x00_set_field8(&reg, RFCSR30_RX_VCM, 2);\n\trt2800_rfcsr_write(rt2x00dev, 30, reg);\n}\n\nstatic void rt2800_init_rfcsr_305x_soc(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_rf_init_calibration(rt2x00dev, 30);\n\n\trt2800_rfcsr_write(rt2x00dev, 0, 0x50);\n\trt2800_rfcsr_write(rt2x00dev, 1, 0x01);\n\trt2800_rfcsr_write(rt2x00dev, 2, 0xf7);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x75);\n\trt2800_rfcsr_write(rt2x00dev, 4, 0x40);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0x50);\n\trt2800_rfcsr_write(rt2x00dev, 8, 0x39);\n\trt2800_rfcsr_write(rt2x00dev, 9, 0x0f);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0x60);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x21);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x75);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x75);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x90);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x58);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0xb3);\n\trt2800_rfcsr_write(rt2x00dev, 17, 0x92);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x2c);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0xba);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0xdb);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 23, 0x31);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0x08);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x01);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x25);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x23);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x13);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x83);\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x00);\n}\n\nstatic void rt2800_init_rfcsr_30xx(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 rfcsr;\n\tu16 eeprom;\n\tu32 reg;\n\n\t \n\trt2800_rf_init_calibration(rt2x00dev, 30);\n\n\trt2800_rfcsr_write(rt2x00dev, 4, 0x40);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0x60);\n\trt2800_rfcsr_write(rt2x00dev, 9, 0x0f);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0x41);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x21);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x7b);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x90);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x58);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0xb3);\n\trt2800_rfcsr_write(rt2x00dev, 17, 0x92);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x2c);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0xba);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0xdb);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0x16);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x1f);\n\n\tif (rt2x00_rt_rev_lt(rt2x00dev, RT3070, REV_RT3070F)) {\n\t\treg = rt2800_register_read(rt2x00dev, LDO_CFG0);\n\t\trt2x00_set_field32(&reg, LDO_CFG0_BGSEL, 1);\n\t\trt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 3);\n\t\trt2800_register_write(rt2x00dev, LDO_CFG0, reg);\n\t} else if (rt2x00_rt(rt2x00dev, RT3071) ||\n\t\t   rt2x00_rt(rt2x00dev, RT3090)) {\n\t\trt2800_rfcsr_write(rt2x00dev, 31, 0x14);\n\n\t\trfcsr = rt2800_rfcsr_read(rt2x00dev, 6);\n\t\trt2x00_set_field8(&rfcsr, RFCSR6_R2, 1);\n\t\trt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\n\n\t\treg = rt2800_register_read(rt2x00dev, LDO_CFG0);\n\t\trt2x00_set_field32(&reg, LDO_CFG0_BGSEL, 1);\n\t\tif (rt2x00_rt_rev_lt(rt2x00dev, RT3071, REV_RT3071E) ||\n\t\t    rt2x00_rt_rev_lt(rt2x00dev, RT3090, REV_RT3090E)) {\n\t\t\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1);\n\t\t\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_DAC_TEST))\n\t\t\t\trt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 3);\n\t\t\telse\n\t\t\t\trt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 0);\n\t\t}\n\t\trt2800_register_write(rt2x00dev, LDO_CFG0, reg);\n\n\t\treg = rt2800_register_read(rt2x00dev, GPIO_SWITCH);\n\t\trt2x00_set_field32(&reg, GPIO_SWITCH_5, 0);\n\t\trt2800_register_write(rt2x00dev, GPIO_SWITCH, reg);\n\t}\n\n\trt2800_rx_filter_calibration(rt2x00dev);\n\n\tif (rt2x00_rt_rev_lt(rt2x00dev, RT3070, REV_RT3070F) ||\n\t    rt2x00_rt_rev_lt(rt2x00dev, RT3071, REV_RT3071E) ||\n\t    rt2x00_rt_rev_lt(rt2x00dev, RT3090, REV_RT3090E))\n\t\trt2800_rfcsr_write(rt2x00dev, 27, 0x03);\n\n\trt2800_led_open_drain_enable(rt2x00dev);\n\trt2800_normal_mode_setup_3xxx(rt2x00dev);\n}\n\nstatic void rt2800_init_rfcsr_3290(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 rfcsr;\n\n\trt2800_rf_init_calibration(rt2x00dev, 2);\n\n\trt2800_rfcsr_write(rt2x00dev, 1, 0x0f);\n\trt2800_rfcsr_write(rt2x00dev, 2, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x08);\n\trt2800_rfcsr_write(rt2x00dev, 4, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0xa0);\n\trt2800_rfcsr_write(rt2x00dev, 8, 0xf3);\n\trt2800_rfcsr_write(rt2x00dev, 9, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0x53);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x4a);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x46);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x9f);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x20);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x83);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x82);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x09);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 32, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 33, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 34, 0x05);\n\trt2800_rfcsr_write(rt2x00dev, 35, 0x12);\n\trt2800_rfcsr_write(rt2x00dev, 36, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 38, 0x85);\n\trt2800_rfcsr_write(rt2x00dev, 39, 0x1b);\n\trt2800_rfcsr_write(rt2x00dev, 40, 0x0b);\n\trt2800_rfcsr_write(rt2x00dev, 41, 0xbb);\n\trt2800_rfcsr_write(rt2x00dev, 42, 0xd5);\n\trt2800_rfcsr_write(rt2x00dev, 43, 0x7b);\n\trt2800_rfcsr_write(rt2x00dev, 44, 0x0e);\n\trt2800_rfcsr_write(rt2x00dev, 45, 0xa2);\n\trt2800_rfcsr_write(rt2x00dev, 46, 0x73);\n\trt2800_rfcsr_write(rt2x00dev, 47, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 48, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 49, 0x98);\n\trt2800_rfcsr_write(rt2x00dev, 52, 0x38);\n\trt2800_rfcsr_write(rt2x00dev, 53, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 54, 0x78);\n\trt2800_rfcsr_write(rt2x00dev, 55, 0x43);\n\trt2800_rfcsr_write(rt2x00dev, 56, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 57, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 58, 0x7f);\n\trt2800_rfcsr_write(rt2x00dev, 59, 0x09);\n\trt2800_rfcsr_write(rt2x00dev, 60, 0x45);\n\trt2800_rfcsr_write(rt2x00dev, 61, 0xc1);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 29);\n\trt2x00_set_field8(&rfcsr, RFCSR29_RSSI_GAIN, 3);\n\trt2800_rfcsr_write(rt2x00dev, 29, rfcsr);\n\n\trt2800_led_open_drain_enable(rt2x00dev);\n\trt2800_normal_mode_setup_3xxx(rt2x00dev);\n}\n\nstatic void rt2800_init_rfcsr_3352(struct rt2x00_dev *rt2x00dev)\n{\n\tint tx0_ext_pa = test_bit(CAPABILITY_EXTERNAL_PA_TX0,\n\t\t\t\t  &rt2x00dev->cap_flags);\n\tint tx1_ext_pa = test_bit(CAPABILITY_EXTERNAL_PA_TX1,\n\t\t\t\t  &rt2x00dev->cap_flags);\n\tu8 rfcsr;\n\n\trt2800_rf_init_calibration(rt2x00dev, 30);\n\n\trt2800_rfcsr_write(rt2x00dev, 0, 0xf0);\n\trt2800_rfcsr_write(rt2x00dev, 1, 0x23);\n\trt2800_rfcsr_write(rt2x00dev, 2, 0x50);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x18);\n\trt2800_rfcsr_write(rt2x00dev, 4, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0x33);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 8, 0xf1);\n\trt2800_rfcsr_write(rt2x00dev, 9, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0xd2);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x42);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x1c);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x5a);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0x01);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x45);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 23, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 32, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 33, 0x00);\n\trfcsr = 0x01;\n\tif (tx0_ext_pa)\n\t\trt2x00_set_field8(&rfcsr, RFCSR34_TX0_EXT_PA, 1);\n\tif (tx1_ext_pa)\n\t\trt2x00_set_field8(&rfcsr, RFCSR34_TX1_EXT_PA, 1);\n\trt2800_rfcsr_write(rt2x00dev, 34, rfcsr);\n\trt2800_rfcsr_write(rt2x00dev, 35, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 36, 0xbd);\n\trt2800_rfcsr_write(rt2x00dev, 37, 0x3c);\n\trt2800_rfcsr_write(rt2x00dev, 38, 0x5f);\n\trt2800_rfcsr_write(rt2x00dev, 39, 0xc5);\n\trt2800_rfcsr_write(rt2x00dev, 40, 0x33);\n\trfcsr = 0x52;\n\tif (!tx0_ext_pa) {\n\t\trt2x00_set_field8(&rfcsr, RFCSR41_BIT1, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR41_BIT4, 1);\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 41, rfcsr);\n\trfcsr = 0x52;\n\tif (!tx1_ext_pa) {\n\t\trt2x00_set_field8(&rfcsr, RFCSR42_BIT1, 1);\n\t\trt2x00_set_field8(&rfcsr, RFCSR42_BIT4, 1);\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 42, rfcsr);\n\trt2800_rfcsr_write(rt2x00dev, 43, 0xdb);\n\trt2800_rfcsr_write(rt2x00dev, 44, 0xdb);\n\trt2800_rfcsr_write(rt2x00dev, 45, 0xdb);\n\trt2800_rfcsr_write(rt2x00dev, 46, 0xdd);\n\trt2800_rfcsr_write(rt2x00dev, 47, 0x0d);\n\trt2800_rfcsr_write(rt2x00dev, 48, 0x14);\n\trt2800_rfcsr_write(rt2x00dev, 49, 0x00);\n\trfcsr = 0x2d;\n\tif (tx0_ext_pa)\n\t\trt2x00_set_field8(&rfcsr, RFCSR50_TX0_EXT_PA, 1);\n\tif (tx1_ext_pa)\n\t\trt2x00_set_field8(&rfcsr, RFCSR50_TX1_EXT_PA, 1);\n\trt2800_rfcsr_write(rt2x00dev, 50, rfcsr);\n\trt2800_rfcsr_write(rt2x00dev, 51, (tx0_ext_pa ? 0x52 : 0x7f));\n\trt2800_rfcsr_write(rt2x00dev, 52, (tx0_ext_pa ? 0xc0 : 0x00));\n\trt2800_rfcsr_write(rt2x00dev, 53, (tx0_ext_pa ? 0xd2 : 0x52));\n\trt2800_rfcsr_write(rt2x00dev, 54, (tx0_ext_pa ? 0xc0 : 0x1b));\n\trt2800_rfcsr_write(rt2x00dev, 55, (tx1_ext_pa ? 0x52 : 0x7f));\n\trt2800_rfcsr_write(rt2x00dev, 56, (tx1_ext_pa ? 0xc0 : 0x00));\n\trt2800_rfcsr_write(rt2x00dev, 57, (tx0_ext_pa ? 0x49 : 0x52));\n\trt2800_rfcsr_write(rt2x00dev, 58, (tx1_ext_pa ? 0xc0 : 0x1b));\n\trt2800_rfcsr_write(rt2x00dev, 59, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 60, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 61, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 62, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 63, 0x00);\n\n\trt2800_rx_filter_calibration(rt2x00dev);\n\trt2800_led_open_drain_enable(rt2x00dev);\n\trt2800_normal_mode_setup_3xxx(rt2x00dev);\n}\n\nstatic void rt2800_init_rfcsr_3390(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 reg;\n\n\trt2800_rf_init_calibration(rt2x00dev, 30);\n\n\trt2800_rfcsr_write(rt2x00dev, 0, 0xa0);\n\trt2800_rfcsr_write(rt2x00dev, 1, 0xe1);\n\trt2800_rfcsr_write(rt2x00dev, 2, 0xf1);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x62);\n\trt2800_rfcsr_write(rt2x00dev, 4, 0x40);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x8b);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0x42);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0x34);\n\trt2800_rfcsr_write(rt2x00dev, 8, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 9, 0xc0);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0x61);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x21);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x3b);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0xe0);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x90);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x53);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0xe0);\n\trt2800_rfcsr_write(rt2x00dev, 17, 0x94);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x5c);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x4a);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0xb2);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0xf6);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 23, 0x14);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0x08);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x3d);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x85);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x41);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x8f);\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x20);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x0f);\n\n\treg = rt2800_register_read(rt2x00dev, GPIO_SWITCH);\n\trt2x00_set_field32(&reg, GPIO_SWITCH_5, 0);\n\trt2800_register_write(rt2x00dev, GPIO_SWITCH, reg);\n\n\trt2800_rx_filter_calibration(rt2x00dev);\n\n\tif (rt2x00_rt_rev_lt(rt2x00dev, RT3390, REV_RT3390E))\n\t\trt2800_rfcsr_write(rt2x00dev, 27, 0x03);\n\n\trt2800_led_open_drain_enable(rt2x00dev);\n\trt2800_normal_mode_setup_3xxx(rt2x00dev);\n}\n\nstatic void rt2800_init_rfcsr_3572(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 rfcsr;\n\tu32 reg;\n\n\trt2800_rf_init_calibration(rt2x00dev, 30);\n\n\trt2800_rfcsr_write(rt2x00dev, 0, 0x70);\n\trt2800_rfcsr_write(rt2x00dev, 1, 0x81);\n\trt2800_rfcsr_write(rt2x00dev, 2, 0xf1);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 4, 0x4c);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x05);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0x4a);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0xd8);\n\trt2800_rfcsr_write(rt2x00dev, 9, 0xc3);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0xf1);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0xb9);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x70);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x65);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0xa0);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x53);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0x4c);\n\trt2800_rfcsr_write(rt2x00dev, 17, 0x23);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0xac);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x93);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0xb3);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0xd0);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 23, 0x3c);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0x16);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x15);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x85);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x9b);\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x09);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x10);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 6);\n\trt2x00_set_field8(&rfcsr, RFCSR6_R2, 1);\n\trt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\n\n\treg = rt2800_register_read(rt2x00dev, LDO_CFG0);\n\trt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 3);\n\trt2x00_set_field32(&reg, LDO_CFG0_BGSEL, 1);\n\trt2800_register_write(rt2x00dev, LDO_CFG0, reg);\n\tmsleep(1);\n\treg = rt2800_register_read(rt2x00dev, LDO_CFG0);\n\trt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 0);\n\trt2x00_set_field32(&reg, LDO_CFG0_BGSEL, 1);\n\trt2800_register_write(rt2x00dev, LDO_CFG0, reg);\n\n\trt2800_rx_filter_calibration(rt2x00dev);\n\trt2800_led_open_drain_enable(rt2x00dev);\n\trt2800_normal_mode_setup_3xxx(rt2x00dev);\n}\n\nstatic void rt3593_post_bbp_init(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 bbp;\n\tbool txbf_enabled = false;  \n\n\tbbp = rt2800_bbp_read(rt2x00dev, 105);\n\tif (rt2x00dev->default_ant.rx_chain_num == 1)\n\t\trt2x00_set_field8(&bbp, BBP105_MLD, 0);\n\telse\n\t\trt2x00_set_field8(&bbp, BBP105_MLD, 1);\n\trt2800_bbp_write(rt2x00dev, 105, bbp);\n\n\trt2800_bbp4_mac_if_ctrl(rt2x00dev);\n\n\trt2800_bbp_write(rt2x00dev, 92, 0x02);\n\trt2800_bbp_write(rt2x00dev, 82, 0x82);\n\trt2800_bbp_write(rt2x00dev, 106, 0x05);\n\trt2800_bbp_write(rt2x00dev, 104, 0x92);\n\trt2800_bbp_write(rt2x00dev, 88, 0x90);\n\trt2800_bbp_write(rt2x00dev, 148, 0xc8);\n\trt2800_bbp_write(rt2x00dev, 47, 0x48);\n\trt2800_bbp_write(rt2x00dev, 120, 0x50);\n\n\tif (txbf_enabled)\n\t\trt2800_bbp_write(rt2x00dev, 163, 0xbd);\n\telse\n\t\trt2800_bbp_write(rt2x00dev, 163, 0x9d);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 142, 6);\n\trt2800_bbp_write(rt2x00dev, 143, 160);\n\trt2800_bbp_write(rt2x00dev, 142, 7);\n\trt2800_bbp_write(rt2x00dev, 143, 161);\n\trt2800_bbp_write(rt2x00dev, 142, 8);\n\trt2800_bbp_write(rt2x00dev, 143, 162);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 31, 0x08);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 68, 0x0b);\n\n\t \n\trt2800_bbp_write(rt2x00dev, 105, 0x04);\n\n}\n\nstatic void rt2800_init_rfcsr_3593(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu32 reg;\n\tu8 rfcsr;\n\n\t \n\treg = rt2800_register_read(rt2x00dev, GPIO_SWITCH);\n\trt2x00_set_field32(&reg, GPIO_SWITCH_4, 0);\n\trt2x00_set_field32(&reg, GPIO_SWITCH_7, 0);\n\trt2800_register_write(rt2x00dev, GPIO_SWITCH, reg);\n\n\t \n\trt2800_rfcsr_write(rt2x00dev, 1, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0x40);\n\trt2800_rfcsr_write(rt2x00dev, 8, 0xf1);\n\trt2800_rfcsr_write(rt2x00dev, 9, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0xd3);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x40);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x4e);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x12);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x40);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x20);\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 32, 0x78);\n\trt2800_rfcsr_write(rt2x00dev, 33, 0x3b);\n\trt2800_rfcsr_write(rt2x00dev, 34, 0x3c);\n\trt2800_rfcsr_write(rt2x00dev, 35, 0xe0);\n\trt2800_rfcsr_write(rt2x00dev, 38, 0x86);\n\trt2800_rfcsr_write(rt2x00dev, 39, 0x23);\n\trt2800_rfcsr_write(rt2x00dev, 44, 0xd3);\n\trt2800_rfcsr_write(rt2x00dev, 45, 0xbb);\n\trt2800_rfcsr_write(rt2x00dev, 46, 0x60);\n\trt2800_rfcsr_write(rt2x00dev, 49, 0x8e);\n\trt2800_rfcsr_write(rt2x00dev, 50, 0x86);\n\trt2800_rfcsr_write(rt2x00dev, 51, 0x75);\n\trt2800_rfcsr_write(rt2x00dev, 52, 0x45);\n\trt2800_rfcsr_write(rt2x00dev, 53, 0x18);\n\trt2800_rfcsr_write(rt2x00dev, 54, 0x18);\n\trt2800_rfcsr_write(rt2x00dev, 55, 0x18);\n\trt2800_rfcsr_write(rt2x00dev, 56, 0xdb);\n\trt2800_rfcsr_write(rt2x00dev, 57, 0x6e);\n\n\t \n\t \n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 2);\n\trt2x00_set_field8(&rfcsr, RFCSR2_RESCAL_EN, 1);\n\trt2800_rfcsr_write(rt2x00dev, 2, rfcsr);\n\n\trt2800_freq_cal_mode1(rt2x00dev);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 18);\n\trt2x00_set_field8(&rfcsr, RFCSR18_XO_TUNE_BYPASS, 1);\n\trt2800_rfcsr_write(rt2x00dev, 18, rfcsr);\n\n\treg = rt2800_register_read(rt2x00dev, LDO_CFG0);\n\trt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 3);\n\trt2x00_set_field32(&reg, LDO_CFG0_BGSEL, 1);\n\trt2800_register_write(rt2x00dev, LDO_CFG0, reg);\n\tusleep_range(1000, 1500);\n\treg = rt2800_register_read(rt2x00dev, LDO_CFG0);\n\trt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 0);\n\trt2800_register_write(rt2x00dev, LDO_CFG0, reg);\n\n\t \n\tdrv_data->calibration_bw20 = 0x1f;\n\tdrv_data->calibration_bw40 = 0x2f;\n\n\t \n\tdrv_data->bbp25 = rt2800_bbp_read(rt2x00dev, 25);\n\tdrv_data->bbp26 = rt2800_bbp_read(rt2x00dev, 26);\n\n\trt2800_led_open_drain_enable(rt2x00dev);\n\trt2800_normal_mode_setup_3593(rt2x00dev);\n\n\trt3593_post_bbp_init(rt2x00dev);\n\n\t \n}\n\nstatic void rt2800_init_rfcsr_5350(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_rfcsr_write(rt2x00dev, 0, 0xf0);\n\trt2800_rfcsr_write(rt2x00dev, 1, 0x23);\n\trt2800_rfcsr_write(rt2x00dev, 2, 0x50);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x08);\n\trt2800_rfcsr_write(rt2x00dev, 4, 0x49);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0xe0);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 8, 0xf1);\n\trt2800_rfcsr_write(rt2x00dev, 9, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0x53);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x4a);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x46);\n\tif (rt2800_clk_is_20mhz(rt2x00dev))\n\t\trt2800_rfcsr_write(rt2x00dev, 13, 0x1f);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 13, 0x9f);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0xc0);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x20);\n\trt2800_rfcsr_write(rt2x00dev, 23, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0xd0);\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 32, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 33, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 34, 0x07);\n\trt2800_rfcsr_write(rt2x00dev, 35, 0x12);\n\trt2800_rfcsr_write(rt2x00dev, 36, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 37, 0x08);\n\trt2800_rfcsr_write(rt2x00dev, 38, 0x85);\n\trt2800_rfcsr_write(rt2x00dev, 39, 0x1b);\n\trt2800_rfcsr_write(rt2x00dev, 40, 0x0b);\n\trt2800_rfcsr_write(rt2x00dev, 41, 0xbb);\n\trt2800_rfcsr_write(rt2x00dev, 42, 0xd5);\n\trt2800_rfcsr_write(rt2x00dev, 43, 0x9b);\n\trt2800_rfcsr_write(rt2x00dev, 44, 0x0c);\n\trt2800_rfcsr_write(rt2x00dev, 45, 0xa6);\n\trt2800_rfcsr_write(rt2x00dev, 46, 0x73);\n\trt2800_rfcsr_write(rt2x00dev, 47, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 48, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 49, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 50, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 51, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 52, 0x38);\n\trt2800_rfcsr_write(rt2x00dev, 53, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 54, 0x38);\n\trt2800_rfcsr_write(rt2x00dev, 55, 0x43);\n\trt2800_rfcsr_write(rt2x00dev, 56, 0x82);\n\trt2800_rfcsr_write(rt2x00dev, 57, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 58, 0x39);\n\trt2800_rfcsr_write(rt2x00dev, 59, 0x0b);\n\trt2800_rfcsr_write(rt2x00dev, 60, 0x45);\n\trt2800_rfcsr_write(rt2x00dev, 61, 0xd1);\n\trt2800_rfcsr_write(rt2x00dev, 62, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 63, 0x00);\n}\n\nstatic void rt2800_init_rfcsr_3883(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 rfcsr;\n\n\t \n\tconst unsigned int eco = 5;\n\n\trt2800_rf_init_calibration(rt2x00dev, 2);\n\n\trt2800_rfcsr_write(rt2x00dev, 0, 0xe0);\n\trt2800_rfcsr_write(rt2x00dev, 1, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 2, 0x50);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x20);\n\trt2800_rfcsr_write(rt2x00dev, 4, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0x40);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 8, 0x5b);\n\trt2800_rfcsr_write(rt2x00dev, 9, 0x08);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0xd3);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x48);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x1a);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x12);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0x00);\n\n\t \n\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x40);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x20);\n\trt2800_rfcsr_write(rt2x00dev, 23, 0xc0);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 32, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 33, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 34, 0x20);\n\trt2800_rfcsr_write(rt2x00dev, 35, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 36, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 37, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 38, 0x86);\n\trt2800_rfcsr_write(rt2x00dev, 39, 0x23);\n\trt2800_rfcsr_write(rt2x00dev, 40, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 41, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 42, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 43, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 44, 0x93);\n\trt2800_rfcsr_write(rt2x00dev, 45, 0xbb);\n\trt2800_rfcsr_write(rt2x00dev, 46, 0x60);\n\trt2800_rfcsr_write(rt2x00dev, 47, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 48, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 49, 0x8e);\n\trt2800_rfcsr_write(rt2x00dev, 50, 0x86);\n\trt2800_rfcsr_write(rt2x00dev, 51, 0x51);\n\trt2800_rfcsr_write(rt2x00dev, 52, 0x05);\n\trt2800_rfcsr_write(rt2x00dev, 53, 0x76);\n\trt2800_rfcsr_write(rt2x00dev, 54, 0x76);\n\trt2800_rfcsr_write(rt2x00dev, 55, 0x76);\n\trt2800_rfcsr_write(rt2x00dev, 56, 0xdb);\n\trt2800_rfcsr_write(rt2x00dev, 57, 0x3e);\n\trt2800_rfcsr_write(rt2x00dev, 58, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 59, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 60, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 61, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 62, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 63, 0x00);\n\n\t \n\n\trt2800_bbp_write(rt2x00dev, 137, 0x0f);\n\n\trt2800_bbp_write(rt2x00dev, 163, 0x9d);\n\n\trt2800_bbp_write(rt2x00dev, 105, 0x05);\n\n\trt2800_bbp_write(rt2x00dev, 179, 0x02);\n\trt2800_bbp_write(rt2x00dev, 180, 0x00);\n\trt2800_bbp_write(rt2x00dev, 182, 0x40);\n\trt2800_bbp_write(rt2x00dev, 180, 0x01);\n\trt2800_bbp_write(rt2x00dev, 182, 0x9c);\n\n\trt2800_bbp_write(rt2x00dev, 179, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 142, 0x04);\n\trt2800_bbp_write(rt2x00dev, 143, 0x3b);\n\trt2800_bbp_write(rt2x00dev, 142, 0x06);\n\trt2800_bbp_write(rt2x00dev, 143, 0xa0);\n\trt2800_bbp_write(rt2x00dev, 142, 0x07);\n\trt2800_bbp_write(rt2x00dev, 143, 0xa1);\n\trt2800_bbp_write(rt2x00dev, 142, 0x08);\n\trt2800_bbp_write(rt2x00dev, 143, 0xa2);\n\trt2800_bbp_write(rt2x00dev, 148, 0xc8);\n\n\tif (eco == 5) {\n\t\trt2800_rfcsr_write(rt2x00dev, 32, 0xd8);\n\t\trt2800_rfcsr_write(rt2x00dev, 33, 0x32);\n\t}\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 2);\n\trt2x00_set_field8(&rfcsr, RFCSR2_RESCAL_BP, 0);\n\trt2x00_set_field8(&rfcsr, RFCSR2_RESCAL_EN, 1);\n\trt2800_rfcsr_write(rt2x00dev, 2, rfcsr);\n\tmsleep(1);\n\trt2x00_set_field8(&rfcsr, RFCSR2_RESCAL_EN, 0);\n\trt2800_rfcsr_write(rt2x00dev, 2, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 1);\n\trt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\n\trt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 6);\n\trfcsr |= 0xc0;\n\trt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 22);\n\trfcsr |= 0x20;\n\trt2800_rfcsr_write(rt2x00dev, 22, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 46);\n\trfcsr |= 0x20;\n\trt2800_rfcsr_write(rt2x00dev, 46, rfcsr);\n\n\trfcsr = rt2800_rfcsr_read(rt2x00dev, 20);\n\trfcsr &= ~0xee;\n\trt2800_rfcsr_write(rt2x00dev, 20, rfcsr);\n}\n\nstatic void rt2800_init_rfcsr_5390(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_rf_init_calibration(rt2x00dev, 2);\n\n\trt2800_rfcsr_write(rt2x00dev, 1, 0x0f);\n\trt2800_rfcsr_write(rt2x00dev, 2, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x88);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x10);\n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F))\n\t\trt2800_rfcsr_write(rt2x00dev, 6, 0xe0);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 6, 0xa0);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0x53);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x4a);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x46);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x9f);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x00);\n\n\trt2800_rfcsr_write(rt2x00dev, 20, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x20);\n\trt2800_rfcsr_write(rt2x00dev, 23, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0x00);\n\tif (rt2x00_is_usb(rt2x00dev) &&\n\t    rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F))\n\t\trt2800_rfcsr_write(rt2x00dev, 25, 0x80);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 25, 0xc0);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x09);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x10);\n\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 32, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 33, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 34, 0x07);\n\trt2800_rfcsr_write(rt2x00dev, 35, 0x12);\n\trt2800_rfcsr_write(rt2x00dev, 36, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 37, 0x08);\n\trt2800_rfcsr_write(rt2x00dev, 38, 0x85);\n\trt2800_rfcsr_write(rt2x00dev, 39, 0x1b);\n\n\trt2800_rfcsr_write(rt2x00dev, 40, 0x0b);\n\trt2800_rfcsr_write(rt2x00dev, 41, 0xbb);\n\trt2800_rfcsr_write(rt2x00dev, 42, 0xd2);\n\trt2800_rfcsr_write(rt2x00dev, 43, 0x9a);\n\trt2800_rfcsr_write(rt2x00dev, 44, 0x0e);\n\trt2800_rfcsr_write(rt2x00dev, 45, 0xa2);\n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F))\n\t\trt2800_rfcsr_write(rt2x00dev, 46, 0x73);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 46, 0x7b);\n\trt2800_rfcsr_write(rt2x00dev, 47, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 48, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 49, 0x94);\n\n\trt2800_rfcsr_write(rt2x00dev, 52, 0x38);\n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F))\n\t\trt2800_rfcsr_write(rt2x00dev, 53, 0x00);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 53, 0x84);\n\trt2800_rfcsr_write(rt2x00dev, 54, 0x78);\n\trt2800_rfcsr_write(rt2x00dev, 55, 0x44);\n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F))\n\t\trt2800_rfcsr_write(rt2x00dev, 56, 0x42);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 56, 0x22);\n\trt2800_rfcsr_write(rt2x00dev, 57, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 58, 0x7f);\n\trt2800_rfcsr_write(rt2x00dev, 59, 0x8f);\n\n\trt2800_rfcsr_write(rt2x00dev, 60, 0x45);\n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F)) {\n\t\tif (rt2x00_is_usb(rt2x00dev))\n\t\t\trt2800_rfcsr_write(rt2x00dev, 61, 0xd1);\n\t\telse\n\t\t\trt2800_rfcsr_write(rt2x00dev, 61, 0xd5);\n\t} else {\n\t\tif (rt2x00_is_usb(rt2x00dev))\n\t\t\trt2800_rfcsr_write(rt2x00dev, 61, 0xdd);\n\t\telse\n\t\t\trt2800_rfcsr_write(rt2x00dev, 61, 0xb5);\n\t}\n\trt2800_rfcsr_write(rt2x00dev, 62, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 63, 0x00);\n\n\trt2800_normal_mode_setup_5xxx(rt2x00dev);\n\n\trt2800_led_open_drain_enable(rt2x00dev);\n}\n\nstatic void rt2800_init_rfcsr_5392(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_rf_init_calibration(rt2x00dev, 2);\n\n\trt2800_rfcsr_write(rt2x00dev, 1, 0x17);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x88);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0xe0);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0x53);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x4a);\n\trt2800_rfcsr_write(rt2x00dev, 12, 0x46);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x9f);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x4d);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0x8d);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x20);\n\trt2800_rfcsr_write(rt2x00dev, 23, 0x0b);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0x44);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x82);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x09);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 32, 0x20);\n\trt2800_rfcsr_write(rt2x00dev, 33, 0xC0);\n\trt2800_rfcsr_write(rt2x00dev, 34, 0x07);\n\trt2800_rfcsr_write(rt2x00dev, 35, 0x12);\n\trt2800_rfcsr_write(rt2x00dev, 36, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 37, 0x08);\n\trt2800_rfcsr_write(rt2x00dev, 38, 0x89);\n\trt2800_rfcsr_write(rt2x00dev, 39, 0x1b);\n\trt2800_rfcsr_write(rt2x00dev, 40, 0x0f);\n\trt2800_rfcsr_write(rt2x00dev, 41, 0xbb);\n\trt2800_rfcsr_write(rt2x00dev, 42, 0xd5);\n\trt2800_rfcsr_write(rt2x00dev, 43, 0x9b);\n\trt2800_rfcsr_write(rt2x00dev, 44, 0x0e);\n\trt2800_rfcsr_write(rt2x00dev, 45, 0xa2);\n\trt2800_rfcsr_write(rt2x00dev, 46, 0x73);\n\trt2800_rfcsr_write(rt2x00dev, 47, 0x0c);\n\trt2800_rfcsr_write(rt2x00dev, 48, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 49, 0x94);\n\trt2800_rfcsr_write(rt2x00dev, 50, 0x94);\n\trt2800_rfcsr_write(rt2x00dev, 51, 0x3a);\n\trt2800_rfcsr_write(rt2x00dev, 52, 0x48);\n\trt2800_rfcsr_write(rt2x00dev, 53, 0x44);\n\trt2800_rfcsr_write(rt2x00dev, 54, 0x38);\n\trt2800_rfcsr_write(rt2x00dev, 55, 0x43);\n\trt2800_rfcsr_write(rt2x00dev, 56, 0xa1);\n\trt2800_rfcsr_write(rt2x00dev, 57, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 58, 0x39);\n\trt2800_rfcsr_write(rt2x00dev, 59, 0x07);\n\trt2800_rfcsr_write(rt2x00dev, 60, 0x45);\n\trt2800_rfcsr_write(rt2x00dev, 61, 0x91);\n\trt2800_rfcsr_write(rt2x00dev, 62, 0x39);\n\trt2800_rfcsr_write(rt2x00dev, 63, 0x07);\n\n\trt2800_normal_mode_setup_5xxx(rt2x00dev);\n\n\trt2800_led_open_drain_enable(rt2x00dev);\n}\n\nstatic void rt2800_init_rfcsr_5592(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_rf_init_calibration(rt2x00dev, 30);\n\n\trt2800_rfcsr_write(rt2x00dev, 1, 0x3F);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0x08);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0xE4);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x4D);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0x8D);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x82);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x10);\n\trt2800_rfcsr_write(rt2x00dev, 33, 0xC0);\n\trt2800_rfcsr_write(rt2x00dev, 34, 0x07);\n\trt2800_rfcsr_write(rt2x00dev, 35, 0x12);\n\trt2800_rfcsr_write(rt2x00dev, 47, 0x0C);\n\trt2800_rfcsr_write(rt2x00dev, 53, 0x22);\n\trt2800_rfcsr_write(rt2x00dev, 63, 0x07);\n\n\trt2800_rfcsr_write(rt2x00dev, 2, 0x80);\n\tmsleep(1);\n\n\trt2800_freq_cal_mode1(rt2x00dev);\n\n\t \n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5592, REV_RT5592C))\n\t\trt2800_bbp_write(rt2x00dev, 103, 0xc0);\n\n\trt2800_normal_mode_setup_5xxx(rt2x00dev);\n\n\tif (rt2x00_rt_rev_lt(rt2x00dev, RT5592, REV_RT5592C))\n\t\trt2800_rfcsr_write(rt2x00dev, 27, 0x03);\n\n\trt2800_led_open_drain_enable(rt2x00dev);\n}\n\nstatic void rt2800_rf_self_txdc_cal(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 rfb5r1_org, rfb7r1_org, rfvalue;\n\tu32 mac0518, mac051c, mac0528, mac052c;\n\tu8 i;\n\n\tmac0518 = rt2800_register_read(rt2x00dev, RF_CONTROL0);\n\tmac051c = rt2800_register_read(rt2x00dev, RF_BYPASS0);\n\tmac0528 = rt2800_register_read(rt2x00dev, RF_CONTROL2);\n\tmac052c = rt2800_register_read(rt2x00dev, RF_BYPASS2);\n\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, 0x0);\n\trt2800_register_write(rt2x00dev, RF_BYPASS2, 0x0);\n\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0xC);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, 0x3306);\n\trt2800_register_write(rt2x00dev, RF_CONTROL2, 0x3330);\n\trt2800_register_write(rt2x00dev, RF_BYPASS2, 0xfffff);\n\trfb5r1_org = rt2800_rfcsr_read_bank(rt2x00dev, 5, 1);\n\trfb7r1_org = rt2800_rfcsr_read_bank(rt2x00dev, 7, 1);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 1, 0x4);\n\tfor (i = 0; i < 100; ++i) {\n\t\tusleep_range(50, 100);\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 5, 1);\n\t\tif ((rfvalue & 0x04) != 0x4)\n\t\t\tbreak;\n\t}\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 1, rfb5r1_org);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 1, 0x4);\n\tfor (i = 0; i < 100; ++i) {\n\t\tusleep_range(50, 100);\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 7, 1);\n\t\tif ((rfvalue & 0x04) != 0x4)\n\t\t\tbreak;\n\t}\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 1, rfb7r1_org);\n\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, 0x0);\n\trt2800_register_write(rt2x00dev, RF_BYPASS2, 0x0);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, mac0518);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, mac051c);\n\trt2800_register_write(rt2x00dev, RF_CONTROL2, mac0528);\n\trt2800_register_write(rt2x00dev, RF_BYPASS2, mac052c);\n}\n\nstatic int rt2800_calcrcalibrationcode(struct rt2x00_dev *rt2x00dev, int d1, int d2)\n{\n\tint calcode = ((d2 - d1) * 1000) / 43;\n\n\tif ((calcode % 10) >= 5)\n\t\tcalcode += 10;\n\tcalcode = (calcode / 10);\n\n\treturn calcode;\n}\n\nstatic void rt2800_r_calibration(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 savemacsysctrl;\n\tu8 saverfb0r1, saverfb0r34, saverfb0r35;\n\tu8 saverfb5r4, saverfb5r17, saverfb5r18;\n\tu8 saverfb5r19, saverfb5r20;\n\tu8 savebbpr22, savebbpr47, savebbpr49;\n\tu8 bytevalue = 0;\n\tint rcalcode;\n\tu8 r_cal_code = 0;\n\ts8 d1 = 0, d2 = 0;\n\tu8 rfvalue;\n\tu32 MAC_RF_BYPASS0, MAC_RF_CONTROL0, MAC_PWR_PIN_CFG;\n\tu32 maccfg;\n\n\tsaverfb0r1 = rt2800_rfcsr_read_bank(rt2x00dev, 0, 1);\n\tsaverfb0r34 = rt2800_rfcsr_read_bank(rt2x00dev, 0, 34);\n\tsaverfb0r35 = rt2800_rfcsr_read_bank(rt2x00dev, 0, 35);\n\tsaverfb5r4 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 4);\n\tsaverfb5r17 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 17);\n\tsaverfb5r18 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 18);\n\tsaverfb5r19 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 19);\n\tsaverfb5r20 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 20);\n\n\tsavebbpr22 = rt2800_bbp_read(rt2x00dev, 22);\n\tsavebbpr47 = rt2800_bbp_read(rt2x00dev, 47);\n\tsavebbpr49 = rt2800_bbp_read(rt2x00dev, 49);\n\n\tsavemacsysctrl = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\tMAC_RF_BYPASS0 = rt2800_register_read(rt2x00dev, RF_BYPASS0);\n\tMAC_RF_CONTROL0 = rt2800_register_read(rt2x00dev, RF_CONTROL0);\n\tMAC_PWR_PIN_CFG = rt2800_register_read(rt2x00dev, PWR_PIN_CFG);\n\n\tmaccfg = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\tmaccfg &= (~0x04);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, maccfg);\n\n\tif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev, MAC_STATUS_CFG_BBP_RF_BUSY_TX)))\n\t\trt2x00_warn(rt2x00dev, \"Wait MAC Tx Status to MAX !!!\\n\");\n\n\tmaccfg = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\tmaccfg &= (~0x08);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, maccfg);\n\n\tif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev, MAC_STATUS_CFG_BBP_RF_BUSY_RX)))\n\t\trt2x00_warn(rt2x00dev, \"Wait MAC Rx Status to MAX !!!\\n\");\n\n\trfvalue = (MAC_RF_BYPASS0 | 0x3004);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, rfvalue);\n\trfvalue = (MAC_RF_CONTROL0 | (~0x3002));\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, rfvalue);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 4, 0x27);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 17, 0x80);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 18, 0x83);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 19, 0x00);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 20, 0x20);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 1, 0x00);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 34, 0x13);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 35, 0x00);\n\n\trt2800_register_write(rt2x00dev, PWR_PIN_CFG, 0x1);\n\n\trt2800_bbp_write(rt2x00dev, 47, 0x04);\n\trt2800_bbp_write(rt2x00dev, 22, 0x80);\n\tusleep_range(100, 200);\n\tbytevalue = rt2800_bbp_read(rt2x00dev, 49);\n\tif (bytevalue > 128)\n\t\td1 = bytevalue - 256;\n\telse\n\t\td1 = (s8)bytevalue;\n\trt2800_bbp_write(rt2x00dev, 22, 0x0);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 35, 0x01);\n\n\trt2800_bbp_write(rt2x00dev, 22, 0x80);\n\tusleep_range(100, 200);\n\tbytevalue = rt2800_bbp_read(rt2x00dev, 49);\n\tif (bytevalue > 128)\n\t\td2 = bytevalue - 256;\n\telse\n\t\td2 = (s8)bytevalue;\n\trt2800_bbp_write(rt2x00dev, 22, 0x0);\n\n\trcalcode = rt2800_calcrcalibrationcode(rt2x00dev, d1, d2);\n\tif (rcalcode < 0)\n\t\tr_cal_code = 256 + rcalcode;\n\telse\n\t\tr_cal_code = (u8)rcalcode;\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 7, r_cal_code);\n\n\trt2800_bbp_write(rt2x00dev, 22, 0x0);\n\n\tbytevalue = rt2800_bbp_read(rt2x00dev, 21);\n\tbytevalue |= 0x1;\n\trt2800_bbp_write(rt2x00dev, 21, bytevalue);\n\tbytevalue = rt2800_bbp_read(rt2x00dev, 21);\n\tbytevalue &= (~0x1);\n\trt2800_bbp_write(rt2x00dev, 21, bytevalue);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 1, saverfb0r1);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 34, saverfb0r34);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 35, saverfb0r35);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 4, saverfb5r4);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 17, saverfb5r17);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 18, saverfb5r18);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 19, saverfb5r19);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 20, saverfb5r20);\n\n\trt2800_bbp_write(rt2x00dev, 22, savebbpr22);\n\trt2800_bbp_write(rt2x00dev, 47, savebbpr47);\n\trt2800_bbp_write(rt2x00dev, 49, savebbpr49);\n\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, MAC_RF_BYPASS0);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, MAC_RF_CONTROL0);\n\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, savemacsysctrl);\n\trt2800_register_write(rt2x00dev, PWR_PIN_CFG, MAC_PWR_PIN_CFG);\n}\n\nstatic void rt2800_rxdcoc_calibration(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 bbpreg = 0;\n\tu32 macvalue = 0;\n\tu8 saverfb0r2, saverfb5r4, saverfb7r4, rfvalue;\n\tint i;\n\n\tsaverfb0r2 = rt2800_rfcsr_read_bank(rt2x00dev, 0, 2);\n\trfvalue = saverfb0r2;\n\trfvalue |= 0x03;\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 2, rfvalue);\n\n\trt2800_bbp_write(rt2x00dev, 158, 141);\n\tbbpreg = rt2800_bbp_read(rt2x00dev, 159);\n\tbbpreg |= 0x10;\n\trt2800_bbp_write(rt2x00dev, 159, bbpreg);\n\n\tmacvalue = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, 0x8);\n\n\tif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev, MAC_STATUS_CFG_BBP_RF_BUSY_TX)))\n\t\trt2x00_warn(rt2x00dev, \"RF TX busy in RX RXDCOC calibration\\n\");\n\n\tsaverfb5r4 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 4);\n\tsaverfb7r4 = rt2800_rfcsr_read_bank(rt2x00dev, 7, 4);\n\tsaverfb5r4 = saverfb5r4 & (~0x40);\n\tsaverfb7r4 = saverfb7r4 & (~0x40);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 4, 0x64);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 4, saverfb5r4);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 4, saverfb7r4);\n\n\trt2800_bbp_write(rt2x00dev, 158, 141);\n\tbbpreg = rt2800_bbp_read(rt2x00dev, 159);\n\tbbpreg = bbpreg & (~0x40);\n\trt2800_bbp_write(rt2x00dev, 159, bbpreg);\n\tbbpreg |= 0x48;\n\trt2800_bbp_write(rt2x00dev, 159, bbpreg);\n\n\tfor (i = 0; i < 10000; i++) {\n\t\tbbpreg = rt2800_bbp_read(rt2x00dev, 159);\n\t\tif ((bbpreg & 0x40) == 0)\n\t\t\tbreak;\n\t\tusleep_range(50, 100);\n\t}\n\n\tbbpreg = rt2800_bbp_read(rt2x00dev, 159);\n\tbbpreg = bbpreg & (~0x40);\n\trt2800_bbp_write(rt2x00dev, 159, bbpreg);\n\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, macvalue);\n\n\trt2800_bbp_write(rt2x00dev, 158, 141);\n\tbbpreg = rt2800_bbp_read(rt2x00dev, 159);\n\tbbpreg &= (~0x10);\n\trt2800_bbp_write(rt2x00dev, 159, bbpreg);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 2, saverfb0r2);\n}\n\nstatic u32 rt2800_do_sqrt_accumulation(u32 si)\n{\n\tu32 root, root_pre, bit;\n\ts8 i;\n\n\tbit = 1 << 15;\n\troot = 0;\n\tfor (i = 15; i >= 0; i = i - 1) {\n\t\troot_pre = root + bit;\n\t\tif ((root_pre * root_pre) <= si)\n\t\t\troot = root_pre;\n\t\tbit = bit >> 1;\n\t}\n\n\treturn root;\n}\n\nstatic void rt2800_rxiq_calibration(struct rt2x00_dev *rt2x00dev)\n{\n\tu8 rfb0r1, rfb0r2, rfb0r42;\n\tu8 rfb4r0, rfb4r19;\n\tu8 rfb5r3, rfb5r4, rfb5r17, rfb5r18, rfb5r19, rfb5r20;\n\tu8 rfb6r0, rfb6r19;\n\tu8 rfb7r3, rfb7r4, rfb7r17, rfb7r18, rfb7r19, rfb7r20;\n\n\tu8 bbp1, bbp4;\n\tu8 bbpr241, bbpr242;\n\tu32 i;\n\tu8 ch_idx;\n\tu8 bbpval;\n\tu8 rfval, vga_idx = 0;\n\tint mi = 0, mq = 0, si = 0, sq = 0, riq = 0;\n\tint sigma_i, sigma_q, r_iq, g_rx;\n\tint g_imb;\n\tint ph_rx;\n\tu32 savemacsysctrl = 0;\n\tu32 orig_RF_CONTROL0 = 0;\n\tu32 orig_RF_BYPASS0 = 0;\n\tu32 orig_RF_CONTROL1 = 0;\n\tu32 orig_RF_BYPASS1 = 0;\n\tu32 orig_RF_CONTROL3 = 0;\n\tu32 orig_RF_BYPASS3 = 0;\n\tu32 bbpval1 = 0;\n\tstatic const u8 rf_vga_table[] = {0x20, 0x21, 0x22, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3f};\n\n\tsavemacsysctrl = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\torig_RF_CONTROL0 = rt2800_register_read(rt2x00dev, RF_CONTROL0);\n\torig_RF_BYPASS0 = rt2800_register_read(rt2x00dev, RF_BYPASS0);\n\torig_RF_CONTROL1 = rt2800_register_read(rt2x00dev, RF_CONTROL1);\n\torig_RF_BYPASS1 = rt2800_register_read(rt2x00dev, RF_BYPASS1);\n\torig_RF_CONTROL3 = rt2800_register_read(rt2x00dev, RF_CONTROL3);\n\torig_RF_BYPASS3 = rt2800_register_read(rt2x00dev, RF_BYPASS3);\n\n\tbbp1 = rt2800_bbp_read(rt2x00dev, 1);\n\tbbp4 = rt2800_bbp_read(rt2x00dev, 4);\n\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, 0x0);\n\n\tif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev, MAC_STATUS_CFG_BBP_RF_BUSY)))\n\t\trt2x00_warn(rt2x00dev, \"Timeout waiting for MAC status in RXIQ calibration\\n\");\n\n\tbbpval = bbp4 & (~0x18);\n\tbbpval = bbp4 | 0x00;\n\trt2800_bbp_write(rt2x00dev, 4, bbpval);\n\n\tbbpval = rt2800_bbp_read(rt2x00dev, 21);\n\tbbpval = bbpval | 1;\n\trt2800_bbp_write(rt2x00dev, 21, bbpval);\n\tbbpval = bbpval & 0xfe;\n\trt2800_bbp_write(rt2x00dev, 21, bbpval);\n\n\trt2800_register_write(rt2x00dev, RF_CONTROL1, 0x00000202);\n\trt2800_register_write(rt2x00dev, RF_BYPASS1, 0x00000303);\n\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags))\n\t\trt2800_register_write(rt2x00dev, RF_CONTROL3, 0x0101);\n\telse\n\t\trt2800_register_write(rt2x00dev, RF_CONTROL3, 0x0000);\n\n\trt2800_register_write(rt2x00dev, RF_BYPASS3, 0xf1f1);\n\n\trfb0r1 = rt2800_rfcsr_read_bank(rt2x00dev, 0, 1);\n\trfb0r2 = rt2800_rfcsr_read_bank(rt2x00dev, 0, 2);\n\trfb0r42 = rt2800_rfcsr_read_bank(rt2x00dev, 0, 42);\n\trfb4r0 = rt2800_rfcsr_read_bank(rt2x00dev, 4, 0);\n\trfb4r19 = rt2800_rfcsr_read_bank(rt2x00dev, 4, 19);\n\trfb5r3 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 3);\n\trfb5r4 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 4);\n\trfb5r17 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 17);\n\trfb5r18 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 18);\n\trfb5r19 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 19);\n\trfb5r20 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 20);\n\n\trfb6r0 = rt2800_rfcsr_read_bank(rt2x00dev, 6, 0);\n\trfb6r19 = rt2800_rfcsr_read_bank(rt2x00dev, 6, 19);\n\trfb7r3 = rt2800_rfcsr_read_bank(rt2x00dev, 7, 3);\n\trfb7r4 = rt2800_rfcsr_read_bank(rt2x00dev, 7, 4);\n\trfb7r17 = rt2800_rfcsr_read_bank(rt2x00dev, 7, 17);\n\trfb7r18 = rt2800_rfcsr_read_bank(rt2x00dev, 7, 18);\n\trfb7r19 = rt2800_rfcsr_read_bank(rt2x00dev, 7, 19);\n\trfb7r20 = rt2800_rfcsr_read_bank(rt2x00dev, 7, 20);\n\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 0, 0x87);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 19, 0x27);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 3, 0x38);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 4, 0x38);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 17, 0x80);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 18, 0xC1);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 19, 0x60);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 20, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 23, 0x0);\n\trt2800_bbp_write(rt2x00dev, 24, 0x0);\n\n\trt2800_bbp_dcoc_write(rt2x00dev, 5, 0x0);\n\n\tbbpr241 = rt2800_bbp_read(rt2x00dev, 241);\n\tbbpr242 = rt2800_bbp_read(rt2x00dev, 242);\n\n\trt2800_bbp_write(rt2x00dev, 241, 0x10);\n\trt2800_bbp_write(rt2x00dev, 242, 0x84);\n\trt2800_bbp_write(rt2x00dev, 244, 0x31);\n\n\tbbpval = rt2800_bbp_dcoc_read(rt2x00dev, 3);\n\tbbpval = bbpval & (~0x7);\n\trt2800_bbp_dcoc_write(rt2x00dev, 3, bbpval);\n\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00000004);\n\tudelay(1);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00000006);\n\tusleep_range(1, 200);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, 0x00003376);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00001006);\n\tudelay(1);\n\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags)) {\n\t\trt2800_bbp_write(rt2x00dev, 23, 0x06);\n\t\trt2800_bbp_write(rt2x00dev, 24, 0x06);\n\t} else {\n\t\trt2800_bbp_write(rt2x00dev, 23, 0x02);\n\t\trt2800_bbp_write(rt2x00dev, 24, 0x02);\n\t}\n\n\tfor (ch_idx = 0; ch_idx < 2; ch_idx = ch_idx + 1) {\n\t\tif (ch_idx == 0) {\n\t\t\trfval = rfb0r1 & (~0x3);\n\t\t\trfval = rfb0r1 | 0x1;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 0, 1, rfval);\n\t\t\trfval = rfb0r2 & (~0x33);\n\t\t\trfval = rfb0r2 | 0x11;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 0, 2, rfval);\n\t\t\trfval = rfb0r42 & (~0x50);\n\t\t\trfval = rfb0r42 | 0x10;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 0, 42, rfval);\n\n\t\t\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00001006);\n\t\t\tudelay(1);\n\n\t\t\tbbpval = bbp1 & (~0x18);\n\t\t\tbbpval = bbpval | 0x00;\n\t\t\trt2800_bbp_write(rt2x00dev, 1, bbpval);\n\n\t\t\trt2800_bbp_dcoc_write(rt2x00dev, 1, 0x00);\n\t\t} else {\n\t\t\trfval = rfb0r1 & (~0x3);\n\t\t\trfval = rfb0r1 | 0x2;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 0, 1, rfval);\n\t\t\trfval = rfb0r2 & (~0x33);\n\t\t\trfval = rfb0r2 | 0x22;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 0, 2, rfval);\n\t\t\trfval = rfb0r42 & (~0x50);\n\t\t\trfval = rfb0r42 | 0x40;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 0, 42, rfval);\n\n\t\t\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00002006);\n\t\t\tudelay(1);\n\n\t\t\tbbpval = bbp1 & (~0x18);\n\t\t\tbbpval = bbpval | 0x08;\n\t\t\trt2800_bbp_write(rt2x00dev, 1, bbpval);\n\n\t\t\trt2800_bbp_dcoc_write(rt2x00dev, 1, 0x01);\n\t\t}\n\t\tusleep_range(500, 1500);\n\n\t\tvga_idx = 0;\n\t\twhile (vga_idx < 11) {\n\t\t\trt2800_rfcsr_write_dccal(rt2x00dev, 3, rf_vga_table[vga_idx]);\n\t\t\trt2800_rfcsr_write_dccal(rt2x00dev, 4, rf_vga_table[vga_idx]);\n\n\t\t\trt2800_bbp_dcoc_write(rt2x00dev, 0, 0x93);\n\n\t\t\tfor (i = 0; i < 10000; i++) {\n\t\t\t\tbbpval = rt2800_bbp_read(rt2x00dev, 159);\n\t\t\t\tif ((bbpval & 0xff) == 0x93)\n\t\t\t\t\tusleep_range(50, 100);\n\t\t\t\telse\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\tif ((bbpval & 0xff) == 0x93) {\n\t\t\t\trt2x00_warn(rt2x00dev, \"Fatal Error: Calibration doesn't finish\");\n\t\t\t\tgoto restore_value;\n\t\t\t}\n\t\t\tfor (i = 0; i < 5; i++) {\n\t\t\t\tu32 bbptemp = 0;\n\t\t\t\tu8 value = 0;\n\t\t\t\tint result = 0;\n\n\t\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x1e);\n\t\t\t\trt2800_bbp_write(rt2x00dev, 159, i);\n\t\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x22);\n\t\t\t\tvalue = rt2800_bbp_read(rt2x00dev, 159);\n\t\t\t\tbbptemp = bbptemp + (value << 24);\n\t\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x21);\n\t\t\t\tvalue = rt2800_bbp_read(rt2x00dev, 159);\n\t\t\t\tbbptemp = bbptemp + (value << 16);\n\t\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x20);\n\t\t\t\tvalue = rt2800_bbp_read(rt2x00dev, 159);\n\t\t\t\tbbptemp = bbptemp + (value << 8);\n\t\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x1f);\n\t\t\t\tvalue = rt2800_bbp_read(rt2x00dev, 159);\n\t\t\t\tbbptemp = bbptemp + value;\n\n\t\t\t\tif (i < 2 && (bbptemp & 0x800000))\n\t\t\t\t\tresult = (bbptemp & 0xffffff) - 0x1000000;\n\t\t\t\telse\n\t\t\t\t\tresult = bbptemp;\n\n\t\t\t\tif (i == 0)\n\t\t\t\t\tmi = result / 4096;\n\t\t\t\telse if (i == 1)\n\t\t\t\t\tmq = result / 4096;\n\t\t\t\telse if (i == 2)\n\t\t\t\t\tsi = bbptemp / 4096;\n\t\t\t\telse if (i == 3)\n\t\t\t\t\tsq = bbptemp / 4096;\n\t\t\t\telse\n\t\t\t\t\triq = result / 4096;\n\t\t\t}\n\n\t\t\tbbpval1 = si - mi * mi;\n\t\t\trt2x00_dbg(rt2x00dev,\n\t\t\t\t   \"RXIQ si=%d, sq=%d, riq=%d, bbpval %d, vga_idx %d\",\n\t\t\t\t   si, sq, riq, bbpval1, vga_idx);\n\n\t\t\tif (bbpval1 >= (100 * 100))\n\t\t\t\tbreak;\n\n\t\t\tif (bbpval1 <= 100)\n\t\t\t\tvga_idx = vga_idx + 9;\n\t\t\telse if (bbpval1 <= 158)\n\t\t\t\tvga_idx = vga_idx + 8;\n\t\t\telse if (bbpval1 <= 251)\n\t\t\t\tvga_idx = vga_idx + 7;\n\t\t\telse if (bbpval1 <= 398)\n\t\t\t\tvga_idx = vga_idx + 6;\n\t\t\telse if (bbpval1 <= 630)\n\t\t\t\tvga_idx = vga_idx + 5;\n\t\t\telse if (bbpval1 <= 1000)\n\t\t\t\tvga_idx = vga_idx + 4;\n\t\t\telse if (bbpval1 <= 1584)\n\t\t\t\tvga_idx = vga_idx + 3;\n\t\t\telse if (bbpval1 <= 2511)\n\t\t\t\tvga_idx = vga_idx + 2;\n\t\t\telse\n\t\t\t\tvga_idx = vga_idx + 1;\n\t\t}\n\n\t\tsigma_i = rt2800_do_sqrt_accumulation(100 * (si - mi * mi));\n\t\tsigma_q = rt2800_do_sqrt_accumulation(100 * (sq - mq * mq));\n\t\tr_iq = 10 * (riq - (mi * mq));\n\n\t\trt2x00_dbg(rt2x00dev, \"Sigma_i=%d, Sigma_q=%d, R_iq=%d\", sigma_i, sigma_q, r_iq);\n\n\t\tif (sigma_i <= 1400 && sigma_i >= 1000 &&\n\t\t    (sigma_i - sigma_q) <= 112 &&\n\t\t    (sigma_i - sigma_q) >= -112 &&\n\t\t    mi <= 32 && mi >= -32 &&\n\t\t    mq <= 32 && mq >= -32) {\n\t\t\tr_iq = 10 * (riq - (mi * mq));\n\t\t\trt2x00_dbg(rt2x00dev, \"RXIQ Sigma_i=%d, Sigma_q=%d, R_iq=%d\\n\",\n\t\t\t\t   sigma_i, sigma_q, r_iq);\n\n\t\t\tg_rx = (1000 * sigma_q) / sigma_i;\n\t\t\tg_imb = ((-2) * 128 * (1000 - g_rx)) / (1000 + g_rx);\n\t\t\tph_rx = (r_iq * 2292) / (sigma_i * sigma_q);\n\n\t\t\tif (ph_rx > 20 || ph_rx < -20) {\n\t\t\t\tph_rx = 0;\n\t\t\t\trt2x00_warn(rt2x00dev, \"RXIQ calibration FAIL\");\n\t\t\t}\n\n\t\t\tif (g_imb > 12 || g_imb < -12) {\n\t\t\t\tg_imb = 0;\n\t\t\t\trt2x00_warn(rt2x00dev, \"RXIQ calibration FAIL\");\n\t\t\t}\n\t\t} else {\n\t\t\tg_imb = 0;\n\t\t\tph_rx = 0;\n\t\t\trt2x00_dbg(rt2x00dev, \"RXIQ Sigma_i=%d, Sigma_q=%d, R_iq=%d\\n\",\n\t\t\t\t   sigma_i, sigma_q, r_iq);\n\t\t\trt2x00_warn(rt2x00dev, \"RXIQ calibration FAIL\");\n\t\t}\n\n\t\tif (ch_idx == 0) {\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x37);\n\t\t\trt2800_bbp_write(rt2x00dev, 159, g_imb & 0x3f);\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x35);\n\t\t\trt2800_bbp_write(rt2x00dev, 159, ph_rx & 0x3f);\n\t\t} else {\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x55);\n\t\t\trt2800_bbp_write(rt2x00dev, 159, g_imb & 0x3f);\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x53);\n\t\t\trt2800_bbp_write(rt2x00dev, 159, ph_rx & 0x3f);\n\t\t}\n\t}\n\nrestore_value:\n\trt2800_bbp_write(rt2x00dev, 158, 0x3);\n\tbbpval = rt2800_bbp_read(rt2x00dev, 159);\n\trt2800_bbp_write(rt2x00dev, 159, (bbpval | 0x07));\n\n\trt2800_bbp_write(rt2x00dev, 158, 0x00);\n\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\trt2800_bbp_write(rt2x00dev, 1, bbp1);\n\trt2800_bbp_write(rt2x00dev, 4, bbp4);\n\trt2800_bbp_write(rt2x00dev, 241, bbpr241);\n\trt2800_bbp_write(rt2x00dev, 242, bbpr242);\n\n\trt2800_bbp_write(rt2x00dev, 244, 0x00);\n\tbbpval = rt2800_bbp_read(rt2x00dev, 21);\n\tbbpval |= 0x1;\n\trt2800_bbp_write(rt2x00dev, 21, bbpval);\n\tusleep_range(10, 200);\n\tbbpval &= 0xfe;\n\trt2800_bbp_write(rt2x00dev, 21, bbpval);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 1, rfb0r1);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 2, rfb0r2);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 42, rfb0r42);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 4, 0, rfb4r0);\n\trt2800_rfcsr_write_bank(rt2x00dev, 4, 19, rfb4r19);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 3, rfb5r3);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 4, rfb5r4);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 17, rfb5r17);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 18, rfb5r18);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 19, rfb5r19);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 20, rfb5r20);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 6, 0, rfb6r0);\n\trt2800_rfcsr_write_bank(rt2x00dev, 6, 19, rfb6r19);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 3, rfb7r3);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 4, rfb7r4);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 17, rfb7r17);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 18, rfb7r18);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 19, rfb7r19);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 20, rfb7r20);\n\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00000006);\n\tudelay(1);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00000004);\n\tudelay(1);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, orig_RF_CONTROL0);\n\tudelay(1);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, orig_RF_BYPASS0);\n\trt2800_register_write(rt2x00dev, RF_CONTROL1, orig_RF_CONTROL1);\n\trt2800_register_write(rt2x00dev, RF_BYPASS1, orig_RF_BYPASS1);\n\trt2800_register_write(rt2x00dev, RF_CONTROL3, orig_RF_CONTROL3);\n\trt2800_register_write(rt2x00dev, RF_BYPASS3, orig_RF_BYPASS3);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, savemacsysctrl);\n}\n\nstatic void rt2800_rf_configstore(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t  struct rf_reg_pair rf_reg_record[][13], u8 chain)\n{\n\tu8 rfvalue = 0;\n\n\tif (chain == CHAIN_0) {\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 0, 1);\n\t\trf_reg_record[CHAIN_0][0].bank = 0;\n\t\trf_reg_record[CHAIN_0][0].reg = 1;\n\t\trf_reg_record[CHAIN_0][0].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 0, 2);\n\t\trf_reg_record[CHAIN_0][1].bank = 0;\n\t\trf_reg_record[CHAIN_0][1].reg = 2;\n\t\trf_reg_record[CHAIN_0][1].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 0, 35);\n\t\trf_reg_record[CHAIN_0][2].bank = 0;\n\t\trf_reg_record[CHAIN_0][2].reg = 35;\n\t\trf_reg_record[CHAIN_0][2].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 0, 42);\n\t\trf_reg_record[CHAIN_0][3].bank = 0;\n\t\trf_reg_record[CHAIN_0][3].reg = 42;\n\t\trf_reg_record[CHAIN_0][3].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 4, 0);\n\t\trf_reg_record[CHAIN_0][4].bank = 4;\n\t\trf_reg_record[CHAIN_0][4].reg = 0;\n\t\trf_reg_record[CHAIN_0][4].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 4, 2);\n\t\trf_reg_record[CHAIN_0][5].bank = 4;\n\t\trf_reg_record[CHAIN_0][5].reg = 2;\n\t\trf_reg_record[CHAIN_0][5].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 4, 34);\n\t\trf_reg_record[CHAIN_0][6].bank = 4;\n\t\trf_reg_record[CHAIN_0][6].reg = 34;\n\t\trf_reg_record[CHAIN_0][6].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 5, 3);\n\t\trf_reg_record[CHAIN_0][7].bank = 5;\n\t\trf_reg_record[CHAIN_0][7].reg = 3;\n\t\trf_reg_record[CHAIN_0][7].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 5, 4);\n\t\trf_reg_record[CHAIN_0][8].bank = 5;\n\t\trf_reg_record[CHAIN_0][8].reg = 4;\n\t\trf_reg_record[CHAIN_0][8].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 5, 17);\n\t\trf_reg_record[CHAIN_0][9].bank = 5;\n\t\trf_reg_record[CHAIN_0][9].reg = 17;\n\t\trf_reg_record[CHAIN_0][9].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 5, 18);\n\t\trf_reg_record[CHAIN_0][10].bank = 5;\n\t\trf_reg_record[CHAIN_0][10].reg = 18;\n\t\trf_reg_record[CHAIN_0][10].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 5, 19);\n\t\trf_reg_record[CHAIN_0][11].bank = 5;\n\t\trf_reg_record[CHAIN_0][11].reg = 19;\n\t\trf_reg_record[CHAIN_0][11].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 5, 20);\n\t\trf_reg_record[CHAIN_0][12].bank = 5;\n\t\trf_reg_record[CHAIN_0][12].reg = 20;\n\t\trf_reg_record[CHAIN_0][12].value = rfvalue;\n\t} else if (chain == CHAIN_1) {\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 0, 1);\n\t\trf_reg_record[CHAIN_1][0].bank = 0;\n\t\trf_reg_record[CHAIN_1][0].reg = 1;\n\t\trf_reg_record[CHAIN_1][0].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 0, 2);\n\t\trf_reg_record[CHAIN_1][1].bank = 0;\n\t\trf_reg_record[CHAIN_1][1].reg = 2;\n\t\trf_reg_record[CHAIN_1][1].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 0, 35);\n\t\trf_reg_record[CHAIN_1][2].bank = 0;\n\t\trf_reg_record[CHAIN_1][2].reg = 35;\n\t\trf_reg_record[CHAIN_1][2].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 0, 42);\n\t\trf_reg_record[CHAIN_1][3].bank = 0;\n\t\trf_reg_record[CHAIN_1][3].reg = 42;\n\t\trf_reg_record[CHAIN_1][3].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 6, 0);\n\t\trf_reg_record[CHAIN_1][4].bank = 6;\n\t\trf_reg_record[CHAIN_1][4].reg = 0;\n\t\trf_reg_record[CHAIN_1][4].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 6, 2);\n\t\trf_reg_record[CHAIN_1][5].bank = 6;\n\t\trf_reg_record[CHAIN_1][5].reg = 2;\n\t\trf_reg_record[CHAIN_1][5].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 6, 34);\n\t\trf_reg_record[CHAIN_1][6].bank = 6;\n\t\trf_reg_record[CHAIN_1][6].reg = 34;\n\t\trf_reg_record[CHAIN_1][6].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 7, 3);\n\t\trf_reg_record[CHAIN_1][7].bank = 7;\n\t\trf_reg_record[CHAIN_1][7].reg = 3;\n\t\trf_reg_record[CHAIN_1][7].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 7, 4);\n\t\trf_reg_record[CHAIN_1][8].bank = 7;\n\t\trf_reg_record[CHAIN_1][8].reg = 4;\n\t\trf_reg_record[CHAIN_1][8].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 7, 17);\n\t\trf_reg_record[CHAIN_1][9].bank = 7;\n\t\trf_reg_record[CHAIN_1][9].reg = 17;\n\t\trf_reg_record[CHAIN_1][9].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 7, 18);\n\t\trf_reg_record[CHAIN_1][10].bank = 7;\n\t\trf_reg_record[CHAIN_1][10].reg = 18;\n\t\trf_reg_record[CHAIN_1][10].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 7, 19);\n\t\trf_reg_record[CHAIN_1][11].bank = 7;\n\t\trf_reg_record[CHAIN_1][11].reg = 19;\n\t\trf_reg_record[CHAIN_1][11].value = rfvalue;\n\t\trfvalue = rt2800_rfcsr_read_bank(rt2x00dev, 7, 20);\n\t\trf_reg_record[CHAIN_1][12].bank = 7;\n\t\trf_reg_record[CHAIN_1][12].reg = 20;\n\t\trf_reg_record[CHAIN_1][12].value = rfvalue;\n\t} else {\n\t\trt2x00_warn(rt2x00dev, \"Unknown chain = %u\\n\", chain);\n\t}\n}\n\nstatic void rt2800_rf_configrecover(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t    struct rf_reg_pair rf_record[][13])\n{\n\tu8 chain_index = 0, record_index = 0;\n\tu8 bank = 0, rf_register = 0, value = 0;\n\n\tfor (chain_index = 0; chain_index < 2; chain_index++) {\n\t\tfor (record_index = 0; record_index < 13; record_index++) {\n\t\t\tbank = rf_record[chain_index][record_index].bank;\n\t\t\trf_register = rf_record[chain_index][record_index].reg;\n\t\t\tvalue = rf_record[chain_index][record_index].value;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, bank, rf_register, value);\n\t\t\trt2x00_dbg(rt2x00dev, \"bank: %d, rf_register: %d, value: %x\\n\",\n\t\t\t\t   bank, rf_register, value);\n\t\t}\n\t}\n}\n\nstatic void rt2800_setbbptonegenerator(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_bbp_write(rt2x00dev, 158, 0xAA);\n\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 158, 0xAB);\n\trt2800_bbp_write(rt2x00dev, 159, 0x0A);\n\n\trt2800_bbp_write(rt2x00dev, 158, 0xAC);\n\trt2800_bbp_write(rt2x00dev, 159, 0x3F);\n\n\trt2800_bbp_write(rt2x00dev, 158, 0xAD);\n\trt2800_bbp_write(rt2x00dev, 159, 0x3F);\n\n\trt2800_bbp_write(rt2x00dev, 244, 0x40);\n}\n\nstatic u32 rt2800_do_fft_accumulation(struct rt2x00_dev *rt2x00dev, u8 tidx, u8 read_neg)\n{\n\tu32 macvalue = 0;\n\tint fftout_i = 0, fftout_q = 0;\n\tu32 ptmp = 0, pint = 0;\n\tu8 bbp = 0;\n\tu8 tidxi;\n\n\trt2800_bbp_write(rt2x00dev, 158, 0x00);\n\trt2800_bbp_write(rt2x00dev, 159, 0x9b);\n\n\tbbp = 0x9b;\n\n\twhile (bbp == 0x9b) {\n\t\tusleep_range(10, 50);\n\t\tbbp = rt2800_bbp_read(rt2x00dev, 159);\n\t\tbbp = bbp & 0xff;\n\t}\n\n\trt2800_bbp_write(rt2x00dev, 158, 0xba);\n\trt2800_bbp_write(rt2x00dev, 159, tidx);\n\trt2800_bbp_write(rt2x00dev, 159, tidx);\n\trt2800_bbp_write(rt2x00dev, 159, tidx);\n\n\tmacvalue = rt2800_register_read(rt2x00dev, 0x057C);\n\n\tfftout_i = (macvalue >> 16);\n\tfftout_i = (fftout_i & 0x8000) ? (fftout_i - 0x10000) : fftout_i;\n\tfftout_q = (macvalue & 0xffff);\n\tfftout_q = (fftout_q & 0x8000) ? (fftout_q - 0x10000) : fftout_q;\n\tptmp = (fftout_i * fftout_i);\n\tptmp = ptmp + (fftout_q * fftout_q);\n\tpint = ptmp;\n\trt2x00_dbg(rt2x00dev, \"I = %d,  Q = %d, power = %x\\n\", fftout_i, fftout_q, pint);\n\tif (read_neg) {\n\t\tpint = pint >> 1;\n\t\ttidxi = 0x40 - tidx;\n\t\ttidxi = tidxi & 0x3f;\n\n\t\trt2800_bbp_write(rt2x00dev, 158, 0xba);\n\t\trt2800_bbp_write(rt2x00dev, 159, tidxi);\n\t\trt2800_bbp_write(rt2x00dev, 159, tidxi);\n\t\trt2800_bbp_write(rt2x00dev, 159, tidxi);\n\n\t\tmacvalue = rt2800_register_read(rt2x00dev, 0x057C);\n\n\t\tfftout_i = (macvalue >> 16);\n\t\tfftout_i = (fftout_i & 0x8000) ? (fftout_i - 0x10000) : fftout_i;\n\t\tfftout_q = (macvalue & 0xffff);\n\t\tfftout_q = (fftout_q & 0x8000) ? (fftout_q - 0x10000) : fftout_q;\n\t\tptmp = (fftout_i * fftout_i);\n\t\tptmp = ptmp + (fftout_q * fftout_q);\n\t\tptmp = ptmp >> 1;\n\t\tpint = pint + ptmp;\n\t}\n\n\treturn pint;\n}\n\nstatic u32 rt2800_read_fft_accumulation(struct rt2x00_dev *rt2x00dev, u8 tidx)\n{\n\tu32 macvalue = 0;\n\tint fftout_i = 0, fftout_q = 0;\n\tu32 ptmp = 0, pint = 0;\n\n\trt2800_bbp_write(rt2x00dev, 158, 0xBA);\n\trt2800_bbp_write(rt2x00dev, 159, tidx);\n\trt2800_bbp_write(rt2x00dev, 159, tidx);\n\trt2800_bbp_write(rt2x00dev, 159, tidx);\n\n\tmacvalue = rt2800_register_read(rt2x00dev, 0x057C);\n\n\tfftout_i = (macvalue >> 16);\n\tfftout_i = (fftout_i & 0x8000) ? (fftout_i - 0x10000) : fftout_i;\n\tfftout_q = (macvalue & 0xffff);\n\tfftout_q = (fftout_q & 0x8000) ? (fftout_q - 0x10000) : fftout_q;\n\tptmp = (fftout_i * fftout_i);\n\tptmp = ptmp + (fftout_q * fftout_q);\n\tpint = ptmp;\n\n\treturn pint;\n}\n\nstatic void rt2800_write_dc(struct rt2x00_dev *rt2x00dev, u8 ch_idx, u8 alc, u8 iorq, u8 dc)\n{\n\tu8 bbp = 0;\n\n\trt2800_bbp_write(rt2x00dev, 158, 0xb0);\n\tbbp = alc | 0x80;\n\trt2800_bbp_write(rt2x00dev, 159, bbp);\n\n\tif (ch_idx == 0)\n\t\tbbp = (iorq == 0) ? 0xb1 : 0xb2;\n\telse\n\t\tbbp = (iorq == 0) ? 0xb8 : 0xb9;\n\n\trt2800_bbp_write(rt2x00dev, 158, bbp);\n\tbbp = dc;\n\trt2800_bbp_write(rt2x00dev, 159, bbp);\n}\n\nstatic void rt2800_loft_search(struct rt2x00_dev *rt2x00dev, u8 ch_idx,\n\t\t\t       u8 alc_idx, u8 dc_result[][RF_ALC_NUM][2])\n{\n\tu32 p0 = 0, p1 = 0, pf = 0;\n\ts8 idx0 = 0, idx1 = 0;\n\tu8 idxf[] = {0x00, 0x00};\n\tu8 ibit = 0x20;\n\tu8 iorq;\n\ts8 bidx;\n\n\trt2800_bbp_write(rt2x00dev, 158, 0xb0);\n\trt2800_bbp_write(rt2x00dev, 159, 0x80);\n\n\tfor (bidx = 5; bidx >= 0; bidx--) {\n\t\tfor (iorq = 0; iorq <= 1; iorq++) {\n\t\t\tif (idxf[iorq] == 0x20) {\n\t\t\t\tidx0 = 0x20;\n\t\t\t\tp0 = pf;\n\t\t\t} else {\n\t\t\t\tidx0 = idxf[iorq] - ibit;\n\t\t\t\tidx0 = idx0 & 0x3F;\n\t\t\t\trt2800_write_dc(rt2x00dev, ch_idx, 0, iorq, idx0);\n\t\t\t\tp0 = rt2800_do_fft_accumulation(rt2x00dev, 0x0A, 0);\n\t\t\t}\n\n\t\t\tidx1 = idxf[iorq] + (bidx == 5 ? 0 : ibit);\n\t\t\tidx1 = idx1 & 0x3F;\n\t\t\trt2800_write_dc(rt2x00dev, ch_idx, 0, iorq, idx1);\n\t\t\tp1 = rt2800_do_fft_accumulation(rt2x00dev, 0x0A, 0);\n\n\t\t\trt2x00_dbg(rt2x00dev, \"alc=%u, IorQ=%u, idx_final=%2x\\n\",\n\t\t\t\t   alc_idx, iorq, idxf[iorq]);\n\t\t\trt2x00_dbg(rt2x00dev, \"p0=%x, p1=%x, pf=%x, idx_0=%x, idx_1=%x, ibit=%x\\n\",\n\t\t\t\t   p0, p1, pf, idx0, idx1, ibit);\n\n\t\t\tif (bidx != 5 && pf <= p0 && pf < p1) {\n\t\t\t\tidxf[iorq] = idxf[iorq];\n\t\t\t} else if (p0 < p1) {\n\t\t\t\tpf = p0;\n\t\t\t\tidxf[iorq] = idx0 & 0x3F;\n\t\t\t} else {\n\t\t\t\tpf = p1;\n\t\t\t\tidxf[iorq] = idx1 & 0x3F;\n\t\t\t}\n\t\t\trt2x00_dbg(rt2x00dev, \"IorQ=%u, idx_final[%u]:%x, pf:%8x\\n\",\n\t\t\t\t   iorq, iorq, idxf[iorq], pf);\n\n\t\t\trt2800_write_dc(rt2x00dev, ch_idx, 0, iorq, idxf[iorq]);\n\t\t}\n\t\tibit = ibit >> 1;\n\t}\n\tdc_result[ch_idx][alc_idx][0] = idxf[0];\n\tdc_result[ch_idx][alc_idx][1] = idxf[1];\n}\n\nstatic void rt2800_iq_search(struct rt2x00_dev *rt2x00dev, u8 ch_idx, u8 *ges, u8 *pes)\n{\n\tu32 p0 = 0, p1 = 0, pf = 0;\n\ts8 perr = 0, gerr = 0, iq_err = 0;\n\ts8 pef = 0, gef = 0;\n\ts8 psta, pend;\n\ts8 gsta, gend;\n\n\tu8 ibit = 0x20;\n\tu8 first_search = 0x00, touch_neg_max = 0x00;\n\ts8 idx0 = 0, idx1 = 0;\n\tu8 gop;\n\tu8 bbp = 0;\n\ts8 bidx;\n\n\tfor (bidx = 5; bidx >= 1; bidx--) {\n\t\tfor (gop = 0; gop < 2; gop++) {\n\t\t\tif (gop == 1 || bidx < 4) {\n\t\t\t\tif (gop == 0)\n\t\t\t\t\tiq_err = gerr;\n\t\t\t\telse\n\t\t\t\t\tiq_err = perr;\n\n\t\t\t\tfirst_search = (gop == 0) ? (bidx == 3) : (bidx == 5);\n\t\t\t\ttouch_neg_max = (gop) ? ((iq_err & 0x0F) == 0x08) :\n\t\t\t\t\t\t\t((iq_err & 0x3F) == 0x20);\n\n\t\t\t\tif (touch_neg_max) {\n\t\t\t\t\tp0 = pf;\n\t\t\t\t\tidx0 = iq_err;\n\t\t\t\t} else {\n\t\t\t\t\tidx0 = iq_err - ibit;\n\t\t\t\t\tbbp = (ch_idx == 0) ? ((gop == 0) ? 0x28 : 0x29) :\n\t\t\t\t\t\t\t      ((gop == 0) ? 0x46 : 0x47);\n\n\t\t\t\t\trt2800_bbp_write(rt2x00dev, 158, bbp);\n\t\t\t\t\trt2800_bbp_write(rt2x00dev, 159, idx0);\n\n\t\t\t\t\tp0 = rt2800_do_fft_accumulation(rt2x00dev, 0x14, 1);\n\t\t\t\t}\n\n\t\t\t\tidx1 = iq_err + (first_search ? 0 : ibit);\n\t\t\t\tidx1 = (gop == 0) ? (idx1 & 0x0F) : (idx1 & 0x3F);\n\n\t\t\t\tbbp = (ch_idx == 0) ? (gop == 0) ? 0x28 : 0x29 :\n\t\t\t\t      (gop == 0) ? 0x46 : 0x47;\n\n\t\t\t\trt2800_bbp_write(rt2x00dev, 158, bbp);\n\t\t\t\trt2800_bbp_write(rt2x00dev, 159, idx1);\n\n\t\t\t\tp1 = rt2800_do_fft_accumulation(rt2x00dev, 0x14, 1);\n\n\t\t\t\trt2x00_dbg(rt2x00dev,\n\t\t\t\t\t   \"p0=%x, p1=%x, pwer_final=%x, idx0=%x, idx1=%x, iq_err=%x, gop=%d, ibit=%x\\n\",\n\t\t\t\t\t   p0, p1, pf, idx0, idx1, iq_err, gop, ibit);\n\n\t\t\t\tif (!(!first_search && pf <= p0 && pf < p1)) {\n\t\t\t\t\tif (p0 < p1) {\n\t\t\t\t\t\tpf = p0;\n\t\t\t\t\t\tiq_err = idx0;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tpf = p1;\n\t\t\t\t\t\tiq_err = idx1;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tbbp = (ch_idx == 0) ? (gop == 0) ? 0x28 : 0x29 :\n\t\t\t\t\t\t      (gop == 0) ? 0x46 : 0x47;\n\n\t\t\t\trt2800_bbp_write(rt2x00dev, 158, bbp);\n\t\t\t\trt2800_bbp_write(rt2x00dev, 159, iq_err);\n\n\t\t\t\tif (gop == 0)\n\t\t\t\t\tgerr = iq_err;\n\t\t\t\telse\n\t\t\t\t\tperr = iq_err;\n\n\t\t\t\trt2x00_dbg(rt2x00dev, \"IQCalibration pf=%8x (%2x, %2x) !\\n\",\n\t\t\t\t\t   pf, gerr & 0x0F, perr & 0x3F);\n\t\t\t}\n\t\t}\n\n\t\tif (bidx > 0)\n\t\t\tibit = (ibit >> 1);\n\t}\n\tgerr = (gerr & 0x08) ? (gerr & 0x0F) - 0x10 : (gerr & 0x0F);\n\tperr = (perr & 0x20) ? (perr & 0x3F) - 0x40 : (perr & 0x3F);\n\n\tgerr = (gerr < -0x07) ? -0x07 : (gerr > 0x05) ? 0x05 : gerr;\n\tgsta = gerr - 1;\n\tgend = gerr + 2;\n\n\tperr = (perr < -0x1f) ? -0x1f : (perr > 0x1d) ? 0x1d : perr;\n\tpsta = perr - 1;\n\tpend = perr + 2;\n\n\tfor (gef = gsta; gef <= gend; gef = gef + 1)\n\t\tfor (pef = psta; pef <= pend; pef = pef + 1) {\n\t\t\tbbp = (ch_idx == 0) ? 0x28 : 0x46;\n\t\t\trt2800_bbp_write(rt2x00dev, 158, bbp);\n\t\t\trt2800_bbp_write(rt2x00dev, 159, gef & 0x0F);\n\n\t\t\tbbp = (ch_idx == 0) ? 0x29 : 0x47;\n\t\t\trt2800_bbp_write(rt2x00dev, 158, bbp);\n\t\t\trt2800_bbp_write(rt2x00dev, 159, pef & 0x3F);\n\n\t\t\tp1 = rt2800_do_fft_accumulation(rt2x00dev, 0x14, 1);\n\t\t\tif (gef == gsta && pef == psta) {\n\t\t\t\tpf = p1;\n\t\t\t\tgerr = gef;\n\t\t\t\tperr = pef;\n\t\t\t} else if (pf > p1) {\n\t\t\t\tpf = p1;\n\t\t\t\tgerr = gef;\n\t\t\t\tperr = pef;\n\t\t\t}\n\t\t\trt2x00_dbg(rt2x00dev, \"Fine IQCalibration p1=%8x pf=%8x (%2x, %2x) !\\n\",\n\t\t\t\t   p1, pf, gef & 0x0F, pef & 0x3F);\n\t\t}\n\n\tges[ch_idx] = gerr & 0x0F;\n\tpes[ch_idx] = perr & 0x3F;\n}\n\nstatic void rt2800_rf_aux_tx0_loopback(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 1, 0x21);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 2, 0x10);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 35, 0x00);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 42, 0x1b);\n\trt2800_rfcsr_write_bank(rt2x00dev, 4, 0, 0x81);\n\trt2800_rfcsr_write_bank(rt2x00dev, 4, 2, 0x81);\n\trt2800_rfcsr_write_bank(rt2x00dev, 4, 34, 0xee);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 3, 0x2d);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 4, 0x2d);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 17, 0x80);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 18, 0xd7);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 19, 0xa2);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 20, 0x20);\n}\n\nstatic void rt2800_rf_aux_tx1_loopback(struct rt2x00_dev *rt2x00dev)\n{\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 1, 0x22);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 2, 0x20);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 35, 0x00);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 42, 0x4b);\n\trt2800_rfcsr_write_bank(rt2x00dev, 6, 0, 0x81);\n\trt2800_rfcsr_write_bank(rt2x00dev, 6, 2, 0x81);\n\trt2800_rfcsr_write_bank(rt2x00dev, 6, 34, 0xee);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 3, 0x2d);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 4, 0x2d);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 17, 0x80);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 18, 0xd7);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 19, 0xa2);\n\trt2800_rfcsr_write_bank(rt2x00dev, 7, 20, 0x20);\n}\n\nstatic void rt2800_loft_iq_calibration(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct rf_reg_pair rf_store[CHAIN_NUM][13];\n\tu32 macorg1 = 0;\n\tu32 macorg2 = 0;\n\tu32 macorg3 = 0;\n\tu32 macorg4 = 0;\n\tu32 macorg5 = 0;\n\tu32 orig528 = 0;\n\tu32 orig52c = 0;\n\n\tu32 savemacsysctrl = 0;\n\tu32 macvalue = 0;\n\tu32 mac13b8 = 0;\n\tu32 p0 = 0, p1 = 0;\n\tu32 p0_idx10 = 0, p1_idx10 = 0;\n\n\tu8 rfvalue;\n\tu8 loft_dc_search_result[CHAIN_NUM][RF_ALC_NUM][2];\n\tu8 ger[CHAIN_NUM], per[CHAIN_NUM];\n\n\tu8 vga_gain[] = {14, 14};\n\tu8 bbp = 0, ch_idx = 0, rf_alc_idx = 0, idx = 0;\n\tu8 bbpr30, rfb0r39, rfb0r42;\n\tu8 bbpr1;\n\tu8 bbpr4;\n\tu8 bbpr241, bbpr242;\n\tu8 count_step;\n\n\tstatic const u8 rf_gain[] = {0x00, 0x01, 0x02, 0x04, 0x08, 0x0c};\n\tstatic const u8 rfvga_gain_table[] = {0x24, 0x25, 0x26, 0x27, 0x28, 0x2c, 0x2d, 0x2e, 0x2f, 0x30,\n\t\t\t\t\t      0x31, 0x38, 0x39, 0x3a, 0x3b, 0x3c, 0x3d, 0x3e, 0x3F};\n\tstatic const u8 bbp_2324gain[] = {0x16, 0x14, 0x12, 0x10, 0x0c, 0x08};\n\n\tsavemacsysctrl = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\tmacorg1 = rt2800_register_read(rt2x00dev, TX_PIN_CFG);\n\tmacorg2 = rt2800_register_read(rt2x00dev, RF_CONTROL0);\n\tmacorg3 = rt2800_register_read(rt2x00dev, RF_BYPASS0);\n\tmacorg4 = rt2800_register_read(rt2x00dev, RF_CONTROL3);\n\tmacorg5 = rt2800_register_read(rt2x00dev, RF_BYPASS3);\n\tmac13b8 = rt2800_register_read(rt2x00dev, 0x13b8);\n\torig528 = rt2800_register_read(rt2x00dev, RF_CONTROL2);\n\torig52c = rt2800_register_read(rt2x00dev, RF_BYPASS2);\n\n\tmacvalue = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\tmacvalue &= (~0x04);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, macvalue);\n\n\tif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev, MAC_STATUS_CFG_BBP_RF_BUSY_TX)))\n\t\trt2x00_warn(rt2x00dev, \"RF TX busy in LOFT IQ calibration\\n\");\n\n\tmacvalue = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\tmacvalue &= (~0x08);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, macvalue);\n\n\tif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev, MAC_STATUS_CFG_BBP_RF_BUSY_RX)))\n\t\trt2x00_warn(rt2x00dev, \"RF RX busy in LOFT IQ calibration\\n\");\n\n\tfor (ch_idx = 0; ch_idx < 2; ch_idx++)\n\t\trt2800_rf_configstore(rt2x00dev, rf_store, ch_idx);\n\n\tbbpr30 = rt2800_bbp_read(rt2x00dev, 30);\n\trfb0r39 = rt2800_rfcsr_read_bank(rt2x00dev, 0, 39);\n\trfb0r42 = rt2800_rfcsr_read_bank(rt2x00dev, 0, 42);\n\n\trt2800_bbp_write(rt2x00dev, 30, 0x1F);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 39, 0x80);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 42, 0x5B);\n\n\trt2800_bbp_write(rt2x00dev, 23, 0x00);\n\trt2800_bbp_write(rt2x00dev, 24, 0x00);\n\n\trt2800_setbbptonegenerator(rt2x00dev);\n\n\tfor (ch_idx = 0; ch_idx < 2; ch_idx++) {\n\t\trt2800_bbp_write(rt2x00dev, 23, 0x00);\n\t\trt2800_bbp_write(rt2x00dev, 24, 0x00);\n\t\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, 0x00);\n\t\trt2800_register_write(rt2x00dev, TX_PIN_CFG, 0x0000000F);\n\t\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00000004);\n\t\trt2800_register_write(rt2x00dev, RF_BYPASS0, 0x00003306);\n\t\trt2800_register_write(rt2x00dev, 0x13b8, 0x10);\n\t\tudelay(1);\n\n\t\tif (ch_idx == 0)\n\t\t\trt2800_rf_aux_tx0_loopback(rt2x00dev);\n\t\telse\n\t\t\trt2800_rf_aux_tx1_loopback(rt2x00dev);\n\n\t\tudelay(1);\n\n\t\tif (ch_idx == 0)\n\t\t\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00001004);\n\t\telse\n\t\t\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00002004);\n\n\t\trt2800_bbp_write(rt2x00dev, 158, 0x05);\n\t\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\n\t\trt2800_bbp_write(rt2x00dev, 158, 0x01);\n\t\tif (ch_idx == 0)\n\t\t\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\t\telse\n\t\t\trt2800_bbp_write(rt2x00dev, 159, 0x01);\n\n\t\tvga_gain[ch_idx] = 18;\n\t\tfor (rf_alc_idx = 0; rf_alc_idx < 3; rf_alc_idx++) {\n\t\t\trt2800_bbp_write(rt2x00dev, 23, bbp_2324gain[rf_alc_idx]);\n\t\t\trt2800_bbp_write(rt2x00dev, 24, bbp_2324gain[rf_alc_idx]);\n\n\t\t\tmacvalue = rt2800_register_read(rt2x00dev, RF_CONTROL3);\n\t\t\tmacvalue &= (~0x0000F1F1);\n\t\t\tmacvalue |= (rf_gain[rf_alc_idx] << 4);\n\t\t\tmacvalue |= (rf_gain[rf_alc_idx] << 12);\n\t\t\trt2800_register_write(rt2x00dev, RF_CONTROL3, macvalue);\n\t\t\tmacvalue = (0x0000F1F1);\n\t\t\trt2800_register_write(rt2x00dev, RF_BYPASS3, macvalue);\n\n\t\t\tif (rf_alc_idx == 0) {\n\t\t\t\trt2800_write_dc(rt2x00dev, ch_idx, 0, 1, 0x21);\n\t\t\t\tfor (; vga_gain[ch_idx] > 0;\n\t\t\t\t     vga_gain[ch_idx] = vga_gain[ch_idx] - 2) {\n\t\t\t\t\trfvalue = rfvga_gain_table[vga_gain[ch_idx]];\n\t\t\t\t\trt2800_rfcsr_write_dccal(rt2x00dev, 3, rfvalue);\n\t\t\t\t\trt2800_rfcsr_write_dccal(rt2x00dev, 4, rfvalue);\n\t\t\t\t\trt2800_write_dc(rt2x00dev, ch_idx, 0, 1, 0x00);\n\t\t\t\t\trt2800_write_dc(rt2x00dev, ch_idx, 0, 0, 0x00);\n\t\t\t\t\tp0 = rt2800_do_fft_accumulation(rt2x00dev, 0x0A, 0);\n\t\t\t\t\trt2800_write_dc(rt2x00dev, ch_idx, 0, 0, 0x21);\n\t\t\t\t\tp1 = rt2800_do_fft_accumulation(rt2x00dev, 0x0A, 0);\n\t\t\t\t\trt2x00_dbg(rt2x00dev, \"LOFT AGC %d %d\\n\", p0, p1);\n\t\t\t\t\tif ((p0 < 7000 * 7000) && (p1 < (7000 * 7000)))\n\t\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\trt2800_write_dc(rt2x00dev, ch_idx, 0, 0, 0x00);\n\t\t\t\trt2800_write_dc(rt2x00dev, ch_idx, 0, 1, 0x00);\n\n\t\t\t\trt2x00_dbg(rt2x00dev, \"Used VGA %d %x\\n\", vga_gain[ch_idx],\n\t\t\t\t\t   rfvga_gain_table[vga_gain[ch_idx]]);\n\n\t\t\t\tif (vga_gain[ch_idx] < 0)\n\t\t\t\t\tvga_gain[ch_idx] = 0;\n\t\t\t}\n\n\t\t\trfvalue = rfvga_gain_table[vga_gain[ch_idx]];\n\n\t\t\trt2800_rfcsr_write_dccal(rt2x00dev, 3, rfvalue);\n\t\t\trt2800_rfcsr_write_dccal(rt2x00dev, 4, rfvalue);\n\n\t\t\trt2800_loft_search(rt2x00dev, ch_idx, rf_alc_idx, loft_dc_search_result);\n\t\t}\n\t}\n\n\tfor (rf_alc_idx = 0; rf_alc_idx < 3; rf_alc_idx++) {\n\t\tfor (idx = 0; idx < 4; idx++) {\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0xB0);\n\t\t\tbbp = (idx << 2) + rf_alc_idx;\n\t\t\trt2800_bbp_write(rt2x00dev, 159, bbp);\n\t\t\trt2x00_dbg(rt2x00dev, \" ALC %2x,\", bbp);\n\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0xb1);\n\t\t\tbbp = loft_dc_search_result[CHAIN_0][rf_alc_idx][0x00];\n\t\t\tbbp = bbp & 0x3F;\n\t\t\trt2800_bbp_write(rt2x00dev, 159, bbp);\n\t\t\trt2x00_dbg(rt2x00dev, \" I0 %2x,\", bbp);\n\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0xb2);\n\t\t\tbbp = loft_dc_search_result[CHAIN_0][rf_alc_idx][0x01];\n\t\t\tbbp = bbp & 0x3F;\n\t\t\trt2800_bbp_write(rt2x00dev, 159, bbp);\n\t\t\trt2x00_dbg(rt2x00dev, \" Q0 %2x,\", bbp);\n\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0xb8);\n\t\t\tbbp = loft_dc_search_result[CHAIN_1][rf_alc_idx][0x00];\n\t\t\tbbp = bbp & 0x3F;\n\t\t\trt2800_bbp_write(rt2x00dev, 159, bbp);\n\t\t\trt2x00_dbg(rt2x00dev, \" I1 %2x,\", bbp);\n\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0xb9);\n\t\t\tbbp = loft_dc_search_result[CHAIN_1][rf_alc_idx][0x01];\n\t\t\tbbp = bbp & 0x3F;\n\t\t\trt2800_bbp_write(rt2x00dev, 159, bbp);\n\t\t\trt2x00_dbg(rt2x00dev, \" Q1 %2x\\n\", bbp);\n\t\t}\n\t}\n\n\trt2800_bbp_write(rt2x00dev, 23, 0x00);\n\trt2800_bbp_write(rt2x00dev, 24, 0x00);\n\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x04);\n\n\trt2800_bbp_write(rt2x00dev, 158, 0x00);\n\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\n\tbbp = 0x00;\n\trt2800_bbp_write(rt2x00dev, 244, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 21, 0x01);\n\tudelay(1);\n\trt2800_bbp_write(rt2x00dev, 21, 0x00);\n\n\trt2800_rf_configrecover(rt2x00dev, rf_store);\n\n\trt2800_register_write(rt2x00dev, TX_PIN_CFG, macorg1);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x04);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, 0x00);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, macorg2);\n\tudelay(1);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, macorg3);\n\trt2800_register_write(rt2x00dev, RF_CONTROL3, macorg4);\n\trt2800_register_write(rt2x00dev, RF_BYPASS3, macorg5);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, savemacsysctrl);\n\trt2800_register_write(rt2x00dev, RF_CONTROL2, orig528);\n\trt2800_register_write(rt2x00dev, RF_BYPASS2, orig52c);\n\trt2800_register_write(rt2x00dev, 0x13b8, mac13b8);\n\n\tsavemacsysctrl = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\tmacorg1 = rt2800_register_read(rt2x00dev, TX_PIN_CFG);\n\tmacorg2 = rt2800_register_read(rt2x00dev, RF_CONTROL0);\n\tmacorg3 = rt2800_register_read(rt2x00dev, RF_BYPASS0);\n\tmacorg4 = rt2800_register_read(rt2x00dev, RF_CONTROL3);\n\tmacorg5 = rt2800_register_read(rt2x00dev, RF_BYPASS3);\n\n\tbbpr1 = rt2800_bbp_read(rt2x00dev, 1);\n\tbbpr4 = rt2800_bbp_read(rt2x00dev, 4);\n\tbbpr241 = rt2800_bbp_read(rt2x00dev, 241);\n\tbbpr242 = rt2800_bbp_read(rt2x00dev, 242);\n\tmac13b8 = rt2800_register_read(rt2x00dev, 0x13b8);\n\n\tmacvalue = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\tmacvalue &= (~0x04);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, macvalue);\n\n\tif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev, MAC_STATUS_CFG_BBP_RF_BUSY_TX)))\n\t\trt2x00_warn(rt2x00dev, \"RF TX busy in LOFT IQ calibration\\n\");\n\n\tmacvalue = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\tmacvalue &= (~0x08);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, macvalue);\n\n\tif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev, MAC_STATUS_CFG_BBP_RF_BUSY_RX)))\n\t\trt2x00_warn(rt2x00dev, \"RF RX busy in LOFT IQ calibration\\n\");\n\n\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags)) {\n\t\trt2800_register_write(rt2x00dev, RF_CONTROL3, 0x00000101);\n\t\trt2800_register_write(rt2x00dev, RF_BYPASS3, 0x0000F1F1);\n\t}\n\n\trt2800_bbp_write(rt2x00dev, 23, 0x00);\n\trt2800_bbp_write(rt2x00dev, 24, 0x00);\n\n\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags)) {\n\t\trt2800_bbp_write(rt2x00dev, 4, bbpr4 & (~0x18));\n\t\trt2800_bbp_write(rt2x00dev, 21, 0x01);\n\t\tudelay(1);\n\t\trt2800_bbp_write(rt2x00dev, 21, 0x00);\n\n\t\trt2800_bbp_write(rt2x00dev, 241, 0x14);\n\t\trt2800_bbp_write(rt2x00dev, 242, 0x80);\n\t\trt2800_bbp_write(rt2x00dev, 244, 0x31);\n\t} else {\n\t\trt2800_setbbptonegenerator(rt2x00dev);\n\t}\n\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00000004);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, 0x00003306);\n\tudelay(1);\n\n\trt2800_register_write(rt2x00dev, TX_PIN_CFG, 0x0000000F);\n\n\tif (!test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags)) {\n\t\trt2800_register_write(rt2x00dev, RF_CONTROL3, 0x00000000);\n\t\trt2800_register_write(rt2x00dev, RF_BYPASS3, 0x0000F1F1);\n\t}\n\n\trt2800_register_write(rt2x00dev, 0x13b8, 0x00000010);\n\n\tfor (ch_idx = 0; ch_idx < 2; ch_idx++)\n\t\trt2800_rf_configstore(rt2x00dev, rf_store, ch_idx);\n\n\trt2800_rfcsr_write_dccal(rt2x00dev, 3, 0x3B);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 4, 0x3B);\n\n\trt2800_bbp_write(rt2x00dev, 158, 0x03);\n\trt2800_bbp_write(rt2x00dev, 159, 0x60);\n\trt2800_bbp_write(rt2x00dev, 158, 0xB0);\n\trt2800_bbp_write(rt2x00dev, 159, 0x80);\n\n\tfor (ch_idx = 0; ch_idx < 2; ch_idx++) {\n\t\trt2800_bbp_write(rt2x00dev, 23, 0x00);\n\t\trt2800_bbp_write(rt2x00dev, 24, 0x00);\n\n\t\tif (ch_idx == 0) {\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x01);\n\t\t\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\t\t\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags)) {\n\t\t\t\tbbp = bbpr1 & (~0x18);\n\t\t\t\tbbp = bbp | 0x00;\n\t\t\t\trt2800_bbp_write(rt2x00dev, 1, bbp);\n\t\t\t}\n\t\t\trt2800_rf_aux_tx0_loopback(rt2x00dev);\n\t\t\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00001004);\n\t\t} else {\n\t\t\trt2800_bbp_write(rt2x00dev, 158, 0x01);\n\t\t\trt2800_bbp_write(rt2x00dev, 159, 0x01);\n\t\t\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX1, &rt2x00dev->cap_flags)) {\n\t\t\t\tbbp = bbpr1 & (~0x18);\n\t\t\t\tbbp = bbp | 0x08;\n\t\t\t\trt2800_bbp_write(rt2x00dev, 1, bbp);\n\t\t\t}\n\t\t\trt2800_rf_aux_tx1_loopback(rt2x00dev);\n\t\t\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00002004);\n\t\t}\n\n\t\trt2800_bbp_write(rt2x00dev, 158, 0x05);\n\t\trt2800_bbp_write(rt2x00dev, 159, 0x04);\n\n\t\tbbp = (ch_idx == 0) ? 0x28 : 0x46;\n\t\trt2800_bbp_write(rt2x00dev, 158, bbp);\n\t\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\n\t\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags)) {\n\t\t\trt2800_bbp_write(rt2x00dev, 23, 0x06);\n\t\t\trt2800_bbp_write(rt2x00dev, 24, 0x06);\n\t\t\tcount_step = 1;\n\t\t} else {\n\t\t\trt2800_bbp_write(rt2x00dev, 23, 0x1F);\n\t\t\trt2800_bbp_write(rt2x00dev, 24, 0x1F);\n\t\t\tcount_step = 2;\n\t\t}\n\n\t\tfor (; vga_gain[ch_idx] < 19; vga_gain[ch_idx] = (vga_gain[ch_idx] + count_step)) {\n\t\t\trfvalue = rfvga_gain_table[vga_gain[ch_idx]];\n\t\t\trt2800_rfcsr_write_dccal(rt2x00dev, 3, rfvalue);\n\t\t\trt2800_rfcsr_write_dccal(rt2x00dev, 4, rfvalue);\n\n\t\t\tbbp = (ch_idx == 0) ? 0x29 : 0x47;\n\t\t\trt2800_bbp_write(rt2x00dev, 158, bbp);\n\t\t\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\t\t\tp0 = rt2800_do_fft_accumulation(rt2x00dev, 0x14, 0);\n\t\t\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags))\n\t\t\t\tp0_idx10 = rt2800_read_fft_accumulation(rt2x00dev, 0x0A);\n\n\t\t\tbbp = (ch_idx == 0) ? 0x29 : 0x47;\n\t\t\trt2800_bbp_write(rt2x00dev, 158, bbp);\n\t\t\trt2800_bbp_write(rt2x00dev, 159, 0x21);\n\t\t\tp1 = rt2800_do_fft_accumulation(rt2x00dev, 0x14, 0);\n\t\t\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX1, &rt2x00dev->cap_flags))\n\t\t\t\tp1_idx10 = rt2800_read_fft_accumulation(rt2x00dev, 0x0A);\n\n\t\t\trt2x00_dbg(rt2x00dev, \"IQ AGC %d %d\\n\", p0, p1);\n\n\t\t\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags)) {\n\t\t\t\trt2x00_dbg(rt2x00dev, \"IQ AGC IDX 10 %d %d\\n\", p0_idx10, p1_idx10);\n\t\t\t\tif ((p0_idx10 > 7000 * 7000) || (p1_idx10 > 7000 * 7000)) {\n\t\t\t\t\tif (vga_gain[ch_idx] != 0)\n\t\t\t\t\t\tvga_gain[ch_idx] = vga_gain[ch_idx] - 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif ((p0 > 2500 * 2500) || (p1 > 2500 * 2500))\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (vga_gain[ch_idx] > 18)\n\t\t\tvga_gain[ch_idx] = 18;\n\t\trt2x00_dbg(rt2x00dev, \"Used VGA %d %x\\n\", vga_gain[ch_idx],\n\t\t\t   rfvga_gain_table[vga_gain[ch_idx]]);\n\n\t\tbbp = (ch_idx == 0) ? 0x29 : 0x47;\n\t\trt2800_bbp_write(rt2x00dev, 158, bbp);\n\t\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\n\t\trt2800_iq_search(rt2x00dev, ch_idx, ger, per);\n\t}\n\n\trt2800_bbp_write(rt2x00dev, 23, 0x00);\n\trt2800_bbp_write(rt2x00dev, 24, 0x00);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x04);\n\n\trt2800_bbp_write(rt2x00dev, 158, 0x28);\n\tbbp = ger[CHAIN_0] & 0x0F;\n\trt2800_bbp_write(rt2x00dev, 159, bbp);\n\n\trt2800_bbp_write(rt2x00dev, 158, 0x29);\n\tbbp = per[CHAIN_0] & 0x3F;\n\trt2800_bbp_write(rt2x00dev, 159, bbp);\n\n\trt2800_bbp_write(rt2x00dev, 158, 0x46);\n\tbbp = ger[CHAIN_1] & 0x0F;\n\trt2800_bbp_write(rt2x00dev, 159, bbp);\n\n\trt2800_bbp_write(rt2x00dev, 158, 0x47);\n\tbbp = per[CHAIN_1] & 0x3F;\n\trt2800_bbp_write(rt2x00dev, 159, bbp);\n\n\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags)) {\n\t\trt2800_bbp_write(rt2x00dev, 1, bbpr1);\n\t\trt2800_bbp_write(rt2x00dev, 241, bbpr241);\n\t\trt2800_bbp_write(rt2x00dev, 242, bbpr242);\n\t}\n\trt2800_bbp_write(rt2x00dev, 244, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 158, 0x00);\n\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\trt2800_bbp_write(rt2x00dev, 158, 0xB0);\n\trt2800_bbp_write(rt2x00dev, 159, 0x00);\n\n\trt2800_bbp_write(rt2x00dev, 30, bbpr30);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 39, rfb0r39);\n\trt2800_rfcsr_write_bank(rt2x00dev, 0, 42, rfb0r42);\n\n\tif (test_bit(CAPABILITY_EXTERNAL_PA_TX0, &rt2x00dev->cap_flags))\n\t\trt2800_bbp_write(rt2x00dev, 4, bbpr4);\n\n\trt2800_bbp_write(rt2x00dev, 21, 0x01);\n\tudelay(1);\n\trt2800_bbp_write(rt2x00dev, 21, 0x00);\n\n\trt2800_rf_configrecover(rt2x00dev, rf_store);\n\n\trt2800_register_write(rt2x00dev, TX_PIN_CFG, macorg1);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x00);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, 0x00);\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, macorg2);\n\tudelay(1);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, macorg3);\n\trt2800_register_write(rt2x00dev, RF_CONTROL3, macorg4);\n\trt2800_register_write(rt2x00dev, RF_BYPASS3, macorg5);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, savemacsysctrl);\n\trt2800_register_write(rt2x00dev, 0x13b8, mac13b8);\n}\n\nstatic void rt2800_bbp_core_soft_reset(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t       bool set_bw, bool is_ht40)\n{\n\tu8 bbp_val;\n\n\tbbp_val = rt2800_bbp_read(rt2x00dev, 21);\n\tbbp_val |= 0x1;\n\trt2800_bbp_write(rt2x00dev, 21, bbp_val);\n\tusleep_range(100, 200);\n\n\tif (set_bw) {\n\t\tbbp_val = rt2800_bbp_read(rt2x00dev, 4);\n\t\trt2x00_set_field8(&bbp_val, BBP4_BANDWIDTH, 2 * is_ht40);\n\t\trt2800_bbp_write(rt2x00dev, 4, bbp_val);\n\t\tusleep_range(100, 200);\n\t}\n\n\tbbp_val = rt2800_bbp_read(rt2x00dev, 21);\n\tbbp_val &= (~0x1);\n\trt2800_bbp_write(rt2x00dev, 21, bbp_val);\n\tusleep_range(100, 200);\n}\n\nstatic int rt2800_rf_lp_config(struct rt2x00_dev *rt2x00dev, bool btxcal)\n{\n\tu8 rf_val;\n\n\tif (btxcal)\n\t\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x04);\n\telse\n\t\trt2800_register_write(rt2x00dev, RF_CONTROL0, 0x02);\n\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, 0x06);\n\n\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 17);\n\trf_val |= 0x80;\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 17, rf_val);\n\n\tif (btxcal) {\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 18, 0xC1);\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 19, 0x20);\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 20, 0x02);\n\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 3);\n\t\trf_val &= (~0x3F);\n\t\trf_val |= 0x3F;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 3, rf_val);\n\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 4);\n\t\trf_val &= (~0x3F);\n\t\trf_val |= 0x3F;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 4, rf_val);\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 5, 0x31);\n\t} else {\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 18, 0xF1);\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 19, 0x18);\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 20, 0x02);\n\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 3);\n\t\trf_val &= (~0x3F);\n\t\trf_val |= 0x34;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 3, rf_val);\n\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 4);\n\t\trf_val &= (~0x3F);\n\t\trf_val |= 0x34;\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 4, rf_val);\n\t}\n\n\treturn 0;\n}\n\nstatic s8 rt2800_lp_tx_filter_bw_cal(struct rt2x00_dev *rt2x00dev)\n{\n\tunsigned int cnt;\n\tu8 bbp_val;\n\ts8 cal_val;\n\n\trt2800_bbp_dcoc_write(rt2x00dev, 0, 0x82);\n\n\tcnt = 0;\n\tdo {\n\t\tusleep_range(500, 2000);\n\t\tbbp_val = rt2800_bbp_read(rt2x00dev, 159);\n\t\tif (bbp_val == 0x02 || cnt == 20)\n\t\t\tbreak;\n\n\t\tcnt++;\n\t} while (cnt < 20);\n\n\tbbp_val = rt2800_bbp_dcoc_read(rt2x00dev, 0x39);\n\tcal_val = bbp_val & 0x7F;\n\tif (cal_val >= 0x40)\n\t\tcal_val -= 128;\n\n\treturn cal_val;\n}\n\nstatic void rt2800_bw_filter_calibration(struct rt2x00_dev *rt2x00dev,\n\t\t\t\t\t bool btxcal)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu8 tx_agc_fc = 0, rx_agc_fc = 0, cmm_agc_fc;\n\tu8 filter_target;\n\tu8 tx_filter_target_20m = 0x09, tx_filter_target_40m = 0x02;\n\tu8 rx_filter_target_20m = 0x27, rx_filter_target_40m = 0x31;\n\tint loop = 0, is_ht40, cnt;\n\tu8 bbp_val, rf_val;\n\ts8 cal_r32_init, cal_r32_val, cal_diff;\n\tu8 saverfb5r00, saverfb5r01, saverfb5r03, saverfb5r04, saverfb5r05;\n\tu8 saverfb5r06, saverfb5r07;\n\tu8 saverfb5r08, saverfb5r17, saverfb5r18, saverfb5r19, saverfb5r20;\n\tu8 saverfb5r37, saverfb5r38, saverfb5r39, saverfb5r40, saverfb5r41;\n\tu8 saverfb5r42, saverfb5r43, saverfb5r44, saverfb5r45, saverfb5r46;\n\tu8 saverfb5r58, saverfb5r59;\n\tu8 savebbp159r0, savebbp159r2, savebbpr23;\n\tu32 MAC_RF_CONTROL0, MAC_RF_BYPASS0;\n\n\t \n\tMAC_RF_CONTROL0 = rt2800_register_read(rt2x00dev, RF_CONTROL0);\n\tMAC_RF_BYPASS0 = rt2800_register_read(rt2x00dev, RF_BYPASS0);\n\n\t \n\tsavebbpr23 = rt2800_bbp_read(rt2x00dev, 23);\n\n\tsavebbp159r0 = rt2800_bbp_dcoc_read(rt2x00dev, 0);\n\tsavebbp159r2 = rt2800_bbp_dcoc_read(rt2x00dev, 2);\n\n\t \n\tsaverfb5r00 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 0);\n\tsaverfb5r01 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 1);\n\tsaverfb5r03 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 3);\n\tsaverfb5r04 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 4);\n\tsaverfb5r05 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 5);\n\tsaverfb5r06 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 6);\n\tsaverfb5r07 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 7);\n\tsaverfb5r08 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 8);\n\tsaverfb5r17 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 17);\n\tsaverfb5r18 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 18);\n\tsaverfb5r19 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 19);\n\tsaverfb5r20 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 20);\n\n\tsaverfb5r37 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 37);\n\tsaverfb5r38 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 38);\n\tsaverfb5r39 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 39);\n\tsaverfb5r40 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 40);\n\tsaverfb5r41 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 41);\n\tsaverfb5r42 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 42);\n\tsaverfb5r43 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 43);\n\tsaverfb5r44 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 44);\n\tsaverfb5r45 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 45);\n\tsaverfb5r46 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 46);\n\n\tsaverfb5r58 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 58);\n\tsaverfb5r59 = rt2800_rfcsr_read_bank(rt2x00dev, 5, 59);\n\n\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 0);\n\trf_val |= 0x3;\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 0, rf_val);\n\n\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 1);\n\trf_val |= 0x1;\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 1, rf_val);\n\n\tcnt = 0;\n\tdo {\n\t\tusleep_range(500, 2000);\n\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 1);\n\t\tif (((rf_val & 0x1) == 0x00) || (cnt == 40))\n\t\t\tbreak;\n\t\tcnt++;\n\t} while (cnt < 40);\n\n\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 0);\n\trf_val &= (~0x3);\n\trf_val |= 0x1;\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 0, rf_val);\n\n\t \n\tbbp_val = rt2800_bbp_read(rt2x00dev, 23);\n\tbbp_val &= (~0x1F);\n\tbbp_val |= 0x10;\n\trt2800_bbp_write(rt2x00dev, 23, bbp_val);\n\n\tdo {\n\t\t \n\t\tif (loop == 0) {\n\t\t\tis_ht40 = false;\n\n\t\t\tif (btxcal)\n\t\t\t\tfilter_target = tx_filter_target_20m;\n\t\t\telse\n\t\t\t\tfilter_target = rx_filter_target_20m;\n\t\t} else {\n\t\t\tis_ht40 = true;\n\n\t\t\tif (btxcal)\n\t\t\t\tfilter_target = tx_filter_target_40m;\n\t\t\telse\n\t\t\t\tfilter_target = rx_filter_target_40m;\n\t\t}\n\n\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 8);\n\t\trf_val &= (~0x04);\n\t\tif (loop == 1)\n\t\t\trf_val |= 0x4;\n\n\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 8, rf_val);\n\n\t\trt2800_bbp_core_soft_reset(rt2x00dev, true, is_ht40);\n\n\t\trt2800_rf_lp_config(rt2x00dev, btxcal);\n\t\tif (btxcal) {\n\t\t\ttx_agc_fc = 0;\n\t\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 58);\n\t\t\trf_val &= (~0x7F);\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 58, rf_val);\n\t\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 59);\n\t\t\trf_val &= (~0x7F);\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 59, rf_val);\n\t\t} else {\n\t\t\trx_agc_fc = 0;\n\t\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 6);\n\t\t\trf_val &= (~0x7F);\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 6, rf_val);\n\t\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 7);\n\t\t\trf_val &= (~0x7F);\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 7, rf_val);\n\t\t}\n\n\t\tusleep_range(1000, 2000);\n\n\t\tbbp_val = rt2800_bbp_dcoc_read(rt2x00dev, 2);\n\t\tbbp_val &= (~0x6);\n\t\trt2800_bbp_dcoc_write(rt2x00dev, 2, bbp_val);\n\n\t\trt2800_bbp_core_soft_reset(rt2x00dev, false, is_ht40);\n\n\t\tcal_r32_init = rt2800_lp_tx_filter_bw_cal(rt2x00dev);\n\n\t\tbbp_val = rt2800_bbp_dcoc_read(rt2x00dev, 2);\n\t\tbbp_val |= 0x6;\n\t\trt2800_bbp_dcoc_write(rt2x00dev, 2, bbp_val);\ndo_cal:\n\t\tif (btxcal) {\n\t\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 58);\n\t\t\trf_val &= (~0x7F);\n\t\t\trf_val |= tx_agc_fc;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 58, rf_val);\n\t\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 59);\n\t\t\trf_val &= (~0x7F);\n\t\t\trf_val |= tx_agc_fc;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 59, rf_val);\n\t\t} else {\n\t\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 6);\n\t\t\trf_val &= (~0x7F);\n\t\t\trf_val |= rx_agc_fc;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 6, rf_val);\n\t\t\trf_val = rt2800_rfcsr_read_bank(rt2x00dev, 5, 7);\n\t\t\trf_val &= (~0x7F);\n\t\t\trf_val |= rx_agc_fc;\n\t\t\trt2800_rfcsr_write_bank(rt2x00dev, 5, 7, rf_val);\n\t\t}\n\n\t\tusleep_range(500, 1000);\n\n\t\trt2800_bbp_core_soft_reset(rt2x00dev, false, is_ht40);\n\n\t\tcal_r32_val = rt2800_lp_tx_filter_bw_cal(rt2x00dev);\n\n\t\tcal_diff = cal_r32_init - cal_r32_val;\n\n\t\tif (btxcal)\n\t\t\tcmm_agc_fc = tx_agc_fc;\n\t\telse\n\t\t\tcmm_agc_fc = rx_agc_fc;\n\n\t\tif (((cal_diff > filter_target) && (cmm_agc_fc == 0)) ||\n\t\t    ((cal_diff < filter_target) && (cmm_agc_fc == 0x3f))) {\n\t\t\tif (btxcal)\n\t\t\t\ttx_agc_fc = 0;\n\t\t\telse\n\t\t\t\trx_agc_fc = 0;\n\t\t} else if ((cal_diff <= filter_target) && (cmm_agc_fc < 0x3f)) {\n\t\t\tif (btxcal)\n\t\t\t\ttx_agc_fc++;\n\t\t\telse\n\t\t\t\trx_agc_fc++;\n\t\t\tgoto do_cal;\n\t\t}\n\n\t\tif (btxcal) {\n\t\t\tif (loop == 0)\n\t\t\t\tdrv_data->tx_calibration_bw20 = tx_agc_fc;\n\t\t\telse\n\t\t\t\tdrv_data->tx_calibration_bw40 = tx_agc_fc;\n\t\t} else {\n\t\t\tif (loop == 0)\n\t\t\t\tdrv_data->rx_calibration_bw20 = rx_agc_fc;\n\t\t\telse\n\t\t\t\tdrv_data->rx_calibration_bw40 = rx_agc_fc;\n\t\t}\n\n\t\tloop++;\n\t} while (loop <= 1);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 0, saverfb5r00);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 1, saverfb5r01);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 3, saverfb5r03);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 4, saverfb5r04);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 5, saverfb5r05);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 6, saverfb5r06);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 7, saverfb5r07);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 8, saverfb5r08);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 17, saverfb5r17);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 18, saverfb5r18);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 19, saverfb5r19);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 20, saverfb5r20);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 37, saverfb5r37);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 38, saverfb5r38);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 39, saverfb5r39);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 40, saverfb5r40);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 41, saverfb5r41);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 42, saverfb5r42);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 43, saverfb5r43);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 44, saverfb5r44);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 45, saverfb5r45);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 46, saverfb5r46);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 58, saverfb5r58);\n\trt2800_rfcsr_write_bank(rt2x00dev, 5, 59, saverfb5r59);\n\n\trt2800_bbp_write(rt2x00dev, 23, savebbpr23);\n\n\trt2800_bbp_dcoc_write(rt2x00dev, 0, savebbp159r0);\n\trt2800_bbp_dcoc_write(rt2x00dev, 2, savebbp159r2);\n\n\tbbp_val = rt2800_bbp_read(rt2x00dev, 4);\n\trt2x00_set_field8(&bbp_val, BBP4_BANDWIDTH,\n\t\t\t  2 * test_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags));\n\trt2800_bbp_write(rt2x00dev, 4, bbp_val);\n\n\trt2800_register_write(rt2x00dev, RF_CONTROL0, MAC_RF_CONTROL0);\n\trt2800_register_write(rt2x00dev, RF_BYPASS0, MAC_RF_BYPASS0);\n}\n\nstatic void rt2800_init_rfcsr_6352(struct rt2x00_dev *rt2x00dev)\n{\n\t \n\trt2800_rfcsr_write(rt2x00dev, 0, 0x02);\n\trt2800_rfcsr_write(rt2x00dev, 1, 0x03);\n\trt2800_rfcsr_write(rt2x00dev, 2, 0x33);\n\trt2800_rfcsr_write(rt2x00dev, 3, 0xFF);\n\trt2800_rfcsr_write(rt2x00dev, 4, 0x0C);\n\trt2800_rfcsr_write(rt2x00dev, 5, 0x40);\n\trt2800_rfcsr_write(rt2x00dev, 6, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 7, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 8, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 9, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 10, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 12, rt2x00dev->freq_offset);\n\trt2800_rfcsr_write(rt2x00dev, 13, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x40);\n\trt2800_rfcsr_write(rt2x00dev, 15, 0x22);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0x4C);\n\trt2800_rfcsr_write(rt2x00dev, 17, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0xA0);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0x12);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x07);\n\trt2800_rfcsr_write(rt2x00dev, 23, 0x13);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0xFE);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x24);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x7A);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0x05);\n\trt2800_rfcsr_write(rt2x00dev, 30, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 31, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 32, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 33, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 34, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 35, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 36, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 37, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 38, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 39, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 40, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 41, 0xD0);\n\trt2800_rfcsr_write(rt2x00dev, 42, 0x5B);\n\trt2800_rfcsr_write(rt2x00dev, 43, 0x00);\n\n\trt2800_rfcsr_write(rt2x00dev, 11, 0x21);\n\tif (rt2800_clk_is_20mhz(rt2x00dev))\n\t\trt2800_rfcsr_write(rt2x00dev, 13, 0x03);\n\telse\n\t\trt2800_rfcsr_write(rt2x00dev, 13, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 14, 0x7C);\n\trt2800_rfcsr_write(rt2x00dev, 16, 0x80);\n\trt2800_rfcsr_write(rt2x00dev, 17, 0x99);\n\trt2800_rfcsr_write(rt2x00dev, 18, 0x99);\n\trt2800_rfcsr_write(rt2x00dev, 19, 0x09);\n\trt2800_rfcsr_write(rt2x00dev, 20, 0x50);\n\trt2800_rfcsr_write(rt2x00dev, 21, 0xB0);\n\trt2800_rfcsr_write(rt2x00dev, 22, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 23, 0x06);\n\trt2800_rfcsr_write(rt2x00dev, 24, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 25, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 26, 0x5D);\n\trt2800_rfcsr_write(rt2x00dev, 27, 0x00);\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x61);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0xB5);\n\trt2800_rfcsr_write(rt2x00dev, 43, 0x02);\n\n\trt2800_rfcsr_write(rt2x00dev, 28, 0x62);\n\trt2800_rfcsr_write(rt2x00dev, 29, 0xAD);\n\trt2800_rfcsr_write(rt2x00dev, 39, 0x80);\n\n\t \n\trt2800_rfcsr_write_chanreg(rt2x00dev, 0, 0x03);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 1, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 2, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 3, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 4, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 5, 0x08);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 6, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 7, 0x51);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 8, 0x53);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 9, 0x16);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 10, 0x61);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 11, 0x53);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 12, 0x22);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 13, 0x3D);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 14, 0x06);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 15, 0x13);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 16, 0x22);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 17, 0x27);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 18, 0x02);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 19, 0xA7);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 20, 0x01);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 21, 0x52);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 22, 0x80);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 23, 0xB3);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 24, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 25, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 26, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 27, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 28, 0x5C);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 29, 0x6B);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 30, 0x6B);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 31, 0x31);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 32, 0x5D);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 33, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 34, 0xE6);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 35, 0x55);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 36, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 37, 0xBB);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 38, 0xB3);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 39, 0xB3);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 40, 0x03);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 41, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 42, 0x00);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 43, 0xB3);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 44, 0xD3);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 45, 0xD5);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 46, 0x07);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 47, 0x68);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 48, 0xEF);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 49, 0x1C);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 54, 0x07);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 55, 0xA8);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 56, 0x85);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 57, 0x10);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 58, 0x07);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 59, 0x6A);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 60, 0x85);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 61, 0x10);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 62, 0x1C);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 63, 0x00);\n\n\trt2800_rfcsr_write_bank(rt2x00dev, 6, 45, 0xC5);\n\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 9, 0x47);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 10, 0x71);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 11, 0x33);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 14, 0x0E);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 17, 0x23);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 19, 0xA4);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 20, 0x02);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 21, 0x12);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 28, 0x1C);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 29, 0xEB);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 32, 0x7D);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 34, 0xD6);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 36, 0x08);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 38, 0xB4);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 43, 0xD3);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 44, 0xB3);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 45, 0xD5);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 46, 0x27);\n\trt2800_rfcsr_write_bank(rt2x00dev, 4, 47, 0x67);\n\trt2800_rfcsr_write_bank(rt2x00dev, 6, 47, 0x69);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 48, 0xFF);\n\trt2800_rfcsr_write_bank(rt2x00dev, 4, 54, 0x27);\n\trt2800_rfcsr_write_bank(rt2x00dev, 6, 54, 0x20);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 55, 0x66);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 56, 0xFF);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 57, 0x1C);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 58, 0x20);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 59, 0x6B);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 60, 0xF7);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 61, 0x09);\n\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 10, 0x51);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 14, 0x06);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 19, 0xA7);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 28, 0x2C);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 55, 0x64);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 8, 0x51);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 9, 0x36);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 11, 0x53);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 14, 0x16);\n\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 47, 0x6C);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 48, 0xFC);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 49, 0x1F);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 54, 0x27);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 55, 0x66);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 59, 0x6B);\n\n\t \n\trt2800_rfcsr_write_chanreg(rt2x00dev, 43, 0xD3);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 44, 0xE3);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 45, 0xE5);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 47, 0x28);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 55, 0x68);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 56, 0xF7);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 58, 0x02);\n\trt2800_rfcsr_write_chanreg(rt2x00dev, 60, 0xC7);\n\n\t \n\trt2800_rfcsr_write_dccal(rt2x00dev, 0, 0x47);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 1, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 2, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 3, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 4, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 5, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 6, 0x10);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 7, 0x10);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 8, 0x04);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 9, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 10, 0x07);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 11, 0x01);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 12, 0x07);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 13, 0x07);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 14, 0x07);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 15, 0x20);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 16, 0x22);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 17, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 18, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 19, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 20, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 21, 0xF1);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 22, 0x11);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 23, 0x02);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 24, 0x41);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 25, 0x20);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 26, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 27, 0xD7);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 28, 0xA2);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 29, 0x20);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 30, 0x49);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 31, 0x20);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 32, 0x04);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 33, 0xF1);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 34, 0xA1);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 35, 0x01);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 41, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 42, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 43, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 44, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 45, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 46, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 47, 0x3E);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 48, 0x3D);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 49, 0x3E);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 50, 0x3D);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 51, 0x3E);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 52, 0x3D);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 53, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 54, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 55, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 56, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 57, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 58, 0x10);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 59, 0x10);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 60, 0x0A);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 61, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 62, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 63, 0x00);\n\n\trt2800_rfcsr_write_dccal(rt2x00dev, 3, 0x08);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 4, 0x04);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 5, 0x20);\n\n\trt2800_rfcsr_write_dccal(rt2x00dev, 5, 0x00);\n\trt2800_rfcsr_write_dccal(rt2x00dev, 17, 0x7C);\n\n\trt2800_r_calibration(rt2x00dev);\n\trt2800_rf_self_txdc_cal(rt2x00dev);\n\trt2800_rxdcoc_calibration(rt2x00dev);\n\trt2800_bw_filter_calibration(rt2x00dev, true);\n\trt2800_bw_filter_calibration(rt2x00dev, false);\n\trt2800_loft_iq_calibration(rt2x00dev);\n\trt2800_rxiq_calibration(rt2x00dev);\n}\n\nstatic void rt2800_init_rfcsr(struct rt2x00_dev *rt2x00dev)\n{\n\tif (rt2800_is_305x_soc(rt2x00dev)) {\n\t\trt2800_init_rfcsr_305x_soc(rt2x00dev);\n\t\treturn;\n\t}\n\n\tswitch (rt2x00dev->chip.rt) {\n\tcase RT3070:\n\tcase RT3071:\n\tcase RT3090:\n\t\trt2800_init_rfcsr_30xx(rt2x00dev);\n\t\tbreak;\n\tcase RT3290:\n\t\trt2800_init_rfcsr_3290(rt2x00dev);\n\t\tbreak;\n\tcase RT3352:\n\t\trt2800_init_rfcsr_3352(rt2x00dev);\n\t\tbreak;\n\tcase RT3390:\n\t\trt2800_init_rfcsr_3390(rt2x00dev);\n\t\tbreak;\n\tcase RT3883:\n\t\trt2800_init_rfcsr_3883(rt2x00dev);\n\t\tbreak;\n\tcase RT3572:\n\t\trt2800_init_rfcsr_3572(rt2x00dev);\n\t\tbreak;\n\tcase RT3593:\n\t\trt2800_init_rfcsr_3593(rt2x00dev);\n\t\tbreak;\n\tcase RT5350:\n\t\trt2800_init_rfcsr_5350(rt2x00dev);\n\t\tbreak;\n\tcase RT5390:\n\t\trt2800_init_rfcsr_5390(rt2x00dev);\n\t\tbreak;\n\tcase RT5392:\n\t\trt2800_init_rfcsr_5392(rt2x00dev);\n\t\tbreak;\n\tcase RT5592:\n\t\trt2800_init_rfcsr_5592(rt2x00dev);\n\t\tbreak;\n\tcase RT6352:\n\t\trt2800_init_rfcsr_6352(rt2x00dev);\n\t\tbreak;\n\t}\n}\n\nint rt2800_enable_radio(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 reg;\n\tu16 word;\n\n\t \n\tif (unlikely(rt2800_wait_wpdma_ready(rt2x00dev) ||\n\t\t     rt2800_init_registers(rt2x00dev)))\n\t\treturn -EIO;\n\n\t \n\tif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev, MAC_STATUS_CFG_BBP_RF_BUSY)))\n\t\treturn -EIO;\n\n\t \n\trt2800_register_write(rt2x00dev, H2M_BBP_AGENT, 0);\n\trt2800_register_write(rt2x00dev, H2M_MAILBOX_CSR, 0);\n\tif (rt2x00_is_usb(rt2x00dev))\n\t\trt2800_register_write(rt2x00dev, H2M_INT_SRC, 0);\n\trt2800_mcu_request(rt2x00dev, MCU_BOOT_SIGNAL, 0, 0, 0);\n\tmsleep(1);\n\n\t \n\tif (unlikely(rt2800_wait_bbp_ready(rt2x00dev)))\n\t\treturn -EIO;\n\n\t \n\trt2800_init_bbp(rt2x00dev);\n\trt2800_init_rfcsr(rt2x00dev);\n\n\tif (rt2x00_is_usb(rt2x00dev) &&\n\t    (rt2x00_rt(rt2x00dev, RT3070) ||\n\t     rt2x00_rt(rt2x00dev, RT3071) ||\n\t     rt2x00_rt(rt2x00dev, RT3572))) {\n\t\tudelay(200);\n\t\trt2800_mcu_request(rt2x00dev, MCU_CURRENT, 0, 0, 0);\n\t\tudelay(10);\n\t}\n\n\t \n\treg = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\trt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_TX, 1);\n\trt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_RX, 0);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, reg);\n\n\tudelay(50);\n\n\treg = rt2800_register_read(rt2x00dev, WPDMA_GLO_CFG);\n\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_TX_DMA, 1);\n\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_RX_DMA, 1);\n\trt2x00_set_field32(&reg, WPDMA_GLO_CFG_TX_WRITEBACK_DONE, 1);\n\trt2800_register_write(rt2x00dev, WPDMA_GLO_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\trt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_TX, 1);\n\trt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_RX, 1);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, reg);\n\n\t \n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_LED_AG_CONF);\n\trt2800_mcu_request(rt2x00dev, MCU_LED_AG_CONF, 0xff,\n\t\t\t   word & 0xff, (word >> 8) & 0xff);\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_LED_ACT_CONF);\n\trt2800_mcu_request(rt2x00dev, MCU_LED_ACT_CONF, 0xff,\n\t\t\t   word & 0xff, (word >> 8) & 0xff);\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_LED_POLARITY);\n\trt2800_mcu_request(rt2x00dev, MCU_LED_LED_POLARITY, 0xff,\n\t\t\t   word & 0xff, (word >> 8) & 0xff);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rt2800_enable_radio);\n\nvoid rt2800_disable_radio(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 reg;\n\n\trt2800_disable_wpdma(rt2x00dev);\n\n\t \n\trt2800_wait_wpdma_ready(rt2x00dev);\n\n\treg = rt2800_register_read(rt2x00dev, MAC_SYS_CTRL);\n\trt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_TX, 0);\n\trt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_RX, 0);\n\trt2800_register_write(rt2x00dev, MAC_SYS_CTRL, reg);\n}\nEXPORT_SYMBOL_GPL(rt2800_disable_radio);\n\nint rt2800_efuse_detect(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 reg;\n\tu16 efuse_ctrl_reg;\n\n\tif (rt2x00_rt(rt2x00dev, RT3290))\n\t\tefuse_ctrl_reg = EFUSE_CTRL_3290;\n\telse\n\t\tefuse_ctrl_reg = EFUSE_CTRL;\n\n\treg = rt2800_register_read(rt2x00dev, efuse_ctrl_reg);\n\treturn rt2x00_get_field32(reg, EFUSE_CTRL_PRESENT);\n}\nEXPORT_SYMBOL_GPL(rt2800_efuse_detect);\n\nstatic void rt2800_efuse_read(struct rt2x00_dev *rt2x00dev, unsigned int i)\n{\n\tu32 reg;\n\tu16 efuse_ctrl_reg;\n\tu16 efuse_data0_reg;\n\tu16 efuse_data1_reg;\n\tu16 efuse_data2_reg;\n\tu16 efuse_data3_reg;\n\n\tif (rt2x00_rt(rt2x00dev, RT3290)) {\n\t\tefuse_ctrl_reg = EFUSE_CTRL_3290;\n\t\tefuse_data0_reg = EFUSE_DATA0_3290;\n\t\tefuse_data1_reg = EFUSE_DATA1_3290;\n\t\tefuse_data2_reg = EFUSE_DATA2_3290;\n\t\tefuse_data3_reg = EFUSE_DATA3_3290;\n\t} else {\n\t\tefuse_ctrl_reg = EFUSE_CTRL;\n\t\tefuse_data0_reg = EFUSE_DATA0;\n\t\tefuse_data1_reg = EFUSE_DATA1;\n\t\tefuse_data2_reg = EFUSE_DATA2;\n\t\tefuse_data3_reg = EFUSE_DATA3;\n\t}\n\tmutex_lock(&rt2x00dev->csr_mutex);\n\n\treg = rt2800_register_read_lock(rt2x00dev, efuse_ctrl_reg);\n\trt2x00_set_field32(&reg, EFUSE_CTRL_ADDRESS_IN, i);\n\trt2x00_set_field32(&reg, EFUSE_CTRL_MODE, 0);\n\trt2x00_set_field32(&reg, EFUSE_CTRL_KICK, 1);\n\trt2800_register_write_lock(rt2x00dev, efuse_ctrl_reg, reg);\n\n\t \n\trt2800_regbusy_read(rt2x00dev, efuse_ctrl_reg, EFUSE_CTRL_KICK, &reg);\n\t \n\treg = rt2800_register_read_lock(rt2x00dev, efuse_data3_reg);\n\t \n\t*(u32 *)&rt2x00dev->eeprom[i] = cpu_to_le32(reg);\n\treg = rt2800_register_read_lock(rt2x00dev, efuse_data2_reg);\n\t*(u32 *)&rt2x00dev->eeprom[i + 2] = cpu_to_le32(reg);\n\treg = rt2800_register_read_lock(rt2x00dev, efuse_data1_reg);\n\t*(u32 *)&rt2x00dev->eeprom[i + 4] = cpu_to_le32(reg);\n\treg = rt2800_register_read_lock(rt2x00dev, efuse_data0_reg);\n\t*(u32 *)&rt2x00dev->eeprom[i + 6] = cpu_to_le32(reg);\n\n\tmutex_unlock(&rt2x00dev->csr_mutex);\n}\n\nint rt2800_read_eeprom_efuse(struct rt2x00_dev *rt2x00dev)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < EEPROM_SIZE / sizeof(u16); i += 8)\n\t\trt2800_efuse_read(rt2x00dev, i);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rt2800_read_eeprom_efuse);\n\nstatic u8 rt2800_get_txmixer_gain_24g(struct rt2x00_dev *rt2x00dev)\n{\n\tu16 word;\n\n\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t    rt2x00_rt(rt2x00dev, RT3883))\n\t\treturn 0;\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_TXMIXER_GAIN_BG);\n\tif ((word & 0x00ff) != 0x00ff)\n\t\treturn rt2x00_get_field16(word, EEPROM_TXMIXER_GAIN_BG_VAL);\n\n\treturn 0;\n}\n\nstatic u8 rt2800_get_txmixer_gain_5g(struct rt2x00_dev *rt2x00dev)\n{\n\tu16 word;\n\n\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t    rt2x00_rt(rt2x00dev, RT3883))\n\t\treturn 0;\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_TXMIXER_GAIN_A);\n\tif ((word & 0x00ff) != 0x00ff)\n\t\treturn rt2x00_get_field16(word, EEPROM_TXMIXER_GAIN_A_VAL);\n\n\treturn 0;\n}\n\nstatic int rt2800_validate_eeprom(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\n\tu16 word;\n\tu8 *mac;\n\tu8 default_lna_gain;\n\tint retval;\n\n\t \n\tretval = rt2800_read_eeprom(rt2x00dev);\n\tif (retval)\n\t\treturn retval;\n\n\t \n\tmac = rt2800_eeprom_addr(rt2x00dev, EEPROM_MAC_ADDR_0);\n\trt2x00lib_set_mac_address(rt2x00dev, mac);\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF0);\n\tif (word == 0xffff) {\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF0_RXPATH, 2);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF0_TXPATH, 1);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF0_RF_TYPE, RF2820);\n\t\trt2800_eeprom_write(rt2x00dev, EEPROM_NIC_CONF0, word);\n\t\trt2x00_eeprom_dbg(rt2x00dev, \"Antenna: 0x%04x\\n\", word);\n\t} else if (rt2x00_rt(rt2x00dev, RT2860) ||\n\t\t   rt2x00_rt(rt2x00dev, RT2872)) {\n\t\t \n\t\tif (rt2x00_get_field16(word, EEPROM_NIC_CONF0_RXPATH) > 2)\n\t\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF0_RXPATH, 2);\n\t\trt2800_eeprom_write(rt2x00dev, EEPROM_NIC_CONF0, word);\n\t}\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1);\n\tif (word == 0xffff) {\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_HW_RADIO, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_EXTERNAL_TX_ALC, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_EXTERNAL_LNA_2G, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_EXTERNAL_LNA_5G, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_CARDBUS_ACCEL, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_BW40M_SB_2G, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_BW40M_SB_5G, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_WPS_PBC, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_BW40M_2G, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_BW40M_5G, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_BROADBAND_EXT_LNA, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_ANT_DIVERSITY, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_INTERNAL_TX_ALC, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_BT_COEXIST, 0);\n\t\trt2x00_set_field16(&word, EEPROM_NIC_CONF1_DAC_TEST, 0);\n\t\trt2800_eeprom_write(rt2x00dev, EEPROM_NIC_CONF1, word);\n\t\trt2x00_eeprom_dbg(rt2x00dev, \"NIC: 0x%04x\\n\", word);\n\t}\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_FREQ);\n\tif ((word & 0x00ff) == 0x00ff) {\n\t\trt2x00_set_field16(&word, EEPROM_FREQ_OFFSET, 0);\n\t\trt2800_eeprom_write(rt2x00dev, EEPROM_FREQ, word);\n\t\trt2x00_eeprom_dbg(rt2x00dev, \"Freq: 0x%04x\\n\", word);\n\t}\n\tif ((word & 0xff00) == 0xff00) {\n\t\trt2x00_set_field16(&word, EEPROM_FREQ_LED_MODE,\n\t\t\t\t   LED_MODE_TXRX_ACTIVITY);\n\t\trt2x00_set_field16(&word, EEPROM_FREQ_LED_POLARITY, 0);\n\t\trt2800_eeprom_write(rt2x00dev, EEPROM_FREQ, word);\n\t\trt2800_eeprom_write(rt2x00dev, EEPROM_LED_AG_CONF, 0x5555);\n\t\trt2800_eeprom_write(rt2x00dev, EEPROM_LED_ACT_CONF, 0x2221);\n\t\trt2800_eeprom_write(rt2x00dev, EEPROM_LED_POLARITY, 0xa9f8);\n\t\trt2x00_eeprom_dbg(rt2x00dev, \"Led Mode: 0x%04x\\n\", word);\n\t}\n\n\t \n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_LNA);\n\tdefault_lna_gain = rt2x00_get_field16(word, EEPROM_LNA_A0);\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_BG);\n\tif (abs(rt2x00_get_field16(word, EEPROM_RSSI_BG_OFFSET0)) > 10)\n\t\trt2x00_set_field16(&word, EEPROM_RSSI_BG_OFFSET0, 0);\n\tif (abs(rt2x00_get_field16(word, EEPROM_RSSI_BG_OFFSET1)) > 10)\n\t\trt2x00_set_field16(&word, EEPROM_RSSI_BG_OFFSET1, 0);\n\trt2800_eeprom_write(rt2x00dev, EEPROM_RSSI_BG, word);\n\n\tdrv_data->txmixer_gain_24g = rt2800_get_txmixer_gain_24g(rt2x00dev);\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_BG2);\n\tif (abs(rt2x00_get_field16(word, EEPROM_RSSI_BG2_OFFSET2)) > 10)\n\t\trt2x00_set_field16(&word, EEPROM_RSSI_BG2_OFFSET2, 0);\n\tif (!rt2x00_rt(rt2x00dev, RT3593) &&\n\t    !rt2x00_rt(rt2x00dev, RT3883)) {\n\t\tif (rt2x00_get_field16(word, EEPROM_RSSI_BG2_LNA_A1) == 0x00 ||\n\t\t    rt2x00_get_field16(word, EEPROM_RSSI_BG2_LNA_A1) == 0xff)\n\t\t\trt2x00_set_field16(&word, EEPROM_RSSI_BG2_LNA_A1,\n\t\t\t\t\t   default_lna_gain);\n\t}\n\trt2800_eeprom_write(rt2x00dev, EEPROM_RSSI_BG2, word);\n\n\tdrv_data->txmixer_gain_5g = rt2800_get_txmixer_gain_5g(rt2x00dev);\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_A);\n\tif (abs(rt2x00_get_field16(word, EEPROM_RSSI_A_OFFSET0)) > 10)\n\t\trt2x00_set_field16(&word, EEPROM_RSSI_A_OFFSET0, 0);\n\tif (abs(rt2x00_get_field16(word, EEPROM_RSSI_A_OFFSET1)) > 10)\n\t\trt2x00_set_field16(&word, EEPROM_RSSI_A_OFFSET1, 0);\n\trt2800_eeprom_write(rt2x00dev, EEPROM_RSSI_A, word);\n\n\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_A2);\n\tif (abs(rt2x00_get_field16(word, EEPROM_RSSI_A2_OFFSET2)) > 10)\n\t\trt2x00_set_field16(&word, EEPROM_RSSI_A2_OFFSET2, 0);\n\tif (!rt2x00_rt(rt2x00dev, RT3593) &&\n\t    !rt2x00_rt(rt2x00dev, RT3883)) {\n\t\tif (rt2x00_get_field16(word, EEPROM_RSSI_A2_LNA_A2) == 0x00 ||\n\t\t    rt2x00_get_field16(word, EEPROM_RSSI_A2_LNA_A2) == 0xff)\n\t\t\trt2x00_set_field16(&word, EEPROM_RSSI_A2_LNA_A2,\n\t\t\t\t\t   default_lna_gain);\n\t}\n\trt2800_eeprom_write(rt2x00dev, EEPROM_RSSI_A2, word);\n\n\tif (rt2x00_rt(rt2x00dev, RT3593) ||\n\t    rt2x00_rt(rt2x00dev, RT3883)) {\n\t\tword = rt2800_eeprom_read(rt2x00dev, EEPROM_EXT_LNA2);\n\t\tif (rt2x00_get_field16(word, EEPROM_EXT_LNA2_A1) == 0x00 ||\n\t\t    rt2x00_get_field16(word, EEPROM_EXT_LNA2_A1) == 0xff)\n\t\t\trt2x00_set_field16(&word, EEPROM_EXT_LNA2_A1,\n\t\t\t\t\t   default_lna_gain);\n\t\tif (rt2x00_get_field16(word, EEPROM_EXT_LNA2_A2) == 0x00 ||\n\t\t    rt2x00_get_field16(word, EEPROM_EXT_LNA2_A2) == 0xff)\n\t\t\trt2x00_set_field16(&word, EEPROM_EXT_LNA2_A1,\n\t\t\t\t\t   default_lna_gain);\n\t\trt2800_eeprom_write(rt2x00dev, EEPROM_EXT_LNA2, word);\n\t}\n\n\treturn 0;\n}\n\nstatic int rt2800_init_eeprom(struct rt2x00_dev *rt2x00dev)\n{\n\tu16 value;\n\tu16 eeprom;\n\tu16 rf;\n\n\t \n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF0);\n\n\t \n\tif (rt2x00_rt(rt2x00dev, RT3290) ||\n\t    rt2x00_rt(rt2x00dev, RT5390) ||\n\t    rt2x00_rt(rt2x00dev, RT5392) ||\n\t    rt2x00_rt(rt2x00dev, RT6352))\n\t\trf = rt2800_eeprom_read(rt2x00dev, EEPROM_CHIP_ID);\n\telse if (rt2x00_rt(rt2x00dev, RT3352))\n\t\trf = RF3322;\n\telse if (rt2x00_rt(rt2x00dev, RT3883))\n\t\trf = RF3853;\n\telse if (rt2x00_rt(rt2x00dev, RT5350))\n\t\trf = RF5350;\n\telse if (rt2x00_rt(rt2x00dev, RT5592))\n\t\trf = RF5592;\n\telse\n\t\trf = rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_RF_TYPE);\n\n\tswitch (rf) {\n\tcase RF2820:\n\tcase RF2850:\n\tcase RF2720:\n\tcase RF2750:\n\tcase RF3020:\n\tcase RF2020:\n\tcase RF3021:\n\tcase RF3022:\n\tcase RF3052:\n\tcase RF3053:\n\tcase RF3070:\n\tcase RF3290:\n\tcase RF3320:\n\tcase RF3322:\n\tcase RF3853:\n\tcase RF5350:\n\tcase RF5360:\n\tcase RF5362:\n\tcase RF5370:\n\tcase RF5372:\n\tcase RF5390:\n\tcase RF5392:\n\tcase RF5592:\n\tcase RF7620:\n\t\tbreak;\n\tdefault:\n\t\trt2x00_err(rt2x00dev, \"Invalid RF chipset 0x%04x detected\\n\",\n\t\t\t   rf);\n\t\treturn -ENODEV;\n\t}\n\n\trt2x00_set_rf(rt2x00dev, rf);\n\n\t \n\trt2x00dev->default_ant.tx_chain_num =\n\t    rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_TXPATH);\n\trt2x00dev->default_ant.rx_chain_num =\n\t    rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_RXPATH);\n\n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1);\n\n\tif (rt2x00_rt(rt2x00dev, RT3070) ||\n\t    rt2x00_rt(rt2x00dev, RT3090) ||\n\t    rt2x00_rt(rt2x00dev, RT3352) ||\n\t    rt2x00_rt(rt2x00dev, RT3390)) {\n\t\tvalue = rt2x00_get_field16(eeprom,\n\t\t\t\tEEPROM_NIC_CONF1_ANT_DIVERSITY);\n\t\tswitch (value) {\n\t\tcase 0:\n\t\tcase 1:\n\t\tcase 2:\n\t\t\trt2x00dev->default_ant.tx = ANTENNA_A;\n\t\t\trt2x00dev->default_ant.rx = ANTENNA_A;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\trt2x00dev->default_ant.tx = ANTENNA_A;\n\t\t\trt2x00dev->default_ant.rx = ANTENNA_B;\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\trt2x00dev->default_ant.tx = ANTENNA_A;\n\t\trt2x00dev->default_ant.rx = ANTENNA_A;\n\t}\n\n\t \n\tif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390R) ||\n\t    rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5370G)) {\n\t\trt2x00dev->default_ant.tx = ANTENNA_HW_DIVERSITY;  \n\t\trt2x00dev->default_ant.rx = ANTENNA_HW_DIVERSITY;  \n\t}\n\n\t \n\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_EXTERNAL_LNA_5G))\n\t\t__set_bit(CAPABILITY_EXTERNAL_LNA_A, &rt2x00dev->cap_flags);\n\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_EXTERNAL_LNA_2G))\n\t\t__set_bit(CAPABILITY_EXTERNAL_LNA_BG, &rt2x00dev->cap_flags);\n\n\t \n\tif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_HW_RADIO))\n\t\t__set_bit(CAPABILITY_HW_BUTTON, &rt2x00dev->cap_flags);\n\n\t \n\tif (!rt2x00_rt(rt2x00dev, RT3352) &&\n\t    rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_BT_COEXIST))\n\t\t__set_bit(CAPABILITY_BT_COEXIST, &rt2x00dev->cap_flags);\n\n\t \n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_FREQ);\n\trt2x00dev->freq_offset = rt2x00_get_field16(eeprom, EEPROM_FREQ_OFFSET);\n\n\t \n#ifdef CONFIG_RT2X00_LIB_LEDS\n\trt2800_init_led(rt2x00dev, &rt2x00dev->led_radio, LED_TYPE_RADIO);\n\trt2800_init_led(rt2x00dev, &rt2x00dev->led_assoc, LED_TYPE_ASSOC);\n\trt2800_init_led(rt2x00dev, &rt2x00dev->led_qual, LED_TYPE_QUALITY);\n\n\trt2x00dev->led_mcu_reg = eeprom;\n#endif  \n\n\t \n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_EIRP_MAX_TX_POWER);\n\n\tif (rt2x00_get_field16(eeprom, EEPROM_EIRP_MAX_TX_POWER_2GHZ) <\n\t\t\t\t\tEIRP_MAX_TX_POWER_LIMIT)\n\t\t__set_bit(CAPABILITY_POWER_LIMIT, &rt2x00dev->cap_flags);\n\n\t \n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1);\n\n\tif (rt2x00_rt(rt2x00dev, RT3352) ||\n\t    rt2x00_rt(rt2x00dev, RT6352)) {\n\t\tif (rt2x00_get_field16(eeprom,\n\t\t    EEPROM_NIC_CONF1_EXTERNAL_TX0_PA_3352))\n\t\t    __set_bit(CAPABILITY_EXTERNAL_PA_TX0,\n\t\t\t      &rt2x00dev->cap_flags);\n\t\tif (rt2x00_get_field16(eeprom,\n\t\t    EEPROM_NIC_CONF1_EXTERNAL_TX1_PA_3352))\n\t\t    __set_bit(CAPABILITY_EXTERNAL_PA_TX1,\n\t\t\t      &rt2x00dev->cap_flags);\n\t}\n\n\teeprom = rt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF2);\n\n\tif (rt2x00_rt(rt2x00dev, RT6352) && eeprom != 0 && eeprom != 0xffff) {\n\t\tif (!rt2x00_get_field16(eeprom,\n\t\t\t\t\tEEPROM_NIC_CONF2_EXTERNAL_PA)) {\n\t\t\t__clear_bit(CAPABILITY_EXTERNAL_PA_TX0,\n\t\t\t\t    &rt2x00dev->cap_flags);\n\t\t\t__clear_bit(CAPABILITY_EXTERNAL_PA_TX1,\n\t\t\t\t    &rt2x00dev->cap_flags);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n \nstatic const struct rf_channel rf_vals[] = {\n\t{ 1,  0x18402ecc, 0x184c0786, 0x1816b455, 0x1800510b },\n\t{ 2,  0x18402ecc, 0x184c0786, 0x18168a55, 0x1800519f },\n\t{ 3,  0x18402ecc, 0x184c078a, 0x18168a55, 0x1800518b },\n\t{ 4,  0x18402ecc, 0x184c078a, 0x18168a55, 0x1800519f },\n\t{ 5,  0x18402ecc, 0x184c078e, 0x18168a55, 0x1800518b },\n\t{ 6,  0x18402ecc, 0x184c078e, 0x18168a55, 0x1800519f },\n\t{ 7,  0x18402ecc, 0x184c0792, 0x18168a55, 0x1800518b },\n\t{ 8,  0x18402ecc, 0x184c0792, 0x18168a55, 0x1800519f },\n\t{ 9,  0x18402ecc, 0x184c0796, 0x18168a55, 0x1800518b },\n\t{ 10, 0x18402ecc, 0x184c0796, 0x18168a55, 0x1800519f },\n\t{ 11, 0x18402ecc, 0x184c079a, 0x18168a55, 0x1800518b },\n\t{ 12, 0x18402ecc, 0x184c079a, 0x18168a55, 0x1800519f },\n\t{ 13, 0x18402ecc, 0x184c079e, 0x18168a55, 0x1800518b },\n\t{ 14, 0x18402ecc, 0x184c07a2, 0x18168a55, 0x18005193 },\n\n\t \n\t{ 36, 0x18402ecc, 0x184c099a, 0x18158a55, 0x180ed1a3 },\n\t{ 38, 0x18402ecc, 0x184c099e, 0x18158a55, 0x180ed193 },\n\t{ 40, 0x18402ec8, 0x184c0682, 0x18158a55, 0x180ed183 },\n\t{ 44, 0x18402ec8, 0x184c0682, 0x18158a55, 0x180ed1a3 },\n\t{ 46, 0x18402ec8, 0x184c0686, 0x18158a55, 0x180ed18b },\n\t{ 48, 0x18402ec8, 0x184c0686, 0x18158a55, 0x180ed19b },\n\t{ 52, 0x18402ec8, 0x184c068a, 0x18158a55, 0x180ed193 },\n\t{ 54, 0x18402ec8, 0x184c068a, 0x18158a55, 0x180ed1a3 },\n\t{ 56, 0x18402ec8, 0x184c068e, 0x18158a55, 0x180ed18b },\n\t{ 60, 0x18402ec8, 0x184c0692, 0x18158a55, 0x180ed183 },\n\t{ 62, 0x18402ec8, 0x184c0692, 0x18158a55, 0x180ed193 },\n\t{ 64, 0x18402ec8, 0x184c0692, 0x18158a55, 0x180ed1a3 },\n\n\t \n\t{ 100, 0x18402ec8, 0x184c06b2, 0x18178a55, 0x180ed783 },\n\t{ 102, 0x18402ec8, 0x184c06b2, 0x18578a55, 0x180ed793 },\n\t{ 104, 0x18402ec8, 0x185c06b2, 0x18578a55, 0x180ed1a3 },\n\t{ 108, 0x18402ecc, 0x185c0a32, 0x18578a55, 0x180ed193 },\n\t{ 110, 0x18402ecc, 0x184c0a36, 0x18178a55, 0x180ed183 },\n\t{ 112, 0x18402ecc, 0x184c0a36, 0x18178a55, 0x180ed19b },\n\t{ 116, 0x18402ecc, 0x184c0a3a, 0x18178a55, 0x180ed1a3 },\n\t{ 118, 0x18402ecc, 0x184c0a3e, 0x18178a55, 0x180ed193 },\n\t{ 120, 0x18402ec4, 0x184c0382, 0x18178a55, 0x180ed183 },\n\t{ 124, 0x18402ec4, 0x184c0382, 0x18178a55, 0x180ed193 },\n\t{ 126, 0x18402ec4, 0x184c0382, 0x18178a55, 0x180ed15b },\n\t{ 128, 0x18402ec4, 0x184c0382, 0x18178a55, 0x180ed1a3 },\n\t{ 132, 0x18402ec4, 0x184c0386, 0x18178a55, 0x180ed18b },\n\t{ 134, 0x18402ec4, 0x184c0386, 0x18178a55, 0x180ed193 },\n\t{ 136, 0x18402ec4, 0x184c0386, 0x18178a55, 0x180ed19b },\n\t{ 140, 0x18402ec4, 0x184c038a, 0x18178a55, 0x180ed183 },\n\n\t \n\t{ 149, 0x18402ec4, 0x184c038a, 0x18178a55, 0x180ed1a7 },\n\t{ 151, 0x18402ec4, 0x184c038e, 0x18178a55, 0x180ed187 },\n\t{ 153, 0x18402ec4, 0x184c038e, 0x18178a55, 0x180ed18f },\n\t{ 157, 0x18402ec4, 0x184c038e, 0x18178a55, 0x180ed19f },\n\t{ 159, 0x18402ec4, 0x184c038e, 0x18178a55, 0x180ed1a7 },\n\t{ 161, 0x18402ec4, 0x184c0392, 0x18178a55, 0x180ed187 },\n\t{ 165, 0x18402ec4, 0x184c0392, 0x18178a55, 0x180ed197 },\n\t{ 167, 0x18402ec4, 0x184c03d2, 0x18179855, 0x1815531f },\n\t{ 169, 0x18402ec4, 0x184c03d2, 0x18179855, 0x18155327 },\n\t{ 171, 0x18402ec4, 0x184c03d6, 0x18179855, 0x18155307 },\n\t{ 173, 0x18402ec4, 0x184c03d6, 0x18179855, 0x1815530f },\n\n\t \n\t{ 184, 0x15002ccc, 0x1500491e, 0x1509be55, 0x150c0a0b },\n\t{ 188, 0x15002ccc, 0x15004922, 0x1509be55, 0x150c0a13 },\n\t{ 192, 0x15002ccc, 0x15004926, 0x1509be55, 0x150c0a1b },\n\t{ 196, 0x15002ccc, 0x1500492a, 0x1509be55, 0x150c0a23 },\n\t{ 208, 0x15002ccc, 0x1500493a, 0x1509be55, 0x150c0a13 },\n\t{ 212, 0x15002ccc, 0x1500493e, 0x1509be55, 0x150c0a1b },\n\t{ 216, 0x15002ccc, 0x15004982, 0x1509be55, 0x150c0a23 },\n};\n\n \nstatic const struct rf_channel rf_vals_3x[] = {\n\t{1,  241, 2, 2 },\n\t{2,  241, 2, 7 },\n\t{3,  242, 2, 2 },\n\t{4,  242, 2, 7 },\n\t{5,  243, 2, 2 },\n\t{6,  243, 2, 7 },\n\t{7,  244, 2, 2 },\n\t{8,  244, 2, 7 },\n\t{9,  245, 2, 2 },\n\t{10, 245, 2, 7 },\n\t{11, 246, 2, 2 },\n\t{12, 246, 2, 7 },\n\t{13, 247, 2, 2 },\n\t{14, 248, 2, 4 },\n\n\t \n\t{36, 0x56, 0, 4},\n\t{38, 0x56, 0, 6},\n\t{40, 0x56, 0, 8},\n\t{44, 0x57, 0, 0},\n\t{46, 0x57, 0, 2},\n\t{48, 0x57, 0, 4},\n\t{52, 0x57, 0, 8},\n\t{54, 0x57, 0, 10},\n\t{56, 0x58, 0, 0},\n\t{60, 0x58, 0, 4},\n\t{62, 0x58, 0, 6},\n\t{64, 0x58, 0, 8},\n\n\t \n\t{100, 0x5b, 0, 8},\n\t{102, 0x5b, 0, 10},\n\t{104, 0x5c, 0, 0},\n\t{108, 0x5c, 0, 4},\n\t{110, 0x5c, 0, 6},\n\t{112, 0x5c, 0, 8},\n\t{116, 0x5d, 0, 0},\n\t{118, 0x5d, 0, 2},\n\t{120, 0x5d, 0, 4},\n\t{124, 0x5d, 0, 8},\n\t{126, 0x5d, 0, 10},\n\t{128, 0x5e, 0, 0},\n\t{132, 0x5e, 0, 4},\n\t{134, 0x5e, 0, 6},\n\t{136, 0x5e, 0, 8},\n\t{140, 0x5f, 0, 0},\n\n\t \n\t{149, 0x5f, 0, 9},\n\t{151, 0x5f, 0, 11},\n\t{153, 0x60, 0, 1},\n\t{157, 0x60, 0, 5},\n\t{159, 0x60, 0, 7},\n\t{161, 0x60, 0, 9},\n\t{165, 0x61, 0, 1},\n\t{167, 0x61, 0, 3},\n\t{169, 0x61, 0, 5},\n\t{171, 0x61, 0, 7},\n\t{173, 0x61, 0, 9},\n};\n\n \nstatic const struct rf_channel rf_vals_3x_xtal20[] = {\n\t{1,    0xE2,\t 2,  0x14},\n\t{2,    0xE3,\t 2,  0x14},\n\t{3,    0xE4,\t 2,  0x14},\n\t{4,    0xE5,\t 2,  0x14},\n\t{5,    0xE6,\t 2,  0x14},\n\t{6,    0xE7,\t 2,  0x14},\n\t{7,    0xE8,\t 2,  0x14},\n\t{8,    0xE9,\t 2,  0x14},\n\t{9,    0xEA,\t 2,  0x14},\n\t{10,   0xEB,\t 2,  0x14},\n\t{11,   0xEC,\t 2,  0x14},\n\t{12,   0xED,\t 2,  0x14},\n\t{13,   0xEE,\t 2,  0x14},\n\t{14,   0xF0,\t 2,  0x18},\n};\n\nstatic const struct rf_channel rf_vals_3853[] = {\n\t{1,  241, 6, 2},\n\t{2,  241, 6, 7},\n\t{3,  242, 6, 2},\n\t{4,  242, 6, 7},\n\t{5,  243, 6, 2},\n\t{6,  243, 6, 7},\n\t{7,  244, 6, 2},\n\t{8,  244, 6, 7},\n\t{9,  245, 6, 2},\n\t{10, 245, 6, 7},\n\t{11, 246, 6, 2},\n\t{12, 246, 6, 7},\n\t{13, 247, 6, 2},\n\t{14, 248, 6, 4},\n\n\t{36, 0x56, 8, 4},\n\t{38, 0x56, 8, 6},\n\t{40, 0x56, 8, 8},\n\t{44, 0x57, 8, 0},\n\t{46, 0x57, 8, 2},\n\t{48, 0x57, 8, 4},\n\t{52, 0x57, 8, 8},\n\t{54, 0x57, 8, 10},\n\t{56, 0x58, 8, 0},\n\t{60, 0x58, 8, 4},\n\t{62, 0x58, 8, 6},\n\t{64, 0x58, 8, 8},\n\n\t{100, 0x5b, 8, 8},\n\t{102, 0x5b, 8, 10},\n\t{104, 0x5c, 8, 0},\n\t{108, 0x5c, 8, 4},\n\t{110, 0x5c, 8, 6},\n\t{112, 0x5c, 8, 8},\n\t{114, 0x5c, 8, 10},\n\t{116, 0x5d, 8, 0},\n\t{118, 0x5d, 8, 2},\n\t{120, 0x5d, 8, 4},\n\t{124, 0x5d, 8, 8},\n\t{126, 0x5d, 8, 10},\n\t{128, 0x5e, 8, 0},\n\t{132, 0x5e, 8, 4},\n\t{134, 0x5e, 8, 6},\n\t{136, 0x5e, 8, 8},\n\t{140, 0x5f, 8, 0},\n\n\t{149, 0x5f, 8, 9},\n\t{151, 0x5f, 8, 11},\n\t{153, 0x60, 8, 1},\n\t{157, 0x60, 8, 5},\n\t{159, 0x60, 8, 7},\n\t{161, 0x60, 8, 9},\n\t{165, 0x61, 8, 1},\n\t{167, 0x61, 8, 3},\n\t{169, 0x61, 8, 5},\n\t{171, 0x61, 8, 7},\n\t{173, 0x61, 8, 9},\n};\n\nstatic const struct rf_channel rf_vals_5592_xtal20[] = {\n\t \n\t{1, 482, 4, 10, 3},\n\t{2, 483, 4, 10, 3},\n\t{3, 484, 4, 10, 3},\n\t{4, 485, 4, 10, 3},\n\t{5, 486, 4, 10, 3},\n\t{6, 487, 4, 10, 3},\n\t{7, 488, 4, 10, 3},\n\t{8, 489, 4, 10, 3},\n\t{9, 490, 4, 10, 3},\n\t{10, 491, 4, 10, 3},\n\t{11, 492, 4, 10, 3},\n\t{12, 493, 4, 10, 3},\n\t{13, 494, 4, 10, 3},\n\t{14, 496, 8, 10, 3},\n\t{36, 172, 8, 12, 1},\n\t{38, 173, 0, 12, 1},\n\t{40, 173, 4, 12, 1},\n\t{42, 173, 8, 12, 1},\n\t{44, 174, 0, 12, 1},\n\t{46, 174, 4, 12, 1},\n\t{48, 174, 8, 12, 1},\n\t{50, 175, 0, 12, 1},\n\t{52, 175, 4, 12, 1},\n\t{54, 175, 8, 12, 1},\n\t{56, 176, 0, 12, 1},\n\t{58, 176, 4, 12, 1},\n\t{60, 176, 8, 12, 1},\n\t{62, 177, 0, 12, 1},\n\t{64, 177, 4, 12, 1},\n\t{100, 183, 4, 12, 1},\n\t{102, 183, 8, 12, 1},\n\t{104, 184, 0, 12, 1},\n\t{106, 184, 4, 12, 1},\n\t{108, 184, 8, 12, 1},\n\t{110, 185, 0, 12, 1},\n\t{112, 185, 4, 12, 1},\n\t{114, 185, 8, 12, 1},\n\t{116, 186, 0, 12, 1},\n\t{118, 186, 4, 12, 1},\n\t{120, 186, 8, 12, 1},\n\t{122, 187, 0, 12, 1},\n\t{124, 187, 4, 12, 1},\n\t{126, 187, 8, 12, 1},\n\t{128, 188, 0, 12, 1},\n\t{130, 188, 4, 12, 1},\n\t{132, 188, 8, 12, 1},\n\t{134, 189, 0, 12, 1},\n\t{136, 189, 4, 12, 1},\n\t{138, 189, 8, 12, 1},\n\t{140, 190, 0, 12, 1},\n\t{149, 191, 6, 12, 1},\n\t{151, 191, 10, 12, 1},\n\t{153, 192, 2, 12, 1},\n\t{155, 192, 6, 12, 1},\n\t{157, 192, 10, 12, 1},\n\t{159, 193, 2, 12, 1},\n\t{161, 193, 6, 12, 1},\n\t{165, 194, 2, 12, 1},\n\t{184, 164, 0, 12, 1},\n\t{188, 164, 4, 12, 1},\n\t{192, 165, 8, 12, 1},\n\t{196, 166, 0, 12, 1},\n};\n\nstatic const struct rf_channel rf_vals_5592_xtal40[] = {\n\t \n\t{1, 241, 2, 10, 3},\n\t{2, 241, 7, 10, 3},\n\t{3, 242, 2, 10, 3},\n\t{4, 242, 7, 10, 3},\n\t{5, 243, 2, 10, 3},\n\t{6, 243, 7, 10, 3},\n\t{7, 244, 2, 10, 3},\n\t{8, 244, 7, 10, 3},\n\t{9, 245, 2, 10, 3},\n\t{10, 245, 7, 10, 3},\n\t{11, 246, 2, 10, 3},\n\t{12, 246, 7, 10, 3},\n\t{13, 247, 2, 10, 3},\n\t{14, 248, 4, 10, 3},\n\t{36, 86, 4, 12, 1},\n\t{38, 86, 6, 12, 1},\n\t{40, 86, 8, 12, 1},\n\t{42, 86, 10, 12, 1},\n\t{44, 87, 0, 12, 1},\n\t{46, 87, 2, 12, 1},\n\t{48, 87, 4, 12, 1},\n\t{50, 87, 6, 12, 1},\n\t{52, 87, 8, 12, 1},\n\t{54, 87, 10, 12, 1},\n\t{56, 88, 0, 12, 1},\n\t{58, 88, 2, 12, 1},\n\t{60, 88, 4, 12, 1},\n\t{62, 88, 6, 12, 1},\n\t{64, 88, 8, 12, 1},\n\t{100, 91, 8, 12, 1},\n\t{102, 91, 10, 12, 1},\n\t{104, 92, 0, 12, 1},\n\t{106, 92, 2, 12, 1},\n\t{108, 92, 4, 12, 1},\n\t{110, 92, 6, 12, 1},\n\t{112, 92, 8, 12, 1},\n\t{114, 92, 10, 12, 1},\n\t{116, 93, 0, 12, 1},\n\t{118, 93, 2, 12, 1},\n\t{120, 93, 4, 12, 1},\n\t{122, 93, 6, 12, 1},\n\t{124, 93, 8, 12, 1},\n\t{126, 93, 10, 12, 1},\n\t{128, 94, 0, 12, 1},\n\t{130, 94, 2, 12, 1},\n\t{132, 94, 4, 12, 1},\n\t{134, 94, 6, 12, 1},\n\t{136, 94, 8, 12, 1},\n\t{138, 94, 10, 12, 1},\n\t{140, 95, 0, 12, 1},\n\t{149, 95, 9, 12, 1},\n\t{151, 95, 11, 12, 1},\n\t{153, 96, 1, 12, 1},\n\t{155, 96, 3, 12, 1},\n\t{157, 96, 5, 12, 1},\n\t{159, 96, 7, 12, 1},\n\t{161, 96, 9, 12, 1},\n\t{165, 97, 1, 12, 1},\n\t{184, 82, 0, 12, 1},\n\t{188, 82, 4, 12, 1},\n\t{192, 82, 8, 12, 1},\n\t{196, 83, 0, 12, 1},\n};\n\nstatic const struct rf_channel rf_vals_7620[] = {\n\t{1, 0x50, 0x99, 0x99, 1},\n\t{2, 0x50, 0x44, 0x44, 2},\n\t{3, 0x50, 0xEE, 0xEE, 2},\n\t{4, 0x50, 0x99, 0x99, 3},\n\t{5, 0x51, 0x44, 0x44, 0},\n\t{6, 0x51, 0xEE, 0xEE, 0},\n\t{7, 0x51, 0x99, 0x99, 1},\n\t{8, 0x51, 0x44, 0x44, 2},\n\t{9, 0x51, 0xEE, 0xEE, 2},\n\t{10, 0x51, 0x99, 0x99, 3},\n\t{11, 0x52, 0x44, 0x44, 0},\n\t{12, 0x52, 0xEE, 0xEE, 0},\n\t{13, 0x52, 0x99, 0x99, 1},\n\t{14, 0x52, 0x33, 0x33, 3},\n};\n\nstatic int rt2800_probe_hw_mode(struct rt2x00_dev *rt2x00dev)\n{\n\tstruct hw_mode_spec *spec = &rt2x00dev->spec;\n\tstruct channel_info *info;\n\ts8 *default_power1;\n\ts8 *default_power2;\n\ts8 *default_power3;\n\tunsigned int i, tx_chains, rx_chains;\n\tu32 reg;\n\n\t \n\trt2x00dev->hw->wiphy->flags &= ~WIPHY_FLAG_PS_ON_BY_DEFAULT;\n\n\t \n\trt2x00dev->hw->wiphy->retry_short = 2;\n\trt2x00dev->hw->wiphy->retry_long = 2;\n\n\t \n\tieee80211_hw_set(rt2x00dev->hw, REPORTS_TX_ACK_STATUS);\n\tieee80211_hw_set(rt2x00dev->hw, AMPDU_AGGREGATION);\n\tieee80211_hw_set(rt2x00dev->hw, PS_NULLFUNC_STACK);\n\tieee80211_hw_set(rt2x00dev->hw, SIGNAL_DBM);\n\tieee80211_hw_set(rt2x00dev->hw, SUPPORTS_PS);\n\n\t \n\tif (!rt2x00_is_usb(rt2x00dev))\n\t\tieee80211_hw_set(rt2x00dev->hw, HOST_BROADCAST_PS_BUFFERING);\n\n\tieee80211_hw_set(rt2x00dev->hw, MFP_CAPABLE);\n\n\tSET_IEEE80211_DEV(rt2x00dev->hw, rt2x00dev->dev);\n\tSET_IEEE80211_PERM_ADDR(rt2x00dev->hw,\n\t\t\t\trt2800_eeprom_addr(rt2x00dev,\n\t\t\t\t\t\t   EEPROM_MAC_ADDR_0));\n\n\t \n\trt2x00dev->hw->max_rates = 1;\n\trt2x00dev->hw->max_report_rates = 7;\n\trt2x00dev->hw->max_rate_tries = 1;\n\n\t \n\tspec->supported_rates = SUPPORT_RATE_CCK | SUPPORT_RATE_OFDM;\n\n\tswitch (rt2x00dev->chip.rf) {\n\tcase RF2720:\n\tcase RF2820:\n\t\tspec->num_channels = 14;\n\t\tspec->channels = rf_vals;\n\t\tbreak;\n\n\tcase RF2750:\n\tcase RF2850:\n\t\tspec->num_channels = ARRAY_SIZE(rf_vals);\n\t\tspec->channels = rf_vals;\n\t\tbreak;\n\n\tcase RF2020:\n\tcase RF3020:\n\tcase RF3021:\n\tcase RF3022:\n\tcase RF3070:\n\tcase RF3290:\n\tcase RF3320:\n\tcase RF3322:\n\tcase RF5350:\n\tcase RF5360:\n\tcase RF5362:\n\tcase RF5370:\n\tcase RF5372:\n\tcase RF5390:\n\tcase RF5392:\n\t\tspec->num_channels = 14;\n\t\tif (rt2800_clk_is_20mhz(rt2x00dev))\n\t\t\tspec->channels = rf_vals_3x_xtal20;\n\t\telse\n\t\t\tspec->channels = rf_vals_3x;\n\t\tbreak;\n\n\tcase RF7620:\n\t\tspec->num_channels = ARRAY_SIZE(rf_vals_7620);\n\t\tspec->channels = rf_vals_7620;\n\t\tbreak;\n\n\tcase RF3052:\n\tcase RF3053:\n\t\tspec->num_channels = ARRAY_SIZE(rf_vals_3x);\n\t\tspec->channels = rf_vals_3x;\n\t\tbreak;\n\n\tcase RF3853:\n\t\tspec->num_channels = ARRAY_SIZE(rf_vals_3853);\n\t\tspec->channels = rf_vals_3853;\n\t\tbreak;\n\n\tcase RF5592:\n\t\treg = rt2800_register_read(rt2x00dev, MAC_DEBUG_INDEX);\n\t\tif (rt2x00_get_field32(reg, MAC_DEBUG_INDEX_XTAL)) {\n\t\t\tspec->num_channels = ARRAY_SIZE(rf_vals_5592_xtal40);\n\t\t\tspec->channels = rf_vals_5592_xtal40;\n\t\t} else {\n\t\t\tspec->num_channels = ARRAY_SIZE(rf_vals_5592_xtal20);\n\t\t\tspec->channels = rf_vals_5592_xtal20;\n\t\t}\n\t\tbreak;\n\t}\n\n\tif (WARN_ON_ONCE(!spec->channels))\n\t\treturn -ENODEV;\n\n\tspec->supported_bands = SUPPORT_BAND_2GHZ;\n\tif (spec->num_channels > 14)\n\t\tspec->supported_bands |= SUPPORT_BAND_5GHZ;\n\n\t \n\tif (!rt2x00_rf(rt2x00dev, RF2020))\n\t\tspec->ht.ht_supported = true;\n\telse\n\t\tspec->ht.ht_supported = false;\n\n\tspec->ht.cap =\n\t    IEEE80211_HT_CAP_SUP_WIDTH_20_40 |\n\t    IEEE80211_HT_CAP_GRN_FLD |\n\t    IEEE80211_HT_CAP_SGI_20 |\n\t    IEEE80211_HT_CAP_SGI_40;\n\n\ttx_chains = rt2x00dev->default_ant.tx_chain_num;\n\trx_chains = rt2x00dev->default_ant.rx_chain_num;\n\n\tif (tx_chains >= 2)\n\t\tspec->ht.cap |= IEEE80211_HT_CAP_TX_STBC;\n\n\tspec->ht.cap |= rx_chains << IEEE80211_HT_CAP_RX_STBC_SHIFT;\n\n\tspec->ht.ampdu_factor = (rx_chains > 1) ? 3 : 2;\n\tspec->ht.ampdu_density = 4;\n\tspec->ht.mcs.tx_params = IEEE80211_HT_MCS_TX_DEFINED;\n\tif (tx_chains != rx_chains) {\n\t\tspec->ht.mcs.tx_params |= IEEE80211_HT_MCS_TX_RX_DIFF;\n\t\tspec->ht.mcs.tx_params |=\n\t\t    (tx_chains - 1) << IEEE80211_HT_MCS_TX_MAX_STREAMS_SHIFT;\n\t}\n\n\tswitch (rx_chains) {\n\tcase 3:\n\t\tspec->ht.mcs.rx_mask[2] = 0xff;\n\t\tfallthrough;\n\tcase 2:\n\t\tspec->ht.mcs.rx_mask[1] = 0xff;\n\t\tfallthrough;\n\tcase 1:\n\t\tspec->ht.mcs.rx_mask[0] = 0xff;\n\t\tspec->ht.mcs.rx_mask[4] = 0x1;  \n\t\tbreak;\n\t}\n\n\t \n\tinfo = kcalloc(spec->num_channels, sizeof(*info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\trt2x00dev->chan_survey =\n\t\tkcalloc(spec->num_channels, sizeof(struct rt2x00_chan_survey),\n\t\t\tGFP_KERNEL);\n\tif (!rt2x00dev->chan_survey) {\n\t\tkfree(info);\n\t\treturn -ENOMEM;\n\t}\n\n\tspec->channels_info = info;\n\n\tdefault_power1 = rt2800_eeprom_addr(rt2x00dev, EEPROM_TXPOWER_BG1);\n\tdefault_power2 = rt2800_eeprom_addr(rt2x00dev, EEPROM_TXPOWER_BG2);\n\n\tif (rt2x00dev->default_ant.tx_chain_num > 2)\n\t\tdefault_power3 = rt2800_eeprom_addr(rt2x00dev,\n\t\t\t\t\t\t    EEPROM_EXT_TXPOWER_BG3);\n\telse\n\t\tdefault_power3 = NULL;\n\n\tfor (i = 0; i < 14; i++) {\n\t\tinfo[i].default_power1 = default_power1[i];\n\t\tinfo[i].default_power2 = default_power2[i];\n\t\tif (default_power3)\n\t\t\tinfo[i].default_power3 = default_power3[i];\n\t}\n\n\tif (spec->num_channels > 14) {\n\t\tdefault_power1 = rt2800_eeprom_addr(rt2x00dev,\n\t\t\t\t\t\t    EEPROM_TXPOWER_A1);\n\t\tdefault_power2 = rt2800_eeprom_addr(rt2x00dev,\n\t\t\t\t\t\t    EEPROM_TXPOWER_A2);\n\n\t\tif (rt2x00dev->default_ant.tx_chain_num > 2)\n\t\t\tdefault_power3 =\n\t\t\t\trt2800_eeprom_addr(rt2x00dev,\n\t\t\t\t\t\t   EEPROM_EXT_TXPOWER_A3);\n\t\telse\n\t\t\tdefault_power3 = NULL;\n\n\t\tfor (i = 14; i < spec->num_channels; i++) {\n\t\t\tinfo[i].default_power1 = default_power1[i - 14];\n\t\t\tinfo[i].default_power2 = default_power2[i - 14];\n\t\t\tif (default_power3)\n\t\t\t\tinfo[i].default_power3 = default_power3[i - 14];\n\t\t}\n\t}\n\n\tswitch (rt2x00dev->chip.rf) {\n\tcase RF2020:\n\tcase RF3020:\n\tcase RF3021:\n\tcase RF3022:\n\tcase RF3320:\n\tcase RF3052:\n\tcase RF3053:\n\tcase RF3070:\n\tcase RF3290:\n\tcase RF3853:\n\tcase RF5350:\n\tcase RF5360:\n\tcase RF5362:\n\tcase RF5370:\n\tcase RF5372:\n\tcase RF5390:\n\tcase RF5392:\n\tcase RF5592:\n\tcase RF7620:\n\t\t__set_bit(CAPABILITY_VCO_RECALIBRATION, &rt2x00dev->cap_flags);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int rt2800_probe_rt(struct rt2x00_dev *rt2x00dev)\n{\n\tu32 reg;\n\tu32 rt;\n\tu32 rev;\n\n\tif (rt2x00_rt(rt2x00dev, RT3290))\n\t\treg = rt2800_register_read(rt2x00dev, MAC_CSR0_3290);\n\telse\n\t\treg = rt2800_register_read(rt2x00dev, MAC_CSR0);\n\n\trt = rt2x00_get_field32(reg, MAC_CSR0_CHIPSET);\n\trev = rt2x00_get_field32(reg, MAC_CSR0_REVISION);\n\n\tswitch (rt) {\n\tcase RT2860:\n\tcase RT2872:\n\tcase RT2883:\n\tcase RT3070:\n\tcase RT3071:\n\tcase RT3090:\n\tcase RT3290:\n\tcase RT3352:\n\tcase RT3390:\n\tcase RT3572:\n\tcase RT3593:\n\tcase RT3883:\n\tcase RT5350:\n\tcase RT5390:\n\tcase RT5392:\n\tcase RT5592:\n\t\tbreak;\n\tdefault:\n\t\trt2x00_err(rt2x00dev, \"Invalid RT chipset 0x%04x, rev %04x detected\\n\",\n\t\t\t   rt, rev);\n\t\treturn -ENODEV;\n\t}\n\n\tif (rt == RT5390 && rt2x00_is_soc(rt2x00dev))\n\t\trt = RT6352;\n\n\trt2x00_set_rt(rt2x00dev, rt, rev);\n\n\treturn 0;\n}\n\nint rt2800_probe_hw(struct rt2x00_dev *rt2x00dev)\n{\n\tint retval;\n\tu32 reg;\n\n\tretval = rt2800_probe_rt(rt2x00dev);\n\tif (retval)\n\t\treturn retval;\n\n\t \n\tretval = rt2800_validate_eeprom(rt2x00dev);\n\tif (retval)\n\t\treturn retval;\n\n\tretval = rt2800_init_eeprom(rt2x00dev);\n\tif (retval)\n\t\treturn retval;\n\n\t \n\treg = rt2800_register_read(rt2x00dev, GPIO_CTRL);\n\trt2x00_set_field32(&reg, GPIO_CTRL_DIR2, 1);\n\trt2800_register_write(rt2x00dev, GPIO_CTRL, reg);\n\n\t \n\tretval = rt2800_probe_hw_mode(rt2x00dev);\n\tif (retval)\n\t\treturn retval;\n\n\t \n\t__set_bit(CAPABILITY_CONTROL_FILTERS, &rt2x00dev->cap_flags);\n\t__set_bit(CAPABILITY_CONTROL_FILTER_PSPOLL, &rt2x00dev->cap_flags);\n\tif (!rt2x00_is_usb(rt2x00dev))\n\t\t__set_bit(CAPABILITY_PRE_TBTT_INTERRUPT, &rt2x00dev->cap_flags);\n\n\t \n\tif (!rt2x00_is_soc(rt2x00dev))\n\t\t__set_bit(REQUIRE_FIRMWARE, &rt2x00dev->cap_flags);\n\t__set_bit(REQUIRE_L2PAD, &rt2x00dev->cap_flags);\n\t__set_bit(REQUIRE_TXSTATUS_FIFO, &rt2x00dev->cap_flags);\n\tif (!rt2800_hwcrypt_disabled(rt2x00dev))\n\t\t__set_bit(CAPABILITY_HW_CRYPTO, &rt2x00dev->cap_flags);\n\t__set_bit(CAPABILITY_LINK_TUNING, &rt2x00dev->cap_flags);\n\t__set_bit(REQUIRE_HT_TX_DESC, &rt2x00dev->cap_flags);\n\tif (rt2x00_is_usb(rt2x00dev))\n\t\t__set_bit(REQUIRE_PS_AUTOWAKE, &rt2x00dev->cap_flags);\n\telse {\n\t\t__set_bit(REQUIRE_DMA, &rt2x00dev->cap_flags);\n\t\t__set_bit(REQUIRE_TASKLET_CONTEXT, &rt2x00dev->cap_flags);\n\t}\n\n\tif (modparam_watchdog) {\n\t\t__set_bit(CAPABILITY_RESTART_HW, &rt2x00dev->cap_flags);\n\t\trt2x00dev->link.watchdog_interval = msecs_to_jiffies(100);\n\t} else {\n\t\trt2x00dev->link.watchdog_disabled = true;\n\t}\n\n\t \n\trt2x00dev->rssi_offset = DEFAULT_RSSI_OFFSET;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rt2800_probe_hw);\n\n \nvoid rt2800_get_key_seq(struct ieee80211_hw *hw,\n\t\t\tstruct ieee80211_key_conf *key,\n\t\t\tstruct ieee80211_key_seq *seq)\n{\n\tstruct rt2x00_dev *rt2x00dev = hw->priv;\n\tstruct mac_iveiv_entry iveiv_entry;\n\tu32 offset;\n\n\tif (key->cipher != WLAN_CIPHER_SUITE_TKIP)\n\t\treturn;\n\n\toffset = MAC_IVEIV_ENTRY(key->hw_key_idx);\n\trt2800_register_multiread(rt2x00dev, offset,\n\t\t\t\t      &iveiv_entry, sizeof(iveiv_entry));\n\n\tmemcpy(&seq->tkip.iv16, &iveiv_entry.iv[0], 2);\n\tmemcpy(&seq->tkip.iv32, &iveiv_entry.iv[4], 4);\n}\nEXPORT_SYMBOL_GPL(rt2800_get_key_seq);\n\nint rt2800_set_rts_threshold(struct ieee80211_hw *hw, u32 value)\n{\n\tstruct rt2x00_dev *rt2x00dev = hw->priv;\n\tu32 reg;\n\tbool enabled = (value < IEEE80211_MAX_RTS_THRESHOLD);\n\n\treg = rt2800_register_read(rt2x00dev, TX_RTS_CFG);\n\trt2x00_set_field32(&reg, TX_RTS_CFG_RTS_THRES, value);\n\trt2800_register_write(rt2x00dev, TX_RTS_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, CCK_PROT_CFG);\n\trt2x00_set_field32(&reg, CCK_PROT_CFG_RTS_TH_EN, enabled);\n\trt2800_register_write(rt2x00dev, CCK_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, OFDM_PROT_CFG);\n\trt2x00_set_field32(&reg, OFDM_PROT_CFG_RTS_TH_EN, enabled);\n\trt2800_register_write(rt2x00dev, OFDM_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, MM20_PROT_CFG);\n\trt2x00_set_field32(&reg, MM20_PROT_CFG_RTS_TH_EN, enabled);\n\trt2800_register_write(rt2x00dev, MM20_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, MM40_PROT_CFG);\n\trt2x00_set_field32(&reg, MM40_PROT_CFG_RTS_TH_EN, enabled);\n\trt2800_register_write(rt2x00dev, MM40_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, GF20_PROT_CFG);\n\trt2x00_set_field32(&reg, GF20_PROT_CFG_RTS_TH_EN, enabled);\n\trt2800_register_write(rt2x00dev, GF20_PROT_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, GF40_PROT_CFG);\n\trt2x00_set_field32(&reg, GF40_PROT_CFG_RTS_TH_EN, enabled);\n\trt2800_register_write(rt2x00dev, GF40_PROT_CFG, reg);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rt2800_set_rts_threshold);\n\nint rt2800_conf_tx(struct ieee80211_hw *hw,\n\t\t   struct ieee80211_vif *vif,\n\t\t   unsigned int link_id, u16 queue_idx,\n\t\t   const struct ieee80211_tx_queue_params *params)\n{\n\tstruct rt2x00_dev *rt2x00dev = hw->priv;\n\tstruct data_queue *queue;\n\tstruct rt2x00_field32 field;\n\tint retval;\n\tu32 reg;\n\tu32 offset;\n\n\t \n\tretval = rt2x00mac_conf_tx(hw, vif, link_id, queue_idx, params);\n\tif (retval)\n\t\treturn retval;\n\n\t \n\tif (queue_idx >= 4)\n\t\treturn 0;\n\n\tqueue = rt2x00queue_get_tx_queue(rt2x00dev, queue_idx);\n\n\t \n\toffset = WMM_TXOP0_CFG + (sizeof(u32) * (!!(queue_idx & 2)));\n\tfield.bit_offset = (queue_idx & 1) * 16;\n\tfield.bit_mask = 0xffff << field.bit_offset;\n\n\treg = rt2800_register_read(rt2x00dev, offset);\n\trt2x00_set_field32(&reg, field, queue->txop);\n\trt2800_register_write(rt2x00dev, offset, reg);\n\n\t \n\tfield.bit_offset = queue_idx * 4;\n\tfield.bit_mask = 0xf << field.bit_offset;\n\n\treg = rt2800_register_read(rt2x00dev, WMM_AIFSN_CFG);\n\trt2x00_set_field32(&reg, field, queue->aifs);\n\trt2800_register_write(rt2x00dev, WMM_AIFSN_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, WMM_CWMIN_CFG);\n\trt2x00_set_field32(&reg, field, queue->cw_min);\n\trt2800_register_write(rt2x00dev, WMM_CWMIN_CFG, reg);\n\n\treg = rt2800_register_read(rt2x00dev, WMM_CWMAX_CFG);\n\trt2x00_set_field32(&reg, field, queue->cw_max);\n\trt2800_register_write(rt2x00dev, WMM_CWMAX_CFG, reg);\n\n\t \n\toffset = EDCA_AC0_CFG + (sizeof(u32) * queue_idx);\n\n\treg = rt2800_register_read(rt2x00dev, offset);\n\trt2x00_set_field32(&reg, EDCA_AC0_CFG_TX_OP, queue->txop);\n\trt2x00_set_field32(&reg, EDCA_AC0_CFG_AIFSN, queue->aifs);\n\trt2x00_set_field32(&reg, EDCA_AC0_CFG_CWMIN, queue->cw_min);\n\trt2x00_set_field32(&reg, EDCA_AC0_CFG_CWMAX, queue->cw_max);\n\trt2800_register_write(rt2x00dev, offset, reg);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(rt2800_conf_tx);\n\nu64 rt2800_get_tsf(struct ieee80211_hw *hw, struct ieee80211_vif *vif)\n{\n\tstruct rt2x00_dev *rt2x00dev = hw->priv;\n\tu64 tsf;\n\tu32 reg;\n\n\treg = rt2800_register_read(rt2x00dev, TSF_TIMER_DW1);\n\ttsf = (u64) rt2x00_get_field32(reg, TSF_TIMER_DW1_HIGH_WORD) << 32;\n\treg = rt2800_register_read(rt2x00dev, TSF_TIMER_DW0);\n\ttsf |= rt2x00_get_field32(reg, TSF_TIMER_DW0_LOW_WORD);\n\n\treturn tsf;\n}\nEXPORT_SYMBOL_GPL(rt2800_get_tsf);\n\nint rt2800_ampdu_action(struct ieee80211_hw *hw, struct ieee80211_vif *vif,\n\t\t\tstruct ieee80211_ampdu_params *params)\n{\n\tstruct ieee80211_sta *sta = params->sta;\n\tenum ieee80211_ampdu_mlme_action action = params->action;\n\tu16 tid = params->tid;\n\tstruct rt2x00_sta *sta_priv = (struct rt2x00_sta *)sta->drv_priv;\n\tint ret = 0;\n\n\t \n\tif (sta_priv->wcid > WCID_END)\n\t\treturn -ENOSPC;\n\n\tswitch (action) {\n\tcase IEEE80211_AMPDU_RX_START:\n\tcase IEEE80211_AMPDU_RX_STOP:\n\t\t \n\t\tbreak;\n\tcase IEEE80211_AMPDU_TX_START:\n\t\tret = IEEE80211_AMPDU_TX_START_IMMEDIATE;\n\t\tbreak;\n\tcase IEEE80211_AMPDU_TX_STOP_CONT:\n\tcase IEEE80211_AMPDU_TX_STOP_FLUSH:\n\tcase IEEE80211_AMPDU_TX_STOP_FLUSH_CONT:\n\t\tieee80211_stop_tx_ba_cb_irqsafe(vif, sta->addr, tid);\n\t\tbreak;\n\tcase IEEE80211_AMPDU_TX_OPERATIONAL:\n\t\tbreak;\n\tdefault:\n\t\trt2x00_warn((struct rt2x00_dev *)hw->priv,\n\t\t\t    \"Unknown AMPDU action\\n\");\n\t}\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(rt2800_ampdu_action);\n\nint rt2800_get_survey(struct ieee80211_hw *hw, int idx,\n\t\t      struct survey_info *survey)\n{\n\tstruct rt2x00_dev *rt2x00dev = hw->priv;\n\tstruct rt2x00_chan_survey *chan_survey =\n\t\t   &rt2x00dev->chan_survey[idx];\n\tenum nl80211_band band = NL80211_BAND_2GHZ;\n\n\tif (idx >= rt2x00dev->bands[band].n_channels) {\n\t\tidx -= rt2x00dev->bands[band].n_channels;\n\t\tband = NL80211_BAND_5GHZ;\n\t}\n\n\tif (idx >= rt2x00dev->bands[band].n_channels)\n\t\treturn -ENOENT;\n\n\tif (idx == 0)\n\t\trt2800_update_survey(rt2x00dev);\n\n\tsurvey->channel = &rt2x00dev->bands[band].channels[idx];\n\n\tsurvey->filled = SURVEY_INFO_TIME |\n\t\t\t SURVEY_INFO_TIME_BUSY |\n\t\t\t SURVEY_INFO_TIME_EXT_BUSY;\n\n\tsurvey->time = div_u64(chan_survey->time_idle + chan_survey->time_busy, 1000);\n\tsurvey->time_busy = div_u64(chan_survey->time_busy, 1000);\n\tsurvey->time_ext_busy = div_u64(chan_survey->time_ext_busy, 1000);\n\n\tif (!(hw->conf.flags & IEEE80211_CONF_OFFCHANNEL))\n\t\tsurvey->filled |= SURVEY_INFO_IN_USE;\n\n\treturn 0;\n\n}\nEXPORT_SYMBOL_GPL(rt2800_get_survey);\n\nMODULE_AUTHOR(DRV_PROJECT \", Bartlomiej Zolnierkiewicz\");\nMODULE_VERSION(DRV_VERSION);\nMODULE_DESCRIPTION(\"Ralink RT2800 library\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}