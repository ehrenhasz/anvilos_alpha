{
  "module_name": "radio.c",
  "hash_id": "2939d33fbe4e1d22927d9230e5b21f1ed58c557b8467cb4f4111953607d394e7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/b43legacy/radio.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n\n#include \"b43legacy.h\"\n#include \"main.h\"\n#include \"phy.h\"\n#include \"radio.h\"\n#include \"ilt.h\"\n\n\n \nstatic const u16 rcc_table[16] = {\n\t0x0002, 0x0003, 0x0001, 0x000F,\n\t0x0006, 0x0007, 0x0005, 0x000F,\n\t0x000A, 0x000B, 0x0009, 0x000F,\n\t0x000E, 0x000F, 0x000D, 0x000F,\n};\n\n \nstatic u16 flip_4bit(u16 value)\n{\n\tu16 flipped = 0x0000;\n\n\tB43legacy_BUG_ON(!((value & ~0x000F) == 0x0000));\n\n\tflipped |= (value & 0x0001) << 3;\n\tflipped |= (value & 0x0002) << 1;\n\tflipped |= (value & 0x0004) >> 1;\n\tflipped |= (value & 0x0008) >> 3;\n\n\treturn flipped;\n}\n\n \nstatic inline\nu16 channel2freq_bg(u8 channel)\n{\n\t \n\tstatic const u16 frequencies_bg[14] = {\n\t\t12, 17, 22, 27,\n\t\t32, 37, 42, 47,\n\t\t52, 57, 62, 67,\n\t\t72, 84,\n\t};\n\n\tif (unlikely(channel < 1 || channel > 14)) {\n\t\tprintk(KERN_INFO \"b43legacy: Channel %d is out of range\\n\",\n\t\t\t\t  channel);\n\t\tdump_stack();\n\t\treturn 2412;\n\t}\n\n\treturn frequencies_bg[channel - 1];\n}\n\nvoid b43legacy_radio_lock(struct b43legacy_wldev *dev)\n{\n\tu32 status;\n\n\tstatus = b43legacy_read32(dev, B43legacy_MMIO_MACCTL);\n\tB43legacy_WARN_ON(status & B43legacy_MACCTL_RADIOLOCK);\n\tstatus |= B43legacy_MACCTL_RADIOLOCK;\n\tb43legacy_write32(dev, B43legacy_MMIO_MACCTL, status);\n\tudelay(10);\n}\n\nvoid b43legacy_radio_unlock(struct b43legacy_wldev *dev)\n{\n\tu32 status;\n\n\tb43legacy_read16(dev, B43legacy_MMIO_PHY_VER);  \n\tstatus = b43legacy_read32(dev, B43legacy_MMIO_MACCTL);\n\tB43legacy_WARN_ON(!(status & B43legacy_MACCTL_RADIOLOCK));\n\tstatus &= ~B43legacy_MACCTL_RADIOLOCK;\n\tb43legacy_write32(dev, B43legacy_MMIO_MACCTL, status);\n}\n\nu16 b43legacy_radio_read16(struct b43legacy_wldev *dev, u16 offset)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\tswitch (phy->type) {\n\tcase B43legacy_PHYTYPE_B:\n\t\tif (phy->radio_ver == 0x2053) {\n\t\t\tif (offset < 0x70)\n\t\t\t\toffset += 0x80;\n\t\t\telse if (offset < 0x80)\n\t\t\t\toffset += 0x70;\n\t\t} else if (phy->radio_ver == 0x2050)\n\t\t\toffset |= 0x80;\n\t\telse\n\t\t\tB43legacy_WARN_ON(1);\n\t\tbreak;\n\tcase B43legacy_PHYTYPE_G:\n\t\toffset |= 0x80;\n\t\tbreak;\n\tdefault:\n\t\tB43legacy_BUG_ON(1);\n\t}\n\n\tb43legacy_write16(dev, B43legacy_MMIO_RADIO_CONTROL, offset);\n\treturn b43legacy_read16(dev, B43legacy_MMIO_RADIO_DATA_LOW);\n}\n\nvoid b43legacy_radio_write16(struct b43legacy_wldev *dev, u16 offset, u16 val)\n{\n\tb43legacy_write16(dev, B43legacy_MMIO_RADIO_CONTROL, offset);\n\tb43legacy_write16(dev, B43legacy_MMIO_RADIO_DATA_LOW, val);\n}\n\nstatic void b43legacy_set_all_gains(struct b43legacy_wldev *dev,\n\t\t\t\t  s16 first, s16 second, s16 third)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 i;\n\tu16 start = 0x08;\n\tu16 end = 0x18;\n\tu16 offset = 0x0400;\n\tu16 tmp;\n\n\tif (phy->rev <= 1) {\n\t\toffset = 0x5000;\n\t\tstart = 0x10;\n\t\tend = 0x20;\n\t}\n\n\tfor (i = 0; i < 4; i++)\n\t\tb43legacy_ilt_write(dev, offset + i, first);\n\n\tfor (i = start; i < end; i++)\n\t\tb43legacy_ilt_write(dev, offset + i, second);\n\n\tif (third != -1) {\n\t\ttmp = ((u16)third << 14) | ((u16)third << 6);\n\t\tb43legacy_phy_write(dev, 0x04A0,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A0) & 0xBFBF)\n\t\t\t\t    | tmp);\n\t\tb43legacy_phy_write(dev, 0x04A1,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A1) & 0xBFBF)\n\t\t\t\t    | tmp);\n\t\tb43legacy_phy_write(dev, 0x04A2,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A2) & 0xBFBF)\n\t\t\t\t    | tmp);\n\t}\n\tb43legacy_dummy_transmission(dev);\n}\n\nstatic void b43legacy_set_original_gains(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 i;\n\tu16 tmp;\n\tu16 offset = 0x0400;\n\tu16 start = 0x0008;\n\tu16 end = 0x0018;\n\n\tif (phy->rev <= 1) {\n\t\toffset = 0x5000;\n\t\tstart = 0x0010;\n\t\tend = 0x0020;\n\t}\n\n\tfor (i = 0; i < 4; i++) {\n\t\ttmp = (i & 0xFFFC);\n\t\ttmp |= (i & 0x0001) << 1;\n\t\ttmp |= (i & 0x0002) >> 1;\n\n\t\tb43legacy_ilt_write(dev, offset + i, tmp);\n\t}\n\n\tfor (i = start; i < end; i++)\n\t\tb43legacy_ilt_write(dev, offset + i, i - start);\n\n\tb43legacy_phy_write(dev, 0x04A0,\n\t\t\t    (b43legacy_phy_read(dev, 0x04A0) & 0xBFBF)\n\t\t\t    | 0x4040);\n\tb43legacy_phy_write(dev, 0x04A1,\n\t\t\t    (b43legacy_phy_read(dev, 0x04A1) & 0xBFBF)\n\t\t\t    | 0x4040);\n\tb43legacy_phy_write(dev, 0x04A2,\n\t\t\t    (b43legacy_phy_read(dev, 0x04A2) & 0xBFBF)\n\t\t\t    | 0x4000);\n\tb43legacy_dummy_transmission(dev);\n}\n\n \nstatic void b43legacy_synth_pu_workaround(struct b43legacy_wldev *dev,\n\t\t\t\t\t  u8 channel)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\tmight_sleep();\n\n\tif (phy->radio_ver != 0x2050 || phy->radio_rev >= 6)\n\t\t \n\t\treturn;\n\n\tif (channel <= 10)\n\t\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL,\n\t\t\t\t  channel2freq_bg(channel + 4));\n\telse\n\t\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL,\n\t\t\t\t  channel2freq_bg(channel));\n\tmsleep(1);\n\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL,\n\t\t\t  channel2freq_bg(channel));\n}\n\nu8 b43legacy_radio_aci_detect(struct b43legacy_wldev *dev, u8 channel)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu8 ret = 0;\n\tu16 saved;\n\tu16 rssi;\n\tu16 temp;\n\tint i;\n\tint j = 0;\n\n\tsaved = b43legacy_phy_read(dev, 0x0403);\n\tb43legacy_radio_selectchannel(dev, channel, 0);\n\tb43legacy_phy_write(dev, 0x0403, (saved & 0xFFF8) | 5);\n\tif (phy->aci_hw_rssi)\n\t\trssi = b43legacy_phy_read(dev, 0x048A) & 0x3F;\n\telse\n\t\trssi = saved & 0x3F;\n\t \n\tif (rssi > 32)\n\t\trssi -= 64;\n\tfor (i = 0; i < 100; i++) {\n\t\ttemp = (b43legacy_phy_read(dev, 0x047F) >> 8) & 0x3F;\n\t\tif (temp > 32)\n\t\t\ttemp -= 64;\n\t\tif (temp < rssi)\n\t\t\tj++;\n\t\tif (j >= 20)\n\t\t\tret = 1;\n\t}\n\tb43legacy_phy_write(dev, 0x0403, saved);\n\n\treturn ret;\n}\n\nu8 b43legacy_radio_aci_scan(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu8 ret[13] = { 0 };\n\tunsigned int channel = phy->channel;\n\tunsigned int i;\n\tunsigned int j;\n\tunsigned int start;\n\tunsigned int end;\n\n\tif (!((phy->type == B43legacy_PHYTYPE_G) && (phy->rev > 0)))\n\t\treturn 0;\n\n\tb43legacy_phy_lock(dev);\n\tb43legacy_radio_lock(dev);\n\tb43legacy_phy_write(dev, 0x0802,\n\t\t\t    b43legacy_phy_read(dev, 0x0802) & 0xFFFC);\n\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS,\n\t\t\t    b43legacy_phy_read(dev, B43legacy_PHY_G_CRS)\n\t\t\t    & 0x7FFF);\n\tb43legacy_set_all_gains(dev, 3, 8, 1);\n\n\tstart = (channel > 5) ? channel - 5 : 1;\n\tend = (channel + 5 < 14) ? channel + 5 : 13;\n\n\tfor (i = start; i <= end; i++) {\n\t\tif (abs(channel - i) > 2)\n\t\t\tret[i-1] = b43legacy_radio_aci_detect(dev, i);\n\t}\n\tb43legacy_radio_selectchannel(dev, channel, 0);\n\tb43legacy_phy_write(dev, 0x0802,\n\t\t\t    (b43legacy_phy_read(dev, 0x0802) & 0xFFFC)\n\t\t\t    | 0x0003);\n\tb43legacy_phy_write(dev, 0x0403,\n\t\t\t    b43legacy_phy_read(dev, 0x0403) & 0xFFF8);\n\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS,\n\t\t\t    b43legacy_phy_read(dev, B43legacy_PHY_G_CRS)\n\t\t\t    | 0x8000);\n\tb43legacy_set_original_gains(dev);\n\tfor (i = 0; i < 13; i++) {\n\t\tif (!ret[i])\n\t\t\tcontinue;\n\t\tend = (i + 5 < 13) ? i + 5 : 13;\n\t\tfor (j = i; j < end; j++)\n\t\t\tret[j] = 1;\n\t}\n\tb43legacy_radio_unlock(dev);\n\tb43legacy_phy_unlock(dev);\n\n\treturn ret[channel - 1];\n}\n\n \n\t\tb43legacy_phy_write(dev, 0x0020, (((u16)threshold) << 8)\n\t\t\t\t    | 0x001C);\n\n\t\tif (phy->radio_rev >= 6) {\n\t\t\tb43legacy_phy_write(dev, 0x0087, 0x0E0D);\n\t\t\tb43legacy_phy_write(dev, 0x0086, 0x0C0B);\n\t\t\tb43legacy_phy_write(dev, 0x0085, 0x0A09);\n\t\t\tb43legacy_phy_write(dev, 0x0084, 0x0808);\n\t\t\tb43legacy_phy_write(dev, 0x0083, 0x0808);\n\t\t\tb43legacy_phy_write(dev, 0x0082, 0x0604);\n\t\t\tb43legacy_phy_write(dev, 0x0081, 0x0302);\n\t\t\tb43legacy_phy_write(dev, 0x0080, 0x0100);\n\t\t}\n\t\tbreak;\n\t}\n\tcase B43legacy_PHYTYPE_G:\n\t\tif (!phy->gmode ||\n\t\t    !(dev->dev->bus->sprom.boardflags_lo &\n\t\t    B43legacy_BFL_RSSI)) {\n\t\t\ttmp16 = b43legacy_nrssi_hw_read(dev, 0x20);\n\t\t\tif (tmp16 >= 0x20)\n\t\t\t\ttmp16 -= 0x40;\n\t\t\tif (tmp16 < 3)\n\t\t\t\tb43legacy_phy_write(dev, 0x048A,\n\t\t\t\t\t\t    (b43legacy_phy_read(dev,\n\t\t\t\t\t\t    0x048A) & 0xF000) | 0x09EB);\n\t\t\telse\n\t\t\t\tb43legacy_phy_write(dev, 0x048A,\n\t\t\t\t\t\t    (b43legacy_phy_read(dev,\n\t\t\t\t\t\t    0x048A) & 0xF000) | 0x0AED);\n\t\t} else {\n\t\t\tif (phy->interfmode ==\n\t\t\t    B43legacy_RADIO_INTERFMODE_NONWLAN) {\n\t\t\t\ta = 0xE;\n\t\t\t\tb = 0xA;\n\t\t\t} else if (!phy->aci_wlan_automatic &&\n\t\t\t\t    phy->aci_enable) {\n\t\t\t\ta = 0x13;\n\t\t\t\tb = 0x12;\n\t\t\t} else {\n\t\t\t\ta = 0xE;\n\t\t\t\tb = 0x11;\n\t\t\t}\n\n\t\t\ta = a * (phy->nrssi[1] - phy->nrssi[0]);\n\t\t\ta += (phy->nrssi[0] << 6);\n\t\t\tif (a < 32)\n\t\t\t\ta += 31;\n\t\t\telse\n\t\t\t\ta += 32;\n\t\t\ta = a >> 6;\n\t\t\ta = clamp_val(a, -31, 31);\n\n\t\t\tb = b * (phy->nrssi[1] - phy->nrssi[0]);\n\t\t\tb += (phy->nrssi[0] << 6);\n\t\t\tif (b < 32)\n\t\t\t\tb += 31;\n\t\t\telse\n\t\t\t\tb += 32;\n\t\t\tb = b >> 6;\n\t\t\tb = clamp_val(b, -31, 31);\n\n\t\t\ttmp_u16 = b43legacy_phy_read(dev, 0x048A) & 0xF000;\n\t\t\ttmp_u16 |= ((u32)b & 0x0000003F);\n\t\t\ttmp_u16 |= (((u32)a & 0x0000003F) << 6);\n\t\t\tb43legacy_phy_write(dev, 0x048A, tmp_u16);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tB43legacy_BUG_ON(1);\n\t}\n}\n\n \nstatic void _stack_save(u32 *_stackptr, size_t *stackidx,\n\t\t\tu8 id, u16 offset, u16 value)\n{\n\tu32 *stackptr = &(_stackptr[*stackidx]);\n\n\tB43legacy_WARN_ON(!((offset & 0xE000) == 0x0000));\n\tB43legacy_WARN_ON(!((id & 0xF8) == 0x00));\n\t*stackptr = offset;\n\t*stackptr |= ((u32)id) << 13;\n\t*stackptr |= ((u32)value) << 16;\n\t(*stackidx)++;\n\tB43legacy_WARN_ON(!(*stackidx < B43legacy_INTERFSTACK_SIZE));\n}\n\nstatic u16 _stack_restore(u32 *stackptr,\n\t\t\t  u8 id, u16 offset)\n{\n\tsize_t i;\n\n\tB43legacy_WARN_ON(!((offset & 0xE000) == 0x0000));\n\tB43legacy_WARN_ON(!((id & 0xF8) == 0x00));\n\tfor (i = 0; i < B43legacy_INTERFSTACK_SIZE; i++, stackptr++) {\n\t\tif ((*stackptr & 0x00001FFF) != offset)\n\t\t\tcontinue;\n\t\tif (((*stackptr & 0x00007000) >> 13) != id)\n\t\t\tcontinue;\n\t\treturn ((*stackptr & 0xFFFF0000) >> 16);\n\t}\n\tB43legacy_BUG_ON(1);\n\n\treturn 0;\n}\n\n#define phy_stacksave(offset)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\t_stack_save(stack, &stackidx, 0x1, (offset),\t\\\n\t\t\t    b43legacy_phy_read(dev, (offset)));\t\\\n\t} while (0)\n#define phy_stackrestore(offset)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\tb43legacy_phy_write(dev, (offset),\t\t\\\n\t\t\t\t    _stack_restore(stack, 0x1,\t\\\n\t\t\t\t    (offset)));\t\t\t\\\n\t} while (0)\n#define radio_stacksave(offset)\t\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\t_stack_save(stack, &stackidx, 0x2, (offset),\t\t\\\n\t\t\t    b43legacy_radio_read16(dev, (offset)));\t\\\n\t} while (0)\n#define radio_stackrestore(offset)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\tb43legacy_radio_write16(dev, (offset),\t\t\t\\\n\t\t\t\t\t_stack_restore(stack, 0x2,\t\\\n\t\t\t\t\t(offset)));\t\t\t\\\n\t} while (0)\n#define ilt_stacksave(offset)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\t_stack_save(stack, &stackidx, 0x3, (offset),\t\\\n\t\t\t    b43legacy_ilt_read(dev, (offset)));\t\\\n\t} while (0)\n#define ilt_stackrestore(offset)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\tb43legacy_ilt_write(dev, (offset),\t\t\\\n\t\t\t\t  _stack_restore(stack, 0x3,\t\\\n\t\t\t\t\t\t (offset)));\t\\\n\t} while (0)\n\nstatic void\nb43legacy_radio_interference_mitigation_enable(struct b43legacy_wldev *dev,\n\t\t\t\t\t       int mode)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 tmp;\n\tu16 flipped;\n\tu32 tmp32;\n\tsize_t stackidx = 0;\n\tu32 *stack = phy->interfstack;\n\n\tswitch (mode) {\n\tcase B43legacy_RADIO_INTERFMODE_NONWLAN:\n\t\tif (phy->rev != 1) {\n\t\t\tb43legacy_phy_write(dev, 0x042B,\n\t\t\t\t\t    b43legacy_phy_read(dev, 0x042B)\n\t\t\t\t\t    | 0x0800);\n\t\t\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS,\n\t\t\t\t\t    b43legacy_phy_read(dev,\n\t\t\t\t\t    B43legacy_PHY_G_CRS) & ~0x4000);\n\t\t\tbreak;\n\t\t}\n\t\tradio_stacksave(0x0078);\n\t\ttmp = (b43legacy_radio_read16(dev, 0x0078) & 0x001E);\n\t\tflipped = flip_4bit(tmp);\n\t\tif (flipped < 10 && flipped >= 8)\n\t\t\tflipped = 7;\n\t\telse if (flipped >= 10)\n\t\t\tflipped -= 3;\n\t\tflipped = flip_4bit(flipped);\n\t\tflipped = (flipped << 1) | 0x0020;\n\t\tb43legacy_radio_write16(dev, 0x0078, flipped);\n\n\t\tb43legacy_calc_nrssi_threshold(dev);\n\n\t\tphy_stacksave(0x0406);\n\t\tb43legacy_phy_write(dev, 0x0406, 0x7E28);\n\n\t\tb43legacy_phy_write(dev, 0x042B,\n\t\t\t\t    b43legacy_phy_read(dev, 0x042B) | 0x0800);\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_RADIO_BITFIELD,\n\t\t\t\t    b43legacy_phy_read(dev,\n\t\t\t\t    B43legacy_PHY_RADIO_BITFIELD) | 0x1000);\n\n\t\tphy_stacksave(0x04A0);\n\t\tb43legacy_phy_write(dev, 0x04A0,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A0) & 0xC0C0)\n\t\t\t\t    | 0x0008);\n\t\tphy_stacksave(0x04A1);\n\t\tb43legacy_phy_write(dev, 0x04A1,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A1) & 0xC0C0)\n\t\t\t\t    | 0x0605);\n\t\tphy_stacksave(0x04A2);\n\t\tb43legacy_phy_write(dev, 0x04A2,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A2) & 0xC0C0)\n\t\t\t\t    | 0x0204);\n\t\tphy_stacksave(0x04A8);\n\t\tb43legacy_phy_write(dev, 0x04A8,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A8) & 0xC0C0)\n\t\t\t\t    | 0x0803);\n\t\tphy_stacksave(0x04AB);\n\t\tb43legacy_phy_write(dev, 0x04AB,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04AB) & 0xC0C0)\n\t\t\t\t    | 0x0605);\n\n\t\tphy_stacksave(0x04A7);\n\t\tb43legacy_phy_write(dev, 0x04A7, 0x0002);\n\t\tphy_stacksave(0x04A3);\n\t\tb43legacy_phy_write(dev, 0x04A3, 0x287A);\n\t\tphy_stacksave(0x04A9);\n\t\tb43legacy_phy_write(dev, 0x04A9, 0x2027);\n\t\tphy_stacksave(0x0493);\n\t\tb43legacy_phy_write(dev, 0x0493, 0x32F5);\n\t\tphy_stacksave(0x04AA);\n\t\tb43legacy_phy_write(dev, 0x04AA, 0x2027);\n\t\tphy_stacksave(0x04AC);\n\t\tb43legacy_phy_write(dev, 0x04AC, 0x32F5);\n\t\tbreak;\n\tcase B43legacy_RADIO_INTERFMODE_MANUALWLAN:\n\t\tif (b43legacy_phy_read(dev, 0x0033) & 0x0800)\n\t\t\tbreak;\n\n\t\tphy->aci_enable = true;\n\n\t\tphy_stacksave(B43legacy_PHY_RADIO_BITFIELD);\n\t\tphy_stacksave(B43legacy_PHY_G_CRS);\n\t\tif (phy->rev < 2)\n\t\t\tphy_stacksave(0x0406);\n\t\telse {\n\t\t\tphy_stacksave(0x04C0);\n\t\t\tphy_stacksave(0x04C1);\n\t\t}\n\t\tphy_stacksave(0x0033);\n\t\tphy_stacksave(0x04A7);\n\t\tphy_stacksave(0x04A3);\n\t\tphy_stacksave(0x04A9);\n\t\tphy_stacksave(0x04AA);\n\t\tphy_stacksave(0x04AC);\n\t\tphy_stacksave(0x0493);\n\t\tphy_stacksave(0x04A1);\n\t\tphy_stacksave(0x04A0);\n\t\tphy_stacksave(0x04A2);\n\t\tphy_stacksave(0x048A);\n\t\tphy_stacksave(0x04A8);\n\t\tphy_stacksave(0x04AB);\n\t\tif (phy->rev == 2) {\n\t\t\tphy_stacksave(0x04AD);\n\t\t\tphy_stacksave(0x04AE);\n\t\t} else if (phy->rev >= 3) {\n\t\t\tphy_stacksave(0x04AD);\n\t\t\tphy_stacksave(0x0415);\n\t\t\tphy_stacksave(0x0416);\n\t\t\tphy_stacksave(0x0417);\n\t\t\tilt_stacksave(0x1A00 + 0x2);\n\t\t\tilt_stacksave(0x1A00 + 0x3);\n\t\t}\n\t\tphy_stacksave(0x042B);\n\t\tphy_stacksave(0x048C);\n\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_RADIO_BITFIELD,\n\t\t\t\t    b43legacy_phy_read(dev,\n\t\t\t\t    B43legacy_PHY_RADIO_BITFIELD) & ~0x1000);\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS,\n\t\t\t\t    (b43legacy_phy_read(dev,\n\t\t\t\t    B43legacy_PHY_G_CRS)\n\t\t\t\t    & 0xFFFC) | 0x0002);\n\n\t\tb43legacy_phy_write(dev, 0x0033, 0x0800);\n\t\tb43legacy_phy_write(dev, 0x04A3, 0x2027);\n\t\tb43legacy_phy_write(dev, 0x04A9, 0x1CA8);\n\t\tb43legacy_phy_write(dev, 0x0493, 0x287A);\n\t\tb43legacy_phy_write(dev, 0x04AA, 0x1CA8);\n\t\tb43legacy_phy_write(dev, 0x04AC, 0x287A);\n\n\t\tb43legacy_phy_write(dev, 0x04A0,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A0)\n\t\t\t\t    & 0xFFC0) | 0x001A);\n\t\tb43legacy_phy_write(dev, 0x04A7, 0x000D);\n\n\t\tif (phy->rev < 2)\n\t\t\tb43legacy_phy_write(dev, 0x0406, 0xFF0D);\n\t\telse if (phy->rev == 2) {\n\t\t\tb43legacy_phy_write(dev, 0x04C0, 0xFFFF);\n\t\t\tb43legacy_phy_write(dev, 0x04C1, 0x00A9);\n\t\t} else {\n\t\t\tb43legacy_phy_write(dev, 0x04C0, 0x00C1);\n\t\t\tb43legacy_phy_write(dev, 0x04C1, 0x0059);\n\t\t}\n\n\t\tb43legacy_phy_write(dev, 0x04A1,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A1)\n\t\t\t\t    & 0xC0FF) | 0x1800);\n\t\tb43legacy_phy_write(dev, 0x04A1,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A1)\n\t\t\t\t    & 0xFFC0) | 0x0015);\n\t\tb43legacy_phy_write(dev, 0x04A8,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A8)\n\t\t\t\t    & 0xCFFF) | 0x1000);\n\t\tb43legacy_phy_write(dev, 0x04A8,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A8)\n\t\t\t\t    & 0xF0FF) | 0x0A00);\n\t\tb43legacy_phy_write(dev, 0x04AB,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04AB)\n\t\t\t\t    & 0xCFFF) | 0x1000);\n\t\tb43legacy_phy_write(dev, 0x04AB,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04AB)\n\t\t\t\t    & 0xF0FF) | 0x0800);\n\t\tb43legacy_phy_write(dev, 0x04AB,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04AB)\n\t\t\t\t    & 0xFFCF) | 0x0010);\n\t\tb43legacy_phy_write(dev, 0x04AB,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04AB)\n\t\t\t\t    & 0xFFF0) | 0x0005);\n\t\tb43legacy_phy_write(dev, 0x04A8,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A8)\n\t\t\t\t    & 0xFFCF) | 0x0010);\n\t\tb43legacy_phy_write(dev, 0x04A8,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A8)\n\t\t\t\t    & 0xFFF0) | 0x0006);\n\t\tb43legacy_phy_write(dev, 0x04A2,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A2)\n\t\t\t\t    & 0xF0FF) | 0x0800);\n\t\tb43legacy_phy_write(dev, 0x04A0,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A0)\n\t\t\t\t    & 0xF0FF) | 0x0500);\n\t\tb43legacy_phy_write(dev, 0x04A2,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A2)\n\t\t\t\t    & 0xFFF0) | 0x000B);\n\n\t\tif (phy->rev >= 3) {\n\t\t\tb43legacy_phy_write(dev, 0x048A,\n\t\t\t\t\t    b43legacy_phy_read(dev, 0x048A)\n\t\t\t\t\t    & ~0x8000);\n\t\t\tb43legacy_phy_write(dev, 0x0415,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0415)\n\t\t\t\t\t    & 0x8000) | 0x36D8);\n\t\t\tb43legacy_phy_write(dev, 0x0416,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0416)\n\t\t\t\t\t    & 0x8000) | 0x36D8);\n\t\t\tb43legacy_phy_write(dev, 0x0417,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0417)\n\t\t\t\t\t    & 0xFE00) | 0x016D);\n\t\t} else {\n\t\t\tb43legacy_phy_write(dev, 0x048A,\n\t\t\t\t\t    b43legacy_phy_read(dev, 0x048A)\n\t\t\t\t\t    | 0x1000);\n\t\t\tb43legacy_phy_write(dev, 0x048A,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x048A)\n\t\t\t\t\t    & 0x9FFF) | 0x2000);\n\t\t\ttmp32 = b43legacy_shm_read32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t\t    B43legacy_UCODEFLAGS_OFFSET);\n\t\t\tif (!(tmp32 & 0x800)) {\n\t\t\t\ttmp32 |= 0x800;\n\t\t\t\tb43legacy_shm_write32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t\t    B43legacy_UCODEFLAGS_OFFSET,\n\t\t\t\t\t    tmp32);\n\t\t\t}\n\t\t}\n\t\tif (phy->rev >= 2)\n\t\t\tb43legacy_phy_write(dev, 0x042B,\n\t\t\t\t\t    b43legacy_phy_read(dev, 0x042B)\n\t\t\t\t\t    | 0x0800);\n\t\tb43legacy_phy_write(dev, 0x048C,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x048C)\n\t\t\t\t    & 0xF0FF) | 0x0200);\n\t\tif (phy->rev == 2) {\n\t\t\tb43legacy_phy_write(dev, 0x04AE,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x04AE)\n\t\t\t\t\t    & 0xFF00) | 0x007F);\n\t\t\tb43legacy_phy_write(dev, 0x04AD,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x04AD)\n\t\t\t\t\t    & 0x00FF) | 0x1300);\n\t\t} else if (phy->rev >= 6) {\n\t\t\tb43legacy_ilt_write(dev, 0x1A00 + 0x3, 0x007F);\n\t\t\tb43legacy_ilt_write(dev, 0x1A00 + 0x2, 0x007F);\n\t\t\tb43legacy_phy_write(dev, 0x04AD,\n\t\t\t\t\t    b43legacy_phy_read(dev, 0x04AD)\n\t\t\t\t\t    & 0x00FF);\n\t\t}\n\t\tb43legacy_calc_nrssi_slope(dev);\n\t\tbreak;\n\tdefault:\n\t\tB43legacy_BUG_ON(1);\n\t}\n}\n\nstatic void\nb43legacy_radio_interference_mitigation_disable(struct b43legacy_wldev *dev,\n\t\t\t\t\t\tint mode)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu32 tmp32;\n\tu32 *stack = phy->interfstack;\n\n\tswitch (mode) {\n\tcase B43legacy_RADIO_INTERFMODE_NONWLAN:\n\t\tif (phy->rev != 1) {\n\t\t\tb43legacy_phy_write(dev, 0x042B,\n\t\t\t\t\t    b43legacy_phy_read(dev, 0x042B)\n\t\t\t\t\t    & ~0x0800);\n\t\t\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS,\n\t\t\t\t\t    b43legacy_phy_read(dev,\n\t\t\t\t\t    B43legacy_PHY_G_CRS) | 0x4000);\n\t\t\tbreak;\n\t\t}\n\t\tphy_stackrestore(0x0078);\n\t\tb43legacy_calc_nrssi_threshold(dev);\n\t\tphy_stackrestore(0x0406);\n\t\tb43legacy_phy_write(dev, 0x042B,\n\t\t\t\t    b43legacy_phy_read(dev, 0x042B) & ~0x0800);\n\t\tif (!dev->bad_frames_preempt)\n\t\t\tb43legacy_phy_write(dev, B43legacy_PHY_RADIO_BITFIELD,\n\t\t\t\t\t    b43legacy_phy_read(dev,\n\t\t\t\t\t    B43legacy_PHY_RADIO_BITFIELD)\n\t\t\t\t\t    & ~(1 << 11));\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS,\n\t\t\t\t    b43legacy_phy_read(dev, B43legacy_PHY_G_CRS)\n\t\t\t\t    | 0x4000);\n\t\tphy_stackrestore(0x04A0);\n\t\tphy_stackrestore(0x04A1);\n\t\tphy_stackrestore(0x04A2);\n\t\tphy_stackrestore(0x04A8);\n\t\tphy_stackrestore(0x04AB);\n\t\tphy_stackrestore(0x04A7);\n\t\tphy_stackrestore(0x04A3);\n\t\tphy_stackrestore(0x04A9);\n\t\tphy_stackrestore(0x0493);\n\t\tphy_stackrestore(0x04AA);\n\t\tphy_stackrestore(0x04AC);\n\t\tbreak;\n\tcase B43legacy_RADIO_INTERFMODE_MANUALWLAN:\n\t\tif (!(b43legacy_phy_read(dev, 0x0033) & 0x0800))\n\t\t\tbreak;\n\n\t\tphy->aci_enable = false;\n\n\t\tphy_stackrestore(B43legacy_PHY_RADIO_BITFIELD);\n\t\tphy_stackrestore(B43legacy_PHY_G_CRS);\n\t\tphy_stackrestore(0x0033);\n\t\tphy_stackrestore(0x04A3);\n\t\tphy_stackrestore(0x04A9);\n\t\tphy_stackrestore(0x0493);\n\t\tphy_stackrestore(0x04AA);\n\t\tphy_stackrestore(0x04AC);\n\t\tphy_stackrestore(0x04A0);\n\t\tphy_stackrestore(0x04A7);\n\t\tif (phy->rev >= 2) {\n\t\t\tphy_stackrestore(0x04C0);\n\t\t\tphy_stackrestore(0x04C1);\n\t\t} else\n\t\t\tphy_stackrestore(0x0406);\n\t\tphy_stackrestore(0x04A1);\n\t\tphy_stackrestore(0x04AB);\n\t\tphy_stackrestore(0x04A8);\n\t\tif (phy->rev == 2) {\n\t\t\tphy_stackrestore(0x04AD);\n\t\t\tphy_stackrestore(0x04AE);\n\t\t} else if (phy->rev >= 3) {\n\t\t\tphy_stackrestore(0x04AD);\n\t\t\tphy_stackrestore(0x0415);\n\t\t\tphy_stackrestore(0x0416);\n\t\t\tphy_stackrestore(0x0417);\n\t\t\tilt_stackrestore(0x1A00 + 0x2);\n\t\t\tilt_stackrestore(0x1A00 + 0x3);\n\t\t}\n\t\tphy_stackrestore(0x04A2);\n\t\tphy_stackrestore(0x04A8);\n\t\tphy_stackrestore(0x042B);\n\t\tphy_stackrestore(0x048C);\n\t\ttmp32 = b43legacy_shm_read32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t\t     B43legacy_UCODEFLAGS_OFFSET);\n\t\tif (tmp32 & 0x800) {\n\t\t\ttmp32 &= ~0x800;\n\t\t\tb43legacy_shm_write32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t\t      B43legacy_UCODEFLAGS_OFFSET,\n\t\t\t\t\t      tmp32);\n\t\t}\n\t\tb43legacy_calc_nrssi_slope(dev);\n\t\tbreak;\n\tdefault:\n\t\tB43legacy_BUG_ON(1);\n\t}\n}\n\n#undef phy_stacksave\n#undef phy_stackrestore\n#undef radio_stacksave\n#undef radio_stackrestore\n#undef ilt_stacksave\n#undef ilt_stackrestore\n\nint b43legacy_radio_set_interference_mitigation(struct b43legacy_wldev *dev,\n\t\t\t\t\t\tint mode)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tint currentmode;\n\n\tif ((phy->type != B43legacy_PHYTYPE_G) ||\n\t    (phy->rev == 0) || (!phy->gmode))\n\t\treturn -ENODEV;\n\n\tphy->aci_wlan_automatic = false;\n\tswitch (mode) {\n\tcase B43legacy_RADIO_INTERFMODE_AUTOWLAN:\n\t\tphy->aci_wlan_automatic = true;\n\t\tif (phy->aci_enable)\n\t\t\tmode = B43legacy_RADIO_INTERFMODE_MANUALWLAN;\n\t\telse\n\t\t\tmode = B43legacy_RADIO_INTERFMODE_NONE;\n\t\tbreak;\n\tcase B43legacy_RADIO_INTERFMODE_NONE:\n\tcase B43legacy_RADIO_INTERFMODE_NONWLAN:\n\tcase B43legacy_RADIO_INTERFMODE_MANUALWLAN:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tcurrentmode = phy->interfmode;\n\tif (currentmode == mode)\n\t\treturn 0;\n\tif (currentmode != B43legacy_RADIO_INTERFMODE_NONE)\n\t\tb43legacy_radio_interference_mitigation_disable(dev,\n\t\t\t\t\t\t\t\tcurrentmode);\n\n\tif (mode == B43legacy_RADIO_INTERFMODE_NONE) {\n\t\tphy->aci_enable = false;\n\t\tphy->aci_hw_rssi = false;\n\t} else\n\t\tb43legacy_radio_interference_mitigation_enable(dev, mode);\n\tphy->interfmode = mode;\n\n\treturn 0;\n}\n\nu16 b43legacy_radio_calibrationvalue(struct b43legacy_wldev *dev)\n{\n\tu16 reg;\n\tu16 index;\n\tu16 ret;\n\n\treg = b43legacy_radio_read16(dev, 0x0060);\n\tindex = (reg & 0x001E) >> 1;\n\tret = rcc_table[index] << 1;\n\tret |= (reg & 0x0001);\n\tret |= 0x0020;\n\n\treturn ret;\n}\n\n#define LPD(L, P, D)    (((L) << 2) | ((P) << 1) | ((D) << 0))\nstatic u16 b43legacy_get_812_value(struct b43legacy_wldev *dev, u8 lpd)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 loop_or = 0;\n\tu16 adj_loopback_gain = phy->loopback_gain[0];\n\tu8 loop;\n\tu16 extern_lna_control;\n\n\tif (!phy->gmode)\n\t\treturn 0;\n\tif (!has_loopback_gain(phy)) {\n\t\tif (phy->rev < 7 || !(dev->dev->bus->sprom.boardflags_lo\n\t\t    & B43legacy_BFL_EXTLNA)) {\n\t\t\tswitch (lpd) {\n\t\t\tcase LPD(0, 1, 1):\n\t\t\t\treturn 0x0FB2;\n\t\t\tcase LPD(0, 0, 1):\n\t\t\t\treturn 0x00B2;\n\t\t\tcase LPD(1, 0, 1):\n\t\t\t\treturn 0x30B2;\n\t\t\tcase LPD(1, 0, 0):\n\t\t\t\treturn 0x30B3;\n\t\t\tdefault:\n\t\t\t\tB43legacy_BUG_ON(1);\n\t\t\t}\n\t\t} else {\n\t\t\tswitch (lpd) {\n\t\t\tcase LPD(0, 1, 1):\n\t\t\t\treturn 0x8FB2;\n\t\t\tcase LPD(0, 0, 1):\n\t\t\t\treturn 0x80B2;\n\t\t\tcase LPD(1, 0, 1):\n\t\t\t\treturn 0x20B2;\n\t\t\tcase LPD(1, 0, 0):\n\t\t\t\treturn 0x20B3;\n\t\t\tdefault:\n\t\t\t\tB43legacy_BUG_ON(1);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tif (phy->radio_rev == 8)\n\t\t\tadj_loopback_gain += 0x003E;\n\t\telse\n\t\t\tadj_loopback_gain += 0x0026;\n\t\tif (adj_loopback_gain >= 0x46) {\n\t\t\tadj_loopback_gain -= 0x46;\n\t\t\textern_lna_control = 0x3000;\n\t\t} else if (adj_loopback_gain >= 0x3A) {\n\t\t\tadj_loopback_gain -= 0x3A;\n\t\t\textern_lna_control = 0x2000;\n\t\t} else if (adj_loopback_gain >= 0x2E) {\n\t\t\tadj_loopback_gain -= 0x2E;\n\t\t\textern_lna_control = 0x1000;\n\t\t} else {\n\t\t\tadj_loopback_gain -= 0x10;\n\t\t\textern_lna_control = 0x0000;\n\t\t}\n\t\tfor (loop = 0; loop < 16; loop++) {\n\t\t\tu16 tmp = adj_loopback_gain - 6 * loop;\n\t\t\tif (tmp < 6)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tloop_or = (loop << 8) | extern_lna_control;\n\t\tif (phy->rev >= 7 && dev->dev->bus->sprom.boardflags_lo\n\t\t    & B43legacy_BFL_EXTLNA) {\n\t\t\tif (extern_lna_control)\n\t\t\t\tloop_or |= 0x8000;\n\t\t\tswitch (lpd) {\n\t\t\tcase LPD(0, 1, 1):\n\t\t\t\treturn 0x8F92;\n\t\t\tcase LPD(0, 0, 1):\n\t\t\t\treturn (0x8092 | loop_or);\n\t\t\tcase LPD(1, 0, 1):\n\t\t\t\treturn (0x2092 | loop_or);\n\t\t\tcase LPD(1, 0, 0):\n\t\t\t\treturn (0x2093 | loop_or);\n\t\t\tdefault:\n\t\t\t\tB43legacy_BUG_ON(1);\n\t\t\t}\n\t\t} else {\n\t\t\tswitch (lpd) {\n\t\t\tcase LPD(0, 1, 1):\n\t\t\t\treturn 0x0F92;\n\t\t\tcase LPD(0, 0, 1):\n\t\t\tcase LPD(1, 0, 1):\n\t\t\t\treturn (0x0092 | loop_or);\n\t\t\tcase LPD(1, 0, 0):\n\t\t\t\treturn (0x0093 | loop_or);\n\t\t\tdefault:\n\t\t\t\tB43legacy_BUG_ON(1);\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n}\n\nu16 b43legacy_radio_init2050(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 backup[21] = { 0 };\n\tu16 ret;\n\tu16 i;\n\tu16 j;\n\tu32 tmp1 = 0;\n\tu32 tmp2 = 0;\n\n\tbackup[0] = b43legacy_radio_read16(dev, 0x0043);\n\tbackup[14] = b43legacy_radio_read16(dev, 0x0051);\n\tbackup[15] = b43legacy_radio_read16(dev, 0x0052);\n\tbackup[1] = b43legacy_phy_read(dev, 0x0015);\n\tbackup[16] = b43legacy_phy_read(dev, 0x005A);\n\tbackup[17] = b43legacy_phy_read(dev, 0x0059);\n\tbackup[18] = b43legacy_phy_read(dev, 0x0058);\n\tif (phy->type == B43legacy_PHYTYPE_B) {\n\t\tbackup[2] = b43legacy_phy_read(dev, 0x0030);\n\t\tbackup[3] = b43legacy_read16(dev, 0x03EC);\n\t\tb43legacy_phy_write(dev, 0x0030, 0x00FF);\n\t\tb43legacy_write16(dev, 0x03EC, 0x3F3F);\n\t} else {\n\t\tif (phy->gmode) {\n\t\t\tbackup[4] = b43legacy_phy_read(dev, 0x0811);\n\t\t\tbackup[5] = b43legacy_phy_read(dev, 0x0812);\n\t\t\tbackup[6] = b43legacy_phy_read(dev, 0x0814);\n\t\t\tbackup[7] = b43legacy_phy_read(dev, 0x0815);\n\t\t\tbackup[8] = b43legacy_phy_read(dev,\n\t\t\t\t\t\t       B43legacy_PHY_G_CRS);\n\t\t\tbackup[9] = b43legacy_phy_read(dev, 0x0802);\n\t\t\tb43legacy_phy_write(dev, 0x0814,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0814)\n\t\t\t\t\t    | 0x0003));\n\t\t\tb43legacy_phy_write(dev, 0x0815,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0815)\n\t\t\t\t\t    & 0xFFFC));\n\t\t\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS,\n\t\t\t\t\t    (b43legacy_phy_read(dev,\n\t\t\t\t\t    B43legacy_PHY_G_CRS) & 0x7FFF));\n\t\t\tb43legacy_phy_write(dev, 0x0802,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0802)\n\t\t\t\t\t    & 0xFFFC));\n\t\t\tif (phy->rev > 1) {  \n\t\t\t\tbackup[19] = b43legacy_phy_read(dev, 0x080F);\n\t\t\t\tbackup[20] = b43legacy_phy_read(dev, 0x0810);\n\t\t\t\tif (phy->rev >= 3)\n\t\t\t\t\tb43legacy_phy_write(dev, 0x080F,\n\t\t\t\t\t\t\t    0xC020);\n\t\t\t\telse\n\t\t\t\t\tb43legacy_phy_write(dev, 0x080F,\n\t\t\t\t\t\t\t    0x8020);\n\t\t\t\tb43legacy_phy_write(dev, 0x0810, 0x0000);\n\t\t\t}\n\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t\t    LPD(0, 1, 1)));\n\t\t\tif (phy->rev < 7 ||\n\t\t\t    !(dev->dev->bus->sprom.boardflags_lo\n\t\t\t    & B43legacy_BFL_EXTLNA))\n\t\t\t\tb43legacy_phy_write(dev, 0x0811, 0x01B3);\n\t\t\telse\n\t\t\t\tb43legacy_phy_write(dev, 0x0811, 0x09B3);\n\t\t}\n\t}\n\tb43legacy_write16(dev, B43legacy_MMIO_PHY_RADIO,\n\t\t\t(b43legacy_read16(dev, B43legacy_MMIO_PHY_RADIO)\n\t\t\t\t\t  | 0x8000));\n\tbackup[10] = b43legacy_phy_read(dev, 0x0035);\n\tb43legacy_phy_write(dev, 0x0035,\n\t\t\t    (b43legacy_phy_read(dev, 0x0035) & 0xFF7F));\n\tbackup[11] = b43legacy_read16(dev, 0x03E6);\n\tbackup[12] = b43legacy_read16(dev, B43legacy_MMIO_CHANNEL_EXT);\n\n\t \n\tif (phy->analog == 0)\n\t\tb43legacy_write16(dev, 0x03E6, 0x0122);\n\telse {\n\t\tif (phy->analog >= 2)\n\t\t\tb43legacy_phy_write(dev, 0x0003,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0003)\n\t\t\t\t\t    & 0xFFBF) | 0x0040);\n\t\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL_EXT,\n\t\t\t\t  (b43legacy_read16(dev,\n\t\t\t\t  B43legacy_MMIO_CHANNEL_EXT) | 0x2000));\n\t}\n\n\tret = b43legacy_radio_calibrationvalue(dev);\n\n\tif (phy->type == B43legacy_PHYTYPE_B)\n\t\tb43legacy_radio_write16(dev, 0x0078, 0x0026);\n\n\tif (phy->gmode)\n\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t    LPD(0, 1, 1)));\n\tb43legacy_phy_write(dev, 0x0015, 0xBFAF);\n\tb43legacy_phy_write(dev, 0x002B, 0x1403);\n\tif (phy->gmode)\n\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t    LPD(0, 0, 1)));\n\tb43legacy_phy_write(dev, 0x0015, 0xBFA0);\n\tb43legacy_radio_write16(dev, 0x0051,\n\t\t\t\t(b43legacy_radio_read16(dev, 0x0051)\n\t\t\t\t| 0x0004));\n\tif (phy->radio_rev == 8)\n\t\tb43legacy_radio_write16(dev, 0x0043, 0x001F);\n\telse {\n\t\tb43legacy_radio_write16(dev, 0x0052, 0x0000);\n\t\tb43legacy_radio_write16(dev, 0x0043,\n\t\t\t\t\t(b43legacy_radio_read16(dev, 0x0043)\n\t\t\t\t\t& 0xFFF0) | 0x0009);\n\t}\n\tb43legacy_phy_write(dev, 0x0058, 0x0000);\n\n\tfor (i = 0; i < 16; i++) {\n\t\tb43legacy_phy_write(dev, 0x005A, 0x0480);\n\t\tb43legacy_phy_write(dev, 0x0059, 0xC810);\n\t\tb43legacy_phy_write(dev, 0x0058, 0x000D);\n\t\tif (phy->gmode)\n\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t\t    LPD(1, 0, 1)));\n\t\tb43legacy_phy_write(dev, 0x0015, 0xAFB0);\n\t\tudelay(10);\n\t\tif (phy->gmode)\n\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t\t    LPD(1, 0, 1)));\n\t\tb43legacy_phy_write(dev, 0x0015, 0xEFB0);\n\t\tudelay(10);\n\t\tif (phy->gmode)\n\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t\t    LPD(1, 0, 0)));\n\t\tb43legacy_phy_write(dev, 0x0015, 0xFFF0);\n\t\tudelay(20);\n\t\ttmp1 += b43legacy_phy_read(dev, 0x002D);\n\t\tb43legacy_phy_write(dev, 0x0058, 0x0000);\n\t\tif (phy->gmode)\n\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t\t    LPD(1, 0, 1)));\n\t\tb43legacy_phy_write(dev, 0x0015, 0xAFB0);\n\t}\n\n\ttmp1++;\n\ttmp1 >>= 9;\n\tudelay(10);\n\tb43legacy_phy_write(dev, 0x0058, 0x0000);\n\n\tfor (i = 0; i < 16; i++) {\n\t\tb43legacy_radio_write16(dev, 0x0078, (flip_4bit(i) << 1)\n\t\t\t\t\t| 0x0020);\n\t\tbackup[13] = b43legacy_radio_read16(dev, 0x0078);\n\t\tudelay(10);\n\t\tfor (j = 0; j < 16; j++) {\n\t\t\tb43legacy_phy_write(dev, 0x005A, 0x0D80);\n\t\t\tb43legacy_phy_write(dev, 0x0059, 0xC810);\n\t\t\tb43legacy_phy_write(dev, 0x0058, 0x000D);\n\t\t\tif (phy->gmode)\n\t\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t\t\t    LPD(1, 0, 1)));\n\t\t\tb43legacy_phy_write(dev, 0x0015, 0xAFB0);\n\t\t\tudelay(10);\n\t\t\tif (phy->gmode)\n\t\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t\t\t    LPD(1, 0, 1)));\n\t\t\tb43legacy_phy_write(dev, 0x0015, 0xEFB0);\n\t\t\tudelay(10);\n\t\t\tif (phy->gmode)\n\t\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t\t\t    LPD(1, 0, 0)));\n\t\t\tb43legacy_phy_write(dev, 0x0015, 0xFFF0);\n\t\t\tudelay(10);\n\t\t\ttmp2 += b43legacy_phy_read(dev, 0x002D);\n\t\t\tb43legacy_phy_write(dev, 0x0058, 0x0000);\n\t\t\tif (phy->gmode)\n\t\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t\t    b43legacy_get_812_value(dev,\n\t\t\t\t\t\t    LPD(1, 0, 1)));\n\t\t\tb43legacy_phy_write(dev, 0x0015, 0xAFB0);\n\t\t}\n\t\ttmp2++;\n\t\ttmp2 >>= 8;\n\t\tif (tmp1 < tmp2)\n\t\t\tbreak;\n\t}\n\n\t \n\tb43legacy_phy_write(dev, 0x0015, backup[1]);\n\tb43legacy_radio_write16(dev, 0x0051, backup[14]);\n\tb43legacy_radio_write16(dev, 0x0052, backup[15]);\n\tb43legacy_radio_write16(dev, 0x0043, backup[0]);\n\tb43legacy_phy_write(dev, 0x005A, backup[16]);\n\tb43legacy_phy_write(dev, 0x0059, backup[17]);\n\tb43legacy_phy_write(dev, 0x0058, backup[18]);\n\tb43legacy_write16(dev, 0x03E6, backup[11]);\n\tif (phy->analog != 0)\n\t\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL_EXT, backup[12]);\n\tb43legacy_phy_write(dev, 0x0035, backup[10]);\n\tb43legacy_radio_selectchannel(dev, phy->channel, 1);\n\tif (phy->type == B43legacy_PHYTYPE_B) {\n\t\tb43legacy_phy_write(dev, 0x0030, backup[2]);\n\t\tb43legacy_write16(dev, 0x03EC, backup[3]);\n\t} else {\n\t\tif (phy->gmode) {\n\t\t\tb43legacy_write16(dev, B43legacy_MMIO_PHY_RADIO,\n\t\t\t\t\t  (b43legacy_read16(dev,\n\t\t\t\t\t  B43legacy_MMIO_PHY_RADIO) & 0x7FFF));\n\t\t\tb43legacy_phy_write(dev, 0x0811, backup[4]);\n\t\t\tb43legacy_phy_write(dev, 0x0812, backup[5]);\n\t\t\tb43legacy_phy_write(dev, 0x0814, backup[6]);\n\t\t\tb43legacy_phy_write(dev, 0x0815, backup[7]);\n\t\t\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS,\n\t\t\t\t\t    backup[8]);\n\t\t\tb43legacy_phy_write(dev, 0x0802, backup[9]);\n\t\t\tif (phy->rev > 1) {\n\t\t\t\tb43legacy_phy_write(dev, 0x080F, backup[19]);\n\t\t\t\tb43legacy_phy_write(dev, 0x0810, backup[20]);\n\t\t\t}\n\t\t}\n\t}\n\tif (i >= 15)\n\t\tret = backup[13];\n\n\treturn ret;\n}\n\nint b43legacy_radio_selectchannel(struct b43legacy_wldev *dev,\n\t\t\t\t  u8 channel,\n\t\t\t\t  int synthetic_pu_workaround)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\tif (channel == 0xFF) {\n\t\tswitch (phy->type) {\n\t\tcase B43legacy_PHYTYPE_B:\n\t\tcase B43legacy_PHYTYPE_G:\n\t\t\tchannel = B43legacy_RADIO_DEFAULT_CHANNEL_BG;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tB43legacy_WARN_ON(1);\n\t\t}\n\t}\n\n \n\tif (synthetic_pu_workaround)\n\t\tb43legacy_synth_pu_workaround(dev, channel);\n\n\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL,\n\t\t\t  channel2freq_bg(channel));\n\n\tif (channel == 14) {\n\t\tif (dev->dev->bus->sprom.country_code == 5)    \n\t\t\tb43legacy_shm_write32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t\t      B43legacy_UCODEFLAGS_OFFSET,\n\t\t\t\t\t      b43legacy_shm_read32(dev,\n\t\t\t\t\t      B43legacy_SHM_SHARED,\n\t\t\t\t\t      B43legacy_UCODEFLAGS_OFFSET)\n\t\t\t\t\t      & ~(1 << 7));\n\t\telse\n\t\t\tb43legacy_shm_write32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t\t      B43legacy_UCODEFLAGS_OFFSET,\n\t\t\t\t\t      b43legacy_shm_read32(dev,\n\t\t\t\t\t      B43legacy_SHM_SHARED,\n\t\t\t\t\t      B43legacy_UCODEFLAGS_OFFSET)\n\t\t\t\t\t      | (1 << 7));\n\t\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL_EXT,\n\t\t\t\t  b43legacy_read16(dev,\n\t\t\t\t  B43legacy_MMIO_CHANNEL_EXT) | (1 << 11));\n\t} else\n\t\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL_EXT,\n\t\t\t\t  b43legacy_read16(dev,\n\t\t\t\t  B43legacy_MMIO_CHANNEL_EXT) & 0xF7BF);\n\n\tphy->channel = channel;\n\t \n\tmsleep(8);\n\n\treturn 0;\n}\n\nvoid b43legacy_radio_set_txantenna(struct b43legacy_wldev *dev, u32 val)\n{\n\tu16 tmp;\n\n\tval <<= 8;\n\ttmp = b43legacy_shm_read16(dev, B43legacy_SHM_SHARED, 0x0022) & 0xFCFF;\n\tb43legacy_shm_write16(dev, B43legacy_SHM_SHARED, 0x0022, tmp | val);\n\ttmp = b43legacy_shm_read16(dev, B43legacy_SHM_SHARED, 0x03A8) & 0xFCFF;\n\tb43legacy_shm_write16(dev, B43legacy_SHM_SHARED, 0x03A8, tmp | val);\n\ttmp = b43legacy_shm_read16(dev, B43legacy_SHM_SHARED, 0x0054) & 0xFCFF;\n\tb43legacy_shm_write16(dev, B43legacy_SHM_SHARED, 0x0054, tmp | val);\n}\n\n \n}\n\nvoid b43legacy_radio_set_txpower_bg(struct b43legacy_wldev *dev,\n\t\t\t\t    u16 baseband_attenuation,\n\t\t\t\t    u16 radio_attenuation,\n\t\t\t\t    u16 txpower)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\tif (baseband_attenuation == 0xFFFF)\n\t\tbaseband_attenuation = phy->bbatt;\n\tif (radio_attenuation == 0xFFFF)\n\t\tradio_attenuation = phy->rfatt;\n\tif (txpower == 0xFFFF)\n\t\ttxpower = phy->txctl1;\n\tphy->bbatt = baseband_attenuation;\n\tphy->rfatt = radio_attenuation;\n\tphy->txctl1 = txpower;\n\n\tB43legacy_WARN_ON(baseband_attenuation > 11);\n\tif (phy->radio_rev < 6)\n\t\tB43legacy_WARN_ON(radio_attenuation > 9);\n\telse\n\t\tB43legacy_WARN_ON(radio_attenuation > 31);\n\tB43legacy_WARN_ON(txpower > 7);\n\n\tb43legacy_phy_set_baseband_attenuation(dev, baseband_attenuation);\n\tb43legacy_radio_write16(dev, 0x0043, radio_attenuation);\n\tb43legacy_shm_write16(dev, B43legacy_SHM_SHARED, 0x0064,\n\t\t\t      radio_attenuation);\n\tif (phy->radio_ver == 0x2050)\n\t\tb43legacy_radio_write16(dev, 0x0052,\n\t\t\t\t\t(b43legacy_radio_read16(dev, 0x0052)\n\t\t\t\t\t& ~0x0070) | ((txpower << 4) & 0x0070));\n\t \n\tif (phy->type == B43legacy_PHYTYPE_G)\n\t\tb43legacy_phy_lo_adjust(dev, 0);\n}\n\nu16 b43legacy_default_baseband_attenuation(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\tif (phy->radio_ver == 0x2050 && phy->radio_rev < 6)\n\t\treturn 0;\n\treturn 2;\n}\n\nu16 b43legacy_default_radio_attenuation(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 att = 0xFFFF;\n\n\tswitch (phy->radio_ver) {\n\tcase 0x2053:\n\t\tswitch (phy->radio_rev) {\n\t\tcase 1:\n\t\t\tatt = 6;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase 0x2050:\n\t\tswitch (phy->radio_rev) {\n\t\tcase 0:\n\t\t\tatt = 5;\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tif (phy->type == B43legacy_PHYTYPE_G) {\n\t\t\t\tif (is_bcm_board_vendor(dev) &&\n\t\t\t\t    dev->dev->bus->boardinfo.type == 0x421 &&\n\t\t\t\t    dev->dev->bus->sprom.board_rev >= 30)\n\t\t\t\t\tatt = 3;\n\t\t\t\telse if (is_bcm_board_vendor(dev) &&\n\t\t\t\t\t dev->dev->bus->boardinfo.type == 0x416)\n\t\t\t\t\tatt = 3;\n\t\t\t\telse\n\t\t\t\t\tatt = 1;\n\t\t\t} else {\n\t\t\t\tif (is_bcm_board_vendor(dev) &&\n\t\t\t\t    dev->dev->bus->boardinfo.type == 0x421 &&\n\t\t\t\t    dev->dev->bus->sprom.board_rev >= 30)\n\t\t\t\t\tatt = 7;\n\t\t\t\telse\n\t\t\t\t\tatt = 6;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tif (phy->type == B43legacy_PHYTYPE_G) {\n\t\t\t\tif (is_bcm_board_vendor(dev) &&\n\t\t\t\t    dev->dev->bus->boardinfo.type == 0x421 &&\n\t\t\t\t    dev->dev->bus->sprom.board_rev >= 30)\n\t\t\t\t\tatt = 3;\n\t\t\t\telse if (is_bcm_board_vendor(dev) &&\n\t\t\t\t\t dev->dev->bus->boardinfo.type ==\n\t\t\t\t\t 0x416)\n\t\t\t\t\tatt = 5;\n\t\t\t\telse if (dev->dev->bus->chip_id == 0x4320)\n\t\t\t\t\tatt = 4;\n\t\t\t\telse\n\t\t\t\t\tatt = 3;\n\t\t\t} else\n\t\t\t\tatt = 6;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tatt = 5;\n\t\t\tbreak;\n\t\tcase 4:\n\t\tcase 5:\n\t\t\tatt = 1;\n\t\t\tbreak;\n\t\tcase 6:\n\t\tcase 7:\n\t\t\tatt = 5;\n\t\t\tbreak;\n\t\tcase 8:\n\t\t\tatt = 0x1A;\n\t\t\tbreak;\n\t\tcase 9:\n\t\tdefault:\n\t\t\tatt = 5;\n\t\t}\n\t}\n\tif (is_bcm_board_vendor(dev) &&\n\t    dev->dev->bus->boardinfo.type == 0x421) {\n\t\tif (dev->dev->bus->sprom.board_rev < 0x43)\n\t\t\tatt = 2;\n\t\telse if (dev->dev->bus->sprom.board_rev < 0x51)\n\t\t\tatt = 3;\n\t}\n\tif (att == 0xFFFF)\n\t\tatt = 5;\n\n\treturn att;\n}\n\nu16 b43legacy_default_txctl1(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\tif (phy->radio_ver != 0x2050)\n\t\treturn 0;\n\tif (phy->radio_rev == 1)\n\t\treturn 3;\n\tif (phy->radio_rev < 6)\n\t\treturn 2;\n\tif (phy->radio_rev == 8)\n\t\treturn 1;\n\treturn 0;\n}\n\nvoid b43legacy_radio_turn_on(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tint err;\n\tu8 channel;\n\n\tmight_sleep();\n\n\tif (phy->radio_on)\n\t\treturn;\n\n\tswitch (phy->type) {\n\tcase B43legacy_PHYTYPE_B:\n\tcase B43legacy_PHYTYPE_G:\n\t\tb43legacy_phy_write(dev, 0x0015, 0x8000);\n\t\tb43legacy_phy_write(dev, 0x0015, 0xCC00);\n\t\tb43legacy_phy_write(dev, 0x0015,\n\t\t\t\t    (phy->gmode ? 0x00C0 : 0x0000));\n\t\tif (phy->radio_off_context.valid) {\n\t\t\t \n\t\t\tb43legacy_phy_write(dev, B43legacy_PHY_RFOVER,\n\t\t\t\t\t    phy->radio_off_context.rfover);\n\t\t\tb43legacy_phy_write(dev, B43legacy_PHY_RFOVERVAL,\n\t\t\t\t\t    phy->radio_off_context.rfoverval);\n\t\t\tphy->radio_off_context.valid = false;\n\t\t}\n\t\tchannel = phy->channel;\n\t\terr = b43legacy_radio_selectchannel(dev,\n\t\t\t\t\tB43legacy_RADIO_DEFAULT_CHANNEL_BG, 1);\n\t\terr |= b43legacy_radio_selectchannel(dev, channel, 0);\n\t\tB43legacy_WARN_ON(err);\n\t\tbreak;\n\tdefault:\n\t\tB43legacy_BUG_ON(1);\n\t}\n\tphy->radio_on = true;\n}\n\nvoid b43legacy_radio_turn_off(struct b43legacy_wldev *dev, bool force)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\tif (!phy->radio_on && !force)\n\t\treturn;\n\n\tif (phy->type == B43legacy_PHYTYPE_G && dev->dev->id.revision >= 5) {\n\t\tu16 rfover, rfoverval;\n\n\t\trfover = b43legacy_phy_read(dev, B43legacy_PHY_RFOVER);\n\t\trfoverval = b43legacy_phy_read(dev, B43legacy_PHY_RFOVERVAL);\n\t\tif (!force) {\n\t\t\tphy->radio_off_context.rfover = rfover;\n\t\t\tphy->radio_off_context.rfoverval = rfoverval;\n\t\t\tphy->radio_off_context.valid = true;\n\t\t}\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_RFOVER, rfover | 0x008C);\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_RFOVERVAL,\n\t\t\t\t    rfoverval & 0xFF73);\n\t} else\n\t\tb43legacy_phy_write(dev, 0x0015, 0xAA00);\n\tphy->radio_on = false;\n\tb43legacydbg(dev->wl, \"Radio initialized\\n\");\n}\n\nvoid b43legacy_radio_clear_tssi(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\tswitch (phy->type) {\n\tcase B43legacy_PHYTYPE_B:\n\tcase B43legacy_PHYTYPE_G:\n\t\tb43legacy_shm_write16(dev, B43legacy_SHM_SHARED, 0x0058,\n\t\t\t\t      0x7F7F);\n\t\tb43legacy_shm_write16(dev, B43legacy_SHM_SHARED, 0x005a,\n\t\t\t\t      0x7F7F);\n\t\tb43legacy_shm_write16(dev, B43legacy_SHM_SHARED, 0x0070,\n\t\t\t\t      0x7F7F);\n\t\tb43legacy_shm_write16(dev, B43legacy_SHM_SHARED, 0x0072,\n\t\t\t\t      0x7F7F);\n\t\tbreak;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}