{
  "module_name": "phy.c",
  "hash_id": "5c92fca452fe9610126c52dae6b423838e50b62caeca4cbc9c501e8ba90f4dfe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/b43legacy/phy.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/pci.h>\n#include <linux/sched.h>\n#include <linux/slab.h>\n#include <linux/types.h>\n\n#include \"b43legacy.h\"\n#include \"phy.h\"\n#include \"main.h\"\n#include \"radio.h\"\n#include \"ilt.h\"\n\n\nstatic const s8 b43legacy_tssi2dbm_b_table[] = {\n\t0x4D, 0x4C, 0x4B, 0x4A,\n\t0x4A, 0x49, 0x48, 0x47,\n\t0x47, 0x46, 0x45, 0x45,\n\t0x44, 0x43, 0x42, 0x42,\n\t0x41, 0x40, 0x3F, 0x3E,\n\t0x3D, 0x3C, 0x3B, 0x3A,\n\t0x39, 0x38, 0x37, 0x36,\n\t0x35, 0x34, 0x32, 0x31,\n\t0x30, 0x2F, 0x2D, 0x2C,\n\t0x2B, 0x29, 0x28, 0x26,\n\t0x25, 0x23, 0x21, 0x1F,\n\t0x1D, 0x1A, 0x17, 0x14,\n\t0x10, 0x0C, 0x06, 0x00,\n\t  -7,   -7,   -7,   -7,\n\t  -7,   -7,   -7,   -7,\n\t  -7,   -7,   -7,   -7,\n};\n\nstatic const s8 b43legacy_tssi2dbm_g_table[] = {\n\t 77,  77,  77,  76,\n\t 76,  76,  75,  75,\n\t 74,  74,  73,  73,\n\t 73,  72,  72,  71,\n\t 71,  70,  70,  69,\n\t 68,  68,  67,  67,\n\t 66,  65,  65,  64,\n\t 63,  63,  62,  61,\n\t 60,  59,  58,  57,\n\t 56,  55,  54,  53,\n\t 52,  50,  49,  47,\n\t 45,  43,  40,  37,\n\t 33,  28,  22,  14,\n\t  5,  -7, -20, -20,\n\t-20, -20, -20, -20,\n\t-20, -20, -20, -20,\n};\n\nstatic void b43legacy_phy_initg(struct b43legacy_wldev *dev);\n\n \nvoid b43legacy_phy_lock(struct b43legacy_wldev *dev)\n{\n#if B43legacy_DEBUG\n\tB43legacy_WARN_ON(dev->phy.phy_locked);\n\tdev->phy.phy_locked = 1;\n#endif\n\n\tif (dev->dev->id.revision < 3) {\n\t\tb43legacy_mac_suspend(dev);\n\t} else {\n\t\tif (!b43legacy_is_mode(dev->wl, NL80211_IFTYPE_AP))\n\t\t\tb43legacy_power_saving_ctl_bits(dev, -1, 1);\n\t}\n}\n\nvoid b43legacy_phy_unlock(struct b43legacy_wldev *dev)\n{\n#if B43legacy_DEBUG\n\tB43legacy_WARN_ON(!dev->phy.phy_locked);\n\tdev->phy.phy_locked = 0;\n#endif\n\n\tif (dev->dev->id.revision < 3) {\n\t\tb43legacy_mac_enable(dev);\n\t} else {\n\t\tif (!b43legacy_is_mode(dev->wl, NL80211_IFTYPE_AP))\n\t\t\tb43legacy_power_saving_ctl_bits(dev, -1, -1);\n\t}\n}\n\nu16 b43legacy_phy_read(struct b43legacy_wldev *dev, u16 offset)\n{\n\tb43legacy_write16(dev, B43legacy_MMIO_PHY_CONTROL, offset);\n\treturn b43legacy_read16(dev, B43legacy_MMIO_PHY_DATA);\n}\n\nvoid b43legacy_phy_write(struct b43legacy_wldev *dev, u16 offset, u16 val)\n{\n\tb43legacy_write16(dev, B43legacy_MMIO_PHY_CONTROL, offset);\n\tb43legacy_write16(dev, B43legacy_MMIO_PHY_DATA, val);\n}\n\nvoid b43legacy_phy_calibrate(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\tb43legacy_read32(dev, B43legacy_MMIO_MACCTL);  \n\tif (phy->calibrated)\n\t\treturn;\n\tif (phy->type == B43legacy_PHYTYPE_G && phy->rev == 1) {\n\t\tb43legacy_wireless_core_reset(dev, 0);\n\t\tb43legacy_phy_initg(dev);\n\t\tb43legacy_wireless_core_reset(dev, B43legacy_TMSLOW_GMODE);\n\t}\n\tphy->calibrated = 1;\n}\n\n \nstatic void b43legacy_phy_init_pctl(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 saved_batt = 0;\n\tu16 saved_ratt = 0;\n\tu16 saved_txctl1 = 0;\n\tint must_reset_txpower = 0;\n\n\tB43legacy_BUG_ON(!(phy->type == B43legacy_PHYTYPE_B ||\n\t\t\t  phy->type == B43legacy_PHYTYPE_G));\n\tif (is_bcm_board_vendor(dev) &&\n\t    (dev->dev->bus->boardinfo.type == 0x0416))\n\t\treturn;\n\n\tb43legacy_phy_write(dev, 0x0028, 0x8018);\n\tb43legacy_write16(dev, 0x03E6, b43legacy_read16(dev, 0x03E6) & 0xFFDF);\n\n\tif (phy->type == B43legacy_PHYTYPE_G) {\n\t\tif (!phy->gmode)\n\t\t\treturn;\n\t\tb43legacy_phy_write(dev, 0x047A, 0xC111);\n\t}\n\tif (phy->savedpctlreg != 0xFFFF)\n\t\treturn;\n#ifdef CONFIG_B43LEGACY_DEBUG\n\tif (phy->manual_txpower_control)\n\t\treturn;\n#endif\n\n\tif (phy->type == B43legacy_PHYTYPE_B &&\n\t    phy->rev >= 2 &&\n\t    phy->radio_ver == 0x2050)\n\t\tb43legacy_radio_write16(dev, 0x0076,\n\t\t\t\t\tb43legacy_radio_read16(dev, 0x0076)\n\t\t\t\t\t| 0x0084);\n\telse {\n\t\tsaved_batt = phy->bbatt;\n\t\tsaved_ratt = phy->rfatt;\n\t\tsaved_txctl1 = phy->txctl1;\n\t\tif ((phy->radio_rev >= 6) && (phy->radio_rev <= 8)\n\t\t    &&   0)\n\t\t\tb43legacy_radio_set_txpower_bg(dev, 0xB, 0x1F, 0);\n\t\telse\n\t\t\tb43legacy_radio_set_txpower_bg(dev, 0xB, 9, 0);\n\t\tmust_reset_txpower = 1;\n\t}\n\tb43legacy_dummy_transmission(dev);\n\n\tphy->savedpctlreg = b43legacy_phy_read(dev, B43legacy_PHY_G_PCTL);\n\n\tif (must_reset_txpower)\n\t\tb43legacy_radio_set_txpower_bg(dev, saved_batt, saved_ratt,\n\t\t\t\t\t       saved_txctl1);\n\telse\n\t\tb43legacy_radio_write16(dev, 0x0076, b43legacy_radio_read16(dev,\n\t\t\t\t\t0x0076) & 0xFF7B);\n\tb43legacy_radio_clear_tssi(dev);\n}\n\nstatic void b43legacy_phy_agcsetup(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 offset = 0x0000;\n\n\tif (phy->rev == 1)\n\t\toffset = 0x4C00;\n\n\tb43legacy_ilt_write(dev, offset, 0x00FE);\n\tb43legacy_ilt_write(dev, offset + 1, 0x000D);\n\tb43legacy_ilt_write(dev, offset + 2, 0x0013);\n\tb43legacy_ilt_write(dev, offset + 3, 0x0019);\n\n\tif (phy->rev == 1) {\n\t\tb43legacy_ilt_write(dev, 0x1800, 0x2710);\n\t\tb43legacy_ilt_write(dev, 0x1801, 0x9B83);\n\t\tb43legacy_ilt_write(dev, 0x1802, 0x9B83);\n\t\tb43legacy_ilt_write(dev, 0x1803, 0x0F8D);\n\t\tb43legacy_phy_write(dev, 0x0455, 0x0004);\n\t}\n\n\tb43legacy_phy_write(dev, 0x04A5, (b43legacy_phy_read(dev, 0x04A5)\n\t\t\t\t\t  & 0x00FF) | 0x5700);\n\tb43legacy_phy_write(dev, 0x041A, (b43legacy_phy_read(dev, 0x041A)\n\t\t\t\t\t  & 0xFF80) | 0x000F);\n\tb43legacy_phy_write(dev, 0x041A, (b43legacy_phy_read(dev, 0x041A)\n\t\t\t\t\t  & 0xC07F) | 0x2B80);\n\tb43legacy_phy_write(dev, 0x048C, (b43legacy_phy_read(dev, 0x048C)\n\t\t\t\t\t  & 0xF0FF) | 0x0300);\n\n\tb43legacy_radio_write16(dev, 0x007A,\n\t\t\t\tb43legacy_radio_read16(dev, 0x007A)\n\t\t\t\t| 0x0008);\n\n\tb43legacy_phy_write(dev, 0x04A0, (b43legacy_phy_read(dev, 0x04A0)\n\t\t\t    & 0xFFF0) | 0x0008);\n\tb43legacy_phy_write(dev, 0x04A1, (b43legacy_phy_read(dev, 0x04A1)\n\t\t\t    & 0xF0FF) | 0x0600);\n\tb43legacy_phy_write(dev, 0x04A2, (b43legacy_phy_read(dev, 0x04A2)\n\t\t\t    & 0xF0FF) | 0x0700);\n\tb43legacy_phy_write(dev, 0x04A0, (b43legacy_phy_read(dev, 0x04A0)\n\t\t\t    & 0xF0FF) | 0x0100);\n\n\tif (phy->rev == 1)\n\t\tb43legacy_phy_write(dev, 0x04A2,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04A2)\n\t\t\t\t    & 0xFFF0) | 0x0007);\n\n\tb43legacy_phy_write(dev, 0x0488, (b43legacy_phy_read(dev, 0x0488)\n\t\t\t    & 0xFF00) | 0x001C);\n\tb43legacy_phy_write(dev, 0x0488, (b43legacy_phy_read(dev, 0x0488)\n\t\t\t    & 0xC0FF) | 0x0200);\n\tb43legacy_phy_write(dev, 0x0496, (b43legacy_phy_read(dev, 0x0496)\n\t\t\t    & 0xFF00) | 0x001C);\n\tb43legacy_phy_write(dev, 0x0489, (b43legacy_phy_read(dev, 0x0489)\n\t\t\t    & 0xFF00) | 0x0020);\n\tb43legacy_phy_write(dev, 0x0489, (b43legacy_phy_read(dev, 0x0489)\n\t\t\t    & 0xC0FF) | 0x0200);\n\tb43legacy_phy_write(dev, 0x0482, (b43legacy_phy_read(dev, 0x0482)\n\t\t\t    & 0xFF00) | 0x002E);\n\tb43legacy_phy_write(dev, 0x0496, (b43legacy_phy_read(dev, 0x0496)\n\t\t\t    & 0x00FF) | 0x1A00);\n\tb43legacy_phy_write(dev, 0x0481, (b43legacy_phy_read(dev, 0x0481)\n\t\t\t    & 0xFF00) | 0x0028);\n\tb43legacy_phy_write(dev, 0x0481, (b43legacy_phy_read(dev, 0x0481)\n\t\t\t    & 0x00FF) | 0x2C00);\n\n\tif (phy->rev == 1) {\n\t\tb43legacy_phy_write(dev, 0x0430, 0x092B);\n\t\tb43legacy_phy_write(dev, 0x041B,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x041B)\n\t\t\t\t    & 0xFFE1) | 0x0002);\n\t} else {\n\t\tb43legacy_phy_write(dev, 0x041B,\n\t\t\t\t    b43legacy_phy_read(dev, 0x041B) & 0xFFE1);\n\t\tb43legacy_phy_write(dev, 0x041F, 0x287A);\n\t\tb43legacy_phy_write(dev, 0x0420,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x0420)\n\t\t\t\t    & 0xFFF0) | 0x0004);\n\t}\n\n\tif (phy->rev > 2) {\n\t\tb43legacy_phy_write(dev, 0x0422, 0x287A);\n\t\tb43legacy_phy_write(dev, 0x0420,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x0420)\n\t\t\t\t    & 0x0FFF) | 0x3000);\n\t}\n\n\tb43legacy_phy_write(dev, 0x04A8, (b43legacy_phy_read(dev, 0x04A8)\n\t\t\t    & 0x8080) | 0x7874);\n\tb43legacy_phy_write(dev, 0x048E, 0x1C00);\n\n\tif (phy->rev == 1) {\n\t\tb43legacy_phy_write(dev, 0x04AB,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x04AB)\n\t\t\t\t    & 0xF0FF) | 0x0600);\n\t\tb43legacy_phy_write(dev, 0x048B, 0x005E);\n\t\tb43legacy_phy_write(dev, 0x048C,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x048C) & 0xFF00)\n\t\t\t\t    | 0x001E);\n\t\tb43legacy_phy_write(dev, 0x048D, 0x0002);\n\t}\n\n\tb43legacy_ilt_write(dev, offset + 0x0800, 0);\n\tb43legacy_ilt_write(dev, offset + 0x0801, 7);\n\tb43legacy_ilt_write(dev, offset + 0x0802, 16);\n\tb43legacy_ilt_write(dev, offset + 0x0803, 28);\n\n\tif (phy->rev >= 6) {\n\t\tb43legacy_phy_write(dev, 0x0426,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x0426) & 0xFFFC));\n\t\tb43legacy_phy_write(dev, 0x0426,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x0426) & 0xEFFF));\n\t}\n}\n\nstatic void b43legacy_phy_setupg(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 i;\n\n\tB43legacy_BUG_ON(phy->type != B43legacy_PHYTYPE_G);\n\tif (phy->rev == 1) {\n\t\tb43legacy_phy_write(dev, 0x0406, 0x4F19);\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS,\n\t\t\t\t    (b43legacy_phy_read(dev,\n\t\t\t\t    B43legacy_PHY_G_CRS) & 0xFC3F) | 0x0340);\n\t\tb43legacy_phy_write(dev, 0x042C, 0x005A);\n\t\tb43legacy_phy_write(dev, 0x0427, 0x001A);\n\n\t\tfor (i = 0; i < B43legacy_ILT_FINEFREQG_SIZE; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x5800 + i,\n\t\t\t\t\t    b43legacy_ilt_finefreqg[i]);\n\t\tfor (i = 0; i < B43legacy_ILT_NOISEG1_SIZE; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x1800 + i,\n\t\t\t\t\t    b43legacy_ilt_noiseg1[i]);\n\t\tfor (i = 0; i < B43legacy_ILT_ROTOR_SIZE; i++)\n\t\t\tb43legacy_ilt_write32(dev, 0x2000 + i,\n\t\t\t\t\t      b43legacy_ilt_rotor[i]);\n\t} else {\n\t\t \n\t\tb43legacy_nrssi_hw_write(dev, 0xBA98, (s16)0x7654);\n\n\t\tif (phy->rev == 2) {\n\t\t\tb43legacy_phy_write(dev, 0x04C0, 0x1861);\n\t\t\tb43legacy_phy_write(dev, 0x04C1, 0x0271);\n\t\t} else if (phy->rev > 2) {\n\t\t\tb43legacy_phy_write(dev, 0x04C0, 0x0098);\n\t\t\tb43legacy_phy_write(dev, 0x04C1, 0x0070);\n\t\t\tb43legacy_phy_write(dev, 0x04C9, 0x0080);\n\t\t}\n\t\tb43legacy_phy_write(dev, 0x042B, b43legacy_phy_read(dev,\n\t\t\t\t    0x042B) | 0x800);\n\n\t\tfor (i = 0; i < 64; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x4000 + i, i);\n\t\tfor (i = 0; i < B43legacy_ILT_NOISEG2_SIZE; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x1800 + i,\n\t\t\t\t\t    b43legacy_ilt_noiseg2[i]);\n\t}\n\n\tif (phy->rev <= 2)\n\t\tfor (i = 0; i < B43legacy_ILT_NOISESCALEG_SIZE; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x1400 + i,\n\t\t\t\t\t    b43legacy_ilt_noisescaleg1[i]);\n\telse if ((phy->rev >= 7) && (b43legacy_phy_read(dev, 0x0449) & 0x0200))\n\t\tfor (i = 0; i < B43legacy_ILT_NOISESCALEG_SIZE; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x1400 + i,\n\t\t\t\t\t    b43legacy_ilt_noisescaleg3[i]);\n\telse\n\t\tfor (i = 0; i < B43legacy_ILT_NOISESCALEG_SIZE; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x1400 + i,\n\t\t\t\t\t    b43legacy_ilt_noisescaleg2[i]);\n\n\tif (phy->rev == 2)\n\t\tfor (i = 0; i < B43legacy_ILT_SIGMASQR_SIZE; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x5000 + i,\n\t\t\t\t\t    b43legacy_ilt_sigmasqr1[i]);\n\telse if ((phy->rev > 2) && (phy->rev <= 8))\n\t\tfor (i = 0; i < B43legacy_ILT_SIGMASQR_SIZE; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x5000 + i,\n\t\t\t\t\t    b43legacy_ilt_sigmasqr2[i]);\n\n\tif (phy->rev == 1) {\n\t\tfor (i = 0; i < B43legacy_ILT_RETARD_SIZE; i++)\n\t\t\tb43legacy_ilt_write32(dev, 0x2400 + i,\n\t\t\t\t\t      b43legacy_ilt_retard[i]);\n\t\tfor (i = 4; i < 20; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x5400 + i, 0x0020);\n\t\tb43legacy_phy_agcsetup(dev);\n\n\t\tif (is_bcm_board_vendor(dev) &&\n\t\t    (dev->dev->bus->boardinfo.type == 0x0416) &&\n\t\t    (dev->dev->bus->sprom.board_rev == 0x0017))\n\t\t\treturn;\n\n\t\tb43legacy_ilt_write(dev, 0x5001, 0x0002);\n\t\tb43legacy_ilt_write(dev, 0x5002, 0x0001);\n\t} else {\n\t\tfor (i = 0; i <= 0x20; i++)\n\t\t\tb43legacy_ilt_write(dev, 0x1000 + i, 0x0820);\n\t\tb43legacy_phy_agcsetup(dev);\n\t\tb43legacy_phy_read(dev, 0x0400);  \n\t\tb43legacy_phy_write(dev, 0x0403, 0x1000);\n\t\tb43legacy_ilt_write(dev, 0x3C02, 0x000F);\n\t\tb43legacy_ilt_write(dev, 0x3C03, 0x0014);\n\n\t\tif (is_bcm_board_vendor(dev) &&\n\t\t    (dev->dev->bus->boardinfo.type == 0x0416) &&\n\t\t    (dev->dev->bus->sprom.board_rev == 0x0017))\n\t\t\treturn;\n\n\t\tb43legacy_ilt_write(dev, 0x0401, 0x0002);\n\t\tb43legacy_ilt_write(dev, 0x0402, 0x0001);\n\t}\n}\n\n \nstatic void b43legacy_phy_inita(struct b43legacy_wldev *dev)\n{\n\n\tmight_sleep();\n\n\tb43legacy_phy_setupg(dev);\n\tif (dev->dev->bus->sprom.boardflags_lo & B43legacy_BFL_PACTRL)\n\t\tb43legacy_phy_write(dev, 0x046E, 0x03CF);\n}\n\nstatic void b43legacy_phy_initb2(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 offset;\n\tint val;\n\n\tb43legacy_write16(dev, 0x03EC, 0x3F22);\n\tb43legacy_phy_write(dev, 0x0020, 0x301C);\n\tb43legacy_phy_write(dev, 0x0026, 0x0000);\n\tb43legacy_phy_write(dev, 0x0030, 0x00C6);\n\tb43legacy_phy_write(dev, 0x0088, 0x3E00);\n\tval = 0x3C3D;\n\tfor (offset = 0x0089; offset < 0x00A7; offset++) {\n\t\tb43legacy_phy_write(dev, offset, val);\n\t\tval -= 0x0202;\n\t}\n\tb43legacy_phy_write(dev, 0x03E4, 0x3000);\n\tb43legacy_radio_selectchannel(dev, phy->channel, 0);\n\tif (phy->radio_ver != 0x2050) {\n\t\tb43legacy_radio_write16(dev, 0x0075, 0x0080);\n\t\tb43legacy_radio_write16(dev, 0x0079, 0x0081);\n\t}\n\tb43legacy_radio_write16(dev, 0x0050, 0x0020);\n\tb43legacy_radio_write16(dev, 0x0050, 0x0023);\n\tif (phy->radio_ver == 0x2050) {\n\t\tb43legacy_radio_write16(dev, 0x0050, 0x0020);\n\t\tb43legacy_radio_write16(dev, 0x005A, 0x0070);\n\t\tb43legacy_radio_write16(dev, 0x005B, 0x007B);\n\t\tb43legacy_radio_write16(dev, 0x005C, 0x00B0);\n\t\tb43legacy_radio_write16(dev, 0x007A, 0x000F);\n\t\tb43legacy_phy_write(dev, 0x0038, 0x0677);\n\t\tb43legacy_radio_init2050(dev);\n\t}\n\tb43legacy_phy_write(dev, 0x0014, 0x0080);\n\tb43legacy_phy_write(dev, 0x0032, 0x00CA);\n\tb43legacy_phy_write(dev, 0x0032, 0x00CC);\n\tb43legacy_phy_write(dev, 0x0035, 0x07C2);\n\tb43legacy_phy_lo_b_measure(dev);\n\tb43legacy_phy_write(dev, 0x0026, 0xCC00);\n\tif (phy->radio_ver != 0x2050)\n\t\tb43legacy_phy_write(dev, 0x0026, 0xCE00);\n\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL_EXT, 0x1000);\n\tb43legacy_phy_write(dev, 0x002A, 0x88A3);\n\tif (phy->radio_ver != 0x2050)\n\t\tb43legacy_phy_write(dev, 0x002A, 0x88C2);\n\tb43legacy_radio_set_txpower_bg(dev, 0xFFFF, 0xFFFF, 0xFFFF);\n\tb43legacy_phy_init_pctl(dev);\n}\n\nstatic void b43legacy_phy_initb4(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 offset;\n\tu16 val;\n\n\tb43legacy_write16(dev, 0x03EC, 0x3F22);\n\tb43legacy_phy_write(dev, 0x0020, 0x301C);\n\tb43legacy_phy_write(dev, 0x0026, 0x0000);\n\tb43legacy_phy_write(dev, 0x0030, 0x00C6);\n\tb43legacy_phy_write(dev, 0x0088, 0x3E00);\n\tval = 0x3C3D;\n\tfor (offset = 0x0089; offset < 0x00A7; offset++) {\n\t\tb43legacy_phy_write(dev, offset, val);\n\t\tval -= 0x0202;\n\t}\n\tb43legacy_phy_write(dev, 0x03E4, 0x3000);\n\tb43legacy_radio_selectchannel(dev, phy->channel, 0);\n\tif (phy->radio_ver != 0x2050) {\n\t\tb43legacy_radio_write16(dev, 0x0075, 0x0080);\n\t\tb43legacy_radio_write16(dev, 0x0079, 0x0081);\n\t}\n\tb43legacy_radio_write16(dev, 0x0050, 0x0020);\n\tb43legacy_radio_write16(dev, 0x0050, 0x0023);\n\tif (phy->radio_ver == 0x2050) {\n\t\tb43legacy_radio_write16(dev, 0x0050, 0x0020);\n\t\tb43legacy_radio_write16(dev, 0x005A, 0x0070);\n\t\tb43legacy_radio_write16(dev, 0x005B, 0x007B);\n\t\tb43legacy_radio_write16(dev, 0x005C, 0x00B0);\n\t\tb43legacy_radio_write16(dev, 0x007A, 0x000F);\n\t\tb43legacy_phy_write(dev, 0x0038, 0x0677);\n\t\tb43legacy_radio_init2050(dev);\n\t}\n\tb43legacy_phy_write(dev, 0x0014, 0x0080);\n\tb43legacy_phy_write(dev, 0x0032, 0x00CA);\n\tif (phy->radio_ver == 0x2050)\n\t\tb43legacy_phy_write(dev, 0x0032, 0x00E0);\n\tb43legacy_phy_write(dev, 0x0035, 0x07C2);\n\n\tb43legacy_phy_lo_b_measure(dev);\n\n\tb43legacy_phy_write(dev, 0x0026, 0xCC00);\n\tif (phy->radio_ver == 0x2050)\n\t\tb43legacy_phy_write(dev, 0x0026, 0xCE00);\n\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL_EXT, 0x1100);\n\tb43legacy_phy_write(dev, 0x002A, 0x88A3);\n\tif (phy->radio_ver == 0x2050)\n\t\tb43legacy_phy_write(dev, 0x002A, 0x88C2);\n\tb43legacy_radio_set_txpower_bg(dev, 0xFFFF, 0xFFFF, 0xFFFF);\n\tif (dev->dev->bus->sprom.boardflags_lo & B43legacy_BFL_RSSI) {\n\t\tb43legacy_calc_nrssi_slope(dev);\n\t\tb43legacy_calc_nrssi_threshold(dev);\n\t}\n\tb43legacy_phy_init_pctl(dev);\n}\n\nstatic void b43legacy_phy_initb5(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 offset;\n\tu16 value;\n\tu8 old_channel;\n\n\tif (phy->analog == 1)\n\t\tb43legacy_radio_write16(dev, 0x007A,\n\t\t\t\t\tb43legacy_radio_read16(dev, 0x007A)\n\t\t\t\t\t| 0x0050);\n\tif (!is_bcm_board_vendor(dev) &&\n\t    (dev->dev->bus->boardinfo.type != 0x0416)) {\n\t\tvalue = 0x2120;\n\t\tfor (offset = 0x00A8 ; offset < 0x00C7; offset++) {\n\t\t\tb43legacy_phy_write(dev, offset, value);\n\t\t\tvalue += 0x0202;\n\t\t}\n\t}\n\tb43legacy_phy_write(dev, 0x0035,\n\t\t\t    (b43legacy_phy_read(dev, 0x0035) & 0xF0FF)\n\t\t\t    | 0x0700);\n\tif (phy->radio_ver == 0x2050)\n\t\tb43legacy_phy_write(dev, 0x0038, 0x0667);\n\n\tif (phy->gmode) {\n\t\tif (phy->radio_ver == 0x2050) {\n\t\t\tb43legacy_radio_write16(dev, 0x007A,\n\t\t\t\t\tb43legacy_radio_read16(dev, 0x007A)\n\t\t\t\t\t| 0x0020);\n\t\t\tb43legacy_radio_write16(dev, 0x0051,\n\t\t\t\t\tb43legacy_radio_read16(dev, 0x0051)\n\t\t\t\t\t| 0x0004);\n\t\t}\n\t\tb43legacy_write16(dev, B43legacy_MMIO_PHY_RADIO, 0x0000);\n\n\t\tb43legacy_phy_write(dev, 0x0802, b43legacy_phy_read(dev, 0x0802)\n\t\t\t\t    | 0x0100);\n\t\tb43legacy_phy_write(dev, 0x042B, b43legacy_phy_read(dev, 0x042B)\n\t\t\t\t    | 0x2000);\n\n\t\tb43legacy_phy_write(dev, 0x001C, 0x186A);\n\n\t\tb43legacy_phy_write(dev, 0x0013, (b43legacy_phy_read(dev,\n\t\t\t\t    0x0013) & 0x00FF) | 0x1900);\n\t\tb43legacy_phy_write(dev, 0x0035, (b43legacy_phy_read(dev,\n\t\t\t\t    0x0035) & 0xFFC0) | 0x0064);\n\t\tb43legacy_phy_write(dev, 0x005D, (b43legacy_phy_read(dev,\n\t\t\t\t    0x005D) & 0xFF80) | 0x000A);\n\t\tb43legacy_phy_write(dev, 0x5B, 0x0000);\n\t\tb43legacy_phy_write(dev, 0x5C, 0x0000);\n\t}\n\n\tif (dev->bad_frames_preempt)\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_RADIO_BITFIELD,\n\t\t\t\t    b43legacy_phy_read(dev,\n\t\t\t\t    B43legacy_PHY_RADIO_BITFIELD) | (1 << 12));\n\n\tif (phy->analog == 1) {\n\t\tb43legacy_phy_write(dev, 0x0026, 0xCE00);\n\t\tb43legacy_phy_write(dev, 0x0021, 0x3763);\n\t\tb43legacy_phy_write(dev, 0x0022, 0x1BC3);\n\t\tb43legacy_phy_write(dev, 0x0023, 0x06F9);\n\t\tb43legacy_phy_write(dev, 0x0024, 0x037E);\n\t} else\n\t\tb43legacy_phy_write(dev, 0x0026, 0xCC00);\n\tb43legacy_phy_write(dev, 0x0030, 0x00C6);\n\tb43legacy_write16(dev, 0x03EC, 0x3F22);\n\n\tif (phy->analog == 1)\n\t\tb43legacy_phy_write(dev, 0x0020, 0x3E1C);\n\telse\n\t\tb43legacy_phy_write(dev, 0x0020, 0x301C);\n\n\tif (phy->analog == 0)\n\t\tb43legacy_write16(dev, 0x03E4, 0x3000);\n\n\told_channel = (phy->channel == 0xFF) ? 1 : phy->channel;\n\t \n\tb43legacy_radio_selectchannel(dev, 7, 0);\n\n\tif (phy->radio_ver != 0x2050) {\n\t\tb43legacy_radio_write16(dev, 0x0075, 0x0080);\n\t\tb43legacy_radio_write16(dev, 0x0079, 0x0081);\n\t}\n\n\tb43legacy_radio_write16(dev, 0x0050, 0x0020);\n\tb43legacy_radio_write16(dev, 0x0050, 0x0023);\n\n\tif (phy->radio_ver == 0x2050) {\n\t\tb43legacy_radio_write16(dev, 0x0050, 0x0020);\n\t\tb43legacy_radio_write16(dev, 0x005A, 0x0070);\n\t}\n\n\tb43legacy_radio_write16(dev, 0x005B, 0x007B);\n\tb43legacy_radio_write16(dev, 0x005C, 0x00B0);\n\n\tb43legacy_radio_write16(dev, 0x007A, b43legacy_radio_read16(dev,\n\t\t\t\t0x007A) | 0x0007);\n\n\tb43legacy_radio_selectchannel(dev, old_channel, 0);\n\n\tb43legacy_phy_write(dev, 0x0014, 0x0080);\n\tb43legacy_phy_write(dev, 0x0032, 0x00CA);\n\tb43legacy_phy_write(dev, 0x002A, 0x88A3);\n\n\tb43legacy_radio_set_txpower_bg(dev, 0xFFFF, 0xFFFF, 0xFFFF);\n\n\tif (phy->radio_ver == 0x2050)\n\t\tb43legacy_radio_write16(dev, 0x005D, 0x000D);\n\n\tb43legacy_write16(dev, 0x03E4, (b43legacy_read16(dev, 0x03E4) &\n\t\t\t  0xFFC0) | 0x0004);\n}\n\nstatic void b43legacy_phy_initb6(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 offset;\n\tu16 val;\n\tu8 old_channel;\n\n\tb43legacy_phy_write(dev, 0x003E, 0x817A);\n\tb43legacy_radio_write16(dev, 0x007A,\n\t\t\t\t(b43legacy_radio_read16(dev, 0x007A) | 0x0058));\n\tif (phy->radio_rev == 4 ||\n\t     phy->radio_rev == 5) {\n\t\tb43legacy_radio_write16(dev, 0x0051, 0x0037);\n\t\tb43legacy_radio_write16(dev, 0x0052, 0x0070);\n\t\tb43legacy_radio_write16(dev, 0x0053, 0x00B3);\n\t\tb43legacy_radio_write16(dev, 0x0054, 0x009B);\n\t\tb43legacy_radio_write16(dev, 0x005A, 0x0088);\n\t\tb43legacy_radio_write16(dev, 0x005B, 0x0088);\n\t\tb43legacy_radio_write16(dev, 0x005D, 0x0088);\n\t\tb43legacy_radio_write16(dev, 0x005E, 0x0088);\n\t\tb43legacy_radio_write16(dev, 0x007D, 0x0088);\n\t\tb43legacy_shm_write32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t      B43legacy_UCODEFLAGS_OFFSET,\n\t\t\t\t      (b43legacy_shm_read32(dev,\n\t\t\t\t      B43legacy_SHM_SHARED,\n\t\t\t\t      B43legacy_UCODEFLAGS_OFFSET)\n\t\t\t\t      | 0x00000200));\n\t}\n\tif (phy->radio_rev == 8) {\n\t\tb43legacy_radio_write16(dev, 0x0051, 0x0000);\n\t\tb43legacy_radio_write16(dev, 0x0052, 0x0040);\n\t\tb43legacy_radio_write16(dev, 0x0053, 0x00B7);\n\t\tb43legacy_radio_write16(dev, 0x0054, 0x0098);\n\t\tb43legacy_radio_write16(dev, 0x005A, 0x0088);\n\t\tb43legacy_radio_write16(dev, 0x005B, 0x006B);\n\t\tb43legacy_radio_write16(dev, 0x005C, 0x000F);\n\t\tif (dev->dev->bus->sprom.boardflags_lo & 0x8000) {\n\t\t\tb43legacy_radio_write16(dev, 0x005D, 0x00FA);\n\t\t\tb43legacy_radio_write16(dev, 0x005E, 0x00D8);\n\t\t} else {\n\t\t\tb43legacy_radio_write16(dev, 0x005D, 0x00F5);\n\t\t\tb43legacy_radio_write16(dev, 0x005E, 0x00B8);\n\t\t}\n\t\tb43legacy_radio_write16(dev, 0x0073, 0x0003);\n\t\tb43legacy_radio_write16(dev, 0x007D, 0x00A8);\n\t\tb43legacy_radio_write16(dev, 0x007C, 0x0001);\n\t\tb43legacy_radio_write16(dev, 0x007E, 0x0008);\n\t}\n\tval = 0x1E1F;\n\tfor (offset = 0x0088; offset < 0x0098; offset++) {\n\t\tb43legacy_phy_write(dev, offset, val);\n\t\tval -= 0x0202;\n\t}\n\tval = 0x3E3F;\n\tfor (offset = 0x0098; offset < 0x00A8; offset++) {\n\t\tb43legacy_phy_write(dev, offset, val);\n\t\tval -= 0x0202;\n\t}\n\tval = 0x2120;\n\tfor (offset = 0x00A8; offset < 0x00C8; offset++) {\n\t\tb43legacy_phy_write(dev, offset, (val & 0x3F3F));\n\t\tval += 0x0202;\n\t}\n\tif (phy->type == B43legacy_PHYTYPE_G) {\n\t\tb43legacy_radio_write16(dev, 0x007A,\n\t\t\t\t\tb43legacy_radio_read16(dev, 0x007A) |\n\t\t\t\t\t0x0020);\n\t\tb43legacy_radio_write16(dev, 0x0051,\n\t\t\t\t\tb43legacy_radio_read16(dev, 0x0051) |\n\t\t\t\t\t0x0004);\n\t\tb43legacy_phy_write(dev, 0x0802,\n\t\t\t\t    b43legacy_phy_read(dev, 0x0802) | 0x0100);\n\t\tb43legacy_phy_write(dev, 0x042B,\n\t\t\t\t    b43legacy_phy_read(dev, 0x042B) | 0x2000);\n\t\tb43legacy_phy_write(dev, 0x5B, 0x0000);\n\t\tb43legacy_phy_write(dev, 0x5C, 0x0000);\n\t}\n\n\told_channel = phy->channel;\n\tif (old_channel >= 8)\n\t\tb43legacy_radio_selectchannel(dev, 1, 0);\n\telse\n\t\tb43legacy_radio_selectchannel(dev, 13, 0);\n\n\tb43legacy_radio_write16(dev, 0x0050, 0x0020);\n\tb43legacy_radio_write16(dev, 0x0050, 0x0023);\n\tudelay(40);\n\tif (phy->radio_rev < 6 || phy->radio_rev == 8) {\n\t\tb43legacy_radio_write16(dev, 0x007C,\n\t\t\t\t\t(b43legacy_radio_read16(dev, 0x007C)\n\t\t\t\t\t| 0x0002));\n\t\tb43legacy_radio_write16(dev, 0x0050, 0x0020);\n\t}\n\tif (phy->radio_rev <= 2) {\n\t\tb43legacy_radio_write16(dev, 0x0050, 0x0020);\n\t\tb43legacy_radio_write16(dev, 0x005A, 0x0070);\n\t\tb43legacy_radio_write16(dev, 0x005B, 0x007B);\n\t\tb43legacy_radio_write16(dev, 0x005C, 0x00B0);\n\t}\n\tb43legacy_radio_write16(dev, 0x007A,\n\t\t\t\t(b43legacy_radio_read16(dev,\n\t\t\t\t0x007A) & 0x00F8) | 0x0007);\n\n\tb43legacy_radio_selectchannel(dev, old_channel, 0);\n\n\tb43legacy_phy_write(dev, 0x0014, 0x0200);\n\tif (phy->radio_rev >= 6)\n\t\tb43legacy_phy_write(dev, 0x002A, 0x88C2);\n\telse\n\t\tb43legacy_phy_write(dev, 0x002A, 0x8AC0);\n\tb43legacy_phy_write(dev, 0x0038, 0x0668);\n\tb43legacy_radio_set_txpower_bg(dev, 0xFFFF, 0xFFFF, 0xFFFF);\n\tif (phy->radio_rev == 4 || phy->radio_rev == 5)\n\t\tb43legacy_phy_write(dev, 0x005D, (b43legacy_phy_read(dev,\n\t\t\t\t    0x005D) & 0xFF80) | 0x0003);\n\tif (phy->radio_rev <= 2)\n\t\tb43legacy_radio_write16(dev, 0x005D, 0x000D);\n\n\tif (phy->analog == 4) {\n\t\tb43legacy_write16(dev, 0x03E4, 0x0009);\n\t\tb43legacy_phy_write(dev, 0x61, b43legacy_phy_read(dev, 0x61)\n\t\t\t\t    & 0xFFF);\n\t} else\n\t\tb43legacy_phy_write(dev, 0x0002, (b43legacy_phy_read(dev,\n\t\t\t\t    0x0002) & 0xFFC0) | 0x0004);\n\tif (phy->type == B43legacy_PHYTYPE_G)\n\t\tb43legacy_write16(dev, 0x03E6, 0x0);\n\tif (phy->type == B43legacy_PHYTYPE_B) {\n\t\tb43legacy_write16(dev, 0x03E6, 0x8140);\n\t\tb43legacy_phy_write(dev, 0x0016, 0x0410);\n\t\tb43legacy_phy_write(dev, 0x0017, 0x0820);\n\t\tb43legacy_phy_write(dev, 0x0062, 0x0007);\n\t\tb43legacy_radio_init2050(dev);\n\t\tb43legacy_phy_lo_g_measure(dev);\n\t\tif (dev->dev->bus->sprom.boardflags_lo &\n\t\t    B43legacy_BFL_RSSI) {\n\t\t\tb43legacy_calc_nrssi_slope(dev);\n\t\t\tb43legacy_calc_nrssi_threshold(dev);\n\t\t}\n\t\tb43legacy_phy_init_pctl(dev);\n\t}\n}\n\nstatic void b43legacy_calc_loopback_gain(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 backup_phy[15] = {0};\n\tu16 backup_radio[3];\n\tu16 backup_bband;\n\tu16 i;\n\tu16 loop1_cnt;\n\tu16 loop1_done;\n\tu16 loop1_omitted;\n\tu16 loop2_done;\n\n\tbackup_phy[0] = b43legacy_phy_read(dev, 0x0429);\n\tbackup_phy[1] = b43legacy_phy_read(dev, 0x0001);\n\tbackup_phy[2] = b43legacy_phy_read(dev, 0x0811);\n\tbackup_phy[3] = b43legacy_phy_read(dev, 0x0812);\n\tif (phy->rev != 1) {\n\t\tbackup_phy[4] = b43legacy_phy_read(dev, 0x0814);\n\t\tbackup_phy[5] = b43legacy_phy_read(dev, 0x0815);\n\t}\n\tbackup_phy[6] = b43legacy_phy_read(dev, 0x005A);\n\tbackup_phy[7] = b43legacy_phy_read(dev, 0x0059);\n\tbackup_phy[8] = b43legacy_phy_read(dev, 0x0058);\n\tbackup_phy[9] = b43legacy_phy_read(dev, 0x000A);\n\tbackup_phy[10] = b43legacy_phy_read(dev, 0x0003);\n\tbackup_phy[11] = b43legacy_phy_read(dev, 0x080F);\n\tbackup_phy[12] = b43legacy_phy_read(dev, 0x0810);\n\tbackup_phy[13] = b43legacy_phy_read(dev, 0x002B);\n\tbackup_phy[14] = b43legacy_phy_read(dev, 0x0015);\n\tb43legacy_phy_read(dev, 0x002D);  \n\tbackup_bband = phy->bbatt;\n\tbackup_radio[0] = b43legacy_radio_read16(dev, 0x0052);\n\tbackup_radio[1] = b43legacy_radio_read16(dev, 0x0043);\n\tbackup_radio[2] = b43legacy_radio_read16(dev, 0x007A);\n\n\tb43legacy_phy_write(dev, 0x0429,\n\t\t\t    b43legacy_phy_read(dev, 0x0429) & 0x3FFF);\n\tb43legacy_phy_write(dev, 0x0001,\n\t\t\t    b43legacy_phy_read(dev, 0x0001) & 0x8000);\n\tb43legacy_phy_write(dev, 0x0811,\n\t\t\t    b43legacy_phy_read(dev, 0x0811) | 0x0002);\n\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t    b43legacy_phy_read(dev, 0x0812) & 0xFFFD);\n\tb43legacy_phy_write(dev, 0x0811,\n\t\t\t    b43legacy_phy_read(dev, 0x0811) | 0x0001);\n\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t    b43legacy_phy_read(dev, 0x0812) & 0xFFFE);\n\tif (phy->rev != 1) {\n\t\tb43legacy_phy_write(dev, 0x0814,\n\t\t\t\t    b43legacy_phy_read(dev, 0x0814) | 0x0001);\n\t\tb43legacy_phy_write(dev, 0x0815,\n\t\t\t\t    b43legacy_phy_read(dev, 0x0815) & 0xFFFE);\n\t\tb43legacy_phy_write(dev, 0x0814,\n\t\t\t\t    b43legacy_phy_read(dev, 0x0814) | 0x0002);\n\t\tb43legacy_phy_write(dev, 0x0815,\n\t\t\t\t    b43legacy_phy_read(dev, 0x0815) & 0xFFFD);\n\t}\n\tb43legacy_phy_write(dev, 0x0811, b43legacy_phy_read(dev, 0x0811) |\n\t\t\t    0x000C);\n\tb43legacy_phy_write(dev, 0x0812, b43legacy_phy_read(dev, 0x0812) |\n\t\t\t    0x000C);\n\n\tb43legacy_phy_write(dev, 0x0811, (b43legacy_phy_read(dev, 0x0811)\n\t\t\t    & 0xFFCF) | 0x0030);\n\tb43legacy_phy_write(dev, 0x0812, (b43legacy_phy_read(dev, 0x0812)\n\t\t\t    & 0xFFCF) | 0x0010);\n\n\tb43legacy_phy_write(dev, 0x005A, 0x0780);\n\tb43legacy_phy_write(dev, 0x0059, 0xC810);\n\tb43legacy_phy_write(dev, 0x0058, 0x000D);\n\tif (phy->analog == 0)\n\t\tb43legacy_phy_write(dev, 0x0003, 0x0122);\n\telse\n\t\tb43legacy_phy_write(dev, 0x000A,\n\t\t\t\t    b43legacy_phy_read(dev, 0x000A)\n\t\t\t\t    | 0x2000);\n\tif (phy->rev != 1) {\n\t\tb43legacy_phy_write(dev, 0x0814,\n\t\t\t\t    b43legacy_phy_read(dev, 0x0814) | 0x0004);\n\t\tb43legacy_phy_write(dev, 0x0815,\n\t\t\t\t    b43legacy_phy_read(dev, 0x0815) & 0xFFFB);\n\t}\n\tb43legacy_phy_write(dev, 0x0003,\n\t\t\t    (b43legacy_phy_read(dev, 0x0003)\n\t\t\t     & 0xFF9F) | 0x0040);\n\tif (phy->radio_ver == 0x2050 && phy->radio_rev == 2) {\n\t\tb43legacy_radio_write16(dev, 0x0052, 0x0000);\n\t\tb43legacy_radio_write16(dev, 0x0043,\n\t\t\t\t\t(b43legacy_radio_read16(dev, 0x0043)\n\t\t\t\t\t & 0xFFF0) | 0x0009);\n\t\tloop1_cnt = 9;\n\t} else if (phy->radio_rev == 8) {\n\t\tb43legacy_radio_write16(dev, 0x0043, 0x000F);\n\t\tloop1_cnt = 15;\n\t} else\n\t\tloop1_cnt = 0;\n\n\tb43legacy_phy_set_baseband_attenuation(dev, 11);\n\n\tif (phy->rev >= 3)\n\t\tb43legacy_phy_write(dev, 0x080F, 0xC020);\n\telse\n\t\tb43legacy_phy_write(dev, 0x080F, 0x8020);\n\tb43legacy_phy_write(dev, 0x0810, 0x0000);\n\n\tb43legacy_phy_write(dev, 0x002B,\n\t\t\t    (b43legacy_phy_read(dev, 0x002B)\n\t\t\t     & 0xFFC0) | 0x0001);\n\tb43legacy_phy_write(dev, 0x002B,\n\t\t\t    (b43legacy_phy_read(dev, 0x002B)\n\t\t\t     & 0xC0FF) | 0x0800);\n\tb43legacy_phy_write(dev, 0x0811,\n\t\t\t    b43legacy_phy_read(dev, 0x0811) | 0x0100);\n\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t    b43legacy_phy_read(dev, 0x0812) & 0xCFFF);\n\tif (dev->dev->bus->sprom.boardflags_lo & B43legacy_BFL_EXTLNA) {\n\t\tif (phy->rev >= 7) {\n\t\t\tb43legacy_phy_write(dev, 0x0811,\n\t\t\t\t\t    b43legacy_phy_read(dev, 0x0811)\n\t\t\t\t\t    | 0x0800);\n\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t    b43legacy_phy_read(dev, 0x0812)\n\t\t\t\t\t    | 0x8000);\n\t\t}\n\t}\n\tb43legacy_radio_write16(dev, 0x007A,\n\t\t\t\tb43legacy_radio_read16(dev, 0x007A)\n\t\t\t\t& 0x00F7);\n\n\tfor (i = 0; i < loop1_cnt; i++) {\n\t\tb43legacy_radio_write16(dev, 0x0043, loop1_cnt);\n\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x0812)\n\t\t\t\t     & 0xF0FF) | (i << 8));\n\t\tb43legacy_phy_write(dev, 0x0015,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x0015)\n\t\t\t\t     & 0x0FFF) | 0xA000);\n\t\tb43legacy_phy_write(dev, 0x0015,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x0015)\n\t\t\t\t     & 0x0FFF) | 0xF000);\n\t\tudelay(20);\n\t\tif (b43legacy_phy_read(dev, 0x002D) >= 0x0DFC)\n\t\t\tbreak;\n\t}\n\tloop1_done = i;\n\tloop1_omitted = loop1_cnt - loop1_done;\n\n\tloop2_done = 0;\n\tif (loop1_done >= 8) {\n\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t    b43legacy_phy_read(dev, 0x0812)\n\t\t\t\t    | 0x0030);\n\t\tfor (i = loop1_done - 8; i < 16; i++) {\n\t\t\tb43legacy_phy_write(dev, 0x0812,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0812)\n\t\t\t\t\t     & 0xF0FF) | (i << 8));\n\t\t\tb43legacy_phy_write(dev, 0x0015,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0015)\n\t\t\t\t\t     & 0x0FFF) | 0xA000);\n\t\t\tb43legacy_phy_write(dev, 0x0015,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0015)\n\t\t\t\t\t     & 0x0FFF) | 0xF000);\n\t\t\tudelay(20);\n\t\t\tif (b43legacy_phy_read(dev, 0x002D) >= 0x0DFC)\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (phy->rev != 1) {\n\t\tb43legacy_phy_write(dev, 0x0814, backup_phy[4]);\n\t\tb43legacy_phy_write(dev, 0x0815, backup_phy[5]);\n\t}\n\tb43legacy_phy_write(dev, 0x005A, backup_phy[6]);\n\tb43legacy_phy_write(dev, 0x0059, backup_phy[7]);\n\tb43legacy_phy_write(dev, 0x0058, backup_phy[8]);\n\tb43legacy_phy_write(dev, 0x000A, backup_phy[9]);\n\tb43legacy_phy_write(dev, 0x0003, backup_phy[10]);\n\tb43legacy_phy_write(dev, 0x080F, backup_phy[11]);\n\tb43legacy_phy_write(dev, 0x0810, backup_phy[12]);\n\tb43legacy_phy_write(dev, 0x002B, backup_phy[13]);\n\tb43legacy_phy_write(dev, 0x0015, backup_phy[14]);\n\n\tb43legacy_phy_set_baseband_attenuation(dev, backup_bband);\n\n\tb43legacy_radio_write16(dev, 0x0052, backup_radio[0]);\n\tb43legacy_radio_write16(dev, 0x0043, backup_radio[1]);\n\tb43legacy_radio_write16(dev, 0x007A, backup_radio[2]);\n\n\tb43legacy_phy_write(dev, 0x0811, backup_phy[2] | 0x0003);\n\tudelay(10);\n\tb43legacy_phy_write(dev, 0x0811, backup_phy[2]);\n\tb43legacy_phy_write(dev, 0x0812, backup_phy[3]);\n\tb43legacy_phy_write(dev, 0x0429, backup_phy[0]);\n\tb43legacy_phy_write(dev, 0x0001, backup_phy[1]);\n\n\tphy->loopback_gain[0] = ((loop1_done * 6) - (loop1_omitted * 4)) - 11;\n\tphy->loopback_gain[1] = (24 - (3 * loop2_done)) * 2;\n}\n\nstatic void b43legacy_phy_initg(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 tmp;\n\n\tif (phy->rev == 1)\n\t\tb43legacy_phy_initb5(dev);\n\telse\n\t\tb43legacy_phy_initb6(dev);\n\tif (phy->rev >= 2 && phy->gmode)\n\t\tb43legacy_phy_inita(dev);\n\n\tif (phy->rev >= 2) {\n\t\tb43legacy_phy_write(dev, 0x0814, 0x0000);\n\t\tb43legacy_phy_write(dev, 0x0815, 0x0000);\n\t}\n\tif (phy->rev == 2) {\n\t\tb43legacy_phy_write(dev, 0x0811, 0x0000);\n\t\tb43legacy_phy_write(dev, 0x0015, 0x00C0);\n\t}\n\tif (phy->rev > 5) {\n\t\tb43legacy_phy_write(dev, 0x0811, 0x0400);\n\t\tb43legacy_phy_write(dev, 0x0015, 0x00C0);\n\t}\n\tif (phy->gmode) {\n\t\ttmp = b43legacy_phy_read(dev, 0x0400) & 0xFF;\n\t\tif (tmp == 3) {\n\t\t\tb43legacy_phy_write(dev, 0x04C2, 0x1816);\n\t\t\tb43legacy_phy_write(dev, 0x04C3, 0x8606);\n\t\t}\n\t\tif (tmp == 4 || tmp == 5) {\n\t\t\tb43legacy_phy_write(dev, 0x04C2, 0x1816);\n\t\t\tb43legacy_phy_write(dev, 0x04C3, 0x8006);\n\t\t\tb43legacy_phy_write(dev, 0x04CC,\n\t\t\t\t\t    (b43legacy_phy_read(dev,\n\t\t\t\t\t     0x04CC) & 0x00FF) |\n\t\t\t\t\t     0x1F00);\n\t\t}\n\t\tif (phy->rev >= 2)\n\t\t\tb43legacy_phy_write(dev, 0x047E, 0x0078);\n\t}\n\tif (phy->radio_rev == 8) {\n\t\tb43legacy_phy_write(dev, 0x0801, b43legacy_phy_read(dev, 0x0801)\n\t\t\t\t    | 0x0080);\n\t\tb43legacy_phy_write(dev, 0x043E, b43legacy_phy_read(dev, 0x043E)\n\t\t\t\t    | 0x0004);\n\t}\n\tif (phy->rev >= 2 && phy->gmode)\n\t\tb43legacy_calc_loopback_gain(dev);\n\tif (phy->radio_rev != 8) {\n\t\tif (phy->initval == 0xFFFF)\n\t\t\tphy->initval = b43legacy_radio_init2050(dev);\n\t\telse\n\t\t\tb43legacy_radio_write16(dev, 0x0078, phy->initval);\n\t}\n\tif (phy->txctl2 == 0xFFFF)\n\t\tb43legacy_phy_lo_g_measure(dev);\n\telse {\n\t\tif (phy->radio_ver == 0x2050 && phy->radio_rev == 8)\n\t\t\tb43legacy_radio_write16(dev, 0x0052,\n\t\t\t\t\t\t(phy->txctl1 << 4) |\n\t\t\t\t\t\tphy->txctl2);\n\t\telse\n\t\t\tb43legacy_radio_write16(dev, 0x0052,\n\t\t\t\t\t\t(b43legacy_radio_read16(dev,\n\t\t\t\t\t\t 0x0052) & 0xFFF0) |\n\t\t\t\t\t\t phy->txctl1);\n\t\tif (phy->rev >= 6)\n\t\t\tb43legacy_phy_write(dev, 0x0036,\n\t\t\t\t\t    (b43legacy_phy_read(dev, 0x0036)\n\t\t\t\t\t     & 0x0FFF) | (phy->txctl2 << 12));\n\t\tif (dev->dev->bus->sprom.boardflags_lo &\n\t\t    B43legacy_BFL_PACTRL)\n\t\t\tb43legacy_phy_write(dev, 0x002E, 0x8075);\n\t\telse\n\t\t\tb43legacy_phy_write(dev, 0x002E, 0x807F);\n\t\tif (phy->rev < 2)\n\t\t\tb43legacy_phy_write(dev, 0x002F, 0x0101);\n\t\telse\n\t\t\tb43legacy_phy_write(dev, 0x002F, 0x0202);\n\t}\n\tif (phy->gmode) {\n\t\tb43legacy_phy_lo_adjust(dev, 0);\n\t\tb43legacy_phy_write(dev, 0x080F, 0x8078);\n\t}\n\n\tif (!(dev->dev->bus->sprom.boardflags_lo & B43legacy_BFL_RSSI)) {\n\t\t \n\t\tb43legacy_nrssi_hw_update(dev, 0xFFFF);\n\t\tb43legacy_calc_nrssi_threshold(dev);\n\t} else if (phy->gmode || phy->rev >= 2) {\n\t\tif (phy->nrssi[0] == -1000) {\n\t\t\tB43legacy_WARN_ON(phy->nrssi[1] != -1000);\n\t\t\tb43legacy_calc_nrssi_slope(dev);\n\t\t} else {\n\t\t\tB43legacy_WARN_ON(phy->nrssi[1] == -1000);\n\t\t\tb43legacy_calc_nrssi_threshold(dev);\n\t\t}\n\t}\n\tif (phy->radio_rev == 8)\n\t\tb43legacy_phy_write(dev, 0x0805, 0x3230);\n\tb43legacy_phy_init_pctl(dev);\n\tif (dev->dev->bus->chip_id == 0x4306\n\t    && dev->dev->bus->chip_package == 2) {\n\t\tb43legacy_phy_write(dev, 0x0429,\n\t\t\t\t    b43legacy_phy_read(dev, 0x0429) & 0xBFFF);\n\t\tb43legacy_phy_write(dev, 0x04C3,\n\t\t\t\t    b43legacy_phy_read(dev, 0x04C3) & 0x7FFF);\n\t}\n}\n\nstatic u16 b43legacy_phy_lo_b_r15_loop(struct b43legacy_wldev *dev)\n{\n\tint i;\n\tu16 ret = 0;\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\tfor (i = 0; i < 10; i++) {\n\t\tb43legacy_phy_write(dev, 0x0015, 0xAFA0);\n\t\tudelay(1);\n\t\tb43legacy_phy_write(dev, 0x0015, 0xEFA0);\n\t\tudelay(10);\n\t\tb43legacy_phy_write(dev, 0x0015, 0xFFA0);\n\t\tudelay(40);\n\t\tret += b43legacy_phy_read(dev, 0x002C);\n\t}\n\tlocal_irq_restore(flags);\n\tcond_resched();\n\n\treturn ret;\n}\n\nvoid b43legacy_phy_lo_b_measure(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 regstack[12] = { 0 };\n\tu16 mls;\n\ts16 fval;\n\tint i;\n\tint j;\n\n\tregstack[0] = b43legacy_phy_read(dev, 0x0015);\n\tregstack[1] = b43legacy_radio_read16(dev, 0x0052) & 0xFFF0;\n\n\tif (phy->radio_ver == 0x2053) {\n\t\tregstack[2] = b43legacy_phy_read(dev, 0x000A);\n\t\tregstack[3] = b43legacy_phy_read(dev, 0x002A);\n\t\tregstack[4] = b43legacy_phy_read(dev, 0x0035);\n\t\tregstack[5] = b43legacy_phy_read(dev, 0x0003);\n\t\tregstack[6] = b43legacy_phy_read(dev, 0x0001);\n\t\tregstack[7] = b43legacy_phy_read(dev, 0x0030);\n\n\t\tregstack[8] = b43legacy_radio_read16(dev, 0x0043);\n\t\tregstack[9] = b43legacy_radio_read16(dev, 0x007A);\n\t\tregstack[10] = b43legacy_read16(dev, 0x03EC);\n\t\tregstack[11] = b43legacy_radio_read16(dev, 0x0052) & 0x00F0;\n\n\t\tb43legacy_phy_write(dev, 0x0030, 0x00FF);\n\t\tb43legacy_write16(dev, 0x03EC, 0x3F3F);\n\t\tb43legacy_phy_write(dev, 0x0035, regstack[4] & 0xFF7F);\n\t\tb43legacy_radio_write16(dev, 0x007A, regstack[9] & 0xFFF0);\n\t}\n\tb43legacy_phy_write(dev, 0x0015, 0xB000);\n\tb43legacy_phy_write(dev, 0x002B, 0x0004);\n\n\tif (phy->radio_ver == 0x2053) {\n\t\tb43legacy_phy_write(dev, 0x002B, 0x0203);\n\t\tb43legacy_phy_write(dev, 0x002A, 0x08A3);\n\t}\n\n\tphy->minlowsig[0] = 0xFFFF;\n\n\tfor (i = 0; i < 4; i++) {\n\t\tb43legacy_radio_write16(dev, 0x0052, regstack[1] | i);\n\t\tb43legacy_phy_lo_b_r15_loop(dev);\n\t}\n\tfor (i = 0; i < 10; i++) {\n\t\tb43legacy_radio_write16(dev, 0x0052, regstack[1] | i);\n\t\tmls = b43legacy_phy_lo_b_r15_loop(dev) / 10;\n\t\tif (mls < phy->minlowsig[0]) {\n\t\t\tphy->minlowsig[0] = mls;\n\t\t\tphy->minlowsigpos[0] = i;\n\t\t}\n\t}\n\tb43legacy_radio_write16(dev, 0x0052, regstack[1]\n\t\t\t\t| phy->minlowsigpos[0]);\n\n\tphy->minlowsig[1] = 0xFFFF;\n\n\tfor (i = -4; i < 5; i += 2) {\n\t\tfor (j = -4; j < 5; j += 2) {\n\t\t\tif (j < 0)\n\t\t\t\tfval = (0x0100 * i) + j + 0x0100;\n\t\t\telse\n\t\t\t\tfval = (0x0100 * i) + j;\n\t\t\tb43legacy_phy_write(dev, 0x002F, fval);\n\t\t\tmls = b43legacy_phy_lo_b_r15_loop(dev) / 10;\n\t\t\tif (mls < phy->minlowsig[1]) {\n\t\t\t\tphy->minlowsig[1] = mls;\n\t\t\t\tphy->minlowsigpos[1] = fval;\n\t\t\t}\n\t\t}\n\t}\n\tphy->minlowsigpos[1] += 0x0101;\n\n\tb43legacy_phy_write(dev, 0x002F, phy->minlowsigpos[1]);\n\tif (phy->radio_ver == 0x2053) {\n\t\tb43legacy_phy_write(dev, 0x000A, regstack[2]);\n\t\tb43legacy_phy_write(dev, 0x002A, regstack[3]);\n\t\tb43legacy_phy_write(dev, 0x0035, regstack[4]);\n\t\tb43legacy_phy_write(dev, 0x0003, regstack[5]);\n\t\tb43legacy_phy_write(dev, 0x0001, regstack[6]);\n\t\tb43legacy_phy_write(dev, 0x0030, regstack[7]);\n\n\t\tb43legacy_radio_write16(dev, 0x0043, regstack[8]);\n\t\tb43legacy_radio_write16(dev, 0x007A, regstack[9]);\n\n\t\tb43legacy_radio_write16(dev, 0x0052,\n\t\t\t\t\t(b43legacy_radio_read16(dev, 0x0052)\n\t\t\t\t\t& 0x000F) | regstack[11]);\n\n\t\tb43legacy_write16(dev, 0x03EC, regstack[10]);\n\t}\n\tb43legacy_phy_write(dev, 0x0015, regstack[0]);\n}\n\nstatic inline\nu16 b43legacy_phy_lo_g_deviation_subval(struct b43legacy_wldev *dev,\n\t\t\t\t\tu16 control)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 ret;\n\tunsigned long flags;\n\n\tlocal_irq_save(flags);\n\tif (phy->gmode) {\n\t\tb43legacy_phy_write(dev, 0x15, 0xE300);\n\t\tcontrol <<= 8;\n\t\tb43legacy_phy_write(dev, 0x0812, control | 0x00B0);\n\t\tudelay(5);\n\t\tb43legacy_phy_write(dev, 0x0812, control | 0x00B2);\n\t\tudelay(2);\n\t\tb43legacy_phy_write(dev, 0x0812, control | 0x00B3);\n\t\tudelay(4);\n\t\tb43legacy_phy_write(dev, 0x0015, 0xF300);\n\t\tudelay(8);\n\t} else {\n\t\tb43legacy_phy_write(dev, 0x0015, control | 0xEFA0);\n\t\tudelay(2);\n\t\tb43legacy_phy_write(dev, 0x0015, control | 0xEFE0);\n\t\tudelay(4);\n\t\tb43legacy_phy_write(dev, 0x0015, control | 0xFFE0);\n\t\tudelay(8);\n\t}\n\tret = b43legacy_phy_read(dev, 0x002D);\n\tlocal_irq_restore(flags);\n\tcond_resched();\n\n\treturn ret;\n}\n\nstatic u32 b43legacy_phy_lo_g_singledeviation(struct b43legacy_wldev *dev,\n\t\t\t\t\t      u16 control)\n{\n\tint i;\n\tu32 ret = 0;\n\n\tfor (i = 0; i < 8; i++)\n\t\tret += b43legacy_phy_lo_g_deviation_subval(dev, control);\n\n\treturn ret;\n}\n\n \nstatic inline\nvoid b43legacy_lo_write(struct b43legacy_wldev *dev,\n\t\t\tstruct b43legacy_lopair *pair)\n{\n\tu16 value;\n\n\tvalue = (u8)(pair->low);\n\tvalue |= ((u8)(pair->high)) << 8;\n\n#ifdef CONFIG_B43LEGACY_DEBUG\n\t \n\tif (pair->low < -8 || pair->low > 8 ||\n\t    pair->high < -8 || pair->high > 8) {\n\t\tb43legacydbg(dev->wl,\n\t\t       \"WARNING: Writing invalid LOpair \"\n\t\t       \"(low: %d, high: %d)\\n\",\n\t\t       pair->low, pair->high);\n\t\tdump_stack();\n\t}\n#endif\n\n\tb43legacy_phy_write(dev, B43legacy_PHY_G_LO_CONTROL, value);\n}\n\nstatic inline\nstruct b43legacy_lopair *b43legacy_find_lopair(struct b43legacy_wldev *dev,\n\t\t\t\t\t       u16 bbatt,\n\t\t\t\t\t       u16 rfatt,\n\t\t\t\t\t       u16 tx)\n{\n\tstatic const u8 dict[10] = { 11, 10, 11, 12, 13, 12, 13, 12, 13, 12 };\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\tif (bbatt > 6)\n\t\tbbatt = 6;\n\tB43legacy_WARN_ON(rfatt >= 10);\n\n\tif (tx == 3)\n\t\treturn b43legacy_get_lopair(phy, rfatt, bbatt);\n\treturn b43legacy_get_lopair(phy, dict[rfatt], bbatt);\n}\n\nstatic inline\nstruct b43legacy_lopair *b43legacy_current_lopair(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\n\treturn b43legacy_find_lopair(dev, phy->bbatt,\n\t\t\t\t     phy->rfatt, phy->txctl1);\n}\n\n \nvoid b43legacy_phy_lo_adjust(struct b43legacy_wldev *dev, int fixed)\n{\n\tstruct b43legacy_lopair *pair;\n\n\tif (fixed) {\n\t\t \n\t\tpair = b43legacy_find_lopair(dev, 2, 3, 0);\n\t} else\n\t\tpair = b43legacy_current_lopair(dev);\n\tb43legacy_lo_write(dev, pair);\n}\n\nstatic void b43legacy_phy_lo_g_measure_txctl2(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 txctl2 = 0;\n\tu16 i;\n\tu32 smallest;\n\tu32 tmp;\n\n\tb43legacy_radio_write16(dev, 0x0052, 0x0000);\n\tudelay(10);\n\tsmallest = b43legacy_phy_lo_g_singledeviation(dev, 0);\n\tfor (i = 0; i < 16; i++) {\n\t\tb43legacy_radio_write16(dev, 0x0052, i);\n\t\tudelay(10);\n\t\ttmp = b43legacy_phy_lo_g_singledeviation(dev, 0);\n\t\tif (tmp < smallest) {\n\t\t\tsmallest = tmp;\n\t\t\ttxctl2 = i;\n\t\t}\n\t}\n\tphy->txctl2 = txctl2;\n}\n\nstatic\nvoid b43legacy_phy_lo_g_state(struct b43legacy_wldev *dev,\n\t\t\t      const struct b43legacy_lopair *in_pair,\n\t\t\t      struct b43legacy_lopair *out_pair,\n\t\t\t      u16 r27)\n{\n\tstatic const struct b43legacy_lopair transitions[8] = {\n\t\t{ .high =  1,  .low =  1, },\n\t\t{ .high =  1,  .low =  0, },\n\t\t{ .high =  1,  .low = -1, },\n\t\t{ .high =  0,  .low = -1, },\n\t\t{ .high = -1,  .low = -1, },\n\t\t{ .high = -1,  .low =  0, },\n\t\t{ .high = -1,  .low =  1, },\n\t\t{ .high =  0,  .low =  1, },\n\t};\n\tstruct b43legacy_lopair lowest_transition = {\n\t\t.high = in_pair->high,\n\t\t.low = in_pair->low,\n\t};\n\tstruct b43legacy_lopair tmp_pair;\n\tstruct b43legacy_lopair transition;\n\tint i = 12;\n\tint state = 0;\n\tint found_lower;\n\tint j;\n\tint begin;\n\tint end;\n\tu32 lowest_deviation;\n\tu32 tmp;\n\n\t \n\n\tb43legacy_lo_write(dev, &lowest_transition);\n\tlowest_deviation = b43legacy_phy_lo_g_singledeviation(dev, r27);\n\tdo {\n\t\tfound_lower = 0;\n\t\tB43legacy_WARN_ON(!(state >= 0 && state <= 8));\n\t\tif (state == 0) {\n\t\t\tbegin = 1;\n\t\t\tend = 8;\n\t\t} else if (state % 2 == 0) {\n\t\t\tbegin = state - 1;\n\t\t\tend = state + 1;\n\t\t} else {\n\t\t\tbegin = state - 2;\n\t\t\tend = state + 2;\n\t\t}\n\t\tif (begin < 1)\n\t\t\tbegin += 8;\n\t\tif (end > 8)\n\t\t\tend -= 8;\n\n\t\tj = begin;\n\t\ttmp_pair.high = lowest_transition.high;\n\t\ttmp_pair.low = lowest_transition.low;\n\t\twhile (1) {\n\t\t\tB43legacy_WARN_ON(!(j >= 1 && j <= 8));\n\t\t\ttransition.high = tmp_pair.high +\n\t\t\t\t\t  transitions[j - 1].high;\n\t\t\ttransition.low = tmp_pair.low + transitions[j - 1].low;\n\t\t\tif ((abs(transition.low) < 9)\n\t\t\t     && (abs(transition.high) < 9)) {\n\t\t\t\tb43legacy_lo_write(dev, &transition);\n\t\t\t\ttmp = b43legacy_phy_lo_g_singledeviation(dev,\n\t\t\t\t\t\t\t\t       r27);\n\t\t\t\tif (tmp < lowest_deviation) {\n\t\t\t\t\tlowest_deviation = tmp;\n\t\t\t\t\tstate = j;\n\t\t\t\t\tfound_lower = 1;\n\n\t\t\t\t\tlowest_transition.high =\n\t\t\t\t\t\t\t\ttransition.high;\n\t\t\t\t\tlowest_transition.low = transition.low;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (j == end)\n\t\t\t\tbreak;\n\t\t\tif (j == 8)\n\t\t\t\tj = 1;\n\t\t\telse\n\t\t\t\tj++;\n\t\t}\n\t} while (i-- && found_lower);\n\n\tout_pair->high = lowest_transition.high;\n\tout_pair->low = lowest_transition.low;\n}\n\n \nvoid b43legacy_phy_set_baseband_attenuation(struct b43legacy_wldev *dev,\n\t\t\t\t\t    u16 bbatt)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 value;\n\n\tif (phy->analog == 0) {\n\t\tvalue = (b43legacy_read16(dev, 0x03E6) & 0xFFF0);\n\t\tvalue |= (bbatt & 0x000F);\n\t\tb43legacy_write16(dev, 0x03E6, value);\n\t\treturn;\n\t}\n\n\tif (phy->analog > 1) {\n\t\tvalue = b43legacy_phy_read(dev, 0x0060) & 0xFFC3;\n\t\tvalue |= (bbatt << 2) & 0x003C;\n\t} else {\n\t\tvalue = b43legacy_phy_read(dev, 0x0060) & 0xFF87;\n\t\tvalue |= (bbatt << 3) & 0x0078;\n\t}\n\tb43legacy_phy_write(dev, 0x0060, value);\n}\n\n \n\tu8 r27 = 0;\n\tu16 r31;\n\n\toldchannel = phy->channel;\n\t \n\tif (phy->gmode) {\n\t\tregstack[0] = b43legacy_phy_read(dev, B43legacy_PHY_G_CRS);\n\t\tregstack[1] = b43legacy_phy_read(dev, 0x0802);\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS, regstack[0]\n\t\t\t\t    & 0x7FFF);\n\t\tb43legacy_phy_write(dev, 0x0802, regstack[1] & 0xFFFC);\n\t}\n\tregstack[3] = b43legacy_read16(dev, 0x03E2);\n\tb43legacy_write16(dev, 0x03E2, regstack[3] | 0x8000);\n\tregstack[4] = b43legacy_read16(dev, B43legacy_MMIO_CHANNEL_EXT);\n\tregstack[5] = b43legacy_phy_read(dev, 0x15);\n\tregstack[6] = b43legacy_phy_read(dev, 0x2A);\n\tregstack[7] = b43legacy_phy_read(dev, 0x35);\n\tregstack[8] = b43legacy_phy_read(dev, 0x60);\n\tregstack[9] = b43legacy_radio_read16(dev, 0x43);\n\tregstack[10] = b43legacy_radio_read16(dev, 0x7A);\n\tregstack[11] = b43legacy_radio_read16(dev, 0x52);\n\tif (phy->gmode) {\n\t\tregstack[12] = b43legacy_phy_read(dev, 0x0811);\n\t\tregstack[13] = b43legacy_phy_read(dev, 0x0812);\n\t\tregstack[14] = b43legacy_phy_read(dev, 0x0814);\n\t\tregstack[15] = b43legacy_phy_read(dev, 0x0815);\n\t}\n\tb43legacy_radio_selectchannel(dev, 6, 0);\n\tif (phy->gmode) {\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS, regstack[0]\n\t\t\t\t    & 0x7FFF);\n\t\tb43legacy_phy_write(dev, 0x0802, regstack[1] & 0xFFFC);\n\t\tb43legacy_dummy_transmission(dev);\n\t}\n\tb43legacy_radio_write16(dev, 0x0043, 0x0006);\n\n\tb43legacy_phy_set_baseband_attenuation(dev, 2);\n\n\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL_EXT, 0x0000);\n\tb43legacy_phy_write(dev, 0x002E, 0x007F);\n\tb43legacy_phy_write(dev, 0x080F, 0x0078);\n\tb43legacy_phy_write(dev, 0x0035, regstack[7] & ~(1 << 7));\n\tb43legacy_radio_write16(dev, 0x007A, regstack[10] & 0xFFF0);\n\tb43legacy_phy_write(dev, 0x002B, 0x0203);\n\tb43legacy_phy_write(dev, 0x002A, 0x08A3);\n\tif (phy->gmode) {\n\t\tb43legacy_phy_write(dev, 0x0814, regstack[14] | 0x0003);\n\t\tb43legacy_phy_write(dev, 0x0815, regstack[15] & 0xFFFC);\n\t\tb43legacy_phy_write(dev, 0x0811, 0x01B3);\n\t\tb43legacy_phy_write(dev, 0x0812, 0x00B2);\n\t}\n\tif (is_initializing)\n\t\tb43legacy_phy_lo_g_measure_txctl2(dev);\n\tb43legacy_phy_write(dev, 0x080F, 0x8078);\n\n\t \n\tcontrol.low = 0;\n\tcontrol.high = 0;\n\tfor (h = 0; h < 10; h++) {\n\t\t \n\t\ti = pairorder[h];\n\t\tif (is_initializing) {\n\t\t\tif (i == 3) {\n\t\t\t\tcontrol.low = 0;\n\t\t\t\tcontrol.high = 0;\n\t\t\t} else if (((i % 2 == 1) && (oldi % 2 == 1)) ||\n\t\t\t\t  ((i % 2 == 0) && (oldi % 2 == 0))) {\n\t\t\t\ttmp_control = b43legacy_get_lopair(phy, oldi,\n\t\t\t\t\t\t\t\t   0);\n\t\t\t\tmemcpy(&control, tmp_control, sizeof(control));\n\t\t\t} else {\n\t\t\t\ttmp_control = b43legacy_get_lopair(phy, 3, 0);\n\t\t\t\tmemcpy(&control, tmp_control, sizeof(control));\n\t\t\t}\n\t\t}\n\t\t \n\t\tfor (j = 0; j < 4; j++) {\n\t\t\tif (is_initializing) {\n\t\t\t\ttmp = i * 2 + j;\n\t\t\t\tr27 = 0;\n\t\t\t\tr31 = 0;\n\t\t\t\tif (tmp > 14) {\n\t\t\t\t\tr31 = 1;\n\t\t\t\t\tif (tmp > 17)\n\t\t\t\t\t\tr27 = 1;\n\t\t\t\t\tif (tmp > 19)\n\t\t\t\t\t\tr27 = 2;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\ttmp_control = b43legacy_get_lopair(phy, i,\n\t\t\t\t\t\t\t\t   j * 2);\n\t\t\t\tif (!tmp_control->used)\n\t\t\t\t\tcontinue;\n\t\t\t\tmemcpy(&control, tmp_control, sizeof(control));\n\t\t\t\tr27 = 3;\n\t\t\t\tr31 = 0;\n\t\t\t}\n\t\t\tb43legacy_radio_write16(dev, 0x43, i);\n\t\t\tb43legacy_radio_write16(dev, 0x52, phy->txctl2);\n\t\t\tudelay(10);\n\t\t\tcond_resched();\n\n\t\t\tb43legacy_phy_set_baseband_attenuation(dev, j * 2);\n\n\t\t\ttmp = (regstack[10] & 0xFFF0);\n\t\t\tif (r31)\n\t\t\t\ttmp |= 0x0008;\n\t\t\tb43legacy_radio_write16(dev, 0x007A, tmp);\n\n\t\t\ttmp_control = b43legacy_get_lopair(phy, i, j * 2);\n\t\t\tb43legacy_phy_lo_g_state(dev, &control, tmp_control,\n\t\t\t\t\t\t r27);\n\t\t}\n\t\toldi = i;\n\t}\n\t \n\tfor (i = 10; i < 14; i++) {\n\t\t \n\t\tfor (j = 0; j < 4; j++) {\n\t\t\tif (is_initializing) {\n\t\t\t\ttmp_control = b43legacy_get_lopair(phy, i - 9,\n\t\t\t\t\t\t\t\t j * 2);\n\t\t\t\tmemcpy(&control, tmp_control, sizeof(control));\n\t\t\t\t \n\t\t\t\ttmp = (i - 9) * 2 + j - 5;\n\t\t\t\tr27 = 0;\n\t\t\t\tr31 = 0;\n\t\t\t\tif (tmp > 14) {\n\t\t\t\t\tr31 = 1;\n\t\t\t\t\tif (tmp > 17)\n\t\t\t\t\t\tr27 = 1;\n\t\t\t\t\tif (tmp > 19)\n\t\t\t\t\t\tr27 = 2;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\ttmp_control = b43legacy_get_lopair(phy, i - 9,\n\t\t\t\t\t\t\t\t   j * 2);\n\t\t\t\tif (!tmp_control->used)\n\t\t\t\t\tcontinue;\n\t\t\t\tmemcpy(&control, tmp_control, sizeof(control));\n\t\t\t\tr27 = 3;\n\t\t\t\tr31 = 0;\n\t\t\t}\n\t\t\tb43legacy_radio_write16(dev, 0x43, i - 9);\n\t\t\t \n\t\t\tb43legacy_radio_write16(dev, 0x52,\n\t\t\t\t\t      phy->txctl2\n\t\t\t\t\t      | (3  << 4));\n\t\t\tudelay(10);\n\t\t\tcond_resched();\n\n\t\t\tb43legacy_phy_set_baseband_attenuation(dev, j * 2);\n\n\t\t\ttmp = (regstack[10] & 0xFFF0);\n\t\t\tif (r31)\n\t\t\t\ttmp |= 0x0008;\n\t\t\tb43legacy_radio_write16(dev, 0x7A, tmp);\n\n\t\t\ttmp_control = b43legacy_get_lopair(phy, i, j * 2);\n\t\t\tb43legacy_phy_lo_g_state(dev, &control, tmp_control,\n\t\t\t\t\t\t r27);\n\t\t}\n\t}\n\n\t \n\tif (phy->gmode) {\n\t\tb43legacy_phy_write(dev, 0x0015, 0xE300);\n\t\tb43legacy_phy_write(dev, 0x0812, (r27 << 8) | 0xA0);\n\t\tudelay(5);\n\t\tb43legacy_phy_write(dev, 0x0812, (r27 << 8) | 0xA2);\n\t\tudelay(2);\n\t\tb43legacy_phy_write(dev, 0x0812, (r27 << 8) | 0xA3);\n\t\tcond_resched();\n\t} else\n\t\tb43legacy_phy_write(dev, 0x0015, r27 | 0xEFA0);\n\tb43legacy_phy_lo_adjust(dev, is_initializing);\n\tb43legacy_phy_write(dev, 0x002E, 0x807F);\n\tif (phy->gmode)\n\t\tb43legacy_phy_write(dev, 0x002F, 0x0202);\n\telse\n\t\tb43legacy_phy_write(dev, 0x002F, 0x0101);\n\tb43legacy_write16(dev, B43legacy_MMIO_CHANNEL_EXT, regstack[4]);\n\tb43legacy_phy_write(dev, 0x0015, regstack[5]);\n\tb43legacy_phy_write(dev, 0x002A, regstack[6]);\n\tb43legacy_phy_write(dev, 0x0035, regstack[7]);\n\tb43legacy_phy_write(dev, 0x0060, regstack[8]);\n\tb43legacy_radio_write16(dev, 0x0043, regstack[9]);\n\tb43legacy_radio_write16(dev, 0x007A, regstack[10]);\n\tregstack[11] &= 0x00F0;\n\tregstack[11] |= (b43legacy_radio_read16(dev, 0x52) & 0x000F);\n\tb43legacy_radio_write16(dev, 0x52, regstack[11]);\n\tb43legacy_write16(dev, 0x03E2, regstack[3]);\n\tif (phy->gmode) {\n\t\tb43legacy_phy_write(dev, 0x0811, regstack[12]);\n\t\tb43legacy_phy_write(dev, 0x0812, regstack[13]);\n\t\tb43legacy_phy_write(dev, 0x0814, regstack[14]);\n\t\tb43legacy_phy_write(dev, 0x0815, regstack[15]);\n\t\tb43legacy_phy_write(dev, B43legacy_PHY_G_CRS, regstack[0]);\n\t\tb43legacy_phy_write(dev, 0x0802, regstack[1]);\n\t}\n\tb43legacy_radio_selectchannel(dev, oldchannel, 1);\n\n#ifdef CONFIG_B43LEGACY_DEBUG\n\t{\n\t\t \n\t\tfor (i = 0; i < B43legacy_LO_COUNT; i++) {\n\t\t\ttmp_control = phy->_lo_pairs + i;\n\t\t\tif (tmp_control->low < -8 || tmp_control->low > 8 ||\n\t\t\t    tmp_control->high < -8 || tmp_control->high > 8)\n\t\t\t\tb43legacywarn(dev->wl,\n\t\t\t\t       \"WARNING: Invalid LOpair (low: %d, high:\"\n\t\t\t\t       \" %d, index: %d)\\n\",\n\t\t\t\t       tmp_control->low, tmp_control->high, i);\n\t\t}\n\t}\n#endif  \n}\n\nstatic\nvoid b43legacy_phy_lo_mark_current_used(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_lopair *pair;\n\n\tpair = b43legacy_current_lopair(dev);\n\tpair->used = 1;\n}\n\nvoid b43legacy_phy_lo_mark_all_unused(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tstruct b43legacy_lopair *pair;\n\tint i;\n\n\tfor (i = 0; i < B43legacy_LO_COUNT; i++) {\n\t\tpair = phy->_lo_pairs + i;\n\t\tpair->used = 0;\n\t}\n}\n\n \nstatic s8 b43legacy_phy_estimate_power_out(struct b43legacy_wldev *dev, s8 tssi)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\ts8 dbm = 0;\n\ts32 tmp;\n\n\ttmp = phy->idle_tssi;\n\ttmp += tssi;\n\ttmp -= phy->savedpctlreg;\n\n\tswitch (phy->type) {\n\tcase B43legacy_PHYTYPE_B:\n\tcase B43legacy_PHYTYPE_G:\n\t\ttmp = clamp_val(tmp, 0x00, 0x3F);\n\t\tdbm = phy->tssi2dbm[tmp];\n\t\tbreak;\n\tdefault:\n\t\tB43legacy_BUG_ON(1);\n\t}\n\n\treturn dbm;\n}\n\n \n\t\tdev->dev->bus->sprom.maxpwr_bg = max_pwr;\n\t}\n\n\t \n#define REG_MAX_PWR 20\n\tmax_pwr = min(REG_MAX_PWR * 4\n\t\t      - dev->dev->bus->sprom.antenna_gain.a0\n\t\t      - 0x6, max_pwr);\n\n\t \n\tdesired_pwr = clamp_val(phy->power_level << 2, 0, max_pwr);\n\tif (b43legacy_debug(dev, B43legacy_DBG_XMITPOWER))\n\t\tb43legacydbg(dev->wl, \"Current TX power output: \" Q52_FMT\n\t\t       \" dBm, Desired TX power output: \" Q52_FMT\n\t\t       \" dBm\\n\", Q52_ARG(estimated_pwr),\n\t\t       Q52_ARG(desired_pwr));\n\t \n\tpwr_adjust = (desired_pwr - estimated_pwr) / 2;\n\t \n\tradio_att_delta = -(pwr_adjust + 7) >> 3;\n\t \n\tbaseband_att_delta = -(pwr_adjust >> 1) - (4 * radio_att_delta);\n\t \n\tif ((radio_att_delta == 0) && (baseband_att_delta == 0)) {\n\t\tb43legacy_phy_lo_mark_current_used(dev);\n\t\treturn;\n\t}\n\n\t \n\tbaseband_attenuation = phy->bbatt;\n\tbaseband_attenuation += baseband_att_delta;\n\tradio_attenuation = phy->rfatt;\n\tradio_attenuation += radio_att_delta;\n\n\t \n\tif (radio_attenuation < 0) {\n\t\tbaseband_attenuation -= (4 * -radio_attenuation);\n\t\tradio_attenuation = 0;\n\t} else if (radio_attenuation > 9) {\n\t\tbaseband_attenuation += (4 * (radio_attenuation - 9));\n\t\tradio_attenuation = 9;\n\t} else {\n\t\twhile (baseband_attenuation < 0 && radio_attenuation > 0) {\n\t\t\tbaseband_attenuation += 4;\n\t\t\tradio_attenuation--;\n\t\t}\n\t\twhile (baseband_attenuation > 11 && radio_attenuation < 9) {\n\t\t\tbaseband_attenuation -= 4;\n\t\t\tradio_attenuation++;\n\t\t}\n\t}\n\tbaseband_attenuation = clamp_val(baseband_attenuation, 0, 11);\n\n\ttxpower = phy->txctl1;\n\tif ((phy->radio_ver == 0x2050) && (phy->radio_rev == 2)) {\n\t\tif (radio_attenuation <= 1) {\n\t\t\tif (txpower == 0) {\n\t\t\t\ttxpower = 3;\n\t\t\t\tradio_attenuation += 2;\n\t\t\t\tbaseband_attenuation += 2;\n\t\t\t} else if (dev->dev->bus->sprom.boardflags_lo\n\t\t\t\t   & B43legacy_BFL_PACTRL) {\n\t\t\t\tbaseband_attenuation += 4 *\n\t\t\t\t\t\t     (radio_attenuation - 2);\n\t\t\t\tradio_attenuation = 2;\n\t\t\t}\n\t\t} else if (radio_attenuation > 4 && txpower != 0) {\n\t\t\ttxpower = 0;\n\t\t\tif (baseband_attenuation < 3) {\n\t\t\t\tradio_attenuation -= 3;\n\t\t\t\tbaseband_attenuation += 2;\n\t\t\t} else {\n\t\t\t\tradio_attenuation -= 2;\n\t\t\t\tbaseband_attenuation -= 2;\n\t\t\t}\n\t\t}\n\t}\n\t \n\tphy->txctl1 = txpower;\n\tbaseband_attenuation = clamp_val(baseband_attenuation, 0, 11);\n\tradio_attenuation = clamp_val(radio_attenuation, 0, 9);\n\tphy->rfatt = radio_attenuation;\n\tphy->bbatt = baseband_attenuation;\n\n\t \n\tb43legacy_phy_lock(dev);\n\tb43legacy_radio_lock(dev);\n\tb43legacy_radio_set_txpower_bg(dev, baseband_attenuation,\n\t\t\t\t       radio_attenuation, txpower);\n\tb43legacy_phy_lo_mark_current_used(dev);\n\tb43legacy_radio_unlock(dev);\n\tb43legacy_phy_unlock(dev);\n}\n\nstatic inline\ns32 b43legacy_tssi2dbm_ad(s32 num, s32 den)\n{\n\tif (num < 0)\n\t\treturn num/den;\n\telse\n\t\treturn (num+den/2)/den;\n}\n\nstatic inline\ns8 b43legacy_tssi2dbm_entry(s8 entry [], u8 index, s16 pab0, s16 pab1, s16 pab2)\n{\n\ts32 m1;\n\ts32 m2;\n\ts32 f = 256;\n\ts32 q;\n\ts32 delta;\n\ts8 i = 0;\n\n\tm1 = b43legacy_tssi2dbm_ad(16 * pab0 + index * pab1, 32);\n\tm2 = max(b43legacy_tssi2dbm_ad(32768 + index * pab2, 256), 1);\n\tdo {\n\t\tif (i > 15)\n\t\t\treturn -EINVAL;\n\t\tq = b43legacy_tssi2dbm_ad(f * 4096 -\n\t\t\t\t\t  b43legacy_tssi2dbm_ad(m2 * f, 16) *\n\t\t\t\t\t  f, 2048);\n\t\tdelta = abs(q - f);\n\t\tf = q;\n\t\ti++;\n\t} while (delta >= 2);\n\tentry[index] = clamp_val(b43legacy_tssi2dbm_ad(m1 * f, 8192),\n\t\t\t\t   -127, 128);\n\treturn 0;\n}\n\n \n\t\tif ((s8)dev->dev->bus->sprom.itssi_bg != 0 &&\n\t\t    (s8)dev->dev->bus->sprom.itssi_bg != -1)\n\t\t\tphy->idle_tssi = (s8)(dev->dev->bus->sprom.\n\t\t\t\t\t  itssi_bg);\n\t\telse\n\t\t\tphy->idle_tssi = 62;\n\t\tdyn_tssi2dbm = kmalloc(64, GFP_KERNEL);\n\t\tif (dyn_tssi2dbm == NULL) {\n\t\t\tb43legacyerr(dev->wl, \"Could not allocate memory \"\n\t\t\t       \"for tssi2dbm table\\n\");\n\t\t\treturn -ENOMEM;\n\t\t}\n\t\tfor (idx = 0; idx < 64; idx++)\n\t\t\tif (b43legacy_tssi2dbm_entry(dyn_tssi2dbm, idx, pab0,\n\t\t\t\t\t\t     pab1, pab2)) {\n\t\t\t\tphy->tssi2dbm = NULL;\n\t\t\t\tb43legacyerr(dev->wl, \"Could not generate \"\n\t\t\t\t       \"tssi2dBm table\\n\");\n\t\t\t\tkfree(dyn_tssi2dbm);\n\t\t\t\treturn -ENODEV;\n\t\t\t}\n\t\tphy->tssi2dbm = dyn_tssi2dbm;\n\t\tphy->dyn_tssi_tbl = 1;\n\t} else {\n\t\t \n\t\tswitch (phy->type) {\n\t\tcase B43legacy_PHYTYPE_B:\n\t\t\tphy->idle_tssi = 0x34;\n\t\t\tphy->tssi2dbm = b43legacy_tssi2dbm_b_table;\n\t\t\tbreak;\n\t\tcase B43legacy_PHYTYPE_G:\n\t\t\tphy->idle_tssi = 0x34;\n\t\t\tphy->tssi2dbm = b43legacy_tssi2dbm_g_table;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nint b43legacy_phy_init(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tint err = -ENODEV;\n\n\tswitch (phy->type) {\n\tcase B43legacy_PHYTYPE_B:\n\t\tswitch (phy->rev) {\n\t\tcase 2:\n\t\t\tb43legacy_phy_initb2(dev);\n\t\t\terr = 0;\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\tb43legacy_phy_initb4(dev);\n\t\t\terr = 0;\n\t\t\tbreak;\n\t\tcase 5:\n\t\t\tb43legacy_phy_initb5(dev);\n\t\t\terr = 0;\n\t\t\tbreak;\n\t\tcase 6:\n\t\t\tb43legacy_phy_initb6(dev);\n\t\t\terr = 0;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase B43legacy_PHYTYPE_G:\n\t\tb43legacy_phy_initg(dev);\n\t\terr = 0;\n\t\tbreak;\n\t}\n\tif (err)\n\t\tb43legacyerr(dev->wl, \"Unknown PHYTYPE found\\n\");\n\n\treturn err;\n}\n\nvoid b43legacy_phy_set_antenna_diversity(struct b43legacy_wldev *dev)\n{\n\tstruct b43legacy_phy *phy = &dev->phy;\n\tu16 antennadiv;\n\tu16 offset;\n\tu16 value;\n\tu32 ucodeflags;\n\n\tantennadiv = phy->antenna_diversity;\n\n\tif (antennadiv == 0xFFFF)\n\t\tantennadiv = 3;\n\tB43legacy_WARN_ON(antennadiv > 3);\n\n\tucodeflags = b43legacy_shm_read32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t\t  B43legacy_UCODEFLAGS_OFFSET);\n\tb43legacy_shm_write32(dev, B43legacy_SHM_SHARED,\n\t\t\t      B43legacy_UCODEFLAGS_OFFSET,\n\t\t\t      ucodeflags & ~B43legacy_UCODEFLAG_AUTODIV);\n\n\tswitch (phy->type) {\n\tcase B43legacy_PHYTYPE_G:\n\t\toffset = 0x0400;\n\n\t\tif (antennadiv == 2)\n\t\t\tvalue = (3  << 7);\n\t\telse\n\t\t\tvalue = (antennadiv << 7);\n\t\tb43legacy_phy_write(dev, offset + 1,\n\t\t\t\t    (b43legacy_phy_read(dev, offset + 1)\n\t\t\t\t    & 0x7E7F) | value);\n\n\t\tif (antennadiv >= 2) {\n\t\t\tif (antennadiv == 2)\n\t\t\t\tvalue = (antennadiv << 7);\n\t\t\telse\n\t\t\t\tvalue = (0  << 7);\n\t\t\tb43legacy_phy_write(dev, offset + 0x2B,\n\t\t\t\t\t    (b43legacy_phy_read(dev,\n\t\t\t\t\t    offset + 0x2B)\n\t\t\t\t\t    & 0xFEFF) | value);\n\t\t}\n\n\t\tif (phy->type == B43legacy_PHYTYPE_G) {\n\t\t\tif (antennadiv >= 2)\n\t\t\t\tb43legacy_phy_write(dev, 0x048C,\n\t\t\t\t\t\t    b43legacy_phy_read(dev,\n\t\t\t\t\t\t    0x048C) | 0x2000);\n\t\t\telse\n\t\t\t\tb43legacy_phy_write(dev, 0x048C,\n\t\t\t\t\t\t    b43legacy_phy_read(dev,\n\t\t\t\t\t\t    0x048C) & ~0x2000);\n\t\t\tif (phy->rev >= 2) {\n\t\t\t\tb43legacy_phy_write(dev, 0x0461,\n\t\t\t\t\t\t    b43legacy_phy_read(dev,\n\t\t\t\t\t\t    0x0461) | 0x0010);\n\t\t\t\tb43legacy_phy_write(dev, 0x04AD,\n\t\t\t\t\t\t    (b43legacy_phy_read(dev,\n\t\t\t\t\t\t    0x04AD)\n\t\t\t\t\t\t    & 0x00FF) | 0x0015);\n\t\t\t\tif (phy->rev == 2)\n\t\t\t\t\tb43legacy_phy_write(dev, 0x0427,\n\t\t\t\t\t\t\t    0x0008);\n\t\t\t\telse\n\t\t\t\t\tb43legacy_phy_write(dev, 0x0427,\n\t\t\t\t\t\t(b43legacy_phy_read(dev, 0x0427)\n\t\t\t\t\t\t & 0x00FF) | 0x0008);\n\t\t\t} else if (phy->rev >= 6)\n\t\t\t\tb43legacy_phy_write(dev, 0x049B, 0x00DC);\n\t\t} else {\n\t\t\tif (phy->rev < 3)\n\t\t\t\tb43legacy_phy_write(dev, 0x002B,\n\t\t\t\t\t\t    (b43legacy_phy_read(dev,\n\t\t\t\t\t\t    0x002B) & 0x00FF)\n\t\t\t\t\t\t    | 0x0024);\n\t\t\telse {\n\t\t\t\tb43legacy_phy_write(dev, 0x0061,\n\t\t\t\t\t\t    b43legacy_phy_read(dev,\n\t\t\t\t\t\t    0x0061) | 0x0010);\n\t\t\t\tif (phy->rev == 3) {\n\t\t\t\t\tb43legacy_phy_write(dev, 0x0093,\n\t\t\t\t\t\t\t    0x001D);\n\t\t\t\t\tb43legacy_phy_write(dev, 0x0027,\n\t\t\t\t\t\t\t    0x0008);\n\t\t\t\t} else {\n\t\t\t\t\tb43legacy_phy_write(dev, 0x0093,\n\t\t\t\t\t\t\t    0x003A);\n\t\t\t\t\tb43legacy_phy_write(dev, 0x0027,\n\t\t\t\t\t\t(b43legacy_phy_read(dev, 0x0027)\n\t\t\t\t\t\t & 0x00FF) | 0x0008);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase B43legacy_PHYTYPE_B:\n\t\tif (dev->dev->id.revision == 2)\n\t\t\tvalue = (3  << 7);\n\t\telse\n\t\t\tvalue = (antennadiv << 7);\n\t\tb43legacy_phy_write(dev, 0x03E2,\n\t\t\t\t    (b43legacy_phy_read(dev, 0x03E2)\n\t\t\t\t    & 0xFE7F) | value);\n\t\tbreak;\n\tdefault:\n\t\tB43legacy_WARN_ON(1);\n\t}\n\n\tif (antennadiv >= 2) {\n\t\tucodeflags = b43legacy_shm_read32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t\t\t  B43legacy_UCODEFLAGS_OFFSET);\n\t\tb43legacy_shm_write32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t      B43legacy_UCODEFLAGS_OFFSET,\n\t\t\t\t      ucodeflags | B43legacy_UCODEFLAG_AUTODIV);\n\t}\n\n\tphy->antenna_diversity = antennadiv;\n}\n\n \nvoid b43legacy_power_saving_ctl_bits(struct b43legacy_wldev *dev,\n\t\t\t\t     int bit25, int bit26)\n{\n\tint i;\n\tu32 status;\n\n \nbit25 = 0;\nbit26 = 1;\n\n\tif (bit25 == -1) {\n\t\t \n\t}\n\tif (bit26 == -1) {\n\t\t \n\t}\n\tstatus = b43legacy_read32(dev, B43legacy_MMIO_MACCTL);\n\tif (bit25)\n\t\tstatus |= B43legacy_MACCTL_HWPS;\n\telse\n\t\tstatus &= ~B43legacy_MACCTL_HWPS;\n\tif (bit26)\n\t\tstatus |= B43legacy_MACCTL_AWAKE;\n\telse\n\t\tstatus &= ~B43legacy_MACCTL_AWAKE;\n\tb43legacy_write32(dev, B43legacy_MMIO_MACCTL, status);\n\tif (bit26 && dev->dev->id.revision >= 5) {\n\t\tfor (i = 0; i < 100; i++) {\n\t\t\tif (b43legacy_shm_read32(dev, B43legacy_SHM_SHARED,\n\t\t\t\t\t\t 0x0040) != 4)\n\t\t\t\tbreak;\n\t\t\tudelay(10);\n\t\t}\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}