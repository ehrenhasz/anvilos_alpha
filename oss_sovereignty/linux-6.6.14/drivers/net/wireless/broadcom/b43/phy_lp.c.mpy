{
  "module_name": "phy_lp.c",
  "hash_id": "eed9f3a7e559be3e5dfda94ddb45d5a605f051bf60f8953fd3e6630175d947a1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/b43/phy_lp.c",
  "human_readable_source": "\n \n\n#include <linux/cordic.h>\n#include <linux/slab.h>\n\n#include \"b43.h\"\n#include \"main.h\"\n#include \"phy_lp.h\"\n#include \"phy_common.h\"\n#include \"tables_lpphy.h\"\n\n\nstatic inline u16 channel2freq_lp(u8 channel)\n{\n\tif (channel < 14)\n\t\treturn (2407 + 5 * channel);\n\telse if (channel == 14)\n\t\treturn 2484;\n\telse if (channel < 184)\n\t\treturn (5000 + 5 * channel);\n\telse\n\t\treturn (4000 + 5 * channel);\n}\n\nstatic unsigned int b43_lpphy_op_get_default_chan(struct b43_wldev *dev)\n{\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\treturn 1;\n\treturn 36;\n}\n\nstatic int b43_lpphy_op_allocate(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy;\n\n\tlpphy = kzalloc(sizeof(*lpphy), GFP_KERNEL);\n\tif (!lpphy)\n\t\treturn -ENOMEM;\n\tdev->phy.lp = lpphy;\n\n\treturn 0;\n}\n\nstatic void b43_lpphy_op_prepare_structs(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_lp *lpphy = phy->lp;\n\n\tmemset(lpphy, 0, sizeof(*lpphy));\n\tlpphy->antenna = B43_ANTENNA_DEFAULT;\n\n\t\n}\n\nstatic void b43_lpphy_op_free(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\n\tkfree(lpphy);\n\tdev->phy.lp = NULL;\n}\n\n \n\t\tlpphy->tx_isolation_low_band = sprom->tri5gl;\n\t\tlpphy->tx_isolation_med_band = sprom->tri5g;\n\t\tlpphy->tx_isolation_hi_band = sprom->tri5gh;\n\t\tlpphy->bx_arch = sprom->bxa5g;\n\t\tlpphy->rx_pwr_offset = sprom->rxpo5g;\n\t\tlpphy->rssi_vf = sprom->rssismf5g;\n\t\tlpphy->rssi_vc = sprom->rssismc5g;\n\t\tlpphy->rssi_gs = sprom->rssisav5g;\n\t\tlpphy->txpa[0] = sprom->pa1b0;\n\t\tlpphy->txpa[1] = sprom->pa1b1;\n\t\tlpphy->txpa[2] = sprom->pa1b2;\n\t\tlpphy->txpal[0] = sprom->pa1lob0;\n\t\tlpphy->txpal[1] = sprom->pa1lob1;\n\t\tlpphy->txpal[2] = sprom->pa1lob2;\n\t\tlpphy->txpah[0] = sprom->pa1hib0;\n\t\tlpphy->txpah[1] = sprom->pa1hib1;\n\t\tlpphy->txpah[2] = sprom->pa1hib2;\n\t\tmaxpwr = sprom->maxpwr_al;\n\t\tofdmpo = sprom->ofdm5glpo;\n\t\tlpphy->max_tx_pwr_low_band = maxpwr;\n\t\tfor (i = 4; i < 12; i++) {\n\t\t\tlpphy->tx_max_ratel[i] = maxpwr - (ofdmpo & 0xF) * 2;\n\t\t\tofdmpo >>= 4;\n\t\t}\n\t\tmaxpwr = sprom->maxpwr_a;\n\t\tofdmpo = sprom->ofdm5gpo;\n\t\tlpphy->max_tx_pwr_med_band = maxpwr;\n\t\tfor (i = 4; i < 12; i++) {\n\t\t\tlpphy->tx_max_rate[i] = maxpwr - (ofdmpo & 0xF) * 2;\n\t\t\tofdmpo >>= 4;\n\t\t}\n\t\tmaxpwr = sprom->maxpwr_ah;\n\t\tofdmpo = sprom->ofdm5ghpo;\n\t\tlpphy->max_tx_pwr_hi_band = maxpwr;\n\t\tfor (i = 4; i < 12; i++) {\n\t\t\tlpphy->tx_max_rateh[i] = maxpwr - (ofdmpo & 0xF) * 2;\n\t\t\tofdmpo >>= 4;\n\t\t}\n\t}\n}\n\nstatic void lpphy_adjust_gain_table(struct b43_wldev *dev, u32 freq)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tu16 temp[3];\n\tu16 isolation;\n\n\tB43_WARN_ON(dev->phy.rev >= 2);\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\tisolation = lpphy->tx_isolation_med_band;\n\telse if (freq <= 5320)\n\t\tisolation = lpphy->tx_isolation_low_band;\n\telse if (freq <= 5700)\n\t\tisolation = lpphy->tx_isolation_med_band;\n\telse\n\t\tisolation = lpphy->tx_isolation_hi_band;\n\n\ttemp[0] = ((isolation - 26) / 12) << 12;\n\ttemp[1] = temp[0] + 0x1000;\n\ttemp[2] = temp[0] + 0x2000;\n\n\tb43_lptab_write_bulk(dev, B43_LPTAB16(13, 0), 3, temp);\n\tb43_lptab_write_bulk(dev, B43_LPTAB16(12, 0), 3, temp);\n}\n\nstatic void lpphy_table_init(struct b43_wldev *dev)\n{\n\tu32 freq = channel2freq_lp(b43_lpphy_op_get_default_chan(dev));\n\n\tif (dev->phy.rev < 2)\n\t\tlpphy_rev0_1_table_init(dev);\n\telse\n\t\tlpphy_rev2plus_table_init(dev);\n\n\tlpphy_init_tx_gain_table(dev);\n\n\tif (dev->phy.rev < 2)\n\t\tlpphy_adjust_gain_table(dev, freq);\n}\n\nstatic void lpphy_baseband_rev0_1_init(struct b43_wldev *dev)\n{\n\tstruct ssb_bus *bus = dev->dev->sdev->bus;\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tu16 tmp, tmp2;\n\n\tb43_phy_mask(dev, B43_LPPHY_AFE_DAC_CTL, 0xF7FF);\n\tb43_phy_write(dev, B43_LPPHY_AFE_CTL, 0);\n\tb43_phy_write(dev, B43_LPPHY_AFE_CTL_OVR, 0);\n\tb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_0, 0);\n\tb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_2, 0);\n\tb43_phy_set(dev, B43_LPPHY_AFE_DAC_CTL, 0x0004);\n\tb43_phy_maskset(dev, B43_LPPHY_OFDMSYNCTHRESH0, 0xFF00, 0x0078);\n\tb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0x83FF, 0x5800);\n\tb43_phy_write(dev, B43_LPPHY_ADC_COMPENSATION_CTL, 0x0016);\n\tb43_phy_maskset(dev, B43_LPPHY_AFE_ADC_CTL_0, 0xFFF8, 0x0004);\n\tb43_phy_maskset(dev, B43_LPPHY_VERYLOWGAINDB, 0x00FF, 0x5400);\n\tb43_phy_maskset(dev, B43_LPPHY_HIGAINDB, 0x00FF, 0x2400);\n\tb43_phy_maskset(dev, B43_LPPHY_LOWGAINDB, 0x00FF, 0x2100);\n\tb43_phy_maskset(dev, B43_LPPHY_VERYLOWGAINDB, 0xFF00, 0x0006);\n\tb43_phy_mask(dev, B43_LPPHY_RX_RADIO_CTL, 0xFFFE);\n\tb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0xFFE0, 0x0005);\n\tb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0xFC1F, 0x0180);\n\tb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0x83FF, 0x3C00);\n\tb43_phy_maskset(dev, B43_LPPHY_GAINDIRECTMISMATCH, 0xFFF0, 0x0005);\n\tb43_phy_maskset(dev, B43_LPPHY_GAIN_MISMATCH_LIMIT, 0xFFC0, 0x001A);\n\tb43_phy_maskset(dev, B43_LPPHY_CRS_ED_THRESH, 0xFF00, 0x00B3);\n\tb43_phy_maskset(dev, B43_LPPHY_CRS_ED_THRESH, 0x00FF, 0xAD00);\n\tb43_phy_maskset(dev, B43_LPPHY_INPUT_PWRDB,\n\t\t\t0xFF00, lpphy->rx_pwr_offset);\n\tif ((sprom->boardflags_lo & B43_BFL_FEM) &&\n\t   ((b43_current_band(dev->wl) == NL80211_BAND_5GHZ) ||\n\t   (sprom->boardflags_hi & B43_BFH_PAREF))) {\n\t\tssb_pmu_set_ldo_voltage(&bus->chipco, LDO_PAREF, 0x28);\n\t\tssb_pmu_set_ldo_paref(&bus->chipco, true);\n\t\tif (dev->phy.rev == 0) {\n\t\t\tb43_phy_maskset(dev, B43_LPPHY_LP_RF_SIGNAL_LUT,\n\t\t\t\t\t0xFFCF, 0x0010);\n\t\t}\n\t\tb43_lptab_write(dev, B43_LPTAB16(11, 7), 60);\n\t} else {\n\t\tssb_pmu_set_ldo_paref(&bus->chipco, false);\n\t\tb43_phy_maskset(dev, B43_LPPHY_LP_RF_SIGNAL_LUT,\n\t\t\t\t0xFFCF, 0x0020);\n\t\tb43_lptab_write(dev, B43_LPTAB16(11, 7), 100);\n\t}\n\ttmp = lpphy->rssi_vf | lpphy->rssi_vc << 4 | 0xA000;\n\tb43_phy_write(dev, B43_LPPHY_AFE_RSSI_CTL_0, tmp);\n\tif (sprom->boardflags_hi & B43_BFH_RSSIINV)\n\t\tb43_phy_maskset(dev, B43_LPPHY_AFE_RSSI_CTL_1, 0xF000, 0x0AAA);\n\telse\n\t\tb43_phy_maskset(dev, B43_LPPHY_AFE_RSSI_CTL_1, 0xF000, 0x02AA);\n\tb43_lptab_write(dev, B43_LPTAB16(11, 1), 24);\n\tb43_phy_maskset(dev, B43_LPPHY_RX_RADIO_CTL,\n\t\t\t0xFFF9, (lpphy->bx_arch << 1));\n\tif (dev->phy.rev == 1 &&\n\t   (sprom->boardflags_hi & B43_BFH_FEM_BT)) {\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xFFC0, 0x000A);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0x3F00, 0x0900);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xFFC0, 0x000A);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xC0FF, 0x0B00);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xFFC0, 0x000A);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xC0FF, 0x0400);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xFFC0, 0x000A);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xC0FF, 0x0B00);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_5, 0xFFC0, 0x000A);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_5, 0xC0FF, 0x0900);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_6, 0xFFC0, 0x000A);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_6, 0xC0FF, 0x0B00);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_7, 0xFFC0, 0x000A);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_7, 0xC0FF, 0x0900);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_8, 0xFFC0, 0x000A);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_8, 0xC0FF, 0x0B00);\n\t} else if (b43_current_band(dev->wl) == NL80211_BAND_5GHZ ||\n\t\t   (dev->dev->board_type == SSB_BOARD_BU4312) ||\n\t\t   (dev->phy.rev == 0 && (sprom->boardflags_lo & B43_BFL_FEM))) {\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xFFC0, 0x0001);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xC0FF, 0x0400);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xFFC0, 0x0001);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xC0FF, 0x0500);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xFFC0, 0x0002);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xC0FF, 0x0800);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xFFC0, 0x0002);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xC0FF, 0x0A00);\n\t} else if (dev->phy.rev == 1 ||\n\t\t  (sprom->boardflags_lo & B43_BFL_FEM)) {\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xFFC0, 0x0004);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xC0FF, 0x0800);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xFFC0, 0x0004);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xC0FF, 0x0C00);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xFFC0, 0x0002);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xC0FF, 0x0100);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xFFC0, 0x0002);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xC0FF, 0x0300);\n\t} else {\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xFFC0, 0x000A);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xC0FF, 0x0900);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xFFC0, 0x000A);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xC0FF, 0x0B00);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xFFC0, 0x0006);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xC0FF, 0x0500);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xFFC0, 0x0006);\n\t\tb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xC0FF, 0x0700);\n\t}\n\tif (dev->phy.rev == 1 && (sprom->boardflags_hi & B43_BFH_PAREF)) {\n\t\tb43_phy_copy(dev, B43_LPPHY_TR_LOOKUP_5, B43_LPPHY_TR_LOOKUP_1);\n\t\tb43_phy_copy(dev, B43_LPPHY_TR_LOOKUP_6, B43_LPPHY_TR_LOOKUP_2);\n\t\tb43_phy_copy(dev, B43_LPPHY_TR_LOOKUP_7, B43_LPPHY_TR_LOOKUP_3);\n\t\tb43_phy_copy(dev, B43_LPPHY_TR_LOOKUP_8, B43_LPPHY_TR_LOOKUP_4);\n\t}\n\tif ((sprom->boardflags_hi & B43_BFH_FEM_BT) &&\n\t    (dev->dev->chip_id == 0x5354) &&\n\t    (dev->dev->chip_pkg == SSB_CHIPPACK_BCM4712S)) {\n\t\tb43_phy_set(dev, B43_LPPHY_CRSGAIN_CTL, 0x0006);\n\t\tb43_phy_write(dev, B43_LPPHY_GPIO_SELECT, 0x0005);\n\t\tb43_phy_write(dev, B43_LPPHY_GPIO_OUTEN, 0xFFFF);\n\t\t\n\t\tb43_hf_write(dev, b43_hf_read(dev) | B43_HF_PR45960W);\n\t}\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\tb43_phy_set(dev, B43_LPPHY_LP_PHY_CTL, 0x8000);\n\t\tb43_phy_set(dev, B43_LPPHY_CRSGAIN_CTL, 0x0040);\n\t\tb43_phy_maskset(dev, B43_LPPHY_MINPWR_LEVEL, 0x00FF, 0xA400);\n\t\tb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL, 0xF0FF, 0x0B00);\n\t\tb43_phy_maskset(dev, B43_LPPHY_SYNCPEAKCNT, 0xFFF8, 0x0007);\n\t\tb43_phy_maskset(dev, B43_LPPHY_DSSS_CONFIRM_CNT, 0xFFF8, 0x0003);\n\t\tb43_phy_maskset(dev, B43_LPPHY_DSSS_CONFIRM_CNT, 0xFFC7, 0x0020);\n\t\tb43_phy_mask(dev, B43_LPPHY_IDLEAFTERPKTRXTO, 0x00FF);\n\t} else {  \n\t\tb43_phy_mask(dev, B43_LPPHY_LP_PHY_CTL, 0x7FFF);\n\t\tb43_phy_mask(dev, B43_LPPHY_CRSGAIN_CTL, 0xFFBF);\n\t}\n\tif (dev->phy.rev == 1) {\n\t\ttmp = b43_phy_read(dev, B43_LPPHY_CLIPCTRTHRESH);\n\t\ttmp2 = (tmp & 0x03E0) >> 5;\n\t\ttmp2 |= tmp2 << 5;\n\t\tb43_phy_write(dev, B43_LPPHY_4C3, tmp2);\n\t\ttmp = b43_phy_read(dev, B43_LPPHY_GAINDIRECTMISMATCH);\n\t\ttmp2 = (tmp & 0x1F00) >> 8;\n\t\ttmp2 |= tmp2 << 5;\n\t\tb43_phy_write(dev, B43_LPPHY_4C4, tmp2);\n\t\ttmp = b43_phy_read(dev, B43_LPPHY_VERYLOWGAINDB);\n\t\ttmp2 = tmp & 0x00FF;\n\t\ttmp2 |= tmp << 8;\n\t\tb43_phy_write(dev, B43_LPPHY_4C5, tmp2);\n\t}\n}\n\nstatic void lpphy_save_dig_flt_state(struct b43_wldev *dev)\n{\n\tstatic const u16 addr[] = {\n\t\tB43_PHY_OFDM(0xC1),\n\t\tB43_PHY_OFDM(0xC2),\n\t\tB43_PHY_OFDM(0xC3),\n\t\tB43_PHY_OFDM(0xC4),\n\t\tB43_PHY_OFDM(0xC5),\n\t\tB43_PHY_OFDM(0xC6),\n\t\tB43_PHY_OFDM(0xC7),\n\t\tB43_PHY_OFDM(0xC8),\n\t\tB43_PHY_OFDM(0xCF),\n\t};\n\n\tstatic const u16 coefs[] = {\n\t\t0xDE5E, 0xE832, 0xE331, 0x4D26,\n\t\t0x0026, 0x1420, 0x0020, 0xFE08,\n\t\t0x0008,\n\t};\n\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(addr); i++) {\n\t\tlpphy->dig_flt_state[i] = b43_phy_read(dev, addr[i]);\n\t\tb43_phy_write(dev, addr[i], coefs[i]);\n\t}\n}\n\nstatic void lpphy_restore_dig_flt_state(struct b43_wldev *dev)\n{\n\tstatic const u16 addr[] = {\n\t\tB43_PHY_OFDM(0xC1),\n\t\tB43_PHY_OFDM(0xC2),\n\t\tB43_PHY_OFDM(0xC3),\n\t\tB43_PHY_OFDM(0xC4),\n\t\tB43_PHY_OFDM(0xC5),\n\t\tB43_PHY_OFDM(0xC6),\n\t\tB43_PHY_OFDM(0xC7),\n\t\tB43_PHY_OFDM(0xC8),\n\t\tB43_PHY_OFDM(0xCF),\n\t};\n\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(addr); i++)\n\t\tb43_phy_write(dev, addr[i], lpphy->dig_flt_state[i]);\n}\n\nstatic void lpphy_baseband_rev2plus_init(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\n\tb43_phy_write(dev, B43_LPPHY_AFE_DAC_CTL, 0x50);\n\tb43_phy_write(dev, B43_LPPHY_AFE_CTL, 0x8800);\n\tb43_phy_write(dev, B43_LPPHY_AFE_CTL_OVR, 0);\n\tb43_phy_write(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0);\n\tb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_0, 0);\n\tb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_2, 0);\n\tb43_phy_write(dev, B43_PHY_OFDM(0xF9), 0);\n\tb43_phy_write(dev, B43_LPPHY_TR_LOOKUP_1, 0);\n\tb43_phy_set(dev, B43_LPPHY_ADC_COMPENSATION_CTL, 0x10);\n\tb43_phy_maskset(dev, B43_LPPHY_OFDMSYNCTHRESH0, 0xFF00, 0xB4);\n\tb43_phy_maskset(dev, B43_LPPHY_DCOFFSETTRANSIENT, 0xF8FF, 0x200);\n\tb43_phy_maskset(dev, B43_LPPHY_DCOFFSETTRANSIENT, 0xFF00, 0x7F);\n\tb43_phy_maskset(dev, B43_LPPHY_GAINDIRECTMISMATCH, 0xFF0F, 0x40);\n\tb43_phy_maskset(dev, B43_LPPHY_PREAMBLECONFIRMTO, 0xFF00, 0x2);\n\tb43_phy_mask(dev, B43_LPPHY_CRSGAIN_CTL, ~0x4000);\n\tb43_phy_mask(dev, B43_LPPHY_CRSGAIN_CTL, ~0x2000);\n\tb43_phy_set(dev, B43_PHY_OFDM(0x10A), 0x1);\n\tif (dev->dev->board_rev >= 0x18) {\n\t\tb43_lptab_write(dev, B43_LPTAB32(17, 65), 0xEC);\n\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0x10A), 0xFF01, 0x14);\n\t} else {\n\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0x10A), 0xFF01, 0x10);\n\t}\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xDF), 0xFF00, 0xF4);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xDF), 0x00FF, 0xF100);\n\tb43_phy_write(dev, B43_LPPHY_CLIPTHRESH, 0x48);\n\tb43_phy_maskset(dev, B43_LPPHY_HIGAINDB, 0xFF00, 0x46);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xE4), 0xFF00, 0x10);\n\tb43_phy_maskset(dev, B43_LPPHY_PWR_THRESH1, 0xFFF0, 0x9);\n\tb43_phy_mask(dev, B43_LPPHY_GAINDIRECTMISMATCH, ~0xF);\n\tb43_phy_maskset(dev, B43_LPPHY_VERYLOWGAINDB, 0x00FF, 0x5500);\n\tb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0xFC1F, 0xA0);\n\tb43_phy_maskset(dev, B43_LPPHY_GAINDIRECTMISMATCH, 0xE0FF, 0x300);\n\tb43_phy_maskset(dev, B43_LPPHY_HIGAINDB, 0x00FF, 0x2A00);\n\tif ((dev->dev->chip_id == 0x4325) && (dev->dev->chip_rev == 0)) {\n\t\tb43_phy_maskset(dev, B43_LPPHY_LOWGAINDB, 0x00FF, 0x2100);\n\t\tb43_phy_maskset(dev, B43_LPPHY_VERYLOWGAINDB, 0xFF00, 0xA);\n\t} else {\n\t\tb43_phy_maskset(dev, B43_LPPHY_LOWGAINDB, 0x00FF, 0x1E00);\n\t\tb43_phy_maskset(dev, B43_LPPHY_VERYLOWGAINDB, 0xFF00, 0xD);\n\t}\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xFE), 0xFFE0, 0x1F);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xFF), 0xFFE0, 0xC);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x100), 0xFF00, 0x19);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xFF), 0x03FF, 0x3C00);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xFE), 0xFC1F, 0x3E0);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xFF), 0xFFE0, 0xC);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x100), 0x00FF, 0x1900);\n\tb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0x83FF, 0x5800);\n\tb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0xFFE0, 0x12);\n\tb43_phy_maskset(dev, B43_LPPHY_GAINMISMATCH, 0x0FFF, 0x9000);\n\n\tif ((dev->dev->chip_id == 0x4325) && (dev->dev->chip_rev == 0)) {\n\t\tb43_lptab_write(dev, B43_LPTAB16(0x08, 0x14), 0);\n\t\tb43_lptab_write(dev, B43_LPTAB16(0x08, 0x12), 0x40);\n\t}\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\tb43_phy_set(dev, B43_LPPHY_CRSGAIN_CTL, 0x40);\n\t\tb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL, 0xF0FF, 0xB00);\n\t\tb43_phy_maskset(dev, B43_LPPHY_SYNCPEAKCNT, 0xFFF8, 0x6);\n\t\tb43_phy_maskset(dev, B43_LPPHY_MINPWR_LEVEL, 0x00FF, 0x9D00);\n\t\tb43_phy_maskset(dev, B43_LPPHY_MINPWR_LEVEL, 0xFF00, 0xA1);\n\t\tb43_phy_mask(dev, B43_LPPHY_IDLEAFTERPKTRXTO, 0x00FF);\n\t} else  \n\t\tb43_phy_mask(dev, B43_LPPHY_CRSGAIN_CTL, ~0x40);\n\n\tb43_phy_maskset(dev, B43_LPPHY_CRS_ED_THRESH, 0xFF00, 0xB3);\n\tb43_phy_maskset(dev, B43_LPPHY_CRS_ED_THRESH, 0x00FF, 0xAD00);\n\tb43_phy_maskset(dev, B43_LPPHY_INPUT_PWRDB, 0xFF00, lpphy->rx_pwr_offset);\n\tb43_phy_set(dev, B43_LPPHY_RESET_CTL, 0x44);\n\tb43_phy_write(dev, B43_LPPHY_RESET_CTL, 0x80);\n\tb43_phy_write(dev, B43_LPPHY_AFE_RSSI_CTL_0, 0xA954);\n\tb43_phy_write(dev, B43_LPPHY_AFE_RSSI_CTL_1,\n\t\t      0x2000 | ((u16)lpphy->rssi_gs << 10) |\n\t\t      ((u16)lpphy->rssi_vc << 4) | lpphy->rssi_vf);\n\n\tif ((dev->dev->chip_id == 0x4325) && (dev->dev->chip_rev == 0)) {\n\t\tb43_phy_set(dev, B43_LPPHY_AFE_ADC_CTL_0, 0x1C);\n\t\tb43_phy_maskset(dev, B43_LPPHY_AFE_CTL, 0x00FF, 0x8800);\n\t\tb43_phy_maskset(dev, B43_LPPHY_AFE_ADC_CTL_1, 0xFC3C, 0x0400);\n\t}\n\n\tlpphy_save_dig_flt_state(dev);\n}\n\nstatic void lpphy_baseband_init(struct b43_wldev *dev)\n{\n\tlpphy_table_init(dev);\n\tif (dev->phy.rev >= 2)\n\t\tlpphy_baseband_rev2plus_init(dev);\n\telse\n\t\tlpphy_baseband_rev0_1_init(dev);\n}\n\nstruct b2062_freqdata {\n\tu16 freq;\n\tu8 data[6];\n};\n\n \nstatic void lpphy_2062_init(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tstruct ssb_bus *bus = dev->dev->sdev->bus;\n\tu32 crystalfreq, tmp, ref;\n\tunsigned int i;\n\tconst struct b2062_freqdata *fd = NULL;\n\n\tstatic const struct b2062_freqdata freqdata_tab[] = {\n\t\t{ .freq = 12000, .data[0] =  6, .data[1] =  6, .data[2] =  6,\n\t\t\t\t .data[3] =  6, .data[4] = 10, .data[5] =  6, },\n\t\t{ .freq = 13000, .data[0] =  4, .data[1] =  4, .data[2] =  4,\n\t\t\t\t .data[3] =  4, .data[4] = 11, .data[5] =  7, },\n\t\t{ .freq = 14400, .data[0] =  3, .data[1] =  3, .data[2] =  3,\n\t\t\t\t .data[3] =  3, .data[4] = 12, .data[5] =  7, },\n\t\t{ .freq = 16200, .data[0] =  3, .data[1] =  3, .data[2] =  3,\n\t\t\t\t .data[3] =  3, .data[4] = 13, .data[5] =  8, },\n\t\t{ .freq = 18000, .data[0] =  2, .data[1] =  2, .data[2] =  2,\n\t\t\t\t .data[3] =  2, .data[4] = 14, .data[5] =  8, },\n\t\t{ .freq = 19200, .data[0] =  1, .data[1] =  1, .data[2] =  1,\n\t\t\t\t .data[3] =  1, .data[4] = 14, .data[5] =  9, },\n\t};\n\n\tb2062_upload_init_table(dev);\n\n\tb43_radio_write(dev, B2062_N_TX_CTL3, 0);\n\tb43_radio_write(dev, B2062_N_TX_CTL4, 0);\n\tb43_radio_write(dev, B2062_N_TX_CTL5, 0);\n\tb43_radio_write(dev, B2062_N_TX_CTL6, 0);\n\tb43_radio_write(dev, B2062_N_PDN_CTL0, 0x40);\n\tb43_radio_write(dev, B2062_N_PDN_CTL0, 0);\n\tb43_radio_write(dev, B2062_N_CALIB_TS, 0x10);\n\tb43_radio_write(dev, B2062_N_CALIB_TS, 0);\n\tif (dev->phy.rev > 0) {\n\t\tb43_radio_write(dev, B2062_S_BG_CTL1,\n\t\t\t(b43_radio_read(dev, B2062_N_COMM2) >> 1) | 0x80);\n\t}\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\tb43_radio_set(dev, B2062_N_TSSI_CTL0, 0x1);\n\telse\n\t\tb43_radio_mask(dev, B2062_N_TSSI_CTL0, ~0x1);\n\n\t \n\tcrystalfreq = bus->chipco.pmu.crystalfreq * 1000;\n\n\tB43_WARN_ON(!(bus->chipco.capabilities & SSB_CHIPCO_CAP_PMU));\n\tB43_WARN_ON(crystalfreq == 0);\n\n\tif (crystalfreq <= 30000000) {\n\t\tlpphy->pdiv = 1;\n\t\tb43_radio_mask(dev, B2062_S_RFPLL_CTL1, 0xFFFB);\n\t} else {\n\t\tlpphy->pdiv = 2;\n\t\tb43_radio_set(dev, B2062_S_RFPLL_CTL1, 0x4);\n\t}\n\n\ttmp = (((800000000 * lpphy->pdiv + crystalfreq) /\n\t      (2 * crystalfreq)) - 8) & 0xFF;\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL7, tmp);\n\n\ttmp = (((100 * crystalfreq + 16000000 * lpphy->pdiv) /\n\t      (32000000 * lpphy->pdiv)) - 1) & 0xFF;\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL18, tmp);\n\n\ttmp = (((2 * crystalfreq + 1000000 * lpphy->pdiv) /\n\t      (2000000 * lpphy->pdiv)) - 1) & 0xFF;\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL19, tmp);\n\n\tref = (1000 * lpphy->pdiv + 2 * crystalfreq) / (2000 * lpphy->pdiv);\n\tref &= 0xFFFF;\n\tfor (i = 0; i < ARRAY_SIZE(freqdata_tab); i++) {\n\t\tif (ref < freqdata_tab[i].freq) {\n\t\t\tfd = &freqdata_tab[i];\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (!fd)\n\t\tfd = &freqdata_tab[ARRAY_SIZE(freqdata_tab) - 1];\n\tb43dbg(dev->wl, \"b2062: Using crystal tab entry %u kHz.\\n\",\n\t       fd->freq);  \n\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL8,\n\t\t\t((u16)(fd->data[1]) << 4) | fd->data[0]);\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL9,\n\t\t\t((u16)(fd->data[3]) << 4) | fd->data[2]);\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL10, fd->data[4]);\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL11, fd->data[5]);\n}\n\n \nstatic void lpphy_2063_init(struct b43_wldev *dev)\n{\n\tb2063_upload_init_table(dev);\n\tb43_radio_write(dev, B2063_LOGEN_SP5, 0);\n\tb43_radio_set(dev, B2063_COMM8, 0x38);\n\tb43_radio_write(dev, B2063_REG_SP1, 0x56);\n\tb43_radio_mask(dev, B2063_RX_BB_CTL2, ~0x2);\n\tb43_radio_write(dev, B2063_PA_SP7, 0);\n\tb43_radio_write(dev, B2063_TX_RF_SP6, 0x20);\n\tb43_radio_write(dev, B2063_TX_RF_SP9, 0x40);\n\tif (dev->phy.rev == 2) {\n\t\tb43_radio_write(dev, B2063_PA_SP3, 0xa0);\n\t\tb43_radio_write(dev, B2063_PA_SP4, 0xa0);\n\t\tb43_radio_write(dev, B2063_PA_SP2, 0x18);\n\t} else {\n\t\tb43_radio_write(dev, B2063_PA_SP3, 0x20);\n\t\tb43_radio_write(dev, B2063_PA_SP2, 0x20);\n\t}\n}\n\nstruct lpphy_stx_table_entry {\n\tu16 phy_offset;\n\tu16 phy_shift;\n\tu16 rf_addr;\n\tu16 rf_shift;\n\tu16 mask;\n};\n\nstatic const struct lpphy_stx_table_entry lpphy_stx_table[] = {\n\t{ .phy_offset = 2, .phy_shift = 6, .rf_addr = 0x3d, .rf_shift = 3, .mask = 0x01, },\n\t{ .phy_offset = 1, .phy_shift = 12, .rf_addr = 0x4c, .rf_shift = 1, .mask = 0x01, },\n\t{ .phy_offset = 1, .phy_shift = 8, .rf_addr = 0x50, .rf_shift = 0, .mask = 0x7f, },\n\t{ .phy_offset = 0, .phy_shift = 8, .rf_addr = 0x44, .rf_shift = 0, .mask = 0xff, },\n\t{ .phy_offset = 1, .phy_shift = 0, .rf_addr = 0x4a, .rf_shift = 0, .mask = 0xff, },\n\t{ .phy_offset = 0, .phy_shift = 4, .rf_addr = 0x4d, .rf_shift = 0, .mask = 0xff, },\n\t{ .phy_offset = 1, .phy_shift = 4, .rf_addr = 0x4e, .rf_shift = 0, .mask = 0xff, },\n\t{ .phy_offset = 0, .phy_shift = 12, .rf_addr = 0x4f, .rf_shift = 0, .mask = 0x0f, },\n\t{ .phy_offset = 1, .phy_shift = 0, .rf_addr = 0x4f, .rf_shift = 4, .mask = 0x0f, },\n\t{ .phy_offset = 3, .phy_shift = 0, .rf_addr = 0x49, .rf_shift = 0, .mask = 0x0f, },\n\t{ .phy_offset = 4, .phy_shift = 3, .rf_addr = 0x46, .rf_shift = 4, .mask = 0x07, },\n\t{ .phy_offset = 3, .phy_shift = 15, .rf_addr = 0x46, .rf_shift = 0, .mask = 0x01, },\n\t{ .phy_offset = 4, .phy_shift = 0, .rf_addr = 0x46, .rf_shift = 1, .mask = 0x07, },\n\t{ .phy_offset = 3, .phy_shift = 8, .rf_addr = 0x48, .rf_shift = 4, .mask = 0x07, },\n\t{ .phy_offset = 3, .phy_shift = 11, .rf_addr = 0x48, .rf_shift = 0, .mask = 0x0f, },\n\t{ .phy_offset = 3, .phy_shift = 4, .rf_addr = 0x49, .rf_shift = 4, .mask = 0x0f, },\n\t{ .phy_offset = 2, .phy_shift = 15, .rf_addr = 0x45, .rf_shift = 0, .mask = 0x01, },\n\t{ .phy_offset = 5, .phy_shift = 13, .rf_addr = 0x52, .rf_shift = 4, .mask = 0x07, },\n\t{ .phy_offset = 6, .phy_shift = 0, .rf_addr = 0x52, .rf_shift = 7, .mask = 0x01, },\n\t{ .phy_offset = 5, .phy_shift = 3, .rf_addr = 0x41, .rf_shift = 5, .mask = 0x07, },\n\t{ .phy_offset = 5, .phy_shift = 6, .rf_addr = 0x41, .rf_shift = 0, .mask = 0x0f, },\n\t{ .phy_offset = 5, .phy_shift = 10, .rf_addr = 0x42, .rf_shift = 5, .mask = 0x07, },\n\t{ .phy_offset = 4, .phy_shift = 15, .rf_addr = 0x42, .rf_shift = 0, .mask = 0x01, },\n\t{ .phy_offset = 5, .phy_shift = 0, .rf_addr = 0x42, .rf_shift = 1, .mask = 0x07, },\n\t{ .phy_offset = 4, .phy_shift = 11, .rf_addr = 0x43, .rf_shift = 4, .mask = 0x0f, },\n\t{ .phy_offset = 4, .phy_shift = 7, .rf_addr = 0x43, .rf_shift = 0, .mask = 0x0f, },\n\t{ .phy_offset = 4, .phy_shift = 6, .rf_addr = 0x45, .rf_shift = 1, .mask = 0x01, },\n\t{ .phy_offset = 2, .phy_shift = 7, .rf_addr = 0x40, .rf_shift = 4, .mask = 0x0f, },\n\t{ .phy_offset = 2, .phy_shift = 11, .rf_addr = 0x40, .rf_shift = 0, .mask = 0x0f, },\n};\n\nstatic void lpphy_sync_stx(struct b43_wldev *dev)\n{\n\tconst struct lpphy_stx_table_entry *e;\n\tunsigned int i;\n\tu16 tmp;\n\n\tfor (i = 0; i < ARRAY_SIZE(lpphy_stx_table); i++) {\n\t\te = &lpphy_stx_table[i];\n\t\ttmp = b43_radio_read(dev, e->rf_addr);\n\t\ttmp >>= e->rf_shift;\n\t\ttmp <<= e->phy_shift;\n\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0xF2 + e->phy_offset),\n\t\t\t\t~(e->mask << e->phy_shift), tmp);\n\t}\n}\n\nstatic void lpphy_radio_init(struct b43_wldev *dev)\n{\n\t \n\tb43_phy_set(dev, B43_LPPHY_FOURWIRE_CTL, 0x2);\n\tudelay(1);\n\tb43_phy_mask(dev, B43_LPPHY_FOURWIRE_CTL, 0xFFFD);\n\tudelay(1);\n\n\tif (dev->phy.radio_ver == 0x2062) {\n\t\tlpphy_2062_init(dev);\n\t} else {\n\t\tlpphy_2063_init(dev);\n\t\tlpphy_sync_stx(dev);\n\t\tb43_phy_write(dev, B43_PHY_OFDM(0xF0), 0x5F80);\n\t\tb43_phy_write(dev, B43_PHY_OFDM(0xF1), 0);\n\t\tif (dev->dev->chip_id == 0x4325) {\n\t\t\t\n\t\t}\n\t}\n}\n\nstruct lpphy_iq_est { u32 iq_prod, i_pwr, q_pwr; };\n\nstatic void lpphy_set_rc_cap(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\n\tu8 rc_cap = (lpphy->rc_cap & 0x1F) >> 1;\n\n\tif (dev->phy.rev == 1) \n\t\trc_cap = min_t(u8, rc_cap + 5, 15);\n\n\tb43_radio_write(dev, B2062_N_RXBB_CALIB2,\n\t\t\tmax_t(u8, lpphy->rc_cap - 4, 0x80));\n\tb43_radio_write(dev, B2062_N_TX_CTL_A, rc_cap | 0x80);\n\tb43_radio_write(dev, B2062_S_RXG_CNT16,\n\t\t\t((lpphy->rc_cap & 0x1F) >> 2) | 0x80);\n}\n\nstatic u8 lpphy_get_bb_mult(struct b43_wldev *dev)\n{\n\treturn (b43_lptab_read(dev, B43_LPTAB16(0, 87)) & 0xFF00) >> 8;\n}\n\nstatic void lpphy_set_bb_mult(struct b43_wldev *dev, u8 bb_mult)\n{\n\tb43_lptab_write(dev, B43_LPTAB16(0, 87), (u16)bb_mult << 8);\n}\n\nstatic void lpphy_set_deaf(struct b43_wldev *dev, bool user)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\n\tif (user)\n\t\tlpphy->crs_usr_disable = true;\n\telse\n\t\tlpphy->crs_sys_disable = true;\n\tb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL, 0xFF1F, 0x80);\n}\n\nstatic void lpphy_clear_deaf(struct b43_wldev *dev, bool user)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\n\tif (user)\n\t\tlpphy->crs_usr_disable = false;\n\telse\n\t\tlpphy->crs_sys_disable = false;\n\n\tif (!lpphy->crs_usr_disable && !lpphy->crs_sys_disable) {\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\t\tb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL,\n\t\t\t\t\t0xFF1F, 0x60);\n\t\telse\n\t\t\tb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL,\n\t\t\t\t\t0xFF1F, 0x20);\n\t}\n}\n\nstatic void lpphy_set_trsw_over(struct b43_wldev *dev, bool tx, bool rx)\n{\n\tu16 trsw = (tx << 1) | rx;\n\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFFC, trsw);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x3);\n}\n\nstatic void lpphy_disable_crs(struct b43_wldev *dev, bool user)\n{\n\tlpphy_set_deaf(dev, user);\n\tlpphy_set_trsw_over(dev, false, true);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFFB);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x4);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFF7);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x8);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x10);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x10);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFDF);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x20);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFBF);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x40);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0x7);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0x38);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFF3F);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0x100);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFDFF);\n\tb43_phy_write(dev, B43_LPPHY_PS_CTL_OVERRIDE_VAL0, 0);\n\tb43_phy_write(dev, B43_LPPHY_PS_CTL_OVERRIDE_VAL1, 1);\n\tb43_phy_write(dev, B43_LPPHY_PS_CTL_OVERRIDE_VAL2, 0x20);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFBFF);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xF7FF);\n\tb43_phy_write(dev, B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL, 0);\n\tb43_phy_write(dev, B43_LPPHY_RX_GAIN_CTL_OVERRIDE_VAL, 0x45AF);\n\tb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_2, 0x3FF);\n}\n\nstatic void lpphy_restore_crs(struct b43_wldev *dev, bool user)\n{\n\tlpphy_clear_deaf(dev, user);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFF80);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFC00);\n}\n\nstruct lpphy_tx_gains { u16 gm, pga, pad, dac; };\n\nstatic void lpphy_disable_rx_gain_override(struct b43_wldev *dev)\n{\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFFE);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFEF);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFBF);\n\tif (dev->phy.rev >= 2) {\n\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFEFF);\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFBFF);\n\t\t\tb43_phy_mask(dev, B43_PHY_OFDM(0xE5), 0xFFF7);\n\t\t}\n\t} else {\n\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFDFF);\n\t}\n}\n\nstatic void lpphy_enable_rx_gain_override(struct b43_wldev *dev)\n{\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x1);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x10);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x40);\n\tif (dev->phy.rev >= 2) {\n\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x100);\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x400);\n\t\t\tb43_phy_set(dev, B43_PHY_OFDM(0xE5), 0x8);\n\t\t}\n\t} else {\n\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x200);\n\t}\n}\n\nstatic void lpphy_disable_tx_gain_override(struct b43_wldev *dev)\n{\n\tif (dev->phy.rev < 2)\n\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFEFF);\n\telse {\n\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFF7F);\n\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xBFFF);\n\t}\n\tb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVR, 0xFFBF);\n}\n\nstatic void lpphy_enable_tx_gain_override(struct b43_wldev *dev)\n{\n\tif (dev->phy.rev < 2)\n\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x100);\n\telse {\n\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x80);\n\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x4000);\n\t}\n\tb43_phy_set(dev, B43_LPPHY_AFE_CTL_OVR, 0x40);\n}\n\nstatic struct lpphy_tx_gains lpphy_get_tx_gains(struct b43_wldev *dev)\n{\n\tstruct lpphy_tx_gains gains;\n\tu16 tmp;\n\n\tgains.dac = (b43_phy_read(dev, B43_LPPHY_AFE_DAC_CTL) & 0x380) >> 7;\n\tif (dev->phy.rev < 2) {\n\t\ttmp = b43_phy_read(dev,\n\t\t\t\t   B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL) & 0x7FF;\n\t\tgains.gm = tmp & 0x0007;\n\t\tgains.pga = (tmp & 0x0078) >> 3;\n\t\tgains.pad = (tmp & 0x780) >> 7;\n\t} else {\n\t\ttmp = b43_phy_read(dev, B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL);\n\t\tgains.pad = b43_phy_read(dev, B43_PHY_OFDM(0xFB)) & 0xFF;\n\t\tgains.gm = tmp & 0xFF;\n\t\tgains.pga = (tmp >> 8) & 0xFF;\n\t}\n\n\treturn gains;\n}\n\nstatic void lpphy_set_dac_gain(struct b43_wldev *dev, u16 dac)\n{\n\tu16 ctl = b43_phy_read(dev, B43_LPPHY_AFE_DAC_CTL) & 0xC7F;\n\tctl |= dac << 7;\n\tb43_phy_maskset(dev, B43_LPPHY_AFE_DAC_CTL, 0xF000, ctl);\n}\n\nstatic u16 lpphy_get_pa_gain(struct b43_wldev *dev)\n{\n\treturn b43_phy_read(dev, B43_PHY_OFDM(0xFB)) & 0x7F;\n}\n\nstatic void lpphy_set_pa_gain(struct b43_wldev *dev, u16 gain)\n{\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xFB), 0xE03F, gain << 6);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xFD), 0x80FF, gain << 8);\n}\n\nstatic void lpphy_set_tx_gains(struct b43_wldev *dev,\n\t\t\t       struct lpphy_tx_gains gains)\n{\n\tu16 rf_gain, pa_gain;\n\n\tif (dev->phy.rev < 2) {\n\t\trf_gain = (gains.pad << 7) | (gains.pga << 3) | gains.gm;\n\t\tb43_phy_maskset(dev, B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL,\n\t\t\t\t0xF800, rf_gain);\n\t} else {\n\t\tpa_gain = lpphy_get_pa_gain(dev);\n\t\tb43_phy_write(dev, B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL,\n\t\t\t      (gains.pga << 8) | gains.gm);\n\t\t \n\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0xFB),\n\t\t\t\t0x8000, gains.pad | (pa_gain << 6));\n\t\tb43_phy_write(dev, B43_PHY_OFDM(0xFC),\n\t\t\t      (gains.pga << 8) | gains.gm);\n\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0xFD),\n\t\t\t\t0x8000, gains.pad | (pa_gain << 8));\n\t}\n\tlpphy_set_dac_gain(dev, gains.dac);\n\tlpphy_enable_tx_gain_override(dev);\n}\n\nstatic void lpphy_rev0_1_set_rx_gain(struct b43_wldev *dev, u32 gain)\n{\n\tu16 trsw = gain & 0x1;\n\tu16 lna = (gain & 0xFFFC) | ((gain & 0xC) >> 2);\n\tu16 ext_lna = (gain & 2) >> 1;\n\n\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFFE, trsw);\n\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL,\n\t\t\t0xFBFF, ext_lna << 10);\n\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL,\n\t\t\t0xF7FF, ext_lna << 11);\n\tb43_phy_write(dev, B43_LPPHY_RX_GAIN_CTL_OVERRIDE_VAL, lna);\n}\n\nstatic void lpphy_rev2plus_set_rx_gain(struct b43_wldev *dev, u32 gain)\n{\n\tu16 low_gain = gain & 0xFFFF;\n\tu16 high_gain = (gain >> 16) & 0xF;\n\tu16 ext_lna = (gain >> 21) & 0x1;\n\tu16 trsw = ~(gain >> 20) & 0x1;\n\tu16 tmp;\n\n\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFFE, trsw);\n\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL,\n\t\t\t0xFDFF, ext_lna << 9);\n\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL,\n\t\t\t0xFBFF, ext_lna << 10);\n\tb43_phy_write(dev, B43_LPPHY_RX_GAIN_CTL_OVERRIDE_VAL, low_gain);\n\tb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS, 0xFFF0, high_gain);\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\ttmp = (gain >> 2) & 0x3;\n\t\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL,\n\t\t\t\t0xE7FF, tmp<<11);\n\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0xE6), 0xFFE7, tmp << 3);\n\t}\n}\n\nstatic void lpphy_set_rx_gain(struct b43_wldev *dev, u32 gain)\n{\n\tif (dev->phy.rev < 2)\n\t\tlpphy_rev0_1_set_rx_gain(dev, gain);\n\telse\n\t\tlpphy_rev2plus_set_rx_gain(dev, gain);\n\tlpphy_enable_rx_gain_override(dev);\n}\n\nstatic void lpphy_set_rx_gain_by_index(struct b43_wldev *dev, u16 idx)\n{\n\tu32 gain = b43_lptab_read(dev, B43_LPTAB16(12, idx));\n\tlpphy_set_rx_gain(dev, gain);\n}\n\nstatic void lpphy_stop_ddfs(struct b43_wldev *dev)\n{\n\tb43_phy_mask(dev, B43_LPPHY_AFE_DDFS, 0xFFFD);\n\tb43_phy_mask(dev, B43_LPPHY_LP_PHY_CTL, 0xFFDF);\n}\n\nstatic void lpphy_run_ddfs(struct b43_wldev *dev, int i_on, int q_on,\n\t\t\t   int incr1, int incr2, int scale_idx)\n{\n\tlpphy_stop_ddfs(dev);\n\tb43_phy_mask(dev, B43_LPPHY_AFE_DDFS_POINTER_INIT, 0xFF80);\n\tb43_phy_mask(dev, B43_LPPHY_AFE_DDFS_POINTER_INIT, 0x80FF);\n\tb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS_INCR_INIT, 0xFF80, incr1);\n\tb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS_INCR_INIT, 0x80FF, incr2 << 8);\n\tb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS, 0xFFF7, i_on << 3);\n\tb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS, 0xFFEF, q_on << 4);\n\tb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS, 0xFF9F, scale_idx << 5);\n\tb43_phy_mask(dev, B43_LPPHY_AFE_DDFS, 0xFFFB);\n\tb43_phy_set(dev, B43_LPPHY_AFE_DDFS, 0x2);\n\tb43_phy_set(dev, B43_LPPHY_LP_PHY_CTL, 0x20);\n}\n\nstatic bool lpphy_rx_iq_est(struct b43_wldev *dev, u16 samples, u8 time,\n\t\t\t   struct lpphy_iq_est *iq_est)\n{\n\tint i;\n\n\tb43_phy_mask(dev, B43_LPPHY_CRSGAIN_CTL, 0xFFF7);\n\tb43_phy_write(dev, B43_LPPHY_IQ_NUM_SMPLS_ADDR, samples);\n\tb43_phy_maskset(dev, B43_LPPHY_IQ_ENABLE_WAIT_TIME_ADDR, 0xFF00, time);\n\tb43_phy_mask(dev, B43_LPPHY_IQ_ENABLE_WAIT_TIME_ADDR, 0xFEFF);\n\tb43_phy_set(dev, B43_LPPHY_IQ_ENABLE_WAIT_TIME_ADDR, 0x200);\n\n\tfor (i = 0; i < 500; i++) {\n\t\tif (!(b43_phy_read(dev,\n\t\t\t\tB43_LPPHY_IQ_ENABLE_WAIT_TIME_ADDR) & 0x200))\n\t\t\tbreak;\n\t\tmsleep(1);\n\t}\n\n\tif ((b43_phy_read(dev, B43_LPPHY_IQ_ENABLE_WAIT_TIME_ADDR) & 0x200)) {\n\t\tb43_phy_set(dev, B43_LPPHY_CRSGAIN_CTL, 0x8);\n\t\treturn false;\n\t}\n\n\tiq_est->iq_prod = b43_phy_read(dev, B43_LPPHY_IQ_ACC_HI_ADDR);\n\tiq_est->iq_prod <<= 16;\n\tiq_est->iq_prod |= b43_phy_read(dev, B43_LPPHY_IQ_ACC_LO_ADDR);\n\n\tiq_est->i_pwr = b43_phy_read(dev, B43_LPPHY_IQ_I_PWR_ACC_HI_ADDR);\n\tiq_est->i_pwr <<= 16;\n\tiq_est->i_pwr |= b43_phy_read(dev, B43_LPPHY_IQ_I_PWR_ACC_LO_ADDR);\n\n\tiq_est->q_pwr = b43_phy_read(dev, B43_LPPHY_IQ_Q_PWR_ACC_HI_ADDR);\n\tiq_est->q_pwr <<= 16;\n\tiq_est->q_pwr |= b43_phy_read(dev, B43_LPPHY_IQ_Q_PWR_ACC_LO_ADDR);\n\n\tb43_phy_set(dev, B43_LPPHY_CRSGAIN_CTL, 0x8);\n\treturn true;\n}\n\nstatic int lpphy_loopback(struct b43_wldev *dev)\n{\n\tstruct lpphy_iq_est iq_est;\n\tint i, index = -1;\n\tu32 tmp;\n\n\tmemset(&iq_est, 0, sizeof(iq_est));\n\n\tlpphy_set_trsw_over(dev, true, true);\n\tb43_phy_set(dev, B43_LPPHY_AFE_CTL_OVR, 1);\n\tb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0xFFFE);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x800);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x800);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x8);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x8);\n\tb43_radio_write(dev, B2062_N_TX_CTL_A, 0x80);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x80);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x80);\n\tfor (i = 0; i < 32; i++) {\n\t\tlpphy_set_rx_gain_by_index(dev, i);\n\t\tlpphy_run_ddfs(dev, 1, 1, 5, 5, 0);\n\t\tif (!(lpphy_rx_iq_est(dev, 1000, 32, &iq_est)))\n\t\t\tcontinue;\n\t\ttmp = (iq_est.i_pwr + iq_est.q_pwr) / 1000;\n\t\tif ((tmp > 4000) && (tmp < 10000)) {\n\t\t\tindex = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\tlpphy_stop_ddfs(dev);\n\treturn index;\n}\n\n \nstatic u32 lpphy_qdiv_roundup(u32 dividend, u32 divisor, u8 precision)\n{\n\tu32 quotient, remainder;\n\n\tif (divisor == 0)\n\t\treturn 0;\n\n\tquotient = dividend / divisor;\n\tremainder = dividend % divisor;\n\n\twhile (precision > 0) {\n\t\tquotient <<= 1;\n\t\tif (remainder << 1 >= divisor) {\n\t\t\tquotient++;\n\t\t\tremainder = (remainder << 1) - divisor;\n\t\t}\n\t\tprecision--;\n\t}\n\n\tif (remainder << 1 >= divisor)\n\t\tquotient++;\n\n\treturn quotient;\n}\n\n \nstatic void lpphy_read_tx_pctl_mode_from_hardware(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tu16 ctl;\n\n\tctl = b43_phy_read(dev, B43_LPPHY_TX_PWR_CTL_CMD);\n\tswitch (ctl & B43_LPPHY_TX_PWR_CTL_CMD_MODE) {\n\tcase B43_LPPHY_TX_PWR_CTL_CMD_MODE_OFF:\n\t\tlpphy->txpctl_mode = B43_LPPHY_TXPCTL_OFF;\n\t\tbreak;\n\tcase B43_LPPHY_TX_PWR_CTL_CMD_MODE_SW:\n\t\tlpphy->txpctl_mode = B43_LPPHY_TXPCTL_SW;\n\t\tbreak;\n\tcase B43_LPPHY_TX_PWR_CTL_CMD_MODE_HW:\n\t\tlpphy->txpctl_mode = B43_LPPHY_TXPCTL_HW;\n\t\tbreak;\n\tdefault:\n\t\tlpphy->txpctl_mode = B43_LPPHY_TXPCTL_UNKNOWN;\n\t\tB43_WARN_ON(1);\n\t\tbreak;\n\t}\n}\n\n \nstatic void lpphy_write_tx_pctl_mode_to_hardware(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tu16 ctl;\n\n\tswitch (lpphy->txpctl_mode) {\n\tcase B43_LPPHY_TXPCTL_OFF:\n\t\tctl = B43_LPPHY_TX_PWR_CTL_CMD_MODE_OFF;\n\t\tbreak;\n\tcase B43_LPPHY_TXPCTL_HW:\n\t\tctl = B43_LPPHY_TX_PWR_CTL_CMD_MODE_HW;\n\t\tbreak;\n\tcase B43_LPPHY_TXPCTL_SW:\n\t\tctl = B43_LPPHY_TX_PWR_CTL_CMD_MODE_SW;\n\t\tbreak;\n\tdefault:\n\t\tctl = 0;\n\t\tB43_WARN_ON(1);\n\t}\n\tb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_CMD,\n\t\t\t~B43_LPPHY_TX_PWR_CTL_CMD_MODE & 0xFFFF, ctl);\n}\n\nstatic void lpphy_set_tx_power_control(struct b43_wldev *dev,\n\t\t\t\t       enum b43_lpphy_txpctl_mode mode)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tenum b43_lpphy_txpctl_mode oldmode;\n\n\tlpphy_read_tx_pctl_mode_from_hardware(dev);\n\toldmode = lpphy->txpctl_mode;\n\tif (oldmode == mode)\n\t\treturn;\n\tlpphy->txpctl_mode = mode;\n\n\tif (oldmode == B43_LPPHY_TXPCTL_HW) {\n\t\t\n\t\t\n\t} else {\n\t\tif (mode == B43_LPPHY_TXPCTL_HW) {\n\t\t\t\n\t\t\tb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_CMD,\n\t\t\t\t\t0xFF80, lpphy->tssi_idx);\n\t\t\tb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_NNUM,\n\t\t\t\t\t0x8FFF, ((u16)lpphy->tssi_npt << 16));\n\t\t\t\n\t\t\tlpphy_disable_tx_gain_override(dev);\n\t\t\tlpphy->tx_pwr_idx_over = -1;\n\t\t}\n\t}\n\tif (dev->phy.rev >= 2) {\n\t\tif (mode == B43_LPPHY_TXPCTL_HW)\n\t\t\tb43_phy_set(dev, B43_PHY_OFDM(0xD0), 0x2);\n\t\telse\n\t\t\tb43_phy_mask(dev, B43_PHY_OFDM(0xD0), 0xFFFD);\n\t}\n\tlpphy_write_tx_pctl_mode_to_hardware(dev);\n}\n\nstatic int b43_lpphy_op_switch_channel(struct b43_wldev *dev,\n\t\t\t\t       unsigned int new_channel);\n\nstatic void lpphy_rev0_1_rc_calib(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tstruct lpphy_iq_est iq_est;\n\tstruct lpphy_tx_gains tx_gains;\n\tstatic const u32 ideal_pwr_table[21] = {\n\t\t0x10000, 0x10557, 0x10e2d, 0x113e0, 0x10f22, 0x0ff64,\n\t\t0x0eda2, 0x0e5d4, 0x0efd1, 0x0fbe8, 0x0b7b8, 0x04b35,\n\t\t0x01a5e, 0x00a0b, 0x00444, 0x001fd, 0x000ff, 0x00088,\n\t\t0x0004c, 0x0002c, 0x0001a,\n\t};\n\tbool old_txg_ovr;\n\tu8 old_bbmult;\n\tu16 old_rf_ovr, old_rf_ovrval, old_afe_ovr, old_afe_ovrval,\n\t    old_rf2_ovr, old_rf2_ovrval, old_phy_ctl;\n\tenum b43_lpphy_txpctl_mode old_txpctl;\n\tu32 normal_pwr, ideal_pwr, mean_sq_pwr, tmp = 0, mean_sq_pwr_min = 0;\n\tint loopback, i, j, inner_sum, err;\n\n\tmemset(&iq_est, 0, sizeof(iq_est));\n\n\terr = b43_lpphy_op_switch_channel(dev, 7);\n\tif (err) {\n\t\tb43dbg(dev->wl,\n\t\t       \"RC calib: Failed to switch to channel 7, error = %d\\n\",\n\t\t       err);\n\t}\n\told_txg_ovr = !!(b43_phy_read(dev, B43_LPPHY_AFE_CTL_OVR) & 0x40);\n\told_bbmult = lpphy_get_bb_mult(dev);\n\tif (old_txg_ovr)\n\t\ttx_gains = lpphy_get_tx_gains(dev);\n\told_rf_ovr = b43_phy_read(dev, B43_LPPHY_RF_OVERRIDE_0);\n\told_rf_ovrval = b43_phy_read(dev, B43_LPPHY_RF_OVERRIDE_VAL_0);\n\told_afe_ovr = b43_phy_read(dev, B43_LPPHY_AFE_CTL_OVR);\n\told_afe_ovrval = b43_phy_read(dev, B43_LPPHY_AFE_CTL_OVRVAL);\n\told_rf2_ovr = b43_phy_read(dev, B43_LPPHY_RF_OVERRIDE_2);\n\told_rf2_ovrval = b43_phy_read(dev, B43_LPPHY_RF_OVERRIDE_2_VAL);\n\told_phy_ctl = b43_phy_read(dev, B43_LPPHY_LP_PHY_CTL);\n\tlpphy_read_tx_pctl_mode_from_hardware(dev);\n\told_txpctl = lpphy->txpctl_mode;\n\n\tlpphy_set_tx_power_control(dev, B43_LPPHY_TXPCTL_OFF);\n\tlpphy_disable_crs(dev, true);\n\tloopback = lpphy_loopback(dev);\n\tif (loopback == -1)\n\t\tgoto finish;\n\tlpphy_set_rx_gain_by_index(dev, loopback);\n\tb43_phy_maskset(dev, B43_LPPHY_LP_PHY_CTL, 0xFFBF, 0x40);\n\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFFF8, 0x1);\n\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFFC7, 0x8);\n\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFF3F, 0xC0);\n\tfor (i = 128; i <= 159; i++) {\n\t\tb43_radio_write(dev, B2062_N_RXBB_CALIB2, i);\n\t\tinner_sum = 0;\n\t\tfor (j = 5; j <= 25; j++) {\n\t\t\tlpphy_run_ddfs(dev, 1, 1, j, j, 0);\n\t\t\tif (!(lpphy_rx_iq_est(dev, 1000, 32, &iq_est)))\n\t\t\t\tgoto finish;\n\t\t\tmean_sq_pwr = iq_est.i_pwr + iq_est.q_pwr;\n\t\t\tif (j == 5)\n\t\t\t\ttmp = mean_sq_pwr;\n\t\t\tideal_pwr = ((ideal_pwr_table[j-5] >> 3) + 1) >> 1;\n\t\t\tnormal_pwr = lpphy_qdiv_roundup(mean_sq_pwr, tmp, 12);\n\t\t\tmean_sq_pwr = ideal_pwr - normal_pwr;\n\t\t\tmean_sq_pwr *= mean_sq_pwr;\n\t\t\tinner_sum += mean_sq_pwr;\n\t\t\tif ((i == 128) || (inner_sum < mean_sq_pwr_min)) {\n\t\t\t\tlpphy->rc_cap = i;\n\t\t\t\tmean_sq_pwr_min = inner_sum;\n\t\t\t}\n\t\t}\n\t}\n\tlpphy_stop_ddfs(dev);\n\nfinish:\n\tlpphy_restore_crs(dev, true);\n\tb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, old_rf_ovrval);\n\tb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_0, old_rf_ovr);\n\tb43_phy_write(dev, B43_LPPHY_AFE_CTL_OVRVAL, old_afe_ovrval);\n\tb43_phy_write(dev, B43_LPPHY_AFE_CTL_OVR, old_afe_ovr);\n\tb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, old_rf2_ovrval);\n\tb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_2, old_rf2_ovr);\n\tb43_phy_write(dev, B43_LPPHY_LP_PHY_CTL, old_phy_ctl);\n\n\tlpphy_set_bb_mult(dev, old_bbmult);\n\tif (old_txg_ovr) {\n\t\t \n\t\tlpphy_set_tx_gains(dev, tx_gains);\n\t}\n\tlpphy_set_tx_power_control(dev, old_txpctl);\n\tif (lpphy->rc_cap)\n\t\tlpphy_set_rc_cap(dev);\n}\n\nstatic void lpphy_rev2plus_rc_calib(struct b43_wldev *dev)\n{\n\tstruct ssb_bus *bus = dev->dev->sdev->bus;\n\tu32 crystal_freq = bus->chipco.pmu.crystalfreq * 1000;\n\tu8 tmp = b43_radio_read(dev, B2063_RX_BB_SP8) & 0xFF;\n\tint i;\n\n\tb43_radio_write(dev, B2063_RX_BB_SP8, 0x0);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7E);\n\tb43_radio_mask(dev, B2063_PLL_SP1, 0xF7);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7C);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL2, 0x15);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL3, 0x70);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL4, 0x52);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL5, 0x1);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7D);\n\n\tfor (i = 0; i < 10000; i++) {\n\t\tif (b43_radio_read(dev, B2063_RC_CALIB_CTL6) & 0x2)\n\t\t\tbreak;\n\t\tmsleep(1);\n\t}\n\n\tif (!(b43_radio_read(dev, B2063_RC_CALIB_CTL6) & 0x2))\n\t\tb43_radio_write(dev, B2063_RX_BB_SP8, tmp);\n\n\ttmp = b43_radio_read(dev, B2063_TX_BB_SP3) & 0xFF;\n\n\tb43_radio_write(dev, B2063_TX_BB_SP3, 0x0);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7E);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7C);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL2, 0x55);\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL3, 0x76);\n\n\tif (crystal_freq == 24000000) {\n\t\tb43_radio_write(dev, B2063_RC_CALIB_CTL4, 0xFC);\n\t\tb43_radio_write(dev, B2063_RC_CALIB_CTL5, 0x0);\n\t} else {\n\t\tb43_radio_write(dev, B2063_RC_CALIB_CTL4, 0x13);\n\t\tb43_radio_write(dev, B2063_RC_CALIB_CTL5, 0x1);\n\t}\n\n\tb43_radio_write(dev, B2063_PA_SP7, 0x7D);\n\n\tfor (i = 0; i < 10000; i++) {\n\t\tif (b43_radio_read(dev, B2063_RC_CALIB_CTL6) & 0x2)\n\t\t\tbreak;\n\t\tmsleep(1);\n\t}\n\n\tif (!(b43_radio_read(dev, B2063_RC_CALIB_CTL6) & 0x2))\n\t\tb43_radio_write(dev, B2063_TX_BB_SP3, tmp);\n\n\tb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7E);\n}\n\nstatic void lpphy_calibrate_rc(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\n\tif (dev->phy.rev >= 2) {\n\t\tlpphy_rev2plus_rc_calib(dev);\n\t} else if (!lpphy->rc_cap) {\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\t\tlpphy_rev0_1_rc_calib(dev);\n\t} else {\n\t\tlpphy_set_rc_cap(dev);\n\t}\n}\n\nstatic void b43_lpphy_op_set_rx_antenna(struct b43_wldev *dev, int antenna)\n{\n\tif (dev->phy.rev >= 2)\n\t\treturn; \n\n\tif (B43_WARN_ON(antenna > B43_ANTENNA_AUTO1))\n\t\treturn;\n\n\tb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_ANTDIVHELP);\n\n\tb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL, 0xFFFD, antenna & 0x2);\n\tb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL, 0xFFFE, antenna & 0x1);\n\n\tb43_hf_write(dev, b43_hf_read(dev) | B43_HF_ANTDIVHELP);\n\n\tdev->phy.lp->antenna = antenna;\n}\n\nstatic void lpphy_set_tx_iqcc(struct b43_wldev *dev, u16 a, u16 b)\n{\n\tu16 tmp[2];\n\n\ttmp[0] = a;\n\ttmp[1] = b;\n\tb43_lptab_write_bulk(dev, B43_LPTAB16(0, 80), 2, tmp);\n}\n\nstatic void lpphy_set_tx_power_by_index(struct b43_wldev *dev, u8 index)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tstruct lpphy_tx_gains gains;\n\tu32 iq_comp, tx_gain, coeff, rf_power;\n\n\tlpphy->tx_pwr_idx_over = index;\n\tlpphy_read_tx_pctl_mode_from_hardware(dev);\n\tif (lpphy->txpctl_mode != B43_LPPHY_TXPCTL_OFF)\n\t\tlpphy_set_tx_power_control(dev, B43_LPPHY_TXPCTL_SW);\n\tif (dev->phy.rev >= 2) {\n\t\tiq_comp = b43_lptab_read(dev, B43_LPTAB32(7, index + 320));\n\t\ttx_gain = b43_lptab_read(dev, B43_LPTAB32(7, index + 192));\n\t\tgains.pad = (tx_gain >> 16) & 0xFF;\n\t\tgains.gm = tx_gain & 0xFF;\n\t\tgains.pga = (tx_gain >> 8) & 0xFF;\n\t\tgains.dac = (iq_comp >> 28) & 0xFF;\n\t\tlpphy_set_tx_gains(dev, gains);\n\t} else {\n\t\tiq_comp = b43_lptab_read(dev, B43_LPTAB32(10, index + 320));\n\t\ttx_gain = b43_lptab_read(dev, B43_LPTAB32(10, index + 192));\n\t\tb43_phy_maskset(dev, B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL,\n\t\t\t\t0xF800, (tx_gain >> 4) & 0x7FFF);\n\t\tlpphy_set_dac_gain(dev, tx_gain & 0x7);\n\t\tlpphy_set_pa_gain(dev, (tx_gain >> 24) & 0x7F);\n\t}\n\tlpphy_set_bb_mult(dev, (iq_comp >> 20) & 0xFF);\n\tlpphy_set_tx_iqcc(dev, (iq_comp >> 10) & 0x3FF, iq_comp & 0x3FF);\n\tif (dev->phy.rev >= 2) {\n\t\tcoeff = b43_lptab_read(dev, B43_LPTAB32(7, index + 448));\n\t} else {\n\t\tcoeff = b43_lptab_read(dev, B43_LPTAB32(10, index + 448));\n\t}\n\tb43_lptab_write(dev, B43_LPTAB16(0, 85), coeff & 0xFFFF);\n\tif (dev->phy.rev >= 2) {\n\t\trf_power = b43_lptab_read(dev, B43_LPTAB32(7, index + 576));\n\t\tb43_phy_maskset(dev, B43_LPPHY_RF_PWR_OVERRIDE, 0xFF00,\n\t\t\t\trf_power & 0xFFFF);\n\t}\n\tlpphy_enable_tx_gain_override(dev);\n}\n\nstatic void lpphy_btcoex_override(struct b43_wldev *dev)\n{\n\tb43_write16(dev, B43_MMIO_BTCOEX_CTL, 0x3);\n\tb43_write16(dev, B43_MMIO_BTCOEX_TXCTL, 0xFF);\n}\n\nstatic void b43_lpphy_op_software_rfkill(struct b43_wldev *dev,\n\t\t\t\t\t bool blocked)\n{\n\t\n\tif (blocked) {\n\t\tif (dev->phy.rev >= 2) {\n\t\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x83FF);\n\t\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x1F00);\n\t\t\tb43_phy_mask(dev, B43_LPPHY_AFE_DDFS, 0x80FF);\n\t\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xDFFF);\n\t\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x0808);\n\t\t} else {\n\t\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xE0FF);\n\t\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x1F00);\n\t\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFCFF);\n\t\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x0018);\n\t\t}\n\t} else {\n\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xE0FF);\n\t\tif (dev->phy.rev >= 2)\n\t\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xF7F7);\n\t\telse\n\t\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFFE7);\n\t}\n}\n\n \nstatic void lpphy_set_analog_filter(struct b43_wldev *dev, int channel)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tu16 tmp = (channel == 14); \n\n\tif (dev->phy.rev < 2) { \n\t\tb43_phy_maskset(dev, B43_LPPHY_LP_PHY_CTL, 0xFCFF, tmp << 9);\n\t\tif ((dev->phy.rev == 1) && (lpphy->rc_cap))\n\t\t\tlpphy_set_rc_cap(dev);\n\t} else {\n\t\tb43_radio_write(dev, B2063_TX_BB_SP3, 0x3F);\n\t}\n}\n\nstatic void lpphy_set_tssi_mux(struct b43_wldev *dev, enum tssi_mux_mode mode)\n{\n\tif (mode != TSSI_MUX_EXT) {\n\t\tb43_radio_set(dev, B2063_PA_SP1, 0x2);\n\t\tb43_phy_set(dev, B43_PHY_OFDM(0xF3), 0x1000);\n\t\tb43_radio_write(dev, B2063_PA_CTL10, 0x51);\n\t\tif (mode == TSSI_MUX_POSTPA) {\n\t\t\tb43_radio_mask(dev, B2063_PA_SP1, 0xFFFE);\n\t\t\tb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0xFFC7);\n\t\t} else {\n\t\t\tb43_radio_maskset(dev, B2063_PA_SP1, 0xFFFE, 0x1);\n\t\t\tb43_phy_maskset(dev, B43_LPPHY_AFE_CTL_OVRVAL,\n\t\t\t\t\t0xFFC7, 0x20);\n\t\t}\n\t} else {\n\t\tB43_WARN_ON(1);\n\t}\n}\n\nstatic void lpphy_tx_pctl_init_hw(struct b43_wldev *dev)\n{\n\tu16 tmp;\n\tint i;\n\n\t\n\tfor (i = 0; i < 64; i++) {\n\t\tif (dev->phy.rev >= 2)\n\t\t\tb43_lptab_write(dev, B43_LPTAB32(7, i + 1), i);\n\t\telse\n\t\t\tb43_lptab_write(dev, B43_LPTAB32(10, i + 1), i);\n\t}\n\n\tb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_NNUM, 0xFF00, 0xFF);\n\tb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_NNUM, 0x8FFF, 0x5000);\n\tb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_IDLETSSI, 0xFFC0, 0x1F);\n\tif (dev->phy.rev < 2) {\n\t\tb43_phy_mask(dev, B43_LPPHY_LP_PHY_CTL, 0xEFFF);\n\t\tb43_phy_maskset(dev, B43_LPPHY_LP_PHY_CTL, 0xDFFF, 0x2000);\n\t} else {\n\t\tb43_phy_mask(dev, B43_PHY_OFDM(0x103), 0xFFFE);\n\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0x103), 0xFFFB, 0x4);\n\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0x103), 0xFFEF, 0x10);\n\t\tb43_radio_maskset(dev, B2063_IQ_CALIB_CTL2, 0xF3, 0x1);\n\t\tlpphy_set_tssi_mux(dev, TSSI_MUX_POSTPA);\n\t}\n\tb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_IDLETSSI, 0x7FFF, 0x8000);\n\tb43_phy_mask(dev, B43_LPPHY_TX_PWR_CTL_DELTAPWR_LIMIT, 0xFF);\n\tb43_phy_write(dev, B43_LPPHY_TX_PWR_CTL_DELTAPWR_LIMIT, 0xA);\n\tb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_CMD,\n\t\t\t~B43_LPPHY_TX_PWR_CTL_CMD_MODE & 0xFFFF,\n\t\t\tB43_LPPHY_TX_PWR_CTL_CMD_MODE_OFF);\n\tb43_phy_mask(dev, B43_LPPHY_TX_PWR_CTL_NNUM, 0xF8FF);\n\tb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_CMD,\n\t\t\t~B43_LPPHY_TX_PWR_CTL_CMD_MODE & 0xFFFF,\n\t\t\tB43_LPPHY_TX_PWR_CTL_CMD_MODE_SW);\n\n\tif (dev->phy.rev < 2) {\n\t\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_0, 0xEFFF, 0x1000);\n\t\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xEFFF);\n\t} else {\n\t\tlpphy_set_tx_power_by_index(dev, 0x7F);\n\t}\n\n\tb43_dummy_transmission(dev, true, true);\n\n\ttmp = b43_phy_read(dev, B43_LPPHY_TX_PWR_CTL_STAT);\n\tif (tmp & 0x8000) {\n\t\tb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_IDLETSSI,\n\t\t\t\t0xFFC0, (tmp & 0xFF) - 32);\n\t}\n\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xEFFF);\n\n\t\n\t\n}\n\nstatic void lpphy_tx_pctl_init_sw(struct b43_wldev *dev)\n{\n\tstruct lpphy_tx_gains gains;\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\tgains.gm = 4;\n\t\tgains.pad = 12;\n\t\tgains.pga = 12;\n\t\tgains.dac = 0;\n\t} else {\n\t\tgains.gm = 7;\n\t\tgains.pad = 14;\n\t\tgains.pga = 15;\n\t\tgains.dac = 0;\n\t}\n\tlpphy_set_tx_gains(dev, gains);\n\tlpphy_set_bb_mult(dev, 150);\n}\n\n \nstatic void lpphy_tx_pctl_init(struct b43_wldev *dev)\n{\n\tif (0 ) {\n\t\tlpphy_tx_pctl_init_hw(dev);\n\t} else {  \n\t\tlpphy_tx_pctl_init_sw(dev);\n\t}\n}\n\nstatic void lpphy_pr41573_workaround(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tu32 *saved_tab;\n\tconst unsigned int saved_tab_size = 256;\n\tenum b43_lpphy_txpctl_mode txpctl_mode;\n\ts8 tx_pwr_idx_over;\n\tu16 tssi_npt, tssi_idx;\n\n\tsaved_tab = kcalloc(saved_tab_size, sizeof(saved_tab[0]), GFP_KERNEL);\n\tif (!saved_tab) {\n\t\tb43err(dev->wl, \"PR41573 failed. Out of memory!\\n\");\n\t\treturn;\n\t}\n\n\tlpphy_read_tx_pctl_mode_from_hardware(dev);\n\ttxpctl_mode = lpphy->txpctl_mode;\n\ttx_pwr_idx_over = lpphy->tx_pwr_idx_over;\n\ttssi_npt = lpphy->tssi_npt;\n\ttssi_idx = lpphy->tssi_idx;\n\n\tif (dev->phy.rev < 2) {\n\t\tb43_lptab_read_bulk(dev, B43_LPTAB32(10, 0x140),\n\t\t\t\t    saved_tab_size, saved_tab);\n\t} else {\n\t\tb43_lptab_read_bulk(dev, B43_LPTAB32(7, 0x140),\n\t\t\t\t    saved_tab_size, saved_tab);\n\t}\n\t\n\tlpphy_table_init(dev); \n\tlpphy_baseband_init(dev);\n\tlpphy_tx_pctl_init(dev);\n\tb43_lpphy_op_software_rfkill(dev, false);\n\tlpphy_set_tx_power_control(dev, B43_LPPHY_TXPCTL_OFF);\n\tif (dev->phy.rev < 2) {\n\t\tb43_lptab_write_bulk(dev, B43_LPTAB32(10, 0x140),\n\t\t\t\t     saved_tab_size, saved_tab);\n\t} else {\n\t\tb43_lptab_write_bulk(dev, B43_LPTAB32(7, 0x140),\n\t\t\t\t     saved_tab_size, saved_tab);\n\t}\n\tb43_write16(dev, B43_MMIO_CHANNEL, lpphy->channel);\n\tlpphy->tssi_npt = tssi_npt;\n\tlpphy->tssi_idx = tssi_idx;\n\tlpphy_set_analog_filter(dev, lpphy->channel);\n\tif (tx_pwr_idx_over != -1)\n\t\tlpphy_set_tx_power_by_index(dev, tx_pwr_idx_over);\n\tif (lpphy->rc_cap)\n\t\tlpphy_set_rc_cap(dev);\n\tb43_lpphy_op_set_rx_antenna(dev, lpphy->antenna);\n\tlpphy_set_tx_power_control(dev, txpctl_mode);\n\tkfree(saved_tab);\n}\n\nstruct lpphy_rx_iq_comp { u8 chan; s8 c1, c0; };\n\nstatic const struct lpphy_rx_iq_comp lpphy_5354_iq_table[] = {\n\t{ .chan = 1, .c1 = -66, .c0 = 15, },\n\t{ .chan = 2, .c1 = -66, .c0 = 15, },\n\t{ .chan = 3, .c1 = -66, .c0 = 15, },\n\t{ .chan = 4, .c1 = -66, .c0 = 15, },\n\t{ .chan = 5, .c1 = -66, .c0 = 15, },\n\t{ .chan = 6, .c1 = -66, .c0 = 15, },\n\t{ .chan = 7, .c1 = -66, .c0 = 14, },\n\t{ .chan = 8, .c1 = -66, .c0 = 14, },\n\t{ .chan = 9, .c1 = -66, .c0 = 14, },\n\t{ .chan = 10, .c1 = -66, .c0 = 14, },\n\t{ .chan = 11, .c1 = -66, .c0 = 14, },\n\t{ .chan = 12, .c1 = -66, .c0 = 13, },\n\t{ .chan = 13, .c1 = -66, .c0 = 13, },\n\t{ .chan = 14, .c1 = -66, .c0 = 13, },\n};\n\nstatic const struct lpphy_rx_iq_comp lpphy_rev0_1_iq_table[] = {\n\t{ .chan = 1, .c1 = -64, .c0 = 13, },\n\t{ .chan = 2, .c1 = -64, .c0 = 13, },\n\t{ .chan = 3, .c1 = -64, .c0 = 13, },\n\t{ .chan = 4, .c1 = -64, .c0 = 13, },\n\t{ .chan = 5, .c1 = -64, .c0 = 12, },\n\t{ .chan = 6, .c1 = -64, .c0 = 12, },\n\t{ .chan = 7, .c1 = -64, .c0 = 12, },\n\t{ .chan = 8, .c1 = -64, .c0 = 12, },\n\t{ .chan = 9, .c1 = -64, .c0 = 12, },\n\t{ .chan = 10, .c1 = -64, .c0 = 11, },\n\t{ .chan = 11, .c1 = -64, .c0 = 11, },\n\t{ .chan = 12, .c1 = -64, .c0 = 11, },\n\t{ .chan = 13, .c1 = -64, .c0 = 11, },\n\t{ .chan = 14, .c1 = -64, .c0 = 10, },\n\t{ .chan = 34, .c1 = -62, .c0 = 24, },\n\t{ .chan = 38, .c1 = -62, .c0 = 24, },\n\t{ .chan = 42, .c1 = -62, .c0 = 24, },\n\t{ .chan = 46, .c1 = -62, .c0 = 23, },\n\t{ .chan = 36, .c1 = -62, .c0 = 24, },\n\t{ .chan = 40, .c1 = -62, .c0 = 24, },\n\t{ .chan = 44, .c1 = -62, .c0 = 23, },\n\t{ .chan = 48, .c1 = -62, .c0 = 23, },\n\t{ .chan = 52, .c1 = -62, .c0 = 23, },\n\t{ .chan = 56, .c1 = -62, .c0 = 22, },\n\t{ .chan = 60, .c1 = -62, .c0 = 22, },\n\t{ .chan = 64, .c1 = -62, .c0 = 22, },\n\t{ .chan = 100, .c1 = -62, .c0 = 16, },\n\t{ .chan = 104, .c1 = -62, .c0 = 16, },\n\t{ .chan = 108, .c1 = -62, .c0 = 15, },\n\t{ .chan = 112, .c1 = -62, .c0 = 14, },\n\t{ .chan = 116, .c1 = -62, .c0 = 14, },\n\t{ .chan = 120, .c1 = -62, .c0 = 13, },\n\t{ .chan = 124, .c1 = -62, .c0 = 12, },\n\t{ .chan = 128, .c1 = -62, .c0 = 12, },\n\t{ .chan = 132, .c1 = -62, .c0 = 12, },\n\t{ .chan = 136, .c1 = -62, .c0 = 11, },\n\t{ .chan = 140, .c1 = -62, .c0 = 10, },\n\t{ .chan = 149, .c1 = -61, .c0 = 9, },\n\t{ .chan = 153, .c1 = -61, .c0 = 9, },\n\t{ .chan = 157, .c1 = -61, .c0 = 9, },\n\t{ .chan = 161, .c1 = -61, .c0 = 8, },\n\t{ .chan = 165, .c1 = -61, .c0 = 8, },\n\t{ .chan = 184, .c1 = -62, .c0 = 25, },\n\t{ .chan = 188, .c1 = -62, .c0 = 25, },\n\t{ .chan = 192, .c1 = -62, .c0 = 25, },\n\t{ .chan = 196, .c1 = -62, .c0 = 25, },\n\t{ .chan = 200, .c1 = -62, .c0 = 25, },\n\t{ .chan = 204, .c1 = -62, .c0 = 25, },\n\t{ .chan = 208, .c1 = -62, .c0 = 25, },\n\t{ .chan = 212, .c1 = -62, .c0 = 25, },\n\t{ .chan = 216, .c1 = -62, .c0 = 26, },\n};\n\nstatic const struct lpphy_rx_iq_comp lpphy_rev2plus_iq_comp = {\n\t.chan = 0,\n\t.c1 = -64,\n\t.c0 = 0,\n};\n\nstatic int lpphy_calc_rx_iq_comp(struct b43_wldev *dev, u16 samples)\n{\n\tstruct lpphy_iq_est iq_est;\n\tu16 c0, c1;\n\tint prod, ipwr, qpwr, prod_msb, q_msb, tmp1, tmp2, tmp3, tmp4, ret;\n\n\tc1 = b43_phy_read(dev, B43_LPPHY_RX_COMP_COEFF_S);\n\tc0 = c1 >> 8;\n\tc1 |= 0xFF;\n\n\tb43_phy_maskset(dev, B43_LPPHY_RX_COMP_COEFF_S, 0xFF00, 0x00C0);\n\tb43_phy_mask(dev, B43_LPPHY_RX_COMP_COEFF_S, 0x00FF);\n\n\tret = lpphy_rx_iq_est(dev, samples, 32, &iq_est);\n\tif (!ret)\n\t\tgoto out;\n\n\tprod = iq_est.iq_prod;\n\tipwr = iq_est.i_pwr;\n\tqpwr = iq_est.q_pwr;\n\n\tif (ipwr + qpwr < 2) {\n\t\tret = 0;\n\t\tgoto out;\n\t}\n\n\tprod_msb = fls(abs(prod));\n\tq_msb = fls(abs(qpwr));\n\ttmp1 = prod_msb - 20;\n\n\tif (tmp1 >= 0) {\n\t\ttmp3 = ((prod << (30 - prod_msb)) + (ipwr >> (1 + tmp1))) /\n\t\t\t(ipwr >> tmp1);\n\t} else {\n\t\ttmp3 = ((prod << (30 - prod_msb)) + (ipwr << (-1 - tmp1))) /\n\t\t\t(ipwr << -tmp1);\n\t}\n\n\ttmp2 = q_msb - 11;\n\n\tif (tmp2 >= 0)\n\t\ttmp4 = (qpwr << (31 - q_msb)) / (ipwr >> tmp2);\n\telse\n\t\ttmp4 = (qpwr << (31 - q_msb)) / (ipwr << -tmp2);\n\n\ttmp4 -= tmp3 * tmp3;\n\ttmp4 = -int_sqrt(tmp4);\n\n\tc0 = tmp3 >> 3;\n\tc1 = tmp4 >> 4;\n\nout:\n\tb43_phy_maskset(dev, B43_LPPHY_RX_COMP_COEFF_S, 0xFF00, c1);\n\tb43_phy_maskset(dev, B43_LPPHY_RX_COMP_COEFF_S, 0x00FF, c0 << 8);\n\treturn ret;\n}\n\nstatic void lpphy_run_samples(struct b43_wldev *dev, u16 samples, u16 loops,\n\t\t\t      u16 wait)\n{\n\tb43_phy_maskset(dev, B43_LPPHY_SMPL_PLAY_BUFFER_CTL,\n\t\t\t0xFFC0, samples - 1);\n\tif (loops != 0xFFFF)\n\t\tloops--;\n\tb43_phy_maskset(dev, B43_LPPHY_SMPL_PLAY_COUNT, 0xF000, loops);\n\tb43_phy_maskset(dev, B43_LPPHY_SMPL_PLAY_BUFFER_CTL, 0x3F, wait << 6);\n\tb43_phy_set(dev, B43_LPPHY_A_PHY_CTL_ADDR, 0x1);\n}\n\n\nstatic void lpphy_start_tx_tone(struct b43_wldev *dev, s32 freq, u16 max)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tu16 buf[64];\n\tint i, samples = 0, theta = 0;\n\tint rotation = (((36 * freq) / 20) << 16) / 100;\n\tstruct cordic_iq sample;\n\n\tlpphy->tx_tone_freq = freq;\n\n\tif (freq) {\n\t\t \n\t\tfor (i = 1; samples * abs(freq) != 20000 * i; i++) {\n\t\t\tsamples = (20000 * i) / abs(freq);\n\t\t\tif(B43_WARN_ON(samples > 63))\n\t\t\t\treturn;\n\t\t}\n\t} else {\n\t\tsamples = 2;\n\t}\n\n\tfor (i = 0; i < samples; i++) {\n\t\tsample = cordic_calc_iq(CORDIC_FIXED(theta));\n\t\ttheta += rotation;\n\t\tbuf[i] = CORDIC_FLOAT((sample.i * max) & 0xFF) << 8;\n\t\tbuf[i] |= CORDIC_FLOAT((sample.q * max) & 0xFF);\n\t}\n\n\tb43_lptab_write_bulk(dev, B43_LPTAB16(5, 0), samples, buf);\n\n\tlpphy_run_samples(dev, samples, 0xFFFF, 0);\n}\n\nstatic void lpphy_stop_tx_tone(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tint i;\n\n\tlpphy->tx_tone_freq = 0;\n\n\tb43_phy_mask(dev, B43_LPPHY_SMPL_PLAY_COUNT, 0xF000);\n\tfor (i = 0; i < 31; i++) {\n\t\tif (!(b43_phy_read(dev, B43_LPPHY_A_PHY_CTL_ADDR) & 0x1))\n\t\t\tbreak;\n\t\tudelay(100);\n\t}\n}\n\n\nstatic void lpphy_papd_cal_txpwr(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tstruct lpphy_tx_gains oldgains;\n\tint old_txpctl, old_afe_ovr, old_rf, old_bbmult;\n\n\tlpphy_read_tx_pctl_mode_from_hardware(dev);\n\told_txpctl = lpphy->txpctl_mode;\n\told_afe_ovr = b43_phy_read(dev, B43_LPPHY_AFE_CTL_OVR) & 0x40;\n\tif (old_afe_ovr)\n\t\toldgains = lpphy_get_tx_gains(dev);\n\told_rf = b43_phy_read(dev, B43_LPPHY_RF_PWR_OVERRIDE) & 0xFF;\n\told_bbmult = lpphy_get_bb_mult(dev);\n\n\tlpphy_set_tx_power_control(dev, B43_LPPHY_TXPCTL_OFF);\n\n\tif (old_afe_ovr)\n\t\tlpphy_set_tx_gains(dev, oldgains);\n\tlpphy_set_bb_mult(dev, old_bbmult);\n\tlpphy_set_tx_power_control(dev, old_txpctl);\n\tb43_phy_maskset(dev, B43_LPPHY_RF_PWR_OVERRIDE, 0xFF00, old_rf);\n}\n\nstatic int lpphy_rx_iq_cal(struct b43_wldev *dev, bool noise, bool tx,\n\t\t\t    bool rx, bool pa, struct lpphy_tx_gains *gains)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tconst struct lpphy_rx_iq_comp *iqcomp = NULL;\n\tstruct lpphy_tx_gains nogains, oldgains;\n\tu16 tmp;\n\tint i, ret;\n\n\tmemset(&nogains, 0, sizeof(nogains));\n\tmemset(&oldgains, 0, sizeof(oldgains));\n\n\tif (dev->dev->chip_id == 0x5354) {\n\t\tfor (i = 0; i < ARRAY_SIZE(lpphy_5354_iq_table); i++) {\n\t\t\tif (lpphy_5354_iq_table[i].chan == lpphy->channel) {\n\t\t\t\tiqcomp = &lpphy_5354_iq_table[i];\n\t\t\t}\n\t\t}\n\t} else if (dev->phy.rev >= 2) {\n\t\tiqcomp = &lpphy_rev2plus_iq_comp;\n\t} else {\n\t\tfor (i = 0; i < ARRAY_SIZE(lpphy_rev0_1_iq_table); i++) {\n\t\t\tif (lpphy_rev0_1_iq_table[i].chan == lpphy->channel) {\n\t\t\t\tiqcomp = &lpphy_rev0_1_iq_table[i];\n\t\t\t}\n\t\t}\n\t}\n\n\tif (B43_WARN_ON(!iqcomp))\n\t\treturn 0;\n\n\tb43_phy_maskset(dev, B43_LPPHY_RX_COMP_COEFF_S, 0xFF00, iqcomp->c1);\n\tb43_phy_maskset(dev, B43_LPPHY_RX_COMP_COEFF_S,\n\t\t\t0x00FF, iqcomp->c0 << 8);\n\n\tif (noise) {\n\t\ttx = true;\n\t\trx = false;\n\t\tpa = false;\n\t}\n\n\tlpphy_set_trsw_over(dev, tx, rx);\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x8);\n\t\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_VAL_0,\n\t\t\t\t0xFFF7, pa << 3);\n\t} else {\n\t\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x20);\n\t\tb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_VAL_0,\n\t\t\t\t0xFFDF, pa << 5);\n\t}\n\n\ttmp = b43_phy_read(dev, B43_LPPHY_AFE_CTL_OVR) & 0x40;\n\n\tif (noise)\n\t\tlpphy_set_rx_gain(dev, 0x2D5D);\n\telse {\n\t\tif (tmp)\n\t\t\toldgains = lpphy_get_tx_gains(dev);\n\t\tif (!gains)\n\t\t\tgains = &nogains;\n\t\tlpphy_set_tx_gains(dev, *gains);\n\t}\n\n\tb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVR, 0xFFFE);\n\tb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0xFFFE);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x800);\n\tb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x800);\n\tlpphy_set_deaf(dev, false);\n\tif (noise)\n\t\tret = lpphy_calc_rx_iq_comp(dev, 0xFFF0);\n\telse {\n\t\tlpphy_start_tx_tone(dev, 4000, 100);\n\t\tret = lpphy_calc_rx_iq_comp(dev, 0x4000);\n\t\tlpphy_stop_tx_tone(dev);\n\t}\n\tlpphy_clear_deaf(dev, false);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFFC);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFF7);\n\tb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFDF);\n\tif (!noise) {\n\t\tif (tmp)\n\t\t\tlpphy_set_tx_gains(dev, oldgains);\n\t\telse\n\t\t\tlpphy_disable_tx_gain_override(dev);\n\t}\n\tlpphy_disable_rx_gain_override(dev);\n\tb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVR, 0xFFFE);\n\tb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0xF7FF);\n\treturn ret;\n}\n\nstatic void lpphy_calibration(struct b43_wldev *dev)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tenum b43_lpphy_txpctl_mode saved_pctl_mode;\n\tbool full_cal = false;\n\n\tif (lpphy->full_calib_chan != lpphy->channel) {\n\t\tfull_cal = true;\n\t\tlpphy->full_calib_chan = lpphy->channel;\n\t}\n\n\tb43_mac_suspend(dev);\n\n\tlpphy_btcoex_override(dev);\n\tif (dev->phy.rev >= 2)\n\t\tlpphy_save_dig_flt_state(dev);\n\tlpphy_read_tx_pctl_mode_from_hardware(dev);\n\tsaved_pctl_mode = lpphy->txpctl_mode;\n\tlpphy_set_tx_power_control(dev, B43_LPPHY_TXPCTL_OFF);\n\t\n\tif ((dev->phy.rev == 0) && (saved_pctl_mode != B43_LPPHY_TXPCTL_OFF))\n\t\tlpphy_pr41573_workaround(dev);\n\tif ((dev->phy.rev >= 2) && full_cal) {\n\t\tlpphy_papd_cal_txpwr(dev);\n\t}\n\tlpphy_set_tx_power_control(dev, saved_pctl_mode);\n\tif (dev->phy.rev >= 2)\n\t\tlpphy_restore_dig_flt_state(dev);\n\tlpphy_rx_iq_cal(dev, true, true, false, false, NULL);\n\n\tb43_mac_enable(dev);\n}\n\nstatic void b43_lpphy_op_maskset(struct b43_wldev *dev, u16 reg, u16 mask,\n\t\t\t\t u16 set)\n{\n\tb43_write16f(dev, B43_MMIO_PHY_CONTROL, reg);\n\tb43_write16(dev, B43_MMIO_PHY_DATA,\n\t\t    (b43_read16(dev, B43_MMIO_PHY_DATA) & mask) | set);\n}\n\nstatic u16 b43_lpphy_op_radio_read(struct b43_wldev *dev, u16 reg)\n{\n\t \n\tB43_WARN_ON(reg == 1);\n\t \n\tif (dev->phy.rev < 2) {\n\t\tif (reg != 0x4001)\n\t\t\treg |= 0x100;\n\t} else\n\t\treg |= 0x200;\n\n\tb43_write16f(dev, B43_MMIO_RADIO_CONTROL, reg);\n\treturn b43_read16(dev, B43_MMIO_RADIO_DATA_LOW);\n}\n\nstatic void b43_lpphy_op_radio_write(struct b43_wldev *dev, u16 reg, u16 value)\n{\n\t \n\tB43_WARN_ON(reg == 1);\n\n\tb43_write16f(dev, B43_MMIO_RADIO_CONTROL, reg);\n\tb43_write16(dev, B43_MMIO_RADIO_DATA_LOW, value);\n}\n\nstruct b206x_channel {\n\tu8 channel;\n\tu16 freq;\n\tu8 data[12];\n};\n\nstatic const struct b206x_channel b2062_chantbl[] = {\n\t{ .channel = 1, .freq = 2412, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 2, .freq = 2417, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 3, .freq = 2422, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 4, .freq = 2427, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 5, .freq = 2432, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 6, .freq = 2437, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 7, .freq = 2442, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 8, .freq = 2447, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 9, .freq = 2452, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 10, .freq = 2457, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 11, .freq = 2462, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 12, .freq = 2467, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 13, .freq = 2472, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 14, .freq = 2484, .data[0] = 0xFF, .data[1] = 0xFF,\n\t  .data[2] = 0xB5, .data[3] = 0x1B, .data[4] = 0x24, .data[5] = 0x32,\n\t  .data[6] = 0x32, .data[7] = 0x88, .data[8] = 0x88, },\n\t{ .channel = 34, .freq = 5170, .data[0] = 0x00, .data[1] = 0x22,\n\t  .data[2] = 0x20, .data[3] = 0x84, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 38, .freq = 5190, .data[0] = 0x00, .data[1] = 0x11,\n\t  .data[2] = 0x10, .data[3] = 0x83, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 42, .freq = 5210, .data[0] = 0x00, .data[1] = 0x11,\n\t  .data[2] = 0x10, .data[3] = 0x83, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 46, .freq = 5230, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x83, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 36, .freq = 5180, .data[0] = 0x00, .data[1] = 0x11,\n\t  .data[2] = 0x20, .data[3] = 0x83, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 40, .freq = 5200, .data[0] = 0x00, .data[1] = 0x11,\n\t  .data[2] = 0x10, .data[3] = 0x84, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 44, .freq = 5220, .data[0] = 0x00, .data[1] = 0x11,\n\t  .data[2] = 0x00, .data[3] = 0x83, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 48, .freq = 5240, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x83, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 52, .freq = 5260, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x83, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 56, .freq = 5280, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x83, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 60, .freq = 5300, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x63, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 64, .freq = 5320, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x62, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 100, .freq = 5500, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x30, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 104, .freq = 5520, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x20, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 108, .freq = 5540, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x20, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 112, .freq = 5560, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x20, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 116, .freq = 5580, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x10, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 120, .freq = 5600, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 124, .freq = 5620, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 128, .freq = 5640, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 132, .freq = 5660, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 136, .freq = 5680, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 140, .freq = 5700, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 149, .freq = 5745, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 153, .freq = 5765, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 157, .freq = 5785, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 161, .freq = 5805, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 165, .freq = 5825, .data[0] = 0x00, .data[1] = 0x00,\n\t  .data[2] = 0x00, .data[3] = 0x00, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x37, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 184, .freq = 4920, .data[0] = 0x55, .data[1] = 0x77,\n\t  .data[2] = 0x90, .data[3] = 0xF7, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0xFF, },\n\t{ .channel = 188, .freq = 4940, .data[0] = 0x44, .data[1] = 0x77,\n\t  .data[2] = 0x80, .data[3] = 0xE7, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0xFF, },\n\t{ .channel = 192, .freq = 4960, .data[0] = 0x44, .data[1] = 0x66,\n\t  .data[2] = 0x80, .data[3] = 0xE7, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0xFF, },\n\t{ .channel = 196, .freq = 4980, .data[0] = 0x33, .data[1] = 0x66,\n\t  .data[2] = 0x70, .data[3] = 0xC7, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0xFF, },\n\t{ .channel = 200, .freq = 5000, .data[0] = 0x22, .data[1] = 0x55,\n\t  .data[2] = 0x60, .data[3] = 0xD7, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0xFF, },\n\t{ .channel = 204, .freq = 5020, .data[0] = 0x22, .data[1] = 0x55,\n\t  .data[2] = 0x60, .data[3] = 0xC7, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0xFF, },\n\t{ .channel = 208, .freq = 5040, .data[0] = 0x22, .data[1] = 0x44,\n\t  .data[2] = 0x50, .data[3] = 0xC7, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0xFF, },\n\t{ .channel = 212, .freq = 5060, .data[0] = 0x11, .data[1] = 0x44,\n\t  .data[2] = 0x50, .data[3] = 0xA5, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n\t{ .channel = 216, .freq = 5080, .data[0] = 0x00, .data[1] = 0x44,\n\t  .data[2] = 0x40, .data[3] = 0xB6, .data[4] = 0x3C, .data[5] = 0x77,\n\t  .data[6] = 0x35, .data[7] = 0xFF, .data[8] = 0x88, },\n};\n\nstatic const struct b206x_channel b2063_chantbl[] = {\n\t{ .channel = 1, .freq = 2412, .data[0] = 0x6F, .data[1] = 0x3C,\n\t  .data[2] = 0x3C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 2, .freq = 2417, .data[0] = 0x6F, .data[1] = 0x3C,\n\t  .data[2] = 0x3C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 3, .freq = 2422, .data[0] = 0x6F, .data[1] = 0x3C,\n\t  .data[2] = 0x3C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 4, .freq = 2427, .data[0] = 0x6F, .data[1] = 0x2C,\n\t  .data[2] = 0x2C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 5, .freq = 2432, .data[0] = 0x6F, .data[1] = 0x2C,\n\t  .data[2] = 0x2C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 6, .freq = 2437, .data[0] = 0x6F, .data[1] = 0x2C,\n\t  .data[2] = 0x2C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 7, .freq = 2442, .data[0] = 0x6F, .data[1] = 0x2C,\n\t  .data[2] = 0x2C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 8, .freq = 2447, .data[0] = 0x6F, .data[1] = 0x2C,\n\t  .data[2] = 0x2C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 9, .freq = 2452, .data[0] = 0x6F, .data[1] = 0x1C,\n\t  .data[2] = 0x1C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 10, .freq = 2457, .data[0] = 0x6F, .data[1] = 0x1C,\n\t  .data[2] = 0x1C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 11, .freq = 2462, .data[0] = 0x6E, .data[1] = 0x1C,\n\t  .data[2] = 0x1C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 12, .freq = 2467, .data[0] = 0x6E, .data[1] = 0x1C,\n\t  .data[2] = 0x1C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 13, .freq = 2472, .data[0] = 0x6E, .data[1] = 0x1C,\n\t  .data[2] = 0x1C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 14, .freq = 2484, .data[0] = 0x6E, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x04, .data[4] = 0x05, .data[5] = 0x05,\n\t  .data[6] = 0x05, .data[7] = 0x05, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x80, .data[11] = 0x70, },\n\t{ .channel = 34, .freq = 5170, .data[0] = 0x6A, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x02, .data[5] = 0x05,\n\t  .data[6] = 0x0D, .data[7] = 0x0D, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x20, .data[11] = 0x00, },\n\t{ .channel = 36, .freq = 5180, .data[0] = 0x6A, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x01, .data[5] = 0x05,\n\t  .data[6] = 0x0D, .data[7] = 0x0C, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x20, .data[11] = 0x00, },\n\t{ .channel = 38, .freq = 5190, .data[0] = 0x6A, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x01, .data[5] = 0x04,\n\t  .data[6] = 0x0C, .data[7] = 0x0C, .data[8] = 0x77, .data[9] = 0x80,\n\t  .data[10] = 0x20, .data[11] = 0x00, },\n\t{ .channel = 40, .freq = 5200, .data[0] = 0x69, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x01, .data[5] = 0x04,\n\t  .data[6] = 0x0C, .data[7] = 0x0C, .data[8] = 0x77, .data[9] = 0x70,\n\t  .data[10] = 0x20, .data[11] = 0x00, },\n\t{ .channel = 42, .freq = 5210, .data[0] = 0x69, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x01, .data[5] = 0x04,\n\t  .data[6] = 0x0B, .data[7] = 0x0C, .data[8] = 0x77, .data[9] = 0x70,\n\t  .data[10] = 0x20, .data[11] = 0x00, },\n\t{ .channel = 44, .freq = 5220, .data[0] = 0x69, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x04,\n\t  .data[6] = 0x0B, .data[7] = 0x0B, .data[8] = 0x77, .data[9] = 0x60,\n\t  .data[10] = 0x20, .data[11] = 0x00, },\n\t{ .channel = 46, .freq = 5230, .data[0] = 0x69, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x03,\n\t  .data[6] = 0x0A, .data[7] = 0x0B, .data[8] = 0x77, .data[9] = 0x60,\n\t  .data[10] = 0x20, .data[11] = 0x00, },\n\t{ .channel = 48, .freq = 5240, .data[0] = 0x69, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x03,\n\t  .data[6] = 0x0A, .data[7] = 0x0A, .data[8] = 0x77, .data[9] = 0x60,\n\t  .data[10] = 0x20, .data[11] = 0x00, },\n\t{ .channel = 52, .freq = 5260, .data[0] = 0x68, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x02,\n\t  .data[6] = 0x09, .data[7] = 0x09, .data[8] = 0x77, .data[9] = 0x60,\n\t  .data[10] = 0x20, .data[11] = 0x00, },\n\t{ .channel = 56, .freq = 5280, .data[0] = 0x68, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x01,\n\t  .data[6] = 0x08, .data[7] = 0x08, .data[8] = 0x77, .data[9] = 0x50,\n\t  .data[10] = 0x10, .data[11] = 0x00, },\n\t{ .channel = 60, .freq = 5300, .data[0] = 0x68, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x01,\n\t  .data[6] = 0x08, .data[7] = 0x08, .data[8] = 0x77, .data[9] = 0x50,\n\t  .data[10] = 0x10, .data[11] = 0x00, },\n\t{ .channel = 64, .freq = 5320, .data[0] = 0x67, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x08, .data[7] = 0x08, .data[8] = 0x77, .data[9] = 0x50,\n\t  .data[10] = 0x10, .data[11] = 0x00, },\n\t{ .channel = 100, .freq = 5500, .data[0] = 0x64, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x02, .data[7] = 0x01, .data[8] = 0x77, .data[9] = 0x20,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 104, .freq = 5520, .data[0] = 0x64, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x01, .data[7] = 0x01, .data[8] = 0x77, .data[9] = 0x20,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 108, .freq = 5540, .data[0] = 0x63, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x01, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x10,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 112, .freq = 5560, .data[0] = 0x63, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x10,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 116, .freq = 5580, .data[0] = 0x62, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x10,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 120, .freq = 5600, .data[0] = 0x62, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 124, .freq = 5620, .data[0] = 0x62, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 128, .freq = 5640, .data[0] = 0x61, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 132, .freq = 5660, .data[0] = 0x61, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 136, .freq = 5680, .data[0] = 0x61, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 140, .freq = 5700, .data[0] = 0x60, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 149, .freq = 5745, .data[0] = 0x60, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 153, .freq = 5765, .data[0] = 0x60, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 157, .freq = 5785, .data[0] = 0x60, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 161, .freq = 5805, .data[0] = 0x60, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 165, .freq = 5825, .data[0] = 0x60, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x00, .data[5] = 0x00,\n\t  .data[6] = 0x00, .data[7] = 0x00, .data[8] = 0x77, .data[9] = 0x00,\n\t  .data[10] = 0x00, .data[11] = 0x00, },\n\t{ .channel = 184, .freq = 4920, .data[0] = 0x6E, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x09, .data[5] = 0x0E,\n\t  .data[6] = 0x0F, .data[7] = 0x0F, .data[8] = 0x77, .data[9] = 0xC0,\n\t  .data[10] = 0x50, .data[11] = 0x00, },\n\t{ .channel = 188, .freq = 4940, .data[0] = 0x6E, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x09, .data[5] = 0x0D,\n\t  .data[6] = 0x0F, .data[7] = 0x0F, .data[8] = 0x77, .data[9] = 0xB0,\n\t  .data[10] = 0x50, .data[11] = 0x00, },\n\t{ .channel = 192, .freq = 4960, .data[0] = 0x6E, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x08, .data[5] = 0x0C,\n\t  .data[6] = 0x0F, .data[7] = 0x0F, .data[8] = 0x77, .data[9] = 0xB0,\n\t  .data[10] = 0x50, .data[11] = 0x00, },\n\t{ .channel = 196, .freq = 4980, .data[0] = 0x6D, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x08, .data[5] = 0x0C,\n\t  .data[6] = 0x0F, .data[7] = 0x0F, .data[8] = 0x77, .data[9] = 0xA0,\n\t  .data[10] = 0x40, .data[11] = 0x00, },\n\t{ .channel = 200, .freq = 5000, .data[0] = 0x6D, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x08, .data[5] = 0x0B,\n\t  .data[6] = 0x0F, .data[7] = 0x0F, .data[8] = 0x77, .data[9] = 0xA0,\n\t  .data[10] = 0x40, .data[11] = 0x00, },\n\t{ .channel = 204, .freq = 5020, .data[0] = 0x6D, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x08, .data[5] = 0x0A,\n\t  .data[6] = 0x0F, .data[7] = 0x0F, .data[8] = 0x77, .data[9] = 0xA0,\n\t  .data[10] = 0x40, .data[11] = 0x00, },\n\t{ .channel = 208, .freq = 5040, .data[0] = 0x6C, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x07, .data[5] = 0x09,\n\t  .data[6] = 0x0F, .data[7] = 0x0F, .data[8] = 0x77, .data[9] = 0x90,\n\t  .data[10] = 0x40, .data[11] = 0x00, },\n\t{ .channel = 212, .freq = 5060, .data[0] = 0x6C, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x06, .data[5] = 0x08,\n\t  .data[6] = 0x0F, .data[7] = 0x0F, .data[8] = 0x77, .data[9] = 0x90,\n\t  .data[10] = 0x40, .data[11] = 0x00, },\n\t{ .channel = 216, .freq = 5080, .data[0] = 0x6C, .data[1] = 0x0C,\n\t  .data[2] = 0x0C, .data[3] = 0x00, .data[4] = 0x05, .data[5] = 0x08,\n\t  .data[6] = 0x0F, .data[7] = 0x0F, .data[8] = 0x77, .data[9] = 0x90,\n\t  .data[10] = 0x40, .data[11] = 0x00, },\n};\n\nstatic void lpphy_b2062_reset_pll_bias(struct b43_wldev *dev)\n{\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL2, 0xFF);\n\tudelay(20);\n\tif (dev->dev->chip_id == 0x5354) {\n\t\tb43_radio_write(dev, B2062_N_COMM1, 4);\n\t\tb43_radio_write(dev, B2062_S_RFPLL_CTL2, 4);\n\t} else {\n\t\tb43_radio_write(dev, B2062_S_RFPLL_CTL2, 0);\n\t}\n\tudelay(5);\n}\n\nstatic void lpphy_b2062_vco_calib(struct b43_wldev *dev)\n{\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL21, 0x42);\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL21, 0x62);\n\tudelay(200);\n}\n\nstatic int lpphy_b2062_tune(struct b43_wldev *dev,\n\t\t\t    unsigned int channel)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tstruct ssb_bus *bus = dev->dev->sdev->bus;\n\tconst struct b206x_channel *chandata = NULL;\n\tu32 crystal_freq = bus->chipco.pmu.crystalfreq * 1000;\n\tu32 tmp1, tmp2, tmp3, tmp4, tmp5, tmp6, tmp7, tmp8, tmp9;\n\tint i, err = 0;\n\n\tfor (i = 0; i < ARRAY_SIZE(b2062_chantbl); i++) {\n\t\tif (b2062_chantbl[i].channel == channel) {\n\t\t\tchandata = &b2062_chantbl[i];\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (B43_WARN_ON(!chandata))\n\t\treturn -EINVAL;\n\n\tb43_radio_set(dev, B2062_S_RFPLL_CTL14, 0x04);\n\tb43_radio_write(dev, B2062_N_LGENA_TUNE0, chandata->data[0]);\n\tb43_radio_write(dev, B2062_N_LGENA_TUNE2, chandata->data[1]);\n\tb43_radio_write(dev, B2062_N_LGENA_TUNE3, chandata->data[2]);\n\tb43_radio_write(dev, B2062_N_TX_TUNE, chandata->data[3]);\n\tb43_radio_write(dev, B2062_S_LGENG_CTL1, chandata->data[4]);\n\tb43_radio_write(dev, B2062_N_LGENA_CTL5, chandata->data[5]);\n\tb43_radio_write(dev, B2062_N_LGENA_CTL6, chandata->data[6]);\n\tb43_radio_write(dev, B2062_N_TX_PGA, chandata->data[7]);\n\tb43_radio_write(dev, B2062_N_TX_PAD, chandata->data[8]);\n\n\ttmp1 = crystal_freq / 1000;\n\ttmp2 = lpphy->pdiv * 1000;\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL33, 0xCC);\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL34, 0x07);\n\tlpphy_b2062_reset_pll_bias(dev);\n\ttmp3 = tmp2 * channel2freq_lp(channel);\n\tif (channel2freq_lp(channel) < 4000)\n\t\ttmp3 *= 2;\n\ttmp4 = 48 * tmp1;\n\ttmp6 = tmp3 / tmp4;\n\ttmp7 = tmp3 % tmp4;\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL26, tmp6);\n\ttmp5 = tmp7 * 0x100;\n\ttmp6 = tmp5 / tmp4;\n\ttmp7 = tmp5 % tmp4;\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL27, tmp6);\n\ttmp5 = tmp7 * 0x100;\n\ttmp6 = tmp5 / tmp4;\n\ttmp7 = tmp5 % tmp4;\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL28, tmp6);\n\ttmp5 = tmp7 * 0x100;\n\ttmp6 = tmp5 / tmp4;\n\ttmp7 = tmp5 % tmp4;\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL29, tmp6 + ((2 * tmp7) / tmp4));\n\ttmp8 = b43_radio_read(dev, B2062_S_RFPLL_CTL19);\n\ttmp9 = ((2 * tmp3 * (tmp8 + 1)) + (3 * tmp1)) / (6 * tmp1);\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL23, (tmp9 >> 8) + 16);\n\tb43_radio_write(dev, B2062_S_RFPLL_CTL24, tmp9 & 0xFF);\n\n\tlpphy_b2062_vco_calib(dev);\n\tif (b43_radio_read(dev, B2062_S_RFPLL_CTL3) & 0x10) {\n\t\tb43_radio_write(dev, B2062_S_RFPLL_CTL33, 0xFC);\n\t\tb43_radio_write(dev, B2062_S_RFPLL_CTL34, 0);\n\t\tlpphy_b2062_reset_pll_bias(dev);\n\t\tlpphy_b2062_vco_calib(dev);\n\t\tif (b43_radio_read(dev, B2062_S_RFPLL_CTL3) & 0x10)\n\t\t\terr = -EIO;\n\t}\n\n\tb43_radio_mask(dev, B2062_S_RFPLL_CTL14, ~0x04);\n\treturn err;\n}\n\nstatic void lpphy_b2063_vco_calib(struct b43_wldev *dev)\n{\n\tu16 tmp;\n\n\tb43_radio_mask(dev, B2063_PLL_SP1, ~0x40);\n\ttmp = b43_radio_read(dev, B2063_PLL_JTAG_CALNRST) & 0xF8;\n\tb43_radio_write(dev, B2063_PLL_JTAG_CALNRST, tmp);\n\tudelay(1);\n\tb43_radio_write(dev, B2063_PLL_JTAG_CALNRST, tmp | 0x4);\n\tudelay(1);\n\tb43_radio_write(dev, B2063_PLL_JTAG_CALNRST, tmp | 0x6);\n\tudelay(1);\n\tb43_radio_write(dev, B2063_PLL_JTAG_CALNRST, tmp | 0x7);\n\tudelay(300);\n\tb43_radio_set(dev, B2063_PLL_SP1, 0x40);\n}\n\nstatic int lpphy_b2063_tune(struct b43_wldev *dev,\n\t\t\t    unsigned int channel)\n{\n\tstruct ssb_bus *bus = dev->dev->sdev->bus;\n\n\tstatic const struct b206x_channel *chandata = NULL;\n\tu32 crystal_freq = bus->chipco.pmu.crystalfreq * 1000;\n\tu32 freqref, vco_freq, val1, val2, val3, timeout, timeoutref, count;\n\tu16 old_comm15, scale;\n\tu32 tmp1, tmp2, tmp3, tmp4, tmp5, tmp6;\n\tint i, div = (crystal_freq <= 26000000 ? 1 : 2);\n\n\tfor (i = 0; i < ARRAY_SIZE(b2063_chantbl); i++) {\n\t\tif (b2063_chantbl[i].channel == channel) {\n\t\t\tchandata = &b2063_chantbl[i];\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (B43_WARN_ON(!chandata))\n\t\treturn -EINVAL;\n\n\tb43_radio_write(dev, B2063_LOGEN_VCOBUF1, chandata->data[0]);\n\tb43_radio_write(dev, B2063_LOGEN_MIXER2, chandata->data[1]);\n\tb43_radio_write(dev, B2063_LOGEN_BUF2, chandata->data[2]);\n\tb43_radio_write(dev, B2063_LOGEN_RCCR1, chandata->data[3]);\n\tb43_radio_write(dev, B2063_A_RX_1ST3, chandata->data[4]);\n\tb43_radio_write(dev, B2063_A_RX_2ND1, chandata->data[5]);\n\tb43_radio_write(dev, B2063_A_RX_2ND4, chandata->data[6]);\n\tb43_radio_write(dev, B2063_A_RX_2ND7, chandata->data[7]);\n\tb43_radio_write(dev, B2063_A_RX_PS6, chandata->data[8]);\n\tb43_radio_write(dev, B2063_TX_RF_CTL2, chandata->data[9]);\n\tb43_radio_write(dev, B2063_TX_RF_CTL5, chandata->data[10]);\n\tb43_radio_write(dev, B2063_PA_CTL11, chandata->data[11]);\n\n\told_comm15 = b43_radio_read(dev, B2063_COMM15);\n\tb43_radio_set(dev, B2063_COMM15, 0x1E);\n\n\tif (chandata->freq > 4000)  \n\t\tvco_freq = chandata->freq << 1;\n\telse\n\t\tvco_freq = chandata->freq << 2;\n\n\tfreqref = crystal_freq * 3;\n\tval1 = lpphy_qdiv_roundup(crystal_freq, 1000000, 16);\n\tval2 = lpphy_qdiv_roundup(crystal_freq, 1000000 * div, 16);\n\tval3 = lpphy_qdiv_roundup(vco_freq, 3, 16);\n\ttimeout = ((((8 * crystal_freq) / (div * 5000000)) + 1) >> 1) - 1;\n\tb43_radio_write(dev, B2063_PLL_JTAG_PLL_VCO_CALIB3, 0x2);\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_VCO_CALIB6,\n\t\t\t  0xFFF8, timeout >> 2);\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_VCO_CALIB7,\n\t\t\t  0xFF9F,timeout << 5);\n\n\ttimeoutref = ((((8 * crystal_freq) / (div * (timeout + 1))) +\n\t\t\t\t\t\t999999) / 1000000) + 1;\n\tb43_radio_write(dev, B2063_PLL_JTAG_PLL_VCO_CALIB5, timeoutref);\n\n\tcount = lpphy_qdiv_roundup(val3, val2 + 16, 16);\n\tcount *= (timeout + 1) * (timeoutref + 1);\n\tcount--;\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_VCO_CALIB7,\n\t\t\t\t\t\t0xF0, count >> 8);\n\tb43_radio_write(dev, B2063_PLL_JTAG_PLL_VCO_CALIB8, count & 0xFF);\n\n\ttmp1 = ((val3 * 62500) / freqref) << 4;\n\ttmp2 = ((val3 * 62500) % freqref) << 4;\n\twhile (tmp2 >= freqref) {\n\t\ttmp1++;\n\t\ttmp2 -= freqref;\n\t}\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_SG1, 0xFFE0, tmp1 >> 4);\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_SG2, 0xFE0F, tmp1 << 4);\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_SG2, 0xFFF0, tmp1 >> 16);\n\tb43_radio_write(dev, B2063_PLL_JTAG_PLL_SG3, (tmp2 >> 8) & 0xFF);\n\tb43_radio_write(dev, B2063_PLL_JTAG_PLL_SG4, tmp2 & 0xFF);\n\n\tb43_radio_write(dev, B2063_PLL_JTAG_PLL_LF1, 0xB9);\n\tb43_radio_write(dev, B2063_PLL_JTAG_PLL_LF2, 0x88);\n\tb43_radio_write(dev, B2063_PLL_JTAG_PLL_LF3, 0x28);\n\tb43_radio_write(dev, B2063_PLL_JTAG_PLL_LF4, 0x63);\n\n\ttmp3 = ((41 * (val3 - 3000)) /1200) + 27;\n\ttmp4 = lpphy_qdiv_roundup(132000 * tmp1, 8451, 16);\n\n\tif ((tmp4 + tmp3 - 1) / tmp3 > 60) {\n\t\tscale = 1;\n\t\ttmp5 = ((tmp4 + tmp3) / (tmp3 << 1)) - 8;\n\t} else {\n\t\tscale = 0;\n\t\ttmp5 = ((tmp4 + (tmp3 >> 1)) / tmp3) - 8;\n\t}\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_CP2, 0xFFC0, tmp5);\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_CP2, 0xFFBF, scale << 6);\n\n\ttmp6 = lpphy_qdiv_roundup(100 * val1, val3, 16);\n\ttmp6 *= (tmp5 * 8) * (scale + 1);\n\tif (tmp6 > 150)\n\t\ttmp6 = 0;\n\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_CP3, 0xFFE0, tmp6);\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_CP3, 0xFFDF, scale << 5);\n\n\tb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_XTAL_12, 0xFFFB, 0x4);\n\tif (crystal_freq > 26000000)\n\t\tb43_radio_set(dev, B2063_PLL_JTAG_PLL_XTAL_12, 0x2);\n\telse\n\t\tb43_radio_mask(dev, B2063_PLL_JTAG_PLL_XTAL_12, 0xFD);\n\n\tif (val1 == 45)\n\t\tb43_radio_set(dev, B2063_PLL_JTAG_PLL_VCO1, 0x2);\n\telse\n\t\tb43_radio_mask(dev, B2063_PLL_JTAG_PLL_VCO1, 0xFD);\n\n\tb43_radio_set(dev, B2063_PLL_SP2, 0x3);\n\tudelay(1);\n\tb43_radio_mask(dev, B2063_PLL_SP2, 0xFFFC);\n\tlpphy_b2063_vco_calib(dev);\n\tb43_radio_write(dev, B2063_COMM15, old_comm15);\n\n\treturn 0;\n}\n\nstatic int b43_lpphy_op_switch_channel(struct b43_wldev *dev,\n\t\t\t\t       unsigned int new_channel)\n{\n\tstruct b43_phy_lp *lpphy = dev->phy.lp;\n\tint err;\n\n\tif (dev->phy.radio_ver == 0x2063) {\n\t\terr = lpphy_b2063_tune(dev, new_channel);\n\t\tif (err)\n\t\t\treturn err;\n\t} else {\n\t\terr = lpphy_b2062_tune(dev, new_channel);\n\t\tif (err)\n\t\t\treturn err;\n\t\tlpphy_set_analog_filter(dev, new_channel);\n\t\tlpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));\n\t}\n\n\tlpphy->channel = new_channel;\n\tb43_write16(dev, B43_MMIO_CHANNEL, new_channel);\n\n\treturn 0;\n}\n\nstatic int b43_lpphy_op_init(struct b43_wldev *dev)\n{\n\tint err;\n\n\tif (dev->dev->bus_type != B43_BUS_SSB) {\n\t\tb43err(dev->wl, \"LP-PHY is supported only on SSB!\\n\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tlpphy_read_band_sprom(dev); \n\tlpphy_baseband_init(dev);\n\tlpphy_radio_init(dev);\n\tlpphy_calibrate_rc(dev);\n\terr = b43_lpphy_op_switch_channel(dev, 7);\n\tif (err) {\n\t\tb43dbg(dev->wl, \"Switch to channel 7 failed, error = %d.\\n\",\n\t\t       err);\n\t}\n\tlpphy_tx_pctl_init(dev);\n\tlpphy_calibration(dev);\n\t\n\n\treturn 0;\n}\n\nstatic void b43_lpphy_op_adjust_txpower(struct b43_wldev *dev)\n{\n\t\n}\n\nstatic enum b43_txpwr_result b43_lpphy_op_recalc_txpower(struct b43_wldev *dev,\n\t\t\t\t\t\t\t bool ignore_tssi)\n{\n\t\n\treturn B43_TXPWR_RES_DONE;\n}\n\nstatic void b43_lpphy_op_switch_analog(struct b43_wldev *dev, bool on)\n{\n       if (on) {\n               b43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVR, 0xfff8);\n       } else {\n               b43_phy_set(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0x0007);\n               b43_phy_set(dev, B43_LPPHY_AFE_CTL_OVR, 0x0007);\n       }\n}\n\nstatic void b43_lpphy_op_pwork_15sec(struct b43_wldev *dev)\n{\n\t\n}\n\nconst struct b43_phy_operations b43_phyops_lp = {\n\t.allocate\t\t= b43_lpphy_op_allocate,\n\t.free\t\t\t= b43_lpphy_op_free,\n\t.prepare_structs\t= b43_lpphy_op_prepare_structs,\n\t.init\t\t\t= b43_lpphy_op_init,\n\t.phy_maskset\t\t= b43_lpphy_op_maskset,\n\t.radio_read\t\t= b43_lpphy_op_radio_read,\n\t.radio_write\t\t= b43_lpphy_op_radio_write,\n\t.software_rfkill\t= b43_lpphy_op_software_rfkill,\n\t.switch_analog\t\t= b43_lpphy_op_switch_analog,\n\t.switch_channel\t\t= b43_lpphy_op_switch_channel,\n\t.get_default_chan\t= b43_lpphy_op_get_default_chan,\n\t.set_rx_antenna\t\t= b43_lpphy_op_set_rx_antenna,\n\t.recalc_txpower\t\t= b43_lpphy_op_recalc_txpower,\n\t.adjust_txpower\t\t= b43_lpphy_op_adjust_txpower,\n\t.pwork_15sec\t\t= b43_lpphy_op_pwork_15sec,\n\t.pwork_60sec\t\t= lpphy_calibration,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}