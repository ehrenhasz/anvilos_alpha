{
  "module_name": "phy_g.c",
  "hash_id": "d8fb2bcb5589301ac4eb5522233b1c94749376c33ae09878fc3a01f81da1701d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/b43/phy_g.c",
  "human_readable_source": "\n \n\n#include \"b43.h\"\n#include \"phy_g.h\"\n#include \"phy_common.h\"\n#include \"lo.h\"\n#include \"main.h\"\n#include \"wa.h\"\n\n#include <linux/bitrev.h>\n#include <linux/slab.h>\n\n\nstatic const s8 b43_tssi2dbm_g_table[] = {\n\t77, 77, 77, 76,\n\t76, 76, 75, 75,\n\t74, 74, 73, 73,\n\t73, 72, 72, 71,\n\t71, 70, 70, 69,\n\t68, 68, 67, 67,\n\t66, 65, 65, 64,\n\t63, 63, 62, 61,\n\t60, 59, 58, 57,\n\t56, 55, 54, 53,\n\t52, 50, 49, 47,\n\t45, 43, 40, 37,\n\t33, 28, 22, 14,\n\t5, -7, -20, -20,\n\t-20, -20, -20, -20,\n\t-20, -20, -20, -20,\n};\n\nstatic const u8 b43_radio_channel_codes_bg[] = {\n\t12, 17, 22, 27,\n\t32, 37, 42, 47,\n\t52, 57, 62, 67,\n\t72, 84,\n};\n\n\nstatic void b43_calc_nrssi_threshold(struct b43_wldev *dev);\n\n\n#define bitrev4(tmp) (bitrev8(tmp) >> 4)\n\n\n \nstatic inline u16 channel2freq_bg(u8 channel)\n{\n\tB43_WARN_ON(!(channel >= 1 && channel <= 14));\n\n\treturn b43_radio_channel_codes_bg[channel - 1];\n}\n\nstatic void generate_rfatt_list(struct b43_wldev *dev,\n\t\t\t\tstruct b43_rfatt_list *list)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\t \n\tstatic const struct b43_rfatt rfatt_0[] = {\n\t\t{.att = 3,.with_padmix = 0,},\n\t\t{.att = 1,.with_padmix = 0,},\n\t\t{.att = 5,.with_padmix = 0,},\n\t\t{.att = 7,.with_padmix = 0,},\n\t\t{.att = 9,.with_padmix = 0,},\n\t\t{.att = 2,.with_padmix = 0,},\n\t\t{.att = 0,.with_padmix = 0,},\n\t\t{.att = 4,.with_padmix = 0,},\n\t\t{.att = 6,.with_padmix = 0,},\n\t\t{.att = 8,.with_padmix = 0,},\n\t\t{.att = 1,.with_padmix = 1,},\n\t\t{.att = 2,.with_padmix = 1,},\n\t\t{.att = 3,.with_padmix = 1,},\n\t\t{.att = 4,.with_padmix = 1,},\n\t};\n\t \n\tstatic const struct b43_rfatt rfatt_1[] = {\n\t\t{.att = 2,.with_padmix = 1,},\n\t\t{.att = 4,.with_padmix = 1,},\n\t\t{.att = 6,.with_padmix = 1,},\n\t\t{.att = 8,.with_padmix = 1,},\n\t\t{.att = 10,.with_padmix = 1,},\n\t\t{.att = 12,.with_padmix = 1,},\n\t\t{.att = 14,.with_padmix = 1,},\n\t};\n\t \n\tstatic const struct b43_rfatt rfatt_2[] = {\n\t\t{.att = 0,.with_padmix = 1,},\n\t\t{.att = 2,.with_padmix = 1,},\n\t\t{.att = 4,.with_padmix = 1,},\n\t\t{.att = 6,.with_padmix = 1,},\n\t\t{.att = 8,.with_padmix = 1,},\n\t\t{.att = 9,.with_padmix = 1,},\n\t\t{.att = 9,.with_padmix = 1,},\n\t};\n\n\tif (!b43_has_hardware_pctl(dev)) {\n\t\t \n\t\tlist->list = rfatt_0;\n\t\tlist->len = ARRAY_SIZE(rfatt_0);\n\t\tlist->min_val = 0;\n\t\tlist->max_val = 9;\n\t\treturn;\n\t}\n\tif (phy->radio_ver == 0x2050 && phy->radio_rev == 8) {\n\t\t \n\t\tlist->list = rfatt_1;\n\t\tlist->len = ARRAY_SIZE(rfatt_1);\n\t\tlist->min_val = 0;\n\t\tlist->max_val = 14;\n\t\treturn;\n\t}\n\t \n\tlist->list = rfatt_2;\n\tlist->len = ARRAY_SIZE(rfatt_2);\n\tlist->min_val = 0;\n\tlist->max_val = 9;\n}\n\nstatic void generate_bbatt_list(struct b43_wldev *dev,\n\t\t\t\tstruct b43_bbatt_list *list)\n{\n\tstatic const struct b43_bbatt bbatt_0[] = {\n\t\t{.att = 0,},\n\t\t{.att = 1,},\n\t\t{.att = 2,},\n\t\t{.att = 3,},\n\t\t{.att = 4,},\n\t\t{.att = 5,},\n\t\t{.att = 6,},\n\t\t{.att = 7,},\n\t\t{.att = 8,},\n\t};\n\n\tlist->list = bbatt_0;\n\tlist->len = ARRAY_SIZE(bbatt_0);\n\tlist->min_val = 0;\n\tlist->max_val = 8;\n}\n\nstatic void b43_shm_clear_tssi(struct b43_wldev *dev)\n{\n\tb43_shm_write16(dev, B43_SHM_SHARED, 0x0058, 0x7F7F);\n\tb43_shm_write16(dev, B43_SHM_SHARED, 0x005a, 0x7F7F);\n\tb43_shm_write16(dev, B43_SHM_SHARED, 0x0070, 0x7F7F);\n\tb43_shm_write16(dev, B43_SHM_SHARED, 0x0072, 0x7F7F);\n}\n\n \nstatic void b43_synth_pu_workaround(struct b43_wldev *dev, u8 channel)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tmight_sleep();\n\n\tif (phy->radio_ver != 0x2050 || phy->radio_rev >= 6) {\n\t\t \n\t\treturn;\n\t}\n\n\tif (channel <= 10) {\n\t\tb43_write16(dev, B43_MMIO_CHANNEL,\n\t\t\t    channel2freq_bg(channel + 4));\n\t} else {\n\t\tb43_write16(dev, B43_MMIO_CHANNEL, channel2freq_bg(1));\n\t}\n\tmsleep(1);\n\tb43_write16(dev, B43_MMIO_CHANNEL, channel2freq_bg(channel));\n}\n\n \nvoid b43_gphy_set_baseband_attenuation(struct b43_wldev *dev,\n\t\t\t\t       u16 baseband_attenuation)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tif (phy->analog == 0) {\n\t\tb43_write16(dev, B43_MMIO_PHY0, (b43_read16(dev, B43_MMIO_PHY0)\n\t\t\t\t\t\t & 0xFFF0) |\n\t\t\t    baseband_attenuation);\n\t} else if (phy->analog > 1) {\n\t\tb43_phy_maskset(dev, B43_PHY_DACCTL, 0xFFC3, (baseband_attenuation << 2));\n\t} else {\n\t\tb43_phy_maskset(dev, B43_PHY_DACCTL, 0xFF87, (baseband_attenuation << 3));\n\t}\n}\n\n \nstatic void b43_set_txpower_g(struct b43_wldev *dev,\n\t\t\t      const struct b43_bbatt *bbatt,\n\t\t\t      const struct b43_rfatt *rfatt, u8 tx_control)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tstruct b43_txpower_lo_control *lo = gphy->lo_control;\n\tu16 bb, rf;\n\tu16 tx_bias, tx_magn;\n\n\tbb = bbatt->att;\n\trf = rfatt->att;\n\ttx_bias = lo->tx_bias;\n\ttx_magn = lo->tx_magn;\n\tif (unlikely(tx_bias == 0xFF))\n\t\ttx_bias = 0;\n\n\t \n\tgphy->tx_control = tx_control;\n\tmemmove(&gphy->rfatt, rfatt, sizeof(*rfatt));\n\tgphy->rfatt.with_padmix = !!(tx_control & B43_TXCTL_TXMIX);\n\tmemmove(&gphy->bbatt, bbatt, sizeof(*bbatt));\n\n\tif (b43_debug(dev, B43_DBG_XMITPOWER)) {\n\t\tb43dbg(dev->wl, \"Tuning TX-power to bbatt(%u), \"\n\t\t       \"rfatt(%u), tx_control(0x%02X), \"\n\t\t       \"tx_bias(0x%02X), tx_magn(0x%02X)\\n\",\n\t\t       bb, rf, tx_control, tx_bias, tx_magn);\n\t}\n\n\tb43_gphy_set_baseband_attenuation(dev, bb);\n\tb43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_RFATT, rf);\n\tif (phy->radio_ver == 0x2050 && phy->radio_rev == 8) {\n\t\tb43_radio_write16(dev, 0x43,\n\t\t\t\t  (rf & 0x000F) | (tx_control & 0x0070));\n\t} else {\n\t\tb43_radio_maskset(dev, 0x43, 0xFFF0, (rf & 0x000F));\n\t\tb43_radio_maskset(dev, 0x52, ~0x0070, (tx_control & 0x0070));\n\t}\n\tif (has_tx_magnification(phy)) {\n\t\tb43_radio_write16(dev, 0x52, tx_magn | tx_bias);\n\t} else {\n\t\tb43_radio_maskset(dev, 0x52, 0xFFF0, (tx_bias & 0x000F));\n\t}\n\tb43_lo_g_adjust(dev);\n}\n\n \nstatic void b43_gphy_tssi_power_lt_init(struct b43_wldev *dev)\n{\n\tstruct b43_phy_g *gphy = dev->phy.g;\n\tint i;\n\tu16 value;\n\n\tfor (i = 0; i < 32; i++)\n\t\tb43_ofdmtab_write16(dev, 0x3C20, i, gphy->tssi2dbm[i]);\n\tfor (i = 32; i < 64; i++)\n\t\tb43_ofdmtab_write16(dev, 0x3C00, i - 32, gphy->tssi2dbm[i]);\n\tfor (i = 0; i < 64; i += 2) {\n\t\tvalue = (u16) gphy->tssi2dbm[i];\n\t\tvalue |= ((u16) gphy->tssi2dbm[i + 1]) << 8;\n\t\tb43_phy_write(dev, 0x380 + (i / 2), value);\n\t}\n}\n\n \nstatic void b43_gphy_gain_lt_init(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tstruct b43_txpower_lo_control *lo = gphy->lo_control;\n\tu16 nr_written = 0;\n\tu16 tmp;\n\tu8 rf, bb;\n\n\tfor (rf = 0; rf < lo->rfatt_list.len; rf++) {\n\t\tfor (bb = 0; bb < lo->bbatt_list.len; bb++) {\n\t\t\tif (nr_written >= 0x40)\n\t\t\t\treturn;\n\t\t\ttmp = lo->bbatt_list.list[bb].att;\n\t\t\ttmp <<= 8;\n\t\t\tif (phy->radio_rev == 8)\n\t\t\t\ttmp |= 0x50;\n\t\t\telse\n\t\t\t\ttmp |= 0x40;\n\t\t\ttmp |= lo->rfatt_list.list[rf].att;\n\t\t\tb43_phy_write(dev, 0x3C0 + nr_written, tmp);\n\t\t\tnr_written++;\n\t\t}\n\t}\n}\n\nstatic void b43_set_all_gains(struct b43_wldev *dev,\n\t\t\t      s16 first, s16 second, s16 third)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tu16 i;\n\tu16 start = 0x08, end = 0x18;\n\tu16 tmp;\n\tu16 table;\n\n\tif (phy->rev <= 1) {\n\t\tstart = 0x10;\n\t\tend = 0x20;\n\t}\n\n\ttable = B43_OFDMTAB_GAINX;\n\tif (phy->rev <= 1)\n\t\ttable = B43_OFDMTAB_GAINX_R1;\n\tfor (i = 0; i < 4; i++)\n\t\tb43_ofdmtab_write16(dev, table, i, first);\n\n\tfor (i = start; i < end; i++)\n\t\tb43_ofdmtab_write16(dev, table, i, second);\n\n\tif (third != -1) {\n\t\ttmp = ((u16) third << 14) | ((u16) third << 6);\n\t\tb43_phy_maskset(dev, 0x04A0, 0xBFBF, tmp);\n\t\tb43_phy_maskset(dev, 0x04A1, 0xBFBF, tmp);\n\t\tb43_phy_maskset(dev, 0x04A2, 0xBFBF, tmp);\n\t}\n\tb43_dummy_transmission(dev, false, true);\n}\n\nstatic void b43_set_original_gains(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tu16 i, tmp;\n\tu16 table;\n\tu16 start = 0x0008, end = 0x0018;\n\n\tif (phy->rev <= 1) {\n\t\tstart = 0x0010;\n\t\tend = 0x0020;\n\t}\n\n\ttable = B43_OFDMTAB_GAINX;\n\tif (phy->rev <= 1)\n\t\ttable = B43_OFDMTAB_GAINX_R1;\n\tfor (i = 0; i < 4; i++) {\n\t\ttmp = (i & 0xFFFC);\n\t\ttmp |= (i & 0x0001) << 1;\n\t\ttmp |= (i & 0x0002) >> 1;\n\n\t\tb43_ofdmtab_write16(dev, table, i, tmp);\n\t}\n\n\tfor (i = start; i < end; i++)\n\t\tb43_ofdmtab_write16(dev, table, i, i - start);\n\n\tb43_phy_maskset(dev, 0x04A0, 0xBFBF, 0x4040);\n\tb43_phy_maskset(dev, 0x04A1, 0xBFBF, 0x4040);\n\tb43_phy_maskset(dev, 0x04A2, 0xBFBF, 0x4000);\n\tb43_dummy_transmission(dev, false, true);\n}\n\n \n\t\tbackup[3] = b43_phy_read(dev, 0x0814);\n\t\tbackup[4] = b43_phy_read(dev, 0x0815);\n\t}\n\tbackup[5] = b43_phy_read(dev, 0x005A);\n\tbackup[6] = b43_phy_read(dev, 0x0059);\n\tbackup[7] = b43_phy_read(dev, 0x0058);\n\tbackup[8] = b43_phy_read(dev, 0x000A);\n\tbackup[9] = b43_phy_read(dev, 0x0003);\n\tbackup[10] = b43_radio_read16(dev, 0x007A);\n\tbackup[11] = b43_radio_read16(dev, 0x0043);\n\n\tb43_phy_mask(dev, 0x0429, 0x7FFF);\n\tb43_phy_maskset(dev, 0x0001, 0x3FFF, 0x4000);\n\tb43_phy_set(dev, 0x0811, 0x000C);\n\tb43_phy_maskset(dev, 0x0812, 0xFFF3, 0x0004);\n\tb43_phy_mask(dev, 0x0802, ~(0x1 | 0x2));\n\tif (phy->rev >= 6) {\n\t\tbackup[12] = b43_phy_read(dev, 0x002E);\n\t\tbackup[13] = b43_phy_read(dev, 0x002F);\n\t\tbackup[14] = b43_phy_read(dev, 0x080F);\n\t\tbackup[15] = b43_phy_read(dev, 0x0810);\n\t\tbackup[16] = b43_phy_read(dev, 0x0801);\n\t\tbackup[17] = b43_phy_read(dev, 0x0060);\n\t\tbackup[18] = b43_phy_read(dev, 0x0014);\n\t\tbackup[19] = b43_phy_read(dev, 0x0478);\n\n\t\tb43_phy_write(dev, 0x002E, 0);\n\t\tb43_phy_write(dev, 0x002F, 0);\n\t\tb43_phy_write(dev, 0x080F, 0);\n\t\tb43_phy_write(dev, 0x0810, 0);\n\t\tb43_phy_set(dev, 0x0478, 0x0100);\n\t\tb43_phy_set(dev, 0x0801, 0x0040);\n\t\tb43_phy_set(dev, 0x0060, 0x0040);\n\t\tb43_phy_set(dev, 0x0014, 0x0200);\n\t}\n\tb43_radio_set(dev, 0x007A, 0x0070);\n\tb43_radio_set(dev, 0x007A, 0x0080);\n\tudelay(30);\n\n\tv47F = (s16) ((b43_phy_read(dev, 0x047F) >> 8) & 0x003F);\n\tif (v47F >= 0x20)\n\t\tv47F -= 0x40;\n\tif (v47F == 31) {\n\t\tfor (i = 7; i >= 4; i--) {\n\t\t\tb43_radio_write16(dev, 0x007B, i);\n\t\t\tudelay(20);\n\t\t\tv47F =\n\t\t\t    (s16) ((b43_phy_read(dev, 0x047F) >> 8) & 0x003F);\n\t\t\tif (v47F >= 0x20)\n\t\t\t\tv47F -= 0x40;\n\t\t\tif (v47F < 31 && saved == 0xFFFF)\n\t\t\t\tsaved = i;\n\t\t}\n\t\tif (saved == 0xFFFF)\n\t\t\tsaved = 4;\n\t} else {\n\t\tb43_radio_mask(dev, 0x007A, 0x007F);\n\t\tif (phy->rev != 1) {\t \n\t\t\tb43_phy_set(dev, 0x0814, 0x0001);\n\t\t\tb43_phy_mask(dev, 0x0815, 0xFFFE);\n\t\t}\n\t\tb43_phy_set(dev, 0x0811, 0x000C);\n\t\tb43_phy_set(dev, 0x0812, 0x000C);\n\t\tb43_phy_set(dev, 0x0811, 0x0030);\n\t\tb43_phy_set(dev, 0x0812, 0x0030);\n\t\tb43_phy_write(dev, 0x005A, 0x0480);\n\t\tb43_phy_write(dev, 0x0059, 0x0810);\n\t\tb43_phy_write(dev, 0x0058, 0x000D);\n\t\tif (phy->rev == 0) {\n\t\t\tb43_phy_write(dev, 0x0003, 0x0122);\n\t\t} else {\n\t\t\tb43_phy_set(dev, 0x000A, 0x2000);\n\t\t}\n\t\tif (phy->rev != 1) {\t \n\t\t\tb43_phy_set(dev, 0x0814, 0x0004);\n\t\t\tb43_phy_mask(dev, 0x0815, 0xFFFB);\n\t\t}\n\t\tb43_phy_maskset(dev, 0x0003, 0xFF9F, 0x0040);\n\t\tb43_radio_set(dev, 0x007A, 0x000F);\n\t\tb43_set_all_gains(dev, 3, 0, 1);\n\t\tb43_radio_maskset(dev, 0x0043, 0x00F0, 0x000F);\n\t\tudelay(30);\n\t\tv47F = (s16) ((b43_phy_read(dev, 0x047F) >> 8) & 0x003F);\n\t\tif (v47F >= 0x20)\n\t\t\tv47F -= 0x40;\n\t\tif (v47F == -32) {\n\t\t\tfor (i = 0; i < 4; i++) {\n\t\t\t\tb43_radio_write16(dev, 0x007B, i);\n\t\t\t\tudelay(20);\n\t\t\t\tv47F =\n\t\t\t\t    (s16) ((b43_phy_read(dev, 0x047F) >> 8) &\n\t\t\t\t\t   0x003F);\n\t\t\t\tif (v47F >= 0x20)\n\t\t\t\t\tv47F -= 0x40;\n\t\t\t\tif (v47F > -31 && saved == 0xFFFF)\n\t\t\t\t\tsaved = i;\n\t\t\t}\n\t\t\tif (saved == 0xFFFF)\n\t\t\t\tsaved = 3;\n\t\t} else\n\t\t\tsaved = 0;\n\t}\n\tb43_radio_write16(dev, 0x007B, saved);\n\n\tif (phy->rev >= 6) {\n\t\tb43_phy_write(dev, 0x002E, backup[12]);\n\t\tb43_phy_write(dev, 0x002F, backup[13]);\n\t\tb43_phy_write(dev, 0x080F, backup[14]);\n\t\tb43_phy_write(dev, 0x0810, backup[15]);\n\t}\n\tif (phy->rev != 1) {\t \n\t\tb43_phy_write(dev, 0x0814, backup[3]);\n\t\tb43_phy_write(dev, 0x0815, backup[4]);\n\t}\n\tb43_phy_write(dev, 0x005A, backup[5]);\n\tb43_phy_write(dev, 0x0059, backup[6]);\n\tb43_phy_write(dev, 0x0058, backup[7]);\n\tb43_phy_write(dev, 0x000A, backup[8]);\n\tb43_phy_write(dev, 0x0003, backup[9]);\n\tb43_radio_write16(dev, 0x0043, backup[11]);\n\tb43_radio_write16(dev, 0x007A, backup[10]);\n\tb43_phy_write(dev, 0x0802, b43_phy_read(dev, 0x0802) | 0x1 | 0x2);\n\tb43_phy_set(dev, 0x0429, 0x8000);\n\tb43_set_original_gains(dev);\n\tif (phy->rev >= 6) {\n\t\tb43_phy_write(dev, 0x0801, backup[16]);\n\t\tb43_phy_write(dev, 0x0060, backup[17]);\n\t\tb43_phy_write(dev, 0x0014, backup[18]);\n\t\tb43_phy_write(dev, 0x0478, backup[19]);\n\t}\n\tb43_phy_write(dev, 0x0001, backup[0]);\n\tb43_phy_write(dev, 0x0812, backup[2]);\n\tb43_phy_write(dev, 0x0811, backup[1]);\n}\n\nstatic void b43_calc_nrssi_slope(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tu16 backup[18] = { 0 };\n\tu16 tmp;\n\ts16 nrssi0, nrssi1;\n\n\tB43_WARN_ON(phy->type != B43_PHYTYPE_G);\n\n\tif (phy->radio_rev >= 9)\n\t\treturn;\n\tif (phy->radio_rev == 8)\n\t\tb43_calc_nrssi_offset(dev);\n\n\tb43_phy_mask(dev, B43_PHY_G_CRS, 0x7FFF);\n\tb43_phy_mask(dev, 0x0802, 0xFFFC);\n\tbackup[7] = b43_read16(dev, 0x03E2);\n\tb43_write16(dev, 0x03E2, b43_read16(dev, 0x03E2) | 0x8000);\n\tbackup[0] = b43_radio_read16(dev, 0x007A);\n\tbackup[1] = b43_radio_read16(dev, 0x0052);\n\tbackup[2] = b43_radio_read16(dev, 0x0043);\n\tbackup[3] = b43_phy_read(dev, 0x0015);\n\tbackup[4] = b43_phy_read(dev, 0x005A);\n\tbackup[5] = b43_phy_read(dev, 0x0059);\n\tbackup[6] = b43_phy_read(dev, 0x0058);\n\tbackup[8] = b43_read16(dev, 0x03E6);\n\tbackup[9] = b43_read16(dev, B43_MMIO_CHANNEL_EXT);\n\tif (phy->rev >= 3) {\n\t\tbackup[10] = b43_phy_read(dev, 0x002E);\n\t\tbackup[11] = b43_phy_read(dev, 0x002F);\n\t\tbackup[12] = b43_phy_read(dev, 0x080F);\n\t\tbackup[13] = b43_phy_read(dev, B43_PHY_G_LO_CONTROL);\n\t\tbackup[14] = b43_phy_read(dev, 0x0801);\n\t\tbackup[15] = b43_phy_read(dev, 0x0060);\n\t\tbackup[16] = b43_phy_read(dev, 0x0014);\n\t\tbackup[17] = b43_phy_read(dev, 0x0478);\n\t\tb43_phy_write(dev, 0x002E, 0);\n\t\tb43_phy_write(dev, B43_PHY_G_LO_CONTROL, 0);\n\t\tswitch (phy->rev) {\n\t\tcase 4:\n\t\tcase 6:\n\t\tcase 7:\n\t\t\tb43_phy_set(dev, 0x0478, 0x0100);\n\t\t\tb43_phy_set(dev, 0x0801, 0x0040);\n\t\t\tbreak;\n\t\tcase 3:\n\t\tcase 5:\n\t\t\tb43_phy_mask(dev, 0x0801, 0xFFBF);\n\t\t\tbreak;\n\t\t}\n\t\tb43_phy_set(dev, 0x0060, 0x0040);\n\t\tb43_phy_set(dev, 0x0014, 0x0200);\n\t}\n\tb43_radio_set(dev, 0x007A, 0x0070);\n\tb43_set_all_gains(dev, 0, 8, 0);\n\tb43_radio_mask(dev, 0x007A, 0x00F7);\n\tif (phy->rev >= 2) {\n\t\tb43_phy_maskset(dev, 0x0811, 0xFFCF, 0x0030);\n\t\tb43_phy_maskset(dev, 0x0812, 0xFFCF, 0x0010);\n\t}\n\tb43_radio_set(dev, 0x007A, 0x0080);\n\tudelay(20);\n\n\tnrssi0 = (s16) ((b43_phy_read(dev, 0x047F) >> 8) & 0x003F);\n\tif (nrssi0 >= 0x0020)\n\t\tnrssi0 -= 0x0040;\n\n\tb43_radio_mask(dev, 0x007A, 0x007F);\n\tif (phy->rev >= 2) {\n\t\tb43_phy_maskset(dev, 0x0003, 0xFF9F, 0x0040);\n\t}\n\n\tb43_write16(dev, B43_MMIO_CHANNEL_EXT,\n\t\t    b43_read16(dev, B43_MMIO_CHANNEL_EXT)\n\t\t    | 0x2000);\n\tb43_radio_set(dev, 0x007A, 0x000F);\n\tb43_phy_write(dev, 0x0015, 0xF330);\n\tif (phy->rev >= 2) {\n\t\tb43_phy_maskset(dev, 0x0812, 0xFFCF, 0x0020);\n\t\tb43_phy_maskset(dev, 0x0811, 0xFFCF, 0x0020);\n\t}\n\n\tb43_set_all_gains(dev, 3, 0, 1);\n\tif (phy->radio_rev == 8) {\n\t\tb43_radio_write16(dev, 0x0043, 0x001F);\n\t} else {\n\t\ttmp = b43_radio_read16(dev, 0x0052) & 0xFF0F;\n\t\tb43_radio_write16(dev, 0x0052, tmp | 0x0060);\n\t\ttmp = b43_radio_read16(dev, 0x0043) & 0xFFF0;\n\t\tb43_radio_write16(dev, 0x0043, tmp | 0x0009);\n\t}\n\tb43_phy_write(dev, 0x005A, 0x0480);\n\tb43_phy_write(dev, 0x0059, 0x0810);\n\tb43_phy_write(dev, 0x0058, 0x000D);\n\tudelay(20);\n\tnrssi1 = (s16) ((b43_phy_read(dev, 0x047F) >> 8) & 0x003F);\n\tif (nrssi1 >= 0x0020)\n\t\tnrssi1 -= 0x0040;\n\tif (nrssi0 == nrssi1)\n\t\tgphy->nrssislope = 0x00010000;\n\telse\n\t\tgphy->nrssislope = 0x00400000 / (nrssi0 - nrssi1);\n\tif (nrssi0 >= -4) {\n\t\tgphy->nrssi[0] = nrssi1;\n\t\tgphy->nrssi[1] = nrssi0;\n\t}\n\tif (phy->rev >= 3) {\n\t\tb43_phy_write(dev, 0x002E, backup[10]);\n\t\tb43_phy_write(dev, 0x002F, backup[11]);\n\t\tb43_phy_write(dev, 0x080F, backup[12]);\n\t\tb43_phy_write(dev, B43_PHY_G_LO_CONTROL, backup[13]);\n\t}\n\tif (phy->rev >= 2) {\n\t\tb43_phy_mask(dev, 0x0812, 0xFFCF);\n\t\tb43_phy_mask(dev, 0x0811, 0xFFCF);\n\t}\n\n\tb43_radio_write16(dev, 0x007A, backup[0]);\n\tb43_radio_write16(dev, 0x0052, backup[1]);\n\tb43_radio_write16(dev, 0x0043, backup[2]);\n\tb43_write16(dev, 0x03E2, backup[7]);\n\tb43_write16(dev, 0x03E6, backup[8]);\n\tb43_write16(dev, B43_MMIO_CHANNEL_EXT, backup[9]);\n\tb43_phy_write(dev, 0x0015, backup[3]);\n\tb43_phy_write(dev, 0x005A, backup[4]);\n\tb43_phy_write(dev, 0x0059, backup[5]);\n\tb43_phy_write(dev, 0x0058, backup[6]);\n\tb43_synth_pu_workaround(dev, phy->channel);\n\tb43_phy_set(dev, 0x0802, (0x0001 | 0x0002));\n\tb43_set_original_gains(dev);\n\tb43_phy_set(dev, B43_PHY_G_CRS, 0x8000);\n\tif (phy->rev >= 3) {\n\t\tb43_phy_write(dev, 0x0801, backup[14]);\n\t\tb43_phy_write(dev, 0x0060, backup[15]);\n\t\tb43_phy_write(dev, 0x0014, backup[16]);\n\t\tb43_phy_write(dev, 0x0478, backup[17]);\n\t}\n\tb43_nrssi_mem_update(dev);\n\tb43_calc_nrssi_threshold(dev);\n}\n\nstatic void b43_calc_nrssi_threshold(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\ts32 a, b;\n\ts16 tmp16;\n\tu16 tmp_u16;\n\n\tB43_WARN_ON(phy->type != B43_PHYTYPE_G);\n\n\tif (!phy->gmode ||\n\t    !(dev->dev->bus_sprom->boardflags_lo & B43_BFL_RSSI)) {\n\t\ttmp16 = b43_nrssi_hw_read(dev, 0x20);\n\t\tif (tmp16 >= 0x20)\n\t\t\ttmp16 -= 0x40;\n\t\tif (tmp16 < 3) {\n\t\t\tb43_phy_maskset(dev, 0x048A, 0xF000, 0x09EB);\n\t\t} else {\n\t\t\tb43_phy_maskset(dev, 0x048A, 0xF000, 0x0AED);\n\t\t}\n\t} else {\n\t\tif (gphy->interfmode == B43_INTERFMODE_NONWLAN) {\n\t\t\ta = 0xE;\n\t\t\tb = 0xA;\n\t\t} else if (!gphy->aci_wlan_automatic && gphy->aci_enable) {\n\t\t\ta = 0x13;\n\t\t\tb = 0x12;\n\t\t} else {\n\t\t\ta = 0xE;\n\t\t\tb = 0x11;\n\t\t}\n\n\t\ta = a * (gphy->nrssi[1] - gphy->nrssi[0]);\n\t\ta += (gphy->nrssi[0] << 6);\n\t\tif (a < 32)\n\t\t\ta += 31;\n\t\telse\n\t\t\ta += 32;\n\t\ta = a >> 6;\n\t\ta = clamp_val(a, -31, 31);\n\n\t\tb = b * (gphy->nrssi[1] - gphy->nrssi[0]);\n\t\tb += (gphy->nrssi[0] << 6);\n\t\tif (b < 32)\n\t\t\tb += 31;\n\t\telse\n\t\t\tb += 32;\n\t\tb = b >> 6;\n\t\tb = clamp_val(b, -31, 31);\n\n\t\ttmp_u16 = b43_phy_read(dev, 0x048A) & 0xF000;\n\t\ttmp_u16 |= ((u32) b & 0x0000003F);\n\t\ttmp_u16 |= (((u32) a & 0x0000003F) << 6);\n\t\tb43_phy_write(dev, 0x048A, tmp_u16);\n\t}\n}\n\n \nstatic void _stack_save(u32 *_stackptr, size_t *stackidx,\n\t\t\tu8 id, u16 offset, u16 value)\n{\n\tu32 *stackptr = &(_stackptr[*stackidx]);\n\n\tB43_WARN_ON(offset & 0xF000);\n\tB43_WARN_ON(id & 0xF0);\n\t*stackptr = offset;\n\t*stackptr |= ((u32) id) << 12;\n\t*stackptr |= ((u32) value) << 16;\n\t(*stackidx)++;\n\tB43_WARN_ON(*stackidx >= B43_INTERFSTACK_SIZE);\n}\n\nstatic u16 _stack_restore(u32 *stackptr, u8 id, u16 offset)\n{\n\tsize_t i;\n\n\tB43_WARN_ON(offset & 0xF000);\n\tB43_WARN_ON(id & 0xF0);\n\tfor (i = 0; i < B43_INTERFSTACK_SIZE; i++, stackptr++) {\n\t\tif ((*stackptr & 0x00000FFF) != offset)\n\t\t\tcontinue;\n\t\tif (((*stackptr & 0x0000F000) >> 12) != id)\n\t\t\tcontinue;\n\t\treturn ((*stackptr & 0xFFFF0000) >> 16);\n\t}\n\tB43_WARN_ON(1);\n\n\treturn 0;\n}\n\n#define phy_stacksave(offset)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\t_stack_save(stack, &stackidx, 0x1, (offset),\t\\\n\t\t\t    b43_phy_read(dev, (offset)));\t\\\n\t} while (0)\n#define phy_stackrestore(offset)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\tb43_phy_write(dev, (offset),\t\t\\\n\t\t\t\t  _stack_restore(stack, 0x1,\t\\\n\t\t\t\t\t\t (offset)));\t\\\n\t} while (0)\n#define radio_stacksave(offset)\t\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\t_stack_save(stack, &stackidx, 0x2, (offset),\t\t\\\n\t\t\t    b43_radio_read16(dev, (offset)));\t\\\n\t} while (0)\n#define radio_stackrestore(offset)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\tb43_radio_write16(dev, (offset),\t\t\t\\\n\t\t\t\t      _stack_restore(stack, 0x2,\t\\\n\t\t\t\t\t\t     (offset)));\t\\\n\t} while (0)\n#define ofdmtab_stacksave(table, offset)\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\t_stack_save(stack, &stackidx, 0x3, (offset)|(table),\t\\\n\t\t\t    b43_ofdmtab_read16(dev, (table), (offset)));\t\\\n\t} while (0)\n#define ofdmtab_stackrestore(table, offset)\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\tb43_ofdmtab_write16(dev, (table),\t(offset),\t\\\n\t\t\t\t  _stack_restore(stack, 0x3,\t\\\n\t\t\t\t\t\t (offset)|(table)));\t\\\n\t} while (0)\n\nstatic void\nb43_radio_interference_mitigation_enable(struct b43_wldev *dev, int mode)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tu16 tmp, flipped;\n\tsize_t stackidx = 0;\n\tu32 *stack = gphy->interfstack;\n\n\tswitch (mode) {\n\tcase B43_INTERFMODE_NONWLAN:\n\t\tif (phy->rev != 1) {\n\t\t\tb43_phy_set(dev, 0x042B, 0x0800);\n\t\t\tb43_phy_mask(dev, B43_PHY_G_CRS, ~0x4000);\n\t\t\tbreak;\n\t\t}\n\t\tradio_stacksave(0x0078);\n\t\ttmp = (b43_radio_read16(dev, 0x0078) & 0x001E);\n\t\tB43_WARN_ON(tmp > 15);\n\t\tflipped = bitrev4(tmp);\n\t\tif (flipped < 10 && flipped >= 8)\n\t\t\tflipped = 7;\n\t\telse if (flipped >= 10)\n\t\t\tflipped -= 3;\n\t\tflipped = (bitrev4(flipped) << 1) | 0x0020;\n\t\tb43_radio_write16(dev, 0x0078, flipped);\n\n\t\tb43_calc_nrssi_threshold(dev);\n\n\t\tphy_stacksave(0x0406);\n\t\tb43_phy_write(dev, 0x0406, 0x7E28);\n\n\t\tb43_phy_set(dev, 0x042B, 0x0800);\n\t\tb43_phy_set(dev, B43_PHY_RADIO_BITFIELD, 0x1000);\n\n\t\tphy_stacksave(0x04A0);\n\t\tb43_phy_maskset(dev, 0x04A0, 0xC0C0, 0x0008);\n\t\tphy_stacksave(0x04A1);\n\t\tb43_phy_maskset(dev, 0x04A1, 0xC0C0, 0x0605);\n\t\tphy_stacksave(0x04A2);\n\t\tb43_phy_maskset(dev, 0x04A2, 0xC0C0, 0x0204);\n\t\tphy_stacksave(0x04A8);\n\t\tb43_phy_maskset(dev, 0x04A8, 0xC0C0, 0x0803);\n\t\tphy_stacksave(0x04AB);\n\t\tb43_phy_maskset(dev, 0x04AB, 0xC0C0, 0x0605);\n\n\t\tphy_stacksave(0x04A7);\n\t\tb43_phy_write(dev, 0x04A7, 0x0002);\n\t\tphy_stacksave(0x04A3);\n\t\tb43_phy_write(dev, 0x04A3, 0x287A);\n\t\tphy_stacksave(0x04A9);\n\t\tb43_phy_write(dev, 0x04A9, 0x2027);\n\t\tphy_stacksave(0x0493);\n\t\tb43_phy_write(dev, 0x0493, 0x32F5);\n\t\tphy_stacksave(0x04AA);\n\t\tb43_phy_write(dev, 0x04AA, 0x2027);\n\t\tphy_stacksave(0x04AC);\n\t\tb43_phy_write(dev, 0x04AC, 0x32F5);\n\t\tbreak;\n\tcase B43_INTERFMODE_MANUALWLAN:\n\t\tif (b43_phy_read(dev, 0x0033) & 0x0800)\n\t\t\tbreak;\n\n\t\tgphy->aci_enable = true;\n\n\t\tphy_stacksave(B43_PHY_RADIO_BITFIELD);\n\t\tphy_stacksave(B43_PHY_G_CRS);\n\t\tif (phy->rev < 2) {\n\t\t\tphy_stacksave(0x0406);\n\t\t} else {\n\t\t\tphy_stacksave(0x04C0);\n\t\t\tphy_stacksave(0x04C1);\n\t\t}\n\t\tphy_stacksave(0x0033);\n\t\tphy_stacksave(0x04A7);\n\t\tphy_stacksave(0x04A3);\n\t\tphy_stacksave(0x04A9);\n\t\tphy_stacksave(0x04AA);\n\t\tphy_stacksave(0x04AC);\n\t\tphy_stacksave(0x0493);\n\t\tphy_stacksave(0x04A1);\n\t\tphy_stacksave(0x04A0);\n\t\tphy_stacksave(0x04A2);\n\t\tphy_stacksave(0x048A);\n\t\tphy_stacksave(0x04A8);\n\t\tphy_stacksave(0x04AB);\n\t\tif (phy->rev == 2) {\n\t\t\tphy_stacksave(0x04AD);\n\t\t\tphy_stacksave(0x04AE);\n\t\t} else if (phy->rev >= 3) {\n\t\t\tphy_stacksave(0x04AD);\n\t\t\tphy_stacksave(0x0415);\n\t\t\tphy_stacksave(0x0416);\n\t\t\tphy_stacksave(0x0417);\n\t\t\tofdmtab_stacksave(0x1A00, 0x2);\n\t\t\tofdmtab_stacksave(0x1A00, 0x3);\n\t\t}\n\t\tphy_stacksave(0x042B);\n\t\tphy_stacksave(0x048C);\n\n\t\tb43_phy_mask(dev, B43_PHY_RADIO_BITFIELD, ~0x1000);\n\t\tb43_phy_maskset(dev, B43_PHY_G_CRS, 0xFFFC, 0x0002);\n\n\t\tb43_phy_write(dev, 0x0033, 0x0800);\n\t\tb43_phy_write(dev, 0x04A3, 0x2027);\n\t\tb43_phy_write(dev, 0x04A9, 0x1CA8);\n\t\tb43_phy_write(dev, 0x0493, 0x287A);\n\t\tb43_phy_write(dev, 0x04AA, 0x1CA8);\n\t\tb43_phy_write(dev, 0x04AC, 0x287A);\n\n\t\tb43_phy_maskset(dev, 0x04A0, 0xFFC0, 0x001A);\n\t\tb43_phy_write(dev, 0x04A7, 0x000D);\n\n\t\tif (phy->rev < 2) {\n\t\t\tb43_phy_write(dev, 0x0406, 0xFF0D);\n\t\t} else if (phy->rev == 2) {\n\t\t\tb43_phy_write(dev, 0x04C0, 0xFFFF);\n\t\t\tb43_phy_write(dev, 0x04C1, 0x00A9);\n\t\t} else {\n\t\t\tb43_phy_write(dev, 0x04C0, 0x00C1);\n\t\t\tb43_phy_write(dev, 0x04C1, 0x0059);\n\t\t}\n\n\t\tb43_phy_maskset(dev, 0x04A1, 0xC0FF, 0x1800);\n\t\tb43_phy_maskset(dev, 0x04A1, 0xFFC0, 0x0015);\n\t\tb43_phy_maskset(dev, 0x04A8, 0xCFFF, 0x1000);\n\t\tb43_phy_maskset(dev, 0x04A8, 0xF0FF, 0x0A00);\n\t\tb43_phy_maskset(dev, 0x04AB, 0xCFFF, 0x1000);\n\t\tb43_phy_maskset(dev, 0x04AB, 0xF0FF, 0x0800);\n\t\tb43_phy_maskset(dev, 0x04AB, 0xFFCF, 0x0010);\n\t\tb43_phy_maskset(dev, 0x04AB, 0xFFF0, 0x0005);\n\t\tb43_phy_maskset(dev, 0x04A8, 0xFFCF, 0x0010);\n\t\tb43_phy_maskset(dev, 0x04A8, 0xFFF0, 0x0006);\n\t\tb43_phy_maskset(dev, 0x04A2, 0xF0FF, 0x0800);\n\t\tb43_phy_maskset(dev, 0x04A0, 0xF0FF, 0x0500);\n\t\tb43_phy_maskset(dev, 0x04A2, 0xFFF0, 0x000B);\n\n\t\tif (phy->rev >= 3) {\n\t\t\tb43_phy_mask(dev, 0x048A, 0x7FFF);\n\t\t\tb43_phy_maskset(dev, 0x0415, 0x8000, 0x36D8);\n\t\t\tb43_phy_maskset(dev, 0x0416, 0x8000, 0x36D8);\n\t\t\tb43_phy_maskset(dev, 0x0417, 0xFE00, 0x016D);\n\t\t} else {\n\t\t\tb43_phy_set(dev, 0x048A, 0x1000);\n\t\t\tb43_phy_maskset(dev, 0x048A, 0x9FFF, 0x2000);\n\t\t\tb43_hf_write(dev, b43_hf_read(dev) | B43_HF_ACIW);\n\t\t}\n\t\tif (phy->rev >= 2) {\n\t\t\tb43_phy_set(dev, 0x042B, 0x0800);\n\t\t}\n\t\tb43_phy_maskset(dev, 0x048C, 0xF0FF, 0x0200);\n\t\tif (phy->rev == 2) {\n\t\t\tb43_phy_maskset(dev, 0x04AE, 0xFF00, 0x007F);\n\t\t\tb43_phy_maskset(dev, 0x04AD, 0x00FF, 0x1300);\n\t\t} else if (phy->rev >= 6) {\n\t\t\tb43_ofdmtab_write16(dev, 0x1A00, 0x3, 0x007F);\n\t\t\tb43_ofdmtab_write16(dev, 0x1A00, 0x2, 0x007F);\n\t\t\tb43_phy_mask(dev, 0x04AD, 0x00FF);\n\t\t}\n\t\tb43_calc_nrssi_slope(dev);\n\t\tbreak;\n\tdefault:\n\t\tB43_WARN_ON(1);\n\t}\n}\n\nstatic void\nb43_radio_interference_mitigation_disable(struct b43_wldev *dev, int mode)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tu32 *stack = gphy->interfstack;\n\n\tswitch (mode) {\n\tcase B43_INTERFMODE_NONWLAN:\n\t\tif (phy->rev != 1) {\n\t\t\tb43_phy_mask(dev, 0x042B, ~0x0800);\n\t\t\tb43_phy_set(dev, B43_PHY_G_CRS, 0x4000);\n\t\t\tbreak;\n\t\t}\n\t\tradio_stackrestore(0x0078);\n\t\tb43_calc_nrssi_threshold(dev);\n\t\tphy_stackrestore(0x0406);\n\t\tb43_phy_mask(dev, 0x042B, ~0x0800);\n\t\tif (!dev->bad_frames_preempt) {\n\t\t\tb43_phy_mask(dev, B43_PHY_RADIO_BITFIELD, ~(1 << 11));\n\t\t}\n\t\tb43_phy_set(dev, B43_PHY_G_CRS, 0x4000);\n\t\tphy_stackrestore(0x04A0);\n\t\tphy_stackrestore(0x04A1);\n\t\tphy_stackrestore(0x04A2);\n\t\tphy_stackrestore(0x04A8);\n\t\tphy_stackrestore(0x04AB);\n\t\tphy_stackrestore(0x04A7);\n\t\tphy_stackrestore(0x04A3);\n\t\tphy_stackrestore(0x04A9);\n\t\tphy_stackrestore(0x0493);\n\t\tphy_stackrestore(0x04AA);\n\t\tphy_stackrestore(0x04AC);\n\t\tbreak;\n\tcase B43_INTERFMODE_MANUALWLAN:\n\t\tif (!(b43_phy_read(dev, 0x0033) & 0x0800))\n\t\t\tbreak;\n\n\t\tgphy->aci_enable = false;\n\n\t\tphy_stackrestore(B43_PHY_RADIO_BITFIELD);\n\t\tphy_stackrestore(B43_PHY_G_CRS);\n\t\tphy_stackrestore(0x0033);\n\t\tphy_stackrestore(0x04A3);\n\t\tphy_stackrestore(0x04A9);\n\t\tphy_stackrestore(0x0493);\n\t\tphy_stackrestore(0x04AA);\n\t\tphy_stackrestore(0x04AC);\n\t\tphy_stackrestore(0x04A0);\n\t\tphy_stackrestore(0x04A7);\n\t\tif (phy->rev >= 2) {\n\t\t\tphy_stackrestore(0x04C0);\n\t\t\tphy_stackrestore(0x04C1);\n\t\t} else\n\t\t\tphy_stackrestore(0x0406);\n\t\tphy_stackrestore(0x04A1);\n\t\tphy_stackrestore(0x04AB);\n\t\tphy_stackrestore(0x04A8);\n\t\tif (phy->rev == 2) {\n\t\t\tphy_stackrestore(0x04AD);\n\t\t\tphy_stackrestore(0x04AE);\n\t\t} else if (phy->rev >= 3) {\n\t\t\tphy_stackrestore(0x04AD);\n\t\t\tphy_stackrestore(0x0415);\n\t\t\tphy_stackrestore(0x0416);\n\t\t\tphy_stackrestore(0x0417);\n\t\t\tofdmtab_stackrestore(0x1A00, 0x2);\n\t\t\tofdmtab_stackrestore(0x1A00, 0x3);\n\t\t}\n\t\tphy_stackrestore(0x04A2);\n\t\tphy_stackrestore(0x048A);\n\t\tphy_stackrestore(0x042B);\n\t\tphy_stackrestore(0x048C);\n\t\tb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_ACIW);\n\t\tb43_calc_nrssi_slope(dev);\n\t\tbreak;\n\tdefault:\n\t\tB43_WARN_ON(1);\n\t}\n}\n\n#undef phy_stacksave\n#undef phy_stackrestore\n#undef radio_stacksave\n#undef radio_stackrestore\n#undef ofdmtab_stacksave\n#undef ofdmtab_stackrestore\n\nstatic u16 b43_radio_core_calibration_value(struct b43_wldev *dev)\n{\n\tu16 reg, index, ret;\n\n\tstatic const u8 rcc_table[] = {\n\t\t0x02, 0x03, 0x01, 0x0F,\n\t\t0x06, 0x07, 0x05, 0x0F,\n\t\t0x0A, 0x0B, 0x09, 0x0F,\n\t\t0x0E, 0x0F, 0x0D, 0x0F,\n\t};\n\n\treg = b43_radio_read16(dev, 0x60);\n\tindex = (reg & 0x001E) >> 1;\n\tret = rcc_table[index] << 1;\n\tret |= (reg & 0x0001);\n\tret |= 0x0020;\n\n\treturn ret;\n}\n\n#define LPD(L, P, D)\t(((L) << 2) | ((P) << 1) | ((D) << 0))\nstatic u16 radio2050_rfover_val(struct b43_wldev *dev,\n\t\t\t\tu16 phy_register, unsigned int lpd)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\n\tif (!phy->gmode)\n\t\treturn 0;\n\n\tif (has_loopback_gain(phy)) {\n\t\tint max_lb_gain = gphy->max_lb_gain;\n\t\tu16 extlna;\n\t\tu16 i;\n\n\t\tif (phy->radio_rev == 8)\n\t\t\tmax_lb_gain += 0x3E;\n\t\telse\n\t\t\tmax_lb_gain += 0x26;\n\t\tif (max_lb_gain >= 0x46) {\n\t\t\textlna = 0x3000;\n\t\t\tmax_lb_gain -= 0x46;\n\t\t} else if (max_lb_gain >= 0x3A) {\n\t\t\textlna = 0x1000;\n\t\t\tmax_lb_gain -= 0x3A;\n\t\t} else if (max_lb_gain >= 0x2E) {\n\t\t\textlna = 0x2000;\n\t\t\tmax_lb_gain -= 0x2E;\n\t\t} else {\n\t\t\textlna = 0;\n\t\t\tmax_lb_gain -= 0x10;\n\t\t}\n\n\t\tfor (i = 0; i < 16; i++) {\n\t\t\tmax_lb_gain -= (i * 6);\n\t\t\tif (max_lb_gain < 6)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif ((phy->rev < 7) ||\n\t\t    !(sprom->boardflags_lo & B43_BFL_EXTLNA)) {\n\t\t\tif (phy_register == B43_PHY_RFOVER) {\n\t\t\t\treturn 0x1B3;\n\t\t\t} else if (phy_register == B43_PHY_RFOVERVAL) {\n\t\t\t\textlna |= (i << 8);\n\t\t\t\tswitch (lpd) {\n\t\t\t\tcase LPD(0, 1, 1):\n\t\t\t\t\treturn 0x0F92;\n\t\t\t\tcase LPD(0, 0, 1):\n\t\t\t\tcase LPD(1, 0, 1):\n\t\t\t\t\treturn (0x0092 | extlna);\n\t\t\t\tcase LPD(1, 0, 0):\n\t\t\t\t\treturn (0x0093 | extlna);\n\t\t\t\t}\n\t\t\t\tB43_WARN_ON(1);\n\t\t\t}\n\t\t\tB43_WARN_ON(1);\n\t\t} else {\n\t\t\tif (phy_register == B43_PHY_RFOVER) {\n\t\t\t\treturn 0x9B3;\n\t\t\t} else if (phy_register == B43_PHY_RFOVERVAL) {\n\t\t\t\tif (extlna)\n\t\t\t\t\textlna |= 0x8000;\n\t\t\t\textlna |= (i << 8);\n\t\t\t\tswitch (lpd) {\n\t\t\t\tcase LPD(0, 1, 1):\n\t\t\t\t\treturn 0x8F92;\n\t\t\t\tcase LPD(0, 0, 1):\n\t\t\t\t\treturn (0x8092 | extlna);\n\t\t\t\tcase LPD(1, 0, 1):\n\t\t\t\t\treturn (0x2092 | extlna);\n\t\t\t\tcase LPD(1, 0, 0):\n\t\t\t\t\treturn (0x2093 | extlna);\n\t\t\t\t}\n\t\t\t\tB43_WARN_ON(1);\n\t\t\t}\n\t\t\tB43_WARN_ON(1);\n\t\t}\n\t} else {\n\t\tif ((phy->rev < 7) ||\n\t\t    !(sprom->boardflags_lo & B43_BFL_EXTLNA)) {\n\t\t\tif (phy_register == B43_PHY_RFOVER) {\n\t\t\t\treturn 0x1B3;\n\t\t\t} else if (phy_register == B43_PHY_RFOVERVAL) {\n\t\t\t\tswitch (lpd) {\n\t\t\t\tcase LPD(0, 1, 1):\n\t\t\t\t\treturn 0x0FB2;\n\t\t\t\tcase LPD(0, 0, 1):\n\t\t\t\t\treturn 0x00B2;\n\t\t\t\tcase LPD(1, 0, 1):\n\t\t\t\t\treturn 0x30B2;\n\t\t\t\tcase LPD(1, 0, 0):\n\t\t\t\t\treturn 0x30B3;\n\t\t\t\t}\n\t\t\t\tB43_WARN_ON(1);\n\t\t\t}\n\t\t\tB43_WARN_ON(1);\n\t\t} else {\n\t\t\tif (phy_register == B43_PHY_RFOVER) {\n\t\t\t\treturn 0x9B3;\n\t\t\t} else if (phy_register == B43_PHY_RFOVERVAL) {\n\t\t\t\tswitch (lpd) {\n\t\t\t\tcase LPD(0, 1, 1):\n\t\t\t\t\treturn 0x8FB2;\n\t\t\t\tcase LPD(0, 0, 1):\n\t\t\t\t\treturn 0x80B2;\n\t\t\t\tcase LPD(1, 0, 1):\n\t\t\t\t\treturn 0x20B2;\n\t\t\t\tcase LPD(1, 0, 0):\n\t\t\t\t\treturn 0x20B3;\n\t\t\t\t}\n\t\t\t\tB43_WARN_ON(1);\n\t\t\t}\n\t\t\tB43_WARN_ON(1);\n\t\t}\n\t}\n\treturn 0;\n}\n\nstruct init2050_saved_values {\n\t \n\tu16 reg_3EC;\n\tu16 reg_3E6;\n\tu16 reg_3F4;\n\t \n\tu16 radio_43;\n\tu16 radio_51;\n\tu16 radio_52;\n\t \n\tu16 phy_pgactl;\n\tu16 phy_cck_5A;\n\tu16 phy_cck_59;\n\tu16 phy_cck_58;\n\tu16 phy_cck_30;\n\tu16 phy_rfover;\n\tu16 phy_rfoverval;\n\tu16 phy_analogover;\n\tu16 phy_analogoverval;\n\tu16 phy_crs0;\n\tu16 phy_classctl;\n\tu16 phy_lo_mask;\n\tu16 phy_lo_ctl;\n\tu16 phy_syncctl;\n};\n\nstatic u16 b43_radio_init2050(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct init2050_saved_values sav;\n\tu16 rcc;\n\tu16 radio78;\n\tu16 ret;\n\tu16 i, j;\n\tu32 tmp1 = 0, tmp2 = 0;\n\n\tmemset(&sav, 0, sizeof(sav));\t \n\n\tsav.radio_43 = b43_radio_read16(dev, 0x43);\n\tsav.radio_51 = b43_radio_read16(dev, 0x51);\n\tsav.radio_52 = b43_radio_read16(dev, 0x52);\n\tsav.phy_pgactl = b43_phy_read(dev, B43_PHY_PGACTL);\n\tsav.phy_cck_5A = b43_phy_read(dev, B43_PHY_CCK(0x5A));\n\tsav.phy_cck_59 = b43_phy_read(dev, B43_PHY_CCK(0x59));\n\tsav.phy_cck_58 = b43_phy_read(dev, B43_PHY_CCK(0x58));\n\n\tif (phy->type == B43_PHYTYPE_B) {\n\t\tsav.phy_cck_30 = b43_phy_read(dev, B43_PHY_CCK(0x30));\n\t\tsav.reg_3EC = b43_read16(dev, 0x3EC);\n\n\t\tb43_phy_write(dev, B43_PHY_CCK(0x30), 0xFF);\n\t\tb43_write16(dev, 0x3EC, 0x3F3F);\n\t} else if (phy->gmode || phy->rev >= 2) {\n\t\tsav.phy_rfover = b43_phy_read(dev, B43_PHY_RFOVER);\n\t\tsav.phy_rfoverval = b43_phy_read(dev, B43_PHY_RFOVERVAL);\n\t\tsav.phy_analogover = b43_phy_read(dev, B43_PHY_ANALOGOVER);\n\t\tsav.phy_analogoverval =\n\t\t    b43_phy_read(dev, B43_PHY_ANALOGOVERVAL);\n\t\tsav.phy_crs0 = b43_phy_read(dev, B43_PHY_CRS0);\n\t\tsav.phy_classctl = b43_phy_read(dev, B43_PHY_CLASSCTL);\n\n\t\tb43_phy_set(dev, B43_PHY_ANALOGOVER, 0x0003);\n\t\tb43_phy_mask(dev, B43_PHY_ANALOGOVERVAL, 0xFFFC);\n\t\tb43_phy_mask(dev, B43_PHY_CRS0, 0x7FFF);\n\t\tb43_phy_mask(dev, B43_PHY_CLASSCTL, 0xFFFC);\n\t\tif (has_loopback_gain(phy)) {\n\t\t\tsav.phy_lo_mask = b43_phy_read(dev, B43_PHY_LO_MASK);\n\t\t\tsav.phy_lo_ctl = b43_phy_read(dev, B43_PHY_LO_CTL);\n\n\t\t\tif (phy->rev >= 3)\n\t\t\t\tb43_phy_write(dev, B43_PHY_LO_MASK, 0xC020);\n\t\t\telse\n\t\t\t\tb43_phy_write(dev, B43_PHY_LO_MASK, 0x8020);\n\t\t\tb43_phy_write(dev, B43_PHY_LO_CTL, 0);\n\t\t}\n\n\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t      radio2050_rfover_val(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t   LPD(0, 1, 1)));\n\t\tb43_phy_write(dev, B43_PHY_RFOVER,\n\t\t\t      radio2050_rfover_val(dev, B43_PHY_RFOVER, 0));\n\t}\n\tb43_write16(dev, 0x3E2, b43_read16(dev, 0x3E2) | 0x8000);\n\n\tsav.phy_syncctl = b43_phy_read(dev, B43_PHY_SYNCCTL);\n\tb43_phy_mask(dev, B43_PHY_SYNCCTL, 0xFF7F);\n\tsav.reg_3E6 = b43_read16(dev, 0x3E6);\n\tsav.reg_3F4 = b43_read16(dev, 0x3F4);\n\n\tif (phy->analog == 0) {\n\t\tb43_write16(dev, 0x03E6, 0x0122);\n\t} else {\n\t\tif (phy->analog >= 2) {\n\t\t\tb43_phy_maskset(dev, B43_PHY_CCK(0x03), 0xFFBF, 0x40);\n\t\t}\n\t\tb43_write16(dev, B43_MMIO_CHANNEL_EXT,\n\t\t\t    (b43_read16(dev, B43_MMIO_CHANNEL_EXT) | 0x2000));\n\t}\n\n\trcc = b43_radio_core_calibration_value(dev);\n\n\tif (phy->type == B43_PHYTYPE_B)\n\t\tb43_radio_write16(dev, 0x78, 0x26);\n\tif (phy->gmode || phy->rev >= 2) {\n\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t      radio2050_rfover_val(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t   LPD(0, 1, 1)));\n\t}\n\tb43_phy_write(dev, B43_PHY_PGACTL, 0xBFAF);\n\tb43_phy_write(dev, B43_PHY_CCK(0x2B), 0x1403);\n\tif (phy->gmode || phy->rev >= 2) {\n\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t      radio2050_rfover_val(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t   LPD(0, 0, 1)));\n\t}\n\tb43_phy_write(dev, B43_PHY_PGACTL, 0xBFA0);\n\tb43_radio_set(dev, 0x51, 0x0004);\n\tif (phy->radio_rev == 8) {\n\t\tb43_radio_write16(dev, 0x43, 0x1F);\n\t} else {\n\t\tb43_radio_write16(dev, 0x52, 0);\n\t\tb43_radio_maskset(dev, 0x43, 0xFFF0, 0x0009);\n\t}\n\tb43_phy_write(dev, B43_PHY_CCK(0x58), 0);\n\n\tfor (i = 0; i < 16; i++) {\n\t\tb43_phy_write(dev, B43_PHY_CCK(0x5A), 0x0480);\n\t\tb43_phy_write(dev, B43_PHY_CCK(0x59), 0xC810);\n\t\tb43_phy_write(dev, B43_PHY_CCK(0x58), 0x000D);\n\t\tif (phy->gmode || phy->rev >= 2) {\n\t\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t      radio2050_rfover_val(dev,\n\t\t\t\t\t\t\t   B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t\t   LPD(1, 0, 1)));\n\t\t}\n\t\tb43_phy_write(dev, B43_PHY_PGACTL, 0xAFB0);\n\t\tudelay(10);\n\t\tif (phy->gmode || phy->rev >= 2) {\n\t\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t      radio2050_rfover_val(dev,\n\t\t\t\t\t\t\t   B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t\t   LPD(1, 0, 1)));\n\t\t}\n\t\tb43_phy_write(dev, B43_PHY_PGACTL, 0xEFB0);\n\t\tudelay(10);\n\t\tif (phy->gmode || phy->rev >= 2) {\n\t\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t      radio2050_rfover_val(dev,\n\t\t\t\t\t\t\t   B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t\t   LPD(1, 0, 0)));\n\t\t}\n\t\tb43_phy_write(dev, B43_PHY_PGACTL, 0xFFF0);\n\t\tudelay(20);\n\t\ttmp1 += b43_phy_read(dev, B43_PHY_LO_LEAKAGE);\n\t\tb43_phy_write(dev, B43_PHY_CCK(0x58), 0);\n\t\tif (phy->gmode || phy->rev >= 2) {\n\t\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t      radio2050_rfover_val(dev,\n\t\t\t\t\t\t\t   B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t\t   LPD(1, 0, 1)));\n\t\t}\n\t\tb43_phy_write(dev, B43_PHY_PGACTL, 0xAFB0);\n\t}\n\tudelay(10);\n\n\tb43_phy_write(dev, B43_PHY_CCK(0x58), 0);\n\ttmp1++;\n\ttmp1 >>= 9;\n\n\tfor (i = 0; i < 16; i++) {\n\t\tradio78 = (bitrev4(i) << 1) | 0x0020;\n\t\tb43_radio_write16(dev, 0x78, radio78);\n\t\tudelay(10);\n\t\tfor (j = 0; j < 16; j++) {\n\t\t\tb43_phy_write(dev, B43_PHY_CCK(0x5A), 0x0D80);\n\t\t\tb43_phy_write(dev, B43_PHY_CCK(0x59), 0xC810);\n\t\t\tb43_phy_write(dev, B43_PHY_CCK(0x58), 0x000D);\n\t\t\tif (phy->gmode || phy->rev >= 2) {\n\t\t\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t\t      radio2050_rfover_val(dev,\n\t\t\t\t\t\t\t\t   B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t\t\t   LPD(1, 0,\n\t\t\t\t\t\t\t\t       1)));\n\t\t\t}\n\t\t\tb43_phy_write(dev, B43_PHY_PGACTL, 0xAFB0);\n\t\t\tudelay(10);\n\t\t\tif (phy->gmode || phy->rev >= 2) {\n\t\t\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t\t      radio2050_rfover_val(dev,\n\t\t\t\t\t\t\t\t   B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t\t\t   LPD(1, 0,\n\t\t\t\t\t\t\t\t       1)));\n\t\t\t}\n\t\t\tb43_phy_write(dev, B43_PHY_PGACTL, 0xEFB0);\n\t\t\tudelay(10);\n\t\t\tif (phy->gmode || phy->rev >= 2) {\n\t\t\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t\t      radio2050_rfover_val(dev,\n\t\t\t\t\t\t\t\t   B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t\t\t   LPD(1, 0,\n\t\t\t\t\t\t\t\t       0)));\n\t\t\t}\n\t\t\tb43_phy_write(dev, B43_PHY_PGACTL, 0xFFF0);\n\t\t\tudelay(10);\n\t\t\ttmp2 += b43_phy_read(dev, B43_PHY_LO_LEAKAGE);\n\t\t\tb43_phy_write(dev, B43_PHY_CCK(0x58), 0);\n\t\t\tif (phy->gmode || phy->rev >= 2) {\n\t\t\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t\t      radio2050_rfover_val(dev,\n\t\t\t\t\t\t\t\t   B43_PHY_RFOVERVAL,\n\t\t\t\t\t\t\t\t   LPD(1, 0,\n\t\t\t\t\t\t\t\t       1)));\n\t\t\t}\n\t\t\tb43_phy_write(dev, B43_PHY_PGACTL, 0xAFB0);\n\t\t}\n\t\ttmp2++;\n\t\ttmp2 >>= 8;\n\t\tif (tmp1 < tmp2)\n\t\t\tbreak;\n\t}\n\n\t \n\tb43_phy_write(dev, B43_PHY_PGACTL, sav.phy_pgactl);\n\tb43_radio_write16(dev, 0x51, sav.radio_51);\n\tb43_radio_write16(dev, 0x52, sav.radio_52);\n\tb43_radio_write16(dev, 0x43, sav.radio_43);\n\tb43_phy_write(dev, B43_PHY_CCK(0x5A), sav.phy_cck_5A);\n\tb43_phy_write(dev, B43_PHY_CCK(0x59), sav.phy_cck_59);\n\tb43_phy_write(dev, B43_PHY_CCK(0x58), sav.phy_cck_58);\n\tb43_write16(dev, 0x3E6, sav.reg_3E6);\n\tif (phy->analog != 0)\n\t\tb43_write16(dev, 0x3F4, sav.reg_3F4);\n\tb43_phy_write(dev, B43_PHY_SYNCCTL, sav.phy_syncctl);\n\tb43_synth_pu_workaround(dev, phy->channel);\n\tif (phy->type == B43_PHYTYPE_B) {\n\t\tb43_phy_write(dev, B43_PHY_CCK(0x30), sav.phy_cck_30);\n\t\tb43_write16(dev, 0x3EC, sav.reg_3EC);\n\t} else if (phy->gmode) {\n\t\tb43_write16(dev, B43_MMIO_PHY_RADIO,\n\t\t\t    b43_read16(dev, B43_MMIO_PHY_RADIO)\n\t\t\t    & 0x7FFF);\n\t\tb43_phy_write(dev, B43_PHY_RFOVER, sav.phy_rfover);\n\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL, sav.phy_rfoverval);\n\t\tb43_phy_write(dev, B43_PHY_ANALOGOVER, sav.phy_analogover);\n\t\tb43_phy_write(dev, B43_PHY_ANALOGOVERVAL,\n\t\t\t      sav.phy_analogoverval);\n\t\tb43_phy_write(dev, B43_PHY_CRS0, sav.phy_crs0);\n\t\tb43_phy_write(dev, B43_PHY_CLASSCTL, sav.phy_classctl);\n\t\tif (has_loopback_gain(phy)) {\n\t\t\tb43_phy_write(dev, B43_PHY_LO_MASK, sav.phy_lo_mask);\n\t\t\tb43_phy_write(dev, B43_PHY_LO_CTL, sav.phy_lo_ctl);\n\t\t}\n\t}\n\tif (i > 15)\n\t\tret = radio78;\n\telse\n\t\tret = rcc;\n\n\treturn ret;\n}\n\nstatic void b43_phy_initb5(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tu16 offset, value;\n\tu8 old_channel;\n\n\tif (phy->analog == 1) {\n\t\tb43_radio_set(dev, 0x007A, 0x0050);\n\t}\n\tif ((dev->dev->board_vendor != SSB_BOARDVENDOR_BCM) &&\n\t    (dev->dev->board_type != SSB_BOARD_BU4306)) {\n\t\tvalue = 0x2120;\n\t\tfor (offset = 0x00A8; offset < 0x00C7; offset++) {\n\t\t\tb43_phy_write(dev, offset, value);\n\t\t\tvalue += 0x202;\n\t\t}\n\t}\n\tb43_phy_maskset(dev, 0x0035, 0xF0FF, 0x0700);\n\tif (phy->radio_ver == 0x2050)\n\t\tb43_phy_write(dev, 0x0038, 0x0667);\n\n\tif (phy->gmode || phy->rev >= 2) {\n\t\tif (phy->radio_ver == 0x2050) {\n\t\t\tb43_radio_set(dev, 0x007A, 0x0020);\n\t\t\tb43_radio_set(dev, 0x0051, 0x0004);\n\t\t}\n\t\tb43_write16(dev, B43_MMIO_PHY_RADIO, 0x0000);\n\n\t\tb43_phy_set(dev, 0x0802, 0x0100);\n\t\tb43_phy_set(dev, 0x042B, 0x2000);\n\n\t\tb43_phy_write(dev, 0x001C, 0x186A);\n\n\t\tb43_phy_maskset(dev, 0x0013, 0x00FF, 0x1900);\n\t\tb43_phy_maskset(dev, 0x0035, 0xFFC0, 0x0064);\n\t\tb43_phy_maskset(dev, 0x005D, 0xFF80, 0x000A);\n\t}\n\n\tif (dev->bad_frames_preempt) {\n\t\tb43_phy_set(dev, B43_PHY_RADIO_BITFIELD, (1 << 11));\n\t}\n\n\tif (phy->analog == 1) {\n\t\tb43_phy_write(dev, 0x0026, 0xCE00);\n\t\tb43_phy_write(dev, 0x0021, 0x3763);\n\t\tb43_phy_write(dev, 0x0022, 0x1BC3);\n\t\tb43_phy_write(dev, 0x0023, 0x06F9);\n\t\tb43_phy_write(dev, 0x0024, 0x037E);\n\t} else\n\t\tb43_phy_write(dev, 0x0026, 0xCC00);\n\tb43_phy_write(dev, 0x0030, 0x00C6);\n\tb43_write16(dev, 0x03EC, 0x3F22);\n\n\tif (phy->analog == 1)\n\t\tb43_phy_write(dev, 0x0020, 0x3E1C);\n\telse\n\t\tb43_phy_write(dev, 0x0020, 0x301C);\n\n\tif (phy->analog == 0)\n\t\tb43_write16(dev, 0x03E4, 0x3000);\n\n\told_channel = phy->channel;\n\t \n\tb43_gphy_channel_switch(dev, 7, 0);\n\n\tif (phy->radio_ver != 0x2050) {\n\t\tb43_radio_write16(dev, 0x0075, 0x0080);\n\t\tb43_radio_write16(dev, 0x0079, 0x0081);\n\t}\n\n\tb43_radio_write16(dev, 0x0050, 0x0020);\n\tb43_radio_write16(dev, 0x0050, 0x0023);\n\n\tif (phy->radio_ver == 0x2050) {\n\t\tb43_radio_write16(dev, 0x0050, 0x0020);\n\t\tb43_radio_write16(dev, 0x005A, 0x0070);\n\t}\n\n\tb43_radio_write16(dev, 0x005B, 0x007B);\n\tb43_radio_write16(dev, 0x005C, 0x00B0);\n\n\tb43_radio_set(dev, 0x007A, 0x0007);\n\n\tb43_gphy_channel_switch(dev, old_channel, 0);\n\n\tb43_phy_write(dev, 0x0014, 0x0080);\n\tb43_phy_write(dev, 0x0032, 0x00CA);\n\tb43_phy_write(dev, 0x002A, 0x88A3);\n\n\tb43_set_txpower_g(dev, &gphy->bbatt, &gphy->rfatt, gphy->tx_control);\n\n\tif (phy->radio_ver == 0x2050)\n\t\tb43_radio_write16(dev, 0x005D, 0x000D);\n\n\tb43_write16(dev, 0x03E4, (b43_read16(dev, 0x03E4) & 0xFFC0) | 0x0004);\n}\n\n \n\tif (phy->radio_rev == 8) {\n\t\tb43_radio_write16(dev, 0x51, 0);\n\t\tb43_radio_write16(dev, 0x52, 0x40);\n\t\tb43_radio_write16(dev, 0x53, 0xB7);\n\t\tb43_radio_write16(dev, 0x54, 0x98);\n\t\tb43_radio_write16(dev, 0x5A, 0x88);\n\t\tb43_radio_write16(dev, 0x5B, 0x6B);\n\t\tb43_radio_write16(dev, 0x5C, 0x0F);\n\t\tif (dev->dev->bus_sprom->boardflags_lo & B43_BFL_ALTIQ) {\n\t\t\tb43_radio_write16(dev, 0x5D, 0xFA);\n\t\t\tb43_radio_write16(dev, 0x5E, 0xD8);\n\t\t} else {\n\t\t\tb43_radio_write16(dev, 0x5D, 0xF5);\n\t\t\tb43_radio_write16(dev, 0x5E, 0xB8);\n\t\t}\n\t\tb43_radio_write16(dev, 0x0073, 0x0003);\n\t\tb43_radio_write16(dev, 0x007D, 0x00A8);\n\t\tb43_radio_write16(dev, 0x007C, 0x0001);\n\t\tb43_radio_write16(dev, 0x007E, 0x0008);\n\t}\n\tval = 0x1E1F;\n\tfor (offset = 0x0088; offset < 0x0098; offset++) {\n\t\tb43_phy_write(dev, offset, val);\n\t\tval -= 0x0202;\n\t}\n\tval = 0x3E3F;\n\tfor (offset = 0x0098; offset < 0x00A8; offset++) {\n\t\tb43_phy_write(dev, offset, val);\n\t\tval -= 0x0202;\n\t}\n\tval = 0x2120;\n\tfor (offset = 0x00A8; offset < 0x00C8; offset++) {\n\t\tb43_phy_write(dev, offset, (val & 0x3F3F));\n\t\tval += 0x0202;\n\t}\n\tif (phy->type == B43_PHYTYPE_G) {\n\t\tb43_radio_set(dev, 0x007A, 0x0020);\n\t\tb43_radio_set(dev, 0x0051, 0x0004);\n\t\tb43_phy_set(dev, 0x0802, 0x0100);\n\t\tb43_phy_set(dev, 0x042B, 0x2000);\n\t\tb43_phy_write(dev, 0x5B, 0);\n\t\tb43_phy_write(dev, 0x5C, 0);\n\t}\n\n\told_channel = phy->channel;\n\tif (old_channel >= 8)\n\t\tb43_gphy_channel_switch(dev, 1, 0);\n\telse\n\t\tb43_gphy_channel_switch(dev, 13, 0);\n\n\tb43_radio_write16(dev, 0x0050, 0x0020);\n\tb43_radio_write16(dev, 0x0050, 0x0023);\n\tudelay(40);\n\tif (phy->radio_rev < 6 || phy->radio_rev == 8) {\n\t\tb43_radio_write16(dev, 0x7C, (b43_radio_read16(dev, 0x7C)\n\t\t\t\t\t      | 0x0002));\n\t\tb43_radio_write16(dev, 0x50, 0x20);\n\t}\n\tif (phy->radio_rev <= 2) {\n\t\tb43_radio_write16(dev, 0x50, 0x20);\n\t\tb43_radio_write16(dev, 0x5A, 0x70);\n\t\tb43_radio_write16(dev, 0x5B, 0x7B);\n\t\tb43_radio_write16(dev, 0x5C, 0xB0);\n\t}\n\tb43_radio_maskset(dev, 0x007A, 0x00F8, 0x0007);\n\n\tb43_gphy_channel_switch(dev, old_channel, 0);\n\n\tb43_phy_write(dev, 0x0014, 0x0200);\n\tif (phy->radio_rev >= 6)\n\t\tb43_phy_write(dev, 0x2A, 0x88C2);\n\telse\n\t\tb43_phy_write(dev, 0x2A, 0x8AC0);\n\tb43_phy_write(dev, 0x0038, 0x0668);\n\tb43_set_txpower_g(dev, &gphy->bbatt, &gphy->rfatt, gphy->tx_control);\n\tif (phy->radio_rev == 4 || phy->radio_rev == 5)\n\t\tb43_phy_maskset(dev, 0x5D, 0xFF80, 0x0003);\n\tif (phy->radio_rev <= 2)\n\t\tb43_radio_write16(dev, 0x005D, 0x000D);\n\n\tif (phy->analog == 4) {\n\t\tb43_write16(dev, 0x3E4, 9);\n\t\tb43_phy_mask(dev, 0x61, 0x0FFF);\n\t} else {\n\t\tb43_phy_maskset(dev, 0x0002, 0xFFC0, 0x0004);\n\t}\n\tif (phy->type == B43_PHYTYPE_B)\n\t\tB43_WARN_ON(1);\n\telse if (phy->type == B43_PHYTYPE_G)\n\t\tb43_write16(dev, 0x03E6, 0x0);\n}\n\nstatic void b43_calc_loopback_gain(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tu16 backup_phy[16] = { 0 };\n\tu16 backup_radio[3];\n\tu16 backup_bband;\n\tu16 i, j, loop_i_max;\n\tu16 trsw_rx;\n\tu16 loop1_outer_done, loop1_inner_done;\n\n\tbackup_phy[0] = b43_phy_read(dev, B43_PHY_CRS0);\n\tbackup_phy[1] = b43_phy_read(dev, B43_PHY_CCKBBANDCFG);\n\tbackup_phy[2] = b43_phy_read(dev, B43_PHY_RFOVER);\n\tbackup_phy[3] = b43_phy_read(dev, B43_PHY_RFOVERVAL);\n\tif (phy->rev != 1) {\t \n\t\tbackup_phy[4] = b43_phy_read(dev, B43_PHY_ANALOGOVER);\n\t\tbackup_phy[5] = b43_phy_read(dev, B43_PHY_ANALOGOVERVAL);\n\t}\n\tbackup_phy[6] = b43_phy_read(dev, B43_PHY_CCK(0x5A));\n\tbackup_phy[7] = b43_phy_read(dev, B43_PHY_CCK(0x59));\n\tbackup_phy[8] = b43_phy_read(dev, B43_PHY_CCK(0x58));\n\tbackup_phy[9] = b43_phy_read(dev, B43_PHY_CCK(0x0A));\n\tbackup_phy[10] = b43_phy_read(dev, B43_PHY_CCK(0x03));\n\tbackup_phy[11] = b43_phy_read(dev, B43_PHY_LO_MASK);\n\tbackup_phy[12] = b43_phy_read(dev, B43_PHY_LO_CTL);\n\tbackup_phy[13] = b43_phy_read(dev, B43_PHY_CCK(0x2B));\n\tbackup_phy[14] = b43_phy_read(dev, B43_PHY_PGACTL);\n\tbackup_phy[15] = b43_phy_read(dev, B43_PHY_LO_LEAKAGE);\n\tbackup_bband = gphy->bbatt.att;\n\tbackup_radio[0] = b43_radio_read16(dev, 0x52);\n\tbackup_radio[1] = b43_radio_read16(dev, 0x43);\n\tbackup_radio[2] = b43_radio_read16(dev, 0x7A);\n\n\tb43_phy_mask(dev, B43_PHY_CRS0, 0x3FFF);\n\tb43_phy_set(dev, B43_PHY_CCKBBANDCFG, 0x8000);\n\tb43_phy_set(dev, B43_PHY_RFOVER, 0x0002);\n\tb43_phy_mask(dev, B43_PHY_RFOVERVAL, 0xFFFD);\n\tb43_phy_set(dev, B43_PHY_RFOVER, 0x0001);\n\tb43_phy_mask(dev, B43_PHY_RFOVERVAL, 0xFFFE);\n\tif (phy->rev != 1) {\t \n\t\tb43_phy_set(dev, B43_PHY_ANALOGOVER, 0x0001);\n\t\tb43_phy_mask(dev, B43_PHY_ANALOGOVERVAL, 0xFFFE);\n\t\tb43_phy_set(dev, B43_PHY_ANALOGOVER, 0x0002);\n\t\tb43_phy_mask(dev, B43_PHY_ANALOGOVERVAL, 0xFFFD);\n\t}\n\tb43_phy_set(dev, B43_PHY_RFOVER, 0x000C);\n\tb43_phy_set(dev, B43_PHY_RFOVERVAL, 0x000C);\n\tb43_phy_set(dev, B43_PHY_RFOVER, 0x0030);\n\tb43_phy_maskset(dev, B43_PHY_RFOVERVAL, 0xFFCF, 0x10);\n\n\tb43_phy_write(dev, B43_PHY_CCK(0x5A), 0x0780);\n\tb43_phy_write(dev, B43_PHY_CCK(0x59), 0xC810);\n\tb43_phy_write(dev, B43_PHY_CCK(0x58), 0x000D);\n\n\tb43_phy_set(dev, B43_PHY_CCK(0x0A), 0x2000);\n\tif (phy->rev != 1) {\t \n\t\tb43_phy_set(dev, B43_PHY_ANALOGOVER, 0x0004);\n\t\tb43_phy_mask(dev, B43_PHY_ANALOGOVERVAL, 0xFFFB);\n\t}\n\tb43_phy_maskset(dev, B43_PHY_CCK(0x03), 0xFF9F, 0x40);\n\n\tif (phy->radio_rev == 8) {\n\t\tb43_radio_write16(dev, 0x43, 0x000F);\n\t} else {\n\t\tb43_radio_write16(dev, 0x52, 0);\n\t\tb43_radio_maskset(dev, 0x43, 0xFFF0, 0x9);\n\t}\n\tb43_gphy_set_baseband_attenuation(dev, 11);\n\n\tif (phy->rev >= 3)\n\t\tb43_phy_write(dev, B43_PHY_LO_MASK, 0xC020);\n\telse\n\t\tb43_phy_write(dev, B43_PHY_LO_MASK, 0x8020);\n\tb43_phy_write(dev, B43_PHY_LO_CTL, 0);\n\n\tb43_phy_maskset(dev, B43_PHY_CCK(0x2B), 0xFFC0, 0x01);\n\tb43_phy_maskset(dev, B43_PHY_CCK(0x2B), 0xC0FF, 0x800);\n\n\tb43_phy_set(dev, B43_PHY_RFOVER, 0x0100);\n\tb43_phy_mask(dev, B43_PHY_RFOVERVAL, 0xCFFF);\n\n\tif (dev->dev->bus_sprom->boardflags_lo & B43_BFL_EXTLNA) {\n\t\tif (phy->rev >= 7) {\n\t\t\tb43_phy_set(dev, B43_PHY_RFOVER, 0x0800);\n\t\t\tb43_phy_set(dev, B43_PHY_RFOVERVAL, 0x8000);\n\t\t}\n\t}\n\tb43_radio_mask(dev, 0x7A, 0x00F7);\n\n\tj = 0;\n\tloop_i_max = (phy->radio_rev == 8) ? 15 : 9;\n\tfor (i = 0; i < loop_i_max; i++) {\n\t\tfor (j = 0; j < 16; j++) {\n\t\t\tb43_radio_write16(dev, 0x43, i);\n\t\t\tb43_phy_maskset(dev, B43_PHY_RFOVERVAL, 0xF0FF, (j << 8));\n\t\t\tb43_phy_maskset(dev, B43_PHY_PGACTL, 0x0FFF, 0xA000);\n\t\t\tb43_phy_set(dev, B43_PHY_PGACTL, 0xF000);\n\t\t\tudelay(20);\n\t\t\tif (b43_phy_read(dev, B43_PHY_LO_LEAKAGE) >= 0xDFC)\n\t\t\t\tgoto exit_loop1;\n\t\t}\n\t}\n      exit_loop1:\n\tloop1_outer_done = i;\n\tloop1_inner_done = j;\n\tif (j >= 8) {\n\t\tb43_phy_set(dev, B43_PHY_RFOVERVAL, 0x30);\n\t\ttrsw_rx = 0x1B;\n\t\tfor (j = j - 8; j < 16; j++) {\n\t\t\tb43_phy_maskset(dev, B43_PHY_RFOVERVAL, 0xF0FF, (j << 8));\n\t\t\tb43_phy_maskset(dev, B43_PHY_PGACTL, 0x0FFF, 0xA000);\n\t\t\tb43_phy_set(dev, B43_PHY_PGACTL, 0xF000);\n\t\t\tudelay(20);\n\t\t\ttrsw_rx -= 3;\n\t\t\tif (b43_phy_read(dev, B43_PHY_LO_LEAKAGE) >= 0xDFC)\n\t\t\t\tgoto exit_loop2;\n\t\t}\n\t} else\n\t\ttrsw_rx = 0x18;\n      exit_loop2:\n\n\tif (phy->rev != 1) {\t \n\t\tb43_phy_write(dev, B43_PHY_ANALOGOVER, backup_phy[4]);\n\t\tb43_phy_write(dev, B43_PHY_ANALOGOVERVAL, backup_phy[5]);\n\t}\n\tb43_phy_write(dev, B43_PHY_CCK(0x5A), backup_phy[6]);\n\tb43_phy_write(dev, B43_PHY_CCK(0x59), backup_phy[7]);\n\tb43_phy_write(dev, B43_PHY_CCK(0x58), backup_phy[8]);\n\tb43_phy_write(dev, B43_PHY_CCK(0x0A), backup_phy[9]);\n\tb43_phy_write(dev, B43_PHY_CCK(0x03), backup_phy[10]);\n\tb43_phy_write(dev, B43_PHY_LO_MASK, backup_phy[11]);\n\tb43_phy_write(dev, B43_PHY_LO_CTL, backup_phy[12]);\n\tb43_phy_write(dev, B43_PHY_CCK(0x2B), backup_phy[13]);\n\tb43_phy_write(dev, B43_PHY_PGACTL, backup_phy[14]);\n\n\tb43_gphy_set_baseband_attenuation(dev, backup_bband);\n\n\tb43_radio_write16(dev, 0x52, backup_radio[0]);\n\tb43_radio_write16(dev, 0x43, backup_radio[1]);\n\tb43_radio_write16(dev, 0x7A, backup_radio[2]);\n\n\tb43_phy_write(dev, B43_PHY_RFOVER, backup_phy[2] | 0x0003);\n\tudelay(10);\n\tb43_phy_write(dev, B43_PHY_RFOVER, backup_phy[2]);\n\tb43_phy_write(dev, B43_PHY_RFOVERVAL, backup_phy[3]);\n\tb43_phy_write(dev, B43_PHY_CRS0, backup_phy[0]);\n\tb43_phy_write(dev, B43_PHY_CCKBBANDCFG, backup_phy[1]);\n\n\tgphy->max_lb_gain =\n\t    ((loop1_inner_done * 6) - (loop1_outer_done * 4)) - 11;\n\tgphy->trsw_rx_gain = trsw_rx * 2;\n}\n\nstatic void b43_hardware_pctl_early_init(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tif (!b43_has_hardware_pctl(dev)) {\n\t\tb43_phy_write(dev, 0x047A, 0xC111);\n\t\treturn;\n\t}\n\n\tb43_phy_mask(dev, 0x0036, 0xFEFF);\n\tb43_phy_write(dev, 0x002F, 0x0202);\n\tb43_phy_set(dev, 0x047C, 0x0002);\n\tb43_phy_set(dev, 0x047A, 0xF000);\n\tif (phy->radio_ver == 0x2050 && phy->radio_rev == 8) {\n\t\tb43_phy_maskset(dev, 0x047A, 0xFF0F, 0x0010);\n\t\tb43_phy_set(dev, 0x005D, 0x8000);\n\t\tb43_phy_maskset(dev, 0x004E, 0xFFC0, 0x0010);\n\t\tb43_phy_write(dev, 0x002E, 0xC07F);\n\t\tb43_phy_set(dev, 0x0036, 0x0400);\n\t} else {\n\t\tb43_phy_set(dev, 0x0036, 0x0200);\n\t\tb43_phy_set(dev, 0x0036, 0x0400);\n\t\tb43_phy_mask(dev, 0x005D, 0x7FFF);\n\t\tb43_phy_mask(dev, 0x004F, 0xFFFE);\n\t\tb43_phy_maskset(dev, 0x004E, 0xFFC0, 0x0010);\n\t\tb43_phy_write(dev, 0x002E, 0xC07F);\n\t\tb43_phy_maskset(dev, 0x047A, 0xFF0F, 0x0010);\n\t}\n}\n\n \nstatic void b43_hardware_pctl_init_gphy(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\n\tif (!b43_has_hardware_pctl(dev)) {\n\t\t \n\t\tb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_HWPCTL);\n\t\treturn;\n\t}\n\n\tb43_phy_maskset(dev, 0x0036, 0xFFC0, (gphy->tgt_idle_tssi - gphy->cur_idle_tssi));\n\tb43_phy_maskset(dev, 0x0478, 0xFF00, (gphy->tgt_idle_tssi - gphy->cur_idle_tssi));\n\tb43_gphy_tssi_power_lt_init(dev);\n\tb43_gphy_gain_lt_init(dev);\n\tb43_phy_mask(dev, 0x0060, 0xFFBF);\n\tb43_phy_write(dev, 0x0014, 0x0000);\n\n\tB43_WARN_ON(phy->rev < 6);\n\tb43_phy_set(dev, 0x0478, 0x0800);\n\tb43_phy_mask(dev, 0x0478, 0xFEFF);\n\tb43_phy_mask(dev, 0x0801, 0xFFBF);\n\n\tb43_gphy_dc_lt_init(dev, 1);\n\n\t \n\tb43_hf_write(dev, b43_hf_read(dev) | B43_HF_HWPCTL);\n}\n\n \nstatic void b43_phy_init_pctl(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tstruct b43_rfatt old_rfatt;\n\tstruct b43_bbatt old_bbatt;\n\tu8 old_tx_control = 0;\n\n\tB43_WARN_ON(phy->type != B43_PHYTYPE_G);\n\n\tif ((dev->dev->board_vendor == SSB_BOARDVENDOR_BCM) &&\n\t    (dev->dev->board_type == SSB_BOARD_BU4306))\n\t\treturn;\n\n\tb43_phy_write(dev, 0x0028, 0x8018);\n\n\t \n\tb43_write16(dev, B43_MMIO_PHY0, b43_read16(dev, B43_MMIO_PHY0)\n\t\t    & 0xFFDF);\n\n\tif (!phy->gmode)\n\t\treturn;\n\tb43_hardware_pctl_early_init(dev);\n\tif (gphy->cur_idle_tssi == 0) {\n\t\tif (phy->radio_ver == 0x2050 && phy->analog == 0) {\n\t\t\tb43_radio_maskset(dev, 0x0076, 0x00F7, 0x0084);\n\t\t} else {\n\t\t\tstruct b43_rfatt rfatt;\n\t\t\tstruct b43_bbatt bbatt;\n\n\t\t\tmemcpy(&old_rfatt, &gphy->rfatt, sizeof(old_rfatt));\n\t\t\tmemcpy(&old_bbatt, &gphy->bbatt, sizeof(old_bbatt));\n\t\t\told_tx_control = gphy->tx_control;\n\n\t\t\tbbatt.att = 11;\n\t\t\tif (phy->radio_rev == 8) {\n\t\t\t\trfatt.att = 15;\n\t\t\t\trfatt.with_padmix = true;\n\t\t\t} else {\n\t\t\t\trfatt.att = 9;\n\t\t\t\trfatt.with_padmix = false;\n\t\t\t}\n\t\t\tb43_set_txpower_g(dev, &bbatt, &rfatt, 0);\n\t\t}\n\t\tb43_dummy_transmission(dev, false, true);\n\t\tgphy->cur_idle_tssi = b43_phy_read(dev, B43_PHY_ITSSI);\n\t\tif (B43_DEBUG) {\n\t\t\t \n\t\t\tif (abs(gphy->cur_idle_tssi - gphy->tgt_idle_tssi) >= 20) {\n\t\t\t\tb43dbg(dev->wl,\n\t\t\t\t       \"!WARNING! Idle-TSSI phy->cur_idle_tssi \"\n\t\t\t\t       \"measuring failed. (cur=%d, tgt=%d). Disabling TX power \"\n\t\t\t\t       \"adjustment.\\n\", gphy->cur_idle_tssi,\n\t\t\t\t       gphy->tgt_idle_tssi);\n\t\t\t\tgphy->cur_idle_tssi = 0;\n\t\t\t}\n\t\t}\n\t\tif (phy->radio_ver == 0x2050 && phy->analog == 0) {\n\t\t\tb43_radio_mask(dev, 0x0076, 0xFF7B);\n\t\t} else {\n\t\t\tb43_set_txpower_g(dev, &old_bbatt,\n\t\t\t\t\t  &old_rfatt, old_tx_control);\n\t\t}\n\t}\n\tb43_hardware_pctl_init_gphy(dev);\n\tb43_shm_clear_tssi(dev);\n}\n\nstatic void b43_phy_inita(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tmight_sleep();\n\n\tif (phy->rev >= 6) {\n\t\tif (b43_phy_read(dev, B43_PHY_ENCORE) & B43_PHY_ENCORE_EN)\n\t\t\tb43_phy_set(dev, B43_PHY_ENCORE, 0x0010);\n\t\telse\n\t\t\tb43_phy_mask(dev, B43_PHY_ENCORE, ~0x1010);\n\t}\n\n\tb43_wa_all(dev);\n\n\tif (dev->dev->bus_sprom->boardflags_lo & B43_BFL_PACTRL)\n\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0x6E), 0xE000, 0x3CF);\n}\n\nstatic void b43_phy_initg(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tu16 tmp;\n\n\tif (phy->rev == 1)\n\t\tb43_phy_initb5(dev);\n\telse\n\t\tb43_phy_initb6(dev);\n\n\tif (phy->rev >= 2 || phy->gmode)\n\t\tb43_phy_inita(dev);\n\n\tif (phy->rev >= 2) {\n\t\tb43_phy_write(dev, B43_PHY_ANALOGOVER, 0);\n\t\tb43_phy_write(dev, B43_PHY_ANALOGOVERVAL, 0);\n\t}\n\tif (phy->rev == 2) {\n\t\tb43_phy_write(dev, B43_PHY_RFOVER, 0);\n\t\tb43_phy_write(dev, B43_PHY_PGACTL, 0xC0);\n\t}\n\tif (phy->rev > 5) {\n\t\tb43_phy_write(dev, B43_PHY_RFOVER, 0x400);\n\t\tb43_phy_write(dev, B43_PHY_PGACTL, 0xC0);\n\t}\n\tif (phy->gmode || phy->rev >= 2) {\n\t\ttmp = b43_phy_read(dev, B43_PHY_VERSION_OFDM);\n\t\ttmp &= B43_PHYVER_VERSION;\n\t\tif (tmp == 3 || tmp == 5) {\n\t\t\tb43_phy_write(dev, B43_PHY_OFDM(0xC2), 0x1816);\n\t\t\tb43_phy_write(dev, B43_PHY_OFDM(0xC3), 0x8006);\n\t\t}\n\t\tif (tmp == 5) {\n\t\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0xCC), 0x00FF, 0x1F00);\n\t\t}\n\t}\n\tif ((phy->rev <= 2 && phy->gmode) || phy->rev >= 2)\n\t\tb43_phy_write(dev, B43_PHY_OFDM(0x7E), 0x78);\n\tif (phy->radio_rev == 8) {\n\t\tb43_phy_set(dev, B43_PHY_EXTG(0x01), 0x80);\n\t\tb43_phy_set(dev, B43_PHY_OFDM(0x3E), 0x4);\n\t}\n\tif (has_loopback_gain(phy))\n\t\tb43_calc_loopback_gain(dev);\n\n\tif (phy->radio_rev != 8) {\n\t\tif (gphy->initval == 0xFFFF)\n\t\t\tgphy->initval = b43_radio_init2050(dev);\n\t\telse\n\t\t\tb43_radio_write16(dev, 0x0078, gphy->initval);\n\t}\n\tb43_lo_g_init(dev);\n\tif (has_tx_magnification(phy)) {\n\t\tb43_radio_write16(dev, 0x52,\n\t\t\t\t  (b43_radio_read16(dev, 0x52) & 0xFF00)\n\t\t\t\t  | gphy->lo_control->tx_bias | gphy->\n\t\t\t\t  lo_control->tx_magn);\n\t} else {\n\t\tb43_radio_maskset(dev, 0x52, 0xFFF0, gphy->lo_control->tx_bias);\n\t}\n\tif (phy->rev >= 6) {\n\t\tb43_phy_maskset(dev, B43_PHY_CCK(0x36), 0x0FFF, (gphy->lo_control->tx_bias << 12));\n\t}\n\tif (dev->dev->bus_sprom->boardflags_lo & B43_BFL_PACTRL)\n\t\tb43_phy_write(dev, B43_PHY_CCK(0x2E), 0x8075);\n\telse\n\t\tb43_phy_write(dev, B43_PHY_CCK(0x2E), 0x807F);\n\tif (phy->rev < 2)\n\t\tb43_phy_write(dev, B43_PHY_CCK(0x2F), 0x101);\n\telse\n\t\tb43_phy_write(dev, B43_PHY_CCK(0x2F), 0x202);\n\tif (phy->gmode || phy->rev >= 2) {\n\t\tb43_lo_g_adjust(dev);\n\t\tb43_phy_write(dev, B43_PHY_LO_MASK, 0x8078);\n\t}\n\n\tif (!(dev->dev->bus_sprom->boardflags_lo & B43_BFL_RSSI)) {\n\t\t \n\t\tb43_nrssi_hw_update(dev, 0xFFFF);\t\n\t\tb43_calc_nrssi_threshold(dev);\n\t} else if (phy->gmode || phy->rev >= 2) {\n\t\tif (gphy->nrssi[0] == -1000) {\n\t\t\tB43_WARN_ON(gphy->nrssi[1] != -1000);\n\t\t\tb43_calc_nrssi_slope(dev);\n\t\t} else\n\t\t\tb43_calc_nrssi_threshold(dev);\n\t}\n\tif (phy->radio_rev == 8)\n\t\tb43_phy_write(dev, B43_PHY_EXTG(0x05), 0x3230);\n\tb43_phy_init_pctl(dev);\n\t \n\tif ((dev->dev->chip_id == 0x4306\n\t     && dev->dev->chip_pkg == 2) || 0) {\n\t\tb43_phy_mask(dev, B43_PHY_CRS0, 0xBFFF);\n\t\tb43_phy_mask(dev, B43_PHY_OFDM(0xC3), 0x7FFF);\n\t}\n}\n\nvoid b43_gphy_channel_switch(struct b43_wldev *dev,\n\t\t\t     unsigned int channel,\n\t\t\t     bool synthetic_pu_workaround)\n{\n\tif (synthetic_pu_workaround)\n\t\tb43_synth_pu_workaround(dev, channel);\n\n\tb43_write16(dev, B43_MMIO_CHANNEL, channel2freq_bg(channel));\n\n\tif (channel == 14) {\n\t\tif (dev->dev->bus_sprom->country_code ==\n\t\t    SSB_SPROM1CCODE_JAPAN)\n\t\t\tb43_hf_write(dev,\n\t\t\t\t     b43_hf_read(dev) & ~B43_HF_ACPR);\n\t\telse\n\t\t\tb43_hf_write(dev,\n\t\t\t\t     b43_hf_read(dev) | B43_HF_ACPR);\n\t\tb43_write16(dev, B43_MMIO_CHANNEL_EXT,\n\t\t\t    b43_read16(dev, B43_MMIO_CHANNEL_EXT)\n\t\t\t    | (1 << 11));\n\t} else {\n\t\tb43_write16(dev, B43_MMIO_CHANNEL_EXT,\n\t\t\t    b43_read16(dev, B43_MMIO_CHANNEL_EXT)\n\t\t\t    & 0xF7BF);\n\t}\n}\n\nstatic void default_baseband_attenuation(struct b43_wldev *dev,\n\t\t\t\t\t struct b43_bbatt *bb)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tif (phy->radio_ver == 0x2050 && phy->radio_rev < 6)\n\t\tbb->att = 0;\n\telse\n\t\tbb->att = 2;\n}\n\nstatic void default_radio_attenuation(struct b43_wldev *dev,\n\t\t\t\t      struct b43_rfatt *rf)\n{\n\tstruct b43_bus_dev *bdev = dev->dev;\n\tstruct b43_phy *phy = &dev->phy;\n\n\trf->with_padmix = false;\n\n\tif (dev->dev->board_vendor == SSB_BOARDVENDOR_BCM &&\n\t    dev->dev->board_type == SSB_BOARD_BCM4309G) {\n\t\tif (dev->dev->board_rev < 0x43) {\n\t\t\trf->att = 2;\n\t\t\treturn;\n\t\t} else if (dev->dev->board_rev < 0x51) {\n\t\t\trf->att = 3;\n\t\t\treturn;\n\t\t}\n\t}\n\n\tswitch (phy->radio_ver) {\n\tcase 0x2053:\n\t\tswitch (phy->radio_rev) {\n\t\tcase 1:\n\t\t\trf->att = 6;\n\t\t\treturn;\n\t\t}\n\t\tbreak;\n\tcase 0x2050:\n\t\tswitch (phy->radio_rev) {\n\t\tcase 0:\n\t\t\trf->att = 5;\n\t\t\treturn;\n\t\tcase 1:\n\t\t\tif (phy->type == B43_PHYTYPE_G) {\n\t\t\t\tif (bdev->board_vendor == SSB_BOARDVENDOR_BCM\n\t\t\t\t    && bdev->board_type == SSB_BOARD_BCM4309G\n\t\t\t\t    && bdev->board_rev >= 30)\n\t\t\t\t\trf->att = 3;\n\t\t\t\telse if (bdev->board_vendor ==\n\t\t\t\t\t SSB_BOARDVENDOR_BCM\n\t\t\t\t\t && bdev->board_type ==\n\t\t\t\t\t SSB_BOARD_BU4306)\n\t\t\t\t\trf->att = 3;\n\t\t\t\telse\n\t\t\t\t\trf->att = 1;\n\t\t\t} else {\n\t\t\t\tif (bdev->board_vendor == SSB_BOARDVENDOR_BCM\n\t\t\t\t    && bdev->board_type == SSB_BOARD_BCM4309G\n\t\t\t\t    && bdev->board_rev >= 30)\n\t\t\t\t\trf->att = 7;\n\t\t\t\telse\n\t\t\t\t\trf->att = 6;\n\t\t\t}\n\t\t\treturn;\n\t\tcase 2:\n\t\t\tif (phy->type == B43_PHYTYPE_G) {\n\t\t\t\tif (bdev->board_vendor == SSB_BOARDVENDOR_BCM\n\t\t\t\t    && bdev->board_type == SSB_BOARD_BCM4309G\n\t\t\t\t    && bdev->board_rev >= 30)\n\t\t\t\t\trf->att = 3;\n\t\t\t\telse if (bdev->board_vendor ==\n\t\t\t\t\t SSB_BOARDVENDOR_BCM\n\t\t\t\t\t && bdev->board_type ==\n\t\t\t\t\t SSB_BOARD_BU4306)\n\t\t\t\t\trf->att = 5;\n\t\t\t\telse if (bdev->chip_id == 0x4320)\n\t\t\t\t\trf->att = 4;\n\t\t\t\telse\n\t\t\t\t\trf->att = 3;\n\t\t\t} else\n\t\t\t\trf->att = 6;\n\t\t\treturn;\n\t\tcase 3:\n\t\t\trf->att = 5;\n\t\t\treturn;\n\t\tcase 4:\n\t\tcase 5:\n\t\t\trf->att = 1;\n\t\t\treturn;\n\t\tcase 6:\n\t\tcase 7:\n\t\t\trf->att = 5;\n\t\t\treturn;\n\t\tcase 8:\n\t\t\trf->att = 0xA;\n\t\t\trf->with_padmix = true;\n\t\t\treturn;\n\t\tcase 9:\n\t\tdefault:\n\t\t\trf->att = 5;\n\t\t\treturn;\n\t\t}\n\t}\n\trf->att = 5;\n}\n\nstatic u16 default_tx_control(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tif (phy->radio_ver != 0x2050)\n\t\treturn 0;\n\tif (phy->radio_rev == 1)\n\t\treturn B43_TXCTL_PA2DB | B43_TXCTL_TXMIX;\n\tif (phy->radio_rev < 6)\n\t\treturn B43_TXCTL_PA2DB;\n\tif (phy->radio_rev == 8)\n\t\treturn B43_TXCTL_TXMIX;\n\treturn 0;\n}\n\nstatic u8 b43_gphy_aci_detect(struct b43_wldev *dev, u8 channel)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tu8 ret = 0;\n\tu16 saved, rssi, temp;\n\tint i, j = 0;\n\n\tsaved = b43_phy_read(dev, 0x0403);\n\tb43_switch_channel(dev, channel);\n\tb43_phy_write(dev, 0x0403, (saved & 0xFFF8) | 5);\n\tif (gphy->aci_hw_rssi)\n\t\trssi = b43_phy_read(dev, 0x048A) & 0x3F;\n\telse\n\t\trssi = saved & 0x3F;\n\t \n\tif (rssi > 32)\n\t\trssi -= 64;\n\tfor (i = 0; i < 100; i++) {\n\t\ttemp = (b43_phy_read(dev, 0x047F) >> 8) & 0x3F;\n\t\tif (temp > 32)\n\t\t\ttemp -= 64;\n\t\tif (temp < rssi)\n\t\t\tj++;\n\t\tif (j >= 20)\n\t\t\tret = 1;\n\t}\n\tb43_phy_write(dev, 0x0403, saved);\n\n\treturn ret;\n}\n\nstatic u8 b43_gphy_aci_scan(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tu8 ret[13] = { 0 };\n\tunsigned int channel = phy->channel;\n\tunsigned int i, j, start, end;\n\n\tif (!((phy->type == B43_PHYTYPE_G) && (phy->rev > 0)))\n\t\treturn 0;\n\n\tb43_phy_lock(dev);\n\tb43_radio_lock(dev);\n\tb43_phy_mask(dev, 0x0802, 0xFFFC);\n\tb43_phy_mask(dev, B43_PHY_G_CRS, 0x7FFF);\n\tb43_set_all_gains(dev, 3, 8, 1);\n\n\tstart = (channel > 5) ? channel - 5 : 1;\n\tend = (channel + 5 < 14) ? channel + 5 : 13;\n\n\tfor (i = start; i <= end; i++) {\n\t\tif (abs(channel - i) > 2)\n\t\t\tret[i - 1] = b43_gphy_aci_detect(dev, i);\n\t}\n\tb43_switch_channel(dev, channel);\n\tb43_phy_maskset(dev, 0x0802, 0xFFFC, 0x0003);\n\tb43_phy_mask(dev, 0x0403, 0xFFF8);\n\tb43_phy_set(dev, B43_PHY_G_CRS, 0x8000);\n\tb43_set_original_gains(dev);\n\tfor (i = 0; i < 13; i++) {\n\t\tif (!ret[i])\n\t\t\tcontinue;\n\t\tend = (i + 5 < 13) ? i + 5 : 13;\n\t\tfor (j = i; j < end; j++)\n\t\t\tret[j] = 1;\n\t}\n\tb43_radio_unlock(dev);\n\tb43_phy_unlock(dev);\n\n\treturn ret[channel - 1];\n}\n\nstatic s32 b43_tssi2dbm_ad(s32 num, s32 den)\n{\n\tif (num < 0)\n\t\treturn num / den;\n\telse\n\t\treturn (num + den / 2) / den;\n}\n\nstatic s8 b43_tssi2dbm_entry(s8 entry[], u8 index,\n\t\t\t     s16 pab0, s16 pab1, s16 pab2)\n{\n\ts32 m1, m2, f = 256, q, delta;\n\ts8 i = 0;\n\n\tm1 = b43_tssi2dbm_ad(16 * pab0 + index * pab1, 32);\n\tm2 = max(b43_tssi2dbm_ad(32768 + index * pab2, 256), 1);\n\tdo {\n\t\tif (i > 15)\n\t\t\treturn -EINVAL;\n\t\tq = b43_tssi2dbm_ad(f * 4096 -\n\t\t\t\t    b43_tssi2dbm_ad(m2 * f, 16) * f, 2048);\n\t\tdelta = abs(q - f);\n\t\tf = q;\n\t\ti++;\n\t} while (delta >= 2);\n\tentry[index] = clamp_val(b43_tssi2dbm_ad(m1 * f, 8192), -127, 128);\n\treturn 0;\n}\n\nu8 *b43_generate_dyn_tssi2dbm_tab(struct b43_wldev *dev,\n\t\t\t\t  s16 pab0, s16 pab1, s16 pab2)\n{\n\tunsigned int i;\n\tu8 *tab;\n\tint err;\n\n\ttab = kmalloc(64, GFP_KERNEL);\n\tif (!tab) {\n\t\tb43err(dev->wl, \"Could not allocate memory \"\n\t\t       \"for tssi2dbm table\\n\");\n\t\treturn NULL;\n\t}\n\tfor (i = 0; i < 64; i++) {\n\t\terr = b43_tssi2dbm_entry(tab, i, pab0, pab1, pab2);\n\t\tif (err) {\n\t\t\tb43err(dev->wl, \"Could not generate \"\n\t\t\t       \"tssi2dBm table\\n\");\n\t\t\tkfree(tab);\n\t\t\treturn NULL;\n\t\t}\n\t}\n\n\treturn tab;\n}\n\n \nstatic int b43_gphy_init_tssi2dbm_table(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\ts16 pab0, pab1, pab2;\n\n\tpab0 = (s16) (dev->dev->bus_sprom->pa0b0);\n\tpab1 = (s16) (dev->dev->bus_sprom->pa0b1);\n\tpab2 = (s16) (dev->dev->bus_sprom->pa0b2);\n\n\tB43_WARN_ON((dev->dev->chip_id == 0x4301) &&\n\t\t    (phy->radio_ver != 0x2050));  \n\n\tgphy->dyn_tssi_tbl = false;\n\n\tif (pab0 != 0 && pab1 != 0 && pab2 != 0 &&\n\t    pab0 != -1 && pab1 != -1 && pab2 != -1) {\n\t\t \n\t\tif ((s8) dev->dev->bus_sprom->itssi_bg != 0 &&\n\t\t    (s8) dev->dev->bus_sprom->itssi_bg != -1) {\n\t\t\tgphy->tgt_idle_tssi =\n\t\t\t\t(s8) (dev->dev->bus_sprom->itssi_bg);\n\t\t} else\n\t\t\tgphy->tgt_idle_tssi = 62;\n\t\tgphy->tssi2dbm = b43_generate_dyn_tssi2dbm_tab(dev, pab0,\n\t\t\t\t\t\t\t       pab1, pab2);\n\t\tif (!gphy->tssi2dbm)\n\t\t\treturn -ENOMEM;\n\t\tgphy->dyn_tssi_tbl = true;\n\t} else {\n\t\t \n\t\tgphy->tgt_idle_tssi = 52;\n\t\tgphy->tssi2dbm = b43_tssi2dbm_g_table;\n\t}\n\n\treturn 0;\n}\n\nstatic int b43_gphy_op_allocate(struct b43_wldev *dev)\n{\n\tstruct b43_phy_g *gphy;\n\tstruct b43_txpower_lo_control *lo;\n\tint err;\n\n\tgphy = kzalloc(sizeof(*gphy), GFP_KERNEL);\n\tif (!gphy) {\n\t\terr = -ENOMEM;\n\t\tgoto error;\n\t}\n\tdev->phy.g = gphy;\n\n\tlo = kzalloc(sizeof(*lo), GFP_KERNEL);\n\tif (!lo) {\n\t\terr = -ENOMEM;\n\t\tgoto err_free_gphy;\n\t}\n\tgphy->lo_control = lo;\n\n\terr = b43_gphy_init_tssi2dbm_table(dev);\n\tif (err)\n\t\tgoto err_free_lo;\n\n\treturn 0;\n\nerr_free_lo:\n\tkfree(lo);\nerr_free_gphy:\n\tkfree(gphy);\nerror:\n\treturn err;\n}\n\nstatic void b43_gphy_op_prepare_structs(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tconst void *tssi2dbm;\n\tint tgt_idle_tssi;\n\tstruct b43_txpower_lo_control *lo;\n\tunsigned int i;\n\n\t \n\ttssi2dbm = gphy->tssi2dbm;\n\ttgt_idle_tssi = gphy->tgt_idle_tssi;\n\t \n\tlo = gphy->lo_control;\n\n\t \n\tmemset(gphy, 0, sizeof(*gphy));\n\n\t \n\tgphy->tssi2dbm = tssi2dbm;\n\tgphy->tgt_idle_tssi = tgt_idle_tssi;\n\tgphy->lo_control = lo;\n\n\tmemset(gphy->minlowsig, 0xFF, sizeof(gphy->minlowsig));\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(gphy->nrssi); i++)\n\t\tgphy->nrssi[i] = -1000;\n\tfor (i = 0; i < ARRAY_SIZE(gphy->nrssi_lt); i++)\n\t\tgphy->nrssi_lt[i] = i;\n\n\tgphy->lofcal = 0xFFFF;\n\tgphy->initval = 0xFFFF;\n\n\tgphy->interfmode = B43_INTERFMODE_NONE;\n\n\t \n\tgphy->ofdmtab_addr_direction = B43_OFDMTAB_DIRECTION_UNKNOWN;\n\n\tgphy->average_tssi = 0xFF;\n\n\t \n\tlo->tx_bias = 0xFF;\n\tINIT_LIST_HEAD(&lo->calib_list);\n}\n\nstatic void b43_gphy_op_free(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\n\tkfree(gphy->lo_control);\n\n\tif (gphy->dyn_tssi_tbl)\n\t\tkfree(gphy->tssi2dbm);\n\tgphy->dyn_tssi_tbl = false;\n\tgphy->tssi2dbm = NULL;\n\n\tkfree(gphy);\n\tdev->phy.g = NULL;\n}\n\nstatic int b43_gphy_op_prepare_hardware(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tstruct b43_txpower_lo_control *lo = gphy->lo_control;\n\n\tB43_WARN_ON(phy->type != B43_PHYTYPE_G);\n\n\tdefault_baseband_attenuation(dev, &gphy->bbatt);\n\tdefault_radio_attenuation(dev, &gphy->rfatt);\n\tgphy->tx_control = (default_tx_control(dev) << 4);\n\tgenerate_rfatt_list(dev, &lo->rfatt_list);\n\tgenerate_bbatt_list(dev, &lo->bbatt_list);\n\n\t \n\tb43_read32(dev, B43_MMIO_MACCTL);\n\n\tif (phy->rev == 1) {\n\t\t \n\t\tphy->gmode = false;\n\t\tb43_wireless_core_reset(dev, 0);\n\t\tb43_phy_initg(dev);\n\t\tphy->gmode = true;\n\t\tb43_wireless_core_reset(dev, 1);\n\t}\n\n\treturn 0;\n}\n\nstatic int b43_gphy_op_init(struct b43_wldev *dev)\n{\n\tb43_phy_initg(dev);\n\n\treturn 0;\n}\n\nstatic void b43_gphy_op_exit(struct b43_wldev *dev)\n{\n\tb43_lo_g_cleanup(dev);\n}\n\nstatic u16 b43_gphy_op_read(struct b43_wldev *dev, u16 reg)\n{\n\tb43_write16f(dev, B43_MMIO_PHY_CONTROL, reg);\n\treturn b43_read16(dev, B43_MMIO_PHY_DATA);\n}\n\nstatic void b43_gphy_op_write(struct b43_wldev *dev, u16 reg, u16 value)\n{\n\tb43_write16f(dev, B43_MMIO_PHY_CONTROL, reg);\n\tb43_write16(dev, B43_MMIO_PHY_DATA, value);\n}\n\nstatic u16 b43_gphy_op_radio_read(struct b43_wldev *dev, u16 reg)\n{\n\t \n\tB43_WARN_ON(reg == 1);\n\t \n\treg |= 0x80;\n\n\tb43_write16f(dev, B43_MMIO_RADIO_CONTROL, reg);\n\treturn b43_read16(dev, B43_MMIO_RADIO_DATA_LOW);\n}\n\nstatic void b43_gphy_op_radio_write(struct b43_wldev *dev, u16 reg, u16 value)\n{\n\t \n\tB43_WARN_ON(reg == 1);\n\n\tb43_write16f(dev, B43_MMIO_RADIO_CONTROL, reg);\n\tb43_write16(dev, B43_MMIO_RADIO_DATA_LOW, value);\n}\n\nstatic bool b43_gphy_op_supports_hwpctl(struct b43_wldev *dev)\n{\n\treturn (dev->phy.rev >= 6);\n}\n\nstatic void b43_gphy_op_software_rfkill(struct b43_wldev *dev,\n\t\t\t\t\tbool blocked)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tunsigned int channel;\n\n\tmight_sleep();\n\n\tif (!blocked) {\n\t\t \n\t\tif (phy->radio_on)\n\t\t\treturn;\n\n\t\tb43_phy_write(dev, 0x0015, 0x8000);\n\t\tb43_phy_write(dev, 0x0015, 0xCC00);\n\t\tb43_phy_write(dev, 0x0015, (phy->gmode ? 0x00C0 : 0x0000));\n\t\tif (gphy->radio_off_context.valid) {\n\t\t\t \n\t\t\tb43_phy_write(dev, B43_PHY_RFOVER,\n\t\t\t\t      gphy->radio_off_context.rfover);\n\t\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL,\n\t\t\t\t      gphy->radio_off_context.rfoverval);\n\t\t\tgphy->radio_off_context.valid = false;\n\t\t}\n\t\tchannel = phy->channel;\n\t\tb43_gphy_channel_switch(dev, 6, 1);\n\t\tb43_gphy_channel_switch(dev, channel, 0);\n\t} else {\n\t\t \n\t\tu16 rfover, rfoverval;\n\n\t\trfover = b43_phy_read(dev, B43_PHY_RFOVER);\n\t\trfoverval = b43_phy_read(dev, B43_PHY_RFOVERVAL);\n\t\tgphy->radio_off_context.rfover = rfover;\n\t\tgphy->radio_off_context.rfoverval = rfoverval;\n\t\tgphy->radio_off_context.valid = true;\n\t\tb43_phy_write(dev, B43_PHY_RFOVER, rfover | 0x008C);\n\t\tb43_phy_write(dev, B43_PHY_RFOVERVAL, rfoverval & 0xFF73);\n\t}\n}\n\nstatic int b43_gphy_op_switch_channel(struct b43_wldev *dev,\n\t\t\t\t      unsigned int new_channel)\n{\n\tif ((new_channel < 1) || (new_channel > 14))\n\t\treturn -EINVAL;\n\tb43_gphy_channel_switch(dev, new_channel, 0);\n\n\treturn 0;\n}\n\nstatic unsigned int b43_gphy_op_get_default_chan(struct b43_wldev *dev)\n{\n\treturn 1;  \n}\n\nstatic void b43_gphy_op_set_rx_antenna(struct b43_wldev *dev, int antenna)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tu16 tmp;\n\tint autodiv = 0;\n\n\tif (antenna == B43_ANTENNA_AUTO0 || antenna == B43_ANTENNA_AUTO1)\n\t\tautodiv = 1;\n\n\tb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_ANTDIVHELP);\n\n\tb43_phy_maskset(dev, B43_PHY_BBANDCFG, ~B43_PHY_BBANDCFG_RXANT,\n\t\t\t(autodiv ? B43_ANTENNA_AUTO1 : antenna) <<\n\t\t\tB43_PHY_BBANDCFG_RXANT_SHIFT);\n\n\tif (autodiv) {\n\t\ttmp = b43_phy_read(dev, B43_PHY_ANTDWELL);\n\t\tif (antenna == B43_ANTENNA_AUTO1)\n\t\t\ttmp &= ~B43_PHY_ANTDWELL_AUTODIV1;\n\t\telse\n\t\t\ttmp |= B43_PHY_ANTDWELL_AUTODIV1;\n\t\tb43_phy_write(dev, B43_PHY_ANTDWELL, tmp);\n\t}\n\n\ttmp = b43_phy_read(dev, B43_PHY_ANTWRSETT);\n\tif (autodiv)\n\t\ttmp |= B43_PHY_ANTWRSETT_ARXDIV;\n\telse\n\t\ttmp &= ~B43_PHY_ANTWRSETT_ARXDIV;\n\tb43_phy_write(dev, B43_PHY_ANTWRSETT, tmp);\n\n\tif (autodiv)\n\t\tb43_phy_set(dev, B43_PHY_ANTWRSETT, B43_PHY_ANTWRSETT_ARXDIV);\n\telse {\n\t\tb43_phy_mask(dev, B43_PHY_ANTWRSETT,\n\t\t\t     B43_PHY_ANTWRSETT_ARXDIV);\n\t}\n\n\tif (phy->rev >= 2) {\n\t\tb43_phy_set(dev, B43_PHY_OFDM61, B43_PHY_OFDM61_10);\n\t\tb43_phy_maskset(dev, B43_PHY_DIVSRCHGAINBACK, 0xFF00, 0x15);\n\n\t\tif (phy->rev == 2)\n\t\t\tb43_phy_write(dev, B43_PHY_ADIVRELATED, 8);\n\t\telse\n\t\t\tb43_phy_maskset(dev, B43_PHY_ADIVRELATED, 0xFF00, 8);\n\t}\n\tif (phy->rev >= 6)\n\t\tb43_phy_write(dev, B43_PHY_OFDM9B, 0xDC);\n\n\tb43_hf_write(dev, b43_hf_read(dev) | B43_HF_ANTDIVHELP);\n}\n\nstatic int b43_gphy_op_interf_mitigation(struct b43_wldev *dev,\n\t\t\t\t\t enum b43_interference_mitigation mode)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tint currentmode;\n\n\tB43_WARN_ON(phy->type != B43_PHYTYPE_G);\n\tif ((phy->rev == 0) || (!phy->gmode))\n\t\treturn -ENODEV;\n\n\tgphy->aci_wlan_automatic = false;\n\tswitch (mode) {\n\tcase B43_INTERFMODE_AUTOWLAN:\n\t\tgphy->aci_wlan_automatic = true;\n\t\tif (gphy->aci_enable)\n\t\t\tmode = B43_INTERFMODE_MANUALWLAN;\n\t\telse\n\t\t\tmode = B43_INTERFMODE_NONE;\n\t\tbreak;\n\tcase B43_INTERFMODE_NONE:\n\tcase B43_INTERFMODE_NONWLAN:\n\tcase B43_INTERFMODE_MANUALWLAN:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tcurrentmode = gphy->interfmode;\n\tif (currentmode == mode)\n\t\treturn 0;\n\tif (currentmode != B43_INTERFMODE_NONE)\n\t\tb43_radio_interference_mitigation_disable(dev, currentmode);\n\n\tif (mode == B43_INTERFMODE_NONE) {\n\t\tgphy->aci_enable = false;\n\t\tgphy->aci_hw_rssi = false;\n\t} else\n\t\tb43_radio_interference_mitigation_enable(dev, mode);\n\tgphy->interfmode = mode;\n\n\treturn 0;\n}\n\n \nstatic s8 b43_gphy_estimate_power_out(struct b43_wldev *dev, s8 tssi)\n{\n\tstruct b43_phy_g *gphy = dev->phy.g;\n\ts8 dbm;\n\ts32 tmp;\n\n\ttmp = (gphy->tgt_idle_tssi - gphy->cur_idle_tssi + tssi);\n\ttmp = clamp_val(tmp, 0x00, 0x3F);\n\tdbm = gphy->tssi2dbm[tmp];\n\n\treturn dbm;\n}\n\nstatic void b43_put_attenuation_into_ranges(struct b43_wldev *dev,\n\t\t\t\t\t    int *_bbatt, int *_rfatt)\n{\n\tint rfatt = *_rfatt;\n\tint bbatt = *_bbatt;\n\tstruct b43_txpower_lo_control *lo = dev->phy.g->lo_control;\n\n\t \n\n\t \n\tconst int rf_min = lo->rfatt_list.min_val;\n\tconst int rf_max = lo->rfatt_list.max_val;\n\tconst int bb_min = lo->bbatt_list.min_val;\n\tconst int bb_max = lo->bbatt_list.max_val;\n\n\twhile (1) {\n\t\tif (rfatt > rf_max && bbatt > bb_max - 4)\n\t\t\tbreak;\t \n\t\tif (rfatt < rf_min && bbatt < bb_min + 4)\n\t\t\tbreak;\t \n\t\tif (bbatt > bb_max && rfatt > rf_max - 1)\n\t\t\tbreak;\t \n\t\tif (bbatt < bb_min && rfatt < rf_min + 1)\n\t\t\tbreak;\t \n\n\t\tif (bbatt > bb_max) {\n\t\t\tbbatt -= 4;\n\t\t\trfatt += 1;\n\t\t\tcontinue;\n\t\t}\n\t\tif (bbatt < bb_min) {\n\t\t\tbbatt += 4;\n\t\t\trfatt -= 1;\n\t\t\tcontinue;\n\t\t}\n\t\tif (rfatt > rf_max) {\n\t\t\trfatt -= 1;\n\t\t\tbbatt += 4;\n\t\t\tcontinue;\n\t\t}\n\t\tif (rfatt < rf_min) {\n\t\t\trfatt += 1;\n\t\t\tbbatt -= 4;\n\t\t\tcontinue;\n\t\t}\n\t\tbreak;\n\t}\n\n\t*_rfatt = clamp_val(rfatt, rf_min, rf_max);\n\t*_bbatt = clamp_val(bbatt, bb_min, bb_max);\n}\n\nstatic void b43_gphy_op_adjust_txpower(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tint rfatt, bbatt;\n\tu8 tx_control;\n\n\tb43_mac_suspend(dev);\n\n\t \n\tbbatt = gphy->bbatt.att;\n\tbbatt += gphy->bbatt_delta;\n\trfatt = gphy->rfatt.att;\n\trfatt += gphy->rfatt_delta;\n\n\tb43_put_attenuation_into_ranges(dev, &bbatt, &rfatt);\n\ttx_control = gphy->tx_control;\n\tif ((phy->radio_ver == 0x2050) && (phy->radio_rev == 2)) {\n\t\tif (rfatt <= 1) {\n\t\t\tif (tx_control == 0) {\n\t\t\t\ttx_control =\n\t\t\t\t    B43_TXCTL_PA2DB |\n\t\t\t\t    B43_TXCTL_TXMIX;\n\t\t\t\trfatt += 2;\n\t\t\t\tbbatt += 2;\n\t\t\t} else if (dev->dev->bus_sprom->\n\t\t\t\t   boardflags_lo &\n\t\t\t\t   B43_BFL_PACTRL) {\n\t\t\t\tbbatt += 4 * (rfatt - 2);\n\t\t\t\trfatt = 2;\n\t\t\t}\n\t\t} else if (rfatt > 4 && tx_control) {\n\t\t\ttx_control = 0;\n\t\t\tif (bbatt < 3) {\n\t\t\t\trfatt -= 3;\n\t\t\t\tbbatt += 2;\n\t\t\t} else {\n\t\t\t\trfatt -= 2;\n\t\t\t\tbbatt -= 2;\n\t\t\t}\n\t\t}\n\t}\n\t \n\tgphy->tx_control = tx_control;\n\tb43_put_attenuation_into_ranges(dev, &bbatt, &rfatt);\n\tgphy->rfatt.att = rfatt;\n\tgphy->bbatt.att = bbatt;\n\n\tif (b43_debug(dev, B43_DBG_XMITPOWER))\n\t\tb43dbg(dev->wl, \"Adjusting TX power\\n\");\n\n\t \n\tb43_phy_lock(dev);\n\tb43_radio_lock(dev);\n\tb43_set_txpower_g(dev, &gphy->bbatt, &gphy->rfatt,\n\t\t\t  gphy->tx_control);\n\tb43_radio_unlock(dev);\n\tb43_phy_unlock(dev);\n\n\tb43_mac_enable(dev);\n}\n\nstatic enum b43_txpwr_result b43_gphy_op_recalc_txpower(struct b43_wldev *dev,\n\t\t\t\t\t\t\tbool ignore_tssi)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\tunsigned int average_tssi;\n\tint cck_result, ofdm_result;\n\tint estimated_pwr, desired_pwr, pwr_adjust;\n\tint rfatt_delta, bbatt_delta;\n\tunsigned int max_pwr;\n\n\t \n\tcck_result = b43_phy_shm_tssi_read(dev, B43_SHM_SH_TSSI_CCK);\n\tofdm_result = b43_phy_shm_tssi_read(dev, B43_SHM_SH_TSSI_OFDM_G);\n\tif ((cck_result < 0) && (ofdm_result < 0)) {\n\t\t \n\t\tif (!ignore_tssi)\n\t\t\tgoto no_adjustment_needed;\n\t\tcck_result = 0;\n\t\tofdm_result = 0;\n\t}\n\tif (cck_result < 0)\n\t\taverage_tssi = ofdm_result;\n\telse if (ofdm_result < 0)\n\t\taverage_tssi = cck_result;\n\telse\n\t\taverage_tssi = (cck_result + ofdm_result) / 2;\n\t \n\tif (likely(gphy->average_tssi != 0xFF))\n\t\taverage_tssi = (average_tssi + gphy->average_tssi) / 2;\n\tgphy->average_tssi = average_tssi;\n\tB43_WARN_ON(average_tssi >= B43_TSSI_MAX);\n\n\t \n\testimated_pwr = b43_gphy_estimate_power_out(dev, average_tssi);\n\n\tB43_WARN_ON(phy->type != B43_PHYTYPE_G);\n\tmax_pwr = dev->dev->bus_sprom->maxpwr_bg;\n\tif (dev->dev->bus_sprom->boardflags_lo & B43_BFL_PACTRL)\n\t\tmax_pwr -= 3;  \n\tif (unlikely(max_pwr >= INT_TO_Q52(30 ))) {\n\t\tb43warn(dev->wl,\n\t\t\t\"Invalid max-TX-power value in SPROM.\\n\");\n\t\tmax_pwr = INT_TO_Q52(20);  \n\t\tdev->dev->bus_sprom->maxpwr_bg = max_pwr;\n\t}\n\n\t \n\tif (phy->desired_txpower < 0)\n\t\tdesired_pwr = INT_TO_Q52(0);\n\telse\n\t\tdesired_pwr = INT_TO_Q52(phy->desired_txpower);\n\t \n\tdesired_pwr = clamp_val(desired_pwr, 0, max_pwr);\n\tif (b43_debug(dev, B43_DBG_XMITPOWER)) {\n\t\tb43dbg(dev->wl,\n\t\t       \"[TX power]  current = \" Q52_FMT\n\t\t       \" dBm,  desired = \" Q52_FMT\n\t\t       \" dBm,  max = \" Q52_FMT \"\\n\",\n\t\t       Q52_ARG(estimated_pwr),\n\t\t       Q52_ARG(desired_pwr),\n\t\t       Q52_ARG(max_pwr));\n\t}\n\n\t \n\tpwr_adjust = desired_pwr - estimated_pwr;\n\tif (pwr_adjust == 0)\n\t\tgoto no_adjustment_needed;\n\n\t \n\trfatt_delta = ((pwr_adjust + 7) / 8);\n\t \n\trfatt_delta = -rfatt_delta;\n\n\t \n\tbbatt_delta = pwr_adjust / 2;\n\t \n\tbbatt_delta = -bbatt_delta;\n\t \n\tbbatt_delta -= 4 * rfatt_delta;\n\n#if B43_DEBUG\n\tif (b43_debug(dev, B43_DBG_XMITPOWER)) {\n\t\tint dbm = pwr_adjust < 0 ? -pwr_adjust : pwr_adjust;\n\t\tb43dbg(dev->wl,\n\t\t       \"[TX power deltas]  %s\" Q52_FMT \" dBm   =>   \"\n\t\t       \"bbatt-delta = %d,  rfatt-delta = %d\\n\",\n\t\t       (pwr_adjust < 0 ? \"-\" : \"\"), Q52_ARG(dbm),\n\t\t       bbatt_delta, rfatt_delta);\n\t}\n#endif  \n\n\t \n\tif ((rfatt_delta == 0) && (bbatt_delta == 0))\n\t\tgoto no_adjustment_needed;\n\n\t \n\tgphy->bbatt_delta = bbatt_delta;\n\tgphy->rfatt_delta = rfatt_delta;\n\n\t \n\treturn B43_TXPWR_RES_NEED_ADJUST;\n\nno_adjustment_needed:\n\treturn B43_TXPWR_RES_DONE;\n}\n\nstatic void b43_gphy_op_pwork_15sec(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_g *gphy = phy->g;\n\n\tb43_mac_suspend(dev);\n\t\n\tif (gphy->aci_enable && gphy->aci_wlan_automatic) {\n\t\tif (!gphy->aci_enable && 1   ) {\n\t\t\tif (0   ) {\n\t\t\t\tphy->ops->interf_mitigation(dev,\n\t\t\t\t\tB43_INTERFMODE_MANUALWLAN);\n\t\t\t}\n\t\t} else if (0  ) {\n\t\t\t   if (  !b43_gphy_aci_scan(dev))\n\t\t\t\tphy->ops->interf_mitigation(dev, B43_INTERFMODE_NONE);\n\t\t}\n\t} else if (gphy->interfmode == B43_INTERFMODE_NONWLAN &&\n\t\t   phy->rev == 1) {\n\t\t\n\t}\n\tb43_lo_g_maintenance_work(dev);\n\tb43_mac_enable(dev);\n}\n\nstatic void b43_gphy_op_pwork_60sec(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tif (!(dev->dev->bus_sprom->boardflags_lo & B43_BFL_RSSI))\n\t\treturn;\n\n\tb43_mac_suspend(dev);\n\tb43_calc_nrssi_slope(dev);\n\tif ((phy->radio_ver == 0x2050) && (phy->radio_rev == 8)) {\n\t\tu8 old_chan = phy->channel;\n\n\t\t \n\t\tif (old_chan >= 8)\n\t\t\tb43_switch_channel(dev, 1);\n\t\telse\n\t\t\tb43_switch_channel(dev, 13);\n\t\tb43_switch_channel(dev, old_chan);\n\t}\n\tb43_mac_enable(dev);\n}\n\nconst struct b43_phy_operations b43_phyops_g = {\n\t.allocate\t\t= b43_gphy_op_allocate,\n\t.free\t\t\t= b43_gphy_op_free,\n\t.prepare_structs\t= b43_gphy_op_prepare_structs,\n\t.prepare_hardware\t= b43_gphy_op_prepare_hardware,\n\t.init\t\t\t= b43_gphy_op_init,\n\t.exit\t\t\t= b43_gphy_op_exit,\n\t.phy_read\t\t= b43_gphy_op_read,\n\t.phy_write\t\t= b43_gphy_op_write,\n\t.radio_read\t\t= b43_gphy_op_radio_read,\n\t.radio_write\t\t= b43_gphy_op_radio_write,\n\t.supports_hwpctl\t= b43_gphy_op_supports_hwpctl,\n\t.software_rfkill\t= b43_gphy_op_software_rfkill,\n\t.switch_analog\t\t= b43_phyop_switch_analog_generic,\n\t.switch_channel\t\t= b43_gphy_op_switch_channel,\n\t.get_default_chan\t= b43_gphy_op_get_default_chan,\n\t.set_rx_antenna\t\t= b43_gphy_op_set_rx_antenna,\n\t.interf_mitigation\t= b43_gphy_op_interf_mitigation,\n\t.recalc_txpower\t\t= b43_gphy_op_recalc_txpower,\n\t.adjust_txpower\t\t= b43_gphy_op_adjust_txpower,\n\t.pwork_15sec\t\t= b43_gphy_op_pwork_15sec,\n\t.pwork_60sec\t\t= b43_gphy_op_pwork_60sec,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}