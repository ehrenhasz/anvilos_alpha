{
  "module_name": "phy_ht.c",
  "hash_id": "99e974a8e89dcc29ef9c002936d50332ca035cc9424d8dc260dd5ed16a75d2ce",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/b43/phy_ht.c",
  "human_readable_source": "\n \n\n#include <linux/slab.h>\n\n#include \"b43.h\"\n#include \"phy_ht.h\"\n#include \"tables_phy_ht.h\"\n#include \"radio_2059.h\"\n#include \"main.h\"\n\n \nenum ht_rssi_type {\n\tHT_RSSI_W1 = 0,\n\tHT_RSSI_W2 = 1,\n\tHT_RSSI_NB = 2,\n\tHT_RSSI_IQ = 3,\n\tHT_RSSI_TSSI_2G = 4,\n\tHT_RSSI_TSSI_5G = 5,\n\tHT_RSSI_TBD = 6,\n};\n\n \n\nstatic void b43_radio_2059_channel_setup(struct b43_wldev *dev,\n\t\t\tconst struct b43_phy_ht_channeltab_e_radio2059 *e)\n{\n\tstatic const u16 routing[] = { R2059_C1, R2059_C2, R2059_C3, };\n\tu16 r;\n\tint core;\n\n\tb43_radio_write(dev, 0x16, e->radio_syn16);\n\tb43_radio_write(dev, 0x17, e->radio_syn17);\n\tb43_radio_write(dev, 0x22, e->radio_syn22);\n\tb43_radio_write(dev, 0x25, e->radio_syn25);\n\tb43_radio_write(dev, 0x27, e->radio_syn27);\n\tb43_radio_write(dev, 0x28, e->radio_syn28);\n\tb43_radio_write(dev, 0x29, e->radio_syn29);\n\tb43_radio_write(dev, 0x2c, e->radio_syn2c);\n\tb43_radio_write(dev, 0x2d, e->radio_syn2d);\n\tb43_radio_write(dev, 0x37, e->radio_syn37);\n\tb43_radio_write(dev, 0x41, e->radio_syn41);\n\tb43_radio_write(dev, 0x43, e->radio_syn43);\n\tb43_radio_write(dev, 0x47, e->radio_syn47);\n\n\tfor (core = 0; core < 3; core++) {\n\t\tr = routing[core];\n\t\tb43_radio_write(dev, r | 0x4a, e->radio_rxtx4a);\n\t\tb43_radio_write(dev, r | 0x58, e->radio_rxtx58);\n\t\tb43_radio_write(dev, r | 0x5a, e->radio_rxtx5a);\n\t\tb43_radio_write(dev, r | 0x6a, e->radio_rxtx6a);\n\t\tb43_radio_write(dev, r | 0x6d, e->radio_rxtx6d);\n\t\tb43_radio_write(dev, r | 0x6e, e->radio_rxtx6e);\n\t\tb43_radio_write(dev, r | 0x92, e->radio_rxtx92);\n\t\tb43_radio_write(dev, r | 0x98, e->radio_rxtx98);\n\t}\n\n\tudelay(50);\n\n\t \n\tb43_radio_mask(dev, R2059_RFPLL_MISC_EN, ~0x1);\n\tb43_radio_mask(dev, R2059_RFPLL_MISC_CAL_RESETN, ~0x4);\n\tb43_radio_set(dev, R2059_RFPLL_MISC_CAL_RESETN, 0x4);\n\tb43_radio_set(dev, R2059_RFPLL_MISC_EN, 0x1);\n\n\tudelay(300);\n}\n\n \nstatic void b43_radio_2059_rcal(struct b43_wldev *dev)\n{\n\t \n\tb43_radio_set(dev, R2059_C3 | R2059_RCAL_CONFIG, 0x1);\n\tusleep_range(10, 20);\n\n\tb43_radio_set(dev, R2059_C3 | 0x0BF, 0x1);\n\tb43_radio_maskset(dev, R2059_C3 | 0x19B, 0x3, 0x2);\n\n\t \n\tb43_radio_set(dev, R2059_C3 | R2059_RCAL_CONFIG, 0x2);\n\tusleep_range(100, 200);\n\n\t \n\tb43_radio_mask(dev, R2059_C3 | R2059_RCAL_CONFIG, ~0x2);\n\n\tif (!b43_radio_wait_value(dev, R2059_C3 | R2059_RCAL_STATUS, 1, 1, 100,\n\t\t\t\t  1000000))\n\t\tb43err(dev->wl, \"Radio 0x2059 rcal timeout\\n\");\n\n\t \n\tb43_radio_mask(dev, R2059_C3 | R2059_RCAL_CONFIG, ~0x1);\n\n\tb43_radio_set(dev, 0xa, 0x60);\n}\n\n \nstatic void b43_radio_2057_rccal(struct b43_wldev *dev)\n{\n\tstatic const u16 radio_values[3][2] = {\n\t\t{ 0x61, 0xE9 }, { 0x69, 0xD5 }, { 0x73, 0x99 },\n\t};\n\tint i;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tb43_radio_write(dev, R2059_RCCAL_MASTER, radio_values[i][0]);\n\t\tb43_radio_write(dev, R2059_RCCAL_X1, 0x6E);\n\t\tb43_radio_write(dev, R2059_RCCAL_TRC0, radio_values[i][1]);\n\n\t\t \n\t\tb43_radio_write(dev, R2059_RCCAL_START_R1_Q1_P1, 0x55);\n\n\t\t \n\t\tif (!b43_radio_wait_value(dev, R2059_RCCAL_DONE_OSCCAP, 2, 2,\n\t\t\t\t\t  500, 5000000))\n\t\t\tb43err(dev->wl, \"Radio 0x2059 rccal timeout\\n\");\n\n\t\t \n\t\tb43_radio_write(dev, R2059_RCCAL_START_R1_Q1_P1, 0x15);\n\t}\n\n\tb43_radio_mask(dev, R2059_RCCAL_MASTER, ~0x1);\n}\n\nstatic void b43_radio_2059_init_pre(struct b43_wldev *dev)\n{\n\tb43_phy_mask(dev, B43_PHY_HT_RF_CTL_CMD, ~B43_PHY_HT_RF_CTL_CMD_CHIP0_PU);\n\tb43_phy_set(dev, B43_PHY_HT_RF_CTL_CMD, B43_PHY_HT_RF_CTL_CMD_FORCE);\n\tb43_phy_mask(dev, B43_PHY_HT_RF_CTL_CMD, ~B43_PHY_HT_RF_CTL_CMD_FORCE);\n\tb43_phy_set(dev, B43_PHY_HT_RF_CTL_CMD, B43_PHY_HT_RF_CTL_CMD_CHIP0_PU);\n}\n\nstatic void b43_radio_2059_init(struct b43_wldev *dev)\n{\n\tstatic const u16 routing[] = { R2059_C1, R2059_C2, R2059_C3 };\n\tint i;\n\n\t \n\tb43_radio_2059_init_pre(dev);\n\n\tr2059_upload_inittabs(dev);\n\n\tfor (i = 0; i < ARRAY_SIZE(routing); i++)\n\t\tb43_radio_set(dev, routing[i] | 0x146, 0x3);\n\n\t \n\n\tb43_radio_set(dev, R2059_RFPLL_MISC_CAL_RESETN, 0x0078);\n\tb43_radio_set(dev, R2059_XTAL_CONFIG2, 0x0080);\n\tmsleep(2);\n\tb43_radio_mask(dev, R2059_RFPLL_MISC_CAL_RESETN, ~0x0078);\n\tb43_radio_mask(dev, R2059_XTAL_CONFIG2, ~0x0080);\n\n\tif (1) {  \n\t\tb43_radio_2059_rcal(dev);\n\t\tb43_radio_2057_rccal(dev);\n\t}\n\n\tb43_radio_mask(dev, R2059_RFPLL_MASTER, ~0x0008);\n}\n\n \n\nstatic void b43_phy_ht_force_rf_sequence(struct b43_wldev *dev, u16 rf_seq)\n{\n\tu8 i;\n\n\tu16 save_seq_mode = b43_phy_read(dev, B43_PHY_HT_RF_SEQ_MODE);\n\tb43_phy_set(dev, B43_PHY_HT_RF_SEQ_MODE, 0x3);\n\n\tb43_phy_set(dev, B43_PHY_HT_RF_SEQ_TRIG, rf_seq);\n\tfor (i = 0; i < 200; i++) {\n\t\tif (!(b43_phy_read(dev, B43_PHY_HT_RF_SEQ_STATUS) & rf_seq)) {\n\t\t\ti = 0;\n\t\t\tbreak;\n\t\t}\n\t\tmsleep(1);\n\t}\n\tif (i)\n\t\tb43err(dev->wl, \"Forcing RF sequence timeout\\n\");\n\n\tb43_phy_write(dev, B43_PHY_HT_RF_SEQ_MODE, save_seq_mode);\n}\n\nstatic void b43_phy_ht_pa_override(struct b43_wldev *dev, bool enable)\n{\n\tstruct b43_phy_ht *htphy = dev->phy.ht;\n\tstatic const u16 regs[3] = { B43_PHY_HT_RF_CTL_INT_C1,\n\t\t\t\t     B43_PHY_HT_RF_CTL_INT_C2,\n\t\t\t\t     B43_PHY_HT_RF_CTL_INT_C3 };\n\tint i;\n\n\tif (enable) {\n\t\tfor (i = 0; i < 3; i++)\n\t\t\tb43_phy_write(dev, regs[i], htphy->rf_ctl_int_save[i]);\n\t} else {\n\t\tfor (i = 0; i < 3; i++)\n\t\t\thtphy->rf_ctl_int_save[i] = b43_phy_read(dev, regs[i]);\n\t\t \n\t\tfor (i = 0; i < 3; i++)\n\t\t\tb43_phy_write(dev, regs[i], 0x0400);\n\t}\n}\n\n \n\nstatic u16 b43_phy_ht_classifier(struct b43_wldev *dev, u16 mask, u16 val)\n{\n\tu16 tmp;\n\tu16 allowed = B43_PHY_HT_CLASS_CTL_CCK_EN |\n\t\t      B43_PHY_HT_CLASS_CTL_OFDM_EN |\n\t\t      B43_PHY_HT_CLASS_CTL_WAITED_EN;\n\n\ttmp = b43_phy_read(dev, B43_PHY_HT_CLASS_CTL);\n\ttmp &= allowed;\n\ttmp &= ~mask;\n\ttmp |= (val & mask);\n\tb43_phy_maskset(dev, B43_PHY_HT_CLASS_CTL, ~allowed, tmp);\n\n\treturn tmp;\n}\n\nstatic void b43_phy_ht_reset_cca(struct b43_wldev *dev)\n{\n\tu16 bbcfg;\n\n\tb43_phy_force_clock(dev, true);\n\tbbcfg = b43_phy_read(dev, B43_PHY_HT_BBCFG);\n\tb43_phy_write(dev, B43_PHY_HT_BBCFG, bbcfg | B43_PHY_HT_BBCFG_RSTCCA);\n\tudelay(1);\n\tb43_phy_write(dev, B43_PHY_HT_BBCFG, bbcfg & ~B43_PHY_HT_BBCFG_RSTCCA);\n\tb43_phy_force_clock(dev, false);\n\n\tb43_phy_ht_force_rf_sequence(dev, B43_PHY_HT_RF_SEQ_TRIG_RST2RX);\n}\n\nstatic void b43_phy_ht_zero_extg(struct b43_wldev *dev)\n{\n\tu8 i, j;\n\tstatic const u16 base[] = { 0x40, 0x60, 0x80 };\n\n\tfor (i = 0; i < ARRAY_SIZE(base); i++) {\n\t\tfor (j = 0; j < 4; j++)\n\t\t\tb43_phy_write(dev, B43_PHY_EXTG(base[i] + j), 0);\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(base); i++)\n\t\tb43_phy_write(dev, B43_PHY_EXTG(base[i] + 0xc), 0);\n}\n\n \nstatic void b43_phy_ht_afe_unk1(struct b43_wldev *dev)\n{\n\tu8 i;\n\n\tstatic const u16 ctl_regs[3][2] = {\n\t\t{ B43_PHY_HT_AFE_C1_OVER, B43_PHY_HT_AFE_C1 },\n\t\t{ B43_PHY_HT_AFE_C2_OVER, B43_PHY_HT_AFE_C2 },\n\t\t{ B43_PHY_HT_AFE_C3_OVER, B43_PHY_HT_AFE_C3},\n\t};\n\n\tfor (i = 0; i < 3; i++) {\n\t\t \n\t\tb43_phy_set(dev, ctl_regs[i][1], 0x4);\n\t\tb43_phy_set(dev, ctl_regs[i][0], 0x4);\n\t\tb43_phy_mask(dev, ctl_regs[i][1], ~0x1);\n\t\tb43_phy_set(dev, ctl_regs[i][0], 0x1);\n\t\tb43_httab_write(dev, B43_HTTAB16(8, 5 + (i * 0x10)), 0);\n\t\tb43_phy_mask(dev, ctl_regs[i][0], ~0x4);\n\t}\n}\n\nstatic void b43_phy_ht_read_clip_detection(struct b43_wldev *dev, u16 *clip_st)\n{\n\tclip_st[0] = b43_phy_read(dev, B43_PHY_HT_C1_CLIP1THRES);\n\tclip_st[1] = b43_phy_read(dev, B43_PHY_HT_C2_CLIP1THRES);\n\tclip_st[2] = b43_phy_read(dev, B43_PHY_HT_C3_CLIP1THRES);\n}\n\nstatic void b43_phy_ht_bphy_init(struct b43_wldev *dev)\n{\n\tunsigned int i;\n\tu16 val;\n\n\tval = 0x1E1F;\n\tfor (i = 0; i < 16; i++) {\n\t\tb43_phy_write(dev, B43_PHY_N_BMODE(0x88 + i), val);\n\t\tval -= 0x202;\n\t}\n\tval = 0x3E3F;\n\tfor (i = 0; i < 16; i++) {\n\t\tb43_phy_write(dev, B43_PHY_N_BMODE(0x98 + i), val);\n\t\tval -= 0x202;\n\t}\n\tb43_phy_write(dev, B43_PHY_N_BMODE(0x38), 0x668);\n}\n\nstatic void b43_phy_ht_bphy_reset(struct b43_wldev *dev, bool reset)\n{\n\tu16 tmp;\n\n\ttmp = b43_read16(dev, B43_MMIO_PSM_PHY_HDR);\n\tb43_write16(dev, B43_MMIO_PSM_PHY_HDR,\n\t\t    tmp | B43_PSM_HDR_MAC_PHY_FORCE_CLK);\n\n\t \n\tif (reset)\n\t\tb43_phy_set(dev, B43_PHY_B_BBCFG,\n\t\t\t    B43_PHY_B_BBCFG_RSTCCA | B43_PHY_B_BBCFG_RSTRX);\n\telse\n\t\tb43_phy_mask(dev, B43_PHY_B_BBCFG,\n\t\t\t     (u16)~(B43_PHY_B_BBCFG_RSTCCA |\n\t\t\t\t    B43_PHY_B_BBCFG_RSTRX));\n\n\tb43_write16(dev, B43_MMIO_PSM_PHY_HDR, tmp);\n}\n\n \n\nstatic void b43_phy_ht_stop_playback(struct b43_wldev *dev)\n{\n\tstruct b43_phy_ht *phy_ht = dev->phy.ht;\n\tu16 tmp;\n\tint i;\n\n\ttmp = b43_phy_read(dev, B43_PHY_HT_SAMP_STAT);\n\tif (tmp & 0x1)\n\t\tb43_phy_set(dev, B43_PHY_HT_SAMP_CMD, B43_PHY_HT_SAMP_CMD_STOP);\n\telse if (tmp & 0x2)\n\t\tb43_phy_mask(dev, B43_PHY_HT_IQLOCAL_CMDGCTL, 0x7FFF);\n\n\tb43_phy_mask(dev, B43_PHY_HT_SAMP_CMD, ~0x0004);\n\n\tfor (i = 0; i < 3; i++) {\n\t\tif (phy_ht->bb_mult_save[i] >= 0) {\n\t\t\tb43_httab_write(dev, B43_HTTAB16(13, 0x63 + i * 4),\n\t\t\t\t\tphy_ht->bb_mult_save[i]);\n\t\t\tb43_httab_write(dev, B43_HTTAB16(13, 0x67 + i * 4),\n\t\t\t\t\tphy_ht->bb_mult_save[i]);\n\t\t}\n\t}\n}\n\nstatic u16 b43_phy_ht_load_samples(struct b43_wldev *dev)\n{\n\tint i;\n\tu16 len = 20 << 3;\n\n\tb43_phy_write(dev, B43_PHY_HT_TABLE_ADDR, 0x4400);\n\n\tfor (i = 0; i < len; i++) {\n\t\tb43_phy_write(dev, B43_PHY_HT_TABLE_DATAHI, 0);\n\t\tb43_phy_write(dev, B43_PHY_HT_TABLE_DATALO, 0);\n\t}\n\n\treturn len;\n}\n\nstatic void b43_phy_ht_run_samples(struct b43_wldev *dev, u16 samps, u16 loops,\n\t\t\t\t   u16 wait)\n{\n\tstruct b43_phy_ht *phy_ht = dev->phy.ht;\n\tu16 save_seq_mode;\n\tint i;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tif (phy_ht->bb_mult_save[i] < 0)\n\t\t\tphy_ht->bb_mult_save[i] = b43_httab_read(dev, B43_HTTAB16(13, 0x63 + i * 4));\n\t}\n\n\tb43_phy_write(dev, B43_PHY_HT_SAMP_DEP_CNT, samps - 1);\n\tif (loops != 0xFFFF)\n\t\tloops--;\n\tb43_phy_write(dev, B43_PHY_HT_SAMP_LOOP_CNT, loops);\n\tb43_phy_write(dev, B43_PHY_HT_SAMP_WAIT_CNT, wait);\n\n\tsave_seq_mode = b43_phy_read(dev, B43_PHY_HT_RF_SEQ_MODE);\n\tb43_phy_set(dev, B43_PHY_HT_RF_SEQ_MODE,\n\t\t    B43_PHY_HT_RF_SEQ_MODE_CA_OVER);\n\n\t \n\tb43_phy_mask(dev, B43_PHY_HT_SAMP_CMD, ~0);\n\tb43_phy_mask(dev, B43_PHY_HT_SAMP_CMD, ~0);\n\tb43_phy_mask(dev, B43_PHY_HT_IQLOCAL_CMDGCTL, ~0);\n\tb43_phy_set(dev, B43_PHY_HT_SAMP_CMD, 0x1);\n\n\tfor (i = 0; i < 100; i++) {\n\t\tif (!(b43_phy_read(dev, B43_PHY_HT_RF_SEQ_STATUS) & 1)) {\n\t\t\ti = 0;\n\t\t\tbreak;\n\t\t}\n\t\tudelay(10);\n\t}\n\tif (i)\n\t\tb43err(dev->wl, \"run samples timeout\\n\");\n\n\tb43_phy_write(dev, B43_PHY_HT_RF_SEQ_MODE, save_seq_mode);\n}\n\nstatic void b43_phy_ht_tx_tone(struct b43_wldev *dev)\n{\n\tu16 samp;\n\n\tsamp = b43_phy_ht_load_samples(dev);\n\tb43_phy_ht_run_samples(dev, samp, 0xFFFF, 0);\n}\n\n \n\nstatic void b43_phy_ht_rssi_select(struct b43_wldev *dev, u8 core_sel,\n\t\t\t\t   enum ht_rssi_type rssi_type)\n{\n\tstatic const u16 ctl_regs[3][2] = {\n\t\t{ B43_PHY_HT_AFE_C1, B43_PHY_HT_AFE_C1_OVER, },\n\t\t{ B43_PHY_HT_AFE_C2, B43_PHY_HT_AFE_C2_OVER, },\n\t\t{ B43_PHY_HT_AFE_C3, B43_PHY_HT_AFE_C3_OVER, },\n\t};\n\tstatic const u16 radio_r[] = { R2059_C1, R2059_C2, R2059_C3, };\n\tint core;\n\n\tif (core_sel == 0) {\n\t\tb43err(dev->wl, \"RSSI selection for core off not implemented yet\\n\");\n\t} else {\n\t\tfor (core = 0; core < 3; core++) {\n\t\t\t \n\t\t\tif ((core_sel == 1 && core != 0) ||\n\t\t\t    (core_sel == 2 && core != 1) ||\n\t\t\t    (core_sel == 3 && core != 2))\n\t\t\t\tcontinue;\n\n\t\t\tswitch (rssi_type) {\n\t\t\tcase HT_RSSI_TSSI_2G:\n\t\t\t\tb43_phy_set(dev, ctl_regs[core][0], 0x3 << 8);\n\t\t\t\tb43_phy_set(dev, ctl_regs[core][0], 0x3 << 10);\n\t\t\t\tb43_phy_set(dev, ctl_regs[core][1], 0x1 << 9);\n\t\t\t\tb43_phy_set(dev, ctl_regs[core][1], 0x1 << 10);\n\n\t\t\t\tb43_radio_set(dev, R2059_C3 | 0xbf, 0x1);\n\t\t\t\tb43_radio_write(dev, radio_r[core] | 0x159,\n\t\t\t\t\t\t0x11);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tb43err(dev->wl, \"RSSI selection for type %d not implemented yet\\n\",\n\t\t\t\t       rssi_type);\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic void b43_phy_ht_poll_rssi(struct b43_wldev *dev, enum ht_rssi_type type,\n\t\t\t\t s32 *buf, u8 nsamp)\n{\n\tu16 phy_regs_values[12];\n\tstatic const u16 phy_regs_to_save[] = {\n\t\tB43_PHY_HT_AFE_C1, B43_PHY_HT_AFE_C1_OVER,\n\t\t0x848, 0x841,\n\t\tB43_PHY_HT_AFE_C2, B43_PHY_HT_AFE_C2_OVER,\n\t\t0x868, 0x861,\n\t\tB43_PHY_HT_AFE_C3, B43_PHY_HT_AFE_C3_OVER,\n\t\t0x888, 0x881,\n\t};\n\tu16 tmp[3];\n\tint i;\n\n\tfor (i = 0; i < 12; i++)\n\t\tphy_regs_values[i] = b43_phy_read(dev, phy_regs_to_save[i]);\n\n\tb43_phy_ht_rssi_select(dev, 5, type);\n\n\tfor (i = 0; i < 6; i++)\n\t\tbuf[i] = 0;\n\n\tfor (i = 0; i < nsamp; i++) {\n\t\ttmp[0] = b43_phy_read(dev, B43_PHY_HT_RSSI_C1);\n\t\ttmp[1] = b43_phy_read(dev, B43_PHY_HT_RSSI_C2);\n\t\ttmp[2] = b43_phy_read(dev, B43_PHY_HT_RSSI_C3);\n\n\t\tbuf[0] += ((s8)((tmp[0] & 0x3F) << 2)) >> 2;\n\t\tbuf[1] += ((s8)(((tmp[0] >> 8) & 0x3F) << 2)) >> 2;\n\t\tbuf[2] += ((s8)((tmp[1] & 0x3F) << 2)) >> 2;\n\t\tbuf[3] += ((s8)(((tmp[1] >> 8) & 0x3F) << 2)) >> 2;\n\t\tbuf[4] += ((s8)((tmp[2] & 0x3F) << 2)) >> 2;\n\t\tbuf[5] += ((s8)(((tmp[2] >> 8) & 0x3F) << 2)) >> 2;\n\t}\n\n\tfor (i = 0; i < 12; i++)\n\t\tb43_phy_write(dev, phy_regs_to_save[i], phy_regs_values[i]);\n}\n\n \n\nstatic void b43_phy_ht_tx_power_fix(struct b43_wldev *dev)\n{\n\tint i;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tu16 mask;\n\t\tu32 tmp = b43_httab_read(dev, B43_HTTAB32(26, 0xE8));\n\n\t\tif (0)  \n\t\t\tmask = 0x2 << (i * 4);\n\t\telse\n\t\t\tmask = 0;\n\t\tb43_phy_mask(dev, B43_PHY_EXTG(0x108), mask);\n\n\t\tb43_httab_write(dev, B43_HTTAB16(7, 0x110 + i), tmp >> 16);\n\t\tb43_httab_write(dev, B43_HTTAB8(13, 0x63 + (i * 4)),\n\t\t\t\ttmp & 0xFF);\n\t\tb43_httab_write(dev, B43_HTTAB8(13, 0x73 + (i * 4)),\n\t\t\t\ttmp & 0xFF);\n\t}\n}\n\nstatic void b43_phy_ht_tx_power_ctl(struct b43_wldev *dev, bool enable)\n{\n\tstruct b43_phy_ht *phy_ht = dev->phy.ht;\n\tu16 en_bits = B43_PHY_HT_TXPCTL_CMD_C1_COEFF |\n\t\t      B43_PHY_HT_TXPCTL_CMD_C1_HWPCTLEN |\n\t\t      B43_PHY_HT_TXPCTL_CMD_C1_PCTLEN;\n\tstatic const u16 cmd_regs[3] = { B43_PHY_HT_TXPCTL_CMD_C1,\n\t\t\t\t\t B43_PHY_HT_TXPCTL_CMD_C2,\n\t\t\t\t\t B43_PHY_HT_TXPCTL_CMD_C3 };\n\tstatic const u16 status_regs[3] = { B43_PHY_HT_TX_PCTL_STATUS_C1,\n\t\t\t\t\t    B43_PHY_HT_TX_PCTL_STATUS_C2,\n\t\t\t\t\t    B43_PHY_HT_TX_PCTL_STATUS_C3 };\n\tint i;\n\n\tif (!enable) {\n\t\tif (b43_phy_read(dev, B43_PHY_HT_TXPCTL_CMD_C1) & en_bits) {\n\t\t\t \n\t\t\tfor (i = 0; i < 3; i++)\n\t\t\t\tphy_ht->tx_pwr_idx[i] =\n\t\t\t\t\tb43_phy_read(dev, status_regs[i]);\n\t\t}\n\t\tb43_phy_mask(dev, B43_PHY_HT_TXPCTL_CMD_C1, ~en_bits);\n\t} else {\n\t\tb43_phy_set(dev, B43_PHY_HT_TXPCTL_CMD_C1, en_bits);\n\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\n\t\t\tfor (i = 0; i < 3; i++)\n\t\t\t\tb43_phy_write(dev, cmd_regs[i], 0x32);\n\t\t}\n\n\t\tfor (i = 0; i < 3; i++)\n\t\t\tif (phy_ht->tx_pwr_idx[i] <=\n\t\t\t    B43_PHY_HT_TXPCTL_CMD_C1_INIT)\n\t\t\t\tb43_phy_write(dev, cmd_regs[i],\n\t\t\t\t\t      phy_ht->tx_pwr_idx[i]);\n\t}\n\n\tphy_ht->tx_pwr_ctl = enable;\n}\n\nstatic void b43_phy_ht_tx_power_ctl_idle_tssi(struct b43_wldev *dev)\n{\n\tstruct b43_phy_ht *phy_ht = dev->phy.ht;\n\tstatic const u16 base[] = { 0x840, 0x860, 0x880 };\n\tu16 save_regs[3][3];\n\ts32 rssi_buf[6];\n\tint core;\n\n\tfor (core = 0; core < 3; core++) {\n\t\tsave_regs[core][1] = b43_phy_read(dev, base[core] + 6);\n\t\tsave_regs[core][2] = b43_phy_read(dev, base[core] + 7);\n\t\tsave_regs[core][0] = b43_phy_read(dev, base[core] + 0);\n\n\t\tb43_phy_write(dev, base[core] + 6, 0);\n\t\tb43_phy_mask(dev, base[core] + 7, ~0xF);  \n\t\tb43_phy_set(dev, base[core] + 0, 0x0400);\n\t\tb43_phy_set(dev, base[core] + 0, 0x1000);\n\t}\n\n\tb43_phy_ht_tx_tone(dev);\n\tudelay(20);\n\tb43_phy_ht_poll_rssi(dev, HT_RSSI_TSSI_2G, rssi_buf, 1);\n\tb43_phy_ht_stop_playback(dev);\n\tb43_phy_ht_reset_cca(dev);\n\n\tphy_ht->idle_tssi[0] = rssi_buf[0] & 0xff;\n\tphy_ht->idle_tssi[1] = rssi_buf[2] & 0xff;\n\tphy_ht->idle_tssi[2] = rssi_buf[4] & 0xff;\n\n\tfor (core = 0; core < 3; core++) {\n\t\tb43_phy_write(dev, base[core] + 0, save_regs[core][0]);\n\t\tb43_phy_write(dev, base[core] + 6, save_regs[core][1]);\n\t\tb43_phy_write(dev, base[core] + 7, save_regs[core][2]);\n\t}\n}\n\nstatic void b43_phy_ht_tssi_setup(struct b43_wldev *dev)\n{\n\tstatic const u16 routing[] = { R2059_C1, R2059_C2, R2059_C3, };\n\tint core;\n\n\t \n\tfor (core = 0; core < 3; core++) {\n\t\tb43_radio_set(dev, 0x8bf, 0x1);\n\t\tb43_radio_write(dev, routing[core] | 0x0159, 0x0011);\n\t}\n}\n\nstatic void b43_phy_ht_tx_power_ctl_setup(struct b43_wldev *dev)\n{\n\tstruct b43_phy_ht *phy_ht = dev->phy.ht;\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\n\tu8 *idle = phy_ht->idle_tssi;\n\tu8 target[3];\n\ts16 a1[3], b0[3], b1[3];\n\n\tu16 freq = dev->phy.chandef->chan->center_freq;\n\tint i, c;\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\tfor (c = 0; c < 3; c++) {\n\t\t\ttarget[c] = sprom->core_pwr_info[c].maxpwr_2g;\n\t\t\ta1[c] = sprom->core_pwr_info[c].pa_2g[0];\n\t\t\tb0[c] = sprom->core_pwr_info[c].pa_2g[1];\n\t\t\tb1[c] = sprom->core_pwr_info[c].pa_2g[2];\n\t\t}\n\t} else if (freq >= 4900 && freq < 5100) {\n\t\tfor (c = 0; c < 3; c++) {\n\t\t\ttarget[c] = sprom->core_pwr_info[c].maxpwr_5gl;\n\t\t\ta1[c] = sprom->core_pwr_info[c].pa_5gl[0];\n\t\t\tb0[c] = sprom->core_pwr_info[c].pa_5gl[1];\n\t\t\tb1[c] = sprom->core_pwr_info[c].pa_5gl[2];\n\t\t}\n\t} else if (freq >= 5100 && freq < 5500) {\n\t\tfor (c = 0; c < 3; c++) {\n\t\t\ttarget[c] = sprom->core_pwr_info[c].maxpwr_5g;\n\t\t\ta1[c] = sprom->core_pwr_info[c].pa_5g[0];\n\t\t\tb0[c] = sprom->core_pwr_info[c].pa_5g[1];\n\t\t\tb1[c] = sprom->core_pwr_info[c].pa_5g[2];\n\t\t}\n\t} else if (freq >= 5500) {\n\t\tfor (c = 0; c < 3; c++) {\n\t\t\ttarget[c] = sprom->core_pwr_info[c].maxpwr_5gh;\n\t\t\ta1[c] = sprom->core_pwr_info[c].pa_5gh[0];\n\t\t\tb0[c] = sprom->core_pwr_info[c].pa_5gh[1];\n\t\t\tb1[c] = sprom->core_pwr_info[c].pa_5gh[2];\n\t\t}\n\t} else {\n\t\ttarget[0] = target[1] = target[2] = 52;\n\t\ta1[0] = a1[1] = a1[2] = -424;\n\t\tb0[0] = b0[1] = b0[2] = 5612;\n\t\tb1[0] = b1[1] = b1[2] = -1393;\n\t}\n\n\tb43_phy_set(dev, B43_PHY_HT_TSSIMODE, B43_PHY_HT_TSSIMODE_EN);\n\tb43_phy_mask(dev, B43_PHY_HT_TXPCTL_CMD_C1,\n\t\t     ~B43_PHY_HT_TXPCTL_CMD_C1_PCTLEN & 0xFFFF);\n\n\t \n\tb43_phy_set(dev, B43_PHY_HT_TXPCTL_IDLE_TSSI, 0x4000);\n\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_CMD_C1,\n\t\t\t~B43_PHY_HT_TXPCTL_CMD_C1_INIT, 0x19);\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_CMD_C2,\n\t\t\t~B43_PHY_HT_TXPCTL_CMD_C2_INIT, 0x19);\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_CMD_C3,\n\t\t\t~B43_PHY_HT_TXPCTL_CMD_C3_INIT, 0x19);\n\n\tb43_phy_set(dev, B43_PHY_HT_TXPCTL_IDLE_TSSI,\n\t\t    B43_PHY_HT_TXPCTL_IDLE_TSSI_BINF);\n\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_IDLE_TSSI,\n\t\t\t~B43_PHY_HT_TXPCTL_IDLE_TSSI_C1,\n\t\t\tidle[0] << B43_PHY_HT_TXPCTL_IDLE_TSSI_C1_SHIFT);\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_IDLE_TSSI,\n\t\t\t~B43_PHY_HT_TXPCTL_IDLE_TSSI_C2,\n\t\t\tidle[1] << B43_PHY_HT_TXPCTL_IDLE_TSSI_C2_SHIFT);\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_IDLE_TSSI2,\n\t\t\t~B43_PHY_HT_TXPCTL_IDLE_TSSI2_C3,\n\t\t\tidle[2] << B43_PHY_HT_TXPCTL_IDLE_TSSI2_C3_SHIFT);\n\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_N, ~B43_PHY_HT_TXPCTL_N_TSSID,\n\t\t\t0xf0);\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_N, ~B43_PHY_HT_TXPCTL_N_NPTIL2,\n\t\t\t0x3 << B43_PHY_HT_TXPCTL_N_NPTIL2_SHIFT);\n#if 0\n\t \n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_CMD_C1, 0x800, 0)\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_CMD_C1, 0x400, 0)\n#endif\n\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_TARG_PWR,\n\t\t\t~B43_PHY_HT_TXPCTL_TARG_PWR_C1,\n\t\t\ttarget[0] << B43_PHY_HT_TXPCTL_TARG_PWR_C1_SHIFT);\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_TARG_PWR,\n\t\t\t~B43_PHY_HT_TXPCTL_TARG_PWR_C2 & 0xFFFF,\n\t\t\ttarget[1] << B43_PHY_HT_TXPCTL_TARG_PWR_C2_SHIFT);\n\tb43_phy_maskset(dev, B43_PHY_HT_TXPCTL_TARG_PWR2,\n\t\t\t~B43_PHY_HT_TXPCTL_TARG_PWR2_C3,\n\t\t\ttarget[2] << B43_PHY_HT_TXPCTL_TARG_PWR2_C3_SHIFT);\n\n\tfor (c = 0; c < 3; c++) {\n\t\ts32 num, den, pwr;\n\t\tu32 regval[64];\n\n\t\tfor (i = 0; i < 64; i++) {\n\t\t\tnum = 8 * (16 * b0[c] + b1[c] * i);\n\t\t\tden = 32768 + a1[c] * i;\n\t\t\tpwr = max((4 * num + den / 2) / den, -8);\n\t\t\tregval[i] = pwr;\n\t\t}\n\t\tb43_httab_write_bulk(dev, B43_HTTAB16(26 + c, 0), 64, regval);\n\t}\n}\n\n \n\nstatic void b43_phy_ht_spur_avoid(struct b43_wldev *dev,\n\t\t\t\t  struct ieee80211_channel *new_channel)\n{\n\tstruct bcma_device *core = dev->dev->bdev;\n\tint spuravoid = 0;\n\n\t \n\tif (new_channel->hw_value == 13 || new_channel->hw_value == 14)\n\t\tspuravoid = 1;\n\tbcma_core_pll_ctl(core, B43_BCMA_CLKCTLST_PHY_PLL_REQ, 0, false);\n\tbcma_pmu_spuravoid_pllupdate(&core->bus->drv_cc, spuravoid);\n\tbcma_core_pll_ctl(core,\n\t\t\t  B43_BCMA_CLKCTLST_80211_PLL_REQ |\n\t\t\t  B43_BCMA_CLKCTLST_PHY_PLL_REQ,\n\t\t\t  B43_BCMA_CLKCTLST_80211_PLL_ST |\n\t\t\t  B43_BCMA_CLKCTLST_PHY_PLL_ST, false);\n\n\tb43_mac_switch_freq(dev, spuravoid);\n\n\tb43_wireless_core_phy_pll_reset(dev);\n\n\tif (spuravoid)\n\t\tb43_phy_set(dev, B43_PHY_HT_BBCFG, B43_PHY_HT_BBCFG_RSTRX);\n\telse\n\t\tb43_phy_mask(dev, B43_PHY_HT_BBCFG,\n\t\t\t\t~B43_PHY_HT_BBCFG_RSTRX & 0xFFFF);\n\n\tb43_phy_ht_reset_cca(dev);\n}\n\nstatic void b43_phy_ht_channel_setup(struct b43_wldev *dev,\n\t\t\t\tconst struct b43_phy_ht_channeltab_e_phy *e,\n\t\t\t\tstruct ieee80211_channel *new_channel)\n{\n\tif (new_channel->band == NL80211_BAND_5GHZ) {\n\t\t \n\t\tb43_phy_mask(dev, B43_PHY_HT_BANDCTL, ~B43_PHY_HT_BANDCTL_5GHZ);\n\n\t\tb43_phy_ht_bphy_reset(dev, true);\n\n\t\t \n\t\tb43_phy_set(dev, B43_PHY_HT_BANDCTL, B43_PHY_HT_BANDCTL_5GHZ);\n\t} else {\n\t\t \n\t\tb43_phy_mask(dev, B43_PHY_HT_BANDCTL, ~B43_PHY_HT_BANDCTL_5GHZ);\n\n\t\tb43_phy_ht_bphy_reset(dev, false);\n\t}\n\n\tb43_phy_write(dev, B43_PHY_HT_BW1, e->bw1);\n\tb43_phy_write(dev, B43_PHY_HT_BW2, e->bw2);\n\tb43_phy_write(dev, B43_PHY_HT_BW3, e->bw3);\n\tb43_phy_write(dev, B43_PHY_HT_BW4, e->bw4);\n\tb43_phy_write(dev, B43_PHY_HT_BW5, e->bw5);\n\tb43_phy_write(dev, B43_PHY_HT_BW6, e->bw6);\n\n\tif (new_channel->hw_value == 14) {\n\t\tb43_phy_ht_classifier(dev, B43_PHY_HT_CLASS_CTL_OFDM_EN, 0);\n\t\tb43_phy_set(dev, B43_PHY_HT_TEST, 0x0800);\n\t} else {\n\t\tb43_phy_ht_classifier(dev, B43_PHY_HT_CLASS_CTL_OFDM_EN,\n\t\t\t\t      B43_PHY_HT_CLASS_CTL_OFDM_EN);\n\t\tif (new_channel->band == NL80211_BAND_2GHZ)\n\t\t\tb43_phy_mask(dev, B43_PHY_HT_TEST, ~0x840);\n\t}\n\n\tif (1)  \n\t\tb43_phy_ht_tx_power_fix(dev);\n\n\tb43_phy_ht_spur_avoid(dev, new_channel);\n\n\tb43_phy_write(dev, 0x017e, 0x3830);\n}\n\nstatic int b43_phy_ht_set_channel(struct b43_wldev *dev,\n\t\t\t\t  struct ieee80211_channel *channel,\n\t\t\t\t  enum nl80211_channel_type channel_type)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tconst struct b43_phy_ht_channeltab_e_radio2059 *chent_r2059 = NULL;\n\n\tif (phy->radio_ver == 0x2059) {\n\t\tchent_r2059 = b43_phy_ht_get_channeltab_e_r2059(dev,\n\t\t\t\t\t\t\tchannel->center_freq);\n\t\tif (!chent_r2059)\n\t\t\treturn -ESRCH;\n\t} else {\n\t\treturn -ESRCH;\n\t}\n\n\t \n\n\tif (phy->radio_ver == 0x2059) {\n\t\tb43_radio_2059_channel_setup(dev, chent_r2059);\n\t\tb43_phy_ht_channel_setup(dev, &(chent_r2059->phy_regs),\n\t\t\t\t\t channel);\n\t} else {\n\t\treturn -ESRCH;\n\t}\n\n\treturn 0;\n}\n\n \n\nstatic int b43_phy_ht_op_allocate(struct b43_wldev *dev)\n{\n\tstruct b43_phy_ht *phy_ht;\n\n\tphy_ht = kzalloc(sizeof(*phy_ht), GFP_KERNEL);\n\tif (!phy_ht)\n\t\treturn -ENOMEM;\n\tdev->phy.ht = phy_ht;\n\n\treturn 0;\n}\n\nstatic void b43_phy_ht_op_prepare_structs(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_ht *phy_ht = phy->ht;\n\tint i;\n\n\tmemset(phy_ht, 0, sizeof(*phy_ht));\n\n\tphy_ht->tx_pwr_ctl = true;\n\tfor (i = 0; i < 3; i++)\n\t\tphy_ht->tx_pwr_idx[i] = B43_PHY_HT_TXPCTL_CMD_C1_INIT + 1;\n\n\tfor (i = 0; i < 3; i++)\n\t\tphy_ht->bb_mult_save[i] = -1;\n}\n\nstatic int b43_phy_ht_op_init(struct b43_wldev *dev)\n{\n\tstruct b43_phy_ht *phy_ht = dev->phy.ht;\n\tu16 tmp;\n\tu16 clip_state[3];\n\tbool saved_tx_pwr_ctl;\n\n\tif (dev->dev->bus_type != B43_BUS_BCMA) {\n\t\tb43err(dev->wl, \"HT-PHY is supported only on BCMA bus!\\n\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tb43_phy_ht_tables_init(dev);\n\n\tb43_phy_mask(dev, 0x0be, ~0x2);\n\tb43_phy_set(dev, 0x23f, 0x7ff);\n\tb43_phy_set(dev, 0x240, 0x7ff);\n\tb43_phy_set(dev, 0x241, 0x7ff);\n\n\tb43_phy_ht_zero_extg(dev);\n\n\tb43_phy_mask(dev, B43_PHY_EXTG(0), ~0x3);\n\n\tb43_phy_write(dev, B43_PHY_HT_AFE_C1_OVER, 0);\n\tb43_phy_write(dev, B43_PHY_HT_AFE_C2_OVER, 0);\n\tb43_phy_write(dev, B43_PHY_HT_AFE_C3_OVER, 0);\n\n\tb43_phy_write(dev, B43_PHY_EXTG(0x103), 0x20);\n\tb43_phy_write(dev, B43_PHY_EXTG(0x101), 0x20);\n\tb43_phy_write(dev, 0x20d, 0xb8);\n\tb43_phy_write(dev, B43_PHY_EXTG(0x14f), 0xc8);\n\tb43_phy_write(dev, 0x70, 0x50);\n\tb43_phy_write(dev, 0x1ff, 0x30);\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\n\t\tb43_phy_ht_classifier(dev, B43_PHY_HT_CLASS_CTL_CCK_EN, 0);\n\telse\n\t\tb43_phy_ht_classifier(dev, B43_PHY_HT_CLASS_CTL_CCK_EN,\n\t\t\t\t      B43_PHY_HT_CLASS_CTL_CCK_EN);\n\n\tb43_phy_set(dev, 0xb1, 0x91);\n\tb43_phy_write(dev, 0x32f, 0x0003);\n\tb43_phy_write(dev, 0x077, 0x0010);\n\tb43_phy_write(dev, 0x0b4, 0x0258);\n\tb43_phy_mask(dev, 0x17e, ~0x4000);\n\n\tb43_phy_write(dev, 0x0b9, 0x0072);\n\n\tb43_httab_write_few(dev, B43_HTTAB16(7, 0x14e), 2, 0x010f, 0x010f);\n\tb43_httab_write_few(dev, B43_HTTAB16(7, 0x15e), 2, 0x010f, 0x010f);\n\tb43_httab_write_few(dev, B43_HTTAB16(7, 0x16e), 2, 0x010f, 0x010f);\n\n\tb43_phy_ht_afe_unk1(dev);\n\n\tb43_httab_write_few(dev, B43_HTTAB16(7, 0x130), 9, 0x777, 0x111, 0x111,\n\t\t\t    0x777, 0x111, 0x111, 0x777, 0x111, 0x111);\n\n\tb43_httab_write(dev, B43_HTTAB16(7, 0x120), 0x0777);\n\tb43_httab_write(dev, B43_HTTAB16(7, 0x124), 0x0777);\n\n\tb43_httab_write(dev, B43_HTTAB16(8, 0x00), 0x02);\n\tb43_httab_write(dev, B43_HTTAB16(8, 0x10), 0x02);\n\tb43_httab_write(dev, B43_HTTAB16(8, 0x20), 0x02);\n\n\tb43_httab_write_few(dev, B43_HTTAB16(8, 0x08), 4,\n\t\t\t    0x8e, 0x96, 0x96, 0x96);\n\tb43_httab_write_few(dev, B43_HTTAB16(8, 0x18), 4,\n\t\t\t    0x8f, 0x9f, 0x9f, 0x9f);\n\tb43_httab_write_few(dev, B43_HTTAB16(8, 0x28), 4,\n\t\t\t    0x8f, 0x9f, 0x9f, 0x9f);\n\n\tb43_httab_write_few(dev, B43_HTTAB16(8, 0x0c), 4, 0x2, 0x2, 0x2, 0x2);\n\tb43_httab_write_few(dev, B43_HTTAB16(8, 0x1c), 4, 0x2, 0x2, 0x2, 0x2);\n\tb43_httab_write_few(dev, B43_HTTAB16(8, 0x2c), 4, 0x2, 0x2, 0x2, 0x2);\n\n\tb43_phy_maskset(dev, 0x0280, 0xff00, 0x3e);\n\tb43_phy_maskset(dev, 0x0283, 0xff00, 0x3e);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x0141), 0xff00, 0x46);\n\tb43_phy_maskset(dev, 0x0283, 0xff00, 0x40);\n\n\tb43_httab_write_few(dev, B43_HTTAB16(00, 0x8), 4,\n\t\t\t    0x09, 0x0e, 0x13, 0x18);\n\tb43_httab_write_few(dev, B43_HTTAB16(01, 0x8), 4,\n\t\t\t    0x09, 0x0e, 0x13, 0x18);\n\t \n\tb43_httab_write_few(dev, B43_HTTAB16(40, 0x8), 4,\n\t\t\t    0x09, 0x0e, 0x13, 0x18);\n\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x24), 0x3f, 0xd);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x64), 0x3f, 0xd);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0xa4), 0x3f, 0xd);\n\n\tb43_phy_set(dev, B43_PHY_EXTG(0x060), 0x1);\n\tb43_phy_set(dev, B43_PHY_EXTG(0x064), 0x1);\n\tb43_phy_set(dev, B43_PHY_EXTG(0x080), 0x1);\n\tb43_phy_set(dev, B43_PHY_EXTG(0x084), 0x1);\n\n\t \n\ttmp = b43_httab_read(dev, B43_HTTAB16(7, 0x144));\n\tb43_httab_write(dev, B43_HTTAB16(7, 0x14a), tmp);\n\ttmp = b43_httab_read(dev, B43_HTTAB16(7, 0x154));\n\tb43_httab_write(dev, B43_HTTAB16(7, 0x15a), tmp);\n\ttmp = b43_httab_read(dev, B43_HTTAB16(7, 0x164));\n\tb43_httab_write(dev, B43_HTTAB16(7, 0x16a), tmp);\n\n\t \n\tb43_phy_force_clock(dev, true);\n\ttmp = b43_phy_read(dev, B43_PHY_HT_BBCFG);\n\tb43_phy_write(dev, B43_PHY_HT_BBCFG, tmp | B43_PHY_HT_BBCFG_RSTCCA);\n\tb43_phy_write(dev, B43_PHY_HT_BBCFG, tmp & ~B43_PHY_HT_BBCFG_RSTCCA);\n\tb43_phy_force_clock(dev, false);\n\n\tb43_mac_phy_clock_set(dev, true);\n\n\tb43_phy_ht_pa_override(dev, false);\n\tb43_phy_ht_force_rf_sequence(dev, B43_PHY_HT_RF_SEQ_TRIG_RX2TX);\n\tb43_phy_ht_force_rf_sequence(dev, B43_PHY_HT_RF_SEQ_TRIG_RST2RX);\n\tb43_phy_ht_pa_override(dev, true);\n\n\t \n\tb43_phy_ht_classifier(dev, 0, 0);\n\tb43_phy_ht_read_clip_detection(dev, clip_state);\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\tb43_phy_ht_bphy_init(dev);\n\n\tb43_httab_write_bulk(dev, B43_HTTAB32(0x1a, 0xc0),\n\t\t\tB43_HTTAB_1A_C0_LATE_SIZE, b43_httab_0x1a_0xc0_late);\n\n\tsaved_tx_pwr_ctl = phy_ht->tx_pwr_ctl;\n\tb43_phy_ht_tx_power_fix(dev);\n\tb43_phy_ht_tx_power_ctl(dev, false);\n\tb43_phy_ht_tx_power_ctl_idle_tssi(dev);\n\tb43_phy_ht_tx_power_ctl_setup(dev);\n\tb43_phy_ht_tssi_setup(dev);\n\tb43_phy_ht_tx_power_ctl(dev, saved_tx_pwr_ctl);\n\n\treturn 0;\n}\n\nstatic void b43_phy_ht_op_free(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_ht *phy_ht = phy->ht;\n\n\tkfree(phy_ht);\n\tphy->ht = NULL;\n}\n\n \n\nstatic void b43_phy_ht_op_maskset(struct b43_wldev *dev, u16 reg, u16 mask,\n\t\t\t\t u16 set)\n{\n\tb43_write16f(dev, B43_MMIO_PHY_CONTROL, reg);\n\tb43_write16(dev, B43_MMIO_PHY_DATA,\n\t\t    (b43_read16(dev, B43_MMIO_PHY_DATA) & mask) | set);\n}\n\nstatic u16 b43_phy_ht_op_radio_read(struct b43_wldev *dev, u16 reg)\n{\n\t \n\treg |= 0x200;\n\n\tb43_write16f(dev, B43_MMIO_RADIO24_CONTROL, reg);\n\treturn b43_read16(dev, B43_MMIO_RADIO24_DATA);\n}\n\nstatic void b43_phy_ht_op_radio_write(struct b43_wldev *dev, u16 reg,\n\t\t\t\t      u16 value)\n{\n\tb43_write16f(dev, B43_MMIO_RADIO24_CONTROL, reg);\n\tb43_write16(dev, B43_MMIO_RADIO24_DATA, value);\n}\n\nstatic enum b43_txpwr_result\nb43_phy_ht_op_recalc_txpower(struct b43_wldev *dev, bool ignore_tssi)\n{\n\treturn B43_TXPWR_RES_DONE;\n}\n\nstatic void b43_phy_ht_op_adjust_txpower(struct b43_wldev *dev)\n{\n}\n\n \n\nconst struct b43_phy_operations b43_phyops_ht = {\n\t.allocate\t\t= b43_phy_ht_op_allocate,\n\t.free\t\t\t= b43_phy_ht_op_free,\n\t.prepare_structs\t= b43_phy_ht_op_prepare_structs,\n\t.init\t\t\t= b43_phy_ht_op_init,\n\t.phy_maskset\t\t= b43_phy_ht_op_maskset,\n\t.radio_read\t\t= b43_phy_ht_op_radio_read,\n\t.radio_write\t\t= b43_phy_ht_op_radio_write,\n\t.software_rfkill\t= b43_phy_ht_op_software_rfkill,\n\t.switch_analog\t\t= b43_phy_ht_op_switch_analog,\n\t.switch_channel\t\t= b43_phy_ht_op_switch_channel,\n\t.get_default_chan\t= b43_phy_ht_op_get_default_chan,\n\t.recalc_txpower\t\t= b43_phy_ht_op_recalc_txpower,\n\t.adjust_txpower\t\t= b43_phy_ht_op_adjust_txpower,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}