{
  "module_name": "wa.c",
  "hash_id": "f9b08bf93ca5fe449a0dc396ab5531bd60a86712b480c8a77d29fa825b8fffb3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/b43/wa.c",
  "human_readable_source": "\n \n\n#include \"b43.h\"\n#include \"main.h\"\n#include \"tables.h\"\n#include \"phy_common.h\"\n#include \"wa.h\"\n\nvoid b43_wa_initgains(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tb43_phy_write(dev, B43_PHY_LNAHPFCTL, 0x1FF9);\n\tb43_phy_mask(dev, B43_PHY_LPFGAINCTL, 0xFF0F);\n\tif (phy->rev <= 2)\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_LPFGAIN, 0, 0x1FBF);\n\tb43_radio_write16(dev, 0x0002, 0x1FBF);\n\n\tb43_phy_write(dev, 0x0024, 0x4680);\n\tb43_phy_write(dev, 0x0020, 0x0003);\n\tb43_phy_write(dev, 0x001D, 0x0F40);\n\tb43_phy_write(dev, 0x001F, 0x1C00);\n\tif (phy->rev <= 3)\n\t\tb43_phy_maskset(dev, 0x002A, 0x00FF, 0x0400);\n\telse if (phy->rev == 5) {\n\t\tb43_phy_maskset(dev, 0x002A, 0x00FF, 0x1A00);\n\t\tb43_phy_write(dev, 0x00CC, 0x2121);\n\t}\n\tif (phy->rev >= 3)\n\t\tb43_phy_write(dev, 0x00BA, 0x3ED5);\n}\n\nstatic void b43_wa_rssi_lt(struct b43_wldev *dev)  \n{\n\tint i;\n\n\tif (0  ) {\n\t\tfor (i = 0; i < 8; i++)\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_RSSI, i, i + 8);\n\t\tfor (i = 8; i < 16; i++)\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_RSSI, i, i - 8);\n\t} else {\n\t\tfor (i = 0; i < 64; i++)\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_RSSI, i, i);\n\t}\n}\n\nstatic void b43_wa_analog(struct b43_wldev *dev)\n{\n\tu16 ofdmrev;\n\n\tofdmrev = b43_phy_read(dev, B43_PHY_VERSION_OFDM) & B43_PHYVER_VERSION;\n\tif (ofdmrev > 2) {\n\t\tb43_phy_write(dev, B43_PHY_PWRDOWN, 0x1000);\n\t} else {\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_DAC, 3, 0x1044);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_DAC, 4, 0x7201);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_DAC, 6, 0x0040);\n\t}\n}\n\nstatic void b43_wa_fft(struct b43_wldev *dev)  \n{\n\tint i;\n\n\tfor (i = 0; i < B43_TAB_FINEFREQG_SIZE; i++)\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_DACRFPABB, i,\n\t\t\t\t    b43_tab_finefreqg[i]);\n}\n\nstatic void b43_wa_nft(struct b43_wldev *dev)  \n{\n\tstruct b43_phy *phy = &dev->phy;\n\tint i;\n\n\tif (phy->rev == 1)\n\t\tfor (i = 0; i < B43_TAB_NOISEG1_SIZE; i++)\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC2, i,\n\t\t\t\t\t    b43_tab_noiseg1[i]);\n\telse\n\t\tfor (i = 0; i < B43_TAB_NOISEG2_SIZE; i++)\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC2, i,\n\t\t\t\t\t    b43_tab_noiseg2[i]);\n}\n\nstatic void b43_wa_rt(struct b43_wldev *dev)  \n{\n\tint i;\n\n\tfor (i = 0; i < B43_TAB_ROTOR_SIZE; i++)\n\t\tb43_ofdmtab_write32(dev, B43_OFDMTAB_ROTOR, i, b43_tab_rotor[i]);\n}\n\nstatic void b43_write_nst(struct b43_wldev *dev, const u16 *nst)\n{\n\tint i;\n\n\tfor (i = 0; i < B43_TAB_NOISESCALE_SIZE; i++)\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_NOISESCALE, i, nst[i]);\n}\n\nstatic void b43_wa_nst(struct b43_wldev *dev)  \n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tif (phy->rev >= 6) {\n\t\tif (b43_phy_read(dev, B43_PHY_ENCORE) & B43_PHY_ENCORE_EN)\n\t\t\tb43_write_nst(dev, b43_tab_noisescaleg3);\n\t\telse\n\t\t\tb43_write_nst(dev, b43_tab_noisescaleg2);\n\t} else {\n\t\tb43_write_nst(dev, b43_tab_noisescaleg1);\n\t}\n}\n\nstatic void b43_wa_art(struct b43_wldev *dev)  \n{\n\tint i;\n\n\tfor (i = 0; i < B43_TAB_RETARD_SIZE; i++)\n\t\t\tb43_ofdmtab_write32(dev, B43_OFDMTAB_ADVRETARD,\n\t\t\t\ti, b43_tab_retard[i]);\n}\n\nstatic void b43_wa_msst(struct b43_wldev *dev)  \n{\n\tstruct b43_phy *phy = &dev->phy;\n\tint i;\n\tconst u16 *tab;\n\n\tif (phy->type == B43_PHYTYPE_G) {\n\t\ttab = b43_tab_sigmasqr2;\n\t} else {\n\t\tB43_WARN_ON(1);\n\t\treturn;\n\t}\n\n\tfor (i = 0; i < B43_TAB_SIGMASQR_SIZE; i++) {\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_MINSIGSQ,\n\t\t\t\t\ti, tab[i]);\n\t}\n}\n\nstatic void b43_wa_crs_ed(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tif (phy->rev == 1) {\n\t\tb43_phy_write(dev, B43_PHY_CRSTHRES1_R1, 0x4F19);\n\t} else if (phy->rev == 2) {\n\t\tb43_phy_write(dev, B43_PHY_CRSTHRES1, 0x1861);\n\t\tb43_phy_write(dev, B43_PHY_CRSTHRES2, 0x0271);\n\t\tb43_phy_set(dev, B43_PHY_ANTDWELL, 0x0800);\n\t} else {\n\t\tb43_phy_write(dev, B43_PHY_CRSTHRES1, 0x0098);\n\t\tb43_phy_write(dev, B43_PHY_CRSTHRES2, 0x0070);\n\t\tb43_phy_write(dev, B43_PHY_OFDM(0xC9), 0x0080);\n\t\tb43_phy_set(dev, B43_PHY_ANTDWELL, 0x0800);\n\t}\n}\n\nstatic void b43_wa_crs_thr(struct b43_wldev *dev)\n{\n\tb43_phy_maskset(dev, B43_PHY_CRS0, ~0x03C0, 0xD000);\n}\n\nstatic void b43_wa_crs_blank(struct b43_wldev *dev)\n{\n\tb43_phy_write(dev, B43_PHY_OFDM(0x2C), 0x005A);\n}\n\nstatic void b43_wa_cck_shiftbits(struct b43_wldev *dev)\n{\n\tb43_phy_write(dev, B43_PHY_CCKSHIFTBITS, 0x0026);\n}\n\nstatic void b43_wa_wrssi_offset(struct b43_wldev *dev)\n{\n\tint i;\n\n\tif (dev->phy.rev == 1) {\n\t\tfor (i = 0; i < 16; i++) {\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_WRSSI_R1,\n\t\t\t\t\t\ti, 0x0020);\n\t\t}\n\t} else {\n\t\tfor (i = 0; i < 32; i++) {\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_WRSSI,\n\t\t\t\t\t\ti, 0x0820);\n\t\t}\n\t}\n}\n\nstatic void b43_wa_txpuoff_rxpuon(struct b43_wldev *dev)\n{\n\tb43_ofdmtab_write16(dev, B43_OFDMTAB_UNKNOWN_0F, 2, 15);\n\tb43_ofdmtab_write16(dev, B43_OFDMTAB_UNKNOWN_0F, 3, 20);\n}\n\nstatic void b43_wa_altagc(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tif (phy->rev == 1) {\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1_R1, 0, 254);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1_R1, 1, 13);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1_R1, 2, 19);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1_R1, 3, 25);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC2, 0, 0x2710);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC2, 1, 0x9B83);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC2, 2, 0x9B83);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC2, 3, 0x0F8D);\n\t\tb43_phy_write(dev, B43_PHY_LMS, 4);\n\t} else {\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1, 0, 254);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1, 1, 13);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1, 2, 19);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC1, 3, 25);\n\t}\n\n\tb43_phy_maskset(dev, B43_PHY_CCKSHIFTBITS_WA, 0x00FF, 0x5700);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x1A), ~0x007F, 0x000F);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x1A), ~0x3F80, 0x2B80);\n\tb43_phy_maskset(dev, B43_PHY_ANTWRSETT, 0xF0FF, 0x0300);\n\tb43_radio_set(dev, 0x7A, 0x0008);\n\tb43_phy_maskset(dev, B43_PHY_N1P1GAIN, ~0x000F, 0x0008);\n\tb43_phy_maskset(dev, B43_PHY_P1P2GAIN, ~0x0F00, 0x0600);\n\tb43_phy_maskset(dev, B43_PHY_N1N2GAIN, ~0x0F00, 0x0700);\n\tb43_phy_maskset(dev, B43_PHY_N1P1GAIN, ~0x0F00, 0x0100);\n\tif (phy->rev == 1) {\n\t\tb43_phy_maskset(dev, B43_PHY_N1N2GAIN, ~0x000F, 0x0007);\n\t}\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x88), ~0x00FF, 0x001C);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x88), ~0x3F00, 0x0200);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x96), ~0x00FF, 0x001C);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x89), ~0x00FF, 0x0020);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x89), ~0x3F00, 0x0200);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x82), ~0x00FF, 0x002E);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x96), 0x00FF, 0x1A00);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x81), ~0x00FF, 0x0028);\n\tb43_phy_maskset(dev, B43_PHY_OFDM(0x81), 0x00FF, 0x2C00);\n\tif (phy->rev == 1) {\n\t\tb43_phy_write(dev, B43_PHY_PEAK_COUNT, 0x092B);\n\t\tb43_phy_maskset(dev, B43_PHY_OFDM(0x1B), ~0x001E, 0x0002);\n\t} else {\n\t\tb43_phy_mask(dev, B43_PHY_OFDM(0x1B), ~0x001E);\n\t\tb43_phy_write(dev, B43_PHY_OFDM(0x1F), 0x287A);\n\t\tb43_phy_maskset(dev, B43_PHY_LPFGAINCTL, ~0x000F, 0x0004);\n\t\tif (phy->rev >= 6) {\n\t\t\tb43_phy_write(dev, B43_PHY_OFDM(0x22), 0x287A);\n\t\t\tb43_phy_maskset(dev, B43_PHY_LPFGAINCTL, 0x0FFF, 0x3000);\n\t\t}\n\t}\n\tb43_phy_maskset(dev, B43_PHY_DIVSRCHIDX, 0x8080, 0x7874);\n\tb43_phy_write(dev, B43_PHY_OFDM(0x8E), 0x1C00);\n\tif (phy->rev == 1) {\n\t\tb43_phy_maskset(dev, B43_PHY_DIVP1P2GAIN, ~0x0F00, 0x0600);\n\t\tb43_phy_write(dev, B43_PHY_OFDM(0x8B), 0x005E);\n\t\tb43_phy_maskset(dev, B43_PHY_ANTWRSETT, ~0x00FF, 0x001E);\n\t\tb43_phy_write(dev, B43_PHY_OFDM(0x8D), 0x0002);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC3_R1, 0, 0);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC3_R1, 1, 7);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC3_R1, 2, 16);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC3_R1, 3, 28);\n\t} else {\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC3, 0, 0);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC3, 1, 7);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC3, 2, 16);\n\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_AGC3, 3, 28);\n\t}\n\tif (phy->rev >= 6) {\n\t\tb43_phy_mask(dev, B43_PHY_OFDM(0x26), ~0x0003);\n\t\tb43_phy_mask(dev, B43_PHY_OFDM(0x26), ~0x1000);\n\t}\n\tb43_phy_read(dev, B43_PHY_VERSION_OFDM);  \n}\n\nstatic void b43_wa_tr_ltov(struct b43_wldev *dev)  \n{\n\tb43_gtab_write(dev, B43_GTAB_ORIGTR, 0, 0x7654);\n}\n\nstatic void b43_wa_cpll_nonpilot(struct b43_wldev *dev)\n{\n\tb43_ofdmtab_write16(dev, B43_OFDMTAB_UNKNOWN_11, 0, 0);\n\tb43_ofdmtab_write16(dev, B43_OFDMTAB_UNKNOWN_11, 1, 0);\n}\n\nstatic void b43_wa_boards_g(struct b43_wldev *dev)\n{\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\tstruct b43_phy *phy = &dev->phy;\n\n\tif (dev->dev->board_vendor != SSB_BOARDVENDOR_BCM ||\n\t    dev->dev->board_type != SSB_BOARD_BU4306 ||\n\t    dev->dev->board_rev != 0x17) {\n\t\tif (phy->rev < 2) {\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_GAINX_R1, 1, 0x0002);\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_GAINX_R1, 2, 0x0001);\n\t\t} else {\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_GAINX, 1, 0x0002);\n\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_GAINX, 2, 0x0001);\n\t\t\tif ((sprom->boardflags_lo & B43_BFL_EXTLNA) &&\n\t\t\t    (phy->rev >= 7)) {\n\t\t\t\tb43_phy_mask(dev, B43_PHY_EXTG(0x11), 0xF7FF);\n\t\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_GAINX, 0x0020, 0x0001);\n\t\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_GAINX, 0x0021, 0x0001);\n\t\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_GAINX, 0x0022, 0x0001);\n\t\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_GAINX, 0x0023, 0x0000);\n\t\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_GAINX, 0x0000, 0x0000);\n\t\t\t\tb43_ofdmtab_write16(dev, B43_OFDMTAB_GAINX, 0x0003, 0x0002);\n\t\t\t}\n\t\t}\n\t}\n\tif (sprom->boardflags_lo & B43_BFL_FEM) {\n\t\tb43_phy_write(dev, B43_PHY_GTABCTL, 0x3120);\n\t\tb43_phy_write(dev, B43_PHY_GTABDATA, 0xC480);\n\t}\n}\n\nvoid b43_wa_all(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tif (phy->type == B43_PHYTYPE_G) {\n\t\tswitch (phy->rev) {\n\t\tcase 1:\n\t\t\tb43_wa_crs_ed(dev);\n\t\t\tb43_wa_crs_thr(dev);\n\t\t\tb43_wa_crs_blank(dev);\n\t\t\tb43_wa_cck_shiftbits(dev);\n\t\t\tb43_wa_fft(dev);\n\t\t\tb43_wa_nft(dev);\n\t\t\tb43_wa_rt(dev);\n\t\t\tb43_wa_nst(dev);\n\t\t\tb43_wa_art(dev);\n\t\t\tb43_wa_wrssi_offset(dev);\n\t\t\tb43_wa_altagc(dev);\n\t\t\tbreak;\n\t\tcase 2:\n\t\tcase 6:\n\t\tcase 7:\n\t\tcase 8:\n\t\tcase 9:\n\t\t\tb43_wa_tr_ltov(dev);\n\t\t\tb43_wa_crs_ed(dev);\n\t\t\tb43_wa_rssi_lt(dev);\n\t\t\tb43_wa_nft(dev);\n\t\t\tb43_wa_nst(dev);\n\t\t\tb43_wa_msst(dev);\n\t\t\tb43_wa_wrssi_offset(dev);\n\t\t\tb43_wa_altagc(dev);\n\t\t\tb43_wa_analog(dev);\n\t\t\tb43_wa_txpuoff_rxpuon(dev);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tB43_WARN_ON(1);\n\t\t}\n\t\tb43_wa_boards_g(dev);\n\t} else {  \n\t\tB43_WARN_ON(1);\n\t}\n\n\tb43_wa_cpll_nonpilot(dev);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}