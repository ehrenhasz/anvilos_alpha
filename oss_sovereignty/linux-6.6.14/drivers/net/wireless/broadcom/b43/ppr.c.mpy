{
  "module_name": "ppr.c",
  "hash_id": "916f4f6a66de9ee75074c8e9a758c89bb98e0657ed1c6fec8ba6ca2a0572bb12",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/b43/ppr.c",
  "human_readable_source": "\n \n\n#include \"ppr.h\"\n#include \"b43.h\"\n\n#define ppr_for_each_entry(ppr, i, entry)\t\t\t\t\\\n\tfor (i = 0, entry = &(ppr)->__all_rates[i];\t\t\t\\\n\t     i < B43_PPR_RATES_NUM;\t\t\t\t\t\\\n\t     i++, entry++)\n\nvoid b43_ppr_clear(struct b43_wldev *dev, struct b43_ppr *ppr)\n{\n\tmemset(ppr, 0, sizeof(*ppr));\n\n\t \n\tBUILD_BUG_ON(sizeof(struct b43_ppr) != B43_PPR_RATES_NUM * sizeof(u8));\n}\n\nvoid b43_ppr_add(struct b43_wldev *dev, struct b43_ppr *ppr, int diff)\n{\n\tint i;\n\tu8 *rate;\n\n\tppr_for_each_entry(ppr, i, rate) {\n\t\t*rate = clamp_val(*rate + diff, 0, 127);\n\t}\n}\n\nvoid b43_ppr_apply_max(struct b43_wldev *dev, struct b43_ppr *ppr, u8 max)\n{\n\tint i;\n\tu8 *rate;\n\n\tppr_for_each_entry(ppr, i, rate) {\n\t\t*rate = min(*rate, max);\n\t}\n}\n\nvoid b43_ppr_apply_min(struct b43_wldev *dev, struct b43_ppr *ppr, u8 min)\n{\n\tint i;\n\tu8 *rate;\n\n\tppr_for_each_entry(ppr, i, rate) {\n\t\t*rate = max(*rate, min);\n\t}\n}\n\nu8 b43_ppr_get_max(struct b43_wldev *dev, struct b43_ppr *ppr)\n{\n\tu8 res = 0;\n\tint i;\n\tu8 *rate;\n\n\tppr_for_each_entry(ppr, i, rate) {\n\t\tres = max(*rate, res);\n\t}\n\n\treturn res;\n}\n\nbool b43_ppr_load_max_from_sprom(struct b43_wldev *dev, struct b43_ppr *ppr,\n\t\t\t\t enum b43_band band)\n{\n\tstruct b43_ppr_rates *rates = &ppr->rates;\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\tstruct b43_phy *phy = &dev->phy;\n\tu8 maxpwr, off;\n\tu32 sprom_ofdm_po;\n\tu16 *sprom_mcs_po;\n\tu8 extra_cdd_po, extra_stbc_po;\n\tint i;\n\n\tswitch (band) {\n\tcase B43_BAND_2G:\n\t\tmaxpwr = min(sprom->core_pwr_info[0].maxpwr_2g,\n\t\t\t     sprom->core_pwr_info[1].maxpwr_2g);\n\t\tsprom_ofdm_po = sprom->ofdm2gpo;\n\t\tsprom_mcs_po = sprom->mcs2gpo;\n\t\textra_cdd_po = (sprom->cddpo >> 0) & 0xf;\n\t\textra_stbc_po = (sprom->stbcpo >> 0) & 0xf;\n\t\tbreak;\n\tcase B43_BAND_5G_LO:\n\t\tmaxpwr = min(sprom->core_pwr_info[0].maxpwr_5gl,\n\t\t\t     sprom->core_pwr_info[1].maxpwr_5gl);\n\t\tsprom_ofdm_po = sprom->ofdm5glpo;\n\t\tsprom_mcs_po = sprom->mcs5glpo;\n\t\textra_cdd_po = (sprom->cddpo >> 8) & 0xf;\n\t\textra_stbc_po = (sprom->stbcpo >> 8) & 0xf;\n\t\tbreak;\n\tcase B43_BAND_5G_MI:\n\t\tmaxpwr = min(sprom->core_pwr_info[0].maxpwr_5g,\n\t\t\t     sprom->core_pwr_info[1].maxpwr_5g);\n\t\tsprom_ofdm_po = sprom->ofdm5gpo;\n\t\tsprom_mcs_po = sprom->mcs5gpo;\n\t\textra_cdd_po = (sprom->cddpo >> 4) & 0xf;\n\t\textra_stbc_po = (sprom->stbcpo >> 4) & 0xf;\n\t\tbreak;\n\tcase B43_BAND_5G_HI:\n\t\tmaxpwr = min(sprom->core_pwr_info[0].maxpwr_5gh,\n\t\t\t     sprom->core_pwr_info[1].maxpwr_5gh);\n\t\tsprom_ofdm_po = sprom->ofdm5ghpo;\n\t\tsprom_mcs_po = sprom->mcs5ghpo;\n\t\textra_cdd_po = (sprom->cddpo >> 12) & 0xf;\n\t\textra_stbc_po = (sprom->stbcpo >> 12) & 0xf;\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON_ONCE(1);\n\t\treturn false;\n\t}\n\n\tif (band == B43_BAND_2G) {\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\toff = ((sprom->cck2gpo >> (i * 4)) & 0xf) * 2;\n\t\t\trates->cck[i] = maxpwr - off;\n\t\t}\n\t}\n\n\t \n\tfor (i = 0; i < 8; i++) {\n\t\toff = ((sprom_ofdm_po >> (i * 4)) & 0xf) * 2;\n\t\trates->ofdm[i] = maxpwr - off;\n\t}\n\n\t \n\trates->mcs_20[0] = rates->ofdm[0];\n\trates->mcs_20[1] = rates->ofdm[2];\n\trates->mcs_20[2] = rates->ofdm[3];\n\trates->mcs_20[3] = rates->ofdm[4];\n\trates->mcs_20[4] = rates->ofdm[5];\n\trates->mcs_20[5] = rates->ofdm[6];\n\trates->mcs_20[6] = rates->ofdm[7];\n\trates->mcs_20[7] = rates->ofdm[7];\n\n\t \n\tfor (i = 0; i < 4; i++) {\n\t\toff = ((sprom_mcs_po[0] >> (i * 4)) & 0xf) * 2;\n\t\trates->mcs_20_cdd[i] = maxpwr - off;\n\t\tif (phy->type == B43_PHYTYPE_N && phy->rev >= 3)\n\t\t\trates->mcs_20_cdd[i] -= extra_cdd_po;\n\t}\n\tfor (i = 0; i < 4; i++) {\n\t\toff = ((sprom_mcs_po[1] >> (i * 4)) & 0xf) * 2;\n\t\trates->mcs_20_cdd[4 + i] = maxpwr - off;\n\t\tif (phy->type == B43_PHYTYPE_N && phy->rev >= 3)\n\t\t\trates->mcs_20_cdd[4 + i] -= extra_cdd_po;\n\t}\n\n\t \n\trates->ofdm_20_cdd[0] = rates->mcs_20_cdd[0];\n\trates->ofdm_20_cdd[1] = rates->mcs_20_cdd[0];\n\trates->ofdm_20_cdd[2] = rates->mcs_20_cdd[1];\n\trates->ofdm_20_cdd[3] = rates->mcs_20_cdd[2];\n\trates->ofdm_20_cdd[4] = rates->mcs_20_cdd[3];\n\trates->ofdm_20_cdd[5] = rates->mcs_20_cdd[4];\n\trates->ofdm_20_cdd[6] = rates->mcs_20_cdd[5];\n\trates->ofdm_20_cdd[7] = rates->mcs_20_cdd[6];\n\n\t \n\tfor (i = 0; i < 4; i++) {\n\t\toff = ((sprom_mcs_po[0] >> (i * 4)) & 0xf) * 2;\n\t\trates->mcs_20_stbc[i] = maxpwr - off;\n\t\tif (phy->type == B43_PHYTYPE_N && phy->rev >= 3)\n\t\t\trates->mcs_20_stbc[i] -= extra_stbc_po;\n\t}\n\tfor (i = 0; i < 4; i++) {\n\t\toff = ((sprom_mcs_po[1] >> (i * 4)) & 0xf) * 2;\n\t\trates->mcs_20_stbc[4 + i] = maxpwr - off;\n\t\tif (phy->type == B43_PHYTYPE_N && phy->rev >= 3)\n\t\t\trates->mcs_20_stbc[4 + i] -= extra_stbc_po;\n\t}\n\n\t \n\tfor (i = 0; i < 4; i++) {\n\t\toff = ((sprom_mcs_po[2] >> (i * 4)) & 0xf) * 2;\n\t\trates->mcs_20_sdm[i] = maxpwr - off;\n\t}\n\tfor (i = 0; i < 4; i++) {\n\t\toff = ((sprom_mcs_po[3] >> (i * 4)) & 0xf) * 2;\n\t\trates->mcs_20_sdm[4 + i] = maxpwr - off;\n\t}\n\n\treturn true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}