{
  "module_name": "phy_n.c",
  "hash_id": "efef8922632dfd57646c6e91fecfcfe132a19d7d449e27876b02d78e0c93e35a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/b43/phy_n.c",
  "human_readable_source": "\n \n\n#include <linux/cordic.h>\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <linux/types.h>\n\n#include \"b43.h\"\n#include \"phy_n.h\"\n#include \"tables_nphy.h\"\n#include \"radio_2055.h\"\n#include \"radio_2056.h\"\n#include \"radio_2057.h\"\n#include \"main.h\"\n#include \"ppr.h\"\n\nstruct nphy_txgains {\n\tu16 tx_lpf[2];\n\tu16 txgm[2];\n\tu16 pga[2];\n\tu16 pad[2];\n\tu16 ipa[2];\n};\n\nstruct nphy_iqcal_params {\n\tu16 tx_lpf;\n\tu16 txgm;\n\tu16 pga;\n\tu16 pad;\n\tu16 ipa;\n\tu16 cal_gain;\n\tu16 ncorr[5];\n};\n\nstruct nphy_iq_est {\n\ts32 iq0_prod;\n\tu32 i0_pwr;\n\tu32 q0_pwr;\n\ts32 iq1_prod;\n\tu32 i1_pwr;\n\tu32 q1_pwr;\n};\n\nenum b43_nphy_rf_sequence {\n\tB43_RFSEQ_RX2TX,\n\tB43_RFSEQ_TX2RX,\n\tB43_RFSEQ_RESET2RX,\n\tB43_RFSEQ_UPDATE_GAINH,\n\tB43_RFSEQ_UPDATE_GAINL,\n\tB43_RFSEQ_UPDATE_GAINU,\n};\n\nenum n_rf_ctl_over_cmd {\n\tN_RF_CTL_OVER_CMD_RXRF_PU = 0,\n\tN_RF_CTL_OVER_CMD_RX_PU = 1,\n\tN_RF_CTL_OVER_CMD_TX_PU = 2,\n\tN_RF_CTL_OVER_CMD_RX_GAIN = 3,\n\tN_RF_CTL_OVER_CMD_TX_GAIN = 4,\n};\n\nenum n_intc_override {\n\tN_INTC_OVERRIDE_OFF = 0,\n\tN_INTC_OVERRIDE_TRSW = 1,\n\tN_INTC_OVERRIDE_PA = 2,\n\tN_INTC_OVERRIDE_EXT_LNA_PU = 3,\n\tN_INTC_OVERRIDE_EXT_LNA_GAIN = 4,\n};\n\nenum n_rssi_type {\n\tN_RSSI_W1 = 0,\n\tN_RSSI_W2,\n\tN_RSSI_NB,\n\tN_RSSI_IQ,\n\tN_RSSI_TSSI_2G,\n\tN_RSSI_TSSI_5G,\n\tN_RSSI_TBD,\n};\n\nenum n_rail_type {\n\tN_RAIL_I = 0,\n\tN_RAIL_Q = 1,\n};\n\nstatic inline bool b43_nphy_ipa(struct b43_wldev *dev)\n{\n\tenum nl80211_band band = b43_current_band(dev->wl);\n\treturn ((dev->phy.n->ipa2g_on && band == NL80211_BAND_2GHZ) ||\n\t\t(dev->phy.n->ipa5g_on && band == NL80211_BAND_5GHZ));\n}\n\n \n\n \n}\n\n \n\te = b43_nphy_get_rf_ctl_over_rev7(dev, field, override);\n\n\tfor (i = 0; i < 2; i++) {\n\t\tif (override >= ARRAY_SIZE(en_addrs)) {\n\t\t\tb43err(dev->wl, \"Invalid override value %d\\n\", override);\n\t\t\treturn;\n\t\t}\n\t\ten_addr = en_addrs[override][i];\n\n\t\tif (e)\n\t\t\tval_addr = (i == 0) ? e->val_addr_core0 : e->val_addr_core1;\n\n\t\tif (off) {\n\t\t\tb43_phy_mask(dev, en_addr, ~en_mask);\n\t\t\tif (e)  \n\t\t\t\tb43_phy_mask(dev, val_addr, ~e->val_mask);\n\t\t} else {\n\t\t\tif (!core || (core & (1 << i))) {\n\t\t\t\tb43_phy_set(dev, en_addr, en_mask);\n\t\t\t\tif (e)\n\t\t\t\t\tb43_phy_maskset(dev, val_addr, ~e->val_mask, (value << e->val_shift));\n\t\t\t}\n\t\t}\n\t}\n}\n\n \n\tB43_WARN_ON(field & (~(1 << (index - 1))));\n\n\tif (dev->phy.rev >= 3) {\n\t\tconst struct nphy_rf_control_override_rev3 *rf_ctrl;\n\t\tfor (i = 0; i < 2; i++) {\n\t\t\tif (index == 0 || index == 16) {\n\t\t\t\tb43err(dev->wl,\n\t\t\t\t\t\"Unsupported RF Ctrl Override call\\n\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\trf_ctrl = &tbl_rf_control_override_rev3[index - 1];\n\t\t\ten_addr = B43_PHY_N((i == 0) ?\n\t\t\t\trf_ctrl->en_addr0 : rf_ctrl->en_addr1);\n\t\t\tval_addr = B43_PHY_N((i == 0) ?\n\t\t\t\trf_ctrl->val_addr0 : rf_ctrl->val_addr1);\n\n\t\t\tif (off) {\n\t\t\t\tb43_phy_mask(dev, en_addr, ~(field));\n\t\t\t\tb43_phy_mask(dev, val_addr,\n\t\t\t\t\t\t~(rf_ctrl->val_mask));\n\t\t\t} else {\n\t\t\t\tif (core == 0 || ((1 << i) & core)) {\n\t\t\t\t\tb43_phy_set(dev, en_addr, field);\n\t\t\t\t\tb43_phy_maskset(dev, val_addr,\n\t\t\t\t\t\t~(rf_ctrl->val_mask),\n\t\t\t\t\t\t(value << rf_ctrl->val_shift));\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\tconst struct nphy_rf_control_override_rev2 *rf_ctrl;\n\t\tif (off) {\n\t\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_OVER, ~(field));\n\t\t\tvalue = 0;\n\t\t} else {\n\t\t\tb43_phy_set(dev, B43_NPHY_RFCTL_OVER, field);\n\t\t}\n\n\t\tfor (i = 0; i < 2; i++) {\n\t\t\tif (index <= 1 || index == 16) {\n\t\t\t\tb43err(dev->wl,\n\t\t\t\t\t\"Unsupported RF Ctrl Override call\\n\");\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (index == 2 || index == 10 ||\n\t\t\t    (index >= 13 && index <= 15)) {\n\t\t\t\tcore = 1;\n\t\t\t}\n\n\t\t\trf_ctrl = &tbl_rf_control_override_rev2[index - 2];\n\t\t\taddr = B43_PHY_N((i == 0) ?\n\t\t\t\trf_ctrl->addr0 : rf_ctrl->addr1);\n\n\t\t\tif ((1 << i) & core)\n\t\t\t\tb43_phy_maskset(dev, addr, ~(rf_ctrl->bmask),\n\t\t\t\t\t\t(value << rf_ctrl->shift));\n\n\t\t\tb43_phy_set(dev, B43_NPHY_RFCTL_OVER, 0x1);\n\t\t\tb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\n\t\t\t\t\tB43_NPHY_RFCTL_CMD_START);\n\t\t\tudelay(1);\n\t\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_OVER, 0xFFFE);\n\t\t}\n\t}\n}\n\nstatic void b43_nphy_rf_ctl_intc_override_rev7(struct b43_wldev *dev,\n\t\t\t\t\t       enum n_intc_override intc_override,\n\t\t\t\t\t       u16 value, u8 core_sel)\n{\n\tu16 reg, tmp, tmp2, val;\n\tint core;\n\n\t \n\n\tfor (core = 0; core < 2; core++) {\n\t\tif ((core_sel == 1 && core != 0) ||\n\t\t    (core_sel == 2 && core != 1))\n\t\t\tcontinue;\n\n\t\treg = (core == 0) ? B43_NPHY_RFCTL_INTC1 : B43_NPHY_RFCTL_INTC2;\n\n\t\tswitch (intc_override) {\n\t\tcase N_INTC_OVERRIDE_OFF:\n\t\t\tb43_phy_write(dev, reg, 0);\n\t\t\tb43_phy_mask(dev, 0x2ff, ~0x2000);\n\t\t\tb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\n\t\t\tbreak;\n\t\tcase N_INTC_OVERRIDE_TRSW:\n\t\t\tb43_phy_maskset(dev, reg, ~0xC0, value << 6);\n\t\t\tb43_phy_set(dev, reg, 0x400);\n\n\t\t\tb43_phy_mask(dev, 0x2ff, ~0xC000 & 0xFFFF);\n\t\t\tb43_phy_set(dev, 0x2ff, 0x2000);\n\t\t\tb43_phy_set(dev, 0x2ff, 0x0001);\n\t\t\tbreak;\n\t\tcase N_INTC_OVERRIDE_PA:\n\t\t\ttmp = 0x0030;\n\t\t\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\n\t\t\t\tval = value << 5;\n\t\t\telse\n\t\t\t\tval = value << 4;\n\t\t\tb43_phy_maskset(dev, reg, ~tmp, val);\n\t\t\tb43_phy_set(dev, reg, 0x1000);\n\t\t\tbreak;\n\t\tcase N_INTC_OVERRIDE_EXT_LNA_PU:\n\t\t\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\n\t\t\t\ttmp = 0x0001;\n\t\t\t\ttmp2 = 0x0004;\n\t\t\t\tval = value;\n\t\t\t} else {\n\t\t\t\ttmp = 0x0004;\n\t\t\t\ttmp2 = 0x0001;\n\t\t\t\tval = value << 2;\n\t\t\t}\n\t\t\tb43_phy_maskset(dev, reg, ~tmp, val);\n\t\t\tb43_phy_mask(dev, reg, ~tmp2);\n\t\t\tbreak;\n\t\tcase N_INTC_OVERRIDE_EXT_LNA_GAIN:\n\t\t\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\n\t\t\t\ttmp = 0x0002;\n\t\t\t\ttmp2 = 0x0008;\n\t\t\t\tval = value << 1;\n\t\t\t} else {\n\t\t\t\ttmp = 0x0008;\n\t\t\t\ttmp2 = 0x0002;\n\t\t\t\tval = value << 3;\n\t\t\t}\n\t\t\tb43_phy_maskset(dev, reg, ~tmp, val);\n\t\t\tb43_phy_mask(dev, reg, ~tmp2);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\n \n\n \n\nstatic void b43_radio_2057_chantab_upload(struct b43_wldev *dev,\n\t\t\t\t\t  const struct b43_nphy_chantabent_rev7 *e_r7,\n\t\t\t\t\t  const struct b43_nphy_chantabent_rev7_2g *e_r7_2g)\n{\n\tif (e_r7_2g) {\n\t\tb43_radio_write(dev, R2057_VCOCAL_COUNTVAL0, e_r7_2g->radio_vcocal_countval0);\n\t\tb43_radio_write(dev, R2057_VCOCAL_COUNTVAL1, e_r7_2g->radio_vcocal_countval1);\n\t\tb43_radio_write(dev, R2057_RFPLL_REFMASTER_SPAREXTALSIZE, e_r7_2g->radio_rfpll_refmaster_sparextalsize);\n\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_R1, e_r7_2g->radio_rfpll_loopfilter_r1);\n\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C2, e_r7_2g->radio_rfpll_loopfilter_c2);\n\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C1, e_r7_2g->radio_rfpll_loopfilter_c1);\n\t\tb43_radio_write(dev, R2057_CP_KPD_IDAC, e_r7_2g->radio_cp_kpd_idac);\n\t\tb43_radio_write(dev, R2057_RFPLL_MMD0, e_r7_2g->radio_rfpll_mmd0);\n\t\tb43_radio_write(dev, R2057_RFPLL_MMD1, e_r7_2g->radio_rfpll_mmd1);\n\t\tb43_radio_write(dev, R2057_VCOBUF_TUNE, e_r7_2g->radio_vcobuf_tune);\n\t\tb43_radio_write(dev, R2057_LOGEN_MX2G_TUNE, e_r7_2g->radio_logen_mx2g_tune);\n\t\tb43_radio_write(dev, R2057_LOGEN_INDBUF2G_TUNE, e_r7_2g->radio_logen_indbuf2g_tune);\n\t\tb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE0, e_r7_2g->radio_txmix2g_tune_boost_pu_core0);\n\t\tb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE0, e_r7_2g->radio_pad2g_tune_pus_core0);\n\t\tb43_radio_write(dev, R2057_LNA2G_TUNE_CORE0, e_r7_2g->radio_lna2g_tune_core0);\n\t\tb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE1, e_r7_2g->radio_txmix2g_tune_boost_pu_core1);\n\t\tb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE1, e_r7_2g->radio_pad2g_tune_pus_core1);\n\t\tb43_radio_write(dev, R2057_LNA2G_TUNE_CORE1, e_r7_2g->radio_lna2g_tune_core1);\n\n\t} else {\n\t\tb43_radio_write(dev, R2057_VCOCAL_COUNTVAL0, e_r7->radio_vcocal_countval0);\n\t\tb43_radio_write(dev, R2057_VCOCAL_COUNTVAL1, e_r7->radio_vcocal_countval1);\n\t\tb43_radio_write(dev, R2057_RFPLL_REFMASTER_SPAREXTALSIZE, e_r7->radio_rfpll_refmaster_sparextalsize);\n\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_R1, e_r7->radio_rfpll_loopfilter_r1);\n\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C2, e_r7->radio_rfpll_loopfilter_c2);\n\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C1, e_r7->radio_rfpll_loopfilter_c1);\n\t\tb43_radio_write(dev, R2057_CP_KPD_IDAC, e_r7->radio_cp_kpd_idac);\n\t\tb43_radio_write(dev, R2057_RFPLL_MMD0, e_r7->radio_rfpll_mmd0);\n\t\tb43_radio_write(dev, R2057_RFPLL_MMD1, e_r7->radio_rfpll_mmd1);\n\t\tb43_radio_write(dev, R2057_VCOBUF_TUNE, e_r7->radio_vcobuf_tune);\n\t\tb43_radio_write(dev, R2057_LOGEN_MX2G_TUNE, e_r7->radio_logen_mx2g_tune);\n\t\tb43_radio_write(dev, R2057_LOGEN_MX5G_TUNE, e_r7->radio_logen_mx5g_tune);\n\t\tb43_radio_write(dev, R2057_LOGEN_INDBUF2G_TUNE, e_r7->radio_logen_indbuf2g_tune);\n\t\tb43_radio_write(dev, R2057_LOGEN_INDBUF5G_TUNE, e_r7->radio_logen_indbuf5g_tune);\n\t\tb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE0, e_r7->radio_txmix2g_tune_boost_pu_core0);\n\t\tb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE0, e_r7->radio_pad2g_tune_pus_core0);\n\t\tb43_radio_write(dev, R2057_PGA_BOOST_TUNE_CORE0, e_r7->radio_pga_boost_tune_core0);\n\t\tb43_radio_write(dev, R2057_TXMIX5G_BOOST_TUNE_CORE0, e_r7->radio_txmix5g_boost_tune_core0);\n\t\tb43_radio_write(dev, R2057_PAD5G_TUNE_MISC_PUS_CORE0, e_r7->radio_pad5g_tune_misc_pus_core0);\n\t\tb43_radio_write(dev, R2057_LNA2G_TUNE_CORE0, e_r7->radio_lna2g_tune_core0);\n\t\tb43_radio_write(dev, R2057_LNA5G_TUNE_CORE0, e_r7->radio_lna5g_tune_core0);\n\t\tb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE1, e_r7->radio_txmix2g_tune_boost_pu_core1);\n\t\tb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE1, e_r7->radio_pad2g_tune_pus_core1);\n\t\tb43_radio_write(dev, R2057_PGA_BOOST_TUNE_CORE1, e_r7->radio_pga_boost_tune_core1);\n\t\tb43_radio_write(dev, R2057_TXMIX5G_BOOST_TUNE_CORE1, e_r7->radio_txmix5g_boost_tune_core1);\n\t\tb43_radio_write(dev, R2057_PAD5G_TUNE_MISC_PUS_CORE1, e_r7->radio_pad5g_tune_misc_pus_core1);\n\t\tb43_radio_write(dev, R2057_LNA2G_TUNE_CORE1, e_r7->radio_lna2g_tune_core1);\n\t\tb43_radio_write(dev, R2057_LNA5G_TUNE_CORE1, e_r7->radio_lna5g_tune_core1);\n\t}\n}\n\nstatic void b43_radio_2057_setup(struct b43_wldev *dev,\n\t\t\t\t const struct b43_nphy_chantabent_rev7 *tabent_r7,\n\t\t\t\t const struct b43_nphy_chantabent_rev7_2g *tabent_r7_2g)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tb43_radio_2057_chantab_upload(dev, tabent_r7, tabent_r7_2g);\n\n\tswitch (phy->radio_rev) {\n\tcase 0 ... 4:\n\tcase 6:\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_R1, 0x3f);\n\t\t\tb43_radio_write(dev, R2057_CP_KPD_IDAC, 0x3f);\n\t\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C1, 0x8);\n\t\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C2, 0x8);\n\t\t} else {\n\t\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_R1, 0x1f);\n\t\t\tb43_radio_write(dev, R2057_CP_KPD_IDAC, 0x3f);\n\t\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C1, 0x8);\n\t\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C2, 0x8);\n\t\t}\n\t\tbreak;\n\tcase 9:  \n\t\tb43_radio_write(dev, R2057_LOGEN_PTAT_RESETS, 0x20);\n\t\tb43_radio_write(dev, R2057_VCOBUF_IDACS, 0x18);\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\n\t\t\tb43_radio_write(dev, R2057_LOGEN_PTAT_RESETS, 0x38);\n\t\t\tb43_radio_write(dev, R2057_VCOBUF_IDACS, 0x0f);\n\n\t\t\tif (b43_is_40mhz(dev)) {\n\t\t\t\t \n\t\t\t} else {\n\t\t\t\tb43_radio_write(dev,\n\t\t\t\t\t\tR2057_PAD_BIAS_FILTER_BWS_CORE0,\n\t\t\t\t\t\t0x3c);\n\t\t\t\tb43_radio_write(dev,\n\t\t\t\t\t\tR2057_PAD_BIAS_FILTER_BWS_CORE1,\n\t\t\t\t\t\t0x3c);\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase 14:  \n\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_R1, 0x1b);\n\t\tb43_radio_write(dev, R2057_CP_KPD_IDAC, 0x3f);\n\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C1, 0x1f);\n\t\tb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C2, 0x1f);\n\t\tbreak;\n\t}\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\tu16 txmix2g_tune_boost_pu = 0;\n\t\tu16 pad2g_tune_pus = 0;\n\n\t\tif (b43_nphy_ipa(dev)) {\n\t\t\tswitch (phy->radio_rev) {\n\t\t\tcase 9:\n\t\t\t\ttxmix2g_tune_boost_pu = 0x0041;\n\t\t\t\t \n\t\t\t\tbreak;\n\t\t\tcase 14:\n\t\t\t\ttxmix2g_tune_boost_pu = 0x21;\n\t\t\t\tpad2g_tune_pus = 0x23;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (txmix2g_tune_boost_pu)\n\t\t\tb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE0,\n\t\t\t\t\ttxmix2g_tune_boost_pu);\n\t\tif (pad2g_tune_pus)\n\t\t\tb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE0,\n\t\t\t\t\tpad2g_tune_pus);\n\t\tif (txmix2g_tune_boost_pu)\n\t\t\tb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE1,\n\t\t\t\t\ttxmix2g_tune_boost_pu);\n\t\tif (pad2g_tune_pus)\n\t\t\tb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE1,\n\t\t\t\t\tpad2g_tune_pus);\n\t}\n\n\tusleep_range(50, 100);\n\n\t \n\tb43_radio_mask(dev, R2057_RFPLL_MISC_EN, ~0x01);\n\tb43_radio_mask(dev, R2057_RFPLL_MISC_CAL_RESETN, ~0x04);\n\tb43_radio_set(dev, R2057_RFPLL_MISC_CAL_RESETN, 0x4);\n\tb43_radio_set(dev, R2057_RFPLL_MISC_EN, 0x01);\n\tusleep_range(300, 600);\n}\n\n \nstatic u8 b43_radio_2057_rcal(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tu16 saved_regs_phy[12];\n\tu16 saved_regs_phy_rf[6];\n\tu16 saved_regs_radio[2] = { };\n\tstatic const u16 phy_to_store[] = {\n\t\tB43_NPHY_RFCTL_RSSIO1, B43_NPHY_RFCTL_RSSIO2,\n\t\tB43_NPHY_RFCTL_LUT_TRSW_LO1, B43_NPHY_RFCTL_LUT_TRSW_LO2,\n\t\tB43_NPHY_RFCTL_RXG1, B43_NPHY_RFCTL_RXG2,\n\t\tB43_NPHY_RFCTL_TXG1, B43_NPHY_RFCTL_TXG2,\n\t\tB43_NPHY_REV7_RF_CTL_MISC_REG3, B43_NPHY_REV7_RF_CTL_MISC_REG4,\n\t\tB43_NPHY_REV7_RF_CTL_MISC_REG5, B43_NPHY_REV7_RF_CTL_MISC_REG6,\n\t};\n\tstatic const u16 phy_to_store_rf[] = {\n\t\tB43_NPHY_REV3_RFCTL_OVER0, B43_NPHY_REV3_RFCTL_OVER1,\n\t\tB43_NPHY_REV7_RF_CTL_OVER3, B43_NPHY_REV7_RF_CTL_OVER4,\n\t\tB43_NPHY_REV7_RF_CTL_OVER5, B43_NPHY_REV7_RF_CTL_OVER6,\n\t};\n\tu16 tmp;\n\tint i;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(phy_to_store); i++)\n\t\tsaved_regs_phy[i] = b43_phy_read(dev, phy_to_store[i]);\n\tfor (i = 0; i < ARRAY_SIZE(phy_to_store_rf); i++)\n\t\tsaved_regs_phy_rf[i] = b43_phy_read(dev, phy_to_store_rf[i]);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(phy_to_store); i++)\n\t\tb43_phy_write(dev, phy_to_store[i], 0);\n\tb43_phy_write(dev, B43_NPHY_REV3_RFCTL_OVER0, 0x07ff);\n\tb43_phy_write(dev, B43_NPHY_REV3_RFCTL_OVER1, 0x07ff);\n\tb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER3, 0x07ff);\n\tb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER4, 0x07ff);\n\tb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER5, 0x007f);\n\tb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER6, 0x007f);\n\n\tswitch (phy->radio_rev) {\n\tcase 5:\n\t\tb43_phy_mask(dev, B43_NPHY_REV7_RF_CTL_OVER3, ~0x2);\n\t\tudelay(10);\n\t\tb43_radio_set(dev, R2057_IQTEST_SEL_PU, 0x1);\n\t\tb43_radio_maskset(dev, R2057v7_IQTEST_SEL_PU2, ~0x2, 0x1);\n\t\tbreak;\n\tcase 9:\n\t\tb43_phy_set(dev, B43_NPHY_REV7_RF_CTL_OVER3, 0x2);\n\t\tb43_phy_set(dev, B43_NPHY_REV7_RF_CTL_MISC_REG3, 0x2);\n\t\tsaved_regs_radio[0] = b43_radio_read(dev, R2057_IQTEST_SEL_PU);\n\t\tb43_radio_write(dev, R2057_IQTEST_SEL_PU, 0x11);\n\t\tbreak;\n\tcase 14:\n\t\tsaved_regs_radio[0] = b43_radio_read(dev, R2057_IQTEST_SEL_PU);\n\t\tsaved_regs_radio[1] = b43_radio_read(dev, R2057v7_IQTEST_SEL_PU2);\n\t\tb43_phy_set(dev, B43_NPHY_REV7_RF_CTL_MISC_REG3, 0x2);\n\t\tb43_phy_set(dev, B43_NPHY_REV7_RF_CTL_OVER3, 0x2);\n\t\tb43_radio_write(dev, R2057v7_IQTEST_SEL_PU2, 0x2);\n\t\tb43_radio_write(dev, R2057_IQTEST_SEL_PU, 0x1);\n\t\tbreak;\n\t}\n\n\t \n\tb43_radio_set(dev, R2057_RCAL_CONFIG, 0x1);\n\tudelay(10);\n\n\t \n\tb43_radio_set(dev, R2057_RCAL_CONFIG, 0x2);\n\tusleep_range(100, 200);\n\n\t \n\tb43_radio_mask(dev, R2057_RCAL_CONFIG, ~0x2);\n\n\t \n\tif (!b43_radio_wait_value(dev, R2057_RCAL_STATUS, 1, 1, 100, 1000000)) {\n\t\tb43err(dev->wl, \"Radio 0x2057 rcal timeout\\n\");\n\t\treturn 0;\n\t}\n\ttmp = b43_radio_read(dev, R2057_RCAL_STATUS) & 0x3E;\n\n\t \n\tb43_radio_mask(dev, R2057_RCAL_CONFIG, ~0x1);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(phy_to_store_rf); i++)\n\t\tb43_phy_write(dev, phy_to_store_rf[i], saved_regs_phy_rf[i]);\n\tfor (i = 0; i < ARRAY_SIZE(phy_to_store); i++)\n\t\tb43_phy_write(dev, phy_to_store[i], saved_regs_phy[i]);\n\n\tswitch (phy->radio_rev) {\n\tcase 0 ... 4:\n\tcase 6:\n\t\tb43_radio_maskset(dev, R2057_TEMPSENSE_CONFIG, ~0x3C, tmp);\n\t\tb43_radio_maskset(dev, R2057_BANDGAP_RCAL_TRIM, ~0xF0,\n\t\t\t\t  tmp << 2);\n\t\tbreak;\n\tcase 5:\n\t\tb43_radio_mask(dev, R2057_IPA2G_CASCONV_CORE0, ~0x1);\n\t\tb43_radio_mask(dev, R2057v7_IQTEST_SEL_PU2, ~0x2);\n\t\tbreak;\n\tcase 9:\n\t\tb43_radio_write(dev, R2057_IQTEST_SEL_PU, saved_regs_radio[0]);\n\t\tbreak;\n\tcase 14:\n\t\tb43_radio_write(dev, R2057_IQTEST_SEL_PU, saved_regs_radio[0]);\n\t\tb43_radio_write(dev, R2057v7_IQTEST_SEL_PU2, saved_regs_radio[1]);\n\t\tbreak;\n\t}\n\n\treturn tmp & 0x3e;\n}\n\n \nstatic u16 b43_radio_2057_rccal(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tbool special = (phy->radio_rev == 3 || phy->radio_rev == 4 ||\n\t\t\tphy->radio_rev == 6);\n\tu16 tmp;\n\n\t \n\tif (special) {\n\t\tb43_radio_write(dev, R2057_RCCAL_MASTER, 0x61);\n\t\tb43_radio_write(dev, R2057_RCCAL_TRC0, 0xC0);\n\t} else {\n\t\tb43_radio_write(dev, R2057v7_RCCAL_MASTER, 0x61);\n\t\tb43_radio_write(dev, R2057_RCCAL_TRC0, 0xE9);\n\t}\n\tb43_radio_write(dev, R2057_RCCAL_X1, 0x6E);\n\n\t \n\tb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x55);\n\tif (!b43_radio_wait_value(dev, R2057_RCCAL_DONE_OSCCAP, 2, 2, 500,\n\t\t\t\t  5000000))\n\t\tb43dbg(dev->wl, \"Radio 0x2057 rccal timeout\\n\");\n\tusleep_range(35, 70);\n\tb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x15);\n\tusleep_range(70, 140);\n\n\t \n\tif (special) {\n\t\tb43_radio_write(dev, R2057_RCCAL_MASTER, 0x69);\n\t\tb43_radio_write(dev, R2057_RCCAL_TRC0, 0xB0);\n\t} else {\n\t\tb43_radio_write(dev, R2057v7_RCCAL_MASTER, 0x69);\n\t\tb43_radio_write(dev, R2057_RCCAL_TRC0, 0xD5);\n\t}\n\tb43_radio_write(dev, R2057_RCCAL_X1, 0x6E);\n\n\t \n\tusleep_range(35, 70);\n\tb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x55);\n\tusleep_range(70, 140);\n\tif (!b43_radio_wait_value(dev, R2057_RCCAL_DONE_OSCCAP, 2, 2, 500,\n\t\t\t\t  5000000))\n\t\tb43dbg(dev->wl, \"Radio 0x2057 rccal timeout\\n\");\n\tusleep_range(35, 70);\n\tb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x15);\n\tusleep_range(70, 140);\n\n\t \n\tif (special) {\n\t\tb43_radio_write(dev, R2057_RCCAL_MASTER, 0x73);\n\t\tb43_radio_write(dev, R2057_RCCAL_X1, 0x28);\n\t\tb43_radio_write(dev, R2057_RCCAL_TRC0, 0xB0);\n\t} else {\n\t\tb43_radio_write(dev, R2057v7_RCCAL_MASTER, 0x73);\n\t\tb43_radio_write(dev, R2057_RCCAL_X1, 0x6E);\n\t\tb43_radio_write(dev, R2057_RCCAL_TRC0, 0x99);\n\t}\n\n\t \n\tusleep_range(35, 70);\n\tb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x55);\n\tusleep_range(70, 140);\n\tif (!b43_radio_wait_value(dev, R2057_RCCAL_DONE_OSCCAP, 2, 2, 500,\n\t\t\t\t  5000000)) {\n\t\tb43err(dev->wl, \"Radio 0x2057 rcal timeout\\n\");\n\t\treturn 0;\n\t}\n\ttmp = b43_radio_read(dev, R2057_RCCAL_DONE_OSCCAP);\n\tusleep_range(35, 70);\n\tb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x15);\n\tusleep_range(70, 140);\n\n\tif (special)\n\t\tb43_radio_mask(dev, R2057_RCCAL_MASTER, ~0x1);\n\telse\n\t\tb43_radio_mask(dev, R2057v7_RCCAL_MASTER, ~0x1);\n\n\treturn tmp;\n}\n\nstatic void b43_radio_2057_init_pre(struct b43_wldev *dev)\n{\n\tb43_phy_mask(dev, B43_NPHY_RFCTL_CMD, ~B43_NPHY_RFCTL_CMD_CHIP0PU);\n\t \n\tb43_phy_mask(dev, B43_NPHY_RFCTL_CMD, B43_NPHY_RFCTL_CMD_OEPORFORCE);\n\tb43_phy_set(dev, B43_NPHY_RFCTL_CMD, ~B43_NPHY_RFCTL_CMD_OEPORFORCE);\n\tb43_phy_set(dev, B43_NPHY_RFCTL_CMD, B43_NPHY_RFCTL_CMD_CHIP0PU);\n}\n\nstatic void b43_radio_2057_init_post(struct b43_wldev *dev)\n{\n\tb43_radio_set(dev, R2057_XTALPUOVR_PINCTRL, 0x1);\n\n\tif (0)  \n\t\tb43_radio_set(dev, R2057_XTALPUOVR_PINCTRL, 0x2);\n\n\tb43_radio_set(dev, R2057_RFPLL_MISC_CAL_RESETN, 0x78);\n\tb43_radio_set(dev, R2057_XTAL_CONFIG2, 0x80);\n\tusleep_range(2000, 3000);\n\tb43_radio_mask(dev, R2057_RFPLL_MISC_CAL_RESETN, ~0x78);\n\tb43_radio_mask(dev, R2057_XTAL_CONFIG2, ~0x80);\n\n\tif (dev->phy.do_full_init) {\n\t\tb43_radio_2057_rcal(dev);\n\t\tb43_radio_2057_rccal(dev);\n\t}\n\tb43_radio_mask(dev, R2057_RFPLL_MASTER, ~0x8);\n}\n\n \n\nstatic void b43_chantab_radio_2056_upload(struct b43_wldev *dev,\n\t\t\t\tconst struct b43_nphy_channeltab_entry_rev3 *e)\n{\n\tb43_radio_write(dev, B2056_SYN_PLL_VCOCAL1, e->radio_syn_pll_vcocal1);\n\tb43_radio_write(dev, B2056_SYN_PLL_VCOCAL2, e->radio_syn_pll_vcocal2);\n\tb43_radio_write(dev, B2056_SYN_PLL_REFDIV, e->radio_syn_pll_refdiv);\n\tb43_radio_write(dev, B2056_SYN_PLL_MMD2, e->radio_syn_pll_mmd2);\n\tb43_radio_write(dev, B2056_SYN_PLL_MMD1, e->radio_syn_pll_mmd1);\n\tb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER1,\n\t\t\t\t\te->radio_syn_pll_loopfilter1);\n\tb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER2,\n\t\t\t\t\te->radio_syn_pll_loopfilter2);\n\tb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER3,\n\t\t\t\t\te->radio_syn_pll_loopfilter3);\n\tb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER4,\n\t\t\t\t\te->radio_syn_pll_loopfilter4);\n\tb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER5,\n\t\t\t\t\te->radio_syn_pll_loopfilter5);\n\tb43_radio_write(dev, B2056_SYN_RESERVED_ADDR27,\n\t\t\t\t\te->radio_syn_reserved_addr27);\n\tb43_radio_write(dev, B2056_SYN_RESERVED_ADDR28,\n\t\t\t\t\te->radio_syn_reserved_addr28);\n\tb43_radio_write(dev, B2056_SYN_RESERVED_ADDR29,\n\t\t\t\t\te->radio_syn_reserved_addr29);\n\tb43_radio_write(dev, B2056_SYN_LOGEN_VCOBUF1,\n\t\t\t\t\te->radio_syn_logen_vcobuf1);\n\tb43_radio_write(dev, B2056_SYN_LOGEN_MIXER2, e->radio_syn_logen_mixer2);\n\tb43_radio_write(dev, B2056_SYN_LOGEN_BUF3, e->radio_syn_logen_buf3);\n\tb43_radio_write(dev, B2056_SYN_LOGEN_BUF4, e->radio_syn_logen_buf4);\n\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_LNAA_TUNE,\n\t\t\t\t\te->radio_rx0_lnaa_tune);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_LNAG_TUNE,\n\t\t\t\t\te->radio_rx0_lnag_tune);\n\n\tb43_radio_write(dev, B2056_TX0 | B2056_TX_INTPAA_BOOST_TUNE,\n\t\t\t\t\te->radio_tx0_intpaa_boost_tune);\n\tb43_radio_write(dev, B2056_TX0 | B2056_TX_INTPAG_BOOST_TUNE,\n\t\t\t\t\te->radio_tx0_intpag_boost_tune);\n\tb43_radio_write(dev, B2056_TX0 | B2056_TX_PADA_BOOST_TUNE,\n\t\t\t\t\te->radio_tx0_pada_boost_tune);\n\tb43_radio_write(dev, B2056_TX0 | B2056_TX_PADG_BOOST_TUNE,\n\t\t\t\t\te->radio_tx0_padg_boost_tune);\n\tb43_radio_write(dev, B2056_TX0 | B2056_TX_PGAA_BOOST_TUNE,\n\t\t\t\t\te->radio_tx0_pgaa_boost_tune);\n\tb43_radio_write(dev, B2056_TX0 | B2056_TX_PGAG_BOOST_TUNE,\n\t\t\t\t\te->radio_tx0_pgag_boost_tune);\n\tb43_radio_write(dev, B2056_TX0 | B2056_TX_MIXA_BOOST_TUNE,\n\t\t\t\t\te->radio_tx0_mixa_boost_tune);\n\tb43_radio_write(dev, B2056_TX0 | B2056_TX_MIXG_BOOST_TUNE,\n\t\t\t\t\te->radio_tx0_mixg_boost_tune);\n\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_LNAA_TUNE,\n\t\t\t\t\te->radio_rx1_lnaa_tune);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_LNAG_TUNE,\n\t\t\t\t\te->radio_rx1_lnag_tune);\n\n\tb43_radio_write(dev, B2056_TX1 | B2056_TX_INTPAA_BOOST_TUNE,\n\t\t\t\t\te->radio_tx1_intpaa_boost_tune);\n\tb43_radio_write(dev, B2056_TX1 | B2056_TX_INTPAG_BOOST_TUNE,\n\t\t\t\t\te->radio_tx1_intpag_boost_tune);\n\tb43_radio_write(dev, B2056_TX1 | B2056_TX_PADA_BOOST_TUNE,\n\t\t\t\t\te->radio_tx1_pada_boost_tune);\n\tb43_radio_write(dev, B2056_TX1 | B2056_TX_PADG_BOOST_TUNE,\n\t\t\t\t\te->radio_tx1_padg_boost_tune);\n\tb43_radio_write(dev, B2056_TX1 | B2056_TX_PGAA_BOOST_TUNE,\n\t\t\t\t\te->radio_tx1_pgaa_boost_tune);\n\tb43_radio_write(dev, B2056_TX1 | B2056_TX_PGAG_BOOST_TUNE,\n\t\t\t\t\te->radio_tx1_pgag_boost_tune);\n\tb43_radio_write(dev, B2056_TX1 | B2056_TX_MIXA_BOOST_TUNE,\n\t\t\t\t\te->radio_tx1_mixa_boost_tune);\n\tb43_radio_write(dev, B2056_TX1 | B2056_TX_MIXG_BOOST_TUNE,\n\t\t\t\t\te->radio_tx1_mixg_boost_tune);\n}\n\n \n\tb43_radio_write(dev, B2056_SYN_PLL_VCOCAL12, 0x00);\n\tb43_radio_write(dev, B2056_TX_INTPAA_PA_MISC, 0x38);\n\tb43_radio_write(dev, B2056_TX_INTPAA_PA_MISC, 0x18);\n\tb43_radio_write(dev, B2056_TX_INTPAA_PA_MISC, 0x38);\n\tb43_radio_write(dev, B2056_TX_INTPAA_PA_MISC, 0x39);\n\tudelay(300);\n}\n\nstatic u8 b43_radio_2056_rcal(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tu16 mast2, tmp;\n\n\tif (phy->rev != 3)\n\t\treturn 0;\n\n\tmast2 = b43_radio_read(dev, B2056_SYN_PLL_MAST2);\n\tb43_radio_write(dev, B2056_SYN_PLL_MAST2, mast2 | 0x7);\n\n\tudelay(10);\n\tb43_radio_write(dev, B2056_SYN_RCAL_MASTER, 0x01);\n\tudelay(10);\n\tb43_radio_write(dev, B2056_SYN_RCAL_MASTER, 0x09);\n\n\tif (!b43_radio_wait_value(dev, B2056_SYN_RCAL_CODE_OUT, 0x80, 0x80, 100,\n\t\t\t\t  1000000)) {\n\t\tb43err(dev->wl, \"Radio recalibration timeout\\n\");\n\t\treturn 0;\n\t}\n\n\tb43_radio_write(dev, B2056_SYN_RCAL_MASTER, 0x01);\n\ttmp = b43_radio_read(dev, B2056_SYN_RCAL_CODE_OUT);\n\tb43_radio_write(dev, B2056_SYN_RCAL_MASTER, 0x00);\n\n\tb43_radio_write(dev, B2056_SYN_PLL_MAST2, mast2);\n\n\treturn tmp & 0x1f;\n}\n\nstatic void b43_radio_init2056_pre(struct b43_wldev *dev)\n{\n\tb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\n\t\t     ~B43_NPHY_RFCTL_CMD_CHIP0PU);\n\t \n\tb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\n\t\t     B43_NPHY_RFCTL_CMD_OEPORFORCE);\n\tb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\n\t\t    ~B43_NPHY_RFCTL_CMD_OEPORFORCE);\n\tb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\n\t\t    B43_NPHY_RFCTL_CMD_CHIP0PU);\n}\n\nstatic void b43_radio_init2056_post(struct b43_wldev *dev)\n{\n\tb43_radio_set(dev, B2056_SYN_COM_CTRL, 0xB);\n\tb43_radio_set(dev, B2056_SYN_COM_PU, 0x2);\n\tb43_radio_set(dev, B2056_SYN_COM_RESET, 0x2);\n\tmsleep(1);\n\tb43_radio_mask(dev, B2056_SYN_COM_RESET, ~0x2);\n\tb43_radio_mask(dev, B2056_SYN_PLL_MAST2, ~0xFC);\n\tb43_radio_mask(dev, B2056_SYN_RCCAL_CTRL0, ~0x1);\n\tif (dev->phy.do_full_init)\n\t\tb43_radio_2056_rcal(dev);\n}\n\n \nstatic void b43_radio_init2056(struct b43_wldev *dev)\n{\n\tb43_radio_init2056_pre(dev);\n\tb2056_upload_inittabs(dev, 0, 0);\n\tb43_radio_init2056_post(dev);\n}\n\n \n\nstatic void b43_chantab_radio_upload(struct b43_wldev *dev,\n\t\t\t\tconst struct b43_nphy_channeltab_entry_rev2 *e)\n{\n\tb43_radio_write(dev, B2055_PLL_REF, e->radio_pll_ref);\n\tb43_radio_write(dev, B2055_RF_PLLMOD0, e->radio_rf_pllmod0);\n\tb43_radio_write(dev, B2055_RF_PLLMOD1, e->radio_rf_pllmod1);\n\tb43_radio_write(dev, B2055_VCO_CAPTAIL, e->radio_vco_captail);\n\tb43_read32(dev, B43_MMIO_MACCTL);  \n\n\tb43_radio_write(dev, B2055_VCO_CAL1, e->radio_vco_cal1);\n\tb43_radio_write(dev, B2055_VCO_CAL2, e->radio_vco_cal2);\n\tb43_radio_write(dev, B2055_PLL_LFC1, e->radio_pll_lfc1);\n\tb43_radio_write(dev, B2055_PLL_LFR1, e->radio_pll_lfr1);\n\tb43_read32(dev, B43_MMIO_MACCTL);  \n\n\tb43_radio_write(dev, B2055_PLL_LFC2, e->radio_pll_lfc2);\n\tb43_radio_write(dev, B2055_LGBUF_CENBUF, e->radio_lgbuf_cenbuf);\n\tb43_radio_write(dev, B2055_LGEN_TUNE1, e->radio_lgen_tune1);\n\tb43_radio_write(dev, B2055_LGEN_TUNE2, e->radio_lgen_tune2);\n\tb43_read32(dev, B43_MMIO_MACCTL);  \n\n\tb43_radio_write(dev, B2055_C1_LGBUF_ATUNE, e->radio_c1_lgbuf_atune);\n\tb43_radio_write(dev, B2055_C1_LGBUF_GTUNE, e->radio_c1_lgbuf_gtune);\n\tb43_radio_write(dev, B2055_C1_RX_RFR1, e->radio_c1_rx_rfr1);\n\tb43_radio_write(dev, B2055_C1_TX_PGAPADTN, e->radio_c1_tx_pgapadtn);\n\tb43_read32(dev, B43_MMIO_MACCTL);  \n\n\tb43_radio_write(dev, B2055_C1_TX_MXBGTRIM, e->radio_c1_tx_mxbgtrim);\n\tb43_radio_write(dev, B2055_C2_LGBUF_ATUNE, e->radio_c2_lgbuf_atune);\n\tb43_radio_write(dev, B2055_C2_LGBUF_GTUNE, e->radio_c2_lgbuf_gtune);\n\tb43_radio_write(dev, B2055_C2_RX_RFR1, e->radio_c2_rx_rfr1);\n\tb43_read32(dev, B43_MMIO_MACCTL);  \n\n\tb43_radio_write(dev, B2055_C2_TX_PGAPADTN, e->radio_c2_tx_pgapadtn);\n\tb43_radio_write(dev, B2055_C2_TX_MXBGTRIM, e->radio_c2_tx_mxbgtrim);\n}\n\n \n\tb43_radio_write(dev, B2055_VCO_CAL10, 0x65);\n\tudelay(300);\n}\n\nstatic void b43_radio_init2055_pre(struct b43_wldev *dev)\n{\n\tb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\n\t\t     ~B43_NPHY_RFCTL_CMD_PORFORCE);\n\tb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\n\t\t    B43_NPHY_RFCTL_CMD_CHIP0PU |\n\t\t    B43_NPHY_RFCTL_CMD_OEPORFORCE);\n\tb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\n\t\t    B43_NPHY_RFCTL_CMD_PORFORCE);\n}\n\nstatic void b43_radio_init2055_post(struct b43_wldev *dev)\n{\n\tstruct b43_phy_n *nphy = dev->phy.n;\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\tbool workaround = false;\n\n\tif (sprom->revision < 4)\n\t\tworkaround = (dev->dev->board_vendor != PCI_VENDOR_ID_BROADCOM\n\t\t\t      && dev->dev->board_type == SSB_BOARD_CB2_4321\n\t\t\t      && dev->dev->board_rev >= 0x41);\n\telse\n\t\tworkaround =\n\t\t\t!(sprom->boardflags2_lo & B43_BFL2_RXBB_INT_REG_DIS);\n\n\tb43_radio_mask(dev, B2055_MASTER1, 0xFFF3);\n\tif (workaround) {\n\t\tb43_radio_mask(dev, B2055_C1_RX_BB_REG, 0x7F);\n\t\tb43_radio_mask(dev, B2055_C2_RX_BB_REG, 0x7F);\n\t}\n\tb43_radio_maskset(dev, B2055_RRCCAL_NOPTSEL, 0xFFC0, 0x2C);\n\tb43_radio_write(dev, B2055_CAL_MISC, 0x3C);\n\tb43_radio_mask(dev, B2055_CAL_MISC, 0xFFBE);\n\tb43_radio_set(dev, B2055_CAL_LPOCTL, 0x80);\n\tb43_radio_set(dev, B2055_CAL_MISC, 0x1);\n\tmsleep(1);\n\tb43_radio_set(dev, B2055_CAL_MISC, 0x40);\n\tif (!b43_radio_wait_value(dev, B2055_CAL_COUT2, 0x80, 0x80, 10, 2000))\n\t\tb43err(dev->wl, \"radio post init timeout\\n\");\n\tb43_radio_mask(dev, B2055_CAL_LPOCTL, 0xFF7F);\n\tb43_switch_channel(dev, dev->phy.channel);\n\tb43_radio_write(dev, B2055_C1_RX_BB_LPF, 0x9);\n\tb43_radio_write(dev, B2055_C2_RX_BB_LPF, 0x9);\n\tb43_radio_write(dev, B2055_C1_RX_BB_MIDACHP, 0x83);\n\tb43_radio_write(dev, B2055_C2_RX_BB_MIDACHP, 0x83);\n\tb43_radio_maskset(dev, B2055_C1_LNA_GAINBST, 0xFFF8, 0x6);\n\tb43_radio_maskset(dev, B2055_C2_LNA_GAINBST, 0xFFF8, 0x6);\n\tif (!nphy->gain_boost) {\n\t\tb43_radio_set(dev, B2055_C1_RX_RFSPC1, 0x2);\n\t\tb43_radio_set(dev, B2055_C2_RX_RFSPC1, 0x2);\n\t} else {\n\t\tb43_radio_mask(dev, B2055_C1_RX_RFSPC1, 0xFFFD);\n\t\tb43_radio_mask(dev, B2055_C2_RX_RFSPC1, 0xFFFD);\n\t}\n\tudelay(2);\n}\n\n \nstatic void b43_radio_init2055(struct b43_wldev *dev)\n{\n\tb43_radio_init2055_pre(dev);\n\tif (b43_status(dev) < B43_STAT_INITIALIZED) {\n\t\t \n\t\tb2055_upload_inittab(dev, 0, 0);\n\t} else {\n\t\tbool ghz5 = b43_current_band(dev->wl) == NL80211_BAND_5GHZ;\n\t\tb2055_upload_inittab(dev, ghz5, 0);\n\t}\n\tb43_radio_init2055_post(dev);\n}\n\n \n\n \n\t\t} else {\n\t\t\tu16 value = b43_nphy_read_lpf_ctl(dev, 0);\n\t\t\tif (phy->rev >= 19)\n\t\t\t\tb43_nphy_rf_ctl_override_rev19(dev, 0x80, value,\n\t\t\t\t\t\t\t       0, false, 1);\n\t\t\telse\n\t\t\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x80, value,\n\t\t\t\t\t\t\t      0, false, 1);\n\t\t\tnphy->lpf_bw_overrode_for_sample_play = true;\n\t\t}\n\t}\n\n\tif ((nphy->bb_mult_save & 0x80000000) == 0) {\n\t\ttmp = b43_ntab_read(dev, B43_NTAB16(15, 87));\n\t\tnphy->bb_mult_save = (tmp & 0xFFFF) | 0x80000000;\n\t}\n\n\tif (modify_bbmult) {\n\t\ttmp = !b43_is_40mhz(dev) ? 0x6464 : 0x4747;\n\t\tb43_ntab_write(dev, B43_NTAB16(15, 87), tmp);\n\t}\n\n\tb43_phy_write(dev, B43_NPHY_SAMP_DEPCNT, (samps - 1));\n\n\tif (loops != 0xFFFF)\n\t\tb43_phy_write(dev, B43_NPHY_SAMP_LOOPCNT, (loops - 1));\n\telse\n\t\tb43_phy_write(dev, B43_NPHY_SAMP_LOOPCNT, loops);\n\n\tb43_phy_write(dev, B43_NPHY_SAMP_WAITCNT, wait);\n\n\tseq_mode = b43_phy_read(dev, B43_NPHY_RFSEQMODE);\n\n\tb43_phy_set(dev, B43_NPHY_RFSEQMODE, B43_NPHY_RFSEQMODE_CAOVER);\n\tif (iqmode) {\n\t\tb43_phy_mask(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x7FFF);\n\t\tb43_phy_set(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8000);\n\t} else {\n\t\ttmp = dac_test ? 5 : 1;\n\t\tb43_phy_write(dev, B43_NPHY_SAMP_CMD, tmp);\n\t}\n\tfor (i = 0; i < 100; i++) {\n\t\tif (!(b43_phy_read(dev, B43_NPHY_RFSEQST) & 1)) {\n\t\t\ti = 0;\n\t\t\tbreak;\n\t\t}\n\t\tudelay(10);\n\t}\n\tif (i)\n\t\tb43err(dev->wl, \"run samples timeout\\n\");\n\n\tb43_phy_write(dev, B43_NPHY_RFSEQMODE, seq_mode);\n\n\tb43_nphy_stay_in_carrier_search(dev, false);\n}\n\n \n\n \n}\n\nstatic void b43_nphy_rev3_rssi_select(struct b43_wldev *dev, u8 code,\n\t\t\t\t      enum n_rssi_type rssi_type)\n{\n\tu8 i;\n\tu16 reg, val;\n\n\tif (code == 0) {\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_OVER1, 0xFDFF);\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_OVER, 0xFDFF);\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_C1, 0xFCFF);\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_C2, 0xFCFF);\n\t\tb43_phy_mask(dev, B43_NPHY_TXF_40CO_B1S0, 0xFFDF);\n\t\tb43_phy_mask(dev, B43_NPHY_TXF_40CO_B32S1, 0xFFDF);\n\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0xFFC3);\n\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0xFFC3);\n\t} else {\n\t\tfor (i = 0; i < 2; i++) {\n\t\t\tif ((code == 1 && i == 1) || (code == 2 && !i))\n\t\t\t\tcontinue;\n\n\t\t\treg = (i == 0) ?\n\t\t\t\tB43_NPHY_AFECTL_OVER1 : B43_NPHY_AFECTL_OVER;\n\t\t\tb43_phy_maskset(dev, reg, 0xFDFF, 0x0200);\n\n\t\t\tif (rssi_type == N_RSSI_W1 ||\n\t\t\t    rssi_type == N_RSSI_W2 ||\n\t\t\t    rssi_type == N_RSSI_NB) {\n\t\t\t\treg = (i == 0) ?\n\t\t\t\t\tB43_NPHY_AFECTL_C1 :\n\t\t\t\t\tB43_NPHY_AFECTL_C2;\n\t\t\t\tb43_phy_maskset(dev, reg, 0xFCFF, 0);\n\n\t\t\t\treg = (i == 0) ?\n\t\t\t\t\tB43_NPHY_RFCTL_LUT_TRSW_UP1 :\n\t\t\t\t\tB43_NPHY_RFCTL_LUT_TRSW_UP2;\n\t\t\t\tb43_phy_maskset(dev, reg, 0xFFC3, 0);\n\n\t\t\t\tif (rssi_type == N_RSSI_W1)\n\t\t\t\t\tval = (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) ? 4 : 8;\n\t\t\t\telse if (rssi_type == N_RSSI_W2)\n\t\t\t\t\tval = 16;\n\t\t\t\telse\n\t\t\t\t\tval = 32;\n\t\t\t\tb43_phy_set(dev, reg, val);\n\n\t\t\t\treg = (i == 0) ?\n\t\t\t\t\tB43_NPHY_TXF_40CO_B1S0 :\n\t\t\t\t\tB43_NPHY_TXF_40CO_B32S1;\n\t\t\t\tb43_phy_set(dev, reg, 0x0020);\n\t\t\t} else {\n\t\t\t\tif (rssi_type == N_RSSI_TBD)\n\t\t\t\t\tval = 0x0100;\n\t\t\t\telse if (rssi_type == N_RSSI_IQ)\n\t\t\t\t\tval = 0x0200;\n\t\t\t\telse\n\t\t\t\t\tval = 0x0300;\n\n\t\t\t\treg = (i == 0) ?\n\t\t\t\t\tB43_NPHY_AFECTL_C1 :\n\t\t\t\t\tB43_NPHY_AFECTL_C2;\n\n\t\t\t\tb43_phy_maskset(dev, reg, 0xFCFF, val);\n\t\t\t\tb43_phy_maskset(dev, reg, 0xF3FF, val << 2);\n\n\t\t\t\tif (rssi_type != N_RSSI_IQ &&\n\t\t\t\t    rssi_type != N_RSSI_TBD) {\n\t\t\t\t\tenum nl80211_band band =\n\t\t\t\t\t\tb43_current_band(dev->wl);\n\n\t\t\t\t\tif (dev->phy.rev < 7) {\n\t\t\t\t\t\tif (b43_nphy_ipa(dev))\n\t\t\t\t\t\t\tval = (band == NL80211_BAND_5GHZ) ? 0xC : 0xE;\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tval = 0x11;\n\t\t\t\t\t\treg = (i == 0) ? B2056_TX0 : B2056_TX1;\n\t\t\t\t\t\treg |= B2056_TX_TX_SSI_MUX;\n\t\t\t\t\t\tb43_radio_write(dev, reg, val);\n\t\t\t\t\t}\n\n\t\t\t\t\treg = (i == 0) ?\n\t\t\t\t\t\tB43_NPHY_AFECTL_OVER1 :\n\t\t\t\t\t\tB43_NPHY_AFECTL_OVER;\n\t\t\t\t\tb43_phy_set(dev, reg, 0x0200);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic void b43_nphy_rev2_rssi_select(struct b43_wldev *dev, u8 code,\n\t\t\t\t      enum n_rssi_type rssi_type)\n{\n\tu16 val;\n\tbool rssi_w1_w2_nb = false;\n\n\tswitch (rssi_type) {\n\tcase N_RSSI_W1:\n\tcase N_RSSI_W2:\n\tcase N_RSSI_NB:\n\t\tval = 0;\n\t\trssi_w1_w2_nb = true;\n\t\tbreak;\n\tcase N_RSSI_TBD:\n\t\tval = 1;\n\t\tbreak;\n\tcase N_RSSI_IQ:\n\t\tval = 2;\n\t\tbreak;\n\tdefault:\n\t\tval = 3;\n\t}\n\n\tval = (val << 12) | (val << 14);\n\tb43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, val);\n\tb43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, val);\n\n\tif (rssi_w1_w2_nb) {\n\t\tb43_phy_maskset(dev, B43_NPHY_RFCTL_RSSIO1, 0xFFCF,\n\t\t\t\t(rssi_type + 1) << 4);\n\t\tb43_phy_maskset(dev, B43_NPHY_RFCTL_RSSIO2, 0xFFCF,\n\t\t\t\t(rssi_type + 1) << 4);\n\t}\n\n\tif (code == 0) {\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_OVER, ~0x3000);\n\t\tif (rssi_w1_w2_nb) {\n\t\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\n\t\t\t\t~(B43_NPHY_RFCTL_CMD_RXEN |\n\t\t\t\t  B43_NPHY_RFCTL_CMD_CORESEL));\n\t\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_OVER,\n\t\t\t\t~(0x1 << 12 |\n\t\t\t\t  0x1 << 5 |\n\t\t\t\t  0x1 << 1 |\n\t\t\t\t  0x1));\n\t\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\n\t\t\t\t~B43_NPHY_RFCTL_CMD_START);\n\t\t\tudelay(20);\n\t\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_OVER, ~0x1);\n\t\t}\n\t} else {\n\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x3000);\n\t\tif (rssi_w1_w2_nb) {\n\t\t\tb43_phy_maskset(dev, B43_NPHY_RFCTL_CMD,\n\t\t\t\t~(B43_NPHY_RFCTL_CMD_RXEN |\n\t\t\t\t  B43_NPHY_RFCTL_CMD_CORESEL),\n\t\t\t\t(B43_NPHY_RFCTL_CMD_RXEN |\n\t\t\t\t code << B43_NPHY_RFCTL_CMD_CORESEL_SHIFT));\n\t\t\tb43_phy_set(dev, B43_NPHY_RFCTL_OVER,\n\t\t\t\t(0x1 << 12 |\n\t\t\t\t  0x1 << 5 |\n\t\t\t\t  0x1 << 1 |\n\t\t\t\t  0x1));\n\t\t\tb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\n\t\t\t\tB43_NPHY_RFCTL_CMD_START);\n\t\t\tudelay(20);\n\t\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_OVER, ~0x1);\n\t\t}\n\t}\n}\n\n \n\n\tif (dev->phy.rev >= 3) {\n\t\tsave_regs_phy[0] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);\n\t\tsave_regs_phy[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);\n\t\tsave_regs_phy[2] = b43_phy_read(dev,\n\t\t\t\t\t\tB43_NPHY_RFCTL_LUT_TRSW_UP1);\n\t\tsave_regs_phy[3] = b43_phy_read(dev,\n\t\t\t\t\t\tB43_NPHY_RFCTL_LUT_TRSW_UP2);\n\t\tsave_regs_phy[4] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER1);\n\t\tsave_regs_phy[5] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);\n\t\tsave_regs_phy[6] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B1S0);\n\t\tsave_regs_phy[7] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B32S1);\n\t\tsave_regs_phy[8] = 0;\n\t} else {\n\t\tsave_regs_phy[0] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);\n\t\tsave_regs_phy[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);\n\t\tsave_regs_phy[2] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);\n\t\tsave_regs_phy[3] = b43_phy_read(dev, B43_NPHY_RFCTL_CMD);\n\t\tsave_regs_phy[4] = b43_phy_read(dev, B43_NPHY_RFCTL_OVER);\n\t\tsave_regs_phy[5] = b43_phy_read(dev, B43_NPHY_RFCTL_RSSIO1);\n\t\tsave_regs_phy[6] = b43_phy_read(dev, B43_NPHY_RFCTL_RSSIO2);\n\t\tsave_regs_phy[7] = 0;\n\t\tsave_regs_phy[8] = 0;\n\t}\n\n\tb43_nphy_rssi_select(dev, 5, rssi_type);\n\n\tif (dev->phy.rev < 2) {\n\t\tsave_regs_phy[8] = b43_phy_read(dev, B43_NPHY_GPIO_SEL);\n\t\tb43_phy_write(dev, B43_NPHY_GPIO_SEL, 5);\n\t}\n\n\tfor (i = 0; i < 4; i++)\n\t\tbuf[i] = 0;\n\n\tfor (i = 0; i < nsamp; i++) {\n\t\tif (dev->phy.rev < 2) {\n\t\t\ts[0] = b43_phy_read(dev, B43_NPHY_GPIO_LOOUT);\n\t\t\ts[1] = b43_phy_read(dev, B43_NPHY_GPIO_HIOUT);\n\t\t} else {\n\t\t\ts[0] = b43_phy_read(dev, B43_NPHY_RSSI1);\n\t\t\ts[1] = b43_phy_read(dev, B43_NPHY_RSSI2);\n\t\t}\n\n\t\tbuf[0] += ((s8)((s[0] & 0x3F) << 2)) >> 2;\n\t\tbuf[1] += ((s8)(((s[0] >> 8) & 0x3F) << 2)) >> 2;\n\t\tbuf[2] += ((s8)((s[1] & 0x3F) << 2)) >> 2;\n\t\tbuf[3] += ((s8)(((s[1] >> 8) & 0x3F) << 2)) >> 2;\n\t}\n\tout = (buf[0] & 0xFF) << 24 | (buf[1] & 0xFF) << 16 |\n\t\t(buf[2] & 0xFF) << 8 | (buf[3] & 0xFF);\n\n\tif (dev->phy.rev < 2)\n\t\tb43_phy_write(dev, B43_NPHY_GPIO_SEL, save_regs_phy[8]);\n\n\tif (dev->phy.rev >= 3) {\n\t\tb43_phy_write(dev, B43_NPHY_AFECTL_C1, save_regs_phy[0]);\n\t\tb43_phy_write(dev, B43_NPHY_AFECTL_C2, save_regs_phy[1]);\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1,\n\t\t\t\tsave_regs_phy[2]);\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2,\n\t\t\t\tsave_regs_phy[3]);\n\t\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER1, save_regs_phy[4]);\n\t\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER, save_regs_phy[5]);\n\t\tb43_phy_write(dev, B43_NPHY_TXF_40CO_B1S0, save_regs_phy[6]);\n\t\tb43_phy_write(dev, B43_NPHY_TXF_40CO_B32S1, save_regs_phy[7]);\n\t} else {\n\t\tb43_phy_write(dev, B43_NPHY_AFECTL_C1, save_regs_phy[0]);\n\t\tb43_phy_write(dev, B43_NPHY_AFECTL_C2, save_regs_phy[1]);\n\t\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER, save_regs_phy[2]);\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_CMD, save_regs_phy[3]);\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_OVER, save_regs_phy[4]);\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_RSSIO1, save_regs_phy[5]);\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_RSSIO2, save_regs_phy[6]);\n\t}\n\n\treturn out;\n}\n\n \n\tu8 rx_core_state;\n\tint core, i, j, vcm;\n\n\tif (dev->phy.rev >= 7) {\n\t\tregs_to_store = regs_to_store_rev7;\n\t\tregs_amount = ARRAY_SIZE(regs_to_store_rev7);\n\t} else {\n\t\tregs_to_store = regs_to_store_rev3;\n\t\tregs_amount = ARRAY_SIZE(regs_to_store_rev3);\n\t}\n\tBUG_ON(regs_amount > ARRAY_SIZE(saved_regs_phy));\n\n\tclass = b43_nphy_classifier(dev, 0, 0);\n\tb43_nphy_classifier(dev, 7, 4);\n\tb43_nphy_read_clip_detection(dev, clip_state);\n\tb43_nphy_write_clip_detection(dev, clip_off);\n\n\tsaved_regs_phy_rfctl[0] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);\n\tsaved_regs_phy_rfctl[1] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);\n\tfor (i = 0; i < regs_amount; i++)\n\t\tsaved_regs_phy[i] = b43_phy_read(dev, regs_to_store[i]);\n\n\tb43_nphy_rf_ctl_intc_override(dev, N_INTC_OVERRIDE_OFF, 0, 7);\n\tb43_nphy_rf_ctl_intc_override(dev, N_INTC_OVERRIDE_TRSW, 1, 7);\n\n\tif (dev->phy.rev >= 7) {\n\t\tb43_nphy_rf_ctl_override_one_to_many(dev,\n\t\t\t\t\t\t     N_RF_CTL_OVER_CMD_RXRF_PU,\n\t\t\t\t\t\t     0, 0, false);\n\t\tb43_nphy_rf_ctl_override_one_to_many(dev,\n\t\t\t\t\t\t     N_RF_CTL_OVER_CMD_RX_PU,\n\t\t\t\t\t\t     1, 0, false);\n\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x80, 1, 0, false, 0);\n\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x40, 1, 0, false, 0);\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\n\t\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x20, 0, 0, false,\n\t\t\t\t\t\t      0);\n\t\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x10, 1, 0, false,\n\t\t\t\t\t\t      0);\n\t\t} else {\n\t\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x10, 0, 0, false,\n\t\t\t\t\t\t      0);\n\t\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x20, 1, 0, false,\n\t\t\t\t\t\t      0);\n\t\t}\n\t} else {\n\t\tb43_nphy_rf_ctl_override(dev, 0x1, 0, 0, false);\n\t\tb43_nphy_rf_ctl_override(dev, 0x2, 1, 0, false);\n\t\tb43_nphy_rf_ctl_override(dev, 0x80, 1, 0, false);\n\t\tb43_nphy_rf_ctl_override(dev, 0x40, 1, 0, false);\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\n\t\t\tb43_nphy_rf_ctl_override(dev, 0x20, 0, 0, false);\n\t\t\tb43_nphy_rf_ctl_override(dev, 0x10, 1, 0, false);\n\t\t} else {\n\t\t\tb43_nphy_rf_ctl_override(dev, 0x10, 0, 0, false);\n\t\t\tb43_nphy_rf_ctl_override(dev, 0x20, 1, 0, false);\n\t\t}\n\t}\n\n\trx_core_state = b43_nphy_get_rx_core_state(dev);\n\tfor (core = 0; core < 2; core++) {\n\t\tif (!(rx_core_state & (1 << core)))\n\t\t\tcontinue;\n\t\tr = core ? B2056_RX1 : B2056_RX0;\n\t\tb43_nphy_scale_offset_rssi(dev, 0, 0, core + 1, N_RAIL_I,\n\t\t\t\t\t   N_RSSI_NB);\n\t\tb43_nphy_scale_offset_rssi(dev, 0, 0, core + 1, N_RAIL_Q,\n\t\t\t\t\t   N_RSSI_NB);\n\n\t\t \n\t\tfor (vcm = 0; vcm < 8; vcm++) {\n\t\t\tif (dev->phy.rev >= 7)\n\t\t\t\tb43_radio_maskset(dev,\n\t\t\t\t\t\t  core ? R2057_NB_MASTER_CORE1 :\n\t\t\t\t\t\t\t R2057_NB_MASTER_CORE0,\n\t\t\t\t\t\t  ~R2057_VCM_MASK, vcm);\n\t\t\telse\n\t\t\t\tb43_radio_maskset(dev, r | B2056_RX_RSSI_MISC,\n\t\t\t\t\t\t  0xE3, vcm << 2);\n\t\t\tb43_nphy_poll_rssi(dev, N_RSSI_NB, results[vcm], 8);\n\t\t}\n\n\t\t \n\t\tfor (i = 0; i < 4; i += 2) {\n\t\t\ts32 currd;\n\t\t\ts32 mind = 0x100000;\n\t\t\ts32 minpoll = 249;\n\t\t\tu8 minvcm = 0;\n\t\t\tif (2 * core != i)\n\t\t\t\tcontinue;\n\t\t\tfor (vcm = 0; vcm < 8; vcm++) {\n\t\t\t\tcurrd = results[vcm][i] * results[vcm][i] +\n\t\t\t\t\tresults[vcm][i + 1] * results[vcm][i];\n\t\t\t\tif (currd < mind) {\n\t\t\t\t\tmind = currd;\n\t\t\t\t\tminvcm = vcm;\n\t\t\t\t}\n\t\t\t\tif (results[vcm][i] < minpoll)\n\t\t\t\t\tminpoll = results[vcm][i];\n\t\t\t}\n\t\t\tvcm_final = minvcm;\n\t\t\tresults_min[i] = minpoll;\n\t\t}\n\n\t\t \n\t\tif (dev->phy.rev >= 7)\n\t\t\tb43_radio_maskset(dev,\n\t\t\t\t\t  core ? R2057_NB_MASTER_CORE1 :\n\t\t\t\t\t\t R2057_NB_MASTER_CORE0,\n\t\t\t\t\t  ~R2057_VCM_MASK, vcm);\n\t\telse\n\t\t\tb43_radio_maskset(dev, r | B2056_RX_RSSI_MISC,\n\t\t\t\t\t  0xE3, vcm_final << 2);\n\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tif (core != i / 2)\n\t\t\t\tcontinue;\n\t\t\toffset[i] = -results[vcm_final][i];\n\t\t\tif (offset[i] < 0)\n\t\t\t\toffset[i] = -((abs(offset[i]) + 4) / 8);\n\t\t\telse\n\t\t\t\toffset[i] = (offset[i] + 4) / 8;\n\t\t\tif (results_min[i] == 248)\n\t\t\t\toffset[i] = -32;\n\t\t\tb43_nphy_scale_offset_rssi(dev, 0, offset[i],\n\t\t\t\t\t\t   (i / 2 == 0) ? 1 : 2,\n\t\t\t\t\t\t   (i % 2 == 0) ? N_RAIL_I : N_RAIL_Q,\n\t\t\t\t\t\t   N_RSSI_NB);\n\t\t}\n\t}\n\n\tfor (core = 0; core < 2; core++) {\n\t\tif (!(rx_core_state & (1 << core)))\n\t\t\tcontinue;\n\t\tfor (i = 0; i < 2; i++) {\n\t\t\tb43_nphy_scale_offset_rssi(dev, 0, 0, core + 1,\n\t\t\t\t\t\t   N_RAIL_I, i);\n\t\t\tb43_nphy_scale_offset_rssi(dev, 0, 0, core + 1,\n\t\t\t\t\t\t   N_RAIL_Q, i);\n\t\t\tb43_nphy_poll_rssi(dev, i, poll_results, 8);\n\t\t\tfor (j = 0; j < 4; j++) {\n\t\t\t\tif (j / 2 == core) {\n\t\t\t\t\toffset[j] = 232 - poll_results[j];\n\t\t\t\t\tif (offset[j] < 0)\n\t\t\t\t\t\toffset[j] = -(abs(offset[j] + 4) / 8);\n\t\t\t\t\telse\n\t\t\t\t\t\toffset[j] = (offset[j] + 4) / 8;\n\t\t\t\t\tb43_nphy_scale_offset_rssi(dev, 0,\n\t\t\t\t\t\toffset[2 * core], core + 1, j % 2, i);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, saved_regs_phy_rfctl[0]);\n\tb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, saved_regs_phy_rfctl[1]);\n\n\tb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\n\n\tb43_phy_set(dev, B43_NPHY_TXF_40CO_B1S1, 0x1);\n\tb43_phy_set(dev, B43_NPHY_RFCTL_CMD, B43_NPHY_RFCTL_CMD_START);\n\tb43_phy_mask(dev, B43_NPHY_TXF_40CO_B1S1, ~0x1);\n\n\tb43_phy_set(dev, B43_NPHY_RFCTL_OVER, 0x1);\n\tb43_phy_set(dev, B43_NPHY_RFCTL_CMD, B43_NPHY_RFCTL_CMD_RXTX);\n\tb43_phy_mask(dev, B43_NPHY_RFCTL_OVER, ~0x1);\n\n\tfor (i = 0; i < regs_amount; i++)\n\t\tb43_phy_write(dev, regs_to_store[i], saved_regs_phy[i]);\n\n\t \n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\trssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_2G;\n\t\trssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_2G;\n\t} else {\n\t\trssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_5G;\n\t\trssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_5G;\n\t}\n\tif (dev->phy.rev >= 7) {\n\t\trssical_radio_regs[0] = b43_radio_read(dev,\n\t\t\t\t\t\t       R2057_NB_MASTER_CORE0);\n\t\trssical_radio_regs[1] = b43_radio_read(dev,\n\t\t\t\t\t\t       R2057_NB_MASTER_CORE1);\n\t} else {\n\t\trssical_radio_regs[0] = b43_radio_read(dev, B2056_RX0 |\n\t\t\t\t\t\t       B2056_RX_RSSI_MISC);\n\t\trssical_radio_regs[1] = b43_radio_read(dev, B2056_RX1 |\n\t\t\t\t\t\t       B2056_RX_RSSI_MISC);\n\t}\n\trssical_phy_regs[0] = b43_phy_read(dev, B43_NPHY_RSSIMC_0I_RSSI_Z);\n\trssical_phy_regs[1] = b43_phy_read(dev, B43_NPHY_RSSIMC_0Q_RSSI_Z);\n\trssical_phy_regs[2] = b43_phy_read(dev, B43_NPHY_RSSIMC_1I_RSSI_Z);\n\trssical_phy_regs[3] = b43_phy_read(dev, B43_NPHY_RSSIMC_1Q_RSSI_Z);\n\trssical_phy_regs[4] = b43_phy_read(dev, B43_NPHY_RSSIMC_0I_RSSI_X);\n\trssical_phy_regs[5] = b43_phy_read(dev, B43_NPHY_RSSIMC_0Q_RSSI_X);\n\trssical_phy_regs[6] = b43_phy_read(dev, B43_NPHY_RSSIMC_1I_RSSI_X);\n\trssical_phy_regs[7] = b43_phy_read(dev, B43_NPHY_RSSIMC_1Q_RSSI_X);\n\trssical_phy_regs[8] = b43_phy_read(dev, B43_NPHY_RSSIMC_0I_RSSI_Y);\n\trssical_phy_regs[9] = b43_phy_read(dev, B43_NPHY_RSSIMC_0Q_RSSI_Y);\n\trssical_phy_regs[10] = b43_phy_read(dev, B43_NPHY_RSSIMC_1I_RSSI_Y);\n\trssical_phy_regs[11] = b43_phy_read(dev, B43_NPHY_RSSIMC_1Q_RSSI_Y);\n\n\t \n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\tnphy->rssical_chanspec_2G.center_freq = phy->chandef->chan->center_freq;\n\telse\n\t\tnphy->rssical_chanspec_5G.center_freq = phy->chandef->chan->center_freq;\n\n\t \n\tb43_nphy_classifier(dev, 7, class);\n\tb43_nphy_write_clip_detection(dev, clip_state);\n}\n\n \n\tb43_nphy_reset_cca(dev);\n}\n\n \nstatic void b43_nphy_rssi_cal(struct b43_wldev *dev)\n{\n\tif (dev->phy.rev >= 19) {\n\t\t \n\t} else if (dev->phy.rev >= 3) {\n\t\tb43_nphy_rev3_rssi_cal(dev);\n\t} else {\n\t\tb43_nphy_rev2_rssi_cal(dev, N_RSSI_NB);\n\t\tb43_nphy_rev2_rssi_cal(dev, N_RSSI_W1);\n\t\tb43_nphy_rev2_rssi_cal(dev, N_RSSI_W2);\n\t}\n}\n\n \n\nstatic void b43_nphy_gain_ctl_workarounds_rev19(struct b43_wldev *dev)\n{\n\t \n}\n\nstatic void b43_nphy_gain_ctl_workarounds_rev7(struct b43_wldev *dev)\n{\n\t \n}\n\nstatic void b43_nphy_gain_ctl_workarounds_rev3(struct b43_wldev *dev)\n{\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\n\tbool ghz5;\n\tbool ext_lna;\n\tu16 rssi_gain;\n\tstruct nphy_gain_ctl_workaround_entry *e;\n\tu8 lpf_gain[6] = { 0x00, 0x06, 0x0C, 0x12, 0x12, 0x12 };\n\tu8 lpf_bits[6] = { 0, 1, 2, 3, 3, 3 };\n\n\t \n\tghz5 = b43_phy_read(dev, B43_NPHY_BANDCTL)\n\t\t& B43_NPHY_BANDCTL_5GHZ;\n\text_lna = ghz5 ? sprom->boardflags_hi & B43_BFH_EXTLNA_5GHZ :\n\t\tsprom->boardflags_lo & B43_BFL_EXTLNA;\n\te = b43_nphy_get_gain_ctl_workaround_ent(dev, ghz5, ext_lna);\n\tif (ghz5 && dev->phy.rev >= 5)\n\t\trssi_gain = 0x90;\n\telse\n\t\trssi_gain = 0x50;\n\n\tb43_phy_set(dev, B43_NPHY_RXCTL, 0x0040);\n\n\t \n\tb43_phy_set(dev, B43_NPHY_C1_CGAINI, B43_NPHY_C1_CGAINI_CL2DETECT);\n\tb43_phy_set(dev, B43_NPHY_C2_CGAINI, B43_NPHY_C2_CGAINI_CL2DETECT);\n\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_BIASPOLE_LNAG1_IDAC,\n\t\t\t0x17);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_BIASPOLE_LNAG1_IDAC,\n\t\t\t0x17);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_LNAG2_IDAC, 0xF0);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_LNAG2_IDAC, 0xF0);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_RSSI_POLE, 0x00);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_RSSI_POLE, 0x00);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_RSSI_GAIN,\n\t\t\trssi_gain);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_RSSI_GAIN,\n\t\t\trssi_gain);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_BIASPOLE_LNAA1_IDAC,\n\t\t\t0x17);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_BIASPOLE_LNAA1_IDAC,\n\t\t\t0x17);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_LNAA2_IDAC, 0xFF);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_LNAA2_IDAC, 0xFF);\n\n\tb43_ntab_write_bulk(dev, B43_NTAB8(0, 8), 4, e->lna1_gain);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(1, 8), 4, e->lna1_gain);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(0, 16), 4, e->lna2_gain);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(1, 16), 4, e->lna2_gain);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(0, 32), 10, e->gain_db);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(1, 32), 10, e->gain_db);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(2, 32), 10, e->gain_bits);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(3, 32), 10, e->gain_bits);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(0, 0x40), 6, lpf_gain);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(1, 0x40), 6, lpf_gain);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(2, 0x40), 6, lpf_bits);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(3, 0x40), 6, lpf_bits);\n\n\tb43_phy_write(dev, B43_NPHY_REV3_C1_INITGAIN_A, e->init_gain);\n\tb43_phy_write(dev, B43_NPHY_REV3_C2_INITGAIN_A, e->init_gain);\n\n\tb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x106), 2,\n\t\t\t\te->rfseq_init);\n\n\tb43_phy_write(dev, B43_NPHY_REV3_C1_CLIP_HIGAIN_A, e->cliphi_gain);\n\tb43_phy_write(dev, B43_NPHY_REV3_C2_CLIP_HIGAIN_A, e->cliphi_gain);\n\tb43_phy_write(dev, B43_NPHY_REV3_C1_CLIP_MEDGAIN_A, e->clipmd_gain);\n\tb43_phy_write(dev, B43_NPHY_REV3_C2_CLIP_MEDGAIN_A, e->clipmd_gain);\n\tb43_phy_write(dev, B43_NPHY_REV3_C1_CLIP_LOGAIN_A, e->cliplo_gain);\n\tb43_phy_write(dev, B43_NPHY_REV3_C2_CLIP_LOGAIN_A, e->cliplo_gain);\n\n\tb43_phy_maskset(dev, B43_NPHY_CRSMINPOWER0, 0xFF00, e->crsmin);\n\tb43_phy_maskset(dev, B43_NPHY_CRSMINPOWERL0, 0xFF00, e->crsminl);\n\tb43_phy_maskset(dev, B43_NPHY_CRSMINPOWERU0, 0xFF00, e->crsminu);\n\tb43_phy_write(dev, B43_NPHY_C1_NBCLIPTHRES, e->nbclip);\n\tb43_phy_write(dev, B43_NPHY_C2_NBCLIPTHRES, e->nbclip);\n\tb43_phy_maskset(dev, B43_NPHY_C1_CLIPWBTHRES,\n\t\t\t~B43_NPHY_C1_CLIPWBTHRES_CLIP2, e->wlclip);\n\tb43_phy_maskset(dev, B43_NPHY_C2_CLIPWBTHRES,\n\t\t\t~B43_NPHY_C2_CLIPWBTHRES_CLIP2, e->wlclip);\n\tb43_phy_write(dev, B43_NPHY_CCK_SHIFTB_REF, 0x809C);\n}\n\nstatic void b43_nphy_gain_ctl_workarounds_rev1_2(struct b43_wldev *dev)\n{\n\tstruct b43_phy_n *nphy = dev->phy.n;\n\n\tu8 i, j;\n\tu8 code;\n\tu16 tmp;\n\tu8 rfseq_events[3] = { 6, 8, 7 };\n\tu8 rfseq_delays[3] = { 10, 30, 1 };\n\n\t \n\tb43_phy_set(dev, B43_NPHY_C1_CGAINI, B43_NPHY_C1_CGAINI_CL2DETECT);\n\tb43_phy_set(dev, B43_NPHY_C2_CGAINI, B43_NPHY_C2_CGAINI_CL2DETECT);\n\n\t \n\tb43_phy_write(dev, B43_NPHY_C1_NBCLIPTHRES, 0x84);\n\tb43_phy_write(dev, B43_NPHY_C2_NBCLIPTHRES, 0x84);\n\n\tif (!b43_is_40mhz(dev)) {\n\t\t \n\t\tb43_phy_write(dev, B43_NPHY_CLIP1_NBDWELL_LEN, 0x002B);\n\t\tb43_phy_write(dev, B43_NPHY_CLIP2_NBDWELL_LEN, 0x002B);\n\t\tb43_phy_write(dev, B43_NPHY_W1CLIP1_DWELL_LEN, 0x0009);\n\t\tb43_phy_write(dev, B43_NPHY_W1CLIP2_DWELL_LEN, 0x0009);\n\t}\n\n\t \n\tb43_phy_maskset(dev, B43_NPHY_C1_CLIPWBTHRES,\n\t\t\t~B43_NPHY_C1_CLIPWBTHRES_CLIP2, 21);\n\tb43_phy_maskset(dev, B43_NPHY_C2_CLIPWBTHRES,\n\t\t\t~B43_NPHY_C2_CLIPWBTHRES_CLIP2, 21);\n\n\tif (!b43_is_40mhz(dev)) {\n\t\tb43_phy_maskset(dev, B43_NPHY_C1_CGAINI,\n\t\t\t~B43_NPHY_C1_CGAINI_GAINBKOFF, 0x1);\n\t\tb43_phy_maskset(dev, B43_NPHY_C2_CGAINI,\n\t\t\t~B43_NPHY_C2_CGAINI_GAINBKOFF, 0x1);\n\t\tb43_phy_maskset(dev, B43_NPHY_C1_CCK_CGAINI,\n\t\t\t~B43_NPHY_C1_CCK_CGAINI_GAINBKOFF, 0x1);\n\t\tb43_phy_maskset(dev, B43_NPHY_C2_CCK_CGAINI,\n\t\t\t~B43_NPHY_C2_CCK_CGAINI_GAINBKOFF, 0x1);\n\t}\n\n\tb43_phy_write(dev, B43_NPHY_CCK_SHIFTB_REF, 0x809C);\n\n\tif (nphy->gain_boost) {\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ &&\n\t\t    b43_is_40mhz(dev))\n\t\t\tcode = 4;\n\t\telse\n\t\t\tcode = 5;\n\t} else {\n\t\tcode = b43_is_40mhz(dev) ? 6 : 7;\n\t}\n\n\t \n\tb43_phy_maskset(dev, B43_NPHY_C1_INITGAIN, ~B43_NPHY_C1_INITGAIN_HPVGA2,\n\t\t\tcode << B43_NPHY_C1_INITGAIN_HPVGA2_SHIFT);\n\tb43_phy_maskset(dev, B43_NPHY_C2_INITGAIN, ~B43_NPHY_C2_INITGAIN_HPVGA2,\n\t\t\tcode << B43_NPHY_C2_INITGAIN_HPVGA2_SHIFT);\n\n\tb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x1D06);\n\t \n\tfor (i = 0; i < 4; i++)\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, (code << 8 | 0x7C));\n\n\tb43_nphy_adjust_lna_gain_table(dev);\n\n\tif (nphy->elna_gain_config) {\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x0808);\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x0);\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\n\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x0C08);\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x0);\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\n\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x1D06);\n\t\t \n\t\tfor (i = 0; i < 4; i++)\n\t\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO,\n\t\t\t\t\t\t(code << 8 | 0x74));\n\t}\n\n\tif (dev->phy.rev == 2) {\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tb43_phy_write(dev, B43_NPHY_TABLE_ADDR,\n\t\t\t\t\t(0x0400 * i) + 0x0020);\n\t\t\tfor (j = 0; j < 21; j++) {\n\t\t\t\ttmp = j * (i < 2 ? 3 : 1);\n\t\t\t\tb43_phy_write(dev,\n\t\t\t\t\tB43_NPHY_TABLE_DATALO, tmp);\n\t\t\t}\n\t\t}\n\t}\n\n\tb43_nphy_set_rf_sequence(dev, 5, rfseq_events, rfseq_delays, 3);\n\tb43_phy_maskset(dev, B43_NPHY_OVER_DGAIN1,\n\t\t~B43_NPHY_OVER_DGAIN_CCKDGECV & 0xFFFF,\n\t\t0x5A << B43_NPHY_OVER_DGAIN_CCKDGECV_SHIFT);\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\tb43_phy_maskset(dev, B43_PHY_N(0xC5D), 0xFF80, 4);\n}\n\n \nstatic void b43_nphy_gain_ctl_workarounds(struct b43_wldev *dev)\n{\n\tif (dev->phy.rev >= 19)\n\t\tb43_nphy_gain_ctl_workarounds_rev19(dev);\n\telse if (dev->phy.rev >= 7)\n\t\tb43_nphy_gain_ctl_workarounds_rev7(dev);\n\telse if (dev->phy.rev >= 3)\n\t\tb43_nphy_gain_ctl_workarounds_rev3(dev);\n\telse\n\t\tb43_nphy_gain_ctl_workarounds_rev1_2(dev);\n}\n\nstatic void b43_nphy_workarounds_rev7plus(struct b43_wldev *dev)\n{\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\tstruct b43_phy *phy = &dev->phy;\n\n\t \n\tu8 tx2rx_events[7] = { 4, 3, 5, 2, 1, 8, 31, };\n\tu8 tx2rx_delays[7] = { 8, 4, 4, 4, 4, 6, 1, };\n\t \n\tu8 rx2tx_events_ipa[9] = { 0x0, 0x1, 0x2, 0x8, 0x5, 0x6, 0xF, 0x3,\n\t\t\t\t\t0x1F };\n\tu8 rx2tx_delays_ipa[9] = { 8, 6, 6, 4, 4, 16, 43, 1, 1 };\n\n\tstatic const u16 ntab7_15e_16e[] = { 0, 0x10f, 0x10f };\n\tu8 ntab7_138_146[] = { 0x11, 0x11 };\n\tu8 ntab7_133[] = { 0x77, 0x11, 0x11 };\n\n\tu16 lpf_ofdm_20mhz[2], lpf_ofdm_40mhz[2], lpf_11b[2];\n\tu16 bcap_val;\n\ts16 bcap_val_11b[2], bcap_val_11n_20[2], bcap_val_11n_40[2];\n\tu16 scap_val;\n\ts16 scap_val_11b[2], scap_val_11n_20[2], scap_val_11n_40[2];\n\tbool rccal_ovrd = false;\n\n\tu16 bias, conv, filt;\n\n\tu32 noise_tbl[2];\n\n\tu32 tmp32;\n\tu8 core;\n\n\tb43_phy_write(dev, B43_NPHY_PHASETR_A0, 0x0125);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_A1, 0x01b3);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_A2, 0x0105);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_B0, 0x016e);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_B1, 0x00cd);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_B2, 0x0020);\n\n\tif (phy->rev == 7) {\n\t\tb43_phy_set(dev, B43_NPHY_FINERX2_CGC, 0x10);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN0, 0xFF80, 0x0020);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN0, 0x80FF, 0x2700);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN1, 0xFF80, 0x002E);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN1, 0x80FF, 0x3300);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN2, 0xFF80, 0x0037);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN2, 0x80FF, 0x3A00);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN3, 0xFF80, 0x003C);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN3, 0x80FF, 0x3E00);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN4, 0xFF80, 0x003E);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN4, 0x80FF, 0x3F00);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN5, 0xFF80, 0x0040);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN5, 0x80FF, 0x4000);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN6, 0xFF80, 0x0040);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN6, 0x80FF, 0x4000);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN7, 0xFF80, 0x0040);\n\t\tb43_phy_maskset(dev, B43_NPHY_FREQGAIN7, 0x80FF, 0x4000);\n\t}\n\n\tif (phy->rev >= 16) {\n\t\tb43_phy_write(dev, B43_NPHY_FORCEFRONT0, 0x7ff);\n\t\tb43_phy_write(dev, B43_NPHY_FORCEFRONT1, 0x7ff);\n\t} else if (phy->rev <= 8) {\n\t\tb43_phy_write(dev, B43_NPHY_FORCEFRONT0, 0x1B0);\n\t\tb43_phy_write(dev, B43_NPHY_FORCEFRONT1, 0x1B0);\n\t}\n\n\tif (phy->rev >= 16)\n\t\tb43_phy_maskset(dev, B43_NPHY_TXTAILCNT, ~0xFF, 0xa0);\n\telse if (phy->rev >= 8)\n\t\tb43_phy_maskset(dev, B43_NPHY_TXTAILCNT, ~0xFF, 0x72);\n\n\tb43_ntab_write(dev, B43_NTAB16(8, 0x00), 2);\n\tb43_ntab_write(dev, B43_NTAB16(8, 0x10), 2);\n\ttmp32 = b43_ntab_read(dev, B43_NTAB32(30, 0));\n\ttmp32 &= 0xffffff;\n\tb43_ntab_write(dev, B43_NTAB32(30, 0), tmp32);\n\tb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x15d), 3, ntab7_15e_16e);\n\tb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x16d), 3, ntab7_15e_16e);\n\n\tb43_nphy_set_rf_sequence(dev, 1, tx2rx_events, tx2rx_delays,\n\t\t\t\t ARRAY_SIZE(tx2rx_events));\n\tif (b43_nphy_ipa(dev))\n\t\tb43_nphy_set_rf_sequence(dev, 0, rx2tx_events_ipa,\n\t\t\t\trx2tx_delays_ipa, ARRAY_SIZE(rx2tx_events_ipa));\n\n\tb43_phy_maskset(dev, B43_NPHY_EPS_OVERRIDEI_0, 0x3FFF, 0x4000);\n\tb43_phy_maskset(dev, B43_NPHY_EPS_OVERRIDEI_1, 0x3FFF, 0x4000);\n\n\tfor (core = 0; core < 2; core++) {\n\t\tlpf_ofdm_20mhz[core] = b43_nphy_read_lpf_ctl(dev, 0x154 + core * 0x10);\n\t\tlpf_ofdm_40mhz[core] = b43_nphy_read_lpf_ctl(dev, 0x159 + core * 0x10);\n\t\tlpf_11b[core] = b43_nphy_read_lpf_ctl(dev, 0x152 + core * 0x10);\n\t}\n\n\tbcap_val = b43_radio_read(dev, R2057_RCCAL_BCAP_VAL);\n\tscap_val = b43_radio_read(dev, R2057_RCCAL_SCAP_VAL);\n\n\tif (b43_nphy_ipa(dev)) {\n\t\tbool ghz2 = b43_current_band(dev->wl) == NL80211_BAND_2GHZ;\n\n\t\tswitch (phy->radio_rev) {\n\t\tcase 5:\n\t\t\t \n\t\t\tif (phy->rev == 8 && b43_is_40mhz(dev)) {\n\t\t\t\tfor (core = 0; core < 2; core++) {\n\t\t\t\t\tscap_val_11b[core] = scap_val;\n\t\t\t\t\tbcap_val_11b[core] = bcap_val;\n\t\t\t\t\tscap_val_11n_20[core] = scap_val;\n\t\t\t\t\tbcap_val_11n_20[core] = bcap_val;\n\t\t\t\t\tscap_val_11n_40[core] = 0xc;\n\t\t\t\t\tbcap_val_11n_40[core] = 0xc;\n\t\t\t\t}\n\n\t\t\t\trccal_ovrd = true;\n\t\t\t}\n\t\t\tif (phy->rev == 9) {\n\t\t\t\t \n\t\t\t}\n\t\t\tbreak;\n\t\tcase 7:\n\t\tcase 8:\n\t\t\tfor (core = 0; core < 2; core++) {\n\t\t\t\tscap_val_11b[core] = scap_val;\n\t\t\t\tbcap_val_11b[core] = bcap_val;\n\t\t\t\tlpf_ofdm_20mhz[core] = 4;\n\t\t\t\tlpf_11b[core] = 1;\n\t\t\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\t\t\tscap_val_11n_20[core] = 0xc;\n\t\t\t\t\tbcap_val_11n_20[core] = 0xc;\n\t\t\t\t\tscap_val_11n_40[core] = 0xa;\n\t\t\t\t\tbcap_val_11n_40[core] = 0xa;\n\t\t\t\t} else {\n\t\t\t\t\tscap_val_11n_20[core] = 0x14;\n\t\t\t\t\tbcap_val_11n_20[core] = 0x14;\n\t\t\t\t\tscap_val_11n_40[core] = 0xf;\n\t\t\t\t\tbcap_val_11n_40[core] = 0xf;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\trccal_ovrd = true;\n\t\t\tbreak;\n\t\tcase 9:\n\t\t\tfor (core = 0; core < 2; core++) {\n\t\t\t\tbcap_val_11b[core] = bcap_val;\n\t\t\t\tscap_val_11b[core] = scap_val;\n\t\t\t\tlpf_11b[core] = 1;\n\n\t\t\t\tif (ghz2) {\n\t\t\t\t\tbcap_val_11n_20[core] = bcap_val + 13;\n\t\t\t\t\tscap_val_11n_20[core] = scap_val + 15;\n\t\t\t\t} else {\n\t\t\t\t\tbcap_val_11n_20[core] = bcap_val + 14;\n\t\t\t\t\tscap_val_11n_20[core] = scap_val + 15;\n\t\t\t\t}\n\t\t\t\tlpf_ofdm_20mhz[core] = 4;\n\n\t\t\t\tif (ghz2) {\n\t\t\t\t\tbcap_val_11n_40[core] = bcap_val - 7;\n\t\t\t\t\tscap_val_11n_40[core] = scap_val - 5;\n\t\t\t\t} else {\n\t\t\t\t\tbcap_val_11n_40[core] = bcap_val + 2;\n\t\t\t\t\tscap_val_11n_40[core] = scap_val + 4;\n\t\t\t\t}\n\t\t\t\tlpf_ofdm_40mhz[core] = 4;\n\t\t\t}\n\n\t\t\trccal_ovrd = true;\n\t\t\tbreak;\n\t\tcase 14:\n\t\t\tfor (core = 0; core < 2; core++) {\n\t\t\t\tbcap_val_11b[core] = bcap_val;\n\t\t\t\tscap_val_11b[core] = scap_val;\n\t\t\t\tlpf_11b[core] = 1;\n\t\t\t}\n\n\t\t\tbcap_val_11n_20[0] = bcap_val + 20;\n\t\t\tscap_val_11n_20[0] = scap_val + 20;\n\t\t\tlpf_ofdm_20mhz[0] = 3;\n\n\t\t\tbcap_val_11n_20[1] = bcap_val + 16;\n\t\t\tscap_val_11n_20[1] = scap_val + 16;\n\t\t\tlpf_ofdm_20mhz[1] = 3;\n\n\t\t\tbcap_val_11n_40[0] = bcap_val + 20;\n\t\t\tscap_val_11n_40[0] = scap_val + 20;\n\t\t\tlpf_ofdm_40mhz[0] = 4;\n\n\t\t\tbcap_val_11n_40[1] = bcap_val + 10;\n\t\t\tscap_val_11n_40[1] = scap_val + 10;\n\t\t\tlpf_ofdm_40mhz[1] = 4;\n\n\t\t\trccal_ovrd = true;\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tif (phy->radio_rev == 5) {\n\t\t\tfor (core = 0; core < 2; core++) {\n\t\t\t\tlpf_ofdm_20mhz[core] = 1;\n\t\t\t\tlpf_ofdm_40mhz[core] = 3;\n\t\t\t\tscap_val_11b[core] = scap_val;\n\t\t\t\tbcap_val_11b[core] = bcap_val;\n\t\t\t\tscap_val_11n_20[core] = 0x11;\n\t\t\t\tscap_val_11n_40[core] = 0x11;\n\t\t\t\tbcap_val_11n_20[core] = 0x13;\n\t\t\t\tbcap_val_11n_40[core] = 0x13;\n\t\t\t}\n\n\t\t\trccal_ovrd = true;\n\t\t}\n\t}\n\tif (rccal_ovrd) {\n\t\tu16 rx2tx_lut_20_11b[2], rx2tx_lut_20_11n[2], rx2tx_lut_40_11n[2];\n\t\tu8 rx2tx_lut_extra = 1;\n\n\t\tfor (core = 0; core < 2; core++) {\n\t\t\tbcap_val_11b[core] = clamp_val(bcap_val_11b[core], 0, 0x1f);\n\t\t\tscap_val_11b[core] = clamp_val(scap_val_11b[core], 0, 0x1f);\n\t\t\tbcap_val_11n_20[core] = clamp_val(bcap_val_11n_20[core], 0, 0x1f);\n\t\t\tscap_val_11n_20[core] = clamp_val(scap_val_11n_20[core], 0, 0x1f);\n\t\t\tbcap_val_11n_40[core] = clamp_val(bcap_val_11n_40[core], 0, 0x1f);\n\t\t\tscap_val_11n_40[core] = clamp_val(scap_val_11n_40[core], 0, 0x1f);\n\n\t\t\trx2tx_lut_20_11b[core] = (rx2tx_lut_extra << 13) |\n\t\t\t\t\t\t (bcap_val_11b[core] << 8) |\n\t\t\t\t\t\t (scap_val_11b[core] << 3) |\n\t\t\t\t\t\t lpf_11b[core];\n\t\t\trx2tx_lut_20_11n[core] = (rx2tx_lut_extra << 13) |\n\t\t\t\t\t\t (bcap_val_11n_20[core] << 8) |\n\t\t\t\t\t\t (scap_val_11n_20[core] << 3) |\n\t\t\t\t\t\t lpf_ofdm_20mhz[core];\n\t\t\trx2tx_lut_40_11n[core] = (rx2tx_lut_extra << 13) |\n\t\t\t\t\t\t (bcap_val_11n_40[core] << 8) |\n\t\t\t\t\t\t (scap_val_11n_40[core] << 3) |\n\t\t\t\t\t\t lpf_ofdm_40mhz[core];\n\t\t}\n\n\t\tfor (core = 0; core < 2; core++) {\n\t\t\tb43_ntab_write(dev, B43_NTAB16(7, 0x152 + core * 16),\n\t\t\t\t       rx2tx_lut_20_11b[core]);\n\t\t\tb43_ntab_write(dev, B43_NTAB16(7, 0x153 + core * 16),\n\t\t\t\t       rx2tx_lut_20_11n[core]);\n\t\t\tb43_ntab_write(dev, B43_NTAB16(7, 0x154 + core * 16),\n\t\t\t\t       rx2tx_lut_20_11n[core]);\n\t\t\tb43_ntab_write(dev, B43_NTAB16(7, 0x155 + core * 16),\n\t\t\t\t       rx2tx_lut_40_11n[core]);\n\t\t\tb43_ntab_write(dev, B43_NTAB16(7, 0x156 + core * 16),\n\t\t\t\t       rx2tx_lut_40_11n[core]);\n\t\t\tb43_ntab_write(dev, B43_NTAB16(7, 0x157 + core * 16),\n\t\t\t\t       rx2tx_lut_40_11n[core]);\n\t\t\tb43_ntab_write(dev, B43_NTAB16(7, 0x158 + core * 16),\n\t\t\t\t       rx2tx_lut_40_11n[core]);\n\t\t\tb43_ntab_write(dev, B43_NTAB16(7, 0x159 + core * 16),\n\t\t\t\t       rx2tx_lut_40_11n[core]);\n\t\t}\n\t}\n\n\tb43_phy_write(dev, 0x32F, 0x3);\n\n\tif (phy->radio_rev == 4 || phy->radio_rev == 6)\n\t\tb43_nphy_rf_ctl_override_rev7(dev, 4, 1, 3, false, 0);\n\n\tif (phy->radio_rev == 3 || phy->radio_rev == 4 || phy->radio_rev == 6) {\n\t\tif (sprom->revision &&\n\t\t    sprom->boardflags2_hi & B43_BFH2_IPALVLSHIFT_3P3) {\n\t\t\tb43_radio_write(dev, 0x5, 0x05);\n\t\t\tb43_radio_write(dev, 0x6, 0x30);\n\t\t\tb43_radio_write(dev, 0x7, 0x00);\n\t\t\tb43_radio_set(dev, 0x4f, 0x1);\n\t\t\tb43_radio_set(dev, 0xd4, 0x1);\n\t\t\tbias = 0x1f;\n\t\t\tconv = 0x6f;\n\t\t\tfilt = 0xaa;\n\t\t} else {\n\t\t\tbias = 0x2b;\n\t\t\tconv = 0x7f;\n\t\t\tfilt = 0xee;\n\t\t}\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\tfor (core = 0; core < 2; core++) {\n\t\t\t\tif (core == 0) {\n\t\t\t\t\tb43_radio_write(dev, 0x5F, bias);\n\t\t\t\t\tb43_radio_write(dev, 0x64, conv);\n\t\t\t\t\tb43_radio_write(dev, 0x66, filt);\n\t\t\t\t} else {\n\t\t\t\t\tb43_radio_write(dev, 0xE8, bias);\n\t\t\t\t\tb43_radio_write(dev, 0xE9, conv);\n\t\t\t\t\tb43_radio_write(dev, 0xEB, filt);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif (b43_nphy_ipa(dev)) {\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\tif (phy->radio_rev == 3 || phy->radio_rev == 4 ||\n\t\t\t    phy->radio_rev == 6) {\n\t\t\t\tfor (core = 0; core < 2; core++) {\n\t\t\t\t\tif (core == 0)\n\t\t\t\t\t\tb43_radio_write(dev, 0x51,\n\t\t\t\t\t\t\t\t0x7f);\n\t\t\t\t\telse\n\t\t\t\t\t\tb43_radio_write(dev, 0xd6,\n\t\t\t\t\t\t\t\t0x7f);\n\t\t\t\t}\n\t\t\t}\n\t\t\tswitch (phy->radio_rev) {\n\t\t\tcase 3:\n\t\t\t\tfor (core = 0; core < 2; core++) {\n\t\t\t\t\tif (core == 0) {\n\t\t\t\t\t\tb43_radio_write(dev, 0x64,\n\t\t\t\t\t\t\t\t0x13);\n\t\t\t\t\t\tb43_radio_write(dev, 0x5F,\n\t\t\t\t\t\t\t\t0x1F);\n\t\t\t\t\t\tb43_radio_write(dev, 0x66,\n\t\t\t\t\t\t\t\t0xEE);\n\t\t\t\t\t\tb43_radio_write(dev, 0x59,\n\t\t\t\t\t\t\t\t0x8A);\n\t\t\t\t\t\tb43_radio_write(dev, 0x80,\n\t\t\t\t\t\t\t\t0x3E);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tb43_radio_write(dev, 0x69,\n\t\t\t\t\t\t\t\t0x13);\n\t\t\t\t\t\tb43_radio_write(dev, 0xE8,\n\t\t\t\t\t\t\t\t0x1F);\n\t\t\t\t\t\tb43_radio_write(dev, 0xEB,\n\t\t\t\t\t\t\t\t0xEE);\n\t\t\t\t\t\tb43_radio_write(dev, 0xDE,\n\t\t\t\t\t\t\t\t0x8A);\n\t\t\t\t\t\tb43_radio_write(dev, 0x105,\n\t\t\t\t\t\t\t\t0x3E);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 7:\n\t\t\tcase 8:\n\t\t\t\tif (!b43_is_40mhz(dev)) {\n\t\t\t\t\tb43_radio_write(dev, 0x5F, 0x14);\n\t\t\t\t\tb43_radio_write(dev, 0xE8, 0x12);\n\t\t\t\t} else {\n\t\t\t\t\tb43_radio_write(dev, 0x5F, 0x16);\n\t\t\t\t\tb43_radio_write(dev, 0xE8, 0x16);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\tcase 14:\n\t\t\t\tfor (core = 0; core < 2; core++) {\n\t\t\t\t\tint o = core ? 0x85 : 0;\n\n\t\t\t\t\tb43_radio_write(dev, o + R2057_IPA2G_CASCONV_CORE0, 0x13);\n\t\t\t\t\tb43_radio_write(dev, o + R2057_TXMIX2G_TUNE_BOOST_PU_CORE0, 0x21);\n\t\t\t\t\tb43_radio_write(dev, o + R2057_IPA2G_BIAS_FILTER_CORE0, 0xff);\n\t\t\t\t\tb43_radio_write(dev, o + R2057_PAD2G_IDACS_CORE0, 0x88);\n\t\t\t\t\tb43_radio_write(dev, o + R2057_PAD2G_TUNE_PUS_CORE0, 0x23);\n\t\t\t\t\tb43_radio_write(dev, o + R2057_IPA2G_IMAIN_CORE0, 0x16);\n\t\t\t\t\tb43_radio_write(dev, o + R2057_PAD_BIAS_FILTER_BWS_CORE0, 0x3e);\n\t\t\t\t\tb43_radio_write(dev, o + R2057_BACKUP1_CORE0, 0x10);\n\t\t\t\t}\n\t\t\t\tbreak;\n\t\t\t}\n\t\t} else {\n\t\t\tu16 freq = phy->chandef->chan->center_freq;\n\t\t\tif ((freq >= 5180 && freq <= 5230) ||\n\t\t\t    (freq >= 5745 && freq <= 5805)) {\n\t\t\t\tb43_radio_write(dev, 0x7D, 0xFF);\n\t\t\t\tb43_radio_write(dev, 0xFE, 0xFF);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tif (phy->radio_rev != 5) {\n\t\t\tfor (core = 0; core < 2; core++) {\n\t\t\t\tif (core == 0) {\n\t\t\t\t\tb43_radio_write(dev, 0x5c, 0x61);\n\t\t\t\t\tb43_radio_write(dev, 0x51, 0x70);\n\t\t\t\t} else {\n\t\t\t\t\tb43_radio_write(dev, 0xe1, 0x61);\n\t\t\t\t\tb43_radio_write(dev, 0xd6, 0x70);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif (phy->radio_rev == 4) {\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x05), 0x20);\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x15), 0x20);\n\t\tfor (core = 0; core < 2; core++) {\n\t\t\tif (core == 0) {\n\t\t\t\tb43_radio_write(dev, 0x1a1, 0x00);\n\t\t\t\tb43_radio_write(dev, 0x1a2, 0x3f);\n\t\t\t\tb43_radio_write(dev, 0x1a6, 0x3f);\n\t\t\t} else {\n\t\t\t\tb43_radio_write(dev, 0x1a7, 0x00);\n\t\t\t\tb43_radio_write(dev, 0x1ab, 0x3f);\n\t\t\t\tb43_radio_write(dev, 0x1ac, 0x3f);\n\t\t\t}\n\t\t}\n\t} else {\n\t\tb43_phy_set(dev, B43_NPHY_AFECTL_C1, 0x4);\n\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x4);\n\t\tb43_phy_set(dev, B43_NPHY_AFECTL_C2, 0x4);\n\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x4);\n\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_C1, ~0x1);\n\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x1);\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_C2, ~0x1);\n\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x1);\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x05), 0);\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x15), 0);\n\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_C1, ~0x4);\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_OVER1, ~0x4);\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_C2, ~0x4);\n\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_OVER, ~0x4);\n\t}\n\n\tb43_phy_write(dev, B43_NPHY_ENDROP_TLEN, 0x2);\n\n\tb43_ntab_write(dev, B43_NTAB32(16, 0x100), 20);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(7, 0x138), 2, ntab7_138_146);\n\tb43_ntab_write(dev, B43_NTAB16(7, 0x141), 0x77);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(7, 0x133), 3, ntab7_133);\n\tb43_ntab_write_bulk(dev, B43_NTAB8(7, 0x146), 2, ntab7_138_146);\n\tb43_ntab_write(dev, B43_NTAB16(7, 0x123), 0x77);\n\tb43_ntab_write(dev, B43_NTAB16(7, 0x12A), 0x77);\n\n\tb43_ntab_read_bulk(dev, B43_NTAB32(16, 0x02), 1, noise_tbl);\n\tnoise_tbl[1] = b43_is_40mhz(dev) ? 0x14D : 0x18D;\n\tb43_ntab_write_bulk(dev, B43_NTAB32(16, 0x02), 2, noise_tbl);\n\n\tb43_ntab_read_bulk(dev, B43_NTAB32(16, 0x7E), 1, noise_tbl);\n\tnoise_tbl[1] = b43_is_40mhz(dev) ? 0x14D : 0x18D;\n\tb43_ntab_write_bulk(dev, B43_NTAB32(16, 0x7E), 2, noise_tbl);\n\n\tb43_nphy_gain_ctl_workarounds(dev);\n\n\t \n}\n\nstatic void b43_nphy_workarounds_rev3plus(struct b43_wldev *dev)\n{\n\tstruct b43_phy_n *nphy = dev->phy.n;\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\n\t \n\tu8 tx2rx_events[7] = { 0x4, 0x3, 0x5, 0x2, 0x1, 0x8, 0x1F };\n\tu8 tx2rx_delays[7] = { 8, 4, 4, 4, 4, 6, 1 };\n\t \n\tu8 rx2tx_events_ipa[9] = { 0x0, 0x1, 0x2, 0x8, 0x5, 0x6, 0xF, 0x3,\n\t\t\t\t\t0x1F };\n\tu8 rx2tx_delays_ipa[9] = { 8, 6, 6, 4, 4, 16, 43, 1, 1 };\n\tu8 rx2tx_events[9] = { 0x0, 0x1, 0x2, 0x8, 0x5, 0x6, 0x3, 0x4, 0x1F };\n\tu8 rx2tx_delays[9] = { 8, 6, 6, 4, 4, 18, 42, 1, 1 };\n\n\tu16 vmids[5][4] = {\n\t\t{ 0xa2, 0xb4, 0xb4, 0x89, },  \n\t\t{ 0xb4, 0xb4, 0xb4, 0x24, },  \n\t\t{ 0xa2, 0xb4, 0xb4, 0x74, },  \n\t\t{ 0xa2, 0xb4, 0xb4, 0x270, },  \n\t\t{ 0xa2, 0xb4, 0xb4, 0x00, },  \n\t};\n\tu16 gains[5][4] = {\n\t\t{ 0x02, 0x02, 0x02, 0x00, },  \n\t\t{ 0x02, 0x02, 0x02, 0x02, },  \n\t\t{ 0x02, 0x02, 0x02, 0x04, },  \n\t\t{ 0x02, 0x02, 0x02, 0x00, },  \n\t\t{ 0x02, 0x02, 0x02, 0x00, },  \n\t};\n\tu16 *vmid, *gain;\n\n\tu8 pdet_range;\n\tu16 tmp16;\n\tu32 tmp32;\n\n\tb43_phy_write(dev, B43_NPHY_FORCEFRONT0, 0x1f8);\n\tb43_phy_write(dev, B43_NPHY_FORCEFRONT1, 0x1f8);\n\n\ttmp32 = b43_ntab_read(dev, B43_NTAB32(30, 0));\n\ttmp32 &= 0xffffff;\n\tb43_ntab_write(dev, B43_NTAB32(30, 0), tmp32);\n\n\tb43_phy_write(dev, B43_NPHY_PHASETR_A0, 0x0125);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_A1, 0x01B3);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_A2, 0x0105);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_B0, 0x016E);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_B1, 0x00CD);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_B2, 0x0020);\n\n\tb43_phy_write(dev, B43_NPHY_REV3_C1_CLIP_LOGAIN_B, 0x000C);\n\tb43_phy_write(dev, B43_NPHY_REV3_C2_CLIP_LOGAIN_B, 0x000C);\n\n\t \n\tb43_nphy_set_rf_sequence(dev, 1, tx2rx_events, tx2rx_delays,\n\t\t\t\t ARRAY_SIZE(tx2rx_events));\n\n\t \n\tif (b43_nphy_ipa(dev))\n\t\tb43_nphy_set_rf_sequence(dev, 0, rx2tx_events_ipa,\n\t\t\t\trx2tx_delays_ipa, ARRAY_SIZE(rx2tx_events_ipa));\n\tif (nphy->hw_phyrxchain != 3 &&\n\t    nphy->hw_phyrxchain != nphy->hw_phytxchain) {\n\t\tif (b43_nphy_ipa(dev)) {\n\t\t\trx2tx_delays[5] = 59;\n\t\t\trx2tx_delays[6] = 1;\n\t\t\trx2tx_events[7] = 0x1F;\n\t\t}\n\t\tb43_nphy_set_rf_sequence(dev, 0, rx2tx_events, rx2tx_delays,\n\t\t\t\t\t ARRAY_SIZE(rx2tx_events));\n\t}\n\n\ttmp16 = (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) ?\n\t\t0x2 : 0x9C40;\n\tb43_phy_write(dev, B43_NPHY_ENDROP_TLEN, tmp16);\n\n\tb43_phy_maskset(dev, B43_NPHY_SGILTRNOFFSET, 0xF0FF, 0x0700);\n\n\tif (!b43_is_40mhz(dev)) {\n\t\tb43_ntab_write(dev, B43_NTAB32(16, 3), 0x18D);\n\t\tb43_ntab_write(dev, B43_NTAB32(16, 127), 0x18D);\n\t} else {\n\t\tb43_ntab_write(dev, B43_NTAB32(16, 3), 0x14D);\n\t\tb43_ntab_write(dev, B43_NTAB32(16, 127), 0x14D);\n\t}\n\n\tb43_nphy_gain_ctl_workarounds(dev);\n\n\tb43_ntab_write(dev, B43_NTAB16(8, 0), 2);\n\tb43_ntab_write(dev, B43_NTAB16(8, 16), 2);\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\tpdet_range = sprom->fem.ghz2.pdet_range;\n\telse\n\t\tpdet_range = sprom->fem.ghz5.pdet_range;\n\tvmid = vmids[min_t(u16, pdet_range, 4)];\n\tgain = gains[min_t(u16, pdet_range, 4)];\n\tswitch (pdet_range) {\n\tcase 3:\n\t\tif (!(dev->phy.rev >= 4 &&\n\t\t      b43_current_band(dev->wl) == NL80211_BAND_2GHZ))\n\t\t\tbreak;\n\t\tfallthrough;\n\tcase 0:\n\tcase 1:\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x08), 4, vmid);\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x18), 4, vmid);\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x0c), 4, gain);\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x1c), 4, gain);\n\t\tbreak;\n\tcase 2:\n\t\tif (dev->phy.rev >= 6) {\n\t\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\t\t\tvmid[3] = 0x94;\n\t\t\telse\n\t\t\t\tvmid[3] = 0x8e;\n\t\t\tgain[3] = 3;\n\t\t} else if (dev->phy.rev == 5) {\n\t\t\tvmid[3] = 0x84;\n\t\t\tgain[3] = 2;\n\t\t}\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x08), 4, vmid);\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x18), 4, vmid);\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x0c), 4, gain);\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x1c), 4, gain);\n\t\tbreak;\n\tcase 4:\n\tcase 5:\n\t\tif (b43_current_band(dev->wl) != NL80211_BAND_2GHZ) {\n\t\t\tif (pdet_range == 4) {\n\t\t\t\tvmid[3] = 0x8e;\n\t\t\t\ttmp16 = 0x96;\n\t\t\t\tgain[3] = 0x2;\n\t\t\t} else {\n\t\t\t\tvmid[3] = 0x89;\n\t\t\t\ttmp16 = 0x89;\n\t\t\t\tgain[3] = 0;\n\t\t\t}\n\t\t} else {\n\t\t\tif (pdet_range == 4) {\n\t\t\t\tvmid[3] = 0x89;\n\t\t\t\ttmp16 = 0x8b;\n\t\t\t\tgain[3] = 0x2;\n\t\t\t} else {\n\t\t\t\tvmid[3] = 0x74;\n\t\t\t\ttmp16 = 0x70;\n\t\t\t\tgain[3] = 0;\n\t\t\t}\n\t\t}\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x08), 4, vmid);\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x0c), 4, gain);\n\t\tvmid[3] = tmp16;\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x18), 4, vmid);\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x1c), 4, gain);\n\t\tbreak;\n\t}\n\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXA_MAST_BIAS, 0x00);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXA_MAST_BIAS, 0x00);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXA_BIAS_MAIN, 0x06);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXA_BIAS_MAIN, 0x06);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXA_BIAS_AUX, 0x07);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXA_BIAS_AUX, 0x07);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXA_LOB_BIAS, 0x88);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXA_LOB_BIAS, 0x88);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXA_CMFB_IDAC, 0x00);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXA_CMFB_IDAC, 0x00);\n\tb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXG_CMFB_IDAC, 0x00);\n\tb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXG_CMFB_IDAC, 0x00);\n\n\t \n\n\tif ((sprom->boardflags2_lo & B43_BFL2_APLL_WAR &&\n\t     b43_current_band(dev->wl) == NL80211_BAND_5GHZ) ||\n\t    (sprom->boardflags2_lo & B43_BFL2_GPLL_WAR &&\n\t     b43_current_band(dev->wl) == NL80211_BAND_2GHZ))\n\t\ttmp32 = 0x00088888;\n\telse\n\t\ttmp32 = 0x88888888;\n\tb43_ntab_write(dev, B43_NTAB32(30, 1), tmp32);\n\tb43_ntab_write(dev, B43_NTAB32(30, 2), tmp32);\n\tb43_ntab_write(dev, B43_NTAB32(30, 3), tmp32);\n\n\tif (dev->phy.rev == 4 &&\n\t    b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\n\t\tb43_radio_write(dev, B2056_TX0 | B2056_TX_GMBB_IDAC,\n\t\t\t\t0x70);\n\t\tb43_radio_write(dev, B2056_TX1 | B2056_TX_GMBB_IDAC,\n\t\t\t\t0x70);\n\t}\n\n\t \n\tb43_phy_write(dev, B43_NPHY_ED_CRS40ASSERTTHRESH0, 0x03eb);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS40ASSERTTHRESH1, 0x03eb);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS40DEASSERTTHRESH0, 0x0341);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS40DEASSERTTHRESH1, 0x0341);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS20LASSERTTHRESH0, 0x042b);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS20LASSERTTHRESH1, 0x042b);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS20LDEASSERTTHRESH0, 0x0381);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS20LDEASSERTTHRESH1, 0x0381);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS20UASSERTTHRESH0, 0x042b);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS20UASSERTTHRESH1, 0x042b);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS20UDEASSERTTHRESH0, 0x0381);\n\tb43_phy_write(dev, B43_NPHY_ED_CRS20UDEASSERTTHRESH1, 0x0381);\n\n\tif (dev->phy.rev >= 6 && sprom->boardflags2_lo & B43_BFL2_SINGLEANT_CCK) {\n\t\t;  \n\t}\n}\n\nstatic void b43_nphy_workarounds_rev1_2(struct b43_wldev *dev)\n{\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_n *nphy = phy->n;\n\n\tu8 events1[7] = { 0x0, 0x1, 0x2, 0x8, 0x4, 0x5, 0x3 };\n\tu8 delays1[7] = { 0x8, 0x6, 0x6, 0x2, 0x4, 0x3C, 0x1 };\n\n\tu8 events2[7] = { 0x0, 0x3, 0x5, 0x4, 0x2, 0x1, 0x8 };\n\tu8 delays2[7] = { 0x8, 0x6, 0x2, 0x4, 0x4, 0x6, 0x1 };\n\n\tif (sprom->boardflags2_lo & B43_BFL2_SKWRKFEM_BRD ||\n\t    dev->dev->board_type == BCMA_BOARD_TYPE_BCM943224M93) {\n\t\tdelays1[0] = 0x1;\n\t\tdelays1[5] = 0x14;\n\t}\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ &&\n\t    nphy->band5g_pwrgain) {\n\t\tb43_radio_mask(dev, B2055_C1_TX_RF_SPARE, ~0x8);\n\t\tb43_radio_mask(dev, B2055_C2_TX_RF_SPARE, ~0x8);\n\t} else {\n\t\tb43_radio_set(dev, B2055_C1_TX_RF_SPARE, 0x8);\n\t\tb43_radio_set(dev, B2055_C2_TX_RF_SPARE, 0x8);\n\t}\n\n\tb43_ntab_write(dev, B43_NTAB16(8, 0x00), 0x000A);\n\tb43_ntab_write(dev, B43_NTAB16(8, 0x10), 0x000A);\n\tif (dev->phy.rev < 3) {\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x02), 0xCDAA);\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x12), 0xCDAA);\n\t}\n\n\tif (dev->phy.rev < 2) {\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x08), 0x0000);\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x18), 0x0000);\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x07), 0x7AAB);\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x17), 0x7AAB);\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x06), 0x0800);\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 0x16), 0x0800);\n\t}\n\n\tb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO1, 0x2D8);\n\tb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0x301);\n\tb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO2, 0x2D8);\n\tb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0x301);\n\n\tb43_nphy_set_rf_sequence(dev, 0, events1, delays1, 7);\n\tb43_nphy_set_rf_sequence(dev, 1, events2, delays2, 7);\n\n\tb43_nphy_gain_ctl_workarounds(dev);\n\n\tif (dev->phy.rev < 2) {\n\t\tif (b43_phy_read(dev, B43_NPHY_RXCTL) & 0x2)\n\t\t\tb43_hf_write(dev, b43_hf_read(dev) |\n\t\t\t\t\tB43_HF_MLADVW);\n\t} else if (dev->phy.rev == 2) {\n\t\tb43_phy_write(dev, B43_NPHY_CRSCHECK2, 0);\n\t\tb43_phy_write(dev, B43_NPHY_CRSCHECK3, 0);\n\t}\n\n\tif (dev->phy.rev < 2)\n\t\tb43_phy_mask(dev, B43_NPHY_SCRAM_SIGCTL,\n\t\t\t\t~B43_NPHY_SCRAM_SIGCTL_SCM);\n\n\t \n\tb43_phy_write(dev, B43_NPHY_PHASETR_A0, 0x125);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_A1, 0x1B3);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_A2, 0x105);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_B0, 0x16E);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_B1, 0xCD);\n\tb43_phy_write(dev, B43_NPHY_PHASETR_B2, 0x20);\n\n\tif (dev->phy.rev < 3) {\n\t\tb43_phy_mask(dev, B43_NPHY_PIL_DW1,\n\t\t\t     ~B43_NPHY_PIL_DW_64QAM & 0xFFFF);\n\t\tb43_phy_write(dev, B43_NPHY_TXF_20CO_S2B1, 0xB5);\n\t\tb43_phy_write(dev, B43_NPHY_TXF_20CO_S2B2, 0xA4);\n\t\tb43_phy_write(dev, B43_NPHY_TXF_20CO_S2B3, 0x00);\n\t}\n\n\tif (dev->phy.rev == 2)\n\t\tb43_phy_set(dev, B43_NPHY_FINERX2_CGC,\n\t\t\t\tB43_NPHY_FINERX2_CGC_DECGC);\n}\n\n \nstatic void b43_nphy_workarounds(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_n *nphy = phy->n;\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\n\t\tb43_nphy_classifier(dev, 1, 0);\n\telse\n\t\tb43_nphy_classifier(dev, 1, 1);\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, 1);\n\n\tb43_phy_set(dev, B43_NPHY_IQFLIP,\n\t\t    B43_NPHY_IQFLIP_ADC1 | B43_NPHY_IQFLIP_ADC2);\n\n\t \n\tif (dev->phy.rev >= 7)\n\t\tb43_nphy_workarounds_rev7plus(dev);\n\telse if (dev->phy.rev >= 3)\n\t\tb43_nphy_workarounds_rev3plus(dev);\n\telse\n\t\tb43_nphy_workarounds_rev1_2(dev);\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, 0);\n}\n\n \n\n \nstatic int b43_nphy_tx_tone(struct b43_wldev *dev, u32 freq, u16 max_val,\n\t\t\t    bool iqmode, bool dac_test, bool modify_bbmult)\n{\n\tu16 samp = b43_nphy_gen_load_samples(dev, freq, max_val, dac_test);\n\tif (samp == 0)\n\t\treturn -1;\n\tb43_nphy_run_samples(dev, samp, 0xFFFF, 0, iqmode, dac_test,\n\t\t\t     modify_bbmult);\n\treturn 0;\n}\n\n \nstatic void b43_nphy_update_txrx_chain(struct b43_wldev *dev)\n{\n\tstruct b43_phy_n *nphy = dev->phy.n;\n\n\tbool override = false;\n\tu16 chain = 0x33;\n\n\tif (nphy->txrx_chain == 0) {\n\t\tchain = 0x11;\n\t\toverride = true;\n\t} else if (nphy->txrx_chain == 1) {\n\t\tchain = 0x22;\n\t\toverride = true;\n\t}\n\n\tb43_phy_maskset(dev, B43_NPHY_RFSEQCA,\n\t\t\t~(B43_NPHY_RFSEQCA_TXEN | B43_NPHY_RFSEQCA_RXEN),\n\t\t\tchain);\n\n\tif (override)\n\t\tb43_phy_set(dev, B43_NPHY_RFSEQMODE,\n\t\t\t\tB43_NPHY_RFSEQMODE_CAOVER);\n\telse\n\t\tb43_phy_mask(dev, B43_NPHY_RFSEQMODE,\n\t\t\t\t~B43_NPHY_RFSEQMODE_CAOVER);\n}\n\n \nstatic void b43_nphy_stop_playback(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_n *nphy = dev->phy.n;\n\tu16 tmp;\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, 1);\n\n\ttmp = b43_phy_read(dev, B43_NPHY_SAMP_STAT);\n\tif (tmp & 0x1)\n\t\tb43_phy_set(dev, B43_NPHY_SAMP_CMD, B43_NPHY_SAMP_CMD_STOP);\n\telse if (tmp & 0x2)\n\t\tb43_phy_mask(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x7FFF);\n\n\tb43_phy_mask(dev, B43_NPHY_SAMP_CMD, ~0x0004);\n\n\tif (nphy->bb_mult_save & 0x80000000) {\n\t\ttmp = nphy->bb_mult_save & 0xFFFF;\n\t\tb43_ntab_write(dev, B43_NTAB16(15, 87), tmp);\n\t\tnphy->bb_mult_save = 0;\n\t}\n\n\tif (phy->rev >= 7 && nphy->lpf_bw_overrode_for_sample_play) {\n\t\tif (phy->rev >= 19)\n\t\t\tb43_nphy_rf_ctl_override_rev19(dev, 0x80, 0, 0, true,\n\t\t\t\t\t\t       1);\n\t\telse\n\t\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x80, 0, 0, true, 1);\n\t\tnphy->lpf_bw_overrode_for_sample_play = false;\n\t}\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, 0);\n}\n\n \nstatic void b43_nphy_iq_cal_gain_params(struct b43_wldev *dev, u16 core,\n\t\t\t\t\tstruct nphy_txgains target,\n\t\t\t\t\tstruct nphy_iqcal_params *params)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tint i, j, indx;\n\tu16 gain;\n\n\tif (dev->phy.rev >= 3) {\n\t\tparams->tx_lpf = target.tx_lpf[core];  \n\t\tparams->txgm = target.txgm[core];\n\t\tparams->pga = target.pga[core];\n\t\tparams->pad = target.pad[core];\n\t\tparams->ipa = target.ipa[core];\n\t\tif (phy->rev >= 19) {\n\t\t\t \n\t\t} else if (phy->rev >= 7) {\n\t\t\tparams->cal_gain = (params->txgm << 12) | (params->pga << 8) | (params->pad << 3) | (params->ipa) | (params->tx_lpf << 15);\n\t\t} else {\n\t\t\tparams->cal_gain = (params->txgm << 12) | (params->pga << 8) | (params->pad << 4) | (params->ipa);\n\t\t}\n\t\tfor (j = 0; j < 5; j++)\n\t\t\tparams->ncorr[j] = 0x79;\n\t} else {\n\t\tgain = (target.pad[core]) | (target.pga[core] << 4) |\n\t\t\t(target.txgm[core] << 8);\n\n\t\tindx = (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) ?\n\t\t\t1 : 0;\n\t\tfor (i = 0; i < 9; i++)\n\t\t\tif (tbl_iqcal_gainparams[indx][i][0] == gain)\n\t\t\t\tbreak;\n\t\ti = min(i, 8);\n\n\t\tparams->txgm = tbl_iqcal_gainparams[indx][i][1];\n\t\tparams->pga = tbl_iqcal_gainparams[indx][i][2];\n\t\tparams->pad = tbl_iqcal_gainparams[indx][i][3];\n\t\tparams->cal_gain = (params->txgm << 7) | (params->pga << 4) |\n\t\t\t\t\t(params->pad << 2);\n\t\tfor (j = 0; j < 4; j++)\n\t\t\tparams->ncorr[j] = tbl_iqcal_gainparams[indx][i][4 + j];\n\t}\n}\n\n \n\n \nstatic void b43_nphy_tx_power_ctrl(struct b43_wldev *dev, bool enable)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_n *nphy = dev->phy.n;\n\tu8 i;\n\tu16 bmask, val, tmp;\n\tenum nl80211_band band = b43_current_band(dev->wl);\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, 1);\n\n\tnphy->txpwrctrl = enable;\n\tif (!enable) {\n\t\tif (dev->phy.rev >= 3 &&\n\t\t    (b43_phy_read(dev, B43_NPHY_TXPCTL_CMD) &\n\t\t     (B43_NPHY_TXPCTL_CMD_COEFF |\n\t\t      B43_NPHY_TXPCTL_CMD_HWPCTLEN |\n\t\t      B43_NPHY_TXPCTL_CMD_PCTLEN))) {\n\t\t\t \n\t\t\tnphy->tx_pwr_idx[0] = b43_phy_read(dev,\n\t\t\t\t\t\tB43_NPHY_C1_TXPCTL_STAT) & 0x7f;\n\t\t\tnphy->tx_pwr_idx[1] = b43_phy_read(dev,\n\t\t\t\t\t\tB43_NPHY_C2_TXPCTL_STAT) & 0x7f;\n\t\t}\n\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x6840);\n\t\tfor (i = 0; i < 84; i++)\n\t\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0);\n\n\t\tb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x6C40);\n\t\tfor (i = 0; i < 84; i++)\n\t\t\tb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0);\n\n\t\ttmp = B43_NPHY_TXPCTL_CMD_COEFF | B43_NPHY_TXPCTL_CMD_HWPCTLEN;\n\t\tif (dev->phy.rev >= 3)\n\t\t\ttmp |= B43_NPHY_TXPCTL_CMD_PCTLEN;\n\t\tb43_phy_mask(dev, B43_NPHY_TXPCTL_CMD, ~tmp);\n\n\t\tif (dev->phy.rev >= 3) {\n\t\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x0100);\n\t\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0100);\n\t\t} else {\n\t\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x4000);\n\t\t}\n\n\t\tif (dev->phy.rev == 2)\n\t\t\tb43_phy_maskset(dev, B43_NPHY_BPHY_CTL3,\n\t\t\t\t~B43_NPHY_BPHY_CTL3_SCALE, 0x53);\n\t\telse if (dev->phy.rev < 2)\n\t\t\tb43_phy_maskset(dev, B43_NPHY_BPHY_CTL3,\n\t\t\t\t~B43_NPHY_BPHY_CTL3_SCALE, 0x5A);\n\n\t\tif (dev->phy.rev < 2 && b43_is_40mhz(dev))\n\t\t\tb43_hf_write(dev, b43_hf_read(dev) | B43_HF_TSSIRPSMW);\n\t} else {\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(26, 64), 84,\n\t\t\t\t    nphy->adj_pwr_tbl);\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(27, 64), 84,\n\t\t\t\t    nphy->adj_pwr_tbl);\n\n\t\tbmask = B43_NPHY_TXPCTL_CMD_COEFF |\n\t\t\tB43_NPHY_TXPCTL_CMD_HWPCTLEN;\n\t\t \n\t\tval = B43_NPHY_TXPCTL_CMD_COEFF | B43_NPHY_TXPCTL_CMD_HWPCTLEN;\n\t\tif (dev->phy.rev >= 3) {\n\t\t\tbmask |= B43_NPHY_TXPCTL_CMD_PCTLEN;\n\t\t\tif (val)\n\t\t\t\tval |= B43_NPHY_TXPCTL_CMD_PCTLEN;\n\t\t}\n\t\tb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD, ~(bmask), val);\n\n\t\tif (band == NL80211_BAND_5GHZ) {\n\t\t\tif (phy->rev >= 19) {\n\t\t\t\t \n\t\t\t} else if (phy->rev >= 7) {\n\t\t\t\tb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD,\n\t\t\t\t\t\t~B43_NPHY_TXPCTL_CMD_INIT,\n\t\t\t\t\t\t0x32);\n\t\t\t\tb43_phy_maskset(dev, B43_NPHY_TXPCTL_INIT,\n\t\t\t\t\t\t~B43_NPHY_TXPCTL_INIT_PIDXI1,\n\t\t\t\t\t\t0x32);\n\t\t\t} else {\n\t\t\t\tb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD,\n\t\t\t\t\t\t~B43_NPHY_TXPCTL_CMD_INIT,\n\t\t\t\t\t\t0x64);\n\t\t\t\tif (phy->rev > 1)\n\t\t\t\t\tb43_phy_maskset(dev,\n\t\t\t\t\t\t\tB43_NPHY_TXPCTL_INIT,\n\t\t\t\t\t\t\t~B43_NPHY_TXPCTL_INIT_PIDXI1,\n\t\t\t\t\t\t\t0x64);\n\t\t\t}\n\t\t}\n\n\t\tif (dev->phy.rev >= 3) {\n\t\t\tif (nphy->tx_pwr_idx[0] != 128 &&\n\t\t\t    nphy->tx_pwr_idx[1] != 128) {\n\t\t\t\t \n\t\t\t\tb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD,\n\t\t\t\t\t\t~B43_NPHY_TXPCTL_CMD_INIT,\n\t\t\t\t\t\tnphy->tx_pwr_idx[0]);\n\t\t\t\tif (dev->phy.rev > 1)\n\t\t\t\t\tb43_phy_maskset(dev,\n\t\t\t\t\t\tB43_NPHY_TXPCTL_INIT,\n\t\t\t\t\t\t~0xff, nphy->tx_pwr_idx[1]);\n\t\t\t}\n\t\t}\n\n\t\tif (phy->rev >= 7) {\n\t\t\t \n\t\t}\n\n\t\tif (dev->phy.rev >= 3) {\n\t\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_OVER1, ~0x100);\n\t\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_OVER, ~0x100);\n\t\t} else {\n\t\t\tb43_phy_mask(dev, B43_NPHY_AFECTL_OVER, ~0x4000);\n\t\t}\n\n\t\tif (dev->phy.rev == 2)\n\t\t\tb43_phy_maskset(dev, B43_NPHY_BPHY_CTL3, ~0xFF, 0x3b);\n\t\telse if (dev->phy.rev < 2)\n\t\t\tb43_phy_maskset(dev, B43_NPHY_BPHY_CTL3, ~0xFF, 0x40);\n\n\t\tif (dev->phy.rev < 2 && b43_is_40mhz(dev))\n\t\t\tb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_TSSIRPSMW);\n\n\t\tif (b43_nphy_ipa(dev)) {\n\t\t\tb43_phy_mask(dev, B43_NPHY_PAPD_EN0, ~0x4);\n\t\t\tb43_phy_mask(dev, B43_NPHY_PAPD_EN1, ~0x4);\n\t\t}\n\t}\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, 0);\n}\n\n \n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, 1);\n\n\t \n\tif (dev->phy.rev >= 7) {\n\t\ttxpi[0] = txpi[1] = 30;\n\t} else if (dev->phy.rev >= 3) {\n\t\ttxpi[0] = 40;\n\t\ttxpi[1] = 40;\n\t} else if (sprom->revision < 4) {\n\t\ttxpi[0] = 72;\n\t\ttxpi[1] = 72;\n\t} else {\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\ttxpi[0] = sprom->txpid2g[0];\n\t\t\ttxpi[1] = sprom->txpid2g[1];\n\t\t} else if (freq >= 4900 && freq < 5100) {\n\t\t\ttxpi[0] = sprom->txpid5gl[0];\n\t\t\ttxpi[1] = sprom->txpid5gl[1];\n\t\t} else if (freq >= 5100 && freq < 5500) {\n\t\t\ttxpi[0] = sprom->txpid5g[0];\n\t\t\ttxpi[1] = sprom->txpid5g[1];\n\t\t} else if (freq >= 5500) {\n\t\t\ttxpi[0] = sprom->txpid5gh[0];\n\t\t\ttxpi[1] = sprom->txpid5gh[1];\n\t\t} else {\n\t\t\ttxpi[0] = 91;\n\t\t\ttxpi[1] = 91;\n\t\t}\n\t}\n\tif (dev->phy.rev < 7 &&\n\t    (txpi[0] < 40 || txpi[0] > 100 || txpi[1] < 40 || txpi[1] > 100))\n\t\ttxpi[0] = txpi[1] = 91;\n\n\t \n\n\tfor (i = 0; i < 2; i++) {\n\t\tconst u32 *table = b43_nphy_get_tx_gain_table(dev);\n\n\t\tif (!table)\n\t\t\tbreak;\n\t\ttxgain = *(table + txpi[i]);\n\n\t\tif (dev->phy.rev >= 3)\n\t\t\tradio_gain = (txgain >> 16) & 0x1FFFF;\n\t\telse\n\t\t\tradio_gain = (txgain >> 16) & 0x1FFF;\n\n\t\tif (dev->phy.rev >= 7)\n\t\t\tdac_gain = (txgain >> 8) & 0x7;\n\t\telse\n\t\t\tdac_gain = (txgain >> 8) & 0x3F;\n\t\tbbmult = txgain & 0xFF;\n\n\t\tif (dev->phy.rev >= 3) {\n\t\t\tif (i == 0)\n\t\t\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x0100);\n\t\t\telse\n\t\t\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0100);\n\t\t} else {\n\t\t\tb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x4000);\n\t\t}\n\n\t\tif (i == 0)\n\t\t\tb43_phy_write(dev, B43_NPHY_AFECTL_DACGAIN1, dac_gain);\n\t\telse\n\t\t\tb43_phy_write(dev, B43_NPHY_AFECTL_DACGAIN2, dac_gain);\n\n\t\tb43_ntab_write(dev, B43_NTAB16(0x7, 0x110 + i), radio_gain);\n\n\t\ttmp = b43_ntab_read(dev, B43_NTAB16(0xF, 0x57));\n\t\tif (i == 0)\n\t\t\ttmp = (tmp & 0x00FF) | (bbmult << 8);\n\t\telse\n\t\t\ttmp = (tmp & 0xFF00) | bbmult;\n\t\tb43_ntab_write(dev, B43_NTAB16(0xF, 0x57), tmp);\n\n\t\tif (b43_nphy_ipa(dev)) {\n\t\t\tu32 tmp32;\n\t\t\tu16 reg = (i == 0) ?\n\t\t\t\tB43_NPHY_PAPD_EN0 : B43_NPHY_PAPD_EN1;\n\t\t\ttmp32 = b43_ntab_read(dev, B43_NTAB32(26 + i,\n\t\t\t\t\t\t\t      576 + txpi[i]));\n\t\t\tb43_phy_maskset(dev, reg, 0xE00F, (u32) tmp32 << 4);\n\t\t\tb43_phy_set(dev, reg, 0x4);\n\t\t}\n\t}\n\n\tb43_phy_mask(dev, B43_NPHY_BPHY_CTL2, ~B43_NPHY_BPHY_CTL2_LUT);\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, 0);\n}\n\nstatic void b43_nphy_ipa_internal_tssi_setup(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tu8 core;\n\tu16 r;  \n\n\tif (phy->rev >= 19) {\n\t\t \n\t} else if (phy->rev >= 7) {\n\t\tfor (core = 0; core < 2; core++) {\n\t\t\tr = core ? 0x190 : 0x170;\n\t\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\t\tb43_radio_write(dev, r + 0x5, 0x5);\n\t\t\t\tb43_radio_write(dev, r + 0x9, 0xE);\n\t\t\t\tif (phy->rev != 5)\n\t\t\t\t\tb43_radio_write(dev, r + 0xA, 0);\n\t\t\t\tif (phy->rev != 7)\n\t\t\t\t\tb43_radio_write(dev, r + 0xB, 1);\n\t\t\t\telse\n\t\t\t\t\tb43_radio_write(dev, r + 0xB, 0x31);\n\t\t\t} else {\n\t\t\t\tb43_radio_write(dev, r + 0x5, 0x9);\n\t\t\t\tb43_radio_write(dev, r + 0x9, 0xC);\n\t\t\t\tb43_radio_write(dev, r + 0xB, 0x0);\n\t\t\t\tif (phy->rev != 5)\n\t\t\t\t\tb43_radio_write(dev, r + 0xA, 1);\n\t\t\t\telse\n\t\t\t\t\tb43_radio_write(dev, r + 0xA, 0x31);\n\t\t\t}\n\t\t\tb43_radio_write(dev, r + 0x6, 0);\n\t\t\tb43_radio_write(dev, r + 0x7, 0);\n\t\t\tb43_radio_write(dev, r + 0x8, 3);\n\t\t\tb43_radio_write(dev, r + 0xC, 0);\n\t\t}\n\t} else {\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\t\tb43_radio_write(dev, B2056_SYN_RESERVED_ADDR31, 0x128);\n\t\telse\n\t\t\tb43_radio_write(dev, B2056_SYN_RESERVED_ADDR31, 0x80);\n\t\tb43_radio_write(dev, B2056_SYN_RESERVED_ADDR30, 0);\n\t\tb43_radio_write(dev, B2056_SYN_GPIO_MASTER1, 0x29);\n\n\t\tfor (core = 0; core < 2; core++) {\n\t\t\tr = core ? B2056_TX1 : B2056_TX0;\n\n\t\t\tb43_radio_write(dev, r | B2056_TX_IQCAL_VCM_HG, 0);\n\t\t\tb43_radio_write(dev, r | B2056_TX_IQCAL_IDAC, 0);\n\t\t\tb43_radio_write(dev, r | B2056_TX_TSSI_VCM, 3);\n\t\t\tb43_radio_write(dev, r | B2056_TX_TX_AMP_DET, 0);\n\t\t\tb43_radio_write(dev, r | B2056_TX_TSSI_MISC1, 8);\n\t\t\tb43_radio_write(dev, r | B2056_TX_TSSI_MISC2, 0);\n\t\t\tb43_radio_write(dev, r | B2056_TX_TSSI_MISC3, 0);\n\t\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\t\tb43_radio_write(dev, r | B2056_TX_TX_SSI_MASTER,\n\t\t\t\t\t\t0x5);\n\t\t\t\tif (phy->rev != 5)\n\t\t\t\t\tb43_radio_write(dev, r | B2056_TX_TSSIA,\n\t\t\t\t\t\t\t0x00);\n\t\t\t\tif (phy->rev >= 5)\n\t\t\t\t\tb43_radio_write(dev, r | B2056_TX_TSSIG,\n\t\t\t\t\t\t\t0x31);\n\t\t\t\telse\n\t\t\t\t\tb43_radio_write(dev, r | B2056_TX_TSSIG,\n\t\t\t\t\t\t\t0x11);\n\t\t\t\tb43_radio_write(dev, r | B2056_TX_TX_SSI_MUX,\n\t\t\t\t\t\t0xE);\n\t\t\t} else {\n\t\t\t\tb43_radio_write(dev, r | B2056_TX_TX_SSI_MASTER,\n\t\t\t\t\t\t0x9);\n\t\t\t\tb43_radio_write(dev, r | B2056_TX_TSSIA, 0x31);\n\t\t\t\tb43_radio_write(dev, r | B2056_TX_TSSIG, 0x0);\n\t\t\t\tb43_radio_write(dev, r | B2056_TX_TX_SSI_MUX,\n\t\t\t\t\t\t0xC);\n\t\t\t}\n\t\t}\n\t}\n}\n\n \nstatic void b43_nphy_tx_power_ctl_idle_tssi(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_n *nphy = dev->phy.n;\n\n\tu32 tmp;\n\ts32 rssi[4] = { };\n\n\tif (phy->chandef->chan->flags & IEEE80211_CHAN_NO_IR)\n\t\treturn;\n\n\tif (b43_nphy_ipa(dev))\n\t\tb43_nphy_ipa_internal_tssi_setup(dev);\n\n\tif (phy->rev >= 19)\n\t\tb43_nphy_rf_ctl_override_rev19(dev, 0x1000, 0, 3, false, 0);\n\telse if (phy->rev >= 7)\n\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x1000, 0, 3, false, 0);\n\telse if (phy->rev >= 3)\n\t\tb43_nphy_rf_ctl_override(dev, 0x2000, 0, 3, false);\n\n\tb43_nphy_stop_playback(dev);\n\tb43_nphy_tx_tone(dev, 4000, 0, false, false, false);\n\tudelay(20);\n\ttmp = b43_nphy_poll_rssi(dev, N_RSSI_TSSI_2G, rssi, 1);\n\tb43_nphy_stop_playback(dev);\n\n\tb43_nphy_rssi_select(dev, 0, N_RSSI_W1);\n\n\tif (phy->rev >= 19)\n\t\tb43_nphy_rf_ctl_override_rev19(dev, 0x1000, 0, 3, true, 0);\n\telse if (phy->rev >= 7)\n\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x1000, 0, 3, true, 0);\n\telse if (phy->rev >= 3)\n\t\tb43_nphy_rf_ctl_override(dev, 0x2000, 0, 3, true);\n\n\tif (phy->rev >= 19) {\n\t\t \n\t\treturn;\n\t} else if (phy->rev >= 3) {\n\t\tnphy->pwr_ctl_info[0].idle_tssi_5g = (tmp >> 24) & 0xFF;\n\t\tnphy->pwr_ctl_info[1].idle_tssi_5g = (tmp >> 8) & 0xFF;\n\t} else {\n\t\tnphy->pwr_ctl_info[0].idle_tssi_5g = (tmp >> 16) & 0xFF;\n\t\tnphy->pwr_ctl_info[1].idle_tssi_5g = tmp & 0xFF;\n\t}\n\tnphy->pwr_ctl_info[0].idle_tssi_2g = (tmp >> 24) & 0xFF;\n\tnphy->pwr_ctl_info[1].idle_tssi_2g = (tmp >> 8) & 0xFF;\n}\n\n \n\n\tfor (i = 0; i < 4; i++)\n\t\tnphy->adj_pwr_tbl[i] = nphy->tx_power_offset[i];\n\n\tfor (stf_mode = 0; stf_mode < 4; stf_mode++) {\n\t\tdelta = 0;\n\t\tswitch (stf_mode) {\n\t\tcase 0:\n\t\t\tif (b43_is_40mhz(dev) && dev->phy.rev >= 5) {\n\t\t\t\tidx = 68;\n\t\t\t} else {\n\t\t\t\tdelta = 1;\n\t\t\t\tidx = b43_is_40mhz(dev) ? 52 : 4;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tidx = b43_is_40mhz(dev) ? 76 : 28;\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tidx = b43_is_40mhz(dev) ? 84 : 36;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tidx = b43_is_40mhz(dev) ? 92 : 44;\n\t\t\tbreak;\n\t\t}\n\n\t\tfor (i = 0; i < 20; i++) {\n\t\t\tnphy->adj_pwr_tbl[4 + 4 * i + stf_mode] =\n\t\t\t\tnphy->tx_power_offset[idx];\n\t\t\tif (i == 0)\n\t\t\t\tidx += delta;\n\t\t\tif (i == 14)\n\t\t\t\tidx += 1 - delta;\n\t\t\tif (i == 3 || i == 4 || i == 7 || i == 8 || i == 11 ||\n\t\t\t    i == 13)\n\t\t\t\tidx += 1;\n\t\t}\n\t}\n}\n\n \n\tu8 i, c;\n\n\tif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12) {\n\t\tb43_maskset32(dev, B43_MMIO_MACCTL, ~0, 0x200000);\n\t\tb43_read32(dev, B43_MMIO_MACCTL);\n\t\tudelay(1);\n\t}\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, true);\n\n\tb43_phy_set(dev, B43_NPHY_TSSIMODE, B43_NPHY_TSSIMODE_EN);\n\tif (dev->phy.rev >= 3)\n\t\tb43_phy_mask(dev, B43_NPHY_TXPCTL_CMD,\n\t\t\t     ~B43_NPHY_TXPCTL_CMD_PCTLEN & 0xFFFF);\n\telse\n\t\tb43_phy_set(dev, B43_NPHY_TXPCTL_CMD,\n\t\t\t    B43_NPHY_TXPCTL_CMD_PCTLEN);\n\n\tif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12)\n\t\tb43_maskset32(dev, B43_MMIO_MACCTL, ~0x200000, 0);\n\n\tif (sprom->revision < 4) {\n\t\tidle[0] = nphy->pwr_ctl_info[0].idle_tssi_2g;\n\t\tidle[1] = nphy->pwr_ctl_info[1].idle_tssi_2g;\n\t\ttarget[0] = target[1] = 52;\n\t\ta1[0] = a1[1] = -424;\n\t\tb0[0] = b0[1] = 5612;\n\t\tb1[0] = b1[1] = -1393;\n\t} else {\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\tfor (c = 0; c < 2; c++) {\n\t\t\t\tidle[c] = nphy->pwr_ctl_info[c].idle_tssi_2g;\n\t\t\t\ttarget[c] = sprom->core_pwr_info[c].maxpwr_2g;\n\t\t\t\ta1[c] = sprom->core_pwr_info[c].pa_2g[0];\n\t\t\t\tb0[c] = sprom->core_pwr_info[c].pa_2g[1];\n\t\t\t\tb1[c] = sprom->core_pwr_info[c].pa_2g[2];\n\t\t\t}\n\t\t} else if (freq >= 4900 && freq < 5100) {\n\t\t\tfor (c = 0; c < 2; c++) {\n\t\t\t\tidle[c] = nphy->pwr_ctl_info[c].idle_tssi_5g;\n\t\t\t\ttarget[c] = sprom->core_pwr_info[c].maxpwr_5gl;\n\t\t\t\ta1[c] = sprom->core_pwr_info[c].pa_5gl[0];\n\t\t\t\tb0[c] = sprom->core_pwr_info[c].pa_5gl[1];\n\t\t\t\tb1[c] = sprom->core_pwr_info[c].pa_5gl[2];\n\t\t\t}\n\t\t} else if (freq >= 5100 && freq < 5500) {\n\t\t\tfor (c = 0; c < 2; c++) {\n\t\t\t\tidle[c] = nphy->pwr_ctl_info[c].idle_tssi_5g;\n\t\t\t\ttarget[c] = sprom->core_pwr_info[c].maxpwr_5g;\n\t\t\t\ta1[c] = sprom->core_pwr_info[c].pa_5g[0];\n\t\t\t\tb0[c] = sprom->core_pwr_info[c].pa_5g[1];\n\t\t\t\tb1[c] = sprom->core_pwr_info[c].pa_5g[2];\n\t\t\t}\n\t\t} else if (freq >= 5500) {\n\t\t\tfor (c = 0; c < 2; c++) {\n\t\t\t\tidle[c] = nphy->pwr_ctl_info[c].idle_tssi_5g;\n\t\t\t\ttarget[c] = sprom->core_pwr_info[c].maxpwr_5gh;\n\t\t\t\ta1[c] = sprom->core_pwr_info[c].pa_5gh[0];\n\t\t\t\tb0[c] = sprom->core_pwr_info[c].pa_5gh[1];\n\t\t\t\tb1[c] = sprom->core_pwr_info[c].pa_5gh[2];\n\t\t\t}\n\t\t} else {\n\t\t\tidle[0] = nphy->pwr_ctl_info[0].idle_tssi_5g;\n\t\t\tidle[1] = nphy->pwr_ctl_info[1].idle_tssi_5g;\n\t\t\ttarget[0] = target[1] = 52;\n\t\t\ta1[0] = a1[1] = -424;\n\t\t\tb0[0] = b0[1] = 5612;\n\t\t\tb1[0] = b1[1] = -1393;\n\t\t}\n\t}\n\n\tppr_max = b43_ppr_get_max(dev, &nphy->tx_pwr_max_ppr);\n\tif (ppr_max) {\n\t\ttarget[0] = ppr_max;\n\t\ttarget[1] = ppr_max;\n\t}\n\n\tif (dev->phy.rev >= 3) {\n\t\tif (sprom->fem.ghz2.tssipos)\n\t\t\tb43_phy_set(dev, B43_NPHY_TXPCTL_ITSSI, 0x4000);\n\t\tif (dev->phy.rev >= 7) {\n\t\t\tfor (c = 0; c < 2; c++) {\n\t\t\t\tr = c ? 0x190 : 0x170;\n\t\t\t\tif (b43_nphy_ipa(dev))\n\t\t\t\t\tb43_radio_write(dev, r + 0x9, (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) ? 0xE : 0xC);\n\t\t\t}\n\t\t} else {\n\t\t\tif (b43_nphy_ipa(dev)) {\n\t\t\t\ttmp = (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) ? 0xC : 0xE;\n\t\t\t\tb43_radio_write(dev,\n\t\t\t\t\tB2056_TX0 | B2056_TX_TX_SSI_MUX, tmp);\n\t\t\t\tb43_radio_write(dev,\n\t\t\t\t\tB2056_TX1 | B2056_TX_TX_SSI_MUX, tmp);\n\t\t\t} else {\n\t\t\t\tb43_radio_write(dev,\n\t\t\t\t\tB2056_TX0 | B2056_TX_TX_SSI_MUX, 0x11);\n\t\t\t\tb43_radio_write(dev,\n\t\t\t\t\tB2056_TX1 | B2056_TX_TX_SSI_MUX, 0x11);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12) {\n\t\tb43_maskset32(dev, B43_MMIO_MACCTL, ~0, 0x200000);\n\t\tb43_read32(dev, B43_MMIO_MACCTL);\n\t\tudelay(1);\n\t}\n\n\tif (phy->rev >= 19) {\n\t\t \n\t} else if (phy->rev >= 7) {\n\t\tb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD,\n\t\t\t\t~B43_NPHY_TXPCTL_CMD_INIT, 0x19);\n\t\tb43_phy_maskset(dev, B43_NPHY_TXPCTL_INIT,\n\t\t\t\t~B43_NPHY_TXPCTL_INIT_PIDXI1, 0x19);\n\t} else {\n\t\tb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD,\n\t\t\t\t~B43_NPHY_TXPCTL_CMD_INIT, 0x40);\n\t\tif (dev->phy.rev > 1)\n\t\t\tb43_phy_maskset(dev, B43_NPHY_TXPCTL_INIT,\n\t\t\t\t~B43_NPHY_TXPCTL_INIT_PIDXI1, 0x40);\n\t}\n\n\tif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12)\n\t\tb43_maskset32(dev, B43_MMIO_MACCTL, ~0x200000, 0);\n\n\tb43_phy_write(dev, B43_NPHY_TXPCTL_N,\n\t\t      0xF0 << B43_NPHY_TXPCTL_N_TSSID_SHIFT |\n\t\t      3 << B43_NPHY_TXPCTL_N_NPTIL2_SHIFT);\n\tb43_phy_write(dev, B43_NPHY_TXPCTL_ITSSI,\n\t\t      idle[0] << B43_NPHY_TXPCTL_ITSSI_0_SHIFT |\n\t\t      idle[1] << B43_NPHY_TXPCTL_ITSSI_1_SHIFT |\n\t\t      B43_NPHY_TXPCTL_ITSSI_BINF);\n\tb43_phy_write(dev, B43_NPHY_TXPCTL_TPWR,\n\t\t      target[0] << B43_NPHY_TXPCTL_TPWR_0_SHIFT |\n\t\t      target[1] << B43_NPHY_TXPCTL_TPWR_1_SHIFT);\n\n\tfor (c = 0; c < 2; c++) {\n\t\tfor (i = 0; i < 64; i++) {\n\t\t\tnum = 8 * (16 * b0[c] + b1[c] * i);\n\t\t\tden = 32768 + a1[c] * i;\n\t\t\tpwr = max((4 * num + den / 2) / den, -8);\n\t\t\tif (dev->phy.rev < 3 && (i <= (31 - idle[c] + 1)))\n\t\t\t\tpwr = max(pwr, target[c] + 1);\n\t\t\tregval[i] = pwr;\n\t\t}\n\t\tb43_ntab_write_bulk(dev, B43_NTAB32(26 + c, 0), 64, regval);\n\t}\n\n\tb43_nphy_tx_prepare_adjusted_power_table(dev);\n\tb43_ntab_write_bulk(dev, B43_NTAB16(26, 64), 84, nphy->adj_pwr_tbl);\n\tb43_ntab_write_bulk(dev, B43_NTAB16(27, 64), 84, nphy->adj_pwr_tbl);\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, false);\n}\n\nstatic void b43_nphy_tx_gain_table_upload(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\n\tconst u32 *table = NULL;\n\tu32 rfpwr_offset;\n\tu8 pga_gain, pad_gain;\n\tint i;\n\tconst s16 *rf_pwr_offset_table = NULL;\n\n\ttable = b43_nphy_get_tx_gain_table(dev);\n\tif (!table)\n\t\treturn;\n\n\tb43_ntab_write_bulk(dev, B43_NTAB32(26, 192), 128, table);\n\tb43_ntab_write_bulk(dev, B43_NTAB32(27, 192), 128, table);\n\n\tif (phy->rev < 3)\n\t\treturn;\n\n#if 0\n\tnphy->gmval = (table[0] >> 16) & 0x7000;\n#endif\n\n\tif (phy->rev >= 19) {\n\t\treturn;\n\t} else if (phy->rev >= 7) {\n\t\trf_pwr_offset_table = b43_ntab_get_rf_pwr_offset_table(dev);\n\t\tif (!rf_pwr_offset_table)\n\t\t\treturn;\n\t\t \n\t\treturn;\n\t}\n\n\tfor (i = 0; i < 128; i++) {\n\t\tif (phy->rev >= 19) {\n\t\t\t \n\t\t\treturn;\n\t\t} else if (phy->rev >= 7) {\n\t\t\tpga_gain = (table[i] >> 24) & 0xf;\n\t\t\tpad_gain = (table[i] >> 19) & 0x1f;\n\t\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\t\t\trfpwr_offset = rf_pwr_offset_table[pad_gain];\n\t\t\telse\n\t\t\t\trfpwr_offset = rf_pwr_offset_table[pga_gain];\n\t\t} else {\n\t\t\tpga_gain = (table[i] >> 24) & 0xF;\n\t\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\t\t\trfpwr_offset = b43_ntab_papd_pga_gain_delta_ipa_2g[pga_gain];\n\t\t\telse\n\t\t\t\trfpwr_offset = 0;  \n\t\t}\n\n\t\tb43_ntab_write(dev, B43_NTAB32(26, 576 + i), rfpwr_offset);\n\t\tb43_ntab_write(dev, B43_NTAB32(27, 576 + i), rfpwr_offset);\n\t}\n}\n\n \nstatic void b43_nphy_tx_lpf_bw(struct b43_wldev *dev)\n{\n\tu16 tmp;\n\n\tif (dev->phy.rev < 3 || dev->phy.rev >= 7)\n\t\treturn;\n\n\tif (b43_nphy_ipa(dev))\n\t\ttmp = b43_is_40mhz(dev) ? 5 : 4;\n\telse\n\t\ttmp = b43_is_40mhz(dev) ? 3 : 1;\n\tb43_phy_write(dev, B43_NPHY_TXF_40CO_B32S2,\n\t\t      (tmp << 9) | (tmp << 6) | (tmp << 3) | tmp);\n\n\tif (b43_nphy_ipa(dev)) {\n\t\ttmp = b43_is_40mhz(dev) ? 4 : 1;\n\t\tb43_phy_write(dev, B43_NPHY_TXF_40CO_B1S2,\n\t\t\t      (tmp << 9) | (tmp << 6) | (tmp << 3) | tmp);\n\t}\n}\n\n \n \nstatic void b43_nphy_restore_rssi_cal(struct b43_wldev *dev)\n{\n\tstruct b43_phy_n *nphy = dev->phy.n;\n\n\tu16 *rssical_radio_regs = NULL;\n\tu16 *rssical_phy_regs = NULL;\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\tif (!nphy->rssical_chanspec_2G.center_freq)\n\t\t\treturn;\n\t\trssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_2G;\n\t\trssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_2G;\n\t} else {\n\t\tif (!nphy->rssical_chanspec_5G.center_freq)\n\t\t\treturn;\n\t\trssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_5G;\n\t\trssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_5G;\n\t}\n\n\tif (dev->phy.rev >= 19) {\n\t\t \n\t} else if (dev->phy.rev >= 7) {\n\t\tb43_radio_maskset(dev, R2057_NB_MASTER_CORE0, ~R2057_VCM_MASK,\n\t\t\t\t  rssical_radio_regs[0]);\n\t\tb43_radio_maskset(dev, R2057_NB_MASTER_CORE1, ~R2057_VCM_MASK,\n\t\t\t\t  rssical_radio_regs[1]);\n\t} else {\n\t\tb43_radio_maskset(dev, B2056_RX0 | B2056_RX_RSSI_MISC, 0xE3,\n\t\t\t\t  rssical_radio_regs[0]);\n\t\tb43_radio_maskset(dev, B2056_RX1 | B2056_RX_RSSI_MISC, 0xE3,\n\t\t\t\t  rssical_radio_regs[1]);\n\t}\n\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_Z, rssical_phy_regs[0]);\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_Z, rssical_phy_regs[1]);\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_Z, rssical_phy_regs[2]);\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Z, rssical_phy_regs[3]);\n\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_X, rssical_phy_regs[4]);\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_X, rssical_phy_regs[5]);\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_X, rssical_phy_regs[6]);\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_X, rssical_phy_regs[7]);\n\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_Y, rssical_phy_regs[8]);\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_Y, rssical_phy_regs[9]);\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_Y, rssical_phy_regs[10]);\n\tb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Y, rssical_phy_regs[11]);\n}\n\nstatic void b43_nphy_tx_cal_radio_setup_rev19(struct b43_wldev *dev)\n{\n\t \n}\n\nstatic void b43_nphy_tx_cal_radio_setup_rev7(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_n *nphy = dev->phy.n;\n\tu16 *save = nphy->tx_rx_cal_radio_saveregs;\n\tint core, off;\n\tu16 r, tmp;\n\n\tfor (core = 0; core < 2; core++) {\n\t\tr = core ? 0x20 : 0;\n\t\toff = core * 11;\n\n\t\tsave[off + 0] = b43_radio_read(dev, r + R2057_TX0_TX_SSI_MASTER);\n\t\tsave[off + 1] = b43_radio_read(dev, r + R2057_TX0_IQCAL_VCM_HG);\n\t\tsave[off + 2] = b43_radio_read(dev, r + R2057_TX0_IQCAL_IDAC);\n\t\tsave[off + 3] = b43_radio_read(dev, r + R2057_TX0_TSSI_VCM);\n\t\tsave[off + 4] = 0;\n\t\tsave[off + 5] = b43_radio_read(dev, r + R2057_TX0_TX_SSI_MUX);\n\t\tif (phy->radio_rev != 5)\n\t\t\tsave[off + 6] = b43_radio_read(dev, r + R2057_TX0_TSSIA);\n\t\tsave[off + 7] = b43_radio_read(dev, r + R2057_TX0_TSSIG);\n\t\tsave[off + 8] = b43_radio_read(dev, r + R2057_TX0_TSSI_MISC1);\n\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\n\t\t\tb43_radio_write(dev, r + R2057_TX0_TX_SSI_MASTER, 0xA);\n\t\t\tb43_radio_write(dev, r + R2057_TX0_IQCAL_VCM_HG, 0x43);\n\t\t\tb43_radio_write(dev, r + R2057_TX0_IQCAL_IDAC, 0x55);\n\t\t\tb43_radio_write(dev, r + R2057_TX0_TSSI_VCM, 0);\n\t\t\tb43_radio_write(dev, r + R2057_TX0_TSSIG, 0);\n\t\t\tif (nphy->use_int_tx_iq_lo_cal) {\n\t\t\t\tb43_radio_write(dev, r + R2057_TX0_TX_SSI_MUX, 0x4);\n\t\t\t\ttmp = true ? 0x31 : 0x21;  \n\t\t\t\tb43_radio_write(dev, r + R2057_TX0_TSSIA, tmp);\n\t\t\t}\n\t\t\tb43_radio_write(dev, r + R2057_TX0_TSSI_MISC1, 0x00);\n\t\t} else {\n\t\t\tb43_radio_write(dev, r + R2057_TX0_TX_SSI_MASTER, 0x6);\n\t\t\tb43_radio_write(dev, r + R2057_TX0_IQCAL_VCM_HG, 0x43);\n\t\t\tb43_radio_write(dev, r + R2057_TX0_IQCAL_IDAC, 0x55);\n\t\t\tb43_radio_write(dev, r + R2057_TX0_TSSI_VCM, 0);\n\n\t\t\tif (phy->radio_rev != 5)\n\t\t\t\tb43_radio_write(dev, r + R2057_TX0_TSSIA, 0);\n\t\t\tif (nphy->use_int_tx_iq_lo_cal) {\n\t\t\t\tb43_radio_write(dev, r + R2057_TX0_TX_SSI_MUX, 0x6);\n\t\t\t\ttmp = true ? 0x31 : 0x21;  \n\t\t\t\tb43_radio_write(dev, r + R2057_TX0_TSSIG, tmp);\n\t\t\t}\n\t\t\tb43_radio_write(dev, r + R2057_TX0_TSSI_MISC1, 0);\n\t\t}\n\t}\n}\n\n \n\tstatic const u16 offset[] = { 0x186, 0x195, 0x2C5 };\n\tstatic const s16 dig_filter_phy_rev16[] = {\n\t\t-375, 136, -407, 208, -1527,\n\t\t956, 93, 186, 93, 230,\n\t\t-44, 230, 201, -191, 201,\n\t};\n\tint i;\n\n\tfor (i = 0; i < 3; i++)\n\t\tb43_nphy_pa_set_tx_dig_filter(dev, offset[i],\n\t\t\t\t\t      tbl_tx_filter_coef_rev4[i]);\n\n\t \n\tif (dev->phy.rev == 16)\n\t\tb43_nphy_pa_set_tx_dig_filter(dev, 0x186, dig_filter_phy_rev16);\n\n\t \n\tif (dev->phy.rev == 17) {\n\t\tb43_nphy_pa_set_tx_dig_filter(dev, 0x186, dig_filter_phy_rev16);\n\t\tb43_nphy_pa_set_tx_dig_filter(dev, 0x195,\n\t\t\t\t\t      tbl_tx_filter_coef_rev4[1]);\n\t}\n\n\tif (b43_is_40mhz(dev)) {\n\t\tb43_nphy_pa_set_tx_dig_filter(dev, 0x186,\n\t\t\t\t\t      tbl_tx_filter_coef_rev4[3]);\n\t} else {\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\n\t\t\tb43_nphy_pa_set_tx_dig_filter(dev, 0x186,\n\t\t\t\t\t\t      tbl_tx_filter_coef_rev4[5]);\n\t\tif (dev->phy.channel == 14)\n\t\t\tb43_nphy_pa_set_tx_dig_filter(dev, 0x186,\n\t\t\t\t\t\t      tbl_tx_filter_coef_rev4[6]);\n\t}\n}\n\n ) {\n\t\t\tif (phy->rev >= 19) {\n\t\t\t\tb43_nphy_rf_ctl_override_rev19(dev, 0x8, 0, 0x3,\n\t\t\t\t\t\t\t       false, 0);\n\t\t\t} else if (phy->rev >= 8) {\n\t\t\t\tb43_nphy_rf_ctl_override_rev7(dev, 0x8, 0, 0x3,\n\t\t\t\t\t\t\t      false, 0);\n\t\t\t} else if (phy->rev == 7) {\n\t\t\t\tb43_radio_maskset(dev, R2057_OVR_REG0, 1 << 4, 1 << 4);\n\t\t\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\t\t\t\tb43_radio_maskset(dev, R2057_PAD2G_TUNE_PUS_CORE0, ~1, 0);\n\t\t\t\t\tb43_radio_maskset(dev, R2057_PAD2G_TUNE_PUS_CORE1, ~1, 0);\n\t\t\t\t} else {\n\t\t\t\t\tb43_radio_maskset(dev, R2057_IPA5G_CASCOFFV_PU_CORE0, ~1, 0);\n\t\t\t\t\tb43_radio_maskset(dev, R2057_IPA5G_CASCOFFV_PU_CORE1, ~1, 0);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\tb43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, 0xA000);\n\t\tb43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, 0xA000);\n\t\ttmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);\n\t\tregs[2] = tmp;\n\t\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp | 0x3000);\n\t\ttmp = b43_ntab_read(dev, B43_NTAB16(8, 2));\n\t\tregs[3] = tmp;\n\t\ttmp |= 0x2000;\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 2), tmp);\n\t\ttmp = b43_ntab_read(dev, B43_NTAB16(8, 18));\n\t\tregs[4] = tmp;\n\t\ttmp |= 0x2000;\n\t\tb43_ntab_write(dev, B43_NTAB16(8, 18), tmp);\n\t\tregs[5] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);\n\t\tregs[6] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\n\t\t\ttmp = 0x0180;\n\t\telse\n\t\t\ttmp = 0x0120;\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, tmp);\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, tmp);\n\t}\n}\n\n \n\tif (phy->rev >= 19) {\n\t\t \n\t} else if (phy->rev >= 7) {\n\t\ttxcal_radio_regs[0] = b43_radio_read(dev,\n\t\t\t\t\t\t     R2057_TX0_LOFT_FINE_I);\n\t\ttxcal_radio_regs[1] = b43_radio_read(dev,\n\t\t\t\t\t\t     R2057_TX0_LOFT_FINE_Q);\n\t\ttxcal_radio_regs[4] = b43_radio_read(dev,\n\t\t\t\t\t\t     R2057_TX0_LOFT_COARSE_I);\n\t\ttxcal_radio_regs[5] = b43_radio_read(dev,\n\t\t\t\t\t\t     R2057_TX0_LOFT_COARSE_Q);\n\t\ttxcal_radio_regs[2] = b43_radio_read(dev,\n\t\t\t\t\t\t     R2057_TX1_LOFT_FINE_I);\n\t\ttxcal_radio_regs[3] = b43_radio_read(dev,\n\t\t\t\t\t\t     R2057_TX1_LOFT_FINE_Q);\n\t\ttxcal_radio_regs[6] = b43_radio_read(dev,\n\t\t\t\t\t\t     R2057_TX1_LOFT_COARSE_I);\n\t\ttxcal_radio_regs[7] = b43_radio_read(dev,\n\t\t\t\t\t\t     R2057_TX1_LOFT_COARSE_Q);\n\t} else if (phy->rev >= 3) {\n\t\ttxcal_radio_regs[0] = b43_radio_read(dev, 0x2021);\n\t\ttxcal_radio_regs[1] = b43_radio_read(dev, 0x2022);\n\t\ttxcal_radio_regs[2] = b43_radio_read(dev, 0x3021);\n\t\ttxcal_radio_regs[3] = b43_radio_read(dev, 0x3022);\n\t\ttxcal_radio_regs[4] = b43_radio_read(dev, 0x2023);\n\t\ttxcal_radio_regs[5] = b43_radio_read(dev, 0x2024);\n\t\ttxcal_radio_regs[6] = b43_radio_read(dev, 0x3023);\n\t\ttxcal_radio_regs[7] = b43_radio_read(dev, 0x3024);\n\t} else {\n\t\ttxcal_radio_regs[0] = b43_radio_read(dev, 0x8B);\n\t\ttxcal_radio_regs[1] = b43_radio_read(dev, 0xBA);\n\t\ttxcal_radio_regs[2] = b43_radio_read(dev, 0x8D);\n\t\ttxcal_radio_regs[3] = b43_radio_read(dev, 0xBC);\n\t}\n\tiqcal_chanspec->center_freq = dev->phy.chandef->chan->center_freq;\n\tiqcal_chanspec->channel_type =\n\t\t\t\tcfg80211_get_chandef_type(dev->phy.chandef);\n\tb43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 8, table);\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, 0);\n}\n\n \n\tif (phy->rev >= 19) {\n\t\t \n\t} else if (phy->rev >= 7) {\n\t\tb43_radio_write(dev, R2057_TX0_LOFT_FINE_I,\n\t\t\t\ttxcal_radio_regs[0]);\n\t\tb43_radio_write(dev, R2057_TX0_LOFT_FINE_Q,\n\t\t\t\ttxcal_radio_regs[1]);\n\t\tb43_radio_write(dev, R2057_TX0_LOFT_COARSE_I,\n\t\t\t\ttxcal_radio_regs[4]);\n\t\tb43_radio_write(dev, R2057_TX0_LOFT_COARSE_Q,\n\t\t\t\ttxcal_radio_regs[5]);\n\t\tb43_radio_write(dev, R2057_TX1_LOFT_FINE_I,\n\t\t\t\ttxcal_radio_regs[2]);\n\t\tb43_radio_write(dev, R2057_TX1_LOFT_FINE_Q,\n\t\t\t\ttxcal_radio_regs[3]);\n\t\tb43_radio_write(dev, R2057_TX1_LOFT_COARSE_I,\n\t\t\t\ttxcal_radio_regs[6]);\n\t\tb43_radio_write(dev, R2057_TX1_LOFT_COARSE_Q,\n\t\t\t\ttxcal_radio_regs[7]);\n\t} else if (phy->rev >= 3) {\n\t\tb43_radio_write(dev, 0x2021, txcal_radio_regs[0]);\n\t\tb43_radio_write(dev, 0x2022, txcal_radio_regs[1]);\n\t\tb43_radio_write(dev, 0x3021, txcal_radio_regs[2]);\n\t\tb43_radio_write(dev, 0x3022, txcal_radio_regs[3]);\n\t\tb43_radio_write(dev, 0x2023, txcal_radio_regs[4]);\n\t\tb43_radio_write(dev, 0x2024, txcal_radio_regs[5]);\n\t\tb43_radio_write(dev, 0x3023, txcal_radio_regs[6]);\n\t\tb43_radio_write(dev, 0x3024, txcal_radio_regs[7]);\n\t} else {\n\t\tb43_radio_write(dev, 0x8B, txcal_radio_regs[0]);\n\t\tb43_radio_write(dev, 0xBA, txcal_radio_regs[1]);\n\t\tb43_radio_write(dev, 0x8D, txcal_radio_regs[2]);\n\t\tb43_radio_write(dev, 0xBC, txcal_radio_regs[3]);\n\t}\n\tb43_nphy_rx_iq_coeffs(dev, true, rxcal_coeffs);\n}\n\n \n\t} else if (phy->rev >= 7) {\n\t\tb43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8AD9);\n\t} else {\n\t\tb43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8AA9);\n\t}\n\n\tif (!b43_is_40mhz(dev))\n\t\tfreq = 2500;\n\telse\n\t\tfreq = 5000;\n\n\tif (nphy->mphase_cal_phase_id > 2)\n\t\tb43_nphy_run_samples(dev, (b43_is_40mhz(dev) ? 40 : 20) * 8,\n\t\t\t\t     0xFFFF, 0, true, false, false);\n\telse\n\t\terror = b43_nphy_tx_tone(dev, freq, 250, true, false, false);\n\n\tif (error == 0) {\n\t\tif (nphy->mphase_cal_phase_id > 2) {\n\t\t\ttable = nphy->mphase_txcal_bestcoeffs;\n\t\t\tlength = 11;\n\t\t\tif (dev->phy.rev < 3)\n\t\t\t\tlength -= 2;\n\t\t} else {\n\t\t\tif (!full && nphy->txiqlocal_coeffsvalid) {\n\t\t\t\ttable = nphy->txiqlocal_bestc;\n\t\t\t\tlength = 11;\n\t\t\t\tif (dev->phy.rev < 3)\n\t\t\t\t\tlength -= 2;\n\t\t\t} else {\n\t\t\t\tfull = true;\n\t\t\t\tif (dev->phy.rev >= 3) {\n\t\t\t\t\ttable = tbl_tx_iqlo_cal_startcoefs_nphyrev3;\n\t\t\t\t\tlength = B43_NTAB_TX_IQLO_CAL_STARTCOEFS_REV3;\n\t\t\t\t} else {\n\t\t\t\t\ttable = tbl_tx_iqlo_cal_startcoefs;\n\t\t\t\t\tlength = B43_NTAB_TX_IQLO_CAL_STARTCOEFS;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tb43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length, table);\n\n\t\tif (full) {\n\t\t\tif (dev->phy.rev >= 3)\n\t\t\t\tmax = B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3;\n\t\t\telse\n\t\t\t\tmax = B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL;\n\t\t} else {\n\t\t\tif (dev->phy.rev >= 3)\n\t\t\t\tmax = B43_NTAB_TX_IQLO_CAL_CMDS_RECAL_REV3;\n\t\t\telse\n\t\t\t\tmax = B43_NTAB_TX_IQLO_CAL_CMDS_RECAL;\n\t\t}\n\n\t\tif (mphase) {\n\t\t\tcount = nphy->mphase_txcal_cmdidx;\n\t\t\tnumb = min(max,\n\t\t\t\t(u16)(count + nphy->mphase_txcal_numcmds));\n\t\t} else {\n\t\t\tcount = 0;\n\t\t\tnumb = max;\n\t\t}\n\n\t\tfor (; count < numb; count++) {\n\t\t\tif (full) {\n\t\t\t\tif (dev->phy.rev >= 3)\n\t\t\t\t\tcmd = tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3[count];\n\t\t\t\telse\n\t\t\t\t\tcmd = tbl_tx_iqlo_cal_cmds_fullcal[count];\n\t\t\t} else {\n\t\t\t\tif (dev->phy.rev >= 3)\n\t\t\t\t\tcmd = tbl_tx_iqlo_cal_cmds_recal_nphyrev3[count];\n\t\t\t\telse\n\t\t\t\t\tcmd = tbl_tx_iqlo_cal_cmds_recal[count];\n\t\t\t}\n\n\t\t\tcore = (cmd & 0x3000) >> 12;\n\t\t\ttype = (cmd & 0x0F00) >> 8;\n\n\t\t\tif (phy6or5x && !updated[core]) {\n\t\t\t\tb43_nphy_update_tx_cal_ladder(dev, core);\n\t\t\t\tupdated[core] = true;\n\t\t\t}\n\n\t\t\ttmp = (params[core].ncorr[type] << 8) | 0x66;\n\t\t\tb43_phy_write(dev, B43_NPHY_IQLOCAL_CMDNNUM, tmp);\n\n\t\t\tif (type == 1 || type == 3 || type == 4) {\n\t\t\t\tbuffer[0] = b43_ntab_read(dev,\n\t\t\t\t\t\tB43_NTAB16(15, 69 + core));\n\t\t\t\tdiq_start = buffer[0];\n\t\t\t\tbuffer[0] = 0;\n\t\t\t\tb43_ntab_write(dev, B43_NTAB16(15, 69 + core),\n\t\t\t\t\t\t0);\n\t\t\t}\n\n\t\t\tb43_phy_write(dev, B43_NPHY_IQLOCAL_CMD, cmd);\n\t\t\tfor (i = 0; i < 2000; i++) {\n\t\t\t\ttmp = b43_phy_read(dev, B43_NPHY_IQLOCAL_CMD);\n\t\t\t\tif (tmp & 0xC000)\n\t\t\t\t\tbreak;\n\t\t\t\tudelay(10);\n\t\t\t}\n\n\t\t\tb43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,\n\t\t\t\t\t\tbuffer);\n\t\t\tb43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length,\n\t\t\t\t\t\tbuffer);\n\n\t\t\tif (type == 1 || type == 3 || type == 4)\n\t\t\t\tbuffer[0] = diq_start;\n\t\t}\n\n\t\tif (mphase)\n\t\t\tnphy->mphase_txcal_cmdidx = (numb >= max) ? 0 : numb;\n\n\t\tlast = (dev->phy.rev < 3) ? 6 : 7;\n\n\t\tif (!mphase || nphy->mphase_cal_phase_id == last) {\n\t\t\tb43_ntab_write_bulk(dev, B43_NTAB16(15, 96), 4, buffer);\n\t\t\tb43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 4, buffer);\n\t\t\tif (dev->phy.rev < 3) {\n\t\t\t\tbuffer[0] = 0;\n\t\t\t\tbuffer[1] = 0;\n\t\t\t\tbuffer[2] = 0;\n\t\t\t\tbuffer[3] = 0;\n\t\t\t}\n\t\t\tb43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4,\n\t\t\t\t\t\tbuffer);\n\t\t\tb43_ntab_read_bulk(dev, B43_NTAB16(15, 101), 2,\n\t\t\t\t\t\tbuffer);\n\t\t\tb43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2,\n\t\t\t\t\t\tbuffer);\n\t\t\tb43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2,\n\t\t\t\t\t\tbuffer);\n\t\t\tlength = 11;\n\t\t\tif (dev->phy.rev < 3)\n\t\t\t\tlength -= 2;\n\t\t\tb43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,\n\t\t\t\t\t\tnphy->txiqlocal_bestc);\n\t\t\tnphy->txiqlocal_coeffsvalid = true;\n\t\t\tnphy->txiqlocal_chanspec.center_freq =\n\t\t\t\t\t\tphy->chandef->chan->center_freq;\n\t\t\tnphy->txiqlocal_chanspec.channel_type =\n\t\t\t\t\tcfg80211_get_chandef_type(phy->chandef);\n\t\t} else {\n\t\t\tlength = 11;\n\t\t\tif (dev->phy.rev < 3)\n\t\t\t\tlength -= 2;\n\t\t\tb43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,\n\t\t\t\t\t\tnphy->mphase_txcal_bestcoeffs);\n\t\t}\n\n\t\tb43_nphy_stop_playback(dev);\n\t\tb43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0);\n\t}\n\n\tb43_nphy_tx_cal_phy_cleanup(dev);\n\tb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, save);\n\n\tif (dev->phy.rev < 2 && (!mphase || nphy->mphase_cal_phase_id == last))\n\t\tb43_nphy_tx_iq_workaround(dev);\n\n\tif (dev->phy.rev >= 4)\n\t\tnphy->hang_avoid = avoid;\n\n\tb43_nphy_stay_in_carrier_search(dev, false);\n\n\treturn error;\n}\n\n \n\n\tnphy->phyrxchain = mask;\n\n\tif (0  )\n\t\treturn;\n\n\tb43_mac_suspend(dev);\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, true);\n\n\tb43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXEN,\n\t\t\t(mask & 0x3) << B43_NPHY_RFSEQCA_RXEN_SHIFT);\n\n\tif ((mask & 0x3) != 0x3) {\n\t\tb43_phy_write(dev, B43_NPHY_HPANT_SWTHRES, 1);\n\t\tif (dev->phy.rev >= 3) {\n\t\t\t \n\t\t}\n\t} else {\n\t\tb43_phy_write(dev, B43_NPHY_HPANT_SWTHRES, 0x1E);\n\t\tif (dev->phy.rev >= 3) {\n\t\t\t \n\t\t}\n\t}\n\n\tb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\n\n\tif (nphy->hang_avoid)\n\t\tb43_nphy_stay_in_carrier_search(dev, false);\n\n\tb43_mac_enable(dev);\n}\n\nstatic enum b43_txpwr_result b43_nphy_op_recalc_txpower(struct b43_wldev *dev,\n\t\t\t\t\t\t\tbool ignore_tssi)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_n *nphy = dev->phy.n;\n\tstruct ieee80211_channel *channel = dev->wl->hw->conf.chandef.chan;\n\tstruct b43_ppr *ppr = &nphy->tx_pwr_max_ppr;\n\tu8 max;  \n\n\tif (nphy->tx_pwr_last_recalc_freq == channel->center_freq &&\n\t    nphy->tx_pwr_last_recalc_limit == phy->desired_txpower)\n\t\treturn B43_TXPWR_RES_DONE;\n\n\t \n\tb43_ppr_clear(dev, ppr);\n\n\t \n\tb43_ppr_load_max_from_sprom(dev, ppr, B43_BAND_2G);\n\n\t \n\tmax = INT_TO_Q52(phy->chandef->chan->max_power);\n\tif (phy->desired_txpower)\n\t\tmax = min_t(u8, max, INT_TO_Q52(phy->desired_txpower));\n\tb43_ppr_apply_max(dev, ppr, max);\n\tif (b43_debug(dev, B43_DBG_XMITPOWER))\n\t\tb43dbg(dev->wl, \"Calculated TX power: \" Q52_FMT \"\\n\",\n\t\t       Q52_ARG(b43_ppr_get_max(dev, ppr)));\n\n\t \n#if 0\n\t \n\thw_gain = 6;  \n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\thw_gain += sprom->antenna_gain.a0;\n\telse\n\t\thw_gain += sprom->antenna_gain.a1;\n\tb43_ppr_add(dev, ppr, -hw_gain);\n#endif\n\n\t \n\tb43_ppr_apply_min(dev, ppr, INT_TO_Q52(8));\n\n\t \n\tb43_mac_suspend(dev);\n\tb43_nphy_tx_power_ctl_setup(dev);\n\tif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12) {\n\t\tb43_maskset32(dev, B43_MMIO_MACCTL, ~0, B43_MACCTL_PHY_LOCK);\n\t\tb43_read32(dev, B43_MMIO_MACCTL);\n\t\tudelay(1);\n\t}\n\tb43_nphy_tx_power_ctrl(dev, nphy->txpwrctrl);\n\tif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12)\n\t\tb43_maskset32(dev, B43_MMIO_MACCTL, ~B43_MACCTL_PHY_LOCK, 0);\n\tb43_mac_enable(dev);\n\n\tnphy->tx_pwr_last_recalc_freq = channel->center_freq;\n\tnphy->tx_pwr_last_recalc_limit = phy->desired_txpower;\n\n\treturn B43_TXPWR_RES_DONE;\n}\n\n \n\n ) {\n\t\t\tb43_ntab_write(dev, B43_NTAB16(9, 2), 0x211);\n\t\t\tb43_ntab_write(dev, B43_NTAB16(9, 3), 0x222);\n\t\t\tb43_ntab_write(dev, B43_NTAB16(9, 8), 0x144);\n\t\t\tb43_ntab_write(dev, B43_NTAB16(9, 12), 0x188);\n\t\t}\n\t} else {\n\t\tb43_phy_write(dev, B43_NPHY_GPIO_LOOEN, 0);\n\t\tb43_phy_write(dev, B43_NPHY_GPIO_HIOEN, 0);\n\n\t\tswitch (dev->dev->bus_type) {\n#ifdef CONFIG_B43_BCMA\n\t\tcase B43_BUS_BCMA:\n\t\t\tbcma_chipco_gpio_control(&dev->dev->bdev->bus->drv_cc,\n\t\t\t\t\t\t 0xFC00, 0xFC00);\n\t\t\tbreak;\n#endif\n#ifdef CONFIG_B43_SSB\n\t\tcase B43_BUS_SSB:\n\t\t\tssb_chipco_gpio_control(&dev->dev->sdev->bus->chipco,\n\t\t\t\t\t\t0xFC00, 0xFC00);\n\t\t\tbreak;\n#endif\n\t\t}\n\n\t\tb43_maskset32(dev, B43_MMIO_MACCTL, ~B43_MACCTL_GPOUTSMSK, 0);\n\t\tb43_maskset16(dev, B43_MMIO_GPIO_MASK, ~0, 0xFC00);\n\t\tb43_maskset16(dev, B43_MMIO_GPIO_CONTROL, (~0xFC00 & 0xFFFF),\n\t\t\t      0);\n\n\t\tif (init) {\n\t\t\tb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO1, 0x2D8);\n\t\t\tb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0x301);\n\t\t\tb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO2, 0x2D8);\n\t\t\tb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0x301);\n\t\t}\n\t}\n}\n\n \n\tif (dev->phy.rev >= 3) {\n\t\tb43_phy_write(dev, B43_NPHY_TXF_40CO_B1S1, 0);\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_OVER, 0);\n\t\tif (phy->rev >= 7) {\n\t\t\tb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER3, 0);\n\t\t\tb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER4, 0);\n\t\t\tb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER5, 0);\n\t\t\tb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER6, 0);\n\t\t}\n\t\tif (phy->rev >= 19) {\n\t\t\t \n\t\t}\n\n\t\tb43_phy_write(dev, B43_NPHY_TXF_40CO_B1S0, 0);\n\t\tb43_phy_write(dev, B43_NPHY_TXF_40CO_B32S1, 0);\n\t} else {\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_OVER, 0);\n\t}\n\tb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, 0);\n\tb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, 0);\n\tif (dev->phy.rev < 6) {\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_INTC3, 0);\n\t\tb43_phy_write(dev, B43_NPHY_RFCTL_INTC4, 0);\n\t}\n\tb43_phy_mask(dev, B43_NPHY_RFSEQMODE,\n\t\t     ~(B43_NPHY_RFSEQMODE_CAOVER |\n\t\t       B43_NPHY_RFSEQMODE_TROVER));\n\tif (dev->phy.rev >= 3)\n\t\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER1, 0);\n\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER, 0);\n\n\tif (dev->phy.rev <= 2) {\n\t\ttmp = (dev->phy.rev == 2) ? 0x3B : 0x40;\n\t\tb43_phy_maskset(dev, B43_NPHY_BPHY_CTL3,\n\t\t\t\t~B43_NPHY_BPHY_CTL3_SCALE,\n\t\t\t\ttmp << B43_NPHY_BPHY_CTL3_SCALE_SHIFT);\n\t}\n\tb43_phy_write(dev, B43_NPHY_AFESEQ_TX2RX_PUD_20M, 0x20);\n\tb43_phy_write(dev, B43_NPHY_AFESEQ_TX2RX_PUD_40M, 0x20);\n\n\tif (sprom->boardflags2_lo & B43_BFL2_SKWRKFEM_BRD ||\n\t    (dev->dev->board_vendor == PCI_VENDOR_ID_APPLE &&\n\t     dev->dev->board_type == BCMA_BOARD_TYPE_BCM943224M93))\n\t\tb43_phy_write(dev, B43_NPHY_TXREALFD, 0xA0);\n\telse\n\t\tb43_phy_write(dev, B43_NPHY_TXREALFD, 0xB8);\n\tb43_phy_write(dev, B43_NPHY_MIMO_CRSTXEXT, 0xC8);\n\tb43_phy_write(dev, B43_NPHY_PLOAD_CSENSE_EXTLEN, 0x50);\n\tb43_phy_write(dev, B43_NPHY_TXRIFS_FRDEL, 0x30);\n\n\tif (phy->rev < 8)\n\t\tb43_nphy_update_mimo_config(dev, nphy->preamble_override);\n\n\tb43_nphy_update_txrx_chain(dev);\n\n\tif (phy->rev < 2) {\n\t\tb43_phy_write(dev, B43_NPHY_DUP40_GFBL, 0xAA8);\n\t\tb43_phy_write(dev, B43_NPHY_DUP40_BL, 0x9A4);\n\t}\n\n\tif (b43_nphy_ipa(dev)) {\n\t\tb43_phy_set(dev, B43_NPHY_PAPD_EN0, 0x1);\n\t\tb43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ0, 0x007F,\n\t\t\t\tnphy->papd_epsilon_offset[0] << 7);\n\t\tb43_phy_set(dev, B43_NPHY_PAPD_EN1, 0x1);\n\t\tb43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ1, 0x007F,\n\t\t\t\tnphy->papd_epsilon_offset[1] << 7);\n\t\tb43_nphy_int_pa_set_tx_dig_filters(dev);\n\t} else if (phy->rev >= 5) {\n\t\tb43_nphy_ext_pa_set_tx_dig_filters(dev);\n\t}\n\n\tb43_nphy_workarounds(dev);\n\n\t \n\tb43_phy_force_clock(dev, 1);\n\ttmp = b43_phy_read(dev, B43_NPHY_BBCFG);\n\tb43_phy_write(dev, B43_NPHY_BBCFG, tmp | B43_NPHY_BBCFG_RSTCCA);\n\tb43_phy_write(dev, B43_NPHY_BBCFG, tmp & ~B43_NPHY_BBCFG_RSTCCA);\n\tb43_phy_force_clock(dev, 0);\n\n\tb43_mac_phy_clock_set(dev, true);\n\n\tif (phy->rev < 7) {\n\t\tb43_nphy_pa_override(dev, false);\n\t\tb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RX2TX);\n\t\tb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\n\t\tb43_nphy_pa_override(dev, true);\n\t}\n\n\tb43_nphy_classifier(dev, 0, 0);\n\tb43_nphy_read_clip_detection(dev, clip);\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\tb43_nphy_bphy_init(dev);\n\n\ttx_pwr_state = nphy->txpwrctrl;\n\tb43_nphy_tx_power_ctrl(dev, false);\n\tb43_nphy_tx_power_fix(dev);\n\tb43_nphy_tx_power_ctl_idle_tssi(dev);\n\tb43_nphy_tx_power_ctl_setup(dev);\n\tb43_nphy_tx_gain_table_upload(dev);\n\n\tif (nphy->phyrxchain != 3)\n\t\tb43_nphy_set_rx_core_state(dev, nphy->phyrxchain);\n\tif (nphy->mphase_cal_phase_id > 0) {\n\t\t; \n\t}\n\n\tdo_rssi_cal = false;\n\tif (phy->rev >= 3) {\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\t\tdo_rssi_cal = !nphy->rssical_chanspec_2G.center_freq;\n\t\telse\n\t\t\tdo_rssi_cal = !nphy->rssical_chanspec_5G.center_freq;\n\n\t\tif (do_rssi_cal)\n\t\t\tb43_nphy_rssi_cal(dev);\n\t\telse\n\t\t\tb43_nphy_restore_rssi_cal(dev);\n\t} else {\n\t\tb43_nphy_rssi_cal(dev);\n\t}\n\n\tif (!((nphy->measure_hold & 0x6) != 0)) {\n\t\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\t\tdo_cal = !nphy->iqcal_chanspec_2G.center_freq;\n\t\telse\n\t\t\tdo_cal = !nphy->iqcal_chanspec_5G.center_freq;\n\n\t\tif (nphy->mute)\n\t\t\tdo_cal = false;\n\n\t\tif (do_cal) {\n\t\t\ttarget = b43_nphy_get_tx_gains(dev);\n\n\t\t\tif (nphy->antsel_type == 2)\n\t\t\t\tb43_nphy_superswitch_init(dev, true);\n\t\t\tif (nphy->perical != 2) {\n\t\t\t\tb43_nphy_rssi_cal(dev);\n\t\t\t\tif (phy->rev >= 3) {\n\t\t\t\t\tnphy->cal_orig_pwr_idx[0] =\n\t\t\t\t\t    nphy->txpwrindex[0].index_internal;\n\t\t\t\t\tnphy->cal_orig_pwr_idx[1] =\n\t\t\t\t\t    nphy->txpwrindex[1].index_internal;\n\t\t\t\t\t \n\t\t\t\t\ttarget = b43_nphy_get_tx_gains(dev);\n\t\t\t\t}\n\t\t\t\tif (!b43_nphy_cal_tx_iq_lo(dev, target, true, false))\n\t\t\t\t\tif (b43_nphy_cal_rx_iq(dev, target, 2, 0) == 0)\n\t\t\t\t\t\tb43_nphy_save_cal(dev);\n\t\t\t} else if (nphy->mphase_cal_phase_id == 0) {\n\t\t\t\t; \n\t\t\t}\n\t\t} else {\n\t\t\tb43_nphy_restore_cal(dev);\n\t\t}\n\t}\n\n\tb43_nphy_tx_pwr_ctrl_coef_setup(dev);\n\tb43_nphy_tx_power_ctrl(dev, tx_pwr_state);\n\tb43_phy_write(dev, B43_NPHY_TXMACIF_HOLDOFF, 0x0015);\n\tb43_phy_write(dev, B43_NPHY_TXMACDELAY, 0x0320);\n\tif (phy->rev >= 3 && phy->rev <= 6)\n\t\tb43_phy_write(dev, B43_NPHY_PLOAD_CSENSE_EXTLEN, 0x0032);\n\tb43_nphy_tx_lpf_bw(dev);\n\tif (phy->rev >= 3)\n\t\tb43_nphy_spur_workaround(dev);\n\n\treturn 0;\n}\n\n \n\nstatic void b43_chantab_phy_upload(struct b43_wldev *dev,\n\t\t\t\t   const struct b43_phy_n_sfo_cfg *e)\n{\n\tb43_phy_write(dev, B43_NPHY_BW1A, e->phy_bw1a);\n\tb43_phy_write(dev, B43_NPHY_BW2, e->phy_bw2);\n\tb43_phy_write(dev, B43_NPHY_BW3, e->phy_bw3);\n\tb43_phy_write(dev, B43_NPHY_BW4, e->phy_bw4);\n\tb43_phy_write(dev, B43_NPHY_BW5, e->phy_bw5);\n\tb43_phy_write(dev, B43_NPHY_BW6, e->phy_bw6);\n}\n\n \n\t\tb43_phy_mask(dev, B43_NPHY_BANDCTL, ~B43_NPHY_BANDCTL_5GHZ);\n\n\t\ttmp16 = b43_read16(dev, B43_MMIO_PSM_PHY_HDR);\n\t\tb43_write16(dev, B43_MMIO_PSM_PHY_HDR, tmp16 | 4);\n\t\t \n\t\tb43_phy_set(dev, B43_PHY_B_BBCFG,\n\t\t\t    B43_PHY_B_BBCFG_RSTCCA | B43_PHY_B_BBCFG_RSTRX);\n\t\tb43_write16(dev, B43_MMIO_PSM_PHY_HDR, tmp16);\n\t\tb43_phy_set(dev, B43_NPHY_BANDCTL, B43_NPHY_BANDCTL_5GHZ);\n\t} else if (new_channel->band == NL80211_BAND_2GHZ) {\n\t\tb43_phy_mask(dev, B43_NPHY_BANDCTL, ~B43_NPHY_BANDCTL_5GHZ);\n\t\ttmp16 = b43_read16(dev, B43_MMIO_PSM_PHY_HDR);\n\t\tb43_write16(dev, B43_MMIO_PSM_PHY_HDR, tmp16 | 4);\n\t\t \n\t\tb43_phy_mask(dev, B43_PHY_B_BBCFG,\n\t\t\t     (u16)~(B43_PHY_B_BBCFG_RSTCCA | B43_PHY_B_BBCFG_RSTRX));\n\t\tb43_write16(dev, B43_MMIO_PSM_PHY_HDR, tmp16);\n\t}\n\n\tb43_chantab_phy_upload(dev, e);\n\n\tif (new_channel->hw_value == 14) {\n\t\tb43_nphy_classifier(dev, 2, 0);\n\t\tb43_phy_set(dev, B43_PHY_B_TEST, 0x0800);\n\t} else {\n\t\tb43_nphy_classifier(dev, 2, 2);\n\t\tif (new_channel->band == NL80211_BAND_2GHZ)\n\t\t\tb43_phy_mask(dev, B43_PHY_B_TEST, ~0x840);\n\t}\n\n\tif (!nphy->txpwrctrl)\n\t\tb43_nphy_tx_power_fix(dev);\n\n\tif (dev->phy.rev < 3)\n\t\tb43_nphy_adjust_lna_gain_table(dev);\n\n\tb43_nphy_tx_lpf_bw(dev);\n\n\tif (dev->phy.rev >= 3 &&\n\t    dev->phy.n->spur_avoid != B43_SPUR_AVOID_DISABLE) {\n\t\tu8 spuravoid = 0;\n\n\t\tif (dev->phy.n->spur_avoid == B43_SPUR_AVOID_FORCE) {\n\t\t\tspuravoid = 1;\n\t\t} else if (phy->rev >= 19) {\n\t\t\t \n\t\t} else if (phy->rev >= 18) {\n\t\t\t \n\t\t} else if (phy->rev >= 17) {\n\t\t\t \n\t\t} else if (phy->rev >= 16) {\n\t\t\t \n\t\t} else if (phy->rev >= 7) {\n\t\t\tif (!b43_is_40mhz(dev)) {  \n\t\t\t\tif (ch == 13 || ch == 14 || ch == 153)\n\t\t\t\t\tspuravoid = 1;\n\t\t\t} else {  \n\t\t\t\tif (ch == 54)\n\t\t\t\t\tspuravoid = 1;\n\t\t\t}\n\t\t} else {\n\t\t\tif (!b43_is_40mhz(dev)) {  \n\t\t\t\tif ((ch >= 5 && ch <= 8) || ch == 13 || ch == 14)\n\t\t\t\t\tspuravoid = 1;\n\t\t\t} else {  \n\t\t\t\tif (nphy->aband_spurwar_en &&\n\t\t\t\t    (ch == 38 || ch == 102 || ch == 118))\n\t\t\t\t\tspuravoid = dev->dev->chip_id == 0x4716;\n\t\t\t}\n\t\t}\n\n\t\tb43_nphy_pmu_spur_avoid(dev, spuravoid);\n\n\t\tb43_mac_switch_freq(dev, spuravoid);\n\n\t\tif (dev->phy.rev == 3 || dev->phy.rev == 4)\n\t\t\tb43_wireless_core_phy_pll_reset(dev);\n\n\t\tif (spuravoid)\n\t\t\tb43_phy_set(dev, B43_NPHY_BBCFG, B43_NPHY_BBCFG_RSTRX);\n\t\telse\n\t\t\tb43_phy_mask(dev, B43_NPHY_BBCFG,\n\t\t\t\t     ~B43_NPHY_BBCFG_RSTRX & 0xFFFF);\n\n\t\tb43_nphy_reset_cca(dev);\n\n\t\t \n\t}\n\n\tb43_phy_write(dev, B43_NPHY_NDATAT_DUP40, 0x3830);\n\n\tif (phy->rev >= 3)\n\t\tb43_nphy_spur_workaround(dev);\n}\n\n \n\t} else if (phy->rev >= 7) {\n\t\tr2057_get_chantabent_rev7(dev, channel->center_freq,\n\t\t\t\t\t  &tabent_r7, &tabent_r7_2g);\n\t\tif (!tabent_r7 && !tabent_r7_2g)\n\t\t\treturn -ESRCH;\n\t} else if (phy->rev >= 3) {\n\t\ttabent_r3 = b43_nphy_get_chantabent_rev3(dev,\n\t\t\t\t\t\t\tchannel->center_freq);\n\t\tif (!tabent_r3)\n\t\t\treturn -ESRCH;\n\t} else {\n\t\ttabent_r2 = b43_nphy_get_chantabent_rev2(dev,\n\t\t\t\t\t\t\tchannel->hw_value);\n\t\tif (!tabent_r2)\n\t\t\treturn -ESRCH;\n\t}\n\n\t \n\tphy->channel = channel->hw_value;\n\n#if 0\n\tif (b43_channel_type_is_40mhz(phy->channel_type) !=\n\t\tb43_channel_type_is_40mhz(channel_type))\n\t\t;  \n#endif\n\n\tif (channel_type == NL80211_CHAN_HT40PLUS) {\n\t\tb43_phy_set(dev, B43_NPHY_RXCTL, B43_NPHY_RXCTL_BSELU20);\n\t\tif (phy->rev >= 7)\n\t\t\tb43_phy_set(dev, 0x310, 0x8000);\n\t} else if (channel_type == NL80211_CHAN_HT40MINUS) {\n\t\tb43_phy_mask(dev, B43_NPHY_RXCTL, ~B43_NPHY_RXCTL_BSELU20);\n\t\tif (phy->rev >= 7)\n\t\t\tb43_phy_mask(dev, 0x310, (u16)~0x8000);\n\t}\n\n\tif (phy->rev >= 19) {\n\t\t \n\t} else if (phy->rev >= 7) {\n\t\tconst struct b43_phy_n_sfo_cfg *phy_regs = tabent_r7 ?\n\t\t\t&(tabent_r7->phy_regs) : &(tabent_r7_2g->phy_regs);\n\n\t\tif (phy->radio_rev <= 4 || phy->radio_rev == 6) {\n\t\t\ttmp = (channel->band == NL80211_BAND_5GHZ) ? 2 : 0;\n\t\t\tb43_radio_maskset(dev, R2057_TIA_CONFIG_CORE0, ~2, tmp);\n\t\t\tb43_radio_maskset(dev, R2057_TIA_CONFIG_CORE1, ~2, tmp);\n\t\t}\n\n\t\tb43_radio_2057_setup(dev, tabent_r7, tabent_r7_2g);\n\t\tb43_nphy_channel_setup(dev, phy_regs, channel);\n\t} else if (phy->rev >= 3) {\n\t\ttmp = (channel->band == NL80211_BAND_5GHZ) ? 4 : 0;\n\t\tb43_radio_maskset(dev, 0x08, 0xFFFB, tmp);\n\t\tb43_radio_2056_setup(dev, tabent_r3);\n\t\tb43_nphy_channel_setup(dev, &(tabent_r3->phy_regs), channel);\n\t} else {\n\t\ttmp = (channel->band == NL80211_BAND_5GHZ) ? 0x0020 : 0x0050;\n\t\tb43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, tmp);\n\t\tb43_radio_2055_setup(dev, tabent_r2);\n\t\tb43_nphy_channel_setup(dev, &(tabent_r2->phy_regs), channel);\n\t}\n\n\treturn 0;\n}\n\n \n\nstatic int b43_nphy_op_allocate(struct b43_wldev *dev)\n{\n\tstruct b43_phy_n *nphy;\n\n\tnphy = kzalloc(sizeof(*nphy), GFP_KERNEL);\n\tif (!nphy)\n\t\treturn -ENOMEM;\n\n\tdev->phy.n = nphy;\n\n\treturn 0;\n}\n\nstatic void b43_nphy_op_prepare_structs(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_n *nphy = phy->n;\n\tstruct ssb_sprom *sprom = dev->dev->bus_sprom;\n\n\tmemset(nphy, 0, sizeof(*nphy));\n\n\tnphy->hang_avoid = (phy->rev == 3 || phy->rev == 4);\n\tnphy->spur_avoid = (phy->rev >= 3) ?\n\t\t\t\tB43_SPUR_AVOID_AUTO : B43_SPUR_AVOID_DISABLE;\n\tnphy->gain_boost = true;  \n\tnphy->txrx_chain = 2;  \n\tnphy->phyrxchain = 3;  \n\tnphy->perical = 2;  \n\t \n\tnphy->tx_pwr_idx[0] = 128;\n\tnphy->tx_pwr_idx[1] = 128;\n\n\t \n\tnphy->txpwrctrl = false;\n\tnphy->pwg_gain_5ghz = false;\n\tif (dev->phy.rev >= 3 ||\n\t    (dev->dev->board_vendor == PCI_VENDOR_ID_APPLE &&\n\t     (dev->dev->core_rev == 11 || dev->dev->core_rev == 12))) {\n\t\tnphy->txpwrctrl = true;\n\t\tnphy->pwg_gain_5ghz = true;\n\t} else if (sprom->revision >= 4) {\n\t\tif (dev->phy.rev >= 2 &&\n\t\t    (sprom->boardflags2_lo & B43_BFL2_TXPWRCTRL_EN)) {\n\t\t\tnphy->txpwrctrl = true;\n#ifdef CONFIG_B43_SSB\n\t\t\tif (dev->dev->bus_type == B43_BUS_SSB &&\n\t\t\t    dev->dev->sdev->bus->bustype == SSB_BUSTYPE_PCI) {\n\t\t\t\tstruct pci_dev *pdev =\n\t\t\t\t\tdev->dev->sdev->bus->host_pci;\n\t\t\t\tif (pdev->device == 0x4328 ||\n\t\t\t\t    pdev->device == 0x432a)\n\t\t\t\t\tnphy->pwg_gain_5ghz = true;\n\t\t\t}\n#endif\n\t\t} else if (sprom->boardflags2_lo & B43_BFL2_5G_PWRGAIN) {\n\t\t\tnphy->pwg_gain_5ghz = true;\n\t\t}\n\t}\n\n\tif (dev->phy.rev >= 3) {\n\t\tnphy->ipa2g_on = sprom->fem.ghz2.extpa_gain == 2;\n\t\tnphy->ipa5g_on = sprom->fem.ghz5.extpa_gain == 2;\n\t}\n}\n\nstatic void b43_nphy_op_free(struct b43_wldev *dev)\n{\n\tstruct b43_phy *phy = &dev->phy;\n\tstruct b43_phy_n *nphy = phy->n;\n\n\tkfree(nphy);\n\tphy->n = NULL;\n}\n\nstatic int b43_nphy_op_init(struct b43_wldev *dev)\n{\n\treturn b43_phy_initn(dev);\n}\n\nstatic inline void check_phyreg(struct b43_wldev *dev, u16 offset)\n{\n#if B43_DEBUG\n\tif ((offset & B43_PHYROUTE) == B43_PHYROUTE_OFDM_GPHY) {\n\t\t \n\t\tb43err(dev->wl, \"Invalid OFDM PHY access at \"\n\t\t       \"0x%04X on N-PHY\\n\", offset);\n\t\tdump_stack();\n\t}\n\tif ((offset & B43_PHYROUTE) == B43_PHYROUTE_EXT_GPHY) {\n\t\t \n\t\tb43err(dev->wl, \"Invalid EXT-G PHY access at \"\n\t\t       \"0x%04X on N-PHY\\n\", offset);\n\t\tdump_stack();\n\t}\n#endif  \n}\n\nstatic void b43_nphy_op_maskset(struct b43_wldev *dev, u16 reg, u16 mask,\n\t\t\t\t u16 set)\n{\n\tcheck_phyreg(dev, reg);\n\tb43_write16f(dev, B43_MMIO_PHY_CONTROL, reg);\n\tb43_maskset16(dev, B43_MMIO_PHY_DATA, mask, set);\n\tdev->phy.writes_counter = 1;\n}\n\nstatic u16 b43_nphy_op_radio_read(struct b43_wldev *dev, u16 reg)\n{\n\t \n\tB43_WARN_ON(dev->phy.rev < 7 && reg == 1);\n\n\tif (dev->phy.rev >= 7)\n\t\treg |= 0x200;  \n\telse\n\t\treg |= 0x100;\n\n\tb43_write16f(dev, B43_MMIO_RADIO_CONTROL, reg);\n\treturn b43_read16(dev, B43_MMIO_RADIO_DATA_LOW);\n}\n\nstatic void b43_nphy_op_radio_write(struct b43_wldev *dev, u16 reg, u16 value)\n{\n\t \n\tB43_WARN_ON(dev->phy.rev < 7 && reg == 1);\n\n\tb43_write16f(dev, B43_MMIO_RADIO_CONTROL, reg);\n\tb43_write16(dev, B43_MMIO_RADIO_DATA_LOW, value);\n}\n\n \n\t\t} else if (phy->rev >= 8) {\n\t\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\n\t\t\t\t     ~B43_NPHY_RFCTL_CMD_CHIP0PU);\n\t\t} else if (phy->rev >= 7) {\n\t\t\t \n\t\t} else if (phy->rev >= 3) {\n\t\t\tb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\n\t\t\t\t     ~B43_NPHY_RFCTL_CMD_CHIP0PU);\n\n\t\t\tb43_radio_mask(dev, 0x09, ~0x2);\n\n\t\t\tb43_radio_write(dev, 0x204D, 0);\n\t\t\tb43_radio_write(dev, 0x2053, 0);\n\t\t\tb43_radio_write(dev, 0x2058, 0);\n\t\t\tb43_radio_write(dev, 0x205E, 0);\n\t\t\tb43_radio_mask(dev, 0x2062, ~0xF0);\n\t\t\tb43_radio_write(dev, 0x2064, 0);\n\n\t\t\tb43_radio_write(dev, 0x304D, 0);\n\t\t\tb43_radio_write(dev, 0x3053, 0);\n\t\t\tb43_radio_write(dev, 0x3058, 0);\n\t\t\tb43_radio_write(dev, 0x305E, 0);\n\t\t\tb43_radio_mask(dev, 0x3062, ~0xF0);\n\t\t\tb43_radio_write(dev, 0x3064, 0);\n\t\t}\n\t} else {\n\t\tif (phy->rev >= 19) {\n\t\t\t \n\t\t} else if (phy->rev >= 7) {\n\t\t\tif (!dev->phy.radio_on)\n\t\t\t\tb43_radio_2057_init(dev);\n\t\t\tb43_switch_channel(dev, dev->phy.channel);\n\t\t} else if (phy->rev >= 3) {\n\t\t\tif (!dev->phy.radio_on)\n\t\t\t\tb43_radio_init2056(dev);\n\t\t\tb43_switch_channel(dev, dev->phy.channel);\n\t\t} else {\n\t\t\tb43_radio_init2055(dev);\n\t\t}\n\t}\n}\n\n \n\t} else if (phy->rev >= 3) {\n\t\tif (on) {\n\t\t\tb43_phy_write(dev, B43_NPHY_AFECTL_C1, core);\n\t\t\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER1, override);\n\t\t\tb43_phy_write(dev, B43_NPHY_AFECTL_C2, core);\n\t\t\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER, override);\n\t\t} else {\n\t\t\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER1, override);\n\t\t\tb43_phy_write(dev, B43_NPHY_AFECTL_C1, core);\n\t\t\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER, override);\n\t\t\tb43_phy_write(dev, B43_NPHY_AFECTL_C2, core);\n\t\t}\n\t} else {\n\t\tb43_phy_write(dev, B43_NPHY_AFECTL_OVER, override);\n\t}\n}\n\nstatic int b43_nphy_op_switch_channel(struct b43_wldev *dev,\n\t\t\t\t      unsigned int new_channel)\n{\n\tstruct ieee80211_channel *channel = dev->wl->hw->conf.chandef.chan;\n\tenum nl80211_channel_type channel_type =\n\t\tcfg80211_get_chandef_type(&dev->wl->hw->conf.chandef);\n\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\n\t\tif ((new_channel < 1) || (new_channel > 14))\n\t\t\treturn -EINVAL;\n\t} else {\n\t\tif (new_channel > 200)\n\t\t\treturn -EINVAL;\n\t}\n\n\treturn b43_nphy_set_channel(dev, channel, channel_type);\n}\n\nstatic unsigned int b43_nphy_op_get_default_chan(struct b43_wldev *dev)\n{\n\tif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\n\t\treturn 1;\n\treturn 36;\n}\n\nconst struct b43_phy_operations b43_phyops_n = {\n\t.allocate\t\t= b43_nphy_op_allocate,\n\t.free\t\t\t= b43_nphy_op_free,\n\t.prepare_structs\t= b43_nphy_op_prepare_structs,\n\t.init\t\t\t= b43_nphy_op_init,\n\t.phy_maskset\t\t= b43_nphy_op_maskset,\n\t.radio_read\t\t= b43_nphy_op_radio_read,\n\t.radio_write\t\t= b43_nphy_op_radio_write,\n\t.software_rfkill\t= b43_nphy_op_software_rfkill,\n\t.switch_analog\t\t= b43_nphy_op_switch_analog,\n\t.switch_channel\t\t= b43_nphy_op_switch_channel,\n\t.get_default_chan\t= b43_nphy_op_get_default_chan,\n\t.recalc_txpower\t\t= b43_nphy_op_recalc_txpower,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}