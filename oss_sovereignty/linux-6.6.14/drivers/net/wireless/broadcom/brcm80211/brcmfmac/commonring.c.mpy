{
  "module_name": "commonring.c",
  "hash_id": "8cf732b75b0752d0d5e171813e5c5f450650bafd14670e892d1d6377ebc33109",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/brcm80211/brcmfmac/commonring.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/netdevice.h>\n\n#include <brcmu_utils.h>\n#include <brcmu_wifi.h>\n\n#include \"core.h\"\n#include \"commonring.h\"\n\nvoid brcmf_commonring_register_cb(struct brcmf_commonring *commonring,\n\t\t\t\t  int (*cr_ring_bell)(void *ctx),\n\t\t\t\t  int (*cr_update_rptr)(void *ctx),\n\t\t\t\t  int (*cr_update_wptr)(void *ctx),\n\t\t\t\t  int (*cr_write_rptr)(void *ctx),\n\t\t\t\t  int (*cr_write_wptr)(void *ctx), void *ctx)\n{\n\tcommonring->cr_ring_bell = cr_ring_bell;\n\tcommonring->cr_update_rptr = cr_update_rptr;\n\tcommonring->cr_update_wptr = cr_update_wptr;\n\tcommonring->cr_write_rptr = cr_write_rptr;\n\tcommonring->cr_write_wptr = cr_write_wptr;\n\tcommonring->cr_ctx = ctx;\n}\n\n\nvoid brcmf_commonring_config(struct brcmf_commonring *commonring, u16 depth,\n\t\t\t     u16 item_len, void *buf_addr)\n{\n\tcommonring->depth = depth;\n\tcommonring->item_len = item_len;\n\tcommonring->buf_addr = buf_addr;\n\tif (!commonring->inited) {\n\t\tspin_lock_init(&commonring->lock);\n\t\tcommonring->inited = true;\n\t}\n\tcommonring->r_ptr = 0;\n\tif (commonring->cr_write_rptr)\n\t\tcommonring->cr_write_rptr(commonring->cr_ctx);\n\tcommonring->w_ptr = 0;\n\tif (commonring->cr_write_wptr)\n\t\tcommonring->cr_write_wptr(commonring->cr_ctx);\n\tcommonring->f_ptr = 0;\n}\n\n\nvoid brcmf_commonring_lock(struct brcmf_commonring *commonring)\n\t\t__acquires(&commonring->lock)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&commonring->lock, flags);\n\tcommonring->flags = flags;\n}\n\n\nvoid brcmf_commonring_unlock(struct brcmf_commonring *commonring)\n\t\t__releases(&commonring->lock)\n{\n\tspin_unlock_irqrestore(&commonring->lock, commonring->flags);\n}\n\n\nbool brcmf_commonring_write_available(struct brcmf_commonring *commonring)\n{\n\tu16 available;\n\tbool retry = true;\n\nagain:\n\tif (commonring->r_ptr <= commonring->w_ptr)\n\t\tavailable = commonring->depth - commonring->w_ptr +\n\t\t\t    commonring->r_ptr;\n\telse\n\t\tavailable = commonring->r_ptr - commonring->w_ptr;\n\n\tif (available > 1) {\n\t\tif (!commonring->was_full)\n\t\t\treturn true;\n\t\tif (available > commonring->depth / 8) {\n\t\t\tcommonring->was_full = false;\n\t\t\treturn true;\n\t\t}\n\t\tif (retry) {\n\t\t\tif (commonring->cr_update_rptr)\n\t\t\t\tcommonring->cr_update_rptr(commonring->cr_ctx);\n\t\t\tretry = false;\n\t\t\tgoto again;\n\t\t}\n\t\treturn false;\n\t}\n\n\tif (retry) {\n\t\tif (commonring->cr_update_rptr)\n\t\t\tcommonring->cr_update_rptr(commonring->cr_ctx);\n\t\tretry = false;\n\t\tgoto again;\n\t}\n\n\tcommonring->was_full = true;\n\treturn false;\n}\n\n\nvoid *brcmf_commonring_reserve_for_write(struct brcmf_commonring *commonring)\n{\n\tvoid *ret_ptr;\n\tu16 available;\n\tbool retry = true;\n\nagain:\n\tif (commonring->r_ptr <= commonring->w_ptr)\n\t\tavailable = commonring->depth - commonring->w_ptr +\n\t\t\t    commonring->r_ptr;\n\telse\n\t\tavailable = commonring->r_ptr - commonring->w_ptr;\n\n\tif (available > 1) {\n\t\tret_ptr = commonring->buf_addr +\n\t\t\t  (commonring->w_ptr * commonring->item_len);\n\t\tcommonring->w_ptr++;\n\t\tif (commonring->w_ptr == commonring->depth)\n\t\t\tcommonring->w_ptr = 0;\n\t\treturn ret_ptr;\n\t}\n\n\tif (retry) {\n\t\tif (commonring->cr_update_rptr)\n\t\t\tcommonring->cr_update_rptr(commonring->cr_ctx);\n\t\tretry = false;\n\t\tgoto again;\n\t}\n\n\tcommonring->was_full = true;\n\treturn NULL;\n}\n\n\nvoid *\nbrcmf_commonring_reserve_for_write_multiple(struct brcmf_commonring *commonring,\n\t\t\t\t\t    u16 n_items, u16 *alloced)\n{\n\tvoid *ret_ptr;\n\tu16 available;\n\tbool retry = true;\n\nagain:\n\tif (commonring->r_ptr <= commonring->w_ptr)\n\t\tavailable = commonring->depth - commonring->w_ptr +\n\t\t\t    commonring->r_ptr;\n\telse\n\t\tavailable = commonring->r_ptr - commonring->w_ptr;\n\n\tif (available > 1) {\n\t\tret_ptr = commonring->buf_addr +\n\t\t\t  (commonring->w_ptr * commonring->item_len);\n\t\t*alloced = min_t(u16, n_items, available - 1);\n\t\tif (*alloced + commonring->w_ptr > commonring->depth)\n\t\t\t*alloced = commonring->depth - commonring->w_ptr;\n\t\tcommonring->w_ptr += *alloced;\n\t\tif (commonring->w_ptr == commonring->depth)\n\t\t\tcommonring->w_ptr = 0;\n\t\treturn ret_ptr;\n\t}\n\n\tif (retry) {\n\t\tif (commonring->cr_update_rptr)\n\t\t\tcommonring->cr_update_rptr(commonring->cr_ctx);\n\t\tretry = false;\n\t\tgoto again;\n\t}\n\n\tcommonring->was_full = true;\n\treturn NULL;\n}\n\n\nint brcmf_commonring_write_complete(struct brcmf_commonring *commonring)\n{\n\tif (commonring->f_ptr > commonring->w_ptr)\n\t\tcommonring->f_ptr = 0;\n\n\tcommonring->f_ptr = commonring->w_ptr;\n\n\tif (commonring->cr_write_wptr)\n\t\tcommonring->cr_write_wptr(commonring->cr_ctx);\n\tif (commonring->cr_ring_bell)\n\t\treturn commonring->cr_ring_bell(commonring->cr_ctx);\n\n\treturn -EIO;\n}\n\n\nvoid brcmf_commonring_write_cancel(struct brcmf_commonring *commonring,\n\t\t\t\t   u16 n_items)\n{\n\tif (commonring->w_ptr == 0)\n\t\tcommonring->w_ptr = commonring->depth - n_items;\n\telse\n\t\tcommonring->w_ptr -= n_items;\n}\n\n\nvoid *brcmf_commonring_get_read_ptr(struct brcmf_commonring *commonring,\n\t\t\t\t    u16 *n_items)\n{\n\tif (commonring->cr_update_wptr)\n\t\tcommonring->cr_update_wptr(commonring->cr_ctx);\n\n\t*n_items = (commonring->w_ptr >= commonring->r_ptr) ?\n\t\t\t\t(commonring->w_ptr - commonring->r_ptr) :\n\t\t\t\t(commonring->depth - commonring->r_ptr);\n\n\tif (*n_items == 0)\n\t\treturn NULL;\n\n\treturn commonring->buf_addr +\n\t       (commonring->r_ptr * commonring->item_len);\n}\n\n\nint brcmf_commonring_read_complete(struct brcmf_commonring *commonring,\n\t\t\t\t   u16 n_items)\n{\n\tcommonring->r_ptr += n_items;\n\tif (commonring->r_ptr == commonring->depth)\n\t\tcommonring->r_ptr = 0;\n\n\tif (commonring->cr_write_rptr)\n\t\treturn commonring->cr_write_rptr(commonring->cr_ctx);\n\n\treturn -EIO;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}