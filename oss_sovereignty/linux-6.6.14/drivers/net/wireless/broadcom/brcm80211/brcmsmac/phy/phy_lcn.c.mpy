{
  "module_name": "phy_lcn.c",
  "hash_id": "b84e9170bcd857741c56161f439c4b2534922253ab11eb623cd474238d5a949b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/brcm80211/brcmsmac/phy/phy_lcn.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/delay.h>\n#include <linux/cordic.h>\n\n#include <pmu.h>\n#include <d11.h>\n#include <phy_shim.h>\n#include \"phy_qmath.h\"\n#include \"phy_hal.h\"\n#include \"phy_radio.h\"\n#include \"phytbl_lcn.h\"\n#include \"phy_lcn.h\"\n\n#define PLL_2064_NDIV\t\t90\n#define PLL_2064_LOW_END_VCO\t3000\n#define PLL_2064_LOW_END_KVCO\t27\n#define PLL_2064_HIGH_END_VCO\t4200\n#define PLL_2064_HIGH_END_KVCO\t68\n#define PLL_2064_LOOP_BW_DOUBLER\t200\n#define PLL_2064_D30_DOUBLER\t\t10500\n#define PLL_2064_LOOP_BW\t260\n#define PLL_2064_D30\t\t8000\n#define PLL_2064_CAL_REF_TO\t8\n#define PLL_2064_MHZ\t\t1000000\n#define PLL_2064_OPEN_LOOP_DELAY\t5\n\n#define TEMPSENSE\t\t\t1\n#define VBATSENSE           2\n\n#define NOISE_IF_UPD_CHK_INTERVAL\t1\n#define NOISE_IF_UPD_RST_INTERVAL\t60\n#define NOISE_IF_UPD_THRESHOLD_CNT\t1\n#define NOISE_IF_UPD_TRHRESHOLD\t50\n#define NOISE_IF_UPD_TIMEOUT\t\t1000\n#define NOISE_IF_OFF\t\t\t0\n#define NOISE_IF_CHK\t\t\t1\n#define NOISE_IF_ON\t\t\t2\n\n#define PAPD_BLANKING_PROFILE\t\t3\n#define PAPD2LUT\t\t\t0\n#define PAPD_CORR_NORM\t\t\t0\n#define PAPD_BLANKING_THRESHOLD\t\t0\n#define PAPD_STOP_AFTER_LAST_UPDATE\t0\n\n#define LCN_TARGET_PWR  60\n\n#define LCN_VBAT_OFFSET_433X 34649679\n#define LCN_VBAT_SLOPE_433X  8258032\n\n#define LCN_VBAT_SCALE_NOM  53\n#define LCN_VBAT_SCALE_DEN  432\n\n#define LCN_TEMPSENSE_OFFSET  80812\n#define LCN_TEMPSENSE_DEN  2647\n\n#define LCN_BW_LMT\t200\n#define LCN_CUR_LMT\t1250\n#define LCN_MULT\t1\n#define LCN_VCO_DIV\t30\n#define LCN_OFFSET\t680\n#define LCN_FACT\t490\n#define LCN_CUR_DIV\t2640\n\n#define LCNPHY_txgainctrlovrval1_pagain_ovr_val1_SHIFT \\\n\t(0 + 8)\n#define LCNPHY_txgainctrlovrval1_pagain_ovr_val1_MASK \\\n\t(0x7f << LCNPHY_txgainctrlovrval1_pagain_ovr_val1_SHIFT)\n\n#define LCNPHY_stxtxgainctrlovrval1_pagain_ovr_val1_SHIFT \\\n\t(0 + 8)\n#define LCNPHY_stxtxgainctrlovrval1_pagain_ovr_val1_MASK \\\n\t(0x7f << LCNPHY_stxtxgainctrlovrval1_pagain_ovr_val1_SHIFT)\n\n#define wlc_lcnphy_enable_tx_gain_override(pi) \\\n\twlc_lcnphy_set_tx_gain_override(pi, true)\n#define wlc_lcnphy_disable_tx_gain_override(pi)\t\\\n\twlc_lcnphy_set_tx_gain_override(pi, false)\n\n#define wlc_lcnphy_iqcal_active(pi)\t\\\n\t(read_phy_reg((pi), 0x451) & \\\n\t ((0x1 << 15) | (0x1 << 14)))\n\n#define txpwrctrl_off(pi) (0x7 != ((read_phy_reg(pi, 0x4a4) & 0xE000) >> 13))\n#define wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi)\t\\\n\t(pi->temppwrctrl_capable)\n#define wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi) \\\n\t(pi->hwpwrctrl_capable)\n\n#define SWCTRL_BT_TX\t\t0x18\n#define SWCTRL_OVR_DISABLE\t0x40\n\n#define\tAFE_CLK_INIT_MODE_TXRX2X\t1\n#define\tAFE_CLK_INIT_MODE_PAPD\t\t0\n\n#define LCNPHY_TBL_ID_IQLOCAL\t\t\t0x00\n\n#define LCNPHY_TBL_ID_RFSEQ         0x08\n#define LCNPHY_TBL_ID_GAIN_IDX\t\t0x0d\n#define LCNPHY_TBL_ID_SW_CTRL\t\t\t0x0f\n#define LCNPHY_TBL_ID_GAIN_TBL\t\t0x12\n#define LCNPHY_TBL_ID_SPUR\t\t\t0x14\n#define LCNPHY_TBL_ID_SAMPLEPLAY\t\t0x15\n#define LCNPHY_TBL_ID_SAMPLEPLAY1\t\t0x16\n\n#define LCNPHY_TX_PWR_CTRL_RATE_OFFSET\t832\n#define LCNPHY_TX_PWR_CTRL_MAC_OFFSET\t128\n#define LCNPHY_TX_PWR_CTRL_GAIN_OFFSET\t192\n#define LCNPHY_TX_PWR_CTRL_IQ_OFFSET\t\t320\n#define LCNPHY_TX_PWR_CTRL_LO_OFFSET\t\t448\n#define LCNPHY_TX_PWR_CTRL_PWR_OFFSET\t\t576\n\n#define LCNPHY_TX_PWR_CTRL_START_INDEX_2G_4313\t140\n\n#define LCNPHY_TX_PWR_CTRL_START_NPT\t\t1\n#define LCNPHY_TX_PWR_CTRL_MAX_NPT\t\t\t7\n\n#define LCNPHY_NOISE_SAMPLES_DEFAULT 5000\n\n#define LCNPHY_ACI_DETECT_START      1\n#define LCNPHY_ACI_DETECT_PROGRESS   2\n#define LCNPHY_ACI_DETECT_STOP       3\n\n#define LCNPHY_ACI_CRSHIFRMLO_TRSH 100\n#define LCNPHY_ACI_GLITCH_TRSH 2000\n#define\tLCNPHY_ACI_TMOUT 250\n#define LCNPHY_ACI_DETECT_TIMEOUT  2\n#define LCNPHY_ACI_START_DELAY 0\n\n#define wlc_lcnphy_tx_gain_override_enabled(pi)\t\\\n\t(0 != (read_phy_reg((pi), 0x43b) & (0x1 << 6)))\n\n#define wlc_lcnphy_total_tx_frames(pi) \\\n\twlapi_bmac_read_shm((pi)->sh->physhim, M_UCODE_MACSTAT + \\\n\t\t\t    offsetof(struct macstat, txallfrm))\n\nstruct lcnphy_txgains {\n\tu16 gm_gain;\n\tu16 pga_gain;\n\tu16 pad_gain;\n\tu16 dac_gain;\n};\n\nenum lcnphy_cal_mode {\n\tLCNPHY_CAL_FULL,\n\tLCNPHY_CAL_RECAL,\n\tLCNPHY_CAL_CURRECAL,\n\tLCNPHY_CAL_DIGCAL,\n\tLCNPHY_CAL_GCTRL\n};\n\nstruct lcnphy_rx_iqcomp {\n\tu8 chan;\n\ts16 a;\n\ts16 b;\n};\n\nstruct lcnphy_spb_tone {\n\ts16 re;\n\ts16 im;\n};\n\nstruct lcnphy_unsign16_struct {\n\tu16 re;\n\tu16 im;\n};\n\nstruct lcnphy_iq_est {\n\tu32 iq_prod;\n\tu32 i_pwr;\n\tu32 q_pwr;\n};\n\nstruct lcnphy_sfo_cfg {\n\tu16 ptcentreTs20;\n\tu16 ptcentreFactor;\n};\n\nenum lcnphy_papd_cal_type {\n\tLCNPHY_PAPD_CAL_CW,\n\tLCNPHY_PAPD_CAL_OFDM\n};\n\ntypedef u16 iqcal_gain_params_lcnphy[9];\n\nstatic const iqcal_gain_params_lcnphy tbl_iqcal_gainparams_lcnphy_2G[] = {\n\t{0, 0, 0, 0, 0, 0, 0, 0, 0},\n};\n\nstatic const iqcal_gain_params_lcnphy *tbl_iqcal_gainparams_lcnphy[1] = {\n\ttbl_iqcal_gainparams_lcnphy_2G,\n};\n\nstatic const u16 iqcal_gainparams_numgains_lcnphy[1] = {\n\tARRAY_SIZE(tbl_iqcal_gainparams_lcnphy_2G),\n};\n\nstatic const struct lcnphy_sfo_cfg lcnphy_sfo_cfg[] = {\n\t{965, 1087},\n\t{967, 1085},\n\t{969, 1082},\n\t{971, 1080},\n\t{973, 1078},\n\t{975, 1076},\n\t{977, 1073},\n\t{979, 1071},\n\t{981, 1069},\n\t{983, 1067},\n\t{985, 1065},\n\t{987, 1063},\n\t{989, 1060},\n\t{994, 1055}\n};\n\nstatic const\nu16 lcnphy_iqcal_loft_gainladder[] = {\n\t((2 << 8) | 0),\n\t((3 << 8) | 0),\n\t((4 << 8) | 0),\n\t((6 << 8) | 0),\n\t((8 << 8) | 0),\n\t((11 << 8) | 0),\n\t((16 << 8) | 0),\n\t((16 << 8) | 1),\n\t((16 << 8) | 2),\n\t((16 << 8) | 3),\n\t((16 << 8) | 4),\n\t((16 << 8) | 5),\n\t((16 << 8) | 6),\n\t((16 << 8) | 7),\n\t((23 << 8) | 7),\n\t((32 << 8) | 7),\n\t((45 << 8) | 7),\n\t((64 << 8) | 7),\n\t((91 << 8) | 7),\n\t((128 << 8) | 7)\n};\n\nstatic const\nu16 lcnphy_iqcal_ir_gainladder[] = {\n\t((1 << 8) | 0),\n\t((2 << 8) | 0),\n\t((4 << 8) | 0),\n\t((6 << 8) | 0),\n\t((8 << 8) | 0),\n\t((11 << 8) | 0),\n\t((16 << 8) | 0),\n\t((23 << 8) | 0),\n\t((32 << 8) | 0),\n\t((45 << 8) | 0),\n\t((64 << 8) | 0),\n\t((64 << 8) | 1),\n\t((64 << 8) | 2),\n\t((64 << 8) | 3),\n\t((64 << 8) | 4),\n\t((64 << 8) | 5),\n\t((64 << 8) | 6),\n\t((64 << 8) | 7),\n\t((91 << 8) | 7),\n\t((128 << 8) | 7)\n};\n\nstatic const\nstruct lcnphy_spb_tone lcnphy_spb_tone_3750[] = {\n\t{88, 0},\n\t{73, 49},\n\t{34, 81},\n\t{-17, 86},\n\t{-62, 62},\n\t{-86, 17},\n\t{-81, -34},\n\t{-49, -73},\n\t{0, -88},\n\t{49, -73},\n\t{81, -34},\n\t{86, 17},\n\t{62, 62},\n\t{17, 86},\n\t{-34, 81},\n\t{-73, 49},\n\t{-88, 0},\n\t{-73, -49},\n\t{-34, -81},\n\t{17, -86},\n\t{62, -62},\n\t{86, -17},\n\t{81, 34},\n\t{49, 73},\n\t{0, 88},\n\t{-49, 73},\n\t{-81, 34},\n\t{-86, -17},\n\t{-62, -62},\n\t{-17, -86},\n\t{34, -81},\n\t{73, -49},\n};\n\nstatic const\nu16 iqlo_loopback_rf_regs[20] = {\n\tRADIO_2064_REG036,\n\tRADIO_2064_REG11A,\n\tRADIO_2064_REG03A,\n\tRADIO_2064_REG025,\n\tRADIO_2064_REG028,\n\tRADIO_2064_REG005,\n\tRADIO_2064_REG112,\n\tRADIO_2064_REG0FF,\n\tRADIO_2064_REG11F,\n\tRADIO_2064_REG00B,\n\tRADIO_2064_REG113,\n\tRADIO_2064_REG007,\n\tRADIO_2064_REG0FC,\n\tRADIO_2064_REG0FD,\n\tRADIO_2064_REG012,\n\tRADIO_2064_REG057,\n\tRADIO_2064_REG059,\n\tRADIO_2064_REG05C,\n\tRADIO_2064_REG078,\n\tRADIO_2064_REG092,\n};\n\nstatic const\nu16 tempsense_phy_regs[14] = {\n\t0x503,\n\t0x4a4,\n\t0x4d0,\n\t0x4d9,\n\t0x4da,\n\t0x4a6,\n\t0x938,\n\t0x939,\n\t0x4d8,\n\t0x4d0,\n\t0x4d7,\n\t0x4a5,\n\t0x40d,\n\t0x4a2,\n};\n\nstatic const\nu16 rxiq_cal_rf_reg[11] = {\n\tRADIO_2064_REG098,\n\tRADIO_2064_REG116,\n\tRADIO_2064_REG12C,\n\tRADIO_2064_REG06A,\n\tRADIO_2064_REG00B,\n\tRADIO_2064_REG01B,\n\tRADIO_2064_REG113,\n\tRADIO_2064_REG01D,\n\tRADIO_2064_REG114,\n\tRADIO_2064_REG02E,\n\tRADIO_2064_REG12A,\n};\n\nstatic const u32 lcnphy_23bitgaincode_table[] = {\n\t0x200100,\n\t0x200200,\n\t0x200004,\n\t0x200014,\n\t0x200024,\n\t0x200034,\n\t0x200134,\n\t0x200234,\n\t0x200334,\n\t0x200434,\n\t0x200037,\n\t0x200137,\n\t0x200237,\n\t0x200337,\n\t0x200437,\n\t0x000035,\n\t0x000135,\n\t0x000235,\n\t0x000037,\n\t0x000137,\n\t0x000237,\n\t0x000337,\n\t0x00013f,\n\t0x00023f,\n\t0x00033f,\n\t0x00034f,\n\t0x00044f,\n\t0x00144f,\n\t0x00244f,\n\t0x00254f,\n\t0x00354f,\n\t0x00454f,\n\t0x00464f,\n\t0x01464f,\n\t0x02464f,\n\t0x03464f,\n\t0x04464f,\n};\n\nstatic const s8 lcnphy_gain_table[] = {\n\t-16,\n\t-13,\n\t10,\n\t7,\n\t4,\n\t0,\n\t3,\n\t6,\n\t9,\n\t12,\n\t15,\n\t18,\n\t21,\n\t24,\n\t27,\n\t30,\n\t33,\n\t36,\n\t39,\n\t42,\n\t45,\n\t48,\n\t50,\n\t53,\n\t56,\n\t59,\n\t62,\n\t65,\n\t68,\n\t71,\n\t74,\n\t77,\n\t80,\n\t83,\n\t86,\n\t89,\n\t92,\n};\n\nstatic const s8 lcnphy_gain_index_offset_for_rssi[] = {\n\t7,\n\t7,\n\t7,\n\t7,\n\t7,\n\t7,\n\t7,\n\t8,\n\t7,\n\t7,\n\t6,\n\t7,\n\t7,\n\t4,\n\t4,\n\t4,\n\t4,\n\t4,\n\t4,\n\t4,\n\t4,\n\t3,\n\t3,\n\t3,\n\t3,\n\t3,\n\t3,\n\t4,\n\t2,\n\t2,\n\t2,\n\t2,\n\t2,\n\t2,\n\t-1,\n\t-2,\n\t-2,\n\t-2\n};\n\nstruct chan_info_2064_lcnphy {\n\tuint chan;\n\tuint freq;\n\tu8 logen_buftune;\n\tu8 logen_rccr_tx;\n\tu8 txrf_mix_tune_ctrl;\n\tu8 pa_input_tune_g;\n\tu8 logen_rccr_rx;\n\tu8 pa_rxrf_lna1_freq_tune;\n\tu8 pa_rxrf_lna2_freq_tune;\n\tu8 rxrf_rxrf_spare1;\n};\n\nstatic const struct chan_info_2064_lcnphy chan_info_2064_lcnphy[] = {\n\t{1, 2412, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{2, 2417, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{3, 2422, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{4, 2427, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{5, 2432, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{6, 2437, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{7, 2442, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{8, 2447, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{9, 2452, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{10, 2457, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{11, 2462, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{12, 2467, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{13, 2472, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n\t{14, 2484, 0x0B, 0x0A, 0x00, 0x07, 0x0A, 0x88, 0x88, 0x80},\n};\n\nstatic const struct lcnphy_radio_regs lcnphy_radio_regs_2064[] = {\n\t{0x00, 0, 0, 0, 0},\n\t{0x01, 0x64, 0x64, 0, 0},\n\t{0x02, 0x20, 0x20, 0, 0},\n\t{0x03, 0x66, 0x66, 0, 0},\n\t{0x04, 0xf8, 0xf8, 0, 0},\n\t{0x05, 0, 0, 0, 0},\n\t{0x06, 0x10, 0x10, 0, 0},\n\t{0x07, 0, 0, 0, 0},\n\t{0x08, 0, 0, 0, 0},\n\t{0x09, 0, 0, 0, 0},\n\t{0x0A, 0x37, 0x37, 0, 0},\n\t{0x0B, 0x6, 0x6, 0, 0},\n\t{0x0C, 0x55, 0x55, 0, 0},\n\t{0x0D, 0x8b, 0x8b, 0, 0},\n\t{0x0E, 0, 0, 0, 0},\n\t{0x0F, 0x5, 0x5, 0, 0},\n\t{0x10, 0, 0, 0, 0},\n\t{0x11, 0xe, 0xe, 0, 0},\n\t{0x12, 0, 0, 0, 0},\n\t{0x13, 0xb, 0xb, 0, 0},\n\t{0x14, 0x2, 0x2, 0, 0},\n\t{0x15, 0x12, 0x12, 0, 0},\n\t{0x16, 0x12, 0x12, 0, 0},\n\t{0x17, 0xc, 0xc, 0, 0},\n\t{0x18, 0xc, 0xc, 0, 0},\n\t{0x19, 0xc, 0xc, 0, 0},\n\t{0x1A, 0x8, 0x8, 0, 0},\n\t{0x1B, 0x2, 0x2, 0, 0},\n\t{0x1C, 0, 0, 0, 0},\n\t{0x1D, 0x1, 0x1, 0, 0},\n\t{0x1E, 0x12, 0x12, 0, 0},\n\t{0x1F, 0x6e, 0x6e, 0, 0},\n\t{0x20, 0x2, 0x2, 0, 0},\n\t{0x21, 0x23, 0x23, 0, 0},\n\t{0x22, 0x8, 0x8, 0, 0},\n\t{0x23, 0, 0, 0, 0},\n\t{0x24, 0, 0, 0, 0},\n\t{0x25, 0xc, 0xc, 0, 0},\n\t{0x26, 0x33, 0x33, 0, 0},\n\t{0x27, 0x55, 0x55, 0, 0},\n\t{0x28, 0, 0, 0, 0},\n\t{0x29, 0x30, 0x30, 0, 0},\n\t{0x2A, 0xb, 0xb, 0, 0},\n\t{0x2B, 0x1b, 0x1b, 0, 0},\n\t{0x2C, 0x3, 0x3, 0, 0},\n\t{0x2D, 0x1b, 0x1b, 0, 0},\n\t{0x2E, 0, 0, 0, 0},\n\t{0x2F, 0x20, 0x20, 0, 0},\n\t{0x30, 0xa, 0xa, 0, 0},\n\t{0x31, 0, 0, 0, 0},\n\t{0x32, 0x62, 0x62, 0, 0},\n\t{0x33, 0x19, 0x19, 0, 0},\n\t{0x34, 0x33, 0x33, 0, 0},\n\t{0x35, 0x77, 0x77, 0, 0},\n\t{0x36, 0, 0, 0, 0},\n\t{0x37, 0x70, 0x70, 0, 0},\n\t{0x38, 0x3, 0x3, 0, 0},\n\t{0x39, 0xf, 0xf, 0, 0},\n\t{0x3A, 0x6, 0x6, 0, 0},\n\t{0x3B, 0xcf, 0xcf, 0, 0},\n\t{0x3C, 0x1a, 0x1a, 0, 0},\n\t{0x3D, 0x6, 0x6, 0, 0},\n\t{0x3E, 0x42, 0x42, 0, 0},\n\t{0x3F, 0, 0, 0, 0},\n\t{0x40, 0xfb, 0xfb, 0, 0},\n\t{0x41, 0x9a, 0x9a, 0, 0},\n\t{0x42, 0x7a, 0x7a, 0, 0},\n\t{0x43, 0x29, 0x29, 0, 0},\n\t{0x44, 0, 0, 0, 0},\n\t{0x45, 0x8, 0x8, 0, 0},\n\t{0x46, 0xce, 0xce, 0, 0},\n\t{0x47, 0x27, 0x27, 0, 0},\n\t{0x48, 0x62, 0x62, 0, 0},\n\t{0x49, 0x6, 0x6, 0, 0},\n\t{0x4A, 0x58, 0x58, 0, 0},\n\t{0x4B, 0xf7, 0xf7, 0, 0},\n\t{0x4C, 0, 0, 0, 0},\n\t{0x4D, 0xb3, 0xb3, 0, 0},\n\t{0x4E, 0, 0, 0, 0},\n\t{0x4F, 0x2, 0x2, 0, 0},\n\t{0x50, 0, 0, 0, 0},\n\t{0x51, 0x9, 0x9, 0, 0},\n\t{0x52, 0x5, 0x5, 0, 0},\n\t{0x53, 0x17, 0x17, 0, 0},\n\t{0x54, 0x38, 0x38, 0, 0},\n\t{0x55, 0, 0, 0, 0},\n\t{0x56, 0, 0, 0, 0},\n\t{0x57, 0xb, 0xb, 0, 0},\n\t{0x58, 0, 0, 0, 0},\n\t{0x59, 0, 0, 0, 0},\n\t{0x5A, 0, 0, 0, 0},\n\t{0x5B, 0, 0, 0, 0},\n\t{0x5C, 0, 0, 0, 0},\n\t{0x5D, 0, 0, 0, 0},\n\t{0x5E, 0x88, 0x88, 0, 0},\n\t{0x5F, 0xcc, 0xcc, 0, 0},\n\t{0x60, 0x74, 0x74, 0, 0},\n\t{0x61, 0x74, 0x74, 0, 0},\n\t{0x62, 0x74, 0x74, 0, 0},\n\t{0x63, 0x44, 0x44, 0, 0},\n\t{0x64, 0x77, 0x77, 0, 0},\n\t{0x65, 0x44, 0x44, 0, 0},\n\t{0x66, 0x77, 0x77, 0, 0},\n\t{0x67, 0x55, 0x55, 0, 0},\n\t{0x68, 0x77, 0x77, 0, 0},\n\t{0x69, 0x77, 0x77, 0, 0},\n\t{0x6A, 0, 0, 0, 0},\n\t{0x6B, 0x7f, 0x7f, 0, 0},\n\t{0x6C, 0x8, 0x8, 0, 0},\n\t{0x6D, 0, 0, 0, 0},\n\t{0x6E, 0x88, 0x88, 0, 0},\n\t{0x6F, 0x66, 0x66, 0, 0},\n\t{0x70, 0x66, 0x66, 0, 0},\n\t{0x71, 0x28, 0x28, 0, 0},\n\t{0x72, 0x55, 0x55, 0, 0},\n\t{0x73, 0x4, 0x4, 0, 0},\n\t{0x74, 0, 0, 0, 0},\n\t{0x75, 0, 0, 0, 0},\n\t{0x76, 0, 0, 0, 0},\n\t{0x77, 0x1, 0x1, 0, 0},\n\t{0x78, 0xd6, 0xd6, 0, 0},\n\t{0x79, 0, 0, 0, 0},\n\t{0x7A, 0, 0, 0, 0},\n\t{0x7B, 0, 0, 0, 0},\n\t{0x7C, 0, 0, 0, 0},\n\t{0x7D, 0, 0, 0, 0},\n\t{0x7E, 0, 0, 0, 0},\n\t{0x7F, 0, 0, 0, 0},\n\t{0x80, 0, 0, 0, 0},\n\t{0x81, 0, 0, 0, 0},\n\t{0x82, 0, 0, 0, 0},\n\t{0x83, 0xb4, 0xb4, 0, 0},\n\t{0x84, 0x1, 0x1, 0, 0},\n\t{0x85, 0x20, 0x20, 0, 0},\n\t{0x86, 0x5, 0x5, 0, 0},\n\t{0x87, 0xff, 0xff, 0, 0},\n\t{0x88, 0x7, 0x7, 0, 0},\n\t{0x89, 0x77, 0x77, 0, 0},\n\t{0x8A, 0x77, 0x77, 0, 0},\n\t{0x8B, 0x77, 0x77, 0, 0},\n\t{0x8C, 0x77, 0x77, 0, 0},\n\t{0x8D, 0x8, 0x8, 0, 0},\n\t{0x8E, 0xa, 0xa, 0, 0},\n\t{0x8F, 0x8, 0x8, 0, 0},\n\t{0x90, 0x18, 0x18, 0, 0},\n\t{0x91, 0x5, 0x5, 0, 0},\n\t{0x92, 0x1f, 0x1f, 0, 0},\n\t{0x93, 0x10, 0x10, 0, 0},\n\t{0x94, 0x3, 0x3, 0, 0},\n\t{0x95, 0, 0, 0, 0},\n\t{0x96, 0, 0, 0, 0},\n\t{0x97, 0xaa, 0xaa, 0, 0},\n\t{0x98, 0, 0, 0, 0},\n\t{0x99, 0x23, 0x23, 0, 0},\n\t{0x9A, 0x7, 0x7, 0, 0},\n\t{0x9B, 0xf, 0xf, 0, 0},\n\t{0x9C, 0x10, 0x10, 0, 0},\n\t{0x9D, 0x3, 0x3, 0, 0},\n\t{0x9E, 0x4, 0x4, 0, 0},\n\t{0x9F, 0x20, 0x20, 0, 0},\n\t{0xA0, 0, 0, 0, 0},\n\t{0xA1, 0, 0, 0, 0},\n\t{0xA2, 0, 0, 0, 0},\n\t{0xA3, 0, 0, 0, 0},\n\t{0xA4, 0x1, 0x1, 0, 0},\n\t{0xA5, 0x77, 0x77, 0, 0},\n\t{0xA6, 0x77, 0x77, 0, 0},\n\t{0xA7, 0x77, 0x77, 0, 0},\n\t{0xA8, 0x77, 0x77, 0, 0},\n\t{0xA9, 0x8c, 0x8c, 0, 0},\n\t{0xAA, 0x88, 0x88, 0, 0},\n\t{0xAB, 0x78, 0x78, 0, 0},\n\t{0xAC, 0x57, 0x57, 0, 0},\n\t{0xAD, 0x88, 0x88, 0, 0},\n\t{0xAE, 0, 0, 0, 0},\n\t{0xAF, 0x8, 0x8, 0, 0},\n\t{0xB0, 0x88, 0x88, 0, 0},\n\t{0xB1, 0, 0, 0, 0},\n\t{0xB2, 0x1b, 0x1b, 0, 0},\n\t{0xB3, 0x3, 0x3, 0, 0},\n\t{0xB4, 0x24, 0x24, 0, 0},\n\t{0xB5, 0x3, 0x3, 0, 0},\n\t{0xB6, 0x1b, 0x1b, 0, 0},\n\t{0xB7, 0x24, 0x24, 0, 0},\n\t{0xB8, 0x3, 0x3, 0, 0},\n\t{0xB9, 0, 0, 0, 0},\n\t{0xBA, 0xaa, 0xaa, 0, 0},\n\t{0xBB, 0, 0, 0, 0},\n\t{0xBC, 0x4, 0x4, 0, 0},\n\t{0xBD, 0, 0, 0, 0},\n\t{0xBE, 0x8, 0x8, 0, 0},\n\t{0xBF, 0x11, 0x11, 0, 0},\n\t{0xC0, 0, 0, 0, 0},\n\t{0xC1, 0, 0, 0, 0},\n\t{0xC2, 0x62, 0x62, 0, 0},\n\t{0xC3, 0x1e, 0x1e, 0, 0},\n\t{0xC4, 0x33, 0x33, 0, 0},\n\t{0xC5, 0x37, 0x37, 0, 0},\n\t{0xC6, 0, 0, 0, 0},\n\t{0xC7, 0x70, 0x70, 0, 0},\n\t{0xC8, 0x1e, 0x1e, 0, 0},\n\t{0xC9, 0x6, 0x6, 0, 0},\n\t{0xCA, 0x4, 0x4, 0, 0},\n\t{0xCB, 0x2f, 0x2f, 0, 0},\n\t{0xCC, 0xf, 0xf, 0, 0},\n\t{0xCD, 0, 0, 0, 0},\n\t{0xCE, 0xff, 0xff, 0, 0},\n\t{0xCF, 0x8, 0x8, 0, 0},\n\t{0xD0, 0x3f, 0x3f, 0, 0},\n\t{0xD1, 0x3f, 0x3f, 0, 0},\n\t{0xD2, 0x3f, 0x3f, 0, 0},\n\t{0xD3, 0, 0, 0, 0},\n\t{0xD4, 0, 0, 0, 0},\n\t{0xD5, 0, 0, 0, 0},\n\t{0xD6, 0xcc, 0xcc, 0, 0},\n\t{0xD7, 0, 0, 0, 0},\n\t{0xD8, 0x8, 0x8, 0, 0},\n\t{0xD9, 0x8, 0x8, 0, 0},\n\t{0xDA, 0x8, 0x8, 0, 0},\n\t{0xDB, 0x11, 0x11, 0, 0},\n\t{0xDC, 0, 0, 0, 0},\n\t{0xDD, 0x87, 0x87, 0, 0},\n\t{0xDE, 0x88, 0x88, 0, 0},\n\t{0xDF, 0x8, 0x8, 0, 0},\n\t{0xE0, 0x8, 0x8, 0, 0},\n\t{0xE1, 0x8, 0x8, 0, 0},\n\t{0xE2, 0, 0, 0, 0},\n\t{0xE3, 0, 0, 0, 0},\n\t{0xE4, 0, 0, 0, 0},\n\t{0xE5, 0xf5, 0xf5, 0, 0},\n\t{0xE6, 0x30, 0x30, 0, 0},\n\t{0xE7, 0x1, 0x1, 0, 0},\n\t{0xE8, 0, 0, 0, 0},\n\t{0xE9, 0xff, 0xff, 0, 0},\n\t{0xEA, 0, 0, 0, 0},\n\t{0xEB, 0, 0, 0, 0},\n\t{0xEC, 0x22, 0x22, 0, 0},\n\t{0xED, 0, 0, 0, 0},\n\t{0xEE, 0, 0, 0, 0},\n\t{0xEF, 0, 0, 0, 0},\n\t{0xF0, 0x3, 0x3, 0, 0},\n\t{0xF1, 0x1, 0x1, 0, 0},\n\t{0xF2, 0, 0, 0, 0},\n\t{0xF3, 0, 0, 0, 0},\n\t{0xF4, 0, 0, 0, 0},\n\t{0xF5, 0, 0, 0, 0},\n\t{0xF6, 0, 0, 0, 0},\n\t{0xF7, 0x6, 0x6, 0, 0},\n\t{0xF8, 0, 0, 0, 0},\n\t{0xF9, 0, 0, 0, 0},\n\t{0xFA, 0x40, 0x40, 0, 0},\n\t{0xFB, 0, 0, 0, 0},\n\t{0xFC, 0x1, 0x1, 0, 0},\n\t{0xFD, 0x80, 0x80, 0, 0},\n\t{0xFE, 0x2, 0x2, 0, 0},\n\t{0xFF, 0x10, 0x10, 0, 0},\n\t{0x100, 0x2, 0x2, 0, 0},\n\t{0x101, 0x1e, 0x1e, 0, 0},\n\t{0x102, 0x1e, 0x1e, 0, 0},\n\t{0x103, 0, 0, 0, 0},\n\t{0x104, 0x1f, 0x1f, 0, 0},\n\t{0x105, 0, 0x8, 0, 1},\n\t{0x106, 0x2a, 0x2a, 0, 0},\n\t{0x107, 0xf, 0xf, 0, 0},\n\t{0x108, 0, 0, 0, 0},\n\t{0x109, 0, 0, 0, 0},\n\t{0x10A, 0, 0, 0, 0},\n\t{0x10B, 0, 0, 0, 0},\n\t{0x10C, 0, 0, 0, 0},\n\t{0x10D, 0, 0, 0, 0},\n\t{0x10E, 0, 0, 0, 0},\n\t{0x10F, 0, 0, 0, 0},\n\t{0x110, 0, 0, 0, 0},\n\t{0x111, 0, 0, 0, 0},\n\t{0x112, 0, 0, 0, 0},\n\t{0x113, 0, 0, 0, 0},\n\t{0x114, 0, 0, 0, 0},\n\t{0x115, 0, 0, 0, 0},\n\t{0x116, 0, 0, 0, 0},\n\t{0x117, 0, 0, 0, 0},\n\t{0x118, 0, 0, 0, 0},\n\t{0x119, 0, 0, 0, 0},\n\t{0x11A, 0, 0, 0, 0},\n\t{0x11B, 0, 0, 0, 0},\n\t{0x11C, 0x1, 0x1, 0, 0},\n\t{0x11D, 0, 0, 0, 0},\n\t{0x11E, 0, 0, 0, 0},\n\t{0x11F, 0, 0, 0, 0},\n\t{0x120, 0, 0, 0, 0},\n\t{0x121, 0, 0, 0, 0},\n\t{0x122, 0x80, 0x80, 0, 0},\n\t{0x123, 0, 0, 0, 0},\n\t{0x124, 0xf8, 0xf8, 0, 0},\n\t{0x125, 0, 0, 0, 0},\n\t{0x126, 0, 0, 0, 0},\n\t{0x127, 0, 0, 0, 0},\n\t{0x128, 0, 0, 0, 0},\n\t{0x129, 0, 0, 0, 0},\n\t{0x12A, 0, 0, 0, 0},\n\t{0x12B, 0, 0, 0, 0},\n\t{0x12C, 0, 0, 0, 0},\n\t{0x12D, 0, 0, 0, 0},\n\t{0x12E, 0, 0, 0, 0},\n\t{0x12F, 0, 0, 0, 0},\n\t{0x130, 0, 0, 0, 0},\n\t{0xFFFF, 0, 0, 0, 0}\n};\n\n#define LCNPHY_NUM_DIG_FILT_COEFFS 16\n#define LCNPHY_NUM_TX_DIG_FILTERS_CCK 13\n\nstatic const u16 LCNPHY_txdigfiltcoeffs_cck[LCNPHY_NUM_TX_DIG_FILTERS_CCK]\n\t[LCNPHY_NUM_DIG_FILT_COEFFS + 1] = {\n\t{0, 1, 415, 1874, 64, 128, 64, 792, 1656, 64, 128, 64, 778, 1582, 64,\n\t 128, 64,},\n\t{1, 1, 402, 1847, 259, 59, 259, 671, 1794, 68, 54, 68, 608, 1863, 93,\n\t 167, 93,},\n\t{2, 1, 415, 1874, 64, 128, 64, 792, 1656, 192, 384, 192, 778, 1582, 64,\n\t 128, 64,},\n\t{3, 1, 302, 1841, 129, 258, 129, 658, 1720, 205, 410, 205, 754, 1760,\n\t 170, 340, 170,},\n\t{20, 1, 360, 1884, 242, 1734, 242, 752, 1720, 205, 1845, 205, 767, 1760,\n\t 256, 185, 256,},\n\t{21, 1, 360, 1884, 149, 1874, 149, 752, 1720, 205, 1883, 205, 767, 1760,\n\t 256, 273, 256,},\n\t{22, 1, 360, 1884, 98, 1948, 98, 752, 1720, 205, 1924, 205, 767, 1760,\n\t 256, 352, 256,},\n\t{23, 1, 350, 1884, 116, 1966, 116, 752, 1720, 205, 2008, 205, 767, 1760,\n\t 128, 233, 128,},\n\t{24, 1, 325, 1884, 32, 40, 32, 756, 1720, 256, 471, 256, 766, 1760, 256,\n\t 1881, 256,},\n\t{25, 1, 299, 1884, 51, 64, 51, 736, 1720, 256, 471, 256, 765, 1760, 256,\n\t 1881, 256,},\n\t{26, 1, 277, 1943, 39, 117, 88, 637, 1838, 64, 192, 144, 614, 1864, 128,\n\t 384, 288,},\n\t{27, 1, 245, 1943, 49, 147, 110, 626, 1838, 256, 768, 576, 613, 1864,\n\t 128, 384, 288,},\n\t{30, 1, 302, 1841, 61, 122, 61, 658, 1720, 205, 410, 205, 754, 1760,\n\t 170, 340, 170,},\n};\n\n#define LCNPHY_NUM_TX_DIG_FILTERS_OFDM 3\nstatic const u16 LCNPHY_txdigfiltcoeffs_ofdm[LCNPHY_NUM_TX_DIG_FILTERS_OFDM]\n\t[LCNPHY_NUM_DIG_FILT_COEFFS + 1] = {\n\t{0, 0, 0xa2, 0x0, 0x100, 0x100, 0x0, 0x0, 0x0, 0x100, 0x0, 0x0,\n\t 0x278, 0xfea0, 0x80, 0x100, 0x80,},\n\t{1, 0, 374, 0xFF79, 16, 32, 16, 799, 0xFE74, 50, 32, 50,\n\t 750, 0xFE2B, 212, 0xFFCE, 212,},\n\t{2, 0, 375, 0xFF16, 37, 76, 37, 799, 0xFE74, 32, 20, 32, 748,\n\t 0xFEF2, 128, 0xFFE2, 128}\n};\n\n#define wlc_lcnphy_set_start_tx_pwr_idx(pi, idx) \\\n\tmod_phy_reg(pi, 0x4a4, \\\n\t\t    (0x1ff << 0), \\\n\t\t    (u16)(idx) << 0)\n\n#define wlc_lcnphy_set_tx_pwr_npt(pi, npt) \\\n\tmod_phy_reg(pi, 0x4a5, \\\n\t\t    (0x7 << 8),\t\\\n\t\t    (u16)(npt) << 8)\n\n#define wlc_lcnphy_get_tx_pwr_ctrl(pi) \\\n\t(read_phy_reg((pi), 0x4a4) & \\\n\t ((0x1 << 15) |\t\\\n\t  (0x1 << 14) |\t\\\n\t  (0x1 << 13)))\n\n#define wlc_lcnphy_get_tx_pwr_npt(pi) \\\n\t((read_phy_reg(pi, 0x4a5) & \\\n\t  (0x7 << 8)) >> \\\n\t 8)\n\n#define wlc_lcnphy_get_current_tx_pwr_idx_if_pwrctrl_on(pi) \\\n\t(read_phy_reg(pi, 0x473) & 0x1ff)\n\n#define wlc_lcnphy_get_target_tx_pwr(pi) \\\n\t((read_phy_reg(pi, 0x4a7) & \\\n\t  (0xff << 0)) >> \\\n\t 0)\n\n#define wlc_lcnphy_set_target_tx_pwr(pi, target) \\\n\tmod_phy_reg(pi, 0x4a7, \\\n\t\t    (0xff << 0), \\\n\t\t    (u16)(target) << 0)\n\n#define wlc_radio_2064_rcal_done(pi) \\\n\t(0 != (read_radio_reg(pi, RADIO_2064_REG05C) & 0x20))\n\n#define tempsense_done(pi) \\\n\t(0x8000 == (read_phy_reg(pi, 0x476) & 0x8000))\n\n#define LCNPHY_IQLOCC_READ(val) \\\n\t((u8)(-(s8)(((val) & 0xf0) >> 4) + (s8)((val) & 0x0f)))\n\n#define FIXED_TXPWR 78\n#define LCNPHY_TEMPSENSE(val) ((s16)((val > 255) ? (val - 512) : val))\n\nvoid wlc_lcnphy_write_table(struct brcms_phy *pi, const struct phytbl_info *pti)\n{\n\twlc_phy_write_table(pi, pti, 0x455, 0x457, 0x456);\n}\n\nvoid wlc_lcnphy_read_table(struct brcms_phy *pi, struct phytbl_info *pti)\n{\n\twlc_phy_read_table(pi, pti, 0x455, 0x457, 0x456);\n}\n\nstatic void\nwlc_lcnphy_common_read_table(struct brcms_phy *pi, u32 tbl_id,\n\t\t\t     const u16 *tbl_ptr, u32 tbl_len,\n\t\t\t     u32 tbl_width, u32 tbl_offset)\n{\n\tstruct phytbl_info tab;\n\ttab.tbl_id = tbl_id;\n\ttab.tbl_ptr = tbl_ptr;\n\ttab.tbl_len = tbl_len;\n\ttab.tbl_width = tbl_width;\n\ttab.tbl_offset = tbl_offset;\n\twlc_lcnphy_read_table(pi, &tab);\n}\n\nstatic void\nwlc_lcnphy_common_write_table(struct brcms_phy *pi, u32 tbl_id,\n\t\t\t      const u16 *tbl_ptr, u32 tbl_len,\n\t\t\t      u32 tbl_width, u32 tbl_offset)\n{\n\n\tstruct phytbl_info tab;\n\ttab.tbl_id = tbl_id;\n\ttab.tbl_ptr = tbl_ptr;\n\ttab.tbl_len = tbl_len;\n\ttab.tbl_width = tbl_width;\n\ttab.tbl_offset = tbl_offset;\n\twlc_lcnphy_write_table(pi, &tab);\n}\n\nstatic u32\nwlc_lcnphy_qdiv_roundup(u32 dividend, u32 divisor, u8 precision)\n{\n\tu32 quotient, remainder, roundup, rbit;\n\n\tquotient = dividend / divisor;\n\tremainder = dividend % divisor;\n\trbit = divisor & 1;\n\troundup = (divisor >> 1) + rbit;\n\n\twhile (precision--) {\n\t\tquotient <<= 1;\n\t\tif (remainder >= roundup) {\n\t\t\tquotient++;\n\t\t\tremainder = ((remainder - roundup) << 1) + rbit;\n\t\t} else {\n\t\t\tremainder <<= 1;\n\t\t}\n\t}\n\n\tif (remainder >= roundup)\n\t\tquotient++;\n\n\treturn quotient;\n}\n\nstatic int wlc_lcnphy_calc_floor(s16 coeff_x, int type)\n{\n\tint k;\n\tk = 0;\n\tif (type == 0) {\n\t\tif (coeff_x < 0)\n\t\t\tk = (coeff_x - 1) / 2;\n\t\telse\n\t\t\tk = coeff_x / 2;\n\t}\n\n\tif (type == 1) {\n\t\tif ((coeff_x + 1) < 0)\n\t\t\tk = (coeff_x) / 2;\n\t\telse\n\t\t\tk = (coeff_x + 1) / 2;\n\t}\n\treturn k;\n}\n\nstatic void\nwlc_lcnphy_get_tx_gain(struct brcms_phy *pi, struct lcnphy_txgains *gains)\n{\n\tu16 dac_gain, rfgain0, rfgain1;\n\n\tdac_gain = read_phy_reg(pi, 0x439) >> 0;\n\tgains->dac_gain = (dac_gain & 0x380) >> 7;\n\n\trfgain0 = (read_phy_reg(pi, 0x4b5) & (0xffff << 0)) >> 0;\n\trfgain1 = (read_phy_reg(pi, 0x4fb) & (0x7fff << 0)) >> 0;\n\n\tgains->gm_gain = rfgain0 & 0xff;\n\tgains->pga_gain = (rfgain0 >> 8) & 0xff;\n\tgains->pad_gain = rfgain1 & 0xff;\n}\n\n\nstatic void wlc_lcnphy_set_dac_gain(struct brcms_phy *pi, u16 dac_gain)\n{\n\tu16 dac_ctrl;\n\n\tdac_ctrl = (read_phy_reg(pi, 0x439) >> 0);\n\tdac_ctrl = dac_ctrl & 0xc7f;\n\tdac_ctrl = dac_ctrl | (dac_gain << 7);\n\tmod_phy_reg(pi, 0x439, (0xfff << 0), (dac_ctrl) << 0);\n\n}\n\nstatic void wlc_lcnphy_set_tx_gain_override(struct brcms_phy *pi, bool bEnable)\n{\n\tu16 bit = bEnable ? 1 : 0;\n\n\tmod_phy_reg(pi, 0x4b0, (0x1 << 7), bit << 7);\n\n\tmod_phy_reg(pi, 0x4b0, (0x1 << 14), bit << 14);\n\n\tmod_phy_reg(pi, 0x43b, (0x1 << 6), bit << 6);\n}\n\nstatic void\nwlc_lcnphy_rx_gain_override_enable(struct brcms_phy *pi, bool enable)\n{\n\tu16 ebit = enable ? 1 : 0;\n\n\tmod_phy_reg(pi, 0x4b0, (0x1 << 8), ebit << 8);\n\n\tmod_phy_reg(pi, 0x44c, (0x1 << 0), ebit << 0);\n\n\tif (LCNREV_LT(pi->pubpi.phy_rev, 2)) {\n\t\tmod_phy_reg(pi, 0x44c, (0x1 << 4), ebit << 4);\n\t\tmod_phy_reg(pi, 0x44c, (0x1 << 6), ebit << 6);\n\t\tmod_phy_reg(pi, 0x4b0, (0x1 << 5), ebit << 5);\n\t\tmod_phy_reg(pi, 0x4b0, (0x1 << 6), ebit << 6);\n\t} else {\n\t\tmod_phy_reg(pi, 0x4b0, (0x1 << 12), ebit << 12);\n\t\tmod_phy_reg(pi, 0x4b0, (0x1 << 13), ebit << 13);\n\t\tmod_phy_reg(pi, 0x4b0, (0x1 << 5), ebit << 5);\n\t}\n\n\tif (CHSPEC_IS2G(pi->radio_chanspec)) {\n\t\tmod_phy_reg(pi, 0x4b0, (0x1 << 10), ebit << 10);\n\t\tmod_phy_reg(pi, 0x4e5, (0x1 << 3), ebit << 3);\n\t}\n}\n\nstatic void\nwlc_lcnphy_set_rx_gain_by_distribution(struct brcms_phy *pi,\n\t\t\t\t       u16 trsw,\n\t\t\t\t       u16 ext_lna,\n\t\t\t\t       u16 biq2,\n\t\t\t\t       u16 biq1,\n\t\t\t\t       u16 tia, u16 lna2, u16 lna1)\n{\n\tu16 gain0_15, gain16_19;\n\n\tgain16_19 = biq2 & 0xf;\n\tgain0_15 = ((biq1 & 0xf) << 12) |\n\t\t   ((tia & 0xf) << 8) |\n\t\t   ((lna2 & 0x3) << 6) |\n\t\t   ((lna2 & 0x3) << 4) |\n\t\t   ((lna1 & 0x3) << 2) |\n\t\t   ((lna1 & 0x3) << 0);\n\n\tmod_phy_reg(pi, 0x4b6, (0xffff << 0), gain0_15 << 0);\n\tmod_phy_reg(pi, 0x4b7, (0xf << 0), gain16_19 << 0);\n\tmod_phy_reg(pi, 0x4b1, (0x3 << 11), lna1 << 11);\n\n\tif (LCNREV_LT(pi->pubpi.phy_rev, 2)) {\n\t\tmod_phy_reg(pi, 0x4b1, (0x1 << 9), ext_lna << 9);\n\t\tmod_phy_reg(pi, 0x4b1, (0x1 << 10), ext_lna << 10);\n\t} else {\n\t\tmod_phy_reg(pi, 0x4b1, (0x1 << 10), 0 << 10);\n\n\t\tmod_phy_reg(pi, 0x4b1, (0x1 << 15), 0 << 15);\n\n\t\tmod_phy_reg(pi, 0x4b1, (0x1 << 9), ext_lna << 9);\n\t}\n\n\tmod_phy_reg(pi, 0x44d, (0x1 << 0), (!trsw) << 0);\n\n}\n\nstatic void wlc_lcnphy_set_trsw_override(struct brcms_phy *pi, bool tx, bool rx)\n{\n\n\tmod_phy_reg(pi, 0x44d,\n\t\t    (0x1 << 1) |\n\t\t    (0x1 << 0), (tx ? (0x1 << 1) : 0) | (rx ? (0x1 << 0) : 0));\n\n\tor_phy_reg(pi, 0x44c, (0x1 << 1) | (0x1 << 0));\n}\n\nstatic void wlc_lcnphy_clear_trsw_override(struct brcms_phy *pi)\n{\n\n\tand_phy_reg(pi, 0x44c, (u16) ~((0x1 << 1) | (0x1 << 0)));\n}\n\nstatic void wlc_lcnphy_set_rx_iq_comp(struct brcms_phy *pi, u16 a, u16 b)\n{\n\tmod_phy_reg(pi, 0x645, (0x3ff << 0), (a) << 0);\n\n\tmod_phy_reg(pi, 0x646, (0x3ff << 0), (b) << 0);\n\n\tmod_phy_reg(pi, 0x647, (0x3ff << 0), (a) << 0);\n\n\tmod_phy_reg(pi, 0x648, (0x3ff << 0), (b) << 0);\n\n\tmod_phy_reg(pi, 0x649, (0x3ff << 0), (a) << 0);\n\n\tmod_phy_reg(pi, 0x64a, (0x3ff << 0), (b) << 0);\n\n}\n\nstatic bool\nwlc_lcnphy_rx_iq_est(struct brcms_phy *pi,\n\t\t     u16 num_samps,\n\t\t     u8 wait_time, struct lcnphy_iq_est *iq_est)\n{\n\tint wait_count = 0;\n\tbool result = true;\n\n\tmod_phy_reg(pi, 0x6da, (0x1 << 5), (1) << 5);\n\n\tmod_phy_reg(pi, 0x410, (0x1 << 3), (0) << 3);\n\n\tmod_phy_reg(pi, 0x482, (0xffff << 0), (num_samps) << 0);\n\n\tmod_phy_reg(pi, 0x481, (0xff << 0), ((u16) wait_time) << 0);\n\n\tmod_phy_reg(pi, 0x481, (0x1 << 8), (0) << 8);\n\n\tmod_phy_reg(pi, 0x481, (0x1 << 9), (1) << 9);\n\n\twhile (read_phy_reg(pi, 0x481) & (0x1 << 9)) {\n\n\t\tif (wait_count > (10 * 500)) {\n\t\t\tresult = false;\n\t\t\tgoto cleanup;\n\t\t}\n\t\tudelay(100);\n\t\twait_count++;\n\t}\n\n\tiq_est->iq_prod = ((u32) read_phy_reg(pi, 0x483) << 16) |\n\t\t\t  (u32) read_phy_reg(pi, 0x484);\n\tiq_est->i_pwr = ((u32) read_phy_reg(pi, 0x485) << 16) |\n\t\t\t(u32) read_phy_reg(pi, 0x486);\n\tiq_est->q_pwr = ((u32) read_phy_reg(pi, 0x487) << 16) |\n\t\t\t(u32) read_phy_reg(pi, 0x488);\n\ncleanup:\n\tmod_phy_reg(pi, 0x410, (0x1 << 3), (1) << 3);\n\n\tmod_phy_reg(pi, 0x6da, (0x1 << 5), (0) << 5);\n\n\treturn result;\n}\n\nstatic bool wlc_lcnphy_calc_rx_iq_comp(struct brcms_phy *pi, u16 num_samps)\n{\n#define LCNPHY_MIN_RXIQ_PWR 2\n\tbool result;\n\tu16 a0_new, b0_new;\n\tstruct lcnphy_iq_est iq_est = { 0, 0, 0 };\n\ts32 a, b, temp;\n\ts16 iq_nbits, qq_nbits, arsh, brsh;\n\ts32 iq;\n\tu32 ii, qq;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\ta0_new = ((read_phy_reg(pi, 0x645) & (0x3ff << 0)) >> 0);\n\tb0_new = ((read_phy_reg(pi, 0x646) & (0x3ff << 0)) >> 0);\n\tmod_phy_reg(pi, 0x6d1, (0x1 << 2), (0) << 2);\n\n\tmod_phy_reg(pi, 0x64b, (0x1 << 6), (1) << 6);\n\n\twlc_lcnphy_set_rx_iq_comp(pi, 0, 0);\n\n\tresult = wlc_lcnphy_rx_iq_est(pi, num_samps, 32, &iq_est);\n\tif (!result)\n\t\tgoto cleanup;\n\n\tiq = (s32) iq_est.iq_prod;\n\tii = iq_est.i_pwr;\n\tqq = iq_est.q_pwr;\n\n\tif ((ii + qq) < LCNPHY_MIN_RXIQ_PWR) {\n\t\tresult = false;\n\t\tgoto cleanup;\n\t}\n\n\tiq_nbits = wlc_phy_nbits(iq);\n\tqq_nbits = wlc_phy_nbits(qq);\n\n\tarsh = 10 - (30 - iq_nbits);\n\tif (arsh >= 0) {\n\t\ta = (-(iq << (30 - iq_nbits)) + (ii >> (1 + arsh)));\n\t\ttemp = (s32) (ii >> arsh);\n\t\tif (temp == 0)\n\t\t\treturn false;\n\t} else {\n\t\ta = (-(iq << (30 - iq_nbits)) + (ii << (-1 - arsh)));\n\t\ttemp = (s32) (ii << -arsh);\n\t\tif (temp == 0)\n\t\t\treturn false;\n\t}\n\ta /= temp;\n\tbrsh = qq_nbits - 31 + 20;\n\tif (brsh >= 0) {\n\t\tb = (qq << (31 - qq_nbits));\n\t\ttemp = (s32) (ii >> brsh);\n\t\tif (temp == 0)\n\t\t\treturn false;\n\t} else {\n\t\tb = (qq << (31 - qq_nbits));\n\t\ttemp = (s32) (ii << -brsh);\n\t\tif (temp == 0)\n\t\t\treturn false;\n\t}\n\tb /= temp;\n\tb -= a * a;\n\tb = (s32) int_sqrt((unsigned long) b);\n\tb -= (1 << 10);\n\ta0_new = (u16) (a & 0x3ff);\n\tb0_new = (u16) (b & 0x3ff);\ncleanup:\n\n\twlc_lcnphy_set_rx_iq_comp(pi, a0_new, b0_new);\n\n\tmod_phy_reg(pi, 0x64b, (0x1 << 0), (1) << 0);\n\n\tmod_phy_reg(pi, 0x64b, (0x1 << 3), (1) << 3);\n\n\tpi_lcn->lcnphy_cal_results.rxiqcal_coeff_a0 = a0_new;\n\tpi_lcn->lcnphy_cal_results.rxiqcal_coeff_b0 = b0_new;\n\n\treturn result;\n}\n\nstatic u32 wlc_lcnphy_measure_digital_power(struct brcms_phy *pi, u16 nsamples)\n{\n\tstruct lcnphy_iq_est iq_est = { 0, 0, 0 };\n\n\tif (!wlc_lcnphy_rx_iq_est(pi, nsamples, 32, &iq_est))\n\t\treturn 0;\n\treturn (iq_est.i_pwr + iq_est.q_pwr) / nsamples;\n}\n\nstatic bool wlc_lcnphy_rx_iq_cal_gain(struct brcms_phy *pi, u16 biq1_gain,\n\t\t\t\t      u16 tia_gain, u16 lna2_gain)\n{\n\tu32 i_thresh_l, q_thresh_l;\n\tu32 i_thresh_h, q_thresh_h;\n\tstruct lcnphy_iq_est iq_est_h, iq_est_l;\n\n\twlc_lcnphy_set_rx_gain_by_distribution(pi, 0, 0, 0, biq1_gain, tia_gain,\n\t\t\t\t\t       lna2_gain, 0);\n\n\twlc_lcnphy_rx_gain_override_enable(pi, true);\n\twlc_lcnphy_start_tx_tone(pi, 2000, (40 >> 1), 0);\n\tudelay(500);\n\twrite_radio_reg(pi, RADIO_2064_REG112, 0);\n\tif (!wlc_lcnphy_rx_iq_est(pi, 1024, 32, &iq_est_l))\n\t\treturn false;\n\n\twlc_lcnphy_start_tx_tone(pi, 2000, 40, 0);\n\tudelay(500);\n\twrite_radio_reg(pi, RADIO_2064_REG112, 0);\n\tif (!wlc_lcnphy_rx_iq_est(pi, 1024, 32, &iq_est_h))\n\t\treturn false;\n\n\ti_thresh_l = (iq_est_l.i_pwr << 1);\n\ti_thresh_h = (iq_est_l.i_pwr << 2) + iq_est_l.i_pwr;\n\n\tq_thresh_l = (iq_est_l.q_pwr << 1);\n\tq_thresh_h = (iq_est_l.q_pwr << 2) + iq_est_l.q_pwr;\n\tif ((iq_est_h.i_pwr > i_thresh_l) &&\n\t    (iq_est_h.i_pwr < i_thresh_h) &&\n\t    (iq_est_h.q_pwr > q_thresh_l) &&\n\t    (iq_est_h.q_pwr < q_thresh_h))\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic bool\nwlc_lcnphy_rx_iq_cal(struct brcms_phy *pi,\n\t\t     const struct lcnphy_rx_iqcomp *iqcomp,\n\t\t     int iqcomp_sz, bool tx_switch, bool rx_switch, int module,\n\t\t     int tx_gain_idx)\n{\n\tstruct lcnphy_txgains old_gains;\n\tu16 tx_pwr_ctrl;\n\tu8 tx_gain_index_old = 0;\n\tbool result = false, tx_gain_override_old = false;\n\tu16 i, Core1TxControl_old,\n\t    RFOverrideVal0_old, rfoverride2_old, rfoverride2val_old,\n\t    rfoverride3_old, rfoverride3val_old, rfoverride4_old,\n\t    rfoverride4val_old, afectrlovr_old, afectrlovrval_old;\n\tint tia_gain, lna2_gain, biq1_gain;\n\tbool set_gain;\n\tu16 old_sslpnCalibClkEnCtrl, old_sslpnRxFeClkEnCtrl;\n\tu16 values_to_save[11];\n\ts16 *ptr;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tptr = kmalloc_array(131, sizeof(s16), GFP_ATOMIC);\n\tif (NULL == ptr)\n\t\treturn false;\n\tif (module == 2) {\n\t\twhile (iqcomp_sz--) {\n\t\t\tif (iqcomp[iqcomp_sz].chan ==\n\t\t\t    CHSPEC_CHANNEL(pi->radio_chanspec)) {\n\t\t\t\twlc_lcnphy_set_rx_iq_comp(pi,\n\t\t\t\t\t\t\t  (u16)\n\t\t\t\t\t\t\t  iqcomp[iqcomp_sz].a,\n\t\t\t\t\t\t\t  (u16)\n\t\t\t\t\t\t\t  iqcomp[iqcomp_sz].b);\n\t\t\t\tresult = true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tgoto cal_done;\n\t}\n\n\tWARN_ON(module != 1);\n\ttx_pwr_ctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\n\n\tfor (i = 0; i < 11; i++)\n\t\tvalues_to_save[i] =\n\t\t\tread_radio_reg(pi, rxiq_cal_rf_reg[i]);\n\tCore1TxControl_old = read_phy_reg(pi, 0x631);\n\n\tor_phy_reg(pi, 0x631, 0x0015);\n\n\tread_phy_reg(pi, 0x44c);  \n\tRFOverrideVal0_old = read_phy_reg(pi, 0x44d);\n\trfoverride2_old = read_phy_reg(pi, 0x4b0);\n\trfoverride2val_old = read_phy_reg(pi, 0x4b1);\n\trfoverride3_old = read_phy_reg(pi, 0x4f9);\n\trfoverride3val_old = read_phy_reg(pi, 0x4fa);\n\trfoverride4_old = read_phy_reg(pi, 0x938);\n\trfoverride4val_old = read_phy_reg(pi, 0x939);\n\tafectrlovr_old = read_phy_reg(pi, 0x43b);\n\tafectrlovrval_old = read_phy_reg(pi, 0x43c);\n\told_sslpnCalibClkEnCtrl = read_phy_reg(pi, 0x6da);\n\told_sslpnRxFeClkEnCtrl = read_phy_reg(pi, 0x6db);\n\n\ttx_gain_override_old = wlc_lcnphy_tx_gain_override_enabled(pi);\n\tif (tx_gain_override_old) {\n\t\twlc_lcnphy_get_tx_gain(pi, &old_gains);\n\t\ttx_gain_index_old = pi_lcn->lcnphy_current_index;\n\t}\n\n\twlc_lcnphy_set_tx_pwr_by_index(pi, tx_gain_idx);\n\n\tmod_phy_reg(pi, 0x4f9, (0x1 << 0), 1 << 0);\n\tmod_phy_reg(pi, 0x4fa, (0x1 << 0), 0 << 0);\n\n\tmod_phy_reg(pi, 0x43b, (0x1 << 1), 1 << 1);\n\tmod_phy_reg(pi, 0x43c, (0x1 << 1), 0 << 1);\n\n\twrite_radio_reg(pi, RADIO_2064_REG116, 0x06);\n\twrite_radio_reg(pi, RADIO_2064_REG12C, 0x07);\n\twrite_radio_reg(pi, RADIO_2064_REG06A, 0xd3);\n\twrite_radio_reg(pi, RADIO_2064_REG098, 0x03);\n\twrite_radio_reg(pi, RADIO_2064_REG00B, 0x7);\n\tmod_radio_reg(pi, RADIO_2064_REG113, 1 << 4, 1 << 4);\n\twrite_radio_reg(pi, RADIO_2064_REG01D, 0x01);\n\twrite_radio_reg(pi, RADIO_2064_REG114, 0x01);\n\twrite_radio_reg(pi, RADIO_2064_REG02E, 0x10);\n\twrite_radio_reg(pi, RADIO_2064_REG12A, 0x08);\n\n\tmod_phy_reg(pi, 0x938, (0x1 << 0), 1 << 0);\n\tmod_phy_reg(pi, 0x939, (0x1 << 0), 0 << 0);\n\tmod_phy_reg(pi, 0x938, (0x1 << 1), 1 << 1);\n\tmod_phy_reg(pi, 0x939, (0x1 << 1), 1 << 1);\n\tmod_phy_reg(pi, 0x938, (0x1 << 2), 1 << 2);\n\tmod_phy_reg(pi, 0x939, (0x1 << 2), 1 << 2);\n\tmod_phy_reg(pi, 0x938, (0x1 << 3), 1 << 3);\n\tmod_phy_reg(pi, 0x939, (0x1 << 3), 1 << 3);\n\tmod_phy_reg(pi, 0x938, (0x1 << 5), 1 << 5);\n\tmod_phy_reg(pi, 0x939, (0x1 << 5), 0 << 5);\n\n\tmod_phy_reg(pi, 0x43b, (0x1 << 0), 1 << 0);\n\tmod_phy_reg(pi, 0x43c, (0x1 << 0), 0 << 0);\n\n\twrite_phy_reg(pi, 0x6da, 0xffff);\n\tor_phy_reg(pi, 0x6db, 0x3);\n\n\twlc_lcnphy_set_trsw_override(pi, tx_switch, rx_switch);\n\tfor (lna2_gain = 3; lna2_gain >= 0; lna2_gain--) {\n\t\tfor (tia_gain = 4; tia_gain >= 0; tia_gain--) {\n\t\t\tfor (biq1_gain = 6; biq1_gain >= 0; biq1_gain--) {\n\t\t\t\tset_gain = wlc_lcnphy_rx_iq_cal_gain(pi,\n\t\t\t\t\t\t\t\t     (u16)\n\t\t\t\t\t\t\t\t     biq1_gain,\n\t\t\t\t\t\t\t\t     (u16)\n\t\t\t\t\t\t\t\t     tia_gain,\n\t\t\t\t\t\t\t\t     (u16)\n\t\t\t\t\t\t\t\t     lna2_gain);\n\t\t\t\tif (!set_gain)\n\t\t\t\t\tcontinue;\n\n\t\t\t\tresult = wlc_lcnphy_calc_rx_iq_comp(pi, 1024);\n\t\t\t\tgoto stop_tone;\n\t\t\t}\n\t\t}\n\t}\n\nstop_tone:\n\twlc_lcnphy_stop_tx_tone(pi);\n\n\twrite_phy_reg(pi, 0x631, Core1TxControl_old);\n\n\twrite_phy_reg(pi, 0x44c, RFOverrideVal0_old);\n\twrite_phy_reg(pi, 0x44d, RFOverrideVal0_old);\n\twrite_phy_reg(pi, 0x4b0, rfoverride2_old);\n\twrite_phy_reg(pi, 0x4b1, rfoverride2val_old);\n\twrite_phy_reg(pi, 0x4f9, rfoverride3_old);\n\twrite_phy_reg(pi, 0x4fa, rfoverride3val_old);\n\twrite_phy_reg(pi, 0x938, rfoverride4_old);\n\twrite_phy_reg(pi, 0x939, rfoverride4val_old);\n\twrite_phy_reg(pi, 0x43b, afectrlovr_old);\n\twrite_phy_reg(pi, 0x43c, afectrlovrval_old);\n\twrite_phy_reg(pi, 0x6da, old_sslpnCalibClkEnCtrl);\n\twrite_phy_reg(pi, 0x6db, old_sslpnRxFeClkEnCtrl);\n\n\twlc_lcnphy_clear_trsw_override(pi);\n\n\tmod_phy_reg(pi, 0x44c, (0x1 << 2), 0 << 2);\n\n\tfor (i = 0; i < 11; i++)\n\t\twrite_radio_reg(pi, rxiq_cal_rf_reg[i],\n\t\t\t\tvalues_to_save[i]);\n\n\tif (tx_gain_override_old)\n\t\twlc_lcnphy_set_tx_pwr_by_index(pi, tx_gain_index_old);\n\telse\n\t\twlc_lcnphy_disable_tx_gain_override(pi);\n\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, tx_pwr_ctrl);\n\twlc_lcnphy_rx_gain_override_enable(pi, false);\n\ncal_done:\n\tkfree(ptr);\n\treturn result;\n}\n\ns8 wlc_lcnphy_get_current_tx_pwr_idx(struct brcms_phy *pi)\n{\n\ts8 index;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tif (txpwrctrl_off(pi))\n\t\tindex = pi_lcn->lcnphy_current_index;\n\telse if (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi))\n\t\tindex =\t(s8) (wlc_lcnphy_get_current_tx_pwr_idx_if_pwrctrl_on(\n\t\t\t      pi) / 2);\n\telse\n\t\tindex = pi_lcn->lcnphy_current_index;\n\treturn index;\n}\n\nvoid wlc_lcnphy_crsuprs(struct brcms_phy *pi, int channel)\n{\n\tu16 afectrlovr, afectrlovrval;\n\tafectrlovr = read_phy_reg(pi, 0x43b);\n\tafectrlovrval = read_phy_reg(pi, 0x43c);\n\tif (channel != 0) {\n\t\tmod_phy_reg(pi, 0x43b, (0x1 << 1), (1) << 1);\n\n\t\tmod_phy_reg(pi, 0x43c, (0x1 << 1), (0) << 1);\n\n\t\tmod_phy_reg(pi, 0x43b, (0x1 << 4), (1) << 4);\n\n\t\tmod_phy_reg(pi, 0x43c, (0x1 << 6), (0) << 6);\n\n\t\twrite_phy_reg(pi, 0x44b, 0xffff);\n\t\twlc_lcnphy_tx_pu(pi, 1);\n\n\t\tmod_phy_reg(pi, 0x634, (0xff << 8), (0) << 8);\n\n\t\tor_phy_reg(pi, 0x6da, 0x0080);\n\n\t\tor_phy_reg(pi, 0x00a, 0x228);\n\t} else {\n\t\tand_phy_reg(pi, 0x00a, ~(0x228));\n\n\t\tand_phy_reg(pi, 0x6da, 0xFF7F);\n\t\twrite_phy_reg(pi, 0x43b, afectrlovr);\n\t\twrite_phy_reg(pi, 0x43c, afectrlovrval);\n\t}\n}\n\nstatic void wlc_lcnphy_toggle_afe_pwdn(struct brcms_phy *pi)\n{\n\tu16 save_AfeCtrlOvrVal, save_AfeCtrlOvr;\n\n\tsave_AfeCtrlOvrVal = read_phy_reg(pi, 0x43c);\n\tsave_AfeCtrlOvr = read_phy_reg(pi, 0x43b);\n\n\twrite_phy_reg(pi, 0x43c, save_AfeCtrlOvrVal | 0x1);\n\twrite_phy_reg(pi, 0x43b, save_AfeCtrlOvr | 0x1);\n\n\twrite_phy_reg(pi, 0x43c, save_AfeCtrlOvrVal & 0xfffe);\n\twrite_phy_reg(pi, 0x43b, save_AfeCtrlOvr & 0xfffe);\n\n\twrite_phy_reg(pi, 0x43c, save_AfeCtrlOvrVal);\n\twrite_phy_reg(pi, 0x43b, save_AfeCtrlOvr);\n}\n\nstatic void\nwlc_lcnphy_txrx_spur_avoidance_mode(struct brcms_phy *pi, bool enable)\n{\n\tif (enable) {\n\t\twrite_phy_reg(pi, 0x942, 0x7);\n\t\twrite_phy_reg(pi, 0x93b, ((1 << 13) + 23));\n\t\twrite_phy_reg(pi, 0x93c, ((1 << 13) + 1989));\n\n\t\twrite_phy_reg(pi, 0x44a, 0x084);\n\t\twrite_phy_reg(pi, 0x44a, 0x080);\n\t\twrite_phy_reg(pi, 0x6d3, 0x2222);\n\t\twrite_phy_reg(pi, 0x6d3, 0x2220);\n\t} else {\n\t\twrite_phy_reg(pi, 0x942, 0x0);\n\t\twrite_phy_reg(pi, 0x93b, ((0 << 13) + 23));\n\t\twrite_phy_reg(pi, 0x93c, ((0 << 13) + 1989));\n\t}\n\twlapi_switch_macfreq(pi->sh->physhim, enable);\n}\n\nstatic void\nwlc_lcnphy_set_chanspec_tweaks(struct brcms_phy *pi, u16 chanspec)\n{\n\tu8 channel = CHSPEC_CHANNEL(chanspec);\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tif (channel == 14)\n\t\tmod_phy_reg(pi, 0x448, (0x3 << 8), (2) << 8);\n\telse\n\t\tmod_phy_reg(pi, 0x448, (0x3 << 8), (1) << 8);\n\n\tpi_lcn->lcnphy_bandedge_corr = 2;\n\tif (channel == 1)\n\t\tpi_lcn->lcnphy_bandedge_corr = 4;\n\n\tif (channel == 1 || channel == 2 || channel == 3 ||\n\t    channel == 4 || channel == 9 ||\n\t    channel == 10 || channel == 11 || channel == 12) {\n\t\tbcma_chipco_pll_write(&pi->d11core->bus->drv_cc, 0x2,\n\t\t\t\t      0x03000c04);\n\t\tbcma_chipco_pll_maskset(&pi->d11core->bus->drv_cc, 0x3,\n\t\t\t\t\t~0x00ffffff, 0x0);\n\t\tbcma_chipco_pll_write(&pi->d11core->bus->drv_cc, 0x4,\n\t\t\t\t      0x200005c0);\n\n\t\tbcma_cc_set32(&pi->d11core->bus->drv_cc, BCMA_CC_PMU_CTL,\n\t\t\t      BCMA_CC_PMU_CTL_PLL_UPD);\n\t\twrite_phy_reg(pi, 0x942, 0);\n\t\twlc_lcnphy_txrx_spur_avoidance_mode(pi, false);\n\t\tpi_lcn->lcnphy_spurmod = false;\n\t\tmod_phy_reg(pi, 0x424, (0xff << 8), (0x1b) << 8);\n\n\t\twrite_phy_reg(pi, 0x425, 0x5907);\n\t} else {\n\t\tbcma_chipco_pll_write(&pi->d11core->bus->drv_cc, 0x2,\n\t\t\t\t      0x03140c04);\n\t\tbcma_chipco_pll_maskset(&pi->d11core->bus->drv_cc, 0x3,\n\t\t\t\t\t~0x00ffffff, 0x333333);\n\t\tbcma_chipco_pll_write(&pi->d11core->bus->drv_cc, 0x4,\n\t\t\t\t      0x202c2820);\n\n\t\tbcma_cc_set32(&pi->d11core->bus->drv_cc, BCMA_CC_PMU_CTL,\n\t\t\t      BCMA_CC_PMU_CTL_PLL_UPD);\n\t\twrite_phy_reg(pi, 0x942, 0);\n\t\twlc_lcnphy_txrx_spur_avoidance_mode(pi, true);\n\n\t\tpi_lcn->lcnphy_spurmod = false;\n\t\tmod_phy_reg(pi, 0x424, (0xff << 8), (0x1f) << 8);\n\n\t\twrite_phy_reg(pi, 0x425, 0x590a);\n\t}\n\n\tor_phy_reg(pi, 0x44a, 0x44);\n\twrite_phy_reg(pi, 0x44a, 0x80);\n}\n\nstatic void\nwlc_lcnphy_radio_2064_channel_tune_4313(struct brcms_phy *pi, u8 channel)\n{\n\tuint i;\n\tconst struct chan_info_2064_lcnphy *ci;\n\tu8 rfpll_doubler = 0;\n\tu8 pll_pwrup, pll_pwrup_ovr;\n\ts32 qFcal;\n\tu8 d15, d16, f16, e44, e45;\n\tu32 div_int, div_frac, fvco3, fpfd, fref3, fcal_div;\n\tu16 loop_bw, d30, setCount;\n\n\tu8 h29, h28_ten, e30, h30_ten, cp_current;\n\tu16 g30, d28;\n\n\tci = &chan_info_2064_lcnphy[0];\n\trfpll_doubler = 1;\n\n\tmod_radio_reg(pi, RADIO_2064_REG09D, 0x4, 0x1 << 2);\n\n\twrite_radio_reg(pi, RADIO_2064_REG09E, 0xf);\n\tif (!rfpll_doubler) {\n\t\tloop_bw = PLL_2064_LOOP_BW;\n\t\td30 = PLL_2064_D30;\n\t} else {\n\t\tloop_bw = PLL_2064_LOOP_BW_DOUBLER;\n\t\td30 = PLL_2064_D30_DOUBLER;\n\t}\n\n\tif (CHSPEC_IS2G(pi->radio_chanspec)) {\n\t\tfor (i = 0; i < ARRAY_SIZE(chan_info_2064_lcnphy); i++)\n\t\t\tif (chan_info_2064_lcnphy[i].chan == channel)\n\t\t\t\tbreak;\n\n\t\tif (i >= ARRAY_SIZE(chan_info_2064_lcnphy))\n\t\t\treturn;\n\n\t\tci = &chan_info_2064_lcnphy[i];\n\t}\n\n\twrite_radio_reg(pi, RADIO_2064_REG02A, ci->logen_buftune);\n\n\tmod_radio_reg(pi, RADIO_2064_REG030, 0x3, ci->logen_rccr_tx);\n\n\tmod_radio_reg(pi, RADIO_2064_REG091, 0x3, ci->txrf_mix_tune_ctrl);\n\n\tmod_radio_reg(pi, RADIO_2064_REG038, 0xf, ci->pa_input_tune_g);\n\n\tmod_radio_reg(pi, RADIO_2064_REG030, 0x3 << 2,\n\t\t      (ci->logen_rccr_rx) << 2);\n\n\tmod_radio_reg(pi, RADIO_2064_REG05E, 0xf, ci->pa_rxrf_lna1_freq_tune);\n\n\tmod_radio_reg(pi, RADIO_2064_REG05E, (0xf) << 4,\n\t\t      (ci->pa_rxrf_lna2_freq_tune) << 4);\n\n\twrite_radio_reg(pi, RADIO_2064_REG06C, ci->rxrf_rxrf_spare1);\n\n\tpll_pwrup = (u8) read_radio_reg(pi, RADIO_2064_REG044);\n\tpll_pwrup_ovr = (u8) read_radio_reg(pi, RADIO_2064_REG12B);\n\n\tor_radio_reg(pi, RADIO_2064_REG044, 0x07);\n\n\tor_radio_reg(pi, RADIO_2064_REG12B, (0x07) << 1);\n\te44 = 0;\n\te45 = 0;\n\n\tfpfd = rfpll_doubler ? (pi->xtalfreq << 1) : (pi->xtalfreq);\n\tif (pi->xtalfreq > 26000000)\n\t\te44 = 1;\n\tif (pi->xtalfreq > 52000000)\n\t\te45 = 1;\n\tif (e44 == 0)\n\t\tfcal_div = 1;\n\telse if (e45 == 0)\n\t\tfcal_div = 2;\n\telse\n\t\tfcal_div = 4;\n\tfvco3 = (ci->freq * 3);\n\tfref3 = 2 * fpfd;\n\n\tqFcal = pi->xtalfreq * fcal_div / PLL_2064_MHZ;\n\n\twrite_radio_reg(pi, RADIO_2064_REG04F, 0x02);\n\n\td15 = (pi->xtalfreq * fcal_div * 4 / 5) / PLL_2064_MHZ - 1;\n\twrite_radio_reg(pi, RADIO_2064_REG052, (0x07 & (d15 >> 2)));\n\twrite_radio_reg(pi, RADIO_2064_REG053, (d15 & 0x3) << 5);\n\n\td16 = (qFcal * 8 / (d15 + 1)) - 1;\n\twrite_radio_reg(pi, RADIO_2064_REG051, d16);\n\n\tf16 = ((d16 + 1) * (d15 + 1)) / qFcal;\n\tsetCount = f16 * 3 * (ci->freq) / 32 - 1;\n\tmod_radio_reg(pi, RADIO_2064_REG053, (0x0f << 0),\n\t\t      (u8) (setCount >> 8));\n\n\tor_radio_reg(pi, RADIO_2064_REG053, 0x10);\n\twrite_radio_reg(pi, RADIO_2064_REG054, (u8) (setCount & 0xff));\n\n\tdiv_int = ((fvco3 * (PLL_2064_MHZ >> 4)) / fref3) << 4;\n\n\tdiv_frac = ((fvco3 * (PLL_2064_MHZ >> 4)) % fref3) << 4;\n\twhile (div_frac >= fref3) {\n\t\tdiv_int++;\n\t\tdiv_frac -= fref3;\n\t}\n\tdiv_frac = wlc_lcnphy_qdiv_roundup(div_frac, fref3, 20);\n\n\tmod_radio_reg(pi, RADIO_2064_REG045, (0x1f << 0),\n\t\t      (u8) (div_int >> 4));\n\tmod_radio_reg(pi, RADIO_2064_REG046, (0x1f << 4),\n\t\t      (u8) (div_int << 4));\n\tmod_radio_reg(pi, RADIO_2064_REG046, (0x0f << 0),\n\t\t      (u8) (div_frac >> 16));\n\twrite_radio_reg(pi, RADIO_2064_REG047, (u8) (div_frac >> 8) & 0xff);\n\twrite_radio_reg(pi, RADIO_2064_REG048, (u8) div_frac & 0xff);\n\n\twrite_radio_reg(pi, RADIO_2064_REG040, 0xfb);\n\n\twrite_radio_reg(pi, RADIO_2064_REG041, 0x9A);\n\twrite_radio_reg(pi, RADIO_2064_REG042, 0xA3);\n\twrite_radio_reg(pi, RADIO_2064_REG043, 0x0C);\n\n\th29 = LCN_BW_LMT / loop_bw;\n\td28 = (((PLL_2064_HIGH_END_KVCO - PLL_2064_LOW_END_KVCO) *\n\t\t(fvco3 / 2 - PLL_2064_LOW_END_VCO)) /\n\t       (PLL_2064_HIGH_END_VCO - PLL_2064_LOW_END_VCO))\n\t      + PLL_2064_LOW_END_KVCO;\n\th28_ten = (d28 * 10) / LCN_VCO_DIV;\n\te30 = (d30 - LCN_OFFSET) / LCN_FACT;\n\tg30 = LCN_OFFSET + (e30 * LCN_FACT);\n\th30_ten = (g30 * 10) / LCN_CUR_DIV;\n\tcp_current = ((LCN_CUR_LMT * h29 * LCN_MULT * 100) / h28_ten) / h30_ten;\n\tmod_radio_reg(pi, RADIO_2064_REG03C, 0x3f, cp_current);\n\n\tif (channel >= 1 && channel <= 5)\n\t\twrite_radio_reg(pi, RADIO_2064_REG03C, 0x8);\n\telse\n\t\twrite_radio_reg(pi, RADIO_2064_REG03C, 0x7);\n\twrite_radio_reg(pi, RADIO_2064_REG03D, 0x3);\n\n\tmod_radio_reg(pi, RADIO_2064_REG044, 0x0c, 0x0c);\n\tudelay(1);\n\n\twlc_2064_vco_cal(pi);\n\n\twrite_radio_reg(pi, RADIO_2064_REG044, pll_pwrup);\n\twrite_radio_reg(pi, RADIO_2064_REG12B, pll_pwrup_ovr);\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 1)) {\n\t\twrite_radio_reg(pi, RADIO_2064_REG038, 3);\n\t\twrite_radio_reg(pi, RADIO_2064_REG091, 7);\n\t}\n\n\tif (!(pi->sh->boardflags & BFL_FEM)) {\n\t\tstatic const u8 reg038[14] = {\n\t\t\t0xd, 0xe, 0xd, 0xd, 0xd, 0xc, 0xa,\n\t\t\t0xb, 0xb, 0x3, 0x3, 0x2, 0x0, 0x0\n\t\t};\n\n\t\twrite_radio_reg(pi, RADIO_2064_REG02A, 0xf);\n\t\twrite_radio_reg(pi, RADIO_2064_REG091, 0x3);\n\t\twrite_radio_reg(pi, RADIO_2064_REG038, 0x3);\n\n\t\twrite_radio_reg(pi, RADIO_2064_REG038, reg038[channel - 1]);\n\t}\n}\n\nstatic int\nwlc_lcnphy_load_tx_iir_filter(struct brcms_phy *pi, bool is_ofdm, s16 filt_type)\n{\n\ts16 filt_index = -1;\n\tint j;\n\n\tu16 addr[] = {\n\t\t0x910,\n\t\t0x91e,\n\t\t0x91f,\n\t\t0x924,\n\t\t0x925,\n\t\t0x926,\n\t\t0x920,\n\t\t0x921,\n\t\t0x927,\n\t\t0x928,\n\t\t0x929,\n\t\t0x922,\n\t\t0x923,\n\t\t0x930,\n\t\t0x931,\n\t\t0x932\n\t};\n\n\tu16 addr_ofdm[] = {\n\t\t0x90f,\n\t\t0x900,\n\t\t0x901,\n\t\t0x906,\n\t\t0x907,\n\t\t0x908,\n\t\t0x902,\n\t\t0x903,\n\t\t0x909,\n\t\t0x90a,\n\t\t0x90b,\n\t\t0x904,\n\t\t0x905,\n\t\t0x90c,\n\t\t0x90d,\n\t\t0x90e\n\t};\n\n\tif (!is_ofdm) {\n\t\tfor (j = 0; j < LCNPHY_NUM_TX_DIG_FILTERS_CCK; j++) {\n\t\t\tif (filt_type == LCNPHY_txdigfiltcoeffs_cck[j][0]) {\n\t\t\t\tfilt_index = (s16) j;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (filt_index != -1) {\n\t\t\tfor (j = 0; j < LCNPHY_NUM_DIG_FILT_COEFFS; j++)\n\t\t\t\twrite_phy_reg(pi, addr[j],\n\t\t\t\t\t      LCNPHY_txdigfiltcoeffs_cck\n\t\t\t\t\t      [filt_index][j + 1]);\n\t\t}\n\t} else {\n\t\tfor (j = 0; j < LCNPHY_NUM_TX_DIG_FILTERS_OFDM; j++) {\n\t\t\tif (filt_type == LCNPHY_txdigfiltcoeffs_ofdm[j][0]) {\n\t\t\t\tfilt_index = (s16) j;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (filt_index != -1) {\n\t\t\tfor (j = 0; j < LCNPHY_NUM_DIG_FILT_COEFFS; j++)\n\t\t\t\twrite_phy_reg(pi, addr_ofdm[j],\n\t\t\t\t\t      LCNPHY_txdigfiltcoeffs_ofdm\n\t\t\t\t\t      [filt_index][j + 1]);\n\t\t}\n\t}\n\n\treturn (filt_index != -1) ? 0 : -1;\n}\n\nstatic u16 wlc_lcnphy_get_pa_gain(struct brcms_phy *pi)\n{\n\tu16 pa_gain;\n\n\tpa_gain = (read_phy_reg(pi, 0x4fb) &\n\t\t   LCNPHY_txgainctrlovrval1_pagain_ovr_val1_MASK) >>\n\t\t  LCNPHY_txgainctrlovrval1_pagain_ovr_val1_SHIFT;\n\n\treturn pa_gain;\n}\n\nstatic void wlc_lcnphy_set_tx_gain(struct brcms_phy *pi,\n\t\t\t\t   struct lcnphy_txgains *target_gains)\n{\n\tu16 pa_gain = wlc_lcnphy_get_pa_gain(pi);\n\n\tmod_phy_reg(\n\t\tpi, 0x4b5,\n\t\t(0xffff << 0),\n\t\t((target_gains->gm_gain) |\n\t\t (target_gains->pga_gain << 8)) <<\n\t\t0);\n\tmod_phy_reg(pi, 0x4fb,\n\t\t    (0x7fff << 0),\n\t\t    ((target_gains->pad_gain) | (pa_gain << 8)) << 0);\n\n\tmod_phy_reg(\n\t\tpi, 0x4fc,\n\t\t(0xffff << 0),\n\t\t((target_gains->gm_gain) |\n\t\t (target_gains->pga_gain << 8)) <<\n\t\t0);\n\tmod_phy_reg(pi, 0x4fd,\n\t\t    (0x7fff << 0),\n\t\t    ((target_gains->pad_gain) | (pa_gain << 8)) << 0);\n\n\twlc_lcnphy_set_dac_gain(pi, target_gains->dac_gain);\n\n\twlc_lcnphy_enable_tx_gain_override(pi);\n}\n\nstatic u8 wlc_lcnphy_get_bbmult(struct brcms_phy *pi)\n{\n\tu16 m0m1;\n\tstruct phytbl_info tab;\n\n\ttab.tbl_ptr = &m0m1;\n\ttab.tbl_len = 1;\n\ttab.tbl_id = LCNPHY_TBL_ID_IQLOCAL;\n\ttab.tbl_offset = 87;\n\ttab.tbl_width = 16;\n\twlc_lcnphy_read_table(pi, &tab);\n\n\treturn (u8) ((m0m1 & 0xff00) >> 8);\n}\n\nstatic void wlc_lcnphy_set_bbmult(struct brcms_phy *pi, u8 m0)\n{\n\tu16 m0m1 = (u16) m0 << 8;\n\tstruct phytbl_info tab;\n\n\ttab.tbl_ptr = &m0m1;\n\ttab.tbl_len = 1;\n\ttab.tbl_id = LCNPHY_TBL_ID_IQLOCAL;\n\ttab.tbl_offset = 87;\n\ttab.tbl_width = 16;\n\twlc_lcnphy_write_table(pi, &tab);\n}\n\nstatic void wlc_lcnphy_clear_tx_power_offsets(struct brcms_phy *pi)\n{\n\tu32 data_buf[64];\n\tstruct phytbl_info tab;\n\n\tmemset(data_buf, 0, sizeof(data_buf));\n\n\ttab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\n\ttab.tbl_width = 32;\n\ttab.tbl_ptr = data_buf;\n\n\tif (!wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi)) {\n\n\t\ttab.tbl_len = 30;\n\t\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_RATE_OFFSET;\n\t\twlc_lcnphy_write_table(pi, &tab);\n\t}\n\n\ttab.tbl_len = 64;\n\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_MAC_OFFSET;\n\twlc_lcnphy_write_table(pi, &tab);\n}\n\nenum lcnphy_tssi_mode {\n\tLCNPHY_TSSI_PRE_PA,\n\tLCNPHY_TSSI_POST_PA,\n\tLCNPHY_TSSI_EXT\n};\n\nstatic void\nwlc_lcnphy_set_tssi_mux(struct brcms_phy *pi, enum lcnphy_tssi_mode pos)\n{\n\tmod_phy_reg(pi, 0x4d7, (0x1 << 0), (0x1) << 0);\n\n\tmod_phy_reg(pi, 0x4d7, (0x1 << 6), (1) << 6);\n\n\tif (LCNPHY_TSSI_POST_PA == pos) {\n\t\tmod_phy_reg(pi, 0x4d9, (0x1 << 2), (0) << 2);\n\n\t\tmod_phy_reg(pi, 0x4d9, (0x1 << 3), (1) << 3);\n\n\t\tif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG086, 0x4, 0x4);\n\t\t} else {\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG03A, 1, 0x1);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG11A, 0x8, 0x8);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG028, 0x1, 0x0);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG11A, 0x4, 1<<2);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG036, 0x10, 0x0);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG11A, 0x10, 1<<4);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG036, 0x3, 0x0);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG035, 0xff, 0x77);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG028, 0x1e, 0xe<<1);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG112, 0x80, 1<<7);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG005, 0x7, 1<<1);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG029, 0xf0, 0<<4);\n\t\t}\n\t} else {\n\t\tmod_phy_reg(pi, 0x4d9, (0x1 << 2), (0x1) << 2);\n\n\t\tmod_phy_reg(pi, 0x4d9, (0x1 << 3), (0) << 3);\n\n\t\tif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG086, 0x4, 0x4);\n\t\t} else {\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG03A, 1, 0);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG11A, 0x8, 0x8);\n\t\t}\n\t}\n\tmod_phy_reg(pi, 0x637, (0x3 << 14), (0) << 14);\n\n\tif (LCNPHY_TSSI_EXT == pos) {\n\t\twrite_radio_reg(pi, RADIO_2064_REG07F, 1);\n\t\tmod_radio_reg(pi, RADIO_2064_REG005, 0x7, 0x2);\n\t\tmod_radio_reg(pi, RADIO_2064_REG112, 0x80, 0x1 << 7);\n\t\tmod_radio_reg(pi, RADIO_2064_REG028, 0x1f, 0x3);\n\t}\n}\n\nstatic u16 wlc_lcnphy_rfseq_tbl_adc_pwrup(struct brcms_phy *pi)\n{\n\tu16 N1, N2, N3, N4, N5, N6, N;\n\tN1 = ((read_phy_reg(pi, 0x4a5) & (0xff << 0))\n\t      >> 0);\n\tN2 = 1 << ((read_phy_reg(pi, 0x4a5) & (0x7 << 12))\n\t\t   >> 12);\n\tN3 = ((read_phy_reg(pi, 0x40d) & (0xff << 0))\n\t      >> 0);\n\tN4 = 1 << ((read_phy_reg(pi, 0x40d) & (0x7 << 8))\n\t\t   >> 8);\n\tN5 = ((read_phy_reg(pi, 0x4a2) & (0xff << 0))\n\t      >> 0);\n\tN6 = 1 << ((read_phy_reg(pi, 0x4a2) & (0x7 << 8))\n\t\t   >> 8);\n\tN = 2 * (N1 + N2 + N3 + N4 + 2 * (N5 + N6)) + 80;\n\tif (N < 1600)\n\t\tN = 1600;\n\treturn N;\n}\n\nstatic void wlc_lcnphy_pwrctrl_rssiparams(struct brcms_phy *pi)\n{\n\tu16 auxpga_vmid, auxpga_vmid_temp, auxpga_gain_temp;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tauxpga_vmid = (2 << 8) |\n\t\t      (pi_lcn->lcnphy_rssi_vc << 4) | pi_lcn->lcnphy_rssi_vf;\n\tauxpga_vmid_temp = (2 << 8) | (8 << 4) | 4;\n\tauxpga_gain_temp = 2;\n\n\tmod_phy_reg(pi, 0x4d8, (0x1 << 0), (0) << 0);\n\n\tmod_phy_reg(pi, 0x4d8, (0x1 << 1), (0) << 1);\n\n\tmod_phy_reg(pi, 0x4d7, (0x1 << 3), (0) << 3);\n\n\tmod_phy_reg(pi, 0x4db,\n\t\t    (0x3ff << 0) |\n\t\t    (0x7 << 12),\n\t\t    (auxpga_vmid << 0) | (pi_lcn->lcnphy_rssi_gs << 12));\n\n\tmod_phy_reg(pi, 0x4dc,\n\t\t    (0x3ff << 0) |\n\t\t    (0x7 << 12),\n\t\t    (auxpga_vmid << 0) | (pi_lcn->lcnphy_rssi_gs << 12));\n\n\tmod_phy_reg(pi, 0x40a,\n\t\t    (0x3ff << 0) |\n\t\t    (0x7 << 12),\n\t\t    (auxpga_vmid << 0) | (pi_lcn->lcnphy_rssi_gs << 12));\n\n\tmod_phy_reg(pi, 0x40b,\n\t\t    (0x3ff << 0) |\n\t\t    (0x7 << 12),\n\t\t    (auxpga_vmid_temp << 0) | (auxpga_gain_temp << 12));\n\n\tmod_phy_reg(pi, 0x40c,\n\t\t    (0x3ff << 0) |\n\t\t    (0x7 << 12),\n\t\t    (auxpga_vmid_temp << 0) | (auxpga_gain_temp << 12));\n\n\tmod_radio_reg(pi, RADIO_2064_REG082, (1 << 5), (1 << 5));\n\tmod_radio_reg(pi, RADIO_2064_REG07C, (1 << 0), (1 << 0));\n}\n\nstatic void wlc_lcnphy_tssi_setup(struct brcms_phy *pi)\n{\n\tstruct phytbl_info tab;\n\tu32 rfseq, ind;\n\tenum lcnphy_tssi_mode mode;\n\tu8 tssi_sel;\n\n\tif (pi->sh->boardflags & BFL_FEM) {\n\t\ttssi_sel = 0x1;\n\t\tmode = LCNPHY_TSSI_EXT;\n\t} else {\n\t\ttssi_sel = 0xe;\n\t\tmode = LCNPHY_TSSI_POST_PA;\n\t}\n\ttab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\n\ttab.tbl_width = 32;\n\ttab.tbl_ptr = &ind;\n\ttab.tbl_len = 1;\n\ttab.tbl_offset = 0;\n\tfor (ind = 0; ind < 128; ind++) {\n\t\twlc_lcnphy_write_table(pi, &tab);\n\t\ttab.tbl_offset++;\n\t}\n\ttab.tbl_offset = 704;\n\tfor (ind = 0; ind < 128; ind++) {\n\t\twlc_lcnphy_write_table(pi, &tab);\n\t\ttab.tbl_offset++;\n\t}\n\tmod_phy_reg(pi, 0x503, (0x1 << 0), (0) << 0);\n\n\tmod_phy_reg(pi, 0x503, (0x1 << 2), (0) << 2);\n\n\tmod_phy_reg(pi, 0x503, (0x1 << 4), (1) << 4);\n\n\twlc_lcnphy_set_tssi_mux(pi, mode);\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 14), (0) << 14);\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 15), (1) << 15);\n\n\tmod_phy_reg(pi, 0x4d0, (0x1 << 5), (0) << 5);\n\n\tmod_phy_reg(pi, 0x4a4, (0x1ff << 0), (0) << 0);\n\n\tmod_phy_reg(pi, 0x4a5, (0xff << 0), (255) << 0);\n\n\tmod_phy_reg(pi, 0x4a5, (0x7 << 12), (5) << 12);\n\n\tmod_phy_reg(pi, 0x4a5, (0x7 << 8), (0) << 8);\n\n\tmod_phy_reg(pi, 0x40d, (0xff << 0), (64) << 0);\n\n\tmod_phy_reg(pi, 0x40d, (0x7 << 8), (4) << 8);\n\n\tmod_phy_reg(pi, 0x4a2, (0xff << 0), (64) << 0);\n\n\tmod_phy_reg(pi, 0x4a2, (0x7 << 8), (4) << 8);\n\n\tmod_phy_reg(pi, 0x4d0, (0x1ff << 6), (0) << 6);\n\n\tmod_phy_reg(pi, 0x4a8, (0xff << 0), (0x1) << 0);\n\n\twlc_lcnphy_clear_tx_power_offsets(pi);\n\n\tmod_phy_reg(pi, 0x4a6, (0x1 << 15), (1) << 15);\n\n\tmod_phy_reg(pi, 0x4a6, (0x1ff << 0), (0xff) << 0);\n\n\tmod_phy_reg(pi, 0x49a, (0x1ff << 0), (0xff) << 0);\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\n\t\tmod_radio_reg(pi, RADIO_2064_REG028, 0xf, tssi_sel);\n\t\tmod_radio_reg(pi, RADIO_2064_REG086, 0x4, 0x4);\n\t} else {\n\t\tmod_radio_reg(pi, RADIO_2064_REG028, 0x1e, tssi_sel << 1);\n\t\tmod_radio_reg(pi, RADIO_2064_REG03A, 0x1, 1);\n\t\tmod_radio_reg(pi, RADIO_2064_REG11A, 0x8, 1 << 3);\n\t}\n\n\twrite_radio_reg(pi, RADIO_2064_REG025, 0xc);\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\n\t\tmod_radio_reg(pi, RADIO_2064_REG03A, 0x1, 1);\n\t} else {\n\t\tif (CHSPEC_IS2G(pi->radio_chanspec))\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG03A, 0x2, 1 << 1);\n\t\telse\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG03A, 0x2, 0 << 1);\n\t}\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 2))\n\t\tmod_radio_reg(pi, RADIO_2064_REG03A, 0x2, 1 << 1);\n\telse\n\t\tmod_radio_reg(pi, RADIO_2064_REG03A, 0x4, 1 << 2);\n\n\tmod_radio_reg(pi, RADIO_2064_REG11A, 0x1, 1 << 0);\n\n\tmod_radio_reg(pi, RADIO_2064_REG005, 0x8, 1 << 3);\n\n\tif (!wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\n\t\tmod_phy_reg(pi, 0x4d7,\n\t\t\t    (0x1 << 3) | (0x7 << 12), 0 << 3 | 2 << 12);\n\n\trfseq = wlc_lcnphy_rfseq_tbl_adc_pwrup(pi);\n\ttab.tbl_id = LCNPHY_TBL_ID_RFSEQ;\n\ttab.tbl_width = 16;\n\ttab.tbl_ptr = &rfseq;\n\ttab.tbl_len = 1;\n\ttab.tbl_offset = 6;\n\twlc_lcnphy_write_table(pi, &tab);\n\n\tmod_phy_reg(pi, 0x938, (0x1 << 2), (1) << 2);\n\n\tmod_phy_reg(pi, 0x939, (0x1 << 2), (1) << 2);\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 12), (1) << 12);\n\n\tmod_phy_reg(pi, 0x4d7, (0x1 << 2), (1) << 2);\n\n\tmod_phy_reg(pi, 0x4d7, (0xf << 8), (0) << 8);\n\n\tmod_radio_reg(pi, RADIO_2064_REG035, 0xff, 0x0);\n\tmod_radio_reg(pi, RADIO_2064_REG036, 0x3, 0x0);\n\tmod_radio_reg(pi, RADIO_2064_REG11A, 0x8, 0x8);\n\n\twlc_lcnphy_pwrctrl_rssiparams(pi);\n}\n\nvoid wlc_lcnphy_tx_pwr_update_npt(struct brcms_phy *pi)\n{\n\tu16 tx_cnt, tx_total, npt;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\ttx_total = wlc_lcnphy_total_tx_frames(pi);\n\ttx_cnt = tx_total - pi_lcn->lcnphy_tssi_tx_cnt;\n\tnpt = wlc_lcnphy_get_tx_pwr_npt(pi);\n\n\tif (tx_cnt > (1 << npt)) {\n\n\t\tpi_lcn->lcnphy_tssi_tx_cnt = tx_total;\n\n\t\tpi_lcn->lcnphy_tssi_idx = wlc_lcnphy_get_current_tx_pwr_idx(pi);\n\t\tpi_lcn->lcnphy_tssi_npt = npt;\n\n\t}\n}\n\ns32 wlc_lcnphy_tssi2dbm(s32 tssi, s32 a1, s32 b0, s32 b1)\n{\n\ts32 a, b, p;\n\n\ta = 32768 + (a1 * tssi);\n\tb = (1024 * b0) + (64 * b1 * tssi);\n\tp = ((2 * b) + a) / (2 * a);\n\n\treturn p;\n}\n\nstatic void wlc_lcnphy_txpower_reset_npt(struct brcms_phy *pi)\n{\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\tif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\n\t\treturn;\n\n\tpi_lcn->lcnphy_tssi_idx = LCNPHY_TX_PWR_CTRL_START_INDEX_2G_4313;\n\tpi_lcn->lcnphy_tssi_npt = LCNPHY_TX_PWR_CTRL_START_NPT;\n}\n\nvoid wlc_lcnphy_txpower_recalc_target(struct brcms_phy *pi)\n{\n\tstruct phytbl_info tab;\n\tu32 rate_table[BRCMS_NUM_RATES_CCK + BRCMS_NUM_RATES_OFDM +\n\t\t       BRCMS_NUM_RATES_MCS_1_STREAM];\n\tuint i, j;\n\tif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\n\t\treturn;\n\n\tfor (i = 0, j = 0; i < ARRAY_SIZE(rate_table); i++, j++) {\n\n\t\tif (i == BRCMS_NUM_RATES_CCK + BRCMS_NUM_RATES_OFDM)\n\t\t\tj = TXP_FIRST_MCS_20_SISO;\n\n\t\trate_table[i] = (u32) ((s32) (-pi->tx_power_offset[j]));\n\t}\n\n\ttab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\n\ttab.tbl_width = 32;\n\ttab.tbl_len = ARRAY_SIZE(rate_table);\n\ttab.tbl_ptr = rate_table;\n\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_RATE_OFFSET;\n\twlc_lcnphy_write_table(pi, &tab);\n\n\tif (wlc_lcnphy_get_target_tx_pwr(pi) != pi->tx_power_min) {\n\t\twlc_lcnphy_set_target_tx_pwr(pi, pi->tx_power_min);\n\n\t\twlc_lcnphy_txpower_reset_npt(pi);\n\t}\n}\n\nstatic void wlc_lcnphy_set_tx_pwr_soft_ctrl(struct brcms_phy *pi, s8 index)\n{\n\tu32 cck_offset[4] = { 22, 22, 22, 22 };\n\tu32 ofdm_offset, reg_offset_cck;\n\tint i;\n\tu16 index2;\n\tstruct phytbl_info tab;\n\n\tif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi))\n\t\treturn;\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 14), (0x1) << 14);\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 14), (0x0) << 14);\n\n\tor_phy_reg(pi, 0x6da, 0x0040);\n\n\treg_offset_cck = 0;\n\tfor (i = 0; i < 4; i++)\n\t\tcck_offset[i] -= reg_offset_cck;\n\ttab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\n\ttab.tbl_width = 32;\n\ttab.tbl_len = 4;\n\ttab.tbl_ptr = cck_offset;\n\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_RATE_OFFSET;\n\twlc_lcnphy_write_table(pi, &tab);\n\tofdm_offset = 0;\n\ttab.tbl_len = 1;\n\ttab.tbl_ptr = &ofdm_offset;\n\tfor (i = 836; i < 862; i++) {\n\t\ttab.tbl_offset = i;\n\t\twlc_lcnphy_write_table(pi, &tab);\n\t}\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 15), (0x1) << 15);\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 14), (0x1) << 14);\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 13), (0x1) << 13);\n\n\tmod_phy_reg(pi, 0x4b0, (0x1 << 7), (0) << 7);\n\n\tmod_phy_reg(pi, 0x43b, (0x1 << 6), (0) << 6);\n\n\tmod_phy_reg(pi, 0x4a9, (0x1 << 15), (1) << 15);\n\n\tindex2 = (u16) (index * 2);\n\tmod_phy_reg(pi, 0x4a9, (0x1ff << 0), (index2) << 0);\n\n\tmod_phy_reg(pi, 0x6a3, (0x1 << 4), (0) << 4);\n\n}\n\nstatic s8 wlc_lcnphy_tempcompensated_txpwrctrl(struct brcms_phy *pi)\n{\n\ts8 index, delta_brd, delta_temp, new_index, tempcorrx;\n\ts16 manp, meas_temp, temp_diff;\n\tbool neg = false;\n\tu16 temp;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi))\n\t\treturn pi_lcn->lcnphy_current_index;\n\n\tindex = FIXED_TXPWR;\n\n\tif (pi_lcn->lcnphy_tempsense_slope == 0)\n\t\treturn index;\n\n\ttemp = (u16) wlc_lcnphy_tempsense(pi, 0);\n\tmeas_temp = LCNPHY_TEMPSENSE(temp);\n\n\tif (pi->tx_power_min != 0)\n\t\tdelta_brd = (pi_lcn->lcnphy_measPower - pi->tx_power_min);\n\telse\n\t\tdelta_brd = 0;\n\n\tmanp = LCNPHY_TEMPSENSE(pi_lcn->lcnphy_rawtempsense);\n\ttemp_diff = manp - meas_temp;\n\tif (temp_diff < 0) {\n\t\tneg = true;\n\t\ttemp_diff = -temp_diff;\n\t}\n\n\tdelta_temp = (s8) wlc_lcnphy_qdiv_roundup((u32) (temp_diff * 192),\n\t\t\t\t\t\t  (u32) (pi_lcn->\n\t\t\t\t\t\t\t lcnphy_tempsense_slope\n\t\t\t\t\t\t\t * 10), 0);\n\tif (neg)\n\t\tdelta_temp = -delta_temp;\n\n\tif (pi_lcn->lcnphy_tempsense_option == 3\n\t    && LCNREV_IS(pi->pubpi.phy_rev, 0))\n\t\tdelta_temp = 0;\n\tif (pi_lcn->lcnphy_tempcorrx > 31)\n\t\ttempcorrx = (s8) (pi_lcn->lcnphy_tempcorrx - 64);\n\telse\n\t\ttempcorrx = (s8) pi_lcn->lcnphy_tempcorrx;\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 1))\n\t\ttempcorrx = 4;\n\tnew_index =\n\t\tindex + delta_brd + delta_temp - pi_lcn->lcnphy_bandedge_corr;\n\tnew_index += tempcorrx;\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 1))\n\t\tindex = 127;\n\n\tif (new_index < 0 || new_index > 126)\n\t\treturn index;\n\n\treturn new_index;\n}\n\nstatic u16 wlc_lcnphy_set_tx_pwr_ctrl_mode(struct brcms_phy *pi, u16 mode)\n{\n\n\tu16 current_mode = mode;\n\tif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi) &&\n\t    mode == LCNPHY_TX_PWR_CTRL_HW)\n\t\tcurrent_mode = LCNPHY_TX_PWR_CTRL_TEMPBASED;\n\tif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi) &&\n\t    mode == LCNPHY_TX_PWR_CTRL_TEMPBASED)\n\t\tcurrent_mode = LCNPHY_TX_PWR_CTRL_HW;\n\treturn current_mode;\n}\n\nvoid wlc_lcnphy_set_tx_pwr_ctrl(struct brcms_phy *pi, u16 mode)\n{\n\tu16 old_mode = wlc_lcnphy_get_tx_pwr_ctrl(pi);\n\ts8 index;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tmode = wlc_lcnphy_set_tx_pwr_ctrl_mode(pi, mode);\n\told_mode = wlc_lcnphy_set_tx_pwr_ctrl_mode(pi, old_mode);\n\n\tmod_phy_reg(pi, 0x6da, (0x1 << 6),\n\t\t    ((LCNPHY_TX_PWR_CTRL_HW == mode) ? 1 : 0) << 6);\n\n\tmod_phy_reg(pi, 0x6a3, (0x1 << 4),\n\t\t    ((LCNPHY_TX_PWR_CTRL_HW == mode) ? 0 : 1) << 4);\n\n\tif (old_mode != mode) {\n\t\tif (LCNPHY_TX_PWR_CTRL_HW == old_mode) {\n\n\t\t\twlc_lcnphy_tx_pwr_update_npt(pi);\n\n\t\t\twlc_lcnphy_clear_tx_power_offsets(pi);\n\t\t}\n\t\tif (LCNPHY_TX_PWR_CTRL_HW == mode) {\n\n\t\t\twlc_lcnphy_txpower_recalc_target(pi);\n\n\t\t\twlc_lcnphy_set_start_tx_pwr_idx(pi,\n\t\t\t\t\t\t\tpi_lcn->\n\t\t\t\t\t\t\tlcnphy_tssi_idx);\n\t\t\twlc_lcnphy_set_tx_pwr_npt(pi, pi_lcn->lcnphy_tssi_npt);\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG11F, 0x4, 0);\n\n\t\t\tpi_lcn->lcnphy_tssi_tx_cnt =\n\t\t\t\twlc_lcnphy_total_tx_frames(pi);\n\n\t\t\twlc_lcnphy_disable_tx_gain_override(pi);\n\t\t\tpi_lcn->lcnphy_tx_power_idx_override = -1;\n\t\t} else\n\t\t\twlc_lcnphy_enable_tx_gain_override(pi);\n\n\t\tmod_phy_reg(pi, 0x4a4,\n\t\t\t    ((0x1 << 15) | (0x1 << 14) | (0x1 << 13)), mode);\n\t\tif (mode == LCNPHY_TX_PWR_CTRL_TEMPBASED) {\n\t\t\tindex = wlc_lcnphy_tempcompensated_txpwrctrl(pi);\n\t\t\twlc_lcnphy_set_tx_pwr_soft_ctrl(pi, index);\n\t\t\tpi_lcn->lcnphy_current_index = (s8)\n\t\t\t\t\t\t       ((read_phy_reg(pi,\n\t\t\t\t\t\t\t\t      0x4a9) &\n\t\t\t\t\t\t\t 0xFF) / 2);\n\t\t}\n\t}\n}\n\nstatic void\nwlc_lcnphy_tx_iqlo_loopback(struct brcms_phy *pi, u16 *values_to_save)\n{\n\tu16 vmid;\n\tint i;\n\tfor (i = 0; i < 20; i++)\n\t\tvalues_to_save[i] =\n\t\t\tread_radio_reg(pi, iqlo_loopback_rf_regs[i]);\n\n\tmod_phy_reg(pi, 0x44c, (0x1 << 12), 1 << 12);\n\tmod_phy_reg(pi, 0x44d, (0x1 << 14), 1 << 14);\n\n\tmod_phy_reg(pi, 0x44c, (0x1 << 11), 1 << 11);\n\tmod_phy_reg(pi, 0x44d, (0x1 << 13), 0 << 13);\n\n\tmod_phy_reg(pi, 0x43b, (0x1 << 1), 1 << 1);\n\tmod_phy_reg(pi, 0x43c, (0x1 << 1), 0 << 1);\n\n\tmod_phy_reg(pi, 0x43b, (0x1 << 0), 1 << 0);\n\tmod_phy_reg(pi, 0x43c, (0x1 << 0), 0 << 0);\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 2))\n\t\tand_radio_reg(pi, RADIO_2064_REG03A, 0xFD);\n\telse\n\t\tand_radio_reg(pi, RADIO_2064_REG03A, 0xF9);\n\tor_radio_reg(pi, RADIO_2064_REG11A, 0x1);\n\n\tor_radio_reg(pi, RADIO_2064_REG036, 0x01);\n\tor_radio_reg(pi, RADIO_2064_REG11A, 0x18);\n\tudelay(20);\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\n\t\tif (CHSPEC_IS5G(pi->radio_chanspec))\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG03A, 1, 0);\n\t\telse\n\t\t\tor_radio_reg(pi, RADIO_2064_REG03A, 1);\n\t} else {\n\t\tif (CHSPEC_IS5G(pi->radio_chanspec))\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG03A, 3, 1);\n\t\telse\n\t\t\tor_radio_reg(pi, RADIO_2064_REG03A, 0x3);\n\t}\n\n\tudelay(20);\n\n\twrite_radio_reg(pi, RADIO_2064_REG025, 0xF);\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\n\t\tif (CHSPEC_IS5G(pi->radio_chanspec))\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG028, 0xF, 0x4);\n\t\telse\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG028, 0xF, 0x6);\n\t} else {\n\t\tif (CHSPEC_IS5G(pi->radio_chanspec))\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG028, 0x1e, 0x4 << 1);\n\t\telse\n\t\t\tmod_radio_reg(pi, RADIO_2064_REG028, 0x1e, 0x6 << 1);\n\t}\n\n\tudelay(20);\n\n\twrite_radio_reg(pi, RADIO_2064_REG005, 0x8);\n\tor_radio_reg(pi, RADIO_2064_REG112, 0x80);\n\tudelay(20);\n\n\tor_radio_reg(pi, RADIO_2064_REG0FF, 0x10);\n\tor_radio_reg(pi, RADIO_2064_REG11F, 0x44);\n\tudelay(20);\n\n\tor_radio_reg(pi, RADIO_2064_REG00B, 0x7);\n\tor_radio_reg(pi, RADIO_2064_REG113, 0x10);\n\tudelay(20);\n\n\twrite_radio_reg(pi, RADIO_2064_REG007, 0x1);\n\tudelay(20);\n\n\tvmid = 0x2A6;\n\tmod_radio_reg(pi, RADIO_2064_REG0FC, 0x3 << 0, (vmid >> 8) & 0x3);\n\twrite_radio_reg(pi, RADIO_2064_REG0FD, (vmid & 0xff));\n\tor_radio_reg(pi, RADIO_2064_REG11F, 0x44);\n\tudelay(20);\n\n\tor_radio_reg(pi, RADIO_2064_REG0FF, 0x10);\n\tudelay(20);\n\twrite_radio_reg(pi, RADIO_2064_REG012, 0x02);\n\tor_radio_reg(pi, RADIO_2064_REG112, 0x06);\n\twrite_radio_reg(pi, RADIO_2064_REG036, 0x11);\n\twrite_radio_reg(pi, RADIO_2064_REG059, 0xcc);\n\twrite_radio_reg(pi, RADIO_2064_REG05C, 0x2e);\n\twrite_radio_reg(pi, RADIO_2064_REG078, 0xd7);\n\twrite_radio_reg(pi, RADIO_2064_REG092, 0x15);\n}\n\nstatic bool wlc_lcnphy_iqcal_wait(struct brcms_phy *pi)\n{\n\tuint delay_count = 0;\n\n\twhile (wlc_lcnphy_iqcal_active(pi)) {\n\t\tudelay(100);\n\t\tdelay_count++;\n\n\t\tif (delay_count > (10 * 500))\n\t\t\tbreak;\n\t}\n\n\treturn (0 == wlc_lcnphy_iqcal_active(pi));\n}\n\nstatic void\nwlc_lcnphy_tx_iqlo_loopback_cleanup(struct brcms_phy *pi, u16 *values_to_save)\n{\n\tint i;\n\n\tand_phy_reg(pi, 0x44c, 0x0 >> 11);\n\n\tand_phy_reg(pi, 0x43b, 0xC);\n\n\tfor (i = 0; i < 20; i++)\n\t\twrite_radio_reg(pi, iqlo_loopback_rf_regs[i],\n\t\t\t\tvalues_to_save[i]);\n}\n\nstatic void\nwlc_lcnphy_tx_iqlo_cal(struct brcms_phy *pi,\n\t\t       struct lcnphy_txgains *target_gains,\n\t\t       enum lcnphy_cal_mode cal_mode, bool keep_tone)\n{\n\n\tstruct lcnphy_txgains cal_gains, temp_gains;\n\tu16 hash;\n\tu8 band_idx;\n\tint j;\n\tu16 ncorr_override[5];\n\tu16 syst_coeffs[] = { 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,\n\t\t\t      0x0000, 0x0000, 0x0000, 0x0000, 0x0000};\n\n\tu16 commands_fullcal[] = {\n\t\t0x8434, 0x8334, 0x8084, 0x8267, 0x8056, 0x8234\n\t};\n\n\tu16 commands_recal[] = {\n\t\t0x8434, 0x8334, 0x8084, 0x8267, 0x8056, 0x8234\n\t};\n\n\tu16 command_nums_fullcal[] = {\n\t\t0x7a97, 0x7a97, 0x7a97, 0x7a87, 0x7a87, 0x7b97\n\t};\n\n\tu16 command_nums_recal[] = {\n\t\t0x7a97, 0x7a97, 0x7a97, 0x7a87, 0x7a87, 0x7b97\n\t};\n\tu16 *command_nums = command_nums_fullcal;\n\n\tu16 *start_coeffs = NULL, *cal_cmds = NULL, cal_type, diq_start;\n\tu16 tx_pwr_ctrl_old, save_txpwrctrlrfctrl2;\n\tu16 save_sslpnCalibClkEnCtrl, save_sslpnRxFeClkEnCtrl;\n\tbool tx_gain_override_old;\n\tstruct lcnphy_txgains old_gains;\n\tuint i, n_cal_cmds = 0, n_cal_start = 0;\n\tu16 *values_to_save;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tvalues_to_save = kmalloc_array(20, sizeof(u16), GFP_ATOMIC);\n\tif (NULL == values_to_save)\n\t\treturn;\n\n\tsave_sslpnRxFeClkEnCtrl = read_phy_reg(pi, 0x6db);\n\tsave_sslpnCalibClkEnCtrl = read_phy_reg(pi, 0x6da);\n\n\tor_phy_reg(pi, 0x6da, 0x40);\n\tor_phy_reg(pi, 0x6db, 0x3);\n\n\tswitch (cal_mode) {\n\tcase LCNPHY_CAL_FULL:\n\t\tstart_coeffs = syst_coeffs;\n\t\tcal_cmds = commands_fullcal;\n\t\tn_cal_cmds = ARRAY_SIZE(commands_fullcal);\n\t\tbreak;\n\n\tcase LCNPHY_CAL_RECAL:\n\t\tstart_coeffs = syst_coeffs;\n\t\tcal_cmds = commands_recal;\n\t\tn_cal_cmds = ARRAY_SIZE(commands_recal);\n\t\tcommand_nums = command_nums_recal;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\twlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t      start_coeffs, 11, 16, 64);\n\n\twrite_phy_reg(pi, 0x6da, 0xffff);\n\tmod_phy_reg(pi, 0x503, (0x1 << 3), (1) << 3);\n\n\ttx_pwr_ctrl_old = wlc_lcnphy_get_tx_pwr_ctrl(pi);\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 12), (1) << 12);\n\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\n\n\tsave_txpwrctrlrfctrl2 = read_phy_reg(pi, 0x4db);\n\n\tmod_phy_reg(pi, 0x4db, (0x3ff << 0), (0x2a6) << 0);\n\n\tmod_phy_reg(pi, 0x4db, (0x7 << 12), (2) << 12);\n\n\twlc_lcnphy_tx_iqlo_loopback(pi, values_to_save);\n\n\ttx_gain_override_old = wlc_lcnphy_tx_gain_override_enabled(pi);\n\tif (tx_gain_override_old)\n\t\twlc_lcnphy_get_tx_gain(pi, &old_gains);\n\n\tif (!target_gains) {\n\t\tif (!tx_gain_override_old)\n\t\t\twlc_lcnphy_set_tx_pwr_by_index(pi,\n\t\t\t\t\t\t       pi_lcn->lcnphy_tssi_idx);\n\t\twlc_lcnphy_get_tx_gain(pi, &temp_gains);\n\t\ttarget_gains = &temp_gains;\n\t}\n\n\thash = (target_gains->gm_gain << 8) |\n\t       (target_gains->pga_gain << 4) | (target_gains->pad_gain);\n\n\tband_idx = (CHSPEC_IS5G(pi->radio_chanspec) ? 1 : 0);\n\n\tcal_gains = *target_gains;\n\tmemset(ncorr_override, 0, sizeof(ncorr_override));\n\tfor (j = 0; j < iqcal_gainparams_numgains_lcnphy[band_idx]; j++) {\n\t\tif (hash == tbl_iqcal_gainparams_lcnphy[band_idx][j][0]) {\n\t\t\tcal_gains.gm_gain =\n\t\t\t\ttbl_iqcal_gainparams_lcnphy[band_idx][j][1];\n\t\t\tcal_gains.pga_gain =\n\t\t\t\ttbl_iqcal_gainparams_lcnphy[band_idx][j][2];\n\t\t\tcal_gains.pad_gain =\n\t\t\t\ttbl_iqcal_gainparams_lcnphy[band_idx][j][3];\n\t\t\tmemcpy(ncorr_override,\n\t\t\t       &tbl_iqcal_gainparams_lcnphy[band_idx][j][3],\n\t\t\t       sizeof(ncorr_override));\n\t\t\tbreak;\n\t\t}\n\t}\n\n\twlc_lcnphy_set_tx_gain(pi, &cal_gains);\n\n\twrite_phy_reg(pi, 0x453, 0xaa9);\n\twrite_phy_reg(pi, 0x93d, 0xc0);\n\n\twlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t      lcnphy_iqcal_loft_gainladder,\n\t\t\t\t      ARRAY_SIZE(lcnphy_iqcal_loft_gainladder),\n\t\t\t\t      16, 0);\n\n\twlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t      lcnphy_iqcal_ir_gainladder,\n\t\t\t\t      ARRAY_SIZE(\n\t\t\t\t\t      lcnphy_iqcal_ir_gainladder), 16,\n\t\t\t\t      32);\n\n\tif (pi->phy_tx_tone_freq) {\n\n\t\twlc_lcnphy_stop_tx_tone(pi);\n\t\tudelay(5);\n\t\twlc_lcnphy_start_tx_tone(pi, 3750, 88, 1);\n\t} else {\n\t\twlc_lcnphy_start_tx_tone(pi, 3750, 88, 1);\n\t}\n\n\twrite_phy_reg(pi, 0x6da, 0xffff);\n\n\tfor (i = n_cal_start; i < n_cal_cmds; i++) {\n\t\tu16 zero_diq = 0;\n\t\tu16 best_coeffs[11];\n\t\tu16 command_num;\n\n\t\tcal_type = (cal_cmds[i] & 0x0f00) >> 8;\n\n\t\tcommand_num = command_nums[i];\n\t\tif (ncorr_override[cal_type])\n\t\t\tcommand_num =\n\t\t\t\tncorr_override[cal_type] << 8 | (command_num &\n\t\t\t\t\t\t\t\t 0xff);\n\n\t\twrite_phy_reg(pi, 0x452, command_num);\n\n\t\tif ((cal_type == 3) || (cal_type == 4)) {\n\t\t\twlc_lcnphy_common_read_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t\t\t     &diq_start, 1, 16, 69);\n\n\t\t\twlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t\t\t      &zero_diq, 1, 16, 69);\n\t\t}\n\n\t\twrite_phy_reg(pi, 0x451, cal_cmds[i]);\n\n\t\tif (!wlc_lcnphy_iqcal_wait(pi))\n\t\t\tgoto cleanup;\n\n\t\twlc_lcnphy_common_read_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t\t     best_coeffs,\n\t\t\t\t\t     ARRAY_SIZE(best_coeffs), 16, 96);\n\t\twlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t\t      best_coeffs,\n\t\t\t\t\t      ARRAY_SIZE(best_coeffs), 16, 64);\n\n\t\tif ((cal_type == 3) || (cal_type == 4))\n\t\t\twlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t\t\t      &diq_start, 1, 16, 69);\n\t\twlc_lcnphy_common_read_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t\t     pi_lcn->lcnphy_cal_results.\n\t\t\t\t\t     txiqlocal_bestcoeffs,\n\t\t\t\t\t     ARRAY_SIZE(pi_lcn->\n\t\t\t\t\t\t\tlcnphy_cal_results.\n\t\t\t\t\t\t\ttxiqlocal_bestcoeffs),\n\t\t\t\t\t     16, 96);\n\t}\n\n\twlc_lcnphy_common_read_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t     pi_lcn->lcnphy_cal_results.\n\t\t\t\t     txiqlocal_bestcoeffs,\n\t\t\t\t     ARRAY_SIZE(pi_lcn->lcnphy_cal_results.\n\t\t\t\t\t\ttxiqlocal_bestcoeffs), 16, 96);\n\tpi_lcn->lcnphy_cal_results.txiqlocal_bestcoeffs_valid = true;\n\n\twlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t      &pi_lcn->lcnphy_cal_results.\n\t\t\t\t      txiqlocal_bestcoeffs[0], 4, 16, 80);\n\n\twlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\n\t\t\t\t      &pi_lcn->lcnphy_cal_results.\n\t\t\t\t      txiqlocal_bestcoeffs[5], 2, 16, 85);\n\ncleanup:\n\twlc_lcnphy_tx_iqlo_loopback_cleanup(pi, values_to_save);\n\tkfree(values_to_save);\n\n\tif (!keep_tone)\n\t\twlc_lcnphy_stop_tx_tone(pi);\n\n\twrite_phy_reg(pi, 0x4db, save_txpwrctrlrfctrl2);\n\n\twrite_phy_reg(pi, 0x453, 0);\n\n\tif (tx_gain_override_old)\n\t\twlc_lcnphy_set_tx_gain(pi, &old_gains);\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, tx_pwr_ctrl_old);\n\n\twrite_phy_reg(pi, 0x6da, save_sslpnCalibClkEnCtrl);\n\twrite_phy_reg(pi, 0x6db, save_sslpnRxFeClkEnCtrl);\n\n}\n\nstatic void wlc_lcnphy_idle_tssi_est(struct brcms_phy_pub *ppi)\n{\n\tbool suspend, tx_gain_override_old;\n\tstruct lcnphy_txgains old_gains;\n\tstruct brcms_phy *pi = container_of(ppi, struct brcms_phy, pubpi_ro);\n\tu16 idleTssi0_2C, idleTssi0_OB, idleTssi0_regvalue_OB,\n\t    idleTssi0_regvalue_2C;\n\tu16 SAVE_txpwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\n\tu16 SAVE_lpfgain = read_radio_reg(pi, RADIO_2064_REG112);\n\tu16 SAVE_jtag_bb_afe_switch =\n\t\tread_radio_reg(pi, RADIO_2064_REG007) & 1;\n\tu16 SAVE_jtag_auxpga = read_radio_reg(pi, RADIO_2064_REG0FF) & 0x10;\n\tu16 SAVE_iqadc_aux_en = read_radio_reg(pi, RADIO_2064_REG11F) & 4;\n\tu8 SAVE_bbmult = wlc_lcnphy_get_bbmult(pi);\n\n\tread_phy_reg(pi, 0x4ab);  \n\tsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\n\t\t\t MCTL_EN_MAC));\n\tif (!suspend)\n\t\twlapi_suspend_mac_and_wait(pi->sh->physhim);\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\n\n\ttx_gain_override_old = wlc_lcnphy_tx_gain_override_enabled(pi);\n\twlc_lcnphy_get_tx_gain(pi, &old_gains);\n\n\twlc_lcnphy_enable_tx_gain_override(pi);\n\twlc_lcnphy_set_tx_pwr_by_index(pi, 127);\n\twrite_radio_reg(pi, RADIO_2064_REG112, 0x6);\n\tmod_radio_reg(pi, RADIO_2064_REG007, 0x1, 1);\n\tmod_radio_reg(pi, RADIO_2064_REG0FF, 0x10, 1 << 4);\n\tmod_radio_reg(pi, RADIO_2064_REG11F, 0x4, 1 << 2);\n\twlc_lcnphy_tssi_setup(pi);\n\n\tmod_phy_reg(pi, 0x4d7, (0x1 << 0), (1 << 0));\n\tmod_phy_reg(pi, 0x4d7, (0x1 << 6), (1 << 6));\n\n\twlc_lcnphy_set_bbmult(pi, 0x0);\n\n\twlc_phy_do_dummy_tx(pi, true, OFF);\n\tread_phy_reg(pi, 0x4ab);  \n\n\tidleTssi0_2C = ((read_phy_reg(pi, 0x63e) & (0x1ff << 0))\n\t\t\t>> 0);\n\n\tif (idleTssi0_2C >= 256)\n\t\tidleTssi0_OB = idleTssi0_2C - 256;\n\telse\n\t\tidleTssi0_OB = idleTssi0_2C + 256;\n\n\tidleTssi0_regvalue_OB = idleTssi0_OB;\n\tif (idleTssi0_regvalue_OB >= 256)\n\t\tidleTssi0_regvalue_2C = idleTssi0_regvalue_OB - 256;\n\telse\n\t\tidleTssi0_regvalue_2C = idleTssi0_regvalue_OB + 256;\n\tmod_phy_reg(pi, 0x4a6, (0x1ff << 0), (idleTssi0_regvalue_2C) << 0);\n\n\tmod_phy_reg(pi, 0x44c, (0x1 << 12), (0) << 12);\n\n\twlc_lcnphy_set_bbmult(pi, SAVE_bbmult);\n\twlc_lcnphy_set_tx_gain_override(pi, tx_gain_override_old);\n\twlc_lcnphy_set_tx_gain(pi, &old_gains);\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, SAVE_txpwrctrl);\n\n\twrite_radio_reg(pi, RADIO_2064_REG112, SAVE_lpfgain);\n\tmod_radio_reg(pi, RADIO_2064_REG007, 0x1, SAVE_jtag_bb_afe_switch);\n\tmod_radio_reg(pi, RADIO_2064_REG0FF, 0x10, SAVE_jtag_auxpga);\n\tmod_radio_reg(pi, RADIO_2064_REG11F, 0x4, SAVE_iqadc_aux_en);\n\tmod_radio_reg(pi, RADIO_2064_REG112, 0x80, 1 << 7);\n\tif (!suspend)\n\t\twlapi_enable_mac(pi->sh->physhim);\n}\n\nstatic void wlc_lcnphy_vbat_temp_sense_setup(struct brcms_phy *pi, u8 mode)\n{\n\tbool suspend;\n\tu16 save_txpwrCtrlEn;\n\tu8 auxpga_vmidcourse, auxpga_vmidfine, auxpga_gain;\n\tu16 auxpga_vmid;\n\tstruct phytbl_info tab;\n\tu32 val;\n\tu8 save_reg007, save_reg0FF, save_reg11F, save_reg005, save_reg025,\n\t   save_reg112;\n\tu16 values_to_save[14];\n\ts8 index;\n\tint i;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\tudelay(999);\n\n\tsave_reg007 = (u8) read_radio_reg(pi, RADIO_2064_REG007);\n\tsave_reg0FF = (u8) read_radio_reg(pi, RADIO_2064_REG0FF);\n\tsave_reg11F = (u8) read_radio_reg(pi, RADIO_2064_REG11F);\n\tsave_reg005 = (u8) read_radio_reg(pi, RADIO_2064_REG005);\n\tsave_reg025 = (u8) read_radio_reg(pi, RADIO_2064_REG025);\n\tsave_reg112 = (u8) read_radio_reg(pi, RADIO_2064_REG112);\n\n\tfor (i = 0; i < 14; i++)\n\t\tvalues_to_save[i] = read_phy_reg(pi, tempsense_phy_regs[i]);\n\tsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\n\t\t\t MCTL_EN_MAC));\n\tif (!suspend)\n\t\twlapi_suspend_mac_and_wait(pi->sh->physhim);\n\tsave_txpwrCtrlEn = read_radio_reg(pi, 0x4a4);\n\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\n\tindex = pi_lcn->lcnphy_current_index;\n\twlc_lcnphy_set_tx_pwr_by_index(pi, 127);\n\tmod_radio_reg(pi, RADIO_2064_REG007, 0x1, 0x1);\n\tmod_radio_reg(pi, RADIO_2064_REG0FF, 0x10, 0x1 << 4);\n\tmod_radio_reg(pi, RADIO_2064_REG11F, 0x4, 0x1 << 2);\n\tmod_phy_reg(pi, 0x503, (0x1 << 0), (0) << 0);\n\n\tmod_phy_reg(pi, 0x503, (0x1 << 2), (0) << 2);\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 14), (0) << 14);\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 15), (0) << 15);\n\n\tmod_phy_reg(pi, 0x4d0, (0x1 << 5), (0) << 5);\n\n\tmod_phy_reg(pi, 0x4a5, (0xff << 0), (255) << 0);\n\n\tmod_phy_reg(pi, 0x4a5, (0x7 << 12), (5) << 12);\n\n\tmod_phy_reg(pi, 0x4a5, (0x7 << 8), (0) << 8);\n\n\tmod_phy_reg(pi, 0x40d, (0xff << 0), (64) << 0);\n\n\tmod_phy_reg(pi, 0x40d, (0x7 << 8), (6) << 8);\n\n\tmod_phy_reg(pi, 0x4a2, (0xff << 0), (64) << 0);\n\n\tmod_phy_reg(pi, 0x4a2, (0x7 << 8), (6) << 8);\n\n\tmod_phy_reg(pi, 0x4d9, (0x7 << 4), (2) << 4);\n\n\tmod_phy_reg(pi, 0x4d9, (0x7 << 8), (3) << 8);\n\n\tmod_phy_reg(pi, 0x4d9, (0x7 << 12), (1) << 12);\n\n\tmod_phy_reg(pi, 0x4da, (0x1 << 12), (0) << 12);\n\n\tmod_phy_reg(pi, 0x4da, (0x1 << 13), (1) << 13);\n\n\tmod_phy_reg(pi, 0x4a6, (0x1 << 15), (1) << 15);\n\n\twrite_radio_reg(pi, RADIO_2064_REG025, 0xC);\n\n\tmod_radio_reg(pi, RADIO_2064_REG005, 0x8, 0x1 << 3);\n\n\tmod_phy_reg(pi, 0x938, (0x1 << 2), (1) << 2);\n\n\tmod_phy_reg(pi, 0x939, (0x1 << 2), (1) << 2);\n\n\tmod_phy_reg(pi, 0x4a4, (0x1 << 12), (1) << 12);\n\n\tval = wlc_lcnphy_rfseq_tbl_adc_pwrup(pi);\n\ttab.tbl_id = LCNPHY_TBL_ID_RFSEQ;\n\ttab.tbl_width = 16;\n\ttab.tbl_len = 1;\n\ttab.tbl_ptr = &val;\n\ttab.tbl_offset = 6;\n\twlc_lcnphy_write_table(pi, &tab);\n\tif (mode == TEMPSENSE) {\n\t\tmod_phy_reg(pi, 0x4d7, (0x1 << 3), (1) << 3);\n\n\t\tmod_phy_reg(pi, 0x4d7, (0x7 << 12), (1) << 12);\n\n\t\tauxpga_vmidcourse = 8;\n\t\tauxpga_vmidfine = 0x4;\n\t\tauxpga_gain = 2;\n\t\tmod_radio_reg(pi, RADIO_2064_REG082, 0x20, 1 << 5);\n\t} else {\n\t\tmod_phy_reg(pi, 0x4d7, (0x1 << 3), (1) << 3);\n\n\t\tmod_phy_reg(pi, 0x4d7, (0x7 << 12), (3) << 12);\n\n\t\tauxpga_vmidcourse = 7;\n\t\tauxpga_vmidfine = 0xa;\n\t\tauxpga_gain = 2;\n\t}\n\tauxpga_vmid =\n\t\t(u16) ((2 << 8) | (auxpga_vmidcourse << 4) | auxpga_vmidfine);\n\tmod_phy_reg(pi, 0x4d8, (0x1 << 0), (1) << 0);\n\n\tmod_phy_reg(pi, 0x4d8, (0x3ff << 2), (auxpga_vmid) << 2);\n\n\tmod_phy_reg(pi, 0x4d8, (0x1 << 1), (1) << 1);\n\n\tmod_phy_reg(pi, 0x4d8, (0x7 << 12), (auxpga_gain) << 12);\n\n\tmod_phy_reg(pi, 0x4d0, (0x1 << 5), (1) << 5);\n\n\twrite_radio_reg(pi, RADIO_2064_REG112, 0x6);\n\n\twlc_phy_do_dummy_tx(pi, true, OFF);\n\tif (!tempsense_done(pi))\n\t\tudelay(10);\n\n\twrite_radio_reg(pi, RADIO_2064_REG007, (u16) save_reg007);\n\twrite_radio_reg(pi, RADIO_2064_REG0FF, (u16) save_reg0FF);\n\twrite_radio_reg(pi, RADIO_2064_REG11F, (u16) save_reg11F);\n\twrite_radio_reg(pi, RADIO_2064_REG005, (u16) save_reg005);\n\twrite_radio_reg(pi, RADIO_2064_REG025, (u16) save_reg025);\n\twrite_radio_reg(pi, RADIO_2064_REG112, (u16) save_reg112);\n\tfor (i = 0; i < 14; i++)\n\t\twrite_phy_reg(pi, tempsense_phy_regs[i], values_to_save[i]);\n\twlc_lcnphy_set_tx_pwr_by_index(pi, (int)index);\n\n\twrite_radio_reg(pi, 0x4a4, save_txpwrCtrlEn);\n\tif (!suspend)\n\t\twlapi_enable_mac(pi->sh->physhim);\n\tudelay(999);\n}\n\nstatic void wlc_lcnphy_tx_pwr_ctrl_init(struct brcms_phy_pub *ppi)\n{\n\tstruct lcnphy_txgains tx_gains;\n\tu8 bbmult;\n\tstruct phytbl_info tab;\n\ts32 a1, b0, b1;\n\ts32 tssi, pwr, mintargetpwr;\n\tbool suspend;\n\tstruct brcms_phy *pi = container_of(ppi, struct brcms_phy, pubpi_ro);\n\n\tsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\n\t\t\t MCTL_EN_MAC));\n\tif (!suspend)\n\t\twlapi_suspend_mac_and_wait(pi->sh->physhim);\n\n\tif (!pi->hwpwrctrl_capable) {\n\t\tif (CHSPEC_IS2G(pi->radio_chanspec)) {\n\t\t\ttx_gains.gm_gain = 4;\n\t\t\ttx_gains.pga_gain = 12;\n\t\t\ttx_gains.pad_gain = 12;\n\t\t\ttx_gains.dac_gain = 0;\n\n\t\t\tbbmult = 150;\n\t\t} else {\n\t\t\ttx_gains.gm_gain = 7;\n\t\t\ttx_gains.pga_gain = 15;\n\t\t\ttx_gains.pad_gain = 14;\n\t\t\ttx_gains.dac_gain = 0;\n\n\t\t\tbbmult = 150;\n\t\t}\n\t\twlc_lcnphy_set_tx_gain(pi, &tx_gains);\n\t\twlc_lcnphy_set_bbmult(pi, bbmult);\n\t\twlc_lcnphy_vbat_temp_sense_setup(pi, TEMPSENSE);\n\t} else {\n\n\t\twlc_lcnphy_idle_tssi_est(ppi);\n\n\t\twlc_lcnphy_clear_tx_power_offsets(pi);\n\n\t\tb0 = pi->txpa_2g[0];\n\t\tb1 = pi->txpa_2g[1];\n\t\ta1 = pi->txpa_2g[2];\n\t\tmintargetpwr = wlc_lcnphy_tssi2dbm(125, a1, b0, b1);\n\n\t\ttab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\n\t\ttab.tbl_width = 32;\n\t\ttab.tbl_ptr = &pwr;\n\t\ttab.tbl_len = 1;\n\t\ttab.tbl_offset = 0;\n\t\tfor (tssi = 0; tssi < 128; tssi++) {\n\t\t\tpwr = wlc_lcnphy_tssi2dbm(tssi, a1, b0, b1);\n\n\t\t\tpwr = (pwr < mintargetpwr) ? mintargetpwr : pwr;\n\t\t\twlc_lcnphy_write_table(pi, &tab);\n\t\t\ttab.tbl_offset++;\n\t\t}\n\t\tmod_phy_reg(pi, 0x4d0, (0x1 << 0), (0) << 0);\n\t\tmod_phy_reg(pi, 0x4d3, (0xff << 0), (0) << 0);\n\t\tmod_phy_reg(pi, 0x4d3, (0xff << 8), (0) << 8);\n\t\tmod_phy_reg(pi, 0x4d0, (0x1 << 4), (0) << 4);\n\t\tmod_phy_reg(pi, 0x4d0, (0x1 << 2), (0) << 2);\n\n\t\tmod_phy_reg(pi, 0x410, (0x1 << 7), (0) << 7);\n\n\t\twrite_phy_reg(pi, 0x4a8, 10);\n\n\t\twlc_lcnphy_set_target_tx_pwr(pi, LCN_TARGET_PWR);\n\n\t\twlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_HW);\n\t}\n\tif (!suspend)\n\t\twlapi_enable_mac(pi->sh->physhim);\n}\n\nstatic void wlc_lcnphy_set_pa_gain(struct brcms_phy *pi, u16 gain)\n{\n\tmod_phy_reg(pi, 0x4fb,\n\t\t    LCNPHY_txgainctrlovrval1_pagain_ovr_val1_MASK,\n\t\t    gain << LCNPHY_txgainctrlovrval1_pagain_ovr_val1_SHIFT);\n\tmod_phy_reg(pi, 0x4fd,\n\t\t    LCNPHY_stxtxgainctrlovrval1_pagain_ovr_val1_MASK,\n\t\t    gain << LCNPHY_stxtxgainctrlovrval1_pagain_ovr_val1_SHIFT);\n}\n\nvoid\nwlc_lcnphy_get_radio_loft(struct brcms_phy *pi,\n\t\t\t  u8 *ei0, u8 *eq0, u8 *fi0, u8 *fq0)\n{\n\t*ei0 = LCNPHY_IQLOCC_READ(read_radio_reg(pi, RADIO_2064_REG089));\n\t*eq0 = LCNPHY_IQLOCC_READ(read_radio_reg(pi, RADIO_2064_REG08A));\n\t*fi0 = LCNPHY_IQLOCC_READ(read_radio_reg(pi, RADIO_2064_REG08B));\n\t*fq0 = LCNPHY_IQLOCC_READ(read_radio_reg(pi, RADIO_2064_REG08C));\n}\n\nvoid wlc_lcnphy_set_tx_iqcc(struct brcms_phy *pi, u16 a, u16 b)\n{\n\tstruct phytbl_info tab;\n\tu16 iqcc[2];\n\n\tiqcc[0] = a;\n\tiqcc[1] = b;\n\n\ttab.tbl_id = LCNPHY_TBL_ID_IQLOCAL;\n\ttab.tbl_width = 16;\n\ttab.tbl_ptr = iqcc;\n\ttab.tbl_len = 2;\n\ttab.tbl_offset = 80;\n\twlc_lcnphy_write_table(pi, &tab);\n}\n\nvoid wlc_lcnphy_set_tx_locc(struct brcms_phy *pi, u16 didq)\n{\n\tstruct phytbl_info tab;\n\n\ttab.tbl_id = LCNPHY_TBL_ID_IQLOCAL;\n\ttab.tbl_width = 16;\n\ttab.tbl_ptr = &didq;\n\ttab.tbl_len = 1;\n\ttab.tbl_offset = 85;\n\twlc_lcnphy_write_table(pi, &tab);\n}\n\nvoid wlc_lcnphy_set_tx_pwr_by_index(struct brcms_phy *pi, int index)\n{\n\tstruct phytbl_info tab;\n\tu16 a, b;\n\tu8 bb_mult;\n\tu32 bbmultiqcomp, txgain, locoeffs, rfpower;\n\tstruct lcnphy_txgains gains;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tpi_lcn->lcnphy_tx_power_idx_override = (s8) index;\n\tpi_lcn->lcnphy_current_index = (u8) index;\n\n\ttab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\n\ttab.tbl_width = 32;\n\ttab.tbl_len = 1;\n\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\n\n\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_IQ_OFFSET + index;\n\ttab.tbl_ptr = &bbmultiqcomp;\n\twlc_lcnphy_read_table(pi, &tab);\n\n\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_GAIN_OFFSET + index;\n\ttab.tbl_width = 32;\n\ttab.tbl_ptr = &txgain;\n\twlc_lcnphy_read_table(pi, &tab);\n\n\tgains.gm_gain = (u16) (txgain & 0xff);\n\tgains.pga_gain = (u16) (txgain >> 8) & 0xff;\n\tgains.pad_gain = (u16) (txgain >> 16) & 0xff;\n\tgains.dac_gain = (u16) (bbmultiqcomp >> 28) & 0x07;\n\twlc_lcnphy_set_tx_gain(pi, &gains);\n\twlc_lcnphy_set_pa_gain(pi, (u16) (txgain >> 24) & 0x7f);\n\n\tbb_mult = (u8) ((bbmultiqcomp >> 20) & 0xff);\n\twlc_lcnphy_set_bbmult(pi, bb_mult);\n\n\twlc_lcnphy_enable_tx_gain_override(pi);\n\n\tif (!wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi)) {\n\n\t\ta = (u16) ((bbmultiqcomp >> 10) & 0x3ff);\n\t\tb = (u16) (bbmultiqcomp & 0x3ff);\n\t\twlc_lcnphy_set_tx_iqcc(pi, a, b);\n\n\t\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_LO_OFFSET + index;\n\t\ttab.tbl_ptr = &locoeffs;\n\t\twlc_lcnphy_read_table(pi, &tab);\n\n\t\twlc_lcnphy_set_tx_locc(pi, (u16) locoeffs);\n\n\t\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_PWR_OFFSET + index;\n\t\ttab.tbl_ptr = &rfpower;\n\t\twlc_lcnphy_read_table(pi, &tab);\n\t\tmod_phy_reg(pi, 0x6a6, (0x1fff << 0), (rfpower * 8) << 0);\n\n\t}\n}\n\nstatic void wlc_lcnphy_clear_papd_comptable(struct brcms_phy *pi)\n{\n\tu32 j;\n\tstruct phytbl_info tab;\n\tu32 temp_offset[128];\n\ttab.tbl_ptr = temp_offset;\n\ttab.tbl_len = 128;\n\ttab.tbl_id = LCNPHY_TBL_ID_PAPDCOMPDELTATBL;\n\ttab.tbl_width = 32;\n\ttab.tbl_offset = 0;\n\n\tmemset(temp_offset, 0, sizeof(temp_offset));\n\tfor (j = 1; j < 128; j += 2)\n\t\ttemp_offset[j] = 0x80000;\n\n\twlc_lcnphy_write_table(pi, &tab);\n\treturn;\n}\n\nvoid wlc_lcnphy_tx_pu(struct brcms_phy *pi, bool bEnable)\n{\n\tif (!bEnable) {\n\n\t\tand_phy_reg(pi, 0x43b, ~(u16) ((0x1 << 1) | (0x1 << 4)));\n\n\t\tmod_phy_reg(pi, 0x43c, (0x1 << 1), 1 << 1);\n\n\t\tand_phy_reg(pi, 0x44c,\n\t\t\t    ~(u16) ((0x1 << 3) |\n\t\t\t\t    (0x1 << 5) |\n\t\t\t\t    (0x1 << 12) |\n\t\t\t\t    (0x1 << 0) | (0x1 << 1) | (0x1 << 2)));\n\n\t\tand_phy_reg(pi, 0x44d,\n\t\t\t    ~(u16) ((0x1 << 3) | (0x1 << 5) | (0x1 << 14)));\n\t\tmod_phy_reg(pi, 0x44d, (0x1 << 2), 1 << 2);\n\n\t\tmod_phy_reg(pi, 0x44d, (0x1 << 1) | (0x1 << 0), (0x1 << 0));\n\n\t\tand_phy_reg(pi, 0x4f9,\n\t\t\t    ~(u16) ((0x1 << 0) | (0x1 << 1) | (0x1 << 2)));\n\n\t\tand_phy_reg(pi, 0x4fa,\n\t\t\t    ~(u16) ((0x1 << 0) | (0x1 << 1) | (0x1 << 2)));\n\t} else {\n\n\t\tmod_phy_reg(pi, 0x43b, (0x1 << 1), 1 << 1);\n\t\tmod_phy_reg(pi, 0x43c, (0x1 << 1), 0 << 1);\n\n\t\tmod_phy_reg(pi, 0x43b, (0x1 << 4), 1 << 4);\n\t\tmod_phy_reg(pi, 0x43c, (0x1 << 6), 0 << 6);\n\n\t\tmod_phy_reg(pi, 0x44c, (0x1 << 12), 1 << 12);\n\t\tmod_phy_reg(pi, 0x44d, (0x1 << 14), 1 << 14);\n\n\t\twlc_lcnphy_set_trsw_override(pi, true, false);\n\n\t\tmod_phy_reg(pi, 0x44d, (0x1 << 2), 0 << 2);\n\t\tmod_phy_reg(pi, 0x44c, (0x1 << 2), 1 << 2);\n\n\t\tif (CHSPEC_IS2G(pi->radio_chanspec)) {\n\n\t\t\tmod_phy_reg(pi, 0x44c, (0x1 << 3), 1 << 3);\n\t\t\tmod_phy_reg(pi, 0x44d, (0x1 << 3), 1 << 3);\n\n\t\t\tmod_phy_reg(pi, 0x44c, (0x1 << 5), 1 << 5);\n\t\t\tmod_phy_reg(pi, 0x44d, (0x1 << 5), 0 << 5);\n\n\t\t\tmod_phy_reg(pi, 0x4f9, (0x1 << 1), 1 << 1);\n\t\t\tmod_phy_reg(pi, 0x4fa, (0x1 << 1), 1 << 1);\n\n\t\t\tmod_phy_reg(pi, 0x4f9, (0x1 << 2), 1 << 2);\n\t\t\tmod_phy_reg(pi, 0x4fa, (0x1 << 2), 1 << 2);\n\n\t\t\tmod_phy_reg(pi, 0x4f9, (0x1 << 0), 1 << 0);\n\t\t\tmod_phy_reg(pi, 0x4fa, (0x1 << 0), 1 << 0);\n\t\t} else {\n\n\t\t\tmod_phy_reg(pi, 0x44c, (0x1 << 3), 1 << 3);\n\t\t\tmod_phy_reg(pi, 0x44d, (0x1 << 3), 0 << 3);\n\n\t\t\tmod_phy_reg(pi, 0x44c, (0x1 << 5), 1 << 5);\n\t\t\tmod_phy_reg(pi, 0x44d, (0x1 << 5), 1 << 5);\n\n\t\t\tmod_phy_reg(pi, 0x4f9, (0x1 << 1), 1 << 1);\n\t\t\tmod_phy_reg(pi, 0x4fa, (0x1 << 1), 0 << 1);\n\n\t\t\tmod_phy_reg(pi, 0x4f9, (0x1 << 2), 1 << 2);\n\t\t\tmod_phy_reg(pi, 0x4fa, (0x1 << 2), 0 << 2);\n\n\t\t\tmod_phy_reg(pi, 0x4f9, (0x1 << 0), 1 << 0);\n\t\t\tmod_phy_reg(pi, 0x4fa, (0x1 << 0), 0 << 0);\n\t\t}\n\t}\n}\n\nstatic void\nwlc_lcnphy_run_samples(struct brcms_phy *pi,\n\t\t       u16 num_samps,\n\t\t       u16 num_loops, u16 wait, bool iqcalmode)\n{\n\n\tor_phy_reg(pi, 0x6da, 0x8080);\n\n\tmod_phy_reg(pi, 0x642, (0x7f << 0), (num_samps - 1) << 0);\n\tif (num_loops != 0xffff)\n\t\tnum_loops--;\n\tmod_phy_reg(pi, 0x640, (0xffff << 0), num_loops << 0);\n\n\tmod_phy_reg(pi, 0x641, (0xffff << 0), wait << 0);\n\n\tif (iqcalmode) {\n\n\t\tand_phy_reg(pi, 0x453, (u16) ~(0x1 << 15));\n\t\tor_phy_reg(pi, 0x453, (0x1 << 15));\n\t} else {\n\t\twrite_phy_reg(pi, 0x63f, 1);\n\t\twlc_lcnphy_tx_pu(pi, 1);\n\t}\n\n\tor_radio_reg(pi, RADIO_2064_REG112, 0x6);\n}\n\nvoid wlc_lcnphy_deaf_mode(struct brcms_phy *pi, bool mode)\n{\n\n\tu8 phybw40;\n\tphybw40 = CHSPEC_IS40(pi->radio_chanspec);\n\n\tmod_phy_reg(pi, 0x4b0, (0x1 << 5), (mode) << 5);\n\tmod_phy_reg(pi, 0x4b1, (0x1 << 9), 0 << 9);\n\n\tif (phybw40 == 0) {\n\t\tmod_phy_reg((pi), 0x410,\n\t\t\t    (0x1 << 6) |\n\t\t\t    (0x1 << 5),\n\t\t\t    ((CHSPEC_IS2G(\n\t\t\t\t      pi->radio_chanspec)) ? (!mode) : 0) <<\n\t\t\t    6 | (!mode) << 5);\n\t\tmod_phy_reg(pi, 0x410, (0x1 << 7), (mode) << 7);\n\t}\n}\n\nvoid\nwlc_lcnphy_start_tx_tone(struct brcms_phy *pi, s32 f_kHz, u16 max_val,\n\t\t\t bool iqcalmode)\n{\n\tu8 phy_bw;\n\tu16 num_samps, t, k;\n\tu32 bw;\n\ts32 theta = 0, rot = 0;\n\tstruct cordic_iq tone_samp;\n\tu32 data_buf[64];\n\tu16 i_samp, q_samp;\n\tstruct phytbl_info tab;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tpi->phy_tx_tone_freq = f_kHz;\n\n\twlc_lcnphy_deaf_mode(pi, true);\n\n\tphy_bw = 40;\n\tif (pi_lcn->lcnphy_spurmod) {\n\t\twrite_phy_reg(pi, 0x942, 0x2);\n\t\twrite_phy_reg(pi, 0x93b, 0x0);\n\t\twrite_phy_reg(pi, 0x93c, 0x0);\n\t\twlc_lcnphy_txrx_spur_avoidance_mode(pi, false);\n\t}\n\n\tif (f_kHz) {\n\t\tk = 1;\n\t\tdo {\n\t\t\tbw = phy_bw * 1000 * k;\n\t\t\tnum_samps = bw / abs(f_kHz);\n\t\t\tk++;\n\t\t} while ((num_samps * (u32) (abs(f_kHz))) != bw);\n\t} else\n\t\tnum_samps = 2;\n\n\trot = ((f_kHz * 36) / phy_bw) / 100;\n\ttheta = 0;\n\n\tfor (t = 0; t < num_samps; t++) {\n\n\t\ttone_samp = cordic_calc_iq(theta);\n\n\t\ttheta += rot;\n\n\t\ti_samp = (u16)(CORDIC_FLOAT(tone_samp.i * max_val) & 0x3ff);\n\t\tq_samp = (u16)(CORDIC_FLOAT(tone_samp.q * max_val) & 0x3ff);\n\t\tdata_buf[t] = (i_samp << 10) | q_samp;\n\t}\n\n\tmod_phy_reg(pi, 0x6d6, (0x3 << 0), 0 << 0);\n\n\tmod_phy_reg(pi, 0x6da, (0x1 << 3), 1 << 3);\n\n\ttab.tbl_ptr = data_buf;\n\ttab.tbl_len = num_samps;\n\ttab.tbl_id = LCNPHY_TBL_ID_SAMPLEPLAY;\n\ttab.tbl_offset = 0;\n\ttab.tbl_width = 32;\n\twlc_lcnphy_write_table(pi, &tab);\n\n\twlc_lcnphy_run_samples(pi, num_samps, 0xffff, 0, iqcalmode);\n}\n\nvoid wlc_lcnphy_stop_tx_tone(struct brcms_phy *pi)\n{\n\ts16 playback_status;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tpi->phy_tx_tone_freq = 0;\n\tif (pi_lcn->lcnphy_spurmod) {\n\t\twrite_phy_reg(pi, 0x942, 0x7);\n\t\twrite_phy_reg(pi, 0x93b, 0x2017);\n\t\twrite_phy_reg(pi, 0x93c, 0x27c5);\n\t\twlc_lcnphy_txrx_spur_avoidance_mode(pi, true);\n\t}\n\n\tplayback_status = read_phy_reg(pi, 0x644);\n\tif (playback_status & (0x1 << 0)) {\n\t\twlc_lcnphy_tx_pu(pi, 0);\n\t\tmod_phy_reg(pi, 0x63f, (0x1 << 1), 1 << 1);\n\t} else if (playback_status & (0x1 << 1))\n\t\tmod_phy_reg(pi, 0x453, (0x1 << 15), 0 << 15);\n\n\tmod_phy_reg(pi, 0x6d6, (0x3 << 0), 1 << 0);\n\n\tmod_phy_reg(pi, 0x6da, (0x1 << 3), 0 << 3);\n\n\tmod_phy_reg(pi, 0x6da, (0x1 << 7), 0 << 7);\n\n\tand_radio_reg(pi, RADIO_2064_REG112, 0xFFF9);\n\n\twlc_lcnphy_deaf_mode(pi, false);\n}\n\nstatic void\nwlc_lcnphy_set_cc(struct brcms_phy *pi, int cal_type, s16 coeff_x, s16 coeff_y)\n{\n\tu16 di0dq0;\n\tu16 x, y, data_rf;\n\tint k;\n\tswitch (cal_type) {\n\tcase 0:\n\t\twlc_lcnphy_set_tx_iqcc(pi, coeff_x, coeff_y);\n\t\tbreak;\n\tcase 2:\n\t\tdi0dq0 = (coeff_x & 0xff) << 8 | (coeff_y & 0xff);\n\t\twlc_lcnphy_set_tx_locc(pi, di0dq0);\n\t\tbreak;\n\tcase 3:\n\t\tk = wlc_lcnphy_calc_floor(coeff_x, 0);\n\t\ty = 8 + k;\n\t\tk = wlc_lcnphy_calc_floor(coeff_x, 1);\n\t\tx = 8 - k;\n\t\tdata_rf = (x * 16 + y);\n\t\twrite_radio_reg(pi, RADIO_2064_REG089, data_rf);\n\t\tk = wlc_lcnphy_calc_floor(coeff_y, 0);\n\t\ty = 8 + k;\n\t\tk = wlc_lcnphy_calc_floor(coeff_y, 1);\n\t\tx = 8 - k;\n\t\tdata_rf = (x * 16 + y);\n\t\twrite_radio_reg(pi, RADIO_2064_REG08A, data_rf);\n\t\tbreak;\n\tcase 4:\n\t\tk = wlc_lcnphy_calc_floor(coeff_x, 0);\n\t\ty = 8 + k;\n\t\tk = wlc_lcnphy_calc_floor(coeff_x, 1);\n\t\tx = 8 - k;\n\t\tdata_rf = (x * 16 + y);\n\t\twrite_radio_reg(pi, RADIO_2064_REG08B, data_rf);\n\t\tk = wlc_lcnphy_calc_floor(coeff_y, 0);\n\t\ty = 8 + k;\n\t\tk = wlc_lcnphy_calc_floor(coeff_y, 1);\n\t\tx = 8 - k;\n\t\tdata_rf = (x * 16 + y);\n\t\twrite_radio_reg(pi, RADIO_2064_REG08C, data_rf);\n\t\tbreak;\n\t}\n}\n\nstatic struct lcnphy_unsign16_struct\nwlc_lcnphy_get_cc(struct brcms_phy *pi, int cal_type)\n{\n\tu16 a, b, didq;\n\tu8 di0, dq0, ei, eq, fi, fq;\n\tstruct lcnphy_unsign16_struct cc;\n\tcc.re = 0;\n\tcc.im = 0;\n\tswitch (cal_type) {\n\tcase 0:\n\t\twlc_lcnphy_get_tx_iqcc(pi, &a, &b);\n\t\tcc.re = a;\n\t\tcc.im = b;\n\t\tbreak;\n\tcase 2:\n\t\tdidq = wlc_lcnphy_get_tx_locc(pi);\n\t\tdi0 = (((didq & 0xff00) << 16) >> 24);\n\t\tdq0 = (((didq & 0x00ff) << 24) >> 24);\n\t\tcc.re = (u16) di0;\n\t\tcc.im = (u16) dq0;\n\t\tbreak;\n\tcase 3:\n\t\twlc_lcnphy_get_radio_loft(pi, &ei, &eq, &fi, &fq);\n\t\tcc.re = (u16) ei;\n\t\tcc.im = (u16) eq;\n\t\tbreak;\n\tcase 4:\n\t\twlc_lcnphy_get_radio_loft(pi, &ei, &eq, &fi, &fq);\n\t\tcc.re = (u16) fi;\n\t\tcc.im = (u16) fq;\n\t\tbreak;\n\t}\n\treturn cc;\n}\n\nstatic void\nwlc_lcnphy_samp_cap(struct brcms_phy *pi, int clip_detect_algo, u16 thresh,\n\t\t    s16 *ptr, int mode)\n{\n\tu32 curval1, curval2, stpptr, curptr, strptr, val;\n\tu16 sslpnCalibClkEnCtrl, timer;\n\tu16 old_sslpnCalibClkEnCtrl;\n\ts16 imag, real;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\ttimer = 0;\n\told_sslpnCalibClkEnCtrl = read_phy_reg(pi, 0x6da);\n\n\tcurval1 = bcma_read16(pi->d11core, D11REGOFFS(psm_corectlsts));\n\tptr[130] = 0;\n\tbcma_write16(pi->d11core, D11REGOFFS(psm_corectlsts),\n\t\t     ((1 << 6) | curval1));\n\n\tbcma_write16(pi->d11core, D11REGOFFS(smpl_clct_strptr), 0x7E00);\n\tbcma_write16(pi->d11core, D11REGOFFS(smpl_clct_stpptr), 0x8000);\n\tudelay(20);\n\tcurval2 = bcma_read16(pi->d11core, D11REGOFFS(psm_phy_hdr_param));\n\tbcma_write16(pi->d11core, D11REGOFFS(psm_phy_hdr_param),\n\t\t     curval2 | 0x30);\n\n\twrite_phy_reg(pi, 0x555, 0x0);\n\twrite_phy_reg(pi, 0x5a6, 0x5);\n\n\twrite_phy_reg(pi, 0x5a2, (u16) (mode | mode << 6));\n\twrite_phy_reg(pi, 0x5cf, 3);\n\twrite_phy_reg(pi, 0x5a5, 0x3);\n\twrite_phy_reg(pi, 0x583, 0x0);\n\twrite_phy_reg(pi, 0x584, 0x0);\n\twrite_phy_reg(pi, 0x585, 0x0fff);\n\twrite_phy_reg(pi, 0x586, 0x0000);\n\n\twrite_phy_reg(pi, 0x580, 0x4501);\n\n\tsslpnCalibClkEnCtrl = read_phy_reg(pi, 0x6da);\n\twrite_phy_reg(pi, 0x6da, (u32) (sslpnCalibClkEnCtrl | 0x2008));\n\tstpptr = bcma_read16(pi->d11core, D11REGOFFS(smpl_clct_stpptr));\n\tcurptr = bcma_read16(pi->d11core, D11REGOFFS(smpl_clct_curptr));\n\tdo {\n\t\tudelay(10);\n\t\tcurptr = bcma_read16(pi->d11core, D11REGOFFS(smpl_clct_curptr));\n\t\ttimer++;\n\t} while ((curptr != stpptr) && (timer < 500));\n\n\tbcma_write16(pi->d11core, D11REGOFFS(psm_phy_hdr_param), 0x2);\n\tstrptr = 0x7E00;\n\tbcma_write32(pi->d11core, D11REGOFFS(tplatewrptr), strptr);\n\twhile (strptr < 0x8000) {\n\t\tval = bcma_read32(pi->d11core, D11REGOFFS(tplatewrdata));\n\t\timag = ((val >> 16) & 0x3ff);\n\t\treal = ((val) & 0x3ff);\n\t\tif (imag > 511)\n\t\t\timag -= 1024;\n\n\t\tif (real > 511)\n\t\t\treal -= 1024;\n\n\t\tif (pi_lcn->lcnphy_iqcal_swp_dis)\n\t\t\tptr[(strptr - 0x7E00) / 4] = real;\n\t\telse\n\t\t\tptr[(strptr - 0x7E00) / 4] = imag;\n\n\t\tif (clip_detect_algo) {\n\t\t\tif (imag > thresh || imag < -thresh) {\n\t\t\t\tstrptr = 0x8000;\n\t\t\t\tptr[130] = 1;\n\t\t\t}\n\t\t}\n\n\t\tstrptr += 4;\n\t}\n\n\twrite_phy_reg(pi, 0x6da, old_sslpnCalibClkEnCtrl);\n\tbcma_write16(pi->d11core, D11REGOFFS(psm_phy_hdr_param), curval2);\n\tbcma_write16(pi->d11core, D11REGOFFS(psm_corectlsts), curval1);\n}\n\nstatic void\nwlc_lcnphy_a1(struct brcms_phy *pi, int cal_type, int num_levels,\n\t      int step_size_lg2)\n{\n\tconst struct lcnphy_spb_tone *phy_c1;\n\tstruct lcnphy_spb_tone phy_c2;\n\tstruct lcnphy_unsign16_struct phy_c3;\n\tint phy_c4, phy_c5, k, l, j, phy_c6;\n\tu16 phy_c7, phy_c8, phy_c9;\n\ts16 phy_c10, phy_c11, phy_c12, phy_c13, phy_c14, phy_c15, phy_c16;\n\ts16 *ptr, phy_c17;\n\ts32 phy_c18, phy_c19;\n\tu32 phy_c20, phy_c21;\n\tbool phy_c22, phy_c23, phy_c24, phy_c25;\n\tu16 phy_c26, phy_c27;\n\tu16 phy_c28, phy_c29, phy_c30;\n\tu16 phy_c31;\n\tu16 *phy_c32;\n\tphy_c21 = 0;\n\tphy_c10 = phy_c13 = phy_c14 = phy_c8 = 0;\n\tptr = kmalloc_array(131, sizeof(s16), GFP_ATOMIC);\n\tif (NULL == ptr)\n\t\treturn;\n\n\tphy_c32 = kmalloc_array(20, sizeof(u16), GFP_ATOMIC);\n\tif (NULL == phy_c32) {\n\t\tkfree(ptr);\n\t\treturn;\n\t}\n\tphy_c26 = read_phy_reg(pi, 0x6da);\n\tphy_c27 = read_phy_reg(pi, 0x6db);\n\tphy_c31 = read_radio_reg(pi, RADIO_2064_REG026);\n\twrite_phy_reg(pi, 0x93d, 0xC0);\n\n\twlc_lcnphy_start_tx_tone(pi, 3750, 88, 0);\n\twrite_phy_reg(pi, 0x6da, 0xffff);\n\tor_phy_reg(pi, 0x6db, 0x3);\n\n\twlc_lcnphy_tx_iqlo_loopback(pi, phy_c32);\n\tudelay(500);\n\tphy_c28 = read_phy_reg(pi, 0x938);\n\tphy_c29 = read_phy_reg(pi, 0x4d7);\n\tphy_c30 = read_phy_reg(pi, 0x4d8);\n\tor_phy_reg(pi, 0x938, 0x1 << 2);\n\tor_phy_reg(pi, 0x4d7, 0x1 << 2);\n\tor_phy_reg(pi, 0x4d7, 0x1 << 3);\n\tmod_phy_reg(pi, 0x4d7, (0x7 << 12), 0x2 << 12);\n\tor_phy_reg(pi, 0x4d8, 1 << 0);\n\tor_phy_reg(pi, 0x4d8, 1 << 1);\n\tmod_phy_reg(pi, 0x4d8, (0x3ff << 2), 0x23A << 2);\n\tmod_phy_reg(pi, 0x4d8, (0x7 << 12), 0x7 << 12);\n\tphy_c1 = &lcnphy_spb_tone_3750[0];\n\tphy_c4 = 32;\n\n\tif (num_levels == 0) {\n\t\tif (cal_type != 0)\n\t\t\tnum_levels = 4;\n\t\telse\n\t\t\tnum_levels = 9;\n\t}\n\tif (step_size_lg2 == 0) {\n\t\tif (cal_type != 0)\n\t\t\tstep_size_lg2 = 3;\n\t\telse\n\t\t\tstep_size_lg2 = 8;\n\t}\n\n\tphy_c7 = (1 << step_size_lg2);\n\tphy_c3 = wlc_lcnphy_get_cc(pi, cal_type);\n\tphy_c15 = (s16) phy_c3.re;\n\tphy_c16 = (s16) phy_c3.im;\n\tif (cal_type == 2) {\n\t\tif (phy_c3.re > 127)\n\t\t\tphy_c15 = phy_c3.re - 256;\n\t\tif (phy_c3.im > 127)\n\t\t\tphy_c16 = phy_c3.im - 256;\n\t}\n\twlc_lcnphy_set_cc(pi, cal_type, phy_c15, phy_c16);\n\tudelay(20);\n\tfor (phy_c8 = 0; phy_c7 != 0 && phy_c8 < num_levels; phy_c8++) {\n\t\tphy_c23 = true;\n\t\tphy_c22 = false;\n\t\tswitch (cal_type) {\n\t\tcase 0:\n\t\t\tphy_c10 = 511;\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\tphy_c10 = 127;\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tphy_c10 = 15;\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\tphy_c10 = 15;\n\t\t\tbreak;\n\t\t}\n\n\t\tphy_c9 = read_phy_reg(pi, 0x93d);\n\t\tphy_c9 = 2 * phy_c9;\n\t\tphy_c24 = false;\n\t\tphy_c5 = 7;\n\t\tphy_c25 = true;\n\t\twhile (1) {\n\t\t\twrite_radio_reg(pi, RADIO_2064_REG026,\n\t\t\t\t\t(phy_c5 & 0x7) | ((phy_c5 & 0x7) << 4));\n\t\t\tudelay(50);\n\t\t\tphy_c22 = false;\n\t\t\tptr[130] = 0;\n\t\t\twlc_lcnphy_samp_cap(pi, 1, phy_c9, &ptr[0], 2);\n\t\t\tif (ptr[130] == 1)\n\t\t\t\tphy_c22 = true;\n\t\t\tif (phy_c22)\n\t\t\t\tphy_c5 -= 1;\n\t\t\tif ((phy_c22 != phy_c24) && (!phy_c25))\n\t\t\t\tbreak;\n\t\t\tif (!phy_c22)\n\t\t\t\tphy_c5 += 1;\n\t\t\tif (phy_c5 <= 0 || phy_c5 >= 7)\n\t\t\t\tbreak;\n\t\t\tphy_c24 = phy_c22;\n\t\t\tphy_c25 = false;\n\t\t}\n\n\t\tif (phy_c5 < 0)\n\t\t\tphy_c5 = 0;\n\t\telse if (phy_c5 > 7)\n\t\t\tphy_c5 = 7;\n\n\t\tfor (k = -phy_c7; k <= phy_c7; k += phy_c7) {\n\t\t\tfor (l = -phy_c7; l <= phy_c7; l += phy_c7) {\n\t\t\t\tphy_c11 = phy_c15 + k;\n\t\t\t\tphy_c12 = phy_c16 + l;\n\n\t\t\t\tif (phy_c11 < -phy_c10)\n\t\t\t\t\tphy_c11 = -phy_c10;\n\t\t\t\telse if (phy_c11 > phy_c10)\n\t\t\t\t\tphy_c11 = phy_c10;\n\t\t\t\tif (phy_c12 < -phy_c10)\n\t\t\t\t\tphy_c12 = -phy_c10;\n\t\t\t\telse if (phy_c12 > phy_c10)\n\t\t\t\t\tphy_c12 = phy_c10;\n\t\t\t\twlc_lcnphy_set_cc(pi, cal_type, phy_c11,\n\t\t\t\t\t\t  phy_c12);\n\t\t\t\tudelay(20);\n\t\t\t\twlc_lcnphy_samp_cap(pi, 0, 0, ptr, 2);\n\n\t\t\t\tphy_c18 = 0;\n\t\t\t\tphy_c19 = 0;\n\t\t\t\tfor (j = 0; j < 128; j++) {\n\t\t\t\t\tif (cal_type != 0)\n\t\t\t\t\t\tphy_c6 = j % phy_c4;\n\t\t\t\t\telse\n\t\t\t\t\t\tphy_c6 = (2 * j) % phy_c4;\n\n\t\t\t\t\tphy_c2.re = phy_c1[phy_c6].re;\n\t\t\t\t\tphy_c2.im = phy_c1[phy_c6].im;\n\t\t\t\t\tphy_c17 = ptr[j];\n\t\t\t\t\tphy_c18 = phy_c18 + phy_c17 * phy_c2.re;\n\t\t\t\t\tphy_c19 = phy_c19 + phy_c17 * phy_c2.im;\n\t\t\t\t}\n\n\t\t\t\tphy_c18 = phy_c18 >> 10;\n\t\t\t\tphy_c19 = phy_c19 >> 10;\n\t\t\t\tphy_c20 = ((phy_c18 * phy_c18) +\n\t\t\t\t\t   (phy_c19 * phy_c19));\n\n\t\t\t\tif (phy_c23 || phy_c20 < phy_c21) {\n\t\t\t\t\tphy_c21 = phy_c20;\n\t\t\t\t\tphy_c13 = phy_c11;\n\t\t\t\t\tphy_c14 = phy_c12;\n\t\t\t\t}\n\t\t\t\tphy_c23 = false;\n\t\t\t}\n\t\t}\n\t\tphy_c23 = true;\n\t\tphy_c15 = phy_c13;\n\t\tphy_c16 = phy_c14;\n\t\tphy_c7 = phy_c7 >> 1;\n\t\twlc_lcnphy_set_cc(pi, cal_type, phy_c15, phy_c16);\n\t\tudelay(20);\n\t}\n\tgoto cleanup;\ncleanup:\n\twlc_lcnphy_tx_iqlo_loopback_cleanup(pi, phy_c32);\n\twlc_lcnphy_stop_tx_tone(pi);\n\twrite_phy_reg(pi, 0x6da, phy_c26);\n\twrite_phy_reg(pi, 0x6db, phy_c27);\n\twrite_phy_reg(pi, 0x938, phy_c28);\n\twrite_phy_reg(pi, 0x4d7, phy_c29);\n\twrite_phy_reg(pi, 0x4d8, phy_c30);\n\twrite_radio_reg(pi, RADIO_2064_REG026, phy_c31);\n\n\tkfree(phy_c32);\n\tkfree(ptr);\n}\n\nvoid wlc_lcnphy_get_tx_iqcc(struct brcms_phy *pi, u16 *a, u16 *b)\n{\n\tu16 iqcc[2];\n\tstruct phytbl_info tab;\n\n\ttab.tbl_ptr = iqcc;\n\ttab.tbl_len = 2;\n\ttab.tbl_id = 0;\n\ttab.tbl_offset = 80;\n\ttab.tbl_width = 16;\n\twlc_lcnphy_read_table(pi, &tab);\n\n\t*a = iqcc[0];\n\t*b = iqcc[1];\n}\n\nstatic void wlc_lcnphy_tx_iqlo_soft_cal_full(struct brcms_phy *pi)\n{\n\twlc_lcnphy_set_cc(pi, 0, 0, 0);\n\twlc_lcnphy_set_cc(pi, 2, 0, 0);\n\twlc_lcnphy_set_cc(pi, 3, 0, 0);\n\twlc_lcnphy_set_cc(pi, 4, 0, 0);\n\n\twlc_lcnphy_a1(pi, 4, 0, 0);\n\twlc_lcnphy_a1(pi, 3, 0, 0);\n\twlc_lcnphy_a1(pi, 2, 3, 2);\n\twlc_lcnphy_a1(pi, 0, 5, 8);\n\twlc_lcnphy_a1(pi, 2, 2, 1);\n\twlc_lcnphy_a1(pi, 0, 4, 3);\n\n\twlc_lcnphy_get_cc(pi, 0);\n\twlc_lcnphy_get_cc(pi, 2);\n\twlc_lcnphy_get_cc(pi, 3);\n\twlc_lcnphy_get_cc(pi, 4);\n}\n\nu16 wlc_lcnphy_get_tx_locc(struct brcms_phy *pi)\n{\n\tstruct phytbl_info tab;\n\tu16 didq;\n\n\ttab.tbl_id = 0;\n\ttab.tbl_width = 16;\n\ttab.tbl_ptr = &didq;\n\ttab.tbl_len = 1;\n\ttab.tbl_offset = 85;\n\twlc_lcnphy_read_table(pi, &tab);\n\n\treturn didq;\n}\n\nstatic void wlc_lcnphy_txpwrtbl_iqlo_cal(struct brcms_phy *pi)\n{\n\n\tstruct lcnphy_txgains target_gains, old_gains;\n\tu8 save_bb_mult;\n\tu16 a, b, didq, save_pa_gain = 0;\n\tuint idx, SAVE_txpwrindex = 0xFF;\n\tu32 val;\n\tu16 SAVE_txpwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\n\tstruct phytbl_info tab;\n\tu8 ei0, eq0, fi0, fq0;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\twlc_lcnphy_get_tx_gain(pi, &old_gains);\n\tsave_pa_gain = wlc_lcnphy_get_pa_gain(pi);\n\n\tsave_bb_mult = wlc_lcnphy_get_bbmult(pi);\n\n\tif (SAVE_txpwrctrl == LCNPHY_TX_PWR_CTRL_OFF)\n\t\tSAVE_txpwrindex = wlc_lcnphy_get_current_tx_pwr_idx(pi);\n\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\n\n\ttarget_gains.gm_gain = 7;\n\ttarget_gains.pga_gain = 0;\n\ttarget_gains.pad_gain = 21;\n\ttarget_gains.dac_gain = 0;\n\twlc_lcnphy_set_tx_gain(pi, &target_gains);\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 1) || pi_lcn->lcnphy_hw_iqcal_en) {\n\n\t\twlc_lcnphy_set_tx_pwr_by_index(pi, 30);\n\n\t\twlc_lcnphy_tx_iqlo_cal(pi, &target_gains,\n\t\t\t\t       (pi_lcn->\n\t\t\t\t\tlcnphy_recal ? LCNPHY_CAL_RECAL :\n\t\t\t\t\tLCNPHY_CAL_FULL), false);\n\t} else {\n\t\twlc_lcnphy_set_tx_pwr_by_index(pi, 16);\n\t\twlc_lcnphy_tx_iqlo_soft_cal_full(pi);\n\t}\n\n\twlc_lcnphy_get_radio_loft(pi, &ei0, &eq0, &fi0, &fq0);\n\tif ((abs((s8) fi0) == 15) && (abs((s8) fq0) == 15)) {\n\t\tif (CHSPEC_IS5G(pi->radio_chanspec)) {\n\t\t\ttarget_gains.gm_gain = 255;\n\t\t\ttarget_gains.pga_gain = 255;\n\t\t\ttarget_gains.pad_gain = 0xf0;\n\t\t\ttarget_gains.dac_gain = 0;\n\t\t} else {\n\t\t\ttarget_gains.gm_gain = 7;\n\t\t\ttarget_gains.pga_gain = 45;\n\t\t\ttarget_gains.pad_gain = 186;\n\t\t\ttarget_gains.dac_gain = 0;\n\t\t}\n\n\t\tif (LCNREV_IS(pi->pubpi.phy_rev, 1)\n\t\t    || pi_lcn->lcnphy_hw_iqcal_en) {\n\n\t\t\ttarget_gains.pga_gain = 0;\n\t\t\ttarget_gains.pad_gain = 30;\n\t\t\twlc_lcnphy_set_tx_pwr_by_index(pi, 16);\n\t\t\twlc_lcnphy_tx_iqlo_cal(pi, &target_gains,\n\t\t\t\t\t       LCNPHY_CAL_FULL, false);\n\t\t} else {\n\t\t\twlc_lcnphy_tx_iqlo_soft_cal_full(pi);\n\t\t}\n\t}\n\n\twlc_lcnphy_get_tx_iqcc(pi, &a, &b);\n\n\tdidq = wlc_lcnphy_get_tx_locc(pi);\n\n\ttab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\n\ttab.tbl_width = 32;\n\ttab.tbl_ptr = &val;\n\n\ttab.tbl_len = 1;\n\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_RATE_OFFSET;\n\n\tfor (idx = 0; idx < 128; idx++) {\n\t\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_IQ_OFFSET + idx;\n\n\t\twlc_lcnphy_read_table(pi, &tab);\n\t\tval = (val & 0xfff00000) |\n\t\t      ((u32) (a & 0x3FF) << 10) | (b & 0x3ff);\n\t\twlc_lcnphy_write_table(pi, &tab);\n\n\t\tval = didq;\n\t\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_LO_OFFSET + idx;\n\t\twlc_lcnphy_write_table(pi, &tab);\n\t}\n\n\tpi_lcn->lcnphy_cal_results.txiqlocal_a = a;\n\tpi_lcn->lcnphy_cal_results.txiqlocal_b = b;\n\tpi_lcn->lcnphy_cal_results.txiqlocal_didq = didq;\n\tpi_lcn->lcnphy_cal_results.txiqlocal_ei0 = ei0;\n\tpi_lcn->lcnphy_cal_results.txiqlocal_eq0 = eq0;\n\tpi_lcn->lcnphy_cal_results.txiqlocal_fi0 = fi0;\n\tpi_lcn->lcnphy_cal_results.txiqlocal_fq0 = fq0;\n\n\twlc_lcnphy_set_bbmult(pi, save_bb_mult);\n\twlc_lcnphy_set_pa_gain(pi, save_pa_gain);\n\twlc_lcnphy_set_tx_gain(pi, &old_gains);\n\n\tif (SAVE_txpwrctrl != LCNPHY_TX_PWR_CTRL_OFF)\n\t\twlc_lcnphy_set_tx_pwr_ctrl(pi, SAVE_txpwrctrl);\n\telse\n\t\twlc_lcnphy_set_tx_pwr_by_index(pi, SAVE_txpwrindex);\n}\n\ns16 wlc_lcnphy_tempsense_new(struct brcms_phy *pi, bool mode)\n{\n\tu16 tempsenseval1, tempsenseval2;\n\ts16 avg = 0;\n\tbool suspend = false;\n\n\tif (mode == 1) {\n\t\tsuspend = (0 == (bcma_read32(pi->d11core,\n\t\t\t\t\t     D11REGOFFS(maccontrol)) &\n\t\t\t\t MCTL_EN_MAC));\n\t\tif (!suspend)\n\t\t\twlapi_suspend_mac_and_wait(pi->sh->physhim);\n\t\twlc_lcnphy_vbat_temp_sense_setup(pi, TEMPSENSE);\n\t}\n\ttempsenseval1 = read_phy_reg(pi, 0x476) & 0x1FF;\n\ttempsenseval2 = read_phy_reg(pi, 0x477) & 0x1FF;\n\n\tif (tempsenseval1 > 255)\n\t\tavg = (s16) (tempsenseval1 - 512);\n\telse\n\t\tavg = (s16) tempsenseval1;\n\n\tif (tempsenseval2 > 255)\n\t\tavg += (s16) (tempsenseval2 - 512);\n\telse\n\t\tavg += (s16) tempsenseval2;\n\n\tavg /= 2;\n\n\tif (mode == 1) {\n\n\t\tmod_phy_reg(pi, 0x448, (0x1 << 14), (1) << 14);\n\n\t\tudelay(100);\n\t\tmod_phy_reg(pi, 0x448, (0x1 << 14), (0) << 14);\n\n\t\tif (!suspend)\n\t\t\twlapi_enable_mac(pi->sh->physhim);\n\t}\n\treturn avg;\n}\n\nu16 wlc_lcnphy_tempsense(struct brcms_phy *pi, bool mode)\n{\n\tu16 tempsenseval1, tempsenseval2;\n\ts32 avg = 0;\n\tbool suspend = false;\n\tu16 SAVE_txpwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tif (mode == 1) {\n\t\tsuspend = (0 == (bcma_read32(pi->d11core,\n\t\t\t\t\t     D11REGOFFS(maccontrol)) &\n\t\t\t\t MCTL_EN_MAC));\n\t\tif (!suspend)\n\t\t\twlapi_suspend_mac_and_wait(pi->sh->physhim);\n\t\twlc_lcnphy_vbat_temp_sense_setup(pi, TEMPSENSE);\n\t}\n\ttempsenseval1 = read_phy_reg(pi, 0x476) & 0x1FF;\n\ttempsenseval2 = read_phy_reg(pi, 0x477) & 0x1FF;\n\n\tif (tempsenseval1 > 255)\n\t\tavg = (int)(tempsenseval1 - 512);\n\telse\n\t\tavg = (int)tempsenseval1;\n\n\tif (pi_lcn->lcnphy_tempsense_option == 1 || pi->hwpwrctrl_capable) {\n\t\tif (tempsenseval2 > 255)\n\t\t\tavg = (int)(avg - tempsenseval2 + 512);\n\t\telse\n\t\t\tavg = (int)(avg - tempsenseval2);\n\t} else {\n\t\tif (tempsenseval2 > 255)\n\t\t\tavg = (int)(avg + tempsenseval2 - 512);\n\t\telse\n\t\t\tavg = (int)(avg + tempsenseval2);\n\t\tavg = avg / 2;\n\t}\n\tif (avg < 0)\n\t\tavg = avg + 512;\n\n\tif (pi_lcn->lcnphy_tempsense_option == 2)\n\t\tavg = tempsenseval1;\n\n\tif (mode)\n\t\twlc_lcnphy_set_tx_pwr_ctrl(pi, SAVE_txpwrctrl);\n\n\tif (mode == 1) {\n\n\t\tmod_phy_reg(pi, 0x448, (0x1 << 14), (1) << 14);\n\n\t\tudelay(100);\n\t\tmod_phy_reg(pi, 0x448, (0x1 << 14), (0) << 14);\n\n\t\tif (!suspend)\n\t\t\twlapi_enable_mac(pi->sh->physhim);\n\t}\n\treturn (u16) avg;\n}\n\ns8 wlc_lcnphy_tempsense_degree(struct brcms_phy *pi, bool mode)\n{\n\ts32 degree = wlc_lcnphy_tempsense_new(pi, mode);\n\tdegree =\n\t\t((degree <<\n\t\t  10) + LCN_TEMPSENSE_OFFSET + (LCN_TEMPSENSE_DEN >> 1))\n\t\t/ LCN_TEMPSENSE_DEN;\n\treturn (s8) degree;\n}\n\ns8 wlc_lcnphy_vbatsense(struct brcms_phy *pi, bool mode)\n{\n\tu16 vbatsenseval;\n\ts32 avg = 0;\n\tbool suspend = false;\n\n\tif (mode == 1) {\n\t\tsuspend = (0 == (bcma_read32(pi->d11core,\n\t\t\t\t\t     D11REGOFFS(maccontrol)) &\n\t\t\t\t MCTL_EN_MAC));\n\t\tif (!suspend)\n\t\t\twlapi_suspend_mac_and_wait(pi->sh->physhim);\n\t\twlc_lcnphy_vbat_temp_sense_setup(pi, VBATSENSE);\n\t}\n\n\tvbatsenseval = read_phy_reg(pi, 0x475) & 0x1FF;\n\n\tif (vbatsenseval > 255)\n\t\tavg = (s32) (vbatsenseval - 512);\n\telse\n\t\tavg = (s32) vbatsenseval;\n\n\tavg =\t(avg * LCN_VBAT_SCALE_NOM +\n\t\t (LCN_VBAT_SCALE_DEN >> 1)) / LCN_VBAT_SCALE_DEN;\n\n\tif (mode == 1) {\n\t\tif (!suspend)\n\t\t\twlapi_enable_mac(pi->sh->physhim);\n\t}\n\treturn (s8) avg;\n}\n\nstatic void wlc_lcnphy_afe_clk_init(struct brcms_phy *pi, u8 mode)\n{\n\tu8 phybw40;\n\tphybw40 = CHSPEC_IS40(pi->radio_chanspec);\n\n\tmod_phy_reg(pi, 0x6d1, (0x1 << 7), (1) << 7);\n\n\tif (((mode == AFE_CLK_INIT_MODE_PAPD) && (phybw40 == 0)) ||\n\t    (mode == AFE_CLK_INIT_MODE_TXRX2X))\n\t\twrite_phy_reg(pi, 0x6d0, 0x7);\n\n\twlc_lcnphy_toggle_afe_pwdn(pi);\n}\n\nstatic void wlc_lcnphy_temp_adj(struct brcms_phy *pi)\n{\n}\n\nstatic void wlc_lcnphy_glacial_timer_based_cal(struct brcms_phy *pi)\n{\n\tbool suspend;\n\ts8 index;\n\tu16 SAVE_pwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\tsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\n\t\t\t MCTL_EN_MAC));\n\tif (!suspend)\n\t\twlapi_suspend_mac_and_wait(pi->sh->physhim);\n\twlc_lcnphy_deaf_mode(pi, true);\n\tpi->phy_lastcal = pi->sh->now;\n\tpi->phy_forcecal = false;\n\tindex = pi_lcn->lcnphy_current_index;\n\n\twlc_lcnphy_txpwrtbl_iqlo_cal(pi);\n\n\twlc_lcnphy_set_tx_pwr_by_index(pi, index);\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, SAVE_pwrctrl);\n\twlc_lcnphy_deaf_mode(pi, false);\n\tif (!suspend)\n\t\twlapi_enable_mac(pi->sh->physhim);\n\n}\n\nstatic void wlc_lcnphy_periodic_cal(struct brcms_phy *pi)\n{\n\tbool suspend;\n\tu16 SAVE_pwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\n\ts8 index;\n\tstruct phytbl_info tab;\n\ts32 a1, b0, b1;\n\ts32 tssi, pwr, mintargetpwr;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tpi->phy_lastcal = pi->sh->now;\n\tpi->phy_forcecal = false;\n\tpi_lcn->lcnphy_full_cal_channel = CHSPEC_CHANNEL(pi->radio_chanspec);\n\tindex = pi_lcn->lcnphy_current_index;\n\n\tsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\n\t\t\t MCTL_EN_MAC));\n\tif (!suspend) {\n\t\twlapi_bmac_write_shm(pi->sh->physhim, M_CTS_DURATION, 10000);\n\t\twlapi_suspend_mac_and_wait(pi->sh->physhim);\n\t}\n\n\twlc_lcnphy_deaf_mode(pi, true);\n\n\twlc_lcnphy_txpwrtbl_iqlo_cal(pi);\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 1))\n\t\twlc_lcnphy_rx_iq_cal(pi, NULL, 0, true, false, 1, 40);\n\telse\n\t\twlc_lcnphy_rx_iq_cal(pi, NULL, 0, true, false, 1, 127);\n\n\tif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi)) {\n\n\t\twlc_lcnphy_idle_tssi_est((struct brcms_phy_pub *) pi);\n\n\t\tb0 = pi->txpa_2g[0];\n\t\tb1 = pi->txpa_2g[1];\n\t\ta1 = pi->txpa_2g[2];\n\t\tmintargetpwr = wlc_lcnphy_tssi2dbm(125, a1, b0, b1);\n\n\t\ttab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\n\t\ttab.tbl_width = 32;\n\t\ttab.tbl_ptr = &pwr;\n\t\ttab.tbl_len = 1;\n\t\ttab.tbl_offset = 0;\n\t\tfor (tssi = 0; tssi < 128; tssi++) {\n\t\t\tpwr = wlc_lcnphy_tssi2dbm(tssi, a1, b0, b1);\n\t\t\tpwr = (pwr < mintargetpwr) ? mintargetpwr : pwr;\n\t\t\twlc_lcnphy_write_table(pi, &tab);\n\t\t\ttab.tbl_offset++;\n\t\t}\n\t}\n\n\twlc_lcnphy_set_tx_pwr_by_index(pi, index);\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, SAVE_pwrctrl);\n\twlc_lcnphy_deaf_mode(pi, false);\n\tif (!suspend)\n\t\twlapi_enable_mac(pi->sh->physhim);\n}\n\nvoid wlc_lcnphy_calib_modes(struct brcms_phy *pi, uint mode)\n{\n\tu16 temp_new;\n\tint temp1, temp2, temp_diff;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tswitch (mode) {\n\tcase PHY_PERICAL_CHAN:\n\t\tbreak;\n\tcase PHY_FULLCAL:\n\t\twlc_lcnphy_periodic_cal(pi);\n\t\tbreak;\n\tcase PHY_PERICAL_PHYINIT:\n\t\twlc_lcnphy_periodic_cal(pi);\n\t\tbreak;\n\tcase PHY_PERICAL_WATCHDOG:\n\t\tif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi)) {\n\t\t\ttemp_new = wlc_lcnphy_tempsense(pi, 0);\n\t\t\ttemp1 = LCNPHY_TEMPSENSE(temp_new);\n\t\t\ttemp2 = LCNPHY_TEMPSENSE(pi_lcn->lcnphy_cal_temper);\n\t\t\ttemp_diff = temp1 - temp2;\n\t\t\tif ((pi_lcn->lcnphy_cal_counter > 90) ||\n\t\t\t    (temp_diff > 60) || (temp_diff < -60)) {\n\t\t\t\twlc_lcnphy_glacial_timer_based_cal(pi);\n\t\t\t\twlc_2064_vco_cal(pi);\n\t\t\t\tpi_lcn->lcnphy_cal_temper = temp_new;\n\t\t\t\tpi_lcn->lcnphy_cal_counter = 0;\n\t\t\t} else\n\t\t\t\tpi_lcn->lcnphy_cal_counter++;\n\t\t}\n\t\tbreak;\n\tcase LCNPHY_PERICAL_TEMPBASED_TXPWRCTRL:\n\t\tif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\n\t\t\twlc_lcnphy_tx_power_adjustment(\n\t\t\t\t(struct brcms_phy_pub *) pi);\n\t\tbreak;\n\t}\n}\n\nvoid wlc_lcnphy_get_tssi(struct brcms_phy *pi, s8 *ofdm_pwr, s8 *cck_pwr)\n{\n\ts8 cck_offset;\n\tu16 status;\n\tstatus = (read_phy_reg(pi, 0x4ab));\n\tif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi) &&\n\t    (status  & (0x1 << 15))) {\n\t\t*ofdm_pwr = (s8) (((read_phy_reg(pi, 0x4ab) & (0x1ff << 0))\n\t\t\t\t   >> 0) >> 1);\n\n\t\tif (wlc_phy_tpc_isenabled_lcnphy(pi))\n\t\t\tcck_offset = pi->tx_power_offset[TXP_FIRST_CCK];\n\t\telse\n\t\t\tcck_offset = 0;\n\n\t\t*cck_pwr = *ofdm_pwr + cck_offset;\n\t} else {\n\t\t*cck_pwr = 0;\n\t\t*ofdm_pwr = 0;\n\t}\n}\n\nvoid wlc_phy_cal_init_lcnphy(struct brcms_phy *pi)\n{\n\treturn;\n\n}\n\nvoid wlc_lcnphy_tx_power_adjustment(struct brcms_phy_pub *ppi)\n{\n\ts8 index;\n\tu16 index2;\n\tstruct brcms_phy *pi = container_of(ppi, struct brcms_phy, pubpi_ro);\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\tu16 SAVE_txpwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\n\tif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi) &&\n\t    SAVE_txpwrctrl) {\n\t\tindex = wlc_lcnphy_tempcompensated_txpwrctrl(pi);\n\t\tindex2 = (u16) (index * 2);\n\t\tmod_phy_reg(pi, 0x4a9, (0x1ff << 0), (index2) << 0);\n\n\t\tpi_lcn->lcnphy_current_index =\n\t\t\t(s8)((read_phy_reg(pi, 0x4a9) & 0xFF) / 2);\n\t}\n}\n\nstatic void\nwlc_lcnphy_load_tx_gain_table(struct brcms_phy *pi,\n\t\t\t      const struct lcnphy_tx_gain_tbl_entry *gain_table)\n{\n\tu32 j;\n\tstruct phytbl_info tab;\n\tu32 val;\n\tu16 pa_gain;\n\tu16 gm_gain;\n\n\tif (pi->sh->boardflags & BFL_FEM)\n\t\tpa_gain = 0x10;\n\telse\n\t\tpa_gain = 0x60;\n\ttab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\n\ttab.tbl_width = 32;\n\ttab.tbl_len = 1;\n\ttab.tbl_ptr = &val;\n\n\t \n\tgm_gain = 15;\n\tfor (j = 0; j < 128; j++) {\n\t\tif (pi->sh->boardflags & BFL_FEM)\n\t\t\tgm_gain = gain_table[j].gm;\n\t\tval = (((u32) pa_gain << 24) |\n\t\t       (gain_table[j].pad << 16) |\n\t\t       (gain_table[j].pga << 8) | gm_gain);\n\n\t\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_GAIN_OFFSET + j;\n\t\twlc_lcnphy_write_table(pi, &tab);\n\n\t\tval = (gain_table[j].dac << 28) | (gain_table[j].bb_mult << 20);\n\t\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_IQ_OFFSET + j;\n\t\twlc_lcnphy_write_table(pi, &tab);\n\t}\n}\n\nstatic void wlc_lcnphy_load_rfpower(struct brcms_phy *pi)\n{\n\tstruct phytbl_info tab;\n\tu32 val, bbmult, rfgain;\n\tu8 index;\n\tu8 scale_factor = 1;\n\ts16 temp, temp1, temp2, qQ, qQ1, qQ2, shift;\n\n\ttab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\n\ttab.tbl_width = 32;\n\ttab.tbl_len = 1;\n\n\tfor (index = 0; index < 128; index++) {\n\t\ttab.tbl_ptr = &bbmult;\n\t\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_IQ_OFFSET + index;\n\t\twlc_lcnphy_read_table(pi, &tab);\n\t\tbbmult = bbmult >> 20;\n\n\t\ttab.tbl_ptr = &rfgain;\n\t\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_GAIN_OFFSET + index;\n\t\twlc_lcnphy_read_table(pi, &tab);\n\n\t\tqm_log10((s32) (bbmult), 0, &temp1, &qQ1);\n\t\tqm_log10((s32) (1 << 6), 0, &temp2, &qQ2);\n\n\t\tif (qQ1 < qQ2) {\n\t\t\ttemp2 = qm_shr16(temp2, qQ2 - qQ1);\n\t\t\tqQ = qQ1;\n\t\t} else {\n\t\t\ttemp1 = qm_shr16(temp1, qQ1 - qQ2);\n\t\t\tqQ = qQ2;\n\t\t}\n\t\ttemp = qm_sub16(temp1, temp2);\n\n\t\tif (qQ >= 4)\n\t\t\tshift = qQ - 4;\n\t\telse\n\t\t\tshift = 4 - qQ;\n\n\t\tval = (((index << shift) + (5 * temp) +\n\t\t\t(1 << (scale_factor + shift - 3))) >> (scale_factor +\n\t\t\t\t\t\t\t       shift - 2));\n\n\t\ttab.tbl_ptr = &val;\n\t\ttab.tbl_offset = LCNPHY_TX_PWR_CTRL_PWR_OFFSET + index;\n\t\twlc_lcnphy_write_table(pi, &tab);\n\t}\n}\n\nstatic void wlc_lcnphy_bu_tweaks(struct brcms_phy *pi)\n{\n\tor_phy_reg(pi, 0x805, 0x1);\n\n\tmod_phy_reg(pi, 0x42f, (0x7 << 0), (0x3) << 0);\n\n\tmod_phy_reg(pi, 0x030, (0x7 << 0), (0x3) << 0);\n\n\twrite_phy_reg(pi, 0x414, 0x1e10);\n\twrite_phy_reg(pi, 0x415, 0x0640);\n\n\tmod_phy_reg(pi, 0x4df, (0xff << 8), -9 << 8);\n\n\tor_phy_reg(pi, 0x44a, 0x44);\n\twrite_phy_reg(pi, 0x44a, 0x80);\n\tmod_phy_reg(pi, 0x434, (0xff << 0), (0xFD) << 0);\n\n\tmod_phy_reg(pi, 0x420, (0xff << 0), (16) << 0);\n\n\tif (!(pi->sh->boardrev < 0x1204))\n\t\tmod_radio_reg(pi, RADIO_2064_REG09B, 0xF0, 0xF0);\n\n\twrite_phy_reg(pi, 0x7d6, 0x0902);\n\tmod_phy_reg(pi, 0x429, (0xf << 0), (0x9) << 0);\n\n\tmod_phy_reg(pi, 0x429, (0x3f << 4), (0xe) << 4);\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 1)) {\n\t\tmod_phy_reg(pi, 0x423, (0xff << 0), (0x46) << 0);\n\n\t\tmod_phy_reg(pi, 0x411, (0xff << 0), (1) << 0);\n\n\t\tmod_phy_reg(pi, 0x434, (0xff << 0), (0xFF) << 0);\n\n\t\tmod_phy_reg(pi, 0x656, (0xf << 0), (2) << 0);\n\n\t\tmod_phy_reg(pi, 0x44d, (0x1 << 2), (1) << 2);\n\n\t\tmod_radio_reg(pi, RADIO_2064_REG0F7, 0x4, 0x4);\n\t\tmod_radio_reg(pi, RADIO_2064_REG0F1, 0x3, 0);\n\t\tmod_radio_reg(pi, RADIO_2064_REG0F2, 0xF8, 0x90);\n\t\tmod_radio_reg(pi, RADIO_2064_REG0F3, 0x3, 0x2);\n\t\tmod_radio_reg(pi, RADIO_2064_REG0F3, 0xf0, 0xa0);\n\n\t\tmod_radio_reg(pi, RADIO_2064_REG11F, 0x2, 0x2);\n\n\t\twlc_lcnphy_clear_tx_power_offsets(pi);\n\t\tmod_phy_reg(pi, 0x4d0, (0x1ff << 6), (10) << 6);\n\n\t}\n}\n\nstatic void wlc_lcnphy_rcal(struct brcms_phy *pi)\n{\n\tu8 rcal_value;\n\n\tand_radio_reg(pi, RADIO_2064_REG05B, 0xfD);\n\n\tor_radio_reg(pi, RADIO_2064_REG004, 0x40);\n\tor_radio_reg(pi, RADIO_2064_REG120, 0x10);\n\n\tor_radio_reg(pi, RADIO_2064_REG078, 0x80);\n\tor_radio_reg(pi, RADIO_2064_REG129, 0x02);\n\n\tor_radio_reg(pi, RADIO_2064_REG057, 0x01);\n\n\tor_radio_reg(pi, RADIO_2064_REG05B, 0x02);\n\tmdelay(5);\n\tSPINWAIT(!wlc_radio_2064_rcal_done(pi), 10 * 1000 * 1000);\n\n\tif (wlc_radio_2064_rcal_done(pi)) {\n\t\trcal_value = (u8) read_radio_reg(pi, RADIO_2064_REG05C);\n\t\trcal_value = rcal_value & 0x1f;\n\t}\n\n\tand_radio_reg(pi, RADIO_2064_REG05B, 0xfD);\n\n\tand_radio_reg(pi, RADIO_2064_REG057, 0xFE);\n}\n\nstatic void wlc_lcnphy_rc_cal(struct brcms_phy *pi)\n{\n\tu8 dflt_rc_cal_val;\n\tu16 flt_val;\n\n\tdflt_rc_cal_val = 7;\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 1))\n\t\tdflt_rc_cal_val = 11;\n\tflt_val =\n\t\t(dflt_rc_cal_val << 10) | (dflt_rc_cal_val << 5) |\n\t\t(dflt_rc_cal_val);\n\twrite_phy_reg(pi, 0x933, flt_val);\n\twrite_phy_reg(pi, 0x934, flt_val);\n\twrite_phy_reg(pi, 0x935, flt_val);\n\twrite_phy_reg(pi, 0x936, flt_val);\n\twrite_phy_reg(pi, 0x937, (flt_val & 0x1FF));\n\n\treturn;\n}\n\nstatic void wlc_radio_2064_init(struct brcms_phy *pi)\n{\n\tu32 i;\n\tconst struct lcnphy_radio_regs *lcnphyregs = NULL;\n\n\tlcnphyregs = lcnphy_radio_regs_2064;\n\n\tfor (i = 0; lcnphyregs[i].address != 0xffff; i++)\n\t\tif (CHSPEC_IS5G(pi->radio_chanspec) && lcnphyregs[i].do_init_a)\n\t\t\twrite_radio_reg(pi,\n\t\t\t\t\t((lcnphyregs[i].address & 0x3fff) |\n\t\t\t\t\t RADIO_DEFAULT_CORE),\n\t\t\t\t\t(u16) lcnphyregs[i].init_a);\n\t\telse if (lcnphyregs[i].do_init_g)\n\t\t\twrite_radio_reg(pi,\n\t\t\t\t\t((lcnphyregs[i].address & 0x3fff) |\n\t\t\t\t\t RADIO_DEFAULT_CORE),\n\t\t\t\t\t(u16) lcnphyregs[i].init_g);\n\n\twrite_radio_reg(pi, RADIO_2064_REG032, 0x62);\n\twrite_radio_reg(pi, RADIO_2064_REG033, 0x19);\n\n\twrite_radio_reg(pi, RADIO_2064_REG090, 0x10);\n\n\twrite_radio_reg(pi, RADIO_2064_REG010, 0x00);\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 1)) {\n\n\t\twrite_radio_reg(pi, RADIO_2064_REG060, 0x7f);\n\t\twrite_radio_reg(pi, RADIO_2064_REG061, 0x72);\n\t\twrite_radio_reg(pi, RADIO_2064_REG062, 0x7f);\n\t}\n\n\twrite_radio_reg(pi, RADIO_2064_REG01D, 0x02);\n\twrite_radio_reg(pi, RADIO_2064_REG01E, 0x06);\n\n\tmod_phy_reg(pi, 0x4ea, (0x7 << 0), 0 << 0);\n\n\tmod_phy_reg(pi, 0x4ea, (0x7 << 3), 1 << 3);\n\n\tmod_phy_reg(pi, 0x4ea, (0x7 << 6), 2 << 6);\n\n\tmod_phy_reg(pi, 0x4ea, (0x7 << 9), 3 << 9);\n\n\tmod_phy_reg(pi, 0x4ea, (0x7 << 12), 4 << 12);\n\n\twrite_phy_reg(pi, 0x4ea, 0x4688);\n\n\tif (pi->sh->boardflags & BFL_FEM)\n\t\tmod_phy_reg(pi, 0x4eb, (0x7 << 0), 2 << 0);\n\telse\n\t\tmod_phy_reg(pi, 0x4eb, (0x7 << 0), 3 << 0);\n\n\tmod_phy_reg(pi, 0x4eb, (0x7 << 6), 0 << 6);\n\n\tmod_phy_reg(pi, 0x46a, (0xffff << 0), 25 << 0);\n\n\twlc_lcnphy_set_tx_locc(pi, 0);\n\n\twlc_lcnphy_rcal(pi);\n\n\twlc_lcnphy_rc_cal(pi);\n\n\tif (!(pi->sh->boardflags & BFL_FEM)) {\n\t\twrite_radio_reg(pi, RADIO_2064_REG032, 0x6f);\n\t\twrite_radio_reg(pi, RADIO_2064_REG033, 0x19);\n\t\twrite_radio_reg(pi, RADIO_2064_REG039, 0xe);\n\t}\n\n}\n\nstatic void wlc_lcnphy_radio_init(struct brcms_phy *pi)\n{\n\twlc_radio_2064_init(pi);\n}\n\nstatic void wlc_lcnphy_tbl_init(struct brcms_phy *pi)\n{\n\tuint idx;\n\tstruct phytbl_info tab;\n\tconst struct phytbl_info *tb;\n\tu32 val;\n\n\tfor (idx = 0; idx < dot11lcnphytbl_info_sz_rev0; idx++)\n\t\twlc_lcnphy_write_table(pi, &dot11lcnphytbl_info_rev0[idx]);\n\n\tif (pi->sh->boardflags & BFL_FEM_BT) {\n\t\ttab.tbl_id = LCNPHY_TBL_ID_RFSEQ;\n\t\ttab.tbl_width = 16;\n\t\ttab.tbl_ptr = &val;\n\t\ttab.tbl_len = 1;\n\t\tval = 100;\n\t\ttab.tbl_offset = 4;\n\t\twlc_lcnphy_write_table(pi, &tab);\n\t}\n\n\tif (!(pi->sh->boardflags & BFL_FEM)) {\n\t\ttab.tbl_id = LCNPHY_TBL_ID_RFSEQ;\n\t\ttab.tbl_width = 16;\n\t\ttab.tbl_ptr = &val;\n\t\ttab.tbl_len = 1;\n\n\t\tval = 150;\n\t\ttab.tbl_offset = 0;\n\t\twlc_lcnphy_write_table(pi, &tab);\n\n\t\tval = 220;\n\t\ttab.tbl_offset = 1;\n\t\twlc_lcnphy_write_table(pi, &tab);\n\t}\n\n\tif (CHSPEC_IS2G(pi->radio_chanspec)) {\n\t\tif (pi->sh->boardflags & BFL_FEM)\n\t\t\twlc_lcnphy_load_tx_gain_table(\n\t\t\t\tpi,\n\t\t\t\tdot11lcnphy_2GHz_extPA_gaintable_rev0);\n\t\telse\n\t\t\twlc_lcnphy_load_tx_gain_table(\n\t\t\t\tpi,\n\t\t\t\tdot11lcnphy_2GHz_gaintable_rev0);\n\t}\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\n\t\tint l;\n\n\t\tif (CHSPEC_IS2G(pi->radio_chanspec)) {\n\t\t\tl = dot11lcnphytbl_rx_gain_info_2G_rev2_sz;\n\t\t\tif (pi->sh->boardflags & BFL_EXTLNA)\n\t\t\t\ttb = dot11lcnphytbl_rx_gain_info_extlna_2G_rev2;\n\t\t\telse\n\t\t\t\ttb = dot11lcnphytbl_rx_gain_info_2G_rev2;\n\t\t} else {\n\t\t\tl = dot11lcnphytbl_rx_gain_info_5G_rev2_sz;\n\t\t\tif (pi->sh->boardflags & BFL_EXTLNA_5GHz)\n\t\t\t\ttb = dot11lcnphytbl_rx_gain_info_extlna_5G_rev2;\n\t\t\telse\n\t\t\t\ttb = dot11lcnphytbl_rx_gain_info_5G_rev2;\n\t\t}\n\n\t\tfor (idx = 0; idx < l; idx++)\n\t\t\twlc_lcnphy_write_table(pi, &tb[idx]);\n\t}\n\n\tif (pi->sh->boardflags & BFL_FEM) {\n\t\tif (pi->sh->boardflags & BFL_FEM_BT) {\n\t\t\tif (pi->sh->boardrev < 0x1250)\n\t\t\t\ttb = &dot11lcn_sw_ctrl_tbl_info_4313_bt_epa;\n\t\t\telse\n\t\t\t\ttb = &dot11lcn_sw_ctrl_tbl_info_4313_bt_epa_p250;\n\t\t} else {\n\t\t\ttb = &dot11lcn_sw_ctrl_tbl_info_4313_epa;\n\t\t}\n\t} else {\n\t\tif (pi->sh->boardflags & BFL_FEM_BT)\n\t\t\ttb = &dot11lcn_sw_ctrl_tbl_info_4313_bt_ipa;\n\t\telse\n\t\t\ttb = &dot11lcn_sw_ctrl_tbl_info_4313;\n\t}\n\twlc_lcnphy_write_table(pi, tb);\n\twlc_lcnphy_load_rfpower(pi);\n\n\twlc_lcnphy_clear_papd_comptable(pi);\n}\n\nstatic void wlc_lcnphy_rev0_baseband_init(struct brcms_phy *pi)\n{\n\tu16 afectrl1;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\twrite_radio_reg(pi, RADIO_2064_REG11C, 0x0);\n\n\twrite_phy_reg(pi, 0x43b, 0x0);\n\twrite_phy_reg(pi, 0x43c, 0x0);\n\twrite_phy_reg(pi, 0x44c, 0x0);\n\twrite_phy_reg(pi, 0x4e6, 0x0);\n\twrite_phy_reg(pi, 0x4f9, 0x0);\n\twrite_phy_reg(pi, 0x4b0, 0x0);\n\twrite_phy_reg(pi, 0x938, 0x0);\n\twrite_phy_reg(pi, 0x4b0, 0x0);\n\twrite_phy_reg(pi, 0x44e, 0);\n\n\tor_phy_reg(pi, 0x567, 0x03);\n\n\tor_phy_reg(pi, 0x44a, 0x44);\n\twrite_phy_reg(pi, 0x44a, 0x80);\n\n\tif (!(pi->sh->boardflags & BFL_FEM))\n\t\twlc_lcnphy_set_tx_pwr_by_index(pi, 52);\n\n\tif (0) {\n\t\tafectrl1 = 0;\n\t\tafectrl1 = (u16) ((pi_lcn->lcnphy_rssi_vf) |\n\t\t\t\t  (pi_lcn->lcnphy_rssi_vc << 4) |\n\t\t\t\t  (pi_lcn->lcnphy_rssi_gs << 10));\n\t\twrite_phy_reg(pi, 0x43e, afectrl1);\n\t}\n\n\tmod_phy_reg(pi, 0x634, (0xff << 0), 0xC << 0);\n\tif (pi->sh->boardflags & BFL_FEM) {\n\t\tmod_phy_reg(pi, 0x634, (0xff << 0), 0xA << 0);\n\n\t\twrite_phy_reg(pi, 0x910, 0x1);\n\t}\n\n\tmod_phy_reg(pi, 0x448, (0x3 << 8), 1 << 8);\n\tmod_phy_reg(pi, 0x608, (0xff << 0), 0x17 << 0);\n\tmod_phy_reg(pi, 0x604, (0x7ff << 0), 0x3EA << 0);\n\n}\n\nstatic void wlc_lcnphy_rev2_baseband_init(struct brcms_phy *pi)\n{\n\tif (CHSPEC_IS5G(pi->radio_chanspec)) {\n\t\tmod_phy_reg(pi, 0x416, (0xff << 0), 80 << 0);\n\t\tmod_phy_reg(pi, 0x416, (0xff << 8), 80 << 8);\n\t}\n}\n\nstatic void wlc_lcnphy_agc_temp_init(struct brcms_phy *pi)\n{\n\ts16 temp;\n\tstruct phytbl_info tab;\n\tu32 tableBuffer[2];\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\ttemp = (s16) read_phy_reg(pi, 0x4df);\n\tpi_lcn->lcnphy_ofdmgainidxtableoffset = (temp & (0xff << 0)) >> 0;\n\n\tif (pi_lcn->lcnphy_ofdmgainidxtableoffset > 127)\n\t\tpi_lcn->lcnphy_ofdmgainidxtableoffset -= 256;\n\n\tpi_lcn->lcnphy_dsssgainidxtableoffset = (temp & (0xff << 8)) >> 8;\n\n\tif (pi_lcn->lcnphy_dsssgainidxtableoffset > 127)\n\t\tpi_lcn->lcnphy_dsssgainidxtableoffset -= 256;\n\n\ttab.tbl_ptr = tableBuffer;\n\ttab.tbl_len = 2;\n\ttab.tbl_id = 17;\n\ttab.tbl_offset = 59;\n\ttab.tbl_width = 32;\n\twlc_lcnphy_read_table(pi, &tab);\n\n\tif (tableBuffer[0] > 63)\n\t\ttableBuffer[0] -= 128;\n\tpi_lcn->lcnphy_tr_R_gain_val = tableBuffer[0];\n\n\tif (tableBuffer[1] > 63)\n\t\ttableBuffer[1] -= 128;\n\tpi_lcn->lcnphy_tr_T_gain_val = tableBuffer[1];\n\n\ttemp = (s16) (read_phy_reg(pi, 0x434) & (0xff << 0));\n\tif (temp > 127)\n\t\ttemp -= 256;\n\tpi_lcn->lcnphy_input_pwr_offset_db = (s8) temp;\n\n\tpi_lcn->lcnphy_Med_Low_Gain_db =\n\t\t(read_phy_reg(pi, 0x424) & (0xff << 8)) >> 8;\n\tpi_lcn->lcnphy_Very_Low_Gain_db =\n\t\t(read_phy_reg(pi, 0x425) & (0xff << 0)) >> 0;\n\n\ttab.tbl_ptr = tableBuffer;\n\ttab.tbl_len = 2;\n\ttab.tbl_id = LCNPHY_TBL_ID_GAIN_IDX;\n\ttab.tbl_offset = 28;\n\ttab.tbl_width = 32;\n\twlc_lcnphy_read_table(pi, &tab);\n\n\tpi_lcn->lcnphy_gain_idx_14_lowword = tableBuffer[0];\n\tpi_lcn->lcnphy_gain_idx_14_hiword = tableBuffer[1];\n\n}\n\nstatic void wlc_lcnphy_baseband_init(struct brcms_phy *pi)\n{\n\n\twlc_lcnphy_tbl_init(pi);\n\twlc_lcnphy_rev0_baseband_init(pi);\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 2))\n\t\twlc_lcnphy_rev2_baseband_init(pi);\n\twlc_lcnphy_bu_tweaks(pi);\n}\n\nvoid wlc_phy_init_lcnphy(struct brcms_phy *pi)\n{\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tpi_lcn->lcnphy_cal_counter = 0;\n\tpi_lcn->lcnphy_cal_temper = pi_lcn->lcnphy_rawtempsense;\n\n\tor_phy_reg(pi, 0x44a, 0x80);\n\tand_phy_reg(pi, 0x44a, 0x7f);\n\n\twlc_lcnphy_afe_clk_init(pi, AFE_CLK_INIT_MODE_TXRX2X);\n\n\twrite_phy_reg(pi, 0x60a, 160);\n\n\twrite_phy_reg(pi, 0x46a, 25);\n\n\twlc_lcnphy_baseband_init(pi);\n\n\twlc_lcnphy_radio_init(pi);\n\n\tif (CHSPEC_IS2G(pi->radio_chanspec))\n\t\twlc_lcnphy_tx_pwr_ctrl_init((struct brcms_phy_pub *) pi);\n\n\twlc_phy_chanspec_set((struct brcms_phy_pub *) pi, pi->radio_chanspec);\n\n\tbcma_chipco_regctl_maskset(&pi->d11core->bus->drv_cc, 0, ~0xf, 0x9);\n\n\tbcma_chipco_chipctl_maskset(&pi->d11core->bus->drv_cc, 0, 0x0,\n\t\t\t\t    0x03CDDDDD);\n\n\tif ((pi->sh->boardflags & BFL_FEM)\n\t    && wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\n\t\twlc_lcnphy_set_tx_pwr_by_index(pi, FIXED_TXPWR);\n\n\twlc_lcnphy_agc_temp_init(pi);\n\n\twlc_lcnphy_temp_adj(pi);\n\n\tmod_phy_reg(pi, 0x448, (0x1 << 14), (1) << 14);\n\n\tudelay(100);\n\tmod_phy_reg(pi, 0x448, (0x1 << 14), (0) << 14);\n\n\twlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_HW);\n\tpi_lcn->lcnphy_noise_samples = LCNPHY_NOISE_SAMPLES_DEFAULT;\n\twlc_lcnphy_calib_modes(pi, PHY_PERICAL_PHYINIT);\n}\n\nstatic bool wlc_phy_txpwr_srom_read_lcnphy(struct brcms_phy *pi)\n{\n\ts8 txpwr = 0;\n\tint i;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\tstruct ssb_sprom *sprom = &pi->d11core->bus->sprom;\n\n\tif (CHSPEC_IS2G(pi->radio_chanspec)) {\n\t\tu16 cckpo = 0;\n\t\tu32 offset_ofdm, offset_mcs;\n\n\t\tpi_lcn->lcnphy_tr_isolation_mid = sprom->fem.ghz2.tr_iso;\n\n\t\tpi_lcn->lcnphy_rx_power_offset = sprom->rxpo2g;\n\n\t\tpi->txpa_2g[0] = sprom->pa0b0;\n\t\tpi->txpa_2g[1] = sprom->pa0b1;\n\t\tpi->txpa_2g[2] = sprom->pa0b2;\n\n\t\tpi_lcn->lcnphy_rssi_vf = sprom->rssismf2g;\n\t\tpi_lcn->lcnphy_rssi_vc = sprom->rssismc2g;\n\t\tpi_lcn->lcnphy_rssi_gs = sprom->rssisav2g;\n\n\t\tpi_lcn->lcnphy_rssi_vf_lowtemp = pi_lcn->lcnphy_rssi_vf;\n\t\tpi_lcn->lcnphy_rssi_vc_lowtemp = pi_lcn->lcnphy_rssi_vc;\n\t\tpi_lcn->lcnphy_rssi_gs_lowtemp = pi_lcn->lcnphy_rssi_gs;\n\n\t\tpi_lcn->lcnphy_rssi_vf_hightemp = pi_lcn->lcnphy_rssi_vf;\n\t\tpi_lcn->lcnphy_rssi_vc_hightemp = pi_lcn->lcnphy_rssi_vc;\n\t\tpi_lcn->lcnphy_rssi_gs_hightemp = pi_lcn->lcnphy_rssi_gs;\n\n\t\ttxpwr = sprom->core_pwr_info[0].maxpwr_2g;\n\t\tpi->tx_srom_max_2g = txpwr;\n\n\t\tfor (i = 0; i < PWRTBL_NUM_COEFF; i++) {\n\t\t\tpi->txpa_2g_low_temp[i] = pi->txpa_2g[i];\n\t\t\tpi->txpa_2g_high_temp[i] = pi->txpa_2g[i];\n\t\t}\n\n\t\tcckpo = sprom->cck2gpo;\n\t\toffset_ofdm = sprom->ofdm2gpo;\n\t\tif (cckpo) {\n\t\t\tuint max_pwr_chan = txpwr;\n\n\t\t\tfor (i = TXP_FIRST_CCK; i <= TXP_LAST_CCK; i++) {\n\t\t\t\tpi->tx_srom_max_rate_2g[i] =\n\t\t\t\t\tmax_pwr_chan - ((cckpo & 0xf) * 2);\n\t\t\t\tcckpo >>= 4;\n\t\t\t}\n\n\t\t\tfor (i = TXP_FIRST_OFDM; i <= TXP_LAST_OFDM; i++) {\n\t\t\t\tpi->tx_srom_max_rate_2g[i] =\n\t\t\t\t\tmax_pwr_chan -\n\t\t\t\t\t((offset_ofdm & 0xf) * 2);\n\t\t\t\toffset_ofdm >>= 4;\n\t\t\t}\n\t\t} else {\n\t\t\tfor (i = TXP_FIRST_CCK; i <= TXP_LAST_CCK; i++)\n\t\t\t\tpi->tx_srom_max_rate_2g[i] = txpwr;\n\n\t\t\tfor (i = TXP_FIRST_OFDM; i <= TXP_LAST_OFDM; i++) {\n\t\t\t\tpi->tx_srom_max_rate_2g[i] = txpwr -\n\t\t\t\t\t\t((offset_ofdm & 0xf) * 2);\n\t\t\t\toffset_ofdm >>= 4;\n\t\t\t}\n\t\t\toffset_mcs = sprom->mcs2gpo[1] << 16;\n\t\t\toffset_mcs |= sprom->mcs2gpo[0];\n\t\t\tpi_lcn->lcnphy_mcs20_po = offset_mcs;\n\t\t\tfor (i = TXP_FIRST_SISO_MCS_20;\n\t\t\t     i <= TXP_LAST_SISO_MCS_20; i++) {\n\t\t\t\tpi->tx_srom_max_rate_2g[i] =\n\t\t\t\t\ttxpwr - ((offset_mcs & 0xf) * 2);\n\t\t\t\toffset_mcs >>= 4;\n\t\t\t}\n\t\t}\n\n\t\tpi_lcn->lcnphy_rawtempsense = sprom->rawtempsense;\n\t\tpi_lcn->lcnphy_measPower = sprom->measpower;\n\t\tpi_lcn->lcnphy_tempsense_slope = sprom->tempsense_slope;\n\t\tpi_lcn->lcnphy_hw_iqcal_en = sprom->hw_iqcal_en;\n\t\tpi_lcn->lcnphy_iqcal_swp_dis = sprom->iqcal_swp_dis;\n\t\tpi_lcn->lcnphy_tempcorrx = sprom->tempcorrx;\n\t\tpi_lcn->lcnphy_tempsense_option = sprom->tempsense_option;\n\t\tpi_lcn->lcnphy_freqoffset_corr = sprom->freqoffset_corr;\n\t\tif (sprom->ant_available_bg > 1)\n\t\t\twlc_phy_ant_rxdiv_set((struct brcms_phy_pub *) pi,\n\t\t\t\tsprom->ant_available_bg);\n\t}\n\tpi_lcn->lcnphy_cck_dig_filt_type = -1;\n\n\treturn true;\n}\n\nvoid wlc_2064_vco_cal(struct brcms_phy *pi)\n{\n\tu8 calnrst;\n\n\tmod_radio_reg(pi, RADIO_2064_REG057, 1 << 3, 1 << 3);\n\tcalnrst = (u8) read_radio_reg(pi, RADIO_2064_REG056) & 0xf8;\n\twrite_radio_reg(pi, RADIO_2064_REG056, calnrst);\n\tudelay(1);\n\twrite_radio_reg(pi, RADIO_2064_REG056, calnrst | 0x03);\n\tudelay(1);\n\twrite_radio_reg(pi, RADIO_2064_REG056, calnrst | 0x07);\n\tudelay(300);\n\tmod_radio_reg(pi, RADIO_2064_REG057, 1 << 3, 0);\n}\n\nbool wlc_phy_tpc_isenabled_lcnphy(struct brcms_phy *pi)\n{\n\tif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\n\t\treturn false;\n\telse\n\t\treturn (LCNPHY_TX_PWR_CTRL_HW ==\n\t\t\twlc_lcnphy_get_tx_pwr_ctrl((pi)));\n}\n\nvoid wlc_phy_txpower_recalc_target_lcnphy(struct brcms_phy *pi)\n{\n\tu16 pwr_ctrl;\n\tif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi)) {\n\t\twlc_lcnphy_calib_modes(pi, LCNPHY_PERICAL_TEMPBASED_TXPWRCTRL);\n\t} else if (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi)) {\n\t\tpwr_ctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\n\t\twlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\n\t\twlc_lcnphy_txpower_recalc_target(pi);\n\t\twlc_lcnphy_set_tx_pwr_ctrl(pi, pwr_ctrl);\n\t}\n}\n\nvoid wlc_phy_chanspec_set_lcnphy(struct brcms_phy *pi, u16 chanspec)\n{\n\tu8 channel = CHSPEC_CHANNEL(chanspec);\n\n\twlc_phy_chanspec_radio_set((struct brcms_phy_pub *)pi, chanspec);\n\n\twlc_lcnphy_set_chanspec_tweaks(pi, pi->radio_chanspec);\n\n\tor_phy_reg(pi, 0x44a, 0x44);\n\twrite_phy_reg(pi, 0x44a, 0x80);\n\n\twlc_lcnphy_radio_2064_channel_tune_4313(pi, channel);\n\tudelay(1000);\n\n\twlc_lcnphy_toggle_afe_pwdn(pi);\n\n\twrite_phy_reg(pi, 0x657, lcnphy_sfo_cfg[channel - 1].ptcentreTs20);\n\twrite_phy_reg(pi, 0x658, lcnphy_sfo_cfg[channel - 1].ptcentreFactor);\n\n\tif (CHSPEC_CHANNEL(pi->radio_chanspec) == 14) {\n\t\tmod_phy_reg(pi, 0x448, (0x3 << 8), (2) << 8);\n\n\t\twlc_lcnphy_load_tx_iir_filter(pi, false, 3);\n\t} else {\n\t\tmod_phy_reg(pi, 0x448, (0x3 << 8), (1) << 8);\n\n\t\twlc_lcnphy_load_tx_iir_filter(pi, false, 2);\n\t}\n\n\tif (pi->sh->boardflags & BFL_FEM)\n\t\twlc_lcnphy_load_tx_iir_filter(pi, true, 0);\n\telse\n\t\twlc_lcnphy_load_tx_iir_filter(pi, true, 3);\n\n\tmod_phy_reg(pi, 0x4eb, (0x7 << 3), (1) << 3);\n\tif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi))\n\t\twlc_lcnphy_tssi_setup(pi);\n}\n\nvoid wlc_phy_detach_lcnphy(struct brcms_phy *pi)\n{\n\tkfree(pi->u.pi_lcnphy);\n}\n\nbool wlc_phy_attach_lcnphy(struct brcms_phy *pi)\n{\n\tstruct brcms_phy_lcnphy *pi_lcn;\n\n\tpi->u.pi_lcnphy = kzalloc(sizeof(struct brcms_phy_lcnphy), GFP_ATOMIC);\n\tif (pi->u.pi_lcnphy == NULL)\n\t\treturn false;\n\n\tpi_lcn = pi->u.pi_lcnphy;\n\n\tif (0 == (pi->sh->boardflags & BFL_NOPA)) {\n\t\tpi->hwpwrctrl = true;\n\t\tpi->hwpwrctrl_capable = true;\n\t}\n\n\tpi->xtalfreq = bcma_chipco_get_alp_clock(&pi->d11core->bus->drv_cc);\n\tpi_lcn->lcnphy_papd_rxGnCtrl_init = 0;\n\n\tpi->pi_fptr.init = wlc_phy_init_lcnphy;\n\tpi->pi_fptr.calinit = wlc_phy_cal_init_lcnphy;\n\tpi->pi_fptr.chanset = wlc_phy_chanspec_set_lcnphy;\n\tpi->pi_fptr.txpwrrecalc = wlc_phy_txpower_recalc_target_lcnphy;\n\tpi->pi_fptr.txiqccget = wlc_lcnphy_get_tx_iqcc;\n\tpi->pi_fptr.txiqccset = wlc_lcnphy_set_tx_iqcc;\n\tpi->pi_fptr.txloccget = wlc_lcnphy_get_tx_locc;\n\tpi->pi_fptr.radioloftget = wlc_lcnphy_get_radio_loft;\n\tpi->pi_fptr.detach = wlc_phy_detach_lcnphy;\n\n\tif (!wlc_phy_txpwr_srom_read_lcnphy(pi)) {\n\t\tkfree(pi->u.pi_lcnphy);\n\t\treturn false;\n\t}\n\n\tif (LCNREV_IS(pi->pubpi.phy_rev, 1)) {\n\t\tif (pi_lcn->lcnphy_tempsense_option == 3) {\n\t\t\tpi->hwpwrctrl = true;\n\t\t\tpi->hwpwrctrl_capable = true;\n\t\t\tpi->temppwrctrl_capable = false;\n\t\t} else {\n\t\t\tpi->hwpwrctrl = false;\n\t\t\tpi->hwpwrctrl_capable = false;\n\t\t\tpi->temppwrctrl_capable = true;\n\t\t}\n\t}\n\n\treturn true;\n}\n\nstatic void wlc_lcnphy_set_rx_gain(struct brcms_phy *pi, u32 gain)\n{\n\tu16 trsw, ext_lna, lna1, lna2, tia, biq0, biq1, gain0_15, gain16_19;\n\n\ttrsw = (gain & ((u32) 1 << 28)) ? 0 : 1;\n\text_lna = (u16) (gain >> 29) & 0x01;\n\tlna1 = (u16) (gain >> 0) & 0x0f;\n\tlna2 = (u16) (gain >> 4) & 0x0f;\n\ttia = (u16) (gain >> 8) & 0xf;\n\tbiq0 = (u16) (gain >> 12) & 0xf;\n\tbiq1 = (u16) (gain >> 16) & 0xf;\n\n\tgain0_15 = (u16) ((lna1 & 0x3) | ((lna1 & 0x3) << 2) |\n\t\t\t  ((lna2 & 0x3) << 4) | ((lna2 & 0x3) << 6) |\n\t\t\t  ((tia & 0xf) << 8) | ((biq0 & 0xf) << 12));\n\tgain16_19 = biq1;\n\n\tmod_phy_reg(pi, 0x44d, (0x1 << 0), trsw << 0);\n\tmod_phy_reg(pi, 0x4b1, (0x1 << 9), ext_lna << 9);\n\tmod_phy_reg(pi, 0x4b1, (0x1 << 10), ext_lna << 10);\n\tmod_phy_reg(pi, 0x4b6, (0xffff << 0), gain0_15 << 0);\n\tmod_phy_reg(pi, 0x4b7, (0xf << 0), gain16_19 << 0);\n\n\tif (CHSPEC_IS2G(pi->radio_chanspec)) {\n\t\tmod_phy_reg(pi, 0x4b1, (0x3 << 11), lna1 << 11);\n\t\tmod_phy_reg(pi, 0x4e6, (0x3 << 3), lna1 << 3);\n\t}\n\twlc_lcnphy_rx_gain_override_enable(pi, true);\n}\n\nstatic u32 wlc_lcnphy_get_receive_power(struct brcms_phy *pi, s32 *gain_index)\n{\n\tu32 received_power = 0;\n\ts32 max_index = 0;\n\tu32 gain_code = 0;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\tmax_index = 36;\n\tif (*gain_index >= 0)\n\t\tgain_code = lcnphy_23bitgaincode_table[*gain_index];\n\n\tif (-1 == *gain_index) {\n\t\t*gain_index = 0;\n\t\twhile ((*gain_index <= (s32) max_index)\n\t\t       && (received_power < 700)) {\n\t\t\twlc_lcnphy_set_rx_gain(pi,\n\t\t\t\t\t       lcnphy_23bitgaincode_table\n\t\t\t\t\t       [*gain_index]);\n\t\t\treceived_power =\n\t\t\t\twlc_lcnphy_measure_digital_power(\n\t\t\t\t\tpi,\n\t\t\t\t\tpi_lcn->\n\t\t\t\t\tlcnphy_noise_samples);\n\t\t\t(*gain_index)++;\n\t\t}\n\t\t(*gain_index)--;\n\t} else {\n\t\twlc_lcnphy_set_rx_gain(pi, gain_code);\n\t\treceived_power =\n\t\t\twlc_lcnphy_measure_digital_power(pi,\n\t\t\t\t\t\t\t pi_lcn->\n\t\t\t\t\t\t\t lcnphy_noise_samples);\n\t}\n\n\treturn received_power;\n}\n\ns32 wlc_lcnphy_rx_signal_power(struct brcms_phy *pi, s32 gain_index)\n{\n\ts32 gain = 0;\n\ts32 nominal_power_db;\n\ts32 log_val, gain_mismatch, desired_gain, input_power_offset_db,\n\t    input_power_db;\n\ts32 received_power, temperature;\n\tu32 power;\n\tu32 msb1, msb2, val1, val2, diff1, diff2;\n\tuint freq;\n\tstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\n\n\treceived_power = wlc_lcnphy_get_receive_power(pi, &gain_index);\n\n\tgain = lcnphy_gain_table[gain_index];\n\n\tnominal_power_db = read_phy_reg(pi, 0x425) >> 8;\n\n\tpower = (received_power * 16);\n\tmsb1 = ffs(power) - 1;\n\tmsb2 = msb1 + 1;\n\tval1 = 1 << msb1;\n\tval2 = 1 << msb2;\n\tdiff1 = (power - val1);\n\tdiff2 = (val2 - power);\n\tif (diff1 < diff2)\n\t\tlog_val = msb1;\n\telse\n\t\tlog_val = msb2;\n\n\tlog_val = log_val * 3;\n\n\tgain_mismatch = (nominal_power_db / 2) - (log_val);\n\n\tdesired_gain = gain + gain_mismatch;\n\n\tinput_power_offset_db = read_phy_reg(pi, 0x434) & 0xFF;\n\n\tif (input_power_offset_db > 127)\n\t\tinput_power_offset_db -= 256;\n\n\tinput_power_db = input_power_offset_db - desired_gain;\n\n\tinput_power_db =\n\t\tinput_power_db + lcnphy_gain_index_offset_for_rssi[gain_index];\n\n\tfreq = wlc_phy_channel2freq(CHSPEC_CHANNEL(pi->radio_chanspec));\n\tif ((freq > 2427) && (freq <= 2467))\n\t\tinput_power_db = input_power_db - 1;\n\n\ttemperature = pi_lcn->lcnphy_lastsensed_temperature;\n\n\tif ((temperature - 15) < -30)\n\t\tinput_power_db =\n\t\t\tinput_power_db +\n\t\t\t(((temperature - 10 - 25) * 286) >> 12) -\n\t\t\t7;\n\telse if ((temperature - 15) < 4)\n\t\tinput_power_db =\n\t\t\tinput_power_db +\n\t\t\t(((temperature - 10 - 25) * 286) >> 12) -\n\t\t\t3;\n\telse\n\t\tinput_power_db = input_power_db +\n\t\t\t\t\t(((temperature - 10 - 25) * 286) >> 12);\n\n\twlc_lcnphy_rx_gain_override_enable(pi, 0);\n\n\treturn input_power_db;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}