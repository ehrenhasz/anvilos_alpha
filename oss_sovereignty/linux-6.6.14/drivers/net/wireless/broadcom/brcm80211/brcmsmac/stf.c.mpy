{
  "module_name": "stf.c",
  "hash_id": "e53bd396af9854dbeb493683808f1f4a89e3ebebacdf97b34cd4a5ec6702f5c3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/brcm80211/brcmsmac/stf.c",
  "human_readable_source": " \n\n#include <net/mac80211.h>\n\n#include \"types.h\"\n#include \"d11.h\"\n#include \"rate.h\"\n#include \"phy/phy_hal.h\"\n#include \"channel.h\"\n#include \"main.h\"\n#include \"stf.h\"\n#include \"debug.h\"\n\n#define MIN_SPATIAL_EXPANSION\t0\n#define MAX_SPATIAL_EXPANSION\t1\n\n#define BRCMS_STF_SS_STBC_RX(wlc) (BRCMS_ISNPHY(wlc->band) && \\\n\tNREV_GT(wlc->band->phyrev, 3) && NREV_LE(wlc->band->phyrev, 6))\n\n#define NSTS_1\t1\n#define NSTS_2\t2\n#define NSTS_3\t3\n#define NSTS_4\t4\n\nstatic const u8 txcore_default[5] = {\n\t(0),\t\t\t \n\t(0x01),\t\t\t \n\t(0x03),\t\t\t \n\t(0x07),\t\t\t \n\t(0x0f)\t\t\t \n};\n\nstatic void brcms_c_stf_stbc_rx_ht_update(struct brcms_c_info *wlc, int val)\n{\n\t \n\tif (BRCMS_STF_SS_STBC_RX(wlc)) {\n\t\tif ((wlc->stf->rxstreams == 1) && (val != HT_CAP_RX_STBC_NO))\n\t\t\treturn;\n\t}\n\n\tif (wlc->pub->up) {\n\t\tbrcms_c_update_beacon(wlc);\n\t\tbrcms_c_update_probe_resp(wlc, true);\n\t}\n}\n\n \nvoid brcms_c_tempsense_upd(struct brcms_c_info *wlc)\n{\n\tstruct brcms_phy_pub *pi = wlc->band->pi;\n\tuint active_chains, txchain;\n\n\t \n\t \n\tactive_chains = wlc_phy_stf_chain_active_get(pi);\n\ttxchain = active_chains & 0xf;\n\n\tif (wlc->stf->txchain == wlc->stf->hw_txchain) {\n\t\tif (txchain && (txchain < wlc->stf->hw_txchain))\n\t\t\t \n\t\t\tbrcms_c_stf_txchain_set(wlc, txchain, true);\n\t} else if (wlc->stf->txchain < wlc->stf->hw_txchain) {\n\t\tif (txchain == wlc->stf->hw_txchain)\n\t\t\t \n\t\t\tbrcms_c_stf_txchain_set(wlc, txchain, true);\n\t}\n}\n\nvoid\nbrcms_c_stf_ss_algo_channel_get(struct brcms_c_info *wlc, u16 *ss_algo_channel,\n\t\t\t    u16 chanspec)\n{\n\tstruct tx_power power = { };\n\tu8 siso_mcs_id, cdd_mcs_id, stbc_mcs_id;\n\n\t \n\t*ss_algo_channel = 0;\n\n\tif (!wlc->pub->up) {\n\t\t*ss_algo_channel = (u16) -1;\n\t\treturn;\n\t}\n\n\twlc_phy_txpower_get_current(wlc->band->pi, &power,\n\t\t\t\t    CHSPEC_CHANNEL(chanspec));\n\n\tsiso_mcs_id = (CHSPEC_IS40(chanspec)) ?\n\t    WL_TX_POWER_MCS40_SISO_FIRST : WL_TX_POWER_MCS20_SISO_FIRST;\n\tcdd_mcs_id = (CHSPEC_IS40(chanspec)) ?\n\t    WL_TX_POWER_MCS40_CDD_FIRST : WL_TX_POWER_MCS20_CDD_FIRST;\n\tstbc_mcs_id = (CHSPEC_IS40(chanspec)) ?\n\t    WL_TX_POWER_MCS40_STBC_FIRST : WL_TX_POWER_MCS20_STBC_FIRST;\n\n\t \n\n\t \n\tif (power.target[siso_mcs_id] > (power.target[cdd_mcs_id] + 12))\n\t\tsetbit(ss_algo_channel, PHY_TXC1_MODE_SISO);\n\telse\n\t\tsetbit(ss_algo_channel, PHY_TXC1_MODE_CDD);\n\n\t \n\tif (power.target[siso_mcs_id] <= (power.target[stbc_mcs_id] + 12))\n\t\tsetbit(ss_algo_channel, PHY_TXC1_MODE_STBC);\n}\n\nstatic bool brcms_c_stf_stbc_tx_set(struct brcms_c_info *wlc, s32 int_val)\n{\n\tif ((int_val != AUTO) && (int_val != OFF) && (int_val != ON))\n\t\treturn false;\n\n\tif ((int_val == ON) && (wlc->stf->txstreams == 1))\n\t\treturn false;\n\n\twlc->bandstate[BAND_2G_INDEX]->band_stf_stbc_tx = (s8) int_val;\n\twlc->bandstate[BAND_5G_INDEX]->band_stf_stbc_tx = (s8) int_val;\n\n\treturn true;\n}\n\nbool brcms_c_stf_stbc_rx_set(struct brcms_c_info *wlc, s32 int_val)\n{\n\tif ((int_val != HT_CAP_RX_STBC_NO)\n\t    && (int_val != HT_CAP_RX_STBC_ONE_STREAM))\n\t\treturn false;\n\n\tif (BRCMS_STF_SS_STBC_RX(wlc)) {\n\t\tif ((int_val != HT_CAP_RX_STBC_NO)\n\t\t    && (wlc->stf->rxstreams == 1))\n\t\t\treturn false;\n\t}\n\n\tbrcms_c_stf_stbc_rx_ht_update(wlc, int_val);\n\treturn true;\n}\n\nstatic int brcms_c_stf_txcore_set(struct brcms_c_info *wlc, u8 Nsts,\n\t\t\t\t  u8 core_mask)\n{\n\tbrcms_dbg_ht(wlc->hw->d11core, \"wl%d: Nsts %d core_mask %x\\n\",\n\t\t     wlc->pub->unit, Nsts, core_mask);\n\n\tif (hweight8(core_mask) > wlc->stf->txstreams)\n\t\tcore_mask = 0;\n\n\tif ((hweight8(core_mask) == wlc->stf->txstreams) &&\n\t    ((core_mask & ~wlc->stf->txchain)\n\t     || !(core_mask & wlc->stf->txchain)))\n\t\tcore_mask = wlc->stf->txchain;\n\n\twlc->stf->txcore[Nsts] = core_mask;\n\t \n\tif (Nsts == 1) {\n\t\t \n\t\twlc->stf->phytxant = core_mask << PHY_TXC_ANT_SHIFT;\n\t\tbrcms_b_txant_set(wlc->hw, wlc->stf->phytxant);\n\t\tif (wlc->clk) {\n\t\t\tbrcms_c_suspend_mac_and_wait(wlc);\n\t\t\tbrcms_c_beacon_phytxctl_txant_upd(wlc, wlc->bcn_rspec);\n\t\t\tbrcms_c_enable_mac(wlc);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int brcms_c_stf_spatial_policy_set(struct brcms_c_info *wlc, int val)\n{\n\tint i;\n\tu8 core_mask = 0;\n\n\tbrcms_dbg_ht(wlc->hw->d11core, \"wl%d: val %x\\n\", wlc->pub->unit,\n\t\t     val);\n\n\twlc->stf->spatial_policy = (s8) val;\n\tfor (i = 1; i <= MAX_STREAMS_SUPPORTED; i++) {\n\t\tcore_mask = (val == MAX_SPATIAL_EXPANSION) ?\n\t\t    wlc->stf->txchain : txcore_default[i];\n\t\tbrcms_c_stf_txcore_set(wlc, (u8) i, core_mask);\n\t}\n\treturn 0;\n}\n\n \nstatic void _brcms_c_stf_phy_txant_upd(struct brcms_c_info *wlc)\n{\n\ts8 txant;\n\n\ttxant = (s8) wlc->stf->txant;\n\tif (BRCMS_PHY_11N_CAP(wlc->band)) {\n\t\tif (txant == ANT_TX_FORCE_0) {\n\t\t\twlc->stf->phytxant = PHY_TXC_ANT_0;\n\t\t} else if (txant == ANT_TX_FORCE_1) {\n\t\t\twlc->stf->phytxant = PHY_TXC_ANT_1;\n\n\t\t\tif (BRCMS_ISNPHY(wlc->band) &&\n\t\t\t    NREV_GE(wlc->band->phyrev, 3)\n\t\t\t    && NREV_LT(wlc->band->phyrev, 7))\n\t\t\t\twlc->stf->phytxant = PHY_TXC_ANT_2;\n\t\t} else {\n\t\t\tif (BRCMS_ISLCNPHY(wlc->band) ||\n\t\t\t    BRCMS_ISSSLPNPHY(wlc->band))\n\t\t\t\twlc->stf->phytxant = PHY_TXC_LCNPHY_ANT_LAST;\n\t\t\telse {\n\t\t\t\t \n\t\t\t\tWARN_ON(wlc->stf->txchain <= 0);\n\t\t\t\twlc->stf->phytxant =\n\t\t\t\t    wlc->stf->txchain << PHY_TXC_ANT_SHIFT;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tif (txant == ANT_TX_FORCE_0)\n\t\t\twlc->stf->phytxant = PHY_TXC_OLD_ANT_0;\n\t\telse if (txant == ANT_TX_FORCE_1)\n\t\t\twlc->stf->phytxant = PHY_TXC_OLD_ANT_1;\n\t\telse\n\t\t\twlc->stf->phytxant = PHY_TXC_OLD_ANT_LAST;\n\t}\n\n\tbrcms_b_txant_set(wlc->hw, wlc->stf->phytxant);\n}\n\nint brcms_c_stf_txchain_set(struct brcms_c_info *wlc, s32 int_val, bool force)\n{\n\tu8 txchain = (u8) int_val;\n\tu8 txstreams;\n\tuint i;\n\n\tif (wlc->stf->txchain == txchain)\n\t\treturn 0;\n\n\tif ((txchain & ~wlc->stf->hw_txchain)\n\t    || !(txchain & wlc->stf->hw_txchain))\n\t\treturn -EINVAL;\n\n\t \n\ttxstreams = (u8) hweight8(txchain);\n\tif (txstreams > MAX_STREAMS_SUPPORTED)\n\t\treturn -EINVAL;\n\n\twlc->stf->txchain = txchain;\n\twlc->stf->txstreams = txstreams;\n\tbrcms_c_stf_stbc_tx_set(wlc, wlc->band->band_stf_stbc_tx);\n\tbrcms_c_stf_ss_update(wlc, wlc->bandstate[BAND_2G_INDEX]);\n\tbrcms_c_stf_ss_update(wlc, wlc->bandstate[BAND_5G_INDEX]);\n\twlc->stf->txant =\n\t    (wlc->stf->txstreams == 1) ? ANT_TX_FORCE_0 : ANT_TX_DEF;\n\t_brcms_c_stf_phy_txant_upd(wlc);\n\n\twlc_phy_stf_chain_set(wlc->band->pi, wlc->stf->txchain,\n\t\t\t      wlc->stf->rxchain);\n\n\tfor (i = 1; i <= MAX_STREAMS_SUPPORTED; i++)\n\t\tbrcms_c_stf_txcore_set(wlc, (u8) i, txcore_default[i]);\n\n\treturn 0;\n}\n\n \nvoid brcms_c_stf_ss_update(struct brcms_c_info *wlc, struct brcms_band *band)\n{\n\tu8 prev_stf_ss;\n\tu8 upd_stf_ss;\n\n\tprev_stf_ss = wlc->stf->ss_opmode;\n\n\t \n\tif (BRCMS_STBC_CAP_PHY(wlc) &&\n\t    wlc->stf->ss_algosel_auto\n\t    && (wlc->stf->ss_algo_channel != (u16) -1)) {\n\t\tupd_stf_ss = (wlc->stf->txstreams == 1 ||\n\t\t\t      isset(&wlc->stf->ss_algo_channel,\n\t\t\t\t    PHY_TXC1_MODE_SISO)) ?\n\t\t\t\t    PHY_TXC1_MODE_SISO : PHY_TXC1_MODE_CDD;\n\t} else {\n\t\tif (wlc->band != band)\n\t\t\treturn;\n\t\tupd_stf_ss = (wlc->stf->txstreams == 1) ?\n\t\t\t\tPHY_TXC1_MODE_SISO : band->band_stf_ss_mode;\n\t}\n\tif (prev_stf_ss != upd_stf_ss) {\n\t\twlc->stf->ss_opmode = upd_stf_ss;\n\t\tbrcms_b_band_stf_ss_set(wlc->hw, upd_stf_ss);\n\t}\n}\n\nint brcms_c_stf_attach(struct brcms_c_info *wlc)\n{\n\twlc->bandstate[BAND_2G_INDEX]->band_stf_ss_mode = PHY_TXC1_MODE_SISO;\n\twlc->bandstate[BAND_5G_INDEX]->band_stf_ss_mode = PHY_TXC1_MODE_CDD;\n\n\tif (BRCMS_ISNPHY(wlc->band) &&\n\t    (wlc_phy_txpower_hw_ctrl_get(wlc->band->pi) != PHY_TPC_HW_ON))\n\t\twlc->bandstate[BAND_2G_INDEX]->band_stf_ss_mode =\n\t\t    PHY_TXC1_MODE_CDD;\n\tbrcms_c_stf_ss_update(wlc, wlc->bandstate[BAND_2G_INDEX]);\n\tbrcms_c_stf_ss_update(wlc, wlc->bandstate[BAND_5G_INDEX]);\n\n\tbrcms_c_stf_stbc_rx_ht_update(wlc, HT_CAP_RX_STBC_NO);\n\twlc->bandstate[BAND_2G_INDEX]->band_stf_stbc_tx = OFF;\n\twlc->bandstate[BAND_5G_INDEX]->band_stf_stbc_tx = OFF;\n\n\tif (BRCMS_STBC_CAP_PHY(wlc)) {\n\t\twlc->stf->ss_algosel_auto = true;\n\t\t \n\t\twlc->stf->ss_algo_channel = (u16) -1;\n\t}\n\treturn 0;\n}\n\nvoid brcms_c_stf_detach(struct brcms_c_info *wlc)\n{\n}\n\nvoid brcms_c_stf_phy_txant_upd(struct brcms_c_info *wlc)\n{\n\t_brcms_c_stf_phy_txant_upd(wlc);\n}\n\nvoid brcms_c_stf_phy_chain_calc(struct brcms_c_info *wlc)\n{\n\tstruct ssb_sprom *sprom = &wlc->hw->d11core->bus->sprom;\n\n\t \n\twlc->stf->hw_txchain = sprom->txchain;\n\twlc->stf->hw_rxchain = sprom->rxchain;\n\n\t \n\tif (wlc->stf->hw_txchain == 0 || wlc->stf->hw_txchain == 0xf) {\n\t\tif (BRCMS_ISNPHY(wlc->band))\n\t\t\twlc->stf->hw_txchain = TXCHAIN_DEF_NPHY;\n\t\telse\n\t\t\twlc->stf->hw_txchain = TXCHAIN_DEF;\n\t}\n\n\twlc->stf->txchain = wlc->stf->hw_txchain;\n\twlc->stf->txstreams = (u8) hweight8(wlc->stf->hw_txchain);\n\n\tif (wlc->stf->hw_rxchain == 0 || wlc->stf->hw_rxchain == 0xf) {\n\t\tif (BRCMS_ISNPHY(wlc->band))\n\t\t\twlc->stf->hw_rxchain = RXCHAIN_DEF_NPHY;\n\t\telse\n\t\t\twlc->stf->hw_rxchain = RXCHAIN_DEF;\n\t}\n\n\twlc->stf->rxchain = wlc->stf->hw_rxchain;\n\twlc->stf->rxstreams = (u8) hweight8(wlc->stf->hw_rxchain);\n\n\t \n\tmemcpy(wlc->stf->txcore, txcore_default, sizeof(wlc->stf->txcore));\n\n\t \n\twlc->stf->spatial_policy = MIN_SPATIAL_EXPANSION;\n\tbrcms_c_stf_spatial_policy_set(wlc, MIN_SPATIAL_EXPANSION);\n}\n\nstatic u16 _brcms_c_stf_phytxchain_sel(struct brcms_c_info *wlc,\n\t\t\t\t       u32 rspec)\n{\n\tu16 phytxant = wlc->stf->phytxant;\n\n\tif (rspec_stf(rspec) != PHY_TXC1_MODE_SISO)\n\t\tphytxant = wlc->stf->txchain << PHY_TXC_ANT_SHIFT;\n\telse if (wlc->stf->txant == ANT_TX_DEF)\n\t\tphytxant = wlc->stf->txchain << PHY_TXC_ANT_SHIFT;\n\tphytxant &= PHY_TXC_ANT_MASK;\n\treturn phytxant;\n}\n\nu16 brcms_c_stf_phytxchain_sel(struct brcms_c_info *wlc, u32 rspec)\n{\n\treturn _brcms_c_stf_phytxchain_sel(wlc, rspec);\n}\n\nu16 brcms_c_stf_d11hdrs_phyctl_txant(struct brcms_c_info *wlc, u32 rspec)\n{\n\tu16 phytxant = wlc->stf->phytxant;\n\tu16 mask = PHY_TXC_ANT_MASK;\n\n\t \n\tif (BRCMS_ISNPHY(wlc->band)) {\n\t\tphytxant = _brcms_c_stf_phytxchain_sel(wlc, rspec);\n\t\tmask = PHY_TXC_HTANT_MASK;\n\t}\n\tphytxant |= phytxant & mask;\n\treturn phytxant;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}