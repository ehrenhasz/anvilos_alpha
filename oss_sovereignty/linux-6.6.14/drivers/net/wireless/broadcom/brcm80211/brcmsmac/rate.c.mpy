{
  "module_name": "rate.c",
  "hash_id": "51f67f9c5cc95dc28d7760a947af69dea83203ca1a1cc2b0c307fb761448fb0c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/broadcom/brcm80211/brcmsmac/rate.c",
  "human_readable_source": " \n\n#include <brcmu_wifi.h>\n#include <brcmu_utils.h>\n\n#include \"d11.h\"\n#include \"pub.h\"\n#include \"rate.h\"\n\n \nconst u8 rate_info[BRCM_MAXRATE + 1] = {\n\t \n  0x00, 0x00, 0x0a, 0x00, 0x14, 0x00, 0x00, 0x00, 0x00, 0x00,\n  0x00, 0x37, 0x8b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8f, 0x00,\n  0x00, 0x00, 0x6e, 0x00, 0x8a, 0x00, 0x00, 0x00, 0x00, 0x00,\n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8e, 0x00, 0x00, 0x00,\n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x89, 0x00,\n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n  0x00, 0x00, 0x8d, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x88, 0x00, 0x00, 0x00,\n  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x8c\n};\n\n \nconst struct brcms_mcs_info mcs_table[MCS_TABLE_SIZE] = {\n\t \n\t{6500, 13500, CEIL(6500 * 10, 9), CEIL(13500 * 10, 9), 0x00,\n\t BRCM_RATE_6M},\n\t \n\t{13000, 27000, CEIL(13000 * 10, 9), CEIL(27000 * 10, 9), 0x08,\n\t BRCM_RATE_12M},\n\t \n\t{19500, 40500, CEIL(19500 * 10, 9), CEIL(40500 * 10, 9), 0x0A,\n\t BRCM_RATE_18M},\n\t \n\t{26000, 54000, CEIL(26000 * 10, 9), CEIL(54000 * 10, 9), 0x10,\n\t BRCM_RATE_24M},\n\t \n\t{39000, 81000, CEIL(39000 * 10, 9), CEIL(81000 * 10, 9), 0x12,\n\t BRCM_RATE_36M},\n\t \n\t{52000, 108000, CEIL(52000 * 10, 9), CEIL(108000 * 10, 9), 0x19,\n\t BRCM_RATE_48M},\n\t \n\t{58500, 121500, CEIL(58500 * 10, 9), CEIL(121500 * 10, 9), 0x1A,\n\t BRCM_RATE_54M},\n\t \n\t{65000, 135000, CEIL(65000 * 10, 9), CEIL(135000 * 10, 9), 0x1C,\n\t BRCM_RATE_54M},\n\t \n\t{13000, 27000, CEIL(13000 * 10, 9), CEIL(27000 * 10, 9), 0x40,\n\t BRCM_RATE_6M},\n\t \n\t{26000, 54000, CEIL(26000 * 10, 9), CEIL(54000 * 10, 9), 0x48,\n\t BRCM_RATE_12M},\n\t \n\t{39000, 81000, CEIL(39000 * 10, 9), CEIL(81000 * 10, 9), 0x4A,\n\t BRCM_RATE_18M},\n\t \n\t{52000, 108000, CEIL(52000 * 10, 9), CEIL(108000 * 10, 9), 0x50,\n\t BRCM_RATE_24M},\n\t \n\t{78000, 162000, CEIL(78000 * 10, 9), CEIL(162000 * 10, 9), 0x52,\n\t BRCM_RATE_36M},\n\t \n\t{104000, 216000, CEIL(104000 * 10, 9), CEIL(216000 * 10, 9), 0x59,\n\t BRCM_RATE_48M},\n\t \n\t{117000, 243000, CEIL(117000 * 10, 9), CEIL(243000 * 10, 9), 0x5A,\n\t BRCM_RATE_54M},\n\t \n\t{130000, 270000, CEIL(130000 * 10, 9), CEIL(270000 * 10, 9), 0x5C,\n\t BRCM_RATE_54M},\n\t \n\t{19500, 40500, CEIL(19500 * 10, 9), CEIL(40500 * 10, 9), 0x80,\n\t BRCM_RATE_6M},\n\t \n\t{39000, 81000, CEIL(39000 * 10, 9), CEIL(81000 * 10, 9), 0x88,\n\t BRCM_RATE_12M},\n\t \n\t{58500, 121500, CEIL(58500 * 10, 9), CEIL(121500 * 10, 9), 0x8A,\n\t BRCM_RATE_18M},\n\t \n\t{78000, 162000, CEIL(78000 * 10, 9), CEIL(162000 * 10, 9), 0x90,\n\t BRCM_RATE_24M},\n\t \n\t{117000, 243000, CEIL(117000 * 10, 9), CEIL(243000 * 10, 9), 0x92,\n\t BRCM_RATE_36M},\n\t \n\t{156000, 324000, CEIL(156000 * 10, 9), CEIL(324000 * 10, 9), 0x99,\n\t BRCM_RATE_48M},\n\t \n\t{175500, 364500, CEIL(175500 * 10, 9), CEIL(364500 * 10, 9), 0x9A,\n\t BRCM_RATE_54M},\n\t \n\t{195000, 405000, CEIL(195000 * 10, 9), CEIL(405000 * 10, 9), 0x9B,\n\t BRCM_RATE_54M},\n\t \n\t{26000, 54000, CEIL(26000 * 10, 9), CEIL(54000 * 10, 9), 0xC0,\n\t BRCM_RATE_6M},\n\t \n\t{52000, 108000, CEIL(52000 * 10, 9), CEIL(108000 * 10, 9), 0xC8,\n\t BRCM_RATE_12M},\n\t \n\t{78000, 162000, CEIL(78000 * 10, 9), CEIL(162000 * 10, 9), 0xCA,\n\t BRCM_RATE_18M},\n\t \n\t{104000, 216000, CEIL(104000 * 10, 9), CEIL(216000 * 10, 9), 0xD0,\n\t BRCM_RATE_24M},\n\t \n\t{156000, 324000, CEIL(156000 * 10, 9), CEIL(324000 * 10, 9), 0xD2,\n\t BRCM_RATE_36M},\n\t \n\t{208000, 432000, CEIL(208000 * 10, 9), CEIL(432000 * 10, 9), 0xD9,\n\t BRCM_RATE_48M},\n\t \n\t{234000, 486000, CEIL(234000 * 10, 9), CEIL(486000 * 10, 9), 0xDA,\n\t BRCM_RATE_54M},\n\t \n\t{260000, 540000, CEIL(260000 * 10, 9), CEIL(540000 * 10, 9), 0xDB,\n\t BRCM_RATE_54M},\n\t \n\t{0, 6000, 0, CEIL(6000 * 10, 9), 0x00, BRCM_RATE_6M},\n};\n\n \nstruct legacy_phycfg {\n\tu32 rate_ofdm;\t \n\t \n\tu8 tx_phy_ctl3;\n};\n\n \n#define LEGACY_PHYCFG_TABLE_SIZE\t12\n\n \nstatic const struct\nlegacy_phycfg legacy_phycfg_table[LEGACY_PHYCFG_TABLE_SIZE] = {\n\t{BRCM_RATE_1M, 0x00},\t \n\t{BRCM_RATE_2M, 0x08},\t \n\t{BRCM_RATE_5M5, 0x10},\t \n\t{BRCM_RATE_11M, 0x18},\t \n\t \n\t{BRCM_RATE_6M, 0x00},\n\t \n\t{BRCM_RATE_9M, 0x02},\n\t \n\t{BRCM_RATE_12M, 0x08},\n\t \n\t{BRCM_RATE_18M, 0x0A},\n\t \n\t{BRCM_RATE_24M, 0x10},\n\t \n\t{BRCM_RATE_36M, 0x12},\n\t \n\t{BRCM_RATE_48M, 0x19},\n\t \n\t{BRCM_RATE_54M, 0x1A},\n};\n\n \n\nconst struct brcms_c_rateset cck_ofdm_mimo_rates = {\n\t12,\n\t \n\t{ 0x82, 0x84, 0x8b, 0x0c, 0x12, 0x96, 0x18, 0x24, 0x30, 0x48, 0x60,\n\t \n\t  0x6c},\n\t0x00,\n\t{ 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t  0x00, 0x00, 0x00, 0x00, 0x00}\n};\n\nconst struct brcms_c_rateset ofdm_mimo_rates = {\n\t8,\n\t \n\t{ 0x8c, 0x12, 0x98, 0x24, 0xb0, 0x48, 0x60, 0x6c},\n\t0x00,\n\t{ 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t  0x00, 0x00, 0x00, 0x00, 0x00}\n};\n\n \nstatic const struct brcms_c_rateset cck_ofdm_40bw_mimo_rates = {\n\t12,\n\t \n\t{ 0x82, 0x84, 0x8b, 0x0c, 0x12, 0x96, 0x18, 0x24, 0x30, 0x48, 0x60,\n\t \n\t  0x6c},\n\t0x00,\n\t{ 0xff, 0xff, 0xff, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t  0x00, 0x00, 0x00, 0x00, 0x00}\n};\n\nstatic const struct brcms_c_rateset ofdm_40bw_mimo_rates = {\n\t8,\n\t \n\t{ 0x8c, 0x12, 0x98, 0x24, 0xb0, 0x48, 0x60, 0x6c},\n\t0x00,\n\t{ 0xff, 0xff, 0xff, 0xff, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t  0x00, 0x00, 0x00, 0x00, 0x00}\n};\n\nconst struct brcms_c_rateset cck_ofdm_rates = {\n\t12,\n\t \n\t{ 0x82, 0x84, 0x8b, 0x0c, 0x12, 0x96, 0x18, 0x24, 0x30, 0x48, 0x60,\n\t \n\t  0x6c},\n\t0x00,\n\t{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t  0x00, 0x00, 0x00, 0x00, 0x00}\n};\n\nconst struct brcms_c_rateset gphy_legacy_rates = {\n\t4,\n\t \n\t{ 0x82, 0x84, 0x8b, 0x96},\n\t0x00,\n\t{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t  0x00, 0x00, 0x00, 0x00, 0x00}\n};\n\nconst struct brcms_c_rateset ofdm_rates = {\n\t8,\n\t \n\t{ 0x8c, 0x12, 0x98, 0x24, 0xb0, 0x48, 0x60, 0x6c},\n\t0x00,\n\t{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t  0x00, 0x00, 0x00, 0x00, 0x00}\n};\n\nconst struct brcms_c_rateset cck_rates = {\n\t4,\n\t \n\t{ 0x82, 0x84, 0x0b, 0x16},\n\t0x00,\n\t{ 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t  0x00, 0x00, 0x00, 0x00, 0x00}\n};\n\n \nstatic bool brcms_c_rateset_valid(struct brcms_c_rateset *rs, bool check_brate)\n{\n\tuint idx;\n\n\tif (!rs->count)\n\t\treturn false;\n\n\tif (!check_brate)\n\t\treturn true;\n\n\t \n\tfor (idx = 0; idx < rs->count; idx++) {\n\t\tif (rs->rates[idx] & BRCMS_RATE_FLAG)\n\t\t\treturn true;\n\t}\n\treturn false;\n}\n\nvoid brcms_c_rateset_mcs_upd(struct brcms_c_rateset *rs, u8 txstreams)\n{\n\tint i;\n\tfor (i = txstreams; i < MAX_STREAMS_SUPPORTED; i++)\n\t\trs->mcs[i] = 0;\n}\n\n \nbool\nbrcms_c_rate_hwrs_filter_sort_validate(struct brcms_c_rateset *rs,\n\t\t\t\t   const struct brcms_c_rateset *hw_rs,\n\t\t\t\t   bool check_brate, u8 txstreams)\n{\n\tu8 rateset[BRCM_MAXRATE + 1];\n\tu8 r;\n\tuint count;\n\tuint i;\n\n\tmemset(rateset, 0, sizeof(rateset));\n\tcount = rs->count;\n\n\tfor (i = 0; i < count; i++) {\n\t\t \n\t\tr = (int)rs->rates[i] & BRCMS_RATE_MASK;\n\t\tif ((r > BRCM_MAXRATE) || (rate_info[r] == 0))\n\t\t\tcontinue;\n\t\trateset[r] = rs->rates[i];\t \n\t}\n\n\t \n\tcount = 0;\n\tfor (i = 0; i < hw_rs->count; i++) {\n\t\tr = hw_rs->rates[i] & BRCMS_RATE_MASK;\n\t\tif (rateset[r])\n\t\t\trs->rates[count++] = rateset[r];\n\t}\n\n\trs->count = count;\n\n\t \n\tfor (i = 0; i < MCSSET_LEN; i++)\n\t\trs->mcs[i] = (rs->mcs[i] & hw_rs->mcs[i]);\n\n\tif (brcms_c_rateset_valid(rs, check_brate))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\n \nu32 brcms_c_compute_rspec(struct d11rxhdr *rxh, u8 *plcp)\n{\n\tint phy_type;\n\tu32 rspec = PHY_TXC1_BW_20MHZ << RSPEC_BW_SHIFT;\n\n\tphy_type =\n\t    ((rxh->RxChan & RXS_CHAN_PHYTYPE_MASK) >> RXS_CHAN_PHYTYPE_SHIFT);\n\n\tif ((phy_type == PHY_TYPE_N) || (phy_type == PHY_TYPE_SSN) ||\n\t    (phy_type == PHY_TYPE_LCN) || (phy_type == PHY_TYPE_HT)) {\n\t\tswitch (rxh->PhyRxStatus_0 & PRXS0_FT_MASK) {\n\t\tcase PRXS0_CCK:\n\t\t\trspec =\n\t\t\t\tcck_phy2mac_rate(\n\t\t\t\t((struct cck_phy_hdr *) plcp)->signal);\n\t\t\tbreak;\n\t\tcase PRXS0_OFDM:\n\t\t\trspec =\n\t\t\t    ofdm_phy2mac_rate(\n\t\t\t\t((struct ofdm_phy_hdr *) plcp)->rlpt[0]);\n\t\t\tbreak;\n\t\tcase PRXS0_PREN:\n\t\t\trspec = (plcp[0] & MIMO_PLCP_MCS_MASK) | RSPEC_MIMORATE;\n\t\t\tif (plcp[0] & MIMO_PLCP_40MHZ) {\n\t\t\t\t \n\t\t\t\trspec &= ~RSPEC_BW_MASK;\n\t\t\t\trspec |= (PHY_TXC1_BW_40MHZ << RSPEC_BW_SHIFT);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase PRXS0_STDN:\n\t\t\t \n\t\tdefault:\n\t\t\t \n\t\t\tbreak;\n\t\t}\n\t\tif (plcp3_issgi(plcp[3]))\n\t\t\trspec |= RSPEC_SHORT_GI;\n\t} else\n\t    if ((phy_type == PHY_TYPE_A) || (rxh->PhyRxStatus_0 & PRXS0_OFDM))\n\t\trspec = ofdm_phy2mac_rate(\n\t\t\t\t((struct ofdm_phy_hdr *) plcp)->rlpt[0]);\n\telse\n\t\trspec = cck_phy2mac_rate(\n\t\t\t\t((struct cck_phy_hdr *) plcp)->signal);\n\n\treturn rspec;\n}\n\n \nvoid brcms_c_rateset_copy(const struct brcms_c_rateset *src,\n\t\t\t  struct brcms_c_rateset *dst)\n{\n\tmemcpy(dst, src, sizeof(struct brcms_c_rateset));\n}\n\n \nvoid\nbrcms_c_rateset_filter(struct brcms_c_rateset *src, struct brcms_c_rateset *dst,\n\t\t       bool basic_only, u8 rates, uint xmask, bool mcsallow)\n{\n\tuint i;\n\tuint r;\n\tuint count;\n\n\tcount = 0;\n\tfor (i = 0; i < src->count; i++) {\n\t\tr = src->rates[i];\n\t\tif (basic_only && !(r & BRCMS_RATE_FLAG))\n\t\t\tcontinue;\n\t\tif (rates == BRCMS_RATES_CCK &&\n\t\t    is_ofdm_rate((r & BRCMS_RATE_MASK)))\n\t\t\tcontinue;\n\t\tif (rates == BRCMS_RATES_OFDM &&\n\t\t    is_cck_rate((r & BRCMS_RATE_MASK)))\n\t\t\tcontinue;\n\t\tdst->rates[count++] = r & xmask;\n\t}\n\tdst->count = count;\n\tdst->htphy_membership = src->htphy_membership;\n\n\tif (mcsallow && rates != BRCMS_RATES_CCK)\n\t\tmemcpy(&dst->mcs[0], &src->mcs[0], MCSSET_LEN);\n\telse\n\t\tbrcms_c_rateset_mcs_clear(dst);\n}\n\n \nvoid\nbrcms_c_rateset_default(struct brcms_c_rateset *rs_tgt,\n\t\t\tconst struct brcms_c_rateset *rs_hw,\n\t\t\tuint phy_type, int bandtype, bool cck_only,\n\t\t\tuint rate_mask, bool mcsallow, u8 bw, u8 txstreams)\n{\n\tconst struct brcms_c_rateset *rs_dflt;\n\tstruct brcms_c_rateset rs_sel;\n\tif ((PHYTYPE_IS(phy_type, PHY_TYPE_HT)) ||\n\t    (PHYTYPE_IS(phy_type, PHY_TYPE_N)) ||\n\t    (PHYTYPE_IS(phy_type, PHY_TYPE_LCN)) ||\n\t    (PHYTYPE_IS(phy_type, PHY_TYPE_SSN))) {\n\t\tif (bandtype == BRCM_BAND_5G)\n\t\t\trs_dflt = (bw == BRCMS_20_MHZ ?\n\t\t\t\t   &ofdm_mimo_rates : &ofdm_40bw_mimo_rates);\n\t\telse\n\t\t\trs_dflt = (bw == BRCMS_20_MHZ ?\n\t\t\t\t   &cck_ofdm_mimo_rates :\n\t\t\t\t   &cck_ofdm_40bw_mimo_rates);\n\t} else if (PHYTYPE_IS(phy_type, PHY_TYPE_LP)) {\n\t\trs_dflt = (bandtype == BRCM_BAND_5G) ?\n\t\t\t  &ofdm_rates : &cck_ofdm_rates;\n\t} else if (PHYTYPE_IS(phy_type, PHY_TYPE_A)) {\n\t\trs_dflt = &ofdm_rates;\n\t} else if (PHYTYPE_IS(phy_type, PHY_TYPE_G)) {\n\t\trs_dflt = &cck_ofdm_rates;\n\t} else {\n\t\t \n\t\trs_dflt = &cck_rates;\t \n\t}\n\n\t \n\tif (!rs_hw)\n\t\trs_hw = rs_dflt;\n\n\tbrcms_c_rateset_copy(rs_dflt, &rs_sel);\n\tbrcms_c_rateset_mcs_upd(&rs_sel, txstreams);\n\tbrcms_c_rateset_filter(&rs_sel, rs_tgt, false,\n\t\t\t   cck_only ? BRCMS_RATES_CCK : BRCMS_RATES_CCK_OFDM,\n\t\t\t   rate_mask, mcsallow);\n\tbrcms_c_rate_hwrs_filter_sort_validate(rs_tgt, rs_hw, false,\n\t\t\t\t\t   mcsallow ? txstreams : 1);\n}\n\ns16 brcms_c_rate_legacy_phyctl(uint rate)\n{\n\tuint i;\n\tfor (i = 0; i < LEGACY_PHYCFG_TABLE_SIZE; i++)\n\t\tif (rate == legacy_phycfg_table[i].rate_ofdm)\n\t\t\treturn legacy_phycfg_table[i].tx_phy_ctl3;\n\n\treturn -1;\n}\n\nvoid brcms_c_rateset_mcs_clear(struct brcms_c_rateset *rateset)\n{\n\tuint i;\n\tfor (i = 0; i < MCSSET_LEN; i++)\n\t\trateset->mcs[i] = 0;\n}\n\nvoid brcms_c_rateset_mcs_build(struct brcms_c_rateset *rateset, u8 txstreams)\n{\n\tmemcpy(&rateset->mcs[0], &cck_ofdm_mimo_rates.mcs[0], MCSSET_LEN);\n\tbrcms_c_rateset_mcs_upd(rateset, txstreams);\n}\n\n \nvoid brcms_c_rateset_bw_mcs_filter(struct brcms_c_rateset *rateset, u8 bw)\n{\n\tif (bw == BRCMS_40_MHZ)\n\t\tsetbit(rateset->mcs, 32);\n\telse\n\t\tclrbit(rateset->mcs, 32);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}