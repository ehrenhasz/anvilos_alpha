{
  "module_name": "wil_crash_dump.c",
  "hash_id": "ddeb12043b66f7bf8780635562e8b6fdc8209ab7fd3ee14c85cc5fcf6260e888",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/wil6210/wil_crash_dump.c",
  "human_readable_source": "\n \n\n#include \"wil6210.h\"\n#include <linux/devcoredump.h>\n\nstatic int wil_fw_get_crash_dump_bounds(struct wil6210_priv *wil,\n\t\t\t\t\tu32 *out_dump_size, u32 *out_host_min)\n{\n\tint i;\n\tconst struct fw_map *map;\n\tu32 host_min, host_max, tmp_max;\n\n\tif (!out_dump_size)\n\t\treturn -EINVAL;\n\n\t \n\tBUILD_BUG_ON(ARRAY_SIZE(fw_mapping) == 0);\n\tmap = &fw_mapping[0];\n\thost_min = map->host;\n\thost_max = map->host + (map->to - map->from);\n\n\tfor (i = 1; i < ARRAY_SIZE(fw_mapping); i++) {\n\t\tmap = &fw_mapping[i];\n\n\t\tif (!map->crash_dump)\n\t\t\tcontinue;\n\n\t\tif (map->host < host_min)\n\t\t\thost_min = map->host;\n\n\t\ttmp_max = map->host + (map->to - map->from);\n\t\tif (tmp_max > host_max)\n\t\t\thost_max = tmp_max;\n\t}\n\n\t*out_dump_size = host_max - host_min;\n\tif (out_host_min)\n\t\t*out_host_min = host_min;\n\n\treturn 0;\n}\n\nint wil_fw_copy_crash_dump(struct wil6210_priv *wil, void *dest, u32 size)\n{\n\tint i;\n\tconst struct fw_map *map;\n\tvoid *data;\n\tu32 host_min, dump_size, offset, len;\n\n\tif (wil_fw_get_crash_dump_bounds(wil, &dump_size, &host_min)) {\n\t\twil_err(wil, \"fail to obtain crash dump size\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (dump_size > size) {\n\t\twil_err(wil, \"not enough space for dump. Need %d have %d\\n\",\n\t\t\tdump_size, size);\n\t\treturn -EINVAL;\n\t}\n\n\tdown_write(&wil->mem_lock);\n\n\tif (test_bit(wil_status_suspending, wil->status) ||\n\t    test_bit(wil_status_suspended, wil->status)) {\n\t\twil_err(wil,\n\t\t\t\"suspend/resume in progress. cannot copy crash dump\\n\");\n\t\tup_write(&wil->mem_lock);\n\t\treturn -EBUSY;\n\t}\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(fw_mapping); i++) {\n\t\tmap = &fw_mapping[i];\n\n\t\tif (!map->crash_dump)\n\t\t\tcontinue;\n\n\t\tdata = (void * __force)wil->csr + HOSTADDR(map->host);\n\t\tlen = map->to - map->from;\n\t\toffset = map->host - host_min;\n\n\t\twil_dbg_misc(wil,\n\t\t\t     \"fw_copy_crash_dump: - dump %s, size %d, offset %d\\n\",\n\t\t\t     fw_mapping[i].name, len, offset);\n\n\t\twil_memcpy_fromio_32((void * __force)(dest + offset),\n\t\t\t\t     (const void __iomem * __force)data, len);\n\t}\n\n\tup_write(&wil->mem_lock);\n\n\treturn 0;\n}\n\nvoid wil_fw_core_dump(struct wil6210_priv *wil)\n{\n\tvoid *fw_dump_data;\n\tu32 fw_dump_size;\n\n\tif (wil_fw_get_crash_dump_bounds(wil, &fw_dump_size, NULL)) {\n\t\twil_err(wil, \"fail to get fw dump size\\n\");\n\t\treturn;\n\t}\n\n\tfw_dump_data = vzalloc(fw_dump_size);\n\tif (!fw_dump_data)\n\t\treturn;\n\n\tif (wil_fw_copy_crash_dump(wil, fw_dump_data, fw_dump_size)) {\n\t\tvfree(fw_dump_data);\n\t\treturn;\n\t}\n\t \n\tdev_coredumpv(wil_to_dev(wil), fw_dump_data, fw_dump_size, GFP_KERNEL);\n\twil_info(wil, \"fw core dumped, size %d bytes\\n\", fw_dump_size);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}