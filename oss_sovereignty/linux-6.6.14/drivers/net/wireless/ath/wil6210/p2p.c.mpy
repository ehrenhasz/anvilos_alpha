{
  "module_name": "p2p.c",
  "hash_id": "156f305d4e76af19e29a8f4c38c21bf0bb58b0cd404f28e3ef2eb81cf5d57998",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/wil6210/p2p.c",
  "human_readable_source": "\n \n\n#include \"wil6210.h\"\n#include \"wmi.h\"\n\n#define P2P_WILDCARD_SSID \"DIRECT-\"\n#define P2P_DMG_SOCIAL_CHANNEL 2\n#define P2P_SEARCH_DURATION_MS 500\n#define P2P_DEFAULT_BI 100\n\nstatic int wil_p2p_start_listen(struct wil6210_vif *vif)\n{\n\tstruct wil6210_priv *wil = vif_to_wil(vif);\n\tstruct wil_p2p_info *p2p = &vif->p2p;\n\tu8 channel = p2p->listen_chan.hw_value;\n\tint rc;\n\n\tlockdep_assert_held(&wil->mutex);\n\n\trc = wmi_p2p_cfg(vif, channel, P2P_DEFAULT_BI);\n\tif (rc) {\n\t\twil_err(wil, \"wmi_p2p_cfg failed\\n\");\n\t\tgoto out;\n\t}\n\n\trc = wmi_set_ssid(vif, strlen(P2P_WILDCARD_SSID), P2P_WILDCARD_SSID);\n\tif (rc) {\n\t\twil_err(wil, \"wmi_set_ssid failed\\n\");\n\t\tgoto out_stop;\n\t}\n\n\trc = wmi_start_listen(vif);\n\tif (rc) {\n\t\twil_err(wil, \"wmi_start_listen failed\\n\");\n\t\tgoto out_stop;\n\t}\n\n\tINIT_WORK(&p2p->discovery_expired_work, wil_p2p_listen_expired);\n\tmod_timer(&p2p->discovery_timer,\n\t\t  jiffies + msecs_to_jiffies(p2p->listen_duration));\nout_stop:\n\tif (rc)\n\t\twmi_stop_discovery(vif);\n\nout:\n\treturn rc;\n}\n\nbool wil_p2p_is_social_scan(struct cfg80211_scan_request *request)\n{\n\treturn (request->n_channels == 1) &&\n\t       (request->channels[0]->hw_value == P2P_DMG_SOCIAL_CHANNEL);\n}\n\nint wil_p2p_search(struct wil6210_vif *vif,\n\t\t   struct cfg80211_scan_request *request)\n{\n\tstruct wil6210_priv *wil = vif_to_wil(vif);\n\tint rc;\n\tstruct wil_p2p_info *p2p = &vif->p2p;\n\n\twil_dbg_misc(wil, \"p2p_search: channel %d\\n\", P2P_DMG_SOCIAL_CHANNEL);\n\n\tlockdep_assert_held(&wil->mutex);\n\n\tif (p2p->discovery_started) {\n\t\twil_err(wil, \"search failed. discovery already ongoing\\n\");\n\t\trc = -EBUSY;\n\t\tgoto out;\n\t}\n\n\trc = wmi_p2p_cfg(vif, P2P_DMG_SOCIAL_CHANNEL, P2P_DEFAULT_BI);\n\tif (rc) {\n\t\twil_err(wil, \"wmi_p2p_cfg failed\\n\");\n\t\tgoto out;\n\t}\n\n\trc = wmi_set_ssid(vif, strlen(P2P_WILDCARD_SSID), P2P_WILDCARD_SSID);\n\tif (rc) {\n\t\twil_err(wil, \"wmi_set_ssid failed\\n\");\n\t\tgoto out_stop;\n\t}\n\n\t \n\trc = wmi_set_ie(vif, WMI_FRAME_PROBE_REQ,\n\t\t\trequest->ie_len, request->ie);\n\tif (rc) {\n\t\twil_err(wil, \"wmi_set_ie(WMI_FRAME_PROBE_REQ) failed\\n\");\n\t\tgoto out_stop;\n\t}\n\n\t \n\trc = wmi_set_ie(vif, WMI_FRAME_PROBE_RESP,\n\t\t\trequest->ie_len, request->ie);\n\tif (rc) {\n\t\twil_err(wil, \"wmi_set_ie(WMI_FRAME_PROBE_RESP) failed\\n\");\n\t\tgoto out_stop;\n\t}\n\n\trc = wmi_start_search(vif);\n\tif (rc) {\n\t\twil_err(wil, \"wmi_start_search failed\\n\");\n\t\tgoto out_stop;\n\t}\n\n\tp2p->discovery_started = 1;\n\tINIT_WORK(&p2p->discovery_expired_work, wil_p2p_search_expired);\n\tmod_timer(&p2p->discovery_timer,\n\t\t  jiffies + msecs_to_jiffies(P2P_SEARCH_DURATION_MS));\n\nout_stop:\n\tif (rc)\n\t\twmi_stop_discovery(vif);\n\nout:\n\treturn rc;\n}\n\nint wil_p2p_listen(struct wil6210_priv *wil, struct wireless_dev *wdev,\n\t\t   unsigned int duration, struct ieee80211_channel *chan,\n\t\t   u64 *cookie)\n{\n\tstruct wil6210_vif *vif = wdev_to_vif(wil, wdev);\n\tstruct wil_p2p_info *p2p = &vif->p2p;\n\tint rc;\n\n\tif (!chan)\n\t\treturn -EINVAL;\n\n\twil_dbg_misc(wil, \"p2p_listen: duration %d\\n\", duration);\n\n\tmutex_lock(&wil->mutex);\n\n\tif (p2p->discovery_started) {\n\t\twil_err(wil, \"discovery already ongoing\\n\");\n\t\trc = -EBUSY;\n\t\tgoto out;\n\t}\n\n\tmemcpy(&p2p->listen_chan, chan, sizeof(*chan));\n\t*cookie = ++p2p->cookie;\n\tp2p->listen_duration = duration;\n\n\tmutex_lock(&wil->vif_mutex);\n\tif (vif->scan_request) {\n\t\twil_dbg_misc(wil, \"Delaying p2p listen until scan done\\n\");\n\t\tp2p->pending_listen_wdev = wdev;\n\t\tp2p->discovery_started = 1;\n\t\trc = 0;\n\t\tmutex_unlock(&wil->vif_mutex);\n\t\tgoto out;\n\t}\n\tmutex_unlock(&wil->vif_mutex);\n\n\trc = wil_p2p_start_listen(vif);\n\tif (rc)\n\t\tgoto out;\n\n\tp2p->discovery_started = 1;\n\tif (vif->mid == 0)\n\t\twil->radio_wdev = wdev;\n\n\tcfg80211_ready_on_channel(wdev, *cookie, chan, duration,\n\t\t\t\t  GFP_KERNEL);\n\nout:\n\tmutex_unlock(&wil->mutex);\n\treturn rc;\n}\n\nu8 wil_p2p_stop_discovery(struct wil6210_vif *vif)\n{\n\tstruct wil_p2p_info *p2p = &vif->p2p;\n\tu8 started = p2p->discovery_started;\n\n\tif (p2p->discovery_started) {\n\t\tif (p2p->pending_listen_wdev) {\n\t\t\t \n\t\t\tp2p->pending_listen_wdev = NULL;\n\t\t} else {\n\t\t\tdel_timer_sync(&p2p->discovery_timer);\n\t\t\twmi_stop_discovery(vif);\n\t\t}\n\t\tp2p->discovery_started = 0;\n\t}\n\n\treturn started;\n}\n\nint wil_p2p_cancel_listen(struct wil6210_vif *vif, u64 cookie)\n{\n\tstruct wil6210_priv *wil = vif_to_wil(vif);\n\tstruct wil_p2p_info *p2p = &vif->p2p;\n\tu8 started;\n\n\tmutex_lock(&wil->mutex);\n\n\tif (cookie != p2p->cookie) {\n\t\twil_info(wil, \"Cookie mismatch: 0x%016llx vs. 0x%016llx\\n\",\n\t\t\t p2p->cookie, cookie);\n\t\tmutex_unlock(&wil->mutex);\n\t\treturn -ENOENT;\n\t}\n\n\tstarted = wil_p2p_stop_discovery(vif);\n\n\tmutex_unlock(&wil->mutex);\n\n\tif (!started) {\n\t\twil_err(wil, \"listen not started\\n\");\n\t\treturn -ENOENT;\n\t}\n\n\tmutex_lock(&wil->vif_mutex);\n\tcfg80211_remain_on_channel_expired(vif_to_radio_wdev(wil, vif),\n\t\t\t\t\t   p2p->cookie,\n\t\t\t\t\t   &p2p->listen_chan,\n\t\t\t\t\t   GFP_KERNEL);\n\tif (vif->mid == 0)\n\t\twil->radio_wdev = wil->main_ndev->ieee80211_ptr;\n\tmutex_unlock(&wil->vif_mutex);\n\treturn 0;\n}\n\nvoid wil_p2p_listen_expired(struct work_struct *work)\n{\n\tstruct wil_p2p_info *p2p = container_of(work,\n\t\t\tstruct wil_p2p_info, discovery_expired_work);\n\tstruct wil6210_vif *vif = container_of(p2p,\n\t\t\tstruct wil6210_vif, p2p);\n\tstruct wil6210_priv *wil = vif_to_wil(vif);\n\tu8 started;\n\n\twil_dbg_misc(wil, \"p2p_listen_expired\\n\");\n\n\tmutex_lock(&wil->mutex);\n\tstarted = wil_p2p_stop_discovery(vif);\n\tmutex_unlock(&wil->mutex);\n\n\tif (!started)\n\t\treturn;\n\n\tmutex_lock(&wil->vif_mutex);\n\tcfg80211_remain_on_channel_expired(vif_to_radio_wdev(wil, vif),\n\t\t\t\t\t   p2p->cookie,\n\t\t\t\t\t   &p2p->listen_chan,\n\t\t\t\t\t   GFP_KERNEL);\n\tif (vif->mid == 0)\n\t\twil->radio_wdev = wil->main_ndev->ieee80211_ptr;\n\tmutex_unlock(&wil->vif_mutex);\n}\n\nvoid wil_p2p_search_expired(struct work_struct *work)\n{\n\tstruct wil_p2p_info *p2p = container_of(work,\n\t\t\tstruct wil_p2p_info, discovery_expired_work);\n\tstruct wil6210_vif *vif = container_of(p2p,\n\t\t\tstruct wil6210_vif, p2p);\n\tstruct wil6210_priv *wil = vif_to_wil(vif);\n\tu8 started;\n\n\twil_dbg_misc(wil, \"p2p_search_expired\\n\");\n\n\tmutex_lock(&wil->mutex);\n\tstarted = wil_p2p_stop_discovery(vif);\n\tmutex_unlock(&wil->mutex);\n\n\tif (started) {\n\t\tstruct cfg80211_scan_info info = {\n\t\t\t.aborted = false,\n\t\t};\n\n\t\tmutex_lock(&wil->vif_mutex);\n\t\tif (vif->scan_request) {\n\t\t\tcfg80211_scan_done(vif->scan_request, &info);\n\t\t\tvif->scan_request = NULL;\n\t\t\tif (vif->mid == 0)\n\t\t\t\twil->radio_wdev =\n\t\t\t\t\twil->main_ndev->ieee80211_ptr;\n\t\t}\n\t\tmutex_unlock(&wil->vif_mutex);\n\t}\n}\n\nvoid wil_p2p_delayed_listen_work(struct work_struct *work)\n{\n\tstruct wil_p2p_info *p2p = container_of(work,\n\t\t\tstruct wil_p2p_info, delayed_listen_work);\n\tstruct wil6210_vif *vif = container_of(p2p,\n\t\t\tstruct wil6210_vif, p2p);\n\tstruct wil6210_priv *wil = vif_to_wil(vif);\n\tint rc;\n\n\tmutex_lock(&wil->mutex);\n\n\twil_dbg_misc(wil, \"Checking delayed p2p listen\\n\");\n\tif (!p2p->discovery_started || !p2p->pending_listen_wdev)\n\t\tgoto out;\n\n\tmutex_lock(&wil->vif_mutex);\n\tif (vif->scan_request) {\n\t\t \n\t\tmutex_unlock(&wil->vif_mutex);\n\t\tgoto out;\n\t}\n\tmutex_unlock(&wil->vif_mutex);\n\n\trc = wil_p2p_start_listen(vif);\n\n\tmutex_lock(&wil->vif_mutex);\n\tif (rc) {\n\t\tcfg80211_remain_on_channel_expired(p2p->pending_listen_wdev,\n\t\t\t\t\t\t   p2p->cookie,\n\t\t\t\t\t\t   &p2p->listen_chan,\n\t\t\t\t\t\t   GFP_KERNEL);\n\t\tif (vif->mid == 0)\n\t\t\twil->radio_wdev = wil->main_ndev->ieee80211_ptr;\n\t} else {\n\t\tcfg80211_ready_on_channel(p2p->pending_listen_wdev, p2p->cookie,\n\t\t\t\t\t  &p2p->listen_chan,\n\t\t\t\t\t  p2p->listen_duration, GFP_KERNEL);\n\t\tif (vif->mid == 0)\n\t\t\twil->radio_wdev = p2p->pending_listen_wdev;\n\t}\n\tp2p->pending_listen_wdev = NULL;\n\tmutex_unlock(&wil->vif_mutex);\n\nout:\n\tmutex_unlock(&wil->mutex);\n}\n\nvoid wil_p2p_stop_radio_operations(struct wil6210_priv *wil)\n{\n\tstruct wil6210_vif *vif = ndev_to_vif(wil->main_ndev);\n\tstruct wil_p2p_info *p2p = &vif->p2p;\n\tstruct cfg80211_scan_info info = {\n\t\t.aborted = true,\n\t};\n\n\tlockdep_assert_held(&wil->mutex);\n\tlockdep_assert_held(&wil->vif_mutex);\n\n\tif (wil->radio_wdev != wil->p2p_wdev)\n\t\tgoto out;\n\n\tif (!p2p->discovery_started) {\n\t\t \n\t\tif (vif->scan_request &&\n\t\t    vif->scan_request->wdev == wil->p2p_wdev)\n\t\t\twil_abort_scan(vif, true);\n\t\tgoto out;\n\t}\n\n\t \n\tmutex_unlock(&wil->vif_mutex);\n\twil_p2p_stop_discovery(vif);\n\tmutex_lock(&wil->vif_mutex);\n\n\tif (vif->scan_request) {\n\t\t \n\t\tcfg80211_scan_done(vif->scan_request, &info);\n\t\tvif->scan_request = NULL;\n\t} else {\n\t\t \n\t\tcfg80211_remain_on_channel_expired(wil->radio_wdev,\n\t\t\t\t\t\t   p2p->cookie,\n\t\t\t\t\t\t   &p2p->listen_chan,\n\t\t\t\t\t\t   GFP_KERNEL);\n\t}\n\nout:\n\twil->radio_wdev = wil->main_ndev->ieee80211_ptr;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}