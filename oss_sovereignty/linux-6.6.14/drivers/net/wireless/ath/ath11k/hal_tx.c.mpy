{
  "module_name": "hal_tx.c",
  "hash_id": "201f67592d2f9de688e1c4773802274e7fbd8891ec98dd0b9f1f64ca30952e40",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath11k/hal_tx.c",
  "human_readable_source": "\n \n\n#include \"hal_desc.h\"\n#include \"hal.h\"\n#include \"hal_tx.h\"\n#include \"hif.h\"\n\n#define DSCP_TID_MAP_TBL_ENTRY_SIZE 64\n\n \nstatic const u8 dscp_tid_map[DSCP_TID_MAP_TBL_ENTRY_SIZE] = {\n\t0, 0, 0, 0, 0, 0, 0, 0,\n\t1, 1, 1, 1, 1, 1, 1, 1,\n\t2, 2, 2, 2, 2, 2, 2, 2,\n\t3, 3, 3, 3, 3, 3, 3, 3,\n\t4, 4, 4, 4, 4, 4, 4, 4,\n\t5, 5, 5, 5, 5, 5, 5, 5,\n\t6, 6, 6, 6, 6, 6, 6, 6,\n\t7, 7, 7, 7, 7, 7, 7, 7,\n};\n\nvoid ath11k_hal_tx_cmd_desc_setup(struct ath11k_base *ab, void *cmd,\n\t\t\t\t  struct hal_tx_info *ti)\n{\n\tstruct hal_tcl_data_cmd *tcl_cmd = (struct hal_tcl_data_cmd *)cmd;\n\n\ttcl_cmd->buf_addr_info.info0 =\n\t\tFIELD_PREP(BUFFER_ADDR_INFO0_ADDR, ti->paddr);\n\ttcl_cmd->buf_addr_info.info1 =\n\t\tFIELD_PREP(BUFFER_ADDR_INFO1_ADDR,\n\t\t\t   ((uint64_t)ti->paddr >> HAL_ADDR_MSB_REG_SHIFT));\n\ttcl_cmd->buf_addr_info.info1 |=\n\t\tFIELD_PREP(BUFFER_ADDR_INFO1_RET_BUF_MGR, ti->rbm_id) |\n\t\tFIELD_PREP(BUFFER_ADDR_INFO1_SW_COOKIE, ti->desc_id);\n\n\ttcl_cmd->info0 =\n\t\tFIELD_PREP(HAL_TCL_DATA_CMD_INFO0_DESC_TYPE, ti->type) |\n\t\tFIELD_PREP(HAL_TCL_DATA_CMD_INFO0_ENCAP_TYPE, ti->encap_type) |\n\t\tFIELD_PREP(HAL_TCL_DATA_CMD_INFO0_ENCRYPT_TYPE,\n\t\t\t   ti->encrypt_type) |\n\t\tFIELD_PREP(HAL_TCL_DATA_CMD_INFO0_SEARCH_TYPE,\n\t\t\t   ti->search_type) |\n\t\tFIELD_PREP(HAL_TCL_DATA_CMD_INFO0_ADDR_EN,\n\t\t\t   ti->addr_search_flags) |\n\t\tFIELD_PREP(HAL_TCL_DATA_CMD_INFO0_CMD_NUM,\n\t\t\t   ti->meta_data_flags);\n\n\ttcl_cmd->info1 = ti->flags0 |\n\t\tFIELD_PREP(HAL_TCL_DATA_CMD_INFO1_DATA_LEN, ti->data_len) |\n\t\tFIELD_PREP(HAL_TCL_DATA_CMD_INFO1_PKT_OFFSET, ti->pkt_offset);\n\n\ttcl_cmd->info2 = ti->flags1 |\n\t\tFIELD_PREP(HAL_TCL_DATA_CMD_INFO2_TID, ti->tid) |\n\t\tFIELD_PREP(HAL_TCL_DATA_CMD_INFO2_LMAC_ID, ti->lmac_id);\n\n\ttcl_cmd->info3 = FIELD_PREP(HAL_TCL_DATA_CMD_INFO3_DSCP_TID_TABLE_IDX,\n\t\t\t\t    ti->dscp_tid_tbl_idx) |\n\t\t\t FIELD_PREP(HAL_TCL_DATA_CMD_INFO3_SEARCH_INDEX,\n\t\t\t\t    ti->bss_ast_idx) |\n\t\t\t FIELD_PREP(HAL_TCL_DATA_CMD_INFO3_CACHE_SET_NUM,\n\t\t\t\t    ti->bss_ast_hash);\n\ttcl_cmd->info4 = 0;\n\n\tif (ti->enable_mesh)\n\t\tab->hw_params.hw_ops->tx_mesh_enable(ab, tcl_cmd);\n}\n\nvoid ath11k_hal_tx_set_dscp_tid_map(struct ath11k_base *ab, int id)\n{\n\tu32 ctrl_reg_val;\n\tu32 addr;\n\tu8 hw_map_val[HAL_DSCP_TID_TBL_SIZE];\n\tint i;\n\tu32 value;\n\tint cnt = 0;\n\n\tctrl_reg_val = ath11k_hif_read32(ab, HAL_SEQ_WCSS_UMAC_TCL_REG +\n\t\t\t\t\t HAL_TCL1_RING_CMN_CTRL_REG);\n\t \n\tctrl_reg_val |= HAL_TCL1_RING_CMN_CTRL_DSCP_TID_MAP_PROG_EN;\n\tath11k_hif_write32(ab, HAL_SEQ_WCSS_UMAC_TCL_REG +\n\t\t\t   HAL_TCL1_RING_CMN_CTRL_REG, ctrl_reg_val);\n\n\taddr = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL1_RING_DSCP_TID_MAP +\n\t       (4 * id * (HAL_DSCP_TID_TBL_SIZE / 4));\n\n\t \n\tfor (i = 0; i < DSCP_TID_MAP_TBL_ENTRY_SIZE; i += 8) {\n\t\tvalue = FIELD_PREP(HAL_TCL1_RING_FIELD_DSCP_TID_MAP0,\n\t\t\t\t   dscp_tid_map[i]) |\n\t\t\tFIELD_PREP(HAL_TCL1_RING_FIELD_DSCP_TID_MAP1,\n\t\t\t\t   dscp_tid_map[i + 1]) |\n\t\t\tFIELD_PREP(HAL_TCL1_RING_FIELD_DSCP_TID_MAP2,\n\t\t\t\t   dscp_tid_map[i + 2]) |\n\t\t\tFIELD_PREP(HAL_TCL1_RING_FIELD_DSCP_TID_MAP3,\n\t\t\t\t   dscp_tid_map[i + 3]) |\n\t\t\tFIELD_PREP(HAL_TCL1_RING_FIELD_DSCP_TID_MAP4,\n\t\t\t\t   dscp_tid_map[i + 4]) |\n\t\t\tFIELD_PREP(HAL_TCL1_RING_FIELD_DSCP_TID_MAP5,\n\t\t\t\t   dscp_tid_map[i + 5]) |\n\t\t\tFIELD_PREP(HAL_TCL1_RING_FIELD_DSCP_TID_MAP6,\n\t\t\t\t   dscp_tid_map[i + 6]) |\n\t\t\tFIELD_PREP(HAL_TCL1_RING_FIELD_DSCP_TID_MAP7,\n\t\t\t\t   dscp_tid_map[i + 7]);\n\t\tmemcpy(&hw_map_val[cnt], (u8 *)&value, 3);\n\t\tcnt += 3;\n\t}\n\n\tfor (i = 0; i < HAL_DSCP_TID_TBL_SIZE; i += 4) {\n\t\tath11k_hif_write32(ab, addr, *(u32 *)&hw_map_val[i]);\n\t\taddr += 4;\n\t}\n\n\t \n\tctrl_reg_val = ath11k_hif_read32(ab, HAL_SEQ_WCSS_UMAC_TCL_REG +\n\t\t\t\t\t HAL_TCL1_RING_CMN_CTRL_REG);\n\tctrl_reg_val &= ~HAL_TCL1_RING_CMN_CTRL_DSCP_TID_MAP_PROG_EN;\n\tath11k_hif_write32(ab, HAL_SEQ_WCSS_UMAC_TCL_REG +\n\t\t\t   HAL_TCL1_RING_CMN_CTRL_REG,\n\t\t\t   ctrl_reg_val);\n}\n\nvoid ath11k_hal_tx_init_data_ring(struct ath11k_base *ab, struct hal_srng *srng)\n{\n\tstruct hal_srng_params params;\n\tstruct hal_tlv_hdr *tlv;\n\tint i, entry_size;\n\tu8 *desc;\n\n\tmemset(&params, 0, sizeof(params));\n\n\tentry_size = ath11k_hal_srng_get_entrysize(ab, HAL_TCL_DATA);\n\tath11k_hal_srng_get_params(ab, srng, &params);\n\tdesc = (u8 *)params.ring_base_vaddr;\n\n\tfor (i = 0; i < params.num_entries; i++) {\n\t\ttlv = (struct hal_tlv_hdr *)desc;\n\t\ttlv->tl = FIELD_PREP(HAL_TLV_HDR_TAG, HAL_TCL_DATA_CMD) |\n\t\t\t  FIELD_PREP(HAL_TLV_HDR_LEN,\n\t\t\t\t     sizeof(struct hal_tcl_data_cmd));\n\t\tdesc += entry_size;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}