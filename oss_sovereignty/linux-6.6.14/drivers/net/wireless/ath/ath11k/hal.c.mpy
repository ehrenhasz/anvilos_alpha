{
  "module_name": "hal.c",
  "hash_id": "001a79e1767d33413ed2622424be3c2d79f39ab5e104e0bb130b6f188719ecc0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath11k/hal.c",
  "human_readable_source": "\n \n#include <linux/dma-mapping.h>\n#include \"hal_tx.h\"\n#include \"debug.h\"\n#include \"hal_desc.h\"\n#include \"hif.h\"\n\nstatic const struct hal_srng_config hw_srng_config_template[] = {\n\t \n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_REO2SW1,\n\t\t.max_rings = 4,\n\t\t.entry_size = sizeof(struct hal_reo_dest_ring) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_REO_REO2SW1_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t \n\t\t.start_ring_id = HAL_SRNG_RING_ID_REO2TCL,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_reo_dest_ring) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_REO_REO2TCL_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_SW2REO,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_reo_entrance_ring) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_REO_SW2REO_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_REO_CMD,\n\t\t.max_rings = 1,\n\t\t.entry_size = (sizeof(struct hal_tlv_hdr) +\n\t\t\tsizeof(struct hal_reo_get_queue_stats)) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_REO_CMD_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_REO_STATUS,\n\t\t.max_rings = 1,\n\t\t.entry_size = (sizeof(struct hal_tlv_hdr) +\n\t\t\tsizeof(struct hal_reo_get_queue_stats_status)) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_REO_STATUS_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_SW2TCL1,\n\t\t.max_rings = 3,\n\t\t.entry_size = (sizeof(struct hal_tlv_hdr) +\n\t\t\t     sizeof(struct hal_tcl_data_cmd)) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_SW2TCL1_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_SW2TCL_CMD,\n\t\t.max_rings = 1,\n\t\t.entry_size = (sizeof(struct hal_tlv_hdr) +\n\t\t\t     sizeof(struct hal_tcl_gse_cmd)) >> 2,\n\t\t.lmac_ring =  false,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_SW2TCL1_CMD_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_TCL_STATUS,\n\t\t.max_rings = 1,\n\t\t.entry_size = (sizeof(struct hal_tlv_hdr) +\n\t\t\t     sizeof(struct hal_tcl_status_ring)) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_TCL_STATUS_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_CE0_SRC,\n\t\t.max_rings = 12,\n\t\t.entry_size = sizeof(struct hal_ce_srng_src_desc) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_CE_SRC_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_CE0_DST,\n\t\t.max_rings = 12,\n\t\t.entry_size = sizeof(struct hal_ce_srng_dest_desc) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_CE_DST_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_CE0_DST_STATUS,\n\t\t.max_rings = 12,\n\t\t.entry_size = sizeof(struct hal_ce_srng_dst_status_desc) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_CE_DST_STATUS_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_WBM_IDLE_LINK,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_wbm_link_desc) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_WBM_IDLE_LINK_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_WBM_SW_RELEASE,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_wbm_release_ring) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_SW2WBM_RELEASE_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_WBM2SW0_RELEASE,\n\t\t.max_rings = 5,\n\t\t.entry_size = sizeof(struct hal_wbm_release_ring) >> 2,\n\t\t.lmac_ring = false,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_WBM2SW_RELEASE_RING_BASE_MSB_RING_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_WMAC1_SW2RXDMA0_BUF,\n\t\t.max_rings = 2,\n\t\t.entry_size = sizeof(struct hal_wbm_buffer_ring) >> 2,\n\t\t.lmac_ring = true,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_WMAC1_RXDMA2SW0,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_reo_entrance_ring) >> 2,\n\t\t.lmac_ring = true,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_WMAC1_SW2RXDMA2_BUF,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_wbm_buffer_ring) >> 2,\n\t\t.lmac_ring = true,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_WMAC1_SW2RXDMA1_STATBUF,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_wbm_buffer_ring) >> 2,\n\t\t.lmac_ring = true,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_WMAC1_RXDMA2SW1,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_reo_entrance_ring) >> 2,\n\t\t.lmac_ring = true,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_WMAC1_SW2RXDMA1_DESC,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_wbm_buffer_ring) >> 2,\n\t\t.lmac_ring = true,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE,\n\t},\n\t{  \n\t\t.start_ring_id = HAL_SRNG_RING_ID_RXDMA_DIR_BUF,\n\t\t.max_rings = 1,\n\t\t.entry_size = 8 >> 2,  \n\t\t.lmac_ring = true,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE,\n\t},\n};\n\nstatic int ath11k_hal_alloc_cont_rdp(struct ath11k_base *ab)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tsize_t size;\n\n\tsize = sizeof(u32) * HAL_SRNG_RING_ID_MAX;\n\thal->rdp.vaddr = dma_alloc_coherent(ab->dev, size, &hal->rdp.paddr,\n\t\t\t\t\t    GFP_KERNEL);\n\tif (!hal->rdp.vaddr)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\nstatic void ath11k_hal_free_cont_rdp(struct ath11k_base *ab)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tsize_t size;\n\n\tif (!hal->rdp.vaddr)\n\t\treturn;\n\n\tsize = sizeof(u32) * HAL_SRNG_RING_ID_MAX;\n\tdma_free_coherent(ab->dev, size,\n\t\t\t  hal->rdp.vaddr, hal->rdp.paddr);\n\thal->rdp.vaddr = NULL;\n}\n\nstatic int ath11k_hal_alloc_cont_wrp(struct ath11k_base *ab)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tsize_t size;\n\n\tsize = sizeof(u32) * HAL_SRNG_NUM_LMAC_RINGS;\n\thal->wrp.vaddr = dma_alloc_coherent(ab->dev, size, &hal->wrp.paddr,\n\t\t\t\t\t    GFP_KERNEL);\n\tif (!hal->wrp.vaddr)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\nstatic void ath11k_hal_free_cont_wrp(struct ath11k_base *ab)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tsize_t size;\n\n\tif (!hal->wrp.vaddr)\n\t\treturn;\n\n\tsize = sizeof(u32) * HAL_SRNG_NUM_LMAC_RINGS;\n\tdma_free_coherent(ab->dev, size,\n\t\t\t  hal->wrp.vaddr, hal->wrp.paddr);\n\thal->wrp.vaddr = NULL;\n}\n\nstatic void ath11k_hal_ce_dst_setup(struct ath11k_base *ab,\n\t\t\t\t    struct hal_srng *srng, int ring_num)\n{\n\tstruct hal_srng_config *srng_config = &ab->hal.srng_config[HAL_CE_DST];\n\tu32 addr;\n\tu32 val;\n\n\taddr = HAL_CE_DST_RING_CTRL +\n\t       srng_config->reg_start[HAL_SRNG_REG_GRP_R0] +\n\t       ring_num * srng_config->reg_size[HAL_SRNG_REG_GRP_R0];\n\n\tval = ath11k_hif_read32(ab, addr);\n\tval &= ~HAL_CE_DST_R0_DEST_CTRL_MAX_LEN;\n\tval |= FIELD_PREP(HAL_CE_DST_R0_DEST_CTRL_MAX_LEN,\n\t\t\t  srng->u.dst_ring.max_buffer_length);\n\tath11k_hif_write32(ab, addr, val);\n}\n\nstatic void ath11k_hal_srng_dst_hw_init(struct ath11k_base *ab,\n\t\t\t\t\tstruct hal_srng *srng)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tu32 val;\n\tu64 hp_addr;\n\tu32 reg_base;\n\n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R0];\n\n\tif (srng->flags & HAL_SRNG_FLAGS_MSI_INTR) {\n\t\tath11k_hif_write32(ab, reg_base +\n\t\t\t\t   HAL_REO1_RING_MSI1_BASE_LSB_OFFSET(ab),\n\t\t\t\t   srng->msi_addr);\n\n\t\tval = FIELD_PREP(HAL_REO1_RING_MSI1_BASE_MSB_ADDR,\n\t\t\t\t ((u64)srng->msi_addr >>\n\t\t\t\t  HAL_ADDR_MSB_REG_SHIFT)) |\n\t\t      HAL_REO1_RING_MSI1_BASE_MSB_MSI1_ENABLE;\n\t\tath11k_hif_write32(ab, reg_base +\n\t\t\t\t       HAL_REO1_RING_MSI1_BASE_MSB_OFFSET(ab), val);\n\n\t\tath11k_hif_write32(ab,\n\t\t\t\t   reg_base + HAL_REO1_RING_MSI1_DATA_OFFSET(ab),\n\t\t\t\t   srng->msi_data);\n\t}\n\n\tath11k_hif_write32(ab, reg_base, srng->ring_base_paddr);\n\n\tval = FIELD_PREP(HAL_REO1_RING_BASE_MSB_RING_BASE_ADDR_MSB,\n\t\t\t ((u64)srng->ring_base_paddr >>\n\t\t\t  HAL_ADDR_MSB_REG_SHIFT)) |\n\t      FIELD_PREP(HAL_REO1_RING_BASE_MSB_RING_SIZE,\n\t\t\t (srng->entry_size * srng->num_entries));\n\tath11k_hif_write32(ab, reg_base + HAL_REO1_RING_BASE_MSB_OFFSET(ab), val);\n\n\tval = FIELD_PREP(HAL_REO1_RING_ID_RING_ID, srng->ring_id) |\n\t      FIELD_PREP(HAL_REO1_RING_ID_ENTRY_SIZE, srng->entry_size);\n\tath11k_hif_write32(ab, reg_base + HAL_REO1_RING_ID_OFFSET(ab), val);\n\n\t \n\tval = FIELD_PREP(HAL_REO1_RING_PRDR_INT_SETUP_INTR_TMR_THOLD,\n\t\t\t (srng->intr_timer_thres_us >> 3));\n\n\tval |= FIELD_PREP(HAL_REO1_RING_PRDR_INT_SETUP_BATCH_COUNTER_THOLD,\n\t\t\t  (srng->intr_batch_cntr_thres_entries *\n\t\t\t   srng->entry_size));\n\n\tath11k_hif_write32(ab,\n\t\t\t   reg_base + HAL_REO1_RING_PRODUCER_INT_SETUP_OFFSET(ab),\n\t\t\t   val);\n\n\thp_addr = hal->rdp.paddr +\n\t\t  ((unsigned long)srng->u.dst_ring.hp_addr -\n\t\t   (unsigned long)hal->rdp.vaddr);\n\tath11k_hif_write32(ab, reg_base + HAL_REO1_RING_HP_ADDR_LSB_OFFSET(ab),\n\t\t\t   hp_addr & HAL_ADDR_LSB_REG_MASK);\n\tath11k_hif_write32(ab, reg_base + HAL_REO1_RING_HP_ADDR_MSB_OFFSET(ab),\n\t\t\t   hp_addr >> HAL_ADDR_MSB_REG_SHIFT);\n\n\t \n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R2];\n\tath11k_hif_write32(ab, reg_base, 0);\n\tath11k_hif_write32(ab, reg_base + HAL_REO1_RING_TP_OFFSET(ab), 0);\n\t*srng->u.dst_ring.hp_addr = 0;\n\n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R0];\n\tval = 0;\n\tif (srng->flags & HAL_SRNG_FLAGS_DATA_TLV_SWAP)\n\t\tval |= HAL_REO1_RING_MISC_DATA_TLV_SWAP;\n\tif (srng->flags & HAL_SRNG_FLAGS_RING_PTR_SWAP)\n\t\tval |= HAL_REO1_RING_MISC_HOST_FW_SWAP;\n\tif (srng->flags & HAL_SRNG_FLAGS_MSI_SWAP)\n\t\tval |= HAL_REO1_RING_MISC_MSI_SWAP;\n\tval |= HAL_REO1_RING_MISC_SRNG_ENABLE;\n\n\tath11k_hif_write32(ab, reg_base + HAL_REO1_RING_MISC_OFFSET(ab), val);\n}\n\nstatic void ath11k_hal_srng_src_hw_init(struct ath11k_base *ab,\n\t\t\t\t\tstruct hal_srng *srng)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tu32 val;\n\tu64 tp_addr;\n\tu32 reg_base;\n\n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R0];\n\n\tif (srng->flags & HAL_SRNG_FLAGS_MSI_INTR) {\n\t\tath11k_hif_write32(ab, reg_base +\n\t\t\t\t   HAL_TCL1_RING_MSI1_BASE_LSB_OFFSET(ab),\n\t\t\t\t   srng->msi_addr);\n\n\t\tval = FIELD_PREP(HAL_TCL1_RING_MSI1_BASE_MSB_ADDR,\n\t\t\t\t ((u64)srng->msi_addr >>\n\t\t\t\t  HAL_ADDR_MSB_REG_SHIFT)) |\n\t\t      HAL_TCL1_RING_MSI1_BASE_MSB_MSI1_ENABLE;\n\t\tath11k_hif_write32(ab, reg_base +\n\t\t\t\t       HAL_TCL1_RING_MSI1_BASE_MSB_OFFSET(ab),\n\t\t\t\t   val);\n\n\t\tath11k_hif_write32(ab, reg_base +\n\t\t\t\t       HAL_TCL1_RING_MSI1_DATA_OFFSET(ab),\n\t\t\t\t   srng->msi_data);\n\t}\n\n\tath11k_hif_write32(ab, reg_base, srng->ring_base_paddr);\n\n\tval = FIELD_PREP(HAL_TCL1_RING_BASE_MSB_RING_BASE_ADDR_MSB,\n\t\t\t ((u64)srng->ring_base_paddr >>\n\t\t\t  HAL_ADDR_MSB_REG_SHIFT)) |\n\t      FIELD_PREP(HAL_TCL1_RING_BASE_MSB_RING_SIZE,\n\t\t\t (srng->entry_size * srng->num_entries));\n\tath11k_hif_write32(ab, reg_base + HAL_TCL1_RING_BASE_MSB_OFFSET(ab), val);\n\n\tval = FIELD_PREP(HAL_REO1_RING_ID_ENTRY_SIZE, srng->entry_size);\n\tath11k_hif_write32(ab, reg_base + HAL_TCL1_RING_ID_OFFSET(ab), val);\n\n\tif (srng->ring_id == HAL_SRNG_RING_ID_WBM_IDLE_LINK) {\n\t\tath11k_hif_write32(ab, reg_base, (u32)srng->ring_base_paddr);\n\t\tval = FIELD_PREP(HAL_TCL1_RING_BASE_MSB_RING_BASE_ADDR_MSB,\n\t\t\t\t ((u64)srng->ring_base_paddr >>\n\t\t\t\t HAL_ADDR_MSB_REG_SHIFT)) |\n\t\t\tFIELD_PREP(HAL_TCL1_RING_BASE_MSB_RING_SIZE,\n\t\t\t\t   (srng->entry_size * srng->num_entries));\n\t\tath11k_hif_write32(ab, reg_base + HAL_TCL1_RING_BASE_MSB_OFFSET(ab), val);\n\t}\n\n\t \n\t \n\tval = FIELD_PREP(HAL_TCL1_RING_CONSR_INT_SETUP_IX0_INTR_TMR_THOLD,\n\t\t\t srng->intr_timer_thres_us);\n\n\tval |= FIELD_PREP(HAL_TCL1_RING_CONSR_INT_SETUP_IX0_BATCH_COUNTER_THOLD,\n\t\t\t  (srng->intr_batch_cntr_thres_entries *\n\t\t\t   srng->entry_size));\n\n\tath11k_hif_write32(ab,\n\t\t\t   reg_base + HAL_TCL1_RING_CONSR_INT_SETUP_IX0_OFFSET(ab),\n\t\t\t   val);\n\n\tval = 0;\n\tif (srng->flags & HAL_SRNG_FLAGS_LOW_THRESH_INTR_EN) {\n\t\tval |= FIELD_PREP(HAL_TCL1_RING_CONSR_INT_SETUP_IX1_LOW_THOLD,\n\t\t\t\t  srng->u.src_ring.low_threshold);\n\t}\n\tath11k_hif_write32(ab,\n\t\t\t   reg_base + HAL_TCL1_RING_CONSR_INT_SETUP_IX1_OFFSET(ab),\n\t\t\t   val);\n\n\tif (srng->ring_id != HAL_SRNG_RING_ID_WBM_IDLE_LINK) {\n\t\ttp_addr = hal->rdp.paddr +\n\t\t\t  ((unsigned long)srng->u.src_ring.tp_addr -\n\t\t\t   (unsigned long)hal->rdp.vaddr);\n\t\tath11k_hif_write32(ab,\n\t\t\t\t   reg_base + HAL_TCL1_RING_TP_ADDR_LSB_OFFSET(ab),\n\t\t\t\t   tp_addr & HAL_ADDR_LSB_REG_MASK);\n\t\tath11k_hif_write32(ab,\n\t\t\t\t   reg_base + HAL_TCL1_RING_TP_ADDR_MSB_OFFSET(ab),\n\t\t\t\t   tp_addr >> HAL_ADDR_MSB_REG_SHIFT);\n\t}\n\n\t \n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R2];\n\tath11k_hif_write32(ab, reg_base, 0);\n\tath11k_hif_write32(ab, reg_base + HAL_TCL1_RING_TP_OFFSET, 0);\n\t*srng->u.src_ring.tp_addr = 0;\n\n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R0];\n\tval = 0;\n\tif (srng->flags & HAL_SRNG_FLAGS_DATA_TLV_SWAP)\n\t\tval |= HAL_TCL1_RING_MISC_DATA_TLV_SWAP;\n\tif (srng->flags & HAL_SRNG_FLAGS_RING_PTR_SWAP)\n\t\tval |= HAL_TCL1_RING_MISC_HOST_FW_SWAP;\n\tif (srng->flags & HAL_SRNG_FLAGS_MSI_SWAP)\n\t\tval |= HAL_TCL1_RING_MISC_MSI_SWAP;\n\n\t \n\tval |= HAL_TCL1_RING_MISC_MSI_LOOPCNT_DISABLE;\n\n\tval |= HAL_TCL1_RING_MISC_SRNG_ENABLE;\n\n\tath11k_hif_write32(ab, reg_base + HAL_TCL1_RING_MISC_OFFSET(ab), val);\n}\n\nstatic void ath11k_hal_srng_hw_init(struct ath11k_base *ab,\n\t\t\t\t    struct hal_srng *srng)\n{\n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC)\n\t\tath11k_hal_srng_src_hw_init(ab, srng);\n\telse\n\t\tath11k_hal_srng_dst_hw_init(ab, srng);\n}\n\nstatic int ath11k_hal_srng_get_ring_id(struct ath11k_base *ab,\n\t\t\t\t       enum hal_ring_type type,\n\t\t\t\t       int ring_num, int mac_id)\n{\n\tstruct hal_srng_config *srng_config = &ab->hal.srng_config[type];\n\tint ring_id;\n\n\tif (ring_num >= srng_config->max_rings) {\n\t\tath11k_warn(ab, \"invalid ring number :%d\\n\", ring_num);\n\t\treturn -EINVAL;\n\t}\n\n\tring_id = srng_config->start_ring_id + ring_num;\n\tif (srng_config->lmac_ring)\n\t\tring_id += mac_id * HAL_SRNG_RINGS_PER_LMAC;\n\n\tif (WARN_ON(ring_id >= HAL_SRNG_RING_ID_MAX))\n\t\treturn -EINVAL;\n\n\treturn ring_id;\n}\n\nint ath11k_hal_srng_get_entrysize(struct ath11k_base *ab, u32 ring_type)\n{\n\tstruct hal_srng_config *srng_config;\n\n\tif (WARN_ON(ring_type >= HAL_MAX_RING_TYPES))\n\t\treturn -EINVAL;\n\n\tsrng_config = &ab->hal.srng_config[ring_type];\n\n\treturn (srng_config->entry_size << 2);\n}\n\nint ath11k_hal_srng_get_max_entries(struct ath11k_base *ab, u32 ring_type)\n{\n\tstruct hal_srng_config *srng_config;\n\n\tif (WARN_ON(ring_type >= HAL_MAX_RING_TYPES))\n\t\treturn -EINVAL;\n\n\tsrng_config = &ab->hal.srng_config[ring_type];\n\n\treturn (srng_config->max_size / srng_config->entry_size);\n}\n\nvoid ath11k_hal_srng_get_params(struct ath11k_base *ab, struct hal_srng *srng,\n\t\t\t\tstruct hal_srng_params *params)\n{\n\tparams->ring_base_paddr = srng->ring_base_paddr;\n\tparams->ring_base_vaddr = srng->ring_base_vaddr;\n\tparams->num_entries = srng->num_entries;\n\tparams->intr_timer_thres_us = srng->intr_timer_thres_us;\n\tparams->intr_batch_cntr_thres_entries =\n\t\tsrng->intr_batch_cntr_thres_entries;\n\tparams->low_threshold = srng->u.src_ring.low_threshold;\n\tparams->msi_addr = srng->msi_addr;\n\tparams->msi_data = srng->msi_data;\n\tparams->flags = srng->flags;\n}\n\ndma_addr_t ath11k_hal_srng_get_hp_addr(struct ath11k_base *ab,\n\t\t\t\t       struct hal_srng *srng)\n{\n\tif (!(srng->flags & HAL_SRNG_FLAGS_LMAC_RING))\n\t\treturn 0;\n\n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC)\n\t\treturn ab->hal.wrp.paddr +\n\t\t       ((unsigned long)srng->u.src_ring.hp_addr -\n\t\t\t(unsigned long)ab->hal.wrp.vaddr);\n\telse\n\t\treturn ab->hal.rdp.paddr +\n\t\t       ((unsigned long)srng->u.dst_ring.hp_addr -\n\t\t\t (unsigned long)ab->hal.rdp.vaddr);\n}\n\ndma_addr_t ath11k_hal_srng_get_tp_addr(struct ath11k_base *ab,\n\t\t\t\t       struct hal_srng *srng)\n{\n\tif (!(srng->flags & HAL_SRNG_FLAGS_LMAC_RING))\n\t\treturn 0;\n\n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC)\n\t\treturn ab->hal.rdp.paddr +\n\t\t       ((unsigned long)srng->u.src_ring.tp_addr -\n\t\t\t(unsigned long)ab->hal.rdp.vaddr);\n\telse\n\t\treturn ab->hal.wrp.paddr +\n\t\t       ((unsigned long)srng->u.dst_ring.tp_addr -\n\t\t\t(unsigned long)ab->hal.wrp.vaddr);\n}\n\nu32 ath11k_hal_ce_get_desc_size(enum hal_ce_desc type)\n{\n\tswitch (type) {\n\tcase HAL_CE_DESC_SRC:\n\t\treturn sizeof(struct hal_ce_srng_src_desc);\n\tcase HAL_CE_DESC_DST:\n\t\treturn sizeof(struct hal_ce_srng_dest_desc);\n\tcase HAL_CE_DESC_DST_STATUS:\n\t\treturn sizeof(struct hal_ce_srng_dst_status_desc);\n\t}\n\n\treturn 0;\n}\n\nvoid ath11k_hal_ce_src_set_desc(void *buf, dma_addr_t paddr, u32 len, u32 id,\n\t\t\t\tu8 byte_swap_data)\n{\n\tstruct hal_ce_srng_src_desc *desc = (struct hal_ce_srng_src_desc *)buf;\n\n\tdesc->buffer_addr_low = paddr & HAL_ADDR_LSB_REG_MASK;\n\tdesc->buffer_addr_info =\n\t\tFIELD_PREP(HAL_CE_SRC_DESC_ADDR_INFO_ADDR_HI,\n\t\t\t   ((u64)paddr >> HAL_ADDR_MSB_REG_SHIFT)) |\n\t\tFIELD_PREP(HAL_CE_SRC_DESC_ADDR_INFO_BYTE_SWAP,\n\t\t\t   byte_swap_data) |\n\t\tFIELD_PREP(HAL_CE_SRC_DESC_ADDR_INFO_GATHER, 0) |\n\t\tFIELD_PREP(HAL_CE_SRC_DESC_ADDR_INFO_LEN, len);\n\tdesc->meta_info = FIELD_PREP(HAL_CE_SRC_DESC_META_INFO_DATA, id);\n}\n\nvoid ath11k_hal_ce_dst_set_desc(void *buf, dma_addr_t paddr)\n{\n\tstruct hal_ce_srng_dest_desc *desc =\n\t\t(struct hal_ce_srng_dest_desc *)buf;\n\n\tdesc->buffer_addr_low = paddr & HAL_ADDR_LSB_REG_MASK;\n\tdesc->buffer_addr_info =\n\t\tFIELD_PREP(HAL_CE_DEST_DESC_ADDR_INFO_ADDR_HI,\n\t\t\t   ((u64)paddr >> HAL_ADDR_MSB_REG_SHIFT));\n}\n\nu32 ath11k_hal_ce_dst_status_get_length(void *buf)\n{\n\tstruct hal_ce_srng_dst_status_desc *desc =\n\t\t(struct hal_ce_srng_dst_status_desc *)buf;\n\tu32 len;\n\n\tlen = FIELD_GET(HAL_CE_DST_STATUS_DESC_FLAGS_LEN, desc->flags);\n\tdesc->flags &= ~HAL_CE_DST_STATUS_DESC_FLAGS_LEN;\n\n\treturn len;\n}\n\nvoid ath11k_hal_set_link_desc_addr(struct hal_wbm_link_desc *desc, u32 cookie,\n\t\t\t\t   dma_addr_t paddr)\n{\n\tdesc->buf_addr_info.info0 = FIELD_PREP(BUFFER_ADDR_INFO0_ADDR,\n\t\t\t\t\t       (paddr & HAL_ADDR_LSB_REG_MASK));\n\tdesc->buf_addr_info.info1 = FIELD_PREP(BUFFER_ADDR_INFO1_ADDR,\n\t\t\t\t\t       ((u64)paddr >> HAL_ADDR_MSB_REG_SHIFT)) |\n\t\t\t\t    FIELD_PREP(BUFFER_ADDR_INFO1_RET_BUF_MGR, 1) |\n\t\t\t\t    FIELD_PREP(BUFFER_ADDR_INFO1_SW_COOKIE, cookie);\n}\n\nu32 *ath11k_hal_srng_dst_peek(struct ath11k_base *ab, struct hal_srng *srng)\n{\n\tlockdep_assert_held(&srng->lock);\n\n\tif (srng->u.dst_ring.tp != srng->u.dst_ring.cached_hp)\n\t\treturn (srng->ring_base_vaddr + srng->u.dst_ring.tp);\n\n\treturn NULL;\n}\n\nstatic void ath11k_hal_srng_prefetch_desc(struct ath11k_base *ab,\n\t\t\t\t\t  struct hal_srng *srng)\n{\n\tu32 *desc;\n\n\t \n\tdesc = ath11k_hal_srng_dst_peek(ab, srng);\n\tif (likely(desc)) {\n\t\tdma_sync_single_for_cpu(ab->dev, virt_to_phys(desc),\n\t\t\t\t\t(srng->entry_size * sizeof(u32)),\n\t\t\t\t\tDMA_FROM_DEVICE);\n\t\tprefetch(desc);\n\t}\n}\n\nu32 *ath11k_hal_srng_dst_get_next_entry(struct ath11k_base *ab,\n\t\t\t\t\tstruct hal_srng *srng)\n{\n\tu32 *desc;\n\n\tlockdep_assert_held(&srng->lock);\n\n\tif (srng->u.dst_ring.tp == srng->u.dst_ring.cached_hp)\n\t\treturn NULL;\n\n\tdesc = srng->ring_base_vaddr + srng->u.dst_ring.tp;\n\n\tsrng->u.dst_ring.tp += srng->entry_size;\n\n\t \n\tif (srng->u.dst_ring.tp == srng->ring_size)\n\t\tsrng->u.dst_ring.tp = 0;\n\n\t \n\tif (srng->flags & HAL_SRNG_FLAGS_CACHED)\n\t\tath11k_hal_srng_prefetch_desc(ab, srng);\n\n\treturn desc;\n}\n\nint ath11k_hal_srng_dst_num_free(struct ath11k_base *ab, struct hal_srng *srng,\n\t\t\t\t bool sync_hw_ptr)\n{\n\tu32 tp, hp;\n\n\tlockdep_assert_held(&srng->lock);\n\n\ttp = srng->u.dst_ring.tp;\n\n\tif (sync_hw_ptr) {\n\t\thp = *srng->u.dst_ring.hp_addr;\n\t\tsrng->u.dst_ring.cached_hp = hp;\n\t} else {\n\t\thp = srng->u.dst_ring.cached_hp;\n\t}\n\n\tif (hp >= tp)\n\t\treturn (hp - tp) / srng->entry_size;\n\telse\n\t\treturn (srng->ring_size - tp + hp) / srng->entry_size;\n}\n\n \nint ath11k_hal_srng_src_num_free(struct ath11k_base *ab, struct hal_srng *srng,\n\t\t\t\t bool sync_hw_ptr)\n{\n\tu32 tp, hp;\n\n\tlockdep_assert_held(&srng->lock);\n\n\thp = srng->u.src_ring.hp;\n\n\tif (sync_hw_ptr) {\n\t\ttp = *srng->u.src_ring.tp_addr;\n\t\tsrng->u.src_ring.cached_tp = tp;\n\t} else {\n\t\ttp = srng->u.src_ring.cached_tp;\n\t}\n\n\tif (tp > hp)\n\t\treturn ((tp - hp) / srng->entry_size) - 1;\n\telse\n\t\treturn ((srng->ring_size - hp + tp) / srng->entry_size) - 1;\n}\n\nu32 *ath11k_hal_srng_src_get_next_entry(struct ath11k_base *ab,\n\t\t\t\t\tstruct hal_srng *srng)\n{\n\tu32 *desc;\n\tu32 next_hp;\n\n\tlockdep_assert_held(&srng->lock);\n\n\t \n\tnext_hp = (srng->u.src_ring.hp + srng->entry_size) % srng->ring_size;\n\n\tif (next_hp == srng->u.src_ring.cached_tp)\n\t\treturn NULL;\n\n\tdesc = srng->ring_base_vaddr + srng->u.src_ring.hp;\n\tsrng->u.src_ring.hp = next_hp;\n\n\t \n\tsrng->u.src_ring.reap_hp = next_hp;\n\n\treturn desc;\n}\n\nu32 *ath11k_hal_srng_src_reap_next(struct ath11k_base *ab,\n\t\t\t\t   struct hal_srng *srng)\n{\n\tu32 *desc;\n\tu32 next_reap_hp;\n\n\tlockdep_assert_held(&srng->lock);\n\n\tnext_reap_hp = (srng->u.src_ring.reap_hp + srng->entry_size) %\n\t\t       srng->ring_size;\n\n\tif (next_reap_hp == srng->u.src_ring.cached_tp)\n\t\treturn NULL;\n\n\tdesc = srng->ring_base_vaddr + next_reap_hp;\n\tsrng->u.src_ring.reap_hp = next_reap_hp;\n\n\treturn desc;\n}\n\nu32 *ath11k_hal_srng_src_get_next_reaped(struct ath11k_base *ab,\n\t\t\t\t\t struct hal_srng *srng)\n{\n\tu32 *desc;\n\n\tlockdep_assert_held(&srng->lock);\n\n\tif (srng->u.src_ring.hp == srng->u.src_ring.reap_hp)\n\t\treturn NULL;\n\n\tdesc = srng->ring_base_vaddr + srng->u.src_ring.hp;\n\tsrng->u.src_ring.hp = (srng->u.src_ring.hp + srng->entry_size) %\n\t\t\t      srng->ring_size;\n\n\treturn desc;\n}\n\nu32 *ath11k_hal_srng_src_peek(struct ath11k_base *ab, struct hal_srng *srng)\n{\n\tlockdep_assert_held(&srng->lock);\n\n\tif (((srng->u.src_ring.hp + srng->entry_size) % srng->ring_size) ==\n\t    srng->u.src_ring.cached_tp)\n\t\treturn NULL;\n\n\treturn srng->ring_base_vaddr + srng->u.src_ring.hp;\n}\n\nvoid ath11k_hal_srng_access_begin(struct ath11k_base *ab, struct hal_srng *srng)\n{\n\tlockdep_assert_held(&srng->lock);\n\n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC) {\n\t\tsrng->u.src_ring.cached_tp =\n\t\t\t*(volatile u32 *)srng->u.src_ring.tp_addr;\n\t} else {\n\t\tsrng->u.dst_ring.cached_hp = *srng->u.dst_ring.hp_addr;\n\n\t\t \n\t\tif (srng->flags & HAL_SRNG_FLAGS_CACHED)\n\t\t\tath11k_hal_srng_prefetch_desc(ab, srng);\n\t}\n}\n\n \nvoid ath11k_hal_srng_access_end(struct ath11k_base *ab, struct hal_srng *srng)\n{\n\tlockdep_assert_held(&srng->lock);\n\n\t \n\tif (srng->flags & HAL_SRNG_FLAGS_LMAC_RING) {\n\t\t \n\t\tif (srng->ring_dir == HAL_SRNG_DIR_SRC) {\n\t\t\tsrng->u.src_ring.last_tp =\n\t\t\t\t*(volatile u32 *)srng->u.src_ring.tp_addr;\n\t\t\t*srng->u.src_ring.hp_addr = srng->u.src_ring.hp;\n\t\t} else {\n\t\t\tsrng->u.dst_ring.last_hp = *srng->u.dst_ring.hp_addr;\n\t\t\t*srng->u.dst_ring.tp_addr = srng->u.dst_ring.tp;\n\t\t}\n\t} else {\n\t\tif (srng->ring_dir == HAL_SRNG_DIR_SRC) {\n\t\t\tsrng->u.src_ring.last_tp =\n\t\t\t\t*(volatile u32 *)srng->u.src_ring.tp_addr;\n\t\t\tath11k_hif_write32(ab,\n\t\t\t\t\t   (unsigned long)srng->u.src_ring.hp_addr -\n\t\t\t\t\t   (unsigned long)ab->mem,\n\t\t\t\t\t   srng->u.src_ring.hp);\n\t\t} else {\n\t\t\tsrng->u.dst_ring.last_hp = *srng->u.dst_ring.hp_addr;\n\t\t\tath11k_hif_write32(ab,\n\t\t\t\t\t   (unsigned long)srng->u.dst_ring.tp_addr -\n\t\t\t\t\t   (unsigned long)ab->mem,\n\t\t\t\t\t   srng->u.dst_ring.tp);\n\t\t}\n\t}\n\n\tsrng->timestamp = jiffies;\n}\n\nvoid ath11k_hal_setup_link_idle_list(struct ath11k_base *ab,\n\t\t\t\t     struct hal_wbm_idle_scatter_list *sbuf,\n\t\t\t\t     u32 nsbufs, u32 tot_link_desc,\n\t\t\t\t     u32 end_offset)\n{\n\tstruct ath11k_buffer_addr *link_addr;\n\tint i;\n\tu32 reg_scatter_buf_sz = HAL_WBM_IDLE_SCATTER_BUF_SIZE / 64;\n\n\tlink_addr = (void *)sbuf[0].vaddr + HAL_WBM_IDLE_SCATTER_BUF_SIZE;\n\n\tfor (i = 1; i < nsbufs; i++) {\n\t\tlink_addr->info0 = sbuf[i].paddr & HAL_ADDR_LSB_REG_MASK;\n\t\tlink_addr->info1 = FIELD_PREP(\n\t\t\t\tHAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_39_32,\n\t\t\t\t(u64)sbuf[i].paddr >> HAL_ADDR_MSB_REG_SHIFT) |\n\t\t\t\tFIELD_PREP(\n\t\t\t\tHAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_MATCH_TAG,\n\t\t\t\tBASE_ADDR_MATCH_TAG_VAL);\n\n\t\tlink_addr = (void *)sbuf[i].vaddr +\n\t\t\t     HAL_WBM_IDLE_SCATTER_BUF_SIZE;\n\t}\n\n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_R0_IDLE_LIST_CONTROL_ADDR,\n\t\t\t   FIELD_PREP(HAL_WBM_SCATTER_BUFFER_SIZE, reg_scatter_buf_sz) |\n\t\t\t   FIELD_PREP(HAL_WBM_LINK_DESC_IDLE_LIST_MODE, 0x1));\n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_R0_IDLE_LIST_SIZE_ADDR,\n\t\t\t   FIELD_PREP(HAL_WBM_SCATTER_RING_SIZE_OF_IDLE_LINK_DESC_LIST,\n\t\t\t\t      reg_scatter_buf_sz * nsbufs));\n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_RING_BASE_LSB,\n\t\t\t   FIELD_PREP(BUFFER_ADDR_INFO0_ADDR,\n\t\t\t\t      sbuf[0].paddr & HAL_ADDR_LSB_REG_MASK));\n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_RING_BASE_MSB,\n\t\t\t   FIELD_PREP(\n\t\t\t\tHAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_39_32,\n\t\t\t\t(u64)sbuf[0].paddr >> HAL_ADDR_MSB_REG_SHIFT) |\n\t\t\t\tFIELD_PREP(\n\t\t\t\tHAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_MATCH_TAG,\n\t\t\t\tBASE_ADDR_MATCH_TAG_VAL));\n\n\t \n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_HEAD_INFO_IX0,\n\t\t\t   FIELD_PREP(BUFFER_ADDR_INFO0_ADDR,\n\t\t\t\t      sbuf[nsbufs - 1].paddr));\n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_HEAD_INFO_IX1,\n\t\t\t   FIELD_PREP(\n\t\t\t\tHAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_39_32,\n\t\t\t\t((u64)sbuf[nsbufs - 1].paddr >>\n\t\t\t\t HAL_ADDR_MSB_REG_SHIFT)) |\n\t\t\t   FIELD_PREP(HAL_WBM_SCATTERED_DESC_HEAD_P_OFFSET_IX1,\n\t\t\t\t      (end_offset >> 2)));\n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_HEAD_INFO_IX0,\n\t\t\t   FIELD_PREP(BUFFER_ADDR_INFO0_ADDR,\n\t\t\t\t      sbuf[0].paddr));\n\n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_TAIL_INFO_IX0,\n\t\t\t   FIELD_PREP(BUFFER_ADDR_INFO0_ADDR,\n\t\t\t\t      sbuf[0].paddr));\n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_TAIL_INFO_IX1,\n\t\t\t   FIELD_PREP(\n\t\t\t\tHAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_39_32,\n\t\t\t\t((u64)sbuf[0].paddr >> HAL_ADDR_MSB_REG_SHIFT)) |\n\t\t\t   FIELD_PREP(HAL_WBM_SCATTERED_DESC_TAIL_P_OFFSET_IX1,\n\t\t\t\t      0));\n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_HP_ADDR,\n\t\t\t   2 * tot_link_desc);\n\n\t \n\tath11k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_IDLE_LINK_RING_MISC_ADDR(ab), 0x40);\n}\n\nint ath11k_hal_srng_setup(struct ath11k_base *ab, enum hal_ring_type type,\n\t\t\t  int ring_num, int mac_id,\n\t\t\t  struct hal_srng_params *params)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tstruct hal_srng_config *srng_config = &ab->hal.srng_config[type];\n\tstruct hal_srng *srng;\n\tint ring_id;\n\tu32 lmac_idx;\n\tint i;\n\tu32 reg_base;\n\n\tring_id = ath11k_hal_srng_get_ring_id(ab, type, ring_num, mac_id);\n\tif (ring_id < 0)\n\t\treturn ring_id;\n\n\tsrng = &hal->srng_list[ring_id];\n\n\tsrng->ring_id = ring_id;\n\tsrng->ring_dir = srng_config->ring_dir;\n\tsrng->ring_base_paddr = params->ring_base_paddr;\n\tsrng->ring_base_vaddr = params->ring_base_vaddr;\n\tsrng->entry_size = srng_config->entry_size;\n\tsrng->num_entries = params->num_entries;\n\tsrng->ring_size = srng->entry_size * srng->num_entries;\n\tsrng->intr_batch_cntr_thres_entries =\n\t\t\t\tparams->intr_batch_cntr_thres_entries;\n\tsrng->intr_timer_thres_us = params->intr_timer_thres_us;\n\tsrng->flags = params->flags;\n\tsrng->msi_addr = params->msi_addr;\n\tsrng->msi_data = params->msi_data;\n\tsrng->initialized = 1;\n\tspin_lock_init(&srng->lock);\n\tlockdep_set_class(&srng->lock, hal->srng_key + ring_id);\n\n\tfor (i = 0; i < HAL_SRNG_NUM_REG_GRP; i++) {\n\t\tsrng->hwreg_base[i] = srng_config->reg_start[i] +\n\t\t\t\t      (ring_num * srng_config->reg_size[i]);\n\t}\n\n\tmemset(srng->ring_base_vaddr, 0,\n\t       (srng->entry_size * srng->num_entries) << 2);\n\n\t \n\tif (IS_ENABLED(CONFIG_CPU_BIG_ENDIAN))\n\t\tsrng->flags |= HAL_SRNG_FLAGS_MSI_SWAP | HAL_SRNG_FLAGS_DATA_TLV_SWAP |\n\t\t\t       HAL_SRNG_FLAGS_RING_PTR_SWAP;\n\n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R2];\n\n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC) {\n\t\tsrng->u.src_ring.hp = 0;\n\t\tsrng->u.src_ring.cached_tp = 0;\n\t\tsrng->u.src_ring.reap_hp = srng->ring_size - srng->entry_size;\n\t\tsrng->u.src_ring.tp_addr = (void *)(hal->rdp.vaddr + ring_id);\n\t\tsrng->u.src_ring.low_threshold = params->low_threshold *\n\t\t\t\t\t\t srng->entry_size;\n\t\tif (srng_config->lmac_ring) {\n\t\t\tlmac_idx = ring_id - HAL_SRNG_RING_ID_LMAC1_ID_START;\n\t\t\tsrng->u.src_ring.hp_addr = (void *)(hal->wrp.vaddr +\n\t\t\t\t\t\t   lmac_idx);\n\t\t\tsrng->flags |= HAL_SRNG_FLAGS_LMAC_RING;\n\t\t} else {\n\t\t\tif (!ab->hw_params.supports_shadow_regs)\n\t\t\t\tsrng->u.src_ring.hp_addr =\n\t\t\t\t(u32 *)((unsigned long)ab->mem + reg_base);\n\t\t\telse\n\t\t\t\tath11k_dbg(ab, ATH11K_DBG_HAL,\n\t\t\t\t\t   \"type %d ring_num %d reg_base 0x%x shadow 0x%lx\\n\",\n\t\t\t\t\t   type, ring_num,\n\t\t\t\t\t   reg_base,\n\t\t\t\t\t   (unsigned long)srng->u.src_ring.hp_addr -\n\t\t\t\t\t   (unsigned long)ab->mem);\n\t\t}\n\t} else {\n\t\t \n\t\tsrng->u.dst_ring.loop_cnt = 1;\n\t\tsrng->u.dst_ring.tp = 0;\n\t\tsrng->u.dst_ring.cached_hp = 0;\n\t\tsrng->u.dst_ring.hp_addr = (void *)(hal->rdp.vaddr + ring_id);\n\t\tif (srng_config->lmac_ring) {\n\t\t\t \n\t\t\tlmac_idx = ring_id - HAL_SRNG_RING_ID_LMAC1_ID_START;\n\t\t\tsrng->u.dst_ring.tp_addr = (void *)(hal->wrp.vaddr +\n\t\t\t\t\t\t   lmac_idx);\n\t\t\tsrng->flags |= HAL_SRNG_FLAGS_LMAC_RING;\n\t\t} else {\n\t\t\tif (!ab->hw_params.supports_shadow_regs)\n\t\t\t\tsrng->u.dst_ring.tp_addr =\n\t\t\t\t(u32 *)((unsigned long)ab->mem + reg_base +\n\t\t\t\t\t(HAL_REO1_RING_TP(ab) - HAL_REO1_RING_HP(ab)));\n\t\t\telse\n\t\t\t\tath11k_dbg(ab, ATH11K_DBG_HAL,\n\t\t\t\t\t   \"type %d ring_num %d target_reg 0x%x shadow 0x%lx\\n\",\n\t\t\t\t\t   type, ring_num,\n\t\t\t\t\t   reg_base + (HAL_REO1_RING_TP(ab) -\n\t\t\t\t\t\t       HAL_REO1_RING_HP(ab)),\n\t\t\t\t\t   (unsigned long)srng->u.dst_ring.tp_addr -\n\t\t\t\t\t   (unsigned long)ab->mem);\n\t\t}\n\t}\n\n\tif (srng_config->lmac_ring)\n\t\treturn ring_id;\n\n\tath11k_hal_srng_hw_init(ab, srng);\n\n\tif (type == HAL_CE_DST) {\n\t\tsrng->u.dst_ring.max_buffer_length = params->max_buffer_len;\n\t\tath11k_hal_ce_dst_setup(ab, srng, ring_num);\n\t}\n\n\treturn ring_id;\n}\n\nstatic void ath11k_hal_srng_update_hp_tp_addr(struct ath11k_base *ab,\n\t\t\t\t\t      int shadow_cfg_idx,\n\t\t\t\t\t  enum hal_ring_type ring_type,\n\t\t\t\t\t  int ring_num)\n{\n\tstruct hal_srng *srng;\n\tstruct ath11k_hal *hal = &ab->hal;\n\tint ring_id;\n\tstruct hal_srng_config *srng_config = &hal->srng_config[ring_type];\n\n\tring_id = ath11k_hal_srng_get_ring_id(ab, ring_type, ring_num, 0);\n\tif (ring_id < 0)\n\t\treturn;\n\n\tsrng = &hal->srng_list[ring_id];\n\n\tif (srng_config->ring_dir == HAL_SRNG_DIR_DST)\n\t\tsrng->u.dst_ring.tp_addr = (u32 *)(HAL_SHADOW_REG(ab, shadow_cfg_idx) +\n\t\t\t\t\t\t   (unsigned long)ab->mem);\n\telse\n\t\tsrng->u.src_ring.hp_addr = (u32 *)(HAL_SHADOW_REG(ab, shadow_cfg_idx) +\n\t\t\t\t\t\t   (unsigned long)ab->mem);\n}\n\nint ath11k_hal_srng_update_shadow_config(struct ath11k_base *ab,\n\t\t\t\t\t enum hal_ring_type ring_type,\n\t\t\t\t\t int ring_num)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tstruct hal_srng_config *srng_config = &hal->srng_config[ring_type];\n\tint shadow_cfg_idx = hal->num_shadow_reg_configured;\n\tu32 target_reg;\n\n\tif (shadow_cfg_idx >= HAL_SHADOW_NUM_REGS)\n\t\treturn -EINVAL;\n\n\thal->num_shadow_reg_configured++;\n\n\ttarget_reg = srng_config->reg_start[HAL_HP_OFFSET_IN_REG_START];\n\ttarget_reg += srng_config->reg_size[HAL_HP_OFFSET_IN_REG_START] *\n\t\tring_num;\n\n\t \n\tif (srng_config->ring_dir == HAL_SRNG_DIR_DST)\n\t\ttarget_reg += HAL_OFFSET_FROM_HP_TO_TP;\n\n\thal->shadow_reg_addr[shadow_cfg_idx] = target_reg;\n\n\t \n\tath11k_hal_srng_update_hp_tp_addr(ab, shadow_cfg_idx, ring_type,\n\t\t\t\t\t  ring_num);\n\n\tath11k_dbg(ab, ATH11K_DBG_HAL,\n\t\t   \"update shadow config target_reg %x shadow reg 0x%x shadow_idx 0x%x ring_type %d ring num %d\",\n\t\t  target_reg,\n\t\t  HAL_SHADOW_REG(ab, shadow_cfg_idx),\n\t\t  shadow_cfg_idx,\n\t\t  ring_type, ring_num);\n\n\treturn 0;\n}\n\nvoid ath11k_hal_srng_shadow_config(struct ath11k_base *ab)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tint ring_type, ring_num;\n\n\t \n\tfor (ring_type = 0; ring_type < HAL_MAX_RING_TYPES; ring_type++) {\n\t\tstruct hal_srng_config *srng_config = &hal->srng_config[ring_type];\n\n\t\tif (ring_type == HAL_CE_SRC ||\n\t\t    ring_type == HAL_CE_DST ||\n\t\t\tring_type == HAL_CE_DST_STATUS)\n\t\t\tcontinue;\n\n\t\tif (srng_config->lmac_ring)\n\t\t\tcontinue;\n\n\t\tfor (ring_num = 0; ring_num < srng_config->max_rings; ring_num++)\n\t\t\tath11k_hal_srng_update_shadow_config(ab, ring_type, ring_num);\n\t}\n}\n\nvoid ath11k_hal_srng_get_shadow_config(struct ath11k_base *ab,\n\t\t\t\t       u32 **cfg, u32 *len)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\n\t*len = hal->num_shadow_reg_configured;\n\t*cfg = hal->shadow_reg_addr;\n}\n\nvoid ath11k_hal_srng_shadow_update_hp_tp(struct ath11k_base *ab,\n\t\t\t\t\t struct hal_srng *srng)\n{\n\tlockdep_assert_held(&srng->lock);\n\n\t \n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC &&\n\t    *srng->u.src_ring.tp_addr != srng->u.src_ring.hp)\n\t\tath11k_hal_srng_access_end(ab, srng);\n}\n\nstatic int ath11k_hal_srng_create_config(struct ath11k_base *ab)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tstruct hal_srng_config *s;\n\n\thal->srng_config = kmemdup(hw_srng_config_template,\n\t\t\t\t   sizeof(hw_srng_config_template),\n\t\t\t\t   GFP_KERNEL);\n\tif (!hal->srng_config)\n\t\treturn -ENOMEM;\n\n\ts = &hal->srng_config[HAL_REO_DST];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO1_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO1_RING_HP(ab);\n\ts->reg_size[0] = HAL_REO2_RING_BASE_LSB(ab) - HAL_REO1_RING_BASE_LSB(ab);\n\ts->reg_size[1] = HAL_REO2_RING_HP(ab) - HAL_REO1_RING_HP(ab);\n\n\ts = &hal->srng_config[HAL_REO_EXCEPTION];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_TCL_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_TCL_RING_HP(ab);\n\n\ts = &hal->srng_config[HAL_REO_REINJECT];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_SW2REO_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_SW2REO_RING_HP(ab);\n\n\ts = &hal->srng_config[HAL_REO_CMD];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_CMD_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_CMD_HP(ab);\n\n\ts = &hal->srng_config[HAL_REO_STATUS];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_STATUS_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_STATUS_HP(ab);\n\n\ts = &hal->srng_config[HAL_TCL_DATA];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL1_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL1_RING_HP;\n\ts->reg_size[0] = HAL_TCL2_RING_BASE_LSB(ab) - HAL_TCL1_RING_BASE_LSB(ab);\n\ts->reg_size[1] = HAL_TCL2_RING_HP - HAL_TCL1_RING_HP;\n\n\ts = &hal->srng_config[HAL_TCL_CMD];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_RING_HP;\n\n\ts = &hal->srng_config[HAL_TCL_STATUS];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_STATUS_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_STATUS_RING_HP;\n\n\ts = &hal->srng_config[HAL_CE_SRC];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_CE0_SRC_REG(ab) + HAL_CE_DST_RING_BASE_LSB +\n\t\tATH11K_CE_OFFSET(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_CE0_SRC_REG(ab) + HAL_CE_DST_RING_HP +\n\t\tATH11K_CE_OFFSET(ab);\n\ts->reg_size[0] = HAL_SEQ_WCSS_UMAC_CE1_SRC_REG(ab) -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_SRC_REG(ab);\n\ts->reg_size[1] = HAL_SEQ_WCSS_UMAC_CE1_SRC_REG(ab) -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_SRC_REG(ab);\n\n\ts = &hal->srng_config[HAL_CE_DST];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG(ab) + HAL_CE_DST_RING_BASE_LSB +\n\t\tATH11K_CE_OFFSET(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG(ab) + HAL_CE_DST_RING_HP +\n\t\tATH11K_CE_OFFSET(ab);\n\ts->reg_size[0] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG(ab) -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG(ab);\n\ts->reg_size[1] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG(ab) -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG(ab);\n\n\ts = &hal->srng_config[HAL_CE_DST_STATUS];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG(ab) +\n\t\tHAL_CE_DST_STATUS_RING_BASE_LSB + ATH11K_CE_OFFSET(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG(ab) + HAL_CE_DST_STATUS_RING_HP +\n\t\tATH11K_CE_OFFSET(ab);\n\ts->reg_size[0] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG(ab) -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG(ab);\n\ts->reg_size[1] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG(ab) -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG(ab);\n\n\ts = &hal->srng_config[HAL_WBM_IDLE_LINK];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_IDLE_LINK_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_IDLE_LINK_RING_HP;\n\n\ts = &hal->srng_config[HAL_SW2WBM_RELEASE];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_RELEASE_RING_HP;\n\n\ts = &hal->srng_config[HAL_WBM2SW_RELEASE];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM0_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM0_RELEASE_RING_HP;\n\ts->reg_size[0] = HAL_WBM1_RELEASE_RING_BASE_LSB(ab) -\n\t\tHAL_WBM0_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_size[1] = HAL_WBM1_RELEASE_RING_HP - HAL_WBM0_RELEASE_RING_HP;\n\n\treturn 0;\n}\n\nstatic void ath11k_hal_register_srng_key(struct ath11k_base *ab)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tu32 ring_id;\n\n\tfor (ring_id = 0; ring_id < HAL_SRNG_RING_ID_MAX; ring_id++)\n\t\tlockdep_register_key(hal->srng_key + ring_id);\n}\n\nstatic void ath11k_hal_unregister_srng_key(struct ath11k_base *ab)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tu32 ring_id;\n\n\tfor (ring_id = 0; ring_id < HAL_SRNG_RING_ID_MAX; ring_id++)\n\t\tlockdep_unregister_key(hal->srng_key + ring_id);\n}\n\nint ath11k_hal_srng_init(struct ath11k_base *ab)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\tint ret;\n\n\tmemset(hal, 0, sizeof(*hal));\n\n\tret = ath11k_hal_srng_create_config(ab);\n\tif (ret)\n\t\tgoto err_hal;\n\n\tret = ath11k_hal_alloc_cont_rdp(ab);\n\tif (ret)\n\t\tgoto err_hal;\n\n\tret = ath11k_hal_alloc_cont_wrp(ab);\n\tif (ret)\n\t\tgoto err_free_cont_rdp;\n\n\tath11k_hal_register_srng_key(ab);\n\n\treturn 0;\n\nerr_free_cont_rdp:\n\tath11k_hal_free_cont_rdp(ab);\n\nerr_hal:\n\treturn ret;\n}\nEXPORT_SYMBOL(ath11k_hal_srng_init);\n\nvoid ath11k_hal_srng_deinit(struct ath11k_base *ab)\n{\n\tstruct ath11k_hal *hal = &ab->hal;\n\n\tath11k_hal_unregister_srng_key(ab);\n\tath11k_hal_free_cont_rdp(ab);\n\tath11k_hal_free_cont_wrp(ab);\n\tkfree(hal->srng_config);\n}\nEXPORT_SYMBOL(ath11k_hal_srng_deinit);\n\nvoid ath11k_hal_dump_srng_stats(struct ath11k_base *ab)\n{\n\tstruct hal_srng *srng;\n\tstruct ath11k_ext_irq_grp *irq_grp;\n\tstruct ath11k_ce_pipe *ce_pipe;\n\tint i;\n\n\tath11k_err(ab, \"Last interrupt received for each CE:\\n\");\n\tfor (i = 0; i < ab->hw_params.ce_count; i++) {\n\t\tce_pipe = &ab->ce.ce_pipe[i];\n\n\t\tif (ath11k_ce_get_attr_flags(ab, i) & CE_ATTR_DIS_INTR)\n\t\t\tcontinue;\n\n\t\tath11k_err(ab, \"CE_id %d pipe_num %d %ums before\\n\",\n\t\t\t   i, ce_pipe->pipe_num,\n\t\t\t   jiffies_to_msecs(jiffies - ce_pipe->timestamp));\n\t}\n\n\tath11k_err(ab, \"\\nLast interrupt received for each group:\\n\");\n\tfor (i = 0; i < ATH11K_EXT_IRQ_GRP_NUM_MAX; i++) {\n\t\tirq_grp = &ab->ext_irq_grp[i];\n\t\tath11k_err(ab, \"group_id %d %ums before\\n\",\n\t\t\t   irq_grp->grp_id,\n\t\t\t   jiffies_to_msecs(jiffies - irq_grp->timestamp));\n\t}\n\n\tfor (i = 0; i < HAL_SRNG_RING_ID_MAX; i++) {\n\t\tsrng = &ab->hal.srng_list[i];\n\n\t\tif (!srng->initialized)\n\t\t\tcontinue;\n\n\t\tif (srng->ring_dir == HAL_SRNG_DIR_SRC)\n\t\t\tath11k_err(ab,\n\t\t\t\t   \"src srng id %u hp %u, reap_hp %u, cur tp %u, cached tp %u last tp %u napi processed before %ums\\n\",\n\t\t\t\t   srng->ring_id, srng->u.src_ring.hp,\n\t\t\t\t   srng->u.src_ring.reap_hp,\n\t\t\t\t   *srng->u.src_ring.tp_addr, srng->u.src_ring.cached_tp,\n\t\t\t\t   srng->u.src_ring.last_tp,\n\t\t\t\t   jiffies_to_msecs(jiffies - srng->timestamp));\n\t\telse if (srng->ring_dir == HAL_SRNG_DIR_DST)\n\t\t\tath11k_err(ab,\n\t\t\t\t   \"dst srng id %u tp %u, cur hp %u, cached hp %u last hp %u napi processed before %ums\\n\",\n\t\t\t\t   srng->ring_id, srng->u.dst_ring.tp,\n\t\t\t\t   *srng->u.dst_ring.hp_addr,\n\t\t\t\t   srng->u.dst_ring.cached_hp,\n\t\t\t\t   srng->u.dst_ring.last_hp,\n\t\t\t\t   jiffies_to_msecs(jiffies - srng->timestamp));\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}