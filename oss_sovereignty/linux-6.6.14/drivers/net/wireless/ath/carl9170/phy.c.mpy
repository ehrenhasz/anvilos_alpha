{
  "module_name": "phy.c",
  "hash_id": "f2e23a2180da1df3e3226e4c5112c8daeaec14e8376e6218f54555cf6257f4bd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/carl9170/phy.c",
  "human_readable_source": " \n\n#include <linux/bitrev.h>\n#include \"carl9170.h\"\n#include \"cmd.h\"\n#include \"phy.h\"\n\nstatic int carl9170_init_power_cal(struct ar9170 *ar)\n{\n\tcarl9170_regwrite_begin(ar);\n\n\tcarl9170_regwrite(AR9170_PHY_REG_POWER_TX_RATE_MAX, 0x7f);\n\tcarl9170_regwrite(AR9170_PHY_REG_POWER_TX_RATE1, 0x3f3f3f3f);\n\tcarl9170_regwrite(AR9170_PHY_REG_POWER_TX_RATE2, 0x3f3f3f3f);\n\tcarl9170_regwrite(AR9170_PHY_REG_POWER_TX_RATE3, 0x3f3f3f3f);\n\tcarl9170_regwrite(AR9170_PHY_REG_POWER_TX_RATE4, 0x3f3f3f3f);\n\tcarl9170_regwrite(AR9170_PHY_REG_POWER_TX_RATE5, 0x3f3f3f3f);\n\tcarl9170_regwrite(AR9170_PHY_REG_POWER_TX_RATE6, 0x3f3f3f3f);\n\tcarl9170_regwrite(AR9170_PHY_REG_POWER_TX_RATE7, 0x3f3f3f3f);\n\tcarl9170_regwrite(AR9170_PHY_REG_POWER_TX_RATE8, 0x3f3f3f3f);\n\tcarl9170_regwrite(AR9170_PHY_REG_POWER_TX_RATE9, 0x3f3f3f3f);\n\n\tcarl9170_regwrite_finish();\n\treturn carl9170_regwrite_result();\n}\n\nstruct carl9170_phy_init {\n\tu32 reg, _5ghz_20, _5ghz_40, _2ghz_40, _2ghz_20;\n};\n\nstatic struct carl9170_phy_init ar5416_phy_init[] = {\n\t{ 0x1c5800, 0x00000007, 0x00000007, 0x00000007, 0x00000007, },\n\t{ 0x1c5804, 0x00000300, 0x000003c4, 0x000003c4, 0x00000300, },\n\t{ 0x1c5808, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c580c, 0xad848e19, 0xad848e19, 0xad848e19, 0xad848e19, },\n\t{ 0x1c5810, 0x7d14e000, 0x7d14e000, 0x7d14e000, 0x7d14e000, },\n\t{ 0x1c5814, 0x9c0a9f6b, 0x9c0a9f6b, 0x9c0a9f6b, 0x9c0a9f6b, },\n\t{ 0x1c5818, 0x00000090, 0x00000090, 0x00000090, 0x00000090, },\n\t{ 0x1c581c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5820, 0x02020200, 0x02020200, 0x02020200, 0x02020200, },\n\t{ 0x1c5824, 0x00000e0e, 0x00000e0e, 0x00000e0e, 0x00000e0e, },\n\t{ 0x1c5828, 0x0a020001, 0x0a020001, 0x0a020001, 0x0a020001, },\n\t{ 0x1c582c, 0x0000a000, 0x0000a000, 0x0000a000, 0x0000a000, },\n\t{ 0x1c5830, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5834, 0x00000e0e, 0x00000e0e, 0x00000e0e, 0x00000e0e, },\n\t{ 0x1c5838, 0x00000007, 0x00000007, 0x00000007, 0x00000007, },\n\t{ 0x1c583c, 0x00200400, 0x00200400, 0x00200400, 0x00200400, },\n\t{ 0x1c5840, 0x206a002e, 0x206a002e, 0x206a002e, 0x206a002e, },\n\t{ 0x1c5844, 0x1372161e, 0x13721c1e, 0x13721c24, 0x137216a4, },\n\t{ 0x1c5848, 0x001a6a65, 0x001a6a65, 0x00197a68, 0x00197a68, },\n\t{ 0x1c584c, 0x1284233c, 0x1284233c, 0x1284233c, 0x1284233c, },\n\t{ 0x1c5850, 0x6c48b4e4, 0x6d48b4e4, 0x6d48b0e4, 0x6c48b0e4, },\n\t{ 0x1c5854, 0x00000859, 0x00000859, 0x00000859, 0x00000859, },\n\t{ 0x1c5858, 0x7ec80d2e, 0x7ec80d2e, 0x7ec80d2e, 0x7ec80d2e, },\n\t{ 0x1c585c, 0x31395c5e, 0x3139605e, 0x3139605e, 0x31395c5e, },\n\t{ 0x1c5860, 0x0004dd10, 0x0004dd10, 0x0004dd20, 0x0004dd20, },\n\t{ 0x1c5864, 0x0001c600, 0x0001c600, 0x0001c600, 0x0001c600, },\n\t{ 0x1c5868, 0x409a4190, 0x409a4190, 0x409a4190, 0x409a4190, },\n\t{ 0x1c586c, 0x050cb081, 0x050cb081, 0x050cb081, 0x050cb081, },\n\t{ 0x1c5900, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5904, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5908, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c590c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5914, 0x000007d0, 0x000007d0, 0x00000898, 0x00000898, },\n\t{ 0x1c5918, 0x00000118, 0x00000230, 0x00000268, 0x00000134, },\n\t{ 0x1c591c, 0x10000fff, 0x10000fff, 0x10000fff, 0x10000fff, },\n\t{ 0x1c5920, 0x0510081c, 0x0510081c, 0x0510001c, 0x0510001c, },\n\t{ 0x1c5924, 0xd0058a15, 0xd0058a15, 0xd0058a15, 0xd0058a15, },\n\t{ 0x1c5928, 0x00000001, 0x00000001, 0x00000001, 0x00000001, },\n\t{ 0x1c592c, 0x00000004, 0x00000004, 0x00000004, 0x00000004, },\n\t{ 0x1c5934, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, },\n\t{ 0x1c5938, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, },\n\t{ 0x1c593c, 0x0000007f, 0x0000007f, 0x0000007f, 0x0000007f, },\n\t{ 0x1c5944, 0xdfb81020, 0xdfb81020, 0xdfb81020, 0xdfb81020, },\n\t{ 0x1c5948, 0x9280b212, 0x9280b212, 0x9280b212, 0x9280b212, },\n\t{ 0x1c594c, 0x00020028, 0x00020028, 0x00020028, 0x00020028, },\n\t{ 0x1c5954, 0x5d50e188, 0x5d50e188, 0x5d50e188, 0x5d50e188, },\n\t{ 0x1c5958, 0x00081fff, 0x00081fff, 0x00081fff, 0x00081fff, },\n\t{ 0x1c5960, 0x00009b40, 0x00009b40, 0x00009b40, 0x00009b40, },\n\t{ 0x1c5964, 0x00001120, 0x00001120, 0x00001120, 0x00001120, },\n\t{ 0x1c5970, 0x190fb515, 0x190fb515, 0x190fb515, 0x190fb515, },\n\t{ 0x1c5974, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5978, 0x00000001, 0x00000001, 0x00000001, 0x00000001, },\n\t{ 0x1c597c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5980, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5984, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5988, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c598c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5990, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5994, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5998, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c599c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c59a0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c59a4, 0x00000007, 0x00000007, 0x00000007, 0x00000007, },\n\t{ 0x1c59a8, 0x001fff00, 0x001fff00, 0x001fff00, 0x001fff00, },\n\t{ 0x1c59ac, 0x006f00c4, 0x006f00c4, 0x006f00c4, 0x006f00c4, },\n\t{ 0x1c59b0, 0x03051000, 0x03051000, 0x03051000, 0x03051000, },\n\t{ 0x1c59b4, 0x00000820, 0x00000820, 0x00000820, 0x00000820, },\n\t{ 0x1c59bc, 0x00181400, 0x00181400, 0x00181400, 0x00181400, },\n\t{ 0x1c59c0, 0x038919be, 0x038919be, 0x038919be, 0x038919be, },\n\t{ 0x1c59c4, 0x06336f77, 0x06336f77, 0x06336f77, 0x06336f77, },\n\t{ 0x1c59c8, 0x6af6532c, 0x6af6532c, 0x6af6532c, 0x6af6532c, },\n\t{ 0x1c59cc, 0x08f186c8, 0x08f186c8, 0x08f186c8, 0x08f186c8, },\n\t{ 0x1c59d0, 0x00046384, 0x00046384, 0x00046384, 0x00046384, },\n\t{ 0x1c59d4, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c59d8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c59dc, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c59e0, 0x00000200, 0x00000200, 0x00000200, 0x00000200, },\n\t{ 0x1c59e4, 0x64646464, 0x64646464, 0x64646464, 0x64646464, },\n\t{ 0x1c59e8, 0x3c787878, 0x3c787878, 0x3c787878, 0x3c787878, },\n\t{ 0x1c59ec, 0x000000aa, 0x000000aa, 0x000000aa, 0x000000aa, },\n\t{ 0x1c59f0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c59fc, 0x00001042, 0x00001042, 0x00001042, 0x00001042, },\n\t{ 0x1c5a00, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5a04, 0x00000040, 0x00000040, 0x00000040, 0x00000040, },\n\t{ 0x1c5a08, 0x00000080, 0x00000080, 0x00000080, 0x00000080, },\n\t{ 0x1c5a0c, 0x000001a1, 0x000001a1, 0x00000141, 0x00000141, },\n\t{ 0x1c5a10, 0x000001e1, 0x000001e1, 0x00000181, 0x00000181, },\n\t{ 0x1c5a14, 0x00000021, 0x00000021, 0x000001c1, 0x000001c1, },\n\t{ 0x1c5a18, 0x00000061, 0x00000061, 0x00000001, 0x00000001, },\n\t{ 0x1c5a1c, 0x00000168, 0x00000168, 0x00000041, 0x00000041, },\n\t{ 0x1c5a20, 0x000001a8, 0x000001a8, 0x000001a8, 0x000001a8, },\n\t{ 0x1c5a24, 0x000001e8, 0x000001e8, 0x000001e8, 0x000001e8, },\n\t{ 0x1c5a28, 0x00000028, 0x00000028, 0x00000028, 0x00000028, },\n\t{ 0x1c5a2c, 0x00000068, 0x00000068, 0x00000068, 0x00000068, },\n\t{ 0x1c5a30, 0x00000189, 0x00000189, 0x000000a8, 0x000000a8, },\n\t{ 0x1c5a34, 0x000001c9, 0x000001c9, 0x00000169, 0x00000169, },\n\t{ 0x1c5a38, 0x00000009, 0x00000009, 0x000001a9, 0x000001a9, },\n\t{ 0x1c5a3c, 0x00000049, 0x00000049, 0x000001e9, 0x000001e9, },\n\t{ 0x1c5a40, 0x00000089, 0x00000089, 0x00000029, 0x00000029, },\n\t{ 0x1c5a44, 0x00000170, 0x00000170, 0x00000069, 0x00000069, },\n\t{ 0x1c5a48, 0x000001b0, 0x000001b0, 0x00000190, 0x00000190, },\n\t{ 0x1c5a4c, 0x000001f0, 0x000001f0, 0x000001d0, 0x000001d0, },\n\t{ 0x1c5a50, 0x00000030, 0x00000030, 0x00000010, 0x00000010, },\n\t{ 0x1c5a54, 0x00000070, 0x00000070, 0x00000050, 0x00000050, },\n\t{ 0x1c5a58, 0x00000191, 0x00000191, 0x00000090, 0x00000090, },\n\t{ 0x1c5a5c, 0x000001d1, 0x000001d1, 0x00000151, 0x00000151, },\n\t{ 0x1c5a60, 0x00000011, 0x00000011, 0x00000191, 0x00000191, },\n\t{ 0x1c5a64, 0x00000051, 0x00000051, 0x000001d1, 0x000001d1, },\n\t{ 0x1c5a68, 0x00000091, 0x00000091, 0x00000011, 0x00000011, },\n\t{ 0x1c5a6c, 0x000001b8, 0x000001b8, 0x00000051, 0x00000051, },\n\t{ 0x1c5a70, 0x000001f8, 0x000001f8, 0x00000198, 0x00000198, },\n\t{ 0x1c5a74, 0x00000038, 0x00000038, 0x000001d8, 0x000001d8, },\n\t{ 0x1c5a78, 0x00000078, 0x00000078, 0x00000018, 0x00000018, },\n\t{ 0x1c5a7c, 0x00000199, 0x00000199, 0x00000058, 0x00000058, },\n\t{ 0x1c5a80, 0x000001d9, 0x000001d9, 0x00000098, 0x00000098, },\n\t{ 0x1c5a84, 0x00000019, 0x00000019, 0x00000159, 0x00000159, },\n\t{ 0x1c5a88, 0x00000059, 0x00000059, 0x00000199, 0x00000199, },\n\t{ 0x1c5a8c, 0x00000099, 0x00000099, 0x000001d9, 0x000001d9, },\n\t{ 0x1c5a90, 0x000000d9, 0x000000d9, 0x00000019, 0x00000019, },\n\t{ 0x1c5a94, 0x000000f9, 0x000000f9, 0x00000059, 0x00000059, },\n\t{ 0x1c5a98, 0x000000f9, 0x000000f9, 0x00000099, 0x00000099, },\n\t{ 0x1c5a9c, 0x000000f9, 0x000000f9, 0x000000d9, 0x000000d9, },\n\t{ 0x1c5aa0, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5aa4, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5aa8, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5aac, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ab0, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ab4, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ab8, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5abc, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ac0, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ac4, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ac8, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5acc, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ad0, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ad4, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ad8, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5adc, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ae0, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ae4, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5ae8, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5aec, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5af0, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5af4, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5af8, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5afc, 0x000000f9, 0x000000f9, 0x000000f9, 0x000000f9, },\n\t{ 0x1c5b00, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5b04, 0x00000001, 0x00000001, 0x00000001, 0x00000001, },\n\t{ 0x1c5b08, 0x00000002, 0x00000002, 0x00000002, 0x00000002, },\n\t{ 0x1c5b0c, 0x00000003, 0x00000003, 0x00000003, 0x00000003, },\n\t{ 0x1c5b10, 0x00000004, 0x00000004, 0x00000004, 0x00000004, },\n\t{ 0x1c5b14, 0x00000005, 0x00000005, 0x00000005, 0x00000005, },\n\t{ 0x1c5b18, 0x00000008, 0x00000008, 0x00000008, 0x00000008, },\n\t{ 0x1c5b1c, 0x00000009, 0x00000009, 0x00000009, 0x00000009, },\n\t{ 0x1c5b20, 0x0000000a, 0x0000000a, 0x0000000a, 0x0000000a, },\n\t{ 0x1c5b24, 0x0000000b, 0x0000000b, 0x0000000b, 0x0000000b, },\n\t{ 0x1c5b28, 0x0000000c, 0x0000000c, 0x0000000c, 0x0000000c, },\n\t{ 0x1c5b2c, 0x0000000d, 0x0000000d, 0x0000000d, 0x0000000d, },\n\t{ 0x1c5b30, 0x00000010, 0x00000010, 0x00000010, 0x00000010, },\n\t{ 0x1c5b34, 0x00000011, 0x00000011, 0x00000011, 0x00000011, },\n\t{ 0x1c5b38, 0x00000012, 0x00000012, 0x00000012, 0x00000012, },\n\t{ 0x1c5b3c, 0x00000013, 0x00000013, 0x00000013, 0x00000013, },\n\t{ 0x1c5b40, 0x00000014, 0x00000014, 0x00000014, 0x00000014, },\n\t{ 0x1c5b44, 0x00000015, 0x00000015, 0x00000015, 0x00000015, },\n\t{ 0x1c5b48, 0x00000018, 0x00000018, 0x00000018, 0x00000018, },\n\t{ 0x1c5b4c, 0x00000019, 0x00000019, 0x00000019, 0x00000019, },\n\t{ 0x1c5b50, 0x0000001a, 0x0000001a, 0x0000001a, 0x0000001a, },\n\t{ 0x1c5b54, 0x0000001b, 0x0000001b, 0x0000001b, 0x0000001b, },\n\t{ 0x1c5b58, 0x0000001c, 0x0000001c, 0x0000001c, 0x0000001c, },\n\t{ 0x1c5b5c, 0x0000001d, 0x0000001d, 0x0000001d, 0x0000001d, },\n\t{ 0x1c5b60, 0x00000020, 0x00000020, 0x00000020, 0x00000020, },\n\t{ 0x1c5b64, 0x00000021, 0x00000021, 0x00000021, 0x00000021, },\n\t{ 0x1c5b68, 0x00000022, 0x00000022, 0x00000022, 0x00000022, },\n\t{ 0x1c5b6c, 0x00000023, 0x00000023, 0x00000023, 0x00000023, },\n\t{ 0x1c5b70, 0x00000024, 0x00000024, 0x00000024, 0x00000024, },\n\t{ 0x1c5b74, 0x00000025, 0x00000025, 0x00000025, 0x00000025, },\n\t{ 0x1c5b78, 0x00000028, 0x00000028, 0x00000028, 0x00000028, },\n\t{ 0x1c5b7c, 0x00000029, 0x00000029, 0x00000029, 0x00000029, },\n\t{ 0x1c5b80, 0x0000002a, 0x0000002a, 0x0000002a, 0x0000002a, },\n\t{ 0x1c5b84, 0x0000002b, 0x0000002b, 0x0000002b, 0x0000002b, },\n\t{ 0x1c5b88, 0x0000002c, 0x0000002c, 0x0000002c, 0x0000002c, },\n\t{ 0x1c5b8c, 0x0000002d, 0x0000002d, 0x0000002d, 0x0000002d, },\n\t{ 0x1c5b90, 0x00000030, 0x00000030, 0x00000030, 0x00000030, },\n\t{ 0x1c5b94, 0x00000031, 0x00000031, 0x00000031, 0x00000031, },\n\t{ 0x1c5b98, 0x00000032, 0x00000032, 0x00000032, 0x00000032, },\n\t{ 0x1c5b9c, 0x00000033, 0x00000033, 0x00000033, 0x00000033, },\n\t{ 0x1c5ba0, 0x00000034, 0x00000034, 0x00000034, 0x00000034, },\n\t{ 0x1c5ba4, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5ba8, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bac, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bb0, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bb4, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bb8, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bbc, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bc0, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bc4, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bc8, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bcc, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bd0, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bd4, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bd8, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bdc, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5be0, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5be4, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5be8, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bec, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bf0, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bf4, 0x00000035, 0x00000035, 0x00000035, 0x00000035, },\n\t{ 0x1c5bf8, 0x00000010, 0x00000010, 0x00000010, 0x00000010, },\n\t{ 0x1c5bfc, 0x0000001a, 0x0000001a, 0x0000001a, 0x0000001a, },\n\t{ 0x1c5c00, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c0c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c10, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c14, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c18, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c1c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c20, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c24, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c28, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c2c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c30, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c34, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c38, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5c3c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5cf0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5cf4, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5cf8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c5cfc, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c6200, 0x00000008, 0x00000008, 0x0000000e, 0x0000000e, },\n\t{ 0x1c6204, 0x00000440, 0x00000440, 0x00000440, 0x00000440, },\n\t{ 0x1c6208, 0xd6be4788, 0xd6be4788, 0xd03e4788, 0xd03e4788, },\n\t{ 0x1c620c, 0x012e8160, 0x012e8160, 0x012a8160, 0x012a8160, },\n\t{ 0x1c6210, 0x40806333, 0x40806333, 0x40806333, 0x40806333, },\n\t{ 0x1c6214, 0x00106c10, 0x00106c10, 0x00106c10, 0x00106c10, },\n\t{ 0x1c6218, 0x009c4060, 0x009c4060, 0x009c4060, 0x009c4060, },\n\t{ 0x1c621c, 0x1883800a, 0x1883800a, 0x1883800a, 0x1883800a, },\n\t{ 0x1c6220, 0x018830c6, 0x018830c6, 0x018830c6, 0x018830c6, },\n\t{ 0x1c6224, 0x00000400, 0x00000400, 0x00000400, 0x00000400, },\n\t{ 0x1c6228, 0x000009b5, 0x000009b5, 0x000009b5, 0x000009b5, },\n\t{ 0x1c622c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c6230, 0x00000108, 0x00000210, 0x00000210, 0x00000108, },\n\t{ 0x1c6234, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, },\n\t{ 0x1c6238, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, },\n\t{ 0x1c623c, 0x13c889af, 0x13c889af, 0x13c889af, 0x13c889af, },\n\t{ 0x1c6240, 0x38490a20, 0x38490a20, 0x38490a20, 0x38490a20, },\n\t{ 0x1c6244, 0x00007bb6, 0x00007bb6, 0x00007bb6, 0x00007bb6, },\n\t{ 0x1c6248, 0x0fff3ffc, 0x0fff3ffc, 0x0fff3ffc, 0x0fff3ffc, },\n\t{ 0x1c624c, 0x00000001, 0x00000001, 0x00000001, 0x00000001, },\n\t{ 0x1c6250, 0x0000a000, 0x0000a000, 0x0000a000, 0x0000a000, },\n\t{ 0x1c6254, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c6258, 0x0cc75380, 0x0cc75380, 0x0cc75380, 0x0cc75380, },\n\t{ 0x1c625c, 0x0f0f0f01, 0x0f0f0f01, 0x0f0f0f01, 0x0f0f0f01, },\n\t{ 0x1c6260, 0xdfa91f01, 0xdfa91f01, 0xdfa91f01, 0xdfa91f01, },\n\t{ 0x1c6264, 0x00418a11, 0x00418a11, 0x00418a11, 0x00418a11, },\n\t{ 0x1c6268, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c626c, 0x09249126, 0x09249126, 0x09249126, 0x09249126, },\n\t{ 0x1c6274, 0x0a1a9caa, 0x0a1a9caa, 0x0a1a7caa, 0x0a1a7caa, },\n\t{ 0x1c6278, 0x1ce739ce, 0x1ce739ce, 0x1ce739ce, 0x1ce739ce, },\n\t{ 0x1c627c, 0x051701ce, 0x051701ce, 0x051701ce, 0x051701ce, },\n\t{ 0x1c6300, 0x18010000, 0x18010000, 0x18010000, 0x18010000, },\n\t{ 0x1c6304, 0x30032602, 0x30032602, 0x2e032402, 0x2e032402, },\n\t{ 0x1c6308, 0x48073e06, 0x48073e06, 0x4a0a3c06, 0x4a0a3c06, },\n\t{ 0x1c630c, 0x560b4c0a, 0x560b4c0a, 0x621a540b, 0x621a540b, },\n\t{ 0x1c6310, 0x641a600f, 0x641a600f, 0x764f6c1b, 0x764f6c1b, },\n\t{ 0x1c6314, 0x7a4f6e1b, 0x7a4f6e1b, 0x845b7a5a, 0x845b7a5a, },\n\t{ 0x1c6318, 0x8c5b7e5a, 0x8c5b7e5a, 0x950f8ccf, 0x950f8ccf, },\n\t{ 0x1c631c, 0x9d0f96cf, 0x9d0f96cf, 0xa5cf9b4f, 0xa5cf9b4f, },\n\t{ 0x1c6320, 0xb51fa69f, 0xb51fa69f, 0xbddfaf1f, 0xbddfaf1f, },\n\t{ 0x1c6324, 0xcb3fbd07, 0xcb3fbcbf, 0xd1ffc93f, 0xd1ffc93f, },\n\t{ 0x1c6328, 0x0000d7bf, 0x0000d7bf, 0x00000000, 0x00000000, },\n\t{ 0x1c632c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c6330, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c6334, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c6338, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c633c, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c6340, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c6344, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c6348, 0x3fffffff, 0x3fffffff, 0x3fffffff, 0x3fffffff, },\n\t{ 0x1c634c, 0x3fffffff, 0x3fffffff, 0x3fffffff, 0x3fffffff, },\n\t{ 0x1c6350, 0x3fffffff, 0x3fffffff, 0x3fffffff, 0x3fffffff, },\n\t{ 0x1c6354, 0x0003ffff, 0x0003ffff, 0x0003ffff, 0x0003ffff, },\n\t{ 0x1c6358, 0x79a8aa1f, 0x79a8aa1f, 0x79a8aa1f, 0x79a8aa1f, },\n\t{ 0x1c6388, 0x08000000, 0x08000000, 0x08000000, 0x08000000, },\n\t{ 0x1c638c, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, },\n\t{ 0x1c6390, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, },\n\t{ 0x1c6394, 0x1ce739ce, 0x1ce739ce, 0x1ce739ce, 0x1ce739ce, },\n\t{ 0x1c6398, 0x000001ce, 0x000001ce, 0x000001ce, 0x000001ce, },\n\t{ 0x1c639c, 0x00000007, 0x00000007, 0x00000007, 0x00000007, },\n\t{ 0x1c63a0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63a4, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63a8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63ac, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63b0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63b4, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63b8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63bc, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63c0, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63c4, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63c8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63cc, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, },\n\t{ 0x1c63d0, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, },\n\t{ 0x1c63d4, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, 0x3f3f3f3f, },\n\t{ 0x1c63d8, 0x00000000, 0x00000000, 0x00000000, 0x00000000, },\n\t{ 0x1c63dc, 0x1ce739ce, 0x1ce739ce, 0x1ce739ce, 0x1ce739ce, },\n\t{ 0x1c63e0, 0x000000c0, 0x000000c0, 0x000000c0, 0x000000c0, },\n\t{ 0x1c6848, 0x00180a65, 0x00180a65, 0x00180a68, 0x00180a68, },\n\t{ 0x1c6920, 0x0510001c, 0x0510001c, 0x0510001c, 0x0510001c, },\n\t{ 0x1c6960, 0x00009b40, 0x00009b40, 0x00009b40, 0x00009b40, },\n\t{ 0x1c720c, 0x012e8160, 0x012e8160, 0x012a8160, 0x012a8160, },\n\t{ 0x1c726c, 0x09249126, 0x09249126, 0x09249126, 0x09249126, },\n\t{ 0x1c7848, 0x00180a65, 0x00180a65, 0x00180a68, 0x00180a68, },\n\t{ 0x1c7920, 0x0510001c, 0x0510001c, 0x0510001c, 0x0510001c, },\n\t{ 0x1c7960, 0x00009b40, 0x00009b40, 0x00009b40, 0x00009b40, },\n\t{ 0x1c820c, 0x012e8160, 0x012e8160, 0x012a8160, 0x012a8160, },\n\t{ 0x1c826c, 0x09249126, 0x09249126, 0x09249126, 0x09249126, },\n \n\t{ 0x1c8864, 0x0001c600, 0x0001c600, 0x0001c600, 0x0001c600, },\n\t{ 0x1c895c, 0x004b6a8e, 0x004b6a8e, 0x004b6a8e, 0x004b6a8e, },\n\t{ 0x1c8968, 0x000003ce, 0x000003ce, 0x000003ce, 0x000003ce, },\n\t{ 0x1c89bc, 0x00181400, 0x00181400, 0x00181400, 0x00181400, },\n\t{ 0x1c9270, 0x00820820, 0x00820820, 0x00820820, 0x00820820, },\n\t{ 0x1c935c, 0x066c420f, 0x066c420f, 0x066c420f, 0x066c420f, },\n\t{ 0x1c9360, 0x0f282207, 0x0f282207, 0x0f282207, 0x0f282207, },\n\t{ 0x1c9364, 0x17601685, 0x17601685, 0x17601685, 0x17601685, },\n\t{ 0x1c9368, 0x1f801104, 0x1f801104, 0x1f801104, 0x1f801104, },\n\t{ 0x1c936c, 0x37a00c03, 0x37a00c03, 0x37a00c03, 0x37a00c03, },\n\t{ 0x1c9370, 0x3fc40883, 0x3fc40883, 0x3fc40883, 0x3fc40883, },\n\t{ 0x1c9374, 0x57c00803, 0x57c00803, 0x57c00803, 0x57c00803, },\n\t{ 0x1c9378, 0x5fd80682, 0x5fd80682, 0x5fd80682, 0x5fd80682, },\n\t{ 0x1c937c, 0x7fe00482, 0x7fe00482, 0x7fe00482, 0x7fe00482, },\n\t{ 0x1c9380, 0x7f3c7bba, 0x7f3c7bba, 0x7f3c7bba, 0x7f3c7bba, },\n\t{ 0x1c9384, 0xf3307ff0, 0xf3307ff0, 0xf3307ff0, 0xf3307ff0, }\n};\n\n \nstatic u32 carl9170_def_val(u32 reg, bool is_2ghz, bool is_40mhz)\n{\n\tunsigned int i;\n\tfor (i = 0; i < ARRAY_SIZE(ar5416_phy_init); i++) {\n\t\tif (ar5416_phy_init[i].reg != reg)\n\t\t\tcontinue;\n\n\t\tif (is_2ghz) {\n\t\t\tif (is_40mhz)\n\t\t\t\treturn ar5416_phy_init[i]._2ghz_40;\n\t\t\telse\n\t\t\t\treturn ar5416_phy_init[i]._2ghz_20;\n\t\t} else {\n\t\t\tif (is_40mhz)\n\t\t\t\treturn ar5416_phy_init[i]._5ghz_40;\n\t\t\telse\n\t\t\t\treturn ar5416_phy_init[i]._5ghz_20;\n\t\t}\n\t}\n\treturn 0;\n}\n\n \nstatic int carl9170_init_phy_from_eeprom(struct ar9170 *ar,\n\t\t\t\tbool is_2ghz, bool is_40mhz)\n{\n\tstatic const u8 xpd2pd[16] = {\n\t\t0x2, 0x2, 0x2, 0x1, 0x2, 0x2, 0x6, 0x2,\n\t\t0x2, 0x3, 0x7, 0x2, 0xb, 0x2, 0x2, 0x2\n\t};\n\t \n\tstruct ar9170_eeprom_modal *m = &ar->eeprom.modal_header[is_2ghz];\n\tu32 val;\n\n\tcarl9170_regwrite_begin(ar);\n\n\t \n\tcarl9170_regwrite(AR9170_PHY_REG_SWITCH_COM,\n\t\tle32_to_cpu(m->antCtrlCommon));\n\n\t \n\tcarl9170_regwrite(AR9170_PHY_REG_SWITCH_CHAIN_0,\n\t\tle32_to_cpu(m->antCtrlChain[0]));\n\n\t \n\tcarl9170_regwrite(AR9170_PHY_REG_SWITCH_CHAIN_2,\n\t\tle32_to_cpu(m->antCtrlChain[1]));\n\n\t \n\tif (!is_40mhz) {\n\t\tval = carl9170_def_val(AR9170_PHY_REG_SETTLING,\n\t\t\t\t     is_2ghz, is_40mhz);\n\t\tSET_VAL(AR9170_PHY_SETTLING_SWITCH, val, m->switchSettling);\n\t\tcarl9170_regwrite(AR9170_PHY_REG_SETTLING, val);\n\t}\n\n\t \n\tval = carl9170_def_val(AR9170_PHY_REG_DESIRED_SZ, is_2ghz, is_40mhz);\n\tSET_VAL(AR9170_PHY_DESIRED_SZ_PGA, val, m->pgaDesiredSize);\n\tSET_VAL(AR9170_PHY_DESIRED_SZ_ADC, val, m->adcDesiredSize);\n\tcarl9170_regwrite(AR9170_PHY_REG_DESIRED_SZ, val);\n\n\t \n\tval = carl9170_def_val(AR9170_PHY_REG_RF_CTL4, is_2ghz, is_40mhz);\n\tSET_VAL(AR9170_PHY_RF_CTL4_TX_END_XPAB_OFF, val, m->txEndToXpaOff);\n\tSET_VAL(AR9170_PHY_RF_CTL4_TX_END_XPAA_OFF, val, m->txEndToXpaOff);\n\tSET_VAL(AR9170_PHY_RF_CTL4_FRAME_XPAB_ON, val, m->txFrameToXpaOn);\n\tSET_VAL(AR9170_PHY_RF_CTL4_FRAME_XPAA_ON, val, m->txFrameToXpaOn);\n\tcarl9170_regwrite(AR9170_PHY_REG_RF_CTL4, val);\n\n\t \n\tval = carl9170_def_val(AR9170_PHY_REG_RF_CTL3, is_2ghz, is_40mhz);\n\tSET_VAL(AR9170_PHY_RF_CTL3_TX_END_TO_A2_RX_ON, val, m->txEndToRxOn);\n\tcarl9170_regwrite(AR9170_PHY_REG_RF_CTL3, val);\n\n\t \n\tval = carl9170_def_val(0x1c8864, is_2ghz, is_40mhz);\n\tval = (val & ~0x7f000) | (m->thresh62 << 12);\n\tcarl9170_regwrite(0x1c8864, val);\n\n\t \n\tval = carl9170_def_val(AR9170_PHY_REG_RXGAIN, is_2ghz, is_40mhz);\n\tSET_VAL(AR9170_PHY_RXGAIN_TXRX_ATTEN, val, m->txRxAttenCh[0]);\n\tcarl9170_regwrite(AR9170_PHY_REG_RXGAIN, val);\n\n\t \n\tval = carl9170_def_val(AR9170_PHY_REG_RXGAIN_CHAIN_2,\n\t\t\t       is_2ghz, is_40mhz);\n\tSET_VAL(AR9170_PHY_RXGAIN_TXRX_ATTEN, val, m->txRxAttenCh[1]);\n\tcarl9170_regwrite(AR9170_PHY_REG_RXGAIN_CHAIN_2, val);\n\n\t \n\tval = carl9170_def_val(AR9170_PHY_REG_GAIN_2GHZ, is_2ghz, is_40mhz);\n\tSET_VAL(AR9170_PHY_GAIN_2GHZ_RXTX_MARGIN, val, m->rxTxMarginCh[0]);\n\t \n\tif (!is_2ghz)\n\t\tSET_VAL(AR9170_PHY_GAIN_2GHZ_BSW_MARGIN, val, m->bswMargin[0]);\n\tcarl9170_regwrite(AR9170_PHY_REG_GAIN_2GHZ, val);\n\n\t \n\tval = carl9170_def_val(AR9170_PHY_REG_GAIN_2GHZ_CHAIN_2,\n\t\t\t       is_2ghz, is_40mhz);\n\tSET_VAL(AR9170_PHY_GAIN_2GHZ_RXTX_MARGIN, val, m->rxTxMarginCh[1]);\n\tcarl9170_regwrite(AR9170_PHY_REG_GAIN_2GHZ_CHAIN_2, val);\n\n\t \n\tval = carl9170_def_val(AR9170_PHY_REG_TIMING_CTRL4(0),\n\t\t\t       is_2ghz, is_40mhz);\n\tSET_VAL(AR9170_PHY_TIMING_CTRL4_IQCORR_Q_I_COFF, val, m->iqCalICh[0]);\n\tSET_VAL(AR9170_PHY_TIMING_CTRL4_IQCORR_Q_Q_COFF, val, m->iqCalQCh[0]);\n\tcarl9170_regwrite(AR9170_PHY_REG_TIMING_CTRL4(0), val);\n\n\t \n\tval = carl9170_def_val(AR9170_PHY_REG_TIMING_CTRL4(2),\n\t\t\t       is_2ghz, is_40mhz);\n\tSET_VAL(AR9170_PHY_TIMING_CTRL4_IQCORR_Q_I_COFF, val, m->iqCalICh[1]);\n\tSET_VAL(AR9170_PHY_TIMING_CTRL4_IQCORR_Q_Q_COFF, val, m->iqCalQCh[1]);\n\tcarl9170_regwrite(AR9170_PHY_REG_TIMING_CTRL4(2), val);\n\n\t \n\tval = carl9170_def_val(AR9170_PHY_REG_TPCRG1, is_2ghz, is_40mhz);\n\tSET_VAL(AR9170_PHY_TPCRG1_PD_GAIN_1, val,\n\t\txpd2pd[m->xpdGain & 0xf] & 3);\n\tSET_VAL(AR9170_PHY_TPCRG1_PD_GAIN_2, val,\n\t\txpd2pd[m->xpdGain & 0xf] >> 2);\n\tcarl9170_regwrite(AR9170_PHY_REG_TPCRG1, val);\n\n\tcarl9170_regwrite(AR9170_PHY_REG_RX_CHAINMASK, ar->eeprom.rx_mask);\n\tcarl9170_regwrite(AR9170_PHY_REG_CAL_CHAINMASK, ar->eeprom.rx_mask);\n\n\tcarl9170_regwrite_finish();\n\treturn carl9170_regwrite_result();\n}\n\nstatic int carl9170_init_phy(struct ar9170 *ar, enum nl80211_band band)\n{\n\tint i, err;\n\tu32 val;\n\tbool is_2ghz = band == NL80211_BAND_2GHZ;\n\tbool is_40mhz = conf_is_ht40(&ar->hw->conf);\n\n\tcarl9170_regwrite_begin(ar);\n\n\tfor (i = 0; i < ARRAY_SIZE(ar5416_phy_init); i++) {\n\t\tif (is_40mhz) {\n\t\t\tif (is_2ghz)\n\t\t\t\tval = ar5416_phy_init[i]._2ghz_40;\n\t\t\telse\n\t\t\t\tval = ar5416_phy_init[i]._5ghz_40;\n\t\t} else {\n\t\t\tif (is_2ghz)\n\t\t\t\tval = ar5416_phy_init[i]._2ghz_20;\n\t\t\telse\n\t\t\t\tval = ar5416_phy_init[i]._5ghz_20;\n\t\t}\n\n\t\tcarl9170_regwrite(ar5416_phy_init[i].reg, val);\n\t}\n\n\tcarl9170_regwrite_finish();\n\terr = carl9170_regwrite_result();\n\tif (err)\n\t\treturn err;\n\n\terr = carl9170_init_phy_from_eeprom(ar, is_2ghz, is_40mhz);\n\tif (err)\n\t\treturn err;\n\n\terr = carl9170_init_power_cal(ar);\n\tif (err)\n\t\treturn err;\n\n\tif (!ar->fw.hw_counters) {\n\t\terr = carl9170_write_reg(ar, AR9170_PWR_REG_PLL_ADDAC,\n\t\t\t\t\t is_2ghz ? 0x5163 : 0x5143);\n\t}\n\n\treturn err;\n}\n\nstruct carl9170_rf_initvals {\n\tu32 reg, _5ghz, _2ghz;\n};\n\nstatic struct carl9170_rf_initvals carl9170_rf_initval[] = {\n\t \n\t{ 0x1c58b0, 0x1e5795e5, 0x1e5795e5},\n\t{ 0x1c58e0, 0x02008020, 0x02008020},\n\t \n\t{ 0x1c58b0, 0x02108421, 0x02108421},\n\t{ 0x1c58ec, 0x00000008, 0x00000008},\n\t \n\t{ 0x1c58b0, 0x0e73ff17, 0x0e73ff17},\n\t{ 0x1c58e0, 0x00000420, 0x00000420},\n\t \n\t{ 0x1c58f0, 0x01400018, 0x01c00018},\n\t \n\t{ 0x1c58b0, 0x000001a1, 0x000001a1},\n\t{ 0x1c58e8, 0x00000001, 0x00000001},\n\t \n\t{ 0x1c58b0, 0x00000013, 0x00000013},\n\t{ 0x1c58e4, 0x00000002, 0x00000002},\n\t \n\t{ 0x1c58b0, 0x00000000, 0x00000000},\n\t{ 0x1c58b0, 0x00000000, 0x00000000},\n\t{ 0x1c58b0, 0x00000000, 0x00000000},\n\t{ 0x1c58b0, 0x00000000, 0x00000000},\n\t{ 0x1c58b0, 0x00000000, 0x00000000},\n\t{ 0x1c58b0, 0x00004000, 0x00004000},\n\t{ 0x1c58b0, 0x00006c00, 0x00006c00},\n\t{ 0x1c58b0, 0x00002c00, 0x00002c00},\n\t{ 0x1c58b0, 0x00004800, 0x00004800},\n\t{ 0x1c58b0, 0x00004000, 0x00004000},\n\t{ 0x1c58b0, 0x00006000, 0x00006000},\n\t{ 0x1c58b0, 0x00001000, 0x00001000},\n\t{ 0x1c58b0, 0x00004000, 0x00004000},\n\t{ 0x1c58b0, 0x00007c00, 0x00007c00},\n\t{ 0x1c58b0, 0x00007c00, 0x00007c00},\n\t{ 0x1c58b0, 0x00007c00, 0x00007c00},\n\t{ 0x1c58b0, 0x00007c00, 0x00007c00},\n\t{ 0x1c58b0, 0x00007c00, 0x00007c00},\n\t{ 0x1c58b0, 0x00087c00, 0x00087c00},\n\t{ 0x1c58b0, 0x00007c00, 0x00007c00},\n\t{ 0x1c58b0, 0x00005400, 0x00005400},\n\t{ 0x1c58b0, 0x00000c00, 0x00000c00},\n\t{ 0x1c58b0, 0x00001800, 0x00001800},\n\t{ 0x1c58b0, 0x00007c00, 0x00007c00},\n\t{ 0x1c58b0, 0x00006c00, 0x00006c00},\n\t{ 0x1c58b0, 0x00006c00, 0x00006c00},\n\t{ 0x1c58b0, 0x00007c00, 0x00007c00},\n\t{ 0x1c58b0, 0x00002c00, 0x00002c00},\n\t{ 0x1c58b0, 0x00003c00, 0x00003c00},\n\t{ 0x1c58b0, 0x00003800, 0x00003800},\n\t{ 0x1c58b0, 0x00001c00, 0x00001c00},\n\t{ 0x1c58b0, 0x00000800, 0x00000800},\n\t{ 0x1c58b0, 0x00000408, 0x00000408},\n\t{ 0x1c58b0, 0x00004c15, 0x00004c15},\n\t{ 0x1c58b0, 0x00004188, 0x00004188},\n\t{ 0x1c58b0, 0x0000201e, 0x0000201e},\n\t{ 0x1c58b0, 0x00010408, 0x00010408},\n\t{ 0x1c58b0, 0x00000801, 0x00000801},\n\t{ 0x1c58b0, 0x00000c08, 0x00000c08},\n\t{ 0x1c58b0, 0x0000181e, 0x0000181e},\n\t{ 0x1c58b0, 0x00001016, 0x00001016},\n\t{ 0x1c58b0, 0x00002800, 0x00002800},\n\t{ 0x1c58b0, 0x00004010, 0x00004010},\n\t{ 0x1c58b0, 0x0000081c, 0x0000081c},\n\t{ 0x1c58b0, 0x00000115, 0x00000115},\n\t{ 0x1c58b0, 0x00000015, 0x00000015},\n\t{ 0x1c58b0, 0x00000066, 0x00000066},\n\t{ 0x1c58b0, 0x0000001c, 0x0000001c},\n\t{ 0x1c58b0, 0x00000000, 0x00000000},\n\t{ 0x1c58b0, 0x00000004, 0x00000004},\n\t{ 0x1c58b0, 0x00000015, 0x00000015},\n\t{ 0x1c58b0, 0x0000001f, 0x0000001f},\n\t{ 0x1c58e0, 0x00000000, 0x00000400},\n\t \n\t{ 0x1c58b0, 0x000000a0, 0x000000a0},\n\t{ 0x1c58b0, 0x00000000, 0x00000000},\n\t{ 0x1c58b0, 0x00000040, 0x00000040},\n\t{ 0x1c58f0, 0x0000001c, 0x0000001c},\n};\n\nstatic int carl9170_init_rf_banks_0_7(struct ar9170 *ar, bool band5ghz)\n{\n\tint err, i;\n\n\tcarl9170_regwrite_begin(ar);\n\n\tfor (i = 0; i < ARRAY_SIZE(carl9170_rf_initval); i++)\n\t\tcarl9170_regwrite(carl9170_rf_initval[i].reg,\n\t\t\t\t  band5ghz ? carl9170_rf_initval[i]._5ghz\n\t\t\t\t\t   : carl9170_rf_initval[i]._2ghz);\n\n\tcarl9170_regwrite_finish();\n\terr = carl9170_regwrite_result();\n\tif (err)\n\t\twiphy_err(ar->hw->wiphy, \"rf init failed\\n\");\n\n\treturn err;\n}\n\nstruct carl9170_phy_freq_params {\n\tu8 coeff_exp;\n\tu16 coeff_man;\n\tu8 coeff_exp_shgi;\n\tu16 coeff_man_shgi;\n};\n\nenum carl9170_bw {\n\tCARL9170_BW_20,\n\tCARL9170_BW_40_BELOW,\n\tCARL9170_BW_40_ABOVE,\n\n\t__CARL9170_NUM_BW,\n};\n\nstruct carl9170_phy_freq_entry {\n\tu16 freq;\n\tstruct carl9170_phy_freq_params params[__CARL9170_NUM_BW];\n};\n\n \nstatic const struct carl9170_phy_freq_entry carl9170_phy_freq_params[] = {\n \n\t{ 2412, {\n\t\t{ 3, 21737, 3, 19563, },\n\t\t{ 3, 21827, 3, 19644, },\n\t\t{ 3, 21647, 3, 19482, },\n\t} },\n\t{ 2417, {\n\t\t{ 3, 21692, 3, 19523, },\n\t\t{ 3, 21782, 3, 19604, },\n\t\t{ 3, 21602, 3, 19442, },\n\t} },\n\t{ 2422, {\n\t\t{ 3, 21647, 3, 19482, },\n\t\t{ 3, 21737, 3, 19563, },\n\t\t{ 3, 21558, 3, 19402, },\n\t} },\n\t{ 2427, {\n\t\t{ 3, 21602, 3, 19442, },\n\t\t{ 3, 21692, 3, 19523, },\n\t\t{ 3, 21514, 3, 19362, },\n\t} },\n\t{ 2432, {\n\t\t{ 3, 21558, 3, 19402, },\n\t\t{ 3, 21647, 3, 19482, },\n\t\t{ 3, 21470, 3, 19323, },\n\t} },\n\t{ 2437, {\n\t\t{ 3, 21514, 3, 19362, },\n\t\t{ 3, 21602, 3, 19442, },\n\t\t{ 3, 21426, 3, 19283, },\n\t} },\n\t{ 2442, {\n\t\t{ 3, 21470, 3, 19323, },\n\t\t{ 3, 21558, 3, 19402, },\n\t\t{ 3, 21382, 3, 19244, },\n\t} },\n\t{ 2447, {\n\t\t{ 3, 21426, 3, 19283, },\n\t\t{ 3, 21514, 3, 19362, },\n\t\t{ 3, 21339, 3, 19205, },\n\t} },\n\t{ 2452, {\n\t\t{ 3, 21382, 3, 19244, },\n\t\t{ 3, 21470, 3, 19323, },\n\t\t{ 3, 21295, 3, 19166, },\n\t} },\n\t{ 2457, {\n\t\t{ 3, 21339, 3, 19205, },\n\t\t{ 3, 21426, 3, 19283, },\n\t\t{ 3, 21252, 3, 19127, },\n\t} },\n\t{ 2462, {\n\t\t{ 3, 21295, 3, 19166, },\n\t\t{ 3, 21382, 3, 19244, },\n\t\t{ 3, 21209, 3, 19088, },\n\t} },\n\t{ 2467, {\n\t\t{ 3, 21252, 3, 19127, },\n\t\t{ 3, 21339, 3, 19205, },\n\t\t{ 3, 21166, 3, 19050, },\n\t} },\n\t{ 2472, {\n\t\t{ 3, 21209, 3, 19088, },\n\t\t{ 3, 21295, 3, 19166, },\n\t\t{ 3, 21124, 3, 19011, },\n\t} },\n\t{ 2484, {\n\t\t{ 3, 21107, 3, 18996, },\n\t\t{ 3, 21192, 3, 19073, },\n\t\t{ 3, 21022, 3, 18920, },\n\t} },\n\t{ 4920, {\n\t\t{ 4, 21313, 4, 19181, },\n\t\t{ 4, 21356, 4, 19220, },\n\t\t{ 4, 21269, 4, 19142, },\n\t} },\n\t{ 4940, {\n\t\t{ 4, 21226, 4, 19104, },\n\t\t{ 4, 21269, 4, 19142, },\n\t\t{ 4, 21183, 4, 19065, },\n\t} },\n\t{ 4960, {\n\t\t{ 4, 21141, 4, 19027, },\n\t\t{ 4, 21183, 4, 19065, },\n\t\t{ 4, 21098, 4, 18988, },\n\t} },\n\t{ 4980, {\n\t\t{ 4, 21056, 4, 18950, },\n\t\t{ 4, 21098, 4, 18988, },\n\t\t{ 4, 21014, 4, 18912, },\n\t} },\n\t{ 5040, {\n\t\t{ 4, 20805, 4, 18725, },\n\t\t{ 4, 20846, 4, 18762, },\n\t\t{ 4, 20764, 4, 18687, },\n\t} },\n\t{ 5060, {\n\t\t{ 4, 20723, 4, 18651, },\n\t\t{ 4, 20764, 4, 18687, },\n\t\t{ 4, 20682, 4, 18614, },\n\t} },\n\t{ 5080, {\n\t\t{ 4, 20641, 4, 18577, },\n\t\t{ 4, 20682, 4, 18614, },\n\t\t{ 4, 20601, 4, 18541, },\n\t} },\n\t{ 5180, {\n\t\t{ 4, 20243, 4, 18219, },\n\t\t{ 4, 20282, 4, 18254, },\n\t\t{ 4, 20204, 4, 18183, },\n\t} },\n\t{ 5200, {\n\t\t{ 4, 20165, 4, 18148, },\n\t\t{ 4, 20204, 4, 18183, },\n\t\t{ 4, 20126, 4, 18114, },\n\t} },\n\t{ 5220, {\n\t\t{ 4, 20088, 4, 18079, },\n\t\t{ 4, 20126, 4, 18114, },\n\t\t{ 4, 20049, 4, 18044, },\n\t} },\n\t{ 5240, {\n\t\t{ 4, 20011, 4, 18010, },\n\t\t{ 4, 20049, 4, 18044, },\n\t\t{ 4, 19973, 4, 17976, },\n\t} },\n\t{ 5260, {\n\t\t{ 4, 19935, 4, 17941, },\n\t\t{ 4, 19973, 4, 17976, },\n\t\t{ 4, 19897, 4, 17907, },\n\t} },\n\t{ 5280, {\n\t\t{ 4, 19859, 4, 17873, },\n\t\t{ 4, 19897, 4, 17907, },\n\t\t{ 4, 19822, 4, 17840, },\n\t} },\n\t{ 5300, {\n\t\t{ 4, 19784, 4, 17806, },\n\t\t{ 4, 19822, 4, 17840, },\n\t\t{ 4, 19747, 4, 17772, },\n\t} },\n\t{ 5320, {\n\t\t{ 4, 19710, 4, 17739, },\n\t\t{ 4, 19747, 4, 17772, },\n\t\t{ 4, 19673, 4, 17706, },\n\t} },\n\t{ 5500, {\n\t\t{ 4, 19065, 4, 17159, },\n\t\t{ 4, 19100, 4, 17190, },\n\t\t{ 4, 19030, 4, 17127, },\n\t} },\n\t{ 5520, {\n\t\t{ 4, 18996, 4, 17096, },\n\t\t{ 4, 19030, 4, 17127, },\n\t\t{ 4, 18962, 4, 17065, },\n\t} },\n\t{ 5540, {\n\t\t{ 4, 18927, 4, 17035, },\n\t\t{ 4, 18962, 4, 17065, },\n\t\t{ 4, 18893, 4, 17004, },\n\t} },\n\t{ 5560, {\n\t\t{ 4, 18859, 4, 16973, },\n\t\t{ 4, 18893, 4, 17004, },\n\t\t{ 4, 18825, 4, 16943, },\n\t} },\n\t{ 5580, {\n\t\t{ 4, 18792, 4, 16913, },\n\t\t{ 4, 18825, 4, 16943, },\n\t\t{ 4, 18758, 4, 16882, },\n\t} },\n\t{ 5600, {\n\t\t{ 4, 18725, 4, 16852, },\n\t\t{ 4, 18758, 4, 16882, },\n\t\t{ 4, 18691, 4, 16822, },\n\t} },\n\t{ 5620, {\n\t\t{ 4, 18658, 4, 16792, },\n\t\t{ 4, 18691, 4, 16822, },\n\t\t{ 4, 18625, 4, 16762, },\n\t} },\n\t{ 5640, {\n\t\t{ 4, 18592, 4, 16733, },\n\t\t{ 4, 18625, 4, 16762, },\n\t\t{ 4, 18559, 4, 16703, },\n\t} },\n\t{ 5660, {\n\t\t{ 4, 18526, 4, 16673, },\n\t\t{ 4, 18559, 4, 16703, },\n\t\t{ 4, 18493, 4, 16644, },\n\t} },\n\t{ 5680, {\n\t\t{ 4, 18461, 4, 16615, },\n\t\t{ 4, 18493, 4, 16644, },\n\t\t{ 4, 18428, 4, 16586, },\n\t} },\n\t{ 5700, {\n\t\t{ 4, 18396, 4, 16556, },\n\t\t{ 4, 18428, 4, 16586, },\n\t\t{ 4, 18364, 4, 16527, },\n\t} },\n\t{ 5745, {\n\t\t{ 4, 18252, 4, 16427, },\n\t\t{ 4, 18284, 4, 16455, },\n\t\t{ 4, 18220, 4, 16398, },\n\t} },\n\t{ 5765, {\n\t\t{ 4, 18189, 5, 32740, },\n\t\t{ 4, 18220, 4, 16398, },\n\t\t{ 4, 18157, 5, 32683, },\n\t} },\n\t{ 5785, {\n\t\t{ 4, 18126, 5, 32626, },\n\t\t{ 4, 18157, 5, 32683, },\n\t\t{ 4, 18094, 5, 32570, },\n\t} },\n\t{ 5805, {\n\t\t{ 4, 18063, 5, 32514, },\n\t\t{ 4, 18094, 5, 32570, },\n\t\t{ 4, 18032, 5, 32458, },\n\t} },\n\t{ 5825, {\n\t\t{ 4, 18001, 5, 32402, },\n\t\t{ 4, 18032, 5, 32458, },\n\t\t{ 4, 17970, 5, 32347, },\n\t} },\n\t{ 5170, {\n\t\t{ 4, 20282, 4, 18254, },\n\t\t{ 4, 20321, 4, 18289, },\n\t\t{ 4, 20243, 4, 18219, },\n\t} },\n\t{ 5190, {\n\t\t{ 4, 20204, 4, 18183, },\n\t\t{ 4, 20243, 4, 18219, },\n\t\t{ 4, 20165, 4, 18148, },\n\t} },\n\t{ 5210, {\n\t\t{ 4, 20126, 4, 18114, },\n\t\t{ 4, 20165, 4, 18148, },\n\t\t{ 4, 20088, 4, 18079, },\n\t} },\n\t{ 5230, {\n\t\t{ 4, 20049, 4, 18044, },\n\t\t{ 4, 20088, 4, 18079, },\n\t\t{ 4, 20011, 4, 18010, },\n\t} },\n};\n\nstatic int carl9170_init_rf_bank4_pwr(struct ar9170 *ar, bool band5ghz,\n\t\t\t\t      u32 freq, enum carl9170_bw bw)\n{\n\tint err;\n\tu32 d0, d1, td0, td1, fd0, fd1;\n\tu8 chansel;\n\tu8 refsel0 = 1, refsel1 = 0;\n\tu8 lf_synth = 0;\n\n\tswitch (bw) {\n\tcase CARL9170_BW_40_ABOVE:\n\t\tfreq += 10;\n\t\tbreak;\n\tcase CARL9170_BW_40_BELOW:\n\t\tfreq -= 10;\n\t\tbreak;\n\tcase CARL9170_BW_20:\n\t\tbreak;\n\tdefault:\n\t\tBUG();\n\t\treturn -ENOSYS;\n\t}\n\n\tif (band5ghz) {\n\t\tif (freq % 10) {\n\t\t\tchansel = (freq - 4800) / 5;\n\t\t} else {\n\t\t\tchansel = ((freq - 4800) / 10) * 2;\n\t\t\trefsel0 = 0;\n\t\t\trefsel1 = 1;\n\t\t}\n\t\tchansel = bitrev8(chansel);\n\t} else {\n\t\tif (freq == 2484) {\n\t\t\tchansel = 10 + (freq - 2274) / 5;\n\t\t\tlf_synth = 1;\n\t\t} else\n\t\t\tchansel = 16 + (freq - 2272) / 5;\n\t\tchansel *= 4;\n\t\tchansel = bitrev8(chansel);\n\t}\n\n\td1 =\tchansel;\n\td0 =\t0x21 |\n\t\trefsel0 << 3 |\n\t\trefsel1 << 2 |\n\t\tlf_synth << 1;\n\ttd0 =\td0 & 0x1f;\n\ttd1 =\td1 & 0x1f;\n\tfd0 =\ttd1 << 5 | td0;\n\n\ttd0 =\t(d0 >> 5) & 0x7;\n\ttd1 =\t(d1 >> 5) & 0x7;\n\tfd1 =\ttd1 << 5 | td0;\n\n\tcarl9170_regwrite_begin(ar);\n\n\tcarl9170_regwrite(0x1c58b0, fd0);\n\tcarl9170_regwrite(0x1c58e8, fd1);\n\n\tcarl9170_regwrite_finish();\n\terr = carl9170_regwrite_result();\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic const struct carl9170_phy_freq_params *\ncarl9170_get_hw_dyn_params(struct ieee80211_channel *channel,\n\t\t\t   enum carl9170_bw bw)\n{\n\tunsigned int chanidx = 0;\n\tu16 freq = 2412;\n\n\tif (channel) {\n\t\tchanidx = channel->hw_value;\n\t\tfreq = channel->center_freq;\n\t}\n\n\tBUG_ON(chanidx >= ARRAY_SIZE(carl9170_phy_freq_params));\n\n\tBUILD_BUG_ON(__CARL9170_NUM_BW != 3);\n\n\tWARN_ON(carl9170_phy_freq_params[chanidx].freq != freq);\n\n\treturn &carl9170_phy_freq_params[chanidx].params[bw];\n}\n\nstatic int carl9170_find_freq_idx(int nfreqs, u8 *freqs, u8 f)\n{\n\tint idx = nfreqs - 2;\n\n\twhile (idx >= 0) {\n\t\tif (f >= freqs[idx])\n\t\t\treturn idx;\n\t\tidx--;\n\t}\n\n\treturn 0;\n}\n\nstatic s32 carl9170_interpolate_s32(s32 x, s32 x1, s32 y1, s32 x2, s32 y2)\n{\n\t \n\tif (y2 == y1)\n\t\treturn y1;\n\n\t \n\tif (x == x1)\n\t\treturn y1;\n\tif (x == x2)\n\t\treturn y2;\n\n\t \n\tif (x2 == x1)\n\t\treturn y1;\n\n\treturn y1 + (((y2 - y1) * (x - x1)) / (x2 - x1));\n}\n\nstatic u8 carl9170_interpolate_u8(u8 x, u8 x1, u8 y1, u8 x2, u8 y2)\n{\n#define SHIFT\t\t8\n\ts32 y;\n\n\ty = carl9170_interpolate_s32(x << SHIFT, x1 << SHIFT,\n\t\ty1 << SHIFT, x2 << SHIFT, y2 << SHIFT);\n\n\t \n\treturn (y >> SHIFT) + ((y & (1 << (SHIFT - 1))) >> (SHIFT - 1));\n#undef SHIFT\n}\n\nstatic u8 carl9170_interpolate_val(u8 x, u8 *x_array, u8 *y_array)\n{\n\tint i;\n\n\tfor (i = 0; i < 3; i++) {\n\t\tif (x <= x_array[i + 1])\n\t\t\tbreak;\n\t}\n\n\treturn carl9170_interpolate_u8(x, x_array[i], y_array[i],\n\t\tx_array[i + 1], y_array[i + 1]);\n}\n\nstatic int carl9170_set_freq_cal_data(struct ar9170 *ar,\n\tstruct ieee80211_channel *channel)\n{\n\tu8 *cal_freq_pier;\n\tu8 vpds[2][AR5416_PD_GAIN_ICEPTS];\n\tu8 pwrs[2][AR5416_PD_GAIN_ICEPTS];\n\tint chain, idx, i;\n\tu32 phy_data = 0;\n\tu8 f, tmp;\n\n\tswitch (channel->band) {\n\tcase NL80211_BAND_2GHZ:\n\t\tf = channel->center_freq - 2300;\n\t\tcal_freq_pier = ar->eeprom.cal_freq_pier_2G;\n\t\ti = AR5416_NUM_2G_CAL_PIERS - 1;\n\t\tbreak;\n\n\tcase NL80211_BAND_5GHZ:\n\t\tf = (channel->center_freq - 4800) / 5;\n\t\tcal_freq_pier = ar->eeprom.cal_freq_pier_5G;\n\t\ti = AR5416_NUM_5G_CAL_PIERS - 1;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tfor (; i >= 0; i--) {\n\t\tif (cal_freq_pier[i] != 0xff)\n\t\t\tbreak;\n\t}\n\tif (i < 0)\n\t\treturn -EINVAL;\n\n\tidx = carl9170_find_freq_idx(i, cal_freq_pier, f);\n\n\tcarl9170_regwrite_begin(ar);\n\n\tfor (chain = 0; chain < AR5416_MAX_CHAINS; chain++) {\n\t\tfor (i = 0; i < AR5416_PD_GAIN_ICEPTS; i++) {\n\t\t\tstruct ar9170_calibration_data_per_freq *cal_pier_data;\n\t\t\tint j;\n\n\t\t\tswitch (channel->band) {\n\t\t\tcase NL80211_BAND_2GHZ:\n\t\t\t\tcal_pier_data = &ar->eeprom.\n\t\t\t\t\tcal_pier_data_2G[chain][idx];\n\t\t\t\tbreak;\n\n\t\t\tcase NL80211_BAND_5GHZ:\n\t\t\t\tcal_pier_data = &ar->eeprom.\n\t\t\t\t\tcal_pier_data_5G[chain][idx];\n\t\t\t\tbreak;\n\n\t\t\tdefault:\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\n\t\t\tfor (j = 0; j < 2; j++) {\n\t\t\t\tvpds[j][i] = carl9170_interpolate_u8(f,\n\t\t\t\t\tcal_freq_pier[idx],\n\t\t\t\t\tcal_pier_data->vpd_pdg[j][i],\n\t\t\t\t\tcal_freq_pier[idx + 1],\n\t\t\t\t\tcal_pier_data[1].vpd_pdg[j][i]);\n\n\t\t\t\tpwrs[j][i] = carl9170_interpolate_u8(f,\n\t\t\t\t\tcal_freq_pier[idx],\n\t\t\t\t\tcal_pier_data->pwr_pdg[j][i],\n\t\t\t\t\tcal_freq_pier[idx + 1],\n\t\t\t\t\tcal_pier_data[1].pwr_pdg[j][i]) / 2;\n\t\t\t}\n\t\t}\n\n\t\tfor (i = 0; i < 76; i++) {\n\t\t\tif (i < 25) {\n\t\t\t\ttmp = carl9170_interpolate_val(i, &pwrs[0][0],\n\t\t\t\t\t\t\t       &vpds[0][0]);\n\t\t\t} else {\n\t\t\t\ttmp = carl9170_interpolate_val(i - 12,\n\t\t\t\t\t\t\t       &pwrs[1][0],\n\t\t\t\t\t\t\t       &vpds[1][0]);\n\t\t\t}\n\n\t\t\tphy_data |= tmp << ((i & 3) << 3);\n\t\t\tif ((i & 3) == 3) {\n\t\t\t\tcarl9170_regwrite(0x1c6280 + chain * 0x1000 +\n\t\t\t\t\t\t  (i & ~3), phy_data);\n\t\t\t\tphy_data = 0;\n\t\t\t}\n\t\t}\n\n\t\tfor (i = 19; i < 32; i++)\n\t\t\tcarl9170_regwrite(0x1c6280 + chain * 0x1000 + (i << 2),\n\t\t\t\t\t  0x0);\n\t}\n\n\tcarl9170_regwrite_finish();\n\treturn carl9170_regwrite_result();\n}\n\nstatic u8 carl9170_get_max_edge_power(struct ar9170 *ar,\n\tu32 freq, struct ar9170_calctl_edges edges[])\n{\n\tint i;\n\tu8 rc = AR5416_MAX_RATE_POWER;\n\tu8 f;\n\tif (freq < 3000)\n\t\tf = freq - 2300;\n\telse\n\t\tf = (freq - 4800) / 5;\n\n\tfor (i = 0; i < AR5416_NUM_BAND_EDGES; i++) {\n\t\tif (edges[i].channel == 0xff)\n\t\t\tbreak;\n\t\tif (f == edges[i].channel) {\n\t\t\t \n\t\t\trc = edges[i].power_flags & ~AR9170_CALCTL_EDGE_FLAGS;\n\t\t\tbreak;\n\t\t}\n\t\tif (i > 0 && f < edges[i].channel) {\n\t\t\tif (f > edges[i - 1].channel &&\n\t\t\t    edges[i - 1].power_flags &\n\t\t\t    AR9170_CALCTL_EDGE_FLAGS) {\n\t\t\t\t \n\t\t\t\trc = edges[i - 1].power_flags &\n\t\t\t\t\t~AR9170_CALCTL_EDGE_FLAGS;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (i == AR5416_NUM_BAND_EDGES) {\n\t\tif (f > edges[i - 1].channel &&\n\t\t    edges[i - 1].power_flags & AR9170_CALCTL_EDGE_FLAGS) {\n\t\t\t \n\t\t\trc = edges[i - 1].power_flags &\n\t\t\t\t~AR9170_CALCTL_EDGE_FLAGS;\n\t\t}\n\t}\n\treturn rc;\n}\n\nstatic u8 carl9170_get_heavy_clip(struct ar9170 *ar, u32 freq,\n\tenum carl9170_bw bw, struct ar9170_calctl_edges edges[])\n{\n\tu8 f;\n\tint i;\n\tu8 rc = 0;\n\n\tif (freq < 3000)\n\t\tf = freq - 2300;\n\telse\n\t\tf = (freq - 4800) / 5;\n\n\tif (bw == CARL9170_BW_40_BELOW || bw == CARL9170_BW_40_ABOVE)\n\t\trc |= 0xf0;\n\n\tfor (i = 0; i < AR5416_NUM_BAND_EDGES; i++) {\n\t\tif (edges[i].channel == 0xff)\n\t\t\tbreak;\n\t\tif (f == edges[i].channel) {\n\t\t\tif (!(edges[i].power_flags & AR9170_CALCTL_EDGE_FLAGS))\n\t\t\t\trc |= 0x0f;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn rc;\n}\n\n \nstatic void carl9170_calc_ctl(struct ar9170 *ar, u32 freq, enum carl9170_bw bw)\n{\n\tu8 ctl_grp;  \n\tu8 ctl_idx;  \n\tint i, j;\n\tstruct ctl_modes {\n\t\tu8 ctl_mode;\n\t\tu8 max_power;\n\t\tu8 *pwr_cal_data;\n\t\tint pwr_cal_len;\n\t} *modes;\n\n\t \n\tstruct ctl_modes mode_list_2ghz[] = {\n\t\t{ CTL_11B, 0, ar->power_2G_cck, 4 },\n\t\t{ CTL_11G, 0, ar->power_2G_ofdm, 4 },\n\t\t{ CTL_2GHT20, 0, ar->power_2G_ht20, 8 },\n\t\t{ CTL_2GHT40, 0, ar->power_2G_ht40, 8 },\n\t};\n\tstruct ctl_modes mode_list_5ghz[] = {\n\t\t{ CTL_11A, 0, ar->power_5G_leg, 4 },\n\t\t{ CTL_5GHT20, 0, ar->power_5G_ht20, 8 },\n\t\t{ CTL_5GHT40, 0, ar->power_5G_ht40, 8 },\n\t};\n\tint nr_modes;\n\n#define EDGES(c, n) (ar->eeprom.ctl_data[c].control_edges[n])\n\n\tar->heavy_clip = 0;\n\n\t \n\tctl_grp = ath_regd_get_band_ctl(&ar->common.regulatory,\n\t\t\t\t\tar->hw->conf.chandef.chan->band);\n\n\t \n\tif (ctl_grp == NO_CTL || ctl_grp == SD_NO_CTL)\n\t\tctl_grp = CTL_FCC;\n\n\tif (ctl_grp != CTL_FCC)\n\t\t \n\t\treturn;\n\n\tif (ar->hw->conf.chandef.chan->band == NL80211_BAND_2GHZ) {\n\t\tmodes = mode_list_2ghz;\n\t\tnr_modes = ARRAY_SIZE(mode_list_2ghz);\n\t} else {\n\t\tmodes = mode_list_5ghz;\n\t\tnr_modes = ARRAY_SIZE(mode_list_5ghz);\n\t}\n\n\tfor (i = 0; i < nr_modes; i++) {\n\t\tu8 c = ctl_grp | modes[i].ctl_mode;\n\t\tfor (ctl_idx = 0; ctl_idx < AR5416_NUM_CTLS; ctl_idx++)\n\t\t\tif (c == ar->eeprom.ctl_index[ctl_idx])\n\t\t\t\tbreak;\n\t\tif (ctl_idx < AR5416_NUM_CTLS) {\n\t\t\tint f_off = 0;\n\n\t\t\t \n\t\t\tif (modes[i].ctl_mode == CTL_11G) {\n\t\t\t\tar->heavy_clip =\n\t\t\t\t\tcarl9170_get_heavy_clip(ar,\n\t\t\t\t\t\tfreq, bw, EDGES(ctl_idx, 1));\n\t\t\t}\n\n\t\t\t \n\t\t\tif (modes[i].ctl_mode == CTL_2GHT40 ||\n\t\t\t    modes[i].ctl_mode == CTL_5GHT40) {\n\t\t\t\tif (bw == CARL9170_BW_40_BELOW)\n\t\t\t\t\tf_off = -10;\n\t\t\t\telse\n\t\t\t\t\tf_off = 10;\n\t\t\t}\n\n\t\t\tmodes[i].max_power =\n\t\t\t\tcarl9170_get_max_edge_power(ar,\n\t\t\t\t\tfreq + f_off, EDGES(ctl_idx, 1));\n\n\t\t\t \n\n\t\t} else {\n\t\t\t \n\t\t\tint k = i;\n\n\t\t\tmodes[i].max_power = AR5416_MAX_RATE_POWER;\n\t\t\twhile (k-- > 0) {\n\t\t\t\tif (modes[k].max_power !=\n\t\t\t\t    AR5416_MAX_RATE_POWER) {\n\t\t\t\t\tmodes[i].max_power = modes[k].max_power;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tfor (j = 0; j < modes[i].pwr_cal_len; j++) {\n\t\t\tmodes[i].pwr_cal_data[j] = min(modes[i].pwr_cal_data[j],\n\t\t\t\t\t\t       modes[i].max_power);\n\t\t}\n\t}\n\n\tif (ar->heavy_clip & 0xf0) {\n\t\tar->power_2G_ht40[0]--;\n\t\tar->power_2G_ht40[1]--;\n\t\tar->power_2G_ht40[2]--;\n\t}\n\tif (ar->heavy_clip & 0xf) {\n\t\tar->power_2G_ht20[0]++;\n\t\tar->power_2G_ht20[1]++;\n\t\tar->power_2G_ht20[2]++;\n\t}\n\n#undef EDGES\n}\n\nstatic void carl9170_set_power_cal(struct ar9170 *ar, u32 freq,\n\t\t\t\t   enum carl9170_bw bw)\n{\n\tstruct ar9170_calibration_target_power_legacy *ctpl;\n\tstruct ar9170_calibration_target_power_ht *ctph;\n\tu8 *ctpres;\n\tint ntargets;\n\tint idx, i, n;\n\tu8 f;\n\tu8 pwr_freqs[AR5416_MAX_NUM_TGT_PWRS];\n\n\tif (freq < 3000)\n\t\tf = freq - 2300;\n\telse\n\t\tf = (freq - 4800) / 5;\n\n\t \n\tfor (i = 0; i < 3; i++) {\n\t\tswitch (i) {\n\t\tcase 0:  \n\t\t\tctpl = &ar->eeprom.cal_tgt_pwr_5G[0];\n\t\t\tntargets = AR5416_NUM_5G_TARGET_PWRS;\n\t\t\tctpres = ar->power_5G_leg;\n\t\t\tbreak;\n\t\tcase 1:  \n\t\t\tctpl = &ar->eeprom.cal_tgt_pwr_2G_cck[0];\n\t\t\tntargets = AR5416_NUM_2G_CCK_TARGET_PWRS;\n\t\t\tctpres = ar->power_2G_cck;\n\t\t\tbreak;\n\t\tcase 2:  \n\t\t\tctpl = &ar->eeprom.cal_tgt_pwr_2G_ofdm[0];\n\t\t\tntargets = AR5416_NUM_2G_OFDM_TARGET_PWRS;\n\t\t\tctpres = ar->power_2G_ofdm;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tBUG();\n\t\t}\n\n\t\tfor (n = 0; n < ntargets; n++) {\n\t\t\tif (ctpl[n].freq == 0xff)\n\t\t\t\tbreak;\n\t\t\tpwr_freqs[n] = ctpl[n].freq;\n\t\t}\n\t\tntargets = n;\n\t\tidx = carl9170_find_freq_idx(ntargets, pwr_freqs, f);\n\t\tfor (n = 0; n < 4; n++)\n\t\t\tctpres[n] = carl9170_interpolate_u8(f,\n\t\t\t\tctpl[idx + 0].freq, ctpl[idx + 0].power[n],\n\t\t\t\tctpl[idx + 1].freq, ctpl[idx + 1].power[n]);\n\t}\n\n\t \n\tfor (i = 0; i < 4; i++) {\n\t\tswitch (i) {\n\t\tcase 0:  \n\t\t\tctph = &ar->eeprom.cal_tgt_pwr_5G_ht20[0];\n\t\t\tntargets = AR5416_NUM_5G_TARGET_PWRS;\n\t\t\tctpres = ar->power_5G_ht20;\n\t\t\tbreak;\n\t\tcase 1:  \n\t\t\tctph = &ar->eeprom.cal_tgt_pwr_5G_ht40[0];\n\t\t\tntargets = AR5416_NUM_5G_TARGET_PWRS;\n\t\t\tctpres = ar->power_5G_ht40;\n\t\t\tbreak;\n\t\tcase 2:  \n\t\t\tctph = &ar->eeprom.cal_tgt_pwr_2G_ht20[0];\n\t\t\tntargets = AR5416_NUM_2G_OFDM_TARGET_PWRS;\n\t\t\tctpres = ar->power_2G_ht20;\n\t\t\tbreak;\n\t\tcase 3:  \n\t\t\tctph = &ar->eeprom.cal_tgt_pwr_2G_ht40[0];\n\t\t\tntargets = AR5416_NUM_2G_OFDM_TARGET_PWRS;\n\t\t\tctpres = ar->power_2G_ht40;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tBUG();\n\t\t}\n\n\t\tfor (n = 0; n < ntargets; n++) {\n\t\t\tif (ctph[n].freq == 0xff)\n\t\t\t\tbreak;\n\t\t\tpwr_freqs[n] = ctph[n].freq;\n\t\t}\n\t\tntargets = n;\n\t\tidx = carl9170_find_freq_idx(ntargets, pwr_freqs, f);\n\t\tfor (n = 0; n < 8; n++)\n\t\t\tctpres[n] = carl9170_interpolate_u8(f,\n\t\t\t\tctph[idx + 0].freq, ctph[idx + 0].power[n],\n\t\t\t\tctph[idx + 1].freq, ctph[idx + 1].power[n]);\n\t}\n\n\t \n\tcarl9170_calc_ctl(ar, freq, bw);\n}\n\nint carl9170_get_noisefloor(struct ar9170 *ar)\n{\n\tstatic const u32 phy_regs[] = {\n\t\tAR9170_PHY_REG_CCA, AR9170_PHY_REG_CH2_CCA,\n\t\tAR9170_PHY_REG_EXT_CCA, AR9170_PHY_REG_CH2_EXT_CCA };\n\tu32 phy_res[ARRAY_SIZE(phy_regs)];\n\tint err, i;\n\n\tBUILD_BUG_ON(ARRAY_SIZE(phy_regs) != ARRAY_SIZE(ar->noise));\n\n\terr = carl9170_read_mreg(ar, ARRAY_SIZE(phy_regs), phy_regs, phy_res);\n\tif (err)\n\t\treturn err;\n\n\tfor (i = 0; i < 2; i++) {\n\t\tar->noise[i] = sign_extend32(GET_VAL(\n\t\t\tAR9170_PHY_CCA_MIN_PWR, phy_res[i]), 8);\n\n\t\tar->noise[i + 2] = sign_extend32(GET_VAL(\n\t\t\tAR9170_PHY_EXT_CCA_MIN_PWR, phy_res[i + 2]), 8);\n\t}\n\n\tif (ar->channel)\n\t\tar->survey[ar->channel->hw_value].noise = ar->noise[0];\n\n\treturn 0;\n}\n\nstatic enum carl9170_bw nl80211_to_carl(enum nl80211_channel_type type)\n{\n\tswitch (type) {\n\tcase NL80211_CHAN_NO_HT:\n\tcase NL80211_CHAN_HT20:\n\t\treturn CARL9170_BW_20;\n\tcase NL80211_CHAN_HT40MINUS:\n\t\treturn CARL9170_BW_40_BELOW;\n\tcase NL80211_CHAN_HT40PLUS:\n\t\treturn CARL9170_BW_40_ABOVE;\n\tdefault:\n\t\tBUG();\n\t}\n}\n\nint carl9170_set_channel(struct ar9170 *ar, struct ieee80211_channel *channel,\n\t\t\t enum nl80211_channel_type _bw)\n{\n\tconst struct carl9170_phy_freq_params *freqpar;\n\tstruct carl9170_rf_init_result rf_res;\n\tstruct carl9170_rf_init rf;\n\tu32 tmp, offs = 0, new_ht = 0;\n\tint err;\n\tenum carl9170_bw bw;\n\tstruct ieee80211_channel *old_channel = NULL;\n\n\tbw = nl80211_to_carl(_bw);\n\n\tif (conf_is_ht(&ar->hw->conf))\n\t\tnew_ht |= CARL9170FW_PHY_HT_ENABLE;\n\n\tif (conf_is_ht40(&ar->hw->conf))\n\t\tnew_ht |= CARL9170FW_PHY_HT_DYN2040;\n\n\t \n\tif (ar->channel) {\n\t\told_channel = ar->channel;\n\t\tar->channel = NULL;\n\t}\n\n\t \n\terr = carl9170_write_reg(ar, AR9170_PWR_REG_RESET,\n\t\t\t\t AR9170_PWR_RESET_BB_COLD_RESET);\n\tif (err)\n\t\treturn err;\n\n\terr = carl9170_write_reg(ar, AR9170_PWR_REG_RESET, 0x0);\n\tif (err)\n\t\treturn err;\n\n\terr = carl9170_init_phy(ar, channel->band);\n\tif (err)\n\t\treturn err;\n\n\terr = carl9170_init_rf_banks_0_7(ar,\n\t\t\t\t\t channel->band == NL80211_BAND_5GHZ);\n\tif (err)\n\t\treturn err;\n\n\terr = carl9170_exec_cmd(ar, CARL9170_CMD_FREQ_START, 0, NULL, 0, NULL);\n\tif (err)\n\t\treturn err;\n\n\terr = carl9170_write_reg(ar, AR9170_PHY_REG_HEAVY_CLIP_ENABLE,\n\t\t\t\t 0x200);\n\tif (err)\n\t\treturn err;\n\n\terr = carl9170_init_rf_bank4_pwr(ar,\n\t\t\t\t\t channel->band == NL80211_BAND_5GHZ,\n\t\t\t\t\t channel->center_freq, bw);\n\tif (err)\n\t\treturn err;\n\n\ttmp = AR9170_PHY_TURBO_FC_SINGLE_HT_LTF1 |\n\t      AR9170_PHY_TURBO_FC_HT_EN;\n\n\tswitch (bw) {\n\tcase CARL9170_BW_20:\n\t\tbreak;\n\tcase CARL9170_BW_40_BELOW:\n\t\ttmp |= AR9170_PHY_TURBO_FC_DYN2040_EN |\n\t\t       AR9170_PHY_TURBO_FC_SHORT_GI_40;\n\t\toffs = 3;\n\t\tbreak;\n\tcase CARL9170_BW_40_ABOVE:\n\t\ttmp |= AR9170_PHY_TURBO_FC_DYN2040_EN |\n\t\t       AR9170_PHY_TURBO_FC_SHORT_GI_40 |\n\t\t       AR9170_PHY_TURBO_FC_DYN2040_PRI_CH;\n\t\toffs = 1;\n\t\tbreak;\n\tdefault:\n\t\tBUG();\n\t\treturn -ENOSYS;\n\t}\n\n\tif (ar->eeprom.tx_mask != 1)\n\t\ttmp |= AR9170_PHY_TURBO_FC_WALSH;\n\n\terr = carl9170_write_reg(ar, AR9170_PHY_REG_TURBO, tmp);\n\tif (err)\n\t\treturn err;\n\n\terr = carl9170_set_freq_cal_data(ar, channel);\n\tif (err)\n\t\treturn err;\n\n\tcarl9170_set_power_cal(ar, channel->center_freq, bw);\n\n\terr = carl9170_set_mac_tpc(ar, channel);\n\tif (err)\n\t\treturn err;\n\n\tfreqpar = carl9170_get_hw_dyn_params(channel, bw);\n\n\trf.ht_settings = new_ht;\n\tif (conf_is_ht40(&ar->hw->conf))\n\t\tSET_VAL(CARL9170FW_PHY_HT_EXT_CHAN_OFF, rf.ht_settings, offs);\n\n\trf.freq = cpu_to_le32(channel->center_freq * 1000);\n\trf.delta_slope_coeff_exp = cpu_to_le32(freqpar->coeff_exp);\n\trf.delta_slope_coeff_man = cpu_to_le32(freqpar->coeff_man);\n\trf.delta_slope_coeff_exp_shgi = cpu_to_le32(freqpar->coeff_exp_shgi);\n\trf.delta_slope_coeff_man_shgi = cpu_to_le32(freqpar->coeff_man_shgi);\n\trf.finiteLoopCount = cpu_to_le32(2000);\n\terr = carl9170_exec_cmd(ar, CARL9170_CMD_RF_INIT, sizeof(rf), &rf,\n\t\t\t\tsizeof(rf_res), &rf_res);\n\tif (err)\n\t\treturn err;\n\n\terr = le32_to_cpu(rf_res.ret);\n\tif (err != 0) {\n\t\tar->chan_fail++;\n\t\tar->total_chan_fail++;\n\n\t\twiphy_err(ar->hw->wiphy, \"channel change: %d -> %d \"\n\t\t\t  \"failed (%d).\\n\", old_channel ?\n\t\t\t  old_channel->center_freq : -1, channel->center_freq,\n\t\t\t  err);\n\n\t\tif (ar->chan_fail > 3) {\n\t\t\t \n\t\t\tcarl9170_restart(ar, CARL9170_RR_TOO_MANY_PHY_ERRORS);\n\t\t\treturn 0;\n\t\t}\n\n\t\terr = carl9170_set_channel(ar, channel, _bw);\n\t\tif (err)\n\t\t\treturn err;\n\t} else {\n\t\tar->chan_fail = 0;\n\t}\n\n\tif (ar->heavy_clip) {\n\t\terr = carl9170_write_reg(ar, AR9170_PHY_REG_HEAVY_CLIP_ENABLE,\n\t\t\t\t\t 0x200 | ar->heavy_clip);\n\t\tif (err) {\n\t\t\tif (net_ratelimit()) {\n\t\t\t\twiphy_err(ar->hw->wiphy, \"failed to set \"\n\t\t\t\t       \"heavy clip\\n\");\n\t\t\t}\n\n\t\t\treturn err;\n\t\t}\n\t}\n\n\tar->channel = channel;\n\tar->ht_settings = new_ht;\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}