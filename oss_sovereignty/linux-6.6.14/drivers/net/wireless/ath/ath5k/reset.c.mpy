{
  "module_name": "reset.c",
  "hash_id": "9b149e3147faa1817748bba918a897d4ba3a51520e1c8621863cef199879c2a3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath5k/reset.c",
  "human_readable_source": " \n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <asm/unaligned.h>\n\n#include <linux/pci.h>\t\t \n#include <linux/log2.h>\n#include <linux/platform_device.h>\n#include \"ath5k.h\"\n#include \"reg.h\"\n#include \"debug.h\"\n\n\n \n\n\n \n\n \nint\nath5k_hw_register_timeout(struct ath5k_hw *ah, u32 reg, u32 flag, u32 val,\n\t\t\t      bool is_set)\n{\n\tint i;\n\tu32 data;\n\n\tfor (i = AR5K_TUNE_REGISTER_TIMEOUT; i > 0; i--) {\n\t\tdata = ath5k_hw_reg_read(ah, reg);\n\t\tif (is_set && (data & flag))\n\t\t\tbreak;\n\t\telse if ((data & flag) == val)\n\t\t\tbreak;\n\t\tudelay(15);\n\t}\n\n\treturn (i <= 0) ? -EAGAIN : 0;\n}\n\n\n \n\n \nunsigned int\nath5k_hw_htoclock(struct ath5k_hw *ah, unsigned int usec)\n{\n\tstruct ath_common *common = ath5k_hw_common(ah);\n\treturn usec * common->clockrate;\n}\n\n \nunsigned int\nath5k_hw_clocktoh(struct ath5k_hw *ah, unsigned int clock)\n{\n\tstruct ath_common *common = ath5k_hw_common(ah);\n\treturn clock / common->clockrate;\n}\n\n \nstatic void\nath5k_hw_init_core_clock(struct ath5k_hw *ah)\n{\n\tstruct ieee80211_channel *channel = ah->ah_current_channel;\n\tstruct ath_common *common = ath5k_hw_common(ah);\n\tu32 usec_reg, txlat, rxlat, usec, clock, sclock, txf2txs;\n\n\t \n\tswitch (channel->hw_value) {\n\tcase AR5K_MODE_11A:\n\t\tclock = 40;\n\t\tbreak;\n\tcase AR5K_MODE_11B:\n\t\tclock = 22;\n\t\tbreak;\n\tcase AR5K_MODE_11G:\n\tdefault:\n\t\tclock = 44;\n\t\tbreak;\n\t}\n\n\t \n\tswitch (ah->ah_bwmode) {\n\tcase AR5K_BWMODE_40MHZ:\n\t\tclock *= 2;\n\t\tbreak;\n\tcase AR5K_BWMODE_10MHZ:\n\t\tclock /= 2;\n\t\tbreak;\n\tcase AR5K_BWMODE_5MHZ:\n\t\tclock /= 4;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tcommon->clockrate = clock;\n\n\t \n\t \n\tusec = clock - 1;\n\tusec = AR5K_REG_SM(usec, AR5K_USEC_1);\n\n\t \n\tif (ah->ah_version != AR5K_AR5210)\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_DCU_GBL_IFS_MISC,\n\t\t\t\t\tAR5K_DCU_GBL_IFS_MISC_USEC_DUR,\n\t\t\t\t\tclock);\n\n\t \n\tif ((ah->ah_radio == AR5K_RF5112) ||\n\t    (ah->ah_radio == AR5K_RF2413) ||\n\t    (ah->ah_radio == AR5K_RF5413) ||\n\t    (ah->ah_radio == AR5K_RF2316) ||\n\t    (ah->ah_radio == AR5K_RF2317))\n\t\t \n\t\tsclock = 40 - 1;\n\telse\n\t\tsclock = 32 - 1;\n\tsclock = AR5K_REG_SM(sclock, AR5K_USEC_32);\n\n\t \n\tusec_reg = ath5k_hw_reg_read(ah, AR5K_USEC_5211);\n\ttxlat = AR5K_REG_MS(usec_reg, AR5K_USEC_TX_LATENCY_5211);\n\trxlat = AR5K_REG_MS(usec_reg, AR5K_USEC_RX_LATENCY_5211);\n\n\t \n\ttxf2txs = AR5K_INIT_TXF2TXD_START_DEFAULT;\n\n\t \n\tif (ah->ah_version == AR5K_AR5210) {\n\t\t \n\t\ttxlat = AR5K_INIT_TX_LATENCY_5210;\n\t\trxlat = AR5K_INIT_RX_LATENCY_5210;\n\t}\n\n\tif (ah->ah_mac_srev < AR5K_SREV_AR5211) {\n\t\t \n\t\ttxlat = AR5K_REG_SM(txlat, AR5K_USEC_TX_LATENCY_5210);\n\t\trxlat = AR5K_REG_SM(rxlat, AR5K_USEC_RX_LATENCY_5210);\n\t} else\n\tswitch (ah->ah_bwmode) {\n\tcase AR5K_BWMODE_10MHZ:\n\t\ttxlat = AR5K_REG_SM(txlat * 2,\n\t\t\t\tAR5K_USEC_TX_LATENCY_5211);\n\t\trxlat = AR5K_REG_SM(AR5K_INIT_RX_LAT_MAX,\n\t\t\t\tAR5K_USEC_RX_LATENCY_5211);\n\t\ttxf2txs = AR5K_INIT_TXF2TXD_START_DELAY_10MHZ;\n\t\tbreak;\n\tcase AR5K_BWMODE_5MHZ:\n\t\ttxlat = AR5K_REG_SM(txlat * 4,\n\t\t\t\tAR5K_USEC_TX_LATENCY_5211);\n\t\trxlat = AR5K_REG_SM(AR5K_INIT_RX_LAT_MAX,\n\t\t\t\tAR5K_USEC_RX_LATENCY_5211);\n\t\ttxf2txs = AR5K_INIT_TXF2TXD_START_DELAY_5MHZ;\n\t\tbreak;\n\tcase AR5K_BWMODE_40MHZ:\n\t\ttxlat = AR5K_INIT_TX_LAT_MIN;\n\t\trxlat = AR5K_REG_SM(rxlat / 2,\n\t\t\t\tAR5K_USEC_RX_LATENCY_5211);\n\t\ttxf2txs = AR5K_INIT_TXF2TXD_START_DEFAULT;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tusec_reg = (usec | sclock | txlat | rxlat);\n\tath5k_hw_reg_write(ah, usec_reg, AR5K_USEC);\n\n\t \n\tif (ah->ah_radio == AR5K_RF5112) {\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_RF_CTL2,\n\t\t\t\t\tAR5K_PHY_RF_CTL2_TXF2TXD_START,\n\t\t\t\t\ttxf2txs);\n\t}\n}\n\n \nstatic void\nath5k_hw_set_sleep_clock(struct ath5k_hw *ah, bool enable)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu32 scal, spending, sclock;\n\n\t \n\tif ((AR5K_EEPROM_HAS32KHZCRYSTAL(ee->ee_misc1) ||\n\tAR5K_EEPROM_HAS32KHZCRYSTAL_OLD(ee->ee_misc1)) &&\n\tenable) {\n\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_USEC_5211, AR5K_USEC_32, 1);\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_TSF_PARM, AR5K_TSF_PARM_INC, 61);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, 0x1f, AR5K_PHY_SCR);\n\n\t\tif ((ah->ah_radio == AR5K_RF5112) ||\n\t\t(ah->ah_radio == AR5K_RF5413) ||\n\t\t(ah->ah_radio == AR5K_RF2316) ||\n\t\t(ah->ah_mac_version == (AR5K_SREV_AR2417 >> 4)))\n\t\t\tspending = 0x14;\n\t\telse\n\t\t\tspending = 0x18;\n\t\tath5k_hw_reg_write(ah, spending, AR5K_PHY_SPENDING);\n\n\t\tif ((ah->ah_radio == AR5K_RF5112) ||\n\t\t(ah->ah_radio == AR5K_RF5413) ||\n\t\t(ah->ah_mac_version == (AR5K_SREV_AR2417 >> 4))) {\n\t\t\tath5k_hw_reg_write(ah, 0x26, AR5K_PHY_SLMT);\n\t\t\tath5k_hw_reg_write(ah, 0x0d, AR5K_PHY_SCAL);\n\t\t\tath5k_hw_reg_write(ah, 0x07, AR5K_PHY_SCLOCK);\n\t\t\tath5k_hw_reg_write(ah, 0x3f, AR5K_PHY_SDELAY);\n\t\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PCICFG,\n\t\t\t\tAR5K_PCICFG_SLEEP_CLOCK_RATE, 0x02);\n\t\t} else {\n\t\t\tath5k_hw_reg_write(ah, 0x0a, AR5K_PHY_SLMT);\n\t\t\tath5k_hw_reg_write(ah, 0x0c, AR5K_PHY_SCAL);\n\t\t\tath5k_hw_reg_write(ah, 0x03, AR5K_PHY_SCLOCK);\n\t\t\tath5k_hw_reg_write(ah, 0x20, AR5K_PHY_SDELAY);\n\t\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PCICFG,\n\t\t\t\tAR5K_PCICFG_SLEEP_CLOCK_RATE, 0x03);\n\t\t}\n\n\t\t \n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PCICFG,\n\t\t\t\tAR5K_PCICFG_SLEEP_CLOCK_EN);\n\n\t} else {\n\n\t\t \n\t\tAR5K_REG_DISABLE_BITS(ah, AR5K_PCICFG,\n\t\t\t\tAR5K_PCICFG_SLEEP_CLOCK_EN);\n\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PCICFG,\n\t\t\t\tAR5K_PCICFG_SLEEP_CLOCK_RATE, 0);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, 0x1f, AR5K_PHY_SCR);\n\t\tath5k_hw_reg_write(ah, AR5K_PHY_SLMT_32MHZ, AR5K_PHY_SLMT);\n\n\t\tif (ah->ah_mac_version == (AR5K_SREV_AR2417 >> 4))\n\t\t\tscal = AR5K_PHY_SCAL_32MHZ_2417;\n\t\telse if (ee->ee_is_hb63)\n\t\t\tscal = AR5K_PHY_SCAL_32MHZ_HB63;\n\t\telse\n\t\t\tscal = AR5K_PHY_SCAL_32MHZ;\n\t\tath5k_hw_reg_write(ah, scal, AR5K_PHY_SCAL);\n\n\t\tath5k_hw_reg_write(ah, AR5K_PHY_SCLOCK_32MHZ, AR5K_PHY_SCLOCK);\n\t\tath5k_hw_reg_write(ah, AR5K_PHY_SDELAY_32MHZ, AR5K_PHY_SDELAY);\n\n\t\tif ((ah->ah_radio == AR5K_RF5112) ||\n\t\t(ah->ah_radio == AR5K_RF5413) ||\n\t\t(ah->ah_radio == AR5K_RF2316) ||\n\t\t(ah->ah_mac_version == (AR5K_SREV_AR2417 >> 4)))\n\t\t\tspending = 0x14;\n\t\telse\n\t\t\tspending = 0x18;\n\t\tath5k_hw_reg_write(ah, spending, AR5K_PHY_SPENDING);\n\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_TSF_PARM, AR5K_TSF_PARM_INC, 1);\n\n\t\tif ((ah->ah_radio == AR5K_RF5112) ||\n\t\t\t(ah->ah_radio == AR5K_RF5413) ||\n\t\t\t(ah->ah_radio == AR5K_RF2316) ||\n\t\t\t(ah->ah_radio == AR5K_RF2317))\n\t\t\tsclock = 40 - 1;\n\t\telse\n\t\t\tsclock = 32 - 1;\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_USEC_5211, AR5K_USEC_32, sclock);\n\t}\n}\n\n\n \n\n \nstatic int\nath5k_hw_nic_reset(struct ath5k_hw *ah, u32 val)\n{\n\tint ret;\n\tu32 mask = val ? val : ~0U;\n\n\t \n\tath5k_hw_reg_read(ah, AR5K_RXDP);\n\n\t \n\tath5k_hw_reg_write(ah, val, AR5K_RESET_CTL);\n\n\t \n\tusleep_range(15, 20);\n\n\tif (ah->ah_version == AR5K_AR5210) {\n\t\tval &= AR5K_RESET_CTL_PCU | AR5K_RESET_CTL_DMA\n\t\t\t| AR5K_RESET_CTL_MAC | AR5K_RESET_CTL_PHY;\n\t\tmask &= AR5K_RESET_CTL_PCU | AR5K_RESET_CTL_DMA\n\t\t\t| AR5K_RESET_CTL_MAC | AR5K_RESET_CTL_PHY;\n\t} else {\n\t\tval &= AR5K_RESET_CTL_PCU | AR5K_RESET_CTL_BASEBAND;\n\t\tmask &= AR5K_RESET_CTL_PCU | AR5K_RESET_CTL_BASEBAND;\n\t}\n\n\tret = ath5k_hw_register_timeout(ah, AR5K_RESET_CTL, mask, val, false);\n\n\t \n\tif ((val & AR5K_RESET_CTL_PCU) == 0)\n\t\tath5k_hw_reg_write(ah, AR5K_INIT_CFG, AR5K_CFG);\n\n\treturn ret;\n}\n\n \nstatic int\nath5k_hw_wisoc_reset(struct ath5k_hw *ah, u32 flags)\n{\n\tu32 mask = flags ? flags : ~0U;\n\tu32 __iomem *reg;\n\tu32 regval;\n\tu32 val = 0;\n\n\t \n\tif (ah->devid >= AR5K_SREV_AR2315_R6) {\n\t\treg = (u32 __iomem *) AR5K_AR2315_RESET;\n\t\tif (mask & AR5K_RESET_CTL_PCU)\n\t\t\tval |= AR5K_AR2315_RESET_WMAC;\n\t\tif (mask & AR5K_RESET_CTL_BASEBAND)\n\t\t\tval |= AR5K_AR2315_RESET_BB_WARM;\n\t} else {\n\t\treg = (u32 __iomem *) AR5K_AR5312_RESET;\n\t\tif (to_platform_device(ah->dev)->id == 0) {\n\t\t\tif (mask & AR5K_RESET_CTL_PCU)\n\t\t\t\tval |= AR5K_AR5312_RESET_WMAC0;\n\t\t\tif (mask & AR5K_RESET_CTL_BASEBAND)\n\t\t\t\tval |= AR5K_AR5312_RESET_BB0_COLD |\n\t\t\t\t       AR5K_AR5312_RESET_BB0_WARM;\n\t\t} else {\n\t\t\tif (mask & AR5K_RESET_CTL_PCU)\n\t\t\t\tval |= AR5K_AR5312_RESET_WMAC1;\n\t\t\tif (mask & AR5K_RESET_CTL_BASEBAND)\n\t\t\t\tval |= AR5K_AR5312_RESET_BB1_COLD |\n\t\t\t\t       AR5K_AR5312_RESET_BB1_WARM;\n\t\t}\n\t}\n\n\t \n\tregval = ioread32(reg);\n\tiowrite32(regval | val, reg);\n\tregval = ioread32(reg);\n\tudelay(100);\t \n\n\t \n\tiowrite32(regval & ~val, reg);\n\tregval = ioread32(reg);\n\n\t \n\tif ((flags & AR5K_RESET_CTL_PCU) == 0)\n\t\tath5k_hw_reg_write(ah, AR5K_INIT_CFG, AR5K_CFG);\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_hw_set_power_mode(struct ath5k_hw *ah, enum ath5k_power_mode mode,\n\t\t\t      bool set_chip, u16 sleep_duration)\n{\n\tunsigned int i;\n\tu32 staid, data;\n\n\tstaid = ath5k_hw_reg_read(ah, AR5K_STA_ID1);\n\n\tswitch (mode) {\n\tcase AR5K_PM_AUTO:\n\t\tstaid &= ~AR5K_STA_ID1_DEFAULT_ANTENNA;\n\t\tfallthrough;\n\tcase AR5K_PM_NETWORK_SLEEP:\n\t\tif (set_chip)\n\t\t\tath5k_hw_reg_write(ah,\n\t\t\t\tAR5K_SLEEP_CTL_SLE_ALLOW |\n\t\t\t\tsleep_duration,\n\t\t\t\tAR5K_SLEEP_CTL);\n\n\t\tstaid |= AR5K_STA_ID1_PWR_SV;\n\t\tbreak;\n\n\tcase AR5K_PM_FULL_SLEEP:\n\t\tif (set_chip)\n\t\t\tath5k_hw_reg_write(ah, AR5K_SLEEP_CTL_SLE_SLP,\n\t\t\t\tAR5K_SLEEP_CTL);\n\n\t\tstaid |= AR5K_STA_ID1_PWR_SV;\n\t\tbreak;\n\n\tcase AR5K_PM_AWAKE:\n\n\t\tstaid &= ~AR5K_STA_ID1_PWR_SV;\n\n\t\tif (!set_chip)\n\t\t\tgoto commit;\n\n\t\tdata = ath5k_hw_reg_read(ah, AR5K_SLEEP_CTL);\n\n\t\t \n\t\tif (data & 0xffc00000)\n\t\t\tdata = 0;\n\t\telse\n\t\t\t \n\t\t\tdata = data & ~AR5K_SLEEP_CTL_SLE;\n\n\t\tath5k_hw_reg_write(ah, data | AR5K_SLEEP_CTL_SLE_WAKE,\n\t\t\t\t\t\t\tAR5K_SLEEP_CTL);\n\t\tusleep_range(15, 20);\n\n\t\tfor (i = 200; i > 0; i--) {\n\t\t\t \n\t\t\tif ((ath5k_hw_reg_read(ah, AR5K_PCICFG) &\n\t\t\t\t\tAR5K_PCICFG_SPWR_DN) == 0)\n\t\t\t\tbreak;\n\n\t\t\t \n\t\t\tusleep_range(50, 75);\n\t\t\tath5k_hw_reg_write(ah, data | AR5K_SLEEP_CTL_SLE_WAKE,\n\t\t\t\t\t\t\tAR5K_SLEEP_CTL);\n\t\t}\n\n\t\t \n\t\tif (i == 0)\n\t\t\treturn -EIO;\n\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\ncommit:\n\tath5k_hw_reg_write(ah, staid, AR5K_STA_ID1);\n\n\treturn 0;\n}\n\n \nint\nath5k_hw_on_hold(struct ath5k_hw *ah)\n{\n\tstruct pci_dev *pdev = ah->pdev;\n\tu32 bus_flags;\n\tint ret;\n\n\tif (ath5k_get_bus_type(ah) == ATH_AHB)\n\t\treturn 0;\n\n\t \n\tret = ath5k_hw_set_power_mode(ah, AR5K_PM_AWAKE, true, 0);\n\tif (ret) {\n\t\tATH5K_ERR(ah, \"failed to wakeup the MAC Chip\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tbus_flags = (pdev && pci_is_pcie(pdev)) ? 0 : AR5K_RESET_CTL_PCI;\n\n\tif (ah->ah_version == AR5K_AR5210) {\n\t\tret = ath5k_hw_nic_reset(ah, AR5K_RESET_CTL_PCU |\n\t\t\tAR5K_RESET_CTL_MAC | AR5K_RESET_CTL_DMA |\n\t\t\tAR5K_RESET_CTL_PHY | AR5K_RESET_CTL_PCI);\n\t\tusleep_range(2000, 2500);\n\t} else {\n\t\tret = ath5k_hw_nic_reset(ah, AR5K_RESET_CTL_PCU |\n\t\t\tAR5K_RESET_CTL_BASEBAND | bus_flags);\n\t}\n\n\tif (ret) {\n\t\tATH5K_ERR(ah, \"failed to put device on warm reset\\n\");\n\t\treturn -EIO;\n\t}\n\n\t \n\tret = ath5k_hw_set_power_mode(ah, AR5K_PM_AWAKE, true, 0);\n\tif (ret) {\n\t\tATH5K_ERR(ah, \"failed to put device on hold\\n\");\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\n \nint\nath5k_hw_nic_wakeup(struct ath5k_hw *ah, struct ieee80211_channel *channel)\n{\n\tstruct pci_dev *pdev = ah->pdev;\n\tu32 turbo, mode, clock, bus_flags;\n\tint ret;\n\n\tturbo = 0;\n\tmode = 0;\n\tclock = 0;\n\n\tif ((ath5k_get_bus_type(ah) != ATH_AHB) || channel) {\n\t\t \n\t\tret = ath5k_hw_set_power_mode(ah, AR5K_PM_AWAKE, true, 0);\n\t\tif (ret) {\n\t\t\tATH5K_ERR(ah, \"failed to wakeup the MAC Chip\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tbus_flags = (pdev && pci_is_pcie(pdev)) ? 0 : AR5K_RESET_CTL_PCI;\n\n\tif (ah->ah_version == AR5K_AR5210) {\n\t\tret = ath5k_hw_nic_reset(ah, AR5K_RESET_CTL_PCU |\n\t\t\tAR5K_RESET_CTL_MAC | AR5K_RESET_CTL_DMA |\n\t\t\tAR5K_RESET_CTL_PHY | AR5K_RESET_CTL_PCI);\n\t\tusleep_range(2000, 2500);\n\t} else {\n\t\tif (ath5k_get_bus_type(ah) == ATH_AHB)\n\t\t\tret = ath5k_hw_wisoc_reset(ah, AR5K_RESET_CTL_PCU |\n\t\t\t\tAR5K_RESET_CTL_BASEBAND);\n\t\telse\n\t\t\tret = ath5k_hw_nic_reset(ah, AR5K_RESET_CTL_PCU |\n\t\t\t\tAR5K_RESET_CTL_BASEBAND | bus_flags);\n\t}\n\n\tif (ret) {\n\t\tATH5K_ERR(ah, \"failed to reset the MAC Chip\\n\");\n\t\treturn -EIO;\n\t}\n\n\t \n\tret = ath5k_hw_set_power_mode(ah, AR5K_PM_AWAKE, true, 0);\n\tif (ret) {\n\t\tATH5K_ERR(ah, \"failed to resume the MAC Chip\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tif (ath5k_get_bus_type(ah) == ATH_AHB)\n\t\tret = ath5k_hw_wisoc_reset(ah, 0);\n\telse\n\t\tret = ath5k_hw_nic_reset(ah, 0);\n\n\tif (ret) {\n\t\tATH5K_ERR(ah, \"failed to warm reset the MAC Chip\\n\");\n\t\treturn -EIO;\n\t}\n\n\t \n\tif (!channel)\n\t\treturn 0;\n\n\tif (ah->ah_version != AR5K_AR5210) {\n\t\t \n\n\t\tif (ah->ah_radio >= AR5K_RF5112) {\n\t\t\tmode = AR5K_PHY_MODE_RAD_RF5112;\n\t\t\tclock = AR5K_PHY_PLL_RF5112;\n\t\t} else {\n\t\t\tmode = AR5K_PHY_MODE_RAD_RF5111;\t \n\t\t\tclock = AR5K_PHY_PLL_RF5111;\t\t \n\t\t}\n\n\t\tif (channel->band == NL80211_BAND_2GHZ) {\n\t\t\tmode |= AR5K_PHY_MODE_FREQ_2GHZ;\n\t\t\tclock |= AR5K_PHY_PLL_44MHZ;\n\n\t\t\tif (channel->hw_value == AR5K_MODE_11B) {\n\t\t\t\tmode |= AR5K_PHY_MODE_MOD_CCK;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tif (ah->ah_version == AR5K_AR5211)\n\t\t\t\t\tmode |= AR5K_PHY_MODE_MOD_OFDM;\n\t\t\t\telse\n\t\t\t\t\tmode |= AR5K_PHY_MODE_MOD_DYN;\n\t\t\t}\n\t\t} else if (channel->band == NL80211_BAND_5GHZ) {\n\t\t\tmode |= (AR5K_PHY_MODE_FREQ_5GHZ |\n\t\t\t\t AR5K_PHY_MODE_MOD_OFDM);\n\n\t\t\t \n\t\t\tif (ah->ah_radio == AR5K_RF5413)\n\t\t\t\tclock = AR5K_PHY_PLL_40MHZ_5413;\n\t\t\telse\n\t\t\t\tclock |= AR5K_PHY_PLL_40MHZ;\n\t\t} else {\n\t\t\tATH5K_ERR(ah, \"invalid radio frequency mode\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\t \n\t\tif (ah->ah_bwmode == AR5K_BWMODE_40MHZ) {\n\t\t\tturbo = AR5K_PHY_TURBO_MODE;\n\t\t\tif (ah->ah_radio != AR5K_RF2425)\n\t\t\t\tturbo |= AR5K_PHY_TURBO_SHORT;\n\t\t} else if (ah->ah_bwmode != AR5K_BWMODE_DEFAULT) {\n\t\t\tif (ah->ah_radio == AR5K_RF5413) {\n\t\t\t\tmode |= (ah->ah_bwmode == AR5K_BWMODE_10MHZ) ?\n\t\t\t\t\tAR5K_PHY_MODE_HALF_RATE :\n\t\t\t\t\tAR5K_PHY_MODE_QUARTER_RATE;\n\t\t\t} else if (ah->ah_version == AR5K_AR5212) {\n\t\t\t\tclock |= (ah->ah_bwmode == AR5K_BWMODE_10MHZ) ?\n\t\t\t\t\tAR5K_PHY_PLL_HALF_RATE :\n\t\t\t\t\tAR5K_PHY_PLL_QUARTER_RATE;\n\t\t\t}\n\t\t}\n\n\t} else {  \n\n\t\t \n\t\tif (ah->ah_bwmode == AR5K_BWMODE_40MHZ)\n\t\t\tath5k_hw_reg_write(ah, AR5K_PHY_TURBO_MODE,\n\t\t\t\t\tAR5K_PHY_TURBO);\n\t}\n\n\tif (ah->ah_version != AR5K_AR5210) {\n\n\t\t \n\t\tif (ath5k_hw_reg_read(ah, AR5K_PHY_PLL) != clock) {\n\t\t\tath5k_hw_reg_write(ah, clock, AR5K_PHY_PLL);\n\t\t\tusleep_range(300, 350);\n\t\t}\n\n\t\t \n\t\tath5k_hw_reg_write(ah, mode, AR5K_PHY_MODE);\n\t\tath5k_hw_reg_write(ah, turbo, AR5K_PHY_TURBO);\n\t}\n\n\treturn 0;\n}\n\n\n \n\n \nstatic void\nath5k_hw_tweak_initval_settings(struct ath5k_hw *ah,\n\t\t\t\tstruct ieee80211_channel *channel)\n{\n\tif (ah->ah_version == AR5K_AR5212 &&\n\t    ah->ah_phy_revision >= AR5K_SREV_PHY_5212A) {\n\n\t\t \n\t\tath5k_hw_reg_write(ah,\n\t\t\t\t(AR5K_REG_SM(2,\n\t\t\t\tAR5K_PHY_ADC_CTL_INBUFGAIN_OFF) |\n\t\t\t\tAR5K_REG_SM(2,\n\t\t\t\tAR5K_PHY_ADC_CTL_INBUFGAIN_ON) |\n\t\t\t\tAR5K_PHY_ADC_CTL_PWD_DAC_OFF |\n\t\t\t\tAR5K_PHY_ADC_CTL_PWD_ADC_OFF),\n\t\t\t\tAR5K_PHY_ADC_CTL);\n\n\n\n\t\t \n\t\tAR5K_REG_DISABLE_BITS(ah, AR5K_PHY_DAG_CCK_CTL,\n\t\t\t\tAR5K_PHY_DAG_CCK_CTL_EN_RSSI_THR);\n\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_DAG_CCK_CTL,\n\t\t\tAR5K_PHY_DAG_CCK_CTL_RSSI_THR, 2);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, 0x0000000f, AR5K_SEQ_MASK);\n\t}\n\n\t \n\tif (ah->ah_phy_revision >= AR5K_SREV_PHY_5212B)\n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_BLUETOOTH);\n\n\t \n\tif (ah->ah_phy_revision > AR5K_SREV_PHY_5212B)\n\t\tAR5K_REG_DISABLE_BITS(ah, AR5K_TXCFG,\n\t\t\t\tAR5K_TXCFG_DCU_DBL_BUF_DIS);\n\n\t \n\tif ((ah->ah_radio == AR5K_RF5413) ||\n\t\t(ah->ah_radio == AR5K_RF2317) ||\n\t\t(ah->ah_mac_version == (AR5K_SREV_AR2417 >> 4))) {\n\t\tu32 fast_adc = true;\n\n\t\tif (channel->center_freq == 2462 ||\n\t\tchannel->center_freq == 2467)\n\t\t\tfast_adc = 0;\n\n\t\t \n\t\tif (ath5k_hw_reg_read(ah, AR5K_PHY_FAST_ADC) != fast_adc)\n\t\t\t\tath5k_hw_reg_write(ah, fast_adc,\n\t\t\t\t\t\tAR5K_PHY_FAST_ADC);\n\t}\n\n\t \n\tif (ah->ah_radio == AR5K_RF5112 &&\n\t\t\tah->ah_radio_5ghz_revision <\n\t\t\tAR5K_SREV_RAD_5112A) {\n\t\tu32 data;\n\t\tath5k_hw_reg_write(ah, AR5K_PHY_CCKTXCTL_WORLD,\n\t\t\t\tAR5K_PHY_CCKTXCTL);\n\t\tif (channel->band == NL80211_BAND_5GHZ)\n\t\t\tdata = 0xffb81020;\n\t\telse\n\t\t\tdata = 0xffb80d20;\n\t\tath5k_hw_reg_write(ah, data, AR5K_PHY_FRAME_CTL);\n\t}\n\n\tif (ah->ah_mac_srev < AR5K_SREV_AR5211) {\n\t\t \n\t\tath5k_hw_reg_write(ah, 0, AR5K_QCUDCU_CLKGT);\n\t\t \n\t\tath5k_hw_reg_write(ah, AR5K_PHY_SCAL_32MHZ_5311,\n\t\t\t\t\t\tAR5K_PHY_SCAL);\n\t\t \n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_DIAG_SW_5211,\n\t\t\t\t\tAR5K_DIAG_SW_ECO_ENABLE);\n\t}\n\n\tif (ah->ah_bwmode) {\n\t\t \n\t\tif (ah->ah_bwmode == AR5K_BWMODE_40MHZ) {\n\n\t\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_SETTLING,\n\t\t\t\t\t\tAR5K_PHY_SETTLING_AGC,\n\t\t\t\t\t\tAR5K_AGC_SETTLING_TURBO);\n\n\t\t\t \n\t\t\tif (ah->ah_version == AR5K_AR5212)\n\t\t\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_SETTLING,\n\t\t\t\t\t\tAR5K_PHY_SETTLING_SWITCH,\n\t\t\t\t\t\tAR5K_SWITCH_SETTLING_TURBO);\n\n\t\t\tif (ah->ah_version == AR5K_AR5210) {\n\t\t\t\t \n\t\t\t\tath5k_hw_reg_write(ah,\n\t\t\t\t\t(AR5K_PHY_FRAME_CTL_INI |\n\t\t\t\t\tAR5K_PHY_TURBO_MODE |\n\t\t\t\t\tAR5K_PHY_TURBO_SHORT | 0x2020),\n\t\t\t\t\tAR5K_PHY_FRAME_CTL_5210);\n\t\t\t}\n\t\t \n\t\t} else if ((ah->ah_mac_srev >= AR5K_SREV_AR5424) &&\n\t\t(ah->ah_mac_srev <= AR5K_SREV_AR5414)) {\n\t\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_FRAME_CTL_5211,\n\t\t\t\t\t\tAR5K_PHY_FRAME_CTL_WIN_LEN,\n\t\t\t\t\t\t3);\n\t\t}\n\t} else if (ah->ah_version == AR5K_AR5210) {\n\t\t \n\t\tath5k_hw_reg_write(ah, (AR5K_PHY_FRAME_CTL_INI | 0x1020),\n\t\t\t\t\t\tAR5K_PHY_FRAME_CTL_5210);\n\t}\n}\n\n \nstatic void\nath5k_hw_commit_eeprom_settings(struct ath5k_hw *ah,\n\t\tstruct ieee80211_channel *channel)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\ts16 cck_ofdm_pwr_delta;\n\tu8 ee_mode;\n\n\t \n\tif (ah->ah_version == AR5K_AR5210)\n\t\treturn;\n\n\tee_mode = ath5k_eeprom_mode_from_channel(ah, channel);\n\n\t \n\tif (channel->center_freq == 2484)\n\t\tcck_ofdm_pwr_delta =\n\t\t\t((ee->ee_cck_ofdm_power_delta -\n\t\t\tee->ee_scaled_cck_delta) * 2) / 10;\n\telse\n\t\tcck_ofdm_pwr_delta =\n\t\t\t(ee->ee_cck_ofdm_power_delta * 2) / 10;\n\n\t \n\tif (ah->ah_phy_revision >= AR5K_SREV_PHY_5212A) {\n\t\tif (channel->hw_value == AR5K_MODE_11G)\n\t\t\tath5k_hw_reg_write(ah,\n\t\t\tAR5K_REG_SM((ee->ee_cck_ofdm_gain_delta * -1),\n\t\t\t\tAR5K_PHY_TX_PWR_ADJ_CCK_GAIN_DELTA) |\n\t\t\tAR5K_REG_SM((cck_ofdm_pwr_delta * -1),\n\t\t\t\tAR5K_PHY_TX_PWR_ADJ_CCK_PCDAC_INDEX),\n\t\t\t\tAR5K_PHY_TX_PWR_ADJ);\n\t\telse\n\t\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_TX_PWR_ADJ);\n\t} else {\n\t\t \n\t\tah->ah_txpower.txp_cck_ofdm_pwr_delta = cck_ofdm_pwr_delta;\n\t\tah->ah_txpower.txp_cck_ofdm_gainf_delta =\n\t\t\t\t\t\tee->ee_cck_ofdm_gain_delta;\n\t}\n\n\t \n\tath5k_hw_set_antenna_switch(ah, ee_mode);\n\n\t \n\tath5k_hw_reg_write(ah,\n\t\tAR5K_PHY_NF_SVAL(ee->ee_noise_floor_thr[ee_mode]),\n\t\tAR5K_PHY_NFTHRES);\n\n\tif ((ah->ah_bwmode == AR5K_BWMODE_40MHZ) &&\n\t(ah->ah_ee_version >= AR5K_EEPROM_VERSION_5_0)) {\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_SETTLING,\n\t\t\t\tAR5K_PHY_SETTLING_SWITCH,\n\t\t\t\tee->ee_switch_settling_turbo[ee_mode]);\n\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_GAIN,\n\t\t\t\tAR5K_PHY_GAIN_TXRX_ATTEN,\n\t\t\t\tee->ee_atn_tx_rx_turbo[ee_mode]);\n\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_DESIRED_SIZE,\n\t\t\t\tAR5K_PHY_DESIRED_SIZE_ADC,\n\t\t\t\tee->ee_adc_desired_size_turbo[ee_mode]);\n\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_DESIRED_SIZE,\n\t\t\t\tAR5K_PHY_DESIRED_SIZE_PGA,\n\t\t\t\tee->ee_pga_desired_size_turbo[ee_mode]);\n\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_GAIN_2GHZ,\n\t\t\t\tAR5K_PHY_GAIN_2GHZ_MARGIN_TXRX,\n\t\t\t\tee->ee_margin_tx_rx_turbo[ee_mode]);\n\n\t} else {\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_SETTLING,\n\t\t\t\tAR5K_PHY_SETTLING_SWITCH,\n\t\t\t\tee->ee_switch_settling[ee_mode]);\n\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_GAIN,\n\t\t\t\tAR5K_PHY_GAIN_TXRX_ATTEN,\n\t\t\t\tee->ee_atn_tx_rx[ee_mode]);\n\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_DESIRED_SIZE,\n\t\t\t\tAR5K_PHY_DESIRED_SIZE_ADC,\n\t\t\t\tee->ee_adc_desired_size[ee_mode]);\n\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_DESIRED_SIZE,\n\t\t\t\tAR5K_PHY_DESIRED_SIZE_PGA,\n\t\t\t\tee->ee_pga_desired_size[ee_mode]);\n\n\t\t \n\t\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_4_1)\n\t\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_GAIN_2GHZ,\n\t\t\t\tAR5K_PHY_GAIN_2GHZ_MARGIN_TXRX,\n\t\t\t\tee->ee_margin_tx_rx[ee_mode]);\n\t}\n\n\t \n\tath5k_hw_reg_write(ah,\n\t\t(ee->ee_tx_end2xpa_disable[ee_mode] << 24) |\n\t\t(ee->ee_tx_end2xpa_disable[ee_mode] << 16) |\n\t\t(ee->ee_tx_frm2xpa_enable[ee_mode] << 8) |\n\t\t(ee->ee_tx_frm2xpa_enable[ee_mode]), AR5K_PHY_RF_CTL4);\n\n\t \n\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_RF_CTL3,\n\t\t\tAR5K_PHY_RF_CTL3_TXE2XLNA_ON,\n\t\t\tee->ee_tx_end2xlna_enable[ee_mode]);\n\n\t \n\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_NF,\n\t\t\tAR5K_PHY_NF_THRESH62,\n\t\t\tee->ee_thr_62[ee_mode]);\n\n\t \n\tif (ath5k_hw_chan_has_spur_noise(ah, channel))\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_OFDM_SELFCORR,\n\t\t\t\tAR5K_PHY_OFDM_SELFCORR_CYPWR_THR1,\n\t\t\t\tAR5K_INIT_CYCRSSI_THR1 +\n\t\t\t\tee->ee_false_detect[ee_mode]);\n\telse\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_OFDM_SELFCORR,\n\t\t\t\tAR5K_PHY_OFDM_SELFCORR_CYPWR_THR1,\n\t\t\t\tAR5K_INIT_CYCRSSI_THR1);\n\n\t \n\t \n\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_4_0) {\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_IQ, AR5K_PHY_IQ_CORR_Q_I_COFF,\n\t\t\t    ee->ee_i_cal[ee_mode]);\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_IQ, AR5K_PHY_IQ_CORR_Q_Q_COFF,\n\t\t\t    ee->ee_q_cal[ee_mode]);\n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_IQ, AR5K_PHY_IQ_CORR_ENABLE);\n\t}\n\n\t \n\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_5_1)\n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_HEAVY_CLIP_ENABLE);\n}\n\n\n \n\n \nint\nath5k_hw_reset(struct ath5k_hw *ah, enum nl80211_iftype op_mode,\n\t\tstruct ieee80211_channel *channel, bool fast, bool skip_pcu)\n{\n\tu32 s_seq[10], s_led[3], tsf_up, tsf_lo;\n\tu8 mode;\n\tint i, ret;\n\n\ttsf_up = 0;\n\ttsf_lo = 0;\n\tmode = 0;\n\n\t \n\tif (fast && (ah->ah_radio != AR5K_RF2413) &&\n\t(ah->ah_radio != AR5K_RF5413))\n\t\tfast = false;\n\n\t \n\tif (ah->ah_version == AR5K_AR5212)\n\t\tath5k_hw_set_sleep_clock(ah, false);\n\n\tmode = channel->hw_value;\n\tswitch (mode) {\n\tcase AR5K_MODE_11A:\n\t\tbreak;\n\tcase AR5K_MODE_11G:\n\t\tif (ah->ah_version <= AR5K_AR5211) {\n\t\t\tATH5K_ERR(ah,\n\t\t\t\t\"G mode not available on 5210/5211\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase AR5K_MODE_11B:\n\t\tif (ah->ah_version < AR5K_AR5211) {\n\t\t\tATH5K_ERR(ah,\n\t\t\t\t\"B mode not available on 5210\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tATH5K_ERR(ah,\n\t\t\t\"invalid channel: %d\\n\", channel->center_freq);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (fast) {\n\t\tret = ath5k_hw_phy_init(ah, channel, mode, true);\n\t\tif (ret) {\n\t\t\tATH5K_DBG(ah, ATH5K_DEBUG_RESET,\n\t\t\t\t\"fast chan change failed, falling back to normal reset\\n\");\n\t\t\t \n\t\t\tret = 0;\n\t\t} else {\n\t\t\tATH5K_DBG(ah, ATH5K_DEBUG_RESET,\n\t\t\t\t\"fast chan change successful\\n\");\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\t \n\tif (ah->ah_version != AR5K_AR5210) {\n\t\t \n\t\tif (ah->ah_mac_srev < AR5K_SREV_AR5211) {\n\n\t\t\tfor (i = 0; i < 10; i++)\n\t\t\t\ts_seq[i] = ath5k_hw_reg_read(ah,\n\t\t\t\t\tAR5K_QUEUE_DCU_SEQNUM(i));\n\n\t\t} else {\n\t\t\ts_seq[0] = ath5k_hw_reg_read(ah,\n\t\t\t\t\tAR5K_QUEUE_DCU_SEQNUM(0));\n\t\t}\n\n\t\t \n\t\tif (ah->ah_version == AR5K_AR5211) {\n\t\t\ttsf_up = ath5k_hw_reg_read(ah, AR5K_TSF_U32);\n\t\t\ttsf_lo = ath5k_hw_reg_read(ah, AR5K_TSF_L32);\n\t\t}\n\t}\n\n\n\t \n\ts_led[0] = ath5k_hw_reg_read(ah, AR5K_PCICFG) &\n\t\t\t\t\tAR5K_PCICFG_LEDSTATE;\n\ts_led[1] = ath5k_hw_reg_read(ah, AR5K_GPIOCR);\n\ts_led[2] = ath5k_hw_reg_read(ah, AR5K_GPIODO);\n\n\n\t \n\tif (ah->ah_version == AR5K_AR5212 &&\n\t(ah->ah_radio <= AR5K_RF5112)) {\n\t\tif (!fast && ah->ah_rf_banks != NULL)\n\t\t\t\tath5k_hw_gainf_calibrate(ah);\n\t}\n\n\t \n\tret = ath5k_hw_nic_wakeup(ah, channel);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (ah->ah_mac_srev >= AR5K_SREV_AR5211)\n\t\tath5k_hw_reg_write(ah, AR5K_PHY_SHIFT_5GHZ, AR5K_PHY(0));\n\telse\n\t\tath5k_hw_reg_write(ah, AR5K_PHY_SHIFT_5GHZ | 0x40,\n\t\t\t\t\t\t\tAR5K_PHY(0));\n\n\t \n\tret = ath5k_hw_write_initvals(ah, mode, skip_pcu);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tath5k_hw_init_core_clock(ah);\n\n\t \n\tath5k_hw_tweak_initval_settings(ah, channel);\n\n\t \n\tath5k_hw_commit_eeprom_settings(ah, channel);\n\n\n\t \n\n\t \n\tif (ah->ah_version != AR5K_AR5210) {\n\t\tif (ah->ah_mac_srev < AR5K_SREV_AR5211) {\n\t\t\tfor (i = 0; i < 10; i++)\n\t\t\t\tath5k_hw_reg_write(ah, s_seq[i],\n\t\t\t\t\tAR5K_QUEUE_DCU_SEQNUM(i));\n\t\t} else {\n\t\t\tath5k_hw_reg_write(ah, s_seq[0],\n\t\t\t\tAR5K_QUEUE_DCU_SEQNUM(0));\n\t\t}\n\n\t\tif (ah->ah_version == AR5K_AR5211) {\n\t\t\tath5k_hw_reg_write(ah, tsf_up, AR5K_TSF_U32);\n\t\t\tath5k_hw_reg_write(ah, tsf_lo, AR5K_TSF_L32);\n\t\t}\n\t}\n\n\t \n\tAR5K_REG_ENABLE_BITS(ah, AR5K_PCICFG, s_led[0]);\n\n\t \n\tath5k_hw_reg_write(ah, s_led[1], AR5K_GPIOCR);\n\tath5k_hw_reg_write(ah, s_led[2], AR5K_GPIODO);\n\n\t \n\tath5k_hw_pcu_init(ah, op_mode);\n\n\t \n\tret = ath5k_hw_phy_init(ah, channel, mode, false);\n\tif (ret) {\n\t\tATH5K_ERR(ah,\n\t\t\t\"failed to initialize PHY (%i) !\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tret = ath5k_hw_init_queues(ah);\n\tif (ret)\n\t\treturn ret;\n\n\n\t \n\tath5k_hw_dma_init(ah);\n\n\n\t \n\tif (ah->ah_use_32khz_clock && ah->ah_version == AR5K_AR5212 &&\n\t    op_mode != NL80211_IFTYPE_AP)\n\t\tath5k_hw_set_sleep_clock(ah, true);\n\n\t \n\tAR5K_REG_DISABLE_BITS(ah, AR5K_BEACON, AR5K_BEACON_ENABLE);\n\tath5k_hw_reset_tsf(ah);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}