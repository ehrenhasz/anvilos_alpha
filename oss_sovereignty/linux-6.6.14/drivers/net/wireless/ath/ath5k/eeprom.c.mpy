{
  "module_name": "eeprom.c",
  "hash_id": "0bd91c3a32ac05b70c8bd3ae59b5f72cee96699d9c7265a0ad5b5f7d13db83a2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath5k/eeprom.c",
  "human_readable_source": " \n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/slab.h>\n\n#include \"ath5k.h\"\n#include \"reg.h\"\n#include \"debug.h\"\n\n\n \n\n \nstatic u16 ath5k_eeprom_bin2freq(struct ath5k_eeprom_info *ee, u16 bin,\n\t\t\t\t\t\t\tunsigned int mode)\n{\n\tu16 val;\n\n\tif (bin == AR5K_EEPROM_CHANNEL_DIS)\n\t\treturn bin;\n\n\tif (mode == AR5K_EEPROM_MODE_11A) {\n\t\tif (ee->ee_version > AR5K_EEPROM_VERSION_3_2)\n\t\t\tval = (5 * bin) + 4800;\n\t\telse\n\t\t\tval = bin > 62 ? (10 * 62) + (5 * (bin - 62)) + 5100 :\n\t\t\t\t(bin * 10) + 5100;\n\t} else {\n\t\tif (ee->ee_version > AR5K_EEPROM_VERSION_3_2)\n\t\t\tval = bin + 2300;\n\t\telse\n\t\t\tval = bin + 2400;\n\t}\n\n\treturn val;\n}\n\n\n \n\n \nstatic int\nath5k_eeprom_init_header(struct ath5k_hw *ah)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu16 val;\n\tu32 cksum, offset, eep_max = AR5K_EEPROM_INFO_MAX;\n\n\t \n\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_MAGIC, ee_magic);\n\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_PROTECT, ee_protect);\n\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_REG_DOMAIN, ee_regdomain);\n\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_VERSION, ee_version);\n\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_HDR, ee_header);\n\n\t \n\tif (ah->ah_ee_version < AR5K_EEPROM_VERSION_3_0)\n\t\treturn 0;\n\n\t \n\tAR5K_EEPROM_READ(AR5K_EEPROM_SIZE_UPPER, val);\n\tif (val) {\n\t\teep_max = (val & AR5K_EEPROM_SIZE_UPPER_MASK) <<\n\t\t\t   AR5K_EEPROM_SIZE_ENDLOC_SHIFT;\n\t\tAR5K_EEPROM_READ(AR5K_EEPROM_SIZE_LOWER, val);\n\t\teep_max = (eep_max | val) - AR5K_EEPROM_INFO_BASE;\n\n\t\t \n\t\tif (eep_max > (3 * AR5K_EEPROM_INFO_MAX)) {\n\t\t\tATH5K_ERR(ah, \"Invalid max custom EEPROM size: \"\n\t\t\t\t  \"%d (0x%04x) max expected: %d (0x%04x)\\n\",\n\t\t\t\t  eep_max, eep_max,\n\t\t\t\t  3 * AR5K_EEPROM_INFO_MAX,\n\t\t\t\t  3 * AR5K_EEPROM_INFO_MAX);\n\t\t\treturn -EIO;\n\t\t}\n\t}\n\n\tfor (cksum = 0, offset = 0; offset < eep_max; offset++) {\n\t\tAR5K_EEPROM_READ(AR5K_EEPROM_INFO(offset), val);\n\t\tcksum ^= val;\n\t}\n\tif (cksum != AR5K_EEPROM_INFO_CKSUM) {\n\t\tATH5K_ERR(ah, \"Invalid EEPROM \"\n\t\t\t  \"checksum: 0x%04x eep_max: 0x%04x (%s)\\n\",\n\t\t\t  cksum, eep_max,\n\t\t\t  eep_max == AR5K_EEPROM_INFO_MAX ?\n\t\t\t\t\"default size\" : \"custom size\");\n\t\treturn -EIO;\n\t}\n\n\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_ANT_GAIN(ah->ah_ee_version),\n\t    ee_ant_gain);\n\n\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_4_0) {\n\t\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_MISC0, ee_misc0);\n\t\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_MISC1, ee_misc1);\n\n\t\t \n\t\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_MISC2, ee_misc2);\n\n\t\tif (ee->ee_version >= AR5K_EEPROM_VERSION_4_3)\n\t\t\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_MISC3, ee_misc3);\n\n\t\tif (ee->ee_version >= AR5K_EEPROM_VERSION_5_0) {\n\t\t\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_MISC4, ee_misc4);\n\t\t\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_MISC5, ee_misc5);\n\t\t\tAR5K_EEPROM_READ_HDR(AR5K_EEPROM_MISC6, ee_misc6);\n\t\t}\n\t}\n\n\tif (ah->ah_ee_version < AR5K_EEPROM_VERSION_3_3) {\n\t\tAR5K_EEPROM_READ(AR5K_EEPROM_OBDB0_2GHZ, val);\n\t\tee->ee_ob[AR5K_EEPROM_MODE_11B][0] = val & 0x7;\n\t\tee->ee_db[AR5K_EEPROM_MODE_11B][0] = (val >> 3) & 0x7;\n\n\t\tAR5K_EEPROM_READ(AR5K_EEPROM_OBDB1_2GHZ, val);\n\t\tee->ee_ob[AR5K_EEPROM_MODE_11G][0] = val & 0x7;\n\t\tee->ee_db[AR5K_EEPROM_MODE_11G][0] = (val >> 3) & 0x7;\n\t}\n\n\tAR5K_EEPROM_READ(AR5K_EEPROM_IS_HB63, val);\n\n\tif ((ah->ah_mac_version == (AR5K_SREV_AR2425 >> 4)) && val)\n\t\tee->ee_is_hb63 = true;\n\telse\n\t\tee->ee_is_hb63 = false;\n\n\tAR5K_EEPROM_READ(AR5K_EEPROM_RFKILL, val);\n\tee->ee_rfkill_pin = (u8) AR5K_REG_MS(val, AR5K_EEPROM_RFKILL_GPIO_SEL);\n\tee->ee_rfkill_pol = val & AR5K_EEPROM_RFKILL_POLARITY ? true : false;\n\n\t \n\tAR5K_EEPROM_READ(AR5K_EEPROM_PCIE_OFFSET, val);\n\tee->ee_serdes = (val == AR5K_EEPROM_PCIE_SERDES_SECTION) ?\n\t\t\t\t\t\t\ttrue : false;\n\n\treturn 0;\n}\n\n\n \nstatic int ath5k_eeprom_read_ants(struct ath5k_hw *ah, u32 *offset,\n\t\tunsigned int mode)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu32 o = *offset;\n\tu16 val;\n\tint i = 0;\n\n\tAR5K_EEPROM_READ(o++, val);\n\tee->ee_switch_settling[mode]\t= (val >> 8) & 0x7f;\n\tee->ee_atn_tx_rx[mode]\t\t= (val >> 2) & 0x3f;\n\tee->ee_ant_control[mode][i]\t= (val << 4) & 0x3f;\n\n\tAR5K_EEPROM_READ(o++, val);\n\tee->ee_ant_control[mode][i++]\t|= (val >> 12) & 0xf;\n\tee->ee_ant_control[mode][i++]\t= (val >> 6) & 0x3f;\n\tee->ee_ant_control[mode][i++]\t= val & 0x3f;\n\n\tAR5K_EEPROM_READ(o++, val);\n\tee->ee_ant_control[mode][i++]\t= (val >> 10) & 0x3f;\n\tee->ee_ant_control[mode][i++]\t= (val >> 4) & 0x3f;\n\tee->ee_ant_control[mode][i]\t= (val << 2) & 0x3f;\n\n\tAR5K_EEPROM_READ(o++, val);\n\tee->ee_ant_control[mode][i++]\t|= (val >> 14) & 0x3;\n\tee->ee_ant_control[mode][i++]\t= (val >> 8) & 0x3f;\n\tee->ee_ant_control[mode][i++]\t= (val >> 2) & 0x3f;\n\tee->ee_ant_control[mode][i]\t= (val << 4) & 0x3f;\n\n\tAR5K_EEPROM_READ(o++, val);\n\tee->ee_ant_control[mode][i++]\t|= (val >> 12) & 0xf;\n\tee->ee_ant_control[mode][i++]\t= (val >> 6) & 0x3f;\n\tee->ee_ant_control[mode][i++]\t= val & 0x3f;\n\n\t \n\tah->ah_ant_ctl[mode][AR5K_ANT_CTL] =\n\t    (ee->ee_ant_control[mode][0] << 4);\n\tah->ah_ant_ctl[mode][AR5K_ANT_SWTABLE_A] =\n\t     ee->ee_ant_control[mode][1]\t|\n\t    (ee->ee_ant_control[mode][2] << 6)\t|\n\t    (ee->ee_ant_control[mode][3] << 12) |\n\t    (ee->ee_ant_control[mode][4] << 18) |\n\t    (ee->ee_ant_control[mode][5] << 24);\n\tah->ah_ant_ctl[mode][AR5K_ANT_SWTABLE_B] =\n\t     ee->ee_ant_control[mode][6]\t|\n\t    (ee->ee_ant_control[mode][7] << 6)\t|\n\t    (ee->ee_ant_control[mode][8] << 12) |\n\t    (ee->ee_ant_control[mode][9] << 18) |\n\t    (ee->ee_ant_control[mode][10] << 24);\n\n\t \n\t*offset = o;\n\n\treturn 0;\n}\n\n \nstatic int ath5k_eeprom_read_modes(struct ath5k_hw *ah, u32 *offset,\n\t\tunsigned int mode)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu32 o = *offset;\n\tu16 val;\n\n\tee->ee_n_piers[mode] = 0;\n\tAR5K_EEPROM_READ(o++, val);\n\tee->ee_adc_desired_size[mode]\t= (s8)((val >> 8) & 0xff);\n\tswitch (mode) {\n\tcase AR5K_EEPROM_MODE_11A:\n\t\tee->ee_ob[mode][3]\t= (val >> 5) & 0x7;\n\t\tee->ee_db[mode][3]\t= (val >> 2) & 0x7;\n\t\tee->ee_ob[mode][2]\t= (val << 1) & 0x7;\n\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_ob[mode][2]\t|= (val >> 15) & 0x1;\n\t\tee->ee_db[mode][2]\t= (val >> 12) & 0x7;\n\t\tee->ee_ob[mode][1]\t= (val >> 9) & 0x7;\n\t\tee->ee_db[mode][1]\t= (val >> 6) & 0x7;\n\t\tee->ee_ob[mode][0]\t= (val >> 3) & 0x7;\n\t\tee->ee_db[mode][0]\t= val & 0x7;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11G:\n\tcase AR5K_EEPROM_MODE_11B:\n\t\tee->ee_ob[mode][1]\t= (val >> 4) & 0x7;\n\t\tee->ee_db[mode][1]\t= val & 0x7;\n\t\tbreak;\n\t}\n\n\tAR5K_EEPROM_READ(o++, val);\n\tee->ee_tx_end2xlna_enable[mode]\t= (val >> 8) & 0xff;\n\tee->ee_thr_62[mode]\t\t= val & 0xff;\n\n\tif (ah->ah_ee_version <= AR5K_EEPROM_VERSION_3_2)\n\t\tee->ee_thr_62[mode] = mode == AR5K_EEPROM_MODE_11A ? 15 : 28;\n\n\tAR5K_EEPROM_READ(o++, val);\n\tee->ee_tx_end2xpa_disable[mode]\t= (val >> 8) & 0xff;\n\tee->ee_tx_frm2xpa_enable[mode]\t= val & 0xff;\n\n\tAR5K_EEPROM_READ(o++, val);\n\tee->ee_pga_desired_size[mode]\t= (val >> 8) & 0xff;\n\n\tif ((val & 0xff) & 0x80)\n\t\tee->ee_noise_floor_thr[mode] = -((((val & 0xff) ^ 0xff)) + 1);\n\telse\n\t\tee->ee_noise_floor_thr[mode] = val & 0xff;\n\n\tif (ah->ah_ee_version <= AR5K_EEPROM_VERSION_3_2)\n\t\tee->ee_noise_floor_thr[mode] =\n\t\t    mode == AR5K_EEPROM_MODE_11A ? -54 : -1;\n\n\tAR5K_EEPROM_READ(o++, val);\n\tee->ee_xlna_gain[mode]\t\t= (val >> 5) & 0xff;\n\tee->ee_x_gain[mode]\t\t= (val >> 1) & 0xf;\n\tee->ee_xpd[mode]\t\t= val & 0x1;\n\n\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_4_0 &&\n\t    mode != AR5K_EEPROM_MODE_11B)\n\t\tee->ee_fixed_bias[mode] = (val >> 13) & 0x1;\n\n\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_3_3) {\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_false_detect[mode] = (val >> 6) & 0x7f;\n\n\t\tif (mode == AR5K_EEPROM_MODE_11A)\n\t\t\tee->ee_xr_power[mode] = val & 0x3f;\n\t\telse {\n\t\t\t \n\t\t\tee->ee_ob[mode][0] = val & 0x7;\n\t\t\tee->ee_db[mode][0] = (val >> 3) & 0x7;\n\t\t}\n\t}\n\n\tif (ah->ah_ee_version < AR5K_EEPROM_VERSION_3_4) {\n\t\tee->ee_i_gain[mode] = AR5K_EEPROM_I_GAIN;\n\t\tee->ee_cck_ofdm_power_delta = AR5K_EEPROM_CCK_OFDM_DELTA;\n\t} else {\n\t\tee->ee_i_gain[mode] = (val >> 13) & 0x7;\n\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_i_gain[mode] |= (val << 3) & 0x38;\n\n\t\tif (mode == AR5K_EEPROM_MODE_11G) {\n\t\t\tee->ee_cck_ofdm_power_delta = (val >> 3) & 0xff;\n\t\t\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_4_6)\n\t\t\t\tee->ee_scaled_cck_delta = (val >> 11) & 0x1f;\n\t\t}\n\t}\n\n\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_4_0 &&\n\t\t\tmode == AR5K_EEPROM_MODE_11A) {\n\t\tee->ee_i_cal[mode] = (val >> 8) & 0x3f;\n\t\tee->ee_q_cal[mode] = (val >> 3) & 0x1f;\n\t}\n\n\tif (ah->ah_ee_version < AR5K_EEPROM_VERSION_4_0)\n\t\tgoto done;\n\n\t \n\tswitch (mode) {\n\tcase AR5K_EEPROM_MODE_11A:\n\t\tif (ah->ah_ee_version < AR5K_EEPROM_VERSION_4_1)\n\t\t\tbreak;\n\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_margin_tx_rx[mode] = val & 0x3f;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11B:\n\t\tAR5K_EEPROM_READ(o++, val);\n\n\t\tee->ee_pwr_cal_b[0].freq =\n\t\t\tath5k_eeprom_bin2freq(ee, val & 0xff, mode);\n\t\tif (ee->ee_pwr_cal_b[0].freq != AR5K_EEPROM_CHANNEL_DIS)\n\t\t\tee->ee_n_piers[mode]++;\n\n\t\tee->ee_pwr_cal_b[1].freq =\n\t\t\tath5k_eeprom_bin2freq(ee, (val >> 8) & 0xff, mode);\n\t\tif (ee->ee_pwr_cal_b[1].freq != AR5K_EEPROM_CHANNEL_DIS)\n\t\t\tee->ee_n_piers[mode]++;\n\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_pwr_cal_b[2].freq =\n\t\t\tath5k_eeprom_bin2freq(ee, val & 0xff, mode);\n\t\tif (ee->ee_pwr_cal_b[2].freq != AR5K_EEPROM_CHANNEL_DIS)\n\t\t\tee->ee_n_piers[mode]++;\n\n\t\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_4_1)\n\t\t\tee->ee_margin_tx_rx[mode] = (val >> 8) & 0x3f;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11G:\n\t\tAR5K_EEPROM_READ(o++, val);\n\n\t\tee->ee_pwr_cal_g[0].freq =\n\t\t\tath5k_eeprom_bin2freq(ee, val & 0xff, mode);\n\t\tif (ee->ee_pwr_cal_g[0].freq != AR5K_EEPROM_CHANNEL_DIS)\n\t\t\tee->ee_n_piers[mode]++;\n\n\t\tee->ee_pwr_cal_g[1].freq =\n\t\t\tath5k_eeprom_bin2freq(ee, (val >> 8) & 0xff, mode);\n\t\tif (ee->ee_pwr_cal_g[1].freq != AR5K_EEPROM_CHANNEL_DIS)\n\t\t\tee->ee_n_piers[mode]++;\n\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_turbo_max_power[mode] = val & 0x7f;\n\t\tee->ee_xr_power[mode] = (val >> 7) & 0x3f;\n\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_pwr_cal_g[2].freq =\n\t\t\tath5k_eeprom_bin2freq(ee, val & 0xff, mode);\n\t\tif (ee->ee_pwr_cal_g[2].freq != AR5K_EEPROM_CHANNEL_DIS)\n\t\t\tee->ee_n_piers[mode]++;\n\n\t\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_4_1)\n\t\t\tee->ee_margin_tx_rx[mode] = (val >> 8) & 0x3f;\n\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_i_cal[mode] = (val >> 5) & 0x3f;\n\t\tee->ee_q_cal[mode] = val & 0x1f;\n\n\t\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_4_2) {\n\t\t\tAR5K_EEPROM_READ(o++, val);\n\t\t\tee->ee_cck_ofdm_gain_delta = val & 0xff;\n\t\t}\n\t\tbreak;\n\t}\n\n\t \n\tif (ee->ee_version < AR5K_EEPROM_VERSION_5_0)\n\t\tgoto done;\n\n\tswitch (mode) {\n\tcase AR5K_EEPROM_MODE_11A:\n\t\tee->ee_switch_settling_turbo[mode] = (val >> 6) & 0x7f;\n\n\t\tee->ee_atn_tx_rx_turbo[mode] = (val >> 13) & 0x7;\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_atn_tx_rx_turbo[mode] |= (val & 0x7) << 3;\n\t\tee->ee_margin_tx_rx_turbo[mode] = (val >> 3) & 0x3f;\n\n\t\tee->ee_adc_desired_size_turbo[mode] = (val >> 9) & 0x7f;\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_adc_desired_size_turbo[mode] |= (val & 0x1) << 7;\n\t\tee->ee_pga_desired_size_turbo[mode] = (val >> 1) & 0xff;\n\n\t\tif (AR5K_EEPROM_EEMAP(ee->ee_misc0) >= 2)\n\t\t\tee->ee_pd_gain_overlap = (val >> 9) & 0xf;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11G:\n\t\tee->ee_switch_settling_turbo[mode] = (val >> 8) & 0x7f;\n\n\t\tee->ee_atn_tx_rx_turbo[mode] = (val >> 15) & 0x7;\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_atn_tx_rx_turbo[mode] |= (val & 0x1f) << 1;\n\t\tee->ee_margin_tx_rx_turbo[mode] = (val >> 5) & 0x3f;\n\n\t\tee->ee_adc_desired_size_turbo[mode] = (val >> 11) & 0x7f;\n\t\tAR5K_EEPROM_READ(o++, val);\n\t\tee->ee_adc_desired_size_turbo[mode] |= (val & 0x7) << 5;\n\t\tee->ee_pga_desired_size_turbo[mode] = (val >> 3) & 0xff;\n\t\tbreak;\n\t}\n\ndone:\n\t \n\t*offset = o;\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_eeprom_init_modes(struct ath5k_hw *ah)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu32 mode_offset[3];\n\tunsigned int mode;\n\tu32 offset;\n\tint ret;\n\n\t \n\tmode_offset[AR5K_EEPROM_MODE_11A] = AR5K_EEPROM_MODES_11A(ah->ah_ee_version);\n\tmode_offset[AR5K_EEPROM_MODE_11B] = AR5K_EEPROM_MODES_11B(ah->ah_ee_version);\n\tmode_offset[AR5K_EEPROM_MODE_11G] = AR5K_EEPROM_MODES_11G(ah->ah_ee_version);\n\n\tee->ee_turbo_max_power[AR5K_EEPROM_MODE_11A] =\n\t\tAR5K_EEPROM_HDR_T_5GHZ_DBM(ee->ee_header);\n\n\tfor (mode = AR5K_EEPROM_MODE_11A; mode <= AR5K_EEPROM_MODE_11G; mode++) {\n\t\toffset = mode_offset[mode];\n\n\t\tret = ath5k_eeprom_read_ants(ah, &offset, mode);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = ath5k_eeprom_read_modes(ah, &offset, mode);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (ah->ah_ee_version <= AR5K_EEPROM_VERSION_3_2) {\n\t\tee->ee_thr_62[AR5K_EEPROM_MODE_11A] = 15;\n\t\tee->ee_thr_62[AR5K_EEPROM_MODE_11B] = 28;\n\t\tee->ee_thr_62[AR5K_EEPROM_MODE_11G] = 28;\n\t}\n\n\treturn 0;\n}\n\n \nstatic inline int\nath5k_eeprom_read_freq_list(struct ath5k_hw *ah, int *offset, int max,\n\t\t\tstruct ath5k_chan_pcal_info *pc, unsigned int mode)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tint o = *offset;\n\tint i = 0;\n\tu8 freq1, freq2;\n\tu16 val;\n\n\tee->ee_n_piers[mode] = 0;\n\twhile (i < max) {\n\t\tAR5K_EEPROM_READ(o++, val);\n\n\t\tfreq1 = val & 0xff;\n\t\tif (!freq1)\n\t\t\tbreak;\n\n\t\tpc[i++].freq = ath5k_eeprom_bin2freq(ee,\n\t\t\t\tfreq1, mode);\n\t\tee->ee_n_piers[mode]++;\n\n\t\tfreq2 = (val >> 8) & 0xff;\n\t\tif (!freq2 || i >= max)\n\t\t\tbreak;\n\n\t\tpc[i++].freq = ath5k_eeprom_bin2freq(ee,\n\t\t\t\tfreq2, mode);\n\t\tee->ee_n_piers[mode]++;\n\t}\n\n\t \n\t*offset = o;\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_eeprom_init_11a_pcal_freq(struct ath5k_hw *ah, int offset)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_chan_pcal_info *pcal = ee->ee_pwr_cal_a;\n\tint i;\n\tu16 val;\n\tu8 mask;\n\n\tif (ee->ee_version >= AR5K_EEPROM_VERSION_3_3) {\n\t\tath5k_eeprom_read_freq_list(ah, &offset,\n\t\t\tAR5K_EEPROM_N_5GHZ_CHAN, pcal,\n\t\t\tAR5K_EEPROM_MODE_11A);\n\t} else {\n\t\tmask = AR5K_EEPROM_FREQ_M(ah->ah_ee_version);\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tpcal[0].freq  = (val >> 9) & mask;\n\t\tpcal[1].freq  = (val >> 2) & mask;\n\t\tpcal[2].freq  = (val << 5) & mask;\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tpcal[2].freq |= (val >> 11) & 0x1f;\n\t\tpcal[3].freq  = (val >> 4) & mask;\n\t\tpcal[4].freq  = (val << 3) & mask;\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tpcal[4].freq |= (val >> 13) & 0x7;\n\t\tpcal[5].freq  = (val >> 6) & mask;\n\t\tpcal[6].freq  = (val << 1) & mask;\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tpcal[6].freq |= (val >> 15) & 0x1;\n\t\tpcal[7].freq  = (val >> 8) & mask;\n\t\tpcal[8].freq  = (val >> 1) & mask;\n\t\tpcal[9].freq  = (val << 6) & mask;\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tpcal[9].freq |= (val >> 10) & 0x3f;\n\n\t\t \n\t\tee->ee_n_piers[AR5K_EEPROM_MODE_11A] = 10;\n\n\t\tfor (i = 0; i < AR5K_EEPROM_N_5GHZ_CHAN; i++) {\n\t\t\tpcal[i].freq = ath5k_eeprom_bin2freq(ee,\n\t\t\t\tpcal[i].freq, AR5K_EEPROM_MODE_11A);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n \nstatic inline int\nath5k_eeprom_init_11bg_2413(struct ath5k_hw *ah, unsigned int mode, int offset)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_chan_pcal_info *pcal;\n\n\tswitch (mode) {\n\tcase AR5K_EEPROM_MODE_11B:\n\t\tpcal = ee->ee_pwr_cal_b;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11G:\n\t\tpcal = ee->ee_pwr_cal_g;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tath5k_eeprom_read_freq_list(ah, &offset,\n\t\tAR5K_EEPROM_N_2GHZ_CHAN_2413, pcal,\n\t\tmode);\n\n\treturn 0;\n}\n\n\n \n\n \nstatic inline void\nath5k_get_pcdac_intercepts(struct ath5k_hw *ah, u8 min, u8 max, u8 *vp)\n{\n\tstatic const u16 intercepts3[] = {\n\t\t0, 5, 10, 20, 30, 50, 70, 85, 90, 95, 100\n\t};\n\tstatic const u16 intercepts3_2[] = {\n\t\t0, 10, 20, 30, 40, 50, 60, 70, 80, 90, 100\n\t};\n\tconst u16 *ip;\n\tint i;\n\n\tif (ah->ah_ee_version >= AR5K_EEPROM_VERSION_3_2)\n\t\tip = intercepts3_2;\n\telse\n\t\tip = intercepts3;\n\n\tfor (i = 0; i < ARRAY_SIZE(intercepts3); i++)\n\t\tvp[i] = (ip[i] * max + (100 - ip[i]) * min) / 100;\n}\n\nstatic int\nath5k_eeprom_free_pcal_info(struct ath5k_hw *ah, int mode)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_chan_pcal_info *chinfo;\n\tu8 pier, pdg;\n\n\tswitch (mode) {\n\tcase AR5K_EEPROM_MODE_11A:\n\t\tif (!AR5K_EEPROM_HDR_11A(ee->ee_header))\n\t\t\treturn 0;\n\t\tchinfo = ee->ee_pwr_cal_a;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11B:\n\t\tif (!AR5K_EEPROM_HDR_11B(ee->ee_header))\n\t\t\treturn 0;\n\t\tchinfo = ee->ee_pwr_cal_b;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11G:\n\t\tif (!AR5K_EEPROM_HDR_11G(ee->ee_header))\n\t\t\treturn 0;\n\t\tchinfo = ee->ee_pwr_cal_g;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tfor (pier = 0; pier < ee->ee_n_piers[mode]; pier++) {\n\t\tif (!chinfo[pier].pd_curves)\n\t\t\tcontinue;\n\n\t\tfor (pdg = 0; pdg < AR5K_EEPROM_N_PD_CURVES; pdg++) {\n\t\t\tstruct ath5k_pdgain_info *pd =\n\t\t\t\t\t&chinfo[pier].pd_curves[pdg];\n\n\t\t\tkfree(pd->pd_step);\n\t\t\tkfree(pd->pd_pwr);\n\t\t}\n\n\t\tkfree(chinfo[pier].pd_curves);\n\t}\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_eeprom_convert_pcal_info_5111(struct ath5k_hw *ah, int mode,\n\t\t\t\tstruct ath5k_chan_pcal_info *chinfo)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_chan_pcal_info_rf5111 *pcinfo;\n\tstruct ath5k_pdgain_info *pd;\n\tu8 pier, point, idx;\n\tu8 *pdgain_idx = ee->ee_pdc_to_idx[mode];\n\n\t \n\tfor (pier = 0; pier < ee->ee_n_piers[mode]; pier++) {\n\n\t\tpcinfo = &chinfo[pier].rf5111_info;\n\n\t\t \n\t\tchinfo[pier].pd_curves =\n\t\t\tkcalloc(AR5K_EEPROM_N_PD_CURVES,\n\t\t\t\tsizeof(struct ath5k_pdgain_info),\n\t\t\t\tGFP_KERNEL);\n\n\t\tif (!chinfo[pier].pd_curves)\n\t\t\tgoto err_out;\n\n\t\t \n\t\tfor (idx = 0; idx < AR5K_EEPROM_N_PD_CURVES; idx++) {\n\n\t\t\tif (!((ee->ee_x_gain[mode] >> idx) & 0x1)) {\n\t\t\t\tpdgain_idx[0] = idx;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (idx == AR5K_EEPROM_N_PD_CURVES)\n\t\t\tgoto err_out;\n\n\t\tee->ee_pd_gains[mode] = 1;\n\n\t\tpd = &chinfo[pier].pd_curves[idx];\n\n\t\tpd->pd_points = AR5K_EEPROM_N_PWR_POINTS_5111;\n\n\t\t \n\t\tpd->pd_step = kcalloc(AR5K_EEPROM_N_PWR_POINTS_5111,\n\t\t\t\t\tsizeof(u8), GFP_KERNEL);\n\t\tif (!pd->pd_step)\n\t\t\tgoto err_out;\n\n\t\tpd->pd_pwr = kcalloc(AR5K_EEPROM_N_PWR_POINTS_5111,\n\t\t\t\t\tsizeof(s16), GFP_KERNEL);\n\t\tif (!pd->pd_pwr)\n\t\t\tgoto err_out;\n\n\t\t \n\t\tfor (point = 0; point < pd->pd_points; point++) {\n\n\t\t\t \n\t\t\tpd->pd_pwr[point] = 2 * pcinfo->pwr[point];\n\n\t\t\t \n\t\t\tpd->pd_step[point] = pcinfo->pcdac[point];\n\t\t}\n\n\t\t \n\t\tchinfo[pier].min_pwr = pd->pd_pwr[0];\n\t\tchinfo[pier].max_pwr = pd->pd_pwr[10];\n\n\t}\n\n\treturn 0;\n\nerr_out:\n\tath5k_eeprom_free_pcal_info(ah, mode);\n\treturn -ENOMEM;\n}\n\n \nstatic int\nath5k_eeprom_read_pcal_info_5111(struct ath5k_hw *ah, int mode)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_chan_pcal_info *pcal;\n\tint offset, ret;\n\tint i;\n\tu16 val;\n\n\toffset = AR5K_EEPROM_GROUPS_START(ee->ee_version);\n\tswitch (mode) {\n\tcase AR5K_EEPROM_MODE_11A:\n\t\tif (!AR5K_EEPROM_HDR_11A(ee->ee_header))\n\t\t\treturn 0;\n\n\t\tret = ath5k_eeprom_init_11a_pcal_freq(ah,\n\t\t\toffset + AR5K_EEPROM_GROUP1_OFFSET);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\toffset += AR5K_EEPROM_GROUP2_OFFSET;\n\t\tpcal = ee->ee_pwr_cal_a;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11B:\n\t\tif (!AR5K_EEPROM_HDR_11B(ee->ee_header) &&\n\t\t    !AR5K_EEPROM_HDR_11G(ee->ee_header))\n\t\t\treturn 0;\n\n\t\tpcal = ee->ee_pwr_cal_b;\n\t\toffset += AR5K_EEPROM_GROUP3_OFFSET;\n\n\t\t \n\t\tpcal[0].freq = 2412;\n\t\tpcal[1].freq = 2447;\n\t\tpcal[2].freq = 2484;\n\t\tee->ee_n_piers[mode] = 3;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11G:\n\t\tif (!AR5K_EEPROM_HDR_11G(ee->ee_header))\n\t\t\treturn 0;\n\n\t\tpcal = ee->ee_pwr_cal_g;\n\t\toffset += AR5K_EEPROM_GROUP4_OFFSET;\n\n\t\t \n\t\tpcal[0].freq = 2312;\n\t\tpcal[1].freq = 2412;\n\t\tpcal[2].freq = 2484;\n\t\tee->ee_n_piers[mode] = 3;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tfor (i = 0; i < ee->ee_n_piers[mode]; i++) {\n\t\tstruct ath5k_chan_pcal_info_rf5111 *cdata =\n\t\t\t&pcal[i].rf5111_info;\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tcdata->pcdac_max = ((val >> 10) & AR5K_EEPROM_PCDAC_M);\n\t\tcdata->pcdac_min = ((val >> 4) & AR5K_EEPROM_PCDAC_M);\n\t\tcdata->pwr[0] = ((val << 2) & AR5K_EEPROM_POWER_M);\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tcdata->pwr[0] |= ((val >> 14) & 0x3);\n\t\tcdata->pwr[1] = ((val >> 8) & AR5K_EEPROM_POWER_M);\n\t\tcdata->pwr[2] = ((val >> 2) & AR5K_EEPROM_POWER_M);\n\t\tcdata->pwr[3] = ((val << 4) & AR5K_EEPROM_POWER_M);\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tcdata->pwr[3] |= ((val >> 12) & 0xf);\n\t\tcdata->pwr[4] = ((val >> 6) & AR5K_EEPROM_POWER_M);\n\t\tcdata->pwr[5] = (val  & AR5K_EEPROM_POWER_M);\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tcdata->pwr[6] = ((val >> 10) & AR5K_EEPROM_POWER_M);\n\t\tcdata->pwr[7] = ((val >> 4) & AR5K_EEPROM_POWER_M);\n\t\tcdata->pwr[8] = ((val << 2) & AR5K_EEPROM_POWER_M);\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tcdata->pwr[8] |= ((val >> 14) & 0x3);\n\t\tcdata->pwr[9] = ((val >> 8) & AR5K_EEPROM_POWER_M);\n\t\tcdata->pwr[10] = ((val >> 2) & AR5K_EEPROM_POWER_M);\n\n\t\tath5k_get_pcdac_intercepts(ah, cdata->pcdac_min,\n\t\t\tcdata->pcdac_max, cdata->pcdac);\n\t}\n\n\treturn ath5k_eeprom_convert_pcal_info_5111(ah, mode, pcal);\n}\n\n\n \n\n \nstatic int\nath5k_eeprom_convert_pcal_info_5112(struct ath5k_hw *ah, int mode,\n\t\t\t\tstruct ath5k_chan_pcal_info *chinfo)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_chan_pcal_info_rf5112 *pcinfo;\n\tu8 *pdgain_idx = ee->ee_pdc_to_idx[mode];\n\tunsigned int pier, pdg, point;\n\n\t \n\tfor (pier = 0; pier < ee->ee_n_piers[mode]; pier++) {\n\n\t\tpcinfo = &chinfo[pier].rf5112_info;\n\n\t\t \n\t\tchinfo[pier].pd_curves =\n\t\t\t\tkcalloc(AR5K_EEPROM_N_PD_CURVES,\n\t\t\t\t\tsizeof(struct ath5k_pdgain_info),\n\t\t\t\t\tGFP_KERNEL);\n\n\t\tif (!chinfo[pier].pd_curves)\n\t\t\tgoto err_out;\n\n\t\t \n\t\tfor (pdg = 0; pdg < ee->ee_pd_gains[mode]; pdg++) {\n\n\t\t\tu8 idx = pdgain_idx[pdg];\n\t\t\tstruct ath5k_pdgain_info *pd =\n\t\t\t\t\t&chinfo[pier].pd_curves[idx];\n\n\t\t\t \n\t\t\tif (pdg == 0) {\n\t\t\t\t \n\t\t\t\tpd->pd_points = AR5K_EEPROM_N_XPD0_POINTS;\n\n\t\t\t\t \n\t\t\t\tpd->pd_step = kcalloc(pd->pd_points,\n\t\t\t\t\t\tsizeof(u8), GFP_KERNEL);\n\n\t\t\t\tif (!pd->pd_step)\n\t\t\t\t\tgoto err_out;\n\n\t\t\t\tpd->pd_pwr = kcalloc(pd->pd_points,\n\t\t\t\t\t\tsizeof(s16), GFP_KERNEL);\n\n\t\t\t\tif (!pd->pd_pwr)\n\t\t\t\t\tgoto err_out;\n\n\t\t\t\t \n\t\t\t\tpd->pd_step[0] = pcinfo->pcdac_x0[0];\n\t\t\t\tpd->pd_pwr[0] = pcinfo->pwr_x0[0];\n\n\t\t\t\tfor (point = 1; point < pd->pd_points;\n\t\t\t\tpoint++) {\n\t\t\t\t\t \n\t\t\t\t\tpd->pd_pwr[point] =\n\t\t\t\t\t\tpcinfo->pwr_x0[point];\n\n\t\t\t\t\t \n\t\t\t\t\tpd->pd_step[point] =\n\t\t\t\t\t\tpd->pd_step[point - 1] +\n\t\t\t\t\t\tpcinfo->pcdac_x0[point];\n\t\t\t\t}\n\n\t\t\t\t \n\t\t\t\tchinfo[pier].min_pwr = pd->pd_pwr[0];\n\n\t\t\t \n\t\t\t} else if (pdg == 1) {\n\n\t\t\t\tpd->pd_points = AR5K_EEPROM_N_XPD3_POINTS;\n\n\t\t\t\t \n\t\t\t\tpd->pd_step = kcalloc(pd->pd_points,\n\t\t\t\t\t\tsizeof(u8), GFP_KERNEL);\n\n\t\t\t\tif (!pd->pd_step)\n\t\t\t\t\tgoto err_out;\n\n\t\t\t\tpd->pd_pwr = kcalloc(pd->pd_points,\n\t\t\t\t\t\tsizeof(s16), GFP_KERNEL);\n\n\t\t\t\tif (!pd->pd_pwr)\n\t\t\t\t\tgoto err_out;\n\n\t\t\t\t \n\t\t\t\tfor (point = 0; point < pd->pd_points;\n\t\t\t\tpoint++) {\n\t\t\t\t\t \n\t\t\t\t\tpd->pd_pwr[point] =\n\t\t\t\t\t\tpcinfo->pwr_x3[point];\n\n\t\t\t\t\t \n\t\t\t\t\tpd->pd_step[point] =\n\t\t\t\t\t\tpcinfo->pcdac_x3[point];\n\t\t\t\t}\n\n\t\t\t\t \n\t\t\t\tchinfo[pier].min_pwr = pd->pd_pwr[0];\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 0;\n\nerr_out:\n\tath5k_eeprom_free_pcal_info(ah, mode);\n\treturn -ENOMEM;\n}\n\n \nstatic int\nath5k_eeprom_read_pcal_info_5112(struct ath5k_hw *ah, int mode)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_chan_pcal_info_rf5112 *chan_pcal_info;\n\tstruct ath5k_chan_pcal_info *gen_chan_info;\n\tu8 *pdgain_idx = ee->ee_pdc_to_idx[mode];\n\tu32 offset;\n\tu8 i, c;\n\tu16 val;\n\tu8 pd_gains = 0;\n\n\t \n\tfor (i = 0; i < AR5K_EEPROM_N_PD_CURVES; i++) {\n\t\t \n\t\tif ((ee->ee_x_gain[mode] >> i) & 0x1)\n\t\t\tpdgain_idx[pd_gains++] = i;\n\t}\n\tee->ee_pd_gains[mode] = pd_gains;\n\n\tif (pd_gains == 0 || pd_gains > 2)\n\t\treturn -EINVAL;\n\n\tswitch (mode) {\n\tcase AR5K_EEPROM_MODE_11A:\n\t\t \n\t\toffset = AR5K_EEPROM_GROUPS_START(ee->ee_version);\n\t\tath5k_eeprom_init_11a_pcal_freq(ah, offset);\n\n\t\toffset += AR5K_EEPROM_GROUP2_OFFSET;\n\t\tgen_chan_info = ee->ee_pwr_cal_a;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11B:\n\t\toffset = AR5K_EEPROM_GROUPS_START(ee->ee_version);\n\t\tif (AR5K_EEPROM_HDR_11A(ee->ee_header))\n\t\t\toffset += AR5K_EEPROM_GROUP3_OFFSET;\n\n\t\t \n\t\tgen_chan_info = ee->ee_pwr_cal_b;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11G:\n\t\toffset = AR5K_EEPROM_GROUPS_START(ee->ee_version);\n\t\tif (AR5K_EEPROM_HDR_11A(ee->ee_header))\n\t\t\toffset += AR5K_EEPROM_GROUP4_OFFSET;\n\t\telse if (AR5K_EEPROM_HDR_11B(ee->ee_header))\n\t\t\toffset += AR5K_EEPROM_GROUP2_OFFSET;\n\n\t\t \n\t\tgen_chan_info = ee->ee_pwr_cal_g;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tfor (i = 0; i < ee->ee_n_piers[mode]; i++) {\n\t\tchan_pcal_info = &gen_chan_info[i].rf5112_info;\n\n\t\t \n\t\tfor (c = 0; c < AR5K_EEPROM_N_XPD0_POINTS; c++) {\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tchan_pcal_info->pwr_x0[c] = (s8) (val & 0xff);\n\t\t\tchan_pcal_info->pwr_x0[++c] = (s8) ((val >> 8) & 0xff);\n\t\t}\n\n\t\t \n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tchan_pcal_info->pcdac_x0[1] = (val & 0x1f);\n\t\tchan_pcal_info->pcdac_x0[2] = ((val >> 5) & 0x1f);\n\t\tchan_pcal_info->pcdac_x0[3] = ((val >> 10) & 0x1f);\n\n\t\t \n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tchan_pcal_info->pwr_x3[0] = (s8) (val & 0xff);\n\t\tchan_pcal_info->pwr_x3[1] = (s8) ((val >> 8) & 0xff);\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tchan_pcal_info->pwr_x3[2] = (val & 0xff);\n\n\t\t \n\t\tchan_pcal_info->pcdac_x3[0] = 20;\n\t\tchan_pcal_info->pcdac_x3[1] = 35;\n\t\tchan_pcal_info->pcdac_x3[2] = 63;\n\n\t\tif (ee->ee_version >= AR5K_EEPROM_VERSION_4_3) {\n\t\t\tchan_pcal_info->pcdac_x0[0] = ((val >> 8) & 0x3f);\n\n\t\t\t \n\t\t\tgen_chan_info[i].max_pwr = chan_pcal_info->pwr_x0[3];\n\t\t} else {\n\t\t\tchan_pcal_info->pcdac_x0[0] = 1;\n\t\t\tgen_chan_info[i].max_pwr = (s8) ((val >> 8) & 0xff);\n\t\t}\n\n\t}\n\n\treturn ath5k_eeprom_convert_pcal_info_5112(ah, mode, gen_chan_info);\n}\n\n\n \n\n \n\n \nstatic inline unsigned int\nath5k_pdgains_size_2413(struct ath5k_eeprom_info *ee, unsigned int mode)\n{\n\tstatic const unsigned int pdgains_size[] = { 4, 6, 9, 12 };\n\tunsigned int sz;\n\n\tsz = pdgains_size[ee->ee_pd_gains[mode] - 1];\n\tsz *= ee->ee_n_piers[mode];\n\n\treturn sz;\n}\n\n \nstatic unsigned int\nath5k_cal_data_offset_2413(struct ath5k_eeprom_info *ee, int mode)\n{\n\tu32 offset = AR5K_EEPROM_CAL_DATA_START(ee->ee_misc4);\n\n\tswitch (mode) {\n\tcase AR5K_EEPROM_MODE_11G:\n\t\tif (AR5K_EEPROM_HDR_11B(ee->ee_header))\n\t\t\toffset += ath5k_pdgains_size_2413(ee,\n\t\t\t\t\tAR5K_EEPROM_MODE_11B) +\n\t\t\t\t\tAR5K_EEPROM_N_2GHZ_CHAN_2413 / 2;\n\t\tfallthrough;\n\tcase AR5K_EEPROM_MODE_11B:\n\t\tif (AR5K_EEPROM_HDR_11A(ee->ee_header))\n\t\t\toffset += ath5k_pdgains_size_2413(ee,\n\t\t\t\t\tAR5K_EEPROM_MODE_11A) +\n\t\t\t\t\tAR5K_EEPROM_N_5GHZ_CHAN / 2;\n\t\tfallthrough;\n\tcase AR5K_EEPROM_MODE_11A:\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn offset;\n}\n\n \nstatic int\nath5k_eeprom_convert_pcal_info_2413(struct ath5k_hw *ah, int mode,\n\t\t\t\tstruct ath5k_chan_pcal_info *chinfo)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_chan_pcal_info_rf2413 *pcinfo;\n\tu8 *pdgain_idx = ee->ee_pdc_to_idx[mode];\n\tunsigned int pier, pdg, point;\n\n\t \n\tfor (pier = 0; pier < ee->ee_n_piers[mode]; pier++) {\n\n\t\tpcinfo = &chinfo[pier].rf2413_info;\n\n\t\t \n\t\tchinfo[pier].pd_curves =\n\t\t\t\tkcalloc(AR5K_EEPROM_N_PD_CURVES,\n\t\t\t\t\tsizeof(struct ath5k_pdgain_info),\n\t\t\t\t\tGFP_KERNEL);\n\n\t\tif (!chinfo[pier].pd_curves)\n\t\t\tgoto err_out;\n\n\t\t \n\t\tfor (pdg = 0; pdg < ee->ee_pd_gains[mode]; pdg++) {\n\n\t\t\tu8 idx = pdgain_idx[pdg];\n\t\t\tstruct ath5k_pdgain_info *pd =\n\t\t\t\t\t&chinfo[pier].pd_curves[idx];\n\n\t\t\t \n\t\t\tif (pdg == ee->ee_pd_gains[mode] - 1)\n\t\t\t\tpd->pd_points = AR5K_EEPROM_N_PD_POINTS;\n\t\t\telse\n\t\t\t\tpd->pd_points = AR5K_EEPROM_N_PD_POINTS - 1;\n\n\t\t\t \n\t\t\tpd->pd_step = kcalloc(pd->pd_points,\n\t\t\t\t\tsizeof(u8), GFP_KERNEL);\n\n\t\t\tif (!pd->pd_step)\n\t\t\t\tgoto err_out;\n\n\t\t\tpd->pd_pwr = kcalloc(pd->pd_points,\n\t\t\t\t\tsizeof(s16), GFP_KERNEL);\n\n\t\t\tif (!pd->pd_pwr)\n\t\t\t\tgoto err_out;\n\n\t\t\t \n\t\t\tpd->pd_step[0] = pcinfo->pddac_i[pdg];\n\t\t\tpd->pd_pwr[0] = 4 * pcinfo->pwr_i[pdg];\n\n\t\t\tfor (point = 1; point < pd->pd_points; point++) {\n\n\t\t\t\tpd->pd_pwr[point] = pd->pd_pwr[point - 1] +\n\t\t\t\t\t2 * pcinfo->pwr[pdg][point - 1];\n\n\t\t\t\tpd->pd_step[point] = pd->pd_step[point - 1] +\n\t\t\t\t\t\tpcinfo->pddac[pdg][point - 1];\n\n\t\t\t}\n\n\t\t\t \n\t\t\tif (pdg == 0)\n\t\t\t\tchinfo[pier].min_pwr = pd->pd_pwr[0];\n\n\t\t\t \n\t\t\tif (pdg == ee->ee_pd_gains[mode] - 1)\n\t\t\t\tchinfo[pier].max_pwr =\n\t\t\t\t\tpd->pd_pwr[pd->pd_points - 1];\n\t\t}\n\t}\n\n\treturn 0;\n\nerr_out:\n\tath5k_eeprom_free_pcal_info(ah, mode);\n\treturn -ENOMEM;\n}\n\n \nstatic int\nath5k_eeprom_read_pcal_info_2413(struct ath5k_hw *ah, int mode)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_chan_pcal_info_rf2413 *pcinfo;\n\tstruct ath5k_chan_pcal_info *chinfo;\n\tu8 *pdgain_idx = ee->ee_pdc_to_idx[mode];\n\tu32 offset;\n\tint idx, i;\n\tu16 val;\n\tu8 pd_gains = 0;\n\n\t \n\tfor (idx = AR5K_EEPROM_N_PD_CURVES - 1; idx >= 0; idx--) {\n\t\t \n\t\tif ((ee->ee_x_gain[mode] >> idx) & 0x1)\n\t\t\tpdgain_idx[pd_gains++] = idx;\n\n\t}\n\tee->ee_pd_gains[mode] = pd_gains;\n\n\tif (pd_gains == 0)\n\t\treturn -EINVAL;\n\n\toffset = ath5k_cal_data_offset_2413(ee, mode);\n\tswitch (mode) {\n\tcase AR5K_EEPROM_MODE_11A:\n\t\tif (!AR5K_EEPROM_HDR_11A(ee->ee_header))\n\t\t\treturn 0;\n\n\t\tath5k_eeprom_init_11a_pcal_freq(ah, offset);\n\t\toffset += AR5K_EEPROM_N_5GHZ_CHAN / 2;\n\t\tchinfo = ee->ee_pwr_cal_a;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11B:\n\t\tif (!AR5K_EEPROM_HDR_11B(ee->ee_header))\n\t\t\treturn 0;\n\n\t\tath5k_eeprom_init_11bg_2413(ah, mode, offset);\n\t\toffset += AR5K_EEPROM_N_2GHZ_CHAN_2413 / 2;\n\t\tchinfo = ee->ee_pwr_cal_b;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11G:\n\t\tif (!AR5K_EEPROM_HDR_11G(ee->ee_header))\n\t\t\treturn 0;\n\n\t\tath5k_eeprom_init_11bg_2413(ah, mode, offset);\n\t\toffset += AR5K_EEPROM_N_2GHZ_CHAN_2413 / 2;\n\t\tchinfo = ee->ee_pwr_cal_g;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tfor (i = 0; i < ee->ee_n_piers[mode]; i++) {\n\t\tpcinfo = &chinfo[i].rf2413_info;\n\n\t\t \n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tpcinfo->pwr_i[0] = val & 0x1f;\n\t\tpcinfo->pddac_i[0] = (val >> 5) & 0x7f;\n\t\tpcinfo->pwr[0][0] = (val >> 12) & 0xf;\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tpcinfo->pddac[0][0] = val & 0x3f;\n\t\tpcinfo->pwr[0][1] = (val >> 6) & 0xf;\n\t\tpcinfo->pddac[0][1] = (val >> 10) & 0x3f;\n\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tpcinfo->pwr[0][2] = val & 0xf;\n\t\tpcinfo->pddac[0][2] = (val >> 4) & 0x3f;\n\n\t\tpcinfo->pwr[0][3] = 0;\n\t\tpcinfo->pddac[0][3] = 0;\n\n\t\tif (pd_gains > 1) {\n\t\t\t \n\t\t\tpcinfo->pwr_i[1] = (val >> 10) & 0x1f;\n\n\t\t\tpcinfo->pddac_i[1] = (val >> 15) & 0x1;\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pddac_i[1] |= (val & 0x3F) << 1;\n\n\t\t\tpcinfo->pwr[1][0] = (val >> 6) & 0xf;\n\t\t\tpcinfo->pddac[1][0] = (val >> 10) & 0x3f;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pwr[1][1] = val & 0xf;\n\t\t\tpcinfo->pddac[1][1] = (val >> 4) & 0x3f;\n\t\t\tpcinfo->pwr[1][2] = (val >> 10) & 0xf;\n\n\t\t\tpcinfo->pddac[1][2] = (val >> 14) & 0x3;\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pddac[1][2] |= (val & 0xF) << 2;\n\n\t\t\tpcinfo->pwr[1][3] = 0;\n\t\t\tpcinfo->pddac[1][3] = 0;\n\t\t} else if (pd_gains == 1) {\n\t\t\t \n\t\t\tpcinfo->pwr[0][3] = (val >> 10) & 0xf;\n\n\t\t\tpcinfo->pddac[0][3] = (val >> 14) & 0x3;\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pddac[0][3] |= (val & 0xF) << 2;\n\t\t}\n\n\t\t \n\t\tif (pd_gains > 2) {\n\t\t\tpcinfo->pwr_i[2] = (val >> 4) & 0x1f;\n\t\t\tpcinfo->pddac_i[2] = (val >> 9) & 0x7f;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pwr[2][0] = (val >> 0) & 0xf;\n\t\t\tpcinfo->pddac[2][0] = (val >> 4) & 0x3f;\n\t\t\tpcinfo->pwr[2][1] = (val >> 10) & 0xf;\n\n\t\t\tpcinfo->pddac[2][1] = (val >> 14) & 0x3;\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pddac[2][1] |= (val & 0xF) << 2;\n\n\t\t\tpcinfo->pwr[2][2] = (val >> 4) & 0xf;\n\t\t\tpcinfo->pddac[2][2] = (val >> 8) & 0x3f;\n\n\t\t\tpcinfo->pwr[2][3] = 0;\n\t\t\tpcinfo->pddac[2][3] = 0;\n\t\t} else if (pd_gains == 2) {\n\t\t\tpcinfo->pwr[1][3] = (val >> 4) & 0xf;\n\t\t\tpcinfo->pddac[1][3] = (val >> 8) & 0x3f;\n\t\t}\n\n\t\tif (pd_gains > 3) {\n\t\t\tpcinfo->pwr_i[3] = (val >> 14) & 0x3;\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pwr_i[3] |= ((val >> 0) & 0x7) << 2;\n\n\t\t\tpcinfo->pddac_i[3] = (val >> 3) & 0x7f;\n\t\t\tpcinfo->pwr[3][0] = (val >> 10) & 0xf;\n\t\t\tpcinfo->pddac[3][0] = (val >> 14) & 0x3;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pddac[3][0] |= (val & 0xF) << 2;\n\t\t\tpcinfo->pwr[3][1] = (val >> 4) & 0xf;\n\t\t\tpcinfo->pddac[3][1] = (val >> 8) & 0x3f;\n\n\t\t\tpcinfo->pwr[3][2] = (val >> 14) & 0x3;\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pwr[3][2] |= ((val >> 0) & 0x3) << 2;\n\n\t\t\tpcinfo->pddac[3][2] = (val >> 2) & 0x3f;\n\t\t\tpcinfo->pwr[3][3] = (val >> 8) & 0xf;\n\n\t\t\tpcinfo->pddac[3][3] = (val >> 12) & 0xF;\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pddac[3][3] |= ((val >> 0) & 0x3) << 4;\n\t\t} else if (pd_gains == 3) {\n\t\t\tpcinfo->pwr[2][3] = (val >> 14) & 0x3;\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\tpcinfo->pwr[2][3] |= ((val >> 0) & 0x3) << 2;\n\n\t\t\tpcinfo->pddac[2][3] = (val >> 2) & 0x3f;\n\t\t}\n\t}\n\n\treturn ath5k_eeprom_convert_pcal_info_2413(ah, mode, chinfo);\n}\n\n\n \nstatic int\nath5k_eeprom_read_target_rate_pwr_info(struct ath5k_hw *ah, unsigned int mode)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_rate_pcal_info *rate_pcal_info;\n\tu8 *rate_target_pwr_num;\n\tu32 offset;\n\tu16 val;\n\tint i;\n\n\toffset = AR5K_EEPROM_TARGET_PWRSTART(ee->ee_misc1);\n\trate_target_pwr_num = &ee->ee_rate_target_pwr_num[mode];\n\tswitch (mode) {\n\tcase AR5K_EEPROM_MODE_11A:\n\t\toffset += AR5K_EEPROM_TARGET_PWR_OFF_11A(ee->ee_version);\n\t\trate_pcal_info = ee->ee_rate_tpwr_a;\n\t\tee->ee_rate_target_pwr_num[mode] = AR5K_EEPROM_N_5GHZ_RATE_CHAN;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11B:\n\t\toffset += AR5K_EEPROM_TARGET_PWR_OFF_11B(ee->ee_version);\n\t\trate_pcal_info = ee->ee_rate_tpwr_b;\n\t\tee->ee_rate_target_pwr_num[mode] = 2;  \n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11G:\n\t\toffset += AR5K_EEPROM_TARGET_PWR_OFF_11G(ee->ee_version);\n\t\trate_pcal_info = ee->ee_rate_tpwr_g;\n\t\tee->ee_rate_target_pwr_num[mode] = AR5K_EEPROM_N_2GHZ_CHAN;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (ee->ee_version <= AR5K_EEPROM_VERSION_3_2) {\n\t\tfor (i = 0; i < (*rate_target_pwr_num); i++) {\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\trate_pcal_info[i].freq =\n\t\t\t    ath5k_eeprom_bin2freq(ee, (val >> 9) & 0x7f, mode);\n\n\t\t\trate_pcal_info[i].target_power_6to24 = ((val >> 3) & 0x3f);\n\t\t\trate_pcal_info[i].target_power_36 = (val << 3) & 0x3f;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\n\t\t\tif (rate_pcal_info[i].freq == AR5K_EEPROM_CHANNEL_DIS ||\n\t\t\t    val == 0) {\n\t\t\t\t(*rate_target_pwr_num) = i;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\trate_pcal_info[i].target_power_36 |= ((val >> 13) & 0x7);\n\t\t\trate_pcal_info[i].target_power_48 = ((val >> 7) & 0x3f);\n\t\t\trate_pcal_info[i].target_power_54 = ((val >> 1) & 0x3f);\n\t\t}\n\t} else {\n\t\tfor (i = 0; i < (*rate_target_pwr_num); i++) {\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\trate_pcal_info[i].freq =\n\t\t\t    ath5k_eeprom_bin2freq(ee, (val >> 8) & 0xff, mode);\n\n\t\t\trate_pcal_info[i].target_power_6to24 = ((val >> 2) & 0x3f);\n\t\t\trate_pcal_info[i].target_power_36 = (val << 4) & 0x3f;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\n\t\t\tif (rate_pcal_info[i].freq == AR5K_EEPROM_CHANNEL_DIS ||\n\t\t\t    val == 0) {\n\t\t\t\t(*rate_target_pwr_num) = i;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\trate_pcal_info[i].target_power_36 |= (val >> 12) & 0xf;\n\t\t\trate_pcal_info[i].target_power_48 = ((val >> 6) & 0x3f);\n\t\t\trate_pcal_info[i].target_power_54 = (val & 0x3f);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n\n \nstatic int\nath5k_eeprom_read_pcal_info(struct ath5k_hw *ah)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tint (*read_pcal)(struct ath5k_hw *hw, int mode);\n\tint mode;\n\tint err;\n\n\tif ((ah->ah_ee_version >= AR5K_EEPROM_VERSION_4_0) &&\n\t\t\t(AR5K_EEPROM_EEMAP(ee->ee_misc0) == 1))\n\t\tread_pcal = ath5k_eeprom_read_pcal_info_5112;\n\telse if ((ah->ah_ee_version >= AR5K_EEPROM_VERSION_5_0) &&\n\t\t\t(AR5K_EEPROM_EEMAP(ee->ee_misc0) == 2))\n\t\tread_pcal = ath5k_eeprom_read_pcal_info_2413;\n\telse\n\t\tread_pcal = ath5k_eeprom_read_pcal_info_5111;\n\n\n\tfor (mode = AR5K_EEPROM_MODE_11A; mode <= AR5K_EEPROM_MODE_11G;\n\tmode++) {\n\t\terr = read_pcal(ah, mode);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = ath5k_eeprom_read_target_rate_pwr_info(ah, mode);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_eeprom_read_ctl_info(struct ath5k_hw *ah)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_edge_power *rep;\n\tunsigned int fmask, pmask;\n\tunsigned int ctl_mode;\n\tint i, j;\n\tu32 offset;\n\tu16 val;\n\n\tpmask = AR5K_EEPROM_POWER_M;\n\tfmask = AR5K_EEPROM_FREQ_M(ee->ee_version);\n\toffset = AR5K_EEPROM_CTL(ee->ee_version);\n\tee->ee_ctls = AR5K_EEPROM_N_CTLS(ee->ee_version);\n\tfor (i = 0; i < ee->ee_ctls; i += 2) {\n\t\tAR5K_EEPROM_READ(offset++, val);\n\t\tee->ee_ctl[i] = (val >> 8) & 0xff;\n\t\tee->ee_ctl[i + 1] = val & 0xff;\n\t}\n\n\toffset = AR5K_EEPROM_GROUP8_OFFSET;\n\tif (ee->ee_version >= AR5K_EEPROM_VERSION_4_0)\n\t\toffset += AR5K_EEPROM_TARGET_PWRSTART(ee->ee_misc1) -\n\t\t\tAR5K_EEPROM_GROUP5_OFFSET;\n\telse\n\t\toffset += AR5K_EEPROM_GROUPS_START(ee->ee_version);\n\n\trep = ee->ee_ctl_pwr;\n\tfor (i = 0; i < ee->ee_ctls; i++) {\n\t\tswitch (ee->ee_ctl[i] & AR5K_CTL_MODE_M) {\n\t\tcase AR5K_CTL_11A:\n\t\tcase AR5K_CTL_TURBO:\n\t\t\tctl_mode = AR5K_EEPROM_MODE_11A;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tctl_mode = AR5K_EEPROM_MODE_11G;\n\t\t\tbreak;\n\t\t}\n\t\tif (ee->ee_ctl[i] == 0) {\n\t\t\tif (ee->ee_version >= AR5K_EEPROM_VERSION_3_3)\n\t\t\t\toffset += 8;\n\t\t\telse\n\t\t\t\toffset += 7;\n\t\t\trep += AR5K_EEPROM_N_EDGES;\n\t\t\tcontinue;\n\t\t}\n\t\tif (ee->ee_version >= AR5K_EEPROM_VERSION_3_3) {\n\t\t\tfor (j = 0; j < AR5K_EEPROM_N_EDGES; j += 2) {\n\t\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\t\trep[j].freq = (val >> 8) & fmask;\n\t\t\t\trep[j + 1].freq = val & fmask;\n\t\t\t}\n\t\t\tfor (j = 0; j < AR5K_EEPROM_N_EDGES; j += 2) {\n\t\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\t\trep[j].edge = (val >> 8) & pmask;\n\t\t\t\trep[j].flag = (val >> 14) & 1;\n\t\t\t\trep[j + 1].edge = val & pmask;\n\t\t\t\trep[j + 1].flag = (val >> 6) & 1;\n\t\t\t}\n\t\t} else {\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\trep[0].freq = (val >> 9) & fmask;\n\t\t\trep[1].freq = (val >> 2) & fmask;\n\t\t\trep[2].freq = (val << 5) & fmask;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\trep[2].freq |= (val >> 11) & 0x1f;\n\t\t\trep[3].freq = (val >> 4) & fmask;\n\t\t\trep[4].freq = (val << 3) & fmask;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\trep[4].freq |= (val >> 13) & 0x7;\n\t\t\trep[5].freq = (val >> 6) & fmask;\n\t\t\trep[6].freq = (val << 1) & fmask;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\trep[6].freq |= (val >> 15) & 0x1;\n\t\t\trep[7].freq = (val >> 8) & fmask;\n\n\t\t\trep[0].edge = (val >> 2) & pmask;\n\t\t\trep[1].edge = (val << 4) & pmask;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\trep[1].edge |= (val >> 12) & 0xf;\n\t\t\trep[2].edge = (val >> 6) & pmask;\n\t\t\trep[3].edge = val & pmask;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\trep[4].edge = (val >> 10) & pmask;\n\t\t\trep[5].edge = (val >> 4) & pmask;\n\t\t\trep[6].edge = (val << 2) & pmask;\n\n\t\t\tAR5K_EEPROM_READ(offset++, val);\n\t\t\trep[6].edge |= (val >> 14) & 0x3;\n\t\t\trep[7].edge = (val >> 8) & pmask;\n\t\t}\n\t\tfor (j = 0; j < AR5K_EEPROM_N_EDGES; j++) {\n\t\t\trep[j].freq = ath5k_eeprom_bin2freq(ee,\n\t\t\t\trep[j].freq, ctl_mode);\n\t\t}\n\t\trep += AR5K_EEPROM_N_EDGES;\n\t}\n\n\treturn 0;\n}\n\nstatic int\nath5k_eeprom_read_spur_chans(struct ath5k_hw *ah)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu32 offset;\n\tu16 val;\n\tint  i;\n\n\toffset = AR5K_EEPROM_CTL(ee->ee_version) +\n\t\t\t\tAR5K_EEPROM_N_CTLS(ee->ee_version);\n\n\tif (ee->ee_version < AR5K_EEPROM_VERSION_5_3) {\n\t\t \n\t\tee->ee_spur_chans[0][0] = AR5K_EEPROM_NO_SPUR;\n\t\t \n\t\tee->ee_spur_chans[0][1] = AR5K_EEPROM_5413_SPUR_CHAN_1;\n\t\tee->ee_spur_chans[1][1] = AR5K_EEPROM_5413_SPUR_CHAN_2;\n\t\tee->ee_spur_chans[2][1] = AR5K_EEPROM_NO_SPUR;\n\t} else if (ee->ee_version >= AR5K_EEPROM_VERSION_5_3) {\n\t\tfor (i = 0; i < AR5K_EEPROM_N_SPUR_CHANS; i++) {\n\t\t\tAR5K_EEPROM_READ(offset, val);\n\t\t\tee->ee_spur_chans[i][0] = val;\n\t\t\tAR5K_EEPROM_READ(offset + AR5K_EEPROM_N_SPUR_CHANS,\n\t\t\t\t\t\t\t\t\tval);\n\t\t\tee->ee_spur_chans[i][1] = val;\n\t\t\toffset++;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n\n \n\n \nint\nath5k_eeprom_init(struct ath5k_hw *ah)\n{\n\tint err;\n\n\terr = ath5k_eeprom_init_header(ah);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = ath5k_eeprom_init_modes(ah);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = ath5k_eeprom_read_pcal_info(ah);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = ath5k_eeprom_read_ctl_info(ah);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = ath5k_eeprom_read_spur_chans(ah);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn 0;\n}\n\nvoid\nath5k_eeprom_detach(struct ath5k_hw *ah)\n{\n\tu8 mode;\n\n\tfor (mode = AR5K_EEPROM_MODE_11A; mode <= AR5K_EEPROM_MODE_11G; mode++)\n\t\tath5k_eeprom_free_pcal_info(ah, mode);\n}\n\nint\nath5k_eeprom_mode_from_channel(struct ath5k_hw *ah,\n\t\tstruct ieee80211_channel *channel)\n{\n\tswitch (channel->hw_value) {\n\tcase AR5K_MODE_11A:\n\t\treturn AR5K_EEPROM_MODE_11A;\n\tcase AR5K_MODE_11G:\n\t\treturn AR5K_EEPROM_MODE_11G;\n\tcase AR5K_MODE_11B:\n\t\treturn AR5K_EEPROM_MODE_11B;\n\tdefault:\n\t\tATH5K_WARN(ah, \"channel is not A/B/G!\");\n\t\treturn AR5K_EEPROM_MODE_11A;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}