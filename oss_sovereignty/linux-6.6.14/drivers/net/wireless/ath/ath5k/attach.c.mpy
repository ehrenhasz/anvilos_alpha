{
  "module_name": "attach.c",
  "hash_id": "b11594976ace4dfcefc0c4ce0cff46b11ba8e3a551c519afcb84de914e556c1f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath5k/attach.c",
  "human_readable_source": " \n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/pci.h>\n#include <linux/slab.h>\n#include \"ath5k.h\"\n#include \"reg.h\"\n#include \"debug.h\"\n\n \nstatic int ath5k_hw_post(struct ath5k_hw *ah)\n{\n\n\tstatic const u32 static_pattern[4] = {\n\t\t0x55555555,\t0xaaaaaaaa,\n\t\t0x66666666,\t0x99999999\n\t};\n\tstatic const u16 regs[2] = { AR5K_STA_ID0, AR5K_PHY(8) };\n\tint i, c;\n\tu16 cur_reg;\n\tu32 var_pattern;\n\tu32 init_val;\n\tu32 cur_val;\n\n\tfor (c = 0; c < 2; c++) {\n\n\t\tcur_reg = regs[c];\n\n\t\t \n\t\tinit_val = ath5k_hw_reg_read(ah, cur_reg);\n\n\t\tfor (i = 0; i < 256; i++) {\n\t\t\tvar_pattern = i << 16 | i;\n\t\t\tath5k_hw_reg_write(ah, var_pattern, cur_reg);\n\t\t\tcur_val = ath5k_hw_reg_read(ah, cur_reg);\n\n\t\t\tif (cur_val != var_pattern) {\n\t\t\t\tATH5K_ERR(ah, \"POST Failed !!!\\n\");\n\t\t\t\treturn -EAGAIN;\n\t\t\t}\n\n\t\t\t \n\t\t\tvar_pattern = 0x0039080f;\n\t\t\tath5k_hw_reg_write(ah, var_pattern, cur_reg);\n\t\t}\n\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\tvar_pattern = static_pattern[i];\n\t\t\tath5k_hw_reg_write(ah, var_pattern, cur_reg);\n\t\t\tcur_val = ath5k_hw_reg_read(ah, cur_reg);\n\n\t\t\tif (cur_val != var_pattern) {\n\t\t\t\tATH5K_ERR(ah, \"POST Failed !!!\\n\");\n\t\t\t\treturn -EAGAIN;\n\t\t\t}\n\n\t\t\t \n\t\t\tvar_pattern = 0x003b080f;\n\t\t\tath5k_hw_reg_write(ah, var_pattern, cur_reg);\n\t\t}\n\n\t\t \n\t\tath5k_hw_reg_write(ah, init_val, cur_reg);\n\n\t}\n\n\treturn 0;\n\n}\n\n \nint ath5k_hw_init(struct ath5k_hw *ah)\n{\n\tstatic const u8 zero_mac[ETH_ALEN] = { };\n\tstruct ath_common *common = ath5k_hw_common(ah);\n\tstruct pci_dev *pdev = ah->pdev;\n\tstruct ath5k_eeprom_info *ee;\n\tint ret;\n\tu32 srev;\n\n\t \n\tah->ah_bwmode = AR5K_BWMODE_DEFAULT;\n\tah->ah_txpower.txp_tpc = AR5K_TUNE_TPC_TXPOWER;\n\tah->ah_imr = 0;\n\tah->ah_retry_short = AR5K_INIT_RETRY_SHORT;\n\tah->ah_retry_long = AR5K_INIT_RETRY_LONG;\n\tah->ah_ant_mode = AR5K_ANTMODE_DEFAULT;\n\tah->ah_noise_floor = -95;\t \n\tah->ani_state.ani_mode = ATH5K_ANI_MODE_AUTO;\n\tah->ah_current_channel = &ah->channels[0];\n\n\t \n\tath5k_hw_read_srev(ah);\n\tsrev = ah->ah_mac_srev;\n\tif (srev < AR5K_SREV_AR5311)\n\t\tah->ah_version = AR5K_AR5210;\n\telse if (srev < AR5K_SREV_AR5212)\n\t\tah->ah_version = AR5K_AR5211;\n\telse\n\t\tah->ah_version = AR5K_AR5212;\n\n\t \n\tah->ah_mac_version = AR5K_REG_MS(srev, AR5K_SREV_VER);\n\n\t \n\tret = ath5k_hw_init_desc_functions(ah);\n\tif (ret)\n\t\tgoto err;\n\n\t \n\tret = ath5k_hw_nic_wakeup(ah, NULL);\n\tif (ret)\n\t\tgoto err;\n\n\t \n\tah->ah_phy_revision = ath5k_hw_reg_read(ah, AR5K_PHY_CHIP_ID) &\n\t\t\t0xffffffff;\n\tah->ah_radio_5ghz_revision = ath5k_hw_radio_revision(ah,\n\t\t\tNL80211_BAND_5GHZ);\n\n\t \n\tswitch (ah->ah_radio_5ghz_revision & 0xf0) {\n\tcase AR5K_SREV_RAD_5111:\n\t\tah->ah_radio = AR5K_RF5111;\n\t\tah->ah_single_chip = false;\n\t\tah->ah_radio_2ghz_revision = ath5k_hw_radio_revision(ah,\n\t\t\t\t\t\t\tNL80211_BAND_2GHZ);\n\t\tbreak;\n\tcase AR5K_SREV_RAD_5112:\n\tcase AR5K_SREV_RAD_2112:\n\t\tah->ah_radio = AR5K_RF5112;\n\t\tah->ah_single_chip = false;\n\t\tah->ah_radio_2ghz_revision = ath5k_hw_radio_revision(ah,\n\t\t\t\t\t\t\tNL80211_BAND_2GHZ);\n\t\tbreak;\n\tcase AR5K_SREV_RAD_2413:\n\t\tah->ah_radio = AR5K_RF2413;\n\t\tah->ah_single_chip = true;\n\t\tbreak;\n\tcase AR5K_SREV_RAD_5413:\n\t\tah->ah_radio = AR5K_RF5413;\n\t\tah->ah_single_chip = true;\n\t\tbreak;\n\tcase AR5K_SREV_RAD_2316:\n\t\tah->ah_radio = AR5K_RF2316;\n\t\tah->ah_single_chip = true;\n\t\tbreak;\n\tcase AR5K_SREV_RAD_2317:\n\t\tah->ah_radio = AR5K_RF2317;\n\t\tah->ah_single_chip = true;\n\t\tbreak;\n\tcase AR5K_SREV_RAD_5424:\n\t\tif (ah->ah_mac_version == AR5K_SREV_AR2425 ||\n\t\t    ah->ah_mac_version == AR5K_SREV_AR2417) {\n\t\t\tah->ah_radio = AR5K_RF2425;\n\t\t\tah->ah_single_chip = true;\n\t\t} else {\n\t\t\tah->ah_radio = AR5K_RF5413;\n\t\t\tah->ah_single_chip = true;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tif (ah->ah_version == AR5K_AR5210) {\n\t\t\tah->ah_radio = AR5K_RF5110;\n\t\t\tah->ah_single_chip = false;\n\t\t} else if (ah->ah_version == AR5K_AR5211) {\n\t\t\tah->ah_radio = AR5K_RF5111;\n\t\t\tah->ah_single_chip = false;\n\t\t\tah->ah_radio_2ghz_revision = ath5k_hw_radio_revision(ah,\n\t\t\t\t\t\t\tNL80211_BAND_2GHZ);\n\t\t} else if (ah->ah_mac_version == (AR5K_SREV_AR2425 >> 4) ||\n\t\t\t   ah->ah_mac_version == (AR5K_SREV_AR2417 >> 4) ||\n\t\t\t   ah->ah_phy_revision == AR5K_SREV_PHY_2425) {\n\t\t\tah->ah_radio = AR5K_RF2425;\n\t\t\tah->ah_single_chip = true;\n\t\t\tah->ah_radio_5ghz_revision = AR5K_SREV_RAD_2425;\n\t\t} else if (srev == AR5K_SREV_AR5213A &&\n\t\t\t   ah->ah_phy_revision == AR5K_SREV_PHY_5212B) {\n\t\t\tah->ah_radio = AR5K_RF5112;\n\t\t\tah->ah_single_chip = false;\n\t\t\tah->ah_radio_5ghz_revision = AR5K_SREV_RAD_5112B;\n\t\t} else if (ah->ah_mac_version == (AR5K_SREV_AR2415 >> 4) ||\n\t\t\t   ah->ah_mac_version == (AR5K_SREV_AR2315_R6 >> 4)) {\n\t\t\tah->ah_radio = AR5K_RF2316;\n\t\t\tah->ah_single_chip = true;\n\t\t\tah->ah_radio_5ghz_revision = AR5K_SREV_RAD_2316;\n\t\t} else if (ah->ah_mac_version == (AR5K_SREV_AR5414 >> 4) ||\n\t\t\t   ah->ah_phy_revision == AR5K_SREV_PHY_5413) {\n\t\t\tah->ah_radio = AR5K_RF5413;\n\t\t\tah->ah_single_chip = true;\n\t\t\tah->ah_radio_5ghz_revision = AR5K_SREV_RAD_5413;\n\t\t} else if (ah->ah_mac_version == (AR5K_SREV_AR2414 >> 4) ||\n\t\t\t   ah->ah_phy_revision == AR5K_SREV_PHY_2413) {\n\t\t\tah->ah_radio = AR5K_RF2413;\n\t\t\tah->ah_single_chip = true;\n\t\t\tah->ah_radio_5ghz_revision = AR5K_SREV_RAD_2413;\n\t\t} else {\n\t\t\tATH5K_ERR(ah, \"Couldn't identify radio revision.\\n\");\n\t\t\tret = -ENODEV;\n\t\t\tgoto err;\n\t\t}\n\t}\n\n\n\t \n\tif ((srev >= AR5K_SREV_AR5416) && (srev < AR5K_SREV_AR2425)) {\n\t\tATH5K_ERR(ah, \"Device not yet supported.\\n\");\n\t\tret = -ENODEV;\n\t\tgoto err;\n\t}\n\n\t \n\tret = ath5k_hw_post(ah);\n\tif (ret)\n\t\tgoto err;\n\n\t \n\tif (srev >= AR5K_SREV_AR5213A)\n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PCICFG, AR5K_PCICFG_RETRY_FIX);\n\n\t \n\tret = ath5k_eeprom_init(ah);\n\tif (ret) {\n\t\tATH5K_ERR(ah, \"unable to init EEPROM\\n\");\n\t\tgoto err;\n\t}\n\n\tee = &ah->ah_capabilities.cap_eeprom;\n\n\t \n\tif ((ah->ah_version == AR5K_AR5212) && pdev && (pci_is_pcie(pdev))) {\n\t\tath5k_hw_reg_write(ah, 0x9248fc00, AR5K_PCIE_SERDES);\n\t\tath5k_hw_reg_write(ah, 0x24924924, AR5K_PCIE_SERDES);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, 0x28000039, AR5K_PCIE_SERDES);\n\t\tath5k_hw_reg_write(ah, 0x53160824, AR5K_PCIE_SERDES);\n\n\t\t \n\t\tif (ee->ee_serdes)\n\t\t\tath5k_hw_reg_write(ah, 0xe5980579, AR5K_PCIE_SERDES);\n\t\telse\n\t\t\tath5k_hw_reg_write(ah, 0xf6800579, AR5K_PCIE_SERDES);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, 0x001defff, AR5K_PCIE_SERDES);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, 0x1aaabe40, AR5K_PCIE_SERDES);\n\t\tath5k_hw_reg_write(ah, 0xbe105554, AR5K_PCIE_SERDES);\n\t\tath5k_hw_reg_write(ah, 0x000e3007, AR5K_PCIE_SERDES);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, 0x00000000, AR5K_PCIE_SERDES_RESET);\n\t\tusleep_range(1000, 1500);\n\t}\n\n\t \n\tret = ath5k_hw_set_capabilities(ah);\n\tif (ret) {\n\t\tATH5K_ERR(ah, \"unable to get device capabilities\\n\");\n\t\tgoto err;\n\t}\n\n\t \n\tcommon->keymax = (ah->ah_version == AR5K_AR5210 ?\n\t\t\t  AR5K_KEYTABLE_SIZE_5210 : AR5K_KEYTABLE_SIZE_5211);\n\n\tif (srev >= AR5K_SREV_AR5212_V4 &&\n\t    (ee->ee_version < AR5K_EEPROM_VERSION_5_0 ||\n\t    !AR5K_EEPROM_AES_DIS(ee->ee_misc5)))\n\t\tcommon->crypt_caps |= ATH_CRYPT_CAP_CIPHER_AESCCM;\n\n\tif (srev >= AR5K_SREV_AR2414) {\n\t\tcommon->crypt_caps |= ATH_CRYPT_CAP_MIC_COMBINED;\n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_MISC_MODE,\n\t\t\tAR5K_MISC_MODE_COMBINED_MIC);\n\t}\n\n\t \n\tath5k_hw_set_lladdr(ah, zero_mac);\n\n\t \n\teth_broadcast_addr(common->curbssid);\n\tath5k_hw_set_bssid(ah);\n\tath5k_hw_set_opmode(ah, ah->opmode);\n\n\tath5k_hw_rfgain_opt_init(ah);\n\n\tath5k_hw_init_nfcal_hist(ah);\n\n\t \n\tath5k_hw_set_ledstate(ah, AR5K_LED_INIT);\n\n\treturn 0;\nerr:\n\treturn ret;\n}\n\n \nvoid ath5k_hw_deinit(struct ath5k_hw *ah)\n{\n\t__set_bit(ATH_STAT_INVALID, ah->status);\n\n\tkfree(ah->ah_rf_banks);\n\n\tath5k_eeprom_detach(ah);\n\n\t \n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}