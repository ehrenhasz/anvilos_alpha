{
  "module_name": "phy.c",
  "hash_id": "d980f8a2de1fa617dc7459ac7a6099b366573c56f8f5ea14f0c15166848ba460",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath5k/phy.c",
  "human_readable_source": " \n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <linux/sort.h>\n#include <asm/unaligned.h>\n\n#include \"ath5k.h\"\n#include \"reg.h\"\n#include \"rfbuffer.h\"\n#include \"rfgain.h\"\n#include \"../regd.h\"\n\n\n \n\n\n \n\n \nu16\nath5k_hw_radio_revision(struct ath5k_hw *ah, enum nl80211_band band)\n{\n\tunsigned int i;\n\tu32 srev;\n\tu16 ret;\n\n\t \n\tswitch (band) {\n\tcase NL80211_BAND_2GHZ:\n\t\tath5k_hw_reg_write(ah, AR5K_PHY_SHIFT_2GHZ, AR5K_PHY(0));\n\t\tbreak;\n\tcase NL80211_BAND_5GHZ:\n\t\tath5k_hw_reg_write(ah, AR5K_PHY_SHIFT_5GHZ, AR5K_PHY(0));\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tusleep_range(2000, 2500);\n\n\t \n\tath5k_hw_reg_write(ah, 0x00001c16, AR5K_PHY(0x34));\n\n\tfor (i = 0; i < 8; i++)\n\t\tath5k_hw_reg_write(ah, 0x00010000, AR5K_PHY(0x20));\n\n\tif (ah->ah_version == AR5K_AR5210) {\n\t\tsrev = (ath5k_hw_reg_read(ah, AR5K_PHY(256)) >> 28) & 0xf;\n\t\tret = (u16)ath5k_hw_bitswap(srev, 4) + 1;\n\t} else {\n\t\tsrev = (ath5k_hw_reg_read(ah, AR5K_PHY(0x100)) >> 24) & 0xff;\n\t\tret = (u16)ath5k_hw_bitswap(((srev & 0xf0) >> 4) |\n\t\t\t\t((srev & 0x0f) << 4), 8);\n\t}\n\n\t \n\tath5k_hw_reg_write(ah, AR5K_PHY_SHIFT_5GHZ, AR5K_PHY(0));\n\n\treturn ret;\n}\n\n \nbool\nath5k_channel_ok(struct ath5k_hw *ah, struct ieee80211_channel *channel)\n{\n\tu16 freq = channel->center_freq;\n\n\t \n\tif (channel->band == NL80211_BAND_2GHZ) {\n\t\tif ((freq >= ah->ah_capabilities.cap_range.range_2ghz_min) &&\n\t\t    (freq <= ah->ah_capabilities.cap_range.range_2ghz_max))\n\t\t\treturn true;\n\t} else if (channel->band == NL80211_BAND_5GHZ)\n\t\tif ((freq >= ah->ah_capabilities.cap_range.range_5ghz_min) &&\n\t\t    (freq <= ah->ah_capabilities.cap_range.range_5ghz_max))\n\t\t\treturn true;\n\n\treturn false;\n}\n\n \nbool\nath5k_hw_chan_has_spur_noise(struct ath5k_hw *ah,\n\t\t\t\tstruct ieee80211_channel *channel)\n{\n\tu8 refclk_freq;\n\n\tif ((ah->ah_radio == AR5K_RF5112) ||\n\t(ah->ah_radio == AR5K_RF5413) ||\n\t(ah->ah_radio == AR5K_RF2413) ||\n\t(ah->ah_mac_version == (AR5K_SREV_AR2417 >> 4)))\n\t\trefclk_freq = 40;\n\telse\n\t\trefclk_freq = 32;\n\n\tif ((channel->center_freq % refclk_freq != 0) &&\n\t((channel->center_freq % refclk_freq < 10) ||\n\t(channel->center_freq % refclk_freq > 22)))\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\n \nstatic unsigned int\nath5k_hw_rfb_op(struct ath5k_hw *ah, const struct ath5k_rf_reg *rf_regs,\n\t\t\t\t\tu32 val, u8 reg_id, bool set)\n{\n\tconst struct ath5k_rf_reg *rfreg = NULL;\n\tu8 offset, bank, num_bits, col, position;\n\tu16 entry;\n\tu32 mask, data, last_bit, bits_shifted, first_bit;\n\tu32 *rfb;\n\ts32 bits_left;\n\tint i;\n\n\tdata = 0;\n\trfb = ah->ah_rf_banks;\n\n\tfor (i = 0; i < ah->ah_rf_regs_count; i++) {\n\t\tif (rf_regs[i].index == reg_id) {\n\t\t\trfreg = &rf_regs[i];\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (rfb == NULL || rfreg == NULL) {\n\t\tATH5K_PRINTF(\"Rf register not found!\\n\");\n\t\t \n\t\treturn 0;\n\t}\n\n\tbank = rfreg->bank;\n\tnum_bits = rfreg->field.len;\n\tfirst_bit = rfreg->field.pos;\n\tcol = rfreg->field.col;\n\n\t \n\toffset = ah->ah_offset[bank];\n\n\t \n\tif (!(col <= 3 && num_bits <= 32 && first_bit + num_bits <= 319)) {\n\t\tATH5K_PRINTF(\"invalid values at offset %u\\n\", offset);\n\t\treturn 0;\n\t}\n\n\tentry = ((first_bit - 1) / 8) + offset;\n\tposition = (first_bit - 1) % 8;\n\n\tif (set)\n\t\tdata = ath5k_hw_bitswap(val, num_bits);\n\n\tfor (bits_shifted = 0, bits_left = num_bits; bits_left > 0;\n\t     position = 0, entry++) {\n\n\t\tlast_bit = (position + bits_left > 8) ? 8 :\n\t\t\t\t\tposition + bits_left;\n\n\t\tmask = (((1 << last_bit) - 1) ^ ((1 << position) - 1)) <<\n\t\t\t\t\t\t\t\t(col * 8);\n\n\t\tif (set) {\n\t\t\trfb[entry] &= ~mask;\n\t\t\trfb[entry] |= ((data << position) << (col * 8)) & mask;\n\t\t\tdata >>= (8 - position);\n\t\t} else {\n\t\t\tdata |= (((rfb[entry] & mask) >> (col * 8)) >> position)\n\t\t\t\t<< bits_shifted;\n\t\t\tbits_shifted += last_bit - position;\n\t\t}\n\n\t\tbits_left -= 8 - position;\n\t}\n\n\tdata = set ? 1 : ath5k_hw_bitswap(data, num_bits);\n\n\treturn data;\n}\n\n \nstatic inline int\nath5k_hw_write_ofdm_timings(struct ath5k_hw *ah,\n\t\t\t\tstruct ieee80211_channel *channel)\n{\n\t \n\tu32 coef_scaled, coef_exp, coef_man,\n\t\tds_coef_exp, ds_coef_man, clock;\n\n\tBUG_ON(!(ah->ah_version == AR5K_AR5212) ||\n\t\t(channel->hw_value == AR5K_MODE_11B));\n\n\t \n\tswitch (ah->ah_bwmode) {\n\tcase AR5K_BWMODE_40MHZ:\n\t\tclock = 40 * 2;\n\t\tbreak;\n\tcase AR5K_BWMODE_10MHZ:\n\t\tclock = 40 / 2;\n\t\tbreak;\n\tcase AR5K_BWMODE_5MHZ:\n\t\tclock = 40 / 4;\n\t\tbreak;\n\tdefault:\n\t\tclock = 40;\n\t\tbreak;\n\t}\n\tcoef_scaled = ((5 * (clock << 24)) / 2) / channel->center_freq;\n\n\t \n\tcoef_exp = ilog2(coef_scaled);\n\n\t \n\tif (!coef_scaled || !coef_exp)\n\t\treturn -EINVAL;\n\n\t \n\tcoef_exp = 14 - (coef_exp - 24);\n\n\n\t \n\tcoef_man = coef_scaled +\n\t\t(1 << (24 - coef_exp - 1));\n\n\t \n\tds_coef_man = coef_man >> (24 - coef_exp);\n\tds_coef_exp = coef_exp - 16;\n\n\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_TIMING_3,\n\t\tAR5K_PHY_TIMING_3_DSC_MAN, ds_coef_man);\n\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_TIMING_3,\n\t\tAR5K_PHY_TIMING_3_DSC_EXP, ds_coef_exp);\n\n\treturn 0;\n}\n\n \nint ath5k_hw_phy_disable(struct ath5k_hw *ah)\n{\n\t \n\tath5k_hw_reg_write(ah, AR5K_PHY_ACT_DISABLE, AR5K_PHY_ACT);\n\n\treturn 0;\n}\n\n \nstatic void\nath5k_hw_wait_for_synth(struct ath5k_hw *ah,\n\t\t\tstruct ieee80211_channel *channel)\n{\n\t \n\tif (ah->ah_version != AR5K_AR5210) {\n\t\tu32 delay;\n\t\tdelay = ath5k_hw_reg_read(ah, AR5K_PHY_RX_DELAY) &\n\t\t\tAR5K_PHY_RX_DELAY_M;\n\t\tdelay = (channel->hw_value == AR5K_MODE_11B) ?\n\t\t\t((delay << 2) / 22) : (delay / 10);\n\t\tif (ah->ah_bwmode == AR5K_BWMODE_10MHZ)\n\t\t\tdelay = delay << 1;\n\t\tif (ah->ah_bwmode == AR5K_BWMODE_5MHZ)\n\t\t\tdelay = delay << 2;\n\t\t \n\t\tusleep_range(100 + delay, 100 + (2 * delay));\n\t} else {\n\t\tusleep_range(1000, 1500);\n\t}\n}\n\n\n \n\n \n\n \nint ath5k_hw_rfgain_opt_init(struct ath5k_hw *ah)\n{\n\t \n\tswitch (ah->ah_radio) {\n\tcase AR5K_RF5111:\n\t\tah->ah_gain.g_step_idx = rfgain_opt_5111.go_default;\n\t\tah->ah_gain.g_low = 20;\n\t\tah->ah_gain.g_high = 35;\n\t\tah->ah_gain.g_state = AR5K_RFGAIN_ACTIVE;\n\t\tbreak;\n\tcase AR5K_RF5112:\n\t\tah->ah_gain.g_step_idx = rfgain_opt_5112.go_default;\n\t\tah->ah_gain.g_low = 20;\n\t\tah->ah_gain.g_high = 85;\n\t\tah->ah_gain.g_state = AR5K_RFGAIN_ACTIVE;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\n \nstatic void\nath5k_hw_request_rfgain_probe(struct ath5k_hw *ah)\n{\n\n\t \n\tif (ah->ah_gain.g_state != AR5K_RFGAIN_ACTIVE)\n\t\treturn;\n\n\t \n\tath5k_hw_reg_write(ah, AR5K_REG_SM(ah->ah_txpower.txp_ofdm - 4,\n\t\t\tAR5K_PHY_PAPD_PROBE_TXPOWER) |\n\t\t\tAR5K_PHY_PAPD_PROBE_TX_NEXT, AR5K_PHY_PAPD_PROBE);\n\n\tah->ah_gain.g_state = AR5K_RFGAIN_READ_REQUESTED;\n\n}\n\n \nstatic u32\nath5k_hw_rf_gainf_corr(struct ath5k_hw *ah)\n{\n\tu32 mix, step;\n\tconst struct ath5k_gain_opt *go;\n\tconst struct ath5k_gain_opt_step *g_step;\n\tconst struct ath5k_rf_reg *rf_regs;\n\n\t \n\tif ((ah->ah_radio != AR5K_RF5112) ||\n\t(ah->ah_radio_5ghz_revision <= AR5K_SREV_RAD_5112A))\n\t\treturn 0;\n\n\tgo = &rfgain_opt_5112;\n\trf_regs = rf_regs_5112a;\n\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_5112a);\n\n\tg_step = &go->go_step[ah->ah_gain.g_step_idx];\n\n\tif (ah->ah_rf_banks == NULL)\n\t\treturn 0;\n\n\tah->ah_gain.g_f_corr = 0;\n\n\t \n\tif (ath5k_hw_rfb_op(ah, rf_regs, 0, AR5K_RF_MIXVGA_OVR, false) != 1)\n\t\treturn 0;\n\n\t \n\tstep = ath5k_hw_rfb_op(ah, rf_regs, 0, AR5K_RF_MIXGAIN_STEP, false);\n\n\t \n\tmix = g_step->gos_param[0];\n\n\tswitch (mix) {\n\tcase 3:\n\t\tah->ah_gain.g_f_corr = step * 2;\n\t\tbreak;\n\tcase 2:\n\t\tah->ah_gain.g_f_corr = (step - 5) * 2;\n\t\tbreak;\n\tcase 1:\n\t\tah->ah_gain.g_f_corr = step;\n\t\tbreak;\n\tdefault:\n\t\tah->ah_gain.g_f_corr = 0;\n\t\tbreak;\n\t}\n\n\treturn ah->ah_gain.g_f_corr;\n}\n\n \nstatic bool\nath5k_hw_rf_check_gainf_readback(struct ath5k_hw *ah)\n{\n\tconst struct ath5k_rf_reg *rf_regs;\n\tu32 step, mix_ovr, level[4];\n\n\tif (ah->ah_rf_banks == NULL)\n\t\treturn false;\n\n\tif (ah->ah_radio == AR5K_RF5111) {\n\n\t\trf_regs = rf_regs_5111;\n\t\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_5111);\n\n\t\tstep = ath5k_hw_rfb_op(ah, rf_regs, 0, AR5K_RF_RFGAIN_STEP,\n\t\t\tfalse);\n\n\t\tlevel[0] = 0;\n\t\tlevel[1] = (step == 63) ? 50 : step + 4;\n\t\tlevel[2] = (step != 63) ? 64 : level[0];\n\t\tlevel[3] = level[2] + 50;\n\n\t\tah->ah_gain.g_high = level[3] -\n\t\t\t(step == 63 ? AR5K_GAIN_DYN_ADJUST_HI_MARGIN : -5);\n\t\tah->ah_gain.g_low = level[0] +\n\t\t\t(step == 63 ? AR5K_GAIN_DYN_ADJUST_LO_MARGIN : 0);\n\t} else {\n\n\t\trf_regs = rf_regs_5112;\n\t\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_5112);\n\n\t\tmix_ovr = ath5k_hw_rfb_op(ah, rf_regs, 0, AR5K_RF_MIXVGA_OVR,\n\t\t\tfalse);\n\n\t\tlevel[0] = level[2] = 0;\n\n\t\tif (mix_ovr == 1) {\n\t\t\tlevel[1] = level[3] = 83;\n\t\t} else {\n\t\t\tlevel[1] = level[3] = 107;\n\t\t\tah->ah_gain.g_high = 55;\n\t\t}\n\t}\n\n\treturn (ah->ah_gain.g_current >= level[0] &&\n\t\t\tah->ah_gain.g_current <= level[1]) ||\n\t\t(ah->ah_gain.g_current >= level[2] &&\n\t\t\tah->ah_gain.g_current <= level[3]);\n}\n\n \nstatic s8\nath5k_hw_rf_gainf_adjust(struct ath5k_hw *ah)\n{\n\tconst struct ath5k_gain_opt *go;\n\tconst struct ath5k_gain_opt_step *g_step;\n\tint ret = 0;\n\n\tswitch (ah->ah_radio) {\n\tcase AR5K_RF5111:\n\t\tgo = &rfgain_opt_5111;\n\t\tbreak;\n\tcase AR5K_RF5112:\n\t\tgo = &rfgain_opt_5112;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tg_step = &go->go_step[ah->ah_gain.g_step_idx];\n\n\tif (ah->ah_gain.g_current >= ah->ah_gain.g_high) {\n\n\t\t \n\t\tif (ah->ah_gain.g_step_idx == 0)\n\t\t\treturn -1;\n\n\t\tfor (ah->ah_gain.g_target = ah->ah_gain.g_current;\n\t\t\t\tah->ah_gain.g_target >=  ah->ah_gain.g_high &&\n\t\t\t\tah->ah_gain.g_step_idx > 0;\n\t\t\t\tg_step = &go->go_step[ah->ah_gain.g_step_idx])\n\t\t\tah->ah_gain.g_target -= 2 *\n\t\t\t    (go->go_step[--(ah->ah_gain.g_step_idx)].gos_gain -\n\t\t\t    g_step->gos_gain);\n\n\t\tret = 1;\n\t\tgoto done;\n\t}\n\n\tif (ah->ah_gain.g_current <= ah->ah_gain.g_low) {\n\n\t\t \n\t\tif (ah->ah_gain.g_step_idx == (go->go_steps_count - 1))\n\t\t\treturn -2;\n\n\t\tfor (ah->ah_gain.g_target = ah->ah_gain.g_current;\n\t\t\t\tah->ah_gain.g_target <= ah->ah_gain.g_low &&\n\t\t\t\tah->ah_gain.g_step_idx < go->go_steps_count - 1;\n\t\t\t\tg_step = &go->go_step[ah->ah_gain.g_step_idx])\n\t\t\tah->ah_gain.g_target -= 2 *\n\t\t\t    (go->go_step[++ah->ah_gain.g_step_idx].gos_gain -\n\t\t\t    g_step->gos_gain);\n\n\t\tret = 2;\n\t\tgoto done;\n\t}\n\ndone:\n\tATH5K_DBG(ah, ATH5K_DEBUG_CALIBRATE,\n\t\t\"ret %d, gain step %u, current gain %u, target gain %u\\n\",\n\t\tret, ah->ah_gain.g_step_idx, ah->ah_gain.g_current,\n\t\tah->ah_gain.g_target);\n\n\treturn ret;\n}\n\n \nenum ath5k_rfgain\nath5k_hw_gainf_calibrate(struct ath5k_hw *ah)\n{\n\tu32 data, type;\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\n\tif (ah->ah_rf_banks == NULL ||\n\tah->ah_gain.g_state == AR5K_RFGAIN_INACTIVE)\n\t\treturn AR5K_RFGAIN_INACTIVE;\n\n\t \n\tif (ah->ah_gain.g_state != AR5K_RFGAIN_READ_REQUESTED)\n\t\tgoto done;\n\n\t \n\tdata = ath5k_hw_reg_read(ah, AR5K_PHY_PAPD_PROBE);\n\n\t \n\tif (!(data & AR5K_PHY_PAPD_PROBE_TX_NEXT)) {\n\t\tah->ah_gain.g_current = data >> AR5K_PHY_PAPD_PROBE_GAINF_S;\n\t\ttype = AR5K_REG_MS(data, AR5K_PHY_PAPD_PROBE_TYPE);\n\n\t\t \n\t\tif (type == AR5K_PHY_PAPD_PROBE_TYPE_CCK) {\n\t\t\tif (ah->ah_radio_5ghz_revision >= AR5K_SREV_RAD_5112A)\n\t\t\t\tah->ah_gain.g_current +=\n\t\t\t\t\tee->ee_cck_ofdm_gain_delta;\n\t\t\telse\n\t\t\t\tah->ah_gain.g_current +=\n\t\t\t\t\tAR5K_GAIN_CCK_PROBE_CORR;\n\t\t}\n\n\t\t \n\t\tif (ah->ah_radio_5ghz_revision >= AR5K_SREV_RAD_5112A) {\n\t\t\tath5k_hw_rf_gainf_corr(ah);\n\t\t\tah->ah_gain.g_current =\n\t\t\t\tah->ah_gain.g_current >= ah->ah_gain.g_f_corr ?\n\t\t\t\t(ah->ah_gain.g_current - ah->ah_gain.g_f_corr) :\n\t\t\t\t0;\n\t\t}\n\n\t\t \n\t\tif (ath5k_hw_rf_check_gainf_readback(ah) &&\n\t\tAR5K_GAIN_CHECK_ADJUST(&ah->ah_gain) &&\n\t\tath5k_hw_rf_gainf_adjust(ah)) {\n\t\t\tah->ah_gain.g_state = AR5K_RFGAIN_NEED_CHANGE;\n\t\t} else {\n\t\t\tah->ah_gain.g_state = AR5K_RFGAIN_ACTIVE;\n\t\t}\n\t}\n\ndone:\n\treturn ah->ah_gain.g_state;\n}\n\n \nstatic int\nath5k_hw_rfgain_init(struct ath5k_hw *ah, enum nl80211_band band)\n{\n\tconst struct ath5k_ini_rfgain *ath5k_rfg;\n\tunsigned int i, size, index;\n\n\tswitch (ah->ah_radio) {\n\tcase AR5K_RF5111:\n\t\tath5k_rfg = rfgain_5111;\n\t\tsize = ARRAY_SIZE(rfgain_5111);\n\t\tbreak;\n\tcase AR5K_RF5112:\n\t\tath5k_rfg = rfgain_5112;\n\t\tsize = ARRAY_SIZE(rfgain_5112);\n\t\tbreak;\n\tcase AR5K_RF2413:\n\t\tath5k_rfg = rfgain_2413;\n\t\tsize = ARRAY_SIZE(rfgain_2413);\n\t\tbreak;\n\tcase AR5K_RF2316:\n\t\tath5k_rfg = rfgain_2316;\n\t\tsize = ARRAY_SIZE(rfgain_2316);\n\t\tbreak;\n\tcase AR5K_RF5413:\n\t\tath5k_rfg = rfgain_5413;\n\t\tsize = ARRAY_SIZE(rfgain_5413);\n\t\tbreak;\n\tcase AR5K_RF2317:\n\tcase AR5K_RF2425:\n\t\tath5k_rfg = rfgain_2425;\n\t\tsize = ARRAY_SIZE(rfgain_2425);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tindex = (band == NL80211_BAND_2GHZ) ? 1 : 0;\n\n\tfor (i = 0; i < size; i++) {\n\t\tAR5K_REG_WAIT(i);\n\t\tath5k_hw_reg_write(ah, ath5k_rfg[i].rfg_value[index],\n\t\t\t(u32)ath5k_rfg[i].rfg_register);\n\t}\n\n\treturn 0;\n}\n\n\n \n\n \nstatic int\nath5k_hw_rfregs_init(struct ath5k_hw *ah,\n\t\t\tstruct ieee80211_channel *channel,\n\t\t\tunsigned int mode)\n{\n\tconst struct ath5k_rf_reg *rf_regs;\n\tconst struct ath5k_ini_rfbuffer *ini_rfb;\n\tconst struct ath5k_gain_opt *go = NULL;\n\tconst struct ath5k_gain_opt_step *g_step;\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu8 ee_mode = 0;\n\tu32 *rfb;\n\tint i, obdb = -1, bank = -1;\n\n\tswitch (ah->ah_radio) {\n\tcase AR5K_RF5111:\n\t\trf_regs = rf_regs_5111;\n\t\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_5111);\n\t\tini_rfb = rfb_5111;\n\t\tah->ah_rf_banks_size = ARRAY_SIZE(rfb_5111);\n\t\tgo = &rfgain_opt_5111;\n\t\tbreak;\n\tcase AR5K_RF5112:\n\t\tif (ah->ah_radio_5ghz_revision >= AR5K_SREV_RAD_5112A) {\n\t\t\trf_regs = rf_regs_5112a;\n\t\t\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_5112a);\n\t\t\tini_rfb = rfb_5112a;\n\t\t\tah->ah_rf_banks_size = ARRAY_SIZE(rfb_5112a);\n\t\t} else {\n\t\t\trf_regs = rf_regs_5112;\n\t\t\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_5112);\n\t\t\tini_rfb = rfb_5112;\n\t\t\tah->ah_rf_banks_size = ARRAY_SIZE(rfb_5112);\n\t\t}\n\t\tgo = &rfgain_opt_5112;\n\t\tbreak;\n\tcase AR5K_RF2413:\n\t\trf_regs = rf_regs_2413;\n\t\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_2413);\n\t\tini_rfb = rfb_2413;\n\t\tah->ah_rf_banks_size = ARRAY_SIZE(rfb_2413);\n\t\tbreak;\n\tcase AR5K_RF2316:\n\t\trf_regs = rf_regs_2316;\n\t\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_2316);\n\t\tini_rfb = rfb_2316;\n\t\tah->ah_rf_banks_size = ARRAY_SIZE(rfb_2316);\n\t\tbreak;\n\tcase AR5K_RF5413:\n\t\trf_regs = rf_regs_5413;\n\t\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_5413);\n\t\tini_rfb = rfb_5413;\n\t\tah->ah_rf_banks_size = ARRAY_SIZE(rfb_5413);\n\t\tbreak;\n\tcase AR5K_RF2317:\n\t\trf_regs = rf_regs_2425;\n\t\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_2425);\n\t\tini_rfb = rfb_2317;\n\t\tah->ah_rf_banks_size = ARRAY_SIZE(rfb_2317);\n\t\tbreak;\n\tcase AR5K_RF2425:\n\t\trf_regs = rf_regs_2425;\n\t\tah->ah_rf_regs_count = ARRAY_SIZE(rf_regs_2425);\n\t\tif (ah->ah_mac_srev < AR5K_SREV_AR2417) {\n\t\t\tini_rfb = rfb_2425;\n\t\t\tah->ah_rf_banks_size = ARRAY_SIZE(rfb_2425);\n\t\t} else {\n\t\t\tini_rfb = rfb_2417;\n\t\t\tah->ah_rf_banks_size = ARRAY_SIZE(rfb_2417);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (ah->ah_rf_banks == NULL) {\n\t\tah->ah_rf_banks = kmalloc_array(ah->ah_rf_banks_size,\n\t\t\t\t\t\t\t\tsizeof(u32),\n\t\t\t\t\t\t\t\tGFP_KERNEL);\n\t\tif (ah->ah_rf_banks == NULL) {\n\t\t\tATH5K_ERR(ah, \"out of memory\\n\");\n\t\t\treturn -ENOMEM;\n\t\t}\n\t}\n\n\t \n\trfb = ah->ah_rf_banks;\n\n\tfor (i = 0; i < ah->ah_rf_banks_size; i++) {\n\t\tif (ini_rfb[i].rfb_bank >= AR5K_MAX_RF_BANKS) {\n\t\t\tATH5K_ERR(ah, \"invalid bank\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tif (bank != ini_rfb[i].rfb_bank) {\n\t\t\tbank = ini_rfb[i].rfb_bank;\n\t\t\tah->ah_offset[bank] = i;\n\t\t}\n\n\t\trfb[i] = ini_rfb[i].rfb_mode_data[mode];\n\t}\n\n\t \n\tif (channel->band == NL80211_BAND_2GHZ) {\n\n\t\tif (channel->hw_value == AR5K_MODE_11B)\n\t\t\tee_mode = AR5K_EEPROM_MODE_11B;\n\t\telse\n\t\t\tee_mode = AR5K_EEPROM_MODE_11G;\n\n\t\t \n\t\tif ((ah->ah_radio == AR5K_RF5111) ||\n\t\t(ah->ah_radio == AR5K_RF5112))\n\t\t\tobdb = 0;\n\t\telse\n\t\t\tobdb = 1;\n\n\t\tath5k_hw_rfb_op(ah, rf_regs, ee->ee_ob[ee_mode][obdb],\n\t\t\t\t\t\tAR5K_RF_OB_2GHZ, true);\n\n\t\tath5k_hw_rfb_op(ah, rf_regs, ee->ee_db[ee_mode][obdb],\n\t\t\t\t\t\tAR5K_RF_DB_2GHZ, true);\n\n\t \n\t} else if ((channel->band == NL80211_BAND_5GHZ) ||\n\t\t\t(ah->ah_radio == AR5K_RF5111)) {\n\n\t\t \n\t\tee_mode = AR5K_EEPROM_MODE_11A;\n\t\tobdb =\t channel->center_freq >= 5725 ? 3 :\n\t\t\t(channel->center_freq >= 5500 ? 2 :\n\t\t\t(channel->center_freq >= 5260 ? 1 :\n\t\t\t (channel->center_freq > 4000 ? 0 : -1)));\n\n\t\tif (obdb < 0)\n\t\t\treturn -EINVAL;\n\n\t\tath5k_hw_rfb_op(ah, rf_regs, ee->ee_ob[ee_mode][obdb],\n\t\t\t\t\t\tAR5K_RF_OB_5GHZ, true);\n\n\t\tath5k_hw_rfb_op(ah, rf_regs, ee->ee_db[ee_mode][obdb],\n\t\t\t\t\t\tAR5K_RF_DB_5GHZ, true);\n\t}\n\n\tg_step = &go->go_step[ah->ah_gain.g_step_idx];\n\n\t \n\tif ((ah->ah_bwmode == AR5K_BWMODE_40MHZ) &&\n\t(ah->ah_radio != AR5K_RF5413))\n\t\tath5k_hw_rfb_op(ah, rf_regs, 1, AR5K_RF_TURBO, false);\n\n\t \n\tif (ah->ah_radio == AR5K_RF5111) {\n\n\t\t \n\t\tif (channel->hw_value != AR5K_MODE_11B) {\n\n\t\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_FRAME_CTL,\n\t\t\t\t\tAR5K_PHY_FRAME_CTL_TX_CLIP,\n\t\t\t\t\tg_step->gos_param[0]);\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, g_step->gos_param[1],\n\t\t\t\t\t\t\tAR5K_RF_PWD_90, true);\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, g_step->gos_param[2],\n\t\t\t\t\t\t\tAR5K_RF_PWD_84, true);\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, g_step->gos_param[3],\n\t\t\t\t\t\tAR5K_RF_RFGAIN_SEL, true);\n\n\t\t\t \n\t\t\tah->ah_gain.g_state = AR5K_RFGAIN_ACTIVE;\n\n\t\t}\n\n\t\t \n\n\t\tath5k_hw_rfb_op(ah, rf_regs, !ee->ee_xpd[ee_mode],\n\t\t\t\t\t\tAR5K_RF_PWD_XPD, true);\n\n\t\tath5k_hw_rfb_op(ah, rf_regs, ee->ee_x_gain[ee_mode],\n\t\t\t\t\t\tAR5K_RF_XPD_GAIN, true);\n\n\t\tath5k_hw_rfb_op(ah, rf_regs, ee->ee_i_gain[ee_mode],\n\t\t\t\t\t\tAR5K_RF_GAIN_I, true);\n\n\t\tath5k_hw_rfb_op(ah, rf_regs, ee->ee_xpd[ee_mode],\n\t\t\t\t\t\tAR5K_RF_PLO_SEL, true);\n\n\t\t \n\t\tif (ah->ah_bwmode == AR5K_BWMODE_5MHZ ||\n\t\tah->ah_bwmode == AR5K_BWMODE_10MHZ) {\n\t\t\tu8 wait_i;\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, 0x1f,\n\t\t\t\t\t\tAR5K_RF_WAIT_S, true);\n\n\t\t\twait_i = (ah->ah_bwmode == AR5K_BWMODE_5MHZ) ?\n\t\t\t\t\t\t\t0x1f : 0x10;\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, wait_i,\n\t\t\t\t\t\tAR5K_RF_WAIT_I, true);\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, 3,\n\t\t\t\t\t\tAR5K_RF_MAX_TIME, true);\n\n\t\t}\n\t}\n\n\tif (ah->ah_radio == AR5K_RF5112) {\n\n\t\t \n\t\tif (channel->hw_value != AR5K_MODE_11B) {\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, g_step->gos_param[0],\n\t\t\t\t\t\tAR5K_RF_MIXGAIN_OVR, true);\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, g_step->gos_param[1],\n\t\t\t\t\t\tAR5K_RF_PWD_138, true);\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, g_step->gos_param[2],\n\t\t\t\t\t\tAR5K_RF_PWD_137, true);\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, g_step->gos_param[3],\n\t\t\t\t\t\tAR5K_RF_PWD_136, true);\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, g_step->gos_param[4],\n\t\t\t\t\t\tAR5K_RF_PWD_132, true);\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, g_step->gos_param[5],\n\t\t\t\t\t\tAR5K_RF_PWD_131, true);\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, g_step->gos_param[6],\n\t\t\t\t\t\tAR5K_RF_PWD_130, true);\n\n\t\t\t \n\t\t\tah->ah_gain.g_state = AR5K_RFGAIN_ACTIVE;\n\t\t}\n\n\t\t \n\n\t\tath5k_hw_rfb_op(ah, rf_regs, ee->ee_xpd[ee_mode],\n\t\t\t\t\t\tAR5K_RF_XPD_SEL, true);\n\n\t\tif (ah->ah_radio_5ghz_revision < AR5K_SREV_RAD_5112A) {\n\t\t\t \n\t\t\tath5k_hw_rfb_op(ah, rf_regs,\n\t\t\t\t\t\tee->ee_x_gain[ee_mode],\n\t\t\t\t\t\tAR5K_RF_XPD_GAIN, true);\n\n\t\t} else {\n\t\t\tu8 *pdg_curve_to_idx = ee->ee_pdc_to_idx[ee_mode];\n\t\t\tif (ee->ee_pd_gains[ee_mode] > 1) {\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs,\n\t\t\t\t\t\tpdg_curve_to_idx[0],\n\t\t\t\t\t\tAR5K_RF_PD_GAIN_LO, true);\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs,\n\t\t\t\t\t\tpdg_curve_to_idx[1],\n\t\t\t\t\t\tAR5K_RF_PD_GAIN_HI, true);\n\t\t\t} else {\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs,\n\t\t\t\t\t\tpdg_curve_to_idx[0],\n\t\t\t\t\t\tAR5K_RF_PD_GAIN_LO, true);\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs,\n\t\t\t\t\t\tpdg_curve_to_idx[0],\n\t\t\t\t\t\tAR5K_RF_PD_GAIN_HI, true);\n\t\t\t}\n\n\t\t\t \n\t\t\tif (ah->ah_radio == AR5K_RF5112 &&\n\t\t\t    (ah->ah_radio_5ghz_revision & AR5K_SREV_REV) > 0) {\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs, 2,\n\t\t\t\t\t\tAR5K_RF_HIGH_VC_CP, true);\n\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs, 2,\n\t\t\t\t\t\tAR5K_RF_MID_VC_CP, true);\n\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs, 2,\n\t\t\t\t\t\tAR5K_RF_LOW_VC_CP, true);\n\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs, 2,\n\t\t\t\t\t\tAR5K_RF_PUSH_UP, true);\n\t\t\t}\n\n\t\t\t \n\t\t\tif (ah->ah_phy_revision >= AR5K_SREV_PHY_5212A) {\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs, 1,\n\t\t\t\t\t\tAR5K_RF_PAD2GND, true);\n\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs, 1,\n\t\t\t\t\t\tAR5K_RF_XB2_LVL, true);\n\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs, 1,\n\t\t\t\t\t\tAR5K_RF_XB5_LVL, true);\n\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs, 1,\n\t\t\t\t\t\tAR5K_RF_PWD_167, true);\n\n\t\t\t\tath5k_hw_rfb_op(ah, rf_regs, 1,\n\t\t\t\t\t\tAR5K_RF_PWD_166, true);\n\t\t\t}\n\t\t}\n\n\t\tath5k_hw_rfb_op(ah, rf_regs, ee->ee_i_gain[ee_mode],\n\t\t\t\t\t\tAR5K_RF_GAIN_I, true);\n\n\t\t \n\t\tif (ah->ah_bwmode == AR5K_BWMODE_5MHZ ||\n\t\tah->ah_bwmode == AR5K_BWMODE_10MHZ) {\n\t\t\tu8 pd_delay;\n\n\t\t\tpd_delay = (ah->ah_bwmode == AR5K_BWMODE_5MHZ) ?\n\t\t\t\t\t\t\t0xf : 0x8;\n\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, pd_delay,\n\t\t\t\t\t\tAR5K_RF_PD_PERIOD_A, true);\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, 0xf,\n\t\t\t\t\t\tAR5K_RF_PD_DELAY_A, true);\n\n\t\t}\n\t}\n\n\tif (ah->ah_radio == AR5K_RF5413 &&\n\tchannel->band == NL80211_BAND_2GHZ) {\n\n\t\tath5k_hw_rfb_op(ah, rf_regs, 1, AR5K_RF_DERBY_CHAN_SEL_MODE,\n\t\t\t\t\t\t\t\t\ttrue);\n\n\t\t \n\t\tif (ah->ah_mac_srev >= AR5K_SREV_AR5424 &&\n\t\tah->ah_mac_srev < AR5K_SREV_AR5413)\n\t\t\tath5k_hw_rfb_op(ah, rf_regs, ath5k_hw_bitswap(6, 3),\n\t\t\t\t\t\tAR5K_RF_PWD_ICLOBUF_2G, true);\n\n\t}\n\n\t \n\tfor (i = 0; i < ah->ah_rf_banks_size; i++) {\n\t\tAR5K_REG_WAIT(i);\n\t\tath5k_hw_reg_write(ah, rfb[i], ini_rfb[i].rfb_ctrl_register);\n\t}\n\n\treturn 0;\n}\n\n\n \n\n \nstatic u32\nath5k_hw_rf5110_chan2athchan(struct ieee80211_channel *channel)\n{\n\tu32 athchan;\n\n\tathchan = (ath5k_hw_bitswap(\n\t\t\t(ieee80211_frequency_to_channel(\n\t\t\t\tchannel->center_freq) - 24) / 2, 5)\n\t\t\t\t<< 1) | (1 << 6) | 0x1;\n\treturn athchan;\n}\n\n \nstatic int\nath5k_hw_rf5110_channel(struct ath5k_hw *ah,\n\t\tstruct ieee80211_channel *channel)\n{\n\tu32 data;\n\n\t \n\tdata = ath5k_hw_rf5110_chan2athchan(channel);\n\tath5k_hw_reg_write(ah, data, AR5K_RF_BUFFER);\n\tath5k_hw_reg_write(ah, 0, AR5K_RF_BUFFER_CONTROL_0);\n\tusleep_range(1000, 1500);\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_hw_rf5111_chan2athchan(unsigned int ieee,\n\t\tstruct ath5k_athchan_2ghz *athchan)\n{\n\tint channel;\n\n\t \n\tchannel = (int)ieee;\n\n\t \n\tif (channel <= 13) {\n\t\tathchan->a2_athchan = 115 + channel;\n\t\tathchan->a2_flags = 0x46;\n\t} else if (channel == 14) {\n\t\tathchan->a2_athchan = 124;\n\t\tathchan->a2_flags = 0x44;\n\t} else if (channel >= 15 && channel <= 26) {\n\t\tathchan->a2_athchan = ((channel - 14) * 4) + 132;\n\t\tathchan->a2_flags = 0x46;\n\t} else\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_hw_rf5111_channel(struct ath5k_hw *ah,\n\t\tstruct ieee80211_channel *channel)\n{\n\tstruct ath5k_athchan_2ghz ath5k_channel_2ghz;\n\tunsigned int ath5k_channel =\n\t\tieee80211_frequency_to_channel(channel->center_freq);\n\tu32 data0, data1, clock;\n\tint ret;\n\n\t \n\tdata0 = data1 = 0;\n\n\tif (channel->band == NL80211_BAND_2GHZ) {\n\t\t \n\t\tret = ath5k_hw_rf5111_chan2athchan(\n\t\t\tieee80211_frequency_to_channel(channel->center_freq),\n\t\t\t&ath5k_channel_2ghz);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tath5k_channel = ath5k_channel_2ghz.a2_athchan;\n\t\tdata0 = ((ath5k_hw_bitswap(ath5k_channel_2ghz.a2_flags, 8) & 0xff)\n\t\t    << 5) | (1 << 4);\n\t}\n\n\tif (ath5k_channel < 145 || !(ath5k_channel & 1)) {\n\t\tclock = 1;\n\t\tdata1 = ((ath5k_hw_bitswap(ath5k_channel - 24, 8) & 0xff) << 2) |\n\t\t\t(clock << 1) | (1 << 10) | 1;\n\t} else {\n\t\tclock = 0;\n\t\tdata1 = ((ath5k_hw_bitswap((ath5k_channel - 24) / 2, 8) & 0xff)\n\t\t\t<< 2) | (clock << 1) | (1 << 10) | 1;\n\t}\n\n\tath5k_hw_reg_write(ah, (data1 & 0xff) | ((data0 & 0xff) << 8),\n\t\t\tAR5K_RF_BUFFER);\n\tath5k_hw_reg_write(ah, ((data1 >> 8) & 0xff) | (data0 & 0xff00),\n\t\t\tAR5K_RF_BUFFER_CONTROL_3);\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_hw_rf5112_channel(struct ath5k_hw *ah,\n\t\tstruct ieee80211_channel *channel)\n{\n\tu32 data, data0, data1, data2;\n\tu16 c;\n\n\tdata = data0 = data1 = data2 = 0;\n\tc = channel->center_freq;\n\n\t \n\tif (c < 4800) {\n\t\t \n\t\tif (!((c - 2224) % 5)) {\n\t\t\t \n\t\t\tdata0 = ((2 * (c - 704)) - 3040) / 10;\n\t\t\tdata1 = 1;\n\t\t \n\t\t} else if (!((c - 2192) % 5)) {\n\t\t\t \n\t\t\tdata0 = ((2 * (c - 672)) - 3040) / 10;\n\t\t\tdata1 = 0;\n\t\t} else\n\t\t\treturn -EINVAL;\n\n\t\tdata0 = ath5k_hw_bitswap((data0 << 2) & 0xff, 8);\n\t \n\t} else if ((c % 5) != 2 || c > 5435) {\n\t\tif (!(c % 20) && c >= 5120) {\n\t\t\tdata0 = ath5k_hw_bitswap(((c - 4800) / 20 << 2), 8);\n\t\t\tdata2 = ath5k_hw_bitswap(3, 2);\n\t\t} else if (!(c % 10)) {\n\t\t\tdata0 = ath5k_hw_bitswap(((c - 4800) / 10 << 1), 8);\n\t\t\tdata2 = ath5k_hw_bitswap(2, 2);\n\t\t} else if (!(c % 5)) {\n\t\t\tdata0 = ath5k_hw_bitswap((c - 4800) / 5, 8);\n\t\t\tdata2 = ath5k_hw_bitswap(1, 2);\n\t\t} else\n\t\t\treturn -EINVAL;\n\t} else {\n\t\tdata0 = ath5k_hw_bitswap((10 * (c - 2 - 4800)) / 25 + 1, 8);\n\t\tdata2 = ath5k_hw_bitswap(0, 2);\n\t}\n\n\tdata = (data0 << 4) | (data1 << 1) | (data2 << 2) | 0x1001;\n\n\tath5k_hw_reg_write(ah, data & 0xff, AR5K_RF_BUFFER);\n\tath5k_hw_reg_write(ah, (data >> 8) & 0x7f, AR5K_RF_BUFFER_CONTROL_5);\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_hw_rf2425_channel(struct ath5k_hw *ah,\n\t\tstruct ieee80211_channel *channel)\n{\n\tu32 data, data0, data2;\n\tu16 c;\n\n\tdata = data0 = data2 = 0;\n\tc = channel->center_freq;\n\n\tif (c < 4800) {\n\t\tdata0 = ath5k_hw_bitswap((c - 2272), 8);\n\t\tdata2 = 0;\n\t \n\t} else if ((c % 5) != 2 || c > 5435) {\n\t\tif (!(c % 20) && c < 5120)\n\t\t\tdata0 = ath5k_hw_bitswap(((c - 4800) / 20 << 2), 8);\n\t\telse if (!(c % 10))\n\t\t\tdata0 = ath5k_hw_bitswap(((c - 4800) / 10 << 1), 8);\n\t\telse if (!(c % 5))\n\t\t\tdata0 = ath5k_hw_bitswap((c - 4800) / 5, 8);\n\t\telse\n\t\t\treturn -EINVAL;\n\t\tdata2 = ath5k_hw_bitswap(1, 2);\n\t} else {\n\t\tdata0 = ath5k_hw_bitswap((10 * (c - 2 - 4800)) / 25 + 1, 8);\n\t\tdata2 = ath5k_hw_bitswap(0, 2);\n\t}\n\n\tdata = (data0 << 4) | data2 << 2 | 0x1001;\n\n\tath5k_hw_reg_write(ah, data & 0xff, AR5K_RF_BUFFER);\n\tath5k_hw_reg_write(ah, (data >> 8) & 0x7f, AR5K_RF_BUFFER_CONTROL_5);\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_hw_channel(struct ath5k_hw *ah,\n\t\tstruct ieee80211_channel *channel)\n{\n\tint ret;\n\t \n\tif (!ath5k_channel_ok(ah, channel)) {\n\t\tATH5K_ERR(ah,\n\t\t\t\"channel frequency (%u MHz) out of supported \"\n\t\t\t\"band range\\n\",\n\t\t\tchannel->center_freq);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tswitch (ah->ah_radio) {\n\tcase AR5K_RF5110:\n\t\tret = ath5k_hw_rf5110_channel(ah, channel);\n\t\tbreak;\n\tcase AR5K_RF5111:\n\t\tret = ath5k_hw_rf5111_channel(ah, channel);\n\t\tbreak;\n\tcase AR5K_RF2317:\n\tcase AR5K_RF2425:\n\t\tret = ath5k_hw_rf2425_channel(ah, channel);\n\t\tbreak;\n\tdefault:\n\t\tret = ath5k_hw_rf5112_channel(ah, channel);\n\t\tbreak;\n\t}\n\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (channel->center_freq == 2484) {\n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_CCKTXCTL,\n\t\t\t\tAR5K_PHY_CCKTXCTL_JAPAN);\n\t} else {\n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_CCKTXCTL,\n\t\t\t\tAR5K_PHY_CCKTXCTL_WORLD);\n\t}\n\n\tah->ah_current_channel = channel;\n\n\treturn 0;\n}\n\n\n \n\n \n\n \nstatic s32\nath5k_hw_read_measured_noise_floor(struct ath5k_hw *ah)\n{\n\ts32 val;\n\n\tval = ath5k_hw_reg_read(ah, AR5K_PHY_NF);\n\treturn sign_extend32(AR5K_REG_MS(val, AR5K_PHY_NF_MINCCA_PWR), 8);\n}\n\n \nvoid\nath5k_hw_init_nfcal_hist(struct ath5k_hw *ah)\n{\n\tint i;\n\n\tah->ah_nfcal_hist.index = 0;\n\tfor (i = 0; i < ATH5K_NF_CAL_HIST_MAX; i++)\n\t\tah->ah_nfcal_hist.nfval[i] = AR5K_TUNE_CCA_MAX_GOOD_VALUE;\n}\n\n \nstatic void ath5k_hw_update_nfcal_hist(struct ath5k_hw *ah, s16 noise_floor)\n{\n\tstruct ath5k_nfcal_hist *hist = &ah->ah_nfcal_hist;\n\thist->index = (hist->index + 1) & (ATH5K_NF_CAL_HIST_MAX - 1);\n\thist->nfval[hist->index] = noise_floor;\n}\n\nstatic int cmps16(const void *a, const void *b)\n{\n\treturn *(s16 *)a - *(s16 *)b;\n}\n\n \nstatic s16\nath5k_hw_get_median_noise_floor(struct ath5k_hw *ah)\n{\n\ts16 sorted_nfval[ATH5K_NF_CAL_HIST_MAX];\n\tint i;\n\n\tmemcpy(sorted_nfval, ah->ah_nfcal_hist.nfval, sizeof(sorted_nfval));\n\tsort(sorted_nfval, ATH5K_NF_CAL_HIST_MAX, sizeof(s16), cmps16, NULL);\n\tfor (i = 0; i < ATH5K_NF_CAL_HIST_MAX; i++) {\n\t\tATH5K_DBG(ah, ATH5K_DEBUG_CALIBRATE,\n\t\t\t\"cal %d:%d\\n\", i, sorted_nfval[i]);\n\t}\n\treturn sorted_nfval[(ATH5K_NF_CAL_HIST_MAX - 1) / 2];\n}\n\n \nvoid\nath5k_hw_update_noise_floor(struct ath5k_hw *ah)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu32 val;\n\ts16 nf, threshold;\n\tu8 ee_mode;\n\n\t \n\tif (ath5k_hw_reg_read(ah, AR5K_PHY_AGCCTL) & AR5K_PHY_AGCCTL_NF) {\n\t\tATH5K_DBG(ah, ATH5K_DEBUG_CALIBRATE,\n\t\t\t\"NF did not complete in calibration window\\n\");\n\n\t\treturn;\n\t}\n\n\tah->ah_cal_mask |= AR5K_CALIBRATION_NF;\n\n\tee_mode = ath5k_eeprom_mode_from_channel(ah, ah->ah_current_channel);\n\n\t \n\tnf = ath5k_hw_read_measured_noise_floor(ah);\n\tthreshold = ee->ee_noise_floor_thr[ee_mode];\n\n\tif (nf > threshold) {\n\t\tATH5K_DBG(ah, ATH5K_DEBUG_CALIBRATE,\n\t\t\t\"noise floor failure detected; \"\n\t\t\t\"read %d, threshold %d\\n\",\n\t\t\tnf, threshold);\n\n\t\tnf = AR5K_TUNE_CCA_MAX_GOOD_VALUE;\n\t}\n\n\tath5k_hw_update_nfcal_hist(ah, nf);\n\tnf = ath5k_hw_get_median_noise_floor(ah);\n\n\t \n\tval = ath5k_hw_reg_read(ah, AR5K_PHY_NF) & ~AR5K_PHY_NF_M;\n\tval |= (nf * 2) & AR5K_PHY_NF_M;\n\tath5k_hw_reg_write(ah, val, AR5K_PHY_NF);\n\n\tAR5K_REG_MASKED_BITS(ah, AR5K_PHY_AGCCTL, AR5K_PHY_AGCCTL_NF,\n\t\t~(AR5K_PHY_AGCCTL_NF_EN | AR5K_PHY_AGCCTL_NF_NOUPDATE));\n\n\tath5k_hw_register_timeout(ah, AR5K_PHY_AGCCTL, AR5K_PHY_AGCCTL_NF,\n\t\t0, false);\n\n\t \n\tval = (val & ~AR5K_PHY_NF_M) | ((-50 * 2) & AR5K_PHY_NF_M);\n\tath5k_hw_reg_write(ah, val, AR5K_PHY_NF);\n\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_AGCCTL,\n\t\tAR5K_PHY_AGCCTL_NF_EN |\n\t\tAR5K_PHY_AGCCTL_NF_NOUPDATE |\n\t\tAR5K_PHY_AGCCTL_NF);\n\n\tah->ah_noise_floor = nf;\n\n\tah->ah_cal_mask &= ~AR5K_CALIBRATION_NF;\n\n\tATH5K_DBG(ah, ATH5K_DEBUG_CALIBRATE,\n\t\t\"noise floor calibrated: %d\\n\", nf);\n}\n\n \nstatic int\nath5k_hw_rf5110_calibrate(struct ath5k_hw *ah,\n\t\tstruct ieee80211_channel *channel)\n{\n\tu32 phy_sig, phy_agc, phy_sat, beacon;\n\tint ret;\n\n\tif (!(ah->ah_cal_mask & AR5K_CALIBRATION_FULL))\n\t\treturn 0;\n\n\t \n\tAR5K_REG_ENABLE_BITS(ah, AR5K_DIAG_SW_5210,\n\t\tAR5K_DIAG_SW_DIS_TX_5210 | AR5K_DIAG_SW_DIS_RX_5210);\n\tbeacon = ath5k_hw_reg_read(ah, AR5K_BEACON_5210);\n\tath5k_hw_reg_write(ah, beacon & ~AR5K_BEACON_ENABLE, AR5K_BEACON_5210);\n\n\tusleep_range(2000, 2500);\n\n\t \n\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_AGC, AR5K_PHY_AGC_DISABLE);\n\tudelay(10);\n\tret = ath5k_hw_channel(ah, channel);\n\n\t \n\tath5k_hw_reg_write(ah, AR5K_PHY_ACT_ENABLE, AR5K_PHY_ACT);\n\tusleep_range(1000, 1500);\n\n\tAR5K_REG_DISABLE_BITS(ah, AR5K_PHY_AGC, AR5K_PHY_AGC_DISABLE);\n\n\tif (ret)\n\t\treturn ret;\n\n\t \n\n\t \n\tphy_sig = ath5k_hw_reg_read(ah, AR5K_PHY_SIG);\n\tphy_agc = ath5k_hw_reg_read(ah, AR5K_PHY_AGCCOARSE);\n\tphy_sat = ath5k_hw_reg_read(ah, AR5K_PHY_ADCSAT);\n\n\t \n\tath5k_hw_reg_write(ah, (phy_sig & ~(AR5K_PHY_SIG_FIRPWR)) |\n\t\tAR5K_REG_SM(-1, AR5K_PHY_SIG_FIRPWR), AR5K_PHY_SIG);\n\n\tath5k_hw_reg_write(ah, (phy_agc & ~(AR5K_PHY_AGCCOARSE_HI |\n\t\t\tAR5K_PHY_AGCCOARSE_LO)) |\n\t\tAR5K_REG_SM(-1, AR5K_PHY_AGCCOARSE_HI) |\n\t\tAR5K_REG_SM(-127, AR5K_PHY_AGCCOARSE_LO), AR5K_PHY_AGCCOARSE);\n\n\tath5k_hw_reg_write(ah, (phy_sat & ~(AR5K_PHY_ADCSAT_ICNT |\n\t\t\tAR5K_PHY_ADCSAT_THR)) |\n\t\tAR5K_REG_SM(2, AR5K_PHY_ADCSAT_ICNT) |\n\t\tAR5K_REG_SM(12, AR5K_PHY_ADCSAT_THR), AR5K_PHY_ADCSAT);\n\n\tudelay(20);\n\n\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_AGC, AR5K_PHY_AGC_DISABLE);\n\tudelay(10);\n\tath5k_hw_reg_write(ah, AR5K_PHY_RFSTG_DISABLE, AR5K_PHY_RFSTG);\n\tAR5K_REG_DISABLE_BITS(ah, AR5K_PHY_AGC, AR5K_PHY_AGC_DISABLE);\n\n\tusleep_range(1000, 1500);\n\n\t \n\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_AGCCTL, AR5K_PHY_AGCCTL_CAL);\n\n\tret = ath5k_hw_register_timeout(ah, AR5K_PHY_AGCCTL,\n\t\t\tAR5K_PHY_AGCCTL_CAL, 0, false);\n\n\t \n\tath5k_hw_reg_write(ah, phy_sig, AR5K_PHY_SIG);\n\tath5k_hw_reg_write(ah, phy_agc, AR5K_PHY_AGCCOARSE);\n\tath5k_hw_reg_write(ah, phy_sat, AR5K_PHY_ADCSAT);\n\n\tif (ret) {\n\t\tATH5K_ERR(ah, \"calibration timeout (%uMHz)\\n\",\n\t\t\t\tchannel->center_freq);\n\t\treturn ret;\n\t}\n\n\t \n\tAR5K_REG_DISABLE_BITS(ah, AR5K_DIAG_SW_5210,\n\t\tAR5K_DIAG_SW_DIS_TX_5210 | AR5K_DIAG_SW_DIS_RX_5210);\n\tath5k_hw_reg_write(ah, beacon, AR5K_BEACON_5210);\n\n\treturn 0;\n}\n\n \nstatic int\nath5k_hw_rf511x_iq_calibrate(struct ath5k_hw *ah)\n{\n\tu32 i_pwr, q_pwr;\n\ts32 iq_corr, i_coff, i_coffd, q_coff, q_coffd;\n\tint i;\n\n\t \n\tif (!ah->ah_iq_cal_needed)\n\t\treturn -EINVAL;\n\telse if (ath5k_hw_reg_read(ah, AR5K_PHY_IQ) & AR5K_PHY_IQ_RUN) {\n\t\tATH5K_DBG_UNLIMIT(ah, ATH5K_DEBUG_CALIBRATE,\n\t\t\t\t\"I/Q calibration still running\");\n\t\treturn -EBUSY;\n\t}\n\n\t \n\n\t \n\tfor (i = 0; i <= 10; i++) {\n\t\tiq_corr = ath5k_hw_reg_read(ah, AR5K_PHY_IQRES_CAL_CORR);\n\t\ti_pwr = ath5k_hw_reg_read(ah, AR5K_PHY_IQRES_CAL_PWR_I);\n\t\tq_pwr = ath5k_hw_reg_read(ah, AR5K_PHY_IQRES_CAL_PWR_Q);\n\t\tATH5K_DBG_UNLIMIT(ah, ATH5K_DEBUG_CALIBRATE,\n\t\t\t\"iq_corr:%x i_pwr:%x q_pwr:%x\", iq_corr, i_pwr, q_pwr);\n\t\tif (i_pwr && q_pwr)\n\t\t\tbreak;\n\t}\n\n\ti_coffd = ((i_pwr >> 1) + (q_pwr >> 1)) >> 7;\n\n\tif (ah->ah_version == AR5K_AR5211)\n\t\tq_coffd = q_pwr >> 6;\n\telse\n\t\tq_coffd = q_pwr >> 7;\n\n\t \n\tif (i_coffd == 0 || q_coffd < 2)\n\t\treturn -ECANCELED;\n\n\t \n\n\ti_coff = (-iq_corr) / i_coffd;\n\ti_coff = clamp(i_coff, -32, 31);  \n\n\tif (ah->ah_version == AR5K_AR5211)\n\t\tq_coff = (i_pwr / q_coffd) - 64;\n\telse\n\t\tq_coff = (i_pwr / q_coffd) - 128;\n\tq_coff = clamp(q_coff, -16, 15);  \n\n\tATH5K_DBG_UNLIMIT(ah, ATH5K_DEBUG_CALIBRATE,\n\t\t\t\"new I:%d Q:%d (i_coffd:%x q_coffd:%x)\",\n\t\t\ti_coff, q_coff, i_coffd, q_coffd);\n\n\t \n\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_IQ, AR5K_PHY_IQ_CORR_Q_I_COFF, i_coff);\n\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_IQ, AR5K_PHY_IQ_CORR_Q_Q_COFF, q_coff);\n\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_IQ, AR5K_PHY_IQ_CORR_ENABLE);\n\n\t \n\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_IQ,\n\t\t\tAR5K_PHY_IQ_CAL_NUM_LOG_MAX, 15);\n\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_IQ, AR5K_PHY_IQ_RUN);\n\n\treturn 0;\n}\n\n \nint\nath5k_hw_phy_calibrate(struct ath5k_hw *ah,\n\t\tstruct ieee80211_channel *channel)\n{\n\tint ret;\n\n\tif (ah->ah_radio == AR5K_RF5110)\n\t\treturn ath5k_hw_rf5110_calibrate(ah, channel);\n\n\tret = ath5k_hw_rf511x_iq_calibrate(ah);\n\tif (ret) {\n\t\tATH5K_DBG_UNLIMIT(ah, ATH5K_DEBUG_CALIBRATE,\n\t\t\t\"No I/Q correction performed (%uMHz)\\n\",\n\t\t\tchannel->center_freq);\n\n\t\t \n\t\tret = 0;\n\t}\n\n\t \n\tif ((ah->ah_cal_mask & AR5K_CALIBRATION_FULL) &&\n\t    (ah->ah_radio == AR5K_RF5111 ||\n\t     ah->ah_radio == AR5K_RF5112) &&\n\t    channel->hw_value != AR5K_MODE_11B)\n\t\tath5k_hw_request_rfgain_probe(ah);\n\n\t \n\tif (!(ah->ah_cal_mask & AR5K_CALIBRATION_NF))\n\t\tath5k_hw_update_noise_floor(ah);\n\n\treturn ret;\n}\n\n\n \n\n \nstatic void\nath5k_hw_set_spur_mitigation_filter(struct ath5k_hw *ah,\n\t\t\t\tstruct ieee80211_channel *channel)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu32 mag_mask[4] = {0, 0, 0, 0};\n\tu32 pilot_mask[2] = {0, 0};\n\t \n\tu16 spur_chan_fbin, chan_fbin, symbol_width, spur_detection_window;\n\ts32 spur_delta_phase, spur_freq_sigma_delta;\n\ts32 spur_offset, num_symbols_x16;\n\tu8 num_symbol_offsets, i, freq_band;\n\n\t \n\tif (channel->band == NL80211_BAND_2GHZ) {\n\t\tchan_fbin = (channel->center_freq - 2300) * 10;\n\t\tfreq_band = AR5K_EEPROM_BAND_2GHZ;\n\t} else {\n\t\tchan_fbin = (channel->center_freq - 4900) * 10;\n\t\tfreq_band = AR5K_EEPROM_BAND_5GHZ;\n\t}\n\n\t \n\tspur_chan_fbin = AR5K_EEPROM_NO_SPUR;\n\tspur_detection_window = AR5K_SPUR_CHAN_WIDTH;\n\t \n\tif (ah->ah_bwmode == AR5K_BWMODE_40MHZ)\n\t\tspur_detection_window *= 2;\n\n\tfor (i = 0; i < AR5K_EEPROM_N_SPUR_CHANS; i++) {\n\t\tspur_chan_fbin = ee->ee_spur_chans[i][freq_band];\n\n\t\t \n\t\tif (spur_chan_fbin == AR5K_EEPROM_NO_SPUR) {\n\t\t\tspur_chan_fbin &= AR5K_EEPROM_SPUR_CHAN_MASK;\n\t\t\tbreak;\n\t\t}\n\n\t\tif ((chan_fbin - spur_detection_window <=\n\t\t(spur_chan_fbin & AR5K_EEPROM_SPUR_CHAN_MASK)) &&\n\t\t(chan_fbin + spur_detection_window >=\n\t\t(spur_chan_fbin & AR5K_EEPROM_SPUR_CHAN_MASK))) {\n\t\t\tspur_chan_fbin &= AR5K_EEPROM_SPUR_CHAN_MASK;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\tif (spur_chan_fbin) {\n\t\tspur_offset = spur_chan_fbin - chan_fbin;\n\t\t \n\t\tswitch (ah->ah_bwmode) {\n\t\tcase AR5K_BWMODE_40MHZ:\n\t\t\t \n\t\t\tspur_delta_phase = (spur_offset << 16) / 25;\n\t\t\tspur_freq_sigma_delta = (spur_delta_phase >> 10);\n\t\t\tsymbol_width = AR5K_SPUR_SYMBOL_WIDTH_BASE_100Hz * 2;\n\t\t\tbreak;\n\t\tcase AR5K_BWMODE_10MHZ:\n\t\t\t \n\t\t\tspur_delta_phase = (spur_offset << 18) / 25;\n\t\t\tspur_freq_sigma_delta = (spur_delta_phase >> 10);\n\t\t\tsymbol_width = AR5K_SPUR_SYMBOL_WIDTH_BASE_100Hz / 2;\n\t\t\tbreak;\n\t\tcase AR5K_BWMODE_5MHZ:\n\t\t\t \n\t\t\tspur_delta_phase = (spur_offset << 19) / 25;\n\t\t\tspur_freq_sigma_delta = (spur_delta_phase >> 10);\n\t\t\tsymbol_width = AR5K_SPUR_SYMBOL_WIDTH_BASE_100Hz / 4;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tif (channel->band == NL80211_BAND_5GHZ) {\n\t\t\t\t \n\t\t\t\tspur_delta_phase = (spur_offset << 17) / 25;\n\t\t\t\tspur_freq_sigma_delta =\n\t\t\t\t\t\t(spur_delta_phase >> 10);\n\t\t\t\tsymbol_width =\n\t\t\t\t\tAR5K_SPUR_SYMBOL_WIDTH_BASE_100Hz;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tspur_delta_phase = (spur_offset << 17) / 25;\n\t\t\t\tspur_freq_sigma_delta =\n\t\t\t\t\t\t(spur_offset << 8) / 55;\n\t\t\t\tsymbol_width =\n\t\t\t\t\tAR5K_SPUR_SYMBOL_WIDTH_BASE_100Hz;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\n\t\t \n\t\tnum_symbols_x16 = ((spur_offset * 1000) << 4) / symbol_width;\n\n\t\t \n\t\tif (!(num_symbols_x16 & 0xF))\n\t\t\t \n\t\t\tnum_symbol_offsets = 3;\n\t\telse\n\t\t\t \n\t\t\tnum_symbol_offsets = 4;\n\n\t\tfor (i = 0; i < num_symbol_offsets; i++) {\n\n\t\t\t \n\t\t\ts32 curr_sym_off =\n\t\t\t\t(num_symbols_x16 / 16) + i + 25;\n\n\t\t\t \n\t\t\tu8 plt_mag_map =\n\t\t\t\t(i == 0 || i == (num_symbol_offsets - 1))\n\t\t\t\t\t\t\t\t? 1 : 2;\n\n\t\t\tif (curr_sym_off >= 0 && curr_sym_off <= 32) {\n\t\t\t\tif (curr_sym_off <= 25)\n\t\t\t\t\tpilot_mask[0] |= 1 << curr_sym_off;\n\t\t\t\telse if (curr_sym_off >= 27)\n\t\t\t\t\tpilot_mask[0] |= 1 << (curr_sym_off - 1);\n\t\t\t} else if (curr_sym_off >= 33 && curr_sym_off <= 52)\n\t\t\t\tpilot_mask[1] |= 1 << (curr_sym_off - 33);\n\n\t\t\t \n\t\t\tif (curr_sym_off >= -1 && curr_sym_off <= 14)\n\t\t\t\tmag_mask[0] |=\n\t\t\t\t\tplt_mag_map << (curr_sym_off + 1) * 2;\n\t\t\telse if (curr_sym_off >= 15 && curr_sym_off <= 30)\n\t\t\t\tmag_mask[1] |=\n\t\t\t\t\tplt_mag_map << (curr_sym_off - 15) * 2;\n\t\t\telse if (curr_sym_off >= 31 && curr_sym_off <= 46)\n\t\t\t\tmag_mask[2] |=\n\t\t\t\t\tplt_mag_map << (curr_sym_off - 31) * 2;\n\t\t\telse if (curr_sym_off >= 47 && curr_sym_off <= 53)\n\t\t\t\tmag_mask[3] |=\n\t\t\t\t\tplt_mag_map << (curr_sym_off - 47) * 2;\n\n\t\t}\n\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_BIN_MASK_CTL,\n\t\t\t\t\tAR5K_PHY_BIN_MASK_CTL_RATE, 0xff);\n\t\t \n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_IQ,\n\t\t\t\t\tAR5K_PHY_IQ_PILOT_MASK_EN |\n\t\t\t\t\tAR5K_PHY_IQ_CHAN_MASK_EN |\n\t\t\t\t\tAR5K_PHY_IQ_SPUR_FILT_EN);\n\n\t\t \n\t\tath5k_hw_reg_write(ah,\n\t\t\t\tAR5K_REG_SM(spur_delta_phase,\n\t\t\t\t\tAR5K_PHY_TIMING_11_SPUR_DELTA_PHASE) |\n\t\t\t\tAR5K_REG_SM(spur_freq_sigma_delta,\n\t\t\t\tAR5K_PHY_TIMING_11_SPUR_FREQ_SD) |\n\t\t\t\tAR5K_PHY_TIMING_11_USE_SPUR_IN_AGC,\n\t\t\t\tAR5K_PHY_TIMING_11);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, pilot_mask[0], AR5K_PHY_TIMING_7);\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_TIMING_8,\n\t\t\t\t\tAR5K_PHY_TIMING_8_PILOT_MASK_2,\n\t\t\t\t\tpilot_mask[1]);\n\n\t\tath5k_hw_reg_write(ah, pilot_mask[0], AR5K_PHY_TIMING_9);\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_TIMING_10,\n\t\t\t\t\tAR5K_PHY_TIMING_10_PILOT_MASK_2,\n\t\t\t\t\tpilot_mask[1]);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, mag_mask[0], AR5K_PHY_BIN_MASK_1);\n\t\tath5k_hw_reg_write(ah, mag_mask[1], AR5K_PHY_BIN_MASK_2);\n\t\tath5k_hw_reg_write(ah, mag_mask[2], AR5K_PHY_BIN_MASK_3);\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_BIN_MASK_CTL,\n\t\t\t\t\tAR5K_PHY_BIN_MASK_CTL_MASK_4,\n\t\t\t\t\tmag_mask[3]);\n\n\t\tath5k_hw_reg_write(ah, mag_mask[0], AR5K_PHY_BIN_MASK2_1);\n\t\tath5k_hw_reg_write(ah, mag_mask[1], AR5K_PHY_BIN_MASK2_2);\n\t\tath5k_hw_reg_write(ah, mag_mask[2], AR5K_PHY_BIN_MASK2_3);\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_BIN_MASK2_4,\n\t\t\t\t\tAR5K_PHY_BIN_MASK2_4_MASK_4,\n\t\t\t\t\tmag_mask[3]);\n\n\t} else if (ath5k_hw_reg_read(ah, AR5K_PHY_IQ) &\n\tAR5K_PHY_IQ_SPUR_FILT_EN) {\n\t\t \n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_BIN_MASK_CTL,\n\t\t\t\t\tAR5K_PHY_BIN_MASK_CTL_RATE, 0);\n\t\tAR5K_REG_DISABLE_BITS(ah, AR5K_PHY_IQ,\n\t\t\t\t\tAR5K_PHY_IQ_PILOT_MASK_EN |\n\t\t\t\t\tAR5K_PHY_IQ_CHAN_MASK_EN |\n\t\t\t\t\tAR5K_PHY_IQ_SPUR_FILT_EN);\n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_TIMING_11);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_TIMING_7);\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_TIMING_8,\n\t\t\t\t\tAR5K_PHY_TIMING_8_PILOT_MASK_2,\n\t\t\t\t\t0);\n\n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_TIMING_9);\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_TIMING_10,\n\t\t\t\t\tAR5K_PHY_TIMING_10_PILOT_MASK_2,\n\t\t\t\t\t0);\n\n\t\t \n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_BIN_MASK_1);\n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_BIN_MASK_2);\n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_BIN_MASK_3);\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_BIN_MASK_CTL,\n\t\t\t\t\tAR5K_PHY_BIN_MASK_CTL_MASK_4,\n\t\t\t\t\t0);\n\n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_BIN_MASK2_1);\n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_BIN_MASK2_2);\n\t\tath5k_hw_reg_write(ah, 0, AR5K_PHY_BIN_MASK2_3);\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_BIN_MASK2_4,\n\t\t\t\t\tAR5K_PHY_BIN_MASK2_4_MASK_4,\n\t\t\t\t\t0);\n\t}\n}\n\n\n \n\n \n\n \nstatic void\nath5k_hw_set_def_antenna(struct ath5k_hw *ah, u8 ant)\n{\n\tif (ah->ah_version != AR5K_AR5210)\n\t\tath5k_hw_reg_write(ah, ant & 0x7, AR5K_DEFAULT_ANTENNA);\n}\n\n \nstatic void\nath5k_hw_set_fast_div(struct ath5k_hw *ah, u8 ee_mode, bool enable)\n{\n\tswitch (ee_mode) {\n\tcase AR5K_EEPROM_MODE_11G:\n\t\t \n\tcase AR5K_EEPROM_MODE_11A:\n\t\tif (enable)\n\t\t\tAR5K_REG_DISABLE_BITS(ah, AR5K_PHY_AGCCTL,\n\t\t\t\t\tAR5K_PHY_AGCCTL_OFDM_DIV_DIS);\n\t\telse\n\t\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_AGCCTL,\n\t\t\t\t\tAR5K_PHY_AGCCTL_OFDM_DIV_DIS);\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11B:\n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_AGCCTL,\n\t\t\t\t\tAR5K_PHY_AGCCTL_OFDM_DIV_DIS);\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tif (enable) {\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_RESTART,\n\t\t\t\tAR5K_PHY_RESTART_DIV_GC, 4);\n\n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_FAST_ANT_DIV,\n\t\t\t\t\tAR5K_PHY_FAST_ANT_DIV_EN);\n\t} else {\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_RESTART,\n\t\t\t\tAR5K_PHY_RESTART_DIV_GC, 0);\n\n\t\tAR5K_REG_DISABLE_BITS(ah, AR5K_PHY_FAST_ANT_DIV,\n\t\t\t\t\tAR5K_PHY_FAST_ANT_DIV_EN);\n\t}\n}\n\n \nvoid\nath5k_hw_set_antenna_switch(struct ath5k_hw *ah, u8 ee_mode)\n{\n\tu8 ant0, ant1;\n\n\t \n\tif (ah->ah_ant_mode == AR5K_ANTMODE_FIXED_A)\n\t\tant0 = ant1 = AR5K_ANT_SWTABLE_A;\n\telse if (ah->ah_ant_mode == AR5K_ANTMODE_FIXED_B)\n\t\tant0 = ant1 = AR5K_ANT_SWTABLE_B;\n\telse {\n\t\tant0 = AR5K_ANT_SWTABLE_A;\n\t\tant1 = AR5K_ANT_SWTABLE_B;\n\t}\n\n\t \n\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_ANT_CTL,\n\t\t\tAR5K_PHY_ANT_CTL_SWTABLE_IDLE,\n\t\t\t(ah->ah_ant_ctl[ee_mode][AR5K_ANT_CTL] |\n\t\t\tAR5K_PHY_ANT_CTL_TXRX_EN));\n\n\t \n\tath5k_hw_reg_write(ah, ah->ah_ant_ctl[ee_mode][ant0],\n\t\tAR5K_PHY_ANT_SWITCH_TABLE_0);\n\tath5k_hw_reg_write(ah, ah->ah_ant_ctl[ee_mode][ant1],\n\t\tAR5K_PHY_ANT_SWITCH_TABLE_1);\n}\n\n \nvoid\nath5k_hw_set_antenna_mode(struct ath5k_hw *ah, u8 ant_mode)\n{\n\tstruct ieee80211_channel *channel = ah->ah_current_channel;\n\tbool use_def_for_tx, update_def_on_tx, use_def_for_rts, fast_div;\n\tbool use_def_for_sg;\n\tint ee_mode;\n\tu8 def_ant, tx_ant;\n\tu32 sta_id1 = 0;\n\n\t \n\tif (channel == NULL) {\n\t\tah->ah_ant_mode = ant_mode;\n\t\treturn;\n\t}\n\n\tdef_ant = ah->ah_def_ant;\n\n\tee_mode = ath5k_eeprom_mode_from_channel(ah, channel);\n\n\tswitch (ant_mode) {\n\tcase AR5K_ANTMODE_DEFAULT:\n\t\ttx_ant = 0;\n\t\tuse_def_for_tx = false;\n\t\tupdate_def_on_tx = false;\n\t\tuse_def_for_rts = false;\n\t\tuse_def_for_sg = false;\n\t\tfast_div = true;\n\t\tbreak;\n\tcase AR5K_ANTMODE_FIXED_A:\n\t\tdef_ant = 1;\n\t\ttx_ant = 1;\n\t\tuse_def_for_tx = true;\n\t\tupdate_def_on_tx = false;\n\t\tuse_def_for_rts = true;\n\t\tuse_def_for_sg = true;\n\t\tfast_div = false;\n\t\tbreak;\n\tcase AR5K_ANTMODE_FIXED_B:\n\t\tdef_ant = 2;\n\t\ttx_ant = 2;\n\t\tuse_def_for_tx = true;\n\t\tupdate_def_on_tx = false;\n\t\tuse_def_for_rts = true;\n\t\tuse_def_for_sg = true;\n\t\tfast_div = false;\n\t\tbreak;\n\tcase AR5K_ANTMODE_SINGLE_AP:\n\t\tdef_ant = 1;\t \n\t\ttx_ant = 0;\n\t\tuse_def_for_tx = true;\n\t\tupdate_def_on_tx = true;\n\t\tuse_def_for_rts = true;\n\t\tuse_def_for_sg = true;\n\t\tfast_div = true;\n\t\tbreak;\n\tcase AR5K_ANTMODE_SECTOR_AP:\n\t\ttx_ant = 1;\t \n\t\tuse_def_for_tx = false;\n\t\tupdate_def_on_tx = false;\n\t\tuse_def_for_rts = true;\n\t\tuse_def_for_sg = false;\n\t\tfast_div = false;\n\t\tbreak;\n\tcase AR5K_ANTMODE_SECTOR_STA:\n\t\ttx_ant = 1;\t \n\t\tuse_def_for_tx = true;\n\t\tupdate_def_on_tx = false;\n\t\tuse_def_for_rts = true;\n\t\tuse_def_for_sg = false;\n\t\tfast_div = true;\n\t\tbreak;\n\tcase AR5K_ANTMODE_DEBUG:\n\t\tdef_ant = 1;\n\t\ttx_ant = 2;\n\t\tuse_def_for_tx = false;\n\t\tupdate_def_on_tx = false;\n\t\tuse_def_for_rts = false;\n\t\tuse_def_for_sg = false;\n\t\tfast_div = false;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tah->ah_tx_ant = tx_ant;\n\tah->ah_ant_mode = ant_mode;\n\tah->ah_def_ant = def_ant;\n\n\tsta_id1 |= use_def_for_tx ? AR5K_STA_ID1_DEFAULT_ANTENNA : 0;\n\tsta_id1 |= update_def_on_tx ? AR5K_STA_ID1_DESC_ANTENNA : 0;\n\tsta_id1 |= use_def_for_rts ? AR5K_STA_ID1_RTS_DEF_ANTENNA : 0;\n\tsta_id1 |= use_def_for_sg ? AR5K_STA_ID1_SELFGEN_DEF_ANT : 0;\n\n\tAR5K_REG_DISABLE_BITS(ah, AR5K_STA_ID1, AR5K_STA_ID1_ANTENNA_SETTINGS);\n\n\tif (sta_id1)\n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_STA_ID1, sta_id1);\n\n\tath5k_hw_set_antenna_switch(ah, ee_mode);\n\t \n\tath5k_hw_set_fast_div(ah, ee_mode, fast_div);\n\tath5k_hw_set_def_antenna(ah, def_ant);\n}\n\n\n \n\n \n\n \nstatic s16\nath5k_get_interpolated_value(s16 target, s16 x_left, s16 x_right,\n\t\t\t\t\ts16 y_left, s16 y_right)\n{\n\ts16 ratio, result;\n\n\t \n\tif ((x_left == x_right) || (y_left == y_right))\n\t\treturn y_left;\n\n\t \n\tratio = ((100 * y_right - 100 * y_left) / (x_right - x_left));\n\n\t \n\tresult = y_left + (ratio * (target - x_left) / 100);\n\n\treturn result;\n}\n\n \nstatic s16\nath5k_get_linear_pcdac_min(const u8 *stepL, const u8 *stepR,\n\t\t\t\tconst s16 *pwrL, const s16 *pwrR)\n{\n\ts8 tmp;\n\ts16 min_pwrL, min_pwrR;\n\ts16 pwr_i;\n\n\t \n\tif (stepL[0] == stepL[1] || stepR[0] == stepR[1])\n\t\treturn max(pwrL[0], pwrR[0]);\n\n\tif (pwrL[0] == pwrL[1])\n\t\tmin_pwrL = pwrL[0];\n\telse {\n\t\tpwr_i = pwrL[0];\n\t\tdo {\n\t\t\tpwr_i--;\n\t\t\ttmp = (s8) ath5k_get_interpolated_value(pwr_i,\n\t\t\t\t\t\t\tpwrL[0], pwrL[1],\n\t\t\t\t\t\t\tstepL[0], stepL[1]);\n\t\t} while (tmp > 1);\n\n\t\tmin_pwrL = pwr_i;\n\t}\n\n\tif (pwrR[0] == pwrR[1])\n\t\tmin_pwrR = pwrR[0];\n\telse {\n\t\tpwr_i = pwrR[0];\n\t\tdo {\n\t\t\tpwr_i--;\n\t\t\ttmp = (s8) ath5k_get_interpolated_value(pwr_i,\n\t\t\t\t\t\t\tpwrR[0], pwrR[1],\n\t\t\t\t\t\t\tstepR[0], stepR[1]);\n\t\t} while (tmp > 1);\n\n\t\tmin_pwrR = pwr_i;\n\t}\n\n\t \n\treturn max(min_pwrL, min_pwrR);\n}\n\n \nstatic void\nath5k_create_power_curve(s16 pmin, s16 pmax,\n\t\t\tconst s16 *pwr, const u8 *vpd,\n\t\t\tu8 num_points,\n\t\t\tu8 *vpd_table, u8 type)\n{\n\tu8 idx[2] = { 0, 1 };\n\ts16 pwr_i = 2 * pmin;\n\tint i;\n\n\tif (num_points < 2)\n\t\treturn;\n\n\t \n\tif (type == AR5K_PWRTABLE_LINEAR_PCDAC) {\n\t\tpwr_i = pmin;\n\t\tpmin = 0;\n\t\tpmax = 63;\n\t}\n\n\t \n\tfor (i = 0; (i <= (u16) (pmax - pmin)) &&\n\t(i < AR5K_EEPROM_POWER_TABLE_SIZE); i++) {\n\n\t\t \n\t\tif ((pwr_i > pwr[idx[1]]) && (idx[1] < num_points - 1)) {\n\t\t\tidx[0]++;\n\t\t\tidx[1]++;\n\t\t}\n\n\t\tvpd_table[i] = (u8) ath5k_get_interpolated_value(pwr_i,\n\t\t\t\t\t\tpwr[idx[0]], pwr[idx[1]],\n\t\t\t\t\t\tvpd[idx[0]], vpd[idx[1]]);\n\n\t\t \n\t\tpwr_i += 2;\n\t}\n}\n\n \nstatic void\nath5k_get_chan_pcal_surrounding_piers(struct ath5k_hw *ah,\n\t\t\tstruct ieee80211_channel *channel,\n\t\t\tstruct ath5k_chan_pcal_info **pcinfo_l,\n\t\t\tstruct ath5k_chan_pcal_info **pcinfo_r)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_chan_pcal_info *pcinfo;\n\tu8 idx_l, idx_r;\n\tu8 mode, max, i;\n\tu32 target = channel->center_freq;\n\n\tidx_l = 0;\n\tidx_r = 0;\n\n\tswitch (channel->hw_value) {\n\tcase AR5K_EEPROM_MODE_11A:\n\t\tpcinfo = ee->ee_pwr_cal_a;\n\t\tmode = AR5K_EEPROM_MODE_11A;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11B:\n\t\tpcinfo = ee->ee_pwr_cal_b;\n\t\tmode = AR5K_EEPROM_MODE_11B;\n\t\tbreak;\n\tcase AR5K_EEPROM_MODE_11G:\n\tdefault:\n\t\tpcinfo = ee->ee_pwr_cal_g;\n\t\tmode = AR5K_EEPROM_MODE_11G;\n\t\tbreak;\n\t}\n\tmax = ee->ee_n_piers[mode] - 1;\n\n\t \n\tif (target < pcinfo[0].freq) {\n\t\tidx_l = idx_r = 0;\n\t\tgoto done;\n\t}\n\n\t \n\tif (target > pcinfo[max].freq) {\n\t\tidx_l = idx_r = max;\n\t\tgoto done;\n\t}\n\n\t \n\tfor (i = 0; i <= max; i++) {\n\n\t\t \n\t\tif (pcinfo[i].freq == target) {\n\t\t\tidx_l = idx_r = i;\n\t\t\tgoto done;\n\t\t}\n\n\t\t \n\t\tif (target < pcinfo[i].freq) {\n\t\t\tidx_r = i;\n\t\t\tidx_l = idx_r - 1;\n\t\t\tgoto done;\n\t\t}\n\t}\n\ndone:\n\t*pcinfo_l = &pcinfo[idx_l];\n\t*pcinfo_r = &pcinfo[idx_r];\n}\n\n \nstatic void\nath5k_get_rate_pcal_data(struct ath5k_hw *ah,\n\t\t\tstruct ieee80211_channel *channel,\n\t\t\tstruct ath5k_rate_pcal_info *rates)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_rate_pcal_info *rpinfo;\n\tu8 idx_l, idx_r;\n\tu8 mode, max, i;\n\tu32 target = channel->center_freq;\n\n\tidx_l = 0;\n\tidx_r = 0;\n\n\tswitch (channel->hw_value) {\n\tcase AR5K_MODE_11A:\n\t\trpinfo = ee->ee_rate_tpwr_a;\n\t\tmode = AR5K_EEPROM_MODE_11A;\n\t\tbreak;\n\tcase AR5K_MODE_11B:\n\t\trpinfo = ee->ee_rate_tpwr_b;\n\t\tmode = AR5K_EEPROM_MODE_11B;\n\t\tbreak;\n\tcase AR5K_MODE_11G:\n\tdefault:\n\t\trpinfo = ee->ee_rate_tpwr_g;\n\t\tmode = AR5K_EEPROM_MODE_11G;\n\t\tbreak;\n\t}\n\tmax = ee->ee_rate_target_pwr_num[mode] - 1;\n\n\t \n\tif (target < rpinfo[0].freq) {\n\t\tidx_l = idx_r = 0;\n\t\tgoto done;\n\t}\n\n\tif (target > rpinfo[max].freq) {\n\t\tidx_l = idx_r = max;\n\t\tgoto done;\n\t}\n\n\tfor (i = 0; i <= max; i++) {\n\n\t\tif (rpinfo[i].freq == target) {\n\t\t\tidx_l = idx_r = i;\n\t\t\tgoto done;\n\t\t}\n\n\t\tif (target < rpinfo[i].freq) {\n\t\t\tidx_r = i;\n\t\t\tidx_l = idx_r - 1;\n\t\t\tgoto done;\n\t\t}\n\t}\n\ndone:\n\t \n\trates->freq = target;\n\n\trates->target_power_6to24 =\n\t\tath5k_get_interpolated_value(target, rpinfo[idx_l].freq,\n\t\t\t\t\trpinfo[idx_r].freq,\n\t\t\t\t\trpinfo[idx_l].target_power_6to24,\n\t\t\t\t\trpinfo[idx_r].target_power_6to24);\n\n\trates->target_power_36 =\n\t\tath5k_get_interpolated_value(target, rpinfo[idx_l].freq,\n\t\t\t\t\trpinfo[idx_r].freq,\n\t\t\t\t\trpinfo[idx_l].target_power_36,\n\t\t\t\t\trpinfo[idx_r].target_power_36);\n\n\trates->target_power_48 =\n\t\tath5k_get_interpolated_value(target, rpinfo[idx_l].freq,\n\t\t\t\t\trpinfo[idx_r].freq,\n\t\t\t\t\trpinfo[idx_l].target_power_48,\n\t\t\t\t\trpinfo[idx_r].target_power_48);\n\n\trates->target_power_54 =\n\t\tath5k_get_interpolated_value(target, rpinfo[idx_l].freq,\n\t\t\t\t\trpinfo[idx_r].freq,\n\t\t\t\t\trpinfo[idx_l].target_power_54,\n\t\t\t\t\trpinfo[idx_r].target_power_54);\n}\n\n \nstatic void\nath5k_get_max_ctl_power(struct ath5k_hw *ah,\n\t\t\tstruct ieee80211_channel *channel)\n{\n\tstruct ath_regulatory *regulatory = ath5k_hw_regulatory(ah);\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tstruct ath5k_edge_power *rep = ee->ee_ctl_pwr;\n\tu8 *ctl_val = ee->ee_ctl;\n\ts16 max_chan_pwr = ah->ah_txpower.txp_max_pwr / 4;\n\ts16 edge_pwr = 0;\n\tu8 rep_idx;\n\tu8 i, ctl_mode;\n\tu8 ctl_idx = 0xFF;\n\tu32 target = channel->center_freq;\n\n\tctl_mode = ath_regd_get_band_ctl(regulatory, channel->band);\n\n\tswitch (channel->hw_value) {\n\tcase AR5K_MODE_11A:\n\t\tif (ah->ah_bwmode == AR5K_BWMODE_40MHZ)\n\t\t\tctl_mode |= AR5K_CTL_TURBO;\n\t\telse\n\t\t\tctl_mode |= AR5K_CTL_11A;\n\t\tbreak;\n\tcase AR5K_MODE_11G:\n\t\tif (ah->ah_bwmode == AR5K_BWMODE_40MHZ)\n\t\t\tctl_mode |= AR5K_CTL_TURBOG;\n\t\telse\n\t\t\tctl_mode |= AR5K_CTL_11G;\n\t\tbreak;\n\tcase AR5K_MODE_11B:\n\t\tctl_mode |= AR5K_CTL_11B;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tfor (i = 0; i < ee->ee_ctls; i++) {\n\t\tif (ctl_val[i] == ctl_mode) {\n\t\t\tctl_idx = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\tif (ctl_idx == 0xFF)\n\t\treturn;\n\n\t \n\trep_idx = ctl_idx * AR5K_EEPROM_N_EDGES;\n\n\t \n\n\t \n\tfor (i = 0; i < AR5K_EEPROM_N_EDGES; i++) {\n\t\trep_idx += i;\n\t\tif (target <= rep[rep_idx].freq)\n\t\t\tedge_pwr = (s16) rep[rep_idx].edge;\n\t}\n\n\tif (edge_pwr)\n\t\tah->ah_txpower.txp_max_pwr = 4 * min(edge_pwr, max_chan_pwr);\n}\n\n\n \n\n \n\n \nstatic void\nath5k_fill_pwr_to_pcdac_table(struct ath5k_hw *ah, s16* table_min,\n\t\t\t\t\t\t\ts16 *table_max)\n{\n\tu8\t*pcdac_out = ah->ah_txpower.txp_pd_table;\n\tu8\t*pcdac_tmp = ah->ah_txpower.tmpL[0];\n\tu8\tpcdac_0, pcdac_n, pcdac_i, pwr_idx, i;\n\ts16\tmin_pwr, max_pwr;\n\n\t \n\tmin_pwr = table_min[0];\n\tpcdac_0 = pcdac_tmp[0];\n\n\tmax_pwr = table_max[0];\n\tpcdac_n = pcdac_tmp[table_max[0] - table_min[0]];\n\n\t \n\tpcdac_i = 0;\n\tfor (i = 0; i < min_pwr; i++)\n\t\tpcdac_out[pcdac_i++] = pcdac_0;\n\n\t \n\tpwr_idx = min_pwr;\n\tfor (i = 0; pwr_idx <= max_pwr &&\n\t\t    pcdac_i < AR5K_EEPROM_POWER_TABLE_SIZE; i++) {\n\t\tpcdac_out[pcdac_i++] = pcdac_tmp[i];\n\t\tpwr_idx++;\n\t}\n\n\t \n\twhile (pcdac_i < AR5K_EEPROM_POWER_TABLE_SIZE)\n\t\tpcdac_out[pcdac_i++] = pcdac_n;\n\n}\n\n \nstatic void\nath5k_combine_linear_pcdac_curves(struct ath5k_hw *ah, s16* table_min,\n\t\t\t\t\t\ts16 *table_max, u8 pdcurves)\n{\n\tu8\t*pcdac_out = ah->ah_txpower.txp_pd_table;\n\tu8\t*pcdac_low_pwr;\n\tu8\t*pcdac_high_pwr;\n\tu8\t*pcdac_tmp;\n\tu8\tpwr;\n\ts16\tmax_pwr_idx;\n\ts16\tmin_pwr_idx;\n\ts16\tmid_pwr_idx = 0;\n\t \n\tu8\tedge_flag;\n\tint\ti;\n\n\t \n\tif (pdcurves > 1) {\n\t\tpcdac_low_pwr = ah->ah_txpower.tmpL[1];\n\t\tpcdac_high_pwr = ah->ah_txpower.tmpL[0];\n\t\tmid_pwr_idx = table_max[1] - table_min[1] - 1;\n\t\tmax_pwr_idx = (table_max[0] - table_min[0]) / 2;\n\n\t\t \n\t\tif (table_max[0] - table_min[1] > 126)\n\t\t\tmin_pwr_idx = table_max[0] - 126;\n\t\telse\n\t\t\tmin_pwr_idx = table_min[1];\n\n\t\t \n\t\tpcdac_tmp = pcdac_high_pwr;\n\n\t\tedge_flag = 0x40;\n\t} else {\n\t\tpcdac_low_pwr = ah->ah_txpower.tmpL[1];  \n\t\tpcdac_high_pwr = ah->ah_txpower.tmpL[0];\n\t\tmin_pwr_idx = table_min[0];\n\t\tmax_pwr_idx = (table_max[0] - table_min[0]) / 2;\n\t\tpcdac_tmp = pcdac_high_pwr;\n\t\tedge_flag = 0;\n\t}\n\n\t \n\tah->ah_txpower.txp_min_idx = min_pwr_idx / 2;\n\n\t \n\tpwr = max_pwr_idx;\n\tfor (i = 63; i >= 0; i--) {\n\t\t \n\t\tif (edge_flag == 0x40 &&\n\t\t(2 * pwr <= (table_max[1] - table_min[0]) || pwr == 0)) {\n\t\t\tedge_flag = 0x00;\n\t\t\tpcdac_tmp = pcdac_low_pwr;\n\t\t\tpwr = mid_pwr_idx / 2;\n\t\t}\n\n\t\t \n\t\tif (pcdac_tmp[pwr] < 1 && (edge_flag == 0x00)) {\n\t\t\twhile (i >= 0) {\n\t\t\t\tpcdac_out[i] = pcdac_out[i + 1];\n\t\t\t\ti--;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\n\t\tpcdac_out[i] = pcdac_tmp[pwr] | edge_flag;\n\n\t\t \n\t\tif (pcdac_out[i] > 126)\n\t\t\tpcdac_out[i] = 126;\n\n\t\t \n\t\tpwr--;\n\t}\n}\n\n \nstatic void\nath5k_write_pcdac_table(struct ath5k_hw *ah)\n{\n\tu8\t*pcdac_out = ah->ah_txpower.txp_pd_table;\n\tint\ti;\n\n\t \n\tfor (i = 0; i < (AR5K_EEPROM_POWER_TABLE_SIZE / 2); i++) {\n\t\tath5k_hw_reg_write(ah,\n\t\t\t(((pcdac_out[2 * i + 0] << 8 | 0xff) & 0xffff) << 0) |\n\t\t\t(((pcdac_out[2 * i + 1] << 8 | 0xff) & 0xffff) << 16),\n\t\t\tAR5K_PHY_PCDAC_TXPOWER(i));\n\t}\n}\n\n\n \n\n \n\n \nstatic void\nath5k_combine_pwr_to_pdadc_curves(struct ath5k_hw *ah,\n\t\t\ts16 *pwr_min, s16 *pwr_max, u8 pdcurves)\n{\n\tu8 gain_boundaries[AR5K_EEPROM_N_PD_GAINS];\n\tu8 *pdadc_out = ah->ah_txpower.txp_pd_table;\n\tu8 *pdadc_tmp;\n\ts16 pdadc_0;\n\tu8 pdadc_i, pdadc_n, pwr_step, pdg, max_idx, table_size;\n\tu8 pd_gain_overlap;\n\n\t \n\tpd_gain_overlap = (u8) ath5k_hw_reg_read(ah, AR5K_PHY_TPC_RG5) &\n\t\tAR5K_PHY_TPC_RG5_PD_GAIN_OVERLAP;\n\n\t \n\tfor (pdg = 0, pdadc_i = 0; pdg < pdcurves; pdg++) {\n\t\tpdadc_tmp = ah->ah_txpower.tmpL[pdg];\n\n\t\tif (pdg == pdcurves - 1)\n\t\t\t \n\t\t\tgain_boundaries[pdg] = pwr_max[pdg] + 4;\n\t\telse\n\t\t\t \n\t\t\tgain_boundaries[pdg] =\n\t\t\t\t(pwr_max[pdg] + pwr_min[pdg + 1]) / 2;\n\n\t\t \n\t\tif (gain_boundaries[pdg] > AR5K_TUNE_MAX_TXPOWER)\n\t\t\tgain_boundaries[pdg] = AR5K_TUNE_MAX_TXPOWER;\n\n\t\t \n\t\tif (pdg == 0)\n\t\t\tpdadc_0 = 0;\n\t\telse\n\t\t\t \n\t\t\tpdadc_0 = (gain_boundaries[pdg - 1] - pwr_min[pdg]) -\n\t\t\t\t\t\t\tpd_gain_overlap;\n\n\t\t \n\t\tif ((pdadc_tmp[1] - pdadc_tmp[0]) > 1)\n\t\t\tpwr_step = pdadc_tmp[1] - pdadc_tmp[0];\n\t\telse\n\t\t\tpwr_step = 1;\n\n\t\t \n\t\twhile ((pdadc_0 < 0) && (pdadc_i < 128)) {\n\t\t\ts16 tmp = pdadc_tmp[0] + pdadc_0 * pwr_step;\n\t\t\tpdadc_out[pdadc_i++] = (tmp < 0) ? 0 : (u8) tmp;\n\t\t\tpdadc_0++;\n\t\t}\n\n\t\t \n\t\tpdadc_n = gain_boundaries[pdg] + pd_gain_overlap - pwr_min[pdg];\n\t\t \n\t\ttable_size = pwr_max[pdg] - pwr_min[pdg];\n\t\tmax_idx = min(pdadc_n, table_size);\n\n\t\t \n\t\twhile (pdadc_0 < max_idx && pdadc_i < 128)\n\t\t\tpdadc_out[pdadc_i++] = pdadc_tmp[pdadc_0++];\n\n\t\t \n\t\tif (pdadc_n <= max_idx)\n\t\t\tcontinue;\n\n\t\t \n\t\tif ((pdadc_tmp[table_size - 1] - pdadc_tmp[table_size - 2]) > 1)\n\t\t\tpwr_step = pdadc_tmp[table_size - 1] -\n\t\t\t\t\t\tpdadc_tmp[table_size - 2];\n\t\telse\n\t\t\tpwr_step = 1;\n\n\t\t \n\t\twhile ((pdadc_0 < (s16) pdadc_n) &&\n\t\t(pdadc_i < AR5K_EEPROM_POWER_TABLE_SIZE * 2)) {\n\t\t\ts16 tmp = pdadc_tmp[table_size - 1] +\n\t\t\t\t\t(pdadc_0 - max_idx) * pwr_step;\n\t\t\tpdadc_out[pdadc_i++] = (tmp > 127) ? 127 : (u8) tmp;\n\t\t\tpdadc_0++;\n\t\t}\n\t}\n\n\twhile (pdg < AR5K_EEPROM_N_PD_GAINS) {\n\t\tgain_boundaries[pdg] = gain_boundaries[pdg - 1];\n\t\tpdg++;\n\t}\n\n\twhile (pdadc_i < AR5K_EEPROM_POWER_TABLE_SIZE * 2) {\n\t\tpdadc_out[pdadc_i] = pdadc_out[pdadc_i - 1];\n\t\tpdadc_i++;\n\t}\n\n\t \n\tath5k_hw_reg_write(ah,\n\t\tAR5K_REG_SM(pd_gain_overlap,\n\t\t\tAR5K_PHY_TPC_RG5_PD_GAIN_OVERLAP) |\n\t\tAR5K_REG_SM(gain_boundaries[0],\n\t\t\tAR5K_PHY_TPC_RG5_PD_GAIN_BOUNDARY_1) |\n\t\tAR5K_REG_SM(gain_boundaries[1],\n\t\t\tAR5K_PHY_TPC_RG5_PD_GAIN_BOUNDARY_2) |\n\t\tAR5K_REG_SM(gain_boundaries[2],\n\t\t\tAR5K_PHY_TPC_RG5_PD_GAIN_BOUNDARY_3) |\n\t\tAR5K_REG_SM(gain_boundaries[3],\n\t\t\tAR5K_PHY_TPC_RG5_PD_GAIN_BOUNDARY_4),\n\t\tAR5K_PHY_TPC_RG5);\n\n\t \n\tah->ah_txpower.txp_min_idx = pwr_min[0];\n\n}\n\n \nstatic void\nath5k_write_pwr_to_pdadc_table(struct ath5k_hw *ah, u8 ee_mode)\n{\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu8 *pdadc_out = ah->ah_txpower.txp_pd_table;\n\tu8 *pdg_to_idx = ee->ee_pdc_to_idx[ee_mode];\n\tu8 pdcurves = ee->ee_pd_gains[ee_mode];\n\tu32 reg;\n\tu8 i;\n\n\t \n\n\t \n\treg = ath5k_hw_reg_read(ah, AR5K_PHY_TPC_RG1);\n\treg &= ~(AR5K_PHY_TPC_RG1_PDGAIN_1 |\n\t\tAR5K_PHY_TPC_RG1_PDGAIN_2 |\n\t\tAR5K_PHY_TPC_RG1_PDGAIN_3 |\n\t\tAR5K_PHY_TPC_RG1_NUM_PD_GAIN);\n\n\t \n\treg |= AR5K_REG_SM(pdcurves, AR5K_PHY_TPC_RG1_NUM_PD_GAIN);\n\n\tswitch (pdcurves) {\n\tcase 3:\n\t\treg |= AR5K_REG_SM(pdg_to_idx[2], AR5K_PHY_TPC_RG1_PDGAIN_3);\n\t\tfallthrough;\n\tcase 2:\n\t\treg |= AR5K_REG_SM(pdg_to_idx[1], AR5K_PHY_TPC_RG1_PDGAIN_2);\n\t\tfallthrough;\n\tcase 1:\n\t\treg |= AR5K_REG_SM(pdg_to_idx[0], AR5K_PHY_TPC_RG1_PDGAIN_1);\n\t\tbreak;\n\t}\n\tath5k_hw_reg_write(ah, reg, AR5K_PHY_TPC_RG1);\n\n\t \n\tfor (i = 0; i < (AR5K_EEPROM_POWER_TABLE_SIZE / 2); i++) {\n\t\tu32 val = get_unaligned_le32(&pdadc_out[4 * i]);\n\t\tath5k_hw_reg_write(ah, val, AR5K_PHY_PDADC_TXPOWER(i));\n\t}\n}\n\n\n \n\n \nstatic int\nath5k_setup_channel_powertable(struct ath5k_hw *ah,\n\t\t\tstruct ieee80211_channel *channel,\n\t\t\tu8 ee_mode, u8 type)\n{\n\tstruct ath5k_pdgain_info *pdg_L, *pdg_R;\n\tstruct ath5k_chan_pcal_info *pcinfo_L;\n\tstruct ath5k_chan_pcal_info *pcinfo_R;\n\tstruct ath5k_eeprom_info *ee = &ah->ah_capabilities.cap_eeprom;\n\tu8 *pdg_curve_to_idx = ee->ee_pdc_to_idx[ee_mode];\n\ts16 table_min[AR5K_EEPROM_N_PD_GAINS];\n\ts16 table_max[AR5K_EEPROM_N_PD_GAINS];\n\tu8 *tmpL;\n\tu8 *tmpR;\n\tu32 target = channel->center_freq;\n\tint pdg, i;\n\n\t \n\tath5k_get_chan_pcal_surrounding_piers(ah, channel,\n\t\t\t\t\t\t&pcinfo_L,\n\t\t\t\t\t\t&pcinfo_R);\n\n\t \n\tfor (pdg = 0; pdg < ee->ee_pd_gains[ee_mode]; pdg++) {\n\n\t\t \n\t\tu8 idx = pdg_curve_to_idx[pdg];\n\n\t\t \n\t\tpdg_L = &pcinfo_L->pd_curves[idx];\n\t\tpdg_R = &pcinfo_R->pd_curves[idx];\n\n\t\t \n\t\ttmpL = ah->ah_txpower.tmpL[pdg];\n\t\ttmpR = ah->ah_txpower.tmpR[pdg];\n\n\t\t \n\t\ttable_min[pdg] = min(pdg_L->pd_pwr[0],\n\t\t\t\t\tpdg_R->pd_pwr[0]) / 2;\n\n\t\ttable_max[pdg] = max(pdg_L->pd_pwr[pdg_L->pd_points - 1],\n\t\t\t\tpdg_R->pd_pwr[pdg_R->pd_points - 1]) / 2;\n\n\t\t \n\t\tswitch (type) {\n\t\tcase AR5K_PWRTABLE_LINEAR_PCDAC:\n\t\t\t \n\t\t\ttable_min[pdg] = min(pdg_L->pd_pwr[0],\n\t\t\t\t\t\tpdg_R->pd_pwr[0]);\n\n\t\t\ttable_max[pdg] =\n\t\t\t\tmax(pdg_L->pd_pwr[pdg_L->pd_points - 1],\n\t\t\t\t\tpdg_R->pd_pwr[pdg_R->pd_points - 1]);\n\n\t\t\t \n\t\t\tif (!(ee->ee_pd_gains[ee_mode] > 1 && pdg == 0)) {\n\n\t\t\t\ttable_min[pdg] =\n\t\t\t\t\tath5k_get_linear_pcdac_min(pdg_L->pd_step,\n\t\t\t\t\t\t\t\tpdg_R->pd_step,\n\t\t\t\t\t\t\t\tpdg_L->pd_pwr,\n\t\t\t\t\t\t\t\tpdg_R->pd_pwr);\n\n\t\t\t\t \n\t\t\t\tif (table_max[pdg] - table_min[pdg] > 126)\n\t\t\t\t\ttable_min[pdg] = table_max[pdg] - 126;\n\t\t\t}\n\n\t\t\tfallthrough;\n\t\tcase AR5K_PWRTABLE_PWR_TO_PCDAC:\n\t\tcase AR5K_PWRTABLE_PWR_TO_PDADC:\n\n\t\t\tath5k_create_power_curve(table_min[pdg],\n\t\t\t\t\t\ttable_max[pdg],\n\t\t\t\t\t\tpdg_L->pd_pwr,\n\t\t\t\t\t\tpdg_L->pd_step,\n\t\t\t\t\t\tpdg_L->pd_points, tmpL, type);\n\n\t\t\t \n\t\t\tif (pcinfo_L == pcinfo_R)\n\t\t\t\tcontinue;\n\n\t\t\tath5k_create_power_curve(table_min[pdg],\n\t\t\t\t\t\ttable_max[pdg],\n\t\t\t\t\t\tpdg_R->pd_pwr,\n\t\t\t\t\t\tpdg_R->pd_step,\n\t\t\t\t\t\tpdg_R->pd_points, tmpR, type);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tfor (i = 0; (i < (u16) (table_max[pdg] - table_min[pdg])) &&\n\t\t(i < AR5K_EEPROM_POWER_TABLE_SIZE); i++) {\n\t\t\ttmpL[i] = (u8) ath5k_get_interpolated_value(target,\n\t\t\t\t\t\t\t(s16) pcinfo_L->freq,\n\t\t\t\t\t\t\t(s16) pcinfo_R->freq,\n\t\t\t\t\t\t\t(s16) tmpL[i],\n\t\t\t\t\t\t\t(s16) tmpR[i]);\n\t\t}\n\t}\n\n\t \n\n\t \n\tah->ah_txpower.txp_min_pwr = ath5k_get_interpolated_value(target,\n\t\t\t\t\t(s16) pcinfo_L->freq,\n\t\t\t\t\t(s16) pcinfo_R->freq,\n\t\t\t\t\tpcinfo_L->min_pwr, pcinfo_R->min_pwr);\n\n\tah->ah_txpower.txp_max_pwr = ath5k_get_interpolated_value(target,\n\t\t\t\t\t(s16) pcinfo_L->freq,\n\t\t\t\t\t(s16) pcinfo_R->freq,\n\t\t\t\t\tpcinfo_L->max_pwr, pcinfo_R->max_pwr);\n\n\t \n\tswitch (type) {\n\tcase AR5K_PWRTABLE_LINEAR_PCDAC:\n\t\t \n\t\tath5k_combine_linear_pcdac_curves(ah, table_min, table_max,\n\t\t\t\t\t\tee->ee_pd_gains[ee_mode]);\n\n\t\t \n\t\tah->ah_txpower.txp_offset = 64 - (table_max[0] / 2);\n\t\tbreak;\n\tcase AR5K_PWRTABLE_PWR_TO_PCDAC:\n\t\t \n\t\tath5k_fill_pwr_to_pcdac_table(ah, table_min, table_max);\n\n\t\t \n\t\tah->ah_txpower.txp_min_idx = 0;\n\t\tah->ah_txpower.txp_offset = 0;\n\t\tbreak;\n\tcase AR5K_PWRTABLE_PWR_TO_PDADC:\n\t\t \n\t\tath5k_combine_pwr_to_pdadc_curves(ah, table_min, table_max,\n\t\t\t\t\t\tee->ee_pd_gains[ee_mode]);\n\n\t\t \n\t\tah->ah_txpower.txp_offset = table_min[0];\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tah->ah_txpower.txp_setup = true;\n\n\treturn 0;\n}\n\n \nstatic void\nath5k_write_channel_powertable(struct ath5k_hw *ah, u8 ee_mode, u8 type)\n{\n\tif (type == AR5K_PWRTABLE_PWR_TO_PDADC)\n\t\tath5k_write_pwr_to_pdadc_table(ah, ee_mode);\n\telse\n\t\tath5k_write_pcdac_table(ah);\n}\n\n\n \n\n \nstatic void\nath5k_setup_rate_powertable(struct ath5k_hw *ah, u16 max_pwr,\n\t\t\tstruct ath5k_rate_pcal_info *rate_info,\n\t\t\tu8 ee_mode)\n{\n\tunsigned int i;\n\tu16 *rates;\n\ts16 rate_idx_scaled = 0;\n\n\t \n\tmax_pwr *= 2;\n\tmax_pwr = min(max_pwr, (u16) ah->ah_txpower.txp_max_pwr) / 2;\n\n\t \n\trates = ah->ah_txpower.txp_rates_power_table;\n\n\t \n\tfor (i = 0; i < 5; i++)\n\t\trates[i] = min(max_pwr, rate_info->target_power_6to24);\n\n\t \n\trates[5] = min(rates[0], rate_info->target_power_36);\n\trates[6] = min(rates[0], rate_info->target_power_48);\n\trates[7] = min(rates[0], rate_info->target_power_54);\n\n\t \n\t \n\trates[8] = min(rates[0], rate_info->target_power_6to24);\n\t \n\trates[9] = min(rates[0], rate_info->target_power_36);\n\t \n\trates[10] = min(rates[0], rate_info->target_power_36);\n\t \n\trates[11] = min(rates[0], rate_info->target_power_48);\n\t \n\trates[12] = min(rates[0], rate_info->target_power_48);\n\t \n\trates[13] = min(rates[0], rate_info->target_power_54);\n\t \n\trates[14] = min(rates[0], rate_info->target_power_54);\n\n\t \n\trates[15] = min(rates[0], rate_info->target_power_6to24);\n\n\t \n\tif ((ee_mode == AR5K_EEPROM_MODE_11G) &&\n\t(ah->ah_phy_revision < AR5K_SREV_PHY_5212A))\n\t\tfor (i = 8; i <= 15; i++)\n\t\t\trates[i] -= ah->ah_txpower.txp_cck_ofdm_gainf_delta;\n\n\t \n\tah->ah_txpower.txp_min_pwr = 2 * rates[7];\n\tah->ah_txpower.txp_cur_pwr = 2 * rates[0];\n\n\t \n\tah->ah_txpower.txp_ofdm = rates[7];\n\n\t \n\tfor (i = 0; i < 16; i++) {\n\t\trate_idx_scaled = rates[i] + ah->ah_txpower.txp_offset;\n\t\t \n\t\tif (rate_idx_scaled > 63)\n\t\t\trate_idx_scaled = 63;\n\t\tif (rate_idx_scaled < 0)\n\t\t\trate_idx_scaled = 0;\n\t\trates[i] = rate_idx_scaled;\n\t}\n}\n\n\n \nstatic int\nath5k_hw_txpower(struct ath5k_hw *ah, struct ieee80211_channel *channel,\n\t\t u8 txpower)\n{\n\tstruct ath5k_rate_pcal_info rate_info;\n\tstruct ieee80211_channel *curr_channel = ah->ah_current_channel;\n\tint ee_mode;\n\tu8 type;\n\tint ret;\n\n\tif (txpower > AR5K_TUNE_MAX_TXPOWER) {\n\t\tATH5K_ERR(ah, \"invalid tx power: %u\\n\", txpower);\n\t\treturn -EINVAL;\n\t}\n\n\tee_mode = ath5k_eeprom_mode_from_channel(ah, channel);\n\n\t \n\tswitch (ah->ah_radio) {\n\tcase AR5K_RF5110:\n\t\t \n\t\treturn 0;\n\tcase AR5K_RF5111:\n\t\ttype = AR5K_PWRTABLE_PWR_TO_PCDAC;\n\t\tbreak;\n\tcase AR5K_RF5112:\n\t\ttype = AR5K_PWRTABLE_LINEAR_PCDAC;\n\t\tbreak;\n\tcase AR5K_RF2413:\n\tcase AR5K_RF5413:\n\tcase AR5K_RF2316:\n\tcase AR5K_RF2317:\n\tcase AR5K_RF2425:\n\t\ttype = AR5K_PWRTABLE_PWR_TO_PDADC;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (!ah->ah_txpower.txp_setup ||\n\t    (channel->hw_value != curr_channel->hw_value) ||\n\t    (channel->center_freq != curr_channel->center_freq)) {\n\t\t \n\t\tint requested_txpower = ah->ah_txpower.txp_requested;\n\n\t\tmemset(&ah->ah_txpower, 0, sizeof(ah->ah_txpower));\n\n\t\t \n\t\tah->ah_txpower.txp_tpc = AR5K_TUNE_TPC_TXPOWER;\n\n\t\tah->ah_txpower.txp_requested = requested_txpower;\n\n\t\t \n\t\tret = ath5k_setup_channel_powertable(ah, channel,\n\t\t\t\t\t\t\tee_mode, type);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\tath5k_write_channel_powertable(ah, ee_mode, type);\n\n\t \n\tath5k_get_max_ctl_power(ah, channel);\n\n\t \n\n\t \n\n\t \n\n\t \n\tath5k_get_rate_pcal_data(ah, channel, &rate_info);\n\n\t \n\tath5k_setup_rate_powertable(ah, txpower, &rate_info, ee_mode);\n\n\t \n\tath5k_hw_reg_write(ah, AR5K_TXPOWER_OFDM(3, 24) |\n\t\tAR5K_TXPOWER_OFDM(2, 16) | AR5K_TXPOWER_OFDM(1, 8) |\n\t\tAR5K_TXPOWER_OFDM(0, 0), AR5K_PHY_TXPOWER_RATE1);\n\n\tath5k_hw_reg_write(ah, AR5K_TXPOWER_OFDM(7, 24) |\n\t\tAR5K_TXPOWER_OFDM(6, 16) | AR5K_TXPOWER_OFDM(5, 8) |\n\t\tAR5K_TXPOWER_OFDM(4, 0), AR5K_PHY_TXPOWER_RATE2);\n\n\tath5k_hw_reg_write(ah, AR5K_TXPOWER_CCK(10, 24) |\n\t\tAR5K_TXPOWER_CCK(9, 16) | AR5K_TXPOWER_CCK(15, 8) |\n\t\tAR5K_TXPOWER_CCK(8, 0), AR5K_PHY_TXPOWER_RATE3);\n\n\tath5k_hw_reg_write(ah, AR5K_TXPOWER_CCK(14, 24) |\n\t\tAR5K_TXPOWER_CCK(13, 16) | AR5K_TXPOWER_CCK(12, 8) |\n\t\tAR5K_TXPOWER_CCK(11, 0), AR5K_PHY_TXPOWER_RATE4);\n\n\t \n\tif (ah->ah_txpower.txp_tpc) {\n\t\tath5k_hw_reg_write(ah, AR5K_PHY_TXPOWER_RATE_MAX_TPC_ENABLE |\n\t\t\tAR5K_TUNE_MAX_TXPOWER, AR5K_PHY_TXPOWER_RATE_MAX);\n\n\t\tath5k_hw_reg_write(ah,\n\t\t\tAR5K_REG_MS(AR5K_TUNE_MAX_TXPOWER, AR5K_TPC_ACK) |\n\t\t\tAR5K_REG_MS(AR5K_TUNE_MAX_TXPOWER, AR5K_TPC_CTS) |\n\t\t\tAR5K_REG_MS(AR5K_TUNE_MAX_TXPOWER, AR5K_TPC_CHIRP),\n\t\t\tAR5K_TPC);\n\t} else {\n\t\tath5k_hw_reg_write(ah, AR5K_TUNE_MAX_TXPOWER,\n\t\t\tAR5K_PHY_TXPOWER_RATE_MAX);\n\t}\n\n\treturn 0;\n}\n\n \nint\nath5k_hw_set_txpower_limit(struct ath5k_hw *ah, u8 txpower)\n{\n\tATH5K_DBG(ah, ATH5K_DEBUG_TXPOWER,\n\t\t\"changing txpower to %d\\n\", txpower);\n\n\treturn ath5k_hw_txpower(ah, ah->ah_current_channel, txpower);\n}\n\n\n \n\n \nint\nath5k_hw_phy_init(struct ath5k_hw *ah, struct ieee80211_channel *channel,\n\t\t      u8 mode, bool fast)\n{\n\tstruct ieee80211_channel *curr_channel;\n\tint ret, i;\n\tu32 phy_tst1;\n\tret = 0;\n\n\t \n\tcurr_channel = ah->ah_current_channel;\n\tif (fast && (channel->hw_value != curr_channel->hw_value))\n\t\treturn -EINVAL;\n\n\t \n\tif (fast) {\n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_RFBUS_REQ,\n\t\t\t\t    AR5K_PHY_RFBUS_REQ_REQUEST);\n\t\tfor (i = 0; i < 100; i++) {\n\t\t\tif (ath5k_hw_reg_read(ah, AR5K_PHY_RFBUS_GRANT))\n\t\t\t\tbreak;\n\t\t\tudelay(5);\n\t\t}\n\t\t \n\t\tif (i >= 100)\n\t\t\treturn -EIO;\n\n\t\t \n\t\tret = ath5k_hw_channel(ah, channel);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tath5k_hw_wait_for_synth(ah, channel);\n\t}\n\n\t \n\tret = ath5k_hw_txpower(ah, channel, ah->ah_txpower.txp_requested ?\n\t\t\t\t\tah->ah_txpower.txp_requested * 2 :\n\t\t\t\t\tAR5K_TUNE_MAX_TXPOWER);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (ah->ah_version == AR5K_AR5212 &&\n\t\tchannel->hw_value != AR5K_MODE_11B) {\n\n\t\tret = ath5k_hw_write_ofdm_timings(ah, channel);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tif (ah->ah_mac_srev >= AR5K_SREV_AR5424)\n\t\t\tath5k_hw_set_spur_mitigation_filter(ah,\n\t\t\t\t\t\t\t    channel);\n\t}\n\n\t \n\tif (fast) {\n\t\t \n\t\tAR5K_REG_DISABLE_BITS(ah, AR5K_PHY_RFBUS_REQ,\n\t\t\t\t    AR5K_PHY_RFBUS_REQ_REQUEST);\n\n\t\t \n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_AGCCTL,\n\t\t\t\t\tAR5K_PHY_AGCCTL_NF);\n\n\t\treturn ret;\n\t}\n\n\t \n\tif (ah->ah_version != AR5K_AR5210) {\n\n\t\t \n\t\tret = ath5k_hw_rfgain_init(ah, channel->band);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tusleep_range(1000, 1500);\n\n\t\t \n\t\tret = ath5k_hw_rfregs_init(ah, channel, mode);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tif (ah->ah_radio == AR5K_RF5111) {\n\t\t\tif (mode == AR5K_MODE_11B)\n\t\t\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_TXCFG,\n\t\t\t\t    AR5K_TXCFG_B_MODE);\n\t\t\telse\n\t\t\t\tAR5K_REG_DISABLE_BITS(ah, AR5K_TXCFG,\n\t\t\t\t    AR5K_TXCFG_B_MODE);\n\t\t}\n\n\t} else if (ah->ah_version == AR5K_AR5210) {\n\t\tusleep_range(1000, 1500);\n\t\t \n\t\tath5k_hw_reg_write(ah, AR5K_PHY_ACT_DISABLE, AR5K_PHY_ACT);\n\t\tusleep_range(1000, 1500);\n\t}\n\n\t \n\tret = ath5k_hw_channel(ah, channel);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tath5k_hw_reg_write(ah, AR5K_PHY_ACT_ENABLE, AR5K_PHY_ACT);\n\n\tath5k_hw_wait_for_synth(ah, channel);\n\n\t \n\tphy_tst1 = ath5k_hw_reg_read(ah, AR5K_PHY_TST1);\n\tath5k_hw_reg_write(ah, AR5K_PHY_TST1_TXHOLD, AR5K_PHY_TST1);\n\tfor (i = 0; i <= 20; i++) {\n\t\tif (!(ath5k_hw_reg_read(ah, AR5K_PHY_ADC_TEST) & 0x10))\n\t\t\tbreak;\n\t\tusleep_range(200, 250);\n\t}\n\tath5k_hw_reg_write(ah, phy_tst1, AR5K_PHY_TST1);\n\n\t \n\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_AGCCTL,\n\t\t\t\tAR5K_PHY_AGCCTL_CAL | AR5K_PHY_AGCCTL_NF);\n\n\t \n\tah->ah_iq_cal_needed = false;\n\tif (!(mode == AR5K_MODE_11B)) {\n\t\tah->ah_iq_cal_needed = true;\n\t\tAR5K_REG_WRITE_BITS(ah, AR5K_PHY_IQ,\n\t\t\t\tAR5K_PHY_IQ_CAL_NUM_LOG_MAX, 15);\n\t\tAR5K_REG_ENABLE_BITS(ah, AR5K_PHY_IQ,\n\t\t\t\tAR5K_PHY_IQ_RUN);\n\t}\n\n\t \n\tif (ath5k_hw_register_timeout(ah, AR5K_PHY_AGCCTL,\n\t\t\tAR5K_PHY_AGCCTL_CAL, 0, false)) {\n\t\tATH5K_ERR(ah, \"gain calibration timeout (%uMHz)\\n\",\n\t\t\tchannel->center_freq);\n\t}\n\n\t \n\tath5k_hw_set_antenna_mode(ah, ah->ah_ant_mode);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}