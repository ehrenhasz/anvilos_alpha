{
  "module_name": "dfs_debug.c",
  "hash_id": "c07303f32f4f5a98395821e7a6fb80b488f92ff317ed332642959d3767966176",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/dfs_debug.c",
  "human_readable_source": " \n\n#include <linux/debugfs.h>\n#include <linux/export.h>\n\n#include \"ath9k.h\"\n#include \"dfs_debug.h\"\n#include \"../dfs_pattern_detector.h\"\n\nstatic struct ath_dfs_pool_stats dfs_pool_stats = { 0 };\n\n#define ATH9K_DFS_STAT(s, p) \\\n\tlen += scnprintf(buf + len, size - len, \"%28s : %10u\\n\", s, \\\n\t\t\t sc->debug.stats.dfs_stats.p)\n#define ATH9K_DFS_POOL_STAT(s, p) \\\n\tlen += scnprintf(buf + len, size - len, \"%28s : %10u\\n\", s, \\\n\t\t\t dfs_pool_stats.p);\n\nstatic ssize_t read_file_dfs(struct file *file, char __user *user_buf,\n\t\t\t     size_t count, loff_t *ppos)\n{\n\tstruct ath_softc *sc = file->private_data;\n\tstruct ath9k_hw_version *hw_ver = &sc->sc_ah->hw_version;\n\tchar *buf;\n\tunsigned int len = 0, size = 8000;\n\tssize_t retval = 0;\n\n\tbuf = kzalloc(size, GFP_KERNEL);\n\tif (buf == NULL)\n\t\treturn -ENOMEM;\n\n\tlen += scnprintf(buf + len, size - len, \"DFS support for \"\n\t\t\t \"macVersion = 0x%x, macRev = 0x%x: %s\\n\",\n\t\t\t hw_ver->macVersion, hw_ver->macRev,\n\t\t\t (sc->sc_ah->caps.hw_caps & ATH9K_HW_CAP_DFS) ?\n\t\t\t\t\t\"enabled\" : \"disabled\");\n\n\tif (!sc->dfs_detector) {\n\t\tlen += scnprintf(buf + len, size - len,\n\t\t\t\t \"DFS detector not enabled\\n\");\n\t\tgoto exit;\n\t}\n\n\tdfs_pool_stats = sc->dfs_detector->get_stats(sc->dfs_detector);\n\n\tlen += scnprintf(buf + len, size - len, \"Pulse detector statistics:\\n\");\n\tATH9K_DFS_STAT(\"pulse events reported   \", pulses_total);\n\tATH9K_DFS_STAT(\"invalid pulse events    \", pulses_no_dfs);\n\tATH9K_DFS_STAT(\"DFS pulses detected     \", pulses_detected);\n\tATH9K_DFS_STAT(\"Datalen discards        \", datalen_discards);\n\tATH9K_DFS_STAT(\"RSSI discards           \", rssi_discards);\n\tATH9K_DFS_STAT(\"BW info discards        \", bwinfo_discards);\n\tATH9K_DFS_STAT(\"Primary channel pulses  \", pri_phy_errors);\n\tATH9K_DFS_STAT(\"Secondary channel pulses\", ext_phy_errors);\n\tATH9K_DFS_STAT(\"Dual channel pulses     \", dc_phy_errors);\n\tlen += scnprintf(buf + len, size - len, \"Radar detector statistics \"\n\t\t\t \"(current DFS region: %d)\\n\",\n\t\t\t sc->dfs_detector->region);\n\tATH9K_DFS_STAT(\"Pulse events processed  \", pulses_processed);\n\tATH9K_DFS_STAT(\"Radars detected         \", radar_detected);\n\tlen += scnprintf(buf + len, size - len, \"Global Pool statistics:\\n\");\n\tATH9K_DFS_POOL_STAT(\"Pool references         \", pool_reference);\n\tATH9K_DFS_POOL_STAT(\"Pulses allocated        \", pulse_allocated);\n\tATH9K_DFS_POOL_STAT(\"Pulses alloc error      \", pulse_alloc_error);\n\tATH9K_DFS_POOL_STAT(\"Pulses in use           \", pulse_used);\n\tATH9K_DFS_POOL_STAT(\"Seqs. allocated         \", pseq_allocated);\n\tATH9K_DFS_POOL_STAT(\"Seqs. alloc error       \", pseq_alloc_error);\n\tATH9K_DFS_POOL_STAT(\"Seqs. in use            \", pseq_used);\n\nexit:\n\tif (len > size)\n\t\tlen = size;\n\n\tretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\n\tkfree(buf);\n\n\treturn retval;\n}\n\n \n#define DFS_STATS_RESET_MAGIC\t0x80000000\nstatic ssize_t write_file_dfs(struct file *file, const char __user *user_buf,\n\t\t\t      size_t count, loff_t *ppos)\n{\n\tstruct ath_softc *sc = file->private_data;\n\tunsigned long val;\n\tssize_t ret;\n\n\tret = kstrtoul_from_user(user_buf, count, 0, &val);\n\tif (ret)\n\t\treturn ret;\n\tif (val == DFS_STATS_RESET_MAGIC)\n\t\tmemset(&sc->debug.stats.dfs_stats, 0,\n\t\t       sizeof(sc->debug.stats.dfs_stats));\n\treturn count;\n}\n\nstatic ssize_t write_file_simulate_radar(struct file *file,\n\t\t\t\t\t const char __user *user_buf,\n\t\t\t\t\t size_t count, loff_t *ppos)\n{\n\tstruct ath_softc *sc = file->private_data;\n\n\tieee80211_radar_detected(sc->hw);\n\n\treturn count;\n}\n\nstatic const struct file_operations fops_simulate_radar = {\n\t.write = write_file_simulate_radar,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\nstatic const struct file_operations fops_dfs_stats = {\n\t.read = read_file_dfs,\n\t.write = write_file_dfs,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\nvoid ath9k_dfs_init_debug(struct ath_softc *sc)\n{\n\tdebugfs_create_file(\"dfs_stats\", 0400,\n\t\t\t    sc->debug.debugfs_phy, sc, &fops_dfs_stats);\n\tdebugfs_create_file(\"dfs_simulate_radar\", 0200,\n\t\t\t    sc->debug.debugfs_phy, sc, &fops_simulate_radar);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}