{
  "module_name": "ar5008_phy.c",
  "hash_id": "85d4524a55fd3dfece34693e498f7a2678d140dfa2a890cf49401af5fa04cd87",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/ar5008_phy.c",
  "human_readable_source": " \n\n#include \"hw.h\"\n#include \"hw-ops.h\"\n#include \"../regd.h\"\n#include \"ar9002_phy.h\"\n\n \n\n#define AR5008_OFDM_RATES\t\t8\n#define AR5008_HT_SS_RATES\t\t8\n#define AR5008_HT_DS_RATES\t\t8\n\n#define AR5008_HT20_SHIFT\t\t16\n#define AR5008_HT40_SHIFT\t\t24\n\n#define AR5008_11NA_OFDM_SHIFT\t\t0\n#define AR5008_11NA_HT_SS_SHIFT\t\t8\n#define AR5008_11NA_HT_DS_SHIFT\t\t16\n\n#define AR5008_11NG_OFDM_SHIFT\t\t4\n#define AR5008_11NG_HT_SS_SHIFT\t\t12\n#define AR5008_11NG_HT_DS_SHIFT\t\t20\n\n \nstatic const int m1ThreshLow_off = 127;\nstatic const int m2ThreshLow_off = 127;\nstatic const int m1Thresh_off = 127;\nstatic const int m2Thresh_off = 127;\nstatic const int m2CountThr_off =  31;\nstatic const int m2CountThrLow_off =  63;\nstatic const int m1ThreshLowExt_off = 127;\nstatic const int m2ThreshLowExt_off = 127;\nstatic const int m1ThreshExt_off = 127;\nstatic const int m2ThreshExt_off = 127;\n\nstatic const u32 ar5416Bank0[][2] = {\n\t \n\t{0x000098b0, 0x1e5795e5},\n\t{0x000098e0, 0x02008020},\n};\n\nstatic const u32 ar5416Bank1[][2] = {\n\t \n\t{0x000098b0, 0x02108421},\n\t{0x000098ec, 0x00000008},\n};\n\nstatic const u32 ar5416Bank2[][2] = {\n\t \n\t{0x000098b0, 0x0e73ff17},\n\t{0x000098e0, 0x00000420},\n};\n\nstatic const u32 ar5416Bank3[][3] = {\n\t \n\t{0x000098f0, 0x01400018, 0x01c00018},\n};\n\nstatic const u32 ar5416Bank7[][2] = {\n\t \n\t{0x0000989c, 0x00000500},\n\t{0x0000989c, 0x00000800},\n\t{0x000098cc, 0x0000000e},\n};\n\nstatic const struct ar5416IniArray bank0 = STATIC_INI_ARRAY(ar5416Bank0);\nstatic const struct ar5416IniArray bank1 = STATIC_INI_ARRAY(ar5416Bank1);\nstatic const struct ar5416IniArray bank2 = STATIC_INI_ARRAY(ar5416Bank2);\nstatic const struct ar5416IniArray bank3 = STATIC_INI_ARRAY(ar5416Bank3);\nstatic const struct ar5416IniArray bank7 = STATIC_INI_ARRAY(ar5416Bank7);\n\nstatic void ar5008_write_bank6(struct ath_hw *ah, unsigned int *writecnt)\n{\n\tstruct ar5416IniArray *array = &ah->iniBank6;\n\tu32 *data = ah->analogBank6Data;\n\tint r;\n\n\tENABLE_REGWRITE_BUFFER(ah);\n\n\tfor (r = 0; r < array->ia_rows; r++) {\n\t\tREG_WRITE(ah, INI_RA(array, r, 0), data[r]);\n\t\tDO_DELAY(*writecnt);\n\t}\n\n\tREGWRITE_BUFFER_FLUSH(ah);\n}\n\n \nstatic void ar5008_hw_phy_modify_rx_buffer(u32 *rfBuf, u32 reg32,\n\t\t\t\t\t   u32 numBits, u32 firstBit,\n\t\t\t\t\t   u32 column)\n{\n\tu32 tmp32, mask, arrayEntry, lastBit;\n\tint32_t bitPosition, bitsLeft;\n\n\ttmp32 = ath9k_hw_reverse_bits(reg32, numBits);\n\tarrayEntry = (firstBit - 1) / 8;\n\tbitPosition = (firstBit - 1) % 8;\n\tbitsLeft = numBits;\n\twhile (bitsLeft > 0) {\n\t\tlastBit = (bitPosition + bitsLeft > 8) ?\n\t\t    8 : bitPosition + bitsLeft;\n\t\tmask = (((1 << lastBit) - 1) ^ ((1 << bitPosition) - 1)) <<\n\t\t    (column * 8);\n\t\trfBuf[arrayEntry] &= ~mask;\n\t\trfBuf[arrayEntry] |= ((tmp32 << bitPosition) <<\n\t\t\t\t      (column * 8)) & mask;\n\t\tbitsLeft -= 8 - bitPosition;\n\t\ttmp32 = tmp32 >> (8 - bitPosition);\n\t\tbitPosition = 0;\n\t\tarrayEntry++;\n\t}\n}\n\n \nstatic void ar5008_hw_force_bias(struct ath_hw *ah, u16 synth_freq)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tu32 tmp_reg;\n\tint reg_writes = 0;\n\tu32 new_bias = 0;\n\n\tif (!AR_SREV_5416(ah) || synth_freq >= 3000)\n\t\treturn;\n\n\tBUG_ON(AR_SREV_9280_20_OR_LATER(ah));\n\n\tif (synth_freq < 2412)\n\t\tnew_bias = 0;\n\telse if (synth_freq < 2422)\n\t\tnew_bias = 1;\n\telse\n\t\tnew_bias = 2;\n\n\t \n\ttmp_reg = ath9k_hw_reverse_bits(new_bias, 3);\n\n\tath_dbg(common, CONFIG, \"Force rf_pwd_icsyndiv to %1d on %4d\\n\",\n\t\tnew_bias, synth_freq);\n\n\t \n\tar5008_hw_phy_modify_rx_buffer(ah->analogBank6Data, tmp_reg, 3, 181, 3);\n\n\t \n\tar5008_write_bank6(ah, &reg_writes);\n}\n\n \nstatic int ar5008_hw_set_channel(struct ath_hw *ah, struct ath9k_channel *chan)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tu32 channelSel = 0;\n\tu32 bModeSynth = 0;\n\tu32 aModeRefSel = 0;\n\tu32 reg32 = 0;\n\tu16 freq;\n\tstruct chan_centers centers;\n\n\tath9k_hw_get_channel_centers(ah, chan, &centers);\n\tfreq = centers.synth_center;\n\n\tif (freq < 4800) {\n\t\tu32 txctl;\n\n\t\tif (((freq - 2192) % 5) == 0) {\n\t\t\tchannelSel = ((freq - 672) * 2 - 3040) / 10;\n\t\t\tbModeSynth = 0;\n\t\t} else if (((freq - 2224) % 5) == 0) {\n\t\t\tchannelSel = ((freq - 704) * 2 - 3040) / 10;\n\t\t\tbModeSynth = 1;\n\t\t} else {\n\t\t\tath_err(common, \"Invalid channel %u MHz\\n\", freq);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tchannelSel = (channelSel << 2) & 0xff;\n\t\tchannelSel = ath9k_hw_reverse_bits(channelSel, 8);\n\n\t\ttxctl = REG_READ(ah, AR_PHY_CCK_TX_CTRL);\n\t\tif (freq == 2484) {\n\n\t\t\tREG_WRITE(ah, AR_PHY_CCK_TX_CTRL,\n\t\t\t\t  txctl | AR_PHY_CCK_TX_CTRL_JAPAN);\n\t\t} else {\n\t\t\tREG_WRITE(ah, AR_PHY_CCK_TX_CTRL,\n\t\t\t\t  txctl & ~AR_PHY_CCK_TX_CTRL_JAPAN);\n\t\t}\n\n\t} else if ((freq % 20) == 0 && freq >= 5120) {\n\t\tchannelSel =\n\t\t    ath9k_hw_reverse_bits(((freq - 4800) / 20 << 2), 8);\n\t\taModeRefSel = ath9k_hw_reverse_bits(1, 2);\n\t} else if ((freq % 10) == 0) {\n\t\tchannelSel =\n\t\t    ath9k_hw_reverse_bits(((freq - 4800) / 10 << 1), 8);\n\t\tif (AR_SREV_9100(ah) || AR_SREV_9160_10_OR_LATER(ah))\n\t\t\taModeRefSel = ath9k_hw_reverse_bits(2, 2);\n\t\telse\n\t\t\taModeRefSel = ath9k_hw_reverse_bits(1, 2);\n\t} else if ((freq % 5) == 0) {\n\t\tchannelSel = ath9k_hw_reverse_bits((freq - 4800) / 5, 8);\n\t\taModeRefSel = ath9k_hw_reverse_bits(1, 2);\n\t} else {\n\t\tath_err(common, \"Invalid channel %u MHz\\n\", freq);\n\t\treturn -EINVAL;\n\t}\n\n\tar5008_hw_force_bias(ah, freq);\n\n\treg32 =\n\t    (channelSel << 8) | (aModeRefSel << 2) | (bModeSynth << 1) |\n\t    (1 << 5) | 0x1;\n\n\tREG_WRITE(ah, AR_PHY(0x37), reg32);\n\n\tah->curchan = chan;\n\n\treturn 0;\n}\n\nvoid ar5008_hw_cmn_spur_mitigate(struct ath_hw *ah,\n\t\t\t  struct ath9k_channel *chan, int bin)\n{\n\tint cur_bin;\n\tint upper, lower, cur_vit_mask;\n\tint i;\n\tint8_t mask_m[123] = {0};\n\tint8_t mask_p[123] = {0};\n\tint8_t mask_amt;\n\tint tmp_mask;\n\tstatic const int pilot_mask_reg[4] = {\n\t\tAR_PHY_TIMING7, AR_PHY_TIMING8,\n\t\tAR_PHY_PILOT_MASK_01_30, AR_PHY_PILOT_MASK_31_60\n\t};\n\tstatic const int chan_mask_reg[4] = {\n\t\tAR_PHY_TIMING9, AR_PHY_TIMING10,\n\t\tAR_PHY_CHANNEL_MASK_01_30, AR_PHY_CHANNEL_MASK_31_60\n\t};\n\tstatic const int inc[4] = { 0, 100, 0, 0 };\n\n\tcur_bin = -6000;\n\tupper = bin + 100;\n\tlower = bin - 100;\n\n\tfor (i = 0; i < 4; i++) {\n\t\tint pilot_mask = 0;\n\t\tint chan_mask = 0;\n\t\tint bp = 0;\n\n\t\tfor (bp = 0; bp < 30; bp++) {\n\t\t\tif ((cur_bin > lower) && (cur_bin < upper)) {\n\t\t\t\tpilot_mask = pilot_mask | 0x1 << bp;\n\t\t\t\tchan_mask = chan_mask | 0x1 << bp;\n\t\t\t}\n\t\t\tcur_bin += 100;\n\t\t}\n\t\tcur_bin += inc[i];\n\t\tREG_WRITE(ah, pilot_mask_reg[i], pilot_mask);\n\t\tREG_WRITE(ah, chan_mask_reg[i], chan_mask);\n\t}\n\n\tcur_vit_mask = 6100;\n\tupper = bin + 120;\n\tlower = bin - 120;\n\n\tfor (i = 0; i < ARRAY_SIZE(mask_m); i++) {\n\t\tif ((cur_vit_mask > lower) && (cur_vit_mask < upper)) {\n\t\t\t \n\t\t\tvolatile int tmp_v = abs(cur_vit_mask - bin);\n\n\t\t\tif (tmp_v < 75)\n\t\t\t\tmask_amt = 1;\n\t\t\telse\n\t\t\t\tmask_amt = 0;\n\t\t\tif (cur_vit_mask < 0)\n\t\t\t\tmask_m[abs(cur_vit_mask / 100)] = mask_amt;\n\t\t\telse\n\t\t\t\tmask_p[cur_vit_mask / 100] = mask_amt;\n\t\t}\n\t\tcur_vit_mask -= 100;\n\t}\n\n\ttmp_mask = (mask_m[46] << 30) | (mask_m[47] << 28)\n\t\t| (mask_m[48] << 26) | (mask_m[49] << 24)\n\t\t| (mask_m[50] << 22) | (mask_m[51] << 20)\n\t\t| (mask_m[52] << 18) | (mask_m[53] << 16)\n\t\t| (mask_m[54] << 14) | (mask_m[55] << 12)\n\t\t| (mask_m[56] << 10) | (mask_m[57] << 8)\n\t\t| (mask_m[58] << 6) | (mask_m[59] << 4)\n\t\t| (mask_m[60] << 2) | (mask_m[61] << 0);\n\tREG_WRITE(ah, AR_PHY_BIN_MASK_1, tmp_mask);\n\tREG_WRITE(ah, AR_PHY_VIT_MASK2_M_46_61, tmp_mask);\n\n\ttmp_mask = (mask_m[31] << 28)\n\t\t| (mask_m[32] << 26) | (mask_m[33] << 24)\n\t\t| (mask_m[34] << 22) | (mask_m[35] << 20)\n\t\t| (mask_m[36] << 18) | (mask_m[37] << 16)\n\t\t| (mask_m[48] << 14) | (mask_m[39] << 12)\n\t\t| (mask_m[40] << 10) | (mask_m[41] << 8)\n\t\t| (mask_m[42] << 6) | (mask_m[43] << 4)\n\t\t| (mask_m[44] << 2) | (mask_m[45] << 0);\n\tREG_WRITE(ah, AR_PHY_BIN_MASK_2, tmp_mask);\n\tREG_WRITE(ah, AR_PHY_MASK2_M_31_45, tmp_mask);\n\n\ttmp_mask = (mask_m[16] << 30) | (mask_m[16] << 28)\n\t\t| (mask_m[18] << 26) | (mask_m[18] << 24)\n\t\t| (mask_m[20] << 22) | (mask_m[20] << 20)\n\t\t| (mask_m[22] << 18) | (mask_m[22] << 16)\n\t\t| (mask_m[24] << 14) | (mask_m[24] << 12)\n\t\t| (mask_m[25] << 10) | (mask_m[26] << 8)\n\t\t| (mask_m[27] << 6) | (mask_m[28] << 4)\n\t\t| (mask_m[29] << 2) | (mask_m[30] << 0);\n\tREG_WRITE(ah, AR_PHY_BIN_MASK_3, tmp_mask);\n\tREG_WRITE(ah, AR_PHY_MASK2_M_16_30, tmp_mask);\n\n\ttmp_mask = (mask_m[0] << 30) | (mask_m[1] << 28)\n\t\t| (mask_m[2] << 26) | (mask_m[3] << 24)\n\t\t| (mask_m[4] << 22) | (mask_m[5] << 20)\n\t\t| (mask_m[6] << 18) | (mask_m[7] << 16)\n\t\t| (mask_m[8] << 14) | (mask_m[9] << 12)\n\t\t| (mask_m[10] << 10) | (mask_m[11] << 8)\n\t\t| (mask_m[12] << 6) | (mask_m[13] << 4)\n\t\t| (mask_m[14] << 2) | (mask_m[15] << 0);\n\tREG_WRITE(ah, AR_PHY_MASK_CTL, tmp_mask);\n\tREG_WRITE(ah, AR_PHY_MASK2_M_00_15, tmp_mask);\n\n\ttmp_mask = (mask_p[15] << 28)\n\t\t| (mask_p[14] << 26) | (mask_p[13] << 24)\n\t\t| (mask_p[12] << 22) | (mask_p[11] << 20)\n\t\t| (mask_p[10] << 18) | (mask_p[9] << 16)\n\t\t| (mask_p[8] << 14) | (mask_p[7] << 12)\n\t\t| (mask_p[6] << 10) | (mask_p[5] << 8)\n\t\t| (mask_p[4] << 6) | (mask_p[3] << 4)\n\t\t| (mask_p[2] << 2) | (mask_p[1] << 0);\n\tREG_WRITE(ah, AR_PHY_BIN_MASK2_1, tmp_mask);\n\tREG_WRITE(ah, AR_PHY_MASK2_P_15_01, tmp_mask);\n\n\ttmp_mask = (mask_p[30] << 28)\n\t\t| (mask_p[29] << 26) | (mask_p[28] << 24)\n\t\t| (mask_p[27] << 22) | (mask_p[26] << 20)\n\t\t| (mask_p[25] << 18) | (mask_p[24] << 16)\n\t\t| (mask_p[23] << 14) | (mask_p[22] << 12)\n\t\t| (mask_p[21] << 10) | (mask_p[20] << 8)\n\t\t| (mask_p[19] << 6) | (mask_p[18] << 4)\n\t\t| (mask_p[17] << 2) | (mask_p[16] << 0);\n\tREG_WRITE(ah, AR_PHY_BIN_MASK2_2, tmp_mask);\n\tREG_WRITE(ah, AR_PHY_MASK2_P_30_16, tmp_mask);\n\n\ttmp_mask = (mask_p[45] << 28)\n\t\t| (mask_p[44] << 26) | (mask_p[43] << 24)\n\t\t| (mask_p[42] << 22) | (mask_p[41] << 20)\n\t\t| (mask_p[40] << 18) | (mask_p[39] << 16)\n\t\t| (mask_p[38] << 14) | (mask_p[37] << 12)\n\t\t| (mask_p[36] << 10) | (mask_p[35] << 8)\n\t\t| (mask_p[34] << 6) | (mask_p[33] << 4)\n\t\t| (mask_p[32] << 2) | (mask_p[31] << 0);\n\tREG_WRITE(ah, AR_PHY_BIN_MASK2_3, tmp_mask);\n\tREG_WRITE(ah, AR_PHY_MASK2_P_45_31, tmp_mask);\n\n\ttmp_mask = (mask_p[61] << 30) | (mask_p[60] << 28)\n\t\t| (mask_p[59] << 26) | (mask_p[58] << 24)\n\t\t| (mask_p[57] << 22) | (mask_p[56] << 20)\n\t\t| (mask_p[55] << 18) | (mask_p[54] << 16)\n\t\t| (mask_p[53] << 14) | (mask_p[52] << 12)\n\t\t| (mask_p[51] << 10) | (mask_p[50] << 8)\n\t\t| (mask_p[49] << 6) | (mask_p[48] << 4)\n\t\t| (mask_p[47] << 2) | (mask_p[46] << 0);\n\tREG_WRITE(ah, AR_PHY_BIN_MASK2_4, tmp_mask);\n\tREG_WRITE(ah, AR_PHY_MASK2_P_61_45, tmp_mask);\n}\n\n \nstatic void ar5008_hw_spur_mitigate(struct ath_hw *ah,\n\t\t\t\t    struct ath9k_channel *chan)\n{\n\tint bb_spur = AR_NO_SPUR;\n\tint bin;\n\tint spur_freq_sd;\n\tint spur_delta_phase;\n\tint denominator;\n\tint tmp, new;\n\tint i;\n\n\tint cur_bb_spur;\n\tbool is2GHz = IS_CHAN_2GHZ(chan);\n\n\tfor (i = 0; i < AR_EEPROM_MODAL_SPURS; i++) {\n\t\tcur_bb_spur = ah->eep_ops->get_spur_channel(ah, i, is2GHz);\n\t\tif (AR_NO_SPUR == cur_bb_spur)\n\t\t\tbreak;\n\t\tcur_bb_spur = cur_bb_spur - (chan->channel * 10);\n\t\tif ((cur_bb_spur > -95) && (cur_bb_spur < 95)) {\n\t\t\tbb_spur = cur_bb_spur;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (AR_NO_SPUR == bb_spur)\n\t\treturn;\n\n\tbin = bb_spur * 32;\n\n\ttmp = REG_READ(ah, AR_PHY_TIMING_CTRL4(0));\n\tnew = tmp | (AR_PHY_TIMING_CTRL4_ENABLE_SPUR_RSSI |\n\t\t     AR_PHY_TIMING_CTRL4_ENABLE_SPUR_FILTER |\n\t\t     AR_PHY_TIMING_CTRL4_ENABLE_CHAN_MASK |\n\t\t     AR_PHY_TIMING_CTRL4_ENABLE_PILOT_MASK);\n\n\tREG_WRITE(ah, AR_PHY_TIMING_CTRL4(0), new);\n\n\tnew = (AR_PHY_SPUR_REG_MASK_RATE_CNTL |\n\t       AR_PHY_SPUR_REG_ENABLE_MASK_PPM |\n\t       AR_PHY_SPUR_REG_MASK_RATE_SELECT |\n\t       AR_PHY_SPUR_REG_ENABLE_VIT_SPUR_RSSI |\n\t       SM(SPUR_RSSI_THRESH, AR_PHY_SPUR_REG_SPUR_RSSI_THRESH));\n\tREG_WRITE(ah, AR_PHY_SPUR_REG, new);\n\n\tspur_delta_phase = ((bb_spur * 524288) / 100) &\n\t\tAR_PHY_TIMING11_SPUR_DELTA_PHASE;\n\n\tdenominator = IS_CHAN_2GHZ(chan) ? 440 : 400;\n\tspur_freq_sd = ((bb_spur * 2048) / denominator) & 0x3ff;\n\n\tnew = (AR_PHY_TIMING11_USE_SPUR_IN_AGC |\n\t       SM(spur_freq_sd, AR_PHY_TIMING11_SPUR_FREQ_SD) |\n\t       SM(spur_delta_phase, AR_PHY_TIMING11_SPUR_DELTA_PHASE));\n\tREG_WRITE(ah, AR_PHY_TIMING11, new);\n\n\tar5008_hw_cmn_spur_mitigate(ah, chan, bin);\n}\n\n \nstatic int ar5008_hw_rf_alloc_ext_banks(struct ath_hw *ah)\n{\n\tint size = ah->iniBank6.ia_rows * sizeof(u32);\n\n\tif (AR_SREV_9280_20_OR_LATER(ah))\n\t    return 0;\n\n\tah->analogBank6Data = devm_kzalloc(ah->dev, size, GFP_KERNEL);\n\tif (!ah->analogBank6Data)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\n\n \nstatic bool ar5008_hw_set_rf_regs(struct ath_hw *ah,\n\t\t\t\t  struct ath9k_channel *chan,\n\t\t\t\t  u16 modesIndex)\n{\n\tu32 eepMinorRev;\n\tu32 ob5GHz = 0, db5GHz = 0;\n\tu32 ob2GHz = 0, db2GHz = 0;\n\tint regWrites = 0;\n\tint i;\n\n\t \n\tif (AR_SREV_9280_20_OR_LATER(ah))\n\t\treturn true;\n\n\t \n\teepMinorRev = ah->eep_ops->get_eeprom_rev(ah);\n\n\tfor (i = 0; i < ah->iniBank6.ia_rows; i++)\n\t\tah->analogBank6Data[i] = INI_RA(&ah->iniBank6, i, modesIndex);\n\n\t \n\tif (eepMinorRev >= 2) {\n\t\tif (IS_CHAN_2GHZ(chan)) {\n\t\t\tob2GHz = ah->eep_ops->get_eeprom(ah, EEP_OB_2);\n\t\t\tdb2GHz = ah->eep_ops->get_eeprom(ah, EEP_DB_2);\n\t\t\tar5008_hw_phy_modify_rx_buffer(ah->analogBank6Data,\n\t\t\t\t\t\t       ob2GHz, 3, 197, 0);\n\t\t\tar5008_hw_phy_modify_rx_buffer(ah->analogBank6Data,\n\t\t\t\t\t\t       db2GHz, 3, 194, 0);\n\t\t} else {\n\t\t\tob5GHz = ah->eep_ops->get_eeprom(ah, EEP_OB_5);\n\t\t\tdb5GHz = ah->eep_ops->get_eeprom(ah, EEP_DB_5);\n\t\t\tar5008_hw_phy_modify_rx_buffer(ah->analogBank6Data,\n\t\t\t\t\t\t       ob5GHz, 3, 203, 0);\n\t\t\tar5008_hw_phy_modify_rx_buffer(ah->analogBank6Data,\n\t\t\t\t\t\t       db5GHz, 3, 200, 0);\n\t\t}\n\t}\n\n\t \n\tREG_WRITE_ARRAY(&bank0, 1, regWrites);\n\tREG_WRITE_ARRAY(&bank1, 1, regWrites);\n\tREG_WRITE_ARRAY(&bank2, 1, regWrites);\n\tREG_WRITE_ARRAY(&bank3, modesIndex, regWrites);\n\tar5008_write_bank6(ah, &regWrites);\n\tREG_WRITE_ARRAY(&bank7, 1, regWrites);\n\n\treturn true;\n}\n\nstatic void ar5008_hw_init_bb(struct ath_hw *ah,\n\t\t\t      struct ath9k_channel *chan)\n{\n\tu32 synthDelay;\n\n\tsynthDelay = REG_READ(ah, AR_PHY_RX_DELAY) & AR_PHY_RX_DELAY_DELAY;\n\n\tREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_EN);\n\n\tath9k_hw_synth_delay(ah, chan, synthDelay);\n}\n\nstatic void ar5008_hw_init_chain_masks(struct ath_hw *ah)\n{\n\tint rx_chainmask, tx_chainmask;\n\n\trx_chainmask = ah->rxchainmask;\n\ttx_chainmask = ah->txchainmask;\n\n\n\tswitch (rx_chainmask) {\n\tcase 0x5:\n\t\tREG_SET_BIT(ah, AR_PHY_ANALOG_SWAP,\n\t\t\t    AR_PHY_SWAP_ALT_CHAIN);\n\t\tfallthrough;\n\tcase 0x3:\n\t\tif (ah->hw_version.macVersion == AR_SREV_REVISION_5416_10) {\n\t\t\tREG_WRITE(ah, AR_PHY_RX_CHAINMASK, 0x7);\n\t\t\tREG_WRITE(ah, AR_PHY_CAL_CHAINMASK, 0x7);\n\t\t\tbreak;\n\t\t}\n\t\tfallthrough;\n\tcase 0x1:\n\tcase 0x2:\n\tcase 0x7:\n\t\tENABLE_REGWRITE_BUFFER(ah);\n\t\tREG_WRITE(ah, AR_PHY_RX_CHAINMASK, rx_chainmask);\n\t\tREG_WRITE(ah, AR_PHY_CAL_CHAINMASK, rx_chainmask);\n\t\tbreak;\n\tdefault:\n\t\tENABLE_REGWRITE_BUFFER(ah);\n\t\tbreak;\n\t}\n\n\tREG_WRITE(ah, AR_SELFGEN_MASK, tx_chainmask);\n\n\tREGWRITE_BUFFER_FLUSH(ah);\n\n\tif (tx_chainmask == 0x5) {\n\t\tREG_SET_BIT(ah, AR_PHY_ANALOG_SWAP,\n\t\t\t    AR_PHY_SWAP_ALT_CHAIN);\n\t}\n\tif (AR_SREV_9100(ah))\n\t\tREG_WRITE(ah, AR_PHY_ANALOG_SWAP,\n\t\t\t  REG_READ(ah, AR_PHY_ANALOG_SWAP) | 0x00000001);\n}\n\nstatic void ar5008_hw_override_ini(struct ath_hw *ah,\n\t\t\t\t   struct ath9k_channel *chan)\n{\n\tu32 val;\n\n\t \n\tREG_SET_BIT(ah, AR_DIAG_SW, (AR_DIAG_RX_DIS | AR_DIAG_RX_ABORT));\n\n\tif (AR_SREV_9280_20_OR_LATER(ah)) {\n\t\t \n\t\tval = REG_READ(ah, AR_PCU_MISC_MODE2) &\n\t\t\t(~AR_ADHOC_MCAST_KEYID_ENABLE);\n\n\t\tif (!AR_SREV_9271(ah))\n\t\t\tval &= ~AR_PCU_MISC_MODE2_HWWAR1;\n\n\t\tif (AR_SREV_9287_11_OR_LATER(ah))\n\t\t\tval = val & (~AR_PCU_MISC_MODE2_HWWAR2);\n\n\t\tval |= AR_PCU_MISC_MODE2_CFP_IGNORE;\n\n\t\tREG_WRITE(ah, AR_PCU_MISC_MODE2, val);\n\t}\n\n\tif (AR_SREV_9280_20_OR_LATER(ah))\n\t\treturn;\n\t \n\tREG_WRITE(ah, 0x9800 + (651 << 2), 0x11);\n\n\t \n\tif (AR_SREV_9100(ah) || AR_SREV_9160(ah)) {\n\t\tval = REG_READ(ah, AR_PHY_HEAVY_CLIP_FACTOR_RIFS);\n\t\tval &= ~AR_PHY_RIFS_INIT_DELAY;\n\t\tREG_WRITE(ah, AR_PHY_HEAVY_CLIP_FACTOR_RIFS, val);\n\t}\n}\n\nstatic void ar5008_hw_set_channel_regs(struct ath_hw *ah,\n\t\t\t\t       struct ath9k_channel *chan)\n{\n\tu32 phymode;\n\tu32 enableDacFifo = 0;\n\n\tif (AR_SREV_9285_12_OR_LATER(ah))\n\t\tenableDacFifo = (REG_READ(ah, AR_PHY_TURBO) &\n\t\t\t\t\t AR_PHY_FC_ENABLE_DAC_FIFO);\n\n\tphymode = AR_PHY_FC_HT_EN | AR_PHY_FC_SHORT_GI_40\n\t\t| AR_PHY_FC_SINGLE_HT_LTF1 | AR_PHY_FC_WALSH | enableDacFifo;\n\n\tif (IS_CHAN_HT40(chan)) {\n\t\tphymode |= AR_PHY_FC_DYN2040_EN;\n\n\t\tif (IS_CHAN_HT40PLUS(chan))\n\t\t\tphymode |= AR_PHY_FC_DYN2040_PRI_CH;\n\n\t}\n\tENABLE_REGWRITE_BUFFER(ah);\n\tREG_WRITE(ah, AR_PHY_TURBO, phymode);\n\n\t \n\tath9k_hw_set11nmac2040(ah, chan);\n\n\tREG_WRITE(ah, AR_GTXTO, 25 << AR_GTXTO_TIMEOUT_LIMIT_S);\n\tREG_WRITE(ah, AR_CST, 0xF << AR_CST_TIMEOUT_LIMIT_S);\n\n\tREGWRITE_BUFFER_FLUSH(ah);\n}\n\n\nstatic int ar5008_hw_process_ini(struct ath_hw *ah,\n\t\t\t\t struct ath9k_channel *chan)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tint i, regWrites = 0;\n\tu32 modesIndex, freqIndex;\n\n\tif (IS_CHAN_5GHZ(chan)) {\n\t\tfreqIndex = 1;\n\t\tmodesIndex = IS_CHAN_HT40(chan) ? 2 : 1;\n\t} else {\n\t\tfreqIndex = 2;\n\t\tmodesIndex = IS_CHAN_HT40(chan) ? 3 : 4;\n\t}\n\n\t \n\tREG_WRITE(ah, AR_PHY(0), 0x00000007);\n\n\t \n\tREG_WRITE(ah, AR_PHY_ADC_SERIAL_CTL, AR_PHY_SEL_EXTERNAL_RADIO);\n\tif (ah->eep_ops->set_addac)\n\t\tah->eep_ops->set_addac(ah, chan);\n\n\tREG_WRITE_ARRAY(&ah->iniAddac, 1, regWrites);\n\tREG_WRITE(ah, AR_PHY_ADC_SERIAL_CTL, AR_PHY_SEL_INTERNAL_ADDAC);\n\n\tENABLE_REGWRITE_BUFFER(ah);\n\n\tfor (i = 0; i < ah->iniModes.ia_rows; i++) {\n\t\tu32 reg = INI_RA(&ah->iniModes, i, 0);\n\t\tu32 val = INI_RA(&ah->iniModes, i, modesIndex);\n\n\t\tif (reg == AR_AN_TOP2 && ah->need_an_top2_fixup)\n\t\t\tval &= ~AR_AN_TOP2_PWDCLKIND;\n\n\t\tREG_WRITE(ah, reg, val);\n\n\t\tif (reg >= 0x7800 && reg < 0x78a0\n\t\t    && ah->config.analog_shiftreg\n\t\t    && (common->bus_ops->ath_bus_type != ATH_USB)) {\n\t\t\tudelay(100);\n\t\t}\n\n\t\tDO_DELAY(regWrites);\n\t}\n\n\tREGWRITE_BUFFER_FLUSH(ah);\n\n\tif (AR_SREV_9280(ah) || AR_SREV_9287_11_OR_LATER(ah))\n\t\tREG_WRITE_ARRAY(&ah->iniModesRxGain, modesIndex, regWrites);\n\n\tif (AR_SREV_9280(ah) || AR_SREV_9285_12_OR_LATER(ah) ||\n\t    AR_SREV_9287_11_OR_LATER(ah))\n\t\tREG_WRITE_ARRAY(&ah->iniModesTxGain, modesIndex, regWrites);\n\n\tif (AR_SREV_9271_10(ah)) {\n\t\tREG_SET_BIT(ah, AR_PHY_SPECTRAL_SCAN, AR_PHY_SPECTRAL_SCAN_ENA);\n\t\tREG_RMW_FIELD(ah, AR_PHY_RF_CTL3, AR_PHY_TX_END_TO_ADC_ON, 0xa);\n\t}\n\n\tENABLE_REGWRITE_BUFFER(ah);\n\n\t \n\tfor (i = 0; i < ah->iniCommon.ia_rows; i++) {\n\t\tu32 reg = INI_RA(&ah->iniCommon, i, 0);\n\t\tu32 val = INI_RA(&ah->iniCommon, i, 1);\n\n\t\tREG_WRITE(ah, reg, val);\n\n\t\tif (reg >= 0x7800 && reg < 0x78a0\n\t\t    && ah->config.analog_shiftreg\n\t\t    && (common->bus_ops->ath_bus_type != ATH_USB)) {\n\t\t\tudelay(100);\n\t\t}\n\n\t\tDO_DELAY(regWrites);\n\t}\n\n\tREGWRITE_BUFFER_FLUSH(ah);\n\n\tREG_WRITE_ARRAY(&ah->iniBB_RfGain, freqIndex, regWrites);\n\n\tif (IS_CHAN_A_FAST_CLOCK(ah, chan))\n\t\tREG_WRITE_ARRAY(&ah->iniModesFastClock, modesIndex,\n\t\t\t\tregWrites);\n\n\tar5008_hw_override_ini(ah, chan);\n\tar5008_hw_set_channel_regs(ah, chan);\n\tar5008_hw_init_chain_masks(ah);\n\tath9k_olc_init(ah);\n\tath9k_hw_apply_txpower(ah, chan, false);\n\n\t \n\tif (!ath9k_hw_set_rf_regs(ah, chan, freqIndex)) {\n\t\tath_err(ath9k_hw_common(ah), \"ar5416SetRfRegs failed\\n\");\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nstatic void ar5008_hw_set_rfmode(struct ath_hw *ah, struct ath9k_channel *chan)\n{\n\tu32 rfMode = 0;\n\n\tif (chan == NULL)\n\t\treturn;\n\n\tif (IS_CHAN_2GHZ(chan))\n\t\trfMode |= AR_PHY_MODE_DYNAMIC;\n\telse\n\t\trfMode |= AR_PHY_MODE_OFDM;\n\n\tif (!AR_SREV_9280_20_OR_LATER(ah))\n\t\trfMode |= (IS_CHAN_5GHZ(chan)) ?\n\t\t\tAR_PHY_MODE_RF5GHZ : AR_PHY_MODE_RF2GHZ;\n\n\tif (IS_CHAN_A_FAST_CLOCK(ah, chan))\n\t\trfMode |= (AR_PHY_MODE_DYNAMIC | AR_PHY_MODE_DYN_CCK_DISABLE);\n\n\tREG_WRITE(ah, AR_PHY_MODE, rfMode);\n}\n\nstatic void ar5008_hw_mark_phy_inactive(struct ath_hw *ah)\n{\n\tREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_DIS);\n}\n\nstatic void ar5008_hw_set_delta_slope(struct ath_hw *ah,\n\t\t\t\t      struct ath9k_channel *chan)\n{\n\tu32 coef_scaled, ds_coef_exp, ds_coef_man;\n\tu32 clockMhzScaled = 0x64000000;\n\tstruct chan_centers centers;\n\n\tif (IS_CHAN_HALF_RATE(chan))\n\t\tclockMhzScaled = clockMhzScaled >> 1;\n\telse if (IS_CHAN_QUARTER_RATE(chan))\n\t\tclockMhzScaled = clockMhzScaled >> 2;\n\n\tath9k_hw_get_channel_centers(ah, chan, &centers);\n\tcoef_scaled = clockMhzScaled / centers.synth_center;\n\n\tath9k_hw_get_delta_slope_vals(ah, coef_scaled, &ds_coef_man,\n\t\t\t\t      &ds_coef_exp);\n\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING3,\n\t\t      AR_PHY_TIMING3_DSC_MAN, ds_coef_man);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING3,\n\t\t      AR_PHY_TIMING3_DSC_EXP, ds_coef_exp);\n\n\tcoef_scaled = (9 * coef_scaled) / 10;\n\n\tath9k_hw_get_delta_slope_vals(ah, coef_scaled, &ds_coef_man,\n\t\t\t\t      &ds_coef_exp);\n\n\tREG_RMW_FIELD(ah, AR_PHY_HALFGI,\n\t\t      AR_PHY_HALFGI_DSC_MAN, ds_coef_man);\n\tREG_RMW_FIELD(ah, AR_PHY_HALFGI,\n\t\t      AR_PHY_HALFGI_DSC_EXP, ds_coef_exp);\n}\n\nstatic bool ar5008_hw_rfbus_req(struct ath_hw *ah)\n{\n\tREG_WRITE(ah, AR_PHY_RFBUS_REQ, AR_PHY_RFBUS_REQ_EN);\n\treturn ath9k_hw_wait(ah, AR_PHY_RFBUS_GRANT, AR_PHY_RFBUS_GRANT_EN,\n\t\t\t   AR_PHY_RFBUS_GRANT_EN, AH_WAIT_TIMEOUT);\n}\n\nstatic void ar5008_hw_rfbus_done(struct ath_hw *ah)\n{\n\tu32 synthDelay = REG_READ(ah, AR_PHY_RX_DELAY) & AR_PHY_RX_DELAY_DELAY;\n\n\tath9k_hw_synth_delay(ah, ah->curchan, synthDelay);\n\n\tREG_WRITE(ah, AR_PHY_RFBUS_REQ, 0);\n}\n\nstatic void ar5008_restore_chainmask(struct ath_hw *ah)\n{\n\tint rx_chainmask = ah->rxchainmask;\n\n\tif ((rx_chainmask == 0x5) || (rx_chainmask == 0x3)) {\n\t\tREG_WRITE(ah, AR_PHY_RX_CHAINMASK, rx_chainmask);\n\t\tREG_WRITE(ah, AR_PHY_CAL_CHAINMASK, rx_chainmask);\n\t}\n}\n\nstatic u32 ar9160_hw_compute_pll_control(struct ath_hw *ah,\n\t\t\t\t\t struct ath9k_channel *chan)\n{\n\tu32 pll;\n\n\tpll = SM(0x5, AR_RTC_9160_PLL_REFDIV);\n\n\tif (chan && IS_CHAN_HALF_RATE(chan))\n\t\tpll |= SM(0x1, AR_RTC_9160_PLL_CLKSEL);\n\telse if (chan && IS_CHAN_QUARTER_RATE(chan))\n\t\tpll |= SM(0x2, AR_RTC_9160_PLL_CLKSEL);\n\n\tif (chan && IS_CHAN_5GHZ(chan))\n\t\tpll |= SM(0x50, AR_RTC_9160_PLL_DIV);\n\telse\n\t\tpll |= SM(0x58, AR_RTC_9160_PLL_DIV);\n\n\treturn pll;\n}\n\nstatic u32 ar5008_hw_compute_pll_control(struct ath_hw *ah,\n\t\t\t\t\t struct ath9k_channel *chan)\n{\n\tu32 pll;\n\n\tpll = AR_RTC_PLL_REFDIV_5 | AR_RTC_PLL_DIV2;\n\n\tif (chan && IS_CHAN_HALF_RATE(chan))\n\t\tpll |= SM(0x1, AR_RTC_PLL_CLKSEL);\n\telse if (chan && IS_CHAN_QUARTER_RATE(chan))\n\t\tpll |= SM(0x2, AR_RTC_PLL_CLKSEL);\n\n\tif (chan && IS_CHAN_5GHZ(chan))\n\t\tpll |= SM(0xa, AR_RTC_PLL_DIV);\n\telse\n\t\tpll |= SM(0xb, AR_RTC_PLL_DIV);\n\n\treturn pll;\n}\n\nstatic bool ar5008_hw_ani_control_new(struct ath_hw *ah,\n\t\t\t\t      enum ath9k_ani_cmd cmd,\n\t\t\t\t      int param)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tstruct ath9k_channel *chan = ah->curchan;\n\tstruct ar5416AniState *aniState = &ah->ani;\n\ts32 value;\n\n\tswitch (cmd & ah->ani_function) {\n\tcase ATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION:{\n\t\t \n\t\tu32 on = param ? 1 : 0;\n\t\t \n\t\tint m1ThreshLow = on ?\n\t\t\taniState->iniDef.m1ThreshLow : m1ThreshLow_off;\n\t\tint m2ThreshLow = on ?\n\t\t\taniState->iniDef.m2ThreshLow : m2ThreshLow_off;\n\t\tint m1Thresh = on ?\n\t\t\taniState->iniDef.m1Thresh : m1Thresh_off;\n\t\tint m2Thresh = on ?\n\t\t\taniState->iniDef.m2Thresh : m2Thresh_off;\n\t\tint m2CountThr = on ?\n\t\t\taniState->iniDef.m2CountThr : m2CountThr_off;\n\t\tint m2CountThrLow = on ?\n\t\t\taniState->iniDef.m2CountThrLow : m2CountThrLow_off;\n\t\tint m1ThreshLowExt = on ?\n\t\t\taniState->iniDef.m1ThreshLowExt : m1ThreshLowExt_off;\n\t\tint m2ThreshLowExt = on ?\n\t\t\taniState->iniDef.m2ThreshLowExt : m2ThreshLowExt_off;\n\t\tint m1ThreshExt = on ?\n\t\t\taniState->iniDef.m1ThreshExt : m1ThreshExt_off;\n\t\tint m2ThreshExt = on ?\n\t\t\taniState->iniDef.m2ThreshExt : m2ThreshExt_off;\n\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\n\t\t\t      AR_PHY_SFCORR_LOW_M1_THRESH_LOW,\n\t\t\t      m1ThreshLow);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\n\t\t\t      AR_PHY_SFCORR_LOW_M2_THRESH_LOW,\n\t\t\t      m2ThreshLow);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR,\n\t\t\t      AR_PHY_SFCORR_M1_THRESH, m1Thresh);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR,\n\t\t\t      AR_PHY_SFCORR_M2_THRESH, m2Thresh);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR,\n\t\t\t      AR_PHY_SFCORR_M2COUNT_THR, m2CountThr);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\n\t\t\t      AR_PHY_SFCORR_LOW_M2COUNT_THR_LOW,\n\t\t\t      m2CountThrLow);\n\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\n\t\t\t      AR_PHY_SFCORR_EXT_M1_THRESH_LOW, m1ThreshLowExt);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\n\t\t\t      AR_PHY_SFCORR_EXT_M2_THRESH_LOW, m2ThreshLowExt);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\n\t\t\t      AR_PHY_SFCORR_EXT_M1_THRESH, m1ThreshExt);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\n\t\t\t      AR_PHY_SFCORR_EXT_M2_THRESH, m2ThreshExt);\n\n\t\tif (on)\n\t\t\tREG_SET_BIT(ah, AR_PHY_SFCORR_LOW,\n\t\t\t\t    AR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW);\n\t\telse\n\t\t\tREG_CLR_BIT(ah, AR_PHY_SFCORR_LOW,\n\t\t\t\t    AR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW);\n\n\t\tif (on != aniState->ofdmWeakSigDetect) {\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"** ch %d: ofdm weak signal: %s=>%s\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->ofdmWeakSigDetect ?\n\t\t\t\t\"on\" : \"off\",\n\t\t\t\ton ? \"on\" : \"off\");\n\t\t\tif (on)\n\t\t\t\tah->stats.ast_ani_ofdmon++;\n\t\t\telse\n\t\t\t\tah->stats.ast_ani_ofdmoff++;\n\t\t\taniState->ofdmWeakSigDetect = on;\n\t\t}\n\t\tbreak;\n\t}\n\tcase ATH9K_ANI_FIRSTEP_LEVEL:{\n\t\tu32 level = param;\n\n\t\tvalue = level * 2;\n\t\tREG_RMW_FIELD(ah, AR_PHY_FIND_SIG,\n\t\t\t      AR_PHY_FIND_SIG_FIRSTEP, value);\n\t\tREG_RMW_FIELD(ah, AR_PHY_FIND_SIG_LOW,\n\t\t\t      AR_PHY_FIND_SIG_FIRSTEP_LOW, value);\n\n\t\tif (level != aniState->firstepLevel) {\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"** ch %d: level %d=>%d[def:%d] firstep[level]=%d ini=%d\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->firstepLevel,\n\t\t\t\tlevel,\n\t\t\t\tATH9K_ANI_FIRSTEP_LVL,\n\t\t\t\tvalue,\n\t\t\t\taniState->iniDef.firstep);\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"** ch %d: level %d=>%d[def:%d] firstep_low[level]=%d ini=%d\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->firstepLevel,\n\t\t\t\tlevel,\n\t\t\t\tATH9K_ANI_FIRSTEP_LVL,\n\t\t\t\tvalue,\n\t\t\t\taniState->iniDef.firstepLow);\n\t\t\tif (level > aniState->firstepLevel)\n\t\t\t\tah->stats.ast_ani_stepup++;\n\t\t\telse if (level < aniState->firstepLevel)\n\t\t\t\tah->stats.ast_ani_stepdown++;\n\t\t\taniState->firstepLevel = level;\n\t\t}\n\t\tbreak;\n\t}\n\tcase ATH9K_ANI_SPUR_IMMUNITY_LEVEL:{\n\t\tu32 level = param;\n\n\t\tvalue = (level + 1) * 2;\n\t\tREG_RMW_FIELD(ah, AR_PHY_TIMING5,\n\t\t\t      AR_PHY_TIMING5_CYCPWR_THR1, value);\n\n\t\tREG_RMW_FIELD(ah, AR_PHY_EXT_CCA,\n\t\t\t\t  AR_PHY_EXT_TIMING5_CYCPWR_THR1, value - 1);\n\n\t\tif (level != aniState->spurImmunityLevel) {\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"** ch %d: level %d=>%d[def:%d] cycpwrThr1[level]=%d ini=%d\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->spurImmunityLevel,\n\t\t\t\tlevel,\n\t\t\t\tATH9K_ANI_SPUR_IMMUNE_LVL,\n\t\t\t\tvalue,\n\t\t\t\taniState->iniDef.cycpwrThr1);\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"** ch %d: level %d=>%d[def:%d] cycpwrThr1Ext[level]=%d ini=%d\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->spurImmunityLevel,\n\t\t\t\tlevel,\n\t\t\t\tATH9K_ANI_SPUR_IMMUNE_LVL,\n\t\t\t\tvalue,\n\t\t\t\taniState->iniDef.cycpwrThr1Ext);\n\t\t\tif (level > aniState->spurImmunityLevel)\n\t\t\t\tah->stats.ast_ani_spurup++;\n\t\t\telse if (level < aniState->spurImmunityLevel)\n\t\t\t\tah->stats.ast_ani_spurdown++;\n\t\t\taniState->spurImmunityLevel = level;\n\t\t}\n\t\tbreak;\n\t}\n\tcase ATH9K_ANI_MRC_CCK:\n\t\t \n\t\tWARN_ON(1);\n\t\tbreak;\n\tdefault:\n\t\tath_dbg(common, ANI, \"invalid cmd %u\\n\", cmd);\n\t\treturn false;\n\t}\n\n\tath_dbg(common, ANI,\n\t\t\"ANI parameters: SI=%d, ofdmWS=%s FS=%d MRCcck=%s listenTime=%d ofdmErrs=%d cckErrs=%d\\n\",\n\t\taniState->spurImmunityLevel,\n\t\taniState->ofdmWeakSigDetect ? \"on\" : \"off\",\n\t\taniState->firstepLevel,\n\t\taniState->mrcCCK ? \"on\" : \"off\",\n\t\taniState->listenTime,\n\t\taniState->ofdmPhyErrCount,\n\t\taniState->cckPhyErrCount);\n\treturn true;\n}\n\nstatic void ar5008_hw_do_getnf(struct ath_hw *ah,\n\t\t\t      int16_t nfarray[NUM_NF_READINGS])\n{\n\tint16_t nf;\n\n\tnf = MS(REG_READ(ah, AR_PHY_CCA), AR_PHY_MINCCA_PWR);\n\tnfarray[0] = sign_extend32(nf, 8);\n\n\tnf = MS(REG_READ(ah, AR_PHY_CH1_CCA), AR_PHY_CH1_MINCCA_PWR);\n\tnfarray[1] = sign_extend32(nf, 8);\n\n\tnf = MS(REG_READ(ah, AR_PHY_CH2_CCA), AR_PHY_CH2_MINCCA_PWR);\n\tnfarray[2] = sign_extend32(nf, 8);\n\n\tif (!IS_CHAN_HT40(ah->curchan))\n\t\treturn;\n\n\tnf = MS(REG_READ(ah, AR_PHY_EXT_CCA), AR_PHY_EXT_MINCCA_PWR);\n\tnfarray[3] = sign_extend32(nf, 8);\n\n\tnf = MS(REG_READ(ah, AR_PHY_CH1_EXT_CCA), AR_PHY_CH1_EXT_MINCCA_PWR);\n\tnfarray[4] = sign_extend32(nf, 8);\n\n\tnf = MS(REG_READ(ah, AR_PHY_CH2_EXT_CCA), AR_PHY_CH2_EXT_MINCCA_PWR);\n\tnfarray[5] = sign_extend32(nf, 8);\n}\n\n \nstatic void ar5008_hw_ani_cache_ini_regs(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tstruct ath9k_channel *chan = ah->curchan;\n\tstruct ar5416AniState *aniState = &ah->ani;\n\tstruct ath9k_ani_default *iniDef;\n\tu32 val;\n\n\tiniDef = &aniState->iniDef;\n\n\tath_dbg(common, ANI, \"ver %d.%d opmode %u chan %d Mhz\\n\",\n\t\tah->hw_version.macVersion,\n\t\tah->hw_version.macRev,\n\t\tah->opmode,\n\t\tchan->channel);\n\n\tval = REG_READ(ah, AR_PHY_SFCORR);\n\tiniDef->m1Thresh = MS(val, AR_PHY_SFCORR_M1_THRESH);\n\tiniDef->m2Thresh = MS(val, AR_PHY_SFCORR_M2_THRESH);\n\tiniDef->m2CountThr = MS(val, AR_PHY_SFCORR_M2COUNT_THR);\n\n\tval = REG_READ(ah, AR_PHY_SFCORR_LOW);\n\tiniDef->m1ThreshLow = MS(val, AR_PHY_SFCORR_LOW_M1_THRESH_LOW);\n\tiniDef->m2ThreshLow = MS(val, AR_PHY_SFCORR_LOW_M2_THRESH_LOW);\n\tiniDef->m2CountThrLow = MS(val, AR_PHY_SFCORR_LOW_M2COUNT_THR_LOW);\n\n\tval = REG_READ(ah, AR_PHY_SFCORR_EXT);\n\tiniDef->m1ThreshExt = MS(val, AR_PHY_SFCORR_EXT_M1_THRESH);\n\tiniDef->m2ThreshExt = MS(val, AR_PHY_SFCORR_EXT_M2_THRESH);\n\tiniDef->m1ThreshLowExt = MS(val, AR_PHY_SFCORR_EXT_M1_THRESH_LOW);\n\tiniDef->m2ThreshLowExt = MS(val, AR_PHY_SFCORR_EXT_M2_THRESH_LOW);\n\tiniDef->firstep = REG_READ_FIELD(ah,\n\t\t\t\t\t AR_PHY_FIND_SIG,\n\t\t\t\t\t AR_PHY_FIND_SIG_FIRSTEP);\n\tiniDef->firstepLow = REG_READ_FIELD(ah,\n\t\t\t\t\t    AR_PHY_FIND_SIG_LOW,\n\t\t\t\t\t    AR_PHY_FIND_SIG_FIRSTEP_LOW);\n\tiniDef->cycpwrThr1 = REG_READ_FIELD(ah,\n\t\t\t\t\t    AR_PHY_TIMING5,\n\t\t\t\t\t    AR_PHY_TIMING5_CYCPWR_THR1);\n\tiniDef->cycpwrThr1Ext = REG_READ_FIELD(ah,\n\t\t\t\t\t       AR_PHY_EXT_CCA,\n\t\t\t\t\t       AR_PHY_EXT_TIMING5_CYCPWR_THR1);\n\n\t \n\taniState->spurImmunityLevel = ATH9K_ANI_SPUR_IMMUNE_LVL;\n\taniState->firstepLevel = ATH9K_ANI_FIRSTEP_LVL;\n\taniState->ofdmWeakSigDetect = true;\n\taniState->mrcCCK = false;  \n}\n\nstatic void ar5008_hw_set_nf_limits(struct ath_hw *ah)\n{\n\tah->nf_2g.max = AR_PHY_CCA_MAX_GOOD_VAL_5416_2GHZ;\n\tah->nf_2g.min = AR_PHY_CCA_MIN_GOOD_VAL_5416_2GHZ;\n\tah->nf_2g.nominal = AR_PHY_CCA_NOM_VAL_5416_2GHZ;\n\tah->nf_5g.max = AR_PHY_CCA_MAX_GOOD_VAL_5416_5GHZ;\n\tah->nf_5g.min = AR_PHY_CCA_MIN_GOOD_VAL_5416_5GHZ;\n\tah->nf_5g.nominal = AR_PHY_CCA_NOM_VAL_5416_5GHZ;\n}\n\nstatic void ar5008_hw_set_radar_params(struct ath_hw *ah,\n\t\t\t\t       struct ath_hw_radar_conf *conf)\n{\n\tu32 radar_0 = 0, radar_1;\n\n\tif (!conf) {\n\t\tREG_CLR_BIT(ah, AR_PHY_RADAR_0, AR_PHY_RADAR_0_ENA);\n\t\treturn;\n\t}\n\n\tradar_0 |= AR_PHY_RADAR_0_ENA | AR_PHY_RADAR_0_FFT_ENA;\n\tradar_0 |= SM(conf->fir_power, AR_PHY_RADAR_0_FIRPWR);\n\tradar_0 |= SM(conf->radar_rssi, AR_PHY_RADAR_0_RRSSI);\n\tradar_0 |= SM(conf->pulse_height, AR_PHY_RADAR_0_HEIGHT);\n\tradar_0 |= SM(conf->pulse_rssi, AR_PHY_RADAR_0_PRSSI);\n\tradar_0 |= SM(conf->pulse_inband, AR_PHY_RADAR_0_INBAND);\n\n\tradar_1 = REG_READ(ah, AR_PHY_RADAR_1);\n\tradar_1 &= ~(AR_PHY_RADAR_1_MAXLEN | AR_PHY_RADAR_1_RELSTEP_THRESH |\n\t\t     AR_PHY_RADAR_1_RELPWR_THRESH);\n\tradar_1 |= AR_PHY_RADAR_1_MAX_RRSSI;\n\tradar_1 |= AR_PHY_RADAR_1_BLOCK_CHECK;\n\tradar_1 |= SM(conf->pulse_maxlen, AR_PHY_RADAR_1_MAXLEN);\n\tradar_1 |= SM(conf->pulse_inband_step, AR_PHY_RADAR_1_RELSTEP_THRESH);\n\tradar_1 |= SM(conf->radar_inband, AR_PHY_RADAR_1_RELPWR_THRESH);\n\n\tREG_WRITE(ah, AR_PHY_RADAR_0, radar_0);\n\tREG_WRITE(ah, AR_PHY_RADAR_1, radar_1);\n\tif (conf->ext_channel)\n\t\tREG_SET_BIT(ah, AR_PHY_RADAR_EXT, AR_PHY_RADAR_EXT_ENA);\n\telse\n\t\tREG_CLR_BIT(ah, AR_PHY_RADAR_EXT, AR_PHY_RADAR_EXT_ENA);\n}\n\nstatic void ar5008_hw_set_radar_conf(struct ath_hw *ah)\n{\n\tstruct ath_hw_radar_conf *conf = &ah->radar_conf;\n\n\tconf->fir_power = -33;\n\tconf->radar_rssi = 20;\n\tconf->pulse_height = 10;\n\tconf->pulse_rssi = 15;\n\tconf->pulse_inband = 15;\n\tconf->pulse_maxlen = 255;\n\tconf->pulse_inband_step = 12;\n\tconf->radar_inband = 8;\n}\n\nstatic void ar5008_hw_init_txpower_cck(struct ath_hw *ah, int16_t *rate_array)\n{\n#define CCK_DELTA(_ah, x) ((OLC_FOR_AR9280_20_LATER(_ah)) ? max((x) - 2, 0) : (x))\n\tah->tx_power[0] = CCK_DELTA(ah, rate_array[rate1l]);\n\tah->tx_power[1] = CCK_DELTA(ah, min(rate_array[rate2l],\n\t\t\t\t\trate_array[rate2s]));\n\tah->tx_power[2] = CCK_DELTA(ah, min(rate_array[rate5_5l],\n\t\t\t\t\trate_array[rate5_5s]));\n\tah->tx_power[3] = CCK_DELTA(ah, min(rate_array[rate11l],\n\t\t\t\t\trate_array[rate11s]));\n#undef CCK_DELTA\n}\n\nstatic void ar5008_hw_init_txpower_ofdm(struct ath_hw *ah, int16_t *rate_array,\n\t\t\t\t\tint offset)\n{\n\tint i, idx = 0;\n\n\tfor (i = offset; i < offset + AR5008_OFDM_RATES; i++) {\n\t\tah->tx_power[i] = rate_array[idx];\n\t\tidx++;\n\t}\n}\n\nstatic void ar5008_hw_init_txpower_ht(struct ath_hw *ah, int16_t *rate_array,\n\t\t\t\t      int ss_offset, int ds_offset,\n\t\t\t\t      bool is_40, int ht40_delta)\n{\n\tint i, mcs_idx = (is_40) ? AR5008_HT40_SHIFT : AR5008_HT20_SHIFT;\n\n\tfor (i = ss_offset; i < ss_offset + AR5008_HT_SS_RATES; i++) {\n\t\tah->tx_power[i] = rate_array[mcs_idx] + ht40_delta;\n\t\tmcs_idx++;\n\t}\n\tmemcpy(&ah->tx_power[ds_offset], &ah->tx_power[ss_offset],\n\t       AR5008_HT_SS_RATES);\n}\n\nvoid ar5008_hw_init_rate_txpower(struct ath_hw *ah, int16_t *rate_array,\n\t\t\t\t struct ath9k_channel *chan, int ht40_delta)\n{\n\tif (IS_CHAN_5GHZ(chan)) {\n\t\tar5008_hw_init_txpower_ofdm(ah, rate_array,\n\t\t\t\t\t    AR5008_11NA_OFDM_SHIFT);\n\t\tif (IS_CHAN_HT20(chan) || IS_CHAN_HT40(chan)) {\n\t\t\tar5008_hw_init_txpower_ht(ah, rate_array,\n\t\t\t\t\t\t  AR5008_11NA_HT_SS_SHIFT,\n\t\t\t\t\t\t  AR5008_11NA_HT_DS_SHIFT,\n\t\t\t\t\t\t  IS_CHAN_HT40(chan),\n\t\t\t\t\t\t  ht40_delta);\n\t\t}\n\t} else {\n\t\tar5008_hw_init_txpower_cck(ah, rate_array);\n\t\tar5008_hw_init_txpower_ofdm(ah, rate_array,\n\t\t\t\t\t    AR5008_11NG_OFDM_SHIFT);\n\t\tif (IS_CHAN_HT20(chan) || IS_CHAN_HT40(chan)) {\n\t\t\tar5008_hw_init_txpower_ht(ah, rate_array,\n\t\t\t\t\t\t  AR5008_11NG_HT_SS_SHIFT,\n\t\t\t\t\t\t  AR5008_11NG_HT_DS_SHIFT,\n\t\t\t\t\t\t  IS_CHAN_HT40(chan),\n\t\t\t\t\t\t  ht40_delta);\n\t\t}\n\t}\n}\n\nint ar5008_hw_attach_phy_ops(struct ath_hw *ah)\n{\n\tstruct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);\n\tstatic const u32 ar5416_cca_regs[6] = {\n\t\tAR_PHY_CCA,\n\t\tAR_PHY_CH1_CCA,\n\t\tAR_PHY_CH2_CCA,\n\t\tAR_PHY_EXT_CCA,\n\t\tAR_PHY_CH1_EXT_CCA,\n\t\tAR_PHY_CH2_EXT_CCA\n\t};\n\tint ret;\n\n\tret = ar5008_hw_rf_alloc_ext_banks(ah);\n\tif (ret)\n\t    return ret;\n\n\tpriv_ops->rf_set_freq = ar5008_hw_set_channel;\n\tpriv_ops->spur_mitigate_freq = ar5008_hw_spur_mitigate;\n\n\tpriv_ops->set_rf_regs = ar5008_hw_set_rf_regs;\n\tpriv_ops->set_channel_regs = ar5008_hw_set_channel_regs;\n\tpriv_ops->init_bb = ar5008_hw_init_bb;\n\tpriv_ops->process_ini = ar5008_hw_process_ini;\n\tpriv_ops->set_rfmode = ar5008_hw_set_rfmode;\n\tpriv_ops->mark_phy_inactive = ar5008_hw_mark_phy_inactive;\n\tpriv_ops->set_delta_slope = ar5008_hw_set_delta_slope;\n\tpriv_ops->rfbus_req = ar5008_hw_rfbus_req;\n\tpriv_ops->rfbus_done = ar5008_hw_rfbus_done;\n\tpriv_ops->restore_chainmask = ar5008_restore_chainmask;\n\tpriv_ops->do_getnf = ar5008_hw_do_getnf;\n\tpriv_ops->set_radar_params = ar5008_hw_set_radar_params;\n\n\tpriv_ops->ani_control = ar5008_hw_ani_control_new;\n\tpriv_ops->ani_cache_ini_regs = ar5008_hw_ani_cache_ini_regs;\n\n\tif (AR_SREV_9100(ah) || AR_SREV_9160_10_OR_LATER(ah))\n\t\tpriv_ops->compute_pll_control = ar9160_hw_compute_pll_control;\n\telse\n\t\tpriv_ops->compute_pll_control = ar5008_hw_compute_pll_control;\n\n\tar5008_hw_set_nf_limits(ah);\n\tar5008_hw_set_radar_conf(ah);\n\tmemcpy(ah->nf_regs, ar5416_cca_regs, sizeof(ah->nf_regs));\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}