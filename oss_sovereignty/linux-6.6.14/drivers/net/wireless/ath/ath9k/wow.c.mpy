{
  "module_name": "wow.c",
  "hash_id": "67c8af24c9e8e1556a9062b32d4117395178d0a254e716c19dc972a7a359977c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/wow.c",
  "human_readable_source": " \n\n#include \"ath9k.h\"\n\nstatic const struct wiphy_wowlan_support ath9k_wowlan_support_legacy = {\n\t.flags = WIPHY_WOWLAN_MAGIC_PKT | WIPHY_WOWLAN_DISCONNECT,\n\t.n_patterns = MAX_NUM_USER_PATTERN,\n\t.pattern_min_len = 1,\n\t.pattern_max_len = MAX_PATTERN_SIZE,\n};\n\nstatic const struct wiphy_wowlan_support ath9k_wowlan_support = {\n\t.flags = WIPHY_WOWLAN_MAGIC_PKT | WIPHY_WOWLAN_DISCONNECT,\n\t.n_patterns = MAX_NUM_PATTERN - 2,\n\t.pattern_min_len = 1,\n\t.pattern_max_len = MAX_PATTERN_SIZE,\n};\n\nstatic u8 ath9k_wow_map_triggers(struct ath_softc *sc,\n\t\t\t\t struct cfg80211_wowlan *wowlan)\n{\n\tu8 wow_triggers = 0;\n\n\tif (wowlan->disconnect)\n\t\twow_triggers |= AH_WOW_LINK_CHANGE |\n\t\t\t\tAH_WOW_BEACON_MISS;\n\tif (wowlan->magic_pkt)\n\t\twow_triggers |= AH_WOW_MAGIC_PATTERN_EN;\n\n\tif (wowlan->n_patterns)\n\t\twow_triggers |= AH_WOW_USER_PATTERN_EN;\n\n\treturn wow_triggers;\n}\n\nstatic int ath9k_wow_add_disassoc_deauth_pattern(struct ath_softc *sc)\n{\n\tstruct ath_hw *ah = sc->sc_ah;\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tint pattern_count = 0;\n\tint ret, i, byte_cnt = 0;\n\tu8 dis_deauth_pattern[MAX_PATTERN_SIZE];\n\tu8 dis_deauth_mask[MAX_PATTERN_SIZE];\n\n\tmemset(dis_deauth_pattern, 0, MAX_PATTERN_SIZE);\n\tmemset(dis_deauth_mask, 0, MAX_PATTERN_SIZE);\n\n\t \n\n\t \n\tfor (i = 0; i < MAX_PATTERN_MASK_SIZE; i++)\n\t\tdis_deauth_mask[i] = 0xff;\n\n\t \n\tdis_deauth_pattern[byte_cnt] = 0xa0;\n\tbyte_cnt++;\n\n\t \n\tbyte_cnt += 3;\n\n\t \n\tbyte_cnt += 6;\n\n\t \n\tmemcpy((dis_deauth_pattern + byte_cnt), common->curbssid, ETH_ALEN);\n\n\tbyte_cnt += 6;\n\n\t \n\tmemcpy((dis_deauth_pattern + byte_cnt), common->curbssid, ETH_ALEN);\n\n\t \n\tdis_deauth_mask[0] = 0xfe;\n\tdis_deauth_mask[1] = 0x03;\n\tdis_deauth_mask[2] = 0xc0;\n\n\tret = ath9k_hw_wow_apply_pattern(ah, dis_deauth_pattern, dis_deauth_mask,\n\t\t\t\t\t pattern_count, byte_cnt);\n\tif (ret)\n\t\tgoto exit;\n\n\tpattern_count++;\n\t \n\tdis_deauth_pattern[0] = 0xC0;\n\n\tret = ath9k_hw_wow_apply_pattern(ah, dis_deauth_pattern, dis_deauth_mask,\n\t\t\t\t\t pattern_count, byte_cnt);\nexit:\n\treturn ret;\n}\n\nstatic int ath9k_wow_add_pattern(struct ath_softc *sc,\n\t\t\t\t struct cfg80211_wowlan *wowlan)\n{\n\tstruct ath_hw *ah = sc->sc_ah;\n\tstruct cfg80211_pkt_pattern *patterns = wowlan->patterns;\n\tu8 wow_pattern[MAX_PATTERN_SIZE];\n\tu8 wow_mask[MAX_PATTERN_SIZE];\n\tint mask_len, ret = 0;\n\ts8 i = 0;\n\n\tfor (i = 0; i < wowlan->n_patterns; i++) {\n\t\tmask_len = DIV_ROUND_UP(patterns[i].pattern_len, 8);\n\t\tmemset(wow_pattern, 0, MAX_PATTERN_SIZE);\n\t\tmemset(wow_mask, 0, MAX_PATTERN_SIZE);\n\t\tmemcpy(wow_pattern, patterns[i].pattern, patterns[i].pattern_len);\n\t\tmemcpy(wow_mask, patterns[i].mask, mask_len);\n\n\t\tret = ath9k_hw_wow_apply_pattern(ah,\n\t\t\t\t\t\t wow_pattern,\n\t\t\t\t\t\t wow_mask,\n\t\t\t\t\t\t i + 2,\n\t\t\t\t\t\t patterns[i].pattern_len);\n\t\tif (ret)\n\t\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nint ath9k_suspend(struct ieee80211_hw *hw,\n\t\t  struct cfg80211_wowlan *wowlan)\n{\n\tstruct ath_softc *sc = hw->priv;\n\tstruct ath_hw *ah = sc->sc_ah;\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tu8 triggers;\n\tint ret = 0;\n\n\tath9k_deinit_channel_context(sc);\n\n\tmutex_lock(&sc->mutex);\n\n\tif (test_bit(ATH_OP_INVALID, &common->op_flags)) {\n\t\tath_err(common, \"Device not present\\n\");\n\t\tret = -ENODEV;\n\t\tgoto fail_wow;\n\t}\n\n\tif (WARN_ON(!wowlan)) {\n\t\tath_err(common, \"None of the WoW triggers enabled\\n\");\n\t\tret = -EINVAL;\n\t\tgoto fail_wow;\n\t}\n\n\tif (sc->cur_chan->nvifs > 1) {\n\t\tath_dbg(common, WOW, \"WoW for multivif is not yet supported\\n\");\n\t\tret = 1;\n\t\tgoto fail_wow;\n\t}\n\n\tif (ath9k_is_chanctx_enabled()) {\n\t\tif (test_bit(ATH_OP_MULTI_CHANNEL, &common->op_flags)) {\n\t\t\tath_dbg(common, WOW,\n\t\t\t\t\"Multi-channel WOW is not supported\\n\");\n\t\t\tret = 1;\n\t\t\tgoto fail_wow;\n\t\t}\n\t}\n\n\tif (!test_bit(ATH_OP_PRIM_STA_VIF, &common->op_flags)) {\n\t\tath_dbg(common, WOW, \"None of the STA vifs are associated\\n\");\n\t\tret = 1;\n\t\tgoto fail_wow;\n\t}\n\n\ttriggers = ath9k_wow_map_triggers(sc, wowlan);\n\tif (!triggers) {\n\t\tath_dbg(common, WOW, \"No valid WoW triggers\\n\");\n\t\tret = 1;\n\t\tgoto fail_wow;\n\t}\n\n\tath_cancel_work(sc);\n\tath_stop_ani(sc);\n\n\tath9k_ps_wakeup(sc);\n\n\tath9k_stop_btcoex(sc);\n\n\t \n\tret = ath9k_wow_add_disassoc_deauth_pattern(sc);\n\tif (ret) {\n\t\tath_err(common,\n\t\t\t\"Unable to add disassoc/deauth pattern: %d\\n\", ret);\n\t\tgoto fail_wow;\n\t}\n\n\tif (triggers & AH_WOW_USER_PATTERN_EN) {\n\t\tret = ath9k_wow_add_pattern(sc, wowlan);\n\t\tif (ret) {\n\t\t\tath_err(common,\n\t\t\t\t\"Unable to add user pattern: %d\\n\", ret);\n\t\t\tgoto fail_wow;\n\t\t}\n\t}\n\n\tspin_lock_bh(&sc->sc_pcu_lock);\n\t \n\tsc->wow_intr_before_sleep = ah->imask;\n\tah->imask &= ~ATH9K_INT_GLOBAL;\n\tath9k_hw_disable_interrupts(ah);\n\tah->imask = ATH9K_INT_BMISS | ATH9K_INT_GLOBAL;\n\tath9k_hw_set_interrupts(ah);\n\tath9k_hw_enable_interrupts(ah);\n\n\tspin_unlock_bh(&sc->sc_pcu_lock);\n\n\t \n\tsynchronize_irq(sc->irq);\n\ttasklet_kill(&sc->intr_tq);\n\n\tath9k_hw_wow_enable(ah, triggers);\n\n\tath9k_ps_restore(sc);\n\tath_dbg(common, WOW, \"Suspend with WoW triggers: 0x%x\\n\", triggers);\n\n\tset_bit(ATH_OP_WOW_ENABLED, &common->op_flags);\nfail_wow:\n\tmutex_unlock(&sc->mutex);\n\treturn ret;\n}\n\nint ath9k_resume(struct ieee80211_hw *hw)\n{\n\tstruct ath_softc *sc = hw->priv;\n\tstruct ath_hw *ah = sc->sc_ah;\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tu8 status;\n\n\tmutex_lock(&sc->mutex);\n\n\tath9k_ps_wakeup(sc);\n\n\tspin_lock_bh(&sc->sc_pcu_lock);\n\n\tath9k_hw_disable_interrupts(ah);\n\tah->imask = sc->wow_intr_before_sleep;\n\tath9k_hw_set_interrupts(ah);\n\tath9k_hw_enable_interrupts(ah);\n\n\tspin_unlock_bh(&sc->sc_pcu_lock);\n\n\tstatus = ath9k_hw_wow_wakeup(ah);\n\tath_dbg(common, WOW, \"Resume with WoW status: 0x%x\\n\", status);\n\n\tath_restart_work(sc);\n\tath9k_start_btcoex(sc);\n\n\tclear_bit(ATH_OP_WOW_ENABLED, &common->op_flags);\n\n\tath9k_ps_restore(sc);\n\tmutex_unlock(&sc->mutex);\n\n\treturn 0;\n}\n\nvoid ath9k_set_wakeup(struct ieee80211_hw *hw, bool enabled)\n{\n\tstruct ath_softc *sc = hw->priv;\n\tstruct ath_common *common = ath9k_hw_common(sc->sc_ah);\n\n\tmutex_lock(&sc->mutex);\n\tdevice_set_wakeup_enable(sc->dev, enabled);\n\tmutex_unlock(&sc->mutex);\n\n\tath_dbg(common, WOW, \"WoW wakeup source is %s\\n\",\n\t\t(enabled) ? \"enabled\" : \"disabled\");\n}\n\nvoid ath9k_init_wow(struct ieee80211_hw *hw)\n{\n\tstruct ath_softc *sc = hw->priv;\n\tstruct ath_hw *ah = sc->sc_ah;\n\n\tif ((sc->driver_data & ATH9K_PCI_WOW) || sc->force_wow) {\n\t\tif (AR_SREV_9462_20_OR_LATER(ah) || AR_SREV_9565_11_OR_LATER(ah))\n\t\t\thw->wiphy->wowlan = &ath9k_wowlan_support;\n\t\telse\n\t\t\thw->wiphy->wowlan = &ath9k_wowlan_support_legacy;\n\n\t\tdevice_init_wakeup(sc->dev, 1);\n\t}\n}\n\nvoid ath9k_deinit_wow(struct ieee80211_hw *hw)\n{\n\tstruct ath_softc *sc = hw->priv;\n\n\tif ((sc->driver_data & ATH9K_PCI_WOW) || sc->force_wow)\n\t\tdevice_init_wakeup(sc->dev, 0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}