{
  "module_name": "ar9002_hw.c",
  "hash_id": "438d6f7a12537651e43bcd5be6302baf4d41a650b4dd756089a45e5b67b084fa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/ar9002_hw.c",
  "human_readable_source": " \n\n#include <linux/moduleparam.h>\n#include \"hw.h\"\n#include \"ar5008_initvals.h\"\n#include \"ar9001_initvals.h\"\n#include \"ar9002_initvals.h\"\n#include \"ar9002_phy.h\"\n\n \n\nstatic int ar9002_hw_init_mode_regs(struct ath_hw *ah)\n{\n\tif (AR_SREV_9271(ah)) {\n\t\tINIT_INI_ARRAY(&ah->iniModes, ar9271Modes_9271);\n\t\tINIT_INI_ARRAY(&ah->iniCommon, ar9271Common_9271);\n\t\tINIT_INI_ARRAY(&ah->iniModes_9271_ANI_reg, ar9271Modes_9271_ANI_reg);\n\t\treturn 0;\n\t}\n\n\tINIT_INI_ARRAY(&ah->iniPcieSerdes,\n\t\t       ar9280PciePhy_clkreq_always_on_L1_9280);\n\n\tif (AR_SREV_9287_11_OR_LATER(ah)) {\n\t\tINIT_INI_ARRAY(&ah->iniModes, ar9287Modes_9287_1_1);\n\t\tINIT_INI_ARRAY(&ah->iniCommon, ar9287Common_9287_1_1);\n\t} else if (AR_SREV_9285_12_OR_LATER(ah)) {\n\t\tINIT_INI_ARRAY(&ah->iniModes, ar9285Modes_9285_1_2);\n\t\tINIT_INI_ARRAY(&ah->iniCommon, ar9285Common_9285_1_2);\n\t} else if (AR_SREV_9280_20_OR_LATER(ah)) {\n\t\tINIT_INI_ARRAY(&ah->iniModes, ar9280Modes_9280_2);\n\t\tINIT_INI_ARRAY(&ah->iniCommon, ar9280Common_9280_2);\n\n\t\tINIT_INI_ARRAY(&ah->iniModesFastClock,\n\t\t\t       ar9280Modes_fast_clock_9280_2);\n\t} else if (AR_SREV_9160_10_OR_LATER(ah)) {\n\t\tINIT_INI_ARRAY(&ah->iniModes, ar5416Modes_9160);\n\t\tINIT_INI_ARRAY(&ah->iniCommon, ar5416Common_9160);\n\t\tif (AR_SREV_9160_11(ah)) {\n\t\t\tINIT_INI_ARRAY(&ah->iniAddac,\n\t\t\t\t       ar5416Addac_9160_1_1);\n\t\t} else {\n\t\t\tINIT_INI_ARRAY(&ah->iniAddac, ar5416Addac_9160);\n\t\t}\n\t} else if (AR_SREV_9100_OR_LATER(ah)) {\n\t\tINIT_INI_ARRAY(&ah->iniModes, ar5416Modes_9100);\n\t\tINIT_INI_ARRAY(&ah->iniCommon, ar5416Common_9100);\n\t\tINIT_INI_ARRAY(&ah->iniAddac, ar5416Addac_9100);\n\t} else {\n\t\tINIT_INI_ARRAY(&ah->iniModes, ar5416Modes);\n\t\tINIT_INI_ARRAY(&ah->iniCommon, ar5416Common);\n\t\tINIT_INI_ARRAY(&ah->iniAddac, ar5416Addac);\n\t}\n\n\tif (!AR_SREV_9280_20_OR_LATER(ah)) {\n\t\t \n\t\tINIT_INI_ARRAY(&ah->iniBB_RfGain, ar5416BB_RfGain);\n\n\t\t \n\t\tif (!AR_SREV_5416(ah))\n\t\t\tINIT_INI_ARRAY(&ah->iniBank6, ar5416Bank6TPC_9100);\n\t\telse\n\t\t\tINIT_INI_ARRAY(&ah->iniBank6, ar5416Bank6TPC);\n\t}\n\n\t \n\tif (AR_SREV_9160(ah) || !AR_SREV_5416_22_OR_LATER(ah)) {\n\t\tstruct ar5416IniArray *addac = &ah->iniAddac;\n\t\tu32 size = sizeof(u32) * addac->ia_rows * addac->ia_columns;\n\t\tu32 *data;\n\n\t\tdata = devm_kzalloc(ah->dev, size, GFP_KERNEL);\n\t\tif (!data)\n\t\t\treturn -ENOMEM;\n\n\t\tmemcpy(data, addac->ia_array, size);\n\t\taddac->ia_array = data;\n\n\t\tif (!AR_SREV_5416_22_OR_LATER(ah)) {\n\t\t\t \n\t\t\tINI_RA(addac, 31,1) = 0;\n\t\t}\n\t}\n\tif (AR_SREV_9287_11_OR_LATER(ah)) {\n\t\tINIT_INI_ARRAY(&ah->iniCckfirNormal,\n\t\t       ar9287Common_normal_cck_fir_coeff_9287_1_1);\n\t\tINIT_INI_ARRAY(&ah->iniCckfirJapan2484,\n\t\t       ar9287Common_japan_2484_cck_fir_coeff_9287_1_1);\n\t}\n\treturn 0;\n}\n\nstatic void ar9280_20_hw_init_rxgain_ini(struct ath_hw *ah)\n{\n\tu32 rxgain_type;\n\n\tif (ah->eep_ops->get_eeprom_rev(ah) >= AR5416_EEP_MINOR_VER_17) {\n\t\trxgain_type = ah->eep_ops->get_eeprom(ah, EEP_RXGAIN_TYPE);\n\n\t\tif (rxgain_type == AR5416_EEP_RXGAIN_13DB_BACKOFF)\n\t\t\tINIT_INI_ARRAY(&ah->iniModesRxGain,\n\t\t\t\t       ar9280Modes_backoff_13db_rxgain_9280_2);\n\t\telse if (rxgain_type == AR5416_EEP_RXGAIN_23DB_BACKOFF)\n\t\t\tINIT_INI_ARRAY(&ah->iniModesRxGain,\n\t\t\t\t       ar9280Modes_backoff_23db_rxgain_9280_2);\n\t\telse\n\t\t\tINIT_INI_ARRAY(&ah->iniModesRxGain,\n\t\t\t\t       ar9280Modes_original_rxgain_9280_2);\n\t} else {\n\t\tINIT_INI_ARRAY(&ah->iniModesRxGain,\n\t\t\t       ar9280Modes_original_rxgain_9280_2);\n\t}\n}\n\nstatic void ar9280_20_hw_init_txgain_ini(struct ath_hw *ah, u32 txgain_type)\n{\n\tif (ah->eep_ops->get_eeprom_rev(ah) >= AR5416_EEP_MINOR_VER_19) {\n\t\tif (txgain_type == AR5416_EEP_TXGAIN_HIGH_POWER)\n\t\t\tINIT_INI_ARRAY(&ah->iniModesTxGain,\n\t\t\t\t       ar9280Modes_high_power_tx_gain_9280_2);\n\t\telse\n\t\t\tINIT_INI_ARRAY(&ah->iniModesTxGain,\n\t\t\t\t       ar9280Modes_original_tx_gain_9280_2);\n\t} else {\n\t\tINIT_INI_ARRAY(&ah->iniModesTxGain,\n\t\t\t       ar9280Modes_original_tx_gain_9280_2);\n\t}\n}\n\nstatic void ar9271_hw_init_txgain_ini(struct ath_hw *ah, u32 txgain_type)\n{\n\tif (txgain_type == AR5416_EEP_TXGAIN_HIGH_POWER)\n\t\tINIT_INI_ARRAY(&ah->iniModesTxGain,\n\t\t\t       ar9271Modes_high_power_tx_gain_9271);\n\telse\n\t\tINIT_INI_ARRAY(&ah->iniModesTxGain,\n\t\t\t       ar9271Modes_normal_power_tx_gain_9271);\n}\n\nstatic void ar9002_hw_init_mode_gain_regs(struct ath_hw *ah)\n{\n\tu32 txgain_type = ah->eep_ops->get_eeprom(ah, EEP_TXGAIN_TYPE);\n\n\tif (AR_SREV_9287_11_OR_LATER(ah))\n\t\tINIT_INI_ARRAY(&ah->iniModesRxGain,\n\t\t\t       ar9287Modes_rx_gain_9287_1_1);\n\telse if (AR_SREV_9280_20(ah))\n\t\tar9280_20_hw_init_rxgain_ini(ah);\n\n\tif (AR_SREV_9271(ah)) {\n\t\tar9271_hw_init_txgain_ini(ah, txgain_type);\n\t} else if (AR_SREV_9287_11_OR_LATER(ah)) {\n\t\tINIT_INI_ARRAY(&ah->iniModesTxGain,\n\t\t\t       ar9287Modes_tx_gain_9287_1_1);\n\t} else if (AR_SREV_9280_20(ah)) {\n\t\tar9280_20_hw_init_txgain_ini(ah, txgain_type);\n\t} else if (AR_SREV_9285_12_OR_LATER(ah)) {\n\t\t \n\t\tif (txgain_type == AR5416_EEP_TXGAIN_HIGH_POWER) {\n\t\t\tif (AR_SREV_9285E_20(ah)) {\n\t\t\t\tINIT_INI_ARRAY(&ah->iniModesTxGain,\n\t\t\t\t\t       ar9285Modes_XE2_0_high_power);\n\t\t\t} else {\n\t\t\t\tINIT_INI_ARRAY(&ah->iniModesTxGain,\n\t\t\t\t\tar9285Modes_high_power_tx_gain_9285_1_2);\n\t\t\t}\n\t\t} else {\n\t\t\tif (AR_SREV_9285E_20(ah)) {\n\t\t\t\tINIT_INI_ARRAY(&ah->iniModesTxGain,\n\t\t\t\t\t       ar9285Modes_XE2_0_normal_power);\n\t\t\t} else {\n\t\t\t\tINIT_INI_ARRAY(&ah->iniModesTxGain,\n\t\t\t\t\tar9285Modes_original_tx_gain_9285_1_2);\n\t\t\t}\n\t\t}\n\t}\n}\n\n \nstatic void ar9002_hw_configpcipowersave(struct ath_hw *ah,\n\t\t\t\t\t bool power_off)\n{\n\tu8 i;\n\tu32 val;\n\n\t \n\tif (!power_off  ) {\n\t\tif (AR_SREV_9280_20_OR_LATER(ah)) {\n\t\t\t \n\t\t\tfor (i = 0; i < ah->iniPcieSerdes.ia_rows; i++) {\n\t\t\t\tREG_WRITE(ah, INI_RA(&ah->iniPcieSerdes, i, 0),\n\t\t\t\t\t  INI_RA(&ah->iniPcieSerdes, i, 1));\n\t\t\t}\n\t\t} else {\n\t\t\tENABLE_REGWRITE_BUFFER(ah);\n\n\t\t\tREG_WRITE(ah, AR_PCIE_SERDES, 0x9248fc00);\n\t\t\tREG_WRITE(ah, AR_PCIE_SERDES, 0x24924924);\n\n\t\t\t \n\t\t\tREG_WRITE(ah, AR_PCIE_SERDES, 0x28000039);\n\t\t\tREG_WRITE(ah, AR_PCIE_SERDES, 0x53160824);\n\t\t\tREG_WRITE(ah, AR_PCIE_SERDES, 0xe5980579);\n\n\t\t\t \n\t\t\tREG_WRITE(ah, AR_PCIE_SERDES, 0x001defff);\n\n\t\t\tREG_WRITE(ah, AR_PCIE_SERDES, 0x1aaabe40);\n\t\t\tREG_WRITE(ah, AR_PCIE_SERDES, 0xbe105554);\n\t\t\tREG_WRITE(ah, AR_PCIE_SERDES, 0x000e3007);\n\n\t\t\t \n\t\t\tREG_WRITE(ah, AR_PCIE_SERDES2, 0x00000000);\n\n\t\t\tREGWRITE_BUFFER_FLUSH(ah);\n\t\t}\n\n\t\tudelay(1000);\n\t}\n\n\tif (power_off) {\n\t\t \n\t\tREG_CLR_BIT(ah, AR_PCIE_PM_CTRL(ah), AR_PCIE_PM_CTRL_ENA);\n\n\t\tval = REG_READ(ah, AR_WA(ah));\n\n\t\t \n\t\tif (ah->config.pcie_waen) {\n\t\t\tif (ah->config.pcie_waen & AR_WA_D3_L1_DISABLE)\n\t\t\t\tval |= AR_WA_D3_L1_DISABLE;\n\t\t} else {\n\t\t\tif (AR_SREV_9285(ah) || AR_SREV_9271(ah) || AR_SREV_9287(ah)) {\n\t\t\t\tif (AR9285_WA_DEFAULT & AR_WA_D3_L1_DISABLE)\n\t\t\t\t\tval |= AR_WA_D3_L1_DISABLE;\n\t\t\t} else if (AR_SREV_9280(ah)) {\n\t\t\t\tif (AR9280_WA_DEFAULT & AR_WA_D3_L1_DISABLE)\n\t\t\t\t\tval |= AR_WA_D3_L1_DISABLE;\n\t\t\t}\n\t\t}\n\n\t\tif (AR_SREV_9280(ah) || AR_SREV_9285(ah) || AR_SREV_9287(ah)) {\n\t\t\t \n\t\t\tval &= ~(AR_WA_BIT6 | AR_WA_BIT7);\n\t\t}\n\n\t\tif (AR_SREV_9280(ah))\n\t\t\tval |= AR_WA_BIT22;\n\n\t\tif (AR_SREV_9285E_20(ah))\n\t\t\tval |= AR_WA_BIT23;\n\n\t\tREG_WRITE(ah, AR_WA(ah), val);\n\t} else {\n\t\tif (ah->config.pcie_waen) {\n\t\t\tval = ah->config.pcie_waen;\n\t\t\tval &= (~AR_WA_D3_L1_DISABLE);\n\t\t} else {\n\t\t\tif (AR_SREV_9285(ah) || AR_SREV_9271(ah) || AR_SREV_9287(ah)) {\n\t\t\t\tval = AR9285_WA_DEFAULT;\n\t\t\t\tval &= (~AR_WA_D3_L1_DISABLE);\n\t\t\t} else if (AR_SREV_9280(ah)) {\n\t\t\t\t \n\t\t\t\tval = AR9280_WA_DEFAULT;\n\t\t\t\tval &= (~AR_WA_D3_L1_DISABLE);\n\t\t\t} else {\n\t\t\t\tval = AR_WA_DEFAULT;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tif (AR_SREV_9285(ah) || AR_SREV_9287(ah))\n\t\t\tval |= (AR_WA_BIT6 | AR_WA_BIT7);\n\n\t\tif (AR_SREV_9285E_20(ah))\n\t\t\tval |= AR_WA_BIT23;\n\n\t\tREG_WRITE(ah, AR_WA(ah), val);\n\n\t\t \n\t\tREG_SET_BIT(ah, AR_PCIE_PM_CTRL(ah), AR_PCIE_PM_CTRL_ENA);\n\t}\n}\n\nstatic int ar9002_hw_get_radiorev(struct ath_hw *ah)\n{\n\tu32 val;\n\tint i;\n\n\tENABLE_REGWRITE_BUFFER(ah);\n\n\tREG_WRITE(ah, AR_PHY(0x36), 0x00007058);\n\tfor (i = 0; i < 8; i++)\n\t\tREG_WRITE(ah, AR_PHY(0x20), 0x00010000);\n\n\tREGWRITE_BUFFER_FLUSH(ah);\n\n\tval = (REG_READ(ah, AR_PHY(256)) >> 24) & 0xff;\n\tval = ((val & 0xf0) >> 4) | ((val & 0x0f) << 4);\n\n\treturn ath9k_hw_reverse_bits(val, 8);\n}\n\nint ar9002_hw_rf_claim(struct ath_hw *ah)\n{\n\tu32 val;\n\n\tREG_WRITE(ah, AR_PHY(0), 0x00000007);\n\n\tval = ar9002_hw_get_radiorev(ah);\n\tswitch (val & AR_RADIO_SREV_MAJOR) {\n\tcase 0:\n\t\tval = AR_RAD5133_SREV_MAJOR;\n\t\tbreak;\n\tcase AR_RAD5133_SREV_MAJOR:\n\tcase AR_RAD5122_SREV_MAJOR:\n\tcase AR_RAD2133_SREV_MAJOR:\n\tcase AR_RAD2122_SREV_MAJOR:\n\t\tbreak;\n\tdefault:\n\t\tath_err(ath9k_hw_common(ah),\n\t\t\t\"Radio Chip Rev 0x%02X not supported\\n\",\n\t\t\tval & AR_RADIO_SREV_MAJOR);\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tah->hw_version.analog5GhzRev = val;\n\n\treturn 0;\n}\n\nvoid ar9002_hw_enable_async_fifo(struct ath_hw *ah)\n{\n\tif (AR_SREV_9287_13_OR_LATER(ah)) {\n\t\tREG_SET_BIT(ah, AR_MAC_PCU_ASYNC_FIFO_REG3,\n\t\t\t\tAR_MAC_PCU_ASYNC_FIFO_REG3_DATAPATH_SEL);\n\t\tREG_SET_BIT(ah, AR_PHY_MODE, AR_PHY_MODE_ASYNCFIFO);\n\t\tREG_CLR_BIT(ah, AR_MAC_PCU_ASYNC_FIFO_REG3,\n\t\t\t\tAR_MAC_PCU_ASYNC_FIFO_REG3_SOFT_RESET);\n\t\tREG_SET_BIT(ah, AR_MAC_PCU_ASYNC_FIFO_REG3,\n\t\t\t\tAR_MAC_PCU_ASYNC_FIFO_REG3_SOFT_RESET);\n\t}\n}\n\nstatic void ar9002_hw_init_hang_checks(struct ath_hw *ah)\n{\n\tif (AR_SREV_9100(ah) || AR_SREV_9160(ah)) {\n\t\tah->config.hw_hang_checks |= HW_BB_RIFS_HANG;\n\t\tah->config.hw_hang_checks |= HW_BB_DFS_HANG;\n\t}\n\n\tif (AR_SREV_9280(ah))\n\t\tah->config.hw_hang_checks |= HW_BB_RX_CLEAR_STUCK_HANG;\n\n\tif (AR_SREV_5416(ah) || AR_SREV_9100(ah) || AR_SREV_9160(ah))\n\t\tah->config.hw_hang_checks |= HW_MAC_HANG;\n}\n\n \nint ar9002_hw_attach_ops(struct ath_hw *ah)\n{\n\tstruct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);\n\tstruct ath_hw_ops *ops = ath9k_hw_ops(ah);\n\tint ret;\n\n\tret = ar9002_hw_init_mode_regs(ah);\n\tif (ret)\n\t\treturn ret;\n\n\tpriv_ops->init_mode_gain_regs = ar9002_hw_init_mode_gain_regs;\n\tpriv_ops->init_hang_checks = ar9002_hw_init_hang_checks;\n\n\tops->config_pci_powersave = ar9002_hw_configpcipowersave;\n\n\tret = ar5008_hw_attach_phy_ops(ah);\n\tif (ret)\n\t\treturn ret;\n\n\tif (AR_SREV_9280_20_OR_LATER(ah))\n\t\tar9002_hw_attach_phy_ops(ah);\n\n\tar9002_hw_attach_calib_ops(ah);\n\tar9002_hw_attach_mac_ops(ah);\n\treturn 0;\n}\n\nvoid ar9002_hw_load_ani_reg(struct ath_hw *ah, struct ath9k_channel *chan)\n{\n\tu32 modesIndex;\n\tint i;\n\n\tif (IS_CHAN_5GHZ(chan))\n\t\tmodesIndex = IS_CHAN_HT40(chan) ? 2 : 1;\n\telse\n\t\tmodesIndex = IS_CHAN_HT40(chan) ? 3 : 4;\n\n\tENABLE_REGWRITE_BUFFER(ah);\n\n\tfor (i = 0; i < ah->iniModes_9271_ANI_reg.ia_rows; i++) {\n\t\tu32 reg = INI_RA(&ah->iniModes_9271_ANI_reg, i, 0);\n\t\tu32 val = INI_RA(&ah->iniModes_9271_ANI_reg, i, modesIndex);\n\t\tu32 val_orig;\n\n\t\tif (reg == AR_PHY_CCK_DETECT) {\n\t\t\tval_orig = REG_READ(ah, reg);\n\t\t\tval &= AR_PHY_CCK_DETECT_WEAK_SIG_THR_CCK;\n\t\t\tval_orig &= ~AR_PHY_CCK_DETECT_WEAK_SIG_THR_CCK;\n\n\t\t\tREG_WRITE(ah, reg, val|val_orig);\n\t\t} else\n\t\t\tREG_WRITE(ah, reg, val);\n\t}\n\n\tREGWRITE_BUFFER_FLUSH(ah);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}