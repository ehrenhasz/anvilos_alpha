{
  "module_name": "ar9003_rtt.c",
  "hash_id": "e1f2cace785213fc521494ff60b9ae78afe8d55b720d763b18d4c9cd23129367",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/ar9003_rtt.c",
  "human_readable_source": " \n\n#include \"hw.h\"\n#include \"hw-ops.h\"\n#include \"ar9003_phy.h\"\n#include \"ar9003_rtt.h\"\n\n#define RTT_RESTORE_TIMEOUT          1000\n#define RTT_ACCESS_TIMEOUT           100\n#define RTT_BAD_VALUE                0x0bad0bad\n\n \n\nvoid ar9003_hw_rtt_enable(struct ath_hw *ah)\n{\n\tREG_WRITE(ah, AR_PHY_RTT_CTRL, 1);\n}\n\nvoid ar9003_hw_rtt_disable(struct ath_hw *ah)\n{\n\tREG_WRITE(ah, AR_PHY_RTT_CTRL, 0);\n}\n\nvoid ar9003_hw_rtt_set_mask(struct ath_hw *ah, u32 rtt_mask)\n{\n\tREG_RMW_FIELD(ah, AR_PHY_RTT_CTRL,\n\t\t      AR_PHY_RTT_CTRL_RESTORE_MASK, rtt_mask);\n}\n\nbool ar9003_hw_rtt_force_restore(struct ath_hw *ah)\n{\n\tif (!ath9k_hw_wait(ah, AR_PHY_RTT_CTRL,\n\t\t\t   AR_PHY_RTT_CTRL_FORCE_RADIO_RESTORE,\n\t\t\t   0, RTT_RESTORE_TIMEOUT))\n\t\treturn false;\n\n\tREG_RMW_FIELD(ah, AR_PHY_RTT_CTRL,\n\t\t      AR_PHY_RTT_CTRL_FORCE_RADIO_RESTORE, 1);\n\n\tif (!ath9k_hw_wait(ah, AR_PHY_RTT_CTRL,\n\t\t\t   AR_PHY_RTT_CTRL_FORCE_RADIO_RESTORE,\n\t\t\t   0, RTT_RESTORE_TIMEOUT))\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic void ar9003_hw_rtt_load_hist_entry(struct ath_hw *ah, u8 chain,\n\t\t\t\t\t  u32 index, u32 data28)\n{\n\tu32 val;\n\n\tval = SM(data28, AR_PHY_RTT_SW_RTT_TABLE_DATA);\n\tREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_1_B(chain), val);\n\n\tval = SM(0, AR_PHY_RTT_SW_RTT_TABLE_ACCESS) |\n\t      SM(1, AR_PHY_RTT_SW_RTT_TABLE_WRITE) |\n\t      SM(index, AR_PHY_RTT_SW_RTT_TABLE_ADDR);\n\tREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain), val);\n\tudelay(1);\n\n\tval |= SM(1, AR_PHY_RTT_SW_RTT_TABLE_ACCESS);\n\tREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain), val);\n\tudelay(1);\n\n\tif (!ath9k_hw_wait(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain),\n\t\t\t   AR_PHY_RTT_SW_RTT_TABLE_ACCESS, 0,\n\t\t\t   RTT_ACCESS_TIMEOUT))\n\t\treturn;\n\n\tval &= ~SM(1, AR_PHY_RTT_SW_RTT_TABLE_WRITE);\n\tREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain), val);\n\tudelay(1);\n\n\tath9k_hw_wait(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain),\n\t\t      AR_PHY_RTT_SW_RTT_TABLE_ACCESS, 0,\n\t\t      RTT_ACCESS_TIMEOUT);\n}\n\nvoid ar9003_hw_rtt_load_hist(struct ath_hw *ah)\n{\n\tint chain, i;\n\n\tfor (chain = 0; chain < AR9300_MAX_CHAINS; chain++) {\n\t\tif (!(ah->caps.rx_chainmask & (1 << chain)))\n\t\t\tcontinue;\n\t\tfor (i = 0; i < MAX_RTT_TABLE_ENTRY; i++) {\n\t\t\tar9003_hw_rtt_load_hist_entry(ah, chain, i,\n\t\t\t\t\t      ah->caldata->rtt_table[chain][i]);\n\t\t\tath_dbg(ath9k_hw_common(ah), CALIBRATE,\n\t\t\t\t\"Load RTT value at idx %d, chain %d: 0x%x\\n\",\n\t\t\t\ti, chain, ah->caldata->rtt_table[chain][i]);\n\t\t}\n\t}\n}\n\nstatic void ar9003_hw_patch_rtt(struct ath_hw *ah, int index, int chain)\n{\n\tint agc, caldac;\n\n\tif (!test_bit(SW_PKDET_DONE, &ah->caldata->cal_flags))\n\t\treturn;\n\n\tif ((index != 5) || (chain >= 2))\n\t\treturn;\n\n\tagc = REG_READ_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t\t     AR_PHY_65NM_RXRF_AGC_AGC_OVERRIDE);\n\tif (!agc)\n\t\treturn;\n\n\tcaldac = ah->caldata->caldac[chain];\n\tah->caldata->rtt_table[chain][index] &= 0xFFFF05FF;\n\tcaldac = (caldac & 0x20) | ((caldac & 0x1F) << 7);\n\tah->caldata->rtt_table[chain][index] |= (caldac << 4);\n}\n\nstatic int ar9003_hw_rtt_fill_hist_entry(struct ath_hw *ah, u8 chain, u32 index)\n{\n\tu32 val;\n\n\tval = SM(0, AR_PHY_RTT_SW_RTT_TABLE_ACCESS) |\n\t      SM(0, AR_PHY_RTT_SW_RTT_TABLE_WRITE) |\n\t      SM(index, AR_PHY_RTT_SW_RTT_TABLE_ADDR);\n\n\tREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain), val);\n\tudelay(1);\n\n\tval |= SM(1, AR_PHY_RTT_SW_RTT_TABLE_ACCESS);\n\tREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain), val);\n\tudelay(1);\n\n\tif (!ath9k_hw_wait(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain),\n\t\t\t   AR_PHY_RTT_SW_RTT_TABLE_ACCESS, 0,\n\t\t\t   RTT_ACCESS_TIMEOUT))\n\t\treturn RTT_BAD_VALUE;\n\n\tval = MS(REG_READ(ah, AR_PHY_RTT_TABLE_SW_INTF_1_B(chain)),\n\t\t AR_PHY_RTT_SW_RTT_TABLE_DATA);\n\n\n\treturn val;\n}\n\nvoid ar9003_hw_rtt_fill_hist(struct ath_hw *ah)\n{\n\tint chain, i;\n\n\tfor (chain = 0; chain < AR9300_MAX_CHAINS; chain++) {\n\t\tif (!(ah->caps.rx_chainmask & (1 << chain)))\n\t\t\tcontinue;\n\t\tfor (i = 0; i < MAX_RTT_TABLE_ENTRY; i++) {\n\t\t\tah->caldata->rtt_table[chain][i] =\n\t\t\t\tar9003_hw_rtt_fill_hist_entry(ah, chain, i);\n\n\t\t\tar9003_hw_patch_rtt(ah, i, chain);\n\n\t\t\tath_dbg(ath9k_hw_common(ah), CALIBRATE,\n\t\t\t\t\"RTT value at idx %d, chain %d is: 0x%x\\n\",\n\t\t\t\ti, chain, ah->caldata->rtt_table[chain][i]);\n\t\t}\n\t}\n\n\tset_bit(RTT_DONE, &ah->caldata->cal_flags);\n}\n\nvoid ar9003_hw_rtt_clear_hist(struct ath_hw *ah)\n{\n\tint chain, i;\n\n\tfor (chain = 0; chain < AR9300_MAX_CHAINS; chain++) {\n\t\tif (!(ah->caps.rx_chainmask & (1 << chain)))\n\t\t\tcontinue;\n\t\tfor (i = 0; i < MAX_RTT_TABLE_ENTRY; i++)\n\t\t\tar9003_hw_rtt_load_hist_entry(ah, chain, i, 0);\n\t}\n\n\tif (ah->caldata)\n\t\tclear_bit(RTT_DONE, &ah->caldata->cal_flags);\n}\n\nbool ar9003_hw_rtt_restore(struct ath_hw *ah, struct ath9k_channel *chan)\n{\n\tbool restore;\n\n\tif (!ah->caldata)\n\t\treturn false;\n\n\tif (test_bit(SW_PKDET_DONE, &ah->caldata->cal_flags)) {\n\t\tif (IS_CHAN_2GHZ(chan)){\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(0),\n\t\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC2G_CALDAC_OVR,\n\t\t\t\t      ah->caldata->caldac[0]);\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(1),\n\t\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC2G_CALDAC_OVR,\n\t\t\t\t      ah->caldata->caldac[1]);\n\t\t} else {\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(0),\n\t\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC5G_CALDAC_OVR,\n\t\t\t\t      ah->caldata->caldac[0]);\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(1),\n\t\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC5G_CALDAC_OVR,\n\t\t\t\t      ah->caldata->caldac[1]);\n\t\t}\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(1),\n\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC_OVERRIDE, 0x1);\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(0),\n\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC_OVERRIDE, 0x1);\n\t}\n\n\tif (!test_bit(RTT_DONE, &ah->caldata->cal_flags))\n\t\treturn false;\n\n\tar9003_hw_rtt_enable(ah);\n\n\tif (test_bit(SW_PKDET_DONE, &ah->caldata->cal_flags))\n\t\tar9003_hw_rtt_set_mask(ah, 0x30);\n\telse\n\t\tar9003_hw_rtt_set_mask(ah, 0x10);\n\n\tif (!ath9k_hw_rfbus_req(ah)) {\n\t\tath_err(ath9k_hw_common(ah), \"Could not stop baseband\\n\");\n\t\trestore = false;\n\t\tgoto fail;\n\t}\n\n\tar9003_hw_rtt_load_hist(ah);\n\trestore = ar9003_hw_rtt_force_restore(ah);\n\nfail:\n\tath9k_hw_rfbus_done(ah);\n\tar9003_hw_rtt_disable(ah);\n\treturn restore;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}