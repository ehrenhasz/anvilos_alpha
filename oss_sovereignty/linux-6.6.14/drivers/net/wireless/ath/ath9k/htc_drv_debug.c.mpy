{
  "module_name": "htc_drv_debug.c",
  "hash_id": "c749b7eef74ac839b0ac801163dd81e8308ca82b2f12bd6e44983156e67cdabf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/htc_drv_debug.c",
  "human_readable_source": " \n\n#include \"htc.h\"\n\nstatic ssize_t read_file_tgt_int_stats(struct file *file, char __user *user_buf,\n\t\t\t\t       size_t count, loff_t *ppos)\n{\n\tstruct ath9k_htc_priv *priv = file->private_data;\n\tstruct ath9k_htc_target_int_stats cmd_rsp;\n\tchar buf[512];\n\tunsigned int len = 0;\n\tint ret = 0;\n\n\tmemset(&cmd_rsp, 0, sizeof(cmd_rsp));\n\n\tath9k_htc_ps_wakeup(priv);\n\n\tWMI_CMD(WMI_INT_STATS_CMDID);\n\tif (ret) {\n\t\tath9k_htc_ps_restore(priv);\n\t\treturn -EINVAL;\n\t}\n\n\tath9k_htc_ps_restore(priv);\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"RX\",\n\t\t\t be32_to_cpu(cmd_rsp.rx));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"RXORN\",\n\t\t\t be32_to_cpu(cmd_rsp.rxorn));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"RXEOL\",\n\t\t\t be32_to_cpu(cmd_rsp.rxeol));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"TXURN\",\n\t\t\t be32_to_cpu(cmd_rsp.txurn));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"TXTO\",\n\t\t\t be32_to_cpu(cmd_rsp.txto));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"CST\",\n\t\t\t be32_to_cpu(cmd_rsp.cst));\n\n\tif (len > sizeof(buf))\n\t\tlen = sizeof(buf);\n\n\treturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\n}\n\nstatic const struct file_operations fops_tgt_int_stats = {\n\t.read = read_file_tgt_int_stats,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\nstatic ssize_t read_file_tgt_tx_stats(struct file *file, char __user *user_buf,\n\t\t\t\t      size_t count, loff_t *ppos)\n{\n\tstruct ath9k_htc_priv *priv = file->private_data;\n\tstruct ath9k_htc_target_tx_stats cmd_rsp;\n\tchar buf[512];\n\tunsigned int len = 0;\n\tint ret = 0;\n\n\tmemset(&cmd_rsp, 0, sizeof(cmd_rsp));\n\n\tath9k_htc_ps_wakeup(priv);\n\n\tWMI_CMD(WMI_TX_STATS_CMDID);\n\tif (ret) {\n\t\tath9k_htc_ps_restore(priv);\n\t\treturn -EINVAL;\n\t}\n\n\tath9k_htc_ps_restore(priv);\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"Xretries\",\n\t\t\t be32_to_cpu(cmd_rsp.xretries));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"FifoErr\",\n\t\t\t be32_to_cpu(cmd_rsp.fifoerr));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"Filtered\",\n\t\t\t be32_to_cpu(cmd_rsp.filtered));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"TimerExp\",\n\t\t\t be32_to_cpu(cmd_rsp.timer_exp));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"ShortRetries\",\n\t\t\t be32_to_cpu(cmd_rsp.shortretries));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"LongRetries\",\n\t\t\t be32_to_cpu(cmd_rsp.longretries));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"QueueNull\",\n\t\t\t be32_to_cpu(cmd_rsp.qnull));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"EncapFail\",\n\t\t\t be32_to_cpu(cmd_rsp.encap_fail));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"NoBuf\",\n\t\t\t be32_to_cpu(cmd_rsp.nobuf));\n\n\tif (len > sizeof(buf))\n\t\tlen = sizeof(buf);\n\n\treturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\n}\n\nstatic const struct file_operations fops_tgt_tx_stats = {\n\t.read = read_file_tgt_tx_stats,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\nstatic ssize_t read_file_tgt_rx_stats(struct file *file, char __user *user_buf,\n\t\t\t\t      size_t count, loff_t *ppos)\n{\n\tstruct ath9k_htc_priv *priv = file->private_data;\n\tstruct ath9k_htc_target_rx_stats cmd_rsp;\n\tchar buf[512];\n\tunsigned int len = 0;\n\tint ret = 0;\n\n\tmemset(&cmd_rsp, 0, sizeof(cmd_rsp));\n\n\tath9k_htc_ps_wakeup(priv);\n\n\tWMI_CMD(WMI_RX_STATS_CMDID);\n\tif (ret) {\n\t\tath9k_htc_ps_restore(priv);\n\t\treturn -EINVAL;\n\t}\n\n\tath9k_htc_ps_restore(priv);\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"NoBuf\",\n\t\t\t be32_to_cpu(cmd_rsp.nobuf));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"HostSend\",\n\t\t\t be32_to_cpu(cmd_rsp.host_send));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"HostDone\",\n\t\t\t be32_to_cpu(cmd_rsp.host_done));\n\n\tif (len > sizeof(buf))\n\t\tlen = sizeof(buf);\n\n\treturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\n}\n\nstatic const struct file_operations fops_tgt_rx_stats = {\n\t.read = read_file_tgt_rx_stats,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\nstatic ssize_t read_file_xmit(struct file *file, char __user *user_buf,\n\t\t\t      size_t count, loff_t *ppos)\n{\n\tstruct ath9k_htc_priv *priv = file->private_data;\n\tchar buf[512];\n\tunsigned int len = 0;\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"Buffers queued\",\n\t\t\t priv->debug.tx_stats.buf_queued);\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"Buffers completed\",\n\t\t\t priv->debug.tx_stats.buf_completed);\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"SKBs queued\",\n\t\t\t priv->debug.tx_stats.skb_queued);\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"SKBs success\",\n\t\t\t priv->debug.tx_stats.skb_success);\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"SKBs failed\",\n\t\t\t priv->debug.tx_stats.skb_failed);\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"CAB queued\",\n\t\t\t priv->debug.tx_stats.cab_queued);\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"BE queued\",\n\t\t\t priv->debug.tx_stats.queue_stats[IEEE80211_AC_BE]);\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"BK queued\",\n\t\t\t priv->debug.tx_stats.queue_stats[IEEE80211_AC_BK]);\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"VI queued\",\n\t\t\t priv->debug.tx_stats.queue_stats[IEEE80211_AC_VI]);\n\tlen += scnprintf(buf + len, sizeof(buf) - len,\n\t\t\t \"%20s : %10u\\n\", \"VO queued\",\n\t\t\t priv->debug.tx_stats.queue_stats[IEEE80211_AC_VO]);\n\n\tif (len > sizeof(buf))\n\t\tlen = sizeof(buf);\n\n\treturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\n}\n\nstatic const struct file_operations fops_xmit = {\n\t.read = read_file_xmit,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\nvoid ath9k_htc_err_stat_rx(struct ath9k_htc_priv *priv,\n\t\t\t     struct ath_rx_status *rs)\n{\n\tath9k_cmn_debug_stat_rx(&priv->debug.rx_stats, rs);\n}\n\nstatic ssize_t read_file_skb_rx(struct file *file, char __user *user_buf,\n\t\t\t      size_t count, loff_t *ppos)\n{\n\tstruct ath9k_htc_priv *priv = file->private_data;\n\tchar *buf;\n\tunsigned int len = 0, size = 1500;\n\tssize_t retval = 0;\n\n\tbuf = kzalloc(size, GFP_KERNEL);\n\tif (buf == NULL)\n\t\treturn -ENOMEM;\n\n\tlen += scnprintf(buf + len, size - len,\n\t\t\t \"%20s : %10u\\n\", \"SKBs allocated\",\n\t\t\t priv->debug.skbrx_stats.skb_allocated);\n\tlen += scnprintf(buf + len, size - len,\n\t\t\t \"%20s : %10u\\n\", \"SKBs completed\",\n\t\t\t priv->debug.skbrx_stats.skb_completed);\n\tlen += scnprintf(buf + len, size - len,\n\t\t\t \"%20s : %10u\\n\", \"SKBs Dropped\",\n\t\t\t priv->debug.skbrx_stats.skb_dropped);\n\n\tif (len > size)\n\t\tlen = size;\n\n\tretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\n\tkfree(buf);\n\n\treturn retval;\n}\n\nstatic const struct file_operations fops_skb_rx = {\n\t.read = read_file_skb_rx,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\nstatic ssize_t read_file_slot(struct file *file, char __user *user_buf,\n\t\t\t      size_t count, loff_t *ppos)\n{\n\tstruct ath9k_htc_priv *priv = file->private_data;\n\tchar buf[512];\n\tunsigned int len;\n\n\tspin_lock_bh(&priv->tx.tx_lock);\n\tlen = scnprintf(buf, sizeof(buf),\n\t\t\t\"TX slot bitmap : %*pb\\n\"\n\t\t\t\"Used slots     : %d\\n\",\n\t\t\tMAX_TX_BUF_NUM, priv->tx.tx_slot,\n\t\t\tbitmap_weight(priv->tx.tx_slot, MAX_TX_BUF_NUM));\n\tspin_unlock_bh(&priv->tx.tx_lock);\n\treturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\n}\n\nstatic const struct file_operations fops_slot = {\n\t.read = read_file_slot,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\nstatic ssize_t read_file_queue(struct file *file, char __user *user_buf,\n\t\t\t       size_t count, loff_t *ppos)\n{\n\tstruct ath9k_htc_priv *priv = file->private_data;\n\tchar buf[512];\n\tunsigned int len = 0;\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len, \"%20s : %10u\\n\",\n\t\t\t \"Mgmt endpoint\", skb_queue_len(&priv->tx.mgmt_ep_queue));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len, \"%20s : %10u\\n\",\n\t\t\t \"Cab endpoint\", skb_queue_len(&priv->tx.cab_ep_queue));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len, \"%20s : %10u\\n\",\n\t\t\t \"Data BE endpoint\", skb_queue_len(&priv->tx.data_be_queue));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len, \"%20s : %10u\\n\",\n\t\t\t \"Data BK endpoint\", skb_queue_len(&priv->tx.data_bk_queue));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len, \"%20s : %10u\\n\",\n\t\t\t \"Data VI endpoint\", skb_queue_len(&priv->tx.data_vi_queue));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len, \"%20s : %10u\\n\",\n\t\t\t \"Data VO endpoint\", skb_queue_len(&priv->tx.data_vo_queue));\n\n\tlen += scnprintf(buf + len, sizeof(buf) - len, \"%20s : %10u\\n\",\n\t\t\t \"Failed queue\", skb_queue_len(&priv->tx.tx_failed));\n\n\tspin_lock_bh(&priv->tx.tx_lock);\n\tlen += scnprintf(buf + len, sizeof(buf) - len, \"%20s : %10u\\n\",\n\t\t\t \"Queued count\", priv->tx.queued_cnt);\n\tspin_unlock_bh(&priv->tx.tx_lock);\n\n\tif (len > sizeof(buf))\n\t\tlen = sizeof(buf);\n\n\treturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\n\n}\n\nstatic const struct file_operations fops_queue = {\n\t.read = read_file_queue,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\nstatic ssize_t read_file_debug(struct file *file, char __user *user_buf,\n\t\t\t       size_t count, loff_t *ppos)\n{\n\tstruct ath9k_htc_priv *priv = file->private_data;\n\tstruct ath_common *common = ath9k_hw_common(priv->ah);\n\tchar buf[32];\n\tunsigned int len;\n\n\tlen = sprintf(buf, \"0x%08x\\n\", common->debug_mask);\n\treturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\n}\n\nstatic ssize_t write_file_debug(struct file *file, const char __user *user_buf,\n\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tstruct ath9k_htc_priv *priv = file->private_data;\n\tstruct ath_common *common = ath9k_hw_common(priv->ah);\n\tunsigned long mask;\n\tssize_t ret;\n\n\tret = kstrtoul_from_user(user_buf, count, 0, &mask);\n\tif (ret)\n\t\treturn ret;\n\n\tcommon->debug_mask = mask;\n\treturn count;\n}\n\nstatic const struct file_operations fops_debug = {\n\t.read = read_file_debug,\n\t.write = write_file_debug,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\n \n#define AMKSTR(nm) #nm \"_BE\", #nm \"_BK\", #nm \"_VI\", #nm \"_VO\"\nstatic const char ath9k_htc_gstrings_stats[][ETH_GSTRING_LEN] = {\n\t\"tx_pkts_nic\",\n\t\"tx_bytes_nic\",\n\t\"rx_pkts_nic\",\n\t\"rx_bytes_nic\",\n\n\tAMKSTR(d_tx_pkts),\n\n\t\"d_rx_crc_err\",\n\t\"d_rx_decrypt_crc_err\",\n\t\"d_rx_phy_err\",\n\t\"d_rx_mic_err\",\n\t\"d_rx_pre_delim_crc_err\",\n\t\"d_rx_post_delim_crc_err\",\n\t\"d_rx_decrypt_busy_err\",\n\n\t\"d_rx_phyerr_radar\",\n\t\"d_rx_phyerr_ofdm_timing\",\n\t\"d_rx_phyerr_cck_timing\",\n\n};\n#define ATH9K_HTC_SSTATS_LEN ARRAY_SIZE(ath9k_htc_gstrings_stats)\n\nvoid ath9k_htc_get_et_strings(struct ieee80211_hw *hw,\n\t\t\t      struct ieee80211_vif *vif,\n\t\t\t      u32 sset, u8 *data)\n{\n\tif (sset == ETH_SS_STATS)\n\t\tmemcpy(data, ath9k_htc_gstrings_stats,\n\t\t       sizeof(ath9k_htc_gstrings_stats));\n}\n\nint ath9k_htc_get_et_sset_count(struct ieee80211_hw *hw,\n\t\t\t\tstruct ieee80211_vif *vif, int sset)\n{\n\tif (sset == ETH_SS_STATS)\n\t\treturn ATH9K_HTC_SSTATS_LEN;\n\treturn 0;\n}\n\n#define STXBASE priv->debug.tx_stats\n#define SRXBASE priv->debug.rx_stats\n#define SKBTXBASE priv->debug.tx_stats\n#define SKBRXBASE priv->debug.skbrx_stats\n#define ASTXQ(a)\t\t\t\t\t\\\n\tdata[i++] = STXBASE.a[IEEE80211_AC_BE];\t\t\\\n\tdata[i++] = STXBASE.a[IEEE80211_AC_BK];\t\t\\\n\tdata[i++] = STXBASE.a[IEEE80211_AC_VI];\t\t\\\n\tdata[i++] = STXBASE.a[IEEE80211_AC_VO]\n\nvoid ath9k_htc_get_et_stats(struct ieee80211_hw *hw,\n\t\t\t    struct ieee80211_vif *vif,\n\t\t\t    struct ethtool_stats *stats, u64 *data)\n{\n\tstruct ath9k_htc_priv *priv = hw->priv;\n\tint i = 0;\n\n\tdata[i++] = SKBTXBASE.skb_success;\n\tdata[i++] = SKBTXBASE.skb_success_bytes;\n\tdata[i++] = SKBRXBASE.skb_completed;\n\tdata[i++] = SKBRXBASE.skb_completed_bytes;\n\n\tASTXQ(queue_stats);\n\n\tdata[i++] = SRXBASE.crc_err;\n\tdata[i++] = SRXBASE.decrypt_crc_err;\n\tdata[i++] = SRXBASE.phy_err;\n\tdata[i++] = SRXBASE.mic_err;\n\tdata[i++] = SRXBASE.pre_delim_crc_err;\n\tdata[i++] = SRXBASE.post_delim_crc_err;\n\tdata[i++] = SRXBASE.decrypt_busy_err;\n\n\tdata[i++] = SRXBASE.phy_err_stats[ATH9K_PHYERR_RADAR];\n\tdata[i++] = SRXBASE.phy_err_stats[ATH9K_PHYERR_OFDM_TIMING];\n\tdata[i++] = SRXBASE.phy_err_stats[ATH9K_PHYERR_CCK_TIMING];\n\n\tWARN_ON(i != ATH9K_HTC_SSTATS_LEN);\n}\n\nvoid ath9k_htc_deinit_debug(struct ath9k_htc_priv *priv)\n{\n\tath9k_cmn_spectral_deinit_debug(&priv->spec_priv);\n}\n\nint ath9k_htc_init_debug(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tstruct ath9k_htc_priv *priv = (struct ath9k_htc_priv *) common->priv;\n\n\tpriv->debug.debugfs_phy = debugfs_create_dir(KBUILD_MODNAME,\n\t\t\t\t\t     priv->hw->wiphy->debugfsdir);\n\tif (IS_ERR(priv->debug.debugfs_phy))\n\t\treturn -ENOMEM;\n\n\tath9k_cmn_spectral_init_debug(&priv->spec_priv, priv->debug.debugfs_phy);\n\n\tdebugfs_create_file(\"tgt_int_stats\", 0400, priv->debug.debugfs_phy,\n\t\t\t    priv, &fops_tgt_int_stats);\n\tdebugfs_create_file(\"tgt_tx_stats\", 0400, priv->debug.debugfs_phy,\n\t\t\t    priv, &fops_tgt_tx_stats);\n\tdebugfs_create_file(\"tgt_rx_stats\", 0400, priv->debug.debugfs_phy,\n\t\t\t    priv, &fops_tgt_rx_stats);\n\tdebugfs_create_file(\"xmit\", 0400, priv->debug.debugfs_phy,\n\t\t\t    priv, &fops_xmit);\n\tdebugfs_create_file(\"skb_rx\", 0400, priv->debug.debugfs_phy,\n\t\t\t    priv, &fops_skb_rx);\n\n\tath9k_cmn_debug_recv(priv->debug.debugfs_phy, &priv->debug.rx_stats);\n\tath9k_cmn_debug_phy_err(priv->debug.debugfs_phy, &priv->debug.rx_stats);\n\n\tdebugfs_create_file(\"slot\", 0400, priv->debug.debugfs_phy,\n\t\t\t    priv, &fops_slot);\n\tdebugfs_create_file(\"queue\", 0400, priv->debug.debugfs_phy,\n\t\t\t    priv, &fops_queue);\n\tdebugfs_create_file(\"debug\", 0600, priv->debug.debugfs_phy,\n\t\t\t    priv, &fops_debug);\n\n\tath9k_cmn_debug_base_eeprom(priv->debug.debugfs_phy, priv->ah);\n\tath9k_cmn_debug_modal_eeprom(priv->debug.debugfs_phy, priv->ah);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}