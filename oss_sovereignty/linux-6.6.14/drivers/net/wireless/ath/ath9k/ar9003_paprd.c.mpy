{
  "module_name": "ar9003_paprd.c",
  "hash_id": "ca6d8f3698d0a5b8625e17d9ffecc0972a1a1866d89b80303cdaddbb844c3a89",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/ar9003_paprd.c",
  "human_readable_source": " \n\n#include <linux/export.h>\n#include \"hw.h\"\n#include \"ar9003_phy.h\"\n\nvoid ar9003_paprd_enable(struct ath_hw *ah, bool val)\n{\n\tstruct ath9k_channel *chan = ah->curchan;\n\tbool is2ghz = IS_CHAN_2GHZ(chan);\n\n\t \n\n\tif (!is2ghz) {\n\t\tif (chan->channel >= UPPER_5G_SUB_BAND_START) {\n\t\t\tif (ar9003_get_paprd_rate_mask_ht20(ah, is2ghz)\n\t\t\t\t\t\t\t\t  & BIT(30))\n\t\t\t\tval = false;\n\t\t} else if (chan->channel >= MID_5G_SUB_BAND_START) {\n\t\t\tif (ar9003_get_paprd_rate_mask_ht20(ah, is2ghz)\n\t\t\t\t\t\t\t\t  & BIT(29))\n\t\t\t\tval = false;\n\t\t} else {\n\t\t\tif (ar9003_get_paprd_rate_mask_ht20(ah, is2ghz)\n\t\t\t\t\t\t\t\t  & BIT(28))\n\t\t\t\tval = false;\n\t\t}\n\t}\n\n\tif (val) {\n\t\tah->paprd_table_write_done = true;\n\t\tath9k_hw_apply_txpower(ah, chan, false);\n\t}\n\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL0_B0,\n\t\t      AR_PHY_PAPRD_CTRL0_PAPRD_ENABLE, !!val);\n\tif (ah->caps.tx_chainmask & BIT(1))\n\t\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL0_B1,\n\t\t\t      AR_PHY_PAPRD_CTRL0_PAPRD_ENABLE, !!val);\n\tif (ah->caps.tx_chainmask & BIT(2))\n\t\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL0_B2,\n\t\t\t      AR_PHY_PAPRD_CTRL0_PAPRD_ENABLE, !!val);\n}\nEXPORT_SYMBOL(ar9003_paprd_enable);\n\nstatic int ar9003_get_training_power_2g(struct ath_hw *ah)\n{\n\tstruct ath9k_channel *chan = ah->curchan;\n\tunsigned int power, scale, delta;\n\n\tscale = ar9003_get_paprd_scale_factor(ah, chan);\n\n\tif (AR_SREV_9330(ah) || AR_SREV_9340(ah) ||\n\t    AR_SREV_9462(ah) || AR_SREV_9565(ah)) {\n\t\tpower = ah->paprd_target_power + 2;\n\t} else if (AR_SREV_9485(ah)) {\n\t\tpower = 25;\n\t} else {\n\t\tpower = REG_READ_FIELD(ah, AR_PHY_POWERTX_RATE5,\n\t\t\t\t       AR_PHY_POWERTX_RATE5_POWERTXHT20_0);\n\n\t\tdelta = abs((int) ah->paprd_target_power - (int) power);\n\t\tif (delta > scale)\n\t\t\treturn -1;\n\n\t\tif (delta < 4)\n\t\t\tpower -= 4 - delta;\n\t}\n\n\treturn power;\n}\n\nstatic int ar9003_get_training_power_5g(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tstruct ath9k_channel *chan = ah->curchan;\n\tunsigned int power, scale, delta;\n\n\tscale = ar9003_get_paprd_scale_factor(ah, chan);\n\n\tif (IS_CHAN_HT40(chan))\n\t\tpower = REG_READ_FIELD(ah, AR_PHY_POWERTX_RATE8,\n\t\t\tAR_PHY_POWERTX_RATE8_POWERTXHT40_5);\n\telse\n\t\tpower = REG_READ_FIELD(ah, AR_PHY_POWERTX_RATE6,\n\t\t\tAR_PHY_POWERTX_RATE6_POWERTXHT20_5);\n\n\tpower += scale;\n\tdelta = abs((int) ah->paprd_target_power - (int) power);\n\tif (delta > scale)\n\t\treturn -1;\n\n\tswitch (get_streams(ah->txchainmask)) {\n\tcase 1:\n\t\tdelta = 6;\n\t\tbreak;\n\tcase 2:\n\t\tdelta = 4;\n\t\tbreak;\n\tcase 3:\n\t\tdelta = 2;\n\t\tbreak;\n\tdefault:\n\t\tdelta = 0;\n\t\tath_dbg(common, CALIBRATE, \"Invalid tx-chainmask: %u\\n\",\n\t\t\tah->txchainmask);\n\t}\n\n\tpower += delta;\n\treturn power;\n}\n\nstatic int ar9003_paprd_setup_single_table(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tstatic const u32 ctrl0[3] = {\n\t\tAR_PHY_PAPRD_CTRL0_B0,\n\t\tAR_PHY_PAPRD_CTRL0_B1,\n\t\tAR_PHY_PAPRD_CTRL0_B2\n\t};\n\tstatic const u32 ctrl1[3] = {\n\t\tAR_PHY_PAPRD_CTRL1_B0,\n\t\tAR_PHY_PAPRD_CTRL1_B1,\n\t\tAR_PHY_PAPRD_CTRL1_B2\n\t};\n\tint training_power;\n\tint i, val;\n\tu32 am2pm_mask = ah->paprd_ratemask;\n\n\tif (IS_CHAN_2GHZ(ah->curchan))\n\t\ttraining_power = ar9003_get_training_power_2g(ah);\n\telse\n\t\ttraining_power = ar9003_get_training_power_5g(ah);\n\n\tath_dbg(common, CALIBRATE, \"Training power: %d, Target power: %d\\n\",\n\t\ttraining_power, ah->paprd_target_power);\n\n\tif (training_power < 0) {\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"PAPRD target power delta out of range\\n\");\n\t\treturn -ERANGE;\n\t}\n\tah->paprd_training_power = training_power;\n\n\tif (AR_SREV_9330(ah))\n\t\tam2pm_mask = 0;\n\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_AM2AM, AR_PHY_PAPRD_AM2AM_MASK,\n\t\t      ah->paprd_ratemask);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_AM2PM, AR_PHY_PAPRD_AM2PM_MASK,\n\t\t      am2pm_mask);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_HT40, AR_PHY_PAPRD_HT40_MASK,\n\t\t      ah->paprd_ratemask_ht40);\n\n\tath_dbg(common, CALIBRATE, \"PAPRD HT20 mask: 0x%x, HT40 mask: 0x%x\\n\",\n\t\tah->paprd_ratemask, ah->paprd_ratemask_ht40);\n\n\tfor (i = 0; i < ah->caps.max_txchains; i++) {\n\t\tREG_RMW_FIELD(ah, ctrl0[i],\n\t\t\t      AR_PHY_PAPRD_CTRL0_USE_SINGLE_TABLE_MASK, 1);\n\t\tREG_RMW_FIELD(ah, ctrl1[i],\n\t\t\t      AR_PHY_PAPRD_CTRL1_ADAPTIVE_AM2PM_ENABLE, 1);\n\t\tREG_RMW_FIELD(ah, ctrl1[i],\n\t\t\t      AR_PHY_PAPRD_CTRL1_ADAPTIVE_AM2AM_ENABLE, 1);\n\t\tREG_RMW_FIELD(ah, ctrl1[i],\n\t\t\t      AR_PHY_PAPRD_CTRL1_ADAPTIVE_SCALING_ENA, 0);\n\t\tREG_RMW_FIELD(ah, ctrl1[i],\n\t\t\t      AR_PHY_PAPRD_CTRL1_PA_GAIN_SCALE_FACT_MASK, 181);\n\t\tREG_RMW_FIELD(ah, ctrl1[i],\n\t\t\t      AR_PHY_PAPRD_CTRL1_PAPRD_MAG_SCALE_FACT, 361);\n\t\tREG_RMW_FIELD(ah, ctrl1[i],\n\t\t\t      AR_PHY_PAPRD_CTRL1_ADAPTIVE_SCALING_ENA, 0);\n\t\tREG_RMW_FIELD(ah, ctrl0[i],\n\t\t\t      AR_PHY_PAPRD_CTRL0_PAPRD_MAG_THRSH, 3);\n\t}\n\n\tar9003_paprd_enable(ah, false);\n\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_SKIP, 0x30);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_LB_ENABLE, 1);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_TX_GAIN_FORCE, 1);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_RX_BB_GAIN_FORCE, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_IQCORR_ENABLE, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL1_CF_PAPRD_AGC2_SETTLING, 28);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL1(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL1_CF_CF_PAPRD_TRAIN_ENABLE, 1);\n\n\tif (AR_SREV_9485(ah)) {\n\t\tval = 148;\n\t} else {\n\t\tif (IS_CHAN_2GHZ(ah->curchan)) {\n\t\t\tif (AR_SREV_9462(ah) || AR_SREV_9565(ah))\n\t\t\t\tval = 145;\n\t\t\telse\n\t\t\t\tval = 147;\n\t\t} else {\n\t\t\tval = 137;\n\t\t}\n\t}\n\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL2(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL2_CF_PAPRD_INIT_RX_BB_GAIN, val);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_FINE_CORR_LEN, 4);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_COARSE_CORR_LEN, 4);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_NUM_CORR_STAGES, 7);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_MIN_LOOPBACK_DEL, 1);\n\n\tif (AR_SREV_9485(ah) ||\n\t    AR_SREV_9462(ah) ||\n\t    AR_SREV_9565(ah) ||\n\t    AR_SREV_9550(ah) ||\n\t    AR_SREV_9330(ah) ||\n\t    AR_SREV_9340(ah))\n\t\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3(ah),\n\t\t\t      AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP, -3);\n\telse\n\t\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3(ah),\n\t\t\t      AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP, -6);\n\n\tval = -10;\n\n\tif (IS_CHAN_2GHZ(ah->curchan) && !AR_SREV_9462(ah) && !AR_SREV_9565(ah))\n\t\tval = -15;\n\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_ADC_DESIRED_SIZE,\n\t\t      val);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_BBTXMIX_DISABLE, 1);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL4(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_SAFETY_DELTA, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL4(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_MIN_CORR, 400);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL4(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL4_CF_PAPRD_NUM_TRAIN_SAMPLES,\n\t\t      100);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_0_B0,\n\t\t      AR_PHY_PAPRD_PRE_POST_SCALING, 261376);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_1_B0,\n\t\t      AR_PHY_PAPRD_PRE_POST_SCALING, 248079);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_2_B0,\n\t\t      AR_PHY_PAPRD_PRE_POST_SCALING, 233759);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_3_B0,\n\t\t      AR_PHY_PAPRD_PRE_POST_SCALING, 220464);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_4_B0,\n\t\t      AR_PHY_PAPRD_PRE_POST_SCALING, 208194);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_5_B0,\n\t\t      AR_PHY_PAPRD_PRE_POST_SCALING, 196949);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_6_B0,\n\t\t      AR_PHY_PAPRD_PRE_POST_SCALING, 185706);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_PRE_POST_SCALE_7_B0,\n\t\t      AR_PHY_PAPRD_PRE_POST_SCALING, 175487);\n\treturn 0;\n}\n\nstatic void ar9003_paprd_get_gain_table(struct ath_hw *ah)\n{\n\tu32 *entry = ah->paprd_gain_table_entries;\n\tu8 *index = ah->paprd_gain_table_index;\n\tu32 reg = AR_PHY_TXGAIN_TABLE;\n\tint i;\n\n\tfor (i = 0; i < PAPRD_GAIN_TABLE_ENTRIES; i++) {\n\t\tentry[i] = REG_READ(ah, reg);\n\t\tindex[i] = (entry[i] >> 24) & 0xff;\n\t\treg += 4;\n\t}\n}\n\nstatic unsigned int ar9003_get_desired_gain(struct ath_hw *ah, int chain,\n\t\t\t\t\t    int target_power)\n{\n\tint olpc_gain_delta = 0, cl_gain_mod;\n\tint alpha_therm, alpha_volt;\n\tint therm_cal_value, volt_cal_value;\n\tint therm_value, volt_value;\n\tint thermal_gain_corr, voltage_gain_corr;\n\tint desired_scale, desired_gain = 0;\n\tu32 reg_olpc  = 0, reg_cl_gain  = 0;\n\n\tREG_CLR_BIT(ah, AR_PHY_PAPRD_TRAINER_STAT1(ah),\n\t\t    AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);\n\tdesired_scale = REG_READ_FIELD(ah, AR_PHY_TPC_12,\n\t\t\t\t       AR_PHY_TPC_12_DESIRED_SCALE_HT40_5);\n\talpha_therm = REG_READ_FIELD(ah, AR_PHY_TPC_19,\n\t\t\t\t     AR_PHY_TPC_19_ALPHA_THERM);\n\talpha_volt = REG_READ_FIELD(ah, AR_PHY_TPC_19,\n\t\t\t\t    AR_PHY_TPC_19_ALPHA_VOLT);\n\ttherm_cal_value = REG_READ_FIELD(ah, AR_PHY_TPC_18,\n\t\t\t\t\t AR_PHY_TPC_18_THERM_CAL_VALUE);\n\tvolt_cal_value = REG_READ_FIELD(ah, AR_PHY_TPC_18,\n\t\t\t\t\tAR_PHY_TPC_18_VOLT_CAL_VALUE);\n\ttherm_value = REG_READ_FIELD(ah, AR_PHY_BB_THERM_ADC_4,\n\t\t\t\t     AR_PHY_BB_THERM_ADC_4_LATEST_THERM_VALUE);\n\tvolt_value = REG_READ_FIELD(ah, AR_PHY_BB_THERM_ADC_4,\n\t\t\t\t    AR_PHY_BB_THERM_ADC_4_LATEST_VOLT_VALUE);\n\n\tswitch (chain) {\n\tcase 0:\n\t\treg_olpc = AR_PHY_TPC_11_B0;\n\t\treg_cl_gain = AR_PHY_CL_TAB_0;\n\t\tbreak;\n\tcase 1:\n\t\treg_olpc = AR_PHY_TPC_11_B1;\n\t\treg_cl_gain = AR_PHY_CL_TAB_1;\n\t\tbreak;\n\tcase 2:\n\t\treg_olpc = AR_PHY_TPC_11_B2;\n\t\treg_cl_gain = AR_PHY_CL_TAB_2;\n\t\tbreak;\n\tdefault:\n\t\tath_dbg(ath9k_hw_common(ah), CALIBRATE,\n\t\t\t\"Invalid chainmask: %d\\n\", chain);\n\t\tbreak;\n\t}\n\n\tolpc_gain_delta = REG_READ_FIELD(ah, reg_olpc,\n\t\t\t\t\t AR_PHY_TPC_11_OLPC_GAIN_DELTA);\n\tcl_gain_mod = REG_READ_FIELD(ah, reg_cl_gain,\n\t\t\t\t\t AR_PHY_CL_TAB_CL_GAIN_MOD);\n\n\tif (olpc_gain_delta >= 128)\n\t\tolpc_gain_delta = olpc_gain_delta - 256;\n\n\tthermal_gain_corr = (alpha_therm * (therm_value - therm_cal_value) +\n\t\t\t     (256 / 2)) / 256;\n\tvoltage_gain_corr = (alpha_volt * (volt_value - volt_cal_value) +\n\t\t\t     (128 / 2)) / 128;\n\tdesired_gain = target_power - olpc_gain_delta - thermal_gain_corr -\n\t    voltage_gain_corr + desired_scale + cl_gain_mod;\n\n\treturn desired_gain;\n}\n\nstatic void ar9003_tx_force_gain(struct ath_hw *ah, unsigned int gain_index)\n{\n\tint selected_gain_entry, txbb1dbgain, txbb6dbgain, txmxrgain;\n\tint padrvgnA, padrvgnB, padrvgnC, padrvgnD;\n\tu32 *gain_table_entries = ah->paprd_gain_table_entries;\n\n\tselected_gain_entry = gain_table_entries[gain_index];\n\ttxbb1dbgain = selected_gain_entry & 0x7;\n\ttxbb6dbgain = (selected_gain_entry >> 3) & 0x3;\n\ttxmxrgain = (selected_gain_entry >> 5) & 0xf;\n\tpadrvgnA = (selected_gain_entry >> 9) & 0xf;\n\tpadrvgnB = (selected_gain_entry >> 13) & 0xf;\n\tpadrvgnC = (selected_gain_entry >> 17) & 0xf;\n\tpadrvgnD = (selected_gain_entry >> 21) & 0x3;\n\n\tREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t      AR_PHY_TX_FORCED_GAIN_FORCED_TXBB1DBGAIN, txbb1dbgain);\n\tREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t      AR_PHY_TX_FORCED_GAIN_FORCED_TXBB6DBGAIN, txbb6dbgain);\n\tREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t      AR_PHY_TX_FORCED_GAIN_FORCED_TXMXRGAIN, txmxrgain);\n\tREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t      AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNA, padrvgnA);\n\tREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t      AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNB, padrvgnB);\n\tREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t      AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGNC, padrvgnC);\n\tREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t      AR_PHY_TX_FORCED_GAIN_FORCED_PADRVGND, padrvgnD);\n\tREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t      AR_PHY_TX_FORCED_GAIN_FORCED_ENABLE_PAL, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t      AR_PHY_TX_FORCED_GAIN_FORCE_TX_GAIN, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_TPC_1, AR_PHY_TPC_1_FORCED_DAC_GAIN, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_TPC_1, AR_PHY_TPC_1_FORCE_DAC_GAIN, 0);\n}\n\nstatic inline int find_expn(int num)\n{\n\treturn fls(num) - 1;\n}\n\nstatic inline int find_proper_scale(int expn, int N)\n{\n\treturn (expn > N) ? expn - 10 : 0;\n}\n\n#define NUM_BIN 23\n\nstatic bool create_pa_curve(u32 *data_L, u32 *data_U, u32 *pa_table, u16 *gain)\n{\n\tunsigned int thresh_accum_cnt;\n\tint x_est[NUM_BIN + 1], Y[NUM_BIN + 1], theta[NUM_BIN + 1];\n\tint PA_in[NUM_BIN + 1];\n\tint B1_tmp[NUM_BIN + 1], B2_tmp[NUM_BIN + 1];\n\tunsigned int B1_abs_max, B2_abs_max;\n\tint max_index, scale_factor;\n\tint y_est[NUM_BIN + 1];\n\tint x_est_fxp1_nonlin, x_tilde[NUM_BIN + 1];\n\tunsigned int x_tilde_abs;\n\tint G_fxp, Y_intercept, order_x_by_y, M, I, L, sum_y_sqr, sum_y_quad;\n\tint Q_x, Q_B1, Q_B2, beta_raw, alpha_raw, scale_B;\n\tint Q_scale_B, Q_beta, Q_alpha, alpha, beta, order_1, order_2;\n\tint order1_5x, order2_3x, order1_5x_rem, order2_3x_rem;\n\tint y5, y3, tmp;\n\tint theta_low_bin = 0;\n\tint i;\n\n\t \n\tthresh_accum_cnt = 16;\n\tscale_factor = 5;\n\tmax_index = 0;\n\tmemset(theta, 0, sizeof(theta));\n\tmemset(x_est, 0, sizeof(x_est));\n\tmemset(Y, 0, sizeof(Y));\n\tmemset(y_est, 0, sizeof(y_est));\n\tmemset(x_tilde, 0, sizeof(x_tilde));\n\n\tfor (i = 0; i < NUM_BIN; i++) {\n\t\ts32 accum_cnt, accum_tx, accum_rx, accum_ang;\n\n\t\t \n\t\taccum_cnt = data_L[i] & 0xffff;\n\n\t\tif (accum_cnt <= thresh_accum_cnt)\n\t\t\tcontinue;\n\n\t\tmax_index++;\n\n\t\t \n\t\taccum_tx = ((data_L[i] >> 16) & 0xffff) |\n\t\t    ((data_U[i] & 0x7ff) << 16);\n\n\t\t \n\t\taccum_rx = ((data_U[i] >> 11) & 0x1f) |\n\t\t    ((data_L[i + 23] & 0xffff) << 5);\n\n\t\t \n\t\taccum_ang = ((data_L[i + 23] >> 16) & 0xffff) |\n\t\t    ((data_U[i + 23] & 0x7ff) << 16);\n\n\t\taccum_tx <<= scale_factor;\n\t\taccum_rx <<= scale_factor;\n\t\tx_est[max_index] =\n\t\t\t(((accum_tx + accum_cnt) / accum_cnt) + 32) >>\n\t\t\tscale_factor;\n\n\t\tY[max_index] =\n\t\t\t((((accum_rx + accum_cnt) / accum_cnt) + 32) >>\n\t\t\t    scale_factor) +\n\t\t\t(1 << scale_factor) * i + 16;\n\n\t\tif (accum_ang >= (1 << 26))\n\t\t\taccum_ang -= 1 << 27;\n\n\t\ttheta[max_index] =\n\t\t\t((accum_ang * (1 << scale_factor)) + accum_cnt) /\n\t\t\taccum_cnt;\n\t}\n\n\t \n\tfor (i = 1; i < 6; i++)\n\t\ttheta_low_bin += theta[i];\n\n\ttheta_low_bin = theta_low_bin / 5;\n\tfor (i = 1; i < 6; i++)\n\t\ttheta[i] = theta_low_bin;\n\n\t \n\ttheta[0] = theta_low_bin;\n\tfor (i = 0; i <= max_index; i++)\n\t\ttheta[i] -= theta_low_bin;\n\n\tx_est[0] = 0;\n\tY[0] = 0;\n\tscale_factor = 8;\n\n\t \n\tif (x_est[6] == x_est[3])\n\t\treturn false;\n\n\tG_fxp =\n\t    (((Y[6] - Y[3]) * 1 << scale_factor) +\n\t     (x_est[6] - x_est[3])) / (x_est[6] - x_est[3]);\n\n\t \n\tif (G_fxp == 0)\n\t\treturn false;\n\n\tY_intercept =\n\t    (G_fxp * (x_est[0] - x_est[3]) +\n\t     (1 << scale_factor)) / (1 << scale_factor) + Y[3];\n\n\tfor (i = 0; i <= max_index; i++)\n\t\ty_est[i] = Y[i] - Y_intercept;\n\n\tfor (i = 0; i <= 3; i++) {\n\t\ty_est[i] = i * 32;\n\t\tx_est[i] = ((y_est[i] * 1 << scale_factor) + G_fxp) / G_fxp;\n\t}\n\n\tif (y_est[max_index] == 0)\n\t\treturn false;\n\n\tx_est_fxp1_nonlin =\n\t    x_est[max_index] - ((1 << scale_factor) * y_est[max_index] +\n\t\t\t\tG_fxp) / G_fxp;\n\n\torder_x_by_y =\n\t    (x_est_fxp1_nonlin + y_est[max_index]) / y_est[max_index];\n\n\tif (order_x_by_y == 0)\n\t\tM = 10;\n\telse if (order_x_by_y == 1)\n\t\tM = 9;\n\telse\n\t\tM = 8;\n\n\tI = (max_index > 15) ? 7 : max_index >> 1;\n\tL = max_index - I;\n\tscale_factor = 8;\n\tsum_y_sqr = 0;\n\tsum_y_quad = 0;\n\tx_tilde_abs = 0;\n\n\tfor (i = 0; i <= L; i++) {\n\t\tunsigned int y_sqr;\n\t\tunsigned int y_quad;\n\t\tunsigned int tmp_abs;\n\n\t\t \n\t\tif (y_est[i + I] == 0)\n\t\t\treturn false;\n\n\t\tx_est_fxp1_nonlin =\n\t\t    x_est[i + I] - ((1 << scale_factor) * y_est[i + I] +\n\t\t\t\t    G_fxp) / G_fxp;\n\n\t\tx_tilde[i] =\n\t\t    (x_est_fxp1_nonlin * (1 << M) + y_est[i + I]) / y_est[i +\n\t\t\t\t\t\t\t\t\t  I];\n\t\tx_tilde[i] =\n\t\t    (x_tilde[i] * (1 << M) + y_est[i + I]) / y_est[i + I];\n\t\tx_tilde[i] =\n\t\t    (x_tilde[i] * (1 << M) + y_est[i + I]) / y_est[i + I];\n\t\ty_sqr =\n\t\t    (y_est[i + I] * y_est[i + I] +\n\t\t     (scale_factor * scale_factor)) / (scale_factor *\n\t\t\t\t\t\t       scale_factor);\n\t\ttmp_abs = abs(x_tilde[i]);\n\t\tif (tmp_abs > x_tilde_abs)\n\t\t\tx_tilde_abs = tmp_abs;\n\n\t\ty_quad = y_sqr * y_sqr;\n\t\tsum_y_sqr = sum_y_sqr + y_sqr;\n\t\tsum_y_quad = sum_y_quad + y_quad;\n\t\tB1_tmp[i] = y_sqr * (L + 1);\n\t\tB2_tmp[i] = y_sqr;\n\t}\n\n\tB1_abs_max = 0;\n\tB2_abs_max = 0;\n\tfor (i = 0; i <= L; i++) {\n\t\tint abs_val;\n\n\t\tB1_tmp[i] -= sum_y_sqr;\n\t\tB2_tmp[i] = sum_y_quad - sum_y_sqr * B2_tmp[i];\n\n\t\tabs_val = abs(B1_tmp[i]);\n\t\tif (abs_val > B1_abs_max)\n\t\t\tB1_abs_max = abs_val;\n\n\t\tabs_val = abs(B2_tmp[i]);\n\t\tif (abs_val > B2_abs_max)\n\t\t\tB2_abs_max = abs_val;\n\t}\n\n\tQ_x = find_proper_scale(find_expn(x_tilde_abs), 10);\n\tQ_B1 = find_proper_scale(find_expn(B1_abs_max), 10);\n\tQ_B2 = find_proper_scale(find_expn(B2_abs_max), 10);\n\n\tbeta_raw = 0;\n\talpha_raw = 0;\n\tfor (i = 0; i <= L; i++) {\n\t\tx_tilde[i] = x_tilde[i] / (1 << Q_x);\n\t\tB1_tmp[i] = B1_tmp[i] / (1 << Q_B1);\n\t\tB2_tmp[i] = B2_tmp[i] / (1 << Q_B2);\n\t\tbeta_raw = beta_raw + B1_tmp[i] * x_tilde[i];\n\t\talpha_raw = alpha_raw + B2_tmp[i] * x_tilde[i];\n\t}\n\n\tscale_B =\n\t    ((sum_y_quad / scale_factor) * (L + 1) -\n\t     (sum_y_sqr / scale_factor) * sum_y_sqr) * scale_factor;\n\n\tQ_scale_B = find_proper_scale(find_expn(abs(scale_B)), 10);\n\tscale_B = scale_B / (1 << Q_scale_B);\n\tif (scale_B == 0)\n\t\treturn false;\n\tQ_beta = find_proper_scale(find_expn(abs(beta_raw)), 10);\n\tQ_alpha = find_proper_scale(find_expn(abs(alpha_raw)), 10);\n\tbeta_raw = beta_raw / (1 << Q_beta);\n\talpha_raw = alpha_raw / (1 << Q_alpha);\n\talpha = (alpha_raw << 10) / scale_B;\n\tbeta = (beta_raw << 10) / scale_B;\n\torder_1 = 3 * M - Q_x - Q_B1 - Q_beta + 10 + Q_scale_B;\n\torder_2 = 3 * M - Q_x - Q_B2 - Q_alpha + 10 + Q_scale_B;\n\torder1_5x = order_1 / 5;\n\torder2_3x = order_2 / 3;\n\torder1_5x_rem = order_1 - 5 * order1_5x;\n\torder2_3x_rem = order_2 - 3 * order2_3x;\n\n\tfor (i = 0; i < PAPRD_TABLE_SZ; i++) {\n\t\ttmp = i * 32;\n\t\ty5 = ((beta * tmp) >> 6) >> order1_5x;\n\t\ty5 = (y5 * tmp) >> order1_5x;\n\t\ty5 = (y5 * tmp) >> order1_5x;\n\t\ty5 = (y5 * tmp) >> order1_5x;\n\t\ty5 = (y5 * tmp) >> order1_5x;\n\t\ty5 = y5 >> order1_5x_rem;\n\t\ty3 = (alpha * tmp) >> order2_3x;\n\t\ty3 = (y3 * tmp) >> order2_3x;\n\t\ty3 = (y3 * tmp) >> order2_3x;\n\t\ty3 = y3 >> order2_3x_rem;\n\t\tPA_in[i] = y5 + y3 + (256 * tmp) / G_fxp;\n\n\t\tif (i >= 2) {\n\t\t\ttmp = PA_in[i] - PA_in[i - 1];\n\t\t\tif (tmp < 0)\n\t\t\t\tPA_in[i] =\n\t\t\t\t    PA_in[i - 1] + (PA_in[i - 1] -\n\t\t\t\t\t\t    PA_in[i - 2]);\n\t\t}\n\n\t\tPA_in[i] = (PA_in[i] < 1400) ? PA_in[i] : 1400;\n\t}\n\n\tbeta_raw = 0;\n\talpha_raw = 0;\n\n\tfor (i = 0; i <= L; i++) {\n\t\tint theta_tilde =\n\t\t    ((theta[i + I] << M) + y_est[i + I]) / y_est[i + I];\n\t\ttheta_tilde =\n\t\t    ((theta_tilde << M) + y_est[i + I]) / y_est[i + I];\n\t\ttheta_tilde =\n\t\t    ((theta_tilde << M) + y_est[i + I]) / y_est[i + I];\n\t\tbeta_raw = beta_raw + B1_tmp[i] * theta_tilde;\n\t\talpha_raw = alpha_raw + B2_tmp[i] * theta_tilde;\n\t}\n\n\tQ_beta = find_proper_scale(find_expn(abs(beta_raw)), 10);\n\tQ_alpha = find_proper_scale(find_expn(abs(alpha_raw)), 10);\n\tbeta_raw = beta_raw / (1 << Q_beta);\n\talpha_raw = alpha_raw / (1 << Q_alpha);\n\n\talpha = (alpha_raw << 10) / scale_B;\n\tbeta = (beta_raw << 10) / scale_B;\n\torder_1 = 3 * M - Q_x - Q_B1 - Q_beta + 10 + Q_scale_B + 5;\n\torder_2 = 3 * M - Q_x - Q_B2 - Q_alpha + 10 + Q_scale_B + 5;\n\torder1_5x = order_1 / 5;\n\torder2_3x = order_2 / 3;\n\torder1_5x_rem = order_1 - 5 * order1_5x;\n\torder2_3x_rem = order_2 - 3 * order2_3x;\n\n\tfor (i = 0; i < PAPRD_TABLE_SZ; i++) {\n\t\tint PA_angle;\n\n\t\t \n\t\tif (i == 4)\n\t\t\tcontinue;\n\n\t\ttmp = i * 32;\n\t\tif (beta > 0)\n\t\t\ty5 = (((beta * tmp - 64) >> 6) -\n\t\t\t      (1 << order1_5x)) / (1 << order1_5x);\n\t\telse\n\t\t\ty5 = ((((beta * tmp - 64) >> 6) +\n\t\t\t       (1 << order1_5x)) / (1 << order1_5x));\n\n\t\ty5 = (y5 * tmp) / (1 << order1_5x);\n\t\ty5 = (y5 * tmp) / (1 << order1_5x);\n\t\ty5 = (y5 * tmp) / (1 << order1_5x);\n\t\ty5 = (y5 * tmp) / (1 << order1_5x);\n\t\ty5 = y5 / (1 << order1_5x_rem);\n\n\t\tif (beta > 0)\n\t\t\ty3 = (alpha * tmp -\n\t\t\t      (1 << order2_3x)) / (1 << order2_3x);\n\t\telse\n\t\t\ty3 = (alpha * tmp +\n\t\t\t      (1 << order2_3x)) / (1 << order2_3x);\n\t\ty3 = (y3 * tmp) / (1 << order2_3x);\n\t\ty3 = (y3 * tmp) / (1 << order2_3x);\n\t\ty3 = y3 / (1 << order2_3x_rem);\n\n\t\tif (i < 4) {\n\t\t\tPA_angle = 0;\n\t\t} else {\n\t\t\tPA_angle = y5 + y3;\n\t\t\tif (PA_angle < -150)\n\t\t\t\tPA_angle = -150;\n\t\t\telse if (PA_angle > 150)\n\t\t\t\tPA_angle = 150;\n\t\t}\n\n\t\tpa_table[i] = ((PA_in[i] & 0x7ff) << 11) + (PA_angle & 0x7ff);\n\t\tif (i == 5) {\n\t\t\tPA_angle = (PA_angle + 2) >> 1;\n\t\t\tpa_table[i - 1] = ((PA_in[i - 1] & 0x7ff) << 11) +\n\t\t\t    (PA_angle & 0x7ff);\n\t\t}\n\t}\n\n\t*gain = G_fxp;\n\treturn true;\n}\n\nvoid ar9003_paprd_populate_single_table(struct ath_hw *ah,\n\t\t\t\t\tstruct ath9k_hw_cal_data *caldata,\n\t\t\t\t\tint chain)\n{\n\tu32 *paprd_table_val = caldata->pa_table[chain];\n\tu32 small_signal_gain = caldata->small_signal_gain[chain];\n\tu32 training_power = ah->paprd_training_power;\n\tu32 reg = 0;\n\tint i;\n\n\tif (chain == 0)\n\t\treg = AR_PHY_PAPRD_MEM_TAB_B0;\n\telse if (chain == 1)\n\t\treg = AR_PHY_PAPRD_MEM_TAB_B1;\n\telse if (chain == 2)\n\t\treg = AR_PHY_PAPRD_MEM_TAB_B2;\n\n\tfor (i = 0; i < PAPRD_TABLE_SZ; i++) {\n\t\tREG_WRITE(ah, reg, paprd_table_val[i]);\n\t\treg = reg + 4;\n\t}\n\n\tif (chain == 0)\n\t\treg = AR_PHY_PA_GAIN123_B0;\n\telse if (chain == 1)\n\t\treg = AR_PHY_PA_GAIN123_B1;\n\telse\n\t\treg = AR_PHY_PA_GAIN123_B2;\n\n\tREG_RMW_FIELD(ah, reg, AR_PHY_PA_GAIN123_PA_GAIN1, small_signal_gain);\n\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL1_B0,\n\t\t      AR_PHY_PAPRD_CTRL1_PAPRD_POWER_AT_AM2AM_CAL,\n\t\t      training_power);\n\n\tif (ah->caps.tx_chainmask & BIT(1))\n\t\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL1_B1,\n\t\t\t      AR_PHY_PAPRD_CTRL1_PAPRD_POWER_AT_AM2AM_CAL,\n\t\t\t      training_power);\n\n\tif (ah->caps.tx_chainmask & BIT(2))\n\t\t \n\t\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_CTRL1_B2,\n\t\t\t      AR_PHY_PAPRD_CTRL1_PAPRD_POWER_AT_AM2AM_CAL,\n\t\t\t      training_power);\n}\nEXPORT_SYMBOL(ar9003_paprd_populate_single_table);\n\nvoid ar9003_paprd_setup_gain_table(struct ath_hw *ah, int chain)\n{\n\tunsigned int i, desired_gain, gain_index;\n\tunsigned int train_power = ah->paprd_training_power;\n\n\tdesired_gain = ar9003_get_desired_gain(ah, chain, train_power);\n\n\tgain_index = 0;\n\tfor (i = 0; i < PAPRD_GAIN_TABLE_ENTRIES; i++) {\n\t\tif (ah->paprd_gain_table_index[i] >= desired_gain)\n\t\t\tbreak;\n\t\tgain_index++;\n\t}\n\n\tar9003_tx_force_gain(ah, gain_index);\n\n\tREG_CLR_BIT(ah, AR_PHY_PAPRD_TRAINER_STAT1(ah),\n\t\t\tAR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);\n}\nEXPORT_SYMBOL(ar9003_paprd_setup_gain_table);\n\nstatic bool ar9003_paprd_retrain_pa_in(struct ath_hw *ah,\n\t\t\t\t       struct ath9k_hw_cal_data *caldata,\n\t\t\t\t       int chain)\n{\n\tu32 *pa_in = caldata->pa_table[chain];\n\tint capdiv_offset, quick_drop_offset;\n\tint capdiv2g, quick_drop;\n\tint count = 0;\n\tint i;\n\n\tif (!AR_SREV_9485(ah) && !AR_SREV_9330(ah))\n\t\treturn false;\n\n\tcapdiv2g = REG_READ_FIELD(ah, AR_PHY_65NM_CH0_TXRF3,\n\t\t\t\t  AR_PHY_65NM_CH0_TXRF3_CAPDIV2G);\n\n\tquick_drop = REG_READ_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3(ah),\n\t\t\t\t    AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP);\n\n\tif (quick_drop)\n\t\tquick_drop -= 0x40;\n\n\tfor (i = 0; i < NUM_BIN + 1; i++) {\n\t\tif (pa_in[i] == 1400)\n\t\t\tcount++;\n\t}\n\n\tif (AR_SREV_9485(ah)) {\n\t\tif (pa_in[23] < 800) {\n\t\t\tcapdiv_offset = (int)((1000 - pa_in[23] + 75) / 150);\n\t\t\tcapdiv2g += capdiv_offset;\n\t\t\tif (capdiv2g > 7) {\n\t\t\t\tcapdiv2g = 7;\n\t\t\t\tif (pa_in[23] < 600) {\n\t\t\t\t\tquick_drop++;\n\t\t\t\t\tif (quick_drop > 0)\n\t\t\t\t\t\tquick_drop = 0;\n\t\t\t\t}\n\t\t\t}\n\t\t} else if (pa_in[23] == 1400) {\n\t\t\tquick_drop_offset = min_t(int, count / 3, 2);\n\t\t\tquick_drop += quick_drop_offset;\n\t\t\tcapdiv2g += quick_drop_offset / 2;\n\n\t\t\tif (capdiv2g > 7)\n\t\t\t\tcapdiv2g = 7;\n\n\t\t\tif (quick_drop > 0) {\n\t\t\t\tquick_drop = 0;\n\t\t\t\tcapdiv2g -= quick_drop_offset;\n\t\t\t\tif (capdiv2g < 0)\n\t\t\t\t\tcapdiv2g = 0;\n\t\t\t}\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t} else if (AR_SREV_9330(ah)) {\n\t\tif (pa_in[23] < 1000) {\n\t\t\tcapdiv_offset = (1000 - pa_in[23]) / 100;\n\t\t\tcapdiv2g += capdiv_offset;\n\t\t\tif (capdiv_offset > 3) {\n\t\t\t\tcapdiv_offset = 1;\n\t\t\t\tquick_drop--;\n\t\t\t}\n\n\t\t\tcapdiv2g += capdiv_offset;\n\t\t\tif (capdiv2g > 6)\n\t\t\t\tcapdiv2g = 6;\n\t\t\tif (quick_drop < -4)\n\t\t\t\tquick_drop = -4;\n\t\t} else if (pa_in[23] == 1400) {\n\t\t\tif (count > 3) {\n\t\t\t\tquick_drop++;\n\t\t\t\tcapdiv2g -= count / 4;\n\t\t\t\tif (quick_drop > -2)\n\t\t\t\t\tquick_drop = -2;\n\t\t\t} else {\n\t\t\t\tcapdiv2g--;\n\t\t\t}\n\n\t\t\tif (capdiv2g < 0)\n\t\t\t\tcapdiv2g = 0;\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tREG_RMW_FIELD(ah, AR_PHY_65NM_CH0_TXRF3,\n\t\t      AR_PHY_65NM_CH0_TXRF3_CAPDIV2G, capdiv2g);\n\tREG_RMW_FIELD(ah, AR_PHY_PAPRD_TRAINER_CNTL3(ah),\n\t\t      AR_PHY_PAPRD_TRAINER_CNTL3_CF_PAPRD_QUICK_DROP,\n\t\t      quick_drop);\n\n\treturn true;\n}\n\nint ar9003_paprd_create_curve(struct ath_hw *ah,\n\t\t\t      struct ath9k_hw_cal_data *caldata, int chain)\n{\n\tu16 *small_signal_gain = &caldata->small_signal_gain[chain];\n\tu32 *pa_table = caldata->pa_table[chain];\n\tu32 *data_L, *data_U;\n\tint i, status = 0;\n\tu32 *buf;\n\tu32 reg;\n\n\tmemset(caldata->pa_table[chain], 0, sizeof(caldata->pa_table[chain]));\n\n\tbuf = kmalloc_array(2 * 48, sizeof(u32), GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\tdata_L = &buf[0];\n\tdata_U = &buf[48];\n\n\tREG_CLR_BIT(ah, AR_PHY_CHAN_INFO_MEMORY(ah),\n\t\t    AR_PHY_CHAN_INFO_MEMORY_CHANINFOMEM_S2_READ);\n\n\treg = AR_PHY_CHAN_INFO_TAB_0;\n\tfor (i = 0; i < 48; i++)\n\t\tdata_L[i] = REG_READ(ah, reg + (i << 2));\n\n\tREG_SET_BIT(ah, AR_PHY_CHAN_INFO_MEMORY(ah),\n\t\t    AR_PHY_CHAN_INFO_MEMORY_CHANINFOMEM_S2_READ);\n\n\tfor (i = 0; i < 48; i++)\n\t\tdata_U[i] = REG_READ(ah, reg + (i << 2));\n\n\tif (!create_pa_curve(data_L, data_U, pa_table, small_signal_gain))\n\t\tstatus = -2;\n\n\tif (ar9003_paprd_retrain_pa_in(ah, caldata, chain))\n\t\tstatus = -EINPROGRESS;\n\n\tREG_CLR_BIT(ah, AR_PHY_PAPRD_TRAINER_STAT1(ah),\n\t\t    AR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);\n\n\tkfree(buf);\n\n\treturn status;\n}\nEXPORT_SYMBOL(ar9003_paprd_create_curve);\n\nint ar9003_paprd_init_table(struct ath_hw *ah)\n{\n\tint ret;\n\n\tret = ar9003_paprd_setup_single_table(ah);\n\tif (ret < 0)\n\t    return ret;\n\n\tar9003_paprd_get_gain_table(ah);\n\treturn 0;\n}\nEXPORT_SYMBOL(ar9003_paprd_init_table);\n\nbool ar9003_paprd_is_done(struct ath_hw *ah)\n{\n\tint paprd_done, agc2_pwr;\n\n\tpaprd_done = REG_READ_FIELD(ah, AR_PHY_PAPRD_TRAINER_STAT1(ah),\n\t\t\t\tAR_PHY_PAPRD_TRAINER_STAT1_PAPRD_TRAIN_DONE);\n\n\tif (AR_SREV_9485(ah))\n\t\tgoto exit;\n\n\tif (paprd_done == 0x1) {\n\t\tagc2_pwr = REG_READ_FIELD(ah, AR_PHY_PAPRD_TRAINER_STAT1(ah),\n\t\t\t\tAR_PHY_PAPRD_TRAINER_STAT1_PAPRD_AGC2_PWR);\n\n\t\tath_dbg(ath9k_hw_common(ah), CALIBRATE,\n\t\t\t\"AGC2_PWR = 0x%x training done = 0x%x\\n\",\n\t\t\tagc2_pwr, paprd_done);\n\t \n\t\tif (agc2_pwr <= PAPRD_IDEAL_AGC2_PWR_RANGE)\n\t\t\tpaprd_done = 0;\n\t}\nexit:\n\treturn !!paprd_done;\n}\nEXPORT_SYMBOL(ar9003_paprd_is_done);\n\nbool ar9003_is_paprd_enabled(struct ath_hw *ah)\n{\n\tif ((ah->caps.hw_caps & ATH9K_HW_CAP_PAPRD) && ah->config.enable_paprd)\n\t\treturn true;\n\n\treturn false;\n}\nEXPORT_SYMBOL(ar9003_is_paprd_enabled);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}