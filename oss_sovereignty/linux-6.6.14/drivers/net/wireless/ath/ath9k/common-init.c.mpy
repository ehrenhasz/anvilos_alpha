{
  "module_name": "common-init.c",
  "hash_id": "ac406f46647e2a7994bd94c92422dfb2facc0458fbc1fdc3ea021199d535750e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/common-init.c",
  "human_readable_source": " \n\n \n\n#include \"common.h\"\n\n#define CHAN2G(_freq, _idx)  { \\\n\t.band = NL80211_BAND_2GHZ, \\\n\t.center_freq = (_freq), \\\n\t.hw_value = (_idx), \\\n\t.max_power = 20, \\\n}\n\n#define CHAN5G(_freq, _idx) { \\\n\t.band = NL80211_BAND_5GHZ, \\\n\t.center_freq = (_freq), \\\n\t.hw_value = (_idx), \\\n\t.max_power = 20, \\\n}\n\n \nstatic const struct ieee80211_channel ath9k_2ghz_chantable[] = {\n\tCHAN2G(2412, 0),  \n\tCHAN2G(2417, 1),  \n\tCHAN2G(2422, 2),  \n\tCHAN2G(2427, 3),  \n\tCHAN2G(2432, 4),  \n\tCHAN2G(2437, 5),  \n\tCHAN2G(2442, 6),  \n\tCHAN2G(2447, 7),  \n\tCHAN2G(2452, 8),  \n\tCHAN2G(2457, 9),  \n\tCHAN2G(2462, 10),  \n\tCHAN2G(2467, 11),  \n\tCHAN2G(2472, 12),  \n\tCHAN2G(2484, 13),  \n};\n\n \nstatic const struct ieee80211_channel ath9k_5ghz_chantable[] = {\n\t \n\tCHAN5G(5180, 14),  \n\tCHAN5G(5200, 15),  \n\tCHAN5G(5220, 16),  \n\tCHAN5G(5240, 17),  \n\t \n\tCHAN5G(5260, 18),  \n\tCHAN5G(5280, 19),  \n\tCHAN5G(5300, 20),  \n\tCHAN5G(5320, 21),  \n\t \n\tCHAN5G(5500, 22),  \n\tCHAN5G(5520, 23),  \n\tCHAN5G(5540, 24),  \n\tCHAN5G(5560, 25),  \n\tCHAN5G(5580, 26),  \n\tCHAN5G(5600, 27),  \n\tCHAN5G(5620, 28),  \n\tCHAN5G(5640, 29),  \n\tCHAN5G(5660, 30),  \n\tCHAN5G(5680, 31),  \n\tCHAN5G(5700, 32),  \n\t \n\tCHAN5G(5745, 33),  \n\tCHAN5G(5765, 34),  \n\tCHAN5G(5785, 35),  \n\tCHAN5G(5805, 36),  \n\tCHAN5G(5825, 37),  \n};\n\n \n#define SHPCHECK(__hw_rate, __flags) \\\n\t((__flags & IEEE80211_RATE_SHORT_PREAMBLE) ? (__hw_rate | 0x04 ) : 0)\n\n#define RATE(_bitrate, _hw_rate, _flags) {              \\\n\t.bitrate        = (_bitrate),                   \\\n\t.flags          = (_flags),                     \\\n\t.hw_value       = (_hw_rate),                   \\\n\t.hw_value_short = (SHPCHECK(_hw_rate, _flags))  \\\n}\n\nstatic struct ieee80211_rate ath9k_legacy_rates[] = {\n\tRATE(10, 0x1b, 0),\n\tRATE(20, 0x1a, IEEE80211_RATE_SHORT_PREAMBLE),\n\tRATE(55, 0x19, IEEE80211_RATE_SHORT_PREAMBLE),\n\tRATE(110, 0x18, IEEE80211_RATE_SHORT_PREAMBLE),\n\tRATE(60, 0x0b, (IEEE80211_RATE_SUPPORTS_5MHZ |\n\t\t\tIEEE80211_RATE_SUPPORTS_10MHZ)),\n\tRATE(90, 0x0f, (IEEE80211_RATE_SUPPORTS_5MHZ |\n\t\t\tIEEE80211_RATE_SUPPORTS_10MHZ)),\n\tRATE(120, 0x0a, (IEEE80211_RATE_SUPPORTS_5MHZ |\n\t\t\t IEEE80211_RATE_SUPPORTS_10MHZ)),\n\tRATE(180, 0x0e, (IEEE80211_RATE_SUPPORTS_5MHZ |\n\t\t\t IEEE80211_RATE_SUPPORTS_10MHZ)),\n\tRATE(240, 0x09, (IEEE80211_RATE_SUPPORTS_5MHZ |\n\t\t\t IEEE80211_RATE_SUPPORTS_10MHZ)),\n\tRATE(360, 0x0d, (IEEE80211_RATE_SUPPORTS_5MHZ |\n\t\t\t IEEE80211_RATE_SUPPORTS_10MHZ)),\n\tRATE(480, 0x08, (IEEE80211_RATE_SUPPORTS_5MHZ |\n\t\t\t IEEE80211_RATE_SUPPORTS_10MHZ)),\n\tRATE(540, 0x0c, (IEEE80211_RATE_SUPPORTS_5MHZ |\n\t\t\t IEEE80211_RATE_SUPPORTS_10MHZ)),\n};\n\nint ath9k_cmn_init_channels_rates(struct ath_common *common)\n{\n\tstruct ath_hw *ah = (struct ath_hw *)common->ah;\n\tvoid *channels;\n\n\tBUILD_BUG_ON(ARRAY_SIZE(ath9k_2ghz_chantable) +\n\t\t     ARRAY_SIZE(ath9k_5ghz_chantable) !=\n\t\t     ATH9K_NUM_CHANNELS);\n\n\tif (ah->caps.hw_caps & ATH9K_HW_CAP_2GHZ) {\n\t\tchannels = devm_kzalloc(ah->dev,\n\t\t\tsizeof(ath9k_2ghz_chantable), GFP_KERNEL);\n\t\tif (!channels)\n\t\t    return -ENOMEM;\n\n\t\tmemcpy(channels, ath9k_2ghz_chantable,\n\t\t       sizeof(ath9k_2ghz_chantable));\n\t\tcommon->sbands[NL80211_BAND_2GHZ].channels = channels;\n\t\tcommon->sbands[NL80211_BAND_2GHZ].band = NL80211_BAND_2GHZ;\n\t\tcommon->sbands[NL80211_BAND_2GHZ].n_channels =\n\t\t\tARRAY_SIZE(ath9k_2ghz_chantable);\n\t\tcommon->sbands[NL80211_BAND_2GHZ].bitrates = ath9k_legacy_rates;\n\t\tcommon->sbands[NL80211_BAND_2GHZ].n_bitrates =\n\t\t\tARRAY_SIZE(ath9k_legacy_rates);\n\t}\n\n\tif (ah->caps.hw_caps & ATH9K_HW_CAP_5GHZ) {\n\t\tchannels = devm_kzalloc(ah->dev,\n\t\t\tsizeof(ath9k_5ghz_chantable), GFP_KERNEL);\n\t\tif (!channels)\n\t\t\treturn -ENOMEM;\n\n\t\tmemcpy(channels, ath9k_5ghz_chantable,\n\t\t       sizeof(ath9k_5ghz_chantable));\n\t\tcommon->sbands[NL80211_BAND_5GHZ].channels = channels;\n\t\tcommon->sbands[NL80211_BAND_5GHZ].band = NL80211_BAND_5GHZ;\n\t\tcommon->sbands[NL80211_BAND_5GHZ].n_channels =\n\t\t\tARRAY_SIZE(ath9k_5ghz_chantable);\n\t\tcommon->sbands[NL80211_BAND_5GHZ].bitrates =\n\t\t\tath9k_legacy_rates + 4;\n\t\tcommon->sbands[NL80211_BAND_5GHZ].n_bitrates =\n\t\t\tARRAY_SIZE(ath9k_legacy_rates) - 4;\n\t}\n\treturn 0;\n}\nEXPORT_SYMBOL(ath9k_cmn_init_channels_rates);\n\nvoid ath9k_cmn_setup_ht_cap(struct ath_hw *ah,\n\t\t\t    struct ieee80211_sta_ht_cap *ht_info)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tu8 tx_streams, rx_streams;\n\tint i, max_streams;\n\n\tht_info->ht_supported = true;\n\tht_info->cap = IEEE80211_HT_CAP_SUP_WIDTH_20_40 |\n\t\t       IEEE80211_HT_CAP_SM_PS |\n\t\t       IEEE80211_HT_CAP_SGI_40 |\n\t\t       IEEE80211_HT_CAP_DSSSCCK40;\n\n\tif (ah->caps.hw_caps & ATH9K_HW_CAP_LDPC)\n\t\tht_info->cap |= IEEE80211_HT_CAP_LDPC_CODING;\n\n\tif (ah->caps.hw_caps & ATH9K_HW_CAP_SGI_20)\n\t\tht_info->cap |= IEEE80211_HT_CAP_SGI_20;\n\n\tht_info->ampdu_factor = IEEE80211_HT_MAX_AMPDU_64K;\n\tht_info->ampdu_density = IEEE80211_HT_MPDU_DENSITY_8;\n\n\tif (AR_SREV_9271(ah) || AR_SREV_9330(ah) || AR_SREV_9485(ah) || AR_SREV_9565(ah))\n\t\tmax_streams = 1;\n\telse if (AR_SREV_9462(ah))\n\t\tmax_streams = 2;\n\telse if (AR_SREV_9300_20_OR_LATER(ah))\n\t\tmax_streams = 3;\n\telse\n\t\tmax_streams = 2;\n\n\tif (AR_SREV_9280_20_OR_LATER(ah)) {\n\t\tif (max_streams >= 2)\n\t\t\tht_info->cap |= IEEE80211_HT_CAP_TX_STBC;\n\t\tht_info->cap |= (1 << IEEE80211_HT_CAP_RX_STBC_SHIFT);\n\t}\n\n\t \n\tmemset(&ht_info->mcs, 0, sizeof(ht_info->mcs));\n\ttx_streams = ath9k_cmn_count_streams(ah->txchainmask, max_streams);\n\trx_streams = ath9k_cmn_count_streams(ah->rxchainmask, max_streams);\n\n\tath_dbg(common, CONFIG, \"TX streams %d, RX streams: %d\\n\",\n\t\ttx_streams, rx_streams);\n\n\tif (tx_streams != rx_streams) {\n\t\tht_info->mcs.tx_params |= IEEE80211_HT_MCS_TX_RX_DIFF;\n\t\tht_info->mcs.tx_params |= ((tx_streams - 1) <<\n\t\t\t\tIEEE80211_HT_MCS_TX_MAX_STREAMS_SHIFT);\n\t}\n\n\tfor (i = 0; i < rx_streams; i++)\n\t\tht_info->mcs.rx_mask[i] = 0xff;\n\n\tht_info->mcs.tx_params |= IEEE80211_HT_MCS_TX_DEFINED;\n}\nEXPORT_SYMBOL(ath9k_cmn_setup_ht_cap);\n\nvoid ath9k_cmn_reload_chainmask(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\n\tif (!(ah->caps.hw_caps & ATH9K_HW_CAP_HT))\n\t\treturn;\n\n\tif (ah->caps.hw_caps & ATH9K_HW_CAP_2GHZ)\n\t\tath9k_cmn_setup_ht_cap(ah,\n\t\t\t&common->sbands[NL80211_BAND_2GHZ].ht_cap);\n\tif (ah->caps.hw_caps & ATH9K_HW_CAP_5GHZ)\n\t\tath9k_cmn_setup_ht_cap(ah,\n\t\t\t&common->sbands[NL80211_BAND_5GHZ].ht_cap);\n}\nEXPORT_SYMBOL(ath9k_cmn_reload_chainmask);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}