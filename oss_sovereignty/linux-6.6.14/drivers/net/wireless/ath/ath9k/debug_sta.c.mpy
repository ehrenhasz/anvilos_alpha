{
  "module_name": "debug_sta.c",
  "hash_id": "08890cef32ce80d61f09c359ddfcff6d0d397af1addbb26a8cbb5b5b0e4e5f1f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/debug_sta.c",
  "human_readable_source": " \n\n#include \"ath9k.h\"\n\n \n \n \n\nstatic ssize_t read_file_node_aggr(struct file *file, char __user *user_buf,\n\t\t\t\t   size_t count, loff_t *ppos)\n{\n\tstruct ath_node *an = file->private_data;\n\tstruct ath_softc *sc = an->sc;\n\tstruct ath_atx_tid *tid;\n\tstruct ath_txq *txq;\n\tu32 len = 0, size = 4096;\n\tchar *buf;\n\tsize_t retval;\n\tint tidno;\n\n\tbuf = kzalloc(size, GFP_KERNEL);\n\tif (buf == NULL)\n\t\treturn -ENOMEM;\n\n\tif (!an->sta->deflink.ht_cap.ht_supported) {\n\t\tlen = scnprintf(buf, size, \"%s\\n\",\n\t\t\t\t\"HT not supported\");\n\t\tgoto exit;\n\t}\n\n\tlen = scnprintf(buf, size, \"Max-AMPDU: %d\\n\",\n\t\t\tan->maxampdu);\n\tlen += scnprintf(buf + len, size - len, \"MPDU Density: %d\\n\\n\",\n\t\t\t an->mpdudensity);\n\n\tlen += scnprintf(buf + len, size - len,\n\t\t\t \"\\n%3s%11s%10s%10s%10s%10s%9s%6s%8s\\n\",\n\t\t\t \"TID\", \"SEQ_START\", \"SEQ_NEXT\", \"BAW_SIZE\",\n\t\t\t \"BAW_HEAD\", \"BAW_TAIL\", \"BAR_IDX\", \"SCHED\", \"PAUSED\");\n\n\tfor (tidno = 0; tidno < IEEE80211_NUM_TIDS; tidno++) {\n\t\ttid = ath_node_to_tid(an, tidno);\n\t\ttxq = tid->txq;\n\t\tath_txq_lock(sc, txq);\n\t\tif (tid->active) {\n\t\t\tlen += scnprintf(buf + len, size - len,\n\t\t\t\t\t \"%3d%11d%10d%10d%10d%10d%9d%6d\\n\",\n\t\t\t\t\t tid->tidno,\n\t\t\t\t\t tid->seq_start,\n\t\t\t\t\t tid->seq_next,\n\t\t\t\t\t tid->baw_size,\n\t\t\t\t\t tid->baw_head,\n\t\t\t\t\t tid->baw_tail,\n\t\t\t\t\t tid->bar_index,\n\t\t\t\t\t !list_empty(&tid->list));\n\t\t}\n\t\tath_txq_unlock(sc, txq);\n\t}\nexit:\n\tretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\n\tkfree(buf);\n\n\treturn retval;\n}\n\nstatic const struct file_operations fops_node_aggr = {\n\t.read = read_file_node_aggr,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\n \n \n \n\nvoid ath_debug_rate_stats(struct ath_softc *sc,\n\t\t\t  struct ath_rx_status *rs,\n\t\t\t  struct sk_buff *skb)\n{\n\tstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *) skb->data;\n\tstruct ath_hw *ah = sc->sc_ah;\n\tstruct ieee80211_rx_status *rxs;\n\tstruct ath_rx_rate_stats *rstats;\n\tstruct ieee80211_sta *sta;\n\tstruct ath_node *an;\n\n\tif (!ieee80211_is_data(hdr->frame_control))\n\t\treturn;\n\n\trcu_read_lock();\n\n\tsta = ieee80211_find_sta_by_ifaddr(sc->hw, hdr->addr2, NULL);\n\tif (!sta)\n\t\tgoto exit;\n\n\tan = (struct ath_node *) sta->drv_priv;\n\trstats = &an->rx_rate_stats;\n\trxs = IEEE80211_SKB_RXCB(skb);\n\n\tif (IS_HT_RATE(rs->rs_rate)) {\n\t\tif (rxs->rate_idx >= ARRAY_SIZE(rstats->ht_stats))\n\t\t\tgoto exit;\n\n\t\tif (rxs->bw == RATE_INFO_BW_40)\n\t\t\trstats->ht_stats[rxs->rate_idx].ht40_cnt++;\n\t\telse\n\t\t\trstats->ht_stats[rxs->rate_idx].ht20_cnt++;\n\n\t\tif (rxs->enc_flags & RX_ENC_FLAG_SHORT_GI)\n\t\t\trstats->ht_stats[rxs->rate_idx].sgi_cnt++;\n\t\telse\n\t\t\trstats->ht_stats[rxs->rate_idx].lgi_cnt++;\n\n\t\tgoto exit;\n\t}\n\n\tif (IS_CCK_RATE(rs->rs_rate)) {\n\t\tif (rxs->enc_flags & RX_ENC_FLAG_SHORTPRE)\n\t\t\trstats->cck_stats[rxs->rate_idx].cck_sp_cnt++;\n\t\telse\n\t\t\trstats->cck_stats[rxs->rate_idx].cck_lp_cnt++;\n\n\t\tgoto exit;\n\t}\n\n\tif (IS_OFDM_RATE(rs->rs_rate)) {\n\t\tif (ah->curchan->chan->band == NL80211_BAND_2GHZ)\n\t\t\trstats->ofdm_stats[rxs->rate_idx - 4].ofdm_cnt++;\n\t\telse\n\t\t\trstats->ofdm_stats[rxs->rate_idx].ofdm_cnt++;\n\t}\nexit:\n\trcu_read_unlock();\n}\n\n#define PRINT_CCK_RATE(str, i, sp)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\tlen += scnprintf(buf + len, size - len,\t\t\t\\\n\t\t\t \"%11s : %10u\\n\",\t\t\t\t\\\n\t\t\t str,\t\t\t\t\t\t\\\n\t\t\t (sp) ? rstats->cck_stats[i].cck_sp_cnt :\t\\\n\t\t\t rstats->cck_stats[i].cck_lp_cnt);\t\t\\\n\t} while (0)\n\n#define PRINT_OFDM_RATE(str, i)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\\\n\t\tlen += scnprintf(buf + len, size - len,\t\t\\\n\t\t\t \"%11s : %10u\\n\",\t\t\t\\\n\t\t\t str,\t\t\t\t\t\\\n\t\t\t rstats->ofdm_stats[i].ofdm_cnt);\t\\\n\t} while (0)\n\nstatic ssize_t read_file_node_recv(struct file *file, char __user *user_buf,\n\t\t\t\t   size_t count, loff_t *ppos)\n{\n\tstruct ath_node *an = file->private_data;\n\tstruct ath_softc *sc = an->sc;\n\tstruct ath_hw *ah = sc->sc_ah;\n\tstruct ath_rx_rate_stats *rstats;\n\tstruct ieee80211_sta *sta = an->sta;\n\tenum nl80211_band band;\n\tu32 len = 0, size = 4096;\n\tchar *buf;\n\tsize_t retval;\n\tint i;\n\n\tbuf = kzalloc(size, GFP_KERNEL);\n\tif (buf == NULL)\n\t\treturn -ENOMEM;\n\n\tband = ah->curchan->chan->band;\n\trstats = &an->rx_rate_stats;\n\n\tif (!sta->deflink.ht_cap.ht_supported)\n\t\tgoto legacy;\n\n\tlen += scnprintf(buf + len, size - len,\n\t\t\t \"%24s%10s%10s%10s\\n\",\n\t\t\t \"HT20\", \"HT40\", \"SGI\", \"LGI\");\n\n\tfor (i = 0; i < 24; i++) {\n\t\tlen += scnprintf(buf + len, size - len,\n\t\t\t\t \"%8s%3u : %10u%10u%10u%10u\\n\",\n\t\t\t\t \"MCS\", i,\n\t\t\t\t rstats->ht_stats[i].ht20_cnt,\n\t\t\t\t rstats->ht_stats[i].ht40_cnt,\n\t\t\t\t rstats->ht_stats[i].sgi_cnt,\n\t\t\t\t rstats->ht_stats[i].lgi_cnt);\n\t}\n\n\tlen += scnprintf(buf + len, size - len, \"\\n\");\n\nlegacy:\n\tif (band == NL80211_BAND_2GHZ) {\n\t\tPRINT_CCK_RATE(\"CCK-1M/LP\", 0, false);\n\t\tPRINT_CCK_RATE(\"CCK-2M/LP\", 1, false);\n\t\tPRINT_CCK_RATE(\"CCK-5.5M/LP\", 2, false);\n\t\tPRINT_CCK_RATE(\"CCK-11M/LP\", 3, false);\n\n\t\tPRINT_CCK_RATE(\"CCK-2M/SP\", 1, true);\n\t\tPRINT_CCK_RATE(\"CCK-5.5M/SP\", 2, true);\n\t\tPRINT_CCK_RATE(\"CCK-11M/SP\", 3, true);\n\t}\n\n\tPRINT_OFDM_RATE(\"OFDM-6M\", 0);\n\tPRINT_OFDM_RATE(\"OFDM-9M\", 1);\n\tPRINT_OFDM_RATE(\"OFDM-12M\", 2);\n\tPRINT_OFDM_RATE(\"OFDM-18M\", 3);\n\tPRINT_OFDM_RATE(\"OFDM-24M\", 4);\n\tPRINT_OFDM_RATE(\"OFDM-36M\", 5);\n\tPRINT_OFDM_RATE(\"OFDM-48M\", 6);\n\tPRINT_OFDM_RATE(\"OFDM-54M\", 7);\n\n\tretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\n\tkfree(buf);\n\n\treturn retval;\n}\n\n#undef PRINT_OFDM_RATE\n#undef PRINT_CCK_RATE\n\nstatic const struct file_operations fops_node_recv = {\n\t.read = read_file_node_recv,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\nvoid ath9k_sta_add_debugfs(struct ieee80211_hw *hw,\n\t\t\t   struct ieee80211_vif *vif,\n\t\t\t   struct ieee80211_sta *sta,\n\t\t\t   struct dentry *dir)\n{\n\tstruct ath_node *an = (struct ath_node *)sta->drv_priv;\n\n\tdebugfs_create_file(\"node_aggr\", 0444, dir, an, &fops_node_aggr);\n\tdebugfs_create_file(\"node_recv\", 0444, dir, an, &fops_node_recv);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}