{
  "module_name": "ar9002_mac.c",
  "hash_id": "de13e36843aa15d1a39dcc183b53f4c37be7001545c145508ad6c9658b017d4f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/ar9002_mac.c",
  "human_readable_source": " \n\n#include \"hw.h\"\n#include <linux/export.h>\n\n#define AR_BufLen           0x00000fff\n\nstatic void ar9002_hw_rx_enable(struct ath_hw *ah)\n{\n\tREG_WRITE(ah, AR_CR, AR_CR_RXE(ah));\n}\n\nstatic void ar9002_hw_set_desc_link(void *ds, u32 ds_link)\n{\n\t((struct ath_desc*) ds)->ds_link = ds_link;\n}\n\nstatic bool ar9002_hw_get_isr(struct ath_hw *ah, enum ath9k_int *masked,\n\t\t\t      u32 *sync_cause_p)\n{\n\tu32 isr = 0;\n\tu32 mask2 = 0;\n\tstruct ath9k_hw_capabilities *pCap = &ah->caps;\n\tu32 sync_cause = 0;\n\tbool fatal_int = false;\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\n\tif (!AR_SREV_9100(ah)) {\n\t\tif (REG_READ(ah, AR_INTR_ASYNC_CAUSE(ah)) & AR_INTR_MAC_IRQ) {\n\t\t\tif ((REG_READ(ah, AR_RTC_STATUS(ah)) & AR_RTC_STATUS_M(ah))\n\t\t\t    == AR_RTC_STATUS_ON) {\n\t\t\t\tisr = REG_READ(ah, AR_ISR);\n\t\t\t}\n\t\t}\n\n\t\tsync_cause = REG_READ(ah, AR_INTR_SYNC_CAUSE(ah)) &\n\t\t\tAR_INTR_SYNC_DEFAULT;\n\n\t\t*masked = 0;\n\n\t\tif (!isr && !sync_cause)\n\t\t\treturn false;\n\t} else {\n\t\t*masked = 0;\n\t\tisr = REG_READ(ah, AR_ISR);\n\t}\n\n\tif (isr) {\n\t\tif (isr & AR_ISR_BCNMISC) {\n\t\t\tu32 isr2;\n\t\t\tisr2 = REG_READ(ah, AR_ISR_S2);\n\t\t\tif (isr2 & AR_ISR_S2_TIM)\n\t\t\t\tmask2 |= ATH9K_INT_TIM;\n\t\t\tif (isr2 & AR_ISR_S2_DTIM)\n\t\t\t\tmask2 |= ATH9K_INT_DTIM;\n\t\t\tif (isr2 & AR_ISR_S2_DTIMSYNC)\n\t\t\t\tmask2 |= ATH9K_INT_DTIMSYNC;\n\t\t\tif (isr2 & (AR_ISR_S2_CABEND))\n\t\t\t\tmask2 |= ATH9K_INT_CABEND;\n\t\t\tif (isr2 & AR_ISR_S2_GTT)\n\t\t\t\tmask2 |= ATH9K_INT_GTT;\n\t\t\tif (isr2 & AR_ISR_S2_CST)\n\t\t\t\tmask2 |= ATH9K_INT_CST;\n\t\t\tif (isr2 & AR_ISR_S2_TSFOOR)\n\t\t\t\tmask2 |= ATH9K_INT_TSFOOR;\n\n\t\t\tif (!(pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)) {\n\t\t\t\tREG_WRITE(ah, AR_ISR_S2, isr2);\n\t\t\t\tisr &= ~AR_ISR_BCNMISC;\n\t\t\t}\n\t\t}\n\n\t\tif (pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)\n\t\t\tisr = REG_READ(ah, AR_ISR_RAC);\n\n\t\tif (isr == 0xffffffff) {\n\t\t\t*masked = 0;\n\t\t\treturn false;\n\t\t}\n\n\t\t*masked = isr & ATH9K_INT_COMMON;\n\n\t\tif (isr & (AR_ISR_RXMINTR | AR_ISR_RXINTM |\n\t\t\t   AR_ISR_RXOK | AR_ISR_RXERR))\n\t\t\t*masked |= ATH9K_INT_RX;\n\n\t\tif (isr &\n\t\t    (AR_ISR_TXOK | AR_ISR_TXDESC | AR_ISR_TXERR |\n\t\t     AR_ISR_TXEOL)) {\n\t\t\tu32 s0_s, s1_s;\n\n\t\t\t*masked |= ATH9K_INT_TX;\n\n\t\t\tif (pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED) {\n\t\t\t\ts0_s = REG_READ(ah, AR_ISR_S0_S);\n\t\t\t\ts1_s = REG_READ(ah, AR_ISR_S1_S);\n\t\t\t} else {\n\t\t\t\ts0_s = REG_READ(ah, AR_ISR_S0);\n\t\t\t\tREG_WRITE(ah, AR_ISR_S0, s0_s);\n\t\t\t\ts1_s = REG_READ(ah, AR_ISR_S1);\n\t\t\t\tREG_WRITE(ah, AR_ISR_S1, s1_s);\n\n\t\t\t\tisr &= ~(AR_ISR_TXOK |\n\t\t\t\t\t AR_ISR_TXDESC |\n\t\t\t\t\t AR_ISR_TXERR |\n\t\t\t\t\t AR_ISR_TXEOL);\n\t\t\t}\n\n\t\t\tah->intr_txqs = MS(s0_s, AR_ISR_S0_QCU_TXOK);\n\t\t\tah->intr_txqs |= MS(s0_s, AR_ISR_S0_QCU_TXDESC);\n\t\t\tah->intr_txqs |= MS(s1_s, AR_ISR_S1_QCU_TXERR);\n\t\t\tah->intr_txqs |= MS(s1_s, AR_ISR_S1_QCU_TXEOL);\n\t\t}\n\n\t\tif (isr & AR_ISR_RXORN) {\n\t\t\tath_dbg(common, INTERRUPT,\n\t\t\t\t\"receive FIFO overrun interrupt\\n\");\n\t\t}\n\n\t\t*masked |= mask2;\n\t}\n\n\tif (!AR_SREV_9100(ah) && (isr & AR_ISR_GENTMR)) {\n\t\tu32 s5_s;\n\n\t\tif (pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED) {\n\t\t\ts5_s = REG_READ(ah, AR_ISR_S5_S(ah));\n\t\t} else {\n\t\t\ts5_s = REG_READ(ah, AR_ISR_S5);\n\t\t}\n\n\t\tah->intr_gen_timer_trigger =\n\t\t\t\tMS(s5_s, AR_ISR_S5_GENTIMER_TRIG);\n\n\t\tah->intr_gen_timer_thresh =\n\t\t\tMS(s5_s, AR_ISR_S5_GENTIMER_THRESH);\n\n\t\tif (ah->intr_gen_timer_trigger)\n\t\t\t*masked |= ATH9K_INT_GENTIMER;\n\n\t\tif ((s5_s & AR_ISR_S5_TIM_TIMER) &&\n\t\t    !(pCap->hw_caps & ATH9K_HW_CAP_AUTOSLEEP))\n\t\t\t*masked |= ATH9K_INT_TIM_TIMER;\n\n\t\tif (!(pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)) {\n\t\t\tREG_WRITE(ah, AR_ISR_S5, s5_s);\n\t\t\tisr &= ~AR_ISR_GENTMR;\n\t\t}\n\t}\n\n\tif (!(pCap->hw_caps & ATH9K_HW_CAP_RAC_SUPPORTED)) {\n\t\tREG_WRITE(ah, AR_ISR, isr);\n\t\tREG_READ(ah, AR_ISR);\n\t}\n\n\tif (AR_SREV_9100(ah))\n\t\treturn true;\n\n\tif (sync_cause) {\n\t\tif (sync_cause_p)\n\t\t\t*sync_cause_p = sync_cause;\n\t\tfatal_int =\n\t\t\t(sync_cause &\n\t\t\t (AR_INTR_SYNC_HOST1_FATAL | AR_INTR_SYNC_HOST1_PERR))\n\t\t\t? true : false;\n\n\t\tif (fatal_int) {\n\t\t\tif (sync_cause & AR_INTR_SYNC_HOST1_FATAL) {\n\t\t\t\tath_dbg(common, ANY,\n\t\t\t\t\t\"received PCI FATAL interrupt\\n\");\n\t\t\t}\n\t\t\tif (sync_cause & AR_INTR_SYNC_HOST1_PERR) {\n\t\t\t\tath_dbg(common, ANY,\n\t\t\t\t\t\"received PCI PERR interrupt\\n\");\n\t\t\t}\n\t\t\t*masked |= ATH9K_INT_FATAL;\n\t\t}\n\t\tif (sync_cause & AR_INTR_SYNC_RADM_CPL_TIMEOUT) {\n\t\t\tath_dbg(common, INTERRUPT,\n\t\t\t\t\"AR_INTR_SYNC_RADM_CPL_TIMEOUT\\n\");\n\t\t\tREG_WRITE(ah, AR_RC, AR_RC_HOSTIF);\n\t\t\tREG_WRITE(ah, AR_RC, 0);\n\t\t\t*masked |= ATH9K_INT_FATAL;\n\t\t}\n\t\tif (sync_cause & AR_INTR_SYNC_LOCAL_TIMEOUT) {\n\t\t\tath_dbg(common, INTERRUPT,\n\t\t\t\t\"AR_INTR_SYNC_LOCAL_TIMEOUT\\n\");\n\t\t}\n\n\t\tREG_WRITE(ah, AR_INTR_SYNC_CAUSE_CLR(ah), sync_cause);\n\t\t(void) REG_READ(ah, AR_INTR_SYNC_CAUSE_CLR(ah));\n\t}\n\n\treturn true;\n}\n\nstatic void\nar9002_set_txdesc(struct ath_hw *ah, void *ds, struct ath_tx_info *i)\n{\n\tstruct ar5416_desc *ads = AR5416DESC(ds);\n\tu32 ctl1, ctl6;\n\n\tads->ds_txstatus0 = ads->ds_txstatus1 = 0;\n\tads->ds_txstatus2 = ads->ds_txstatus3 = 0;\n\tads->ds_txstatus4 = ads->ds_txstatus5 = 0;\n\tads->ds_txstatus6 = ads->ds_txstatus7 = 0;\n\tads->ds_txstatus8 = ads->ds_txstatus9 = 0;\n\n\tWRITE_ONCE(ads->ds_link, i->link);\n\tWRITE_ONCE(ads->ds_data, i->buf_addr[0]);\n\n\tctl1 = i->buf_len[0] | (i->is_last ? 0 : AR_TxMore);\n\tctl6 = SM(i->keytype, AR_EncrType);\n\n\tif (AR_SREV_9285(ah)) {\n\t\tads->ds_ctl8 = 0;\n\t\tads->ds_ctl9 = 0;\n\t\tads->ds_ctl10 = 0;\n\t\tads->ds_ctl11 = 0;\n\t}\n\n\tif ((i->is_first || i->is_last) &&\n\t    i->aggr != AGGR_BUF_MIDDLE && i->aggr != AGGR_BUF_LAST) {\n\t\tWRITE_ONCE(ads->ds_ctl2, set11nTries(i->rates, 0)\n\t\t\t| set11nTries(i->rates, 1)\n\t\t\t| set11nTries(i->rates, 2)\n\t\t\t| set11nTries(i->rates, 3)\n\t\t\t| (i->dur_update ? AR_DurUpdateEna : 0)\n\t\t\t| SM(0, AR_BurstDur));\n\n\t\tWRITE_ONCE(ads->ds_ctl3, set11nRate(i->rates, 0)\n\t\t\t| set11nRate(i->rates, 1)\n\t\t\t| set11nRate(i->rates, 2)\n\t\t\t| set11nRate(i->rates, 3));\n\t} else {\n\t\tWRITE_ONCE(ads->ds_ctl2, 0);\n\t\tWRITE_ONCE(ads->ds_ctl3, 0);\n\t}\n\n\tif (!i->is_first) {\n\t\tWRITE_ONCE(ads->ds_ctl0, 0);\n\t\tWRITE_ONCE(ads->ds_ctl1, ctl1);\n\t\tWRITE_ONCE(ads->ds_ctl6, ctl6);\n\t\treturn;\n\t}\n\n\tctl1 |= (i->keyix != ATH9K_TXKEYIX_INVALID ? SM(i->keyix, AR_DestIdx) : 0)\n\t\t| SM(i->type, AR_FrameType)\n\t\t| (i->flags & ATH9K_TXDESC_NOACK ? AR_NoAck : 0)\n\t\t| (i->flags & ATH9K_TXDESC_EXT_ONLY ? AR_ExtOnly : 0)\n\t\t| (i->flags & ATH9K_TXDESC_EXT_AND_CTL ? AR_ExtAndCtl : 0);\n\n\tswitch (i->aggr) {\n\tcase AGGR_BUF_FIRST:\n\t\tctl6 |= SM(i->aggr_len, AR_AggrLen);\n\t\tfallthrough;\n\tcase AGGR_BUF_MIDDLE:\n\t\tctl1 |= AR_IsAggr | AR_MoreAggr;\n\t\tctl6 |= SM(i->ndelim, AR_PadDelim);\n\t\tbreak;\n\tcase AGGR_BUF_LAST:\n\t\tctl1 |= AR_IsAggr;\n\t\tbreak;\n\tcase AGGR_BUF_NONE:\n\t\tbreak;\n\t}\n\n\tWRITE_ONCE(ads->ds_ctl0, (i->pkt_len & AR_FrameLen)\n\t\t| (i->flags & ATH9K_TXDESC_VMF ? AR_VirtMoreFrag : 0)\n\t\t| SM(i->txpower[0], AR_XmitPower0)\n\t\t| (i->flags & ATH9K_TXDESC_VEOL ? AR_VEOL : 0)\n\t\t| (i->flags & ATH9K_TXDESC_INTREQ ? AR_TxIntrReq : 0)\n\t\t| (i->keyix != ATH9K_TXKEYIX_INVALID ? AR_DestIdxValid : 0)\n\t\t| (i->flags & ATH9K_TXDESC_CLRDMASK ? AR_ClrDestMask : 0)\n\t\t| (i->flags & ATH9K_TXDESC_RTSENA ? AR_RTSEnable :\n\t\t   (i->flags & ATH9K_TXDESC_CTSENA ? AR_CTSEnable : 0)));\n\n\tWRITE_ONCE(ads->ds_ctl1, ctl1);\n\tWRITE_ONCE(ads->ds_ctl6, ctl6);\n\n\tif (i->aggr == AGGR_BUF_MIDDLE || i->aggr == AGGR_BUF_LAST)\n\t\treturn;\n\n\tWRITE_ONCE(ads->ds_ctl4, set11nPktDurRTSCTS(i->rates, 0)\n\t\t| set11nPktDurRTSCTS(i->rates, 1));\n\n\tWRITE_ONCE(ads->ds_ctl5, set11nPktDurRTSCTS(i->rates, 2)\n\t\t| set11nPktDurRTSCTS(i->rates, 3));\n\n\tWRITE_ONCE(ads->ds_ctl7,\n\t\t  set11nRateFlags(i->rates, 0) | set11nChainSel(i->rates, 0)\n\t\t| set11nRateFlags(i->rates, 1) | set11nChainSel(i->rates, 1)\n\t\t| set11nRateFlags(i->rates, 2) | set11nChainSel(i->rates, 2)\n\t\t| set11nRateFlags(i->rates, 3) | set11nChainSel(i->rates, 3)\n\t\t| SM(i->rtscts_rate, AR_RTSCTSRate));\n\n\tWRITE_ONCE(ads->ds_ctl9, SM(i->txpower[1], AR_XmitPower1));\n\tWRITE_ONCE(ads->ds_ctl10, SM(i->txpower[2], AR_XmitPower2));\n\tWRITE_ONCE(ads->ds_ctl11, SM(i->txpower[3], AR_XmitPower3));\n}\n\nstatic int ar9002_hw_proc_txdesc(struct ath_hw *ah, void *ds,\n\t\t\t\t struct ath_tx_status *ts)\n{\n\tstruct ar5416_desc *ads = AR5416DESC(ds);\n\tu32 status;\n\n\tstatus = READ_ONCE(ads->ds_txstatus9);\n\tif ((status & AR_TxDone) == 0)\n\t\treturn -EINPROGRESS;\n\n\tts->ts_tstamp = ads->AR_SendTimestamp;\n\tts->ts_status = 0;\n\tts->ts_flags = 0;\n\n\tif (status & AR_TxOpExceeded)\n\t\tts->ts_status |= ATH9K_TXERR_XTXOP;\n\tts->tid = MS(status, AR_TxTid);\n\tts->ts_rateindex = MS(status, AR_FinalTxIdx);\n\tts->ts_seqnum = MS(status, AR_SeqNum);\n\n\tstatus = READ_ONCE(ads->ds_txstatus0);\n\tts->ts_rssi_ctl0 = MS(status, AR_TxRSSIAnt00);\n\tts->ts_rssi_ctl1 = MS(status, AR_TxRSSIAnt01);\n\tts->ts_rssi_ctl2 = MS(status, AR_TxRSSIAnt02);\n\tif (status & AR_TxBaStatus) {\n\t\tts->ts_flags |= ATH9K_TX_BA;\n\t\tts->ba_low = ads->AR_BaBitmapLow;\n\t\tts->ba_high = ads->AR_BaBitmapHigh;\n\t}\n\n\tstatus = READ_ONCE(ads->ds_txstatus1);\n\tif (status & AR_FrmXmitOK)\n\t\tts->ts_status |= ATH9K_TX_ACKED;\n\telse {\n\t\tif (status & AR_ExcessiveRetries)\n\t\t\tts->ts_status |= ATH9K_TXERR_XRETRY;\n\t\tif (status & AR_Filtered)\n\t\t\tts->ts_status |= ATH9K_TXERR_FILT;\n\t\tif (status & AR_FIFOUnderrun) {\n\t\t\tts->ts_status |= ATH9K_TXERR_FIFO;\n\t\t\tath9k_hw_updatetxtriglevel(ah, true);\n\t\t}\n\t}\n\tif (status & AR_TxTimerExpired)\n\t\tts->ts_status |= ATH9K_TXERR_TIMER_EXPIRED;\n\tif (status & AR_DescCfgErr)\n\t\tts->ts_flags |= ATH9K_TX_DESC_CFG_ERR;\n\tif (status & AR_TxDataUnderrun) {\n\t\tts->ts_flags |= ATH9K_TX_DATA_UNDERRUN;\n\t\tath9k_hw_updatetxtriglevel(ah, true);\n\t}\n\tif (status & AR_TxDelimUnderrun) {\n\t\tts->ts_flags |= ATH9K_TX_DELIM_UNDERRUN;\n\t\tath9k_hw_updatetxtriglevel(ah, true);\n\t}\n\tts->ts_shortretry = MS(status, AR_RTSFailCnt);\n\tts->ts_longretry = MS(status, AR_DataFailCnt);\n\tts->ts_virtcol = MS(status, AR_VirtRetryCnt);\n\n\tstatus = READ_ONCE(ads->ds_txstatus5);\n\tts->ts_rssi = MS(status, AR_TxRSSICombined);\n\tts->ts_rssi_ext0 = MS(status, AR_TxRSSIAnt10);\n\tts->ts_rssi_ext1 = MS(status, AR_TxRSSIAnt11);\n\tts->ts_rssi_ext2 = MS(status, AR_TxRSSIAnt12);\n\n\tts->evm0 = ads->AR_TxEVM0;\n\tts->evm1 = ads->AR_TxEVM1;\n\tts->evm2 = ads->AR_TxEVM2;\n\n\treturn 0;\n}\n\nstatic int ar9002_hw_get_duration(struct ath_hw *ah, const void *ds, int index)\n{\n\tstruct ar5416_desc *ads = AR5416DESC(ds);\n\n\tswitch (index) {\n\tcase 0:\n\t\treturn MS(READ_ONCE(ads->ds_ctl4), AR_PacketDur0);\n\tcase 1:\n\t\treturn MS(READ_ONCE(ads->ds_ctl4), AR_PacketDur1);\n\tcase 2:\n\t\treturn MS(READ_ONCE(ads->ds_ctl5), AR_PacketDur2);\n\tcase 3:\n\t\treturn MS(READ_ONCE(ads->ds_ctl5), AR_PacketDur3);\n\tdefault:\n\t\treturn -1;\n\t}\n}\n\nvoid ath9k_hw_setuprxdesc(struct ath_hw *ah, struct ath_desc *ds,\n\t\t\t  u32 size, u32 flags)\n{\n\tstruct ar5416_desc *ads = AR5416DESC(ds);\n\n\tads->ds_ctl1 = size & AR_BufLen;\n\tif (flags & ATH9K_RXDESC_INTREQ)\n\t\tads->ds_ctl1 |= AR_RxIntrReq;\n\n\tmemset(&ads->u.rx, 0, sizeof(ads->u.rx));\n}\nEXPORT_SYMBOL(ath9k_hw_setuprxdesc);\n\nvoid ar9002_hw_attach_mac_ops(struct ath_hw *ah)\n{\n\tstruct ath_hw_ops *ops = ath9k_hw_ops(ah);\n\n\tops->rx_enable = ar9002_hw_rx_enable;\n\tops->set_desc_link = ar9002_hw_set_desc_link;\n\tops->get_isr = ar9002_hw_get_isr;\n\tops->set_txdesc = ar9002_set_txdesc;\n\tops->proc_txdesc = ar9002_hw_proc_txdesc;\n\tops->get_duration = ar9002_hw_get_duration;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}