{
  "module_name": "ar9003_phy.c",
  "hash_id": "8cd5c00c3a4570405d9965f41cf74c73fd5097e21d465f95bf6aebbf09a187c8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/ar9003_phy.c",
  "human_readable_source": " \n\n#include <linux/export.h>\n#include \"hw.h\"\n#include \"ar9003_phy.h\"\n#include \"ar9003_eeprom.h\"\n\n#define AR9300_OFDM_RATES\t8\n#define AR9300_HT_SS_RATES\t8\n#define AR9300_HT_DS_RATES\t8\n#define AR9300_HT_TS_RATES\t8\n\n#define AR9300_11NA_OFDM_SHIFT\t\t0\n#define AR9300_11NA_HT_SS_SHIFT\t\t8\n#define AR9300_11NA_HT_DS_SHIFT\t\t16\n#define AR9300_11NA_HT_TS_SHIFT\t\t24\n\n#define AR9300_11NG_OFDM_SHIFT\t\t4\n#define AR9300_11NG_HT_SS_SHIFT\t\t12\n#define AR9300_11NG_HT_DS_SHIFT\t\t20\n#define AR9300_11NG_HT_TS_SHIFT\t\t28\n\nstatic const int firstep_table[] =\n \n\t{ -4, -2,  0,  2,  4,  6,  8, 10, 12 };  \n\nstatic const int cycpwrThr1_table[] =\n \n\t{ -6, -4, -2,  0,  2,  4,  6,  8 };      \n\n \nstatic const int m1ThreshLow_off = 127;\nstatic const int m2ThreshLow_off = 127;\nstatic const int m1Thresh_off = 127;\nstatic const int m2Thresh_off = 127;\nstatic const int m2CountThr_off =  31;\nstatic const int m2CountThrLow_off =  63;\nstatic const int m1ThreshLowExt_off = 127;\nstatic const int m2ThreshLowExt_off = 127;\nstatic const int m1ThreshExt_off = 127;\nstatic const int m2ThreshExt_off = 127;\n\nstatic const u8 ofdm2pwr[] = {\n\tALL_TARGET_LEGACY_6_24,\n\tALL_TARGET_LEGACY_6_24,\n\tALL_TARGET_LEGACY_6_24,\n\tALL_TARGET_LEGACY_6_24,\n\tALL_TARGET_LEGACY_6_24,\n\tALL_TARGET_LEGACY_36,\n\tALL_TARGET_LEGACY_48,\n\tALL_TARGET_LEGACY_54\n};\n\nstatic const u8 mcs2pwr_ht20[] = {\n\tALL_TARGET_HT20_0_8_16,\n\tALL_TARGET_HT20_1_3_9_11_17_19,\n\tALL_TARGET_HT20_1_3_9_11_17_19,\n\tALL_TARGET_HT20_1_3_9_11_17_19,\n\tALL_TARGET_HT20_4,\n\tALL_TARGET_HT20_5,\n\tALL_TARGET_HT20_6,\n\tALL_TARGET_HT20_7,\n\tALL_TARGET_HT20_0_8_16,\n\tALL_TARGET_HT20_1_3_9_11_17_19,\n\tALL_TARGET_HT20_1_3_9_11_17_19,\n\tALL_TARGET_HT20_1_3_9_11_17_19,\n\tALL_TARGET_HT20_12,\n\tALL_TARGET_HT20_13,\n\tALL_TARGET_HT20_14,\n\tALL_TARGET_HT20_15,\n\tALL_TARGET_HT20_0_8_16,\n\tALL_TARGET_HT20_1_3_9_11_17_19,\n\tALL_TARGET_HT20_1_3_9_11_17_19,\n\tALL_TARGET_HT20_1_3_9_11_17_19,\n\tALL_TARGET_HT20_20,\n\tALL_TARGET_HT20_21,\n\tALL_TARGET_HT20_22,\n\tALL_TARGET_HT20_23\n};\n\nstatic const u8 mcs2pwr_ht40[] = {\n\tALL_TARGET_HT40_0_8_16,\n\tALL_TARGET_HT40_1_3_9_11_17_19,\n\tALL_TARGET_HT40_1_3_9_11_17_19,\n\tALL_TARGET_HT40_1_3_9_11_17_19,\n\tALL_TARGET_HT40_4,\n\tALL_TARGET_HT40_5,\n\tALL_TARGET_HT40_6,\n\tALL_TARGET_HT40_7,\n\tALL_TARGET_HT40_0_8_16,\n\tALL_TARGET_HT40_1_3_9_11_17_19,\n\tALL_TARGET_HT40_1_3_9_11_17_19,\n\tALL_TARGET_HT40_1_3_9_11_17_19,\n\tALL_TARGET_HT40_12,\n\tALL_TARGET_HT40_13,\n\tALL_TARGET_HT40_14,\n\tALL_TARGET_HT40_15,\n\tALL_TARGET_HT40_0_8_16,\n\tALL_TARGET_HT40_1_3_9_11_17_19,\n\tALL_TARGET_HT40_1_3_9_11_17_19,\n\tALL_TARGET_HT40_1_3_9_11_17_19,\n\tALL_TARGET_HT40_20,\n\tALL_TARGET_HT40_21,\n\tALL_TARGET_HT40_22,\n\tALL_TARGET_HT40_23,\n};\n\n \nstatic int ar9003_hw_set_channel(struct ath_hw *ah, struct ath9k_channel *chan)\n{\n\tu16 bMode, fracMode = 0, aModeRefSel = 0;\n\tu32 freq, chan_frac, div, channelSel = 0, reg32 = 0;\n\tstruct chan_centers centers;\n\tint loadSynthChannel;\n\n\tath9k_hw_get_channel_centers(ah, chan, &centers);\n\tfreq = centers.synth_center;\n\n\tif (freq < 4800) {      \n\t\tif (AR_SREV_9330(ah) || AR_SREV_9485(ah) ||\n\t\t    AR_SREV_9531(ah) || AR_SREV_9550(ah) ||\n\t\t    AR_SREV_9561(ah) || AR_SREV_9565(ah)) {\n\t\t\tif (ah->is_clk_25mhz)\n\t\t\t\tdiv = 75;\n\t\t\telse\n\t\t\t\tdiv = 120;\n\n\t\t\tchannelSel = (freq * 4) / div;\n\t\t\tchan_frac = (((freq * 4) % div) * 0x20000) / div;\n\t\t\tchannelSel = (channelSel << 17) | chan_frac;\n\t\t} else if (AR_SREV_9340(ah)) {\n\t\t\tif (ah->is_clk_25mhz) {\n\t\t\t\tchannelSel = (freq * 2) / 75;\n\t\t\t\tchan_frac = (((freq * 2) % 75) * 0x20000) / 75;\n\t\t\t\tchannelSel = (channelSel << 17) | chan_frac;\n\t\t\t} else {\n\t\t\t\tchannelSel = CHANSEL_2G(freq) >> 1;\n\t\t\t}\n\t\t} else {\n\t\t\tchannelSel = CHANSEL_2G(freq);\n\t\t}\n\t\t \n\t\tbMode = 1;\n\t} else {\n\t\tif ((AR_SREV_9340(ah) || AR_SREV_9550(ah) ||\n\t\t     AR_SREV_9531(ah) || AR_SREV_9561(ah)) &&\n\t\t    ah->is_clk_25mhz) {\n\t\t\tchannelSel = freq / 75;\n\t\t\tchan_frac = ((freq % 75) * 0x20000) / 75;\n\t\t\tchannelSel = (channelSel << 17) | chan_frac;\n\t\t} else {\n\t\t\tchannelSel = CHANSEL_5G(freq);\n\t\t\t \n\t\t\tchannelSel >>= 1;\n\t\t}\n\t\t \n\t\tbMode = 0;\n\t}\n\n\t \n\tfracMode = 1;\n\taModeRefSel = 0;\n\tloadSynthChannel = 0;\n\n\treg32 = (bMode << 29);\n\tREG_WRITE(ah, AR_PHY_SYNTH_CONTROL, reg32);\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_65NM_CH0_SYNTH4,\n\t\t      AR_PHY_SYNTH4_LONG_SHIFT_SELECT, 1);\n\n\t \n\treg32 = (channelSel << 2) | (fracMode << 30) |\n\t\t(aModeRefSel << 28) | (loadSynthChannel << 31);\n\tREG_WRITE(ah, AR_PHY_65NM_CH0_SYNTH7, reg32);\n\n\t \n\tloadSynthChannel = 1;\n\treg32 = (channelSel << 2) | (fracMode << 30) |\n\t\t(aModeRefSel << 28) | (loadSynthChannel << 31);\n\tREG_WRITE(ah, AR_PHY_65NM_CH0_SYNTH7, reg32);\n\n\tah->curchan = chan;\n\n\treturn 0;\n}\n\n \nstatic void ar9003_hw_spur_mitigate_mrc_cck(struct ath_hw *ah,\n\t\t\t\t\t    struct ath9k_channel *chan)\n{\n\tstatic const u32 spur_freq[4] = { 2420, 2440, 2464, 2480 };\n\tint cur_bb_spur, negative = 0, cck_spur_freq;\n\tint i;\n\tint range, max_spur_cnts, synth_freq;\n\tu8 *spur_fbin_ptr = ar9003_get_spur_chan_ptr(ah, IS_CHAN_2GHZ(chan));\n\n\t \n\n\tif (AR_SREV_9485(ah) || AR_SREV_9340(ah) || AR_SREV_9330(ah) ||\n\t    AR_SREV_9550(ah) || AR_SREV_9561(ah)) {\n\t\tif (spur_fbin_ptr[0] == 0)  \n\t\t\treturn;\n\t\tmax_spur_cnts = 5;\n\t\tif (IS_CHAN_HT40(chan)) {\n\t\t\trange = 19;\n\t\t\tif (REG_READ_FIELD(ah, AR_PHY_GEN_CTRL,\n\t\t\t\t\t   AR_PHY_GC_DYN2040_PRI_CH) == 0)\n\t\t\t\tsynth_freq = chan->channel + 10;\n\t\t\telse\n\t\t\t\tsynth_freq = chan->channel - 10;\n\t\t} else {\n\t\t\trange = 10;\n\t\t\tsynth_freq = chan->channel;\n\t\t}\n\t} else {\n\t\trange = AR_SREV_9462(ah) ? 5 : 10;\n\t\tmax_spur_cnts = 4;\n\t\tsynth_freq = chan->channel;\n\t}\n\n\tfor (i = 0; i < max_spur_cnts; i++) {\n\t\tif (AR_SREV_9462(ah) && (i == 0 || i == 3))\n\t\t\tcontinue;\n\n\t\tnegative = 0;\n\t\tif (AR_SREV_9485(ah) || AR_SREV_9340(ah) || AR_SREV_9330(ah) ||\n\t\t    AR_SREV_9550(ah) || AR_SREV_9561(ah))\n\t\t\tcur_bb_spur = ath9k_hw_fbin2freq(spur_fbin_ptr[i],\n\t\t\t\t\t\t\t IS_CHAN_2GHZ(chan));\n\t\telse\n\t\t\tcur_bb_spur = spur_freq[i];\n\n\t\tcur_bb_spur -= synth_freq;\n\t\tif (cur_bb_spur < 0) {\n\t\t\tnegative = 1;\n\t\t\tcur_bb_spur = -cur_bb_spur;\n\t\t}\n\t\tif (cur_bb_spur < range) {\n\t\t\tcck_spur_freq = (int)((cur_bb_spur << 19) / 11);\n\n\t\t\tif (negative == 1)\n\t\t\t\tcck_spur_freq = -cck_spur_freq;\n\n\t\t\tcck_spur_freq = cck_spur_freq & 0xfffff;\n\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t\t\t      AR_PHY_AGC_CONTROL_YCOK_MAX, 0x7);\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\n\t\t\t\t      AR_PHY_CCK_SPUR_MIT_SPUR_RSSI_THR, 0x7f);\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\n\t\t\t\t      AR_PHY_CCK_SPUR_MIT_SPUR_FILTER_TYPE,\n\t\t\t\t      0x2);\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\n\t\t\t\t      AR_PHY_CCK_SPUR_MIT_USE_CCK_SPUR_MIT,\n\t\t\t\t      0x1);\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\n\t\t\t\t      AR_PHY_CCK_SPUR_MIT_CCK_SPUR_FREQ,\n\t\t\t\t      cck_spur_freq);\n\n\t\t\treturn;\n\t\t}\n\t}\n\n\tREG_RMW_FIELD(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t      AR_PHY_AGC_CONTROL_YCOK_MAX, 0x5);\n\tREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\n\t\t      AR_PHY_CCK_SPUR_MIT_USE_CCK_SPUR_MIT, 0x0);\n\tREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\n\t\t      AR_PHY_CCK_SPUR_MIT_CCK_SPUR_FREQ, 0x0);\n}\n\n \nstatic void ar9003_hw_spur_ofdm_clear(struct ath_hw *ah)\n{\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING4,\n\t\t      AR_PHY_TIMING4_ENABLE_SPUR_FILTER, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING11,\n\t\t      AR_PHY_TIMING11_SPUR_FREQ_SD, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING11,\n\t\t      AR_PHY_TIMING11_SPUR_DELTA_PHASE, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\n\t\t      AR_PHY_SFCORR_EXT_SPUR_SUBCHANNEL_SD, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING11,\n\t\t      AR_PHY_TIMING11_USE_SPUR_FILTER_IN_AGC, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING11,\n\t\t      AR_PHY_TIMING11_USE_SPUR_FILTER_IN_SELFCOR, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING4,\n\t\t      AR_PHY_TIMING4_ENABLE_SPUR_RSSI, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\n\t\t      AR_PHY_SPUR_REG_EN_VIT_SPUR_RSSI, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\n\t\t      AR_PHY_SPUR_REG_ENABLE_NF_RSSI_SPUR_MIT, 0);\n\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\n\t\t      AR_PHY_SPUR_REG_ENABLE_MASK_PPM, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING4,\n\t\t      AR_PHY_TIMING4_ENABLE_PILOT_MASK, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING4,\n\t\t      AR_PHY_TIMING4_ENABLE_CHAN_MASK, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\n\t\t      AR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_IDX_A, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_A(ah),\n\t\t      AR_PHY_SPUR_MASK_A_CF_PUNC_MASK_IDX_A, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\n\t\t      AR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_IDX_A, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\n\t\t      AR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_A, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\n\t\t      AR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_A, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_A(ah),\n\t\t      AR_PHY_SPUR_MASK_A_CF_PUNC_MASK_A, 0);\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\n\t\t      AR_PHY_SPUR_REG_MASK_RATE_CNTL, 0);\n}\n\nstatic void ar9003_hw_spur_ofdm(struct ath_hw *ah,\n\t\t\t\tint freq_offset,\n\t\t\t\tint spur_freq_sd,\n\t\t\t\tint spur_delta_phase,\n\t\t\t\tint spur_subchannel_sd,\n\t\t\t\tint range,\n\t\t\t\tint synth_freq)\n{\n\tint mask_index = 0;\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_TIMING4,\n\t\t AR_PHY_TIMING4_ENABLE_SPUR_FILTER, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING11,\n\t\t      AR_PHY_TIMING11_SPUR_FREQ_SD, spur_freq_sd);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING11,\n\t\t      AR_PHY_TIMING11_SPUR_DELTA_PHASE, spur_delta_phase);\n\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\n\t\t      AR_PHY_SFCORR_EXT_SPUR_SUBCHANNEL_SD, spur_subchannel_sd);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING11,\n\t\t      AR_PHY_TIMING11_USE_SPUR_FILTER_IN_AGC, 0x1);\n\n\tif (!(AR_SREV_9565(ah) && range == 10 && synth_freq == 2437))\n\t\tREG_RMW_FIELD(ah, AR_PHY_TIMING11,\n\t\t\t      AR_PHY_TIMING11_USE_SPUR_FILTER_IN_SELFCOR, 0x1);\n\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING4,\n\t\t      AR_PHY_TIMING4_ENABLE_SPUR_RSSI, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\n\t\t      AR_PHY_SPUR_REG_SPUR_RSSI_THRESH, 34);\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\n\t\t      AR_PHY_SPUR_REG_EN_VIT_SPUR_RSSI, 1);\n\n\tif (!AR_SREV_9340(ah) &&\n\t    REG_READ_FIELD(ah, AR_PHY_MODE,\n\t\t\t   AR_PHY_MODE_DYNAMIC) == 0x1)\n\t\tREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\n\t\t\t      AR_PHY_SPUR_REG_ENABLE_NF_RSSI_SPUR_MIT, 1);\n\n\tmask_index = (freq_offset << 4) / 5;\n\tif (mask_index < 0)\n\t\tmask_index = mask_index - 1;\n\n\tmask_index = mask_index & 0x7f;\n\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\n\t\t      AR_PHY_SPUR_REG_ENABLE_MASK_PPM, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING4,\n\t\t      AR_PHY_TIMING4_ENABLE_PILOT_MASK, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING4,\n\t\t      AR_PHY_TIMING4_ENABLE_CHAN_MASK, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\n\t\t      AR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_IDX_A, mask_index);\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_A(ah),\n\t\t      AR_PHY_SPUR_MASK_A_CF_PUNC_MASK_IDX_A, mask_index);\n\tREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\n\t\t      AR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_IDX_A, mask_index);\n\tREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\n\t\t      AR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_A, 0xc);\n\tREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\n\t\t      AR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_A, 0xc);\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_A(ah),\n\t\t      AR_PHY_SPUR_MASK_A_CF_PUNC_MASK_A, 0xa0);\n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\n\t\t      AR_PHY_SPUR_REG_MASK_RATE_CNTL, 0xff);\n}\n\nstatic void ar9003_hw_spur_ofdm_9565(struct ath_hw *ah,\n\t\t\t\t     int freq_offset)\n{\n\tint mask_index = 0;\n\n\tmask_index = (freq_offset << 4) / 5;\n\tif (mask_index < 0)\n\t\tmask_index = mask_index - 1;\n\n\tmask_index = mask_index & 0x7f;\n\n\tREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\n\t\t      AR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_IDX_B,\n\t\t      mask_index);\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_B(ah),\n\t\t      AR_PHY_SPUR_MASK_A_CF_PUNC_MASK_IDX_A,\n\t\t      mask_index);\n\n\tREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\n\t\t      AR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_IDX_B,\n\t\t      mask_index);\n\tREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\n\t\t      AR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_B, 0xe);\n\tREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\n\t\t      AR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_B, 0xe);\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_B(ah),\n\t\t      AR_PHY_SPUR_MASK_A_CF_PUNC_MASK_A, 0xa0);\n}\n\nstatic void ar9003_hw_spur_ofdm_work(struct ath_hw *ah,\n\t\t\t\t     struct ath9k_channel *chan,\n\t\t\t\t     int freq_offset,\n\t\t\t\t     int range,\n\t\t\t\t     int synth_freq)\n{\n\tint spur_freq_sd = 0;\n\tint spur_subchannel_sd = 0;\n\tint spur_delta_phase = 0;\n\n\tif (IS_CHAN_HT40(chan)) {\n\t\tif (freq_offset < 0) {\n\t\t\tif (REG_READ_FIELD(ah, AR_PHY_GEN_CTRL,\n\t\t\t\t\t   AR_PHY_GC_DYN2040_PRI_CH) == 0x0)\n\t\t\t\tspur_subchannel_sd = 1;\n\t\t\telse\n\t\t\t\tspur_subchannel_sd = 0;\n\n\t\t\tspur_freq_sd = ((freq_offset + 10) << 9) / 11;\n\n\t\t} else {\n\t\t\tif (REG_READ_FIELD(ah, AR_PHY_GEN_CTRL,\n\t\t\t    AR_PHY_GC_DYN2040_PRI_CH) == 0x0)\n\t\t\t\tspur_subchannel_sd = 0;\n\t\t\telse\n\t\t\t\tspur_subchannel_sd = 1;\n\n\t\t\tspur_freq_sd = ((freq_offset - 10) << 9) / 11;\n\n\t\t}\n\n\t\tspur_delta_phase = (freq_offset << 17) / 5;\n\n\t} else {\n\t\tspur_subchannel_sd = 0;\n\t\tspur_freq_sd = (freq_offset << 9) /11;\n\t\tspur_delta_phase = (freq_offset << 18) / 5;\n\t}\n\n\tspur_freq_sd = spur_freq_sd & 0x3ff;\n\tspur_delta_phase = spur_delta_phase & 0xfffff;\n\n\tar9003_hw_spur_ofdm(ah,\n\t\t\t    freq_offset,\n\t\t\t    spur_freq_sd,\n\t\t\t    spur_delta_phase,\n\t\t\t    spur_subchannel_sd,\n\t\t\t    range, synth_freq);\n}\n\n \nstatic void ar9003_hw_spur_mitigate_ofdm(struct ath_hw *ah,\n\t\t\t\t\t struct ath9k_channel *chan)\n{\n\tint synth_freq;\n\tint range = 10;\n\tint freq_offset = 0;\n\tu8 *spur_fbin_ptr = ar9003_get_spur_chan_ptr(ah, IS_CHAN_2GHZ(chan));\n\tunsigned int i;\n\n\tif (spur_fbin_ptr[0] == 0)\n\t\treturn;  \n\n\tif (IS_CHAN_HT40(chan)) {\n\t\trange = 19;\n\t\tif (REG_READ_FIELD(ah, AR_PHY_GEN_CTRL,\n\t\t\t\t   AR_PHY_GC_DYN2040_PRI_CH) == 0x0)\n\t\t\tsynth_freq = chan->channel - 10;\n\t\telse\n\t\t\tsynth_freq = chan->channel + 10;\n\t} else {\n\t\trange = 10;\n\t\tsynth_freq = chan->channel;\n\t}\n\n\tar9003_hw_spur_ofdm_clear(ah);\n\n\tfor (i = 0; i < AR_EEPROM_MODAL_SPURS && spur_fbin_ptr[i]; i++) {\n\t\tfreq_offset = ath9k_hw_fbin2freq(spur_fbin_ptr[i],\n\t\t\t\t\t\t IS_CHAN_2GHZ(chan));\n\t\tfreq_offset -= synth_freq;\n\t\tif (abs(freq_offset) < range) {\n\t\t\tar9003_hw_spur_ofdm_work(ah, chan, freq_offset,\n\t\t\t\t\t\t range, synth_freq);\n\n\t\t\tif (AR_SREV_9565(ah) && (i < 4)) {\n\t\t\t\tfreq_offset =\n\t\t\t\t\tath9k_hw_fbin2freq(spur_fbin_ptr[i + 1],\n\t\t\t\t\t\t\t   IS_CHAN_2GHZ(chan));\n\t\t\t\tfreq_offset -= synth_freq;\n\t\t\t\tif (abs(freq_offset) < range)\n\t\t\t\t\tar9003_hw_spur_ofdm_9565(ah, freq_offset);\n\t\t\t}\n\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic void ar9003_hw_spur_mitigate(struct ath_hw *ah,\n\t\t\t\t    struct ath9k_channel *chan)\n{\n\tif (!AR_SREV_9565(ah))\n\t\tar9003_hw_spur_mitigate_mrc_cck(ah, chan);\n\tar9003_hw_spur_mitigate_ofdm(ah, chan);\n}\n\nstatic u32 ar9003_hw_compute_pll_control_soc(struct ath_hw *ah,\n\t\t\t\t\t     struct ath9k_channel *chan)\n{\n\tu32 pll;\n\n\tpll = SM(0x5, AR_RTC_9300_SOC_PLL_REFDIV);\n\n\tif (chan && IS_CHAN_HALF_RATE(chan))\n\t\tpll |= SM(0x1, AR_RTC_9300_SOC_PLL_CLKSEL);\n\telse if (chan && IS_CHAN_QUARTER_RATE(chan))\n\t\tpll |= SM(0x2, AR_RTC_9300_SOC_PLL_CLKSEL);\n\n\tpll |= SM(0x2c, AR_RTC_9300_SOC_PLL_DIV_INT);\n\n\treturn pll;\n}\n\nstatic u32 ar9003_hw_compute_pll_control(struct ath_hw *ah,\n\t\t\t\t\t struct ath9k_channel *chan)\n{\n\tu32 pll;\n\n\tpll = SM(0x5, AR_RTC_9300_PLL_REFDIV);\n\n\tif (chan && IS_CHAN_HALF_RATE(chan))\n\t\tpll |= SM(0x1, AR_RTC_9300_PLL_CLKSEL);\n\telse if (chan && IS_CHAN_QUARTER_RATE(chan))\n\t\tpll |= SM(0x2, AR_RTC_9300_PLL_CLKSEL);\n\n\tpll |= SM(0x2c, AR_RTC_9300_PLL_DIV);\n\n\treturn pll;\n}\n\nstatic void ar9003_hw_set_channel_regs(struct ath_hw *ah,\n\t\t\t\t       struct ath9k_channel *chan)\n{\n\tu32 phymode;\n\tu32 enableDacFifo = 0;\n\n\tenableDacFifo =\n\t\t(REG_READ(ah, AR_PHY_GEN_CTRL) & AR_PHY_GC_ENABLE_DAC_FIFO);\n\n\t \n\tphymode = AR_PHY_GC_HT_EN | AR_PHY_GC_SHORT_GI_40 | enableDacFifo;\n\n\tif (!AR_SREV_9561(ah))\n\t\tphymode |= AR_PHY_GC_SINGLE_HT_LTF1;\n\n\t \n\tif (IS_CHAN_HT40(chan)) {\n\t\tphymode |= AR_PHY_GC_DYN2040_EN;\n\t\t \n\t\tif (IS_CHAN_HT40PLUS(chan))\n\t\t\tphymode |= AR_PHY_GC_DYN2040_PRI_CH;\n\n\t}\n\n\t \n\tphymode |= REG_READ(ah, AR_PHY_GEN_CTRL);\n\t \n\tphymode &= ~AR_PHY_GC_GF_DETECT_EN;\n\n\tREG_WRITE(ah, AR_PHY_GEN_CTRL, phymode);\n\n\t \n\tath9k_hw_set11nmac2040(ah, chan);\n\n\t \n\tREG_WRITE(ah, AR_GTXTO, 25 << AR_GTXTO_TIMEOUT_LIMIT_S);\n\t \n\tREG_WRITE(ah, AR_CST, 0xF << AR_CST_TIMEOUT_LIMIT_S);\n}\n\nstatic void ar9003_hw_init_bb(struct ath_hw *ah,\n\t\t\t      struct ath9k_channel *chan)\n{\n\tu32 synthDelay;\n\n\t \n\tsynthDelay = REG_READ(ah, AR_PHY_RX_DELAY) & AR_PHY_RX_DELAY_DELAY;\n\n\t \n\tREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_EN);\n\tath9k_hw_synth_delay(ah, chan, synthDelay);\n}\n\nvoid ar9003_hw_set_chain_masks(struct ath_hw *ah, u8 rx, u8 tx)\n{\n\tif (ah->caps.tx_chainmask == 5 || ah->caps.rx_chainmask == 5)\n\t\tREG_SET_BIT(ah, AR_PHY_ANALOG_SWAP,\n\t\t\t    AR_PHY_SWAP_ALT_CHAIN);\n\n\tREG_WRITE(ah, AR_PHY_RX_CHAINMASK, rx);\n\tREG_WRITE(ah, AR_PHY_CAL_CHAINMASK, rx);\n\n\tif ((ah->caps.hw_caps & ATH9K_HW_CAP_APM) && (tx == 0x7))\n\t\ttx = 3;\n\n\tREG_WRITE(ah, AR_SELFGEN_MASK, tx);\n}\n\n \nstatic void ar9003_hw_override_ini(struct ath_hw *ah)\n{\n\tu32 val;\n\n\t \n\tREG_SET_BIT(ah, AR_DIAG_SW, (AR_DIAG_RX_DIS | AR_DIAG_RX_ABORT));\n\n\t \n\tval = REG_READ(ah, AR_PCU_MISC_MODE2) & (~AR_ADHOC_MCAST_KEYID_ENABLE);\n\tval |= AR_AGG_WEP_ENABLE_FIX |\n\t       AR_AGG_WEP_ENABLE |\n\t       AR_PCU_MISC_MODE2_CFP_IGNORE;\n\tREG_WRITE(ah, AR_PCU_MISC_MODE2, val);\n\n\tif (AR_SREV_9462(ah) || AR_SREV_9565(ah)) {\n\t\tREG_WRITE(ah, AR_GLB_SWREG_DISCONT_MODE,\n\t\t\t  AR_GLB_SWREG_DISCONT_EN_BT_WLAN);\n\n\t\tif (REG_READ_FIELD(ah, AR_PHY_TX_IQCAL_CONTROL_0(ah),\n\t\t\t\t   AR_PHY_TX_IQCAL_CONTROL_0_ENABLE_TXIQ_CAL))\n\t\t\tah->enabled_cals |= TX_IQ_CAL;\n\t\telse\n\t\t\tah->enabled_cals &= ~TX_IQ_CAL;\n\n\t}\n\n\tif (REG_READ(ah, AR_PHY_CL_CAL_CTL) & AR_PHY_CL_CAL_ENABLE)\n\t\tah->enabled_cals |= TX_CL_CAL;\n\telse\n\t\tah->enabled_cals &= ~TX_CL_CAL;\n\n\tif (AR_SREV_9340(ah) || AR_SREV_9531(ah) || AR_SREV_9550(ah) ||\n\t    AR_SREV_9561(ah)) {\n\t\tif (ah->is_clk_25mhz) {\n\t\t\tREG_WRITE(ah, AR_RTC_DERIVED_CLK(ah), 0x17c << 1);\n\t\t\tREG_WRITE(ah, AR_SLP32_MODE, 0x0010f3d7);\n\t\t\tREG_WRITE(ah, AR_SLP32_INC, 0x0001e7ae);\n\t\t} else {\n\t\t\tREG_WRITE(ah, AR_RTC_DERIVED_CLK(ah), 0x261 << 1);\n\t\t\tREG_WRITE(ah, AR_SLP32_MODE, 0x0010f400);\n\t\t\tREG_WRITE(ah, AR_SLP32_INC, 0x0001e800);\n\t\t}\n\t\tudelay(100);\n\t}\n}\n\nstatic void ar9003_hw_prog_ini(struct ath_hw *ah,\n\t\t\t       struct ar5416IniArray *iniArr,\n\t\t\t       int column)\n{\n\tunsigned int i, regWrites = 0;\n\n\t \n\tif (!iniArr->ia_array)\n\t\treturn;\n\n\t \n\tif (column >= iniArr->ia_columns)\n\t\tcolumn = 1;\n\n\tfor (i = 0; i < iniArr->ia_rows; i++) {\n\t\tu32 reg = INI_RA(iniArr, i, 0);\n\t\tu32 val = INI_RA(iniArr, i, column);\n\n\t\tREG_WRITE(ah, reg, val);\n\n\t\tDO_DELAY(regWrites);\n\t}\n}\n\nstatic int ar9550_hw_get_modes_txgain_index(struct ath_hw *ah,\n\t\t\t\t\t    struct ath9k_channel *chan)\n{\n\tint ret;\n\n\tif (IS_CHAN_2GHZ(chan)) {\n\t\tif (IS_CHAN_HT40(chan))\n\t\t\treturn 7;\n\t\telse\n\t\t\treturn 8;\n\t}\n\n\tif (chan->channel <= 5350)\n\t\tret = 1;\n\telse if ((chan->channel > 5350) && (chan->channel <= 5600))\n\t\tret = 3;\n\telse\n\t\tret = 5;\n\n\tif (IS_CHAN_HT40(chan))\n\t\tret++;\n\n\treturn ret;\n}\n\nstatic int ar9561_hw_get_modes_txgain_index(struct ath_hw *ah,\n\t\t\t\t\t    struct ath9k_channel *chan)\n{\n\tif (IS_CHAN_2GHZ(chan)) {\n\t\tif (IS_CHAN_HT40(chan))\n\t\t\treturn 1;\n\t\telse\n\t\t\treturn 2;\n\t}\n\n\treturn 0;\n}\n\nstatic void ar9003_doubler_fix(struct ath_hw *ah)\n{\n\tif (AR_SREV_9300(ah) || AR_SREV_9580(ah) || AR_SREV_9550(ah)) {\n\t\tREG_RMW(ah, AR_PHY_65NM_CH0_RXTX2,\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S, 0);\n\t\tREG_RMW(ah, AR_PHY_65NM_CH1_RXTX2,\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S, 0);\n\t\tREG_RMW(ah, AR_PHY_65NM_CH2_RXTX2,\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S, 0);\n\n\t\tudelay(200);\n\n\t\tREG_CLR_BIT(ah, AR_PHY_65NM_CH0_RXTX2,\n\t\t\t    AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK);\n\t\tREG_CLR_BIT(ah, AR_PHY_65NM_CH1_RXTX2,\n\t\t\t    AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK);\n\t\tREG_CLR_BIT(ah, AR_PHY_65NM_CH2_RXTX2,\n\t\t\t    AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK);\n\n\t\tudelay(1);\n\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_CH0_RXTX2,\n\t\t\t      AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK, 1);\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_CH1_RXTX2,\n\t\t\t      AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK, 1);\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_CH2_RXTX2,\n\t\t\t      AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK, 1);\n\n\t\tudelay(200);\n\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_CH0_SYNTH12,\n\t\t\t      AR_PHY_65NM_CH0_SYNTH12_VREFMUL3, 0xf);\n\n\t\tREG_RMW(ah, AR_PHY_65NM_CH0_RXTX2, 0,\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S);\n\t\tREG_RMW(ah, AR_PHY_65NM_CH1_RXTX2, 0,\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S);\n\t\tREG_RMW(ah, AR_PHY_65NM_CH2_RXTX2, 0,\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\n\t\t\t1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S);\n\t}\n}\n\nstatic int ar9003_hw_process_ini(struct ath_hw *ah,\n\t\t\t\t struct ath9k_channel *chan)\n{\n\tunsigned int regWrites = 0, i;\n\tu32 modesIndex;\n\n\tif (IS_CHAN_5GHZ(chan))\n\t\tmodesIndex = IS_CHAN_HT40(chan) ? 2 : 1;\n\telse\n\t\tmodesIndex = IS_CHAN_HT40(chan) ? 3 : 4;\n\n\t \n\tfor (i = 0; i < ATH_INI_NUM_SPLIT; i++) {\n\t\tar9003_hw_prog_ini(ah, &ah->iniSOC[i], modesIndex);\n\t\tar9003_hw_prog_ini(ah, &ah->iniMac[i], modesIndex);\n\t\tar9003_hw_prog_ini(ah, &ah->iniBB[i], modesIndex);\n\t\tar9003_hw_prog_ini(ah, &ah->iniRadio[i], modesIndex);\n\t\tif (i == ATH_INI_POST && AR_SREV_9462_20_OR_LATER(ah))\n\t\t\tar9003_hw_prog_ini(ah,\n\t\t\t\t\t   &ah->ini_radio_post_sys2ant,\n\t\t\t\t\t   modesIndex);\n\t}\n\n\tar9003_doubler_fix(ah);\n\n\t \n\tREG_WRITE_ARRAY(&ah->iniModesRxGain, 1, regWrites);\n\n\tif (AR_SREV_9462_20_OR_LATER(ah)) {\n\t\t \n\t\tif (ar9003_hw_get_rx_gain_idx(ah) == 2) {\n\t\t\tREG_WRITE_ARRAY(&ah->ini_modes_rxgain_bb_core,\n\t\t\t\t\t1, regWrites);\n\t\t\tREG_WRITE_ARRAY(&ah->ini_modes_rxgain_bb_postamble,\n\t\t\t\t\tmodesIndex, regWrites);\n\t\t}\n\n\t\t \n\t\tif ((ar9003_hw_get_rx_gain_idx(ah) == 2) ||\n\t\t    (ar9003_hw_get_rx_gain_idx(ah) == 3)) {\n\t\t\tREG_WRITE_ARRAY(&ah->ini_modes_rxgain_xlna,\n\t\t\t\t\tmodesIndex, regWrites);\n\t\t}\n\t}\n\n\tif (AR_SREV_9550(ah) || AR_SREV_9561(ah))\n\t\tREG_WRITE_ARRAY(&ah->ini_modes_rx_gain_bounds, modesIndex,\n\t\t\t\tregWrites);\n\n\tif (AR_SREV_9561(ah) && (ar9003_hw_get_rx_gain_idx(ah) == 0))\n\t\tREG_WRITE_ARRAY(&ah->ini_modes_rxgain_xlna,\n\t\t\t\tmodesIndex, regWrites);\n\t \n\tif (AR_SREV_9550(ah) || AR_SREV_9531(ah) || AR_SREV_9561(ah)) {\n\t\tint modes_txgain_index = 1;\n\n\t\tif (AR_SREV_9550(ah))\n\t\t\tmodes_txgain_index = ar9550_hw_get_modes_txgain_index(ah, chan);\n\n\t\tif (AR_SREV_9561(ah))\n\t\t\tmodes_txgain_index =\n\t\t\t\tar9561_hw_get_modes_txgain_index(ah, chan);\n\n\t\tif (modes_txgain_index < 0)\n\t\t\treturn -EINVAL;\n\n\t\tREG_WRITE_ARRAY(&ah->iniModesTxGain, modes_txgain_index,\n\t\t\t\tregWrites);\n\t} else {\n\t\tREG_WRITE_ARRAY(&ah->iniModesTxGain, modesIndex, regWrites);\n\t}\n\n\t \n\tif (IS_CHAN_A_FAST_CLOCK(ah, chan))\n\t\tREG_WRITE_ARRAY(&ah->iniModesFastClock,\n\t\t\t\tmodesIndex, regWrites);\n\n\t \n\tREG_WRITE_ARRAY(&ah->iniAdditional, 1, regWrites);\n\n\t \n\tif (chan->channel == 2484) {\n\t\tar9003_hw_prog_ini(ah, &ah->iniCckfirJapan2484, 1);\n\n\t\tif (AR_SREV_9531(ah))\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_FCAL_2_0,\n\t\t\t\t      AR_PHY_FLC_PWR_THRESH, 0);\n\t}\n\n\tah->modes_index = modesIndex;\n\tar9003_hw_override_ini(ah);\n\tar9003_hw_set_channel_regs(ah, chan);\n\tar9003_hw_set_chain_masks(ah, ah->rxchainmask, ah->txchainmask);\n\tath9k_hw_apply_txpower(ah, chan, false);\n\n\treturn 0;\n}\n\nstatic void ar9003_hw_set_rfmode(struct ath_hw *ah,\n\t\t\t\t struct ath9k_channel *chan)\n{\n\tu32 rfMode = 0;\n\n\tif (chan == NULL)\n\t\treturn;\n\n\tif (IS_CHAN_2GHZ(chan))\n\t\trfMode |= AR_PHY_MODE_DYNAMIC;\n\telse\n\t\trfMode |= AR_PHY_MODE_OFDM;\n\n\tif (IS_CHAN_A_FAST_CLOCK(ah, chan))\n\t\trfMode |= (AR_PHY_MODE_DYNAMIC | AR_PHY_MODE_DYN_CCK_DISABLE);\n\n\tif (IS_CHAN_HALF_RATE(chan) || IS_CHAN_QUARTER_RATE(chan))\n\t\tREG_RMW_FIELD(ah, AR_PHY_FRAME_CTL,\n\t\t\t      AR_PHY_FRAME_CTL_CF_OVERLAP_WINDOW, 3);\n\n\tREG_WRITE(ah, AR_PHY_MODE, rfMode);\n}\n\nstatic void ar9003_hw_mark_phy_inactive(struct ath_hw *ah)\n{\n\tREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_DIS);\n}\n\nstatic void ar9003_hw_set_delta_slope(struct ath_hw *ah,\n\t\t\t\t      struct ath9k_channel *chan)\n{\n\tu32 coef_scaled, ds_coef_exp, ds_coef_man;\n\tu32 clockMhzScaled = 0x64000000;\n\tstruct chan_centers centers;\n\n\t \n\tif (IS_CHAN_HALF_RATE(chan))\n\t\tclockMhzScaled = clockMhzScaled >> 1;\n\telse if (IS_CHAN_QUARTER_RATE(chan))\n\t\tclockMhzScaled = clockMhzScaled >> 2;\n\n\t \n\tath9k_hw_get_channel_centers(ah, chan, &centers);\n\tcoef_scaled = clockMhzScaled / centers.synth_center;\n\n\tath9k_hw_get_delta_slope_vals(ah, coef_scaled, &ds_coef_man,\n\t\t\t\t      &ds_coef_exp);\n\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING3,\n\t\t      AR_PHY_TIMING3_DSC_MAN, ds_coef_man);\n\tREG_RMW_FIELD(ah, AR_PHY_TIMING3,\n\t\t      AR_PHY_TIMING3_DSC_EXP, ds_coef_exp);\n\n\t \n\tcoef_scaled = (9 * coef_scaled) / 10;\n\n\tath9k_hw_get_delta_slope_vals(ah, coef_scaled, &ds_coef_man,\n\t\t\t\t      &ds_coef_exp);\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_SGI_DELTA,\n\t\t      AR_PHY_SGI_DSC_MAN, ds_coef_man);\n\tREG_RMW_FIELD(ah, AR_PHY_SGI_DELTA,\n\t\t      AR_PHY_SGI_DSC_EXP, ds_coef_exp);\n}\n\nstatic bool ar9003_hw_rfbus_req(struct ath_hw *ah)\n{\n\tREG_WRITE(ah, AR_PHY_RFBUS_REQ, AR_PHY_RFBUS_REQ_EN);\n\treturn ath9k_hw_wait(ah, AR_PHY_RFBUS_GRANT, AR_PHY_RFBUS_GRANT_EN,\n\t\t\t     AR_PHY_RFBUS_GRANT_EN, AH_WAIT_TIMEOUT);\n}\n\n \nstatic void ar9003_hw_rfbus_done(struct ath_hw *ah)\n{\n\tu32 synthDelay = REG_READ(ah, AR_PHY_RX_DELAY) & AR_PHY_RX_DELAY_DELAY;\n\n\tath9k_hw_synth_delay(ah, ah->curchan, synthDelay);\n\n\tREG_WRITE(ah, AR_PHY_RFBUS_REQ, 0);\n}\n\nstatic bool ar9003_hw_ani_control(struct ath_hw *ah,\n\t\t\t\t  enum ath9k_ani_cmd cmd, int param)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tstruct ath9k_channel *chan = ah->curchan;\n\tstruct ar5416AniState *aniState = &ah->ani;\n\tint m1ThreshLow, m2ThreshLow;\n\tint m1Thresh, m2Thresh;\n\tint m2CountThr, m2CountThrLow;\n\tint m1ThreshLowExt, m2ThreshLowExt;\n\tint m1ThreshExt, m2ThreshExt;\n\ts32 value, value2;\n\n\tswitch (cmd & ah->ani_function) {\n\tcase ATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION:{\n\t\t \n\t\tu32 on = param ? 1 : 0;\n\n\t\tif (AR_SREV_9462(ah) || AR_SREV_9565(ah))\n\t\t\tgoto skip_ws_det;\n\n\t\tm1ThreshLow = on ?\n\t\t\taniState->iniDef.m1ThreshLow : m1ThreshLow_off;\n\t\tm2ThreshLow = on ?\n\t\t\taniState->iniDef.m2ThreshLow : m2ThreshLow_off;\n\t\tm1Thresh = on ?\n\t\t\taniState->iniDef.m1Thresh : m1Thresh_off;\n\t\tm2Thresh = on ?\n\t\t\taniState->iniDef.m2Thresh : m2Thresh_off;\n\t\tm2CountThr = on ?\n\t\t\taniState->iniDef.m2CountThr : m2CountThr_off;\n\t\tm2CountThrLow = on ?\n\t\t\taniState->iniDef.m2CountThrLow : m2CountThrLow_off;\n\t\tm1ThreshLowExt = on ?\n\t\t\taniState->iniDef.m1ThreshLowExt : m1ThreshLowExt_off;\n\t\tm2ThreshLowExt = on ?\n\t\t\taniState->iniDef.m2ThreshLowExt : m2ThreshLowExt_off;\n\t\tm1ThreshExt = on ?\n\t\t\taniState->iniDef.m1ThreshExt : m1ThreshExt_off;\n\t\tm2ThreshExt = on ?\n\t\t\taniState->iniDef.m2ThreshExt : m2ThreshExt_off;\n\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\n\t\t\t      AR_PHY_SFCORR_LOW_M1_THRESH_LOW,\n\t\t\t      m1ThreshLow);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\n\t\t\t      AR_PHY_SFCORR_LOW_M2_THRESH_LOW,\n\t\t\t      m2ThreshLow);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR,\n\t\t\t      AR_PHY_SFCORR_M1_THRESH,\n\t\t\t      m1Thresh);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR,\n\t\t\t      AR_PHY_SFCORR_M2_THRESH,\n\t\t\t      m2Thresh);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR,\n\t\t\t      AR_PHY_SFCORR_M2COUNT_THR,\n\t\t\t      m2CountThr);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\n\t\t\t      AR_PHY_SFCORR_LOW_M2COUNT_THR_LOW,\n\t\t\t      m2CountThrLow);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\n\t\t\t      AR_PHY_SFCORR_EXT_M1_THRESH_LOW,\n\t\t\t      m1ThreshLowExt);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\n\t\t\t      AR_PHY_SFCORR_EXT_M2_THRESH_LOW,\n\t\t\t      m2ThreshLowExt);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\n\t\t\t      AR_PHY_SFCORR_EXT_M1_THRESH,\n\t\t\t      m1ThreshExt);\n\t\tREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\n\t\t\t      AR_PHY_SFCORR_EXT_M2_THRESH,\n\t\t\t      m2ThreshExt);\nskip_ws_det:\n\t\tif (on)\n\t\t\tREG_SET_BIT(ah, AR_PHY_SFCORR_LOW,\n\t\t\t\t    AR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW);\n\t\telse\n\t\t\tREG_CLR_BIT(ah, AR_PHY_SFCORR_LOW,\n\t\t\t\t    AR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW);\n\n\t\tif (on != aniState->ofdmWeakSigDetect) {\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"** ch %d: ofdm weak signal: %s=>%s\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->ofdmWeakSigDetect ?\n\t\t\t\t\"on\" : \"off\",\n\t\t\t\ton ? \"on\" : \"off\");\n\t\t\tif (on)\n\t\t\t\tah->stats.ast_ani_ofdmon++;\n\t\t\telse\n\t\t\t\tah->stats.ast_ani_ofdmoff++;\n\t\t\taniState->ofdmWeakSigDetect = on;\n\t\t}\n\t\tbreak;\n\t}\n\tcase ATH9K_ANI_FIRSTEP_LEVEL:{\n\t\tu32 level = param;\n\n\t\tif (level >= ARRAY_SIZE(firstep_table)) {\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"ATH9K_ANI_FIRSTEP_LEVEL: level out of range (%u > %zu)\\n\",\n\t\t\t\tlevel, ARRAY_SIZE(firstep_table));\n\t\t\treturn false;\n\t\t}\n\n\t\t \n\t\tvalue = firstep_table[level] -\n\t\t\tfirstep_table[ATH9K_ANI_FIRSTEP_LVL] +\n\t\t\taniState->iniDef.firstep;\n\t\tif (value < ATH9K_SIG_FIRSTEP_SETTING_MIN)\n\t\t\tvalue = ATH9K_SIG_FIRSTEP_SETTING_MIN;\n\t\tif (value > ATH9K_SIG_FIRSTEP_SETTING_MAX)\n\t\t\tvalue = ATH9K_SIG_FIRSTEP_SETTING_MAX;\n\t\tREG_RMW_FIELD(ah, AR_PHY_FIND_SIG,\n\t\t\t      AR_PHY_FIND_SIG_FIRSTEP,\n\t\t\t      value);\n\t\t \n\t\tvalue2 = firstep_table[level] -\n\t\t\t firstep_table[ATH9K_ANI_FIRSTEP_LVL] +\n\t\t\t aniState->iniDef.firstepLow;\n\t\tif (value2 < ATH9K_SIG_FIRSTEP_SETTING_MIN)\n\t\t\tvalue2 = ATH9K_SIG_FIRSTEP_SETTING_MIN;\n\t\tif (value2 > ATH9K_SIG_FIRSTEP_SETTING_MAX)\n\t\t\tvalue2 = ATH9K_SIG_FIRSTEP_SETTING_MAX;\n\n\t\tREG_RMW_FIELD(ah, AR_PHY_FIND_SIG_LOW,\n\t\t\t      AR_PHY_FIND_SIG_LOW_FIRSTEP_LOW, value2);\n\n\t\tif (level != aniState->firstepLevel) {\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"** ch %d: level %d=>%d[def:%d] firstep[level]=%d ini=%d\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->firstepLevel,\n\t\t\t\tlevel,\n\t\t\t\tATH9K_ANI_FIRSTEP_LVL,\n\t\t\t\tvalue,\n\t\t\t\taniState->iniDef.firstep);\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"** ch %d: level %d=>%d[def:%d] firstep_low[level]=%d ini=%d\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->firstepLevel,\n\t\t\t\tlevel,\n\t\t\t\tATH9K_ANI_FIRSTEP_LVL,\n\t\t\t\tvalue2,\n\t\t\t\taniState->iniDef.firstepLow);\n\t\t\tif (level > aniState->firstepLevel)\n\t\t\t\tah->stats.ast_ani_stepup++;\n\t\t\telse if (level < aniState->firstepLevel)\n\t\t\t\tah->stats.ast_ani_stepdown++;\n\t\t\taniState->firstepLevel = level;\n\t\t}\n\t\tbreak;\n\t}\n\tcase ATH9K_ANI_SPUR_IMMUNITY_LEVEL:{\n\t\tu32 level = param;\n\n\t\tif (level >= ARRAY_SIZE(cycpwrThr1_table)) {\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"ATH9K_ANI_SPUR_IMMUNITY_LEVEL: level out of range (%u > %zu)\\n\",\n\t\t\t\tlevel, ARRAY_SIZE(cycpwrThr1_table));\n\t\t\treturn false;\n\t\t}\n\t\t \n\t\tvalue = cycpwrThr1_table[level] -\n\t\t\tcycpwrThr1_table[ATH9K_ANI_SPUR_IMMUNE_LVL] +\n\t\t\taniState->iniDef.cycpwrThr1;\n\t\tif (value < ATH9K_SIG_SPUR_IMM_SETTING_MIN)\n\t\t\tvalue = ATH9K_SIG_SPUR_IMM_SETTING_MIN;\n\t\tif (value > ATH9K_SIG_SPUR_IMM_SETTING_MAX)\n\t\t\tvalue = ATH9K_SIG_SPUR_IMM_SETTING_MAX;\n\t\tREG_RMW_FIELD(ah, AR_PHY_TIMING5,\n\t\t\t      AR_PHY_TIMING5_CYCPWR_THR1,\n\t\t\t      value);\n\n\t\t \n\t\tvalue2 = cycpwrThr1_table[level] -\n\t\t\t cycpwrThr1_table[ATH9K_ANI_SPUR_IMMUNE_LVL] +\n\t\t\t aniState->iniDef.cycpwrThr1Ext;\n\t\tif (value2 < ATH9K_SIG_SPUR_IMM_SETTING_MIN)\n\t\t\tvalue2 = ATH9K_SIG_SPUR_IMM_SETTING_MIN;\n\t\tif (value2 > ATH9K_SIG_SPUR_IMM_SETTING_MAX)\n\t\t\tvalue2 = ATH9K_SIG_SPUR_IMM_SETTING_MAX;\n\t\tREG_RMW_FIELD(ah, AR_PHY_EXT_CCA,\n\t\t\t      AR_PHY_EXT_CYCPWR_THR1, value2);\n\n\t\tif (level != aniState->spurImmunityLevel) {\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"** ch %d: level %d=>%d[def:%d] cycpwrThr1[level]=%d ini=%d\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->spurImmunityLevel,\n\t\t\t\tlevel,\n\t\t\t\tATH9K_ANI_SPUR_IMMUNE_LVL,\n\t\t\t\tvalue,\n\t\t\t\taniState->iniDef.cycpwrThr1);\n\t\t\tath_dbg(common, ANI,\n\t\t\t\t\"** ch %d: level %d=>%d[def:%d] cycpwrThr1Ext[level]=%d ini=%d\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->spurImmunityLevel,\n\t\t\t\tlevel,\n\t\t\t\tATH9K_ANI_SPUR_IMMUNE_LVL,\n\t\t\t\tvalue2,\n\t\t\t\taniState->iniDef.cycpwrThr1Ext);\n\t\t\tif (level > aniState->spurImmunityLevel)\n\t\t\t\tah->stats.ast_ani_spurup++;\n\t\t\telse if (level < aniState->spurImmunityLevel)\n\t\t\t\tah->stats.ast_ani_spurdown++;\n\t\t\taniState->spurImmunityLevel = level;\n\t\t}\n\t\tbreak;\n\t}\n\tcase ATH9K_ANI_MRC_CCK:{\n\t\t \n\t\tbool is_on = param ? 1 : 0;\n\n\t\tif (ah->caps.rx_chainmask == 1)\n\t\t\tbreak;\n\n\t\tREG_RMW_FIELD(ah, AR_PHY_MRC_CCK_CTRL,\n\t\t\t      AR_PHY_MRC_CCK_ENABLE, is_on);\n\t\tREG_RMW_FIELD(ah, AR_PHY_MRC_CCK_CTRL,\n\t\t\t      AR_PHY_MRC_CCK_MUX_REG, is_on);\n\t\tif (is_on != aniState->mrcCCK) {\n\t\t\tath_dbg(common, ANI, \"** ch %d: MRC CCK: %s=>%s\\n\",\n\t\t\t\tchan->channel,\n\t\t\t\taniState->mrcCCK ? \"on\" : \"off\",\n\t\t\t\tis_on ? \"on\" : \"off\");\n\t\t\tif (is_on)\n\t\t\t\tah->stats.ast_ani_ccklow++;\n\t\t\telse\n\t\t\t\tah->stats.ast_ani_cckhigh++;\n\t\t\taniState->mrcCCK = is_on;\n\t\t}\n\tbreak;\n\t}\n\tdefault:\n\t\tath_dbg(common, ANI, \"invalid cmd %u\\n\", cmd);\n\t\treturn false;\n\t}\n\n\tath_dbg(common, ANI,\n\t\t\"ANI parameters: SI=%d, ofdmWS=%s FS=%d MRCcck=%s listenTime=%d ofdmErrs=%d cckErrs=%d\\n\",\n\t\taniState->spurImmunityLevel,\n\t\taniState->ofdmWeakSigDetect ? \"on\" : \"off\",\n\t\taniState->firstepLevel,\n\t\taniState->mrcCCK ? \"on\" : \"off\",\n\t\taniState->listenTime,\n\t\taniState->ofdmPhyErrCount,\n\t\taniState->cckPhyErrCount);\n\treturn true;\n}\n\nstatic void ar9003_hw_do_getnf(struct ath_hw *ah,\n\t\t\t      int16_t nfarray[NUM_NF_READINGS])\n{\n#define AR_PHY_CH_MINCCA_PWR\t0x1FF00000\n#define AR_PHY_CH_MINCCA_PWR_S\t20\n#define AR_PHY_CH_EXT_MINCCA_PWR 0x01FF0000\n#define AR_PHY_CH_EXT_MINCCA_PWR_S 16\n\n\tint16_t nf;\n\tint i;\n\n\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\tif (ah->rxchainmask & BIT(i)) {\n\t\t\tnf = MS(REG_READ(ah, ah->nf_regs[i]),\n\t\t\t\t\t AR_PHY_CH_MINCCA_PWR);\n\t\t\tnfarray[i] = sign_extend32(nf, 8);\n\n\t\t\tif (IS_CHAN_HT40(ah->curchan)) {\n\t\t\t\tu8 ext_idx = AR9300_MAX_CHAINS + i;\n\n\t\t\t\tnf = MS(REG_READ(ah, ah->nf_regs[ext_idx]),\n\t\t\t\t\t\t AR_PHY_CH_EXT_MINCCA_PWR);\n\t\t\t\tnfarray[ext_idx] = sign_extend32(nf, 8);\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic void ar9003_hw_set_nf_limits(struct ath_hw *ah)\n{\n\tah->nf_2g.max = AR_PHY_CCA_MAX_GOOD_VAL_9300_2GHZ;\n\tah->nf_2g.min = AR_PHY_CCA_MIN_GOOD_VAL_9300_2GHZ;\n\tah->nf_2g.nominal = AR_PHY_CCA_NOM_VAL_9300_2GHZ;\n\tah->nf_5g.max = AR_PHY_CCA_MAX_GOOD_VAL_9300_5GHZ;\n\tah->nf_5g.min = AR_PHY_CCA_MIN_GOOD_VAL_9300_5GHZ;\n\tah->nf_5g.nominal = AR_PHY_CCA_NOM_VAL_9300_5GHZ;\n\n\tif (AR_SREV_9330(ah))\n\t\tah->nf_2g.nominal = AR_PHY_CCA_NOM_VAL_9330_2GHZ;\n\n\tif (AR_SREV_9462(ah) || AR_SREV_9565(ah)) {\n\t\tah->nf_2g.min = AR_PHY_CCA_MIN_GOOD_VAL_9462_2GHZ;\n\t\tah->nf_2g.nominal = AR_PHY_CCA_NOM_VAL_9462_2GHZ;\n\t\tah->nf_5g.min = AR_PHY_CCA_MIN_GOOD_VAL_9462_5GHZ;\n\t\tah->nf_5g.nominal = AR_PHY_CCA_NOM_VAL_9462_5GHZ;\n\t}\n}\n\n \nstatic void ar9003_hw_ani_cache_ini_regs(struct ath_hw *ah)\n{\n\tstruct ar5416AniState *aniState;\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tstruct ath9k_channel *chan = ah->curchan;\n\tstruct ath9k_ani_default *iniDef;\n\tu32 val;\n\n\taniState = &ah->ani;\n\tiniDef = &aniState->iniDef;\n\n\tath_dbg(common, ANI, \"ver %d.%d opmode %u chan %d Mhz\\n\",\n\t\tah->hw_version.macVersion,\n\t\tah->hw_version.macRev,\n\t\tah->opmode,\n\t\tchan->channel);\n\n\tval = REG_READ(ah, AR_PHY_SFCORR);\n\tiniDef->m1Thresh = MS(val, AR_PHY_SFCORR_M1_THRESH);\n\tiniDef->m2Thresh = MS(val, AR_PHY_SFCORR_M2_THRESH);\n\tiniDef->m2CountThr = MS(val, AR_PHY_SFCORR_M2COUNT_THR);\n\n\tval = REG_READ(ah, AR_PHY_SFCORR_LOW);\n\tiniDef->m1ThreshLow = MS(val, AR_PHY_SFCORR_LOW_M1_THRESH_LOW);\n\tiniDef->m2ThreshLow = MS(val, AR_PHY_SFCORR_LOW_M2_THRESH_LOW);\n\tiniDef->m2CountThrLow = MS(val, AR_PHY_SFCORR_LOW_M2COUNT_THR_LOW);\n\n\tval = REG_READ(ah, AR_PHY_SFCORR_EXT);\n\tiniDef->m1ThreshExt = MS(val, AR_PHY_SFCORR_EXT_M1_THRESH);\n\tiniDef->m2ThreshExt = MS(val, AR_PHY_SFCORR_EXT_M2_THRESH);\n\tiniDef->m1ThreshLowExt = MS(val, AR_PHY_SFCORR_EXT_M1_THRESH_LOW);\n\tiniDef->m2ThreshLowExt = MS(val, AR_PHY_SFCORR_EXT_M2_THRESH_LOW);\n\tiniDef->firstep = REG_READ_FIELD(ah,\n\t\t\t\t\t AR_PHY_FIND_SIG,\n\t\t\t\t\t AR_PHY_FIND_SIG_FIRSTEP);\n\tiniDef->firstepLow = REG_READ_FIELD(ah,\n\t\t\t\t\t    AR_PHY_FIND_SIG_LOW,\n\t\t\t\t\t    AR_PHY_FIND_SIG_LOW_FIRSTEP_LOW);\n\tiniDef->cycpwrThr1 = REG_READ_FIELD(ah,\n\t\t\t\t\t    AR_PHY_TIMING5,\n\t\t\t\t\t    AR_PHY_TIMING5_CYCPWR_THR1);\n\tiniDef->cycpwrThr1Ext = REG_READ_FIELD(ah,\n\t\t\t\t\t       AR_PHY_EXT_CCA,\n\t\t\t\t\t       AR_PHY_EXT_CYCPWR_THR1);\n\n\t \n\taniState->spurImmunityLevel = ATH9K_ANI_SPUR_IMMUNE_LVL;\n\taniState->firstepLevel = ATH9K_ANI_FIRSTEP_LVL;\n\taniState->ofdmWeakSigDetect = true;\n\taniState->mrcCCK = true;\n}\n\nstatic void ar9003_hw_set_radar_params(struct ath_hw *ah,\n\t\t\t\t       struct ath_hw_radar_conf *conf)\n{\n\tunsigned int regWrites = 0;\n\tu32 radar_0 = 0, radar_1;\n\n\tif (!conf) {\n\t\tREG_CLR_BIT(ah, AR_PHY_RADAR_0, AR_PHY_RADAR_0_ENA);\n\t\treturn;\n\t}\n\n\tradar_0 |= AR_PHY_RADAR_0_ENA | AR_PHY_RADAR_0_FFT_ENA;\n\tradar_0 |= SM(conf->fir_power, AR_PHY_RADAR_0_FIRPWR);\n\tradar_0 |= SM(conf->radar_rssi, AR_PHY_RADAR_0_RRSSI);\n\tradar_0 |= SM(conf->pulse_height, AR_PHY_RADAR_0_HEIGHT);\n\tradar_0 |= SM(conf->pulse_rssi, AR_PHY_RADAR_0_PRSSI);\n\tradar_0 |= SM(conf->pulse_inband, AR_PHY_RADAR_0_INBAND);\n\n\tradar_1 = REG_READ(ah, AR_PHY_RADAR_1);\n\tradar_1 &= ~(AR_PHY_RADAR_1_MAXLEN | AR_PHY_RADAR_1_RELSTEP_THRESH |\n\t\t     AR_PHY_RADAR_1_RELPWR_THRESH);\n\tradar_1 |= AR_PHY_RADAR_1_MAX_RRSSI;\n\tradar_1 |= AR_PHY_RADAR_1_BLOCK_CHECK;\n\tradar_1 |= SM(conf->pulse_maxlen, AR_PHY_RADAR_1_MAXLEN);\n\tradar_1 |= SM(conf->pulse_inband_step, AR_PHY_RADAR_1_RELSTEP_THRESH);\n\tradar_1 |= SM(conf->radar_inband, AR_PHY_RADAR_1_RELPWR_THRESH);\n\n\tREG_WRITE(ah, AR_PHY_RADAR_0, radar_0);\n\tREG_WRITE(ah, AR_PHY_RADAR_1, radar_1);\n\tif (conf->ext_channel)\n\t\tREG_SET_BIT(ah, AR_PHY_RADAR_EXT, AR_PHY_RADAR_EXT_ENA);\n\telse\n\t\tREG_CLR_BIT(ah, AR_PHY_RADAR_EXT, AR_PHY_RADAR_EXT_ENA);\n\n\tif (AR_SREV_9300(ah) || AR_SREV_9340(ah) || AR_SREV_9580(ah)) {\n\t\tREG_WRITE_ARRAY(&ah->ini_dfs,\n\t\t\t\tIS_CHAN_HT40(ah->curchan) ? 2 : 1, regWrites);\n\t}\n}\n\nstatic void ar9003_hw_set_radar_conf(struct ath_hw *ah)\n{\n\tstruct ath_hw_radar_conf *conf = &ah->radar_conf;\n\n\tconf->fir_power = -28;\n\tconf->radar_rssi = 0;\n\tconf->pulse_height = 10;\n\tconf->pulse_rssi = 15;\n\tconf->pulse_inband = 8;\n\tconf->pulse_maxlen = 255;\n\tconf->pulse_inband_step = 12;\n\tconf->radar_inband = 8;\n}\n\nstatic void ar9003_hw_antdiv_comb_conf_get(struct ath_hw *ah,\n\t\t\t\t\t   struct ath_hw_antcomb_conf *antconf)\n{\n\tu32 regval;\n\n\tregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\n\tantconf->main_lna_conf = (regval & AR_PHY_ANT_DIV_MAIN_LNACONF) >>\n\t\t\t\t  AR_PHY_ANT_DIV_MAIN_LNACONF_S;\n\tantconf->alt_lna_conf = (regval & AR_PHY_ANT_DIV_ALT_LNACONF) >>\n\t\t\t\t AR_PHY_ANT_DIV_ALT_LNACONF_S;\n\tantconf->fast_div_bias = (regval & AR_PHY_ANT_FAST_DIV_BIAS) >>\n\t\t\t\t  AR_PHY_ANT_FAST_DIV_BIAS_S;\n\n\tif (AR_SREV_9330_11(ah)) {\n\t\tantconf->lna1_lna2_switch_delta = -1;\n\t\tantconf->lna1_lna2_delta = -9;\n\t\tantconf->div_group = 1;\n\t} else if (AR_SREV_9485(ah)) {\n\t\tantconf->lna1_lna2_switch_delta = -1;\n\t\tantconf->lna1_lna2_delta = -9;\n\t\tantconf->div_group = 2;\n\t} else if (AR_SREV_9565(ah)) {\n\t\tantconf->lna1_lna2_switch_delta = 3;\n\t\tantconf->lna1_lna2_delta = -9;\n\t\tantconf->div_group = 3;\n\t} else {\n\t\tantconf->lna1_lna2_switch_delta = -1;\n\t\tantconf->lna1_lna2_delta = -3;\n\t\tantconf->div_group = 0;\n\t}\n}\n\nstatic void ar9003_hw_antdiv_comb_conf_set(struct ath_hw *ah,\n\t\t\t\t   struct ath_hw_antcomb_conf *antconf)\n{\n\tu32 regval;\n\n\tregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\n\tregval &= ~(AR_PHY_ANT_DIV_MAIN_LNACONF |\n\t\t    AR_PHY_ANT_DIV_ALT_LNACONF |\n\t\t    AR_PHY_ANT_FAST_DIV_BIAS |\n\t\t    AR_PHY_ANT_DIV_MAIN_GAINTB |\n\t\t    AR_PHY_ANT_DIV_ALT_GAINTB);\n\tregval |= ((antconf->main_lna_conf << AR_PHY_ANT_DIV_MAIN_LNACONF_S)\n\t\t   & AR_PHY_ANT_DIV_MAIN_LNACONF);\n\tregval |= ((antconf->alt_lna_conf << AR_PHY_ANT_DIV_ALT_LNACONF_S)\n\t\t   & AR_PHY_ANT_DIV_ALT_LNACONF);\n\tregval |= ((antconf->fast_div_bias << AR_PHY_ANT_FAST_DIV_BIAS_S)\n\t\t   & AR_PHY_ANT_FAST_DIV_BIAS);\n\tregval |= ((antconf->main_gaintb << AR_PHY_ANT_DIV_MAIN_GAINTB_S)\n\t\t   & AR_PHY_ANT_DIV_MAIN_GAINTB);\n\tregval |= ((antconf->alt_gaintb << AR_PHY_ANT_DIV_ALT_GAINTB_S)\n\t\t   & AR_PHY_ANT_DIV_ALT_GAINTB);\n\n\tREG_WRITE(ah, AR_PHY_MC_GAIN_CTRL, regval);\n}\n\n#ifdef CONFIG_ATH9K_BTCOEX_SUPPORT\n\nstatic void ar9003_hw_set_bt_ant_diversity(struct ath_hw *ah, bool enable)\n{\n\tstruct ath9k_hw_capabilities *pCap = &ah->caps;\n\tu8 ant_div_ctl1;\n\tu32 regval;\n\n\tif (!AR_SREV_9485(ah) && !AR_SREV_9565(ah))\n\t\treturn;\n\n\tif (AR_SREV_9485(ah)) {\n\t\tregval = ar9003_hw_ant_ctrl_common_2_get(ah,\n\t\t\t\t\t\t IS_CHAN_2GHZ(ah->curchan));\n\t\tif (enable) {\n\t\t\tregval &= ~AR_SWITCH_TABLE_COM2_ALL;\n\t\t\tregval |= ah->config.ant_ctrl_comm2g_switch_enable;\n\t\t}\n\t\tREG_RMW_FIELD(ah, AR_PHY_SWITCH_COM_2,\n\t\t\t      AR_SWITCH_TABLE_COM2_ALL, regval);\n\t}\n\n\tant_div_ctl1 = ah->eep_ops->get_eeprom(ah, EEP_ANT_DIV_CTL1);\n\n\t \n\tregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\n\tregval &= (~AR_ANT_DIV_CTRL_ALL);\n\tregval |= (ant_div_ctl1 & 0x3f) << AR_ANT_DIV_CTRL_ALL_S;\n\tREG_WRITE(ah, AR_PHY_MC_GAIN_CTRL, regval);\n\n\tif (AR_SREV_9485_11_OR_LATER(ah)) {\n\t\t \n\t\tregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\n\t\tregval &= ~AR_PHY_ANT_DIV_LNADIV;\n\t\tregval |= ((ant_div_ctl1 >> 6) & 0x1) << AR_PHY_ANT_DIV_LNADIV_S;\n\t\tif (enable)\n\t\t\tregval |= AR_ANT_DIV_ENABLE;\n\n\t\tREG_WRITE(ah, AR_PHY_MC_GAIN_CTRL, regval);\n\n\t\t \n\t\tregval = REG_READ(ah, AR_PHY_CCK_DETECT);\n\t\tregval &= ~AR_FAST_DIV_ENABLE;\n\t\tregval |= ((ant_div_ctl1 >> 7) & 0x1) << AR_FAST_DIV_ENABLE_S;\n\t\tif (enable)\n\t\t\tregval |= AR_FAST_DIV_ENABLE;\n\n\t\tREG_WRITE(ah, AR_PHY_CCK_DETECT, regval);\n\n\t\tif (pCap->hw_caps & ATH9K_HW_CAP_ANT_DIV_COMB) {\n\t\t\tregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\n\t\t\tregval &= (~(AR_PHY_ANT_DIV_MAIN_LNACONF |\n\t\t\t\t     AR_PHY_ANT_DIV_ALT_LNACONF |\n\t\t\t\t     AR_PHY_ANT_DIV_ALT_GAINTB |\n\t\t\t\t     AR_PHY_ANT_DIV_MAIN_GAINTB));\n\t\t\t \n\t\t\tregval |= (ATH_ANT_DIV_COMB_LNA1 <<\n\t\t\t\t   AR_PHY_ANT_DIV_MAIN_LNACONF_S);\n\t\t\tregval |= (ATH_ANT_DIV_COMB_LNA2 <<\n\t\t\t\t   AR_PHY_ANT_DIV_ALT_LNACONF_S);\n\t\t\tREG_WRITE(ah, AR_PHY_MC_GAIN_CTRL, regval);\n\t\t}\n\t} else if (AR_SREV_9565(ah)) {\n\t\tif (enable) {\n\t\t\tREG_SET_BIT(ah, AR_PHY_MC_GAIN_CTRL,\n\t\t\t\t    AR_ANT_DIV_ENABLE);\n\t\t\tREG_SET_BIT(ah, AR_PHY_MC_GAIN_CTRL,\n\t\t\t\t    (1 << AR_PHY_ANT_SW_RX_PROT_S));\n\t\t\tREG_SET_BIT(ah, AR_PHY_CCK_DETECT,\n\t\t\t\t    AR_FAST_DIV_ENABLE);\n\t\t\tREG_SET_BIT(ah, AR_PHY_RESTART,\n\t\t\t\t    AR_PHY_RESTART_ENABLE_DIV_M2FLAG);\n\t\t\tREG_SET_BIT(ah, AR_BTCOEX_WL_LNADIV,\n\t\t\t\t    AR_BTCOEX_WL_LNADIV_FORCE_ON);\n\t\t} else {\n\t\t\tREG_CLR_BIT(ah, AR_PHY_MC_GAIN_CTRL,\n\t\t\t\t    AR_ANT_DIV_ENABLE);\n\t\t\tREG_CLR_BIT(ah, AR_PHY_MC_GAIN_CTRL,\n\t\t\t\t    (1 << AR_PHY_ANT_SW_RX_PROT_S));\n\t\t\tREG_CLR_BIT(ah, AR_PHY_CCK_DETECT,\n\t\t\t\t    AR_FAST_DIV_ENABLE);\n\t\t\tREG_CLR_BIT(ah, AR_PHY_RESTART,\n\t\t\t\t    AR_PHY_RESTART_ENABLE_DIV_M2FLAG);\n\t\t\tREG_CLR_BIT(ah, AR_BTCOEX_WL_LNADIV,\n\t\t\t\t    AR_BTCOEX_WL_LNADIV_FORCE_ON);\n\n\t\t\tregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\n\t\t\tregval &= ~(AR_PHY_ANT_DIV_MAIN_LNACONF |\n\t\t\t\t    AR_PHY_ANT_DIV_ALT_LNACONF |\n\t\t\t\t    AR_PHY_ANT_DIV_MAIN_GAINTB |\n\t\t\t\t    AR_PHY_ANT_DIV_ALT_GAINTB);\n\t\t\tregval |= (ATH_ANT_DIV_COMB_LNA1 <<\n\t\t\t\t   AR_PHY_ANT_DIV_MAIN_LNACONF_S);\n\t\t\tregval |= (ATH_ANT_DIV_COMB_LNA2 <<\n\t\t\t\t   AR_PHY_ANT_DIV_ALT_LNACONF_S);\n\t\t\tREG_WRITE(ah, AR_PHY_MC_GAIN_CTRL, regval);\n\t\t}\n\t}\n}\n\n#endif\n\nstatic int ar9003_hw_fast_chan_change(struct ath_hw *ah,\n\t\t\t\t      struct ath9k_channel *chan,\n\t\t\t\t      u8 *ini_reloaded)\n{\n\tunsigned int regWrites = 0;\n\tu32 modesIndex, txgain_index;\n\n\tif (IS_CHAN_5GHZ(chan))\n\t\tmodesIndex = IS_CHAN_HT40(chan) ? 2 : 1;\n\telse\n\t\tmodesIndex = IS_CHAN_HT40(chan) ? 3 : 4;\n\n\ttxgain_index = AR_SREV_9531(ah) ? 1 : modesIndex;\n\n\tif (modesIndex == ah->modes_index) {\n\t\t*ini_reloaded = false;\n\t\tgoto set_rfmode;\n\t}\n\n\tar9003_hw_prog_ini(ah, &ah->iniSOC[ATH_INI_POST], modesIndex);\n\tar9003_hw_prog_ini(ah, &ah->iniMac[ATH_INI_POST], modesIndex);\n\tar9003_hw_prog_ini(ah, &ah->iniBB[ATH_INI_POST], modesIndex);\n\tar9003_hw_prog_ini(ah, &ah->iniRadio[ATH_INI_POST], modesIndex);\n\n\tif (AR_SREV_9462_20_OR_LATER(ah))\n\t\tar9003_hw_prog_ini(ah, &ah->ini_radio_post_sys2ant,\n\t\t\t\t   modesIndex);\n\n\tREG_WRITE_ARRAY(&ah->iniModesTxGain, txgain_index, regWrites);\n\n\tif (AR_SREV_9462_20_OR_LATER(ah)) {\n\t\t \n\t\tif (ar9003_hw_get_rx_gain_idx(ah) == 2) {\n\t\t\tREG_WRITE_ARRAY(&ah->ini_modes_rxgain_bb_core,\n\t\t\t\t\t1, regWrites);\n\t\t\tREG_WRITE_ARRAY(&ah->ini_modes_rxgain_bb_postamble,\n\t\t\t\t\tmodesIndex, regWrites);\n\t\t}\n\t}\n\n\t \n\tif (IS_CHAN_A_FAST_CLOCK(ah, chan))\n\t\tREG_WRITE_ARRAY(&ah->iniModesFastClock, modesIndex, regWrites);\n\n\tif (AR_SREV_9565(ah))\n\t\tREG_WRITE_ARRAY(&ah->iniModesFastClock, 1, regWrites);\n\n\t \n\tif (chan->channel == 2484)\n\t\tar9003_hw_prog_ini(ah, &ah->iniCckfirJapan2484, 1);\n\n\tah->modes_index = modesIndex;\n\t*ini_reloaded = true;\n\nset_rfmode:\n\tar9003_hw_set_rfmode(ah, chan);\n\treturn 0;\n}\n\nstatic void ar9003_hw_spectral_scan_config(struct ath_hw *ah,\n\t\t\t\t\t   struct ath_spec_scan *param)\n{\n\tu8 count;\n\n\tif (!param->enabled) {\n\t\tREG_CLR_BIT(ah, AR_PHY_SPECTRAL_SCAN,\n\t\t\t    AR_PHY_SPECTRAL_SCAN_ENABLE);\n\t\treturn;\n\t}\n\n\tREG_SET_BIT(ah, AR_PHY_RADAR_0, AR_PHY_RADAR_0_FFT_ENA);\n\tREG_SET_BIT(ah, AR_PHY_SPECTRAL_SCAN, AR_PHY_SPECTRAL_SCAN_ENABLE);\n\n\t \n\tcount = param->count;\n\tif (param->endless)\n\t\tcount = 0;\n\telse if (param->count == 0)\n\t\tcount = 1;\n\n\tif (param->short_repeat)\n\t\tREG_SET_BIT(ah, AR_PHY_SPECTRAL_SCAN,\n\t\t\t    AR_PHY_SPECTRAL_SCAN_SHORT_REPEAT);\n\telse\n\t\tREG_CLR_BIT(ah, AR_PHY_SPECTRAL_SCAN,\n\t\t\t    AR_PHY_SPECTRAL_SCAN_SHORT_REPEAT);\n\n\tREG_RMW_FIELD(ah, AR_PHY_SPECTRAL_SCAN,\n\t\t      AR_PHY_SPECTRAL_SCAN_COUNT, count);\n\tREG_RMW_FIELD(ah, AR_PHY_SPECTRAL_SCAN,\n\t\t      AR_PHY_SPECTRAL_SCAN_PERIOD, param->period);\n\tREG_RMW_FIELD(ah, AR_PHY_SPECTRAL_SCAN,\n\t\t      AR_PHY_SPECTRAL_SCAN_FFT_PERIOD, param->fft_period);\n\n\treturn;\n}\n\nstatic void ar9003_hw_spectral_scan_trigger(struct ath_hw *ah)\n{\n\tREG_SET_BIT(ah, AR_PHY_SPECTRAL_SCAN,\n\t\t    AR_PHY_SPECTRAL_SCAN_ENABLE);\n\t \n\tREG_SET_BIT(ah, AR_PHY_SPECTRAL_SCAN,\n\t\t    AR_PHY_SPECTRAL_SCAN_ACTIVE);\n}\n\nstatic void ar9003_hw_spectral_scan_wait(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\n\t \n\tif (!ath9k_hw_wait(ah, AR_PHY_SPECTRAL_SCAN,\n\t\t\t   AR_PHY_SPECTRAL_SCAN_ACTIVE,\n\t\t\t   0, AH_WAIT_TIMEOUT)) {\n\t\tath_err(common, \"spectral scan wait failed\\n\");\n\t\treturn;\n\t}\n}\n\nstatic void ar9003_hw_tx99_start(struct ath_hw *ah, u32 qnum)\n{\n\tREG_SET_BIT(ah, AR_PHY_TEST(ah), PHY_AGC_CLR);\n\tREG_CLR_BIT(ah, AR_DIAG_SW, AR_DIAG_RX_DIS);\n\tREG_WRITE(ah, AR_CR, AR_CR_RXD);\n\tREG_WRITE(ah, AR_DLCL_IFS(qnum), 0);\n\tREG_WRITE(ah, AR_D_GBL_IFS_SIFS, 20);  \n\tREG_WRITE(ah, AR_D_GBL_IFS_EIFS, 20);\n\tREG_WRITE(ah, AR_TIME_OUT, 0x00000400);\n\tREG_WRITE(ah, AR_DRETRY_LIMIT(qnum), 0xffffffff);\n\tREG_SET_BIT(ah, AR_QMISC(qnum), AR_Q_MISC_DCU_EARLY_TERM_REQ);\n}\n\nstatic void ar9003_hw_tx99_stop(struct ath_hw *ah)\n{\n\tREG_CLR_BIT(ah, AR_PHY_TEST(ah), PHY_AGC_CLR);\n\tREG_SET_BIT(ah, AR_DIAG_SW, AR_DIAG_RX_DIS);\n}\n\nstatic void ar9003_hw_tx99_set_txpower(struct ath_hw *ah, u8 txpower)\n{\n\tstatic u8 p_pwr_array[ar9300RateSize] = { 0 };\n\tunsigned int i;\n\n\ttxpower = txpower <= MAX_RATE_POWER ? txpower : MAX_RATE_POWER;\n\tfor (i = 0; i < ar9300RateSize; i++)\n\t\tp_pwr_array[i] = txpower;\n\n\tar9003_hw_tx_power_regwrite(ah, p_pwr_array);\n}\n\nstatic void ar9003_hw_init_txpower_cck(struct ath_hw *ah, u8 *rate_array)\n{\n\tah->tx_power[0] = rate_array[ALL_TARGET_LEGACY_1L_5L];\n\tah->tx_power[1] = rate_array[ALL_TARGET_LEGACY_1L_5L];\n\tah->tx_power[2] = min(rate_array[ALL_TARGET_LEGACY_1L_5L],\n\t\t\t      rate_array[ALL_TARGET_LEGACY_5S]);\n\tah->tx_power[3] = min(rate_array[ALL_TARGET_LEGACY_11L],\n\t\t\t      rate_array[ALL_TARGET_LEGACY_11S]);\n}\n\nstatic void ar9003_hw_init_txpower_ofdm(struct ath_hw *ah, u8 *rate_array,\n\t\t\t\t\tint offset)\n{\n\tint i, j;\n\n\tfor (i = offset; i < offset + AR9300_OFDM_RATES; i++) {\n\t\t \n\t\tj = ofdm2pwr[i - offset];\n\t\tah->tx_power[i] = rate_array[j];\n\t}\n}\n\nstatic void ar9003_hw_init_txpower_ht(struct ath_hw *ah, u8 *rate_array,\n\t\t\t\t      int ss_offset, int ds_offset,\n\t\t\t\t      int ts_offset, bool is_40)\n{\n\tint i, j, mcs_idx = 0;\n\tconst u8 *mcs2pwr = (is_40) ? mcs2pwr_ht40 : mcs2pwr_ht20;\n\n\tfor (i = ss_offset; i < ss_offset + AR9300_HT_SS_RATES; i++) {\n\t\tj = mcs2pwr[mcs_idx];\n\t\tah->tx_power[i] = rate_array[j];\n\t\tmcs_idx++;\n\t}\n\n\tfor (i = ds_offset; i < ds_offset + AR9300_HT_DS_RATES; i++) {\n\t\tj = mcs2pwr[mcs_idx];\n\t\tah->tx_power[i] = rate_array[j];\n\t\tmcs_idx++;\n\t}\n\n\tfor (i = ts_offset; i < ts_offset + AR9300_HT_TS_RATES; i++) {\n\t\tj = mcs2pwr[mcs_idx];\n\t\tah->tx_power[i] = rate_array[j];\n\t\tmcs_idx++;\n\t}\n}\n\nstatic void ar9003_hw_init_txpower_stbc(struct ath_hw *ah, int ss_offset,\n\t\t\t\t\tint ds_offset, int ts_offset)\n{\n\tmemcpy(&ah->tx_power_stbc[ss_offset], &ah->tx_power[ss_offset],\n\t       AR9300_HT_SS_RATES);\n\tmemcpy(&ah->tx_power_stbc[ds_offset], &ah->tx_power[ds_offset],\n\t       AR9300_HT_DS_RATES);\n\tmemcpy(&ah->tx_power_stbc[ts_offset], &ah->tx_power[ts_offset],\n\t       AR9300_HT_TS_RATES);\n}\n\nvoid ar9003_hw_init_rate_txpower(struct ath_hw *ah, u8 *rate_array,\n\t\t\t\t struct ath9k_channel *chan)\n{\n\tif (IS_CHAN_5GHZ(chan)) {\n\t\tar9003_hw_init_txpower_ofdm(ah, rate_array,\n\t\t\t\t\t    AR9300_11NA_OFDM_SHIFT);\n\t\tif (IS_CHAN_HT20(chan) || IS_CHAN_HT40(chan)) {\n\t\t\tar9003_hw_init_txpower_ht(ah, rate_array,\n\t\t\t\t\t\t  AR9300_11NA_HT_SS_SHIFT,\n\t\t\t\t\t\t  AR9300_11NA_HT_DS_SHIFT,\n\t\t\t\t\t\t  AR9300_11NA_HT_TS_SHIFT,\n\t\t\t\t\t\t  IS_CHAN_HT40(chan));\n\t\t\tar9003_hw_init_txpower_stbc(ah,\n\t\t\t\t\t\t    AR9300_11NA_HT_SS_SHIFT,\n\t\t\t\t\t\t    AR9300_11NA_HT_DS_SHIFT,\n\t\t\t\t\t\t    AR9300_11NA_HT_TS_SHIFT);\n\t\t}\n\t} else {\n\t\tar9003_hw_init_txpower_cck(ah, rate_array);\n\t\tar9003_hw_init_txpower_ofdm(ah, rate_array,\n\t\t\t\t\t    AR9300_11NG_OFDM_SHIFT);\n\t\tif (IS_CHAN_HT20(chan) || IS_CHAN_HT40(chan)) {\n\t\t\tar9003_hw_init_txpower_ht(ah, rate_array,\n\t\t\t\t\t\t  AR9300_11NG_HT_SS_SHIFT,\n\t\t\t\t\t\t  AR9300_11NG_HT_DS_SHIFT,\n\t\t\t\t\t\t  AR9300_11NG_HT_TS_SHIFT,\n\t\t\t\t\t\t  IS_CHAN_HT40(chan));\n\t\t\tar9003_hw_init_txpower_stbc(ah,\n\t\t\t\t\t\t    AR9300_11NG_HT_SS_SHIFT,\n\t\t\t\t\t\t    AR9300_11NG_HT_DS_SHIFT,\n\t\t\t\t\t\t    AR9300_11NG_HT_TS_SHIFT);\n\t\t}\n\t}\n}\n\nvoid ar9003_hw_attach_phy_ops(struct ath_hw *ah)\n{\n\tstruct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);\n\tstruct ath_hw_ops *ops = ath9k_hw_ops(ah);\n\tstatic const u32 ar9300_cca_regs[6] = {\n\t\tAR_PHY_CCA_0,\n\t\tAR_PHY_CCA_1,\n\t\tAR_PHY_CCA_2,\n\t\tAR_PHY_EXT_CCA,\n\t\tAR_PHY_EXT_CCA_1,\n\t\tAR_PHY_EXT_CCA_2,\n\t};\n\n\tpriv_ops->rf_set_freq = ar9003_hw_set_channel;\n\tpriv_ops->spur_mitigate_freq = ar9003_hw_spur_mitigate;\n\n\tif (AR_SREV_9340(ah) || AR_SREV_9550(ah) || AR_SREV_9531(ah) ||\n\t    AR_SREV_9561(ah))\n\t\tpriv_ops->compute_pll_control = ar9003_hw_compute_pll_control_soc;\n\telse\n\t\tpriv_ops->compute_pll_control = ar9003_hw_compute_pll_control;\n\n\tpriv_ops->set_channel_regs = ar9003_hw_set_channel_regs;\n\tpriv_ops->init_bb = ar9003_hw_init_bb;\n\tpriv_ops->process_ini = ar9003_hw_process_ini;\n\tpriv_ops->set_rfmode = ar9003_hw_set_rfmode;\n\tpriv_ops->mark_phy_inactive = ar9003_hw_mark_phy_inactive;\n\tpriv_ops->set_delta_slope = ar9003_hw_set_delta_slope;\n\tpriv_ops->rfbus_req = ar9003_hw_rfbus_req;\n\tpriv_ops->rfbus_done = ar9003_hw_rfbus_done;\n\tpriv_ops->ani_control = ar9003_hw_ani_control;\n\tpriv_ops->do_getnf = ar9003_hw_do_getnf;\n\tpriv_ops->ani_cache_ini_regs = ar9003_hw_ani_cache_ini_regs;\n\tpriv_ops->set_radar_params = ar9003_hw_set_radar_params;\n\tpriv_ops->fast_chan_change = ar9003_hw_fast_chan_change;\n\n\tops->antdiv_comb_conf_get = ar9003_hw_antdiv_comb_conf_get;\n\tops->antdiv_comb_conf_set = ar9003_hw_antdiv_comb_conf_set;\n\tops->spectral_scan_config = ar9003_hw_spectral_scan_config;\n\tops->spectral_scan_trigger = ar9003_hw_spectral_scan_trigger;\n\tops->spectral_scan_wait = ar9003_hw_spectral_scan_wait;\n\n#ifdef CONFIG_ATH9K_BTCOEX_SUPPORT\n\tops->set_bt_ant_diversity = ar9003_hw_set_bt_ant_diversity;\n#endif\n\tops->tx99_start = ar9003_hw_tx99_start;\n\tops->tx99_stop = ar9003_hw_tx99_stop;\n\tops->tx99_set_txpower = ar9003_hw_tx99_set_txpower;\n\n\tar9003_hw_set_nf_limits(ah);\n\tar9003_hw_set_radar_conf(ah);\n\tmemcpy(ah->nf_regs, ar9300_cca_regs, sizeof(ah->nf_regs));\n}\n\n \n\n \nbool ar9003_hw_bb_watchdog_check(struct ath_hw *ah)\n{\n\tu32 val;\n\n\tswitch(ah->bb_watchdog_last_status) {\n\tcase 0x04000539:\n\t\tval = REG_READ(ah, AR_PHY_RADAR_0);\n\t\tval &= (~AR_PHY_RADAR_0_FIRPWR);\n\t\tval |= SM(0x7f, AR_PHY_RADAR_0_FIRPWR);\n\t\tREG_WRITE(ah, AR_PHY_RADAR_0, val);\n\t\tudelay(1);\n\t\tval = REG_READ(ah, AR_PHY_RADAR_0);\n\t\tval &= ~AR_PHY_RADAR_0_FIRPWR;\n\t\tval |= SM(AR9300_DFS_FIRPWR, AR_PHY_RADAR_0_FIRPWR);\n\t\tREG_WRITE(ah, AR_PHY_RADAR_0, val);\n\n\t\treturn false;\n\tcase 0x1300000a:\n\t\treturn false;\n\tcase 0x0400000a:\n\tcase 0x04000b09:\n\t\treturn true;\n\tcase 0x04000409:\n\t\tif (AR_SREV_9340(ah) || AR_SREV_9531(ah) || AR_SREV_9561(ah))\n\t\t\treturn false;\n\t\telse\n\t\t\treturn true;\n\tdefault:\n\t\t \n\t\treturn true;\n\t}\n}\nEXPORT_SYMBOL(ar9003_hw_bb_watchdog_check);\n\nvoid ar9003_hw_bb_watchdog_config(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tu32 idle_tmo_ms = ah->bb_watchdog_timeout_ms;\n\tu32 val, idle_count;\n\n\tif (!idle_tmo_ms) {\n\t\t \n\t\tREG_WRITE(ah, AR_PHY_WATCHDOG_CTL_2,\n\t\t\t  REG_READ(ah, AR_PHY_WATCHDOG_CTL_2) &\n\t\t\t  ~(AR_PHY_WATCHDOG_RST_ENABLE |\n\t\t\t    AR_PHY_WATCHDOG_IRQ_ENABLE));\n\n\t\t \n\t\tREG_WRITE(ah, AR_PHY_WATCHDOG_CTL_1,\n\t\t\t  REG_READ(ah, AR_PHY_WATCHDOG_CTL_1) &\n\t\t\t  ~(AR_PHY_WATCHDOG_NON_IDLE_ENABLE |\n\t\t\t    AR_PHY_WATCHDOG_IDLE_ENABLE));\n\n\t\tath_dbg(common, RESET, \"Disabled BB Watchdog\\n\");\n\t\treturn;\n\t}\n\n\t \n\tval = REG_READ(ah, AR_PHY_WATCHDOG_CTL_2) & AR_PHY_WATCHDOG_CNTL2_MASK;\n\tREG_WRITE(ah, AR_PHY_WATCHDOG_CTL_2,\n\t\t  (val | AR_PHY_WATCHDOG_IRQ_ENABLE) &\n\t\t  ~AR_PHY_WATCHDOG_RST_ENABLE);\n\n\t \n\tif (idle_tmo_ms > 10000)\n\t\tidle_tmo_ms = 10000;\n\n\t \n\tidle_count = (100 * idle_tmo_ms) / 74;\n\tif (ah->curchan && IS_CHAN_HT40(ah->curchan))\n\t\tidle_count = (100 * idle_tmo_ms) / 37;\n\n\t \n\tREG_WRITE(ah, AR_PHY_WATCHDOG_CTL_1,\n\t\t  AR_PHY_WATCHDOG_NON_IDLE_ENABLE |\n\t\t  AR_PHY_WATCHDOG_IDLE_MASK |\n\t\t  (AR_PHY_WATCHDOG_NON_IDLE_MASK & (idle_count << 2)));\n\n\tath_dbg(common, RESET, \"Enabled BB Watchdog timeout (%u ms)\\n\",\n\t\tidle_tmo_ms);\n}\n\nvoid ar9003_hw_bb_watchdog_read(struct ath_hw *ah)\n{\n\t \n\tah->bb_watchdog_last_status = REG_READ(ah, AR_PHY_WATCHDOG_STATUS);\n\n\t \n\tREG_WRITE(ah, AR_PHY_WATCHDOG_STATUS,\n\t\t  ah->bb_watchdog_last_status & ~AR_PHY_WATCHDOG_STATUS_CLR);\n}\n\nvoid ar9003_hw_bb_watchdog_dbg_info(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tu32 status;\n\n\tif (likely(!(common->debug_mask & ATH_DBG_RESET)))\n\t\treturn;\n\n\tstatus = ah->bb_watchdog_last_status;\n\tath_dbg(common, RESET,\n\t\t\"\\n==== BB update: BB status=0x%08x ====\\n\", status);\n\tath_dbg(common, RESET,\n\t\t\"** BB state: wd=%u det=%u rdar=%u rOFDM=%d rCCK=%u tOFDM=%u tCCK=%u agc=%u src=%u **\\n\",\n\t\tMS(status, AR_PHY_WATCHDOG_INFO),\n\t\tMS(status, AR_PHY_WATCHDOG_DET_HANG),\n\t\tMS(status, AR_PHY_WATCHDOG_RADAR_SM),\n\t\tMS(status, AR_PHY_WATCHDOG_RX_OFDM_SM),\n\t\tMS(status, AR_PHY_WATCHDOG_RX_CCK_SM),\n\t\tMS(status, AR_PHY_WATCHDOG_TX_OFDM_SM),\n\t\tMS(status, AR_PHY_WATCHDOG_TX_CCK_SM),\n\t\tMS(status, AR_PHY_WATCHDOG_AGC_SM),\n\t\tMS(status, AR_PHY_WATCHDOG_SRCH_SM));\n\n\tath_dbg(common, RESET, \"** BB WD cntl: cntl1=0x%08x cntl2=0x%08x **\\n\",\n\t\tREG_READ(ah, AR_PHY_WATCHDOG_CTL_1),\n\t\tREG_READ(ah, AR_PHY_WATCHDOG_CTL_2));\n\tath_dbg(common, RESET, \"** BB mode: BB_gen_controls=0x%08x **\\n\",\n\t\tREG_READ(ah, AR_PHY_GEN_CTRL));\n\n#define PCT(_field) (common->cc_survey._field * 100 / common->cc_survey.cycles)\n\tif (common->cc_survey.cycles)\n\t\tath_dbg(common, RESET,\n\t\t\t\"** BB busy times: rx_clear=%d%%, rx_frame=%d%%, tx_frame=%d%% **\\n\",\n\t\t\tPCT(rx_busy), PCT(rx_frame), PCT(tx_frame));\n\n\tath_dbg(common, RESET, \"==== BB update: done ====\\n\\n\");\n}\nEXPORT_SYMBOL(ar9003_hw_bb_watchdog_dbg_info);\n\nvoid ar9003_hw_disable_phy_restart(struct ath_hw *ah)\n{\n\tu8 result;\n\tu32 val;\n\n\t \n\tresult = MS(ah->bb_watchdog_last_status, AR_PHY_WATCHDOG_RX_OFDM_SM);\n\n\tif ((result == 0xb) || ah->bb_hang_rx_ofdm) {\n\t\tah->bb_hang_rx_ofdm = true;\n\t\tval = REG_READ(ah, AR_PHY_RESTART);\n\t\tval &= ~AR_PHY_RESTART_ENA;\n\t\tREG_WRITE(ah, AR_PHY_RESTART, val);\n\t}\n}\nEXPORT_SYMBOL(ar9003_hw_disable_phy_restart);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}