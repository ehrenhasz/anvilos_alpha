{
  "module_name": "antenna.c",
  "hash_id": "ccc656d86a567da7da11752fa60323fa3684d97f557eee53cedb95661bdcd88f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/antenna.c",
  "human_readable_source": " \n\n#include \"ath9k.h\"\n\n \n\nstatic inline bool ath_is_alt_ant_ratio_better(struct ath_ant_comb *antcomb,\n\t\t\t\t\t       int alt_ratio, int maxdelta,\n\t\t\t\t\t       int mindelta, int main_rssi_avg,\n\t\t\t\t\t       int alt_rssi_avg, int pkt_count)\n{\n\tif (pkt_count <= 50)\n\t\treturn false;\n\n\tif (alt_rssi_avg > main_rssi_avg + mindelta)\n\t\treturn true;\n\n\tif (alt_ratio >= antcomb->ant_ratio2 &&\n\t    alt_rssi_avg >= antcomb->low_rssi_thresh &&\n\t    (alt_rssi_avg > main_rssi_avg + maxdelta))\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic inline bool ath_ant_div_comb_alt_check(struct ath_hw_antcomb_conf *conf,\n\t\t\t\t\t      struct ath_ant_comb *antcomb,\n\t\t\t\t\t      int alt_ratio, int alt_rssi_avg,\n\t\t\t\t\t      int main_rssi_avg)\n{\n\tbool result, set1, set2;\n\n\tresult = set1 = set2 = false;\n\n\tif (conf->main_lna_conf == ATH_ANT_DIV_COMB_LNA2 &&\n\t    conf->alt_lna_conf == ATH_ANT_DIV_COMB_LNA1)\n\t\tset1 = true;\n\n\tif (conf->main_lna_conf == ATH_ANT_DIV_COMB_LNA1 &&\n\t    conf->alt_lna_conf == ATH_ANT_DIV_COMB_LNA2)\n\t\tset2 = true;\n\n\tswitch (conf->div_group) {\n\tcase 0:\n\t\tif (alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO)\n\t\t\tresult = true;\n\t\tbreak;\n\tcase 1:\n\tcase 2:\n\t\tif (alt_rssi_avg < 4 || alt_rssi_avg < antcomb->low_rssi_thresh)\n\t\t\tbreak;\n\n\t\tif ((set1 && (alt_rssi_avg >= (main_rssi_avg - 5))) ||\n\t\t    (set2 && (alt_rssi_avg >= (main_rssi_avg - 2))) ||\n\t\t    (alt_ratio > antcomb->ant_ratio))\n\t\t\tresult = true;\n\n\t\tbreak;\n\tcase 3:\n\t\tif (alt_rssi_avg < 4 || alt_rssi_avg < antcomb->low_rssi_thresh)\n\t\t\tbreak;\n\n\t\tif ((set1 && (alt_rssi_avg >= (main_rssi_avg - 3))) ||\n\t\t    (set2 && (alt_rssi_avg >= (main_rssi_avg + 3))) ||\n\t\t    (alt_ratio > antcomb->ant_ratio))\n\t\t\tresult = true;\n\n\t\tbreak;\n\t}\n\n\treturn result;\n}\n\nstatic void ath_lnaconf_alt_good_scan(struct ath_ant_comb *antcomb,\n\t\t\t\t      struct ath_hw_antcomb_conf ant_conf,\n\t\t\t\t      int main_rssi_avg)\n{\n\tantcomb->quick_scan_cnt = 0;\n\n\tif (ant_conf.main_lna_conf == ATH_ANT_DIV_COMB_LNA2)\n\t\tantcomb->rssi_lna2 = main_rssi_avg;\n\telse if (ant_conf.main_lna_conf == ATH_ANT_DIV_COMB_LNA1)\n\t\tantcomb->rssi_lna1 = main_rssi_avg;\n\n\tswitch ((ant_conf.main_lna_conf << 4) | ant_conf.alt_lna_conf) {\n\tcase 0x10:  \n\t\tantcomb->main_conf = ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\n\t\tantcomb->first_quick_scan_conf =\n\t\t\tATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\n\t\tantcomb->second_quick_scan_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\tbreak;\n\tcase 0x20:  \n\t\tantcomb->main_conf = ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\n\t\tantcomb->first_quick_scan_conf =\n\t\t\tATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\n\t\tantcomb->second_quick_scan_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\tbreak;\n\tcase 0x21:  \n\t\tantcomb->main_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\tantcomb->first_quick_scan_conf =\n\t\t\tATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\n\t\tantcomb->second_quick_scan_conf =\n\t\t\tATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\n\t\tbreak;\n\tcase 0x12:  \n\t\tantcomb->main_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\tantcomb->first_quick_scan_conf =\n\t\t\tATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\n\t\tantcomb->second_quick_scan_conf =\n\t\t\tATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\n\t\tbreak;\n\tcase 0x13:  \n\t\tantcomb->main_conf = ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\n\t\tantcomb->first_quick_scan_conf =\n\t\t\tATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\n\t\tantcomb->second_quick_scan_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\tbreak;\n\tcase 0x23:  \n\t\tantcomb->main_conf = ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\n\t\tantcomb->first_quick_scan_conf =\n\t\t\tATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\n\t\tantcomb->second_quick_scan_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void ath_ant_set_alt_ratio(struct ath_ant_comb *antcomb,\n\t\t\t\t  struct ath_hw_antcomb_conf *conf)\n{\n\t \n\tif (antcomb->first_ratio && antcomb->second_ratio) {\n\t\tif (antcomb->rssi_second > antcomb->rssi_third) {\n\t\t\t \n\t\t\tif ((antcomb->first_quick_scan_conf == ATH_ANT_DIV_COMB_LNA1) ||\n\t\t\t    (antcomb->first_quick_scan_conf == ATH_ANT_DIV_COMB_LNA2))\n\t\t\t\t \n\t\t\t\tif (conf->main_lna_conf == ATH_ANT_DIV_COMB_LNA2)\n\t\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t\t\telse\n\t\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\t\telse\n\t\t\t\t \n\t\t\t\tconf->alt_lna_conf =\n\t\t\t\t\tantcomb->first_quick_scan_conf;\n\t\t} else if ((antcomb->second_quick_scan_conf == ATH_ANT_DIV_COMB_LNA1) ||\n\t\t\t   (antcomb->second_quick_scan_conf == ATH_ANT_DIV_COMB_LNA2)) {\n\t\t\t \n\t\t\tif (conf->main_lna_conf == ATH_ANT_DIV_COMB_LNA2)\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t\telse\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\t} else {\n\t\t\t \n\t\t\tconf->alt_lna_conf = antcomb->second_quick_scan_conf;\n\t\t}\n\t} else if (antcomb->first_ratio) {\n\t\t \n\t\tif ((antcomb->first_quick_scan_conf == ATH_ANT_DIV_COMB_LNA1) ||\n\t\t    (antcomb->first_quick_scan_conf == ATH_ANT_DIV_COMB_LNA2))\n\t\t\t \n\t\t\tif (conf->main_lna_conf == ATH_ANT_DIV_COMB_LNA2)\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t\telse\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\telse\n\t\t\t \n\t\t\tconf->alt_lna_conf = antcomb->first_quick_scan_conf;\n\t} else if (antcomb->second_ratio) {\n\t\t \n\t\tif ((antcomb->second_quick_scan_conf == ATH_ANT_DIV_COMB_LNA1) ||\n\t\t    (antcomb->second_quick_scan_conf == ATH_ANT_DIV_COMB_LNA2))\n\t\t\t \n\t\t\tif (conf->main_lna_conf == ATH_ANT_DIV_COMB_LNA2)\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t\telse\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\telse\n\t\t\t \n\t\t\tconf->alt_lna_conf = antcomb->second_quick_scan_conf;\n\t} else {\n\t\t \n\t\tif ((antcomb->main_conf == ATH_ANT_DIV_COMB_LNA1) ||\n\t\t    (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA2))\n\t\t\t \n\t\t\tif (conf->main_lna_conf == ATH_ANT_DIV_COMB_LNA2)\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t\telse\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\telse\n\t\t\t \n\t\t\tconf->alt_lna_conf = antcomb->main_conf;\n\t}\n}\n\nstatic void ath_select_ant_div_from_quick_scan(struct ath_ant_comb *antcomb,\n\t\t\t\t       struct ath_hw_antcomb_conf *div_ant_conf,\n\t\t\t\t       int main_rssi_avg, int alt_rssi_avg,\n\t\t\t\t       int alt_ratio)\n{\n\t \n\tswitch (antcomb->quick_scan_cnt) {\n\tcase 0:\n\t\t \n\t\tdiv_ant_conf->main_lna_conf = antcomb->main_conf;\n\t\tdiv_ant_conf->alt_lna_conf = antcomb->first_quick_scan_conf;\n\t\tbreak;\n\tcase 1:\n\t\t \n\t\tdiv_ant_conf->main_lna_conf = antcomb->main_conf;\n\t\tdiv_ant_conf->alt_lna_conf = antcomb->second_quick_scan_conf;\n\t\tantcomb->rssi_first = main_rssi_avg;\n\t\tantcomb->rssi_second = alt_rssi_avg;\n\n\t\tif (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA1) {\n\t\t\t \n\t\t\tif (ath_is_alt_ant_ratio_better(antcomb, alt_ratio,\n\t\t\t\t\t\tATH_ANT_DIV_COMB_LNA1_DELTA_HI,\n\t\t\t\t\t\tATH_ANT_DIV_COMB_LNA1_DELTA_LOW,\n\t\t\t\t\t\tmain_rssi_avg, alt_rssi_avg,\n\t\t\t\t\t\tantcomb->total_pkt_count))\n\t\t\t\tantcomb->first_ratio = true;\n\t\t\telse\n\t\t\t\tantcomb->first_ratio = false;\n\t\t} else if (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA2) {\n\t\t\tif (ath_is_alt_ant_ratio_better(antcomb, alt_ratio,\n\t\t\t\t\t\tATH_ANT_DIV_COMB_LNA1_DELTA_MID,\n\t\t\t\t\t\tATH_ANT_DIV_COMB_LNA1_DELTA_LOW,\n\t\t\t\t\t\tmain_rssi_avg, alt_rssi_avg,\n\t\t\t\t\t\tantcomb->total_pkt_count))\n\t\t\t\tantcomb->first_ratio = true;\n\t\t\telse\n\t\t\t\tantcomb->first_ratio = false;\n\t\t} else {\n\t\t\tif (ath_is_alt_ant_ratio_better(antcomb, alt_ratio,\n\t\t\t\t\t\tATH_ANT_DIV_COMB_LNA1_DELTA_HI,\n\t\t\t\t\t\t0,\n\t\t\t\t\t\tmain_rssi_avg, alt_rssi_avg,\n\t\t\t\t\t\tantcomb->total_pkt_count))\n\t\t\t\tantcomb->first_ratio = true;\n\t\t\telse\n\t\t\t\tantcomb->first_ratio = false;\n\t\t}\n\t\tbreak;\n\tcase 2:\n\t\tantcomb->alt_good = false;\n\t\tantcomb->scan_not_start = false;\n\t\tantcomb->scan = false;\n\t\tantcomb->rssi_first = main_rssi_avg;\n\t\tantcomb->rssi_third = alt_rssi_avg;\n\n\t\tswitch(antcomb->second_quick_scan_conf) {\n\t\tcase ATH_ANT_DIV_COMB_LNA1:\n\t\t\tantcomb->rssi_lna1 = alt_rssi_avg;\n\t\t\tbreak;\n\t\tcase ATH_ANT_DIV_COMB_LNA2:\n\t\t\tantcomb->rssi_lna2 = alt_rssi_avg;\n\t\t\tbreak;\n\t\tcase ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2:\n\t\t\tif (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA2)\n\t\t\t\tantcomb->rssi_lna2 = main_rssi_avg;\n\t\t\telse if (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA1)\n\t\t\t\tantcomb->rssi_lna1 = main_rssi_avg;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tif (antcomb->rssi_lna2 > antcomb->rssi_lna1 +\n\t\t    div_ant_conf->lna1_lna2_switch_delta)\n\t\t\tdiv_ant_conf->main_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\telse\n\t\t\tdiv_ant_conf->main_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\n\t\tif (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA1) {\n\t\t\tif (ath_is_alt_ant_ratio_better(antcomb, alt_ratio,\n\t\t\t\t\t\tATH_ANT_DIV_COMB_LNA1_DELTA_HI,\n\t\t\t\t\t\tATH_ANT_DIV_COMB_LNA1_DELTA_LOW,\n\t\t\t\t\t\tmain_rssi_avg, alt_rssi_avg,\n\t\t\t\t\t\tantcomb->total_pkt_count))\n\t\t\t\tantcomb->second_ratio = true;\n\t\t\telse\n\t\t\t\tantcomb->second_ratio = false;\n\t\t} else if (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA2) {\n\t\t\tif (ath_is_alt_ant_ratio_better(antcomb, alt_ratio,\n\t\t\t\t\t\tATH_ANT_DIV_COMB_LNA1_DELTA_MID,\n\t\t\t\t\t\tATH_ANT_DIV_COMB_LNA1_DELTA_LOW,\n\t\t\t\t\t\tmain_rssi_avg, alt_rssi_avg,\n\t\t\t\t\t\tantcomb->total_pkt_count))\n\t\t\t\tantcomb->second_ratio = true;\n\t\t\telse\n\t\t\t\tantcomb->second_ratio = false;\n\t\t} else {\n\t\t\tif (ath_is_alt_ant_ratio_better(antcomb, alt_ratio,\n\t\t\t\t\t\tATH_ANT_DIV_COMB_LNA1_DELTA_HI,\n\t\t\t\t\t\t0,\n\t\t\t\t\t\tmain_rssi_avg, alt_rssi_avg,\n\t\t\t\t\t\tantcomb->total_pkt_count))\n\t\t\t\tantcomb->second_ratio = true;\n\t\t\telse\n\t\t\t\tantcomb->second_ratio = false;\n\t\t}\n\n\t\tath_ant_set_alt_ratio(antcomb, div_ant_conf);\n\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void ath_ant_div_conf_fast_divbias(struct ath_hw_antcomb_conf *ant_conf,\n\t\t\t\t\t  struct ath_ant_comb *antcomb,\n\t\t\t\t\t  int alt_ratio)\n{\n\tant_conf->main_gaintb = 0;\n\tant_conf->alt_gaintb = 0;\n\n\tif (ant_conf->div_group == 0) {\n\t\t \n\t\tswitch ((ant_conf->main_lna_conf << 4) |\n\t\t\t\tant_conf->alt_lna_conf) {\n\t\tcase 0x01:  \n\t\t\tant_conf->fast_div_bias = 0x3b;\n\t\t\tbreak;\n\t\tcase 0x02:  \n\t\t\tant_conf->fast_div_bias = 0x3d;\n\t\t\tbreak;\n\t\tcase 0x03:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x10:  \n\t\t\tant_conf->fast_div_bias = 0x7;\n\t\t\tbreak;\n\t\tcase 0x12:  \n\t\t\tant_conf->fast_div_bias = 0x2;\n\t\t\tbreak;\n\t\tcase 0x13:  \n\t\t\tant_conf->fast_div_bias = 0x7;\n\t\t\tbreak;\n\t\tcase 0x20:  \n\t\t\tant_conf->fast_div_bias = 0x6;\n\t\t\tbreak;\n\t\tcase 0x21:  \n\t\t\tant_conf->fast_div_bias = 0x0;\n\t\t\tbreak;\n\t\tcase 0x23:  \n\t\t\tant_conf->fast_div_bias = 0x6;\n\t\t\tbreak;\n\t\tcase 0x30:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x31:  \n\t\t\tant_conf->fast_div_bias = 0x3b;\n\t\t\tbreak;\n\t\tcase 0x32:  \n\t\t\tant_conf->fast_div_bias = 0x3d;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t} else if (ant_conf->div_group == 1) {\n\t\t \n\t\tswitch ((ant_conf->main_lna_conf << 4) |\n\t\t\tant_conf->alt_lna_conf) {\n\t\tcase 0x01:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x02:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x03:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x10:  \n\t\t\tif (!(antcomb->scan) &&\n\t\t\t    (alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\n\t\t\t\tant_conf->fast_div_bias = 0x3f;\n\t\t\telse\n\t\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x12:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x13:  \n\t\t\tif (!(antcomb->scan) &&\n\t\t\t    (alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\n\t\t\t\tant_conf->fast_div_bias = 0x3f;\n\t\t\telse\n\t\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x20:  \n\t\t\tif (!(antcomb->scan) &&\n\t\t\t    (alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\n\t\t\t\tant_conf->fast_div_bias = 0x3f;\n\t\t\telse\n\t\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x21:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x23:  \n\t\t\tif (!(antcomb->scan) &&\n\t\t\t    (alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\n\t\t\t\tant_conf->fast_div_bias = 0x3f;\n\t\t\telse\n\t\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x30:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x31:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x32:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t} else if (ant_conf->div_group == 2) {\n\t\t \n\t\tswitch ((ant_conf->main_lna_conf << 4) |\n\t\t\t\tant_conf->alt_lna_conf) {\n\t\tcase 0x01:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x02:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x03:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x10:  \n\t\t\tif (!antcomb->scan && (alt_ratio > antcomb->ant_ratio))\n\t\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\telse\n\t\t\t\tant_conf->fast_div_bias = 0x2;\n\t\t\tbreak;\n\t\tcase 0x12:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x13:  \n\t\t\tif (!antcomb->scan && (alt_ratio > antcomb->ant_ratio))\n\t\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\telse\n\t\t\t\tant_conf->fast_div_bias = 0x2;\n\t\t\tbreak;\n\t\tcase 0x20:  \n\t\t\tif (!antcomb->scan && (alt_ratio > antcomb->ant_ratio))\n\t\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\telse\n\t\t\t\tant_conf->fast_div_bias = 0x2;\n\t\t\tbreak;\n\t\tcase 0x21:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x23:  \n\t\t\tif (!antcomb->scan && (alt_ratio > antcomb->ant_ratio))\n\t\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\telse\n\t\t\t\tant_conf->fast_div_bias = 0x2;\n\t\t\tbreak;\n\t\tcase 0x30:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x31:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x32:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tif (antcomb->fast_div_bias)\n\t\t\tant_conf->fast_div_bias = antcomb->fast_div_bias;\n\t} else if (ant_conf->div_group == 3) {\n\t\tswitch ((ant_conf->main_lna_conf << 4) |\n\t\t\tant_conf->alt_lna_conf) {\n\t\tcase 0x01:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x02:  \n\t\t\tant_conf->fast_div_bias = 0x39;\n\t\t\tbreak;\n\t\tcase 0x03:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x10:  \n\t\t\tant_conf->fast_div_bias = 0x2;\n\t\t\tbreak;\n\t\tcase 0x12:  \n\t\t\tant_conf->fast_div_bias = 0x3f;\n\t\t\tbreak;\n\t\tcase 0x13:  \n\t\t\tant_conf->fast_div_bias = 0x2;\n\t\t\tbreak;\n\t\tcase 0x20:  \n\t\t\tant_conf->fast_div_bias = 0x3;\n\t\t\tbreak;\n\t\tcase 0x21:  \n\t\t\tant_conf->fast_div_bias = 0x3;\n\t\t\tbreak;\n\t\tcase 0x23:  \n\t\t\tant_conf->fast_div_bias = 0x3;\n\t\t\tbreak;\n\t\tcase 0x30:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tcase 0x31:  \n\t\t\tant_conf->fast_div_bias = 0x6;\n\t\t\tbreak;\n\t\tcase 0x32:  \n\t\t\tant_conf->fast_div_bias = 0x1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic void ath_ant_try_scan(struct ath_ant_comb *antcomb,\n\t\t\t     struct ath_hw_antcomb_conf *conf,\n\t\t\t     int curr_alt_set, int alt_rssi_avg,\n\t\t\t     int main_rssi_avg)\n{\n\tswitch (curr_alt_set) {\n\tcase ATH_ANT_DIV_COMB_LNA2:\n\t\tantcomb->rssi_lna2 = alt_rssi_avg;\n\t\tantcomb->rssi_lna1 = main_rssi_avg;\n\t\tantcomb->scan = true;\n\t\t \n\t\tconf->main_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\n\t\tbreak;\n\tcase ATH_ANT_DIV_COMB_LNA1:\n\t\tantcomb->rssi_lna1 = alt_rssi_avg;\n\t\tantcomb->rssi_lna2 = main_rssi_avg;\n\t\tantcomb->scan = true;\n\t\t \n\t\tconf->main_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\n\t\tbreak;\n\tcase ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2:\n\t\tantcomb->rssi_add = alt_rssi_avg;\n\t\tantcomb->scan = true;\n\t\t \n\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\n\t\tbreak;\n\tcase ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2:\n\t\tantcomb->rssi_sub = alt_rssi_avg;\n\t\tantcomb->scan = false;\n\t\tif (antcomb->rssi_lna2 >\n\t\t    (antcomb->rssi_lna1 + conf->lna1_lna2_switch_delta)) {\n\t\t\t \n\t\t\tif ((antcomb->rssi_add > antcomb->rssi_lna1) &&\n\t\t\t    (antcomb->rssi_add > antcomb->rssi_sub)) {\n\t\t\t\t \n\t\t\t\tconf->main_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\n\t\t\t} else if (antcomb->rssi_sub >\n\t\t\t\t   antcomb->rssi_lna1) {\n\t\t\t\t \n\t\t\t\tconf->main_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tconf->main_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tif ((antcomb->rssi_add > antcomb->rssi_lna2) &&\n\t\t\t    (antcomb->rssi_add > antcomb->rssi_sub)) {\n\t\t\t\t \n\t\t\t\tconf->main_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\n\t\t\t} else if (antcomb->rssi_sub >\n\t\t\t\t   antcomb->rssi_lna1) {\n\t\t\t\t \n\t\t\t\tconf->main_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tconf->main_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t\t\tconf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic bool ath_ant_try_switch(struct ath_hw_antcomb_conf *div_ant_conf,\n\t\t\t       struct ath_ant_comb *antcomb,\n\t\t\t       int alt_ratio, int alt_rssi_avg,\n\t\t\t       int main_rssi_avg, int curr_main_set,\n\t\t\t       int curr_alt_set)\n{\n\tbool ret = false;\n\n\tif (ath_ant_div_comb_alt_check(div_ant_conf, antcomb, alt_ratio,\n\t\t\t\t       alt_rssi_avg, main_rssi_avg)) {\n\t\tif (curr_alt_set == ATH_ANT_DIV_COMB_LNA2) {\n\t\t\t \n\t\t\tdiv_ant_conf->main_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\t\tdiv_ant_conf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t} else if (curr_alt_set == ATH_ANT_DIV_COMB_LNA1) {\n\t\t\tdiv_ant_conf->main_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\t\tdiv_ant_conf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\t\t}\n\n\t\tret = true;\n\t} else if ((curr_alt_set != ATH_ANT_DIV_COMB_LNA1) &&\n\t\t   (curr_alt_set != ATH_ANT_DIV_COMB_LNA2)) {\n\t\t \n\t\tif (curr_main_set == ATH_ANT_DIV_COMB_LNA2)\n\t\t\tdiv_ant_conf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA1;\n\t\telse if (curr_main_set == ATH_ANT_DIV_COMB_LNA1)\n\t\t\tdiv_ant_conf->alt_lna_conf = ATH_ANT_DIV_COMB_LNA2;\n\n\t\tret = true;\n\t}\n\n\treturn ret;\n}\n\nstatic bool ath_ant_short_scan_check(struct ath_ant_comb *antcomb)\n{\n\tint alt_ratio;\n\n\tif (!antcomb->scan || !antcomb->alt_good)\n\t\treturn false;\n\n\tif (time_after(jiffies, antcomb->scan_start_time +\n\t\t       msecs_to_jiffies(ATH_ANT_DIV_COMB_SHORT_SCAN_INTR)))\n\t\treturn true;\n\n\tif (antcomb->total_pkt_count == ATH_ANT_DIV_COMB_SHORT_SCAN_PKTCOUNT) {\n\t\talt_ratio = ((antcomb->alt_recv_cnt * 100) /\n\t\t\t     antcomb->total_pkt_count);\n\t\tif (alt_ratio < antcomb->ant_ratio)\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nvoid ath_ant_comb_scan(struct ath_softc *sc, struct ath_rx_status *rs)\n{\n\tstruct ath_hw_antcomb_conf div_ant_conf;\n\tstruct ath_ant_comb *antcomb = &sc->ant_comb;\n\tint alt_ratio = 0, alt_rssi_avg = 0, main_rssi_avg = 0, curr_alt_set;\n\tint curr_main_set;\n\tint main_rssi = rs->rs_rssi_ctl[0];\n\tint alt_rssi = rs->rs_rssi_ctl[1];\n\tint rx_ant_conf,  main_ant_conf;\n\tbool short_scan = false, ret;\n\n\trx_ant_conf = (rs->rs_rssi_ctl[2] >> ATH_ANT_RX_CURRENT_SHIFT) &\n\t\t       ATH_ANT_RX_MASK;\n\tmain_ant_conf = (rs->rs_rssi_ctl[2] >> ATH_ANT_RX_MAIN_SHIFT) &\n\t\t\t ATH_ANT_RX_MASK;\n\n\tif (alt_rssi >= antcomb->low_rssi_thresh) {\n\t\tantcomb->ant_ratio = ATH_ANT_DIV_COMB_ALT_ANT_RATIO;\n\t\tantcomb->ant_ratio2 = ATH_ANT_DIV_COMB_ALT_ANT_RATIO2;\n\t} else {\n\t\tantcomb->ant_ratio = ATH_ANT_DIV_COMB_ALT_ANT_RATIO_LOW_RSSI;\n\t\tantcomb->ant_ratio2 = ATH_ANT_DIV_COMB_ALT_ANT_RATIO2_LOW_RSSI;\n\t}\n\n\t \n\tif (main_rssi > 0 && alt_rssi > 0) {\n\t\tantcomb->total_pkt_count++;\n\t\tantcomb->main_total_rssi += main_rssi;\n\t\tantcomb->alt_total_rssi  += alt_rssi;\n\n\t\tif (main_ant_conf == rx_ant_conf)\n\t\t\tantcomb->main_recv_cnt++;\n\t\telse\n\t\t\tantcomb->alt_recv_cnt++;\n\t}\n\n\tif (main_ant_conf == rx_ant_conf) {\n\t\tANT_STAT_INC(sc, ANT_MAIN, recv_cnt);\n\t\tANT_LNA_INC(sc, ANT_MAIN, rx_ant_conf);\n\t} else {\n\t\tANT_STAT_INC(sc, ANT_ALT, recv_cnt);\n\t\tANT_LNA_INC(sc, ANT_ALT, rx_ant_conf);\n\t}\n\n\t \n\tshort_scan = ath_ant_short_scan_check(antcomb);\n\n\tif (((antcomb->total_pkt_count < ATH_ANT_DIV_COMB_MAX_PKTCOUNT) ||\n\t     rs->rs_moreaggr) && !short_scan)\n\t\treturn;\n\n\tif (antcomb->total_pkt_count) {\n\t\talt_ratio = ((antcomb->alt_recv_cnt * 100) /\n\t\t\t     antcomb->total_pkt_count);\n\t\tmain_rssi_avg = (antcomb->main_total_rssi /\n\t\t\t\t antcomb->total_pkt_count);\n\t\talt_rssi_avg = (antcomb->alt_total_rssi /\n\t\t\t\t antcomb->total_pkt_count);\n\t}\n\n\tath9k_hw_antdiv_comb_conf_get(sc->sc_ah, &div_ant_conf);\n\tcurr_alt_set = div_ant_conf.alt_lna_conf;\n\tcurr_main_set = div_ant_conf.main_lna_conf;\n\tantcomb->count++;\n\n\tif (antcomb->count == ATH_ANT_DIV_COMB_MAX_COUNT) {\n\t\tif (alt_ratio > antcomb->ant_ratio) {\n\t\t\tath_lnaconf_alt_good_scan(antcomb, div_ant_conf,\n\t\t\t\t\t\t  main_rssi_avg);\n\t\t\tantcomb->alt_good = true;\n\t\t} else {\n\t\t\tantcomb->alt_good = false;\n\t\t}\n\n\t\tantcomb->count = 0;\n\t\tantcomb->scan = true;\n\t\tantcomb->scan_not_start = true;\n\t}\n\n\tif (!antcomb->scan) {\n\t\tret = ath_ant_try_switch(&div_ant_conf, antcomb, alt_ratio,\n\t\t\t\t\t alt_rssi_avg, main_rssi_avg,\n\t\t\t\t\t curr_main_set, curr_alt_set);\n\t\tif (ret)\n\t\t\tgoto div_comb_done;\n\t}\n\n\tif (!antcomb->scan &&\n\t    (alt_rssi_avg < (main_rssi_avg + div_ant_conf.lna1_lna2_delta)))\n\t\tgoto div_comb_done;\n\n\tif (!antcomb->scan_not_start) {\n\t\tath_ant_try_scan(antcomb, &div_ant_conf, curr_alt_set,\n\t\t\t\t alt_rssi_avg, main_rssi_avg);\n\t} else {\n\t\tif (!antcomb->alt_good) {\n\t\t\tantcomb->scan_not_start = false;\n\t\t\t \n\t\t\tif (curr_main_set == ATH_ANT_DIV_COMB_LNA2) {\n\t\t\t\tdiv_ant_conf.main_lna_conf =\n\t\t\t\t\tATH_ANT_DIV_COMB_LNA2;\n\t\t\t\tdiv_ant_conf.alt_lna_conf =\n\t\t\t\t\tATH_ANT_DIV_COMB_LNA1;\n\t\t\t} else if (curr_main_set == ATH_ANT_DIV_COMB_LNA1) {\n\t\t\t\tdiv_ant_conf.main_lna_conf =\n\t\t\t\t\tATH_ANT_DIV_COMB_LNA1;\n\t\t\t\tdiv_ant_conf.alt_lna_conf =\n\t\t\t\t\tATH_ANT_DIV_COMB_LNA2;\n\t\t\t}\n\t\t\tgoto div_comb_done;\n\t\t}\n\t\tath_select_ant_div_from_quick_scan(antcomb, &div_ant_conf,\n\t\t\t\t\t\t   main_rssi_avg, alt_rssi_avg,\n\t\t\t\t\t\t   alt_ratio);\n\t\tantcomb->quick_scan_cnt++;\n\t}\n\ndiv_comb_done:\n\tath_ant_div_conf_fast_divbias(&div_ant_conf, antcomb, alt_ratio);\n\tath9k_hw_antdiv_comb_conf_set(sc->sc_ah, &div_ant_conf);\n\tath9k_debug_stat_ant(sc, &div_ant_conf, main_rssi_avg, alt_rssi_avg);\n\n\tantcomb->scan_start_time = jiffies;\n\tantcomb->total_pkt_count = 0;\n\tantcomb->main_total_rssi = 0;\n\tantcomb->alt_total_rssi = 0;\n\tantcomb->main_recv_cnt = 0;\n\tantcomb->alt_recv_cnt = 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}