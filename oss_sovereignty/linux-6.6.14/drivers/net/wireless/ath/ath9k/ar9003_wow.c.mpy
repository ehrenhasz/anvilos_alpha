{
  "module_name": "ar9003_wow.c",
  "hash_id": "01a321808423d0454951a67d5af9dd216deb5d8501e9b160c5f9d06a6f5bd9d3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/ar9003_wow.c",
  "human_readable_source": " \n\n#include <linux/export.h>\n#include \"ath9k.h\"\n#include \"reg.h\"\n#include \"reg_wow.h\"\n#include \"hw-ops.h\"\n\nstatic void ath9k_hw_set_sta_powersave(struct ath_hw *ah)\n{\n\tif (!ath9k_hw_mci_is_enabled(ah))\n\t\tgoto set;\n\t \n\tif (ar9003_mci_state(ah, MCI_STATE_GET_WLAN_PS_STATE) != MCI_PS_DISABLE)\n\t\treturn;\nset:\n\tREG_SET_BIT(ah, AR_STA_ID1, AR_STA_ID1_PWR_SAV);\n}\n\nstatic void ath9k_hw_set_powermode_wow_sleep(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\n\tath9k_hw_set_sta_powersave(ah);\n\n\t \n\tREG_WRITE(ah, AR_CR, AR_CR_RXD);\n\n\tif (!ath9k_hw_wait(ah, AR_CR, AR_CR_RXE(ah), 0, AH_WAIT_TIMEOUT)) {\n\t\tath_err(common, \"Failed to stop Rx DMA in 10ms AR_CR=0x%08x AR_DIAG_SW=0x%08x\\n\",\n\t\t\tREG_READ(ah, AR_CR), REG_READ(ah, AR_DIAG_SW));\n\t\treturn;\n\t}\n\n\tif (AR_SREV_9462(ah) || AR_SREV_9565(ah)) {\n\t\tif (!REG_READ(ah, AR_MAC_PCU_GEN_TIMER_TSF_SEL))\n\t\t\tREG_CLR_BIT(ah, AR_DIRECT_CONNECT, AR_DC_TSF2_ENABLE);\n\t} else if (AR_SREV_9485(ah)){\n\t\tif (!(REG_READ(ah, AR_NDP2_TIMER_MODE) &\n\t\t      AR_GEN_TIMERS2_MODE_ENABLE_MASK))\n\t\t\tREG_CLR_BIT(ah, AR_DIRECT_CONNECT, AR_DC_TSF2_ENABLE);\n\t}\n\n\tif (ath9k_hw_mci_is_enabled(ah))\n\t\tREG_WRITE(ah, AR_RTC_KEEP_AWAKE, 0x2);\n\n\tREG_WRITE(ah, AR_RTC_FORCE_WAKE(ah), AR_RTC_FORCE_WAKE_ON_INT);\n}\n\nstatic void ath9k_wow_create_keep_alive_pattern(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tu8 sta_mac_addr[ETH_ALEN], ap_mac_addr[ETH_ALEN];\n\tu32 ctl[13] = {0};\n\tu32 data_word[KAL_NUM_DATA_WORDS];\n\tu8 i;\n\tu32 wow_ka_data_word0;\n\n\tmemcpy(sta_mac_addr, common->macaddr, ETH_ALEN);\n\tmemcpy(ap_mac_addr, common->curbssid, ETH_ALEN);\n\n\t \n\tctl[0] = (KAL_FRAME_LEN | (MAX_RATE_POWER << 16));\n\tctl[1] = 0;\n\tctl[4] = 0;\n\tctl[7] = (ah->txchainmask) << 2;\n\tctl[2] = 0xf << 16;  \n\n\tif (IS_CHAN_2GHZ(ah->curchan))\n\t\tctl[3] = 0x1b;\t \n\telse\n\t\tctl[3] = 0xb;\t \n\n\tfor (i = 0; i < KAL_NUM_DESC_WORDS; i++)\n\t\tREG_WRITE(ah, (AR_WOW_KA_DESC_WORD2 + i * 4), ctl[i]);\n\n\tdata_word[0] = (KAL_FRAME_TYPE << 2) | (KAL_FRAME_SUB_TYPE << 4) |\n\t\t       (KAL_TO_DS << 8) | (KAL_DURATION_ID << 16);\n\tdata_word[1] = (ap_mac_addr[3] << 24) | (ap_mac_addr[2] << 16) |\n\t\t       (ap_mac_addr[1] << 8) | (ap_mac_addr[0]);\n\tdata_word[2] = (sta_mac_addr[1] << 24) | (sta_mac_addr[0] << 16) |\n\t\t       (ap_mac_addr[5] << 8) | (ap_mac_addr[4]);\n\tdata_word[3] = (sta_mac_addr[5] << 24) | (sta_mac_addr[4] << 16) |\n\t\t       (sta_mac_addr[3] << 8) | (sta_mac_addr[2]);\n\tdata_word[4] = (ap_mac_addr[3] << 24) | (ap_mac_addr[2] << 16) |\n\t\t       (ap_mac_addr[1] << 8) | (ap_mac_addr[0]);\n\tdata_word[5] = (ap_mac_addr[5] << 8) | (ap_mac_addr[4]);\n\n\tif (AR_SREV_9462_20_OR_LATER(ah) || AR_SREV_9565(ah)) {\n\t\t \n\t\tREG_WRITE(ah, (AR_WOW_KA_DESC_WORD2 + (12 * 4)), 0);\n\t\twow_ka_data_word0 = AR_WOW_TXBUF(13);\n\t} else {\n\t\twow_ka_data_word0 = AR_WOW_TXBUF(12);\n\t}\n\n\tfor (i = 0; i < KAL_NUM_DATA_WORDS; i++)\n\t\tREG_WRITE(ah, (wow_ka_data_word0 + i*4), data_word[i]);\n}\n\nint ath9k_hw_wow_apply_pattern(struct ath_hw *ah, u8 *user_pattern,\n\t\t\t       u8 *user_mask, int pattern_count,\n\t\t\t       int pattern_len)\n{\n\tint i;\n\tu32 pattern_val, mask_val;\n\tu32 set, clr;\n\n\tif (pattern_count >= ah->wow.max_patterns)\n\t\treturn -ENOSPC;\n\n\tif (pattern_count < MAX_NUM_PATTERN_LEGACY)\n\t\tREG_SET_BIT(ah, AR_WOW_PATTERN, BIT(pattern_count));\n\telse\n\t\tREG_SET_BIT(ah, AR_MAC_PCU_WOW4, BIT(pattern_count - 8));\n\n\tfor (i = 0; i < MAX_PATTERN_SIZE; i += 4) {\n\t\tmemcpy(&pattern_val, user_pattern, 4);\n\t\tREG_WRITE(ah, (AR_WOW_TB_PATTERN(pattern_count) + i),\n\t\t\t  pattern_val);\n\t\tuser_pattern += 4;\n\t}\n\n\tfor (i = 0; i < MAX_PATTERN_MASK_SIZE; i += 4) {\n\t\tmemcpy(&mask_val, user_mask, 4);\n\t\tREG_WRITE(ah, (AR_WOW_TB_MASK(pattern_count) + i), mask_val);\n\t\tuser_mask += 4;\n\t}\n\n\tif (pattern_count < MAX_NUM_PATTERN_LEGACY)\n\t\tah->wow.wow_event_mask |=\n\t\t\tBIT(pattern_count + AR_WOW_PAT_FOUND_SHIFT);\n\telse\n\t\tah->wow.wow_event_mask2 |=\n\t\t\tBIT((pattern_count - 8) + AR_WOW_PAT_FOUND_SHIFT);\n\n\tif (pattern_count < 4) {\n\t\tset = (pattern_len & AR_WOW_LENGTH_MAX) <<\n\t\t       AR_WOW_LEN1_SHIFT(pattern_count);\n\t\tclr = AR_WOW_LENGTH1_MASK(pattern_count);\n\t\tREG_RMW(ah, AR_WOW_LENGTH1, set, clr);\n\t} else if (pattern_count < 8) {\n\t\tset = (pattern_len & AR_WOW_LENGTH_MAX) <<\n\t\t       AR_WOW_LEN2_SHIFT(pattern_count);\n\t\tclr = AR_WOW_LENGTH2_MASK(pattern_count);\n\t\tREG_RMW(ah, AR_WOW_LENGTH2, set, clr);\n\t} else if (pattern_count < 12) {\n\t\tset = (pattern_len & AR_WOW_LENGTH_MAX) <<\n\t\t       AR_WOW_LEN3_SHIFT(pattern_count);\n\t\tclr = AR_WOW_LENGTH3_MASK(pattern_count);\n\t\tREG_RMW(ah, AR_WOW_LENGTH3, set, clr);\n\t} else if (pattern_count < MAX_NUM_PATTERN) {\n\t\tset = (pattern_len & AR_WOW_LENGTH_MAX) <<\n\t\t       AR_WOW_LEN4_SHIFT(pattern_count);\n\t\tclr = AR_WOW_LENGTH4_MASK(pattern_count);\n\t\tREG_RMW(ah, AR_WOW_LENGTH4, set, clr);\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL(ath9k_hw_wow_apply_pattern);\n\nu32 ath9k_hw_wow_wakeup(struct ath_hw *ah)\n{\n\tu32 wow_status = 0;\n\tu32 val = 0, rval;\n\n\t \n\trval = REG_READ(ah, AR_WOW_PATTERN);\n\tval = AR_WOW_STATUS(rval);\n\n\t \n\tval &= ah->wow.wow_event_mask;\n\n\tif (val) {\n\t\tif (val & AR_WOW_MAGIC_PAT_FOUND)\n\t\t\twow_status |= AH_WOW_MAGIC_PATTERN_EN;\n\t\tif (AR_WOW_PATTERN_FOUND(val))\n\t\t\twow_status |= AH_WOW_USER_PATTERN_EN;\n\t\tif (val & AR_WOW_KEEP_ALIVE_FAIL)\n\t\t\twow_status |= AH_WOW_LINK_CHANGE;\n\t\tif (val & AR_WOW_BEACON_FAIL)\n\t\t\twow_status |= AH_WOW_BEACON_MISS;\n\t}\n\n\trval = REG_READ(ah, AR_MAC_PCU_WOW4);\n\tval = AR_WOW_STATUS2(rval);\n\tval &= ah->wow.wow_event_mask2;\n\n\tif (val) {\n\t\tif (AR_WOW2_PATTERN_FOUND(val))\n\t\t\twow_status |= AH_WOW_USER_PATTERN_EN;\n\t}\n\n\t \n\n\t \n\tREG_RMW(ah, AR_PCIE_PM_CTRL(ah), AR_PMCTRL_WOW_PME_CLR,\n\t\tAR_PMCTRL_PWR_STATE_D1D3);\n\n\t \n\tREG_WRITE(ah, AR_WOW_PATTERN,\n\t\t  AR_WOW_CLEAR_EVENTS(REG_READ(ah, AR_WOW_PATTERN)));\n\tREG_WRITE(ah, AR_MAC_PCU_WOW4,\n\t\t  AR_WOW_CLEAR_EVENTS2(REG_READ(ah, AR_MAC_PCU_WOW4)));\n\n\t \n\tREG_WRITE(ah, AR_RSSI_THR, INIT_RSSI_THR);\n\n\t \n\tif (ah->is_pciexpress)\n\t\tath9k_hw_configpcipowersave(ah, false);\n\n\tif (AR_SREV_9462(ah) || AR_SREV_9565(ah) || AR_SREV_9485(ah)) {\n\t\tu32 dc = REG_READ(ah, AR_DIRECT_CONNECT);\n\n\t\tif (!(dc & AR_DC_TSF2_ENABLE))\n\t\t\tath9k_hw_gen_timer_start_tsf2(ah);\n\t}\n\n\tah->wow.wow_event_mask = 0;\n\tah->wow.wow_event_mask2 = 0;\n\n\treturn wow_status;\n}\nEXPORT_SYMBOL(ath9k_hw_wow_wakeup);\n\nstatic void ath9k_hw_wow_set_arwr_reg(struct ath_hw *ah)\n{\n\tu32 wa_reg;\n\n\tif (!ah->is_pciexpress)\n\t\treturn;\n\n\t \n\twa_reg = REG_READ(ah, AR_WA(ah));\n\twa_reg &= ~AR_WA_UNTIE_RESET_EN;\n\twa_reg |= AR_WA_RESET_EN;\n\twa_reg |= AR_WA_POR_SHORT;\n\n\tREG_WRITE(ah, AR_WA(ah), wa_reg);\n}\n\nvoid ath9k_hw_wow_enable(struct ath_hw *ah, u32 pattern_enable)\n{\n\tu32 wow_event_mask;\n\tu32 keep_alive, magic_pattern, host_pm_ctrl;\n\n\twow_event_mask = ah->wow.wow_event_mask;\n\n\t \n\tREG_SET_BIT(ah, AR_PCIE_PM_CTRL(ah), AR_PMCTRL_HOST_PME_EN |\n\t\t    \t\t\t AR_PMCTRL_PWR_PM_CTRL_ENA |\n\t\t    \t\t\t AR_PMCTRL_AUX_PWR_DET |\n\t\t    \t\t\t AR_PMCTRL_WOW_PME_CLR);\n\tREG_CLR_BIT(ah, AR_PCIE_PM_CTRL(ah), AR_PMCTRL_WOW_PME_CLR);\n\n\t \n\tREG_SET_BIT(ah, AR_WOW_PATTERN,\n\t\t    AR_WOW_BACK_OFF_SHIFT(AR_WOW_PAT_BACKOFF));\n\n\t \n\tREG_SET_BIT(ah, AR_WOW_COUNT, AR_WOW_AIFS_CNT(AR_WOW_CNT_AIFS_CNT) |\n\t\t    \t\t      AR_WOW_SLOT_CNT(AR_WOW_CNT_SLOT_CNT) |\n\t\t    \t\t      AR_WOW_KEEP_ALIVE_CNT(AR_WOW_CNT_KA_CNT));\n\t \n\tif (pattern_enable & AH_WOW_BEACON_MISS)\n\t\tREG_WRITE(ah, AR_WOW_BCN_TIMO, AR_WOW_BEACON_TIMO);\n\telse\n\t\tREG_WRITE(ah, AR_WOW_BCN_TIMO, AR_WOW_BEACON_TIMO_MAX);\n\n\t \n\tif (!pattern_enable)\n\t\tREG_WRITE(ah, AR_WOW_KEEP_ALIVE_TIMO, AR_WOW_KEEP_ALIVE_NEVER);\n\telse\n\t\tREG_WRITE(ah, AR_WOW_KEEP_ALIVE_TIMO, KAL_TIMEOUT * 32);\n\n\t \n\tREG_WRITE(ah, AR_WOW_KEEP_ALIVE_DELAY, KAL_DELAY * 1000);\n\n\t \n\tath9k_wow_create_keep_alive_pattern(ah);\n\n\t \n\tkeep_alive = REG_READ(ah, AR_WOW_KEEP_ALIVE);\n\n\t \n\tkeep_alive &= ~AR_WOW_KEEP_ALIVE_AUTO_DIS;\n\n\tif (pattern_enable & AH_WOW_LINK_CHANGE) {\n\t\tkeep_alive &= ~AR_WOW_KEEP_ALIVE_FAIL_DIS;\n\t\twow_event_mask |= AR_WOW_KEEP_ALIVE_FAIL;\n\t} else {\n\t\tkeep_alive |= AR_WOW_KEEP_ALIVE_FAIL_DIS;\n\t}\n\n\tREG_WRITE(ah, AR_WOW_KEEP_ALIVE, keep_alive);\n\n\t \n\tREG_RMW_FIELD(ah, AR_RSSI_THR, AR_RSSI_THR_BM_THR,\n\t\t      AR_WOW_BMISSTHRESHOLD);\n\n\tif (pattern_enable & AH_WOW_BEACON_MISS) {\n\t\twow_event_mask |= AR_WOW_BEACON_FAIL;\n\t\tREG_SET_BIT(ah, AR_WOW_BCN_EN, AR_WOW_BEACON_FAIL_EN);\n\t} else {\n\t\tREG_CLR_BIT(ah, AR_WOW_BCN_EN, AR_WOW_BEACON_FAIL_EN);\n\t}\n\n\t \n\tmagic_pattern = REG_READ(ah, AR_WOW_PATTERN);\n\tmagic_pattern |= AR_WOW_MAC_INTR_EN;\n\n\tif (pattern_enable & AH_WOW_MAGIC_PATTERN_EN) {\n\t\tmagic_pattern |= AR_WOW_MAGIC_EN;\n\t\twow_event_mask |= AR_WOW_MAGIC_PAT_FOUND;\n\t} else {\n\t\tmagic_pattern &= ~AR_WOW_MAGIC_EN;\n\t}\n\n\tREG_WRITE(ah, AR_WOW_PATTERN, magic_pattern);\n\n\t \n\tREG_WRITE(ah, AR_WOW_PATTERN_MATCH_LT_256B,\n\t\t  AR_WOW_PATTERN_SUPPORTED);\n\n\t \n\thost_pm_ctrl = REG_READ(ah, AR_PCIE_PM_CTRL(ah));\n\thost_pm_ctrl |= AR_PMCTRL_PWR_STATE_D1D3 |\n\t\t\tAR_PMCTRL_HOST_PME_EN |\n\t\t\tAR_PMCTRL_PWR_PM_CTRL_ENA;\n\thost_pm_ctrl &= ~AR_PCIE_PM_CTRL_ENA;\n\n\tif (AR_SREV_9462(ah)) {\n\t\t \n\t\thost_pm_ctrl &= ~AR_PMCTRL_PWR_STATE_D1D3;\n\t\thost_pm_ctrl |= AR_PMCTRL_PWR_STATE_D1D3_REAL;\n\t}\n\n\tREG_WRITE(ah, AR_PCIE_PM_CTRL(ah), host_pm_ctrl);\n\n\t \n\tREG_CLR_BIT(ah, AR_STA_ID1, AR_STA_ID1_PRESERVE_SEQNUM);\n\n\t \n\tREG_SET_BIT(ah, AR_PCIE_PHY_REG3, BIT(13));\n\n\tath9k_hw_wow_set_arwr_reg(ah);\n\n\tif (ath9k_hw_mci_is_enabled(ah))\n\t\tREG_WRITE(ah, AR_RTC_KEEP_AWAKE, 0x2);\n\n\t \n\tREG_CLR_BIT(ah, AR_PCU_MISC_MODE3, BIT(5));\n\n\tath9k_hw_set_powermode_wow_sleep(ah);\n\tah->wow.wow_event_mask = wow_event_mask;\n}\nEXPORT_SYMBOL(ath9k_hw_wow_enable);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}