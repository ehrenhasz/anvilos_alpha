{
  "module_name": "ar9003_calib.c",
  "hash_id": "57b20ee3ec3c6d557d50cc2eae48028e9d3d32750af9e0ac21f18ed718969316",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath9k/ar9003_calib.c",
  "human_readable_source": " \n\n#include \"hw.h\"\n#include \"hw-ops.h\"\n#include \"ar9003_phy.h\"\n#include \"ar9003_rtt.h\"\n#include \"ar9003_mci.h\"\n\n#define MAX_MEASUREMENT\tMAX_IQCAL_MEASUREMENT\n#define MAX_MAG_DELTA\t11\n#define MAX_PHS_DELTA\t10\n#define MAXIQCAL        3\n\nstruct coeff {\n\tint mag_coeff[AR9300_MAX_CHAINS][MAX_MEASUREMENT][MAXIQCAL];\n\tint phs_coeff[AR9300_MAX_CHAINS][MAX_MEASUREMENT][MAXIQCAL];\n\tint iqc_coeff[2];\n};\n\nenum ar9003_cal_types {\n\tIQ_MISMATCH_CAL = BIT(0),\n};\n\nstatic void ar9003_hw_setup_calibration(struct ath_hw *ah,\n\t\t\t\t\tstruct ath9k_cal_list *currCal)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\n\t \n\tswitch (currCal->calData->calType) {\n\tcase IQ_MISMATCH_CAL:\n\t\t \n\t\tREG_RMW_FIELD(ah, AR_PHY_TIMING4,\n\t\t\t      AR_PHY_TIMING4_IQCAL_LOG_COUNT_MAX,\n\t\t\t      currCal->calData->calCountMax);\n\t\tREG_WRITE(ah, AR_PHY_CALMODE, AR_PHY_CALMODE_IQ);\n\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"starting IQ Mismatch Calibration\\n\");\n\n\t\t \n\t\tREG_SET_BIT(ah, AR_PHY_TIMING4, AR_PHY_TIMING4_DO_CAL);\n\t\tbreak;\n\tdefault:\n\t\tath_err(common, \"Invalid calibration type\\n\");\n\t\tbreak;\n\t}\n}\n\n \nstatic bool ar9003_hw_per_calibration(struct ath_hw *ah,\n\t\t\t\t      struct ath9k_channel *ichan,\n\t\t\t\t      u8 rxchainmask,\n\t\t\t\t      struct ath9k_cal_list *currCal)\n{\n\tstruct ath9k_hw_cal_data *caldata = ah->caldata;\n\tconst struct ath9k_percal_data *cur_caldata = currCal->calData;\n\n\t \n\tif (currCal->calState == CAL_RUNNING) {\n\t\t \n\t\tif (REG_READ(ah, AR_PHY_TIMING4) & AR_PHY_TIMING4_DO_CAL)\n\t\t\treturn false;\n\n\t\t \n\t\tcur_caldata->calCollect(ah);\n\t\tah->cal_samples++;\n\n\t\tif (ah->cal_samples >= cur_caldata->calNumSamples) {\n\t\t\tunsigned int i, numChains = 0;\n\t\t\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\t\t\tif (rxchainmask & (1 << i))\n\t\t\t\t\tnumChains++;\n\t\t\t}\n\n\t\t\t \n\t\t\tcur_caldata->calPostProc(ah, numChains);\n\n\t\t\t \n\t\t\tcaldata->CalValid |= cur_caldata->calType;\n\t\t\tcurrCal->calState = CAL_DONE;\n\t\t\treturn true;\n\t\t} else {\n\t\t\t \n\t\t\tar9003_hw_setup_calibration(ah, currCal);\n\t\t}\n\t} else if (!(caldata->CalValid & cur_caldata->calType)) {\n\t\t \n\t\tath9k_hw_reset_calibration(ah, currCal);\n\t}\n\n\treturn false;\n}\n\nstatic int ar9003_hw_calibrate(struct ath_hw *ah, struct ath9k_channel *chan,\n\t\t\t       u8 rxchainmask, bool longcal)\n{\n\tbool iscaldone = true;\n\tstruct ath9k_cal_list *currCal = ah->cal_list_curr;\n\tint ret;\n\n\t \n\tif (currCal &&\n\t    (currCal->calState == CAL_RUNNING ||\n\t     currCal->calState == CAL_WAITING)) {\n\t\tiscaldone = ar9003_hw_per_calibration(ah, chan,\n\t\t\t\t\t\t      rxchainmask, currCal);\n\t\tif (iscaldone) {\n\t\t\tah->cal_list_curr = currCal = currCal->calNext;\n\n\t\t\tif (currCal->calState == CAL_WAITING) {\n\t\t\t\tiscaldone = false;\n\t\t\t\tath9k_hw_reset_calibration(ah, currCal);\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tif (longcal && ath9k_hw_getnf(ah, chan)) {\n\t\t \n\t\tret = ath9k_hw_loadnf(ah, ah->curchan);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\t \n\t\tath9k_hw_start_nfcal(ah, false);\n\t}\n\n\treturn iscaldone;\n}\n\nstatic void ar9003_hw_iqcal_collect(struct ath_hw *ah)\n{\n\tint i;\n\n\t \n\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\tif (ah->txchainmask & BIT(i)) {\n\t\t\tah->totalPowerMeasI[i] +=\n\t\t\t\tREG_READ(ah, AR_PHY_CAL_MEAS_0(i));\n\t\t\tah->totalPowerMeasQ[i] +=\n\t\t\t\tREG_READ(ah, AR_PHY_CAL_MEAS_1(i));\n\t\t\tah->totalIqCorrMeas[i] +=\n\t\t\t\t(int32_t) REG_READ(ah, AR_PHY_CAL_MEAS_2(i));\n\t\t\tath_dbg(ath9k_hw_common(ah), CALIBRATE,\n\t\t\t\t\"%d: Chn %d pmi=0x%08x;pmq=0x%08x;iqcm=0x%08x;\\n\",\n\t\t\t\tah->cal_samples, i, ah->totalPowerMeasI[i],\n\t\t\t\tah->totalPowerMeasQ[i],\n\t\t\t\tah->totalIqCorrMeas[i]);\n\t\t}\n\t}\n}\n\nstatic void ar9003_hw_iqcalibrate(struct ath_hw *ah, u8 numChains)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tu32 powerMeasQ, powerMeasI, iqCorrMeas;\n\tu32 qCoffDenom, iCoffDenom;\n\tint32_t qCoff, iCoff;\n\tint iqCorrNeg, i;\n\tstatic const u_int32_t offset_array[3] = {\n\t\tAR_PHY_RX_IQCAL_CORR_B0,\n\t\tAR_PHY_RX_IQCAL_CORR_B1,\n\t\tAR_PHY_RX_IQCAL_CORR_B2,\n\t};\n\n\tfor (i = 0; i < numChains; i++) {\n\t\tpowerMeasI = ah->totalPowerMeasI[i];\n\t\tpowerMeasQ = ah->totalPowerMeasQ[i];\n\t\tiqCorrMeas = ah->totalIqCorrMeas[i];\n\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"Starting IQ Cal and Correction for Chain %d\\n\", i);\n\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"Original: Chn %d iq_corr_meas = 0x%08x\\n\",\n\t\t\ti, ah->totalIqCorrMeas[i]);\n\n\t\tiqCorrNeg = 0;\n\n\t\tif (iqCorrMeas > 0x80000000) {\n\t\t\tiqCorrMeas = (0xffffffff - iqCorrMeas) + 1;\n\t\t\tiqCorrNeg = 1;\n\t\t}\n\n\t\tath_dbg(common, CALIBRATE, \"Chn %d pwr_meas_i = 0x%08x\\n\",\n\t\t\ti, powerMeasI);\n\t\tath_dbg(common, CALIBRATE, \"Chn %d pwr_meas_q = 0x%08x\\n\",\n\t\t\ti, powerMeasQ);\n\t\tath_dbg(common, CALIBRATE, \"iqCorrNeg is 0x%08x\\n\", iqCorrNeg);\n\n\t\tiCoffDenom = (powerMeasI / 2 + powerMeasQ / 2) / 256;\n\t\tqCoffDenom = powerMeasQ / 64;\n\n\t\tif ((iCoffDenom != 0) && (qCoffDenom != 0)) {\n\t\t\tiCoff = iqCorrMeas / iCoffDenom;\n\t\t\tqCoff = powerMeasI / qCoffDenom - 64;\n\t\t\tath_dbg(common, CALIBRATE, \"Chn %d iCoff = 0x%08x\\n\",\n\t\t\t\ti, iCoff);\n\t\t\tath_dbg(common, CALIBRATE, \"Chn %d qCoff = 0x%08x\\n\",\n\t\t\t\ti, qCoff);\n\n\t\t\t \n\t\t\tif (iCoff >= 63)\n\t\t\t\tiCoff = 63;\n\t\t\telse if (iCoff <= -63)\n\t\t\t\tiCoff = -63;\n\n\t\t\t \n\t\t\tif (iqCorrNeg == 0x0)\n\t\t\t\tiCoff = -iCoff;\n\n\t\t\t \n\t\t\tif (qCoff >= 63)\n\t\t\t\tqCoff = 63;\n\t\t\telse if (qCoff <= -63)\n\t\t\t\tqCoff = -63;\n\n\t\t\tiCoff = iCoff & 0x7f;\n\t\t\tqCoff = qCoff & 0x7f;\n\n\t\t\tath_dbg(common, CALIBRATE,\n\t\t\t\t\"Chn %d : iCoff = 0x%x  qCoff = 0x%x\\n\",\n\t\t\t\ti, iCoff, qCoff);\n\t\t\tath_dbg(common, CALIBRATE,\n\t\t\t\t\"Register offset (0x%04x) before update = 0x%x\\n\",\n\t\t\t\toffset_array[i],\n\t\t\t\tREG_READ(ah, offset_array[i]));\n\n\t\t\tif (AR_SREV_9565(ah) &&\n\t\t\t    (iCoff == 63 || qCoff == 63 ||\n\t\t\t     iCoff == -63 || qCoff == -63))\n\t\t\t\treturn;\n\n\t\t\tREG_RMW_FIELD(ah, offset_array[i],\n\t\t\t\t      AR_PHY_RX_IQCAL_CORR_IQCORR_Q_I_COFF,\n\t\t\t\t      iCoff);\n\t\t\tREG_RMW_FIELD(ah, offset_array[i],\n\t\t\t\t      AR_PHY_RX_IQCAL_CORR_IQCORR_Q_Q_COFF,\n\t\t\t\t      qCoff);\n\t\t\tath_dbg(common, CALIBRATE,\n\t\t\t\t\"Register offset (0x%04x) QI COFF (bitfields 0x%08x) after update = 0x%x\\n\",\n\t\t\t\toffset_array[i],\n\t\t\t\tAR_PHY_RX_IQCAL_CORR_IQCORR_Q_I_COFF,\n\t\t\t\tREG_READ(ah, offset_array[i]));\n\t\t\tath_dbg(common, CALIBRATE,\n\t\t\t\t\"Register offset (0x%04x) QQ COFF (bitfields 0x%08x) after update = 0x%x\\n\",\n\t\t\t\toffset_array[i],\n\t\t\t\tAR_PHY_RX_IQCAL_CORR_IQCORR_Q_Q_COFF,\n\t\t\t\tREG_READ(ah, offset_array[i]));\n\n\t\t\tath_dbg(common, CALIBRATE,\n\t\t\t\t\"IQ Cal and Correction done for Chain %d\\n\", i);\n\t\t}\n\t}\n\n\tREG_SET_BIT(ah, AR_PHY_RX_IQCAL_CORR_B0,\n\t\t    AR_PHY_RX_IQCAL_CORR_IQCORR_ENABLE);\n\tath_dbg(common, CALIBRATE,\n\t\t\"IQ Cal and Correction (offset 0x%04x) enabled (bit position 0x%08x). New Value 0x%08x\\n\",\n\t\t(unsigned) (AR_PHY_RX_IQCAL_CORR_B0),\n\t\tAR_PHY_RX_IQCAL_CORR_IQCORR_ENABLE,\n\t\tREG_READ(ah, AR_PHY_RX_IQCAL_CORR_B0));\n}\n\nstatic const struct ath9k_percal_data iq_cal_single_sample = {\n\tIQ_MISMATCH_CAL,\n\tMIN_CAL_SAMPLES,\n\tPER_MAX_LOG_COUNT,\n\tar9003_hw_iqcal_collect,\n\tar9003_hw_iqcalibrate\n};\n\nstatic void ar9003_hw_init_cal_settings(struct ath_hw *ah)\n{\n\tah->iq_caldata.calData = &iq_cal_single_sample;\n\n\tif (AR_SREV_9300_20_OR_LATER(ah)) {\n\t\tah->enabled_cals |= TX_IQ_CAL;\n\t\tif (AR_SREV_9485_OR_LATER(ah) && !AR_SREV_9340(ah))\n\t\t\tah->enabled_cals |= TX_IQ_ON_AGC_CAL;\n\t}\n\n\tah->supp_cals = IQ_MISMATCH_CAL;\n}\n\n#define OFF_UPPER_LT 24\n#define OFF_LOWER_LT 7\n\nstatic bool ar9003_hw_dynamic_osdac_selection(struct ath_hw *ah,\n\t\t\t\t\t      bool txiqcal_done)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tint ch0_done, osdac_ch0, dc_off_ch0_i1, dc_off_ch0_q1, dc_off_ch0_i2,\n\t\tdc_off_ch0_q2, dc_off_ch0_i3, dc_off_ch0_q3;\n\tint ch1_done, osdac_ch1, dc_off_ch1_i1, dc_off_ch1_q1, dc_off_ch1_i2,\n\t\tdc_off_ch1_q2, dc_off_ch1_i3, dc_off_ch1_q3;\n\tint ch2_done, osdac_ch2, dc_off_ch2_i1, dc_off_ch2_q1, dc_off_ch2_i2,\n\t\tdc_off_ch2_q2, dc_off_ch2_i3, dc_off_ch2_q3;\n\tbool status;\n\tu32 temp, val;\n\n\t \n\tREG_CLR_BIT(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t    AR_PHY_AGC_CONTROL_OFFSET_CAL);\n\tREG_CLR_BIT(ah, AR_PHY_TX_IQCAL_CONTROL_0(ah),\n\t\t    AR_PHY_TX_IQCAL_CONTROL_0_ENABLE_TXIQ_CAL);\n\tREG_WRITE(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t  REG_READ(ah, AR_PHY_AGC_CONTROL(ah)) | AR_PHY_AGC_CONTROL_CAL);\n\n\tstatus = ath9k_hw_wait(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t\t       AR_PHY_AGC_CONTROL_CAL,\n\t\t\t       0, AH_WAIT_TIMEOUT);\n\tif (!status) {\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"AGC cal without offset cal failed to complete in 1ms\");\n\t\treturn false;\n\t}\n\n\t \n\tREG_SET_BIT(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t    AR_PHY_AGC_CONTROL_OFFSET_CAL);\n\tREG_CLR_BIT(ah, AR_PHY_CL_CAL_CTL,\n\t\t    AR_PHY_CL_CAL_ENABLE);\n\tREG_CLR_BIT(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t    AR_PHY_AGC_CONTROL_FLTR_CAL);\n\tREG_CLR_BIT(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t    AR_PHY_AGC_CONTROL_PKDET_CAL);\n\n\tch0_done = 0;\n\tch1_done = 0;\n\tch2_done = 0;\n\n\twhile ((ch0_done == 0) || (ch1_done == 0) || (ch2_done == 0)) {\n\t\tosdac_ch0 = (REG_READ(ah, AR_PHY_65NM_CH0_BB1) >> 30) & 0x3;\n\t\tosdac_ch1 = (REG_READ(ah, AR_PHY_65NM_CH1_BB1) >> 30) & 0x3;\n\t\tosdac_ch2 = (REG_READ(ah, AR_PHY_65NM_CH2_BB1) >> 30) & 0x3;\n\n\t\tREG_SET_BIT(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_EN);\n\n\t\tREG_WRITE(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t\t  REG_READ(ah, AR_PHY_AGC_CONTROL(ah)) | AR_PHY_AGC_CONTROL_CAL);\n\n\t\tstatus = ath9k_hw_wait(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t\t\t       AR_PHY_AGC_CONTROL_CAL,\n\t\t\t\t       0, AH_WAIT_TIMEOUT);\n\t\tif (!status) {\n\t\t\tath_dbg(common, CALIBRATE,\n\t\t\t\t\"DC offset cal failed to complete in 1ms\");\n\t\t\treturn false;\n\t\t}\n\n\t\tREG_CLR_BIT(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_EN);\n\n\t\t \n\t\tREG_WRITE(ah, AR_PHY_65NM_CH0_BB3,\n\t\t\t  ((REG_READ(ah, AR_PHY_65NM_CH0_BB3) & 0xfffffcff) | (1 << 8)));\n\t\tREG_WRITE(ah, AR_PHY_65NM_CH1_BB3,\n\t\t\t  ((REG_READ(ah, AR_PHY_65NM_CH1_BB3) & 0xfffffcff) | (1 << 8)));\n\t\tREG_WRITE(ah, AR_PHY_65NM_CH2_BB3,\n\t\t\t  ((REG_READ(ah, AR_PHY_65NM_CH2_BB3) & 0xfffffcff) | (1 << 8)));\n\n\t\ttemp = REG_READ(ah, AR_PHY_65NM_CH0_BB3);\n\t\tdc_off_ch0_i1 = (temp >> 26) & 0x1f;\n\t\tdc_off_ch0_q1 = (temp >> 21) & 0x1f;\n\n\t\ttemp = REG_READ(ah, AR_PHY_65NM_CH1_BB3);\n\t\tdc_off_ch1_i1 = (temp >> 26) & 0x1f;\n\t\tdc_off_ch1_q1 = (temp >> 21) & 0x1f;\n\n\t\ttemp = REG_READ(ah, AR_PHY_65NM_CH2_BB3);\n\t\tdc_off_ch2_i1 = (temp >> 26) & 0x1f;\n\t\tdc_off_ch2_q1 = (temp >> 21) & 0x1f;\n\n\t\t \n\t\tREG_WRITE(ah, AR_PHY_65NM_CH0_BB3,\n\t\t\t  ((REG_READ(ah, AR_PHY_65NM_CH0_BB3) & 0xfffffcff) | (2 << 8)));\n\t\tREG_WRITE(ah, AR_PHY_65NM_CH1_BB3,\n\t\t\t  ((REG_READ(ah, AR_PHY_65NM_CH1_BB3) & 0xfffffcff) | (2 << 8)));\n\t\tREG_WRITE(ah, AR_PHY_65NM_CH2_BB3,\n\t\t\t  ((REG_READ(ah, AR_PHY_65NM_CH2_BB3) & 0xfffffcff) | (2 << 8)));\n\n\t\ttemp = REG_READ(ah, AR_PHY_65NM_CH0_BB3);\n\t\tdc_off_ch0_i2 = (temp >> 26) & 0x1f;\n\t\tdc_off_ch0_q2 = (temp >> 21) & 0x1f;\n\n\t\ttemp = REG_READ(ah, AR_PHY_65NM_CH1_BB3);\n\t\tdc_off_ch1_i2 = (temp >> 26) & 0x1f;\n\t\tdc_off_ch1_q2 = (temp >> 21) & 0x1f;\n\n\t\ttemp = REG_READ(ah, AR_PHY_65NM_CH2_BB3);\n\t\tdc_off_ch2_i2 = (temp >> 26) & 0x1f;\n\t\tdc_off_ch2_q2 = (temp >> 21) & 0x1f;\n\n\t\t \n\t\tREG_WRITE(ah, AR_PHY_65NM_CH0_BB3,\n\t\t\t  ((REG_READ(ah, AR_PHY_65NM_CH0_BB3) & 0xfffffcff) | (3 << 8)));\n\t\tREG_WRITE(ah, AR_PHY_65NM_CH1_BB3,\n\t\t\t  ((REG_READ(ah, AR_PHY_65NM_CH1_BB3) & 0xfffffcff) | (3 << 8)));\n\t\tREG_WRITE(ah, AR_PHY_65NM_CH2_BB3,\n\t\t\t  ((REG_READ(ah, AR_PHY_65NM_CH2_BB3) & 0xfffffcff) | (3 << 8)));\n\n\t\ttemp = REG_READ(ah, AR_PHY_65NM_CH0_BB3);\n\t\tdc_off_ch0_i3 = (temp >> 26) & 0x1f;\n\t\tdc_off_ch0_q3 = (temp >> 21) & 0x1f;\n\n\t\ttemp = REG_READ(ah, AR_PHY_65NM_CH1_BB3);\n\t\tdc_off_ch1_i3 = (temp >> 26) & 0x1f;\n\t\tdc_off_ch1_q3 = (temp >> 21) & 0x1f;\n\n\t\ttemp = REG_READ(ah, AR_PHY_65NM_CH2_BB3);\n\t\tdc_off_ch2_i3 = (temp >> 26) & 0x1f;\n\t\tdc_off_ch2_q3 = (temp >> 21) & 0x1f;\n\n\t\tif ((dc_off_ch0_i1 > OFF_UPPER_LT) || (dc_off_ch0_i1 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch0_i2 > OFF_UPPER_LT) || (dc_off_ch0_i2 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch0_i3 > OFF_UPPER_LT) || (dc_off_ch0_i3 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch0_q1 > OFF_UPPER_LT) || (dc_off_ch0_q1 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch0_q2 > OFF_UPPER_LT) || (dc_off_ch0_q2 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch0_q3 > OFF_UPPER_LT) || (dc_off_ch0_q3 < OFF_LOWER_LT)) {\n\t\t\tif (osdac_ch0 == 3) {\n\t\t\t\tch0_done = 1;\n\t\t\t} else {\n\t\t\t\tosdac_ch0++;\n\n\t\t\t\tval = REG_READ(ah, AR_PHY_65NM_CH0_BB1) & 0x3fffffff;\n\t\t\t\tval |= (osdac_ch0 << 30);\n\t\t\t\tREG_WRITE(ah, AR_PHY_65NM_CH0_BB1, val);\n\n\t\t\t\tch0_done = 0;\n\t\t\t}\n\t\t} else {\n\t\t\tch0_done = 1;\n\t\t}\n\n\t\tif ((dc_off_ch1_i1 > OFF_UPPER_LT) || (dc_off_ch1_i1 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch1_i2 > OFF_UPPER_LT) || (dc_off_ch1_i2 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch1_i3 > OFF_UPPER_LT) || (dc_off_ch1_i3 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch1_q1 > OFF_UPPER_LT) || (dc_off_ch1_q1 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch1_q2 > OFF_UPPER_LT) || (dc_off_ch1_q2 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch1_q3 > OFF_UPPER_LT) || (dc_off_ch1_q3 < OFF_LOWER_LT)) {\n\t\t\tif (osdac_ch1 == 3) {\n\t\t\t\tch1_done = 1;\n\t\t\t} else {\n\t\t\t\tosdac_ch1++;\n\n\t\t\t\tval = REG_READ(ah, AR_PHY_65NM_CH1_BB1) & 0x3fffffff;\n\t\t\t\tval |= (osdac_ch1 << 30);\n\t\t\t\tREG_WRITE(ah, AR_PHY_65NM_CH1_BB1, val);\n\n\t\t\t\tch1_done = 0;\n\t\t\t}\n\t\t} else {\n\t\t\tch1_done = 1;\n\t\t}\n\n\t\tif ((dc_off_ch2_i1 > OFF_UPPER_LT) || (dc_off_ch2_i1 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch2_i2 > OFF_UPPER_LT) || (dc_off_ch2_i2 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch2_i3 > OFF_UPPER_LT) || (dc_off_ch2_i3 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch2_q1 > OFF_UPPER_LT) || (dc_off_ch2_q1 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch2_q2 > OFF_UPPER_LT) || (dc_off_ch2_q2 < OFF_LOWER_LT) ||\n\t\t    (dc_off_ch2_q3 > OFF_UPPER_LT) || (dc_off_ch2_q3 < OFF_LOWER_LT)) {\n\t\t\tif (osdac_ch2 == 3) {\n\t\t\t\tch2_done = 1;\n\t\t\t} else {\n\t\t\t\tosdac_ch2++;\n\n\t\t\t\tval = REG_READ(ah, AR_PHY_65NM_CH2_BB1) & 0x3fffffff;\n\t\t\t\tval |= (osdac_ch2 << 30);\n\t\t\t\tREG_WRITE(ah, AR_PHY_65NM_CH2_BB1, val);\n\n\t\t\t\tch2_done = 0;\n\t\t\t}\n\t\t} else {\n\t\t\tch2_done = 1;\n\t\t}\n\t}\n\n\tREG_CLR_BIT(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t    AR_PHY_AGC_CONTROL_OFFSET_CAL);\n\tREG_SET_BIT(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_EN);\n\n\t \n\tREG_SET_BIT(ah, AR_PHY_TX_IQCAL_CONTROL_0(ah),\n\t\t    AR_PHY_TX_IQCAL_CONTROL_0_ENABLE_TXIQ_CAL);\n\n\treturn true;\n}\n\n \nstatic bool ar9003_hw_solve_iq_cal(struct ath_hw *ah,\n\t\t\t\t   s32 sin_2phi_1,\n\t\t\t\t   s32 cos_2phi_1,\n\t\t\t\t   s32 sin_2phi_2,\n\t\t\t\t   s32 cos_2phi_2,\n\t\t\t\t   s32 mag_a0_d0,\n\t\t\t\t   s32 phs_a0_d0,\n\t\t\t\t   s32 mag_a1_d0,\n\t\t\t\t   s32 phs_a1_d0,\n\t\t\t\t   s32 solved_eq[])\n{\n\ts32 f1 = cos_2phi_1 - cos_2phi_2,\n\t    f3 = sin_2phi_1 - sin_2phi_2,\n\t    f2;\n\ts32 mag_tx, phs_tx, mag_rx, phs_rx;\n\tconst s32 result_shift = 1 << 15;\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\n\tf2 = ((f1 >> 3) * (f1 >> 3) + (f3 >> 3) * (f3 >> 3)) >> 9;\n\n\tif (!f2) {\n\t\tath_dbg(common, CALIBRATE, \"Divide by 0\\n\");\n\t\treturn false;\n\t}\n\n\t \n\tmag_tx = f1 * (mag_a0_d0  - mag_a1_d0) + f3 * (phs_a0_d0 - phs_a1_d0);\n\t \n\tphs_tx = f3 * (-mag_a0_d0 + mag_a1_d0) + f1 * (phs_a0_d0 - phs_a1_d0);\n\n\tmag_tx = (mag_tx / f2);\n\tphs_tx = (phs_tx / f2);\n\n\t \n\tmag_rx = mag_a0_d0 - (cos_2phi_1 * mag_tx + sin_2phi_1 * phs_tx) /\n\t\t result_shift;\n\t \n\tphs_rx = phs_a0_d0 + (sin_2phi_1 * mag_tx - cos_2phi_1 * phs_tx) /\n\t\t result_shift;\n\n\tsolved_eq[0] = mag_tx;\n\tsolved_eq[1] = phs_tx;\n\tsolved_eq[2] = mag_rx;\n\tsolved_eq[3] = phs_rx;\n\n\treturn true;\n}\n\nstatic s32 ar9003_hw_find_mag_approx(struct ath_hw *ah, s32 in_re, s32 in_im)\n{\n\ts32 abs_i = abs(in_re),\n\t    abs_q = abs(in_im),\n\t    max_abs, min_abs;\n\n\tif (abs_i > abs_q) {\n\t\tmax_abs = abs_i;\n\t\tmin_abs = abs_q;\n\t} else {\n\t\tmax_abs = abs_q;\n\t\tmin_abs = abs_i;\n\t}\n\n\treturn max_abs - (max_abs / 32) + (min_abs / 8) + (min_abs / 4);\n}\n\n#define DELPT 32\n\nstatic bool ar9003_hw_calc_iq_corr(struct ath_hw *ah,\n\t\t\t\t   s32 chain_idx,\n\t\t\t\t   const s32 iq_res[],\n\t\t\t\t   s32 iqc_coeff[])\n{\n\ts32 i2_m_q2_a0_d0, i2_p_q2_a0_d0, iq_corr_a0_d0,\n\t    i2_m_q2_a0_d1, i2_p_q2_a0_d1, iq_corr_a0_d1,\n\t    i2_m_q2_a1_d0, i2_p_q2_a1_d0, iq_corr_a1_d0,\n\t    i2_m_q2_a1_d1, i2_p_q2_a1_d1, iq_corr_a1_d1;\n\ts32 mag_a0_d0, mag_a1_d0, mag_a0_d1, mag_a1_d1,\n\t    phs_a0_d0, phs_a1_d0, phs_a0_d1, phs_a1_d1,\n\t    sin_2phi_1, cos_2phi_1,\n\t    sin_2phi_2, cos_2phi_2;\n\ts32 mag_tx, phs_tx, mag_rx, phs_rx;\n\ts32 solved_eq[4], mag_corr_tx, phs_corr_tx, mag_corr_rx, phs_corr_rx,\n\t    q_q_coff, q_i_coff;\n\tconst s32 res_scale = 1 << 15;\n\tconst s32 delpt_shift = 1 << 8;\n\ts32 mag1, mag2;\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\n\ti2_m_q2_a0_d0 = iq_res[0] & 0xfff;\n\ti2_p_q2_a0_d0 = (iq_res[0] >> 12) & 0xfff;\n\tiq_corr_a0_d0 = ((iq_res[0] >> 24) & 0xff) + ((iq_res[1] & 0xf) << 8);\n\n\tif (i2_m_q2_a0_d0 > 0x800)\n\t\ti2_m_q2_a0_d0 = -((0xfff - i2_m_q2_a0_d0) + 1);\n\n\tif (i2_p_q2_a0_d0 > 0x800)\n\t\ti2_p_q2_a0_d0 = -((0xfff - i2_p_q2_a0_d0) + 1);\n\n\tif (iq_corr_a0_d0 > 0x800)\n\t\tiq_corr_a0_d0 = -((0xfff - iq_corr_a0_d0) + 1);\n\n\ti2_m_q2_a0_d1 = (iq_res[1] >> 4) & 0xfff;\n\ti2_p_q2_a0_d1 = (iq_res[2] & 0xfff);\n\tiq_corr_a0_d1 = (iq_res[2] >> 12) & 0xfff;\n\n\tif (i2_m_q2_a0_d1 > 0x800)\n\t\ti2_m_q2_a0_d1 = -((0xfff - i2_m_q2_a0_d1) + 1);\n\n\tif (iq_corr_a0_d1 > 0x800)\n\t\tiq_corr_a0_d1 = -((0xfff - iq_corr_a0_d1) + 1);\n\n\ti2_m_q2_a1_d0 = ((iq_res[2] >> 24) & 0xff) + ((iq_res[3] & 0xf) << 8);\n\ti2_p_q2_a1_d0 = (iq_res[3] >> 4) & 0xfff;\n\tiq_corr_a1_d0 = iq_res[4] & 0xfff;\n\n\tif (i2_m_q2_a1_d0 > 0x800)\n\t\ti2_m_q2_a1_d0 = -((0xfff - i2_m_q2_a1_d0) + 1);\n\n\tif (i2_p_q2_a1_d0 > 0x800)\n\t\ti2_p_q2_a1_d0 = -((0xfff - i2_p_q2_a1_d0) + 1);\n\n\tif (iq_corr_a1_d0 > 0x800)\n\t\tiq_corr_a1_d0 = -((0xfff - iq_corr_a1_d0) + 1);\n\n\ti2_m_q2_a1_d1 = (iq_res[4] >> 12) & 0xfff;\n\ti2_p_q2_a1_d1 = ((iq_res[4] >> 24) & 0xff) + ((iq_res[5] & 0xf) << 8);\n\tiq_corr_a1_d1 = (iq_res[5] >> 4) & 0xfff;\n\n\tif (i2_m_q2_a1_d1 > 0x800)\n\t\ti2_m_q2_a1_d1 = -((0xfff - i2_m_q2_a1_d1) + 1);\n\n\tif (i2_p_q2_a1_d1 > 0x800)\n\t\ti2_p_q2_a1_d1 = -((0xfff - i2_p_q2_a1_d1) + 1);\n\n\tif (iq_corr_a1_d1 > 0x800)\n\t\tiq_corr_a1_d1 = -((0xfff - iq_corr_a1_d1) + 1);\n\n\tif ((i2_p_q2_a0_d0 == 0) || (i2_p_q2_a0_d1 == 0) ||\n\t    (i2_p_q2_a1_d0 == 0) || (i2_p_q2_a1_d1 == 0)) {\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"Divide by 0:\\n\"\n\t\t\t\"a0_d0=%d\\n\"\n\t\t\t\"a0_d1=%d\\n\"\n\t\t\t\"a2_d0=%d\\n\"\n\t\t\t\"a1_d1=%d\\n\",\n\t\t\ti2_p_q2_a0_d0, i2_p_q2_a0_d1,\n\t\t\ti2_p_q2_a1_d0, i2_p_q2_a1_d1);\n\t\treturn false;\n\t}\n\n\tif ((i2_p_q2_a0_d0 < 1024) || (i2_p_q2_a0_d0 > 2047) ||\n            (i2_p_q2_a1_d0 < 0) || (i2_p_q2_a1_d1 < 0) ||\n            (i2_p_q2_a0_d0 <= i2_m_q2_a0_d0) ||\n            (i2_p_q2_a0_d0 <= iq_corr_a0_d0) ||\n            (i2_p_q2_a0_d1 <= i2_m_q2_a0_d1) ||\n            (i2_p_q2_a0_d1 <= iq_corr_a0_d1) ||\n            (i2_p_q2_a1_d0 <= i2_m_q2_a1_d0) ||\n            (i2_p_q2_a1_d0 <= iq_corr_a1_d0) ||\n            (i2_p_q2_a1_d1 <= i2_m_q2_a1_d1) ||\n            (i2_p_q2_a1_d1 <= iq_corr_a1_d1)) {\n\t\treturn false;\n\t}\n\n\tmag_a0_d0 = (i2_m_q2_a0_d0 * res_scale) / i2_p_q2_a0_d0;\n\tphs_a0_d0 = (iq_corr_a0_d0 * res_scale) / i2_p_q2_a0_d0;\n\n\tmag_a0_d1 = (i2_m_q2_a0_d1 * res_scale) / i2_p_q2_a0_d1;\n\tphs_a0_d1 = (iq_corr_a0_d1 * res_scale) / i2_p_q2_a0_d1;\n\n\tmag_a1_d0 = (i2_m_q2_a1_d0 * res_scale) / i2_p_q2_a1_d0;\n\tphs_a1_d0 = (iq_corr_a1_d0 * res_scale) / i2_p_q2_a1_d0;\n\n\tmag_a1_d1 = (i2_m_q2_a1_d1 * res_scale) / i2_p_q2_a1_d1;\n\tphs_a1_d1 = (iq_corr_a1_d1 * res_scale) / i2_p_q2_a1_d1;\n\n\t \n\tsin_2phi_1 = (((mag_a0_d0 - mag_a0_d1) * delpt_shift) / DELPT);\n\t \n\tcos_2phi_1 = (((phs_a0_d1 - phs_a0_d0) * delpt_shift) / DELPT);\n\t \n\tsin_2phi_2 = (((mag_a1_d0 - mag_a1_d1) * delpt_shift) / DELPT);\n\t \n\tcos_2phi_2 = (((phs_a1_d1 - phs_a1_d0) * delpt_shift) / DELPT);\n\n\t \n\tmag1 = ar9003_hw_find_mag_approx(ah, cos_2phi_1, sin_2phi_1);\n\tmag2 = ar9003_hw_find_mag_approx(ah, cos_2phi_2, sin_2phi_2);\n\n\tif ((mag1 == 0) || (mag2 == 0)) {\n\t\tath_dbg(common, CALIBRATE, \"Divide by 0: mag1=%d, mag2=%d\\n\",\n\t\t\tmag1, mag2);\n\t\treturn false;\n\t}\n\n\t \n\tsin_2phi_1 = (sin_2phi_1 * res_scale / mag1);\n\tcos_2phi_1 = (cos_2phi_1 * res_scale / mag1);\n\tsin_2phi_2 = (sin_2phi_2 * res_scale / mag2);\n\tcos_2phi_2 = (cos_2phi_2 * res_scale / mag2);\n\n\t \n\tif (!ar9003_hw_solve_iq_cal(ah,\n\t\t\t     sin_2phi_1, cos_2phi_1,\n\t\t\t     sin_2phi_2, cos_2phi_2,\n\t\t\t     mag_a0_d0, phs_a0_d0,\n\t\t\t     mag_a1_d0,\n\t\t\t     phs_a1_d0, solved_eq)) {\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"Call to ar9003_hw_solve_iq_cal() failed\\n\");\n\t\treturn false;\n\t}\n\n\tmag_tx = solved_eq[0];\n\tphs_tx = solved_eq[1];\n\tmag_rx = solved_eq[2];\n\tphs_rx = solved_eq[3];\n\n\tath_dbg(common, CALIBRATE,\n\t\t\"chain %d: mag mismatch=%d phase mismatch=%d\\n\",\n\t\tchain_idx, mag_tx/res_scale, phs_tx/res_scale);\n\n\tif (res_scale == mag_tx) {\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"Divide by 0: mag_tx=%d, res_scale=%d\\n\",\n\t\t\tmag_tx, res_scale);\n\t\treturn false;\n\t}\n\n\t \n\tmag_corr_tx = (mag_tx * res_scale) / (res_scale - mag_tx);\n\tphs_corr_tx = -phs_tx;\n\n\tq_q_coff = (mag_corr_tx * 128 / res_scale);\n\tq_i_coff = (phs_corr_tx * 256 / res_scale);\n\n\tath_dbg(common, CALIBRATE, \"tx chain %d: mag corr=%d  phase corr=%d\\n\",\n\t\tchain_idx, q_q_coff, q_i_coff);\n\n\tif (q_i_coff < -63)\n\t\tq_i_coff = -63;\n\tif (q_i_coff > 63)\n\t\tq_i_coff = 63;\n\tif (q_q_coff < -63)\n\t\tq_q_coff = -63;\n\tif (q_q_coff > 63)\n\t\tq_q_coff = 63;\n\n\tiqc_coeff[0] = (q_q_coff * 128) + (0x7f & q_i_coff);\n\n\tath_dbg(common, CALIBRATE, \"tx chain %d: iq corr coeff=%x\\n\",\n\t\tchain_idx, iqc_coeff[0]);\n\n\tif (-mag_rx == res_scale) {\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"Divide by 0: mag_rx=%d, res_scale=%d\\n\",\n\t\t\tmag_rx, res_scale);\n\t\treturn false;\n\t}\n\n\t \n\tmag_corr_rx = (-mag_rx * res_scale) / (res_scale + mag_rx);\n\tphs_corr_rx = -phs_rx;\n\n\tq_q_coff = (mag_corr_rx * 128 / res_scale);\n\tq_i_coff = (phs_corr_rx * 256 / res_scale);\n\n\tath_dbg(common, CALIBRATE, \"rx chain %d: mag corr=%d  phase corr=%d\\n\",\n\t\tchain_idx, q_q_coff, q_i_coff);\n\n\tif (q_i_coff < -63)\n\t\tq_i_coff = -63;\n\tif (q_i_coff > 63)\n\t\tq_i_coff = 63;\n\tif (q_q_coff < -63)\n\t\tq_q_coff = -63;\n\tif (q_q_coff > 63)\n\t\tq_q_coff = 63;\n\n\tiqc_coeff[1] = (q_q_coff * 128) + (0x7f & q_i_coff);\n\n\tath_dbg(common, CALIBRATE, \"rx chain %d: iq corr coeff=%x\\n\",\n\t\tchain_idx, iqc_coeff[1]);\n\n\treturn true;\n}\n\nstatic void ar9003_hw_detect_outlier(int mp_coeff[][MAXIQCAL],\n\t\t\t\t     int nmeasurement,\n\t\t\t\t     int max_delta)\n{\n\tint mp_max = -64, max_idx = 0;\n\tint mp_min = 63, min_idx = 0;\n\tint mp_avg = 0, i, outlier_idx = 0, mp_count = 0;\n\n\t \n\tfor (i = 0; i < nmeasurement; i++) {\n\t\tif (mp_coeff[i][0] > mp_max) {\n\t\t\tmp_max = mp_coeff[i][0];\n\t\t\tmax_idx = i;\n\t\t} else if (mp_coeff[i][0] < mp_min) {\n\t\t\tmp_min = mp_coeff[i][0];\n\t\t\tmin_idx = i;\n\t\t}\n\t}\n\n\t \n\tfor (i = 0; i < nmeasurement; i++) {\n\t\tif ((abs(mp_coeff[i][0]) < abs(mp_max)) ||\n\t\t    (abs(mp_coeff[i][0]) < abs(mp_min))) {\n\t\t\tmp_avg += mp_coeff[i][0];\n\t\t\tmp_count++;\n\t\t}\n\t}\n\n\t \n\tif (mp_count)\n\t\tmp_avg /= mp_count;\n\telse\n\t\tmp_avg = mp_coeff[nmeasurement - 1][0];\n\n\t \n\tif (abs(mp_max - mp_min) > max_delta) {\n\t\tif (abs(mp_max - mp_avg) > abs(mp_min - mp_avg))\n\t\t\toutlier_idx = max_idx;\n\t\telse\n\t\t\toutlier_idx = min_idx;\n\n\t\tmp_coeff[outlier_idx][0] = mp_avg;\n\t}\n}\n\nstatic void ar9003_hw_tx_iq_cal_outlier_detection(struct ath_hw *ah,\n\t\t\t\t\t\t  struct coeff *coeff,\n\t\t\t\t\t\t  bool is_reusable)\n{\n\tint i, im, nmeasurement;\n\tint magnitude, phase;\n\tu32 tx_corr_coeff[MAX_MEASUREMENT][AR9300_MAX_CHAINS];\n\tstruct ath9k_hw_cal_data *caldata = ah->caldata;\n\n\tmemset(tx_corr_coeff, 0, sizeof(tx_corr_coeff));\n\tfor (i = 0; i < MAX_MEASUREMENT / 2; i++) {\n\t\ttx_corr_coeff[i * 2][0] = tx_corr_coeff[(i * 2) + 1][0] =\n\t\t\t\t\tAR_PHY_TX_IQCAL_CORR_COEFF_B0(ah, i);\n\t\tif (!AR_SREV_9485(ah)) {\n\t\t\ttx_corr_coeff[i * 2][1] =\n\t\t\ttx_corr_coeff[(i * 2) + 1][1] =\n\t\t\t\t\tAR_PHY_TX_IQCAL_CORR_COEFF_B1(i);\n\n\t\t\ttx_corr_coeff[i * 2][2] =\n\t\t\ttx_corr_coeff[(i * 2) + 1][2] =\n\t\t\t\t\tAR_PHY_TX_IQCAL_CORR_COEFF_B2(i);\n\t\t}\n\t}\n\n\t \n\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\tif (!(ah->txchainmask & (1 << i)))\n\t\t\tcontinue;\n\t\tnmeasurement = REG_READ_FIELD(ah,\n\t\t\t\tAR_PHY_TX_IQCAL_STATUS_B0(ah),\n\t\t\t\tAR_PHY_CALIBRATED_GAINS_0);\n\n\t\tif (nmeasurement > MAX_MEASUREMENT)\n\t\t\tnmeasurement = MAX_MEASUREMENT;\n\n\t\t \n\t\tif (!AR_SREV_9550(ah)) {\n\t\t\t \n\t\t\tif (nmeasurement > 1) {\n\t\t\t\t \n\t\t\t\tar9003_hw_detect_outlier(coeff->mag_coeff[i],\n\t\t\t\t\t\t\t nmeasurement,\n\t\t\t\t\t\t\t MAX_MAG_DELTA);\n\n\t\t\t\t \n\t\t\t\tar9003_hw_detect_outlier(coeff->phs_coeff[i],\n\t\t\t\t\t\t\t nmeasurement,\n\t\t\t\t\t\t\t MAX_PHS_DELTA);\n\t\t\t}\n\t\t}\n\n\t\tfor (im = 0; im < nmeasurement; im++) {\n\t\t\tmagnitude = coeff->mag_coeff[i][im][0];\n\t\t\tphase = coeff->phs_coeff[i][im][0];\n\n\t\t\tcoeff->iqc_coeff[0] =\n\t\t\t\t(phase & 0x7f) | ((magnitude & 0x7f) << 7);\n\n\t\t\tif ((im % 2) == 0)\n\t\t\t\tREG_RMW_FIELD(ah, tx_corr_coeff[im][i],\n\t\t\t\t\tAR_PHY_TX_IQCAL_CORR_COEFF_00_COEFF_TABLE,\n\t\t\t\t\tcoeff->iqc_coeff[0]);\n\t\t\telse\n\t\t\t\tREG_RMW_FIELD(ah, tx_corr_coeff[im][i],\n\t\t\t\t\tAR_PHY_TX_IQCAL_CORR_COEFF_01_COEFF_TABLE,\n\t\t\t\t\tcoeff->iqc_coeff[0]);\n\n\t\t\tif (caldata)\n\t\t\t\tcaldata->tx_corr_coeff[im][i] =\n\t\t\t\t\tcoeff->iqc_coeff[0];\n\t\t}\n\t\tif (caldata)\n\t\t\tcaldata->num_measures[i] = nmeasurement;\n\t}\n\n\tREG_RMW_FIELD(ah, AR_PHY_TX_IQCAL_CONTROL_3,\n\t\t      AR_PHY_TX_IQCAL_CONTROL_3_IQCORR_EN, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_RX_IQCAL_CORR_B0,\n\t\t      AR_PHY_RX_IQCAL_CORR_B0_LOOPBACK_IQCORR_EN, 0x1);\n\n\tif (caldata) {\n\t\tif (is_reusable)\n\t\t\tset_bit(TXIQCAL_DONE, &caldata->cal_flags);\n\t\telse\n\t\t\tclear_bit(TXIQCAL_DONE, &caldata->cal_flags);\n\t}\n\n\treturn;\n}\n\nstatic bool ar9003_hw_tx_iq_cal_run(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tu8 tx_gain_forced;\n\n\ttx_gain_forced = REG_READ_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t\t\t\tAR_PHY_TXGAIN_FORCE);\n\tif (tx_gain_forced)\n\t\tREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\n\t\t\t      AR_PHY_TXGAIN_FORCE, 0);\n\n\tREG_RMW_FIELD(ah, AR_PHY_TX_IQCAL_START(ah),\n\t\t      AR_PHY_TX_IQCAL_START_DO_CAL, 1);\n\n\tif (!ath9k_hw_wait(ah, AR_PHY_TX_IQCAL_START(ah),\n\t\t\tAR_PHY_TX_IQCAL_START_DO_CAL, 0,\n\t\t\tAH_WAIT_TIMEOUT)) {\n\t\tath_dbg(common, CALIBRATE, \"Tx IQ Cal is not completed\\n\");\n\t\treturn false;\n\t}\n\treturn true;\n}\n\nstatic void __ar955x_tx_iq_cal_sort(struct ath_hw *ah,\n\t\t\t\t    struct coeff *coeff,\n\t\t\t\t    int i, int nmeasurement)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tint im, ix, iy;\n\n\tfor (im = 0; im < nmeasurement; im++) {\n\t\tfor (ix = 0; ix < MAXIQCAL - 1; ix++) {\n\t\t\tfor (iy = ix + 1; iy <= MAXIQCAL - 1; iy++) {\n\t\t\t\tif (coeff->mag_coeff[i][im][iy] <\n\t\t\t\t    coeff->mag_coeff[i][im][ix]) {\n\t\t\t\t\tswap(coeff->mag_coeff[i][im][ix],\n\t\t\t\t\t     coeff->mag_coeff[i][im][iy]);\n\t\t\t\t}\n\t\t\t\tif (coeff->phs_coeff[i][im][iy] <\n\t\t\t\t    coeff->phs_coeff[i][im][ix]) {\n\t\t\t\t\tswap(coeff->phs_coeff[i][im][ix],\n\t\t\t\t\t     coeff->phs_coeff[i][im][iy]);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tcoeff->mag_coeff[i][im][0] = coeff->mag_coeff[i][im][MAXIQCAL / 2];\n\t\tcoeff->phs_coeff[i][im][0] = coeff->phs_coeff[i][im][MAXIQCAL / 2];\n\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"IQCAL: Median [ch%d][gain%d]: mag = %d phase = %d\\n\",\n\t\t\ti, im,\n\t\t\tcoeff->mag_coeff[i][im][0],\n\t\t\tcoeff->phs_coeff[i][im][0]);\n\t}\n}\n\nstatic bool ar955x_tx_iq_cal_median(struct ath_hw *ah,\n\t\t\t\t    struct coeff *coeff,\n\t\t\t\t    int iqcal_idx,\n\t\t\t\t    int nmeasurement)\n{\n\tint i;\n\n\tif ((iqcal_idx + 1) != MAXIQCAL)\n\t\treturn false;\n\n\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\t__ar955x_tx_iq_cal_sort(ah, coeff, i, nmeasurement);\n\t}\n\n\treturn true;\n}\n\nstatic void ar9003_hw_tx_iq_cal_post_proc(struct ath_hw *ah,\n\t\t\t\t\t  int iqcal_idx,\n\t\t\t\t\t  bool is_reusable)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tconst u32 txiqcal_status[AR9300_MAX_CHAINS] = {\n\t\tAR_PHY_TX_IQCAL_STATUS_B0(ah),\n\t\tAR_PHY_TX_IQCAL_STATUS_B1,\n\t\tAR_PHY_TX_IQCAL_STATUS_B2,\n\t};\n\tconst u_int32_t chan_info_tab[] = {\n\t\tAR_PHY_CHAN_INFO_TAB_0,\n\t\tAR_PHY_CHAN_INFO_TAB_1,\n\t\tAR_PHY_CHAN_INFO_TAB_2,\n\t};\n\tstatic struct coeff coeff;\n\ts32 iq_res[6];\n\tint i, im, j;\n\tint nmeasurement = 0;\n\tbool outlier_detect = true;\n\n\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\tif (!(ah->txchainmask & (1 << i)))\n\t\t\tcontinue;\n\n\t\tnmeasurement = REG_READ_FIELD(ah,\n\t\t\t\tAR_PHY_TX_IQCAL_STATUS_B0(ah),\n\t\t\t\tAR_PHY_CALIBRATED_GAINS_0);\n\t\tif (nmeasurement > MAX_MEASUREMENT)\n\t\t\tnmeasurement = MAX_MEASUREMENT;\n\n\t\tfor (im = 0; im < nmeasurement; im++) {\n\t\t\tath_dbg(common, CALIBRATE,\n\t\t\t\t\"Doing Tx IQ Cal for chain %d\\n\", i);\n\n\t\t\tif (REG_READ(ah, txiqcal_status[i]) &\n\t\t\t\t\tAR_PHY_TX_IQCAL_STATUS_FAILED) {\n\t\t\t\tath_dbg(common, CALIBRATE,\n\t\t\t\t\t\"Tx IQ Cal failed for chain %d\\n\", i);\n\t\t\t\tgoto tx_iqcal_fail;\n\t\t\t}\n\n\t\t\tfor (j = 0; j < 3; j++) {\n\t\t\t\tu32 idx = 2 * j, offset = 4 * (3 * im + j);\n\n\t\t\t\tREG_RMW_FIELD(ah,\n\t\t\t\t\t\tAR_PHY_CHAN_INFO_MEMORY(ah),\n\t\t\t\t\t\tAR_PHY_CHAN_INFO_TAB_S2_READ,\n\t\t\t\t\t\t0);\n\n\t\t\t\t \n\t\t\t\tiq_res[idx] = REG_READ(ah,\n\t\t\t\t\t\tchan_info_tab[i] +\n\t\t\t\t\t\toffset);\n\n\t\t\t\tREG_RMW_FIELD(ah,\n\t\t\t\t\t\tAR_PHY_CHAN_INFO_MEMORY(ah),\n\t\t\t\t\t\tAR_PHY_CHAN_INFO_TAB_S2_READ,\n\t\t\t\t\t\t1);\n\n\t\t\t\t \n\t\t\t\tiq_res[idx + 1] = 0xffff & REG_READ(ah,\n\t\t\t\t\t\tchan_info_tab[i] + offset);\n\n\t\t\t\tath_dbg(common, CALIBRATE,\n\t\t\t\t\t\"IQ_RES[%d]=0x%x IQ_RES[%d]=0x%x\\n\",\n\t\t\t\t\tidx, iq_res[idx], idx + 1,\n\t\t\t\t\tiq_res[idx + 1]);\n\t\t\t}\n\n\t\t\tif (!ar9003_hw_calc_iq_corr(ah, i, iq_res,\n\t\t\t\t\t\tcoeff.iqc_coeff)) {\n\t\t\t\tath_dbg(common, CALIBRATE,\n\t\t\t\t\t\"Failed in calculation of IQ correction\\n\");\n\t\t\t\tgoto tx_iqcal_fail;\n\t\t\t}\n\n\t\t\tcoeff.phs_coeff[i][im][iqcal_idx] =\n\t\t\t\tcoeff.iqc_coeff[0] & 0x7f;\n\t\t\tcoeff.mag_coeff[i][im][iqcal_idx] =\n\t\t\t\t(coeff.iqc_coeff[0] >> 7) & 0x7f;\n\n\t\t\tif (coeff.mag_coeff[i][im][iqcal_idx] > 63)\n\t\t\t\tcoeff.mag_coeff[i][im][iqcal_idx] -= 128;\n\t\t\tif (coeff.phs_coeff[i][im][iqcal_idx] > 63)\n\t\t\t\tcoeff.phs_coeff[i][im][iqcal_idx] -= 128;\n\t\t}\n\t}\n\n\tif (AR_SREV_9550(ah))\n\t\toutlier_detect = ar955x_tx_iq_cal_median(ah, &coeff,\n\t\t\t\t\t\t\t iqcal_idx, nmeasurement);\n\tif (outlier_detect)\n\t\tar9003_hw_tx_iq_cal_outlier_detection(ah, &coeff, is_reusable);\n\n\treturn;\n\ntx_iqcal_fail:\n\tath_dbg(common, CALIBRATE, \"Tx IQ Cal failed\\n\");\n\treturn;\n}\n\nstatic void ar9003_hw_tx_iq_cal_reload(struct ath_hw *ah)\n{\n\tstruct ath9k_hw_cal_data *caldata = ah->caldata;\n\tu32 tx_corr_coeff[MAX_MEASUREMENT][AR9300_MAX_CHAINS];\n\tint i, im;\n\n\tmemset(tx_corr_coeff, 0, sizeof(tx_corr_coeff));\n\tfor (i = 0; i < MAX_MEASUREMENT / 2; i++) {\n\t\ttx_corr_coeff[i * 2][0] = tx_corr_coeff[(i * 2) + 1][0] =\n\t\t\t\t\tAR_PHY_TX_IQCAL_CORR_COEFF_B0(ah, i);\n\t\tif (!AR_SREV_9485(ah)) {\n\t\t\ttx_corr_coeff[i * 2][1] =\n\t\t\ttx_corr_coeff[(i * 2) + 1][1] =\n\t\t\t\t\tAR_PHY_TX_IQCAL_CORR_COEFF_B1(i);\n\n\t\t\ttx_corr_coeff[i * 2][2] =\n\t\t\ttx_corr_coeff[(i * 2) + 1][2] =\n\t\t\t\t\tAR_PHY_TX_IQCAL_CORR_COEFF_B2(i);\n\t\t}\n\t}\n\n\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\tif (!(ah->txchainmask & (1 << i)))\n\t\t\tcontinue;\n\n\t\tfor (im = 0; im < caldata->num_measures[i]; im++) {\n\t\t\tif ((im % 2) == 0)\n\t\t\t\tREG_RMW_FIELD(ah, tx_corr_coeff[im][i],\n\t\t\t\t     AR_PHY_TX_IQCAL_CORR_COEFF_00_COEFF_TABLE,\n\t\t\t\t     caldata->tx_corr_coeff[im][i]);\n\t\t\telse\n\t\t\t\tREG_RMW_FIELD(ah, tx_corr_coeff[im][i],\n\t\t\t\t     AR_PHY_TX_IQCAL_CORR_COEFF_01_COEFF_TABLE,\n\t\t\t\t     caldata->tx_corr_coeff[im][i]);\n\t\t}\n\t}\n\n\tREG_RMW_FIELD(ah, AR_PHY_TX_IQCAL_CONTROL_3,\n\t\t      AR_PHY_TX_IQCAL_CONTROL_3_IQCORR_EN, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_RX_IQCAL_CORR_B0,\n\t\t      AR_PHY_RX_IQCAL_CORR_B0_LOOPBACK_IQCORR_EN, 0x1);\n}\n\nstatic void ar9003_hw_manual_peak_cal(struct ath_hw *ah, u8 chain, bool is_2g)\n{\n\tint offset[8] = {0}, total = 0, test;\n\tint agc_out, i, peak_detect_threshold = 0;\n\n\tif (AR_SREV_9550(ah) || AR_SREV_9531(ah))\n\t\tpeak_detect_threshold = 8;\n\telse if (AR_SREV_9561(ah))\n\t\tpeak_detect_threshold = 11;\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_GAINSTAGES(chain),\n\t\t      AR_PHY_65NM_RXRF_GAINSTAGES_RX_OVERRIDE, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_GAINSTAGES(chain),\n\t\t      AR_PHY_65NM_RXRF_GAINSTAGES_LNAON_CALDC, 0x0);\n\n\tif (AR_SREV_9003_PCOEM(ah) || AR_SREV_9330_11(ah)) {\n\t\tif (is_2g)\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_GAINSTAGES(chain),\n\t\t\t\t      AR_PHY_65NM_RXRF_GAINSTAGES_LNA2G_GAIN_OVR, 0x0);\n\t\telse\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_GAINSTAGES(chain),\n\t\t\t\t      AR_PHY_65NM_RXRF_GAINSTAGES_LNA5G_GAIN_OVR, 0x0);\n\t}\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXTX2(chain),\n\t\t      AR_PHY_65NM_RXTX2_RXON_OVR, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXTX2(chain),\n\t\t      AR_PHY_65NM_RXTX2_RXON, 0x0);\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t      AR_PHY_65NM_RXRF_AGC_AGC_OVERRIDE, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t      AR_PHY_65NM_RXRF_AGC_AGC_ON_OVR, 0x1);\n\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t      AR_PHY_65NM_RXRF_AGC_AGC_CAL_OVR, 0x1);\n\n\tif (AR_SREV_9330_11(ah))\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC2G_CALDAC_OVR, 0x0);\n\n\tif (is_2g)\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC2G_DBDAC_OVR,\n\t\t\t      peak_detect_threshold);\n\telse\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC5G_DBDAC_OVR,\n\t\t\t      peak_detect_threshold);\n\n\tfor (i = 6; i > 0; i--) {\n\t\toffset[i] = BIT(i - 1);\n\t\ttest = total + offset[i];\n\n\t\tif (is_2g)\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC2G_CALDAC_OVR,\n\t\t\t\t      test);\n\t\telse\n\t\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC5G_CALDAC_OVR,\n\t\t\t\t      test);\n\t\tudelay(100);\n\t\tagc_out = REG_READ_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t\t\t\t AR_PHY_65NM_RXRF_AGC_AGC_OUT);\n\t\toffset[i] = (agc_out) ? 0 : 1;\n\t\ttotal += (offset[i] << (i - 1));\n\t}\n\n\tif (is_2g)\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC2G_CALDAC_OVR, total);\n\telse\n\t\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t\t      AR_PHY_65NM_RXRF_AGC_AGC5G_CALDAC_OVR, total);\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_GAINSTAGES(chain),\n\t\t      AR_PHY_65NM_RXRF_GAINSTAGES_RX_OVERRIDE, 0);\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXTX2(chain),\n\t\t      AR_PHY_65NM_RXTX2_RXON_OVR, 0);\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\n\t\t      AR_PHY_65NM_RXRF_AGC_AGC_CAL_OVR, 0);\n}\n\nstatic void ar9003_hw_do_pcoem_manual_peak_cal(struct ath_hw *ah,\n\t\t\t\t\t       struct ath9k_channel *chan,\n\t\t\t\t\t       bool run_rtt_cal)\n{\n\tstruct ath9k_hw_cal_data *caldata = ah->caldata;\n\tint i;\n\n\tif ((ah->caps.hw_caps & ATH9K_HW_CAP_RTT) && !run_rtt_cal)\n\t\treturn;\n\n\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\tif (!(ah->rxchainmask & (1 << i)))\n\t\t\tcontinue;\n\t\tar9003_hw_manual_peak_cal(ah, i, IS_CHAN_2GHZ(chan));\n\t}\n\n\tif (caldata)\n\t\tset_bit(SW_PKDET_DONE, &caldata->cal_flags);\n\n\tif ((ah->caps.hw_caps & ATH9K_HW_CAP_RTT) && caldata) {\n\t\tif (IS_CHAN_2GHZ(chan)){\n\t\t\tcaldata->caldac[0] = REG_READ_FIELD(ah,\n\t\t\t\t\t\t    AR_PHY_65NM_RXRF_AGC(0),\n\t\t\t\t\t\t    AR_PHY_65NM_RXRF_AGC_AGC2G_CALDAC_OVR);\n\t\t\tcaldata->caldac[1] = REG_READ_FIELD(ah,\n\t\t\t\t\t\t    AR_PHY_65NM_RXRF_AGC(1),\n\t\t\t\t\t\t    AR_PHY_65NM_RXRF_AGC_AGC2G_CALDAC_OVR);\n\t\t} else {\n\t\t\tcaldata->caldac[0] = REG_READ_FIELD(ah,\n\t\t\t\t\t\t    AR_PHY_65NM_RXRF_AGC(0),\n\t\t\t\t\t\t    AR_PHY_65NM_RXRF_AGC_AGC5G_CALDAC_OVR);\n\t\t\tcaldata->caldac[1] = REG_READ_FIELD(ah,\n\t\t\t\t\t\t    AR_PHY_65NM_RXRF_AGC(1),\n\t\t\t\t\t\t    AR_PHY_65NM_RXRF_AGC_AGC5G_CALDAC_OVR);\n\t\t}\n\t}\n}\n\nstatic void ar9003_hw_cl_cal_post_proc(struct ath_hw *ah, bool is_reusable)\n{\n\tu32 cl_idx[AR9300_MAX_CHAINS] = { AR_PHY_CL_TAB_0,\n\t\t\t\t\t  AR_PHY_CL_TAB_1,\n\t\t\t\t\t  AR_PHY_CL_TAB_2 };\n\tstruct ath9k_hw_cal_data *caldata = ah->caldata;\n\tbool txclcal_done = false;\n\tint i, j;\n\n\tif (!caldata || !(ah->enabled_cals & TX_CL_CAL))\n\t\treturn;\n\n\ttxclcal_done = !!(REG_READ(ah, AR_PHY_AGC_CONTROL(ah)) &\n\t\t\t  AR_PHY_AGC_CONTROL_CLC_SUCCESS);\n\n\tif (test_bit(TXCLCAL_DONE, &caldata->cal_flags)) {\n\t\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\t\tif (!(ah->txchainmask & (1 << i)))\n\t\t\t\tcontinue;\n\t\t\tfor (j = 0; j < MAX_CL_TAB_ENTRY; j++)\n\t\t\t\tREG_WRITE(ah, CL_TAB_ENTRY(cl_idx[i]),\n\t\t\t\t\t  caldata->tx_clcal[i][j]);\n\t\t}\n\t} else if (is_reusable && txclcal_done) {\n\t\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\t\tif (!(ah->txchainmask & (1 << i)))\n\t\t\t\tcontinue;\n\t\t\tfor (j = 0; j < MAX_CL_TAB_ENTRY; j++)\n\t\t\t\tcaldata->tx_clcal[i][j] =\n\t\t\t\t\tREG_READ(ah, CL_TAB_ENTRY(cl_idx[i]));\n\t\t}\n\t\tset_bit(TXCLCAL_DONE, &caldata->cal_flags);\n\t}\n}\n\nstatic void ar9003_hw_init_cal_common(struct ath_hw *ah)\n{\n\tstruct ath9k_hw_cal_data *caldata = ah->caldata;\n\n\t \n\tah->cal_list = ah->cal_list_last = ah->cal_list_curr = NULL;\n\n\tINIT_CAL(&ah->iq_caldata);\n\tINSERT_CAL(ah, &ah->iq_caldata);\n\n\t \n\tah->cal_list_curr = ah->cal_list;\n\n\tif (ah->cal_list_curr)\n\t\tath9k_hw_reset_calibration(ah, ah->cal_list_curr);\n\n\tif (caldata)\n\t\tcaldata->CalValid = 0;\n}\n\nstatic bool ar9003_hw_init_cal_pcoem(struct ath_hw *ah,\n\t\t\t\t     struct ath9k_channel *chan)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tstruct ath9k_hw_cal_data *caldata = ah->caldata;\n\tbool txiqcal_done = false;\n\tbool is_reusable = true, status = true;\n\tbool run_rtt_cal = false, run_agc_cal;\n\tbool rtt = !!(ah->caps.hw_caps & ATH9K_HW_CAP_RTT);\n\tu32 rx_delay = 0;\n\tu32 agc_ctrl = 0, agc_supp_cals = AR_PHY_AGC_CONTROL_OFFSET_CAL |\n\t\t\t\t\t  AR_PHY_AGC_CONTROL_FLTR_CAL   |\n\t\t\t\t\t  AR_PHY_AGC_CONTROL_PKDET_CAL;\n\n\t \n\tar9003_hw_set_chain_masks(ah, ah->caps.rx_chainmask, ah->caps.tx_chainmask);\n\n\tif (rtt) {\n\t\tif (!ar9003_hw_rtt_restore(ah, chan))\n\t\t\trun_rtt_cal = true;\n\n\t\tif (run_rtt_cal)\n\t\t\tath_dbg(common, CALIBRATE, \"RTT calibration to be done\\n\");\n\t}\n\n\trun_agc_cal = run_rtt_cal;\n\n\tif (run_rtt_cal) {\n\t\tar9003_hw_rtt_enable(ah);\n\t\tar9003_hw_rtt_set_mask(ah, 0x00);\n\t\tar9003_hw_rtt_clear_hist(ah);\n\t}\n\n\tif (rtt) {\n\t\tif (!run_rtt_cal) {\n\t\t\tagc_ctrl = REG_READ(ah, AR_PHY_AGC_CONTROL(ah));\n\t\t\tagc_supp_cals &= agc_ctrl;\n\t\t\tagc_ctrl &= ~(AR_PHY_AGC_CONTROL_OFFSET_CAL |\n\t\t\t\t      AR_PHY_AGC_CONTROL_FLTR_CAL |\n\t\t\t\t      AR_PHY_AGC_CONTROL_PKDET_CAL);\n\t\t\tREG_WRITE(ah, AR_PHY_AGC_CONTROL(ah), agc_ctrl);\n\t\t} else {\n\t\t\tif (ah->ah_flags & AH_FASTCC)\n\t\t\t\trun_agc_cal = true;\n\t\t}\n\t}\n\n\tif (ah->enabled_cals & TX_CL_CAL) {\n\t\tif (caldata && test_bit(TXCLCAL_DONE, &caldata->cal_flags))\n\t\t\tREG_CLR_BIT(ah, AR_PHY_CL_CAL_CTL,\n\t\t\t\t    AR_PHY_CL_CAL_ENABLE);\n\t\telse {\n\t\t\tREG_SET_BIT(ah, AR_PHY_CL_CAL_CTL,\n\t\t\t\t    AR_PHY_CL_CAL_ENABLE);\n\t\t\trun_agc_cal = true;\n\t\t}\n\t}\n\n\tif ((IS_CHAN_HALF_RATE(chan) || IS_CHAN_QUARTER_RATE(chan)) ||\n\t    !(ah->enabled_cals & TX_IQ_CAL))\n\t\tgoto skip_tx_iqcal;\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_TX_IQCAL_CONTROL_1(ah),\n\t\t      AR_PHY_TX_IQCAL_CONTROL_1_IQCORR_I_Q_COFF_DELPT,\n\t\t      DELPT);\n\n\t \n\tif (ah->enabled_cals & TX_IQ_ON_AGC_CAL) {\n\t\tif (caldata && !test_bit(TXIQCAL_DONE, &caldata->cal_flags))\n\t\t\tREG_SET_BIT(ah, AR_PHY_TX_IQCAL_CONTROL_0(ah),\n\t\t\t\t    AR_PHY_TX_IQCAL_CONTROL_0_ENABLE_TXIQ_CAL);\n\t\telse\n\t\t\tREG_CLR_BIT(ah, AR_PHY_TX_IQCAL_CONTROL_0(ah),\n\t\t\t\t    AR_PHY_TX_IQCAL_CONTROL_0_ENABLE_TXIQ_CAL);\n\t\ttxiqcal_done = run_agc_cal = true;\n\t}\n\nskip_tx_iqcal:\n\tif (ath9k_hw_mci_is_enabled(ah) && IS_CHAN_2GHZ(chan) && run_agc_cal)\n\t\tar9003_mci_init_cal_req(ah, &is_reusable);\n\n\tif (REG_READ(ah, AR_PHY_CL_CAL_CTL) & AR_PHY_CL_CAL_ENABLE) {\n\t\trx_delay = REG_READ(ah, AR_PHY_RX_DELAY);\n\t\t \n\t\tREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_DIS);\n\t\tudelay(5);\n\t\tREG_WRITE(ah, AR_PHY_RX_DELAY, AR_PHY_RX_DELAY_DELAY);\n\t\tREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_EN);\n\t}\n\n\tif (run_agc_cal || !(ah->ah_flags & AH_FASTCC)) {\n\t\t \n\t\tREG_WRITE(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t\t  REG_READ(ah, AR_PHY_AGC_CONTROL(ah)) |\n\t\t\t  AR_PHY_AGC_CONTROL_CAL);\n\n\t\t \n\t\tstatus = ath9k_hw_wait(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t\t\t       AR_PHY_AGC_CONTROL_CAL,\n\t\t\t\t       0, AH_WAIT_TIMEOUT);\n\n\t\tar9003_hw_do_pcoem_manual_peak_cal(ah, chan, run_rtt_cal);\n\t}\n\n\tif (REG_READ(ah, AR_PHY_CL_CAL_CTL) & AR_PHY_CL_CAL_ENABLE) {\n\t\tREG_WRITE(ah, AR_PHY_RX_DELAY, rx_delay);\n\t\tudelay(5);\n\t}\n\n\tif (ath9k_hw_mci_is_enabled(ah) && IS_CHAN_2GHZ(chan) && run_agc_cal)\n\t\tar9003_mci_init_cal_done(ah);\n\n\tif (rtt && !run_rtt_cal) {\n\t\tagc_ctrl |= agc_supp_cals;\n\t\tREG_WRITE(ah, AR_PHY_AGC_CONTROL(ah), agc_ctrl);\n\t}\n\n\tif (!status) {\n\t\tif (run_rtt_cal)\n\t\t\tar9003_hw_rtt_disable(ah);\n\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"offset calibration failed to complete in %d ms; noisy environment?\\n\",\n\t\t\tAH_WAIT_TIMEOUT / 1000);\n\t\treturn false;\n\t}\n\n\tif (txiqcal_done)\n\t\tar9003_hw_tx_iq_cal_post_proc(ah, 0, is_reusable);\n\telse if (caldata && test_bit(TXIQCAL_DONE, &caldata->cal_flags))\n\t\tar9003_hw_tx_iq_cal_reload(ah);\n\n\tar9003_hw_cl_cal_post_proc(ah, is_reusable);\n\n\tif (run_rtt_cal && caldata) {\n\t\tif (is_reusable) {\n\t\t\tif (!ath9k_hw_rfbus_req(ah)) {\n\t\t\t\tath_err(ath9k_hw_common(ah),\n\t\t\t\t\t\"Could not stop baseband\\n\");\n\t\t\t} else {\n\t\t\t\tar9003_hw_rtt_fill_hist(ah);\n\n\t\t\t\tif (test_bit(SW_PKDET_DONE, &caldata->cal_flags))\n\t\t\t\t\tar9003_hw_rtt_load_hist(ah);\n\t\t\t}\n\n\t\t\tath9k_hw_rfbus_done(ah);\n\t\t}\n\n\t\tar9003_hw_rtt_disable(ah);\n\t}\n\n\t \n\tar9003_hw_set_chain_masks(ah, ah->rxchainmask, ah->txchainmask);\n\n\tar9003_hw_init_cal_common(ah);\n\n\treturn true;\n}\n\nstatic bool do_ar9003_agc_cal(struct ath_hw *ah)\n{\n\tstruct ath_common *common = ath9k_hw_common(ah);\n\tbool status;\n\n\tREG_WRITE(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t  REG_READ(ah, AR_PHY_AGC_CONTROL(ah)) |\n\t\t  AR_PHY_AGC_CONTROL_CAL);\n\n\tstatus = ath9k_hw_wait(ah, AR_PHY_AGC_CONTROL(ah),\n\t\t\t       AR_PHY_AGC_CONTROL_CAL,\n\t\t\t       0, AH_WAIT_TIMEOUT);\n\tif (!status) {\n\t\tath_dbg(common, CALIBRATE,\n\t\t\t\"offset calibration failed to complete in %d ms,\"\n\t\t\t\"noisy environment?\\n\",\n\t\t\tAH_WAIT_TIMEOUT / 1000);\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic bool ar9003_hw_init_cal_soc(struct ath_hw *ah,\n\t\t\t\t   struct ath9k_channel *chan)\n{\n\tbool txiqcal_done = false;\n\tbool status = true;\n\tbool run_agc_cal = false, sep_iq_cal = false;\n\tint i = 0;\n\n\t \n\tar9003_hw_set_chain_masks(ah, ah->caps.rx_chainmask, ah->caps.tx_chainmask);\n\n\tif (ah->enabled_cals & TX_CL_CAL) {\n\t\tREG_SET_BIT(ah, AR_PHY_CL_CAL_CTL, AR_PHY_CL_CAL_ENABLE);\n\t\trun_agc_cal = true;\n\t}\n\n\tif (IS_CHAN_HALF_RATE(chan) || IS_CHAN_QUARTER_RATE(chan))\n\t\tgoto skip_tx_iqcal;\n\n\t \n\tREG_RMW_FIELD(ah, AR_PHY_TX_IQCAL_CONTROL_1(ah),\n\t\t      AR_PHY_TX_IQCAL_CONTROL_1_IQCORR_I_Q_COFF_DELPT,\n\t\t      DELPT);\n\n\t \n\tif (ah->enabled_cals & TX_IQ_ON_AGC_CAL) {\n\t\tif (REG_READ_FIELD(ah, AR_PHY_TX_IQCAL_CONTROL_0(ah),\n\t\t\t\t   AR_PHY_TX_IQCAL_CONTROL_0_ENABLE_TXIQ_CAL)) {\n\t\t\t\ttxiqcal_done = true;\n\t\t} else {\n\t\t\ttxiqcal_done = false;\n\t\t}\n\t\trun_agc_cal = true;\n\t} else {\n\t\tsep_iq_cal = true;\n\t\trun_agc_cal = true;\n\t}\n\n\t \n\tif (sep_iq_cal) {\n\t\ttxiqcal_done = ar9003_hw_tx_iq_cal_run(ah);\n\t\tREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_DIS);\n\t\tudelay(5);\n\t\tREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_EN);\n\t}\n\n\tif (AR_SREV_9550(ah) && IS_CHAN_2GHZ(chan)) {\n\t\tif (!ar9003_hw_dynamic_osdac_selection(ah, txiqcal_done))\n\t\t\treturn false;\n\t}\n\nskip_tx_iqcal:\n\tif (run_agc_cal || !(ah->ah_flags & AH_FASTCC)) {\n\t\tfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\n\t\t\tif (!(ah->rxchainmask & (1 << i)))\n\t\t\t\tcontinue;\n\n\t\t\tar9003_hw_manual_peak_cal(ah, i,\n\t\t\t\t\t\t  IS_CHAN_2GHZ(chan));\n\t\t}\n\n\t\t \n\t\tif (!AR_SREV_9550(ah)) {\n\t\t\tstatus = do_ar9003_agc_cal(ah);\n\t\t\tif (!status)\n\t\t\t\treturn false;\n\n\t\t\tif (txiqcal_done)\n\t\t\t\tar9003_hw_tx_iq_cal_post_proc(ah, 0, false);\n\t\t} else {\n\t\t\tif (!txiqcal_done) {\n\t\t\t\tstatus = do_ar9003_agc_cal(ah);\n\t\t\t\tif (!status)\n\t\t\t\t\treturn false;\n\t\t\t} else {\n\t\t\t\tfor (i = 0; i < MAXIQCAL; i++) {\n\t\t\t\t\tstatus = do_ar9003_agc_cal(ah);\n\t\t\t\t\tif (!status)\n\t\t\t\t\t\treturn false;\n\t\t\t\t\tar9003_hw_tx_iq_cal_post_proc(ah, i, false);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tar9003_hw_set_chain_masks(ah, ah->rxchainmask, ah->txchainmask);\n\n\tar9003_hw_init_cal_common(ah);\n\n\treturn true;\n}\n\nvoid ar9003_hw_attach_calib_ops(struct ath_hw *ah)\n{\n\tstruct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);\n\tstruct ath_hw_ops *ops = ath9k_hw_ops(ah);\n\n\tif (AR_SREV_9003_PCOEM(ah))\n\t\tpriv_ops->init_cal = ar9003_hw_init_cal_pcoem;\n\telse\n\t\tpriv_ops->init_cal = ar9003_hw_init_cal_soc;\n\n\tpriv_ops->init_cal_settings = ar9003_hw_init_cal_settings;\n\tpriv_ops->setup_calibration = ar9003_hw_setup_calibration;\n\n\tops->calibrate = ar9003_hw_calibrate;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}