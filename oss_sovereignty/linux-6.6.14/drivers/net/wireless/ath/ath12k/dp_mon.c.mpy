{
  "module_name": "dp_mon.c",
  "hash_id": "8bae84affd886ec487dd94909d64e2ae11132909f9aa0dfe44d241f000142faa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath12k/dp_mon.c",
  "human_readable_source": "\n \n\n#include \"dp_mon.h\"\n#include \"debug.h\"\n#include \"dp_rx.h\"\n#include \"dp_tx.h\"\n#include \"peer.h\"\n\nstatic void ath12k_dp_mon_rx_handle_ofdma_info(void *rx_tlv,\n\t\t\t\t\t       struct hal_rx_user_status *rx_user_status)\n{\n\tstruct hal_rx_ppdu_end_user_stats *ppdu_end_user =\n\t\t\t\t(struct hal_rx_ppdu_end_user_stats *)rx_tlv;\n\n\trx_user_status->ul_ofdma_user_v0_word0 =\n\t\t__le32_to_cpu(ppdu_end_user->usr_resp_ref);\n\trx_user_status->ul_ofdma_user_v0_word1 =\n\t\t__le32_to_cpu(ppdu_end_user->usr_resp_ref_ext);\n}\n\nstatic void\nath12k_dp_mon_rx_populate_byte_count(void *rx_tlv, void *ppduinfo,\n\t\t\t\t     struct hal_rx_user_status *rx_user_status)\n{\n\tstruct hal_rx_ppdu_end_user_stats *ppdu_end_user =\n\t\t(struct hal_rx_ppdu_end_user_stats *)rx_tlv;\n\tu32 mpdu_ok_byte_count = __le32_to_cpu(ppdu_end_user->mpdu_ok_cnt);\n\tu32 mpdu_err_byte_count = __le32_to_cpu(ppdu_end_user->mpdu_err_cnt);\n\n\trx_user_status->mpdu_ok_byte_count =\n\t\tu32_get_bits(mpdu_ok_byte_count,\n\t\t\t     HAL_RX_PPDU_END_USER_STATS_MPDU_DELIM_OK_BYTE_COUNT);\n\trx_user_status->mpdu_err_byte_count =\n\t\tu32_get_bits(mpdu_err_byte_count,\n\t\t\t     HAL_RX_PPDU_END_USER_STATS_MPDU_DELIM_ERR_BYTE_COUNT);\n}\n\nstatic void\nath12k_dp_mon_rx_populate_mu_user_info(void *rx_tlv,\n\t\t\t\t       struct hal_rx_mon_ppdu_info *ppdu_info,\n\t\t\t\t       struct hal_rx_user_status *rx_user_status)\n{\n\trx_user_status->ast_index = ppdu_info->ast_index;\n\trx_user_status->tid = ppdu_info->tid;\n\trx_user_status->tcp_ack_msdu_count =\n\t\tppdu_info->tcp_ack_msdu_count;\n\trx_user_status->tcp_msdu_count =\n\t\tppdu_info->tcp_msdu_count;\n\trx_user_status->udp_msdu_count =\n\t\tppdu_info->udp_msdu_count;\n\trx_user_status->other_msdu_count =\n\t\tppdu_info->other_msdu_count;\n\trx_user_status->frame_control = ppdu_info->frame_control;\n\trx_user_status->frame_control_info_valid =\n\t\tppdu_info->frame_control_info_valid;\n\trx_user_status->data_sequence_control_info_valid =\n\t\tppdu_info->data_sequence_control_info_valid;\n\trx_user_status->first_data_seq_ctrl =\n\t\tppdu_info->first_data_seq_ctrl;\n\trx_user_status->preamble_type = ppdu_info->preamble_type;\n\trx_user_status->ht_flags = ppdu_info->ht_flags;\n\trx_user_status->vht_flags = ppdu_info->vht_flags;\n\trx_user_status->he_flags = ppdu_info->he_flags;\n\trx_user_status->rs_flags = ppdu_info->rs_flags;\n\n\trx_user_status->mpdu_cnt_fcs_ok =\n\t\tppdu_info->num_mpdu_fcs_ok;\n\trx_user_status->mpdu_cnt_fcs_err =\n\t\tppdu_info->num_mpdu_fcs_err;\n\tmemcpy(&rx_user_status->mpdu_fcs_ok_bitmap[0], &ppdu_info->mpdu_fcs_ok_bitmap[0],\n\t       HAL_RX_NUM_WORDS_PER_PPDU_BITMAP *\n\t       sizeof(ppdu_info->mpdu_fcs_ok_bitmap[0]));\n\n\tath12k_dp_mon_rx_populate_byte_count(rx_tlv, ppdu_info, rx_user_status);\n}\n\nstatic void ath12k_dp_mon_parse_vht_sig_a(u8 *tlv_data,\n\t\t\t\t\t  struct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct hal_rx_vht_sig_a_info *vht_sig =\n\t\t\t(struct hal_rx_vht_sig_a_info *)tlv_data;\n\tu32 nsts, group_id, info0, info1;\n\tu8 gi_setting;\n\n\tinfo0 = __le32_to_cpu(vht_sig->info0);\n\tinfo1 = __le32_to_cpu(vht_sig->info1);\n\n\tppdu_info->ldpc = u32_get_bits(info1, HAL_RX_VHT_SIG_A_INFO_INFO1_SU_MU_CODING);\n\tppdu_info->mcs = u32_get_bits(info1, HAL_RX_VHT_SIG_A_INFO_INFO1_MCS);\n\tgi_setting = u32_get_bits(info1, HAL_RX_VHT_SIG_A_INFO_INFO1_GI_SETTING);\n\tswitch (gi_setting) {\n\tcase HAL_RX_VHT_SIG_A_NORMAL_GI:\n\t\tppdu_info->gi = HAL_RX_GI_0_8_US;\n\t\tbreak;\n\tcase HAL_RX_VHT_SIG_A_SHORT_GI:\n\tcase HAL_RX_VHT_SIG_A_SHORT_GI_AMBIGUITY:\n\t\tppdu_info->gi = HAL_RX_GI_0_4_US;\n\t\tbreak;\n\t}\n\n\tppdu_info->is_stbc = u32_get_bits(info0, HAL_RX_VHT_SIG_A_INFO_INFO0_STBC);\n\tnsts = u32_get_bits(info0, HAL_RX_VHT_SIG_A_INFO_INFO0_NSTS);\n\tif (ppdu_info->is_stbc && nsts > 0)\n\t\tnsts = ((nsts + 1) >> 1) - 1;\n\n\tppdu_info->nss = u32_get_bits(nsts, VHT_SIG_SU_NSS_MASK);\n\tppdu_info->bw = u32_get_bits(info0, HAL_RX_VHT_SIG_A_INFO_INFO0_BW);\n\tppdu_info->beamformed = u32_get_bits(info1,\n\t\t\t\t\t     HAL_RX_VHT_SIG_A_INFO_INFO1_BEAMFORMED);\n\tgroup_id = u32_get_bits(info0, HAL_RX_VHT_SIG_A_INFO_INFO0_GROUP_ID);\n\tif (group_id == 0 || group_id == 63)\n\t\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_SU;\n\telse\n\t\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_MU_MIMO;\n\tppdu_info->vht_flag_values5 = group_id;\n\tppdu_info->vht_flag_values3[0] = (((ppdu_info->mcs) << 4) |\n\t\t\t\t\t    ppdu_info->nss);\n\tppdu_info->vht_flag_values2 = ppdu_info->bw;\n\tppdu_info->vht_flag_values4 =\n\t\tu32_get_bits(info1, HAL_RX_VHT_SIG_A_INFO_INFO1_SU_MU_CODING);\n}\n\nstatic void ath12k_dp_mon_parse_ht_sig(u8 *tlv_data,\n\t\t\t\t       struct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct hal_rx_ht_sig_info *ht_sig =\n\t\t\t(struct hal_rx_ht_sig_info *)tlv_data;\n\tu32 info0 = __le32_to_cpu(ht_sig->info0);\n\tu32 info1 = __le32_to_cpu(ht_sig->info1);\n\n\tppdu_info->mcs = u32_get_bits(info0, HAL_RX_HT_SIG_INFO_INFO0_MCS);\n\tppdu_info->bw = u32_get_bits(info0, HAL_RX_HT_SIG_INFO_INFO0_BW);\n\tppdu_info->is_stbc = u32_get_bits(info1, HAL_RX_HT_SIG_INFO_INFO1_STBC);\n\tppdu_info->ldpc = u32_get_bits(info1, HAL_RX_HT_SIG_INFO_INFO1_FEC_CODING);\n\tppdu_info->gi = u32_get_bits(info1, HAL_RX_HT_SIG_INFO_INFO1_GI);\n\tppdu_info->nss = (ppdu_info->mcs >> 3);\n\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_SU;\n}\n\nstatic void ath12k_dp_mon_parse_l_sig_b(u8 *tlv_data,\n\t\t\t\t\tstruct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct hal_rx_lsig_b_info *lsigb =\n\t\t\t(struct hal_rx_lsig_b_info *)tlv_data;\n\tu32 info0 = __le32_to_cpu(lsigb->info0);\n\tu8 rate;\n\n\trate = u32_get_bits(info0, HAL_RX_LSIG_B_INFO_INFO0_RATE);\n\tswitch (rate) {\n\tcase 1:\n\t\trate = HAL_RX_LEGACY_RATE_1_MBPS;\n\t\tbreak;\n\tcase 2:\n\tcase 5:\n\t\trate = HAL_RX_LEGACY_RATE_2_MBPS;\n\t\tbreak;\n\tcase 3:\n\tcase 6:\n\t\trate = HAL_RX_LEGACY_RATE_5_5_MBPS;\n\t\tbreak;\n\tcase 4:\n\tcase 7:\n\t\trate = HAL_RX_LEGACY_RATE_11_MBPS;\n\t\tbreak;\n\tdefault:\n\t\trate = HAL_RX_LEGACY_RATE_INVALID;\n\t}\n\n\tppdu_info->rate = rate;\n\tppdu_info->cck_flag = 1;\n\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_SU;\n}\n\nstatic void ath12k_dp_mon_parse_l_sig_a(u8 *tlv_data,\n\t\t\t\t\tstruct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct hal_rx_lsig_a_info *lsiga =\n\t\t\t(struct hal_rx_lsig_a_info *)tlv_data;\n\tu32 info0 = __le32_to_cpu(lsiga->info0);\n\tu8 rate;\n\n\trate = u32_get_bits(info0, HAL_RX_LSIG_A_INFO_INFO0_RATE);\n\tswitch (rate) {\n\tcase 8:\n\t\trate = HAL_RX_LEGACY_RATE_48_MBPS;\n\t\tbreak;\n\tcase 9:\n\t\trate = HAL_RX_LEGACY_RATE_24_MBPS;\n\t\tbreak;\n\tcase 10:\n\t\trate = HAL_RX_LEGACY_RATE_12_MBPS;\n\t\tbreak;\n\tcase 11:\n\t\trate = HAL_RX_LEGACY_RATE_6_MBPS;\n\t\tbreak;\n\tcase 12:\n\t\trate = HAL_RX_LEGACY_RATE_54_MBPS;\n\t\tbreak;\n\tcase 13:\n\t\trate = HAL_RX_LEGACY_RATE_36_MBPS;\n\t\tbreak;\n\tcase 14:\n\t\trate = HAL_RX_LEGACY_RATE_18_MBPS;\n\t\tbreak;\n\tcase 15:\n\t\trate = HAL_RX_LEGACY_RATE_9_MBPS;\n\t\tbreak;\n\tdefault:\n\t\trate = HAL_RX_LEGACY_RATE_INVALID;\n\t}\n\n\tppdu_info->rate = rate;\n\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_SU;\n}\n\nstatic void ath12k_dp_mon_parse_he_sig_b2_ofdma(u8 *tlv_data,\n\t\t\t\t\t\tstruct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct hal_rx_he_sig_b2_ofdma_info *he_sig_b2_ofdma =\n\t\t\t(struct hal_rx_he_sig_b2_ofdma_info *)tlv_data;\n\tu32 info0, value;\n\n\tinfo0 = __le32_to_cpu(he_sig_b2_ofdma->info0);\n\n\tppdu_info->he_data1 |= HE_MCS_KNOWN | HE_DCM_KNOWN | HE_CODING_KNOWN;\n\n\t \n\tppdu_info->he_data2 |= HE_TXBF_KNOWN;\n\n\tppdu_info->mcs = u32_get_bits(info0, HAL_RX_HE_SIG_B2_OFDMA_INFO_INFO0_STA_MCS);\n\tvalue = ppdu_info->mcs << HE_TRANSMIT_MCS_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_B2_OFDMA_INFO_INFO0_STA_DCM);\n\tvalue = value << HE_DCM_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_B2_OFDMA_INFO_INFO0_STA_CODING);\n\tppdu_info->ldpc = value;\n\tvalue = value << HE_CODING_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\t \n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_B2_OFDMA_INFO_INFO0_STA_ID);\n\tvalue = value << HE_STA_ID_SHIFT;\n\tppdu_info->he_data4 |= value;\n\n\tppdu_info->nss = u32_get_bits(info0, HAL_RX_HE_SIG_B2_OFDMA_INFO_INFO0_STA_NSTS);\n\tppdu_info->beamformed = u32_get_bits(info0,\n\t\t\t\t\t     HAL_RX_HE_SIG_B2_OFDMA_INFO_INFO0_STA_TXBF);\n\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_MU_OFDMA;\n}\n\nstatic void ath12k_dp_mon_parse_he_sig_b2_mu(u8 *tlv_data,\n\t\t\t\t\t     struct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct hal_rx_he_sig_b2_mu_info *he_sig_b2_mu =\n\t\t\t(struct hal_rx_he_sig_b2_mu_info *)tlv_data;\n\tu32 info0, value;\n\n\tinfo0 = __le32_to_cpu(he_sig_b2_mu->info0);\n\n\tppdu_info->he_data1 |= HE_MCS_KNOWN | HE_CODING_KNOWN;\n\n\tppdu_info->mcs = u32_get_bits(info0, HAL_RX_HE_SIG_B2_MU_INFO_INFO0_STA_MCS);\n\tvalue = ppdu_info->mcs << HE_TRANSMIT_MCS_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_B2_MU_INFO_INFO0_STA_CODING);\n\tppdu_info->ldpc = value;\n\tvalue = value << HE_CODING_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_B2_MU_INFO_INFO0_STA_ID);\n\tvalue = value << HE_STA_ID_SHIFT;\n\tppdu_info->he_data4 |= value;\n\n\tppdu_info->nss = u32_get_bits(info0, HAL_RX_HE_SIG_B2_MU_INFO_INFO0_STA_NSTS);\n}\n\nstatic void ath12k_dp_mon_parse_he_sig_b1_mu(u8 *tlv_data,\n\t\t\t\t\t     struct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct hal_rx_he_sig_b1_mu_info *he_sig_b1_mu =\n\t\t\t(struct hal_rx_he_sig_b1_mu_info *)tlv_data;\n\tu32 info0 = __le32_to_cpu(he_sig_b1_mu->info0);\n\tu16 ru_tones;\n\n\tru_tones = u32_get_bits(info0,\n\t\t\t\tHAL_RX_HE_SIG_B1_MU_INFO_INFO0_RU_ALLOCATION);\n\tppdu_info->ru_alloc = ath12k_he_ru_tones_to_nl80211_he_ru_alloc(ru_tones);\n\tppdu_info->he_RU[0] = ru_tones;\n\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_MU_MIMO;\n}\n\nstatic void ath12k_dp_mon_parse_he_sig_mu(u8 *tlv_data,\n\t\t\t\t\t  struct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct hal_rx_he_sig_a_mu_dl_info *he_sig_a_mu_dl =\n\t\t\t(struct hal_rx_he_sig_a_mu_dl_info *)tlv_data;\n\tu32 info0, info1, value;\n\tu16 he_gi = 0, he_ltf = 0;\n\n\tinfo0 = __le32_to_cpu(he_sig_a_mu_dl->info0);\n\tinfo1 = __le32_to_cpu(he_sig_a_mu_dl->info1);\n\n\tppdu_info->he_mu_flags = 1;\n\n\tppdu_info->he_data1 = HE_MU_FORMAT_TYPE;\n\tppdu_info->he_data1 |=\n\t\t\tHE_BSS_COLOR_KNOWN |\n\t\t\tHE_DL_UL_KNOWN |\n\t\t\tHE_LDPC_EXTRA_SYMBOL_KNOWN |\n\t\t\tHE_STBC_KNOWN |\n\t\t\tHE_DATA_BW_RU_KNOWN |\n\t\t\tHE_DOPPLER_KNOWN;\n\n\tppdu_info->he_data2 =\n\t\t\tHE_GI_KNOWN |\n\t\t\tHE_LTF_SYMBOLS_KNOWN |\n\t\t\tHE_PRE_FEC_PADDING_KNOWN |\n\t\t\tHE_PE_DISAMBIGUITY_KNOWN |\n\t\t\tHE_TXOP_KNOWN |\n\t\t\tHE_MIDABLE_PERIODICITY_KNOWN;\n\n\t \n\tppdu_info->he_data3 = u32_get_bits(info0, HAL_RX_HE_SIG_A_MU_DL_INFO0_BSS_COLOR);\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_MU_DL_INFO0_UL_FLAG);\n\tvalue = value << HE_DL_UL_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_MU_DL_INFO1_LDPC_EXTRA);\n\tvalue = value << HE_LDPC_EXTRA_SYMBOL_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_MU_DL_INFO1_STBC);\n\tvalue = value << HE_STBC_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\t \n\tppdu_info->he_data4 = u32_get_bits(info0,\n\t\t\t\t\t   HAL_RX_HE_SIG_A_MU_DL_INFO0_SPATIAL_REUSE);\n\tppdu_info->he_data4 = value;\n\n\t \n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_MU_DL_INFO0_TRANSMIT_BW);\n\tppdu_info->he_data5 = value;\n\tppdu_info->bw = value;\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_MU_DL_INFO0_CP_LTF_SIZE);\n\tswitch (value) {\n\tcase 0:\n\t\the_gi = HE_GI_0_8;\n\t\the_ltf = HE_LTF_4_X;\n\t\tbreak;\n\tcase 1:\n\t\the_gi = HE_GI_0_8;\n\t\the_ltf = HE_LTF_2_X;\n\t\tbreak;\n\tcase 2:\n\t\the_gi = HE_GI_1_6;\n\t\the_ltf = HE_LTF_2_X;\n\t\tbreak;\n\tcase 3:\n\t\the_gi = HE_GI_3_2;\n\t\the_ltf = HE_LTF_4_X;\n\t\tbreak;\n\t}\n\n\tppdu_info->gi = he_gi;\n\tvalue = he_gi << HE_GI_SHIFT;\n\tppdu_info->he_data5 |= value;\n\n\tvalue = he_ltf << HE_LTF_SIZE_SHIFT;\n\tppdu_info->he_data5 |= value;\n\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_MU_DL_INFO1_NUM_LTF_SYMB);\n\tvalue = (value << HE_LTF_SYM_SHIFT);\n\tppdu_info->he_data5 |= value;\n\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_MU_DL_INFO1_PKT_EXT_FACTOR);\n\tvalue = value << HE_PRE_FEC_PAD_SHIFT;\n\tppdu_info->he_data5 |= value;\n\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_MU_DL_INFO1_PKT_EXT_PE_DISAM);\n\tvalue = value << HE_PE_DISAMBIGUITY_SHIFT;\n\tppdu_info->he_data5 |= value;\n\n\t \n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_MU_DL_INFO0_DOPPLER_INDICATION);\n\tvalue = value << HE_DOPPLER_SHIFT;\n\tppdu_info->he_data6 |= value;\n\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_MU_DL_INFO1_TXOP_DURATION);\n\tvalue = value << HE_TXOP_SHIFT;\n\tppdu_info->he_data6 |= value;\n\n\t \n\t \n\tppdu_info->he_flags1 =\n\t\tHE_SIG_B_MCS_KNOWN |\n\t\tHE_SIG_B_DCM_KNOWN |\n\t\tHE_SIG_B_COMPRESSION_FLAG_1_KNOWN |\n\t\tHE_SIG_B_SYM_NUM_KNOWN |\n\t\tHE_RU_0_KNOWN;\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_MU_DL_INFO0_MCS_OF_SIGB);\n\tppdu_info->he_flags1 |= value;\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_MU_DL_INFO0_DCM_OF_SIGB);\n\tvalue = value << HE_DCM_FLAG_1_SHIFT;\n\tppdu_info->he_flags1 |= value;\n\n\t \n\tppdu_info->he_flags2 = HE_BW_KNOWN;\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_MU_DL_INFO0_TRANSMIT_BW);\n\tppdu_info->he_flags2 |= value;\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_MU_DL_INFO0_COMP_MODE_SIGB);\n\tvalue = value << HE_SIG_B_COMPRESSION_FLAG_2_SHIFT;\n\tppdu_info->he_flags2 |= value;\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_MU_DL_INFO0_NUM_SIGB_SYMB);\n\tvalue = value - 1;\n\tvalue = value << HE_NUM_SIG_B_SYMBOLS_SHIFT;\n\tppdu_info->he_flags2 |= value;\n\n\tppdu_info->is_stbc = info1 &\n\t\t\t     HAL_RX_HE_SIG_A_MU_DL_INFO1_STBC;\n\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_MU_MIMO;\n}\n\nstatic void ath12k_dp_mon_parse_he_sig_su(u8 *tlv_data,\n\t\t\t\t\t  struct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct hal_rx_he_sig_a_su_info *he_sig_a =\n\t\t\t(struct hal_rx_he_sig_a_su_info *)tlv_data;\n\tu32 info0, info1, value;\n\tu32 dcm;\n\tu8 he_dcm = 0, he_stbc = 0;\n\tu16 he_gi = 0, he_ltf = 0;\n\n\tppdu_info->he_flags = 1;\n\n\tinfo0 = __le32_to_cpu(he_sig_a->info0);\n\tinfo1 = __le32_to_cpu(he_sig_a->info1);\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_FORMAT_IND);\n\tif (value == 0)\n\t\tppdu_info->he_data1 = HE_TRIG_FORMAT_TYPE;\n\telse\n\t\tppdu_info->he_data1 = HE_SU_FORMAT_TYPE;\n\n\tppdu_info->he_data1 |=\n\t\t\tHE_BSS_COLOR_KNOWN |\n\t\t\tHE_BEAM_CHANGE_KNOWN |\n\t\t\tHE_DL_UL_KNOWN |\n\t\t\tHE_MCS_KNOWN |\n\t\t\tHE_DCM_KNOWN |\n\t\t\tHE_CODING_KNOWN |\n\t\t\tHE_LDPC_EXTRA_SYMBOL_KNOWN |\n\t\t\tHE_STBC_KNOWN |\n\t\t\tHE_DATA_BW_RU_KNOWN |\n\t\t\tHE_DOPPLER_KNOWN;\n\n\tppdu_info->he_data2 |=\n\t\t\tHE_GI_KNOWN |\n\t\t\tHE_TXBF_KNOWN |\n\t\t\tHE_PE_DISAMBIGUITY_KNOWN |\n\t\t\tHE_TXOP_KNOWN |\n\t\t\tHE_LTF_SYMBOLS_KNOWN |\n\t\t\tHE_PRE_FEC_PADDING_KNOWN |\n\t\t\tHE_MIDABLE_PERIODICITY_KNOWN;\n\n\tppdu_info->he_data3 = u32_get_bits(info0,\n\t\t\t\t\t   HAL_RX_HE_SIG_A_SU_INFO_INFO0_BSS_COLOR);\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_BEAM_CHANGE);\n\tvalue = value << HE_BEAM_CHANGE_SHIFT;\n\tppdu_info->he_data3 |= value;\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_DL_UL_FLAG);\n\tvalue = value << HE_DL_UL_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_TRANSMIT_MCS);\n\tppdu_info->mcs = value;\n\tvalue = value << HE_TRANSMIT_MCS_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_DCM);\n\the_dcm = value;\n\tvalue = value << HE_DCM_SHIFT;\n\tppdu_info->he_data3 |= value;\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_CODING);\n\tvalue = value << HE_CODING_SHIFT;\n\tppdu_info->he_data3 |= value;\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_LDPC_EXTRA);\n\tvalue = value << HE_LDPC_EXTRA_SYMBOL_SHIFT;\n\tppdu_info->he_data3 |= value;\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_STBC);\n\the_stbc = value;\n\tvalue = value << HE_STBC_SHIFT;\n\tppdu_info->he_data3 |= value;\n\n\t \n\tppdu_info->he_data4 = u32_get_bits(info0,\n\t\t\t\t\t   HAL_RX_HE_SIG_A_SU_INFO_INFO0_SPATIAL_REUSE);\n\n\t \n\tvalue = u32_get_bits(info0,\n\t\t\t     HAL_RX_HE_SIG_A_SU_INFO_INFO0_TRANSMIT_BW);\n\tppdu_info->he_data5 = value;\n\tppdu_info->bw = value;\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_CP_LTF_SIZE);\n\tswitch (value) {\n\tcase 0:\n\t\the_gi = HE_GI_0_8;\n\t\the_ltf = HE_LTF_1_X;\n\t\tbreak;\n\tcase 1:\n\t\the_gi = HE_GI_0_8;\n\t\the_ltf = HE_LTF_2_X;\n\t\tbreak;\n\tcase 2:\n\t\the_gi = HE_GI_1_6;\n\t\the_ltf = HE_LTF_2_X;\n\t\tbreak;\n\tcase 3:\n\t\tif (he_dcm && he_stbc) {\n\t\t\the_gi = HE_GI_0_8;\n\t\t\the_ltf = HE_LTF_4_X;\n\t\t} else {\n\t\t\the_gi = HE_GI_3_2;\n\t\t\the_ltf = HE_LTF_4_X;\n\t\t}\n\t\tbreak;\n\t}\n\tppdu_info->gi = he_gi;\n\tvalue = he_gi << HE_GI_SHIFT;\n\tppdu_info->he_data5 |= value;\n\tvalue = he_ltf << HE_LTF_SIZE_SHIFT;\n\tppdu_info->ltf_size = he_ltf;\n\tppdu_info->he_data5 |= value;\n\n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_NSTS);\n\tvalue = (value << HE_LTF_SYM_SHIFT);\n\tppdu_info->he_data5 |= value;\n\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_PKT_EXT_FACTOR);\n\tvalue = value << HE_PRE_FEC_PAD_SHIFT;\n\tppdu_info->he_data5 |= value;\n\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_TXBF);\n\tvalue = value << HE_TXBF_SHIFT;\n\tppdu_info->he_data5 |= value;\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_PKT_EXT_PE_DISAM);\n\tvalue = value << HE_PE_DISAMBIGUITY_SHIFT;\n\tppdu_info->he_data5 |= value;\n\n\t \n\tvalue = u32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_NSTS);\n\tvalue++;\n\tppdu_info->he_data6 = value;\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_DOPPLER_IND);\n\tvalue = value << HE_DOPPLER_SHIFT;\n\tppdu_info->he_data6 |= value;\n\tvalue = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_TXOP_DURATION);\n\tvalue = value << HE_TXOP_SHIFT;\n\tppdu_info->he_data6 |= value;\n\n\tppdu_info->mcs =\n\t\tu32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_TRANSMIT_MCS);\n\tppdu_info->bw =\n\t\tu32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_TRANSMIT_BW);\n\tppdu_info->ldpc = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_CODING);\n\tppdu_info->is_stbc = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_STBC);\n\tppdu_info->beamformed = u32_get_bits(info1, HAL_RX_HE_SIG_A_SU_INFO_INFO1_TXBF);\n\tdcm = u32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_DCM);\n\tppdu_info->nss = u32_get_bits(info0, HAL_RX_HE_SIG_A_SU_INFO_INFO0_NSTS);\n\tppdu_info->dcm = dcm;\n\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_SU;\n}\n\nstatic enum hal_rx_mon_status\nath12k_dp_mon_rx_parse_status_tlv(struct ath12k_base *ab,\n\t\t\t\t  struct ath12k_mon_data *pmon,\n\t\t\t\t  u32 tlv_tag, u8 *tlv_data, u32 userid)\n{\n\tstruct hal_rx_mon_ppdu_info *ppdu_info = &pmon->mon_ppdu_info;\n\tu32 info[7];\n\n\tswitch (tlv_tag) {\n\tcase HAL_RX_PPDU_START: {\n\t\tstruct hal_rx_ppdu_start *ppdu_start =\n\t\t\t(struct hal_rx_ppdu_start *)tlv_data;\n\n\t\tinfo[0] = __le32_to_cpu(ppdu_start->info0);\n\n\t\tppdu_info->ppdu_id =\n\t\t\tu32_get_bits(info[0], HAL_RX_PPDU_START_INFO0_PPDU_ID);\n\t\tppdu_info->chan_num = __le32_to_cpu(ppdu_start->chan_num);\n\t\tppdu_info->ppdu_ts = __le32_to_cpu(ppdu_start->ppdu_start_ts);\n\n\t\tif (ppdu_info->ppdu_id != ppdu_info->last_ppdu_id) {\n\t\t\tppdu_info->last_ppdu_id = ppdu_info->ppdu_id;\n\t\t\tppdu_info->num_users = 0;\n\t\t\tmemset(&ppdu_info->mpdu_fcs_ok_bitmap, 0,\n\t\t\t       HAL_RX_NUM_WORDS_PER_PPDU_BITMAP *\n\t\t\t       sizeof(ppdu_info->mpdu_fcs_ok_bitmap[0]));\n\t\t}\n\t\tbreak;\n\t}\n\tcase HAL_RX_PPDU_END_USER_STATS: {\n\t\tstruct hal_rx_ppdu_end_user_stats *eu_stats =\n\t\t\t(struct hal_rx_ppdu_end_user_stats *)tlv_data;\n\n\t\tinfo[0] = __le32_to_cpu(eu_stats->info0);\n\t\tinfo[1] = __le32_to_cpu(eu_stats->info1);\n\t\tinfo[2] = __le32_to_cpu(eu_stats->info2);\n\t\tinfo[4] = __le32_to_cpu(eu_stats->info4);\n\t\tinfo[5] = __le32_to_cpu(eu_stats->info5);\n\t\tinfo[6] = __le32_to_cpu(eu_stats->info6);\n\n\t\tppdu_info->ast_index =\n\t\t\tu32_get_bits(info[2], HAL_RX_PPDU_END_USER_STATS_INFO2_AST_INDEX);\n\t\tppdu_info->fc_valid =\n\t\t\tu32_get_bits(info[1], HAL_RX_PPDU_END_USER_STATS_INFO1_FC_VALID);\n\t\tppdu_info->tid =\n\t\t\tffs(u32_get_bits(info[6],\n\t\t\t\t\t HAL_RX_PPDU_END_USER_STATS_INFO6_TID_BITMAP)\n\t\t\t\t\t - 1);\n\t\tppdu_info->tcp_msdu_count =\n\t\t\tu32_get_bits(info[4],\n\t\t\t\t     HAL_RX_PPDU_END_USER_STATS_INFO4_TCP_MSDU_CNT);\n\t\tppdu_info->udp_msdu_count =\n\t\t\tu32_get_bits(info[4],\n\t\t\t\t     HAL_RX_PPDU_END_USER_STATS_INFO4_UDP_MSDU_CNT);\n\t\tppdu_info->other_msdu_count =\n\t\t\tu32_get_bits(info[5],\n\t\t\t\t     HAL_RX_PPDU_END_USER_STATS_INFO5_OTHER_MSDU_CNT);\n\t\tppdu_info->tcp_ack_msdu_count =\n\t\t\tu32_get_bits(info[5],\n\t\t\t\t     HAL_RX_PPDU_END_USER_STATS_INFO5_TCP_ACK_MSDU_CNT);\n\t\tppdu_info->preamble_type =\n\t\t\tu32_get_bits(info[1],\n\t\t\t\t     HAL_RX_PPDU_END_USER_STATS_INFO1_PKT_TYPE);\n\t\tppdu_info->num_mpdu_fcs_ok =\n\t\t\tu32_get_bits(info[1],\n\t\t\t\t     HAL_RX_PPDU_END_USER_STATS_INFO1_MPDU_CNT_FCS_OK);\n\t\tppdu_info->num_mpdu_fcs_err =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_RX_PPDU_END_USER_STATS_INFO0_MPDU_CNT_FCS_ERR);\n\t\tswitch (ppdu_info->preamble_type) {\n\t\tcase HAL_RX_PREAMBLE_11N:\n\t\t\tppdu_info->ht_flags = 1;\n\t\t\tbreak;\n\t\tcase HAL_RX_PREAMBLE_11AC:\n\t\t\tppdu_info->vht_flags = 1;\n\t\t\tbreak;\n\t\tcase HAL_RX_PREAMBLE_11AX:\n\t\t\tppdu_info->he_flags = 1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tif (userid < HAL_MAX_UL_MU_USERS) {\n\t\t\tstruct hal_rx_user_status *rxuser_stats =\n\t\t\t\t&ppdu_info->userstats[userid];\n\t\t\tppdu_info->num_users += 1;\n\n\t\t\tath12k_dp_mon_rx_handle_ofdma_info(tlv_data, rxuser_stats);\n\t\t\tath12k_dp_mon_rx_populate_mu_user_info(tlv_data, ppdu_info,\n\t\t\t\t\t\t\t       rxuser_stats);\n\t\t}\n\t\tppdu_info->mpdu_fcs_ok_bitmap[0] = __le32_to_cpu(eu_stats->rsvd1[0]);\n\t\tppdu_info->mpdu_fcs_ok_bitmap[1] = __le32_to_cpu(eu_stats->rsvd1[1]);\n\t\tbreak;\n\t}\n\tcase HAL_RX_PPDU_END_USER_STATS_EXT: {\n\t\tstruct hal_rx_ppdu_end_user_stats_ext *eu_stats =\n\t\t\t(struct hal_rx_ppdu_end_user_stats_ext *)tlv_data;\n\t\tppdu_info->mpdu_fcs_ok_bitmap[2] = __le32_to_cpu(eu_stats->info1);\n\t\tppdu_info->mpdu_fcs_ok_bitmap[3] = __le32_to_cpu(eu_stats->info2);\n\t\tppdu_info->mpdu_fcs_ok_bitmap[4] = __le32_to_cpu(eu_stats->info3);\n\t\tppdu_info->mpdu_fcs_ok_bitmap[5] = __le32_to_cpu(eu_stats->info4);\n\t\tppdu_info->mpdu_fcs_ok_bitmap[6] = __le32_to_cpu(eu_stats->info5);\n\t\tppdu_info->mpdu_fcs_ok_bitmap[7] = __le32_to_cpu(eu_stats->info6);\n\t\tbreak;\n\t}\n\tcase HAL_PHYRX_HT_SIG:\n\t\tath12k_dp_mon_parse_ht_sig(tlv_data, ppdu_info);\n\t\tbreak;\n\n\tcase HAL_PHYRX_L_SIG_B:\n\t\tath12k_dp_mon_parse_l_sig_b(tlv_data, ppdu_info);\n\t\tbreak;\n\n\tcase HAL_PHYRX_L_SIG_A:\n\t\tath12k_dp_mon_parse_l_sig_a(tlv_data, ppdu_info);\n\t\tbreak;\n\n\tcase HAL_PHYRX_VHT_SIG_A:\n\t\tath12k_dp_mon_parse_vht_sig_a(tlv_data, ppdu_info);\n\t\tbreak;\n\n\tcase HAL_PHYRX_HE_SIG_A_SU:\n\t\tath12k_dp_mon_parse_he_sig_su(tlv_data, ppdu_info);\n\t\tbreak;\n\n\tcase HAL_PHYRX_HE_SIG_A_MU_DL:\n\t\tath12k_dp_mon_parse_he_sig_mu(tlv_data, ppdu_info);\n\t\tbreak;\n\n\tcase HAL_PHYRX_HE_SIG_B1_MU:\n\t\tath12k_dp_mon_parse_he_sig_b1_mu(tlv_data, ppdu_info);\n\t\tbreak;\n\n\tcase HAL_PHYRX_HE_SIG_B2_MU:\n\t\tath12k_dp_mon_parse_he_sig_b2_mu(tlv_data, ppdu_info);\n\t\tbreak;\n\n\tcase HAL_PHYRX_HE_SIG_B2_OFDMA:\n\t\tath12k_dp_mon_parse_he_sig_b2_ofdma(tlv_data, ppdu_info);\n\t\tbreak;\n\n\tcase HAL_PHYRX_RSSI_LEGACY: {\n\t\tstruct hal_rx_phyrx_rssi_legacy_info *rssi =\n\t\t\t(struct hal_rx_phyrx_rssi_legacy_info *)tlv_data;\n\t\tu32 reception_type = 0;\n\t\tu32 rssi_legacy_info = __le32_to_cpu(rssi->rsvd[0]);\n\n\t\tinfo[0] = __le32_to_cpu(rssi->info0);\n\n\t\t \n\t\tppdu_info->rssi_comb =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_RX_PHYRX_RSSI_LEGACY_INFO_INFO0_RSSI_COMB);\n\t\treception_type =\n\t\t\tu32_get_bits(rssi_legacy_info,\n\t\t\t\t     HAL_RX_PHYRX_RSSI_LEGACY_INFO_RSVD1_RECEPTION);\n\n\t\tswitch (reception_type) {\n\t\tcase HAL_RECEPTION_TYPE_ULOFMDA:\n\t\t\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_MU_OFDMA;\n\t\t\tbreak;\n\t\tcase HAL_RECEPTION_TYPE_ULMIMO:\n\t\t\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_MU_MIMO;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tppdu_info->reception_type = HAL_RX_RECEPTION_TYPE_SU;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\t}\n\tcase HAL_RXPCU_PPDU_END_INFO: {\n\t\tstruct hal_rx_ppdu_end_duration *ppdu_rx_duration =\n\t\t\t(struct hal_rx_ppdu_end_duration *)tlv_data;\n\n\t\tinfo[0] = __le32_to_cpu(ppdu_rx_duration->info0);\n\t\tppdu_info->rx_duration =\n\t\t\tu32_get_bits(info[0], HAL_RX_PPDU_END_DURATION);\n\t\tppdu_info->tsft = __le32_to_cpu(ppdu_rx_duration->rsvd0[1]);\n\t\tppdu_info->tsft = (ppdu_info->tsft << 32) |\n\t\t\t\t   __le32_to_cpu(ppdu_rx_duration->rsvd0[0]);\n\t\tbreak;\n\t}\n\tcase HAL_RX_MPDU_START: {\n\t\tstruct hal_rx_mpdu_start *mpdu_start =\n\t\t\t(struct hal_rx_mpdu_start *)tlv_data;\n\t\tstruct dp_mon_mpdu *mon_mpdu = pmon->mon_mpdu;\n\t\tu16 peer_id;\n\n\t\tinfo[1] = __le32_to_cpu(mpdu_start->info1);\n\t\tpeer_id = u32_get_bits(info[1], HAL_RX_MPDU_START_INFO1_PEERID);\n\t\tif (peer_id)\n\t\t\tppdu_info->peer_id = peer_id;\n\n\t\tppdu_info->mpdu_len += u32_get_bits(info[1],\n\t\t\t\t\t\t    HAL_RX_MPDU_START_INFO2_MPDU_LEN);\n\t\tif (userid < HAL_MAX_UL_MU_USERS) {\n\t\t\tinfo[0] = __le32_to_cpu(mpdu_start->info0);\n\t\t\tppdu_info->userid = userid;\n\t\t\tppdu_info->ampdu_id[userid] =\n\t\t\t\tu32_get_bits(info[0], HAL_RX_MPDU_START_INFO1_PEERID);\n\t\t}\n\n\t\tmon_mpdu = kzalloc(sizeof(*mon_mpdu), GFP_ATOMIC);\n\t\tif (!mon_mpdu)\n\t\t\treturn HAL_RX_MON_STATUS_PPDU_NOT_DONE;\n\n\t\tbreak;\n\t}\n\tcase HAL_RX_MSDU_START:\n\t\t \n\t\tbreak;\n\tcase HAL_MON_BUF_ADDR: {\n\t\tstruct dp_rxdma_ring *buf_ring = &ab->dp.rxdma_mon_buf_ring;\n\t\tstruct dp_mon_packet_info *packet_info =\n\t\t\t(struct dp_mon_packet_info *)tlv_data;\n\t\tint buf_id = u32_get_bits(packet_info->cookie,\n\t\t\t\t\t  DP_RXDMA_BUF_COOKIE_BUF_ID);\n\t\tstruct sk_buff *msdu;\n\t\tstruct dp_mon_mpdu *mon_mpdu = pmon->mon_mpdu;\n\t\tstruct ath12k_skb_rxcb *rxcb;\n\n\t\tspin_lock_bh(&buf_ring->idr_lock);\n\t\tmsdu = idr_remove(&buf_ring->bufs_idr, buf_id);\n\t\tspin_unlock_bh(&buf_ring->idr_lock);\n\n\t\tif (unlikely(!msdu)) {\n\t\t\tath12k_warn(ab, \"monitor destination with invalid buf_id %d\\n\",\n\t\t\t\t    buf_id);\n\t\t\treturn HAL_RX_MON_STATUS_PPDU_NOT_DONE;\n\t\t}\n\n\t\trxcb = ATH12K_SKB_RXCB(msdu);\n\t\tdma_unmap_single(ab->dev, rxcb->paddr,\n\t\t\t\t msdu->len + skb_tailroom(msdu),\n\t\t\t\t DMA_FROM_DEVICE);\n\n\t\tif (mon_mpdu->tail)\n\t\t\tmon_mpdu->tail->next = msdu;\n\t\telse\n\t\t\tmon_mpdu->tail = msdu;\n\n\t\tath12k_dp_mon_buf_replenish(ab, buf_ring, 1);\n\n\t\tbreak;\n\t}\n\tcase HAL_RX_MSDU_END: {\n\t\tstruct rx_msdu_end_qcn9274 *msdu_end =\n\t\t\t(struct rx_msdu_end_qcn9274 *)tlv_data;\n\t\tbool is_first_msdu_in_mpdu;\n\t\tu16 msdu_end_info;\n\n\t\tmsdu_end_info = __le16_to_cpu(msdu_end->info5);\n\t\tis_first_msdu_in_mpdu = u32_get_bits(msdu_end_info,\n\t\t\t\t\t\t     RX_MSDU_END_INFO5_FIRST_MSDU);\n\t\tif (is_first_msdu_in_mpdu) {\n\t\t\tpmon->mon_mpdu->head = pmon->mon_mpdu->tail;\n\t\t\tpmon->mon_mpdu->tail = NULL;\n\t\t}\n\t\tbreak;\n\t}\n\tcase HAL_RX_MPDU_END:\n\t\tlist_add_tail(&pmon->mon_mpdu->list, &pmon->dp_rx_mon_mpdu_list);\n\t\tbreak;\n\tcase HAL_DUMMY:\n\t\treturn HAL_RX_MON_STATUS_BUF_DONE;\n\tcase HAL_RX_PPDU_END_STATUS_DONE:\n\tcase 0:\n\t\treturn HAL_RX_MON_STATUS_PPDU_DONE;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn HAL_RX_MON_STATUS_PPDU_NOT_DONE;\n}\n\nstatic void ath12k_dp_mon_rx_msdus_set_payload(struct ath12k *ar, struct sk_buff *msdu)\n{\n\tu32 rx_pkt_offset, l2_hdr_offset;\n\n\trx_pkt_offset = ar->ab->hw_params->hal_desc_sz;\n\tl2_hdr_offset = ath12k_dp_rx_h_l3pad(ar->ab,\n\t\t\t\t\t     (struct hal_rx_desc *)msdu->data);\n\tskb_pull(msdu, rx_pkt_offset + l2_hdr_offset);\n}\n\nstatic struct sk_buff *\nath12k_dp_mon_rx_merg_msdus(struct ath12k *ar,\n\t\t\t    u32 mac_id, struct sk_buff *head_msdu,\n\t\t\t    struct ieee80211_rx_status *rxs, bool *fcs_err)\n{\n\tstruct ath12k_base *ab = ar->ab;\n\tstruct sk_buff *msdu, *mpdu_buf, *prev_buf;\n\tstruct hal_rx_desc *rx_desc;\n\tu8 *hdr_desc, *dest, decap_format;\n\tstruct ieee80211_hdr_3addr *wh;\n\tu32 err_bitmap;\n\n\tmpdu_buf = NULL;\n\n\tif (!head_msdu)\n\t\tgoto err_merge_fail;\n\n\trx_desc = (struct hal_rx_desc *)head_msdu->data;\n\terr_bitmap = ath12k_dp_rx_h_mpdu_err(ab, rx_desc);\n\n\tif (err_bitmap & HAL_RX_MPDU_ERR_FCS)\n\t\t*fcs_err = true;\n\n\tdecap_format = ath12k_dp_rx_h_decap_type(ab, rx_desc);\n\n\tath12k_dp_rx_h_ppdu(ar, rx_desc, rxs);\n\n\tif (decap_format == DP_RX_DECAP_TYPE_RAW) {\n\t\tath12k_dp_mon_rx_msdus_set_payload(ar, head_msdu);\n\n\t\tprev_buf = head_msdu;\n\t\tmsdu = head_msdu->next;\n\n\t\twhile (msdu) {\n\t\t\tath12k_dp_mon_rx_msdus_set_payload(ar, msdu);\n\n\t\t\tprev_buf = msdu;\n\t\t\tmsdu = msdu->next;\n\t\t}\n\n\t\tprev_buf->next = NULL;\n\n\t\tskb_trim(prev_buf, prev_buf->len - HAL_RX_FCS_LEN);\n\t} else if (decap_format == DP_RX_DECAP_TYPE_NATIVE_WIFI) {\n\t\tu8 qos_pkt = 0;\n\n\t\trx_desc = (struct hal_rx_desc *)head_msdu->data;\n\t\thdr_desc = ab->hw_params->hal_ops->rx_desc_get_msdu_payload(rx_desc);\n\n\t\t \n\t\twh = (struct ieee80211_hdr_3addr *)hdr_desc;\n\n\t\tif (ieee80211_is_data_qos(wh->frame_control))\n\t\t\tqos_pkt = 1;\n\n\t\tmsdu = head_msdu;\n\n\t\twhile (msdu) {\n\t\t\tath12k_dp_mon_rx_msdus_set_payload(ar, msdu);\n\t\t\tif (qos_pkt) {\n\t\t\t\tdest = skb_push(msdu, sizeof(__le16));\n\t\t\t\tif (!dest)\n\t\t\t\t\tgoto err_merge_fail;\n\t\t\t\tmemcpy(dest, hdr_desc, sizeof(struct ieee80211_qos_hdr));\n\t\t\t}\n\t\t\tprev_buf = msdu;\n\t\t\tmsdu = msdu->next;\n\t\t}\n\t\tdest = skb_put(prev_buf, HAL_RX_FCS_LEN);\n\t\tif (!dest)\n\t\t\tgoto err_merge_fail;\n\n\t\tath12k_dbg(ab, ATH12K_DBG_DATA,\n\t\t\t   \"mpdu_buf %pK mpdu_buf->len %u\",\n\t\t\t   prev_buf, prev_buf->len);\n\t} else {\n\t\tath12k_dbg(ab, ATH12K_DBG_DATA,\n\t\t\t   \"decap format %d is not supported!\\n\",\n\t\t\t   decap_format);\n\t\tgoto err_merge_fail;\n\t}\n\n\treturn head_msdu;\n\nerr_merge_fail:\n\tif (mpdu_buf && decap_format != DP_RX_DECAP_TYPE_RAW) {\n\t\tath12k_dbg(ab, ATH12K_DBG_DATA,\n\t\t\t   \"err_merge_fail mpdu_buf %pK\", mpdu_buf);\n\t\t \n\t\tdev_kfree_skb_any(mpdu_buf);\n\t}\n\treturn NULL;\n}\n\nstatic void\nath12k_dp_mon_rx_update_radiotap_he(struct hal_rx_mon_ppdu_info *rx_status,\n\t\t\t\t    u8 *rtap_buf)\n{\n\tu32 rtap_len = 0;\n\n\tput_unaligned_le16(rx_status->he_data1, &rtap_buf[rtap_len]);\n\trtap_len += 2;\n\n\tput_unaligned_le16(rx_status->he_data2, &rtap_buf[rtap_len]);\n\trtap_len += 2;\n\n\tput_unaligned_le16(rx_status->he_data3, &rtap_buf[rtap_len]);\n\trtap_len += 2;\n\n\tput_unaligned_le16(rx_status->he_data4, &rtap_buf[rtap_len]);\n\trtap_len += 2;\n\n\tput_unaligned_le16(rx_status->he_data5, &rtap_buf[rtap_len]);\n\trtap_len += 2;\n\n\tput_unaligned_le16(rx_status->he_data6, &rtap_buf[rtap_len]);\n}\n\nstatic void\nath12k_dp_mon_rx_update_radiotap_he_mu(struct hal_rx_mon_ppdu_info *rx_status,\n\t\t\t\t       u8 *rtap_buf)\n{\n\tu32 rtap_len = 0;\n\n\tput_unaligned_le16(rx_status->he_flags1, &rtap_buf[rtap_len]);\n\trtap_len += 2;\n\n\tput_unaligned_le16(rx_status->he_flags2, &rtap_buf[rtap_len]);\n\trtap_len += 2;\n\n\trtap_buf[rtap_len] = rx_status->he_RU[0];\n\trtap_len += 1;\n\n\trtap_buf[rtap_len] = rx_status->he_RU[1];\n\trtap_len += 1;\n\n\trtap_buf[rtap_len] = rx_status->he_RU[2];\n\trtap_len += 1;\n\n\trtap_buf[rtap_len] = rx_status->he_RU[3];\n}\n\nstatic void ath12k_dp_mon_update_radiotap(struct ath12k *ar,\n\t\t\t\t\t  struct hal_rx_mon_ppdu_info *ppduinfo,\n\t\t\t\t\t  struct sk_buff *mon_skb,\n\t\t\t\t\t  struct ieee80211_rx_status *rxs)\n{\n\tstruct ieee80211_supported_band *sband;\n\tu8 *ptr = NULL;\n\tu16 ampdu_id = ppduinfo->ampdu_id[ppduinfo->userid];\n\n\trxs->flag |= RX_FLAG_MACTIME_START;\n\trxs->signal = ppduinfo->rssi_comb + ATH12K_DEFAULT_NOISE_FLOOR;\n\trxs->nss = ppduinfo->nss + 1;\n\n\tif (ampdu_id) {\n\t\trxs->flag |= RX_FLAG_AMPDU_DETAILS;\n\t\trxs->ampdu_reference = ampdu_id;\n\t}\n\n\tif (ppduinfo->he_mu_flags) {\n\t\trxs->flag |= RX_FLAG_RADIOTAP_HE_MU;\n\t\trxs->encoding = RX_ENC_HE;\n\t\tptr = skb_push(mon_skb, sizeof(struct ieee80211_radiotap_he_mu));\n\t\tath12k_dp_mon_rx_update_radiotap_he_mu(ppduinfo, ptr);\n\t} else if (ppduinfo->he_flags) {\n\t\trxs->flag |= RX_FLAG_RADIOTAP_HE;\n\t\trxs->encoding = RX_ENC_HE;\n\t\tptr = skb_push(mon_skb, sizeof(struct ieee80211_radiotap_he));\n\t\tath12k_dp_mon_rx_update_radiotap_he(ppduinfo, ptr);\n\t\trxs->rate_idx = ppduinfo->rate;\n\t} else if (ppduinfo->vht_flags) {\n\t\trxs->encoding = RX_ENC_VHT;\n\t\trxs->rate_idx = ppduinfo->rate;\n\t} else if (ppduinfo->ht_flags) {\n\t\trxs->encoding = RX_ENC_HT;\n\t\trxs->rate_idx = ppduinfo->rate;\n\t} else {\n\t\trxs->encoding = RX_ENC_LEGACY;\n\t\tsband = &ar->mac.sbands[rxs->band];\n\t\trxs->rate_idx = ath12k_mac_hw_rate_to_idx(sband, ppduinfo->rate,\n\t\t\t\t\t\t\t  ppduinfo->cck_flag);\n\t}\n\n\trxs->mactime = ppduinfo->tsft;\n}\n\nstatic void ath12k_dp_mon_rx_deliver_msdu(struct ath12k *ar, struct napi_struct *napi,\n\t\t\t\t\t  struct sk_buff *msdu,\n\t\t\t\t\t  struct ieee80211_rx_status *status)\n{\n\tstatic const struct ieee80211_radiotap_he known = {\n\t\t.data1 = cpu_to_le16(IEEE80211_RADIOTAP_HE_DATA1_DATA_MCS_KNOWN |\n\t\t\t\t     IEEE80211_RADIOTAP_HE_DATA1_BW_RU_ALLOC_KNOWN),\n\t\t.data2 = cpu_to_le16(IEEE80211_RADIOTAP_HE_DATA2_GI_KNOWN),\n\t};\n\tstruct ieee80211_rx_status *rx_status;\n\tstruct ieee80211_radiotap_he *he = NULL;\n\tstruct ieee80211_sta *pubsta = NULL;\n\tstruct ath12k_peer *peer;\n\tstruct ath12k_skb_rxcb *rxcb = ATH12K_SKB_RXCB(msdu);\n\tu8 decap = DP_RX_DECAP_TYPE_RAW;\n\tbool is_mcbc = rxcb->is_mcbc;\n\tbool is_eapol_tkip = rxcb->is_eapol;\n\n\tif ((status->encoding == RX_ENC_HE) && !(status->flag & RX_FLAG_RADIOTAP_HE) &&\n\t    !(status->flag & RX_FLAG_SKIP_MONITOR)) {\n\t\the = skb_push(msdu, sizeof(known));\n\t\tmemcpy(he, &known, sizeof(known));\n\t\tstatus->flag |= RX_FLAG_RADIOTAP_HE;\n\t}\n\n\tif (!(status->flag & RX_FLAG_ONLY_MONITOR))\n\t\tdecap = ath12k_dp_rx_h_decap_type(ar->ab, rxcb->rx_desc);\n\tspin_lock_bh(&ar->ab->base_lock);\n\tpeer = ath12k_dp_rx_h_find_peer(ar->ab, msdu);\n\tif (peer && peer->sta)\n\t\tpubsta = peer->sta;\n\tspin_unlock_bh(&ar->ab->base_lock);\n\n\tath12k_dbg(ar->ab, ATH12K_DBG_DATA,\n\t\t   \"rx skb %pK len %u peer %pM %u %s %s%s%s%s%s%s%s %srate_idx %u vht_nss %u freq %u band %u flag 0x%x fcs-err %i mic-err %i amsdu-more %i\\n\",\n\t\t   msdu,\n\t\t   msdu->len,\n\t\t   peer ? peer->addr : NULL,\n\t\t   rxcb->tid,\n\t\t   (is_mcbc) ? \"mcast\" : \"ucast\",\n\t\t   (status->encoding == RX_ENC_LEGACY) ? \"legacy\" : \"\",\n\t\t   (status->encoding == RX_ENC_HT) ? \"ht\" : \"\",\n\t\t   (status->encoding == RX_ENC_VHT) ? \"vht\" : \"\",\n\t\t   (status->encoding == RX_ENC_HE) ? \"he\" : \"\",\n\t\t   (status->bw == RATE_INFO_BW_40) ? \"40\" : \"\",\n\t\t   (status->bw == RATE_INFO_BW_80) ? \"80\" : \"\",\n\t\t   (status->bw == RATE_INFO_BW_160) ? \"160\" : \"\",\n\t\t   status->enc_flags & RX_ENC_FLAG_SHORT_GI ? \"sgi \" : \"\",\n\t\t   status->rate_idx,\n\t\t   status->nss,\n\t\t   status->freq,\n\t\t   status->band, status->flag,\n\t\t   !!(status->flag & RX_FLAG_FAILED_FCS_CRC),\n\t\t   !!(status->flag & RX_FLAG_MMIC_ERROR),\n\t\t   !!(status->flag & RX_FLAG_AMSDU_MORE));\n\n\tath12k_dbg_dump(ar->ab, ATH12K_DBG_DP_RX, NULL, \"dp rx msdu: \",\n\t\t\tmsdu->data, msdu->len);\n\trx_status = IEEE80211_SKB_RXCB(msdu);\n\t*rx_status = *status;\n\n\t \n\n\t \n\tif (decap == DP_RX_DECAP_TYPE_ETHERNET2_DIX && !is_eapol_tkip &&\n\t    !(is_mcbc && rx_status->flag & RX_FLAG_DECRYPTED))\n\t\trx_status->flag |= RX_FLAG_8023;\n\n\tieee80211_rx_napi(ar->hw, pubsta, msdu, napi);\n}\n\nstatic int ath12k_dp_mon_rx_deliver(struct ath12k *ar, u32 mac_id,\n\t\t\t\t    struct sk_buff *head_msdu,\n\t\t\t\t    struct hal_rx_mon_ppdu_info *ppduinfo,\n\t\t\t\t    struct napi_struct *napi)\n{\n\tstruct ath12k_pdev_dp *dp = &ar->dp;\n\tstruct sk_buff *mon_skb, *skb_next, *header;\n\tstruct ieee80211_rx_status *rxs = &dp->rx_status;\n\tbool fcs_err = false;\n\n\tmon_skb = ath12k_dp_mon_rx_merg_msdus(ar, mac_id, head_msdu,\n\t\t\t\t\t      rxs, &fcs_err);\n\tif (!mon_skb)\n\t\tgoto mon_deliver_fail;\n\n\theader = mon_skb;\n\trxs->flag = 0;\n\n\tif (fcs_err)\n\t\trxs->flag = RX_FLAG_FAILED_FCS_CRC;\n\n\tdo {\n\t\tskb_next = mon_skb->next;\n\t\tif (!skb_next)\n\t\t\trxs->flag &= ~RX_FLAG_AMSDU_MORE;\n\t\telse\n\t\t\trxs->flag |= RX_FLAG_AMSDU_MORE;\n\n\t\tif (mon_skb == header) {\n\t\t\theader = NULL;\n\t\t\trxs->flag &= ~RX_FLAG_ALLOW_SAME_PN;\n\t\t} else {\n\t\t\trxs->flag |= RX_FLAG_ALLOW_SAME_PN;\n\t\t}\n\t\trxs->flag |= RX_FLAG_ONLY_MONITOR;\n\t\tath12k_dp_mon_update_radiotap(ar, ppduinfo, mon_skb, rxs);\n\t\tath12k_dp_mon_rx_deliver_msdu(ar, napi, mon_skb, rxs);\n\t\tmon_skb = skb_next;\n\t} while (mon_skb);\n\trxs->flag = 0;\n\n\treturn 0;\n\nmon_deliver_fail:\n\tmon_skb = head_msdu;\n\twhile (mon_skb) {\n\t\tskb_next = mon_skb->next;\n\t\tdev_kfree_skb_any(mon_skb);\n\t\tmon_skb = skb_next;\n\t}\n\treturn -EINVAL;\n}\n\nstatic enum hal_rx_mon_status\nath12k_dp_mon_parse_rx_dest(struct ath12k_base *ab, struct ath12k_mon_data *pmon,\n\t\t\t    struct sk_buff *skb)\n{\n\tstruct hal_rx_mon_ppdu_info *ppdu_info = &pmon->mon_ppdu_info;\n\tstruct hal_tlv_hdr *tlv;\n\tenum hal_rx_mon_status hal_status;\n\tu32 tlv_userid = 0;\n\tu16 tlv_tag, tlv_len;\n\tu8 *ptr = skb->data;\n\n\tmemset(ppdu_info, 0, sizeof(struct hal_rx_mon_ppdu_info));\n\n\tdo {\n\t\ttlv = (struct hal_tlv_hdr *)ptr;\n\t\ttlv_tag = le32_get_bits(tlv->tl, HAL_TLV_HDR_TAG);\n\t\ttlv_len = le32_get_bits(tlv->tl, HAL_TLV_HDR_LEN);\n\t\ttlv_userid = le32_get_bits(tlv->tl, HAL_TLV_USR_ID);\n\t\tptr += sizeof(*tlv);\n\n\t\t \n\n\t\tif (tlv_tag == HAL_RX_PPDU_END)\n\t\t\ttlv_len = sizeof(struct hal_rx_rxpcu_classification_overview);\n\n\t\thal_status = ath12k_dp_mon_rx_parse_status_tlv(ab, pmon,\n\t\t\t\t\t\t\t       tlv_tag, ptr, tlv_userid);\n\t\tptr += tlv_len;\n\t\tptr = PTR_ALIGN(ptr, HAL_TLV_ALIGN);\n\n\t\tif ((ptr - skb->data) >= DP_RX_BUFFER_SIZE)\n\t\t\tbreak;\n\n\t} while (hal_status == HAL_RX_MON_STATUS_PPDU_NOT_DONE);\n\n\treturn hal_status;\n}\n\nenum hal_rx_mon_status\nath12k_dp_mon_rx_parse_mon_status(struct ath12k *ar,\n\t\t\t\t  struct ath12k_mon_data *pmon,\n\t\t\t\t  int mac_id,\n\t\t\t\t  struct sk_buff *skb,\n\t\t\t\t  struct napi_struct *napi)\n{\n\tstruct ath12k_base *ab = ar->ab;\n\tstruct hal_rx_mon_ppdu_info *ppdu_info = &pmon->mon_ppdu_info;\n\tstruct dp_mon_mpdu *tmp;\n\tstruct dp_mon_mpdu *mon_mpdu = pmon->mon_mpdu;\n\tstruct sk_buff *head_msdu, *tail_msdu;\n\tenum hal_rx_mon_status hal_status = HAL_RX_MON_STATUS_BUF_DONE;\n\n\tath12k_dp_mon_parse_rx_dest(ab, pmon, skb);\n\n\tlist_for_each_entry_safe(mon_mpdu, tmp, &pmon->dp_rx_mon_mpdu_list, list) {\n\t\tlist_del(&mon_mpdu->list);\n\t\thead_msdu = mon_mpdu->head;\n\t\ttail_msdu = mon_mpdu->tail;\n\n\t\tif (head_msdu && tail_msdu) {\n\t\t\tath12k_dp_mon_rx_deliver(ar, mac_id, head_msdu,\n\t\t\t\t\t\t ppdu_info, napi);\n\t\t}\n\n\t\tkfree(mon_mpdu);\n\t}\n\treturn hal_status;\n}\n\nint ath12k_dp_mon_buf_replenish(struct ath12k_base *ab,\n\t\t\t\tstruct dp_rxdma_ring *buf_ring,\n\t\t\t\tint req_entries)\n{\n\tstruct hal_mon_buf_ring *mon_buf;\n\tstruct sk_buff *skb;\n\tstruct hal_srng *srng;\n\tdma_addr_t paddr;\n\tu32 cookie;\n\tint buf_id;\n\n\tsrng = &ab->hal.srng_list[buf_ring->refill_buf_ring.ring_id];\n\tspin_lock_bh(&srng->lock);\n\tath12k_hal_srng_access_begin(ab, srng);\n\n\twhile (req_entries > 0) {\n\t\tskb = dev_alloc_skb(DP_RX_BUFFER_SIZE + DP_RX_BUFFER_ALIGN_SIZE);\n\t\tif (unlikely(!skb))\n\t\t\tgoto fail_alloc_skb;\n\n\t\tif (!IS_ALIGNED((unsigned long)skb->data, DP_RX_BUFFER_ALIGN_SIZE)) {\n\t\t\tskb_pull(skb,\n\t\t\t\t PTR_ALIGN(skb->data, DP_RX_BUFFER_ALIGN_SIZE) -\n\t\t\t\t skb->data);\n\t\t}\n\n\t\tpaddr = dma_map_single(ab->dev, skb->data,\n\t\t\t\t       skb->len + skb_tailroom(skb),\n\t\t\t\t       DMA_FROM_DEVICE);\n\n\t\tif (unlikely(dma_mapping_error(ab->dev, paddr)))\n\t\t\tgoto fail_free_skb;\n\n\t\tspin_lock_bh(&buf_ring->idr_lock);\n\t\tbuf_id = idr_alloc(&buf_ring->bufs_idr, skb, 0,\n\t\t\t\t   buf_ring->bufs_max * 3, GFP_ATOMIC);\n\t\tspin_unlock_bh(&buf_ring->idr_lock);\n\n\t\tif (unlikely(buf_id < 0))\n\t\t\tgoto fail_dma_unmap;\n\n\t\tmon_buf = ath12k_hal_srng_src_get_next_entry(ab, srng);\n\t\tif (unlikely(!mon_buf))\n\t\t\tgoto fail_idr_remove;\n\n\t\tATH12K_SKB_RXCB(skb)->paddr = paddr;\n\n\t\tcookie = u32_encode_bits(buf_id, DP_RXDMA_BUF_COOKIE_BUF_ID);\n\n\t\tmon_buf->paddr_lo = cpu_to_le32(lower_32_bits(paddr));\n\t\tmon_buf->paddr_hi = cpu_to_le32(upper_32_bits(paddr));\n\t\tmon_buf->cookie = cpu_to_le64(cookie);\n\n\t\treq_entries--;\n\t}\n\n\tath12k_hal_srng_access_end(ab, srng);\n\tspin_unlock_bh(&srng->lock);\n\treturn 0;\n\nfail_idr_remove:\n\tspin_lock_bh(&buf_ring->idr_lock);\n\tidr_remove(&buf_ring->bufs_idr, buf_id);\n\tspin_unlock_bh(&buf_ring->idr_lock);\nfail_dma_unmap:\n\tdma_unmap_single(ab->dev, paddr, skb->len + skb_tailroom(skb),\n\t\t\t DMA_FROM_DEVICE);\nfail_free_skb:\n\tdev_kfree_skb_any(skb);\nfail_alloc_skb:\n\tath12k_hal_srng_access_end(ab, srng);\n\tspin_unlock_bh(&srng->lock);\n\treturn -ENOMEM;\n}\n\nstatic struct dp_mon_tx_ppdu_info *\nath12k_dp_mon_tx_get_ppdu_info(struct ath12k_mon_data *pmon,\n\t\t\t       unsigned int ppdu_id,\n\t\t\t       enum dp_mon_tx_ppdu_info_type type)\n{\n\tstruct dp_mon_tx_ppdu_info *tx_ppdu_info;\n\n\tif (type == DP_MON_TX_PROT_PPDU_INFO) {\n\t\ttx_ppdu_info = pmon->tx_prot_ppdu_info;\n\n\t\tif (tx_ppdu_info && !tx_ppdu_info->is_used)\n\t\t\treturn tx_ppdu_info;\n\t\tkfree(tx_ppdu_info);\n\t} else {\n\t\ttx_ppdu_info = pmon->tx_data_ppdu_info;\n\n\t\tif (tx_ppdu_info && !tx_ppdu_info->is_used)\n\t\t\treturn tx_ppdu_info;\n\t\tkfree(tx_ppdu_info);\n\t}\n\n\t \n\ttx_ppdu_info = kzalloc(sizeof(*tx_ppdu_info), GFP_ATOMIC);\n\tif (!tx_ppdu_info)\n\t\treturn NULL;\n\n\ttx_ppdu_info->is_used = 0;\n\ttx_ppdu_info->ppdu_id = ppdu_id;\n\n\tif (type == DP_MON_TX_PROT_PPDU_INFO)\n\t\tpmon->tx_prot_ppdu_info = tx_ppdu_info;\n\telse\n\t\tpmon->tx_data_ppdu_info = tx_ppdu_info;\n\n\treturn tx_ppdu_info;\n}\n\nstatic struct dp_mon_tx_ppdu_info *\nath12k_dp_mon_hal_tx_ppdu_info(struct ath12k_mon_data *pmon,\n\t\t\t       u16 tlv_tag)\n{\n\tswitch (tlv_tag) {\n\tcase HAL_TX_FES_SETUP:\n\tcase HAL_TX_FLUSH:\n\tcase HAL_PCU_PPDU_SETUP_INIT:\n\tcase HAL_TX_PEER_ENTRY:\n\tcase HAL_TX_QUEUE_EXTENSION:\n\tcase HAL_TX_MPDU_START:\n\tcase HAL_TX_MSDU_START:\n\tcase HAL_TX_DATA:\n\tcase HAL_MON_BUF_ADDR:\n\tcase HAL_TX_MPDU_END:\n\tcase HAL_TX_LAST_MPDU_FETCHED:\n\tcase HAL_TX_LAST_MPDU_END:\n\tcase HAL_COEX_TX_REQ:\n\tcase HAL_TX_RAW_OR_NATIVE_FRAME_SETUP:\n\tcase HAL_SCH_CRITICAL_TLV_REFERENCE:\n\tcase HAL_TX_FES_SETUP_COMPLETE:\n\tcase HAL_TQM_MPDU_GLOBAL_START:\n\tcase HAL_SCHEDULER_END:\n\tcase HAL_TX_FES_STATUS_USER_PPDU:\n\t\tbreak;\n\tcase HAL_TX_FES_STATUS_PROT: {\n\t\tif (!pmon->tx_prot_ppdu_info->is_used)\n\t\t\tpmon->tx_prot_ppdu_info->is_used = true;\n\n\t\treturn pmon->tx_prot_ppdu_info;\n\t}\n\t}\n\n\tif (!pmon->tx_data_ppdu_info->is_used)\n\t\tpmon->tx_data_ppdu_info->is_used = true;\n\n\treturn pmon->tx_data_ppdu_info;\n}\n\n#define MAX_MONITOR_HEADER 512\n#define MAX_DUMMY_FRM_BODY 128\n\nstruct sk_buff *ath12k_dp_mon_tx_alloc_skb(void)\n{\n\tstruct sk_buff *skb;\n\n\tskb = dev_alloc_skb(MAX_MONITOR_HEADER + MAX_DUMMY_FRM_BODY);\n\tif (!skb)\n\t\treturn NULL;\n\n\tskb_reserve(skb, MAX_MONITOR_HEADER);\n\n\tif (!IS_ALIGNED((unsigned long)skb->data, 4))\n\t\tskb_pull(skb, PTR_ALIGN(skb->data, 4) - skb->data);\n\n\treturn skb;\n}\n\nstatic int\nath12k_dp_mon_tx_gen_cts2self_frame(struct dp_mon_tx_ppdu_info *tx_ppdu_info)\n{\n\tstruct sk_buff *skb;\n\tstruct ieee80211_cts *cts;\n\n\tskb = ath12k_dp_mon_tx_alloc_skb();\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tcts = (struct ieee80211_cts *)skb->data;\n\tmemset(cts, 0, MAX_DUMMY_FRM_BODY);\n\tcts->frame_control =\n\t\tcpu_to_le16(IEEE80211_FTYPE_CTL | IEEE80211_STYPE_CTS);\n\tcts->duration = cpu_to_le16(tx_ppdu_info->rx_status.rx_duration);\n\tmemcpy(cts->ra, tx_ppdu_info->rx_status.addr1, sizeof(cts->ra));\n\n\tskb_put(skb, sizeof(*cts));\n\ttx_ppdu_info->tx_mon_mpdu->head = skb;\n\ttx_ppdu_info->tx_mon_mpdu->tail = NULL;\n\tlist_add_tail(&tx_ppdu_info->tx_mon_mpdu->list,\n\t\t      &tx_ppdu_info->dp_tx_mon_mpdu_list);\n\n\treturn 0;\n}\n\nstatic int\nath12k_dp_mon_tx_gen_rts_frame(struct dp_mon_tx_ppdu_info *tx_ppdu_info)\n{\n\tstruct sk_buff *skb;\n\tstruct ieee80211_rts *rts;\n\n\tskb = ath12k_dp_mon_tx_alloc_skb();\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\trts = (struct ieee80211_rts *)skb->data;\n\tmemset(rts, 0, MAX_DUMMY_FRM_BODY);\n\trts->frame_control =\n\t\tcpu_to_le16(IEEE80211_FTYPE_CTL | IEEE80211_STYPE_RTS);\n\trts->duration = cpu_to_le16(tx_ppdu_info->rx_status.rx_duration);\n\tmemcpy(rts->ra, tx_ppdu_info->rx_status.addr1, sizeof(rts->ra));\n\tmemcpy(rts->ta, tx_ppdu_info->rx_status.addr2, sizeof(rts->ta));\n\n\tskb_put(skb, sizeof(*rts));\n\ttx_ppdu_info->tx_mon_mpdu->head = skb;\n\ttx_ppdu_info->tx_mon_mpdu->tail = NULL;\n\tlist_add_tail(&tx_ppdu_info->tx_mon_mpdu->list,\n\t\t      &tx_ppdu_info->dp_tx_mon_mpdu_list);\n\n\treturn 0;\n}\n\nstatic int\nath12k_dp_mon_tx_gen_3addr_qos_null_frame(struct dp_mon_tx_ppdu_info *tx_ppdu_info)\n{\n\tstruct sk_buff *skb;\n\tstruct ieee80211_qos_hdr *qhdr;\n\n\tskb = ath12k_dp_mon_tx_alloc_skb();\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tqhdr = (struct ieee80211_qos_hdr *)skb->data;\n\tmemset(qhdr, 0, MAX_DUMMY_FRM_BODY);\n\tqhdr->frame_control =\n\t\tcpu_to_le16(IEEE80211_FTYPE_DATA | IEEE80211_STYPE_QOS_NULLFUNC);\n\tqhdr->duration_id = cpu_to_le16(tx_ppdu_info->rx_status.rx_duration);\n\tmemcpy(qhdr->addr1, tx_ppdu_info->rx_status.addr1, ETH_ALEN);\n\tmemcpy(qhdr->addr2, tx_ppdu_info->rx_status.addr2, ETH_ALEN);\n\tmemcpy(qhdr->addr3, tx_ppdu_info->rx_status.addr3, ETH_ALEN);\n\n\tskb_put(skb, sizeof(*qhdr));\n\ttx_ppdu_info->tx_mon_mpdu->head = skb;\n\ttx_ppdu_info->tx_mon_mpdu->tail = NULL;\n\tlist_add_tail(&tx_ppdu_info->tx_mon_mpdu->list,\n\t\t      &tx_ppdu_info->dp_tx_mon_mpdu_list);\n\n\treturn 0;\n}\n\nstatic int\nath12k_dp_mon_tx_gen_4addr_qos_null_frame(struct dp_mon_tx_ppdu_info *tx_ppdu_info)\n{\n\tstruct sk_buff *skb;\n\tstruct dp_mon_qosframe_addr4 *qhdr;\n\n\tskb = ath12k_dp_mon_tx_alloc_skb();\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tqhdr = (struct dp_mon_qosframe_addr4 *)skb->data;\n\tmemset(qhdr, 0, MAX_DUMMY_FRM_BODY);\n\tqhdr->frame_control =\n\t\tcpu_to_le16(IEEE80211_FTYPE_DATA | IEEE80211_STYPE_QOS_NULLFUNC);\n\tqhdr->duration = cpu_to_le16(tx_ppdu_info->rx_status.rx_duration);\n\tmemcpy(qhdr->addr1, tx_ppdu_info->rx_status.addr1, ETH_ALEN);\n\tmemcpy(qhdr->addr2, tx_ppdu_info->rx_status.addr2, ETH_ALEN);\n\tmemcpy(qhdr->addr3, tx_ppdu_info->rx_status.addr3, ETH_ALEN);\n\tmemcpy(qhdr->addr4, tx_ppdu_info->rx_status.addr4, ETH_ALEN);\n\n\tskb_put(skb, sizeof(*qhdr));\n\ttx_ppdu_info->tx_mon_mpdu->head = skb;\n\ttx_ppdu_info->tx_mon_mpdu->tail = NULL;\n\tlist_add_tail(&tx_ppdu_info->tx_mon_mpdu->list,\n\t\t      &tx_ppdu_info->dp_tx_mon_mpdu_list);\n\n\treturn 0;\n}\n\nstatic int\nath12k_dp_mon_tx_gen_ack_frame(struct dp_mon_tx_ppdu_info *tx_ppdu_info)\n{\n\tstruct sk_buff *skb;\n\tstruct dp_mon_frame_min_one *fbmhdr;\n\n\tskb = ath12k_dp_mon_tx_alloc_skb();\n\tif (!skb)\n\t\treturn -ENOMEM;\n\n\tfbmhdr = (struct dp_mon_frame_min_one *)skb->data;\n\tmemset(fbmhdr, 0, MAX_DUMMY_FRM_BODY);\n\tfbmhdr->frame_control =\n\t\tcpu_to_le16(IEEE80211_FTYPE_DATA | IEEE80211_STYPE_QOS_CFACK);\n\tmemcpy(fbmhdr->addr1, tx_ppdu_info->rx_status.addr1, ETH_ALEN);\n\n\t \n\tfbmhdr->duration = 0;\n\n\tskb_put(skb, sizeof(*fbmhdr));\n\ttx_ppdu_info->tx_mon_mpdu->head = skb;\n\ttx_ppdu_info->tx_mon_mpdu->tail = NULL;\n\tlist_add_tail(&tx_ppdu_info->tx_mon_mpdu->list,\n\t\t      &tx_ppdu_info->dp_tx_mon_mpdu_list);\n\n\treturn 0;\n}\n\nstatic int\nath12k_dp_mon_tx_gen_prot_frame(struct dp_mon_tx_ppdu_info *tx_ppdu_info)\n{\n\tint ret = 0;\n\n\tswitch (tx_ppdu_info->rx_status.medium_prot_type) {\n\tcase DP_MON_TX_MEDIUM_RTS_LEGACY:\n\tcase DP_MON_TX_MEDIUM_RTS_11AC_STATIC_BW:\n\tcase DP_MON_TX_MEDIUM_RTS_11AC_DYNAMIC_BW:\n\t\tret = ath12k_dp_mon_tx_gen_rts_frame(tx_ppdu_info);\n\t\tbreak;\n\tcase DP_MON_TX_MEDIUM_CTS2SELF:\n\t\tret = ath12k_dp_mon_tx_gen_cts2self_frame(tx_ppdu_info);\n\t\tbreak;\n\tcase DP_MON_TX_MEDIUM_QOS_NULL_NO_ACK_3ADDR:\n\t\tret = ath12k_dp_mon_tx_gen_3addr_qos_null_frame(tx_ppdu_info);\n\t\tbreak;\n\tcase DP_MON_TX_MEDIUM_QOS_NULL_NO_ACK_4ADDR:\n\t\tret = ath12k_dp_mon_tx_gen_4addr_qos_null_frame(tx_ppdu_info);\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic enum dp_mon_tx_tlv_status\nath12k_dp_mon_tx_parse_status_tlv(struct ath12k_base *ab,\n\t\t\t\t  struct ath12k_mon_data *pmon,\n\t\t\t\t  u16 tlv_tag, u8 *tlv_data, u32 userid)\n{\n\tstruct dp_mon_tx_ppdu_info *tx_ppdu_info;\n\tenum dp_mon_tx_tlv_status status = DP_MON_TX_STATUS_PPDU_NOT_DONE;\n\tu32 info[7];\n\n\ttx_ppdu_info = ath12k_dp_mon_hal_tx_ppdu_info(pmon, tlv_tag);\n\n\tswitch (tlv_tag) {\n\tcase HAL_TX_FES_SETUP: {\n\t\tstruct hal_tx_fes_setup *tx_fes_setup =\n\t\t\t\t\t(struct hal_tx_fes_setup *)tlv_data;\n\n\t\tinfo[0] = __le32_to_cpu(tx_fes_setup->info0);\n\t\ttx_ppdu_info->ppdu_id = __le32_to_cpu(tx_fes_setup->schedule_id);\n\t\ttx_ppdu_info->num_users =\n\t\t\tu32_get_bits(info[0], HAL_TX_FES_SETUP_INFO0_NUM_OF_USERS);\n\t\tstatus = DP_MON_TX_FES_SETUP;\n\t\tbreak;\n\t}\n\n\tcase HAL_TX_FES_STATUS_END: {\n\t\tstruct hal_tx_fes_status_end *tx_fes_status_end =\n\t\t\t(struct hal_tx_fes_status_end *)tlv_data;\n\t\tu32 tst_15_0, tst_31_16;\n\n\t\tinfo[0] = __le32_to_cpu(tx_fes_status_end->info0);\n\t\ttst_15_0 =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_FES_STATUS_END_INFO0_START_TIMESTAMP_15_0);\n\t\ttst_31_16 =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_FES_STATUS_END_INFO0_START_TIMESTAMP_31_16);\n\n\t\ttx_ppdu_info->rx_status.ppdu_ts = (tst_15_0 | (tst_31_16 << 16));\n\t\tstatus = DP_MON_TX_FES_STATUS_END;\n\t\tbreak;\n\t}\n\n\tcase HAL_RX_RESPONSE_REQUIRED_INFO: {\n\t\tstruct hal_rx_resp_req_info *rx_resp_req_info =\n\t\t\t(struct hal_rx_resp_req_info *)tlv_data;\n\t\tu32 addr_32;\n\t\tu16 addr_16;\n\n\t\tinfo[0] = __le32_to_cpu(rx_resp_req_info->info0);\n\t\tinfo[1] = __le32_to_cpu(rx_resp_req_info->info1);\n\t\tinfo[2] = __le32_to_cpu(rx_resp_req_info->info2);\n\t\tinfo[3] = __le32_to_cpu(rx_resp_req_info->info3);\n\t\tinfo[4] = __le32_to_cpu(rx_resp_req_info->info4);\n\t\tinfo[5] = __le32_to_cpu(rx_resp_req_info->info5);\n\n\t\ttx_ppdu_info->rx_status.ppdu_id =\n\t\t\tu32_get_bits(info[0], HAL_RX_RESP_REQ_INFO0_PPDU_ID);\n\t\ttx_ppdu_info->rx_status.reception_type =\n\t\t\tu32_get_bits(info[0], HAL_RX_RESP_REQ_INFO0_RECEPTION_TYPE);\n\t\ttx_ppdu_info->rx_status.rx_duration =\n\t\t\tu32_get_bits(info[1], HAL_RX_RESP_REQ_INFO1_DURATION);\n\t\ttx_ppdu_info->rx_status.mcs =\n\t\t\tu32_get_bits(info[1], HAL_RX_RESP_REQ_INFO1_RATE_MCS);\n\t\ttx_ppdu_info->rx_status.sgi =\n\t\t\tu32_get_bits(info[1], HAL_RX_RESP_REQ_INFO1_SGI);\n\t\ttx_ppdu_info->rx_status.is_stbc =\n\t\t\tu32_get_bits(info[1], HAL_RX_RESP_REQ_INFO1_STBC);\n\t\ttx_ppdu_info->rx_status.ldpc =\n\t\t\tu32_get_bits(info[1], HAL_RX_RESP_REQ_INFO1_LDPC);\n\t\ttx_ppdu_info->rx_status.is_ampdu =\n\t\t\tu32_get_bits(info[1], HAL_RX_RESP_REQ_INFO1_IS_AMPDU);\n\t\ttx_ppdu_info->rx_status.num_users =\n\t\t\tu32_get_bits(info[2], HAL_RX_RESP_REQ_INFO2_NUM_USER);\n\n\t\taddr_32 = u32_get_bits(info[3], HAL_RX_RESP_REQ_INFO3_ADDR1_31_0);\n\t\taddr_16 = u32_get_bits(info[3], HAL_RX_RESP_REQ_INFO4_ADDR1_47_32);\n\t\tath12k_dp_get_mac_addr(addr_32, addr_16, tx_ppdu_info->rx_status.addr1);\n\n\t\taddr_16 = u32_get_bits(info[4], HAL_RX_RESP_REQ_INFO4_ADDR1_15_0);\n\t\taddr_32 = u32_get_bits(info[5], HAL_RX_RESP_REQ_INFO5_ADDR1_47_16);\n\t\tath12k_dp_get_mac_addr(addr_32, addr_16, tx_ppdu_info->rx_status.addr2);\n\n\t\tif (tx_ppdu_info->rx_status.reception_type == 0)\n\t\t\tath12k_dp_mon_tx_gen_cts2self_frame(tx_ppdu_info);\n\t\tstatus = DP_MON_RX_RESPONSE_REQUIRED_INFO;\n\t\tbreak;\n\t}\n\n\tcase HAL_PCU_PPDU_SETUP_INIT: {\n\t\tstruct hal_tx_pcu_ppdu_setup_init *ppdu_setup =\n\t\t\t(struct hal_tx_pcu_ppdu_setup_init *)tlv_data;\n\t\tu32 addr_32;\n\t\tu16 addr_16;\n\n\t\tinfo[0] = __le32_to_cpu(ppdu_setup->info0);\n\t\tinfo[1] = __le32_to_cpu(ppdu_setup->info1);\n\t\tinfo[2] = __le32_to_cpu(ppdu_setup->info2);\n\t\tinfo[3] = __le32_to_cpu(ppdu_setup->info3);\n\t\tinfo[4] = __le32_to_cpu(ppdu_setup->info4);\n\t\tinfo[5] = __le32_to_cpu(ppdu_setup->info5);\n\t\tinfo[6] = __le32_to_cpu(ppdu_setup->info6);\n\n\t\t \n\t\taddr_32 = u32_get_bits(info[1],\n\t\t\t\t       HAL_TX_PPDU_SETUP_INFO1_PROT_FRAME_ADDR1_31_0);\n\t\taddr_16 = u32_get_bits(info[2],\n\t\t\t\t       HAL_TX_PPDU_SETUP_INFO2_PROT_FRAME_ADDR1_47_32);\n\t\tath12k_dp_get_mac_addr(addr_32, addr_16, tx_ppdu_info->rx_status.addr1);\n\n\t\t \n\t\taddr_16 = u32_get_bits(info[2],\n\t\t\t\t       HAL_TX_PPDU_SETUP_INFO2_PROT_FRAME_ADDR2_15_0);\n\t\taddr_32 = u32_get_bits(info[3],\n\t\t\t\t       HAL_TX_PPDU_SETUP_INFO3_PROT_FRAME_ADDR2_47_16);\n\t\tath12k_dp_get_mac_addr(addr_32, addr_16, tx_ppdu_info->rx_status.addr2);\n\n\t\t \n\t\taddr_32 = u32_get_bits(info[4],\n\t\t\t\t       HAL_TX_PPDU_SETUP_INFO4_PROT_FRAME_ADDR3_31_0);\n\t\taddr_16 = u32_get_bits(info[5],\n\t\t\t\t       HAL_TX_PPDU_SETUP_INFO5_PROT_FRAME_ADDR3_47_32);\n\t\tath12k_dp_get_mac_addr(addr_32, addr_16, tx_ppdu_info->rx_status.addr3);\n\n\t\t \n\t\taddr_16 = u32_get_bits(info[5],\n\t\t\t\t       HAL_TX_PPDU_SETUP_INFO5_PROT_FRAME_ADDR4_15_0);\n\t\taddr_32 = u32_get_bits(info[6],\n\t\t\t\t       HAL_TX_PPDU_SETUP_INFO6_PROT_FRAME_ADDR4_47_16);\n\t\tath12k_dp_get_mac_addr(addr_32, addr_16, tx_ppdu_info->rx_status.addr4);\n\n\t\tstatus = u32_get_bits(info[0],\n\t\t\t\t      HAL_TX_PPDU_SETUP_INFO0_MEDIUM_PROT_TYPE);\n\t\tbreak;\n\t}\n\n\tcase HAL_TX_QUEUE_EXTENSION: {\n\t\tstruct hal_tx_queue_exten *tx_q_exten =\n\t\t\t(struct hal_tx_queue_exten *)tlv_data;\n\n\t\tinfo[0] = __le32_to_cpu(tx_q_exten->info0);\n\n\t\ttx_ppdu_info->rx_status.frame_control =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_Q_EXT_INFO0_FRAME_CTRL);\n\t\ttx_ppdu_info->rx_status.fc_valid = true;\n\t\tbreak;\n\t}\n\n\tcase HAL_TX_FES_STATUS_START: {\n\t\tstruct hal_tx_fes_status_start *tx_fes_start =\n\t\t\t(struct hal_tx_fes_status_start *)tlv_data;\n\n\t\tinfo[0] = __le32_to_cpu(tx_fes_start->info0);\n\n\t\ttx_ppdu_info->rx_status.medium_prot_type =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_FES_STATUS_START_INFO0_MEDIUM_PROT_TYPE);\n\t\tbreak;\n\t}\n\n\tcase HAL_TX_FES_STATUS_PROT: {\n\t\tstruct hal_tx_fes_status_prot *tx_fes_status =\n\t\t\t(struct hal_tx_fes_status_prot *)tlv_data;\n\t\tu32 start_timestamp;\n\t\tu32 end_timestamp;\n\n\t\tinfo[0] = __le32_to_cpu(tx_fes_status->info0);\n\t\tinfo[1] = __le32_to_cpu(tx_fes_status->info1);\n\n\t\tstart_timestamp =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_FES_STAT_PROT_INFO0_STRT_FRM_TS_15_0);\n\t\tstart_timestamp |=\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_FES_STAT_PROT_INFO0_STRT_FRM_TS_31_16) << 15;\n\t\tend_timestamp =\n\t\t\tu32_get_bits(info[1],\n\t\t\t\t     HAL_TX_FES_STAT_PROT_INFO1_END_FRM_TS_15_0);\n\t\tend_timestamp |=\n\t\t\tu32_get_bits(info[1],\n\t\t\t\t     HAL_TX_FES_STAT_PROT_INFO1_END_FRM_TS_31_16) << 15;\n\t\ttx_ppdu_info->rx_status.rx_duration = end_timestamp - start_timestamp;\n\n\t\tath12k_dp_mon_tx_gen_prot_frame(tx_ppdu_info);\n\t\tbreak;\n\t}\n\n\tcase HAL_TX_FES_STATUS_START_PPDU:\n\tcase HAL_TX_FES_STATUS_START_PROT: {\n\t\tstruct hal_tx_fes_status_start_prot *tx_fes_stat_start =\n\t\t\t(struct hal_tx_fes_status_start_prot *)tlv_data;\n\t\tu64 ppdu_ts;\n\n\t\tinfo[0] = __le32_to_cpu(tx_fes_stat_start->info0);\n\n\t\ttx_ppdu_info->rx_status.ppdu_ts =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_FES_STAT_STRT_INFO0_PROT_TS_LOWER_32);\n\t\tppdu_ts = (u32_get_bits(info[1],\n\t\t\t\t\tHAL_TX_FES_STAT_STRT_INFO1_PROT_TS_UPPER_32));\n\t\ttx_ppdu_info->rx_status.ppdu_ts |= ppdu_ts << 32;\n\t\tbreak;\n\t}\n\n\tcase HAL_TX_FES_STATUS_USER_PPDU: {\n\t\tstruct hal_tx_fes_status_user_ppdu *tx_fes_usr_ppdu =\n\t\t\t(struct hal_tx_fes_status_user_ppdu *)tlv_data;\n\n\t\tinfo[0] = __le32_to_cpu(tx_fes_usr_ppdu->info0);\n\n\t\ttx_ppdu_info->rx_status.rx_duration =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_FES_STAT_USR_PPDU_INFO0_DURATION);\n\t\tbreak;\n\t}\n\n\tcase HAL_MACTX_HE_SIG_A_SU:\n\t\tath12k_dp_mon_parse_he_sig_su(tlv_data, &tx_ppdu_info->rx_status);\n\t\tbreak;\n\n\tcase HAL_MACTX_HE_SIG_A_MU_DL:\n\t\tath12k_dp_mon_parse_he_sig_mu(tlv_data, &tx_ppdu_info->rx_status);\n\t\tbreak;\n\n\tcase HAL_MACTX_HE_SIG_B1_MU:\n\t\tath12k_dp_mon_parse_he_sig_b1_mu(tlv_data, &tx_ppdu_info->rx_status);\n\t\tbreak;\n\n\tcase HAL_MACTX_HE_SIG_B2_MU:\n\t\tath12k_dp_mon_parse_he_sig_b2_mu(tlv_data, &tx_ppdu_info->rx_status);\n\t\tbreak;\n\n\tcase HAL_MACTX_HE_SIG_B2_OFDMA:\n\t\tath12k_dp_mon_parse_he_sig_b2_ofdma(tlv_data, &tx_ppdu_info->rx_status);\n\t\tbreak;\n\n\tcase HAL_MACTX_VHT_SIG_A:\n\t\tath12k_dp_mon_parse_vht_sig_a(tlv_data, &tx_ppdu_info->rx_status);\n\t\tbreak;\n\n\tcase HAL_MACTX_L_SIG_A:\n\t\tath12k_dp_mon_parse_l_sig_a(tlv_data, &tx_ppdu_info->rx_status);\n\t\tbreak;\n\n\tcase HAL_MACTX_L_SIG_B:\n\t\tath12k_dp_mon_parse_l_sig_b(tlv_data, &tx_ppdu_info->rx_status);\n\t\tbreak;\n\n\tcase HAL_RX_FRAME_BITMAP_ACK: {\n\t\tstruct hal_rx_frame_bitmap_ack *fbm_ack =\n\t\t\t(struct hal_rx_frame_bitmap_ack *)tlv_data;\n\t\tu32 addr_32;\n\t\tu16 addr_16;\n\n\t\tinfo[0] = __le32_to_cpu(fbm_ack->info0);\n\t\tinfo[1] = __le32_to_cpu(fbm_ack->info1);\n\n\t\taddr_32 = u32_get_bits(info[0],\n\t\t\t\t       HAL_RX_FBM_ACK_INFO0_ADDR1_31_0);\n\t\taddr_16 = u32_get_bits(info[1],\n\t\t\t\t       HAL_RX_FBM_ACK_INFO1_ADDR1_47_32);\n\t\tath12k_dp_get_mac_addr(addr_32, addr_16, tx_ppdu_info->rx_status.addr1);\n\n\t\tath12k_dp_mon_tx_gen_ack_frame(tx_ppdu_info);\n\t\tbreak;\n\t}\n\n\tcase HAL_MACTX_PHY_DESC: {\n\t\tstruct hal_tx_phy_desc *tx_phy_desc =\n\t\t\t(struct hal_tx_phy_desc *)tlv_data;\n\n\t\tinfo[0] = __le32_to_cpu(tx_phy_desc->info0);\n\t\tinfo[1] = __le32_to_cpu(tx_phy_desc->info1);\n\t\tinfo[2] = __le32_to_cpu(tx_phy_desc->info2);\n\t\tinfo[3] = __le32_to_cpu(tx_phy_desc->info3);\n\n\t\ttx_ppdu_info->rx_status.beamformed =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_PHY_DESC_INFO0_BF_TYPE);\n\t\ttx_ppdu_info->rx_status.preamble_type =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_PHY_DESC_INFO0_PREAMBLE_11B);\n\t\ttx_ppdu_info->rx_status.mcs =\n\t\t\tu32_get_bits(info[1],\n\t\t\t\t     HAL_TX_PHY_DESC_INFO1_MCS);\n\t\ttx_ppdu_info->rx_status.ltf_size =\n\t\t\tu32_get_bits(info[3],\n\t\t\t\t     HAL_TX_PHY_DESC_INFO3_LTF_SIZE);\n\t\ttx_ppdu_info->rx_status.nss =\n\t\t\tu32_get_bits(info[2],\n\t\t\t\t     HAL_TX_PHY_DESC_INFO2_NSS);\n\t\ttx_ppdu_info->rx_status.chan_num =\n\t\t\tu32_get_bits(info[3],\n\t\t\t\t     HAL_TX_PHY_DESC_INFO3_ACTIVE_CHANNEL);\n\t\ttx_ppdu_info->rx_status.bw =\n\t\t\tu32_get_bits(info[0],\n\t\t\t\t     HAL_TX_PHY_DESC_INFO0_BANDWIDTH);\n\t\tbreak;\n\t}\n\n\tcase HAL_TX_MPDU_START: {\n\t\tstruct dp_mon_mpdu *mon_mpdu = tx_ppdu_info->tx_mon_mpdu;\n\n\t\tmon_mpdu = kzalloc(sizeof(*mon_mpdu), GFP_ATOMIC);\n\t\tif (!mon_mpdu)\n\t\t\treturn DP_MON_TX_STATUS_PPDU_NOT_DONE;\n\t\tstatus = DP_MON_TX_MPDU_START;\n\t\tbreak;\n\t}\n\n\tcase HAL_MON_BUF_ADDR: {\n\t\tstruct dp_rxdma_ring *buf_ring = &ab->dp.tx_mon_buf_ring;\n\t\tstruct dp_mon_packet_info *packet_info =\n\t\t\t(struct dp_mon_packet_info *)tlv_data;\n\t\tint buf_id = u32_get_bits(packet_info->cookie,\n\t\t\t\t\t  DP_RXDMA_BUF_COOKIE_BUF_ID);\n\t\tstruct sk_buff *msdu;\n\t\tstruct dp_mon_mpdu *mon_mpdu = tx_ppdu_info->tx_mon_mpdu;\n\t\tstruct ath12k_skb_rxcb *rxcb;\n\n\t\tspin_lock_bh(&buf_ring->idr_lock);\n\t\tmsdu = idr_remove(&buf_ring->bufs_idr, buf_id);\n\t\tspin_unlock_bh(&buf_ring->idr_lock);\n\n\t\tif (unlikely(!msdu)) {\n\t\t\tath12k_warn(ab, \"monitor destination with invalid buf_id %d\\n\",\n\t\t\t\t    buf_id);\n\t\t\treturn DP_MON_TX_STATUS_PPDU_NOT_DONE;\n\t\t}\n\n\t\trxcb = ATH12K_SKB_RXCB(msdu);\n\t\tdma_unmap_single(ab->dev, rxcb->paddr,\n\t\t\t\t msdu->len + skb_tailroom(msdu),\n\t\t\t\t DMA_FROM_DEVICE);\n\n\t\tif (!mon_mpdu->head)\n\t\t\tmon_mpdu->head = msdu;\n\t\telse if (mon_mpdu->tail)\n\t\t\tmon_mpdu->tail->next = msdu;\n\n\t\tmon_mpdu->tail = msdu;\n\n\t\tath12k_dp_mon_buf_replenish(ab, buf_ring, 1);\n\t\tstatus = DP_MON_TX_BUFFER_ADDR;\n\t\tbreak;\n\t}\n\n\tcase HAL_TX_MPDU_END:\n\t\tlist_add_tail(&tx_ppdu_info->tx_mon_mpdu->list,\n\t\t\t      &tx_ppdu_info->dp_tx_mon_mpdu_list);\n\t\tbreak;\n\t}\n\n\treturn status;\n}\n\nenum dp_mon_tx_tlv_status\nath12k_dp_mon_tx_status_get_num_user(u16 tlv_tag,\n\t\t\t\t     struct hal_tlv_hdr *tx_tlv,\n\t\t\t\t     u8 *num_users)\n{\n\tu32 tlv_status = DP_MON_TX_STATUS_PPDU_NOT_DONE;\n\tu32 info0;\n\n\tswitch (tlv_tag) {\n\tcase HAL_TX_FES_SETUP: {\n\t\tstruct hal_tx_fes_setup *tx_fes_setup =\n\t\t\t\t(struct hal_tx_fes_setup *)tx_tlv;\n\n\t\tinfo0 = __le32_to_cpu(tx_fes_setup->info0);\n\n\t\t*num_users = u32_get_bits(info0, HAL_TX_FES_SETUP_INFO0_NUM_OF_USERS);\n\t\ttlv_status = DP_MON_TX_FES_SETUP;\n\t\tbreak;\n\t}\n\n\tcase HAL_RX_RESPONSE_REQUIRED_INFO: {\n\t\t \n\t\ttlv_status = DP_MON_RX_RESPONSE_REQUIRED_INFO;\n\t\tbreak;\n\t}\n\t}\n\n\treturn tlv_status;\n}\n\nstatic void\nath12k_dp_mon_tx_process_ppdu_info(struct ath12k *ar, int mac_id,\n\t\t\t\t   struct napi_struct *napi,\n\t\t\t\t   struct dp_mon_tx_ppdu_info *tx_ppdu_info)\n{\n\tstruct dp_mon_mpdu *tmp, *mon_mpdu;\n\tstruct sk_buff *head_msdu;\n\n\tlist_for_each_entry_safe(mon_mpdu, tmp,\n\t\t\t\t &tx_ppdu_info->dp_tx_mon_mpdu_list, list) {\n\t\tlist_del(&mon_mpdu->list);\n\t\thead_msdu = mon_mpdu->head;\n\n\t\tif (head_msdu)\n\t\t\tath12k_dp_mon_rx_deliver(ar, mac_id, head_msdu,\n\t\t\t\t\t\t &tx_ppdu_info->rx_status, napi);\n\n\t\tkfree(mon_mpdu);\n\t}\n}\n\nenum hal_rx_mon_status\nath12k_dp_mon_tx_parse_mon_status(struct ath12k *ar,\n\t\t\t\t  struct ath12k_mon_data *pmon,\n\t\t\t\t  int mac_id,\n\t\t\t\t  struct sk_buff *skb,\n\t\t\t\t  struct napi_struct *napi,\n\t\t\t\t  u32 ppdu_id)\n{\n\tstruct ath12k_base *ab = ar->ab;\n\tstruct dp_mon_tx_ppdu_info *tx_prot_ppdu_info, *tx_data_ppdu_info;\n\tstruct hal_tlv_hdr *tlv;\n\tu8 *ptr = skb->data;\n\tu16 tlv_tag;\n\tu16 tlv_len;\n\tu32 tlv_userid = 0;\n\tu8 num_user;\n\tu32 tlv_status = DP_MON_TX_STATUS_PPDU_NOT_DONE;\n\n\ttx_prot_ppdu_info = ath12k_dp_mon_tx_get_ppdu_info(pmon, ppdu_id,\n\t\t\t\t\t\t\t   DP_MON_TX_PROT_PPDU_INFO);\n\tif (!tx_prot_ppdu_info)\n\t\treturn -ENOMEM;\n\n\ttlv = (struct hal_tlv_hdr *)ptr;\n\ttlv_tag = le32_get_bits(tlv->tl, HAL_TLV_HDR_TAG);\n\n\ttlv_status = ath12k_dp_mon_tx_status_get_num_user(tlv_tag, tlv, &num_user);\n\tif (tlv_status == DP_MON_TX_STATUS_PPDU_NOT_DONE || !num_user)\n\t\treturn -EINVAL;\n\n\ttx_data_ppdu_info = ath12k_dp_mon_tx_get_ppdu_info(pmon, ppdu_id,\n\t\t\t\t\t\t\t   DP_MON_TX_DATA_PPDU_INFO);\n\tif (!tx_data_ppdu_info)\n\t\treturn -ENOMEM;\n\n\tdo {\n\t\ttlv = (struct hal_tlv_hdr *)ptr;\n\t\ttlv_tag = le32_get_bits(tlv->tl, HAL_TLV_HDR_TAG);\n\t\ttlv_len = le32_get_bits(tlv->tl, HAL_TLV_HDR_LEN);\n\t\ttlv_userid = le32_get_bits(tlv->tl, HAL_TLV_USR_ID);\n\n\t\ttlv_status = ath12k_dp_mon_tx_parse_status_tlv(ab, pmon,\n\t\t\t\t\t\t\t       tlv_tag, ptr,\n\t\t\t\t\t\t\t       tlv_userid);\n\t\tptr += tlv_len;\n\t\tptr = PTR_ALIGN(ptr, HAL_TLV_ALIGN);\n\t\tif ((ptr - skb->data) >= DP_TX_MONITOR_BUF_SIZE)\n\t\t\tbreak;\n\t} while (tlv_status != DP_MON_TX_FES_STATUS_END);\n\n\tath12k_dp_mon_tx_process_ppdu_info(ar, mac_id, napi, tx_data_ppdu_info);\n\tath12k_dp_mon_tx_process_ppdu_info(ar, mac_id, napi, tx_prot_ppdu_info);\n\n\treturn tlv_status;\n}\n\nint ath12k_dp_mon_srng_process(struct ath12k *ar, int mac_id, int *budget,\n\t\t\t       enum dp_monitor_mode monitor_mode,\n\t\t\t       struct napi_struct *napi)\n{\n\tstruct hal_mon_dest_desc *mon_dst_desc;\n\tstruct ath12k_pdev_dp *pdev_dp = &ar->dp;\n\tstruct ath12k_mon_data *pmon = (struct ath12k_mon_data *)&pdev_dp->mon_data;\n\tstruct ath12k_base *ab = ar->ab;\n\tstruct ath12k_dp *dp = &ab->dp;\n\tstruct sk_buff *skb;\n\tstruct ath12k_skb_rxcb *rxcb;\n\tstruct dp_srng *mon_dst_ring;\n\tstruct hal_srng *srng;\n\tstruct dp_rxdma_ring *buf_ring;\n\tu64 cookie;\n\tu32 ppdu_id;\n\tint num_buffs_reaped = 0, srng_id, buf_id;\n\tu8 dest_idx = 0, i;\n\tbool end_of_ppdu;\n\tstruct hal_rx_mon_ppdu_info *ppdu_info;\n\tstruct ath12k_peer *peer = NULL;\n\n\tppdu_info = &pmon->mon_ppdu_info;\n\tmemset(ppdu_info, 0, sizeof(*ppdu_info));\n\tppdu_info->peer_id = HAL_INVALID_PEERID;\n\n\tsrng_id = ath12k_hw_mac_id_to_srng_id(ab->hw_params, mac_id);\n\n\tif (monitor_mode == ATH12K_DP_RX_MONITOR_MODE) {\n\t\tmon_dst_ring = &pdev_dp->rxdma_mon_dst_ring[srng_id];\n\t\tbuf_ring = &dp->rxdma_mon_buf_ring;\n\t} else {\n\t\tmon_dst_ring = &pdev_dp->tx_mon_dst_ring[srng_id];\n\t\tbuf_ring = &dp->tx_mon_buf_ring;\n\t}\n\n\tsrng = &ab->hal.srng_list[mon_dst_ring->ring_id];\n\n\tspin_lock_bh(&srng->lock);\n\tath12k_hal_srng_access_begin(ab, srng);\n\n\twhile (likely(*budget)) {\n\t\t*budget -= 1;\n\t\tmon_dst_desc = ath12k_hal_srng_dst_peek(ab, srng);\n\t\tif (unlikely(!mon_dst_desc))\n\t\t\tbreak;\n\n\t\tcookie = le32_to_cpu(mon_dst_desc->cookie);\n\t\tbuf_id = u32_get_bits(cookie, DP_RXDMA_BUF_COOKIE_BUF_ID);\n\n\t\tspin_lock_bh(&buf_ring->idr_lock);\n\t\tskb = idr_remove(&buf_ring->bufs_idr, buf_id);\n\t\tspin_unlock_bh(&buf_ring->idr_lock);\n\n\t\tif (unlikely(!skb)) {\n\t\t\tath12k_warn(ab, \"monitor destination with invalid buf_id %d\\n\",\n\t\t\t\t    buf_id);\n\t\t\tgoto move_next;\n\t\t}\n\n\t\trxcb = ATH12K_SKB_RXCB(skb);\n\t\tdma_unmap_single(ab->dev, rxcb->paddr,\n\t\t\t\t skb->len + skb_tailroom(skb),\n\t\t\t\t DMA_FROM_DEVICE);\n\n\t\tpmon->dest_skb_q[dest_idx] = skb;\n\t\tdest_idx++;\n\t\tppdu_id = le32_to_cpu(mon_dst_desc->ppdu_id);\n\t\tend_of_ppdu = le32_get_bits(mon_dst_desc->info0,\n\t\t\t\t\t    HAL_MON_DEST_INFO0_END_OF_PPDU);\n\t\tif (!end_of_ppdu)\n\t\t\tcontinue;\n\n\t\tfor (i = 0; i < dest_idx; i++) {\n\t\t\tskb = pmon->dest_skb_q[i];\n\n\t\t\tif (monitor_mode == ATH12K_DP_RX_MONITOR_MODE)\n\t\t\t\tath12k_dp_mon_rx_parse_mon_status(ar, pmon, mac_id,\n\t\t\t\t\t\t\t\t  skb, napi);\n\t\t\telse\n\t\t\t\tath12k_dp_mon_tx_parse_mon_status(ar, pmon, mac_id,\n\t\t\t\t\t\t\t\t  skb, napi, ppdu_id);\n\n\t\t\tpeer = ath12k_peer_find_by_id(ab, ppdu_info->peer_id);\n\n\t\t\tif (!peer || !peer->sta) {\n\t\t\t\tath12k_dbg(ab, ATH12K_DBG_DATA,\n\t\t\t\t\t   \"failed to find the peer with peer_id %d\\n\",\n\t\t\t\t\t   ppdu_info->peer_id);\n\t\t\t\tdev_kfree_skb_any(skb);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tdev_kfree_skb_any(skb);\n\t\t\tpmon->dest_skb_q[i] = NULL;\n\t\t}\n\n\t\tdest_idx = 0;\nmove_next:\n\t\tath12k_dp_mon_buf_replenish(ab, buf_ring, 1);\n\t\tath12k_hal_srng_src_get_next_entry(ab, srng);\n\t\tnum_buffs_reaped++;\n\t}\n\n\tath12k_hal_srng_access_end(ab, srng);\n\tspin_unlock_bh(&srng->lock);\n\n\treturn num_buffs_reaped;\n}\n\nstatic void\nath12k_dp_mon_rx_update_peer_rate_table_stats(struct ath12k_rx_peer_stats *rx_stats,\n\t\t\t\t\t      struct hal_rx_mon_ppdu_info *ppdu_info,\n\t\t\t\t\t      struct hal_rx_user_status *user_stats,\n\t\t\t\t\t      u32 num_msdu)\n{\n\tu32 rate_idx = 0;\n\tu32 mcs_idx = (user_stats) ? user_stats->mcs : ppdu_info->mcs;\n\tu32 nss_idx = (user_stats) ? user_stats->nss - 1 : ppdu_info->nss - 1;\n\tu32 bw_idx = ppdu_info->bw;\n\tu32 gi_idx = ppdu_info->gi;\n\n\tif ((mcs_idx > HAL_RX_MAX_MCS_HE) || (nss_idx >= HAL_RX_MAX_NSS) ||\n\t    (bw_idx >= HAL_RX_BW_MAX) || (gi_idx >= HAL_RX_GI_MAX)) {\n\t\treturn;\n\t}\n\n\tif (ppdu_info->preamble_type == HAL_RX_PREAMBLE_11N ||\n\t    ppdu_info->preamble_type == HAL_RX_PREAMBLE_11AC) {\n\t\trate_idx = mcs_idx * 8 + 8 * 10 * nss_idx;\n\t\trate_idx += bw_idx * 2 + gi_idx;\n\t} else if (ppdu_info->preamble_type == HAL_RX_PREAMBLE_11AX) {\n\t\tgi_idx = ath12k_he_gi_to_nl80211_he_gi(ppdu_info->gi);\n\t\trate_idx = mcs_idx * 12 + 12 * 12 * nss_idx;\n\t\trate_idx += bw_idx * 3 + gi_idx;\n\t} else {\n\t\treturn;\n\t}\n\n\trx_stats->pkt_stats.rx_rate[rate_idx] += num_msdu;\n\tif (user_stats)\n\t\trx_stats->byte_stats.rx_rate[rate_idx] += user_stats->mpdu_ok_byte_count;\n\telse\n\t\trx_stats->byte_stats.rx_rate[rate_idx] += ppdu_info->mpdu_len;\n}\n\nstatic void ath12k_dp_mon_rx_update_peer_su_stats(struct ath12k *ar,\n\t\t\t\t\t\t  struct ath12k_sta *arsta,\n\t\t\t\t\t\t  struct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct ath12k_rx_peer_stats *rx_stats = arsta->rx_stats;\n\tu32 num_msdu;\n\n\tif (!rx_stats)\n\t\treturn;\n\n\tarsta->rssi_comb = ppdu_info->rssi_comb;\n\n\tnum_msdu = ppdu_info->tcp_msdu_count + ppdu_info->tcp_ack_msdu_count +\n\t\t   ppdu_info->udp_msdu_count + ppdu_info->other_msdu_count;\n\n\trx_stats->num_msdu += num_msdu;\n\trx_stats->tcp_msdu_count += ppdu_info->tcp_msdu_count +\n\t\t\t\t    ppdu_info->tcp_ack_msdu_count;\n\trx_stats->udp_msdu_count += ppdu_info->udp_msdu_count;\n\trx_stats->other_msdu_count += ppdu_info->other_msdu_count;\n\n\tif (ppdu_info->preamble_type == HAL_RX_PREAMBLE_11A ||\n\t    ppdu_info->preamble_type == HAL_RX_PREAMBLE_11B) {\n\t\tppdu_info->nss = 1;\n\t\tppdu_info->mcs = HAL_RX_MAX_MCS;\n\t\tppdu_info->tid = IEEE80211_NUM_TIDS;\n\t}\n\n\tif (ppdu_info->ldpc < HAL_RX_SU_MU_CODING_MAX)\n\t\trx_stats->coding_count[ppdu_info->ldpc] += num_msdu;\n\n\tif (ppdu_info->tid <= IEEE80211_NUM_TIDS)\n\t\trx_stats->tid_count[ppdu_info->tid] += num_msdu;\n\n\tif (ppdu_info->preamble_type < HAL_RX_PREAMBLE_MAX)\n\t\trx_stats->pream_cnt[ppdu_info->preamble_type] += num_msdu;\n\n\tif (ppdu_info->reception_type < HAL_RX_RECEPTION_TYPE_MAX)\n\t\trx_stats->reception_type[ppdu_info->reception_type] += num_msdu;\n\n\tif (ppdu_info->is_stbc)\n\t\trx_stats->stbc_count += num_msdu;\n\n\tif (ppdu_info->beamformed)\n\t\trx_stats->beamformed_count += num_msdu;\n\n\tif (ppdu_info->num_mpdu_fcs_ok > 1)\n\t\trx_stats->ampdu_msdu_count += num_msdu;\n\telse\n\t\trx_stats->non_ampdu_msdu_count += num_msdu;\n\n\trx_stats->num_mpdu_fcs_ok += ppdu_info->num_mpdu_fcs_ok;\n\trx_stats->num_mpdu_fcs_err += ppdu_info->num_mpdu_fcs_err;\n\trx_stats->dcm_count += ppdu_info->dcm;\n\n\trx_stats->rx_duration += ppdu_info->rx_duration;\n\tarsta->rx_duration = rx_stats->rx_duration;\n\n\tif (ppdu_info->nss > 0 && ppdu_info->nss <= HAL_RX_MAX_NSS) {\n\t\trx_stats->pkt_stats.nss_count[ppdu_info->nss - 1] += num_msdu;\n\t\trx_stats->byte_stats.nss_count[ppdu_info->nss - 1] += ppdu_info->mpdu_len;\n\t}\n\n\tif (ppdu_info->preamble_type == HAL_RX_PREAMBLE_11N &&\n\t    ppdu_info->mcs <= HAL_RX_MAX_MCS_HT) {\n\t\trx_stats->pkt_stats.ht_mcs_count[ppdu_info->mcs] += num_msdu;\n\t\trx_stats->byte_stats.ht_mcs_count[ppdu_info->mcs] += ppdu_info->mpdu_len;\n\t\t \n\t\tppdu_info->mcs = ppdu_info->mcs % 8;\n\t}\n\n\tif (ppdu_info->preamble_type == HAL_RX_PREAMBLE_11AC &&\n\t    ppdu_info->mcs <= HAL_RX_MAX_MCS_VHT) {\n\t\trx_stats->pkt_stats.vht_mcs_count[ppdu_info->mcs] += num_msdu;\n\t\trx_stats->byte_stats.vht_mcs_count[ppdu_info->mcs] += ppdu_info->mpdu_len;\n\t}\n\n\tif (ppdu_info->preamble_type == HAL_RX_PREAMBLE_11AX &&\n\t    ppdu_info->mcs <= HAL_RX_MAX_MCS_HE) {\n\t\trx_stats->pkt_stats.he_mcs_count[ppdu_info->mcs] += num_msdu;\n\t\trx_stats->byte_stats.he_mcs_count[ppdu_info->mcs] += ppdu_info->mpdu_len;\n\t}\n\n\tif ((ppdu_info->preamble_type == HAL_RX_PREAMBLE_11A ||\n\t     ppdu_info->preamble_type == HAL_RX_PREAMBLE_11B) &&\n\t     ppdu_info->rate < HAL_RX_LEGACY_RATE_INVALID) {\n\t\trx_stats->pkt_stats.legacy_count[ppdu_info->rate] += num_msdu;\n\t\trx_stats->byte_stats.legacy_count[ppdu_info->rate] += ppdu_info->mpdu_len;\n\t}\n\n\tif (ppdu_info->gi < HAL_RX_GI_MAX) {\n\t\trx_stats->pkt_stats.gi_count[ppdu_info->gi] += num_msdu;\n\t\trx_stats->byte_stats.gi_count[ppdu_info->gi] += ppdu_info->mpdu_len;\n\t}\n\n\tif (ppdu_info->bw < HAL_RX_BW_MAX) {\n\t\trx_stats->pkt_stats.bw_count[ppdu_info->bw] += num_msdu;\n\t\trx_stats->byte_stats.bw_count[ppdu_info->bw] += ppdu_info->mpdu_len;\n\t}\n\n\tath12k_dp_mon_rx_update_peer_rate_table_stats(rx_stats, ppdu_info,\n\t\t\t\t\t\t      NULL, num_msdu);\n}\n\nvoid ath12k_dp_mon_rx_process_ulofdma(struct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tstruct hal_rx_user_status *rx_user_status;\n\tu32 num_users, i, mu_ul_user_v0_word0, mu_ul_user_v0_word1, ru_size;\n\n\tif (!(ppdu_info->reception_type == HAL_RX_RECEPTION_TYPE_MU_MIMO ||\n\t      ppdu_info->reception_type == HAL_RX_RECEPTION_TYPE_MU_OFDMA ||\n\t      ppdu_info->reception_type == HAL_RX_RECEPTION_TYPE_MU_OFDMA_MIMO))\n\t\treturn;\n\n\tnum_users = ppdu_info->num_users;\n\tif (num_users > HAL_MAX_UL_MU_USERS)\n\t\tnum_users = HAL_MAX_UL_MU_USERS;\n\n\tfor (i = 0; i < num_users; i++) {\n\t\trx_user_status = &ppdu_info->userstats[i];\n\t\tmu_ul_user_v0_word0 =\n\t\t\trx_user_status->ul_ofdma_user_v0_word0;\n\t\tmu_ul_user_v0_word1 =\n\t\t\trx_user_status->ul_ofdma_user_v0_word1;\n\n\t\tif (u32_get_bits(mu_ul_user_v0_word0,\n\t\t\t\t HAL_RX_UL_OFDMA_USER_INFO_V0_W0_VALID) &&\n\t\t    !u32_get_bits(mu_ul_user_v0_word0,\n\t\t\t\t  HAL_RX_UL_OFDMA_USER_INFO_V0_W0_VER)) {\n\t\t\trx_user_status->mcs =\n\t\t\t\tu32_get_bits(mu_ul_user_v0_word1,\n\t\t\t\t\t     HAL_RX_UL_OFDMA_USER_INFO_V0_W1_MCS);\n\t\t\trx_user_status->nss =\n\t\t\t\tu32_get_bits(mu_ul_user_v0_word1,\n\t\t\t\t\t     HAL_RX_UL_OFDMA_USER_INFO_V0_W1_NSS) + 1;\n\n\t\t\trx_user_status->ofdma_info_valid = 1;\n\t\t\trx_user_status->ul_ofdma_ru_start_index =\n\t\t\t\tu32_get_bits(mu_ul_user_v0_word1,\n\t\t\t\t\t     HAL_RX_UL_OFDMA_USER_INFO_V0_W1_RU_START);\n\n\t\t\tru_size = u32_get_bits(mu_ul_user_v0_word1,\n\t\t\t\t\t       HAL_RX_UL_OFDMA_USER_INFO_V0_W1_RU_SIZE);\n\t\t\trx_user_status->ul_ofdma_ru_width = ru_size;\n\t\t\trx_user_status->ul_ofdma_ru_size = ru_size;\n\t\t}\n\t\trx_user_status->ldpc = u32_get_bits(mu_ul_user_v0_word1,\n\t\t\t\t\t\t    HAL_RX_UL_OFDMA_USER_INFO_V0_W1_LDPC);\n\t}\n\tppdu_info->ldpc = 1;\n}\n\nstatic void\nath12k_dp_mon_rx_update_user_stats(struct ath12k *ar,\n\t\t\t\t   struct hal_rx_mon_ppdu_info *ppdu_info,\n\t\t\t\t   u32 uid)\n{\n\tstruct ath12k_sta *arsta = NULL;\n\tstruct ath12k_rx_peer_stats *rx_stats = NULL;\n\tstruct hal_rx_user_status *user_stats = &ppdu_info->userstats[uid];\n\tstruct ath12k_peer *peer;\n\tu32 num_msdu;\n\n\tif (user_stats->ast_index == 0 || user_stats->ast_index == 0xFFFF)\n\t\treturn;\n\n\tpeer = ath12k_peer_find_by_ast(ar->ab, user_stats->ast_index);\n\n\tif (!peer) {\n\t\tath12k_warn(ar->ab, \"peer ast idx %d can't be found\\n\",\n\t\t\t    user_stats->ast_index);\n\t\treturn;\n\t}\n\n\tarsta = (struct ath12k_sta *)peer->sta->drv_priv;\n\trx_stats = arsta->rx_stats;\n\n\tif (!rx_stats)\n\t\treturn;\n\n\tarsta->rssi_comb = ppdu_info->rssi_comb;\n\n\tnum_msdu = user_stats->tcp_msdu_count + user_stats->tcp_ack_msdu_count +\n\t\t   user_stats->udp_msdu_count + user_stats->other_msdu_count;\n\n\trx_stats->num_msdu += num_msdu;\n\trx_stats->tcp_msdu_count += user_stats->tcp_msdu_count +\n\t\t\t\t    user_stats->tcp_ack_msdu_count;\n\trx_stats->udp_msdu_count += user_stats->udp_msdu_count;\n\trx_stats->other_msdu_count += user_stats->other_msdu_count;\n\n\tif (ppdu_info->ldpc < HAL_RX_SU_MU_CODING_MAX)\n\t\trx_stats->coding_count[ppdu_info->ldpc] += num_msdu;\n\n\tif (user_stats->tid <= IEEE80211_NUM_TIDS)\n\t\trx_stats->tid_count[user_stats->tid] += num_msdu;\n\n\tif (user_stats->preamble_type < HAL_RX_PREAMBLE_MAX)\n\t\trx_stats->pream_cnt[user_stats->preamble_type] += num_msdu;\n\n\tif (ppdu_info->reception_type < HAL_RX_RECEPTION_TYPE_MAX)\n\t\trx_stats->reception_type[ppdu_info->reception_type] += num_msdu;\n\n\tif (ppdu_info->is_stbc)\n\t\trx_stats->stbc_count += num_msdu;\n\n\tif (ppdu_info->beamformed)\n\t\trx_stats->beamformed_count += num_msdu;\n\n\tif (user_stats->mpdu_cnt_fcs_ok > 1)\n\t\trx_stats->ampdu_msdu_count += num_msdu;\n\telse\n\t\trx_stats->non_ampdu_msdu_count += num_msdu;\n\n\trx_stats->num_mpdu_fcs_ok += user_stats->mpdu_cnt_fcs_ok;\n\trx_stats->num_mpdu_fcs_err += user_stats->mpdu_cnt_fcs_err;\n\trx_stats->dcm_count += ppdu_info->dcm;\n\tif (ppdu_info->reception_type == HAL_RX_RECEPTION_TYPE_MU_OFDMA ||\n\t    ppdu_info->reception_type == HAL_RX_RECEPTION_TYPE_MU_OFDMA_MIMO)\n\t\trx_stats->ru_alloc_cnt[user_stats->ul_ofdma_ru_size] += num_msdu;\n\n\trx_stats->rx_duration += ppdu_info->rx_duration;\n\tarsta->rx_duration = rx_stats->rx_duration;\n\n\tif (user_stats->nss > 0 && user_stats->nss <= HAL_RX_MAX_NSS) {\n\t\trx_stats->pkt_stats.nss_count[user_stats->nss - 1] += num_msdu;\n\t\trx_stats->byte_stats.nss_count[user_stats->nss - 1] +=\n\t\t\t\t\t\tuser_stats->mpdu_ok_byte_count;\n\t}\n\n\tif (user_stats->preamble_type == HAL_RX_PREAMBLE_11AX &&\n\t    user_stats->mcs <= HAL_RX_MAX_MCS_HE) {\n\t\trx_stats->pkt_stats.he_mcs_count[user_stats->mcs] += num_msdu;\n\t\trx_stats->byte_stats.he_mcs_count[user_stats->mcs] +=\n\t\t\t\t\t\tuser_stats->mpdu_ok_byte_count;\n\t}\n\n\tif (ppdu_info->gi < HAL_RX_GI_MAX) {\n\t\trx_stats->pkt_stats.gi_count[ppdu_info->gi] += num_msdu;\n\t\trx_stats->byte_stats.gi_count[ppdu_info->gi] +=\n\t\t\t\t\t\tuser_stats->mpdu_ok_byte_count;\n\t}\n\n\tif (ppdu_info->bw < HAL_RX_BW_MAX) {\n\t\trx_stats->pkt_stats.bw_count[ppdu_info->bw] += num_msdu;\n\t\trx_stats->byte_stats.bw_count[ppdu_info->bw] +=\n\t\t\t\t\t\tuser_stats->mpdu_ok_byte_count;\n\t}\n\n\tath12k_dp_mon_rx_update_peer_rate_table_stats(rx_stats, ppdu_info,\n\t\t\t\t\t\t      user_stats, num_msdu);\n}\n\nstatic void\nath12k_dp_mon_rx_update_peer_mu_stats(struct ath12k *ar,\n\t\t\t\t      struct hal_rx_mon_ppdu_info *ppdu_info)\n{\n\tu32 num_users, i;\n\n\tnum_users = ppdu_info->num_users;\n\tif (num_users > HAL_MAX_UL_MU_USERS)\n\t\tnum_users = HAL_MAX_UL_MU_USERS;\n\n\tfor (i = 0; i < num_users; i++)\n\t\tath12k_dp_mon_rx_update_user_stats(ar, ppdu_info, i);\n}\n\nint ath12k_dp_mon_rx_process_stats(struct ath12k *ar, int mac_id,\n\t\t\t\t   struct napi_struct *napi, int *budget)\n{\n\tstruct ath12k_base *ab = ar->ab;\n\tstruct ath12k_pdev_dp *pdev_dp = &ar->dp;\n\tstruct ath12k_mon_data *pmon = (struct ath12k_mon_data *)&pdev_dp->mon_data;\n\tstruct hal_rx_mon_ppdu_info *ppdu_info = &pmon->mon_ppdu_info;\n\tstruct ath12k_dp *dp = &ab->dp;\n\tstruct hal_mon_dest_desc *mon_dst_desc;\n\tstruct sk_buff *skb;\n\tstruct ath12k_skb_rxcb *rxcb;\n\tstruct dp_srng *mon_dst_ring;\n\tstruct hal_srng *srng;\n\tstruct dp_rxdma_ring *buf_ring;\n\tstruct ath12k_sta *arsta = NULL;\n\tstruct ath12k_peer *peer;\n\tu64 cookie;\n\tint num_buffs_reaped = 0, srng_id, buf_id;\n\tu8 dest_idx = 0, i;\n\tbool end_of_ppdu;\n\tu32 hal_status;\n\n\tsrng_id = ath12k_hw_mac_id_to_srng_id(ab->hw_params, mac_id);\n\tmon_dst_ring = &pdev_dp->rxdma_mon_dst_ring[srng_id];\n\tbuf_ring = &dp->rxdma_mon_buf_ring;\n\n\tsrng = &ab->hal.srng_list[mon_dst_ring->ring_id];\n\tspin_lock_bh(&srng->lock);\n\tath12k_hal_srng_access_begin(ab, srng);\n\n\twhile (likely(*budget)) {\n\t\t*budget -= 1;\n\t\tmon_dst_desc = ath12k_hal_srng_dst_peek(ab, srng);\n\t\tif (unlikely(!mon_dst_desc))\n\t\t\tbreak;\n\t\tcookie = le32_to_cpu(mon_dst_desc->cookie);\n\t\tbuf_id = u32_get_bits(cookie, DP_RXDMA_BUF_COOKIE_BUF_ID);\n\n\t\tspin_lock_bh(&buf_ring->idr_lock);\n\t\tskb = idr_remove(&buf_ring->bufs_idr, buf_id);\n\t\tspin_unlock_bh(&buf_ring->idr_lock);\n\n\t\tif (unlikely(!skb)) {\n\t\t\tath12k_warn(ab, \"monitor destination with invalid buf_id %d\\n\",\n\t\t\t\t    buf_id);\n\t\t\tgoto move_next;\n\t\t}\n\n\t\trxcb = ATH12K_SKB_RXCB(skb);\n\t\tdma_unmap_single(ab->dev, rxcb->paddr,\n\t\t\t\t skb->len + skb_tailroom(skb),\n\t\t\t\t DMA_FROM_DEVICE);\n\t\tpmon->dest_skb_q[dest_idx] = skb;\n\t\tdest_idx++;\n\t\tend_of_ppdu = le32_get_bits(mon_dst_desc->info0,\n\t\t\t\t\t    HAL_MON_DEST_INFO0_END_OF_PPDU);\n\t\tif (!end_of_ppdu)\n\t\t\tcontinue;\n\n\t\tfor (i = 0; i < dest_idx; i++) {\n\t\t\tskb = pmon->dest_skb_q[i];\n\t\t\thal_status = ath12k_dp_mon_parse_rx_dest(ab, pmon, skb);\n\n\t\t\tif (ppdu_info->peer_id == HAL_INVALID_PEERID ||\n\t\t\t    hal_status != HAL_RX_MON_STATUS_PPDU_DONE) {\n\t\t\t\tdev_kfree_skb_any(skb);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\trcu_read_lock();\n\t\t\tspin_lock_bh(&ab->base_lock);\n\t\t\tpeer = ath12k_peer_find_by_id(ab, ppdu_info->peer_id);\n\t\t\tif (!peer || !peer->sta) {\n\t\t\t\tath12k_dbg(ab, ATH12K_DBG_DATA,\n\t\t\t\t\t   \"failed to find the peer with peer_id %d\\n\",\n\t\t\t\t\t   ppdu_info->peer_id);\n\t\t\t\tspin_unlock_bh(&ab->base_lock);\n\t\t\t\trcu_read_unlock();\n\t\t\t\tdev_kfree_skb_any(skb);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (ppdu_info->reception_type == HAL_RX_RECEPTION_TYPE_SU) {\n\t\t\t\tarsta = (struct ath12k_sta *)peer->sta->drv_priv;\n\t\t\t\tath12k_dp_mon_rx_update_peer_su_stats(ar, arsta,\n\t\t\t\t\t\t\t\t      ppdu_info);\n\t\t\t} else if ((ppdu_info->fc_valid) &&\n\t\t\t\t   (ppdu_info->ast_index != HAL_AST_IDX_INVALID)) {\n\t\t\t\tath12k_dp_mon_rx_process_ulofdma(ppdu_info);\n\t\t\t\tath12k_dp_mon_rx_update_peer_mu_stats(ar, ppdu_info);\n\t\t\t}\n\n\t\t\tspin_unlock_bh(&ab->base_lock);\n\t\t\trcu_read_unlock();\n\t\t\tdev_kfree_skb_any(skb);\n\t\t\tmemset(ppdu_info, 0, sizeof(*ppdu_info));\n\t\t\tppdu_info->peer_id = HAL_INVALID_PEERID;\n\t\t}\n\n\t\tdest_idx = 0;\nmove_next:\n\t\tath12k_dp_mon_buf_replenish(ab, buf_ring, 1);\n\t\tath12k_hal_srng_src_get_next_entry(ab, srng);\n\t\tnum_buffs_reaped++;\n\t}\n\n\tath12k_hal_srng_access_end(ab, srng);\n\tspin_unlock_bh(&srng->lock);\n\treturn num_buffs_reaped;\n}\n\nint ath12k_dp_mon_process_ring(struct ath12k_base *ab, int mac_id,\n\t\t\t       struct napi_struct *napi, int budget,\n\t\t\t       enum dp_monitor_mode monitor_mode)\n{\n\tstruct ath12k *ar = ath12k_ab_to_ar(ab, mac_id);\n\tint num_buffs_reaped = 0;\n\n\tif (!ar->monitor_started)\n\t\tath12k_dp_mon_rx_process_stats(ar, mac_id, napi, &budget);\n\telse\n\t\tnum_buffs_reaped = ath12k_dp_mon_srng_process(ar, mac_id, &budget,\n\t\t\t\t\t\t\t      monitor_mode, napi);\n\n\treturn num_buffs_reaped;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}