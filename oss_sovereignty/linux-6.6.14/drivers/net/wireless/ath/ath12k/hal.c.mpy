{
  "module_name": "hal.c",
  "hash_id": "1ea3c76fc3e9810479b1394c10de1b3b353e90ce31d6c89534660b72e058f1e2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/ath12k/hal.c",
  "human_readable_source": "\n \n#include <linux/dma-mapping.h>\n#include \"hal_tx.h\"\n#include \"hal_rx.h\"\n#include \"debug.h\"\n#include \"hal_desc.h\"\n#include \"hif.h\"\n\nstatic const struct hal_srng_config hw_srng_config_template[] = {\n\t \n\t[HAL_REO_DST] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_REO2SW1,\n\t\t.max_rings = 8,\n\t\t.entry_size = sizeof(struct hal_reo_dest_ring) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_REO_REO2SW1_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_REO_EXCEPTION] = {\n\t\t \n\t\t.start_ring_id = HAL_SRNG_RING_ID_REO2SW0,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_reo_dest_ring) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_REO_REO2SW0_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_REO_REINJECT] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_SW2REO,\n\t\t.max_rings = 4,\n\t\t.entry_size = sizeof(struct hal_reo_entrance_ring) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_REO_SW2REO_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_REO_CMD] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_REO_CMD,\n\t\t.max_rings = 1,\n\t\t.entry_size = (sizeof(struct hal_tlv_64_hdr) +\n\t\t\tsizeof(struct hal_reo_get_queue_stats)) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_REO_CMD_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_REO_STATUS] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_REO_STATUS,\n\t\t.max_rings = 1,\n\t\t.entry_size = (sizeof(struct hal_tlv_64_hdr) +\n\t\t\tsizeof(struct hal_reo_get_queue_stats_status)) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_REO_STATUS_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_TCL_DATA] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_SW2TCL1,\n\t\t.max_rings = 6,\n\t\t.entry_size = sizeof(struct hal_tcl_data_cmd) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_SW2TCL1_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_TCL_CMD] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_SW2TCL_CMD,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_tcl_gse_cmd) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_SW2TCL1_CMD_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_TCL_STATUS] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_TCL_STATUS,\n\t\t.max_rings = 1,\n\t\t.entry_size = (sizeof(struct hal_tlv_hdr) +\n\t\t\t     sizeof(struct hal_tcl_status_ring)) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_TCL_STATUS_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_CE_SRC] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_CE0_SRC,\n\t\t.max_rings = 16,\n\t\t.entry_size = sizeof(struct hal_ce_srng_src_desc) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_CE_SRC_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_CE_DST] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_CE0_DST,\n\t\t.max_rings = 16,\n\t\t.entry_size = sizeof(struct hal_ce_srng_dest_desc) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_CE_DST_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_CE_DST_STATUS] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_CE0_DST_STATUS,\n\t\t.max_rings = 16,\n\t\t.entry_size = sizeof(struct hal_ce_srng_dst_status_desc) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_CE_DST_STATUS_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_WBM_IDLE_LINK] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_WBM_IDLE_LINK,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_wbm_link_desc) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_WBM_IDLE_LINK_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_SW2WBM_RELEASE] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_WBM_SW0_RELEASE,\n\t\t.max_rings = 2,\n\t\t.entry_size = sizeof(struct hal_wbm_release_ring) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_SW2WBM_RELEASE_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_WBM2SW_RELEASE] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_WBM2SW0_RELEASE,\n\t\t.max_rings = 8,\n\t\t.entry_size = sizeof(struct hal_wbm_release_ring) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_UMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_WBM2SW_RELEASE_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_RXDMA_BUF] = {\n\t\t.start_ring_id = HAL_SRNG_SW2RXDMA_BUF0,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_wbm_buffer_ring) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_DMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE_BE,\n\t},\n\t[HAL_RXDMA_DST] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_WMAC1_RXDMA2SW0,\n\t\t.max_rings = 0,\n\t\t.entry_size = 0,\n\t\t.mac_type = ATH12K_HAL_SRNG_PMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE_BE,\n\t},\n\t[HAL_RXDMA_MONITOR_BUF] = {\n\t\t.start_ring_id = HAL_SRNG_SW2RXMON_BUF0,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_mon_buf_ring) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_PMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE_BE,\n\t},\n\t[HAL_RXDMA_MONITOR_STATUS] = { 0, },\n\t[HAL_RXDMA_MONITOR_DESC] = { 0, },\n\t[HAL_RXDMA_DIR_BUF] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_RXDMA_DIR_BUF,\n\t\t.max_rings = 2,\n\t\t.entry_size = 8 >> 2,  \n\t\t.mac_type = ATH12K_HAL_SRNG_PMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE_BE,\n\t},\n\t[HAL_PPE2TCL] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_PPE2TCL1,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_tcl_entrance_from_ppe_ring) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_PMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_SW2TCL1_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_PPE_RELEASE] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_WBM_PPE_RELEASE,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_wbm_release_ring) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_PMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_WBM2PPE_RELEASE_RING_BASE_MSB_RING_SIZE,\n\t},\n\t[HAL_TX_MONITOR_BUF] = {\n\t\t.start_ring_id = HAL_SRNG_SW2TXMON_BUF0,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_mon_buf_ring) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_PMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_SRC,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE_BE,\n\t},\n\t[HAL_RXDMA_MONITOR_DST] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_WMAC1_SW2RXMON_BUF0,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_mon_dest_desc) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_PMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE_BE,\n\t},\n\t[HAL_TX_MONITOR_DST] = {\n\t\t.start_ring_id = HAL_SRNG_RING_ID_WMAC1_TXMON2SW0_BUF0,\n\t\t.max_rings = 1,\n\t\t.entry_size = sizeof(struct hal_mon_dest_desc) >> 2,\n\t\t.mac_type = ATH12K_HAL_SRNG_PMAC,\n\t\t.ring_dir = HAL_SRNG_DIR_DST,\n\t\t.max_size = HAL_RXDMA_RING_MAX_SIZE_BE,\n\t}\n};\n\nstatic const struct ath12k_hal_tcl_to_wbm_rbm_map\nath12k_hal_qcn9274_tcl_to_wbm_rbm_map[DP_TCL_NUM_RING_MAX] = {\n\t{\n\t\t.wbm_ring_num = 0,\n\t\t.rbm_id = HAL_RX_BUF_RBM_SW0_BM,\n\t},\n\t{\n\t\t.wbm_ring_num = 1,\n\t\t.rbm_id = HAL_RX_BUF_RBM_SW1_BM,\n\t},\n\t{\n\t\t.wbm_ring_num = 2,\n\t\t.rbm_id = HAL_RX_BUF_RBM_SW2_BM,\n\t},\n\t{\n\t\t.wbm_ring_num = 4,\n\t\t.rbm_id = HAL_RX_BUF_RBM_SW4_BM,\n\t}\n};\n\nstatic const struct ath12k_hal_tcl_to_wbm_rbm_map\nath12k_hal_wcn7850_tcl_to_wbm_rbm_map[DP_TCL_NUM_RING_MAX] = {\n\t{\n\t\t.wbm_ring_num = 0,\n\t\t.rbm_id = HAL_RX_BUF_RBM_SW0_BM,\n\t},\n\t{\n\t\t.wbm_ring_num = 2,\n\t\t.rbm_id = HAL_RX_BUF_RBM_SW2_BM,\n\t},\n\t{\n\t\t.wbm_ring_num = 4,\n\t\t.rbm_id = HAL_RX_BUF_RBM_SW4_BM,\n\t},\n};\n\nstatic unsigned int ath12k_hal_reo1_ring_id_offset(struct ath12k_base *ab)\n{\n\treturn HAL_REO1_RING_ID(ab) - HAL_REO1_RING_BASE_LSB(ab);\n}\n\nstatic unsigned int ath12k_hal_reo1_ring_msi1_base_lsb_offset(struct ath12k_base *ab)\n{\n\treturn HAL_REO1_RING_MSI1_BASE_LSB(ab) - HAL_REO1_RING_BASE_LSB(ab);\n}\n\nstatic unsigned int ath12k_hal_reo1_ring_msi1_base_msb_offset(struct ath12k_base *ab)\n{\n\treturn HAL_REO1_RING_MSI1_BASE_MSB(ab) - HAL_REO1_RING_BASE_LSB(ab);\n}\n\nstatic unsigned int ath12k_hal_reo1_ring_msi1_data_offset(struct ath12k_base *ab)\n{\n\treturn HAL_REO1_RING_MSI1_DATA(ab) - HAL_REO1_RING_BASE_LSB(ab);\n}\n\nstatic unsigned int ath12k_hal_reo1_ring_base_msb_offset(struct ath12k_base *ab)\n{\n\treturn HAL_REO1_RING_BASE_MSB(ab) - HAL_REO1_RING_BASE_LSB(ab);\n}\n\nstatic unsigned int ath12k_hal_reo1_ring_producer_int_setup_offset(struct ath12k_base *ab)\n{\n\treturn HAL_REO1_RING_PRODUCER_INT_SETUP(ab) - HAL_REO1_RING_BASE_LSB(ab);\n}\n\nstatic unsigned int ath12k_hal_reo1_ring_hp_addr_lsb_offset(struct ath12k_base *ab)\n{\n\treturn HAL_REO1_RING_HP_ADDR_LSB(ab) - HAL_REO1_RING_BASE_LSB(ab);\n}\n\nstatic unsigned int ath12k_hal_reo1_ring_hp_addr_msb_offset(struct ath12k_base *ab)\n{\n\treturn HAL_REO1_RING_HP_ADDR_MSB(ab) - HAL_REO1_RING_BASE_LSB(ab);\n}\n\nstatic unsigned int ath12k_hal_reo1_ring_misc_offset(struct ath12k_base *ab)\n{\n\treturn HAL_REO1_RING_MISC(ab) - HAL_REO1_RING_BASE_LSB(ab);\n}\n\nstatic bool ath12k_hw_qcn9274_rx_desc_get_first_msdu(struct hal_rx_desc *desc)\n{\n\treturn !!le16_get_bits(desc->u.qcn9274.msdu_end.info5,\n\t\t\t       RX_MSDU_END_INFO5_FIRST_MSDU);\n}\n\nstatic bool ath12k_hw_qcn9274_rx_desc_get_last_msdu(struct hal_rx_desc *desc)\n{\n\treturn !!le16_get_bits(desc->u.qcn9274.msdu_end.info5,\n\t\t\t       RX_MSDU_END_INFO5_LAST_MSDU);\n}\n\nstatic u8 ath12k_hw_qcn9274_rx_desc_get_l3_pad_bytes(struct hal_rx_desc *desc)\n{\n\treturn le16_get_bits(desc->u.qcn9274.msdu_end.info5,\n\t\t\t     RX_MSDU_END_INFO5_L3_HDR_PADDING);\n}\n\nstatic bool ath12k_hw_qcn9274_rx_desc_encrypt_valid(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.qcn9274.mpdu_start.info4,\n\t\t\t       RX_MPDU_START_INFO4_ENCRYPT_INFO_VALID);\n}\n\nstatic u32 ath12k_hw_qcn9274_rx_desc_get_encrypt_type(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.qcn9274.mpdu_start.info2,\n\t\t\t     RX_MPDU_START_INFO2_ENC_TYPE);\n}\n\nstatic u8 ath12k_hw_qcn9274_rx_desc_get_decap_type(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.qcn9274.msdu_end.info11,\n\t\t\t     RX_MSDU_END_INFO11_DECAP_FORMAT);\n}\n\nstatic u8 ath12k_hw_qcn9274_rx_desc_get_mesh_ctl(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.qcn9274.msdu_end.info11,\n\t\t\t     RX_MSDU_END_INFO11_MESH_CTRL_PRESENT);\n}\n\nstatic bool ath12k_hw_qcn9274_rx_desc_get_mpdu_seq_ctl_vld(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.qcn9274.mpdu_start.info4,\n\t\t\t       RX_MPDU_START_INFO4_MPDU_SEQ_CTRL_VALID);\n}\n\nstatic bool ath12k_hw_qcn9274_rx_desc_get_mpdu_fc_valid(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.qcn9274.mpdu_start.info4,\n\t\t\t       RX_MPDU_START_INFO4_MPDU_FCTRL_VALID);\n}\n\nstatic u16 ath12k_hw_qcn9274_rx_desc_get_mpdu_start_seq_no(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.qcn9274.mpdu_start.info4,\n\t\t\t     RX_MPDU_START_INFO4_MPDU_SEQ_NUM);\n}\n\nstatic u16 ath12k_hw_qcn9274_rx_desc_get_msdu_len(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.qcn9274.msdu_end.info10,\n\t\t\t     RX_MSDU_END_INFO10_MSDU_LENGTH);\n}\n\nstatic u8 ath12k_hw_qcn9274_rx_desc_get_msdu_sgi(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.qcn9274.msdu_end.info12,\n\t\t\t     RX_MSDU_END_INFO12_SGI);\n}\n\nstatic u8 ath12k_hw_qcn9274_rx_desc_get_msdu_rate_mcs(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.qcn9274.msdu_end.info12,\n\t\t\t     RX_MSDU_END_INFO12_RATE_MCS);\n}\n\nstatic u8 ath12k_hw_qcn9274_rx_desc_get_msdu_rx_bw(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.qcn9274.msdu_end.info12,\n\t\t\t     RX_MSDU_END_INFO12_RECV_BW);\n}\n\nstatic u32 ath12k_hw_qcn9274_rx_desc_get_msdu_freq(struct hal_rx_desc *desc)\n{\n\treturn __le32_to_cpu(desc->u.qcn9274.msdu_end.phy_meta_data);\n}\n\nstatic u8 ath12k_hw_qcn9274_rx_desc_get_msdu_pkt_type(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.qcn9274.msdu_end.info12,\n\t\t\t     RX_MSDU_END_INFO12_PKT_TYPE);\n}\n\nstatic u8 ath12k_hw_qcn9274_rx_desc_get_msdu_nss(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.qcn9274.msdu_end.info12,\n\t\t\t     RX_MSDU_END_INFO12_MIMO_SS_BITMAP);\n}\n\nstatic u8 ath12k_hw_qcn9274_rx_desc_get_mpdu_tid(struct hal_rx_desc *desc)\n{\n\treturn le16_get_bits(desc->u.qcn9274.msdu_end.info5,\n\t\t\t    RX_MSDU_END_INFO5_TID);\n}\n\nstatic u16 ath12k_hw_qcn9274_rx_desc_get_mpdu_peer_id(struct hal_rx_desc *desc)\n{\n\treturn __le16_to_cpu(desc->u.qcn9274.mpdu_start.sw_peer_id);\n}\n\nstatic void ath12k_hw_qcn9274_rx_desc_copy_end_tlv(struct hal_rx_desc *fdesc,\n\t\t\t\t\t\t   struct hal_rx_desc *ldesc)\n{\n\tmemcpy(&fdesc->u.qcn9274.msdu_end, &ldesc->u.qcn9274.msdu_end,\n\t       sizeof(struct rx_msdu_end_qcn9274));\n}\n\nstatic u32 ath12k_hw_qcn9274_rx_desc_get_mpdu_ppdu_id(struct hal_rx_desc *desc)\n{\n\treturn __le16_to_cpu(desc->u.qcn9274.mpdu_start.phy_ppdu_id);\n}\n\nstatic void ath12k_hw_qcn9274_rx_desc_set_msdu_len(struct hal_rx_desc *desc, u16 len)\n{\n\tu32 info = __le32_to_cpu(desc->u.qcn9274.msdu_end.info10);\n\n\tinfo &= ~RX_MSDU_END_INFO10_MSDU_LENGTH;\n\tinfo |= u32_encode_bits(len, RX_MSDU_END_INFO10_MSDU_LENGTH);\n\n\tdesc->u.qcn9274.msdu_end.info10 = __cpu_to_le32(info);\n}\n\nstatic u8 *ath12k_hw_qcn9274_rx_desc_get_msdu_payload(struct hal_rx_desc *desc)\n{\n\treturn &desc->u.qcn9274.msdu_payload[0];\n}\n\nstatic u32 ath12k_hw_qcn9274_rx_desc_get_mpdu_start_offset(void)\n{\n\treturn offsetof(struct hal_rx_desc_qcn9274, mpdu_start);\n}\n\nstatic u32 ath12k_hw_qcn9274_rx_desc_get_msdu_end_offset(void)\n{\n\treturn offsetof(struct hal_rx_desc_qcn9274, msdu_end);\n}\n\nstatic bool ath12k_hw_qcn9274_rx_desc_mac_addr2_valid(struct hal_rx_desc *desc)\n{\n\treturn __le32_to_cpu(desc->u.qcn9274.mpdu_start.info4) &\n\t       RX_MPDU_START_INFO4_MAC_ADDR2_VALID;\n}\n\nstatic u8 *ath12k_hw_qcn9274_rx_desc_mpdu_start_addr2(struct hal_rx_desc *desc)\n{\n\treturn desc->u.qcn9274.mpdu_start.addr2;\n}\n\nstatic bool ath12k_hw_qcn9274_rx_desc_is_da_mcbc(struct hal_rx_desc *desc)\n{\n\treturn __le16_to_cpu(desc->u.qcn9274.msdu_end.info5) &\n\t       RX_MSDU_END_INFO5_DA_IS_MCBC;\n}\n\nstatic void ath12k_hw_qcn9274_rx_desc_get_dot11_hdr(struct hal_rx_desc *desc,\n\t\t\t\t\t\t    struct ieee80211_hdr *hdr)\n{\n\thdr->frame_control = desc->u.qcn9274.mpdu_start.frame_ctrl;\n\thdr->duration_id = desc->u.qcn9274.mpdu_start.duration;\n\tether_addr_copy(hdr->addr1, desc->u.qcn9274.mpdu_start.addr1);\n\tether_addr_copy(hdr->addr2, desc->u.qcn9274.mpdu_start.addr2);\n\tether_addr_copy(hdr->addr3, desc->u.qcn9274.mpdu_start.addr3);\n\tif (__le32_to_cpu(desc->u.qcn9274.mpdu_start.info4) &\n\t\t\tRX_MPDU_START_INFO4_MAC_ADDR4_VALID) {\n\t\tether_addr_copy(hdr->addr4, desc->u.qcn9274.mpdu_start.addr4);\n\t}\n\thdr->seq_ctrl = desc->u.qcn9274.mpdu_start.seq_ctrl;\n}\n\nstatic void ath12k_hw_qcn9274_rx_desc_get_crypto_hdr(struct hal_rx_desc *desc,\n\t\t\t\t\t\t     u8 *crypto_hdr,\n\t\t\t\t\t\t     enum hal_encrypt_type enctype)\n{\n\tunsigned int key_id;\n\n\tswitch (enctype) {\n\tcase HAL_ENCRYPT_TYPE_OPEN:\n\t\treturn;\n\tcase HAL_ENCRYPT_TYPE_TKIP_NO_MIC:\n\tcase HAL_ENCRYPT_TYPE_TKIP_MIC:\n\t\tcrypto_hdr[0] =\n\t\t\tHAL_RX_MPDU_INFO_PN_GET_BYTE2(desc->u.qcn9274.mpdu_start.pn[0]);\n\t\tcrypto_hdr[1] = 0;\n\t\tcrypto_hdr[2] =\n\t\t\tHAL_RX_MPDU_INFO_PN_GET_BYTE1(desc->u.qcn9274.mpdu_start.pn[0]);\n\t\tbreak;\n\tcase HAL_ENCRYPT_TYPE_CCMP_128:\n\tcase HAL_ENCRYPT_TYPE_CCMP_256:\n\tcase HAL_ENCRYPT_TYPE_GCMP_128:\n\tcase HAL_ENCRYPT_TYPE_AES_GCMP_256:\n\t\tcrypto_hdr[0] =\n\t\t\tHAL_RX_MPDU_INFO_PN_GET_BYTE1(desc->u.qcn9274.mpdu_start.pn[0]);\n\t\tcrypto_hdr[1] =\n\t\t\tHAL_RX_MPDU_INFO_PN_GET_BYTE2(desc->u.qcn9274.mpdu_start.pn[0]);\n\t\tcrypto_hdr[2] = 0;\n\t\tbreak;\n\tcase HAL_ENCRYPT_TYPE_WEP_40:\n\tcase HAL_ENCRYPT_TYPE_WEP_104:\n\tcase HAL_ENCRYPT_TYPE_WEP_128:\n\tcase HAL_ENCRYPT_TYPE_WAPI_GCM_SM4:\n\tcase HAL_ENCRYPT_TYPE_WAPI:\n\t\treturn;\n\t}\n\tkey_id = le32_get_bits(desc->u.qcn9274.mpdu_start.info5,\n\t\t\t       RX_MPDU_START_INFO5_KEY_ID);\n\tcrypto_hdr[3] = 0x20 | (key_id << 6);\n\tcrypto_hdr[4] = HAL_RX_MPDU_INFO_PN_GET_BYTE3(desc->u.qcn9274.mpdu_start.pn[0]);\n\tcrypto_hdr[5] = HAL_RX_MPDU_INFO_PN_GET_BYTE4(desc->u.qcn9274.mpdu_start.pn[0]);\n\tcrypto_hdr[6] = HAL_RX_MPDU_INFO_PN_GET_BYTE1(desc->u.qcn9274.mpdu_start.pn[1]);\n\tcrypto_hdr[7] = HAL_RX_MPDU_INFO_PN_GET_BYTE2(desc->u.qcn9274.mpdu_start.pn[1]);\n}\n\nstatic u16 ath12k_hw_qcn9274_rx_desc_get_mpdu_frame_ctl(struct hal_rx_desc *desc)\n{\n\treturn __le16_to_cpu(desc->u.qcn9274.mpdu_start.frame_ctrl);\n}\n\nstatic int ath12k_hal_srng_create_config_qcn9274(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tstruct hal_srng_config *s;\n\n\thal->srng_config = kmemdup(hw_srng_config_template,\n\t\t\t\t   sizeof(hw_srng_config_template),\n\t\t\t\t   GFP_KERNEL);\n\tif (!hal->srng_config)\n\t\treturn -ENOMEM;\n\n\ts = &hal->srng_config[HAL_REO_DST];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO1_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO1_RING_HP;\n\ts->reg_size[0] = HAL_REO2_RING_BASE_LSB(ab) - HAL_REO1_RING_BASE_LSB(ab);\n\ts->reg_size[1] = HAL_REO2_RING_HP - HAL_REO1_RING_HP;\n\n\ts = &hal->srng_config[HAL_REO_EXCEPTION];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_SW0_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_SW0_RING_HP;\n\n\ts = &hal->srng_config[HAL_REO_REINJECT];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_SW2REO_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_SW2REO_RING_HP;\n\ts->reg_size[0] = HAL_SW2REO1_RING_BASE_LSB(ab) - HAL_SW2REO_RING_BASE_LSB(ab);\n\ts->reg_size[1] = HAL_SW2REO1_RING_HP - HAL_SW2REO_RING_HP;\n\n\ts = &hal->srng_config[HAL_REO_CMD];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_CMD_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_CMD_HP;\n\n\ts = &hal->srng_config[HAL_REO_STATUS];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_STATUS_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_STATUS_HP;\n\n\ts = &hal->srng_config[HAL_TCL_DATA];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL1_RING_BASE_LSB;\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL1_RING_HP;\n\ts->reg_size[0] = HAL_TCL2_RING_BASE_LSB - HAL_TCL1_RING_BASE_LSB;\n\ts->reg_size[1] = HAL_TCL2_RING_HP - HAL_TCL1_RING_HP;\n\n\ts = &hal->srng_config[HAL_TCL_CMD];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_RING_HP;\n\n\ts = &hal->srng_config[HAL_TCL_STATUS];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_STATUS_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_STATUS_RING_HP;\n\n\ts = &hal->srng_config[HAL_CE_SRC];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_CE0_SRC_REG + HAL_CE_DST_RING_BASE_LSB;\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_CE0_SRC_REG + HAL_CE_DST_RING_HP;\n\ts->reg_size[0] = HAL_SEQ_WCSS_UMAC_CE1_SRC_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_SRC_REG;\n\ts->reg_size[1] = HAL_SEQ_WCSS_UMAC_CE1_SRC_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_SRC_REG;\n\n\ts = &hal->srng_config[HAL_CE_DST];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG + HAL_CE_DST_RING_BASE_LSB;\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG + HAL_CE_DST_RING_HP;\n\ts->reg_size[0] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG;\n\ts->reg_size[1] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG;\n\n\ts = &hal->srng_config[HAL_CE_DST_STATUS];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG +\n\t\tHAL_CE_DST_STATUS_RING_BASE_LSB;\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG + HAL_CE_DST_STATUS_RING_HP;\n\ts->reg_size[0] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG;\n\ts->reg_size[1] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG;\n\n\ts = &hal->srng_config[HAL_WBM_IDLE_LINK];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_IDLE_LINK_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_IDLE_LINK_RING_HP;\n\n\ts = &hal->srng_config[HAL_SW2WBM_RELEASE];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\tHAL_WBM_SW_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_SW_RELEASE_RING_HP;\n\ts->reg_size[0] = HAL_WBM_SW1_RELEASE_RING_BASE_LSB(ab) -\n\t\t\t HAL_WBM_SW_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_size[1] = HAL_WBM_SW1_RELEASE_RING_HP - HAL_WBM_SW_RELEASE_RING_HP;\n\n\ts = &hal->srng_config[HAL_WBM2SW_RELEASE];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM0_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM0_RELEASE_RING_HP;\n\ts->reg_size[0] = HAL_WBM1_RELEASE_RING_BASE_LSB(ab) -\n\t\tHAL_WBM0_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_size[1] = HAL_WBM1_RELEASE_RING_HP - HAL_WBM0_RELEASE_RING_HP;\n\n\t \n\ts = &hal->srng_config[HAL_PPE2TCL];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_PPE2TCL1_RING_BASE_LSB;\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_PPE2TCL1_RING_HP;\n\n\ts = &hal->srng_config[HAL_PPE_RELEASE];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t\tHAL_WBM_PPE_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_PPE_RELEASE_RING_HP;\n\n\treturn 0;\n}\n\nstatic bool ath12k_hw_qcn9274_dp_rx_h_msdu_done(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.qcn9274.msdu_end.info14,\n\t\t\t       RX_MSDU_END_INFO14_MSDU_DONE);\n}\n\nstatic bool ath12k_hw_qcn9274_dp_rx_h_l4_cksum_fail(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.qcn9274.msdu_end.info13,\n\t\t\t       RX_MSDU_END_INFO13_TCP_UDP_CKSUM_FAIL);\n}\n\nstatic bool ath12k_hw_qcn9274_dp_rx_h_ip_cksum_fail(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.qcn9274.msdu_end.info13,\n\t\t\t       RX_MSDU_END_INFO13_IP_CKSUM_FAIL);\n}\n\nstatic bool ath12k_hw_qcn9274_dp_rx_h_is_decrypted(struct hal_rx_desc *desc)\n{\n\treturn (le32_get_bits(desc->u.qcn9274.msdu_end.info14,\n\t\t\t      RX_MSDU_END_INFO14_DECRYPT_STATUS_CODE) ==\n\t\t\t      RX_DESC_DECRYPT_STATUS_CODE_OK);\n}\n\nstatic u32 ath12k_hw_qcn9274_dp_rx_h_mpdu_err(struct hal_rx_desc *desc)\n{\n\tu32 info = __le32_to_cpu(desc->u.qcn9274.msdu_end.info13);\n\tu32 errmap = 0;\n\n\tif (info & RX_MSDU_END_INFO13_FCS_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_FCS;\n\n\tif (info & RX_MSDU_END_INFO13_DECRYPT_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_DECRYPT;\n\n\tif (info & RX_MSDU_END_INFO13_TKIP_MIC_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_TKIP_MIC;\n\n\tif (info & RX_MSDU_END_INFO13_A_MSDU_ERROR)\n\t\terrmap |= HAL_RX_MPDU_ERR_AMSDU_ERR;\n\n\tif (info & RX_MSDU_END_INFO13_OVERFLOW_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_OVERFLOW;\n\n\tif (info & RX_MSDU_END_INFO13_MSDU_LEN_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_MSDU_LEN;\n\n\tif (info & RX_MSDU_END_INFO13_MPDU_LEN_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_MPDU_LEN;\n\n\treturn errmap;\n}\n\nconst struct hal_ops hal_qcn9274_ops = {\n\t.rx_desc_get_first_msdu = ath12k_hw_qcn9274_rx_desc_get_first_msdu,\n\t.rx_desc_get_last_msdu = ath12k_hw_qcn9274_rx_desc_get_last_msdu,\n\t.rx_desc_get_l3_pad_bytes = ath12k_hw_qcn9274_rx_desc_get_l3_pad_bytes,\n\t.rx_desc_encrypt_valid = ath12k_hw_qcn9274_rx_desc_encrypt_valid,\n\t.rx_desc_get_encrypt_type = ath12k_hw_qcn9274_rx_desc_get_encrypt_type,\n\t.rx_desc_get_decap_type = ath12k_hw_qcn9274_rx_desc_get_decap_type,\n\t.rx_desc_get_mesh_ctl = ath12k_hw_qcn9274_rx_desc_get_mesh_ctl,\n\t.rx_desc_get_mpdu_seq_ctl_vld = ath12k_hw_qcn9274_rx_desc_get_mpdu_seq_ctl_vld,\n\t.rx_desc_get_mpdu_fc_valid = ath12k_hw_qcn9274_rx_desc_get_mpdu_fc_valid,\n\t.rx_desc_get_mpdu_start_seq_no = ath12k_hw_qcn9274_rx_desc_get_mpdu_start_seq_no,\n\t.rx_desc_get_msdu_len = ath12k_hw_qcn9274_rx_desc_get_msdu_len,\n\t.rx_desc_get_msdu_sgi = ath12k_hw_qcn9274_rx_desc_get_msdu_sgi,\n\t.rx_desc_get_msdu_rate_mcs = ath12k_hw_qcn9274_rx_desc_get_msdu_rate_mcs,\n\t.rx_desc_get_msdu_rx_bw = ath12k_hw_qcn9274_rx_desc_get_msdu_rx_bw,\n\t.rx_desc_get_msdu_freq = ath12k_hw_qcn9274_rx_desc_get_msdu_freq,\n\t.rx_desc_get_msdu_pkt_type = ath12k_hw_qcn9274_rx_desc_get_msdu_pkt_type,\n\t.rx_desc_get_msdu_nss = ath12k_hw_qcn9274_rx_desc_get_msdu_nss,\n\t.rx_desc_get_mpdu_tid = ath12k_hw_qcn9274_rx_desc_get_mpdu_tid,\n\t.rx_desc_get_mpdu_peer_id = ath12k_hw_qcn9274_rx_desc_get_mpdu_peer_id,\n\t.rx_desc_copy_end_tlv = ath12k_hw_qcn9274_rx_desc_copy_end_tlv,\n\t.rx_desc_get_mpdu_ppdu_id = ath12k_hw_qcn9274_rx_desc_get_mpdu_ppdu_id,\n\t.rx_desc_set_msdu_len = ath12k_hw_qcn9274_rx_desc_set_msdu_len,\n\t.rx_desc_get_msdu_payload = ath12k_hw_qcn9274_rx_desc_get_msdu_payload,\n\t.rx_desc_get_mpdu_start_offset = ath12k_hw_qcn9274_rx_desc_get_mpdu_start_offset,\n\t.rx_desc_get_msdu_end_offset = ath12k_hw_qcn9274_rx_desc_get_msdu_end_offset,\n\t.rx_desc_mac_addr2_valid = ath12k_hw_qcn9274_rx_desc_mac_addr2_valid,\n\t.rx_desc_mpdu_start_addr2 = ath12k_hw_qcn9274_rx_desc_mpdu_start_addr2,\n\t.rx_desc_is_da_mcbc = ath12k_hw_qcn9274_rx_desc_is_da_mcbc,\n\t.rx_desc_get_dot11_hdr = ath12k_hw_qcn9274_rx_desc_get_dot11_hdr,\n\t.rx_desc_get_crypto_header = ath12k_hw_qcn9274_rx_desc_get_crypto_hdr,\n\t.rx_desc_get_mpdu_frame_ctl = ath12k_hw_qcn9274_rx_desc_get_mpdu_frame_ctl,\n\t.create_srng_config = ath12k_hal_srng_create_config_qcn9274,\n\t.tcl_to_wbm_rbm_map = ath12k_hal_qcn9274_tcl_to_wbm_rbm_map,\n\t.dp_rx_h_msdu_done = ath12k_hw_qcn9274_dp_rx_h_msdu_done,\n\t.dp_rx_h_l4_cksum_fail = ath12k_hw_qcn9274_dp_rx_h_l4_cksum_fail,\n\t.dp_rx_h_ip_cksum_fail = ath12k_hw_qcn9274_dp_rx_h_ip_cksum_fail,\n\t.dp_rx_h_is_decrypted = ath12k_hw_qcn9274_dp_rx_h_is_decrypted,\n\t.dp_rx_h_mpdu_err = ath12k_hw_qcn9274_dp_rx_h_mpdu_err,\n};\n\nstatic bool ath12k_hw_wcn7850_rx_desc_get_first_msdu(struct hal_rx_desc *desc)\n{\n\treturn !!le16_get_bits(desc->u.wcn7850.msdu_end.info5,\n\t\t\t       RX_MSDU_END_INFO5_FIRST_MSDU);\n}\n\nstatic bool ath12k_hw_wcn7850_rx_desc_get_last_msdu(struct hal_rx_desc *desc)\n{\n\treturn !!le16_get_bits(desc->u.wcn7850.msdu_end.info5,\n\t\t\t       RX_MSDU_END_INFO5_LAST_MSDU);\n}\n\nstatic u8 ath12k_hw_wcn7850_rx_desc_get_l3_pad_bytes(struct hal_rx_desc *desc)\n{\n\treturn le16_get_bits(desc->u.wcn7850.msdu_end.info5,\n\t\t\t    RX_MSDU_END_INFO5_L3_HDR_PADDING);\n}\n\nstatic bool ath12k_hw_wcn7850_rx_desc_encrypt_valid(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.wcn7850.mpdu_start.info4,\n\t\t\t       RX_MPDU_START_INFO4_ENCRYPT_INFO_VALID);\n}\n\nstatic u32 ath12k_hw_wcn7850_rx_desc_get_encrypt_type(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.wcn7850.mpdu_start.info2,\n\t\t\t     RX_MPDU_START_INFO2_ENC_TYPE);\n}\n\nstatic u8 ath12k_hw_wcn7850_rx_desc_get_decap_type(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.wcn7850.msdu_end.info11,\n\t\t\t     RX_MSDU_END_INFO11_DECAP_FORMAT);\n}\n\nstatic u8 ath12k_hw_wcn7850_rx_desc_get_mesh_ctl(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.wcn7850.msdu_end.info11,\n\t\t\t     RX_MSDU_END_INFO11_MESH_CTRL_PRESENT);\n}\n\nstatic bool ath12k_hw_wcn7850_rx_desc_get_mpdu_seq_ctl_vld(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.wcn7850.mpdu_start.info4,\n\t\t\t       RX_MPDU_START_INFO4_MPDU_SEQ_CTRL_VALID);\n}\n\nstatic bool ath12k_hw_wcn7850_rx_desc_get_mpdu_fc_valid(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.wcn7850.mpdu_start.info4,\n\t\t\t       RX_MPDU_START_INFO4_MPDU_FCTRL_VALID);\n}\n\nstatic u16 ath12k_hw_wcn7850_rx_desc_get_mpdu_start_seq_no(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.wcn7850.mpdu_start.info4,\n\t\t\t     RX_MPDU_START_INFO4_MPDU_SEQ_NUM);\n}\n\nstatic u16 ath12k_hw_wcn7850_rx_desc_get_msdu_len(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.wcn7850.msdu_end.info10,\n\t\t\t     RX_MSDU_END_INFO10_MSDU_LENGTH);\n}\n\nstatic u8 ath12k_hw_wcn7850_rx_desc_get_msdu_sgi(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.wcn7850.msdu_end.info12,\n\t\t\t     RX_MSDU_END_INFO12_SGI);\n}\n\nstatic u8 ath12k_hw_wcn7850_rx_desc_get_msdu_rate_mcs(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.wcn7850.msdu_end.info12,\n\t\t\t     RX_MSDU_END_INFO12_RATE_MCS);\n}\n\nstatic u8 ath12k_hw_wcn7850_rx_desc_get_msdu_rx_bw(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.wcn7850.msdu_end.info12,\n\t\t\t     RX_MSDU_END_INFO12_RECV_BW);\n}\n\nstatic u32 ath12k_hw_wcn7850_rx_desc_get_msdu_freq(struct hal_rx_desc *desc)\n{\n\treturn __le32_to_cpu(desc->u.wcn7850.msdu_end.phy_meta_data);\n}\n\nstatic u8 ath12k_hw_wcn7850_rx_desc_get_msdu_pkt_type(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.wcn7850.msdu_end.info12,\n\t\t\t     RX_MSDU_END_INFO12_PKT_TYPE);\n}\n\nstatic u8 ath12k_hw_wcn7850_rx_desc_get_msdu_nss(struct hal_rx_desc *desc)\n{\n\treturn le32_get_bits(desc->u.wcn7850.msdu_end.info12,\n\t\t\t     RX_MSDU_END_INFO12_MIMO_SS_BITMAP);\n}\n\nstatic u8 ath12k_hw_wcn7850_rx_desc_get_mpdu_tid(struct hal_rx_desc *desc)\n{\n\treturn le16_get_bits(desc->u.wcn7850.msdu_end.info5,\n\t\t\t     RX_MSDU_END_INFO5_TID);\n}\n\nstatic u16 ath12k_hw_wcn7850_rx_desc_get_mpdu_peer_id(struct hal_rx_desc *desc)\n{\n\treturn __le16_to_cpu(desc->u.wcn7850.mpdu_start.sw_peer_id);\n}\n\nstatic void ath12k_hw_wcn7850_rx_desc_copy_end_tlv(struct hal_rx_desc *fdesc,\n\t\t\t\t\t\t   struct hal_rx_desc *ldesc)\n{\n\tmemcpy(&fdesc->u.wcn7850.msdu_end, &ldesc->u.wcn7850.msdu_end,\n\t       sizeof(struct rx_msdu_end_qcn9274));\n}\n\nstatic u32 ath12k_hw_wcn7850_rx_desc_get_mpdu_start_tag(struct hal_rx_desc *desc)\n{\n\treturn le64_get_bits(desc->u.wcn7850.mpdu_start_tag,\n\t\t\t    HAL_TLV_HDR_TAG);\n}\n\nstatic u32 ath12k_hw_wcn7850_rx_desc_get_mpdu_ppdu_id(struct hal_rx_desc *desc)\n{\n\treturn __le16_to_cpu(desc->u.wcn7850.mpdu_start.phy_ppdu_id);\n}\n\nstatic void ath12k_hw_wcn7850_rx_desc_set_msdu_len(struct hal_rx_desc *desc, u16 len)\n{\n\tu32 info = __le32_to_cpu(desc->u.wcn7850.msdu_end.info10);\n\n\tinfo &= ~RX_MSDU_END_INFO10_MSDU_LENGTH;\n\tinfo |= u32_encode_bits(len, RX_MSDU_END_INFO10_MSDU_LENGTH);\n\n\tdesc->u.wcn7850.msdu_end.info10 = __cpu_to_le32(info);\n}\n\nstatic u8 *ath12k_hw_wcn7850_rx_desc_get_msdu_payload(struct hal_rx_desc *desc)\n{\n\treturn &desc->u.wcn7850.msdu_payload[0];\n}\n\nstatic u32 ath12k_hw_wcn7850_rx_desc_get_mpdu_start_offset(void)\n{\n\treturn offsetof(struct hal_rx_desc_wcn7850, mpdu_start_tag);\n}\n\nstatic u32 ath12k_hw_wcn7850_rx_desc_get_msdu_end_offset(void)\n{\n\treturn offsetof(struct hal_rx_desc_wcn7850, msdu_end_tag);\n}\n\nstatic bool ath12k_hw_wcn7850_rx_desc_mac_addr2_valid(struct hal_rx_desc *desc)\n{\n\treturn __le32_to_cpu(desc->u.wcn7850.mpdu_start.info4) &\n\t       RX_MPDU_START_INFO4_MAC_ADDR2_VALID;\n}\n\nstatic u8 *ath12k_hw_wcn7850_rx_desc_mpdu_start_addr2(struct hal_rx_desc *desc)\n{\n\treturn desc->u.wcn7850.mpdu_start.addr2;\n}\n\nstatic bool ath12k_hw_wcn7850_rx_desc_is_da_mcbc(struct hal_rx_desc *desc)\n{\n\treturn __le16_to_cpu(desc->u.wcn7850.msdu_end.info5) &\n\t       RX_MSDU_END_INFO5_DA_IS_MCBC;\n}\n\nstatic void ath12k_hw_wcn7850_rx_desc_get_dot11_hdr(struct hal_rx_desc *desc,\n\t\t\t\t\t\t    struct ieee80211_hdr *hdr)\n{\n\thdr->frame_control = desc->u.wcn7850.mpdu_start.frame_ctrl;\n\thdr->duration_id = desc->u.wcn7850.mpdu_start.duration;\n\tether_addr_copy(hdr->addr1, desc->u.wcn7850.mpdu_start.addr1);\n\tether_addr_copy(hdr->addr2, desc->u.wcn7850.mpdu_start.addr2);\n\tether_addr_copy(hdr->addr3, desc->u.wcn7850.mpdu_start.addr3);\n\tif (__le32_to_cpu(desc->u.wcn7850.mpdu_start.info4) &\n\t\t\tRX_MPDU_START_INFO4_MAC_ADDR4_VALID) {\n\t\tether_addr_copy(hdr->addr4, desc->u.wcn7850.mpdu_start.addr4);\n\t}\n\thdr->seq_ctrl = desc->u.wcn7850.mpdu_start.seq_ctrl;\n}\n\nstatic void ath12k_hw_wcn7850_rx_desc_get_crypto_hdr(struct hal_rx_desc *desc,\n\t\t\t\t\t\t     u8 *crypto_hdr,\n\t\t\t\t\t\t     enum hal_encrypt_type enctype)\n{\n\tunsigned int key_id;\n\n\tswitch (enctype) {\n\tcase HAL_ENCRYPT_TYPE_OPEN:\n\t\treturn;\n\tcase HAL_ENCRYPT_TYPE_TKIP_NO_MIC:\n\tcase HAL_ENCRYPT_TYPE_TKIP_MIC:\n\t\tcrypto_hdr[0] =\n\t\t\tHAL_RX_MPDU_INFO_PN_GET_BYTE2(desc->u.wcn7850.mpdu_start.pn[0]);\n\t\tcrypto_hdr[1] = 0;\n\t\tcrypto_hdr[2] =\n\t\t\tHAL_RX_MPDU_INFO_PN_GET_BYTE1(desc->u.wcn7850.mpdu_start.pn[0]);\n\t\tbreak;\n\tcase HAL_ENCRYPT_TYPE_CCMP_128:\n\tcase HAL_ENCRYPT_TYPE_CCMP_256:\n\tcase HAL_ENCRYPT_TYPE_GCMP_128:\n\tcase HAL_ENCRYPT_TYPE_AES_GCMP_256:\n\t\tcrypto_hdr[0] =\n\t\t\tHAL_RX_MPDU_INFO_PN_GET_BYTE1(desc->u.wcn7850.mpdu_start.pn[0]);\n\t\tcrypto_hdr[1] =\n\t\t\tHAL_RX_MPDU_INFO_PN_GET_BYTE2(desc->u.wcn7850.mpdu_start.pn[0]);\n\t\tcrypto_hdr[2] = 0;\n\t\tbreak;\n\tcase HAL_ENCRYPT_TYPE_WEP_40:\n\tcase HAL_ENCRYPT_TYPE_WEP_104:\n\tcase HAL_ENCRYPT_TYPE_WEP_128:\n\tcase HAL_ENCRYPT_TYPE_WAPI_GCM_SM4:\n\tcase HAL_ENCRYPT_TYPE_WAPI:\n\t\treturn;\n\t}\n\tkey_id = u32_get_bits(__le32_to_cpu(desc->u.wcn7850.mpdu_start.info5),\n\t\t\t      RX_MPDU_START_INFO5_KEY_ID);\n\tcrypto_hdr[3] = 0x20 | (key_id << 6);\n\tcrypto_hdr[4] = HAL_RX_MPDU_INFO_PN_GET_BYTE3(desc->u.wcn7850.mpdu_start.pn[0]);\n\tcrypto_hdr[5] = HAL_RX_MPDU_INFO_PN_GET_BYTE4(desc->u.wcn7850.mpdu_start.pn[0]);\n\tcrypto_hdr[6] = HAL_RX_MPDU_INFO_PN_GET_BYTE1(desc->u.wcn7850.mpdu_start.pn[1]);\n\tcrypto_hdr[7] = HAL_RX_MPDU_INFO_PN_GET_BYTE2(desc->u.wcn7850.mpdu_start.pn[1]);\n}\n\nstatic u16 ath12k_hw_wcn7850_rx_desc_get_mpdu_frame_ctl(struct hal_rx_desc *desc)\n{\n\treturn __le16_to_cpu(desc->u.wcn7850.mpdu_start.frame_ctrl);\n}\n\nstatic int ath12k_hal_srng_create_config_wcn7850(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tstruct hal_srng_config *s;\n\n\thal->srng_config = kmemdup(hw_srng_config_template,\n\t\t\t\t   sizeof(hw_srng_config_template),\n\t\t\t\t   GFP_KERNEL);\n\tif (!hal->srng_config)\n\t\treturn -ENOMEM;\n\n\ts = &hal->srng_config[HAL_REO_DST];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO1_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO1_RING_HP;\n\ts->reg_size[0] = HAL_REO2_RING_BASE_LSB(ab) - HAL_REO1_RING_BASE_LSB(ab);\n\ts->reg_size[1] = HAL_REO2_RING_HP - HAL_REO1_RING_HP;\n\n\ts = &hal->srng_config[HAL_REO_EXCEPTION];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_SW0_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_SW0_RING_HP;\n\n\ts = &hal->srng_config[HAL_REO_REINJECT];\n\ts->max_rings = 1;\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_SW2REO_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_SW2REO_RING_HP;\n\n\ts = &hal->srng_config[HAL_REO_CMD];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_CMD_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_CMD_HP;\n\n\ts = &hal->srng_config[HAL_REO_STATUS];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_STATUS_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_REO_REG + HAL_REO_STATUS_HP;\n\n\ts = &hal->srng_config[HAL_TCL_DATA];\n\ts->max_rings = 5;\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL1_RING_BASE_LSB;\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL1_RING_HP;\n\ts->reg_size[0] = HAL_TCL2_RING_BASE_LSB - HAL_TCL1_RING_BASE_LSB;\n\ts->reg_size[1] = HAL_TCL2_RING_HP - HAL_TCL1_RING_HP;\n\n\ts = &hal->srng_config[HAL_TCL_CMD];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_RING_HP;\n\n\ts = &hal->srng_config[HAL_TCL_STATUS];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_STATUS_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_TCL_REG + HAL_TCL_STATUS_RING_HP;\n\n\ts = &hal->srng_config[HAL_CE_SRC];\n\ts->max_rings = 12;\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_CE0_SRC_REG + HAL_CE_DST_RING_BASE_LSB;\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_CE0_SRC_REG + HAL_CE_DST_RING_HP;\n\ts->reg_size[0] = HAL_SEQ_WCSS_UMAC_CE1_SRC_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_SRC_REG;\n\ts->reg_size[1] = HAL_SEQ_WCSS_UMAC_CE1_SRC_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_SRC_REG;\n\n\ts = &hal->srng_config[HAL_CE_DST];\n\ts->max_rings = 12;\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG + HAL_CE_DST_RING_BASE_LSB;\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG + HAL_CE_DST_RING_HP;\n\ts->reg_size[0] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG;\n\ts->reg_size[1] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG;\n\n\ts = &hal->srng_config[HAL_CE_DST_STATUS];\n\ts->max_rings = 12;\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG +\n\t\tHAL_CE_DST_STATUS_RING_BASE_LSB;\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_CE0_DST_REG + HAL_CE_DST_STATUS_RING_HP;\n\ts->reg_size[0] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG;\n\ts->reg_size[1] = HAL_SEQ_WCSS_UMAC_CE1_DST_REG -\n\t\tHAL_SEQ_WCSS_UMAC_CE0_DST_REG;\n\n\ts = &hal->srng_config[HAL_WBM_IDLE_LINK];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_IDLE_LINK_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_IDLE_LINK_RING_HP;\n\n\ts = &hal->srng_config[HAL_SW2WBM_RELEASE];\n\ts->max_rings = 1;\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\tHAL_WBM_SW_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_SW_RELEASE_RING_HP;\n\n\ts = &hal->srng_config[HAL_WBM2SW_RELEASE];\n\ts->reg_start[0] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM0_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_start[1] = HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM0_RELEASE_RING_HP;\n\ts->reg_size[0] = HAL_WBM1_RELEASE_RING_BASE_LSB(ab) -\n\t\tHAL_WBM0_RELEASE_RING_BASE_LSB(ab);\n\ts->reg_size[1] = HAL_WBM1_RELEASE_RING_HP - HAL_WBM0_RELEASE_RING_HP;\n\n\ts = &hal->srng_config[HAL_RXDMA_BUF];\n\ts->max_rings = 2;\n\ts->mac_type = ATH12K_HAL_SRNG_PMAC;\n\n\ts = &hal->srng_config[HAL_RXDMA_DST];\n\ts->max_rings = 1;\n\ts->entry_size = sizeof(struct hal_reo_entrance_ring) >> 2;\n\n\t \n\ts = &hal->srng_config[HAL_RXDMA_DIR_BUF];\n\ts->max_rings = 0;\n\n\ts = &hal->srng_config[HAL_PPE2TCL];\n\ts->max_rings = 0;\n\n\ts = &hal->srng_config[HAL_PPE_RELEASE];\n\ts->max_rings = 0;\n\n\ts = &hal->srng_config[HAL_TX_MONITOR_BUF];\n\ts->max_rings = 0;\n\n\ts = &hal->srng_config[HAL_TX_MONITOR_DST];\n\ts->max_rings = 0;\n\n\ts = &hal->srng_config[HAL_PPE2TCL];\n\ts->max_rings = 0;\n\n\treturn 0;\n}\n\nstatic bool ath12k_hw_wcn7850_dp_rx_h_msdu_done(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.wcn7850.msdu_end.info14,\n\t\t\t       RX_MSDU_END_INFO14_MSDU_DONE);\n}\n\nstatic bool ath12k_hw_wcn7850_dp_rx_h_l4_cksum_fail(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.wcn7850.msdu_end.info13,\n\t\t\t       RX_MSDU_END_INFO13_TCP_UDP_CKSUM_FAIL);\n}\n\nstatic bool ath12k_hw_wcn7850_dp_rx_h_ip_cksum_fail(struct hal_rx_desc *desc)\n{\n\treturn !!le32_get_bits(desc->u.wcn7850.msdu_end.info13,\n\t\t\t      RX_MSDU_END_INFO13_IP_CKSUM_FAIL);\n}\n\nstatic bool ath12k_hw_wcn7850_dp_rx_h_is_decrypted(struct hal_rx_desc *desc)\n{\n\treturn (le32_get_bits(desc->u.wcn7850.msdu_end.info14,\n\t\t\t      RX_MSDU_END_INFO14_DECRYPT_STATUS_CODE) ==\n\t\t\t      RX_DESC_DECRYPT_STATUS_CODE_OK);\n}\n\nstatic u32 ath12k_hw_wcn7850_dp_rx_h_mpdu_err(struct hal_rx_desc *desc)\n{\n\tu32 info = __le32_to_cpu(desc->u.wcn7850.msdu_end.info13);\n\tu32 errmap = 0;\n\n\tif (info & RX_MSDU_END_INFO13_FCS_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_FCS;\n\n\tif (info & RX_MSDU_END_INFO13_DECRYPT_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_DECRYPT;\n\n\tif (info & RX_MSDU_END_INFO13_TKIP_MIC_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_TKIP_MIC;\n\n\tif (info & RX_MSDU_END_INFO13_A_MSDU_ERROR)\n\t\terrmap |= HAL_RX_MPDU_ERR_AMSDU_ERR;\n\n\tif (info & RX_MSDU_END_INFO13_OVERFLOW_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_OVERFLOW;\n\n\tif (info & RX_MSDU_END_INFO13_MSDU_LEN_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_MSDU_LEN;\n\n\tif (info & RX_MSDU_END_INFO13_MPDU_LEN_ERR)\n\t\terrmap |= HAL_RX_MPDU_ERR_MPDU_LEN;\n\n\treturn errmap;\n}\n\nconst struct hal_ops hal_wcn7850_ops = {\n\t.rx_desc_get_first_msdu = ath12k_hw_wcn7850_rx_desc_get_first_msdu,\n\t.rx_desc_get_last_msdu = ath12k_hw_wcn7850_rx_desc_get_last_msdu,\n\t.rx_desc_get_l3_pad_bytes = ath12k_hw_wcn7850_rx_desc_get_l3_pad_bytes,\n\t.rx_desc_encrypt_valid = ath12k_hw_wcn7850_rx_desc_encrypt_valid,\n\t.rx_desc_get_encrypt_type = ath12k_hw_wcn7850_rx_desc_get_encrypt_type,\n\t.rx_desc_get_decap_type = ath12k_hw_wcn7850_rx_desc_get_decap_type,\n\t.rx_desc_get_mesh_ctl = ath12k_hw_wcn7850_rx_desc_get_mesh_ctl,\n\t.rx_desc_get_mpdu_seq_ctl_vld = ath12k_hw_wcn7850_rx_desc_get_mpdu_seq_ctl_vld,\n\t.rx_desc_get_mpdu_fc_valid = ath12k_hw_wcn7850_rx_desc_get_mpdu_fc_valid,\n\t.rx_desc_get_mpdu_start_seq_no = ath12k_hw_wcn7850_rx_desc_get_mpdu_start_seq_no,\n\t.rx_desc_get_msdu_len = ath12k_hw_wcn7850_rx_desc_get_msdu_len,\n\t.rx_desc_get_msdu_sgi = ath12k_hw_wcn7850_rx_desc_get_msdu_sgi,\n\t.rx_desc_get_msdu_rate_mcs = ath12k_hw_wcn7850_rx_desc_get_msdu_rate_mcs,\n\t.rx_desc_get_msdu_rx_bw = ath12k_hw_wcn7850_rx_desc_get_msdu_rx_bw,\n\t.rx_desc_get_msdu_freq = ath12k_hw_wcn7850_rx_desc_get_msdu_freq,\n\t.rx_desc_get_msdu_pkt_type = ath12k_hw_wcn7850_rx_desc_get_msdu_pkt_type,\n\t.rx_desc_get_msdu_nss = ath12k_hw_wcn7850_rx_desc_get_msdu_nss,\n\t.rx_desc_get_mpdu_tid = ath12k_hw_wcn7850_rx_desc_get_mpdu_tid,\n\t.rx_desc_get_mpdu_peer_id = ath12k_hw_wcn7850_rx_desc_get_mpdu_peer_id,\n\t.rx_desc_copy_end_tlv = ath12k_hw_wcn7850_rx_desc_copy_end_tlv,\n\t.rx_desc_get_mpdu_start_tag = ath12k_hw_wcn7850_rx_desc_get_mpdu_start_tag,\n\t.rx_desc_get_mpdu_ppdu_id = ath12k_hw_wcn7850_rx_desc_get_mpdu_ppdu_id,\n\t.rx_desc_set_msdu_len = ath12k_hw_wcn7850_rx_desc_set_msdu_len,\n\t.rx_desc_get_msdu_payload = ath12k_hw_wcn7850_rx_desc_get_msdu_payload,\n\t.rx_desc_get_mpdu_start_offset = ath12k_hw_wcn7850_rx_desc_get_mpdu_start_offset,\n\t.rx_desc_get_msdu_end_offset = ath12k_hw_wcn7850_rx_desc_get_msdu_end_offset,\n\t.rx_desc_mac_addr2_valid = ath12k_hw_wcn7850_rx_desc_mac_addr2_valid,\n\t.rx_desc_mpdu_start_addr2 = ath12k_hw_wcn7850_rx_desc_mpdu_start_addr2,\n\t.rx_desc_is_da_mcbc = ath12k_hw_wcn7850_rx_desc_is_da_mcbc,\n\t.rx_desc_get_dot11_hdr = ath12k_hw_wcn7850_rx_desc_get_dot11_hdr,\n\t.rx_desc_get_crypto_header = ath12k_hw_wcn7850_rx_desc_get_crypto_hdr,\n\t.rx_desc_get_mpdu_frame_ctl = ath12k_hw_wcn7850_rx_desc_get_mpdu_frame_ctl,\n\t.create_srng_config = ath12k_hal_srng_create_config_wcn7850,\n\t.tcl_to_wbm_rbm_map = ath12k_hal_wcn7850_tcl_to_wbm_rbm_map,\n\t.dp_rx_h_msdu_done = ath12k_hw_wcn7850_dp_rx_h_msdu_done,\n\t.dp_rx_h_l4_cksum_fail = ath12k_hw_wcn7850_dp_rx_h_l4_cksum_fail,\n\t.dp_rx_h_ip_cksum_fail = ath12k_hw_wcn7850_dp_rx_h_ip_cksum_fail,\n\t.dp_rx_h_is_decrypted = ath12k_hw_wcn7850_dp_rx_h_is_decrypted,\n\t.dp_rx_h_mpdu_err = ath12k_hw_wcn7850_dp_rx_h_mpdu_err,\n};\n\nstatic int ath12k_hal_alloc_cont_rdp(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tsize_t size;\n\n\tsize = sizeof(u32) * HAL_SRNG_RING_ID_MAX;\n\thal->rdp.vaddr = dma_alloc_coherent(ab->dev, size, &hal->rdp.paddr,\n\t\t\t\t\t    GFP_KERNEL);\n\tif (!hal->rdp.vaddr)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\nstatic void ath12k_hal_free_cont_rdp(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tsize_t size;\n\n\tif (!hal->rdp.vaddr)\n\t\treturn;\n\n\tsize = sizeof(u32) * HAL_SRNG_RING_ID_MAX;\n\tdma_free_coherent(ab->dev, size,\n\t\t\t  hal->rdp.vaddr, hal->rdp.paddr);\n\thal->rdp.vaddr = NULL;\n}\n\nstatic int ath12k_hal_alloc_cont_wrp(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tsize_t size;\n\n\tsize = sizeof(u32) * (HAL_SRNG_NUM_PMAC_RINGS + HAL_SRNG_NUM_DMAC_RINGS);\n\thal->wrp.vaddr = dma_alloc_coherent(ab->dev, size, &hal->wrp.paddr,\n\t\t\t\t\t    GFP_KERNEL);\n\tif (!hal->wrp.vaddr)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\nstatic void ath12k_hal_free_cont_wrp(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tsize_t size;\n\n\tif (!hal->wrp.vaddr)\n\t\treturn;\n\n\tsize = sizeof(u32) * (HAL_SRNG_NUM_PMAC_RINGS + HAL_SRNG_NUM_DMAC_RINGS);\n\tdma_free_coherent(ab->dev, size,\n\t\t\t  hal->wrp.vaddr, hal->wrp.paddr);\n\thal->wrp.vaddr = NULL;\n}\n\nstatic void ath12k_hal_ce_dst_setup(struct ath12k_base *ab,\n\t\t\t\t    struct hal_srng *srng, int ring_num)\n{\n\tstruct hal_srng_config *srng_config = &ab->hal.srng_config[HAL_CE_DST];\n\tu32 addr;\n\tu32 val;\n\n\taddr = HAL_CE_DST_RING_CTRL +\n\t       srng_config->reg_start[HAL_SRNG_REG_GRP_R0] +\n\t       ring_num * srng_config->reg_size[HAL_SRNG_REG_GRP_R0];\n\n\tval = ath12k_hif_read32(ab, addr);\n\tval &= ~HAL_CE_DST_R0_DEST_CTRL_MAX_LEN;\n\tval |= u32_encode_bits(srng->u.dst_ring.max_buffer_length,\n\t\t\t       HAL_CE_DST_R0_DEST_CTRL_MAX_LEN);\n\tath12k_hif_write32(ab, addr, val);\n}\n\nstatic void ath12k_hal_srng_dst_hw_init(struct ath12k_base *ab,\n\t\t\t\t\tstruct hal_srng *srng)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tu32 val;\n\tu64 hp_addr;\n\tu32 reg_base;\n\n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R0];\n\n\tif (srng->flags & HAL_SRNG_FLAGS_MSI_INTR) {\n\t\tath12k_hif_write32(ab, reg_base +\n\t\t\t\t   ath12k_hal_reo1_ring_msi1_base_lsb_offset(ab),\n\t\t\t\t   srng->msi_addr);\n\n\t\tval = u32_encode_bits(((u64)srng->msi_addr >> HAL_ADDR_MSB_REG_SHIFT),\n\t\t\t\t      HAL_REO1_RING_MSI1_BASE_MSB_ADDR) |\n\t\t\t\t      HAL_REO1_RING_MSI1_BASE_MSB_MSI1_ENABLE;\n\t\tath12k_hif_write32(ab, reg_base +\n\t\t\t\t   ath12k_hal_reo1_ring_msi1_base_msb_offset(ab), val);\n\n\t\tath12k_hif_write32(ab,\n\t\t\t\t   reg_base + ath12k_hal_reo1_ring_msi1_data_offset(ab),\n\t\t\t\t   srng->msi_data);\n\t}\n\n\tath12k_hif_write32(ab, reg_base, srng->ring_base_paddr);\n\n\tval = u32_encode_bits(((u64)srng->ring_base_paddr >> HAL_ADDR_MSB_REG_SHIFT),\n\t\t\t      HAL_REO1_RING_BASE_MSB_RING_BASE_ADDR_MSB) |\n\t      u32_encode_bits((srng->entry_size * srng->num_entries),\n\t\t\t      HAL_REO1_RING_BASE_MSB_RING_SIZE);\n\tath12k_hif_write32(ab, reg_base + ath12k_hal_reo1_ring_base_msb_offset(ab), val);\n\n\tval = u32_encode_bits(srng->ring_id, HAL_REO1_RING_ID_RING_ID) |\n\t      u32_encode_bits(srng->entry_size, HAL_REO1_RING_ID_ENTRY_SIZE);\n\tath12k_hif_write32(ab, reg_base + ath12k_hal_reo1_ring_id_offset(ab), val);\n\n\t \n\tval = u32_encode_bits((srng->intr_timer_thres_us >> 3),\n\t\t\t      HAL_REO1_RING_PRDR_INT_SETUP_INTR_TMR_THOLD);\n\n\tval |= u32_encode_bits((srng->intr_batch_cntr_thres_entries * srng->entry_size),\n\t\t\t\tHAL_REO1_RING_PRDR_INT_SETUP_BATCH_COUNTER_THOLD);\n\n\tath12k_hif_write32(ab,\n\t\t\t   reg_base + ath12k_hal_reo1_ring_producer_int_setup_offset(ab),\n\t\t\t   val);\n\n\thp_addr = hal->rdp.paddr +\n\t\t  ((unsigned long)srng->u.dst_ring.hp_addr -\n\t\t   (unsigned long)hal->rdp.vaddr);\n\tath12k_hif_write32(ab, reg_base + ath12k_hal_reo1_ring_hp_addr_lsb_offset(ab),\n\t\t\t   hp_addr & HAL_ADDR_LSB_REG_MASK);\n\tath12k_hif_write32(ab, reg_base + ath12k_hal_reo1_ring_hp_addr_msb_offset(ab),\n\t\t\t   hp_addr >> HAL_ADDR_MSB_REG_SHIFT);\n\n\t \n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R2];\n\tath12k_hif_write32(ab, reg_base, 0);\n\tath12k_hif_write32(ab, reg_base + HAL_REO1_RING_TP_OFFSET, 0);\n\t*srng->u.dst_ring.hp_addr = 0;\n\n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R0];\n\tval = 0;\n\tif (srng->flags & HAL_SRNG_FLAGS_DATA_TLV_SWAP)\n\t\tval |= HAL_REO1_RING_MISC_DATA_TLV_SWAP;\n\tif (srng->flags & HAL_SRNG_FLAGS_RING_PTR_SWAP)\n\t\tval |= HAL_REO1_RING_MISC_HOST_FW_SWAP;\n\tif (srng->flags & HAL_SRNG_FLAGS_MSI_SWAP)\n\t\tval |= HAL_REO1_RING_MISC_MSI_SWAP;\n\tval |= HAL_REO1_RING_MISC_SRNG_ENABLE;\n\n\tath12k_hif_write32(ab, reg_base + ath12k_hal_reo1_ring_misc_offset(ab), val);\n}\n\nstatic void ath12k_hal_srng_src_hw_init(struct ath12k_base *ab,\n\t\t\t\t\tstruct hal_srng *srng)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tu32 val;\n\tu64 tp_addr;\n\tu32 reg_base;\n\n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R0];\n\n\tif (srng->flags & HAL_SRNG_FLAGS_MSI_INTR) {\n\t\tath12k_hif_write32(ab, reg_base +\n\t\t\t\t   HAL_TCL1_RING_MSI1_BASE_LSB_OFFSET(ab),\n\t\t\t\t   srng->msi_addr);\n\n\t\tval = u32_encode_bits(((u64)srng->msi_addr >> HAL_ADDR_MSB_REG_SHIFT),\n\t\t\t\t      HAL_TCL1_RING_MSI1_BASE_MSB_ADDR) |\n\t\t\t\t      HAL_TCL1_RING_MSI1_BASE_MSB_MSI1_ENABLE;\n\t\tath12k_hif_write32(ab, reg_base +\n\t\t\t\t       HAL_TCL1_RING_MSI1_BASE_MSB_OFFSET(ab),\n\t\t\t\t   val);\n\n\t\tath12k_hif_write32(ab, reg_base +\n\t\t\t\t       HAL_TCL1_RING_MSI1_DATA_OFFSET(ab),\n\t\t\t\t   srng->msi_data);\n\t}\n\n\tath12k_hif_write32(ab, reg_base, srng->ring_base_paddr);\n\n\tval = u32_encode_bits(((u64)srng->ring_base_paddr >> HAL_ADDR_MSB_REG_SHIFT),\n\t\t\t      HAL_TCL1_RING_BASE_MSB_RING_BASE_ADDR_MSB) |\n\t      u32_encode_bits((srng->entry_size * srng->num_entries),\n\t\t\t      HAL_TCL1_RING_BASE_MSB_RING_SIZE);\n\tath12k_hif_write32(ab, reg_base + HAL_TCL1_RING_BASE_MSB_OFFSET, val);\n\n\tval = u32_encode_bits(srng->entry_size, HAL_REO1_RING_ID_ENTRY_SIZE);\n\tath12k_hif_write32(ab, reg_base + HAL_TCL1_RING_ID_OFFSET(ab), val);\n\n\tval = u32_encode_bits(srng->intr_timer_thres_us,\n\t\t\t      HAL_TCL1_RING_CONSR_INT_SETUP_IX0_INTR_TMR_THOLD);\n\n\tval |= u32_encode_bits((srng->intr_batch_cntr_thres_entries * srng->entry_size),\n\t\t\t       HAL_TCL1_RING_CONSR_INT_SETUP_IX0_BATCH_COUNTER_THOLD);\n\n\tath12k_hif_write32(ab,\n\t\t\t   reg_base + HAL_TCL1_RING_CONSR_INT_SETUP_IX0_OFFSET(ab),\n\t\t\t   val);\n\n\tval = 0;\n\tif (srng->flags & HAL_SRNG_FLAGS_LOW_THRESH_INTR_EN) {\n\t\tval |= u32_encode_bits(srng->u.src_ring.low_threshold,\n\t\t\t\t       HAL_TCL1_RING_CONSR_INT_SETUP_IX1_LOW_THOLD);\n\t}\n\tath12k_hif_write32(ab,\n\t\t\t   reg_base + HAL_TCL1_RING_CONSR_INT_SETUP_IX1_OFFSET(ab),\n\t\t\t   val);\n\n\tif (srng->ring_id != HAL_SRNG_RING_ID_WBM_IDLE_LINK) {\n\t\ttp_addr = hal->rdp.paddr +\n\t\t\t  ((unsigned long)srng->u.src_ring.tp_addr -\n\t\t\t   (unsigned long)hal->rdp.vaddr);\n\t\tath12k_hif_write32(ab,\n\t\t\t\t   reg_base + HAL_TCL1_RING_TP_ADDR_LSB_OFFSET(ab),\n\t\t\t\t   tp_addr & HAL_ADDR_LSB_REG_MASK);\n\t\tath12k_hif_write32(ab,\n\t\t\t\t   reg_base + HAL_TCL1_RING_TP_ADDR_MSB_OFFSET(ab),\n\t\t\t\t   tp_addr >> HAL_ADDR_MSB_REG_SHIFT);\n\t}\n\n\t \n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R2];\n\tath12k_hif_write32(ab, reg_base, 0);\n\tath12k_hif_write32(ab, reg_base + HAL_TCL1_RING_TP_OFFSET, 0);\n\t*srng->u.src_ring.tp_addr = 0;\n\n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R0];\n\tval = 0;\n\tif (srng->flags & HAL_SRNG_FLAGS_DATA_TLV_SWAP)\n\t\tval |= HAL_TCL1_RING_MISC_DATA_TLV_SWAP;\n\tif (srng->flags & HAL_SRNG_FLAGS_RING_PTR_SWAP)\n\t\tval |= HAL_TCL1_RING_MISC_HOST_FW_SWAP;\n\tif (srng->flags & HAL_SRNG_FLAGS_MSI_SWAP)\n\t\tval |= HAL_TCL1_RING_MISC_MSI_SWAP;\n\n\t \n\tval |= HAL_TCL1_RING_MISC_MSI_LOOPCNT_DISABLE;\n\n\tval |= HAL_TCL1_RING_MISC_SRNG_ENABLE;\n\n\tif (srng->ring_id == HAL_SRNG_RING_ID_WBM_IDLE_LINK)\n\t\tval |= HAL_TCL1_RING_MISC_MSI_RING_ID_DISABLE;\n\n\tath12k_hif_write32(ab, reg_base + HAL_TCL1_RING_MISC_OFFSET(ab), val);\n}\n\nstatic void ath12k_hal_srng_hw_init(struct ath12k_base *ab,\n\t\t\t\t    struct hal_srng *srng)\n{\n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC)\n\t\tath12k_hal_srng_src_hw_init(ab, srng);\n\telse\n\t\tath12k_hal_srng_dst_hw_init(ab, srng);\n}\n\nstatic int ath12k_hal_srng_get_ring_id(struct ath12k_base *ab,\n\t\t\t\t       enum hal_ring_type type,\n\t\t\t\t       int ring_num, int mac_id)\n{\n\tstruct hal_srng_config *srng_config = &ab->hal.srng_config[type];\n\tint ring_id;\n\n\tif (ring_num >= srng_config->max_rings) {\n\t\tath12k_warn(ab, \"invalid ring number :%d\\n\", ring_num);\n\t\treturn -EINVAL;\n\t}\n\n\tring_id = srng_config->start_ring_id + ring_num;\n\tif (srng_config->mac_type == ATH12K_HAL_SRNG_PMAC)\n\t\tring_id += mac_id * HAL_SRNG_RINGS_PER_PMAC;\n\n\tif (WARN_ON(ring_id >= HAL_SRNG_RING_ID_MAX))\n\t\treturn -EINVAL;\n\n\treturn ring_id;\n}\n\nint ath12k_hal_srng_get_entrysize(struct ath12k_base *ab, u32 ring_type)\n{\n\tstruct hal_srng_config *srng_config;\n\n\tif (WARN_ON(ring_type >= HAL_MAX_RING_TYPES))\n\t\treturn -EINVAL;\n\n\tsrng_config = &ab->hal.srng_config[ring_type];\n\n\treturn (srng_config->entry_size << 2);\n}\n\nint ath12k_hal_srng_get_max_entries(struct ath12k_base *ab, u32 ring_type)\n{\n\tstruct hal_srng_config *srng_config;\n\n\tif (WARN_ON(ring_type >= HAL_MAX_RING_TYPES))\n\t\treturn -EINVAL;\n\n\tsrng_config = &ab->hal.srng_config[ring_type];\n\n\treturn (srng_config->max_size / srng_config->entry_size);\n}\n\nvoid ath12k_hal_srng_get_params(struct ath12k_base *ab, struct hal_srng *srng,\n\t\t\t\tstruct hal_srng_params *params)\n{\n\tparams->ring_base_paddr = srng->ring_base_paddr;\n\tparams->ring_base_vaddr = srng->ring_base_vaddr;\n\tparams->num_entries = srng->num_entries;\n\tparams->intr_timer_thres_us = srng->intr_timer_thres_us;\n\tparams->intr_batch_cntr_thres_entries =\n\t\tsrng->intr_batch_cntr_thres_entries;\n\tparams->low_threshold = srng->u.src_ring.low_threshold;\n\tparams->msi_addr = srng->msi_addr;\n\tparams->msi2_addr = srng->msi2_addr;\n\tparams->msi_data = srng->msi_data;\n\tparams->msi2_data = srng->msi2_data;\n\tparams->flags = srng->flags;\n}\n\ndma_addr_t ath12k_hal_srng_get_hp_addr(struct ath12k_base *ab,\n\t\t\t\t       struct hal_srng *srng)\n{\n\tif (!(srng->flags & HAL_SRNG_FLAGS_LMAC_RING))\n\t\treturn 0;\n\n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC)\n\t\treturn ab->hal.wrp.paddr +\n\t\t       ((unsigned long)srng->u.src_ring.hp_addr -\n\t\t\t(unsigned long)ab->hal.wrp.vaddr);\n\telse\n\t\treturn ab->hal.rdp.paddr +\n\t\t       ((unsigned long)srng->u.dst_ring.hp_addr -\n\t\t\t (unsigned long)ab->hal.rdp.vaddr);\n}\n\ndma_addr_t ath12k_hal_srng_get_tp_addr(struct ath12k_base *ab,\n\t\t\t\t       struct hal_srng *srng)\n{\n\tif (!(srng->flags & HAL_SRNG_FLAGS_LMAC_RING))\n\t\treturn 0;\n\n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC)\n\t\treturn ab->hal.rdp.paddr +\n\t\t       ((unsigned long)srng->u.src_ring.tp_addr -\n\t\t\t(unsigned long)ab->hal.rdp.vaddr);\n\telse\n\t\treturn ab->hal.wrp.paddr +\n\t\t       ((unsigned long)srng->u.dst_ring.tp_addr -\n\t\t\t(unsigned long)ab->hal.wrp.vaddr);\n}\n\nu32 ath12k_hal_ce_get_desc_size(enum hal_ce_desc type)\n{\n\tswitch (type) {\n\tcase HAL_CE_DESC_SRC:\n\t\treturn sizeof(struct hal_ce_srng_src_desc);\n\tcase HAL_CE_DESC_DST:\n\t\treturn sizeof(struct hal_ce_srng_dest_desc);\n\tcase HAL_CE_DESC_DST_STATUS:\n\t\treturn sizeof(struct hal_ce_srng_dst_status_desc);\n\t}\n\n\treturn 0;\n}\n\nvoid ath12k_hal_ce_src_set_desc(struct hal_ce_srng_src_desc *desc, dma_addr_t paddr,\n\t\t\t\tu32 len, u32 id, u8 byte_swap_data)\n{\n\tdesc->buffer_addr_low = cpu_to_le32(paddr & HAL_ADDR_LSB_REG_MASK);\n\tdesc->buffer_addr_info =\n\t\tle32_encode_bits(((u64)paddr >> HAL_ADDR_MSB_REG_SHIFT),\n\t\t\t\t HAL_CE_SRC_DESC_ADDR_INFO_ADDR_HI) |\n\t\tle32_encode_bits(byte_swap_data,\n\t\t\t\t HAL_CE_SRC_DESC_ADDR_INFO_BYTE_SWAP) |\n\t\tle32_encode_bits(0, HAL_CE_SRC_DESC_ADDR_INFO_GATHER) |\n\t\tle32_encode_bits(len, HAL_CE_SRC_DESC_ADDR_INFO_LEN);\n\tdesc->meta_info = le32_encode_bits(id, HAL_CE_SRC_DESC_META_INFO_DATA);\n}\n\nvoid ath12k_hal_ce_dst_set_desc(struct hal_ce_srng_dest_desc *desc, dma_addr_t paddr)\n{\n\tdesc->buffer_addr_low = cpu_to_le32(paddr & HAL_ADDR_LSB_REG_MASK);\n\tdesc->buffer_addr_info =\n\t\tle32_encode_bits(((u64)paddr >> HAL_ADDR_MSB_REG_SHIFT),\n\t\t\t\t HAL_CE_DEST_DESC_ADDR_INFO_ADDR_HI);\n}\n\nu32 ath12k_hal_ce_dst_status_get_length(struct hal_ce_srng_dst_status_desc *desc)\n{\n\tu32 len;\n\n\tlen = le32_get_bits(desc->flags, HAL_CE_DST_STATUS_DESC_FLAGS_LEN);\n\tdesc->flags &= ~cpu_to_le32(HAL_CE_DST_STATUS_DESC_FLAGS_LEN);\n\n\treturn len;\n}\n\nvoid ath12k_hal_set_link_desc_addr(struct hal_wbm_link_desc *desc, u32 cookie,\n\t\t\t\t   dma_addr_t paddr)\n{\n\tdesc->buf_addr_info.info0 = le32_encode_bits((paddr & HAL_ADDR_LSB_REG_MASK),\n\t\t\t\t\t\t     BUFFER_ADDR_INFO0_ADDR);\n\tdesc->buf_addr_info.info1 =\n\t\t\tle32_encode_bits(((u64)paddr >> HAL_ADDR_MSB_REG_SHIFT),\n\t\t\t\t\t BUFFER_ADDR_INFO1_ADDR) |\n\t\t\tle32_encode_bits(1, BUFFER_ADDR_INFO1_RET_BUF_MGR) |\n\t\t\tle32_encode_bits(cookie, BUFFER_ADDR_INFO1_SW_COOKIE);\n}\n\nvoid *ath12k_hal_srng_dst_peek(struct ath12k_base *ab, struct hal_srng *srng)\n{\n\tlockdep_assert_held(&srng->lock);\n\n\tif (srng->u.dst_ring.tp != srng->u.dst_ring.cached_hp)\n\t\treturn (srng->ring_base_vaddr + srng->u.dst_ring.tp);\n\n\treturn NULL;\n}\n\nvoid *ath12k_hal_srng_dst_get_next_entry(struct ath12k_base *ab,\n\t\t\t\t\t struct hal_srng *srng)\n{\n\tvoid *desc;\n\n\tlockdep_assert_held(&srng->lock);\n\n\tif (srng->u.dst_ring.tp == srng->u.dst_ring.cached_hp)\n\t\treturn NULL;\n\n\tdesc = srng->ring_base_vaddr + srng->u.dst_ring.tp;\n\n\tsrng->u.dst_ring.tp = (srng->u.dst_ring.tp + srng->entry_size) %\n\t\t\t      srng->ring_size;\n\n\treturn desc;\n}\n\nint ath12k_hal_srng_dst_num_free(struct ath12k_base *ab, struct hal_srng *srng,\n\t\t\t\t bool sync_hw_ptr)\n{\n\tu32 tp, hp;\n\n\tlockdep_assert_held(&srng->lock);\n\n\ttp = srng->u.dst_ring.tp;\n\n\tif (sync_hw_ptr) {\n\t\thp = *srng->u.dst_ring.hp_addr;\n\t\tsrng->u.dst_ring.cached_hp = hp;\n\t} else {\n\t\thp = srng->u.dst_ring.cached_hp;\n\t}\n\n\tif (hp >= tp)\n\t\treturn (hp - tp) / srng->entry_size;\n\telse\n\t\treturn (srng->ring_size - tp + hp) / srng->entry_size;\n}\n\n \nint ath12k_hal_srng_src_num_free(struct ath12k_base *ab, struct hal_srng *srng,\n\t\t\t\t bool sync_hw_ptr)\n{\n\tu32 tp, hp;\n\n\tlockdep_assert_held(&srng->lock);\n\n\thp = srng->u.src_ring.hp;\n\n\tif (sync_hw_ptr) {\n\t\ttp = *srng->u.src_ring.tp_addr;\n\t\tsrng->u.src_ring.cached_tp = tp;\n\t} else {\n\t\ttp = srng->u.src_ring.cached_tp;\n\t}\n\n\tif (tp > hp)\n\t\treturn ((tp - hp) / srng->entry_size) - 1;\n\telse\n\t\treturn ((srng->ring_size - hp + tp) / srng->entry_size) - 1;\n}\n\nvoid *ath12k_hal_srng_src_get_next_entry(struct ath12k_base *ab,\n\t\t\t\t\t struct hal_srng *srng)\n{\n\tvoid *desc;\n\tu32 next_hp;\n\n\tlockdep_assert_held(&srng->lock);\n\n\t \n\tnext_hp = (srng->u.src_ring.hp + srng->entry_size) % srng->ring_size;\n\n\tif (next_hp == srng->u.src_ring.cached_tp)\n\t\treturn NULL;\n\n\tdesc = srng->ring_base_vaddr + srng->u.src_ring.hp;\n\tsrng->u.src_ring.hp = next_hp;\n\n\t \n\tsrng->u.src_ring.reap_hp = next_hp;\n\n\treturn desc;\n}\n\nvoid *ath12k_hal_srng_src_reap_next(struct ath12k_base *ab,\n\t\t\t\t    struct hal_srng *srng)\n{\n\tvoid *desc;\n\tu32 next_reap_hp;\n\n\tlockdep_assert_held(&srng->lock);\n\n\tnext_reap_hp = (srng->u.src_ring.reap_hp + srng->entry_size) %\n\t\t       srng->ring_size;\n\n\tif (next_reap_hp == srng->u.src_ring.cached_tp)\n\t\treturn NULL;\n\n\tdesc = srng->ring_base_vaddr + next_reap_hp;\n\tsrng->u.src_ring.reap_hp = next_reap_hp;\n\n\treturn desc;\n}\n\nvoid *ath12k_hal_srng_src_get_next_reaped(struct ath12k_base *ab,\n\t\t\t\t\t  struct hal_srng *srng)\n{\n\tvoid *desc;\n\n\tlockdep_assert_held(&srng->lock);\n\n\tif (srng->u.src_ring.hp == srng->u.src_ring.reap_hp)\n\t\treturn NULL;\n\n\tdesc = srng->ring_base_vaddr + srng->u.src_ring.hp;\n\tsrng->u.src_ring.hp = (srng->u.src_ring.hp + srng->entry_size) %\n\t\t\t      srng->ring_size;\n\n\treturn desc;\n}\n\nvoid ath12k_hal_srng_access_begin(struct ath12k_base *ab, struct hal_srng *srng)\n{\n\tlockdep_assert_held(&srng->lock);\n\n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC)\n\t\tsrng->u.src_ring.cached_tp =\n\t\t\t*(volatile u32 *)srng->u.src_ring.tp_addr;\n\telse\n\t\tsrng->u.dst_ring.cached_hp = *srng->u.dst_ring.hp_addr;\n}\n\n \nvoid ath12k_hal_srng_access_end(struct ath12k_base *ab, struct hal_srng *srng)\n{\n\tlockdep_assert_held(&srng->lock);\n\n\t \n\tif (srng->flags & HAL_SRNG_FLAGS_LMAC_RING) {\n\t\t \n\t\tif (srng->ring_dir == HAL_SRNG_DIR_SRC) {\n\t\t\tsrng->u.src_ring.last_tp =\n\t\t\t\t*(volatile u32 *)srng->u.src_ring.tp_addr;\n\t\t\t*srng->u.src_ring.hp_addr = srng->u.src_ring.hp;\n\t\t} else {\n\t\t\tsrng->u.dst_ring.last_hp = *srng->u.dst_ring.hp_addr;\n\t\t\t*srng->u.dst_ring.tp_addr = srng->u.dst_ring.tp;\n\t\t}\n\t} else {\n\t\tif (srng->ring_dir == HAL_SRNG_DIR_SRC) {\n\t\t\tsrng->u.src_ring.last_tp =\n\t\t\t\t*(volatile u32 *)srng->u.src_ring.tp_addr;\n\t\t\tath12k_hif_write32(ab,\n\t\t\t\t\t   (unsigned long)srng->u.src_ring.hp_addr -\n\t\t\t\t\t   (unsigned long)ab->mem,\n\t\t\t\t\t   srng->u.src_ring.hp);\n\t\t} else {\n\t\t\tsrng->u.dst_ring.last_hp = *srng->u.dst_ring.hp_addr;\n\t\t\tath12k_hif_write32(ab,\n\t\t\t\t\t   (unsigned long)srng->u.dst_ring.tp_addr -\n\t\t\t\t\t   (unsigned long)ab->mem,\n\t\t\t\t\t   srng->u.dst_ring.tp);\n\t\t}\n\t}\n\n\tsrng->timestamp = jiffies;\n}\n\nvoid ath12k_hal_setup_link_idle_list(struct ath12k_base *ab,\n\t\t\t\t     struct hal_wbm_idle_scatter_list *sbuf,\n\t\t\t\t     u32 nsbufs, u32 tot_link_desc,\n\t\t\t\t     u32 end_offset)\n{\n\tstruct ath12k_buffer_addr *link_addr;\n\tint i;\n\tu32 reg_scatter_buf_sz = HAL_WBM_IDLE_SCATTER_BUF_SIZE / 64;\n\tu32 val;\n\n\tlink_addr = (void *)sbuf[0].vaddr + HAL_WBM_IDLE_SCATTER_BUF_SIZE;\n\n\tfor (i = 1; i < nsbufs; i++) {\n\t\tlink_addr->info0 = cpu_to_le32(sbuf[i].paddr & HAL_ADDR_LSB_REG_MASK);\n\n\t\tlink_addr->info1 =\n\t\t\tle32_encode_bits((u64)sbuf[i].paddr >> HAL_ADDR_MSB_REG_SHIFT,\n\t\t\t\t\t HAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_39_32) |\n\t\t\tle32_encode_bits(BASE_ADDR_MATCH_TAG_VAL,\n\t\t\t\t\t HAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_MATCH_TAG);\n\n\t\tlink_addr = (void *)sbuf[i].vaddr +\n\t\t\t     HAL_WBM_IDLE_SCATTER_BUF_SIZE;\n\t}\n\n\tval = u32_encode_bits(reg_scatter_buf_sz, HAL_WBM_SCATTER_BUFFER_SIZE) |\n\t      u32_encode_bits(0x1, HAL_WBM_LINK_DESC_IDLE_LIST_MODE);\n\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_R0_IDLE_LIST_CONTROL_ADDR(ab),\n\t\t\t   val);\n\n\tval = u32_encode_bits(reg_scatter_buf_sz * nsbufs,\n\t\t\t      HAL_WBM_SCATTER_RING_SIZE_OF_IDLE_LINK_DESC_LIST);\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG + HAL_WBM_R0_IDLE_LIST_SIZE_ADDR(ab),\n\t\t\t   val);\n\n\tval = u32_encode_bits(sbuf[0].paddr & HAL_ADDR_LSB_REG_MASK,\n\t\t\t      BUFFER_ADDR_INFO0_ADDR);\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_RING_BASE_LSB(ab),\n\t\t\t   val);\n\n\tval = u32_encode_bits(BASE_ADDR_MATCH_TAG_VAL,\n\t\t\t      HAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_MATCH_TAG) |\n\t      u32_encode_bits((u64)sbuf[0].paddr >> HAL_ADDR_MSB_REG_SHIFT,\n\t\t\t      HAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_39_32);\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_RING_BASE_MSB(ab),\n\t\t\t   val);\n\n\t \n\tval = u32_encode_bits(sbuf[nsbufs - 1].paddr, BUFFER_ADDR_INFO0_ADDR);\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_HEAD_INFO_IX0(ab),\n\t\t\t   val);\n\n\tval = u32_encode_bits(((u64)sbuf[nsbufs - 1].paddr >> HAL_ADDR_MSB_REG_SHIFT),\n\t\t\t      HAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_39_32) |\n\t       u32_encode_bits((end_offset >> 2),\n\t\t\t       HAL_WBM_SCATTERED_DESC_HEAD_P_OFFSET_IX1);\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_HEAD_INFO_IX1(ab),\n\t\t\t   val);\n\n\tval = u32_encode_bits(sbuf[0].paddr, BUFFER_ADDR_INFO0_ADDR);\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_HEAD_INFO_IX0(ab),\n\t\t\t   val);\n\n\tval = u32_encode_bits(sbuf[0].paddr, BUFFER_ADDR_INFO0_ADDR);\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_TAIL_INFO_IX0(ab),\n\t\t\t   val);\n\n\tval = u32_encode_bits(((u64)sbuf[0].paddr >> HAL_ADDR_MSB_REG_SHIFT),\n\t\t\t      HAL_WBM_SCATTERED_DESC_MSB_BASE_ADDR_39_32) |\n\t      u32_encode_bits(0, HAL_WBM_SCATTERED_DESC_TAIL_P_OFFSET_IX1);\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_TAIL_INFO_IX1(ab),\n\t\t\t   val);\n\n\tval = 2 * tot_link_desc;\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_SCATTERED_DESC_PTR_HP_ADDR(ab),\n\t\t\t   val);\n\n\t \n\tval = u32_encode_bits(1, HAL_WBM_IDLE_LINK_RING_MISC_SRNG_ENABLE) |\n\t      u32_encode_bits(1, HAL_WBM_IDLE_LINK_RING_MISC_RIND_ID_DISABLE);\n\tath12k_hif_write32(ab,\n\t\t\t   HAL_SEQ_WCSS_UMAC_WBM_REG +\n\t\t\t   HAL_WBM_IDLE_LINK_RING_MISC_ADDR(ab),\n\t\t\t   val);\n}\n\nint ath12k_hal_srng_setup(struct ath12k_base *ab, enum hal_ring_type type,\n\t\t\t  int ring_num, int mac_id,\n\t\t\t  struct hal_srng_params *params)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tstruct hal_srng_config *srng_config = &ab->hal.srng_config[type];\n\tstruct hal_srng *srng;\n\tint ring_id;\n\tu32 idx;\n\tint i;\n\tu32 reg_base;\n\n\tring_id = ath12k_hal_srng_get_ring_id(ab, type, ring_num, mac_id);\n\tif (ring_id < 0)\n\t\treturn ring_id;\n\n\tsrng = &hal->srng_list[ring_id];\n\n\tsrng->ring_id = ring_id;\n\tsrng->ring_dir = srng_config->ring_dir;\n\tsrng->ring_base_paddr = params->ring_base_paddr;\n\tsrng->ring_base_vaddr = params->ring_base_vaddr;\n\tsrng->entry_size = srng_config->entry_size;\n\tsrng->num_entries = params->num_entries;\n\tsrng->ring_size = srng->entry_size * srng->num_entries;\n\tsrng->intr_batch_cntr_thres_entries =\n\t\t\t\tparams->intr_batch_cntr_thres_entries;\n\tsrng->intr_timer_thres_us = params->intr_timer_thres_us;\n\tsrng->flags = params->flags;\n\tsrng->msi_addr = params->msi_addr;\n\tsrng->msi2_addr = params->msi2_addr;\n\tsrng->msi_data = params->msi_data;\n\tsrng->msi2_data = params->msi2_data;\n\tsrng->initialized = 1;\n\tspin_lock_init(&srng->lock);\n\tlockdep_set_class(&srng->lock, &srng->lock_key);\n\n\tfor (i = 0; i < HAL_SRNG_NUM_REG_GRP; i++) {\n\t\tsrng->hwreg_base[i] = srng_config->reg_start[i] +\n\t\t\t\t      (ring_num * srng_config->reg_size[i]);\n\t}\n\n\tmemset(srng->ring_base_vaddr, 0,\n\t       (srng->entry_size * srng->num_entries) << 2);\n\n\treg_base = srng->hwreg_base[HAL_SRNG_REG_GRP_R2];\n\n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC) {\n\t\tsrng->u.src_ring.hp = 0;\n\t\tsrng->u.src_ring.cached_tp = 0;\n\t\tsrng->u.src_ring.reap_hp = srng->ring_size - srng->entry_size;\n\t\tsrng->u.src_ring.tp_addr = (void *)(hal->rdp.vaddr + ring_id);\n\t\tsrng->u.src_ring.low_threshold = params->low_threshold *\n\t\t\t\t\t\t srng->entry_size;\n\t\tif (srng_config->mac_type == ATH12K_HAL_SRNG_UMAC) {\n\t\t\tif (!ab->hw_params->supports_shadow_regs)\n\t\t\t\tsrng->u.src_ring.hp_addr =\n\t\t\t\t\t(u32 *)((unsigned long)ab->mem + reg_base);\n\t\t\telse\n\t\t\t\tath12k_dbg(ab, ATH12K_DBG_HAL,\n\t\t\t\t\t   \"hal type %d ring_num %d reg_base 0x%x shadow 0x%lx\\n\",\n\t\t\t\t\t   type, ring_num,\n\t\t\t\t\t   reg_base,\n\t\t\t\t\t   (unsigned long)srng->u.src_ring.hp_addr -\n\t\t\t\t\t   (unsigned long)ab->mem);\n\t\t} else {\n\t\t\tidx = ring_id - HAL_SRNG_RING_ID_DMAC_CMN_ID_START;\n\t\t\tsrng->u.src_ring.hp_addr = (void *)(hal->wrp.vaddr +\n\t\t\t\t\t\t   idx);\n\t\t\tsrng->flags |= HAL_SRNG_FLAGS_LMAC_RING;\n\t\t}\n\t} else {\n\t\t \n\t\tsrng->u.dst_ring.loop_cnt = 1;\n\t\tsrng->u.dst_ring.tp = 0;\n\t\tsrng->u.dst_ring.cached_hp = 0;\n\t\tsrng->u.dst_ring.hp_addr = (void *)(hal->rdp.vaddr + ring_id);\n\t\tif (srng_config->mac_type == ATH12K_HAL_SRNG_UMAC) {\n\t\t\tif (!ab->hw_params->supports_shadow_regs)\n\t\t\t\tsrng->u.dst_ring.tp_addr =\n\t\t\t\t\t(u32 *)((unsigned long)ab->mem + reg_base +\n\t\t\t\t\t(HAL_REO1_RING_TP - HAL_REO1_RING_HP));\n\t\t\telse\n\t\t\t\tath12k_dbg(ab, ATH12K_DBG_HAL,\n\t\t\t\t\t   \"type %d ring_num %d target_reg 0x%x shadow 0x%lx\\n\",\n\t\t\t\t\t   type, ring_num,\n\t\t\t\t\t   reg_base + HAL_REO1_RING_TP - HAL_REO1_RING_HP,\n\t\t\t\t\t   (unsigned long)srng->u.dst_ring.tp_addr -\n\t\t\t\t\t   (unsigned long)ab->mem);\n\t\t} else {\n\t\t\t \n\t\t\tidx = ring_id - HAL_SRNG_RING_ID_DMAC_CMN_ID_START;\n\t\t\tsrng->u.dst_ring.tp_addr = (void *)(hal->wrp.vaddr +\n\t\t\t\t\t\t   idx);\n\t\t\tsrng->flags |= HAL_SRNG_FLAGS_LMAC_RING;\n\t\t}\n\t}\n\n\tif (srng_config->mac_type != ATH12K_HAL_SRNG_UMAC)\n\t\treturn ring_id;\n\n\tath12k_hal_srng_hw_init(ab, srng);\n\n\tif (type == HAL_CE_DST) {\n\t\tsrng->u.dst_ring.max_buffer_length = params->max_buffer_len;\n\t\tath12k_hal_ce_dst_setup(ab, srng, ring_num);\n\t}\n\n\treturn ring_id;\n}\n\nstatic void ath12k_hal_srng_update_hp_tp_addr(struct ath12k_base *ab,\n\t\t\t\t\t      int shadow_cfg_idx,\n\t\t\t\t\t      enum hal_ring_type ring_type,\n\t\t\t\t\t      int ring_num)\n{\n\tstruct hal_srng *srng;\n\tstruct ath12k_hal *hal = &ab->hal;\n\tint ring_id;\n\tstruct hal_srng_config *srng_config = &hal->srng_config[ring_type];\n\n\tring_id = ath12k_hal_srng_get_ring_id(ab, ring_type, ring_num, 0);\n\tif (ring_id < 0)\n\t\treturn;\n\n\tsrng = &hal->srng_list[ring_id];\n\n\tif (srng_config->ring_dir == HAL_SRNG_DIR_DST)\n\t\tsrng->u.dst_ring.tp_addr = (u32 *)(HAL_SHADOW_REG(shadow_cfg_idx) +\n\t\t\t\t\t\t   (unsigned long)ab->mem);\n\telse\n\t\tsrng->u.src_ring.hp_addr = (u32 *)(HAL_SHADOW_REG(shadow_cfg_idx) +\n\t\t\t\t\t\t   (unsigned long)ab->mem);\n}\n\nint ath12k_hal_srng_update_shadow_config(struct ath12k_base *ab,\n\t\t\t\t\t enum hal_ring_type ring_type,\n\t\t\t\t\t int ring_num)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tstruct hal_srng_config *srng_config = &hal->srng_config[ring_type];\n\tint shadow_cfg_idx = hal->num_shadow_reg_configured;\n\tu32 target_reg;\n\n\tif (shadow_cfg_idx >= HAL_SHADOW_NUM_REGS)\n\t\treturn -EINVAL;\n\n\thal->num_shadow_reg_configured++;\n\n\ttarget_reg = srng_config->reg_start[HAL_HP_OFFSET_IN_REG_START];\n\ttarget_reg += srng_config->reg_size[HAL_HP_OFFSET_IN_REG_START] *\n\t\tring_num;\n\n\t \n\tif (srng_config->ring_dir == HAL_SRNG_DIR_DST)\n\t\ttarget_reg += HAL_OFFSET_FROM_HP_TO_TP;\n\n\thal->shadow_reg_addr[shadow_cfg_idx] = target_reg;\n\n\t \n\tath12k_hal_srng_update_hp_tp_addr(ab, shadow_cfg_idx, ring_type,\n\t\t\t\t\t  ring_num);\n\n\tath12k_dbg(ab, ATH12K_DBG_HAL,\n\t\t   \"target_reg %x, shadow reg 0x%x shadow_idx 0x%x, ring_type %d, ring num %d\",\n\t\t  target_reg,\n\t\t  HAL_SHADOW_REG(shadow_cfg_idx),\n\t\t  shadow_cfg_idx,\n\t\t  ring_type, ring_num);\n\n\treturn 0;\n}\n\nvoid ath12k_hal_srng_shadow_config(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tint ring_type, ring_num;\n\n\t \n\tfor (ring_type = 0; ring_type < HAL_MAX_RING_TYPES; ring_type++) {\n\t\tstruct hal_srng_config *srng_config = &hal->srng_config[ring_type];\n\n\t\tif (ring_type == HAL_CE_SRC ||\n\t\t    ring_type == HAL_CE_DST ||\n\t\t\tring_type == HAL_CE_DST_STATUS)\n\t\t\tcontinue;\n\n\t\tif (srng_config->mac_type == ATH12K_HAL_SRNG_DMAC ||\n\t\t    srng_config->mac_type == ATH12K_HAL_SRNG_PMAC)\n\t\t\tcontinue;\n\n\t\tfor (ring_num = 0; ring_num < srng_config->max_rings; ring_num++)\n\t\t\tath12k_hal_srng_update_shadow_config(ab, ring_type, ring_num);\n\t}\n}\n\nvoid ath12k_hal_srng_get_shadow_config(struct ath12k_base *ab,\n\t\t\t\t       u32 **cfg, u32 *len)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\n\t*len = hal->num_shadow_reg_configured;\n\t*cfg = hal->shadow_reg_addr;\n}\n\nvoid ath12k_hal_srng_shadow_update_hp_tp(struct ath12k_base *ab,\n\t\t\t\t\t struct hal_srng *srng)\n{\n\tlockdep_assert_held(&srng->lock);\n\n\t \n\tif (srng->ring_dir == HAL_SRNG_DIR_SRC &&\n\t    *srng->u.src_ring.tp_addr != srng->u.src_ring.hp)\n\t\tath12k_hal_srng_access_end(ab, srng);\n}\n\nstatic void ath12k_hal_register_srng_lock_keys(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tu32 ring_id;\n\n\tfor (ring_id = 0; ring_id < HAL_SRNG_RING_ID_MAX; ring_id++)\n\t\tlockdep_register_key(&hal->srng_list[ring_id].lock_key);\n}\n\nstatic void ath12k_hal_unregister_srng_lock_keys(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tu32 ring_id;\n\n\tfor (ring_id = 0; ring_id < HAL_SRNG_RING_ID_MAX; ring_id++)\n\t\tlockdep_unregister_key(&hal->srng_list[ring_id].lock_key);\n}\n\nint ath12k_hal_srng_init(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\tint ret;\n\n\tmemset(hal, 0, sizeof(*hal));\n\n\tret = ab->hw_params->hal_ops->create_srng_config(ab);\n\tif (ret)\n\t\tgoto err_hal;\n\n\tret = ath12k_hal_alloc_cont_rdp(ab);\n\tif (ret)\n\t\tgoto err_hal;\n\n\tret = ath12k_hal_alloc_cont_wrp(ab);\n\tif (ret)\n\t\tgoto err_free_cont_rdp;\n\n\tath12k_hal_register_srng_lock_keys(ab);\n\n\treturn 0;\n\nerr_free_cont_rdp:\n\tath12k_hal_free_cont_rdp(ab);\n\nerr_hal:\n\treturn ret;\n}\n\nvoid ath12k_hal_srng_deinit(struct ath12k_base *ab)\n{\n\tstruct ath12k_hal *hal = &ab->hal;\n\n\tath12k_hal_unregister_srng_lock_keys(ab);\n\tath12k_hal_free_cont_rdp(ab);\n\tath12k_hal_free_cont_wrp(ab);\n\tkfree(hal->srng_config);\n\thal->srng_config = NULL;\n}\n\nvoid ath12k_hal_dump_srng_stats(struct ath12k_base *ab)\n{\n\tstruct hal_srng *srng;\n\tstruct ath12k_ext_irq_grp *irq_grp;\n\tstruct ath12k_ce_pipe *ce_pipe;\n\tint i;\n\n\tath12k_err(ab, \"Last interrupt received for each CE:\\n\");\n\tfor (i = 0; i < ab->hw_params->ce_count; i++) {\n\t\tce_pipe = &ab->ce.ce_pipe[i];\n\n\t\tif (ath12k_ce_get_attr_flags(ab, i) & CE_ATTR_DIS_INTR)\n\t\t\tcontinue;\n\n\t\tath12k_err(ab, \"CE_id %d pipe_num %d %ums before\\n\",\n\t\t\t   i, ce_pipe->pipe_num,\n\t\t\t   jiffies_to_msecs(jiffies - ce_pipe->timestamp));\n\t}\n\n\tath12k_err(ab, \"\\nLast interrupt received for each group:\\n\");\n\tfor (i = 0; i < ATH12K_EXT_IRQ_GRP_NUM_MAX; i++) {\n\t\tirq_grp = &ab->ext_irq_grp[i];\n\t\tath12k_err(ab, \"group_id %d %ums before\\n\",\n\t\t\t   irq_grp->grp_id,\n\t\t\t   jiffies_to_msecs(jiffies - irq_grp->timestamp));\n\t}\n\n\tfor (i = 0; i < HAL_SRNG_RING_ID_MAX; i++) {\n\t\tsrng = &ab->hal.srng_list[i];\n\n\t\tif (!srng->initialized)\n\t\t\tcontinue;\n\n\t\tif (srng->ring_dir == HAL_SRNG_DIR_SRC)\n\t\t\tath12k_err(ab,\n\t\t\t\t   \"src srng id %u hp %u, reap_hp %u, cur tp %u, cached tp %u last tp %u napi processed before %ums\\n\",\n\t\t\t\t   srng->ring_id, srng->u.src_ring.hp,\n\t\t\t\t   srng->u.src_ring.reap_hp,\n\t\t\t\t   *srng->u.src_ring.tp_addr, srng->u.src_ring.cached_tp,\n\t\t\t\t   srng->u.src_ring.last_tp,\n\t\t\t\t   jiffies_to_msecs(jiffies - srng->timestamp));\n\t\telse if (srng->ring_dir == HAL_SRNG_DIR_DST)\n\t\t\tath12k_err(ab,\n\t\t\t\t   \"dst srng id %u tp %u, cur hp %u, cached hp %u last hp %u napi processed before %ums\\n\",\n\t\t\t\t   srng->ring_id, srng->u.dst_ring.tp,\n\t\t\t\t   *srng->u.dst_ring.hp_addr,\n\t\t\t\t   srng->u.dst_ring.cached_hp,\n\t\t\t\t   srng->u.dst_ring.last_hp,\n\t\t\t\t   jiffies_to_msecs(jiffies - srng->timestamp));\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}