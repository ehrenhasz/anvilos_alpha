{
  "module_name": "txrx.c",
  "hash_id": "c586721c324834b948d240fd27dc250da993325166bff67913263d05d66f44f0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/wcn36xx/txrx.c",
  "human_readable_source": " \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/random.h>\n#include \"txrx.h\"\n\nstatic inline int get_rssi0(struct wcn36xx_rx_bd *bd)\n{\n\treturn 100 - ((bd->phy_stat0 >> 24) & 0xff);\n}\n\nstatic inline int get_snr(struct wcn36xx_rx_bd *bd)\n{\n\treturn ((bd->phy_stat1 >> 24) & 0xff);\n}\n\nstruct wcn36xx_rate {\n\tu16 bitrate;\n\tu16 mcs_or_legacy_index;\n\tenum mac80211_rx_encoding encoding;\n\tenum mac80211_rx_encoding_flags encoding_flags;\n\tenum rate_info_bw bw;\n};\n\n \nstatic const u8 ab_rx_ch_map[] = { 36, 40, 44, 48, 52, 56, 60, 64, 100, 104,\n\t\t\t\t   108, 112, 116, 120, 124, 128, 132, 136, 140,\n\t\t\t\t   149, 153, 157, 161, 165, 144 };\n\nstatic const struct wcn36xx_rate wcn36xx_rate_table[] = {\n\t \n\t{  10, 0, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\t{  20, 1, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\t{  55, 2, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\t{ 110, 3, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\n\t \n\t{  10, 0, RX_ENC_LEGACY, RX_ENC_FLAG_SHORTPRE, RATE_INFO_BW_20 },\n\t{  20, 1, RX_ENC_LEGACY, RX_ENC_FLAG_SHORTPRE, RATE_INFO_BW_20 },\n\t{  55, 2, RX_ENC_LEGACY, RX_ENC_FLAG_SHORTPRE, RATE_INFO_BW_20 },\n\t{ 110, 3, RX_ENC_LEGACY, RX_ENC_FLAG_SHORTPRE, RATE_INFO_BW_20 },\n\n\t \n\t{  60, 4, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\t{  90, 5, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\t{ 120, 6, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\t{ 180, 7, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\t{ 240, 8, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\t{ 360, 9, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\t{ 480, 10, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\t{ 540, 11, RX_ENC_LEGACY, 0, RATE_INFO_BW_20 },\n\n\t \n\t{  65, 0, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{ 130, 1, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{ 195, 2, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{ 260, 3, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{ 390, 4, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{ 520, 5, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{ 585, 6, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{ 650, 7, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\n\t \n\t{  72, 0, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\t{ 144, 1, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\t{ 217, 2, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\t{ 289, 3, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\t{ 434, 4, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\t{ 578, 5, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\t{ 650, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\t{ 722, 7, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\n\t \n\t{  65, 0, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_20 },\n\t{ 130, 1, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_20 },\n\t{ 195, 2, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_20 },\n\t{ 260, 3, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_20 },\n\t{ 390, 4, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_20 },\n\t{ 520, 5, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_20 },\n\t{ 585, 6, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_20 },\n\t{ 650, 7, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_20 },\n\n\t \n\t{ 135, 0, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 270, 1, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 405, 2, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 540, 3, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 810, 4, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 1080, 5, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 1215, 6, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 1350, 7, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\n\t \n\t{ 150, 0, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 300, 1, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 450, 2, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 600, 3, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 900, 4, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1200, 5, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1500, 7, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{ 135, 0, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_40 },\n\t{ 270, 1, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_40 },\n\t{ 405, 2, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_40 },\n\t{ 540, 3, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_40 },\n\t{ 810, 4, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_40 },\n\t{ 1080, 5, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_40 },\n\t{ 1215, 6, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_40 },\n\t{ 1350, 7, RX_ENC_HT, RX_ENC_FLAG_HT_GF, RATE_INFO_BW_40 },\n\n\t \n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{   65, 0, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{  130, 1, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{  195, 2, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{  260, 3, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{  390, 4, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{  520, 5, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{  585, 6, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{  650, 7, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\t{  780, 8, RX_ENC_HT, 0, RATE_INFO_BW_20 },\n\n\t \n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{  655, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\t{  722, 7, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\t{  866, 8, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_20 },\n\n\t \n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{  135, 0, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{  270, 1, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{  405, 2, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{  540, 3, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{  810, 4, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 1080, 5, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 1215, 6, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 1350, 7, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 1350, 7, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 1620, 8, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\t{ 1800, 9, RX_ENC_HT, 0, RATE_INFO_BW_40 },\n\n\t \n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{ 1200, 5, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1500, 7, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{ 1800, 8, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 2000, 9, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{ 1350, 6, RX_ENC_HT,  RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{  292, 0, RX_ENC_HT, 0, RATE_INFO_BW_80},\n\t{  585, 1, RX_ENC_HT, 0, RATE_INFO_BW_80},\n\t{  877, 2, RX_ENC_HT, 0, RATE_INFO_BW_80},\n\t{ 1170, 3, RX_ENC_HT, 0, RATE_INFO_BW_80},\n\t{ 1755, 4, RX_ENC_HT, 0, RATE_INFO_BW_80},\n\t{ 2340, 5, RX_ENC_HT, 0, RATE_INFO_BW_80},\n\t{ 2632, 6, RX_ENC_HT, 0, RATE_INFO_BW_80},\n\t{ 2925, 7, RX_ENC_HT, 0, RATE_INFO_BW_80},\n\n\t \n\t{ 1350, 6, RX_ENC_HT,  RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{ 3510, 8, RX_ENC_HT, 0, RATE_INFO_BW_80},\n\t{ 3900, 9, RX_ENC_HT, 0, RATE_INFO_BW_80},\n\n\t \n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\t{ 1350, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{ 2925, 6, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_80 },\n\t{ 3250, 7, RX_ENC_HT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_80 },\n\n\t \n\t{ 1350, 6, RX_ENC_HT,  RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_40 },\n\n\t \n\t{ 3900, 8, RX_ENC_VHT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_80 },\n\t{ 4333, 9, RX_ENC_VHT, RX_ENC_FLAG_SHORT_GI, RATE_INFO_BW_80 },\n};\n\nstatic struct sk_buff *wcn36xx_unchain_msdu(struct sk_buff_head *amsdu)\n{\n\tstruct sk_buff *skb, *first;\n\tint total_len = 0;\n\tint space;\n\n\tfirst = __skb_dequeue(amsdu);\n\n\tskb_queue_walk(amsdu, skb)\n\t\ttotal_len += skb->len;\n\n\tspace = total_len - skb_tailroom(first);\n\tif (space > 0 && pskb_expand_head(first, 0, space, GFP_ATOMIC) < 0) {\n\t\t__skb_queue_head(amsdu, first);\n\t\treturn NULL;\n\t}\n\n\t \n\twhile ((skb = __skb_dequeue(amsdu))) {\n\t\tskb_copy_from_linear_data(skb, skb_put(first, skb->len),\n\t\t\t\t\t  skb->len);\n\t\tdev_kfree_skb_irq(skb);\n\t}\n\n\treturn first;\n}\n\nstatic void __skb_queue_purge_irq(struct sk_buff_head *list)\n{\n\tstruct sk_buff *skb;\n\n\twhile ((skb = __skb_dequeue(list)) != NULL)\n\t\tdev_kfree_skb_irq(skb);\n}\n\nstatic void wcn36xx_update_survey(struct wcn36xx *wcn, int rssi, int snr,\n\t\t\t\t  int band, int freq)\n{\n\tstatic struct ieee80211_channel *channel;\n\tstruct ieee80211_supported_band *sband;\n\tint idx;\n\tint i;\n\tu8 snr_sample = snr & 0xff;\n\n\tidx = 0;\n\tif (band == NL80211_BAND_5GHZ)\n\t\tidx = wcn->hw->wiphy->bands[NL80211_BAND_2GHZ]->n_channels;\n\n\tsband = wcn->hw->wiphy->bands[band];\n\tchannel = sband->channels;\n\n\tfor (i = 0; i < sband->n_channels; i++, channel++) {\n\t\tif (channel->center_freq == freq) {\n\t\t\tidx += i;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tspin_lock(&wcn->survey_lock);\n\twcn->chan_survey[idx].rssi = rssi;\n\twcn->chan_survey[idx].snr = snr;\n\tspin_unlock(&wcn->survey_lock);\n\n\tadd_device_randomness(&snr_sample, sizeof(snr_sample));\n}\n\nint wcn36xx_rx_skb(struct wcn36xx *wcn, struct sk_buff *skb)\n{\n\tstruct ieee80211_rx_status status;\n\tconst struct wcn36xx_rate *rate;\n\tstruct ieee80211_hdr *hdr;\n\tstruct wcn36xx_rx_bd *bd;\n\tu16 fc, sn;\n\n\t \n\tmemset(&status, 0, sizeof(status));\n\n\tbd = (struct wcn36xx_rx_bd *)skb->data;\n\tbuff_to_be((u32 *)bd, sizeof(*bd)/sizeof(u32));\n\twcn36xx_dbg_dump(WCN36XX_DBG_RX_DUMP,\n\t\t\t \"BD   <<< \", (char *)bd,\n\t\t\t sizeof(struct wcn36xx_rx_bd));\n\n\tif (bd->pdu.mpdu_data_off <= bd->pdu.mpdu_header_off ||\n\t    bd->pdu.mpdu_len < bd->pdu.mpdu_header_len)\n\t\tgoto drop;\n\n\tif (bd->asf && !bd->esf) {  \n\t\t \n\t\tif (bd->pdu.mpdu_data_off + bd->pdu.mpdu_len > WCN36XX_PKT_SIZE)\n\t\t\tgoto drop;\n\n\t\tskb_put(skb, bd->pdu.mpdu_data_off + bd->pdu.mpdu_len);\n\t\tskb_pull(skb, bd->pdu.mpdu_data_off);\n\n\t\t \n\t\tgoto done;\n\t}\n\n\tif (bd->pdu.mpdu_header_off < sizeof(*bd) ||\n\t    bd->pdu.mpdu_header_off + bd->pdu.mpdu_len > WCN36XX_PKT_SIZE)\n\t\tgoto drop;\n\n\tskb_put(skb, bd->pdu.mpdu_header_off + bd->pdu.mpdu_len);\n\tskb_pull(skb, bd->pdu.mpdu_header_off);\n\n\thdr = (struct ieee80211_hdr *) skb->data;\n\tfc = __le16_to_cpu(hdr->frame_control);\n\tsn = IEEE80211_SEQ_TO_SN(__le16_to_cpu(hdr->seq_ctrl));\n\n\tstatus.mactime = 10;\n\tstatus.signal = -get_rssi0(bd);\n\tstatus.antenna = 1;\n\tstatus.flag = 0;\n\tstatus.rx_flags = 0;\n\tstatus.flag |= RX_FLAG_IV_STRIPPED |\n\t\t       RX_FLAG_MMIC_STRIPPED |\n\t\t       RX_FLAG_DECRYPTED;\n\n\twcn36xx_dbg(WCN36XX_DBG_RX, \"status.flags=%x\\n\", status.flag);\n\n\tif (bd->scan_learn) {\n\t\t \n\t\tu8 hwch = (bd->reserved0 << 4) + bd->rx_ch;\n\n\t\tif (bd->rf_band != 1 && hwch <= sizeof(ab_rx_ch_map) && hwch >= 1) {\n\t\t\tstatus.band = NL80211_BAND_5GHZ;\n\t\t\tstatus.freq = ieee80211_channel_to_frequency(ab_rx_ch_map[hwch - 1],\n\t\t\t\t\t\t\t\t     status.band);\n\t\t} else {\n\t\t\tstatus.band = NL80211_BAND_2GHZ;\n\t\t\tstatus.freq = ieee80211_channel_to_frequency(hwch, status.band);\n\t\t}\n\t} else {\n\t\tstatus.band = WCN36XX_BAND(wcn);\n\t\tstatus.freq = WCN36XX_CENTER_FREQ(wcn);\n\t}\n\n\twcn36xx_update_survey(wcn, status.signal, get_snr(bd),\n\t\t\t      status.band, status.freq);\n\n\tif (bd->rate_id < ARRAY_SIZE(wcn36xx_rate_table)) {\n\t\trate = &wcn36xx_rate_table[bd->rate_id];\n\t\tstatus.encoding = rate->encoding;\n\t\tstatus.enc_flags = rate->encoding_flags;\n\t\tstatus.bw = rate->bw;\n\t\tstatus.rate_idx = rate->mcs_or_legacy_index;\n\t\tstatus.nss = 1;\n\n\t\tif (status.band == NL80211_BAND_5GHZ &&\n\t\t    status.encoding == RX_ENC_LEGACY &&\n\t\t    status.rate_idx >= 4) {\n\t\t\t \n\t\t\tstatus.rate_idx -= 4;\n\t\t}\n\t} else {\n\t\tstatus.encoding = 0;\n\t\tstatus.bw = 0;\n\t\tstatus.enc_flags = 0;\n\t\tstatus.rate_idx = 0;\n\t}\n\n\tif (ieee80211_is_beacon(hdr->frame_control) ||\n\t    ieee80211_is_probe_resp(hdr->frame_control))\n\t\tstatus.boottime_ns = ktime_get_boottime_ns();\n\n\tmemcpy(IEEE80211_SKB_RXCB(skb), &status, sizeof(status));\n\n\tif (ieee80211_is_beacon(hdr->frame_control)) {\n\t\twcn36xx_dbg(WCN36XX_DBG_BEACON, \"beacon skb %p len %d fc %04x sn %d\\n\",\n\t\t\t    skb, skb->len, fc, sn);\n\t\twcn36xx_dbg_dump(WCN36XX_DBG_BEACON_DUMP, \"SKB <<< \",\n\t\t\t\t (char *)skb->data, skb->len);\n\t} else {\n\t\twcn36xx_dbg(WCN36XX_DBG_RX, \"rx skb %p len %d fc %04x sn %d\\n\",\n\t\t\t    skb, skb->len, fc, sn);\n\t\twcn36xx_dbg_dump(WCN36XX_DBG_RX_DUMP, \"SKB <<< \",\n\t\t\t\t (char *)skb->data, skb->len);\n\t}\n\ndone:\n\t \n\tif (unlikely(bd->asf && !(bd->lsf && bd->esf))) {\n\t\tif (bd->esf && !skb_queue_empty(&wcn->amsdu)) {\n\t\t\twcn36xx_err(\"Discarding non complete chain\");\n\t\t\t__skb_queue_purge_irq(&wcn->amsdu);\n\t\t}\n\n\t\t__skb_queue_tail(&wcn->amsdu, skb);\n\n\t\tif (!bd->lsf)\n\t\t\treturn 0;  \n\n\t\tskb = wcn36xx_unchain_msdu(&wcn->amsdu);\n\t\tif (!skb)\n\t\t\tgoto drop;\n\t}\n\n\tieee80211_rx_irqsafe(wcn->hw, skb);\n\n\treturn 0;\n\ndrop:  \n\twcn36xx_err(\"Drop frame! skb:%p len:%u hoff:%u doff:%u asf=%u esf=%u lsf=%u\\n\",\n\t\t    skb, bd->pdu.mpdu_len, bd->pdu.mpdu_header_off,\n\t\t    bd->pdu.mpdu_data_off, bd->asf, bd->esf, bd->lsf);\n\n\tdev_kfree_skb_irq(skb);\n\t__skb_queue_purge_irq(&wcn->amsdu);\n\n\treturn -EINVAL;\n}\n\nstatic void wcn36xx_set_tx_pdu(struct wcn36xx_tx_bd *bd,\n\t\t\t       u32 mpdu_header_len,\n\t\t\t       u32 len,\n\t\t\t       u16 tid)\n{\n\tbd->pdu.mpdu_header_len = mpdu_header_len;\n\tbd->pdu.mpdu_header_off = sizeof(*bd);\n\tbd->pdu.mpdu_data_off = bd->pdu.mpdu_header_len +\n\t\tbd->pdu.mpdu_header_off;\n\tbd->pdu.mpdu_len = len;\n\tbd->pdu.tid = tid;\n}\n\nstatic inline struct wcn36xx_vif *get_vif_by_addr(struct wcn36xx *wcn,\n\t\t\t\t\t\t  u8 *addr)\n{\n\tstruct wcn36xx_vif *vif_priv = NULL;\n\tstruct ieee80211_vif *vif = NULL;\n\tlist_for_each_entry(vif_priv, &wcn->vif_list, list) {\n\t\t\tvif = wcn36xx_priv_to_vif(vif_priv);\n\t\t\tif (memcmp(vif->addr, addr, ETH_ALEN) == 0)\n\t\t\t\treturn vif_priv;\n\t}\n\twcn36xx_warn(\"vif %pM not found\\n\", addr);\n\treturn NULL;\n}\n\nstatic void wcn36xx_tx_start_ampdu(struct wcn36xx *wcn,\n\t\t\t\t   struct wcn36xx_sta *sta_priv,\n\t\t\t\t   struct sk_buff *skb)\n{\n\tstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *)skb->data;\n\tstruct ieee80211_sta *sta;\n\tu8 *qc, tid;\n\n\tif (!conf_is_ht(&wcn->hw->conf))\n\t\treturn;\n\n\tsta = wcn36xx_priv_to_sta(sta_priv);\n\n\tif (WARN_ON(!ieee80211_is_data_qos(hdr->frame_control)))\n\t\treturn;\n\n\tif (skb_get_queue_mapping(skb) == IEEE80211_AC_VO)\n\t\treturn;\n\n\tqc = ieee80211_get_qos_ctl(hdr);\n\ttid = qc[0] & IEEE80211_QOS_CTL_TID_MASK;\n\n\tspin_lock(&sta_priv->ampdu_lock);\n\tif (sta_priv->ampdu_state[tid] != WCN36XX_AMPDU_NONE)\n\t\tgoto out_unlock;\n\n\tif (sta_priv->non_agg_frame_ct++ >= WCN36XX_AMPDU_START_THRESH) {\n\t\tsta_priv->ampdu_state[tid] = WCN36XX_AMPDU_START;\n\t\tsta_priv->non_agg_frame_ct = 0;\n\t\tieee80211_start_tx_ba_session(sta, tid, 0);\n\t}\nout_unlock:\n\tspin_unlock(&sta_priv->ampdu_lock);\n}\n\nstatic void wcn36xx_set_tx_data(struct wcn36xx_tx_bd *bd,\n\t\t\t\tstruct wcn36xx *wcn,\n\t\t\t\tstruct wcn36xx_vif **vif_priv,\n\t\t\t\tstruct wcn36xx_sta *sta_priv,\n\t\t\t\tstruct sk_buff *skb,\n\t\t\t\tbool bcast)\n{\n\tstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *)skb->data;\n\tstruct ieee80211_tx_info *info = IEEE80211_SKB_CB(skb);\n\tstruct ieee80211_vif *vif = NULL;\n\tstruct wcn36xx_vif *__vif_priv = NULL;\n\tbool is_data_qos = ieee80211_is_data_qos(hdr->frame_control);\n\tu16 tid = 0;\n\n\tbd->bd_rate = WCN36XX_BD_RATE_DATA;\n\n\t \n\tif (sta_priv) {\n\t\t__vif_priv = sta_priv->vif;\n\t\tvif = wcn36xx_priv_to_vif(__vif_priv);\n\n\t\tbd->dpu_sign = sta_priv->ucast_dpu_sign;\n\t\tif (vif->type == NL80211_IFTYPE_STATION) {\n\t\t\tbd->sta_index = sta_priv->bss_sta_index;\n\t\t\tbd->dpu_desc_idx = sta_priv->bss_dpu_desc_index;\n\t\t} else if (vif->type == NL80211_IFTYPE_AP ||\n\t\t\t   vif->type == NL80211_IFTYPE_ADHOC ||\n\t\t\t   vif->type == NL80211_IFTYPE_MESH_POINT) {\n\t\t\tbd->sta_index = sta_priv->sta_index;\n\t\t\tbd->dpu_desc_idx = sta_priv->dpu_desc_index;\n\t\t}\n\t} else {\n\t\t__vif_priv = get_vif_by_addr(wcn, hdr->addr2);\n\t\tbd->sta_index = __vif_priv->self_sta_index;\n\t\tbd->dpu_desc_idx = __vif_priv->self_dpu_desc_index;\n\t\tbd->dpu_sign = __vif_priv->self_ucast_dpu_sign;\n\t}\n\n\tif (is_data_qos) {\n\t\ttid = ieee80211_get_tid(hdr);\n\t\t \n\t\tbd->queue_id = tid;\n\t\tbd->pdu.bd_ssn = WCN36XX_TXBD_SSN_FILL_DPU_QOS;\n\t} else {\n\t\tbd->pdu.bd_ssn = WCN36XX_TXBD_SSN_FILL_DPU_NON_QOS;\n\t}\n\n\tif (info->flags & IEEE80211_TX_INTFL_DONT_ENCRYPT ||\n\t    (sta_priv && !sta_priv->is_data_encrypted)) {\n\t\tbd->dpu_ne = 1;\n\t}\n\n\tif (ieee80211_is_any_nullfunc(hdr->frame_control)) {\n\t\t \n\t\tbd->queue_id = WCN36XX_TX_U_WQ_ID;\n\t\tbd->bd_rate = WCN36XX_BD_RATE_CTRL;\n\t\tif (ieee80211_is_qos_nullfunc(hdr->frame_control))\n\t\t\tbd->pdu.bd_ssn = WCN36XX_TXBD_SSN_FILL_HOST;\n\t}\n\n\tif (bcast) {\n\t\tbd->ub = 1;\n\t\tbd->ack_policy = 1;\n\t}\n\t*vif_priv = __vif_priv;\n\n\twcn36xx_set_tx_pdu(bd,\n\t\t\t   is_data_qos ?\n\t\t\t   sizeof(struct ieee80211_qos_hdr) :\n\t\t\t   sizeof(struct ieee80211_hdr_3addr),\n\t\t\t   skb->len, tid);\n\n\tif (sta_priv && is_data_qos)\n\t\twcn36xx_tx_start_ampdu(wcn, sta_priv, skb);\n}\n\nstatic void wcn36xx_set_tx_mgmt(struct wcn36xx_tx_bd *bd,\n\t\t\t\tstruct wcn36xx *wcn,\n\t\t\t\tstruct wcn36xx_vif **vif_priv,\n\t\t\t\tstruct sk_buff *skb,\n\t\t\t\tbool bcast)\n{\n\tstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *)skb->data;\n\tstruct wcn36xx_vif *__vif_priv =\n\t\tget_vif_by_addr(wcn, hdr->addr2);\n\tbd->sta_index = __vif_priv->self_sta_index;\n\tbd->dpu_desc_idx = __vif_priv->self_dpu_desc_index;\n\tbd->dpu_ne = 1;\n\n\t \n\tif (ieee80211_is_mgmt(hdr->frame_control))\n\t\tbd->bd_rate = (WCN36XX_BAND(wcn) == NL80211_BAND_5GHZ) ?\n\t\t\tWCN36XX_BD_RATE_CTRL :\n\t\t\tWCN36XX_BD_RATE_MGMT;\n\telse if (ieee80211_is_ctl(hdr->frame_control))\n\t\tbd->bd_rate = WCN36XX_BD_RATE_CTRL;\n\telse\n\t\twcn36xx_warn(\"frame control type unknown\\n\");\n\n\t \n\tif (__vif_priv->is_joining &&\n\t    ieee80211_is_probe_req(hdr->frame_control))\n\t\tbcast = false;\n\n\tif (bcast) {\n\t\t \n\t\tbd->ub = 1;\n\t\t \n\t\tbd->ack_policy = 1;\n\t\tbd->queue_id = WCN36XX_TX_B_WQ_ID;\n\t} else\n\t\tbd->queue_id = WCN36XX_TX_U_WQ_ID;\n\t*vif_priv = __vif_priv;\n\n\tbd->pdu.bd_ssn = WCN36XX_TXBD_SSN_FILL_DPU_NON_QOS;\n\n\twcn36xx_set_tx_pdu(bd,\n\t\t\t   ieee80211_is_data_qos(hdr->frame_control) ?\n\t\t\t   sizeof(struct ieee80211_qos_hdr) :\n\t\t\t   sizeof(struct ieee80211_hdr_3addr),\n\t\t\t   skb->len, WCN36XX_TID);\n}\n\nint wcn36xx_start_tx(struct wcn36xx *wcn,\n\t\t     struct wcn36xx_sta *sta_priv,\n\t\t     struct sk_buff *skb)\n{\n\tstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *)skb->data;\n\tstruct wcn36xx_vif *vif_priv = NULL;\n\tstruct ieee80211_tx_info *info = IEEE80211_SKB_CB(skb);\n\tbool is_low = ieee80211_is_data(hdr->frame_control);\n\tbool bcast = is_broadcast_ether_addr(hdr->addr1) ||\n\t\tis_multicast_ether_addr(hdr->addr1);\n\tbool ack_ind = (info->flags & IEEE80211_TX_CTL_REQ_TX_STATUS) &&\n\t\t\t\t\t!(info->flags & IEEE80211_TX_CTL_NO_ACK);\n\tstruct wcn36xx_tx_bd bd;\n\tint ret;\n\n\tmemset(&bd, 0, sizeof(bd));\n\n\twcn36xx_dbg(WCN36XX_DBG_TX,\n\t\t    \"tx skb %p len %d fc %04x sn %d %s %s\\n\",\n\t\t    skb, skb->len, __le16_to_cpu(hdr->frame_control),\n\t\t    IEEE80211_SEQ_TO_SN(__le16_to_cpu(hdr->seq_ctrl)),\n\t\t    is_low ? \"low\" : \"high\", bcast ? \"bcast\" : \"ucast\");\n\n\twcn36xx_dbg_dump(WCN36XX_DBG_TX_DUMP, \"\", skb->data, skb->len);\n\n\tbd.dpu_rf = WCN36XX_BMU_WQ_TX;\n\n\tif (unlikely(ack_ind)) {\n\t\twcn36xx_dbg(WCN36XX_DBG_DXE, \"TX_ACK status requested\\n\");\n\n\t\t \n\t\tieee80211_stop_queues(wcn->hw);\n\n\t\t \n\t\tbd.tx_comp = 1;\n\t}\n\n\t \n\tif (is_low)\n\t\twcn36xx_set_tx_data(&bd, wcn, &vif_priv, sta_priv, skb, bcast);\n\telse\n\t\t \n\t\twcn36xx_set_tx_mgmt(&bd, wcn, &vif_priv, skb, bcast);\n\n\tbuff_to_be((u32 *)&bd, sizeof(bd)/sizeof(u32));\n\tbd.tx_bd_sign = 0xbdbdbdbd;\n\n\tret = wcn36xx_dxe_tx_frame(wcn, vif_priv, &bd, skb, is_low);\n\tif (unlikely(ret && ack_ind)) {\n\t\t \n\t\tieee80211_wake_queues(wcn->hw);\n\t}\n\n\treturn ret;\n}\n\nvoid wcn36xx_process_tx_rate(struct ani_global_class_a_stats_info *stats, struct rate_info *info)\n{\n\t \n\tif (stats->tx_rate_flags & HAL_TX_RATE_LEGACY)\n\t\tinfo->legacy = stats->tx_rate * 5;\n\n\tinfo->flags = 0;\n\tinfo->mcs = stats->mcs_index;\n\tinfo->nss = 1;\n\n\tif (stats->tx_rate_flags & (HAL_TX_RATE_HT20 | HAL_TX_RATE_HT40))\n\t\tinfo->flags |= RATE_INFO_FLAGS_MCS;\n\n\tif (stats->tx_rate_flags & (HAL_TX_RATE_VHT20 | HAL_TX_RATE_VHT40 | HAL_TX_RATE_VHT80))\n\t\tinfo->flags |= RATE_INFO_FLAGS_VHT_MCS;\n\n\tif (stats->tx_rate_flags & HAL_TX_RATE_SGI)\n\t\tinfo->flags |= RATE_INFO_FLAGS_SHORT_GI;\n\n\tif (stats->tx_rate_flags & (HAL_TX_RATE_HT20 | HAL_TX_RATE_VHT20))\n\t\tinfo->bw = RATE_INFO_BW_20;\n\n\tif (stats->tx_rate_flags & (HAL_TX_RATE_HT40 | HAL_TX_RATE_VHT40))\n\t\tinfo->bw = RATE_INFO_BW_40;\n\n\tif (stats->tx_rate_flags & HAL_TX_RATE_VHT80)\n\t\tinfo->bw = RATE_INFO_BW_80;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}