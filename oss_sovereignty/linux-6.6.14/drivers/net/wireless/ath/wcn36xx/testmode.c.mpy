{
  "module_name": "testmode.c",
  "hash_id": "04a6db91b249f56b823ab2ff1647e78a2dc8d8c5e57f7dab2bdca26621443194",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ath/wcn36xx/testmode.c",
  "human_readable_source": " \n\n#include <net/netlink.h>\n#include <linux/firmware.h>\n#include <net/cfg80211.h>\n#include \"wcn36xx.h\"\n\n#include \"testmode.h\"\n#include \"testmode_i.h\"\n#include \"hal.h\"\n#include \"smd.h\"\n\nstatic const struct nla_policy wcn36xx_tm_policy[WCN36XX_TM_ATTR_MAX + 1] = {\n\t[WCN36XX_TM_ATTR_CMD] = { .type = NLA_U16 },\n\t[WCN36XX_TM_ATTR_DATA] = { .type = NLA_BINARY,\n\t.len = WCN36XX_TM_DATA_MAX_LEN },\n};\n\nstruct build_release_number {\n\tu16 drv_major;\n\tu16 drv_minor;\n\tu16 drv_patch;\n\tu16 drv_build;\n\tu16 ptt_max;\n\tu16 ptt_min;\n\tu16 fw_ver;\n} __packed;\n\nstatic int wcn36xx_tm_cmd_ptt(struct wcn36xx *wcn, struct ieee80211_vif *vif,\n\t\t\t      struct nlattr *tb[])\n{\n\tint ret = 0, buf_len;\n\tvoid *buf;\n\tstruct ftm_rsp_msg *msg, *rsp = NULL;\n\tstruct sk_buff *skb;\n\n\tif (!tb[WCN36XX_TM_ATTR_DATA])\n\t\treturn -EINVAL;\n\n\tbuf = nla_data(tb[WCN36XX_TM_ATTR_DATA]);\n\tbuf_len = nla_len(tb[WCN36XX_TM_ATTR_DATA]);\n\tmsg = (struct ftm_rsp_msg *)buf;\n\n\twcn36xx_dbg(WCN36XX_DBG_TESTMODE,\n\t\t    \"testmode cmd wmi msg_id 0x%04X msg_len %d buf %pK buf_len %d\\n\",\n\t\t   msg->msg_id, msg->msg_body_length,\n\t\t   buf, buf_len);\n\n\twcn36xx_dbg_dump(WCN36XX_DBG_TESTMODE_DUMP, \"REQ \", buf, buf_len);\n\n\tif (msg->msg_id == MSG_GET_BUILD_RELEASE_NUMBER) {\n\t\tstruct build_release_number *body =\n\t\t\t\t(struct build_release_number *)\n\t\t\t\tmsg->msg_response;\n\n\t\tbody->drv_major = wcn->fw_major;\n\t\tbody->drv_minor = wcn->fw_minor;\n\t\tbody->drv_patch = wcn->fw_version;\n\t\tbody->drv_build = wcn->fw_revision;\n\t\tbody->ptt_max = 10;\n\t\tbody->ptt_min = 0;\n\n\t\trsp = msg;\n\t\trsp->resp_status = 0;\n\t} else {\n\t\twcn36xx_dbg(WCN36XX_DBG_TESTMODE,\n\t\t\t    \"PPT Request >> HAL size %d\\n\",\n\t\t\t\tmsg->msg_body_length);\n\n\t\tmsg->resp_status = wcn36xx_smd_process_ptt_msg(wcn, vif, msg,\n\t\t\t\t\t\t\t       msg->msg_body_length, (void *)(&rsp));\n\n\t\twcn36xx_dbg(WCN36XX_DBG_TESTMODE,\n\t\t\t    \"Response status = %d\\n\",\n\t\t\t\tmsg->resp_status);\n\t\tif (rsp)\n\t\t\twcn36xx_dbg(WCN36XX_DBG_TESTMODE,\n\t\t\t\t    \"PPT Response << HAL size %d\\n\",\n\t\t\t\t\trsp->msg_body_length);\n\t}\n\n\tif (!rsp) {\n\t\trsp = msg;\n\t\twcn36xx_warn(\"No response! Echoing request with response status %d\\n\",\n\t\t\t     rsp->resp_status);\n\t}\n\twcn36xx_dbg_dump(WCN36XX_DBG_TESTMODE_DUMP, \"RSP \",\n\t\t\t rsp, rsp->msg_body_length);\n\n\tskb = cfg80211_testmode_alloc_reply_skb(wcn->hw->wiphy,\n\t\t\t\t\t\tnla_total_size(msg->msg_body_length));\n\tif (!skb) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tret = nla_put(skb, WCN36XX_TM_ATTR_DATA, rsp->msg_body_length, rsp);\n\tif (ret) {\n\t\tkfree_skb(skb);\n\t\tgoto out;\n\t}\n\n\tret = cfg80211_testmode_reply(skb);\n\nout:\n\tif (rsp != msg)\n\t\tkfree(rsp);\n\n\treturn ret;\n}\n\nint wcn36xx_tm_cmd(struct ieee80211_hw *hw, struct ieee80211_vif *vif,\n\t\t   void *data, int len)\n{\n\tstruct wcn36xx *wcn = hw->priv;\n\tstruct nlattr *tb[WCN36XX_TM_ATTR_MAX + 1];\n\tint ret = 0;\n\tunsigned short attr;\n\n\twcn36xx_dbg_dump(WCN36XX_DBG_TESTMODE_DUMP, \"Data:\", data, len);\n\tret = nla_parse_deprecated(tb, WCN36XX_TM_ATTR_MAX, data, len,\n\t\t\t\t   wcn36xx_tm_policy, NULL);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!tb[WCN36XX_TM_ATTR_CMD])\n\t\treturn -EINVAL;\n\n\tattr = nla_get_u16(tb[WCN36XX_TM_ATTR_CMD]);\n\n\tif (attr != WCN36XX_TM_CMD_PTT)\n\t\treturn -EOPNOTSUPP;\n\n\treturn wcn36xx_tm_cmd_ptt(wcn, vif, tb);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}