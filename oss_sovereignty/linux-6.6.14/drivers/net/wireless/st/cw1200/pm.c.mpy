{
  "module_name": "pm.c",
  "hash_id": "fdc09ad5fb717c8efe8545f1185fd47f957db6f16b4d59567418bcfacd564660",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/st/cw1200/pm.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/if_ether.h>\n#include \"cw1200.h\"\n#include \"pm.h\"\n#include \"sta.h\"\n#include \"bh.h\"\n#include \"hwbus.h\"\n\n#define CW1200_BEACON_SKIPPING_MULTIPLIER 3\n\nstruct cw1200_udp_port_filter {\n\tstruct wsm_udp_port_filter_hdr hdr;\n\t \n\tstruct wsm_udp_port_filter filters[WSM_MAX_FILTER_ELEMENTS];\n} __packed;\n\nstruct cw1200_ether_type_filter {\n\tstruct wsm_ether_type_filter_hdr hdr;\n\t \n\tstruct wsm_ether_type_filter filters[WSM_MAX_FILTER_ELEMENTS];\n} __packed;\n\nstatic struct cw1200_udp_port_filter cw1200_udp_port_filter_on = {\n\t.hdr.num = 2,\n\t.filters = {\n\t\t[0] = {\n\t\t\t.action = WSM_FILTER_ACTION_FILTER_OUT,\n\t\t\t.type = WSM_FILTER_PORT_TYPE_DST,\n\t\t\t.port = __cpu_to_le16(67),  \n\t\t},\n\t\t[1] = {\n\t\t\t.action = WSM_FILTER_ACTION_FILTER_OUT,\n\t\t\t.type = WSM_FILTER_PORT_TYPE_DST,\n\t\t\t.port = __cpu_to_le16(68),  \n\t\t},\n\t}\n};\n\nstatic struct wsm_udp_port_filter_hdr cw1200_udp_port_filter_off = {\n\t.num = 0,\n};\n\n#ifndef ETH_P_WAPI\n#define ETH_P_WAPI     0x88B4\n#endif\n\nstatic struct cw1200_ether_type_filter cw1200_ether_type_filter_on = {\n\t.hdr.num = 4,\n\t.filters = {\n\t\t[0] = {\n\t\t\t.action = WSM_FILTER_ACTION_FILTER_IN,\n\t\t\t.type = __cpu_to_le16(ETH_P_IP),\n\t\t},\n\t\t[1] = {\n\t\t\t.action = WSM_FILTER_ACTION_FILTER_IN,\n\t\t\t.type = __cpu_to_le16(ETH_P_PAE),\n\t\t},\n\t\t[2] = {\n\t\t\t.action = WSM_FILTER_ACTION_FILTER_IN,\n\t\t\t.type = __cpu_to_le16(ETH_P_WAPI),\n\t\t},\n\t\t[3] = {\n\t\t\t.action = WSM_FILTER_ACTION_FILTER_IN,\n\t\t\t.type = __cpu_to_le16(ETH_P_ARP),\n\t\t},\n\t},\n};\n\nstatic struct wsm_ether_type_filter_hdr cw1200_ether_type_filter_off = {\n\t.num = 0,\n};\n\n \nstruct cw1200_suspend_state {\n\tunsigned long bss_loss_tmo;\n\tunsigned long join_tmo;\n\tunsigned long direct_probe;\n\tunsigned long link_id_gc;\n\tbool beacon_skipping;\n\tu8 prev_ps_mode;\n};\n\nstatic void cw1200_pm_stay_awake_tmo(struct timer_list *unused)\n{\n\t \n}\n\nint cw1200_pm_init(struct cw1200_pm_state *pm,\n\t\t   struct cw1200_common *priv)\n{\n\tspin_lock_init(&pm->lock);\n\n\ttimer_setup(&pm->stay_awake, cw1200_pm_stay_awake_tmo, 0);\n\n\treturn 0;\n}\n\nvoid cw1200_pm_deinit(struct cw1200_pm_state *pm)\n{\n\tdel_timer_sync(&pm->stay_awake);\n}\n\nvoid cw1200_pm_stay_awake(struct cw1200_pm_state *pm,\n\t\t\t  unsigned long tmo)\n{\n\tlong cur_tmo;\n\tspin_lock_bh(&pm->lock);\n\tcur_tmo = pm->stay_awake.expires - jiffies;\n\tif (!timer_pending(&pm->stay_awake) || cur_tmo < (long)tmo)\n\t\tmod_timer(&pm->stay_awake, jiffies + tmo);\n\tspin_unlock_bh(&pm->lock);\n}\n\nstatic long cw1200_suspend_work(struct delayed_work *work)\n{\n\tint ret = cancel_delayed_work(work);\n\tlong tmo;\n\tif (ret > 0) {\n\t\t \n\t\ttmo = work->timer.expires - jiffies;\n\t\tif (tmo < 0)\n\t\t\ttmo = 0;\n\t} else {\n\t\ttmo = -1;\n\t}\n\treturn tmo;\n}\n\nstatic int cw1200_resume_work(struct cw1200_common *priv,\n\t\t\t       struct delayed_work *work,\n\t\t\t       unsigned long tmo)\n{\n\tif ((long)tmo < 0)\n\t\treturn 1;\n\n\treturn queue_delayed_work(priv->workqueue, work, tmo);\n}\n\nint cw1200_can_suspend(struct cw1200_common *priv)\n{\n\tif (atomic_read(&priv->bh_rx)) {\n\t\twiphy_dbg(priv->hw->wiphy, \"Suspend interrupted.\\n\");\n\t\treturn 0;\n\t}\n\treturn 1;\n}\nEXPORT_SYMBOL_GPL(cw1200_can_suspend);\n\nint cw1200_wow_suspend(struct ieee80211_hw *hw, struct cfg80211_wowlan *wowlan)\n{\n\tstruct cw1200_common *priv = hw->priv;\n\tstruct cw1200_pm_state *pm_state = &priv->pm_state;\n\tstruct cw1200_suspend_state *state;\n\tint ret;\n\n\tspin_lock_bh(&pm_state->lock);\n\tret = timer_pending(&pm_state->stay_awake);\n\tspin_unlock_bh(&pm_state->lock);\n\tif (ret)\n\t\treturn -EAGAIN;\n\n\t \n\tif (priv->tx_queue_stats.num_queued)\n\t\treturn -EBUSY;\n\n\t \n\tif (!mutex_trylock(&priv->conf_mutex))\n\t\treturn -EBUSY;\n\n\t \n\tif (priv->channel_switch_in_progress)\n\t\tgoto revert1;\n\n\t \n\tif (priv->join_pending)\n\t\tgoto revert1;\n\n\t \n\tif (down_trylock(&priv->scan.lock))\n\t\tgoto revert1;\n\n\t \n\twsm_lock_tx_async(priv);\n\n\t \n\tif (wait_event_timeout(priv->bh_evt_wq,\n\t\t\t       !priv->hw_bufs_used, HZ / 10) <= 0)\n\t\tgoto revert2;\n\n\t \n\twsm_set_udp_port_filter(priv, &cw1200_udp_port_filter_on.hdr);\n\n\t \n\twsm_set_ether_type_filter(priv, &cw1200_ether_type_filter_on.hdr);\n\n\t \n\tstate = kzalloc(sizeof(struct cw1200_suspend_state), GFP_KERNEL);\n\tif (!state)\n\t\tgoto revert3;\n\n\t \n\tif (!priv->vif->p2p &&\n\t    priv->join_status == CW1200_JOIN_STATUS_STA &&\n\t    priv->powersave_mode.mode != WSM_PSM_PS) {\n\t\tstate->prev_ps_mode = priv->powersave_mode.mode;\n\t\tpriv->powersave_mode.mode = WSM_PSM_PS;\n\t\tcw1200_set_pm(priv, &priv->powersave_mode);\n\t\tif (wait_event_interruptible_timeout(priv->ps_mode_switch_done,\n\t\t\t\t\t\t     !priv->ps_mode_switch_in_progress, 1*HZ) <= 0) {\n\t\t\tgoto revert4;\n\t\t}\n\t}\n\n\t \n\tstate->bss_loss_tmo =\n\t\tcw1200_suspend_work(&priv->bss_loss_work);\n\tstate->join_tmo =\n\t\tcw1200_suspend_work(&priv->join_timeout);\n\tstate->direct_probe =\n\t\tcw1200_suspend_work(&priv->scan.probe_work);\n\tstate->link_id_gc =\n\t\tcw1200_suspend_work(&priv->link_id_gc_work);\n\n\tcancel_delayed_work_sync(&priv->clear_recent_scan_work);\n\tatomic_set(&priv->recent_scan, 0);\n\n\t \n\tif (priv->join_status == CW1200_JOIN_STATUS_STA &&\n\t    priv->join_dtim_period &&\n\t    !priv->has_multicast_subscription) {\n\t\tstate->beacon_skipping = true;\n\t\twsm_set_beacon_wakeup_period(priv,\n\t\t\t\t\t     priv->join_dtim_period,\n\t\t\t\t\t     CW1200_BEACON_SKIPPING_MULTIPLIER * priv->join_dtim_period);\n\t}\n\n\t \n\tif (cw1200_bh_suspend(priv))\n\t\tgoto revert5;\n\n\tret = timer_pending(&priv->mcast_timeout);\n\tif (ret)\n\t\tgoto revert6;\n\n\t \n\tpm_state->suspend_state = state;\n\n\t \n\tret = priv->hwbus_ops->power_mgmt(priv->hwbus_priv, true);\n\tif (ret) {\n\t\twiphy_err(priv->hw->wiphy,\n\t\t\t  \"PM request failed: %d. WoW is disabled.\\n\", ret);\n\t\tcw1200_wow_resume(hw);\n\t\treturn -EBUSY;\n\t}\n\n\t \n\tif (atomic_read(&priv->bh_rx)) {\n\t\tcw1200_wow_resume(hw);\n\t\treturn -EAGAIN;\n\t}\n\n\treturn 0;\n\nrevert6:\n\tWARN_ON(cw1200_bh_resume(priv));\nrevert5:\n\tcw1200_resume_work(priv, &priv->bss_loss_work,\n\t\t\t   state->bss_loss_tmo);\n\tcw1200_resume_work(priv, &priv->join_timeout,\n\t\t\t   state->join_tmo);\n\tcw1200_resume_work(priv, &priv->scan.probe_work,\n\t\t\t   state->direct_probe);\n\tcw1200_resume_work(priv, &priv->link_id_gc_work,\n\t\t\t   state->link_id_gc);\nrevert4:\n\tkfree(state);\nrevert3:\n\twsm_set_udp_port_filter(priv, &cw1200_udp_port_filter_off);\n\twsm_set_ether_type_filter(priv, &cw1200_ether_type_filter_off);\nrevert2:\n\twsm_unlock_tx(priv);\n\tup(&priv->scan.lock);\nrevert1:\n\tmutex_unlock(&priv->conf_mutex);\n\treturn -EBUSY;\n}\n\nint cw1200_wow_resume(struct ieee80211_hw *hw)\n{\n\tstruct cw1200_common *priv = hw->priv;\n\tstruct cw1200_pm_state *pm_state = &priv->pm_state;\n\tstruct cw1200_suspend_state *state;\n\n\tstate = pm_state->suspend_state;\n\tpm_state->suspend_state = NULL;\n\n\t \n\tpriv->hwbus_ops->power_mgmt(priv->hwbus_priv, false);\n\n\t \n\tup(&priv->scan.lock);\n\n\t \n\tWARN_ON(cw1200_bh_resume(priv));\n\n\t \n\tif (!priv->vif->p2p && priv->join_status == CW1200_JOIN_STATUS_STA) {\n\t\tpriv->powersave_mode.mode = state->prev_ps_mode;\n\t\tcw1200_set_pm(priv, &priv->powersave_mode);\n\t}\n\n\tif (state->beacon_skipping) {\n\t\twsm_set_beacon_wakeup_period(priv, priv->beacon_int *\n\t\t\t\t\t     priv->join_dtim_period >\n\t\t\t\t\t     MAX_BEACON_SKIP_TIME_MS ? 1 :\n\t\t\t\t\t     priv->join_dtim_period, 0);\n\t\tstate->beacon_skipping = false;\n\t}\n\n\t \n\tcw1200_resume_work(priv, &priv->bss_loss_work,\n\t\t\t   state->bss_loss_tmo);\n\tcw1200_resume_work(priv, &priv->join_timeout,\n\t\t\t   state->join_tmo);\n\tcw1200_resume_work(priv, &priv->scan.probe_work,\n\t\t\t   state->direct_probe);\n\tcw1200_resume_work(priv, &priv->link_id_gc_work,\n\t\t\t   state->link_id_gc);\n\n\t \n\twsm_set_udp_port_filter(priv, &cw1200_udp_port_filter_off);\n\n\t \n\twsm_set_ether_type_filter(priv, &cw1200_ether_type_filter_off);\n\n\t \n\twsm_unlock_tx(priv);\n\n\t \n\tmutex_unlock(&priv->conf_mutex);\n\n\t \n\tkfree(state);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}