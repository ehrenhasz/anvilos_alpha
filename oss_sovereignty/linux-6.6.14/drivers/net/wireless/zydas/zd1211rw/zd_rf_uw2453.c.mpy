{
  "module_name": "zd_rf_uw2453.c",
  "hash_id": "5cab96f40f5a6ce97634cee7ac16cafe071476939145a4ddd143b6eb6f500133",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/zydas/zd1211rw/zd_rf_uw2453.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n\n#include \"zd_rf.h\"\n#include \"zd_usb.h\"\n#include \"zd_chip.h\"\n\n \n\n \n#define UW2453_REGWRITE(reg, val) ((((reg) & 0xf) << 20) | ((val) & 0xfffff))\n\n \n\n \nstatic const u8 uw2453_std_synth[] = {\n\tRF_CHANNEL( 1) = 0x47,\n\tRF_CHANNEL( 2) = 0x47,\n\tRF_CHANNEL( 3) = 0x67,\n\tRF_CHANNEL( 4) = 0x67,\n\tRF_CHANNEL( 5) = 0x67,\n\tRF_CHANNEL( 6) = 0x67,\n\tRF_CHANNEL( 7) = 0x57,\n\tRF_CHANNEL( 8) = 0x57,\n\tRF_CHANNEL( 9) = 0x57,\n\tRF_CHANNEL(10) = 0x57,\n\tRF_CHANNEL(11) = 0x77,\n\tRF_CHANNEL(12) = 0x77,\n\tRF_CHANNEL(13) = 0x77,\n\tRF_CHANNEL(14) = 0x4f,\n};\n\n \nstatic const u16 uw2453_synth_divide[] = {\n\tRF_CHANNEL( 1) = 0x999,\n\tRF_CHANNEL( 2) = 0x99b,\n\tRF_CHANNEL( 3) = 0x998,\n\tRF_CHANNEL( 4) = 0x99a,\n\tRF_CHANNEL( 5) = 0x999,\n\tRF_CHANNEL( 6) = 0x99b,\n\tRF_CHANNEL( 7) = 0x998,\n\tRF_CHANNEL( 8) = 0x99a,\n\tRF_CHANNEL( 9) = 0x999,\n\tRF_CHANNEL(10) = 0x99b,\n\tRF_CHANNEL(11) = 0x998,\n\tRF_CHANNEL(12) = 0x99a,\n\tRF_CHANNEL(13) = 0x999,\n\tRF_CHANNEL(14) = 0xccc,\n};\n\n \n#define CHAN_TO_PAIRIDX(a) ((a - 1) / 2)\n#define RF_CHANPAIR(a,b) [CHAN_TO_PAIRIDX(a)]\nstatic const u16 uw2453_std_vco_cfg[][7] = {\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x664d,\n\t\tRF_CHANPAIR( 3,  4) = 0x604d,\n\t\tRF_CHANPAIR( 5,  6) = 0x6675,\n\t\tRF_CHANPAIR( 7,  8) = 0x6475,\n\t\tRF_CHANPAIR( 9, 10) = 0x6655,\n\t\tRF_CHANPAIR(11, 12) = 0x6455,\n\t\tRF_CHANPAIR(13, 14) = 0x6665,\n\t},\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x666d,\n\t\tRF_CHANPAIR( 3,  4) = 0x606d,\n\t\tRF_CHANPAIR( 5,  6) = 0x664d,\n\t\tRF_CHANPAIR( 7,  8) = 0x644d,\n\t\tRF_CHANPAIR( 9, 10) = 0x6675,\n\t\tRF_CHANPAIR(11, 12) = 0x6475,\n\t\tRF_CHANPAIR(13, 14) = 0x6655,\n\t},\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x665d,\n\t\tRF_CHANPAIR( 3,  4) = 0x605d,\n\t\tRF_CHANPAIR( 5,  6) = 0x666d,\n\t\tRF_CHANPAIR( 7,  8) = 0x646d,\n\t\tRF_CHANPAIR( 9, 10) = 0x664d,\n\t\tRF_CHANPAIR(11, 12) = 0x644d,\n\t\tRF_CHANPAIR(13, 14) = 0x6675,\n\t},\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x667d,\n\t\tRF_CHANPAIR( 3,  4) = 0x607d,\n\t\tRF_CHANPAIR( 5,  6) = 0x665d,\n\t\tRF_CHANPAIR( 7,  8) = 0x645d,\n\t\tRF_CHANPAIR( 9, 10) = 0x666d,\n\t\tRF_CHANPAIR(11, 12) = 0x646d,\n\t\tRF_CHANPAIR(13, 14) = 0x664d,\n\t},\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x6643,\n\t\tRF_CHANPAIR( 3,  4) = 0x6043,\n\t\tRF_CHANPAIR( 5,  6) = 0x667d,\n\t\tRF_CHANPAIR( 7,  8) = 0x647d,\n\t\tRF_CHANPAIR( 9, 10) = 0x665d,\n\t\tRF_CHANPAIR(11, 12) = 0x645d,\n\t\tRF_CHANPAIR(13, 14) = 0x666d,\n\t},\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x6663,\n\t\tRF_CHANPAIR( 3,  4) = 0x6063,\n\t\tRF_CHANPAIR( 5,  6) = 0x6643,\n\t\tRF_CHANPAIR( 7,  8) = 0x6443,\n\t\tRF_CHANPAIR( 9, 10) = 0x667d,\n\t\tRF_CHANPAIR(11, 12) = 0x647d,\n\t\tRF_CHANPAIR(13, 14) = 0x665d,\n\t},\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x6653,\n\t\tRF_CHANPAIR( 3,  4) = 0x6053,\n\t\tRF_CHANPAIR( 5,  6) = 0x6663,\n\t\tRF_CHANPAIR( 7,  8) = 0x6463,\n\t\tRF_CHANPAIR( 9, 10) = 0x6643,\n\t\tRF_CHANPAIR(11, 12) = 0x6443,\n\t\tRF_CHANPAIR(13, 14) = 0x667d,\n\t},\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x6673,\n\t\tRF_CHANPAIR( 3,  4) = 0x6073,\n\t\tRF_CHANPAIR( 5,  6) = 0x6653,\n\t\tRF_CHANPAIR( 7,  8) = 0x6453,\n\t\tRF_CHANPAIR( 9, 10) = 0x6663,\n\t\tRF_CHANPAIR(11, 12) = 0x6463,\n\t\tRF_CHANPAIR(13, 14) = 0x6643,\n\t},\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x664b,\n\t\tRF_CHANPAIR( 3,  4) = 0x604b,\n\t\tRF_CHANPAIR( 5,  6) = 0x6673,\n\t\tRF_CHANPAIR( 7,  8) = 0x6473,\n\t\tRF_CHANPAIR( 9, 10) = 0x6653,\n\t\tRF_CHANPAIR(11, 12) = 0x6453,\n\t\tRF_CHANPAIR(13, 14) = 0x6663,\n\t},\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x666b,\n\t\tRF_CHANPAIR( 3,  4) = 0x606b,\n\t\tRF_CHANPAIR( 5,  6) = 0x664b,\n\t\tRF_CHANPAIR( 7,  8) = 0x644b,\n\t\tRF_CHANPAIR( 9, 10) = 0x6673,\n\t\tRF_CHANPAIR(11, 12) = 0x6473,\n\t\tRF_CHANPAIR(13, 14) = 0x6653,\n\t},\n\t{  \n\t\tRF_CHANPAIR( 1,  2) = 0x665b,\n\t\tRF_CHANPAIR( 3,  4) = 0x605b,\n\t\tRF_CHANPAIR( 5,  6) = 0x666b,\n\t\tRF_CHANPAIR( 7,  8) = 0x646b,\n\t\tRF_CHANPAIR( 9, 10) = 0x664b,\n\t\tRF_CHANPAIR(11, 12) = 0x644b,\n\t\tRF_CHANPAIR(13, 14) = 0x6673,\n\t},\n\n};\n\n \nstatic const u16 uw2453_autocal_synth[] = {\n\tRF_CHANNEL( 1) = 0x6847,\n\tRF_CHANNEL( 2) = 0x6847,\n\tRF_CHANNEL( 3) = 0x6867,\n\tRF_CHANNEL( 4) = 0x6867,\n\tRF_CHANNEL( 5) = 0x6867,\n\tRF_CHANNEL( 6) = 0x6867,\n\tRF_CHANNEL( 7) = 0x6857,\n\tRF_CHANNEL( 8) = 0x6857,\n\tRF_CHANNEL( 9) = 0x6857,\n\tRF_CHANNEL(10) = 0x6857,\n\tRF_CHANNEL(11) = 0x6877,\n\tRF_CHANNEL(12) = 0x6877,\n\tRF_CHANNEL(13) = 0x6877,\n\tRF_CHANNEL(14) = 0x684f,\n};\n\n \nstatic const u16 UW2453_AUTOCAL_VCO_CFG = 0x6662;\n\n \nstatic u32 uw2453_txgain[] = {\n\t[0x00] = 0x0e313,\n\t[0x01] = 0x0fb13,\n\t[0x02] = 0x0e093,\n\t[0x03] = 0x0f893,\n\t[0x04] = 0x0ea93,\n\t[0x05] = 0x1f093,\n\t[0x06] = 0x1f493,\n\t[0x07] = 0x1f693,\n\t[0x08] = 0x1f393,\n\t[0x09] = 0x1f35b,\n\t[0x0a] = 0x1e6db,\n\t[0x0b] = 0x1ff3f,\n\t[0x0c] = 0x1ffff,\n\t[0x0d] = 0x361d7,\n\t[0x0e] = 0x37fbf,\n\t[0x0f] = 0x3ff8b,\n\t[0x10] = 0x3ff33,\n\t[0x11] = 0x3fb3f,\n\t[0x12] = 0x3ffff,\n};\n\n \nstruct uw2453_priv {\n\t \n\tint config;\n};\n\n#define UW2453_PRIV(rf) ((struct uw2453_priv *) (rf)->priv)\n\nstatic int uw2453_synth_set_channel(struct zd_chip *chip, int channel,\n\tbool autocal)\n{\n\tint r;\n\tint idx = channel - 1;\n\tu32 val;\n\n\tif (autocal)\n\t\tval = UW2453_REGWRITE(1, uw2453_autocal_synth[idx]);\n\telse\n\t\tval = UW2453_REGWRITE(1, uw2453_std_synth[idx]);\n\n\tr = zd_rfwrite_locked(chip, val, RF_RV_BITS);\n\tif (r)\n\t\treturn r;\n\n\treturn zd_rfwrite_locked(chip,\n\t\tUW2453_REGWRITE(2, uw2453_synth_divide[idx]), RF_RV_BITS);\n}\n\nstatic int uw2453_write_vco_cfg(struct zd_chip *chip, u16 value)\n{\n\t \n\tu32 val = 0x40000 | value;\n\treturn zd_rfwrite_locked(chip, UW2453_REGWRITE(3, val), RF_RV_BITS);\n}\n\nstatic int uw2453_init_mode(struct zd_chip *chip)\n{\n\tstatic const u32 rv[] = {\n\t\tUW2453_REGWRITE(0, 0x25f98),  \n\t\tUW2453_REGWRITE(0, 0x25f9a),  \n\t\tUW2453_REGWRITE(0, 0x25f94),  \n\t\tUW2453_REGWRITE(0, 0x27fd4),  \n\t};\n\n\treturn zd_rfwritev_locked(chip, rv, ARRAY_SIZE(rv), RF_RV_BITS);\n}\n\nstatic int uw2453_set_tx_gain_level(struct zd_chip *chip, int channel)\n{\n\tu8 int_value = chip->pwr_int_values[channel - 1];\n\n\tif (int_value >= ARRAY_SIZE(uw2453_txgain)) {\n\t\tdev_dbg_f(zd_chip_dev(chip), \"can't configure TX gain for \"\n\t\t\t  \"int value %x on channel %d\\n\", int_value, channel);\n\t\treturn 0;\n\t}\n\n\treturn zd_rfwrite_locked(chip,\n\t\tUW2453_REGWRITE(7, uw2453_txgain[int_value]), RF_RV_BITS);\n}\n\nstatic int uw2453_init_hw(struct zd_rf *rf)\n{\n\tint i, r;\n\tint found_config = -1;\n\tu16 intr_status;\n\tstruct zd_chip *chip = zd_rf_to_chip(rf);\n\n\tstatic const struct zd_ioreq16 ioreqs[] = {\n\t\t{ ZD_CR10,  0x89 }, { ZD_CR15,  0x20 },\n\t\t{ ZD_CR17,  0x28 },  \n\t\t{ ZD_CR23,  0x38 }, { ZD_CR24,  0x20 }, { ZD_CR26,  0x93 },\n\t\t{ ZD_CR27,  0x15 }, { ZD_CR28,  0x3e }, { ZD_CR29,  0x00 },\n\t\t{ ZD_CR33,  0x28 }, { ZD_CR34,  0x30 },\n\t\t{ ZD_CR35,  0x43 },  \n\t\t{ ZD_CR41,  0x24 }, { ZD_CR44,  0x32 },\n\t\t{ ZD_CR46,  0x92 },  \n\t\t{ ZD_CR47,  0x1e },\n\t\t{ ZD_CR48,  0x04 },  \n\t\t{ ZD_CR49,  0xfa }, { ZD_CR79,  0x58 }, { ZD_CR80,  0x30 },\n\t\t{ ZD_CR81,  0x30 }, { ZD_CR87,  0x0a }, { ZD_CR89,  0x04 },\n\t\t{ ZD_CR91,  0x00 }, { ZD_CR92,  0x0a }, { ZD_CR98,  0x8d },\n\t\t{ ZD_CR99,  0x28 }, { ZD_CR100, 0x02 },\n\t\t{ ZD_CR101, 0x09 },  \n\t\t{ ZD_CR102, 0x27 },\n\t\t{ ZD_CR106, 0x1c },  \n\t\t{ ZD_CR107, 0x1c },  \n\t\t{ ZD_CR109, 0x13 },\n\t\t{ ZD_CR110, 0x1f },  \n\t\t{ ZD_CR111, 0x13 }, { ZD_CR112, 0x1f }, { ZD_CR113, 0x27 },\n\t\t{ ZD_CR114, 0x23 },  \n\t\t{ ZD_CR115, 0x24 },  \n\t\t{ ZD_CR116, 0x24 },  \n\t\t{ ZD_CR117, 0xfa },  \n\t\t{ ZD_CR118, 0xf0 },  \n\t\t{ ZD_CR119, 0x1a },  \n\t\t{ ZD_CR120, 0x4f },\n\t\t{ ZD_CR121, 0x1f },  \n\t\t{ ZD_CR122, 0xf0 }, { ZD_CR123, 0x57 }, { ZD_CR125, 0xad },\n\t\t{ ZD_CR126, 0x6c }, { ZD_CR127, 0x03 },\n\t\t{ ZD_CR128, 0x14 },  \n\t\t{ ZD_CR129, 0x12 },  \n\t\t{ ZD_CR130, 0x10 }, { ZD_CR137, 0x50 }, { ZD_CR138, 0xa8 },\n\t\t{ ZD_CR144, 0xac }, { ZD_CR146, 0x20 }, { ZD_CR252, 0xff },\n\t\t{ ZD_CR253, 0xff },\n\t};\n\n\tstatic const u32 rv[] = {\n\t\tUW2453_REGWRITE(4, 0x2b),     \n\t\tUW2453_REGWRITE(5, 0x19e4f),  \n\t\tUW2453_REGWRITE(6, 0xf81ad),  \n\t\tUW2453_REGWRITE(7, 0x3fffe),  \n\n\t\t \n\t\tUW2453_REGWRITE(0, 0x25f9c),  \n\n\t\t \n\t\tUW2453_REGWRITE(1, 0x47),\n\t\tUW2453_REGWRITE(2, 0x999),\n\n\t\t \n\t\tUW2453_REGWRITE(3, 0x7602),\n\n\t\t \n\t\tUW2453_REGWRITE(3, 0x46063),\n\t};\n\n\tr = zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\n\tif (r)\n\t\treturn r;\n\n\tr = zd_rfwritev_locked(chip, rv, ARRAY_SIZE(rv), RF_RV_BITS);\n\tif (r)\n\t\treturn r;\n\n\tr = uw2453_init_mode(chip);\n\tif (r)\n\t\treturn r;\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(uw2453_std_vco_cfg) - 1; i++) {\n\t\t \n\t\tr = uw2453_synth_set_channel(chip, 1, false);\n\t\tif (r)\n\t\t\treturn r;\n\n\t\t \n\t\tr = uw2453_write_vco_cfg(chip, uw2453_std_vco_cfg[i][0]);\n\t\tif (r)\n\t\t\treturn r;\n\n\t\t \n\t\tr = zd_iowrite16_locked(chip, 0x0f, UW2453_INTR_REG);\n\t\tif (r)\n\t\t\treturn r;\n\n\t\t \n\t\tr = zd_ioread16_locked(chip, &intr_status, UW2453_INTR_REG);\n\t\tif (r)\n\t\t\treturn r;\n\n\t\tif (!(intr_status & 0xf)) {\n\t\t\tdev_dbg_f(zd_chip_dev(chip),\n\t\t\t\t\"PLL locked on configuration %d\\n\", i);\n\t\t\tfound_config = i;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (found_config == -1) {\n\t\t \n\t\tdev_dbg_f(zd_chip_dev(chip),\n\t\t\t\"PLL did not lock, using autocal\\n\");\n\n\t\tr = uw2453_synth_set_channel(chip, 1, true);\n\t\tif (r)\n\t\t\treturn r;\n\n\t\tr = uw2453_write_vco_cfg(chip, UW2453_AUTOCAL_VCO_CFG);\n\t\tif (r)\n\t\t\treturn r;\n\t}\n\n\t \n\tUW2453_PRIV(rf)->config = found_config + 1;\n\n\treturn zd_iowrite16_locked(chip, 0x06, ZD_CR203);\n}\n\nstatic int uw2453_set_channel(struct zd_rf *rf, u8 channel)\n{\n\tint r;\n\tu16 vco_cfg;\n\tint config = UW2453_PRIV(rf)->config;\n\tbool autocal = (config == -1);\n\tstruct zd_chip *chip = zd_rf_to_chip(rf);\n\n\tstatic const struct zd_ioreq16 ioreqs[] = {\n\t\t{ ZD_CR80,  0x30 }, { ZD_CR81,  0x30 }, { ZD_CR79,  0x58 },\n\t\t{ ZD_CR12,  0xf0 }, { ZD_CR77,  0x1b }, { ZD_CR78,  0x58 },\n\t};\n\n\tr = uw2453_synth_set_channel(chip, channel, autocal);\n\tif (r)\n\t\treturn r;\n\n\tif (autocal)\n\t\tvco_cfg = UW2453_AUTOCAL_VCO_CFG;\n\telse\n\t\tvco_cfg = uw2453_std_vco_cfg[config][CHAN_TO_PAIRIDX(channel)];\n\n\tr = uw2453_write_vco_cfg(chip, vco_cfg);\n\tif (r)\n\t\treturn r;\n\n\tr = uw2453_init_mode(chip);\n\tif (r)\n\t\treturn r;\n\n\tr = zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\n\tif (r)\n\t\treturn r;\n\n\tr = uw2453_set_tx_gain_level(chip, channel);\n\tif (r)\n\t\treturn r;\n\n\treturn zd_iowrite16_locked(chip, 0x06, ZD_CR203);\n}\n\nstatic int uw2453_switch_radio_on(struct zd_rf *rf)\n{\n\tint r;\n\tstruct zd_chip *chip = zd_rf_to_chip(rf);\n\tstruct zd_ioreq16 ioreqs[] = {\n\t\t{ ZD_CR11,  0x00 }, { ZD_CR251, 0x3f },\n\t};\n\n\t \n\tr = zd_rfwrite_locked(chip, UW2453_REGWRITE(0, 0x25f94), RF_RV_BITS);\n\tif (r)\n\t\treturn r;\n\n\tif (zd_chip_is_zd1211b(chip))\n\t\tioreqs[1].value = 0x7f;\n\n\treturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\n}\n\nstatic int uw2453_switch_radio_off(struct zd_rf *rf)\n{\n\tint r;\n\tstruct zd_chip *chip = zd_rf_to_chip(rf);\n\tstatic const struct zd_ioreq16 ioreqs[] = {\n\t\t{ ZD_CR11,  0x04 }, { ZD_CR251, 0x2f },\n\t};\n\n\t \n\t \n\tr = zd_rfwrite_locked(chip, UW2453_REGWRITE(0, 0x25f90), RF_RV_BITS);\n\tif (r)\n\t\treturn r;\n\n\treturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\n}\n\nstatic void uw2453_clear(struct zd_rf *rf)\n{\n\tkfree(rf->priv);\n}\n\nint zd_rf_init_uw2453(struct zd_rf *rf)\n{\n\trf->init_hw = uw2453_init_hw;\n\trf->set_channel = uw2453_set_channel;\n\trf->switch_radio_on = uw2453_switch_radio_on;\n\trf->switch_radio_off = uw2453_switch_radio_off;\n\trf->patch_6m_band_edge = zd_rf_generic_patch_6m;\n\trf->clear = uw2453_clear;\n\t \n\trf->update_channel_int = 0;\n\n\trf->priv = kmalloc(sizeof(struct uw2453_priv), GFP_KERNEL);\n\tif (rf->priv == NULL)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}