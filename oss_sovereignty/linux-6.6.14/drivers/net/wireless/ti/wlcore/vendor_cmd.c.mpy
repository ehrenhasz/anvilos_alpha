{
  "module_name": "vendor_cmd.c",
  "hash_id": "69727a4beb36953f71225c558ceb41bc7435137beccd07ca8048499f6f5bc015",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ti/wlcore/vendor_cmd.c",
  "human_readable_source": "\n \n\n#include <linux/pm_runtime.h>\n\n#include <net/mac80211.h>\n#include <net/netlink.h>\n\n#include \"wlcore.h\"\n#include \"debug.h\"\n#include \"hw_ops.h\"\n#include \"vendor_cmd.h\"\n\nstatic const\nstruct nla_policy wlcore_vendor_attr_policy[NUM_WLCORE_VENDOR_ATTR] = {\n\t[WLCORE_VENDOR_ATTR_FREQ]\t\t= { .type = NLA_U32 },\n\t[WLCORE_VENDOR_ATTR_GROUP_ID]\t\t= { .type = NLA_U32 },\n\t[WLCORE_VENDOR_ATTR_GROUP_KEY]\t\t= { .type = NLA_BINARY,\n\t\t\t\t\t\t    .len = WLAN_MAX_KEY_LEN },\n};\n\nstatic int\nwlcore_vendor_cmd_smart_config_start(struct wiphy *wiphy,\n\t\t\t\t     struct wireless_dev *wdev,\n\t\t\t\t     const void *data, int data_len)\n{\n\tstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\n\tstruct wl1271 *wl = hw->priv;\n\tstruct nlattr *tb[NUM_WLCORE_VENDOR_ATTR];\n\tint ret;\n\n\twl1271_debug(DEBUG_CMD, \"vendor cmd smart config start\");\n\n\tif (!data)\n\t\treturn -EINVAL;\n\n\tret = nla_parse_deprecated(tb, MAX_WLCORE_VENDOR_ATTR, data, data_len,\n\t\t\t\t   wlcore_vendor_attr_policy, NULL);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!tb[WLCORE_VENDOR_ATTR_GROUP_ID])\n\t\treturn -EINVAL;\n\n\tmutex_lock(&wl->mutex);\n\n\tif (unlikely(wl->state != WLCORE_STATE_ON)) {\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tret = pm_runtime_resume_and_get(wl->dev);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = wlcore_smart_config_start(wl,\n\t\t\tnla_get_u32(tb[WLCORE_VENDOR_ATTR_GROUP_ID]));\n\n\tpm_runtime_mark_last_busy(wl->dev);\n\tpm_runtime_put_autosuspend(wl->dev);\nout:\n\tmutex_unlock(&wl->mutex);\n\n\treturn ret;\n}\n\nstatic int\nwlcore_vendor_cmd_smart_config_stop(struct wiphy *wiphy,\n\t\t\t\t    struct wireless_dev *wdev,\n\t\t\t\t    const void *data, int data_len)\n{\n\tstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\n\tstruct wl1271 *wl = hw->priv;\n\tint ret;\n\n\twl1271_debug(DEBUG_CMD, \"testmode cmd smart config stop\");\n\n\tmutex_lock(&wl->mutex);\n\n\tif (unlikely(wl->state != WLCORE_STATE_ON)) {\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tret = pm_runtime_resume_and_get(wl->dev);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = wlcore_smart_config_stop(wl);\n\n\tpm_runtime_mark_last_busy(wl->dev);\n\tpm_runtime_put_autosuspend(wl->dev);\nout:\n\tmutex_unlock(&wl->mutex);\n\n\treturn ret;\n}\n\nstatic int\nwlcore_vendor_cmd_smart_config_set_group_key(struct wiphy *wiphy,\n\t\t\t\t\t     struct wireless_dev *wdev,\n\t\t\t\t\t     const void *data, int data_len)\n{\n\tstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\n\tstruct wl1271 *wl = hw->priv;\n\tstruct nlattr *tb[NUM_WLCORE_VENDOR_ATTR];\n\tint ret;\n\n\twl1271_debug(DEBUG_CMD, \"testmode cmd smart config set group key\");\n\n\tif (!data)\n\t\treturn -EINVAL;\n\n\tret = nla_parse_deprecated(tb, MAX_WLCORE_VENDOR_ATTR, data, data_len,\n\t\t\t\t   wlcore_vendor_attr_policy, NULL);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!tb[WLCORE_VENDOR_ATTR_GROUP_ID] ||\n\t    !tb[WLCORE_VENDOR_ATTR_GROUP_KEY])\n\t\treturn -EINVAL;\n\n\tmutex_lock(&wl->mutex);\n\n\tif (unlikely(wl->state != WLCORE_STATE_ON)) {\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tret = pm_runtime_resume_and_get(wl->dev);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = wlcore_smart_config_set_group_key(wl,\n\t\t\tnla_get_u32(tb[WLCORE_VENDOR_ATTR_GROUP_ID]),\n\t\t\tnla_len(tb[WLCORE_VENDOR_ATTR_GROUP_KEY]),\n\t\t\tnla_data(tb[WLCORE_VENDOR_ATTR_GROUP_KEY]));\n\n\tpm_runtime_mark_last_busy(wl->dev);\n\tpm_runtime_put_autosuspend(wl->dev);\nout:\n\tmutex_unlock(&wl->mutex);\n\n\treturn ret;\n}\n\nstatic const struct wiphy_vendor_command wlcore_vendor_commands[] = {\n\t{\n\t\t.info = {\n\t\t\t.vendor_id = TI_OUI,\n\t\t\t.subcmd = WLCORE_VENDOR_CMD_SMART_CONFIG_START,\n\t\t},\n\t\t.flags = WIPHY_VENDOR_CMD_NEED_NETDEV |\n\t\t\t WIPHY_VENDOR_CMD_NEED_RUNNING,\n\t\t.doit = wlcore_vendor_cmd_smart_config_start,\n\t\t.policy = wlcore_vendor_attr_policy,\n\t},\n\t{\n\t\t.info = {\n\t\t\t.vendor_id = TI_OUI,\n\t\t\t.subcmd = WLCORE_VENDOR_CMD_SMART_CONFIG_STOP,\n\t\t},\n\t\t.flags = WIPHY_VENDOR_CMD_NEED_NETDEV |\n\t\t\t WIPHY_VENDOR_CMD_NEED_RUNNING,\n\t\t.doit = wlcore_vendor_cmd_smart_config_stop,\n\t\t.policy = wlcore_vendor_attr_policy,\n\t},\n\t{\n\t\t.info = {\n\t\t\t.vendor_id = TI_OUI,\n\t\t\t.subcmd = WLCORE_VENDOR_CMD_SMART_CONFIG_SET_GROUP_KEY,\n\t\t},\n\t\t.flags = WIPHY_VENDOR_CMD_NEED_NETDEV |\n\t\t\t WIPHY_VENDOR_CMD_NEED_RUNNING,\n\t\t.doit = wlcore_vendor_cmd_smart_config_set_group_key,\n\t\t.policy = wlcore_vendor_attr_policy,\n\t},\n};\n\nstatic const struct nl80211_vendor_cmd_info wlcore_vendor_events[] = {\n\t{\n\t\t.vendor_id = TI_OUI,\n\t\t.subcmd = WLCORE_VENDOR_EVENT_SC_SYNC,\n\t},\n\t{\n\t\t.vendor_id = TI_OUI,\n\t\t.subcmd = WLCORE_VENDOR_EVENT_SC_DECODE,\n\t},\n};\n\nvoid wlcore_set_vendor_commands(struct wiphy *wiphy)\n{\n\twiphy->vendor_commands = wlcore_vendor_commands;\n\twiphy->n_vendor_commands = ARRAY_SIZE(wlcore_vendor_commands);\n\twiphy->vendor_events = wlcore_vendor_events;\n\twiphy->n_vendor_events = ARRAY_SIZE(wlcore_vendor_events);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}