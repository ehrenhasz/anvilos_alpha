{
  "module_name": "scan.c",
  "hash_id": "dc47343fe1f9ffee3d4a168c63ab5ce92097924632dd6269837e939e417758b2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ti/wl18xx/scan.c",
  "human_readable_source": "\n \n\n#include <linux/ieee80211.h>\n#include \"scan.h\"\n#include \"../wlcore/debug.h\"\n\nstatic void wl18xx_adjust_channels(struct wl18xx_cmd_scan_params *cmd,\n\t\t\t\t   struct wlcore_scan_channels *cmd_channels)\n{\n\tmemcpy(cmd->passive, cmd_channels->passive, sizeof(cmd->passive));\n\tmemcpy(cmd->active, cmd_channels->active, sizeof(cmd->active));\n\tcmd->dfs = cmd_channels->dfs;\n\tcmd->passive_active = cmd_channels->passive_active;\n\n\tmemcpy(cmd->channels_2, cmd_channels->channels_2,\n\t       sizeof(cmd->channels_2));\n\tmemcpy(cmd->channels_5, cmd_channels->channels_5,\n\t       sizeof(cmd->channels_5));\n\t \n}\n\nstatic int wl18xx_scan_send(struct wl1271 *wl, struct wl12xx_vif *wlvif,\n\t\t\t    struct cfg80211_scan_request *req)\n{\n\tstruct wl18xx_cmd_scan_params *cmd;\n\tstruct wlcore_scan_channels *cmd_channels = NULL;\n\tint ret;\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\tif (!cmd) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\t \n\tif (wlcore_is_p2p_mgmt(wlvif))\n\t\tcmd->role_id = wlvif->dev_role_id;\n\telse\n\t\tcmd->role_id = wlvif->role_id;\n\n\tif (WARN_ON(cmd->role_id == WL12XX_INVALID_ROLE_ID)) {\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tcmd->scan_type = SCAN_TYPE_SEARCH;\n\tcmd->rssi_threshold = -127;\n\tcmd->snr_threshold = 0;\n\n\tcmd->bss_type = SCAN_BSS_TYPE_ANY;\n\n\tcmd->ssid_from_list = 0;\n\tcmd->filter = 0;\n\tcmd->add_broadcast = 0;\n\n\tcmd->urgency = 0;\n\tcmd->protect = 0;\n\n\tcmd->n_probe_reqs = wl->conf.scan.num_probe_reqs;\n\tcmd->terminate_after = 0;\n\n\t \n\tWARN_ON(req->n_ssids > 1);\n\n\tcmd_channels = kzalloc(sizeof(*cmd_channels), GFP_KERNEL);\n\tif (!cmd_channels) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\twlcore_set_scan_chan_params(wl, cmd_channels, req->channels,\n\t\t\t\t    req->n_channels, req->n_ssids,\n\t\t\t\t    SCAN_TYPE_SEARCH);\n\twl18xx_adjust_channels(cmd, cmd_channels);\n\n\t \n\tcmd->total_cycles = 1;\n\n\tif (req->no_cck)\n\t\tcmd->rate = WL18XX_SCAN_RATE_6;\n\n\tcmd->tag = WL1271_SCAN_DEFAULT_TAG;\n\n\tif (req->n_ssids) {\n\t\tcmd->ssid_len = req->ssids[0].ssid_len;\n\t\tmemcpy(cmd->ssid, req->ssids[0].ssid, cmd->ssid_len);\n\t}\n\n\t \n\tif (cmd->active[0]) {\n\t\tu8 band = NL80211_BAND_2GHZ;\n\t\tret = wl12xx_cmd_build_probe_req(wl, wlvif,\n\t\t\t\t cmd->role_id, band,\n\t\t\t\t req->ssids ? req->ssids[0].ssid : NULL,\n\t\t\t\t req->ssids ? req->ssids[0].ssid_len : 0,\n\t\t\t\t req->ie,\n\t\t\t\t req->ie_len,\n\t\t\t\t NULL,\n\t\t\t\t 0,\n\t\t\t\t false);\n\t\tif (ret < 0) {\n\t\t\twl1271_error(\"2.4GHz PROBE request template failed\");\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tif (cmd->active[1] || cmd->dfs) {\n\t\tu8 band = NL80211_BAND_5GHZ;\n\t\tret = wl12xx_cmd_build_probe_req(wl, wlvif,\n\t\t\t\t cmd->role_id, band,\n\t\t\t\t req->ssids ? req->ssids[0].ssid : NULL,\n\t\t\t\t req->ssids ? req->ssids[0].ssid_len : 0,\n\t\t\t\t req->ie,\n\t\t\t\t req->ie_len,\n\t\t\t\t NULL,\n\t\t\t\t 0,\n\t\t\t\t false);\n\t\tif (ret < 0) {\n\t\t\twl1271_error(\"5GHz PROBE request template failed\");\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\twl1271_dump(DEBUG_SCAN, \"SCAN: \", cmd, sizeof(*cmd));\n\n\tret = wl1271_cmd_send(wl, CMD_SCAN, cmd, sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"SCAN failed\");\n\t\tgoto out;\n\t}\n\nout:\n\tkfree(cmd_channels);\n\tkfree(cmd);\n\treturn ret;\n}\n\nvoid wl18xx_scan_completed(struct wl1271 *wl, struct wl12xx_vif *wlvif)\n{\n\twl->scan.failed = false;\n\tcancel_delayed_work(&wl->scan_complete_work);\n\tieee80211_queue_delayed_work(wl->hw, &wl->scan_complete_work,\n\t\t\t\t     msecs_to_jiffies(0));\n}\n\nstatic\nint wl18xx_scan_sched_scan_config(struct wl1271 *wl,\n\t\t\t\t  struct wl12xx_vif *wlvif,\n\t\t\t\t  struct cfg80211_sched_scan_request *req,\n\t\t\t\t  struct ieee80211_scan_ies *ies)\n{\n\tstruct wl18xx_cmd_scan_params *cmd;\n\tstruct wlcore_scan_channels *cmd_channels = NULL;\n\tstruct conf_sched_scan_settings *c = &wl->conf.sched_scan;\n\tint ret;\n\tint filter_type;\n\n\twl1271_debug(DEBUG_CMD, \"cmd sched_scan scan config\");\n\n\tfilter_type = wlcore_scan_sched_scan_ssid_list(wl, wlvif, req);\n\tif (filter_type < 0)\n\t\treturn filter_type;\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\tif (!cmd) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tcmd->role_id = wlvif->role_id;\n\n\tif (WARN_ON(cmd->role_id == WL12XX_INVALID_ROLE_ID)) {\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tcmd->scan_type = SCAN_TYPE_PERIODIC;\n\tcmd->rssi_threshold = c->rssi_threshold;\n\tcmd->snr_threshold = c->snr_threshold;\n\n\t \n\tcmd->bss_type = SCAN_BSS_TYPE_ANY;\n\n\tcmd->ssid_from_list = 1;\n\tif (filter_type == SCAN_SSID_FILTER_LIST)\n\t\tcmd->filter = 1;\n\tcmd->add_broadcast = 0;\n\n\tcmd->urgency = 0;\n\tcmd->protect = 0;\n\n\tcmd->n_probe_reqs = c->num_probe_reqs;\n\t \n\tcmd->terminate_after = 0;\n\n\tcmd_channels = kzalloc(sizeof(*cmd_channels), GFP_KERNEL);\n\tif (!cmd_channels) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\t \n\twlcore_set_scan_chan_params(wl, cmd_channels, req->channels,\n\t\t\t\t    req->n_channels, req->n_ssids,\n\t\t\t\t    SCAN_TYPE_PERIODIC);\n\twl18xx_adjust_channels(cmd, cmd_channels);\n\n\tif (c->num_short_intervals && c->long_interval &&\n\t    c->long_interval > req->scan_plans[0].interval * MSEC_PER_SEC) {\n\t\tcmd->short_cycles_msec =\n\t\t\tcpu_to_le16(req->scan_plans[0].interval * MSEC_PER_SEC);\n\t\tcmd->long_cycles_msec = cpu_to_le16(c->long_interval);\n\t\tcmd->short_cycles_count = c->num_short_intervals;\n\t} else {\n\t\tcmd->short_cycles_msec = 0;\n\t\tcmd->long_cycles_msec =\n\t\t\tcpu_to_le16(req->scan_plans[0].interval * MSEC_PER_SEC);\n\t\tcmd->short_cycles_count = 0;\n\t}\n\twl1271_debug(DEBUG_SCAN, \"short_interval: %d, long_interval: %d, num_short: %d\",\n\t\t     le16_to_cpu(cmd->short_cycles_msec),\n\t\t     le16_to_cpu(cmd->long_cycles_msec),\n\t\t     cmd->short_cycles_count);\n\n\tcmd->total_cycles = 0;\n\n\tcmd->tag = WL1271_SCAN_DEFAULT_TAG;\n\n\t \n\tcmd->report_threshold = 1;\n\tcmd->terminate_on_report = 0;\n\n\tif (cmd->active[0]) {\n\t\tu8 band = NL80211_BAND_2GHZ;\n\t\tret = wl12xx_cmd_build_probe_req(wl, wlvif,\n\t\t\t\t cmd->role_id, band,\n\t\t\t\t req->ssids ? req->ssids[0].ssid : NULL,\n\t\t\t\t req->ssids ? req->ssids[0].ssid_len : 0,\n\t\t\t\t ies->ies[band],\n\t\t\t\t ies->len[band],\n\t\t\t\t ies->common_ies,\n\t\t\t\t ies->common_ie_len,\n\t\t\t\t true);\n\t\tif (ret < 0) {\n\t\t\twl1271_error(\"2.4GHz PROBE request template failed\");\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tif (cmd->active[1] || cmd->dfs) {\n\t\tu8 band = NL80211_BAND_5GHZ;\n\t\tret = wl12xx_cmd_build_probe_req(wl, wlvif,\n\t\t\t\t cmd->role_id, band,\n\t\t\t\t req->ssids ? req->ssids[0].ssid : NULL,\n\t\t\t\t req->ssids ? req->ssids[0].ssid_len : 0,\n\t\t\t\t ies->ies[band],\n\t\t\t\t ies->len[band],\n\t\t\t\t ies->common_ies,\n\t\t\t\t ies->common_ie_len,\n\t\t\t\t true);\n\t\tif (ret < 0) {\n\t\t\twl1271_error(\"5GHz PROBE request template failed\");\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\twl1271_dump(DEBUG_SCAN, \"SCAN: \", cmd, sizeof(*cmd));\n\n\tret = wl1271_cmd_send(wl, CMD_SCAN, cmd, sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"SCAN failed\");\n\t\tgoto out;\n\t}\n\nout:\n\tkfree(cmd_channels);\n\tkfree(cmd);\n\treturn ret;\n}\n\nint wl18xx_sched_scan_start(struct wl1271 *wl, struct wl12xx_vif *wlvif,\n\t\t\t    struct cfg80211_sched_scan_request *req,\n\t\t\t    struct ieee80211_scan_ies *ies)\n{\n\treturn wl18xx_scan_sched_scan_config(wl, wlvif, req, ies);\n}\n\nstatic int __wl18xx_scan_stop(struct wl1271 *wl, struct wl12xx_vif *wlvif,\n\t\t\t       u8 scan_type)\n{\n\tstruct wl18xx_cmd_scan_stop *stop;\n\tint ret;\n\n\twl1271_debug(DEBUG_CMD, \"cmd periodic scan stop\");\n\n\tstop = kzalloc(sizeof(*stop), GFP_KERNEL);\n\tif (!stop) {\n\t\twl1271_error(\"failed to alloc memory to send sched scan stop\");\n\t\treturn -ENOMEM;\n\t}\n\n\tstop->role_id = wlvif->role_id;\n\tstop->scan_type = scan_type;\n\n\tret = wl1271_cmd_send(wl, CMD_STOP_SCAN, stop, sizeof(*stop), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"failed to send sched scan stop command\");\n\t\tgoto out_free;\n\t}\n\nout_free:\n\tkfree(stop);\n\treturn ret;\n}\n\nvoid wl18xx_scan_sched_scan_stop(struct wl1271 *wl, struct wl12xx_vif *wlvif)\n{\n\t__wl18xx_scan_stop(wl, wlvif, SCAN_TYPE_PERIODIC);\n}\nint wl18xx_scan_start(struct wl1271 *wl, struct wl12xx_vif *wlvif,\n\t\t      struct cfg80211_scan_request *req)\n{\n\treturn wl18xx_scan_send(wl, wlvif, req);\n}\n\nint wl18xx_scan_stop(struct wl1271 *wl, struct wl12xx_vif *wlvif)\n{\n\treturn __wl18xx_scan_stop(wl, wlvif, SCAN_TYPE_SEARCH);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}