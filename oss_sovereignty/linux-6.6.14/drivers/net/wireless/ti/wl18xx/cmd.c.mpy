{
  "module_name": "cmd.c",
  "hash_id": "2a5b14aae2e8cc825c4f0e04047d645b4ba822223692340a32f469992e094dc0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ti/wl18xx/cmd.c",
  "human_readable_source": "\n \n\n#include \"../wlcore/cmd.h\"\n#include \"../wlcore/debug.h\"\n#include \"../wlcore/hw_ops.h\"\n\n#include \"cmd.h\"\n\nint wl18xx_cmd_channel_switch(struct wl1271 *wl,\n\t\t\t      struct wl12xx_vif *wlvif,\n\t\t\t      struct ieee80211_channel_switch *ch_switch)\n{\n\tstruct wl18xx_cmd_channel_switch *cmd;\n\tu32 supported_rates;\n\tint ret;\n\n\twl1271_debug(DEBUG_ACX, \"cmd channel switch (count=%d)\",\n\t\t     ch_switch->count);\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\tif (!cmd) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tcmd->role_id = wlvif->role_id;\n\tcmd->channel = ch_switch->chandef.chan->hw_value;\n\tcmd->switch_time = ch_switch->count;\n\tcmd->stop_tx = ch_switch->block_tx;\n\n\tswitch (ch_switch->chandef.chan->band) {\n\tcase NL80211_BAND_2GHZ:\n\t\tcmd->band = WLCORE_BAND_2_4GHZ;\n\t\tbreak;\n\tcase NL80211_BAND_5GHZ:\n\t\tcmd->band = WLCORE_BAND_5GHZ;\n\t\tbreak;\n\tdefault:\n\t\twl1271_error(\"invalid channel switch band: %d\",\n\t\t\t     ch_switch->chandef.chan->band);\n\t\tret = -EINVAL;\n\t\tgoto out_free;\n\t}\n\n\tsupported_rates = CONF_TX_ENABLED_RATES | CONF_TX_MCS_RATES;\n\tif (wlvif->bss_type == BSS_TYPE_STA_BSS)\n\t\tsupported_rates |= wlcore_hw_sta_get_ap_rate_mask(wl, wlvif);\n\telse\n\t\tsupported_rates |=\n\t\t\twlcore_hw_ap_get_mimo_wide_rate_mask(wl, wlvif);\n\tif (wlvif->p2p)\n\t\tsupported_rates &= ~CONF_TX_CCK_RATES;\n\tcmd->local_supported_rates = cpu_to_le32(supported_rates);\n\tcmd->channel_type = wlvif->channel_type;\n\n\tret = wl1271_cmd_send(wl, CMD_CHANNEL_SWITCH, cmd, sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"failed to send channel switch command\");\n\t\tgoto out_free;\n\t}\n\nout_free:\n\tkfree(cmd);\nout:\n\treturn ret;\n}\n\nint wl18xx_cmd_smart_config_start(struct wl1271 *wl, u32 group_bitmap)\n{\n\tstruct wl18xx_cmd_smart_config_start *cmd;\n\tint ret = 0;\n\n\twl1271_debug(DEBUG_CMD, \"cmd smart config start group_bitmap=0x%x\",\n\t\t     group_bitmap);\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\tif (!cmd) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tcmd->group_id_bitmask = cpu_to_le32(group_bitmap);\n\n\tret = wl1271_cmd_send(wl, CMD_SMART_CONFIG_START, cmd, sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"failed to send smart config start command\");\n\t\tgoto out_free;\n\t}\n\nout_free:\n\tkfree(cmd);\nout:\n\treturn ret;\n}\n\nint wl18xx_cmd_smart_config_stop(struct wl1271 *wl)\n{\n\tstruct wl1271_cmd_header *cmd;\n\tint ret = 0;\n\n\twl1271_debug(DEBUG_CMD, \"cmd smart config stop\");\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\tif (!cmd) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tret = wl1271_cmd_send(wl, CMD_SMART_CONFIG_STOP, cmd, sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"failed to send smart config stop command\");\n\t\tgoto out_free;\n\t}\n\nout_free:\n\tkfree(cmd);\nout:\n\treturn ret;\n}\n\nint wl18xx_cmd_smart_config_set_group_key(struct wl1271 *wl, u16 group_id,\n\t\t\t\t\t  u8 key_len, u8 *key)\n{\n\tstruct wl18xx_cmd_smart_config_set_group_key *cmd;\n\tint ret = 0;\n\n\twl1271_debug(DEBUG_CMD, \"cmd smart config set group key id=0x%x\",\n\t\t     group_id);\n\n\tif (key_len != sizeof(cmd->key)) {\n\t\twl1271_error(\"invalid group key size: %d\", key_len);\n\t\treturn -E2BIG;\n\t}\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\tif (!cmd) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tcmd->group_id = cpu_to_le32(group_id);\n\tmemcpy(cmd->key, key, key_len);\n\n\tret = wl1271_cmd_send(wl, CMD_SMART_CONFIG_SET_GROUP_KEY, cmd,\n\t\t\t      sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"failed to send smart config set group key cmd\");\n\t\tgoto out_free;\n\t}\n\nout_free:\n\tkfree(cmd);\nout:\n\treturn ret;\n}\n\nint wl18xx_cmd_set_cac(struct wl1271 *wl, struct wl12xx_vif *wlvif, bool start)\n{\n\tstruct wlcore_cmd_cac_start *cmd;\n\tint ret = 0;\n\n\twl1271_debug(DEBUG_CMD, \"cmd cac (channel %d) %s\",\n\t\t     wlvif->channel, start ? \"start\" : \"stop\");\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\tif (!cmd)\n\t\treturn -ENOMEM;\n\n\tcmd->role_id = wlvif->role_id;\n\tcmd->channel = wlvif->channel;\n\tif (wlvif->band == NL80211_BAND_5GHZ)\n\t\tcmd->band = WLCORE_BAND_5GHZ;\n\tcmd->bandwidth = wlcore_get_native_channel_type(wlvif->channel_type);\n\n\tret = wl1271_cmd_send(wl,\n\t\t\t      start ? CMD_CAC_START : CMD_CAC_STOP,\n\t\t\t      cmd, sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"failed to send cac command\");\n\t\tgoto out_free;\n\t}\n\nout_free:\n\tkfree(cmd);\n\treturn ret;\n}\n\nint wl18xx_cmd_radar_detection_debug(struct wl1271 *wl, u8 channel)\n{\n\tstruct wl18xx_cmd_dfs_radar_debug *cmd;\n\tint ret = 0;\n\n\twl1271_debug(DEBUG_CMD, \"cmd radar detection debug (chan %d)\",\n\t\t     channel);\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\tif (!cmd)\n\t\treturn -ENOMEM;\n\n\tcmd->channel = channel;\n\n\tret = wl1271_cmd_send(wl, CMD_DFS_RADAR_DETECTION_DEBUG,\n\t\t\t      cmd, sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"failed to send radar detection debug command\");\n\t\tgoto out_free;\n\t}\n\nout_free:\n\tkfree(cmd);\n\treturn ret;\n}\n\nint wl18xx_cmd_dfs_master_restart(struct wl1271 *wl, struct wl12xx_vif *wlvif)\n{\n\tstruct wl18xx_cmd_dfs_master_restart *cmd;\n\tint ret = 0;\n\n\twl1271_debug(DEBUG_CMD, \"cmd dfs master restart (role %d)\",\n\t\t     wlvif->role_id);\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\tif (!cmd)\n\t\treturn -ENOMEM;\n\n\tcmd->role_id = wlvif->role_id;\n\n\tret = wl1271_cmd_send(wl, CMD_DFS_MASTER_RESTART,\n\t\t\t      cmd, sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"failed to send dfs master restart command\");\n\t\tgoto out_free;\n\t}\nout_free:\n\tkfree(cmd);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}