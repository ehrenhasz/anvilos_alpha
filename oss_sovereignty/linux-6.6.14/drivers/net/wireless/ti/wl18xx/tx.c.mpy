{
  "module_name": "tx.c",
  "hash_id": "b83e8cb54dc340e8b5d329ffa18ba820568acd6080227a79174b1c4a50bd1799",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ti/wl18xx/tx.c",
  "human_readable_source": "\n \n\n#include \"../wlcore/wlcore.h\"\n#include \"../wlcore/cmd.h\"\n#include \"../wlcore/debug.h\"\n#include \"../wlcore/acx.h\"\n#include \"../wlcore/tx.h\"\n\n#include \"wl18xx.h\"\n#include \"tx.h\"\n\nstatic\nvoid wl18xx_get_last_tx_rate(struct wl1271 *wl, struct ieee80211_vif *vif,\n\t\t\t     u8 band, struct ieee80211_tx_rate *rate, u8 hlid)\n{\n\tu8 fw_rate = wl->links[hlid].fw_rate_idx;\n\n\tif (fw_rate > CONF_HW_RATE_INDEX_MAX) {\n\t\twl1271_error(\"last Tx rate invalid: %d\", fw_rate);\n\t\trate->idx = 0;\n\t\trate->flags = 0;\n\t\treturn;\n\t}\n\n\tif (fw_rate <= CONF_HW_RATE_INDEX_54MBPS) {\n\t\trate->idx = fw_rate;\n\t\tif (band == NL80211_BAND_5GHZ)\n\t\t\trate->idx -= CONF_HW_RATE_INDEX_6MBPS;\n\t\trate->flags = 0;\n\t} else {\n\t\trate->flags = IEEE80211_TX_RC_MCS;\n\t\trate->idx = fw_rate - CONF_HW_RATE_INDEX_MCS0;\n\n\t\t \n\t\tif (fw_rate >= CONF_HW_RATE_INDEX_MCS7_SGI)\n\t\t\t(rate->idx)--;\n\t\tif (fw_rate == CONF_HW_RATE_INDEX_MCS15_SGI)\n\t\t\t(rate->idx)--;\n\n\t\t \n\t\tif (fw_rate == CONF_HW_RATE_INDEX_MCS7_SGI ||\n\t\t    fw_rate == CONF_HW_RATE_INDEX_MCS15_SGI)\n\t\t\trate->flags |= IEEE80211_TX_RC_SHORT_GI;\n\n\t\tif (fw_rate > CONF_HW_RATE_INDEX_MCS7_SGI && vif) {\n\t\t\tstruct wl12xx_vif *wlvif = wl12xx_vif_to_data(vif);\n\t\t\tif (wlvif->channel_type == NL80211_CHAN_HT40MINUS ||\n\t\t\t    wlvif->channel_type == NL80211_CHAN_HT40PLUS) {\n\t\t\t\t \n\t\t\t\trate->idx -= 8;\n\t\t\t\trate->flags |= IEEE80211_TX_RC_40_MHZ_WIDTH;\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic void wl18xx_tx_complete_packet(struct wl1271 *wl, u8 tx_stat_byte)\n{\n\tstruct ieee80211_tx_info *info;\n\tstruct sk_buff *skb;\n\tint id = tx_stat_byte & WL18XX_TX_STATUS_DESC_ID_MASK;\n\tbool tx_success;\n\tstruct wl1271_tx_hw_descr *tx_desc;\n\n\t \n\tif (unlikely(id >= wl->num_tx_desc || wl->tx_frames[id] == NULL)) {\n\t\twl1271_warning(\"illegal id in tx completion: %d\", id);\n\t\treturn;\n\t}\n\n\t \n\ttx_success = !(tx_stat_byte & BIT(WL18XX_TX_STATUS_STAT_BIT_IDX));\n\n\tskb = wl->tx_frames[id];\n\tinfo = IEEE80211_SKB_CB(skb);\n\ttx_desc = (struct wl1271_tx_hw_descr *)skb->data;\n\n\tif (wl12xx_is_dummy_packet(wl, skb)) {\n\t\twl1271_free_tx_id(wl, id);\n\t\treturn;\n\t}\n\n\t \n\tif (tx_success && !(info->flags & IEEE80211_TX_CTL_NO_ACK))\n\t\tinfo->flags |= IEEE80211_TX_STAT_ACK;\n\t \n\twl18xx_get_last_tx_rate(wl, info->control.vif,\n\t\t\t\tinfo->band,\n\t\t\t\t&info->status.rates[0],\n\t\t\t\ttx_desc->hlid);\n\n\tinfo->status.rates[0].count = 1;  \n\tinfo->status.ack_signal = -1;\n\n\tif (!tx_success)\n\t\twl->stats.retry_count++;\n\n\t \n\n\t \n\tskb_pull(skb, sizeof(struct wl1271_tx_hw_descr));\n\n\t \n\tif ((wl->quirks & WLCORE_QUIRK_TKIP_HEADER_SPACE) &&\n\t    info->control.hw_key &&\n\t    info->control.hw_key->cipher == WLAN_CIPHER_SUITE_TKIP) {\n\t\tint hdrlen = ieee80211_get_hdrlen_from_skb(skb);\n\t\tmemmove(skb->data + WL1271_EXTRA_SPACE_TKIP, skb->data, hdrlen);\n\t\tskb_pull(skb, WL1271_EXTRA_SPACE_TKIP);\n\t}\n\n\twl1271_debug(DEBUG_TX, \"tx status id %u skb 0x%p success %d\",\n\t\t     id, skb, tx_success);\n\n\t \n\tskb_queue_tail(&wl->deferred_tx_queue, skb);\n\tqueue_work(wl->freezable_wq, &wl->netstack_work);\n\twl1271_free_tx_id(wl, id);\n}\n\nvoid wl18xx_tx_immediate_complete(struct wl1271 *wl)\n{\n\tstruct wl18xx_fw_status_priv *status_priv =\n\t\t(struct wl18xx_fw_status_priv *)wl->fw_status->priv;\n\tstruct wl18xx_priv *priv = wl->priv;\n\tu8 i, hlid;\n\n\t \n\tif (priv->last_fw_rls_idx == status_priv->fw_release_idx)\n\t\treturn;\n\n\t \n\thlid = wl->fw_status->counters.hlid;\n\n\tif (hlid < WLCORE_MAX_LINKS) {\n\t\twl->links[hlid].fw_rate_idx =\n\t\t\t\twl->fw_status->counters.tx_last_rate;\n\t\twl->links[hlid].fw_rate_mbps =\n\t\t\t\twl->fw_status->counters.tx_last_rate_mbps;\n\t}\n\n\t \n\twl1271_debug(DEBUG_TX, \"last released desc = %d, current idx = %d\",\n\t\t     priv->last_fw_rls_idx, status_priv->fw_release_idx);\n\n\tif (status_priv->fw_release_idx >= WL18XX_FW_MAX_TX_STATUS_DESC) {\n\t\twl1271_error(\"invalid desc release index %d\",\n\t\t\t     status_priv->fw_release_idx);\n\t\tWARN_ON(1);\n\t\treturn;\n\t}\n\n\tfor (i = priv->last_fw_rls_idx;\n\t     i != status_priv->fw_release_idx;\n\t     i = (i + 1) % WL18XX_FW_MAX_TX_STATUS_DESC) {\n\t\twl18xx_tx_complete_packet(wl,\n\t\t\tstatus_priv->released_tx_desc[i]);\n\n\t\twl->tx_results_count++;\n\t}\n\n\tpriv->last_fw_rls_idx = status_priv->fw_release_idx;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}