{
  "module_name": "event.c",
  "hash_id": "2702764ef9bc4817e7b0379db2254915c3be1d2412dee0d9e83db2455fad0056",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ti/wl18xx/event.c",
  "human_readable_source": "\n \n\n#include <net/genetlink.h>\n#include \"event.h\"\n#include \"scan.h\"\n#include \"conf.h\"\n#include \"../wlcore/cmd.h\"\n#include \"../wlcore/debug.h\"\n#include \"../wlcore/vendor_cmd.h\"\n\nint wl18xx_wait_for_event(struct wl1271 *wl, enum wlcore_wait_event event,\n\t\t\t  bool *timeout)\n{\n\tu32 local_event;\n\n\tswitch (event) {\n\tcase WLCORE_EVENT_PEER_REMOVE_COMPLETE:\n\t\tlocal_event = PEER_REMOVE_COMPLETE_EVENT_ID;\n\t\tbreak;\n\n\tcase WLCORE_EVENT_DFS_CONFIG_COMPLETE:\n\t\tlocal_event = DFS_CHANNELS_CONFIG_COMPLETE_EVENT;\n\t\tbreak;\n\n\tdefault:\n\t\t \n\t\treturn 0;\n\t}\n\treturn wlcore_cmd_wait_for_event_or_timeout(wl, local_event, timeout);\n}\n\nstatic const char *wl18xx_radar_type_decode(u8 radar_type)\n{\n\tswitch (radar_type) {\n\tcase RADAR_TYPE_REGULAR:\n\t\treturn \"REGULAR\";\n\tcase RADAR_TYPE_CHIRP:\n\t\treturn \"CHIRP\";\n\tcase RADAR_TYPE_NONE:\n\tdefault:\n\t\treturn \"N/A\";\n\t}\n}\n\nstatic int wlcore_smart_config_sync_event(struct wl1271 *wl, u8 sync_channel,\n\t\t\t\t\t  u8 sync_band)\n{\n\tstruct sk_buff *skb;\n\tenum nl80211_band band;\n\tint freq;\n\n\tif (sync_band == WLCORE_BAND_5GHZ)\n\t\tband = NL80211_BAND_5GHZ;\n\telse\n\t\tband = NL80211_BAND_2GHZ;\n\n\tfreq = ieee80211_channel_to_frequency(sync_channel, band);\n\n\twl1271_debug(DEBUG_EVENT,\n\t\t     \"SMART_CONFIG_SYNC_EVENT_ID, freq: %d (chan: %d band %d)\",\n\t\t     freq, sync_channel, sync_band);\n\tskb = cfg80211_vendor_event_alloc(wl->hw->wiphy, NULL, 20,\n\t\t\t\t\t  WLCORE_VENDOR_EVENT_SC_SYNC,\n\t\t\t\t\t  GFP_KERNEL);\n\n\tif (nla_put_u32(skb, WLCORE_VENDOR_ATTR_FREQ, freq)) {\n\t\tkfree_skb(skb);\n\t\treturn -EMSGSIZE;\n\t}\n\tcfg80211_vendor_event(skb, GFP_KERNEL);\n\treturn 0;\n}\n\nstatic int wlcore_smart_config_decode_event(struct wl1271 *wl,\n\t\t\t\t\t    u8 ssid_len, u8 *ssid,\n\t\t\t\t\t    u8 pwd_len, u8 *pwd)\n{\n\tstruct sk_buff *skb;\n\n\twl1271_debug(DEBUG_EVENT, \"SMART_CONFIG_DECODE_EVENT_ID\");\n\twl1271_dump_ascii(DEBUG_EVENT, \"SSID:\", ssid, ssid_len);\n\n\tskb = cfg80211_vendor_event_alloc(wl->hw->wiphy, NULL,\n\t\t\t\t\t  ssid_len + pwd_len + 20,\n\t\t\t\t\t  WLCORE_VENDOR_EVENT_SC_DECODE,\n\t\t\t\t\t  GFP_KERNEL);\n\n\tif (nla_put(skb, WLCORE_VENDOR_ATTR_SSID, ssid_len, ssid) ||\n\t    nla_put(skb, WLCORE_VENDOR_ATTR_PSK, pwd_len, pwd)) {\n\t\tkfree_skb(skb);\n\t\treturn -EMSGSIZE;\n\t}\n\tcfg80211_vendor_event(skb, GFP_KERNEL);\n\treturn 0;\n}\n\nstatic void wlcore_event_time_sync(struct wl1271 *wl,\n\t\t\t\t   u16 tsf_high_msb, u16 tsf_high_lsb,\n\t\t\t\t   u16 tsf_low_msb, u16 tsf_low_lsb)\n{\n\tu32 clock_low;\n\tu32 clock_high;\n\n\tclock_high = (tsf_high_msb << 16) | tsf_high_lsb;\n\tclock_low = (tsf_low_msb << 16) | tsf_low_lsb;\n\n\twl1271_info(\"TIME_SYNC_EVENT_ID: clock_high %u, clock low %u\",\n\t\t    clock_high, clock_low);\n}\n\nint wl18xx_process_mailbox_events(struct wl1271 *wl)\n{\n\tstruct wl18xx_event_mailbox *mbox = wl->mbox;\n\tu32 vector;\n\n\tvector = le32_to_cpu(mbox->events_vector);\n\twl1271_debug(DEBUG_EVENT, \"MBOX vector: 0x%x\", vector);\n\n\tif (vector & SCAN_COMPLETE_EVENT_ID) {\n\t\twl1271_debug(DEBUG_EVENT, \"scan results: %d\",\n\t\t\t     mbox->number_of_scan_results);\n\n\t\tif (wl->scan_wlvif)\n\t\t\twl18xx_scan_completed(wl, wl->scan_wlvif);\n\t}\n\n\tif (vector & TIME_SYNC_EVENT_ID)\n\t\twlcore_event_time_sync(wl,\n\t\t\tle16_to_cpu(mbox->time_sync_tsf_high_msb),\n\t\t\tle16_to_cpu(mbox->time_sync_tsf_high_lsb),\n\t\t\tle16_to_cpu(mbox->time_sync_tsf_low_msb),\n\t\t\tle16_to_cpu(mbox->time_sync_tsf_low_lsb));\n\n\tif (vector & RADAR_DETECTED_EVENT_ID) {\n\t\twl1271_info(\"radar event: channel %d type %s\",\n\t\t\t    mbox->radar_channel,\n\t\t\t    wl18xx_radar_type_decode(mbox->radar_type));\n\n\t\tif (!wl->radar_debug_mode)\n\t\t\tieee80211_radar_detected(wl->hw);\n\t}\n\n\tif (vector & PERIODIC_SCAN_REPORT_EVENT_ID) {\n\t\twl1271_debug(DEBUG_EVENT,\n\t\t\t     \"PERIODIC_SCAN_REPORT_EVENT (results %d)\",\n\t\t\t     mbox->number_of_sched_scan_results);\n\n\t\twlcore_scan_sched_scan_results(wl);\n\t}\n\n\tif (vector & PERIODIC_SCAN_COMPLETE_EVENT_ID)\n\t\twlcore_event_sched_scan_completed(wl, 1);\n\n\tif (vector & RSSI_SNR_TRIGGER_0_EVENT_ID)\n\t\twlcore_event_rssi_trigger(wl, mbox->rssi_snr_trigger_metric);\n\n\tif (vector & BA_SESSION_RX_CONSTRAINT_EVENT_ID)\n\t\twlcore_event_ba_rx_constraint(wl,\n\t\t\t\tle16_to_cpu(mbox->rx_ba_role_id_bitmap),\n\t\t\t\tle16_to_cpu(mbox->rx_ba_allowed_bitmap));\n\n\tif (vector & BSS_LOSS_EVENT_ID)\n\t\twlcore_event_beacon_loss(wl,\n\t\t\t\t\t le16_to_cpu(mbox->bss_loss_bitmap));\n\n\tif (vector & CHANNEL_SWITCH_COMPLETE_EVENT_ID)\n\t\twlcore_event_channel_switch(wl,\n\t\t\tle16_to_cpu(mbox->channel_switch_role_id_bitmap),\n\t\t\ttrue);\n\n\tif (vector & DUMMY_PACKET_EVENT_ID)\n\t\twlcore_event_dummy_packet(wl);\n\n\t \n\tif (vector & MAX_TX_FAILURE_EVENT_ID)\n\t\twlcore_event_max_tx_failure(wl,\n\t\t\t\tle16_to_cpu(mbox->tx_retry_exceeded_bitmap));\n\n\tif (vector & INACTIVE_STA_EVENT_ID)\n\t\twlcore_event_inactive_sta(wl,\n\t\t\t\tle16_to_cpu(mbox->inactive_sta_bitmap));\n\n\tif (vector & REMAIN_ON_CHANNEL_COMPLETE_EVENT_ID)\n\t\twlcore_event_roc_complete(wl);\n\n\tif (vector & SMART_CONFIG_SYNC_EVENT_ID)\n\t\twlcore_smart_config_sync_event(wl, mbox->sc_sync_channel,\n\t\t\t\t\t       mbox->sc_sync_band);\n\n\tif (vector & SMART_CONFIG_DECODE_EVENT_ID)\n\t\twlcore_smart_config_decode_event(wl,\n\t\t\t\t\t\t mbox->sc_ssid_len,\n\t\t\t\t\t\t mbox->sc_ssid,\n\t\t\t\t\t\t mbox->sc_pwd_len,\n\t\t\t\t\t\t mbox->sc_pwd);\n\tif (vector & FW_LOGGER_INDICATION)\n\t\twlcore_event_fw_logger(wl);\n\n\tif (vector & RX_BA_WIN_SIZE_CHANGE_EVENT_ID) {\n\t\tstruct wl12xx_vif *wlvif;\n\t\tstruct ieee80211_vif *vif;\n\t\tstruct ieee80211_sta *sta;\n\t\tu8 link_id = mbox->rx_ba_link_id;\n\t\tu8 win_size = mbox->rx_ba_win_size;\n\t\tconst u8 *addr;\n\n\t\twlvif = wl->links[link_id].wlvif;\n\t\tvif = wl12xx_wlvif_to_vif(wlvif);\n\n\t\t \n\t\tif (wlvif->bss_type != BSS_TYPE_AP_BSS)\n\t\t\taddr = vif->bss_conf.bssid;\n\t\telse\n\t\t\taddr = wl->links[link_id].addr;\n\n\t\tsta = ieee80211_find_sta(vif, addr);\n\t\tif (sta) {\n\t\t\tsta->max_rx_aggregation_subframes = win_size;\n\t\t\tieee80211_stop_rx_ba_session(vif,\n\t\t\t\t\t\twl->links[link_id].ba_bitmap,\n\t\t\t\t\t\taddr);\n\t\t}\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}