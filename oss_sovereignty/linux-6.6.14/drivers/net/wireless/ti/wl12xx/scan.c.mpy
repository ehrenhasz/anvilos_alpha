{
  "module_name": "scan.c",
  "hash_id": "e5c7ee2cd3f288a557066737cb1a2f505ae84a8e999ab411298eba41900dc9c4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/ti/wl12xx/scan.c",
  "human_readable_source": "\n \n\n#include <linux/ieee80211.h>\n#include \"scan.h\"\n#include \"../wlcore/debug.h\"\n#include \"../wlcore/tx.h\"\n\nstatic int wl1271_get_scan_channels(struct wl1271 *wl,\n\t\t\t\t    struct cfg80211_scan_request *req,\n\t\t\t\t    struct basic_scan_channel_params *channels,\n\t\t\t\t    enum nl80211_band band, bool passive)\n{\n\tstruct conf_scan_settings *c = &wl->conf.scan;\n\tint i, j;\n\tu32 flags;\n\n\tfor (i = 0, j = 0;\n\t     i < req->n_channels && j < WL1271_SCAN_MAX_CHANNELS;\n\t     i++) {\n\t\tflags = req->channels[i]->flags;\n\n\t\tif (!test_bit(i, wl->scan.scanned_ch) &&\n\t\t    !(flags & IEEE80211_CHAN_DISABLED) &&\n\t\t    (req->channels[i]->band == band) &&\n\t\t     \n\t\t    (passive || !(flags & IEEE80211_CHAN_NO_IR))) {\n\t\t\twl1271_debug(DEBUG_SCAN, \"band %d, center_freq %d \",\n\t\t\t\t     req->channels[i]->band,\n\t\t\t\t     req->channels[i]->center_freq);\n\t\t\twl1271_debug(DEBUG_SCAN, \"hw_value %d, flags %X\",\n\t\t\t\t     req->channels[i]->hw_value,\n\t\t\t\t     req->channels[i]->flags);\n\t\t\twl1271_debug(DEBUG_SCAN,\n\t\t\t\t     \"max_antenna_gain %d, max_power %d\",\n\t\t\t\t     req->channels[i]->max_antenna_gain,\n\t\t\t\t     req->channels[i]->max_power);\n\t\t\twl1271_debug(DEBUG_SCAN, \"beacon_found %d\",\n\t\t\t\t     req->channels[i]->beacon_found);\n\n\t\t\tif (!passive) {\n\t\t\t\tchannels[j].min_duration =\n\t\t\t\t\tcpu_to_le32(c->min_dwell_time_active);\n\t\t\t\tchannels[j].max_duration =\n\t\t\t\t\tcpu_to_le32(c->max_dwell_time_active);\n\t\t\t} else {\n\t\t\t\tchannels[j].min_duration =\n\t\t\t\t\tcpu_to_le32(c->dwell_time_passive);\n\t\t\t\tchannels[j].max_duration =\n\t\t\t\t\tcpu_to_le32(c->dwell_time_passive);\n\t\t\t}\n\t\t\tchannels[j].early_termination = 0;\n\t\t\tchannels[j].tx_power_att = req->channels[i]->max_power;\n\t\t\tchannels[j].channel = req->channels[i]->hw_value;\n\n\t\t\tmemset(&channels[j].bssid_lsb, 0xff, 4);\n\t\t\tmemset(&channels[j].bssid_msb, 0xff, 2);\n\n\t\t\t \n\t\t\tset_bit(i, wl->scan.scanned_ch);\n\n\t\t\tj++;\n\t\t}\n\t}\n\n\treturn j;\n}\n\n#define WL1271_NOTHING_TO_SCAN 1\n\nstatic int wl1271_scan_send(struct wl1271 *wl, struct wl12xx_vif *wlvif,\n\t\t\t    enum nl80211_band band,\n\t\t\t    bool passive, u32 basic_rate)\n{\n\tstruct ieee80211_vif *vif = wl12xx_wlvif_to_vif(wlvif);\n\tstruct wl1271_cmd_scan *cmd;\n\tstruct wl1271_cmd_trigger_scan_to *trigger;\n\tint ret;\n\tu16 scan_options = 0;\n\n\t \n\tif (!passive && wl->scan.req->n_ssids == 0)\n\t\treturn WL1271_NOTHING_TO_SCAN;\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\ttrigger = kzalloc(sizeof(*trigger), GFP_KERNEL);\n\tif (!cmd || !trigger) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tif (wl->conf.scan.split_scan_timeout)\n\t\tscan_options |= WL1271_SCAN_OPT_SPLIT_SCAN;\n\n\tif (passive)\n\t\tscan_options |= WL1271_SCAN_OPT_PASSIVE;\n\n\t \n\tif (wlcore_is_p2p_mgmt(wlvif))\n\t\tcmd->params.role_id = wlvif->dev_role_id;\n\telse\n\t\tcmd->params.role_id = wlvif->role_id;\n\n\tif (WARN_ON(cmd->params.role_id == WL12XX_INVALID_ROLE_ID)) {\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tcmd->params.scan_options = cpu_to_le16(scan_options);\n\n\tcmd->params.n_ch = wl1271_get_scan_channels(wl, wl->scan.req,\n\t\t\t\t\t\t    cmd->channels,\n\t\t\t\t\t\t    band, passive);\n\tif (cmd->params.n_ch == 0) {\n\t\tret = WL1271_NOTHING_TO_SCAN;\n\t\tgoto out;\n\t}\n\n\tcmd->params.tx_rate = cpu_to_le32(basic_rate);\n\tcmd->params.n_probe_reqs = wl->conf.scan.num_probe_reqs;\n\tcmd->params.tid_trigger = CONF_TX_AC_ANY_TID;\n\tcmd->params.scan_tag = WL1271_SCAN_DEFAULT_TAG;\n\n\tif (band == NL80211_BAND_2GHZ)\n\t\tcmd->params.band = WL1271_SCAN_BAND_2_4_GHZ;\n\telse\n\t\tcmd->params.band = WL1271_SCAN_BAND_5_GHZ;\n\n\tif (wl->scan.ssid_len) {\n\t\tcmd->params.ssid_len = wl->scan.ssid_len;\n\t\tmemcpy(cmd->params.ssid, wl->scan.ssid, wl->scan.ssid_len);\n\t}\n\n\tmemcpy(cmd->addr, vif->addr, ETH_ALEN);\n\n\tret = wl12xx_cmd_build_probe_req(wl, wlvif,\n\t\t\t\t\t cmd->params.role_id, band,\n\t\t\t\t\t wl->scan.ssid, wl->scan.ssid_len,\n\t\t\t\t\t wl->scan.req->ie,\n\t\t\t\t\t wl->scan.req->ie_len, NULL, 0, false);\n\tif (ret < 0) {\n\t\twl1271_error(\"PROBE request template failed\");\n\t\tgoto out;\n\t}\n\n\ttrigger->timeout = cpu_to_le32(wl->conf.scan.split_scan_timeout);\n\tret = wl1271_cmd_send(wl, CMD_TRIGGER_SCAN_TO, trigger,\n\t\t\t      sizeof(*trigger), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"trigger scan to failed for hw scan\");\n\t\tgoto out;\n\t}\n\n\twl1271_dump(DEBUG_SCAN, \"SCAN: \", cmd, sizeof(*cmd));\n\n\tret = wl1271_cmd_send(wl, CMD_SCAN, cmd, sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"SCAN failed\");\n\t\tgoto out;\n\t}\n\nout:\n\tkfree(cmd);\n\tkfree(trigger);\n\treturn ret;\n}\n\nint wl12xx_scan_stop(struct wl1271 *wl, struct wl12xx_vif *wlvif)\n{\n\tstruct wl1271_cmd_header *cmd = NULL;\n\tint ret = 0;\n\n\tif (WARN_ON(wl->scan.state == WL1271_SCAN_STATE_IDLE))\n\t\treturn -EINVAL;\n\n\twl1271_debug(DEBUG_CMD, \"cmd scan stop\");\n\n\tcmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\n\tif (!cmd) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tret = wl1271_cmd_send(wl, CMD_STOP_SCAN, cmd,\n\t\t\t      sizeof(*cmd), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"cmd stop_scan failed\");\n\t\tgoto out;\n\t}\nout:\n\tkfree(cmd);\n\treturn ret;\n}\n\nvoid wl1271_scan_stm(struct wl1271 *wl, struct wl12xx_vif *wlvif)\n{\n\tint ret = 0;\n\tenum nl80211_band band;\n\tu32 rate, mask;\n\n\tswitch (wl->scan.state) {\n\tcase WL1271_SCAN_STATE_IDLE:\n\t\tbreak;\n\n\tcase WL1271_SCAN_STATE_2GHZ_ACTIVE:\n\t\tband = NL80211_BAND_2GHZ;\n\t\tmask = wlvif->bitrate_masks[band];\n\t\tif (wl->scan.req->no_cck) {\n\t\t\tmask &= ~CONF_TX_CCK_RATES;\n\t\t\tif (!mask)\n\t\t\t\tmask = CONF_TX_RATE_MASK_BASIC_P2P;\n\t\t}\n\t\trate = wl1271_tx_min_rate_get(wl, mask);\n\t\tret = wl1271_scan_send(wl, wlvif, band, false, rate);\n\t\tif (ret == WL1271_NOTHING_TO_SCAN) {\n\t\t\twl->scan.state = WL1271_SCAN_STATE_2GHZ_PASSIVE;\n\t\t\twl1271_scan_stm(wl, wlvif);\n\t\t}\n\n\t\tbreak;\n\n\tcase WL1271_SCAN_STATE_2GHZ_PASSIVE:\n\t\tband = NL80211_BAND_2GHZ;\n\t\tmask = wlvif->bitrate_masks[band];\n\t\tif (wl->scan.req->no_cck) {\n\t\t\tmask &= ~CONF_TX_CCK_RATES;\n\t\t\tif (!mask)\n\t\t\t\tmask = CONF_TX_RATE_MASK_BASIC_P2P;\n\t\t}\n\t\trate = wl1271_tx_min_rate_get(wl, mask);\n\t\tret = wl1271_scan_send(wl, wlvif, band, true, rate);\n\t\tif (ret == WL1271_NOTHING_TO_SCAN) {\n\t\t\tif (wl->enable_11a)\n\t\t\t\twl->scan.state = WL1271_SCAN_STATE_5GHZ_ACTIVE;\n\t\t\telse\n\t\t\t\twl->scan.state = WL1271_SCAN_STATE_DONE;\n\t\t\twl1271_scan_stm(wl, wlvif);\n\t\t}\n\n\t\tbreak;\n\n\tcase WL1271_SCAN_STATE_5GHZ_ACTIVE:\n\t\tband = NL80211_BAND_5GHZ;\n\t\trate = wl1271_tx_min_rate_get(wl, wlvif->bitrate_masks[band]);\n\t\tret = wl1271_scan_send(wl, wlvif, band, false, rate);\n\t\tif (ret == WL1271_NOTHING_TO_SCAN) {\n\t\t\twl->scan.state = WL1271_SCAN_STATE_5GHZ_PASSIVE;\n\t\t\twl1271_scan_stm(wl, wlvif);\n\t\t}\n\n\t\tbreak;\n\n\tcase WL1271_SCAN_STATE_5GHZ_PASSIVE:\n\t\tband = NL80211_BAND_5GHZ;\n\t\trate = wl1271_tx_min_rate_get(wl, wlvif->bitrate_masks[band]);\n\t\tret = wl1271_scan_send(wl, wlvif, band, true, rate);\n\t\tif (ret == WL1271_NOTHING_TO_SCAN) {\n\t\t\twl->scan.state = WL1271_SCAN_STATE_DONE;\n\t\t\twl1271_scan_stm(wl, wlvif);\n\t\t}\n\n\t\tbreak;\n\n\tcase WL1271_SCAN_STATE_DONE:\n\t\twl->scan.failed = false;\n\t\tcancel_delayed_work(&wl->scan_complete_work);\n\t\tieee80211_queue_delayed_work(wl->hw, &wl->scan_complete_work,\n\t\t\t\t\t     msecs_to_jiffies(0));\n\t\tbreak;\n\n\tdefault:\n\t\twl1271_error(\"invalid scan state\");\n\t\tbreak;\n\t}\n\n\tif (ret < 0) {\n\t\tcancel_delayed_work(&wl->scan_complete_work);\n\t\tieee80211_queue_delayed_work(wl->hw, &wl->scan_complete_work,\n\t\t\t\t\t     msecs_to_jiffies(0));\n\t}\n}\n\nstatic void wl12xx_adjust_channels(struct wl1271_cmd_sched_scan_config *cmd,\n\t\t\t\t   struct wlcore_scan_channels *cmd_channels)\n{\n\tmemcpy(cmd->passive, cmd_channels->passive, sizeof(cmd->passive));\n\tmemcpy(cmd->active, cmd_channels->active, sizeof(cmd->active));\n\tcmd->dfs = cmd_channels->dfs;\n\tcmd->n_pactive_ch = cmd_channels->passive_active;\n\n\tmemcpy(cmd->channels_2, cmd_channels->channels_2,\n\t       sizeof(cmd->channels_2));\n\tmemcpy(cmd->channels_5, cmd_channels->channels_5,\n\t       sizeof(cmd->channels_5));\n\t \n}\n\nint wl1271_scan_sched_scan_config(struct wl1271 *wl,\n\t\t\t\t  struct wl12xx_vif *wlvif,\n\t\t\t\t  struct cfg80211_sched_scan_request *req,\n\t\t\t\t  struct ieee80211_scan_ies *ies)\n{\n\tstruct wl1271_cmd_sched_scan_config *cfg = NULL;\n\tstruct wlcore_scan_channels *cfg_channels = NULL;\n\tstruct conf_sched_scan_settings *c = &wl->conf.sched_scan;\n\tint i, ret;\n\tbool force_passive = !req->n_ssids;\n\n\twl1271_debug(DEBUG_CMD, \"cmd sched_scan scan config\");\n\n\tcfg = kzalloc(sizeof(*cfg), GFP_KERNEL);\n\tif (!cfg)\n\t\treturn -ENOMEM;\n\n\tcfg->role_id = wlvif->role_id;\n\tcfg->rssi_threshold = c->rssi_threshold;\n\tcfg->snr_threshold  = c->snr_threshold;\n\tcfg->n_probe_reqs = c->num_probe_reqs;\n\t \n\tcfg->cycles = 0;\n\t \n\tcfg->report_after = 1;\n\t \n\tcfg->terminate = 0;\n\tcfg->tag = WL1271_SCAN_DEFAULT_TAG;\n\t \n\tcfg->bss_type = SCAN_BSS_TYPE_ANY;\n\t \n\tfor (i = 0; i < SCAN_MAX_CYCLE_INTERVALS; i++)\n\t\tcfg->intervals[i] = cpu_to_le32(req->scan_plans[0].interval *\n\t\t\t\t\t\tMSEC_PER_SEC);\n\n\tcfg->ssid_len = 0;\n\tret = wlcore_scan_sched_scan_ssid_list(wl, wlvif, req);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tcfg->filter_type = ret;\n\n\twl1271_debug(DEBUG_SCAN, \"filter_type = %d\", cfg->filter_type);\n\n\tcfg_channels = kzalloc(sizeof(*cfg_channels), GFP_KERNEL);\n\tif (!cfg_channels) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tif (!wlcore_set_scan_chan_params(wl, cfg_channels, req->channels,\n\t\t\t\t\t req->n_channels, req->n_ssids,\n\t\t\t\t\t SCAN_TYPE_PERIODIC)) {\n\t\twl1271_error(\"scan channel list is empty\");\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\twl12xx_adjust_channels(cfg, cfg_channels);\n\n\tif (!force_passive && cfg->active[0]) {\n\t\tu8 band = NL80211_BAND_2GHZ;\n\t\tret = wl12xx_cmd_build_probe_req(wl, wlvif,\n\t\t\t\t\t\t wlvif->role_id, band,\n\t\t\t\t\t\t req->ssids[0].ssid,\n\t\t\t\t\t\t req->ssids[0].ssid_len,\n\t\t\t\t\t\t ies->ies[band],\n\t\t\t\t\t\t ies->len[band],\n\t\t\t\t\t\t ies->common_ies,\n\t\t\t\t\t\t ies->common_ie_len,\n\t\t\t\t\t\t true);\n\t\tif (ret < 0) {\n\t\t\twl1271_error(\"2.4GHz PROBE request template failed\");\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tif (!force_passive && cfg->active[1]) {\n\t\tu8 band = NL80211_BAND_5GHZ;\n\t\tret = wl12xx_cmd_build_probe_req(wl, wlvif,\n\t\t\t\t\t\t wlvif->role_id, band,\n\t\t\t\t\t\t req->ssids[0].ssid,\n\t\t\t\t\t\t req->ssids[0].ssid_len,\n\t\t\t\t\t\t ies->ies[band],\n\t\t\t\t\t\t ies->len[band],\n\t\t\t\t\t\t ies->common_ies,\n\t\t\t\t\t\t ies->common_ie_len,\n\t\t\t\t\t\t true);\n\t\tif (ret < 0) {\n\t\t\twl1271_error(\"5GHz PROBE request template failed\");\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\twl1271_dump(DEBUG_SCAN, \"SCAN_CFG: \", cfg, sizeof(*cfg));\n\n\tret = wl1271_cmd_send(wl, CMD_CONNECTION_SCAN_CFG, cfg,\n\t\t\t      sizeof(*cfg), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"SCAN configuration failed\");\n\t\tgoto out;\n\t}\nout:\n\tkfree(cfg_channels);\n\tkfree(cfg);\n\treturn ret;\n}\n\nint wl1271_scan_sched_scan_start(struct wl1271 *wl, struct wl12xx_vif *wlvif)\n{\n\tstruct wl1271_cmd_sched_scan_start *start;\n\tint ret = 0;\n\n\twl1271_debug(DEBUG_CMD, \"cmd periodic scan start\");\n\n\tif (wlvif->bss_type != BSS_TYPE_STA_BSS)\n\t\treturn -EOPNOTSUPP;\n\n\tif ((wl->quirks & WLCORE_QUIRK_NO_SCHED_SCAN_WHILE_CONN) &&\n\t    test_bit(WLVIF_FLAG_IN_USE, &wlvif->flags))\n\t\treturn -EBUSY;\n\n\tstart = kzalloc(sizeof(*start), GFP_KERNEL);\n\tif (!start)\n\t\treturn -ENOMEM;\n\n\tstart->role_id = wlvif->role_id;\n\tstart->tag = WL1271_SCAN_DEFAULT_TAG;\n\n\tret = wl1271_cmd_send(wl, CMD_START_PERIODIC_SCAN, start,\n\t\t\t      sizeof(*start), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"failed to send scan start command\");\n\t\tgoto out_free;\n\t}\n\nout_free:\n\tkfree(start);\n\treturn ret;\n}\n\nint wl12xx_sched_scan_start(struct wl1271 *wl, struct wl12xx_vif  *wlvif,\n\t\t\t    struct cfg80211_sched_scan_request *req,\n\t\t\t    struct ieee80211_scan_ies *ies)\n{\n\tint ret;\n\n\tret = wl1271_scan_sched_scan_config(wl, wlvif, req, ies);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn wl1271_scan_sched_scan_start(wl, wlvif);\n}\n\nvoid wl12xx_scan_sched_scan_stop(struct wl1271 *wl,  struct wl12xx_vif *wlvif)\n{\n\tstruct wl1271_cmd_sched_scan_stop *stop;\n\tint ret = 0;\n\n\twl1271_debug(DEBUG_CMD, \"cmd periodic scan stop\");\n\n\t \n\tstop = kzalloc(sizeof(*stop), GFP_KERNEL);\n\tif (!stop) {\n\t\twl1271_error(\"failed to alloc memory to send sched scan stop\");\n\t\treturn;\n\t}\n\n\tstop->role_id = wlvif->role_id;\n\tstop->tag = WL1271_SCAN_DEFAULT_TAG;\n\n\tret = wl1271_cmd_send(wl, CMD_STOP_PERIODIC_SCAN, stop,\n\t\t\t      sizeof(*stop), 0);\n\tif (ret < 0) {\n\t\twl1271_error(\"failed to send sched scan stop command\");\n\t\tgoto out_free;\n\t}\n\nout_free:\n\tkfree(stop);\n}\n\nint wl12xx_scan_start(struct wl1271 *wl, struct wl12xx_vif *wlvif,\n\t\t      struct cfg80211_scan_request *req)\n{\n\twl1271_scan_stm(wl, wlvif);\n\treturn 0;\n}\n\nvoid wl12xx_scan_completed(struct wl1271 *wl, struct wl12xx_vif *wlvif)\n{\n\twl1271_scan_stm(wl, wlvif);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}