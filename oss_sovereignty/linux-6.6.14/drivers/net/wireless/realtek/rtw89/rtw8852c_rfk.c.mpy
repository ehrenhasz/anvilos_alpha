{
  "module_name": "rtw8852c_rfk.c",
  "hash_id": "7d6ca91680df915bfd714c9b9d984b9466d4164aee61764839366389c8baa67c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtw89/rtw8852c_rfk.c",
  "human_readable_source": "\n \n\n#include \"coex.h\"\n#include \"debug.h\"\n#include \"phy.h\"\n#include \"reg.h\"\n#include \"rtw8852c.h\"\n#include \"rtw8852c_rfk.h\"\n#include \"rtw8852c_rfk_table.h\"\n#include \"rtw8852c_table.h\"\n\nstruct rxck_def {\n\tu32 ctl;\n\tu32 en;\n\tu32 bw0;\n\tu32 bw1;\n\tu32 mul;\n\tu32 lp;\n};\n\n#define _TSSI_DE_MASK GENMASK(21, 12)\nstatic const u32 _tssi_de_cck_long[RF_PATH_NUM_8852C] = {0x5858, 0x7858};\nstatic const u32 _tssi_de_cck_short[RF_PATH_NUM_8852C] = {0x5860, 0x7860};\nstatic const u32 _tssi_de_mcs_20m[RF_PATH_NUM_8852C] = {0x5838, 0x7838};\nstatic const u32 _tssi_de_mcs_40m[RF_PATH_NUM_8852C] = {0x5840, 0x7840};\nstatic const u32 _tssi_de_mcs_80m[RF_PATH_NUM_8852C] = {0x5848, 0x7848};\nstatic const u32 _tssi_de_mcs_80m_80m[RF_PATH_NUM_8852C] = {0x5850, 0x7850};\nstatic const u32 _tssi_de_mcs_5m[RF_PATH_NUM_8852C] = {0x5828, 0x7828};\nstatic const u32 _tssi_de_mcs_10m[RF_PATH_NUM_8852C] = {0x5830, 0x7830};\n\nstatic const u32 rtw8852c_backup_bb_regs[] = {\n\t0x8120, 0xc0d4, 0xc0d8, 0xc0e8, 0x8220, 0xc1d4, 0xc1d8, 0xc1e8\n};\n\nstatic const u32 rtw8852c_backup_rf_regs[] = {\n\t0xdf, 0x5f, 0x8f, 0x97, 0xa3, 0x5, 0x10005\n};\n\n#define BACKUP_BB_REGS_NR ARRAY_SIZE(rtw8852c_backup_bb_regs)\n#define BACKUP_RF_REGS_NR ARRAY_SIZE(rtw8852c_backup_rf_regs)\n\n#define RXK_GROUP_NR 4\nstatic const u32 _rxk_a6_idxrxgain[RXK_GROUP_NR] = {0x190, 0x196, 0x290, 0x316};\nstatic const u32 _rxk_a6_idxattc2[RXK_GROUP_NR] = {0x00, 0x0, 0x00, 0x00};\nstatic const u32 _rxk_a_idxrxgain[RXK_GROUP_NR] = {0x190, 0x198, 0x310, 0x318};\nstatic const u32 _rxk_a_idxattc2[RXK_GROUP_NR] = {0x00, 0x00, 0x00, 0x00};\nstatic const u32 _rxk_g_idxrxgain[RXK_GROUP_NR] = {0x252, 0x26c, 0x350, 0x360};\nstatic const u32 _rxk_g_idxattc2[RXK_GROUP_NR] = {0x00, 0x07, 0x00, 0x3};\n\n#define TXK_GROUP_NR 3\nstatic const u32 _txk_a6_power_range[TXK_GROUP_NR] = {0x0, 0x0, 0x0};\nstatic const u32 _txk_a6_track_range[TXK_GROUP_NR] = {0x6, 0x7, 0x7};\nstatic const u32 _txk_a6_gain_bb[TXK_GROUP_NR] = {0x12, 0x09, 0x0e};\nstatic const u32 _txk_a6_itqt[TXK_GROUP_NR] = {0x12, 0x12, 0x12};\nstatic const u32 _txk_a_power_range[TXK_GROUP_NR] = {0x0, 0x0, 0x0};\nstatic const u32 _txk_a_track_range[TXK_GROUP_NR] = {0x5, 0x6, 0x7};\nstatic const u32 _txk_a_gain_bb[TXK_GROUP_NR] = {0x12, 0x09, 0x0e};\nstatic const u32 _txk_a_itqt[TXK_GROUP_NR] = {0x12, 0x12, 0x12};\nstatic const u32 _txk_g_power_range[TXK_GROUP_NR] = {0x0, 0x0, 0x0};\nstatic const u32 _txk_g_track_range[TXK_GROUP_NR] = {0x5, 0x6, 0x6};\nstatic const u32 _txk_g_gain_bb[TXK_GROUP_NR] = {0x0e, 0x0a, 0x0e};\nstatic const u32 _txk_g_itqt[TXK_GROUP_NR] = { 0x12, 0x12, 0x12};\n\nstatic const u32 dpk_par_regs[RTW89_DPK_RF_PATH][4] = {\n\t{0x8190, 0x8194, 0x8198, 0x81a4},\n\t{0x81a8, 0x81c4, 0x81c8, 0x81e8},\n};\n\nstatic const u8 _dck_addr_bs[RF_PATH_NUM_8852C] = {0x0, 0x10};\nstatic const u8 _dck_addr[RF_PATH_NUM_8852C] = {0xc, 0x1c};\n\nstatic const struct rxck_def _ck480M = {0x8, 0x2, 0x3, 0xf, 0x0, 0x9};\nstatic const struct rxck_def _ck960M = {0x8, 0x2, 0x2, 0x8, 0x0, 0x9};\nstatic const struct rxck_def _ck1920M = {0x8, 0x0, 0x2, 0x4, 0x6, 0x9};\n\nstatic u8 _kpath(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]dbcc_en: %x,  PHY%d\\n\",\n\t\t    rtwdev->dbcc_en, phy_idx);\n\n\tif (!rtwdev->dbcc_en)\n\t\treturn RF_AB;\n\n\tif (phy_idx == RTW89_PHY_0)\n\t\treturn RF_A;\n\telse\n\t\treturn RF_B;\n}\n\nstatic void _rfk_backup_bb_reg(struct rtw89_dev *rtwdev, u32 backup_bb_reg_val[])\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_BB_REGS_NR; i++) {\n\t\tbackup_bb_reg_val[i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, rtw8852c_backup_bb_regs[i],\n\t\t\t\t\t      MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]backup bb reg : %x, value =%x\\n\",\n\t\t\t    rtw8852c_backup_bb_regs[i], backup_bb_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_backup_rf_reg(struct rtw89_dev *rtwdev, u32 backup_rf_reg_val[],\n\t\t\t       u8 rf_path)\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_RF_REGS_NR; i++) {\n\t\tbackup_rf_reg_val[i] =\n\t\t\trtw89_read_rf(rtwdev, rf_path,\n\t\t\t\t      rtw8852c_backup_rf_regs[i], RFREG_MASK);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]backup rf S%d reg : %x, value =%x\\n\", rf_path,\n\t\t\t    rtw8852c_backup_rf_regs[i], backup_rf_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_restore_bb_reg(struct rtw89_dev *rtwdev, u32 backup_bb_reg_val[])\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_BB_REGS_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, rtw8852c_backup_bb_regs[i],\n\t\t\t\t       MASKDWORD, backup_bb_reg_val[i]);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]restore bb reg : %x, value =%x\\n\",\n\t\t\t    rtw8852c_backup_bb_regs[i], backup_bb_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_restore_rf_reg(struct rtw89_dev *rtwdev, u32 backup_rf_reg_val[],\n\t\t\t\tu8 rf_path)\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_RF_REGS_NR; i++) {\n\t\trtw89_write_rf(rtwdev, rf_path, rtw8852c_backup_rf_regs[i],\n\t\t\t       RFREG_MASK, backup_rf_reg_val[i]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]restore rf S%d reg: %x, value =%x\\n\", rf_path,\n\t\t\t    rtw8852c_backup_rf_regs[i], backup_rf_reg_val[i]);\n\t}\n}\n\nstatic void _wait_rx_mode(struct rtw89_dev *rtwdev, u8 kpath)\n{\n\tu8 path;\n\tu32 rf_mode;\n\tint ret;\n\n\tfor (path = 0; path < RF_PATH_MAX; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\tret = read_poll_timeout_atomic(rtw89_read_rf, rf_mode, rf_mode != 2,\n\t\t\t\t\t       2, 5000, false, rtwdev, path, 0x00,\n\t\t\t\t\t       RR_MOD_MASK);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK] Wait S%d to Rx mode!! (ret = %d)\\n\",\n\t\t\t    path, ret);\n\t}\n}\n\nstatic void _dack_dump(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\tu8 t;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S0 ADC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->addck_d[0][0], dack->addck_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S1 ADC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->addck_d[1][0], dack->addck_d[1][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S0 DAC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->dadck_d[0][0], dack->dadck_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S1 DAC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->dadck_d[1][0], dack->dadck_d[1][1]);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S0 biask ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->biask_d[0][0], dack->biask_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S1 biask ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->biask_d[1][0], dack->biask_d[1][1]);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 MSBK ic:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[0][0][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 MSBK qc:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[0][1][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 MSBK ic:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[1][0][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 MSBK qc:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[1][1][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n}\n\nstatic void _addck_backup(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0, 0x0);\n\tdack->addck_d[0][0] = rtw89_phy_read32_mask(rtwdev, R_ADDCKR0,\n\t\t\t\t\t\t    B_ADDCKR0_A0);\n\tdack->addck_d[0][1] = rtw89_phy_read32_mask(rtwdev, R_ADDCKR0,\n\t\t\t\t\t\t    B_ADDCKR0_A1);\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1, 0x0);\n\tdack->addck_d[1][0] = rtw89_phy_read32_mask(rtwdev, R_ADDCKR1,\n\t\t\t\t\t\t    B_ADDCKR1_A0);\n\tdack->addck_d[1][1] = rtw89_phy_read32_mask(rtwdev, R_ADDCKR1,\n\t\t\t\t\t\t    B_ADDCKR1_A1);\n}\n\nstatic void _addck_reload(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0_RL, B_ADDCK0_RL1,\n\t\t\t       dack->addck_d[0][0]);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0_RL, B_ADDCK0_RL0,\n\t\t\t       dack->addck_d[0][1]);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0_RL, B_ADDCK0_RLS, 0x3);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1_RL, B_ADDCK1_RL1,\n\t\t\t       dack->addck_d[1][0]);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1_RL, B_ADDCK1_RL0,\n\t\t\t       dack->addck_d[1][1]);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1_RL, B_ADDCK1_RLS, 0x3);\n}\n\nstatic void _dack_backup_s0(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x1);\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DCOF0, B_DCOF0_V, i);\n\t\tdack->msbk_d[0][0][i] = rtw89_phy_read32_mask(rtwdev,\n\t\t\t\t\t\t\t      R_DACK_S0P2,\n\t\t\t\t\t\t\t      B_DACK_S0M0);\n\t\trtw89_phy_write32_mask(rtwdev, R_DCOF8, B_DCOF8_V, i);\n\t\tdack->msbk_d[0][1][i] = rtw89_phy_read32_mask(rtwdev,\n\t\t\t\t\t\t\t      R_DACK_S0P3,\n\t\t\t\t\t\t\t      B_DACK_S0M1);\n\t}\n\tdack->biask_d[0][0] = rtw89_phy_read32_mask(rtwdev, R_DACK_BIAS00,\n\t\t\t\t\t\t    B_DACK_BIAS00);\n\tdack->biask_d[0][1] = rtw89_phy_read32_mask(rtwdev, R_DACK_BIAS01,\n\t\t\t\t\t\t    B_DACK_BIAS01);\n\tdack->dadck_d[0][0] = rtw89_phy_read32_mask(rtwdev, R_DACK_DADCK00,\n\t\t\t\t\t\t    B_DACK_DADCK00);\n\tdack->dadck_d[0][1] = rtw89_phy_read32_mask(rtwdev, R_DACK_DADCK01,\n\t\t\t\t\t\t    B_DACK_DADCK01);\n}\n\nstatic void _dack_backup_s1(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\n\trtw89_phy_write32_mask(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON, 0x1);\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DACK10, B_DACK10, i);\n\t\tdack->msbk_d[1][0][i] = rtw89_phy_read32_mask(rtwdev,\n\t\t\t\t\t\t\t      R_DACK10S,\n\t\t\t\t\t\t\t      B_DACK10S);\n\t\trtw89_phy_write32_mask(rtwdev, R_DACK11, B_DACK11, i);\n\t\tdack->msbk_d[1][1][i] = rtw89_phy_read32_mask(rtwdev,\n\t\t\t\t\t\t\t      R_DACK11S,\n\t\t\t\t\t\t\t      B_DACK11S);\n\t}\n\tdack->biask_d[1][0] = rtw89_phy_read32_mask(rtwdev, R_DACK_BIAS10,\n\t\t\t\t\t\t    B_DACK_BIAS10);\n\tdack->biask_d[1][1] = rtw89_phy_read32_mask(rtwdev, R_DACK_BIAS11,\n\t\t\t\t\t\t    B_DACK_BIAS11);\n\tdack->dadck_d[1][0] = rtw89_phy_read32_mask(rtwdev, R_DACK_DADCK10,\n\t\t\t\t\t\t    B_DACK_DADCK10);\n\tdack->dadck_d[1][1] = rtw89_phy_read32_mask(rtwdev, R_DACK_DADCK11,\n\t\t\t\t\t\t    B_DACK_DADCK11);\n}\n\nstatic void _dack_reload_by_path(struct rtw89_dev *rtwdev,\n\t\t\t\t enum rtw89_rf_path path, u8 index)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 idx_offset, path_offset;\n\tu32 val32, offset, addr;\n\tu8 i;\n\n\tidx_offset = (index == 0 ? 0 : 0x14);\n\tpath_offset = (path == RF_PATH_A ? 0 : 0x28);\n\toffset = idx_offset + path_offset;\n\n\trtw89_rfk_parser(rtwdev, &rtw8852c_dack_reload_defs_tbl);\n\n\t \n\tval32 = 0x0;\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR / 4; i++)\n\t\tval32 |= dack->msbk_d[path][index][i + 12] << (i * 8);\n\taddr = 0xc200 + offset;\n\trtw89_phy_write32(rtwdev, addr, val32);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", addr,\n\t\t    rtw89_phy_read32_mask(rtwdev, addr, MASKDWORD));\n\n\t \n\tval32 = 0x0;\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR / 4; i++)\n\t\tval32 |= dack->msbk_d[path][index][i + 8] << (i * 8);\n\taddr = 0xc204 + offset;\n\trtw89_phy_write32(rtwdev, addr, val32);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", addr,\n\t\t    rtw89_phy_read32_mask(rtwdev, addr, MASKDWORD));\n\n\t \n\tval32 = 0x0;\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR / 4; i++)\n\t\tval32 |= dack->msbk_d[path][index][i + 4] << (i * 8);\n\taddr = 0xc208 + offset;\n\trtw89_phy_write32(rtwdev, addr, val32);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", addr,\n\t\t    rtw89_phy_read32_mask(rtwdev, addr, MASKDWORD));\n\n\t \n\tval32 = 0x0;\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR / 4; i++)\n\t\tval32 |= dack->msbk_d[path][index][i] << (i * 8);\n\taddr = 0xc20c + offset;\n\trtw89_phy_write32(rtwdev, addr, val32);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", addr,\n\t\t    rtw89_phy_read32_mask(rtwdev, addr, MASKDWORD));\n\n\t \n\tval32 = (dack->biask_d[path][index] << 22) |\n\t\t(dack->dadck_d[path][index] << 14);\n\taddr = 0xc210 + offset;\n\trtw89_phy_write32(rtwdev, addr, val32);\n\trtw89_phy_write32_set(rtwdev, addr, BIT(0));\n}\n\nstatic void _dack_reload(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < 2; i++)\n\t\t_dack_reload_by_path(rtwdev, path, i);\n}\n\nstatic void _addck(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 val;\n\tint ret;\n\n\t \n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_RST, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_EN, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_EN, 0x0);\n\tfsleep(1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0, 0x1);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val,\n\t\t\t\t       1, 10000, false, rtwdev, 0xc0fc, BIT(0));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 ADDCK timeout\\n\");\n\t\tdack->addck_timeout[0] = true;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_RST, 0x0);\n\n\t \n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1_RST, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1_EN, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1_EN, 0x0);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1, 0x1);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val,\n\t\t\t\t       1, 10000, false, rtwdev, 0xc1fc, BIT(0));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 ADDCK timeout\\n\");\n\t\tdack->addck_timeout[0] = true;\n\t}\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1_RST, 0x0);\n}\n\nstatic void _dack_reset(struct rtw89_dev *rtwdev, u8 path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852c_dack_reset_defs_a_tbl,\n\t\t\t\t &rtw8852c_dack_reset_defs_b_tbl);\n}\n\nenum adc_ck {\n\tADC_NA = 0,\n\tADC_480M = 1,\n\tADC_960M = 2,\n\tADC_1920M = 3,\n};\n\nenum dac_ck {\n\tDAC_40M = 0,\n\tDAC_80M = 1,\n\tDAC_120M = 2,\n\tDAC_160M = 3,\n\tDAC_240M = 4,\n\tDAC_320M = 5,\n\tDAC_480M = 6,\n\tDAC_960M = 7,\n};\n\nenum rf_mode {\n\tRF_SHUT_DOWN = 0x0,\n\tRF_STANDBY = 0x1,\n\tRF_TX = 0x2,\n\tRF_RX = 0x3,\n\tRF_TXIQK = 0x4,\n\tRF_DPK = 0x5,\n\tRF_RXK1 = 0x6,\n\tRF_RXK2 = 0x7,\n};\n\nstatic void rtw8852c_txck_force(struct rtw89_dev *rtwdev, u8 path, bool force,\n\t\t\t\tenum dac_ck ck)\n{\n\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK | (path << 13), B_P0_TXCK_ON, 0x0);\n\n\tif (!force)\n\t\treturn;\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK | (path << 13), B_P0_TXCK_VAL, ck);\n\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK | (path << 13), B_P0_TXCK_ON, 0x1);\n}\n\nstatic void rtw8852c_rxck_force(struct rtw89_dev *rtwdev, u8 path, bool force,\n\t\t\t\tenum adc_ck ck)\n{\n\tconst struct rxck_def *def;\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK | (path << 13), B_P0_RXCK_ON, 0x0);\n\n\tif (!force)\n\t\treturn;\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK | (path << 13), B_P0_RXCK_VAL, ck);\n\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK | (path << 13), B_P0_RXCK_ON, 0x1);\n\n\tswitch (ck) {\n\tcase ADC_480M:\n\t\tdef = &_ck480M;\n\t\tbreak;\n\tcase ADC_960M:\n\t\tdef = &_ck960M;\n\t\tbreak;\n\tcase ADC_1920M:\n\tdefault:\n\t\tdef = &_ck1920M;\n\t\tbreak;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW0 | (path << 8), B_P0_CFCH_CTL, def->ctl);\n\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW0 | (path << 8), B_P0_CFCH_EN, def->en);\n\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW0 | (path << 8), B_P0_CFCH_BW0, def->bw0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW1 | (path << 8), B_P0_CFCH_BW1, def->bw1);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK | (path << 8), B_DRCK_MUL, def->mul);\n\trtw89_phy_write32_mask(rtwdev, R_ADCMOD | (path << 8), B_ADCMOD_LP, def->lp);\n}\n\nstatic bool _check_dack_done(struct rtw89_dev *rtwdev, bool s0)\n{\n\tif (s0) {\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_DACK_S0P0, B_DACK_S0P0_OK) == 0 ||\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S0P1, B_DACK_S0P1_OK) == 0 ||\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S0P2, B_DACK_S0P2_OK) == 0 ||\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S0P3, B_DACK_S0P3_OK) == 0)\n\t\t\treturn false;\n\t} else {\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_DACK_S1P0, B_DACK_S1P0_OK) == 0 ||\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S1P1, B_DACK_S1P1_OK) == 0 ||\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S1P2, B_DACK_S1P2_OK) == 0 ||\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S1P3, B_DACK_S1P3_OK) == 0)\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic void _dack_s0(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tbool done;\n\tint ret;\n\n\trtw8852c_txck_force(rtwdev, RF_PATH_A, true, DAC_160M);\n\trtw89_rfk_parser(rtwdev, &rtw8852c_dack_defs_s0_tbl);\n\n\t_dack_reset(rtwdev, RF_PATH_A);\n\n\trtw89_phy_write32_mask(rtwdev, R_DCOF1, B_DCOF1_S, 0x1);\n\tret = read_poll_timeout_atomic(_check_dack_done, done, done,\n\t\t\t\t       1, 10000, false, rtwdev, true);\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 DACK timeout\\n\");\n\t\tdack->msbk_timeout[0] = true;\n\t}\n\trtw89_phy_write32_mask(rtwdev, R_DCOF1, B_DCOF1_S, 0x0);\n\trtw8852c_txck_force(rtwdev, RF_PATH_A, false, DAC_960M);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S0 DADCK\\n\");\n\n\t_dack_backup_s0(rtwdev);\n\t_dack_reload(rtwdev, RF_PATH_A);\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x0);\n}\n\nstatic void _dack_s1(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tbool done;\n\tint ret;\n\n\trtw8852c_txck_force(rtwdev, RF_PATH_B, true, DAC_160M);\n\trtw89_rfk_parser(rtwdev, &rtw8852c_dack_defs_s1_tbl);\n\n\t_dack_reset(rtwdev, RF_PATH_B);\n\n\trtw89_phy_write32_mask(rtwdev, R_DACK1_K, B_DACK1_EN, 0x1);\n\tret = read_poll_timeout_atomic(_check_dack_done, done, done,\n\t\t\t\t       1, 10000, false, rtwdev, false);\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 DACK timeout\\n\");\n\t\tdack->msbk_timeout[0] = true;\n\t}\n\trtw89_phy_write32_mask(rtwdev, R_DACK1_K, B_DACK1_EN, 0x0);\n\trtw8852c_txck_force(rtwdev, RF_PATH_B, false, DAC_960M);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S1 DADCK\\n\");\n\n\t_dack_backup_s1(rtwdev);\n\t_dack_reload(rtwdev, RF_PATH_B);\n\trtw89_phy_write32_mask(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON, 0x0);\n}\n\nstatic void _dack(struct rtw89_dev *rtwdev)\n{\n\t_dack_s0(rtwdev);\n\t_dack_s1(rtwdev);\n}\n\nstatic void _drck(struct rtw89_dev *rtwdev)\n{\n\tu32 val;\n\tint ret;\n\n\trtw89_phy_write32_mask(rtwdev, R_DRCK, B_DRCK_EN, 0x1);\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val,\n\t\t\t\t       1, 10000, false, rtwdev, 0xc0c8, BIT(3));\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,  \"[DACK]DRCK timeout\\n\");\n\n\trtw89_rfk_parser(rtwdev, &rtw8852c_drck_defs_tbl);\n\n\tval = rtw89_phy_read32_mask(rtwdev, R_DRCK_RES, B_DRCK_RES);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK, B_DRCK_IDLE, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK, B_DRCK_VAL, val);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0xc0c4 = 0x%x\\n\",\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DRCK, MASKDWORD));\n}\n\nstatic void _dac_cal(struct rtw89_dev *rtwdev, bool force)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 rf0_0, rf1_0;\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, RTW89_PHY_0, RF_AB);\n\n\tdack->dack_done = false;\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK b\\n\");\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK start!!!\\n\");\n\trf0_0 = rtw89_read_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK);\n\trf1_0 = rtw89_read_rf(rtwdev, RF_PATH_B, RR_MOD, RFREG_MASK);\n\t_drck(rtwdev);\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK, 0x337e1);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_MOD, RFREG_MASK, 0x337e1);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_ONESHOT_START);\n\t_addck(rtwdev);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_ONESHOT_STOP);\n\n\t_addck_backup(rtwdev);\n\t_addck_reload(rtwdev);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MODOPT, RFREG_MASK, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_MODOPT, RFREG_MASK, 0x0);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_ONESHOT_START);\n\t_dack(rtwdev);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_ONESHOT_STOP);\n\n\t_dack_dump(rtwdev);\n\tdack->dack_done = true;\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK, rf0_0);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_MOD, RFREG_MASK, rf1_0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RR_RSV1_RST, 0x1);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV1, RR_RSV1_RST, 0x1);\n\tdack->dack_cnt++;\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK finish!!!\\n\");\n}\n\n#define RTW8852C_NCTL_VER 0xd\n#define RTW8852C_IQK_VER 0x2a\n#define RTW8852C_IQK_SS 2\n#define RTW8852C_IQK_THR_REK 8\n#define RTW8852C_IQK_CFIR_GROUP_NR 4\n\nenum rtw8852c_iqk_type {\n\tID_TXAGC,\n\tID_G_FLOK_COARSE,\n\tID_A_FLOK_COARSE,\n\tID_G_FLOK_FINE,\n\tID_A_FLOK_FINE,\n\tID_FLOK_VBUFFER,\n\tID_TXK,\n\tID_RXAGC,\n\tID_RXK,\n\tID_NBTXK,\n\tID_NBRXK,\n};\n\nstatic void rtw8852c_disable_rxagc(struct rtw89_dev *rtwdev, u8 path, u8 en_rxgac)\n{\n\tif (path == RF_PATH_A)\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_AGC_CTL, B_P0_AGC_EN, en_rxgac);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_AGC_CTL, B_P1_AGC_EN, en_rxgac);\n}\n\nstatic void _iqk_rxk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\tif (path == RF_PATH_A)\n\t\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RXK, 0x0101);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RXK, 0x0202);\n\n\tswitch (iqk_info->iqk_bw[path]) {\n\tcase RTW89_CHANNEL_WIDTH_20:\n\tcase RTW89_CHANNEL_WIDTH_40:\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), B_DPD_GDIS, 0x1);\n\t\trtw8852c_rxck_force(rtwdev, path, true, ADC_480M);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), B_ACK_VAL, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB2, RR_RXBB2_CKT, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW + (path << 13), B_P0_NRBW_DBG, 0x1);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_80:\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), B_DPD_GDIS, 0x1);\n\t\trtw8852c_rxck_force(rtwdev, path, true, ADC_960M);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), B_ACK_VAL, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB2, RR_RXBB2_CKT, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW + (path << 13), B_P0_NRBW_DBG, 0x1);\n\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_160:\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), B_DPD_GDIS, 0x1);\n\t\trtw8852c_rxck_force(rtwdev, path, true, ADC_1920M);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), B_ACK_VAL, 0x2);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB2, RR_RXBB2_CKT, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW + (path << 13), B_P0_NRBW_DBG, 0x1);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trtw89_rfk_parser(rtwdev, &rtw8852c_iqk_rxk_cfg_defs_tbl);\n\n\tif (path == RF_PATH_A)\n\t\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RXK, 0x1101);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RXK, 0x2202);\n}\n\nstatic bool _iqk_check_cal(struct rtw89_dev *rtwdev, u8 path, u8 ktype)\n{\n\tu32 tmp;\n\tu32 val;\n\tint ret;\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x55,\n\t\t\t\t       1, 8200, false, rtwdev, 0xbff8, MASKBYTE0);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]IQK timeout!!!\\n\");\n\n\trtw89_phy_write32_clr(rtwdev, R_NCTL_N1, MASKBYTE0);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, ret=%d\\n\", path, ret);\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, type= %x, 0x8008 = 0x%x\\n\", path, ktype, tmp);\n\n\treturn false;\n}\n\nstatic bool _iqk_one_shot(struct rtw89_dev *rtwdev,\n\t\t\t  enum rtw89_phy_idx phy_idx, u8 path, u8 ktype)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 addr_rfc_ctl = R_UPD_CLK + (path << 13);\n\tu32 iqk_cmd;\n\tbool fail;\n\n\tswitch (ktype) {\n\tcase ID_TXAGC:\n\t\tiqk_cmd = 0x008 | (1 << (4 + path)) | (path << 1);\n\t\tbreak;\n\tcase ID_A_FLOK_COARSE:\n\t\trtw89_phy_write32_mask(rtwdev, addr_rfc_ctl, 0x00000002, 0x1);\n\t\tiqk_cmd = 0x008 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_G_FLOK_COARSE:\n\t\trtw89_phy_write32_mask(rtwdev, addr_rfc_ctl, 0x00000002, 0x1);\n\t\tiqk_cmd = 0x108 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_A_FLOK_FINE:\n\t\trtw89_phy_write32_mask(rtwdev, addr_rfc_ctl, 0x00000002, 0x1);\n\t\tiqk_cmd = 0x508 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_G_FLOK_FINE:\n\t\trtw89_phy_write32_mask(rtwdev, addr_rfc_ctl, 0x00000002, 0x1);\n\t\tiqk_cmd = 0x208 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_FLOK_VBUFFER:\n\t\trtw89_phy_write32_mask(rtwdev, addr_rfc_ctl, 0x00000002, 0x1);\n\t\tiqk_cmd = 0x308 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_TXK:\n\t\trtw89_phy_write32_mask(rtwdev, addr_rfc_ctl, 0x00000002, 0x0);\n\t\tiqk_cmd = 0x008 | (1 << (4 + path)) | ((0x8 + iqk_info->iqk_bw[path]) << 8);\n\t\tbreak;\n\tcase ID_RXAGC:\n\t\tiqk_cmd = 0x508 | (1 << (4 + path)) | (path << 1);\n\t\tbreak;\n\tcase ID_RXK:\n\t\trtw89_phy_write32_mask(rtwdev, addr_rfc_ctl, 0x00000002, 0x1);\n\t\tiqk_cmd = 0x008 | (1 << (4 + path)) | ((0xc + iqk_info->iqk_bw[path]) << 8);\n\t\tbreak;\n\tcase ID_NBTXK:\n\t\trtw89_phy_write32_mask(rtwdev, addr_rfc_ctl, 0x00000002, 0x0);\n\t\tiqk_cmd = 0x408 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_NBRXK:\n\t\trtw89_phy_write32_mask(rtwdev, addr_rfc_ctl, 0x00000002, 0x1);\n\t\tiqk_cmd = 0x608 | (1 << (4 + path));\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD, iqk_cmd + 1);\n\tfsleep(15);\n\tfail = _iqk_check_cal(rtwdev, path, ktype);\n\trtw89_phy_write32_mask(rtwdev, addr_rfc_ctl, 0x00000002, 0x0);\n\n\treturn fail;\n}\n\nstatic bool _rxk_group_sel(struct rtw89_dev *rtwdev,\n\t\t\t   enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool fail;\n\tu32 tmp;\n\tu32 bkrf0;\n\tu8 gp;\n\n\tbkrf0 = rtw89_read_rf(rtwdev, path, RR_MOD, RR_MOD_NBW);\n\tif (path == RF_PATH_B) {\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_IQKPLL, RR_IQKPLL_MOD, 0x3);\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_B, RR_CHTR, RR_CHTR_MOD);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV4, RR_RSV4_AGH, tmp);\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_B, RR_CHTR, RR_CHTR_TXRX);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV4, RR_RSV4_PLLCH, tmp);\n\t}\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\tdefault:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0xc);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_NBW, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXG, RR_RXG_IQKMOD, 0x9);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0xc);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_NBW, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXAE, RR_RXAE_IQKMOD, 0x8);\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0xc);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_NBW, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXAE, RR_RXAE_IQKMOD, 0x9);\n\t\tbreak;\n\t}\n\n\tfsleep(10);\n\n\tfor (gp = 0; gp < RXK_GROUP_NR; gp++) {\n\t\tswitch (iqk_info->iqk_band[path]) {\n\t\tcase RTW89_BAND_2G:\n\t\tdefault:\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXG,\n\t\t\t\t       _rxk_g_idxrxgain[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_VOBUF,\n\t\t\t\t       _rxk_g_idxattc2[gp]);\n\t\t\tbreak;\n\t\tcase RTW89_BAND_5G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXG,\n\t\t\t\t       _rxk_a_idxrxgain[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_IATT,\n\t\t\t\t       _rxk_a_idxattc2[gp]);\n\t\t\tbreak;\n\t\tcase RTW89_BAND_6G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXG,\n\t\t\t\t       _rxk_a6_idxrxgain[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_IATT,\n\t\t\t\t       _rxk_a6_idxattc2[gp]);\n\t\t\tbreak;\n\t\t}\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_SET, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_GP_V1, gp);\n\t\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_RXK);\n\t}\n\n\tif (path == RF_PATH_B)\n\t\trtw89_write_rf(rtwdev, path, RR_IQKPLL, RR_IQKPLL_MOD, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_NBW, bkrf0);\n\n\tif (fail) {\n\t\tiqk_info->nb_rxcfir[path] = 0x40000002;\n\t\tiqk_info->is_wb_rxiqk[path] = false;\n\t} else {\n\t\tiqk_info->nb_rxcfir[path] = 0x40000000;\n\t\tiqk_info->is_wb_rxiqk[path] = true;\n\t}\n\n\treturn false;\n}\n\nstatic bool _iqk_nbrxk(struct rtw89_dev *rtwdev,\n\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool fail;\n\tu32 tmp;\n\tu32 bkrf0;\n\tu8 gp = 0x2;\n\n\tbkrf0 = rtw89_read_rf(rtwdev, path, RR_MOD, RR_MOD_NBW);\n\tif (path == RF_PATH_B) {\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_IQKPLL, RR_IQKPLL_MOD, 0x3);\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_B, RR_CHTR, RR_CHTR_MOD);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV4, RR_RSV4_AGH, tmp);\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_B, RR_CHTR, RR_CHTR_TXRX);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV4, RR_RSV4_PLLCH, tmp);\n\t}\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\tdefault:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0xc);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_NBW, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXG, RR_RXG_IQKMOD, 0x9);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0xc);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_NBW, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXAE, RR_RXAE_IQKMOD, 0x8);\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0xc);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_NBW, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXAE, RR_RXAE_IQKMOD, 0x9);\n\t\tbreak;\n\t}\n\n\tfsleep(10);\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\tdefault:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXG, _rxk_g_idxrxgain[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_VOBUF, _rxk_g_idxattc2[gp]);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXG, _rxk_a_idxrxgain[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_IATT, _rxk_a_idxattc2[gp]);\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXG, _rxk_a6_idxrxgain[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_IATT, _rxk_a6_idxattc2[gp]);\n\t\tbreak;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SEL, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SET, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_GP_V1, gp);\n\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_RXK);\n\n\tif (path == RF_PATH_B)\n\t\trtw89_write_rf(rtwdev, path, RR_IQKPLL, RR_IQKPLL_MOD, 0x0);\n\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_NBW, bkrf0);\n\n\tif (fail)\n\t\tiqk_info->nb_rxcfir[path] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t\t      MASKDWORD) | 0x2;\n\telse\n\t\tiqk_info->nb_rxcfir[path] = 0x40000002;\n\n\tiqk_info->is_wb_rxiqk[path] = false;\n\treturn fail;\n}\n\nstatic bool _txk_group_sel(struct rtw89_dev *rtwdev,\n\t\t\t   enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool fail;\n\tu8 gp;\n\n\tfor (gp = 0; gp < TXK_GROUP_NR; gp++) {\n\t\tswitch (iqk_info->iqk_band[path]) {\n\t\tcase RTW89_BAND_2G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0,\n\t\t\t\t       _txk_g_power_range[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1,\n\t\t\t\t       _txk_g_track_range[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG,\n\t\t\t\t       _txk_g_gain_bb[gp]);\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_KIP_IQP + (path << 8),\n\t\t\t\t\t       MASKDWORD, _txk_g_itqt[gp]);\n\t\t\tbreak;\n\t\tcase RTW89_BAND_5G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0,\n\t\t\t\t       _txk_a_power_range[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1,\n\t\t\t\t       _txk_a_track_range[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG,\n\t\t\t\t       _txk_a_gain_bb[gp]);\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_KIP_IQP + (path << 8),\n\t\t\t\t\t       MASKDWORD, _txk_a_itqt[gp]);\n\t\t\tbreak;\n\t\tcase RTW89_BAND_6G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0,\n\t\t\t\t       _txk_a6_power_range[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1,\n\t\t\t\t       _txk_a6_track_range[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG,\n\t\t\t\t       _txk_a6_gain_bb[gp]);\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_KIP_IQP + (path << 8),\n\t\t\t\t\t       MASKDWORD, _txk_a6_itqt[gp]);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_SET, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_G2, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_GP, gp + 1);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x00b);\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\t\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_TXK);\n\t}\n\n\tif (fail) {\n\t\tiqk_info->nb_txcfir[path] = 0x40000002;\n\t\tiqk_info->is_wb_txiqk[path] = false;\n\t} else {\n\t\tiqk_info->nb_txcfir[path] = 0x40000000;\n\t\tiqk_info->is_wb_txiqk[path] = true;\n\t}\n\n\treturn fail;\n}\n\nstatic bool _iqk_nbtxk(struct rtw89_dev *rtwdev,\n\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool fail;\n\tu8 gp = 0x2;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, _txk_g_power_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, _txk_g_track_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, _txk_g_gain_bb[gp]);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       MASKDWORD, _txk_g_itqt[gp]);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, _txk_a_power_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, _txk_a_track_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, _txk_a_gain_bb[gp]);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       MASKDWORD, _txk_a_itqt[gp]);\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, _txk_a6_power_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, _txk_a6_track_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, _txk_a6_gain_bb[gp]);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       MASKDWORD, _txk_a6_itqt[gp]);\n\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SEL, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SET, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_G2, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_GP, gp + 1);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x00b);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBTXK);\n\n\tif (!fail)\n\t\tiqk_info->nb_txcfir[path] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_TXIQC + (path << 8),\n\t\t\t\t\t      MASKDWORD) | 0x2;\n\telse\n\t\tiqk_info->nb_txcfir[path] = 0x40000002;\n\n\tiqk_info->is_wb_txiqk[path] = false;\n\n\treturn fail;\n}\n\nstatic bool _lok_finetune_check(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_rfk_mcc_info *rfk_mcc = &rtwdev->rfk_mcc;\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 idx = rfk_mcc->table_idx;\n\tbool is_fail1,  is_fail2;\n\tu32 val;\n\tu32 core_i;\n\tu32 core_q;\n\tu32 vbuff_i;\n\tu32 vbuff_q;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\tval = rtw89_read_rf(rtwdev,  path, RR_TXMO, RFREG_MASK);\n\tcore_i = FIELD_GET(RR_TXMO_COI, val);\n\tcore_q = FIELD_GET(RR_TXMO_COQ, val);\n\n\tif (core_i < 0x2 || core_i > 0x1d || core_q < 0x2 || core_q > 0x1d)\n\t\tis_fail1 = true;\n\telse\n\t\tis_fail1 = false;\n\n\tiqk_info->lok_idac[idx][path] = val;\n\n\tval = rtw89_read_rf(rtwdev, path, RR_LOKVB, RFREG_MASK);\n\tvbuff_i = FIELD_GET(RR_LOKVB_COI, val);\n\tvbuff_q = FIELD_GET(RR_LOKVB_COQ, val);\n\n\tif (vbuff_i < 0x2 || vbuff_i > 0x3d || vbuff_q < 0x2 || vbuff_q > 0x3d)\n\t\tis_fail2 = true;\n\telse\n\t\tis_fail2 = false;\n\n\tiqk_info->lok_vbuf[idx][path] = val;\n\n\treturn is_fail1 || is_fail2;\n}\n\nstatic bool _iqk_lok(struct rtw89_dev *rtwdev,\n\t\t     enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 tmp_id = 0x0;\n\tbool fail = false;\n\tbool tmp = false;\n\n\t \n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, IQK_DF4_TXT_8_25MHZ);\n\n\t \n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x6);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x9);\n\t\ttmp_id = ID_G_FLOK_COARSE;\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x6);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x9);\n\t\ttmp_id = ID_A_FLOK_COARSE;\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x6);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x9);\n\t\ttmp_id = ID_A_FLOK_COARSE;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\ttmp = _iqk_one_shot(rtwdev, phy_idx, path, tmp_id);\n\tiqk_info->lok_cor_fail[0][path] = tmp;\n\n\t \n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x12);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x1b);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x12);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x1b);\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x12);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x1b);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\ttmp = _iqk_one_shot(rtwdev, phy_idx, path, ID_FLOK_VBUFFER);\n\n\t \n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x6);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x9);\n\t\ttmp_id = ID_G_FLOK_FINE;\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x6);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x9);\n\t\ttmp_id = ID_A_FLOK_FINE;\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x6);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x9);\n\t\ttmp_id = ID_A_FLOK_FINE;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\ttmp = _iqk_one_shot(rtwdev, phy_idx, path, tmp_id);\n\tiqk_info->lok_fin_fail[0][path] = tmp;\n\n\t \n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\tdefault:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x12);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x1b);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x12);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x1b);\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x12);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       B_KIP_IQP_IQSW, 0x1b);\n\t\tbreak;\n\t}\n\ttmp = _iqk_one_shot(rtwdev, phy_idx, path, ID_FLOK_VBUFFER);\n\tfail = _lok_finetune_check(rtwdev, path);\n\n\treturn fail;\n}\n\nstatic void _iqk_txk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\tdefault:\n\t\trtw89_write_rf(rtwdev, path, RR_TXG1, RR_TXG1_ATT2, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXG1, RR_TXG1_ATT1, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXG2, RR_TXG2_ATT0, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TXA2, RR_TXA2_LDO, 0xf);\n\t\trtw89_write_rf(rtwdev, path, RR_TXGA, RR_TXGA_LOK_EXT, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK,\n\t\t\t       0x403e0 | iqk_info->syn1to2);\n\t\tfsleep(10);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, 0x6);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXATANK, RR_TXATANK_LBSW2, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXPOW, RR_TXPOW_TXAS, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TXA2, RR_TXA2_LDO, 0xf);\n\t\trtw89_write_rf(rtwdev, path, RR_TXGA, RR_TXGA_LOK_EXT, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK,\n\t\t\t       0x403e0 | iqk_info->syn1to2);\n\t\tfsleep(10);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, 0x6);\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXATANK, RR_TXATANK_LBSW2, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXPOW, RR_TXPOW_TXAS, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TXA2, RR_TXA2_LDO, 0xf);\n\t\trtw89_write_rf(rtwdev, path, RR_TXGA, RR_TXGA_LOK_EXT, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK,\n\t\t\t       0x403e0  | iqk_info->syn1to2);\n\t\tfsleep(10);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, 0x6);\n\t\tbreak;\n\t}\n}\n\nstatic void _iqk_info_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t  u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 tmp;\n\tbool flag;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d_thermal = %lu\\n\", path,\n\t\t    ewma_thermal_read(&rtwdev->phystat.avg_thermal[path]));\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d_LOK_COR_fail= %d\\n\", path,\n\t\t    iqk_info->lok_cor_fail[0][path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d_LOK_FIN_fail= %d\\n\", path,\n\t\t    iqk_info->lok_fin_fail[0][path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d_TXIQK_fail = %d\\n\", path,\n\t\t    iqk_info->iqk_tx_fail[0][path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d_RXIQK_fail= %d,\\n\", path,\n\t\t    iqk_info->iqk_rx_fail[0][path]);\n\n\tflag = iqk_info->lok_cor_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_FCOR << (path * 4), flag);\n\tflag = iqk_info->lok_fin_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_FFIN << (path * 4), flag);\n\tflag = iqk_info->iqk_tx_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_FTX << (path * 4), flag);\n\tflag = iqk_info->iqk_rx_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_F_RX << (path * 4), flag);\n\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_IQK_RES + (path << 8), MASKDWORD);\n\tiqk_info->bp_iqkenable[path] = tmp;\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD);\n\tiqk_info->bp_txkresult[path] = tmp;\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD);\n\tiqk_info->bp_rxkresult[path] = tmp;\n\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF2, B_IQKINF2_KCNT,\n\t\t\t       iqk_info->iqk_times);\n\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_IQKINF, B_IQKINF_FAIL << (path * 4));\n\tif (tmp != 0x0)\n\t\tiqk_info->iqk_fail_cnt++;\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF2, B_IQKINF2_FCNT << (path * 4),\n\t\t\t       iqk_info->iqk_fail_cnt);\n}\n\nstatic void _iqk_by_path(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\t_iqk_txk_setting(rtwdev, path);\n\tiqk_info->lok_fail[path] = _iqk_lok(rtwdev, phy_idx, path);\n\n\tif (iqk_info->is_nbiqk)\n\t\tiqk_info->iqk_tx_fail[0][path] = _iqk_nbtxk(rtwdev, phy_idx, path);\n\telse\n\t\tiqk_info->iqk_tx_fail[0][path] = _txk_group_sel(rtwdev, phy_idx, path);\n\n\t_iqk_rxk_setting(rtwdev, path);\n\tif (iqk_info->is_nbiqk)\n\t\tiqk_info->iqk_rx_fail[0][path] = _iqk_nbrxk(rtwdev, phy_idx, path);\n\telse\n\t\tiqk_info->iqk_rx_fail[0][path] = _rxk_group_sel(rtwdev, phy_idx, path);\n\n\t_iqk_info_iqk(rtwdev, phy_idx, path);\n}\n\nstatic void _iqk_get_ch_info(struct rtw89_dev *rtwdev,\n\t\t\t     enum rtw89_phy_idx phy, u8 path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\tiqk_info->iqk_band[path] = chan->band_type;\n\tiqk_info->iqk_bw[path] = chan->band_width;\n\tiqk_info->iqk_ch[path] = chan->channel;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]iqk_info->iqk_band[%x] = 0x%x\\n\", path,\n\t\t    iqk_info->iqk_band[path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]iqk_info->iqk_bw[%x] = 0x%x\\n\",\n\t\t    path, iqk_info->iqk_bw[path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]iqk_info->iqk_ch[%x] = 0x%x\\n\",\n\t\t    path, iqk_info->iqk_ch[path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%d (PHY%d): / DBCC %s/ %s/ CH%d/ %s\\n\", path, phy,\n\t\t    rtwdev->dbcc_en ? \"on\" : \"off\",\n\t\t    iqk_info->iqk_band[path] == 0 ? \"2G\" :\n\t\t    iqk_info->iqk_band[path] == 1 ? \"5G\" : \"6G\",\n\t\t    iqk_info->iqk_ch[path],\n\t\t    iqk_info->iqk_bw[path] == 0 ? \"20M\" :\n\t\t    iqk_info->iqk_bw[path] == 1 ? \"40M\" : \"80M\");\n\tif (!rtwdev->dbcc_en)\n\t\tiqk_info->syn1to2 = 0x1;\n\telse\n\t\tiqk_info->syn1to2 = 0x3;\n\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_VER, RTW8852C_IQK_VER);\n\trtw89_phy_write32_mask(rtwdev, R_IQKCH, B_IQKCH_BAND << (path * 16),\n\t\t\t       iqk_info->iqk_band[path]);\n\trtw89_phy_write32_mask(rtwdev, R_IQKCH, B_IQKCH_BW << (path * 16),\n\t\t\t       iqk_info->iqk_bw[path]);\n\trtw89_phy_write32_mask(rtwdev, R_IQKCH, B_IQKCH_CH << (path * 16),\n\t\t\t       iqk_info->iqk_ch[path]);\n\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF2, B_IQKINF2_NCTLV, RTW8852C_NCTL_VER);\n}\n\nstatic void _iqk_start_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t   u8 path)\n{\n\t_iqk_by_path(rtwdev, phy_idx, path);\n}\n\nstatic void _iqk_restore(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool fail;\n\n\trtw89_phy_write32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD,\n\t\t\t       iqk_info->nb_txcfir[path]);\n\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD,\n\t\t\t       iqk_info->nb_rxcfir[path]);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD,\n\t\t\t       0x00001219 + (path << 4));\n\tfsleep(200);\n\tfail = _iqk_check_cal(rtwdev, path, 0x12);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] restore fail  = %x\\n\", fail);\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000000);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x80000000);\n\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x1);\n}\n\nstatic void _iqk_afebb_restore(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852c_iqk_afebb_restore_defs_a_tbl,\n\t\t\t\t &rtw8852c_iqk_afebb_restore_defs_b_tbl);\n\n\trtw8852c_disable_rxagc(rtwdev, path, 0x1);\n}\n\nstatic void _iqk_preset(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_rfk_mcc_info *rfk_mcc = &rtwdev->rfk_mcc;\n\tu8 idx = 0;\n\n\tidx = rfk_mcc->table_idx;\n\trtw89_phy_write32_mask(rtwdev, R_COEF_SEL + (path << 8), B_COEF_SEL_IQC, idx);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_G3, idx);\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000080);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x81ff010a);\n}\n\nstatic void _iqk_macbb_setting(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===> %s\\n\", __func__);\n\n\t \n\trtw89_write_rf(rtwdev,  path, RR_BBDC, RR_BBDC_SEL, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A0 << path, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A1 << path, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A2 << path, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A3 << path, 0x0);\n\n\t \n\trtw8852c_disable_rxagc(rtwdev, path, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK | (path << 13), MASKDWORD, 0xf801fffd);\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK | (path << 13), B_DPD_DIS, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK | (path << 13), B_DAC_VAL, 0x1);\n\n\trtw8852c_txck_force(rtwdev, path, true, DAC_960M);\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK | (path << 13), B_DPD_GDIS, 0x1);\n\n\trtw8852c_rxck_force(rtwdev, path, true, ADC_1920M);\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK | (path << 13), B_ACK_VAL, 0x2);\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW | (path << 13), B_P0_NRBW_DBG, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x1f);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x13);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0x0001);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0x0041);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A1 << path, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A3 << path, 0x1);\n}\n\nstatic void _rck(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\tu32 rf_reg5, rck_val = 0;\n\tu32 val;\n\tint ret;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] ====== S%d RCK ======\\n\", path);\n\n\trf_reg5 = rtw89_read_rf(rtwdev, path, RR_RSV1, RFREG_MASK);\n\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] RF0x00 = 0x%x\\n\",\n\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK));\n\n\t \n\trtw89_write_rf(rtwdev, path, RR_RCKC, RFREG_MASK, 0x00240);\n\n\tret = read_poll_timeout_atomic(rtw89_read_rf, val, val, 2, 20,\n\t\t\t\t       false, rtwdev, path, 0x1c, BIT(3));\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] RCK timeout\\n\");\n\n\trck_val = rtw89_read_rf(rtwdev, path, RR_RCKC, RR_RCKC_CA);\n\trtw89_write_rf(rtwdev, path, RR_RCKC, RFREG_MASK, rck_val);\n\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RFREG_MASK, rf_reg5);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RCK] RF 0x1b / 0x1c = 0x%x / 0x%x\\n\",\n\t\t    rtw89_read_rf(rtwdev, path, RR_RCKC, RFREG_MASK),\n\t\t    rtw89_read_rf(rtwdev, path, RR_RCKS, RFREG_MASK));\n}\n\nstatic void _iqk_init(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 ch, path;\n\n\trtw89_phy_write32_clr(rtwdev, R_IQKINF, MASKDWORD);\n\tif (iqk_info->is_iqk_init)\n\t\treturn;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\tiqk_info->is_iqk_init = true;\n\tiqk_info->is_nbiqk = false;\n\tiqk_info->iqk_fft_en = false;\n\tiqk_info->iqk_sram_en = false;\n\tiqk_info->iqk_cfir_en = false;\n\tiqk_info->iqk_xym_en = false;\n\tiqk_info->iqk_times = 0x0;\n\n\tfor (ch = 0; ch < RTW89_IQK_CHS_NR; ch++) {\n\t\tiqk_info->iqk_channel[ch] = 0x0;\n\t\tfor (path = 0; path < RTW8852C_IQK_SS; path++) {\n\t\t\tiqk_info->lok_cor_fail[ch][path] = false;\n\t\t\tiqk_info->lok_fin_fail[ch][path] = false;\n\t\t\tiqk_info->iqk_tx_fail[ch][path] = false;\n\t\t\tiqk_info->iqk_rx_fail[ch][path] = false;\n\t\t\tiqk_info->iqk_mcc_ch[ch][path] = 0x0;\n\t\t\tiqk_info->iqk_table_idx[path] = 0x0;\n\t\t}\n\t}\n}\n\nstatic void _doiqk(struct rtw89_dev *rtwdev, bool force,\n\t\t   enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 backup_bb_val[BACKUP_BB_REGS_NR];\n\tu32 backup_rf_val[RTW8852C_IQK_SS][BACKUP_RF_REGS_NR];\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, RF_AB);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_START);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]==========IQK start!!!!!==========\\n\");\n\tiqk_info->iqk_times++;\n\tiqk_info->version = RTW8852C_IQK_VER;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]Test Ver 0x%x\\n\", iqk_info->version);\n\t_iqk_get_ch_info(rtwdev, phy_idx, path);\n\t_rfk_backup_bb_reg(rtwdev, backup_bb_val);\n\t_rfk_backup_rf_reg(rtwdev, backup_rf_val[path], path);\n\t_iqk_macbb_setting(rtwdev, phy_idx, path);\n\t_iqk_preset(rtwdev, path);\n\t_iqk_start_iqk(rtwdev, phy_idx, path);\n\t_iqk_restore(rtwdev, path);\n\t_iqk_afebb_restore(rtwdev, phy_idx, path);\n\t_rfk_restore_bb_reg(rtwdev, backup_bb_val);\n\t_rfk_restore_rf_reg(rtwdev, backup_rf_val[path], path);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_STOP);\n}\n\nstatic void _iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, bool force)\n{\n\tswitch (_kpath(rtwdev, phy_idx)) {\n\tcase RF_A:\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_A);\n\t\tbreak;\n\tcase RF_B:\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_B);\n\t\tbreak;\n\tcase RF_AB:\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_A);\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_B);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void _rx_dck_value_rewrite(struct rtw89_dev *rtwdev, u8 path, u8 addr,\n\t\t\t\t  u8 val_i, u8 val_q)\n{\n\tu32 ofst_val;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RX_DCK] rewrite val_i = 0x%x, val_q = 0x%x\\n\", val_i, val_q);\n\n\t \n\tofst_val = u32_encode_bits(val_q >> 1, RR_LUTWD0_MB) |\n\t\t   u32_encode_bits(val_i >> 1, RR_LUTWD0_LB);\n\n\trtw89_write_rf(rtwdev, path, RR_LUTPLL, RR_CAL_RW, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_RFC, RR_WCAL, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_FINE, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_LUTWA, MASKBYTE0, addr);\n\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RFREG_MASK, ofst_val);\n\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RFREG_MASK, ofst_val);\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_FINE, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RFC, RR_WCAL, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_LUTPLL, RR_CAL_RW, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RX_DCK] Final val_i = 0x%x, val_q = 0x%x\\n\",\n\t\t    u32_get_bits(ofst_val, RR_LUTWD0_LB) << 1,\n\t\t    u32_get_bits(ofst_val, RR_LUTWD0_MB) << 1);\n}\n\nstatic bool _rx_dck_rek_check(struct rtw89_dev *rtwdev, u8 path)\n{\n\tu8 i_even_bs, q_even_bs;\n\tu8 i_odd_bs, q_odd_bs;\n\tu8 i_even, q_even;\n\tu8 i_odd, q_odd;\n\tconst u8 th = 10;\n\tu8 i;\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++) {\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_DCK, _dck_addr_bs[i]);\n\t\ti_even_bs = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_TIA);\n\t\tq_even_bs = rtw89_read_rf(rtwdev, path, RR_DCK1, RR_DCK1_TIA);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RX_DCK] Gain[0x%x] i_even_bs/ q_even_bs = 0x%x/ 0x%x\\n\",\n\t\t\t    _dck_addr_bs[i], i_even_bs, q_even_bs);\n\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_DCK, _dck_addr[i]);\n\t\ti_even = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_TIA);\n\t\tq_even = rtw89_read_rf(rtwdev, path, RR_DCK1, RR_DCK1_TIA);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RX_DCK] Gain[0x%x] i_even/ q_even = 0x%x/ 0x%x\\n\",\n\t\t\t    _dck_addr[i], i_even, q_even);\n\n\t\tif (abs(i_even_bs - i_even) > th || abs(q_even_bs - q_even) > th)\n\t\t\treturn true;\n\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_DCK, _dck_addr_bs[i] + 1);\n\t\ti_odd_bs = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_TIA);\n\t\tq_odd_bs = rtw89_read_rf(rtwdev, path, RR_DCK1, RR_DCK1_TIA);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RX_DCK] Gain[0x%x] i_odd_bs/ q_odd_bs = 0x%x/ 0x%x\\n\",\n\t\t\t    _dck_addr_bs[i] + 1, i_odd_bs, q_odd_bs);\n\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_DCK, _dck_addr[i] + 1);\n\t\ti_odd = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_TIA);\n\t\tq_odd = rtw89_read_rf(rtwdev, path, RR_DCK1, RR_DCK1_TIA);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RX_DCK] Gain[0x%x] i_odd/ q_odd = 0x%x/ 0x%x\\n\",\n\t\t\t    _dck_addr[i] + 1, i_odd, q_odd);\n\n\t\tif (abs(i_odd_bs - i_odd) > th || abs(q_odd_bs - q_odd) > th)\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic void _rx_dck_fix_if_need(struct rtw89_dev *rtwdev, u8 path, u8 addr,\n\t\t\t\tu8 val_i_bs, u8 val_q_bs, u8 val_i, u8 val_q)\n{\n\tconst u8 th = 10;\n\n\tif ((abs(val_i_bs - val_i) < th) && (abs(val_q_bs - val_q) <= th)) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RX_DCK] offset check PASS!!\\n\");\n\t\treturn;\n\t}\n\n\tif (abs(val_i_bs - val_i) > th) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RX_DCK] val_i over TH (0x%x / 0x%x)\\n\", val_i_bs, val_i);\n\t\tval_i = val_i_bs;\n\t}\n\n\tif (abs(val_q_bs - val_q) > th) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RX_DCK] val_q over TH (0x%x / 0x%x)\\n\", val_q_bs, val_q);\n\t\tval_q = val_q_bs;\n\t}\n\n\t_rx_dck_value_rewrite(rtwdev, path, addr, val_i, val_q);\n}\n\nstatic void _rx_dck_recover(struct rtw89_dev *rtwdev, u8 path)\n{\n\tu8 i_even_bs, q_even_bs;\n\tu8 i_odd_bs, q_odd_bs;\n\tu8 i_even, q_even;\n\tu8 i_odd, q_odd;\n\tu8 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RX_DCK] ===> recovery\\n\");\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++) {\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_DCK, _dck_addr_bs[i]);\n\t\ti_even_bs = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_TIA);\n\t\tq_even_bs = rtw89_read_rf(rtwdev, path, RR_DCK1, RR_DCK1_TIA);\n\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_DCK, _dck_addr_bs[i] + 1);\n\t\ti_odd_bs = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_TIA);\n\t\tq_odd_bs = rtw89_read_rf(rtwdev, path, RR_DCK1, RR_DCK1_TIA);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RX_DCK] Gain[0x%x] i_even_bs/ q_even_bs = 0x%x/ 0x%x\\n\",\n\t\t\t    _dck_addr_bs[i], i_even_bs, q_even_bs);\n\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_DCK, _dck_addr[i]);\n\t\ti_even = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_TIA);\n\t\tq_even = rtw89_read_rf(rtwdev, path, RR_DCK1, RR_DCK1_TIA);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RX_DCK] Gain[0x%x] i_even/ q_even = 0x%x/ 0x%x\\n\",\n\t\t\t    _dck_addr[i], i_even, q_even);\n\t\t_rx_dck_fix_if_need(rtwdev, path, _dck_addr[i],\n\t\t\t\t    i_even_bs, q_even_bs, i_even, q_even);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RX_DCK] Gain[0x%x] i_odd_bs/ q_odd_bs = 0x%x/ 0x%x\\n\",\n\t\t\t    _dck_addr_bs[i] + 1, i_odd_bs, q_odd_bs);\n\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_DCK, _dck_addr[i] + 1);\n\t\ti_odd = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_TIA);\n\t\tq_odd = rtw89_read_rf(rtwdev, path, RR_DCK1, RR_DCK1_TIA);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RX_DCK] Gain[0x%x] i_odd/ q_odd = 0x%x/ 0x%x\\n\",\n\t\t\t    _dck_addr[i] + 1, i_odd, q_odd);\n\t\t_rx_dck_fix_if_need(rtwdev, path, _dck_addr[i] + 1,\n\t\t\t\t    i_odd_bs, q_odd_bs, i_odd, q_odd);\n\t}\n}\n\nstatic void _rx_dck_toggle(struct rtw89_dev *rtwdev, u8 path)\n{\n\tint ret;\n\tu32 val;\n\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x1);\n\n\tret = read_poll_timeout_atomic(rtw89_read_rf, val, val,\n\t\t\t\t       2, 2000, false, rtwdev, path,\n\t\t\t\t       RR_DCK1, RR_DCK1_DONE);\n\tif (ret)\n\t\trtw89_warn(rtwdev, \"[RX_DCK] S%d RXDCK timeout\\n\", path);\n\telse\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RX_DCK] S%d RXDCK finish\\n\", path);\n\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x0);\n}\n\nstatic void _set_rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy, u8 path,\n\t\t\tbool is_afe)\n{\n\tu8 res;\n\n\trtw89_write_rf(rtwdev, path, RR_DCK1, RR_DCK1_CLR, 0x0);\n\n\t_rx_dck_toggle(rtwdev, path);\n\tif (rtw89_read_rf(rtwdev, path, RR_DCKC, RR_DCKC_CHK) == 0)\n\t\treturn;\n\tres = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_DONE);\n\tif (res > 1) {\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB2, RR_RXBB2_IDAC, res);\n\t\t_rx_dck_toggle(rtwdev, path);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB2, RR_RXBB2_IDAC, 0x1);\n\t}\n}\n\nstatic\nu8 _rx_dck_channel_calc(struct rtw89_dev *rtwdev, const struct rtw89_chan *chan)\n{\n\tu8 target_ch = 0;\n\n\tif (chan->band_type == RTW89_BAND_5G) {\n\t\tif (chan->channel >= 36 && chan->channel <= 64) {\n\t\t\ttarget_ch = 100;\n\t\t} else if (chan->channel >= 100 && chan->channel <= 144) {\n\t\t\ttarget_ch = chan->channel + 32;\n\t\t\tif (target_ch > 144)\n\t\t\t\ttarget_ch = chan->channel + 33;\n\t\t} else if (chan->channel >= 149 && chan->channel <= 177) {\n\t\t\ttarget_ch = chan->channel - 33;\n\t\t}\n\t} else if (chan->band_type == RTW89_BAND_6G) {\n\t\tif (chan->channel >= 1 && chan->channel <= 125)\n\t\t\ttarget_ch = chan->channel + 32;\n\t\telse\n\t\t\ttarget_ch = chan->channel - 32;\n\t} else {\n\t\ttarget_ch = chan->channel;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RX_DCK] cur_ch / target_ch = %d / %d\\n\",\n\t\t    chan->channel, target_ch);\n\n\treturn target_ch;\n}\n\n#define RTW8852C_RF_REL_VERSION 34\n#define RTW8852C_DPK_VER 0xf\n#define RTW8852C_DPK_TH_AVG_NUM 4\n#define RTW8852C_DPK_RF_PATH 2\n#define RTW8852C_DPK_KIP_REG_NUM 7\n#define RTW8852C_DPK_RXSRAM_DBG 0\n\nenum rtw8852c_dpk_id {\n\tLBK_RXIQK\t= 0x06,\n\tSYNC\t\t= 0x10,\n\tMDPK_IDL\t= 0x11,\n\tMDPK_MPA\t= 0x12,\n\tGAIN_LOSS\t= 0x13,\n\tGAIN_CAL\t= 0x14,\n\tDPK_RXAGC\t= 0x15,\n\tKIP_PRESET\t= 0x16,\n\tKIP_RESTORE\t= 0x17,\n\tDPK_TXAGC\t= 0x19,\n\tD_KIP_PRESET\t= 0x28,\n\tD_TXAGC\t\t= 0x29,\n\tD_RXAGC\t\t= 0x2a,\n\tD_SYNC\t\t= 0x2b,\n\tD_GAIN_LOSS\t= 0x2c,\n\tD_MDPK_IDL\t= 0x2d,\n\tD_GAIN_NORM\t= 0x2f,\n\tD_KIP_THERMAL\t= 0x30,\n\tD_KIP_RESTORE\t= 0x31\n};\n\n#define DPK_TXAGC_LOWER 0x2e\n#define DPK_TXAGC_UPPER 0x3f\n#define DPK_TXAGC_INVAL 0xff\n\nenum dpk_agc_step {\n\tDPK_AGC_STEP_SYNC_DGAIN,\n\tDPK_AGC_STEP_GAIN_LOSS_IDX,\n\tDPK_AGC_STEP_GL_GT_CRITERION,\n\tDPK_AGC_STEP_GL_LT_CRITERION,\n\tDPK_AGC_STEP_SET_TX_GAIN,\n};\n\nenum dpk_pas_result {\n\tDPK_PAS_NOR,\n\tDPK_PAS_GT,\n\tDPK_PAS_LT,\n};\n\nstatic void _rf_direct_cntrl(struct rtw89_dev *rtwdev,\n\t\t\t     enum rtw89_rf_path path, bool is_bybb)\n{\n\tif (is_bybb)\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x1);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n}\n\nstatic void _dpk_onoff(struct rtw89_dev *rtwdev,\n\t\t       enum rtw89_rf_path path, bool off);\n\nstatic void _dpk_bkup_kip(struct rtw89_dev *rtwdev, const u32 reg[],\n\t\t\t  u32 reg_bkup[][RTW8852C_DPK_KIP_REG_NUM], u8 path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < RTW8852C_DPK_KIP_REG_NUM; i++) {\n\t\treg_bkup[path][i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, reg[i] + (path << 8), MASKDWORD);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Backup 0x%x = %x\\n\",\n\t\t\t    reg[i] + (path << 8), reg_bkup[path][i]);\n\t}\n}\n\nstatic void _dpk_reload_kip(struct rtw89_dev *rtwdev, const u32 reg[],\n\t\t\t    u32 reg_bkup[][RTW8852C_DPK_KIP_REG_NUM], u8 path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < RTW8852C_DPK_KIP_REG_NUM; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, reg[i] + (path << 8),\n\t\t\t\t       MASKDWORD, reg_bkup[path][i]);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Reload 0x%x = %x\\n\",\n\t\t\t    reg[i] + (path << 8), reg_bkup[path][i]);\n\t}\n}\n\nstatic u8 _dpk_one_shot(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\tenum rtw89_rf_path path, enum rtw8852c_dpk_id id)\n{\n\tu16 dpk_cmd;\n\tu32 val;\n\tint ret;\n\n\tdpk_cmd = (u16)((id << 8) | (0x19 + path * 0x12));\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD, dpk_cmd);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x55,\n\t\t\t\t       10, 20000, false, rtwdev, 0xbff8, MASKBYTE0);\n\tudelay(10);\n\trtw89_phy_write32_clr(rtwdev, R_NCTL_N1, MASKBYTE0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] one-shot for %s = 0x%x (ret=%d)\\n\",\n\t\t    id == 0x06 ? \"LBK_RXIQK\" :\n\t\t    id == 0x10 ? \"SYNC\" :\n\t\t    id == 0x11 ? \"MDPK_IDL\" :\n\t\t    id == 0x12 ? \"MDPK_MPA\" :\n\t\t    id == 0x13 ? \"GAIN_LOSS\" : \"PWR_CAL\",\n\t\t    dpk_cmd, ret);\n\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] one-shot over 20ms!!!!\\n\");\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n\nstatic void _dpk_information(struct rtw89_dev *rtwdev,\n\t\t\t     enum rtw89_phy_idx phy,\n\t\t\t     enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tu8 kidx = dpk->cur_idx[path];\n\n\tdpk->bp[path][kidx].band = chan->band_type;\n\tdpk->bp[path][kidx].ch = chan->channel;\n\tdpk->bp[path][kidx].bw = chan->band_width;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] S%d[%d] (PHY%d): TSSI %s/ DBCC %s/ %s/ CH%d/ %s\\n\",\n\t\t    path, dpk->cur_idx[path], phy,\n\t\t    rtwdev->is_tssi_mode[path] ? \"on\" : \"off\",\n\t\t    rtwdev->dbcc_en ? \"on\" : \"off\",\n\t\t    dpk->bp[path][kidx].band == 0 ? \"2G\" :\n\t\t    dpk->bp[path][kidx].band == 1 ? \"5G\" : \"6G\",\n\t\t    dpk->bp[path][kidx].ch,\n\t\t    dpk->bp[path][kidx].bw == 0 ? \"20M\" :\n\t\t    dpk->bp[path][kidx].bw == 1 ? \"40M\" : \"80M\");\n}\n\nstatic void _dpk_bb_afe_setting(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path, u8 kpath)\n{\n\t \n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A0 << path, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A1 << path, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A2 << path, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A3 << path, 0x0);\n\n\t \n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), MASKDWORD, 0xd801dffd);\n\n\t \n\trtw8852c_txck_force(rtwdev, path, true, DAC_960M);\n\n\t \n\trtw8852c_rxck_force(rtwdev, path, true, ADC_1920M);\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW + (path << 13),\n\t\t\t       B_P0_NRBW_DBG, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, MASKBYTE3, 0x1f);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, MASKBYTE3, 0x13);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, MASKHWORD, 0x0001);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, MASKHWORD, 0x0041);\n\n\t \n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A1 << path, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A3 << path, 0x1);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d BB/AFE setting\\n\", path);\n}\n\nstatic void _dpk_bb_afe_restore(struct rtw89_dev *rtwdev, u8 path)\n{\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW + (path << 13),\n\t\t\t       B_P0_NRBW_DBG, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A0 << path, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A1 << path, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A2 << path, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A3 << path, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), MASKDWORD, 0x00000000);\n\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK + (path << 13), B_P0_TXCK_ALL, 0x00);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A0 << path, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_A2 << path, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d BB/AFE restore\\n\", path);\n}\n\nstatic void _dpk_tssi_pause(struct rtw89_dev *rtwdev,\n\t\t\t    enum rtw89_rf_path path, bool is_pause)\n{\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK + (path << 13),\n\t\t\t       B_P0_TSSI_TRK_EN, is_pause);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d TSSI %s\\n\", path,\n\t\t    is_pause ? \"pause\" : \"resume\");\n}\n\nstatic void _dpk_kip_control_rfc(struct rtw89_dev *rtwdev, u8 path, bool ctrl_by_kip)\n{\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), B_IQK_RFC_ON, ctrl_by_kip);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] RFC is controlled by %s\\n\",\n\t\t    ctrl_by_kip ? \"KIP\" : \"BB\");\n}\n\nstatic void _dpk_txpwr_bb_force(struct rtw89_dev *rtwdev, u8 path, bool force)\n{\n\trtw89_phy_write32_mask(rtwdev, R_TXPWRB + (path << 13), B_TXPWRB_ON, force);\n\trtw89_phy_write32_mask(rtwdev, R_TXPWRB_H + (path << 13), B_TXPWRB_RDY, force);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,  \"[DPK] S%d txpwr_bb_force %s\\n\",\n\t\t    path, force ? \"on\" : \"off\");\n}\n\nstatic void _dpk_kip_restore(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t     enum rtw89_rf_path path)\n{\n\t_dpk_one_shot(rtwdev, phy, path, D_KIP_RESTORE);\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\t_dpk_txpwr_bb_force(rtwdev, path, false);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d restore KIP\\n\", path);\n}\n\nstatic void _dpk_lbk_rxiqk(struct rtw89_dev *rtwdev,\n\t\t\t   enum rtw89_phy_idx phy,\n\t\t\t   enum rtw89_rf_path path)\n{\n#define RX_TONE_IDX 0x00250025  \n\tu8 cur_rxbb;\n\tu32 rf_11, reg_81cc;\n\n\trtw89_phy_write32_mask(rtwdev, R_DPD_V1 + (path << 8), B_DPD_LBK, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_MDPK_RX_DCK, B_MDPK_RX_DCK_EN, 0x1);\n\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\n\tcur_rxbb = rtw89_read_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXBB);\n\trf_11 = rtw89_read_rf(rtwdev, path, RR_TXIG, RFREG_MASK);\n\treg_81cc = rtw89_phy_read32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t\t B_KIP_IQP_SW);\n\n\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, 0x3);\n\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0xd);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXBB, 0x1f);\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), B_KIP_IQP_IQSW, 0x12);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), B_KIP_IQP_SW, 0x3);\n\n\t_dpk_kip_control_rfc(rtwdev, path, true);\n\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, MASKDWORD, RX_TONE_IDX);\n\n\t_dpk_one_shot(rtwdev, phy, path, LBK_RXIQK);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d LBK RXIQC = 0x%x\\n\", path,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD));\n\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\n\trtw89_write_rf(rtwdev, path, RR_TXIG, RFREG_MASK, rf_11);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXBB, cur_rxbb);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), B_KIP_IQP_SW, reg_81cc);\n\n\trtw89_phy_write32_mask(rtwdev, R_MDPK_RX_DCK, B_MDPK_RX_DCK_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_KPATH_CFG, B_KPATH_CFG_ED, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_DI, 0x1);\n\n\t_dpk_kip_control_rfc(rtwdev, path, true);\n}\n\nstatic void _dpk_rf_setting(struct rtw89_dev *rtwdev, u8 gain,\n\t\t\t    enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tif (dpk->bp[path][kidx].band == RTW89_BAND_2G) {\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK,\n\t\t\t       0x50121 | BIT(rtwdev->dbcc_en));\n\t\trtw89_write_rf(rtwdev, path, RR_MOD_V1, RR_MOD_MASK, RF_DPK);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_ATTC, 0x2);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_ATTR, 0x4);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTDBG, RR_LUTDBG_TIA, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TIA, RR_TIA_N6, 0x1);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] RF 0x0/0x83/0x9e/0x1a/0xdf/0x1001a = 0x%x/ 0x%x/ 0x%x/ 0x%x/ 0x%x/ 0x%x\\n\",\n\t\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK),\n\t\t\t    rtw89_read_rf(rtwdev, path, RR_RXBB, RFREG_MASK),\n\t\t\t    rtw89_read_rf(rtwdev, path, RR_TIA, RFREG_MASK),\n\t\t\t    rtw89_read_rf(rtwdev, path, RR_BTC, RFREG_MASK),\n\t\t\t    rtw89_read_rf(rtwdev, path, RR_LUTDBG, RFREG_MASK),\n\t\t\t    rtw89_read_rf(rtwdev, path, 0x1001a, RFREG_MASK));\n\t} else {\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK,\n\t\t\t       0x50101 | BIT(rtwdev->dbcc_en));\n\t\trtw89_write_rf(rtwdev, path, RR_MOD_V1, RR_MOD_MASK, RF_DPK);\n\n\t\tif (dpk->bp[path][kidx].band == RTW89_BAND_6G && dpk->bp[path][kidx].ch >= 161)\n\t\t\trtw89_write_rf(rtwdev, path, RR_IQGEN, RR_IQGEN_BIAS, 0x8);\n\n\t\trtw89_write_rf(rtwdev, path, RR_LOGEN, RR_LOGEN_RPT, 0xd);\n\t\trtw89_write_rf(rtwdev, path, RR_TXAC, RR_TXAC_IQG, 0x8);\n\n\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_ATT, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIQK, RR_TXIQK_ATT2, 0x3);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTDBG, RR_LUTDBG_TIA, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TIA, RR_TIA_N6, 0x1);\n\n\t\tif (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_160)\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXBB2, RR_RXBB2_EBW, 0x0);\n\t}\n}\n\nstatic void _dpk_tpg_sel(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tif (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_160) {\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_SEL, MASKDWORD, 0x0180ff30);\n\t} else if (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_80) {\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_SEL, MASKDWORD, 0xffe0fa00);\n\t} else if (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_40) {\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_SEL, MASKDWORD, 0xff4009e0);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_SEL, MASKDWORD, 0xf9f007d0);\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] TPG_Select for %s\\n\",\n\t\t    dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_160 ? \"160M\" :\n\t\t    dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_80 ? \"80M\" :\n\t\t    dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_40 ? \"40M\" : \"20M\");\n}\n\nstatic bool _dpk_sync_check(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 kidx)\n{\n#define DPK_SYNC_TH_DC_I 200\n#define DPK_SYNC_TH_DC_Q 200\n#define DPK_SYNC_TH_CORR 170\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu16 dc_i, dc_q;\n\tu8 corr_val, corr_idx, rxbb;\n\tu8 rxbb_ov;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x0);\n\n\tcorr_idx = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_CORI);\n\tcorr_val = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_CORV);\n\n\tdpk->corr_idx[path][kidx] = corr_idx;\n\tdpk->corr_val[path][kidx] = corr_val;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x9);\n\n\tdc_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCI);\n\tdc_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCQ);\n\n\tdc_i = abs(sign_extend32(dc_i, 11));\n\tdc_q = abs(sign_extend32(dc_q, 11));\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] S%d Corr_idx/ Corr_val /DC I/Q, = %d / %d / %d / %d\\n\",\n\t\t    path, corr_idx, corr_val, dc_i, dc_q);\n\n\tdpk->dc_i[path][kidx] = dc_i;\n\tdpk->dc_q[path][kidx] = dc_q;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x8);\n\trxbb = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_RXBB);\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x31);\n\trxbb_ov = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_RXOV);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] S%d RXBB/ RXAGC_done /RXBB_ovlmt = %d / %d / %d\\n\",\n\t\t    path, rxbb,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DONE),\n\t\t    rxbb_ov);\n\n\tif (dc_i > DPK_SYNC_TH_DC_I || dc_q > DPK_SYNC_TH_DC_Q ||\n\t    corr_val < DPK_SYNC_TH_CORR)\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\nstatic u16 _dpk_dgain_read(struct rtw89_dev *rtwdev)\n{\n\tu16 dgain = 0x0;\n\n\trtw89_phy_write32_clr(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL);\n\n\tdgain = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCI);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] DGain = 0x%x (%d)\\n\", dgain, dgain);\n\n\treturn dgain;\n}\n\nstatic u8 _dpk_gainloss_read(struct rtw89_dev *rtwdev)\n{\n\tu8 result;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x6);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG2, B_DPK_CFG2_ST, 0x1);\n\n\tresult = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_GL);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] tmp GL = %d\\n\", result);\n\n\treturn result;\n}\n\nstatic void _dpk_kset_query(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT + (path << 8), B_KIP_RPT_SEL, 0x10);\n\tdpk->cur_k_set =\n\t\trtw89_phy_read32_mask(rtwdev, R_RPT_PER + (path << 8), 0xE0000000) - 1;\n}\n\nstatic void _dpk_kip_set_txagc(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t       enum rtw89_rf_path path, u8 dbm, bool set_from_bb)\n{\n\tif (set_from_bb) {\n\t\tdbm = clamp_t(u8, dbm, 7, 24);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] set S%d txagc to %ddBm\\n\", path, dbm);\n\t\trtw89_phy_write32_mask(rtwdev, R_TXPWRB + (path << 13), B_TXPWRB_VAL, dbm << 2);\n\t}\n\t_dpk_one_shot(rtwdev, phy, path, D_TXAGC);\n\t_dpk_kset_query(rtwdev, path);\n}\n\nstatic u8 _dpk_gainloss(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\tenum rtw89_rf_path path, u8 kidx)\n{\n\t_dpk_one_shot(rtwdev, phy, path, D_GAIN_LOSS);\n\t_dpk_kip_set_txagc(rtwdev, phy, path, 0xff, false);\n\n\trtw89_phy_write32_mask(rtwdev, R_DPK_GL + (path << 8), B_DPK_GL_A1, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_GL + (path << 8), B_DPK_GL_A0, 0x0);\n\n\treturn _dpk_gainloss_read(rtwdev);\n}\n\nstatic enum dpk_pas_result _dpk_pas_read(struct rtw89_dev *rtwdev, bool is_check)\n{\n\tu32 val1_i = 0, val1_q = 0, val2_i = 0, val2_q = 0;\n\tu32 val1_sqrt_sum, val2_sqrt_sum;\n\tu8 i;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKBYTE2, 0x06);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG2, B_DPK_CFG2_ST, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE2, 0x08);\n\n\tif (is_check) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, 0x00);\n\t\tval1_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKHWORD);\n\t\tval1_i = abs(sign_extend32(val1_i, 11));\n\t\tval1_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKLWORD);\n\t\tval1_q = abs(sign_extend32(val1_q, 11));\n\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, 0x1f);\n\t\tval2_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKHWORD);\n\t\tval2_i = abs(sign_extend32(val2_i, 11));\n\t\tval2_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKLWORD);\n\t\tval2_q = abs(sign_extend32(val2_q, 11));\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] PAS_delta = 0x%x\\n\",\n\t\t\t    phy_div(val1_i * val1_i + val1_q * val1_q,\n\t\t\t\t    val2_i * val2_i + val2_q * val2_q));\n\t} else {\n\t\tfor (i = 0; i < 32; i++) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, i);\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] PAS_Read[%02d]= 0x%08x\\n\", i,\n\t\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD));\n\t\t}\n\t}\n\n\tval1_sqrt_sum = val1_i * val1_i + val1_q * val1_q;\n\tval2_sqrt_sum = val2_i * val2_i + val2_q * val2_q;\n\n\tif (val1_sqrt_sum < val2_sqrt_sum)\n\t\treturn DPK_PAS_LT;\n\telse if (val1_sqrt_sum >= val2_sqrt_sum * 8 / 5)\n\t\treturn DPK_PAS_GT;\n\telse\n\t\treturn DPK_PAS_NOR;\n}\n\nstatic bool _dpk_kip_set_rxagc(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t       enum rtw89_rf_path path, u8 kidx)\n{\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_MOD, B_KIP_MOD,\n\t\t\t       rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK));\n\t_dpk_kip_control_rfc(rtwdev, path, true);\n\n\t_dpk_one_shot(rtwdev, phy, path, D_RXAGC);\n\n\treturn _dpk_sync_check(rtwdev, path, kidx);\n}\n\nstatic void _dpk_read_rxsram(struct rtw89_dev *rtwdev)\n{\n\tu32 addr;\n\n\trtw89_rfk_parser(rtwdev, &rtw8852c_read_rxsram_pre_defs_tbl);\n\n\tfor (addr = 0; addr < 0x200; addr++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX, MASKDWORD, 0x00010000 | addr);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] RXSRAM[%03d] = 0x%07x\\n\", addr,\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD));\n\t}\n\n\trtw89_rfk_parser(rtwdev, &rtw8852c_read_rxsram_post_defs_tbl);\n}\n\nstatic void _dpk_bypass_rxiqc(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\trtw89_phy_write32_mask(rtwdev, R_DPD_V1 + (path << 8), B_DPD_LBK, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD, 0x40000002);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Bypass RXIQC\\n\");\n}\n\nstatic u8 _dpk_agc(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t   enum rtw89_rf_path path, u8 kidx, u8 init_xdbm, u8 loss_only)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 step = DPK_AGC_STEP_SYNC_DGAIN;\n\tu8 tmp_dbm = init_xdbm, tmp_gl_idx = 0;\n\tu8 tmp_rxbb;\n\tu8 goout = 0, agc_cnt = 0;\n\tenum dpk_pas_result pas;\n\tu16 dgain = 0;\n\tbool is_fail = false;\n\tint limit = 200;\n\n\tdo {\n\t\tswitch (step) {\n\t\tcase DPK_AGC_STEP_SYNC_DGAIN:\n\t\t\tis_fail = _dpk_kip_set_rxagc(rtwdev, phy, path, kidx);\n\n\t\t\tif (RTW8852C_DPK_RXSRAM_DBG)\n\t\t\t\t_dpk_read_rxsram(rtwdev);\n\n\t\t\tif (is_fail) {\n\t\t\t\tgoout = 1;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tdgain = _dpk_dgain_read(rtwdev);\n\n\t\t\tif (dgain > 0x5fc || dgain < 0x556) {\n\t\t\t\t_dpk_one_shot(rtwdev, phy, path, D_SYNC);\n\t\t\t\tdgain = _dpk_dgain_read(rtwdev);\n\t\t\t}\n\n\t\t\tif (agc_cnt == 0) {\n\t\t\t\tif (dpk->bp[path][kidx].band == RTW89_BAND_2G)\n\t\t\t\t\t_dpk_bypass_rxiqc(rtwdev, path);\n\t\t\t\telse\n\t\t\t\t\t_dpk_lbk_rxiqk(rtwdev, phy, path);\n\t\t\t}\n\t\t\tstep = DPK_AGC_STEP_GAIN_LOSS_IDX;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GAIN_LOSS_IDX:\n\t\t\ttmp_gl_idx = _dpk_gainloss(rtwdev, phy, path, kidx);\n\t\t\tpas = _dpk_pas_read(rtwdev, true);\n\n\t\t\tif (pas == DPK_PAS_LT && tmp_gl_idx > 0)\n\t\t\t\tstep = DPK_AGC_STEP_GL_LT_CRITERION;\n\t\t\telse if (pas == DPK_PAS_GT && tmp_gl_idx == 0)\n\t\t\t\tstep = DPK_AGC_STEP_GL_GT_CRITERION;\n\t\t\telse if (tmp_gl_idx >= 7)\n\t\t\t\tstep = DPK_AGC_STEP_GL_GT_CRITERION;\n\t\t\telse if (tmp_gl_idx == 0)\n\t\t\t\tstep = DPK_AGC_STEP_GL_LT_CRITERION;\n\t\t\telse\n\t\t\t\tstep = DPK_AGC_STEP_SET_TX_GAIN;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GL_GT_CRITERION:\n\t\t\tif (tmp_dbm <= 7) {\n\t\t\t\tgoout = 1;\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Txagc@lower bound!!\\n\");\n\t\t\t} else {\n\t\t\t\ttmp_dbm = max_t(u8, tmp_dbm - 3, 7);\n\t\t\t\t_dpk_kip_set_txagc(rtwdev, phy, path, tmp_dbm, true);\n\t\t\t}\n\t\t\tstep = DPK_AGC_STEP_SYNC_DGAIN;\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GL_LT_CRITERION:\n\t\t\tif (tmp_dbm >= 24) {\n\t\t\t\tgoout = 1;\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Txagc@upper bound!!\\n\");\n\t\t\t} else {\n\t\t\t\ttmp_dbm = min_t(u8, tmp_dbm + 2, 24);\n\t\t\t\t_dpk_kip_set_txagc(rtwdev, phy, path, tmp_dbm, true);\n\t\t\t}\n\t\t\tstep = DPK_AGC_STEP_SYNC_DGAIN;\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_SET_TX_GAIN:\n\t\t\t_dpk_kip_control_rfc(rtwdev, path, false);\n\t\t\ttmp_rxbb = rtw89_read_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXBB);\n\t\t\tif (tmp_rxbb + tmp_gl_idx > 0x1f)\n\t\t\t\ttmp_rxbb = 0x1f;\n\t\t\telse\n\t\t\t\ttmp_rxbb = tmp_rxbb + tmp_gl_idx;\n\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXBB, tmp_rxbb);\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Adjust RXBB (%+d) = 0x%x\\n\",\n\t\t\t\t    tmp_gl_idx, tmp_rxbb);\n\t\t\t_dpk_kip_control_rfc(rtwdev, path, true);\n\t\t\tgoout = 1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tgoout = 1;\n\t\t\tbreak;\n\t\t}\n\t} while (!goout && agc_cnt < 6 && --limit > 0);\n\n\tif (limit <= 0)\n\t\trtw89_warn(rtwdev, \"[DPK] exceed loop limit\\n\");\n\n\treturn is_fail;\n}\n\nstatic void _dpk_set_mdpd_para(struct rtw89_dev *rtwdev, u8 order)\n{\n\tstatic const struct rtw89_rfk_tbl *order_tbls[] = {\n\t\t&rtw8852c_dpk_mdpd_order0_defs_tbl,\n\t\t&rtw8852c_dpk_mdpd_order1_defs_tbl,\n\t\t&rtw8852c_dpk_mdpd_order2_defs_tbl,\n\t\t&rtw8852c_dpk_mdpd_order3_defs_tbl,\n\t};\n\n\tif (order >= ARRAY_SIZE(order_tbls)) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Wrong MDPD order!!(0x%x)\\n\", order);\n\t\treturn;\n\t}\n\n\trtw89_rfk_parser(rtwdev, order_tbls[order]);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Set %s for IDL\\n\",\n\t\t    order == 0x0 ? \"(5,3,1)\" :\n\t\t    order == 0x1 ? \"(5,3,0)\" :\n\t\t    order == 0x2 ? \"(5,0,0)\" : \"(7,3,1)\");\n}\n\nstatic void _dpk_idl_mpa(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 cnt;\n\tu8 ov_flag;\n\tu32 dpk_sync;\n\n\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_MA, 0x1);\n\n\tif (rtw89_phy_read32_mask(rtwdev, R_DPK_MPA, B_DPK_MPA_T2) == 0x1)\n\t\t_dpk_set_mdpd_para(rtwdev, 0x2);\n\telse if (rtw89_phy_read32_mask(rtwdev, R_DPK_MPA, B_DPK_MPA_T1) == 0x1)\n\t\t_dpk_set_mdpd_para(rtwdev, 0x1);\n\telse if (rtw89_phy_read32_mask(rtwdev, R_DPK_MPA, B_DPK_MPA_T0) == 0x1)\n\t\t_dpk_set_mdpd_para(rtwdev, 0x0);\n\telse if (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_5 ||\n\t\t dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_10 ||\n\t\t dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_20)\n\t\t_dpk_set_mdpd_para(rtwdev, 0x2);\n\telse if (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_40 ||\n\t\t dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_80)\n\t\t_dpk_set_mdpd_para(rtwdev, 0x1);\n\telse\n\t\t_dpk_set_mdpd_para(rtwdev, 0x0);\n\n\trtw89_phy_write32_mask(rtwdev, R_DPK_IDL, B_DPK_IDL, 0x0);\n\tfsleep(1000);\n\n\t_dpk_one_shot(rtwdev, phy, path, D_MDPK_IDL);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x0);\n\tdpk_sync = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] dpk_sync = 0x%x\\n\", dpk_sync);\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0xf);\n\tov_flag = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_SYNERR);\n\tfor (cnt = 0; cnt < 5 && ov_flag == 0x1; cnt++) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] ReK due to MDPK ov!!!\\n\");\n\t\t_dpk_one_shot(rtwdev, phy, path, D_MDPK_IDL);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0xf);\n\t\tov_flag = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_SYNERR);\n\t}\n\n\tif (ov_flag) {\n\t\t_dpk_set_mdpd_para(rtwdev, 0x2);\n\t\t_dpk_one_shot(rtwdev, phy, path, D_MDPK_IDL);\n\t}\n}\n\nstatic bool _dpk_reload_check(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t      enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tbool is_reload = false;\n\tu8 idx, cur_band, cur_ch;\n\n\tcur_band = chan->band_type;\n\tcur_ch = chan->channel;\n\n\tfor (idx = 0; idx < RTW89_DPK_BKUP_NUM; idx++) {\n\t\tif (cur_band != dpk->bp[path][idx].band ||\n\t\t    cur_ch != dpk->bp[path][idx].ch)\n\t\t\tcontinue;\n\n\t\trtw89_phy_write32_mask(rtwdev, R_COEF_SEL + (path << 8),\n\t\t\t\t       B_COEF_SEL_MDPD, idx);\n\t\tdpk->cur_idx[path] = idx;\n\t\tis_reload = true;\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] reload S%d[%d] success\\n\", path, idx);\n\t}\n\n\treturn is_reload;\n}\n\nstatic void _dpk_kip_pwr_clk_onoff(struct rtw89_dev *rtwdev, bool turn_on)\n{\n\trtw89_rfk_parser(rtwdev, turn_on ? &rtw8852c_dpk_kip_pwr_clk_on_defs_tbl :\n\t\t\t\t\t   &rtw8852c_dpk_kip_pwr_clk_off_defs_tbl);\n}\n\nstatic void _dpk_kip_preset_8852c(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t  enum rtw89_rf_path path, u8 kidx)\n{\n\trtw89_phy_write32_mask(rtwdev, R_KIP_MOD, B_KIP_MOD,\n\t\t\t       rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK));\n\n\tif (rtwdev->hal.cv == CHIP_CAV)\n\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t       R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t\t       B_DPD_SEL, 0x01);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t       R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t\t       B_DPD_SEL, 0x0c);\n\n\t_dpk_kip_control_rfc(rtwdev, path, true);\n\trtw89_phy_write32_mask(rtwdev, R_COEF_SEL + (path << 8), B_COEF_SEL_MDPD, kidx);\n\n\t_dpk_one_shot(rtwdev, phy, path, D_KIP_PRESET);\n}\n\nstatic void _dpk_para_query(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 kidx)\n{\n#define _DPK_PARA_TXAGC GENMASK(15, 10)\n#define _DPK_PARA_THER GENMASK(31, 26)\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu32 para;\n\n\tpara = rtw89_phy_read32_mask(rtwdev, dpk_par_regs[kidx][dpk->cur_k_set] + (path << 8),\n\t\t\t\t     MASKDWORD);\n\n\tdpk->bp[path][kidx].txagc_dpk = FIELD_GET(_DPK_PARA_TXAGC, para);\n\tdpk->bp[path][kidx].ther_dpk = FIELD_GET(_DPK_PARA_THER, para);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] thermal/ txagc_RF (K%d) = 0x%x/ 0x%x\\n\",\n\t\t    dpk->cur_k_set, dpk->bp[path][kidx].ther_dpk, dpk->bp[path][kidx].txagc_dpk);\n}\n\nstatic void _dpk_gain_normalize_8852c(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t      enum rtw89_rf_path path, u8 kidx, bool is_execute)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tif (is_execute) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_GN + (path << 8), B_DPK_GN_AG, 0x200);\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_GN + (path << 8), B_DPK_GN_EN, 0x3);\n\n\t\t_dpk_one_shot(rtwdev, phy, path, D_GAIN_NORM);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, dpk_par_regs[kidx][dpk->cur_k_set] + (path << 8),\n\t\t\t\t       0x0000007F, 0x5b);\n\t}\n\tdpk->bp[path][kidx].gs =\n\t\trtw89_phy_read32_mask(rtwdev, dpk_par_regs[kidx][dpk->cur_k_set] + (path << 8),\n\t\t\t\t      0x0000007F);\n}\n\nstatic u8 _dpk_order_convert(struct rtw89_dev *rtwdev)\n{\n\tu32 val32 = rtw89_phy_read32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP);\n\tu8 val;\n\n\tswitch (val32) {\n\tcase 0:\n\t\tval = 0x6;\n\t\tbreak;\n\tcase 1:\n\t\tval = 0x2;\n\t\tbreak;\n\tcase 2:\n\t\tval = 0x0;\n\t\tbreak;\n\tcase 3:\n\t\tval = 0x7;\n\t\tbreak;\n\tdefault:\n\t\tval = 0xff;\n\t\tbreak;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] convert MDPD order to 0x%x\\n\", val);\n\n\treturn val;\n}\n\nstatic void _dpk_on(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t    enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_MDPD, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_MDPD, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       B_DPD_ORDER, _dpk_order_convert(rtwdev));\n\n\tdpk->bp[path][kidx].mdpd_en = BIT(dpk->cur_k_set);\n\tdpk->bp[path][kidx].path_ok = true;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d[%d] path_ok = 0x%x\\n\",\n\t\t    path, kidx, dpk->bp[path][kidx].mdpd_en);\n\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       B_DPD_MEN, dpk->bp[path][kidx].mdpd_en);\n\n\t_dpk_gain_normalize_8852c(rtwdev, phy, path, kidx, false);\n}\n\nstatic bool _dpk_main(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t      enum rtw89_rf_path path, u8 gain)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 kidx = dpk->cur_idx[path];\n\tu8 init_xdbm = 15;\n\tbool is_fail;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] ========= S%d[%d] DPK Start =========\\n\", path, kidx);\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\t_rf_direct_cntrl(rtwdev, path, false);\n\trtw89_write_rf(rtwdev, path, RR_BBDC, RFREG_MASK, 0x03ffd);\n\t_dpk_rf_setting(rtwdev, gain, path, kidx);\n\t_set_rx_dck(rtwdev, phy, path, false);\n\t_dpk_kip_pwr_clk_onoff(rtwdev, true);\n\t_dpk_kip_preset_8852c(rtwdev, phy, path, kidx);\n\t_dpk_txpwr_bb_force(rtwdev, path, true);\n\t_dpk_kip_set_txagc(rtwdev, phy, path, init_xdbm, true);\n\t_dpk_tpg_sel(rtwdev, path, kidx);\n\n\tis_fail = _dpk_agc(rtwdev, phy, path, kidx, init_xdbm, false);\n\tif (is_fail)\n\t\tgoto _error;\n\n\t_dpk_idl_mpa(rtwdev, phy, path, kidx);\n\t_dpk_para_query(rtwdev, path, kidx);\n\t_dpk_on(rtwdev, phy, path, kidx);\n\n_error:\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RF_RX);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d[%d]_K%d %s\\n\", path, kidx,\n\t\t    dpk->cur_k_set, is_fail ? \"need Check\" : \"is Success\");\n\n\treturn is_fail;\n}\n\nstatic void _dpk_init(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 kidx = dpk->cur_idx[path];\n\n\tdpk->bp[path][kidx].path_ok = false;\n}\n\nstatic void _dpk_drf_direct_cntrl(struct rtw89_dev *rtwdev, u8 path, bool is_bybb)\n{\n\tif (is_bybb)\n\t\trtw89_write_rf(rtwdev,  path, RR_BBDC, RR_BBDC_SEL, 0x1);\n\telse\n\t\trtw89_write_rf(rtwdev,  path, RR_BBDC, RR_BBDC_SEL, 0x0);\n}\n\nstatic void _dpk_cal_select(struct rtw89_dev *rtwdev, bool force,\n\t\t\t    enum rtw89_phy_idx phy, u8 kpath)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tstatic const u32 kip_reg[] = {0x813c, 0x8124, 0x8120, 0xc0c4, 0xc0e8, 0xc0d4, 0xc0d8};\n\tu32 backup_rf_val[RTW8852C_DPK_RF_PATH][BACKUP_RF_REGS_NR];\n\tu32 kip_bkup[RTW8852C_DPK_RF_PATH][RTW8852C_DPK_KIP_REG_NUM] = {};\n\tu8 path;\n\tbool is_fail = true, reloaded[RTW8852C_DPK_RF_PATH] = {false};\n\n\tstatic_assert(ARRAY_SIZE(kip_reg) == RTW8852C_DPK_KIP_REG_NUM);\n\n\tif (dpk->is_dpk_reload_en) {\n\t\tfor (path = 0; path < RTW8852C_DPK_RF_PATH; path++) {\n\t\t\tif (!(kpath & BIT(path)))\n\t\t\t\tcontinue;\n\n\t\t\treloaded[path] = _dpk_reload_check(rtwdev, phy, path);\n\t\t\tif (!reloaded[path] && dpk->bp[path][0].ch != 0)\n\t\t\t\tdpk->cur_idx[path] = !dpk->cur_idx[path];\n\t\t\telse\n\t\t\t\t_dpk_onoff(rtwdev, path, false);\n\t\t}\n\t} else {\n\t\tfor (path = 0; path < RTW8852C_DPK_RF_PATH; path++)\n\t\t\tdpk->cur_idx[path] = 0;\n\t}\n\n\tfor (path = 0; path < RTW8852C_DPK_RF_PATH; path++) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] ========= S%d[%d] DPK Init =========\\n\",\n\t\t\t    path, dpk->cur_idx[path]);\n\t\t_dpk_bkup_kip(rtwdev, kip_reg, kip_bkup, path);\n\t\t_rfk_backup_rf_reg(rtwdev, backup_rf_val[path], path);\n\t\t_dpk_information(rtwdev, phy, path);\n\t\t_dpk_init(rtwdev, path);\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\t_dpk_tssi_pause(rtwdev, path, true);\n\t}\n\n\tfor (path = 0; path < RTW8852C_DPK_RF_PATH; path++) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] ========= S%d[%d] DPK Start =========\\n\",\n\t\t\t    path, dpk->cur_idx[path]);\n\t\trtw8852c_disable_rxagc(rtwdev, path, 0x0);\n\t\t_dpk_drf_direct_cntrl(rtwdev, path, false);\n\t\t_dpk_bb_afe_setting(rtwdev, phy, path, kpath);\n\t\tis_fail = _dpk_main(rtwdev, phy, path, 1);\n\t\t_dpk_onoff(rtwdev, path, is_fail);\n\t}\n\n\tfor (path = 0; path < RTW8852C_DPK_RF_PATH; path++) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] ========= S%d[%d] DPK Restore =========\\n\",\n\t\t\t    path, dpk->cur_idx[path]);\n\t\t_dpk_kip_restore(rtwdev, phy, path);\n\t\t_dpk_reload_kip(rtwdev, kip_reg, kip_bkup, path);\n\t\t_rfk_restore_rf_reg(rtwdev, backup_rf_val[path], path);\n\t\t_dpk_bb_afe_restore(rtwdev, path);\n\t\trtw8852c_disable_rxagc(rtwdev, path, 0x1);\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\t_dpk_tssi_pause(rtwdev, path, false);\n\t}\n\n\t_dpk_kip_pwr_clk_onoff(rtwdev, false);\n}\n\nstatic bool _dpk_bypass_check(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tstruct rtw89_fem_info *fem = &rtwdev->fem;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 band = chan->band_type;\n\n\tif (rtwdev->hal.cv == CHIP_CAV && band != RTW89_BAND_2G) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Skip DPK due to CAV & not 2G!!\\n\");\n\t\treturn true;\n\t} else if (fem->epa_2g && band == RTW89_BAND_2G) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Skip DPK due to 2G_ext_PA exist!!\\n\");\n\t\treturn true;\n\t} else if (fem->epa_5g && band == RTW89_BAND_5G) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Skip DPK due to 5G_ext_PA exist!!\\n\");\n\t\treturn true;\n\t} else if (fem->epa_6g && band == RTW89_BAND_6G) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Skip DPK due to 6G_ext_PA exist!!\\n\");\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic void _dpk_force_bypass(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tu8 path, kpath;\n\n\tkpath = _kpath(rtwdev, phy);\n\n\tfor (path = 0; path < RTW8852C_DPK_RF_PATH; path++) {\n\t\tif (kpath & BIT(path))\n\t\t\t_dpk_onoff(rtwdev, path, true);\n\t}\n}\n\nstatic void _dpk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy, bool force)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] ****** DPK Start (Ver: 0x%x, Cv: %d, RF_para: %d) ******\\n\",\n\t\t    RTW8852C_DPK_VER, rtwdev->hal.cv,\n\t\t    RTW8852C_RF_REL_VERSION);\n\n\tif (_dpk_bypass_check(rtwdev, phy))\n\t\t_dpk_force_bypass(rtwdev, phy);\n\telse\n\t\t_dpk_cal_select(rtwdev, force, phy, _kpath(rtwdev, phy));\n\n\tif (rtw89_read_rf(rtwdev, RF_PATH_A, RR_DCKC, RR_DCKC_CHK) == 0x1)\n\t\trtw8852c_rx_dck(rtwdev, phy, false);\n}\n\nstatic void _dpk_onoff(struct rtw89_dev *rtwdev,\n\t\t       enum rtw89_rf_path path, bool off)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 val, kidx = dpk->cur_idx[path];\n\n\tval = dpk->is_dpk_enable && !off && dpk->bp[path][kidx].path_ok ?\n\t      dpk->bp[path][kidx].mdpd_en : 0;\n\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       B_DPD_MEN, val);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d[%d] DPK %s !!!\\n\", path,\n\t\t    kidx, dpk->is_dpk_enable && !off ? \"enable\" : \"disable\");\n}\n\nstatic void _dpk_track(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 path, kidx;\n\tu8 txagc_rf = 0;\n\ts8 txagc_bb = 0, txagc_bb_tp = 0, txagc_ofst = 0;\n\tu8 cur_ther;\n\ts8 delta_ther = 0;\n\ts16 pwsf_tssi_ofst;\n\n\tfor (path = 0; path < RTW8852C_DPK_RF_PATH; path++) {\n\t\tkidx = dpk->cur_idx[path];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] ================[S%d[%d] (CH %d)]================\\n\",\n\t\t\t    path, kidx, dpk->bp[path][kidx].ch);\n\n\t\ttxagc_rf =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BB + (path << 13), 0x0000003f);\n\t\ttxagc_bb =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BB + (path << 13), MASKBYTE2);\n\t\ttxagc_bb_tp =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BTP + (path << 13), B_TXAGC_BTP);\n\n\t\t \n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT + (path << 8), B_KIP_RPT_SEL, 0xf);\n\t\tcur_ther =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_RPT_PER + (path << 8), B_RPT_PER_TH);\n\t\ttxagc_ofst =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_RPT_PER + (path << 8), B_RPT_PER_OF);\n\t\tpwsf_tssi_ofst =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_RPT_PER + (path << 8), B_RPT_PER_TSSI);\n\t\tpwsf_tssi_ofst = sign_extend32(pwsf_tssi_ofst, 12);\n\n\t\tcur_ther = ewma_thermal_read(&rtwdev->phystat.avg_thermal[path]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] thermal now = %d\\n\", cur_ther);\n\n\t\tif (dpk->bp[path][kidx].ch != 0 && cur_ther != 0)\n\t\t\tdelta_ther = dpk->bp[path][kidx].ther_dpk - cur_ther;\n\n\t\tdelta_ther = delta_ther * 1 / 2;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] extra delta_ther = %d (0x%x / 0x%x@k)\\n\",\n\t\t\t    delta_ther, cur_ther, dpk->bp[path][kidx].ther_dpk);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] delta_txagc = %d (0x%x / 0x%x@k)\\n\",\n\t\t\t    txagc_rf - dpk->bp[path][kidx].txagc_dpk, txagc_rf,\n\t\t\t    dpk->bp[path][kidx].txagc_dpk);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] txagc_offset / pwsf_tssi_ofst = 0x%x / %+d\\n\",\n\t\t\t    txagc_ofst, pwsf_tssi_ofst);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] txagc_bb_tp / txagc_bb = 0x%x / 0x%x\\n\",\n\t\t\t    txagc_bb_tp, txagc_bb);\n\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_DPK_WR, B_DPK_WR_ST) == 0x0 &&\n\t\t    txagc_rf != 0 && rtwdev->hal.cv == CHIP_CAV) {\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t    \"[DPK_TRK] New pwsf = 0x%x\\n\", 0x78 - delta_ther);\n\n\t\t\trtw89_phy_write32_mask(rtwdev, R_DPD_BND + (path << 8) + (kidx << 2),\n\t\t\t\t\t       0x07FC0000, 0x78 - delta_ther);\n\t\t}\n\t}\n}\n\nstatic void _tssi_set_sys(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\trtw89_rfk_parser(rtwdev, &rtw8852c_tssi_sys_defs_tbl);\n\n\tif (path == RF_PATH_A)\n\t\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t\t &rtw8852c_tssi_sys_defs_2g_a_tbl,\n\t\t\t\t\t &rtw8852c_tssi_sys_defs_5g_a_tbl);\n\telse\n\t\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t\t &rtw8852c_tssi_sys_defs_2g_b_tbl,\n\t\t\t\t\t &rtw8852c_tssi_sys_defs_5g_b_tbl);\n}\n\nstatic void _tssi_ini_txpwr_ctrl_bb(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t    enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852c_tssi_txpwr_ctrl_bb_defs_a_tbl,\n\t\t\t\t &rtw8852c_tssi_txpwr_ctrl_bb_defs_b_tbl);\n}\n\nstatic void _tssi_ini_txpwr_ctrl_bb_he_tb(struct rtw89_dev *rtwdev,\n\t\t\t\t\t  enum rtw89_phy_idx phy,\n\t\t\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852c_tssi_txpwr_ctrl_bb_he_tb_defs_a_tbl,\n\t\t\t\t &rtw8852c_tssi_txpwr_ctrl_bb_he_tb_defs_b_tbl);\n}\n\nstatic void _tssi_set_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\tif (path == RF_PATH_A) {\n\t\trtw89_rfk_parser(rtwdev, &rtw8852c_tssi_dck_defs_a_tbl);\n\t\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t\t &rtw8852c_tssi_dck_defs_2g_a_tbl,\n\t\t\t\t\t &rtw8852c_tssi_dck_defs_5g_a_tbl);\n\t} else {\n\t\trtw89_rfk_parser(rtwdev, &rtw8852c_tssi_dck_defs_b_tbl);\n\t\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t\t &rtw8852c_tssi_dck_defs_2g_b_tbl,\n\t\t\t\t\t &rtw8852c_tssi_dck_defs_5g_b_tbl);\n\t}\n}\n\nstatic void _tssi_set_bbgain_split(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t   enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852c_tssi_set_bbgain_split_a_tbl,\n\t\t\t\t &rtw8852c_tssi_set_bbgain_split_b_tbl);\n}\n\nstatic void _tssi_set_tmeter_tbl(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n#define RTW8852C_TSSI_GET_VAL(ptr, idx)\t\t\t\\\n({\t\t\t\t\t\t\t\\\n\ts8 *__ptr = (ptr);\t\t\t\t\\\n\tu8 __idx = (idx), __i, __v;\t\t\t\\\n\tu32 __val = 0;\t\t\t\t\t\\\n\tfor (__i = 0; __i < 4; __i++) {\t\t\t\\\n\t\t__v = (__ptr[__idx + __i]);\t\t\\\n\t\t__val |= (__v << (8 * __i));\t\t\\\n\t}\t\t\t\t\t\t\\\n\t__val;\t\t\t\t\t\t\\\n})\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu8 subband = chan->subband_type;\n\tconst s8 *thm_up_a = NULL;\n\tconst s8 *thm_down_a = NULL;\n\tconst s8 *thm_up_b = NULL;\n\tconst s8 *thm_down_b = NULL;\n\tu8 thermal = 0xff;\n\ts8 thm_ofst[64] = {0};\n\tu32 tmp = 0;\n\tu8 i, j;\n\n\tswitch (subband) {\n\tdefault:\n\tcase RTW89_CH_2G:\n\t\tthm_up_a = rtw89_8852c_trk_cfg.delta_swingidx_2ga_p;\n\t\tthm_down_a = rtw89_8852c_trk_cfg.delta_swingidx_2ga_n;\n\t\tthm_up_b = rtw89_8852c_trk_cfg.delta_swingidx_2gb_p;\n\t\tthm_down_b = rtw89_8852c_trk_cfg.delta_swingidx_2gb_n;\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_1:\n\t\tthm_up_a = rtw89_8852c_trk_cfg.delta_swingidx_5ga_p[0];\n\t\tthm_down_a = rtw89_8852c_trk_cfg.delta_swingidx_5ga_n[0];\n\t\tthm_up_b = rtw89_8852c_trk_cfg.delta_swingidx_5gb_p[0];\n\t\tthm_down_b = rtw89_8852c_trk_cfg.delta_swingidx_5gb_n[0];\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_3:\n\t\tthm_up_a = rtw89_8852c_trk_cfg.delta_swingidx_5ga_p[1];\n\t\tthm_down_a = rtw89_8852c_trk_cfg.delta_swingidx_5ga_n[1];\n\t\tthm_up_b = rtw89_8852c_trk_cfg.delta_swingidx_5gb_p[1];\n\t\tthm_down_b = rtw89_8852c_trk_cfg.delta_swingidx_5gb_n[1];\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_4:\n\t\tthm_up_a = rtw89_8852c_trk_cfg.delta_swingidx_5ga_p[2];\n\t\tthm_down_a = rtw89_8852c_trk_cfg.delta_swingidx_5ga_n[2];\n\t\tthm_up_b = rtw89_8852c_trk_cfg.delta_swingidx_5gb_p[2];\n\t\tthm_down_b = rtw89_8852c_trk_cfg.delta_swingidx_5gb_n[2];\n\t\tbreak;\n\tcase RTW89_CH_6G_BAND_IDX0:\n\tcase RTW89_CH_6G_BAND_IDX1:\n\t\tthm_up_a = rtw89_8852c_trk_cfg.delta_swingidx_6ga_p[0];\n\t\tthm_down_a = rtw89_8852c_trk_cfg.delta_swingidx_6ga_n[0];\n\t\tthm_up_b = rtw89_8852c_trk_cfg.delta_swingidx_6gb_p[0];\n\t\tthm_down_b = rtw89_8852c_trk_cfg.delta_swingidx_6gb_n[0];\n\t\tbreak;\n\tcase RTW89_CH_6G_BAND_IDX2:\n\tcase RTW89_CH_6G_BAND_IDX3:\n\t\tthm_up_a = rtw89_8852c_trk_cfg.delta_swingidx_6ga_p[1];\n\t\tthm_down_a = rtw89_8852c_trk_cfg.delta_swingidx_6ga_n[1];\n\t\tthm_up_b = rtw89_8852c_trk_cfg.delta_swingidx_6gb_p[1];\n\t\tthm_down_b = rtw89_8852c_trk_cfg.delta_swingidx_6gb_n[1];\n\t\tbreak;\n\tcase RTW89_CH_6G_BAND_IDX4:\n\tcase RTW89_CH_6G_BAND_IDX5:\n\t\tthm_up_a = rtw89_8852c_trk_cfg.delta_swingidx_6ga_p[2];\n\t\tthm_down_a = rtw89_8852c_trk_cfg.delta_swingidx_6ga_n[2];\n\t\tthm_up_b = rtw89_8852c_trk_cfg.delta_swingidx_6gb_p[2];\n\t\tthm_down_b = rtw89_8852c_trk_cfg.delta_swingidx_6gb_n[2];\n\t\tbreak;\n\tcase RTW89_CH_6G_BAND_IDX6:\n\tcase RTW89_CH_6G_BAND_IDX7:\n\t\tthm_up_a = rtw89_8852c_trk_cfg.delta_swingidx_6ga_p[3];\n\t\tthm_down_a = rtw89_8852c_trk_cfg.delta_swingidx_6ga_n[3];\n\t\tthm_up_b = rtw89_8852c_trk_cfg.delta_swingidx_6gb_p[3];\n\t\tthm_down_b = rtw89_8852c_trk_cfg.delta_swingidx_6gb_n[3];\n\t\tbreak;\n\t}\n\n\tif (path == RF_PATH_A) {\n\t\tthermal = tssi_info->thermal[RF_PATH_A];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] ch=%d thermal_pathA=0x%x\\n\", ch, thermal);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER_DIS, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER_TRK, 0x1);\n\n\t\tif (thermal == 0xff) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER, 32);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_VAL, 32);\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\trtw89_phy_write32(rtwdev, R_P0_TSSI_BASE + i, 0x0);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x5c00 + i, 0x0);\n\t\t\t}\n\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER, thermal);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_VAL,\n\t\t\t\t\t       thermal);\n\n\t\t\ti = 0;\n\t\t\tfor (j = 0; j < 32; j++)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      -thm_down_a[i++] :\n\t\t\t\t\t      -thm_down_a[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\ti = 1;\n\t\t\tfor (j = 63; j >= 32; j--)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      thm_up_a[i++] :\n\t\t\t\t\t      thm_up_a[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\ttmp = RTW8852C_TSSI_GET_VAL(thm_ofst, i);\n\t\t\t\trtw89_phy_write32(rtwdev, R_P0_TSSI_BASE + i, tmp);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x5c00 + i, tmp);\n\t\t\t}\n\t\t}\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, R_P0_RFCTM_RDY, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, R_P0_RFCTM_RDY, 0x0);\n\n\t} else {\n\t\tthermal = tssi_info->thermal[RF_PATH_B];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] ch=%d thermal_pathB=0x%x\\n\", ch, thermal);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER_DIS, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER_TRK, 0x1);\n\n\t\tif (thermal == 0xff) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER, 32);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, B_P1_RFCTM_VAL, 32);\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\trtw89_phy_write32(rtwdev, R_TSSI_THOF + i, 0x0);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x7c00 + i, 0x0);\n\t\t\t}\n\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER, thermal);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, B_P1_RFCTM_VAL,\n\t\t\t\t\t       thermal);\n\n\t\t\ti = 0;\n\t\t\tfor (j = 0; j < 32; j++)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      -thm_down_b[i++] :\n\t\t\t\t\t      -thm_down_b[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\ti = 1;\n\t\t\tfor (j = 63; j >= 32; j--)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      thm_up_b[i++] :\n\t\t\t\t\t      thm_up_b[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\ttmp = RTW8852C_TSSI_GET_VAL(thm_ofst, i);\n\t\t\t\trtw89_phy_write32(rtwdev, R_TSSI_THOF + i, tmp);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x7c00 + i, tmp);\n\t\t\t}\n\t\t}\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, R_P1_RFCTM_RDY, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, R_P1_RFCTM_RDY, 0x0);\n\t}\n#undef RTW8852C_TSSI_GET_VAL\n}\n\nstatic void _tssi_slope_cal_org(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\tif (path == RF_PATH_A) {\n\t\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t\t &rtw8852c_tssi_slope_cal_org_defs_2g_a_tbl,\n\t\t\t\t\t &rtw8852c_tssi_slope_cal_org_defs_5g_a_tbl);\n\t} else {\n\t\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t\t &rtw8852c_tssi_slope_cal_org_defs_2g_b_tbl,\n\t\t\t\t\t &rtw8852c_tssi_slope_cal_org_defs_5g_b_tbl);\n\t}\n}\n\nstatic void _tssi_set_aligk_default(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t    enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\tconst struct rtw89_rfk_tbl *tbl;\n\n\tif (path == RF_PATH_A) {\n\t\tif (band == RTW89_BAND_2G)\n\t\t\ttbl = &rtw8852c_tssi_set_aligk_default_defs_2g_a_tbl;\n\t\telse if (band == RTW89_BAND_6G)\n\t\t\ttbl = &rtw8852c_tssi_set_aligk_default_defs_6g_a_tbl;\n\t\telse\n\t\t\ttbl = &rtw8852c_tssi_set_aligk_default_defs_5g_a_tbl;\n\t} else {\n\t\tif (band == RTW89_BAND_2G)\n\t\t\ttbl = &rtw8852c_tssi_set_aligk_default_defs_2g_b_tbl;\n\t\telse if (band == RTW89_BAND_6G)\n\t\t\ttbl = &rtw8852c_tssi_set_aligk_default_defs_6g_b_tbl;\n\t\telse\n\t\t\ttbl = &rtw8852c_tssi_set_aligk_default_defs_5g_b_tbl;\n\t}\n\n\trtw89_rfk_parser(rtwdev, tbl);\n}\n\nstatic void _tssi_set_slope(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852c_tssi_slope_defs_a_tbl,\n\t\t\t\t &rtw8852c_tssi_slope_defs_b_tbl);\n}\n\nstatic void _tssi_run_slope(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852c_tssi_run_slope_defs_a_tbl,\n\t\t\t\t &rtw8852c_tssi_run_slope_defs_b_tbl);\n}\n\nstatic void _tssi_set_track(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852c_tssi_track_defs_a_tbl,\n\t\t\t\t &rtw8852c_tssi_track_defs_b_tbl);\n}\n\nstatic void _tssi_set_txagc_offset_mv_avg(struct rtw89_dev *rtwdev,\n\t\t\t\t\t  enum rtw89_phy_idx phy,\n\t\t\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852c_tssi_txagc_ofst_mv_avg_defs_a_tbl,\n\t\t\t\t &rtw8852c_tssi_txagc_ofst_mv_avg_defs_b_tbl);\n}\n\nstatic void _tssi_enable(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tu32 i, path = RF_PATH_A, path_max = RF_PATH_NUM_8852C;\n\n\tif (rtwdev->dbcc_en) {\n\t\tif (phy == RTW89_PHY_0) {\n\t\t\tpath = RF_PATH_A;\n\t\t\tpath_max = RF_PATH_B;\n\t\t} else if (phy == RTW89_PHY_1) {\n\t\t\tpath = RF_PATH_B;\n\t\t\tpath_max = RF_PATH_NUM_8852C;\n\t\t}\n\t}\n\n\tfor (i = path; i < path_max; i++) {\n\t\t_tssi_set_track(rtwdev, phy, i);\n\t\t_tssi_set_txagc_offset_mv_avg(rtwdev, phy, i);\n\n\t\trtw89_rfk_parser_by_cond(rtwdev, i == RF_PATH_A,\n\t\t\t\t\t &rtw8852c_tssi_enable_defs_a_tbl,\n\t\t\t\t\t &rtw8852c_tssi_enable_defs_b_tbl);\n\n\t\ttssi_info->base_thermal[i] =\n\t\t\tewma_thermal_read(&rtwdev->phystat.avg_thermal[i]);\n\t\trtwdev->is_tssi_mode[i] = true;\n\t}\n}\n\nstatic void _tssi_disable(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tu32 i, path = RF_PATH_A, path_max = RF_PATH_NUM_8852C;\n\n\tif (rtwdev->dbcc_en) {\n\t\tif (phy == RTW89_PHY_0) {\n\t\t\tpath = RF_PATH_A;\n\t\t\tpath_max = RF_PATH_B;\n\t\t} else if (phy == RTW89_PHY_1) {\n\t\t\tpath = RF_PATH_B;\n\t\t\tpath_max = RF_PATH_NUM_8852C;\n\t\t}\n\t}\n\n\tfor (i = path; i < path_max; i++) {\n\t\tif (i == RF_PATH_A) {\n\t\t\trtw89_rfk_parser(rtwdev, &rtw8852c_tssi_disable_defs_a_tbl);\n\t\t\trtwdev->is_tssi_mode[RF_PATH_A] = false;\n\t\t}  else if (i == RF_PATH_B) {\n\t\t\trtw89_rfk_parser(rtwdev, &rtw8852c_tssi_disable_defs_b_tbl);\n\t\t\trtwdev->is_tssi_mode[RF_PATH_B] = false;\n\t\t}\n\t}\n}\n\nstatic u32 _tssi_get_cck_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 2:\n\t\treturn 0;\n\tcase 3 ... 5:\n\t\treturn 1;\n\tcase 6 ... 8:\n\t\treturn 2;\n\tcase 9 ... 11:\n\t\treturn 3;\n\tcase 12 ... 13:\n\t\treturn 4;\n\tcase 14:\n\t\treturn 5;\n\t}\n\n\treturn 0;\n}\n\n#define TSSI_EXTRA_GROUP_BIT (BIT(31))\n#define TSSI_EXTRA_GROUP(idx) (TSSI_EXTRA_GROUP_BIT | (idx))\n#define IS_TSSI_EXTRA_GROUP(group) ((group) & TSSI_EXTRA_GROUP_BIT)\n#define TSSI_EXTRA_GET_GROUP_IDX1(group) ((group) & ~TSSI_EXTRA_GROUP_BIT)\n#define TSSI_EXTRA_GET_GROUP_IDX2(group) (TSSI_EXTRA_GET_GROUP_IDX1(group) + 1)\n\nstatic u32 _tssi_get_ofdm_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 2:\n\t\treturn 0;\n\tcase 3 ... 5:\n\t\treturn 1;\n\tcase 6 ... 8:\n\t\treturn 2;\n\tcase 9 ... 11:\n\t\treturn 3;\n\tcase 12 ... 14:\n\t\treturn 4;\n\tcase 36 ... 40:\n\t\treturn 5;\n\tcase 41 ... 43:\n\t\treturn TSSI_EXTRA_GROUP(5);\n\tcase 44 ... 48:\n\t\treturn 6;\n\tcase 49 ... 51:\n\t\treturn TSSI_EXTRA_GROUP(6);\n\tcase 52 ... 56:\n\t\treturn 7;\n\tcase 57 ... 59:\n\t\treturn TSSI_EXTRA_GROUP(7);\n\tcase 60 ... 64:\n\t\treturn 8;\n\tcase 100 ... 104:\n\t\treturn 9;\n\tcase 105 ... 107:\n\t\treturn TSSI_EXTRA_GROUP(9);\n\tcase 108 ... 112:\n\t\treturn 10;\n\tcase 113 ... 115:\n\t\treturn TSSI_EXTRA_GROUP(10);\n\tcase 116 ... 120:\n\t\treturn 11;\n\tcase 121 ... 123:\n\t\treturn TSSI_EXTRA_GROUP(11);\n\tcase 124 ... 128:\n\t\treturn 12;\n\tcase 129 ... 131:\n\t\treturn TSSI_EXTRA_GROUP(12);\n\tcase 132 ... 136:\n\t\treturn 13;\n\tcase 137 ... 139:\n\t\treturn TSSI_EXTRA_GROUP(13);\n\tcase 140 ... 144:\n\t\treturn 14;\n\tcase 149 ... 153:\n\t\treturn 15;\n\tcase 154 ... 156:\n\t\treturn TSSI_EXTRA_GROUP(15);\n\tcase 157 ... 161:\n\t\treturn 16;\n\tcase 162 ... 164:\n\t\treturn TSSI_EXTRA_GROUP(16);\n\tcase 165 ... 169:\n\t\treturn 17;\n\tcase 170 ... 172:\n\t\treturn TSSI_EXTRA_GROUP(17);\n\tcase 173 ... 177:\n\t\treturn 18;\n\t}\n\n\treturn 0;\n}\n\nstatic u32 _tssi_get_6g_ofdm_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 5:\n\t\treturn 0;\n\tcase 6 ... 8:\n\t\treturn TSSI_EXTRA_GROUP(0);\n\tcase 9 ... 13:\n\t\treturn 1;\n\tcase 14 ... 16:\n\t\treturn TSSI_EXTRA_GROUP(1);\n\tcase 17 ... 21:\n\t\treturn 2;\n\tcase 22 ... 24:\n\t\treturn TSSI_EXTRA_GROUP(2);\n\tcase 25 ... 29:\n\t\treturn 3;\n\tcase 33 ... 37:\n\t\treturn 4;\n\tcase 38 ... 40:\n\t\treturn TSSI_EXTRA_GROUP(4);\n\tcase 41 ... 45:\n\t\treturn 5;\n\tcase 46 ... 48:\n\t\treturn TSSI_EXTRA_GROUP(5);\n\tcase 49 ... 53:\n\t\treturn 6;\n\tcase 54 ... 56:\n\t\treturn TSSI_EXTRA_GROUP(6);\n\tcase 57 ... 61:\n\t\treturn 7;\n\tcase 65 ... 69:\n\t\treturn 8;\n\tcase 70 ... 72:\n\t\treturn TSSI_EXTRA_GROUP(8);\n\tcase 73 ... 77:\n\t\treturn 9;\n\tcase 78 ... 80:\n\t\treturn TSSI_EXTRA_GROUP(9);\n\tcase 81 ... 85:\n\t\treturn 10;\n\tcase 86 ... 88:\n\t\treturn TSSI_EXTRA_GROUP(10);\n\tcase 89 ... 93:\n\t\treturn 11;\n\tcase 97 ... 101:\n\t\treturn 12;\n\tcase 102 ... 104:\n\t\treturn TSSI_EXTRA_GROUP(12);\n\tcase 105 ... 109:\n\t\treturn 13;\n\tcase 110 ... 112:\n\t\treturn TSSI_EXTRA_GROUP(13);\n\tcase 113 ... 117:\n\t\treturn 14;\n\tcase 118 ... 120:\n\t\treturn TSSI_EXTRA_GROUP(14);\n\tcase 121 ... 125:\n\t\treturn 15;\n\tcase 129 ... 133:\n\t\treturn 16;\n\tcase 134 ... 136:\n\t\treturn TSSI_EXTRA_GROUP(16);\n\tcase 137 ... 141:\n\t\treturn 17;\n\tcase 142 ... 144:\n\t\treturn TSSI_EXTRA_GROUP(17);\n\tcase 145 ... 149:\n\t\treturn 18;\n\tcase 150 ... 152:\n\t\treturn TSSI_EXTRA_GROUP(18);\n\tcase 153 ... 157:\n\t\treturn 19;\n\tcase 161 ... 165:\n\t\treturn 20;\n\tcase 166 ... 168:\n\t\treturn TSSI_EXTRA_GROUP(20);\n\tcase 169 ... 173:\n\t\treturn 21;\n\tcase 174 ... 176:\n\t\treturn TSSI_EXTRA_GROUP(21);\n\tcase 177 ... 181:\n\t\treturn 22;\n\tcase 182 ... 184:\n\t\treturn TSSI_EXTRA_GROUP(22);\n\tcase 185 ... 189:\n\t\treturn 23;\n\tcase 193 ... 197:\n\t\treturn 24;\n\tcase 198 ... 200:\n\t\treturn TSSI_EXTRA_GROUP(24);\n\tcase 201 ... 205:\n\t\treturn 25;\n\tcase 206 ... 208:\n\t\treturn TSSI_EXTRA_GROUP(25);\n\tcase 209 ... 213:\n\t\treturn 26;\n\tcase 214 ... 216:\n\t\treturn TSSI_EXTRA_GROUP(26);\n\tcase 217 ... 221:\n\t\treturn 27;\n\tcase 225 ... 229:\n\t\treturn 28;\n\tcase 230 ... 232:\n\t\treturn TSSI_EXTRA_GROUP(28);\n\tcase 233 ... 237:\n\t\treturn 29;\n\tcase 238 ... 240:\n\t\treturn TSSI_EXTRA_GROUP(29);\n\tcase 241 ... 245:\n\t\treturn 30;\n\tcase 246 ... 248:\n\t\treturn TSSI_EXTRA_GROUP(30);\n\tcase 249 ... 253:\n\t\treturn 31;\n\t}\n\n\treturn 0;\n}\n\nstatic u32 _tssi_get_trim_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 8:\n\t\treturn 0;\n\tcase 9 ... 14:\n\t\treturn 1;\n\tcase 36 ... 48:\n\t\treturn 2;\n\tcase 49 ... 51:\n\t\treturn TSSI_EXTRA_GROUP(2);\n\tcase 52 ... 64:\n\t\treturn 3;\n\tcase 100 ... 112:\n\t\treturn 4;\n\tcase 113 ... 115:\n\t\treturn TSSI_EXTRA_GROUP(4);\n\tcase 116 ... 128:\n\t\treturn 5;\n\tcase 132 ... 144:\n\t\treturn 6;\n\tcase 149 ... 177:\n\t\treturn 7;\n\t}\n\n\treturn 0;\n}\n\nstatic u32 _tssi_get_6g_trim_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 13:\n\t\treturn 0;\n\tcase 14 ... 16:\n\t\treturn TSSI_EXTRA_GROUP(0);\n\tcase 17 ... 29:\n\t\treturn 1;\n\tcase 33 ... 45:\n\t\treturn 2;\n\tcase 46 ... 48:\n\t\treturn TSSI_EXTRA_GROUP(2);\n\tcase 49 ... 61:\n\t\treturn 3;\n\tcase 65 ... 77:\n\t\treturn 4;\n\tcase 78 ... 80:\n\t\treturn TSSI_EXTRA_GROUP(4);\n\tcase 81 ... 93:\n\t\treturn 5;\n\tcase 97 ... 109:\n\t\treturn 6;\n\tcase 110 ... 112:\n\t\treturn TSSI_EXTRA_GROUP(6);\n\tcase 113 ... 125:\n\t\treturn 7;\n\tcase 129 ... 141:\n\t\treturn 8;\n\tcase 142 ... 144:\n\t\treturn TSSI_EXTRA_GROUP(8);\n\tcase 145 ... 157:\n\t\treturn 9;\n\tcase 161 ... 173:\n\t\treturn 10;\n\tcase 174 ... 176:\n\t\treturn TSSI_EXTRA_GROUP(10);\n\tcase 177 ... 189:\n\t\treturn 11;\n\tcase 193 ... 205:\n\t\treturn 12;\n\tcase 206 ... 208:\n\t\treturn TSSI_EXTRA_GROUP(12);\n\tcase 209 ... 221:\n\t\treturn 13;\n\tcase 225 ... 237:\n\t\treturn 14;\n\tcase 238 ... 240:\n\t\treturn TSSI_EXTRA_GROUP(14);\n\tcase 241 ... 253:\n\t\treturn 15;\n\t}\n\n\treturn 0;\n}\n\nstatic s8 _tssi_get_ofdm_de(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\tu8 ch = chan->channel;\n\tu32 gidx, gidx_1st, gidx_2nd;\n\ts8 de_1st;\n\ts8 de_2nd;\n\ts8 val;\n\n\tif (band == RTW89_BAND_2G || band == RTW89_BAND_5G) {\n\t\tgidx = _tssi_get_ofdm_group(rtwdev, ch);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs group_idx=0x%x\\n\",\n\t\t\t    path, gidx);\n\n\t\tif (IS_TSSI_EXTRA_GROUP(gidx)) {\n\t\t\tgidx_1st = TSSI_EXTRA_GET_GROUP_IDX1(gidx);\n\t\t\tgidx_2nd = TSSI_EXTRA_GET_GROUP_IDX2(gidx);\n\t\t\tde_1st = tssi_info->tssi_mcs[path][gidx_1st];\n\t\t\tde_2nd = tssi_info->tssi_mcs[path][gidx_2nd];\n\t\t\tval = (de_1st + de_2nd) / 2;\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI][TRIM]: path=%d mcs de=%d 1st=%d 2nd=%d\\n\",\n\t\t\t\t    path, val, de_1st, de_2nd);\n\t\t} else {\n\t\t\tval = tssi_info->tssi_mcs[path][gidx];\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI][TRIM]: path=%d mcs de=%d\\n\", path, val);\n\t\t}\n\t} else {\n\t\tgidx = _tssi_get_6g_ofdm_group(rtwdev, ch);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs group_idx=0x%x\\n\",\n\t\t\t    path, gidx);\n\n\t\tif (IS_TSSI_EXTRA_GROUP(gidx)) {\n\t\t\tgidx_1st = TSSI_EXTRA_GET_GROUP_IDX1(gidx);\n\t\t\tgidx_2nd = TSSI_EXTRA_GET_GROUP_IDX2(gidx);\n\t\t\tde_1st = tssi_info->tssi_6g_mcs[path][gidx_1st];\n\t\t\tde_2nd = tssi_info->tssi_6g_mcs[path][gidx_2nd];\n\t\t\tval = (de_1st + de_2nd) / 2;\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI][TRIM]: path=%d mcs de=%d 1st=%d 2nd=%d\\n\",\n\t\t\t\t    path, val, de_1st, de_2nd);\n\t\t} else {\n\t\t\tval = tssi_info->tssi_6g_mcs[path][gidx];\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI][TRIM]: path=%d mcs de=%d\\n\", path, val);\n\t\t}\n\t}\n\n\treturn val;\n}\n\nstatic s8 _tssi_get_ofdm_trim_de(struct rtw89_dev *rtwdev,\n\t\t\t\t enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\tu8 ch = chan->channel;\n\tu32 tgidx, tgidx_1st, tgidx_2nd;\n\ts8 tde_1st = 0;\n\ts8 tde_2nd = 0;\n\ts8 val;\n\n\tif (band == RTW89_BAND_2G || band == RTW89_BAND_5G) {\n\t\ttgidx = _tssi_get_trim_group(rtwdev, ch);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_group_idx=0x%x\\n\",\n\t\t\t    path, tgidx);\n\n\t\tif (IS_TSSI_EXTRA_GROUP(tgidx)) {\n\t\t\ttgidx_1st = TSSI_EXTRA_GET_GROUP_IDX1(tgidx);\n\t\t\ttgidx_2nd = TSSI_EXTRA_GET_GROUP_IDX2(tgidx);\n\t\t\ttde_1st = tssi_info->tssi_trim[path][tgidx_1st];\n\t\t\ttde_2nd = tssi_info->tssi_trim[path][tgidx_2nd];\n\t\t\tval = (tde_1st + tde_2nd) / 2;\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_de=%d 1st=%d 2nd=%d\\n\",\n\t\t\t\t    path, val, tde_1st, tde_2nd);\n\t\t} else {\n\t\t\tval = tssi_info->tssi_trim[path][tgidx];\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_de=%d\\n\",\n\t\t\t\t    path, val);\n\t\t}\n\t} else {\n\t\ttgidx = _tssi_get_6g_trim_group(rtwdev, ch);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_group_idx=0x%x\\n\",\n\t\t\t    path, tgidx);\n\n\t\tif (IS_TSSI_EXTRA_GROUP(tgidx)) {\n\t\t\ttgidx_1st = TSSI_EXTRA_GET_GROUP_IDX1(tgidx);\n\t\t\ttgidx_2nd = TSSI_EXTRA_GET_GROUP_IDX2(tgidx);\n\t\t\ttde_1st = tssi_info->tssi_trim_6g[path][tgidx_1st];\n\t\t\ttde_2nd = tssi_info->tssi_trim_6g[path][tgidx_2nd];\n\t\t\tval = (tde_1st + tde_2nd) / 2;\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_de=%d 1st=%d 2nd=%d\\n\",\n\t\t\t\t    path, val, tde_1st, tde_2nd);\n\t\t} else {\n\t\t\tval = tssi_info->tssi_trim_6g[path][tgidx];\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_de=%d\\n\",\n\t\t\t\t    path, val);\n\t\t}\n\t}\n\n\treturn val;\n}\n\nstatic void _tssi_set_efuse_to_de(struct rtw89_dev *rtwdev,\n\t\t\t\t  enum rtw89_phy_idx phy)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu8 gidx;\n\ts8 ofdm_de;\n\ts8 trim_de;\n\ts32 val;\n\tu32 i, path = RF_PATH_A, path_max = RF_PATH_NUM_8852C;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI][TRIM]: phy=%d ch=%d\\n\",\n\t\t    phy, ch);\n\n\tif (rtwdev->dbcc_en) {\n\t\tif (phy == RTW89_PHY_0) {\n\t\t\tpath = RF_PATH_A;\n\t\t\tpath_max = RF_PATH_B;\n\t\t} else if (phy == RTW89_PHY_1) {\n\t\t\tpath = RF_PATH_B;\n\t\t\tpath_max = RF_PATH_NUM_8852C;\n\t\t}\n\t}\n\n\tfor (i = path; i < path_max; i++) {\n\t\tgidx = _tssi_get_cck_group(rtwdev, ch);\n\t\ttrim_de = _tssi_get_ofdm_trim_de(rtwdev, phy, i);\n\t\tval = tssi_info->tssi_cck[i][gidx] + trim_de;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d cck[%d]=0x%x trim=0x%x\\n\",\n\t\t\t    i, gidx, tssi_info->tssi_cck[i][gidx], trim_de);\n\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_cck_long[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_cck_short[i], _TSSI_DE_MASK, val);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] Set TSSI CCK DE 0x%x[21:12]=0x%x\\n\",\n\t\t\t    _tssi_de_cck_long[i],\n\t\t\t    rtw89_phy_read32_mask(rtwdev, _tssi_de_cck_long[i],\n\t\t\t\t\t\t  _TSSI_DE_MASK));\n\n\t\tofdm_de = _tssi_get_ofdm_de(rtwdev, phy, i);\n\t\ttrim_de = _tssi_get_ofdm_trim_de(rtwdev, phy, i);\n\t\tval = ofdm_de + trim_de;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs=0x%x trim=0x%x\\n\",\n\t\t\t    i, ofdm_de, trim_de);\n\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_20m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_40m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_80m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_80m_80m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_5m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_10m[i], _TSSI_DE_MASK, val);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] Set TSSI MCS DE 0x%x[21:12]=0x%x\\n\",\n\t\t\t    _tssi_de_mcs_20m[i],\n\t\t\t    rtw89_phy_read32_mask(rtwdev, _tssi_de_mcs_20m[i],\n\t\t\t\t\t\t  _TSSI_DE_MASK));\n\t}\n}\n\nstatic void rtw8852c_tssi_cont_en(struct rtw89_dev *rtwdev, bool en,\n\t\t\t\t  enum rtw89_rf_path path)\n{\n\tstatic const u32 tssi_trk[2] = {0x5818, 0x7818};\n\tstatic const u32 tssi_en[2] = {0x5820, 0x7820};\n\n\tif (en) {\n\t\trtw89_phy_write32_mask(rtwdev, tssi_trk[path], BIT(30), 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, tssi_en[path], BIT(31), 0x0);\n\t\tif (rtwdev->dbcc_en && path == RF_PATH_B)\n\t\t\t_tssi_set_efuse_to_de(rtwdev, RTW89_PHY_1);\n\t\telse\n\t\t\t_tssi_set_efuse_to_de(rtwdev, RTW89_PHY_0);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, tssi_trk[path], BIT(30), 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, tssi_en[path], BIT(31), 0x1);\n\t}\n}\n\nvoid rtw8852c_tssi_cont_en_phyidx(struct rtw89_dev *rtwdev, bool en, u8 phy_idx)\n{\n\tif (!rtwdev->dbcc_en) {\n\t\trtw8852c_tssi_cont_en(rtwdev, en, RF_PATH_A);\n\t\trtw8852c_tssi_cont_en(rtwdev, en, RF_PATH_B);\n\t} else {\n\t\tif (phy_idx == RTW89_PHY_0)\n\t\t\trtw8852c_tssi_cont_en(rtwdev, en, RF_PATH_A);\n\t\telse\n\t\t\trtw8852c_tssi_cont_en(rtwdev, en, RF_PATH_B);\n\t}\n}\n\nstatic void _bw_setting(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t\tenum rtw89_bandwidth bw, bool is_dav)\n{\n\tu32 rf_reg18;\n\tu32 reg_reg18_addr;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]===>%s\\n\", __func__);\n\tif (is_dav)\n\t\treg_reg18_addr = RR_CFGCH;\n\telse\n\t\treg_reg18_addr = RR_CFGCH_V1;\n\n\trf_reg18 = rtw89_read_rf(rtwdev, path, reg_reg18_addr, RFREG_MASK);\n\trf_reg18 &= ~RR_CFGCH_BW;\n\n\tswitch (bw) {\n\tcase RTW89_CHANNEL_WIDTH_5:\n\tcase RTW89_CHANNEL_WIDTH_10:\n\tcase RTW89_CHANNEL_WIDTH_20:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BW, CFGCH_BW_20M);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW0 | (path << 8), B_P0_CFCH_BW0, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW1 | (path << 8), B_P0_CFCH_BW1, 0xf);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_40:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BW, CFGCH_BW_40M);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW0 | (path << 8), B_P0_CFCH_BW0, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW1 | (path << 8), B_P0_CFCH_BW1, 0xf);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_80:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BW, CFGCH_BW_80M);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW0 | (path << 8), B_P0_CFCH_BW0, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW1 | (path << 8), B_P0_CFCH_BW1, 0xd);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_160:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BW, CFGCH_BW_160M);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW0 | (path << 8), B_P0_CFCH_BW0, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW1 | (path << 8), B_P0_CFCH_BW1, 0xb);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trtw89_write_rf(rtwdev, path, reg_reg18_addr, RFREG_MASK, rf_reg18);\n}\n\nstatic void _ctrl_bw(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t     enum rtw89_bandwidth bw)\n{\n\tbool is_dav;\n\tu8 kpath, path;\n\tu32 tmp = 0;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]===>%s\\n\", __func__);\n\tkpath = _kpath(rtwdev, phy);\n\n\tfor (path = 0; path < 2; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\tis_dav = true;\n\t\t_bw_setting(rtwdev, path, bw, is_dav);\n\t\tis_dav = false;\n\t\t_bw_setting(rtwdev, path, bw, is_dav);\n\t\tif (rtwdev->dbcc_en)\n\t\t\tcontinue;\n\n\t\tif (path == RF_PATH_B && rtwdev->hal.cv == CHIP_CAV) {\n\t\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV1, RR_RSV1_RST, 0x0);\n\t\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_A, RR_CFGCH, RFREG_MASK);\n\t\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_APK, RR_APK_MOD, 0x3);\n\t\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_CFGCH, RFREG_MASK, tmp);\n\t\t\tfsleep(100);\n\t\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV1, RR_RSV1_RST, 0x1);\n\t\t}\n\t}\n}\n\nstatic void _ch_setting(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t\tu8 central_ch, enum rtw89_band band, bool is_dav)\n{\n\tu32 rf_reg18;\n\tu32 reg_reg18_addr;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]===>%s\\n\", __func__);\n\tif (is_dav)\n\t\treg_reg18_addr = 0x18;\n\telse\n\t\treg_reg18_addr = 0x10018;\n\n\trf_reg18 = rtw89_read_rf(rtwdev, path, reg_reg18_addr, RFREG_MASK);\n\trf_reg18 &= ~(RR_CFGCH_BAND1 | RR_CFGCH_BAND0 | RR_CFGCH_CH);\n\trf_reg18 |= FIELD_PREP(RR_CFGCH_CH, central_ch);\n\n\tswitch (band) {\n\tcase RTW89_BAND_2G:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BAND1, CFGCH_BAND1_2G);\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BAND0, CFGCH_BAND0_2G);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BAND1, CFGCH_BAND1_5G);\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BAND0, CFGCH_BAND0_5G);\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BAND1, CFGCH_BAND1_6G);\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BAND0, CFGCH_BAND0_6G);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\trtw89_write_rf(rtwdev, path, reg_reg18_addr, RFREG_MASK, rf_reg18);\n\tfsleep(100);\n}\n\nstatic void _ctrl_ch(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t     u8 central_ch, enum rtw89_band band)\n{\n\tu8 kpath, path;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]===>%s\\n\", __func__);\n\tif (band != RTW89_BAND_6G) {\n\t\tif ((central_ch > 14 && central_ch < 36) ||\n\t\t    (central_ch > 64 && central_ch < 100) ||\n\t\t    (central_ch > 144 && central_ch < 149) || central_ch > 177)\n\t\t\treturn;\n\t} else {\n\t\tif (central_ch > 253 || central_ch  == 2)\n\t\t\treturn;\n\t}\n\n\tkpath = _kpath(rtwdev, phy);\n\n\tfor (path = 0; path < 2; path++) {\n\t\tif (kpath & BIT(path)) {\n\t\t\t_ch_setting(rtwdev, path, central_ch, band, true);\n\t\t\t_ch_setting(rtwdev, path, central_ch, band, false);\n\t\t}\n\t}\n}\n\nstatic void _rxbb_bw(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t     enum rtw89_bandwidth bw)\n{\n\tu8 kpath;\n\tu8 path;\n\tu32 val;\n\n\tkpath = _kpath(rtwdev, phy);\n\tfor (path = 0; path < 2; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWE2, RR_LUTWE2_RTXBW, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWA, RR_LUTWA_M2, 0xa);\n\t\tswitch (bw) {\n\t\tcase RTW89_CHANNEL_WIDTH_20:\n\t\t\tval = 0x1b;\n\t\t\tbreak;\n\t\tcase RTW89_CHANNEL_WIDTH_40:\n\t\t\tval = 0x13;\n\t\t\tbreak;\n\t\tcase RTW89_CHANNEL_WIDTH_80:\n\t\t\tval = 0xb;\n\t\t\tbreak;\n\t\tcase RTW89_CHANNEL_WIDTH_160:\n\t\tdefault:\n\t\t\tval = 0x3;\n\t\t\tbreak;\n\t\t}\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB, val);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWE2, RR_LUTWE2_RTXBW, 0x0);\n\t}\n}\n\nstatic void _lck_keep_thermal(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_lck_info *lck = &rtwdev->lck;\n\tint path;\n\n\tfor (path = 0; path < rtwdev->chip->rf_path_num; path++) {\n\t\tlck->thermal[path] =\n\t\t\tewma_thermal_read(&rtwdev->phystat.avg_thermal[path]);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[LCK] path=%d thermal=0x%x\", path, lck->thermal[path]);\n\t}\n}\n\nstatic void _lck(struct rtw89_dev *rtwdev)\n{\n\tu32 tmp18[2];\n\tint path = rtwdev->dbcc_en ? 2 : 1;\n\tint i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK, \"[LCK] DO LCK\\n\");\n\n\ttmp18[0] = rtw89_read_rf(rtwdev, RF_PATH_A, RR_CFGCH, RFREG_MASK);\n\ttmp18[1] = rtw89_read_rf(rtwdev, RF_PATH_B, RR_CFGCH, RFREG_MASK);\n\n\tfor (i = 0; i < path; i++) {\n\t\trtw89_write_rf(rtwdev, i, RR_LCK_TRG, RR_LCK_TRGSEL, 0x1);\n\t\trtw89_write_rf(rtwdev, i, RR_CFGCH, RFREG_MASK, tmp18[i]);\n\t\trtw89_write_rf(rtwdev, i, RR_LCK_TRG, RR_LCK_TRGSEL, 0x0);\n\t}\n\n\t_lck_keep_thermal(rtwdev);\n}\n\n#define RTW8852C_LCK_TH 8\n\nvoid rtw8852c_lck_track(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_lck_info *lck = &rtwdev->lck;\n\tu8 cur_thermal;\n\tint delta;\n\tint path;\n\n\tfor (path = 0; path < rtwdev->chip->rf_path_num; path++) {\n\t\tcur_thermal =\n\t\t\tewma_thermal_read(&rtwdev->phystat.avg_thermal[path]);\n\t\tdelta = abs((int)cur_thermal - lck->thermal[path]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[LCK] path=%d current thermal=0x%x delta=0x%x\\n\",\n\t\t\t    path, cur_thermal, delta);\n\n\t\tif (delta >= RTW8852C_LCK_TH) {\n\t\t\t_lck(rtwdev);\n\t\t\treturn;\n\t\t}\n\t}\n}\n\nvoid rtw8852c_lck_init(struct rtw89_dev *rtwdev)\n{\n\t_lck_keep_thermal(rtwdev);\n}\n\nstatic\nvoid rtw8852c_ctrl_bw_ch(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t u8 central_ch, enum rtw89_band band,\n\t\t\t enum rtw89_bandwidth bw)\n{\n\t_ctrl_ch(rtwdev, phy, central_ch, band);\n\t_ctrl_bw(rtwdev, phy, bw);\n\t_rxbb_bw(rtwdev, phy, bw);\n}\n\nvoid rtw8852c_set_channel_rf(struct rtw89_dev *rtwdev,\n\t\t\t     const struct rtw89_chan *chan,\n\t\t\t     enum rtw89_phy_idx phy_idx)\n{\n\trtw8852c_ctrl_bw_ch(rtwdev, phy_idx, chan->channel,\n\t\t\t    chan->band_type,\n\t\t\t    chan->band_width);\n}\n\nvoid rtw8852c_mcc_get_ch_info(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_rfk_mcc_info *rfk_mcc = &rtwdev->rfk_mcc;\n\tu8 idx = rfk_mcc->table_idx;\n\tint i;\n\n\tfor (i = 0; i < RTW89_IQK_CHS_NR; i++) {\n\t\tif (rfk_mcc->ch[idx] == 0)\n\t\t\tbreak;\n\t\tif (++idx >= RTW89_IQK_CHS_NR)\n\t\t\tidx = 0;\n\t}\n\n\trfk_mcc->table_idx = idx;\n\trfk_mcc->ch[idx] = chan->channel;\n\trfk_mcc->band[idx] = chan->band_type;\n}\n\nvoid rtw8852c_rck(struct rtw89_dev *rtwdev)\n{\n\tu8 path;\n\n\tfor (path = 0; path < 2; path++)\n\t\t_rck(rtwdev, path);\n}\n\nvoid rtw8852c_dack(struct rtw89_dev *rtwdev)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, RTW89_PHY_0, 0);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_START);\n\t_dac_cal(rtwdev, false);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852c_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu32 tx_en;\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\t_iqk_init(rtwdev);\n\t_iqk(rtwdev, phy_idx, false);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_STOP);\n}\n\n#define RXDCK_VER_8852C 0xe\n\nstatic void _rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t    bool is_afe, u8 retry_limit)\n{\n\tstruct rtw89_rx_dck_info *rx_dck = &rtwdev->rx_dck;\n\tu8 path, kpath;\n\tu32 rf_reg5;\n\tbool is_fail;\n\tu8 rek_cnt;\n\n\tkpath = _kpath(rtwdev, phy);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RX_DCK] ****** RXDCK Start (Ver: 0x%x, Cv: %d) ******\\n\",\n\t\t    RXDCK_VER_8852C, rtwdev->hal.cv);\n\n\tfor (path = 0; path < 2; path++) {\n\t\trf_reg5 = rtw89_read_rf(rtwdev, path, RR_RSV1, RFREG_MASK);\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK + (path << 13),\n\t\t\t\t\t       B_P0_TSSI_TRK_EN, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_LO_SEL, rtwdev->dbcc_en);\n\n\t\tfor (rek_cnt = 0; rek_cnt < retry_limit; rek_cnt++) {\n\t\t\t_set_rx_dck(rtwdev, phy, path, is_afe);\n\n\t\t\t \n\t\t\tif (rek_cnt == retry_limit - 1) {\n\t\t\t\t_rx_dck_recover(rtwdev, path);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tis_fail = _rx_dck_rek_check(rtwdev, path);\n\t\t\tif (!is_fail)\n\t\t\t\tbreak;\n\t\t}\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RX_DCK] rek_cnt[%d]=%d\",\n\t\t\t    path, rek_cnt);\n\n\t\trx_dck->thermal[path] = ewma_thermal_read(&rtwdev->phystat.avg_thermal[path]);\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RFREG_MASK, rf_reg5);\n\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK + (path << 13),\n\t\t\t\t\t       B_P0_TSSI_TRK_EN, 0x0);\n\t}\n}\n\nvoid rtw8852c_rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy, bool is_afe)\n{\n\t_rx_dck(rtwdev, phy, is_afe, 1);\n}\n\n#define RTW8852C_RX_DCK_TH 12\n\nvoid rtw8852c_rx_dck_track(struct rtw89_dev *rtwdev)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_rx_dck_info *rx_dck = &rtwdev->rx_dck;\n\tenum rtw89_phy_idx phy_idx = RTW89_PHY_0;\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\tu8 dck_channel;\n\tu8 cur_thermal;\n\tu32 tx_en;\n\tint delta;\n\tint path;\n\n\tif (chan->band_type == RTW89_BAND_2G)\n\t\treturn;\n\n\tif (rtwdev->scanning)\n\t\treturn;\n\n\tfor (path = 0; path < RF_PATH_NUM_8852C; path++) {\n\t\tcur_thermal =\n\t\t\tewma_thermal_read(&rtwdev->phystat.avg_thermal[path]);\n\t\tdelta = abs((int)cur_thermal - rx_dck->thermal[path]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[RX_DCK] path=%d current thermal=0x%x delta=0x%x\\n\",\n\t\t\t    path, cur_thermal, delta);\n\n\t\tif (delta >= RTW8852C_RX_DCK_TH)\n\t\t\tgoto trigger_rx_dck;\n\t}\n\n\treturn;\n\ntrigger_rx_dck:\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_RXDCK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\n\tfor (path = 0; path < RF_PATH_NUM_8852C; path++) {\n\t\tdck_channel = _rx_dck_channel_calc(rtwdev, chan);\n\t\t_ctrl_ch(rtwdev, RTW89_PHY_0, dck_channel, chan->band_type);\n\t}\n\n\t_rx_dck(rtwdev, RTW89_PHY_0, false, 20);\n\n\tfor (path = 0; path < RF_PATH_NUM_8852C; path++)\n\t\t_ctrl_ch(rtwdev, RTW89_PHY_0, chan->channel, chan->band_type);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_RXDCK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852c_dpk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu32 tx_en;\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\trtwdev->dpk.is_dpk_enable = true;\n\trtwdev->dpk.is_dpk_reload_en = false;\n\t_dpk(rtwdev, phy_idx, false);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852c_dpk_track(struct rtw89_dev *rtwdev)\n{\n\t_dpk_track(rtwdev);\n}\n\nvoid rtw8852c_tssi(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tu32 i, path = RF_PATH_A, path_max = RF_PATH_NUM_8852C;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI] %s: phy=%d\\n\", __func__, phy);\n\n\tif (rtwdev->dbcc_en) {\n\t\tif (phy == RTW89_PHY_0) {\n\t\t\tpath = RF_PATH_A;\n\t\t\tpath_max = RF_PATH_B;\n\t\t} else if (phy == RTW89_PHY_1) {\n\t\t\tpath = RF_PATH_B;\n\t\t\tpath_max = RF_PATH_NUM_8852C;\n\t\t}\n\t}\n\n\t_tssi_disable(rtwdev, phy);\n\n\tfor (i = path; i < path_max; i++) {\n\t\t_tssi_set_sys(rtwdev, phy, i);\n\t\t_tssi_ini_txpwr_ctrl_bb(rtwdev, phy, i);\n\t\t_tssi_ini_txpwr_ctrl_bb_he_tb(rtwdev, phy, i);\n\t\t_tssi_set_dck(rtwdev, phy, i);\n\t\t_tssi_set_bbgain_split(rtwdev, phy, i);\n\t\t_tssi_set_tmeter_tbl(rtwdev, phy, i);\n\t\t_tssi_slope_cal_org(rtwdev, phy, i);\n\t\t_tssi_set_aligk_default(rtwdev, phy, i);\n\t\t_tssi_set_slope(rtwdev, phy, i);\n\t\t_tssi_run_slope(rtwdev, phy, i);\n\t}\n\n\t_tssi_enable(rtwdev, phy);\n\t_tssi_set_efuse_to_de(rtwdev, phy);\n}\n\nvoid rtw8852c_tssi_scan(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tu32 i, path = RF_PATH_A, path_max = RF_PATH_NUM_8852C;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI] %s: phy=%d\\n\",\n\t\t    __func__, phy);\n\n\tif (!rtwdev->is_tssi_mode[RF_PATH_A])\n\t\treturn;\n\tif (!rtwdev->is_tssi_mode[RF_PATH_B])\n\t\treturn;\n\n\tif (rtwdev->dbcc_en) {\n\t\tif (phy == RTW89_PHY_0) {\n\t\t\tpath = RF_PATH_A;\n\t\t\tpath_max = RF_PATH_B;\n\t\t} else if (phy == RTW89_PHY_1) {\n\t\t\tpath = RF_PATH_B;\n\t\t\tpath_max = RF_PATH_NUM_8852C;\n\t\t}\n\t}\n\n\t_tssi_disable(rtwdev, phy);\n\n\tfor (i = path; i < path_max; i++) {\n\t\t_tssi_set_sys(rtwdev, phy, i);\n\t\t_tssi_set_dck(rtwdev, phy, i);\n\t\t_tssi_set_tmeter_tbl(rtwdev, phy, i);\n\t\t_tssi_slope_cal_org(rtwdev, phy, i);\n\t\t_tssi_set_aligk_default(rtwdev, phy, i);\n\t}\n\n\t_tssi_enable(rtwdev, phy);\n\t_tssi_set_efuse_to_de(rtwdev, phy);\n}\n\nstatic void rtw8852c_tssi_default_txagc(struct rtw89_dev *rtwdev,\n\t\t\t\t\tenum rtw89_phy_idx phy, bool enable)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tu8 i;\n\n\tif (!rtwdev->is_tssi_mode[RF_PATH_A] && !rtwdev->is_tssi_mode[RF_PATH_B])\n\t\treturn;\n\n\tif (enable) {\n\t\t \n\t\tif (rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB, B_TXAGC_BB_OFT) != 0xc000 &&\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB, B_TXAGC_BB_OFT) != 0x0) {\n\t\t\tfor (i = 0; i < 6; i++) {\n\t\t\t\ttssi_info->default_txagc_offset[RF_PATH_A] =\n\t\t\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BB,\n\t\t\t\t\t\t\t      B_TXAGC_BB);\n\t\t\t\tif (tssi_info->default_txagc_offset[RF_PATH_A])\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB_S1, B_TXAGC_BB_S1_OFT) != 0xc000 &&\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB_S1, B_TXAGC_BB_S1_OFT) != 0x0) {\n\t\t\tfor (i = 0; i < 6; i++) {\n\t\t\t\ttssi_info->default_txagc_offset[RF_PATH_B] =\n\t\t\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BB_S1,\n\t\t\t\t\t\t\t      B_TXAGC_BB_S1);\n\t\t\t\tif (tssi_info->default_txagc_offset[RF_PATH_B])\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t} else {\n\t\t \n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT,\n\t\t\t\t       tssi_info->default_txagc_offset[RF_PATH_A]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT,\n\t\t\t\t       tssi_info->default_txagc_offset[RF_PATH_B]);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x1);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT_EN, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT_EN, 0x1);\n\t}\n}\n\nvoid rtw8852c_wifi_scan_notify(struct rtw89_dev *rtwdev,\n\t\t\t       bool scan_start, enum rtw89_phy_idx phy_idx)\n{\n\tif (scan_start)\n\t\trtw8852c_tssi_default_txagc(rtwdev, phy_idx, true);\n\telse\n\t\trtw8852c_tssi_default_txagc(rtwdev, phy_idx, false);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}