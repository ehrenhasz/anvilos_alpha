{
  "module_name": "rtw8852c.c",
  "hash_id": "1621f1c81f39f4f9fa73f17e439427bc5df762bac3444c5cffbd70fe9015b763",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtw89/rtw8852c.c",
  "human_readable_source": "\n \n\n#include \"coex.h\"\n#include \"debug.h\"\n#include \"fw.h\"\n#include \"mac.h\"\n#include \"phy.h\"\n#include \"reg.h\"\n#include \"rtw8852c.h\"\n#include \"rtw8852c_rfk.h\"\n#include \"rtw8852c_table.h\"\n#include \"util.h\"\n\n#define RTW8852C_FW_FORMAT_MAX 0\n#define RTW8852C_FW_BASENAME \"rtw89/rtw8852c_fw\"\n#define RTW8852C_MODULE_FIRMWARE \\\n\tRTW8852C_FW_BASENAME \".bin\"\n\nstatic const struct rtw89_hfc_ch_cfg rtw8852c_hfc_chcfg_pcie[] = {\n\t{13, 1614, grp_0},  \n\t{13, 1614, grp_0},  \n\t{13, 1614, grp_0},  \n\t{13, 1614, grp_0},  \n\t{13, 1614, grp_1},  \n\t{13, 1614, grp_1},  \n\t{13, 1614, grp_1},  \n\t{13, 1614, grp_1},  \n\t{13, 1614, grp_0},  \n\t{13, 1614, grp_0},  \n\t{13, 1614, grp_1},  \n\t{13, 1614, grp_1},  \n\t{40, 0, 0}  \n};\n\nstatic const struct rtw89_hfc_pub_cfg rtw8852c_hfc_pubcfg_pcie = {\n\t1614,  \n\t1614,  \n\t3228,  \n\t0  \n};\n\nstatic const struct rtw89_hfc_param_ini rtw8852c_hfc_param_ini_pcie[] = {\n\t[RTW89_QTA_SCC] = {rtw8852c_hfc_chcfg_pcie, &rtw8852c_hfc_pubcfg_pcie,\n\t\t\t   &rtw89_mac_size.hfc_preccfg_pcie, RTW89_HCIFC_POH},\n\t[RTW89_QTA_DLFW] = {NULL, NULL, &rtw89_mac_size.hfc_preccfg_pcie,\n\t\t\t    RTW89_HCIFC_POH},\n\t[RTW89_QTA_INVALID] = {NULL},\n};\n\nstatic const struct rtw89_dle_mem rtw8852c_dle_mem_pcie[] = {\n\t[RTW89_QTA_SCC] = {RTW89_QTA_SCC, &rtw89_mac_size.wde_size19,\n\t\t\t   &rtw89_mac_size.ple_size19, &rtw89_mac_size.wde_qt18,\n\t\t\t   &rtw89_mac_size.wde_qt18, &rtw89_mac_size.ple_qt46,\n\t\t\t   &rtw89_mac_size.ple_qt47},\n\t[RTW89_QTA_DLFW] = {RTW89_QTA_DLFW, &rtw89_mac_size.wde_size18,\n\t\t\t    &rtw89_mac_size.ple_size18, &rtw89_mac_size.wde_qt17,\n\t\t\t    &rtw89_mac_size.wde_qt17, &rtw89_mac_size.ple_qt44,\n\t\t\t    &rtw89_mac_size.ple_qt45},\n\t[RTW89_QTA_INVALID] = {RTW89_QTA_INVALID, NULL, NULL, NULL, NULL, NULL,\n\t\t\t       NULL},\n};\n\nstatic const u32 rtw8852c_h2c_regs[RTW89_H2CREG_MAX] = {\n\tR_AX_H2CREG_DATA0_V1, R_AX_H2CREG_DATA1_V1, R_AX_H2CREG_DATA2_V1,\n\tR_AX_H2CREG_DATA3_V1\n};\n\nstatic const u32 rtw8852c_c2h_regs[RTW89_H2CREG_MAX] = {\n\tR_AX_C2HREG_DATA0_V1, R_AX_C2HREG_DATA1_V1, R_AX_C2HREG_DATA2_V1,\n\tR_AX_C2HREG_DATA3_V1\n};\n\nstatic const struct rtw89_page_regs rtw8852c_page_regs = {\n\t.hci_fc_ctrl\t= R_AX_HCI_FC_CTRL_V1,\n\t.ch_page_ctrl\t= R_AX_CH_PAGE_CTRL_V1,\n\t.ach_page_ctrl\t= R_AX_ACH0_PAGE_CTRL_V1,\n\t.ach_page_info\t= R_AX_ACH0_PAGE_INFO_V1,\n\t.pub_page_info3\t= R_AX_PUB_PAGE_INFO3_V1,\n\t.pub_page_ctrl1\t= R_AX_PUB_PAGE_CTRL1_V1,\n\t.pub_page_ctrl2\t= R_AX_PUB_PAGE_CTRL2_V1,\n\t.pub_page_info1\t= R_AX_PUB_PAGE_INFO1_V1,\n\t.pub_page_info2 = R_AX_PUB_PAGE_INFO2_V1,\n\t.wp_page_ctrl1\t= R_AX_WP_PAGE_CTRL1_V1,\n\t.wp_page_ctrl2\t= R_AX_WP_PAGE_CTRL2_V1,\n\t.wp_page_info1\t= R_AX_WP_PAGE_INFO1_V1,\n};\n\nstatic const struct rtw89_reg_def rtw8852c_dcfo_comp = {\n\tR_DCFO_COMP_S0_V1, B_DCFO_COMP_S0_V1_MSK\n};\n\nstatic const struct rtw89_imr_info rtw8852c_imr_info = {\n\t.wdrls_imr_set\t\t= B_AX_WDRLS_IMR_SET_V1,\n\t.wsec_imr_reg\t\t= R_AX_SEC_ERROR_FLAG_IMR,\n\t.wsec_imr_set\t\t= B_AX_TX_HANG_IMR | B_AX_RX_HANG_IMR,\n\t.mpdu_tx_imr_set\t= B_AX_MPDU_TX_IMR_SET_V1,\n\t.mpdu_rx_imr_set\t= B_AX_MPDU_RX_IMR_SET_V1,\n\t.sta_sch_imr_set\t= B_AX_STA_SCHEDULER_IMR_SET,\n\t.txpktctl_imr_b0_reg\t= R_AX_TXPKTCTL_B0_ERRFLAG_IMR,\n\t.txpktctl_imr_b0_clr\t= B_AX_TXPKTCTL_IMR_B0_CLR_V1,\n\t.txpktctl_imr_b0_set\t= B_AX_TXPKTCTL_IMR_B0_SET_V1,\n\t.txpktctl_imr_b1_reg\t= R_AX_TXPKTCTL_B1_ERRFLAG_IMR,\n\t.txpktctl_imr_b1_clr\t= B_AX_TXPKTCTL_IMR_B1_CLR_V1,\n\t.txpktctl_imr_b1_set\t= B_AX_TXPKTCTL_IMR_B1_SET_V1,\n\t.wde_imr_clr\t\t= B_AX_WDE_IMR_CLR_V1,\n\t.wde_imr_set\t\t= B_AX_WDE_IMR_SET_V1,\n\t.ple_imr_clr\t\t= B_AX_PLE_IMR_CLR_V1,\n\t.ple_imr_set\t\t= B_AX_PLE_IMR_SET_V1,\n\t.host_disp_imr_clr\t= B_AX_HOST_DISP_IMR_CLR_V1,\n\t.host_disp_imr_set\t= B_AX_HOST_DISP_IMR_SET_V1,\n\t.cpu_disp_imr_clr\t= B_AX_CPU_DISP_IMR_CLR_V1,\n\t.cpu_disp_imr_set\t= B_AX_CPU_DISP_IMR_SET_V1,\n\t.other_disp_imr_clr\t= B_AX_OTHER_DISP_IMR_CLR_V1,\n\t.other_disp_imr_set\t= B_AX_OTHER_DISP_IMR_SET_V1,\n\t.bbrpt_com_err_imr_reg\t= R_AX_BBRPT_COM_ERR_IMR,\n\t.bbrpt_chinfo_err_imr_reg = R_AX_BBRPT_CHINFO_ERR_IMR,\n\t.bbrpt_err_imr_set\t= R_AX_BBRPT_CHINFO_IMR_SET_V1,\n\t.bbrpt_dfs_err_imr_reg\t= R_AX_BBRPT_DFS_ERR_IMR,\n\t.ptcl_imr_clr\t\t= B_AX_PTCL_IMR_CLR_V1,\n\t.ptcl_imr_set\t\t= B_AX_PTCL_IMR_SET_V1,\n\t.cdma_imr_0_reg\t\t= R_AX_RX_ERR_FLAG_IMR,\n\t.cdma_imr_0_clr\t\t= B_AX_RX_ERR_IMR_CLR_V1,\n\t.cdma_imr_0_set\t\t= B_AX_RX_ERR_IMR_SET_V1,\n\t.cdma_imr_1_reg\t\t= R_AX_TX_ERR_FLAG_IMR,\n\t.cdma_imr_1_clr\t\t= B_AX_TX_ERR_IMR_CLR_V1,\n\t.cdma_imr_1_set\t\t= B_AX_TX_ERR_IMR_SET_V1,\n\t.phy_intf_imr_reg\t= R_AX_PHYINFO_ERR_IMR_V1,\n\t.phy_intf_imr_clr\t= B_AX_PHYINFO_IMR_CLR_V1,\n\t.phy_intf_imr_set\t= B_AX_PHYINFO_IMR_SET_V1,\n\t.rmac_imr_reg\t\t= R_AX_RX_ERR_IMR,\n\t.rmac_imr_clr\t\t= B_AX_RMAC_IMR_CLR_V1,\n\t.rmac_imr_set\t\t= B_AX_RMAC_IMR_SET_V1,\n\t.tmac_imr_reg\t\t= R_AX_TRXPTCL_ERROR_INDICA_MASK,\n\t.tmac_imr_clr\t\t= B_AX_TMAC_IMR_CLR_V1,\n\t.tmac_imr_set\t\t= B_AX_TMAC_IMR_SET_V1,\n};\n\nstatic const struct rtw89_rrsr_cfgs rtw8852c_rrsr_cfgs = {\n\t.ref_rate = {R_AX_TRXPTCL_RRSR_CTL_0, B_AX_WMAC_RESP_REF_RATE_SEL, 0},\n\t.rsc = {R_AX_PTCL_RRSR1, B_AX_RSC_MASK, 2},\n};\n\nstatic const struct rtw89_dig_regs rtw8852c_dig_regs = {\n\t.seg0_pd_reg = R_SEG0R_PD,\n\t.pd_lower_bound_mask = B_SEG0R_PD_LOWER_BOUND_MSK,\n\t.pd_spatial_reuse_en = B_SEG0R_PD_SPATIAL_REUSE_EN_MSK,\n\t.bmode_pd_reg = R_BMODE_PDTH_EN_V1,\n\t.bmode_cca_rssi_limit_en = B_BMODE_PDTH_LIMIT_EN_MSK_V1,\n\t.bmode_pd_lower_bound_reg = R_BMODE_PDTH_V1,\n\t.bmode_rssi_nocca_low_th_mask = B_BMODE_PDTH_LOWER_BOUND_MSK_V1,\n\t.p0_lna_init = {R_PATH0_LNA_INIT_V1, B_PATH0_LNA_INIT_IDX_MSK},\n\t.p1_lna_init = {R_PATH1_LNA_INIT_V1, B_PATH1_LNA_INIT_IDX_MSK},\n\t.p0_tia_init = {R_PATH0_TIA_INIT_V1, B_PATH0_TIA_INIT_IDX_MSK_V1},\n\t.p1_tia_init = {R_PATH1_TIA_INIT_V1, B_PATH1_TIA_INIT_IDX_MSK_V1},\n\t.p0_rxb_init = {R_PATH0_RXB_INIT_V1, B_PATH0_RXB_INIT_IDX_MSK_V1},\n\t.p1_rxb_init = {R_PATH1_RXB_INIT_V1, B_PATH1_RXB_INIT_IDX_MSK_V1},\n\t.p0_p20_pagcugc_en = {R_PATH0_P20_FOLLOW_BY_PAGCUGC_V1,\n\t\t\t      B_PATH0_P20_FOLLOW_BY_PAGCUGC_EN_MSK},\n\t.p0_s20_pagcugc_en = {R_PATH0_S20_FOLLOW_BY_PAGCUGC_V1,\n\t\t\t      B_PATH0_S20_FOLLOW_BY_PAGCUGC_EN_MSK},\n\t.p1_p20_pagcugc_en = {R_PATH1_P20_FOLLOW_BY_PAGCUGC_V1,\n\t\t\t      B_PATH1_P20_FOLLOW_BY_PAGCUGC_EN_MSK},\n\t.p1_s20_pagcugc_en = {R_PATH1_S20_FOLLOW_BY_PAGCUGC_V1,\n\t\t\t      B_PATH1_S20_FOLLOW_BY_PAGCUGC_EN_MSK},\n};\n\nstatic void rtw8852c_ctrl_btg(struct rtw89_dev *rtwdev, bool btg);\nstatic void rtw8852c_ctrl_tx_path_tmac(struct rtw89_dev *rtwdev, u8 tx_path,\n\t\t\t\t       enum rtw89_mac_idx mac_idx);\n\nstatic int rtw8852c_pwr_on_func(struct rtw89_dev *rtwdev)\n{\n\tu32 val32;\n\tu32 ret;\n\n\tval32 = rtw89_read32_mask(rtwdev, R_AX_SYS_STATUS1, B_AX_PAD_HCI_SEL_V2_MASK);\n\tif (val32 == MAC_AX_HCI_SEL_PCIE_USB)\n\t\trtw89_write32_set(rtwdev, R_AX_LDO_AON_CTRL0, B_AX_PD_REGU_L);\n\n\trtw89_write32_clr(rtwdev, R_AX_SYS_PW_CTRL, B_AX_AFSM_WLSUS_EN |\n\t\t\t\t\t\t    B_AX_AFSM_PCIE_SUS_EN);\n\trtw89_write32_set(rtwdev, R_AX_SYS_PW_CTRL, B_AX_DIS_WLBT_PDNSUSEN_SOPC);\n\trtw89_write32_set(rtwdev, R_AX_WLLPS_CTRL, B_AX_DIS_WLBT_LPSEN_LOPC);\n\trtw89_write32_clr(rtwdev, R_AX_SYS_PW_CTRL, B_AX_APDM_HPDN);\n\trtw89_write32_clr(rtwdev, R_AX_SYS_PW_CTRL, B_AX_APFM_SWLPS);\n\n\tret = read_poll_timeout(rtw89_read32, val32, val32 & B_AX_RDY_SYSPWR,\n\t\t\t\t1000, 20000, false, rtwdev, R_AX_SYS_PW_CTRL);\n\tif (ret)\n\t\treturn ret;\n\n\trtw89_write32_set(rtwdev, R_AX_SYS_PW_CTRL, B_AX_EN_WLON);\n\trtw89_write32_set(rtwdev, R_AX_SYS_PW_CTRL, B_AX_APFN_ONMAC);\n\n\tret = read_poll_timeout(rtw89_read32, val32, !(val32 & B_AX_APFN_ONMAC),\n\t\t\t\t1000, 20000, false, rtwdev, R_AX_SYS_PW_CTRL);\n\tif (ret)\n\t\treturn ret;\n\n\trtw89_write8_set(rtwdev, R_AX_PLATFORM_ENABLE, B_AX_PLATFORM_EN);\n\trtw89_write8_clr(rtwdev, R_AX_PLATFORM_ENABLE, B_AX_PLATFORM_EN);\n\trtw89_write8_set(rtwdev, R_AX_PLATFORM_ENABLE, B_AX_PLATFORM_EN);\n\trtw89_write8_clr(rtwdev, R_AX_PLATFORM_ENABLE, B_AX_PLATFORM_EN);\n\n\trtw89_write8_set(rtwdev, R_AX_PLATFORM_ENABLE, B_AX_PLATFORM_EN);\n\trtw89_write32_clr(rtwdev, R_AX_SYS_SDIO_CTRL, B_AX_PCIE_CALIB_EN_V1);\n\n\trtw89_write32_clr(rtwdev, R_AX_SYS_ISO_CTRL_EXTEND, B_AX_CMAC1_FEN);\n\trtw89_write32_set(rtwdev, R_AX_SYS_ISO_CTRL_EXTEND, B_AX_R_SYM_ISO_CMAC12PP);\n\trtw89_write32_clr(rtwdev, R_AX_AFE_CTRL1, B_AX_R_SYM_WLCMAC1_P4_PC_EN |\n\t\t\t\t\t\t  B_AX_R_SYM_WLCMAC1_P3_PC_EN |\n\t\t\t\t\t\t  B_AX_R_SYM_WLCMAC1_P2_PC_EN |\n\t\t\t\t\t\t  B_AX_R_SYM_WLCMAC1_P1_PC_EN |\n\t\t\t\t\t\t  B_AX_R_SYM_WLCMAC1_PC_EN);\n\trtw89_write32_set(rtwdev, R_AX_SYS_ADIE_PAD_PWR_CTRL, B_AX_SYM_PADPDN_WL_PTA_1P3);\n\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL,\n\t\t\t\t      XTAL_SI_GND_SHDN_WL, XTAL_SI_GND_SHDN_WL);\n\tif (ret)\n\t\treturn ret;\n\n\trtw89_write32_set(rtwdev, R_AX_SYS_ADIE_PAD_PWR_CTRL, B_AX_SYM_PADPDN_WL_RFC_1P3);\n\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL,\n\t\t\t\t      XTAL_SI_SHDN_WL, XTAL_SI_SHDN_WL);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, XTAL_SI_OFF_WEI,\n\t\t\t\t      XTAL_SI_OFF_WEI);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, XTAL_SI_OFF_EI,\n\t\t\t\t      XTAL_SI_OFF_EI);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, 0, XTAL_SI_RFC2RF);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, XTAL_SI_PON_WEI,\n\t\t\t\t      XTAL_SI_PON_WEI);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, XTAL_SI_PON_EI,\n\t\t\t\t      XTAL_SI_PON_EI);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, 0, XTAL_SI_SRAM2RFC);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_XTAL_XMD_2, 0, XTAL_SI_LDO_LPS);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_XTAL_XMD_4, 0, XTAL_SI_LPS_CAP);\n\tif (ret)\n\t\treturn ret;\n\n\trtw89_write32_set(rtwdev, R_AX_PMC_DBG_CTRL2, B_AX_SYSON_DIS_PMCR_AX_WRMSK);\n\trtw89_write32_set(rtwdev, R_AX_SYS_ISO_CTRL, B_AX_ISO_EB2CORE);\n\trtw89_write32_clr(rtwdev, R_AX_SYS_ISO_CTRL, B_AX_PWC_EV2EF_B15);\n\n\tfsleep(1000);\n\n\trtw89_write32_clr(rtwdev, R_AX_SYS_ISO_CTRL, B_AX_PWC_EV2EF_B14);\n\trtw89_write32_clr(rtwdev, R_AX_PMC_DBG_CTRL2, B_AX_SYSON_DIS_PMCR_AX_WRMSK);\n\trtw89_write32_set(rtwdev, R_AX_GPIO0_15_EECS_EESK_LED1_PULL_LOW_EN,\n\t\t\t  B_AX_EECS_PULL_LOW_EN | B_AX_EESK_PULL_LOW_EN |\n\t\t\t  B_AX_LED1_PULL_LOW_EN);\n\n\trtw89_write32_set(rtwdev, R_AX_DMAC_FUNC_EN,\n\t\t\t  B_AX_MAC_FUNC_EN | B_AX_DMAC_FUNC_EN | B_AX_MPDU_PROC_EN |\n\t\t\t  B_AX_WD_RLS_EN | B_AX_DLE_WDE_EN | B_AX_TXPKT_CTRL_EN |\n\t\t\t  B_AX_STA_SCH_EN | B_AX_DLE_PLE_EN | B_AX_PKT_BUF_EN |\n\t\t\t  B_AX_DMAC_TBL_EN | B_AX_PKT_IN_EN | B_AX_DLE_CPUIO_EN |\n\t\t\t  B_AX_DISPATCHER_EN | B_AX_BBRPT_EN | B_AX_MAC_SEC_EN |\n\t\t\t  B_AX_MAC_UN_EN | B_AX_H_AXIDMA_EN);\n\n\trtw89_write32_set(rtwdev, R_AX_CMAC_FUNC_EN,\n\t\t\t  B_AX_CMAC_EN | B_AX_CMAC_TXEN | B_AX_CMAC_RXEN |\n\t\t\t  B_AX_FORCE_CMACREG_GCKEN | B_AX_PHYINTF_EN |\n\t\t\t  B_AX_CMAC_DMA_EN | B_AX_PTCLTOP_EN | B_AX_SCHEDULER_EN |\n\t\t\t  B_AX_TMAC_EN | B_AX_RMAC_EN);\n\n\trtw89_write32_mask(rtwdev, R_AX_LED1_FUNC_SEL, B_AX_PINMUX_EESK_FUNC_SEL_V1_MASK,\n\t\t\t   PINMUX_EESK_FUNC_SEL_BT_LOG);\n\n\treturn 0;\n}\n\nstatic int rtw8852c_pwr_off_func(struct rtw89_dev *rtwdev)\n{\n\tu32 val32;\n\tu32 ret;\n\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, XTAL_SI_RFC2RF,\n\t\t\t\t      XTAL_SI_RFC2RF);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, 0, XTAL_SI_OFF_EI);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, 0, XTAL_SI_OFF_WEI);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_WL_RFC_S0, 0, XTAL_SI_RF00);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_WL_RFC_S1, 0, XTAL_SI_RF10);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, XTAL_SI_SRAM2RFC,\n\t\t\t\t      XTAL_SI_SRAM2RFC);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, 0, XTAL_SI_PON_EI);\n\tif (ret)\n\t\treturn ret;\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, 0, XTAL_SI_PON_WEI);\n\tif (ret)\n\t\treturn ret;\n\n\trtw89_write32_set(rtwdev, R_AX_SYS_PW_CTRL, B_AX_EN_WLON);\n\trtw89_write8_clr(rtwdev, R_AX_SYS_FUNC_EN, B_AX_FEN_BB_GLB_RSTN | B_AX_FEN_BBRSTB);\n\trtw89_write32_clr(rtwdev, R_AX_SYS_ISO_CTRL_EXTEND,\n\t\t\t  B_AX_R_SYM_FEN_WLBBGLB_1 | B_AX_R_SYM_FEN_WLBBFUN_1);\n\trtw89_write32_clr(rtwdev, R_AX_SYS_ADIE_PAD_PWR_CTRL, B_AX_SYM_PADPDN_WL_RFC_1P3);\n\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, 0, XTAL_SI_SHDN_WL);\n\tif (ret)\n\t\treturn ret;\n\n\trtw89_write32_clr(rtwdev, R_AX_SYS_ADIE_PAD_PWR_CTRL, B_AX_SYM_PADPDN_WL_PTA_1P3);\n\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, 0, XTAL_SI_GND_SHDN_WL);\n\tif (ret)\n\t\treturn ret;\n\n\trtw89_write32_set(rtwdev, R_AX_SYS_PW_CTRL, B_AX_APFM_OFFMAC);\n\n\tret = read_poll_timeout(rtw89_read32, val32, !(val32 & B_AX_APFM_OFFMAC),\n\t\t\t\t1000, 20000, false, rtwdev, R_AX_SYS_PW_CTRL);\n\tif (ret)\n\t\treturn ret;\n\n\trtw89_write32(rtwdev, R_AX_WLLPS_CTRL, 0x0001A0B0);\n\trtw89_write32_set(rtwdev, R_AX_SYS_PW_CTRL, B_AX_XTAL_OFF_A_DIE);\n\trtw89_write32_set(rtwdev, R_AX_SYS_PW_CTRL, B_AX_APFM_SWLPS);\n\n\treturn 0;\n}\n\nstatic void rtw8852c_e_efuse_parsing(struct rtw89_efuse *efuse,\n\t\t\t\t     struct rtw8852c_efuse *map)\n{\n\tether_addr_copy(efuse->addr, map->e.mac_addr);\n\tefuse->rfe_type = map->rfe_type;\n\tefuse->xtal_cap = map->xtal_k;\n}\n\nstatic void rtw8852c_efuse_parsing_tssi(struct rtw89_dev *rtwdev,\n\t\t\t\t\tstruct rtw8852c_efuse *map)\n{\n\tstruct rtw89_tssi_info *tssi = &rtwdev->tssi;\n\tstruct rtw8852c_tssi_offset *ofst[] = {&map->path_a_tssi, &map->path_b_tssi};\n\tu8 *bw40_1s_tssi_6g_ofst[] = {map->bw40_1s_tssi_6g_a, map->bw40_1s_tssi_6g_b};\n\tu8 i, j;\n\n\ttssi->thermal[RF_PATH_A] = map->path_a_therm;\n\ttssi->thermal[RF_PATH_B] = map->path_b_therm;\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++) {\n\t\tmemcpy(tssi->tssi_cck[i], ofst[i]->cck_tssi,\n\t\t       sizeof(ofst[i]->cck_tssi));\n\n\t\tfor (j = 0; j < TSSI_CCK_CH_GROUP_NUM; j++)\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI][EFUSE] path=%d cck[%d]=0x%x\\n\",\n\t\t\t\t    i, j, tssi->tssi_cck[i][j]);\n\n\t\tmemcpy(tssi->tssi_mcs[i], ofst[i]->bw40_tssi,\n\t\t       sizeof(ofst[i]->bw40_tssi));\n\t\tmemcpy(tssi->tssi_mcs[i] + TSSI_MCS_2G_CH_GROUP_NUM,\n\t\t       ofst[i]->bw40_1s_tssi_5g, sizeof(ofst[i]->bw40_1s_tssi_5g));\n\t\tmemcpy(tssi->tssi_6g_mcs[i], bw40_1s_tssi_6g_ofst[i],\n\t\t       sizeof(tssi->tssi_6g_mcs[i]));\n\n\t\tfor (j = 0; j < TSSI_MCS_CH_GROUP_NUM; j++)\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI][EFUSE] path=%d mcs[%d]=0x%x\\n\",\n\t\t\t\t    i, j, tssi->tssi_mcs[i][j]);\n\t}\n}\n\nstatic bool _decode_efuse_gain(u8 data, s8 *high, s8 *low)\n{\n\tif (high)\n\t\t*high = sign_extend32(FIELD_GET(GENMASK(7,  4), data), 3);\n\tif (low)\n\t\t*low = sign_extend32(FIELD_GET(GENMASK(3,  0), data), 3);\n\n\treturn data != 0xff;\n}\n\nstatic void rtw8852c_efuse_parsing_gain_offset(struct rtw89_dev *rtwdev,\n\t\t\t\t\t       struct rtw8852c_efuse *map)\n{\n\tstruct rtw89_phy_efuse_gain *gain = &rtwdev->efuse_gain;\n\tbool valid = false;\n\n\tvalid |= _decode_efuse_gain(map->rx_gain_2g_cck,\n\t\t\t\t    &gain->offset[RF_PATH_A][RTW89_GAIN_OFFSET_2G_CCK],\n\t\t\t\t    &gain->offset[RF_PATH_B][RTW89_GAIN_OFFSET_2G_CCK]);\n\tvalid |= _decode_efuse_gain(map->rx_gain_2g_ofdm,\n\t\t\t\t    &gain->offset[RF_PATH_A][RTW89_GAIN_OFFSET_2G_OFDM],\n\t\t\t\t    &gain->offset[RF_PATH_B][RTW89_GAIN_OFFSET_2G_OFDM]);\n\tvalid |= _decode_efuse_gain(map->rx_gain_5g_low,\n\t\t\t\t    &gain->offset[RF_PATH_A][RTW89_GAIN_OFFSET_5G_LOW],\n\t\t\t\t    &gain->offset[RF_PATH_B][RTW89_GAIN_OFFSET_5G_LOW]);\n\tvalid |= _decode_efuse_gain(map->rx_gain_5g_mid,\n\t\t\t\t    &gain->offset[RF_PATH_A][RTW89_GAIN_OFFSET_5G_MID],\n\t\t\t\t    &gain->offset[RF_PATH_B][RTW89_GAIN_OFFSET_5G_MID]);\n\tvalid |= _decode_efuse_gain(map->rx_gain_5g_high,\n\t\t\t\t    &gain->offset[RF_PATH_A][RTW89_GAIN_OFFSET_5G_HIGH],\n\t\t\t\t    &gain->offset[RF_PATH_B][RTW89_GAIN_OFFSET_5G_HIGH]);\n\n\tgain->offset_valid = valid;\n}\n\nstatic int rtw8852c_read_efuse(struct rtw89_dev *rtwdev, u8 *log_map)\n{\n\tstruct rtw89_efuse *efuse = &rtwdev->efuse;\n\tstruct rtw8852c_efuse *map;\n\n\tmap = (struct rtw8852c_efuse *)log_map;\n\n\tefuse->country_code[0] = map->country_code[0];\n\tefuse->country_code[1] = map->country_code[1];\n\trtw8852c_efuse_parsing_tssi(rtwdev, map);\n\trtw8852c_efuse_parsing_gain_offset(rtwdev, map);\n\n\tswitch (rtwdev->hci.type) {\n\tcase RTW89_HCI_TYPE_PCIE:\n\t\trtw8852c_e_efuse_parsing(efuse, map);\n\t\tbreak;\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n\n\trtw89_info(rtwdev, \"chip rfe_type is %d\\n\", efuse->rfe_type);\n\n\treturn 0;\n}\n\nstatic void rtw8852c_phycap_parsing_tssi(struct rtw89_dev *rtwdev, u8 *phycap_map)\n{\n\tstruct rtw89_tssi_info *tssi = &rtwdev->tssi;\n\tstatic const u32 tssi_trim_addr[RF_PATH_NUM_8852C] = {0x5D6, 0x5AB};\n\tstatic const u32 tssi_trim_addr_6g[RF_PATH_NUM_8852C] = {0x5CE, 0x5A3};\n\tu32 addr = rtwdev->chip->phycap_addr;\n\tbool pg = false;\n\tu32 ofst;\n\tu8 i, j;\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++) {\n\t\tfor (j = 0; j < TSSI_TRIM_CH_GROUP_NUM; j++) {\n\t\t\t \n\t\t\tofst = tssi_trim_addr[i] - addr - j;\n\t\t\ttssi->tssi_trim[i][j] = phycap_map[ofst];\n\n\t\t\tif (phycap_map[ofst] != 0xff)\n\t\t\t\tpg = true;\n\t\t}\n\n\t\tfor (j = 0; j < TSSI_TRIM_CH_GROUP_NUM_6G; j++) {\n\t\t\t \n\t\t\tofst = tssi_trim_addr_6g[i] - addr - j;\n\t\t\ttssi->tssi_trim_6g[i][j] = phycap_map[ofst];\n\n\t\t\tif (phycap_map[ofst] != 0xff)\n\t\t\t\tpg = true;\n\t\t}\n\t}\n\n\tif (!pg) {\n\t\tmemset(tssi->tssi_trim, 0, sizeof(tssi->tssi_trim));\n\t\tmemset(tssi->tssi_trim_6g, 0, sizeof(tssi->tssi_trim_6g));\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM] no PG, set all trim info to 0\\n\");\n\t}\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++)\n\t\tfor (j = 0; j < TSSI_TRIM_CH_GROUP_NUM; j++)\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t    \"[TSSI] path=%d idx=%d trim=0x%x addr=0x%x\\n\",\n\t\t\t\t    i, j, tssi->tssi_trim[i][j],\n\t\t\t\t    tssi_trim_addr[i] - j);\n}\n\nstatic void rtw8852c_phycap_parsing_thermal_trim(struct rtw89_dev *rtwdev,\n\t\t\t\t\t\t u8 *phycap_map)\n{\n\tstruct rtw89_power_trim_info *info = &rtwdev->pwr_trim;\n\tstatic const u32 thm_trim_addr[RF_PATH_NUM_8852C] = {0x5DF, 0x5DC};\n\tu32 addr = rtwdev->chip->phycap_addr;\n\tu8 i;\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++) {\n\t\tinfo->thermal_trim[i] = phycap_map[thm_trim_addr[i] - addr];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[THERMAL][TRIM] path=%d thermal_trim=0x%x\\n\",\n\t\t\t    i, info->thermal_trim[i]);\n\n\t\tif (info->thermal_trim[i] != 0xff)\n\t\t\tinfo->pg_thermal_trim = true;\n\t}\n}\n\nstatic void rtw8852c_thermal_trim(struct rtw89_dev *rtwdev)\n{\n#define __thm_setting(raw)\t\t\t\t\\\n({\t\t\t\t\t\t\t\\\n\tu8 __v = (raw);\t\t\t\t\t\\\n\t((__v & 0x1) << 3) | ((__v & 0x1f) >> 1);\t\\\n})\n\tstruct rtw89_power_trim_info *info = &rtwdev->pwr_trim;\n\tu8 i, val;\n\n\tif (!info->pg_thermal_trim) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[THERMAL][TRIM] no PG, do nothing\\n\");\n\n\t\treturn;\n\t}\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++) {\n\t\tval = __thm_setting(info->thermal_trim[i]);\n\t\trtw89_write_rf(rtwdev, i, RR_TM2, RR_TM2_OFF, val);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[THERMAL][TRIM] path=%d thermal_setting=0x%x\\n\",\n\t\t\t    i, val);\n\t}\n#undef __thm_setting\n}\n\nstatic void rtw8852c_phycap_parsing_pa_bias_trim(struct rtw89_dev *rtwdev,\n\t\t\t\t\t\t u8 *phycap_map)\n{\n\tstruct rtw89_power_trim_info *info = &rtwdev->pwr_trim;\n\tstatic const u32 pabias_trim_addr[RF_PATH_NUM_8852C] = {0x5DE, 0x5DB};\n\tu32 addr = rtwdev->chip->phycap_addr;\n\tu8 i;\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++) {\n\t\tinfo->pa_bias_trim[i] = phycap_map[pabias_trim_addr[i] - addr];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[PA_BIAS][TRIM] path=%d pa_bias_trim=0x%x\\n\",\n\t\t\t    i, info->pa_bias_trim[i]);\n\n\t\tif (info->pa_bias_trim[i] != 0xff)\n\t\t\tinfo->pg_pa_bias_trim = true;\n\t}\n}\n\nstatic void rtw8852c_pa_bias_trim(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_power_trim_info *info = &rtwdev->pwr_trim;\n\tu8 pabias_2g, pabias_5g;\n\tu8 i;\n\n\tif (!info->pg_pa_bias_trim) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[PA_BIAS][TRIM] no PG, do nothing\\n\");\n\n\t\treturn;\n\t}\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++) {\n\t\tpabias_2g = FIELD_GET(GENMASK(3, 0), info->pa_bias_trim[i]);\n\t\tpabias_5g = FIELD_GET(GENMASK(7, 4), info->pa_bias_trim[i]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[PA_BIAS][TRIM] path=%d 2G=0x%x 5G=0x%x\\n\",\n\t\t\t    i, pabias_2g, pabias_5g);\n\n\t\trtw89_write_rf(rtwdev, i, RR_BIASA, RR_BIASA_TXG, pabias_2g);\n\t\trtw89_write_rf(rtwdev, i, RR_BIASA, RR_BIASA_TXA, pabias_5g);\n\t}\n}\n\nstatic int rtw8852c_read_phycap(struct rtw89_dev *rtwdev, u8 *phycap_map)\n{\n\trtw8852c_phycap_parsing_tssi(rtwdev, phycap_map);\n\trtw8852c_phycap_parsing_thermal_trim(rtwdev, phycap_map);\n\trtw8852c_phycap_parsing_pa_bias_trim(rtwdev, phycap_map);\n\n\treturn 0;\n}\n\nstatic void rtw8852c_power_trim(struct rtw89_dev *rtwdev)\n{\n\trtw8852c_thermal_trim(rtwdev);\n\trtw8852c_pa_bias_trim(rtwdev);\n}\n\nstatic void rtw8852c_set_channel_mac(struct rtw89_dev *rtwdev,\n\t\t\t\t     const struct rtw89_chan *chan,\n\t\t\t\t     u8 mac_idx)\n{\n\tu32 rf_mod = rtw89_mac_reg_by_idx(rtwdev, R_AX_WMAC_RFMOD, mac_idx);\n\tu32 sub_carr = rtw89_mac_reg_by_idx(rtwdev, R_AX_TX_SUB_CARRIER_VALUE, mac_idx);\n\tu32 chk_rate = rtw89_mac_reg_by_idx(rtwdev, R_AX_TXRATE_CHK, mac_idx);\n\tu8 txsc20 = 0, txsc40 = 0, txsc80 = 0;\n\tu8 rf_mod_val = 0, chk_rate_mask = 0;\n\tu32 txsc;\n\n\tswitch (chan->band_width) {\n\tcase RTW89_CHANNEL_WIDTH_160:\n\t\ttxsc80 = rtw89_phy_get_txsc(rtwdev, chan,\n\t\t\t\t\t    RTW89_CHANNEL_WIDTH_80);\n\t\tfallthrough;\n\tcase RTW89_CHANNEL_WIDTH_80:\n\t\ttxsc40 = rtw89_phy_get_txsc(rtwdev, chan,\n\t\t\t\t\t    RTW89_CHANNEL_WIDTH_40);\n\t\tfallthrough;\n\tcase RTW89_CHANNEL_WIDTH_40:\n\t\ttxsc20 = rtw89_phy_get_txsc(rtwdev, chan,\n\t\t\t\t\t    RTW89_CHANNEL_WIDTH_20);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tswitch (chan->band_width) {\n\tcase RTW89_CHANNEL_WIDTH_160:\n\t\trf_mod_val = AX_WMAC_RFMOD_160M;\n\t\ttxsc = FIELD_PREP(B_AX_TXSC_20M_MASK, txsc20) |\n\t\t       FIELD_PREP(B_AX_TXSC_40M_MASK, txsc40) |\n\t\t       FIELD_PREP(B_AX_TXSC_80M_MASK, txsc80);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_80:\n\t\trf_mod_val = AX_WMAC_RFMOD_80M;\n\t\ttxsc = FIELD_PREP(B_AX_TXSC_20M_MASK, txsc20) |\n\t\t       FIELD_PREP(B_AX_TXSC_40M_MASK, txsc40);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_40:\n\t\trf_mod_val = AX_WMAC_RFMOD_40M;\n\t\ttxsc = FIELD_PREP(B_AX_TXSC_20M_MASK, txsc20);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_20:\n\tdefault:\n\t\trf_mod_val = AX_WMAC_RFMOD_20M;\n\t\ttxsc = 0;\n\t\tbreak;\n\t}\n\trtw89_write8_mask(rtwdev, rf_mod, B_AX_WMAC_RFMOD_MASK, rf_mod_val);\n\trtw89_write32(rtwdev, sub_carr, txsc);\n\n\tswitch (chan->band_type) {\n\tcase RTW89_BAND_2G:\n\t\tchk_rate_mask = B_AX_BAND_MODE;\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\tcase RTW89_BAND_6G:\n\t\tchk_rate_mask = B_AX_CHECK_CCK_EN | B_AX_RTS_LIMIT_IN_OFDM6;\n\t\tbreak;\n\tdefault:\n\t\trtw89_warn(rtwdev, \"Invalid band_type:%d\\n\", chan->band_type);\n\t\treturn;\n\t}\n\trtw89_write8_clr(rtwdev, chk_rate, B_AX_BAND_MODE | B_AX_CHECK_CCK_EN |\n\t\t\t\t\t   B_AX_RTS_LIMIT_IN_OFDM6);\n\trtw89_write8_set(rtwdev, chk_rate, chk_rate_mask);\n}\n\nstatic const u32 rtw8852c_sco_barker_threshold[14] = {\n\t0x1fe4f, 0x1ff5e, 0x2006c, 0x2017b, 0x2028a, 0x20399, 0x204a8, 0x205b6,\n\t0x206c5, 0x207d4, 0x208e3, 0x209f2, 0x20b00, 0x20d8a\n};\n\nstatic const u32 rtw8852c_sco_cck_threshold[14] = {\n\t0x2bdac, 0x2bf21, 0x2c095, 0x2c209, 0x2c37e, 0x2c4f2, 0x2c666, 0x2c7db,\n\t0x2c94f, 0x2cac3, 0x2cc38, 0x2cdac, 0x2cf21, 0x2d29e\n};\n\nstatic int rtw8852c_ctrl_sco_cck(struct rtw89_dev *rtwdev, u8 central_ch,\n\t\t\t\t u8 primary_ch, enum rtw89_bandwidth bw)\n{\n\tu8 ch_element;\n\n\tif (bw == RTW89_CHANNEL_WIDTH_20) {\n\t\tch_element = central_ch - 1;\n\t} else if (bw == RTW89_CHANNEL_WIDTH_40) {\n\t\tif (primary_ch == 1)\n\t\t\tch_element = central_ch - 1 + 2;\n\t\telse\n\t\t\tch_element = central_ch - 1 - 2;\n\t} else {\n\t\trtw89_warn(rtwdev, \"Invalid BW:%d for CCK\\n\", bw);\n\t\treturn -EINVAL;\n\t}\n\trtw89_phy_write32_mask(rtwdev, R_BK_FC0_INV_V1, B_BK_FC0_INV_MSK_V1,\n\t\t\t       rtw8852c_sco_barker_threshold[ch_element]);\n\trtw89_phy_write32_mask(rtwdev, R_CCK_FC0_INV_V1, B_CCK_FC0_INV_MSK_V1,\n\t\t\t       rtw8852c_sco_cck_threshold[ch_element]);\n\n\treturn 0;\n}\n\nstruct rtw8852c_bb_gain {\n\tu32 gain_g[BB_PATH_NUM_8852C];\n\tu32 gain_a[BB_PATH_NUM_8852C];\n\tu32 gain_mask;\n};\n\nstatic const struct rtw8852c_bb_gain bb_gain_lna[LNA_GAIN_NUM] = {\n\t{ .gain_g = {0x4678, 0x475C}, .gain_a = {0x45DC, 0x4740},\n\t  .gain_mask = 0x00ff0000 },\n\t{ .gain_g = {0x4678, 0x475C}, .gain_a = {0x45DC, 0x4740},\n\t  .gain_mask = 0xff000000 },\n\t{ .gain_g = {0x467C, 0x4760}, .gain_a = {0x4660, 0x4744},\n\t  .gain_mask = 0x000000ff },\n\t{ .gain_g = {0x467C, 0x4760}, .gain_a = {0x4660, 0x4744},\n\t  .gain_mask = 0x0000ff00 },\n\t{ .gain_g = {0x467C, 0x4760}, .gain_a = {0x4660, 0x4744},\n\t  .gain_mask = 0x00ff0000 },\n\t{ .gain_g = {0x467C, 0x4760}, .gain_a = {0x4660, 0x4744},\n\t  .gain_mask = 0xff000000 },\n\t{ .gain_g = {0x4680, 0x4764}, .gain_a = {0x4664, 0x4748},\n\t  .gain_mask = 0x000000ff },\n};\n\nstatic const struct rtw8852c_bb_gain bb_gain_tia[TIA_GAIN_NUM] = {\n\t{ .gain_g = {0x4680, 0x4764}, .gain_a = {0x4664, 0x4748},\n\t  .gain_mask = 0x00ff0000 },\n\t{ .gain_g = {0x4680, 0x4764}, .gain_a = {0x4664, 0x4748},\n\t  .gain_mask = 0xff000000 },\n};\n\nstruct rtw8852c_bb_gain_bypass {\n\tu32 gain_g[BB_PATH_NUM_8852C];\n\tu32 gain_a[BB_PATH_NUM_8852C];\n\tu32 gain_mask_g;\n\tu32 gain_mask_a;\n};\n\nstatic\nconst struct rtw8852c_bb_gain_bypass bb_gain_bypass_lna[LNA_GAIN_NUM] = {\n\t{ .gain_g = {0x4BB8, 0x4C7C}, .gain_a = {0x4BB4, 0x4C78},\n\t  .gain_mask_g = 0xff000000, .gain_mask_a = 0xff},\n\t{ .gain_g = {0x4BBC, 0x4C80}, .gain_a = {0x4BB4, 0x4C78},\n\t  .gain_mask_g = 0xff, .gain_mask_a = 0xff00},\n\t{ .gain_g = {0x4BBC, 0x4C80}, .gain_a = {0x4BB4, 0x4C78},\n\t  .gain_mask_g = 0xff00, .gain_mask_a = 0xff0000},\n\t{ .gain_g = {0x4BBC, 0x4C80}, .gain_a = {0x4BB4, 0x4C78},\n\t  .gain_mask_g = 0xff0000, .gain_mask_a = 0xff000000},\n\t{ .gain_g = {0x4BBC, 0x4C80}, .gain_a = {0x4BB8, 0x4C7C},\n\t  .gain_mask_g = 0xff000000, .gain_mask_a = 0xff},\n\t{ .gain_g = {0x4BC0, 0x4C84}, .gain_a = {0x4BB8, 0x4C7C},\n\t  .gain_mask_g = 0xff, .gain_mask_a = 0xff00},\n\t{ .gain_g = {0x4BC0, 0x4C84}, .gain_a = {0x4BB8, 0x4C7C},\n\t  .gain_mask_g = 0xff00, .gain_mask_a = 0xff0000},\n};\n\nstruct rtw8852c_bb_gain_op1db {\n\tstruct {\n\t\tu32 lna[BB_PATH_NUM_8852C];\n\t\tu32 tia_lna[BB_PATH_NUM_8852C];\n\t\tu32 mask;\n\t} reg[LNA_GAIN_NUM];\n\tu32 reg_tia0_lna6[BB_PATH_NUM_8852C];\n\tu32 mask_tia0_lna6;\n};\n\nstatic const struct rtw8852c_bb_gain_op1db bb_gain_op1db_a = {\n\t.reg = {\n\t\t{ .lna = {0x4668, 0x474c}, .tia_lna = {0x4670, 0x4754},\n\t\t  .mask = 0xff},\n\t\t{ .lna = {0x4668, 0x474c}, .tia_lna = {0x4670, 0x4754},\n\t\t  .mask = 0xff00},\n\t\t{ .lna = {0x4668, 0x474c}, .tia_lna = {0x4670, 0x4754},\n\t\t  .mask = 0xff0000},\n\t\t{ .lna = {0x4668, 0x474c}, .tia_lna = {0x4670, 0x4754},\n\t\t  .mask = 0xff000000},\n\t\t{ .lna = {0x466c, 0x4750}, .tia_lna = {0x4674, 0x4758},\n\t\t  .mask = 0xff},\n\t\t{ .lna = {0x466c, 0x4750}, .tia_lna = {0x4674, 0x4758},\n\t\t  .mask = 0xff00},\n\t\t{ .lna = {0x466c, 0x4750}, .tia_lna = {0x4674, 0x4758},\n\t\t  .mask = 0xff0000},\n\t},\n\t.reg_tia0_lna6 = {0x4674, 0x4758},\n\t.mask_tia0_lna6 = 0xff000000,\n};\n\nstatic void rtw8852c_set_gain_error(struct rtw89_dev *rtwdev,\n\t\t\t\t    enum rtw89_subband subband,\n\t\t\t\t    enum rtw89_rf_path path)\n{\n\tconst struct rtw89_phy_bb_gain_info *gain = &rtwdev->bb_gain;\n\tu8 gain_band = rtw89_subband_to_bb_gain_band(subband);\n\ts32 val;\n\tu32 reg;\n\tu32 mask;\n\tint i;\n\n\tfor (i = 0; i < LNA_GAIN_NUM; i++) {\n\t\tif (subband == RTW89_CH_2G)\n\t\t\treg = bb_gain_lna[i].gain_g[path];\n\t\telse\n\t\t\treg = bb_gain_lna[i].gain_a[path];\n\n\t\tmask = bb_gain_lna[i].gain_mask;\n\t\tval = gain->lna_gain[gain_band][path][i];\n\t\trtw89_phy_write32_mask(rtwdev, reg, mask, val);\n\n\t\tif (subband == RTW89_CH_2G) {\n\t\t\treg = bb_gain_bypass_lna[i].gain_g[path];\n\t\t\tmask = bb_gain_bypass_lna[i].gain_mask_g;\n\t\t} else {\n\t\t\treg = bb_gain_bypass_lna[i].gain_a[path];\n\t\t\tmask = bb_gain_bypass_lna[i].gain_mask_a;\n\t\t}\n\n\t\tval = gain->lna_gain_bypass[gain_band][path][i];\n\t\trtw89_phy_write32_mask(rtwdev, reg, mask, val);\n\n\t\tif (subband != RTW89_CH_2G) {\n\t\t\treg = bb_gain_op1db_a.reg[i].lna[path];\n\t\t\tmask = bb_gain_op1db_a.reg[i].mask;\n\t\t\tval = gain->lna_op1db[gain_band][path][i];\n\t\t\trtw89_phy_write32_mask(rtwdev, reg, mask, val);\n\n\t\t\treg = bb_gain_op1db_a.reg[i].tia_lna[path];\n\t\t\tmask = bb_gain_op1db_a.reg[i].mask;\n\t\t\tval = gain->tia_lna_op1db[gain_band][path][i];\n\t\t\trtw89_phy_write32_mask(rtwdev, reg, mask, val);\n\t\t}\n\t}\n\n\tif (subband != RTW89_CH_2G) {\n\t\treg = bb_gain_op1db_a.reg_tia0_lna6[path];\n\t\tmask = bb_gain_op1db_a.mask_tia0_lna6;\n\t\tval = gain->tia_lna_op1db[gain_band][path][7];\n\t\trtw89_phy_write32_mask(rtwdev, reg, mask, val);\n\t}\n\n\tfor (i = 0; i < TIA_GAIN_NUM; i++) {\n\t\tif (subband == RTW89_CH_2G)\n\t\t\treg = bb_gain_tia[i].gain_g[path];\n\t\telse\n\t\t\treg = bb_gain_tia[i].gain_a[path];\n\n\t\tmask = bb_gain_tia[i].gain_mask;\n\t\tval = gain->tia_gain[gain_band][path][i];\n\t\trtw89_phy_write32_mask(rtwdev, reg, mask, val);\n\t}\n}\n\nstatic void rtw8852c_set_gain_offset(struct rtw89_dev *rtwdev,\n\t\t\t\t     const struct rtw89_chan *chan,\n\t\t\t\t     enum rtw89_phy_idx phy_idx,\n\t\t\t\t     enum rtw89_rf_path path)\n{\n\tstatic const u32 rssi_ofst_addr[2] = {R_PATH0_G_TIA0_LNA6_OP1DB_V1,\n\t\t\t\t\t      R_PATH1_G_TIA0_LNA6_OP1DB_V1};\n\tstatic const u32 rpl_mask[2] = {B_RPL_PATHA_MASK, B_RPL_PATHB_MASK};\n\tstatic const u32 rpl_tb_mask[2] = {B_RSSI_M_PATHA_MASK, B_RSSI_M_PATHB_MASK};\n\tstruct rtw89_phy_efuse_gain *efuse_gain = &rtwdev->efuse_gain;\n\tenum rtw89_gain_offset gain_band;\n\ts32 offset_q0, offset_base_q4;\n\ts32 tmp = 0;\n\n\tif (!efuse_gain->offset_valid)\n\t\treturn;\n\n\tif (rtwdev->dbcc_en && path == RF_PATH_B)\n\t\tphy_idx = RTW89_PHY_1;\n\n\tif (chan->band_type == RTW89_BAND_2G) {\n\t\toffset_q0 = efuse_gain->offset[path][RTW89_GAIN_OFFSET_2G_CCK];\n\t\toffset_base_q4 = efuse_gain->offset_base[phy_idx];\n\n\t\ttmp = clamp_t(s32, (-offset_q0 << 3) + (offset_base_q4 >> 1),\n\t\t\t      S8_MIN >> 1, S8_MAX >> 1);\n\t\trtw89_phy_write32_mask(rtwdev, R_RPL_OFST, B_RPL_OFST_MASK, tmp & 0x7f);\n\t}\n\n\tgain_band = rtw89_subband_to_gain_offset_band_of_ofdm(chan->subband_type);\n\n\toffset_q0 = -efuse_gain->offset[path][gain_band];\n\toffset_base_q4 = efuse_gain->offset_base[phy_idx];\n\n\ttmp = (offset_q0 << 2) + (offset_base_q4 >> 2);\n\ttmp = clamp_t(s32, -tmp, S8_MIN, S8_MAX);\n\trtw89_phy_write32_mask(rtwdev, rssi_ofst_addr[path], B_PATH0_R_G_OFST_MASK, tmp & 0xff);\n\n\ttmp = clamp_t(s32, offset_q0 << 4, S8_MIN, S8_MAX);\n\trtw89_phy_write32_idx(rtwdev, R_RPL_PATHAB, rpl_mask[path], tmp & 0xff, phy_idx);\n\trtw89_phy_write32_idx(rtwdev, R_RSSI_M_PATHAB, rpl_tb_mask[path], tmp & 0xff, phy_idx);\n}\n\nstatic void rtw8852c_ctrl_ch(struct rtw89_dev *rtwdev,\n\t\t\t     const struct rtw89_chan *chan,\n\t\t\t     enum rtw89_phy_idx phy_idx)\n{\n\tu8 sco;\n\tu16 central_freq = chan->freq;\n\tu8 central_ch = chan->channel;\n\tu8 band = chan->band_type;\n\tu8 subband = chan->subband_type;\n\tbool is_2g = band == RTW89_BAND_2G;\n\tu8 chan_idx;\n\n\tif (!central_freq) {\n\t\trtw89_warn(rtwdev, \"Invalid central_freq\\n\");\n\t\treturn;\n\t}\n\n\tif (phy_idx == RTW89_PHY_0) {\n\t\t \n\t\trtw8852c_set_gain_error(rtwdev, subband, RF_PATH_A);\n\t\trtw8852c_set_gain_offset(rtwdev, chan, phy_idx, RF_PATH_A);\n\n\t\tif (is_2g)\n\t\t\trtw89_phy_write32_idx(rtwdev, R_PATH0_BAND_SEL_V1,\n\t\t\t\t\t      B_PATH0_BAND_SEL_MSK_V1, 1,\n\t\t\t\t\t      phy_idx);\n\t\telse\n\t\t\trtw89_phy_write32_idx(rtwdev, R_PATH0_BAND_SEL_V1,\n\t\t\t\t\t      B_PATH0_BAND_SEL_MSK_V1, 0,\n\t\t\t\t\t      phy_idx);\n\t\t \n\t\tif (!rtwdev->dbcc_en) {\n\t\t\trtw8852c_set_gain_error(rtwdev, subband, RF_PATH_B);\n\t\t\trtw8852c_set_gain_offset(rtwdev, chan, phy_idx, RF_PATH_B);\n\n\t\t\tif (is_2g)\n\t\t\t\trtw89_phy_write32_idx(rtwdev,\n\t\t\t\t\t\t      R_PATH1_BAND_SEL_V1,\n\t\t\t\t\t\t      B_PATH1_BAND_SEL_MSK_V1,\n\t\t\t\t\t\t      1, phy_idx);\n\t\t\telse\n\t\t\t\trtw89_phy_write32_idx(rtwdev,\n\t\t\t\t\t\t      R_PATH1_BAND_SEL_V1,\n\t\t\t\t\t\t      B_PATH1_BAND_SEL_MSK_V1,\n\t\t\t\t\t\t      0, phy_idx);\n\t\t\trtw89_phy_write32_clr(rtwdev, R_2P4G_BAND, B_2P4G_BAND_SEL);\n\t\t} else {\n\t\t\tif (is_2g)\n\t\t\t\trtw89_phy_write32_clr(rtwdev, R_2P4G_BAND, B_2P4G_BAND_SEL);\n\t\t\telse\n\t\t\t\trtw89_phy_write32_set(rtwdev, R_2P4G_BAND, B_2P4G_BAND_SEL);\n\t\t}\n\t\t \n\t\trtw89_phy_write32_idx(rtwdev, R_FC0_V1, B_FC0_MSK_V1,\n\t\t\t\t      central_freq, phy_idx);\n\t\t \n\t\tsco = DIV_ROUND_CLOSEST(1 << 18, central_freq);\n\t\trtw89_phy_write32_idx(rtwdev, R_FC0_BW, B_FC0_BW_INV, sco,\n\t\t\t\t      phy_idx);\n\t} else {\n\t\t \n\t\trtw8852c_set_gain_error(rtwdev, subband, RF_PATH_B);\n\t\trtw8852c_set_gain_offset(rtwdev, chan, phy_idx, RF_PATH_B);\n\n\t\tif (is_2g)\n\t\t\trtw89_phy_write32_idx(rtwdev, R_PATH1_BAND_SEL_V1,\n\t\t\t\t\t      B_PATH1_BAND_SEL_MSK_V1,\n\t\t\t\t\t      1, phy_idx);\n\t\telse\n\t\t\trtw89_phy_write32_idx(rtwdev, R_PATH1_BAND_SEL_V1,\n\t\t\t\t\t      B_PATH1_BAND_SEL_MSK_V1,\n\t\t\t\t\t      0, phy_idx);\n\t\t \n\t\trtw89_phy_write32_idx(rtwdev, R_FC0_V1, B_FC0_MSK_V1,\n\t\t\t\t      central_freq, phy_idx);\n\t\t \n\t\tsco = DIV_ROUND_CLOSEST(1 << 18, central_freq);\n\t\trtw89_phy_write32_idx(rtwdev, R_FC0_BW, B_FC0_BW_INV, sco,\n\t\t\t\t      phy_idx);\n\t}\n\t \n\tif (band == RTW89_BAND_2G) {\n\t\tif (central_ch == 14) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFF0_V1,\n\t\t\t\t\t       B_PCOEFF01_MSK_V1, 0x3b13ff);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFF2_V1,\n\t\t\t\t\t       B_PCOEFF23_MSK_V1, 0x1c42de);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFF4_V1,\n\t\t\t\t\t       B_PCOEFF45_MSK_V1, 0xfdb0ad);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFF6_V1,\n\t\t\t\t\t       B_PCOEFF67_MSK_V1, 0xf60f6e);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFF8_V1,\n\t\t\t\t\t       B_PCOEFF89_MSK_V1, 0xfd8f92);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFFA_V1,\n\t\t\t\t\t       B_PCOEFFAB_MSK_V1, 0x2d011);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFFC_V1,\n\t\t\t\t\t       B_PCOEFFCD_MSK_V1, 0x1c02c);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFFE_V1,\n\t\t\t\t\t       B_PCOEFFEF_MSK_V1, 0xfff00a);\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFF0_V1,\n\t\t\t\t\t       B_PCOEFF01_MSK_V1, 0x3d23ff);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFF2_V1,\n\t\t\t\t\t       B_PCOEFF23_MSK_V1, 0x29b354);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFF4_V1,\n\t\t\t\t\t       B_PCOEFF45_MSK_V1, 0xfc1c8);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFF6_V1,\n\t\t\t\t\t       B_PCOEFF67_MSK_V1, 0xfdb053);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFF8_V1,\n\t\t\t\t\t       B_PCOEFF89_MSK_V1, 0xf86f9a);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFFA_V1,\n\t\t\t\t\t       B_PCOEFFAB_MSK_V1, 0xfaef92);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFFC_V1,\n\t\t\t\t\t       B_PCOEFFCD_MSK_V1, 0xfe5fcc);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PCOEFFE_V1,\n\t\t\t\t\t       B_PCOEFFEF_MSK_V1, 0xffdff5);\n\t\t}\n\t}\n\n\tchan_idx = rtw89_encode_chan_idx(rtwdev, chan->primary_channel, band);\n\trtw89_phy_write32_idx(rtwdev, R_MAC_PIN_SEL, B_CH_IDX_SEG0, chan_idx, phy_idx);\n}\n\nstatic void rtw8852c_bw_setting(struct rtw89_dev *rtwdev, u8 bw, u8 path)\n{\n\tstatic const u32 adc_sel[2] = {0xC0EC, 0xC1EC};\n\tstatic const u32 wbadc_sel[2] = {0xC0E4, 0xC1E4};\n\n\tswitch (bw) {\n\tcase RTW89_CHANNEL_WIDTH_5:\n\t\trtw89_phy_write32_mask(rtwdev, adc_sel[path], 0x6000, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, wbadc_sel[path], 0x30, 0x0);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_10:\n\t\trtw89_phy_write32_mask(rtwdev, adc_sel[path], 0x6000, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, wbadc_sel[path], 0x30, 0x1);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_20:\n\tcase RTW89_CHANNEL_WIDTH_40:\n\tcase RTW89_CHANNEL_WIDTH_80:\n\tcase RTW89_CHANNEL_WIDTH_160:\n\t\trtw89_phy_write32_mask(rtwdev, adc_sel[path], 0x6000, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, wbadc_sel[path], 0x30, 0x2);\n\t\tbreak;\n\tdefault:\n\t\trtw89_warn(rtwdev, \"Fail to set ADC\\n\");\n\t}\n}\n\nstatic void rtw8852c_edcca_per20_bitmap_sifs(struct rtw89_dev *rtwdev, u8 bw,\n\t\t\t\t\t     enum rtw89_phy_idx phy_idx)\n{\n\tif (bw == RTW89_CHANNEL_WIDTH_20) {\n\t\trtw89_phy_write32_idx(rtwdev, R_SNDCCA_A1, B_SNDCCA_A1_EN, 0xff, phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_SNDCCA_A2, B_SNDCCA_A2_VAL, 0, phy_idx);\n\t} else {\n\t\trtw89_phy_write32_idx(rtwdev, R_SNDCCA_A1, B_SNDCCA_A1_EN, 0, phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_SNDCCA_A2, B_SNDCCA_A2_VAL, 0, phy_idx);\n\t}\n}\n\nstatic void\nrtw8852c_ctrl_bw(struct rtw89_dev *rtwdev, u8 pri_ch, u8 bw,\n\t\t enum rtw89_phy_idx phy_idx)\n{\n\tu8 mod_sbw = 0;\n\n\tswitch (bw) {\n\tcase RTW89_CHANNEL_WIDTH_5:\n\tcase RTW89_CHANNEL_WIDTH_10:\n\tcase RTW89_CHANNEL_WIDTH_20:\n\t\tif (bw == RTW89_CHANNEL_WIDTH_5)\n\t\t\tmod_sbw = 0x1;\n\t\telse if (bw == RTW89_CHANNEL_WIDTH_10)\n\t\t\tmod_sbw = 0x2;\n\t\telse if (bw == RTW89_CHANNEL_WIDTH_20)\n\t\t\tmod_sbw = 0x0;\n\t\trtw89_phy_write32_idx(rtwdev, R_FC0_BW, B_FC0_BW_SET, 0x0,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_CHBW_MOD, B_CHBW_MOD_SBW,\n\t\t\t\t      mod_sbw, phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_CHBW_MOD, B_CHBW_MOD_PRICH, 0x0,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_SAMPL_DLY_T_V1,\n\t\t\t\t       B_PATH0_SAMPL_DLY_T_MSK_V1, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_SAMPL_DLY_T_V1,\n\t\t\t\t       B_PATH1_SAMPL_DLY_T_MSK_V1, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_BW_SEL_V1,\n\t\t\t\t       B_PATH0_BW_SEL_MSK_V1, 0xf);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BW_SEL_V1,\n\t\t\t\t       B_PATH1_BW_SEL_MSK_V1, 0xf);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_40:\n\t\trtw89_phy_write32_idx(rtwdev, R_FC0_BW, B_FC0_BW_SET, 0x1,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_CHBW_MOD, B_CHBW_MOD_SBW, 0x0,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_CHBW_MOD, B_CHBW_MOD_PRICH,\n\t\t\t\t      pri_ch,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_SAMPL_DLY_T_V1,\n\t\t\t\t       B_PATH0_SAMPL_DLY_T_MSK_V1, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_SAMPL_DLY_T_V1,\n\t\t\t\t       B_PATH1_SAMPL_DLY_T_MSK_V1, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_BW_SEL_V1,\n\t\t\t\t       B_PATH0_BW_SEL_MSK_V1, 0xf);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BW_SEL_V1,\n\t\t\t\t       B_PATH1_BW_SEL_MSK_V1, 0xf);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_80:\n\t\trtw89_phy_write32_idx(rtwdev, R_FC0_BW, B_FC0_BW_SET, 0x2,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_CHBW_MOD, B_CHBW_MOD_SBW, 0x0,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_CHBW_MOD, B_CHBW_MOD_PRICH,\n\t\t\t\t      pri_ch,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_SAMPL_DLY_T_V1,\n\t\t\t\t       B_PATH0_SAMPL_DLY_T_MSK_V1, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_SAMPL_DLY_T_V1,\n\t\t\t\t       B_PATH1_SAMPL_DLY_T_MSK_V1, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_BW_SEL_V1,\n\t\t\t\t       B_PATH0_BW_SEL_MSK_V1, 0xd);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BW_SEL_V1,\n\t\t\t\t       B_PATH1_BW_SEL_MSK_V1, 0xd);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_160:\n\t\trtw89_phy_write32_idx(rtwdev, R_FC0_BW, B_FC0_BW_SET, 0x3,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_CHBW_MOD, B_CHBW_MOD_SBW, 0x0,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_CHBW_MOD, B_CHBW_MOD_PRICH,\n\t\t\t\t      pri_ch,\n\t\t\t\t      phy_idx);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_SAMPL_DLY_T_V1,\n\t\t\t\t       B_PATH0_SAMPL_DLY_T_MSK_V1, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_SAMPL_DLY_T_V1,\n\t\t\t\t       B_PATH1_SAMPL_DLY_T_MSK_V1, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_BW_SEL_V1,\n\t\t\t\t       B_PATH0_BW_SEL_MSK_V1, 0xb);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BW_SEL_V1,\n\t\t\t\t       B_PATH1_BW_SEL_MSK_V1, 0xb);\n\t\tbreak;\n\tdefault:\n\t\trtw89_warn(rtwdev, \"Fail to switch bw (bw:%d, pri ch:%d)\\n\", bw,\n\t\t\t   pri_ch);\n\t}\n\n\tif (bw == RTW89_CHANNEL_WIDTH_40) {\n\t\trtw89_phy_write32_idx(rtwdev, R_RX_BW40_2XFFT_EN_V1,\n\t\t\t\t      B_RX_BW40_2XFFT_EN_MSK_V1, 0x1, phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_T2F_GI_COMB, B_T2F_GI_COMB_EN, 1, phy_idx);\n\t} else {\n\t\trtw89_phy_write32_idx(rtwdev, R_RX_BW40_2XFFT_EN_V1,\n\t\t\t\t      B_RX_BW40_2XFFT_EN_MSK_V1, 0x0, phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_T2F_GI_COMB, B_T2F_GI_COMB_EN, 0, phy_idx);\n\t}\n\n\tif (phy_idx == RTW89_PHY_0) {\n\t\trtw8852c_bw_setting(rtwdev, bw, RF_PATH_A);\n\t\tif (!rtwdev->dbcc_en)\n\t\t\trtw8852c_bw_setting(rtwdev, bw, RF_PATH_B);\n\t} else {\n\t\trtw8852c_bw_setting(rtwdev, bw, RF_PATH_B);\n\t}\n\n\trtw8852c_edcca_per20_bitmap_sifs(rtwdev, bw, phy_idx);\n}\n\nstatic u32 rtw8852c_spur_freq(struct rtw89_dev *rtwdev,\n\t\t\t      const struct rtw89_chan *chan)\n{\n\tu8 center_chan = chan->channel;\n\tu8 bw = chan->band_width;\n\n\tswitch (chan->band_type) {\n\tcase RTW89_BAND_2G:\n\t\tif (bw == RTW89_CHANNEL_WIDTH_20) {\n\t\t\tif (center_chan >= 5 && center_chan <= 8)\n\t\t\t\treturn 2440;\n\t\t\tif (center_chan == 13)\n\t\t\t\treturn 2480;\n\t\t} else if (bw == RTW89_CHANNEL_WIDTH_40) {\n\t\t\tif (center_chan >= 3 && center_chan <= 10)\n\t\t\t\treturn 2440;\n\t\t}\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\tif (center_chan == 151 || center_chan == 153 ||\n\t\t    center_chan == 155 || center_chan == 163)\n\t\t\treturn 5760;\n\t\tbreak;\n\tcase RTW89_BAND_6G:\n\t\tif (center_chan == 195 || center_chan == 197 ||\n\t\t    center_chan == 199 || center_chan == 207)\n\t\t\treturn 6920;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n#define CARRIER_SPACING_312_5 312500  \n#define CARRIER_SPACING_78_125 78125  \n#define MAX_TONE_NUM 2048\n\nstatic void rtw8852c_set_csi_tone_idx(struct rtw89_dev *rtwdev,\n\t\t\t\t      const struct rtw89_chan *chan,\n\t\t\t\t      enum rtw89_phy_idx phy_idx)\n{\n\tu32 spur_freq;\n\ts32 freq_diff, csi_idx, csi_tone_idx;\n\n\tspur_freq = rtw8852c_spur_freq(rtwdev, chan);\n\tif (spur_freq == 0) {\n\t\trtw89_phy_write32_idx(rtwdev, R_SEG0CSI_EN, B_SEG0CSI_EN, 0, phy_idx);\n\t\treturn;\n\t}\n\n\tfreq_diff = (spur_freq - chan->freq) * 1000000;\n\tcsi_idx = s32_div_u32_round_closest(freq_diff, CARRIER_SPACING_78_125);\n\ts32_div_u32_round_down(csi_idx, MAX_TONE_NUM, &csi_tone_idx);\n\n\trtw89_phy_write32_idx(rtwdev, R_SEG0CSI, B_SEG0CSI_IDX, csi_tone_idx, phy_idx);\n\trtw89_phy_write32_idx(rtwdev, R_SEG0CSI_EN, B_SEG0CSI_EN, 1, phy_idx);\n}\n\nstatic const struct rtw89_nbi_reg_def rtw8852c_nbi_reg_def[] = {\n\t[RF_PATH_A] = {\n\t\t.notch1_idx = {0x4C14, 0xFF},\n\t\t.notch1_frac_idx = {0x4C14, 0xC00},\n\t\t.notch1_en = {0x4C14, 0x1000},\n\t\t.notch2_idx = {0x4C20, 0xFF},\n\t\t.notch2_frac_idx = {0x4C20, 0xC00},\n\t\t.notch2_en = {0x4C20, 0x1000},\n\t},\n\t[RF_PATH_B] = {\n\t\t.notch1_idx = {0x4CD8, 0xFF},\n\t\t.notch1_frac_idx = {0x4CD8, 0xC00},\n\t\t.notch1_en = {0x4CD8, 0x1000},\n\t\t.notch2_idx = {0x4CE4, 0xFF},\n\t\t.notch2_frac_idx = {0x4CE4, 0xC00},\n\t\t.notch2_en = {0x4CE4, 0x1000},\n\t},\n};\n\nstatic void rtw8852c_set_nbi_tone_idx(struct rtw89_dev *rtwdev,\n\t\t\t\t      const struct rtw89_chan *chan,\n\t\t\t\t      enum rtw89_rf_path path)\n{\n\tconst struct rtw89_nbi_reg_def *nbi = &rtw8852c_nbi_reg_def[path];\n\tu32 spur_freq, fc;\n\ts32 freq_diff;\n\ts32 nbi_idx, nbi_tone_idx;\n\ts32 nbi_frac_idx, nbi_frac_tone_idx;\n\tbool notch2_chk = false;\n\n\tspur_freq = rtw8852c_spur_freq(rtwdev, chan);\n\tif (spur_freq == 0) {\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch1_en.addr, nbi->notch1_en.mask, 0);\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch1_en.addr, nbi->notch1_en.mask, 0);\n\t\treturn;\n\t}\n\n\tfc = chan->freq;\n\tif (chan->band_width == RTW89_CHANNEL_WIDTH_160) {\n\t\tfc = (spur_freq > fc) ? fc + 40 : fc - 40;\n\t\tif ((fc > spur_freq &&\n\t\t     chan->channel < chan->primary_channel) ||\n\t\t    (fc < spur_freq &&\n\t\t     chan->channel > chan->primary_channel))\n\t\t\tnotch2_chk = true;\n\t}\n\n\tfreq_diff = (spur_freq - fc) * 1000000;\n\tnbi_idx = s32_div_u32_round_down(freq_diff, CARRIER_SPACING_312_5, &nbi_frac_idx);\n\n\tif (chan->band_width == RTW89_CHANNEL_WIDTH_20) {\n\t\ts32_div_u32_round_down(nbi_idx + 32, 64, &nbi_tone_idx);\n\t} else {\n\t\tu16 tone_para = (chan->band_width == RTW89_CHANNEL_WIDTH_40) ?\n\t\t\t\t128 : 256;\n\n\t\ts32_div_u32_round_down(nbi_idx, tone_para, &nbi_tone_idx);\n\t}\n\tnbi_frac_tone_idx = s32_div_u32_round_closest(nbi_frac_idx, CARRIER_SPACING_78_125);\n\n\tif (chan->band_width == RTW89_CHANNEL_WIDTH_160 && notch2_chk) {\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch2_idx.addr,\n\t\t\t\t       nbi->notch2_idx.mask, nbi_tone_idx);\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch2_frac_idx.addr,\n\t\t\t\t       nbi->notch2_frac_idx.mask, nbi_frac_tone_idx);\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch2_en.addr, nbi->notch2_en.mask, 0);\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch2_en.addr, nbi->notch2_en.mask, 1);\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch1_en.addr, nbi->notch1_en.mask, 0);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch1_idx.addr,\n\t\t\t\t       nbi->notch1_idx.mask, nbi_tone_idx);\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch1_frac_idx.addr,\n\t\t\t\t       nbi->notch1_frac_idx.mask, nbi_frac_tone_idx);\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch1_en.addr, nbi->notch1_en.mask, 0);\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch1_en.addr, nbi->notch1_en.mask, 1);\n\t\trtw89_phy_write32_mask(rtwdev, nbi->notch2_en.addr, nbi->notch2_en.mask, 0);\n\t}\n}\n\nstatic void rtw8852c_spur_notch(struct rtw89_dev *rtwdev, u32 val,\n\t\t\t\tenum rtw89_phy_idx phy_idx)\n{\n\tu32 notch;\n\tu32 notch2;\n\n\tif (phy_idx == RTW89_PHY_0) {\n\t\tnotch = R_PATH0_NOTCH;\n\t\tnotch2 = R_PATH0_NOTCH2;\n\t} else {\n\t\tnotch = R_PATH1_NOTCH;\n\t\tnotch2 = R_PATH1_NOTCH2;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, notch,\n\t\t\t       B_PATH0_NOTCH_VAL | B_PATH0_NOTCH_EN, val);\n\trtw89_phy_write32_set(rtwdev, notch, B_PATH0_NOTCH_EN);\n\trtw89_phy_write32_mask(rtwdev, notch2,\n\t\t\t       B_PATH0_NOTCH2_VAL | B_PATH0_NOTCH2_EN, val);\n\trtw89_phy_write32_set(rtwdev, notch2, B_PATH0_NOTCH2_EN);\n}\n\nstatic void rtw8852c_spur_elimination(struct rtw89_dev *rtwdev,\n\t\t\t\t      const struct rtw89_chan *chan,\n\t\t\t\t      u8 pri_ch_idx,\n\t\t\t\t      enum rtw89_phy_idx phy_idx)\n{\n\trtw8852c_set_csi_tone_idx(rtwdev, chan, phy_idx);\n\n\tif (phy_idx == RTW89_PHY_0) {\n\t\tif (chan->band_width == RTW89_CHANNEL_WIDTH_160 &&\n\t\t    (pri_ch_idx == RTW89_SC_20_LOWER ||\n\t\t     pri_ch_idx == RTW89_SC_20_UP3X)) {\n\t\t\trtw8852c_spur_notch(rtwdev, 0xe7f, RTW89_PHY_0);\n\t\t\tif (!rtwdev->dbcc_en)\n\t\t\t\trtw8852c_spur_notch(rtwdev, 0xe7f, RTW89_PHY_1);\n\t\t} else if (chan->band_width == RTW89_CHANNEL_WIDTH_160 &&\n\t\t\t   (pri_ch_idx == RTW89_SC_20_UPPER ||\n\t\t\t    pri_ch_idx == RTW89_SC_20_LOW3X)) {\n\t\t\trtw8852c_spur_notch(rtwdev, 0x280, RTW89_PHY_0);\n\t\t\tif (!rtwdev->dbcc_en)\n\t\t\t\trtw8852c_spur_notch(rtwdev, 0x280, RTW89_PHY_1);\n\t\t} else {\n\t\t\trtw8852c_set_nbi_tone_idx(rtwdev, chan, RF_PATH_A);\n\t\t\tif (!rtwdev->dbcc_en)\n\t\t\t\trtw8852c_set_nbi_tone_idx(rtwdev, chan,\n\t\t\t\t\t\t\t  RF_PATH_B);\n\t\t}\n\t} else {\n\t\tif (chan->band_width == RTW89_CHANNEL_WIDTH_160 &&\n\t\t    (pri_ch_idx == RTW89_SC_20_LOWER ||\n\t\t     pri_ch_idx == RTW89_SC_20_UP3X)) {\n\t\t\trtw8852c_spur_notch(rtwdev, 0xe7f, RTW89_PHY_1);\n\t\t} else if (chan->band_width == RTW89_CHANNEL_WIDTH_160 &&\n\t\t\t   (pri_ch_idx == RTW89_SC_20_UPPER ||\n\t\t\t    pri_ch_idx == RTW89_SC_20_LOW3X)) {\n\t\t\trtw8852c_spur_notch(rtwdev, 0x280, RTW89_PHY_1);\n\t\t} else {\n\t\t\trtw8852c_set_nbi_tone_idx(rtwdev, chan, RF_PATH_B);\n\t\t}\n\t}\n\n\tif (pri_ch_idx == RTW89_SC_20_UP3X || pri_ch_idx == RTW89_SC_20_LOW3X)\n\t\trtw89_phy_write32_idx(rtwdev, R_PD_BOOST_EN, B_PD_BOOST_EN, 0, phy_idx);\n\telse\n\t\trtw89_phy_write32_idx(rtwdev, R_PD_BOOST_EN, B_PD_BOOST_EN, 1, phy_idx);\n}\n\nstatic void rtw8852c_5m_mask(struct rtw89_dev *rtwdev,\n\t\t\t     const struct rtw89_chan *chan,\n\t\t\t     enum rtw89_phy_idx phy_idx)\n{\n\tu8 pri_ch = chan->pri_ch_idx;\n\tbool mask_5m_low;\n\tbool mask_5m_en;\n\n\tswitch (chan->band_width) {\n\tcase RTW89_CHANNEL_WIDTH_40:\n\t\tmask_5m_en = true;\n\t\tmask_5m_low = pri_ch == RTW89_SC_20_LOWER;\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_80:\n\t\tmask_5m_en = pri_ch == RTW89_SC_20_UPMOST ||\n\t\t\t     pri_ch == RTW89_SC_20_LOWEST;\n\t\tmask_5m_low = pri_ch == RTW89_SC_20_LOWEST;\n\t\tbreak;\n\tdefault:\n\t\tmask_5m_en = false;\n\t\tmask_5m_low = false;\n\t\tbreak;\n\t}\n\n\tif (!mask_5m_en) {\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_5MDET, B_PATH0_5MDET_EN, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_5MDET, B_PATH1_5MDET_EN, 0x0);\n\t\trtw89_phy_write32_idx(rtwdev, R_ASSIGN_SBD_OPT,\n\t\t\t\t      B_ASSIGN_SBD_OPT_EN, 0x0, phy_idx);\n\t} else {\n\t\tif (mask_5m_low) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_5MDET, B_PATH0_5MDET_TH, 0x4);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_5MDET, B_PATH0_5MDET_EN, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_5MDET, B_PATH0_5MDET_SB2, 0x0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_5MDET, B_PATH0_5MDET_SB0, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_5MDET, B_PATH1_5MDET_TH, 0x4);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_5MDET, B_PATH1_5MDET_EN, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_5MDET, B_PATH1_5MDET_SB2, 0x0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_5MDET, B_PATH1_5MDET_SB0, 0x1);\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_5MDET, B_PATH0_5MDET_TH, 0x4);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_5MDET, B_PATH0_5MDET_EN, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_5MDET, B_PATH0_5MDET_SB2, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_5MDET, B_PATH0_5MDET_SB0, 0x0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_5MDET, B_PATH1_5MDET_TH, 0x4);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_5MDET, B_PATH1_5MDET_EN, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_5MDET, B_PATH1_5MDET_SB2, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_5MDET, B_PATH1_5MDET_SB0, 0x0);\n\t\t}\n\t\trtw89_phy_write32_idx(rtwdev, R_ASSIGN_SBD_OPT, B_ASSIGN_SBD_OPT_EN, 0x1, phy_idx);\n\t}\n}\n\nstatic void rtw8852c_bb_reset_all(struct rtw89_dev *rtwdev,\n\t\t\t\t  enum rtw89_phy_idx phy_idx)\n{\n\t \n\trtw89_phy_write32_mask(rtwdev, R_S0_HW_SI_DIS, B_S0_HW_SI_DIS_W_R_TRIG,\n\t\t\t       0x7);\n\trtw89_phy_write32_mask(rtwdev, R_S1_HW_SI_DIS, B_S1_HW_SI_DIS_W_R_TRIG,\n\t\t\t       0x7);\n\n\tudelay(1);\n\n\trtw89_phy_write32_idx(rtwdev, R_RSTB_ASYNC, B_RSTB_ASYNC_ALL, 1,\n\t\t\t      phy_idx);\n\trtw89_phy_write32_idx(rtwdev, R_RSTB_ASYNC, B_RSTB_ASYNC_ALL, 0,\n\t\t\t      phy_idx);\n\t \n\trtw89_phy_write32_mask(rtwdev, R_S0_HW_SI_DIS, B_S0_HW_SI_DIS_W_R_TRIG,\n\t\t\t       0x0);\n\trtw89_phy_write32_mask(rtwdev, R_S1_HW_SI_DIS, B_S1_HW_SI_DIS_W_R_TRIG,\n\t\t\t       0x0);\n\n\trtw89_phy_write32_idx(rtwdev, R_RSTB_ASYNC, B_RSTB_ASYNC_ALL, 1,\n\t\t\t      phy_idx);\n}\n\nstatic void rtw8852c_bb_reset_en(struct rtw89_dev *rtwdev, enum rtw89_band band,\n\t\t\t\t enum rtw89_phy_idx phy_idx, bool en)\n{\n\tif (en) {\n\t\trtw89_phy_write32_idx(rtwdev, R_S0_HW_SI_DIS,\n\t\t\t\t      B_S0_HW_SI_DIS_W_R_TRIG, 0x0, phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_S1_HW_SI_DIS,\n\t\t\t\t      B_S1_HW_SI_DIS_W_R_TRIG, 0x0, phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_RSTB_ASYNC, B_RSTB_ASYNC_ALL, 1,\n\t\t\t\t      phy_idx);\n\t\tif (band == RTW89_BAND_2G)\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXCCA_V1, B_RXCCA_DIS_V1, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_PD_CTRL, B_PD_HIT_DIS, 0x0);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXCCA_V1, B_RXCCA_DIS_V1, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_PD_CTRL, B_PD_HIT_DIS, 0x1);\n\t\trtw89_phy_write32_idx(rtwdev, R_S0_HW_SI_DIS,\n\t\t\t\t      B_S0_HW_SI_DIS_W_R_TRIG, 0x7, phy_idx);\n\t\trtw89_phy_write32_idx(rtwdev, R_S1_HW_SI_DIS,\n\t\t\t\t      B_S1_HW_SI_DIS_W_R_TRIG, 0x7, phy_idx);\n\t\tfsleep(1);\n\t\trtw89_phy_write32_idx(rtwdev, R_RSTB_ASYNC, B_RSTB_ASYNC_ALL, 0,\n\t\t\t\t      phy_idx);\n\t}\n}\n\nstatic void rtw8852c_bb_reset(struct rtw89_dev *rtwdev,\n\t\t\t      enum rtw89_phy_idx phy_idx)\n{\n\trtw8852c_bb_reset_all(rtwdev, phy_idx);\n}\n\nstatic\nvoid rtw8852c_bb_gpio_trsw(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t\t   u8 tx_path_en, u8 trsw_tx,\n\t\t\t   u8 trsw_rx, u8 trsw, u8 trsw_b)\n{\n\tstatic const u32 path_cr_bases[] = {0x5868, 0x7868};\n\tu32 mask_ofst = 16;\n\tu32 cr;\n\tu32 val;\n\n\tif (path >= ARRAY_SIZE(path_cr_bases))\n\t\treturn;\n\n\tcr = path_cr_bases[path];\n\n\tmask_ofst += (tx_path_en * 4 + trsw_tx * 2 + trsw_rx) * 2;\n\tval = FIELD_PREP(B_P0_TRSW_A, trsw) | FIELD_PREP(B_P0_TRSW_B, trsw_b);\n\n\trtw89_phy_write32_mask(rtwdev, cr, (B_P0_TRSW_A | B_P0_TRSW_B) << mask_ofst, val);\n}\n\nenum rtw8852c_rfe_src {\n\tPAPE_RFM,\n\tTRSW_RFM,\n\tLNAON_RFM,\n};\n\nstatic\nvoid rtw8852c_bb_gpio_rfm(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t\t  enum rtw8852c_rfe_src src, u8 dis_tx_gnt_wl,\n\t\t\t  u8 active_tx_opt, u8 act_bt_en, u8 rfm_output_val)\n{\n\tstatic const u32 path_cr_bases[] = {0x5894, 0x7894};\n\tstatic const u32 masks[] = {0, 8, 16};\n\tu32 mask, mask_ofst;\n\tu32 cr;\n\tu32 val;\n\n\tif (src >= ARRAY_SIZE(masks) || path >= ARRAY_SIZE(path_cr_bases))\n\t\treturn;\n\n\tmask_ofst = masks[src];\n\tcr = path_cr_bases[path];\n\n\tval = FIELD_PREP(B_P0_RFM_DIS_WL, dis_tx_gnt_wl) |\n\t      FIELD_PREP(B_P0_RFM_TX_OPT, active_tx_opt) |\n\t      FIELD_PREP(B_P0_RFM_BT_EN, act_bt_en) |\n\t      FIELD_PREP(B_P0_RFM_OUT, rfm_output_val);\n\tmask = 0xff << mask_ofst;\n\n\trtw89_phy_write32_mask(rtwdev, cr, mask, val);\n}\n\nstatic void rtw8852c_bb_gpio_init(struct rtw89_dev *rtwdev)\n{\n\tstatic const u32 cr_bases[] = {0x5800, 0x7800};\n\tu32 addr;\n\tu8 i;\n\n\tfor (i = 0; i < ARRAY_SIZE(cr_bases); i++) {\n\t\taddr = cr_bases[i];\n\t\trtw89_phy_write32_set(rtwdev, (addr | 0x68), B_P0_TRSW_A);\n\t\trtw89_phy_write32_clr(rtwdev, (addr | 0x68), B_P0_TRSW_X);\n\t\trtw89_phy_write32_clr(rtwdev, (addr | 0x68), B_P0_TRSW_SO_A2);\n\t\trtw89_phy_write32(rtwdev, (addr | 0x80), 0x77777777);\n\t\trtw89_phy_write32(rtwdev, (addr | 0x84), 0x77777777);\n\t}\n\n\trtw89_phy_write32(rtwdev, R_RFE_E_A2, 0xffffffff);\n\trtw89_phy_write32(rtwdev, R_RFE_O_SEL_A2, 0);\n\trtw89_phy_write32(rtwdev, R_RFE_SEL0_A2, 0);\n\trtw89_phy_write32(rtwdev, R_RFE_SEL32_A2, 0);\n\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_A, 0, 0, 0, 0, 1);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_A, 0, 0, 1, 1, 0);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_A, 0, 1, 0, 1, 0);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_A, 0, 1, 1, 1, 0);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_A, 1, 0, 0, 0, 1);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_A, 1, 0, 1, 1, 0);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_A, 1, 1, 0, 1, 0);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_A, 1, 1, 1, 1, 0);\n\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_B, 0, 0, 0, 0, 1);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_B, 0, 0, 1, 1, 0);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_B, 0, 1, 0, 1, 0);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_B, 0, 1, 1, 1, 0);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_B, 1, 0, 0, 0, 1);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_B, 1, 0, 1, 1, 0);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_B, 1, 1, 0, 1, 0);\n\trtw8852c_bb_gpio_trsw(rtwdev, RF_PATH_B, 1, 1, 1, 1, 0);\n\n\trtw8852c_bb_gpio_rfm(rtwdev, RF_PATH_A, PAPE_RFM, 0, 0, 0, 0x0);\n\trtw8852c_bb_gpio_rfm(rtwdev, RF_PATH_A, TRSW_RFM, 0, 0, 0, 0x4);\n\trtw8852c_bb_gpio_rfm(rtwdev, RF_PATH_A, LNAON_RFM, 0, 0, 0, 0x8);\n\n\trtw8852c_bb_gpio_rfm(rtwdev, RF_PATH_B, PAPE_RFM, 0, 0, 0, 0x0);\n\trtw8852c_bb_gpio_rfm(rtwdev, RF_PATH_B, TRSW_RFM, 0, 0, 0, 0x4);\n\trtw8852c_bb_gpio_rfm(rtwdev, RF_PATH_B, LNAON_RFM, 0, 0, 0, 0x8);\n}\n\nstatic void rtw8852c_bb_macid_ctrl_init(struct rtw89_dev *rtwdev,\n\t\t\t\t\tenum rtw89_phy_idx phy_idx)\n{\n\tu32 addr;\n\n\tfor (addr = R_AX_PWR_MACID_LMT_TABLE0;\n\t     addr <= R_AX_PWR_MACID_LMT_TABLE127; addr += 4)\n\t\trtw89_mac_txpwr_write32(rtwdev, phy_idx, addr, 0);\n}\n\nstatic void rtw8852c_bb_sethw(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_phy_efuse_gain *gain = &rtwdev->efuse_gain;\n\n\trtw89_phy_write32_set(rtwdev, R_DBCC_80P80_SEL_EVM_RPT,\n\t\t\t      B_DBCC_80P80_SEL_EVM_RPT_EN);\n\trtw89_phy_write32_set(rtwdev, R_DBCC_80P80_SEL_EVM_RPT2,\n\t\t\t      B_DBCC_80P80_SEL_EVM_RPT2_EN);\n\n\trtw8852c_bb_macid_ctrl_init(rtwdev, RTW89_PHY_0);\n\trtw8852c_bb_gpio_init(rtwdev);\n\n\t \n\tgain->offset_base[RTW89_PHY_0] =\n\t\trtw89_phy_read32_mask(rtwdev, R_RPL_BIAS_COMP, B_RPL_BIAS_COMP_MASK);\n\tgain->offset_base[RTW89_PHY_1] =\n\t\trtw89_phy_read32_mask(rtwdev, R_RPL_BIAS_COMP1, B_RPL_BIAS_COMP1_MASK);\n}\n\nstatic void rtw8852c_set_channel_bb(struct rtw89_dev *rtwdev,\n\t\t\t\t    const struct rtw89_chan *chan,\n\t\t\t\t    enum rtw89_phy_idx phy_idx)\n{\n\tstatic const u32 ru_alloc_msk[2] = {B_P80_AT_HIGH_FREQ_RU_ALLOC_PHY0,\n\t\t\t\t\t    B_P80_AT_HIGH_FREQ_RU_ALLOC_PHY1};\n\tstruct rtw89_hal *hal = &rtwdev->hal;\n\tbool cck_en = chan->band_type == RTW89_BAND_2G;\n\tu8 pri_ch_idx = chan->pri_ch_idx;\n\tu32 mask, reg;\n\tu8 ntx_path;\n\n\tif (chan->band_type == RTW89_BAND_2G)\n\t\trtw8852c_ctrl_sco_cck(rtwdev, chan->channel,\n\t\t\t\t      chan->primary_channel,\n\t\t\t\t      chan->band_width);\n\n\trtw8852c_ctrl_ch(rtwdev, chan, phy_idx);\n\trtw8852c_ctrl_bw(rtwdev, pri_ch_idx, chan->band_width, phy_idx);\n\tif (cck_en) {\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK_ADC, B_ENABLE_CCK, 1);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXCCA_V1, B_RXCCA_DIS_V1, 0);\n\t\trtw89_phy_write32_idx(rtwdev, R_PD_ARBITER_OFF,\n\t\t\t\t      B_PD_ARBITER_OFF, 0x0, phy_idx);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK_ADC, B_ENABLE_CCK, 0);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXCCA_V1, B_RXCCA_DIS_V1, 1);\n\t\trtw89_phy_write32_idx(rtwdev, R_PD_ARBITER_OFF,\n\t\t\t\t      B_PD_ARBITER_OFF, 0x1, phy_idx);\n\t}\n\n\trtw8852c_spur_elimination(rtwdev, chan, pri_ch_idx, phy_idx);\n\trtw8852c_ctrl_btg(rtwdev, chan->band_type == RTW89_BAND_2G);\n\trtw8852c_5m_mask(rtwdev, chan, phy_idx);\n\n\tif (chan->band_width == RTW89_CHANNEL_WIDTH_160 &&\n\t    rtwdev->hal.cv != CHIP_CAV) {\n\t\trtw89_phy_write32_idx(rtwdev, R_P80_AT_HIGH_FREQ,\n\t\t\t\t      B_P80_AT_HIGH_FREQ, 0x0, phy_idx);\n\t\treg = rtw89_mac_reg_by_idx(rtwdev, R_P80_AT_HIGH_FREQ_BB_WRP, phy_idx);\n\t\tif (chan->primary_channel > chan->channel) {\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_P80_AT_HIGH_FREQ_RU_ALLOC,\n\t\t\t\t\t       ru_alloc_msk[phy_idx], 1);\n\t\t\trtw89_write32_mask(rtwdev, reg,\n\t\t\t\t\t   B_P80_AT_HIGH_FREQ_BB_WRP, 1);\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_P80_AT_HIGH_FREQ_RU_ALLOC,\n\t\t\t\t\t       ru_alloc_msk[phy_idx], 0);\n\t\t\trtw89_write32_mask(rtwdev, reg,\n\t\t\t\t\t   B_P80_AT_HIGH_FREQ_BB_WRP, 0);\n\t\t}\n\t}\n\n\tif (chan->band_type == RTW89_BAND_6G &&\n\t    chan->band_width == RTW89_CHANNEL_WIDTH_160)\n\t\trtw89_phy_write32_idx(rtwdev, R_CDD_EVM_CHK_EN,\n\t\t\t\t      B_CDD_EVM_CHK_EN, 0, phy_idx);\n\telse\n\t\trtw89_phy_write32_idx(rtwdev, R_CDD_EVM_CHK_EN,\n\t\t\t\t      B_CDD_EVM_CHK_EN, 1, phy_idx);\n\n\tif (!rtwdev->dbcc_en) {\n\t\tmask = B_P0_TXPW_RSTB_TSSI | B_P0_TXPW_RSTB_MANON;\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TXPW_RSTB, mask, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TXPW_RSTB, mask, 0x3);\n\t\tmask = B_P1_TXPW_RSTB_TSSI | B_P1_TXPW_RSTB_MANON;\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TXPW_RSTB, mask, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TXPW_RSTB, mask, 0x3);\n\t} else {\n\t\tif (phy_idx == RTW89_PHY_0) {\n\t\t\tmask = B_P0_TXPW_RSTB_TSSI | B_P0_TXPW_RSTB_MANON;\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TXPW_RSTB, mask, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TXPW_RSTB, mask, 0x3);\n\t\t} else {\n\t\t\tmask = B_P1_TXPW_RSTB_TSSI | B_P1_TXPW_RSTB_MANON;\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TXPW_RSTB, mask, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TXPW_RSTB, mask, 0x3);\n\t\t}\n\t}\n\n\tif (chan->band_type == RTW89_BAND_6G)\n\t\trtw89_phy_write32_set(rtwdev, R_MUIC, B_MUIC_EN);\n\telse\n\t\trtw89_phy_write32_clr(rtwdev, R_MUIC, B_MUIC_EN);\n\n\tif (hal->antenna_tx)\n\t\tntx_path = hal->antenna_tx;\n\telse\n\t\tntx_path = chan->band_type == RTW89_BAND_6G ? RF_B : RF_AB;\n\n\trtw8852c_ctrl_tx_path_tmac(rtwdev, ntx_path, (enum rtw89_mac_idx)phy_idx);\n\n\trtw8852c_bb_reset_all(rtwdev, phy_idx);\n}\n\nstatic void rtw8852c_set_channel(struct rtw89_dev *rtwdev,\n\t\t\t\t const struct rtw89_chan *chan,\n\t\t\t\t enum rtw89_mac_idx mac_idx,\n\t\t\t\t enum rtw89_phy_idx phy_idx)\n{\n\trtw8852c_set_channel_mac(rtwdev, chan, mac_idx);\n\trtw8852c_set_channel_bb(rtwdev, chan, phy_idx);\n\trtw8852c_set_channel_rf(rtwdev, chan, phy_idx);\n}\n\nstatic void rtw8852c_dfs_en(struct rtw89_dev *rtwdev, bool en)\n{\n\tif (en)\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_P0, B_UPD_P0_EN, 1);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_P0, B_UPD_P0_EN, 0);\n}\n\nstatic void rtw8852c_adc_en(struct rtw89_dev *rtwdev, bool en)\n{\n\tif (en)\n\t\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RST,\n\t\t\t\t       0x0);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RST,\n\t\t\t\t       0xf);\n}\n\nstatic void rtw8852c_set_channel_help(struct rtw89_dev *rtwdev, bool enter,\n\t\t\t\t      struct rtw89_channel_help_params *p,\n\t\t\t\t      const struct rtw89_chan *chan,\n\t\t\t\t      enum rtw89_mac_idx mac_idx,\n\t\t\t\t      enum rtw89_phy_idx phy_idx)\n{\n\tif (enter) {\n\t\trtw89_chip_stop_sch_tx(rtwdev, mac_idx, &p->tx_en,\n\t\t\t\t       RTW89_SCH_TX_SEL_ALL);\n\t\trtw89_mac_cfg_ppdu_status(rtwdev, mac_idx, false);\n\t\trtw8852c_dfs_en(rtwdev, false);\n\t\trtw8852c_tssi_cont_en_phyidx(rtwdev, false, phy_idx);\n\t\trtw8852c_adc_en(rtwdev, false);\n\t\tfsleep(40);\n\t\trtw8852c_bb_reset_en(rtwdev, chan->band_type, phy_idx, false);\n\t} else {\n\t\trtw89_mac_cfg_ppdu_status(rtwdev, mac_idx, true);\n\t\trtw8852c_adc_en(rtwdev, true);\n\t\trtw8852c_dfs_en(rtwdev, true);\n\t\trtw8852c_tssi_cont_en_phyidx(rtwdev, true, phy_idx);\n\t\trtw8852c_bb_reset_en(rtwdev, chan->band_type, phy_idx, true);\n\t\trtw89_chip_resume_sch_tx(rtwdev, mac_idx, p->tx_en);\n\t}\n}\n\nstatic void rtw8852c_rfk_init(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_rfk_mcc_info *rfk_mcc = &rtwdev->rfk_mcc;\n\n\trtwdev->is_tssi_mode[RF_PATH_A] = false;\n\trtwdev->is_tssi_mode[RF_PATH_B] = false;\n\tmemset(rfk_mcc, 0, sizeof(*rfk_mcc));\n\trtw8852c_lck_init(rtwdev);\n\n\trtw8852c_rck(rtwdev);\n\trtw8852c_dack(rtwdev);\n\trtw8852c_rx_dck(rtwdev, RTW89_PHY_0, false);\n}\n\nstatic void rtw8852c_rfk_channel(struct rtw89_dev *rtwdev)\n{\n\tenum rtw89_phy_idx phy_idx = RTW89_PHY_0;\n\n\trtw8852c_mcc_get_ch_info(rtwdev, phy_idx);\n\trtw8852c_rx_dck(rtwdev, phy_idx, false);\n\trtw8852c_iqk(rtwdev, phy_idx);\n\trtw8852c_tssi(rtwdev, phy_idx);\n\trtw8852c_dpk(rtwdev, phy_idx);\n\trtw89_fw_h2c_rf_ntfy_mcc(rtwdev);\n}\n\nstatic void rtw8852c_rfk_band_changed(struct rtw89_dev *rtwdev,\n\t\t\t\t      enum rtw89_phy_idx phy_idx)\n{\n\trtw8852c_tssi_scan(rtwdev, phy_idx);\n}\n\nstatic void rtw8852c_rfk_scan(struct rtw89_dev *rtwdev, bool start)\n{\n\trtw8852c_wifi_scan_notify(rtwdev, start, RTW89_PHY_0);\n}\n\nstatic void rtw8852c_rfk_track(struct rtw89_dev *rtwdev)\n{\n\trtw8852c_dpk_track(rtwdev);\n\trtw8852c_lck_track(rtwdev);\n\trtw8852c_rx_dck_track(rtwdev);\n}\n\nstatic u32 rtw8852c_bb_cal_txpwr_ref(struct rtw89_dev *rtwdev,\n\t\t\t\t     enum rtw89_phy_idx phy_idx, s16 ref)\n{\n\ts8 ofst_int = 0;\n\tu8 base_cw_0db = 0x27;\n\tu16 tssi_16dbm_cw = 0x12c;\n\ts16 pwr_s10_3 = 0;\n\ts16 rf_pwr_cw = 0;\n\tu16 bb_pwr_cw = 0;\n\tu32 pwr_cw = 0;\n\tu32 tssi_ofst_cw = 0;\n\n\tpwr_s10_3 = (ref << 1) + (s16)(ofst_int) + (s16)(base_cw_0db << 3);\n\tbb_pwr_cw = FIELD_GET(GENMASK(2, 0), pwr_s10_3);\n\trf_pwr_cw = FIELD_GET(GENMASK(8, 3), pwr_s10_3);\n\trf_pwr_cw = clamp_t(s16, rf_pwr_cw, 15, 63);\n\tpwr_cw = (rf_pwr_cw << 3) | bb_pwr_cw;\n\n\ttssi_ofst_cw = (u32)((s16)tssi_16dbm_cw + (ref << 1) - (16 << 3));\n\trtw89_debug(rtwdev, RTW89_DBG_TXPWR,\n\t\t    \"[TXPWR] tssi_ofst_cw=%d rf_cw=0x%x bb_cw=0x%x\\n\",\n\t\t    tssi_ofst_cw, rf_pwr_cw, bb_pwr_cw);\n\n\treturn (tssi_ofst_cw << 18) | (pwr_cw << 9) | (ref & GENMASK(8, 0));\n}\n\nstatic\nvoid rtw8852c_set_txpwr_ul_tb_offset(struct rtw89_dev *rtwdev,\n\t\t\t\t     s8 pw_ofst, enum rtw89_mac_idx mac_idx)\n{\n\ts8 pw_ofst_2tx;\n\ts8 val_1t;\n\ts8 val_2t;\n\tu32 reg;\n\tu8 i;\n\n\tif (pw_ofst < -32 || pw_ofst > 31) {\n\t\trtw89_warn(rtwdev, \"[ULTB] Err pwr_offset=%d\\n\", pw_ofst);\n\t\treturn;\n\t}\n\tval_1t = pw_ofst << 2;\n\tpw_ofst_2tx = max(pw_ofst - 3, -32);\n\tval_2t = pw_ofst_2tx << 2;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TXPWR, \"[ULTB] val_1tx=0x%x\\n\", val_1t);\n\trtw89_debug(rtwdev, RTW89_DBG_TXPWR, \"[ULTB] val_2tx=0x%x\\n\", val_2t);\n\n\tfor (i = 0; i < 4; i++) {\n\t\t \n\t\treg = rtw89_mac_reg_by_idx(rtwdev, R_AX_PWR_UL_TB_1T, mac_idx);\n\t\trtw89_write32_mask(rtwdev, reg,\n\t\t\t\t   B_AX_PWR_UL_TB_1T_V1_MASK << (8 * i),\n\t\t\t\t   val_1t);\n\t\t \n\t\treg = rtw89_mac_reg_by_idx(rtwdev, R_AX_PWR_UL_TB_2T, mac_idx);\n\t\trtw89_write32_mask(rtwdev, reg,\n\t\t\t\t   B_AX_PWR_UL_TB_2T_V1_MASK << (8 * i),\n\t\t\t\t   val_2t);\n\t}\n}\n\nstatic void rtw8852c_set_txpwr_ref(struct rtw89_dev *rtwdev,\n\t\t\t\t   enum rtw89_phy_idx phy_idx)\n{\n\tstatic const u32 addr[RF_PATH_NUM_8852C] = {0x5800, 0x7800};\n\tconst u32 mask = 0x7FFFFFF;\n\tconst u8 ofst_ofdm = 0x4;\n\tconst u8 ofst_cck = 0x8;\n\ts16 ref_ofdm = 0;\n\ts16 ref_cck = 0;\n\tu32 val;\n\tu8 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TXPWR, \"[TXPWR] set txpwr reference\\n\");\n\n\trtw89_mac_txpwr_write32_mask(rtwdev, phy_idx, R_AX_PWR_RATE_CTRL,\n\t\t\t\t     GENMASK(27, 10), 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_TXPWR, \"[TXPWR] set bb ofdm txpwr ref\\n\");\n\tval = rtw8852c_bb_cal_txpwr_ref(rtwdev, phy_idx, ref_ofdm);\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++)\n\t\trtw89_phy_write32_idx(rtwdev, addr[i] + ofst_ofdm, mask, val,\n\t\t\t\t      phy_idx);\n\n\trtw89_debug(rtwdev, RTW89_DBG_TXPWR, \"[TXPWR] set bb cck txpwr ref\\n\");\n\tval = rtw8852c_bb_cal_txpwr_ref(rtwdev, phy_idx, ref_cck);\n\n\tfor (i = 0; i < RF_PATH_NUM_8852C; i++)\n\t\trtw89_phy_write32_idx(rtwdev, addr[i] + ofst_cck, mask, val,\n\t\t\t\t      phy_idx);\n}\n\nstatic void rtw8852c_bb_set_tx_shape_dfir(struct rtw89_dev *rtwdev,\n\t\t\t\t\t  const struct rtw89_chan *chan,\n\t\t\t\t\t  u8 tx_shape_idx,\n\t\t\t\t\t  enum rtw89_phy_idx phy_idx)\n{\n#define __DFIR_CFG_MASK 0xffffff\n#define __DFIR_CFG_NR 8\n#define __DECL_DFIR_VAR(_prefix, _name, _val...) \\\n\tstatic const u32 _prefix ## _ ## _name[] = {_val}; \\\n\tstatic_assert(ARRAY_SIZE(_prefix ## _ ## _name) == __DFIR_CFG_NR)\n#define __DECL_DFIR_PARAM(_name, _val...) __DECL_DFIR_VAR(param, _name, _val)\n#define __DECL_DFIR_ADDR(_name, _val...) __DECL_DFIR_VAR(addr, _name, _val)\n\n\t__DECL_DFIR_PARAM(flat,\n\t\t\t  0x003D23FF, 0x0029B354, 0x000FC1C8, 0x00FDB053,\n\t\t\t  0x00F86F9A, 0x00FAEF92, 0x00FE5FCC, 0x00FFDFF5);\n\t__DECL_DFIR_PARAM(sharp,\n\t\t\t  0x003D83FF, 0x002C636A, 0x0013F204, 0x00008090,\n\t\t\t  0x00F87FB0, 0x00F99F83, 0x00FDBFBA, 0x00003FF5);\n\t__DECL_DFIR_PARAM(sharp_14,\n\t\t\t  0x003B13FF, 0x001C42DE, 0x00FDB0AD, 0x00F60F6E,\n\t\t\t  0x00FD8F92, 0x0002D011, 0x0001C02C, 0x00FFF00A);\n\t__DECL_DFIR_ADDR(filter,\n\t\t\t 0x45BC, 0x45CC, 0x45D0, 0x45D4, 0x45D8, 0x45C0,\n\t\t\t 0x45C4, 0x45C8);\n\tu8 ch = chan->channel;\n\tconst u32 *param;\n\tint i;\n\n\tif (ch > 14) {\n\t\trtw89_warn(rtwdev,\n\t\t\t   \"set tx shape dfir by unknown ch: %d on 2G\\n\", ch);\n\t\treturn;\n\t}\n\n\tif (ch == 14)\n\t\tparam = param_sharp_14;\n\telse\n\t\tparam = tx_shape_idx == 0 ? param_flat : param_sharp;\n\n\tfor (i = 0; i < __DFIR_CFG_NR; i++) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_TXPWR,\n\t\t\t    \"set tx shape dfir: 0x%x: 0x%x\\n\", addr_filter[i],\n\t\t\t    param[i]);\n\t\trtw89_phy_write32_idx(rtwdev, addr_filter[i], __DFIR_CFG_MASK,\n\t\t\t\t      param[i], phy_idx);\n\t}\n\n#undef __DECL_DFIR_ADDR\n#undef __DECL_DFIR_PARAM\n#undef __DECL_DFIR_VAR\n#undef __DFIR_CFG_NR\n#undef __DFIR_CFG_MASK\n}\n\nstatic void rtw8852c_set_tx_shape(struct rtw89_dev *rtwdev,\n\t\t\t\t  const struct rtw89_chan *chan,\n\t\t\t\t  enum rtw89_phy_idx phy_idx)\n{\n\tu8 band = chan->band_type;\n\tu8 regd = rtw89_regd_get(rtwdev, band);\n\tu8 tx_shape_cck = rtw89_8852c_tx_shape[band][RTW89_RS_CCK][regd];\n\tu8 tx_shape_ofdm = rtw89_8852c_tx_shape[band][RTW89_RS_OFDM][regd];\n\n\tif (band == RTW89_BAND_2G)\n\t\trtw8852c_bb_set_tx_shape_dfir(rtwdev, chan, tx_shape_cck, phy_idx);\n\n\trtw89_phy_tssi_ctrl_set_bandedge_cfg(rtwdev,\n\t\t\t\t\t     (enum rtw89_mac_idx)phy_idx,\n\t\t\t\t\t     tx_shape_ofdm);\n}\n\nstatic void rtw8852c_set_txpwr(struct rtw89_dev *rtwdev,\n\t\t\t       const struct rtw89_chan *chan,\n\t\t\t       enum rtw89_phy_idx phy_idx)\n{\n\trtw89_phy_set_txpwr_byrate(rtwdev, chan, phy_idx);\n\trtw89_phy_set_txpwr_offset(rtwdev, chan, phy_idx);\n\trtw8852c_set_tx_shape(rtwdev, chan, phy_idx);\n\trtw89_phy_set_txpwr_limit(rtwdev, chan, phy_idx);\n\trtw89_phy_set_txpwr_limit_ru(rtwdev, chan, phy_idx);\n}\n\nstatic void rtw8852c_set_txpwr_ctrl(struct rtw89_dev *rtwdev,\n\t\t\t\t    enum rtw89_phy_idx phy_idx)\n{\n\trtw8852c_set_txpwr_ref(rtwdev, phy_idx);\n}\n\nstatic void\nrtw8852c_init_tssi_ctrl(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tstatic const struct rtw89_reg2_def ctrl_ini[] = {\n\t\t{0xD938, 0x00010100},\n\t\t{0xD93C, 0x0500D500},\n\t\t{0xD940, 0x00000500},\n\t\t{0xD944, 0x00000005},\n\t\t{0xD94C, 0x00220000},\n\t\t{0xD950, 0x00030000},\n\t};\n\tu32 addr;\n\tint i;\n\n\tfor (addr = R_AX_TSSI_CTRL_HEAD; addr <= R_AX_TSSI_CTRL_TAIL; addr += 4)\n\t\trtw89_mac_txpwr_write32(rtwdev, phy_idx, addr, 0);\n\n\tfor (i = 0; i < ARRAY_SIZE(ctrl_ini); i++)\n\t\trtw89_mac_txpwr_write32(rtwdev, phy_idx, ctrl_ini[i].addr,\n\t\t\t\t\tctrl_ini[i].data);\n\n\trtw89_phy_tssi_ctrl_set_bandedge_cfg(rtwdev,\n\t\t\t\t\t     (enum rtw89_mac_idx)phy_idx,\n\t\t\t\t\t     RTW89_TSSI_BANDEDGE_FLAT);\n}\n\nstatic int\nrtw8852c_init_txpwr_unit(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tint ret;\n\n\tret = rtw89_mac_txpwr_write32(rtwdev, phy_idx, R_AX_PWR_UL_CTRL2, 0x07763333);\n\tif (ret)\n\t\treturn ret;\n\n\tret = rtw89_mac_txpwr_write32(rtwdev, phy_idx, R_AX_PWR_COEXT_CTRL, 0x01ebf000);\n\tif (ret)\n\t\treturn ret;\n\n\tret = rtw89_mac_txpwr_write32(rtwdev, phy_idx, R_AX_PWR_UL_CTRL0, 0x0002f8ff);\n\tif (ret)\n\t\treturn ret;\n\n\trtw8852c_set_txpwr_ul_tb_offset(rtwdev, 0, phy_idx == RTW89_PHY_1 ?\n\t\t\t\t\t\t\t      RTW89_MAC_1 :\n\t\t\t\t\t\t\t      RTW89_MAC_0);\n\trtw8852c_init_tssi_ctrl(rtwdev, phy_idx);\n\n\treturn 0;\n}\n\nstatic void rtw8852c_bb_cfg_rx_path(struct rtw89_dev *rtwdev, u8 rx_path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 band = chan->band_type;\n\tu32 rst_mask0 = B_P0_TXPW_RSTB_MANON | B_P0_TXPW_RSTB_TSSI;\n\tu32 rst_mask1 = B_P1_TXPW_RSTB_MANON | B_P1_TXPW_RSTB_TSSI;\n\n\tif (rtwdev->dbcc_en) {\n\t\trtw89_phy_write32_mask(rtwdev, R_CHBW_MOD, B_ANT_RX_SEG0, 1);\n\t\trtw89_phy_write32_idx(rtwdev, R_CHBW_MOD, B_ANT_RX_SEG0, 2,\n\t\t\t\t      RTW89_PHY_1);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_FC0_BW, B_ANT_RX_1RCCA_SEG0,\n\t\t\t\t       1);\n\t\trtw89_phy_write32_mask(rtwdev, R_FC0_BW, B_ANT_RX_1RCCA_SEG1,\n\t\t\t\t       1);\n\t\trtw89_phy_write32_idx(rtwdev, R_FC0_BW, B_ANT_RX_1RCCA_SEG0, 2,\n\t\t\t\t      RTW89_PHY_1);\n\t\trtw89_phy_write32_idx(rtwdev, R_FC0_BW, B_ANT_RX_1RCCA_SEG1, 2,\n\t\t\t\t      RTW89_PHY_1);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHT_MCS_LIMIT,\n\t\t\t\t       B_RXHT_MCS_LIMIT, 0);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXVHT_MCS_LIMIT,\n\t\t\t\t       B_RXVHT_MCS_LIMIT, 0);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHE_USER_MAX, 8);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHE_MAX_NSS, 0);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHETB_MAX_NSS, 0);\n\n\t\trtw89_phy_write32_idx(rtwdev, R_RXHT_MCS_LIMIT,\n\t\t\t\t      B_RXHT_MCS_LIMIT, 0, RTW89_PHY_1);\n\t\trtw89_phy_write32_idx(rtwdev, R_RXVHT_MCS_LIMIT,\n\t\t\t\t      B_RXVHT_MCS_LIMIT, 0, RTW89_PHY_1);\n\t\trtw89_phy_write32_idx(rtwdev, R_RXHE, B_RXHE_USER_MAX, 1,\n\t\t\t\t      RTW89_PHY_1);\n\t\trtw89_phy_write32_idx(rtwdev, R_RXHE, B_RXHE_MAX_NSS, 0,\n\t\t\t\t      RTW89_PHY_1);\n\t\trtw89_phy_write32_idx(rtwdev, R_RXHE, B_RXHETB_MAX_NSS, 0,\n\t\t\t\t      RTW89_PHY_1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TXPW_RSTB, rst_mask0, 1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TXPW_RSTB, rst_mask0, 3);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TXPW_RSTB, rst_mask1, 1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TXPW_RSTB, rst_mask1, 3);\n\t} else {\n\t\tif (rx_path == RF_PATH_A) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_CHBW_MOD,\n\t\t\t\t\t       B_ANT_RX_SEG0, 1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_FC0_BW,\n\t\t\t\t\t       B_ANT_RX_1RCCA_SEG0, 1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_FC0_BW,\n\t\t\t\t\t       B_ANT_RX_1RCCA_SEG1, 1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXHT_MCS_LIMIT,\n\t\t\t\t\t       B_RXHT_MCS_LIMIT, 0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXVHT_MCS_LIMIT,\n\t\t\t\t\t       B_RXVHT_MCS_LIMIT, 0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHE_MAX_NSS,\n\t\t\t\t\t       0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHETB_MAX_NSS,\n\t\t\t\t\t       0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TXPW_RSTB,\n\t\t\t\t\t       rst_mask0, 1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TXPW_RSTB,\n\t\t\t\t\t       rst_mask0, 3);\n\t\t} else if (rx_path == RF_PATH_B) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_CHBW_MOD,\n\t\t\t\t\t       B_ANT_RX_SEG0, 2);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_FC0_BW,\n\t\t\t\t\t       B_ANT_RX_1RCCA_SEG0, 2);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_FC0_BW,\n\t\t\t\t\t       B_ANT_RX_1RCCA_SEG1, 2);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXHT_MCS_LIMIT,\n\t\t\t\t\t       B_RXHT_MCS_LIMIT, 0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXVHT_MCS_LIMIT,\n\t\t\t\t\t       B_RXVHT_MCS_LIMIT, 0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHE_MAX_NSS,\n\t\t\t\t\t       0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHETB_MAX_NSS,\n\t\t\t\t\t       0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TXPW_RSTB,\n\t\t\t\t\t       rst_mask1, 1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TXPW_RSTB,\n\t\t\t\t\t       rst_mask1, 3);\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_CHBW_MOD,\n\t\t\t\t\t       B_ANT_RX_SEG0, 3);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_FC0_BW,\n\t\t\t\t\t       B_ANT_RX_1RCCA_SEG0, 3);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_FC0_BW,\n\t\t\t\t\t       B_ANT_RX_1RCCA_SEG1, 3);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXHT_MCS_LIMIT,\n\t\t\t\t\t       B_RXHT_MCS_LIMIT, 1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXVHT_MCS_LIMIT,\n\t\t\t\t\t       B_RXVHT_MCS_LIMIT, 1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHE_MAX_NSS,\n\t\t\t\t\t       1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHETB_MAX_NSS,\n\t\t\t\t\t       1);\n\t\t\trtw8852c_ctrl_btg(rtwdev, band == RTW89_BAND_2G);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TXPW_RSTB,\n\t\t\t\t\t       rst_mask0, 1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TXPW_RSTB,\n\t\t\t\t\t       rst_mask0, 3);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TXPW_RSTB,\n\t\t\t\t\t       rst_mask1, 1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TXPW_RSTB,\n\t\t\t\t\t       rst_mask1, 3);\n\t\t}\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHE_USER_MAX, 8);\n\t}\n}\n\nstatic void rtw8852c_ctrl_tx_path_tmac(struct rtw89_dev *rtwdev, u8 tx_path,\n\t\t\t\t       enum rtw89_mac_idx mac_idx)\n{\n\tstruct rtw89_reg2_def path_com[] = {\n\t\t{R_AX_PATH_COM0, AX_PATH_COM0_DFVAL},\n\t\t{R_AX_PATH_COM1, AX_PATH_COM1_DFVAL},\n\t\t{R_AX_PATH_COM2, AX_PATH_COM2_DFVAL},\n\t\t{R_AX_PATH_COM3, AX_PATH_COM3_DFVAL},\n\t\t{R_AX_PATH_COM4, AX_PATH_COM4_DFVAL},\n\t\t{R_AX_PATH_COM5, AX_PATH_COM5_DFVAL},\n\t\t{R_AX_PATH_COM6, AX_PATH_COM6_DFVAL},\n\t\t{R_AX_PATH_COM7, AX_PATH_COM7_DFVAL},\n\t\t{R_AX_PATH_COM8, AX_PATH_COM8_DFVAL},\n\t\t{R_AX_PATH_COM9, AX_PATH_COM9_DFVAL},\n\t\t{R_AX_PATH_COM10, AX_PATH_COM10_DFVAL},\n\t\t{R_AX_PATH_COM11, AX_PATH_COM11_DFVAL},\n\t};\n\tu32 addr;\n\tu32 reg;\n\tu8 cr_size = ARRAY_SIZE(path_com);\n\tu8 i = 0;\n\n\trtw89_phy_write32_idx(rtwdev, R_MAC_SEL, B_MAC_SEL_MOD, 0, RTW89_PHY_0);\n\trtw89_phy_write32_idx(rtwdev, R_MAC_SEL, B_MAC_SEL_MOD, 0, RTW89_PHY_1);\n\n\tfor (addr = R_AX_MACID_ANT_TABLE;\n\t     addr <= R_AX_MACID_ANT_TABLE_LAST; addr += 4) {\n\t\treg = rtw89_mac_reg_by_idx(rtwdev, addr, mac_idx);\n\t\trtw89_write32(rtwdev, reg, 0);\n\t}\n\n\tif (tx_path == RF_A) {\n\t\tpath_com[0].data = AX_PATH_COM0_PATHA;\n\t\tpath_com[1].data = AX_PATH_COM1_PATHA;\n\t\tpath_com[2].data = AX_PATH_COM2_PATHA;\n\t\tpath_com[7].data = AX_PATH_COM7_PATHA;\n\t\tpath_com[8].data = AX_PATH_COM8_PATHA;\n\t} else if (tx_path == RF_B) {\n\t\tpath_com[0].data = AX_PATH_COM0_PATHB;\n\t\tpath_com[1].data = AX_PATH_COM1_PATHB;\n\t\tpath_com[2].data = AX_PATH_COM2_PATHB;\n\t\tpath_com[7].data = AX_PATH_COM7_PATHB;\n\t\tpath_com[8].data = AX_PATH_COM8_PATHB;\n\t} else if (tx_path == RF_AB) {\n\t\tpath_com[0].data = AX_PATH_COM0_PATHAB;\n\t\tpath_com[1].data = AX_PATH_COM1_PATHAB;\n\t\tpath_com[2].data = AX_PATH_COM2_PATHAB;\n\t\tpath_com[7].data = AX_PATH_COM7_PATHAB;\n\t\tpath_com[8].data = AX_PATH_COM8_PATHAB;\n\t} else {\n\t\trtw89_warn(rtwdev, \"[Invalid Tx Path]Tx Path: %d\\n\", tx_path);\n\t\treturn;\n\t}\n\n\tfor (i = 0; i < cr_size; i++) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"0x%x = 0x%x\\n\",\n\t\t\t    path_com[i].addr, path_com[i].data);\n\t\treg = rtw89_mac_reg_by_idx(rtwdev, path_com[i].addr, mac_idx);\n\t\trtw89_write32(rtwdev, reg, path_com[i].data);\n\t}\n}\n\nstatic void rtw8852c_bb_ctrl_btc_preagc(struct rtw89_dev *rtwdev, bool bt_en)\n{\n\tif (bt_en) {\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_FRC_FIR_TYPE_V1,\n\t\t\t\t       B_PATH0_FRC_FIR_TYPE_MSK_V1, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_FRC_FIR_TYPE_V1,\n\t\t\t\t       B_PATH1_FRC_FIR_TYPE_MSK_V1, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_RXBB_V1,\n\t\t\t\t       B_PATH0_RXBB_MSK_V1, 0xf);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_RXBB_V1,\n\t\t\t\t       B_PATH1_RXBB_MSK_V1, 0xf);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_G_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH0_G_LNA6_OP1DB_V1, 0x80);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_G_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH1_G_LNA6_OP1DB_V1, 0x80);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_G_TIA0_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH0_G_TIA0_LNA6_OP1DB_V1, 0x80);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_G_TIA1_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH0_G_TIA1_LNA6_OP1DB_V1, 0x80);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_G_TIA0_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH1_G_TIA0_LNA6_OP1DB_V1, 0x80);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_G_TIA1_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH1_G_TIA1_LNA6_OP1DB_V1, 0x80);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_BT_BACKOFF_V1,\n\t\t\t\t       B_PATH0_BT_BACKOFF_V1, 0x780D1E);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BT_BACKOFF_V1,\n\t\t\t\t       B_PATH1_BT_BACKOFF_V1, 0x780D1E);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_BACKOFF_IBADC_V1,\n\t\t\t\t       B_P0_BACKOFF_IBADC_V1, 0x34);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_BACKOFF_IBADC_V1,\n\t\t\t\t       B_P1_BACKOFF_IBADC_V1, 0x34);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_FRC_FIR_TYPE_V1,\n\t\t\t\t       B_PATH0_FRC_FIR_TYPE_MSK_V1, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_FRC_FIR_TYPE_V1,\n\t\t\t\t       B_PATH1_FRC_FIR_TYPE_MSK_V1, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_RXBB_V1,\n\t\t\t\t       B_PATH0_RXBB_MSK_V1, 0x60);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_RXBB_V1,\n\t\t\t\t       B_PATH1_RXBB_MSK_V1, 0x60);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_G_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH0_G_LNA6_OP1DB_V1, 0x1a);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_G_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH1_G_LNA6_OP1DB_V1, 0x1a);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_G_TIA0_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH0_G_TIA0_LNA6_OP1DB_V1, 0x2a);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_G_TIA1_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH0_G_TIA1_LNA6_OP1DB_V1, 0x2a);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_G_TIA0_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH1_G_TIA0_LNA6_OP1DB_V1, 0x2a);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_G_TIA1_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH1_G_TIA1_LNA6_OP1DB_V1, 0x2a);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_BT_BACKOFF_V1,\n\t\t\t\t       B_PATH0_BT_BACKOFF_V1, 0x79E99E);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BT_BACKOFF_V1,\n\t\t\t\t       B_PATH1_BT_BACKOFF_V1, 0x79E99E);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_BACKOFF_IBADC_V1,\n\t\t\t\t       B_P0_BACKOFF_IBADC_V1, 0x26);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_BACKOFF_IBADC_V1,\n\t\t\t\t       B_P1_BACKOFF_IBADC_V1, 0x26);\n\t}\n}\n\nstatic void rtw8852c_bb_cfg_txrx_path(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_hal *hal = &rtwdev->hal;\n\n\trtw8852c_bb_cfg_rx_path(rtwdev, RF_PATH_AB);\n\n\tif (hal->rx_nss == 1) {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHT_MCS_LIMIT, B_RXHT_MCS_LIMIT, 0);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXVHT_MCS_LIMIT, B_RXVHT_MCS_LIMIT, 0);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHE_MAX_NSS, 0);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHETB_MAX_NSS, 0);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHT_MCS_LIMIT, B_RXHT_MCS_LIMIT, 1);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXVHT_MCS_LIMIT, B_RXVHT_MCS_LIMIT, 1);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHE_MAX_NSS, 1);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXHE, B_RXHETB_MAX_NSS, 1);\n\t}\n}\n\nstatic u8 rtw8852c_get_thermal(struct rtw89_dev *rtwdev, enum rtw89_rf_path rf_path)\n{\n\trtw89_write_rf(rtwdev, rf_path, RR_TM, RR_TM_TRI, 0x1);\n\trtw89_write_rf(rtwdev, rf_path, RR_TM, RR_TM_TRI, 0x0);\n\trtw89_write_rf(rtwdev, rf_path, RR_TM, RR_TM_TRI, 0x1);\n\n\tfsleep(200);\n\n\treturn rtw89_read_rf(rtwdev, rf_path, RR_TM, RR_TM_VAL);\n}\n\nstatic void rtw8852c_btc_set_rfe(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_btc *btc = &rtwdev->btc;\n\tstruct rtw89_btc_module *module = &btc->mdinfo;\n\n\tmodule->rfe_type = rtwdev->efuse.rfe_type;\n\tmodule->cv = rtwdev->hal.cv;\n\tmodule->bt_solo = 0;\n\tmodule->switch_type = BTC_SWITCH_INTERNAL;\n\n\tif (module->rfe_type > 0)\n\t\tmodule->ant.num = (module->rfe_type % 2 ? 2 : 3);\n\telse\n\t\tmodule->ant.num = 2;\n\n\tmodule->ant.diversity = 0;\n\tmodule->ant.isolation = 10;\n\n\tif (module->ant.num == 3) {\n\t\tmodule->ant.type = BTC_ANT_DEDICATED;\n\t\tmodule->bt_pos = BTC_BT_ALONE;\n\t} else {\n\t\tmodule->ant.type = BTC_ANT_SHARED;\n\t\tmodule->bt_pos = BTC_BT_BTG;\n\t}\n}\n\nstatic void rtw8852c_ctrl_btg(struct rtw89_dev *rtwdev, bool btg)\n{\n\tif (btg) {\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_BT_SHARE_V1,\n\t\t\t\t       B_PATH0_BT_SHARE_V1, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_BTG_PATH_V1,\n\t\t\t\t       B_PATH0_BTG_PATH_V1, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_G_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH1_G_LNA6_OP1DB_V1, 0x20);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_G_TIA0_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH1_G_TIA0_LNA6_OP1DB_V1, 0x30);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BT_SHARE_V1,\n\t\t\t\t       B_PATH1_BT_SHARE_V1, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BTG_PATH_V1,\n\t\t\t\t       B_PATH1_BTG_PATH_V1, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_PMAC_GNT, B_PMAC_GNT_P1, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CHBW_MOD, B_BT_SHARE, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_FC0_BW, B_ANT_RX_BT_SEG0, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, R_BT_DYN_DC_EST_EN,\n\t\t\t\t       B_BT_DYN_DC_EST_EN_MSK, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_GNT_BT_WGT_EN, B_GNT_BT_WGT_EN,\n\t\t\t\t       0x1);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_BT_SHARE_V1,\n\t\t\t\t       B_PATH0_BT_SHARE_V1, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH0_BTG_PATH_V1,\n\t\t\t\t       B_PATH0_BTG_PATH_V1, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_G_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH1_G_LNA6_OP1DB_V1, 0x1a);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_G_TIA0_LNA6_OP1DB_V1,\n\t\t\t\t       B_PATH1_G_TIA0_LNA6_OP1DB_V1, 0x2a);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BT_SHARE_V1,\n\t\t\t\t       B_PATH1_BT_SHARE_V1, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BTG_PATH_V1,\n\t\t\t\t       B_PATH1_BTG_PATH_V1, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_PMAC_GNT, B_PMAC_GNT_P1, 0xf);\n\t\trtw89_phy_write32_mask(rtwdev, R_PMAC_GNT, B_PMAC_GNT_P2, 0x4);\n\t\trtw89_phy_write32_mask(rtwdev, R_CHBW_MOD, B_BT_SHARE, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_FC0_BW, B_ANT_RX_BT_SEG0, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_BT_DYN_DC_EST_EN,\n\t\t\t\t       B_BT_DYN_DC_EST_EN_MSK, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_GNT_BT_WGT_EN, B_GNT_BT_WGT_EN,\n\t\t\t\t       0x0);\n\t}\n}\n\nstatic\nvoid rtw8852c_set_trx_mask(struct rtw89_dev *rtwdev, u8 path, u8 group, u32 val)\n{\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RFREG_MASK, 0x20000);\n\trtw89_write_rf(rtwdev, path, RR_LUTWA, RFREG_MASK, group);\n\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RFREG_MASK, val);\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RFREG_MASK, 0x0);\n}\n\nstatic void rtw8852c_btc_init_cfg(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_btc *btc = &rtwdev->btc;\n\tstruct rtw89_btc_module *module = &btc->mdinfo;\n\tconst struct rtw89_chip_info *chip = rtwdev->chip;\n\tconst struct rtw89_mac_ax_coex coex_params = {\n\t\t.pta_mode = RTW89_MAC_AX_COEX_RTK_MODE,\n\t\t.direction = RTW89_MAC_AX_COEX_INNER,\n\t};\n\n\t \n\trtw89_mac_coex_init_v1(rtwdev, &coex_params);\n\n\t \n\tchip->ops->btc_set_wl_pri(rtwdev, BTC_PRI_MASK_TX_RESP, true);\n\tchip->ops->btc_set_wl_pri(rtwdev, BTC_PRI_MASK_BEACON, true);\n\n\t \n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_WLSEL, RFREG_MASK, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_WLSEL, RFREG_MASK, 0x0);\n\n\t \n\tif (module->ant.type == BTC_ANT_SHARED) {\n\t\trtw8852c_set_trx_mask(rtwdev,\n\t\t\t\t      RF_PATH_A, BTC_BT_SS_GROUP, 0x5ff);\n\t\trtw8852c_set_trx_mask(rtwdev,\n\t\t\t\t      RF_PATH_B, BTC_BT_SS_GROUP, 0x5ff);\n\t\t \n\t\trtw8852c_set_trx_mask(rtwdev,\n\t\t\t\t      RF_PATH_A, BTC_BT_TX_GROUP, 0x5ff);\n\t} else {  \n\t\trtw8852c_set_trx_mask(rtwdev,\n\t\t\t\t      RF_PATH_A, BTC_BT_SS_GROUP, 0x5df);\n\t\trtw8852c_set_trx_mask(rtwdev,\n\t\t\t\t      RF_PATH_B, BTC_BT_SS_GROUP, 0x5df);\n\t}\n\n\t \n\trtw89_write32(rtwdev, R_AX_BT_BREAK_TABLE, BTC_BREAK_PARAM);\n\n\t  \n\trtw89_write32_set(rtwdev,\n\t\t\t  R_AX_BT_CNT_CFG, B_AX_BT_CNT_EN |\n\t\t\t  B_AX_BT_CNT_RST_V1);\n\tbtc->cx.wl.status.map.init_ok = true;\n}\n\nstatic\nvoid rtw8852c_btc_set_wl_pri(struct rtw89_dev *rtwdev, u8 map, bool state)\n{\n\tu32 bitmap = 0;\n\tu32 reg = 0;\n\n\tswitch (map) {\n\tcase BTC_PRI_MASK_TX_RESP:\n\t\treg = R_BTC_COEX_WL_REQ;\n\t\tbitmap = B_BTC_RSP_ACK_HI;\n\t\tbreak;\n\tcase BTC_PRI_MASK_BEACON:\n\t\treg = R_BTC_COEX_WL_REQ;\n\t\tbitmap = B_BTC_TX_BCN_HI;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tif (state)\n\t\trtw89_write32_set(rtwdev, reg, bitmap);\n\telse\n\t\trtw89_write32_clr(rtwdev, reg, bitmap);\n}\n\nunion rtw8852c_btc_wl_txpwr_ctrl {\n\tu32 txpwr_val;\n\tstruct {\n\t\tunion {\n\t\t\tu16 ctrl_all_time;\n\t\t\tstruct {\n\t\t\t\ts16 data:9;\n\t\t\t\tu16 rsvd:6;\n\t\t\t\tu16 flag:1;\n\t\t\t} all_time;\n\t\t};\n\t\tunion {\n\t\t\tu16 ctrl_gnt_bt;\n\t\t\tstruct {\n\t\t\t\ts16 data:9;\n\t\t\t\tu16 rsvd:7;\n\t\t\t} gnt_bt;\n\t\t};\n\t};\n} __packed;\n\nstatic void\nrtw8852c_btc_set_wl_txpwr_ctrl(struct rtw89_dev *rtwdev, u32 txpwr_val)\n{\n\tunion rtw8852c_btc_wl_txpwr_ctrl arg = { .txpwr_val = txpwr_val };\n\ts32 val;\n\n#define __write_ctrl(_reg, _msk, _val, _en, _cond)\t\t\\\ndo {\t\t\t\t\t\t\t\t\\\n\tu32 _wrt = FIELD_PREP(_msk, _val);\t\t\t\\\n\tBUILD_BUG_ON((_msk & _en) != 0);\t\t\t\\\n\tif (_cond)\t\t\t\t\t\t\\\n\t\t_wrt |= _en;\t\t\t\t\t\\\n\telse\t\t\t\t\t\t\t\\\n\t\t_wrt &= ~_en;\t\t\t\t\t\\\n\trtw89_mac_txpwr_write32_mask(rtwdev, RTW89_PHY_0, _reg,\t\\\n\t\t\t\t     _msk | _en, _wrt);\t\t\\\n} while (0)\n\n\tswitch (arg.ctrl_all_time) {\n\tcase 0xffff:\n\t\tval = 0;\n\t\tbreak;\n\tdefault:\n\t\tval = arg.all_time.data;\n\t\tbreak;\n\t}\n\n\t__write_ctrl(R_AX_PWR_RATE_CTRL, B_AX_FORCE_PWR_BY_RATE_VALUE_MASK,\n\t\t     val, B_AX_FORCE_PWR_BY_RATE_EN,\n\t\t     arg.ctrl_all_time != 0xffff);\n\n\tswitch (arg.ctrl_gnt_bt) {\n\tcase 0xffff:\n\t\tval = 0;\n\t\tbreak;\n\tdefault:\n\t\tval = arg.gnt_bt.data;\n\t\tbreak;\n\t}\n\n\t__write_ctrl(R_AX_PWR_COEXT_CTRL, B_AX_TXAGC_BT_MASK, val,\n\t\t     B_AX_TXAGC_BT_EN, arg.ctrl_gnt_bt != 0xffff);\n\n#undef __write_ctrl\n}\n\nstatic\ns8 rtw8852c_btc_get_bt_rssi(struct rtw89_dev *rtwdev, s8 val)\n{\n\t \n\treturn clamp_t(s8, val + 6, -100, 0) + 100;\n}\n\nstatic const struct rtw89_btc_rf_trx_para rtw89_btc_8852c_rf_ul[] = {\n\t{255, 0, 0, 7},  \n\t{255, 2, 0, 7},  \n\t{255, 0, 0, 7},  \n\t{255, 0, 0, 7},  \n\t{255, 0, 0, 7},  \n\t{255, 1, 0, 7},  \n\t{6, 1, 0, 7},\n\t{13, 1, 0, 7},\n\t{13, 1, 0, 7}\n};\n\nstatic const struct rtw89_btc_rf_trx_para rtw89_btc_8852c_rf_dl[] = {\n\t{255, 0, 0, 7},  \n\t{255, 2, 0, 7},  \n\t{255, 0, 0, 7},  \n\t{255, 0, 0, 7},  \n\t{255, 0, 0, 7},  \n\t{255, 1, 0, 7},  \n\t{255, 1, 0, 7},\n\t{255, 1, 0, 7},\n\t{255, 1, 0, 7}\n};\n\nstatic const u8 rtw89_btc_8852c_wl_rssi_thres[BTC_WL_RSSI_THMAX] = {60, 50, 40, 30};\nstatic const u8 rtw89_btc_8852c_bt_rssi_thres[BTC_BT_RSSI_THMAX] = {40, 36, 31, 28};\n\nstatic const struct rtw89_btc_fbtc_mreg rtw89_btc_8852c_mon_reg[] = {\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xda00),\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xda04),\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xda24),\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xda30),\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xda34),\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xda38),\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xda44),\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xda48),\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xda4c),\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xd200),\n\tRTW89_DEF_FBTC_MREG(REG_MAC, 4, 0xd220),\n\tRTW89_DEF_FBTC_MREG(REG_BB, 4, 0x980),\n\tRTW89_DEF_FBTC_MREG(REG_BB, 4, 0x4aa4),\n\tRTW89_DEF_FBTC_MREG(REG_BB, 4, 0x4778),\n\tRTW89_DEF_FBTC_MREG(REG_BB, 4, 0x476c),\n};\n\nstatic\nvoid rtw8852c_btc_update_bt_cnt(struct rtw89_dev *rtwdev)\n{\n\t \n}\n\nstatic\nvoid rtw8852c_btc_wl_s1_standby(struct rtw89_dev *rtwdev, bool state)\n{\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWE, RFREG_MASK, 0x80000);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWA, RFREG_MASK, 0x1);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD1, RFREG_MASK, 0x620);\n\n\t \n\tif (state)\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD0,\n\t\t\t       RFREG_MASK, 0x179c);\n\telse\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD0,\n\t\t\t       RFREG_MASK, 0x208);\n\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWE, RFREG_MASK, 0x0);\n}\n\nstatic void rtw8852c_set_wl_lna2(struct rtw89_dev *rtwdev, u8 level)\n{\n\t \n\n\tswitch (level) {\n\tcase 0:  \n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWE, RFREG_MASK, 0x1000);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWA, RFREG_MASK, 0x0);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD0, RFREG_MASK, 0x15);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWA, RFREG_MASK, 0x1);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD0, RFREG_MASK, 0x17);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWA, RFREG_MASK, 0x2);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD0, RFREG_MASK, 0x15);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWA, RFREG_MASK, 0x3);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD0, RFREG_MASK, 0x17);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWE, RFREG_MASK, 0x0);\n\t\tbreak;\n\tcase 1:  \n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWE, RFREG_MASK, 0x1000);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWA, RFREG_MASK, 0x0);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD0, RFREG_MASK, 0x15);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWA, RFREG_MASK, 0x1);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD0, RFREG_MASK, 0x5);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWA, RFREG_MASK, 0x2);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD0, RFREG_MASK, 0x15);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWA, RFREG_MASK, 0x3);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWD0, RFREG_MASK, 0x5);\n\t\trtw89_write_rf(rtwdev, RF_PATH_B, RR_LUTWE, RFREG_MASK, 0x0);\n\t\tbreak;\n\t}\n}\n\nstatic void rtw8852c_btc_set_wl_rx_gain(struct rtw89_dev *rtwdev, u32 level)\n{\n\tstruct rtw89_btc *btc = &rtwdev->btc;\n\n\tswitch (level) {\n\tcase 0:  \n\tdefault:\n\t\trtw8852c_bb_ctrl_btc_preagc(rtwdev, false);\n\t\tbtc->dm.wl_lna2 = 0;\n\t\tbreak;\n\tcase 1:  \n\t\trtw8852c_bb_ctrl_btc_preagc(rtwdev, true);\n\t\tbtc->dm.wl_lna2 = 0;\n\t\tbreak;\n\tcase 2:  \n\t\trtw8852c_bb_ctrl_btc_preagc(rtwdev, false);\n\t\tbtc->dm.wl_lna2 = 1;\n\t\tbreak;\n\t}\n\n\trtw8852c_set_wl_lna2(rtwdev, btc->dm.wl_lna2);\n}\n\nstatic void rtw8852c_fill_freq_with_ppdu(struct rtw89_dev *rtwdev,\n\t\t\t\t\t struct rtw89_rx_phy_ppdu *phy_ppdu,\n\t\t\t\t\t struct ieee80211_rx_status *status)\n{\n\tu8 chan_idx = phy_ppdu->chan_idx;\n\tenum nl80211_band band;\n\tu8 ch;\n\n\tif (chan_idx == 0)\n\t\treturn;\n\n\trtw89_decode_chan_idx(rtwdev, chan_idx, &ch, &band);\n\tstatus->freq = ieee80211_channel_to_frequency(ch, band);\n\tstatus->band = band;\n}\n\nstatic void rtw8852c_query_ppdu(struct rtw89_dev *rtwdev,\n\t\t\t\tstruct rtw89_rx_phy_ppdu *phy_ppdu,\n\t\t\t\tstruct ieee80211_rx_status *status)\n{\n\tu8 path;\n\tu8 *rx_power = phy_ppdu->rssi;\n\n\tstatus->signal = RTW89_RSSI_RAW_TO_DBM(max(rx_power[RF_PATH_A], rx_power[RF_PATH_B]));\n\tfor (path = 0; path < rtwdev->chip->rf_path_num; path++) {\n\t\tstatus->chains |= BIT(path);\n\t\tstatus->chain_signal[path] = RTW89_RSSI_RAW_TO_DBM(rx_power[path]);\n\t}\n\tif (phy_ppdu->valid)\n\t\trtw8852c_fill_freq_with_ppdu(rtwdev, phy_ppdu, status);\n}\n\nstatic int rtw8852c_mac_enable_bb_rf(struct rtw89_dev *rtwdev)\n{\n\tint ret;\n\n\trtw89_write8_set(rtwdev, R_AX_SYS_FUNC_EN,\n\t\t\t B_AX_FEN_BBRSTB | B_AX_FEN_BB_GLB_RSTN);\n\n\trtw89_write32_set(rtwdev, R_AX_WLRF_CTRL, B_AX_AFC_AFEDIG);\n\trtw89_write32_clr(rtwdev, R_AX_WLRF_CTRL, B_AX_AFC_AFEDIG);\n\trtw89_write32_set(rtwdev, R_AX_WLRF_CTRL, B_AX_AFC_AFEDIG);\n\n\trtw89_write32_mask(rtwdev, R_AX_AFE_OFF_CTRL1, B_AX_S0_LDO_VSEL_F_MASK, 0x1);\n\trtw89_write32_mask(rtwdev, R_AX_AFE_OFF_CTRL1, B_AX_S1_LDO_VSEL_F_MASK, 0x1);\n\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL0, 0x7, FULL_BIT_MASK);\n\tif (ret)\n\t\treturn ret;\n\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_ANAPAR_WL, 0x6c, FULL_BIT_MASK);\n\tif (ret)\n\t\treturn ret;\n\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_WL_RFC_S0, 0xc7, FULL_BIT_MASK);\n\tif (ret)\n\t\treturn ret;\n\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL_SI_WL_RFC_S1, 0xc7, FULL_BIT_MASK);\n\tif (ret)\n\t\treturn ret;\n\n\tret = rtw89_mac_write_xtal_si(rtwdev, XTAL3, 0xd, FULL_BIT_MASK);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int rtw8852c_mac_disable_bb_rf(struct rtw89_dev *rtwdev)\n{\n\trtw89_write8_clr(rtwdev, R_AX_SYS_FUNC_EN,\n\t\t\t B_AX_FEN_BBRSTB | B_AX_FEN_BB_GLB_RSTN);\n\n\treturn 0;\n}\n\n#ifdef CONFIG_PM\nstatic const struct wiphy_wowlan_support rtw_wowlan_stub_8852c = {\n\t.flags = WIPHY_WOWLAN_MAGIC_PKT | WIPHY_WOWLAN_DISCONNECT,\n\t.n_patterns = RTW89_MAX_PATTERN_NUM,\n\t.pattern_max_len = RTW89_MAX_PATTERN_SIZE,\n\t.pattern_min_len = 1,\n};\n#endif\n\nstatic const struct rtw89_chip_ops rtw8852c_chip_ops = {\n\t.enable_bb_rf\t\t= rtw8852c_mac_enable_bb_rf,\n\t.disable_bb_rf\t\t= rtw8852c_mac_disable_bb_rf,\n\t.bb_reset\t\t= rtw8852c_bb_reset,\n\t.bb_sethw\t\t= rtw8852c_bb_sethw,\n\t.read_rf\t\t= rtw89_phy_read_rf_v1,\n\t.write_rf\t\t= rtw89_phy_write_rf_v1,\n\t.set_channel\t\t= rtw8852c_set_channel,\n\t.set_channel_help\t= rtw8852c_set_channel_help,\n\t.read_efuse\t\t= rtw8852c_read_efuse,\n\t.read_phycap\t\t= rtw8852c_read_phycap,\n\t.fem_setup\t\t= NULL,\n\t.rfe_gpio\t\t= NULL,\n\t.rfk_init\t\t= rtw8852c_rfk_init,\n\t.rfk_channel\t\t= rtw8852c_rfk_channel,\n\t.rfk_band_changed\t= rtw8852c_rfk_band_changed,\n\t.rfk_scan\t\t= rtw8852c_rfk_scan,\n\t.rfk_track\t\t= rtw8852c_rfk_track,\n\t.power_trim\t\t= rtw8852c_power_trim,\n\t.set_txpwr\t\t= rtw8852c_set_txpwr,\n\t.set_txpwr_ctrl\t\t= rtw8852c_set_txpwr_ctrl,\n\t.init_txpwr_unit\t= rtw8852c_init_txpwr_unit,\n\t.get_thermal\t\t= rtw8852c_get_thermal,\n\t.ctrl_btg\t\t= rtw8852c_ctrl_btg,\n\t.query_ppdu\t\t= rtw8852c_query_ppdu,\n\t.bb_ctrl_btc_preagc\t= rtw8852c_bb_ctrl_btc_preagc,\n\t.cfg_txrx_path\t\t= rtw8852c_bb_cfg_txrx_path,\n\t.set_txpwr_ul_tb_offset\t= rtw8852c_set_txpwr_ul_tb_offset,\n\t.pwr_on_func\t\t= rtw8852c_pwr_on_func,\n\t.pwr_off_func\t\t= rtw8852c_pwr_off_func,\n\t.query_rxdesc\t\t= rtw89_core_query_rxdesc,\n\t.fill_txdesc\t\t= rtw89_core_fill_txdesc_v1,\n\t.fill_txdesc_fwcmd\t= rtw89_core_fill_txdesc_fwcmd_v1,\n\t.cfg_ctrl_path\t\t= rtw89_mac_cfg_ctrl_path_v1,\n\t.mac_cfg_gnt\t\t= rtw89_mac_cfg_gnt_v1,\n\t.stop_sch_tx\t\t= rtw89_mac_stop_sch_tx_v1,\n\t.resume_sch_tx\t\t= rtw89_mac_resume_sch_tx_v1,\n\t.h2c_dctl_sec_cam\t= rtw89_fw_h2c_dctl_sec_cam_v1,\n\n\t.btc_set_rfe\t\t= rtw8852c_btc_set_rfe,\n\t.btc_init_cfg\t\t= rtw8852c_btc_init_cfg,\n\t.btc_set_wl_pri\t\t= rtw8852c_btc_set_wl_pri,\n\t.btc_set_wl_txpwr_ctrl\t= rtw8852c_btc_set_wl_txpwr_ctrl,\n\t.btc_get_bt_rssi\t= rtw8852c_btc_get_bt_rssi,\n\t.btc_update_bt_cnt\t= rtw8852c_btc_update_bt_cnt,\n\t.btc_wl_s1_standby\t= rtw8852c_btc_wl_s1_standby,\n\t.btc_set_wl_rx_gain\t= rtw8852c_btc_set_wl_rx_gain,\n\t.btc_set_policy\t\t= rtw89_btc_set_policy_v1,\n};\n\nconst struct rtw89_chip_info rtw8852c_chip_info = {\n\t.chip_id\t\t= RTL8852C,\n\t.chip_gen\t\t= RTW89_CHIP_AX,\n\t.ops\t\t\t= &rtw8852c_chip_ops,\n\t.mac_def\t\t= &rtw89_mac_gen_ax,\n\t.phy_def\t\t= &rtw89_phy_gen_ax,\n\t.fw_basename\t\t= RTW8852C_FW_BASENAME,\n\t.fw_format_max\t\t= RTW8852C_FW_FORMAT_MAX,\n\t.try_ce_fw\t\t= false,\n\t.needed_fw_elms\t\t= 0,\n\t.fifo_size\t\t= 458752,\n\t.small_fifo_size\t= false,\n\t.dle_scc_rsvd_size\t= 0,\n\t.max_amsdu_limit\t= 8000,\n\t.dis_2g_40m_ul_ofdma\t= false,\n\t.rsvd_ple_ofst\t\t= 0x6f800,\n\t.hfc_param_ini\t\t= rtw8852c_hfc_param_ini_pcie,\n\t.dle_mem\t\t= rtw8852c_dle_mem_pcie,\n\t.wde_qempty_acq_num     = 16,\n\t.wde_qempty_mgq_sel     = 16,\n\t.rf_base_addr\t\t= {0xe000, 0xf000},\n\t.pwr_on_seq\t\t= NULL,\n\t.pwr_off_seq\t\t= NULL,\n\t.bb_table\t\t= &rtw89_8852c_phy_bb_table,\n\t.bb_gain_table\t\t= &rtw89_8852c_phy_bb_gain_table,\n\t.rf_table\t\t= {&rtw89_8852c_phy_radiob_table,\n\t\t\t\t   &rtw89_8852c_phy_radioa_table,},\n\t.nctl_table\t\t= &rtw89_8852c_phy_nctl_table,\n\t.nctl_post_table\t= NULL,\n\t.byr_table\t\t= &rtw89_8852c_byr_table,\n\t.dflt_parms\t\t= &rtw89_8852c_dflt_parms,\n\t.rfe_parms_conf\t\t= NULL,\n\t.txpwr_factor_rf\t= 2,\n\t.txpwr_factor_mac\t= 1,\n\t.dig_table\t\t= NULL,\n\t.dig_regs\t\t= &rtw8852c_dig_regs,\n\t.tssi_dbw_table\t\t= &rtw89_8852c_tssi_dbw_table,\n\t.support_chanctx_num\t= 1,\n\t.support_bands\t\t= BIT(NL80211_BAND_2GHZ) |\n\t\t\t\t  BIT(NL80211_BAND_5GHZ) |\n\t\t\t\t  BIT(NL80211_BAND_6GHZ),\n\t.support_bw160\t\t= true,\n\t.support_unii4\t\t= true,\n\t.support_ul_tb_ctrl     = false,\n\t.hw_sec_hdr\t\t= true,\n\t.rf_path_num\t\t= 2,\n\t.tx_nss\t\t\t= 2,\n\t.rx_nss\t\t\t= 2,\n\t.acam_num\t\t= 128,\n\t.bcam_num\t\t= 20,\n\t.scam_num\t\t= 128,\n\t.bacam_num\t\t= 8,\n\t.bacam_dynamic_num\t= 8,\n\t.bacam_ver\t\t= RTW89_BACAM_V0_EXT,\n\t.sec_ctrl_efuse_size\t= 4,\n\t.physical_efuse_size\t= 1216,\n\t.logical_efuse_size\t= 2048,\n\t.limit_efuse_size\t= 1280,\n\t.dav_phy_efuse_size\t= 96,\n\t.dav_log_efuse_size\t= 16,\n\t.phycap_addr\t\t= 0x590,\n\t.phycap_size\t\t= 0x60,\n\t.para_ver\t\t= 0x1,\n\t.wlcx_desired\t\t= 0x06000000,\n\t.btcx_desired\t\t= 0x7,\n\t.scbd\t\t\t= 0x1,\n\t.mailbox\t\t= 0x1,\n\n\t.afh_guard_ch\t\t= 6,\n\t.wl_rssi_thres\t\t= rtw89_btc_8852c_wl_rssi_thres,\n\t.bt_rssi_thres\t\t= rtw89_btc_8852c_bt_rssi_thres,\n\t.rssi_tol\t\t= 2,\n\t.mon_reg_num\t\t= ARRAY_SIZE(rtw89_btc_8852c_mon_reg),\n\t.mon_reg\t\t= rtw89_btc_8852c_mon_reg,\n\t.rf_para_ulink_num\t= ARRAY_SIZE(rtw89_btc_8852c_rf_ul),\n\t.rf_para_ulink\t\t= rtw89_btc_8852c_rf_ul,\n\t.rf_para_dlink_num\t= ARRAY_SIZE(rtw89_btc_8852c_rf_dl),\n\t.rf_para_dlink\t\t= rtw89_btc_8852c_rf_dl,\n\t.ps_mode_supported\t= BIT(RTW89_PS_MODE_RFOFF) |\n\t\t\t\t  BIT(RTW89_PS_MODE_CLK_GATED) |\n\t\t\t\t  BIT(RTW89_PS_MODE_PWR_GATED),\n\t.low_power_hci_modes\t= BIT(RTW89_PS_MODE_CLK_GATED) |\n\t\t\t\t  BIT(RTW89_PS_MODE_PWR_GATED),\n\t.h2c_cctl_func_id\t= H2C_FUNC_MAC_CCTLINFO_UD_V1,\n\t.hci_func_en_addr\t= R_AX_HCI_FUNC_EN_V1,\n\t.h2c_desc_size\t\t= sizeof(struct rtw89_rxdesc_short),\n\t.txwd_body_size\t\t= sizeof(struct rtw89_txwd_body_v1),\n\t.h2c_ctrl_reg\t\t= R_AX_H2CREG_CTRL_V1,\n\t.h2c_counter_reg\t= {R_AX_UDM1 + 1, B_AX_UDM1_HALMAC_H2C_DEQ_CNT_MASK >> 8},\n\t.h2c_regs\t\t= rtw8852c_h2c_regs,\n\t.c2h_ctrl_reg\t\t= R_AX_C2HREG_CTRL_V1,\n\t.c2h_counter_reg\t= {R_AX_UDM1 + 1, B_AX_UDM1_HALMAC_C2H_ENQ_CNT_MASK >> 8},\n\t.c2h_regs\t\t= rtw8852c_c2h_regs,\n\t.page_regs\t\t= &rtw8852c_page_regs,\n\t.cfo_src_fd\t\t= false,\n\t.cfo_hw_comp            = false,\n\t.dcfo_comp\t\t= &rtw8852c_dcfo_comp,\n\t.dcfo_comp_sft\t\t= 12,\n\t.imr_info\t\t= &rtw8852c_imr_info,\n\t.rrsr_cfgs\t\t= &rtw8852c_rrsr_cfgs,\n\t.bss_clr_map_reg\t= R_BSS_CLR_MAP,\n\t.dma_ch_mask\t\t= 0,\n\t.edcca_lvl_reg\t\t= R_SEG0R_EDCCA_LVL,\n#ifdef CONFIG_PM\n\t.wowlan_stub\t\t= &rtw_wowlan_stub_8852c,\n#endif\n\t.xtal_info\t\t= NULL,\n};\nEXPORT_SYMBOL(rtw8852c_chip_info);\n\nMODULE_FIRMWARE(RTW8852C_MODULE_FIRMWARE);\nMODULE_AUTHOR(\"Realtek Corporation\");\nMODULE_DESCRIPTION(\"Realtek 802.11ax wireless 8852C driver\");\nMODULE_LICENSE(\"Dual BSD/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}