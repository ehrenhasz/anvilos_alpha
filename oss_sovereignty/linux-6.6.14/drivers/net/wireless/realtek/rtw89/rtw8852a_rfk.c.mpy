{
  "module_name": "rtw8852a_rfk.c",
  "hash_id": "92331b730315c4411bbafeffb9150d21b00417145ee28bfc1b560dea05070497",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtw89/rtw8852a_rfk.c",
  "human_readable_source": "\n \n\n#include \"coex.h\"\n#include \"debug.h\"\n#include \"mac.h\"\n#include \"phy.h\"\n#include \"reg.h\"\n#include \"rtw8852a.h\"\n#include \"rtw8852a_rfk.h\"\n#include \"rtw8852a_rfk_table.h\"\n#include \"rtw8852a_table.h\"\n\nstatic u8 _kpath(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]dbcc_en: %x,  PHY%d\\n\",\n\t\t    rtwdev->dbcc_en, phy_idx);\n\n\tif (!rtwdev->dbcc_en)\n\t\treturn RF_AB;\n\n\tif (phy_idx == RTW89_PHY_0)\n\t\treturn RF_A;\n\telse\n\t\treturn RF_B;\n}\n\nstatic const u32 rtw8852a_backup_bb_regs[] = {0x2344, 0x58f0, 0x78f0};\nstatic const u32 rtw8852a_backup_rf_regs[] = {0xef, 0xde, 0x0, 0x1e, 0x2, 0x85, 0x90, 0x5};\n#define BACKUP_BB_REGS_NR ARRAY_SIZE(rtw8852a_backup_bb_regs)\n#define BACKUP_RF_REGS_NR ARRAY_SIZE(rtw8852a_backup_rf_regs)\n\nstatic void _rfk_backup_bb_reg(struct rtw89_dev *rtwdev, u32 backup_bb_reg_val[])\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_BB_REGS_NR; i++) {\n\t\tbackup_bb_reg_val[i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, rtw8852a_backup_bb_regs[i],\n\t\t\t\t\t      MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]backup bb reg : %x, value =%x\\n\",\n\t\t\t    rtw8852a_backup_bb_regs[i], backup_bb_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_backup_rf_reg(struct rtw89_dev *rtwdev, u32 backup_rf_reg_val[],\n\t\t\t       u8 rf_path)\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_RF_REGS_NR; i++) {\n\t\tbackup_rf_reg_val[i] =\n\t\t\trtw89_read_rf(rtwdev, rf_path,\n\t\t\t\t      rtw8852a_backup_rf_regs[i], RFREG_MASK);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]backup rf S%d reg : %x, value =%x\\n\", rf_path,\n\t\t\t    rtw8852a_backup_rf_regs[i], backup_rf_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_restore_bb_reg(struct rtw89_dev *rtwdev,\n\t\t\t\tu32 backup_bb_reg_val[])\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_BB_REGS_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, rtw8852a_backup_bb_regs[i],\n\t\t\t\t       MASKDWORD, backup_bb_reg_val[i]);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]restore bb reg : %x, value =%x\\n\",\n\t\t\t    rtw8852a_backup_bb_regs[i], backup_bb_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_restore_rf_reg(struct rtw89_dev *rtwdev,\n\t\t\t\tu32 backup_rf_reg_val[], u8 rf_path)\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_RF_REGS_NR; i++) {\n\t\trtw89_write_rf(rtwdev, rf_path, rtw8852a_backup_rf_regs[i],\n\t\t\t       RFREG_MASK, backup_rf_reg_val[i]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]restore rf S%d reg: %x, value =%x\\n\", rf_path,\n\t\t\t    rtw8852a_backup_rf_regs[i], backup_rf_reg_val[i]);\n\t}\n}\n\nstatic void _wait_rx_mode(struct rtw89_dev *rtwdev, u8 kpath)\n{\n\tu8 path;\n\tu32 rf_mode;\n\tint ret;\n\n\tfor (path = 0; path < RF_PATH_MAX; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\tret = read_poll_timeout_atomic(rtw89_read_rf, rf_mode, rf_mode != 2,\n\t\t\t\t\t       2, 5000, false, rtwdev, path, 0x00,\n\t\t\t\t\t       RR_MOD_MASK);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK] Wait S%d to Rx mode!! (ret = %d)\\n\",\n\t\t\t    path, ret);\n\t}\n}\n\nstatic void _dack_dump(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\tu8 t;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S0 ADC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->addck_d[0][0], dack->addck_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S1 ADC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->addck_d[1][0], dack->addck_d[1][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S0 DAC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->dadck_d[0][0], dack->dadck_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S1 DAC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->dadck_d[1][0], dack->dadck_d[1][1]);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S0 biask ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->biask_d[0][0], dack->biask_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S1 biask ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->biask_d[1][0], dack->biask_d[1][1]);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 MSBK ic:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[0][0][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 MSBK qc:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[0][1][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 MSBK ic:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[1][0][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 MSBK qc:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[1][1][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n}\n\nstatic void _afe_init(struct rtw89_dev *rtwdev)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_afe_init_defs_tbl);\n}\n\nstatic void _addck_backup(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\n\trtw89_phy_write32_clr(rtwdev, R_S0_RXDC2, B_S0_RXDC2_SEL);\n\tdack->addck_d[0][0] = (u16)rtw89_phy_read32_mask(rtwdev, R_S0_ADDCK,\n\t\t\t\t\t\t\t B_S0_ADDCK_Q);\n\tdack->addck_d[0][1] = (u16)rtw89_phy_read32_mask(rtwdev, R_S0_ADDCK,\n\t\t\t\t\t\t\t B_S0_ADDCK_I);\n\n\trtw89_phy_write32_clr(rtwdev, R_S1_RXDC2, B_S1_RXDC2_SEL);\n\tdack->addck_d[1][0] = (u16)rtw89_phy_read32_mask(rtwdev, R_S1_ADDCK,\n\t\t\t\t\t\t\t B_S1_ADDCK_Q);\n\tdack->addck_d[1][1] = (u16)rtw89_phy_read32_mask(rtwdev, R_S1_ADDCK,\n\t\t\t\t\t\t\t B_S1_ADDCK_I);\n}\n\nstatic void _addck_reload(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\n\trtw89_phy_write32_mask(rtwdev, R_S0_RXDC, B_S0_RXDC_I, dack->addck_d[0][0]);\n\trtw89_phy_write32_mask(rtwdev, R_S0_RXDC2, B_S0_RXDC2_Q2,\n\t\t\t       (dack->addck_d[0][1] >> 6));\n\trtw89_phy_write32_mask(rtwdev, R_S0_RXDC, B_S0_RXDC_Q,\n\t\t\t       (dack->addck_d[0][1] & 0x3f));\n\trtw89_phy_write32_set(rtwdev, R_S0_RXDC2, B_S0_RXDC2_MEN);\n\trtw89_phy_write32_mask(rtwdev, R_S1_RXDC, B_S1_RXDC_I, dack->addck_d[1][0]);\n\trtw89_phy_write32_mask(rtwdev, R_S1_RXDC2, B_S1_RXDC2_Q2,\n\t\t\t       (dack->addck_d[1][1] >> 6));\n\trtw89_phy_write32_mask(rtwdev, R_S1_RXDC, B_S1_RXDC_Q,\n\t\t\t       (dack->addck_d[1][1] & 0x3f));\n\trtw89_phy_write32_set(rtwdev, R_S1_RXDC2, B_S1_RXDC2_EN);\n}\n\nstatic void _dack_backup_s0(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\n\trtw89_phy_write32_set(rtwdev, R_S0_DACKI, B_S0_DACKI_EN);\n\trtw89_phy_write32_set(rtwdev, R_S0_DACKQ, B_S0_DACKQ_EN);\n\trtw89_phy_write32_set(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG);\n\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_S0_DACKI, B_S0_DACKI_AR, i);\n\t\tdack->msbk_d[0][0][i] =\n\t\t\t(u8)rtw89_phy_read32_mask(rtwdev, R_S0_DACKI7, B_S0_DACKI7_K);\n\t\trtw89_phy_write32_mask(rtwdev, R_S0_DACKQ, B_S0_DACKQ_AR, i);\n\t\tdack->msbk_d[0][1][i] =\n\t\t\t(u8)rtw89_phy_read32_mask(rtwdev, R_S0_DACKQ7, B_S0_DACKQ7_K);\n\t}\n\tdack->biask_d[0][0] = (u16)rtw89_phy_read32_mask(rtwdev, R_S0_DACKI2,\n\t\t\t\t\t\t\t B_S0_DACKI2_K);\n\tdack->biask_d[0][1] = (u16)rtw89_phy_read32_mask(rtwdev, R_S0_DACKQ2,\n\t\t\t\t\t\t\t B_S0_DACKQ2_K);\n\tdack->dadck_d[0][0] = (u8)rtw89_phy_read32_mask(rtwdev, R_S0_DACKI8,\n\t\t\t\t\t\t\tB_S0_DACKI8_K) - 8;\n\tdack->dadck_d[0][1] = (u8)rtw89_phy_read32_mask(rtwdev, R_S0_DACKQ8,\n\t\t\t\t\t\t\tB_S0_DACKQ8_K) - 8;\n}\n\nstatic void _dack_backup_s1(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\n\trtw89_phy_write32_set(rtwdev, R_S1_DACKI, B_S1_DACKI_EN);\n\trtw89_phy_write32_set(rtwdev, R_S1_DACKQ, B_S1_DACKQ_EN);\n\trtw89_phy_write32_set(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON);\n\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_S1_DACKI, B_S1_DACKI_AR, i);\n\t\tdack->msbk_d[1][0][i] =\n\t\t\t(u8)rtw89_phy_read32_mask(rtwdev, R_S1_DACKI7, B_S1_DACKI_K);\n\t\trtw89_phy_write32_mask(rtwdev, R_S1_DACKQ, B_S1_DACKQ_AR, i);\n\t\tdack->msbk_d[1][1][i] =\n\t\t\t(u8)rtw89_phy_read32_mask(rtwdev, R_S1_DACKQ7, B_S1_DACKQ7_K);\n\t}\n\tdack->biask_d[1][0] =\n\t\t(u16)rtw89_phy_read32_mask(rtwdev, R_S1_DACKI2, B_S1_DACKI2_K);\n\tdack->biask_d[1][1] =\n\t\t(u16)rtw89_phy_read32_mask(rtwdev, R_S1_DACKQ2, B_S1_DACKQ2_K);\n\tdack->dadck_d[1][0] =\n\t\t(u8)rtw89_phy_read32_mask(rtwdev, R_S1_DACKI8, B_S1_DACKI8_K) - 8;\n\tdack->dadck_d[1][1] =\n\t\t(u8)rtw89_phy_read32_mask(rtwdev, R_S1_DACKQ8, B_S1_DACKQ8_K) - 8;\n}\n\nstatic void _dack_reload_by_path(struct rtw89_dev *rtwdev,\n\t\t\t\t enum rtw89_rf_path path, u8 index)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 tmp = 0, tmp_offset, tmp_reg;\n\tu8 i;\n\tu32 idx_offset, path_offset;\n\n\tif (index == 0)\n\t\tidx_offset = 0;\n\telse\n\t\tidx_offset = 0x50;\n\n\tif (path == RF_PATH_A)\n\t\tpath_offset = 0;\n\telse\n\t\tpath_offset = 0x2000;\n\n\ttmp_offset = idx_offset + path_offset;\n\t \n\ttmp = 0x0;\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR / 4; i++)\n\t\ttmp |= dack->msbk_d[path][index][i + 12] << (i * 8);\n\ttmp_reg = 0x5e14 + tmp_offset;\n\trtw89_phy_write32(rtwdev, tmp_reg, tmp);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", tmp_reg,\n\t\t    rtw89_phy_read32_mask(rtwdev, tmp_reg, MASKDWORD));\n\t \n\ttmp = 0x0;\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR / 4; i++)\n\t\ttmp |= dack->msbk_d[path][index][i + 8] << (i * 8);\n\ttmp_reg = 0x5e18 + tmp_offset;\n\trtw89_phy_write32(rtwdev, tmp_reg, tmp);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", tmp_reg,\n\t\t    rtw89_phy_read32_mask(rtwdev, tmp_reg, MASKDWORD));\n\t \n\ttmp = 0x0;\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR / 4; i++)\n\t\ttmp |= dack->msbk_d[path][index][i + 4] << (i * 8);\n\ttmp_reg = 0x5e1c + tmp_offset;\n\trtw89_phy_write32(rtwdev, tmp_reg, tmp);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", tmp_reg,\n\t\t    rtw89_phy_read32_mask(rtwdev, tmp_reg, MASKDWORD));\n\t \n\ttmp = 0x0;\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR / 4; i++)\n\t\ttmp |= dack->msbk_d[path][index][i] << (i * 8);\n\ttmp_reg = 0x5e20 + tmp_offset;\n\trtw89_phy_write32(rtwdev, tmp_reg, tmp);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", tmp_reg,\n\t\t    rtw89_phy_read32_mask(rtwdev, tmp_reg, MASKDWORD));\n\t \n\ttmp = 0x0;\n\ttmp = (dack->biask_d[path][index] << 22) |\n\t       (dack->dadck_d[path][index] << 14);\n\ttmp_reg = 0x5e24 + tmp_offset;\n\trtw89_phy_write32(rtwdev, tmp_reg, tmp);\n}\n\nstatic void _dack_reload(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < 2; i++)\n\t\t_dack_reload_by_path(rtwdev, path, i);\n\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_rfk_dack_reload_defs_a_tbl,\n\t\t\t\t &rtw8852a_rfk_dack_reload_defs_b_tbl);\n}\n\n#define ADDC_T_AVG 100\nstatic void _check_addc(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\ts32 dc_re = 0, dc_im = 0;\n\tu32 tmp;\n\tu32 i;\n\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_rfk_check_addc_defs_a_tbl,\n\t\t\t\t &rtw8852a_rfk_check_addc_defs_b_tbl);\n\n\tfor (i = 0; i < ADDC_T_AVG; i++) {\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_DBG32_D, MASKDWORD);\n\t\tdc_re += sign_extend32(FIELD_GET(0xfff000, tmp), 11);\n\t\tdc_im += sign_extend32(FIELD_GET(0xfff, tmp), 11);\n\t}\n\n\tdc_re /= ADDC_T_AVG;\n\tdc_im /= ADDC_T_AVG;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S%d,dc_re = 0x%x,dc_im =0x%x\\n\", path, dc_re, dc_im);\n}\n\nstatic void _addck(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 val;\n\tint ret;\n\n\t \n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_addck_reset_defs_a_tbl);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]before S0 ADDCK\\n\");\n\t_check_addc(rtwdev, RF_PATH_A);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_addck_trigger_defs_a_tbl);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t       false, rtwdev, 0x1e00, BIT(0));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 ADDCK timeout\\n\");\n\t\tdack->addck_timeout[0] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]ADDCK ret = %d\\n\", ret);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S0 ADDCK\\n\");\n\t_check_addc(rtwdev, RF_PATH_A);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_addck_restore_defs_a_tbl);\n\n\t \n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_addck_reset_defs_b_tbl);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]before S1 ADDCK\\n\");\n\t_check_addc(rtwdev, RF_PATH_B);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_addck_trigger_defs_b_tbl);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t       false, rtwdev, 0x3e00, BIT(0));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 ADDCK timeout\\n\");\n\t\tdack->addck_timeout[1] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]ADDCK ret = %d\\n\", ret);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S1 ADDCK\\n\");\n\t_check_addc(rtwdev, RF_PATH_B);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_addck_restore_defs_b_tbl);\n}\n\nstatic void _check_dadc(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_rfk_check_dadc_defs_f_a_tbl,\n\t\t\t\t &rtw8852a_rfk_check_dadc_defs_f_b_tbl);\n\n\t_check_addc(rtwdev, path);\n\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_rfk_check_dadc_defs_r_a_tbl,\n\t\t\t\t &rtw8852a_rfk_check_dadc_defs_r_b_tbl);\n}\n\nstatic void _dack_s0(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 val;\n\tint ret;\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dack_defs_f_a_tbl);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t       false, rtwdev, 0x5e28, BIT(15));\n\tret |= read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t\tfalse, rtwdev, 0x5e78, BIT(15));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 MSBK timeout\\n\");\n\t\tdack->msbk_timeout[0] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK ret = %d\\n\", ret);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dack_defs_m_a_tbl);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t       false, rtwdev, 0x5e48, BIT(17));\n\tret |= read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t\tfalse, rtwdev, 0x5e98, BIT(17));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 DADACK timeout\\n\");\n\t\tdack->dadck_timeout[0] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK ret = %d\\n\", ret);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dack_defs_r_a_tbl);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S0 DADCK\\n\");\n\t_check_dadc(rtwdev, RF_PATH_A);\n\n\t_dack_backup_s0(rtwdev);\n\t_dack_reload(rtwdev, RF_PATH_A);\n\n\trtw89_phy_write32_clr(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG);\n}\n\nstatic void _dack_s1(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 val;\n\tint ret;\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dack_defs_f_b_tbl);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t       false, rtwdev, 0x7e28, BIT(15));\n\tret |= read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t\tfalse, rtwdev, 0x7e78, BIT(15));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 MSBK timeout\\n\");\n\t\tdack->msbk_timeout[1] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK ret = %d\\n\", ret);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dack_defs_m_b_tbl);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t       false, rtwdev, 0x7e48, BIT(17));\n\tret |= read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t\tfalse, rtwdev, 0x7e98, BIT(17));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 DADCK timeout\\n\");\n\t\tdack->dadck_timeout[1] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK ret = %d\\n\", ret);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dack_defs_r_b_tbl);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S1 DADCK\\n\");\n\t_check_dadc(rtwdev, RF_PATH_B);\n\n\t_dack_backup_s1(rtwdev);\n\t_dack_reload(rtwdev, RF_PATH_B);\n\n\trtw89_phy_write32_clr(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON);\n}\n\nstatic void _dack(struct rtw89_dev *rtwdev)\n{\n\t_dack_s0(rtwdev);\n\t_dack_s1(rtwdev);\n}\n\nstatic void _dac_cal(struct rtw89_dev *rtwdev, bool force)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 rf0_0, rf1_0;\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, RTW89_PHY_0, RF_AB);\n\n\tdack->dack_done = false;\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK b\\n\");\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK start!!!\\n\");\n\trf0_0 = rtw89_read_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK);\n\trf1_0 = rtw89_read_rf(rtwdev, RF_PATH_B, RR_MOD, RFREG_MASK);\n\t_afe_init(rtwdev);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK, 0x30001);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_MOD, RFREG_MASK, 0x30001);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_ONESHOT_START);\n\t_addck(rtwdev);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_ONESHOT_STOP);\n\t_addck_backup(rtwdev);\n\t_addck_reload(rtwdev);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK, 0x40001);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_MOD, RFREG_MASK, 0x40001);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MODOPT, RFREG_MASK, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_MODOPT, RFREG_MASK, 0x0);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_ONESHOT_START);\n\t_dack(rtwdev);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_ONESHOT_STOP);\n\t_dack_dump(rtwdev);\n\tdack->dack_done = true;\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK, rf0_0);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_MOD, RFREG_MASK, rf1_0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RR_RSV1_RST, 0x1);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV1, RR_RSV1_RST, 0x1);\n\tdack->dack_cnt++;\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK finish!!!\\n\");\n}\n\n#define RTW8852A_NCTL_VER 0xd\n#define RTW8852A_IQK_VER 0x2a\n#define RTW8852A_IQK_SS 2\n#define RTW8852A_IQK_THR_REK 8\n#define RTW8852A_IQK_CFIR_GROUP_NR 4\n\nenum rtw8852a_iqk_type {\n\tID_TXAGC,\n\tID_FLOK_COARSE,\n\tID_FLOK_FINE,\n\tID_TXK,\n\tID_RXAGC,\n\tID_RXK,\n\tID_NBTXK,\n\tID_NBRXK,\n};\n\nstatic void _iqk_read_fft_dbcc0(struct rtw89_dev *rtwdev, u8 path)\n{\n\tu8 i = 0x0;\n\tu32 fft[6] = {0x0};\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKDWORD, 0x00160000);\n\tfft[0] = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKDWORD, 0x00170000);\n\tfft[1] = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKDWORD, 0x00180000);\n\tfft[2] = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKDWORD, 0x00190000);\n\tfft[3] = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKDWORD, 0x001a0000);\n\tfft[4] = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKDWORD, 0x001b0000);\n\tfft[5] = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD);\n\tfor (i = 0; i < 6; i++)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x,fft[%x]= %x\\n\",\n\t\t\t    path, i, fft[i]);\n}\n\nstatic void _iqk_read_xym_dbcc0(struct rtw89_dev *rtwdev, u8 path)\n{\n\tu8 i = 0x0;\n\tu32 tmp = 0x0;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, B_NCTL_CFG_SPAGE, path);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF, B_IQK_DIF_TRX, 0x1);\n\n\tfor (i = 0x0; i < 0x18; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N2, MASKDWORD, 0x000000c0 + i);\n\t\trtw89_phy_write32_clr(rtwdev, R_NCTL_N2, MASKDWORD);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, 0x8%lx38 = %x\\n\",\n\t\t\t    path, BIT(path), tmp);\n\t\tudelay(1);\n\t}\n\trtw89_phy_write32_clr(rtwdev, R_IQK_DIF, B_IQK_DIF_TRX);\n\trtw89_phy_write32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD, 0x40000000);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_N2, MASKDWORD, 0x80010100);\n\tudelay(1);\n}\n\nstatic void _iqk_read_txcfir_dbcc0(struct rtw89_dev *rtwdev, u8 path,\n\t\t\t\t   u8 group)\n{\n\tstatic const u32 base_addrs[RTW8852A_IQK_SS][RTW8852A_IQK_CFIR_GROUP_NR] = {\n\t\t{0x8f20, 0x8f54, 0x8f88, 0x8fbc},\n\t\t{0x9320, 0x9354, 0x9388, 0x93bc},\n\t};\n\tu8 idx = 0x0;\n\tu32 tmp = 0x0;\n\tu32 base_addr;\n\n\tif (path >= RTW8852A_IQK_SS) {\n\t\trtw89_warn(rtwdev, \"cfir path %d out of range\\n\", path);\n\t\treturn;\n\t}\n\tif (group >= RTW8852A_IQK_CFIR_GROUP_NR) {\n\t\trtw89_warn(rtwdev, \"cfir group %d out of range\\n\", group);\n\t\treturn;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\trtw89_phy_write32_mask(rtwdev, R_W_COEF + (path << 8), MASKDWORD, 0x00000001);\n\n\tbase_addr = base_addrs[path][group];\n\n\tfor (idx = 0; idx < 0x0d; idx++) {\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, base_addr + (idx << 2), MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK] %x = %x\\n\",\n\t\t\t    base_addr + (idx << 2), tmp);\n\t}\n\n\tif (path == 0x0) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]\\n\");\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXCFIR_P0C0, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x8f50 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXCFIR_P0C1, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x8f84 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXCFIR_P0C2, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x8fb8 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXCFIR_P0C3, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x8fec = %x\\n\", tmp);\n\t} else {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]\\n\");\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXCFIR_P1C0, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x9350 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXCFIR_P1C1, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x9384 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXCFIR_P1C2, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x93b8 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXCFIR_P1C3, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x93ec = %x\\n\", tmp);\n\t}\n\trtw89_phy_write32_clr(rtwdev, R_W_COEF + (path << 8), MASKDWORD);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT + (path << 8), B_KIP_RPT_SEL, 0xc);\n\tudelay(1);\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_RPT_PER + (path << 8), MASKDWORD);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, 0x8%lxfc = %x\\n\", path,\n\t\t    BIT(path), tmp);\n}\n\nstatic void _iqk_read_rxcfir_dbcc0(struct rtw89_dev *rtwdev, u8 path,\n\t\t\t\t   u8 group)\n{\n\tstatic const u32 base_addrs[RTW8852A_IQK_SS][RTW8852A_IQK_CFIR_GROUP_NR] = {\n\t\t{0x8d00, 0x8d44, 0x8d88, 0x8dcc},\n\t\t{0x9100, 0x9144, 0x9188, 0x91cc},\n\t};\n\tu8 idx = 0x0;\n\tu32 tmp = 0x0;\n\tu32 base_addr;\n\n\tif (path >= RTW8852A_IQK_SS) {\n\t\trtw89_warn(rtwdev, \"cfir path %d out of range\\n\", path);\n\t\treturn;\n\t}\n\tif (group >= RTW8852A_IQK_CFIR_GROUP_NR) {\n\t\trtw89_warn(rtwdev, \"cfir group %d out of range\\n\", group);\n\t\treturn;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\trtw89_phy_write32_mask(rtwdev, R_W_COEF + (path << 8), MASKDWORD, 0x00000001);\n\n\tbase_addr = base_addrs[path][group];\n\tfor (idx = 0; idx < 0x10; idx++) {\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, base_addr + (idx << 2), MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]%x = %x\\n\",\n\t\t\t    base_addr + (idx << 2), tmp);\n\t}\n\n\tif (path == 0x0) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]\\n\");\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXCFIR_P0C0, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x8d40 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXCFIR_P0C1, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x8d84 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXCFIR_P0C2, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x8dc8 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXCFIR_P0C3, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x8e0c = %x\\n\", tmp);\n\t} else {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]\\n\");\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXCFIR_P1C0, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x9140 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXCFIR_P1C1, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x9184 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXCFIR_P1C2, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x91c8 = %x\\n\", tmp);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXCFIR_P1C3, MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] 0x920c = %x\\n\", tmp);\n\t}\n\trtw89_phy_write32_clr(rtwdev, R_W_COEF + (path << 8), MASKDWORD);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT + (path << 8), B_KIP_RPT_SEL, 0xd);\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_RPT_PER + (path << 8), MASKDWORD);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, 0x8%lxfc = %x\\n\", path,\n\t\t    BIT(path), tmp);\n}\n\nstatic void _iqk_sram(struct rtw89_dev *rtwdev, u8 path)\n{\n\tu32 tmp = 0x0;\n\tu32 i = 0x0;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKDWORD, 0x00020000);\n\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX2, MASKDWORD, 0x00000080);\n\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX, MASKDWORD, 0x00010000);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x009);\n\n\tfor (i = 0; i <= 0x9f; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX, MASKDWORD, 0x00010000 + i);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCI);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]0x%x\\n\", tmp);\n\t}\n\n\tfor (i = 0; i <= 0x9f; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX, MASKDWORD, 0x00010000 + i);\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCQ);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]0x%x\\n\", tmp);\n\t}\n\trtw89_phy_write32_clr(rtwdev, R_SRAM_IQRX2, MASKDWORD);\n\trtw89_phy_write32_clr(rtwdev, R_SRAM_IQRX, MASKDWORD);\n}\n\nstatic void _iqk_rxk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 tmp = 0x0;\n\n\trtw89_phy_write32_set(rtwdev, R_P0_NRBW + (path << 13), B_P0_NRBW_DBG);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x3);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0xa041);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15_H2, 0x3);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_FLTRST, 0x0);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_FLTRST, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15_H2, 0x0);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RST, 0x0303);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RST, 0x0000);\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RXK2);\n\t\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_SEL2G, 0x1);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RXK2);\n\t\trtw89_write_rf(rtwdev, path, RR_WLSEL, RR_WLSEL_AG, 0x5);\n\t\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_SEL5G, 0x1);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\ttmp = rtw89_read_rf(rtwdev, path, RR_CFGCH, RFREG_MASK);\n\trtw89_write_rf(rtwdev, path, RR_RSV4, RFREG_MASK, tmp);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_OFF, 0x13);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x1);\n\tfsleep(128);\n}\n\nstatic bool _iqk_check_cal(struct rtw89_dev *rtwdev, u8 path, u8 ktype)\n{\n\tu32 tmp;\n\tu32 val;\n\tint ret;\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x55, 1, 8200,\n\t\t\t\t       false, rtwdev, 0xbff8, MASKBYTE0);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]IQK timeout!!!\\n\");\n\trtw89_phy_write32_clr(rtwdev, R_NCTL_N1, MASKBYTE0);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, ret=%d\\n\", path, ret);\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, type= %x, 0x8008 = 0x%x\\n\", path, ktype, tmp);\n\n\treturn false;\n}\n\nstatic bool _iqk_one_shot(struct rtw89_dev *rtwdev,\n\t\t\t  enum rtw89_phy_idx phy_idx, u8 path, u8 ktype)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool fail = false;\n\tu32 iqk_cmd = 0x0;\n\tu8 phy_map = rtw89_btc_path_phymap(rtwdev, phy_idx, path);\n\tu32 addr_rfc_ctl = 0x0;\n\n\tif (path == RF_PATH_A)\n\t\taddr_rfc_ctl = 0x5864;\n\telse\n\t\taddr_rfc_ctl = 0x7864;\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_START);\n\tswitch (ktype) {\n\tcase ID_TXAGC:\n\t\tiqk_cmd = 0x008 | (1 << (4 + path)) | (path << 1);\n\t\tbreak;\n\tcase ID_FLOK_COARSE:\n\t\trtw89_phy_write32_set(rtwdev, addr_rfc_ctl, 0x20000000);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x009);\n\t\tiqk_cmd = 0x108 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_FLOK_FINE:\n\t\trtw89_phy_write32_set(rtwdev, addr_rfc_ctl, 0x20000000);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x009);\n\t\tiqk_cmd = 0x208 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_TXK:\n\t\trtw89_phy_write32_clr(rtwdev, addr_rfc_ctl, 0x20000000);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x025);\n\t\tiqk_cmd = 0x008 | (1 << (path + 4)) |\n\t\t\t  (((0x8 + iqk_info->iqk_bw[path]) & 0xf) << 8);\n\t\tbreak;\n\tcase ID_RXAGC:\n\t\tiqk_cmd = 0x508 | (1 << (4 + path)) | (path << 1);\n\t\tbreak;\n\tcase ID_RXK:\n\t\trtw89_phy_write32_set(rtwdev, addr_rfc_ctl, 0x20000000);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x011);\n\t\tiqk_cmd = 0x008 | (1 << (path + 4)) |\n\t\t\t  (((0xb + iqk_info->iqk_bw[path]) & 0xf) << 8);\n\t\tbreak;\n\tcase ID_NBTXK:\n\t\trtw89_phy_write32_clr(rtwdev, addr_rfc_ctl, 0x20000000);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x025);\n\t\tiqk_cmd = 0x308 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_NBRXK:\n\t\trtw89_phy_write32_set(rtwdev, addr_rfc_ctl, 0x20000000);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x011);\n\t\tiqk_cmd = 0x608 | (1 << (4 + path));\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD, iqk_cmd + 1);\n\trtw89_phy_write32_set(rtwdev, R_DPK_CTL, B_DPK_CTL_EN);\n\tudelay(1);\n\tfail = _iqk_check_cal(rtwdev, path, ktype);\n\tif (iqk_info->iqk_xym_en)\n\t\t_iqk_read_xym_dbcc0(rtwdev, path);\n\tif (iqk_info->iqk_fft_en)\n\t\t_iqk_read_fft_dbcc0(rtwdev, path);\n\tif (iqk_info->iqk_sram_en)\n\t\t_iqk_sram(rtwdev, path);\n\tif (iqk_info->iqk_cfir_en) {\n\t\tif (ktype == ID_TXK) {\n\t\t\t_iqk_read_txcfir_dbcc0(rtwdev, path, 0x0);\n\t\t\t_iqk_read_txcfir_dbcc0(rtwdev, path, 0x1);\n\t\t\t_iqk_read_txcfir_dbcc0(rtwdev, path, 0x2);\n\t\t\t_iqk_read_txcfir_dbcc0(rtwdev, path, 0x3);\n\t\t} else {\n\t\t\t_iqk_read_rxcfir_dbcc0(rtwdev, path, 0x0);\n\t\t\t_iqk_read_rxcfir_dbcc0(rtwdev, path, 0x1);\n\t\t\t_iqk_read_rxcfir_dbcc0(rtwdev, path, 0x2);\n\t\t\t_iqk_read_rxcfir_dbcc0(rtwdev, path, 0x3);\n\t\t}\n\t}\n\n\trtw89_phy_write32_clr(rtwdev, addr_rfc_ctl, 0x20000000);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_STOP);\n\n\treturn fail;\n}\n\nstatic bool _rxk_group_sel(struct rtw89_dev *rtwdev,\n\t\t\t   enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tstatic const u32 rxgn_a[4] = {0x18C, 0x1A0, 0x28C, 0x2A0};\n\tstatic const u32 attc2_a[4] = {0x0, 0x0, 0x07, 0x30};\n\tstatic const u32 attc1_a[4] = {0x7, 0x5, 0x1, 0x1};\n\tstatic const u32 rxgn_g[4] = {0x1CC, 0x1E0, 0x2CC, 0x2E0};\n\tstatic const u32 attc2_g[4] = {0x0, 0x15, 0x3, 0x1a};\n\tstatic const u32 attc1_g[4] = {0x1, 0x0, 0x1, 0x0};\n\tu8 gp = 0x0;\n\tbool fail = false;\n\tu32 rf0 = 0x0;\n\n\tfor (gp = 0; gp < 0x4; gp++) {\n\t\tswitch (iqk_info->iqk_band[path]) {\n\t\tcase RTW89_BAND_2G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXG, rxgn_g[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_C2G, attc2_g[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_C1G, attc1_g[gp]);\n\t\t\tbreak;\n\t\tcase RTW89_BAND_5G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXG, rxgn_a[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_C2, attc2_a[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_C1, attc1_a[gp]);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\trtw89_phy_write32_set(rtwdev, R_IQK_CFG, B_IQK_CFG_SET);\n\t\trf0 = rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF2, B_IQK_DIF2_RXPI,\n\t\t\t\t       rf0 | iqk_info->syn1to2);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_COM, MASKDWORD, 0x40010100);\n\t\trtw89_phy_write32_clr(rtwdev, R_IQK_RES + (path << 8), B_IQK_RES_RXCFIR);\n\t\trtw89_phy_write32_set(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SEL);\n\t\trtw89_phy_write32_clr(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_G3);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_GP, gp);\n\t\trtw89_phy_write32_mask(rtwdev, R_IOQ_IQK_DPK, B_IOQ_IQK_DPK_EN, 0x1);\n\t\trtw89_phy_write32_clr(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP);\n\t\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_RXK);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQKINF, BIT(16 + gp + path * 4), fail);\n\t}\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_SEL2G, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x0);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_SEL5G, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_WLSEL, RR_WLSEL_AG, 0x0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tiqk_info->nb_rxcfir[path] = 0x40000000;\n\trtw89_phy_write32_mask(rtwdev, R_IQK_RES + (path << 8),\n\t\t\t       B_IQK_RES_RXCFIR, 0x5);\n\tiqk_info->is_wb_rxiqk[path] = true;\n\treturn false;\n}\n\nstatic bool _iqk_nbrxk(struct rtw89_dev *rtwdev,\n\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 group = 0x0;\n\tu32 rf0 = 0x0, tmp = 0x0;\n\tu32 idxrxgain_a = 0x1a0;\n\tu32 idxattc2_a = 0x00;\n\tu32 idxattc1_a = 0x5;\n\tu32 idxrxgain_g = 0x1E0;\n\tu32 idxattc2_g = 0x15;\n\tu32 idxattc1_g = 0x0;\n\tbool fail = false;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXG, idxrxgain_g);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_C2G, idxattc2_g);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_C1G, idxattc1_g);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXG, idxrxgain_a);\n\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_C2, idxattc2_a);\n\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_C1, idxattc1_a);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\trtw89_phy_write32_set(rtwdev, R_IQK_CFG, B_IQK_CFG_SET);\n\trf0 = rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF2, B_IQK_DIF2_RXPI,\n\t\t\t       rf0 | iqk_info->syn1to2);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_COM, MASKDWORD, 0x40010100);\n\trtw89_phy_write32_clr(rtwdev, R_IQK_RES + (path << 8), B_IQK_RES_RXCFIR);\n\trtw89_phy_write32_set(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SEL);\n\trtw89_phy_write32_clr(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_G3);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t       B_CFIR_LUT_GP, group);\n\trtw89_phy_write32_set(rtwdev, R_IOQ_IQK_DPK, B_IOQ_IQK_DPK_EN);\n\trtw89_phy_write32_clr(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP);\n\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBRXK);\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_SEL2G, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x0);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_SEL5G, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_WLSEL, RR_WLSEL_AG, 0x0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tif (!fail) {\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD);\n\t\tiqk_info->nb_rxcfir[path] = tmp | 0x2;\n\t} else {\n\t\tiqk_info->nb_rxcfir[path] = 0x40000002;\n\t}\n\treturn fail;\n}\n\nstatic void _iqk_rxclk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\tif (iqk_info->iqk_bw[path] == RTW89_CHANNEL_WIDTH_80) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_SYS + (path << 8),\n\t\t\t\t       MASKDWORD, 0x4d000a08);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK + (path << 13),\n\t\t\t\t       B_P0_RXCK_VAL, 0x2);\n\t\trtw89_phy_write32_set(rtwdev, R_P0_RXCK + (path << 13), B_P0_RXCK_ON);\n\t\trtw89_phy_write32_set(rtwdev, R_UPD_CLK_ADC, B_UPD_CLK_ADC_ON);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK_ADC, B_UPD_CLK_ADC_VAL, 0x1);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_SYS + (path << 8),\n\t\t\t\t       MASKDWORD, 0x44000a08);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK + (path << 13),\n\t\t\t\t       B_P0_RXCK_VAL, 0x1);\n\t\trtw89_phy_write32_set(rtwdev, R_P0_RXCK + (path << 13), B_P0_RXCK_ON);\n\t\trtw89_phy_write32_set(rtwdev, R_UPD_CLK_ADC, B_UPD_CLK_ADC_ON);\n\t\trtw89_phy_write32_clr(rtwdev, R_UPD_CLK_ADC, B_UPD_CLK_ADC_VAL);\n\t}\n}\n\nstatic bool _txk_group_sel(struct rtw89_dev *rtwdev,\n\t\t\t   enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstatic const u32 a_txgain[4] = {0xE466, 0x646D, 0xE4E2, 0x64ED};\n\tstatic const u32 g_txgain[4] = {0x60e8, 0x60f0, 0x61e8, 0x61ED};\n\tstatic const u32 a_itqt[4] = {0x12, 0x12, 0x12, 0x1b};\n\tstatic const u32 g_itqt[4] = {0x09, 0x12, 0x12, 0x12};\n\tstatic const u32 g_attsmxr[4] = {0x0, 0x1, 0x1, 0x1};\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool fail = false;\n\tu8 gp = 0x0;\n\tu32 tmp = 0x0;\n\n\tfor (gp = 0x0; gp < 0x4; gp++) {\n\t\tswitch (iqk_info->iqk_band[path]) {\n\t\tcase RTW89_BAND_2G:\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RFGAIN_BND + (path << 8),\n\t\t\t\t\t       B_RFGAIN_BND, 0x08);\n\t\t\trtw89_write_rf(rtwdev, path, RR_GAINTX, RR_GAINTX_ALL,\n\t\t\t\t       g_txgain[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXG1, RR_TXG1_ATT1,\n\t\t\t\t       g_attsmxr[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXG2, RR_TXG2_ATT0,\n\t\t\t\t       g_attsmxr[gp]);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t\t       MASKDWORD, g_itqt[gp]);\n\t\t\tbreak;\n\t\tcase RTW89_BAND_5G:\n\t\t\trtw89_phy_write32_mask(rtwdev, R_RFGAIN_BND + (path << 8),\n\t\t\t\t\t       B_RFGAIN_BND, 0x04);\n\t\t\trtw89_write_rf(rtwdev, path, RR_GAINTX, RR_GAINTX_ALL,\n\t\t\t\t       a_txgain[gp]);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t\t       MASKDWORD, a_itqt[gp]);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\trtw89_phy_write32_clr(rtwdev, R_IQK_RES + (path << 8), B_IQK_RES_TXCFIR);\n\t\trtw89_phy_write32_set(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SEL);\n\t\trtw89_phy_write32_set(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_G3);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_GP, gp);\n\t\trtw89_phy_write32_clr(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP);\n\t\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_TXK);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQKINF, BIT(8 + gp + path * 4), fail);\n\t}\n\n\tiqk_info->nb_txcfir[path] = 0x40000000;\n\trtw89_phy_write32_mask(rtwdev, R_IQK_RES + (path << 8),\n\t\t\t       B_IQK_RES_TXCFIR, 0x5);\n\tiqk_info->is_wb_txiqk[path] = true;\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, 0x8%lx38 = 0x%x\\n\", path,\n\t\t    BIT(path), tmp);\n\treturn false;\n}\n\nstatic bool _iqk_nbtxk(struct rtw89_dev *rtwdev,\n\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 group = 0x2;\n\tu32 a_mode_txgain = 0x64e2;\n\tu32 g_mode_txgain = 0x61e8;\n\tu32 attsmxr = 0x1;\n\tu32 itqt = 0x12;\n\tu32 tmp = 0x0;\n\tbool fail = false;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_phy_write32_mask(rtwdev, R_RFGAIN_BND + (path << 8),\n\t\t\t\t       B_RFGAIN_BND, 0x08);\n\t\trtw89_write_rf(rtwdev, path, RR_GAINTX, RR_GAINTX_ALL, g_mode_txgain);\n\t\trtw89_write_rf(rtwdev, path, RR_TXG1, RR_TXG1_ATT1, attsmxr);\n\t\trtw89_write_rf(rtwdev, path, RR_TXG2, RR_TXG2_ATT0, attsmxr);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_phy_write32_mask(rtwdev, R_RFGAIN_BND + (path << 8),\n\t\t\t\t       B_RFGAIN_BND, 0x04);\n\t\trtw89_write_rf(rtwdev, path, RR_GAINTX, RR_GAINTX_ALL, a_mode_txgain);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\trtw89_phy_write32_clr(rtwdev, R_IQK_RES + (path << 8), B_IQK_RES_TXCFIR);\n\trtw89_phy_write32_set(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SEL);\n\trtw89_phy_write32_set(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_G3);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_GP, group);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), MASKDWORD, itqt);\n\trtw89_phy_write32_clr(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP);\n\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBTXK);\n\tif (!fail) {\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD);\n\t\tiqk_info->nb_txcfir[path] = tmp | 0x2;\n\t} else {\n\t\tiqk_info->nb_txcfir[path] = 0x40000002;\n\t}\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, 0x8%lx38 = 0x%x\\n\", path,\n\t\t    BIT(path), tmp);\n\treturn fail;\n}\n\nstatic void _lok_res_table(struct rtw89_dev *rtwdev, u8 path, u8 ibias)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, ibias = %x\\n\", path, ibias);\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RFREG_MASK, 0x2);\n\tif (iqk_info->iqk_band[path] == RTW89_BAND_2G)\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWA, RFREG_MASK, 0x0);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWA, RFREG_MASK, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RFREG_MASK, ibias);\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RFREG_MASK, 0x0);\n}\n\nstatic bool _lok_finetune_check(struct rtw89_dev *rtwdev, u8 path)\n{\n\tbool is_fail = false;\n\tu32 tmp = 0x0;\n\tu32 core_i = 0x0;\n\tu32 core_q = 0x0;\n\n\ttmp = rtw89_read_rf(rtwdev, path, RR_TXMO, RFREG_MASK);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK][FineLOK] S%x, 0x58 = 0x%x\\n\",\n\t\t    path, tmp);\n\tcore_i = FIELD_GET(RR_TXMO_COI, tmp);\n\tcore_q = FIELD_GET(RR_TXMO_COQ, tmp);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, i = 0x%x\\n\", path, core_i);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, q = 0x%x\\n\", path, core_q);\n\n\tif (core_i < 0x2 || core_i > 0x1d || core_q < 0x2 || core_q > 0x1d)\n\t\tis_fail = true;\n\treturn is_fail;\n}\n\nstatic bool _iqk_lok(struct rtw89_dev *rtwdev,\n\t\t     enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 rf0 = 0x0;\n\tu8 itqt = 0x12;\n\tbool fail = false;\n\tbool tmp = false;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_GAINTX, RR_GAINTX_ALL, 0xe5e0);\n\t\titqt = 0x09;\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_GAINTX, RR_GAINTX_ALL, 0xe4e0);\n\t\titqt = 0x12;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\trtw89_phy_write32_set(rtwdev, R_IQK_CFG, B_IQK_CFG_SET);\n\trf0 = rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF1, B_IQK_DIF1_TXPI,\n\t\t\t       rf0 | iqk_info->syn1to2);\n\trtw89_phy_write32_clr(rtwdev, R_IQK_RES + (path << 8), B_IQK_RES_TXCFIR);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SEL, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_G3, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_GP, 0x0);\n\trtw89_phy_write32_set(rtwdev, R_IOQ_IQK_DPK, B_IOQ_IQK_DPK_EN);\n\trtw89_phy_write32_clr(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), MASKDWORD, itqt);\n\ttmp = _iqk_one_shot(rtwdev, phy_idx, path, ID_FLOK_COARSE);\n\tiqk_info->lok_cor_fail[0][path] = tmp;\n\tfsleep(10);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), MASKDWORD, itqt);\n\ttmp = _iqk_one_shot(rtwdev, phy_idx, path, ID_FLOK_FINE);\n\tiqk_info->lok_fin_fail[0][path] = tmp;\n\tfail = _lok_finetune_check(rtwdev, path);\n\treturn fail;\n}\n\nstatic void _iqk_txk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\trtw89_phy_write32_set(rtwdev, R_P0_NRBW + (path << 13), B_P0_NRBW_DBG);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x1f);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x13);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0x0001);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0x0041);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RST, 0x0303);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RST, 0x0000);\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_XALNA2, RR_XALNA2_SW, 0x00);\n\t\trtw89_write_rf(rtwdev, path, RR_RCKD, RR_RCKD_POW, 0x3f);\n\t\trtw89_write_rf(rtwdev, path, RR_TXG1, RR_TXG1_ATT2, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXG1, RR_TXG1_ATT1, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TXG2, RR_TXG2_ATT0, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TXGA, RR_TXGA_LOK_EN, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTDBG, RR_LUTDBG_LOK, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWA, RR_LUTWA_MASK, 0x000);\n\t\trtw89_write_rf(rtwdev, path, RR_RSV2, RFREG_MASK, 0x80200);\n\t\trtw89_write_rf(rtwdev, path, RR_DTXLOK, RFREG_MASK, 0x80200);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK,\n\t\t\t       0x403e0 | iqk_info->syn1to2);\n\t\tudelay(1);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_XGLNA2, RR_XGLNA2_SW, 0x00);\n\t\trtw89_write_rf(rtwdev, path, RR_RCKD, RR_RCKD_POW, 0x3f);\n\t\trtw89_write_rf(rtwdev, path, RR_BIASA, RR_BIASA_A, 0x7);\n\t\trtw89_write_rf(rtwdev, path, RR_TXGA, RR_TXGA_LOK_EN, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTDBG, RR_LUTDBG_LOK, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWA, RR_LUTWA_MASK, 0x100);\n\t\trtw89_write_rf(rtwdev, path, RR_RSV2, RFREG_MASK, 0x80200);\n\t\trtw89_write_rf(rtwdev, path, RR_DTXLOK, RFREG_MASK, 0x80200);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RFREG_MASK, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RFREG_MASK, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK,\n\t\t\t       0x403e0 | iqk_info->syn1to2);\n\t\tudelay(1);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void _iqk_txclk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_SYS + (path << 8), MASKDWORD, 0xce000a08);\n}\n\nstatic void _iqk_info_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t  u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 tmp = 0x0;\n\tbool flag = 0x0;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d_thermal = %lu\\n\", path,\n\t\t    ewma_thermal_read(&rtwdev->phystat.avg_thermal[path]));\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d_LOK_COR_fail= %d\\n\", path,\n\t\t    iqk_info->lok_cor_fail[0][path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d_LOK_FIN_fail= %d\\n\", path,\n\t\t    iqk_info->lok_fin_fail[0][path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d_TXIQK_fail = %d\\n\", path,\n\t\t    iqk_info->iqk_tx_fail[0][path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d_RXIQK_fail= %d,\\n\", path,\n\t\t    iqk_info->iqk_rx_fail[0][path]);\n\tflag = iqk_info->lok_cor_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, BIT(0) << (path * 4), flag);\n\tflag = iqk_info->lok_fin_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, BIT(1) << (path * 4), flag);\n\tflag = iqk_info->iqk_tx_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, BIT(2) << (path * 4), flag);\n\tflag = iqk_info->iqk_rx_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, BIT(3) << (path * 4), flag);\n\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_IQK_RES + (path << 8), MASKDWORD);\n\tiqk_info->bp_iqkenable[path] = tmp;\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD);\n\tiqk_info->bp_txkresult[path] = tmp;\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD);\n\tiqk_info->bp_rxkresult[path] = tmp;\n\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF2, B_IQKINF2_KCNT,\n\t\t\t       (u8)iqk_info->iqk_times);\n\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_IQKINF, 0x0000000f << (path * 4));\n\tif (tmp != 0x0)\n\t\tiqk_info->iqk_fail_cnt++;\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF2, 0x00ff0000 << (path * 4),\n\t\t\t       iqk_info->iqk_fail_cnt);\n}\n\nstatic\nvoid _iqk_by_path(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool lok_is_fail = false;\n\tu8 ibias = 0x1;\n\tu8 i = 0;\n\n\t_iqk_txclk_setting(rtwdev, path);\n\n\tfor (i = 0; i < 3; i++) {\n\t\t_lok_res_table(rtwdev, path, ibias++);\n\t\t_iqk_txk_setting(rtwdev, path);\n\t\tlok_is_fail = _iqk_lok(rtwdev, phy_idx, path);\n\t\tif (!lok_is_fail)\n\t\t\tbreak;\n\t}\n\tif (iqk_info->is_nbiqk)\n\t\tiqk_info->iqk_tx_fail[0][path] = _iqk_nbtxk(rtwdev, phy_idx, path);\n\telse\n\t\tiqk_info->iqk_tx_fail[0][path] = _txk_group_sel(rtwdev, phy_idx, path);\n\n\t_iqk_rxclk_setting(rtwdev, path);\n\t_iqk_rxk_setting(rtwdev, path);\n\tif (iqk_info->is_nbiqk || rtwdev->dbcc_en || iqk_info->iqk_band[path] == RTW89_BAND_2G)\n\t\tiqk_info->iqk_rx_fail[0][path] = _iqk_nbrxk(rtwdev, phy_idx, path);\n\telse\n\t\tiqk_info->iqk_rx_fail[0][path] = _rxk_group_sel(rtwdev, phy_idx, path);\n\n\t_iqk_info_iqk(rtwdev, phy_idx, path);\n}\n\nstatic void _iqk_get_ch_info(struct rtw89_dev *rtwdev,\n\t\t\t     enum rtw89_phy_idx phy, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu32 reg_rf18 = 0x0, reg_35c = 0x0;\n\tu8 idx = 0;\n\tu8 get_empty_table = false;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\tfor  (idx = 0; idx < RTW89_IQK_CHS_NR; idx++) {\n\t\tif (iqk_info->iqk_mcc_ch[idx][path] == 0) {\n\t\t\tget_empty_table = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\tif (!get_empty_table) {\n\t\tidx = iqk_info->iqk_table_idx[path] + 1;\n\t\tif (idx > RTW89_IQK_CHS_NR - 1)\n\t\t\tidx = 0;\n\t}\n\treg_rf18 = rtw89_read_rf(rtwdev, path, RR_CFGCH, RFREG_MASK);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]cfg ch = %d\\n\", reg_rf18);\n\treg_35c = rtw89_phy_read32_mask(rtwdev, 0x35c, 0x00000c00);\n\n\tiqk_info->iqk_band[path] = chan->band_type;\n\tiqk_info->iqk_bw[path] = chan->band_width;\n\tiqk_info->iqk_ch[path] = chan->channel;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]iqk_info->iqk_band[%x] = 0x%x\\n\", path,\n\t\t    iqk_info->iqk_band[path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]iqk_info->iqk_bw[%x] = 0x%x\\n\",\n\t\t    path, iqk_info->iqk_bw[path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]iqk_info->iqk_ch[%x] = 0x%x\\n\",\n\t\t    path, iqk_info->iqk_ch[path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%d (PHY%d): / DBCC %s/ %s/ CH%d/ %s\\n\", path, phy,\n\t\t    rtwdev->dbcc_en ? \"on\" : \"off\",\n\t\t    iqk_info->iqk_band[path] == 0 ? \"2G\" :\n\t\t    iqk_info->iqk_band[path] == 1 ? \"5G\" : \"6G\",\n\t\t    iqk_info->iqk_ch[path],\n\t\t    iqk_info->iqk_bw[path] == 0 ? \"20M\" :\n\t\t    iqk_info->iqk_bw[path] == 1 ? \"40M\" : \"80M\");\n\tif (reg_35c == 0x01)\n\t\tiqk_info->syn1to2 = 0x1;\n\telse\n\t\tiqk_info->syn1to2 = 0x0;\n\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_VER, RTW8852A_IQK_VER);\n\trtw89_phy_write32_mask(rtwdev, R_IQKCH, 0x000f << (path * 16),\n\t\t\t       (u8)iqk_info->iqk_band[path]);\n\trtw89_phy_write32_mask(rtwdev, R_IQKCH, 0x00f0 << (path * 16),\n\t\t\t       (u8)iqk_info->iqk_bw[path]);\n\trtw89_phy_write32_mask(rtwdev, R_IQKCH, 0xff00 << (path * 16),\n\t\t\t       (u8)iqk_info->iqk_ch[path]);\n\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF2, 0x000000ff, RTW8852A_NCTL_VER);\n}\n\nstatic void _iqk_start_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t   u8 path)\n{\n\t_iqk_by_path(rtwdev, phy_idx, path);\n}\n\nstatic void _iqk_restore(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\trtw89_phy_write32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD,\n\t\t\t       iqk_info->nb_txcfir[path]);\n\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD,\n\t\t\t       iqk_info->nb_rxcfir[path]);\n\trtw89_phy_write32_clr(rtwdev, R_NCTL_RPT, MASKDWORD);\n\trtw89_phy_write32_clr(rtwdev, R_MDPK_RX_DCK, MASKDWORD);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x80000000);\n\trtw89_phy_write32_clr(rtwdev, R_KPATH_CFG, MASKDWORD);\n\trtw89_phy_write32_clr(rtwdev, R_GAPK, B_GAPK_ADR);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_SYS + (path << 8), MASKDWORD, 0x10010000);\n\trtw89_phy_write32_clr(rtwdev, R_KIP + (path << 8), B_KIP_RFGAIN);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_MAP + (path << 8), MASKDWORD, 0xe4e4e4e4);\n\trtw89_phy_write32_clr(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SEL);\n\trtw89_phy_write32_clr(rtwdev, R_KIP_IQP + (path << 8), B_KIP_IQP_IQSW);\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), MASKDWORD, 0x00000002);\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RCKD, RR_RCKD_POW, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\trtw89_write_rf(rtwdev, path, RR_TXRSV, RR_TXRSV_GAPK, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_BIAS, RR_BIAS_GAPK, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x1);\n}\n\nstatic void _iqk_afebb_restore(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tconst struct rtw89_rfk_tbl *tbl;\n\n\tswitch (_kpath(rtwdev, phy_idx)) {\n\tcase RF_A:\n\t\ttbl = &rtw8852a_rfk_iqk_restore_defs_dbcc_path0_tbl;\n\t\tbreak;\n\tcase RF_B:\n\t\ttbl = &rtw8852a_rfk_iqk_restore_defs_dbcc_path1_tbl;\n\t\tbreak;\n\tdefault:\n\t\ttbl = &rtw8852a_rfk_iqk_restore_defs_nondbcc_path01_tbl;\n\t\tbreak;\n\t}\n\n\trtw89_rfk_parser(rtwdev, tbl);\n}\n\nstatic void _iqk_preset(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 idx = iqk_info->iqk_table_idx[path];\n\n\tif (rtwdev->dbcc_en) {\n\t\trtw89_phy_write32_mask(rtwdev, R_COEF_SEL + (path << 8),\n\t\t\t\t       B_COEF_SEL_IQC, path & 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_G2, path & 0x1);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_COEF_SEL + (path << 8),\n\t\t\t\t       B_COEF_SEL_IQC, idx);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_G2, idx);\n\t}\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000080);\n\trtw89_phy_write32_clr(rtwdev, R_NCTL_RW, MASKDWORD);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x81ff010a);\n\trtw89_phy_write32_mask(rtwdev, R_KPATH_CFG, MASKDWORD, 0x00200000);\n\trtw89_phy_write32_mask(rtwdev, R_MDPK_RX_DCK, MASKDWORD, 0x80000000);\n\trtw89_phy_write32_clr(rtwdev, R_LOAD_COEF + (path << 8), MASKDWORD);\n}\n\nstatic void _iqk_macbb_setting(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tconst struct rtw89_rfk_tbl *tbl;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===> %s\\n\", __func__);\n\n\tswitch (_kpath(rtwdev, phy_idx)) {\n\tcase RF_A:\n\t\ttbl = &rtw8852a_rfk_iqk_set_defs_dbcc_path0_tbl;\n\t\tbreak;\n\tcase RF_B:\n\t\ttbl = &rtw8852a_rfk_iqk_set_defs_dbcc_path1_tbl;\n\t\tbreak;\n\tdefault:\n\t\ttbl = &rtw8852a_rfk_iqk_set_defs_nondbcc_path01_tbl;\n\t\tbreak;\n\t}\n\n\trtw89_rfk_parser(rtwdev, tbl);\n}\n\nstatic void _iqk_dbcc(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 phy_idx = 0x0;\n\n\tiqk_info->iqk_times++;\n\n\tif (path == 0x0)\n\t\tphy_idx = RTW89_PHY_0;\n\telse\n\t\tphy_idx = RTW89_PHY_1;\n\n\t_iqk_get_ch_info(rtwdev, phy_idx, path);\n\t_iqk_macbb_setting(rtwdev, phy_idx, path);\n\t_iqk_preset(rtwdev, path);\n\t_iqk_start_iqk(rtwdev, phy_idx, path);\n\t_iqk_restore(rtwdev, path);\n\t_iqk_afebb_restore(rtwdev, phy_idx, path);\n}\n\nstatic void _rck(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\tu32 rf_reg5, rck_val = 0;\n\tu32 val;\n\tint ret;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] ====== S%d RCK ======\\n\", path);\n\n\trf_reg5 = rtw89_read_rf(rtwdev, path, RR_RSV1, RFREG_MASK);\n\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] RF0x00 = 0x%x\\n\",\n\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK));\n\n\t \n\trtw89_write_rf(rtwdev, path, RR_RCKC, RFREG_MASK, 0x00240);\n\n\tret = read_poll_timeout_atomic(rtw89_read_rf, val, val, 2, 20,\n\t\t\t\t       false, rtwdev, path, 0x1c, BIT(3));\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] RCK timeout\\n\");\n\n\trck_val = rtw89_read_rf(rtwdev, path, RR_RCKC, RR_RCKC_CA);\n\trtw89_write_rf(rtwdev, path, RR_RCKC, RFREG_MASK, rck_val);\n\n\t \n\trtw89_write_rf(rtwdev, path, RR_RCKO, RR_RCKO_OFF, 0x4);\n\n\trtw89_write_rf(rtwdev, path, RR_RFC, RR_RFC_CKEN, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_RFC, RR_RFC_CKEN, 0x0);\n\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RFREG_MASK, rf_reg5);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RCK] RF 0x1b / 0x1c / 0x1d = 0x%x / 0x%x / 0x%x\\n\",\n\t\t    rtw89_read_rf(rtwdev, path, RR_RCKC, RFREG_MASK),\n\t\t    rtw89_read_rf(rtwdev, path, RR_RCKS, RFREG_MASK),\n\t\t    rtw89_read_rf(rtwdev, path, RR_RCKO, RFREG_MASK));\n}\n\nstatic void _iqk_init(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 ch, path;\n\n\trtw89_phy_write32_clr(rtwdev, R_IQKINF, MASKDWORD);\n\tif (iqk_info->is_iqk_init)\n\t\treturn;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\tiqk_info->is_iqk_init = true;\n\tiqk_info->is_nbiqk = false;\n\tiqk_info->iqk_fft_en = false;\n\tiqk_info->iqk_sram_en = false;\n\tiqk_info->iqk_cfir_en = false;\n\tiqk_info->iqk_xym_en = false;\n\tiqk_info->iqk_times = 0x0;\n\n\tfor (ch = 0; ch < RTW89_IQK_CHS_NR; ch++) {\n\t\tiqk_info->iqk_channel[ch] = 0x0;\n\t\tfor (path = 0; path < RTW8852A_IQK_SS; path++) {\n\t\t\tiqk_info->lok_cor_fail[ch][path] = false;\n\t\t\tiqk_info->lok_fin_fail[ch][path] = false;\n\t\t\tiqk_info->iqk_tx_fail[ch][path] = false;\n\t\t\tiqk_info->iqk_rx_fail[ch][path] = false;\n\t\t\tiqk_info->iqk_mcc_ch[ch][path] = 0x0;\n\t\t\tiqk_info->iqk_table_idx[path] = 0x0;\n\t\t}\n\t}\n}\n\nstatic void _doiqk(struct rtw89_dev *rtwdev, bool force,\n\t\t   enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 backup_bb_val[BACKUP_BB_REGS_NR];\n\tu32 backup_rf_val[RTW8852A_IQK_SS][BACKUP_RF_REGS_NR];\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, RF_AB);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_START);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]==========IQK start!!!!!==========\\n\");\n\tiqk_info->iqk_times++;\n\tiqk_info->version = RTW8852A_IQK_VER;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]Test Ver 0x%x\\n\", iqk_info->version);\n\t_iqk_get_ch_info(rtwdev, phy_idx, path);\n\t_rfk_backup_bb_reg(rtwdev, &backup_bb_val[0]);\n\t_rfk_backup_rf_reg(rtwdev, &backup_rf_val[path][0], path);\n\t_iqk_macbb_setting(rtwdev, phy_idx, path);\n\t_iqk_preset(rtwdev, path);\n\t_iqk_start_iqk(rtwdev, phy_idx, path);\n\t_iqk_restore(rtwdev, path);\n\t_iqk_afebb_restore(rtwdev, phy_idx, path);\n\t_rfk_restore_bb_reg(rtwdev, &backup_bb_val[0]);\n\t_rfk_restore_rf_reg(rtwdev, &backup_rf_val[path][0], path);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_STOP);\n}\n\nstatic void _iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, bool force)\n{\n\tswitch (_kpath(rtwdev, phy_idx)) {\n\tcase RF_A:\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_A);\n\t\tbreak;\n\tcase RF_B:\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_B);\n\t\tbreak;\n\tcase RF_AB:\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_A);\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_B);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\n#define RXDCK_VER_8852A 0xe\n\nstatic void _set_rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\tenum rtw89_rf_path path, bool is_afe)\n{\n\tu8 phy_map = rtw89_btc_path_phymap(rtwdev, phy, path);\n\tu32 ori_val;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RX_DCK] ==== S%d RX DCK (by %s)====\\n\",\n\t\t    path, is_afe ? \"AFE\" : \"RFC\");\n\n\tori_val = rtw89_phy_read32_mask(rtwdev, R_P0_RXCK + (path << 13), MASKDWORD);\n\n\tif (is_afe) {\n\t\trtw89_phy_write32_set(rtwdev, R_P0_NRBW + (path << 13), B_P0_NRBW_DBG);\n\t\trtw89_phy_write32_set(rtwdev, R_P0_RXCK + (path << 13), B_P0_RXCK_ON);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK + (path << 13),\n\t\t\t\t       B_P0_RXCK_VAL, 0x3);\n\t\trtw89_phy_write32_set(rtwdev, R_S0_RXDC2 + (path << 13), B_S0_RXDC2_MEN);\n\t\trtw89_phy_write32_mask(rtwdev, R_S0_RXDC2 + (path << 13),\n\t\t\t\t       B_S0_RXDC2_AVG, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15_H, 0x3);\n\t\trtw89_phy_write32_clr(rtwdev, R_ANAPAR, B_ANAPAR_ADCCLK);\n\t\trtw89_phy_write32_clr(rtwdev, R_ANAPAR, B_ANAPAR_FLTRST);\n\t\trtw89_phy_write32_set(rtwdev, R_ANAPAR, B_ANAPAR_FLTRST);\n\t\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_CRXBB, 0x1);\n\t}\n\n\trtw89_write_rf(rtwdev, path, RR_DCK2, RR_DCK2_CYCLE, 0x3f);\n\trtw89_write_rf(rtwdev, path, RR_DCK1, RR_DCK1_SEL, is_afe);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_RXDCK, BTC_WRFK_ONESHOT_START);\n\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x1);\n\n\tfsleep(600);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_RXDCK, BTC_WRFK_ONESHOT_STOP);\n\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x0);\n\n\tif (is_afe) {\n\t\trtw89_phy_write32_clr(rtwdev, R_P0_NRBW + (path << 13), B_P0_NRBW_DBG);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK + (path << 13),\n\t\t\t\t       MASKDWORD, ori_val);\n\t}\n}\n\nstatic void _rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t    bool is_afe)\n{\n\tu8 path, kpath, dck_tune;\n\tu32 rf_reg5;\n\tu32 addr;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RX_DCK] ****** RXDCK Start (Ver: 0x%x, Cv: %d) ******\\n\",\n\t\t    RXDCK_VER_8852A, rtwdev->hal.cv);\n\n\tkpath = _kpath(rtwdev, phy);\n\n\tfor (path = 0; path < 2; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\trf_reg5 = rtw89_read_rf(rtwdev, path, RR_RSV1, RFREG_MASK);\n\t\tdck_tune = (u8)rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_FINE);\n\n\t\tif (rtwdev->is_tssi_mode[path]) {\n\t\t\taddr = 0x5818 + (path << 13);\n\t\t\t \n\t\t\trtw89_phy_write32_set(rtwdev, addr, BIT(30));\n\t\t}\n\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_FINE, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\t\t_set_rx_dck(rtwdev, phy, path, is_afe);\n\t\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_FINE, dck_tune);\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RFREG_MASK, rf_reg5);\n\n\t\tif (rtwdev->is_tssi_mode[path]) {\n\t\t\taddr = 0x5818 + (path << 13);\n\t\t\t \n\t\t\trtw89_phy_write32_clr(rtwdev, addr, BIT(30));\n\t\t}\n\t}\n}\n\n#define RTW8852A_RF_REL_VERSION 34\n#define RTW8852A_DPK_VER 0x10\n#define RTW8852A_DPK_TH_AVG_NUM 4\n#define RTW8852A_DPK_RF_PATH 2\n#define RTW8852A_DPK_KIP_REG_NUM 2\n\nenum rtw8852a_dpk_id {\n\tLBK_RXIQK\t= 0x06,\n\tSYNC\t\t= 0x10,\n\tMDPK_IDL\t= 0x11,\n\tMDPK_MPA\t= 0x12,\n\tGAIN_LOSS\t= 0x13,\n\tGAIN_CAL\t= 0x14,\n};\n\nstatic void _rf_direct_cntrl(struct rtw89_dev *rtwdev,\n\t\t\t     enum rtw89_rf_path path, bool is_bybb)\n{\n\tif (is_bybb)\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x1);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n}\n\nstatic void _dpk_onoff(struct rtw89_dev *rtwdev,\n\t\t       enum rtw89_rf_path path, bool off);\n\nstatic void _dpk_bkup_kip(struct rtw89_dev *rtwdev, u32 *reg,\n\t\t\t  u32 reg_bkup[][RTW8852A_DPK_KIP_REG_NUM],\n\t\t\t  u8 path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < RTW8852A_DPK_KIP_REG_NUM; i++) {\n\t\treg_bkup[path][i] = rtw89_phy_read32_mask(rtwdev,\n\t\t\t\t\t\t\t  reg[i] + (path << 8),\n\t\t\t\t\t\t\t  MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Backup 0x%x = %x\\n\",\n\t\t\t    reg[i] + (path << 8), reg_bkup[path][i]);\n\t}\n}\n\nstatic void _dpk_reload_kip(struct rtw89_dev *rtwdev, u32 *reg,\n\t\t\t    u32 reg_bkup[][RTW8852A_DPK_KIP_REG_NUM], u8 path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < RTW8852A_DPK_KIP_REG_NUM; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, reg[i] + (path << 8),\n\t\t\t\t       MASKDWORD, reg_bkup[path][i]);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Reload 0x%x = %x\\n\",\n\t\t\t    reg[i] + (path << 8), reg_bkup[path][i]);\n\t}\n}\n\nstatic u8 _dpk_one_shot(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\tenum rtw89_rf_path path, enum rtw8852a_dpk_id id)\n{\n\tu8 phy_map  = rtw89_btc_path_phymap(rtwdev, phy, path);\n\tu16 dpk_cmd = 0x0;\n\tu32 val;\n\tint ret;\n\n\tdpk_cmd = (u16)((id << 8) | (0x19 + (path << 4)));\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_ONESHOT_START);\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD, dpk_cmd);\n\trtw89_phy_write32_set(rtwdev, R_DPK_CTL, B_DPK_CTL_EN);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x55,\n\t\t\t\t       10, 20000, false, rtwdev, 0xbff8, MASKBYTE0);\n\n\trtw89_phy_write32_clr(rtwdev, R_NCTL_N1, MASKBYTE0);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_ONESHOT_STOP);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] one-shot for %s = 0x%x (ret=%d)\\n\",\n\t\t    id == 0x06 ? \"LBK_RXIQK\" :\n\t\t    id == 0x10 ? \"SYNC\" :\n\t\t    id == 0x11 ? \"MDPK_IDL\" :\n\t\t    id == 0x12 ? \"MDPK_MPA\" :\n\t\t    id == 0x13 ? \"GAIN_LOSS\" : \"PWR_CAL\",\n\t\t    dpk_cmd, ret);\n\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] one-shot over 20ms!!!!\\n\");\n\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n\nstatic void _dpk_rx_dck(struct rtw89_dev *rtwdev,\n\t\t\tenum rtw89_phy_idx phy,\n\t\t\tenum rtw89_rf_path path)\n{\n\trtw89_write_rf(rtwdev, path, RR_RXBB2, RR_EN_TIA_IDA, 0x3);\n\t_set_rx_dck(rtwdev, phy, path, false);\n}\n\nstatic void _dpk_information(struct rtw89_dev *rtwdev,\n\t\t\t     enum rtw89_phy_idx phy,\n\t\t\t     enum rtw89_rf_path path)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 kidx = dpk->cur_idx[path];\n\n\tdpk->bp[path][kidx].band = chan->band_type;\n\tdpk->bp[path][kidx].ch = chan->channel;\n\tdpk->bp[path][kidx].bw = chan->band_width;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] S%d[%d] (PHY%d): TSSI %s/ DBCC %s/ %s/ CH%d/ %s\\n\",\n\t\t    path, dpk->cur_idx[path], phy,\n\t\t    rtwdev->is_tssi_mode[path] ? \"on\" : \"off\",\n\t\t    rtwdev->dbcc_en ? \"on\" : \"off\",\n\t\t    dpk->bp[path][kidx].band == 0 ? \"2G\" :\n\t\t    dpk->bp[path][kidx].band == 1 ? \"5G\" : \"6G\",\n\t\t    dpk->bp[path][kidx].ch,\n\t\t    dpk->bp[path][kidx].bw == 0 ? \"20M\" :\n\t\t    dpk->bp[path][kidx].bw == 1 ? \"40M\" : \"80M\");\n}\n\nstatic void _dpk_bb_afe_setting(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path, u8 kpath)\n{\n\tswitch (kpath) {\n\tcase RF_A:\n\t\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_bb_afe_sf_defs_a_tbl);\n\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_2P4G_BAND, B_2P4G_BAND_SEL) == 0x0)\n\t\t\trtw89_phy_write32_set(rtwdev, R_RXCCA, B_RXCCA_DIS);\n\n\t\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_bb_afe_sr_defs_a_tbl);\n\t\tbreak;\n\tcase RF_B:\n\t\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_bb_afe_sf_defs_b_tbl);\n\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_2P4G_BAND, B_2P4G_BAND_SEL) == 0x1)\n\t\t\trtw89_phy_write32_set(rtwdev, R_RXCCA, B_RXCCA_DIS);\n\n\t\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_bb_afe_sr_defs_b_tbl);\n\t\tbreak;\n\tcase RF_AB:\n\t\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_bb_afe_s_defs_ab_tbl);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] Set BB/AFE for PHY%d (kpath=%d)\\n\", phy, kpath);\n}\n\nstatic void _dpk_bb_afe_restore(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path, u8 kpath)\n{\n\tswitch (kpath) {\n\tcase RF_A:\n\t\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_bb_afe_r_defs_a_tbl);\n\t\tbreak;\n\tcase RF_B:\n\t\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_bb_afe_r_defs_b_tbl);\n\t\tbreak;\n\tcase RF_AB:\n\t\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_bb_afe_r_defs_ab_tbl);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] Restore BB/AFE for PHY%d (kpath=%d)\\n\", phy, kpath);\n}\n\nstatic void _dpk_tssi_pause(struct rtw89_dev *rtwdev,\n\t\t\t    enum rtw89_rf_path path, bool is_pause)\n{\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK + (path << 13),\n\t\t\t       B_P0_TSSI_TRK_EN, is_pause);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d TSSI %s\\n\", path,\n\t\t    is_pause ? \"pause\" : \"resume\");\n}\n\nstatic void _dpk_kip_setting(struct rtw89_dev *rtwdev,\n\t\t\t     enum rtw89_rf_path path, u8 kidx)\n{\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000080);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_CLK, MASKDWORD, 0x00093f3f);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x807f030a);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_SYS + (path << 8), MASKDWORD, 0xce000a08);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG, B_DPK_CFG_IDX, 0x2);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, B_NCTL_CFG_SPAGE, path);  \n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0 + (path << 8) + (kidx << 2),\n\t\t\t       MASKDWORD, 0x003f2e2e);\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       MASKDWORD, 0x005b5b5b);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] KIP setting for S%d[%d]!!\\n\",\n\t\t    path, kidx);\n}\n\nstatic void _dpk_kip_restore(struct rtw89_dev *rtwdev,\n\t\t\t     enum rtw89_rf_path path)\n{\n\trtw89_phy_write32_clr(rtwdev, R_NCTL_RPT, MASKDWORD);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x80000000);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_SYS + (path << 8), MASKDWORD, 0x10010000);\n\trtw89_phy_write32_clr(rtwdev, R_KIP_CLK, MASKDWORD);\n\n\tif (rtwdev->hal.cv > CHIP_CBV)\n\t\trtw89_phy_write32_mask(rtwdev, R_DPD_COM + (path << 8), BIT(15), 0x1);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d restore KIP\\n\", path);\n}\n\nstatic void _dpk_lbk_rxiqk(struct rtw89_dev *rtwdev,\n\t\t\t   enum rtw89_phy_idx phy,\n\t\t\t   enum rtw89_rf_path path)\n{\n\tu8 cur_rxbb;\n\n\tcur_rxbb = (u8)rtw89_read_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXBB);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_lbk_rxiqk_defs_f_tbl);\n\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0xc);\n\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_PLLEN, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_RXPOW, RR_RXPOW_IQK, 0x2);\n\trtw89_write_rf(rtwdev, path, RR_RSV4, RFREG_MASK,\n\t\t       rtw89_read_rf(rtwdev, path, RR_CFGCH, RFREG_MASK));\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_OFF, 0x13);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x1);\n\n\tfsleep(70);\n\n\trtw89_write_rf(rtwdev, path, RR_RXIQGEN, RR_RXIQGEN_ATTL, 0x1f);\n\n\tif (cur_rxbb <= 0xa)\n\t\trtw89_write_rf(rtwdev, path, RR_RXIQGEN, RR_RXIQGEN_ATTH, 0x3);\n\telse if (cur_rxbb <= 0x10 && cur_rxbb >= 0xb)\n\t\trtw89_write_rf(rtwdev, path, RR_RXIQGEN, RR_RXIQGEN_ATTH, 0x1);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_RXIQGEN, RR_RXIQGEN_ATTH, 0x0);\n\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x11);\n\n\t_dpk_one_shot(rtwdev, phy, path, LBK_RXIQK);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d LBK RXIQC = 0x%x\\n\", path,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_RXIQC, MASKDWORD));\n\n\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_PLLEN, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RXPOW, RR_RXPOW_IQK, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x0);  \n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_DPK);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_lbk_rxiqk_defs_r_tbl);\n}\n\nstatic void _dpk_get_thermal(struct rtw89_dev *rtwdev, u8 kidx,\n\t\t\t     enum rtw89_rf_path path)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tdpk->bp[path][kidx].ther_dpk =\n\t\tewma_thermal_read(&rtwdev->phystat.avg_thermal[path]);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] thermal@DPK = 0x%x\\n\",\n\t\t    dpk->bp[path][kidx].ther_dpk);\n}\n\nstatic u8 _dpk_set_tx_pwr(struct rtw89_dev *rtwdev, u8 gain,\n\t\t\t  enum rtw89_rf_path path)\n{\n\tu8 txagc_ori = 0x38;\n\n\trtw89_write_rf(rtwdev, path, RR_MODOPT, RFREG_MASK, txagc_ori);\n\n\treturn txagc_ori;\n}\n\nstatic void _dpk_rf_setting(struct rtw89_dev *rtwdev, u8 gain,\n\t\t\t    enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tif (dpk->bp[path][kidx].band == RTW89_BAND_2G) {\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_DPK, 0x280b);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_ATTC, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_ATTR, 0x4);\n\t\trtw89_write_rf(rtwdev, path, RR_MIXER, RR_MIXER_GN, 0x0);\n\t} else {\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_DPK, 0x282e);\n\t\trtw89_write_rf(rtwdev, path, RR_BIASA2, RR_BIASA2_LB, 0x7);\n\t\trtw89_write_rf(rtwdev, path, RR_TXATANK, RR_TXATANK_LBSW, 0x3);\n\t\trtw89_write_rf(rtwdev, path, RR_RXA, RR_RXA_DPK, 0x3);\n\t}\n\trtw89_write_rf(rtwdev, path, RR_RCKD, RR_RCKD_BW, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_BTC, RR_BTC_TXBB, dpk->bp[path][kidx].bw + 1);\n\trtw89_write_rf(rtwdev, path, RR_BTC, RR_BTC_RXBB, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] RF 0x0/0x1/0x1a = 0x%x/ 0x%x/ 0x%x\\n\",\n\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK),\n\t\t    rtw89_read_rf(rtwdev, path, RR_MODOPT, RFREG_MASK),\n\t\t    rtw89_read_rf(rtwdev, path, RR_BTC, RFREG_MASK));\n}\n\nstatic void _dpk_manual_txcfir(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_rf_path path, bool is_manual)\n{\n\tu8 tmp_pad, tmp_txbb;\n\n\tif (is_manual) {\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP + (path << 8), B_KIP_RFGAIN, 0x1);\n\t\ttmp_pad = (u8)rtw89_read_rf(rtwdev, path, RR_GAINTX, RR_GAINTX_PAD);\n\t\trtw89_phy_write32_mask(rtwdev, R_RFGAIN + (path << 8),\n\t\t\t\t       B_RFGAIN_PAD, tmp_pad);\n\n\t\ttmp_txbb = (u8)rtw89_read_rf(rtwdev, path, RR_GAINTX, RR_GAINTX_BB);\n\t\trtw89_phy_write32_mask(rtwdev, R_RFGAIN + (path << 8),\n\t\t\t\t       B_RFGAIN_TXBB, tmp_txbb);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8),\n\t\t\t\t       B_LOAD_COEF_CFIR, 0x1);\n\t\trtw89_phy_write32_clr(rtwdev, R_LOAD_COEF + (path << 8),\n\t\t\t\t      B_LOAD_COEF_CFIR);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), BIT(1), 0x1);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] PAD_man / TXBB_man = 0x%x / 0x%x\\n\", tmp_pad,\n\t\t\t    tmp_txbb);\n\t} else {\n\t\trtw89_phy_write32_clr(rtwdev, R_KIP + (path << 8), B_KIP_RFGAIN);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] disable manual switch TXCFIR\\n\");\n\t}\n}\n\nstatic void _dpk_bypass_rxcfir(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_rf_path path, bool is_bypass)\n{\n\tif (is_bypass) {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t       B_RXIQC_BYPASS2, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t       B_RXIQC_BYPASS, 0x1);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Bypass RXIQC (0x8%d3c = 0x%x)\\n\", 1 + path,\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t\t\t  MASKDWORD));\n\t} else {\n\t\trtw89_phy_write32_clr(rtwdev, R_RXIQC + (path << 8), B_RXIQC_BYPASS2);\n\t\trtw89_phy_write32_clr(rtwdev, R_RXIQC + (path << 8), B_RXIQC_BYPASS);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] restore 0x8%d3c = 0x%x\\n\", 1 + path,\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t\t\t  MASKDWORD));\n\t}\n}\n\nstatic\nvoid _dpk_tpg_sel(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tif (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_80)\n\t\trtw89_phy_write32_clr(rtwdev, R_TPG_MOD, B_TPG_MOD_F);\n\telse if (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_40)\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x2);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x1);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] TPG_Select for %s\\n\",\n\t\t    dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_80 ? \"80M\" :\n\t\t    dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_40 ? \"40M\" : \"20M\");\n}\n\nstatic void _dpk_table_select(struct rtw89_dev *rtwdev,\n\t\t\t      enum rtw89_rf_path path, u8 kidx, u8 gain)\n{\n\tu8 val;\n\n\tval = 0x80 + kidx * 0x20 + gain * 0x10;\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0 + (path << 8), MASKBYTE3, val);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] table select for Kidx[%d], Gain[%d] (0x%x)\\n\", kidx,\n\t\t    gain, val);\n}\n\nstatic bool _dpk_sync_check(struct rtw89_dev *rtwdev,\n\t\t\t    enum rtw89_rf_path path)\n{\n#define DPK_SYNC_TH_DC_I 200\n#define DPK_SYNC_TH_DC_Q 200\n#define DPK_SYNC_TH_CORR 170\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu16 dc_i, dc_q;\n\tu8 corr_val, corr_idx;\n\n\trtw89_phy_write32_clr(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL);\n\n\tcorr_idx = (u8)rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_CORI);\n\tcorr_val = (u8)rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_CORV);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] S%d Corr_idx / Corr_val = %d / %d\\n\", path, corr_idx,\n\t\t    corr_val);\n\n\tdpk->corr_idx[path][0] = corr_idx;\n\tdpk->corr_val[path][0] = corr_val;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x9);\n\n\tdc_i = (u16)rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCI);\n\tdc_q = (u16)rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCQ);\n\n\tdc_i = abs(sign_extend32(dc_i, 11));\n\tdc_q = abs(sign_extend32(dc_q, 11));\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d DC I/Q, = %d / %d\\n\",\n\t\t    path, dc_i, dc_q);\n\n\tdpk->dc_i[path][0] = dc_i;\n\tdpk->dc_q[path][0] = dc_q;\n\n\tif (dc_i > DPK_SYNC_TH_DC_I || dc_q > DPK_SYNC_TH_DC_Q ||\n\t    corr_val < DPK_SYNC_TH_CORR)\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\nstatic bool _dpk_sync(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t      enum rtw89_rf_path path, u8 kidx)\n{\n\t_dpk_tpg_sel(rtwdev, path, kidx);\n\t_dpk_one_shot(rtwdev, phy, path, SYNC);\n\treturn _dpk_sync_check(rtwdev, path);  \n}\n\nstatic u16 _dpk_dgain_read(struct rtw89_dev *rtwdev)\n{\n\tu16 dgain = 0x0;\n\n\trtw89_phy_write32_clr(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL);\n\n\trtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_SYNERR);\n\n\tdgain = (u16)rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCI);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] DGain = 0x%x (%d)\\n\", dgain,\n\t\t    dgain);\n\n\treturn dgain;\n}\n\nstatic s8 _dpk_dgain_mapping(struct rtw89_dev *rtwdev, u16 dgain)\n{\n\ts8 offset;\n\n\tif (dgain >= 0x783)\n\t\toffset = 0x6;\n\telse if (dgain <= 0x782 && dgain >= 0x551)\n\t\toffset = 0x3;\n\telse if (dgain <= 0x550 && dgain >= 0x3c4)\n\t\toffset = 0x0;\n\telse if (dgain <= 0x3c3 && dgain >= 0x2aa)\n\t\toffset = -3;\n\telse if (dgain <= 0x2a9 && dgain >= 0x1e3)\n\t\toffset = -6;\n\telse if (dgain <= 0x1e2 && dgain >= 0x156)\n\t\toffset = -9;\n\telse if (dgain <= 0x155)\n\t\toffset = -12;\n\telse\n\t\toffset = 0x0;\n\n\treturn offset;\n}\n\nstatic u8 _dpk_gainloss_read(struct rtw89_dev *rtwdev)\n{\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x6);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG2, B_DPK_CFG2_ST, 0x1);\n\treturn rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_GL);\n}\n\nstatic void _dpk_gainloss(struct rtw89_dev *rtwdev,\n\t\t\t  enum rtw89_phy_idx phy, enum rtw89_rf_path path,\n\t\t\t  u8 kidx)\n{\n\t_dpk_table_select(rtwdev, path, kidx, 1);\n\t_dpk_one_shot(rtwdev, phy, path, GAIN_LOSS);\n}\n\n#define DPK_TXAGC_LOWER 0x2e\n#define DPK_TXAGC_UPPER 0x3f\n#define DPK_TXAGC_INVAL 0xff\n\nstatic u8 _dpk_set_offset(struct rtw89_dev *rtwdev,\n\t\t\t  enum rtw89_rf_path path, s8 gain_offset)\n{\n\tu8 txagc;\n\n\ttxagc = (u8)rtw89_read_rf(rtwdev, path, RR_MODOPT, RFREG_MASK);\n\n\tif (txagc - gain_offset < DPK_TXAGC_LOWER)\n\t\ttxagc = DPK_TXAGC_LOWER;\n\telse if (txagc - gain_offset > DPK_TXAGC_UPPER)\n\t\ttxagc = DPK_TXAGC_UPPER;\n\telse\n\t\ttxagc = txagc - gain_offset;\n\n\trtw89_write_rf(rtwdev, path, RR_MODOPT, RFREG_MASK, txagc);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] tmp_txagc (GL=%d) = 0x%x\\n\",\n\t\t    gain_offset, txagc);\n\treturn txagc;\n}\n\nenum dpk_agc_step {\n\tDPK_AGC_STEP_SYNC_DGAIN,\n\tDPK_AGC_STEP_GAIN_ADJ,\n\tDPK_AGC_STEP_GAIN_LOSS_IDX,\n\tDPK_AGC_STEP_GL_GT_CRITERION,\n\tDPK_AGC_STEP_GL_LT_CRITERION,\n\tDPK_AGC_STEP_SET_TX_GAIN,\n};\n\nstatic u8 _dpk_pas_read(struct rtw89_dev *rtwdev, bool is_check)\n{\n\tu32 val1_i = 0, val1_q = 0, val2_i = 0, val2_q = 0;\n\tu8 i;\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_rfk_dpk_pas_read_defs_tbl);\n\n\tif (is_check) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, 0x00);\n\t\tval1_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKHWORD);\n\t\tval1_i = abs(sign_extend32(val1_i, 11));\n\t\tval1_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKLWORD);\n\t\tval1_q = abs(sign_extend32(val1_q, 11));\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, 0x1f);\n\t\tval2_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKHWORD);\n\t\tval2_i = abs(sign_extend32(val2_i, 11));\n\t\tval2_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKLWORD);\n\t\tval2_q = abs(sign_extend32(val2_q, 11));\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] PAS_delta = 0x%x\\n\",\n\t\t\t    phy_div(val1_i * val1_i + val1_q * val1_q,\n\t\t\t\t    val2_i * val2_i + val2_q * val2_q));\n\n\t} else {\n\t\tfor (i = 0; i < 32; i++) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, i);\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t    \"[DPK] PAS_Read[%02d]= 0x%08x\\n\", i,\n\t\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD));\n\t\t}\n\t}\n\tif ((val1_i * val1_i + val1_q * val1_q) >=\n\t    ((val2_i * val2_i + val2_q * val2_q) * 8 / 5))\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\nstatic u8 _dpk_agc(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t   enum rtw89_rf_path path, u8 kidx, u8 init_txagc,\n\t\t   bool loss_only)\n{\n#define DPK_AGC_ADJ_LMT 6\n#define DPK_DGAIN_UPPER 1922\n#define DPK_DGAIN_LOWER 342\n#define DPK_RXBB_UPPER 0x1f\n#define DPK_RXBB_LOWER 0\n#define DPK_GL_CRIT 7\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 tmp_txagc, tmp_rxbb = 0, tmp_gl_idx = 0;\n\tu8 agc_cnt = 0;\n\tbool limited_rxbb = false;\n\ts8 offset = 0;\n\tu16 dgain = 0;\n\tu8 step = DPK_AGC_STEP_SYNC_DGAIN;\n\tbool goout = false;\n\n\ttmp_txagc = init_txagc;\n\n\tdo {\n\t\tswitch (step) {\n\t\tcase DPK_AGC_STEP_SYNC_DGAIN:\n\t\t\tif (_dpk_sync(rtwdev, phy, path, kidx)) {\n\t\t\t\ttmp_txagc = DPK_TXAGC_INVAL;\n\t\t\t\tgoout = true;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tdgain = _dpk_dgain_read(rtwdev);\n\n\t\t\tif (loss_only || limited_rxbb)\n\t\t\t\tstep = DPK_AGC_STEP_GAIN_LOSS_IDX;\n\t\t\telse\n\t\t\t\tstep = DPK_AGC_STEP_GAIN_ADJ;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GAIN_ADJ:\n\t\t\ttmp_rxbb = (u8)rtw89_read_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXBB);\n\t\t\toffset = _dpk_dgain_mapping(rtwdev, dgain);\n\n\t\t\tif (tmp_rxbb + offset > DPK_RXBB_UPPER) {\n\t\t\t\ttmp_rxbb = DPK_RXBB_UPPER;\n\t\t\t\tlimited_rxbb = true;\n\t\t\t} else if (tmp_rxbb + offset < DPK_RXBB_LOWER) {\n\t\t\t\ttmp_rxbb = DPK_RXBB_LOWER;\n\t\t\t\tlimited_rxbb = true;\n\t\t\t} else {\n\t\t\t\ttmp_rxbb = tmp_rxbb + offset;\n\t\t\t}\n\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_M_RXBB, tmp_rxbb);\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t    \"[DPK] Adjust RXBB (%d) = 0x%x\\n\", offset,\n\t\t\t\t    tmp_rxbb);\n\t\t\tif (offset != 0 || agc_cnt == 0) {\n\t\t\t\tif (chan->band_width < RTW89_CHANNEL_WIDTH_80)\n\t\t\t\t\t_dpk_bypass_rxcfir(rtwdev, path, true);\n\t\t\t\telse\n\t\t\t\t\t_dpk_lbk_rxiqk(rtwdev, phy, path);\n\t\t\t}\n\t\t\tif (dgain > DPK_DGAIN_UPPER || dgain < DPK_DGAIN_LOWER)\n\t\t\t\tstep = DPK_AGC_STEP_SYNC_DGAIN;\n\t\t\telse\n\t\t\t\tstep = DPK_AGC_STEP_GAIN_LOSS_IDX;\n\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GAIN_LOSS_IDX:\n\t\t\t_dpk_gainloss(rtwdev, phy, path, kidx);\n\t\t\ttmp_gl_idx = _dpk_gainloss_read(rtwdev);\n\n\t\t\tif ((tmp_gl_idx == 0 && _dpk_pas_read(rtwdev, true)) ||\n\t\t\t    tmp_gl_idx > DPK_GL_CRIT)\n\t\t\t\tstep = DPK_AGC_STEP_GL_GT_CRITERION;\n\t\t\telse if (tmp_gl_idx == 0)\n\t\t\t\tstep = DPK_AGC_STEP_GL_LT_CRITERION;\n\t\t\telse\n\t\t\t\tstep = DPK_AGC_STEP_SET_TX_GAIN;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GL_GT_CRITERION:\n\t\t\tif (tmp_txagc == DPK_TXAGC_LOWER) {\n\t\t\t\tgoout = true;\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t\t    \"[DPK] Txagc@lower bound!!\\n\");\n\t\t\t} else {\n\t\t\t\ttmp_txagc = _dpk_set_offset(rtwdev, path, 3);\n\t\t\t}\n\t\t\tstep = DPK_AGC_STEP_GAIN_LOSS_IDX;\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GL_LT_CRITERION:\n\t\t\tif (tmp_txagc == DPK_TXAGC_UPPER) {\n\t\t\t\tgoout = true;\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t\t    \"[DPK] Txagc@upper bound!!\\n\");\n\t\t\t} else {\n\t\t\t\ttmp_txagc = _dpk_set_offset(rtwdev, path, -2);\n\t\t\t}\n\t\t\tstep = DPK_AGC_STEP_GAIN_LOSS_IDX;\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_SET_TX_GAIN:\n\t\t\ttmp_txagc = _dpk_set_offset(rtwdev, path, tmp_gl_idx);\n\t\t\tgoout = true;\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tgoout = true;\n\t\t\tbreak;\n\t\t}\n\t} while (!goout && (agc_cnt < DPK_AGC_ADJ_LMT));\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] Txagc / RXBB for DPK = 0x%x / 0x%x\\n\", tmp_txagc,\n\t\t    tmp_rxbb);\n\n\treturn tmp_txagc;\n}\n\nstatic void _dpk_set_mdpd_para(struct rtw89_dev *rtwdev, u8 order)\n{\n\tswitch (order) {\n\tcase 0:\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP, order);\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_PN, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_MAN, 0x1);\n\t\tbreak;\n\tcase 1:\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP, order);\n\t\trtw89_phy_write32_clr(rtwdev, R_LDL_NORM, B_LDL_NORM_PN);\n\t\trtw89_phy_write32_clr(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_MAN);\n\t\tbreak;\n\tcase 2:\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP, order);\n\t\trtw89_phy_write32_clr(rtwdev, R_LDL_NORM, B_LDL_NORM_PN);\n\t\trtw89_phy_write32_clr(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_MAN);\n\t\tbreak;\n\tdefault:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Wrong MDPD order!!(0x%x)\\n\", order);\n\t\tbreak;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] Set MDPD order to 0x%x for IDL\\n\", order);\n}\n\nstatic void _dpk_idl_mpa(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t enum rtw89_rf_path path, u8 kidx, u8 gain)\n{\n\t_dpk_set_mdpd_para(rtwdev, 0x0);\n\t_dpk_table_select(rtwdev, path, kidx, 1);\n\t_dpk_one_shot(rtwdev, phy, path, MDPK_IDL);\n}\n\nstatic void _dpk_fill_result(struct rtw89_dev *rtwdev,\n\t\t\t     enum rtw89_rf_path path, u8 kidx, u8 gain,\n\t\t\t     u8 txagc)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tu16 pwsf = 0x78;\n\tu8 gs = 0x5b;\n\n\trtw89_phy_write32_mask(rtwdev, R_COEF_SEL + (path << 8), B_COEF_SEL_MDPD, kidx);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] Fill txagc/ pwsf/ gs = 0x%x/ 0x%x/ 0x%x\\n\", txagc,\n\t\t    pwsf, gs);\n\n\tdpk->bp[path][kidx].txagc_dpk = txagc;\n\trtw89_phy_write32_mask(rtwdev, R_TXAGC_RFK + (path << 8),\n\t\t\t       0x3F << ((gain << 3) + (kidx << 4)), txagc);\n\n\tdpk->bp[path][kidx].pwsf = pwsf;\n\trtw89_phy_write32_mask(rtwdev, R_DPD_BND + (path << 8) + (kidx << 2),\n\t\t\t       0x1FF << (gain << 4), pwsf);\n\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_MDPD, 0x1);\n\trtw89_phy_write32_clr(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_MDPD);\n\n\tdpk->bp[path][kidx].gs = gs;\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       MASKDWORD, 0x065b5b5b);\n\n\trtw89_phy_write32_clr(rtwdev, R_DPD_V1 + (path << 8), MASKDWORD);\n\n\trtw89_phy_write32_clr(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_SEL);\n}\n\nstatic bool _dpk_reload_check(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t      enum rtw89_rf_path path)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tbool is_reload = false;\n\tu8 idx, cur_band, cur_ch;\n\n\tcur_band = chan->band_type;\n\tcur_ch = chan->channel;\n\n\tfor (idx = 0; idx < RTW89_DPK_BKUP_NUM; idx++) {\n\t\tif (cur_band != dpk->bp[path][idx].band ||\n\t\t    cur_ch != dpk->bp[path][idx].ch)\n\t\t\tcontinue;\n\n\t\trtw89_phy_write32_mask(rtwdev, R_COEF_SEL + (path << 8),\n\t\t\t\t       B_COEF_SEL_MDPD, idx);\n\t\tdpk->cur_idx[path] = idx;\n\t\tis_reload = true;\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] reload S%d[%d] success\\n\", path, idx);\n\t}\n\n\treturn is_reload;\n}\n\nstatic bool _dpk_main(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t      enum rtw89_rf_path path, u8 gain)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 txagc = 0, kidx = dpk->cur_idx[path];\n\tbool is_fail = false;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] ========= S%d[%d] DPK Start =========\\n\", path,\n\t\t    kidx);\n\n\t_rf_direct_cntrl(rtwdev, path, false);\n\ttxagc = _dpk_set_tx_pwr(rtwdev, gain, path);\n\t_dpk_rf_setting(rtwdev, gain, path, kidx);\n\t_dpk_rx_dck(rtwdev, phy, path);\n\n\t_dpk_kip_setting(rtwdev, path, kidx);\n\t_dpk_manual_txcfir(rtwdev, path, true);\n\ttxagc = _dpk_agc(rtwdev, phy, path, kidx, txagc, false);\n\tif (txagc == DPK_TXAGC_INVAL)\n\t\tis_fail = true;\n\t_dpk_get_thermal(rtwdev, kidx, path);\n\n\t_dpk_idl_mpa(rtwdev, phy, path, kidx, gain);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\t_dpk_fill_result(rtwdev, path, kidx, gain, txagc);\n\t_dpk_manual_txcfir(rtwdev, path, false);\n\n\tif (!is_fail)\n\t\tdpk->bp[path][kidx].path_ok = true;\n\telse\n\t\tdpk->bp[path][kidx].path_ok = false;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d[%d] DPK %s\\n\", path, kidx,\n\t\t    is_fail ? \"Check\" : \"Success\");\n\n\treturn is_fail;\n}\n\nstatic void _dpk_cal_select(struct rtw89_dev *rtwdev, bool force,\n\t\t\t    enum rtw89_phy_idx phy, u8 kpath)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu32 backup_bb_val[BACKUP_BB_REGS_NR];\n\tu32 backup_rf_val[RTW8852A_DPK_RF_PATH][BACKUP_RF_REGS_NR];\n\tu32 kip_bkup[RTW8852A_DPK_RF_PATH][RTW8852A_DPK_KIP_REG_NUM] = {{0}};\n\tu32 kip_reg[] = {R_RXIQC, R_IQK_RES};\n\tu8 path;\n\tbool is_fail = true, reloaded[RTW8852A_DPK_RF_PATH] = {false};\n\n\tif (dpk->is_dpk_reload_en) {\n\t\tfor (path = 0; path < RTW8852A_DPK_RF_PATH; path++) {\n\t\t\tif (!(kpath & BIT(path)))\n\t\t\t\tcontinue;\n\n\t\t\treloaded[path] = _dpk_reload_check(rtwdev, phy, path);\n\t\t\tif (!reloaded[path] && dpk->bp[path][0].ch != 0)\n\t\t\t\tdpk->cur_idx[path] = !dpk->cur_idx[path];\n\t\t\telse\n\t\t\t\t_dpk_onoff(rtwdev, path, false);\n\t\t}\n\t} else {\n\t\tfor (path = 0; path < RTW8852A_DPK_RF_PATH; path++)\n\t\t\tdpk->cur_idx[path] = 0;\n\t}\n\n\tif ((kpath == RF_A && reloaded[RF_PATH_A]) ||\n\t    (kpath == RF_B && reloaded[RF_PATH_B]) ||\n\t    (kpath == RF_AB && reloaded[RF_PATH_A] && reloaded[RF_PATH_B]))\n\t\treturn;\n\n\t_rfk_backup_bb_reg(rtwdev, &backup_bb_val[0]);\n\n\tfor (path = 0; path < RTW8852A_DPK_RF_PATH; path++) {\n\t\tif (!(kpath & BIT(path)) || reloaded[path])\n\t\t\tcontinue;\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\t_dpk_tssi_pause(rtwdev, path, true);\n\t\t_dpk_bkup_kip(rtwdev, kip_reg, kip_bkup, path);\n\t\t_rfk_backup_rf_reg(rtwdev, &backup_rf_val[path][0], path);\n\t\t_dpk_information(rtwdev, phy, path);\n\t}\n\n\t_dpk_bb_afe_setting(rtwdev, phy, path, kpath);\n\n\tfor (path = 0; path < RTW8852A_DPK_RF_PATH; path++) {\n\t\tif (!(kpath & BIT(path)) || reloaded[path])\n\t\t\tcontinue;\n\n\t\tis_fail = _dpk_main(rtwdev, phy, path, 1);\n\t\t_dpk_onoff(rtwdev, path, is_fail);\n\t}\n\n\t_dpk_bb_afe_restore(rtwdev, phy, path, kpath);\n\t_rfk_restore_bb_reg(rtwdev, &backup_bb_val[0]);\n\n\tfor (path = 0; path < RTW8852A_DPK_RF_PATH; path++) {\n\t\tif (!(kpath & BIT(path)) || reloaded[path])\n\t\t\tcontinue;\n\n\t\t_dpk_kip_restore(rtwdev, path);\n\t\t_dpk_reload_kip(rtwdev, kip_reg, kip_bkup, path);\n\t\t_rfk_restore_rf_reg(rtwdev, &backup_rf_val[path][0], path);\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\t_dpk_tssi_pause(rtwdev, path, false);\n\t}\n}\n\nstatic bool _dpk_bypass_check(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tstruct rtw89_fem_info *fem = &rtwdev->fem;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\n\tif (fem->epa_2g && chan->band_type == RTW89_BAND_2G) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Skip DPK due to 2G_ext_PA exist!!\\n\");\n\t\treturn true;\n\t} else if (fem->epa_5g && chan->band_type == RTW89_BAND_5G) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Skip DPK due to 5G_ext_PA exist!!\\n\");\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic void _dpk_force_bypass(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tu8 path, kpath;\n\n\tkpath = _kpath(rtwdev, phy);\n\n\tfor (path = 0; path < RTW8852A_DPK_RF_PATH; path++) {\n\t\tif (kpath & BIT(path))\n\t\t\t_dpk_onoff(rtwdev, path, true);\n\t}\n}\n\nstatic void _dpk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy, bool force)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] ****** DPK Start (Ver: 0x%x, Cv: %d, RF_para: %d) ******\\n\",\n\t\t    RTW8852A_DPK_VER, rtwdev->hal.cv,\n\t\t    RTW8852A_RF_REL_VERSION);\n\n\tif (_dpk_bypass_check(rtwdev, phy))\n\t\t_dpk_force_bypass(rtwdev, phy);\n\telse\n\t\t_dpk_cal_select(rtwdev, force, phy, _kpath(rtwdev, phy));\n}\n\nstatic void _dpk_onoff(struct rtw89_dev *rtwdev,\n\t\t       enum rtw89_rf_path path, bool off)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 val, kidx = dpk->cur_idx[path];\n\n\tval = dpk->is_dpk_enable && !off && dpk->bp[path][kidx].path_ok;\n\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       MASKBYTE3, 0x6 | val);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d[%d] DPK %s !!!\\n\", path,\n\t\t    kidx, dpk->is_dpk_enable && !off ? \"enable\" : \"disable\");\n}\n\nstatic void _dpk_track(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tu8 path, kidx;\n\tu8 trk_idx = 0, txagc_rf = 0;\n\ts8 txagc_bb = 0, txagc_bb_tp = 0, ini_diff = 0, txagc_ofst = 0;\n\tu16 pwsf[2];\n\tu8 cur_ther;\n\ts8 delta_ther[2] = {0};\n\n\tfor (path = 0; path < RTW8852A_DPK_RF_PATH; path++) {\n\t\tkidx = dpk->cur_idx[path];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] ================[S%d[%d] (CH %d)]================\\n\",\n\t\t\t    path, kidx, dpk->bp[path][kidx].ch);\n\n\t\tcur_ther = ewma_thermal_read(&rtwdev->phystat.avg_thermal[path]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] thermal now = %d\\n\", cur_ther);\n\n\t\tif (dpk->bp[path][kidx].ch != 0 && cur_ther != 0)\n\t\t\tdelta_ther[path] = dpk->bp[path][kidx].ther_dpk - cur_ther;\n\n\t\tif (dpk->bp[path][kidx].band == RTW89_BAND_2G)\n\t\t\tdelta_ther[path] = delta_ther[path] * 3 / 2;\n\t\telse\n\t\t\tdelta_ther[path] = delta_ther[path] * 5 / 2;\n\n\t\ttxagc_rf = (u8)rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB  + (path << 13),\n\t\t\t\t\t\t     RR_MODOPT_M_TXPWR);\n\n\t\tif (rtwdev->is_tssi_mode[path]) {\n\t\t\ttrk_idx = (u8)rtw89_read_rf(rtwdev, path, RR_TXA, RR_TXA_TRK);\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t    \"[DPK_TRK] txagc_RF / track_idx = 0x%x / %d\\n\",\n\t\t\t\t    txagc_rf, trk_idx);\n\n\t\t\ttxagc_bb =\n\t\t\t\t(s8)rtw89_phy_read32_mask(rtwdev,\n\t\t\t\t\t\t\t  R_TXAGC_BB + (path << 13),\n\t\t\t\t\t\t\t  MASKBYTE2);\n\t\t\ttxagc_bb_tp =\n\t\t\t\t(u8)rtw89_phy_read32_mask(rtwdev,\n\t\t\t\t\t\t\t  R_TXAGC_TP + (path << 13),\n\t\t\t\t\t\t\t  B_TXAGC_TP);\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t    \"[DPK_TRK] txagc_bb_tp / txagc_bb = 0x%x / 0x%x\\n\",\n\t\t\t\t    txagc_bb_tp, txagc_bb);\n\n\t\t\ttxagc_ofst =\n\t\t\t\t(s8)rtw89_phy_read32_mask(rtwdev,\n\t\t\t\t\t\t\t  R_TXAGC_BB + (path << 13),\n\t\t\t\t\t\t\t  MASKBYTE3);\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t    \"[DPK_TRK] txagc_offset / delta_ther = %d / %d\\n\",\n\t\t\t\t    txagc_ofst, delta_ther[path]);\n\n\t\t\tif (rtw89_phy_read32_mask(rtwdev, R_DPD_COM + (path << 8),\n\t\t\t\t\t\t  BIT(15)) == 0x1)\n\t\t\t\ttxagc_ofst = 0;\n\n\t\t\tif (txagc_rf != 0 && cur_ther != 0)\n\t\t\t\tini_diff = txagc_ofst + delta_ther[path];\n\n\t\t\tif (rtw89_phy_read32_mask(rtwdev, R_P0_TXDPD + (path << 13),\n\t\t\t\t\t\t  B_P0_TXDPD) == 0x0) {\n\t\t\t\tpwsf[0] = dpk->bp[path][kidx].pwsf + txagc_bb_tp -\n\t\t\t\t\t  txagc_bb + ini_diff +\n\t\t\t\t\t  tssi_info->extra_ofst[path];\n\t\t\t\tpwsf[1] = dpk->bp[path][kidx].pwsf + txagc_bb_tp -\n\t\t\t\t\t  txagc_bb + ini_diff +\n\t\t\t\t\t  tssi_info->extra_ofst[path];\n\t\t\t} else {\n\t\t\t\tpwsf[0] = dpk->bp[path][kidx].pwsf + ini_diff +\n\t\t\t\t\t  tssi_info->extra_ofst[path];\n\t\t\t\tpwsf[1] = dpk->bp[path][kidx].pwsf + ini_diff +\n\t\t\t\t\t  tssi_info->extra_ofst[path];\n\t\t\t}\n\n\t\t} else {\n\t\t\tpwsf[0] = (dpk->bp[path][kidx].pwsf + delta_ther[path]) & 0x1ff;\n\t\t\tpwsf[1] = (dpk->bp[path][kidx].pwsf + delta_ther[path]) & 0x1ff;\n\t\t}\n\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_DPK_TRK, B_DPK_TRK_DIS) == 0x0 &&\n\t\t    txagc_rf != 0) {\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t    \"[DPK_TRK] New pwsf[0] / pwsf[1] = 0x%x / 0x%x\\n\",\n\t\t\t\t    pwsf[0], pwsf[1]);\n\n\t\t\trtw89_phy_write32_mask(rtwdev, R_DPD_BND + (path << 8) + (kidx << 2),\n\t\t\t\t\t       0x000001FF, pwsf[0]);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_DPD_BND + (path << 8) + (kidx << 2),\n\t\t\t\t\t       0x01FF0000, pwsf[1]);\n\t\t}\n\t}\n}\n\nstatic void _tssi_rf_setting(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t     enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\tif (band == RTW89_BAND_2G)\n\t\trtw89_write_rf(rtwdev, path, RR_TXPOW, RR_TXPOW_TXG, 0x1);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_TXPOW, RR_TXPOW_TXA, 0x1);\n}\n\nstatic void _tssi_set_sys(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\trtw89_rfk_parser(rtwdev, &rtw8852a_tssi_sys_defs_tbl);\n\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t &rtw8852a_tssi_sys_defs_2g_tbl,\n\t\t\t\t &rtw8852a_tssi_sys_defs_5g_tbl);\n}\n\nstatic void _tssi_ini_txpwr_ctrl_bb(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t    enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_tssi_txpwr_ctrl_bb_defs_a_tbl,\n\t\t\t\t &rtw8852a_tssi_txpwr_ctrl_bb_defs_b_tbl);\n\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t &rtw8852a_tssi_txpwr_ctrl_bb_defs_2g_tbl,\n\t\t\t\t &rtw8852a_tssi_txpwr_ctrl_bb_defs_5g_tbl);\n}\n\nstatic void _tssi_ini_txpwr_ctrl_bb_he_tb(struct rtw89_dev *rtwdev,\n\t\t\t\t\t  enum rtw89_phy_idx phy,\n\t\t\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_tssi_txpwr_ctrl_bb_he_tb_defs_a_tbl,\n\t\t\t\t &rtw8852a_tssi_txpwr_ctrl_bb_he_tb_defs_b_tbl);\n}\n\nstatic void _tssi_set_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_tssi_dck_defs_a_tbl,\n\t\t\t\t &rtw8852a_tssi_dck_defs_b_tbl);\n}\n\nstatic void _tssi_set_tmeter_tbl(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n#define __get_val(ptr, idx)\t\t\t\t\\\n({\t\t\t\t\t\t\t\\\n\ts8 *__ptr = (ptr);\t\t\t\t\\\n\tu8 __idx = (idx), __i, __v;\t\t\t\\\n\tu32 __val = 0;\t\t\t\t\t\\\n\tfor (__i = 0; __i < 4; __i++) {\t\t\t\\\n\t\t__v = (__ptr[__idx + __i]);\t\t\\\n\t\t__val |= (__v << (8 * __i));\t\t\\\n\t}\t\t\t\t\t\t\\\n\t__val;\t\t\t\t\t\t\\\n})\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu8 subband = chan->subband_type;\n\tconst s8 *thm_up_a = NULL;\n\tconst s8 *thm_down_a = NULL;\n\tconst s8 *thm_up_b = NULL;\n\tconst s8 *thm_down_b = NULL;\n\tu8 thermal = 0xff;\n\ts8 thm_ofst[64] = {0};\n\tu32 tmp = 0;\n\tu8 i, j;\n\n\tswitch (subband) {\n\tdefault:\n\tcase RTW89_CH_2G:\n\t\tthm_up_a = rtw89_8852a_trk_cfg.delta_swingidx_2ga_p;\n\t\tthm_down_a = rtw89_8852a_trk_cfg.delta_swingidx_2ga_n;\n\t\tthm_up_b = rtw89_8852a_trk_cfg.delta_swingidx_2gb_p;\n\t\tthm_down_b = rtw89_8852a_trk_cfg.delta_swingidx_2gb_n;\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_1:\n\t\tthm_up_a = rtw89_8852a_trk_cfg.delta_swingidx_5ga_p[0];\n\t\tthm_down_a = rtw89_8852a_trk_cfg.delta_swingidx_5ga_n[0];\n\t\tthm_up_b = rtw89_8852a_trk_cfg.delta_swingidx_5gb_p[0];\n\t\tthm_down_b = rtw89_8852a_trk_cfg.delta_swingidx_5gb_n[0];\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_3:\n\t\tthm_up_a = rtw89_8852a_trk_cfg.delta_swingidx_5ga_p[1];\n\t\tthm_down_a = rtw89_8852a_trk_cfg.delta_swingidx_5ga_n[1];\n\t\tthm_up_b = rtw89_8852a_trk_cfg.delta_swingidx_5gb_p[1];\n\t\tthm_down_b = rtw89_8852a_trk_cfg.delta_swingidx_5gb_n[1];\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_4:\n\t\tthm_up_a = rtw89_8852a_trk_cfg.delta_swingidx_5ga_p[2];\n\t\tthm_down_a = rtw89_8852a_trk_cfg.delta_swingidx_5ga_n[2];\n\t\tthm_up_b = rtw89_8852a_trk_cfg.delta_swingidx_5gb_p[2];\n\t\tthm_down_b = rtw89_8852a_trk_cfg.delta_swingidx_5gb_n[2];\n\t\tbreak;\n\t}\n\n\tif (path == RF_PATH_A) {\n\t\tthermal = tssi_info->thermal[RF_PATH_A];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] ch=%d thermal_pathA=0x%x\\n\", ch, thermal);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER_DIS, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER_TRK, 0x1);\n\n\t\tif (thermal == 0xff) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER, 32);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_VAL, 32);\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\trtw89_phy_write32(rtwdev, R_P0_TSSI_BASE + i, 0x0);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x5c00 + i, 0x0);\n\t\t\t}\n\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER, thermal);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_VAL,\n\t\t\t\t\t       thermal);\n\n\t\t\ti = 0;\n\t\t\tfor (j = 0; j < 32; j++)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      -thm_down_a[i++] :\n\t\t\t\t\t      -thm_down_a[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\ti = 1;\n\t\t\tfor (j = 63; j >= 32; j--)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      thm_up_a[i++] :\n\t\t\t\t\t      thm_up_a[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\ttmp = __get_val(thm_ofst, i);\n\t\t\t\trtw89_phy_write32(rtwdev, R_P0_TSSI_BASE + i, tmp);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x5c00 + i, tmp);\n\t\t\t}\n\t\t}\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, R_P0_RFCTM_RDY, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, R_P0_RFCTM_RDY, 0x0);\n\n\t} else {\n\t\tthermal = tssi_info->thermal[RF_PATH_B];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] ch=%d thermal_pathB=0x%x\\n\", ch, thermal);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER_DIS, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER_TRK, 0x1);\n\n\t\tif (thermal == 0xff) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER, 32);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, B_P1_RFCTM_VAL, 32);\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\trtw89_phy_write32(rtwdev, R_TSSI_THOF + i, 0x0);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x7c00 + i, 0x0);\n\t\t\t}\n\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER, thermal);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, B_P1_RFCTM_VAL,\n\t\t\t\t\t       thermal);\n\n\t\t\ti = 0;\n\t\t\tfor (j = 0; j < 32; j++)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      -thm_down_b[i++] :\n\t\t\t\t\t      -thm_down_b[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\ti = 1;\n\t\t\tfor (j = 63; j >= 32; j--)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      thm_up_b[i++] :\n\t\t\t\t\t      thm_up_b[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\ttmp = __get_val(thm_ofst, i);\n\t\t\t\trtw89_phy_write32(rtwdev, R_TSSI_THOF + i, tmp);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x7c00 + i, tmp);\n\t\t\t}\n\t\t}\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, R_P1_RFCTM_RDY, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, R_P1_RFCTM_RDY, 0x0);\n\t}\n#undef __get_val\n}\n\nstatic void _tssi_set_dac_gain_tbl(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t   enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_tssi_dac_gain_tbl_defs_a_tbl,\n\t\t\t\t &rtw8852a_tssi_dac_gain_tbl_defs_b_tbl);\n}\n\nstatic void _tssi_slope_cal_org(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_tssi_slope_cal_org_defs_a_tbl,\n\t\t\t\t &rtw8852a_tssi_slope_cal_org_defs_b_tbl);\n}\n\nstatic void _tssi_set_rf_gap_tbl(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_tssi_rf_gap_tbl_defs_a_tbl,\n\t\t\t\t &rtw8852a_tssi_rf_gap_tbl_defs_b_tbl);\n}\n\nstatic void _tssi_set_slope(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_tssi_slope_defs_a_tbl,\n\t\t\t\t &rtw8852a_tssi_slope_defs_b_tbl);\n}\n\nstatic void _tssi_set_track(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_tssi_track_defs_a_tbl,\n\t\t\t\t &rtw8852a_tssi_track_defs_b_tbl);\n}\n\nstatic void _tssi_set_txagc_offset_mv_avg(struct rtw89_dev *rtwdev,\n\t\t\t\t\t  enum rtw89_phy_idx phy,\n\t\t\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852a_tssi_txagc_ofst_mv_avg_defs_a_tbl,\n\t\t\t\t &rtw8852a_tssi_txagc_ofst_mv_avg_defs_b_tbl);\n}\n\nstatic void _tssi_pak(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t      enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 subband = chan->subband_type;\n\n\tswitch (subband) {\n\tdefault:\n\tcase RTW89_CH_2G:\n\t\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t\t &rtw8852a_tssi_pak_defs_a_2g_tbl,\n\t\t\t\t\t &rtw8852a_tssi_pak_defs_b_2g_tbl);\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_1:\n\t\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t\t &rtw8852a_tssi_pak_defs_a_5g_1_tbl,\n\t\t\t\t\t &rtw8852a_tssi_pak_defs_b_5g_1_tbl);\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_3:\n\t\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t\t &rtw8852a_tssi_pak_defs_a_5g_3_tbl,\n\t\t\t\t\t &rtw8852a_tssi_pak_defs_b_5g_3_tbl);\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_4:\n\t\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t\t &rtw8852a_tssi_pak_defs_a_5g_4_tbl,\n\t\t\t\t\t &rtw8852a_tssi_pak_defs_b_5g_4_tbl);\n\t\tbreak;\n\t}\n}\n\nstatic void _tssi_enable(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tu8 i;\n\n\tfor (i = 0; i < RF_PATH_NUM_8852A; i++) {\n\t\t_tssi_set_track(rtwdev, phy, i);\n\t\t_tssi_set_txagc_offset_mv_avg(rtwdev, phy, i);\n\n\t\trtw89_rfk_parser_by_cond(rtwdev, i == RF_PATH_A,\n\t\t\t\t\t &rtw8852a_tssi_enable_defs_a_tbl,\n\t\t\t\t\t &rtw8852a_tssi_enable_defs_b_tbl);\n\n\t\ttssi_info->base_thermal[i] =\n\t\t\tewma_thermal_read(&rtwdev->phystat.avg_thermal[i]);\n\t\trtwdev->is_tssi_mode[i] = true;\n\t}\n}\n\nstatic void _tssi_disable(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8852a_tssi_disable_defs_tbl);\n\n\trtwdev->is_tssi_mode[RF_PATH_A] = false;\n\trtwdev->is_tssi_mode[RF_PATH_B] = false;\n}\n\nstatic u32 _tssi_get_cck_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 2:\n\t\treturn 0;\n\tcase 3 ... 5:\n\t\treturn 1;\n\tcase 6 ... 8:\n\t\treturn 2;\n\tcase 9 ... 11:\n\t\treturn 3;\n\tcase 12 ... 13:\n\t\treturn 4;\n\tcase 14:\n\t\treturn 5;\n\t}\n\n\treturn 0;\n}\n\n#define TSSI_EXTRA_GROUP_BIT (BIT(31))\n#define TSSI_EXTRA_GROUP(idx) (TSSI_EXTRA_GROUP_BIT | (idx))\n#define IS_TSSI_EXTRA_GROUP(group) ((group) & TSSI_EXTRA_GROUP_BIT)\n#define TSSI_EXTRA_GET_GROUP_IDX1(group) ((group) & ~TSSI_EXTRA_GROUP_BIT)\n#define TSSI_EXTRA_GET_GROUP_IDX2(group) (TSSI_EXTRA_GET_GROUP_IDX1(group) + 1)\n\nstatic u32 _tssi_get_ofdm_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 2:\n\t\treturn 0;\n\tcase 3 ... 5:\n\t\treturn 1;\n\tcase 6 ... 8:\n\t\treturn 2;\n\tcase 9 ... 11:\n\t\treturn 3;\n\tcase 12 ... 14:\n\t\treturn 4;\n\tcase 36 ... 40:\n\t\treturn 5;\n\tcase 41 ... 43:\n\t\treturn TSSI_EXTRA_GROUP(5);\n\tcase 44 ... 48:\n\t\treturn 6;\n\tcase 49 ... 51:\n\t\treturn TSSI_EXTRA_GROUP(6);\n\tcase 52 ... 56:\n\t\treturn 7;\n\tcase 57 ... 59:\n\t\treturn TSSI_EXTRA_GROUP(7);\n\tcase 60 ... 64:\n\t\treturn 8;\n\tcase 100 ... 104:\n\t\treturn 9;\n\tcase 105 ... 107:\n\t\treturn TSSI_EXTRA_GROUP(9);\n\tcase 108 ... 112:\n\t\treturn 10;\n\tcase 113 ... 115:\n\t\treturn TSSI_EXTRA_GROUP(10);\n\tcase 116 ... 120:\n\t\treturn 11;\n\tcase 121 ... 123:\n\t\treturn TSSI_EXTRA_GROUP(11);\n\tcase 124 ... 128:\n\t\treturn 12;\n\tcase 129 ... 131:\n\t\treturn TSSI_EXTRA_GROUP(12);\n\tcase 132 ... 136:\n\t\treturn 13;\n\tcase 137 ... 139:\n\t\treturn TSSI_EXTRA_GROUP(13);\n\tcase 140 ... 144:\n\t\treturn 14;\n\tcase 149 ... 153:\n\t\treturn 15;\n\tcase 154 ... 156:\n\t\treturn TSSI_EXTRA_GROUP(15);\n\tcase 157 ... 161:\n\t\treturn 16;\n\tcase 162 ... 164:\n\t\treturn TSSI_EXTRA_GROUP(16);\n\tcase 165 ... 169:\n\t\treturn 17;\n\tcase 170 ... 172:\n\t\treturn TSSI_EXTRA_GROUP(17);\n\tcase 173 ... 177:\n\t\treturn 18;\n\t}\n\n\treturn 0;\n}\n\nstatic u32 _tssi_get_trim_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 8:\n\t\treturn 0;\n\tcase 9 ... 14:\n\t\treturn 1;\n\tcase 36 ... 48:\n\t\treturn 2;\n\tcase 52 ... 64:\n\t\treturn 3;\n\tcase 100 ... 112:\n\t\treturn 4;\n\tcase 116 ... 128:\n\t\treturn 5;\n\tcase 132 ... 144:\n\t\treturn 6;\n\tcase 149 ... 177:\n\t\treturn 7;\n\t}\n\n\treturn 0;\n}\n\nstatic s8 _tssi_get_ofdm_de(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu32 gidx, gidx_1st, gidx_2nd;\n\ts8 de_1st = 0;\n\ts8 de_2nd = 0;\n\ts8 val;\n\n\tgidx = _tssi_get_ofdm_group(rtwdev, ch);\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t    \"[TSSI][TRIM]: path=%d mcs group_idx=0x%x\\n\",\n\t\t    path, gidx);\n\n\tif (IS_TSSI_EXTRA_GROUP(gidx)) {\n\t\tgidx_1st = TSSI_EXTRA_GET_GROUP_IDX1(gidx);\n\t\tgidx_2nd = TSSI_EXTRA_GET_GROUP_IDX2(gidx);\n\t\tde_1st = tssi_info->tssi_mcs[path][gidx_1st];\n\t\tde_2nd = tssi_info->tssi_mcs[path][gidx_2nd];\n\t\tval = (de_1st + de_2nd) / 2;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs de=%d 1st=%d 2nd=%d\\n\",\n\t\t\t    path, val, de_1st, de_2nd);\n\t} else {\n\t\tval = tssi_info->tssi_mcs[path][gidx];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs de=%d\\n\", path, val);\n\t}\n\n\treturn val;\n}\n\nstatic s8 _tssi_get_ofdm_trim_de(struct rtw89_dev *rtwdev,\n\t\t\t\t enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu32 tgidx, tgidx_1st, tgidx_2nd;\n\ts8 tde_1st = 0;\n\ts8 tde_2nd = 0;\n\ts8 val;\n\n\ttgidx = _tssi_get_trim_group(rtwdev, ch);\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t    \"[TSSI][TRIM]: path=%d mcs trim_group_idx=0x%x\\n\",\n\t\t    path, tgidx);\n\n\tif (IS_TSSI_EXTRA_GROUP(tgidx)) {\n\t\ttgidx_1st = TSSI_EXTRA_GET_GROUP_IDX1(tgidx);\n\t\ttgidx_2nd = TSSI_EXTRA_GET_GROUP_IDX2(tgidx);\n\t\ttde_1st = tssi_info->tssi_trim[path][tgidx_1st];\n\t\ttde_2nd = tssi_info->tssi_trim[path][tgidx_2nd];\n\t\tval = (tde_1st + tde_2nd) / 2;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_de=%d 1st=%d 2nd=%d\\n\",\n\t\t\t    path, val, tde_1st, tde_2nd);\n\t} else {\n\t\tval = tssi_info->tssi_trim[path][tgidx];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_de=%d\\n\",\n\t\t\t    path, val);\n\t}\n\n\treturn val;\n}\n\nstatic void _tssi_set_efuse_to_de(struct rtw89_dev *rtwdev,\n\t\t\t\t  enum rtw89_phy_idx phy)\n{\n#define __DE_MASK 0x003ff000\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstatic const u32 r_cck_long[RF_PATH_NUM_8852A] = {0x5858, 0x7858};\n\tstatic const u32 r_cck_short[RF_PATH_NUM_8852A] = {0x5860, 0x7860};\n\tstatic const u32 r_mcs_20m[RF_PATH_NUM_8852A] = {0x5838, 0x7838};\n\tstatic const u32 r_mcs_40m[RF_PATH_NUM_8852A] = {0x5840, 0x7840};\n\tstatic const u32 r_mcs_80m[RF_PATH_NUM_8852A] = {0x5848, 0x7848};\n\tstatic const u32 r_mcs_80m_80m[RF_PATH_NUM_8852A] = {0x5850, 0x7850};\n\tstatic const u32 r_mcs_5m[RF_PATH_NUM_8852A] = {0x5828, 0x7828};\n\tstatic const u32 r_mcs_10m[RF_PATH_NUM_8852A] = {0x5830, 0x7830};\n\tu8 ch = chan->channel;\n\tu8 i, gidx;\n\ts8 ofdm_de;\n\ts8 trim_de;\n\ts32 val;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI][TRIM]: phy=%d ch=%d\\n\",\n\t\t    phy, ch);\n\n\tfor (i = 0; i < RF_PATH_NUM_8852A; i++) {\n\t\tgidx = _tssi_get_cck_group(rtwdev, ch);\n\t\ttrim_de = _tssi_get_ofdm_trim_de(rtwdev, phy, i);\n\t\tval = tssi_info->tssi_cck[i][gidx] + trim_de;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d cck[%d]=0x%x trim=0x%x\\n\",\n\t\t\t    i, gidx, tssi_info->tssi_cck[i][gidx], trim_de);\n\n\t\trtw89_phy_write32_mask(rtwdev, r_cck_long[i], __DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, r_cck_short[i], __DE_MASK, val);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] Set TSSI CCK DE 0x%x[21:12]=0x%x\\n\",\n\t\t\t    r_cck_long[i],\n\t\t\t    rtw89_phy_read32_mask(rtwdev, r_cck_long[i],\n\t\t\t\t\t\t  __DE_MASK));\n\n\t\tofdm_de = _tssi_get_ofdm_de(rtwdev, phy, i);\n\t\ttrim_de = _tssi_get_ofdm_trim_de(rtwdev, phy, i);\n\t\tval = ofdm_de + trim_de;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs=0x%x trim=0x%x\\n\",\n\t\t\t    i, ofdm_de, trim_de);\n\n\t\trtw89_phy_write32_mask(rtwdev, r_mcs_20m[i], __DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, r_mcs_40m[i], __DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, r_mcs_80m[i], __DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, r_mcs_80m_80m[i], __DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, r_mcs_5m[i], __DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, r_mcs_10m[i], __DE_MASK, val);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] Set TSSI MCS DE 0x%x[21:12]=0x%x\\n\",\n\t\t\t    r_mcs_20m[i],\n\t\t\t    rtw89_phy_read32_mask(rtwdev, r_mcs_20m[i],\n\t\t\t\t\t\t  __DE_MASK));\n\t}\n#undef __DE_MASK\n}\n\nstatic void _tssi_track(struct rtw89_dev *rtwdev)\n{\n\tstatic const u32 tx_gain_scale_table[] = {\n\t\t0x400, 0x40e, 0x41d, 0x427, 0x43c, 0x44c, 0x45c, 0x46c,\n\t\t0x400, 0x39d, 0x3ab, 0x3b8, 0x3c6, 0x3d4, 0x3e2, 0x3f1\n\t};\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tu8 path;\n\tu8 cur_ther;\n\ts32 delta_ther = 0, gain_offset_int, gain_offset_float;\n\ts8 gain_offset;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI][TRK] %s:\\n\",\n\t\t    __func__);\n\n\tif (!rtwdev->is_tssi_mode[RF_PATH_A])\n\t\treturn;\n\tif (!rtwdev->is_tssi_mode[RF_PATH_B])\n\t\treturn;\n\n\tfor (path = RF_PATH_A; path < RF_PATH_NUM_8852A; path++) {\n\t\tif (!tssi_info->tssi_tracking_check[path]) {\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI][TRK] return!!!\\n\");\n\t\t\tcontinue;\n\t\t}\n\n\t\tcur_ther = (u8)rtw89_phy_read32_mask(rtwdev,\n\t\t\t\t\t\t  R_TSSI_THER + (path << 13),\n\t\t\t\t\t\t  B_TSSI_THER);\n\n\t\tif (cur_ther == 0 || tssi_info->base_thermal[path] == 0)\n\t\t\tcontinue;\n\n\t\tdelta_ther = cur_ther - tssi_info->base_thermal[path];\n\n\t\tgain_offset = (s8)delta_ther * 15 / 10;\n\n\t\ttssi_info->extra_ofst[path] = gain_offset;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRK] base_thermal=%d gain_offset=0x%x path=%d\\n\",\n\t\t\t    tssi_info->base_thermal[path], gain_offset, path);\n\n\t\tgain_offset_int = gain_offset >> 3;\n\t\tgain_offset_float = gain_offset & 7;\n\n\t\tif (gain_offset_int > 15)\n\t\t\tgain_offset_int = 15;\n\t\telse if (gain_offset_int < -16)\n\t\t\tgain_offset_int = -16;\n\n\t\trtw89_phy_write32_mask(rtwdev, R_DPD_OFT_EN + (path << 13),\n\t\t\t\t       B_DPD_OFT_EN, 0x1);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_TXGAIN_SCALE + (path << 13),\n\t\t\t\t       B_TXGAIN_SCALE_EN, 0x1);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_DPD_OFT_ADDR + (path << 13),\n\t\t\t\t       B_DPD_OFT_ADDR, gain_offset_int);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_TXGAIN_SCALE + (path << 13),\n\t\t\t\t       B_TXGAIN_SCALE_OFT,\n\t\t\t\t       tx_gain_scale_table[gain_offset_float]);\n\t}\n}\n\nstatic void _tssi_high_power(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel, ch_tmp;\n\tu8 bw = chan->band_width;\n\tu8 band = chan->band_type;\n\tu8 subband = chan->subband_type;\n\ts8 power;\n\ts32 xdbm;\n\n\tif (bw == RTW89_CHANNEL_WIDTH_40)\n\t\tch_tmp = ch - 2;\n\telse if (bw == RTW89_CHANNEL_WIDTH_80)\n\t\tch_tmp = ch - 6;\n\telse\n\t\tch_tmp = ch;\n\n\tpower = rtw89_phy_read_txpwr_limit(rtwdev, band, bw, RTW89_1TX,\n\t\t\t\t\t   RTW89_RS_MCS, RTW89_NONBF, ch_tmp);\n\n\txdbm = power * 100 / 4;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI] %s: phy=%d xdbm=%d\\n\",\n\t\t    __func__, phy, xdbm);\n\n\tif (xdbm > 1800 && subband == RTW89_CH_2G) {\n\t\ttssi_info->tssi_tracking_check[RF_PATH_A] = true;\n\t\ttssi_info->tssi_tracking_check[RF_PATH_B] = true;\n\t} else {\n\t\trtw89_rfk_parser(rtwdev, &rtw8852a_tssi_tracking_defs_tbl);\n\t\ttssi_info->extra_ofst[RF_PATH_A] = 0;\n\t\ttssi_info->extra_ofst[RF_PATH_B] = 0;\n\t\ttssi_info->tssi_tracking_check[RF_PATH_A] = false;\n\t\ttssi_info->tssi_tracking_check[RF_PATH_B] = false;\n\t}\n}\n\nstatic void _tssi_hw_tx(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\tu8 path, s16 pwr_dbm, u8 enable)\n{\n\trtw8852a_bb_set_plcp_tx(rtwdev);\n\trtw8852a_bb_cfg_tx_path(rtwdev, path);\n\trtw8852a_bb_set_power(rtwdev, pwr_dbm, phy);\n\trtw8852a_bb_set_pmac_pkt_tx(rtwdev, enable, 20, 5000, 0, phy);\n}\n\nstatic void _tssi_pre_tx(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tconst struct rtw89_chip_info *mac_reg = rtwdev->chip;\n\tu8 ch = chan->channel, ch_tmp;\n\tu8 bw = chan->band_width;\n\tu8 band = chan->band_type;\n\tu32 tx_en;\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy, 0);\n\ts8 power;\n\ts16 xdbm;\n\tu32 i, tx_counter = 0;\n\n\tif (bw == RTW89_CHANNEL_WIDTH_40)\n\t\tch_tmp = ch - 2;\n\telse if (bw == RTW89_CHANNEL_WIDTH_80)\n\t\tch_tmp = ch - 6;\n\telse\n\t\tch_tmp = ch;\n\n\tpower = rtw89_phy_read_txpwr_limit(rtwdev, band, RTW89_CHANNEL_WIDTH_20,\n\t\t\t\t\t   RTW89_1TX, RTW89_RS_OFDM,\n\t\t\t\t\t   RTW89_NONBF, ch_tmp);\n\n\txdbm = (power * 100) >> mac_reg->txpwr_factor_mac;\n\n\tif (xdbm > 1800)\n\t\txdbm = 68;\n\telse\n\t\txdbm = power * 2;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t    \"[TSSI] %s: phy=%d org_power=%d xdbm=%d\\n\",\n\t\t    __func__, phy, power, xdbm);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy));\n\ttx_counter = rtw89_phy_read32_mask(rtwdev, R_TX_COUNTER, MASKLWORD);\n\n\t_tssi_hw_tx(rtwdev, phy, RF_PATH_AB, xdbm, true);\n\tmdelay(15);\n\t_tssi_hw_tx(rtwdev, phy, RF_PATH_AB, xdbm, false);\n\n\ttx_counter = rtw89_phy_read32_mask(rtwdev, R_TX_COUNTER, MASKLWORD) -\n\t\t    tx_counter;\n\n\tif (rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB, MASKHWORD) != 0xc000 &&\n\t    rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB, MASKHWORD) != 0x0) {\n\t\tfor (i = 0; i < 6; i++) {\n\t\t\ttssi_info->default_txagc_offset[RF_PATH_A] =\n\t\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BB,\n\t\t\t\t\t\t      MASKBYTE3);\n\n\t\t\tif (tssi_info->default_txagc_offset[RF_PATH_A] != 0x0)\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB_S1, MASKHWORD) != 0xc000 &&\n\t    rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB_S1, MASKHWORD) != 0x0) {\n\t\tfor (i = 0; i < 6; i++) {\n\t\t\ttssi_info->default_txagc_offset[RF_PATH_B] =\n\t\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BB_S1,\n\t\t\t\t\t\t      MASKBYTE3);\n\n\t\t\tif (tssi_info->default_txagc_offset[RF_PATH_B] != 0x0)\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t    \"[TSSI] %s: tx counter=%d\\n\",\n\t\t    __func__, tx_counter);\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t    \"[TSSI] Backup R_TXAGC_BB=0x%x R_TXAGC_BB_S1=0x%x\\n\",\n\t\t    tssi_info->default_txagc_offset[RF_PATH_A],\n\t\t    tssi_info->default_txagc_offset[RF_PATH_B]);\n\n\trtw8852a_bb_tx_mode_switch(rtwdev, phy, 0);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852a_rck(struct rtw89_dev *rtwdev)\n{\n\tu8 path;\n\n\tfor (path = 0; path < 2; path++)\n\t\t_rck(rtwdev, path);\n}\n\nvoid rtw8852a_dack(struct rtw89_dev *rtwdev)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, RTW89_PHY_0, 0);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_START);\n\t_dac_cal(rtwdev, false);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852a_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu32 tx_en;\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\t_iqk_init(rtwdev);\n\tif (rtwdev->dbcc_en)\n\t\t_iqk_dbcc(rtwdev, phy_idx);\n\telse\n\t\t_iqk(rtwdev, phy_idx, false);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852a_rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t     bool is_afe)\n{\n\tu32 tx_en;\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_RXDCK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\t_rx_dck(rtwdev, phy_idx, is_afe);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_RXDCK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852a_dpk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu32 tx_en;\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\trtwdev->dpk.is_dpk_enable = true;\n\trtwdev->dpk.is_dpk_reload_en = false;\n\t_dpk(rtwdev, phy_idx, false);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852a_dpk_track(struct rtw89_dev *rtwdev)\n{\n\t_dpk_track(rtwdev);\n}\n\nvoid rtw8852a_tssi(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tu8 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI] %s: phy=%d\\n\",\n\t\t    __func__, phy);\n\n\t_tssi_disable(rtwdev, phy);\n\n\tfor (i = RF_PATH_A; i < RF_PATH_NUM_8852A; i++) {\n\t\t_tssi_rf_setting(rtwdev, phy, i);\n\t\t_tssi_set_sys(rtwdev, phy);\n\t\t_tssi_ini_txpwr_ctrl_bb(rtwdev, phy, i);\n\t\t_tssi_ini_txpwr_ctrl_bb_he_tb(rtwdev, phy, i);\n\t\t_tssi_set_dck(rtwdev, phy, i);\n\t\t_tssi_set_tmeter_tbl(rtwdev, phy, i);\n\t\t_tssi_set_dac_gain_tbl(rtwdev, phy, i);\n\t\t_tssi_slope_cal_org(rtwdev, phy, i);\n\t\t_tssi_set_rf_gap_tbl(rtwdev, phy, i);\n\t\t_tssi_set_slope(rtwdev, phy, i);\n\t\t_tssi_pak(rtwdev, phy, i);\n\t}\n\n\t_tssi_enable(rtwdev, phy);\n\t_tssi_set_efuse_to_de(rtwdev, phy);\n\t_tssi_high_power(rtwdev, phy);\n\t_tssi_pre_tx(rtwdev, phy);\n}\n\nvoid rtw8852a_tssi_scan(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tu8 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI] %s: phy=%d\\n\",\n\t\t    __func__, phy);\n\n\tif (!rtwdev->is_tssi_mode[RF_PATH_A])\n\t\treturn;\n\tif (!rtwdev->is_tssi_mode[RF_PATH_B])\n\t\treturn;\n\n\t_tssi_disable(rtwdev, phy);\n\n\tfor (i = RF_PATH_A; i < RF_PATH_NUM_8852A; i++) {\n\t\t_tssi_rf_setting(rtwdev, phy, i);\n\t\t_tssi_set_sys(rtwdev, phy);\n\t\t_tssi_set_tmeter_tbl(rtwdev, phy, i);\n\t\t_tssi_pak(rtwdev, phy, i);\n\t}\n\n\t_tssi_enable(rtwdev, phy);\n\t_tssi_set_efuse_to_de(rtwdev, phy);\n}\n\nvoid rtw8852a_tssi_track(struct rtw89_dev *rtwdev)\n{\n\t_tssi_track(rtwdev);\n}\n\nstatic\nvoid _rtw8852a_tssi_avg_scan(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tif (!rtwdev->is_tssi_mode[RF_PATH_A] && !rtwdev->is_tssi_mode[RF_PATH_B])\n\t\treturn;\n\n\t \n\trtw89_rfk_parser(rtwdev, &rtw8852a_tssi_disable_defs_tbl);\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_AVG, B_P0_TSSI_AVG, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_MV_AVG, B_P0_TSSI_MV_AVG, 0x0);\n\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_AVG, B_P1_TSSI_AVG, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_MV_AVG, B_P1_TSSI_MV_AVG, 0x0);\n\n\t \n\trtw89_rfk_parser(rtwdev, &rtw8852a_tssi_enable_defs_ab_tbl);\n}\n\nstatic\nvoid _rtw8852a_tssi_set_avg(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tif (!rtwdev->is_tssi_mode[RF_PATH_A] && !rtwdev->is_tssi_mode[RF_PATH_B])\n\t\treturn;\n\n\t \n\trtw89_rfk_parser(rtwdev, &rtw8852a_tssi_disable_defs_tbl);\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_AVG, B_P0_TSSI_AVG, 0x4);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_MV_AVG, B_P0_TSSI_MV_AVG, 0x2);\n\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_AVG, B_P1_TSSI_AVG, 0x4);\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_MV_AVG, B_P1_TSSI_MV_AVG, 0x2);\n\n\t \n\trtw89_rfk_parser(rtwdev, &rtw8852a_tssi_enable_defs_ab_tbl);\n}\n\nstatic void rtw8852a_tssi_set_avg(struct rtw89_dev *rtwdev,\n\t\t\t\t  enum rtw89_phy_idx phy, bool enable)\n{\n\tif (!rtwdev->is_tssi_mode[RF_PATH_A] && !rtwdev->is_tssi_mode[RF_PATH_B])\n\t\treturn;\n\n\tif (enable) {\n\t\t \n\t\t_rtw8852a_tssi_avg_scan(rtwdev, phy);\n\t} else {\n\t\t \n\t\t_rtw8852a_tssi_set_avg(rtwdev, phy);\n\t}\n}\n\nstatic void rtw8852a_tssi_default_txagc(struct rtw89_dev *rtwdev,\n\t\t\t\t\tenum rtw89_phy_idx phy, bool enable)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tu8 i;\n\n\tif (!rtwdev->is_tssi_mode[RF_PATH_A] && !rtwdev->is_tssi_mode[RF_PATH_B])\n\t\treturn;\n\n\tif (enable) {\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB, B_TXAGC_BB_OFT) != 0xc000 &&\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB, B_TXAGC_BB_OFT) != 0x0) {\n\t\t\tfor (i = 0; i < 6; i++) {\n\t\t\t\ttssi_info->default_txagc_offset[RF_PATH_A] =\n\t\t\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BB,\n\t\t\t\t\t\t\t      B_TXAGC_BB);\n\t\t\t\tif (tssi_info->default_txagc_offset[RF_PATH_A])\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB_S1, B_TXAGC_BB_S1_OFT) != 0xc000 &&\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB_S1, B_TXAGC_BB_S1_OFT) != 0x0) {\n\t\t\tfor (i = 0; i < 6; i++) {\n\t\t\t\ttssi_info->default_txagc_offset[RF_PATH_B] =\n\t\t\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BB_S1,\n\t\t\t\t\t\t\t      B_TXAGC_BB_S1);\n\t\t\t\tif (tssi_info->default_txagc_offset[RF_PATH_B])\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT,\n\t\t\t\t       tssi_info->default_txagc_offset[RF_PATH_A]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT,\n\t\t\t\t       tssi_info->default_txagc_offset[RF_PATH_B]);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x1);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT_EN, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT_EN, 0x1);\n\t}\n}\n\nvoid rtw8852a_wifi_scan_notify(struct rtw89_dev *rtwdev,\n\t\t\t       bool scan_start, enum rtw89_phy_idx phy_idx)\n{\n\tif (scan_start) {\n\t\trtw8852a_tssi_default_txagc(rtwdev, phy_idx, true);\n\t\trtw8852a_tssi_set_avg(rtwdev, phy_idx, true);\n\t} else {\n\t\trtw8852a_tssi_default_txagc(rtwdev, phy_idx, false);\n\t\trtw8852a_tssi_set_avg(rtwdev, phy_idx, false);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}