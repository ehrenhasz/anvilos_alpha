{
  "module_name": "rtw8852b_rfk.c",
  "hash_id": "7f60a10ab5a47fc5e3799ddf65701e99cd6a1760010edb325ac5aa6be8207527",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtw89/rtw8852b_rfk.c",
  "human_readable_source": "\n \n\n#include \"coex.h\"\n#include \"debug.h\"\n#include \"mac.h\"\n#include \"phy.h\"\n#include \"reg.h\"\n#include \"rtw8852b.h\"\n#include \"rtw8852b_rfk.h\"\n#include \"rtw8852b_rfk_table.h\"\n#include \"rtw8852b_table.h\"\n\n#define RTW8852B_RXDCK_VER 0x1\n#define RTW8852B_IQK_VER 0x2a\n#define RTW8852B_IQK_SS 2\n#define RTW8852B_RXK_GROUP_NR 4\n#define RTW8852B_TSSI_PATH_NR 2\n#define RTW8852B_RF_REL_VERSION 34\n#define RTW8852B_DPK_VER 0x0d\n#define RTW8852B_DPK_RF_PATH 2\n#define RTW8852B_DPK_KIP_REG_NUM 2\n\n#define _TSSI_DE_MASK GENMASK(21, 12)\n#define ADDC_T_AVG 100\n#define DPK_TXAGC_LOWER 0x2e\n#define DPK_TXAGC_UPPER 0x3f\n#define DPK_TXAGC_INVAL 0xff\n#define RFREG_MASKRXBB 0x003e0\n#define RFREG_MASKMODE 0xf0000\n\nenum rtw8852b_dpk_id {\n\tLBK_RXIQK\t= 0x06,\n\tSYNC\t\t= 0x10,\n\tMDPK_IDL\t= 0x11,\n\tMDPK_MPA\t= 0x12,\n\tGAIN_LOSS\t= 0x13,\n\tGAIN_CAL\t= 0x14,\n\tDPK_RXAGC\t= 0x15,\n\tKIP_PRESET\t= 0x16,\n\tKIP_RESTORE\t= 0x17,\n\tDPK_TXAGC\t= 0x19,\n\tD_KIP_PRESET\t= 0x28,\n\tD_TXAGC\t\t= 0x29,\n\tD_RXAGC\t\t= 0x2a,\n\tD_SYNC\t\t= 0x2b,\n\tD_GAIN_LOSS\t= 0x2c,\n\tD_MDPK_IDL\t= 0x2d,\n\tD_GAIN_NORM\t= 0x2f,\n\tD_KIP_THERMAL\t= 0x30,\n\tD_KIP_RESTORE\t= 0x31\n};\n\nenum dpk_agc_step {\n\tDPK_AGC_STEP_SYNC_DGAIN,\n\tDPK_AGC_STEP_GAIN_ADJ,\n\tDPK_AGC_STEP_GAIN_LOSS_IDX,\n\tDPK_AGC_STEP_GL_GT_CRITERION,\n\tDPK_AGC_STEP_GL_LT_CRITERION,\n\tDPK_AGC_STEP_SET_TX_GAIN,\n};\n\nenum rtw8852b_iqk_type {\n\tID_TXAGC = 0x0,\n\tID_FLOK_COARSE = 0x1,\n\tID_FLOK_FINE = 0x2,\n\tID_TXK = 0x3,\n\tID_RXAGC = 0x4,\n\tID_RXK = 0x5,\n\tID_NBTXK = 0x6,\n\tID_NBRXK = 0x7,\n\tID_FLOK_VBUFFER = 0x8,\n\tID_A_FLOK_COARSE = 0x9,\n\tID_G_FLOK_COARSE = 0xa,\n\tID_A_FLOK_FINE = 0xb,\n\tID_G_FLOK_FINE = 0xc,\n\tID_IQK_RESTORE = 0x10,\n};\n\nstatic const u32 _tssi_trigger[RTW8852B_TSSI_PATH_NR] = {0x5820, 0x7820};\nstatic const u32 _tssi_cw_rpt_addr[RTW8852B_TSSI_PATH_NR] = {0x1c18, 0x3c18};\nstatic const u32 _tssi_cw_default_addr[RTW8852B_TSSI_PATH_NR][4] = {\n\t{0x5634, 0x5630, 0x5630, 0x5630},\n\t{0x7634, 0x7630, 0x7630, 0x7630} };\nstatic const u32 _tssi_cw_default_mask[4] = {\n\t0x000003ff, 0x3ff00000, 0x000ffc00, 0x000003ff};\nstatic const u32 _tssi_de_cck_long[RF_PATH_NUM_8852B] = {0x5858, 0x7858};\nstatic const u32 _tssi_de_cck_short[RF_PATH_NUM_8852B] = {0x5860, 0x7860};\nstatic const u32 _tssi_de_mcs_20m[RF_PATH_NUM_8852B] = {0x5838, 0x7838};\nstatic const u32 _tssi_de_mcs_40m[RF_PATH_NUM_8852B] = {0x5840, 0x7840};\nstatic const u32 _tssi_de_mcs_80m[RF_PATH_NUM_8852B] = {0x5848, 0x7848};\nstatic const u32 _tssi_de_mcs_80m_80m[RF_PATH_NUM_8852B] = {0x5850, 0x7850};\nstatic const u32 _tssi_de_mcs_5m[RF_PATH_NUM_8852B] = {0x5828, 0x7828};\nstatic const u32 _tssi_de_mcs_10m[RF_PATH_NUM_8852B] = {0x5830, 0x7830};\nstatic const u32 _a_idxrxgain[RTW8852B_RXK_GROUP_NR] = {0x190, 0x198, 0x350, 0x352};\nstatic const u32 _a_idxattc2[RTW8852B_RXK_GROUP_NR] = {0x0f, 0x0f, 0x3f, 0x7f};\nstatic const u32 _a_idxattc1[RTW8852B_RXK_GROUP_NR] = {0x3, 0x1, 0x0, 0x0};\nstatic const u32 _g_idxrxgain[RTW8852B_RXK_GROUP_NR] = {0x212, 0x21c, 0x350, 0x360};\nstatic const u32 _g_idxattc2[RTW8852B_RXK_GROUP_NR] = {0x00, 0x00, 0x28, 0x5f};\nstatic const u32 _g_idxattc1[RTW8852B_RXK_GROUP_NR] = {0x3, 0x3, 0x2, 0x1};\nstatic const u32 _a_power_range[RTW8852B_RXK_GROUP_NR] = {0x0, 0x0, 0x0, 0x0};\nstatic const u32 _a_track_range[RTW8852B_RXK_GROUP_NR] = {0x3, 0x3, 0x6, 0x6};\nstatic const u32 _a_gain_bb[RTW8852B_RXK_GROUP_NR] = {0x08, 0x0e, 0x06, 0x0e};\nstatic const u32 _a_itqt[RTW8852B_RXK_GROUP_NR] = {0x12, 0x12, 0x12, 0x1b};\nstatic const u32 _g_power_range[RTW8852B_RXK_GROUP_NR] = {0x0, 0x0, 0x0, 0x0};\nstatic const u32 _g_track_range[RTW8852B_RXK_GROUP_NR] = {0x4, 0x4, 0x6, 0x6};\nstatic const u32 _g_gain_bb[RTW8852B_RXK_GROUP_NR] = {0x08, 0x0e, 0x06, 0x0e};\nstatic const u32 _g_itqt[RTW8852B_RXK_GROUP_NR] = {0x09, 0x12, 0x1b, 0x24};\n\nstatic const u32 rtw8852b_backup_bb_regs[] = {0x2344, 0x5800, 0x7800};\nstatic const u32 rtw8852b_backup_rf_regs[] = {\n\t0xde, 0xdf, 0x8b, 0x90, 0x97, 0x85, 0x1e, 0x0, 0x2, 0x5, 0x10005\n};\n\n#define BACKUP_BB_REGS_NR ARRAY_SIZE(rtw8852b_backup_bb_regs)\n#define BACKUP_RF_REGS_NR ARRAY_SIZE(rtw8852b_backup_rf_regs)\n\nstatic const struct rtw89_reg3_def rtw8852b_set_nondbcc_path01[] = {\n\t{0x20fc, 0xffff0000, 0x0303},\n\t{0x5864, 0x18000000, 0x3},\n\t{0x7864, 0x18000000, 0x3},\n\t{0x12b8, 0x40000000, 0x1},\n\t{0x32b8, 0x40000000, 0x1},\n\t{0x030c, 0xff000000, 0x13},\n\t{0x032c, 0xffff0000, 0x0041},\n\t{0x12b8, 0x10000000, 0x1},\n\t{0x58c8, 0x01000000, 0x1},\n\t{0x78c8, 0x01000000, 0x1},\n\t{0x5864, 0xc0000000, 0x3},\n\t{0x7864, 0xc0000000, 0x3},\n\t{0x2008, 0x01ffffff, 0x1ffffff},\n\t{0x0c1c, 0x00000004, 0x1},\n\t{0x0700, 0x08000000, 0x1},\n\t{0x0c70, 0x000003ff, 0x3ff},\n\t{0x0c60, 0x00000003, 0x3},\n\t{0x0c6c, 0x00000001, 0x1},\n\t{0x58ac, 0x08000000, 0x1},\n\t{0x78ac, 0x08000000, 0x1},\n\t{0x0c3c, 0x00000200, 0x1},\n\t{0x2344, 0x80000000, 0x1},\n\t{0x4490, 0x80000000, 0x1},\n\t{0x12a0, 0x00007000, 0x7},\n\t{0x12a0, 0x00008000, 0x1},\n\t{0x12a0, 0x00070000, 0x3},\n\t{0x12a0, 0x00080000, 0x1},\n\t{0x32a0, 0x00070000, 0x3},\n\t{0x32a0, 0x00080000, 0x1},\n\t{0x0700, 0x01000000, 0x1},\n\t{0x0700, 0x06000000, 0x2},\n\t{0x20fc, 0xffff0000, 0x3333},\n};\n\nstatic const struct rtw89_reg3_def rtw8852b_restore_nondbcc_path01[] = {\n\t{0x20fc, 0xffff0000, 0x0303},\n\t{0x12b8, 0x40000000, 0x0},\n\t{0x32b8, 0x40000000, 0x0},\n\t{0x5864, 0xc0000000, 0x0},\n\t{0x7864, 0xc0000000, 0x0},\n\t{0x2008, 0x01ffffff, 0x0000000},\n\t{0x0c1c, 0x00000004, 0x0},\n\t{0x0700, 0x08000000, 0x0},\n\t{0x0c70, 0x0000001f, 0x03},\n\t{0x0c70, 0x000003e0, 0x03},\n\t{0x12a0, 0x000ff000, 0x00},\n\t{0x32a0, 0x000ff000, 0x00},\n\t{0x0700, 0x07000000, 0x0},\n\t{0x20fc, 0xffff0000, 0x0000},\n\t{0x58c8, 0x01000000, 0x0},\n\t{0x78c8, 0x01000000, 0x0},\n\t{0x0c3c, 0x00000200, 0x0},\n\t{0x2344, 0x80000000, 0x0},\n};\n\nstatic void _rfk_backup_bb_reg(struct rtw89_dev *rtwdev, u32 backup_bb_reg_val[])\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_BB_REGS_NR; i++) {\n\t\tbackup_bb_reg_val[i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, rtw8852b_backup_bb_regs[i],\n\t\t\t\t\t      MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK]backup bb reg : %x, value =%x\\n\",\n\t\t\t    rtw8852b_backup_bb_regs[i], backup_bb_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_backup_rf_reg(struct rtw89_dev *rtwdev, u32 backup_rf_reg_val[],\n\t\t\t       u8 rf_path)\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_RF_REGS_NR; i++) {\n\t\tbackup_rf_reg_val[i] =\n\t\t\trtw89_read_rf(rtwdev, rf_path,\n\t\t\t\t      rtw8852b_backup_rf_regs[i], RFREG_MASK);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK]backup rf S%d reg : %x, value =%x\\n\", rf_path,\n\t\t\t    rtw8852b_backup_rf_regs[i], backup_rf_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_restore_bb_reg(struct rtw89_dev *rtwdev,\n\t\t\t\tconst u32 backup_bb_reg_val[])\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_BB_REGS_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, rtw8852b_backup_bb_regs[i],\n\t\t\t\t       MASKDWORD, backup_bb_reg_val[i]);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK]restore bb reg : %x, value =%x\\n\",\n\t\t\t    rtw8852b_backup_bb_regs[i], backup_bb_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_restore_rf_reg(struct rtw89_dev *rtwdev,\n\t\t\t\tconst u32 backup_rf_reg_val[], u8 rf_path)\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_RF_REGS_NR; i++) {\n\t\trtw89_write_rf(rtwdev, rf_path, rtw8852b_backup_rf_regs[i],\n\t\t\t       RFREG_MASK, backup_rf_reg_val[i]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK]restore rf S%d reg: %x, value =%x\\n\", rf_path,\n\t\t\t    rtw8852b_backup_rf_regs[i], backup_rf_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_rf_direct_cntrl(struct rtw89_dev *rtwdev,\n\t\t\t\t enum rtw89_rf_path path, bool is_bybb)\n{\n\tif (is_bybb)\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x1);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n}\n\nstatic void _rfk_drf_direct_cntrl(struct rtw89_dev *rtwdev,\n\t\t\t\t  enum rtw89_rf_path path, bool is_bybb)\n{\n\tif (is_bybb)\n\t\trtw89_write_rf(rtwdev, path, RR_BBDC, RR_BBDC_SEL, 0x1);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_BBDC, RR_BBDC_SEL, 0x0);\n}\n\nstatic bool _iqk_check_cal(struct rtw89_dev *rtwdev, u8 path)\n{\n\tbool fail = true;\n\tu32 val;\n\tint ret;\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x55,\n\t\t\t\t       1, 8200, false, rtwdev, 0xbff8, MASKBYTE0);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]NCTL1 IQK timeout!!!\\n\");\n\n\tudelay(200);\n\n\tif (!ret)\n\t\tfail = rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, B_NCTL_RPT_FLG);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, MASKBYTE0, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, ret=%d\\n\", path, ret);\n\tval = rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, 0x8008 = 0x%x\\n\", path, val);\n\n\treturn fail;\n}\n\nstatic u8 _kpath(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu8 val;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]dbcc_en: %x,PHY%d\\n\",\n\t\t    rtwdev->dbcc_en, phy_idx);\n\n\tif (!rtwdev->dbcc_en) {\n\t\tval = RF_AB;\n\t} else {\n\t\tif (phy_idx == RTW89_PHY_0)\n\t\t\tval = RF_A;\n\t\telse\n\t\t\tval = RF_B;\n\t}\n\treturn val;\n}\n\nstatic void _set_rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\tenum rtw89_rf_path path)\n{\n\trtw89_write_rf(rtwdev, path, RR_DCK1, RR_DCK1_CLR, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x1);\n\tmdelay(1);\n}\n\nstatic void _rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tu8 path, dck_tune;\n\tu32 rf_reg5;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RX_DCK] ****** RXDCK Start (Ver: 0x%x, CV : 0x%x) ******\\n\",\n\t\t    RTW8852B_RXDCK_VER, rtwdev->hal.cv);\n\n\tfor (path = 0; path < RF_PATH_NUM_8852B; path++) {\n\t\trf_reg5 = rtw89_read_rf(rtwdev, path, RR_RSV1, RFREG_MASK);\n\t\tdck_tune = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_FINE);\n\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_P0_TSSI_TRK + (path << 13),\n\t\t\t\t\t       B_P0_TSSI_TRK_EN, 0x1);\n\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_FINE, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\t\t_set_rx_dck(rtwdev, phy, path);\n\t\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_FINE, dck_tune);\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RFREG_MASK, rf_reg5);\n\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_P0_TSSI_TRK + (path << 13),\n\t\t\t\t\t       B_P0_TSSI_TRK_EN, 0x0);\n\t}\n}\n\nstatic void _rck(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\tu32 rf_reg5;\n\tu32 rck_val;\n\tu32 val;\n\tint ret;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] ====== S%d RCK ======\\n\", path);\n\n\trf_reg5 = rtw89_read_rf(rtwdev, path, RR_RSV1, RFREG_MASK);\n\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] RF0x00 = 0x%05x\\n\",\n\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK));\n\n\t \n\trtw89_write_rf(rtwdev, path, RR_RCKC, RFREG_MASK, 0x00240);\n\n\tret = read_poll_timeout_atomic(rtw89_read_rf, val, val, 2, 30,\n\t\t\t\t       false, rtwdev, path, RR_RCKS, BIT(3));\n\n\trck_val = rtw89_read_rf(rtwdev, path, RR_RCKC, RR_RCKC_CA);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] rck_val = 0x%x, ret = %d\\n\",\n\t\t    rck_val, ret);\n\n\trtw89_write_rf(rtwdev, path, RR_RCKC, RFREG_MASK, rck_val);\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RFREG_MASK, rf_reg5);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] RF 0x1b = 0x%x\\n\",\n\t\t    rtw89_read_rf(rtwdev, path, RR_RCKC, RFREG_MASK));\n}\n\nstatic void _afe_init(struct rtw89_dev *rtwdev)\n{\n\trtw89_write32(rtwdev, R_AX_PHYREG_SET, 0xf);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852b_afe_init_defs_tbl);\n}\n\nstatic void _drck(struct rtw89_dev *rtwdev)\n{\n\tu32 rck_d;\n\tu32 val;\n\tint ret;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]Ddie RCK start!!!\\n\");\n\trtw89_phy_write32_mask(rtwdev, R_DRCK_V1, B_DRCK_V1_KICK, 0x1);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t       false, rtwdev, R_DRCK_RS, B_DRCK_RS_DONE);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DRCK timeout\\n\");\n\n\trtw89_phy_write32_mask(rtwdev, R_DRCK_V1, B_DRCK_V1_KICK, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK_FH, B_DRCK_LAT, 0x1);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK_FH, B_DRCK_LAT, 0x0);\n\trck_d = rtw89_phy_read32_mask(rtwdev, R_DRCK_RS, B_DRCK_RS_LPS);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK_V1, B_DRCK_V1_SEL, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK_V1, B_DRCK_V1_CV, rck_d);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0xc0cc = 0x%x\\n\",\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DRCK_V1, MASKDWORD));\n}\n\nstatic void _addck_backup(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0, 0x0);\n\tdack->addck_d[0][0] = rtw89_phy_read32_mask(rtwdev, R_ADDCKR0, B_ADDCKR0_A0);\n\tdack->addck_d[0][1] = rtw89_phy_read32_mask(rtwdev, R_ADDCKR0, B_ADDCKR0_A1);\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1, 0x0);\n\tdack->addck_d[1][0] = rtw89_phy_read32_mask(rtwdev, R_ADDCKR1, B_ADDCKR1_A0);\n\tdack->addck_d[1][1] = rtw89_phy_read32_mask(rtwdev, R_ADDCKR1, B_ADDCKR1_A1);\n}\n\nstatic void _addck_reload(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\n\t \n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0D, B_ADDCK0D_VAL, dack->addck_d[0][0]);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_VAL, dack->addck_d[0][1] >> 6);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0D, B_ADDCK0D_VAL2, dack->addck_d[0][1] & 0x3f);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_MAN, 0x3);\n\n\t \n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1D, B_ADDCK1D_VAL, dack->addck_d[1][0]);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK0_VAL, dack->addck_d[1][1] >> 6);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1D, B_ADDCK1D_VAL2, dack->addck_d[1][1] & 0x3f);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1_MAN, 0x3);\n}\n\nstatic void _dack_backup_s0(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x1);\n\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DCOF0, B_DCOF0_V, i);\n\t\tdack->msbk_d[0][0][i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_DACK_S0P2, B_DACK_S0M0);\n\t\trtw89_phy_write32_mask(rtwdev, R_DCOF8, B_DCOF8_V, i);\n\t\tdack->msbk_d[0][1][i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_DACK_S0P3, B_DACK_S0M1);\n\t}\n\n\tdack->biask_d[0][0] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_BIAS00, B_DACK_BIAS00);\n\tdack->biask_d[0][1] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_BIAS01, B_DACK_BIAS01);\n\n\tdack->dadck_d[0][0] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_DADCK00, B_DACK_DADCK00);\n\tdack->dadck_d[0][1] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_DADCK01, B_DACK_DADCK01);\n}\n\nstatic void _dack_backup_s1(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\n\trtw89_phy_write32_mask(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON, 0x1);\n\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DACK10, B_DACK10, i);\n\t\tdack->msbk_d[1][0][i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_DACK10S, B_DACK10S);\n\t\trtw89_phy_write32_mask(rtwdev, R_DACK11, B_DACK11, i);\n\t\tdack->msbk_d[1][1][i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_DACK11S, B_DACK11S);\n\t}\n\n\tdack->biask_d[1][0] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_BIAS10, B_DACK_BIAS10);\n\tdack->biask_d[1][1] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_BIAS11, B_DACK_BIAS11);\n\n\tdack->dadck_d[1][0] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_DADCK10, B_DACK_DADCK10);\n\tdack->dadck_d[1][1] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_DADCK11, B_DACK_DADCK11);\n}\n\nstatic void _check_addc(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\ts32 dc_re = 0, dc_im = 0;\n\tu32 tmp;\n\tu32 i;\n\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852b_check_addc_defs_a_tbl,\n\t\t\t\t &rtw8852b_check_addc_defs_b_tbl);\n\n\tfor (i = 0; i < ADDC_T_AVG; i++) {\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_DBG32_D, MASKDWORD);\n\t\tdc_re += sign_extend32(FIELD_GET(0xfff000, tmp), 11);\n\t\tdc_im += sign_extend32(FIELD_GET(0xfff, tmp), 11);\n\t}\n\n\tdc_re /= ADDC_T_AVG;\n\tdc_im /= ADDC_T_AVG;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S%d,dc_re = 0x%x,dc_im =0x%x\\n\", path, dc_re, dc_im);\n}\n\nstatic void _addck(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 val;\n\tint ret;\n\n\t \n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_MAN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_PATH1_SAMPL_DLY_T_V1, 0x30, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_ADCCLK, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_FLTRST, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_FLTRST, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15_H, 0xf);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_PATH0_SAMPL_DLY_T_V1, BIT(1), 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15_H, 0x3);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]before S0 ADDCK\\n\");\n\t_check_addc(rtwdev, RF_PATH_A);\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_TRG, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_TRG, 0x0);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0, 0x1);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t       false, rtwdev, R_ADDCKR0, BIT(0));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 ADDCK timeout\\n\");\n\t\tdack->addck_timeout[0] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]ADDCK ret = %d\\n\", ret);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S0 ADDCK\\n\");\n\t_check_addc(rtwdev, RF_PATH_A);\n\n\trtw89_phy_write32_mask(rtwdev, R_PATH0_SAMPL_DLY_T_V1, BIT(1), 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_EN, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15_H, 0xc);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_ADCCLK, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x0);\n\n\t \n\trtw89_phy_write32_mask(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_ADCCLK, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_FLTRST, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_FLTRST, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15_H, 0xf);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_PATH1_SAMPL_DLY_T_V1, BIT(1), 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15_H, 0x3);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]before S1 ADDCK\\n\");\n\t_check_addc(rtwdev, RF_PATH_B);\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1_TRG, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1_TRG, 0x0);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK1, B_ADDCK1, 0x1);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val, 1, 10000,\n\t\t\t\t       false, rtwdev, R_ADDCKR1, BIT(0));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 ADDCK timeout\\n\");\n\t\tdack->addck_timeout[1] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]ADDCK ret = %d\\n\", ret);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S1 ADDCK\\n\");\n\t_check_addc(rtwdev, RF_PATH_B);\n\n\trtw89_phy_write32_mask(rtwdev, R_PATH1_SAMPL_DLY_T_V1, BIT(1), 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_EN, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15_H, 0xc);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_ADCCLK, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON, 0x0);\n}\n\nstatic void _check_dadc(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852b_check_dadc_en_defs_a_tbl,\n\t\t\t\t &rtw8852b_check_dadc_en_defs_b_tbl);\n\n\t_check_addc(rtwdev, path);\n\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852b_check_dadc_dis_defs_a_tbl,\n\t\t\t\t &rtw8852b_check_dadc_dis_defs_b_tbl);\n}\n\nstatic bool _dack_s0_check_done(struct rtw89_dev *rtwdev, bool part1)\n{\n\tif (part1) {\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_DACK_S0P0, B_DACK_S0P0_OK) == 0 ||\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S0P1, B_DACK_S0P1_OK) == 0)\n\t\t\treturn false;\n\t} else {\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_DACK_S0P2, B_DACK_S0P2_OK) == 0 ||\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S0P3, B_DACK_S0P3_OK) == 0)\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic void _dack_s0(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tbool done;\n\tint ret;\n\n\trtw89_rfk_parser(rtwdev, &rtw8852b_dack_s0_1_defs_tbl);\n\n\tret = read_poll_timeout_atomic(_dack_s0_check_done, done, done, 1, 10000,\n\t\t\t\t       false, rtwdev, true);\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 MSBK timeout\\n\");\n\t\tdack->msbk_timeout[0] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK ret = %d\\n\", ret);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852b_dack_s0_2_defs_tbl);\n\n\tret = read_poll_timeout_atomic(_dack_s0_check_done, done, done, 1, 10000,\n\t\t\t\t       false, rtwdev, false);\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 DADCK timeout\\n\");\n\t\tdack->dadck_timeout[0] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK ret = %d\\n\", ret);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852b_dack_s0_3_defs_tbl);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S0 DADCK\\n\");\n\n\t_dack_backup_s0(rtwdev);\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x0);\n}\n\nstatic bool _dack_s1_check_done(struct rtw89_dev *rtwdev, bool part1)\n{\n\tif (part1) {\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_DACK_S1P0, B_DACK_S1P0_OK) == 0 &&\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S1P1, B_DACK_S1P1_OK) == 0)\n\t\t\treturn false;\n\t} else {\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_DACK10S, B_DACK_S1P2_OK) == 0 &&\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACK11S, B_DACK_S1P3_OK) == 0)\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic void _dack_s1(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tbool done;\n\tint ret;\n\n\trtw89_rfk_parser(rtwdev, &rtw8852b_dack_s1_1_defs_tbl);\n\n\tret = read_poll_timeout_atomic(_dack_s1_check_done, done, done, 1, 10000,\n\t\t\t\t       false, rtwdev, true);\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 MSBK timeout\\n\");\n\t\tdack->msbk_timeout[1] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK ret = %d\\n\", ret);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852b_dack_s1_2_defs_tbl);\n\n\tret = read_poll_timeout_atomic(_dack_s1_check_done, done, done, 1, 10000,\n\t\t\t\t       false, rtwdev, false);\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 DADCK timeout\\n\");\n\t\tdack->dadck_timeout[1] = true;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK ret = %d\\n\", ret);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852b_dack_s1_3_defs_tbl);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S1 DADCK\\n\");\n\n\t_check_dadc(rtwdev, RF_PATH_B);\n\t_dack_backup_s1(rtwdev);\n\trtw89_phy_write32_mask(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON, 0x0);\n}\n\nstatic void _dack(struct rtw89_dev *rtwdev)\n{\n\t_dack_s0(rtwdev);\n\t_dack_s1(rtwdev);\n}\n\nstatic void _dack_dump(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\tu8 t;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S0 ADC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->addck_d[0][0], dack->addck_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S1 ADC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->addck_d[1][0], dack->addck_d[1][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S0 DAC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->dadck_d[0][0], dack->dadck_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S1 DAC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->dadck_d[1][0], dack->dadck_d[1][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S0 biask ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->biask_d[0][0], dack->biask_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]S1 biask ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->biask_d[1][0], dack->biask_d[1][1]);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 MSBK ic:\\n\");\n\tfor (i = 0; i < 0x10; i++) {\n\t\tt = dack->msbk_d[0][0][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 MSBK qc:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[0][1][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 MSBK ic:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[1][0][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S1 MSBK qc:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[1][1][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n}\n\nstatic void _dac_cal(struct rtw89_dev *rtwdev, bool force)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 rf0_0, rf1_0;\n\n\tdack->dack_done = false;\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK 0x1\\n\");\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK start!!!\\n\");\n\n\trf0_0 = rtw89_read_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK);\n\trf1_0 = rtw89_read_rf(rtwdev, RF_PATH_B, RR_MOD, RFREG_MASK);\n\t_afe_init(rtwdev);\n\t_drck(rtwdev);\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK, 0x337e1);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_MOD, RFREG_MASK, 0x337e1);\n\t_addck(rtwdev);\n\t_addck_backup(rtwdev);\n\t_addck_reload(rtwdev);\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MODOPT, RFREG_MASK, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_MODOPT, RFREG_MASK, 0x0);\n\t_dack(rtwdev);\n\t_dack_dump(rtwdev);\n\tdack->dack_done = true;\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK, rf0_0);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_MOD, RFREG_MASK, rf1_0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RR_RSV1_RST, 0x1);\n\trtw89_write_rf(rtwdev, RF_PATH_B, RR_RSV1, RR_RSV1_RST, 0x1);\n\tdack->dack_cnt++;\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK finish!!!\\n\");\n}\n\nstatic void _iqk_rxk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 tmp;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0xc);\n\t\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_SEL2G, 0x1);\n\t\ttmp = rtw89_read_rf(rtwdev, path, RR_CFGCH, RFREG_MASK);\n\t\trtw89_write_rf(rtwdev, path, RR_RSV4, RFREG_MASK, tmp);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0xc);\n\t\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_SEL5G, 0x1);\n\t\ttmp = rtw89_read_rf(rtwdev, path, RR_CFGCH, RFREG_MASK);\n\t\trtw89_write_rf(rtwdev, path, RR_RSV4, RFREG_MASK, tmp);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic bool _iqk_one_shot(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t  u8 path, u8 ktype)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 iqk_cmd;\n\tbool fail;\n\n\tswitch (ktype) {\n\tcase ID_FLOK_COARSE:\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x1);\n\t\tiqk_cmd = 0x108 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_FLOK_FINE:\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x1);\n\t\tiqk_cmd = 0x208 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_FLOK_VBUFFER:\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x1);\n\t\tiqk_cmd = 0x308 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_TXK:\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x0);\n\t\tiqk_cmd = 0x008 | (1 << (path + 4)) |\n\t\t\t  (((0x8 + iqk_info->iqk_bw[path]) & 0xf) << 8);\n\t\tbreak;\n\tcase ID_RXAGC:\n\t\tiqk_cmd = 0x508 | (1 << (4 + path)) | (path << 1);\n\t\tbreak;\n\tcase ID_RXK:\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x1);\n\t\tiqk_cmd = 0x008 | (1 << (path + 4)) |\n\t\t\t  (((0xb + iqk_info->iqk_bw[path]) & 0xf) << 8);\n\t\tbreak;\n\tcase ID_NBTXK:\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x011);\n\t\tiqk_cmd = 0x408 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_NBRXK:\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x011);\n\t\tiqk_cmd = 0x608 | (1 << (4 + path));\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD, iqk_cmd + 1);\n\tudelay(1);\n\tfail = _iqk_check_cal(rtwdev, path);\n\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x0);\n\n\treturn fail;\n}\n\nstatic bool _rxk_group_sel(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t   u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail = false;\n\tbool fail;\n\tu8 gp;\n\n\tfor (gp = 0; gp < RTW8852B_RXK_GROUP_NR; gp++) {\n\t\tswitch (iqk_info->iqk_band[path]) {\n\t\tcase RTW89_BAND_2G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_RGM,\n\t\t\t\t       _g_idxrxgain[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_C2G,\n\t\t\t\t       _g_idxattc2[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_C1G,\n\t\t\t\t       _g_idxattc1[gp]);\n\t\t\tbreak;\n\t\tcase RTW89_BAND_5G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_RGM,\n\t\t\t\t       _a_idxrxgain[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_HATT,\n\t\t\t\t       _a_idxattc2[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_CC2,\n\t\t\t\t       _a_idxattc1[gp]);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_SET, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_GP_V1, gp);\n\t\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_RXK);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQKINF,\n\t\t\t\t       BIT(16 + gp + path * 4), fail);\n\t\tkfail |= fail;\n\t}\n\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_SEL5G, 0x0);\n\n\tif (kfail) {\n\t\tiqk_info->nb_rxcfir[path] = 0x40000002;\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_RES + (path << 8),\n\t\t\t\t       B_IQK_RES_RXCFIR, 0x0);\n\t\tiqk_info->is_wb_rxiqk[path] = false;\n\t} else {\n\t\tiqk_info->nb_rxcfir[path] = 0x40000000;\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_RES + (path << 8),\n\t\t\t\t       B_IQK_RES_RXCFIR, 0x5);\n\t\tiqk_info->is_wb_rxiqk[path] = true;\n\t}\n\n\treturn kfail;\n}\n\nstatic bool _iqk_nbrxk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t       u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tconst u8 gp = 0x3;\n\tbool kfail = false;\n\tbool fail;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_RGM,\n\t\t\t       _g_idxrxgain[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_C2G,\n\t\t\t       _g_idxattc2[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_C1G,\n\t\t\t       _g_idxattc1[gp]);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_RGM,\n\t\t\t       _a_idxrxgain[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_HATT,\n\t\t\t       _a_idxattc2[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RXA2_CC2,\n\t\t\t       _a_idxattc1[gp]);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SEL, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SET, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_GP_V1, gp);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RFREG_MASK, 0x80013);\n\tudelay(1);\n\n\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBRXK);\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, BIT(16 + gp + path * 4), fail);\n\tkfail |= fail;\n\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_SEL5G, 0x0);\n\n\tif (!kfail)\n\t\tiqk_info->nb_rxcfir[path] =\n\t\t\t rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD) | 0x2;\n\telse\n\t\tiqk_info->nb_rxcfir[path] = 0x40000002;\n\n\treturn kfail;\n}\n\nstatic void _iqk_rxclk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\tif (iqk_info->iqk_bw[path] == RTW89_CHANNEL_WIDTH_80) {\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON, 0x1);\n\t\tudelay(1);\n\t\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x0f);\n\t\tudelay(1);\n\t\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x03);\n\t\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0xa001);\n\t\tudelay(1);\n\t\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0xa041);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK, B_P0_RXCK_VAL, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK, B_P0_RXCK_ON, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_RXCK, B_P1_RXCK_VAL, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_RXCK, B_P1_RXCK_ON, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK_ADC, B_UPD_CLK_ADC_ON, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK_ADC, B_UPD_CLK_ADC_VAL, 0x1);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON, 0x1);\n\t\tudelay(1);\n\t\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x0f);\n\t\tudelay(1);\n\t\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x03);\n\t\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0xa001);\n\t\tudelay(1);\n\t\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0xa041);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK, B_P0_RXCK_VAL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK, B_P0_RXCK_ON, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_RXCK, B_P1_RXCK_VAL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_RXCK, B_P1_RXCK_ON, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK_ADC, B_UPD_CLK_ADC_ON, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK_ADC, B_UPD_CLK_ADC_VAL, 0x0);\n\t}\n}\n\nstatic bool _txk_group_sel(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail = false;\n\tbool fail;\n\tu8 gp;\n\n\tfor (gp = 0x0; gp < RTW8852B_RXK_GROUP_NR; gp++) {\n\t\tswitch (iqk_info->iqk_band[path]) {\n\t\tcase RTW89_BAND_2G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0,\n\t\t\t\t       _g_power_range[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1,\n\t\t\t\t       _g_track_range[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG,\n\t\t\t\t       _g_gain_bb[gp]);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t\t       MASKDWORD, _g_itqt[gp]);\n\t\t\tbreak;\n\t\tcase RTW89_BAND_5G:\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0,\n\t\t\t\t       _a_power_range[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1,\n\t\t\t\t       _a_track_range[gp]);\n\t\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG,\n\t\t\t\t       _a_gain_bb[gp]);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t\t       MASKDWORD, _a_itqt[gp]);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_SET, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_G2, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8),\n\t\t\t\t       B_CFIR_LUT_GP, gp);\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\t\tfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_TXK);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQKINF,\n\t\t\t\t       BIT(8 + gp + path * 4), fail);\n\t\tkfail |= fail;\n\t}\n\n\tif (kfail) {\n\t\tiqk_info->nb_txcfir[path] = 0x40000002;\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_RES + (path << 8),\n\t\t\t\t       B_IQK_RES_TXCFIR, 0x0);\n\t\tiqk_info->is_wb_txiqk[path] = false;\n\t} else {\n\t\tiqk_info->nb_txcfir[path] = 0x40000000;\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_RES + (path << 8),\n\t\t\t\t       B_IQK_RES_TXCFIR, 0x5);\n\t\tiqk_info->is_wb_txiqk[path] = true;\n\t}\n\n\treturn kfail;\n}\n\nstatic bool _iqk_nbtxk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail;\n\tu8 gp = 0x2;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0,\n\t\t\t       _g_power_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1,\n\t\t\t       _g_track_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG,\n\t\t\t       _g_gain_bb[gp]);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       MASKDWORD, _g_itqt[gp]);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0,\n\t\t\t       _a_power_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1,\n\t\t\t       _a_track_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG,\n\t\t\t       _a_gain_bb[gp]);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       MASKDWORD, _a_itqt[gp]);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SEL, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_SET, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_G2, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_GP, gp);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\tkfail = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBTXK);\n\n\tif (!kfail)\n\t\tiqk_info->nb_txcfir[path] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_TXIQC + (path << 8),\n\t\t\t\t\t      MASKDWORD) | 0x2;\n\telse\n\t\tiqk_info->nb_txcfir[path] = 0x40000002;\n\n\treturn kfail;\n}\n\nstatic void _lok_res_table(struct rtw89_dev *rtwdev, u8 path, u8 ibias)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, ibias = %x\\n\", path, ibias);\n\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RFREG_MASK, 0x2);\n\tif (iqk_info->iqk_band[path] == RTW89_BAND_2G)\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWA, RFREG_MASK, 0x0);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWA, RFREG_MASK, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RFREG_MASK, ibias);\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RFREG_MASK, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_TXVBUF, RR_TXVBUF_DACEN, 0x1);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, 0x7c = %x\\n\", path,\n\t\t    rtw89_read_rf(rtwdev, path, RR_TXVBUF, RFREG_MASK));\n}\n\nstatic bool _lok_finetune_check(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool is_fail1, is_fail2;\n\tu32 vbuff_i;\n\tu32 vbuff_q;\n\tu32 core_i;\n\tu32 core_q;\n\tu32 tmp;\n\tu8 ch;\n\n\ttmp = rtw89_read_rf(rtwdev, path, RR_TXMO, RFREG_MASK);\n\tcore_i = FIELD_GET(RR_TXMO_COI, tmp);\n\tcore_q = FIELD_GET(RR_TXMO_COQ, tmp);\n\tch = (iqk_info->iqk_times / 2) % RTW89_IQK_CHS_NR;\n\n\tif (core_i < 0x2 || core_i > 0x1d || core_q < 0x2 || core_q > 0x1d)\n\t\tis_fail1 = true;\n\telse\n\t\tis_fail1 = false;\n\n\tiqk_info->lok_idac[ch][path] = tmp;\n\n\ttmp = rtw89_read_rf(rtwdev, path, RR_LOKVB, RFREG_MASK);\n\tvbuff_i = FIELD_GET(RR_LOKVB_COI, tmp);\n\tvbuff_q = FIELD_GET(RR_LOKVB_COQ, tmp);\n\n\tif (vbuff_i < 0x2 || vbuff_i > 0x3d || vbuff_q < 0x2 || vbuff_q > 0x3d)\n\t\tis_fail2 = true;\n\telse\n\t\tis_fail2 = false;\n\n\tiqk_info->lok_vbuf[ch][path] = tmp;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, lok_idac[%x][%x] = 0x%x\\n\", path, ch, path,\n\t\t    iqk_info->lok_idac[ch][path]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, lok_vbuf[%x][%x] = 0x%x\\n\", path, ch, path,\n\t\t    iqk_info->lok_vbuf[ch][path]);\n\n\treturn is_fail1 | is_fail2;\n}\n\nstatic bool _iqk_lok(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool tmp;\n\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x021);\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, 0x6);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, 0x4);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x0);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), MASKDWORD, 0x9);\n\ttmp = _iqk_one_shot(rtwdev, phy_idx, path, ID_FLOK_COARSE);\n\tiqk_info->lok_cor_fail[0][path] = tmp;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x12);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x12);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), MASKDWORD, 0x24);\n\ttmp = _iqk_one_shot(rtwdev, phy_idx, path, ID_FLOK_VBUFFER);\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x0);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), MASKDWORD, 0x9);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x021);\n\ttmp = _iqk_one_shot(rtwdev, phy_idx, path, ID_FLOK_FINE);\n\tiqk_info->lok_fin_fail[0][path] = tmp;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x12);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0x12);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), MASKDWORD, 0x24);\n\t_iqk_one_shot(rtwdev, phy_idx, path, ID_FLOK_VBUFFER);\n\n\treturn _lok_finetune_check(rtwdev, path);\n}\n\nstatic void _iqk_txk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_write_rf(rtwdev, path, RR_XALNA2, RR_XALNA2_SW2, 0x00);\n\t\trtw89_write_rf(rtwdev, path, RR_TXG1, RR_TXG1_ATT2, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXG1, RR_TXG1_ATT1, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_TXG2, RR_TXG2_ATT0, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TXGA, RR_TXGA_LOK_EXT, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWA, RR_LUTWA_M1, 0x00);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_IQK, 0x403e);\n\t\tudelay(1);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_write_rf(rtwdev, path, RR_XGLNA2, RR_XGLNA2_SW, 0x00);\n\t\trtw89_write_rf(rtwdev, path, RR_BIASA, RR_BIASA_A, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TXGA, RR_TXGA_LOK_EXT, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWA, RR_LUTWA_M1, 0x80);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_IQK, 0x403e);\n\t\tudelay(1);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void _iqk_txclk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_P1_DBGMOD, B_P1_DBGMOD_ON, 0x1);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x1f);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR_PW15, B_ANAPAR_PW15, 0x13);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0x0001);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ANAPAR, B_ANAPAR_15, 0x0041);\n}\n\nstatic void _iqk_info_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 tmp;\n\tbool flag;\n\n\tflag = iqk_info->lok_cor_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_FCOR << (path * 4), flag);\n\tflag = iqk_info->lok_fin_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_FFIN << (path * 4), flag);\n\tflag = iqk_info->iqk_tx_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_FTX << (path * 4), flag);\n\tflag = iqk_info->iqk_rx_fail[0][path];\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_F_RX << (path * 4), flag);\n\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_IQK_RES + (path << 8), MASKDWORD);\n\tiqk_info->bp_iqkenable[path] = tmp;\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD);\n\tiqk_info->bp_txkresult[path] = tmp;\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD);\n\tiqk_info->bp_rxkresult[path] = tmp;\n\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF2, B_IQKINF2_KCNT, iqk_info->iqk_times);\n\n\ttmp = rtw89_phy_read32_mask(rtwdev, R_IQKINF, B_IQKINF_FAIL << (path * 4));\n\tif (tmp)\n\t\tiqk_info->iqk_fail_cnt++;\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF2, B_IQKINF2_FCNT << (path * 4),\n\t\t\t       iqk_info->iqk_fail_cnt);\n}\n\nstatic void _iqk_by_path(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool lok_is_fail = false;\n\tconst int try = 3;\n\tu8 ibias = 0x1;\n\tu8 i;\n\n\t_iqk_txclk_setting(rtwdev, path);\n\n\t \n\tfor (i = 0; i < try; i++) {\n\t\t_lok_res_table(rtwdev, path, ibias++);\n\t\t_iqk_txk_setting(rtwdev, path);\n\t\tlok_is_fail = _iqk_lok(rtwdev, phy_idx, path);\n\t\tif (!lok_is_fail)\n\t\t\tbreak;\n\t}\n\n\tif (lok_is_fail)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] LOK (%d) fail\\n\", path);\n\n\t \n\tif (iqk_info->is_nbiqk)\n\t\tiqk_info->iqk_tx_fail[0][path] = _iqk_nbtxk(rtwdev, phy_idx, path);\n\telse\n\t\tiqk_info->iqk_tx_fail[0][path] = _txk_group_sel(rtwdev, phy_idx, path);\n\n\t \n\t_iqk_rxclk_setting(rtwdev, path);\n\t_iqk_rxk_setting(rtwdev, path);\n\tif (iqk_info->is_nbiqk)\n\t\tiqk_info->iqk_rx_fail[0][path] = _iqk_nbrxk(rtwdev, phy_idx, path);\n\telse\n\t\tiqk_info->iqk_rx_fail[0][path] = _rxk_group_sel(rtwdev, phy_idx, path);\n\n\t_iqk_info_iqk(rtwdev, phy_idx, path);\n}\n\nstatic void _iqk_get_ch_info(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy, u8 path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 reg_rf18;\n\tu32 reg_35c;\n\tu8 idx;\n\tu8 get_empty_table = false;\n\n\tfor (idx = 0; idx < RTW89_IQK_CHS_NR; idx++) {\n\t\tif (iqk_info->iqk_mcc_ch[idx][path] == 0) {\n\t\t\tget_empty_table = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] (1)idx = %x\\n\", idx);\n\n\tif (!get_empty_table) {\n\t\tidx = iqk_info->iqk_table_idx[path] + 1;\n\t\tif (idx > 1)\n\t\t\tidx = 0;\n\t}\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] (2)idx = %x\\n\", idx);\n\n\treg_rf18 = rtw89_read_rf(rtwdev, path, RR_CFGCH, RFREG_MASK);\n\treg_35c = rtw89_phy_read32_mask(rtwdev, R_CIRST, B_CIRST_SYN);\n\n\tiqk_info->iqk_band[path] = chan->band_type;\n\tiqk_info->iqk_bw[path] = chan->band_width;\n\tiqk_info->iqk_ch[path] = chan->channel;\n\tiqk_info->iqk_mcc_ch[idx][path] = chan->channel;\n\tiqk_info->iqk_table_idx[path] = idx;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, 0x18= 0x%x, idx = %x\\n\",\n\t\t    path, reg_rf18, idx);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, 0x18= 0x%x\\n\",\n\t\t    path, reg_rf18);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]times = 0x%x, ch =%x\\n\",\n\t\t    iqk_info->iqk_times, idx);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]iqk_mcc_ch[%x][%x] = 0x%x\\n\",\n\t\t    idx, path, iqk_info->iqk_mcc_ch[idx][path]);\n\n\tif (reg_35c == 0x01)\n\t\tiqk_info->syn1to2 = 0x1;\n\telse\n\t\tiqk_info->syn1to2 = 0x0;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, iqk_info->syn1to2= 0x%x\\n\", path,\n\t\t    iqk_info->syn1to2);\n\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, B_IQKINF_VER, RTW8852B_IQK_VER);\n\t \n\trtw89_phy_write32_mask(rtwdev, R_IQKCH, B_IQKCH_BAND << (path * 16),\n\t\t\t       iqk_info->iqk_band[path]);\n\t \n\trtw89_phy_write32_mask(rtwdev, R_IQKCH, B_IQKCH_BW << (path * 16),\n\t\t\t       iqk_info->iqk_bw[path]);\n\trtw89_phy_write32_mask(rtwdev, R_IQKCH, B_IQKCH_CH << (path * 16),\n\t\t\t       iqk_info->iqk_ch[path]);\n}\n\nstatic void _iqk_start_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, u8 path)\n{\n\t_iqk_by_path(rtwdev, phy_idx, path);\n}\n\nstatic void _iqk_restore(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool fail;\n\n\trtw89_phy_write32_mask(rtwdev, R_TXIQC + (path << 8), MASKDWORD,\n\t\t\t       iqk_info->nb_txcfir[path]);\n\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD,\n\t\t\t       iqk_info->nb_rxcfir[path]);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD,\n\t\t\t       0x00000e19 + (path << 4));\n\tfail = _iqk_check_cal(rtwdev, path);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"%s result =%x\\n\", __func__, fail);\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000000);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x80000000);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_SYS, B_IQK_RES_K, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_IQRSN, B_IQRSN_K1, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_IQRSN, B_IQRSN_K2, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_LUTWE, RR_LUTWE_LOK, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0x3);\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_BBDC, RR_BBDC_SEL, 0x1);\n}\n\nstatic void _iqk_afebb_restore(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tconst struct rtw89_reg3_def *def;\n\tint size;\n\tu8 kpath;\n\tint i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"===> %s\\n\", __func__);\n\n\tkpath = _kpath(rtwdev, phy_idx);\n\n\tswitch (kpath) {\n\tcase RF_A:\n\tcase RF_B:\n\t\treturn;\n\tdefault:\n\t\tsize = ARRAY_SIZE(rtw8852b_restore_nondbcc_path01);\n\t\tdef = rtw8852b_restore_nondbcc_path01;\n\t\tbreak;\n\t}\n\n\tfor (i = 0; i < size; i++, def++)\n\t\trtw89_phy_write32_mask(rtwdev, def->addr, def->mask, def->data);\n}\n\nstatic void _iqk_preset(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 idx;\n\n\tidx = iqk_info->iqk_table_idx[path];\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] (3)idx = %x\\n\", idx);\n\n\trtw89_phy_write32_mask(rtwdev, R_COEF_SEL + (path << 8), B_COEF_SEL_IQC, idx);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT + (path << 8), B_CFIR_LUT_G3, idx);\n\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_BBDC, RR_BBDC_SEL, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000080);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x81ff010a);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK](1)S%x, 0x8%x54 = 0x%x\\n\", path, 1 << path,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_CFIR_LUT + (path << 8), MASKDWORD));\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK](1)S%x, 0x8%x04 = 0x%x\\n\", path, 1 << path,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_COEF_SEL + (path << 8), MASKDWORD));\n}\n\nstatic void _iqk_macbb_setting(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tconst struct rtw89_reg3_def *def;\n\tint size;\n\tu8 kpath;\n\tint i;\n\n\tkpath = _kpath(rtwdev, phy_idx);\n\n\tswitch (kpath) {\n\tcase RF_A:\n\tcase RF_B:\n\t\treturn;\n\tdefault:\n\t\tsize = ARRAY_SIZE(rtw8852b_set_nondbcc_path01);\n\t\tdef = rtw8852b_set_nondbcc_path01;\n\t\tbreak;\n\t}\n\n\tfor (i = 0; i < size; i++, def++)\n\t\trtw89_phy_write32_mask(rtwdev, def->addr, def->mask, def->data);\n}\n\nstatic void _iqk_init(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 idx, path;\n\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, MASKDWORD, 0x0);\n\tif (iqk_info->is_iqk_init)\n\t\treturn;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\tiqk_info->is_iqk_init = true;\n\tiqk_info->is_nbiqk = false;\n\tiqk_info->iqk_fft_en = false;\n\tiqk_info->iqk_sram_en = false;\n\tiqk_info->iqk_cfir_en = false;\n\tiqk_info->iqk_xym_en = false;\n\tiqk_info->iqk_times = 0x0;\n\n\tfor (idx = 0; idx < RTW89_IQK_CHS_NR; idx++) {\n\t\tiqk_info->iqk_channel[idx] = 0x0;\n\t\tfor (path = 0; path < RTW8852B_IQK_SS; path++) {\n\t\t\tiqk_info->lok_cor_fail[idx][path] = false;\n\t\t\tiqk_info->lok_fin_fail[idx][path] = false;\n\t\t\tiqk_info->iqk_tx_fail[idx][path] = false;\n\t\t\tiqk_info->iqk_rx_fail[idx][path] = false;\n\t\t\tiqk_info->iqk_mcc_ch[idx][path] = 0x0;\n\t\t\tiqk_info->iqk_table_idx[path] = 0x0;\n\t\t}\n\t}\n}\n\nstatic void _wait_rx_mode(struct rtw89_dev *rtwdev, u8 kpath)\n{\n\tu32 rf_mode;\n\tu8 path;\n\tint ret;\n\n\tfor (path = 0; path < RF_PATH_MAX; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\tret = read_poll_timeout_atomic(rtw89_read_rf, rf_mode,\n\t\t\t\t\t       rf_mode != 2, 2, 5000, false,\n\t\t\t\t\t       rtwdev, path, RR_MOD, RR_MOD_MASK);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK] Wait S%d to Rx mode!! (ret = %d)\\n\", path, ret);\n\t}\n}\n\nstatic void _tmac_tx_pause(struct rtw89_dev *rtwdev, enum rtw89_phy_idx band_idx,\n\t\t\t   bool is_pause)\n{\n\tif (!is_pause)\n\t\treturn;\n\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, band_idx));\n}\n\nstatic void _doiqk(struct rtw89_dev *rtwdev, bool force,\n\t\t   enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu32 backup_bb_val[BACKUP_BB_REGS_NR];\n\tu32 backup_rf_val[RTW8852B_IQK_SS][BACKUP_RF_REGS_NR];\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, RF_AB);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_START);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]==========IQK start!!!!!==========\\n\");\n\tiqk_info->iqk_times++;\n\tiqk_info->version = RTW8852B_IQK_VER;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]Test Ver 0x%x\\n\", iqk_info->version);\n\t_iqk_get_ch_info(rtwdev, phy_idx, path);\n\n\t_rfk_backup_bb_reg(rtwdev, &backup_bb_val[0]);\n\t_rfk_backup_rf_reg(rtwdev, &backup_rf_val[path][0], path);\n\t_iqk_macbb_setting(rtwdev, phy_idx, path);\n\t_iqk_preset(rtwdev, path);\n\t_iqk_start_iqk(rtwdev, phy_idx, path);\n\t_iqk_restore(rtwdev, path);\n\t_iqk_afebb_restore(rtwdev, phy_idx, path);\n\t_rfk_restore_bb_reg(rtwdev, &backup_bb_val[0]);\n\t_rfk_restore_rf_reg(rtwdev, &backup_rf_val[path][0], path);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_STOP);\n}\n\nstatic void _iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, bool force)\n{\n\tu8 kpath = _kpath(rtwdev, phy_idx);\n\n\tswitch (kpath) {\n\tcase RF_A:\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_A);\n\t\tbreak;\n\tcase RF_B:\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_B);\n\t\tbreak;\n\tcase RF_AB:\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_A);\n\t\t_doiqk(rtwdev, force, phy_idx, RF_PATH_B);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void _dpk_bkup_kip(struct rtw89_dev *rtwdev, const u32 reg[],\n\t\t\t  u32 reg_bkup[][RTW8852B_DPK_KIP_REG_NUM], u8 path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < RTW8852B_DPK_KIP_REG_NUM; i++) {\n\t\treg_bkup[path][i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, reg[i] + (path << 8), MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Backup 0x%x = %x\\n\",\n\t\t\t    reg[i] + (path << 8), reg_bkup[path][i]);\n\t}\n}\n\nstatic void _dpk_reload_kip(struct rtw89_dev *rtwdev, const u32 reg[],\n\t\t\t    const u32 reg_bkup[][RTW8852B_DPK_KIP_REG_NUM], u8 path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < RTW8852B_DPK_KIP_REG_NUM; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, reg[i] + (path << 8), MASKDWORD,\n\t\t\t\t       reg_bkup[path][i]);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Reload 0x%x = %x\\n\",\n\t\t\t    reg[i] + (path << 8), reg_bkup[path][i]);\n\t}\n}\n\nstatic u8 _dpk_order_convert(struct rtw89_dev *rtwdev)\n{\n\tu8 order;\n\tu8 val;\n\n\torder = rtw89_phy_read32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP);\n\tval = 0x3 >> order;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] convert MDPD order to 0x%x\\n\", val);\n\n\treturn val;\n}\n\nstatic void _dpk_onoff(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, bool off)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 val, kidx = dpk->cur_idx[path];\n\n\tval = dpk->is_dpk_enable && !off && dpk->bp[path][kidx].path_ok;\n\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       MASKBYTE3, _dpk_order_convert(rtwdev) << 1 | val);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d[%d] DPK %s !!!\\n\", path,\n\t\t    kidx, dpk->is_dpk_enable && !off ? \"enable\" : \"disable\");\n}\n\nstatic void _dpk_one_shot(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path, enum rtw8852b_dpk_id id)\n{\n\tu16 dpk_cmd;\n\tu32 val;\n\tint ret;\n\n\tdpk_cmd = (id << 8) | (0x19 + (path << 4));\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD, dpk_cmd);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x55,\n\t\t\t\t       1, 20000, false,\n\t\t\t\t       rtwdev, 0xbff8, MASKBYTE0);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] one-shot over 20ms!!!!\\n\");\n\n\tudelay(1);\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKDWORD, 0x00030000);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x8000,\n\t\t\t\t       1, 2000, false,\n\t\t\t\t       rtwdev, 0x80fc, MASKLWORD);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] one-shot over 20ms!!!!\\n\");\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, MASKBYTE0, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] one-shot for %s = 0x%x\\n\",\n\t\t    id == 0x06 ? \"LBK_RXIQK\" :\n\t\t    id == 0x10 ? \"SYNC\" :\n\t\t    id == 0x11 ? \"MDPK_IDL\" :\n\t\t    id == 0x12 ? \"MDPK_MPA\" :\n\t\t    id == 0x13 ? \"GAIN_LOSS\" :\n\t\t    id == 0x14 ? \"PWR_CAL\" :\n\t\t    id == 0x15 ? \"DPK_RXAGC\" :\n\t\t    id == 0x16 ? \"KIP_PRESET\" :\n\t\t    id == 0x17 ? \"KIP_RESTORE\" : \"DPK_TXAGC\",\n\t\t    dpk_cmd);\n}\n\nstatic void _dpk_rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\tenum rtw89_rf_path path)\n{\n\trtw89_write_rf(rtwdev, path, RR_RXBB2, RR_EN_TIA_IDA, 0x3);\n\t_set_rx_dck(rtwdev, phy, path);\n}\n\nstatic void _dpk_information(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t     enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tu8 kidx = dpk->cur_idx[path];\n\n\tdpk->bp[path][kidx].band = chan->band_type;\n\tdpk->bp[path][kidx].ch = chan->channel;\n\tdpk->bp[path][kidx].bw = chan->band_width;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] S%d[%d] (PHY%d): TSSI %s/ DBCC %s/ %s/ CH%d/ %s\\n\",\n\t\t    path, dpk->cur_idx[path], phy,\n\t\t    rtwdev->is_tssi_mode[path] ? \"on\" : \"off\",\n\t\t    rtwdev->dbcc_en ? \"on\" : \"off\",\n\t\t    dpk->bp[path][kidx].band == 0 ? \"2G\" :\n\t\t    dpk->bp[path][kidx].band == 1 ? \"5G\" : \"6G\",\n\t\t    dpk->bp[path][kidx].ch,\n\t\t    dpk->bp[path][kidx].bw == 0 ? \"20M\" :\n\t\t    dpk->bp[path][kidx].bw == 1 ? \"40M\" : \"80M\");\n}\n\nstatic void _dpk_bb_afe_setting(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path, u8 kpath)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852b_dpk_afe_defs_tbl);\n\n\tif (chan->band_width == RTW89_CHANNEL_WIDTH_80) {\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW1, B_P0_CFCH_EX, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BW_SEL_V1, B_PATH1_BW_SEL_EX, 0x1);\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] Set BB/AFE for PHY%d (kpath=%d)\\n\", phy, kpath);\n}\n\nstatic void _dpk_bb_afe_restore(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path, u8 kpath)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\n\trtw89_rfk_parser(rtwdev, &rtw8852b_dpk_afe_restore_defs_tbl);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] Restore BB/AFE for PHY%d (kpath=%d)\\n\", phy, kpath);\n\n\tif (chan->band_width == RTW89_CHANNEL_WIDTH_80) {\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_CFCH_BW1, B_P0_CFCH_EX, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_PATH1_BW_SEL_V1,  B_PATH1_BW_SEL_EX, 0x0);\n\t}\n}\n\nstatic void _dpk_tssi_pause(struct rtw89_dev *rtwdev,\n\t\t\t    enum rtw89_rf_path path, bool is_pause)\n{\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK + (path << 13),\n\t\t\t       B_P0_TSSI_TRK_EN, is_pause);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d TSSI %s\\n\", path,\n\t\t    is_pause ? \"pause\" : \"resume\");\n}\n\nstatic void _dpk_kip_restore(struct rtw89_dev *rtwdev,\n\t\t\t     enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8852b_dpk_kip_defs_tbl);\n\n\tif (rtwdev->hal.cv > CHIP_CAV)\n\t\trtw89_phy_write32_mask(rtwdev, R_DPD_COM + (path << 8), B_DPD_COM_OF, 0x1);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d restore KIP\\n\", path);\n}\n\nstatic void _dpk_lbk_rxiqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t   enum rtw89_rf_path path)\n{\n\tu8 cur_rxbb;\n\tu32 tmp;\n\n\tcur_rxbb = rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASKRXBB);\n\n\trtw89_phy_write32_mask(rtwdev, R_MDPK_RX_DCK, B_MDPK_RX_DCK_EN, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_RES + (path << 8), B_IQK_RES_RXCFIR, 0x0);\n\n\ttmp = rtw89_read_rf(rtwdev, path, RR_CFGCH, RFREG_MASK);\n\trtw89_write_rf(rtwdev, path, RR_RSV4, RFREG_MASK, tmp);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASKMODE, 0xd);\n\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_PLLEN, 0x1);\n\n\tif (cur_rxbb >= 0x11)\n\t\trtw89_write_rf(rtwdev, path, RR_TXIQK, RR_TXIQK_ATT1, 0x13);\n\telse if (cur_rxbb <= 0xa)\n\t\trtw89_write_rf(rtwdev, path, RR_TXIQK, RR_TXIQK_ATT1, 0x00);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_TXIQK, RR_TXIQK_ATT1, 0x05);\n\n\trtw89_write_rf(rtwdev, path, RR_XGLNA2, RR_XGLNA2_SW, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RFREG_MASK, 0x80014);\n\tudelay(70);\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x025);\n\n\t_dpk_one_shot(rtwdev, phy, path, LBK_RXIQK);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d LBK RXIQC = 0x%x\\n\", path,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_RXIQC, MASKDWORD));\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RXK, RR_RXK_PLLEN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_MDPK_RX_DCK, B_MDPK_RX_DCK_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_KPATH_CFG, B_KPATH_CFG_ED, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_DI, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASKMODE, 0x5);\n}\n\nstatic void _dpk_get_thermal(struct rtw89_dev *rtwdev, u8 kidx, enum rtw89_rf_path path)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\trtw89_write_rf(rtwdev, path, RR_TM, RR_TM_TRI, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_TM, RR_TM_TRI, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_TM, RR_TM_TRI, 0x1);\n\n\tudelay(200);\n\n\tdpk->bp[path][kidx].ther_dpk = rtw89_read_rf(rtwdev, path, RR_TM, RR_TM_VAL);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] thermal@DPK = 0x%x\\n\",\n\t\t    dpk->bp[path][kidx].ther_dpk);\n}\n\nstatic void _dpk_rf_setting(struct rtw89_dev *rtwdev, u8 gain,\n\t\t\t    enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tif (dpk->bp[path][kidx].band == RTW89_BAND_2G) {\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK, 0x50220);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_FATT, 0xf2);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTDBG, RR_LUTDBG_TIA, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TIA, RR_TIA_N6, 0x1);\n\t} else {\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK, 0x50220);\n\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RAA2_SWATT, 0x5);\n\t\trtw89_write_rf(rtwdev, path, RR_LUTDBG, RR_LUTDBG_TIA, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_TIA, RR_TIA_N6, 0x1);\n\t\trtw89_write_rf(rtwdev, path, RR_RXA_LNA, RFREG_MASK, 0x920FC);\n\t\trtw89_write_rf(rtwdev, path, RR_XALNA2, RFREG_MASK, 0x002C0);\n\t\trtw89_write_rf(rtwdev, path, RR_IQGEN, RFREG_MASK, 0x38800);\n\t}\n\n\trtw89_write_rf(rtwdev, path, RR_RCKD, RR_RCKD_BW, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_BTC, RR_BTC_TXBB, dpk->bp[path][kidx].bw + 1);\n\trtw89_write_rf(rtwdev, path, RR_BTC, RR_BTC_RXBB, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] ARF 0x0/0x11/0x1a = 0x%x/ 0x%x/ 0x%x\\n\",\n\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK),\n\t\t    rtw89_read_rf(rtwdev, path, RR_TXIG, RFREG_MASK),\n\t\t    rtw89_read_rf(rtwdev, path, RR_BTC, RFREG_MASK));\n}\n\nstatic void _dpk_bypass_rxcfir(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_rf_path path, bool is_bypass)\n{\n\tif (is_bypass) {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t       B_RXIQC_BYPASS2, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t       B_RXIQC_BYPASS, 0x1);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Bypass RXIQC (0x8%d3c = 0x%x)\\n\", 1 + path,\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t\t\t  MASKDWORD));\n\t} else {\n\t\trtw89_phy_write32_clr(rtwdev, R_RXIQC + (path << 8), B_RXIQC_BYPASS2);\n\t\trtw89_phy_write32_clr(rtwdev, R_RXIQC + (path << 8), B_RXIQC_BYPASS);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] restore 0x8%d3c = 0x%x\\n\", 1 + path,\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t\t\t  MASKDWORD));\n\t}\n}\n\nstatic\nvoid _dpk_tpg_sel(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tif (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_80)\n\t\trtw89_phy_write32_clr(rtwdev, R_TPG_MOD, B_TPG_MOD_F);\n\telse if (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_40)\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x2);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x1);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] TPG_Select for %s\\n\",\n\t\t    dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_80 ? \"80M\" :\n\t\t    dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_40 ? \"40M\" : \"20M\");\n}\n\nstatic void _dpk_table_select(struct rtw89_dev *rtwdev,\n\t\t\t      enum rtw89_rf_path path, u8 kidx, u8 gain)\n{\n\tu8 val;\n\n\tval = 0x80 + kidx * 0x20 + gain * 0x10;\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0 + (path << 8), MASKBYTE3, val);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] table select for Kidx[%d], Gain[%d] (0x%x)\\n\", kidx,\n\t\t    gain, val);\n}\n\nstatic bool _dpk_sync_check(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 kidx)\n{\n#define DPK_SYNC_TH_DC_I 200\n#define DPK_SYNC_TH_DC_Q 200\n#define DPK_SYNC_TH_CORR 170\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu16 dc_i, dc_q;\n\tu8 corr_val, corr_idx;\n\n\trtw89_phy_write32_clr(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL);\n\n\tcorr_idx = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_CORI);\n\tcorr_val = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_CORV);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] S%d Corr_idx / Corr_val = %d / %d\\n\",\n\t\t    path, corr_idx, corr_val);\n\n\tdpk->corr_idx[path][kidx] = corr_idx;\n\tdpk->corr_val[path][kidx] = corr_val;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x9);\n\n\tdc_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCI);\n\tdc_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCQ);\n\n\tdc_i = abs(sign_extend32(dc_i, 11));\n\tdc_q = abs(sign_extend32(dc_q, 11));\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d DC I/Q, = %d / %d\\n\",\n\t\t    path, dc_i, dc_q);\n\n\tdpk->dc_i[path][kidx] = dc_i;\n\tdpk->dc_q[path][kidx] = dc_q;\n\n\tif (dc_i > DPK_SYNC_TH_DC_I || dc_q > DPK_SYNC_TH_DC_Q ||\n\t    corr_val < DPK_SYNC_TH_CORR)\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\nstatic bool _dpk_sync(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t      enum rtw89_rf_path path, u8 kidx)\n{\n\t_dpk_one_shot(rtwdev, phy, path, SYNC);\n\n\treturn _dpk_sync_check(rtwdev, path, kidx);\n}\n\nstatic u16 _dpk_dgain_read(struct rtw89_dev *rtwdev)\n{\n\tu16 dgain;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x0);\n\n\tdgain = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCI);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] DGain = 0x%x\\n\", dgain);\n\n\treturn dgain;\n}\n\nstatic s8 _dpk_dgain_mapping(struct rtw89_dev *rtwdev, u16 dgain)\n{\n\tstatic const u16 bnd[15] = {\n\t\t0xbf1, 0xaa5, 0x97d, 0x875, 0x789, 0x6b7, 0x5fc, 0x556,\n\t\t0x4c1, 0x43d, 0x3c7, 0x35e, 0x2ac, 0x262, 0x220\n\t};\n\ts8 offset;\n\n\tif (dgain >= bnd[0])\n\t\toffset = 0x6;\n\telse if (bnd[0] > dgain && dgain >= bnd[1])\n\t\toffset = 0x6;\n\telse if (bnd[1] > dgain && dgain >= bnd[2])\n\t\toffset = 0x5;\n\telse if (bnd[2] > dgain && dgain >= bnd[3])\n\t\toffset = 0x4;\n\telse if (bnd[3] > dgain && dgain >= bnd[4])\n\t\toffset = 0x3;\n\telse if (bnd[4] > dgain && dgain >= bnd[5])\n\t\toffset = 0x2;\n\telse if (bnd[5] > dgain && dgain >= bnd[6])\n\t\toffset = 0x1;\n\telse if (bnd[6] > dgain && dgain >= bnd[7])\n\t\toffset = 0x0;\n\telse if (bnd[7] > dgain && dgain >= bnd[8])\n\t\toffset = 0xff;\n\telse if (bnd[8] > dgain && dgain >= bnd[9])\n\t\toffset = 0xfe;\n\telse if (bnd[9] > dgain && dgain >= bnd[10])\n\t\toffset = 0xfd;\n\telse if (bnd[10] > dgain && dgain >= bnd[11])\n\t\toffset = 0xfc;\n\telse if (bnd[11] > dgain && dgain >= bnd[12])\n\t\toffset = 0xfb;\n\telse if (bnd[12] > dgain && dgain >= bnd[13])\n\t\toffset = 0xfa;\n\telse if (bnd[13] > dgain && dgain >= bnd[14])\n\t\toffset = 0xf9;\n\telse if (bnd[14] > dgain)\n\t\toffset = 0xf8;\n\telse\n\t\toffset = 0x0;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] DGain offset = %d\\n\", offset);\n\n\treturn offset;\n}\n\nstatic u8 _dpk_gainloss_read(struct rtw89_dev *rtwdev)\n{\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x6);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG2, B_DPK_CFG2_ST, 0x1);\n\n\treturn rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_GL);\n}\n\nstatic void _dpk_gainloss(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path, u8 kidx)\n{\n\t_dpk_table_select(rtwdev, path, kidx, 1);\n\t_dpk_one_shot(rtwdev, phy, path, GAIN_LOSS);\n}\n\nstatic void _dpk_kip_preset(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path, u8 kidx)\n{\n\t_dpk_tpg_sel(rtwdev, path, kidx);\n\t_dpk_one_shot(rtwdev, phy, path, KIP_PRESET);\n}\n\nstatic void _dpk_kip_pwr_clk_on(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_rf_path path)\n{\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000080);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x807f030a);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_SYS + (path << 8), MASKDWORD, 0xce000a08);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] KIP Power/CLK on\\n\");\n}\n\nstatic void _dpk_kip_set_txagc(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t       enum rtw89_rf_path path, u8 txagc)\n{\n\trtw89_write_rf(rtwdev, path, RR_TXAGC, RFREG_MASK, txagc);\n\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x1);\n\t_dpk_one_shot(rtwdev, phy, path, DPK_TXAGC);\n\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] set TXAGC = 0x%x\\n\", txagc);\n}\n\nstatic void _dpk_kip_set_rxagc(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t       enum rtw89_rf_path path)\n{\n\tu32 tmp;\n\n\ttmp = rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_MOD, B_KIP_MOD, tmp);\n\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x1);\n\t_dpk_one_shot(rtwdev, phy, path, DPK_RXAGC);\n\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL_V1, 0x8);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] set RXBB = 0x%x (RF0x0[9:5] = 0x%x)\\n\",\n\t\t    rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_RXBB_V1),\n\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASKRXBB));\n}\n\nstatic u8 _dpk_set_offset(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path, s8 gain_offset)\n{\n\tu8 txagc;\n\n\ttxagc = rtw89_read_rf(rtwdev, path, RR_TXAGC, RFREG_MASK);\n\n\tif (txagc - gain_offset < DPK_TXAGC_LOWER)\n\t\ttxagc = DPK_TXAGC_LOWER;\n\telse if (txagc - gain_offset > DPK_TXAGC_UPPER)\n\t\ttxagc = DPK_TXAGC_UPPER;\n\telse\n\t\ttxagc = txagc - gain_offset;\n\n\t_dpk_kip_set_txagc(rtwdev, phy, path, txagc);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] tmp_txagc (GL=%d) = 0x%x\\n\",\n\t\t    gain_offset, txagc);\n\treturn txagc;\n}\n\nstatic bool _dpk_pas_read(struct rtw89_dev *rtwdev, bool is_check)\n{\n\tu32 val1_i = 0, val1_q = 0, val2_i = 0, val2_q = 0;\n\tu8 i;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKBYTE2, 0x06);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG2, B_DPK_CFG2_ST, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE2, 0x08);\n\n\tif (is_check) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, 0x00);\n\t\tval1_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKHWORD);\n\t\tval1_i = abs(sign_extend32(val1_i, 11));\n\t\tval1_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKLWORD);\n\t\tval1_q = abs(sign_extend32(val1_q, 11));\n\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, 0x1f);\n\t\tval2_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKHWORD);\n\t\tval2_i = abs(sign_extend32(val2_i, 11));\n\t\tval2_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKLWORD);\n\t\tval2_q = abs(sign_extend32(val2_q, 11));\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] PAS_delta = 0x%x\\n\",\n\t\t\t    phy_div(val1_i * val1_i + val1_q * val1_q,\n\t\t\t\t    val2_i * val2_i + val2_q * val2_q));\n\t} else {\n\t\tfor (i = 0; i < 32; i++) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, i);\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t    \"[DPK] PAS_Read[%02d]= 0x%08x\\n\", i,\n\t\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD));\n\t\t}\n\t}\n\n\tif (val1_i * val1_i + val1_q * val1_q >=\n\t    (val2_i * val2_i + val2_q * val2_q) * 8 / 5)\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic u8 _dpk_agc(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t   enum rtw89_rf_path path, u8 kidx, u8 init_txagc,\n\t\t   bool loss_only)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 step = DPK_AGC_STEP_SYNC_DGAIN;\n\tu8 tmp_txagc, tmp_rxbb = 0, tmp_gl_idx = 0;\n\tu8 goout = 0, agc_cnt = 0, limited_rxbb = 0;\n\tu16 dgain = 0;\n\ts8 offset;\n\tint limit = 200;\n\n\ttmp_txagc = init_txagc;\n\n\tdo {\n\t\tswitch (step) {\n\t\tcase DPK_AGC_STEP_SYNC_DGAIN:\n\t\t\tif (_dpk_sync(rtwdev, phy, path, kidx)) {\n\t\t\t\ttmp_txagc = 0xff;\n\t\t\t\tgoout = 1;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tdgain = _dpk_dgain_read(rtwdev);\n\n\t\t\tif (loss_only == 1 || limited_rxbb == 1)\n\t\t\t\tstep = DPK_AGC_STEP_GAIN_LOSS_IDX;\n\t\t\telse\n\t\t\t\tstep = DPK_AGC_STEP_GAIN_ADJ;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GAIN_ADJ:\n\t\t\ttmp_rxbb = rtw89_read_rf(rtwdev, path, RR_MOD,\n\t\t\t\t\t\t RFREG_MASKRXBB);\n\t\t\toffset = _dpk_dgain_mapping(rtwdev, dgain);\n\n\t\t\tif (tmp_rxbb + offset > 0x1f) {\n\t\t\t\ttmp_rxbb = 0x1f;\n\t\t\t\tlimited_rxbb = 1;\n\t\t\t} else if (tmp_rxbb + offset < 0) {\n\t\t\t\ttmp_rxbb = 0;\n\t\t\t\tlimited_rxbb = 1;\n\t\t\t} else {\n\t\t\t\ttmp_rxbb = tmp_rxbb + offset;\n\t\t\t}\n\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASKRXBB,\n\t\t\t\t       tmp_rxbb);\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t    \"[DPK] Adjust RXBB (%d) = 0x%x\\n\", offset, tmp_rxbb);\n\t\t\tif (offset || agc_cnt == 0) {\n\t\t\t\tif (chan->band_width < RTW89_CHANNEL_WIDTH_80)\n\t\t\t\t\t_dpk_bypass_rxcfir(rtwdev, path, true);\n\t\t\t\telse\n\t\t\t\t\t_dpk_lbk_rxiqk(rtwdev, phy, path);\n\t\t\t}\n\t\t\tif (dgain > 1922 || dgain < 342)\n\t\t\t\tstep = DPK_AGC_STEP_SYNC_DGAIN;\n\t\t\telse\n\t\t\t\tstep = DPK_AGC_STEP_GAIN_LOSS_IDX;\n\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GAIN_LOSS_IDX:\n\t\t\t_dpk_gainloss(rtwdev, phy, path, kidx);\n\t\t\ttmp_gl_idx = _dpk_gainloss_read(rtwdev);\n\n\t\t\tif ((tmp_gl_idx == 0 && _dpk_pas_read(rtwdev, true)) ||\n\t\t\t    tmp_gl_idx >= 7)\n\t\t\t\tstep = DPK_AGC_STEP_GL_GT_CRITERION;\n\t\t\telse if (tmp_gl_idx == 0)\n\t\t\t\tstep = DPK_AGC_STEP_GL_LT_CRITERION;\n\t\t\telse\n\t\t\t\tstep = DPK_AGC_STEP_SET_TX_GAIN;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GL_GT_CRITERION:\n\t\t\tif (tmp_txagc == 0x2e) {\n\t\t\t\tgoout = 1;\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t\t    \"[DPK] Txagc@lower bound!!\\n\");\n\t\t\t} else {\n\t\t\t\ttmp_txagc = _dpk_set_offset(rtwdev, phy, path, 0x3);\n\t\t\t}\n\t\t\tstep = DPK_AGC_STEP_GAIN_LOSS_IDX;\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GL_LT_CRITERION:\n\t\t\tif (tmp_txagc == 0x3f) {\n\t\t\t\tgoout = 1;\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t\t    \"[DPK] Txagc@upper bound!!\\n\");\n\t\t\t} else {\n\t\t\t\ttmp_txagc = _dpk_set_offset(rtwdev, phy, path, 0xfe);\n\t\t\t}\n\t\t\tstep = DPK_AGC_STEP_GAIN_LOSS_IDX;\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\t\tcase DPK_AGC_STEP_SET_TX_GAIN:\n\t\t\ttmp_txagc = _dpk_set_offset(rtwdev, phy, path, tmp_gl_idx);\n\t\t\tgoout = 1;\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tgoout = 1;\n\t\t\tbreak;\n\t\t}\n\t} while (!goout && agc_cnt < 6 && limit-- > 0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] Txagc / RXBB for DPK = 0x%x / 0x%x\\n\", tmp_txagc,\n\t\t    tmp_rxbb);\n\n\treturn tmp_txagc;\n}\n\nstatic void _dpk_set_mdpd_para(struct rtw89_dev *rtwdev, u8 order)\n{\n\tswitch (order) {\n\tcase 0:\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP, order);\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_PN, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_MAN, 0x1);\n\t\tbreak;\n\tcase 1:\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP, order);\n\t\trtw89_phy_write32_clr(rtwdev, R_LDL_NORM, B_LDL_NORM_PN);\n\t\trtw89_phy_write32_clr(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_MAN);\n\t\tbreak;\n\tcase 2:\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP, order);\n\t\trtw89_phy_write32_clr(rtwdev, R_LDL_NORM, B_LDL_NORM_PN);\n\t\trtw89_phy_write32_clr(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_MAN);\n\t\tbreak;\n\tdefault:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Wrong MDPD order!!(0x%x)\\n\", order);\n\t\tbreak;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] Set MDPD order to 0x%x for IDL\\n\", order);\n}\n\nstatic void _dpk_idl_mpa(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t enum rtw89_rf_path path, u8 kidx, u8 gain)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tif (dpk->bp[path][kidx].bw < RTW89_CHANNEL_WIDTH_80 &&\n\t    dpk->bp[path][kidx].band == RTW89_BAND_5G)\n\t\t_dpk_set_mdpd_para(rtwdev, 0x2);\n\telse\n\t\t_dpk_set_mdpd_para(rtwdev, 0x0);\n\n\t_dpk_one_shot(rtwdev, phy, path, MDPK_IDL);\n}\n\nstatic void _dpk_fill_result(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t     enum rtw89_rf_path path, u8 kidx, u8 gain, u8 txagc)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tconst u16 pwsf = 0x78;\n\tu8 gs = dpk->dpk_gs[phy];\n\n\trtw89_phy_write32_mask(rtwdev, R_COEF_SEL + (path << 8),\n\t\t\t       B_COEF_SEL_MDPD, kidx);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] Fill txagc/ pwsf/ gs = 0x%x/ 0x%x/ 0x%x\\n\", txagc,\n\t\t    pwsf, gs);\n\n\tdpk->bp[path][kidx].txagc_dpk = txagc;\n\trtw89_phy_write32_mask(rtwdev, R_TXAGC_RFK + (path << 8),\n\t\t\t       0x3F << ((gain << 3) + (kidx << 4)), txagc);\n\n\tdpk->bp[path][kidx].pwsf = pwsf;\n\trtw89_phy_write32_mask(rtwdev, R_DPD_BND + (path << 8) + (kidx << 2),\n\t\t\t       0x1FF << (gain << 4), pwsf);\n\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_MDPD, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_MDPD, 0x0);\n\n\tdpk->bp[path][kidx].gs = gs;\n\tif (dpk->dpk_gs[phy] == 0x7f)\n\t\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t\t       MASKDWORD, 0x007f7f7f);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t\t       MASKDWORD, 0x005b5b5b);\n\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       B_DPD_ORDER_V1, _dpk_order_convert(rtwdev));\n\trtw89_phy_write32_mask(rtwdev, R_DPD_V1 + (path << 8), MASKDWORD, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_SEL, 0x0);\n}\n\nstatic bool _dpk_reload_check(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t      enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tbool is_reload = false;\n\tu8 idx, cur_band, cur_ch;\n\n\tcur_band = chan->band_type;\n\tcur_ch = chan->channel;\n\n\tfor (idx = 0; idx < RTW89_DPK_BKUP_NUM; idx++) {\n\t\tif (cur_band != dpk->bp[path][idx].band ||\n\t\t    cur_ch != dpk->bp[path][idx].ch)\n\t\t\tcontinue;\n\n\t\trtw89_phy_write32_mask(rtwdev, R_COEF_SEL + (path << 8),\n\t\t\t\t       B_COEF_SEL_MDPD, idx);\n\t\tdpk->cur_idx[path] = idx;\n\t\tis_reload = true;\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] reload S%d[%d] success\\n\", path, idx);\n\t}\n\n\treturn is_reload;\n}\n\nstatic bool _dpk_main(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t      enum rtw89_rf_path path, u8 gain)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 txagc = 0x38, kidx = dpk->cur_idx[path];\n\tbool is_fail = false;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] ========= S%d[%d] DPK Start =========\\n\", path, kidx);\n\n\t_rfk_rf_direct_cntrl(rtwdev, path, false);\n\t_rfk_drf_direct_cntrl(rtwdev, path, false);\n\n\t_dpk_kip_pwr_clk_on(rtwdev, path);\n\t_dpk_kip_set_txagc(rtwdev, phy, path, txagc);\n\t_dpk_rf_setting(rtwdev, gain, path, kidx);\n\t_dpk_rx_dck(rtwdev, phy, path);\n\n\t_dpk_kip_preset(rtwdev, phy, path, kidx);\n\t_dpk_kip_set_rxagc(rtwdev, phy, path);\n\t_dpk_table_select(rtwdev, path, kidx, gain);\n\n\ttxagc = _dpk_agc(rtwdev, phy, path, kidx, txagc, false);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Adjust txagc = 0x%x\\n\", txagc);\n\n\tif (txagc == 0xff) {\n\t\tis_fail = true;\n\t} else {\n\t\t_dpk_get_thermal(rtwdev, kidx, path);\n\n\t\t_dpk_idl_mpa(rtwdev, phy, path, kidx, gain);\n\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\n\t\t_dpk_fill_result(rtwdev, phy, path, kidx, gain, txagc);\n\t}\n\n\tif (!is_fail)\n\t\tdpk->bp[path][kidx].path_ok = true;\n\telse\n\t\tdpk->bp[path][kidx].path_ok = false;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d[%d] DPK %s\\n\", path, kidx,\n\t\t    is_fail ? \"Check\" : \"Success\");\n\n\treturn is_fail;\n}\n\nstatic void _dpk_cal_select(struct rtw89_dev *rtwdev, bool force,\n\t\t\t    enum rtw89_phy_idx phy, u8 kpath)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tstatic const u32 kip_reg[] = {0x813c, 0x8124, 0x8120};\n\tu32 kip_bkup[RTW8852B_DPK_RF_PATH][RTW8852B_DPK_KIP_REG_NUM] = {};\n\tu32 backup_rf_val[RTW8852B_DPK_RF_PATH][BACKUP_RF_REGS_NR];\n\tu32 backup_bb_val[BACKUP_BB_REGS_NR];\n\tbool is_fail = true, reloaded[RTW8852B_DPK_RF_PATH] = {};\n\tu8 path;\n\n\tif (dpk->is_dpk_reload_en) {\n\t\tfor (path = 0; path < RTW8852B_DPK_RF_PATH; path++) {\n\t\t\treloaded[path] = _dpk_reload_check(rtwdev, phy, path);\n\t\t\tif (!reloaded[path] && dpk->bp[path][0].ch)\n\t\t\t\tdpk->cur_idx[path] = !dpk->cur_idx[path];\n\t\t\telse\n\t\t\t\t_dpk_onoff(rtwdev, path, false);\n\t\t}\n\t} else {\n\t\tfor (path = 0; path < RTW8852B_DPK_RF_PATH; path++)\n\t\t\tdpk->cur_idx[path] = 0;\n\t}\n\n\t_rfk_backup_bb_reg(rtwdev, &backup_bb_val[0]);\n\n\tfor (path = 0; path < RTW8852B_DPK_RF_PATH; path++) {\n\t\t_dpk_bkup_kip(rtwdev, kip_reg, kip_bkup, path);\n\t\t_rfk_backup_rf_reg(rtwdev, &backup_rf_val[path][0], path);\n\t\t_dpk_information(rtwdev, phy, path);\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\t_dpk_tssi_pause(rtwdev, path, true);\n\t}\n\n\t_dpk_bb_afe_setting(rtwdev, phy, path, kpath);\n\n\tfor (path = 0; path < RTW8852B_DPK_RF_PATH; path++) {\n\t\tis_fail = _dpk_main(rtwdev, phy, path, 1);\n\t\t_dpk_onoff(rtwdev, path, is_fail);\n\t}\n\n\t_dpk_bb_afe_restore(rtwdev, phy, path, kpath);\n\t_rfk_restore_bb_reg(rtwdev, &backup_bb_val[0]);\n\n\tfor (path = 0; path < RTW8852B_DPK_RF_PATH; path++) {\n\t\t_dpk_kip_restore(rtwdev, path);\n\t\t_dpk_reload_kip(rtwdev, kip_reg, kip_bkup, path);\n\t\t_rfk_restore_rf_reg(rtwdev, &backup_rf_val[path][0], path);\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\t_dpk_tssi_pause(rtwdev, path, false);\n\t}\n}\n\nstatic bool _dpk_bypass_check(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_fem_info *fem = &rtwdev->fem;\n\n\tif (fem->epa_2g && chan->band_type == RTW89_BAND_2G) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Skip DPK due to 2G_ext_PA exist!!\\n\");\n\t\treturn true;\n\t} else if (fem->epa_5g && chan->band_type == RTW89_BAND_5G) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Skip DPK due to 5G_ext_PA exist!!\\n\");\n\t\treturn true;\n\t} else if (fem->epa_6g && chan->band_type == RTW89_BAND_6G) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Skip DPK due to 6G_ext_PA exist!!\\n\");\n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic void _dpk_force_bypass(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tu8 path, kpath;\n\n\tkpath = _kpath(rtwdev, phy);\n\n\tfor (path = 0; path < RTW8852B_DPK_RF_PATH; path++) {\n\t\tif (kpath & BIT(path))\n\t\t\t_dpk_onoff(rtwdev, path, true);\n\t}\n}\n\nstatic void _dpk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy, bool force)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] ****** DPK Start (Ver: 0x%x, Cv: %d, RF_para: %d) ******\\n\",\n\t\t    RTW8852B_DPK_VER, rtwdev->hal.cv,\n\t\t    RTW8852B_RF_REL_VERSION);\n\n\tif (_dpk_bypass_check(rtwdev, phy))\n\t\t_dpk_force_bypass(rtwdev, phy);\n\telse\n\t\t_dpk_cal_select(rtwdev, force, phy, RF_AB);\n}\n\nstatic void _dpk_track(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\ts8 txagc_bb, txagc_bb_tp, ini_diff = 0, txagc_ofst;\n\ts8 delta_ther[2] = {};\n\tu8 trk_idx, txagc_rf;\n\tu8 path, kidx;\n\tu16 pwsf[2];\n\tu8 cur_ther;\n\tu32 tmp;\n\n\tfor (path = 0; path < RF_PATH_NUM_8852B; path++) {\n\t\tkidx = dpk->cur_idx[path];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] ================[S%d[%d] (CH %d)]================\\n\",\n\t\t\t    path, kidx, dpk->bp[path][kidx].ch);\n\n\t\tcur_ther = ewma_thermal_read(&rtwdev->phystat.avg_thermal[path]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] thermal now = %d\\n\", cur_ther);\n\n\t\tif (dpk->bp[path][kidx].ch && cur_ther)\n\t\t\tdelta_ther[path] = dpk->bp[path][kidx].ther_dpk - cur_ther;\n\n\t\tif (dpk->bp[path][kidx].band == RTW89_BAND_2G)\n\t\t\tdelta_ther[path] = delta_ther[path] * 3 / 2;\n\t\telse\n\t\t\tdelta_ther[path] = delta_ther[path] * 5 / 2;\n\n\t\ttxagc_rf = rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB + (path << 13),\n\t\t\t\t\t\t 0x0000003f);\n\n\t\tif (rtwdev->is_tssi_mode[path]) {\n\t\t\ttrk_idx = rtw89_read_rf(rtwdev, path, RR_TXA, RR_TXA_TRK);\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t    \"[DPK_TRK] txagc_RF / track_idx = 0x%x / %d\\n\",\n\t\t\t\t    txagc_rf, trk_idx);\n\n\t\t\ttxagc_bb =\n\t\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BB + (path << 13),\n\t\t\t\t\t\t      MASKBYTE2);\n\t\t\ttxagc_bb_tp =\n\t\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_TP + (path << 13),\n\t\t\t\t\t\t      B_TXAGC_TP);\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t    \"[DPK_TRK] txagc_bb_tp / txagc_bb = 0x%x / 0x%x\\n\",\n\t\t\t\t    txagc_bb_tp, txagc_bb);\n\n\t\t\ttxagc_ofst =\n\t\t\t\trtw89_phy_read32_mask(rtwdev, R_TXAGC_BB + (path << 13),\n\t\t\t\t\t\t      MASKBYTE3);\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t    \"[DPK_TRK] txagc_offset / delta_ther = %d / %d\\n\",\n\t\t\t\t    txagc_ofst, delta_ther[path]);\n\t\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_DPD_COM + (path << 8),\n\t\t\t\t\t\t    B_DPD_COM_OF);\n\t\t\tif (tmp == 0x1) {\n\t\t\t\ttxagc_ofst = 0;\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t\t    \"[DPK_TRK] HW txagc offset mode\\n\");\n\t\t\t}\n\n\t\t\tif (txagc_rf && cur_ther)\n\t\t\t\tini_diff = txagc_ofst + (delta_ther[path]);\n\n\t\t\ttmp = rtw89_phy_read32_mask(rtwdev,\n\t\t\t\t\t\t    R_P0_TXDPD + (path << 13),\n\t\t\t\t\t\t    B_P0_TXDPD);\n\t\t\tif (tmp == 0x0) {\n\t\t\t\tpwsf[0] = dpk->bp[path][kidx].pwsf +\n\t\t\t\t\t  txagc_bb_tp - txagc_bb + ini_diff;\n\t\t\t\tpwsf[1] = dpk->bp[path][kidx].pwsf +\n\t\t\t\t\t  txagc_bb_tp - txagc_bb + ini_diff;\n\t\t\t} else {\n\t\t\t\tpwsf[0] = dpk->bp[path][kidx].pwsf + ini_diff;\n\t\t\t\tpwsf[1] = dpk->bp[path][kidx].pwsf + ini_diff;\n\t\t\t}\n\n\t\t} else {\n\t\t\tpwsf[0] = (dpk->bp[path][kidx].pwsf + delta_ther[path]) & 0x1ff;\n\t\t\tpwsf[1] = (dpk->bp[path][kidx].pwsf + delta_ther[path]) & 0x1ff;\n\t\t}\n\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, R_DPK_TRK, B_DPK_TRK_DIS);\n\t\tif (!tmp && txagc_rf) {\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t    \"[DPK_TRK] New pwsf[0] / pwsf[1] = 0x%x / 0x%x\\n\",\n\t\t\t\t    pwsf[0], pwsf[1]);\n\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_DPD_BND + (path << 8) + (kidx << 2),\n\t\t\t\t\t       B_DPD_BND_0, pwsf[0]);\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_DPD_BND + (path << 8) + (kidx << 2),\n\t\t\t\t\t       B_DPD_BND_1, pwsf[1]);\n\t\t}\n\t}\n}\n\nstatic void _set_dpd_backoff(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 tx_scale, ofdm_bkof, path, kpath;\n\n\tkpath = _kpath(rtwdev, phy);\n\n\tofdm_bkof = rtw89_phy_read32_mask(rtwdev, R_DPD_BF + (phy << 13), B_DPD_BF_OFDM);\n\ttx_scale = rtw89_phy_read32_mask(rtwdev, R_DPD_BF + (phy << 13), B_DPD_BF_SCA);\n\n\tif (ofdm_bkof + tx_scale >= 44) {\n\t\t \n\t\tdpk->dpk_gs[phy] = 0x7f;\n\t\tfor (path = 0; path < RF_PATH_NUM_8852B; path++) {\n\t\t\tif (!(kpath & BIT(path)))\n\t\t\t\tcontinue;\n\n\t\t\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8),\n\t\t\t\t\t       B_DPD_CFG, 0x7f7f7f);\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t    \"[RFK] Set S%d DPD backoff to 0dB\\n\", path);\n\t\t}\n\t} else {\n\t\tdpk->dpk_gs[phy] = 0x5b;\n\t}\n}\n\nstatic void _tssi_rf_setting(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t     enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\tif (band == RTW89_BAND_2G)\n\t\trtw89_write_rf(rtwdev, path, RR_TXPOW, RR_TXPOW_TXG, 0x1);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_TXPOW, RR_TXPOW_TXA, 0x1);\n}\n\nstatic void _tssi_set_sys(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\trtw89_rfk_parser(rtwdev, &rtw8852b_tssi_sys_defs_tbl);\n\n\tif (path == RF_PATH_A)\n\t\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t\t &rtw8852b_tssi_sys_a_defs_2g_tbl,\n\t\t\t\t\t &rtw8852b_tssi_sys_a_defs_5g_tbl);\n\telse\n\t\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t\t &rtw8852b_tssi_sys_b_defs_2g_tbl,\n\t\t\t\t\t &rtw8852b_tssi_sys_b_defs_5g_tbl);\n}\n\nstatic void _tssi_ini_txpwr_ctrl_bb(struct rtw89_dev *rtwdev,\n\t\t\t\t    enum rtw89_phy_idx phy,\n\t\t\t\t    enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852b_tssi_init_txpwr_defs_a_tbl,\n\t\t\t\t &rtw8852b_tssi_init_txpwr_defs_b_tbl);\n}\n\nstatic void _tssi_ini_txpwr_ctrl_bb_he_tb(struct rtw89_dev *rtwdev,\n\t\t\t\t\t  enum rtw89_phy_idx phy,\n\t\t\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852b_tssi_init_txpwr_he_tb_defs_a_tbl,\n\t\t\t\t &rtw8852b_tssi_init_txpwr_he_tb_defs_b_tbl);\n}\n\nstatic void _tssi_set_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852b_tssi_dck_defs_a_tbl,\n\t\t\t\t &rtw8852b_tssi_dck_defs_b_tbl);\n}\n\nstatic void _tssi_set_tmeter_tbl(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n#define RTW8852B_TSSI_GET_VAL(ptr, idx)\t\t\t\\\n({\t\t\t\t\t\t\t\\\n\ts8 *__ptr = (ptr);\t\t\t\t\\\n\tu8 __idx = (idx), __i, __v;\t\t\t\\\n\tu32 __val = 0;\t\t\t\t\t\\\n\tfor (__i = 0; __i < 4; __i++) {\t\t\t\\\n\t\t__v = (__ptr[__idx + __i]);\t\t\\\n\t\t__val |= (__v << (8 * __i));\t\t\\\n\t}\t\t\t\t\t\t\\\n\t__val;\t\t\t\t\t\t\\\n})\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu8 subband = chan->subband_type;\n\tconst s8 *thm_up_a = NULL;\n\tconst s8 *thm_down_a = NULL;\n\tconst s8 *thm_up_b = NULL;\n\tconst s8 *thm_down_b = NULL;\n\tu8 thermal = 0xff;\n\ts8 thm_ofst[64] = {0};\n\tu32 tmp = 0;\n\tu8 i, j;\n\n\tswitch (subband) {\n\tdefault:\n\tcase RTW89_CH_2G:\n\t\tthm_up_a = rtw89_8852b_trk_cfg.delta_swingidx_2ga_p;\n\t\tthm_down_a = rtw89_8852b_trk_cfg.delta_swingidx_2ga_n;\n\t\tthm_up_b = rtw89_8852b_trk_cfg.delta_swingidx_2gb_p;\n\t\tthm_down_b = rtw89_8852b_trk_cfg.delta_swingidx_2gb_n;\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_1:\n\t\tthm_up_a = rtw89_8852b_trk_cfg.delta_swingidx_5ga_p[0];\n\t\tthm_down_a = rtw89_8852b_trk_cfg.delta_swingidx_5ga_n[0];\n\t\tthm_up_b = rtw89_8852b_trk_cfg.delta_swingidx_5gb_p[0];\n\t\tthm_down_b = rtw89_8852b_trk_cfg.delta_swingidx_5gb_n[0];\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_3:\n\t\tthm_up_a = rtw89_8852b_trk_cfg.delta_swingidx_5ga_p[1];\n\t\tthm_down_a = rtw89_8852b_trk_cfg.delta_swingidx_5ga_n[1];\n\t\tthm_up_b = rtw89_8852b_trk_cfg.delta_swingidx_5gb_p[1];\n\t\tthm_down_b = rtw89_8852b_trk_cfg.delta_swingidx_5gb_n[1];\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_4:\n\t\tthm_up_a = rtw89_8852b_trk_cfg.delta_swingidx_5ga_p[2];\n\t\tthm_down_a = rtw89_8852b_trk_cfg.delta_swingidx_5ga_n[2];\n\t\tthm_up_b = rtw89_8852b_trk_cfg.delta_swingidx_5gb_p[2];\n\t\tthm_down_b = rtw89_8852b_trk_cfg.delta_swingidx_5gb_n[2];\n\t\tbreak;\n\t}\n\n\tif (path == RF_PATH_A) {\n\t\tthermal = tssi_info->thermal[RF_PATH_A];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] ch=%d thermal_pathA=0x%x\\n\", ch, thermal);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER_DIS, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER_TRK, 0x1);\n\n\t\tif (thermal == 0xff) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER, 32);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_VAL, 32);\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\trtw89_phy_write32(rtwdev, R_P0_TSSI_BASE + i, 0x0);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    R_P0_TSSI_BASE + i, 0x0);\n\t\t\t}\n\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER, thermal);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_VAL,\n\t\t\t\t\t       thermal);\n\n\t\t\ti = 0;\n\t\t\tfor (j = 0; j < 32; j++)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      -thm_down_a[i++] :\n\t\t\t\t\t      -thm_down_a[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\ti = 1;\n\t\t\tfor (j = 63; j >= 32; j--)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      thm_up_a[i++] :\n\t\t\t\t\t      thm_up_a[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\ttmp = RTW8852B_TSSI_GET_VAL(thm_ofst, i);\n\t\t\t\trtw89_phy_write32(rtwdev, R_P0_TSSI_BASE + i, tmp);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x5c00 + i, tmp);\n\t\t\t}\n\t\t}\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, R_P0_RFCTM_RDY, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, R_P0_RFCTM_RDY, 0x0);\n\n\t} else {\n\t\tthermal = tssi_info->thermal[RF_PATH_B];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] ch=%d thermal_pathB=0x%x\\n\", ch, thermal);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER_DIS, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER_TRK, 0x1);\n\n\t\tif (thermal == 0xff) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER, 32);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, B_P1_RFCTM_VAL, 32);\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\trtw89_phy_write32(rtwdev, R_TSSI_THOF + i, 0x0);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x7c00 + i, 0x0);\n\t\t\t}\n\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TMETER, B_P1_TMETER, thermal);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, B_P1_RFCTM_VAL,\n\t\t\t\t\t       thermal);\n\n\t\t\ti = 0;\n\t\t\tfor (j = 0; j < 32; j++)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      -thm_down_b[i++] :\n\t\t\t\t\t      -thm_down_b[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\ti = 1;\n\t\t\tfor (j = 63; j >= 32; j--)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      thm_up_b[i++] :\n\t\t\t\t\t      thm_up_b[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\ttmp = RTW8852B_TSSI_GET_VAL(thm_ofst, i);\n\t\t\t\trtw89_phy_write32(rtwdev, R_TSSI_THOF + i, tmp);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x7c00 + i, tmp);\n\t\t\t}\n\t\t}\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, R_P1_RFCTM_RDY, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_RFCTM, R_P1_RFCTM_RDY, 0x0);\n\t}\n#undef RTW8852B_TSSI_GET_VAL\n}\n\nstatic void _tssi_set_dac_gain_tbl(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t   enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852b_tssi_dac_gain_defs_a_tbl,\n\t\t\t\t &rtw8852b_tssi_dac_gain_defs_b_tbl);\n}\n\nstatic void _tssi_slope_cal_org(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\tif (path == RF_PATH_A)\n\t\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t\t &rtw8852b_tssi_slope_a_defs_2g_tbl,\n\t\t\t\t\t &rtw8852b_tssi_slope_a_defs_5g_tbl);\n\telse\n\t\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t\t &rtw8852b_tssi_slope_b_defs_2g_tbl,\n\t\t\t\t\t &rtw8852b_tssi_slope_b_defs_5g_tbl);\n}\n\nstatic void _tssi_alignment_default(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t    enum rtw89_rf_path path, bool all)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\tconst struct rtw89_rfk_tbl *tbl = NULL;\n\tu8 ch = chan->channel;\n\n\tif (path == RF_PATH_A) {\n\t\tif (band == RTW89_BAND_2G) {\n\t\t\tif (all)\n\t\t\t\ttbl = &rtw8852b_tssi_align_a_2g_all_defs_tbl;\n\t\t\telse\n\t\t\t\ttbl = &rtw8852b_tssi_align_a_2g_part_defs_tbl;\n\t\t} else if (ch >= 36 && ch <= 64) {\n\t\t\tif (all)\n\t\t\t\ttbl = &rtw8852b_tssi_align_a_5g1_all_defs_tbl;\n\t\t\telse\n\t\t\t\ttbl = &rtw8852b_tssi_align_a_5g1_part_defs_tbl;\n\t\t} else if (ch >= 100 && ch <= 144) {\n\t\t\tif (all)\n\t\t\t\ttbl = &rtw8852b_tssi_align_a_5g2_all_defs_tbl;\n\t\t\telse\n\t\t\t\ttbl = &rtw8852b_tssi_align_a_5g2_part_defs_tbl;\n\t\t} else if (ch >= 149 && ch <= 177) {\n\t\t\tif (all)\n\t\t\t\ttbl = &rtw8852b_tssi_align_a_5g3_all_defs_tbl;\n\t\t\telse\n\t\t\t\ttbl = &rtw8852b_tssi_align_a_5g3_part_defs_tbl;\n\t\t}\n\t} else {\n\t\tif (ch >= 1 && ch <= 14) {\n\t\t\tif (all)\n\t\t\t\ttbl = &rtw8852b_tssi_align_b_2g_all_defs_tbl;\n\t\t\telse\n\t\t\t\ttbl = &rtw8852b_tssi_align_b_2g_part_defs_tbl;\n\t\t} else if (ch >= 36 && ch <= 64) {\n\t\t\tif (all)\n\t\t\t\ttbl = &rtw8852b_tssi_align_b_5g1_all_defs_tbl;\n\t\t\telse\n\t\t\t\ttbl = &rtw8852b_tssi_align_b_5g1_part_defs_tbl;\n\t\t} else if (ch >= 100 && ch <= 144) {\n\t\t\tif (all)\n\t\t\t\ttbl = &rtw8852b_tssi_align_b_5g2_all_defs_tbl;\n\t\t\telse\n\t\t\t\ttbl = &rtw8852b_tssi_align_b_5g2_part_defs_tbl;\n\t\t} else if (ch >= 149 && ch <= 177) {\n\t\t\tif (all)\n\t\t\t\ttbl = &rtw8852b_tssi_align_b_5g3_all_defs_tbl;\n\t\t\telse\n\t\t\t\ttbl = &rtw8852b_tssi_align_b_5g3_part_defs_tbl;\n\t\t}\n\t}\n\n\tif (tbl)\n\t\trtw89_rfk_parser(rtwdev, tbl);\n}\n\nstatic void _tssi_set_tssi_slope(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser_by_cond(rtwdev, path == RF_PATH_A,\n\t\t\t\t &rtw8852b_tssi_slope_defs_a_tbl,\n\t\t\t\t &rtw8852b_tssi_slope_defs_b_tbl);\n}\n\nstatic void _tssi_set_tssi_track(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n\tif (path == RF_PATH_A)\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSIC, B_P0_TSSIC_BYPASS, 0x0);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSIC, B_P1_TSSIC_BYPASS, 0x0);\n}\n\nstatic void _tssi_set_txagc_offset_mv_avg(struct rtw89_dev *rtwdev,\n\t\t\t\t\t  enum rtw89_phy_idx phy,\n\t\t\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"======>%s   path=%d\\n\", __func__,\n\t\t    path);\n\n\tif (path == RF_PATH_A)\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_MV_AVG, B_P0_TSSI_MV_MIX, 0x010);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_MV_AVG, B_P1_RFCTM_DEL, 0x010);\n}\n\nstatic void _tssi_enable(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tu8 i;\n\n\tfor (i = 0; i < RF_PATH_NUM_8852B; i++) {\n\t\t_tssi_set_tssi_track(rtwdev, phy, i);\n\t\t_tssi_set_txagc_offset_mv_avg(rtwdev, phy, i);\n\n\t\tif (i == RF_PATH_A) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_MV_AVG,\n\t\t\t\t\t       B_P0_TSSI_MV_CLR, 0x0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_AVG,\n\t\t\t\t\t       B_P0_TSSI_EN, 0x0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_AVG,\n\t\t\t\t\t       B_P0_TSSI_EN, 0x1);\n\t\t\trtw89_write_rf(rtwdev, i, RR_TXGA_V1,\n\t\t\t\t       RR_TXGA_V1_TRK_EN, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK,\n\t\t\t\t\t       B_P0_TSSI_RFC, 0x3);\n\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK,\n\t\t\t\t\t       B_P0_TSSI_OFT, 0xc0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK,\n\t\t\t\t\t       B_P0_TSSI_OFT_EN, 0x0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK,\n\t\t\t\t\t       B_P0_TSSI_OFT_EN, 0x1);\n\n\t\t\trtwdev->is_tssi_mode[RF_PATH_A] = true;\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_MV_AVG,\n\t\t\t\t\t       B_P1_TSSI_MV_CLR, 0x0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_AVG,\n\t\t\t\t\t       B_P1_TSSI_EN, 0x0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_AVG,\n\t\t\t\t\t       B_P1_TSSI_EN, 0x1);\n\t\t\trtw89_write_rf(rtwdev, i, RR_TXGA_V1,\n\t\t\t\t       RR_TXGA_V1_TRK_EN, 0x1);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK,\n\t\t\t\t\t       B_P1_TSSI_RFC, 0x3);\n\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK,\n\t\t\t\t\t       B_P1_TSSI_OFT, 0xc0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK,\n\t\t\t\t\t       B_P1_TSSI_OFT_EN, 0x0);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK,\n\t\t\t\t\t       B_P1_TSSI_OFT_EN, 0x1);\n\n\t\t\trtwdev->is_tssi_mode[RF_PATH_B] = true;\n\t\t}\n\t}\n}\n\nstatic void _tssi_disable(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_AVG, B_P0_TSSI_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_RFC, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_MV_AVG, B_P0_TSSI_MV_CLR, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_AVG, B_P1_TSSI_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_RFC, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_MV_AVG, B_P1_TSSI_MV_CLR, 0x1);\n\n\trtwdev->is_tssi_mode[RF_PATH_A] = false;\n\trtwdev->is_tssi_mode[RF_PATH_B] = false;\n}\n\nstatic u32 _tssi_get_cck_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 2:\n\t\treturn 0;\n\tcase 3 ... 5:\n\t\treturn 1;\n\tcase 6 ... 8:\n\t\treturn 2;\n\tcase 9 ... 11:\n\t\treturn 3;\n\tcase 12 ... 13:\n\t\treturn 4;\n\tcase 14:\n\t\treturn 5;\n\t}\n\n\treturn 0;\n}\n\n#define TSSI_EXTRA_GROUP_BIT (BIT(31))\n#define TSSI_EXTRA_GROUP(idx) (TSSI_EXTRA_GROUP_BIT | (idx))\n#define IS_TSSI_EXTRA_GROUP(group) ((group) & TSSI_EXTRA_GROUP_BIT)\n#define TSSI_EXTRA_GET_GROUP_IDX1(group) ((group) & ~TSSI_EXTRA_GROUP_BIT)\n#define TSSI_EXTRA_GET_GROUP_IDX2(group) (TSSI_EXTRA_GET_GROUP_IDX1(group) + 1)\n\nstatic u32 _tssi_get_ofdm_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 2:\n\t\treturn 0;\n\tcase 3 ... 5:\n\t\treturn 1;\n\tcase 6 ... 8:\n\t\treturn 2;\n\tcase 9 ... 11:\n\t\treturn 3;\n\tcase 12 ... 14:\n\t\treturn 4;\n\tcase 36 ... 40:\n\t\treturn 5;\n\tcase 41 ... 43:\n\t\treturn TSSI_EXTRA_GROUP(5);\n\tcase 44 ... 48:\n\t\treturn 6;\n\tcase 49 ... 51:\n\t\treturn TSSI_EXTRA_GROUP(6);\n\tcase 52 ... 56:\n\t\treturn 7;\n\tcase 57 ... 59:\n\t\treturn TSSI_EXTRA_GROUP(7);\n\tcase 60 ... 64:\n\t\treturn 8;\n\tcase 100 ... 104:\n\t\treturn 9;\n\tcase 105 ... 107:\n\t\treturn TSSI_EXTRA_GROUP(9);\n\tcase 108 ... 112:\n\t\treturn 10;\n\tcase 113 ... 115:\n\t\treturn TSSI_EXTRA_GROUP(10);\n\tcase 116 ... 120:\n\t\treturn 11;\n\tcase 121 ... 123:\n\t\treturn TSSI_EXTRA_GROUP(11);\n\tcase 124 ... 128:\n\t\treturn 12;\n\tcase 129 ... 131:\n\t\treturn TSSI_EXTRA_GROUP(12);\n\tcase 132 ... 136:\n\t\treturn 13;\n\tcase 137 ... 139:\n\t\treturn TSSI_EXTRA_GROUP(13);\n\tcase 140 ... 144:\n\t\treturn 14;\n\tcase 149 ... 153:\n\t\treturn 15;\n\tcase 154 ... 156:\n\t\treturn TSSI_EXTRA_GROUP(15);\n\tcase 157 ... 161:\n\t\treturn 16;\n\tcase 162 ... 164:\n\t\treturn TSSI_EXTRA_GROUP(16);\n\tcase 165 ... 169:\n\t\treturn 17;\n\tcase 170 ... 172:\n\t\treturn TSSI_EXTRA_GROUP(17);\n\tcase 173 ... 177:\n\t\treturn 18;\n\t}\n\n\treturn 0;\n}\n\nstatic u32 _tssi_get_trim_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 8:\n\t\treturn 0;\n\tcase 9 ... 14:\n\t\treturn 1;\n\tcase 36 ... 48:\n\t\treturn 2;\n\tcase 52 ... 64:\n\t\treturn 3;\n\tcase 100 ... 112:\n\t\treturn 4;\n\tcase 116 ... 128:\n\t\treturn 5;\n\tcase 132 ... 144:\n\t\treturn 6;\n\tcase 149 ... 177:\n\t\treturn 7;\n\t}\n\n\treturn 0;\n}\n\nstatic s8 _tssi_get_ofdm_de(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu32 gidx, gidx_1st, gidx_2nd;\n\ts8 de_1st;\n\ts8 de_2nd;\n\ts8 val;\n\n\tgidx = _tssi_get_ofdm_group(rtwdev, ch);\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t    \"[TSSI][TRIM]: path=%d mcs group_idx=0x%x\\n\", path, gidx);\n\n\tif (IS_TSSI_EXTRA_GROUP(gidx)) {\n\t\tgidx_1st = TSSI_EXTRA_GET_GROUP_IDX1(gidx);\n\t\tgidx_2nd = TSSI_EXTRA_GET_GROUP_IDX2(gidx);\n\t\tde_1st = tssi_info->tssi_mcs[path][gidx_1st];\n\t\tde_2nd = tssi_info->tssi_mcs[path][gidx_2nd];\n\t\tval = (de_1st + de_2nd) / 2;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs de=%d 1st=%d 2nd=%d\\n\",\n\t\t\t    path, val, de_1st, de_2nd);\n\t} else {\n\t\tval = tssi_info->tssi_mcs[path][gidx];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs de=%d\\n\", path, val);\n\t}\n\n\treturn val;\n}\n\nstatic s8 _tssi_get_ofdm_trim_de(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu32 tgidx, tgidx_1st, tgidx_2nd;\n\ts8 tde_1st;\n\ts8 tde_2nd;\n\ts8 val;\n\n\ttgidx = _tssi_get_trim_group(rtwdev, ch);\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t    \"[TSSI][TRIM]: path=%d mcs trim_group_idx=0x%x\\n\",\n\t\t    path, tgidx);\n\n\tif (IS_TSSI_EXTRA_GROUP(tgidx)) {\n\t\ttgidx_1st = TSSI_EXTRA_GET_GROUP_IDX1(tgidx);\n\t\ttgidx_2nd = TSSI_EXTRA_GET_GROUP_IDX2(tgidx);\n\t\ttde_1st = tssi_info->tssi_trim[path][tgidx_1st];\n\t\ttde_2nd = tssi_info->tssi_trim[path][tgidx_2nd];\n\t\tval = (tde_1st + tde_2nd) / 2;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_de=%d 1st=%d 2nd=%d\\n\",\n\t\t\t    path, val, tde_1st, tde_2nd);\n\t} else {\n\t\tval = tssi_info->tssi_trim[path][tgidx];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_de=%d\\n\",\n\t\t\t    path, val);\n\t}\n\n\treturn val;\n}\n\nstatic void _tssi_set_efuse_to_de(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu8 gidx;\n\ts8 ofdm_de;\n\ts8 trim_de;\n\ts32 val;\n\tu32 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI][TRIM]: phy=%d ch=%d\\n\",\n\t\t    phy, ch);\n\n\tfor (i = RF_PATH_A; i < RF_PATH_NUM_8852B; i++) {\n\t\tgidx = _tssi_get_cck_group(rtwdev, ch);\n\t\ttrim_de = _tssi_get_ofdm_trim_de(rtwdev, phy, i);\n\t\tval = tssi_info->tssi_cck[i][gidx] + trim_de;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d cck[%d]=0x%x trim=0x%x\\n\",\n\t\t\t    i, gidx, tssi_info->tssi_cck[i][gidx], trim_de);\n\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_cck_long[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_cck_short[i], _TSSI_DE_MASK, val);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] Set TSSI CCK DE 0x%x[21:12]=0x%x\\n\",\n\t\t\t    _tssi_de_cck_long[i],\n\t\t\t    rtw89_phy_read32_mask(rtwdev, _tssi_de_cck_long[i],\n\t\t\t\t\t\t  _TSSI_DE_MASK));\n\n\t\tofdm_de = _tssi_get_ofdm_de(rtwdev, phy, i);\n\t\ttrim_de = _tssi_get_ofdm_trim_de(rtwdev, phy, i);\n\t\tval = ofdm_de + trim_de;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs=0x%x trim=0x%x\\n\",\n\t\t\t    i, ofdm_de, trim_de);\n\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_20m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_40m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_80m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_80m_80m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_5m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_10m[i], _TSSI_DE_MASK, val);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] Set TSSI MCS DE 0x%x[21:12]=0x%x\\n\",\n\t\t\t    _tssi_de_mcs_20m[i],\n\t\t\t    rtw89_phy_read32_mask(rtwdev, _tssi_de_mcs_20m[i],\n\t\t\t\t\t\t  _TSSI_DE_MASK));\n\t}\n}\n\nstatic void _tssi_alimentk_dump_result(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[TSSI PA K]\\n0x%x = 0x%08x\\n0x%x = 0x%08x\\n0x%x = 0x%08x\\n0x%x = 0x%08x\\n\"\n\t\t    \"0x%x = 0x%08x\\n0x%x = 0x%08x\\n0x%x = 0x%08x\\n0x%x = 0x%08x\\n\",\n\t\t    R_TSSI_PA_K1 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TSSI_PA_K1 + (path << 13), MASKDWORD),\n\t\t    R_TSSI_PA_K2 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TSSI_PA_K2 + (path << 13), MASKDWORD),\n\t\t    R_P0_TSSI_ALIM1 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM1 + (path << 13), MASKDWORD),\n\t\t    R_P0_TSSI_ALIM3 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM3 + (path << 13), MASKDWORD),\n\t\t    R_TSSI_PA_K5 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TSSI_PA_K5 + (path << 13), MASKDWORD),\n\t\t    R_P0_TSSI_ALIM2 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM2 + (path << 13), MASKDWORD),\n\t\t    R_P0_TSSI_ALIM4 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM4 + (path << 13), MASKDWORD),\n\t\t    R_TSSI_PA_K8 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TSSI_PA_K8 + (path << 13), MASKDWORD));\n}\n\nstatic void _tssi_alimentk_done(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_phy_idx phy, enum rtw89_rf_path path)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 channel = chan->channel;\n\tu8 band;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======>%s   phy=%d   path=%d\\n\", __func__, phy, path);\n\n\tif (channel >= 1 && channel <= 14)\n\t\tband = TSSI_ALIMK_2G;\n\telse if (channel >= 36 && channel <= 64)\n\t\tband = TSSI_ALIMK_5GL;\n\telse if (channel >= 100 && channel <= 144)\n\t\tband = TSSI_ALIMK_5GM;\n\telse if (channel >= 149 && channel <= 177)\n\t\tband = TSSI_ALIMK_5GH;\n\telse\n\t\tband = TSSI_ALIMK_2G;\n\n\tif (tssi_info->alignment_done[path][band]) {\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM1 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_value[path][band][0]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM3 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_value[path][band][1]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM2 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_value[path][band][2]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM4 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_value[path][band][3]);\n\t}\n\n\t_tssi_alimentk_dump_result(rtwdev, path);\n}\n\nstatic void _tssi_hw_tx(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\tenum rtw89_rf_path path, u16 cnt, u16 period, s16 pwr_dbm,\n\t\t\tu8 enable)\n{\n\tenum rtw89_rf_path_bit rx_path;\n\n\tif (path == RF_PATH_A)\n\t\trx_path = RF_A;\n\telse if (path == RF_PATH_B)\n\t\trx_path = RF_B;\n\telse if (path == RF_PATH_AB)\n\t\trx_path = RF_AB;\n\telse\n\t\trx_path = RF_ABCD;  \n\n\tif (enable) {\n\t\trtw8852b_bb_set_plcp_tx(rtwdev);\n\t\trtw8852b_bb_cfg_tx_path(rtwdev, path);\n\t\trtw8852b_bb_ctrl_rx_path(rtwdev, rx_path);\n\t\trtw8852b_bb_set_power(rtwdev, pwr_dbm, phy);\n\t}\n\n\trtw8852b_bb_set_pmac_pkt_tx(rtwdev, enable, cnt, period, 20, phy);\n}\n\nstatic void _tssi_backup_bb_registers(struct rtw89_dev *rtwdev,\n\t\t\t\t      enum rtw89_phy_idx phy, const u32 reg[],\n\t\t\t\t      u32 reg_backup[], u32 reg_num)\n{\n\tu32 i;\n\n\tfor (i = 0; i < reg_num; i++) {\n\t\treg_backup[i] = rtw89_phy_read32_mask(rtwdev, reg[i], MASKDWORD);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[TSSI] Backup BB 0x%x = 0x%x\\n\", reg[i],\n\t\t\t    reg_backup[i]);\n\t}\n}\n\nstatic void _tssi_reload_bb_registers(struct rtw89_dev *rtwdev,\n\t\t\t\t      enum rtw89_phy_idx phy, const u32 reg[],\n\t\t\t\t      u32 reg_backup[], u32 reg_num)\n\n{\n\tu32 i;\n\n\tfor (i = 0; i < reg_num; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, reg[i], MASKDWORD, reg_backup[i]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[TSSI] Reload BB 0x%x = 0x%x\\n\", reg[i],\n\t\t\t    reg_backup[i]);\n\t}\n}\n\nstatic u8 _tssi_ch_to_idx(struct rtw89_dev *rtwdev, u8 channel)\n{\n\tu8 channel_index;\n\n\tif (channel >= 1 && channel <= 14)\n\t\tchannel_index = channel - 1;\n\telse if (channel >= 36 && channel <= 64)\n\t\tchannel_index = (channel - 36) / 2 + 14;\n\telse if (channel >= 100 && channel <= 144)\n\t\tchannel_index = ((channel - 100) / 2) + 15 + 14;\n\telse if (channel >= 149 && channel <= 177)\n\t\tchannel_index = ((channel - 149) / 2) + 38 + 14;\n\telse\n\t\tchannel_index = 0;\n\n\treturn channel_index;\n}\n\nstatic bool _tssi_get_cw_report(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path, const s16 *power,\n\t\t\t\tu32 *tssi_cw_rpt)\n{\n\tu32 tx_counter, tx_counter_tmp;\n\tconst int retry = 100;\n\tu32 tmp;\n\tint j, k;\n\n\tfor (j = 0; j < RTW8852B_TSSI_PATH_NR; j++) {\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_trigger[path], B_P0_TSSI_EN, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_trigger[path], B_P0_TSSI_EN, 0x1);\n\n\t\ttx_counter = rtw89_phy_read32_mask(rtwdev, R_TX_COUNTER, MASKLWORD);\n\n\t\ttmp = rtw89_phy_read32_mask(rtwdev, _tssi_trigger[path], MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[TSSI PA K] 0x%x = 0x%08x   path=%d\\n\",\n\t\t\t    _tssi_trigger[path], tmp, path);\n\n\t\tif (j == 0)\n\t\t\t_tssi_hw_tx(rtwdev, phy, path, 100, 5000, power[j], true);\n\t\telse\n\t\t\t_tssi_hw_tx(rtwdev, phy, RF_PATH_ABCD, 100, 5000, power[j], true);\n\n\t\ttx_counter_tmp = rtw89_phy_read32_mask(rtwdev, R_TX_COUNTER, MASKLWORD);\n\t\ttx_counter_tmp -= tx_counter;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[TSSI PA K] First HWTXcounter=%d path=%d\\n\",\n\t\t\t    tx_counter_tmp, path);\n\n\t\tfor (k = 0; k < retry; k++) {\n\t\t\ttmp = rtw89_phy_read32_mask(rtwdev, _tssi_cw_rpt_addr[path],\n\t\t\t\t\t\t    B_TSSI_CWRPT_RDY);\n\t\t\tif (tmp)\n\t\t\t\tbreak;\n\n\t\t\tudelay(30);\n\n\t\t\ttx_counter_tmp =\n\t\t\t\trtw89_phy_read32_mask(rtwdev, R_TX_COUNTER, MASKLWORD);\n\t\t\ttx_counter_tmp -= tx_counter;\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t    \"[TSSI PA K] Flow k = %d HWTXcounter=%d path=%d\\n\",\n\t\t\t\t    k, tx_counter_tmp, path);\n\t\t}\n\n\t\tif (k >= retry) {\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t    \"[TSSI PA K] TSSI finish bit k > %d mp:100ms normal:30us path=%d\\n\",\n\t\t\t\t    k, path);\n\n\t\t\t_tssi_hw_tx(rtwdev, phy, path, 100, 5000, power[j], false);\n\t\t\treturn false;\n\t\t}\n\n\t\ttssi_cw_rpt[j] =\n\t\t\trtw89_phy_read32_mask(rtwdev, _tssi_cw_rpt_addr[path], B_TSSI_CWRPT);\n\n\t\t_tssi_hw_tx(rtwdev, phy, path, 100, 5000, power[j], false);\n\n\t\ttx_counter_tmp = rtw89_phy_read32_mask(rtwdev, R_TX_COUNTER, MASKLWORD);\n\t\ttx_counter_tmp -= tx_counter;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[TSSI PA K] Final HWTXcounter=%d path=%d\\n\",\n\t\t\t    tx_counter_tmp, path);\n\t}\n\n\treturn true;\n}\n\nstatic void _tssi_alimentk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t   enum rtw89_rf_path path)\n{\n\tstatic const u32 bb_reg[8] = {0x5820, 0x7820, 0x4978, 0x58e4,\n\t\t\t\t      0x78e4, 0x49c0, 0x0d18, 0x0d80};\n\tstatic const s16 power_2g[4] = {48, 20, 4, 4};\n\tstatic const s16 power_5g[4] = {48, 20, 4, 4};\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\ts32 tssi_alim_offset_1, tssi_alim_offset_2, tssi_alim_offset_3;\n\tu32 tssi_cw_rpt[RTW8852B_TSSI_PATH_NR] = {0};\n\tu8 channel = chan->channel;\n\tu8 ch_idx = _tssi_ch_to_idx(rtwdev, channel);\n\tstruct rtw8852b_bb_tssi_bak tssi_bak;\n\ts32 aliment_diff, tssi_cw_default;\n\tu32 start_time, finish_time;\n\tu32 bb_reg_backup[8] = {0};\n\tconst s16 *power;\n\tu8 band;\n\tbool ok;\n\tu32 tmp;\n\tu8 j;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======> %s   channel=%d   path=%d\\n\", __func__, channel,\n\t\t    path);\n\n\tif (tssi_info->check_backup_aligmk[path][ch_idx]) {\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM1 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_backup_by_ch[path][ch_idx][0]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM3 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_backup_by_ch[path][ch_idx][1]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM2 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_backup_by_ch[path][ch_idx][2]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM4 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_backup_by_ch[path][ch_idx][3]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"======> %s   Reload TSSI Alignment !!!\\n\", __func__);\n\t\t_tssi_alimentk_dump_result(rtwdev, path);\n\t\treturn;\n\t}\n\n\tstart_time = ktime_get_ns();\n\n\tif (chan->band_type == RTW89_BAND_2G)\n\t\tpower = power_2g;\n\telse\n\t\tpower = power_5g;\n\n\tif (channel >= 1 && channel <= 14)\n\t\tband = TSSI_ALIMK_2G;\n\telse if (channel >= 36 && channel <= 64)\n\t\tband = TSSI_ALIMK_5GL;\n\telse if (channel >= 100 && channel <= 144)\n\t\tband = TSSI_ALIMK_5GM;\n\telse if (channel >= 149 && channel <= 177)\n\t\tband = TSSI_ALIMK_5GH;\n\telse\n\t\tband = TSSI_ALIMK_2G;\n\n\trtw8852b_bb_backup_tssi(rtwdev, phy, &tssi_bak);\n\t_tssi_backup_bb_registers(rtwdev, phy, bb_reg, bb_reg_backup, ARRAY_SIZE(bb_reg_backup));\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_AVG, B_P0_TSSI_AVG, 0x8);\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_AVG, B_P1_TSSI_AVG, 0x8);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_MV_AVG, B_P0_TSSI_MV_AVG, 0x2);\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_MV_AVG, B_P1_TSSI_MV_AVG, 0x2);\n\n\tok = _tssi_get_cw_report(rtwdev, phy, path, power, tssi_cw_rpt);\n\tif (!ok)\n\t\tgoto out;\n\n\tfor (j = 0; j < RTW8852B_TSSI_PATH_NR; j++) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[TSSI PA K] power[%d]=%d  tssi_cw_rpt[%d]=%d\\n\", j,\n\t\t\t    power[j], j, tssi_cw_rpt[j]);\n\t}\n\n\ttmp = rtw89_phy_read32_mask(rtwdev, _tssi_cw_default_addr[path][1],\n\t\t\t\t    _tssi_cw_default_mask[1]);\n\ttssi_cw_default = sign_extend32(tmp, 8);\n\ttssi_alim_offset_1 = tssi_cw_rpt[0] - ((power[0] - power[1]) * 2) -\n\t\t\t     tssi_cw_rpt[1] + tssi_cw_default;\n\taliment_diff = tssi_alim_offset_1 - tssi_cw_default;\n\n\ttmp = rtw89_phy_read32_mask(rtwdev, _tssi_cw_default_addr[path][2],\n\t\t\t\t    _tssi_cw_default_mask[2]);\n\ttssi_cw_default = sign_extend32(tmp, 8);\n\ttssi_alim_offset_2 = tssi_cw_default + aliment_diff;\n\n\ttmp = rtw89_phy_read32_mask(rtwdev, _tssi_cw_default_addr[path][3],\n\t\t\t\t    _tssi_cw_default_mask[3]);\n\ttssi_cw_default = sign_extend32(tmp, 8);\n\ttssi_alim_offset_3 = tssi_cw_default + aliment_diff;\n\n\tif (path == RF_PATH_A) {\n\t\ttmp = FIELD_PREP(B_P1_TSSI_ALIM11, tssi_alim_offset_1) |\n\t\t      FIELD_PREP(B_P1_TSSI_ALIM12, tssi_alim_offset_2) |\n\t\t      FIELD_PREP(B_P1_TSSI_ALIM13, tssi_alim_offset_3);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM1, B_P0_TSSI_ALIM1, tmp);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM2, B_P0_TSSI_ALIM2, tmp);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[TSSI PA K] tssi_alim_offset = 0x%x   0x%x   0x%x   0x%x\\n\",\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM3, B_P0_TSSI_ALIM31),\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM1, B_P0_TSSI_ALIM11),\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM1, B_P0_TSSI_ALIM12),\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM1, B_P0_TSSI_ALIM13));\n\t} else {\n\t\ttmp = FIELD_PREP(B_P1_TSSI_ALIM11, tssi_alim_offset_1) |\n\t\t      FIELD_PREP(B_P1_TSSI_ALIM12, tssi_alim_offset_2) |\n\t\t      FIELD_PREP(B_P1_TSSI_ALIM13, tssi_alim_offset_3);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_ALIM1, B_P1_TSSI_ALIM1, tmp);\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_ALIM2, B_P1_TSSI_ALIM2, tmp);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[TSSI PA K] tssi_alim_offset = 0x%x   0x%x   0x%x   0x%x\\n\",\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_P1_TSSI_ALIM3, B_P1_TSSI_ALIM31),\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_P1_TSSI_ALIM1, B_P1_TSSI_ALIM11),\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_P1_TSSI_ALIM1, B_P1_TSSI_ALIM12),\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_P1_TSSI_ALIM1, B_P1_TSSI_ALIM13));\n\t}\n\n\ttssi_info->alignment_done[path][band] = true;\n\ttssi_info->alignment_value[path][band][0] =\n\t\trtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM1 + (path << 13), MASKDWORD);\n\ttssi_info->alignment_value[path][band][1] =\n\t\trtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM3 + (path << 13), MASKDWORD);\n\ttssi_info->alignment_value[path][band][2] =\n\t\trtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM2 + (path << 13), MASKDWORD);\n\ttssi_info->alignment_value[path][band][3] =\n\t\trtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM4 + (path << 13), MASKDWORD);\n\n\ttssi_info->check_backup_aligmk[path][ch_idx] = true;\n\ttssi_info->alignment_backup_by_ch[path][ch_idx][0] =\n\t\trtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM1 + (path << 13), MASKDWORD);\n\ttssi_info->alignment_backup_by_ch[path][ch_idx][1] =\n\t\trtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM3 + (path << 13), MASKDWORD);\n\ttssi_info->alignment_backup_by_ch[path][ch_idx][2] =\n\t\trtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM2 + (path << 13), MASKDWORD);\n\ttssi_info->alignment_backup_by_ch[path][ch_idx][3] =\n\t\trtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM4 + (path << 13), MASKDWORD);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[TSSI PA K] tssi_info->alignment_value[path=%d][band=%d][0], 0x%x = 0x%08x\\n\",\n\t\t    path, band, R_P0_TSSI_ALIM1 + (path << 13),\n\t\t    tssi_info->alignment_value[path][band][0]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[TSSI PA K] tssi_info->alignment_value[path=%d][band=%d][1], 0x%x = 0x%08x\\n\",\n\t\t    path, band, R_P0_TSSI_ALIM3 + (path << 13),\n\t\t    tssi_info->alignment_value[path][band][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[TSSI PA K] tssi_info->alignment_value[path=%d][band=%d][2], 0x%x = 0x%08x\\n\",\n\t\t    path, band, R_P0_TSSI_ALIM2 + (path << 13),\n\t\t    tssi_info->alignment_value[path][band][2]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[TSSI PA K] tssi_info->alignment_value[path=%d][band=%d][3], 0x%x = 0x%08x\\n\",\n\t\t    path, band, R_P0_TSSI_ALIM4 + (path << 13),\n\t\t    tssi_info->alignment_value[path][band][3]);\n\nout:\n\t_tssi_reload_bb_registers(rtwdev, phy, bb_reg, bb_reg_backup, ARRAY_SIZE(bb_reg_backup));\n\trtw8852b_bb_restore_tssi(rtwdev, phy, &tssi_bak);\n\trtw8852b_bb_tx_mode_switch(rtwdev, phy, 0);\n\n\tfinish_time = ktime_get_ns();\n\ttssi_info->tssi_alimk_time += finish_time - start_time;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[TSSI PA K] %s processing time = %d ms\\n\", __func__,\n\t\t    tssi_info->tssi_alimk_time);\n}\n\nvoid rtw8852b_dpk_init(struct rtw89_dev *rtwdev)\n{\n\t_set_dpd_backoff(rtwdev, RTW89_PHY_0);\n}\n\nvoid rtw8852b_rck(struct rtw89_dev *rtwdev)\n{\n\tu8 path;\n\n\tfor (path = 0; path < RF_PATH_NUM_8852B; path++)\n\t\t_rck(rtwdev, path);\n}\n\nvoid rtw8852b_dack(struct rtw89_dev *rtwdev)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, RTW89_PHY_0, 0);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_START);\n\t_dac_cal(rtwdev, false);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DACK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852b_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\tu32 tx_en;\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\t_iqk_init(rtwdev);\n\t_iqk(rtwdev, phy_idx, false);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852b_rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\tu32 tx_en;\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_RXDCK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\t_rx_dck(rtwdev, phy_idx);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_RXDCK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852b_dpk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\tu32 tx_en;\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\trtwdev->dpk.is_dpk_enable = true;\n\trtwdev->dpk.is_dpk_reload_en = false;\n\t_dpk(rtwdev, phy_idx, false);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_STOP);\n}\n\nvoid rtw8852b_dpk_track(struct rtw89_dev *rtwdev)\n{\n\t_dpk_track(rtwdev);\n}\n\nvoid rtw8852b_tssi(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy, bool hwtx_en)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy, RF_AB);\n\tu32 tx_en;\n\tu8 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI] %s: phy=%d\\n\", __func__, phy);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_START);\n\n\t_tssi_disable(rtwdev, phy);\n\n\tfor (i = RF_PATH_A; i < RF_PATH_NUM_8852B; i++) {\n\t\t_tssi_rf_setting(rtwdev, phy, i);\n\t\t_tssi_set_sys(rtwdev, phy, i);\n\t\t_tssi_ini_txpwr_ctrl_bb(rtwdev, phy, i);\n\t\t_tssi_ini_txpwr_ctrl_bb_he_tb(rtwdev, phy, i);\n\t\t_tssi_set_dck(rtwdev, phy, i);\n\t\t_tssi_set_tmeter_tbl(rtwdev, phy, i);\n\t\t_tssi_set_dac_gain_tbl(rtwdev, phy, i);\n\t\t_tssi_slope_cal_org(rtwdev, phy, i);\n\t\t_tssi_alignment_default(rtwdev, phy, i, true);\n\t\t_tssi_set_tssi_slope(rtwdev, phy, i);\n\n\t\trtw89_chip_stop_sch_tx(rtwdev, phy, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t\t_tmac_tx_pause(rtwdev, phy, true);\n\t\tif (hwtx_en)\n\t\t\t_tssi_alimentk(rtwdev, phy, i);\n\t\t_tmac_tx_pause(rtwdev, phy, false);\n\t\trtw89_chip_resume_sch_tx(rtwdev, phy, tx_en);\n\t}\n\n\t_tssi_enable(rtwdev, phy);\n\t_tssi_set_efuse_to_de(rtwdev, phy);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_STOP);\n}\n\nvoid rtw8852b_tssi_scan(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tu8 channel = chan->channel;\n\tu8 band;\n\tu32 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======>%s   phy=%d  channel=%d\\n\", __func__, phy, channel);\n\n\tif (channel >= 1 && channel <= 14)\n\t\tband = TSSI_ALIMK_2G;\n\telse if (channel >= 36 && channel <= 64)\n\t\tband = TSSI_ALIMK_5GL;\n\telse if (channel >= 100 && channel <= 144)\n\t\tband = TSSI_ALIMK_5GM;\n\telse if (channel >= 149 && channel <= 177)\n\t\tband = TSSI_ALIMK_5GH;\n\telse\n\t\tband = TSSI_ALIMK_2G;\n\n\t_tssi_disable(rtwdev, phy);\n\n\tfor (i = RF_PATH_A; i < RTW8852B_TSSI_PATH_NR; i++) {\n\t\t_tssi_rf_setting(rtwdev, phy, i);\n\t\t_tssi_set_sys(rtwdev, phy, i);\n\t\t_tssi_set_tmeter_tbl(rtwdev, phy, i);\n\n\t\tif (tssi_info->alignment_done[i][band])\n\t\t\t_tssi_alimentk_done(rtwdev, phy, i);\n\t\telse\n\t\t\t_tssi_alignment_default(rtwdev, phy, i, true);\n\t}\n\n\t_tssi_enable(rtwdev, phy);\n\t_tssi_set_efuse_to_de(rtwdev, phy);\n}\n\nstatic void rtw8852b_tssi_default_txagc(struct rtw89_dev *rtwdev,\n\t\t\t\t\tenum rtw89_phy_idx phy, bool enable)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 channel = chan->channel;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"======> %s   ch=%d\\n\",\n\t\t    __func__, channel);\n\n\tif (enable) {\n\t\tif (!rtwdev->is_tssi_mode[RF_PATH_A] && !rtwdev->is_tssi_mode[RF_PATH_B])\n\t\t\trtw8852b_tssi(rtwdev, phy, true);\n\t\treturn;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======>%s 1 SCAN_END Set 0x5818[7:0]=0x%x 0x7818[7:0]=0x%x\\n\",\n\t\t    __func__,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT));\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT, 0xc0);\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT,  0xc0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT_EN, 0x1);\n\n\t_tssi_alimentk_done(rtwdev, phy, RF_PATH_A);\n\t_tssi_alimentk_done(rtwdev, phy, RF_PATH_B);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======>%s 2 SCAN_END Set 0x5818[7:0]=0x%x 0x7818[7:0]=0x%x\\n\",\n\t\t    __func__,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P1_TSSI_TRK, B_P1_TSSI_OFT));\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======> %s   SCAN_END\\n\", __func__);\n}\n\nvoid rtw8852b_wifi_scan_notify(struct rtw89_dev *rtwdev, bool scan_start,\n\t\t\t       enum rtw89_phy_idx phy_idx)\n{\n\tif (scan_start)\n\t\trtw8852b_tssi_default_txagc(rtwdev, phy_idx, true);\n\telse\n\t\trtw8852b_tssi_default_txagc(rtwdev, phy_idx, false);\n}\n\nstatic void _bw_setting(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t\tenum rtw89_bandwidth bw, bool dav)\n{\n\tu32 rf_reg18;\n\tu32 reg18_addr = dav ? RR_CFGCH : RR_CFGCH_V1;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]===> %s\\n\", __func__);\n\n\trf_reg18 = rtw89_read_rf(rtwdev, path, reg18_addr, RFREG_MASK);\n\tif (rf_reg18 == INV_RF_DATA) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK]Invalid RF_0x18 for Path-%d\\n\", path);\n\t\treturn;\n\t}\n\trf_reg18 &= ~RR_CFGCH_BW;\n\n\tswitch (bw) {\n\tcase RTW89_CHANNEL_WIDTH_5:\n\tcase RTW89_CHANNEL_WIDTH_10:\n\tcase RTW89_CHANNEL_WIDTH_20:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BW, CFGCH_BW_20M);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_40:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BW, CFGCH_BW_40M);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_80:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BW, CFGCH_BW_80M);\n\t\tbreak;\n\tdefault:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]Fail to set CH\\n\");\n\t}\n\n\trf_reg18 &= ~(RR_CFGCH_POW_LCK | RR_CFGCH_TRX_AH | RR_CFGCH_BCN |\n\t\t      RR_CFGCH_BW2) & RFREG_MASK;\n\trf_reg18 |= RR_CFGCH_BW2;\n\trtw89_write_rf(rtwdev, path, reg18_addr, RFREG_MASK, rf_reg18);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK] set %x at path%d, %x =0x%x\\n\",\n\t\t    bw, path, reg18_addr,\n\t\t    rtw89_read_rf(rtwdev, path, reg18_addr, RFREG_MASK));\n}\n\nstatic void _ctrl_bw(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t     enum rtw89_bandwidth bw)\n{\n\t_bw_setting(rtwdev, RF_PATH_A, bw, true);\n\t_bw_setting(rtwdev, RF_PATH_B, bw, true);\n\t_bw_setting(rtwdev, RF_PATH_A, bw, false);\n\t_bw_setting(rtwdev, RF_PATH_B, bw, false);\n}\n\nstatic bool _set_s0_arfc18(struct rtw89_dev *rtwdev, u32 val)\n{\n\tu32 bak;\n\tu32 tmp;\n\tint ret;\n\n\tbak = rtw89_read_rf(rtwdev, RF_PATH_A, RR_LDO, RFREG_MASK);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LDO, RR_LDO_SEL, 0x1);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_CFGCH, RFREG_MASK, val);\n\n\tret = read_poll_timeout_atomic(rtw89_read_rf, tmp, tmp == 0, 1, 1000,\n\t\t\t\t       false, rtwdev, RF_PATH_A, RR_LPF, RR_LPF_BUSY);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]LCK timeout\\n\");\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LDO, RFREG_MASK, bak);\n\n\treturn !!ret;\n}\n\nstatic void _lck_check(struct rtw89_dev *rtwdev)\n{\n\tu32 tmp;\n\n\tif (rtw89_read_rf(rtwdev, RF_PATH_A, RR_SYNFB, RR_SYNFB_LK) == 0) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]SYN MMD reset\\n\");\n\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MMD, RR_MMD_RST_EN, 0x1);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MMD, RR_MMD_RST_SYN, 0x0);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MMD, RR_MMD_RST_SYN, 0x1);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MMD, RR_MMD_RST_EN, 0x0);\n\t}\n\n\tudelay(10);\n\n\tif (rtw89_read_rf(rtwdev, RF_PATH_A, RR_SYNFB, RR_SYNFB_LK) == 0) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]re-set RF 0x18\\n\");\n\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RR_LCK_TRGSEL, 0x1);\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_A, RR_CFGCH, RFREG_MASK);\n\t\t_set_s0_arfc18(rtwdev, tmp);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RR_LCK_TRGSEL, 0x0);\n\t}\n\n\tif (rtw89_read_rf(rtwdev, RF_PATH_A, RR_SYNFB, RR_SYNFB_LK) == 0) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]SYN off/on\\n\");\n\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_A, RR_POW, RFREG_MASK);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_POW, RFREG_MASK, tmp);\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_A, RR_SX, RFREG_MASK);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_SX, RFREG_MASK, tmp);\n\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_SYNLUT, RR_SYNLUT_MOD, 0x1);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_POW, RR_POW_SYN, 0x0);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_POW, RR_POW_SYN, 0x3);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_SYNLUT, RR_SYNLUT_MOD, 0x0);\n\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RR_LCK_TRGSEL, 0x1);\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_A, RR_CFGCH, RFREG_MASK);\n\t\t_set_s0_arfc18(rtwdev, tmp);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RR_LCK_TRGSEL, 0x0);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]0xb2=%x, 0xc5=%x\\n\",\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_VCO, RFREG_MASK),\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_SYNFB, RFREG_MASK));\n\t}\n}\n\nstatic void _set_ch(struct rtw89_dev *rtwdev, u32 val)\n{\n\tbool timeout;\n\n\ttimeout = _set_s0_arfc18(rtwdev, val);\n\tif (!timeout)\n\t\t_lck_check(rtwdev);\n}\n\nstatic void _ch_setting(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t\tu8 central_ch, bool dav)\n{\n\tu32 reg18_addr = dav ? RR_CFGCH : RR_CFGCH_V1;\n\tbool is_2g_ch = central_ch <= 14;\n\tu32 rf_reg18;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]===> %s\\n\", __func__);\n\n\trf_reg18 = rtw89_read_rf(rtwdev, path, reg18_addr, RFREG_MASK);\n\trf_reg18 &= ~(RR_CFGCH_BAND1 | RR_CFGCH_POW_LCK | RR_CFGCH_TRX_AH |\n\t\t      RR_CFGCH_BCN | RR_CFGCH_BAND0 | RR_CFGCH_CH);\n\trf_reg18 |= FIELD_PREP(RR_CFGCH_CH, central_ch);\n\n\tif (!is_2g_ch)\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BAND1, CFGCH_BAND1_5G) |\n\t\t\t    FIELD_PREP(RR_CFGCH_BAND0, CFGCH_BAND0_5G);\n\n\trf_reg18 &= ~(RR_CFGCH_POW_LCK | RR_CFGCH_TRX_AH | RR_CFGCH_BCN |\n\t\t      RR_CFGCH_BW2) & RFREG_MASK;\n\trf_reg18 |= RR_CFGCH_BW2;\n\n\tif (path == RF_PATH_A && dav)\n\t\t_set_ch(rtwdev, rf_reg18);\n\telse\n\t\trtw89_write_rf(rtwdev, path, reg18_addr, RFREG_MASK, rf_reg18);\n\n\trtw89_write_rf(rtwdev, path, RR_LCKST, RR_LCKST_BIN, 0);\n\trtw89_write_rf(rtwdev, path, RR_LCKST, RR_LCKST_BIN, 1);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RFK]CH: %d for Path-%d, reg0x%x = 0x%x\\n\",\n\t\t    central_ch, path, reg18_addr,\n\t\t    rtw89_read_rf(rtwdev, path, reg18_addr, RFREG_MASK));\n}\n\nstatic void _ctrl_ch(struct rtw89_dev *rtwdev, u8 central_ch)\n{\n\t_ch_setting(rtwdev, RF_PATH_A, central_ch, true);\n\t_ch_setting(rtwdev, RF_PATH_B, central_ch, true);\n\t_ch_setting(rtwdev, RF_PATH_A, central_ch, false);\n\t_ch_setting(rtwdev, RF_PATH_B, central_ch, false);\n}\n\nstatic void _set_rxbb_bw(struct rtw89_dev *rtwdev, enum rtw89_bandwidth bw,\n\t\t\t enum rtw89_rf_path path)\n{\n\trtw89_write_rf(rtwdev, path, RR_LUTWE2, RR_LUTWE2_RTXBW, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_LUTWA, RR_LUTWA_M2, 0x12);\n\n\tif (bw == RTW89_CHANNEL_WIDTH_20)\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB, 0x1b);\n\telse if (bw == RTW89_CHANNEL_WIDTH_40)\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB, 0x13);\n\telse if (bw == RTW89_CHANNEL_WIDTH_80)\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB, 0xb);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB, 0x3);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK] set S%d RXBB BW 0x3F = 0x%x\\n\", path,\n\t\t    rtw89_read_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB));\n\n\trtw89_write_rf(rtwdev, path, RR_LUTWE2, RR_LUTWE2_RTXBW, 0x0);\n}\n\nstatic void _rxbb_bw(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t     enum rtw89_bandwidth bw)\n{\n\tu8 kpath, path;\n\n\tkpath = _kpath(rtwdev, phy);\n\n\tfor (path = 0; path < RF_PATH_NUM_8852B; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\t_set_rxbb_bw(rtwdev, bw, path);\n\t}\n}\n\nstatic void rtw8852b_ctrl_bw_ch(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_phy_idx phy, u8 central_ch,\n\t\t\t\tenum rtw89_band band, enum rtw89_bandwidth bw)\n{\n\t_ctrl_ch(rtwdev, central_ch);\n\t_ctrl_bw(rtwdev, phy, bw);\n\t_rxbb_bw(rtwdev, phy, bw);\n}\n\nvoid rtw8852b_set_channel_rf(struct rtw89_dev *rtwdev,\n\t\t\t     const struct rtw89_chan *chan,\n\t\t\t     enum rtw89_phy_idx phy_idx)\n{\n\trtw8852b_ctrl_bw_ch(rtwdev, phy_idx, chan->channel, chan->band_type,\n\t\t\t    chan->band_width);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}