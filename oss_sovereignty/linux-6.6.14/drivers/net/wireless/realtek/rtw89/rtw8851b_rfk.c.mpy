{
  "module_name": "rtw8851b_rfk.c",
  "hash_id": "ede87659755915a5990602620e0a169806ac8344fb9eafc93d3379ceab04af36",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtw89/rtw8851b_rfk.c",
  "human_readable_source": "\n \n\n#include \"coex.h\"\n#include \"debug.h\"\n#include \"mac.h\"\n#include \"phy.h\"\n#include \"reg.h\"\n#include \"rtw8851b.h\"\n#include \"rtw8851b_rfk.h\"\n#include \"rtw8851b_rfk_table.h\"\n#include \"rtw8851b_table.h\"\n\n#define DPK_VER_8851B 0x5\n#define DPK_KIP_REG_NUM_8851B 7\n#define DPK_RF_REG_NUM_8851B 4\n#define DPK_KSET_NUM 4\n#define RTW8851B_RXK_GROUP_NR 4\n#define RTW8851B_RXK_GROUP_IDX_NR 2\n#define RTW8851B_TXK_GROUP_NR 1\n#define RTW8851B_IQK_VER 0x2a\n#define RTW8851B_IQK_SS 1\n#define RTW8851B_LOK_GRAM 10\n#define RTW8851B_TSSI_PATH_NR 1\n\n#define _TSSI_DE_MASK GENMASK(21, 12)\n\nenum dpk_id {\n\tLBK_RXIQK\t= 0x06,\n\tSYNC\t\t= 0x10,\n\tMDPK_IDL\t= 0x11,\n\tMDPK_MPA\t= 0x12,\n\tGAIN_LOSS\t= 0x13,\n\tGAIN_CAL\t= 0x14,\n\tDPK_RXAGC\t= 0x15,\n\tKIP_PRESET\t= 0x16,\n\tKIP_RESTORE\t= 0x17,\n\tDPK_TXAGC\t= 0x19,\n\tD_KIP_PRESET\t= 0x28,\n\tD_TXAGC\t\t= 0x29,\n\tD_RXAGC\t\t= 0x2a,\n\tD_SYNC\t\t= 0x2b,\n\tD_GAIN_LOSS\t= 0x2c,\n\tD_MDPK_IDL\t= 0x2d,\n\tD_MDPK_LDL\t= 0x2e,\n\tD_GAIN_NORM\t= 0x2f,\n\tD_KIP_THERMAL\t= 0x30,\n\tD_KIP_RESTORE\t= 0x31\n};\n\nenum dpk_agc_step {\n\tDPK_AGC_STEP_SYNC_DGAIN,\n\tDPK_AGC_STEP_GAIN_LOSS_IDX,\n\tDPK_AGC_STEP_GL_GT_CRITERION,\n\tDPK_AGC_STEP_GL_LT_CRITERION,\n\tDPK_AGC_STEP_SET_TX_GAIN,\n};\n\nenum rtw8851b_iqk_type {\n\tID_TXAGC = 0x0,\n\tID_FLOK_COARSE = 0x1,\n\tID_FLOK_FINE = 0x2,\n\tID_TXK = 0x3,\n\tID_RXAGC = 0x4,\n\tID_RXK = 0x5,\n\tID_NBTXK = 0x6,\n\tID_NBRXK = 0x7,\n\tID_FLOK_VBUFFER = 0x8,\n\tID_A_FLOK_COARSE = 0x9,\n\tID_G_FLOK_COARSE = 0xa,\n\tID_A_FLOK_FINE = 0xb,\n\tID_G_FLOK_FINE = 0xc,\n\tID_IQK_RESTORE = 0x10,\n};\n\nenum rf_mode {\n\tRF_SHUT_DOWN = 0x0,\n\tRF_STANDBY = 0x1,\n\tRF_TX = 0x2,\n\tRF_RX = 0x3,\n\tRF_TXIQK = 0x4,\n\tRF_DPK = 0x5,\n\tRF_RXK1 = 0x6,\n\tRF_RXK2 = 0x7,\n};\n\nstatic const u32 _tssi_de_cck_long[RF_PATH_NUM_8851B] = {0x5858};\nstatic const u32 _tssi_de_cck_short[RF_PATH_NUM_8851B] = {0x5860};\nstatic const u32 _tssi_de_mcs_20m[RF_PATH_NUM_8851B] = {0x5838};\nstatic const u32 _tssi_de_mcs_40m[RF_PATH_NUM_8851B] = {0x5840};\nstatic const u32 _tssi_de_mcs_80m[RF_PATH_NUM_8851B] = {0x5848};\nstatic const u32 _tssi_de_mcs_80m_80m[RF_PATH_NUM_8851B] = {0x5850};\nstatic const u32 _tssi_de_mcs_5m[RF_PATH_NUM_8851B] = {0x5828};\nstatic const u32 _tssi_de_mcs_10m[RF_PATH_NUM_8851B] = {0x5830};\nstatic const u32 g_idxrxgain[RTW8851B_RXK_GROUP_NR] = {0x10e, 0x116, 0x28e, 0x296};\nstatic const u32 g_idxattc2[RTW8851B_RXK_GROUP_NR] = {0x0, 0xf, 0x0, 0xf};\nstatic const u32 g_idxrxagc[RTW8851B_RXK_GROUP_NR] = {0x0, 0x1, 0x2, 0x3};\nstatic const u32 a_idxrxgain[RTW8851B_RXK_GROUP_IDX_NR] = {0x10C, 0x28c};\nstatic const u32 a_idxattc2[RTW8851B_RXK_GROUP_IDX_NR] = {0xf, 0xf};\nstatic const u32 a_idxrxagc[RTW8851B_RXK_GROUP_IDX_NR] = {0x4, 0x6};\nstatic const u32 a_power_range[RTW8851B_TXK_GROUP_NR] = {0x0};\nstatic const u32 a_track_range[RTW8851B_TXK_GROUP_NR] = {0x6};\nstatic const u32 a_gain_bb[RTW8851B_TXK_GROUP_NR] = {0x0a};\nstatic const u32 a_itqt[RTW8851B_TXK_GROUP_NR] = {0x12};\nstatic const u32 g_power_range[RTW8851B_TXK_GROUP_NR] = {0x0};\nstatic const u32 g_track_range[RTW8851B_TXK_GROUP_NR] = {0x6};\nstatic const u32 g_gain_bb[RTW8851B_TXK_GROUP_NR] = {0x10};\nstatic const u32 g_itqt[RTW8851B_TXK_GROUP_NR] = {0x12};\n\nstatic const u32 rtw8851b_backup_bb_regs[] = {0xc0d4, 0xc0d8, 0xc0c4, 0xc0ec, 0xc0e8};\nstatic const u32 rtw8851b_backup_rf_regs[] = {\n\t0xef, 0xde, 0x0, 0x1e, 0x2, 0x85, 0x90, 0x5};\n\n#define BACKUP_BB_REGS_NR ARRAY_SIZE(rtw8851b_backup_bb_regs)\n#define BACKUP_RF_REGS_NR ARRAY_SIZE(rtw8851b_backup_rf_regs)\n\nstatic const u32 dpk_kip_reg[DPK_KIP_REG_NUM_8851B] = {\n\t0x813c, 0x8124, 0xc0ec, 0xc0e8, 0xc0c4, 0xc0d4, 0xc0d8};\nstatic const u32 dpk_rf_reg[DPK_RF_REG_NUM_8851B] = {0xde, 0x8f, 0x5, 0x10005};\n\nstatic void _set_ch(struct rtw89_dev *rtwdev, u32 val);\n\nstatic u8 _rxk_5ghz_group_from_idx(u8 idx)\n{\n\t \n\tif (idx < RTW8851B_RXK_GROUP_IDX_NR)\n\t\treturn idx * 2;\n\n\treturn 0;\n}\n\nstatic u8 _kpath(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\treturn RF_A;\n}\n\nstatic void _adc_fifo_rst(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t  u8 path)\n{\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RXK, 0x0101);\n\tfsleep(10);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, B_ADC_FIFO_RXK, 0x1111);\n}\n\nstatic void _rfk_rf_direct_cntrl(struct rtw89_dev *rtwdev,\n\t\t\t\t enum rtw89_rf_path path, bool is_bybb)\n{\n\tif (is_bybb)\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x1);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n}\n\nstatic void _rfk_drf_direct_cntrl(struct rtw89_dev *rtwdev,\n\t\t\t\t  enum rtw89_rf_path path, bool is_bybb)\n{\n\tif (is_bybb)\n\t\trtw89_write_rf(rtwdev, path, RR_BBDC, RR_BBDC_SEL, 0x1);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_BBDC, RR_BBDC_SEL, 0x0);\n}\n\nstatic void _wait_rx_mode(struct rtw89_dev *rtwdev, u8 kpath)\n{\n\tu32 rf_mode;\n\tu8 path;\n\tint ret;\n\n\tfor (path = 0; path < RF_PATH_MAX; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\tret = read_poll_timeout_atomic(rtw89_read_rf, rf_mode,\n\t\t\t\t\t       rf_mode != 2, 2, 5000, false,\n\t\t\t\t\t       rtwdev, path, 0x00, RR_MOD_MASK);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK] Wait S%d to Rx mode!! (ret = %d)\\n\",\n\t\t\t    path, ret);\n\t}\n}\n\nstatic void _dack_reset(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\trtw89_phy_write32_mask(rtwdev, R_DCOF0, B_DCOF0_RST, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DCOF0, B_DCOF0_RST, 0x1);\n}\n\nstatic void _drck(struct rtw89_dev *rtwdev)\n{\n\tu32 rck_d;\n\tu32 val;\n\tint ret;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]Ddie RCK start!!!\\n\");\n\n\trtw89_phy_write32_mask(rtwdev, R_DRCK, B_DRCK_IDLE, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK, B_DRCK_EN, 0x1);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val,\n\t\t\t\t       1, 10000, false,\n\t\t\t\t       rtwdev, R_DRCK_RES, B_DRCK_POL);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DRCK timeout\\n\");\n\n\trtw89_phy_write32_mask(rtwdev, R_DRCK, B_DRCK_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK_FH, B_DRCK_LAT, 0x1);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK_FH, B_DRCK_LAT, 0x0);\n\n\trck_d = rtw89_phy_read32_mask(rtwdev, R_DRCK_RES, 0x7c00);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK, B_DRCK_IDLE, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DRCK, B_DRCK_VAL, rck_d);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0xc0c4 = 0x%x\\n\",\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DRCK, MASKDWORD));\n}\n\nstatic void _addck_backup(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0, 0x0);\n\n\tdack->addck_d[0][0] = rtw89_phy_read32_mask(rtwdev, R_ADDCKR0, B_ADDCKR0_A0);\n\tdack->addck_d[0][1] = rtw89_phy_read32_mask(rtwdev, R_ADDCKR0, B_ADDCKR0_A1);\n}\n\nstatic void _addck_reload(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0_RL, B_ADDCK0_RL1, dack->addck_d[0][0]);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0_RL, B_ADDCK0_RL0, dack->addck_d[0][1]);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0_RL, B_ADDCK0_RLS, 0x3);\n}\n\nstatic void _dack_backup_s0(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x1);\n\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DCOF0, B_DCOF0_V, i);\n\t\tdack->msbk_d[0][0][i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_DACK_S0P2, B_DACK_S0M0);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_DCOF8, B_DCOF8_V, i);\n\t\tdack->msbk_d[0][1][i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_DACK_S0P3, B_DACK_S0M1);\n\t}\n\n\tdack->biask_d[0][0] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_BIAS00, B_DACK_BIAS00);\n\tdack->biask_d[0][1] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_BIAS01, B_DACK_BIAS01);\n\tdack->dadck_d[0][0] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_DADCK00, B_DACK_DADCK00) + 24;\n\tdack->dadck_d[0][1] =\n\t\trtw89_phy_read32_mask(rtwdev, R_DACK_DADCK01, B_DACK_DADCK01) + 24;\n}\n\nstatic void _dack_reload_by_path(struct rtw89_dev *rtwdev,\n\t\t\t\t enum rtw89_rf_path path, u8 index)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 idx_offset, path_offset;\n\tu32 offset, reg;\n\tu32 tmp;\n\tu8 i;\n\n\tif (index == 0)\n\t\tidx_offset = 0;\n\telse\n\t\tidx_offset = 0x14;\n\n\tif (path == RF_PATH_A)\n\t\tpath_offset = 0;\n\telse\n\t\tpath_offset = 0x28;\n\n\toffset = idx_offset + path_offset;\n\n\trtw89_phy_write32_mask(rtwdev, R_DCOF1, B_DCOF1_RST, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_DCOF9, B_DCOF9_RST, 0x1);\n\n\t \n\ttmp = 0x0;\n\tfor (i = 0; i < 4; i++)\n\t\ttmp |= dack->msbk_d[path][index][i + 12] << (i * 8);\n\treg = 0xc200 + offset;\n\trtw89_phy_write32(rtwdev, reg, tmp);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", reg,\n\t\t    rtw89_phy_read32_mask(rtwdev, reg, MASKDWORD));\n\n\t \n\ttmp = 0x0;\n\tfor (i = 0; i < 4; i++)\n\t\ttmp |= dack->msbk_d[path][index][i + 8] << (i * 8);\n\treg = 0xc204 + offset;\n\trtw89_phy_write32(rtwdev, reg, tmp);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", reg,\n\t\t    rtw89_phy_read32_mask(rtwdev, reg, MASKDWORD));\n\n\t \n\ttmp = 0x0;\n\tfor (i = 0; i < 4; i++)\n\t\ttmp |= dack->msbk_d[path][index][i + 4] << (i * 8);\n\treg = 0xc208 + offset;\n\trtw89_phy_write32(rtwdev, reg, tmp);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", reg,\n\t\t    rtw89_phy_read32_mask(rtwdev, reg, MASKDWORD));\n\n\t \n\ttmp = 0x0;\n\tfor (i = 0; i < 4; i++)\n\t\ttmp |= dack->msbk_d[path][index][i] << (i * 8);\n\treg = 0xc20c + offset;\n\trtw89_phy_write32(rtwdev, reg, tmp);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", reg,\n\t\t    rtw89_phy_read32_mask(rtwdev, reg, MASKDWORD));\n\n\t \n\ttmp = 0x0;\n\ttmp = (dack->biask_d[path][index] << 22) |\n\t      (dack->dadck_d[path][index] << 14);\n\treg = 0xc210 + offset;\n\trtw89_phy_write32(rtwdev, reg, tmp);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x=0x%x\\n\", reg,\n\t\t    rtw89_phy_read32_mask(rtwdev, reg, MASKDWORD));\n\n\trtw89_phy_write32_mask(rtwdev, R_DACKN0_CTL + offset, B_DACKN0_EN, 0x1);\n}\n\nstatic void _dack_reload(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\tu8 index;\n\n\tfor (index = 0; index < 2; index++)\n\t\t_dack_reload_by_path(rtwdev, path, index);\n}\n\nstatic void _addck(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 val;\n\tint ret;\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_RST, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_EN, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_EN, 0x0);\n\tudelay(1);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0, 0x1);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val,\n\t\t\t\t       1, 10000, false,\n\t\t\t\t       rtwdev, R_ADDCKR0, BIT(0));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 ADDCK timeout\\n\");\n\t\tdack->addck_timeout[0] = true;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]ADDCK ret = %d\\n\", ret);\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_RST, 0x0);\n}\n\nstatic void _new_dadck(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 i_dc, q_dc, ic, qc;\n\tu32 val;\n\tint ret;\n\n\trtw89_rfk_parser(rtwdev, &rtw8851b_dadck_setup_defs_tbl);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val,\n\t\t\t\t       1, 10000, false,\n\t\t\t\t       rtwdev, R_ADDCKR0, BIT(0));\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 DADCK timeout\\n\");\n\t\tdack->addck_timeout[0] = true;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DADCK ret = %d\\n\", ret);\n\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_IQ, 0x0);\n\ti_dc = rtw89_phy_read32_mask(rtwdev, R_ADDCKR0, B_ADDCKR0_DC);\n\trtw89_phy_write32_mask(rtwdev, R_ADDCK0, B_ADDCK0_IQ, 0x1);\n\tq_dc = rtw89_phy_read32_mask(rtwdev, R_ADDCKR0, B_ADDCKR0_DC);\n\n\tic = 0x80 - sign_extend32(i_dc, 11) * 6;\n\tqc = 0x80 - sign_extend32(q_dc, 11) * 6;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]before DADCK, i_dc=0x%x, q_dc=0x%x\\n\", i_dc, q_dc);\n\n\tdack->dadck_d[0][0] = ic;\n\tdack->dadck_d[0][1] = qc;\n\n\trtw89_phy_write32_mask(rtwdev, R_DACKN0_CTL, B_DACKN0_V, dack->dadck_d[0][0]);\n\trtw89_phy_write32_mask(rtwdev, R_DACKN1_CTL, B_DACKN1_V, dack->dadck_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DACK]after DADCK, 0xc210=0x%x, 0xc224=0x%x\\n\",\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACKN0_CTL, MASKDWORD),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_DACKN1_CTL, MASKDWORD));\n\n\trtw89_rfk_parser(rtwdev, &rtw8851b_dadck_post_defs_tbl);\n}\n\nstatic bool _dack_s0_poll(struct rtw89_dev *rtwdev)\n{\n\tif (rtw89_phy_read32_mask(rtwdev, R_DACK_S0P0, B_DACK_S0P0_OK) == 0 ||\n\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S0P1, B_DACK_S0P1_OK) == 0 ||\n\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S0P2, B_DACK_S0P2_OK) == 0 ||\n\t    rtw89_phy_read32_mask(rtwdev, R_DACK_S0P3, B_DACK_S0P3_OK) == 0)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic void _dack_s0(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tbool done;\n\tint ret;\n\n\trtw89_rfk_parser(rtwdev, &rtw8851b_dack_s0_1_defs_tbl);\n\t_dack_reset(rtwdev, RF_PATH_A);\n\trtw89_phy_write32_mask(rtwdev, R_DCOF1, B_DCOF1_S, 0x1);\n\n\tret = read_poll_timeout_atomic(_dack_s0_poll, done, done,\n\t\t\t\t       1, 10000, false, rtwdev);\n\tif (ret) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 DACK timeout\\n\");\n\t\tdack->msbk_timeout[0] = true;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK ret = %d\\n\", ret);\n\n\trtw89_rfk_parser(rtwdev, &rtw8851b_dack_s0_2_defs_tbl);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]after S0 DADCK\\n\");\n\n\t_dack_backup_s0(rtwdev);\n\t_dack_reload(rtwdev, RF_PATH_A);\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW, B_P0_NRBW_DBG, 0x0);\n}\n\nstatic void _dack(struct rtw89_dev *rtwdev)\n{\n\t_dack_s0(rtwdev);\n}\n\nstatic void _dack_dump(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu8 i;\n\tu8 t;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 ADC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->addck_d[0][0], dack->addck_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 DAC_DCK ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->dadck_d[0][0], dack->dadck_d[0][1]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 biask ic = 0x%x, qc = 0x%x\\n\",\n\t\t    dack->biask_d[0][0], dack->biask_d[0][1]);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 MSBK ic:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[0][0][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]S0 MSBK qc:\\n\");\n\tfor (i = 0; i < RTW89_DACK_MSBK_NR; i++) {\n\t\tt = dack->msbk_d[0][1][i];\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]0x%x\\n\", t);\n\t}\n}\n\nstatic void _dack_manual_off(struct rtw89_dev *rtwdev)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8851b_dack_manual_off_defs_tbl);\n}\n\nstatic void _dac_cal(struct rtw89_dev *rtwdev, bool force)\n{\n\tstruct rtw89_dack_info *dack = &rtwdev->dack;\n\tu32 rf0_0;\n\n\tdack->dack_done = false;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK 0x2\\n\");\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK start!!!\\n\");\n\trf0_0 = rtw89_read_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]RF0=0x%x\\n\", rf0_0);\n\n\t_drck(rtwdev);\n\t_dack_manual_off(rtwdev);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK, 0x337e1);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RR_RSV1_RST, 0x0);\n\n\t_addck(rtwdev);\n\t_addck_backup(rtwdev);\n\t_addck_reload(rtwdev);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RFREG_MASK, 0x40001);\n\n\t_dack(rtwdev);\n\t_new_dadck(rtwdev);\n\t_dack_dump(rtwdev);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RR_RSV1_RST, 0x1);\n\n\tdack->dack_done = true;\n\tdack->dack_cnt++;\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DACK]DACK finish!!!\\n\");\n}\n\nstatic void _rx_dck_info(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t enum rtw89_rf_path path, bool is_afe)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RX_DCK] ==== S%d RX DCK (%s / CH%d / %s / by %s)====\\n\", path,\n\t\t    chan->band_type == RTW89_BAND_2G ? \"2G\" :\n\t\t    chan->band_type == RTW89_BAND_5G ? \"5G\" : \"6G\",\n\t\t    chan->channel,\n\t\t    chan->band_width == RTW89_CHANNEL_WIDTH_20 ? \"20M\" :\n\t\t    chan->band_width == RTW89_CHANNEL_WIDTH_40 ? \"40M\" : \"80M\",\n\t\t    is_afe ? \"AFE\" : \"RFC\");\n}\n\nstatic void _rxbb_ofst_swap(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 rf_mode)\n{\n\tu32 val, val_i, val_q;\n\n\tval_i = rtw89_read_rf(rtwdev, path, RR_DCK, RR_DCK_S1);\n\tval_q = rtw89_read_rf(rtwdev, path, RR_DCK1, RR_DCK1_S1);\n\n\tval = val_q << 4 | val_i;\n\n\trtw89_write_rf(rtwdev, path, RR_LUTWE2, RR_LUTWE2_DIS, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_LUTWA, RFREG_MASK, rf_mode);\n\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RFREG_MASK, val);\n\trtw89_write_rf(rtwdev, path, RR_LUTWE2, RR_LUTWE2_DIS, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RX_DCK] val_i = 0x%x, val_q = 0x%x, 0x3F = 0x%x\\n\",\n\t\t    val_i, val_q, val);\n}\n\nstatic void _set_rx_dck(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 rf_mode)\n{\n\tu32 val;\n\tint ret;\n\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x1);\n\n\tret = read_poll_timeout_atomic(rtw89_read_rf, val, val,\n\t\t\t\t       2, 2000, false,\n\t\t\t\t       rtwdev, path, RR_DCK, BIT(8));\n\n\trtw89_write_rf(rtwdev, path, RR_DCK, RR_DCK_LV, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RX_DCK] S%d RXDCK finish (ret = %d)\\n\",\n\t\t    path, ret);\n\n\t_rxbb_ofst_swap(rtwdev, path, rf_mode);\n}\n\nstatic void _rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy, bool is_afe)\n{\n\tu32 rf_reg5;\n\tu8 path;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RX_DCK] ****** RXDCK Start (Ver: 0x%x, Cv: %d) ******\\n\",\n\t\t    0x2, rtwdev->hal.cv);\n\n\tfor (path = 0; path < RF_PATH_NUM_8851B; path++) {\n\t\t_rx_dck_info(rtwdev, phy, path, is_afe);\n\n\t\trf_reg5 = rtw89_read_rf(rtwdev, path, RR_RSV1, RFREG_MASK);\n\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_P0_TSSI_TRK + (path << 13),\n\t\t\t\t\t       B_P0_TSSI_TRK_EN, 0x1);\n\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RF_RX);\n\t\t_set_rx_dck(rtwdev, path, RF_RX);\n\t\trtw89_write_rf(rtwdev, path, RR_RSV1, RFREG_MASK, rf_reg5);\n\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_P0_TSSI_TRK + (path << 13),\n\t\t\t\t\t       B_P0_TSSI_TRK_EN, 0x0);\n\t}\n}\n\nstatic void _iqk_sram(struct rtw89_dev *rtwdev, u8 path)\n{\n\tu32 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKDWORD, 0x00020000);\n\trtw89_phy_write32_mask(rtwdev, R_MDPK_RX_DCK, MASKDWORD, 0x80000000);\n\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX2, MASKDWORD, 0x00000080);\n\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX, MASKDWORD, 0x00010000);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x009);\n\n\tfor (i = 0; i <= 0x9f; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX, MASKDWORD,\n\t\t\t\t       0x00010000 + i);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]0x%x\\n\",\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCI));\n\t}\n\n\tfor (i = 0; i <= 0x9f; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX, MASKDWORD,\n\t\t\t\t       0x00010000 + i);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]0x%x\\n\",\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCQ));\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX2, MASKDWORD, 0x00000000);\n\trtw89_phy_write32_mask(rtwdev, R_SRAM_IQRX, MASKDWORD, 0x00000000);\n}\n\nstatic void _iqk_rxk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, 0xc);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_POW, 0x1);\n}\n\nstatic bool _iqk_check_cal(struct rtw89_dev *rtwdev, u8 path)\n{\n\tbool fail1 = false, fail2 = false;\n\tu32 val;\n\tint ret;\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x55,\n\t\t\t\t       10, 8200, false,\n\t\t\t\t       rtwdev, 0xbff8, MASKBYTE0);\n\tif (ret) {\n\t\tfail1 = true;\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]NCTL1 IQK timeout!!!\\n\");\n\t}\n\n\tfsleep(10);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x8000,\n\t\t\t\t       10, 200, false,\n\t\t\t\t       rtwdev, R_RPT_COM, B_RPT_COM_RDY);\n\tif (ret) {\n\t\tfail2 = true;\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]NCTL2 IQK timeout!!!\\n\");\n\t}\n\n\tfsleep(10);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, MASKBYTE0, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, ret = %d, notready = %x fail=%d,%d\\n\",\n\t\t    path, ret, fail1 || fail2, fail1, fail2);\n\n\treturn fail1 || fail2;\n}\n\nstatic bool _iqk_one_shot(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t  u8 path, u8 ktype)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool notready;\n\tu32 iqk_cmd;\n\n\tswitch (ktype) {\n\tcase ID_A_FLOK_COARSE:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]============ S%d ID_A_FLOK_COARSE ============\\n\", path);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x1);\n\t\tiqk_cmd = 0x108 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_G_FLOK_COARSE:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]============ S%d ID_G_FLOK_COARSE ============\\n\", path);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x1);\n\t\tiqk_cmd = 0x108 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_A_FLOK_FINE:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]============ S%d ID_A_FLOK_FINE ============\\n\", path);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x1);\n\t\tiqk_cmd = 0x308 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_G_FLOK_FINE:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]============ S%d ID_G_FLOK_FINE ============\\n\", path);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x1);\n\t\tiqk_cmd = 0x308 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_TXK:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]============ S%d ID_TXK ============\\n\", path);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x0);\n\t\tiqk_cmd = 0x008 | (1 << (path + 4)) |\n\t\t\t  (((0x8 + iqk_info->iqk_bw[path]) & 0xf) << 8);\n\t\tbreak;\n\tcase ID_RXAGC:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]============ S%d ID_RXAGC ============\\n\", path);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x1);\n\t\tiqk_cmd = 0x708 | (1 << (4 + path)) | (path << 1);\n\t\tbreak;\n\tcase ID_RXK:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]============ S%d ID_RXK ============\\n\", path);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x1);\n\t\tiqk_cmd = 0x008 | (1 << (path + 4)) |\n\t\t\t  (((0xc + iqk_info->iqk_bw[path]) & 0xf) << 8);\n\t\tbreak;\n\tcase ID_NBTXK:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]============ S%d ID_NBTXK ============\\n\", path);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT,\n\t\t\t\t       0x00b);\n\t\tiqk_cmd = 0x408 | (1 << (4 + path));\n\t\tbreak;\n\tcase ID_NBRXK:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]============ S%d ID_NBRXK ============\\n\", path);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT,\n\t\t\t\t       0x011);\n\t\tiqk_cmd = 0x608 | (1 << (4 + path));\n\t\tbreak;\n\tdefault:\n\t\treturn false;\n\t}\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD, iqk_cmd + 1);\n\tnotready = _iqk_check_cal(rtwdev, path);\n\tif (iqk_info->iqk_sram_en &&\n\t    (ktype == ID_NBRXK || ktype == ID_RXK))\n\t\t_iqk_sram(rtwdev, path);\n\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x0);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, ktype= %x, id = %x, notready = %x\\n\",\n\t\t    path, ktype, iqk_cmd + 1, notready);\n\n\treturn notready;\n}\n\nstatic bool _rxk_2g_group_sel(struct rtw89_dev *rtwdev,\n\t\t\t      enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail = false;\n\tbool notready;\n\tu32 rf_0;\n\tu8 gp;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\tfor (gp = 0; gp < RTW8851B_RXK_GROUP_NR; gp++) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, gp = %x\\n\", path, gp);\n\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_RGM, g_idxrxgain[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_C2, g_idxattc2[gp]);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G3, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_GP_V1, gp);\n\n\t\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RFREG_MASK, 0x80013);\n\t\tfsleep(10);\n\t\trf_0 = rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF2, B_IQK_DIF2_RXPI, rf_0);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_RXA, B_IQK_RXAGC, g_idxrxagc[gp]);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x11);\n\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_RXAGC);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S%x, RXAGC 0x8008 = 0x%x, rxbb = %x\\n\", path,\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD),\n\t\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, 0x003e0));\n\n\t\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_OFF, 0x13);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x011);\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBRXK);\n\t\tiqk_info->nb_rxcfir[path] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_RXIQC, MASKDWORD) | 0x2;\n\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_RXK);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S%x, WBRXK 0x8008 = 0x%x\\n\", path,\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD));\n\t}\n\n\tif (!notready)\n\t\tkfail = !!rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, B_NCTL_RPT_FLG);\n\n\tif (kfail)\n\t\t_iqk_sram(rtwdev, path);\n\n\tif (kfail) {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t       MASKDWORD, iqk_info->nb_rxcfir[path] | 0x2);\n\t\tiqk_info->is_wb_txiqk[path] = false;\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t       MASKDWORD, 0x40000000);\n\t\tiqk_info->is_wb_txiqk[path] = true;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, kfail = 0x%x, 0x8%x3c = 0x%x\\n\", path, kfail,\n\t\t    1 << path, iqk_info->nb_rxcfir[path]);\n\treturn kfail;\n}\n\nstatic bool _rxk_5g_group_sel(struct rtw89_dev *rtwdev,\n\t\t\t      enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail = false;\n\tbool notready;\n\tu32 rf_0;\n\tu8 idx;\n\tu8 gp;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\tfor (idx = 0; idx < RTW8851B_RXK_GROUP_IDX_NR; idx++) {\n\t\tgp = _rxk_5ghz_group_from_idx(idx);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, gp = %x\\n\", path, gp);\n\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RR_MOD_RGM, a_idxrxgain[idx]);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RXA2, RR_RXA2_ATT, a_idxattc2[idx]);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G3, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_GP_V1, gp);\n\n\t\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RFREG_MASK, 0x80013);\n\t\tfsleep(100);\n\t\trf_0 = rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF2, B_IQK_DIF2_RXPI, rf_0);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_RXA, B_IQK_RXAGC, a_idxrxagc[idx]);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x11);\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_RXAGC);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S%x, RXAGC 0x8008 = 0x%x, rxbb = %x\\n\", path,\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD),\n\t\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, RR_MOD_RXB));\n\n\t\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_OFF, 0x13);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x011);\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBRXK);\n\t\tiqk_info->nb_rxcfir[path] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_RXIQC, MASKDWORD) | 0x2;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S%x, NBRXK 0x8008 = 0x%x\\n\", path,\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD));\n\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_RXK);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S%x, WBRXK 0x8008 = 0x%x\\n\", path,\n\t\t\t    rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD));\n\t}\n\n\tif (!notready)\n\t\tkfail = !!rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, B_NCTL_RPT_FLG);\n\n\tif (kfail)\n\t\t_iqk_sram(rtwdev, path);\n\n\tif (kfail) {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD,\n\t\t\t\t       iqk_info->nb_rxcfir[path] | 0x2);\n\t\tiqk_info->is_wb_txiqk[path] = false;\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD,\n\t\t\t\t       0x40000000);\n\t\tiqk_info->is_wb_txiqk[path] = true;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, kfail = 0x%x, 0x8%x3c = 0x%x\\n\", path, kfail,\n\t\t    1 << path, iqk_info->nb_rxcfir[path]);\n\treturn kfail;\n}\n\nstatic bool _iqk_5g_nbrxk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t  u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail = false;\n\tbool notready;\n\tu8 idx = 0x1;\n\tu32 rf_0;\n\tu8 gp;\n\n\tgp = _rxk_5ghz_group_from_idx(idx);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, gp = %x\\n\", path, gp);\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RR_MOD_RGM, a_idxrxgain[idx]);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RXA2, RR_RXA2_ATT, a_idxattc2[idx]);\n\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_SEL, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G3, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_GP_V1, gp);\n\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RFREG_MASK, 0x80013);\n\tfsleep(100);\n\trf_0 = rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF2, B_IQK_DIF2_RXPI, rf_0);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_RXA, B_IQK_RXAGC, a_idxrxagc[idx]);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x11);\n\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_RXAGC);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, RXAGC 0x8008 = 0x%x, rxbb = %x\\n\", path,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD),\n\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, 0x003e0));\n\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_OFF, 0x13);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x011);\n\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBRXK);\n\tiqk_info->nb_rxcfir[path] =\n\t\trtw89_phy_read32_mask(rtwdev, R_RXIQC, MASKDWORD) | 0x2;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, NBRXK 0x8008 = 0x%x\\n\", path,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD));\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, WBRXK 0x8008 = 0x%x\\n\",\n\t\t    path, rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD));\n\n\tif (!notready)\n\t\tkfail = !!rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, B_NCTL_RPT_FLG);\n\n\tif (kfail) {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t       MASKDWORD, 0x40000002);\n\t\tiqk_info->is_wb_rxiqk[path] = false;\n\t} else {\n\t\tiqk_info->is_wb_rxiqk[path] = false;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, kfail = 0x%x, 0x8%x3c = 0x%x\\n\", path, kfail,\n\t\t    1 << path, iqk_info->nb_rxcfir[path]);\n\n\treturn kfail;\n}\n\nstatic bool _iqk_2g_nbrxk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t  u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail = false;\n\tbool notready;\n\tu8 gp = 0x3;\n\tu32 rf_0;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, gp = %x\\n\", path, gp);\n\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_RGM, g_idxrxgain[gp]);\n\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_C2, g_idxattc2[gp]);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_SEL, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G3, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_GP_V1, gp);\n\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RFREG_MASK, 0x80013);\n\tfsleep(10);\n\trf_0 = rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF2, B_IQK_DIF2_RXPI, rf_0);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_RXA, B_IQK_RXAGC, g_idxrxagc[gp]);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x11);\n\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_RXAGC);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, RXAGC 0x8008 = 0x%x, rxbb = %x\\n\",\n\t\t    path, rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD),\n\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, 0x003e0));\n\n\trtw89_write_rf(rtwdev, path, RR_RXKPLL, RR_RXKPLL_OFF, 0x13);\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_RXT, 0x011);\n\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBRXK);\n\tiqk_info->nb_rxcfir[path] =\n\t\trtw89_phy_read32_mask(rtwdev, R_RXIQC, MASKDWORD) | 0x2;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, NBRXK 0x8008 = 0x%x\\n\", path,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD));\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, WBRXK 0x8008 = 0x%x\\n\",\n\t\t    path, rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, MASKDWORD));\n\n\tif (!notready)\n\t\tkfail = !!rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, B_NCTL_RPT_FLG);\n\n\tif (kfail) {\n\t\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8),\n\t\t\t\t       MASKDWORD, 0x40000002);\n\t\tiqk_info->is_wb_rxiqk[path] = false;\n\t} else {\n\t\tiqk_info->is_wb_rxiqk[path] = false;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, kfail = 0x%x, 0x8%x3c = 0x%x\\n\", path, kfail,\n\t\t    1 << path, iqk_info->nb_rxcfir[path]);\n\treturn kfail;\n}\n\nstatic void _iqk_rxclk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\trtw89_write_rf(rtwdev, path, RR_RXBB2, RR_RXBB2_CKT, 0x1);\n\n\tif (iqk_info->iqk_bw[path] == RTW89_CHANNEL_WIDTH_80)\n\t\trtw89_rfk_parser(rtwdev, &rtw8851b_iqk_rxclk_80_defs_tbl);\n\telse\n\t\trtw89_rfk_parser(rtwdev, &rtw8851b_iqk_rxclk_others_defs_tbl);\n}\n\nstatic bool _txk_5g_group_sel(struct rtw89_dev *rtwdev,\n\t\t\t      enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail = false;\n\tbool notready;\n\tu8 gp;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\tfor (gp = 0x0; gp < RTW8851B_TXK_GROUP_NR; gp++) {\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, a_power_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, a_track_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, a_gain_bb[gp]);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G3, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G2, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_GP, gp);\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP, MASKDWORD, a_itqt[gp]);\n\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBTXK);\n\t\tiqk_info->nb_txcfir[path] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_TXIQC, MASKDWORD)  | 0x2;\n\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       MASKDWORD, a_itqt[gp]);\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_TXK);\n\t}\n\n\tif (!notready)\n\t\tkfail = !!rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, B_NCTL_RPT_FLG);\n\n\tif (kfail) {\n\t\trtw89_phy_write32_mask(rtwdev, R_TXIQC + (path << 8),\n\t\t\t\t       MASKDWORD, iqk_info->nb_txcfir[path] | 0x2);\n\t\tiqk_info->is_wb_txiqk[path] = false;\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_TXIQC + (path << 8),\n\t\t\t\t       MASKDWORD, 0x40000000);\n\t\tiqk_info->is_wb_txiqk[path] = true;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, kfail = 0x%x, 0x8%x38 = 0x%x\\n\", path, kfail,\n\t\t    1 << path, iqk_info->nb_txcfir[path]);\n\treturn kfail;\n}\n\nstatic bool _txk_2g_group_sel(struct rtw89_dev *rtwdev,\n\t\t\t      enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail = false;\n\tbool notready;\n\tu8 gp;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\tfor (gp = 0x0; gp < RTW8851B_TXK_GROUP_NR; gp++) {\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, g_power_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, g_track_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, g_gain_bb[gp]);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP, MASKDWORD, g_itqt[gp]);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G3, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G2, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_GP, gp);\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBTXK);\n\t\tiqk_info->nb_txcfir[path] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_TXIQC, MASKDWORD)  | 0x2;\n\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t       MASKDWORD, g_itqt[gp]);\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_TXK);\n\t}\n\n\tif (!notready)\n\t\tkfail = !!rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, B_NCTL_RPT_FLG);\n\n\tif (kfail) {\n\t\trtw89_phy_write32_mask(rtwdev, R_TXIQC + (path << 8),\n\t\t\t\t       MASKDWORD, iqk_info->nb_txcfir[path] | 0x2);\n\t\tiqk_info->is_wb_txiqk[path] = false;\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_TXIQC + (path << 8),\n\t\t\t\t       MASKDWORD, 0x40000000);\n\t\tiqk_info->is_wb_txiqk[path] = true;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, kfail = 0x%x, 0x8%x38 = 0x%x\\n\", path, kfail,\n\t\t    1 << path, iqk_info->nb_txcfir[path]);\n\treturn kfail;\n}\n\nstatic bool _iqk_5g_nbtxk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t  u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail = false;\n\tbool notready;\n\tu8 gp;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\tfor (gp = 0x0; gp < RTW8851B_TXK_GROUP_NR; gp++) {\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, a_power_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, a_track_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, a_gain_bb[gp]);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G3, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G2, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_GP, gp);\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP, MASKDWORD, a_itqt[gp]);\n\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBTXK);\n\t\tiqk_info->nb_txcfir[path] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_TXIQC, MASKDWORD)  | 0x2;\n\t}\n\n\tif (!notready)\n\t\tkfail = !!rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, B_NCTL_RPT_FLG);\n\n\tif (kfail) {\n\t\trtw89_phy_write32_mask(rtwdev, R_TXIQC + (path << 8),\n\t\t\t\t       MASKDWORD, 0x40000002);\n\t\tiqk_info->is_wb_rxiqk[path] = false;\n\t} else {\n\t\tiqk_info->is_wb_rxiqk[path] = false;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, kfail = 0x%x, 0x8%x38 = 0x%x\\n\", path, kfail,\n\t\t    1 << path, iqk_info->nb_txcfir[path]);\n\treturn kfail;\n}\n\nstatic bool _iqk_2g_nbtxk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t  u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool kfail = false;\n\tbool notready;\n\tu8 gp;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\tfor (gp = 0x0; gp < RTW8851B_TXK_GROUP_NR; gp++) {\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, g_power_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, g_track_range[gp]);\n\t\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, g_gain_bb[gp]);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP, MASKDWORD, g_itqt[gp]);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G3, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_G2, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_CFIR_LUT, B_CFIR_LUT_GP, gp);\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\n\t\tnotready = _iqk_one_shot(rtwdev, phy_idx, path, ID_NBTXK);\n\t\tiqk_info->nb_txcfir[path] =\n\t\t\trtw89_phy_read32_mask(rtwdev, R_TXIQC + (path << 8),\n\t\t\t\t\t      MASKDWORD)  | 0x2;\n\t}\n\n\tif (!notready)\n\t\tkfail = !!rtw89_phy_read32_mask(rtwdev, R_NCTL_RPT, B_NCTL_RPT_FLG);\n\n\tif (kfail) {\n\t\trtw89_phy_write32_mask(rtwdev, R_TXIQC + (path << 8),\n\t\t\t\t       MASKDWORD, 0x40000002);\n\t\tiqk_info->is_wb_rxiqk[path] = false;\n\t} else {\n\t\tiqk_info->is_wb_rxiqk[path] = false;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]S%x, kfail = 0x%x, 0x8%x38 = 0x%x\\n\", path, kfail,\n\t\t    1 << path, iqk_info->nb_txcfir[path]);\n\treturn kfail;\n}\n\nstatic bool _iqk_2g_lok(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\tu8 path)\n{\n\tstatic const u32 g_txbb[RTW8851B_LOK_GRAM] = {\n\t\t0x02, 0x06, 0x0a, 0x0c, 0x0e, 0x10, 0x12, 0x14, 0x16, 0x17};\n\tstatic const u32 g_itqt[RTW8851B_LOK_GRAM] = {\n\t\t0x09, 0x09, 0x09, 0x09, 0x09, 0x09, 0x12, 0x12, 0x12, 0x1b};\n\tstatic const u32 g_wa[RTW8851B_LOK_GRAM] = {\n\t\t0x00, 0x04, 0x08, 0x0c, 0x0e, 0x10, 0x12, 0x14, 0x16, 0x17};\n\tbool fail = false;\n\tu8 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LUTDBG, RR_LUTDBG_LOK, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_TXIG, RR_TXIG_GR0, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_TXIG, RR_TXIG_GR1, 0x6);\n\n\tfor (i = 0; i < RTW8851B_LOK_GRAM; i++) {\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_TXIG, RR_TXIG_TG, g_txbb[i]);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LUTWA, RR_LUTWA_M1, g_wa[i]);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP, B_KIP_IQP_IQSW, g_itqt[i]);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x021);\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD,\n\t\t\t\t       0x00000109 | (1 << (4 + path)));\n\t\tfail |= _iqk_check_cal(rtwdev, path);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP, B_KIP_IQP_IQSW, g_itqt[i]);\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD,\n\t\t\t\t       0x00000309 | (1 << (4 + path)));\n\t\tfail |= _iqk_check_cal(rtwdev, path);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x0);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S0, i = %x, 0x8[19:15] = 0x%x,0x8[09:05] = 0x%x\\n\", i,\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_DTXLOK, 0xf8000),\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_DTXLOK, 0x003e0));\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S0, i = %x, 0x9[19:16] = 0x%x,0x9[09:06] = 0x%x\\n\", i,\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_RSV2, 0xf0000),\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_RSV2, 0x003c0));\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S0, i = %x, 0x58 = %x\\n\", i,\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_TXMO, RFREG_MASK));\n\t}\n\n\treturn fail;\n}\n\nstatic bool _iqk_5g_lok(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\tu8 path)\n{\n\tstatic const u32 a_txbb[RTW8851B_LOK_GRAM] = {\n\t\t0x02, 0x06, 0x0a, 0x0c, 0x0e, 0x10, 0x12, 0x14, 0x16, 0x17};\n\tstatic const u32 a_itqt[RTW8851B_LOK_GRAM] = {\n\t\t0x09, 0x09, 0x09, 0x12, 0x12, 0x12, 0x1b, 0x1b, 0x1b, 0x1b};\n\tstatic const u32 a_wa[RTW8851B_LOK_GRAM] = {\n\t\t0x80, 0x84, 0x88, 0x8c, 0x8e, 0x90, 0x92, 0x94, 0x96, 0x97};\n\tbool fail = false;\n\tu8 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LUTDBG, RR_LUTDBG_LOK, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_TXIG, RR_TXIG_GR0, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_TXIG, RR_TXIG_GR1, 0x7);\n\n\tfor (i = 0; i < RTW8851B_LOK_GRAM; i++) {\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_TXIG, RR_TXIG_TG, a_txbb[i]);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LUTWA, RR_LUTWA_M1, a_wa[i]);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP, B_KIP_IQP_IQSW, a_itqt[i]);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x021);\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD,\n\t\t\t\t       0x00000109 | (1 << (4 + path)));\n\t\tfail |= _iqk_check_cal(rtwdev, path);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP, B_KIP_IQP_IQSW, a_itqt[i]);\n\t\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, B_IQK_DIF4_TXT, 0x021);\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD,\n\t\t\t\t       0x00000309 | (1 << (4 + path)));\n\t\tfail |= _iqk_check_cal(rtwdev, path);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\t\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK, B_IQK_RFC_ON, 0x0);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S0, i = %x, 0x8[19:15] = 0x%x,0x8[09:05] = 0x%x\\n\", i,\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_DTXLOK, 0xf8000),\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_DTXLOK, 0x003e0));\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S0, i = %x, 0x9[19:16] = 0x%x,0x9[09:06] = 0x%x\\n\", i,\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_RSV2, 0xf0000),\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_RSV2, 0x003c0));\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[IQK]S0, i = %x, 0x58 = %x\\n\", i,\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_TXMO, RFREG_MASK));\n\t}\n\n\treturn fail;\n}\n\nstatic void _iqk_txk_setting(struct rtw89_dev *rtwdev, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\n\tswitch (iqk_info->iqk_band[path]) {\n\tcase RTW89_BAND_2G:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]RTW89_BAND_2G\\n\");\n\t\trtw89_rfk_parser(rtwdev, &rtw8851b_iqk_txk_2ghz_defs_tbl);\n\t\tbreak;\n\tcase RTW89_BAND_5G:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]RTW89_BAND_5G\\n\");\n\t\trtw89_rfk_parser(rtwdev, &rtw8851b_iqk_txk_5ghz_defs_tbl);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\n#define IQK_LOK_RETRY 1\n\nstatic void _iqk_by_path(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tbool lok_is_fail;\n\tu8 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\tfor (i = 0; i < IQK_LOK_RETRY; i++) {\n\t\t_iqk_txk_setting(rtwdev, path);\n\t\tif (iqk_info->iqk_band[path] == RTW89_BAND_2G)\n\t\t\tlok_is_fail = _iqk_2g_lok(rtwdev, phy_idx, path);\n\t\telse\n\t\t\tlok_is_fail = _iqk_5g_lok(rtwdev, phy_idx, path);\n\n\t\tif (!lok_is_fail)\n\t\t\tbreak;\n\t}\n\n\tif (iqk_info->is_nbiqk) {\n\t\tif (iqk_info->iqk_band[path] == RTW89_BAND_2G)\n\t\t\tiqk_info->iqk_tx_fail[0][path] =\n\t\t\t\t_iqk_2g_nbtxk(rtwdev, phy_idx, path);\n\t\telse\n\t\t\tiqk_info->iqk_tx_fail[0][path] =\n\t\t\t\t_iqk_5g_nbtxk(rtwdev, phy_idx, path);\n\t} else {\n\t\tif (iqk_info->iqk_band[path] == RTW89_BAND_2G)\n\t\t\tiqk_info->iqk_tx_fail[0][path] =\n\t\t\t\t_txk_2g_group_sel(rtwdev, phy_idx, path);\n\t\telse\n\t\t\tiqk_info->iqk_tx_fail[0][path] =\n\t\t\t\t_txk_5g_group_sel(rtwdev, phy_idx, path);\n\t}\n\n\t_iqk_rxclk_setting(rtwdev, path);\n\t_iqk_rxk_setting(rtwdev, path);\n\t_adc_fifo_rst(rtwdev, phy_idx, path);\n\n\tif (iqk_info->is_nbiqk) {\n\t\tif (iqk_info->iqk_band[path] == RTW89_BAND_2G)\n\t\t\tiqk_info->iqk_rx_fail[0][path] =\n\t\t\t\t_iqk_2g_nbrxk(rtwdev, phy_idx, path);\n\t\telse\n\t\t\tiqk_info->iqk_rx_fail[0][path] =\n\t\t\t\t_iqk_5g_nbrxk(rtwdev, phy_idx, path);\n\t} else {\n\t\tif (iqk_info->iqk_band[path] == RTW89_BAND_2G)\n\t\t\tiqk_info->iqk_rx_fail[0][path] =\n\t\t\t\t_rxk_2g_group_sel(rtwdev, phy_idx, path);\n\t\telse\n\t\t\tiqk_info->iqk_rx_fail[0][path] =\n\t\t\t\t_rxk_5g_group_sel(rtwdev, phy_idx, path);\n\t}\n}\n\nstatic void _rfk_backup_bb_reg(struct rtw89_dev *rtwdev,\n\t\t\t       u32 backup_bb_reg_val[])\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_BB_REGS_NR; i++) {\n\t\tbackup_bb_reg_val[i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, rtw8851b_backup_bb_regs[i],\n\t\t\t\t\t      MASKDWORD);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK]backup bb reg : %x, value =%x\\n\",\n\t\t\t    rtw8851b_backup_bb_regs[i], backup_bb_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_backup_rf_reg(struct rtw89_dev *rtwdev,\n\t\t\t       u32 backup_rf_reg_val[], u8 rf_path)\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_RF_REGS_NR; i++) {\n\t\tbackup_rf_reg_val[i] =\n\t\t\trtw89_read_rf(rtwdev, rf_path,\n\t\t\t\t      rtw8851b_backup_rf_regs[i], RFREG_MASK);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK]backup rf S%d reg : %x, value =%x\\n\", rf_path,\n\t\t\t    rtw8851b_backup_rf_regs[i], backup_rf_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_restore_bb_reg(struct rtw89_dev *rtwdev,\n\t\t\t\tconst u32 backup_bb_reg_val[])\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_BB_REGS_NR; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, rtw8851b_backup_bb_regs[i],\n\t\t\t\t       MASKDWORD, backup_bb_reg_val[i]);\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK]restore bb reg : %x, value =%x\\n\",\n\t\t\t    rtw8851b_backup_bb_regs[i], backup_bb_reg_val[i]);\n\t}\n}\n\nstatic void _rfk_restore_rf_reg(struct rtw89_dev *rtwdev,\n\t\t\t\tconst u32 backup_rf_reg_val[], u8 rf_path)\n{\n\tu32 i;\n\n\tfor (i = 0; i < BACKUP_RF_REGS_NR; i++) {\n\t\trtw89_write_rf(rtwdev, rf_path, rtw8851b_backup_rf_regs[i],\n\t\t\t       RFREG_MASK, backup_rf_reg_val[i]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK]restore rf S%d reg: %x, value =%x\\n\", rf_path,\n\t\t\t    rtw8851b_backup_rf_regs[i], backup_rf_reg_val[i]);\n\t}\n}\n\nstatic void _iqk_get_ch_info(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t     u8 path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 idx = 0;\n\n\tiqk_info->iqk_band[path] = chan->band_type;\n\tiqk_info->iqk_bw[path] = chan->band_width;\n\tiqk_info->iqk_ch[path] = chan->channel;\n\tiqk_info->iqk_table_idx[path] = idx;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%d (PHY%d): / DBCC %s/ %s/ CH%d/ %s\\n\",\n\t\t    path, phy, rtwdev->dbcc_en ? \"on\" : \"off\",\n\t\t    iqk_info->iqk_band[path] == 0 ? \"2G\" :\n\t\t    iqk_info->iqk_band[path] == 1 ? \"5G\" : \"6G\",\n\t\t    iqk_info->iqk_ch[path],\n\t\t    iqk_info->iqk_bw[path] == 0 ? \"20M\" :\n\t\t    iqk_info->iqk_bw[path] == 1 ? \"40M\" : \"80M\");\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]times = 0x%x, ch =%x\\n\",\n\t\t    iqk_info->iqk_times, idx);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]S%x, iqk_info->syn1to2= 0x%x\\n\",\n\t\t    path, iqk_info->syn1to2);\n}\n\nstatic void _iqk_start_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx,\n\t\t\t   u8 path)\n{\n\t_iqk_by_path(rtwdev, phy_idx, path);\n}\n\nstatic void _iqk_restore(struct rtw89_dev *rtwdev, u8 path)\n{\n\tbool fail;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD, 0x00001219);\n\tfsleep(10);\n\tfail = _iqk_check_cal(rtwdev, path);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK] restore fail=%d\\n\", fail);\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LUTWE, RR_LUTWE_LOK, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LUTDBG, RR_LUTDBG_TIA, 0x0);\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, B_NCTL_N1_CIP, 0x00);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000000);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x80000000);\n}\n\nstatic void _iqk_afebb_restore(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8851b_iqk_afebb_restore_defs_tbl);\n}\n\nstatic void _iqk_preset(struct rtw89_dev *rtwdev, u8 path)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000080);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x81ff010a);\n}\n\nstatic void _iqk_macbb_setting(struct rtw89_dev *rtwdev,\n\t\t\t       enum rtw89_phy_idx phy_idx, u8 path)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\trtw89_rfk_parser(rtwdev, &rtw8851b_iqk_macbb_defs_tbl);\n}\n\nstatic void _iqk_init(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 idx, path;\n\n\trtw89_phy_write32_mask(rtwdev, R_IQKINF, MASKDWORD, 0x0);\n\n\tif (iqk_info->is_iqk_init)\n\t\treturn;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]===>%s\\n\", __func__);\n\n\tiqk_info->is_iqk_init = true;\n\tiqk_info->is_nbiqk = false;\n\tiqk_info->iqk_fft_en = false;\n\tiqk_info->iqk_sram_en = false;\n\tiqk_info->iqk_cfir_en = false;\n\tiqk_info->iqk_xym_en = false;\n\tiqk_info->iqk_times = 0x0;\n\n\tfor (idx = 0; idx < RTW89_IQK_CHS_NR; idx++) {\n\t\tiqk_info->iqk_channel[idx] = 0x0;\n\t\tfor (path = 0; path < RF_PATH_NUM_8851B; path++) {\n\t\t\tiqk_info->lok_cor_fail[idx][path] = false;\n\t\t\tiqk_info->lok_fin_fail[idx][path] = false;\n\t\t\tiqk_info->iqk_tx_fail[idx][path] = false;\n\t\t\tiqk_info->iqk_rx_fail[idx][path] = false;\n\t\t\tiqk_info->iqk_table_idx[path] = 0x0;\n\t\t}\n\t}\n}\n\nstatic void _doiqk(struct rtw89_dev *rtwdev, bool force,\n\t\t   enum rtw89_phy_idx phy_idx, u8 path)\n{\n\tstruct rtw89_iqk_info *iqk_info = &rtwdev->iqk;\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, RF_AB);\n\tu32 backup_rf_val[RTW8851B_IQK_SS][BACKUP_RF_REGS_NR];\n\tu32 backup_bb_val[BACKUP_BB_REGS_NR];\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK,\n\t\t\t      BTC_WRFK_ONESHOT_START);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[IQK]==========IQK start!!!!!==========\\n\");\n\tiqk_info->iqk_times++;\n\tiqk_info->version = RTW8851B_IQK_VER;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[IQK]Test Ver 0x%x\\n\", iqk_info->version);\n\t_iqk_get_ch_info(rtwdev, phy_idx, path);\n\n\t_rfk_backup_bb_reg(rtwdev, &backup_bb_val[0]);\n\t_rfk_backup_rf_reg(rtwdev, &backup_rf_val[path][0], path);\n\t_iqk_macbb_setting(rtwdev, phy_idx, path);\n\t_iqk_preset(rtwdev, path);\n\t_iqk_start_iqk(rtwdev, phy_idx, path);\n\t_iqk_restore(rtwdev, path);\n\t_iqk_afebb_restore(rtwdev, phy_idx, path);\n\t_rfk_restore_bb_reg(rtwdev, &backup_bb_val[0]);\n\t_rfk_restore_rf_reg(rtwdev, &backup_rf_val[path][0], path);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK,\n\t\t\t      BTC_WRFK_ONESHOT_STOP);\n}\n\nstatic void _iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx, bool force)\n{\n\t_doiqk(rtwdev, force, phy_idx, RF_PATH_A);\n}\n\nstatic void _dpk_bkup_kip(struct rtw89_dev *rtwdev, const u32 *reg,\n\t\t\t  u32 reg_bkup[][DPK_KIP_REG_NUM_8851B], u8 path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < DPK_KIP_REG_NUM_8851B; i++) {\n\t\treg_bkup[path][i] =\n\t\t\trtw89_phy_read32_mask(rtwdev, reg[i] + (path << 8), MASKDWORD);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Backup 0x%x = %x\\n\",\n\t\t\t    reg[i] + (path << 8), reg_bkup[path][i]);\n\t}\n}\n\nstatic void _dpk_bkup_rf(struct rtw89_dev *rtwdev, const u32 *rf_reg,\n\t\t\t u32 rf_bkup[][DPK_RF_REG_NUM_8851B], u8 path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < DPK_RF_REG_NUM_8851B; i++) {\n\t\trf_bkup[path][i] = rtw89_read_rf(rtwdev, path, rf_reg[i], RFREG_MASK);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Backup RF S%d 0x%x = %x\\n\",\n\t\t\t    path, rf_reg[i], rf_bkup[path][i]);\n\t}\n}\n\nstatic void _dpk_reload_kip(struct rtw89_dev *rtwdev, const u32 *reg,\n\t\t\t    u32 reg_bkup[][DPK_KIP_REG_NUM_8851B], u8 path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < DPK_KIP_REG_NUM_8851B; i++) {\n\t\trtw89_phy_write32_mask(rtwdev, reg[i] + (path << 8), MASKDWORD,\n\t\t\t\t       reg_bkup[path][i]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Reload 0x%x = %x\\n\",\n\t\t\t    reg[i] + (path << 8), reg_bkup[path][i]);\n\t}\n}\n\nstatic void _dpk_reload_rf(struct rtw89_dev *rtwdev, const u32 *rf_reg,\n\t\t\t   u32 rf_bkup[][DPK_RF_REG_NUM_8851B], u8 path)\n{\n\tu8 i;\n\n\tfor (i = 0; i < DPK_RF_REG_NUM_8851B; i++) {\n\t\trtw89_write_rf(rtwdev, path, rf_reg[i], RFREG_MASK, rf_bkup[path][i]);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Reload RF S%d 0x%x = %x\\n\", path,\n\t\t\t    rf_reg[i], rf_bkup[path][i]);\n\t}\n}\n\nstatic void _dpk_one_shot(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path, enum dpk_id id)\n{\n\tu16 dpk_cmd;\n\tu32 val;\n\tint ret;\n\n\tdpk_cmd = ((id << 8) | (0x19 + path * 0x12));\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_CFG, MASKDWORD, dpk_cmd);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x55,\n\t\t\t\t       10, 20000, false,\n\t\t\t\t       rtwdev, 0xbff8, MASKBYTE0);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] one-shot 1 timeout\\n\");\n\n\tudelay(1);\n\n\tret = read_poll_timeout_atomic(rtw89_phy_read32_mask, val, val == 0x8000,\n\t\t\t\t       1, 2000, false,\n\t\t\t\t       rtwdev, R_RPT_COM, MASKLWORD);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] one-shot 2 timeout\\n\");\n\n\trtw89_phy_write32_mask(rtwdev, R_NCTL_N1, MASKBYTE0, 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] one-shot for %s = 0x%04x\\n\",\n\t\t    id == 0x28 ? \"KIP_PRESET\" :\n\t\t    id == 0x29 ? \"DPK_TXAGC\" :\n\t\t    id == 0x2a ? \"DPK_RXAGC\" :\n\t\t    id == 0x2b ? \"SYNC\" :\n\t\t    id == 0x2c ? \"GAIN_LOSS\" :\n\t\t    id == 0x2d ? \"MDPK_IDL\" :\n\t\t    id == 0x2f ? \"DPK_GAIN_NORM\" :\n\t\t    id == 0x31 ? \"KIP_RESTORE\" :\n\t\t    id == 0x6 ? \"LBK_RXIQK\" : \"Unknown id\",\n\t\t    dpk_cmd);\n}\n\nstatic void _dpk_onoff(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t       bool off)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 kidx = dpk->cur_idx[path];\n\tu8 off_reverse = off ? 0 : 1;\n\tu8 val;\n\n\tval = dpk->is_dpk_enable * off_reverse * dpk->bp[path][kidx].path_ok;\n\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       0xf0000000, val);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d[%d] DPK %s !!!\\n\", path,\n\t\t    kidx, val == 0 ? \"disable\" : \"enable\");\n}\n\nstatic void _dpk_init(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tu8 kidx = dpk->cur_idx[path];\n\n\tdpk->bp[path][kidx].path_ok = 0;\n}\n\nstatic void _dpk_information(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t     enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tu8 kidx = dpk->cur_idx[path];\n\n\tdpk->bp[path][kidx].band = chan->band_type;\n\tdpk->bp[path][kidx].ch = chan->band_width;\n\tdpk->bp[path][kidx].bw = chan->channel;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] S%d[%d] (PHY%d): TSSI %s/ DBCC %s/ %s/ CH%d/ %s\\n\",\n\t\t    path, dpk->cur_idx[path], phy,\n\t\t    rtwdev->is_tssi_mode[path] ? \"on\" : \"off\",\n\t\t    rtwdev->dbcc_en ? \"on\" : \"off\",\n\t\t    dpk->bp[path][kidx].band == 0 ? \"2G\" :\n\t\t    dpk->bp[path][kidx].band == 1 ? \"5G\" : \"6G\",\n\t\t    dpk->bp[path][kidx].ch,\n\t\t    dpk->bp[path][kidx].bw == 0 ? \"20M\" :\n\t\t    dpk->bp[path][kidx].bw == 1 ? \"40M\" :\n\t\t    dpk->bp[path][kidx].bw == 2 ? \"80M\" : \"160M\");\n}\n\nstatic void _dpk_rxagc_onoff(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t\t     bool turn_on)\n{\n\tif (path == RF_PATH_A)\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_AGC_CTL, B_P0_AGC_EN, turn_on);\n\telse\n\t\trtw89_phy_write32_mask(rtwdev, R_P1_AGC_CTL, B_P1_AGC_EN, turn_on);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d RXAGC is %s\\n\", path,\n\t\t    turn_on ? \"turn_on\" : \"turn_off\");\n}\n\nstatic void _dpk_bb_afe_setting(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(16 + path), 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(20 + path), 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(24 + path), 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(28 + path), 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), MASKDWORD, 0xd801dffd);\n\n\trtw89_rfk_parser(rtwdev, &rtw8851b_iqk_bb_afe_defs_tbl);\n\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(20 + path), 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(28 + path), 0x1);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d BB/AFE setting\\n\", path);\n}\n\nstatic void _dpk_bb_afe_restore(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\trtw89_phy_write32_mask(rtwdev, R_P0_NRBW + (path << 13), B_P0_NRBW_DBG, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(16 + path), 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(20 + path), 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(24 + path), 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(28 + path), 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13), MASKDWORD, 0x00000000);\n\trtw89_phy_write32_mask(rtwdev, R_P0_RXCK + (path << 13), B_P0_TXCK_ALL, 0x00);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(16 + path), 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_ADC_FIFO, BIT(24 + path), 0x0);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d BB/AFE restore\\n\", path);\n}\n\nstatic void _dpk_tssi_pause(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t\t    bool is_pause)\n{\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK + (path << 13),\n\t\t\t       B_P0_TSSI_TRK_EN, is_pause);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d TSSI %s\\n\", path,\n\t\t    is_pause ? \"pause\" : \"resume\");\n}\n\nstatic void _dpk_tpg_sel(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tif (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_80) {\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_SEL, MASKDWORD, 0xffe0fa00);\n\t} else if (dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_40) {\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_SEL, MASKDWORD, 0xff4009e0);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_MOD, B_TPG_MOD_F, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_TPG_SEL, MASKDWORD, 0xf9f007d0);\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] TPG Select for %s\\n\",\n\t\t    dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_80 ? \"80M\" :\n\t\t    dpk->bp[path][kidx].bw == RTW89_CHANNEL_WIDTH_40 ? \"40M\" : \"20M\");\n}\n\nstatic void _dpk_txpwr_bb_force(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_rf_path path, bool force)\n{\n\trtw89_phy_write32_mask(rtwdev, R_TXPWRB + (path << 13), B_TXPWRB_ON, force);\n\trtw89_phy_write32_mask(rtwdev, R_TXPWRB_H + (path << 13), B_TXPWRB_RDY, force);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d txpwr_bb_force %s\\n\",\n\t\t    path, force ? \"on\" : \"off\");\n}\n\nstatic void _dpk_kip_pwr_clk_onoff(struct rtw89_dev *rtwdev, bool turn_on)\n{\n\tif (turn_on) {\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000080);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x807f030a);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, R_NCTL_RPT, MASKDWORD, 0x00000000);\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_SYSCFG, MASKDWORD, 0x80000000);\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_WR, BIT(18), 0x1);\n\t}\n}\n\nstatic void _dpk_kip_control_rfc(struct rtw89_dev *rtwdev,\n\t\t\t\t enum rtw89_rf_path path, bool ctrl_by_kip)\n{\n\trtw89_phy_write32_mask(rtwdev, R_UPD_CLK + (path << 13),\n\t\t\t       B_IQK_RFC_ON, ctrl_by_kip);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] RFC is controlled by %s\\n\",\n\t\t    ctrl_by_kip ? \"KIP\" : \"BB\");\n}\n\nstatic void _dpk_kip_preset(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path, u8 kidx)\n{\n\trtw89_phy_write32_mask(rtwdev, R_KIP_MOD, B_KIP_MOD,\n\t\t\t       rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK));\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       B_DPD_SEL, 0x01);\n\n\t_dpk_kip_control_rfc(rtwdev, path, true);\n\t_dpk_one_shot(rtwdev, phy, path, D_KIP_PRESET);\n}\n\nstatic void _dpk_kip_restore(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t     enum rtw89_rf_path path)\n{\n\t_dpk_one_shot(rtwdev, phy, path, D_KIP_RESTORE);\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\t_dpk_txpwr_bb_force(rtwdev, path, false);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d restore KIP\\n\", path);\n}\n\nstatic void _dpk_kset_query(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT + (path << 8), B_KIP_RPT_SEL, 0x10);\n\n\tdpk->cur_k_set =\n\t\trtw89_phy_read32_mask(rtwdev, R_RPT_PER + (path << 8), B_RPT_PER_KSET) - 1;\n}\n\nstatic void _dpk_para_query(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 kidx)\n{\n\tstatic const u32 reg[RTW89_DPK_BKUP_NUM][DPK_KSET_NUM] = {\n\t\t{0x8190, 0x8194, 0x8198, 0x81a4},\n\t\t{0x81a8, 0x81c4, 0x81c8, 0x81e8}\n\t};\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 cur_k_set = dpk->cur_k_set;\n\tu32 para;\n\n\tif (cur_k_set >= DPK_KSET_NUM) {\n\t\trtw89_warn(rtwdev, \"DPK cur_k_set = %d\\n\", cur_k_set);\n\t\tcur_k_set = 2;\n\t}\n\n\tpara = rtw89_phy_read32_mask(rtwdev, reg[kidx][cur_k_set] + (path << 8),\n\t\t\t\t     MASKDWORD);\n\n\tdpk->bp[path][kidx].txagc_dpk = (para >> 10) & 0x3f;\n\tdpk->bp[path][kidx].ther_dpk = (para >> 26) & 0x3f;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] thermal/ txagc_RF (K%d) = 0x%x/ 0x%x\\n\",\n\t\t    dpk->cur_k_set, dpk->bp[path][kidx].ther_dpk,\n\t\t    dpk->bp[path][kidx].txagc_dpk);\n}\n\nstatic bool _dpk_sync_check(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 corr_val, corr_idx, rxbb;\n\tu16 dc_i, dc_q;\n\tu8 rxbb_ov;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x0);\n\n\tcorr_idx = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_CORI);\n\tcorr_val = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_CORV);\n\tdpk->corr_idx[path][kidx] = corr_idx;\n\tdpk->corr_val[path][kidx] = corr_val;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x9);\n\n\tdc_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCI);\n\tdc_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCQ);\n\n\tdc_i = abs(sign_extend32(dc_i, 11));\n\tdc_q = abs(sign_extend32(dc_q, 11));\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] S%d Corr_idx/ Corr_val /DC I/Q, = %d / %d / %d / %d\\n\",\n\t\t    path, corr_idx, corr_val, dc_i, dc_q);\n\n\tdpk->dc_i[path][kidx] = dc_i;\n\tdpk->dc_q[path][kidx] = dc_q;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x8);\n\trxbb = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_RXBB);\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x31);\n\trxbb_ov = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_RXOV);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] S%d RXBB/ RXAGC_done /RXBB_ovlmt = %d / %d / %d\\n\",\n\t\t    path, rxbb,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DONE),\n\t\t    rxbb_ov);\n\n\tif (dc_i > 200 || dc_q > 200 || corr_val < 170)\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\nstatic void _dpk_kip_set_txagc(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t       enum rtw89_rf_path path, u8 dbm,\n\t\t\t       bool set_from_bb)\n{\n\tif (set_from_bb) {\n\t\tdbm = clamp_t(u8, dbm, 7, 24);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] set S%d txagc to %ddBm\\n\", path, dbm);\n\t\trtw89_phy_write32_mask(rtwdev, R_TXPWRB + (path << 13),\n\t\t\t\t       B_TXPWRB_VAL, dbm << 2);\n\t}\n\n\t_dpk_one_shot(rtwdev, phy, path, D_TXAGC);\n\t_dpk_kset_query(rtwdev, path);\n}\n\nstatic bool _dpk_kip_set_rxagc(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t       enum rtw89_rf_path path, u8 kidx)\n{\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_MOD, B_KIP_MOD,\n\t\t\t       rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK));\n\t_dpk_kip_control_rfc(rtwdev, path, true);\n\n\t_dpk_one_shot(rtwdev, phy, path, D_RXAGC);\n\treturn _dpk_sync_check(rtwdev, path, kidx);\n}\n\nstatic void _dpk_lbk_rxiqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t   enum rtw89_rf_path path)\n{\n\tu32 rf_11, reg_81cc;\n\tu8 cur_rxbb;\n\n\trtw89_phy_write32_mask(rtwdev, R_DPD_V1 + (path << 8), B_DPD_LBK, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_MDPK_RX_DCK, B_MDPK_RX_DCK_EN, 0x1);\n\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\n\tcur_rxbb = rtw89_read_rf(rtwdev, path, RR_MOD, RR_MOD_RXB);\n\trf_11 = rtw89_read_rf(rtwdev, path, RR_TXIG, RFREG_MASK);\n\treg_81cc = rtw89_phy_read32_mask(rtwdev, R_KIP_IQP + (path << 8),\n\t\t\t\t\t B_KIP_IQP_SW);\n\n\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR0, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_GR1, 0x3);\n\trtw89_write_rf(rtwdev, path, RR_TXIG, RR_TXIG_TG, 0xd);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_RXB, 0x1f);\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), B_KIP_IQP_IQSW, 0x12);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), B_KIP_IQP_SW, 0x3);\n\n\t_dpk_kip_control_rfc(rtwdev, path, true);\n\n\trtw89_phy_write32_mask(rtwdev, R_IQK_DIF4, MASKDWORD, 0x00250025);\n\n\t_dpk_one_shot(rtwdev, phy, path, LBK_RXIQK);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d LBK RXIQC = 0x%x\\n\", path,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD));\n\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\n\trtw89_write_rf(rtwdev, path, RR_TXIG, RFREG_MASK, rf_11);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_RXB, cur_rxbb);\n\trtw89_phy_write32_mask(rtwdev, R_KIP_IQP + (path << 8), B_KIP_IQP_SW, reg_81cc);\n\n\trtw89_phy_write32_mask(rtwdev, R_MDPK_RX_DCK, B_MDPK_RX_DCK_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_KPATH_CFG, B_KPATH_CFG_ED, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_DI, 0x1);\n\n\t_dpk_kip_control_rfc(rtwdev, path, true);\n}\n\nstatic void _dpk_rf_setting(struct rtw89_dev *rtwdev, enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\tif (dpk->bp[path][kidx].band == RTW89_BAND_2G) {\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK, 0x50521);\n\t\trtw89_write_rf(rtwdev, path, RR_MOD_V1, RR_MOD_MASK, RF_DPK);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_ATTC, 0x0);\n\t\trtw89_write_rf(rtwdev, path, RR_RXBB, RR_RXBB_ATTR, 0x7);\n\t} else {\n\t\trtw89_write_rf(rtwdev, path, RR_MOD, RFREG_MASK,\n\t\t\t       0x50521 | BIT(rtwdev->dbcc_en));\n\t\trtw89_write_rf(rtwdev, path, RR_MOD_V1, RR_MOD_MASK, RF_DPK);\n\t\trtw89_write_rf(rtwdev, path, RR_RXA2, RR_RAA2_SATT, 0x3);\n\t}\n\n\trtw89_write_rf(rtwdev, path, RR_RCKD, RR_RCKD_BW, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_BTC, RR_BTC_TXBB, dpk->bp[path][kidx].bw + 1);\n\trtw89_write_rf(rtwdev, path, RR_BTC, RR_BTC_RXBB, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_RXBB2, RR_RXBB2_EBW, 0x0);\n}\n\nstatic void _dpk_bypass_rxiqc(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\trtw89_phy_write32_mask(rtwdev, R_DPD_V1 + (path << 8), B_DPD_LBK, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_RXIQC + (path << 8), MASKDWORD, 0x40000002);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Bypass RXIQC\\n\");\n}\n\nstatic u16 _dpk_dgain_read(struct rtw89_dev *rtwdev)\n{\n\tu16 dgain;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x0);\n\tdgain = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_DCI);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] DGain = 0x%x\\n\", dgain);\n\n\treturn dgain;\n}\n\nstatic u8 _dpk_gainloss_read(struct rtw89_dev *rtwdev)\n{\n\tu8 result;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, B_KIP_RPT1_SEL, 0x6);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG2, B_DPK_CFG2_ST, 0x1);\n\tresult = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, B_PRT_COM_GL);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] tmp GL = %d\\n\", result);\n\n\treturn result;\n}\n\nstatic u8 _dpk_gainloss(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\tenum rtw89_rf_path path, u8 kidx)\n{\n\t_dpk_one_shot(rtwdev, phy, path, D_GAIN_LOSS);\n\t_dpk_kip_set_txagc(rtwdev, phy, path, 0xff, false);\n\n\trtw89_phy_write32_mask(rtwdev, R_DPK_GL + (path << 8), B_DPK_GL_A1, 0xf078);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_GL + (path << 8), B_DPK_GL_A0, 0x0);\n\n\treturn _dpk_gainloss_read(rtwdev);\n}\n\nstatic u8 _dpk_pas_read(struct rtw89_dev *rtwdev, u8 is_check)\n{\n\tu32 val1_i = 0, val1_q = 0, val2_i = 0, val2_q = 0;\n\tu32 val1_sqrt_sum, val2_sqrt_sum;\n\tu8 i;\n\n\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT1, MASKBYTE2, 0x06);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG2, B_DPK_CFG2_ST, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE2, 0x08);\n\n\tif (is_check) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, 0x00);\n\t\tval1_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKHWORD);\n\t\tval1_i = abs(sign_extend32(val1_i, 11));\n\t\tval1_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKLWORD);\n\t\tval1_q = abs(sign_extend32(val1_q, 11));\n\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, 0x1f);\n\t\tval2_i = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKHWORD);\n\t\tval2_i = abs(sign_extend32(val2_i, 11));\n\t\tval2_q = rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKLWORD);\n\t\tval2_q = abs(sign_extend32(val2_q, 11));\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] PAS_delta = 0x%x\\n\",\n\t\t\t    phy_div(val1_i * val1_i + val1_q * val1_q,\n\t\t\t\t    val2_i * val2_i + val2_q * val2_q));\n\t} else {\n\t\tfor (i = 0; i < 32; i++) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_DPK_CFG3, MASKBYTE3, i);\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t    \"[DPK] PAS_Read[%02d]= 0x%08x\\n\", i,\n\t\t\t\t    rtw89_phy_read32_mask(rtwdev, R_RPT_COM, MASKDWORD));\n\t\t}\n\t}\n\n\tval1_sqrt_sum = val1_i * val1_i + val1_q * val1_q;\n\tval2_sqrt_sum = val2_i * val2_i + val2_q * val2_q;\n\n\tif (val1_sqrt_sum < val2_sqrt_sum)\n\t\treturn 2;\n\telse if (val1_sqrt_sum >= val2_sqrt_sum * 8 / 5)\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\nstatic u8 _dpk_agc(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t   enum rtw89_rf_path path, u8 kidx, u8 init_xdbm, u8 loss_only)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 tmp_dbm = init_xdbm, tmp_gl_idx = 0;\n\tu8 step = DPK_AGC_STEP_SYNC_DGAIN;\n\tu8 goout = 0, agc_cnt = 0;\n\tbool is_fail = false;\n\tint limit = 200;\n\tu8 tmp_rxbb;\n\tu16 dgain;\n\n\tdo {\n\t\tswitch (step) {\n\t\tcase DPK_AGC_STEP_SYNC_DGAIN:\n\t\t\tis_fail = _dpk_kip_set_rxagc(rtwdev, phy, path, kidx);\n\n\t\t\tif (is_fail) {\n\t\t\t\tgoout = 1;\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tdgain = _dpk_dgain_read(rtwdev);\n\n\t\t\tif (dgain > 0x5fc || dgain < 0x556) {\n\t\t\t\t_dpk_one_shot(rtwdev, phy, path, D_SYNC);\n\t\t\t\tdgain = _dpk_dgain_read(rtwdev);\n\t\t\t}\n\n\t\t\tif (agc_cnt == 0) {\n\t\t\t\tif (dpk->bp[path][kidx].band == RTW89_BAND_2G)\n\t\t\t\t\t_dpk_bypass_rxiqc(rtwdev, path);\n\t\t\t\telse\n\t\t\t\t\t_dpk_lbk_rxiqk(rtwdev, phy, path);\n\t\t\t}\n\t\t\tstep = DPK_AGC_STEP_GAIN_LOSS_IDX;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GAIN_LOSS_IDX:\n\t\t\ttmp_gl_idx = _dpk_gainloss(rtwdev, phy, path, kidx);\n\n\t\t\tif (_dpk_pas_read(rtwdev, true) == 2 && tmp_gl_idx > 0)\n\t\t\t\tstep = DPK_AGC_STEP_GL_LT_CRITERION;\n\t\t\telse if ((tmp_gl_idx == 0 && _dpk_pas_read(rtwdev, true) == 1) ||\n\t\t\t\t tmp_gl_idx >= 7)\n\t\t\t\tstep = DPK_AGC_STEP_GL_GT_CRITERION;\n\t\t\telse if (tmp_gl_idx == 0)\n\t\t\t\tstep = DPK_AGC_STEP_GL_LT_CRITERION;\n\t\t\telse\n\t\t\t\tstep = DPK_AGC_STEP_SET_TX_GAIN;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GL_GT_CRITERION:\n\t\t\tif (tmp_dbm <= 7) {\n\t\t\t\tgoout = 1;\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t\t    \"[DPK] Txagc@lower bound!!\\n\");\n\t\t\t} else {\n\t\t\t\ttmp_dbm = max_t(u8, tmp_dbm - 3, 7);\n\t\t\t\t_dpk_kip_set_txagc(rtwdev, phy, path, tmp_dbm, true);\n\t\t\t}\n\t\t\tstep = DPK_AGC_STEP_SYNC_DGAIN;\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_GL_LT_CRITERION:\n\t\t\tif (tmp_dbm >= 24) {\n\t\t\t\tgoout = 1;\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t\t    \"[DPK] Txagc@upper bound!!\\n\");\n\t\t\t} else {\n\t\t\t\ttmp_dbm = min_t(u8, tmp_dbm + 2, 24);\n\t\t\t\t_dpk_kip_set_txagc(rtwdev, phy, path, tmp_dbm, true);\n\t\t\t}\n\t\t\tstep = DPK_AGC_STEP_SYNC_DGAIN;\n\t\t\tagc_cnt++;\n\t\t\tbreak;\n\n\t\tcase DPK_AGC_STEP_SET_TX_GAIN:\n\t\t\t_dpk_kip_control_rfc(rtwdev, path, false);\n\t\t\ttmp_rxbb = rtw89_read_rf(rtwdev, path, RR_MOD, RR_MOD_RXB);\n\t\t\ttmp_rxbb = min_t(u8, tmp_rxbb + tmp_gl_idx, 0x1f);\n\n\t\t\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_RXB, tmp_rxbb);\n\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t\t    \"[DPK] Adjust RXBB (%+d) = 0x%x\\n\",\n\t\t\t\t    tmp_gl_idx, tmp_rxbb);\n\t\t\t_dpk_kip_control_rfc(rtwdev, path, true);\n\t\t\tgoout = 1;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tgoout = 1;\n\t\t\tbreak;\n\t\t}\n\t} while (!goout && agc_cnt < 6 && limit-- > 0);\n\n\treturn is_fail;\n}\n\nstatic void _dpk_set_mdpd_para(struct rtw89_dev *rtwdev, u8 order)\n{\n\tswitch (order) {\n\tcase 0:  \n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_IDL, B_DPK_IDL_SEL, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_PN, 0x4);\n\t\trtw89_phy_write32_mask(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_DMAN, 0x1);\n\t\tbreak;\n\tcase 1:  \n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_IDL, B_DPK_IDL_SEL, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_PN, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_DMAN, 0x0);\n\t\tbreak;\n\tcase 2:  \n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP, 0x2);\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_IDL, B_DPK_IDL_SEL, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_PN, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_DMAN, 0x0);\n\t\tbreak;\n\tcase 3:  \n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_IDL, B_DPK_IDL_SEL, 0x3);\n\t\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_PN, 0x4);\n\t\trtw89_phy_write32_mask(rtwdev, R_MDPK_SYNC, B_MDPK_SYNC_DMAN, 0x1);\n\t\tbreak;\n\tdefault:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] Wrong MDPD order!!(0x%x)\\n\", order);\n\t\tbreak;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] Set %s for IDL\\n\",\n\t\t    order == 0x0 ? \"(5,3,1)\" :\n\t\t    order == 0x1 ? \"(5,3,0)\" :\n\t\t    order == 0x2 ? \"(5,0,0)\" : \"(7,3,1)\");\n}\n\nstatic void _dpk_idl_mpa(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t enum rtw89_rf_path path, u8 kidx)\n{\n\trtw89_phy_write32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_MA, 0x1);\n\n\tif (rtw89_phy_read32_mask(rtwdev, R_IDL_MPA, B_IDL_MD500) == 0x1)\n\t\t_dpk_set_mdpd_para(rtwdev, 0x2);\n\telse if (rtw89_phy_read32_mask(rtwdev, R_IDL_MPA, B_IDL_MD530) == 0x1)\n\t\t_dpk_set_mdpd_para(rtwdev, 0x1);\n\telse\n\t\t_dpk_set_mdpd_para(rtwdev, 0x0);\n\n\trtw89_phy_write32_mask(rtwdev, R_DPK_IDL, B_DPK_IDL, 0x0);\n\tfsleep(1000);\n\n\t_dpk_one_shot(rtwdev, phy, path, D_MDPK_IDL);\n}\n\nstatic u8 _dpk_order_convert(struct rtw89_dev *rtwdev)\n{\n\tu32 order;\n\tu8 val;\n\n\torder = rtw89_phy_read32_mask(rtwdev, R_LDL_NORM, B_LDL_NORM_OP);\n\n\tswitch (order) {\n\tcase 0:  \n\t\tval = 0x6;\n\t\tbreak;\n\tcase 1:  \n\t\tval = 0x2;\n\t\tbreak;\n\tcase 2:  \n\t\tval = 0x0;\n\t\tbreak;\n\tdefault:\n\t\tval = 0xff;\n\t\tbreak;\n\t}\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] convert MDPD order to 0x%x\\n\", val);\n\n\treturn val;\n}\n\nstatic void _dpk_gain_normalize(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path, u8 kidx, bool is_execute)\n{\n\tstatic const u32 reg[RTW89_DPK_BKUP_NUM][DPK_KSET_NUM] = {\n\t\t{0x8190, 0x8194, 0x8198, 0x81a4},\n\t\t{0x81a8, 0x81c4, 0x81c8, 0x81e8}\n\t};\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 cur_k_set = dpk->cur_k_set;\n\n\tif (cur_k_set >= DPK_KSET_NUM) {\n\t\trtw89_warn(rtwdev, \"DPK cur_k_set = %d\\n\", cur_k_set);\n\t\tcur_k_set = 2;\n\t}\n\n\tif (is_execute) {\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_GN + (path << 8),\n\t\t\t\t       B_DPK_GN_AG, 0x200);\n\t\trtw89_phy_write32_mask(rtwdev, R_DPK_GN + (path << 8),\n\t\t\t\t       B_DPK_GN_EN, 0x3);\n\n\t\t_dpk_one_shot(rtwdev, phy, path, D_GAIN_NORM);\n\t} else {\n\t\trtw89_phy_write32_mask(rtwdev, reg[kidx][cur_k_set] + (path << 8),\n\t\t\t\t       0x0000007F, 0x5b);\n\t}\n\n\tdpk->bp[path][kidx].gs =\n\t\trtw89_phy_read32_mask(rtwdev, reg[kidx][cur_k_set] + (path << 8),\n\t\t\t\t      0x0000007F);\n}\n\nstatic void _dpk_on(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t    enum rtw89_rf_path path, u8 kidx)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_MDPD, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_LOAD_COEF + (path << 8), B_LOAD_COEF_MDPD, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       B_DPD_ORDER, _dpk_order_convert(rtwdev));\n\n\tdpk->bp[path][kidx].path_ok =\n\t\tdpk->bp[path][kidx].path_ok | BIT(dpk->cur_k_set);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d[%d] path_ok = 0x%x\\n\",\n\t\t    path, kidx, dpk->bp[path][kidx].path_ok);\n\n\trtw89_phy_write32_mask(rtwdev, R_DPD_CH0A + (path << 8) + (kidx << 2),\n\t\t\t       B_DPD_MEN, dpk->bp[path][kidx].path_ok);\n\n\t_dpk_gain_normalize(rtwdev, phy, path, kidx, false);\n}\n\nstatic bool _dpk_main(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t      enum rtw89_rf_path path)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu8 kidx = dpk->cur_idx[path];\n\tu8 init_xdbm = 17;\n\tbool is_fail;\n\n\tif (dpk->bp[path][kidx].band != RTW89_BAND_2G)\n\t\tinit_xdbm = 15;\n\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\t_rfk_rf_direct_cntrl(rtwdev, path, false);\n\trtw89_write_rf(rtwdev, path, RR_BBDC, RFREG_MASK, 0x03ffd);\n\n\t_dpk_rf_setting(rtwdev, path, kidx);\n\t_set_rx_dck(rtwdev, path, RF_DPK);\n\n\t_dpk_kip_pwr_clk_onoff(rtwdev, true);\n\t_dpk_kip_preset(rtwdev, phy, path, kidx);\n\t_dpk_txpwr_bb_force(rtwdev, path, true);\n\t_dpk_kip_set_txagc(rtwdev, phy, path, init_xdbm, true);\n\t_dpk_tpg_sel(rtwdev, path, kidx);\n\tis_fail = _dpk_agc(rtwdev, phy, path, kidx, init_xdbm, false);\n\tif (is_fail)\n\t\tgoto _error;\n\n\t_dpk_idl_mpa(rtwdev, phy, path, kidx);\n\t_dpk_para_query(rtwdev, path, kidx);\n\n\t_dpk_on(rtwdev, phy, path, kidx);\n_error:\n\t_dpk_kip_control_rfc(rtwdev, path, false);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RF_RX);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[DPK] S%d[%d]_K%d %s\\n\", path, kidx,\n\t\t    dpk->cur_k_set, is_fail ? \"need Check\" : \"is Success\");\n\n\treturn is_fail;\n}\n\nstatic void _dpk_cal_select(struct rtw89_dev *rtwdev, bool force,\n\t\t\t    enum rtw89_phy_idx phy, u8 kpath)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\tu32 kip_bkup[RF_PATH_NUM_8851B][DPK_KIP_REG_NUM_8851B] = {};\n\tu32 rf_bkup[RF_PATH_NUM_8851B][DPK_RF_REG_NUM_8851B] = {};\n\tbool is_fail;\n\tu8 path;\n\n\tfor (path = 0; path < RF_PATH_NUM_8851B; path++)\n\t\tdpk->cur_idx[path] = 0;\n\n\tfor (path = 0; path < RF_PATH_NUM_8851B; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\t\t_dpk_bkup_kip(rtwdev, dpk_kip_reg, kip_bkup, path);\n\t\t_dpk_bkup_rf(rtwdev, dpk_rf_reg, rf_bkup, path);\n\t\t_dpk_information(rtwdev, phy, path);\n\t\t_dpk_init(rtwdev, path);\n\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\t_dpk_tssi_pause(rtwdev, path, true);\n\t}\n\n\tfor (path = 0; path < RF_PATH_NUM_8851B; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[DPK] ========= S%d[%d] DPK Start =========\\n\",\n\t\t\t    path, dpk->cur_idx[path]);\n\n\t\t_dpk_rxagc_onoff(rtwdev, path, false);\n\t\t_rfk_drf_direct_cntrl(rtwdev, path, false);\n\t\t_dpk_bb_afe_setting(rtwdev, path);\n\n\t\tis_fail = _dpk_main(rtwdev, phy, path);\n\t\t_dpk_onoff(rtwdev, path, is_fail);\n\t}\n\n\tfor (path = 0; path < RF_PATH_NUM_8851B; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\t_dpk_kip_restore(rtwdev, phy, path);\n\t\t_dpk_reload_kip(rtwdev, dpk_kip_reg, kip_bkup, path);\n\t\t_dpk_reload_rf(rtwdev, dpk_rf_reg, rf_bkup, path);\n\t\t_dpk_bb_afe_restore(rtwdev, path);\n\t\t_dpk_rxagc_onoff(rtwdev, path, true);\n\n\t\tif (rtwdev->is_tssi_mode[path])\n\t\t\t_dpk_tssi_pause(rtwdev, path, false);\n\t}\n\n\t_dpk_kip_pwr_clk_onoff(rtwdev, false);\n}\n\nstatic void _dpk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy, bool force)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[DPK] ****** 8851B DPK Start (Ver: 0x%x, Cv: %d) ******\\n\",\n\t\t    DPK_VER_8851B, rtwdev->hal.cv);\n\n\t_dpk_cal_select(rtwdev, force, phy, _kpath(rtwdev, phy));\n}\n\nstatic void _dpk_track(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_dpk_info *dpk = &rtwdev->dpk;\n\ts8 txagc_bb, txagc_bb_tp, txagc_ofst;\n\ts16 pwsf_tssi_ofst;\n\ts8 delta_ther = 0;\n\tu8 path, kidx;\n\tu8 txagc_rf;\n\tu8 cur_ther;\n\n\tfor (path = 0; path < RF_PATH_NUM_8851B; path++) {\n\t\tkidx = dpk->cur_idx[path];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] ================[S%d[%d] (CH %d)]================\\n\",\n\t\t\t    path, kidx, dpk->bp[path][kidx].ch);\n\n\t\ttxagc_rf = rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB + (path << 13),\n\t\t\t\t\t\t B_TXAGC_RF);\n\t\ttxagc_bb = rtw89_phy_read32_mask(rtwdev, R_TXAGC_BB + (path << 13),\n\t\t\t\t\t\t MASKBYTE2);\n\t\ttxagc_bb_tp = rtw89_phy_read32_mask(rtwdev, R_TXAGC_BTP + (path << 13),\n\t\t\t\t\t\t    B_TXAGC_BTP);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_KIP_RPT + (path << 8),\n\t\t\t\t       B_KIP_RPT_SEL, 0xf);\n\t\tcur_ther = rtw89_phy_read32_mask(rtwdev, R_RPT_PER + (path << 8),\n\t\t\t\t\t\t B_RPT_PER_TH);\n\t\ttxagc_ofst = rtw89_phy_read32_mask(rtwdev, R_RPT_PER + (path << 8),\n\t\t\t\t\t\t   B_RPT_PER_OF);\n\t\tpwsf_tssi_ofst = rtw89_phy_read32_mask(rtwdev, R_RPT_PER + (path << 8),\n\t\t\t\t\t\t       B_RPT_PER_TSSI);\n\t\tpwsf_tssi_ofst = sign_extend32(pwsf_tssi_ofst, 12);\n\n\t\tdelta_ther = cur_ther - dpk->bp[path][kidx].ther_dpk;\n\n\t\tdelta_ther = delta_ther * 2 / 3;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] extra delta_ther = %d (0x%x / 0x%x@k)\\n\",\n\t\t\t    delta_ther, cur_ther, dpk->bp[path][kidx].ther_dpk);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] delta_txagc = %d (0x%x / 0x%x@k)\\n\",\n\t\t\t    txagc_rf - dpk->bp[path][kidx].txagc_dpk,\n\t\t\t    txagc_rf, dpk->bp[path][kidx].txagc_dpk);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] txagc_offset / pwsf_tssi_ofst = 0x%x / %+d\\n\",\n\t\t\t    txagc_ofst, pwsf_tssi_ofst);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t    \"[DPK_TRK] txagc_bb_tp / txagc_bb = 0x%x / 0x%x\\n\",\n\t\t\t    txagc_bb_tp, txagc_bb);\n\n\t\tif (rtw89_phy_read32_mask(rtwdev, R_IDL_MPA, B_IDL_DN) == 0x0 &&\n\t\t    txagc_rf != 0) {\n\t\t\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t\t\t    \"[DPK_TRK] New pwsf = 0x%x\\n\", 0x78 - delta_ther);\n\n\t\t\trtw89_phy_write32_mask(rtwdev,\n\t\t\t\t\t       R_DPD_BND + (path << 8) + (kidx << 2),\n\t\t\t\t\t       0x07FC0000, 0x78 - delta_ther);\n\t\t}\n\t}\n}\n\nstatic void _rck(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\tu32 rf_reg5;\n\tu32 rck_val;\n\tu32 val;\n\tint ret;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] ====== S%d RCK ======\\n\", path);\n\n\trf_reg5 = rtw89_read_rf(rtwdev, path, RR_RSV1, RFREG_MASK);\n\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RR_RSV1_RST, 0x0);\n\trtw89_write_rf(rtwdev, path, RR_MOD, RR_MOD_MASK, RR_MOD_V_RX);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] RF0x00 = 0x%05x\\n\",\n\t\t    rtw89_read_rf(rtwdev, path, RR_MOD, RFREG_MASK));\n\n\t \n\trtw89_write_rf(rtwdev, path, RR_RCKC, RFREG_MASK, 0x00240);\n\n\tret = read_poll_timeout_atomic(rtw89_read_rf, val, val, 2, 30,\n\t\t\t\t       false, rtwdev, path, RR_RCKS, BIT(3));\n\n\trck_val = rtw89_read_rf(rtwdev, path, RR_RCKC, RR_RCKC_CA);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] rck_val = 0x%x, ret = %d\\n\",\n\t\t    rck_val, ret);\n\n\trtw89_write_rf(rtwdev, path, RR_RCKC, RFREG_MASK, rck_val);\n\trtw89_write_rf(rtwdev, path, RR_RSV1, RFREG_MASK, rf_reg5);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RCK] RF 0x1b = 0x%x\\n\",\n\t\t    rtw89_read_rf(rtwdev, path, RR_RCKC, RFREG_MASK));\n}\n\nstatic void _tssi_set_sys(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\trtw89_rfk_parser(rtwdev, &rtw8851b_tssi_sys_defs_tbl);\n\n\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t &rtw8851b_tssi_sys_a_defs_2g_tbl,\n\t\t\t\t &rtw8851b_tssi_sys_a_defs_5g_tbl);\n}\n\nstatic void _tssi_ini_txpwr_ctrl_bb(struct rtw89_dev *rtwdev,\n\t\t\t\t    enum rtw89_phy_idx phy,\n\t\t\t\t    enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8851b_tssi_init_txpwr_defs_a_tbl);\n}\n\nstatic void _tssi_ini_txpwr_ctrl_bb_he_tb(struct rtw89_dev *rtwdev,\n\t\t\t\t\t  enum rtw89_phy_idx phy,\n\t\t\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8851b_tssi_init_txpwr_he_tb_defs_a_tbl);\n}\n\nstatic void _tssi_set_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8851b_tssi_dck_defs_a_tbl);\n}\n\nstatic void _tssi_set_tmeter_tbl(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n#define RTW8851B_TSSI_GET_VAL(ptr, idx)\t\t\t\\\n({\t\t\t\t\t\t\t\\\n\ts8 *__ptr = (ptr);\t\t\t\t\\\n\tu8 __idx = (idx), __i, __v;\t\t\t\\\n\tu32 __val = 0;\t\t\t\t\t\\\n\tfor (__i = 0; __i < 4; __i++) {\t\t\t\\\n\t\t__v = (__ptr[__idx + __i]);\t\t\\\n\t\t__val |= (__v << (8 * __i));\t\t\\\n\t}\t\t\t\t\t\t\\\n\t__val;\t\t\t\t\t\t\\\n})\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu8 subband = chan->subband_type;\n\tconst s8 *thm_up_a = NULL;\n\tconst s8 *thm_down_a = NULL;\n\tu8 thermal = 0xff;\n\ts8 thm_ofst[64] = {0};\n\tu32 tmp = 0;\n\tu8 i, j;\n\n\tswitch (subband) {\n\tdefault:\n\tcase RTW89_CH_2G:\n\t\tthm_up_a = rtw89_8851b_trk_cfg.delta_swingidx_2ga_p;\n\t\tthm_down_a = rtw89_8851b_trk_cfg.delta_swingidx_2ga_n;\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_1:\n\t\tthm_up_a = rtw89_8851b_trk_cfg.delta_swingidx_5ga_p[0];\n\t\tthm_down_a = rtw89_8851b_trk_cfg.delta_swingidx_5ga_n[0];\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_3:\n\t\tthm_up_a = rtw89_8851b_trk_cfg.delta_swingidx_5ga_p[1];\n\t\tthm_down_a = rtw89_8851b_trk_cfg.delta_swingidx_5ga_n[1];\n\t\tbreak;\n\tcase RTW89_CH_5G_BAND_4:\n\t\tthm_up_a = rtw89_8851b_trk_cfg.delta_swingidx_5ga_p[2];\n\t\tthm_down_a = rtw89_8851b_trk_cfg.delta_swingidx_5ga_n[2];\n\t\tbreak;\n\t}\n\n\tif (path == RF_PATH_A) {\n\t\tthermal = tssi_info->thermal[RF_PATH_A];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] ch=%d thermal_pathA=0x%x\\n\", ch, thermal);\n\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER_DIS, 0x0);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER_TRK, 0x1);\n\n\t\tif (thermal == 0xff) {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER, 32);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_VAL, 32);\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\trtw89_phy_write32(rtwdev, R_P0_TSSI_BASE + i, 0x0);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    R_P0_TSSI_BASE + i, 0x0);\n\t\t\t}\n\n\t\t} else {\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_TMETER, B_P0_TMETER,\n\t\t\t\t\t       thermal);\n\t\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, B_P0_RFCTM_VAL,\n\t\t\t\t\t       thermal);\n\n\t\t\ti = 0;\n\t\t\tfor (j = 0; j < 32; j++)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      -thm_down_a[i++] :\n\t\t\t\t\t      -thm_down_a[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\ti = 1;\n\t\t\tfor (j = 63; j >= 32; j--)\n\t\t\t\tthm_ofst[j] = i < DELTA_SWINGIDX_SIZE ?\n\t\t\t\t\t      thm_up_a[i++] :\n\t\t\t\t\t      thm_up_a[DELTA_SWINGIDX_SIZE - 1];\n\n\t\t\tfor (i = 0; i < 64; i += 4) {\n\t\t\t\ttmp = RTW8851B_TSSI_GET_VAL(thm_ofst, i);\n\t\t\t\trtw89_phy_write32(rtwdev, R_P0_TSSI_BASE + i, tmp);\n\n\t\t\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t\t\t    \"[TSSI] write 0x%x val=0x%08x\\n\",\n\t\t\t\t\t    0x5c00 + i, tmp);\n\t\t\t}\n\t\t}\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, R_P0_RFCTM_RDY, 0x1);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_RFCTM, R_P0_RFCTM_RDY, 0x0);\n\t}\n#undef RTW8851B_TSSI_GET_VAL\n}\n\nstatic void _tssi_set_dac_gain_tbl(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t   enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8851b_tssi_dac_gain_defs_a_tbl);\n}\n\nstatic void _tssi_slope_cal_org(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\tenum rtw89_rf_path path)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t &rtw8851b_tssi_slope_a_defs_2g_tbl,\n\t\t\t\t &rtw8851b_tssi_slope_a_defs_5g_tbl);\n}\n\nstatic void _tssi_alignment_default(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t    enum rtw89_rf_path path, bool all)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tenum rtw89_band band = chan->band_type;\n\n\trtw89_rfk_parser_by_cond(rtwdev, band == RTW89_BAND_2G,\n\t\t\t\t &rtw8851b_tssi_align_a_2g_defs_tbl,\n\t\t\t\t &rtw8851b_tssi_align_a_5g_defs_tbl);\n}\n\nstatic void _tssi_set_tssi_slope(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8851b_tssi_slope_defs_a_tbl);\n}\n\nstatic void _tssi_set_tssi_track(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8851b_tssi_track_defs_a_tbl);\n}\n\nstatic void _tssi_set_txagc_offset_mv_avg(struct rtw89_dev *rtwdev,\n\t\t\t\t\t  enum rtw89_phy_idx phy,\n\t\t\t\t\t  enum rtw89_rf_path path)\n{\n\trtw89_rfk_parser(rtwdev, &rtw8851b_tssi_mv_avg_defs_a_tbl);\n}\n\nstatic void _tssi_enable(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\t_tssi_set_tssi_track(rtwdev, phy, RF_PATH_A);\n\t_tssi_set_txagc_offset_mv_avg(rtwdev, phy, RF_PATH_A);\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_MV_AVG, B_P0_TSSI_MV_CLR, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_AVG, B_P0_TSSI_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_AVG, B_P0_TSSI_EN, 0x1);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_TXGA_V1, RR_TXGA_V1_TRK_EN, 0x1);\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_RFC, 0x3);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT, 0xc0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x1);\n\n\trtwdev->is_tssi_mode[RF_PATH_A] = true;\n}\n\nstatic void _tssi_disable(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_AVG, B_P0_TSSI_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x1);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_MV_AVG, B_P0_TSSI_MV_CLR, 0x1);\n\n\trtwdev->is_tssi_mode[RF_PATH_A] = false;\n}\n\nstatic u32 _tssi_get_cck_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 2:\n\t\treturn 0;\n\tcase 3 ... 5:\n\t\treturn 1;\n\tcase 6 ... 8:\n\t\treturn 2;\n\tcase 9 ... 11:\n\t\treturn 3;\n\tcase 12 ... 13:\n\t\treturn 4;\n\tcase 14:\n\t\treturn 5;\n\t}\n\n\treturn 0;\n}\n\n#define TSSI_EXTRA_GROUP_BIT (BIT(31))\n#define TSSI_EXTRA_GROUP(idx) (TSSI_EXTRA_GROUP_BIT | (idx))\n#define IS_TSSI_EXTRA_GROUP(group) ((group) & TSSI_EXTRA_GROUP_BIT)\n#define TSSI_EXTRA_GET_GROUP_IDX1(group) ((group) & ~TSSI_EXTRA_GROUP_BIT)\n#define TSSI_EXTRA_GET_GROUP_IDX2(group) (TSSI_EXTRA_GET_GROUP_IDX1(group) + 1)\n\nstatic u32 _tssi_get_ofdm_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 2:\n\t\treturn 0;\n\tcase 3 ... 5:\n\t\treturn 1;\n\tcase 6 ... 8:\n\t\treturn 2;\n\tcase 9 ... 11:\n\t\treturn 3;\n\tcase 12 ... 14:\n\t\treturn 4;\n\tcase 36 ... 40:\n\t\treturn 5;\n\tcase 41 ... 43:\n\t\treturn TSSI_EXTRA_GROUP(5);\n\tcase 44 ... 48:\n\t\treturn 6;\n\tcase 49 ... 51:\n\t\treturn TSSI_EXTRA_GROUP(6);\n\tcase 52 ... 56:\n\t\treturn 7;\n\tcase 57 ... 59:\n\t\treturn TSSI_EXTRA_GROUP(7);\n\tcase 60 ... 64:\n\t\treturn 8;\n\tcase 100 ... 104:\n\t\treturn 9;\n\tcase 105 ... 107:\n\t\treturn TSSI_EXTRA_GROUP(9);\n\tcase 108 ... 112:\n\t\treturn 10;\n\tcase 113 ... 115:\n\t\treturn TSSI_EXTRA_GROUP(10);\n\tcase 116 ... 120:\n\t\treturn 11;\n\tcase 121 ... 123:\n\t\treturn TSSI_EXTRA_GROUP(11);\n\tcase 124 ... 128:\n\t\treturn 12;\n\tcase 129 ... 131:\n\t\treturn TSSI_EXTRA_GROUP(12);\n\tcase 132 ... 136:\n\t\treturn 13;\n\tcase 137 ... 139:\n\t\treturn TSSI_EXTRA_GROUP(13);\n\tcase 140 ... 144:\n\t\treturn 14;\n\tcase 149 ... 153:\n\t\treturn 15;\n\tcase 154 ... 156:\n\t\treturn TSSI_EXTRA_GROUP(15);\n\tcase 157 ... 161:\n\t\treturn 16;\n\tcase 162 ... 164:\n\t\treturn TSSI_EXTRA_GROUP(16);\n\tcase 165 ... 169:\n\t\treturn 17;\n\tcase 170 ... 172:\n\t\treturn TSSI_EXTRA_GROUP(17);\n\tcase 173 ... 177:\n\t\treturn 18;\n\t}\n\n\treturn 0;\n}\n\nstatic u32 _tssi_get_trim_group(struct rtw89_dev *rtwdev, u8 ch)\n{\n\tswitch (ch) {\n\tcase 1 ... 8:\n\t\treturn 0;\n\tcase 9 ... 14:\n\t\treturn 1;\n\tcase 36 ... 48:\n\t\treturn 2;\n\tcase 52 ... 64:\n\t\treturn 3;\n\tcase 100 ... 112:\n\t\treturn 4;\n\tcase 116 ... 128:\n\t\treturn 5;\n\tcase 132 ... 144:\n\t\treturn 6;\n\tcase 149 ... 177:\n\t\treturn 7;\n\t}\n\n\treturn 0;\n}\n\nstatic s8 _tssi_get_ofdm_de(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t    enum rtw89_rf_path path)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu32 gidx, gidx_1st, gidx_2nd;\n\tu8 ch = chan->channel;\n\ts8 de_1st;\n\ts8 de_2nd;\n\ts8 val;\n\n\tgidx = _tssi_get_ofdm_group(rtwdev, ch);\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t    \"[TSSI][TRIM]: path=%d mcs group_idx=0x%x\\n\", path, gidx);\n\n\tif (IS_TSSI_EXTRA_GROUP(gidx)) {\n\t\tgidx_1st = TSSI_EXTRA_GET_GROUP_IDX1(gidx);\n\t\tgidx_2nd = TSSI_EXTRA_GET_GROUP_IDX2(gidx);\n\t\tde_1st = tssi_info->tssi_mcs[path][gidx_1st];\n\t\tde_2nd = tssi_info->tssi_mcs[path][gidx_2nd];\n\t\tval = (de_1st + de_2nd) / 2;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs de=%d 1st=%d 2nd=%d\\n\",\n\t\t\t    path, val, de_1st, de_2nd);\n\t} else {\n\t\tval = tssi_info->tssi_mcs[path][gidx];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs de=%d\\n\", path, val);\n\t}\n\n\treturn val;\n}\n\nstatic s8 _tssi_get_ofdm_trim_de(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t\t\t enum rtw89_rf_path path)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu32 tgidx, tgidx_1st, tgidx_2nd;\n\tu8 ch = chan->channel;\n\ts8 tde_1st;\n\ts8 tde_2nd;\n\ts8 val;\n\n\ttgidx = _tssi_get_trim_group(rtwdev, ch);\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t    \"[TSSI][TRIM]: path=%d mcs trim_group_idx=0x%x\\n\",\n\t\t    path, tgidx);\n\n\tif (IS_TSSI_EXTRA_GROUP(tgidx)) {\n\t\ttgidx_1st = TSSI_EXTRA_GET_GROUP_IDX1(tgidx);\n\t\ttgidx_2nd = TSSI_EXTRA_GET_GROUP_IDX2(tgidx);\n\t\ttde_1st = tssi_info->tssi_trim[path][tgidx_1st];\n\t\ttde_2nd = tssi_info->tssi_trim[path][tgidx_2nd];\n\t\tval = (tde_1st + tde_2nd) / 2;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_de=%d 1st=%d 2nd=%d\\n\",\n\t\t\t    path, val, tde_1st, tde_2nd);\n\t} else {\n\t\tval = tssi_info->tssi_trim[path][tgidx];\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs trim_de=%d\\n\",\n\t\t\t    path, val);\n\t}\n\n\treturn val;\n}\n\nstatic void _tssi_set_efuse_to_de(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 ch = chan->channel;\n\tu8 gidx;\n\ts8 ofdm_de;\n\ts8 trim_de;\n\ts32 val;\n\tu32 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI][TRIM]: phy=%d ch=%d\\n\",\n\t\t    phy, ch);\n\n\tfor (i = RF_PATH_A; i < RTW8851B_TSSI_PATH_NR; i++) {\n\t\tgidx = _tssi_get_cck_group(rtwdev, ch);\n\t\ttrim_de = _tssi_get_ofdm_trim_de(rtwdev, phy, i);\n\t\tval = tssi_info->tssi_cck[i][gidx] + trim_de;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d cck[%d]=0x%x trim=0x%x\\n\",\n\t\t\t    i, gidx, tssi_info->tssi_cck[i][gidx], trim_de);\n\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_cck_long[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_cck_short[i], _TSSI_DE_MASK, val);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] Set TSSI CCK DE 0x%x[21:12]=0x%x\\n\",\n\t\t\t    _tssi_de_cck_long[i],\n\t\t\t    rtw89_phy_read32_mask(rtwdev, _tssi_de_cck_long[i],\n\t\t\t\t\t\t  _TSSI_DE_MASK));\n\n\t\tofdm_de = _tssi_get_ofdm_de(rtwdev, phy, i);\n\t\ttrim_de = _tssi_get_ofdm_trim_de(rtwdev, phy, i);\n\t\tval = ofdm_de + trim_de;\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI][TRIM]: path=%d mcs=0x%x trim=0x%x\\n\",\n\t\t\t    i, ofdm_de, trim_de);\n\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_20m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_40m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_80m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_80m_80m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_5m[i], _TSSI_DE_MASK, val);\n\t\trtw89_phy_write32_mask(rtwdev, _tssi_de_mcs_10m[i], _TSSI_DE_MASK, val);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_TSSI,\n\t\t\t    \"[TSSI] Set TSSI MCS DE 0x%x[21:12]=0x%x\\n\",\n\t\t\t    _tssi_de_mcs_20m[i],\n\t\t\t    rtw89_phy_read32_mask(rtwdev, _tssi_de_mcs_20m[i],\n\t\t\t\t\t\t  _TSSI_DE_MASK));\n\t}\n}\n\nstatic void _tssi_alimentk_dump_result(struct rtw89_dev *rtwdev, enum rtw89_rf_path path)\n{\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[TSSI PA K]\\n0x%x = 0x%08x\\n0x%x = 0x%08x\\n0x%x = 0x%08x\\n0x%x = 0x%08x\\n\"\n\t\t    \"0x%x = 0x%08x\\n0x%x = 0x%08x\\n0x%x = 0x%08x\\n0x%x = 0x%08x\\n\",\n\t\t    R_TSSI_PA_K1 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TSSI_PA_K1 + (path << 13), MASKDWORD),\n\t\t    R_TSSI_PA_K2 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TSSI_PA_K2 + (path << 13), MASKDWORD),\n\t\t    R_P0_TSSI_ALIM1 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM1 + (path << 13), MASKDWORD),\n\t\t    R_P0_TSSI_ALIM3 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM3 + (path << 13), MASKDWORD),\n\t\t    R_TSSI_PA_K5 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TSSI_PA_K5 + (path << 13), MASKDWORD),\n\t\t    R_P0_TSSI_ALIM2 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM2 + (path << 13), MASKDWORD),\n\t\t    R_P0_TSSI_ALIM4 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_ALIM4 + (path << 13), MASKDWORD),\n\t\t    R_TSSI_PA_K8 + (path << 13),\n\t\t    rtw89_phy_read32_mask(rtwdev, R_TSSI_PA_K8 + (path << 13), MASKDWORD));\n}\n\nstatic void _tssi_alimentk_done(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_phy_idx phy, enum rtw89_rf_path path)\n{\n\tstruct rtw89_tssi_info *tssi_info = &rtwdev->tssi;\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 channel = chan->channel;\n\tu8 band;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======>%s   phy=%d   path=%d\\n\", __func__, phy, path);\n\n\tif (channel >= 1 && channel <= 14)\n\t\tband = TSSI_ALIMK_2G;\n\telse if (channel >= 36 && channel <= 64)\n\t\tband = TSSI_ALIMK_5GL;\n\telse if (channel >= 100 && channel <= 144)\n\t\tband = TSSI_ALIMK_5GM;\n\telse if (channel >= 149 && channel <= 177)\n\t\tband = TSSI_ALIMK_5GH;\n\telse\n\t\tband = TSSI_ALIMK_2G;\n\n\tif (tssi_info->alignment_done[path][band]) {\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM1 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_value[path][band][0]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM3 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_value[path][band][1]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM2 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_value[path][band][2]);\n\t\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_ALIM4 + (path << 13), MASKDWORD,\n\t\t\t\t       tssi_info->alignment_value[path][band][3]);\n\t}\n\n\t_tssi_alimentk_dump_result(rtwdev, path);\n}\n\nstatic void rtw8851b_by_rate_dpd(struct rtw89_dev *rtwdev)\n{\n\trtw89_write32_mask(rtwdev, R_AX_PWR_SWING_OTHER_CTRL0,\n\t\t\t   B_AX_CFIR_BY_RATE_OFF_MASK, 0x21861);\n}\n\nvoid rtw8851b_dpk_init(struct rtw89_dev *rtwdev)\n{\n\trtw8851b_by_rate_dpd(rtwdev);\n}\n\nvoid rtw8851b_aack(struct rtw89_dev *rtwdev)\n{\n\tu32 tmp05, tmpd3, ib[4];\n\tu32 tmp;\n\tint ret;\n\tint rek;\n\tint i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]DO AACK\\n\");\n\n\ttmp05 = rtw89_read_rf(rtwdev, RF_PATH_A, RR_RSV1, RFREG_MASK);\n\ttmpd3 = rtw89_read_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RFREG_MASK);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RR_MOD_MASK, 0x3);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RFREG_MASK, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RR_LCK_ST, 0x0);\n\n\tfor (rek = 0; rek < 4; rek++) {\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_AACK, RFREG_MASK, 0x8201e);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_AACK, RFREG_MASK, 0x8201f);\n\t\tfsleep(100);\n\n\t\tret = read_poll_timeout_atomic(rtw89_read_rf, tmp, tmp,\n\t\t\t\t\t       1, 1000, false,\n\t\t\t\t\t       rtwdev, RF_PATH_A, 0xd0, BIT(16));\n\t\tif (ret)\n\t\t\trtw89_warn(rtwdev, \"[LCK]AACK timeout\\n\");\n\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_VCI, RR_VCI_ON, 0x1);\n\t\tfor (i = 0; i < 4; i++) {\n\t\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_VCO, RR_VCO_SEL, i);\n\t\t\tib[i] = rtw89_read_rf(rtwdev, RF_PATH_A, RR_IBD, RR_IBD_VAL);\n\t\t}\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_VCI, RR_VCI_ON, 0x0);\n\n\t\tif (ib[0] != 0 && ib[1] != 0 && ib[2] != 0 && ib[3] != 0)\n\t\t\tbreak;\n\t}\n\n\tif (rek != 0)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]AACK rek = %d\\n\", rek);\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RFREG_MASK, tmp05);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RFREG_MASK, tmpd3);\n}\n\nstatic void _lck_keep_thermal(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_lck_info *lck = &rtwdev->lck;\n\n\tlck->thermal[RF_PATH_A] =\n\t\tewma_thermal_read(&rtwdev->phystat.avg_thermal[RF_PATH_A]);\n\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t    \"[LCK] path=%d thermal=0x%x\", RF_PATH_A, lck->thermal[RF_PATH_A]);\n}\n\nstatic void rtw8851b_lck(struct rtw89_dev *rtwdev)\n{\n\tu32 tmp05, tmp18, tmpd3;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]DO LCK\\n\");\n\n\ttmp05 = rtw89_read_rf(rtwdev, RF_PATH_A, RR_RSV1, RFREG_MASK);\n\ttmp18 = rtw89_read_rf(rtwdev, RF_PATH_A, RR_CFGCH, RFREG_MASK);\n\ttmpd3 = rtw89_read_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RFREG_MASK);\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MOD, RR_MOD_MASK, 0x3);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RFREG_MASK, 0x0);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RR_LCK_TRGSEL, 0x1);\n\n\t_set_ch(rtwdev, tmp18);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RFREG_MASK, tmpd3);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_RSV1, RFREG_MASK, tmp05);\n\n\t_lck_keep_thermal(rtwdev);\n}\n\n#define RTW8851B_LCK_TH 8\n\nvoid rtw8851b_lck_track(struct rtw89_dev *rtwdev)\n{\n\tstruct rtw89_lck_info *lck = &rtwdev->lck;\n\tu8 cur_thermal;\n\tint delta;\n\n\tcur_thermal =\n\t\tewma_thermal_read(&rtwdev->phystat.avg_thermal[RF_PATH_A]);\n\tdelta = abs((int)cur_thermal - lck->thermal[RF_PATH_A]);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK_TRACK,\n\t\t    \"[LCK] path=%d current thermal=0x%x delta=0x%x\\n\",\n\t\t    RF_PATH_A, cur_thermal, delta);\n\n\tif (delta >= RTW8851B_LCK_TH) {\n\t\trtw8851b_aack(rtwdev);\n\t\trtw8851b_lck(rtwdev);\n\t}\n}\n\nvoid rtw8851b_lck_init(struct rtw89_dev *rtwdev)\n{\n\t_lck_keep_thermal(rtwdev);\n}\n\nvoid rtw8851b_rck(struct rtw89_dev *rtwdev)\n{\n\t_rck(rtwdev, RF_PATH_A);\n}\n\nvoid rtw8851b_dack(struct rtw89_dev *rtwdev)\n{\n\t_dac_cal(rtwdev, false);\n}\n\nvoid rtw8851b_iqk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\tu32 tx_en;\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\t_iqk_init(rtwdev);\n\t_iqk(rtwdev, phy_idx, false);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_STOP);\n}\n\nvoid rtw8851b_rx_dck(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\tu32 tx_en;\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_RXDCK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\t_rx_dck(rtwdev, phy_idx, false);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_RXDCK, BTC_WRFK_STOP);\n}\n\nvoid rtw8851b_dpk(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy_idx)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy_idx, 0);\n\tu32 tx_en;\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_START);\n\trtw89_chip_stop_sch_tx(rtwdev, phy_idx, &tx_en, RTW89_SCH_TX_SEL_ALL);\n\t_wait_rx_mode(rtwdev, _kpath(rtwdev, phy_idx));\n\n\trtwdev->dpk.is_dpk_enable = true;\n\trtwdev->dpk.is_dpk_reload_en = false;\n\t_dpk(rtwdev, phy_idx, false);\n\n\trtw89_chip_resume_sch_tx(rtwdev, phy_idx, tx_en);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_DPK, BTC_WRFK_STOP);\n}\n\nvoid rtw8851b_dpk_track(struct rtw89_dev *rtwdev)\n{\n\t_dpk_track(rtwdev);\n}\n\nvoid rtw8851b_tssi(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy, bool hwtx_en)\n{\n\tu8 phy_map = rtw89_btc_phymap(rtwdev, phy, RF_A);\n\tu8 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_TSSI, \"[TSSI] %s: phy=%d\\n\", __func__, phy);\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_START);\n\n\t_tssi_disable(rtwdev, phy);\n\n\tfor (i = RF_PATH_A; i < RF_PATH_NUM_8851B; i++) {\n\t\t_tssi_set_sys(rtwdev, phy, i);\n\t\t_tssi_ini_txpwr_ctrl_bb(rtwdev, phy, i);\n\t\t_tssi_ini_txpwr_ctrl_bb_he_tb(rtwdev, phy, i);\n\t\t_tssi_set_dck(rtwdev, phy, i);\n\t\t_tssi_set_tmeter_tbl(rtwdev, phy, i);\n\t\t_tssi_set_dac_gain_tbl(rtwdev, phy, i);\n\t\t_tssi_slope_cal_org(rtwdev, phy, i);\n\t\t_tssi_alignment_default(rtwdev, phy, i, true);\n\t\t_tssi_set_tssi_slope(rtwdev, phy, i);\n\t}\n\n\t_tssi_enable(rtwdev, phy);\n\t_tssi_set_efuse_to_de(rtwdev, phy);\n\n\trtw89_btc_ntfy_wl_rfk(rtwdev, phy_map, BTC_WRFKT_IQK, BTC_WRFK_ONESHOT_STOP);\n}\n\nvoid rtw8851b_tssi_scan(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 channel = chan->channel;\n\tu32 i;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======>%s   phy=%d  channel=%d\\n\", __func__, phy, channel);\n\n\t_tssi_disable(rtwdev, phy);\n\n\tfor (i = RF_PATH_A; i < RF_PATH_NUM_8851B; i++) {\n\t\t_tssi_set_sys(rtwdev, phy, i);\n\t\t_tssi_set_tmeter_tbl(rtwdev, phy, i);\n\t\t_tssi_slope_cal_org(rtwdev, phy, i);\n\t\t_tssi_alignment_default(rtwdev, phy, i, true);\n\t}\n\n\t_tssi_enable(rtwdev, phy);\n\t_tssi_set_efuse_to_de(rtwdev, phy);\n}\n\nstatic void rtw8851b_tssi_default_txagc(struct rtw89_dev *rtwdev,\n\t\t\t\t\tenum rtw89_phy_idx phy, bool enable)\n{\n\tconst struct rtw89_chan *chan = rtw89_chan_get(rtwdev, RTW89_SUB_ENTITY_0);\n\tu8 channel = chan->channel;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"======> %s   ch=%d\\n\",\n\t\t    __func__, channel);\n\n\tif (enable)\n\t\treturn;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======>%s 1 SCAN_END Set 0x5818[7:0]=0x%x\\n\",\n\t\t    __func__,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT));\n\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT, 0xc0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x0);\n\trtw89_phy_write32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT_EN, 0x1);\n\n\t_tssi_alimentk_done(rtwdev, phy, RF_PATH_A);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======>%s 2 SCAN_END Set 0x5818[7:0]=0x%x\\n\",\n\t\t    __func__,\n\t\t    rtw89_phy_read32_mask(rtwdev, R_P0_TSSI_TRK, B_P0_TSSI_OFT));\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"======> %s   SCAN_END\\n\", __func__);\n}\n\nvoid rtw8851b_wifi_scan_notify(struct rtw89_dev *rtwdev, bool scan_start,\n\t\t\t       enum rtw89_phy_idx phy_idx)\n{\n\tif (scan_start)\n\t\trtw8851b_tssi_default_txagc(rtwdev, phy_idx, true);\n\telse\n\t\trtw8851b_tssi_default_txagc(rtwdev, phy_idx, false);\n}\n\nstatic void _bw_setting(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t\tenum rtw89_bandwidth bw, bool dav)\n{\n\tu32 reg18_addr = dav ? RR_CFGCH : RR_CFGCH_V1;\n\tu32 rf_reg18;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]===> %s\\n\", __func__);\n\n\trf_reg18 = rtw89_read_rf(rtwdev, path, reg18_addr, RFREG_MASK);\n\tif (rf_reg18 == INV_RF_DATA) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t\t    \"[RFK]Invalid RF_0x18 for Path-%d\\n\", path);\n\t\treturn;\n\t}\n\trf_reg18 &= ~RR_CFGCH_BW;\n\n\tswitch (bw) {\n\tcase RTW89_CHANNEL_WIDTH_5:\n\tcase RTW89_CHANNEL_WIDTH_10:\n\tcase RTW89_CHANNEL_WIDTH_20:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BW, CFGCH_BW_20M);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_40:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BW, CFGCH_BW_40M);\n\t\tbreak;\n\tcase RTW89_CHANNEL_WIDTH_80:\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BW, CFGCH_BW_80M);\n\t\tbreak;\n\tdefault:\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]Fail to set CH\\n\");\n\t}\n\n\trf_reg18 &= ~(RR_CFGCH_POW_LCK | RR_CFGCH_TRX_AH | RR_CFGCH_BCN |\n\t\t      RR_CFGCH_BW2) & RFREG_MASK;\n\trf_reg18 |= RR_CFGCH_BW2;\n\trtw89_write_rf(rtwdev, path, reg18_addr, RFREG_MASK, rf_reg18);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK] set %x at path%d, %x =0x%x\\n\",\n\t\t    bw, path, reg18_addr,\n\t\t    rtw89_read_rf(rtwdev, path, reg18_addr, RFREG_MASK));\n}\n\nstatic void _ctrl_bw(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t     enum rtw89_bandwidth bw)\n{\n\t_bw_setting(rtwdev, RF_PATH_A, bw, true);\n\t_bw_setting(rtwdev, RF_PATH_A, bw, false);\n}\n\nstatic bool _set_s0_arfc18(struct rtw89_dev *rtwdev, u32 val)\n{\n\tu32 bak;\n\tu32 tmp;\n\tint ret;\n\n\tbak = rtw89_read_rf(rtwdev, RF_PATH_A, RR_LDO, RFREG_MASK);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LDO, RR_LDO_SEL, 0x1);\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_CFGCH, RFREG_MASK, val);\n\n\tret = read_poll_timeout_atomic(rtw89_read_rf, tmp, tmp == 0, 1, 1000,\n\t\t\t\t       false, rtwdev, RF_PATH_A, RR_LPF, RR_LPF_BUSY);\n\tif (ret)\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]LCK timeout\\n\");\n\n\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LDO, RFREG_MASK, bak);\n\n\treturn !!ret;\n}\n\nstatic void _lck_check(struct rtw89_dev *rtwdev)\n{\n\tu32 tmp;\n\n\tif (rtw89_read_rf(rtwdev, RF_PATH_A, RR_SYNFB, RR_SYNFB_LK) == 0) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]SYN MMD reset\\n\");\n\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MMD, RR_MMD_RST_EN, 0x1);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MMD, RR_MMD_RST_SYN, 0x0);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MMD, RR_MMD_RST_SYN, 0x1);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_MMD, RR_MMD_RST_EN, 0x0);\n\t}\n\n\tudelay(10);\n\n\tif (rtw89_read_rf(rtwdev, RF_PATH_A, RR_SYNFB, RR_SYNFB_LK) == 0) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]re-set RF 0x18\\n\");\n\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RR_LCK_TRGSEL, 0x1);\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_A, RR_CFGCH, RFREG_MASK);\n\t\t_set_s0_arfc18(rtwdev, tmp);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RR_LCK_TRGSEL, 0x0);\n\t}\n\n\tif (rtw89_read_rf(rtwdev, RF_PATH_A, RR_SYNFB, RR_SYNFB_LK) == 0) {\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]SYN off/on\\n\");\n\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_A, RR_POW, RFREG_MASK);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_POW, RFREG_MASK, tmp);\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_A, RR_SX, RFREG_MASK);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_SX, RFREG_MASK, tmp);\n\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_SYNLUT, RR_SYNLUT_MOD, 0x1);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_POW, RR_POW_SYN, 0x0);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_POW, RR_POW_SYN, 0x3);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_SYNLUT, RR_SYNLUT_MOD, 0x0);\n\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RR_LCK_TRGSEL, 0x1);\n\t\ttmp = rtw89_read_rf(rtwdev, RF_PATH_A, RR_CFGCH, RFREG_MASK);\n\t\t_set_s0_arfc18(rtwdev, tmp);\n\t\trtw89_write_rf(rtwdev, RF_PATH_A, RR_LCK_TRG, RR_LCK_TRGSEL, 0x0);\n\n\t\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[LCK]0xb2=%x, 0xc5=%x\\n\",\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_VCO, RFREG_MASK),\n\t\t\t    rtw89_read_rf(rtwdev, RF_PATH_A, RR_SYNFB, RFREG_MASK));\n\t}\n}\n\nstatic void _set_ch(struct rtw89_dev *rtwdev, u32 val)\n{\n\tbool timeout;\n\n\ttimeout = _set_s0_arfc18(rtwdev, val);\n\tif (!timeout)\n\t\t_lck_check(rtwdev);\n}\n\nstatic void _ch_setting(struct rtw89_dev *rtwdev, enum rtw89_rf_path path,\n\t\t\tu8 central_ch, bool dav)\n{\n\tu32 reg18_addr = dav ? RR_CFGCH : RR_CFGCH_V1;\n\tbool is_2g_ch = central_ch <= 14;\n\tu32 rf_reg18;\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK]===> %s\\n\", __func__);\n\n\trf_reg18 = rtw89_read_rf(rtwdev, path, reg18_addr, RFREG_MASK);\n\trf_reg18 &= ~(RR_CFGCH_BAND1 | RR_CFGCH_POW_LCK | RR_CFGCH_TRX_AH |\n\t\t      RR_CFGCH_BCN | RR_CFGCH_BAND0 | RR_CFGCH_CH);\n\trf_reg18 |= FIELD_PREP(RR_CFGCH_CH, central_ch);\n\n\tif (!is_2g_ch)\n\t\trf_reg18 |= FIELD_PREP(RR_CFGCH_BAND1, CFGCH_BAND1_5G) |\n\t\t\t    FIELD_PREP(RR_CFGCH_BAND0, CFGCH_BAND0_5G);\n\n\trf_reg18 &= ~(RR_CFGCH_POW_LCK | RR_CFGCH_TRX_AH | RR_CFGCH_BCN |\n\t\t      RR_CFGCH_BW2) & RFREG_MASK;\n\trf_reg18 |= RR_CFGCH_BW2;\n\n\tif (path == RF_PATH_A && dav)\n\t\t_set_ch(rtwdev, rf_reg18);\n\telse\n\t\trtw89_write_rf(rtwdev, path, reg18_addr, RFREG_MASK, rf_reg18);\n\n\trtw89_write_rf(rtwdev, path, RR_LCKST, RR_LCKST_BIN, 0);\n\trtw89_write_rf(rtwdev, path, RR_LCKST, RR_LCKST_BIN, 1);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK,\n\t\t    \"[RFK]CH: %d for Path-%d, reg0x%x = 0x%x\\n\",\n\t\t    central_ch, path, reg18_addr,\n\t\t    rtw89_read_rf(rtwdev, path, reg18_addr, RFREG_MASK));\n}\n\nstatic void _ctrl_ch(struct rtw89_dev *rtwdev, u8 central_ch)\n{\n\t_ch_setting(rtwdev, RF_PATH_A, central_ch, true);\n\t_ch_setting(rtwdev, RF_PATH_A, central_ch, false);\n}\n\nstatic void _set_rxbb_bw(struct rtw89_dev *rtwdev, enum rtw89_bandwidth bw,\n\t\t\t enum rtw89_rf_path path)\n{\n\trtw89_write_rf(rtwdev, path, RR_LUTWE2, RR_LUTWE2_RTXBW, 0x1);\n\trtw89_write_rf(rtwdev, path, RR_LUTWA, RR_LUTWA_M2, 0x12);\n\n\tif (bw == RTW89_CHANNEL_WIDTH_20)\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB, 0x1b);\n\telse if (bw == RTW89_CHANNEL_WIDTH_40)\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB, 0x13);\n\telse if (bw == RTW89_CHANNEL_WIDTH_80)\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB, 0xb);\n\telse\n\t\trtw89_write_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB, 0x3);\n\n\trtw89_debug(rtwdev, RTW89_DBG_RFK, \"[RFK] set S%d RXBB BW 0x3F = 0x%x\\n\", path,\n\t\t    rtw89_read_rf(rtwdev, path, RR_LUTWD0, RR_LUTWD0_LB));\n\n\trtw89_write_rf(rtwdev, path, RR_LUTWE2, RR_LUTWE2_RTXBW, 0x0);\n}\n\nstatic void _rxbb_bw(struct rtw89_dev *rtwdev, enum rtw89_phy_idx phy,\n\t\t     enum rtw89_bandwidth bw)\n{\n\tu8 kpath, path;\n\n\tkpath = _kpath(rtwdev, phy);\n\n\tfor (path = 0; path < RF_PATH_NUM_8851B; path++) {\n\t\tif (!(kpath & BIT(path)))\n\t\t\tcontinue;\n\n\t\t_set_rxbb_bw(rtwdev, bw, path);\n\t}\n}\n\nstatic void rtw8851b_ctrl_bw_ch(struct rtw89_dev *rtwdev,\n\t\t\t\tenum rtw89_phy_idx phy, u8 central_ch,\n\t\t\t\tenum rtw89_band band, enum rtw89_bandwidth bw)\n{\n\t_ctrl_ch(rtwdev, central_ch);\n\t_ctrl_bw(rtwdev, phy, bw);\n\t_rxbb_bw(rtwdev, phy, bw);\n}\n\nvoid rtw8851b_set_channel_rf(struct rtw89_dev *rtwdev,\n\t\t\t     const struct rtw89_chan *chan,\n\t\t\t     enum rtw89_phy_idx phy_idx)\n{\n\trtw8851b_ctrl_bw_ch(rtwdev, phy_idx, chan->channel, chan->band_type,\n\t\t\t    chan->band_width);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}