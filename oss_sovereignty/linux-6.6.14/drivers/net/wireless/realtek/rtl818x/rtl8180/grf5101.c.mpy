{
  "module_name": "grf5101.c",
  "hash_id": "e6de4663255796b32a2f18699be90993b2d4b64dc644c18c74454946f9b244c8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtl818x/rtl8180/grf5101.c",
  "human_readable_source": "\n\n \n\n#include <linux/pci.h>\n#include <linux/delay.h>\n#include <net/mac80211.h>\n\n#include \"rtl8180.h\"\n#include \"grf5101.h\"\n\nstatic const int grf5101_encode[] = {\n\t0x0, 0x8, 0x4, 0xC,\n\t0x2, 0xA, 0x6, 0xE,\n\t0x1, 0x9, 0x5, 0xD,\n\t0x3, 0xB, 0x7, 0xF\n};\n\nstatic void write_grf5101(struct ieee80211_hw *dev, u8 addr, u32 data)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tu32 phy_config;\n\n\tphy_config =  grf5101_encode[(data >> 8) & 0xF];\n\tphy_config |= grf5101_encode[(data >> 4) & 0xF] << 4;\n\tphy_config |= grf5101_encode[data & 0xF] << 8;\n\tphy_config |= grf5101_encode[(addr >> 1) & 0xF] << 12;\n\tphy_config |= (addr & 1) << 16;\n\tphy_config |= grf5101_encode[(data & 0xf000) >> 12] << 24;\n\n\t \n\tphy_config |= 0x90000000;\n\n\trtl818x_iowrite32(priv,\n\t\t(__le32 __iomem *) &priv->map->RFPinsOutput, phy_config);\n\n\tmsleep(3);\n}\n\nstatic void grf5101_write_phy_antenna(struct ieee80211_hw *dev, short chan)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tu8 ant = GRF5101_ANTENNA;\n\n\tif (priv->rfparam & RF_PARAM_ANTBDEFAULT)\n\t\tant |= BB_ANTENNA_B;\n\n\tif (chan == 14)\n\t\tant |= BB_ANTATTEN_CHAN14;\n\n\trtl8180_write_phy(dev, 0x10, ant);\n}\n\nstatic u8 grf5101_rf_calc_rssi(u8 agc, u8 sq)\n{\n\tif (agc > 60)\n\t\treturn 65;\n\n\t \n\treturn 65 * agc / 60;\n}\n\nstatic void grf5101_rf_set_channel(struct ieee80211_hw *dev,\n\t\t\t\t   struct ieee80211_conf *conf)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tint channel =\n\t\tieee80211_frequency_to_channel(conf->chandef.chan->center_freq);\n\tu32 txpw = priv->channels[channel - 1].hw_value & 0xFF;\n\tu32 chan = channel - 1;\n\n\t \n\twrite_grf5101(dev, 0x15, 0x0);\n\twrite_grf5101(dev, 0x06, txpw);\n\twrite_grf5101(dev, 0x15, 0x10);\n\twrite_grf5101(dev, 0x15, 0x0);\n\n\t \n\twrite_grf5101(dev, 0x07, 0x0);\n\twrite_grf5101(dev, 0x0B, chan);\n\twrite_grf5101(dev, 0x07, 0x1000);\n\n\tgrf5101_write_phy_antenna(dev, channel);\n}\n\nstatic void grf5101_rf_stop(struct ieee80211_hw *dev)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tu32 anaparam;\n\n\tanaparam = priv->anaparam;\n\tanaparam &= 0x000fffff;\n\tanaparam |= 0x3f900000;\n\trtl8180_set_anaparam(priv, anaparam);\n\n\twrite_grf5101(dev, 0x07, 0x0);\n\twrite_grf5101(dev, 0x1f, 0x45);\n\twrite_grf5101(dev, 0x1f, 0x5);\n\twrite_grf5101(dev, 0x00, 0x8e4);\n}\n\nstatic void grf5101_rf_init(struct ieee80211_hw *dev)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\n\trtl8180_set_anaparam(priv, priv->anaparam);\n\n\twrite_grf5101(dev, 0x1f, 0x0);\n\twrite_grf5101(dev, 0x1f, 0x0);\n\twrite_grf5101(dev, 0x1f, 0x40);\n\twrite_grf5101(dev, 0x1f, 0x60);\n\twrite_grf5101(dev, 0x1f, 0x61);\n\twrite_grf5101(dev, 0x1f, 0x61);\n\twrite_grf5101(dev, 0x00, 0xae4);\n\twrite_grf5101(dev, 0x1f, 0x1);\n\twrite_grf5101(dev, 0x1f, 0x41);\n\twrite_grf5101(dev, 0x1f, 0x61);\n\n\twrite_grf5101(dev, 0x01, 0x1a23);\n\twrite_grf5101(dev, 0x02, 0x4971);\n\twrite_grf5101(dev, 0x03, 0x41de);\n\twrite_grf5101(dev, 0x04, 0x2d80);\n\twrite_grf5101(dev, 0x05, 0x68ff);\t \n\twrite_grf5101(dev, 0x06, 0x0);\n\twrite_grf5101(dev, 0x07, 0x0);\n\twrite_grf5101(dev, 0x08, 0x7533);\n\twrite_grf5101(dev, 0x09, 0xc401);\n\twrite_grf5101(dev, 0x0a, 0x0);\n\twrite_grf5101(dev, 0x0c, 0x1c7);\n\twrite_grf5101(dev, 0x0d, 0x29d3);\n\twrite_grf5101(dev, 0x0e, 0x2e8);\n\twrite_grf5101(dev, 0x10, 0x192);\n\twrite_grf5101(dev, 0x11, 0x248);\n\twrite_grf5101(dev, 0x12, 0x0);\n\twrite_grf5101(dev, 0x13, 0x20c4);\n\twrite_grf5101(dev, 0x14, 0xf4fc);\n\twrite_grf5101(dev, 0x15, 0x0);\n\twrite_grf5101(dev, 0x16, 0x1500);\n\n\twrite_grf5101(dev, 0x07, 0x1000);\n\n\t \n\trtl8180_write_phy(dev, 0, 0xa8);\n\trtl8180_write_phy(dev, 3, 0x0);\n\trtl8180_write_phy(dev, 4, 0xc0);\n\trtl8180_write_phy(dev, 5, 0x90);\n\trtl8180_write_phy(dev, 6, 0x1e);\n\trtl8180_write_phy(dev, 7, 0x64);\n\n\tgrf5101_write_phy_antenna(dev, 1);\n\n\trtl8180_write_phy(dev, 0x11, 0x88);\n\n\tif (rtl818x_ioread8(priv, &priv->map->CONFIG2) &\n\t    RTL818X_CONFIG2_ANTENNA_DIV)\n\t\trtl8180_write_phy(dev, 0x12, 0xc0);  \n\telse\n\t\trtl8180_write_phy(dev, 0x12, 0x40);  \n\n\trtl8180_write_phy(dev, 0x13, 0x90 | priv->csthreshold);\n\n\trtl8180_write_phy(dev, 0x19, 0x0);\n\trtl8180_write_phy(dev, 0x1a, 0xa0);\n\trtl8180_write_phy(dev, 0x1b, 0x44);\n}\n\nconst struct rtl818x_rf_ops grf5101_rf_ops = {\n\t.name\t\t= \"GCT\",\n\t.init\t\t= grf5101_rf_init,\n\t.stop\t\t= grf5101_rf_stop,\n\t.set_chan\t= grf5101_rf_set_channel,\n\t.calc_rssi\t= grf5101_rf_calc_rssi,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}