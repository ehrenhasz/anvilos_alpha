{
  "module_name": "rtl8225se.c",
  "hash_id": "96ba3f12bf1bfaa35beb5d1587d97afdca5145dba4eac9c747352ce6c7a1ae79",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtl818x/rtl8180/rtl8225se.c",
  "human_readable_source": "\n\n \n\n#include <net/mac80211.h>\n\n#include \"rtl8180.h\"\n#include \"rtl8225se.h\"\n\n#define PFX \"rtl8225 (se) \"\n\nstatic const u32 RF_GAIN_TABLE[] = {\n\t0x0096, 0x0076, 0x0056, 0x0036, 0x0016, 0x01f6, 0x01d6, 0x01b6,\n\t0x0196, 0x0176, 0x00F7, 0x00D7, 0x00B7, 0x0097, 0x0077, 0x0057,\n\t0x0037, 0x00FB, 0x00DB, 0x00BB, 0x00FF, 0x00E3, 0x00C3, 0x00A3,\n\t0x0083, 0x0063, 0x0043, 0x0023, 0x0003, 0x01E3, 0x01C3, 0x01A3,\n\t0x0183, 0x0163, 0x0143, 0x0123, 0x0103\n};\n\nstatic const u8 cck_ofdm_gain_settings[] = {\n\t0x00, 0x01, 0x02, 0x03, 0x04, 0x05,\n\t0x06, 0x07, 0x08, 0x09, 0x0a, 0x0b,\n\t0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11,\n\t0x12, 0x13, 0x14, 0x15, 0x16, 0x17,\n\t0x18, 0x19, 0x1a, 0x1b, 0x1c, 0x1d,\n\t0x1e, 0x1f, 0x20, 0x21, 0x22, 0x23,\n};\n\nstatic const u32 rtl8225se_chan[] = {\n\t0x0080, 0x0100, 0x0180, 0x0200, 0x0280, 0x0300, 0x0380,\n\t0x0400, 0x0480, 0x0500, 0x0580, 0x0600, 0x0680, 0x074A,\n};\n\nstatic const u8 ZEBRA_AGC[] = {\n\t0x7E, 0x7E, 0x7E, 0x7E, 0x7D, 0x7C, 0x7B, 0x7A,\n\t0x79, 0x78, 0x77, 0x76, 0x75, 0x74, 0x73, 0x72,\n\t0x71, 0x70, 0x6F, 0x6E, 0x6D, 0x6C, 0x6B, 0x6A,\n\t0x69, 0x68, 0x67, 0x66, 0x65, 0x64, 0x63, 0x62,\n\t0x48, 0x47, 0x46, 0x45, 0x44, 0x29, 0x28, 0x27,\n\t0x26, 0x25, 0x24, 0x23, 0x22, 0x21, 0x08, 0x07,\n\t0x06, 0x05, 0x04, 0x03, 0x02, 0x01, 0x00, 0x00,\n\t0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\n\t0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f, 0x0f,\n\t0x0f, 0x0f, 0x10, 0x11, 0x12, 0x13, 0x15, 0x16,\n\t0x17, 0x17, 0x18, 0x18, 0x19, 0x1a, 0x1a, 0x1b,\n\t0x1b, 0x1c, 0x1c, 0x1d, 0x1d, 0x1d, 0x1e, 0x1e,\n\t0x1f, 0x1f, 0x1f, 0x20, 0x20, 0x20, 0x20, 0x21,\n\t0x21, 0x21, 0x22, 0x22, 0x22, 0x23, 0x23, 0x24,\n\t0x24, 0x25, 0x25, 0x25, 0x26, 0x26, 0x27, 0x27,\n\t0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F, 0x2F\n};\n\nstatic const u8 OFDM_CONFIG[] = {\n\t0x10, 0x0F, 0x0A, 0x0C, 0x14, 0xFA, 0xFF, 0x50,\n\t0x00, 0x50, 0x00, 0x00, 0x00, 0x5C, 0x00, 0x00,\n\t0x40, 0x00, 0x40, 0x00, 0x00, 0x00, 0xA8, 0x26,\n\t0x32, 0x33, 0x06, 0xA5, 0x6F, 0x55, 0xC8, 0xBB,\n\t0x0A, 0xE1, 0x2C, 0x4A, 0x86, 0x83, 0x34, 0x00,\n\t0x4F, 0x24, 0x6F, 0xC2, 0x03, 0x40, 0x80, 0x00,\n\t0xC0, 0xC1, 0x58, 0xF1, 0x00, 0xC4, 0x90, 0x3e,\n\t0xD8, 0x3C, 0x7B, 0x10, 0x10\n};\n\nstatic void rtl8187se_three_wire_io(struct ieee80211_hw *dev, u8 *data,\n\t\t\t\t    u8 len, bool write)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tint i;\n\tu8 tmp;\n\n\tdo {\n\t\tfor (i = 0; i < 5; i++) {\n\t\t\ttmp = rtl818x_ioread8(priv, SW_3W_CMD1);\n\t\t\tif (!(tmp & 0x3))\n\t\t\t\tbreak;\n\t\t\tudelay(10);\n\t\t}\n\t\tif (i == 5)\n\t\t\twiphy_err(dev->wiphy, PFX\n\t\t\t\t\"CmdReg: 0x%x RE/WE bits aren't clear\\n\", tmp);\n\n\t\ttmp = rtl818x_ioread8(priv, &priv->map->rf_sw_config) | 0x02;\n\t\trtl818x_iowrite8(priv, &priv->map->rf_sw_config, tmp);\n\n\t\ttmp = rtl818x_ioread8(priv, REG_ADDR1(0x84)) & 0xF7;\n\t\trtl818x_iowrite8(priv, REG_ADDR1(0x84), tmp);\n\t\tif (write) {\n\t\t\tif (len == 16) {\n\t\t\t\trtl818x_iowrite16(priv, SW_3W_DB0,\n\t\t\t\t  *(u16 *)data);\n\t\t\t} else if (len == 64) {\n\t\t\t\trtl818x_iowrite32(priv, SW_3W_DB0_4,\n\t\t\t\t  *((u32 *)data));\n\t\t\t\trtl818x_iowrite32(priv, SW_3W_DB1_4,\n\t\t\t\t  *((u32 *)(data + 4)));\n\t\t\t} else\n\t\t\t\twiphy_err(dev->wiphy, PFX\n\t\t\t\t\t\"Unimplemented length\\n\");\n\t\t} else {\n\t\t\trtl818x_iowrite16(priv, SW_3W_DB0, *(u16 *)data);\n\t\t}\n\t\tif (write)\n\t\t\ttmp = 2;\n\t\telse\n\t\t\ttmp = 1;\n\t\trtl818x_iowrite8(priv, SW_3W_CMD1, tmp);\n\t\tfor (i = 0; i < 5; i++) {\n\t\t\ttmp = rtl818x_ioread8(priv, SW_3W_CMD1);\n\t\t\tif (!(tmp & 0x3))\n\t\t\t\tbreak;\n\t\t\tudelay(10);\n\t\t}\n\t\trtl818x_iowrite8(priv, SW_3W_CMD1, 0);\n\t\tif (!write) {\n\t\t\t*((u16 *)data) = rtl818x_ioread16(priv, SI_DATA_REG);\n\t\t\t*((u16 *)data) &= 0x0FFF;\n\t\t}\n\t} while (0);\n}\n\nstatic u32 rtl8187se_rf_readreg(struct ieee80211_hw *dev, u8 addr)\n{\n\tu32 dataread = addr & 0x0F;\n\trtl8187se_three_wire_io(dev, (u8 *)&dataread, 16, 0);\n\treturn dataread;\n}\n\nstatic void rtl8187se_rf_writereg(struct ieee80211_hw *dev, u8 addr, u32 data)\n{\n\tu32 outdata = (data << 4) | (u32)(addr & 0x0F);\n\trtl8187se_three_wire_io(dev, (u8 *)&outdata, 16, 1);\n}\n\n\nstatic void rtl8225se_write_zebra_agc(struct ieee80211_hw *dev)\n{\n\tint i;\n\n\tfor (i = 0; i < 128; i++) {\n\t\trtl8225se_write_phy_ofdm(dev, 0xF, ZEBRA_AGC[i]);\n\t\trtl8225se_write_phy_ofdm(dev, 0xE, i+0x80);\n\t\trtl8225se_write_phy_ofdm(dev, 0xE, 0);\n\t}\n}\n\nstatic void rtl8187se_write_ofdm_config(struct ieee80211_hw *dev)\n{\n\t \n\tint i;\n\n\tfor (i = 0; i < 60; i++)\n\t\trtl8225se_write_phy_ofdm(dev, i, OFDM_CONFIG[i]);\n\n}\n\nstatic void rtl8225sez2_rf_set_tx_power(struct ieee80211_hw *dev, int channel)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tu8 cck_power, ofdm_power;\n\n\tcck_power = priv->channels[channel - 1].hw_value & 0xFF;\n\tif (cck_power > 35)\n\t\tcck_power = 35;\n\trtl818x_iowrite8(priv, &priv->map->TX_GAIN_CCK,\n\t\t\t cck_ofdm_gain_settings[cck_power]);\n\n\tusleep_range(1000, 5000);\n\tofdm_power = priv->channels[channel - 1].hw_value >> 8;\n\tif (ofdm_power > 35)\n\t\tofdm_power = 35;\n\n\trtl818x_iowrite8(priv, &priv->map->TX_GAIN_OFDM,\n\t\t\t cck_ofdm_gain_settings[ofdm_power]);\n\tif (ofdm_power < 12) {\n\t\trtl8225se_write_phy_ofdm(dev, 7, 0x5C);\n\t\trtl8225se_write_phy_ofdm(dev, 9, 0x5C);\n\t}\n\tif (ofdm_power < 18) {\n\t\trtl8225se_write_phy_ofdm(dev, 7, 0x54);\n\t\trtl8225se_write_phy_ofdm(dev, 9, 0x54);\n\t} else {\n\t\trtl8225se_write_phy_ofdm(dev, 7, 0x50);\n\t\trtl8225se_write_phy_ofdm(dev, 9, 0x50);\n\t}\n\n\tusleep_range(1000, 5000);\n}\n\nstatic void rtl8187se_write_rf_gain(struct ieee80211_hw *dev)\n{\n\tint i;\n\n\tfor (i = 0; i <= 36; i++) {\n\t\trtl8187se_rf_writereg(dev, 0x01, i); mdelay(1);\n\t\trtl8187se_rf_writereg(dev, 0x02, RF_GAIN_TABLE[i]); mdelay(1);\n\t}\n}\n\nstatic void rtl8187se_write_initial_gain(struct ieee80211_hw *dev,\n\t\t\t\t\tint init_gain)\n{\n\tswitch (init_gain) {\n\tdefault:\n\t\trtl8225se_write_phy_ofdm(dev, 0x17, 0x26); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x24, 0x86); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x05, 0xFA); mdelay(1);\n\t\tbreak;\n\tcase 2:\n\t\trtl8225se_write_phy_ofdm(dev, 0x17, 0x36); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x24, 0x86); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x05, 0xFA); mdelay(1);\n\t\tbreak;\n\tcase 3:\n\t\trtl8225se_write_phy_ofdm(dev, 0x17, 0x36); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x24, 0x86); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x05, 0xFB); mdelay(1);\n\t\tbreak;\n\tcase 4:\n\t\trtl8225se_write_phy_ofdm(dev, 0x17, 0x46); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x24, 0x86); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x05, 0xFB); mdelay(1);\n\t\tbreak;\n\tcase 5:\n\t\trtl8225se_write_phy_ofdm(dev, 0x17, 0x46); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x24, 0x96); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x05, 0xFB); mdelay(1);\n\t\tbreak;\n\tcase 6:\n\t\trtl8225se_write_phy_ofdm(dev, 0x17, 0x56); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x24, 0x96); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x05, 0xFC); mdelay(1);\n\t\tbreak;\n\tcase 7:\n\t\trtl8225se_write_phy_ofdm(dev, 0x17, 0x56); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x24, 0xA6); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x05, 0xFC); mdelay(1);\n\t\tbreak;\n\tcase 8:\n\t\trtl8225se_write_phy_ofdm(dev, 0x17, 0x66); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x24, 0xB6); mdelay(1);\n\t\trtl8225se_write_phy_ofdm(dev, 0x05, 0xFC); mdelay(1);\n\t\tbreak;\n\t}\n}\n\nvoid rtl8225se_rf_init(struct ieee80211_hw *dev)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tu32 rf23, rf24;\n\tu8 d_cut = 0;\n\tu8 tmp;\n\n\t \n\trtl8187se_rf_writereg(dev, 0x00, 0x013F); mdelay(1);\n\trf23 = rtl8187se_rf_readreg(dev, 0x08); mdelay(1);\n\trf24 = rtl8187se_rf_readreg(dev, 0x09); mdelay(1);\n\tif (rf23 == 0x0818 && rf24 == 0x070C)\n\t\td_cut = 1;\n\n\twiphy_info(dev->wiphy, \"RTL8225-SE version %s\\n\",\n\t\td_cut ? \"D\" : \"not-D\");\n\n\t \n\trtl8187se_rf_writereg(dev, 0x00, 0x009F); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x01, 0x06E0); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x02, 0x004D); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x03, 0x07F1); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x04, 0x0975); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x05, 0x0C72); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x06, 0x0AE6); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x07, 0x00CA); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x08, 0x0E1C); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x09, 0x02F0); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0A, 0x09D0); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0B, 0x01BA); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0C, 0x0640); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0D, 0x08DF); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0E, 0x0020); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0F, 0x0990); mdelay(1);\n\t \n\trtl8187se_rf_writereg(dev, 0x00, 0x013F); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x03, 0x0806); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x04, 0x03A7); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x05, 0x059B); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x06, 0x0081); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x07, 0x01A0); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0A, 0x0001); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0B, 0x0418); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0C, 0x0FBE); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0D, 0x0008); mdelay(1);\n\tif (d_cut)\n\t\trtl8187se_rf_writereg(dev, 0x0E, 0x0807);\n\telse\n\t\trtl8187se_rf_writereg(dev, 0x0E, 0x0806);\n\tmdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0F, 0x0ACC); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x00, 0x01D7); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x03, 0x0E00); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x04, 0x0E50); mdelay(1);\n\n\trtl8187se_write_rf_gain(dev);\n\n\trtl8187se_rf_writereg(dev, 0x05, 0x0203); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x06, 0x0200); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x00, 0x0137); mdelay(11);\n\trtl8187se_rf_writereg(dev, 0x0D, 0x0008); mdelay(11);\n\trtl8187se_rf_writereg(dev, 0x00, 0x0037); mdelay(11);\n\trtl8187se_rf_writereg(dev, 0x04, 0x0160); mdelay(11);\n\trtl8187se_rf_writereg(dev, 0x07, 0x0080); mdelay(11);\n\trtl8187se_rf_writereg(dev, 0x02, 0x088D); msleep(221);\n\trtl8187se_rf_writereg(dev, 0x00, 0x0137); mdelay(11);\n\trtl8187se_rf_writereg(dev, 0x07, 0x0000); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x07, 0x0180); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x07, 0x0220); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x07, 0x03E0); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x06, 0x00C1); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0A, 0x0001); mdelay(1);\n\tif (priv->xtal_cal) {\n\t\ttmp = (priv->xtal_in << 4) | (priv->xtal_out << 1) |\n\t\t      (1 << 11) | (1 << 9);\n\t\trtl8187se_rf_writereg(dev, 0x0F, tmp);\n\t\twiphy_info(dev->wiphy, \"Xtal cal\\n\");\n\t\tmdelay(1);\n\t} else {\n\t\twiphy_info(dev->wiphy, \"NO Xtal cal\\n\");\n\t\trtl8187se_rf_writereg(dev, 0x0F, 0x0ACC);\n\t\tmdelay(1);\n\t}\n\t \n\trtl8187se_rf_writereg(dev, 0x00, 0x00BF); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x0D, 0x08DF); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x02, 0x004D); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x04, 0x0975); msleep(31);\n\trtl8187se_rf_writereg(dev, 0x00, 0x0197); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x05, 0x05AB); mdelay(1);\n\n\trtl8187se_rf_writereg(dev, 0x00, 0x009F); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x01, 0x0000); mdelay(1);\n\trtl8187se_rf_writereg(dev, 0x02, 0x0000); mdelay(1);\n\t \n\t \n\trtl818x_iowrite8(priv, REG_ADDR1(0x024E),\n\t\t rtl818x_ioread8(priv, REG_ADDR1(0x24E)) & 0x9F);\n\trtl8225se_write_phy_cck(dev, 0x00, 0xC8);\n\trtl8225se_write_phy_cck(dev, 0x06, 0x1C);\n\trtl8225se_write_phy_cck(dev, 0x10, 0x78);\n\trtl8225se_write_phy_cck(dev, 0x2E, 0xD0);\n\trtl8225se_write_phy_cck(dev, 0x2F, 0x06);\n\trtl8225se_write_phy_cck(dev, 0x01, 0x46);\n\n\t \n\trtl818x_iowrite8(priv, &priv->map->TX_GAIN_CCK, 0x10);\n\trtl818x_iowrite8(priv, &priv->map->TX_GAIN_OFDM, 0x1B);\n\n\trtl818x_iowrite8(priv, &priv->map->TX_ANTENNA, 0x03);\n\trtl8225se_write_phy_ofdm(dev, 0x00, 0x12);\n\n\trtl8225se_write_zebra_agc(dev);\n\n\trtl8225se_write_phy_ofdm(dev, 0x10, 0x00);\n\n\trtl8187se_write_ofdm_config(dev);\n\n\t \n\trtl8187se_rf_writereg(dev, 0x00, 0x009F); udelay(500);\n\trtl8187se_rf_writereg(dev, 0x04, 0x0972); udelay(500);\n\t \n\trtl8187se_rf_writereg(dev, 0x00, 0x009F); udelay(500);\n\trtl8187se_rf_writereg(dev, 0x04, 0x0972); udelay(500);\n\t \n\trtl8225se_write_phy_ofdm(dev, 0x10, 0x40);\n\trtl8225se_write_phy_ofdm(dev, 0x12, 0x40);\n\n\trtl8187se_write_initial_gain(dev, 4);\n}\n\nvoid rtl8225se_rf_stop(struct ieee80211_hw *dev)\n{\n\t \n\tstruct rtl8180_priv *priv = dev->priv;\n\n\t \n\trtl8225se_write_phy_ofdm(dev, 0x10, 0x00);\n\trtl8225se_write_phy_ofdm(dev, 0x12, 0x00);\n\t \n\trtl8187se_rf_writereg(dev, 0x04, 0x0000);\n\trtl8187se_rf_writereg(dev, 0x00, 0x0000);\n\n\tusleep_range(1000, 5000);\n\t \n\trtl8180_set_anaparam(priv, RTL8225SE_ANAPARAM_OFF);\n\trtl8180_set_anaparam2(priv, RTL8225SE_ANAPARAM2_OFF);\n}\n\nvoid rtl8225se_rf_set_channel(struct ieee80211_hw *dev,\n\t\t\t\t   struct ieee80211_conf *conf)\n{\n\tint chan =\n\t\tieee80211_frequency_to_channel(conf->chandef.chan->center_freq);\n\n\trtl8225sez2_rf_set_tx_power(dev, chan);\n\trtl8187se_rf_writereg(dev, 0x7, rtl8225se_chan[chan - 1]);\n\tif ((rtl8187se_rf_readreg(dev, 0x7) & 0x0F80) !=\n\t\trtl8225se_chan[chan - 1])\n\t\trtl8187se_rf_writereg(dev, 0x7, rtl8225se_chan[chan - 1]);\n\tusleep_range(10000, 20000);\n}\n\nstatic const struct rtl818x_rf_ops rtl8225se_ops = {\n\t.name\t\t= \"rtl8225-se\",\n\t.init\t\t= rtl8225se_rf_init,\n\t.stop\t\t= rtl8225se_rf_stop,\n\t.set_chan\t= rtl8225se_rf_set_channel,\n};\n\nconst struct rtl818x_rf_ops *rtl8187se_detect_rf(struct ieee80211_hw *dev)\n{\n\treturn &rtl8225se_ops;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}