{
  "module_name": "sa2400.c",
  "hash_id": "9bf9848681d24d0b3fd733bc40988a5529c53697791affc614e95de716f8d586",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtl818x/rtl8180/sa2400.c",
  "human_readable_source": "\n\n \n\n#include <linux/pci.h>\n#include <linux/delay.h>\n#include <net/mac80211.h>\n\n#include \"rtl8180.h\"\n#include \"sa2400.h\"\n\nstatic const u32 sa2400_chan[] = {\n\t0x00096c,  \n\t0x080970,\n\t0x100974,\n\t0x180978,\n\t0x000980,\n\t0x080984,\n\t0x100988,\n\t0x18098c,\n\t0x000994,\n\t0x080998,\n\t0x10099c,\n\t0x1809a0,\n\t0x0009a8,\n\t0x0009b4,  \n};\n\nstatic void write_sa2400(struct ieee80211_hw *dev, u8 addr, u32 data)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tu32 phy_config;\n\n\t \n\tphy_config = 0xb0000000;\n\n\tphy_config |= ((u32)(addr & 0xf)) << 24;\n\tphy_config |= data & 0xffffff;\n\n\trtl818x_iowrite32(priv,\n\t\t(__le32 __iomem *) &priv->map->RFPinsOutput, phy_config);\n\n\tmsleep(3);\n}\n\nstatic void sa2400_write_phy_antenna(struct ieee80211_hw *dev, short chan)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tu8 ant = SA2400_ANTENNA;\n\n\tif (priv->rfparam & RF_PARAM_ANTBDEFAULT)\n\t\tant |= BB_ANTENNA_B;\n\n\tif (chan == 14)\n\t\tant |= BB_ANTATTEN_CHAN14;\n\n\trtl8180_write_phy(dev, 0x10, ant);\n\n}\n\nstatic u8 sa2400_rf_rssi_map[] = {\n\t0x64, 0x64, 0x63, 0x62, 0x61, 0x60, 0x5f, 0x5e,\n\t0x5d, 0x5c, 0x5b, 0x5a, 0x57, 0x54, 0x52, 0x50,\n\t0x4e, 0x4c, 0x4a, 0x48, 0x46, 0x44, 0x41, 0x3f,\n\t0x3c, 0x3a, 0x37, 0x36, 0x36, 0x1c, 0x1c, 0x1b,\n\t0x1b, 0x1a, 0x1a, 0x19, 0x19, 0x18, 0x18, 0x17,\n\t0x17, 0x16, 0x16, 0x15, 0x15, 0x14, 0x14, 0x13,\n\t0x13, 0x12, 0x12, 0x11, 0x11, 0x10, 0x10, 0x0f,\n\t0x0f, 0x0e, 0x0e, 0x0d, 0x0d, 0x0c, 0x0c, 0x0b,\n\t0x0b, 0x0a, 0x0a, 0x09, 0x09, 0x08, 0x08, 0x07,\n\t0x07, 0x06, 0x06, 0x05, 0x04, 0x03, 0x02,\n};\n\nstatic u8 sa2400_rf_calc_rssi(u8 agc, u8 sq)\n{\n\tif (sq == 0x80)\n\t\treturn 1;\n\n\tif (sq > 78)\n\t\treturn 32;\n\n\t \n\treturn 65 * sa2400_rf_rssi_map[sq] / 100;\n}\n\nstatic void sa2400_rf_set_channel(struct ieee80211_hw *dev,\n\t\t\t\t  struct ieee80211_conf *conf)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tint channel =\n\t\tieee80211_frequency_to_channel(conf->chandef.chan->center_freq);\n\tu32 txpw = priv->channels[channel - 1].hw_value & 0xFF;\n\tu32 chan = sa2400_chan[channel - 1];\n\n\twrite_sa2400(dev, 7, txpw);\n\n\tsa2400_write_phy_antenna(dev, channel);\n\n\twrite_sa2400(dev, 0, chan);\n\twrite_sa2400(dev, 1, 0xbb50);\n\twrite_sa2400(dev, 2, 0x80);\n\twrite_sa2400(dev, 3, 0);\n}\n\nstatic void sa2400_rf_stop(struct ieee80211_hw *dev)\n{\n\twrite_sa2400(dev, 4, 0);\n}\n\nstatic void sa2400_rf_init(struct ieee80211_hw *dev)\n{\n\tstruct rtl8180_priv *priv = dev->priv;\n\tu32 anaparam, txconf;\n\tu8 firdac;\n\tint analogphy = priv->rfparam & RF_PARAM_ANALOGPHY;\n\n\tanaparam = priv->anaparam;\n\tanaparam &= ~(1 << ANAPARAM_TXDACOFF_SHIFT);\n\tanaparam &= ~ANAPARAM_PWR1_MASK;\n\tanaparam &= ~ANAPARAM_PWR0_MASK;\n\n\tif (analogphy) {\n\t\tanaparam |= SA2400_ANA_ANAPARAM_PWR1_ON << ANAPARAM_PWR1_SHIFT;\n\t\tfirdac = 0;\n\t} else {\n\t\tanaparam |= (SA2400_DIG_ANAPARAM_PWR1_ON << ANAPARAM_PWR1_SHIFT);\n\t\tanaparam |= (SA2400_ANAPARAM_PWR0_ON << ANAPARAM_PWR0_SHIFT);\n\t\tfirdac = 1 << SA2400_REG4_FIRDAC_SHIFT;\n\t}\n\n\trtl8180_set_anaparam(priv, anaparam);\n\n\twrite_sa2400(dev, 0, sa2400_chan[0]);\n\twrite_sa2400(dev, 1, 0xbb50);\n\twrite_sa2400(dev, 2, 0x80);\n\twrite_sa2400(dev, 3, 0);\n\twrite_sa2400(dev, 4, 0x19340 | firdac);\n\twrite_sa2400(dev, 5, 0x1dfb | (SA2400_MAX_SENS - 54) << 15);\n\twrite_sa2400(dev, 4, 0x19348 | firdac);  \n\n\tif (!analogphy)\n\t\twrite_sa2400(dev, 4, 0x1938c);  \n\n\twrite_sa2400(dev, 4, 0x19340 | firdac);\n\n\twrite_sa2400(dev, 0, sa2400_chan[0]);\n\twrite_sa2400(dev, 1, 0xbb50);\n\twrite_sa2400(dev, 2, 0x80);\n\twrite_sa2400(dev, 3, 0);\n\twrite_sa2400(dev, 4, 0x19344 | firdac);  \n\n\t \n\twrite_sa2400(dev, 6, 0x13ff | (1 << 23));  \n\twrite_sa2400(dev, 8, 0);  \n\n\tif (analogphy) {\n\t\trtl8180_set_anaparam(priv, anaparam |\n\t\t\t\t     (1 << ANAPARAM_TXDACOFF_SHIFT));\n\n\t\ttxconf = rtl818x_ioread32(priv, &priv->map->TX_CONF);\n\t\trtl818x_iowrite32(priv, &priv->map->TX_CONF,\n\t\t\ttxconf | RTL818X_TX_CONF_LOOPBACK_CONT);\n\n\t\twrite_sa2400(dev, 4, 0x19341);  \n\n\t\t \n\t\twrite_sa2400(dev, 4, 0x19345);\n\n\t\t \n\n\t\trtl818x_iowrite32(priv, &priv->map->TX_CONF, txconf);\n\n\t\trtl8180_set_anaparam(priv, anaparam);\n\t}\n\t \n\n\twrite_sa2400(dev, 4, 0x19341 | firdac);  \n\n\t \n\trtl8180_write_phy(dev, 0, 0x98);\n\trtl8180_write_phy(dev, 3, 0x38);\n\trtl8180_write_phy(dev, 4, 0xe0);\n\trtl8180_write_phy(dev, 5, 0x90);\n\trtl8180_write_phy(dev, 6, 0x1a);\n\trtl8180_write_phy(dev, 7, 0x64);\n\n\tsa2400_write_phy_antenna(dev, 1);\n\n\trtl8180_write_phy(dev, 0x11, 0x80);\n\n\tif (rtl818x_ioread8(priv, &priv->map->CONFIG2) &\n\t    RTL818X_CONFIG2_ANTENNA_DIV)\n\t\trtl8180_write_phy(dev, 0x12, 0xc7);  \n\telse\n\t\trtl8180_write_phy(dev, 0x12, 0x47);  \n\n\trtl8180_write_phy(dev, 0x13, 0x90 | priv->csthreshold);\n\n\trtl8180_write_phy(dev, 0x19, 0x0);\n\trtl8180_write_phy(dev, 0x1a, 0xa0);\n}\n\nconst struct rtl818x_rf_ops sa2400_rf_ops = {\n\t.name\t\t= \"Philips\",\n\t.init\t\t= sa2400_rf_init,\n\t.stop\t\t= sa2400_rf_stop,\n\t.set_chan\t= sa2400_rf_set_channel,\n\t.calc_rssi\t= sa2400_rf_calc_rssi,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}