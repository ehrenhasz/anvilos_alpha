{
  "module_name": "sar.c",
  "hash_id": "03b8615f509155146a75808693e38b03474ea2374faca0cd376a3a86326b8c4f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtw88/sar.c",
  "human_readable_source": "\n \n\n#include \"sar.h\"\n#include \"phy.h\"\n#include \"debug.h\"\n\ns8 rtw_query_sar(struct rtw_dev *rtwdev, const struct rtw_sar_arg *arg)\n{\n\tconst struct rtw_hal *hal = &rtwdev->hal;\n\tconst struct rtw_sar *sar = &hal->sar;\n\n\tswitch (sar->src) {\n\tdefault:\n\t\trtw_warn(rtwdev, \"unknown SAR source: %d\\n\", sar->src);\n\t\tfallthrough;\n\tcase RTW_SAR_SOURCE_NONE:\n\t\treturn (s8)rtwdev->chip->max_power_index;\n\tcase RTW_SAR_SOURCE_COMMON:\n\t\treturn sar->cfg[arg->path][arg->rs].common[arg->sar_band];\n\t}\n}\n\nstatic int rtw_apply_sar(struct rtw_dev *rtwdev, const struct rtw_sar *new)\n{\n\tstruct rtw_hal *hal = &rtwdev->hal;\n\tstruct rtw_sar *sar = &hal->sar;\n\n\tif (sar->src != RTW_SAR_SOURCE_NONE && new->src != sar->src) {\n\t\trtw_warn(rtwdev, \"SAR source: %d is in use\\n\", sar->src);\n\t\treturn -EBUSY;\n\t}\n\n\t*sar = *new;\n\trtw_phy_set_tx_power_level(rtwdev, hal->current_channel);\n\n\treturn 0;\n}\n\nstatic s8 rtw_sar_to_phy(struct rtw_dev *rtwdev, u8 fct, s32 sar,\n\t\t\t const struct rtw_sar_arg *arg)\n{\n\tstruct rtw_hal *hal = &rtwdev->hal;\n\tu8 txgi = rtwdev->chip->txgi_factor;\n\tu8 max = rtwdev->chip->max_power_index;\n\ts32 tmp;\n\ts8 base;\n\n\ttmp = fct > txgi ? sar >> (fct - txgi) : sar << (txgi - fct);\n\tbase = arg->sar_band == RTW_SAR_BAND_0 ?\n\t       hal->tx_pwr_by_rate_base_2g[arg->path][arg->rs] :\n\t       hal->tx_pwr_by_rate_base_5g[arg->path][arg->rs];\n\n\treturn (s8)clamp_t(s32, tmp, -max - 1, max) - base;\n}\n\nstatic const struct cfg80211_sar_freq_ranges rtw_common_sar_freq_ranges[] = {\n\t[RTW_SAR_BAND_0] = { .start_freq = 2412, .end_freq = 2484, },\n\t[RTW_SAR_BAND_1] = { .start_freq = 5180, .end_freq = 5320, },\n\t[RTW_SAR_BAND_3] = { .start_freq = 5500, .end_freq = 5720, },\n\t[RTW_SAR_BAND_4] = { .start_freq = 5745, .end_freq = 5825, },\n};\n\nstatic_assert(ARRAY_SIZE(rtw_common_sar_freq_ranges) == RTW_SAR_BAND_NR);\n\nconst struct cfg80211_sar_capa rtw_sar_capa = {\n\t.type = NL80211_SAR_TYPE_POWER,\n\t.num_freq_ranges = RTW_SAR_BAND_NR,\n\t.freq_ranges = rtw_common_sar_freq_ranges,\n};\n\nint rtw_set_sar_specs(struct rtw_dev *rtwdev,\n\t\t      const struct cfg80211_sar_specs *sar)\n{\n\tstruct rtw_sar_arg arg = {0};\n\tstruct rtw_sar new = {0};\n\tu32 idx, i, j, k;\n\ts32 power;\n\ts8 val;\n\n\tif (sar->type != NL80211_SAR_TYPE_POWER)\n\t\treturn -EINVAL;\n\n\tmemset(&new, rtwdev->chip->max_power_index, sizeof(new));\n\tnew.src = RTW_SAR_SOURCE_COMMON;\n\n\tfor (i = 0; i < sar->num_sub_specs; i++) {\n\t\tidx = sar->sub_specs[i].freq_range_index;\n\t\tif (idx >= RTW_SAR_BAND_NR)\n\t\t\treturn -EINVAL;\n\n\t\tpower = sar->sub_specs[i].power;\n\t\trtw_dbg(rtwdev, RTW_DBG_REGD, \"On freq %u to %u, set SAR %d in 1/%lu dBm\\n\",\n\t\t\trtw_common_sar_freq_ranges[idx].start_freq,\n\t\t\trtw_common_sar_freq_ranges[idx].end_freq,\n\t\t\tpower, BIT(RTW_COMMON_SAR_FCT));\n\n\t\tfor (j = 0; j < RTW_RF_PATH_MAX; j++) {\n\t\t\tfor (k = 0; k < RTW_RATE_SECTION_MAX; k++) {\n\t\t\t\targ = (struct rtw_sar_arg){\n\t\t\t\t\t.sar_band = idx,\n\t\t\t\t\t.path = j,\n\t\t\t\t\t.rs = k,\n\t\t\t\t};\n\t\t\t\tval = rtw_sar_to_phy(rtwdev, RTW_COMMON_SAR_FCT,\n\t\t\t\t\t\t     power, &arg);\n\t\t\t\tnew.cfg[j][k].common[idx] = val;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn rtw_apply_sar(rtwdev, &new);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}