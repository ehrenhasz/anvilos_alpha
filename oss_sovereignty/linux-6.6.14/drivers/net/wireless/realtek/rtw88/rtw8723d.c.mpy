{
  "module_name": "rtw8723d.c",
  "hash_id": "ad88e758936c252c4cb3eaffe0055de2ebd6a8723e18fcbf4614a1ab51b5f114",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtw88/rtw8723d.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include \"main.h\"\n#include \"coex.h\"\n#include \"fw.h\"\n#include \"tx.h\"\n#include \"rx.h\"\n#include \"phy.h\"\n#include \"rtw8723d.h\"\n#include \"rtw8723d_table.h\"\n#include \"mac.h\"\n#include \"reg.h\"\n#include \"debug.h\"\n\nstatic const struct rtw_hw_reg rtw8723d_txagc[] = {\n\t[DESC_RATE1M]\t= { .addr = 0xe08, .mask = 0x0000ff00 },\n\t[DESC_RATE2M]\t= { .addr = 0x86c, .mask = 0x0000ff00 },\n\t[DESC_RATE5_5M]\t= { .addr = 0x86c, .mask = 0x00ff0000 },\n\t[DESC_RATE11M]\t= { .addr = 0x86c, .mask = 0xff000000 },\n\t[DESC_RATE6M]\t= { .addr = 0xe00, .mask = 0x000000ff },\n\t[DESC_RATE9M]\t= { .addr = 0xe00, .mask = 0x0000ff00 },\n\t[DESC_RATE12M]\t= { .addr = 0xe00, .mask = 0x00ff0000 },\n\t[DESC_RATE18M]\t= { .addr = 0xe00, .mask = 0xff000000 },\n\t[DESC_RATE24M]\t= { .addr = 0xe04, .mask = 0x000000ff },\n\t[DESC_RATE36M]\t= { .addr = 0xe04, .mask = 0x0000ff00 },\n\t[DESC_RATE48M]\t= { .addr = 0xe04, .mask = 0x00ff0000 },\n\t[DESC_RATE54M]\t= { .addr = 0xe04, .mask = 0xff000000 },\n\t[DESC_RATEMCS0]\t= { .addr = 0xe10, .mask = 0x000000ff },\n\t[DESC_RATEMCS1]\t= { .addr = 0xe10, .mask = 0x0000ff00 },\n\t[DESC_RATEMCS2]\t= { .addr = 0xe10, .mask = 0x00ff0000 },\n\t[DESC_RATEMCS3]\t= { .addr = 0xe10, .mask = 0xff000000 },\n\t[DESC_RATEMCS4]\t= { .addr = 0xe14, .mask = 0x000000ff },\n\t[DESC_RATEMCS5]\t= { .addr = 0xe14, .mask = 0x0000ff00 },\n\t[DESC_RATEMCS6]\t= { .addr = 0xe14, .mask = 0x00ff0000 },\n\t[DESC_RATEMCS7]\t= { .addr = 0xe14, .mask = 0xff000000 },\n};\n\n#define WLAN_TXQ_RPT_EN\t\t0x1F\n#define WLAN_SLOT_TIME\t\t0x09\n#define WLAN_RL_VAL\t\t0x3030\n#define WLAN_BAR_VAL\t\t0x0201ffff\n#define BIT_MASK_TBTT_HOLD\t0x00000fff\n#define BIT_SHIFT_TBTT_HOLD\t8\n#define BIT_MASK_TBTT_SETUP\t0x000000ff\n#define BIT_SHIFT_TBTT_SETUP\t0\n#define BIT_MASK_TBTT_MASK\t((BIT_MASK_TBTT_HOLD << BIT_SHIFT_TBTT_HOLD) | \\\n\t\t\t\t (BIT_MASK_TBTT_SETUP << BIT_SHIFT_TBTT_SETUP))\n#define TBTT_TIME(s, h)((((s) & BIT_MASK_TBTT_SETUP) << BIT_SHIFT_TBTT_SETUP) |\\\n\t\t\t(((h) & BIT_MASK_TBTT_HOLD) << BIT_SHIFT_TBTT_HOLD))\n#define WLAN_TBTT_TIME_NORMAL\tTBTT_TIME(0x04, 0x80)\n#define WLAN_TBTT_TIME_STOP_BCN\tTBTT_TIME(0x04, 0x64)\n#define WLAN_PIFS_VAL\t\t0\n#define WLAN_AGG_BRK_TIME\t0x16\n#define WLAN_NAV_PROT_LEN\t0x0040\n#define WLAN_SPEC_SIFS\t\t0x100a\n#define WLAN_RX_PKT_LIMIT\t0x17\n#define WLAN_MAX_AGG_NR\t\t0x0A\n#define WLAN_AMPDU_MAX_TIME\t0x1C\n#define WLAN_ANT_SEL\t\t0x82\n#define WLAN_LTR_IDLE_LAT\t0x90039003\n#define WLAN_LTR_ACT_LAT\t0x883c883c\n#define WLAN_LTR_CTRL1\t\t0xCB004010\n#define WLAN_LTR_CTRL2\t\t0x01233425\n\nstatic void rtw8723d_lck(struct rtw_dev *rtwdev)\n{\n\tu32 lc_cal;\n\tu8 val_ctx, rf_val;\n\tint ret;\n\n\tval_ctx = rtw_read8(rtwdev, REG_CTX);\n\tif ((val_ctx & BIT_MASK_CTX_TYPE) != 0)\n\t\trtw_write8(rtwdev, REG_CTX, val_ctx & ~BIT_MASK_CTX_TYPE);\n\telse\n\t\trtw_write8(rtwdev, REG_TXPAUSE, 0xFF);\n\tlc_cal = rtw_read_rf(rtwdev, RF_PATH_A, RF_CFGCH, RFREG_MASK);\n\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_CFGCH, RFREG_MASK, lc_cal | BIT_LCK);\n\n\tret = read_poll_timeout(rtw_read_rf, rf_val, rf_val != 0x1,\n\t\t\t\t10000, 1000000, false,\n\t\t\t\trtwdev, RF_PATH_A, RF_CFGCH, BIT_LCK);\n\tif (ret)\n\t\trtw_warn(rtwdev, \"failed to poll LCK status bit\\n\");\n\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_CFGCH, RFREG_MASK, lc_cal);\n\tif ((val_ctx & BIT_MASK_CTX_TYPE) != 0)\n\t\trtw_write8(rtwdev, REG_CTX, val_ctx);\n\telse\n\t\trtw_write8(rtwdev, REG_TXPAUSE, 0x00);\n}\n\nstatic const u32 rtw8723d_ofdm_swing_table[] = {\n\t0x0b40002d, 0x0c000030, 0x0cc00033, 0x0d800036, 0x0e400039, 0x0f00003c,\n\t0x10000040, 0x11000044, 0x12000048, 0x1300004c, 0x14400051, 0x15800056,\n\t0x16c0005b, 0x18000060, 0x19800066, 0x1b00006c, 0x1c800072, 0x1e400079,\n\t0x20000080, 0x22000088, 0x24000090, 0x26000098, 0x288000a2, 0x2ac000ab,\n\t0x2d4000b5, 0x300000c0, 0x32c000cb, 0x35c000d7, 0x390000e4, 0x3c8000f2,\n\t0x40000100, 0x43c0010f, 0x47c0011f, 0x4c000130, 0x50800142, 0x55400155,\n\t0x5a400169, 0x5fc0017f, 0x65400195, 0x6b8001ae, 0x71c001c7, 0x788001e2,\n\t0x7f8001fe,\n};\n\nstatic const u32 rtw8723d_cck_swing_table[] = {\n\t0x0CD, 0x0D9, 0x0E6, 0x0F3, 0x102, 0x111, 0x121, 0x132, 0x144, 0x158,\n\t0x16C, 0x182, 0x198, 0x1B1, 0x1CA, 0x1E5, 0x202, 0x221, 0x241, 0x263,\n\t0x287, 0x2AE, 0x2D6, 0x301, 0x32F, 0x35F, 0x392, 0x3C9, 0x402, 0x43F,\n\t0x47F, 0x4C3, 0x50C, 0x558, 0x5A9, 0x5FF, 0x65A, 0x6BA, 0x720, 0x78C,\n\t0x7FF,\n};\n\n#define RTW_OFDM_SWING_TABLE_SIZE\tARRAY_SIZE(rtw8723d_ofdm_swing_table)\n#define RTW_CCK_SWING_TABLE_SIZE\tARRAY_SIZE(rtw8723d_cck_swing_table)\n\nstatic void rtw8723d_pwrtrack_init(struct rtw_dev *rtwdev)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\tu8 path;\n\n\tdm_info->default_ofdm_index = RTW_DEF_OFDM_SWING_INDEX;\n\n\tfor (path = RF_PATH_A; path < rtwdev->hal.rf_path_num; path++) {\n\t\tewma_thermal_init(&dm_info->avg_thermal[path]);\n\t\tdm_info->delta_power_index[path] = 0;\n\t}\n\tdm_info->pwr_trk_triggered = false;\n\tdm_info->pwr_trk_init_trigger = true;\n\tdm_info->thermal_meter_k = rtwdev->efuse.thermal_meter_k;\n\tdm_info->txagc_remnant_cck = 0;\n\tdm_info->txagc_remnant_ofdm = 0;\n}\n\nstatic void rtw8723d_phy_set_param(struct rtw_dev *rtwdev)\n{\n\tu8 xtal_cap;\n\tu32 val32;\n\n\t \n\trtw_write16_set(rtwdev, REG_SYS_FUNC_EN,\n\t\t\tBIT_FEN_EN_25_1 | BIT_FEN_BB_GLB_RST | BIT_FEN_BB_RSTB);\n\trtw_write8_set(rtwdev, REG_RF_CTRL,\n\t\t       BIT_RF_EN | BIT_RF_RSTB | BIT_RF_SDM_RSTB);\n\trtw_write8(rtwdev, REG_AFE_CTRL1 + 1, 0x80);\n\n\trtw_phy_load_tables(rtwdev);\n\n\t \n\trtw_write32_clr(rtwdev, REG_RCR, BIT_RCR_ADF);\n\trtw_write8_set(rtwdev, REG_HIQ_NO_LMT_EN, BIT_HIQ_NO_LMT_EN_ROOT);\n\trtw_write16_set(rtwdev, REG_AFE_CTRL_4, BIT_CK320M_AFE_EN | BIT_EN_SYN);\n\n\txtal_cap = rtwdev->efuse.crystal_cap & 0x3F;\n\trtw_write32_mask(rtwdev, REG_AFE_CTRL3, BIT_MASK_XTAL,\n\t\t\t xtal_cap | (xtal_cap << 6));\n\trtw_write32_set(rtwdev, REG_FPGA0_RFMOD, BIT_CCKEN | BIT_OFDMEN);\n\tif ((rtwdev->efuse.afe >> 4) == 14) {\n\t\trtw_write32_set(rtwdev, REG_AFE_CTRL3, BIT_XTAL_GMP_BIT4);\n\t\trtw_write32_clr(rtwdev, REG_AFE_CTRL1, BITS_PLL);\n\t\trtw_write32_set(rtwdev, REG_LDO_SWR_CTRL, BIT_XTA1);\n\t\trtw_write32_clr(rtwdev, REG_LDO_SWR_CTRL, BIT_XTA0);\n\t}\n\n\trtw_write8(rtwdev, REG_SLOT, WLAN_SLOT_TIME);\n\trtw_write8(rtwdev, REG_FWHW_TXQ_CTRL + 1, WLAN_TXQ_RPT_EN);\n\trtw_write16(rtwdev, REG_RETRY_LIMIT, WLAN_RL_VAL);\n\trtw_write32(rtwdev, REG_BAR_MODE_CTRL, WLAN_BAR_VAL);\n\trtw_write8(rtwdev, REG_ATIMWND, 0x2);\n\trtw_write8(rtwdev, REG_BCN_CTRL,\n\t\t   BIT_DIS_TSF_UDT | BIT_EN_BCN_FUNCTION | BIT_EN_TXBCN_RPT);\n\tval32 = rtw_read32(rtwdev, REG_TBTT_PROHIBIT);\n\tval32 &= ~BIT_MASK_TBTT_MASK;\n\tval32 |= WLAN_TBTT_TIME_STOP_BCN;\n\trtw_write8(rtwdev, REG_TBTT_PROHIBIT, val32);\n\trtw_write8(rtwdev, REG_PIFS, WLAN_PIFS_VAL);\n\trtw_write8(rtwdev, REG_AGGR_BREAK_TIME, WLAN_AGG_BRK_TIME);\n\trtw_write16(rtwdev, REG_NAV_PROT_LEN, WLAN_NAV_PROT_LEN);\n\trtw_write16(rtwdev, REG_MAC_SPEC_SIFS, WLAN_SPEC_SIFS);\n\trtw_write16(rtwdev, REG_SIFS, WLAN_SPEC_SIFS);\n\trtw_write16(rtwdev, REG_SIFS + 2, WLAN_SPEC_SIFS);\n\trtw_write8(rtwdev, REG_SINGLE_AMPDU_CTRL, BIT_EN_SINGLE_APMDU);\n\trtw_write8(rtwdev, REG_RX_PKT_LIMIT, WLAN_RX_PKT_LIMIT);\n\trtw_write8(rtwdev, REG_MAX_AGGR_NUM, WLAN_MAX_AGG_NR);\n\trtw_write8(rtwdev, REG_AMPDU_MAX_TIME, WLAN_AMPDU_MAX_TIME);\n\trtw_write8(rtwdev, REG_LEDCFG2, WLAN_ANT_SEL);\n\n\trtw_write32(rtwdev, REG_LTR_IDLE_LATENCY, WLAN_LTR_IDLE_LAT);\n\trtw_write32(rtwdev, REG_LTR_ACTIVE_LATENCY, WLAN_LTR_ACT_LAT);\n\trtw_write32(rtwdev, REG_LTR_CTRL_BASIC, WLAN_LTR_CTRL1);\n\trtw_write32(rtwdev, REG_LTR_CTRL_BASIC + 4, WLAN_LTR_CTRL2);\n\n\trtw_phy_init(rtwdev);\n\trtwdev->dm_info.cck_pd_default = rtw_read8(rtwdev, REG_CSRATIO) & 0x1f;\n\n\trtw_write16_set(rtwdev, REG_TXDMA_OFFSET_CHK, BIT_DROP_DATA_EN);\n\n\trtw8723d_lck(rtwdev);\n\n\trtw_write32_mask(rtwdev, REG_OFDM0_XAAGC1, MASKBYTE0, 0x50);\n\trtw_write32_mask(rtwdev, REG_OFDM0_XAAGC1, MASKBYTE0, 0x20);\n\n\trtw8723d_pwrtrack_init(rtwdev);\n}\n\nstatic void rtw8723de_efuse_parsing(struct rtw_efuse *efuse,\n\t\t\t\t    struct rtw8723d_efuse *map)\n{\n\tether_addr_copy(efuse->addr, map->e.mac_addr);\n}\n\nstatic void rtw8723du_efuse_parsing(struct rtw_efuse *efuse,\n\t\t\t\t    struct rtw8723d_efuse *map)\n{\n\tether_addr_copy(efuse->addr, map->u.mac_addr);\n}\n\nstatic void rtw8723ds_efuse_parsing(struct rtw_efuse *efuse,\n\t\t\t\t    struct rtw8723d_efuse *map)\n{\n\tether_addr_copy(efuse->addr, map->s.mac_addr);\n}\n\nstatic int rtw8723d_read_efuse(struct rtw_dev *rtwdev, u8 *log_map)\n{\n\tstruct rtw_efuse *efuse = &rtwdev->efuse;\n\tstruct rtw8723d_efuse *map;\n\tint i;\n\n\tmap = (struct rtw8723d_efuse *)log_map;\n\n\tefuse->rfe_option = 0;\n\tefuse->rf_board_option = map->rf_board_option;\n\tefuse->crystal_cap = map->xtal_k;\n\tefuse->pa_type_2g = map->pa_type;\n\tefuse->lna_type_2g = map->lna_type_2g[0];\n\tefuse->channel_plan = map->channel_plan;\n\tefuse->country_code[0] = map->country_code[0];\n\tefuse->country_code[1] = map->country_code[1];\n\tefuse->bt_setting = map->rf_bt_setting;\n\tefuse->regd = map->rf_board_option & 0x7;\n\tefuse->thermal_meter[0] = map->thermal_meter;\n\tefuse->thermal_meter_k = map->thermal_meter;\n\tefuse->afe = map->afe;\n\n\tfor (i = 0; i < 4; i++)\n\t\tefuse->txpwr_idx_table[i] = map->txpwr_idx_table[i];\n\n\tswitch (rtw_hci_type(rtwdev)) {\n\tcase RTW_HCI_TYPE_PCIE:\n\t\trtw8723de_efuse_parsing(efuse, map);\n\t\tbreak;\n\tcase RTW_HCI_TYPE_USB:\n\t\trtw8723du_efuse_parsing(efuse, map);\n\t\tbreak;\n\tcase RTW_HCI_TYPE_SDIO:\n\t\trtw8723ds_efuse_parsing(efuse, map);\n\t\tbreak;\n\tdefault:\n\t\t \n\t\treturn -ENOTSUPP;\n\t}\n\n\treturn 0;\n}\n\nstatic void query_phy_status_page0(struct rtw_dev *rtwdev, u8 *phy_status,\n\t\t\t\t   struct rtw_rx_pkt_stat *pkt_stat)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\ts8 min_rx_power = -120;\n\tu8 pwdb = GET_PHY_STAT_P0_PWDB(phy_status);\n\n\tpkt_stat->rx_power[RF_PATH_A] = pwdb - 97;\n\tpkt_stat->rssi = rtw_phy_rf_power_2_rssi(pkt_stat->rx_power, 1);\n\tpkt_stat->bw = RTW_CHANNEL_WIDTH_20;\n\tpkt_stat->signal_power = max(pkt_stat->rx_power[RF_PATH_A],\n\t\t\t\t     min_rx_power);\n\tdm_info->rssi[RF_PATH_A] = pkt_stat->rssi;\n}\n\nstatic void query_phy_status_page1(struct rtw_dev *rtwdev, u8 *phy_status,\n\t\t\t\t   struct rtw_rx_pkt_stat *pkt_stat)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\tu8 rxsc, bw;\n\ts8 min_rx_power = -120;\n\ts8 rx_evm;\n\n\tif (pkt_stat->rate > DESC_RATE11M && pkt_stat->rate < DESC_RATEMCS0)\n\t\trxsc = GET_PHY_STAT_P1_L_RXSC(phy_status);\n\telse\n\t\trxsc = GET_PHY_STAT_P1_HT_RXSC(phy_status);\n\n\tif (GET_PHY_STAT_P1_RF_MODE(phy_status) == 0)\n\t\tbw = RTW_CHANNEL_WIDTH_20;\n\telse if ((rxsc == 1) || (rxsc == 2))\n\t\tbw = RTW_CHANNEL_WIDTH_20;\n\telse\n\t\tbw = RTW_CHANNEL_WIDTH_40;\n\n\tpkt_stat->rx_power[RF_PATH_A] = GET_PHY_STAT_P1_PWDB_A(phy_status) - 110;\n\tpkt_stat->rssi = rtw_phy_rf_power_2_rssi(pkt_stat->rx_power, 1);\n\tpkt_stat->bw = bw;\n\tpkt_stat->signal_power = max(pkt_stat->rx_power[RF_PATH_A],\n\t\t\t\t     min_rx_power);\n\tpkt_stat->rx_evm[RF_PATH_A] = GET_PHY_STAT_P1_RXEVM_A(phy_status);\n\tpkt_stat->rx_snr[RF_PATH_A] = GET_PHY_STAT_P1_RXSNR_A(phy_status);\n\tpkt_stat->cfo_tail[RF_PATH_A] = GET_PHY_STAT_P1_CFO_TAIL_A(phy_status);\n\n\tdm_info->curr_rx_rate = pkt_stat->rate;\n\tdm_info->rssi[RF_PATH_A] = pkt_stat->rssi;\n\tdm_info->rx_snr[RF_PATH_A] = pkt_stat->rx_snr[RF_PATH_A] >> 1;\n\tdm_info->cfo_tail[RF_PATH_A] = (pkt_stat->cfo_tail[RF_PATH_A] * 5) >> 1;\n\n\trx_evm = clamp_t(s8, -pkt_stat->rx_evm[RF_PATH_A] >> 1, 0, 64);\n\trx_evm &= 0x3F;\t \n\tdm_info->rx_evm_dbm[RF_PATH_A] = rx_evm;\n}\n\nstatic void query_phy_status(struct rtw_dev *rtwdev, u8 *phy_status,\n\t\t\t     struct rtw_rx_pkt_stat *pkt_stat)\n{\n\tu8 page;\n\n\tpage = *phy_status & 0xf;\n\n\tswitch (page) {\n\tcase 0:\n\t\tquery_phy_status_page0(rtwdev, phy_status, pkt_stat);\n\t\tbreak;\n\tcase 1:\n\t\tquery_phy_status_page1(rtwdev, phy_status, pkt_stat);\n\t\tbreak;\n\tdefault:\n\t\trtw_warn(rtwdev, \"unused phy status page (%d)\\n\", page);\n\t\treturn;\n\t}\n}\n\nstatic void rtw8723d_query_rx_desc(struct rtw_dev *rtwdev, u8 *rx_desc,\n\t\t\t\t   struct rtw_rx_pkt_stat *pkt_stat,\n\t\t\t\t   struct ieee80211_rx_status *rx_status)\n{\n\tstruct ieee80211_hdr *hdr;\n\tu32 desc_sz = rtwdev->chip->rx_pkt_desc_sz;\n\tu8 *phy_status = NULL;\n\n\tmemset(pkt_stat, 0, sizeof(*pkt_stat));\n\n\tpkt_stat->phy_status = GET_RX_DESC_PHYST(rx_desc);\n\tpkt_stat->icv_err = GET_RX_DESC_ICV_ERR(rx_desc);\n\tpkt_stat->crc_err = GET_RX_DESC_CRC32(rx_desc);\n\tpkt_stat->decrypted = !GET_RX_DESC_SWDEC(rx_desc) &&\n\t\t\t      GET_RX_DESC_ENC_TYPE(rx_desc) != RX_DESC_ENC_NONE;\n\tpkt_stat->is_c2h = GET_RX_DESC_C2H(rx_desc);\n\tpkt_stat->pkt_len = GET_RX_DESC_PKT_LEN(rx_desc);\n\tpkt_stat->drv_info_sz = GET_RX_DESC_DRV_INFO_SIZE(rx_desc);\n\tpkt_stat->shift = GET_RX_DESC_SHIFT(rx_desc);\n\tpkt_stat->rate = GET_RX_DESC_RX_RATE(rx_desc);\n\tpkt_stat->cam_id = GET_RX_DESC_MACID(rx_desc);\n\tpkt_stat->ppdu_cnt = 0;\n\tpkt_stat->tsf_low = GET_RX_DESC_TSFL(rx_desc);\n\n\t \n\tpkt_stat->drv_info_sz *= 8;\n\n\t \n\tif (pkt_stat->is_c2h)\n\t\treturn;\n\n\thdr = (struct ieee80211_hdr *)(rx_desc + desc_sz + pkt_stat->shift +\n\t\t\t\t       pkt_stat->drv_info_sz);\n\tif (pkt_stat->phy_status) {\n\t\tphy_status = rx_desc + desc_sz + pkt_stat->shift;\n\t\tquery_phy_status(rtwdev, phy_status, pkt_stat);\n\t}\n\n\trtw_rx_fill_rx_status(rtwdev, pkt_stat, hdr, rx_status, phy_status);\n}\n\nstatic bool rtw8723d_check_spur_ov_thres(struct rtw_dev *rtwdev,\n\t\t\t\t\t u8 channel, u32 thres)\n{\n\tu32 freq;\n\tbool ret = false;\n\n\tif (channel == 13)\n\t\tfreq = FREQ_CH13;\n\telse if (channel == 14)\n\t\tfreq = FREQ_CH14;\n\telse\n\t\treturn false;\n\n\trtw_write32(rtwdev, REG_ANALOG_P4, DIS_3WIRE);\n\trtw_write32(rtwdev, REG_PSDFN, freq);\n\trtw_write32(rtwdev, REG_PSDFN, START_PSD | freq);\n\n\tmsleep(30);\n\tif (rtw_read32(rtwdev, REG_PSDRPT) >= thres)\n\t\tret = true;\n\n\trtw_write32(rtwdev, REG_PSDFN, freq);\n\trtw_write32(rtwdev, REG_ANALOG_P4, EN_3WIRE);\n\n\treturn ret;\n}\n\nstatic void rtw8723d_cfg_notch(struct rtw_dev *rtwdev, u8 channel, bool notch)\n{\n\tif (!notch) {\n\t\trtw_write32_mask(rtwdev, REG_OFDM0_RXDSP, BIT_MASK_RXDSP, 0x1f);\n\t\trtw_write32_mask(rtwdev, REG_OFDM0_RXDSP, BIT_EN_RXDSP, 0x0);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI1, 0x00000000);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI2, 0x00000000);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI3, 0x00000000);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI4, 0x00000000);\n\t\trtw_write32_mask(rtwdev, REG_OFDM1_CFOTRK, BIT_EN_CFOTRK, 0x0);\n\t\treturn;\n\t}\n\n\tswitch (channel) {\n\tcase 13:\n\t\trtw_write32_mask(rtwdev, REG_OFDM0_RXDSP, BIT_MASK_RXDSP, 0xb);\n\t\trtw_write32_mask(rtwdev, REG_OFDM0_RXDSP, BIT_EN_RXDSP, 0x1);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI1, 0x04000000);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI2, 0x00000000);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI3, 0x00000000);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI4, 0x00000000);\n\t\trtw_write32_mask(rtwdev, REG_OFDM1_CFOTRK, BIT_EN_CFOTRK, 0x1);\n\t\tbreak;\n\tcase 14:\n\t\trtw_write32_mask(rtwdev, REG_OFDM0_RXDSP, BIT_MASK_RXDSP, 0x5);\n\t\trtw_write32_mask(rtwdev, REG_OFDM0_RXDSP, BIT_EN_RXDSP, 0x1);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI1, 0x00000000);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI2, 0x00000000);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI3, 0x00000000);\n\t\trtw_write32(rtwdev, REG_OFDM1_CSI4, 0x00080000);\n\t\trtw_write32_mask(rtwdev, REG_OFDM1_CFOTRK, BIT_EN_CFOTRK, 0x1);\n\t\tbreak;\n\tdefault:\n\t\trtw_write32_mask(rtwdev, REG_OFDM0_RXDSP, BIT_EN_RXDSP, 0x0);\n\t\trtw_write32_mask(rtwdev, REG_OFDM1_CFOTRK, BIT_EN_CFOTRK, 0x0);\n\t\tbreak;\n\t}\n}\n\nstatic void rtw8723d_spur_cal(struct rtw_dev *rtwdev, u8 channel)\n{\n\tbool notch;\n\n\tif (channel < 13) {\n\t\trtw8723d_cfg_notch(rtwdev, channel, false);\n\t\treturn;\n\t}\n\n\tnotch = rtw8723d_check_spur_ov_thres(rtwdev, channel, SPUR_THRES);\n\trtw8723d_cfg_notch(rtwdev, channel, notch);\n}\n\nstatic void rtw8723d_set_channel_rf(struct rtw_dev *rtwdev, u8 channel, u8 bw)\n{\n\tu32 rf_cfgch_a, rf_cfgch_b;\n\n\trf_cfgch_a = rtw_read_rf(rtwdev, RF_PATH_A, RF_CFGCH, RFREG_MASK);\n\trf_cfgch_b = rtw_read_rf(rtwdev, RF_PATH_B, RF_CFGCH, RFREG_MASK);\n\n\trf_cfgch_a &= ~RFCFGCH_CHANNEL_MASK;\n\trf_cfgch_b &= ~RFCFGCH_CHANNEL_MASK;\n\trf_cfgch_a |= (channel & RFCFGCH_CHANNEL_MASK);\n\trf_cfgch_b |= (channel & RFCFGCH_CHANNEL_MASK);\n\n\trf_cfgch_a &= ~RFCFGCH_BW_MASK;\n\tswitch (bw) {\n\tcase RTW_CHANNEL_WIDTH_20:\n\t\trf_cfgch_a |= RFCFGCH_BW_20M;\n\t\tbreak;\n\tcase RTW_CHANNEL_WIDTH_40:\n\t\trf_cfgch_a |= RFCFGCH_BW_40M;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_CFGCH, RFREG_MASK, rf_cfgch_a);\n\trtw_write_rf(rtwdev, RF_PATH_B, RF_CFGCH, RFREG_MASK, rf_cfgch_b);\n\n\trtw8723d_spur_cal(rtwdev, channel);\n}\n\nstatic const struct rtw_backup_info cck_dfir_cfg[][CCK_DFIR_NR] = {\n\t[0] = {\n\t\t{ .len = 4, .reg = 0xA24, .val = 0x64B80C1C },\n\t\t{ .len = 4, .reg = 0xA28, .val = 0x00008810 },\n\t\t{ .len = 4, .reg = 0xAAC, .val = 0x01235667 },\n\t},\n\t[1] = {\n\t\t{ .len = 4, .reg = 0xA24, .val = 0x0000B81C },\n\t\t{ .len = 4, .reg = 0xA28, .val = 0x00000000 },\n\t\t{ .len = 4, .reg = 0xAAC, .val = 0x00003667 },\n\t},\n};\n\nstatic void rtw8723d_set_channel_bb(struct rtw_dev *rtwdev, u8 channel, u8 bw,\n\t\t\t\t    u8 primary_ch_idx)\n{\n\tconst struct rtw_backup_info *cck_dfir;\n\tint i;\n\n\tcck_dfir = channel <= 13 ? cck_dfir_cfg[0] : cck_dfir_cfg[1];\n\n\tfor (i = 0; i < CCK_DFIR_NR; i++, cck_dfir++)\n\t\trtw_write32(rtwdev, cck_dfir->reg, cck_dfir->val);\n\n\tswitch (bw) {\n\tcase RTW_CHANNEL_WIDTH_20:\n\t\trtw_write32_mask(rtwdev, REG_FPGA0_RFMOD, BIT_MASK_RFMOD, 0x0);\n\t\trtw_write32_mask(rtwdev, REG_FPGA1_RFMOD, BIT_MASK_RFMOD, 0x0);\n\t\trtw_write32_mask(rtwdev, REG_BBRX_DFIR, BIT_RXBB_DFIR_EN, 1);\n\t\trtw_write32_mask(rtwdev, REG_BBRX_DFIR, BIT_MASK_RXBB_DFIR, 0xa);\n\t\tbreak;\n\tcase RTW_CHANNEL_WIDTH_40:\n\t\trtw_write32_mask(rtwdev, REG_FPGA0_RFMOD, BIT_MASK_RFMOD, 0x1);\n\t\trtw_write32_mask(rtwdev, REG_FPGA1_RFMOD, BIT_MASK_RFMOD, 0x1);\n\t\trtw_write32_mask(rtwdev, REG_BBRX_DFIR, BIT_RXBB_DFIR_EN, 0);\n\t\trtw_write32_mask(rtwdev, REG_CCK0_SYS, BIT_CCK_SIDE_BAND,\n\t\t\t\t (primary_ch_idx == RTW_SC_20_UPPER ? 1 : 0));\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void rtw8723d_set_channel(struct rtw_dev *rtwdev, u8 channel, u8 bw,\n\t\t\t\t u8 primary_chan_idx)\n{\n\trtw8723d_set_channel_rf(rtwdev, channel, bw);\n\trtw_set_channel_mac(rtwdev, channel, bw, primary_chan_idx);\n\trtw8723d_set_channel_bb(rtwdev, channel, bw, primary_chan_idx);\n}\n\n#define BIT_CFENDFORM\t\tBIT(9)\n#define BIT_WMAC_TCR_ERR0\tBIT(12)\n#define BIT_WMAC_TCR_ERR1\tBIT(13)\n#define BIT_TCR_CFG\t\t(BIT_CFENDFORM | BIT_WMAC_TCR_ERR0 |\t       \\\n\t\t\t\t BIT_WMAC_TCR_ERR1)\n#define WLAN_RX_FILTER0\t\t0xFFFF\n#define WLAN_RX_FILTER1\t\t0x400\n#define WLAN_RX_FILTER2\t\t0xFFFF\n#define WLAN_RCR_CFG\t\t0x700060CE\n\nstatic int rtw8723d_mac_init(struct rtw_dev *rtwdev)\n{\n\trtw_write8(rtwdev, REG_FWHW_TXQ_CTRL + 1, WLAN_TXQ_RPT_EN);\n\trtw_write32(rtwdev, REG_TCR, BIT_TCR_CFG);\n\n\trtw_write16(rtwdev, REG_RXFLTMAP0, WLAN_RX_FILTER0);\n\trtw_write16(rtwdev, REG_RXFLTMAP1, WLAN_RX_FILTER1);\n\trtw_write16(rtwdev, REG_RXFLTMAP2, WLAN_RX_FILTER2);\n\trtw_write32(rtwdev, REG_RCR, WLAN_RCR_CFG);\n\n\trtw_write32(rtwdev, REG_INT_MIG, 0);\n\trtw_write32(rtwdev, REG_MCUTST_1, 0x0);\n\n\trtw_write8(rtwdev, REG_MISC_CTRL, BIT_DIS_SECOND_CCA);\n\trtw_write8(rtwdev, REG_2ND_CCA_CTRL, 0);\n\n\treturn 0;\n}\n\nstatic void rtw8723d_shutdown(struct rtw_dev *rtwdev)\n{\n\trtw_write16_set(rtwdev, REG_HCI_OPT_CTRL, BIT_USB_SUS_DIS);\n}\n\nstatic void rtw8723d_cfg_ldo25(struct rtw_dev *rtwdev, bool enable)\n{\n\tu8 ldo_pwr;\n\n\tldo_pwr = rtw_read8(rtwdev, REG_LDO_EFUSE_CTRL + 3);\n\tif (enable) {\n\t\tldo_pwr &= ~BIT_MASK_LDO25_VOLTAGE;\n\t\tldo_pwr |= (BIT_LDO25_VOLTAGE_V25 << 4) | BIT_LDO25_EN;\n\t} else {\n\t\tldo_pwr &= ~BIT_LDO25_EN;\n\t}\n\trtw_write8(rtwdev, REG_LDO_EFUSE_CTRL + 3, ldo_pwr);\n}\n\nstatic void\nrtw8723d_set_tx_power_index_by_rate(struct rtw_dev *rtwdev, u8 path, u8 rs)\n{\n\tstruct rtw_hal *hal = &rtwdev->hal;\n\tconst struct rtw_hw_reg *txagc;\n\tu8 rate, pwr_index;\n\tint j;\n\n\tfor (j = 0; j < rtw_rate_size[rs]; j++) {\n\t\trate = rtw_rate_section[rs][j];\n\t\tpwr_index = hal->tx_pwr_tbl[path][rate];\n\n\t\tif (rate >= ARRAY_SIZE(rtw8723d_txagc)) {\n\t\t\trtw_warn(rtwdev, \"rate 0x%x isn't supported\\n\", rate);\n\t\t\tcontinue;\n\t\t}\n\t\ttxagc = &rtw8723d_txagc[rate];\n\t\tif (!txagc->addr) {\n\t\t\trtw_warn(rtwdev, \"rate 0x%x isn't defined\\n\", rate);\n\t\t\tcontinue;\n\t\t}\n\n\t\trtw_write32_mask(rtwdev, txagc->addr, txagc->mask, pwr_index);\n\t}\n}\n\nstatic void rtw8723d_set_tx_power_index(struct rtw_dev *rtwdev)\n{\n\tstruct rtw_hal *hal = &rtwdev->hal;\n\tint rs, path;\n\n\tfor (path = 0; path < hal->rf_path_num; path++) {\n\t\tfor (rs = 0; rs <= RTW_RATE_SECTION_HT_1S; rs++)\n\t\t\trtw8723d_set_tx_power_index_by_rate(rtwdev, path, rs);\n\t}\n}\n\nstatic void rtw8723d_efuse_grant(struct rtw_dev *rtwdev, bool on)\n{\n\tif (on) {\n\t\trtw_write8(rtwdev, REG_EFUSE_ACCESS, EFUSE_ACCESS_ON);\n\n\t\trtw_write16_set(rtwdev, REG_SYS_FUNC_EN, BIT_FEN_ELDR);\n\t\trtw_write16_set(rtwdev, REG_SYS_CLKR, BIT_LOADER_CLK_EN | BIT_ANA8M);\n\t} else {\n\t\trtw_write8(rtwdev, REG_EFUSE_ACCESS, EFUSE_ACCESS_OFF);\n\t}\n}\n\nstatic void rtw8723d_false_alarm_statistics(struct rtw_dev *rtwdev)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\tu32 cck_fa_cnt;\n\tu32 ofdm_fa_cnt;\n\tu32 crc32_cnt;\n\tu32 val32;\n\n\t \n\trtw_write32_mask(rtwdev, REG_OFDM_FA_HOLDC_11N, BIT_MASK_OFDM_FA_KEEP, 1);\n\trtw_write32_mask(rtwdev, REG_OFDM_FA_RSTD_11N, BIT_MASK_OFDM_FA_KEEP1, 1);\n\trtw_write32_mask(rtwdev, REG_CCK_FA_RST_11N, BIT_MASK_CCK_CNT_KEEP, 1);\n\trtw_write32_mask(rtwdev, REG_CCK_FA_RST_11N, BIT_MASK_CCK_FA_KEEP, 1);\n\n\tcck_fa_cnt = rtw_read32_mask(rtwdev, REG_CCK_FA_LSB_11N, MASKBYTE0);\n\tcck_fa_cnt += rtw_read32_mask(rtwdev, REG_CCK_FA_MSB_11N, MASKBYTE3) << 8;\n\n\tval32 = rtw_read32(rtwdev, REG_OFDM_FA_TYPE1_11N);\n\tofdm_fa_cnt = u32_get_bits(val32, BIT_MASK_OFDM_FF_CNT);\n\tofdm_fa_cnt += u32_get_bits(val32, BIT_MASK_OFDM_SF_CNT);\n\tval32 = rtw_read32(rtwdev, REG_OFDM_FA_TYPE2_11N);\n\tdm_info->ofdm_cca_cnt = u32_get_bits(val32, BIT_MASK_OFDM_CCA_CNT);\n\tofdm_fa_cnt += u32_get_bits(val32, BIT_MASK_OFDM_PF_CNT);\n\tval32 = rtw_read32(rtwdev, REG_OFDM_FA_TYPE3_11N);\n\tofdm_fa_cnt += u32_get_bits(val32, BIT_MASK_OFDM_RI_CNT);\n\tofdm_fa_cnt += u32_get_bits(val32, BIT_MASK_OFDM_CRC_CNT);\n\tval32 = rtw_read32(rtwdev, REG_OFDM_FA_TYPE4_11N);\n\tofdm_fa_cnt += u32_get_bits(val32, BIT_MASK_OFDM_MNS_CNT);\n\n\tdm_info->cck_fa_cnt = cck_fa_cnt;\n\tdm_info->ofdm_fa_cnt = ofdm_fa_cnt;\n\tdm_info->total_fa_cnt = cck_fa_cnt + ofdm_fa_cnt;\n\n\tdm_info->cck_err_cnt = rtw_read32(rtwdev, REG_IGI_C_11N);\n\tdm_info->cck_ok_cnt = rtw_read32(rtwdev, REG_IGI_D_11N);\n\tcrc32_cnt = rtw_read32(rtwdev, REG_OFDM_CRC32_CNT_11N);\n\tdm_info->ofdm_err_cnt = u32_get_bits(crc32_cnt, BIT_MASK_OFDM_LCRC_ERR);\n\tdm_info->ofdm_ok_cnt = u32_get_bits(crc32_cnt, BIT_MASK_OFDM_LCRC_OK);\n\tcrc32_cnt = rtw_read32(rtwdev, REG_HT_CRC32_CNT_11N);\n\tdm_info->ht_err_cnt = u32_get_bits(crc32_cnt, BIT_MASK_HT_CRC_ERR);\n\tdm_info->ht_ok_cnt = u32_get_bits(crc32_cnt, BIT_MASK_HT_CRC_OK);\n\tdm_info->vht_err_cnt = 0;\n\tdm_info->vht_ok_cnt = 0;\n\n\tval32 = rtw_read32(rtwdev, REG_CCK_CCA_CNT_11N);\n\tdm_info->cck_cca_cnt = (u32_get_bits(val32, BIT_MASK_CCK_FA_MSB) << 8) |\n\t\t\t       u32_get_bits(val32, BIT_MASK_CCK_FA_LSB);\n\tdm_info->total_cca_cnt = dm_info->cck_cca_cnt + dm_info->ofdm_cca_cnt;\n\n\t \n\trtw_write32_mask(rtwdev, REG_OFDM_FA_RSTC_11N, BIT_MASK_OFDM_FA_RST, 1);\n\trtw_write32_mask(rtwdev, REG_OFDM_FA_RSTC_11N, BIT_MASK_OFDM_FA_RST, 0);\n\trtw_write32_mask(rtwdev, REG_OFDM_FA_RSTD_11N, BIT_MASK_OFDM_FA_RST1, 1);\n\trtw_write32_mask(rtwdev, REG_OFDM_FA_RSTD_11N, BIT_MASK_OFDM_FA_RST1, 0);\n\trtw_write32_mask(rtwdev, REG_OFDM_FA_HOLDC_11N, BIT_MASK_OFDM_FA_KEEP, 0);\n\trtw_write32_mask(rtwdev, REG_OFDM_FA_RSTD_11N, BIT_MASK_OFDM_FA_KEEP1, 0);\n\trtw_write32_mask(rtwdev, REG_CCK_FA_RST_11N, BIT_MASK_CCK_CNT_KPEN, 0);\n\trtw_write32_mask(rtwdev, REG_CCK_FA_RST_11N, BIT_MASK_CCK_CNT_KPEN, 2);\n\trtw_write32_mask(rtwdev, REG_CCK_FA_RST_11N, BIT_MASK_CCK_FA_KPEN, 0);\n\trtw_write32_mask(rtwdev, REG_CCK_FA_RST_11N, BIT_MASK_CCK_FA_KPEN, 2);\n\trtw_write32_mask(rtwdev, REG_PAGE_F_RST_11N, BIT_MASK_F_RST_ALL, 1);\n\trtw_write32_mask(rtwdev, REG_PAGE_F_RST_11N, BIT_MASK_F_RST_ALL, 0);\n}\n\nstatic const u32 iqk_adda_regs[] = {\n\t0x85c, 0xe6c, 0xe70, 0xe74, 0xe78, 0xe7c, 0xe80, 0xe84, 0xe88, 0xe8c,\n\t0xed0, 0xed4, 0xed8, 0xedc, 0xee0, 0xeec\n};\n\nstatic const u32 iqk_mac8_regs[] = {0x522, 0x550, 0x551};\nstatic const u32 iqk_mac32_regs[] = {0x40};\n\nstatic const u32 iqk_bb_regs[] = {\n\t0xc04, 0xc08, 0x874, 0xb68, 0xb6c, 0x870, 0x860, 0x864, 0xa04\n};\n\n#define IQK_ADDA_REG_NUM\tARRAY_SIZE(iqk_adda_regs)\n#define IQK_MAC8_REG_NUM\tARRAY_SIZE(iqk_mac8_regs)\n#define IQK_MAC32_REG_NUM\tARRAY_SIZE(iqk_mac32_regs)\n#define IQK_BB_REG_NUM\t\tARRAY_SIZE(iqk_bb_regs)\n\nstruct iqk_backup_regs {\n\tu32 adda[IQK_ADDA_REG_NUM];\n\tu8 mac8[IQK_MAC8_REG_NUM];\n\tu32 mac32[IQK_MAC32_REG_NUM];\n\tu32 bb[IQK_BB_REG_NUM];\n\n\tu32 lte_path;\n\tu32 lte_gnt;\n\n\tu32 bb_sel_btg;\n\tu8 btg_sel;\n\n\tu8 igia;\n\tu8 igib;\n};\n\nstatic void rtw8723d_iqk_backup_regs(struct rtw_dev *rtwdev,\n\t\t\t\t     struct iqk_backup_regs *backup)\n{\n\tint i;\n\n\tfor (i = 0; i < IQK_ADDA_REG_NUM; i++)\n\t\tbackup->adda[i] = rtw_read32(rtwdev, iqk_adda_regs[i]);\n\n\tfor (i = 0; i < IQK_MAC8_REG_NUM; i++)\n\t\tbackup->mac8[i] = rtw_read8(rtwdev, iqk_mac8_regs[i]);\n\tfor (i = 0; i < IQK_MAC32_REG_NUM; i++)\n\t\tbackup->mac32[i] = rtw_read32(rtwdev, iqk_mac32_regs[i]);\n\n\tfor (i = 0; i < IQK_BB_REG_NUM; i++)\n\t\tbackup->bb[i] = rtw_read32(rtwdev, iqk_bb_regs[i]);\n\n\tbackup->igia = rtw_read32_mask(rtwdev, REG_OFDM0_XAAGC1, MASKBYTE0);\n\tbackup->igib = rtw_read32_mask(rtwdev, REG_OFDM0_XBAGC1, MASKBYTE0);\n\n\tbackup->bb_sel_btg = rtw_read32(rtwdev, REG_BB_SEL_BTG);\n}\n\nstatic void rtw8723d_iqk_restore_regs(struct rtw_dev *rtwdev,\n\t\t\t\t      const struct iqk_backup_regs *backup)\n{\n\tint i;\n\n\tfor (i = 0; i < IQK_ADDA_REG_NUM; i++)\n\t\trtw_write32(rtwdev, iqk_adda_regs[i], backup->adda[i]);\n\n\tfor (i = 0; i < IQK_MAC8_REG_NUM; i++)\n\t\trtw_write8(rtwdev, iqk_mac8_regs[i], backup->mac8[i]);\n\tfor (i = 0; i < IQK_MAC32_REG_NUM; i++)\n\t\trtw_write32(rtwdev, iqk_mac32_regs[i], backup->mac32[i]);\n\n\tfor (i = 0; i < IQK_BB_REG_NUM; i++)\n\t\trtw_write32(rtwdev, iqk_bb_regs[i], backup->bb[i]);\n\n\trtw_write32_mask(rtwdev, REG_OFDM0_XAAGC1, MASKBYTE0, 0x50);\n\trtw_write32_mask(rtwdev, REG_OFDM0_XAAGC1, MASKBYTE0, backup->igia);\n\n\trtw_write32_mask(rtwdev, REG_OFDM0_XBAGC1, MASKBYTE0, 0x50);\n\trtw_write32_mask(rtwdev, REG_OFDM0_XBAGC1, MASKBYTE0, backup->igib);\n\n\trtw_write32(rtwdev, REG_TXIQK_TONE_A_11N, 0x01008c00);\n\trtw_write32(rtwdev, REG_RXIQK_TONE_A_11N, 0x01008c00);\n}\n\nstatic void rtw8723d_iqk_backup_path_ctrl(struct rtw_dev *rtwdev,\n\t\t\t\t\t  struct iqk_backup_regs *backup)\n{\n\tbackup->btg_sel = rtw_read8(rtwdev, REG_BTG_SEL);\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] original 0x67 = 0x%x\\n\",\n\t\tbackup->btg_sel);\n}\n\nstatic void rtw8723d_iqk_config_path_ctrl(struct rtw_dev *rtwdev)\n{\n\trtw_write32_mask(rtwdev, REG_PAD_CTRL1, BIT_BT_BTG_SEL, 0x1);\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] set 0x67 = 0x%x\\n\",\n\t\trtw_read32_mask(rtwdev, REG_PAD_CTRL1, MASKBYTE3));\n}\n\nstatic void rtw8723d_iqk_restore_path_ctrl(struct rtw_dev *rtwdev,\n\t\t\t\t\t   const struct iqk_backup_regs *backup)\n{\n\trtw_write8(rtwdev, REG_BTG_SEL, backup->btg_sel);\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] restore 0x67 = 0x%x\\n\",\n\t\trtw_read32_mask(rtwdev, REG_PAD_CTRL1, MASKBYTE3));\n}\n\nstatic void rtw8723d_iqk_backup_lte_path_gnt(struct rtw_dev *rtwdev,\n\t\t\t\t\t     struct iqk_backup_regs *backup)\n{\n\tbackup->lte_path = rtw_read32(rtwdev, REG_LTECOEX_PATH_CONTROL);\n\trtw_write32(rtwdev, REG_LTECOEX_CTRL, 0x800f0038);\n\tmdelay(1);\n\tbackup->lte_gnt = rtw_read32(rtwdev, REG_LTECOEX_READ_DATA);\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] OriginalGNT = 0x%x\\n\",\n\t\tbackup->lte_gnt);\n}\n\nstatic void rtw8723d_iqk_config_lte_path_gnt(struct rtw_dev *rtwdev)\n{\n\trtw_write32(rtwdev, REG_LTECOEX_WRITE_DATA, 0x0000ff00);\n\trtw_write32(rtwdev, REG_LTECOEX_CTRL, 0xc0020038);\n\trtw_write32_mask(rtwdev, REG_LTECOEX_PATH_CONTROL, BIT_LTE_MUX_CTRL_PATH, 0x1);\n}\n\nstatic void rtw8723d_iqk_restore_lte_path_gnt(struct rtw_dev *rtwdev,\n\t\t\t\t\t      const struct iqk_backup_regs *bak)\n{\n\trtw_write32(rtwdev, REG_LTECOEX_WRITE_DATA, bak->lte_gnt);\n\trtw_write32(rtwdev, REG_LTECOEX_CTRL, 0xc00f0038);\n\trtw_write32(rtwdev, REG_LTECOEX_PATH_CONTROL, bak->lte_path);\n}\n\nstruct rtw_8723d_iqk_cfg {\n\tconst char *name;\n\tu32 val_bb_sel_btg;\n\tu32 reg_lutwe;\n\tu32 val_txiqk_pi;\n\tu32 reg_padlut;\n\tu32 reg_gaintx;\n\tu32 reg_bspad;\n\tu32 val_wlint;\n\tu32 val_wlsel;\n\tu32 val_iqkpts;\n};\n\nstatic const struct rtw_8723d_iqk_cfg iqk_tx_cfg[PATH_NR] = {\n\t[PATH_S1] = {\n\t\t.name = \"S1\",\n\t\t.val_bb_sel_btg = 0x99000000,\n\t\t.reg_lutwe = RF_LUTWE,\n\t\t.val_txiqk_pi = 0x8214019f,\n\t\t.reg_padlut = RF_LUTDBG,\n\t\t.reg_gaintx = RF_GAINTX,\n\t\t.reg_bspad = RF_BSPAD,\n\t\t.val_wlint = 0xe0d,\n\t\t.val_wlsel = 0x60d,\n\t\t.val_iqkpts = 0xfa000000,\n\t},\n\t[PATH_S0] = {\n\t\t.name = \"S0\",\n\t\t.val_bb_sel_btg = 0x99000280,\n\t\t.reg_lutwe = RF_LUTWE2,\n\t\t.val_txiqk_pi = 0x8214018a,\n\t\t.reg_padlut = RF_TXADBG,\n\t\t.reg_gaintx = RF_TRXIQ,\n\t\t.reg_bspad = RF_TXATANK,\n\t\t.val_wlint = 0xe6d,\n\t\t.val_wlsel = 0x66d,\n\t\t.val_iqkpts = 0xf9000000,\n\t},\n};\n\nstatic u8 rtw8723d_iqk_check_tx_failed(struct rtw_dev *rtwdev,\n\t\t\t\t       const struct rtw_8723d_iqk_cfg *iqk_cfg)\n{\n\ts32 tx_x, tx_y;\n\tu32 tx_fail;\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] 0xeac = 0x%x\\n\",\n\t\trtw_read32(rtwdev, REG_IQK_RES_RY));\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] 0xe94 = 0x%x, 0xe9c = 0x%x\\n\",\n\t\trtw_read32(rtwdev, REG_IQK_RES_TX),\n\t\trtw_read32(rtwdev, REG_IQK_RES_TY));\n\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\"[IQK] 0xe90(before IQK)= 0x%x, 0xe98(afer IQK) = 0x%x\\n\",\n\t\trtw_read32(rtwdev, 0xe90),\n\t\trtw_read32(rtwdev, 0xe98));\n\n\ttx_fail = rtw_read32_mask(rtwdev, REG_IQK_RES_RY, BIT_IQK_TX_FAIL);\n\ttx_x = rtw_read32_mask(rtwdev, REG_IQK_RES_TX, BIT_MASK_RES_TX);\n\ttx_y = rtw_read32_mask(rtwdev, REG_IQK_RES_TY, BIT_MASK_RES_TY);\n\n\tif (!tx_fail && tx_x != IQK_TX_X_ERR && tx_y != IQK_TX_Y_ERR)\n\t\treturn IQK_TX_OK;\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] %s TXIQK is failed\\n\",\n\t\tiqk_cfg->name);\n\n\treturn 0;\n}\n\nstatic u8 rtw8723d_iqk_check_rx_failed(struct rtw_dev *rtwdev,\n\t\t\t\t       const struct rtw_8723d_iqk_cfg *iqk_cfg)\n{\n\ts32 rx_x, rx_y;\n\tu32 rx_fail;\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] 0xea4 = 0x%x, 0xeac = 0x%x\\n\",\n\t\trtw_read32(rtwdev, REG_IQK_RES_RX),\n\t\trtw_read32(rtwdev, REG_IQK_RES_RY));\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\"[IQK] 0xea0(before IQK)= 0x%x, 0xea8(afer IQK) = 0x%x\\n\",\n\t\trtw_read32(rtwdev, 0xea0),\n\t\trtw_read32(rtwdev, 0xea8));\n\n\trx_fail = rtw_read32_mask(rtwdev, REG_IQK_RES_RY, BIT_IQK_RX_FAIL);\n\trx_x = rtw_read32_mask(rtwdev, REG_IQK_RES_RX, BIT_MASK_RES_RX);\n\trx_y = rtw_read32_mask(rtwdev, REG_IQK_RES_RY, BIT_MASK_RES_RY);\n\trx_y = abs(iqkxy_to_s32(rx_y));\n\n\tif (!rx_fail && rx_x < IQK_RX_X_UPPER && rx_x > IQK_RX_X_LOWER &&\n\t    rx_y < IQK_RX_Y_LMT)\n\t\treturn IQK_RX_OK;\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] %s RXIQK STEP2 is failed\\n\",\n\t\tiqk_cfg->name);\n\n\treturn 0;\n}\n\nstatic void rtw8723d_iqk_one_shot(struct rtw_dev *rtwdev, bool tx,\n\t\t\t\t  const struct rtw_8723d_iqk_cfg *iqk_cfg)\n{\n\tu32 pts = (tx ? iqk_cfg->val_iqkpts : 0xf9000000);\n\n\t \n\trtw_write32_mask(rtwdev, REG_FPGA0_IQK_11N, BIT_MASK_IQK_MOD, EN_IQK);\n\trtw8723d_iqk_config_lte_path_gnt(rtwdev);\n\n\trtw_write32(rtwdev, REG_LTECOEX_CTRL, 0x800f0054);\n\tmdelay(1);\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] GNT_BT @%s %sIQK1 = 0x%x\\n\",\n\t\tiqk_cfg->name, tx ? \"TX\" : \"RX\",\n\t\trtw_read32(rtwdev, REG_LTECOEX_READ_DATA));\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] 0x948 @%s %sIQK1 = 0x%x\\n\",\n\t\tiqk_cfg->name, tx ? \"TX\" : \"RX\",\n\t\trtw_read32(rtwdev, REG_BB_SEL_BTG));\n\n\t \n\trtw_write32(rtwdev, REG_IQK_AGC_PTS_11N, pts);\n\trtw_write32(rtwdev, REG_IQK_AGC_PTS_11N, 0xf8000000);\n\n\tif (!check_hw_ready(rtwdev, REG_IQK_RES_RY, BIT_IQK_DONE, 1))\n\t\trtw_warn(rtwdev, \"%s %s IQK isn't done\\n\", iqk_cfg->name,\n\t\t\t tx ? \"TX\" : \"RX\");\n}\n\nstatic void rtw8723d_iqk_txrx_path_post(struct rtw_dev *rtwdev,\n\t\t\t\t\tconst struct rtw_8723d_iqk_cfg *iqk_cfg,\n\t\t\t\t\tconst struct iqk_backup_regs *backup)\n{\n\trtw8723d_iqk_restore_lte_path_gnt(rtwdev, backup);\n\trtw_write32(rtwdev, REG_BB_SEL_BTG, backup->bb_sel_btg);\n\n\t \n\trtw_write32_mask(rtwdev, REG_FPGA0_IQK_11N, BIT_MASK_IQK_MOD, RST_IQK);\n\tmdelay(1);\n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_padlut, 0x800, 0x0);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_WLINT, BIT(0), 0x0);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_WLSEL, BIT(0), 0x0);\n}\n\nstatic u8 rtw8723d_iqk_tx_path(struct rtw_dev *rtwdev,\n\t\t\t       const struct rtw_8723d_iqk_cfg *iqk_cfg,\n\t\t\t       const struct iqk_backup_regs *backup)\n{\n\tu8 status;\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] path %s TXIQK!!\\n\", iqk_cfg->name);\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] 0x67 @%s TXIQK = 0x%x\\n\",\n\t\tiqk_cfg->name,\n\t\trtw_read32_mask(rtwdev, REG_PAD_CTRL1, MASKBYTE3));\n\n\trtw_write32(rtwdev, REG_BB_SEL_BTG, iqk_cfg->val_bb_sel_btg);\n\trtw_write32_mask(rtwdev, REG_FPGA0_IQK_11N, BIT_MASK_IQK_MOD, RST_IQK);\n\tmdelay(1);\n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_lutwe, RFREG_MASK, 0x80000);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_LUTWA, RFREG_MASK, 0x00004);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_LUTWD1, RFREG_MASK, 0x0005d);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_LUTWD0, RFREG_MASK, 0xBFFE0);\n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_lutwe, RFREG_MASK, 0x00000);\n\n\t \n\trtw_write32(rtwdev, REG_TXIQK_TONE_A_11N, 0x08008c0c);\n\trtw_write32(rtwdev, REG_RXIQK_TONE_A_11N, 0x38008c1c);\n\trtw_write32(rtwdev, REG_TXIQK_PI_A_11N, iqk_cfg->val_txiqk_pi);\n\trtw_write32(rtwdev, REG_RXIQK_PI_A_11N, 0x28160200);\n\trtw_write32(rtwdev, REG_TXIQK_11N, 0x01007c00);\n\trtw_write32(rtwdev, REG_RXIQK_11N, 0x01004800);\n\n\t \n\trtw_write32(rtwdev, REG_IQK_AGC_RSP_11N, 0x00462911);\n\n\t \n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_padlut, 0x800, 0x1);\n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_gaintx, 0x600, 0x0);\n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_gaintx, 0x1E0, 0x3);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_RXIQGEN, 0x1F, 0xf);\n\n\t \n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_lutwe, 0x10, 0x1);\n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_bspad, 0x1, 0x1);\n\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_WLINT, RFREG_MASK, iqk_cfg->val_wlint);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_WLSEL, RFREG_MASK, iqk_cfg->val_wlsel);\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] RF0x1 @%s TXIQK = 0x%x\\n\",\n\t\tiqk_cfg->name,\n\t\trtw_read_rf(rtwdev, RF_PATH_A, RF_WLINT, RFREG_MASK));\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] RF0x2 @%s TXIQK = 0x%x\\n\",\n\t\tiqk_cfg->name,\n\t\trtw_read_rf(rtwdev, RF_PATH_A, RF_WLSEL, RFREG_MASK));\n\n\trtw8723d_iqk_one_shot(rtwdev, true, iqk_cfg);\n\tstatus = rtw8723d_iqk_check_tx_failed(rtwdev, iqk_cfg);\n\n\trtw8723d_iqk_txrx_path_post(rtwdev, iqk_cfg, backup);\n\n\treturn status;\n}\n\nstatic u8 rtw8723d_iqk_rx_path(struct rtw_dev *rtwdev,\n\t\t\t       const struct rtw_8723d_iqk_cfg *iqk_cfg,\n\t\t\t       const struct iqk_backup_regs *backup)\n{\n\tu32 tx_x, tx_y;\n\tu8 status;\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] path %s RXIQK Step1!!\\n\",\n\t\tiqk_cfg->name);\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] 0x67 @%s RXIQK1 = 0x%x\\n\",\n\t\tiqk_cfg->name,\n\t\trtw_read32_mask(rtwdev, REG_PAD_CTRL1, MASKBYTE3));\n\trtw_write32(rtwdev, REG_BB_SEL_BTG, iqk_cfg->val_bb_sel_btg);\n\n\trtw_write32_mask(rtwdev, REG_FPGA0_IQK_11N, BIT_MASK_IQK_MOD, RST_IQK);\n\n\t \n\trtw_write32(rtwdev, REG_TXIQK_11N, 0x01007c00);\n\trtw_write32(rtwdev, REG_RXIQK_11N, 0x01004800);\n\n\t \n\trtw_write32(rtwdev, REG_TXIQK_TONE_A_11N, 0x18008c1c);\n\trtw_write32(rtwdev, REG_RXIQK_TONE_A_11N, 0x38008c1c);\n\trtw_write32(rtwdev, REG_TX_IQK_TONE_B, 0x38008c1c);\n\trtw_write32(rtwdev, REG_RX_IQK_TONE_B, 0x38008c1c);\n\trtw_write32(rtwdev, REG_TXIQK_PI_A_11N, 0x82160000);\n\trtw_write32(rtwdev, REG_RXIQK_PI_A_11N, 0x28160000);\n\n\t \n\trtw_write32(rtwdev, REG_IQK_AGC_RSP_11N, 0x0046a911);\n\n\t \n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_lutwe, RFREG_MASK, 0x80000);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_LUTWA, RFREG_MASK, 0x00006);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_LUTWD1, RFREG_MASK, 0x0005f);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_LUTWD0, RFREG_MASK, 0xa7ffb);\n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_lutwe, RFREG_MASK, 0x00000);\n\n\t \n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_padlut, 0x800, 0x1);\n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_gaintx, 0x600, 0x0);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_WLINT, RFREG_MASK, iqk_cfg->val_wlint);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_WLSEL, RFREG_MASK, iqk_cfg->val_wlsel);\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] RF0x1@ path %s RXIQK1 = 0x%x\\n\",\n\t\tiqk_cfg->name,\n\t\trtw_read_rf(rtwdev, RF_PATH_A, RF_WLINT, RFREG_MASK));\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] RF0x2@ path %s RXIQK1 = 0x%x\\n\",\n\t\tiqk_cfg->name,\n\t\trtw_read_rf(rtwdev, RF_PATH_A, RF_WLSEL, RFREG_MASK));\n\n\trtw8723d_iqk_one_shot(rtwdev, false, iqk_cfg);\n\tstatus = rtw8723d_iqk_check_tx_failed(rtwdev, iqk_cfg);\n\n\tif (!status)\n\t\tgoto restore;\n\n\t \n\ttx_x = rtw_read32_mask(rtwdev, REG_IQK_RES_TX, BIT_MASK_RES_TX);\n\ttx_y = rtw_read32_mask(rtwdev, REG_IQK_RES_TY, BIT_MASK_RES_TY);\n\n\trtw_write32(rtwdev, REG_TXIQK_11N, BIT_SET_TXIQK_11N(tx_x, tx_y));\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] 0xe40 = 0x%x u4tmp = 0x%x\\n\",\n\t\trtw_read32(rtwdev, REG_TXIQK_11N),\n\t\tBIT_SET_TXIQK_11N(tx_x, tx_y));\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] path %s RXIQK STEP2!!\\n\",\n\t\tiqk_cfg->name);\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] 0x67 @%s RXIQK2 = 0x%x\\n\",\n\t\tiqk_cfg->name,\n\t\trtw_read32_mask(rtwdev, REG_PAD_CTRL1, MASKBYTE3));\n\n\trtw_write32(rtwdev, REG_RXIQK_11N, 0x01004800);\n\trtw_write32(rtwdev, REG_TXIQK_TONE_A_11N, 0x38008c1c);\n\trtw_write32(rtwdev, REG_RXIQK_TONE_A_11N, 0x18008c1c);\n\trtw_write32(rtwdev, REG_TX_IQK_TONE_B, 0x38008c1c);\n\trtw_write32(rtwdev, REG_RX_IQK_TONE_B, 0x38008c1c);\n\trtw_write32(rtwdev, REG_TXIQK_PI_A_11N, 0x82170000);\n\trtw_write32(rtwdev, REG_RXIQK_PI_A_11N, 0x28171400);\n\n\t \n\trtw_write32(rtwdev, REG_IQK_AGC_RSP_11N, 0x0046a8d1);\n\n\t \n\trtw_write32_mask(rtwdev, REG_FPGA0_IQK_11N, BIT_MASK_IQK_MOD, RST_IQK);\n\tmdelay(1);\n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_lutwe, 0x80000, 0x1);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_LUTWA, RFREG_MASK, 0x00007);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_LUTWD1, RFREG_MASK, 0x0005f);\n\trtw_write_rf(rtwdev, RF_PATH_A, RF_LUTWD0, RFREG_MASK, 0xb3fdb);\n\trtw_write_rf(rtwdev, RF_PATH_A, iqk_cfg->reg_lutwe, RFREG_MASK, 0x00000);\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] RF0x1 @%s RXIQK2 = 0x%x\\n\",\n\t\tiqk_cfg->name,\n\t\trtw_read_rf(rtwdev, RF_PATH_A, RF_WLINT, RFREG_MASK));\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] RF0x2 @%s RXIQK2 = 0x%x\\n\",\n\t\tiqk_cfg->name,\n\t\trtw_read_rf(rtwdev, RF_PATH_A, RF_WLSEL, RFREG_MASK));\n\n\trtw8723d_iqk_one_shot(rtwdev, false, iqk_cfg);\n\tstatus |= rtw8723d_iqk_check_rx_failed(rtwdev, iqk_cfg);\n\nrestore:\n\trtw8723d_iqk_txrx_path_post(rtwdev, iqk_cfg, backup);\n\n\treturn status;\n}\n\nstatic\nvoid rtw8723d_iqk_fill_s1_matrix(struct rtw_dev *rtwdev, const s32 result[])\n{\n\ts32 oldval_1;\n\ts32 x, y;\n\ts32 tx1_a, tx1_a_ext;\n\ts32 tx1_c, tx1_c_ext;\n\n\tif (result[IQK_S1_TX_X] == 0)\n\t\treturn;\n\n\toldval_1 = rtw_read32_mask(rtwdev, REG_OFDM_0_XA_TX_IQ_IMBALANCE,\n\t\t\t\t   BIT_MASK_TXIQ_ELM_D);\n\n\tx = iqkxy_to_s32(result[IQK_S1_TX_X]);\n\ttx1_a = iqk_mult(x, oldval_1, &tx1_a_ext);\n\trtw_write32_mask(rtwdev, REG_OFDM_0_XA_TX_IQ_IMBALANCE,\n\t\t\t BIT_MASK_TXIQ_ELM_A, tx1_a);\n\trtw_write32_mask(rtwdev, REG_OFDM_0_ECCA_THRESHOLD,\n\t\t\t BIT_MASK_OFDM0_EXT_A, tx1_a_ext);\n\n\ty = iqkxy_to_s32(result[IQK_S1_TX_Y]);\n\ttx1_c = iqk_mult(y, oldval_1, &tx1_c_ext);\n\trtw_write32_mask(rtwdev, REG_TXIQK_MATRIXA_LSB2_11N, MASKH4BITS,\n\t\t\t BIT_SET_TXIQ_ELM_C1(tx1_c));\n\trtw_write32_mask(rtwdev, REG_OFDM_0_XA_TX_IQ_IMBALANCE,\n\t\t\t BIT_MASK_TXIQ_ELM_C, BIT_SET_TXIQ_ELM_C2(tx1_c));\n\trtw_write32_mask(rtwdev, REG_OFDM_0_ECCA_THRESHOLD,\n\t\t\t BIT_MASK_OFDM0_EXT_C, tx1_c_ext);\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\"[IQK] X = 0x%x, TX1_A = 0x%x, oldval_1 0x%x\\n\",\n\t\tx, tx1_a, oldval_1);\n\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\"[IQK] Y = 0x%x, TX1_C = 0x%x\\n\", y, tx1_c);\n\n\tif (result[IQK_S1_RX_X] == 0)\n\t\treturn;\n\n\trtw_write32_mask(rtwdev, REG_A_RXIQI, BIT_MASK_RXIQ_S1_X,\n\t\t\t result[IQK_S1_RX_X]);\n\trtw_write32_mask(rtwdev, REG_A_RXIQI, BIT_MASK_RXIQ_S1_Y1,\n\t\t\t BIT_SET_RXIQ_S1_Y1(result[IQK_S1_RX_Y]));\n\trtw_write32_mask(rtwdev, REG_RXIQK_MATRIX_LSB_11N, BIT_MASK_RXIQ_S1_Y2,\n\t\t\t BIT_SET_RXIQ_S1_Y2(result[IQK_S1_RX_Y]));\n}\n\nstatic\nvoid rtw8723d_iqk_fill_s0_matrix(struct rtw_dev *rtwdev, const s32 result[])\n{\n\ts32 oldval_0;\n\ts32 x, y;\n\ts32 tx0_a, tx0_a_ext;\n\ts32 tx0_c, tx0_c_ext;\n\n\tif (result[IQK_S0_TX_X] == 0)\n\t\treturn;\n\n\toldval_0 = rtw_read32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_D_S0);\n\n\tx = iqkxy_to_s32(result[IQK_S0_TX_X]);\n\ttx0_a = iqk_mult(x, oldval_0, &tx0_a_ext);\n\n\trtw_write32_mask(rtwdev, REG_TXIQ_AB_S0, BIT_MASK_TXIQ_A_S0, tx0_a);\n\trtw_write32_mask(rtwdev, REG_TXIQ_AB_S0, BIT_MASK_TXIQ_A_EXT_S0, tx0_a_ext);\n\n\ty = iqkxy_to_s32(result[IQK_S0_TX_Y]);\n\ttx0_c = iqk_mult(y, oldval_0, &tx0_c_ext);\n\n\trtw_write32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_C_S0, tx0_c);\n\trtw_write32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_C_EXT_S0, tx0_c_ext);\n\n\tif (result[IQK_S0_RX_X] == 0)\n\t\treturn;\n\n\trtw_write32_mask(rtwdev, REG_RXIQ_AB_S0, BIT_MASK_RXIQ_X_S0,\n\t\t\t result[IQK_S0_RX_X]);\n\trtw_write32_mask(rtwdev, REG_RXIQ_AB_S0, BIT_MASK_RXIQ_Y_S0,\n\t\t\t result[IQK_S0_RX_Y]);\n}\n\nstatic void rtw8723d_iqk_path_adda_on(struct rtw_dev *rtwdev)\n{\n\tint i;\n\n\tfor (i = 0; i < IQK_ADDA_REG_NUM; i++)\n\t\trtw_write32(rtwdev, iqk_adda_regs[i], 0x03c00016);\n}\n\nstatic void rtw8723d_iqk_config_mac(struct rtw_dev *rtwdev)\n{\n\trtw_write8(rtwdev, REG_TXPAUSE, 0xff);\n}\n\nstatic\nvoid rtw8723d_iqk_rf_standby(struct rtw_dev *rtwdev, enum rtw_rf_path path)\n{\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] path-%s standby mode!\\n\",\n\t\tpath == RF_PATH_A ? \"S1\" : \"S0\");\n\n\trtw_write32_mask(rtwdev, REG_FPGA0_IQK_11N, BIT_MASK_IQK_MOD, RST_IQK);\n\tmdelay(1);\n\trtw_write_rf(rtwdev, path, RF_MODE, RFREG_MASK, 0x10000);\n\trtw_write32_mask(rtwdev, REG_FPGA0_IQK_11N, BIT_MASK_IQK_MOD, EN_IQK);\n}\n\nstatic\nbool rtw8723d_iqk_similarity_cmp(struct rtw_dev *rtwdev, s32 result[][IQK_NR],\n\t\t\t\t u8 c1, u8 c2)\n{\n\tu32 i, j, diff;\n\tu32 bitmap = 0;\n\tu8 candidate[PATH_NR] = {IQK_ROUND_INVALID, IQK_ROUND_INVALID};\n\tbool ret = true;\n\n\ts32 tmp1, tmp2;\n\n\tfor (i = 0; i < IQK_NR; i++) {\n\t\ttmp1 = iqkxy_to_s32(result[c1][i]);\n\t\ttmp2 = iqkxy_to_s32(result[c2][i]);\n\n\t\tdiff = abs(tmp1 - tmp2);\n\n\t\tif (diff <= MAX_TOLERANCE)\n\t\t\tcontinue;\n\n\t\tif ((i == IQK_S1_RX_X || i == IQK_S0_RX_X) && !bitmap) {\n\t\t\tif (result[c1][i] + result[c1][i + 1] == 0)\n\t\t\t\tcandidate[i / IQK_SX_NR] = c2;\n\t\t\telse if (result[c2][i] + result[c2][i + 1] == 0)\n\t\t\t\tcandidate[i / IQK_SX_NR] = c1;\n\t\t\telse\n\t\t\t\tbitmap |= BIT(i);\n\t\t} else {\n\t\t\tbitmap |= BIT(i);\n\t\t}\n\t}\n\n\tif (bitmap != 0)\n\t\tgoto check_sim;\n\n\tfor (i = 0; i < PATH_NR; i++) {\n\t\tif (candidate[i] == IQK_ROUND_INVALID)\n\t\t\tcontinue;\n\n\t\tfor (j = i * IQK_SX_NR; j < i * IQK_SX_NR + 2; j++)\n\t\t\tresult[IQK_ROUND_HYBRID][j] = result[candidate[i]][j];\n\t\tret = false;\n\t}\n\n\treturn ret;\n\ncheck_sim:\n\tfor (i = 0; i < IQK_NR; i++) {\n\t\tj = i & ~1;\t \n\t\tif (bitmap & GENMASK(j + 1, j))\n\t\t\tcontinue;\n\n\t\tresult[IQK_ROUND_HYBRID][i] = result[c1][i];\n\t}\n\n\treturn false;\n}\n\nstatic\nvoid rtw8723d_iqk_precfg_path(struct rtw_dev *rtwdev, enum rtw8723d_path path)\n{\n\tif (path == PATH_S0) {\n\t\trtw8723d_iqk_rf_standby(rtwdev, RF_PATH_A);\n\t\trtw8723d_iqk_path_adda_on(rtwdev);\n\t}\n\n\trtw_write32_mask(rtwdev, REG_FPGA0_IQK_11N, BIT_MASK_IQK_MOD, EN_IQK);\n\trtw_write32(rtwdev, REG_TXIQK_11N, 0x01007c00);\n\trtw_write32(rtwdev, REG_RXIQK_11N, 0x01004800);\n\n\tif (path == PATH_S1) {\n\t\trtw8723d_iqk_rf_standby(rtwdev, RF_PATH_B);\n\t\trtw8723d_iqk_path_adda_on(rtwdev);\n\t}\n}\n\nstatic\nvoid rtw8723d_iqk_one_round(struct rtw_dev *rtwdev, s32 result[][IQK_NR], u8 t,\n\t\t\t    const struct iqk_backup_regs *backup)\n{\n\tu32 i;\n\tu8 s1_ok, s0_ok;\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\"[IQK] IQ Calibration for 1T1R_S0/S1 for %d times\\n\", t);\n\n\trtw8723d_iqk_path_adda_on(rtwdev);\n\trtw8723d_iqk_config_mac(rtwdev);\n\trtw_write32_mask(rtwdev, REG_CCK_ANT_SEL_11N, 0x0f000000, 0xf);\n\trtw_write32(rtwdev, REG_BB_RX_PATH_11N, 0x03a05611);\n\trtw_write32(rtwdev, REG_TRMUX_11N, 0x000800e4);\n\trtw_write32(rtwdev, REG_BB_PWR_SAV1_11N, 0x25204200);\n\trtw8723d_iqk_precfg_path(rtwdev, PATH_S1);\n\n\tfor (i = 0; i < PATH_IQK_RETRY; i++) {\n\t\ts1_ok = rtw8723d_iqk_tx_path(rtwdev, &iqk_tx_cfg[PATH_S1], backup);\n\t\tif (s1_ok == IQK_TX_OK) {\n\t\t\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\t\t\"[IQK] path S1 Tx IQK Success!!\\n\");\n\t\t\tresult[t][IQK_S1_TX_X] =\n\t\t\t  rtw_read32_mask(rtwdev, REG_IQK_RES_TX, BIT_MASK_RES_TX);\n\t\t\tresult[t][IQK_S1_TX_Y] =\n\t\t\t  rtw_read32_mask(rtwdev, REG_IQK_RES_TY, BIT_MASK_RES_TY);\n\t\t\tbreak;\n\t\t}\n\n\t\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] path S1 Tx IQK Fail!!\\n\");\n\t\tresult[t][IQK_S1_TX_X] = 0x100;\n\t\tresult[t][IQK_S1_TX_Y] = 0x0;\n\t}\n\n\tfor (i = 0; i < PATH_IQK_RETRY; i++) {\n\t\ts1_ok = rtw8723d_iqk_rx_path(rtwdev, &iqk_tx_cfg[PATH_S1], backup);\n\t\tif (s1_ok == (IQK_TX_OK | IQK_RX_OK)) {\n\t\t\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\t\t\"[IQK] path S1 Rx IQK Success!!\\n\");\n\t\t\tresult[t][IQK_S1_RX_X] =\n\t\t\t  rtw_read32_mask(rtwdev, REG_IQK_RES_RX, BIT_MASK_RES_RX);\n\t\t\tresult[t][IQK_S1_RX_Y] =\n\t\t\t  rtw_read32_mask(rtwdev, REG_IQK_RES_RY, BIT_MASK_RES_RY);\n\t\t\tbreak;\n\t\t}\n\n\t\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] path S1 Rx IQK Fail!!\\n\");\n\t\tresult[t][IQK_S1_RX_X] = 0x100;\n\t\tresult[t][IQK_S1_RX_Y] = 0x0;\n\t}\n\n\tif (s1_ok == 0x0)\n\t\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] path S1 IQK is failed!!\\n\");\n\n\trtw8723d_iqk_precfg_path(rtwdev, PATH_S0);\n\n\tfor (i = 0; i < PATH_IQK_RETRY; i++) {\n\t\ts0_ok = rtw8723d_iqk_tx_path(rtwdev, &iqk_tx_cfg[PATH_S0], backup);\n\t\tif (s0_ok == IQK_TX_OK) {\n\t\t\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\t\t\"[IQK] path S0 Tx IQK Success!!\\n\");\n\t\t\tresult[t][IQK_S0_TX_X] =\n\t\t\t  rtw_read32_mask(rtwdev, REG_IQK_RES_TX, BIT_MASK_RES_TX);\n\t\t\tresult[t][IQK_S0_TX_Y] =\n\t\t\t  rtw_read32_mask(rtwdev, REG_IQK_RES_TY, BIT_MASK_RES_TY);\n\t\t\tbreak;\n\t\t}\n\n\t\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] path S0 Tx IQK Fail!!\\n\");\n\t\tresult[t][IQK_S0_TX_X] = 0x100;\n\t\tresult[t][IQK_S0_TX_Y] = 0x0;\n\t}\n\n\tfor (i = 0; i < PATH_IQK_RETRY; i++) {\n\t\ts0_ok = rtw8723d_iqk_rx_path(rtwdev, &iqk_tx_cfg[PATH_S0], backup);\n\t\tif (s0_ok == (IQK_TX_OK | IQK_RX_OK)) {\n\t\t\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\t\t\"[IQK] path S0 Rx IQK Success!!\\n\");\n\n\t\t\tresult[t][IQK_S0_RX_X] =\n\t\t\t  rtw_read32_mask(rtwdev, REG_IQK_RES_RX, BIT_MASK_RES_RX);\n\t\t\tresult[t][IQK_S0_RX_Y] =\n\t\t\t  rtw_read32_mask(rtwdev, REG_IQK_RES_RY, BIT_MASK_RES_RY);\n\t\t\tbreak;\n\t\t}\n\n\t\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] path S0 Rx IQK Fail!!\\n\");\n\t\tresult[t][IQK_S0_RX_X] = 0x100;\n\t\tresult[t][IQK_S0_RX_Y] = 0x0;\n\t}\n\n\tif (s0_ok == 0x0)\n\t\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] path S0 IQK is failed!!\\n\");\n\n\trtw_write32_mask(rtwdev, REG_FPGA0_IQK_11N, BIT_MASK_IQK_MOD, RST_IQK);\n\tmdelay(1);\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\"[IQK] back to BB mode, load original value!\\n\");\n}\n\nstatic void rtw8723d_phy_calibration(struct rtw_dev *rtwdev)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\ts32 result[IQK_ROUND_SIZE][IQK_NR];\n\tstruct iqk_backup_regs backup;\n\tu8 i, j;\n\tu8 final_candidate = IQK_ROUND_INVALID;\n\tbool good;\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] Start!!!\\n\");\n\n\tmemset(result, 0, sizeof(result));\n\n\trtw8723d_iqk_backup_path_ctrl(rtwdev, &backup);\n\trtw8723d_iqk_backup_lte_path_gnt(rtwdev, &backup);\n\trtw8723d_iqk_backup_regs(rtwdev, &backup);\n\n\tfor (i = IQK_ROUND_0; i <= IQK_ROUND_2; i++) {\n\t\trtw8723d_iqk_config_path_ctrl(rtwdev);\n\t\trtw8723d_iqk_config_lte_path_gnt(rtwdev);\n\n\t\trtw8723d_iqk_one_round(rtwdev, result, i, &backup);\n\n\t\tif (i > IQK_ROUND_0)\n\t\t\trtw8723d_iqk_restore_regs(rtwdev, &backup);\n\t\trtw8723d_iqk_restore_lte_path_gnt(rtwdev, &backup);\n\t\trtw8723d_iqk_restore_path_ctrl(rtwdev, &backup);\n\n\t\tfor (j = IQK_ROUND_0; j < i; j++) {\n\t\t\tgood = rtw8723d_iqk_similarity_cmp(rtwdev, result, j, i);\n\n\t\t\tif (good) {\n\t\t\t\tfinal_candidate = j;\n\t\t\t\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\t\t\t\"[IQK] cmp %d:%d final_candidate is %x\\n\",\n\t\t\t\t\tj, i, final_candidate);\n\t\t\t\tgoto iqk_done;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (final_candidate == IQK_ROUND_INVALID) {\n\t\ts32 reg_tmp = 0;\n\n\t\tfor (i = 0; i < IQK_NR; i++)\n\t\t\treg_tmp += result[IQK_ROUND_HYBRID][i];\n\n\t\tif (reg_tmp != 0) {\n\t\t\tfinal_candidate = IQK_ROUND_HYBRID;\n\t\t} else {\n\t\t\tWARN(1, \"IQK is failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\t}\n\niqk_done:\n\trtw8723d_iqk_fill_s1_matrix(rtwdev, result[final_candidate]);\n\trtw8723d_iqk_fill_s0_matrix(rtwdev, result[final_candidate]);\n\n\tdm_info->iqk.result.s1_x = result[final_candidate][IQK_S1_TX_X];\n\tdm_info->iqk.result.s1_y = result[final_candidate][IQK_S1_TX_Y];\n\tdm_info->iqk.result.s0_x = result[final_candidate][IQK_S0_TX_X];\n\tdm_info->iqk.result.s0_y = result[final_candidate][IQK_S0_TX_Y];\n\tdm_info->iqk.done = true;\n\nout:\n\trtw_write32(rtwdev, REG_BB_SEL_BTG, backup.bb_sel_btg);\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] final_candidate is %x\\n\",\n\t\tfinal_candidate);\n\n\tfor (i = IQK_ROUND_0; i < IQK_ROUND_SIZE; i++)\n\t\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\t\"[IQK] Result %u: rege94_s1=%x rege9c_s1=%x regea4_s1=%x regeac_s1=%x rege94_s0=%x rege9c_s0=%x regea4_s0=%x regeac_s0=%x %s\\n\",\n\t\t\ti,\n\t\t\tresult[i][0], result[i][1], result[i][2], result[i][3],\n\t\t\tresult[i][4], result[i][5], result[i][6], result[i][7],\n\t\t\tfinal_candidate == i ? \"(final candidate)\" : \"\");\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\"[IQK]0xc80 = 0x%x 0xc94 = 0x%x 0xc14 = 0x%x 0xca0 = 0x%x\\n\",\n\t\trtw_read32(rtwdev, REG_OFDM_0_XA_TX_IQ_IMBALANCE),\n\t\trtw_read32(rtwdev, REG_TXIQK_MATRIXA_LSB2_11N),\n\t\trtw_read32(rtwdev, REG_A_RXIQI),\n\t\trtw_read32(rtwdev, REG_RXIQK_MATRIX_LSB_11N));\n\trtw_dbg(rtwdev, RTW_DBG_RFK,\n\t\t\"[IQK]0xcd0 = 0x%x 0xcd4 = 0x%x 0xcd8 = 0x%x\\n\",\n\t\trtw_read32(rtwdev, REG_TXIQ_AB_S0),\n\t\trtw_read32(rtwdev, REG_TXIQ_CD_S0),\n\t\trtw_read32(rtwdev, REG_RXIQ_AB_S0));\n\n\trtw_dbg(rtwdev, RTW_DBG_RFK, \"[IQK] finished\\n\");\n}\n\nstatic void rtw8723d_phy_cck_pd_set(struct rtw_dev *rtwdev, u8 new_lvl)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\tu8 pd[CCK_PD_LV_MAX] = {3, 7, 13, 13, 13};\n\tu8 cck_n_rx;\n\n\trtw_dbg(rtwdev, RTW_DBG_PHY, \"lv: (%d) -> (%d)\\n\",\n\t\tdm_info->cck_pd_lv[RTW_CHANNEL_WIDTH_20][RF_PATH_A], new_lvl);\n\n\tif (dm_info->cck_pd_lv[RTW_CHANNEL_WIDTH_20][RF_PATH_A] == new_lvl)\n\t\treturn;\n\n\tcck_n_rx = (rtw_read8_mask(rtwdev, REG_CCK0_FAREPORT, BIT_CCK0_2RX) &&\n\t\t    rtw_read8_mask(rtwdev, REG_CCK0_FAREPORT, BIT_CCK0_MRC)) ? 2 : 1;\n\trtw_dbg(rtwdev, RTW_DBG_PHY,\n\t\t\"is_linked=%d, lv=%d, n_rx=%d, cs_ratio=0x%x, pd_th=0x%x, cck_fa_avg=%d\\n\",\n\t\trtw_is_assoc(rtwdev), new_lvl, cck_n_rx,\n\t\tdm_info->cck_pd_default + new_lvl * 2,\n\t\tpd[new_lvl], dm_info->cck_fa_avg);\n\n\tdm_info->cck_fa_avg = CCK_FA_AVG_RESET;\n\n\tdm_info->cck_pd_lv[RTW_CHANNEL_WIDTH_20][RF_PATH_A] = new_lvl;\n\trtw_write32_mask(rtwdev, REG_PWRTH, 0x3f0000, pd[new_lvl]);\n\trtw_write32_mask(rtwdev, REG_PWRTH2, 0x1f0000,\n\t\t\t dm_info->cck_pd_default + new_lvl * 2);\n}\n\n \nstatic void rtw8723d_coex_cfg_init(struct rtw_dev *rtwdev)\n{\n\t \n\trtw_write8_set(rtwdev, REG_BCN_CTRL, BIT_EN_BCN_FUNCTION);\n\n\t \n\t \n\trtw_write8_mask(rtwdev, REG_BT_TDMA_TIME, BIT_MASK_SAMPLE_RATE, 0x5);\n\n\t \n\trtw_write8(rtwdev, REG_BT_STAT_CTRL, 0x1);\n\n\t \n\trtw_write32_set(rtwdev, REG_GPIO_MUXCFG, BIT_BT_PTA_EN);\n\trtw_write32_set(rtwdev, REG_GPIO_MUXCFG, BIT_PO_BT_PTA_PINS);\n\n\t \n\trtw_write8_set(rtwdev, REG_QUEUE_CTRL, BIT_PTA_WL_TX_EN);\n}\n\nstatic void rtw8723d_coex_cfg_gnt_fix(struct rtw_dev *rtwdev)\n{\n}\n\nstatic void rtw8723d_coex_cfg_gnt_debug(struct rtw_dev *rtwdev)\n{\n\trtw_write8_mask(rtwdev, REG_LEDCFG2, BIT(6), 0);\n\trtw_write8_mask(rtwdev, REG_PAD_CTRL1 + 3, BIT(0), 0);\n\trtw_write8_mask(rtwdev, REG_GPIO_INTM + 2, BIT(4), 0);\n\trtw_write8_mask(rtwdev, REG_GPIO_MUXCFG + 2, BIT(1), 0);\n\trtw_write8_mask(rtwdev, REG_PAD_CTRL1 + 3, BIT(1), 0);\n\trtw_write8_mask(rtwdev, REG_PAD_CTRL1 + 2, BIT(7), 0);\n\trtw_write8_mask(rtwdev, REG_SYS_CLKR + 1, BIT(1), 0);\n\trtw_write8_mask(rtwdev, REG_SYS_SDIO_CTRL + 3, BIT(3), 0);\n}\n\nstatic void rtw8723d_coex_cfg_rfe_type(struct rtw_dev *rtwdev)\n{\n\tstruct rtw_efuse *efuse = &rtwdev->efuse;\n\tstruct rtw_coex *coex = &rtwdev->coex;\n\tstruct rtw_coex_rfe *coex_rfe = &coex->rfe;\n\tbool aux = efuse->bt_setting & BIT(6);\n\n\tcoex_rfe->rfe_module_type = rtwdev->efuse.rfe_option;\n\tcoex_rfe->ant_switch_polarity = 0;\n\tcoex_rfe->ant_switch_exist = false;\n\tcoex_rfe->ant_switch_with_bt = false;\n\tcoex_rfe->ant_switch_diversity = false;\n\tcoex_rfe->wlg_at_btg = true;\n\n\t \n\tif (efuse->share_ant) {\n\t\tif (aux)\n\t\t\trtw_write16(rtwdev, REG_BB_SEL_BTG, 0x80);\n\t\telse\n\t\t\trtw_write16(rtwdev, REG_BB_SEL_BTG, 0x200);\n\t} else {\n\t\tif (aux)\n\t\t\trtw_write16(rtwdev, REG_BB_SEL_BTG, 0x280);\n\t\telse\n\t\t\trtw_write16(rtwdev, REG_BB_SEL_BTG, 0x0);\n\t}\n\n\t \n\trtw_coex_write_indirect_reg(rtwdev, LTE_COEX_CTRL, BIT_LTE_COEX_EN, 0x0);\n\trtw_coex_write_indirect_reg(rtwdev, LTE_WL_TRX_CTRL, MASKLWORD, 0xffff);\n\trtw_coex_write_indirect_reg(rtwdev, LTE_BT_TRX_CTRL, MASKLWORD, 0xffff);\n}\n\nstatic void rtw8723d_coex_cfg_wl_tx_power(struct rtw_dev *rtwdev, u8 wl_pwr)\n{\n\tstruct rtw_coex *coex = &rtwdev->coex;\n\tstruct rtw_coex_dm *coex_dm = &coex->dm;\n\tstatic const u8\twl_tx_power[] = {0xb2, 0x90};\n\tu8 pwr;\n\n\tif (wl_pwr == coex_dm->cur_wl_pwr_lvl)\n\t\treturn;\n\n\tcoex_dm->cur_wl_pwr_lvl = wl_pwr;\n\n\tif (coex_dm->cur_wl_pwr_lvl >= ARRAY_SIZE(wl_tx_power))\n\t\tcoex_dm->cur_wl_pwr_lvl = ARRAY_SIZE(wl_tx_power) - 1;\n\n\tpwr = wl_tx_power[coex_dm->cur_wl_pwr_lvl];\n\n\trtw_write8(rtwdev, REG_ANA_PARAM1 + 3, pwr);\n}\n\nstatic void rtw8723d_coex_cfg_wl_rx_gain(struct rtw_dev *rtwdev, bool low_gain)\n{\n\tstruct rtw_coex *coex = &rtwdev->coex;\n\tstruct rtw_coex_dm *coex_dm = &coex->dm;\n\t \n\tstatic const u32 wl_rx_low_gain_on[] = {\n\t\t0xec120101, 0xeb130101, 0xce140101, 0xcd150101, 0xcc160101,\n\t\t0xcb170101, 0xca180101, 0x8d190101, 0x8c1a0101, 0x8b1b0101,\n\t\t0x4f1c0101, 0x4e1d0101, 0x4d1e0101, 0x4c1f0101, 0x0e200101,\n\t\t0x0d210101, 0x0c220101, 0x0b230101, 0xcf240001, 0xce250001,\n\t\t0xcd260001, 0xcc270001, 0x8f280001\n\t};\n\t \n\tstatic const u32 wl_rx_low_gain_off[] = {\n\t\t0xec120101, 0xeb130101, 0xea140101, 0xe9150101, 0xe8160101,\n\t\t0xe7170101, 0xe6180101, 0xe5190101, 0xe41a0101, 0xe31b0101,\n\t\t0xe21c0101, 0xe11d0101, 0xe01e0101, 0x861f0101, 0x85200101,\n\t\t0x84210101, 0x83220101, 0x82230101, 0x81240101, 0x80250101,\n\t\t0x44260101, 0x43270101, 0x42280101\n\t};\n\tu8 i;\n\n\tif (low_gain == coex_dm->cur_wl_rx_low_gain_en)\n\t\treturn;\n\n\tcoex_dm->cur_wl_rx_low_gain_en = low_gain;\n\n\tif (coex_dm->cur_wl_rx_low_gain_en) {\n\t\tfor (i = 0; i < ARRAY_SIZE(wl_rx_low_gain_on); i++)\n\t\t\trtw_write32(rtwdev, REG_AGCRSSI, wl_rx_low_gain_on[i]);\n\t} else {\n\t\tfor (i = 0; i < ARRAY_SIZE(wl_rx_low_gain_off); i++)\n\t\t\trtw_write32(rtwdev, REG_AGCRSSI, wl_rx_low_gain_off[i]);\n\t}\n}\n\nstatic u8 rtw8723d_pwrtrack_get_limit_ofdm(struct rtw_dev *rtwdev)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\tu8 tx_rate = dm_info->tx_rate;\n\tu8 limit_ofdm = 30;\n\n\tswitch (tx_rate) {\n\tcase DESC_RATE1M...DESC_RATE5_5M:\n\tcase DESC_RATE11M:\n\t\tbreak;\n\tcase DESC_RATE6M...DESC_RATE48M:\n\t\tlimit_ofdm = 36;\n\t\tbreak;\n\tcase DESC_RATE54M:\n\t\tlimit_ofdm = 34;\n\t\tbreak;\n\tcase DESC_RATEMCS0...DESC_RATEMCS2:\n\t\tlimit_ofdm = 38;\n\t\tbreak;\n\tcase DESC_RATEMCS3...DESC_RATEMCS4:\n\t\tlimit_ofdm = 36;\n\t\tbreak;\n\tcase DESC_RATEMCS5...DESC_RATEMCS7:\n\t\tlimit_ofdm = 34;\n\t\tbreak;\n\tdefault:\n\t\trtw_warn(rtwdev, \"pwrtrack unhandled tx_rate 0x%x\\n\", tx_rate);\n\t\tbreak;\n\t}\n\n\treturn limit_ofdm;\n}\n\nstatic void rtw8723d_set_iqk_matrix_by_result(struct rtw_dev *rtwdev,\n\t\t\t\t\t      u32 ofdm_swing, u8 rf_path)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\ts32 ele_A, ele_D, ele_C;\n\ts32 ele_A_ext, ele_C_ext, ele_D_ext;\n\ts32 iqk_result_x;\n\ts32 iqk_result_y;\n\ts32 value32;\n\n\tswitch (rf_path) {\n\tdefault:\n\tcase RF_PATH_A:\n\t\tiqk_result_x = dm_info->iqk.result.s1_x;\n\t\tiqk_result_y = dm_info->iqk.result.s1_y;\n\t\tbreak;\n\tcase RF_PATH_B:\n\t\tiqk_result_x = dm_info->iqk.result.s0_x;\n\t\tiqk_result_y = dm_info->iqk.result.s0_y;\n\t\tbreak;\n\t}\n\n\t \n\tele_D = OFDM_SWING_D(ofdm_swing);\n\tiqk_mult(iqk_result_x, ele_D, &ele_D_ext);\n\t \n\tiqk_result_x = iqkxy_to_s32(iqk_result_x);\n\tele_A = iqk_mult(iqk_result_x, ele_D, &ele_A_ext);\n\t \n\tiqk_result_y = iqkxy_to_s32(iqk_result_y);\n\tele_C = iqk_mult(iqk_result_y, ele_D, &ele_C_ext);\n\n\tswitch (rf_path) {\n\tcase RF_PATH_A:\n\tdefault:\n\t\t \n\t\tvalue32 = BIT_SET_TXIQ_ELM_ACD(ele_A, ele_C, ele_D);\n\t\trtw_write32(rtwdev, REG_OFDM_0_XA_TX_IQ_IMBALANCE, value32);\n\t\tvalue32 = BIT_SET_TXIQ_ELM_C1(ele_C);\n\t\trtw_write32_mask(rtwdev, REG_TXIQK_MATRIXA_LSB2_11N, MASKH4BITS,\n\t\t\t\t value32);\n\t\tvalue32 = rtw_read32(rtwdev, REG_OFDM_0_ECCA_THRESHOLD);\n\t\tvalue32 &= ~BIT_MASK_OFDM0_EXTS;\n\t\tvalue32 |= BIT_SET_OFDM0_EXTS(ele_A_ext, ele_C_ext, ele_D_ext);\n\t\trtw_write32(rtwdev, REG_OFDM_0_ECCA_THRESHOLD, value32);\n\t\tbreak;\n\n\tcase RF_PATH_B:\n\t\t \n\t\trtw_write32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_D_S0, ele_D);\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_C_S0, ele_C);\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_AB_S0, BIT_MASK_TXIQ_A_S0, ele_A);\n\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_D_EXT_S0,\n\t\t\t\t ele_D_ext);\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_AB_S0, BIT_MASK_TXIQ_A_EXT_S0,\n\t\t\t\t ele_A_ext);\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_C_EXT_S0,\n\t\t\t\t ele_C_ext);\n\t\tbreak;\n\t}\n}\n\nstatic void rtw8723d_set_iqk_matrix(struct rtw_dev *rtwdev, s8 ofdm_index,\n\t\t\t\t    u8 rf_path)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\ts32 value32;\n\tu32 ofdm_swing;\n\n\tif (ofdm_index >= RTW_OFDM_SWING_TABLE_SIZE)\n\t\tofdm_index = RTW_OFDM_SWING_TABLE_SIZE - 1;\n\telse if (ofdm_index < 0)\n\t\tofdm_index = 0;\n\n\tofdm_swing = rtw8723d_ofdm_swing_table[ofdm_index];\n\n\tif (dm_info->iqk.done) {\n\t\trtw8723d_set_iqk_matrix_by_result(rtwdev, ofdm_swing, rf_path);\n\t\treturn;\n\t}\n\n\tswitch (rf_path) {\n\tcase RF_PATH_A:\n\tdefault:\n\t\trtw_write32(rtwdev, REG_OFDM_0_XA_TX_IQ_IMBALANCE, ofdm_swing);\n\t\trtw_write32_mask(rtwdev, REG_TXIQK_MATRIXA_LSB2_11N, MASKH4BITS,\n\t\t\t\t 0x00);\n\t\tvalue32 = rtw_read32(rtwdev, REG_OFDM_0_ECCA_THRESHOLD);\n\t\tvalue32 &= ~BIT_MASK_OFDM0_EXTS;\n\t\trtw_write32(rtwdev, REG_OFDM_0_ECCA_THRESHOLD, value32);\n\t\tbreak;\n\n\tcase RF_PATH_B:\n\t\t \n\t\trtw_write32_mask(rtwdev, REG_TXIQ_AB_S0, BIT_MASK_TXIQ_A_S0,\n\t\t\t\t OFDM_SWING_A(ofdm_swing));\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_AB_S0, BIT_MASK_TXIQ_B_S0,\n\t\t\t\t OFDM_SWING_B(ofdm_swing));\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_C_S0,\n\t\t\t\t OFDM_SWING_C(ofdm_swing));\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_D_S0,\n\t\t\t\t OFDM_SWING_D(ofdm_swing));\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_D_EXT_S0, 0x0);\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_CD_S0, BIT_MASK_TXIQ_C_EXT_S0, 0x0);\n\t\trtw_write32_mask(rtwdev, REG_TXIQ_AB_S0, BIT_MASK_TXIQ_A_EXT_S0, 0x0);\n\t\tbreak;\n\t}\n}\n\nstatic void rtw8723d_pwrtrack_set_ofdm_pwr(struct rtw_dev *rtwdev, s8 swing_idx,\n\t\t\t\t\t   s8 txagc_idx)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\n\tdm_info->txagc_remnant_ofdm = txagc_idx;\n\n\trtw8723d_set_iqk_matrix(rtwdev, swing_idx, RF_PATH_A);\n\trtw8723d_set_iqk_matrix(rtwdev, swing_idx, RF_PATH_B);\n}\n\nstatic void rtw8723d_pwrtrack_set_cck_pwr(struct rtw_dev *rtwdev, s8 swing_idx,\n\t\t\t\t\t  s8 txagc_idx)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\n\tdm_info->txagc_remnant_cck = txagc_idx;\n\n\trtw_write32_mask(rtwdev, 0xab4, 0x000007FF,\n\t\t\t rtw8723d_cck_swing_table[swing_idx]);\n}\n\nstatic void rtw8723d_pwrtrack_set(struct rtw_dev *rtwdev, u8 path)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\tstruct rtw_hal *hal = &rtwdev->hal;\n\tu8 limit_ofdm;\n\tu8 limit_cck = 40;\n\ts8 final_ofdm_swing_index;\n\ts8 final_cck_swing_index;\n\n\tlimit_ofdm = rtw8723d_pwrtrack_get_limit_ofdm(rtwdev);\n\n\tfinal_ofdm_swing_index = RTW_DEF_OFDM_SWING_INDEX +\n\t\t\t\t dm_info->delta_power_index[path];\n\tfinal_cck_swing_index = RTW_DEF_CCK_SWING_INDEX +\n\t\t\t\tdm_info->delta_power_index[path];\n\n\tif (final_ofdm_swing_index > limit_ofdm)\n\t\trtw8723d_pwrtrack_set_ofdm_pwr(rtwdev, limit_ofdm,\n\t\t\t\t\t       final_ofdm_swing_index - limit_ofdm);\n\telse if (final_ofdm_swing_index < 0)\n\t\trtw8723d_pwrtrack_set_ofdm_pwr(rtwdev, 0,\n\t\t\t\t\t       final_ofdm_swing_index);\n\telse\n\t\trtw8723d_pwrtrack_set_ofdm_pwr(rtwdev, final_ofdm_swing_index, 0);\n\n\tif (final_cck_swing_index > limit_cck)\n\t\trtw8723d_pwrtrack_set_cck_pwr(rtwdev, limit_cck,\n\t\t\t\t\t      final_cck_swing_index - limit_cck);\n\telse if (final_cck_swing_index < 0)\n\t\trtw8723d_pwrtrack_set_cck_pwr(rtwdev, 0,\n\t\t\t\t\t      final_cck_swing_index);\n\telse\n\t\trtw8723d_pwrtrack_set_cck_pwr(rtwdev, final_cck_swing_index, 0);\n\n\trtw_phy_set_tx_power_level(rtwdev, hal->current_channel);\n}\n\nstatic void rtw8723d_pwrtrack_set_xtal(struct rtw_dev *rtwdev, u8 therm_path,\n\t\t\t\t       u8 delta)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\tconst struct rtw_pwr_track_tbl *tbl = rtwdev->chip->pwr_track_tbl;\n\tconst s8 *pwrtrk_xtal;\n\ts8 xtal_cap;\n\n\tif (dm_info->thermal_avg[therm_path] >\n\t    rtwdev->efuse.thermal_meter[therm_path])\n\t\tpwrtrk_xtal = tbl->pwrtrk_xtal_p;\n\telse\n\t\tpwrtrk_xtal = tbl->pwrtrk_xtal_n;\n\n\txtal_cap = rtwdev->efuse.crystal_cap & 0x3F;\n\txtal_cap = clamp_t(s8, xtal_cap + pwrtrk_xtal[delta], 0, 0x3F);\n\trtw_write32_mask(rtwdev, REG_AFE_CTRL3, BIT_MASK_XTAL,\n\t\t\t xtal_cap | (xtal_cap << 6));\n}\n\nstatic void rtw8723d_phy_pwrtrack(struct rtw_dev *rtwdev)\n{\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\tstruct rtw_swing_table swing_table;\n\tu8 thermal_value, delta, path;\n\tbool do_iqk = false;\n\n\trtw_phy_config_swing_table(rtwdev, &swing_table);\n\n\tif (rtwdev->efuse.thermal_meter[0] == 0xff)\n\t\treturn;\n\n\tthermal_value = rtw_read_rf(rtwdev, RF_PATH_A, RF_T_METER, 0xfc00);\n\n\trtw_phy_pwrtrack_avg(rtwdev, thermal_value, RF_PATH_A);\n\n\tdo_iqk = rtw_phy_pwrtrack_need_iqk(rtwdev);\n\n\tif (do_iqk)\n\t\trtw8723d_lck(rtwdev);\n\n\tif (dm_info->pwr_trk_init_trigger)\n\t\tdm_info->pwr_trk_init_trigger = false;\n\telse if (!rtw_phy_pwrtrack_thermal_changed(rtwdev, thermal_value,\n\t\t\t\t\t\t   RF_PATH_A))\n\t\tgoto iqk;\n\n\tdelta = rtw_phy_pwrtrack_get_delta(rtwdev, RF_PATH_A);\n\n\tdelta = min_t(u8, delta, RTW_PWR_TRK_TBL_SZ - 1);\n\n\tfor (path = 0; path < rtwdev->hal.rf_path_num; path++) {\n\t\ts8 delta_cur, delta_last;\n\n\t\tdelta_last = dm_info->delta_power_index[path];\n\t\tdelta_cur = rtw_phy_pwrtrack_get_pwridx(rtwdev, &swing_table,\n\t\t\t\t\t\t\tpath, RF_PATH_A, delta);\n\t\tif (delta_last == delta_cur)\n\t\t\tcontinue;\n\n\t\tdm_info->delta_power_index[path] = delta_cur;\n\t\trtw8723d_pwrtrack_set(rtwdev, path);\n\t}\n\n\trtw8723d_pwrtrack_set_xtal(rtwdev, RF_PATH_A, delta);\n\niqk:\n\tif (do_iqk)\n\t\trtw8723d_phy_calibration(rtwdev);\n}\n\nstatic void rtw8723d_pwr_track(struct rtw_dev *rtwdev)\n{\n\tstruct rtw_efuse *efuse = &rtwdev->efuse;\n\tstruct rtw_dm_info *dm_info = &rtwdev->dm_info;\n\n\tif (efuse->power_track_type != 0)\n\t\treturn;\n\n\tif (!dm_info->pwr_trk_triggered) {\n\t\trtw_write_rf(rtwdev, RF_PATH_A, RF_T_METER,\n\t\t\t     GENMASK(17, 16), 0x03);\n\t\tdm_info->pwr_trk_triggered = true;\n\t\treturn;\n\t}\n\n\trtw8723d_phy_pwrtrack(rtwdev);\n\tdm_info->pwr_trk_triggered = false;\n}\n\nstatic void rtw8723d_fill_txdesc_checksum(struct rtw_dev *rtwdev,\n\t\t\t\t\t  struct rtw_tx_pkt_info *pkt_info,\n\t\t\t\t\t  u8 *txdesc)\n{\n\tsize_t words = 32 / 2;  \n\t__le16 chksum = 0;\n\t__le16 *data = (__le16 *)(txdesc);\n\tstruct rtw_tx_desc *tx_desc = (struct rtw_tx_desc *)txdesc;\n\n\tle32p_replace_bits(&tx_desc->w7, 0, RTW_TX_DESC_W7_TXDESC_CHECKSUM);\n\n\twhile (words--)\n\t\tchksum ^= *data++;\n\n\tchksum = ~chksum;\n\n\tle32p_replace_bits(&tx_desc->w7, __le16_to_cpu(chksum),\n\t\t\t   RTW_TX_DESC_W7_TXDESC_CHECKSUM);\n}\n\nstatic struct rtw_chip_ops rtw8723d_ops = {\n\t.phy_set_param\t\t= rtw8723d_phy_set_param,\n\t.read_efuse\t\t= rtw8723d_read_efuse,\n\t.query_rx_desc\t\t= rtw8723d_query_rx_desc,\n\t.set_channel\t\t= rtw8723d_set_channel,\n\t.mac_init\t\t= rtw8723d_mac_init,\n\t.shutdown\t\t= rtw8723d_shutdown,\n\t.read_rf\t\t= rtw_phy_read_rf_sipi,\n\t.write_rf\t\t= rtw_phy_write_rf_reg_sipi,\n\t.set_tx_power_index\t= rtw8723d_set_tx_power_index,\n\t.set_antenna\t\t= NULL,\n\t.cfg_ldo25\t\t= rtw8723d_cfg_ldo25,\n\t.efuse_grant\t\t= rtw8723d_efuse_grant,\n\t.false_alarm_statistics\t= rtw8723d_false_alarm_statistics,\n\t.phy_calibration\t= rtw8723d_phy_calibration,\n\t.cck_pd_set\t\t= rtw8723d_phy_cck_pd_set,\n\t.pwr_track\t\t= rtw8723d_pwr_track,\n\t.config_bfee\t\t= NULL,\n\t.set_gid_table\t\t= NULL,\n\t.cfg_csi_rate\t\t= NULL,\n\t.fill_txdesc_checksum\t= rtw8723d_fill_txdesc_checksum,\n\n\t.coex_set_init\t\t= rtw8723d_coex_cfg_init,\n\t.coex_set_ant_switch\t= NULL,\n\t.coex_set_gnt_fix\t= rtw8723d_coex_cfg_gnt_fix,\n\t.coex_set_gnt_debug\t= rtw8723d_coex_cfg_gnt_debug,\n\t.coex_set_rfe_type\t= rtw8723d_coex_cfg_rfe_type,\n\t.coex_set_wl_tx_power\t= rtw8723d_coex_cfg_wl_tx_power,\n\t.coex_set_wl_rx_gain\t= rtw8723d_coex_cfg_wl_rx_gain,\n};\n\n \nstatic const struct coex_table_para table_sant_8723d[] = {\n\t{0xffffffff, 0xffffffff},  \n\t{0x55555555, 0x55555555},\n\t{0x66555555, 0x66555555},\n\t{0xaaaaaaaa, 0xaaaaaaaa},\n\t{0x5a5a5a5a, 0x5a5a5a5a},\n\t{0xfafafafa, 0xfafafafa},  \n\t{0x6a5a5555, 0xaaaaaaaa},\n\t{0x6a5a56aa, 0x6a5a56aa},\n\t{0x6a5a5a5a, 0x6a5a5a5a},\n\t{0x66555555, 0x5a5a5a5a},\n\t{0x66555555, 0x6a5a5a5a},  \n\t{0x66555555, 0x6a5a5aaa},\n\t{0x66555555, 0x5a5a5aaa},\n\t{0x66555555, 0x6aaa5aaa},\n\t{0x66555555, 0xaaaa5aaa},\n\t{0x66555555, 0xaaaaaaaa},  \n\t{0xffff55ff, 0xfafafafa},\n\t{0xffff55ff, 0x6afa5afa},\n\t{0xaaffffaa, 0xfafafafa},\n\t{0xaa5555aa, 0x5a5a5a5a},\n\t{0xaa5555aa, 0x6a5a5a5a},  \n\t{0xaa5555aa, 0xaaaaaaaa},\n\t{0xffffffff, 0x5a5a5a5a},\n\t{0xffffffff, 0x5a5a5a5a},\n\t{0xffffffff, 0x55555555},\n\t{0xffffffff, 0x5a5a5aaa},  \n\t{0x55555555, 0x5a5a5a5a},\n\t{0x55555555, 0xaaaaaaaa},\n\t{0x55555555, 0x6a5a6a5a},\n\t{0x66556655, 0x66556655},\n\t{0x66556aaa, 0x6a5a6aaa},  \n\t{0xffffffff, 0x5aaa5aaa},\n\t{0x56555555, 0x5a5a5aaa},\n};\n\n \nstatic const struct coex_table_para table_nsant_8723d[] = {\n\t{0xffffffff, 0xffffffff},  \n\t{0x55555555, 0x55555555},\n\t{0x66555555, 0x66555555},\n\t{0xaaaaaaaa, 0xaaaaaaaa},\n\t{0x5a5a5a5a, 0x5a5a5a5a},\n\t{0xfafafafa, 0xfafafafa},  \n\t{0x5afa5afa, 0x5afa5afa},\n\t{0x55555555, 0xfafafafa},\n\t{0x66555555, 0xfafafafa},\n\t{0x66555555, 0x5a5a5a5a},\n\t{0x66555555, 0x6a5a5a5a},  \n\t{0x66555555, 0xaaaaaaaa},\n\t{0xffff55ff, 0xfafafafa},\n\t{0xffff55ff, 0x5afa5afa},\n\t{0xffff55ff, 0xaaaaaaaa},\n\t{0xffff55ff, 0xffff55ff},  \n\t{0xaaffffaa, 0x5afa5afa},\n\t{0xaaffffaa, 0xaaaaaaaa},\n\t{0xffffffff, 0xfafafafa},\n\t{0xffffffff, 0x5afa5afa},\n\t{0xffffffff, 0xaaaaaaaa},  \n\t{0x55ff55ff, 0x5afa5afa},\n\t{0x55ff55ff, 0xaaaaaaaa},\n\t{0x55ff55ff, 0x55ff55ff}\n};\n\n \nstatic const struct coex_tdma_para tdma_sant_8723d[] = {\n\t{ {0x00, 0x00, 0x00, 0x00, 0x00} },  \n\t{ {0x61, 0x45, 0x03, 0x11, 0x11} },  \n\t{ {0x61, 0x3a, 0x03, 0x11, 0x11} },\n\t{ {0x61, 0x30, 0x03, 0x11, 0x11} },\n\t{ {0x61, 0x20, 0x03, 0x11, 0x11} },\n\t{ {0x61, 0x10, 0x03, 0x11, 0x11} },  \n\t{ {0x61, 0x45, 0x03, 0x11, 0x10} },\n\t{ {0x61, 0x3a, 0x03, 0x11, 0x10} },\n\t{ {0x61, 0x30, 0x03, 0x11, 0x10} },\n\t{ {0x61, 0x20, 0x03, 0x11, 0x10} },\n\t{ {0x61, 0x10, 0x03, 0x11, 0x10} },  \n\t{ {0x61, 0x08, 0x03, 0x11, 0x14} },\n\t{ {0x61, 0x08, 0x03, 0x10, 0x14} },\n\t{ {0x51, 0x08, 0x03, 0x10, 0x54} },\n\t{ {0x51, 0x08, 0x03, 0x10, 0x55} },\n\t{ {0x51, 0x08, 0x07, 0x10, 0x54} },  \n\t{ {0x51, 0x45, 0x03, 0x10, 0x50} },\n\t{ {0x51, 0x3a, 0x03, 0x10, 0x50} },\n\t{ {0x51, 0x30, 0x03, 0x10, 0x50} },\n\t{ {0x51, 0x20, 0x03, 0x10, 0x50} },\n\t{ {0x51, 0x10, 0x03, 0x10, 0x50} },  \n\t{ {0x51, 0x4a, 0x03, 0x10, 0x50} },\n\t{ {0x51, 0x0c, 0x03, 0x10, 0x54} },\n\t{ {0x55, 0x08, 0x03, 0x10, 0x54} },\n\t{ {0x65, 0x10, 0x03, 0x11, 0x10} },\n\t{ {0x51, 0x10, 0x03, 0x10, 0x51} },  \n\t{ {0x51, 0x08, 0x03, 0x10, 0x50} },\n\t{ {0x61, 0x08, 0x03, 0x11, 0x11} }\n};\n\n \nstatic const struct coex_tdma_para tdma_nsant_8723d[] = {\n\t{ {0x00, 0x00, 0x00, 0x00, 0x01} },  \n\t{ {0x61, 0x45, 0x03, 0x11, 0x11} },  \n\t{ {0x61, 0x3a, 0x03, 0x11, 0x11} },\n\t{ {0x61, 0x30, 0x03, 0x11, 0x11} },\n\t{ {0x61, 0x20, 0x03, 0x11, 0x11} },\n\t{ {0x61, 0x10, 0x03, 0x11, 0x11} },  \n\t{ {0x61, 0x45, 0x03, 0x11, 0x10} },\n\t{ {0x61, 0x3a, 0x03, 0x11, 0x10} },\n\t{ {0x61, 0x30, 0x03, 0x11, 0x10} },\n\t{ {0x61, 0x20, 0x03, 0x11, 0x10} },\n\t{ {0x61, 0x10, 0x03, 0x11, 0x10} },  \n\t{ {0x61, 0x08, 0x03, 0x11, 0x14} },\n\t{ {0x61, 0x08, 0x03, 0x10, 0x14} },\n\t{ {0x51, 0x08, 0x03, 0x10, 0x54} },\n\t{ {0x51, 0x08, 0x03, 0x10, 0x55} },\n\t{ {0x51, 0x08, 0x07, 0x10, 0x54} },  \n\t{ {0x51, 0x45, 0x03, 0x10, 0x50} },\n\t{ {0x51, 0x3a, 0x03, 0x10, 0x50} },\n\t{ {0x51, 0x30, 0x03, 0x10, 0x50} },\n\t{ {0x51, 0x20, 0x03, 0x10, 0x50} },\n\t{ {0x51, 0x10, 0x03, 0x10, 0x50} },  \n\t{ {0x51, 0x08, 0x03, 0x10, 0x50} }\n};\n\n \nstatic const u8 wl_rssi_step_8723d[] = {60, 50, 44, 30};\nstatic const u8 bt_rssi_step_8723d[] = {30, 30, 30, 30};\nstatic const struct coex_5g_afh_map afh_5g_8723d[] = { {0, 0, 0} };\n\nstatic const struct rtw_hw_reg btg_reg_8723d = {\n\t.addr = REG_BTG_SEL, .mask = BIT_MASK_BTG_WL,\n};\n\n \nstatic const struct coex_rf_para rf_para_tx_8723d[] = {\n\t{0, 0, false, 7},   \n\t{0, 10, false, 7},  \n\t{1, 0, true, 4},\n\t{1, 2, true, 4},\n\t{1, 10, true, 4},\n\t{1, 15, true, 4}\n};\n\nstatic const struct coex_rf_para rf_para_rx_8723d[] = {\n\t{0, 0, false, 7},   \n\t{0, 10, false, 7},  \n\t{1, 0, true, 5},\n\t{1, 2, true, 5},\n\t{1, 10, true, 5},\n\t{1, 15, true, 5}\n};\n\nstatic const struct rtw_pwr_seq_cmd trans_carddis_to_cardemu_8723d[] = {\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(3) | BIT(7), 0},\n\t{0x0086,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_SDIO,\n\t RTW_PWR_CMD_WRITE, BIT(0), 0},\n\t{0x0086,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_SDIO,\n\t RTW_PWR_CMD_POLLING, BIT(1), BIT(1)},\n\t{0x004A,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_USB_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), 0},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(3) | BIT(4), 0},\n\t{0x0023,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(4), 0},\n\t{0x0301,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_PCI_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0},\n\t{0xFFFF,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t 0,\n\t RTW_PWR_CMD_END, 0, 0},\n};\n\nstatic const struct rtw_pwr_seq_cmd trans_cardemu_to_act_8723d[] = {\n\t{0x0020,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_USB_MSK | RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), BIT(0)},\n\t{0x0001,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_USB_MSK | RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_DELAY, 1, RTW_PWR_DELAY_MS},\n\t{0x0000,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_USB_MSK | RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(5), 0},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, (BIT(4) | BIT(3) | BIT(2)), 0},\n\t{0x0075,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_PCI_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), BIT(0)},\n\t{0x0006,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_POLLING, BIT(1), BIT(1)},\n\t{0x0075,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_PCI_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), 0},\n\t{0x0006,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), BIT(0)},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_POLLING, (BIT(1) | BIT(0)), 0},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(7), 0},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, (BIT(4) | BIT(3)), 0},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), BIT(0)},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_POLLING, BIT(0), 0},\n\t{0x0010,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(6), BIT(6)},\n\t{0x0049,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(1), BIT(1)},\n\t{0x0063,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(1), BIT(1)},\n\t{0x0062,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(1), 0},\n\t{0x0058,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), BIT(0)},\n\t{0x005A,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(1), BIT(1)},\n\t{0x0068,\n\t RTW_PWR_CUT_TEST_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(3), BIT(3)},\n\t{0x0069,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(6), BIT(6)},\n\t{0x001f,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0x00},\n\t{0x0077,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0x00},\n\t{0x001f,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0x07},\n\t{0x0077,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0x07},\n\t{0xFFFF,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t 0,\n\t RTW_PWR_CMD_END, 0, 0},\n};\n\nstatic const struct rtw_pwr_seq_cmd *card_enable_flow_8723d[] = {\n\ttrans_carddis_to_cardemu_8723d,\n\ttrans_cardemu_to_act_8723d,\n\tNULL\n};\n\nstatic const struct rtw_pwr_seq_cmd trans_act_to_lps_8723d[] = {\n\t{0x0301,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_PCI_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0xFF},\n\t{0x0522,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0xFF},\n\t{0x05F8,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_POLLING, 0xFF, 0},\n\t{0x05F9,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_POLLING, 0xFF, 0},\n\t{0x05FA,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_POLLING, 0xFF, 0},\n\t{0x05FB,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_POLLING, 0xFF, 0},\n\t{0x0002,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), 0},\n\t{0x0002,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_DELAY, 0, RTW_PWR_DELAY_US},\n\t{0x0002,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(1), 0},\n\t{0x0100,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0x03},\n\t{0x0101,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(1), 0},\n\t{0x0093,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0x00},\n\t{0x0553,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(5), BIT(5)},\n\t{0xFFFF,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t 0,\n\t RTW_PWR_CMD_END, 0, 0},\n};\n\nstatic const struct rtw_pwr_seq_cmd trans_act_to_pre_carddis_8723d[] = {\n\t{0x0003,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(2), 0},\n\t{0x0080,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0},\n\t{0xFFFF,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t 0,\n\t RTW_PWR_CMD_END, 0, 0},\n};\n\nstatic const struct rtw_pwr_seq_cmd trans_act_to_cardemu_8723d[] = {\n\t{0x0002,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), 0},\n\t{0x0049,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(1), 0},\n\t{0x0006,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), BIT(0)},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(1), BIT(1)},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_POLLING, BIT(1), 0},\n\t{0x0010,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(6), 0},\n\t{0x0000,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_USB_MSK | RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(5), BIT(5)},\n\t{0x0020,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_USB_MSK | RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), 0},\n\t{0xFFFF,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t 0,\n\t RTW_PWR_CMD_END, 0, 0},\n};\n\nstatic const struct rtw_pwr_seq_cmd trans_cardemu_to_carddis_8723d[] = {\n\t{0x0007,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0x20},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_USB_MSK | RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(3) | BIT(4), BIT(3)},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_PCI_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(2), BIT(2)},\n\t{0x0005,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_PCI_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(3) | BIT(4), BIT(3) | BIT(4)},\n\t{0x004A,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_USB_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), 1},\n\t{0x0023,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(4), BIT(4)},\n\t{0x0086,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_SDIO,\n\t RTW_PWR_CMD_WRITE, BIT(0), BIT(0)},\n\t{0x0086,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_SDIO_MSK,\n\t RTW_PWR_ADDR_SDIO,\n\t RTW_PWR_CMD_POLLING, BIT(1), 0},\n\t{0xFFFF,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t 0,\n\t RTW_PWR_CMD_END, 0, 0},\n};\n\nstatic const struct rtw_pwr_seq_cmd trans_act_to_post_carddis_8723d[] = {\n\t{0x001D,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), 0},\n\t{0x001D,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, BIT(0), BIT(0)},\n\t{0x001C,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t RTW_PWR_ADDR_MAC,\n\t RTW_PWR_CMD_WRITE, 0xFF, 0x0E},\n\t{0xFFFF,\n\t RTW_PWR_CUT_ALL_MSK,\n\t RTW_PWR_INTF_ALL_MSK,\n\t 0,\n\t RTW_PWR_CMD_END, 0, 0},\n};\n\nstatic const struct rtw_pwr_seq_cmd *card_disable_flow_8723d[] = {\n\ttrans_act_to_lps_8723d,\n\ttrans_act_to_pre_carddis_8723d,\n\ttrans_act_to_cardemu_8723d,\n\ttrans_cardemu_to_carddis_8723d,\n\ttrans_act_to_post_carddis_8723d,\n\tNULL\n};\n\nstatic const struct rtw_page_table page_table_8723d[] = {\n\t{12, 2, 2, 0, 1},\n\t{12, 2, 2, 0, 1},\n\t{12, 2, 2, 0, 1},\n\t{12, 2, 2, 0, 1},\n\t{12, 2, 2, 0, 1},\n};\n\nstatic const struct rtw_rqpn rqpn_table_8723d[] = {\n\t{RTW_DMA_MAPPING_NORMAL, RTW_DMA_MAPPING_NORMAL,\n\t RTW_DMA_MAPPING_LOW, RTW_DMA_MAPPING_LOW,\n\t RTW_DMA_MAPPING_EXTRA, RTW_DMA_MAPPING_HIGH},\n\t{RTW_DMA_MAPPING_NORMAL, RTW_DMA_MAPPING_NORMAL,\n\t RTW_DMA_MAPPING_LOW, RTW_DMA_MAPPING_LOW,\n\t RTW_DMA_MAPPING_EXTRA, RTW_DMA_MAPPING_HIGH},\n\t{RTW_DMA_MAPPING_NORMAL, RTW_DMA_MAPPING_NORMAL,\n\t RTW_DMA_MAPPING_NORMAL, RTW_DMA_MAPPING_HIGH,\n\t RTW_DMA_MAPPING_HIGH, RTW_DMA_MAPPING_HIGH},\n\t{RTW_DMA_MAPPING_NORMAL, RTW_DMA_MAPPING_NORMAL,\n\t RTW_DMA_MAPPING_LOW, RTW_DMA_MAPPING_LOW,\n\t RTW_DMA_MAPPING_HIGH, RTW_DMA_MAPPING_HIGH},\n\t{RTW_DMA_MAPPING_NORMAL, RTW_DMA_MAPPING_NORMAL,\n\t RTW_DMA_MAPPING_LOW, RTW_DMA_MAPPING_LOW,\n\t RTW_DMA_MAPPING_EXTRA, RTW_DMA_MAPPING_HIGH},\n};\n\nstatic const struct rtw_prioq_addrs prioq_addrs_8723d = {\n\t.prio[RTW_DMA_MAPPING_EXTRA] = {\n\t\t.rsvd = REG_RQPN_NPQ + 2, .avail = REG_RQPN_NPQ + 3,\n\t},\n\t.prio[RTW_DMA_MAPPING_LOW] = {\n\t\t.rsvd = REG_RQPN + 1, .avail = REG_FIFOPAGE_CTRL_2 + 1,\n\t},\n\t.prio[RTW_DMA_MAPPING_NORMAL] = {\n\t\t.rsvd = REG_RQPN_NPQ, .avail = REG_RQPN_NPQ + 1,\n\t},\n\t.prio[RTW_DMA_MAPPING_HIGH] = {\n\t\t.rsvd = REG_RQPN, .avail = REG_FIFOPAGE_CTRL_2,\n\t},\n\t.wsize = false,\n};\n\nstatic const struct rtw_intf_phy_para pcie_gen1_param_8723d[] = {\n\t{0x0008, 0x4a22,\n\t RTW_IP_SEL_PHY,\n\t RTW_INTF_PHY_CUT_ALL,\n\t RTW_INTF_PHY_PLATFORM_ALL},\n\t{0x0009, 0x1000,\n\t RTW_IP_SEL_PHY,\n\t ~(RTW_INTF_PHY_CUT_A | RTW_INTF_PHY_CUT_B),\n\t RTW_INTF_PHY_PLATFORM_ALL},\n\t{0xFFFF, 0x0000,\n\t RTW_IP_SEL_PHY,\n\t RTW_INTF_PHY_CUT_ALL,\n\t RTW_INTF_PHY_PLATFORM_ALL},\n};\n\nstatic const struct rtw_intf_phy_para_table phy_para_table_8723d = {\n\t.gen1_para\t= pcie_gen1_param_8723d,\n\t.n_gen1_para\t= ARRAY_SIZE(pcie_gen1_param_8723d),\n};\n\nstatic const struct rtw_hw_reg rtw8723d_dig[] = {\n\t[0] = { .addr = 0xc50, .mask = 0x7f },\n\t[1] = { .addr = 0xc50, .mask = 0x7f },\n};\n\nstatic const struct rtw_hw_reg rtw8723d_dig_cck[] = {\n\t[0] = { .addr = 0xa0c, .mask = 0x3f00 },\n};\n\nstatic const struct rtw_rf_sipi_addr rtw8723d_rf_sipi_addr[] = {\n\t[RF_PATH_A] = { .hssi_1 = 0x820, .lssi_read    = 0x8a0,\n\t\t\t.hssi_2 = 0x824, .lssi_read_pi = 0x8b8},\n\t[RF_PATH_B] = { .hssi_1 = 0x828, .lssi_read    = 0x8a4,\n\t\t\t.hssi_2 = 0x82c, .lssi_read_pi = 0x8bc},\n};\n\nstatic const struct rtw_ltecoex_addr rtw8723d_ltecoex_addr = {\n\t.ctrl = REG_LTECOEX_CTRL,\n\t.wdata = REG_LTECOEX_WRITE_DATA,\n\t.rdata = REG_LTECOEX_READ_DATA,\n};\n\nstatic const struct rtw_rfe_def rtw8723d_rfe_defs[] = {\n\t[0] = { .phy_pg_tbl\t= &rtw8723d_bb_pg_tbl,\n\t\t.txpwr_lmt_tbl\t= &rtw8723d_txpwr_lmt_tbl,},\n};\n\nstatic const u8 rtw8723d_pwrtrk_2gb_n[] = {\n\t0, 0, 1, 1, 1, 2, 2, 3, 4, 4, 4, 4, 5, 5, 5,\n\t6, 6, 7, 7, 8, 8, 8, 9, 9, 9, 10, 10, 10, 10, 10\n};\n\nstatic const u8 rtw8723d_pwrtrk_2gb_p[] = {\n\t0, 0, 1, 1, 2, 2, 2, 3, 3, 4, 4, 5, 5, 6, 7,\n\t7, 8, 8, 8, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10\n};\n\nstatic const u8 rtw8723d_pwrtrk_2ga_n[] = {\n\t0, 0, 1, 1, 1, 2, 2, 3, 4, 4, 4, 4, 5, 5, 5,\n\t6, 6, 7, 7, 8, 8, 8, 9, 9, 9, 10, 10, 10, 10, 10\n};\n\nstatic const u8 rtw8723d_pwrtrk_2ga_p[] = {\n\t0, 0, 1, 1, 2, 2, 2, 3, 3, 4, 4, 5, 5, 6, 7,\n\t7, 8, 8, 8, 9, 9, 10, 10, 10, 10, 10, 10, 10, 10, 10\n};\n\nstatic const u8 rtw8723d_pwrtrk_2g_cck_b_n[] = {\n\t0, 1, 1, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6,\n\t6, 7, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 11, 11, 11\n};\n\nstatic const u8 rtw8723d_pwrtrk_2g_cck_b_p[] = {\n\t0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7,\n\t7, 8, 9, 9, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11\n};\n\nstatic const u8 rtw8723d_pwrtrk_2g_cck_a_n[] = {\n\t0, 1, 1, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6,\n\t6, 7, 7, 7, 8, 8, 9, 9, 10, 10, 11, 11, 11, 11, 11\n};\n\nstatic const u8 rtw8723d_pwrtrk_2g_cck_a_p[] = {\n\t0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7,\n\t7, 8, 9, 9, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11\n};\n\nstatic const s8 rtw8723d_pwrtrk_xtal_n[] = {\n\t0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n\t0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0\n};\n\nstatic const s8 rtw8723d_pwrtrk_xtal_p[] = {\n\t0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\n\t0, -10, -12, -14, -16, -16, -16, -16, -16, -16, -16, -16, -16, -16, -16\n};\n\nstatic const struct rtw_pwr_track_tbl rtw8723d_rtw_pwr_track_tbl = {\n\t.pwrtrk_2gb_n = rtw8723d_pwrtrk_2gb_n,\n\t.pwrtrk_2gb_p = rtw8723d_pwrtrk_2gb_p,\n\t.pwrtrk_2ga_n = rtw8723d_pwrtrk_2ga_n,\n\t.pwrtrk_2ga_p = rtw8723d_pwrtrk_2ga_p,\n\t.pwrtrk_2g_cckb_n = rtw8723d_pwrtrk_2g_cck_b_n,\n\t.pwrtrk_2g_cckb_p = rtw8723d_pwrtrk_2g_cck_b_p,\n\t.pwrtrk_2g_ccka_n = rtw8723d_pwrtrk_2g_cck_a_n,\n\t.pwrtrk_2g_ccka_p = rtw8723d_pwrtrk_2g_cck_a_p,\n\t.pwrtrk_xtal_p = rtw8723d_pwrtrk_xtal_p,\n\t.pwrtrk_xtal_n = rtw8723d_pwrtrk_xtal_n,\n};\n\nstatic const struct rtw_reg_domain coex_info_hw_regs_8723d[] = {\n\t{0x948, MASKDWORD, RTW_REG_DOMAIN_MAC32},\n\t{0x67, BIT(7), RTW_REG_DOMAIN_MAC8},\n\t{0, 0, RTW_REG_DOMAIN_NL},\n\t{0x964, BIT(1), RTW_REG_DOMAIN_MAC8},\n\t{0x864, BIT(0), RTW_REG_DOMAIN_MAC8},\n\t{0xab7, BIT(5), RTW_REG_DOMAIN_MAC8},\n\t{0xa01, BIT(7), RTW_REG_DOMAIN_MAC8},\n\t{0, 0, RTW_REG_DOMAIN_NL},\n\t{0x430, MASKDWORD, RTW_REG_DOMAIN_MAC32},\n\t{0x434, MASKDWORD, RTW_REG_DOMAIN_MAC32},\n\t{0x42a, MASKLWORD, RTW_REG_DOMAIN_MAC16},\n\t{0x426, MASKBYTE0, RTW_REG_DOMAIN_MAC8},\n\t{0x45e, BIT(3), RTW_REG_DOMAIN_MAC8},\n\t{0, 0, RTW_REG_DOMAIN_NL},\n\t{0x4c6, BIT(4), RTW_REG_DOMAIN_MAC8},\n\t{0x40, BIT(5), RTW_REG_DOMAIN_MAC8},\n\t{0x550, MASKDWORD, RTW_REG_DOMAIN_MAC32},\n\t{0x522, MASKBYTE0, RTW_REG_DOMAIN_MAC8},\n\t{0x953, BIT(1), RTW_REG_DOMAIN_MAC8},\n};\n\nconst struct rtw_chip_info rtw8723d_hw_spec = {\n\t.ops = &rtw8723d_ops,\n\t.id = RTW_CHIP_TYPE_8723D,\n\t.fw_name = \"rtw88/rtw8723d_fw.bin\",\n\t.wlan_cpu = RTW_WCPU_11N,\n\t.tx_pkt_desc_sz = 40,\n\t.tx_buf_desc_sz = 16,\n\t.rx_pkt_desc_sz = 24,\n\t.rx_buf_desc_sz = 8,\n\t.phy_efuse_size = 512,\n\t.log_efuse_size = 512,\n\t.ptct_efuse_size = 96 + 1,\n\t.txff_size = 32768,\n\t.rxff_size = 16384,\n\t.rsvd_drv_pg_num = 8,\n\t.txgi_factor = 1,\n\t.is_pwr_by_rate_dec = true,\n\t.max_power_index = 0x3f,\n\t.csi_buf_pg_num = 0,\n\t.band = RTW_BAND_2G,\n\t.page_size = TX_PAGE_SIZE,\n\t.dig_min = 0x20,\n\t.ht_supported = true,\n\t.vht_supported = false,\n\t.lps_deep_mode_supported = 0,\n\t.sys_func_en = 0xFD,\n\t.pwr_on_seq = card_enable_flow_8723d,\n\t.pwr_off_seq = card_disable_flow_8723d,\n\t.page_table = page_table_8723d,\n\t.rqpn_table = rqpn_table_8723d,\n\t.prioq_addrs = &prioq_addrs_8723d,\n\t.intf_table = &phy_para_table_8723d,\n\t.dig = rtw8723d_dig,\n\t.dig_cck = rtw8723d_dig_cck,\n\t.rf_sipi_addr = {0x840, 0x844},\n\t.rf_sipi_read_addr = rtw8723d_rf_sipi_addr,\n\t.fix_rf_phy_num = 2,\n\t.ltecoex_addr = &rtw8723d_ltecoex_addr,\n\t.mac_tbl = &rtw8723d_mac_tbl,\n\t.agc_tbl = &rtw8723d_agc_tbl,\n\t.bb_tbl = &rtw8723d_bb_tbl,\n\t.rf_tbl = {&rtw8723d_rf_a_tbl},\n\t.rfe_defs = rtw8723d_rfe_defs,\n\t.rfe_defs_size = ARRAY_SIZE(rtw8723d_rfe_defs),\n\t.rx_ldpc = false,\n\t.pwr_track_tbl = &rtw8723d_rtw_pwr_track_tbl,\n\t.iqk_threshold = 8,\n\t.ampdu_density = IEEE80211_HT_MPDU_DENSITY_16,\n\t.max_scan_ie_len = IEEE80211_MAX_DATA_LEN,\n\n\t.coex_para_ver = 0x2007022f,\n\t.bt_desired_ver = 0x2f,\n\t.scbd_support = true,\n\t.new_scbd10_def = true,\n\t.ble_hid_profile_support = false,\n\t.wl_mimo_ps_support = false,\n\t.pstdma_type = COEX_PSTDMA_FORCE_LPSOFF,\n\t.bt_rssi_type = COEX_BTRSSI_RATIO,\n\t.ant_isolation = 15,\n\t.rssi_tolerance = 2,\n\t.wl_rssi_step = wl_rssi_step_8723d,\n\t.bt_rssi_step = bt_rssi_step_8723d,\n\t.table_sant_num = ARRAY_SIZE(table_sant_8723d),\n\t.table_sant = table_sant_8723d,\n\t.table_nsant_num = ARRAY_SIZE(table_nsant_8723d),\n\t.table_nsant = table_nsant_8723d,\n\t.tdma_sant_num = ARRAY_SIZE(tdma_sant_8723d),\n\t.tdma_sant = tdma_sant_8723d,\n\t.tdma_nsant_num = ARRAY_SIZE(tdma_nsant_8723d),\n\t.tdma_nsant = tdma_nsant_8723d,\n\t.wl_rf_para_num = ARRAY_SIZE(rf_para_tx_8723d),\n\t.wl_rf_para_tx = rf_para_tx_8723d,\n\t.wl_rf_para_rx = rf_para_rx_8723d,\n\t.bt_afh_span_bw20 = 0x20,\n\t.bt_afh_span_bw40 = 0x30,\n\t.afh_5g_num = ARRAY_SIZE(afh_5g_8723d),\n\t.afh_5g = afh_5g_8723d,\n\t.btg_reg = &btg_reg_8723d,\n\n\t.coex_info_hw_regs_num = ARRAY_SIZE(coex_info_hw_regs_8723d),\n\t.coex_info_hw_regs = coex_info_hw_regs_8723d,\n};\nEXPORT_SYMBOL(rtw8723d_hw_spec);\n\nMODULE_FIRMWARE(\"rtw88/rtw8723d_fw.bin\");\n\nMODULE_AUTHOR(\"Realtek Corporation\");\nMODULE_DESCRIPTION(\"Realtek 802.11n wireless 8723d driver\");\nMODULE_LICENSE(\"Dual BSD/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}