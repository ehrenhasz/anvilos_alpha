{
  "module_name": "trx.c",
  "hash_id": "170d8143a6b941fbb7a16e59572a7aaff40c00871c40ce953e66361dea40cd72",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtlwifi/rtl8192de/trx.c",
  "human_readable_source": "\n \n\n#include \"../wifi.h\"\n#include \"../pci.h\"\n#include \"../base.h\"\n#include \"../stats.h\"\n#include \"reg.h\"\n#include \"def.h\"\n#include \"phy.h\"\n#include \"trx.h\"\n#include \"led.h\"\n\nstatic u8 _rtl92de_map_hwqueue_to_fwqueue(struct sk_buff *skb, u8 hw_queue)\n{\n\t__le16 fc = rtl_get_fc(skb);\n\n\tif (unlikely(ieee80211_is_beacon(fc)))\n\t\treturn QSLT_BEACON;\n\tif (ieee80211_is_mgmt(fc))\n\t\treturn QSLT_MGNT;\n\n\treturn skb->priority;\n}\n\nstatic long _rtl92de_translate_todbm(struct ieee80211_hw *hw,\n\t\t\t\t     u8 signal_strength_index)\n{\n\tlong signal_power;\n\n\tsignal_power = (long)((signal_strength_index + 1) >> 1);\n\tsignal_power -= 95;\n\treturn signal_power;\n}\n\nstatic void _rtl92de_query_rxphystatus(struct ieee80211_hw *hw,\n\t\t\t\t       struct rtl_stats *pstats,\n\t\t\t\t       struct rx_desc_92d *pdesc,\n\t\t\t\t       struct rx_fwinfo_92d *p_drvinfo,\n\t\t\t\t       bool packet_match_bssid,\n\t\t\t\t       bool packet_toself,\n\t\t\t\t       bool packet_beacon)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_ps_ctl *ppsc = rtl_psc(rtlpriv);\n\tstruct phy_sts_cck_8192d *cck_buf;\n\ts8 rx_pwr_all, rx_pwr[4];\n\tu8 rf_rx_num = 0, evm, pwdb_all;\n\tu8 i, max_spatial_stream;\n\tu32 rssi, total_rssi = 0;\n\tbool is_cck_rate;\n\n\tis_cck_rate = RX_HAL_IS_CCK_RATE(pdesc->rxmcs);\n\tpstats->packet_matchbssid = packet_match_bssid;\n\tpstats->packet_toself = packet_toself;\n\tpstats->packet_beacon = packet_beacon;\n\tpstats->is_cck = is_cck_rate;\n\tpstats->rx_mimo_sig_qual[0] = -1;\n\tpstats->rx_mimo_sig_qual[1] = -1;\n\n\tif (is_cck_rate) {\n\t\tu8 report, cck_highpwr;\n\t\tcck_buf = (struct phy_sts_cck_8192d *)p_drvinfo;\n\t\tif (ppsc->rfpwr_state == ERFON)\n\t\t\tcck_highpwr = (u8) rtl_get_bbreg(hw,\n\t\t\t\t\t\t RFPGA0_XA_HSSIPARAMETER2,\n\t\t\t\t\t\t BIT(9));\n\t\telse\n\t\t\tcck_highpwr = false;\n\t\tif (!cck_highpwr) {\n\t\t\tu8 cck_agc_rpt = cck_buf->cck_agc_rpt;\n\t\t\treport = cck_buf->cck_agc_rpt & 0xc0;\n\t\t\treport = report >> 6;\n\t\t\tswitch (report) {\n\t\t\tcase 0x3:\n\t\t\t\trx_pwr_all = -46 - (cck_agc_rpt & 0x3e);\n\t\t\t\tbreak;\n\t\t\tcase 0x2:\n\t\t\t\trx_pwr_all = -26 - (cck_agc_rpt & 0x3e);\n\t\t\t\tbreak;\n\t\t\tcase 0x1:\n\t\t\t\trx_pwr_all = -12 - (cck_agc_rpt & 0x3e);\n\t\t\t\tbreak;\n\t\t\tcase 0x0:\n\t\t\t\trx_pwr_all = 16 - (cck_agc_rpt & 0x3e);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t} else {\n\t\t\tu8 cck_agc_rpt = cck_buf->cck_agc_rpt;\n\t\t\treport = p_drvinfo->cfosho[0] & 0x60;\n\t\t\treport = report >> 5;\n\t\t\tswitch (report) {\n\t\t\tcase 0x3:\n\t\t\t\trx_pwr_all = -46 - ((cck_agc_rpt & 0x1f) << 1);\n\t\t\t\tbreak;\n\t\t\tcase 0x2:\n\t\t\t\trx_pwr_all = -26 - ((cck_agc_rpt & 0x1f) << 1);\n\t\t\t\tbreak;\n\t\t\tcase 0x1:\n\t\t\t\trx_pwr_all = -12 - ((cck_agc_rpt & 0x1f) << 1);\n\t\t\t\tbreak;\n\t\t\tcase 0x0:\n\t\t\t\trx_pwr_all = 16 - ((cck_agc_rpt & 0x1f) << 1);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tpwdb_all = rtl_query_rxpwrpercentage(rx_pwr_all);\n\t\t \n\t\t \n\t\tpwdb_all += 6;\n\t\tif (pwdb_all > 100)\n\t\t\tpwdb_all = 100;\n\t\t \n\t\tif (pwdb_all > 34 && pwdb_all <= 42)\n\t\t\tpwdb_all -= 2;\n\t\telse if (pwdb_all > 26 && pwdb_all <= 34)\n\t\t\tpwdb_all -= 6;\n\t\telse if (pwdb_all > 14 && pwdb_all <= 26)\n\t\t\tpwdb_all -= 8;\n\t\telse if (pwdb_all > 4 && pwdb_all <= 14)\n\t\t\tpwdb_all -= 4;\n\t\tpstats->rx_pwdb_all = pwdb_all;\n\t\tpstats->recvsignalpower = rx_pwr_all;\n\t\tif (packet_match_bssid) {\n\t\t\tu8 sq;\n\t\t\tif (pstats->rx_pwdb_all > 40) {\n\t\t\t\tsq = 100;\n\t\t\t} else {\n\t\t\t\tsq = cck_buf->sq_rpt;\n\t\t\t\tif (sq > 64)\n\t\t\t\t\tsq = 0;\n\t\t\t\telse if (sq < 20)\n\t\t\t\t\tsq = 100;\n\t\t\t\telse\n\t\t\t\t\tsq = ((64 - sq) * 100) / 44;\n\t\t\t}\n\t\t\tpstats->signalquality = sq;\n\t\t\tpstats->rx_mimo_sig_qual[0] = sq;\n\t\t\tpstats->rx_mimo_sig_qual[1] = -1;\n\t\t}\n\t} else {\n\t\trtlpriv->dm.rfpath_rxenable[0] = true;\n\t\trtlpriv->dm.rfpath_rxenable[1] = true;\n\t\tfor (i = RF90_PATH_A; i < RF6052_MAX_PATH; i++) {\n\t\t\tif (rtlpriv->dm.rfpath_rxenable[i])\n\t\t\t\trf_rx_num++;\n\t\t\trx_pwr[i] = ((p_drvinfo->gain_trsw[i] & 0x3f) * 2)\n\t\t\t\t    - 110;\n\t\t\trssi = rtl_query_rxpwrpercentage(rx_pwr[i]);\n\t\t\ttotal_rssi += rssi;\n\t\t\trtlpriv->stats.rx_snr_db[i] =\n\t\t\t\t\t (long)(p_drvinfo->rxsnr[i] / 2);\n\t\t\tif (packet_match_bssid)\n\t\t\t\tpstats->rx_mimo_signalstrength[i] = (u8) rssi;\n\t\t}\n\t\trx_pwr_all = ((p_drvinfo->pwdb_all >> 1) & 0x7f) - 106;\n\t\tpwdb_all = rtl_query_rxpwrpercentage(rx_pwr_all);\n\t\tpstats->rx_pwdb_all = pwdb_all;\n\t\tpstats->rxpower = rx_pwr_all;\n\t\tpstats->recvsignalpower = rx_pwr_all;\n\t\tif (pdesc->rxht && pdesc->rxmcs >= DESC_RATEMCS8 &&\n\t\t    pdesc->rxmcs <= DESC_RATEMCS15)\n\t\t\tmax_spatial_stream = 2;\n\t\telse\n\t\t\tmax_spatial_stream = 1;\n\t\tfor (i = 0; i < max_spatial_stream; i++) {\n\t\t\tevm = rtl_evm_db_to_percentage(p_drvinfo->rxevm[i]);\n\t\t\tif (packet_match_bssid) {\n\t\t\t\tif (i == 0)\n\t\t\t\t\tpstats->signalquality =\n\t\t\t\t\t\t (u8)(evm & 0xff);\n\t\t\t\tpstats->rx_mimo_sig_qual[i] =\n\t\t\t\t\t\t (u8)(evm & 0xff);\n\t\t\t}\n\t\t}\n\t}\n\tif (is_cck_rate)\n\t\tpstats->signalstrength = (u8)(rtl_signal_scale_mapping(hw,\n\t\t\t\tpwdb_all));\n\telse if (rf_rx_num != 0)\n\t\tpstats->signalstrength = (u8)(rtl_signal_scale_mapping(hw,\n\t\t\t\ttotal_rssi /= rf_rx_num));\n}\n\nstatic void rtl92d_loop_over_paths(struct ieee80211_hw *hw,\n\t\t\t\t   struct rtl_stats *pstats)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &(rtlpriv->phy);\n\tu8 rfpath;\n\n\tfor (rfpath = RF90_PATH_A; rfpath < rtlphy->num_total_rfpath;\n\t     rfpath++) {\n\t\tif (rtlpriv->stats.rx_rssi_percentage[rfpath] == 0) {\n\t\t\trtlpriv->stats.rx_rssi_percentage[rfpath] =\n\t\t\t    pstats->rx_mimo_signalstrength[rfpath];\n\n\t\t}\n\t\tif (pstats->rx_mimo_signalstrength[rfpath] >\n\t\t    rtlpriv->stats.rx_rssi_percentage[rfpath]) {\n\t\t\trtlpriv->stats.rx_rssi_percentage[rfpath] =\n\t\t\t    ((rtlpriv->stats.rx_rssi_percentage[rfpath] *\n\t\t\t      (RX_SMOOTH_FACTOR - 1)) +\n\t\t\t     (pstats->rx_mimo_signalstrength[rfpath])) /\n\t\t\t    (RX_SMOOTH_FACTOR);\n\t\t\trtlpriv->stats.rx_rssi_percentage[rfpath] =\n\t\t\t    rtlpriv->stats.rx_rssi_percentage[rfpath] + 1;\n\t\t} else {\n\t\t\trtlpriv->stats.rx_rssi_percentage[rfpath] =\n\t\t\t    ((rtlpriv->stats.rx_rssi_percentage[rfpath] *\n\t\t\t      (RX_SMOOTH_FACTOR - 1)) +\n\t\t\t     (pstats->rx_mimo_signalstrength[rfpath])) /\n\t\t\t    (RX_SMOOTH_FACTOR);\n\t\t}\n\t}\n}\n\nstatic void _rtl92de_process_ui_rssi(struct ieee80211_hw *hw,\n\t\t\t\t     struct rtl_stats *pstats)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 last_rssi, tmpval;\n\n\tif (pstats->packet_toself || pstats->packet_beacon) {\n\t\trtlpriv->stats.rssi_calculate_cnt++;\n\t\tif (rtlpriv->stats.ui_rssi.total_num++ >=\n\t\t    PHY_RSSI_SLID_WIN_MAX) {\n\t\t\trtlpriv->stats.ui_rssi.total_num =\n\t\t\t\t\t\t PHY_RSSI_SLID_WIN_MAX;\n\t\t\tlast_rssi = rtlpriv->stats.ui_rssi.elements[\n\t\t\t\trtlpriv->stats.ui_rssi.index];\n\t\t\trtlpriv->stats.ui_rssi.total_val -= last_rssi;\n\t\t}\n\t\trtlpriv->stats.ui_rssi.total_val += pstats->signalstrength;\n\t\trtlpriv->stats.ui_rssi.elements\n\t\t\t[rtlpriv->stats.ui_rssi.index++] =\n\t\t\tpstats->signalstrength;\n\t\tif (rtlpriv->stats.ui_rssi.index >= PHY_RSSI_SLID_WIN_MAX)\n\t\t\trtlpriv->stats.ui_rssi.index = 0;\n\t\ttmpval = rtlpriv->stats.ui_rssi.total_val /\n\t\t\trtlpriv->stats.ui_rssi.total_num;\n\t\trtlpriv->stats.signal_strength = _rtl92de_translate_todbm(hw,\n\t\t\t(u8) tmpval);\n\t\tpstats->rssi = rtlpriv->stats.signal_strength;\n\t}\n\tif (!pstats->is_cck && pstats->packet_toself)\n\t\trtl92d_loop_over_paths(hw, pstats);\n}\n\nstatic void _rtl92de_update_rxsignalstatistics(struct ieee80211_hw *hw,\n\t\t\t\t\t       struct rtl_stats *pstats)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tint weighting = 0;\n\n\tif (rtlpriv->stats.recv_signal_power == 0)\n\t\trtlpriv->stats.recv_signal_power = pstats->recvsignalpower;\n\tif (pstats->recvsignalpower > rtlpriv->stats.recv_signal_power)\n\t\tweighting = 5;\n\telse if (pstats->recvsignalpower < rtlpriv->stats.recv_signal_power)\n\t\tweighting = (-5);\n\trtlpriv->stats.recv_signal_power = (rtlpriv->stats.recv_signal_power *\n\t\t5 + pstats->recvsignalpower + weighting) / 6;\n}\n\nstatic void _rtl92de_process_pwdb(struct ieee80211_hw *hw,\n\t\t\t\t  struct rtl_stats *pstats)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tlong undec_sm_pwdb;\n\n\tif (mac->opmode == NL80211_IFTYPE_ADHOC\t||\n\t\tmac->opmode == NL80211_IFTYPE_AP)\n\t\treturn;\n\telse\n\t\tundec_sm_pwdb = rtlpriv->dm.undec_sm_pwdb;\n\n\tif (pstats->packet_toself || pstats->packet_beacon) {\n\t\tif (undec_sm_pwdb < 0)\n\t\t\tundec_sm_pwdb = pstats->rx_pwdb_all;\n\t\tif (pstats->rx_pwdb_all > (u32) undec_sm_pwdb) {\n\t\t\tundec_sm_pwdb = (((undec_sm_pwdb) *\n\t\t\t      (RX_SMOOTH_FACTOR - 1)) +\n\t\t\t      (pstats->rx_pwdb_all)) / (RX_SMOOTH_FACTOR);\n\t\t\tundec_sm_pwdb = undec_sm_pwdb + 1;\n\t\t} else {\n\t\t\tundec_sm_pwdb = (((undec_sm_pwdb) *\n\t\t\t      (RX_SMOOTH_FACTOR - 1)) +\n\t\t\t      (pstats->rx_pwdb_all)) / (RX_SMOOTH_FACTOR);\n\t\t}\n\t\trtlpriv->dm.undec_sm_pwdb = undec_sm_pwdb;\n\t\t_rtl92de_update_rxsignalstatistics(hw, pstats);\n\t}\n}\n\nstatic void rtl92d_loop_over_streams(struct ieee80211_hw *hw,\n\t\t\t\t     struct rtl_stats *pstats)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tint stream;\n\n\tfor (stream = 0; stream < 2; stream++) {\n\t\tif (pstats->rx_mimo_sig_qual[stream] != -1) {\n\t\t\tif (rtlpriv->stats.rx_evm_percentage[stream] == 0) {\n\t\t\t\trtlpriv->stats.rx_evm_percentage[stream] =\n\t\t\t\t    pstats->rx_mimo_sig_qual[stream];\n\t\t\t}\n\t\t\trtlpriv->stats.rx_evm_percentage[stream] =\n\t\t\t    ((rtlpriv->stats.rx_evm_percentage[stream]\n\t\t\t      * (RX_SMOOTH_FACTOR - 1)) +\n\t\t\t     (pstats->rx_mimo_sig_qual[stream] * 1)) /\n\t\t\t    (RX_SMOOTH_FACTOR);\n\t\t}\n\t}\n}\n\nstatic void _rtl92de_process_ui_link_quality(struct ieee80211_hw *hw,\n\t\t\t\t\t     struct rtl_stats *pstats)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 last_evm, tmpval;\n\n\tif (pstats->signalquality == 0)\n\t\treturn;\n\tif (pstats->packet_toself || pstats->packet_beacon) {\n\t\tif (rtlpriv->stats.ui_link_quality.total_num++ >=\n\t\t    PHY_LINKQUALITY_SLID_WIN_MAX) {\n\t\t\trtlpriv->stats.ui_link_quality.total_num =\n\t\t\t    PHY_LINKQUALITY_SLID_WIN_MAX;\n\t\t\tlast_evm = rtlpriv->stats.ui_link_quality.elements[\n\t\t\t\trtlpriv->stats.ui_link_quality.index];\n\t\t\trtlpriv->stats.ui_link_quality.total_val -= last_evm;\n\t\t}\n\t\trtlpriv->stats.ui_link_quality.total_val +=\n\t\t\t\t\t\t pstats->signalquality;\n\t\trtlpriv->stats.ui_link_quality.elements[\n\t\t\trtlpriv->stats.ui_link_quality.index++] =\n\t\t\t\t\t\t pstats->signalquality;\n\t\tif (rtlpriv->stats.ui_link_quality.index >=\n\t\t    PHY_LINKQUALITY_SLID_WIN_MAX)\n\t\t\trtlpriv->stats.ui_link_quality.index = 0;\n\t\ttmpval = rtlpriv->stats.ui_link_quality.total_val /\n\t\t    rtlpriv->stats.ui_link_quality.total_num;\n\t\trtlpriv->stats.signal_quality = tmpval;\n\t\trtlpriv->stats.last_sigstrength_inpercent = tmpval;\n\t\trtl92d_loop_over_streams(hw, pstats);\n\t}\n}\n\nstatic void _rtl92de_process_phyinfo(struct ieee80211_hw *hw,\n\t\t\t\t     u8 *buffer,\n\t\t\t\t     struct rtl_stats *pcurrent_stats)\n{\n\n\tif (!pcurrent_stats->packet_matchbssid &&\n\t    !pcurrent_stats->packet_beacon)\n\t\treturn;\n\n\t_rtl92de_process_ui_rssi(hw, pcurrent_stats);\n\t_rtl92de_process_pwdb(hw, pcurrent_stats);\n\t_rtl92de_process_ui_link_quality(hw, pcurrent_stats);\n}\n\nstatic void _rtl92de_translate_rx_signal_stuff(struct ieee80211_hw *hw,\n\t\t\t\t\t       struct sk_buff *skb,\n\t\t\t\t\t       struct rtl_stats *pstats,\n\t\t\t\t\t       struct rx_desc_92d *pdesc,\n\t\t\t\t\t       struct rx_fwinfo_92d *p_drvinfo)\n{\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\n\tstruct ieee80211_hdr *hdr;\n\tu8 *tmp_buf;\n\tu8 *praddr;\n\tu16 type, cfc;\n\t__le16 fc;\n\tbool packet_matchbssid, packet_toself, packet_beacon = false;\n\n\ttmp_buf = skb->data + pstats->rx_drvinfo_size + pstats->rx_bufshift;\n\thdr = (struct ieee80211_hdr *)tmp_buf;\n\tfc = hdr->frame_control;\n\tcfc = le16_to_cpu(fc);\n\ttype = WLAN_FC_GET_TYPE(fc);\n\tpraddr = hdr->addr1;\n\tpacket_matchbssid = ((IEEE80211_FTYPE_CTL != type) &&\n\t     ether_addr_equal(mac->bssid,\n\t\t\t      (cfc & IEEE80211_FCTL_TODS) ? hdr->addr1 :\n\t\t\t      (cfc & IEEE80211_FCTL_FROMDS) ? hdr->addr2 :\n\t\t\t      hdr->addr3) &&\n\t     (!pstats->hwerror) && (!pstats->crc) && (!pstats->icv));\n\tpacket_toself = packet_matchbssid &&\n\t\t\tether_addr_equal(praddr, rtlefuse->dev_addr);\n\tif (ieee80211_is_beacon(fc))\n\t\tpacket_beacon = true;\n\t_rtl92de_query_rxphystatus(hw, pstats, pdesc, p_drvinfo,\n\t\t\t\t   packet_matchbssid, packet_toself,\n\t\t\t\t   packet_beacon);\n\t_rtl92de_process_phyinfo(hw, tmp_buf, pstats);\n}\n\nbool rtl92de_rx_query_desc(struct ieee80211_hw *hw,\tstruct rtl_stats *stats,\n\t\tstruct ieee80211_rx_status *rx_status,\n\t\tu8 *pdesc8, struct sk_buff *skb)\n{\n\t__le32 *pdesc = (__le32 *)pdesc8;\n\tstruct rx_fwinfo_92d *p_drvinfo;\n\tu32 phystatus = get_rx_desc_physt(pdesc);\n\n\tstats->length = (u16)get_rx_desc_pkt_len(pdesc);\n\tstats->rx_drvinfo_size = (u8)get_rx_desc_drv_info_size(pdesc) *\n\t\t\t\t RX_DRV_INFO_SIZE_UNIT;\n\tstats->rx_bufshift = (u8)(get_rx_desc_shift(pdesc) & 0x03);\n\tstats->icv = (u16)get_rx_desc_icv(pdesc);\n\tstats->crc = (u16)get_rx_desc_crc32(pdesc);\n\tstats->hwerror = (stats->crc | stats->icv);\n\tstats->decrypted = !get_rx_desc_swdec(pdesc);\n\tstats->rate = (u8)get_rx_desc_rxmcs(pdesc);\n\tstats->shortpreamble = (u16)get_rx_desc_splcp(pdesc);\n\tstats->isampdu = (bool)(get_rx_desc_paggr(pdesc) == 1);\n\tstats->isfirst_ampdu = (bool)((get_rx_desc_paggr(pdesc) == 1) &&\n\t\t\t\t      (get_rx_desc_faggr(pdesc) == 1));\n\tstats->timestamp_low = get_rx_desc_tsfl(pdesc);\n\tstats->rx_is40mhzpacket = (bool)get_rx_desc_bw(pdesc);\n\tstats->is_ht = (bool)get_rx_desc_rxht(pdesc);\n\trx_status->freq = hw->conf.chandef.chan->center_freq;\n\trx_status->band = hw->conf.chandef.chan->band;\n\tif (get_rx_desc_crc32(pdesc))\n\t\trx_status->flag |= RX_FLAG_FAILED_FCS_CRC;\n\tif (!get_rx_desc_swdec(pdesc))\n\t\trx_status->flag |= RX_FLAG_DECRYPTED;\n\tif (get_rx_desc_bw(pdesc))\n\t\trx_status->bw = RATE_INFO_BW_40;\n\tif (get_rx_desc_rxht(pdesc))\n\t\trx_status->encoding = RX_ENC_HT;\n\trx_status->flag |= RX_FLAG_MACTIME_START;\n\tif (stats->decrypted)\n\t\trx_status->flag |= RX_FLAG_DECRYPTED;\n\trx_status->rate_idx = rtlwifi_rate_mapping(hw, stats->is_ht,\n\t\t\t\t\t\t   false, stats->rate);\n\trx_status->mactime = get_rx_desc_tsfl(pdesc);\n\tif (phystatus) {\n\t\tp_drvinfo = (struct rx_fwinfo_92d *)(skb->data +\n\t\t\t\t\t\t     stats->rx_bufshift);\n\t\t_rtl92de_translate_rx_signal_stuff(hw,\n\t\t\t\t\t\t   skb, stats,\n\t\t\t\t\t\t   (struct rx_desc_92d *)pdesc,\n\t\t\t\t\t\t   p_drvinfo);\n\t}\n\t \n\trx_status->signal = stats->recvsignalpower + 10;\n\treturn true;\n}\n\nstatic void _rtl92de_insert_emcontent(struct rtl_tcb_desc *ptcb_desc,\n\t\t\t\t      u8 *virtualaddress8)\n{\n\t__le32 *virtualaddress = (__le32 *)virtualaddress8;\n\n\tmemset(virtualaddress, 0, 8);\n\n\tset_earlymode_pktnum(virtualaddress, ptcb_desc->empkt_num);\n\tset_earlymode_len0(virtualaddress, ptcb_desc->empkt_len[0]);\n\tset_earlymode_len1(virtualaddress, ptcb_desc->empkt_len[1]);\n\tset_earlymode_len2_1(virtualaddress, ptcb_desc->empkt_len[2] & 0xF);\n\tset_earlymode_len2_2(virtualaddress, ptcb_desc->empkt_len[2] >> 4);\n\tset_earlymode_len3(virtualaddress, ptcb_desc->empkt_len[3]);\n\tset_earlymode_len4(virtualaddress, ptcb_desc->empkt_len[4]);\n}\n\nvoid rtl92de_tx_fill_desc(struct ieee80211_hw *hw,\n\t\t\t  struct ieee80211_hdr *hdr, u8 *pdesc8,\n\t\t\t  u8 *pbd_desc_tx, struct ieee80211_tx_info *info,\n\t\t\t  struct ieee80211_sta *sta,\n\t\t\t  struct sk_buff *skb,\n\t\t\t  u8 hw_queue, struct rtl_tcb_desc *ptcb_desc)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tstruct rtl_pci *rtlpci = rtl_pcidev(rtl_pcipriv(hw));\n\tstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\n\tstruct rtl_ps_ctl *ppsc = rtl_psc(rtl_priv(hw));\n\t__le32 *pdesc = (__le32 *)pdesc8;\n\tu16 seq_number;\n\t__le16 fc = hdr->frame_control;\n\tunsigned int buf_len = 0;\n\tunsigned int skb_len = skb->len;\n\tu8 fw_qsel = _rtl92de_map_hwqueue_to_fwqueue(skb, hw_queue);\n\tbool firstseg = ((hdr->seq_ctrl &\n\t\t\tcpu_to_le16(IEEE80211_SCTL_FRAG)) == 0);\n\tbool lastseg = ((hdr->frame_control &\n\t\t\tcpu_to_le16(IEEE80211_FCTL_MOREFRAGS)) == 0);\n\tdma_addr_t mapping;\n\tu8 bw_40 = 0;\n\n\tif (mac->opmode == NL80211_IFTYPE_STATION) {\n\t\tbw_40 = mac->bw_40;\n\t} else if (mac->opmode == NL80211_IFTYPE_AP ||\n\t\tmac->opmode == NL80211_IFTYPE_ADHOC) {\n\t\tif (sta)\n\t\t\tbw_40 = sta->deflink.bandwidth >= IEEE80211_STA_RX_BW_40;\n\t}\n\tseq_number = (le16_to_cpu(hdr->seq_ctrl) & IEEE80211_SCTL_SEQ) >> 4;\n\trtl_get_tcb_desc(hw, info, sta, skb, ptcb_desc);\n\t \n\tif (rtlhal->earlymode_enable) {\n\t\tskb_push(skb, EM_HDR_LEN);\n\t\tmemset(skb->data, 0, EM_HDR_LEN);\n\t}\n\tbuf_len = skb->len;\n\tmapping = dma_map_single(&rtlpci->pdev->dev, skb->data, skb->len,\n\t\t\t\t DMA_TO_DEVICE);\n\tif (dma_mapping_error(&rtlpci->pdev->dev, mapping)) {\n\t\trtl_dbg(rtlpriv, COMP_SEND, DBG_TRACE,\n\t\t\t\"DMA mapping error\\n\");\n\t\treturn;\n\t}\n\tclear_pci_tx_desc_content(pdesc, sizeof(struct tx_desc_92d));\n\tif (ieee80211_is_nullfunc(fc) || ieee80211_is_ctl(fc)) {\n\t\tfirstseg = true;\n\t\tlastseg = true;\n\t}\n\tif (firstseg) {\n\t\tif (rtlhal->earlymode_enable) {\n\t\t\tset_tx_desc_pkt_offset(pdesc, 1);\n\t\t\tset_tx_desc_offset(pdesc, USB_HWDESC_HEADER_LEN +\n\t\t\t\t\t   EM_HDR_LEN);\n\t\t\tif (ptcb_desc->empkt_num) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_SEND, DBG_LOUD,\n\t\t\t\t\t\"Insert 8 byte.pTcb->EMPktNum:%d\\n\",\n\t\t\t\t\tptcb_desc->empkt_num);\n\t\t\t\t_rtl92de_insert_emcontent(ptcb_desc,\n\t\t\t\t\t\t\t  (u8 *)(skb->data));\n\t\t\t}\n\t\t} else {\n\t\t\tset_tx_desc_offset(pdesc, USB_HWDESC_HEADER_LEN);\n\t\t}\n\t\t \n\t\tif (rtlhal->current_bandtype == BAND_ON_5G)\n\t\t\tif (ptcb_desc->hw_rate < DESC_RATE6M)\n\t\t\t\tptcb_desc->hw_rate = DESC_RATE6M;\n\t\tset_tx_desc_tx_rate(pdesc, ptcb_desc->hw_rate);\n\t\tif (ptcb_desc->use_shortgi || ptcb_desc->use_shortpreamble)\n\t\t\tset_tx_desc_data_shortgi(pdesc, 1);\n\n\t\tif (rtlhal->macphymode == DUALMAC_DUALPHY &&\n\t\t\tptcb_desc->hw_rate == DESC_RATEMCS7)\n\t\t\tset_tx_desc_data_shortgi(pdesc, 1);\n\n\t\tif (info->flags & IEEE80211_TX_CTL_AMPDU) {\n\t\t\tset_tx_desc_agg_enable(pdesc, 1);\n\t\t\tset_tx_desc_max_agg_num(pdesc, 0x14);\n\t\t}\n\t\tset_tx_desc_seq(pdesc, seq_number);\n\t\tset_tx_desc_rts_enable(pdesc,\n\t\t\t\t       ((ptcb_desc->rts_enable &&\n\t\t\t\t\t!ptcb_desc->cts_enable) ? 1 : 0));\n\t\tset_tx_desc_hw_rts_enable(pdesc, ((ptcb_desc->rts_enable\n\t\t\t\t\t  || ptcb_desc->cts_enable) ? 1 : 0));\n\t\tset_tx_desc_cts2self(pdesc, ((ptcb_desc->cts_enable) ? 1 : 0));\n\t\tset_tx_desc_rts_stbc(pdesc, ((ptcb_desc->rts_stbc) ? 1 : 0));\n\t\t \n\t\tif (rtlhal->current_bandtype == BAND_ON_5G)\n\t\t\tif (ptcb_desc->rts_rate < DESC_RATE6M)\n\t\t\t\tptcb_desc->rts_rate = DESC_RATE6M;\n\t\tset_tx_desc_rts_rate(pdesc, ptcb_desc->rts_rate);\n\t\tset_tx_desc_rts_bw(pdesc, 0);\n\t\tset_tx_desc_rts_sc(pdesc, ptcb_desc->rts_sc);\n\t\tset_tx_desc_rts_short(pdesc, ((ptcb_desc->rts_rate <=\n\t\t\tDESC_RATE54M) ?\n\t\t\t(ptcb_desc->rts_use_shortpreamble ? 1 : 0) :\n\t\t\t(ptcb_desc->rts_use_shortgi ? 1 : 0)));\n\t\tif (bw_40) {\n\t\t\tif (ptcb_desc->packet_bw) {\n\t\t\t\tset_tx_desc_data_bw(pdesc, 1);\n\t\t\t\tset_tx_desc_tx_sub_carrier(pdesc, 3);\n\t\t\t} else {\n\t\t\t\tset_tx_desc_data_bw(pdesc, 0);\n\t\t\t\tset_tx_desc_tx_sub_carrier(pdesc,\n\t\t\t\t\t\t\tmac->cur_40_prime_sc);\n\t\t\t}\n\t\t} else {\n\t\t\tset_tx_desc_data_bw(pdesc, 0);\n\t\t\tset_tx_desc_tx_sub_carrier(pdesc, 0);\n\t\t}\n\t\tset_tx_desc_linip(pdesc, 0);\n\t\tset_tx_desc_pkt_size(pdesc, (u16)skb_len);\n\t\tif (sta) {\n\t\t\tu8 ampdu_density = sta->deflink.ht_cap.ampdu_density;\n\t\t\tset_tx_desc_ampdu_density(pdesc, ampdu_density);\n\t\t}\n\t\tif (info->control.hw_key) {\n\t\t\tstruct ieee80211_key_conf *keyconf;\n\n\t\t\tkeyconf = info->control.hw_key;\n\t\t\tswitch (keyconf->cipher) {\n\t\t\tcase WLAN_CIPHER_SUITE_WEP40:\n\t\t\tcase WLAN_CIPHER_SUITE_WEP104:\n\t\t\tcase WLAN_CIPHER_SUITE_TKIP:\n\t\t\t\tset_tx_desc_sec_type(pdesc, 0x1);\n\t\t\t\tbreak;\n\t\t\tcase WLAN_CIPHER_SUITE_CCMP:\n\t\t\t\tset_tx_desc_sec_type(pdesc, 0x3);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tset_tx_desc_sec_type(pdesc, 0x0);\n\t\t\t\tbreak;\n\n\t\t\t}\n\t\t}\n\t\tset_tx_desc_pkt_id(pdesc, 0);\n\t\tset_tx_desc_queue_sel(pdesc, fw_qsel);\n\t\tset_tx_desc_data_rate_fb_limit(pdesc, 0x1F);\n\t\tset_tx_desc_rts_rate_fb_limit(pdesc, 0xF);\n\t\tset_tx_desc_disable_fb(pdesc, ptcb_desc->disable_ratefallback ?\n\t\t\t\t       1 : 0);\n\t\tset_tx_desc_use_rate(pdesc, ptcb_desc->use_driver_rate ? 1 : 0);\n\n\t\t \n\t\t \n\t\t \n\t\tif (!ptcb_desc->use_driver_rate) {\n\t\t\tset_tx_desc_rts_rate(pdesc, 0x08);\n\t\t\t \n\t\t}\n\t\tif (ieee80211_is_data_qos(fc)) {\n\t\t\tif (mac->rdg_en) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_SEND, DBG_TRACE,\n\t\t\t\t\t\"Enable RDG function\\n\");\n\t\t\t\tset_tx_desc_rdg_enable(pdesc, 1);\n\t\t\t\tset_tx_desc_htc(pdesc, 1);\n\t\t\t}\n\t\t}\n\t}\n\n\tset_tx_desc_first_seg(pdesc, (firstseg ? 1 : 0));\n\tset_tx_desc_last_seg(pdesc, (lastseg ? 1 : 0));\n\tset_tx_desc_tx_buffer_size(pdesc, (u16)buf_len);\n\tset_tx_desc_tx_buffer_address(pdesc, mapping);\n\tif (rtlpriv->dm.useramask) {\n\t\tset_tx_desc_rate_id(pdesc, ptcb_desc->ratr_index);\n\t\tset_tx_desc_macid(pdesc, ptcb_desc->mac_id);\n\t} else {\n\t\tset_tx_desc_rate_id(pdesc, 0xC + ptcb_desc->ratr_index);\n\t\tset_tx_desc_macid(pdesc, ptcb_desc->ratr_index);\n\t}\n\tif (ieee80211_is_data_qos(fc))\n\t\tset_tx_desc_qos(pdesc, 1);\n\n\tif ((!ieee80211_is_data_qos(fc)) && ppsc->fwctrl_lps) {\n\t\tset_tx_desc_hwseq_en(pdesc, 1);\n\t\tset_tx_desc_pkt_id(pdesc, 8);\n\t}\n\tset_tx_desc_more_frag(pdesc, (lastseg ? 0 : 1));\n\trtl_dbg(rtlpriv, COMP_SEND, DBG_TRACE, \"\\n\");\n}\n\nvoid rtl92de_tx_fill_cmddesc(struct ieee80211_hw *hw,\n\t\t\t     u8 *pdesc8, bool firstseg,\n\t\t\t     bool lastseg, struct sk_buff *skb)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_pci *rtlpci = rtl_pcidev(rtl_pcipriv(hw));\n\tstruct rtl_ps_ctl *ppsc = rtl_psc(rtlpriv);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\n\tu8 fw_queue = QSLT_BEACON;\n\n\tstruct ieee80211_hdr *hdr = rtl_get_hdr(skb);\n\t__le16 fc = hdr->frame_control;\n\t__le32 *pdesc = (__le32 *)pdesc8;\n\n\tdma_addr_t mapping = dma_map_single(&rtlpci->pdev->dev, skb->data,\n\t\t\t\t\t    skb->len, DMA_TO_DEVICE);\n\n\tif (dma_mapping_error(&rtlpci->pdev->dev, mapping)) {\n\t\trtl_dbg(rtlpriv, COMP_SEND, DBG_TRACE,\n\t\t\t\"DMA mapping error\\n\");\n\t\treturn;\n\t}\n\tclear_pci_tx_desc_content(pdesc, TX_DESC_SIZE);\n\tif (firstseg)\n\t\tset_tx_desc_offset(pdesc, USB_HWDESC_HEADER_LEN);\n\t \n\tif (rtlhal->current_bandtype == BAND_ON_5G) {\n\t\tset_tx_desc_tx_rate(pdesc, DESC_RATE6M);\n\t} else {\n\t\tset_tx_desc_tx_rate(pdesc, DESC_RATE1M);\n\t}\n\tset_tx_desc_seq(pdesc, 0);\n\tset_tx_desc_linip(pdesc, 0);\n\tset_tx_desc_queue_sel(pdesc, fw_queue);\n\tset_tx_desc_first_seg(pdesc, 1);\n\tset_tx_desc_last_seg(pdesc, 1);\n\tset_tx_desc_tx_buffer_size(pdesc, (u16)skb->len);\n\tset_tx_desc_tx_buffer_address(pdesc, mapping);\n\tset_tx_desc_rate_id(pdesc, 7);\n\tset_tx_desc_macid(pdesc, 0);\n\tset_tx_desc_pkt_size(pdesc, (u16)(skb->len));\n\tset_tx_desc_first_seg(pdesc, 1);\n\tset_tx_desc_last_seg(pdesc, 1);\n\tset_tx_desc_offset(pdesc, 0x20);\n\tset_tx_desc_use_rate(pdesc, 1);\n\n\tif (!ieee80211_is_data_qos(fc) && ppsc->fwctrl_lps) {\n\t\tset_tx_desc_hwseq_en(pdesc, 1);\n\t\tset_tx_desc_pkt_id(pdesc, 8);\n\t}\n\n\tRT_PRINT_DATA(rtlpriv, COMP_CMD, DBG_LOUD,\n\t\t      \"H2C Tx Cmd Content\", pdesc, TX_DESC_SIZE);\n\twmb();\n\tset_tx_desc_own(pdesc, 1);\n}\n\nvoid rtl92de_set_desc(struct ieee80211_hw *hw, u8 *pdesc8, bool istx,\n\t\t      u8 desc_name, u8 *val)\n{\n\t__le32  *pdesc = (__le32 *)pdesc8;\n\n\tif (istx) {\n\t\tswitch (desc_name) {\n\t\tcase HW_DESC_OWN:\n\t\t\twmb();\n\t\t\tset_tx_desc_own(pdesc, 1);\n\t\t\tbreak;\n\t\tcase HW_DESC_TX_NEXTDESC_ADDR:\n\t\t\tset_tx_desc_next_desc_address(pdesc, *(u32 *)val);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tWARN_ONCE(true, \"rtl8192de: ERR txdesc :%d not processed\\n\",\n\t\t\t\t  desc_name);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tswitch (desc_name) {\n\t\tcase HW_DESC_RXOWN:\n\t\t\twmb();\n\t\t\tset_rx_desc_own(pdesc, 1);\n\t\t\tbreak;\n\t\tcase HW_DESC_RXBUFF_ADDR:\n\t\t\tset_rx_desc_buff_addr(pdesc, *(u32 *)val);\n\t\t\tbreak;\n\t\tcase HW_DESC_RXPKT_LEN:\n\t\t\tset_rx_desc_pkt_len(pdesc, *(u32 *)val);\n\t\t\tbreak;\n\t\tcase HW_DESC_RXERO:\n\t\t\tset_rx_desc_eor(pdesc, 1);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tWARN_ONCE(true, \"rtl8192de: ERR rxdesc :%d not processed\\n\",\n\t\t\t\t  desc_name);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nu64 rtl92de_get_desc(struct ieee80211_hw *hw,\n\t\t     u8 *p_desc8, bool istx, u8 desc_name)\n{\n\t__le32 *p_desc = (__le32 *)p_desc8;\n\tu32 ret = 0;\n\n\tif (istx) {\n\t\tswitch (desc_name) {\n\t\tcase HW_DESC_OWN:\n\t\t\tret = get_tx_desc_own(p_desc);\n\t\t\tbreak;\n\t\tcase HW_DESC_TXBUFF_ADDR:\n\t\t\tret = get_tx_desc_tx_buffer_address(p_desc);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tWARN_ONCE(true, \"rtl8192de: ERR txdesc :%d not processed\\n\",\n\t\t\t\t  desc_name);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\tswitch (desc_name) {\n\t\tcase HW_DESC_OWN:\n\t\t\tret = get_rx_desc_own(p_desc);\n\t\t\tbreak;\n\t\tcase HW_DESC_RXPKT_LEN:\n\t\t\tret = get_rx_desc_pkt_len(p_desc);\n\t\tbreak;\n\t\tcase HW_DESC_RXBUFF_ADDR:\n\t\t\tret = get_rx_desc_buff_addr(p_desc);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tWARN_ONCE(true, \"rtl8192de: ERR rxdesc :%d not processed\\n\",\n\t\t\t\t  desc_name);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn ret;\n}\n\nbool rtl92de_is_tx_desc_closed(struct ieee80211_hw *hw,\n\t\t\t       u8 hw_queue, u16 index)\n{\n\tstruct rtl_pci *rtlpci = rtl_pcidev(rtl_pcipriv(hw));\n\tstruct rtl8192_tx_ring *ring = &rtlpci->tx_ring[hw_queue];\n\tu8 *entry = (u8 *)(&ring->desc[ring->idx]);\n\tu8 own = (u8)rtl92de_get_desc(hw, entry, true, HW_DESC_OWN);\n\n\t \n\tif (own)\n\t\treturn false;\n\treturn true;\n}\n\nvoid rtl92de_tx_polling(struct ieee80211_hw *hw, u8 hw_queue)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tif (hw_queue == BEACON_QUEUE)\n\t\trtl_write_word(rtlpriv, REG_PCIE_CTRL_REG, BIT(4));\n\telse\n\t\trtl_write_word(rtlpriv, REG_PCIE_CTRL_REG,\n\t\t\t       BIT(0) << (hw_queue));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}