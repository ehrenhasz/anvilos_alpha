{
  "module_name": "stats.c",
  "hash_id": "ea101950196a3fdefc39dab0a69e7e877204c69a107478c57707dae0c32ca04d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtlwifi/stats.c",
  "human_readable_source": "\n \n\n#include \"wifi.h\"\n#include \"stats.h\"\n#include <linux/export.h>\n\nu8 rtl_query_rxpwrpercentage(s8 antpower)\n{\n\tif ((antpower <= -100) || (antpower >= 20))\n\t\treturn 0;\n\telse if (antpower >= 0)\n\t\treturn 100;\n\telse\n\t\treturn 100 + antpower;\n}\nEXPORT_SYMBOL(rtl_query_rxpwrpercentage);\n\nu8 rtl_evm_db_to_percentage(s8 value)\n{\n\ts8 ret_val = clamp(-value, 0, 33) * 3;\n\n\tif (ret_val == 99)\n\t\tret_val = 100;\n\n\treturn ret_val;\n}\nEXPORT_SYMBOL(rtl_evm_db_to_percentage);\n\nstatic long rtl_translate_todbm(struct ieee80211_hw *hw,\n\t\t\t u8 signal_strength_index)\n{\n\tlong signal_power;\n\n\tsignal_power = (long)((signal_strength_index + 1) >> 1);\n\tsignal_power -= 95;\n\treturn signal_power;\n}\n\nlong rtl_signal_scale_mapping(struct ieee80211_hw *hw, long currsig)\n{\n\tlong retsig;\n\n\tif (currsig >= 61 && currsig <= 100)\n\t\tretsig = 90 + ((currsig - 60) / 4);\n\telse if (currsig >= 41 && currsig <= 60)\n\t\tretsig = 78 + ((currsig - 40) / 2);\n\telse if (currsig >= 31 && currsig <= 40)\n\t\tretsig = 66 + (currsig - 30);\n\telse if (currsig >= 21 && currsig <= 30)\n\t\tretsig = 54 + (currsig - 20);\n\telse if (currsig >= 5 && currsig <= 20)\n\t\tretsig = 42 + (((currsig - 5) * 2) / 3);\n\telse if (currsig == 4)\n\t\tretsig = 36;\n\telse if (currsig == 3)\n\t\tretsig = 27;\n\telse if (currsig == 2)\n\t\tretsig = 18;\n\telse if (currsig == 1)\n\t\tretsig = 9;\n\telse\n\t\tretsig = currsig;\n\n\treturn retsig;\n}\nEXPORT_SYMBOL(rtl_signal_scale_mapping);\n\nstatic void rtl_process_ui_rssi(struct ieee80211_hw *hw,\n\t\t\t\tstruct rtl_stats *pstatus)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &(rtlpriv->phy);\n\tu8 rfpath;\n\tu32 last_rssi, tmpval;\n\n\tif (!pstatus->packet_toself && !pstatus->packet_beacon)\n\t\treturn;\n\n\trtlpriv->stats.pwdb_all_cnt += pstatus->rx_pwdb_all;\n\trtlpriv->stats.rssi_calculate_cnt++;\n\n\tif (rtlpriv->stats.ui_rssi.total_num++ >= PHY_RSSI_SLID_WIN_MAX) {\n\t\trtlpriv->stats.ui_rssi.total_num = PHY_RSSI_SLID_WIN_MAX;\n\t\tlast_rssi = rtlpriv->stats.ui_rssi.elements[\n\t\t\trtlpriv->stats.ui_rssi.index];\n\t\trtlpriv->stats.ui_rssi.total_val -= last_rssi;\n\t}\n\trtlpriv->stats.ui_rssi.total_val += pstatus->signalstrength;\n\trtlpriv->stats.ui_rssi.elements[rtlpriv->stats.ui_rssi.index++] =\n\t    pstatus->signalstrength;\n\tif (rtlpriv->stats.ui_rssi.index >= PHY_RSSI_SLID_WIN_MAX)\n\t\trtlpriv->stats.ui_rssi.index = 0;\n\ttmpval = rtlpriv->stats.ui_rssi.total_val /\n\t\trtlpriv->stats.ui_rssi.total_num;\n\trtlpriv->stats.signal_strength = rtl_translate_todbm(hw,\n\t\t(u8) tmpval);\n\tpstatus->rssi = rtlpriv->stats.signal_strength;\n\n\tif (pstatus->is_cck)\n\t\treturn;\n\n\tfor (rfpath = RF90_PATH_A; rfpath < rtlphy->num_total_rfpath;\n\t     rfpath++) {\n\t\tif (rtlpriv->stats.rx_rssi_percentage[rfpath] == 0) {\n\t\t\trtlpriv->stats.rx_rssi_percentage[rfpath] =\n\t\t\t    pstatus->rx_mimo_signalstrength[rfpath];\n\n\t\t}\n\t\tif (pstatus->rx_mimo_signalstrength[rfpath] >\n\t\t    rtlpriv->stats.rx_rssi_percentage[rfpath]) {\n\t\t\trtlpriv->stats.rx_rssi_percentage[rfpath] =\n\t\t\t    ((rtlpriv->stats.rx_rssi_percentage[rfpath] *\n\t\t\t      (RX_SMOOTH_FACTOR - 1)) +\n\t\t\t     (pstatus->rx_mimo_signalstrength[rfpath])) /\n\t\t\t    (RX_SMOOTH_FACTOR);\n\t\t\trtlpriv->stats.rx_rssi_percentage[rfpath] =\n\t\t\t    rtlpriv->stats.rx_rssi_percentage[rfpath] + 1;\n\t\t} else {\n\t\t\trtlpriv->stats.rx_rssi_percentage[rfpath] =\n\t\t\t    ((rtlpriv->stats.rx_rssi_percentage[rfpath] *\n\t\t\t      (RX_SMOOTH_FACTOR - 1)) +\n\t\t\t     (pstatus->rx_mimo_signalstrength[rfpath])) /\n\t\t\t    (RX_SMOOTH_FACTOR);\n\t\t}\n\t\trtlpriv->stats.rx_snr_db[rfpath] = pstatus->rx_snr[rfpath];\n\t\trtlpriv->stats.rx_evm_dbm[rfpath] =\n\t\t\t\t\tpstatus->rx_mimo_evm_dbm[rfpath];\n\t\trtlpriv->stats.rx_cfo_short[rfpath] =\n\t\t\t\t\tpstatus->cfo_short[rfpath];\n\t\trtlpriv->stats.rx_cfo_tail[rfpath] = pstatus->cfo_tail[rfpath];\n\t}\n}\n\nstatic void rtl_update_rxsignalstatistics(struct ieee80211_hw *hw,\n\t\t\t\t\t  struct rtl_stats *pstatus)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tint weighting = 0;\n\n\tif (rtlpriv->stats.recv_signal_power == 0)\n\t\trtlpriv->stats.recv_signal_power = pstatus->recvsignalpower;\n\tif (pstatus->recvsignalpower > rtlpriv->stats.recv_signal_power)\n\t\tweighting = 5;\n\telse if (pstatus->recvsignalpower < rtlpriv->stats.recv_signal_power)\n\t\tweighting = (-5);\n\trtlpriv->stats.recv_signal_power = (rtlpriv->stats.recv_signal_power *\n\t\t5 + pstatus->recvsignalpower + weighting) / 6;\n}\n\nstatic void rtl_process_pwdb(struct ieee80211_hw *hw, struct rtl_stats *pstatus)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_sta_info *drv_priv = NULL;\n\tstruct ieee80211_sta *sta = NULL;\n\tlong undec_sm_pwdb;\n\n\trcu_read_lock();\n\tif (rtlpriv->mac80211.opmode != NL80211_IFTYPE_STATION)\n\t\tsta = rtl_find_sta(hw, pstatus->psaddr);\n\n\t \n\tif (sta) {\n\t\tdrv_priv = (struct rtl_sta_info *) sta->drv_priv;\n\t\tundec_sm_pwdb = drv_priv->rssi_stat.undec_sm_pwdb;\n\t} else {\n\t\tundec_sm_pwdb = rtlpriv->dm.undec_sm_pwdb;\n\t}\n\n\tif (undec_sm_pwdb < 0)\n\t\tundec_sm_pwdb = pstatus->rx_pwdb_all;\n\tif (pstatus->rx_pwdb_all > (u32) undec_sm_pwdb) {\n\t\tundec_sm_pwdb = (((undec_sm_pwdb) *\n\t\t      (RX_SMOOTH_FACTOR - 1)) +\n\t\t     (pstatus->rx_pwdb_all)) / (RX_SMOOTH_FACTOR);\n\t\tundec_sm_pwdb = undec_sm_pwdb + 1;\n\t} else {\n\t\tundec_sm_pwdb = (((undec_sm_pwdb) *\n\t\t      (RX_SMOOTH_FACTOR - 1)) +\n\t\t     (pstatus->rx_pwdb_all)) / (RX_SMOOTH_FACTOR);\n\t}\n\n\tif (sta) {\n\t\tdrv_priv->rssi_stat.undec_sm_pwdb = undec_sm_pwdb;\n\t} else {\n\t\trtlpriv->dm.undec_sm_pwdb = undec_sm_pwdb;\n\t}\n\trcu_read_unlock();\n\n\trtl_update_rxsignalstatistics(hw, pstatus);\n}\n\nstatic void rtl_process_ui_link_quality(struct ieee80211_hw *hw,\n\t\t\t\t\tstruct rtl_stats *pstatus)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 last_evm, n_stream, tmpval;\n\n\tif (pstatus->signalquality == 0)\n\t\treturn;\n\n\tif (rtlpriv->stats.ui_link_quality.total_num++ >=\n\t    PHY_LINKQUALITY_SLID_WIN_MAX) {\n\t\trtlpriv->stats.ui_link_quality.total_num =\n\t\t    PHY_LINKQUALITY_SLID_WIN_MAX;\n\t\tlast_evm = rtlpriv->stats.ui_link_quality.elements[\n\t\t\trtlpriv->stats.ui_link_quality.index];\n\t\trtlpriv->stats.ui_link_quality.total_val -= last_evm;\n\t}\n\trtlpriv->stats.ui_link_quality.total_val += pstatus->signalquality;\n\trtlpriv->stats.ui_link_quality.elements[\n\t\trtlpriv->stats.ui_link_quality.index++] =\n\t\t\t\t\t\t\tpstatus->signalquality;\n\tif (rtlpriv->stats.ui_link_quality.index >=\n\t    PHY_LINKQUALITY_SLID_WIN_MAX)\n\t\trtlpriv->stats.ui_link_quality.index = 0;\n\ttmpval = rtlpriv->stats.ui_link_quality.total_val /\n\t    rtlpriv->stats.ui_link_quality.total_num;\n\trtlpriv->stats.signal_quality = tmpval;\n\trtlpriv->stats.last_sigstrength_inpercent = tmpval;\n\tfor (n_stream = 0; n_stream < 2; n_stream++) {\n\t\tif (pstatus->rx_mimo_sig_qual[n_stream] != -1) {\n\t\t\tif (rtlpriv->stats.rx_evm_percentage[n_stream] == 0) {\n\t\t\t\trtlpriv->stats.rx_evm_percentage[n_stream] =\n\t\t\t\t    pstatus->rx_mimo_sig_qual[n_stream];\n\t\t\t}\n\t\t\trtlpriv->stats.rx_evm_percentage[n_stream] =\n\t\t\t    ((rtlpriv->stats.rx_evm_percentage[n_stream]\n\t\t\t      * (RX_SMOOTH_FACTOR - 1)) +\n\t\t\t     (pstatus->rx_mimo_sig_qual[n_stream] * 1)) /\n\t\t\t    (RX_SMOOTH_FACTOR);\n\t\t}\n\t}\n}\n\nvoid rtl_process_phyinfo(struct ieee80211_hw *hw, u8 *buffer,\n\t\t\t struct rtl_stats *pstatus)\n{\n\n\tif (!pstatus->packet_matchbssid)\n\t\treturn;\n\n\trtl_process_ui_rssi(hw, pstatus);\n\trtl_process_pwdb(hw, pstatus);\n\trtl_process_ui_link_quality(hw, pstatus);\n}\nEXPORT_SYMBOL(rtl_process_phyinfo);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}