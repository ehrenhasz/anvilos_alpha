{
  "module_name": "dm.c",
  "hash_id": "ba01e192cbff61723ca16bd4f12f9f4b7db28e5ce74478224efa3fc0e697a7c2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtlwifi/rtl8821ae/dm.c",
  "human_readable_source": "\n \n\n#include \"../wifi.h\"\n#include \"../base.h\"\n#include \"../pci.h\"\n#include \"../core.h\"\n#include \"reg.h\"\n#include \"def.h\"\n#include \"phy.h\"\n#include \"dm.h\"\n#include \"fw.h\"\n#include \"trx.h\"\n#include \"../btcoexist/rtl_btc.h\"\n\nstatic const u32 txscaling_tbl[TXSCALE_TABLE_SIZE] = {\n\t0x081,  \n\t0x088,  \n\t0x090,  \n\t0x099,  \n\t0x0A2,  \n\t0x0AC,  \n\t0x0B6,  \n\t0x0C0,  \n\t0x0CC,  \n\t0x0D8,  \n\t0x0E5,  \n\t0x0F2,  \n\t0x101,  \n\t0x110,  \n\t0x120,  \n\t0x131,  \n\t0x143,  \n\t0x156,  \n\t0x16A,  \n\t0x180,  \n\t0x197,  \n\t0x1AF,  \n\t0x1C8,  \n\t0x1E3,  \n\t0x200,  \n\t0x21E,  \n\t0x23E,  \n\t0x261,  \n\t0x285,  \n\t0x2AB,  \n\t0x2D3,  \n\t0x2FE,  \n\t0x32B,  \n\t0x35C,  \n\t0x38E,  \n\t0x3C4,  \n\t0x3FE   \n};\n\nstatic const u32 rtl8821ae_txscaling_table[TXSCALE_TABLE_SIZE] = {\n\t0x081,  \n\t0x088,  \n\t0x090,  \n\t0x099,  \n\t0x0A2,  \n\t0x0AC,  \n\t0x0B6,  \n\t0x0C0,  \n\t0x0CC,  \n\t0x0D8,  \n\t0x0E5,  \n\t0x0F2,  \n\t0x101,  \n\t0x110,  \n\t0x120,  \n\t0x131,  \n\t0x143,  \n\t0x156,  \n\t0x16A,  \n\t0x180,  \n\t0x197,  \n\t0x1AF,  \n\t0x1C8,  \n\t0x1E3,  \n\t0x200,  \n\t0x21E,  \n\t0x23E,  \n\t0x261,  \n\t0x285,  \n\t0x2AB,  \n\t0x2D3,  \n\t0x2FE,  \n\t0x32B,  \n\t0x35C,  \n\t0x38E,  \n\t0x3C4,  \n\t0x3FE   \n};\n\nstatic const u32 edca_setting_dl[PEER_MAX] = {\n\t0xa44f,\t\t \n\t0x5ea44f,\t \n\t0x5e4322,\t \n\t0x5ea42b,\t\t \n\t0xa44f,\t\t \n\t0xa630,\t\t \n\t0x5ea630,\t\t \n\t0x5ea42b,\t\t \n};\n\nstatic const u32 edca_setting_ul[PEER_MAX] = {\n\t0x5e4322,\t \n\t0xa44f,\t\t \n\t0x5ea44f,\t \n\t0x5ea32b,\t \n\t0x5ea422,\t \n\t0x5ea322,\t \n\t0x3ea430,\t \n\t0x5ea44f,\t \n};\n\nstatic const u8 rtl8818e_delta_swing_table_idx_24gb_p[] = {\n\t0, 0, 0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 4, 4, 4,\n\t4, 4, 4, 5, 5, 7, 7, 8, 8, 8, 9, 9, 9, 9, 9};\n\nstatic const u8 rtl8818e_delta_swing_table_idx_24gb_n[] = {\n\t0, 0, 0, 2, 2, 3, 3, 4, 4, 4, 4, 5, 5, 6, 6,\n\t7, 7, 7, 7, 8, 8, 9, 9, 10, 10, 10, 11, 11, 11, 11};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_24gb_n[]  = {\n\t0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 6,\n\t6, 6, 7, 8, 9, 9, 9, 9, 10, 10, 10, 10, 11, 11};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_24gb_p[] = {\n\t0, 0, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 6,\n\t6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 9, 9, 9, 9};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_24ga_n[] = {\n\t0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 6,\n\t6, 6, 7, 8, 8, 9, 9, 9, 10, 10, 10, 10, 11, 11};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_24ga_p[] = {\n\t0, 0, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 6,\n\t6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 9, 9, 9, 9};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_24gcckb_n[] = {\n\t0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 6,\n\t6, 6, 7, 8, 9, 9, 9, 9, 10, 10, 10, 10, 11, 11};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_24gcckb_p[] = {\n\t0, 0, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 6,\n\t6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 9, 9, 9, 9};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_24gccka_n[] = {\n\t0, 1, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 5, 6,\n\t6, 6, 7, 8, 8, 9, 9, 9, 10, 10, 10, 10, 11, 11};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_24gccka_p[] = {\n\t0, 0, 1, 1, 2, 2, 2, 2, 3, 3, 3, 4, 4, 5, 5, 6,\n\t6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 9, 9, 9, 9};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_5gb_n[][DEL_SW_IDX_SZ] = {\n\t{0, 1, 1, 2, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 6, 7, 7,\n\t7, 8, 8, 9, 9, 9, 10, 10, 11, 11, 12, 12, 13},\n\t{0, 1, 1, 2, 2, 2, 3, 3, 4, 4, 4, 5, 5, 6, 6, 7,\n\t7, 8, 8, 9, 9, 10, 10, 11, 11, 12, 12, 12, 13, 13},\n\t{0, 1, 1, 2, 3, 3, 4, 4, 5, 6, 6, 7, 8, 9, 10, 11,\n\t12, 12, 13, 14, 14, 14, 15, 16, 17, 17, 17, 18, 18, 18},\n};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_5gb_p[][DEL_SW_IDX_SZ] = {\n\t{0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 6, 7, 7, 8,\n\t8, 9, 9, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11},\n\t{0, 1, 1, 2, 2, 3, 3, 4, 4, 4, 5, 5, 6, 6, 7, 7, 8,\n\t8, 9, 9, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11},\n\t{0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 7, 7, 8, 8, 9,\n\t9, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11},\n};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_5ga_n[][DEL_SW_IDX_SZ] = {\n\t{0, 1, 1, 2, 2, 3, 3, 4, 4, 4, 5, 5, 6, 6, 7, 7, 8,\n\t8, 9, 9, 10, 10, 11, 11, 12, 12, 12, 13, 13, 13},\n\t{0, 1, 1, 2, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 8, 9,\n\t9, 10, 10, 11, 11, 11, 12, 12, 12, 12, 12, 13, 13},\n\t{0, 1, 1, 2, 2, 3, 3, 4, 5, 6, 7, 8, 8, 9, 10, 11,\n\t12, 13, 14, 14, 15, 15, 15, 16, 16, 16, 17, 17, 18, 18},\n};\n\nstatic const u8 rtl8812ae_delta_swing_table_idx_5ga_p[][DEL_SW_IDX_SZ] = {\n\t{0, 1, 1, 2, 2, 3, 3, 4, 4, 4, 4, 5, 5, 6, 7, 7, 8,\n\t8, 9, 9, 10, 10, 11, 11, 11, 11, 11, 11, 11, 11},\n\t{0, 1, 1, 2, 2, 3, 3, 4, 4, 4, 5, 5, 6, 6, 7, 7, 8,\n\t9, 9, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11},\n\t{0, 1, 1, 2, 3, 3, 4, 4, 5, 6, 6, 7, 7, 8, 9, 9,\n\t10, 10, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11},\n};\n\nstatic const u8 rtl8821ae_delta_swing_table_idx_24ga_n[]  = {\n\t0, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6,\n\t6, 7, 7, 7, 8, 8, 8, 9, 9, 9, 10, 10, 10};\n\nstatic const u8 rtl8821ae_delta_swing_table_idx_24ga_p[] = {\n\t0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8,\n\t8, 9, 9, 10, 10, 11, 11, 12, 12, 12, 12, 12, 12};\n\nstatic const u8 rtl8821ae_delta_swing_table_idx_24gccka_n[] = {\n\t0, 1, 1, 2, 2, 2, 3, 3, 3, 4, 4, 4, 5, 5, 5, 6, 6,\n\t6, 7, 7, 7, 8, 8, 8, 9, 9, 9, 10, 10, 10};\n\nstatic const u8 rtl8821ae_delta_swing_table_idx_24gccka_p[] = {\n\t0, 0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8,\n\t8, 9, 9, 10, 10, 11, 11, 12, 12, 12, 12, 12, 12};\n\nstatic const u8 rtl8821ae_delta_swing_table_idx_5ga_n[][DEL_SW_IDX_SZ] = {\n\t{0, 0, 1, 2, 3, 3, 4, 5, 6, 6, 7, 8, 9, 9, 10, 11,\n\t12, 12, 13, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16},\n\t{0, 0, 1, 2, 3, 3, 4, 5, 6, 6, 7, 8, 9, 9, 10, 11,\n\t12, 12, 13, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16},\n\t{0, 0, 1, 2, 3, 3, 4, 5, 6, 6, 7, 8, 9, 9, 10, 11,\n\t12, 12, 13, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16},\n};\n\nstatic const u8 rtl8821ae_delta_swing_table_idx_5ga_p[][DEL_SW_IDX_SZ] = {\n\t{0, 0, 1, 2, 3, 3, 4, 5, 6, 6, 7, 8, 9, 9, 10, 11,\n\t12, 12, 13, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16},\n\t{0, 0, 1, 2, 3, 3, 4, 5, 6, 6, 7, 8, 9, 9, 10, 11,\n\t12, 12, 13, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16},\n\t{0, 0, 1, 2, 3, 3, 4, 5, 6, 6, 7, 8, 9, 9, 10, 11,\n\t12, 12, 13, 14, 15, 15, 16, 16, 16, 16, 16, 16, 16, 16},\n};\n\nvoid rtl8821ae_dm_txpower_track_adjust(struct ieee80211_hw *hw,\n\t\t\t\t       u8 type, u8 *pdirection,\n\t\t\t\t       u32 *poutwrite_val)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\n\tu8 pwr_val = 0;\n\n\tif (type == 0) {\n\t\tif (rtlpriv->dm.swing_idx_ofdm[RF90_PATH_A] <=\n\t\t\trtlpriv->dm.swing_idx_ofdm_base[RF90_PATH_A]) {\n\t\t\t*pdirection = 1;\n\t\t\tpwr_val = rtldm->swing_idx_ofdm_base[RF90_PATH_A] -\n\t\t\t\t\trtldm->swing_idx_ofdm[RF90_PATH_A];\n\t\t} else {\n\t\t\t*pdirection = 2;\n\t\t\tpwr_val = rtldm->swing_idx_ofdm[RF90_PATH_A] -\n\t\t\t\trtldm->swing_idx_ofdm_base[RF90_PATH_A];\n\t\t}\n\t} else if (type == 1) {\n\t\tif (rtldm->swing_idx_cck <= rtldm->swing_idx_cck_base) {\n\t\t\t*pdirection = 1;\n\t\t\tpwr_val = rtldm->swing_idx_cck_base -\n\t\t\t\t\trtldm->swing_idx_cck;\n\t\t} else {\n\t\t\t*pdirection = 2;\n\t\t\tpwr_val = rtldm->swing_idx_cck -\n\t\t\t\trtldm->swing_idx_cck_base;\n\t\t}\n\t}\n\n\tif (pwr_val >= TXPWRTRACK_MAX_IDX && (*pdirection == 1))\n\t\tpwr_val = TXPWRTRACK_MAX_IDX;\n\n\t*poutwrite_val = pwr_val | (pwr_val << 8)|\n\t\t\t\t(pwr_val << 16)|\n\t\t\t\t(pwr_val << 24);\n}\n\nvoid rtl8821ae_dm_clear_txpower_tracking_state(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_dm *rtldm = rtl_dm(rtlpriv);\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtlpriv);\n\tu8 p = 0;\n\n\trtldm->swing_idx_cck_base = rtldm->default_cck_index;\n\trtldm->swing_idx_cck = rtldm->default_cck_index;\n\trtldm->cck_index = 0;\n\n\tfor (p = RF90_PATH_A; p <= RF90_PATH_B; ++p) {\n\t\trtldm->swing_idx_ofdm_base[p] = rtldm->default_ofdm_index;\n\t\trtldm->swing_idx_ofdm[p] = rtldm->default_ofdm_index;\n\t\trtldm->ofdm_index[p] = rtldm->default_ofdm_index;\n\n\t\trtldm->power_index_offset[p] = 0;\n\t\trtldm->delta_power_index[p] = 0;\n\t\trtldm->delta_power_index_last[p] = 0;\n\t\t \n\t\trtldm->absolute_ofdm_swing_idx[p] = 0;\n\t\trtldm->remnant_ofdm_swing_idx[p] = 0;\n\t}\n\t \n\trtldm->modify_txagc_flag_path_a = false;\n\t \n\trtldm->modify_txagc_flag_path_b = false;\n\trtldm->remnant_cck_idx = 0;\n\trtldm->thermalvalue = rtlefuse->eeprom_thermalmeter;\n\trtldm->thermalvalue_iqk = rtlefuse->eeprom_thermalmeter;\n\trtldm->thermalvalue_lck = rtlefuse->eeprom_thermalmeter;\n}\n\nstatic u8  rtl8821ae_dm_get_swing_index(struct ieee80211_hw *hw)\n{\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tu8 i = 0;\n\tu32  bb_swing;\n\n\tbb_swing = phy_get_tx_swing_8812A(hw, rtlhal->current_bandtype,\n\t\t\t\t\t  RF90_PATH_A);\n\n\tfor (i = 0; i < TXSCALE_TABLE_SIZE; ++i)\n\t\tif (bb_swing == rtl8821ae_txscaling_table[i])\n\t\t\tbreak;\n\n\treturn i;\n}\n\nvoid rtl8821ae_dm_initialize_txpower_tracking_thermalmeter(\n\t\t\t\tstruct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_dm *rtldm = rtl_dm(rtlpriv);\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtlpriv);\n\tu8 default_swing_index  = 0;\n\tu8 p = 0;\n\n\trtlpriv->dm.txpower_track_control = true;\n\trtldm->thermalvalue = rtlefuse->eeprom_thermalmeter;\n\trtldm->thermalvalue_iqk = rtlefuse->eeprom_thermalmeter;\n\trtldm->thermalvalue_lck = rtlefuse->eeprom_thermalmeter;\n\tdefault_swing_index = rtl8821ae_dm_get_swing_index(hw);\n\n\trtldm->default_ofdm_index =\n\t\t(default_swing_index == TXSCALE_TABLE_SIZE) ?\n\t\t24 : default_swing_index;\n\trtldm->default_cck_index = 24;\n\n\trtldm->swing_idx_cck_base = rtldm->default_cck_index;\n\trtldm->cck_index = rtldm->default_cck_index;\n\n\tfor (p = RF90_PATH_A; p < MAX_RF_PATH; ++p) {\n\t\trtldm->swing_idx_ofdm_base[p] =\n\t\t\trtldm->default_ofdm_index;\n\t\trtldm->ofdm_index[p] = rtldm->default_ofdm_index;\n\t\trtldm->delta_power_index[p] = 0;\n\t\trtldm->power_index_offset[p] = 0;\n\t\trtldm->delta_power_index_last[p] = 0;\n\t}\n}\n\nvoid rtl8821ae_dm_init_edca_turbo(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\trtlpriv->dm.current_turbo_edca = false;\n\trtlpriv->dm.is_any_nonbepkts = false;\n\trtlpriv->dm.is_cur_rdlstate = false;\n}\n\nvoid rtl8821ae_dm_init_rate_adaptive_mask(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rate_adaptive *p_ra = &rtlpriv->ra;\n\n\tp_ra->ratr_state = DM_RATR_STA_INIT;\n\tp_ra->pre_ratr_state = DM_RATR_STA_INIT;\n\n\trtlpriv->dm.dm_type = DM_TYPE_BYDRIVER;\n\tif (rtlpriv->dm.dm_type == DM_TYPE_BYDRIVER)\n\t\trtlpriv->dm.useramask = true;\n\telse\n\t\trtlpriv->dm.useramask = false;\n\n\tp_ra->high_rssi_thresh_for_ra = 50;\n\tp_ra->low_rssi_thresh_for_ra40m = 20;\n}\n\nstatic void rtl8821ae_dm_init_dynamic_atc_switch(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\trtlpriv->dm.crystal_cap = rtlpriv->efuse.crystalcap;\n\n\trtlpriv->dm.atc_status = rtl_get_bbreg(hw, ROFDM1_CFOTRACKING, BIT(11));\n\trtlpriv->dm.cfo_threshold = CFO_THRESHOLD_XTAL;\n}\n\nstatic void rtl8821ae_dm_common_info_self_init(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 tmp;\n\n\trtlphy->cck_high_power =\n\t\t(bool)rtl_get_bbreg(hw, ODM_REG_CCK_RPT_FORMAT_11AC,\n\t\t\t\t    ODM_BIT_CCK_RPT_FORMAT_11AC);\n\n\ttmp = (u8)rtl_get_bbreg(hw, ODM_REG_BB_RX_PATH_11AC,\n\t\t\t\tODM_BIT_BB_RX_PATH_11AC);\n\tif (tmp & BIT(0))\n\t\trtlpriv->dm.rfpath_rxenable[0] = true;\n\tif (tmp & BIT(1))\n\t\trtlpriv->dm.rfpath_rxenable[1] = true;\n}\n\nvoid rtl8821ae_dm_init(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu32 cur_igvalue = rtl_get_bbreg(hw, ROFDM0_XAAGCCORE1, 0x7f);\n\n\tspin_lock(&rtlpriv->locks.iqk_lock);\n\trtlphy->lck_inprogress = false;\n\tspin_unlock(&rtlpriv->locks.iqk_lock);\n\n\trtlpriv->dm.dm_type = DM_TYPE_BYDRIVER;\n\trtl8821ae_dm_common_info_self_init(hw);\n\trtl_dm_diginit(hw, cur_igvalue);\n\trtl8821ae_dm_init_rate_adaptive_mask(hw);\n\trtl8821ae_dm_init_edca_turbo(hw);\n\trtl8821ae_dm_initialize_txpower_tracking_thermalmeter(hw);\n\trtl8821ae_dm_init_dynamic_atc_switch(hw);\n}\n\nstatic void rtl8821ae_dm_find_minimum_rssi(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct dig_t *rtl_dm_dig = &rtlpriv->dm_digtable;\n\tstruct rtl_mac *mac = rtl_mac(rtlpriv);\n\n\t \n\tif ((mac->link_state < MAC80211_LINKED) &&\n\t    (rtlpriv->dm.entry_min_undec_sm_pwdb == 0)) {\n\t\trtl_dm_dig->min_undec_pwdb_for_dm = 0;\n\t\tpr_debug(\"rtl8821ae: Not connected to any AP\\n\");\n\t}\n\tif (mac->link_state >= MAC80211_LINKED) {\n\t\tif (mac->opmode == NL80211_IFTYPE_AP ||\n\t\t    mac->opmode == NL80211_IFTYPE_ADHOC) {\n\t\t\trtl_dm_dig->min_undec_pwdb_for_dm =\n\t\t\t    rtlpriv->dm.entry_min_undec_sm_pwdb;\n\t\t\trtl_dbg(rtlpriv, COMP_BB_POWERSAVING, DBG_LOUD,\n\t\t\t\t\"AP Client PWDB = 0x%lx\\n\",\n\t\t\t\trtlpriv->dm.entry_min_undec_sm_pwdb);\n\t\t} else {\n\t\t\trtl_dm_dig->min_undec_pwdb_for_dm =\n\t\t\t    rtlpriv->dm.undec_sm_pwdb;\n\t\t\trtl_dbg(rtlpriv, COMP_BB_POWERSAVING, DBG_LOUD,\n\t\t\t\t\"STA Default Port PWDB = 0x%x\\n\",\n\t\t\t\trtl_dm_dig->min_undec_pwdb_for_dm);\n\t\t}\n\t} else {\n\t\trtl_dm_dig->min_undec_pwdb_for_dm =\n\t\t    rtlpriv->dm.entry_min_undec_sm_pwdb;\n\t\trtl_dbg(rtlpriv, COMP_BB_POWERSAVING, DBG_LOUD,\n\t\t\t\"AP Ext Port or disconnect PWDB = 0x%x\\n\",\n\t\t\trtl_dm_dig->min_undec_pwdb_for_dm);\n\t}\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\"MinUndecoratedPWDBForDM =%d\\n\",\n\t\trtl_dm_dig->min_undec_pwdb_for_dm);\n}\n\nstatic void  rtl8812ae_dm_rssi_dump_to_register(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\trtl_write_byte(rtlpriv, RA_RSSI_DUMP,\n\t\t       rtlpriv->stats.rx_rssi_percentage[0]);\n\trtl_write_byte(rtlpriv, RB_RSSI_DUMP,\n\t\t       rtlpriv->stats.rx_rssi_percentage[1]);\n\n\t \n\trtl_write_byte(rtlpriv, RS1_RX_EVM_DUMP,\n\t\t       rtlpriv->stats.rx_evm_dbm[0]);\n\trtl_write_byte(rtlpriv, RS2_RX_EVM_DUMP,\n\t\t       rtlpriv->stats.rx_evm_dbm[1]);\n\n\t \n\trtl_write_byte(rtlpriv, RA_RX_SNR_DUMP,\n\t\t       (u8)(rtlpriv->stats.rx_snr_db[0]));\n\trtl_write_byte(rtlpriv, RB_RX_SNR_DUMP,\n\t\t       (u8)(rtlpriv->stats.rx_snr_db[1]));\n\n\t \n\trtl_write_word(rtlpriv, RA_CFO_SHORT_DUMP,\n\t\t       rtlpriv->stats.rx_cfo_short[0]);\n\trtl_write_word(rtlpriv, RB_CFO_SHORT_DUMP,\n\t\t       rtlpriv->stats.rx_cfo_short[1]);\n\n\t \n\trtl_write_word(rtlpriv, RA_CFO_LONG_DUMP,\n\t\t       rtlpriv->stats.rx_cfo_tail[0]);\n\trtl_write_word(rtlpriv, RB_CFO_LONG_DUMP,\n\t\t       rtlpriv->stats.rx_cfo_tail[1]);\n}\n\nstatic void rtl8821ae_dm_check_rssi_monitor(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\n\tstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tstruct rtl_sta_info *drv_priv;\n\tu8 h2c_parameter[4] = { 0 };\n\tlong tmp_entry_max_pwdb = 0, tmp_entry_min_pwdb = 0xff;\n\tu8 stbc_tx = 0;\n\tu64 cur_rxokcnt = 0;\n\tstatic u64 last_txokcnt = 0, last_rxokcnt;\n\n\tcur_rxokcnt = rtlpriv->stats.rxbytesunicast - last_rxokcnt;\n\tlast_txokcnt = rtlpriv->stats.txbytesunicast;\n\tlast_rxokcnt = rtlpriv->stats.rxbytesunicast;\n\tif (cur_rxokcnt > (last_txokcnt * 6))\n\t\th2c_parameter[3] = 0x01;\n\telse\n\t\th2c_parameter[3] = 0x00;\n\n\t \n\tif (mac->opmode == NL80211_IFTYPE_AP ||\n\t    mac->opmode == NL80211_IFTYPE_ADHOC ||\n\t    mac->opmode == NL80211_IFTYPE_MESH_POINT) {\n\t\tspin_lock_bh(&rtlpriv->locks.entry_list_lock);\n\t\tlist_for_each_entry(drv_priv, &rtlpriv->entry_list, list) {\n\t\t\tif (drv_priv->rssi_stat.undec_sm_pwdb <\n\t\t\t\t\ttmp_entry_min_pwdb)\n\t\t\t\ttmp_entry_min_pwdb =\n\t\t\t\t\tdrv_priv->rssi_stat.undec_sm_pwdb;\n\t\t\tif (drv_priv->rssi_stat.undec_sm_pwdb >\n\t\t\t\t\ttmp_entry_max_pwdb)\n\t\t\t\ttmp_entry_max_pwdb =\n\t\t\t\t\tdrv_priv->rssi_stat.undec_sm_pwdb;\n\t\t}\n\t\tspin_unlock_bh(&rtlpriv->locks.entry_list_lock);\n\n\t\t \n\t\tif (tmp_entry_max_pwdb != 0) {\n\t\t\trtlpriv->dm.entry_max_undec_sm_pwdb =\n\t\t\t\ttmp_entry_max_pwdb;\n\t\t\tRTPRINT(rtlpriv, FDM, DM_PWDB,\n\t\t\t\t\"EntryMaxPWDB = 0x%lx(%ld)\\n\",\n\t\t\t\ttmp_entry_max_pwdb, tmp_entry_max_pwdb);\n\t\t} else {\n\t\t\trtlpriv->dm.entry_max_undec_sm_pwdb = 0;\n\t\t}\n\t\t \n\t\tif (tmp_entry_min_pwdb != 0xff) {\n\t\t\trtlpriv->dm.entry_min_undec_sm_pwdb =\n\t\t\t\ttmp_entry_min_pwdb;\n\t\t\tRTPRINT(rtlpriv, FDM, DM_PWDB,\n\t\t\t\t\"EntryMinPWDB = 0x%lx(%ld)\\n\",\n\t\t\t\ttmp_entry_min_pwdb, tmp_entry_min_pwdb);\n\t\t} else {\n\t\t\trtlpriv->dm.entry_min_undec_sm_pwdb = 0;\n\t\t}\n\t}\n\t \n\tif (rtlpriv->dm.useramask) {\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\n\t\t\tif (mac->mode == WIRELESS_MODE_AC_24G ||\n\t\t\t    mac->mode == WIRELESS_MODE_AC_5G ||\n\t\t\t    mac->mode == WIRELESS_MODE_AC_ONLY)\n\t\t\t\tstbc_tx = (mac->vht_cur_stbc &\n\t\t\t\t\t   STBC_VHT_ENABLE_TX) ? 1 : 0;\n\t\t\telse\n\t\t\t\tstbc_tx = (mac->ht_cur_stbc &\n\t\t\t\t\t   STBC_HT_ENABLE_TX) ? 1 : 0;\n\t\t\th2c_parameter[3] |= stbc_tx << 1;\n\t\t}\n\t\th2c_parameter[2] =\n\t\t\t(u8)(rtlpriv->dm.undec_sm_pwdb & 0xFF);\n\t\th2c_parameter[1] = 0x20;\n\t\th2c_parameter[0] = 0;\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)\n\t\t\trtl8821ae_fill_h2c_cmd(hw, H2C_RSSI_21AE_REPORT, 4,\n\t\t\t\t\t       h2c_parameter);\n\t\telse\n\t\t\trtl8821ae_fill_h2c_cmd(hw, H2C_RSSI_21AE_REPORT, 3,\n\t\t\t\t\t       h2c_parameter);\n\t} else {\n\t\trtl_write_byte(rtlpriv, 0x4fe, rtlpriv->dm.undec_sm_pwdb);\n\t}\n\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)\n\t\trtl8812ae_dm_rssi_dump_to_register(hw);\n\trtl8821ae_dm_find_minimum_rssi(hw);\n\tdm_digtable->rssi_val_min = rtlpriv->dm_digtable.min_undec_pwdb_for_dm;\n}\n\nvoid rtl8821ae_dm_write_cck_cca_thres(struct ieee80211_hw *hw, u8 current_cca)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\n\n\tif (dm_digtable->cur_cck_cca_thres != current_cca)\n\t\trtl_write_byte(rtlpriv, DM_REG_CCK_CCA_11AC, current_cca);\n\n\tdm_digtable->pre_cck_cca_thres = dm_digtable->cur_cck_cca_thres;\n\tdm_digtable->cur_cck_cca_thres = current_cca;\n}\n\nvoid rtl8821ae_dm_write_dig(struct ieee80211_hw *hw, u8 current_igi)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\n\n\tif (dm_digtable->stop_dig)\n\t\treturn;\n\n\tif (dm_digtable->cur_igvalue != current_igi) {\n\t\trtl_set_bbreg(hw, DM_REG_IGI_A_11AC,\n\t\t\t      DM_BIT_IGI_11AC, current_igi);\n\t\tif (rtlpriv->phy.rf_type != RF_1T1R)\n\t\t\trtl_set_bbreg(hw, DM_REG_IGI_B_11AC,\n\t\t\t\t      DM_BIT_IGI_11AC, current_igi);\n\t}\n\tdm_digtable->cur_igvalue = current_igi;\n}\n\nstatic void rtl8821ae_dm_dig(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tu8 dig_min_0;\n\tu8 dig_max_of_min;\n\tbool first_connect, first_disconnect;\n\tu8 dm_dig_max, dm_dig_min, offset;\n\tu8 current_igi = dm_digtable->cur_igvalue;\n\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD, \"\\n\");\n\n\tif (mac->act_scanning) {\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\"Return: In Scan Progress\\n\");\n\t\treturn;\n\t}\n\n\t \n\tdig_min_0 = dm_digtable->dig_min_0;\n\tfirst_connect = (mac->link_state >= MAC80211_LINKED) &&\n\t\t\t(!dm_digtable->media_connect_0);\n\tfirst_disconnect = (mac->link_state < MAC80211_LINKED) &&\n\t\t\t(dm_digtable->media_connect_0);\n\n\t \n\n\tdm_dig_max = 0x5A;\n\n\tif (rtlhal->hw_type != HARDWARE_TYPE_RTL8821AE)\n\t\tdm_dig_min = DM_DIG_MIN;\n\telse\n\t\tdm_dig_min = 0x1C;\n\n\tdig_max_of_min = DM_DIG_MAX_AP;\n\n\tif (mac->link_state >= MAC80211_LINKED) {\n\t\tif (rtlhal->hw_type != HARDWARE_TYPE_RTL8821AE)\n\t\t\toffset = 20;\n\t\telse\n\t\t\toffset = 10;\n\n\t\tif ((dm_digtable->rssi_val_min + offset) > dm_dig_max)\n\t\t\tdm_digtable->rx_gain_max = dm_dig_max;\n\t\telse if ((dm_digtable->rssi_val_min + offset) < dm_dig_min)\n\t\t\tdm_digtable->rx_gain_max = dm_dig_min;\n\t\telse\n\t\t\tdm_digtable->rx_gain_max =\n\t\t\t\tdm_digtable->rssi_val_min + offset;\n\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\"dm_digtable->rssi_val_min=0x%x,dm_digtable->rx_gain_max = 0x%x\\n\",\n\t\t\tdm_digtable->rssi_val_min,\n\t\t\tdm_digtable->rx_gain_max);\n\t\tif (rtlpriv->dm.one_entry_only) {\n\t\t\toffset = 0;\n\n\t\t\tif (dm_digtable->rssi_val_min - offset < dm_dig_min)\n\t\t\t\tdig_min_0 = dm_dig_min;\n\t\t\telse if (dm_digtable->rssi_val_min -\n\t\t\t\toffset > dig_max_of_min)\n\t\t\t\tdig_min_0 = dig_max_of_min;\n\t\t\telse\n\t\t\t\tdig_min_0 =\n\t\t\t\t\tdm_digtable->rssi_val_min - offset;\n\n\t\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\t\"bOneEntryOnly=TRUE, dig_min_0=0x%x\\n\",\n\t\t\t\tdig_min_0);\n\t\t} else {\n\t\t\tdig_min_0 = dm_dig_min;\n\t\t}\n\t} else {\n\t\tdm_digtable->rx_gain_max = dm_dig_max;\n\t\tdig_min_0 = dm_dig_min;\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD, \"No Link\\n\");\n\t}\n\n\tif (rtlpriv->falsealm_cnt.cnt_all > 10000) {\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\"Abnormally false alarm case.\\n\");\n\n\t\tif (dm_digtable->large_fa_hit != 3)\n\t\t\tdm_digtable->large_fa_hit++;\n\t\tif (dm_digtable->forbidden_igi < current_igi) {\n\t\t\tdm_digtable->forbidden_igi = current_igi;\n\t\t\tdm_digtable->large_fa_hit = 1;\n\t\t}\n\n\t\tif (dm_digtable->large_fa_hit >= 3) {\n\t\t\tif ((dm_digtable->forbidden_igi + 1) >\n\t\t\t\tdm_digtable->rx_gain_max)\n\t\t\t\tdm_digtable->rx_gain_min =\n\t\t\t\t\tdm_digtable->rx_gain_max;\n\t\t\telse\n\t\t\t\tdm_digtable->rx_gain_min =\n\t\t\t\t\t(dm_digtable->forbidden_igi + 1);\n\t\t\tdm_digtable->recover_cnt = 3600;\n\t\t}\n\t} else {\n\t\t \n\t\tif (dm_digtable->recover_cnt != 0) {\n\t\t\tdm_digtable->recover_cnt--;\n\t\t} else {\n\t\t\tif (dm_digtable->large_fa_hit < 3) {\n\t\t\t\tif ((dm_digtable->forbidden_igi - 1) <\n\t\t\t\t    dig_min_0) {\n\t\t\t\t\tdm_digtable->forbidden_igi =\n\t\t\t\t\t\tdig_min_0;\n\t\t\t\t\tdm_digtable->rx_gain_min =\n\t\t\t\t\t\tdig_min_0;\n\t\t\t\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\t\t\t\"Normal Case: At Lower Bound\\n\");\n\t\t\t\t} else {\n\t\t\t\t\tdm_digtable->forbidden_igi--;\n\t\t\t\t\tdm_digtable->rx_gain_min =\n\t\t\t\t\t  (dm_digtable->forbidden_igi + 1);\n\t\t\t\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\t\t\t\"Normal Case: Approach Lower Bound\\n\");\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tdm_digtable->large_fa_hit = 0;\n\t\t\t}\n\t\t}\n\t}\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\"pDM_DigTable->LargeFAHit=%d\\n\",\n\t\tdm_digtable->large_fa_hit);\n\n\tif (rtlpriv->dm.dbginfo.num_qry_beacon_pkt < 10)\n\t\tdm_digtable->rx_gain_min = dm_dig_min;\n\n\tif (dm_digtable->rx_gain_min > dm_digtable->rx_gain_max)\n\t\tdm_digtable->rx_gain_min = dm_digtable->rx_gain_max;\n\n\t \n\tif (mac->link_state >= MAC80211_LINKED) {\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\"DIG AfterLink\\n\");\n\t\tif (first_connect) {\n\t\t\tif (dm_digtable->rssi_val_min <= dig_max_of_min)\n\t\t\t\tcurrent_igi = dm_digtable->rssi_val_min;\n\t\t\telse\n\t\t\t\tcurrent_igi = dig_max_of_min;\n\t\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\t\"First Connect\\n\");\n\t\t} else {\n\t\t\tif (rtlpriv->falsealm_cnt.cnt_all > DM_DIG_FA_TH2)\n\t\t\t\tcurrent_igi = current_igi + 4;\n\t\t\telse if (rtlpriv->falsealm_cnt.cnt_all > DM_DIG_FA_TH1)\n\t\t\t\tcurrent_igi = current_igi + 2;\n\t\t\telse if (rtlpriv->falsealm_cnt.cnt_all < DM_DIG_FA_TH0)\n\t\t\t\tcurrent_igi = current_igi - 2;\n\n\t\t\tif ((rtlpriv->dm.dbginfo.num_qry_beacon_pkt < 10) &&\n\t\t\t    (rtlpriv->falsealm_cnt.cnt_all < DM_DIG_FA_TH1)) {\n\t\t\t\tcurrent_igi = dm_digtable->rx_gain_min;\n\t\t\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\t\t\"Beacon is less than 10 and FA is less than 768, IGI GOES TO 0x1E!!!!!!!!!!!!\\n\");\n\t\t\t}\n\t\t}\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\"DIG BeforeLink\\n\");\n\t\tif (first_disconnect) {\n\t\t\tcurrent_igi = dm_digtable->rx_gain_min;\n\t\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\t\"First DisConnect\\n\");\n\t\t} else {\n\t\t\t \n\t\t\tif (rtlpriv->falsealm_cnt.cnt_all > 2000)\n\t\t\t\tcurrent_igi = current_igi + 4;\n\t\t\telse if (rtlpriv->falsealm_cnt.cnt_all > 600)\n\t\t\t\tcurrent_igi = current_igi + 2;\n\t\t\telse if (rtlpriv->falsealm_cnt.cnt_all < 300)\n\t\t\t\tcurrent_igi = current_igi - 2;\n\n\t\t\tif (current_igi >= 0x3e)\n\t\t\t\tcurrent_igi = 0x3e;\n\n\t\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD, \"England DIG\\n\");\n\t\t}\n\t}\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\"DIG End Adjust IGI\\n\");\n\t \n\n\tif (current_igi > dm_digtable->rx_gain_max)\n\t\tcurrent_igi = dm_digtable->rx_gain_max;\n\tif (current_igi < dm_digtable->rx_gain_min)\n\t\tcurrent_igi = dm_digtable->rx_gain_min;\n\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\"rx_gain_max=0x%x, rx_gain_min=0x%x\\n\",\n\t\tdm_digtable->rx_gain_max, dm_digtable->rx_gain_min);\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\"TotalFA=%d\\n\", rtlpriv->falsealm_cnt.cnt_all);\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\"CurIGValue=0x%x\\n\", current_igi);\n\n\trtl8821ae_dm_write_dig(hw, current_igi);\n\tdm_digtable->media_connect_0 =\n\t\t((mac->link_state >= MAC80211_LINKED) ? true : false);\n\tdm_digtable->dig_min_0 = dig_min_0;\n}\n\nstatic void rtl8821ae_dm_common_info_self_update(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 cnt = 0;\n\tstruct rtl_sta_info *drv_priv;\n\n\trtlpriv->dm.tx_rate = 0xff;\n\n\trtlpriv->dm.one_entry_only = false;\n\n\tif (rtlpriv->mac80211.opmode == NL80211_IFTYPE_STATION &&\n\t    rtlpriv->mac80211.link_state >= MAC80211_LINKED) {\n\t\trtlpriv->dm.one_entry_only = true;\n\t\treturn;\n\t}\n\n\tif (rtlpriv->mac80211.opmode == NL80211_IFTYPE_AP ||\n\t    rtlpriv->mac80211.opmode == NL80211_IFTYPE_ADHOC ||\n\t    rtlpriv->mac80211.opmode == NL80211_IFTYPE_MESH_POINT) {\n\t\tspin_lock_bh(&rtlpriv->locks.entry_list_lock);\n\t\tlist_for_each_entry(drv_priv, &rtlpriv->entry_list, list)\n\t\t\tcnt++;\n\t\tspin_unlock_bh(&rtlpriv->locks.entry_list_lock);\n\n\t\tif (cnt == 1)\n\t\t\trtlpriv->dm.one_entry_only = true;\n\t}\n}\n\nstatic void rtl8821ae_dm_false_alarm_counter_statistics(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct false_alarm_statistics *falsealm_cnt = &rtlpriv->falsealm_cnt;\n\tu32 cck_enable = 0;\n\n\t \n\tfalsealm_cnt->cnt_ofdm_fail =\n\t\trtl_get_bbreg(hw, ODM_REG_OFDM_FA_11AC, BMASKLWORD);\n\tfalsealm_cnt->cnt_cck_fail =\n\t\trtl_get_bbreg(hw, ODM_REG_CCK_FA_11AC, BMASKLWORD);\n\n\tcck_enable =  rtl_get_bbreg(hw, ODM_REG_BB_RX_PATH_11AC, BIT(28));\n\tif (cck_enable)   \n\t\tfalsealm_cnt->cnt_all = falsealm_cnt->cnt_ofdm_fail +\n\t\t\t\t\tfalsealm_cnt->cnt_cck_fail;\n\telse\n\t\tfalsealm_cnt->cnt_all = falsealm_cnt->cnt_ofdm_fail;\n\n\t \n\trtl_set_bbreg(hw, ODM_REG_OFDM_FA_RST_11AC, BIT(17), 1);\n\trtl_set_bbreg(hw, ODM_REG_OFDM_FA_RST_11AC, BIT(17), 0);\n\t \n\trtl_set_bbreg(hw, ODM_REG_CCK_FA_RST_11AC, BIT(15), 0);\n\trtl_set_bbreg(hw, ODM_REG_CCK_FA_RST_11AC, BIT(15), 1);\n\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD, \"Cnt_Cck_fail=%d\\n\",\n\t\tfalsealm_cnt->cnt_cck_fail);\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD, \"cnt_ofdm_fail=%d\\n\",\n\t\tfalsealm_cnt->cnt_ofdm_fail);\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD, \"Total False Alarm=%d\\n\",\n\t\tfalsealm_cnt->cnt_all);\n}\n\nstatic void rtl8812ae_dm_check_txpower_tracking_thermalmeter(\n\t\tstruct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\tif (!rtlpriv->dm.tm_trigger) {\n\t\trtl_set_rfreg(hw, RF90_PATH_A, RF_T_METER_88E,\n\t\t\t      BIT(17) | BIT(16), 0x03);\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"Trigger 8812 Thermal Meter!!\\n\");\n\t\trtlpriv->dm.tm_trigger = 1;\n\t\treturn;\n\t}\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"Schedule TxPowerTracking direct call!!\\n\");\n\trtl8812ae_dm_txpower_tracking_callback_thermalmeter(hw);\n}\n\nstatic void rtl8821ae_dm_iq_calibrate(struct ieee80211_hw *hw)\n{\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\n\tif (mac->link_state >= MAC80211_LINKED) {\n\t\tif (rtldm->linked_interval < 3)\n\t\t\trtldm->linked_interval++;\n\n\t\tif (rtldm->linked_interval == 2) {\n\t\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)\n\t\t\t\trtl8812ae_phy_iq_calibrate(hw, false);\n\t\t\telse\n\t\t\t\trtl8821ae_phy_iq_calibrate(hw, false);\n\t\t}\n\t} else {\n\t\trtldm->linked_interval = 0;\n\t}\n}\n\nstatic void rtl8812ae_get_delta_swing_table(struct ieee80211_hw *hw,\n\t\t\t\t\t    const u8 **up_a,\n\t\t\t\t\t    const u8 **down_a,\n\t\t\t\t\t    const u8 **up_b,\n\t\t\t\t\t    const u8 **down_b)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\n\tu8 channel = rtlphy->current_channel;\n\tu8 rate = rtldm->tx_rate;\n\n\tif (1 <= channel && channel <= 14) {\n\t\tif (RTL8821AE_RX_HAL_IS_CCK_RATE(rate)) {\n\t\t\t*up_a = rtl8812ae_delta_swing_table_idx_24gccka_p;\n\t\t\t*down_a = rtl8812ae_delta_swing_table_idx_24gccka_n;\n\t\t\t*up_b = rtl8812ae_delta_swing_table_idx_24gcckb_p;\n\t\t\t*down_b = rtl8812ae_delta_swing_table_idx_24gcckb_n;\n\t\t} else {\n\t\t\t*up_a = rtl8812ae_delta_swing_table_idx_24ga_p;\n\t\t\t*down_a = rtl8812ae_delta_swing_table_idx_24ga_n;\n\t\t\t*up_b = rtl8812ae_delta_swing_table_idx_24gb_p;\n\t\t\t*down_b = rtl8812ae_delta_swing_table_idx_24gb_n;\n\t\t}\n\t} else if (36 <= channel && channel <= 64) {\n\t\t*up_a = rtl8812ae_delta_swing_table_idx_5ga_p[0];\n\t\t*down_a = rtl8812ae_delta_swing_table_idx_5ga_n[0];\n\t\t*up_b = rtl8812ae_delta_swing_table_idx_5gb_p[0];\n\t\t*down_b = rtl8812ae_delta_swing_table_idx_5gb_n[0];\n\t} else if (100 <= channel && channel <= 140) {\n\t\t*up_a = rtl8812ae_delta_swing_table_idx_5ga_p[1];\n\t\t*down_a = rtl8812ae_delta_swing_table_idx_5ga_n[1];\n\t\t*up_b = rtl8812ae_delta_swing_table_idx_5gb_p[1];\n\t\t*down_b = rtl8812ae_delta_swing_table_idx_5gb_n[1];\n\t} else if (149 <= channel && channel <= 173) {\n\t\t*up_a = rtl8812ae_delta_swing_table_idx_5ga_p[2];\n\t\t*down_a = rtl8812ae_delta_swing_table_idx_5ga_n[2];\n\t\t*up_b = rtl8812ae_delta_swing_table_idx_5gb_p[2];\n\t\t*down_b = rtl8812ae_delta_swing_table_idx_5gb_n[2];\n\t} else {\n\t\t*up_a = rtl8818e_delta_swing_table_idx_24gb_p;\n\t\t*down_a = rtl8818e_delta_swing_table_idx_24gb_n;\n\t\t*up_b = rtl8818e_delta_swing_table_idx_24gb_p;\n\t\t*down_b = rtl8818e_delta_swing_table_idx_24gb_n;\n\t}\n}\n\nvoid rtl8821ae_dm_update_init_rate(struct ieee80211_hw *hw, u8 rate)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_dm\t*rtldm = rtl_dm(rtl_priv(hw));\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tu8 p = 0;\n\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"Get C2H Command! Rate=0x%x\\n\", rate);\n\n\trtldm->tx_rate = rate;\n\n\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) {\n\t\trtl8821ae_dm_txpwr_track_set_pwr(hw, MIX_MODE, RF90_PATH_A, 0);\n\t} else {\n\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++)\n\t\t\trtl8812ae_dm_txpwr_track_set_pwr(hw, MIX_MODE, p, 0);\n\t}\n}\n\nu8 rtl8821ae_hw_rate_to_mrate(struct ieee80211_hw *hw, u8 rate)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 ret_rate = MGN_1M;\n\n\tswitch (rate) {\n\tcase DESC_RATE1M:\n\t\tret_rate = MGN_1M;\n\t\tbreak;\n\tcase DESC_RATE2M:\n\t\tret_rate = MGN_2M;\n\t\tbreak;\n\tcase DESC_RATE5_5M:\n\t\tret_rate = MGN_5_5M;\n\t\tbreak;\n\tcase DESC_RATE11M:\n\t\tret_rate = MGN_11M;\n\t\tbreak;\n\tcase DESC_RATE6M:\n\t\tret_rate = MGN_6M;\n\t\tbreak;\n\tcase DESC_RATE9M:\n\t\tret_rate = MGN_9M;\n\t\tbreak;\n\tcase DESC_RATE12M:\n\t\tret_rate = MGN_12M;\n\t\tbreak;\n\tcase DESC_RATE18M:\n\t\tret_rate = MGN_18M;\n\t\tbreak;\n\tcase DESC_RATE24M:\n\t\tret_rate = MGN_24M;\n\t\tbreak;\n\tcase DESC_RATE36M:\n\t\tret_rate = MGN_36M;\n\t\tbreak;\n\tcase DESC_RATE48M:\n\t\tret_rate = MGN_48M;\n\t\tbreak;\n\tcase DESC_RATE54M:\n\t\tret_rate = MGN_54M;\n\t\tbreak;\n\tcase DESC_RATEMCS0:\n\t\tret_rate = MGN_MCS0;\n\t\tbreak;\n\tcase DESC_RATEMCS1:\n\t\tret_rate = MGN_MCS1;\n\t\tbreak;\n\tcase DESC_RATEMCS2:\n\t\tret_rate = MGN_MCS2;\n\t\tbreak;\n\tcase DESC_RATEMCS3:\n\t\tret_rate = MGN_MCS3;\n\t\tbreak;\n\tcase DESC_RATEMCS4:\n\t\tret_rate = MGN_MCS4;\n\t\tbreak;\n\tcase DESC_RATEMCS5:\n\t\tret_rate = MGN_MCS5;\n\t\tbreak;\n\tcase DESC_RATEMCS6:\n\t\tret_rate = MGN_MCS6;\n\t\tbreak;\n\tcase DESC_RATEMCS7:\n\t\tret_rate = MGN_MCS7;\n\t\tbreak;\n\tcase DESC_RATEMCS8:\n\t\tret_rate = MGN_MCS8;\n\t\tbreak;\n\tcase DESC_RATEMCS9:\n\t\tret_rate = MGN_MCS9;\n\t\tbreak;\n\tcase DESC_RATEMCS10:\n\t\tret_rate = MGN_MCS10;\n\t\tbreak;\n\tcase DESC_RATEMCS11:\n\t\tret_rate = MGN_MCS11;\n\t\tbreak;\n\tcase DESC_RATEMCS12:\n\t\tret_rate = MGN_MCS12;\n\t\tbreak;\n\tcase DESC_RATEMCS13:\n\t\tret_rate = MGN_MCS13;\n\t\tbreak;\n\tcase DESC_RATEMCS14:\n\t\tret_rate = MGN_MCS14;\n\t\tbreak;\n\tcase DESC_RATEMCS15:\n\t\tret_rate = MGN_MCS15;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS0:\n\t\tret_rate = MGN_VHT1SS_MCS0;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS1:\n\t\tret_rate = MGN_VHT1SS_MCS1;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS2:\n\t\tret_rate = MGN_VHT1SS_MCS2;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS3:\n\t\tret_rate = MGN_VHT1SS_MCS3;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS4:\n\t\tret_rate = MGN_VHT1SS_MCS4;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS5:\n\t\tret_rate = MGN_VHT1SS_MCS5;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS6:\n\t\tret_rate = MGN_VHT1SS_MCS6;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS7:\n\t\tret_rate = MGN_VHT1SS_MCS7;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS8:\n\t\tret_rate = MGN_VHT1SS_MCS8;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS9:\n\t\tret_rate = MGN_VHT1SS_MCS9;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS0:\n\t\tret_rate = MGN_VHT2SS_MCS0;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS1:\n\t\tret_rate = MGN_VHT2SS_MCS1;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS2:\n\t\tret_rate = MGN_VHT2SS_MCS2;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS3:\n\t\tret_rate = MGN_VHT2SS_MCS3;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS4:\n\t\tret_rate = MGN_VHT2SS_MCS4;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS5:\n\t\tret_rate = MGN_VHT2SS_MCS5;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS6:\n\t\tret_rate = MGN_VHT2SS_MCS6;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS7:\n\t\tret_rate = MGN_VHT2SS_MCS7;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS8:\n\t\tret_rate = MGN_VHT2SS_MCS8;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS9:\n\t\tret_rate = MGN_VHT2SS_MCS9;\n\t\tbreak;\n\tdefault:\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"HwRateToMRate8812(): Non supported Rate [%x]!!!\\n\",\n\t\t\trate);\n\t\tbreak;\n\t}\n\treturn ret_rate;\n}\n\n \nvoid rtl8812ae_dm_txpwr_track_set_pwr(struct ieee80211_hw *hw,\n\t\t\t\t      enum pwr_track_control_method method,\n\t\t\t\t      u8 rf_path, u8 channel_mapped_index)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_dm\t*rtldm = rtl_dm(rtl_priv(hw));\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu32 final_swing_idx[2];\n\tu8 pwr_tracking_limit = 26;  \n\tu8 tx_rate = 0xFF;\n\ts8 final_ofdm_swing_index = 0;\n\n\tif (rtldm->tx_rate != 0xFF)\n\t\ttx_rate =\n\t\t\trtl8821ae_hw_rate_to_mrate(hw, rtldm->tx_rate);\n\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"===>%s\\n\", __func__);\n\t \n\tif (tx_rate != 0xFF) {\n\t\t \n\t\tif ((tx_rate >= MGN_1M) && (tx_rate <= MGN_11M))\n\t\t\tpwr_tracking_limit = 32;  \n\t\t \n\t\telse if ((tx_rate >= MGN_6M) && (tx_rate <= MGN_48M))\n\t\t\tpwr_tracking_limit = 30;  \n\t\telse if (tx_rate == MGN_54M)\n\t\t\tpwr_tracking_limit = 28;  \n\t\t \n\t\t  \n\t\telse if ((tx_rate >= MGN_MCS0) && (tx_rate <= MGN_MCS2))\n\t\t\tpwr_tracking_limit = 34;  \n\t\t  \n\t\telse if ((tx_rate >= MGN_MCS3) && (tx_rate <= MGN_MCS4))\n\t\t\tpwr_tracking_limit = 30;  \n\t\t  \n\t\telse if ((tx_rate >= MGN_MCS5) && (tx_rate <= MGN_MCS7))\n\t\t\tpwr_tracking_limit = 28;  \n\t\t  \n\t\telse if ((tx_rate >= MGN_MCS8) && (tx_rate <= MGN_MCS10))\n\t\t\tpwr_tracking_limit = 34;  \n\t\t  \n\t\telse if ((tx_rate >= MGN_MCS11) && (tx_rate <= MGN_MCS12))\n\t\t\tpwr_tracking_limit = 30;  \n\t\t  \n\t\telse if ((tx_rate >= MGN_MCS13) && (tx_rate <= MGN_MCS15))\n\t\t\tpwr_tracking_limit = 28;  \n\n\t\t \n\t\t  \n\t\telse if ((tx_rate >= MGN_VHT1SS_MCS0) &&\n\t\t\t (tx_rate <= MGN_VHT1SS_MCS2))\n\t\t\tpwr_tracking_limit = 34;  \n\t\t  \n\t\telse if ((tx_rate >= MGN_VHT1SS_MCS3) &&\n\t\t\t (tx_rate <= MGN_VHT1SS_MCS4))\n\t\t\tpwr_tracking_limit = 30;  \n\t\t  \n\t\telse if ((tx_rate >= MGN_VHT1SS_MCS5) &&\n\t\t\t (tx_rate <= MGN_VHT1SS_MCS6))\n\t\t\tpwr_tracking_limit = 28;  \n\t\telse if (tx_rate == MGN_VHT1SS_MCS7)  \n\t\t\tpwr_tracking_limit = 26;  \n\t\telse if (tx_rate == MGN_VHT1SS_MCS8)  \n\t\t\tpwr_tracking_limit = 24;  \n\t\telse if (tx_rate == MGN_VHT1SS_MCS9)  \n\t\t\tpwr_tracking_limit = 22;  \n\t\t  \n\t\telse if ((tx_rate >= MGN_VHT2SS_MCS0) &&\n\t\t\t (tx_rate <= MGN_VHT2SS_MCS2))\n\t\t\tpwr_tracking_limit = 34;  \n\t\t  \n\t\telse if ((tx_rate >= MGN_VHT2SS_MCS3) &&\n\t\t\t (tx_rate <= MGN_VHT2SS_MCS4))\n\t\t\tpwr_tracking_limit = 30;  \n\t\t  \n\t\telse if ((tx_rate >= MGN_VHT2SS_MCS5) &&\n\t\t\t (tx_rate <= MGN_VHT2SS_MCS6))\n\t\t\tpwr_tracking_limit = 28;  \n\t\telse if (tx_rate == MGN_VHT2SS_MCS7)  \n\t\t\tpwr_tracking_limit = 26;  \n\t\telse if (tx_rate == MGN_VHT2SS_MCS8)  \n\t\t\tpwr_tracking_limit = 24;  \n\t\telse if (tx_rate == MGN_VHT2SS_MCS9)  \n\t\t\tpwr_tracking_limit = 22;  \n\t\telse\n\t\t\tpwr_tracking_limit = 24;\n\t}\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"TxRate=0x%x, PwrTrackingLimit=%d\\n\",\n\t\ttx_rate, pwr_tracking_limit);\n\n\tif (method == BBSWING) {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"===>%s\\n\", __func__);\n\n\t\tif (rf_path == RF90_PATH_A) {\n\t\t\tu32 tmp;\n\n\t\t\tfinal_swing_idx[RF90_PATH_A] =\n\t\t\t\t(rtldm->ofdm_index[RF90_PATH_A] >\n\t\t\t\tpwr_tracking_limit) ?\n\t\t\t\tpwr_tracking_limit :\n\t\t\t\trtldm->ofdm_index[RF90_PATH_A];\n\t\t\ttmp = final_swing_idx[RF90_PATH_A];\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"pDM_Odm->RFCalibrateInfo.OFDM_index[ODM_RF_PATH_A]=%d,pDM_Odm->RealBbSwingIdx[ODM_RF_PATH_A]=%d\\n\",\n\t\t\t\trtldm->ofdm_index[RF90_PATH_A],\n\t\t\t\tfinal_swing_idx[RF90_PATH_A]);\n\n\t\t\trtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\n\t\t\t\t      txscaling_tbl[tmp]);\n\t\t} else {\n\t\t\tu32 tmp;\n\n\t\t\tfinal_swing_idx[RF90_PATH_B] =\n\t\t\t\trtldm->ofdm_index[RF90_PATH_B] >\n\t\t\t\tpwr_tracking_limit ?\n\t\t\t\tpwr_tracking_limit :\n\t\t\t\trtldm->ofdm_index[RF90_PATH_B];\n\t\t\ttmp = final_swing_idx[RF90_PATH_B];\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"pDM_Odm->RFCalibrateInfo.OFDM_index[ODM_RF_PATH_B]=%d, pDM_Odm->RealBbSwingIdx[ODM_RF_PATH_B]=%d\\n\",\n\t\t\t\trtldm->ofdm_index[RF90_PATH_B],\n\t\t\t\tfinal_swing_idx[RF90_PATH_B]);\n\n\t\t\trtl_set_bbreg(hw, RB_TXSCALE, 0xFFE00000,\n\t\t\t\t      txscaling_tbl[tmp]);\n\t\t}\n\t} else if (method == MIX_MODE) {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"pDM_Odm->DefaultOfdmIndex=%d, pDM_Odm->Absolute_OFDMSwingIdx[RFPath]=%d, RF_Path = %d\\n\",\n\t\t\trtldm->default_ofdm_index,\n\t\t\trtldm->absolute_ofdm_swing_idx[rf_path],\n\t\t\trf_path);\n\n\t\tfinal_ofdm_swing_index = rtldm->default_ofdm_index +\n\t\t\t\trtldm->absolute_ofdm_swing_idx[rf_path];\n\n\t\tif (rf_path == RF90_PATH_A) {\n\t\t\t \n\t\t\tif (final_ofdm_swing_index > pwr_tracking_limit) {\n\t\t\t\trtldm->remnant_cck_idx =\n\t\t\t\t\tfinal_ofdm_swing_index -\n\t\t\t\t\tpwr_tracking_limit;\n\t\t\t\t \n\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path] =\n\t\t\t\t\tfinal_ofdm_swing_index -\n\t\t\t\t\tpwr_tracking_limit;\n\n\t\t\t\trtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\n\t\t\t\t\t      txscaling_tbl[pwr_tracking_limit]);\n\n\t\t\t\trtldm->modify_txagc_flag_path_a = true;\n\n\t\t\t\t \n\t\t\t\trtl8821ae_phy_set_txpower_level_by_path(hw,\n\t\t\t\t\trtlphy->current_channel,\n\t\t\t\t\tRF90_PATH_A);\n\n\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\t\"******Path_A Over BBSwing Limit ,PwrTrackingLimit = %d ,Remnant TxAGC Value = %d\\n\",\n\t\t\t\t\tpwr_tracking_limit,\n\t\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path]);\n\t\t\t} else if (final_ofdm_swing_index < 0) {\n\t\t\t\trtldm->remnant_cck_idx = final_ofdm_swing_index;\n\t\t\t\t \n\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path] =\n\t\t\t\t\tfinal_ofdm_swing_index;\n\n\t\t\t\trtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\n\t\t\t\t\ttxscaling_tbl[0]);\n\n\t\t\t\trtldm->modify_txagc_flag_path_a = true;\n\n\t\t\t\t \n\t\t\t\trtl8821ae_phy_set_txpower_level_by_path(hw,\n\t\t\t\t\trtlphy->current_channel, RF90_PATH_A);\n\n\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\t\"******Path_A Lower then BBSwing lower bound  0 , Remnant TxAGC Value = %d\\n\",\n\t\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path]);\n\t\t\t} else {\n\t\t\t\trtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\n\t\t\t\t\ttxscaling_tbl[(u8)final_ofdm_swing_index]);\n\n\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\t\"******Path_A Compensate with BBSwing, Final_OFDM_Swing_Index = %d\\n\",\n\t\t\t\t\tfinal_ofdm_swing_index);\n\t\t\t\t \n\t\t\t\tif (rtldm->modify_txagc_flag_path_a) {\n\t\t\t\t\trtldm->remnant_cck_idx = 0;\n\t\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path] = 0;\n\n\t\t\t\t\t \n\t\t\t\t\trtl8821ae_phy_set_txpower_level_by_path(hw,\n\t\t\t\t\t\trtlphy->current_channel, RF90_PATH_A);\n\t\t\t\t\trtldm->modify_txagc_flag_path_a = false;\n\n\t\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING,\n\t\t\t\t\t\tDBG_LOUD,\n\t\t\t\t\t\t\"******Path_A pDM_Odm->Modify_TxAGC_Flag = FALSE\\n\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t \n\t\tif (rf_path == RF90_PATH_B) {\n\t\t\tif (final_ofdm_swing_index > pwr_tracking_limit) {\n\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path] =\n\t\t\t\t\tfinal_ofdm_swing_index -\n\t\t\t\t\tpwr_tracking_limit;\n\n\t\t\t\trtl_set_bbreg(hw, RB_TXSCALE,\n\t\t\t\t\t0xFFE00000,\n\t\t\t\t\ttxscaling_tbl[pwr_tracking_limit]);\n\n\t\t\t\trtldm->modify_txagc_flag_path_b = true;\n\n\t\t\t\t \n\t\t\t\trtl8821ae_phy_set_txpower_level_by_path(hw,\n\t\t\t\t\trtlphy->current_channel, RF90_PATH_B);\n\n\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\t\"******Path_B Over BBSwing Limit , PwrTrackingLimit = %d , Remnant TxAGC Value = %d\\n\",\n\t\t\t\t\tpwr_tracking_limit,\n\t\t\t\t\t rtldm->remnant_ofdm_swing_idx[rf_path]);\n\t\t\t} else if (final_ofdm_swing_index < 0) {\n\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path] =\n\t\t\t\t\tfinal_ofdm_swing_index;\n\n\t\t\t\trtl_set_bbreg(hw, RB_TXSCALE, 0xFFE00000,\n\t\t\t\t\t      txscaling_tbl[0]);\n\n\t\t\t\trtldm->modify_txagc_flag_path_b = true;\n\n\t\t\t\t \n\t\t\t\trtl8821ae_phy_set_txpower_level_by_path(hw,\n\t\t\t\t\trtlphy->current_channel, RF90_PATH_B);\n\n\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\t\"******Path_B Lower then BBSwing lower bound  0 , Remnant TxAGC Value = %d\\n\",\n\t\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path]);\n\t\t\t} else {\n\t\t\t\trtl_set_bbreg(hw, RB_TXSCALE, 0xFFE00000,\n\t\t\t\t\ttxscaling_tbl[(u8)final_ofdm_swing_index]);\n\n\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\t\"******Path_B Compensate with BBSwing ,Final_OFDM_Swing_Index = %d\\n\",\n\t\t\t\t\tfinal_ofdm_swing_index);\n\t\t\t\t  \n\t\t\t\tif (rtldm->modify_txagc_flag_path_b) {\n\t\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path] = 0;\n\n\t\t\t\t\t \n\t\t\t\t\trtl8821ae_phy_set_txpower_level_by_path(hw,\n\t\t\t\t\trtlphy->current_channel, RF90_PATH_B);\n\n\t\t\t\t\trtldm->modify_txagc_flag_path_b =\n\t\t\t\t\t\tfalse;\n\n\t\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\t\t\"******Path_B pDM_Odm->Modify_TxAGC_Flag = FALSE\\n\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\treturn;\n\t}\n}\n\nvoid rtl8812ae_dm_txpower_tracking_callback_thermalmeter(\n\tstruct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\n\tstruct rtl_dm\t*rtldm = rtl_dm(rtl_priv(hw));\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tu8 thermal_value = 0, delta, delta_lck, delta_iqk, p = 0, i = 0;\n\tu8 thermal_value_avg_count = 0;\n\tu32 thermal_value_avg = 0;\n\t \n\tu8 ofdm_min_index = 6;\n\t  \n\tu8 index_for_channel = 0;\n\t \n\tconst u8 *delta_swing_table_idx_tup_a;\n\tconst u8 *delta_swing_table_idx_tdown_a;\n\tconst u8 *delta_swing_table_idx_tup_b;\n\tconst u8 *delta_swing_table_idx_tdown_b;\n\n\t \n\trtl8812ae_get_delta_swing_table(hw,\n\t\t&delta_swing_table_idx_tup_a,\n\t\t&delta_swing_table_idx_tdown_a,\n\t\t&delta_swing_table_idx_tup_b,\n\t\t&delta_swing_table_idx_tdown_b);\n\n\trtldm->txpower_trackinginit = true;\n\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"pDM_Odm->BbSwingIdxCckBase: %d, pDM_Odm->BbSwingIdxOfdmBase[A]:%d, pDM_Odm->DefaultOfdmIndex: %d\\n\",\n\t\trtldm->swing_idx_cck_base,\n\t\trtldm->swing_idx_ofdm_base[RF90_PATH_A],\n\t\trtldm->default_ofdm_index);\n\n\tthermal_value = (u8)rtl_get_rfreg(hw, RF90_PATH_A,\n\t\t \n\t\tRF_T_METER_8812A, 0xfc00);\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"Thermal Meter = 0x%X, EFUSE Thermal Base = 0x%X\\n\",\n\t\tthermal_value, rtlefuse->eeprom_thermalmeter);\n\tif (!rtldm->txpower_track_control ||\n\t    rtlefuse->eeprom_thermalmeter == 0 ||\n\t    rtlefuse->eeprom_thermalmeter == 0xFF)\n\t\treturn;\n\n\t \n\n\tif (rtlhal->reloadtxpowerindex)\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"reload ofdm index for band switch\\n\");\n\n\t \n\trtldm->thermalvalue_avg[rtldm->thermalvalue_avg_index] = thermal_value;\n\trtldm->thermalvalue_avg_index++;\n\tif (rtldm->thermalvalue_avg_index == AVG_THERMAL_NUM_8812A)\n\t\t \n\t\trtldm->thermalvalue_avg_index = 0;\n\n\tfor (i = 0; i < AVG_THERMAL_NUM_8812A; i++) {\n\t\tif (rtldm->thermalvalue_avg[i]) {\n\t\t\tthermal_value_avg += rtldm->thermalvalue_avg[i];\n\t\t\tthermal_value_avg_count++;\n\t\t}\n\t}\n\t \n\tif (thermal_value_avg_count) {\n\t\tthermal_value = (u8)(thermal_value_avg /\n\t\t\t\tthermal_value_avg_count);\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"AVG Thermal Meter = 0x%X, EFUSE Thermal Base = 0x%X\\n\",\n\t\t\tthermal_value, rtlefuse->eeprom_thermalmeter);\n\t}\n\n\t \n\tdelta = (thermal_value > rtldm->thermalvalue) ?\n\t\t(thermal_value - rtldm->thermalvalue) :\n\t\t(rtldm->thermalvalue - thermal_value);\n\tdelta_lck = (thermal_value > rtldm->thermalvalue_lck) ?\n\t\t(thermal_value - rtldm->thermalvalue_lck) :\n\t\t(rtldm->thermalvalue_lck - thermal_value);\n\tdelta_iqk = (thermal_value > rtldm->thermalvalue_iqk) ?\n\t\t(thermal_value - rtldm->thermalvalue_iqk) :\n\t\t(rtldm->thermalvalue_iqk - thermal_value);\n\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"(delta, delta_LCK, delta_IQK) = (%d, %d, %d)\\n\",\n\t\tdelta, delta_lck, delta_iqk);\n\n\t \n\tif (delta_lck >= IQK_THRESHOLD) {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"delta_LCK(%d) >= Threshold_IQK(%d)\\n\",\n\t\t\tdelta_lck, IQK_THRESHOLD);\n\t\trtldm->thermalvalue_lck = thermal_value;\n\t\trtl8821ae_phy_lc_calibrate(hw);\n\t}\n\n\t \n\n\tif (delta > 0 && rtldm->txpower_track_control) {\n\t\t \n\t\tdelta = thermal_value > rtlefuse->eeprom_thermalmeter ?\n\t\t\t(thermal_value - rtlefuse->eeprom_thermalmeter) :\n\t\t\t(rtlefuse->eeprom_thermalmeter - thermal_value);\n\n\t\tif (delta >= TXPWR_TRACK_TABLE_SIZE)\n\t\t\tdelta = TXPWR_TRACK_TABLE_SIZE - 1;\n\n\t\t \n\n\t\tif (thermal_value > rtlefuse->eeprom_thermalmeter) {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"delta_swing_table_idx_tup_a[%d] = %d\\n\",\n\t\t\t\tdelta, delta_swing_table_idx_tup_a[delta]);\n\t\t\trtldm->delta_power_index_last[RF90_PATH_A] =\n\t\t\t\trtldm->delta_power_index[RF90_PATH_A];\n\t\t\trtldm->delta_power_index[RF90_PATH_A] =\n\t\t\t\tdelta_swing_table_idx_tup_a[delta];\n\n\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_A] =\n\t\t\t\tdelta_swing_table_idx_tup_a[delta];\n\t\t\t \n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"******Temp is higher and pDM_Odm->Absolute_OFDMSwingIdx[ODM_RF_PATH_A] = %d\\n\",\n\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_A]);\n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"delta_swing_table_idx_tup_b[%d] = %d\\n\",\n\t\t\t\tdelta, delta_swing_table_idx_tup_b[delta]);\n\t\t\trtldm->delta_power_index_last[RF90_PATH_B] =\n\t\t\t\trtldm->delta_power_index[RF90_PATH_B];\n\t\t\trtldm->delta_power_index[RF90_PATH_B] =\n\t\t\t\tdelta_swing_table_idx_tup_b[delta];\n\n\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_B] =\n\t\t\t\tdelta_swing_table_idx_tup_b[delta];\n\t\t\t \n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"******Temp is higher and pDM_Odm->Absolute_OFDMSwingIdx[ODM_RF_PATH_B] = %d\\n\",\n\t\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_B]);\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"delta_swing_table_idx_tdown_a[%d] = %d\\n\",\n\t\t\t\tdelta, delta_swing_table_idx_tdown_a[delta]);\n\n\t\t\trtldm->delta_power_index_last[RF90_PATH_A] =\n\t\t\t\trtldm->delta_power_index[RF90_PATH_A];\n\t\t\trtldm->delta_power_index[RF90_PATH_A] =\n\t\t\t\t-1 * delta_swing_table_idx_tdown_a[delta];\n\n\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_A] =\n\t\t\t\t-1 * delta_swing_table_idx_tdown_a[delta];\n\t\t\t \n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"******Temp is lower and pDM_Odm->Absolute_OFDMSwingIdx[ODM_RF_PATH_A] = %d\\n\",\n\t\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_A]);\n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"deltaSwingTableIdx_TDOWN_B[%d] = %d\\n\",\n\t\t\t\tdelta, delta_swing_table_idx_tdown_b[delta]);\n\n\t\t\trtldm->delta_power_index_last[RF90_PATH_B] =\n\t\t\t\trtldm->delta_power_index[RF90_PATH_B];\n\t\t\trtldm->delta_power_index[RF90_PATH_B] =\n\t\t\t\t-1 * delta_swing_table_idx_tdown_b[delta];\n\n\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_B] =\n\t\t\t\t-1 * delta_swing_table_idx_tdown_b[delta];\n\t\t\t \n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"******Temp is lower and pDM_Odm->Absolute_OFDMSwingIdx[ODM_RF_PATH_B] = %d\\n\",\n\t\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_B]);\n\t\t}\n\n\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++) {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"============================= [Path-%c]Calculating PowerIndexOffset =============================\\n\",\n\t\t\t\t(p == RF90_PATH_A ? 'A' : 'B'));\n\n\t\t\tif (rtldm->delta_power_index[p] ==\n\t\t\t\trtldm->delta_power_index_last[p])\n\t\t\t\t \n\t\t\t\trtldm->power_index_offset[p] = 0;\n\t\t\telse\n\t\t\t\trtldm->power_index_offset[p] =\n\t\t\t\t\trtldm->delta_power_index[p] -\n\t\t\t\t\trtldm->delta_power_index_last[p];\n\t\t\t\t \n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"[Path-%c] PowerIndexOffset(%d) =DeltaPowerIndex(%d) -DeltaPowerIndexLast(%d)\\n\",\n\t\t\t\t(p == RF90_PATH_A ? 'A' : 'B'),\n\t\t\t\trtldm->power_index_offset[p],\n\t\t\t\trtldm->delta_power_index[p],\n\t\t\t\trtldm->delta_power_index_last[p]);\n\n\t\t\trtldm->ofdm_index[p] =\n\t\t\t\t\trtldm->swing_idx_ofdm_base[p] +\n\t\t\t\t\trtldm->power_index_offset[p];\n\t\t\trtldm->cck_index =\n\t\t\t\t\trtldm->swing_idx_cck_base +\n\t\t\t\t\trtldm->power_index_offset[p];\n\n\t\t\trtldm->swing_idx_cck = rtldm->cck_index;\n\t\t\trtldm->swing_idx_ofdm[p] = rtldm->ofdm_index[p];\n\n\t\t\t \n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"The 'CCK' final index(%d) = BaseIndex(%d) + PowerIndexOffset(%d)\\n\",\n\t\t\t\trtldm->swing_idx_cck,\n\t\t\t\trtldm->swing_idx_cck_base,\n\t\t\t\trtldm->power_index_offset[p]);\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"The 'OFDM' final index(%d) = BaseIndex[%c](%d) + PowerIndexOffset(%d)\\n\",\n\t\t\t\trtldm->swing_idx_ofdm[p],\n\t\t\t\t(p == RF90_PATH_A ? 'A' : 'B'),\n\t\t\t\trtldm->swing_idx_ofdm_base[p],\n\t\t\t\trtldm->power_index_offset[p]);\n\n\t\t\t \n\n\t\t\tif (rtldm->ofdm_index[p] > TXSCALE_TABLE_SIZE - 1)\n\t\t\t\trtldm->ofdm_index[p] = TXSCALE_TABLE_SIZE - 1;\n\t\t\telse if (rtldm->ofdm_index[p] < ofdm_min_index)\n\t\t\t\trtldm->ofdm_index[p] = ofdm_min_index;\n\t\t}\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"\\n\\n====================================================================================\\n\");\n\t\tif (rtldm->cck_index > TXSCALE_TABLE_SIZE - 1)\n\t\t\trtldm->cck_index = TXSCALE_TABLE_SIZE - 1;\n\t\telse if (rtldm->cck_index < 0)\n\t\t\trtldm->cck_index = 0;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"The thermal meter is unchanged or TxPowerTracking OFF(%d): ThermalValue: %d , pDM_Odm->RFCalibrateInfo.ThermalValue: %d\\n\",\n\t\t\trtldm->txpower_track_control,\n\t\t\tthermal_value,\n\t\t\trtldm->thermalvalue);\n\n\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++)\n\t\t\trtldm->power_index_offset[p] = 0;\n\t}\n\t \n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"TxPowerTracking: [CCK] Swing Current Index: %d,Swing Base Index: %d\\n\",\n\t\trtldm->cck_index, rtldm->swing_idx_cck_base);\n\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++) {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"TxPowerTracking: [OFDM] Swing Current Index: %d,Swing Base Index[%c]: %d\\n\",\n\t\t\trtldm->ofdm_index[p],\n\t\t\t(p == RF90_PATH_A ? 'A' : 'B'),\n\t\t\trtldm->swing_idx_ofdm_base[p]);\n\t}\n\n\tif ((rtldm->power_index_offset[RF90_PATH_A] != 0 ||\n\t\trtldm->power_index_offset[RF90_PATH_B] != 0) &&\n\t\trtldm->txpower_track_control) {\n\t\t \n\t\tif (thermal_value > rtldm->thermalvalue) {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"Temperature Increasing(A): delta_pi: %d , delta_t: %d, Now_t: %d,EFUSE_t: %d, Last_t: %d\\n\",\n\t\t\t\trtldm->power_index_offset[RF90_PATH_A],\n\t\t\t\tdelta, thermal_value,\n\t\t\t\trtlefuse->eeprom_thermalmeter,\n\t\t\t\trtldm->thermalvalue);\n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"Temperature Increasing(B): delta_pi: %d ,delta_t: %d, Now_t: %d, EFUSE_t: %d, Last_t: %d\\n\",\n\t\t\t\trtldm->power_index_offset[RF90_PATH_B],\n\t\t\t\tdelta, thermal_value,\n\t\t\t\trtlefuse->eeprom_thermalmeter,\n\t\t\t\trtldm->thermalvalue);\n\t\t} else if (thermal_value < rtldm->thermalvalue) {  \n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"Temperature Decreasing(A): delta_pi: %d , delta_t: %d, Now_t: %d, EFUSE_t: %d, Last_t: %d\\n\",\n\t\t\t\trtldm->power_index_offset[RF90_PATH_A],\n\t\t\t\tdelta, thermal_value,\n\t\t\t\trtlefuse->eeprom_thermalmeter,\n\t\t\t\trtldm->thermalvalue);\n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"Temperature Decreasing(B): delta_pi: %d , delta_t: %d, Now_t: %d, EFUSE_t: %d, Last_t: %d\\n\",\n\t\t\t\trtldm->power_index_offset[RF90_PATH_B],\n\t\t\t\tdelta, thermal_value,\n\t\t\t\trtlefuse->eeprom_thermalmeter,\n\t\t\t\trtldm->thermalvalue);\n\t\t}\n\n\t\tif (thermal_value > rtlefuse->eeprom_thermalmeter) {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"Temperature(%d) higher than PG value(%d)\\n\",\n\t\t\t\tthermal_value, rtlefuse->eeprom_thermalmeter);\n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"**********Enter POWER Tracking MIX_MODE**********\\n\");\n\t\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++)\n\t\t\t\trtl8812ae_dm_txpwr_track_set_pwr(hw, MIX_MODE,\n\t\t\t\t\t\t\t\t p, 0);\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"Temperature(%d) lower than PG value(%d)\\n\",\n\t\t\t\tthermal_value, rtlefuse->eeprom_thermalmeter);\n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"**********Enter POWER Tracking MIX_MODE**********\\n\");\n\t\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++)\n\t\t\t\trtl8812ae_dm_txpwr_track_set_pwr(hw, MIX_MODE,\n\t\t\t\t\t\t\t\t p, index_for_channel);\n\t\t}\n\t\t \n\t\trtldm->swing_idx_cck_base = rtldm->swing_idx_cck;\n\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8812A; p++)\n\t\t\t\trtldm->swing_idx_ofdm_base[p] =\n\t\t\t\t\trtldm->swing_idx_ofdm[p];\n\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"pDM_Odm->RFCalibrateInfo.ThermalValue =%d ThermalValue= %d\\n\",\n\t\t\trtldm->thermalvalue, thermal_value);\n\t\t \n\t\trtldm->thermalvalue = thermal_value;\n\t}\n\t \n\tif (delta_iqk >= IQK_THRESHOLD)\n\t\trtl8812ae_do_iqk(hw, delta_iqk, thermal_value, 8);\n\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"<===%s\\n\", __func__);\n}\n\nstatic void rtl8821ae_get_delta_swing_table(struct ieee80211_hw *hw,\n\t\t\t\t\t    const u8 **up_a,\n\t\t\t\t\t    const u8 **down_a)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\n\tu8 channel = rtlphy->current_channel;\n\tu8 rate = rtldm->tx_rate;\n\n\tif (1 <= channel && channel <= 14) {\n\t\tif (RTL8821AE_RX_HAL_IS_CCK_RATE(rate)) {\n\t\t\t*up_a = rtl8821ae_delta_swing_table_idx_24gccka_p;\n\t\t\t*down_a = rtl8821ae_delta_swing_table_idx_24gccka_n;\n\t\t} else {\n\t\t\t*up_a = rtl8821ae_delta_swing_table_idx_24ga_p;\n\t\t\t*down_a = rtl8821ae_delta_swing_table_idx_24ga_n;\n\t\t}\n\t} else if (36 <= channel && channel <= 64) {\n\t\t*up_a = rtl8821ae_delta_swing_table_idx_5ga_p[0];\n\t\t*down_a = rtl8821ae_delta_swing_table_idx_5ga_n[0];\n\t} else if (100 <= channel && channel <= 140) {\n\t\t*up_a = rtl8821ae_delta_swing_table_idx_5ga_p[1];\n\t\t*down_a = rtl8821ae_delta_swing_table_idx_5ga_n[1];\n\t} else if (149 <= channel && channel <= 173) {\n\t\t*up_a = rtl8821ae_delta_swing_table_idx_5ga_p[2];\n\t\t*down_a = rtl8821ae_delta_swing_table_idx_5ga_n[2];\n\t} else {\n\t\t*up_a = rtl8818e_delta_swing_table_idx_24gb_p;\n\t\t*down_a = rtl8818e_delta_swing_table_idx_24gb_n;\n\t}\n\treturn;\n}\n\n \nvoid rtl8821ae_dm_txpwr_track_set_pwr(struct ieee80211_hw *hw,\n\t\t\t\t      enum pwr_track_control_method method,\n\t\t\t\t      u8 rf_path, u8 channel_mapped_index)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_dm\t*rtldm = rtl_dm(rtl_priv(hw));\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu32 final_swing_idx[1];\n\tu8 pwr_tracking_limit = 26;  \n\tu8 tx_rate = 0xFF;\n\ts8 final_ofdm_swing_index = 0;\n\n\tif (rtldm->tx_rate != 0xFF)\n\t\ttx_rate = rtl8821ae_hw_rate_to_mrate(hw, rtldm->tx_rate);\n\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD, \"===>%s\\n\", __func__);\n\n\tif (tx_rate != 0xFF) {  \n\t\t \n\t\tif ((tx_rate >= MGN_1M) && (tx_rate <= MGN_11M))\n\t\t\tpwr_tracking_limit = 32;  \n\t\t \n\t\telse if ((tx_rate >= MGN_6M) && (tx_rate <= MGN_48M))\n\t\t\tpwr_tracking_limit = 30;  \n\t\telse if (tx_rate == MGN_54M)\n\t\t\tpwr_tracking_limit = 28;  \n\t\t \n\t\t \n\t\telse if ((tx_rate >= MGN_MCS0) && (tx_rate <= MGN_MCS2))\n\t\t\tpwr_tracking_limit = 34;  \n\t\t \n\t\telse if ((tx_rate >= MGN_MCS3) && (tx_rate <= MGN_MCS4))\n\t\t\tpwr_tracking_limit = 30;  \n\t\t \n\t\telse if ((tx_rate >= MGN_MCS5) && (tx_rate <= MGN_MCS7))\n\t\t\tpwr_tracking_limit = 28;  \n\t\t \n\t\t \n\t\telse if ((tx_rate >= MGN_VHT1SS_MCS0) &&\n\t\t\t(tx_rate <= MGN_VHT1SS_MCS2))\n\t\t\tpwr_tracking_limit = 34;  \n\t\t \n\t\telse if ((tx_rate >= MGN_VHT1SS_MCS3) &&\n\t\t\t(tx_rate <= MGN_VHT1SS_MCS4))\n\t\t\tpwr_tracking_limit = 30;  \n\t\t \n\t\telse if ((tx_rate >= MGN_VHT1SS_MCS5) &&\n\t\t\t(tx_rate <= MGN_VHT1SS_MCS6))\n\t\t\tpwr_tracking_limit = 28;  \n\t\telse if (tx_rate == MGN_VHT1SS_MCS7)  \n\t\t\tpwr_tracking_limit = 26;  \n\t\telse if (tx_rate == MGN_VHT1SS_MCS8)  \n\t\t\tpwr_tracking_limit = 24;  \n\t\telse if (tx_rate == MGN_VHT1SS_MCS9)  \n\t\t\tpwr_tracking_limit = 22;  \n\t\telse\n\t\t\tpwr_tracking_limit = 24;\n\t}\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"TxRate=0x%x, PwrTrackingLimit=%d\\n\",\n\t\ttx_rate, pwr_tracking_limit);\n\n\tif (method == BBSWING) {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"===>%s\\n\", __func__);\n\t\tif (rf_path == RF90_PATH_A) {\n\t\t\tfinal_swing_idx[RF90_PATH_A] =\n\t\t\t\t(rtldm->ofdm_index[RF90_PATH_A] >\n\t\t\t\tpwr_tracking_limit) ?\n\t\t\t\tpwr_tracking_limit :\n\t\t\t\trtldm->ofdm_index[RF90_PATH_A];\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"pDM_Odm->RFCalibrateInfo.OFDM_index[ODM_RF_PATH_A]=%d,pDM_Odm->RealBbSwingIdx[ODM_RF_PATH_A]=%d\\n\",\n\t\t\t\trtldm->ofdm_index[RF90_PATH_A],\n\t\t\t\tfinal_swing_idx[RF90_PATH_A]);\n\n\t\t\trtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\n\t\t\t\ttxscaling_tbl[final_swing_idx[RF90_PATH_A]]);\n\t\t}\n\t} else if (method == MIX_MODE) {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"pDM_Odm->DefaultOfdmIndex=%d,pDM_Odm->Absolute_OFDMSwingIdx[RFPath]=%d, RF_Path = %d\\n\",\n\t\t\trtldm->default_ofdm_index,\n\t\t\trtldm->absolute_ofdm_swing_idx[rf_path],\n\t\t\trf_path);\n\n\t\tfinal_ofdm_swing_index =\n\t\t\trtldm->default_ofdm_index +\n\t\t\trtldm->absolute_ofdm_swing_idx[rf_path];\n\t\t \n\t\tif (rf_path == RF90_PATH_A) {\n\t\t\tif (final_ofdm_swing_index > pwr_tracking_limit) {\n\t\t\t\trtldm->remnant_cck_idx =\n\t\t\t\t\tfinal_ofdm_swing_index -\n\t\t\t\t\tpwr_tracking_limit;\n\t\t\t\t \n\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path] =\n\t\t\t\t\tfinal_ofdm_swing_index -\n\t\t\t\t\tpwr_tracking_limit;\n\n\t\t\t\trtl_set_bbreg(hw, RA_TXSCALE,\n\t\t\t\t\t0xFFE00000,\n\t\t\t\t\ttxscaling_tbl[pwr_tracking_limit]);\n\n\t\t\t\trtldm->modify_txagc_flag_path_a = true;\n\n\t\t\t\t \n\t\t\t\trtl8821ae_phy_set_txpower_level_by_path(hw,\n\t\t\t\t\trtlphy->current_channel,\n\t\t\t\t\tRF90_PATH_A);\n\n\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\t\" ******Path_A Over BBSwing Limit , PwrTrackingLimit = %d , Remnant TxAGC Value = %d\\n\",\n\t\t\t\t\tpwr_tracking_limit,\n\t\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path]);\n\t\t\t} else if (final_ofdm_swing_index < 0) {\n\t\t\t\trtldm->remnant_cck_idx = final_ofdm_swing_index;\n\t\t\t\t \n\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path] =\n\t\t\t\t\tfinal_ofdm_swing_index;\n\n\t\t\t\trtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\n\t\t\t\t\ttxscaling_tbl[0]);\n\n\t\t\t\trtldm->modify_txagc_flag_path_a = true;\n\n\t\t\t\t \n\t\t\t\trtl8821ae_phy_set_txpower_level_by_path(hw,\n\t\t\t\t\trtlphy->current_channel, RF90_PATH_A);\n\n\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\t\"******Path_A Lower then BBSwing lower bound  0 , Remnant TxAGC Value = %d\\n\",\n\t\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path]);\n\t\t\t} else {\n\t\t\t\trtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\n\t\t\t\t\ttxscaling_tbl[(u8)final_ofdm_swing_index]);\n\n\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\t\"******Path_A Compensate with BBSwing ,Final_OFDM_Swing_Index = %d\\n\",\n\t\t\t\t\tfinal_ofdm_swing_index);\n\t\t\t\t \n\t\t\t\tif (rtldm->modify_txagc_flag_path_a) {\n\t\t\t\t\trtldm->remnant_cck_idx = 0;\n\t\t\t\t\trtldm->remnant_ofdm_swing_idx[rf_path] = 0;\n\n\t\t\t\t\t \n\t\t\t\t\trtl8821ae_phy_set_txpower_level_by_path(hw,\n\t\t\t\t\t\trtlphy->current_channel, RF90_PATH_A);\n\n\t\t\t\t\trtldm->modify_txagc_flag_path_a = false;\n\n\t\t\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING,\n\t\t\t\t\t\tDBG_LOUD,\n\t\t\t\t\t\t\"******Path_A pDM_Odm->Modify_TxAGC_Flag= FALSE\\n\");\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t} else {\n\t\treturn;\n\t}\n}\n\nvoid rtl8821ae_dm_txpower_tracking_callback_thermalmeter(\n\tstruct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\n\tstruct rtl_dm\t*rtldm = rtl_dm(rtl_priv(hw));\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\n\tu8 thermal_value = 0, delta, delta_lck, delta_iqk, p = 0, i = 0;\n\tu8 thermal_value_avg_count = 0;\n\tu32 thermal_value_avg = 0;\n\n\tu8 ofdm_min_index = 6;   \n\t \n\tu8 index_for_channel = 0;\n\n\t \n\tconst u8 *delta_swing_table_idx_tup_a;\n\tconst u8 *delta_swing_table_idx_tdown_a;\n\n\t \n\trtl8821ae_get_delta_swing_table(hw,\n\t\t\t\t\t&delta_swing_table_idx_tup_a,\n\t\t\t\t\t&delta_swing_table_idx_tdown_a);\n\n\trtldm->txpower_trackinginit = true;\n\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"===>%s,\\n pDM_Odm->BbSwingIdxCckBase: %d,pDM_Odm->BbSwingIdxOfdmBase[A]:%d, pDM_Odm->DefaultOfdmIndex: %d\\n\",\n\t\t__func__,\n\t\trtldm->swing_idx_cck_base,\n\t\trtldm->swing_idx_ofdm_base[RF90_PATH_A],\n\t\trtldm->default_ofdm_index);\n\t \n\tthermal_value = (u8)rtl_get_rfreg(hw,\n\t\tRF90_PATH_A, RF_T_METER_8812A, 0xfc00);\n\tif (!rtldm->txpower_track_control ||\n\t\trtlefuse->eeprom_thermalmeter == 0 ||\n\t\trtlefuse->eeprom_thermalmeter == 0xFF)\n\t\treturn;\n\n\t \n\n\tif (rtlhal->reloadtxpowerindex) {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"reload ofdm index for band switch\\n\");\n\t}\n\n\t \n\trtldm->thermalvalue_avg[rtldm->thermalvalue_avg_index] = thermal_value;\n\trtldm->thermalvalue_avg_index++;\n\tif (rtldm->thermalvalue_avg_index == AVG_THERMAL_NUM_8812A)\n\t\t \n\t\trtldm->thermalvalue_avg_index = 0;\n\n\tfor (i = 0; i < AVG_THERMAL_NUM_8812A; i++) {\n\t\tif (rtldm->thermalvalue_avg[i]) {\n\t\t\tthermal_value_avg += rtldm->thermalvalue_avg[i];\n\t\t\tthermal_value_avg_count++;\n\t\t}\n\t}\n\t \n\tif (thermal_value_avg_count) {\n\t\tthermal_value = (u8)(thermal_value_avg /\n\t\t\t\tthermal_value_avg_count);\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"AVG Thermal Meter = 0x%X, EFUSE Thermal Base = 0x%X\\n\",\n\t\t\tthermal_value, rtlefuse->eeprom_thermalmeter);\n\t}\n\n\t \n\tdelta = (thermal_value > rtldm->thermalvalue) ?\n\t\t(thermal_value - rtldm->thermalvalue) :\n\t\t(rtldm->thermalvalue - thermal_value);\n\tdelta_lck = (thermal_value > rtldm->thermalvalue_lck) ?\n\t\t(thermal_value - rtldm->thermalvalue_lck) :\n\t\t(rtldm->thermalvalue_lck - thermal_value);\n\tdelta_iqk = (thermal_value > rtldm->thermalvalue_iqk) ?\n\t\t(thermal_value - rtldm->thermalvalue_iqk) :\n\t\t(rtldm->thermalvalue_iqk - thermal_value);\n\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"(delta, delta_LCK, delta_IQK) = (%d, %d, %d)\\n\",\n\t\tdelta, delta_lck, delta_iqk);\n\n\t \n\t \n\tif (delta_lck >= IQK_THRESHOLD) {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"delta_LCK(%d) >= Threshold_IQK(%d)\\n\",\n\t\t\tdelta_lck, IQK_THRESHOLD);\n\t\trtldm->thermalvalue_lck = thermal_value;\n\t\trtl8821ae_phy_lc_calibrate(hw);\n\t}\n\n\t \n\n\tif (delta > 0 && rtldm->txpower_track_control) {\n\t\t \n\t\tdelta = thermal_value > rtlefuse->eeprom_thermalmeter ?\n\t\t\t(thermal_value - rtlefuse->eeprom_thermalmeter) :\n\t\t\t(rtlefuse->eeprom_thermalmeter - thermal_value);\n\n\t\tif (delta >= TXSCALE_TABLE_SIZE)\n\t\t\tdelta = TXSCALE_TABLE_SIZE - 1;\n\n\t\t \n\n\t\tif (thermal_value > rtlefuse->eeprom_thermalmeter) {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"delta_swing_table_idx_tup_a[%d] = %d\\n\",\n\t\t\t\tdelta, delta_swing_table_idx_tup_a[delta]);\n\t\t\trtldm->delta_power_index_last[RF90_PATH_A] =\n\t\t\t\trtldm->delta_power_index[RF90_PATH_A];\n\t\t\trtldm->delta_power_index[RF90_PATH_A] =\n\t\t\t\tdelta_swing_table_idx_tup_a[delta];\n\n\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_A] =\n\t\t\t\tdelta_swing_table_idx_tup_a[delta];\n\t\t\t \n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"******Temp is higher and pDM_Odm->Absolute_OFDMSwingIdx[ODM_RF_PATH_A] = %d\\n\",\n\t\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_A]);\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"delta_swing_table_idx_tdown_a[%d] = %d\\n\",\n\t\t\t\tdelta, delta_swing_table_idx_tdown_a[delta]);\n\n\t\t\trtldm->delta_power_index_last[RF90_PATH_A] =\n\t\t\t\trtldm->delta_power_index[RF90_PATH_A];\n\t\t\trtldm->delta_power_index[RF90_PATH_A] =\n\t\t\t\t-1 * delta_swing_table_idx_tdown_a[delta];\n\n\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_A] =\n\t\t\t\t-1 * delta_swing_table_idx_tdown_a[delta];\n\t\t\t \n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"******Temp is lower and pDM_Odm->Absolute_OFDMSwingIdx[ODM_RF_PATH_A] = %d\\n\",\n\t\t\t\trtldm->absolute_ofdm_swing_idx[RF90_PATH_A]);\n\t\t}\n\n\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++) {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"\\n\\n================================ [Path-%c]Calculating PowerIndexOffset ================================\\n\",\n\t\t\t\t(p == RF90_PATH_A ? 'A' : 'B'));\n\t\t\t \n\t\t\tif (rtldm->delta_power_index[p] ==\n\t\t\t\trtldm->delta_power_index_last[p])\n\n\t\t\t\trtldm->power_index_offset[p] = 0;\n\t\t\telse\n\t\t\t\trtldm->power_index_offset[p] =\n\t\t\t\t\trtldm->delta_power_index[p] -\n\t\t\t\t\trtldm->delta_power_index_last[p];\n\t\t\t \n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"[Path-%c] PowerIndexOffset(%d) = DeltaPowerIndex(%d) - DeltaPowerIndexLast(%d)\\n\",\n\t\t\t\t(p == RF90_PATH_A ? 'A' : 'B'),\n\t\t\t\trtldm->power_index_offset[p],\n\t\t\t\trtldm->delta_power_index[p] ,\n\t\t\t\trtldm->delta_power_index_last[p]);\n\n\t\t\trtldm->ofdm_index[p] =\n\t\t\t\t\trtldm->swing_idx_ofdm_base[p] +\n\t\t\t\t\trtldm->power_index_offset[p];\n\t\t\trtldm->cck_index =\n\t\t\t\t\trtldm->swing_idx_cck_base +\n\t\t\t\t\trtldm->power_index_offset[p];\n\n\t\t\trtldm->swing_idx_cck = rtldm->cck_index;\n\t\t\trtldm->swing_idx_ofdm[p] = rtldm->ofdm_index[p];\n\n\t\t\t \n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"The 'CCK' final index(%d) = BaseIndex(%d) + PowerIndexOffset(%d)\\n\",\n\t\t\t\trtldm->swing_idx_cck,\n\t\t\t\trtldm->swing_idx_cck_base,\n\t\t\t\trtldm->power_index_offset[p]);\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"The 'OFDM' final index(%d) = BaseIndex[%c](%d) + PowerIndexOffset(%d)\\n\",\n\t\t\t\trtldm->swing_idx_ofdm[p],\n\t\t\t\t(p == RF90_PATH_A ? 'A' : 'B'),\n\t\t\t\trtldm->swing_idx_ofdm_base[p],\n\t\t\t\trtldm->power_index_offset[p]);\n\n\t\t\t \n\n\t\t\tif (rtldm->ofdm_index[p] > TXSCALE_TABLE_SIZE - 1)\n\t\t\t\trtldm->ofdm_index[p] = TXSCALE_TABLE_SIZE - 1;\n\t\t\telse if (rtldm->ofdm_index[p] < ofdm_min_index)\n\t\t\t\trtldm->ofdm_index[p] = ofdm_min_index;\n\t\t}\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"\\n\\n========================================================================================================\\n\");\n\t\tif (rtldm->cck_index > TXSCALE_TABLE_SIZE - 1)\n\t\t\trtldm->cck_index = TXSCALE_TABLE_SIZE - 1;\n\t\telse if (rtldm->cck_index < 0)\n\t\t\trtldm->cck_index = 0;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"The thermal meter is unchanged or TxPowerTracking OFF(%d):ThermalValue: %d , pDM_Odm->RFCalibrateInfo.ThermalValue: %d\\n\",\n\t\t\trtldm->txpower_track_control,\n\t\t\tthermal_value,\n\t\t\trtldm->thermalvalue);\n\n\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++)\n\t\t\trtldm->power_index_offset[p] = 0;\n\t}\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\"TxPowerTracking: [CCK] Swing Current Index: %d, Swing Base Index: %d\\n\",\n\t\t \n\t\trtldm->cck_index, rtldm->swing_idx_cck_base);\n\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++) {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"TxPowerTracking: [OFDM] Swing Current Index: %d, Swing Base Index[%c]: %d\\n\",\n\t\t\trtldm->ofdm_index[p],\n\t\t\t(p == RF90_PATH_A ? 'A' : 'B'),\n\t\t\trtldm->swing_idx_ofdm_base[p]);\n\t}\n\n\tif ((rtldm->power_index_offset[RF90_PATH_A] != 0 ||\n\t\trtldm->power_index_offset[RF90_PATH_B] != 0) &&\n\t\trtldm->txpower_track_control) {\n\t\t \n\t\t \n\t\t \n\t\tif (thermal_value > rtldm->thermalvalue) {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"Temperature Increasing(A): delta_pi: %d , delta_t: %d,Now_t: %d, EFUSE_t: %d, Last_t: %d\\n\",\n\t\t\t\trtldm->power_index_offset[RF90_PATH_A],\n\t\t\t\tdelta, thermal_value,\n\t\t\t\trtlefuse->eeprom_thermalmeter,\n\t\t\t\trtldm->thermalvalue);\n\t\t} else if (thermal_value < rtldm->thermalvalue) {  \n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"Temperature Decreasing(A): delta_pi: %d , delta_t: %d, Now_t: %d, EFUSE_t: %d, Last_t: %d\\n\",\n\t\t\t\trtldm->power_index_offset[RF90_PATH_A],\n\t\t\t\tdelta, thermal_value,\n\t\t\t\trtlefuse->eeprom_thermalmeter,\n\t\t\t\trtldm->thermalvalue);\n\t\t}\n\n\t\tif (thermal_value > rtlefuse->eeprom_thermalmeter) {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"Temperature(%d) higher than PG value(%d)\\n\",\n\t\t\t\tthermal_value, rtlefuse->eeprom_thermalmeter);\n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"****Enter POWER Tracking MIX_MODE****\\n\");\n\t\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++)\n\t\t\t\t\trtl8821ae_dm_txpwr_track_set_pwr(hw,\n\t\t\t\t\t\tMIX_MODE, p, index_for_channel);\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"Temperature(%d) lower than PG value(%d)\\n\",\n\t\t\t\tthermal_value, rtlefuse->eeprom_thermalmeter);\n\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\t\"*****Enter POWER Tracking MIX_MODE*****\\n\");\n\t\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++)\n\t\t\t\trtl8812ae_dm_txpwr_track_set_pwr(hw,\n\t\t\t\t\tMIX_MODE, p, index_for_channel);\n\t\t}\n\t\t \n\t\trtldm->swing_idx_cck_base = rtldm->swing_idx_cck;\n\t\tfor (p = RF90_PATH_A; p < MAX_PATH_NUM_8821A; p++)\n\t\t\trtldm->swing_idx_ofdm_base[p] = rtldm->swing_idx_ofdm[p];\n\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"pDM_Odm->RFCalibrateInfo.ThermalValue = %d ThermalValue= %d\\n\",\n\t\t\trtldm->thermalvalue, thermal_value);\n\t\t \n\t\trtldm->thermalvalue = thermal_value;\n\t}\n\t \n\tif (delta_iqk >= IQK_THRESHOLD) {\n\t\tif (!rtlphy->lck_inprogress) {\n\t\t\tspin_lock(&rtlpriv->locks.iqk_lock);\n\t\t\trtlphy->lck_inprogress = true;\n\t\t\tspin_unlock(&rtlpriv->locks.iqk_lock);\n\n\t\t\trtl8821ae_do_iqk(hw, delta_iqk, thermal_value, 8);\n\n\t\t\tspin_lock(&rtlpriv->locks.iqk_lock);\n\t\t\trtlphy->lck_inprogress = false;\n\t\t\tspin_unlock(&rtlpriv->locks.iqk_lock);\n\t\t}\n\t}\n\n\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD, \"<===%s\\n\", __func__);\n}\n\nvoid rtl8821ae_dm_check_txpower_tracking_thermalmeter(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tif (!rtlpriv->dm.tm_trigger) {\n\t\trtl_set_rfreg(hw, RF90_PATH_A, RF_T_METER_88E, BIT(17)|BIT(16),\n\t\t\t      0x03);\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"Trigger 8821ae Thermal Meter!!\\n\");\n\t\trtlpriv->dm.tm_trigger = 1;\n\t\treturn;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"Schedule TxPowerTracking !!\\n\");\n\n\t\trtl8821ae_dm_txpower_tracking_callback_thermalmeter(hw);\n\t\trtlpriv->dm.tm_trigger = 0;\n\t}\n}\n\nstatic void rtl8821ae_dm_refresh_rate_adaptive_mask(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tstruct rate_adaptive *p_ra = &rtlpriv->ra;\n\tu32 low_rssithresh_for_ra = p_ra->low2high_rssi_thresh_for_ra40m;\n\tu32 high_rssithresh_for_ra = p_ra->high_rssi_thresh_for_ra;\n\tu8 go_up_gap = 5;\n\tstruct ieee80211_sta *sta = NULL;\n\n\tif (is_hal_stop(rtlhal)) {\n\t\trtl_dbg(rtlpriv, COMP_RATE, DBG_LOUD,\n\t\t\t\"driver is going to unload\\n\");\n\t\treturn;\n\t}\n\n\tif (!rtlpriv->dm.useramask) {\n\t\trtl_dbg(rtlpriv, COMP_RATE, DBG_LOUD,\n\t\t\t\"driver does not control rate adaptive mask\\n\");\n\t\treturn;\n\t}\n\n\tif (mac->link_state == MAC80211_LINKED &&\n\t\tmac->opmode == NL80211_IFTYPE_STATION) {\n\t\tswitch (p_ra->pre_ratr_state) {\n\t\tcase DM_RATR_STA_MIDDLE:\n\t\t\thigh_rssithresh_for_ra += go_up_gap;\n\t\t\tbreak;\n\t\tcase DM_RATR_STA_LOW:\n\t\t\thigh_rssithresh_for_ra += go_up_gap;\n\t\t\tlow_rssithresh_for_ra += go_up_gap;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tif (rtlpriv->dm.undec_sm_pwdb >\n\t\t    (long)high_rssithresh_for_ra)\n\t\t\tp_ra->ratr_state = DM_RATR_STA_HIGH;\n\t\telse if (rtlpriv->dm.undec_sm_pwdb >\n\t\t\t (long)low_rssithresh_for_ra)\n\t\t\tp_ra->ratr_state = DM_RATR_STA_MIDDLE;\n\t\telse\n\t\t\tp_ra->ratr_state = DM_RATR_STA_LOW;\n\n\t\tif (p_ra->pre_ratr_state != p_ra->ratr_state) {\n\t\t\trtl_dbg(rtlpriv, COMP_RATE, DBG_LOUD,\n\t\t\t\t\"RSSI = %ld\\n\",\n\t\t\t\trtlpriv->dm.undec_sm_pwdb);\n\t\t\trtl_dbg(rtlpriv, COMP_RATE, DBG_LOUD,\n\t\t\t\t\"RSSI_LEVEL = %d\\n\", p_ra->ratr_state);\n\t\t\trtl_dbg(rtlpriv, COMP_RATE, DBG_LOUD,\n\t\t\t\t\"PreState = %d, CurState = %d\\n\",\n\t\t\t\tp_ra->pre_ratr_state, p_ra->ratr_state);\n\n\t\t\trcu_read_lock();\n\t\t\tsta = rtl_find_sta(hw, mac->bssid);\n\t\t\tif (sta)\n\t\t\t\trtlpriv->cfg->ops->update_rate_tbl(hw,\n\t\t\t\t\t\tsta, p_ra->ratr_state, true);\n\t\t\trcu_read_unlock();\n\n\t\t\tp_ra->pre_ratr_state = p_ra->ratr_state;\n\t\t}\n\t}\n}\n\nstatic void rtl8821ae_dm_refresh_basic_rate_mask(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\n\tstruct rtl_mac *mac = &rtlpriv->mac80211;\n\tstatic u8 stage;\n\tu8 cur_stage = 0;\n\tu16 basic_rate = RRSR_1M | RRSR_2M | RRSR_5_5M | RRSR_11M | RRSR_6M;\n\n\tif (mac->link_state < MAC80211_LINKED)\n\t\tcur_stage = 0;\n\telse if (dm_digtable->rssi_val_min < 25)\n\t\tcur_stage = 1;\n\telse if (dm_digtable->rssi_val_min > 30)\n\t\tcur_stage = 3;\n\telse\n\t\tcur_stage = 2;\n\n\tif (cur_stage != stage) {\n\t\tif (cur_stage == 1) {\n\t\t\tbasic_rate &= (!(basic_rate ^ mac->basic_rates));\n\t\t\trtlpriv->cfg->ops->set_hw_reg(hw,\n\t\t\t\tHW_VAR_BASIC_RATE, (u8 *)&basic_rate);\n\t\t} else if (cur_stage == 3 && (stage == 1 || stage == 2)) {\n\t\t\trtlpriv->cfg->ops->set_hw_reg(hw,\n\t\t\t\tHW_VAR_BASIC_RATE, (u8 *)&mac->basic_rates);\n\t\t}\n\t}\n\tstage = cur_stage;\n}\n\nstatic void rtl8821ae_dm_edca_choose_traffic_idx(\n\tstruct ieee80211_hw *hw, u64 cur_tx_bytes,\n\tu64 cur_rx_bytes, bool b_bias_on_rx,\n\tbool *pb_is_cur_rdl_state)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\tif (b_bias_on_rx) {\n\t\tif (cur_tx_bytes > (cur_rx_bytes*4)) {\n\t\t\t*pb_is_cur_rdl_state = false;\n\t\t\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\t\t\"Uplink Traffic\\n\");\n\t\t} else {\n\t\t\t*pb_is_cur_rdl_state = true;\n\t\t\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\t\t\"Balance Traffic\\n\");\n\t\t}\n\t} else {\n\t\tif (cur_rx_bytes > (cur_tx_bytes*4)) {\n\t\t\t*pb_is_cur_rdl_state = true;\n\t\t\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\t\t\"Downlink\tTraffic\\n\");\n\t\t} else {\n\t\t\t*pb_is_cur_rdl_state = false;\n\t\t\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\t\t\"Balance Traffic\\n\");\n\t\t}\n\t}\n\treturn;\n}\n\nstatic void rtl8821ae_dm_check_edca_turbo(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tstruct rtl_dm *rtldm =  rtl_dm(rtl_priv(hw));\n\n\t \n\tu64 cur_tx_ok_cnt = 0;\n\tu64 cur_rx_ok_cnt = 0;\n\tu32 edca_be_ul = 0x5ea42b;\n\tu32 edca_be_dl = 0x5ea42b;\n\tu32 edca_be = 0x5ea42b;\n\tu8 iot_peer = 0;\n\tbool *pb_is_cur_rdl_state = NULL;\n\tbool b_bias_on_rx = false;\n\tbool b_edca_turbo_on = false;\n\n\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\"%s=====>\\n\", __func__);\n\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\"Original BE PARAM: 0x%x\\n\",\n\t\trtl_read_dword(rtlpriv, DM_REG_EDCA_BE_11N));\n\n\tif (rtlpriv->dm.dbginfo.num_non_be_pkt > 0x100)\n\t\trtlpriv->dm.is_any_nonbepkts = true;\n\trtlpriv->dm.dbginfo.num_non_be_pkt = 0;\n\n\t \n\tpb_is_cur_rdl_state = &rtlpriv->dm.is_cur_rdlstate;\n\n\tcur_tx_ok_cnt = rtlpriv->stats.txbytesunicast - rtldm->last_tx_ok_cnt;\n\tcur_rx_ok_cnt = rtlpriv->stats.rxbytesunicast - rtldm->last_rx_ok_cnt;\n\n\trtldm->last_tx_ok_cnt = rtlpriv->stats.txbytesunicast;\n\trtldm->last_rx_ok_cnt = rtlpriv->stats.rxbytesunicast;\n\n\tiot_peer = rtlpriv->mac80211.vendor;\n\tb_bias_on_rx = false;\n\tb_edca_turbo_on = ((!rtlpriv->dm.is_any_nonbepkts) &&\n\t\t\t   (!rtlpriv->dm.disable_framebursting)) ?\n\t\t\t   true : false;\n\n\tif (rtlpriv->rtlhal.hw_type != HARDWARE_TYPE_RTL8812AE) {\n\t\tif ((iot_peer == PEER_CISCO) &&\n\t\t\t(mac->mode == WIRELESS_MODE_N_24G)) {\n\t\t\tedca_be_dl = edca_setting_dl[iot_peer];\n\t\t\tedca_be_ul = edca_setting_ul[iot_peer];\n\t\t}\n\t}\n\n\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\"bIsAnyNonBEPkts : 0x%x  bDisableFrameBursting : 0x%x\\n\",\n\t\trtlpriv->dm.is_any_nonbepkts,\n\t\trtlpriv->dm.disable_framebursting);\n\n\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\"bEdcaTurboOn : 0x%x bBiasOnRx : 0x%x\\n\",\n\t\tb_edca_turbo_on, b_bias_on_rx);\n\n\tif (b_edca_turbo_on) {\n\t\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\t\"curTxOkCnt : 0x%llx\\n\", cur_tx_ok_cnt);\n\t\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\t\"curRxOkCnt : 0x%llx\\n\", cur_rx_ok_cnt);\n\t\tif (b_bias_on_rx)\n\t\t\trtl8821ae_dm_edca_choose_traffic_idx(hw, cur_tx_ok_cnt,\n\t\t\t\tcur_rx_ok_cnt, true, pb_is_cur_rdl_state);\n\t\telse\n\t\t\trtl8821ae_dm_edca_choose_traffic_idx(hw, cur_tx_ok_cnt,\n\t\t\t\tcur_rx_ok_cnt, false, pb_is_cur_rdl_state);\n\n\t\tedca_be = (*pb_is_cur_rdl_state) ?  edca_be_dl : edca_be_ul;\n\n\t\trtl_write_dword(rtlpriv, DM_REG_EDCA_BE_11N, edca_be);\n\n\t\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\t\"EDCA Turbo on: EDCA_BE:0x%x\\n\", edca_be);\n\n\t\trtlpriv->dm.current_turbo_edca = true;\n\n\t\trtl_dbg(rtlpriv, COMP_TURBO, DBG_LOUD,\n\t\t\t\"EDCA_BE_DL : 0x%x  EDCA_BE_UL : 0x%x  EDCA_BE : 0x%x\\n\",\n\t\t\tedca_be_dl, edca_be_ul, edca_be);\n\t} else {\n\t\tif (rtlpriv->dm.current_turbo_edca) {\n\t\t\tu8 tmp = AC0_BE;\n\t\t\trtlpriv->cfg->ops->set_hw_reg(hw, HW_VAR_AC_PARAM,\n\t\t\t\t\t\t      (u8 *)(&tmp));\n\t\t}\n\t\trtlpriv->dm.current_turbo_edca = false;\n\t}\n\n\trtlpriv->dm.is_any_nonbepkts = false;\n\trtldm->last_tx_ok_cnt = rtlpriv->stats.txbytesunicast;\n\trtldm->last_rx_ok_cnt = rtlpriv->stats.rxbytesunicast;\n}\n\nstatic void rtl8821ae_dm_cck_packet_detection_thresh(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\n\tu8 cur_cck_cca_thresh;\n\n\tif (rtlpriv->mac80211.link_state >= MAC80211_LINKED) {\n\t\tif (dm_digtable->rssi_val_min > 25) {\n\t\t\tcur_cck_cca_thresh = 0xcd;\n\t\t} else if ((dm_digtable->rssi_val_min <= 25) &&\n\t\t\t   (dm_digtable->rssi_val_min > 10)) {\n\t\t\tcur_cck_cca_thresh = 0x83;\n\t\t} else {\n\t\t\tif (rtlpriv->falsealm_cnt.cnt_cck_fail > 1000)\n\t\t\t\tcur_cck_cca_thresh = 0x83;\n\t\t\telse\n\t\t\t\tcur_cck_cca_thresh = 0x40;\n\t\t}\n\t} else {\n\t\tif (rtlpriv->falsealm_cnt.cnt_cck_fail > 1000)\n\t\t\tcur_cck_cca_thresh = 0x83;\n\t\telse\n\t\t\tcur_cck_cca_thresh = 0x40;\n\t}\n\n\tif (dm_digtable->cur_cck_cca_thres != cur_cck_cca_thresh)\n\t\trtl_write_byte(rtlpriv, ODM_REG_CCK_CCA_11AC,\n\t\t\t       cur_cck_cca_thresh);\n\n\tdm_digtable->pre_cck_cca_thres = dm_digtable->cur_cck_cca_thres;\n\tdm_digtable->cur_cck_cca_thres = cur_cck_cca_thresh;\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_TRACE,\n\t\t\"CCK cca thresh hold =%x\\n\", dm_digtable->cur_cck_cca_thres);\n}\n\nstatic void rtl8821ae_dm_dynamic_atc_switch(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\n\tu8 crystal_cap;\n\tu32 packet_count;\n\tint cfo_khz_a, cfo_khz_b, cfo_ave = 0, adjust_xtal = 0;\n\tint cfo_ave_diff;\n\n\tif (rtlpriv->mac80211.link_state < MAC80211_LINKED) {\n\t\t \n\t\tif (rtldm->atc_status == ATC_STATUS_OFF) {\n\t\t\trtl_set_bbreg(hw, RFC_AREA, BIT(14), ATC_STATUS_ON);\n\t\t\trtldm->atc_status = ATC_STATUS_ON;\n\t\t}\n\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD, \"No link!!\\n\");\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\"atc_status = %d\\n\", rtldm->atc_status);\n\n\t\tif (rtldm->crystal_cap != rtlpriv->efuse.crystalcap) {\n\t\t\trtldm->crystal_cap = rtlpriv->efuse.crystalcap;\n\t\t\tcrystal_cap = rtldm->crystal_cap & 0x3f;\n\t\t\tcrystal_cap = crystal_cap & 0x3f;\n\t\t\tif (rtlpriv->rtlhal.hw_type == HARDWARE_TYPE_RTL8812AE)\n\t\t\t\trtl_set_bbreg(hw, REG_MAC_PHY_CTRL,\n\t\t\t\t\t      0x7ff80000, (crystal_cap |\n\t\t\t\t\t      (crystal_cap << 6)));\n\t\t\telse\n\t\t\t\trtl_set_bbreg(hw, REG_MAC_PHY_CTRL,\n\t\t\t\t\t      0xfff000, (crystal_cap |\n\t\t\t\t\t      (crystal_cap << 6)));\n\t\t}\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD, \"crystal_cap = 0x%x\\n\",\n\t\t\trtldm->crystal_cap);\n\t} else{\n\t\t \n\t\tcfo_khz_a = (int)(rtldm->cfo_tail[0] * 3125) / 1280;\n\t\tcfo_khz_b = (int)(rtldm->cfo_tail[1] * 3125) / 1280;\n\t\tpacket_count = rtldm->packet_count;\n\n\t\t \n\t\tif (packet_count == rtldm->packet_count_pre) {\n\t\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\t\"packet counter doesn't change\\n\");\n\t\t\treturn;\n\t\t}\n\n\t\trtldm->packet_count_pre = packet_count;\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\"packet counter = %d\\n\",\n\t\t\trtldm->packet_count);\n\n\t\t \n\t\tif (rtlpriv->phy.rf_type == RF_1T1R)\n\t\t\tcfo_ave = cfo_khz_a;\n\t\telse\n\t\t\tcfo_ave = (cfo_khz_a + cfo_khz_b) >> 1;\n\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\"cfo_khz_a = %dkHz, cfo_khz_b = %dkHz, cfo_ave = %dkHz\\n\",\n\t\t\tcfo_khz_a, cfo_khz_b, cfo_ave);\n\n\t\t \n\t\tcfo_ave_diff = (rtldm->cfo_ave_pre >= cfo_ave) ?\n\t\t\t\t\t\t(rtldm->cfo_ave_pre - cfo_ave) :\n\t\t\t\t\t\t(cfo_ave - rtldm->cfo_ave_pre);\n\n\t\tif (cfo_ave_diff > 20 && !rtldm->large_cfo_hit) {\n\t\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\t\"first large CFO hit\\n\");\n\t\t\trtldm->large_cfo_hit = true;\n\t\t\treturn;\n\t\t} else\n\t\t\trtldm->large_cfo_hit = false;\n\n\t\trtldm->cfo_ave_pre = cfo_ave;\n\n\t\t \n\n\t\t \n\t\tif (cfo_ave >= -rtldm->cfo_threshold &&\n\t\t\tcfo_ave <= rtldm->cfo_threshold &&\n\t\t\trtldm->is_freeze == 0) {\n\t\t\tif (rtldm->cfo_threshold == CFO_THRESHOLD_XTAL) {\n\t\t\t\trtldm->cfo_threshold = CFO_THRESHOLD_XTAL + 10;\n\t\t\t\trtldm->is_freeze = 1;\n\t\t\t} else {\n\t\t\t\trtldm->cfo_threshold = CFO_THRESHOLD_XTAL;\n\t\t\t}\n\t\t}\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\"Dynamic threshold = %d\\n\",\n\t\t\trtldm->cfo_threshold);\n\n\t\t \n\t\tif (cfo_ave > rtldm->cfo_threshold && rtldm->crystal_cap < 0x3f)\n\t\t\tadjust_xtal = ((cfo_ave - CFO_THRESHOLD_XTAL) >> 2) + 1;\n\t\telse if ((cfo_ave < -rtlpriv->dm.cfo_threshold) &&\n\t\t\t rtlpriv->dm.crystal_cap > 0)\n\t\t\tadjust_xtal = ((cfo_ave + CFO_THRESHOLD_XTAL) >> 2) - 1;\n\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\"Crystal cap = 0x%x, Crystal cap offset = %d\\n\",\n\t\t\trtldm->crystal_cap, adjust_xtal);\n\n\t\t \n\t\tif (adjust_xtal != 0) {\n\t\t\trtldm->is_freeze = 0;\n\t\t\trtldm->crystal_cap += adjust_xtal;\n\n\t\t\tif (rtldm->crystal_cap > 0x3f)\n\t\t\t\trtldm->crystal_cap = 0x3f;\n\t\t\telse if (rtldm->crystal_cap < 0)\n\t\t\t\trtldm->crystal_cap = 0;\n\n\t\t\tcrystal_cap = rtldm->crystal_cap & 0x3f;\n\t\t\tcrystal_cap = crystal_cap & 0x3f;\n\t\t\tif (rtlpriv->rtlhal.hw_type == HARDWARE_TYPE_RTL8812AE)\n\t\t\t\trtl_set_bbreg(hw, REG_MAC_PHY_CTRL,\n\t\t\t\t\t      0x7ff80000, (crystal_cap |\n\t\t\t\t\t      (crystal_cap << 6)));\n\t\t\telse\n\t\t\t\trtl_set_bbreg(hw, REG_MAC_PHY_CTRL,\n\t\t\t\t\t      0xfff000, (crystal_cap |\n\t\t\t\t\t      (crystal_cap << 6)));\n\t\t\trtl_dbg(rtlpriv, COMP_DIG, DBG_LOUD,\n\t\t\t\t\"New crystal cap = 0x%x\\n\",\n\t\t\t\trtldm->crystal_cap);\n\t\t}\n\t}\n}\n\nvoid rtl8821ae_dm_watchdog(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_ps_ctl *ppsc = rtl_psc(rtl_priv(hw));\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tbool fw_current_inpsmode = false;\n\tbool fw_ps_awake = true;\n\n\trtlpriv->cfg->ops->get_hw_reg(hw, HW_VAR_FW_PSMODE_STATUS,\n\t\t\t\t      (u8 *)(&fw_current_inpsmode));\n\n\trtlpriv->cfg->ops->get_hw_reg(hw, HW_VAR_FWLPS_RF_ON,\n\t\t\t\t      (u8 *)(&fw_ps_awake));\n\n\tif (ppsc->p2p_ps_info.p2p_ps_mode)\n\t\tfw_ps_awake = false;\n\n\tspin_lock(&rtlpriv->locks.rf_ps_lock);\n\tif ((ppsc->rfpwr_state == ERFON) &&\n\t    ((!fw_current_inpsmode) && fw_ps_awake) &&\n\t    (!ppsc->rfchange_inprogress)) {\n\t\trtl8821ae_dm_common_info_self_update(hw);\n\t\trtl8821ae_dm_false_alarm_counter_statistics(hw);\n\t\trtl8821ae_dm_check_rssi_monitor(hw);\n\t\trtl8821ae_dm_dig(hw);\n\t\trtl8821ae_dm_cck_packet_detection_thresh(hw);\n\t\trtl8821ae_dm_refresh_rate_adaptive_mask(hw);\n\t\trtl8821ae_dm_refresh_basic_rate_mask(hw);\n\t\trtl8821ae_dm_check_edca_turbo(hw);\n\t\trtl8821ae_dm_dynamic_atc_switch(hw);\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)\n\t\t\trtl8812ae_dm_check_txpower_tracking_thermalmeter(hw);\n\t\telse\n\t\t\trtl8821ae_dm_check_txpower_tracking_thermalmeter(hw);\n\t\trtl8821ae_dm_iq_calibrate(hw);\n\t}\n\tspin_unlock(&rtlpriv->locks.rf_ps_lock);\n\n\trtlpriv->dm.dbginfo.num_qry_beacon_pkt = 0;\n\trtl_dbg(rtlpriv, COMP_DIG, DBG_DMESG, \"\\n\");\n}\n\nvoid rtl8821ae_dm_set_tx_ant_by_tx_info(struct ieee80211_hw *hw,\n\t\t\t\t\tu8 *pdesc, u32 mac_id)\n{\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tstruct rtl_dm *rtldm = rtl_dm(rtl_priv(hw));\n\tstruct fast_ant_training *pfat_table = &rtldm->fat_table;\n\t__le32 *pdesc32 = (__le32 *)pdesc;\n\n\tif (rtlhal->hw_type != HARDWARE_TYPE_RTL8812AE)\n\t\treturn;\n\n\tif (rtlefuse->antenna_div_type == CG_TRX_HW_ANTDIV)\n\t\tset_tx_desc_tx_ant(pdesc32, pfat_table->antsel_a[mac_id]);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}