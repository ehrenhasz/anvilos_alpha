{
  "module_name": "phy.c",
  "hash_id": "54d65c3555d5029ddeeb9ffaaec3fd5709192981ad0d69689649485786c69de8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtlwifi/rtl8821ae/phy.c",
  "human_readable_source": "\n \n\n#include \"../wifi.h\"\n#include \"../pci.h\"\n#include \"../ps.h\"\n#include \"reg.h\"\n#include \"def.h\"\n#include \"phy.h\"\n#include \"rf.h\"\n#include \"dm.h\"\n#include \"table.h\"\n#include \"trx.h\"\n#include \"../btcoexist/halbt_precomp.h\"\n#include \"hw.h\"\n#include \"../efuse.h\"\n\n#define READ_NEXT_PAIR(array_table, v1, v2, i) \\\n\tdo { \\\n\t\ti += 2; \\\n\t\tv1 = array_table[i]; \\\n\t\tv2 = array_table[i+1]; \\\n\t} while (0)\n\nstatic u32 _rtl8821ae_phy_rf_serial_read(struct ieee80211_hw *hw,\n\t\t\t\t\t enum radio_path rfpath, u32 offset);\nstatic void _rtl8821ae_phy_rf_serial_write(struct ieee80211_hw *hw,\n\t\t\t\t\t   enum radio_path rfpath, u32 offset,\n\t\t\t\t\t   u32 data);\nstatic u32 _rtl8821ae_phy_calculate_bit_shift(u32 bitmask)\n{\n\tif (WARN_ON_ONCE(!bitmask))\n\t\treturn 0;\n\n\treturn __ffs(bitmask);\n}\nstatic bool _rtl8821ae_phy_bb8821a_config_parafile(struct ieee80211_hw *hw);\n \nstatic bool _rtl8821ae_phy_config_mac_with_headerfile(struct ieee80211_hw *hw);\nstatic bool _rtl8821ae_phy_config_bb_with_headerfile(struct ieee80211_hw *hw,\n\t\t\t\t\t\t     u8 configtype);\nstatic bool _rtl8821ae_phy_config_bb_with_pgheaderfile(struct ieee80211_hw *hw,\n\t\t\t\t\t\t       u8 configtype);\nstatic void phy_init_bb_rf_register_definition(struct ieee80211_hw *hw);\n\nstatic long _rtl8821ae_phy_txpwr_idx_to_dbm(struct ieee80211_hw *hw,\n\t\t\t\t\t    enum wireless_mode wirelessmode,\n\t\t\t\t\t    u8 txpwridx);\nstatic void rtl8821ae_phy_set_rf_on(struct ieee80211_hw *hw);\nstatic void rtl8821ae_phy_set_io(struct ieee80211_hw *hw);\n\nstatic void rtl8812ae_fixspur(struct ieee80211_hw *hw,\n\t\t\t      enum ht_channel_width band_width, u8 channel)\n{\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\n\t \n\tif (IS_VENDOR_8812A_C_CUT(rtlhal->version)) {\n\t\tif (band_width == HT_CHANNEL_WIDTH_20_40 && channel == 11)\n\t\t\trtl_set_bbreg(hw, RRFMOD, 0xC00, 0x3);\n\t\t\t \n\t\telse\n\t\t\trtl_set_bbreg(hw, RRFMOD, 0xC00, 0x2);\n\t\t\t \n\n\t\t \n\t\tif (band_width == HT_CHANNEL_WIDTH_20 &&\n\t\t    (channel == 13 || channel == 14)) {\n\t\t\trtl_set_bbreg(hw, RRFMOD, 0x300, 0x3);\n\t\t\t \n\t\t\trtl_set_bbreg(hw, RADC_BUF_CLK, BIT(30), 1);\n\t\t\t \n\t\t} else if (band_width == HT_CHANNEL_WIDTH_20_40 &&\n\t\t\t   channel == 11) {\n\t\t\trtl_set_bbreg(hw, RADC_BUF_CLK, BIT(30), 1);\n\t\t\t \n\t\t} else if (band_width != HT_CHANNEL_WIDTH_80) {\n\t\t\trtl_set_bbreg(hw, RRFMOD, 0x300, 0x2);\n\t\t\t \n\t\t\trtl_set_bbreg(hw, RADC_BUF_CLK, BIT(30), 0);\n\t\t\t \n\t\t}\n\t} else if (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\n\t\t \n\t\tif (band_width == HT_CHANNEL_WIDTH_20 &&\n\t\t    (channel == 13 || channel == 14))\n\t\t\trtl_set_bbreg(hw, RRFMOD, 0x300, 0x3);\n\t\t\t \n\t\telse if (channel  <= 14)  \n\t\t\trtl_set_bbreg(hw, RRFMOD, 0x300, 0x2);\n\t\t\t \n\t}\n}\n\nu32 rtl8821ae_phy_query_bb_reg(struct ieee80211_hw *hw, u32 regaddr,\n\t\t\t       u32 bitmask)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 returnvalue, originalvalue, bitshift;\n\n\trtl_dbg(rtlpriv, COMP_RF, DBG_TRACE,\n\t\t\"regaddr(%#x), bitmask(%#x)\\n\",\n\t\tregaddr, bitmask);\n\toriginalvalue = rtl_read_dword(rtlpriv, regaddr);\n\tbitshift = _rtl8821ae_phy_calculate_bit_shift(bitmask);\n\treturnvalue = (originalvalue & bitmask) >> bitshift;\n\n\trtl_dbg(rtlpriv, COMP_RF, DBG_TRACE,\n\t\t\"BBR MASK=0x%x Addr[0x%x]=0x%x\\n\",\n\t\tbitmask, regaddr, originalvalue);\n\treturn returnvalue;\n}\n\nvoid rtl8821ae_phy_set_bb_reg(struct ieee80211_hw *hw,\n\t\t\t      u32 regaddr, u32 bitmask, u32 data)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 originalvalue, bitshift;\n\n\trtl_dbg(rtlpriv, COMP_RF, DBG_TRACE,\n\t\t\"regaddr(%#x), bitmask(%#x), data(%#x)\\n\",\n\t\tregaddr, bitmask, data);\n\n\tif (bitmask != MASKDWORD) {\n\t\toriginalvalue = rtl_read_dword(rtlpriv, regaddr);\n\t\tbitshift = _rtl8821ae_phy_calculate_bit_shift(bitmask);\n\t\tdata = ((originalvalue & (~bitmask)) |\n\t\t\t((data << bitshift) & bitmask));\n\t}\n\n\trtl_write_dword(rtlpriv, regaddr, data);\n\n\trtl_dbg(rtlpriv, COMP_RF, DBG_TRACE,\n\t\t\"regaddr(%#x), bitmask(%#x), data(%#x)\\n\",\n\t\tregaddr, bitmask, data);\n}\n\nu32 rtl8821ae_phy_query_rf_reg(struct ieee80211_hw *hw,\n\t\t\t       enum radio_path rfpath, u32 regaddr,\n\t\t\t       u32 bitmask)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 original_value, readback_value, bitshift;\n\n\trtl_dbg(rtlpriv, COMP_RF, DBG_TRACE,\n\t\t\"regaddr(%#x), rfpath(%#x), bitmask(%#x)\\n\",\n\t\tregaddr, rfpath, bitmask);\n\n\tspin_lock(&rtlpriv->locks.rf_lock);\n\n\toriginal_value = _rtl8821ae_phy_rf_serial_read(hw, rfpath, regaddr);\n\tbitshift = _rtl8821ae_phy_calculate_bit_shift(bitmask);\n\treadback_value = (original_value & bitmask) >> bitshift;\n\n\tspin_unlock(&rtlpriv->locks.rf_lock);\n\n\trtl_dbg(rtlpriv, COMP_RF, DBG_TRACE,\n\t\t\"regaddr(%#x), rfpath(%#x), bitmask(%#x), original_value(%#x)\\n\",\n\t\tregaddr, rfpath, bitmask, original_value);\n\n\treturn readback_value;\n}\n\nvoid rtl8821ae_phy_set_rf_reg(struct ieee80211_hw *hw,\n\t\t\t   enum radio_path rfpath,\n\t\t\t   u32 regaddr, u32 bitmask, u32 data)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 original_value, bitshift;\n\n\trtl_dbg(rtlpriv, COMP_RF, DBG_TRACE,\n\t\t\"regaddr(%#x), bitmask(%#x), data(%#x), rfpath(%#x)\\n\",\n\t\tregaddr, bitmask, data, rfpath);\n\n\tspin_lock(&rtlpriv->locks.rf_lock);\n\n\tif (bitmask != RFREG_OFFSET_MASK) {\n\t\toriginal_value =\n\t\t   _rtl8821ae_phy_rf_serial_read(hw, rfpath, regaddr);\n\t\tbitshift = _rtl8821ae_phy_calculate_bit_shift(bitmask);\n\t\tdata = ((original_value & (~bitmask)) | (data << bitshift));\n\t}\n\n\t_rtl8821ae_phy_rf_serial_write(hw, rfpath, regaddr, data);\n\n\tspin_unlock(&rtlpriv->locks.rf_lock);\n\n\trtl_dbg(rtlpriv, COMP_RF, DBG_TRACE,\n\t\t\"regaddr(%#x), bitmask(%#x), data(%#x), rfpath(%#x)\\n\",\n\t\t regaddr, bitmask, data, rfpath);\n}\n\nstatic u32 _rtl8821ae_phy_rf_serial_read(struct ieee80211_hw *hw,\n\t\t\t\t\t enum radio_path rfpath, u32 offset)\n{\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tbool is_pi_mode = false;\n\tu32 retvalue = 0;\n\n\t \n\tif (RT_CANNOT_IO(hw)) {\n\t\tpr_err(\"return all one\\n\");\n\t\treturn 0xFFFFFFFF;\n\t}\n\t \n\tif (offset != 0x0 &&\n\t    !((rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) ||\n\t    (IS_VENDOR_8812A_C_CUT(rtlhal->version))))\n\t\trtl_set_bbreg(hw, RCCAONSEC, 0x8, 1);\n\toffset &= 0xff;\n\n\tif (rfpath == RF90_PATH_A)\n\t\tis_pi_mode = (bool)rtl_get_bbreg(hw, 0xC00, 0x4);\n\telse if (rfpath == RF90_PATH_B)\n\t\tis_pi_mode = (bool)rtl_get_bbreg(hw, 0xE00, 0x4);\n\n\trtl_set_bbreg(hw, RHSSIREAD_8821AE, 0xff, offset);\n\n\tif ((rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) ||\n\t    (IS_VENDOR_8812A_C_CUT(rtlhal->version)))\n\t\tudelay(20);\n\n\tif (is_pi_mode) {\n\t\tif (rfpath == RF90_PATH_A)\n\t\t\tretvalue =\n\t\t\t  rtl_get_bbreg(hw, RA_PIREAD_8821A, BLSSIREADBACKDATA);\n\t\telse if (rfpath == RF90_PATH_B)\n\t\t\tretvalue =\n\t\t\t  rtl_get_bbreg(hw, RB_PIREAD_8821A, BLSSIREADBACKDATA);\n\t} else {\n\t\tif (rfpath == RF90_PATH_A)\n\t\t\tretvalue =\n\t\t\t  rtl_get_bbreg(hw, RA_SIREAD_8821A, BLSSIREADBACKDATA);\n\t\telse if (rfpath == RF90_PATH_B)\n\t\t\tretvalue =\n\t\t\t  rtl_get_bbreg(hw, RB_SIREAD_8821A, BLSSIREADBACKDATA);\n\t}\n\n\t \n\tif (offset != 0x0 &&\n\t    !((rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) ||\n\t    (IS_VENDOR_8812A_C_CUT(rtlhal->version))))\n\t\trtl_set_bbreg(hw, RCCAONSEC, 0x8, 0);\n\treturn retvalue;\n}\n\nstatic void _rtl8821ae_phy_rf_serial_write(struct ieee80211_hw *hw,\n\t\t\t\t\t   enum radio_path rfpath, u32 offset,\n\t\t\t\t\t   u32 data)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tstruct bb_reg_def *pphyreg = &rtlphy->phyreg_def[rfpath];\n\tu32 data_and_addr;\n\tu32 newoffset;\n\n\tif (RT_CANNOT_IO(hw)) {\n\t\tpr_err(\"stop\\n\");\n\t\treturn;\n\t}\n\toffset &= 0xff;\n\tnewoffset = offset;\n\tdata_and_addr = ((newoffset << 20) |\n\t\t\t (data & 0x000fffff)) & 0x0fffffff;\n\trtl_set_bbreg(hw, pphyreg->rf3wire_offset, MASKDWORD, data_and_addr);\n\trtl_dbg(rtlpriv, COMP_RF, DBG_TRACE,\n\t\t\"RFW-%d Addr[0x%x]=0x%x\\n\",\n\t\trfpath, pphyreg->rf3wire_offset, data_and_addr);\n}\n\nbool rtl8821ae_phy_mac_config(struct ieee80211_hw *hw)\n{\n\tbool rtstatus = 0;\n\n\trtstatus = _rtl8821ae_phy_config_mac_with_headerfile(hw);\n\n\treturn rtstatus;\n}\n\nbool rtl8821ae_phy_bb_config(struct ieee80211_hw *hw)\n{\n\tbool rtstatus = true;\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tu8 regval;\n\tu8 crystal_cap;\n\n\tphy_init_bb_rf_register_definition(hw);\n\n\tregval = rtl_read_byte(rtlpriv, REG_SYS_FUNC_EN);\n\tregval |= FEN_PCIEA;\n\trtl_write_byte(rtlpriv, REG_SYS_FUNC_EN, regval);\n\trtl_write_byte(rtlpriv, REG_SYS_FUNC_EN,\n\t\t       regval | FEN_BB_GLB_RSTN | FEN_BBRSTB);\n\n\trtl_write_byte(rtlpriv, REG_RF_CTRL, 0x7);\n\trtl_write_byte(rtlpriv, REG_OPT_CTRL + 2, 0x7);\n\n\trtstatus = _rtl8821ae_phy_bb8821a_config_parafile(hw);\n\n\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\n\t\tcrystal_cap = rtlefuse->crystalcap & 0x3F;\n\t\trtl_set_bbreg(hw, REG_MAC_PHY_CTRL, 0x7FF80000,\n\t\t\t      (crystal_cap | (crystal_cap << 6)));\n\t} else {\n\t\tcrystal_cap = rtlefuse->crystalcap & 0x3F;\n\t\trtl_set_bbreg(hw, REG_MAC_PHY_CTRL, 0xFFF000,\n\t\t\t      (crystal_cap | (crystal_cap << 6)));\n\t}\n\trtlphy->reg_837 = rtl_read_byte(rtlpriv, 0x837);\n\n\treturn rtstatus;\n}\n\nbool rtl8821ae_phy_rf_config(struct ieee80211_hw *hw)\n{\n\treturn rtl8821ae_phy_rf6052_config(hw);\n}\n\nstatic void _rtl8812ae_phy_set_rfe_reg_24g(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tu8 tmp;\n\n\tswitch (rtlhal->rfe_type) {\n\tcase 3:\n\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, BMASKDWORD, 0x54337770);\n\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD, 0x54337770);\n\t\trtl_set_bbreg(hw, RA_RFE_INV, BMASKRFEINV, 0x010);\n\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x010);\n\t\trtl_set_bbreg(hw, 0x900, 0x00000303, 0x1);\n\t\tbreak;\n\tcase 4:\n\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, BMASKDWORD, 0x77777777);\n\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD, 0x77777777);\n\t\trtl_set_bbreg(hw, RA_RFE_INV, BMASKRFEINV, 0x001);\n\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x001);\n\t\tbreak;\n\tcase 5:\n\t\trtl_write_byte(rtlpriv, RA_RFE_PINMUX + 2, 0x77);\n\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD, 0x77777777);\n\t\ttmp = rtl_read_byte(rtlpriv, RA_RFE_INV + 3);\n\t\trtl_write_byte(rtlpriv, RA_RFE_INV + 3, tmp & ~0x1);\n\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x000);\n\t\tbreak;\n\tcase 1:\n\t\tif (rtlpriv->btcoexist.bt_coexistence) {\n\t\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, 0xffffff, 0x777777);\n\t\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD,\n\t\t\t\t      0x77777777);\n\t\t\trtl_set_bbreg(hw, RA_RFE_INV, 0x33f00000, 0x000);\n\t\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x000);\n\t\t\tbreak;\n\t\t}\n\t\tfallthrough;\n\tcase 0:\n\tcase 2:\n\tdefault:\n\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, BMASKDWORD, 0x77777777);\n\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD, 0x77777777);\n\t\trtl_set_bbreg(hw, RA_RFE_INV, BMASKRFEINV, 0x000);\n\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x000);\n\t\tbreak;\n\t}\n}\n\nstatic void _rtl8812ae_phy_set_rfe_reg_5g(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tu8 tmp;\n\n\tswitch (rtlhal->rfe_type) {\n\tcase 0:\n\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, BMASKDWORD, 0x77337717);\n\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD, 0x77337717);\n\t\trtl_set_bbreg(hw, RA_RFE_INV, BMASKRFEINV, 0x010);\n\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x010);\n\t\tbreak;\n\tcase 1:\n\t\tif (rtlpriv->btcoexist.bt_coexistence) {\n\t\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, 0xffffff, 0x337717);\n\t\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD,\n\t\t\t\t      0x77337717);\n\t\t\trtl_set_bbreg(hw, RA_RFE_INV, 0x33f00000, 0x000);\n\t\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x000);\n\t\t} else {\n\t\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, BMASKDWORD,\n\t\t\t\t      0x77337717);\n\t\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD,\n\t\t\t\t      0x77337717);\n\t\t\trtl_set_bbreg(hw, RA_RFE_INV, BMASKRFEINV, 0x000);\n\t\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x000);\n\t\t}\n\t\tbreak;\n\tcase 3:\n\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, BMASKDWORD, 0x54337717);\n\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD, 0x54337717);\n\t\trtl_set_bbreg(hw, RA_RFE_INV, BMASKRFEINV, 0x010);\n\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x010);\n\t\trtl_set_bbreg(hw, 0x900, 0x00000303, 0x1);\n\t\tbreak;\n\tcase 5:\n\t\trtl_write_byte(rtlpriv, RA_RFE_PINMUX + 2, 0x33);\n\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD, 0x77337777);\n\t\ttmp = rtl_read_byte(rtlpriv, RA_RFE_INV + 3);\n\t\trtl_write_byte(rtlpriv, RA_RFE_INV + 3, tmp | 0x1);\n\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x010);\n\t\tbreak;\n\tcase 2:\n\tcase 4:\n\tdefault:\n\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, BMASKDWORD, 0x77337777);\n\t\trtl_set_bbreg(hw, RB_RFE_PINMUX, BMASKDWORD, 0x77337777);\n\t\trtl_set_bbreg(hw, RA_RFE_INV, BMASKRFEINV, 0x010);\n\t\trtl_set_bbreg(hw, RB_RFE_INV, BMASKRFEINV, 0x010);\n\t\tbreak;\n\t}\n}\n\nu32 phy_get_tx_swing_8812A(struct ieee80211_hw *hw, u8\tband,\n\t\t\t   u8 rf_path)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tstruct rtl_dm *rtldm = rtl_dm(rtlpriv);\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\n\ts8 reg_swing_2g = -1; \n\ts8 reg_swing_5g = -1; \n\ts8 swing_2g = -1 * reg_swing_2g;\n\ts8 swing_5g = -1 * reg_swing_5g;\n\tu32  out = 0x200;\n\tconst s8 auto_temp = -1;\n\n\trtl_dbg(rtlpriv, COMP_SCAN, DBG_LOUD,\n\t\t\"===> PHY_GetTXBBSwing_8812A, bbSwing_2G: %d, bbSwing_5G: %d,autoload_failflag=%d.\\n\",\n\t\t(int)swing_2g, (int)swing_5g,\n\t\t(int)rtlefuse->autoload_failflag);\n\n\tif (rtlefuse->autoload_failflag) {\n\t\tif (band == BAND_ON_2_4G) {\n\t\t\trtldm->swing_diff_2g = swing_2g;\n\t\t\tif (swing_2g == 0) {\n\t\t\t\tout = 0x200;  \n\t\t\t} else if (swing_2g == -3) {\n\t\t\t\tout = 0x16A;  \n\t\t\t} else if (swing_2g == -6) {\n\t\t\t\tout = 0x101;  \n\t\t\t} else if (swing_2g == -9) {\n\t\t\t\tout = 0x0B6;  \n\t\t\t} else {\n\t\t\t\trtldm->swing_diff_2g = 0;\n\t\t\t\tout = 0x200;\n\t\t\t}\n\t\t} else if (band == BAND_ON_5G) {\n\t\t\trtldm->swing_diff_5g = swing_5g;\n\t\t\tif (swing_5g == 0) {\n\t\t\t\tout = 0x200;  \n\t\t\t} else if (swing_5g == -3) {\n\t\t\t\tout = 0x16A;  \n\t\t\t} else if (swing_5g == -6) {\n\t\t\t\tout = 0x101;  \n\t\t\t} else if (swing_5g == -9) {\n\t\t\t\tout = 0x0B6;  \n\t\t\t} else {\n\t\t\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) {\n\t\t\t\t\trtldm->swing_diff_5g = -3;\n\t\t\t\t\tout = 0x16A;\n\t\t\t\t} else {\n\t\t\t\t\trtldm->swing_diff_5g = 0;\n\t\t\t\t\tout = 0x200;\n\t\t\t\t}\n\t\t\t}\n\t\t} else {\n\t\t\trtldm->swing_diff_2g = -3;\n\t\t\trtldm->swing_diff_5g = -3;\n\t\t\tout = 0x16A;  \n\t\t}\n\t} else {\n\t\tu32 swing = 0, swing_a = 0, swing_b = 0;\n\n\t\tif (band == BAND_ON_2_4G) {\n\t\t\tif (reg_swing_2g == auto_temp) {\n\t\t\t\tefuse_shadow_read(hw, 1, 0xC6, (u32 *)&swing);\n\t\t\t\tswing = (swing == 0xFF) ? 0x00 : swing;\n\t\t\t} else if (swing_2g ==  0) {\n\t\t\t\tswing = 0x00;  \n\t\t\t} else if (swing_2g == -3) {\n\t\t\t\tswing = 0x05;  \n\t\t\t} else if (swing_2g == -6) {\n\t\t\t\tswing = 0x0A;  \n\t\t\t} else if (swing_2g == -9) {\n\t\t\t\tswing = 0xFF;  \n\t\t\t} else {\n\t\t\t\tswing = 0x00;\n\t\t\t}\n\t\t} else {\n\t\t\tif (reg_swing_5g == auto_temp) {\n\t\t\t\tefuse_shadow_read(hw, 1, 0xC7, (u32 *)&swing);\n\t\t\t\tswing = (swing == 0xFF) ? 0x00 : swing;\n\t\t\t} else if (swing_5g ==  0) {\n\t\t\t\tswing = 0x00;  \n\t\t\t} else if (swing_5g == -3) {\n\t\t\t\tswing = 0x05;  \n\t\t\t} else if (swing_5g == -6) {\n\t\t\t\tswing = 0x0A;  \n\t\t\t} else if (swing_5g == -9) {\n\t\t\t\tswing = 0xFF;  \n\t\t\t} else {\n\t\t\t\tswing = 0x00;\n\t\t\t}\n\t\t}\n\n\t\tswing_a = (swing & 0x3) >> 0;  \n\t\tswing_b = (swing & 0xC) >> 2;  \n\t\trtl_dbg(rtlpriv, COMP_SCAN, DBG_LOUD,\n\t\t\t\"===> PHY_GetTXBBSwing_8812A, swingA: 0x%X, swingB: 0x%X\\n\",\n\t\t\tswing_a, swing_b);\n\n\t\t \n\t\tif (swing_a == 0x0) {\n\t\t\tif (band == BAND_ON_2_4G)\n\t\t\t\trtldm->swing_diff_2g = 0;\n\t\t\telse\n\t\t\t\trtldm->swing_diff_5g = 0;\n\t\t\tout = 0x200;  \n\t\t} else if (swing_a == 0x1) {\n\t\t\tif (band == BAND_ON_2_4G)\n\t\t\t\trtldm->swing_diff_2g = -3;\n\t\t\telse\n\t\t\t\trtldm->swing_diff_5g = -3;\n\t\t\tout = 0x16A;  \n\t\t} else if (swing_a == 0x2) {\n\t\t\tif (band == BAND_ON_2_4G)\n\t\t\t\trtldm->swing_diff_2g = -6;\n\t\t\telse\n\t\t\t\trtldm->swing_diff_5g = -6;\n\t\t\tout = 0x101;  \n\t\t} else if (swing_a == 0x3) {\n\t\t\tif (band == BAND_ON_2_4G)\n\t\t\t\trtldm->swing_diff_2g = -9;\n\t\t\telse\n\t\t\t\trtldm->swing_diff_5g = -9;\n\t\t\tout = 0x0B6;  \n\t\t}\n\t\t \n\t\tif (swing_b == 0x0) {\n\t\t\tif (band == BAND_ON_2_4G)\n\t\t\t\trtldm->swing_diff_2g = 0;\n\t\t\telse\n\t\t\t\trtldm->swing_diff_5g = 0;\n\t\t\tout = 0x200;  \n\t\t} else if (swing_b == 0x1) {\n\t\t\tif (band == BAND_ON_2_4G)\n\t\t\t\trtldm->swing_diff_2g = -3;\n\t\t\telse\n\t\t\t\trtldm->swing_diff_5g = -3;\n\t\t\tout = 0x16A;  \n\t\t} else if (swing_b == 0x2) {\n\t\t\tif (band == BAND_ON_2_4G)\n\t\t\t\trtldm->swing_diff_2g = -6;\n\t\t\telse\n\t\t\t\trtldm->swing_diff_5g = -6;\n\t\t\tout = 0x101;  \n\t\t} else if (swing_b == 0x3) {\n\t\t\tif (band == BAND_ON_2_4G)\n\t\t\t\trtldm->swing_diff_2g = -9;\n\t\t\telse\n\t\t\t\trtldm->swing_diff_5g = -9;\n\t\t\tout = 0x0B6;  \n\t\t}\n\t}\n\n\trtl_dbg(rtlpriv, COMP_SCAN, DBG_LOUD,\n\t\t\"<=== PHY_GetTXBBSwing_8812A, out = 0x%X\\n\", out);\n\treturn out;\n}\n\nvoid rtl8821ae_phy_switch_wirelessband(struct ieee80211_hw *hw, u8 band)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tstruct rtl_dm *rtldm = rtl_dm(rtlpriv);\n\tu8 current_band = rtlhal->current_bandtype;\n\ts8 bb_diff_between_band;\n\n\trtl8821ae_phy_query_bb_reg(hw, RTXPATH, 0xf0);\n\trtl8821ae_phy_query_bb_reg(hw, RCCK_RX, 0x0f000000);\n\trtlhal->current_bandtype = (enum band_type) band;\n\t \n\tif (rtlhal->current_bandtype == BAND_ON_2_4G) {\n\t\t \n\t\trtl_set_bbreg(hw, ROFDMCCKEN, BOFDMEN|BCCKEN, 0x03);\n\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) {\n\t\t\t \n\t\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, 0xF000, 0x7);\n\t\t\t \n\t\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, 0xF0, 0x7);\n\t\t}\n\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\n\t\t\t \n\t\t\trtl_set_bbreg(hw, 0x834, 0x3, 0x1);\n\t\t}\n\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) {\n\t\t\t \n\t\t\trtl_set_bbreg(hw, RA_TXSCALE, 0xF00, 0);\n\t\t} else {\n\t\t\t \n\t\t\trtl_set_bbreg(hw, 0x82c, 0x3, 0);\n\t\t}\n\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)\n\t\t\t_rtl8812ae_phy_set_rfe_reg_24g(hw);\n\n\t\trtl_set_bbreg(hw, RTXPATH, 0xf0, 0x1);\n\t\trtl_set_bbreg(hw, RCCK_RX, 0x0f000000, 0x1);\n\n\t\trtl_write_byte(rtlpriv, REG_CCK_CHECK, 0x0);\n\t} else { \n\t\tu16 count, reg_41a;\n\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) {\n\t\t\t \n\t\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, 0xF000, 0x5);\n\t\t\t \n\t\t\trtl_set_bbreg(hw, RA_RFE_PINMUX, 0xF0, 0x4);\n\t\t}\n\t\t \n\t\trtl_write_byte(rtlpriv, REG_CCK_CHECK, 0x80);\n\n\t\tcount = 0;\n\t\treg_41a = rtl_read_word(rtlpriv, REG_TXPKT_EMPTY);\n\t\trtl_dbg(rtlpriv, COMP_SCAN, DBG_LOUD,\n\t\t\t\"Reg41A value %d\\n\", reg_41a);\n\t\treg_41a &= 0x30;\n\t\twhile ((reg_41a != 0x30) && (count < 50)) {\n\t\t\tudelay(50);\n\t\t\trtl_dbg(rtlpriv, COMP_SCAN, DBG_LOUD, \"Delay 50us\\n\");\n\n\t\t\treg_41a = rtl_read_word(rtlpriv, REG_TXPKT_EMPTY);\n\t\t\treg_41a &= 0x30;\n\t\t\tcount++;\n\t\t\trtl_dbg(rtlpriv, COMP_SCAN, DBG_LOUD,\n\t\t\t\t\"Reg41A value %d\\n\", reg_41a);\n\t\t}\n\t\tif (count != 0)\n\t\t\trtl_dbg(rtlpriv, COMP_MLME, DBG_LOUD,\n\t\t\t\t\"PHY_SwitchWirelessBand8812(): Switch to 5G Band. Count = %d reg41A=0x%x\\n\",\n\t\t\t\tcount, reg_41a);\n\n\t\t \n\t\trtl_set_bbreg(hw, ROFDMCCKEN, BOFDMEN|BCCKEN, 0x03);\n\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\n\t\t\t \n\t\t\trtl_set_bbreg(hw, 0x834, 0x3, 0x2);\n\t\t}\n\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) {\n\t\t\t \n\t\t\t \n\t\t\trtl_set_bbreg(hw, RA_TXSCALE, 0xF00, 1);\n\t\t} else\n\t\t\t \n\t\t\trtl_set_bbreg(hw, 0x82c, 0x3, 1);\n\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)\n\t\t\t_rtl8812ae_phy_set_rfe_reg_5g(hw);\n\n\t\trtl_set_bbreg(hw, RTXPATH, 0xf0, 0);\n\t\trtl_set_bbreg(hw, RCCK_RX, 0x0f000000, 0xf);\n\n\t\trtl_dbg(rtlpriv, COMP_SCAN, DBG_LOUD,\n\t\t\t\"==>PHY_SwitchWirelessBand8812() BAND_ON_5G settings OFDM index 0x%x\\n\",\n\t\t\trtlpriv->dm.ofdm_index[RF90_PATH_A]);\n\t}\n\n\tif ((rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) ||\n\t    (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE)) {\n\t\t \n\t\trtl_set_bbreg(hw, RA_TXSCALE, 0xFFE00000,\n\t\t\t      phy_get_tx_swing_8812A(hw, band, RF90_PATH_A));\n\t\t \n\t\trtl_set_bbreg(hw, RB_TXSCALE, 0xFFE00000,\n\t\t\t      phy_get_tx_swing_8812A(hw, band, RF90_PATH_B));\n\n\t\t \n\t\tif (band != current_band) {\n\t\t\tbb_diff_between_band =\n\t\t\t\t(rtldm->swing_diff_2g - rtldm->swing_diff_5g);\n\t\t\tbb_diff_between_band = (band == BAND_ON_2_4G) ?\n\t\t\t\t\t\tbb_diff_between_band :\n\t\t\t\t\t\t(-1 * bb_diff_between_band);\n\t\t\trtldm->default_ofdm_index += bb_diff_between_band * 2;\n\t\t}\n\t\trtl8821ae_dm_clear_txpower_tracking_state(hw);\n\t}\n\n\trtl_dbg(rtlpriv, COMP_SCAN, DBG_TRACE,\n\t\t\"<==%s():Switch Band OK.\\n\", __func__);\n\treturn;\n}\n\nstatic bool _rtl8821ae_check_positive(struct ieee80211_hw *hw,\n\t\t\t\t      const u32 condition1,\n\t\t\t\t      const u32 condition2)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\n\tu32 cut_ver = ((rtlhal->version & CHIP_VER_RTL_MASK)\n\t\t\t\t\t>> CHIP_VER_RTL_SHIFT);\n\tu32 intf = (rtlhal->interface == INTF_USB ? BIT(1) : BIT(0));\n\n\tu8  board_type = ((rtlhal->board_type & BIT(4)) >> 4) << 0 |  \n\t\t\t ((rtlhal->board_type & BIT(3)) >> 3) << 1 |  \n\t\t\t ((rtlhal->board_type & BIT(7)) >> 7) << 2 |  \n\t\t\t ((rtlhal->board_type & BIT(6)) >> 6) << 3 |  \n\t\t\t ((rtlhal->board_type & BIT(2)) >> 2) << 4;   \n\n\tu32 cond1 = condition1, cond2 = condition2;\n\tu32 driver1 = cut_ver << 24 |\t \n\t\t      0 << 20 |\t\t\t \n\t\t      0x04 << 16 |\t\t \n\t\t      rtlhal->package_type << 12 |\n\t\t      intf << 8 |\t\t\t \n\t\t      board_type;\n\n\tu32 driver2 = rtlhal->type_glna <<  0 |\n\t\t      rtlhal->type_gpa  <<  8 |\n\t\t      rtlhal->type_alna << 16 |\n\t\t      rtlhal->type_apa  << 24;\n\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\"===> [8812A] CheckPositive (cond1, cond2) = (0x%X 0x%X)\\n\",\n\t\tcond1, cond2);\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\"===> [8812A] CheckPositive (driver1, driver2) = (0x%X 0x%X)\\n\",\n\t\tdriver1, driver2);\n\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\"\t(Platform, Interface) = (0x%X, 0x%X)\\n\", 0x04, intf);\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\"\t(Board, Package) = (0x%X, 0x%X)\\n\",\n\t\trtlhal->board_type, rtlhal->package_type);\n\n\t \n\t \n\n\tif (((cond1 & 0x0000F000) != 0) && ((cond1 & 0x0000F000) !=\n\t\t(driver1 & 0x0000F000)))\n\t\treturn false;\n\tif (((cond1 & 0x0F000000) != 0) && ((cond1 & 0x0F000000) !=\n\t\t(driver1 & 0x0F000000)))\n\t\treturn false;\n\n\t \n\t \n\n\tcond1   &= 0x00FF0FFF;\n\tdriver1 &= 0x00FF0FFF;\n\n\tif ((cond1 & driver1) == cond1) {\n\t\tu32 mask = 0;\n\n\t\tif ((cond1 & 0x0F) == 0)  \n\t\t\treturn true;\n\n\t\tif ((cond1 & BIT(0)) != 0)  \n\t\t\tmask |= 0x000000FF;\n\t\tif ((cond1 & BIT(1)) != 0)  \n\t\t\tmask |= 0x0000FF00;\n\t\tif ((cond1 & BIT(2)) != 0)  \n\t\t\tmask |= 0x00FF0000;\n\t\tif ((cond1 & BIT(3)) != 0)  \n\t\t\tmask |= 0xFF000000;\n\n\t\t \n\t\tif ((cond2 & mask) == (driver2 & mask))\n\t\t\treturn true;\n\t\telse\n\t\t\treturn false;\n\t} else\n\t\treturn false;\n}\n\nstatic bool _rtl8821ae_check_condition(struct ieee80211_hw *hw,\n\t\t\t\t       const u32 condition)\n{\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\n\tu32 _board = rtlefuse->board_type;  \n\tu32 _interface = 0x01;  \n\tu32 _platform = 0x08; \n\tu32 cond = condition;\n\n\tif (condition == 0xCDCDCDCD)\n\t\treturn true;\n\n\tcond = condition & 0xFF;\n\tif ((_board != cond) && cond != 0xFF)\n\t\treturn false;\n\n\tcond = condition & 0xFF00;\n\tcond = cond >> 8;\n\tif ((_interface & cond) == 0 && cond != 0x07)\n\t\treturn false;\n\n\tcond = condition & 0xFF0000;\n\tcond = cond >> 16;\n\tif ((_platform & cond) == 0 && cond != 0x0F)\n\t\treturn false;\n\treturn true;\n}\n\nstatic void _rtl8821ae_config_rf_reg(struct ieee80211_hw *hw,\n\t\t\t\t     u32 addr, u32 data,\n\t\t\t\t     enum radio_path rfpath, u32 regaddr)\n{\n\tif (addr == 0xfe || addr == 0xffe) {\n\t\t \n\t\tmdelay(50);\n\t} else {\n\t\trtl_set_rfreg(hw, rfpath, regaddr, RFREG_OFFSET_MASK, data);\n\t\tudelay(1);\n\t}\n}\n\nstatic void _rtl8821ae_config_rf_radio_a(struct ieee80211_hw *hw,\n\t\t\t\t\t u32 addr, u32 data)\n{\n\tu32 content = 0x1000;  \n\tu32 maskforphyset = (u32)(content & 0xE000);\n\n\t_rtl8821ae_config_rf_reg(hw, addr, data,\n\t\t\t\t RF90_PATH_A, addr | maskforphyset);\n}\n\nstatic void _rtl8821ae_config_rf_radio_b(struct ieee80211_hw *hw,\n\t\t\t\t\t u32 addr, u32 data)\n{\n\tu32 content = 0x1001;  \n\tu32 maskforphyset = (u32)(content & 0xE000);\n\n\t_rtl8821ae_config_rf_reg(hw, addr, data,\n\t\t\t\t RF90_PATH_B, addr | maskforphyset);\n}\n\nstatic void _rtl8821ae_config_bb_reg(struct ieee80211_hw *hw,\n\t\t\t\t     u32 addr, u32 data)\n{\n\tif (addr == 0xfe)\n\t\tmdelay(50);\n\telse if (addr == 0xfd)\n\t\tmdelay(5);\n\telse if (addr == 0xfc)\n\t\tmdelay(1);\n\telse if (addr == 0xfb)\n\t\tudelay(50);\n\telse if (addr == 0xfa)\n\t\tudelay(5);\n\telse if (addr == 0xf9)\n\t\tudelay(1);\n\telse\n\t\trtl_set_bbreg(hw, addr, MASKDWORD, data);\n\n\tudelay(1);\n}\n\nstatic void _rtl8821ae_phy_init_tx_power_by_rate(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 band, rfpath, txnum, rate_section;\n\n\tfor (band = BAND_ON_2_4G; band <= BAND_ON_5G; ++band)\n\t\tfor (rfpath = 0; rfpath < TX_PWR_BY_RATE_NUM_RF; ++rfpath)\n\t\t\tfor (txnum = 0; txnum < TX_PWR_BY_RATE_NUM_RF; ++txnum)\n\t\t\t\tfor (rate_section = 0;\n\t\t\t\t     rate_section < TX_PWR_BY_RATE_NUM_SECTION;\n\t\t\t\t     ++rate_section)\n\t\t\t\t\trtlphy->tx_power_by_rate_offset[band]\n\t\t\t\t\t    [rfpath][txnum][rate_section] = 0;\n}\n\nstatic void _rtl8821ae_phy_set_txpower_by_rate_base(struct ieee80211_hw *hw,\n\t\t\t\t\t  u8 band, u8 path,\n\t\t\t\t\t  u8 rate_section,\n\t\t\t\t\t  u8 txnum, u8 value)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\n\tif (path > RF90_PATH_D) {\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\"Invalid Rf Path %d in phy_SetTxPowerByRatBase()\\n\", path);\n\t\treturn;\n\t}\n\n\tif (band == BAND_ON_2_4G) {\n\t\tswitch (rate_section) {\n\t\tcase CCK:\n\t\t\trtlphy->txpwr_by_rate_base_24g[path][txnum][0] = value;\n\t\t\tbreak;\n\t\tcase OFDM:\n\t\t\trtlphy->txpwr_by_rate_base_24g[path][txnum][1] = value;\n\t\t\tbreak;\n\t\tcase HT_MCS0_MCS7:\n\t\t\trtlphy->txpwr_by_rate_base_24g[path][txnum][2] = value;\n\t\t\tbreak;\n\t\tcase HT_MCS8_MCS15:\n\t\t\trtlphy->txpwr_by_rate_base_24g[path][txnum][3] = value;\n\t\t\tbreak;\n\t\tcase VHT_1SSMCS0_1SSMCS9:\n\t\t\trtlphy->txpwr_by_rate_base_24g[path][txnum][4] = value;\n\t\t\tbreak;\n\t\tcase VHT_2SSMCS0_2SSMCS9:\n\t\t\trtlphy->txpwr_by_rate_base_24g[path][txnum][5] = value;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\t\"Invalid RateSection %d in Band 2.4G,Rf Path %d, %dTx in PHY_SetTxPowerByRateBase()\\n\",\n\t\t\t\trate_section, path, txnum);\n\t\t\tbreak;\n\t\t}\n\t} else if (band == BAND_ON_5G) {\n\t\tswitch (rate_section) {\n\t\tcase OFDM:\n\t\t\trtlphy->txpwr_by_rate_base_5g[path][txnum][0] = value;\n\t\t\tbreak;\n\t\tcase HT_MCS0_MCS7:\n\t\t\trtlphy->txpwr_by_rate_base_5g[path][txnum][1] = value;\n\t\t\tbreak;\n\t\tcase HT_MCS8_MCS15:\n\t\t\trtlphy->txpwr_by_rate_base_5g[path][txnum][2] = value;\n\t\t\tbreak;\n\t\tcase VHT_1SSMCS0_1SSMCS9:\n\t\t\trtlphy->txpwr_by_rate_base_5g[path][txnum][3] = value;\n\t\t\tbreak;\n\t\tcase VHT_2SSMCS0_2SSMCS9:\n\t\t\trtlphy->txpwr_by_rate_base_5g[path][txnum][4] = value;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\t\"Invalid RateSection %d in Band 5G, Rf Path %d, %dTx in PHY_SetTxPowerByRateBase()\\n\",\n\t\t\t\trate_section, path, txnum);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\"Invalid Band %d in PHY_SetTxPowerByRateBase()\\n\", band);\n\t}\n}\n\nstatic u8 _rtl8821ae_phy_get_txpower_by_rate_base(struct ieee80211_hw *hw,\n\t\t\t\t\t\t  u8 band, u8 path,\n\t\t\t\t\t\t  u8 txnum, u8 rate_section)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 value = 0;\n\n\tif (path > RF90_PATH_D) {\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\"Invalid Rf Path %d in PHY_GetTxPowerByRateBase()\\n\",\n\t\t\tpath);\n\t\treturn 0;\n\t}\n\n\tif (band == BAND_ON_2_4G) {\n\t\tswitch (rate_section) {\n\t\tcase CCK:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_24g[path][txnum][0];\n\t\t\tbreak;\n\t\tcase OFDM:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_24g[path][txnum][1];\n\t\t\tbreak;\n\t\tcase HT_MCS0_MCS7:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_24g[path][txnum][2];\n\t\t\tbreak;\n\t\tcase HT_MCS8_MCS15:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_24g[path][txnum][3];\n\t\t\tbreak;\n\t\tcase VHT_1SSMCS0_1SSMCS9:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_24g[path][txnum][4];\n\t\t\tbreak;\n\t\tcase VHT_2SSMCS0_2SSMCS9:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_24g[path][txnum][5];\n\t\t\tbreak;\n\t\tdefault:\n\t\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\t\"Invalid RateSection %d in Band 2.4G, Rf Path %d, %dTx in PHY_GetTxPowerByRateBase()\\n\",\n\t\t\t\trate_section, path, txnum);\n\t\t\tbreak;\n\t\t}\n\t} else if (band == BAND_ON_5G) {\n\t\tswitch (rate_section) {\n\t\tcase OFDM:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_5g[path][txnum][0];\n\t\t\tbreak;\n\t\tcase HT_MCS0_MCS7:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_5g[path][txnum][1];\n\t\t\tbreak;\n\t\tcase HT_MCS8_MCS15:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_5g[path][txnum][2];\n\t\t\tbreak;\n\t\tcase VHT_1SSMCS0_1SSMCS9:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_5g[path][txnum][3];\n\t\t\tbreak;\n\t\tcase VHT_2SSMCS0_2SSMCS9:\n\t\t\tvalue = rtlphy->txpwr_by_rate_base_5g[path][txnum][4];\n\t\t\tbreak;\n\t\tdefault:\n\t\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\t\"Invalid RateSection %d in Band 5G, Rf Path %d, %dTx in PHY_GetTxPowerByRateBase()\\n\",\n\t\t\t\trate_section, path, txnum);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\"Invalid Band %d in PHY_GetTxPowerByRateBase()\\n\", band);\n\t}\n\n\treturn value;\n}\n\nstatic void _rtl8821ae_phy_store_txpower_by_rate_base(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu16 rawvalue = 0;\n\tu8 base = 0, path = 0;\n\n\tfor (path = RF90_PATH_A; path <= RF90_PATH_B; ++path) {\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][path][RF_1TX][0] >> 24) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_2_4G, path, CCK, RF_1TX, base);\n\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][path][RF_1TX][2] >> 24) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_2_4G, path, OFDM, RF_1TX, base);\n\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][path][RF_1TX][4] >> 24) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_2_4G, path, HT_MCS0_MCS7, RF_1TX, base);\n\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][path][RF_2TX][6] >> 24) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_2_4G, path, HT_MCS8_MCS15, RF_2TX, base);\n\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][path][RF_1TX][8] >> 24) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_2_4G, path, VHT_1SSMCS0_1SSMCS9, RF_1TX, base);\n\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][path][RF_2TX][11] >> 8) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_2_4G, path, VHT_2SSMCS0_2SSMCS9, RF_2TX, base);\n\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_5G][path][RF_1TX][2] >> 24) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_5G, path, OFDM, RF_1TX, base);\n\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_5G][path][RF_1TX][4] >> 24) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_5G, path, HT_MCS0_MCS7, RF_1TX, base);\n\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_5G][path][RF_2TX][6] >> 24) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_5G, path, HT_MCS8_MCS15, RF_2TX, base);\n\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_5G][path][RF_1TX][8] >> 24) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_5G, path, VHT_1SSMCS0_1SSMCS9, RF_1TX, base);\n\n\t\trawvalue = (u16)(rtlphy->tx_power_by_rate_offset[BAND_ON_5G][path][RF_2TX][11] >> 8) & 0xFF;\n\t\tbase = (rawvalue >> 4) * 10 + (rawvalue & 0xF);\n\t\t_rtl8821ae_phy_set_txpower_by_rate_base(hw, BAND_ON_5G, path, VHT_2SSMCS0_2SSMCS9, RF_2TX, base);\n\t}\n}\n\nstatic void _phy_convert_txpower_dbm_to_relative_value(u32 *data, u8 start,\n\t\t\t\t\t\tu8 end, u8 base_val)\n{\n\tint i;\n\tu8 temp_value = 0;\n\tu32 temp_data = 0;\n\n\tfor (i = 3; i >= 0; --i) {\n\t\tif (i >= start && i <= end) {\n\t\t\t \n\t\t\ttemp_value = (u8)(*data >> (i * 8)) & 0xF;\n\t\t\ttemp_value += ((u8)((*data >> (i * 8 + 4)) & 0xF)) * 10;\n\n\t\t\t \n\t\t\ttemp_value = (temp_value > base_val) ? temp_value -\n\t\t\t\t\tbase_val : base_val - temp_value;\n\t\t} else {\n\t\t\ttemp_value = (u8)(*data >> (i * 8)) & 0xFF;\n\t\t}\n\t\ttemp_data <<= 8;\n\t\ttemp_data |= temp_value;\n\t}\n\t*data = temp_data;\n}\n\nstatic void _rtl8812ae_phy_cross_reference_ht_and_vht_txpower_limit(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 regulation, bw, channel, rate_section;\n\ts8 temp_pwrlmt = 0;\n\n\tfor (regulation = 0; regulation < MAX_REGULATION_NUM; ++regulation) {\n\t\tfor (bw = 0; bw < MAX_5G_BANDWIDTH_NUM; ++bw) {\n\t\t\tfor (channel = 0; channel < CHANNEL_MAX_NUMBER_5G; ++channel) {\n\t\t\t\tfor (rate_section = 0; rate_section < MAX_RATE_SECTION_NUM; ++rate_section) {\n\t\t\t\t\ttemp_pwrlmt = rtlphy->txpwr_limit_5g[regulation]\n\t\t\t\t\t\t[bw][rate_section][channel][RF90_PATH_A];\n\t\t\t\t\tif (temp_pwrlmt == MAX_POWER_INDEX) {\n\t\t\t\t\t\tif (bw == 0 || bw == 1) {  \n\t\t\t\t\t\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\t\t\t\t\t\t\"No power limit table of the specified band %d, bandwidth %d, ratesection %d, channel %d, rf path %d\\n\",\n\t\t\t\t\t\t\t\t1, bw, rate_section, channel, RF90_PATH_A);\n\t\t\t\t\t\t\tif (rate_section == 2) {\n\t\t\t\t\t\t\t\trtlphy->txpwr_limit_5g[regulation][bw][2][channel][RF90_PATH_A] =\n\t\t\t\t\t\t\t\t\trtlphy->txpwr_limit_5g[regulation][bw][4][channel][RF90_PATH_A];\n\t\t\t\t\t\t\t} else if (rate_section == 4) {\n\t\t\t\t\t\t\t\trtlphy->txpwr_limit_5g[regulation][bw][4][channel][RF90_PATH_A] =\n\t\t\t\t\t\t\t\t\trtlphy->txpwr_limit_5g[regulation][bw][2][channel][RF90_PATH_A];\n\t\t\t\t\t\t\t} else if (rate_section == 3) {\n\t\t\t\t\t\t\t\trtlphy->txpwr_limit_5g[regulation][bw][3][channel][RF90_PATH_A] =\n\t\t\t\t\t\t\t\t\trtlphy->txpwr_limit_5g[regulation][bw][5][channel][RF90_PATH_A];\n\t\t\t\t\t\t\t} else if (rate_section == 5) {\n\t\t\t\t\t\t\t\trtlphy->txpwr_limit_5g[regulation][bw][5][channel][RF90_PATH_A] =\n\t\t\t\t\t\t\t\t\trtlphy->txpwr_limit_5g[regulation][bw][3][channel][RF90_PATH_A];\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\t\t\t\t\t\t\"use other value %d\\n\",\n\t\t\t\t\t\t\t\ttemp_pwrlmt);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n}\n\nstatic u8 _rtl8812ae_phy_get_txpower_by_rate_base_index(struct ieee80211_hw *hw,\n\t\t\t\t\t\t   enum band_type band, u8 rate)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 index = 0;\n\tif (band == BAND_ON_2_4G) {\n\t\tswitch (rate) {\n\t\tcase MGN_1M:\n\t\tcase MGN_2M:\n\t\tcase MGN_5_5M:\n\t\tcase MGN_11M:\n\t\t\tindex = 0;\n\t\t\tbreak;\n\n\t\tcase MGN_6M:\n\t\tcase MGN_9M:\n\t\tcase MGN_12M:\n\t\tcase MGN_18M:\n\t\tcase MGN_24M:\n\t\tcase MGN_36M:\n\t\tcase MGN_48M:\n\t\tcase MGN_54M:\n\t\t\tindex = 1;\n\t\t\tbreak;\n\n\t\tcase MGN_MCS0:\n\t\tcase MGN_MCS1:\n\t\tcase MGN_MCS2:\n\t\tcase MGN_MCS3:\n\t\tcase MGN_MCS4:\n\t\tcase MGN_MCS5:\n\t\tcase MGN_MCS6:\n\t\tcase MGN_MCS7:\n\t\t\tindex = 2;\n\t\t\tbreak;\n\n\t\tcase MGN_MCS8:\n\t\tcase MGN_MCS9:\n\t\tcase MGN_MCS10:\n\t\tcase MGN_MCS11:\n\t\tcase MGN_MCS12:\n\t\tcase MGN_MCS13:\n\t\tcase MGN_MCS14:\n\t\tcase MGN_MCS15:\n\t\t\tindex = 3;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\t\"Wrong rate 0x%x to obtain index in 2.4G in PHY_GetTxPowerByRateBaseIndex()\\n\",\n\t\t\t\trate);\n\t\t\tbreak;\n\t\t}\n\t} else if (band == BAND_ON_5G) {\n\t\tswitch (rate) {\n\t\tcase MGN_6M:\n\t\tcase MGN_9M:\n\t\tcase MGN_12M:\n\t\tcase MGN_18M:\n\t\tcase MGN_24M:\n\t\tcase MGN_36M:\n\t\tcase MGN_48M:\n\t\tcase MGN_54M:\n\t\t\tindex = 0;\n\t\t\tbreak;\n\n\t\tcase MGN_MCS0:\n\t\tcase MGN_MCS1:\n\t\tcase MGN_MCS2:\n\t\tcase MGN_MCS3:\n\t\tcase MGN_MCS4:\n\t\tcase MGN_MCS5:\n\t\tcase MGN_MCS6:\n\t\tcase MGN_MCS7:\n\t\t\tindex = 1;\n\t\t\tbreak;\n\n\t\tcase MGN_MCS8:\n\t\tcase MGN_MCS9:\n\t\tcase MGN_MCS10:\n\t\tcase MGN_MCS11:\n\t\tcase MGN_MCS12:\n\t\tcase MGN_MCS13:\n\t\tcase MGN_MCS14:\n\t\tcase MGN_MCS15:\n\t\t\tindex = 2;\n\t\t\tbreak;\n\n\t\tcase MGN_VHT1SS_MCS0:\n\t\tcase MGN_VHT1SS_MCS1:\n\t\tcase MGN_VHT1SS_MCS2:\n\t\tcase MGN_VHT1SS_MCS3:\n\t\tcase MGN_VHT1SS_MCS4:\n\t\tcase MGN_VHT1SS_MCS5:\n\t\tcase MGN_VHT1SS_MCS6:\n\t\tcase MGN_VHT1SS_MCS7:\n\t\tcase MGN_VHT1SS_MCS8:\n\t\tcase MGN_VHT1SS_MCS9:\n\t\t\tindex = 3;\n\t\t\tbreak;\n\n\t\tcase MGN_VHT2SS_MCS0:\n\t\tcase MGN_VHT2SS_MCS1:\n\t\tcase MGN_VHT2SS_MCS2:\n\t\tcase MGN_VHT2SS_MCS3:\n\t\tcase MGN_VHT2SS_MCS4:\n\t\tcase MGN_VHT2SS_MCS5:\n\t\tcase MGN_VHT2SS_MCS6:\n\t\tcase MGN_VHT2SS_MCS7:\n\t\tcase MGN_VHT2SS_MCS8:\n\t\tcase MGN_VHT2SS_MCS9:\n\t\t\tindex = 4;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\t\"Wrong rate 0x%x to obtain index in 5G in PHY_GetTxPowerByRateBaseIndex()\\n\",\n\t\t\t\trate);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn index;\n}\n\nstatic void _rtl8812ae_phy_convert_txpower_limit_to_power_index(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 bw40_pwr_base_dbm2_4G, bw40_pwr_base_dbm5G;\n\tu8 regulation, bw, channel, rate_section;\n\tu8 base_index2_4G = 0;\n\tu8 base_index5G = 0;\n\ts8 temp_value = 0, temp_pwrlmt = 0;\n\tu8 rf_path = 0;\n\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\"=====> _rtl8812ae_phy_convert_txpower_limit_to_power_index()\\n\");\n\n\t_rtl8812ae_phy_cross_reference_ht_and_vht_txpower_limit(hw);\n\n\tfor (regulation = 0; regulation < MAX_REGULATION_NUM; ++regulation) {\n\t\tfor (bw = 0; bw < MAX_2_4G_BANDWIDTH_NUM; ++bw) {\n\t\t\tfor (channel = 0; channel < CHANNEL_MAX_NUMBER_2G; ++channel) {\n\t\t\t\tfor (rate_section = 0; rate_section < MAX_RATE_SECTION_NUM; ++rate_section) {\n\t\t\t\t\t \n\t\t\t\t\tif (rate_section == 0) {  \n\t\t\t\t\t\tbase_index2_4G =\n\t\t\t\t\t\t\t_rtl8812ae_phy_get_txpower_by_rate_base_index(hw,\n\t\t\t\t\t\t\tBAND_ON_2_4G, MGN_11M);\n\t\t\t\t\t} else if (rate_section == 1) {  \n\t\t\t\t\t\tbase_index2_4G =\n\t\t\t\t\t\t\t_rtl8812ae_phy_get_txpower_by_rate_base_index(hw,\n\t\t\t\t\t\t\tBAND_ON_2_4G, MGN_54M);\n\t\t\t\t\t} else if (rate_section == 2) {  \n\t\t\t\t\t\tbase_index2_4G =\n\t\t\t\t\t\t\t_rtl8812ae_phy_get_txpower_by_rate_base_index(hw,\n\t\t\t\t\t\t\tBAND_ON_2_4G, MGN_MCS7);\n\t\t\t\t\t} else if (rate_section == 3) {  \n\t\t\t\t\t\tbase_index2_4G =\n\t\t\t\t\t\t\t_rtl8812ae_phy_get_txpower_by_rate_base_index(hw,\n\t\t\t\t\t\t\tBAND_ON_2_4G, MGN_MCS15);\n\t\t\t\t\t}\n\n\t\t\t\t\ttemp_pwrlmt = rtlphy->txpwr_limit_2_4g[regulation]\n\t\t\t\t\t\t[bw][rate_section][channel][RF90_PATH_A];\n\n\t\t\t\t\tfor (rf_path = RF90_PATH_A;\n\t\t\t\t\t\trf_path < MAX_RF_PATH_NUM;\n\t\t\t\t\t\t++rf_path) {\n\t\t\t\t\t\tif (rate_section == 3)\n\t\t\t\t\t\t\tbw40_pwr_base_dbm2_4G =\n\t\t\t\t\t\t\trtlphy->txpwr_by_rate_base_24g[rf_path][RF_2TX][base_index2_4G];\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tbw40_pwr_base_dbm2_4G =\n\t\t\t\t\t\t\trtlphy->txpwr_by_rate_base_24g[rf_path][RF_1TX][base_index2_4G];\n\n\t\t\t\t\t\tif (temp_pwrlmt != MAX_POWER_INDEX) {\n\t\t\t\t\t\t\ttemp_value = temp_pwrlmt - bw40_pwr_base_dbm2_4G;\n\t\t\t\t\t\t\trtlphy->txpwr_limit_2_4g[regulation]\n\t\t\t\t\t\t\t\t[bw][rate_section][channel][rf_path] =\n\t\t\t\t\t\t\t\ttemp_value;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\t\t\t\t\t\"TxPwrLimit_2_4G[regulation %d][bw %d][rateSection %d][channel %d] = %d\\n(TxPwrLimit in dBm %d - BW40PwrLmt2_4G[channel %d][rfpath %d] %d)\\n\",\n\t\t\t\t\t\t\tregulation, bw, rate_section, channel,\n\t\t\t\t\t\t\trtlphy->txpwr_limit_2_4g[regulation][bw]\n\t\t\t\t\t\t\t[rate_section][channel][rf_path], (temp_pwrlmt == 63)\n\t\t\t\t\t\t\t? 0 : temp_pwrlmt/2, channel, rf_path,\n\t\t\t\t\t\t\tbw40_pwr_base_dbm2_4G);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\tfor (regulation = 0; regulation < MAX_REGULATION_NUM; ++regulation) {\n\t\tfor (bw = 0; bw < MAX_5G_BANDWIDTH_NUM; ++bw) {\n\t\t\tfor (channel = 0; channel < CHANNEL_MAX_NUMBER_5G; ++channel) {\n\t\t\t\tfor (rate_section = 0; rate_section < MAX_RATE_SECTION_NUM; ++rate_section) {\n\t\t\t\t\t \n\t\t\t\t\tif (rate_section == 1) {  \n\t\t\t\t\t\tbase_index5G =\n\t\t\t\t\t\t\t_rtl8812ae_phy_get_txpower_by_rate_base_index(hw,\n\t\t\t\t\t\t\tBAND_ON_5G, MGN_54M);\n\t\t\t\t\t} else if (rate_section == 2) {  \n\t\t\t\t\t\tbase_index5G =\n\t\t\t\t\t\t\t_rtl8812ae_phy_get_txpower_by_rate_base_index(hw,\n\t\t\t\t\t\t\tBAND_ON_5G, MGN_MCS7);\n\t\t\t\t\t} else if (rate_section == 3) {  \n\t\t\t\t\t\tbase_index5G =\n\t\t\t\t\t\t\t_rtl8812ae_phy_get_txpower_by_rate_base_index(hw,\n\t\t\t\t\t\t\tBAND_ON_5G, MGN_MCS15);\n\t\t\t\t\t} else if (rate_section == 4) {  \n\t\t\t\t\t\tbase_index5G =\n\t\t\t\t\t\t\t_rtl8812ae_phy_get_txpower_by_rate_base_index(hw,\n\t\t\t\t\t\t\tBAND_ON_5G, MGN_VHT1SS_MCS7);\n\t\t\t\t\t} else if (rate_section == 5) {  \n\t\t\t\t\t\tbase_index5G =\n\t\t\t\t\t\t\t_rtl8812ae_phy_get_txpower_by_rate_base_index(hw,\n\t\t\t\t\t\t\tBAND_ON_5G, MGN_VHT2SS_MCS7);\n\t\t\t\t\t}\n\n\t\t\t\t\ttemp_pwrlmt = rtlphy->txpwr_limit_5g[regulation]\n\t\t\t\t\t\t[bw][rate_section][channel]\n\t\t\t\t\t\t[RF90_PATH_A];\n\n\t\t\t\t\tfor (rf_path = RF90_PATH_A;\n\t\t\t\t\t     rf_path < MAX_RF_PATH_NUM;\n\t\t\t\t\t     ++rf_path) {\n\t\t\t\t\t\tif (rate_section == 3 || rate_section == 5)\n\t\t\t\t\t\t\tbw40_pwr_base_dbm5G =\n\t\t\t\t\t\t\trtlphy->txpwr_by_rate_base_5g[rf_path]\n\t\t\t\t\t\t\t[RF_2TX][base_index5G];\n\t\t\t\t\t\telse\n\t\t\t\t\t\t\tbw40_pwr_base_dbm5G =\n\t\t\t\t\t\t\trtlphy->txpwr_by_rate_base_5g[rf_path]\n\t\t\t\t\t\t\t[RF_1TX][base_index5G];\n\n\t\t\t\t\t\tif (temp_pwrlmt != MAX_POWER_INDEX) {\n\t\t\t\t\t\t\ttemp_value =\n\t\t\t\t\t\t\t\ttemp_pwrlmt - bw40_pwr_base_dbm5G;\n\t\t\t\t\t\t\trtlphy->txpwr_limit_5g[regulation]\n\t\t\t\t\t\t\t\t[bw][rate_section][channel]\n\t\t\t\t\t\t\t\t[rf_path] = temp_value;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\t\t\t\t\t\"TxPwrLimit_5G[regulation %d][bw %d][rateSection %d][channel %d] =%d\\n(TxPwrLimit in dBm %d - BW40PwrLmt5G[chnl group %d][rfpath %d] %d)\\n\",\n\t\t\t\t\t\t\tregulation, bw, rate_section,\n\t\t\t\t\t\t\tchannel, rtlphy->txpwr_limit_5g[regulation]\n\t\t\t\t\t\t\t[bw][rate_section][channel][rf_path],\n\t\t\t\t\t\t\ttemp_pwrlmt, channel, rf_path, bw40_pwr_base_dbm5G);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\"<===== %s()\\n\", __func__);\n}\n\nstatic void _rtl8821ae_phy_init_txpower_limit(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 i, j, k, l, m;\n\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\"=====>`%s()!\\n\", __func__);\n\n\tfor (i = 0; i < MAX_REGULATION_NUM; ++i) {\n\t\tfor (j = 0; j < MAX_2_4G_BANDWIDTH_NUM; ++j)\n\t\t\tfor (k = 0; k < MAX_RATE_SECTION_NUM; ++k)\n\t\t\t\tfor (m = 0; m < CHANNEL_MAX_NUMBER_2G; ++m)\n\t\t\t\t\tfor (l = 0; l < MAX_RF_PATH_NUM; ++l)\n\t\t\t\t\t\trtlphy->txpwr_limit_2_4g\n\t\t\t\t\t\t\t\t[i][j][k][m][l]\n\t\t\t\t\t\t\t= MAX_POWER_INDEX;\n\t}\n\tfor (i = 0; i < MAX_REGULATION_NUM; ++i) {\n\t\tfor (j = 0; j < MAX_5G_BANDWIDTH_NUM; ++j)\n\t\t\tfor (k = 0; k < MAX_RATE_SECTION_NUM; ++k)\n\t\t\t\tfor (m = 0; m < CHANNEL_MAX_NUMBER_5G; ++m)\n\t\t\t\t\tfor (l = 0; l < MAX_RF_PATH_NUM; ++l)\n\t\t\t\t\t\trtlphy->txpwr_limit_5g\n\t\t\t\t\t\t\t\t[i][j][k][m][l]\n\t\t\t\t\t\t\t= MAX_POWER_INDEX;\n\t}\n\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\"<===== %s()!\\n\", __func__);\n}\n\nstatic void _rtl8821ae_phy_convert_txpower_dbm_to_relative_value(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 base = 0, rfpath = 0;\n\n\tfor (rfpath = RF90_PATH_A; rfpath <= RF90_PATH_B; ++rfpath) {\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_2_4G, rfpath, RF_1TX, CCK);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_1TX][0],\n\t\t\t0, 3, base);\n\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_2_4G, rfpath, RF_1TX, OFDM);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_1TX][1],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_1TX][2],\n\t\t\t0, 3, base);\n\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_2_4G, rfpath, RF_1TX, HT_MCS0_MCS7);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_1TX][3],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_1TX][4],\n\t\t\t0, 3, base);\n\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_2_4G, rfpath, RF_2TX, HT_MCS8_MCS15);\n\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_2TX][5],\n\t\t\t0, 3, base);\n\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_2TX][6],\n\t\t\t0, 3, base);\n\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_2_4G, rfpath, RF_1TX, VHT_1SSMCS0_1SSMCS9);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_1TX][7],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_1TX][8],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_1TX][9],\n\t\t\t0, 1, base);\n\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_2_4G, rfpath, RF_2TX, VHT_2SSMCS0_2SSMCS9);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_1TX][9],\n\t\t\t2, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_2TX][10],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_2_4G][rfpath][RF_2TX][11],\n\t\t\t0, 3, base);\n\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_5G, rfpath, RF_1TX, OFDM);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_1TX][1],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_1TX][2],\n\t\t\t0, 3, base);\n\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_5G, rfpath, RF_1TX, HT_MCS0_MCS7);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_1TX][3],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_1TX][4],\n\t\t\t0, 3, base);\n\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_5G, rfpath, RF_2TX, HT_MCS8_MCS15);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_2TX][5],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_2TX][6],\n\t\t\t0, 3, base);\n\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_5G, rfpath, RF_1TX, VHT_1SSMCS0_1SSMCS9);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_1TX][7],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_1TX][8],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_1TX][9],\n\t\t\t0, 1, base);\n\n\t\tbase = _rtl8821ae_phy_get_txpower_by_rate_base(hw, BAND_ON_5G, rfpath, RF_2TX, VHT_2SSMCS0_2SSMCS9);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_1TX][9],\n\t\t\t2, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_2TX][10],\n\t\t\t0, 3, base);\n\t\t_phy_convert_txpower_dbm_to_relative_value(\n\t\t\t&rtlphy->tx_power_by_rate_offset[BAND_ON_5G][rfpath][RF_2TX][11],\n\t\t\t0, 3, base);\n\t}\n\n\trtl_dbg(rtlpriv, COMP_POWER, DBG_TRACE,\n\t\t\"<===_rtl8821ae_phy_convert_txpower_dbm_to_relative_value()\\n\");\n}\n\nstatic void _rtl8821ae_phy_txpower_by_rate_configuration(struct ieee80211_hw *hw)\n{\n\t_rtl8821ae_phy_store_txpower_by_rate_base(hw);\n\t_rtl8821ae_phy_convert_txpower_dbm_to_relative_value(hw);\n}\n\n \nstatic bool _rtl8812ae_get_integer_from_string(const char *str, u8 *pint)\n{\n\tu16 i = 0;\n\t*pint = 0;\n\n\twhile (str[i] != '\\0') {\n\t\tif (str[i] >= '0' && str[i] <= '9') {\n\t\t\t*pint *= 10;\n\t\t\t*pint += (str[i] - '0');\n\t\t} else {\n\t\t\treturn false;\n\t\t}\n\t\t++i;\n\t}\n\n\treturn true;\n}\n\nstatic s8 _rtl8812ae_phy_get_chnl_idx_of_txpwr_lmt(struct ieee80211_hw *hw,\n\t\t\t\t\t      u8 band, u8 channel)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\ts8 channel_index = -1;\n\tu8  i = 0;\n\n\tif (band == BAND_ON_2_4G)\n\t\tchannel_index = channel - 1;\n\telse if (band == BAND_ON_5G) {\n\t\tfor (i = 0; i < sizeof(channel5g)/sizeof(u8); ++i) {\n\t\t\tif (channel5g[i] == channel)\n\t\t\t\tchannel_index = i;\n\t\t}\n\t} else\n\t\trtl_dbg(rtlpriv, COMP_POWER, DBG_LOUD, \"Invalid Band %d in %s\\n\",\n\t\t\tband,  __func__);\n\n\tif (channel_index == -1)\n\t\trtl_dbg(rtlpriv, COMP_POWER, DBG_LOUD,\n\t\t\t\"Invalid Channel %d of Band %d in %s\\n\", channel,\n\t\t\tband, __func__);\n\n\treturn channel_index;\n}\n\nstatic void _rtl8812ae_phy_set_txpower_limit(struct ieee80211_hw *hw,\n\t\t\t\t      const char *pregulation,\n\t\t\t\t      const char *pband, const char *pbandwidth,\n\t\t\t\t      const char *prate_section, const char *prf_path,\n\t\t\t\t      const char *pchannel, const char *ppower_limit)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 regulation = 0, bandwidth = 0, rate_section = 0, channel;\n\tu8 channel_index;\n\ts8 power_limit = 0, prev_power_limit, ret;\n\n\tif (!_rtl8812ae_get_integer_from_string(pchannel, &channel) ||\n\t    !_rtl8812ae_get_integer_from_string(ppower_limit,\n\t\t\t\t\t\t&power_limit)) {\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\t\"Illegal index of pwr_lmt table [chnl %d][val %d]\\n\",\n\t\t\tchannel, power_limit);\n\t}\n\n\tpower_limit = power_limit > MAX_POWER_INDEX ?\n\t\t      MAX_POWER_INDEX : power_limit;\n\n\tif (strcmp(pregulation, \"FCC\") == 0)\n\t\tregulation = 0;\n\telse if (strcmp(pregulation, \"MKK\") == 0)\n\t\tregulation = 1;\n\telse if (strcmp(pregulation, \"ETSI\") == 0)\n\t\tregulation = 2;\n\telse if (strcmp(pregulation, \"WW13\") == 0)\n\t\tregulation = 3;\n\n\tif (strcmp(prate_section, \"CCK\") == 0)\n\t\trate_section = 0;\n\telse if (strcmp(prate_section, \"OFDM\") == 0)\n\t\trate_section = 1;\n\telse if (strcmp(prate_section, \"HT\") == 0 &&\n\t\t strcmp(prf_path, \"1T\") == 0)\n\t\trate_section = 2;\n\telse if (strcmp(prate_section, \"HT\") == 0 &&\n\t\t strcmp(prf_path, \"2T\") == 0)\n\t\trate_section = 3;\n\telse if (strcmp(prate_section, \"VHT\") == 0 &&\n\t\t strcmp(prf_path, \"1T\") == 0)\n\t\trate_section = 4;\n\telse if (strcmp(prate_section, \"VHT\") == 0 &&\n\t\t strcmp(prf_path, \"2T\") == 0)\n\t\trate_section = 5;\n\n\tif (strcmp(pbandwidth, \"20M\") == 0)\n\t\tbandwidth = 0;\n\telse if (strcmp(pbandwidth, \"40M\") == 0)\n\t\tbandwidth = 1;\n\telse if (strcmp(pbandwidth, \"80M\") == 0)\n\t\tbandwidth = 2;\n\telse if (strcmp(pbandwidth, \"160M\") == 0)\n\t\tbandwidth = 3;\n\n\tif (strcmp(pband, \"2.4G\") == 0) {\n\t\tret = _rtl8812ae_phy_get_chnl_idx_of_txpwr_lmt(hw,\n\t\t\t\t\t\t\t       BAND_ON_2_4G,\n\t\t\t\t\t\t\t       channel);\n\n\t\tif (ret == -1)\n\t\t\treturn;\n\n\t\tchannel_index = ret;\n\n\t\tprev_power_limit = rtlphy->txpwr_limit_2_4g[regulation]\n\t\t\t\t\t\t[bandwidth][rate_section]\n\t\t\t\t\t\t[channel_index][RF90_PATH_A];\n\n\t\tif (power_limit < prev_power_limit)\n\t\t\trtlphy->txpwr_limit_2_4g[regulation][bandwidth]\n\t\t\t\t[rate_section][channel_index][RF90_PATH_A] =\n\t\t\t\t\t\t\t\t   power_limit;\n\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\t\"2.4G [regula %d][bw %d][sec %d][chnl %d][val %d]\\n\",\n\t\t\tregulation, bandwidth, rate_section, channel_index,\n\t\t\trtlphy->txpwr_limit_2_4g[regulation][bandwidth]\n\t\t\t\t[rate_section][channel_index][RF90_PATH_A]);\n\t} else if (strcmp(pband, \"5G\") == 0) {\n\t\tret = _rtl8812ae_phy_get_chnl_idx_of_txpwr_lmt(hw,\n\t\t\t\t\t\t\t       BAND_ON_5G,\n\t\t\t\t\t\t\t       channel);\n\n\t\tif (ret == -1)\n\t\t\treturn;\n\n\t\tchannel_index = ret;\n\n\t\tprev_power_limit = rtlphy->txpwr_limit_5g[regulation][bandwidth]\n\t\t\t\t\t\t[rate_section][channel_index]\n\t\t\t\t\t\t[RF90_PATH_A];\n\n\t\tif (power_limit < prev_power_limit)\n\t\t\trtlphy->txpwr_limit_5g[regulation][bandwidth]\n\t\t\t[rate_section][channel_index][RF90_PATH_A] = power_limit;\n\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\t\"5G: [regul %d][bw %d][sec %d][chnl %d][val %d]\\n\",\n\t\t\tregulation, bandwidth, rate_section, channel,\n\t\t\trtlphy->txpwr_limit_5g[regulation][bandwidth]\n\t\t\t\t[rate_section][channel_index][RF90_PATH_A]);\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\t\"Cannot recognize the band info in %s\\n\", pband);\n\t\treturn;\n\t}\n}\n\nstatic void _rtl8812ae_phy_config_bb_txpwr_lmt(struct ieee80211_hw *hw,\n\t\t\t\t\t  const char *regulation, const char *band,\n\t\t\t\t\t  const char *bandwidth, const char *rate_section,\n\t\t\t\t\t  const char *rf_path, const char *channel,\n\t\t\t\t\t  const char *power_limit)\n{\n\t_rtl8812ae_phy_set_txpower_limit(hw, regulation, band, bandwidth,\n\t\t\t\t\t rate_section, rf_path, channel,\n\t\t\t\t\t power_limit);\n}\n\nstatic void _rtl8821ae_phy_read_and_config_txpwr_lmt(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\n\tu32 i = 0;\n\tu32 array_len;\n\tconst char **array;\n\n\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\n\t\tarray_len = RTL8812AE_TXPWR_LMT_ARRAY_LEN;\n\t\tarray = RTL8812AE_TXPWR_LMT;\n\t} else {\n\t\tarray_len = RTL8821AE_TXPWR_LMT_ARRAY_LEN;\n\t\tarray = RTL8821AE_TXPWR_LMT;\n\t}\n\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE, \"\\n\");\n\n\tfor (i = 0; i < array_len; i += 7) {\n\t\tconst char *regulation = array[i];\n\t\tconst char *band = array[i+1];\n\t\tconst char *bandwidth = array[i+2];\n\t\tconst char *rate = array[i+3];\n\t\tconst char *rf_path = array[i+4];\n\t\tconst char *chnl = array[i+5];\n\t\tconst char *val = array[i+6];\n\n\t\t_rtl8812ae_phy_config_bb_txpwr_lmt(hw, regulation, band,\n\t\t\t\t\t\t   bandwidth, rate, rf_path,\n\t\t\t\t\t\t   chnl, val);\n\t}\n}\n\nstatic bool _rtl8821ae_phy_bb8821a_config_parafile(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\n\tbool rtstatus;\n\n\t_rtl8821ae_phy_init_txpower_limit(hw);\n\n\t \n\tif (rtlefuse->eeprom_regulatory != 2)\n\t\t_rtl8821ae_phy_read_and_config_txpwr_lmt(hw);\n\n\trtstatus = _rtl8821ae_phy_config_bb_with_headerfile(hw,\n\t\t\t\t\t\t       BASEBAND_CONFIG_PHY_REG);\n\tif (!rtstatus) {\n\t\tpr_err(\"Write BB Reg Fail!!\\n\");\n\t\treturn false;\n\t}\n\t_rtl8821ae_phy_init_tx_power_by_rate(hw);\n\tif (!rtlefuse->autoload_failflag) {\n\t\trtstatus = _rtl8821ae_phy_config_bb_with_pgheaderfile(hw,\n\t\t\t\t\t\t    BASEBAND_CONFIG_PHY_REG);\n\t}\n\tif (!rtstatus) {\n\t\tpr_err(\"BB_PG Reg Fail!!\\n\");\n\t\treturn false;\n\t}\n\n\t_rtl8821ae_phy_txpower_by_rate_configuration(hw);\n\n\t \n\tif (rtlefuse->eeprom_regulatory != 2)\n\t\t_rtl8812ae_phy_convert_txpower_limit_to_power_index(hw);\n\n\trtstatus = _rtl8821ae_phy_config_bb_with_headerfile(hw,\n\t\t\t\t\t\tBASEBAND_CONFIG_AGC_TAB);\n\n\tif (!rtstatus) {\n\t\tpr_err(\"AGC Table Fail\\n\");\n\t\treturn false;\n\t}\n\trtlphy->cck_high_power = (bool)(rtl_get_bbreg(hw,\n\t\t\tRFPGA0_XA_HSSIPARAMETER2, 0x200));\n\treturn true;\n}\n\nstatic bool\n__rtl8821ae_phy_config_with_headerfile(struct ieee80211_hw *hw,\n\t\t\t\t       u32 *array_table, u16 arraylen,\n\t\t\t\t       void (*set_reg)(struct ieee80211_hw *hw,\n\t\t\t\t\t\t       u32 regaddr, u32 data))\n{\n\t#define COND_ELSE  2\n\t#define COND_ENDIF 3\n\n\tint i = 0;\n\tu8 cond;\n\tbool matched = true, skipped = false;\n\n\twhile ((i + 1) < arraylen) {\n\t\tu32 v1 = array_table[i];\n\t\tu32 v2 = array_table[i + 1];\n\n\t\tif (v1 & (BIT(31) | BIT(30))) { \n\t\t\tif (v1 & BIT(31)) { \n\t\t\t\tcond  = (u8)((v1 & (BIT(29) | BIT(28))) >> 28);\n\t\t\t\tif (cond == COND_ENDIF) { \n\t\t\t\t\tmatched = true;\n\t\t\t\t\tskipped = false;\n\t\t\t\t} else if (cond == COND_ELSE)  \n\t\t\t\t\tmatched = skipped ? false : true;\n\t\t\t\telse { \n\t\t\t\t\tif (skipped) {\n\t\t\t\t\t\tmatched = false;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tif (_rtl8821ae_check_positive(\n\t\t\t\t\t\t\t\thw, v1, v2)) {\n\t\t\t\t\t\t\tmatched = true;\n\t\t\t\t\t\t\tskipped = true;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tmatched = false;\n\t\t\t\t\t\t\tskipped = false;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} else if (v1 & BIT(30)) {  \n\t\t\t \n\t\t\t}\n\t\t} else {\n\t\t\tif (matched)\n\t\t\t\tset_reg(hw, v1, v2);\n\t\t}\n\t\ti = i + 2;\n\t}\n\n\treturn true;\n}\n\nstatic bool _rtl8821ae_phy_config_mac_with_headerfile(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\n\tu32 arraylength;\n\tu32 *ptrarray;\n\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE, \"Read MAC_REG_Array\\n\");\n\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) {\n\t\tarraylength = RTL8821AE_MAC_1T_ARRAYLEN;\n\t\tptrarray = RTL8821AE_MAC_REG_ARRAY;\n\t} else {\n\t\tarraylength = RTL8812AE_MAC_1T_ARRAYLEN;\n\t\tptrarray = RTL8812AE_MAC_REG_ARRAY;\n\t}\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\"Img: MAC_REG_ARRAY LEN %d\\n\", arraylength);\n\n\treturn __rtl8821ae_phy_config_with_headerfile(hw,\n\t\t\tptrarray, arraylength, rtl_write_byte_with_val32);\n}\n\nstatic bool _rtl8821ae_phy_config_bb_with_headerfile(struct ieee80211_hw *hw,\n\t\t\t\t\t\t     u8 configtype)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\n\tu32 *array_table;\n\tu16 arraylen;\n\n\tif (configtype == BASEBAND_CONFIG_PHY_REG) {\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\n\t\t\tarraylen = RTL8812AE_PHY_REG_1TARRAYLEN;\n\t\t\tarray_table = RTL8812AE_PHY_REG_ARRAY;\n\t\t} else {\n\t\t\tarraylen = RTL8821AE_PHY_REG_1TARRAYLEN;\n\t\t\tarray_table = RTL8821AE_PHY_REG_ARRAY;\n\t\t}\n\n\t\treturn __rtl8821ae_phy_config_with_headerfile(hw,\n\t\t\t\tarray_table, arraylen,\n\t\t\t\t_rtl8821ae_config_bb_reg);\n\t} else if (configtype == BASEBAND_CONFIG_AGC_TAB) {\n\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\n\t\t\tarraylen = RTL8812AE_AGC_TAB_1TARRAYLEN;\n\t\t\tarray_table = RTL8812AE_AGC_TAB_ARRAY;\n\t\t} else {\n\t\t\tarraylen = RTL8821AE_AGC_TAB_1TARRAYLEN;\n\t\t\tarray_table = RTL8821AE_AGC_TAB_ARRAY;\n\t\t}\n\n\t\treturn __rtl8821ae_phy_config_with_headerfile(hw,\n\t\t\t\tarray_table, arraylen,\n\t\t\t\trtl_set_bbreg_with_dwmask);\n\t}\n\treturn true;\n}\n\nstatic u8 _rtl8821ae_get_rate_section_index(u32 regaddr)\n{\n\tu8 index = 0;\n\tregaddr &= 0xFFF;\n\tif (regaddr >= 0xC20 && regaddr <= 0xC4C)\n\t\tindex = (u8)((regaddr - 0xC20) / 4);\n\telse if (regaddr >= 0xE20 && regaddr <= 0xE4C)\n\t\tindex = (u8)((regaddr - 0xE20) / 4);\n\telse\n\t\tWARN_ONCE(true,\n\t\t\t  \"rtl8821ae: Invalid RegAddr 0x%x\\n\", regaddr);\n\treturn index;\n}\n\nstatic void _rtl8821ae_store_tx_power_by_rate(struct ieee80211_hw *hw,\n\t\t\t\t\t      u32 band, u32 rfpath,\n\t\t\t\t\t      u32 txnum, u32 regaddr,\n\t\t\t\t\t      u32 bitmask, u32 data)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 rate_section = _rtl8821ae_get_rate_section_index(regaddr);\n\n\tif (band != BAND_ON_2_4G && band != BAND_ON_5G) {\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_WARNING, \"Invalid Band %d\\n\", band);\n\t\tband = BAND_ON_2_4G;\n\t}\n\tif (rfpath >= MAX_RF_PATH) {\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_WARNING, \"Invalid RfPath %d\\n\", rfpath);\n\t\trfpath = MAX_RF_PATH - 1;\n\t}\n\tif (txnum >= MAX_RF_PATH) {\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_WARNING, \"Invalid TxNum %d\\n\", txnum);\n\t\ttxnum = MAX_RF_PATH - 1;\n\t}\n\trtlphy->tx_power_by_rate_offset[band][rfpath][txnum][rate_section] = data;\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\"TxPwrByRateOffset[Band %d][RfPath %d][TxNum %d][RateSection %d] = 0x%x\\n\",\n\t\tband, rfpath, txnum, rate_section,\n\t\trtlphy->tx_power_by_rate_offset[band][rfpath][txnum][rate_section]);\n}\n\nstatic bool _rtl8821ae_phy_config_bb_with_pgheaderfile(struct ieee80211_hw *hw,\n\t\t\t\t\t\t\tu8 configtype)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\n\tint i;\n\tu32 *array;\n\tu16 arraylen;\n\tu32 v1, v2, v3, v4, v5, v6;\n\n\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE) {\n\t\tarraylen = RTL8812AE_PHY_REG_ARRAY_PGLEN;\n\t\tarray = RTL8812AE_PHY_REG_ARRAY_PG;\n\t} else {\n\t\tarraylen = RTL8821AE_PHY_REG_ARRAY_PGLEN;\n\t\tarray = RTL8821AE_PHY_REG_ARRAY_PG;\n\t}\n\n\tif (configtype != BASEBAND_CONFIG_PHY_REG) {\n\t\trtl_dbg(rtlpriv, COMP_SEND, DBG_TRACE,\n\t\t\t\"configtype != BaseBand_Config_PHY_REG\\n\");\n\t\treturn true;\n\t}\n\tfor (i = 0; i < arraylen; i += 6) {\n\t\tv1 = array[i];\n\t\tv2 = array[i+1];\n\t\tv3 = array[i+2];\n\t\tv4 = array[i+3];\n\t\tv5 = array[i+4];\n\t\tv6 = array[i+5];\n\n\t\tif (v1 < 0xCDCDCDCD) {\n\t\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8812AE &&\n\t\t\t\t(v4 == 0xfe || v4 == 0xffe)) {\n\t\t\t\tmsleep(50);\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) {\n\t\t\t\tif (v4 == 0xfe)\n\t\t\t\t\tmsleep(50);\n\t\t\t\telse if (v4 == 0xfd)\n\t\t\t\t\tmdelay(5);\n\t\t\t\telse if (v4 == 0xfc)\n\t\t\t\t\tmdelay(1);\n\t\t\t\telse if (v4 == 0xfb)\n\t\t\t\t\tudelay(50);\n\t\t\t\telse if (v4 == 0xfa)\n\t\t\t\t\tudelay(5);\n\t\t\t\telse if (v4 == 0xf9)\n\t\t\t\t\tudelay(1);\n\t\t\t}\n\t\t\t_rtl8821ae_store_tx_power_by_rate(hw, v1, v2, v3,\n\t\t\t\t\t\t\t  v4, v5, v6);\n\t\t\tcontinue;\n\t\t} else {\n\t\t\t  \n\t\t\tif (!_rtl8821ae_check_condition(hw, v1)) {\n\t\t\t\ti += 2;  \n\t\t\t\tv1 = array[i];\n\t\t\t\tv2 = array[i+1];\n\t\t\t\tv3 = array[i+2];\n\t\t\t\twhile (v2 != 0xDEAD) {\n\t\t\t\t\ti += 3;\n\t\t\t\t\tv1 = array[i];\n\t\t\t\t\tv2 = array[i+1];\n\t\t\t\t\tv3 = array[i+2];\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn true;\n}\n\nbool rtl8812ae_phy_config_rf_with_headerfile(struct ieee80211_hw *hw,\n\t\t\t\t\t     enum radio_path rfpath)\n{\n\tu32 *radioa_array_table_a, *radioa_array_table_b;\n\tu16 radioa_arraylen_a, radioa_arraylen_b;\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\tradioa_arraylen_a = RTL8812AE_RADIOA_1TARRAYLEN;\n\tradioa_array_table_a = RTL8812AE_RADIOA_ARRAY;\n\tradioa_arraylen_b = RTL8812AE_RADIOB_1TARRAYLEN;\n\tradioa_array_table_b = RTL8812AE_RADIOB_ARRAY;\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\"Radio_A:RTL8821AE_RADIOA_ARRAY %d\\n\", radioa_arraylen_a);\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD, \"Radio No %x\\n\", rfpath);\n\tswitch (rfpath) {\n\tcase RF90_PATH_A:\n\t\treturn __rtl8821ae_phy_config_with_headerfile(hw,\n\t\t\t\tradioa_array_table_a, radioa_arraylen_a,\n\t\t\t\t_rtl8821ae_config_rf_radio_a);\n\tcase RF90_PATH_B:\n\t\treturn __rtl8821ae_phy_config_with_headerfile(hw,\n\t\t\t\tradioa_array_table_b, radioa_arraylen_b,\n\t\t\t\t_rtl8821ae_config_rf_radio_b);\n\tcase RF90_PATH_C:\n\tcase RF90_PATH_D:\n\t\tpr_err(\"switch case %#x not processed\\n\", rfpath);\n\t\tbreak;\n\t}\n\treturn true;\n}\n\nbool rtl8821ae_phy_config_rf_with_headerfile(struct ieee80211_hw *hw,\n\t\t\t\t\t\tenum radio_path rfpath)\n{\n\tu32 *radioa_array_table;\n\tu16 radioa_arraylen;\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\tradioa_arraylen = RTL8821AE_RADIOA_1TARRAYLEN;\n\tradioa_array_table = RTL8821AE_RADIOA_ARRAY;\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\"Radio_A:RTL8821AE_RADIOA_ARRAY %d\\n\", radioa_arraylen);\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD, \"Radio No %x\\n\", rfpath);\n\tswitch (rfpath) {\n\tcase RF90_PATH_A:\n\t\treturn __rtl8821ae_phy_config_with_headerfile(hw,\n\t\t\tradioa_array_table, radioa_arraylen,\n\t\t\t_rtl8821ae_config_rf_radio_a);\n\n\tcase RF90_PATH_B:\n\tcase RF90_PATH_C:\n\tcase RF90_PATH_D:\n\t\tpr_err(\"switch case %#x not processed\\n\", rfpath);\n\t\tbreak;\n\t}\n\treturn true;\n}\n\nvoid rtl8821ae_phy_get_hw_reg_originalvalue(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\n\trtlphy->default_initialgain[0] =\n\t    (u8)rtl_get_bbreg(hw, ROFDM0_XAAGCCORE1, MASKBYTE0);\n\trtlphy->default_initialgain[1] =\n\t    (u8)rtl_get_bbreg(hw, ROFDM0_XBAGCCORE1, MASKBYTE0);\n\trtlphy->default_initialgain[2] =\n\t    (u8)rtl_get_bbreg(hw, ROFDM0_XCAGCCORE1, MASKBYTE0);\n\trtlphy->default_initialgain[3] =\n\t    (u8)rtl_get_bbreg(hw, ROFDM0_XDAGCCORE1, MASKBYTE0);\n\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\"Default initial gain (c50=0x%x, c58=0x%x, c60=0x%x, c68=0x%x\\n\",\n\t\trtlphy->default_initialgain[0],\n\t\trtlphy->default_initialgain[1],\n\t\trtlphy->default_initialgain[2],\n\t\trtlphy->default_initialgain[3]);\n\n\trtlphy->framesync = (u8)rtl_get_bbreg(hw,\n\t\t\t\t\t       ROFDM0_RXDETECTOR3, MASKBYTE0);\n\trtlphy->framesync_c34 = rtl_get_bbreg(hw,\n\t\t\t\t\t      ROFDM0_RXDETECTOR2, MASKDWORD);\n\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_TRACE,\n\t\t\"Default framesync (0x%x) = 0x%x\\n\",\n\t\tROFDM0_RXDETECTOR3, rtlphy->framesync);\n}\n\nstatic void phy_init_bb_rf_register_definition(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\n\trtlphy->phyreg_def[RF90_PATH_A].rfintfs = RFPGA0_XAB_RFINTERFACESW;\n\trtlphy->phyreg_def[RF90_PATH_B].rfintfs = RFPGA0_XAB_RFINTERFACESW;\n\n\trtlphy->phyreg_def[RF90_PATH_A].rfintfo = RFPGA0_XA_RFINTERFACEOE;\n\trtlphy->phyreg_def[RF90_PATH_B].rfintfo = RFPGA0_XB_RFINTERFACEOE;\n\n\trtlphy->phyreg_def[RF90_PATH_A].rfintfe = RFPGA0_XA_RFINTERFACEOE;\n\trtlphy->phyreg_def[RF90_PATH_B].rfintfe = RFPGA0_XB_RFINTERFACEOE;\n\n\trtlphy->phyreg_def[RF90_PATH_A].rf3wire_offset = RA_LSSIWRITE_8821A;\n\trtlphy->phyreg_def[RF90_PATH_B].rf3wire_offset = RB_LSSIWRITE_8821A;\n\n\trtlphy->phyreg_def[RF90_PATH_A].rfhssi_para2 = RHSSIREAD_8821AE;\n\trtlphy->phyreg_def[RF90_PATH_B].rfhssi_para2 = RHSSIREAD_8821AE;\n\n\trtlphy->phyreg_def[RF90_PATH_A].rf_rb = RA_SIREAD_8821A;\n\trtlphy->phyreg_def[RF90_PATH_B].rf_rb = RB_SIREAD_8821A;\n\n\trtlphy->phyreg_def[RF90_PATH_A].rf_rbpi = RA_PIREAD_8821A;\n\trtlphy->phyreg_def[RF90_PATH_B].rf_rbpi = RB_PIREAD_8821A;\n}\n\nvoid rtl8821ae_phy_get_txpower_level(struct ieee80211_hw *hw, long *powerlevel)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 txpwr_level;\n\tlong txpwr_dbm;\n\n\ttxpwr_level = rtlphy->cur_cck_txpwridx;\n\ttxpwr_dbm = _rtl8821ae_phy_txpwr_idx_to_dbm(hw,\n\t\t\t\t\t\t WIRELESS_MODE_B, txpwr_level);\n\ttxpwr_level = rtlphy->cur_ofdm24g_txpwridx;\n\tif (_rtl8821ae_phy_txpwr_idx_to_dbm(hw,\n\t\t\t\t\t WIRELESS_MODE_G,\n\t\t\t\t\t txpwr_level) > txpwr_dbm)\n\t\ttxpwr_dbm =\n\t\t    _rtl8821ae_phy_txpwr_idx_to_dbm(hw, WIRELESS_MODE_G,\n\t\t\t\t\t\t txpwr_level);\n\ttxpwr_level = rtlphy->cur_ofdm24g_txpwridx;\n\tif (_rtl8821ae_phy_txpwr_idx_to_dbm(hw,\n\t\t\t\t\t WIRELESS_MODE_N_24G,\n\t\t\t\t\t txpwr_level) > txpwr_dbm)\n\t\ttxpwr_dbm =\n\t\t    _rtl8821ae_phy_txpwr_idx_to_dbm(hw, WIRELESS_MODE_N_24G,\n\t\t\t\t\t\t txpwr_level);\n\t*powerlevel = txpwr_dbm;\n}\n\nstatic bool _rtl8821ae_phy_get_chnl_index(u8 channel, u8 *chnl_index)\n{\n\tu8 i = 0;\n\tbool in_24g = true;\n\n\tif (channel <= 14) {\n\t\tin_24g = true;\n\t\t*chnl_index = channel - 1;\n\t} else {\n\t\tin_24g = false;\n\n\t\tfor (i = 0; i < CHANNEL_MAX_NUMBER_5G; ++i) {\n\t\t\tif (channel5g[i] == channel) {\n\t\t\t\t*chnl_index = i;\n\t\t\t\treturn in_24g;\n\t\t\t}\n\t\t}\n\t}\n\treturn in_24g;\n}\n\nstatic s8 _rtl8821ae_phy_get_ratesection_intxpower_byrate(u8 path, u8 rate)\n{\n\ts8 rate_section = 0;\n\tswitch (rate) {\n\tcase DESC_RATE1M:\n\tcase DESC_RATE2M:\n\tcase DESC_RATE5_5M:\n\tcase DESC_RATE11M:\n\t\trate_section = 0;\n\t\tbreak;\n\tcase DESC_RATE6M:\n\tcase DESC_RATE9M:\n\tcase DESC_RATE12M:\n\tcase DESC_RATE18M:\n\t\trate_section = 1;\n\t\tbreak;\n\tcase DESC_RATE24M:\n\tcase DESC_RATE36M:\n\tcase DESC_RATE48M:\n\tcase DESC_RATE54M:\n\t\trate_section = 2;\n\t\tbreak;\n\tcase DESC_RATEMCS0:\n\tcase DESC_RATEMCS1:\n\tcase DESC_RATEMCS2:\n\tcase DESC_RATEMCS3:\n\t\trate_section = 3;\n\t\tbreak;\n\tcase DESC_RATEMCS4:\n\tcase DESC_RATEMCS5:\n\tcase DESC_RATEMCS6:\n\tcase DESC_RATEMCS7:\n\t\trate_section = 4;\n\t\tbreak;\n\tcase DESC_RATEMCS8:\n\tcase DESC_RATEMCS9:\n\tcase DESC_RATEMCS10:\n\tcase DESC_RATEMCS11:\n\t\trate_section = 5;\n\t\tbreak;\n\tcase DESC_RATEMCS12:\n\tcase DESC_RATEMCS13:\n\tcase DESC_RATEMCS14:\n\tcase DESC_RATEMCS15:\n\t\trate_section = 6;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS0:\n\tcase DESC_RATEVHT1SS_MCS1:\n\tcase DESC_RATEVHT1SS_MCS2:\n\tcase DESC_RATEVHT1SS_MCS3:\n\t\trate_section = 7;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS4:\n\tcase DESC_RATEVHT1SS_MCS5:\n\tcase DESC_RATEVHT1SS_MCS6:\n\tcase DESC_RATEVHT1SS_MCS7:\n\t\trate_section = 8;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS8:\n\tcase DESC_RATEVHT1SS_MCS9:\n\tcase DESC_RATEVHT2SS_MCS0:\n\tcase DESC_RATEVHT2SS_MCS1:\n\t\trate_section = 9;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS2:\n\tcase DESC_RATEVHT2SS_MCS3:\n\tcase DESC_RATEVHT2SS_MCS4:\n\tcase DESC_RATEVHT2SS_MCS5:\n\t\trate_section = 10;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS6:\n\tcase DESC_RATEVHT2SS_MCS7:\n\tcase DESC_RATEVHT2SS_MCS8:\n\tcase DESC_RATEVHT2SS_MCS9:\n\t\trate_section = 11;\n\t\tbreak;\n\tdefault:\n\t\tWARN_ONCE(true, \"rtl8821ae: Rate_Section is Illegal\\n\");\n\t\tbreak;\n\t}\n\n\treturn rate_section;\n}\n\nstatic s8 _rtl8812ae_phy_get_world_wide_limit(s8  *limit_table)\n{\n\ts8 min = limit_table[0];\n\tu8 i = 0;\n\n\tfor (i = 0; i < MAX_REGULATION_NUM; ++i) {\n\t\tif (limit_table[i] < min)\n\t\t\tmin = limit_table[i];\n\t}\n\treturn min;\n}\n\nstatic s8 _rtl8812ae_phy_get_txpower_limit(struct ieee80211_hw *hw,\n\t\t\t\t\t     u8 band,\n\t\t\t\t\t     enum ht_channel_width bandwidth,\n\t\t\t\t\t     enum radio_path rf_path,\n\t\t\t\t\t     u8 rate, u8 channel)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtlpriv);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tshort band_temp = -1, regulation = -1, bandwidth_temp = -1,\n\t\t rate_section = -1, channel_temp = -1;\n\tu16 regu, bdwidth, sec, chnl;\n\ts8 power_limit = MAX_POWER_INDEX;\n\n\tif (rtlefuse->eeprom_regulatory == 2)\n\t\treturn MAX_POWER_INDEX;\n\n\tregulation = TXPWR_LMT_WW;\n\n\tif (band == BAND_ON_2_4G)\n\t\tband_temp = 0;\n\telse if (band == BAND_ON_5G)\n\t\tband_temp = 1;\n\n\tif (bandwidth == HT_CHANNEL_WIDTH_20)\n\t\tbandwidth_temp = 0;\n\telse if (bandwidth == HT_CHANNEL_WIDTH_20_40)\n\t\tbandwidth_temp = 1;\n\telse if (bandwidth == HT_CHANNEL_WIDTH_80)\n\t\tbandwidth_temp = 2;\n\n\tswitch (rate) {\n\tcase DESC_RATE1M:\n\tcase DESC_RATE2M:\n\tcase DESC_RATE5_5M:\n\tcase DESC_RATE11M:\n\t\trate_section = 0;\n\t\tbreak;\n\tcase DESC_RATE6M:\n\tcase DESC_RATE9M:\n\tcase DESC_RATE12M:\n\tcase DESC_RATE18M:\n\tcase DESC_RATE24M:\n\tcase DESC_RATE36M:\n\tcase DESC_RATE48M:\n\tcase DESC_RATE54M:\n\t\trate_section = 1;\n\t\tbreak;\n\tcase DESC_RATEMCS0:\n\tcase DESC_RATEMCS1:\n\tcase DESC_RATEMCS2:\n\tcase DESC_RATEMCS3:\n\tcase DESC_RATEMCS4:\n\tcase DESC_RATEMCS5:\n\tcase DESC_RATEMCS6:\n\tcase DESC_RATEMCS7:\n\t\trate_section = 2;\n\t\tbreak;\n\tcase DESC_RATEMCS8:\n\tcase DESC_RATEMCS9:\n\tcase DESC_RATEMCS10:\n\tcase DESC_RATEMCS11:\n\tcase DESC_RATEMCS12:\n\tcase DESC_RATEMCS13:\n\tcase DESC_RATEMCS14:\n\tcase DESC_RATEMCS15:\n\t\trate_section = 3;\n\t\tbreak;\n\tcase DESC_RATEVHT1SS_MCS0:\n\tcase DESC_RATEVHT1SS_MCS1:\n\tcase DESC_RATEVHT1SS_MCS2:\n\tcase DESC_RATEVHT1SS_MCS3:\n\tcase DESC_RATEVHT1SS_MCS4:\n\tcase DESC_RATEVHT1SS_MCS5:\n\tcase DESC_RATEVHT1SS_MCS6:\n\tcase DESC_RATEVHT1SS_MCS7:\n\tcase DESC_RATEVHT1SS_MCS8:\n\tcase DESC_RATEVHT1SS_MCS9:\n\t\trate_section = 4;\n\t\tbreak;\n\tcase DESC_RATEVHT2SS_MCS0:\n\tcase DESC_RATEVHT2SS_MCS1:\n\tcase DESC_RATEVHT2SS_MCS2:\n\tcase DESC_RATEVHT2SS_MCS3:\n\tcase DESC_RATEVHT2SS_MCS4:\n\tcase DESC_RATEVHT2SS_MCS5:\n\tcase DESC_RATEVHT2SS_MCS6:\n\tcase DESC_RATEVHT2SS_MCS7:\n\tcase DESC_RATEVHT2SS_MCS8:\n\tcase DESC_RATEVHT2SS_MCS9:\n\t\trate_section = 5;\n\t\tbreak;\n\tdefault:\n\t\trtl_dbg(rtlpriv, COMP_POWER, DBG_LOUD,\n\t\t\t\"Wrong rate 0x%x\\n\", rate);\n\t\tbreak;\n\t}\n\n\tif (band_temp == BAND_ON_5G  && rate_section == 0)\n\t\trtl_dbg(rtlpriv, COMP_POWER, DBG_LOUD,\n\t\t\t\"Wrong rate 0x%x: No CCK in 5G Band\\n\", rate);\n\n\t \n\tif (rate_section == 1)\n\t\tbandwidth_temp = 0;\n\n\t \n\tif ((rate_section == 2 || rate_section == 3) && band == BAND_ON_5G &&\n\t    bandwidth_temp == 2)\n\t\tbandwidth_temp = 1;\n\n\tif (band == BAND_ON_2_4G)\n\t\tchannel_temp = _rtl8812ae_phy_get_chnl_idx_of_txpwr_lmt(hw,\n\t\tBAND_ON_2_4G, channel);\n\telse if (band == BAND_ON_5G)\n\t\tchannel_temp = _rtl8812ae_phy_get_chnl_idx_of_txpwr_lmt(hw,\n\t\tBAND_ON_5G, channel);\n\telse if (band == BAND_ON_BOTH) {\n\t\t; \n\t}\n\n\tif (band_temp == -1 || regulation == -1 || bandwidth_temp == -1 ||\n\t\trate_section == -1 || channel_temp == -1) {\n\t\trtl_dbg(rtlpriv, COMP_POWER, DBG_LOUD,\n\t\t\t\"Wrong index value to access power limit table [band %d][regulation %d][bandwidth %d][rf_path %d][rate_section %d][chnl %d]\\n\",\n\t\t\tband_temp, regulation, bandwidth_temp, rf_path,\n\t\t\trate_section, channel_temp);\n\t\treturn MAX_POWER_INDEX;\n\t}\n\n\tregu = regulation;\n\tbdwidth = bandwidth_temp;\n\tsec = rate_section;\n\tchnl = channel_temp;\n\n\tif (band == BAND_ON_2_4G) {\n\t\ts8 limits[10] = {0};\n\t\tu8 i;\n\n\t\tfor (i = 0; i < 4; ++i)\n\t\t\tlimits[i] = rtlphy->txpwr_limit_2_4g[i][bdwidth]\n\t\t\t[sec][chnl][rf_path];\n\n\t\tpower_limit = (regulation == TXPWR_LMT_WW) ?\n\t\t\t_rtl8812ae_phy_get_world_wide_limit(limits) :\n\t\t\trtlphy->txpwr_limit_2_4g[regu][bdwidth]\n\t\t\t\t\t[sec][chnl][rf_path];\n\t} else if (band == BAND_ON_5G) {\n\t\ts8 limits[10] = {0};\n\t\tu8 i;\n\n\t\tfor (i = 0; i < MAX_REGULATION_NUM; ++i)\n\t\t\tlimits[i] = rtlphy->txpwr_limit_5g[i][bdwidth]\n\t\t\t[sec][chnl][rf_path];\n\n\t\tpower_limit = (regulation == TXPWR_LMT_WW) ?\n\t\t\t_rtl8812ae_phy_get_world_wide_limit(limits) :\n\t\t\trtlphy->txpwr_limit_5g[regu][chnl]\n\t\t\t[sec][chnl][rf_path];\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD,\n\t\t\t\"No power limit table of the specified band\\n\");\n\t}\n\treturn power_limit;\n}\n\nstatic s8 _rtl8821ae_phy_get_txpower_by_rate(struct ieee80211_hw *hw,\n\t\t\t\t\tu8 band, u8 path, u8 rate)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 shift = 0, rate_section, tx_num;\n\ts8 tx_pwr_diff = 0;\n\ts8 limit = 0;\n\n\trate_section = _rtl8821ae_phy_get_ratesection_intxpower_byrate(path, rate);\n\ttx_num = RF_TX_NUM_NONIMPLEMENT;\n\n\tif (tx_num == RF_TX_NUM_NONIMPLEMENT) {\n\t\tif ((rate >= DESC_RATEMCS8 && rate <= DESC_RATEMCS15) ||\n\t\t\t(rate >= DESC_RATEVHT2SS_MCS2 && rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\ttx_num = RF_2TX;\n\t\telse\n\t\t\ttx_num = RF_1TX;\n\t}\n\n\tswitch (rate) {\n\tcase DESC_RATE1M:\n\tcase DESC_RATE6M:\n\tcase DESC_RATE24M:\n\tcase DESC_RATEMCS0:\n\tcase DESC_RATEMCS4:\n\tcase DESC_RATEMCS8:\n\tcase DESC_RATEMCS12:\n\tcase DESC_RATEVHT1SS_MCS0:\n\tcase DESC_RATEVHT1SS_MCS4:\n\tcase DESC_RATEVHT1SS_MCS8:\n\tcase DESC_RATEVHT2SS_MCS2:\n\tcase DESC_RATEVHT2SS_MCS6:\n\t\tshift = 0;\n\t\tbreak;\n\tcase DESC_RATE2M:\n\tcase DESC_RATE9M:\n\tcase DESC_RATE36M:\n\tcase DESC_RATEMCS1:\n\tcase DESC_RATEMCS5:\n\tcase DESC_RATEMCS9:\n\tcase DESC_RATEMCS13:\n\tcase DESC_RATEVHT1SS_MCS1:\n\tcase DESC_RATEVHT1SS_MCS5:\n\tcase DESC_RATEVHT1SS_MCS9:\n\tcase DESC_RATEVHT2SS_MCS3:\n\tcase DESC_RATEVHT2SS_MCS7:\n\t\tshift = 8;\n\t\tbreak;\n\tcase DESC_RATE5_5M:\n\tcase DESC_RATE12M:\n\tcase DESC_RATE48M:\n\tcase DESC_RATEMCS2:\n\tcase DESC_RATEMCS6:\n\tcase DESC_RATEMCS10:\n\tcase DESC_RATEMCS14:\n\tcase DESC_RATEVHT1SS_MCS2:\n\tcase DESC_RATEVHT1SS_MCS6:\n\tcase DESC_RATEVHT2SS_MCS0:\n\tcase DESC_RATEVHT2SS_MCS4:\n\tcase DESC_RATEVHT2SS_MCS8:\n\t\tshift = 16;\n\t\tbreak;\n\tcase DESC_RATE11M:\n\tcase DESC_RATE18M:\n\tcase DESC_RATE54M:\n\tcase DESC_RATEMCS3:\n\tcase DESC_RATEMCS7:\n\tcase DESC_RATEMCS11:\n\tcase DESC_RATEMCS15:\n\tcase DESC_RATEVHT1SS_MCS3:\n\tcase DESC_RATEVHT1SS_MCS7:\n\tcase DESC_RATEVHT2SS_MCS1:\n\tcase DESC_RATEVHT2SS_MCS5:\n\tcase DESC_RATEVHT2SS_MCS9:\n\t\tshift = 24;\n\t\tbreak;\n\tdefault:\n\t\tWARN_ONCE(true, \"rtl8821ae: Rate_Section is Illegal\\n\");\n\t\tbreak;\n\t}\n\n\ttx_pwr_diff = (u8)(rtlphy->tx_power_by_rate_offset[band][path]\n\t\t[tx_num][rate_section] >> shift) & 0xff;\n\n\t \n\tif (rtlpriv->efuse.eeprom_regulatory != 2) {\n\t\tlimit = _rtl8812ae_phy_get_txpower_limit(hw, band,\n\t\t\trtlphy->current_chan_bw, path, rate,\n\t\t\trtlphy->current_channel);\n\n\t\tif (rate == DESC_RATEVHT1SS_MCS8 || rate == DESC_RATEVHT1SS_MCS9  ||\n\t\t\t rate == DESC_RATEVHT2SS_MCS8 || rate == DESC_RATEVHT2SS_MCS9) {\n\t\t\tif (limit < 0) {\n\t\t\t\tif (tx_pwr_diff < (-limit))\n\t\t\t\t\ttx_pwr_diff = -limit;\n\t\t\t}\n\t\t} else {\n\t\t\tif (limit < 0)\n\t\t\t\ttx_pwr_diff = limit;\n\t\t\telse\n\t\t\t\ttx_pwr_diff = tx_pwr_diff > limit ? limit : tx_pwr_diff;\n\t\t}\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"Maximum power by rate %d, final power by rate %d\\n\",\n\t\t\tlimit, tx_pwr_diff);\n\t}\n\n\treturn\ttx_pwr_diff;\n}\n\nstatic u8 _rtl8821ae_get_txpower_index(struct ieee80211_hw *hw, u8 path,\n\t\t\t\t\tu8 rate, u8 bandwidth, u8 channel)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\n\tstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\n\tu8 index = (channel - 1);\n\tu8 txpower = 0;\n\tbool in_24g = false;\n\ts8 powerdiff_byrate = 0;\n\n\tif (((rtlhal->current_bandtype == BAND_ON_2_4G) &&\n\t    (channel > 14 || channel < 1)) ||\n\t    ((rtlhal->current_bandtype == BAND_ON_5G) && (channel <= 14))) {\n\t\tindex = 0;\n\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD,\n\t\t\t\"Illegal channel!!\\n\");\n\t}\n\n\tin_24g = _rtl8821ae_phy_get_chnl_index(channel, &index);\n\tif (in_24g) {\n\t\tif (RTL8821AE_RX_HAL_IS_CCK_RATE(rate))\n\t\t\ttxpower = rtlefuse->txpwrlevel_cck[path][index];\n\t\telse if (DESC_RATE6M <= rate)\n\t\t\ttxpower = rtlefuse->txpwrlevel_ht40_1s[path][index];\n\t\telse\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_LOUD, \"invalid rate\\n\");\n\n\t\tif (DESC_RATE6M <= rate && rate <= DESC_RATE54M &&\n\t\t    !RTL8821AE_RX_HAL_IS_CCK_RATE(rate))\n\t\t\ttxpower += rtlefuse->txpwr_legacyhtdiff[path][TX_1S];\n\n\t\tif (bandwidth == HT_CHANNEL_WIDTH_20) {\n\t\t\tif ((DESC_RATEMCS0 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t\t(DESC_RATEVHT1SS_MCS0 <= rate && rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower += rtlefuse->txpwr_ht20diff[path][TX_1S];\n\t\t\tif ((DESC_RATEMCS8 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t\t(DESC_RATEVHT2SS_MCS0 <= rate && rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower += rtlefuse->txpwr_ht20diff[path][TX_2S];\n\t\t} else if (bandwidth == HT_CHANNEL_WIDTH_20_40) {\n\t\t\tif ((DESC_RATEMCS0 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t\t(DESC_RATEVHT1SS_MCS0 <= rate && rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower += rtlefuse->txpwr_ht40diff[path][TX_1S];\n\t\t\tif ((DESC_RATEMCS8 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t\t(DESC_RATEVHT2SS_MCS0 <= rate && rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower += rtlefuse->txpwr_ht40diff[path][TX_2S];\n\t\t} else if (bandwidth == HT_CHANNEL_WIDTH_80) {\n\t\t\tif ((DESC_RATEMCS0 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t    (DESC_RATEVHT1SS_MCS0 <= rate &&\n\t\t\t     rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower += rtlefuse->txpwr_ht40diff[path][TX_1S];\n\t\t\tif ((DESC_RATEMCS8 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t    (DESC_RATEVHT2SS_MCS0 <= rate &&\n\t\t\t     rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower += rtlefuse->txpwr_ht40diff[path][TX_2S];\n\t\t}\n\t} else {\n\t\tif (DESC_RATE6M <= rate)\n\t\t\ttxpower = rtlefuse->txpwr_5g_bw40base[path][index];\n\t\telse\n\t\t\trtl_dbg(rtlpriv, COMP_POWER_TRACKING, DBG_WARNING,\n\t\t\t\t\"INVALID Rate.\\n\");\n\n\t\tif (DESC_RATE6M <= rate && rate <= DESC_RATE54M &&\n\t\t    !RTL8821AE_RX_HAL_IS_CCK_RATE(rate))\n\t\t\ttxpower += rtlefuse->txpwr_5g_ofdmdiff[path][TX_1S];\n\n\t\tif (bandwidth == HT_CHANNEL_WIDTH_20) {\n\t\t\tif ((DESC_RATEMCS0 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t    (DESC_RATEVHT1SS_MCS0 <= rate &&\n\t\t\t     rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower += rtlefuse->txpwr_5g_bw20diff[path][TX_1S];\n\t\t\tif ((DESC_RATEMCS8 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t    (DESC_RATEVHT2SS_MCS0 <= rate &&\n\t\t\t     rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower += rtlefuse->txpwr_5g_bw20diff[path][TX_2S];\n\t\t} else if (bandwidth == HT_CHANNEL_WIDTH_20_40) {\n\t\t\tif ((DESC_RATEMCS0 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t    (DESC_RATEVHT1SS_MCS0 <= rate &&\n\t\t\t     rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower += rtlefuse->txpwr_5g_bw40diff[path][TX_1S];\n\t\t\tif ((DESC_RATEMCS8 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t    (DESC_RATEVHT2SS_MCS0 <= rate &&\n\t\t\t     rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower += rtlefuse->txpwr_5g_bw40diff[path][TX_2S];\n\t\t} else if (bandwidth == HT_CHANNEL_WIDTH_80) {\n\t\t\tu8 i;\n\n\t\t\tfor (i = 0; i < sizeof(channel5g_80m) / sizeof(u8); ++i)\n\t\t\t\tif (channel5g_80m[i] == channel)\n\t\t\t\t\tindex = i;\n\n\t\t\tif ((DESC_RATEMCS0 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t    (DESC_RATEVHT1SS_MCS0 <= rate &&\n\t\t\t     rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower = rtlefuse->txpwr_5g_bw80base[path][index]\n\t\t\t\t\t+ rtlefuse->txpwr_5g_bw80diff[path][TX_1S];\n\t\t\tif ((DESC_RATEMCS8 <= rate && rate <= DESC_RATEMCS15) ||\n\t\t\t    (DESC_RATEVHT2SS_MCS0 <= rate &&\n\t\t\t     rate <= DESC_RATEVHT2SS_MCS9))\n\t\t\t\ttxpower = rtlefuse->txpwr_5g_bw80base[path][index]\n\t\t\t\t\t+ rtlefuse->txpwr_5g_bw80diff[path][TX_1S]\n\t\t\t\t\t+ rtlefuse->txpwr_5g_bw80diff[path][TX_2S];\n\t\t    }\n\t}\n\tif (rtlefuse->eeprom_regulatory != 2)\n\t\tpowerdiff_byrate =\n\t\t  _rtl8821ae_phy_get_txpower_by_rate(hw, (u8)(!in_24g),\n\t\t\t\t\t\t     path, rate);\n\n\tif (rate == DESC_RATEVHT1SS_MCS8 || rate == DESC_RATEVHT1SS_MCS9 ||\n\t    rate == DESC_RATEVHT2SS_MCS8 || rate == DESC_RATEVHT2SS_MCS9)\n\t\ttxpower -= powerdiff_byrate;\n\telse\n\t\ttxpower += powerdiff_byrate;\n\n\tif (rate > DESC_RATE11M)\n\t\ttxpower += rtlpriv->dm.remnant_ofdm_swing_idx[path];\n\telse\n\t\ttxpower += rtlpriv->dm.remnant_cck_idx;\n\n\tif (txpower > MAX_POWER_INDEX)\n\t\ttxpower = MAX_POWER_INDEX;\n\n\treturn txpower;\n}\n\nstatic void _rtl8821ae_phy_set_txpower_index(struct ieee80211_hw *hw,\n\t\t\t\t\t     u8 power_index, u8 path, u8 rate)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\tif (path == RF90_PATH_A) {\n\t\tswitch (rate) {\n\t\tcase DESC_RATE1M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_CCK11_CCK1,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE2M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_CCK11_CCK1,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE5_5M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_CCK11_CCK1,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE11M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_CCK11_CCK1,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE6M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_OFDM18_OFDM6,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE9M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_OFDM18_OFDM6,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE12M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_OFDM18_OFDM6,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE18M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_OFDM18_OFDM6,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE24M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_OFDM54_OFDM24,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE36M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_OFDM54_OFDM24,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE48M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_OFDM54_OFDM24,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE54M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_OFDM54_OFDM24,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS0:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS03_MCS00,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS1:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS03_MCS00,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS2:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS03_MCS00,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS3:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS03_MCS00,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS4:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS07_MCS04,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS5:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS07_MCS04,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS6:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS07_MCS04,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS7:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS07_MCS04,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS8:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS11_MCS08,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS9:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS11_MCS08,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS10:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS11_MCS08,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS11:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS11_MCS08,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS12:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS15_MCS12,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS13:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS15_MCS12,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS14:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS15_MCS12,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS15:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_MCS15_MCS12,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS0:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS1INDEX3_NSS1INDEX0,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS1:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS1INDEX3_NSS1INDEX0,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS2:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS1INDEX3_NSS1INDEX0,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS3:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS1INDEX3_NSS1INDEX0,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS4:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS1INDEX7_NSS1INDEX4,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS5:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS1INDEX7_NSS1INDEX4,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS6:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS1INDEX7_NSS1INDEX4,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS7:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS1INDEX7_NSS1INDEX4,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS8:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX1_NSS1INDEX8,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS9:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX1_NSS1INDEX8,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS0:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX1_NSS1INDEX8,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS1:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX1_NSS1INDEX8,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS2:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX5_NSS2INDEX2,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS3:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX5_NSS2INDEX2,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS4:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX5_NSS2INDEX2,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS5:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX5_NSS2INDEX2,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS6:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX9_NSS2INDEX6,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS7:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX9_NSS2INDEX6,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS8:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX9_NSS2INDEX6,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS9:\n\t\t\trtl_set_bbreg(hw, RTXAGC_A_NSS2INDEX9_NSS2INDEX6,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\trtl_dbg(rtlpriv, COMP_POWER, DBG_LOUD,\n\t\t\t\t\"Invalid Rate!!\\n\");\n\t\t\tbreak;\n\t\t}\n\t} else if (path == RF90_PATH_B) {\n\t\tswitch (rate) {\n\t\tcase DESC_RATE1M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_CCK11_CCK1,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE2M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_CCK11_CCK1,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE5_5M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_CCK11_CCK1,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE11M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_CCK11_CCK1,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE6M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_OFDM18_OFDM6,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE9M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_OFDM18_OFDM6,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE12M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_OFDM18_OFDM6,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE18M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_OFDM18_OFDM6,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE24M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_OFDM54_OFDM24,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE36M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_OFDM54_OFDM24,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE48M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_OFDM54_OFDM24,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATE54M:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_OFDM54_OFDM24,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS0:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS03_MCS00,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS1:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS03_MCS00,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS2:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS03_MCS00,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS3:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS03_MCS00,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS4:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS07_MCS04,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS5:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS07_MCS04,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS6:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS07_MCS04,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS7:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS07_MCS04,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS8:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS11_MCS08,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS9:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS11_MCS08,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS10:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS11_MCS08,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS11:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS11_MCS08,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS12:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS15_MCS12,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS13:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS15_MCS12,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS14:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS15_MCS12,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEMCS15:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_MCS15_MCS12,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS0:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS1INDEX3_NSS1INDEX0,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS1:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS1INDEX3_NSS1INDEX0,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS2:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS1INDEX3_NSS1INDEX0,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS3:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS1INDEX3_NSS1INDEX0,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS4:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS1INDEX7_NSS1INDEX4,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS5:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS1INDEX7_NSS1INDEX4,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS6:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS1INDEX7_NSS1INDEX4,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS7:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS1INDEX7_NSS1INDEX4,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS8:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX1_NSS1INDEX8,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT1SS_MCS9:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX1_NSS1INDEX8,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS0:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX1_NSS1INDEX8,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS1:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX1_NSS1INDEX8,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS2:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX5_NSS2INDEX2,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS3:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX5_NSS2INDEX2,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS4:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX5_NSS2INDEX2,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS5:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX5_NSS2INDEX2,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS6:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX9_NSS2INDEX6,\n\t\t\t\t      MASKBYTE0, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS7:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX9_NSS2INDEX6,\n\t\t\t\t      MASKBYTE1, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS8:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX9_NSS2INDEX6,\n\t\t\t\t      MASKBYTE2, power_index);\n\t\t\tbreak;\n\t\tcase DESC_RATEVHT2SS_MCS9:\n\t\t\trtl_set_bbreg(hw, RTXAGC_B_NSS2INDEX9_NSS2INDEX6,\n\t\t\t\t      MASKBYTE3, power_index);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\trtl_dbg(rtlpriv, COMP_POWER, DBG_LOUD,\n\t\t\t\t\"Invalid Rate!!\\n\");\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_POWER, DBG_LOUD,\n\t\t\t\"Invalid RFPath!!\\n\");\n\t}\n}\n\nstatic void _rtl8821ae_phy_set_txpower_level_by_path(struct ieee80211_hw *hw,\n\t\t\t\t\t\t     u8 *array, u8 path,\n\t\t\t\t\t\t     u8 channel, u8 size)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 i;\n\tu8 power_index;\n\n\tfor (i = 0; i < size; i++) {\n\t\tpower_index =\n\t\t  _rtl8821ae_get_txpower_index(hw, path, array[i],\n\t\t\t\t\t       rtlphy->current_chan_bw,\n\t\t\t\t\t       channel);\n\t\t_rtl8821ae_phy_set_txpower_index(hw, power_index, path,\n\t\t\t\t\t\t array[i]);\n\t}\n}\n\nstatic void _rtl8821ae_phy_txpower_training_by_path(struct ieee80211_hw *hw,\n\t\t\t\t\t\t    u8 bw, u8 channel, u8 path)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\n\tu8 i;\n\tu32 power_level, data, offset;\n\n\tif (path >= rtlphy->num_total_rfpath)\n\t\treturn;\n\n\tdata = 0;\n\tif (path == RF90_PATH_A) {\n\t\tpower_level =\n\t\t\t_rtl8821ae_get_txpower_index(hw, RF90_PATH_A,\n\t\t\tDESC_RATEMCS7, bw, channel);\n\t\toffset =  RA_TXPWRTRAING;\n\t} else {\n\t\tpower_level =\n\t\t\t_rtl8821ae_get_txpower_index(hw, RF90_PATH_B,\n\t\t\tDESC_RATEMCS7, bw, channel);\n\t\toffset =  RB_TXPWRTRAING;\n\t}\n\n\tfor (i = 0; i < 3; i++) {\n\t\tif (i == 0)\n\t\t\tpower_level = power_level - 10;\n\t\telse if (i == 1)\n\t\t\tpower_level = power_level - 8;\n\t\telse\n\t\t\tpower_level = power_level - 6;\n\n\t\tdata |= (((power_level > 2) ? (power_level) : 2) << (i * 8));\n\t}\n\trtl_set_bbreg(hw, offset, 0xffffff, data);\n}\n\nvoid rtl8821ae_phy_set_txpower_level_by_path(struct ieee80211_hw *hw,\n\t\t\t\t\t     u8 channel, u8 path)\n{\n\t \n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 cck_rates[]  = {DESC_RATE1M, DESC_RATE2M, DESC_RATE5_5M,\n\t\t\t      DESC_RATE11M};\n\tu8 sizes_of_cck_retes = 4;\n\tu8 ofdm_rates[]  = {DESC_RATE6M, DESC_RATE9M, DESC_RATE12M,\n\t\t\t\tDESC_RATE18M, DESC_RATE24M, DESC_RATE36M,\n\t\t\t\tDESC_RATE48M, DESC_RATE54M};\n\tu8 sizes_of_ofdm_retes = 8;\n\tu8 ht_rates_1t[]  = {DESC_RATEMCS0, DESC_RATEMCS1, DESC_RATEMCS2,\n\t\t\t\tDESC_RATEMCS3, DESC_RATEMCS4, DESC_RATEMCS5,\n\t\t\t\tDESC_RATEMCS6, DESC_RATEMCS7};\n\tu8 sizes_of_ht_retes_1t = 8;\n\tu8 ht_rates_2t[]  = {DESC_RATEMCS8, DESC_RATEMCS9,\n\t\t\t\tDESC_RATEMCS10, DESC_RATEMCS11,\n\t\t\t\tDESC_RATEMCS12, DESC_RATEMCS13,\n\t\t\t\tDESC_RATEMCS14, DESC_RATEMCS15};\n\tu8 sizes_of_ht_retes_2t = 8;\n\tu8 vht_rates_1t[]  = {DESC_RATEVHT1SS_MCS0, DESC_RATEVHT1SS_MCS1,\n\t\t\t\tDESC_RATEVHT1SS_MCS2, DESC_RATEVHT1SS_MCS3,\n\t\t\t\tDESC_RATEVHT1SS_MCS4, DESC_RATEVHT1SS_MCS5,\n\t\t\t\tDESC_RATEVHT1SS_MCS6, DESC_RATEVHT1SS_MCS7,\n\t\t\t     DESC_RATEVHT1SS_MCS8, DESC_RATEVHT1SS_MCS9};\n\tu8 vht_rates_2t[]  = {DESC_RATEVHT2SS_MCS0, DESC_RATEVHT2SS_MCS1,\n\t\t\t\tDESC_RATEVHT2SS_MCS2, DESC_RATEVHT2SS_MCS3,\n\t\t\t\tDESC_RATEVHT2SS_MCS4, DESC_RATEVHT2SS_MCS5,\n\t\t\t\tDESC_RATEVHT2SS_MCS6, DESC_RATEVHT2SS_MCS7,\n\t\t\t\tDESC_RATEVHT2SS_MCS8, DESC_RATEVHT2SS_MCS9};\n\tu8 sizes_of_vht_retes = 10;\n\n\tif (rtlhal->current_bandtype == BAND_ON_2_4G)\n\t\t_rtl8821ae_phy_set_txpower_level_by_path(hw, cck_rates, path, channel,\n\t\t\t\t\t\t\t sizes_of_cck_retes);\n\n\t_rtl8821ae_phy_set_txpower_level_by_path(hw, ofdm_rates, path, channel,\n\t\t\t\t\t\t sizes_of_ofdm_retes);\n\t_rtl8821ae_phy_set_txpower_level_by_path(hw, ht_rates_1t, path, channel,\n\t\t\t\t\t\t sizes_of_ht_retes_1t);\n\t_rtl8821ae_phy_set_txpower_level_by_path(hw, vht_rates_1t, path, channel,\n\t\t\t\t\t\t sizes_of_vht_retes);\n\n\tif (rtlphy->num_total_rfpath >= 2) {\n\t\t_rtl8821ae_phy_set_txpower_level_by_path(hw, ht_rates_2t, path,\n\t\t\t\t\t\t\t channel,\n\t\t\t\t\t\t\t sizes_of_ht_retes_2t);\n\t\t_rtl8821ae_phy_set_txpower_level_by_path(hw, vht_rates_2t, path,\n\t\t\t\t\t\t\t channel,\n\t\t\t\t\t\t\t sizes_of_vht_retes);\n\t}\n\n\t_rtl8821ae_phy_txpower_training_by_path(hw, rtlphy->current_chan_bw,\n\t\t\t\t\t\tchannel, path);\n}\n\n \nvoid rtl8821ae_phy_set_txpower_level(struct ieee80211_hw *hw, u8 channel)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 path = 0;\n\n\tfor (path = RF90_PATH_A; path < rtlphy->num_total_rfpath; ++path)\n\t\trtl8821ae_phy_set_txpower_level_by_path(hw, channel, path);\n}\n\nstatic long _rtl8821ae_phy_txpwr_idx_to_dbm(struct ieee80211_hw *hw,\n\t\t\t\t\t    enum wireless_mode wirelessmode,\n\t\t\t\t\t    u8 txpwridx)\n{\n\tlong offset;\n\tlong pwrout_dbm;\n\n\tswitch (wirelessmode) {\n\tcase WIRELESS_MODE_B:\n\t\toffset = -7;\n\t\tbreak;\n\tcase WIRELESS_MODE_G:\n\tcase WIRELESS_MODE_N_24G:\n\t\toffset = -8;\n\t\tbreak;\n\tdefault:\n\t\toffset = -8;\n\t\tbreak;\n\t}\n\tpwrout_dbm = txpwridx / 2 + offset;\n\treturn pwrout_dbm;\n}\n\nvoid rtl8821ae_phy_scan_operation_backup(struct ieee80211_hw *hw, u8 operation)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tenum io_type iotype = IO_CMD_PAUSE_BAND0_DM_BY_SCAN;\n\n\tif (!is_hal_stop(rtlhal)) {\n\t\tswitch (operation) {\n\t\tcase SCAN_OPT_BACKUP_BAND0:\n\t\t\tiotype = IO_CMD_PAUSE_BAND0_DM_BY_SCAN;\n\t\t\trtlpriv->cfg->ops->set_hw_reg(hw,\n\t\t\t\t\t\t      HW_VAR_IO_CMD,\n\t\t\t\t\t\t      (u8 *)&iotype);\n\n\t\t\tbreak;\n\t\tcase SCAN_OPT_BACKUP_BAND1:\n\t\t\tiotype = IO_CMD_PAUSE_BAND1_DM_BY_SCAN;\n\t\t\trtlpriv->cfg->ops->set_hw_reg(hw,\n\t\t\t\t\t\t      HW_VAR_IO_CMD,\n\t\t\t\t\t\t      (u8 *)&iotype);\n\n\t\t\tbreak;\n\t\tcase SCAN_OPT_RESTORE:\n\t\t\tiotype = IO_CMD_RESUME_DM_BY_SCAN;\n\t\t\trtlpriv->cfg->ops->set_hw_reg(hw,\n\t\t\t\t\t\t      HW_VAR_IO_CMD,\n\t\t\t\t\t\t      (u8 *)&iotype);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpr_err(\"Unknown Scan Backup operation.\\n\");\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic void _rtl8821ae_phy_set_reg_bw(struct rtl_priv *rtlpriv, u8 bw)\n{\n\tu16 reg_rf_mode_bw, tmp = 0;\n\n\treg_rf_mode_bw = rtl_read_word(rtlpriv, REG_TRXPTCL_CTL);\n\tswitch (bw) {\n\tcase HT_CHANNEL_WIDTH_20:\n\t\trtl_write_word(rtlpriv, REG_TRXPTCL_CTL, reg_rf_mode_bw & 0xFE7F);\n\t\tbreak;\n\tcase HT_CHANNEL_WIDTH_20_40:\n\t\ttmp = reg_rf_mode_bw | BIT(7);\n\t\trtl_write_word(rtlpriv, REG_TRXPTCL_CTL, tmp & 0xFEFF);\n\t\tbreak;\n\tcase HT_CHANNEL_WIDTH_80:\n\t\ttmp = reg_rf_mode_bw | BIT(8);\n\t\trtl_write_word(rtlpriv, REG_TRXPTCL_CTL, tmp & 0xFF7F);\n\t\tbreak;\n\tdefault:\n\t\trtl_dbg(rtlpriv, COMP_ERR, DBG_WARNING, \"unknown Bandwidth: 0x%x\\n\", bw);\n\t\tbreak;\n\t}\n}\n\nstatic u8 _rtl8821ae_phy_get_secondary_chnl(struct rtl_priv *rtlpriv)\n{\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tstruct rtl_mac *mac = rtl_mac(rtlpriv);\n\tu8 sc_set_40 = 0, sc_set_20 = 0;\n\n\tif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_80) {\n\t\tif (mac->cur_80_prime_sc == PRIME_CHNL_OFFSET_LOWER)\n\t\t\tsc_set_40 = VHT_DATA_SC_40_LOWER_OF_80MHZ;\n\t\telse if (mac->cur_80_prime_sc == PRIME_CHNL_OFFSET_UPPER)\n\t\t\tsc_set_40 = VHT_DATA_SC_40_UPPER_OF_80MHZ;\n\t\telse\n\t\t\tpr_err(\"SCMapping: Not Correct Primary40MHz Setting\\n\");\n\n\t\tif ((mac->cur_40_prime_sc == PRIME_CHNL_OFFSET_LOWER) &&\n\t\t\t(mac->cur_80_prime_sc == HAL_PRIME_CHNL_OFFSET_LOWER))\n\t\t\tsc_set_20 = VHT_DATA_SC_20_LOWEST_OF_80MHZ;\n\t\telse if ((mac->cur_40_prime_sc == PRIME_CHNL_OFFSET_UPPER) &&\n\t\t\t(mac->cur_80_prime_sc == HAL_PRIME_CHNL_OFFSET_LOWER))\n\t\t\tsc_set_20 = VHT_DATA_SC_20_LOWER_OF_80MHZ;\n\t\telse if ((mac->cur_40_prime_sc == PRIME_CHNL_OFFSET_LOWER) &&\n\t\t\t(mac->cur_80_prime_sc == HAL_PRIME_CHNL_OFFSET_UPPER))\n\t\t\tsc_set_20 = VHT_DATA_SC_20_UPPER_OF_80MHZ;\n\t\telse if ((mac->cur_40_prime_sc == PRIME_CHNL_OFFSET_UPPER) &&\n\t\t\t(mac->cur_80_prime_sc == HAL_PRIME_CHNL_OFFSET_UPPER))\n\t\t\tsc_set_20 = VHT_DATA_SC_20_UPPERST_OF_80MHZ;\n\t\telse\n\t\t\tpr_err(\"SCMapping: Not Correct Primary40MHz Setting\\n\");\n\t} else if (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20_40) {\n\t\tif (mac->cur_40_prime_sc == PRIME_CHNL_OFFSET_UPPER)\n\t\t\tsc_set_20 = VHT_DATA_SC_20_UPPER_OF_80MHZ;\n\t\telse if (mac->cur_40_prime_sc == PRIME_CHNL_OFFSET_LOWER)\n\t\t\tsc_set_20 = VHT_DATA_SC_20_LOWER_OF_80MHZ;\n\t\telse\n\t\t\tpr_err(\"SCMapping: Not Correct Primary40MHz Setting\\n\");\n\t}\n\treturn (sc_set_40 << 4) | sc_set_20;\n}\n\nvoid rtl8821ae_phy_set_bw_mode_callback(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 sub_chnl = 0;\n\tu8 l1pk_val = 0;\n\n\trtl_dbg(rtlpriv, COMP_SCAN, DBG_TRACE,\n\t\t\"Switch to %s bandwidth\\n\",\n\t\t(rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20 ?\n\t\t \"20MHz\" :\n\t\t (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20_40 ?\n\t\t  \"40MHz\" : \"80MHz\")));\n\n\t_rtl8821ae_phy_set_reg_bw(rtlpriv, rtlphy->current_chan_bw);\n\tsub_chnl = _rtl8821ae_phy_get_secondary_chnl(rtlpriv);\n\trtl_write_byte(rtlpriv, 0x0483, sub_chnl);\n\n\tswitch (rtlphy->current_chan_bw) {\n\tcase HT_CHANNEL_WIDTH_20:\n\t\trtl_set_bbreg(hw, RRFMOD, 0x003003C3, 0x00300200);\n\t\trtl_set_bbreg(hw, RADC_BUF_CLK, BIT(30), 0);\n\n\t\tif (rtlphy->rf_type == RF_2T2R)\n\t\t\trtl_set_bbreg(hw, RL1PEAKTH, 0x03C00000, 7);\n\t\telse\n\t\t\trtl_set_bbreg(hw, RL1PEAKTH, 0x03C00000, 8);\n\t\tbreak;\n\tcase HT_CHANNEL_WIDTH_20_40:\n\t\trtl_set_bbreg(hw, RRFMOD, 0x003003C3, 0x00300201);\n\t\trtl_set_bbreg(hw, RADC_BUF_CLK, BIT(30), 0);\n\t\trtl_set_bbreg(hw, RRFMOD, 0x3C, sub_chnl);\n\t\trtl_set_bbreg(hw, RCCAONSEC, 0xf0000000, sub_chnl);\n\n\t\tif (rtlphy->reg_837 & BIT(2))\n\t\t\tl1pk_val = 6;\n\t\telse {\n\t\t\tif (rtlphy->rf_type == RF_2T2R)\n\t\t\t\tl1pk_val = 7;\n\t\t\telse\n\t\t\t\tl1pk_val = 8;\n\t\t}\n\t\t \n\t\trtl_set_bbreg(hw, RL1PEAKTH, 0x03C00000, l1pk_val);\n\n\t\tif (sub_chnl == VHT_DATA_SC_20_UPPER_OF_80MHZ)\n\t\t\trtl_set_bbreg(hw, RCCK_SYSTEM, BCCK_SYSTEM, 1);\n\t\telse\n\t\t\trtl_set_bbreg(hw, RCCK_SYSTEM, BCCK_SYSTEM, 0);\n\t\tbreak;\n\n\tcase HT_CHANNEL_WIDTH_80:\n\t\t  \n\t\trtl_set_bbreg(hw, RRFMOD, 0x003003C3, 0x00300202);\n\t\t \n\t\trtl_set_bbreg(hw, RADC_BUF_CLK, BIT(30), 1);\n\t\trtl_set_bbreg(hw, RRFMOD, 0x3C, sub_chnl);\n\t\trtl_set_bbreg(hw, RCCAONSEC, 0xf0000000, sub_chnl);\n\n\t\tif (rtlphy->reg_837 & BIT(2))\n\t\t\tl1pk_val = 5;\n\t\telse {\n\t\t\tif (rtlphy->rf_type == RF_2T2R)\n\t\t\t\tl1pk_val = 6;\n\t\t\telse\n\t\t\t\tl1pk_val = 7;\n\t\t}\n\t\trtl_set_bbreg(hw, RL1PEAKTH, 0x03C00000, l1pk_val);\n\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"unknown bandwidth: %#X\\n\",\n\t\t       rtlphy->current_chan_bw);\n\t\tbreak;\n\t}\n\n\trtl8812ae_fixspur(hw, rtlphy->current_chan_bw, rtlphy->current_channel);\n\n\trtl8821ae_phy_rf6052_set_bandwidth(hw, rtlphy->current_chan_bw);\n\trtlphy->set_bwmode_inprogress = false;\n\n\trtl_dbg(rtlpriv, COMP_SCAN, DBG_LOUD, \"\\n\");\n}\n\nvoid rtl8821ae_phy_set_bw_mode(struct ieee80211_hw *hw,\n\t\t\t    enum nl80211_channel_type ch_type)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tu8 tmp_bw = rtlphy->current_chan_bw;\n\n\tif (rtlphy->set_bwmode_inprogress)\n\t\treturn;\n\trtlphy->set_bwmode_inprogress = true;\n\tif ((!is_hal_stop(rtlhal)) && !(RT_CANNOT_IO(hw)))\n\t\trtl8821ae_phy_set_bw_mode_callback(hw);\n\telse {\n\t\trtl_dbg(rtlpriv, COMP_ERR, DBG_WARNING,\n\t\t\t\"FALSE driver sleep or unload\\n\");\n\t\trtlphy->set_bwmode_inprogress = false;\n\t\trtlphy->current_chan_bw = tmp_bw;\n\t}\n}\n\nvoid rtl8821ae_phy_sw_chnl_callback(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 channel = rtlphy->current_channel;\n\tu8 path;\n\tu32 data;\n\n\trtl_dbg(rtlpriv, COMP_SCAN, DBG_TRACE,\n\t\t\"switch to channel%d\\n\", rtlphy->current_channel);\n\tif (is_hal_stop(rtlhal))\n\t\treturn;\n\n\tif (36 <= channel && channel <= 48)\n\t\tdata = 0x494;\n\telse if (50 <= channel && channel <= 64)\n\t\tdata = 0x453;\n\telse if (100 <= channel && channel <= 116)\n\t\tdata = 0x452;\n\telse if (118 <= channel)\n\t\tdata = 0x412;\n\telse\n\t\tdata = 0x96a;\n\trtl_set_bbreg(hw, RFC_AREA, 0x1ffe0000, data);\n\n\tfor (path = RF90_PATH_A; path < rtlphy->num_total_rfpath; path++) {\n\t\tif (36 <= channel && channel <= 64)\n\t\t\tdata = 0x101;\n\t\telse if (100 <= channel && channel <= 140)\n\t\t\tdata = 0x301;\n\t\telse if (140 < channel)\n\t\t\tdata = 0x501;\n\t\telse\n\t\t\tdata = 0x000;\n\t\trtl8821ae_phy_set_rf_reg(hw, path, RF_CHNLBW,\n\t\t\tBIT(18)|BIT(17)|BIT(16)|BIT(9)|BIT(8), data);\n\n\t\trtl8821ae_phy_set_rf_reg(hw, path, RF_CHNLBW,\n\t\t\tBMASKBYTE0, channel);\n\n\t\tif (channel > 14) {\n\t\t\tif (rtlhal->hw_type == HARDWARE_TYPE_RTL8821AE) {\n\t\t\t\tif (36 <= channel && channel <= 64)\n\t\t\t\t\tdata = 0x114E9;\n\t\t\t\telse\n\t\t\t\t\tdata = 0x110E9;\n\t\t\t\trtl8821ae_phy_set_rf_reg(hw, path, RF_APK,\n\t\t\t\t\tBRFREGOFFSETMASK, data);\n\t\t\t}\n\t\t}\n\t}\n\trtl_dbg(rtlpriv, COMP_SCAN, DBG_TRACE, \"\\n\");\n}\n\nu8 rtl8821ae_phy_sw_chnl(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\tu32 timeout = 1000, timecount = 0;\n\tu8 channel = rtlphy->current_channel;\n\n\tif (rtlphy->sw_chnl_inprogress)\n\t\treturn 0;\n\tif (rtlphy->set_bwmode_inprogress)\n\t\treturn 0;\n\n\tif ((is_hal_stop(rtlhal)) || (RT_CANNOT_IO(hw))) {\n\t\trtl_dbg(rtlpriv, COMP_CHAN, DBG_LOUD,\n\t\t\t\"sw_chnl_inprogress false driver sleep or unload\\n\");\n\t\treturn 0;\n\t}\n\twhile (rtlphy->lck_inprogress && timecount < timeout) {\n\t\tmdelay(50);\n\t\ttimecount += 50;\n\t}\n\n\tif (rtlphy->current_channel > 14 && rtlhal->current_bandtype != BAND_ON_5G)\n\t\trtl8821ae_phy_switch_wirelessband(hw, BAND_ON_5G);\n\telse if (rtlphy->current_channel <= 14 && rtlhal->current_bandtype != BAND_ON_2_4G)\n\t\trtl8821ae_phy_switch_wirelessband(hw, BAND_ON_2_4G);\n\n\trtlphy->sw_chnl_inprogress = true;\n\tif (channel == 0)\n\t\tchannel = 1;\n\n\trtl_dbg(rtlpriv, COMP_SCAN, DBG_TRACE,\n\t\t\"switch to channel%d, band type is %d\\n\",\n\t\trtlphy->current_channel, rtlhal->current_bandtype);\n\n\trtl8821ae_phy_sw_chnl_callback(hw);\n\n\trtl8821ae_dm_clear_txpower_tracking_state(hw);\n\trtl8821ae_phy_set_txpower_level(hw, rtlphy->current_channel);\n\n\trtl_dbg(rtlpriv, COMP_SCAN, DBG_TRACE, \"\\n\");\n\trtlphy->sw_chnl_inprogress = false;\n\treturn 1;\n}\n\nu8 _rtl8812ae_get_right_chnl_place_for_iqk(u8 chnl)\n{\n\tstatic const u8 channel_all[TARGET_CHNL_NUM_2G_5G_8812] = {\n\t\t1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13,\n\t\t14, 36, 38, 40, 42, 44, 46, 48, 50, 52, 54,\n\t\t56, 58, 60, 62, 64, 100, 102, 104, 106, 108,\n\t\t110, 112, 114, 116, 118, 120, 122, 124, 126,\n\t\t128, 130, 132, 134, 136, 138, 140, 149, 151,\n\t\t153, 155, 157, 159, 161, 163, 165};\n\tu8 place;\n\n\tif (chnl > 14) {\n\t\tfor (place = 14; place < sizeof(channel_all); place++)\n\t\t\tif (channel_all[place] == chnl)\n\t\t\t\treturn place-13;\n\t}\n\n\treturn 0;\n}\n\n#define MACBB_REG_NUM 10\n#define AFE_REG_NUM 14\n#define RF_REG_NUM 3\n\nstatic void _rtl8821ae_iqk_backup_macbb(struct ieee80211_hw *hw,\n\t\t\t\t\tu32 *macbb_backup,\n\t\t\t\t\tu32 *backup_macbb_reg, u32 mac_bb_num)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 i;\n\n\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t \n\tfor (i = 0; i < mac_bb_num; i++)\n\t\tmacbb_backup[i] = rtl_read_dword(rtlpriv, backup_macbb_reg[i]);\n\n\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD, \"BackupMacBB Success!!!!\\n\");\n}\n\nstatic void _rtl8821ae_iqk_backup_afe(struct ieee80211_hw *hw, u32 *afe_backup,\n\t\t\t\t      u32 *backup_afe_REG, u32 afe_num)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 i;\n\n\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t \n\tfor (i = 0; i < afe_num; i++)\n\t\tafe_backup[i] = rtl_read_dword(rtlpriv, backup_afe_REG[i]);\n\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD, \"BackupAFE Success!!!!\\n\");\n}\n\nstatic void _rtl8821ae_iqk_backup_rf(struct ieee80211_hw *hw, u32 *rfa_backup,\n\t\t\t\t     u32 *rfb_backup, u32 *backup_rf_reg,\n\t\t\t\t     u32 rf_num)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 i;\n\n\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t \n\tfor (i = 0; i < rf_num; i++) {\n\t\trfa_backup[i] = rtl_get_rfreg(hw, RF90_PATH_A, backup_rf_reg[i],\n\t\t\t\t\t      BMASKDWORD);\n\t\trfb_backup[i] = rtl_get_rfreg(hw, RF90_PATH_B, backup_rf_reg[i],\n\t\t\t\t\t      BMASKDWORD);\n\t}\n\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD, \"BackupRF Success!!!!\\n\");\n}\n\nstatic void _rtl8821ae_iqk_configure_mac(\n\t\tstruct ieee80211_hw *hw\n\t\t)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\t \n\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\trtl_write_byte(rtlpriv, 0x522, 0x3f);\n\trtl_set_bbreg(hw, 0x550, BIT(11) | BIT(3), 0x0);\n\trtl_write_byte(rtlpriv, 0x808, 0x00);\t\t \n\trtl_set_bbreg(hw, 0x838, 0xf, 0xc);\t\t \n}\n\nstatic void _rtl8821ae_iqk_tx_fill_iqc(struct ieee80211_hw *hw,\n\t\t\t\t       enum radio_path path, u32 tx_x, u32 tx_y)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tswitch (path) {\n\tcase RF90_PATH_A:\n\t\t \n\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x1);\n\t\trtl_write_dword(rtlpriv, 0xc90, 0x00000080);\n\t\trtl_write_dword(rtlpriv, 0xcc4, 0x20040000);\n\t\trtl_write_dword(rtlpriv, 0xcc8, 0x20000000);\n\t\trtl_set_bbreg(hw, 0xccc, 0x000007ff, tx_y);\n\t\trtl_set_bbreg(hw, 0xcd4, 0x000007ff, tx_x);\n\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\"TX_X = %x;;TX_Y = %x =====> fill to IQC\\n\",\n\t\t\ttx_x, tx_y);\n\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\"0xcd4 = %x;;0xccc = %x ====>fill to IQC\\n\",\n\t\t\trtl_get_bbreg(hw, 0xcd4, 0x000007ff),\n\t\t\trtl_get_bbreg(hw, 0xccc, 0x000007ff));\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void _rtl8821ae_iqk_rx_fill_iqc(struct ieee80211_hw *hw,\n\t\t\t\t       enum radio_path path, u32 rx_x, u32 rx_y)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tswitch (path) {\n\tcase RF90_PATH_A:\n\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t\trtl_set_bbreg(hw, 0xc10, 0x000003ff, rx_x>>1);\n\t\trtl_set_bbreg(hw, 0xc10, 0x03ff0000, rx_y>>1);\n\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\"rx_x = %x;;rx_y = %x ====>fill to IQC\\n\",\n\t\t\trx_x >> 1, rx_y >> 1);\n\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\"0xc10 = %x ====>fill to IQC\\n\",\n\t\t\trtl_read_dword(rtlpriv, 0xc10));\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\n#define cal_num 10\n\nstatic void _rtl8821ae_iqk_tx(struct ieee80211_hw *hw, enum radio_path path)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\n\tu32\ttx_fail, rx_fail, delay_count, iqk_ready, cal_retry, cal = 0, temp_reg65;\n\tint\ttx_x = 0, tx_y = 0, rx_x = 0, rx_y = 0, tx_average = 0, rx_average = 0;\n\tint\ttx_x0[cal_num], tx_y0[cal_num], tx_x0_rxk[cal_num],\n\t\ttx_y0_rxk[cal_num], rx_x0[cal_num], rx_y0[cal_num],\n\t\ttx_dt[cal_num], rx_dt[cal_num];\n\tbool\ttx0iqkok = false, rx0iqkok = false;\n\tbool\tvdf_enable = false;\n\tint\ti, k, vdf_y[3], vdf_x[3],\n\t\tii, dx = 0, dy = 0, tx_finish = 0, rx_finish = 0;\n\n\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\"BandWidth = %d.\\n\",\n\t\trtlphy->current_chan_bw);\n\tif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_80)\n\t\tvdf_enable = true;\n\n\twhile (cal < cal_num) {\n\t\tswitch (path) {\n\t\tcase RF90_PATH_A:\n\t\t\ttemp_reg65 = rtl_get_rfreg(hw, path, 0x65, 0xffffffff);\n\t\t\t \n\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t\t\t \n\t\t\t \n\t\t\trtl_write_dword(rtlpriv, 0xc60, 0x77777777);\n\t\t\trtl_write_dword(rtlpriv, 0xc64, 0x77777777);\n\t\t\trtl_write_dword(rtlpriv, 0xc68, 0x19791979);\n\t\t\trtl_write_dword(rtlpriv, 0xc6c, 0x19791979);\n\t\t\trtl_write_dword(rtlpriv, 0xc70, 0x19791979);\n\t\t\trtl_write_dword(rtlpriv, 0xc74, 0x19791979);\n\t\t\trtl_write_dword(rtlpriv, 0xc78, 0x19791979);\n\t\t\trtl_write_dword(rtlpriv, 0xc7c, 0x19791979);\n\t\t\trtl_write_dword(rtlpriv, 0xc80, 0x19791979);\n\t\t\trtl_write_dword(rtlpriv, 0xc84, 0x19791979);\n\n\t\t\trtl_set_bbreg(hw, 0xc00, 0xf, 0x4);  \n\n\t\t\t \n\t\t\t \n\t\t\t \n\t\t\trtl_set_bbreg(hw, 0xc5c, BIT(26) | BIT(25) | BIT(24), 0x7);\n\n\t\t\t \n\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x80002);\n\t\t\trtl_set_rfreg(hw, path, 0x18, 0x00c00, 0x3);      \n\t\t\trtl_set_rfreg(hw, path, 0x30, RFREG_OFFSET_MASK, 0x20000);\n\t\t\trtl_set_rfreg(hw, path, 0x31, RFREG_OFFSET_MASK, 0x0003f);\n\t\t\trtl_set_rfreg(hw, path, 0x32, RFREG_OFFSET_MASK, 0xf3fc3);\n\t\t\trtl_set_rfreg(hw, path, 0x65, RFREG_OFFSET_MASK, 0x931d5);\n\t\t\trtl_set_rfreg(hw, path, 0x8f, RFREG_OFFSET_MASK, 0x8a001);\n\t\t\trtl_set_bbreg(hw, 0xcb8, 0xf, 0xd);\n\t\t\trtl_write_dword(rtlpriv, 0x90c, 0x00008000);\n\t\t\trtl_write_dword(rtlpriv, 0xb00, 0x03000100);\n\t\t\trtl_set_bbreg(hw, 0xc94, BIT(0), 0x1);\n\t\t\trtl_write_dword(rtlpriv, 0x978, 0x29002000); \n\t\t\trtl_write_dword(rtlpriv, 0x97c, 0xa9002000); \n\t\t\trtl_write_dword(rtlpriv, 0x984, 0x00462910); \n\n\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x1);  \n\t\t\trtl_write_dword(rtlpriv, 0xc88, 0x821403f4);\n\n\t\t\tif (rtlhal->current_bandtype)\n\t\t\t\trtl_write_dword(rtlpriv, 0xc8c, 0x68163e96);\n\t\t\telse\n\t\t\t\trtl_write_dword(rtlpriv, 0xc8c, 0x28163e96);\n\n\t\t\trtl_write_dword(rtlpriv, 0xc80, 0x18008c10); \n\t\t\trtl_write_dword(rtlpriv, 0xc84, 0x38008c10); \n\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00100000); \n\t\t\trtl_write_dword(rtlpriv, 0x980, 0xfa000000);\n\t\t\trtl_write_dword(rtlpriv, 0x980, 0xf8000000);\n\n\t\t\tmdelay(10);  \n\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00000000);\n\n\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t\t\trtl_set_rfreg(hw, path, 0x58, 0x7fe00, rtl_get_rfreg(hw, path, 0x8, 0xffc00));  \n\n\t\t\tswitch (rtlphy->current_chan_bw) {\n\t\t\tcase 1:\n\t\t\t\trtl_set_rfreg(hw, path, 0x18, 0x00c00, 0x1);\n\t\t\t\tbreak;\n\t\t\tcase 2:\n\t\t\t\trtl_set_rfreg(hw, path, 0x18, 0x00c00, 0x0);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x1);  \n\n\t\t\t \n\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x80000);\n\t\t\trtl_set_rfreg(hw, path, 0x30, RFREG_OFFSET_MASK, 0x20000);\n\t\t\trtl_set_rfreg(hw, path, 0x31, RFREG_OFFSET_MASK, 0x0003f);\n\t\t\trtl_set_rfreg(hw, path, 0x32, RFREG_OFFSET_MASK, 0xf3fc3);\n\t\t\trtl_set_rfreg(hw, path, 0x65, RFREG_OFFSET_MASK, 0x931d5);\n\t\t\trtl_set_rfreg(hw, path, 0x8f, RFREG_OFFSET_MASK, 0x8a001);\n\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x00000);\n\t\t\t \n\t\t\trtl_write_dword(rtlpriv, 0x90c, 0x00008000);\n\t\t\trtl_write_dword(rtlpriv, 0xb00, 0x03000100);\n\t\t\trtl_set_bbreg(hw, 0xc94, BIT(0), 0x1);\n\t\t\trtl_write_dword(rtlpriv, 0x978, 0x29002000); \n\t\t\trtl_write_dword(rtlpriv, 0x97c, 0xa9002000); \n\t\t\trtl_write_dword(rtlpriv, 0x984, 0x0046a910); \n\n\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x1);  \n\t\t\trtl_write_dword(rtlpriv, 0xc88, 0x821403f1);\n\t\t\tif (rtlhal->current_bandtype)\n\t\t\t\trtl_write_dword(rtlpriv, 0xc8c, 0x40163e96);\n\t\t\telse\n\t\t\t\trtl_write_dword(rtlpriv, 0xc8c, 0x00163e96);\n\n\t\t\tif (vdf_enable) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD, \"VDF_enable\\n\");\n\t\t\t\tfor (k = 0; k <= 2; k++) {\n\t\t\t\t\tswitch (k) {\n\t\t\t\t\tcase 0:\n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xc80, 0x18008c38); \n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xc84, 0x38008c38); \n\t\t\t\t\t\trtl_set_bbreg(hw, 0xce8, BIT(31), 0x0);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 1:\n\t\t\t\t\t\trtl_set_bbreg(hw, 0xc80, BIT(28), 0x0);\n\t\t\t\t\t\trtl_set_bbreg(hw, 0xc84, BIT(28), 0x0);\n\t\t\t\t\t\trtl_set_bbreg(hw, 0xce8, BIT(31), 0x0);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 2:\n\t\t\t\t\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\t\t\t\t\"vdf_y[1] = %x;;;vdf_y[0] = %x\\n\", vdf_y[1]>>21 & 0x00007ff, vdf_y[0]>>21 & 0x00007ff);\n\t\t\t\t\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\t\t\t\t\"vdf_x[1] = %x;;;vdf_x[0] = %x\\n\", vdf_x[1]>>21 & 0x00007ff, vdf_x[0]>>21 & 0x00007ff);\n\t\t\t\t\t\ttx_dt[cal] = (vdf_y[1]>>20)-(vdf_y[0]>>20);\n\t\t\t\t\t\ttx_dt[cal] = ((16*tx_dt[cal])*10000/15708);\n\t\t\t\t\t\ttx_dt[cal] = (tx_dt[cal] >> 1)+(tx_dt[cal] & BIT(0));\n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xc80, 0x18008c20); \n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xc84, 0x38008c20); \n\t\t\t\t\t\trtl_set_bbreg(hw, 0xce8, BIT(31), 0x1);\n\t\t\t\t\t\trtl_set_bbreg(hw, 0xce8, 0x3fff0000, tx_dt[cal] & 0x00003fff);\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00100000); \n\t\t\t\t\tcal_retry = 0;\n\t\t\t\t\twhile (1) {\n\t\t\t\t\t\t \n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xfa000000);\n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xf8000000);\n\n\t\t\t\t\t\tmdelay(10);  \n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00000000);\n\t\t\t\t\t\tdelay_count = 0;\n\t\t\t\t\t\twhile (1) {\n\t\t\t\t\t\t\tiqk_ready = rtl_get_bbreg(hw, 0xd00, BIT(10));\n\t\t\t\t\t\t\tif ((~iqk_ready) || (delay_count > 20))\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\telse{\n\t\t\t\t\t\t\t\tmdelay(1);\n\t\t\t\t\t\t\t\tdelay_count++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (delay_count < 20) {\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\ttx_fail = rtl_get_bbreg(hw, 0xd00, BIT(12));\n\n\t\t\t\t\t\t\tif (~tx_fail) {\n\t\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x02000000);\n\t\t\t\t\t\t\t\tvdf_x[k] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x04000000);\n\t\t\t\t\t\t\t\tvdf_y[k] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\t\ttx0iqkok = true;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xccc, 0x000007ff, 0x0);\n\t\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xcd4, 0x000007ff, 0x200);\n\t\t\t\t\t\t\t\ttx0iqkok = false;\n\t\t\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\ttx0iqkok = false;\n\t\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (k == 3) {\n\t\t\t\t\ttx_x0[cal] = vdf_x[k-1];\n\t\t\t\t\ttx_y0[cal] = vdf_y[k-1];\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\trtl_write_dword(rtlpriv, 0xc80, 0x18008c10); \n\t\t\t\trtl_write_dword(rtlpriv, 0xc84, 0x38008c10); \n\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00100000); \n\t\t\t\tcal_retry = 0;\n\t\t\t\twhile (1) {\n\t\t\t\t\t \n\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xfa000000);\n\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xf8000000);\n\n\t\t\t\t\tmdelay(10);  \n\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00000000);\n\t\t\t\t\tdelay_count = 0;\n\t\t\t\t\twhile (1) {\n\t\t\t\t\t\tiqk_ready = rtl_get_bbreg(hw, 0xd00, BIT(10));\n\t\t\t\t\t\tif ((~iqk_ready) || (delay_count > 20))\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\telse{\n\t\t\t\t\t\t\tmdelay(1);\n\t\t\t\t\t\t\tdelay_count++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (delay_count < 20) {\t\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\ttx_fail = rtl_get_bbreg(hw, 0xd00, BIT(12));\n\n\t\t\t\t\t\tif (~tx_fail) {\n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x02000000);\n\t\t\t\t\t\t\ttx_x0[cal] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x04000000);\n\t\t\t\t\t\t\ttx_y0[cal] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\ttx0iqkok = true;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xccc, 0x000007ff, 0x0);\n\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xcd4, 0x000007ff, 0x200);\n\t\t\t\t\t\t\ttx0iqkok = false;\n\t\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttx0iqkok = false;\n\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (!tx0iqkok)\n\t\t\t\tbreak;\t\t\t\t \n\n\t\t\tif (vdf_enable == 1) {\n\t\t\t\trtl_set_bbreg(hw, 0xce8, BIT(31), 0x0);     \n\t\t\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD, \"RXVDF Start\\n\");\n\t\t\t\tfor (k = 0; k <= 2; k++) {\n\t\t\t\t\t \n\t\t\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t\t\t\t\t \n\t\t\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x80000);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0x30, RFREG_OFFSET_MASK, 0x30000);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0x31, RFREG_OFFSET_MASK, 0x00029);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0x32, RFREG_OFFSET_MASK, 0xd7ffb);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0x65, RFREG_OFFSET_MASK, temp_reg65);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0x8f, RFREG_OFFSET_MASK, 0x8a001);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x00000);\n\n\t\t\t\t\trtl_set_bbreg(hw, 0xcb8, 0xf, 0xd);\n\t\t\t\t\trtl_write_dword(rtlpriv, 0x978, 0x29002000); \n\t\t\t\t\trtl_write_dword(rtlpriv, 0x97c, 0xa9002000); \n\t\t\t\t\trtl_write_dword(rtlpriv, 0x984, 0x0046a910); \n\t\t\t\t\trtl_write_dword(rtlpriv, 0x90c, 0x00008000);\n\t\t\t\t\trtl_write_dword(rtlpriv, 0xb00, 0x03000100);\n\t\t\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x1);  \n\t\t\t\t\tswitch (k) {\n\t\t\t\t\tcase 0:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xc80, 0x18008c38); \n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xc84, 0x38008c38); \n\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xce8, BIT(30), 0x0);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 1:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xc80, 0x08008c38); \n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xc84, 0x28008c38); \n\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xce8, BIT(30), 0x0);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tcase 2:\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\t\t\t\t\t\"VDF_Y[1] = %x;;;VDF_Y[0] = %x\\n\",\n\t\t\t\t\t\t\t\tvdf_y[1] >> 21 & 0x00007ff,\n\t\t\t\t\t\t\t\tvdf_y[0] >> 21 & 0x00007ff);\n\t\t\t\t\t\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\t\t\t\t\t\"VDF_X[1] = %x;;;VDF_X[0] = %x\\n\",\n\t\t\t\t\t\t\t\tvdf_x[1] >> 21 & 0x00007ff,\n\t\t\t\t\t\t\t\tvdf_x[0] >> 21 & 0x00007ff);\n\t\t\t\t\t\t\trx_dt[cal] = (vdf_y[1]>>20)-(vdf_y[0]>>20);\n\t\t\t\t\t\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD, \"Rx_dt = %d\\n\",\n\t\t\t\t\t\t\t\trx_dt[cal]);\n\t\t\t\t\t\t\trx_dt[cal] = ((16*rx_dt[cal])*10000/13823);\n\t\t\t\t\t\t\trx_dt[cal] = (rx_dt[cal] >> 1)+(rx_dt[cal] & BIT(0));\n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xc80, 0x18008c20); \n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xc84, 0x38008c20); \n\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xce8, 0x00003fff, rx_dt[cal] & 0x00003fff);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tbreak;\n\t\t\t\t\tdefault:\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t\trtl_write_dword(rtlpriv, 0xc88, 0x821603e0);\n\t\t\t\t\trtl_write_dword(rtlpriv, 0xc8c, 0x68163e96);\n\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00100000); \n\t\t\t\t\tcal_retry = 0;\n\t\t\t\t\twhile (1) {\n\t\t\t\t\t\t \n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xfa000000);\n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xf8000000);\n\n\t\t\t\t\t\tmdelay(10);  \n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00000000);\n\t\t\t\t\t\tdelay_count = 0;\n\t\t\t\t\t\twhile (1) {\n\t\t\t\t\t\t\tiqk_ready = rtl_get_bbreg(hw, 0xd00, BIT(10));\n\t\t\t\t\t\t\tif ((~iqk_ready) || (delay_count > 20))\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\telse{\n\t\t\t\t\t\t\t\tmdelay(1);\n\t\t\t\t\t\t\t\tdelay_count++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (delay_count < 20) {\t\t\t\t\t\t\t \n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\ttx_fail = rtl_get_bbreg(hw, 0xd00, BIT(12));\n\n\t\t\t\t\t\t\tif (~tx_fail) {\n\t\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x02000000);\n\t\t\t\t\t\t\t\ttx_x0_rxk[cal] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x04000000);\n\t\t\t\t\t\t\t\ttx_y0_rxk[cal] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\t\ttx0iqkok = true;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t} else{\n\t\t\t\t\t\t\t\ttx0iqkok = false;\n\t\t\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\ttx0iqkok = false;\n\t\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!tx0iqkok) {    \n\t\t\t\t\t\ttx_x0_rxk[cal] = tx_x0[cal];\n\t\t\t\t\t\ttx_y0_rxk[cal] = tx_y0[cal];\n\t\t\t\t\t\ttx0iqkok = true;\n\t\t\t\t\t\trtl_dbg(rtlpriv,\n\t\t\t\t\t\t\tCOMP_IQK,\n\t\t\t\t\t\t\tDBG_LOUD,\n\t\t\t\t\t\t\t\"RXK Step 1 fail\\n\");\n\t\t\t\t\t}\n\n\t\t\t\t\t \n\t\t\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t\t\t\t\t \n\t\t\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x80000);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0x30, RFREG_OFFSET_MASK, 0x30000);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0x31, RFREG_OFFSET_MASK, 0x0002f);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0x32, RFREG_OFFSET_MASK, 0xfffbb);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0x8f, RFREG_OFFSET_MASK, 0x88001);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0x65, RFREG_OFFSET_MASK, 0x931d8);\n\t\t\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x00000);\n\n\t\t\t\t\trtl_set_bbreg(hw, 0x978, 0x03FF8000, (tx_x0_rxk[cal])>>21&0x000007ff);\n\t\t\t\t\trtl_set_bbreg(hw, 0x978, 0x000007FF, (tx_y0_rxk[cal])>>21&0x000007ff);\n\t\t\t\t\trtl_set_bbreg(hw, 0x978, BIT(31), 0x1);\n\t\t\t\t\trtl_set_bbreg(hw, 0x97c, BIT(31), 0x0);\n\t\t\t\t\trtl_set_bbreg(hw, 0xcb8, 0xF, 0xe);\n\t\t\t\t\trtl_write_dword(rtlpriv, 0x90c, 0x00008000);\n\t\t\t\t\trtl_write_dword(rtlpriv, 0x984, 0x0046a911);\n\n\t\t\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x1);  \n\t\t\t\t\trtl_set_bbreg(hw, 0xc80, BIT(29), 0x1);\n\t\t\t\t\trtl_set_bbreg(hw, 0xc84, BIT(29), 0x0);\n\t\t\t\t\trtl_write_dword(rtlpriv, 0xc88, 0x02140119);\n\n\t\t\t\t\trtl_write_dword(rtlpriv, 0xc8c, 0x28160d00);  \n\n\t\t\t\t\tif (k == 2)\n\t\t\t\t\t\trtl_set_bbreg(hw, 0xce8, BIT(30), 0x1);   \n\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00100000); \n\n\t\t\t\t\tcal_retry = 0;\n\t\t\t\t\twhile (1) {\n\t\t\t\t\t\t \n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xfa000000);\n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xf8000000);\n\n\t\t\t\t\t\tmdelay(10);  \n\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00000000);\n\t\t\t\t\t\tdelay_count = 0;\n\t\t\t\t\t\twhile (1) {\n\t\t\t\t\t\t\tiqk_ready = rtl_get_bbreg(hw, 0xd00, BIT(10));\n\t\t\t\t\t\t\tif ((~iqk_ready) || (delay_count > 20))\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\telse{\n\t\t\t\t\t\t\t\tmdelay(1);\n\t\t\t\t\t\t\t\tdelay_count++;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tif (delay_count < 20) {\t \n\t\t\t\t\t\t\t \n\t\t\t\t\t\t\trx_fail = rtl_get_bbreg(hw, 0xd00, BIT(11));\n\t\t\t\t\t\t\tif (rx_fail == 0) {\n\t\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x06000000);\n\t\t\t\t\t\t\t\tvdf_x[k] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x08000000);\n\t\t\t\t\t\t\t\tvdf_y[k] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\t\trx0iqkok = true;\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xc10, 0x000003ff, 0x200>>1);\n\t\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xc10, 0x03ff0000, 0x0>>1);\n\t\t\t\t\t\t\t\trx0iqkok = false;\n\t\t\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else{\n\t\t\t\t\t\t\trx0iqkok = false;\n\t\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t}\n\t\t\t\tif (k == 3) {\n\t\t\t\t\trx_x0[cal] = vdf_x[k-1];\n\t\t\t\t\trx_y0[cal] = vdf_y[k-1];\n\t\t\t\t}\n\t\t\t\trtl_set_bbreg(hw, 0xce8, BIT(31), 0x1);     \n\t\t\t}\n\n\t\t\telse{\n\t\t\t\t \n\t\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t\t\t\t \n\t\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x80000);\n\t\t\t\trtl_set_rfreg(hw, path, 0x30, RFREG_OFFSET_MASK, 0x30000);\n\t\t\t\trtl_set_rfreg(hw, path, 0x31, RFREG_OFFSET_MASK, 0x00029);\n\t\t\t\trtl_set_rfreg(hw, path, 0x32, RFREG_OFFSET_MASK, 0xd7ffb);\n\t\t\t\trtl_set_rfreg(hw, path, 0x65, RFREG_OFFSET_MASK, temp_reg65);\n\t\t\t\trtl_set_rfreg(hw, path, 0x8f, RFREG_OFFSET_MASK, 0x8a001);\n\t\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x00000);\n\t\t\t\trtl_write_dword(rtlpriv, 0x90c, 0x00008000);\n\t\t\t\trtl_write_dword(rtlpriv, 0xb00, 0x03000100);\n\t\t\t\trtl_write_dword(rtlpriv, 0x984, 0x0046a910); \n\n\t\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x1);  \n\t\t\t\trtl_write_dword(rtlpriv, 0xc80, 0x18008c10); \n\t\t\t\trtl_write_dword(rtlpriv, 0xc84, 0x38008c10); \n\t\t\t\trtl_write_dword(rtlpriv, 0xc88, 0x821603e0);\n\t\t\t\t \n\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00100000); \n\t\t\t\tcal_retry = 0;\n\t\t\t\twhile (1) {\n\t\t\t\t\t \n\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xfa000000);\n\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xf8000000);\n\n\t\t\t\t\tmdelay(10);  \n\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00000000);\n\t\t\t\t\tdelay_count = 0;\n\t\t\t\t\twhile (1) {\n\t\t\t\t\t\tiqk_ready = rtl_get_bbreg(hw, 0xd00, BIT(10));\n\t\t\t\t\t\tif ((~iqk_ready) || (delay_count > 20))\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\telse{\n\t\t\t\t\t\t\tmdelay(1);\n\t\t\t\t\t\t\tdelay_count++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (delay_count < 20) {\t\t\t\t\t\t\t \n\t\t\t\t\t\t \n\t\t\t\t\t\ttx_fail = rtl_get_bbreg(hw, 0xd00, BIT(12));\n\n\t\t\t\t\t\tif (~tx_fail) {\n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x02000000);\n\t\t\t\t\t\t\ttx_x0_rxk[cal] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x04000000);\n\t\t\t\t\t\t\ttx_y0_rxk[cal] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\ttx0iqkok = true;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\ttx0iqkok = false;\n\t\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t} else{\n\t\t\t\t\t\ttx0iqkok = false;\n\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tif (!tx0iqkok) {    \n\t\t\t\t\ttx_x0_rxk[cal] = tx_x0[cal];\n\t\t\t\t\ttx_y0_rxk[cal] = tx_y0[cal];\n\t\t\t\t\ttx0iqkok = true;\n\t\t\t\t\trtl_dbg(rtlpriv, COMP_IQK,\n\t\t\t\t\t\tDBG_LOUD, \"1\");\n\t\t\t\t}\n\n\t\t\t\t \n\t\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t\t\t\t \n\t\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x80000);\n\t\t\t\trtl_set_rfreg(hw, path, 0x30, RFREG_OFFSET_MASK, 0x30000);\n\t\t\t\trtl_set_rfreg(hw, path, 0x31, RFREG_OFFSET_MASK, 0x0002f);\n\t\t\t\trtl_set_rfreg(hw, path, 0x32, RFREG_OFFSET_MASK, 0xfffbb);\n\t\t\t\trtl_set_rfreg(hw, path, 0x8f, RFREG_OFFSET_MASK, 0x88001);\n\t\t\t\trtl_set_rfreg(hw, path, 0x65, RFREG_OFFSET_MASK, 0x931d8);\n\t\t\t\trtl_set_rfreg(hw, path, 0xef, RFREG_OFFSET_MASK, 0x00000);\n\n\t\t\t\trtl_set_bbreg(hw, 0x978, 0x03FF8000, (tx_x0_rxk[cal])>>21&0x000007ff);\n\t\t\t\trtl_set_bbreg(hw, 0x978, 0x000007FF, (tx_y0_rxk[cal])>>21&0x000007ff);\n\t\t\t\trtl_set_bbreg(hw, 0x978, BIT(31), 0x1);\n\t\t\t\trtl_set_bbreg(hw, 0x97c, BIT(31), 0x0);\n\t\t\t\t \n\t\t\t\trtl_write_dword(rtlpriv, 0x90c, 0x00008000);\n\t\t\t\trtl_write_dword(rtlpriv, 0x984, 0x0046a911);\n\n\t\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x1);  \n\t\t\t\trtl_write_dword(rtlpriv, 0xc80, 0x38008c10); \n\t\t\t\trtl_write_dword(rtlpriv, 0xc84, 0x18008c10); \n\t\t\t\trtl_write_dword(rtlpriv, 0xc88, 0x02140119);\n\n\t\t\t\trtl_write_dword(rtlpriv, 0xc8c, 0x28160d00);  \n\n\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00100000); \n\n\t\t\t\tcal_retry = 0;\n\t\t\t\twhile (1) {\n\t\t\t\t\t \n\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xfa000000);\n\t\t\t\t\trtl_write_dword(rtlpriv, 0x980, 0xf8000000);\n\n\t\t\t\t\tmdelay(10);  \n\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x00000000);\n\t\t\t\t\tdelay_count = 0;\n\t\t\t\t\twhile (1) {\n\t\t\t\t\t\tiqk_ready = rtl_get_bbreg(hw, 0xd00, BIT(10));\n\t\t\t\t\t\tif ((~iqk_ready) || (delay_count > 20))\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\telse{\n\t\t\t\t\t\t\tmdelay(1);\n\t\t\t\t\t\t\tdelay_count++;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\n\t\t\t\t\tif (delay_count < 20) {\t \n\t\t\t\t\t\t \n\t\t\t\t\t\trx_fail = rtl_get_bbreg(hw, 0xd00, BIT(11));\n\t\t\t\t\t\tif (rx_fail == 0) {\n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x06000000);\n\t\t\t\t\t\t\trx_x0[cal] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\trtl_write_dword(rtlpriv, 0xcb8, 0x08000000);\n\t\t\t\t\t\t\trx_y0[cal] = rtl_get_bbreg(hw, 0xd00, 0x07ff0000)<<21;\n\t\t\t\t\t\t\trx0iqkok = true;\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t} else{\n\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xc10, 0x000003ff, 0x200>>1);\n\t\t\t\t\t\t\trtl_set_bbreg(hw, 0xc10, 0x03ff0000, 0x0>>1);\n\t\t\t\t\t\t\trx0iqkok = false;\n\t\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\t\tbreak;\n\n\t\t\t\t\t\t}\n\t\t\t\t\t} else{\n\t\t\t\t\t\trx0iqkok = false;\n\t\t\t\t\t\tcal_retry++;\n\t\t\t\t\t\tif (cal_retry == 10)\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (tx0iqkok)\n\t\t\t\ttx_average++;\n\t\t\tif (rx0iqkok)\n\t\t\t\trx_average++;\n\t\t\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t\t\trtl_set_rfreg(hw, path, 0x65, RFREG_OFFSET_MASK, temp_reg65);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tcal++;\n\t}\n\n\t \n\tswitch (path) {\n\tcase RF90_PATH_A:\n\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\"========Path_A =======\\n\");\n\t\tif (tx_average == 0)\n\t\t\tbreak;\n\n\t\tfor (i = 0; i < tx_average; i++) {\n\t\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\t\"TX_X0_RXK[%d] = %x ;; TX_Y0_RXK[%d] = %x\\n\", i,\n\t\t\t\t(tx_x0_rxk[i]) >> 21 & 0x000007ff, i,\n\t\t\t\t(tx_y0_rxk[i]) >> 21 & 0x000007ff);\n\t\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\t\"TX_X0[%d] = %x ;; TX_Y0[%d] = %x\\n\", i,\n\t\t\t\t(tx_x0[i]) >> 21 & 0x000007ff, i,\n\t\t\t\t(tx_y0[i]) >> 21 & 0x000007ff);\n\t\t}\n\t\tfor (i = 0; i < tx_average; i++) {\n\t\t\tfor (ii = i+1; ii < tx_average; ii++) {\n\t\t\t\tdx = (tx_x0[i]>>21) - (tx_x0[ii]>>21);\n\t\t\t\tif (dx < 3 && dx > -3) {\n\t\t\t\t\tdy = (tx_y0[i]>>21) - (tx_y0[ii]>>21);\n\t\t\t\t\tif (dy < 3 && dy > -3) {\n\t\t\t\t\t\ttx_x = ((tx_x0[i]>>21) + (tx_x0[ii]>>21))/2;\n\t\t\t\t\t\ttx_y = ((tx_y0[i]>>21) + (tx_y0[ii]>>21))/2;\n\t\t\t\t\t\ttx_finish = 1;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (tx_finish == 1)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (tx_finish == 1)\n\t\t\t_rtl8821ae_iqk_tx_fill_iqc(hw, path, tx_x, tx_y);  \n\t\telse\n\t\t\t_rtl8821ae_iqk_tx_fill_iqc(hw, path, 0x200, 0x0);\n\n\t\tif (rx_average == 0)\n\t\t\tbreak;\n\n\t\tfor (i = 0; i < rx_average; i++)\n\t\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\t\"RX_X0[%d] = %x ;; RX_Y0[%d] = %x\\n\", i,\n\t\t\t\t(rx_x0[i])>>21&0x000007ff, i,\n\t\t\t\t(rx_y0[i])>>21&0x000007ff);\n\t\tfor (i = 0; i < rx_average; i++) {\n\t\t\tfor (ii = i+1; ii < rx_average; ii++) {\n\t\t\t\tdx = (rx_x0[i]>>21) - (rx_x0[ii]>>21);\n\t\t\t\tif (dx < 4 && dx > -4) {\n\t\t\t\t\tdy = (rx_y0[i]>>21) - (rx_y0[ii]>>21);\n\t\t\t\t\tif (dy < 4 && dy > -4) {\n\t\t\t\t\t\trx_x = ((rx_x0[i]>>21) + (rx_x0[ii]>>21))/2;\n\t\t\t\t\t\trx_y = ((rx_y0[i]>>21) + (rx_y0[ii]>>21))/2;\n\t\t\t\t\t\trx_finish = 1;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (rx_finish == 1)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (rx_finish == 1)\n\t\t\t_rtl8821ae_iqk_rx_fill_iqc(hw, path, rx_x, rx_y);\n\t\telse\n\t\t\t_rtl8821ae_iqk_rx_fill_iqc(hw, path, 0x200, 0x0);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void _rtl8821ae_iqk_restore_rf(struct ieee80211_hw *hw,\n\t\t\t\t      enum radio_path path,\n\t\t\t\t      u32 *backup_rf_reg,\n\t\t\t\t      u32 *rf_backup, u32 rf_reg_num)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 i;\n\n\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\tfor (i = 0; i < RF_REG_NUM; i++)\n\t\trtl_set_rfreg(hw, path, backup_rf_reg[i], RFREG_OFFSET_MASK,\n\t\t\t      rf_backup[i]);\n\n\tswitch (path) {\n\tcase RF90_PATH_A:\n\t\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\t\"RestoreRF Path A Success!!!!\\n\");\n\t\tbreak;\n\tdefault:\n\t\t\tbreak;\n\t}\n}\n\nstatic void _rtl8821ae_iqk_restore_afe(struct ieee80211_hw *hw,\n\t\t\t\t       u32 *afe_backup, u32 *backup_afe_reg,\n\t\t\t\t       u32 afe_num)\n{\n\tu32 i;\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t \n\tfor (i = 0; i < afe_num; i++)\n\t\trtl_write_dword(rtlpriv, backup_afe_reg[i], afe_backup[i]);\n\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x1);  \n\trtl_write_dword(rtlpriv, 0xc80, 0x0);\n\trtl_write_dword(rtlpriv, 0xc84, 0x0);\n\trtl_write_dword(rtlpriv, 0xc88, 0x0);\n\trtl_write_dword(rtlpriv, 0xc8c, 0x3c000000);\n\trtl_write_dword(rtlpriv, 0xc90, 0x00000080);\n\trtl_write_dword(rtlpriv, 0xc94, 0x00000000);\n\trtl_write_dword(rtlpriv, 0xcc4, 0x20040000);\n\trtl_write_dword(rtlpriv, 0xcc8, 0x20000000);\n\trtl_write_dword(rtlpriv, 0xcb8, 0x0);\n\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD, \"RestoreAFE Success!!!!\\n\");\n}\n\nstatic void _rtl8821ae_iqk_restore_macbb(struct ieee80211_hw *hw,\n\t\t\t\t\t u32 *macbb_backup,\n\t\t\t\t\t u32 *backup_macbb_reg,\n\t\t\t\t\t u32 macbb_num)\n{\n\tu32 i;\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\trtl_set_bbreg(hw, 0x82c, BIT(31), 0x0);  \n\t \n\tfor (i = 0; i < macbb_num; i++)\n\t\trtl_write_dword(rtlpriv, backup_macbb_reg[i], macbb_backup[i]);\n\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD, \"RestoreMacBB Success!!!!\\n\");\n}\n\n#undef MACBB_REG_NUM\n#undef AFE_REG_NUM\n#undef RF_REG_NUM\n\n#define MACBB_REG_NUM 11\n#define AFE_REG_NUM 12\n#define RF_REG_NUM 3\n\nstatic void _rtl8821ae_phy_iq_calibrate(struct ieee80211_hw *hw)\n{\n\tu32\tmacbb_backup[MACBB_REG_NUM];\n\tu32 afe_backup[AFE_REG_NUM];\n\tu32 rfa_backup[RF_REG_NUM];\n\tu32 rfb_backup[RF_REG_NUM];\n\tu32 backup_macbb_reg[MACBB_REG_NUM] = {\n\t\t0xb00, 0x520, 0x550, 0x808, 0x90c, 0xc00, 0xc50,\n\t\t0xe00, 0xe50, 0x838, 0x82c\n\t};\n\tu32 backup_afe_reg[AFE_REG_NUM] = {\n\t\t0xc5c, 0xc60, 0xc64, 0xc68, 0xc6c, 0xc70, 0xc74,\n\t\t0xc78, 0xc7c, 0xc80, 0xc84, 0xcb8\n\t};\n\tu32\tbackup_rf_reg[RF_REG_NUM] = {0x65, 0x8f, 0x0};\n\n\t_rtl8821ae_iqk_backup_macbb(hw, macbb_backup, backup_macbb_reg,\n\t\t\t\t    MACBB_REG_NUM);\n\t_rtl8821ae_iqk_backup_afe(hw, afe_backup, backup_afe_reg, AFE_REG_NUM);\n\t_rtl8821ae_iqk_backup_rf(hw, rfa_backup, rfb_backup, backup_rf_reg,\n\t\t\t\t RF_REG_NUM);\n\n\t_rtl8821ae_iqk_configure_mac(hw);\n\t_rtl8821ae_iqk_tx(hw, RF90_PATH_A);\n\t_rtl8821ae_iqk_restore_rf(hw, RF90_PATH_A, backup_rf_reg, rfa_backup,\n\t\t\t\t  RF_REG_NUM);\n\n\t_rtl8821ae_iqk_restore_afe(hw, afe_backup, backup_afe_reg, AFE_REG_NUM);\n\t_rtl8821ae_iqk_restore_macbb(hw, macbb_backup, backup_macbb_reg,\n\t\t\t\t     MACBB_REG_NUM);\n}\n\nstatic void _rtl8821ae_phy_set_rfpath_switch(struct ieee80211_hw *hw, bool main)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\t \n\t \n\trtl_dbg(rtlpriv, COMP_INIT, DBG_LOUD, \"\\n\");\n\n\tif (main)\n\t\trtl_set_bbreg(hw, RA_RFE_PINMUX + 4, BIT(29) | BIT(28), 0x1);\n\telse\n\t\trtl_set_bbreg(hw, RA_RFE_PINMUX + 4, BIT(29) | BIT(28), 0x2);\n}\n\n#undef IQK_ADDA_REG_NUM\n#undef IQK_DELAY_TIME\n\nvoid rtl8812ae_phy_iq_calibrate(struct ieee80211_hw *hw, bool b_recovery)\n{\n}\n\nvoid rtl8812ae_do_iqk(struct ieee80211_hw *hw, u8 delta_thermal_index,\n\t\t      u8 thermal_value, u8 threshold)\n{\n\tstruct rtl_dm\t*rtldm = rtl_dm(rtl_priv(hw));\n\n\trtldm->thermalvalue_iqk = thermal_value;\n\trtl8812ae_phy_iq_calibrate(hw, false);\n}\n\nvoid rtl8821ae_phy_iq_calibrate(struct ieee80211_hw *hw, bool b_recovery)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\n\tif (!rtlphy->lck_inprogress) {\n\t\tspin_lock(&rtlpriv->locks.iqk_lock);\n\t\trtlphy->lck_inprogress = true;\n\t\tspin_unlock(&rtlpriv->locks.iqk_lock);\n\n\t\t_rtl8821ae_phy_iq_calibrate(hw);\n\n\t\tspin_lock(&rtlpriv->locks.iqk_lock);\n\t\trtlphy->lck_inprogress = false;\n\t\tspin_unlock(&rtlpriv->locks.iqk_lock);\n\t}\n}\n\nvoid rtl8821ae_reset_iqk_result(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tu8 i;\n\n\trtl_dbg(rtlpriv, COMP_IQK, DBG_LOUD,\n\t\t\"rtl8812ae_dm_reset_iqk_result:: settings regs %d default regs %d\\n\",\n\t\t(int)(sizeof(rtlphy->iqk_matrix) /\n\t\tsizeof(struct iqk_matrix_regs)),\n\t\tIQK_MATRIX_SETTINGS_NUM);\n\n\tfor (i = 0; i < IQK_MATRIX_SETTINGS_NUM; i++) {\n\t\trtlphy->iqk_matrix[i].value[0][0] = 0x100;\n\t\trtlphy->iqk_matrix[i].value[0][2] = 0x100;\n\t\trtlphy->iqk_matrix[i].value[0][4] = 0x100;\n\t\trtlphy->iqk_matrix[i].value[0][6] = 0x100;\n\n\t\trtlphy->iqk_matrix[i].value[0][1] = 0x0;\n\t\trtlphy->iqk_matrix[i].value[0][3] = 0x0;\n\t\trtlphy->iqk_matrix[i].value[0][5] = 0x0;\n\t\trtlphy->iqk_matrix[i].value[0][7] = 0x0;\n\n\t\trtlphy->iqk_matrix[i].iqk_done = false;\n\t}\n}\n\nvoid rtl8821ae_do_iqk(struct ieee80211_hw *hw, u8 delta_thermal_index,\n\t\t      u8 thermal_value, u8 threshold)\n{\n\tstruct rtl_dm\t*rtldm = rtl_dm(rtl_priv(hw));\n\n\trtl8821ae_reset_iqk_result(hw);\n\n\trtldm->thermalvalue_iqk = thermal_value;\n\trtl8821ae_phy_iq_calibrate(hw, false);\n}\n\nvoid rtl8821ae_phy_lc_calibrate(struct ieee80211_hw *hw)\n{\n}\n\nvoid rtl8821ae_phy_ap_calibrate(struct ieee80211_hw *hw, s8 delta)\n{\n}\n\nvoid rtl8821ae_phy_set_rfpath_switch(struct ieee80211_hw *hw, bool bmain)\n{\n\t_rtl8821ae_phy_set_rfpath_switch(hw, bmain);\n}\n\nbool rtl8821ae_phy_set_io_cmd(struct ieee80211_hw *hw, enum io_type iotype)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\tbool postprocessing = false;\n\n\trtl_dbg(rtlpriv, COMP_CMD, DBG_TRACE,\n\t\t\"-->IO Cmd(%#x), set_io_inprogress(%d)\\n\",\n\t\tiotype, rtlphy->set_io_inprogress);\n\tdo {\n\t\tswitch (iotype) {\n\t\tcase IO_CMD_RESUME_DM_BY_SCAN:\n\t\t\trtl_dbg(rtlpriv, COMP_CMD, DBG_TRACE,\n\t\t\t\t\"[IO CMD] Resume DM after scan.\\n\");\n\t\t\tpostprocessing = true;\n\t\t\tbreak;\n\t\tcase IO_CMD_PAUSE_BAND0_DM_BY_SCAN:\n\t\tcase IO_CMD_PAUSE_BAND1_DM_BY_SCAN:\n\t\t\trtl_dbg(rtlpriv, COMP_CMD, DBG_TRACE,\n\t\t\t\t\"[IO CMD] Pause DM before scan.\\n\");\n\t\t\tpostprocessing = true;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpr_err(\"switch case %#x not processed\\n\",\n\t\t\t       iotype);\n\t\t\tbreak;\n\t\t}\n\t} while (false);\n\tif (postprocessing && !rtlphy->set_io_inprogress) {\n\t\trtlphy->set_io_inprogress = true;\n\t\trtlphy->current_io_type = iotype;\n\t} else {\n\t\treturn false;\n\t}\n\trtl8821ae_phy_set_io(hw);\n\trtl_dbg(rtlpriv, COMP_CMD, DBG_TRACE, \"IO Type(%#x)\\n\", iotype);\n\treturn true;\n}\n\nstatic void rtl8821ae_phy_set_io(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct dig_t *dm_digtable = &rtlpriv->dm_digtable;\n\tstruct rtl_phy *rtlphy = &rtlpriv->phy;\n\n\trtl_dbg(rtlpriv, COMP_CMD, DBG_TRACE,\n\t\t\"--->Cmd(%#x), set_io_inprogress(%d)\\n\",\n\t\trtlphy->current_io_type, rtlphy->set_io_inprogress);\n\tswitch (rtlphy->current_io_type) {\n\tcase IO_CMD_RESUME_DM_BY_SCAN:\n\t\tif (rtlpriv->mac80211.opmode == NL80211_IFTYPE_ADHOC)\n\t\t\t_rtl8821ae_resume_tx_beacon(hw);\n\t\trtl8821ae_dm_write_dig(hw, rtlphy->initgain_backup.xaagccore1);\n\t\trtl8821ae_dm_write_cck_cca_thres(hw,\n\t\t\t\t\t\t rtlphy->initgain_backup.cca);\n\t\tbreak;\n\tcase IO_CMD_PAUSE_BAND0_DM_BY_SCAN:\n\t\tif (rtlpriv->mac80211.opmode == NL80211_IFTYPE_ADHOC)\n\t\t\t_rtl8821ae_stop_tx_beacon(hw);\n\t\trtlphy->initgain_backup.xaagccore1 = dm_digtable->cur_igvalue;\n\t\trtl8821ae_dm_write_dig(hw, 0x17);\n\t\trtlphy->initgain_backup.cca = dm_digtable->cur_cck_cca_thres;\n\t\trtl8821ae_dm_write_cck_cca_thres(hw, 0x40);\n\t\tbreak;\n\tcase IO_CMD_PAUSE_BAND1_DM_BY_SCAN:\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"switch case %#x not processed\\n\",\n\t\t       rtlphy->current_io_type);\n\t\tbreak;\n\t}\n\trtlphy->set_io_inprogress = false;\n\trtl_dbg(rtlpriv, COMP_CMD, DBG_TRACE,\n\t\t\"(%#x)\\n\", rtlphy->current_io_type);\n}\n\nstatic void rtl8821ae_phy_set_rf_on(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\trtl_write_byte(rtlpriv, REG_SPS0_CTRL, 0x2b);\n\trtl_write_byte(rtlpriv, REG_SYS_FUNC_EN, 0xE3);\n\trtl_write_byte(rtlpriv, REG_SYS_FUNC_EN, 0xE2);\n\trtl_write_byte(rtlpriv, REG_SYS_FUNC_EN, 0xE3);\n\trtl_write_byte(rtlpriv, REG_TXPAUSE, 0x00);\n}\n\nstatic bool _rtl8821ae_phy_set_rf_power_state(struct ieee80211_hw *hw,\n\t\t\t\t\t      enum rf_pwrstate rfpwr_state)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_pci_priv *pcipriv = rtl_pcipriv(hw);\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tstruct rtl_ps_ctl *ppsc = rtl_psc(rtl_priv(hw));\n\tbool bresult = true;\n\tu8 i, queue_id;\n\tstruct rtl8192_tx_ring *ring = NULL;\n\n\tswitch (rfpwr_state) {\n\tcase ERFON:\n\t\tif ((ppsc->rfpwr_state == ERFOFF) &&\n\t\t    RT_IN_PS_LEVEL(ppsc, RT_RF_OFF_LEVL_HALT_NIC)) {\n\t\t\tbool rtstatus = false;\n\t\t\tu32 initializecount = 0;\n\n\t\t\tdo {\n\t\t\t\tinitializecount++;\n\t\t\t\trtl_dbg(rtlpriv, COMP_RF, DBG_DMESG,\n\t\t\t\t\t\"IPS Set eRf nic enable\\n\");\n\t\t\t\trtstatus = rtl_ps_enable_nic(hw);\n\t\t\t} while (!rtstatus && (initializecount < 10));\n\t\t\tRT_CLEAR_PS_LEVEL(ppsc,\n\t\t\t\t\t  RT_RF_OFF_LEVL_HALT_NIC);\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_RF, DBG_DMESG,\n\t\t\t\t\"Set ERFON slept:%d ms\\n\",\n\t\t\t\tjiffies_to_msecs(jiffies -\n\t\t\t\t\t\t ppsc->last_sleep_jiffies));\n\t\t\tppsc->last_awake_jiffies = jiffies;\n\t\t\trtl8821ae_phy_set_rf_on(hw);\n\t\t}\n\t\tif (mac->link_state == MAC80211_LINKED) {\n\t\t\trtlpriv->cfg->ops->led_control(hw,\n\t\t\t\t\t\t       LED_CTL_LINK);\n\t\t} else {\n\t\t\trtlpriv->cfg->ops->led_control(hw,\n\t\t\t\t\t\t       LED_CTL_NO_LINK);\n\t\t}\n\t\tbreak;\n\tcase ERFOFF:\n\t\tfor (queue_id = 0, i = 0;\n\t\t     queue_id < RTL_PCI_MAX_TX_QUEUE_COUNT;) {\n\t\t\tring = &pcipriv->dev.tx_ring[queue_id];\n\t\t\tif (queue_id == BEACON_QUEUE ||\n\t\t\t    skb_queue_len(&ring->queue) == 0) {\n\t\t\t\tqueue_id++;\n\t\t\t\tcontinue;\n\t\t\t} else {\n\t\t\t\trtl_dbg(rtlpriv, COMP_ERR, DBG_WARNING,\n\t\t\t\t\t\"eRf Off/Sleep: %d times TcbBusyQueue[%d] =%d before doze!\\n\",\n\t\t\t\t\t(i + 1), queue_id,\n\t\t\t\t\tskb_queue_len(&ring->queue));\n\n\t\t\t\tudelay(10);\n\t\t\t\ti++;\n\t\t\t}\n\t\t\tif (i >= MAX_DOZE_WAITING_TIMES_9x) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_ERR, DBG_WARNING,\n\t\t\t\t\t\"\\n ERFSLEEP: %d times TcbBusyQueue[%d] = %d !\\n\",\n\t\t\t\t\tMAX_DOZE_WAITING_TIMES_9x,\n\t\t\t\t\tqueue_id,\n\t\t\t\t\tskb_queue_len(&ring->queue));\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\n\t\tif (ppsc->reg_rfps_level & RT_RF_OFF_LEVL_HALT_NIC) {\n\t\t\trtl_dbg(rtlpriv, COMP_RF, DBG_DMESG,\n\t\t\t\t\"IPS Set eRf nic disable\\n\");\n\t\t\trtl_ps_disable_nic(hw);\n\t\t\tRT_SET_PS_LEVEL(ppsc, RT_RF_OFF_LEVL_HALT_NIC);\n\t\t} else {\n\t\t\tif (ppsc->rfoff_reason == RF_CHANGE_BY_IPS) {\n\t\t\t\trtlpriv->cfg->ops->led_control(hw,\n\t\t\t\t\t\t\t       LED_CTL_NO_LINK);\n\t\t\t} else {\n\t\t\t\trtlpriv->cfg->ops->led_control(hw,\n\t\t\t\t\t\t\t       LED_CTL_POWER_OFF);\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"switch case %#x not processed\\n\",\n\t\t       rfpwr_state);\n\t\tbresult = false;\n\t\tbreak;\n\t}\n\tif (bresult)\n\t\tppsc->rfpwr_state = rfpwr_state;\n\treturn bresult;\n}\n\nbool rtl8821ae_phy_set_rf_power_state(struct ieee80211_hw *hw,\n\t\t\t\t      enum rf_pwrstate rfpwr_state)\n{\n\tstruct rtl_ps_ctl *ppsc = rtl_psc(rtl_priv(hw));\n\n\tbool bresult = false;\n\n\tif (rfpwr_state == ppsc->rfpwr_state)\n\t\treturn bresult;\n\tbresult = _rtl8821ae_phy_set_rf_power_state(hw, rfpwr_state);\n\treturn bresult;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}