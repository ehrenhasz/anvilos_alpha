{
  "module_name": "regd.c",
  "hash_id": "7923289179b228ceee4671ddeb55d6b452369879ebe6cf08f460c684b863b39d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtlwifi/regd.c",
  "human_readable_source": "\n \n\n#include \"wifi.h\"\n#include \"regd.h\"\n\nstatic struct country_code_to_enum_rd all_countries[] = {\n\t{COUNTRY_CODE_FCC, \"US\"},\n\t{COUNTRY_CODE_IC, \"US\"},\n\t{COUNTRY_CODE_ETSI, \"EC\"},\n\t{COUNTRY_CODE_SPAIN, \"EC\"},\n\t{COUNTRY_CODE_FRANCE, \"EC\"},\n\t{COUNTRY_CODE_MKK, \"JP\"},\n\t{COUNTRY_CODE_MKK1, \"JP\"},\n\t{COUNTRY_CODE_ISRAEL, \"EC\"},\n\t{COUNTRY_CODE_TELEC, \"JP\"},\n\t{COUNTRY_CODE_MIC, \"JP\"},\n\t{COUNTRY_CODE_GLOBAL_DOMAIN, \"JP\"},\n\t{COUNTRY_CODE_WORLD_WIDE_13, \"EC\"},\n\t{COUNTRY_CODE_TELEC_NETGEAR, \"EC\"},\n\t{COUNTRY_CODE_WORLD_WIDE_13_5G_ALL, \"US\"},\n};\n\n \n#define RTL819x_2GHZ_CH01_11\t\\\n\tREG_RULE(2412-10, 2462+10, 40, 0, 20, 0)\n\n \n#define RTL819x_2GHZ_CH12_13\t\\\n\tREG_RULE(2467-10, 2472+10, 40, 0, 20,\\\n\tNL80211_RRF_PASSIVE_SCAN)\n\n#define RTL819x_2GHZ_CH14\t\\\n\tREG_RULE(2484-10, 2484+10, 40, 0, 20, \\\n\tNL80211_RRF_PASSIVE_SCAN | \\\n\tNL80211_RRF_NO_OFDM)\n\n \n#define RTL819x_5GHZ_5150_5350\t\\\n\tREG_RULE(5150-10, 5350+10, 80, 0, 30, 0)\n \n#define RTL819x_5GHZ_5470_5850\t\\\n\tREG_RULE(5470-10, 5850+10, 80, 0, 30, 0)\n \n#define RTL819x_5GHZ_5725_5850\t\\\n\tREG_RULE(5725-10, 5850+10, 80, 0, 30, 0)\n\n#define RTL819x_5GHZ_ALL\t\\\n\t(RTL819x_5GHZ_5150_5350, RTL819x_5GHZ_5470_5850)\n\nstatic const struct ieee80211_regdomain rtl_regdom_11 = {\n\t.n_reg_rules = 1,\n\t.alpha2 = \"99\",\n\t.reg_rules = {\n\t\t      RTL819x_2GHZ_CH01_11,\n\t\t      }\n};\n\nstatic const struct ieee80211_regdomain rtl_regdom_12_13 = {\n\t.n_reg_rules = 2,\n\t.alpha2 = \"99\",\n\t.reg_rules = {\n\t\t      RTL819x_2GHZ_CH01_11,\n\t\t\t  RTL819x_2GHZ_CH12_13,\n\t\t      }\n};\n\nstatic const struct ieee80211_regdomain rtl_regdom_no_midband = {\n\t.n_reg_rules = 3,\n\t.alpha2 = \"99\",\n\t.reg_rules = {\n\t\t      RTL819x_2GHZ_CH01_11,\n\t\t\t  RTL819x_5GHZ_5150_5350,\n\t\t\t  RTL819x_5GHZ_5725_5850,\n\t\t      }\n};\n\nstatic const struct ieee80211_regdomain rtl_regdom_60_64 = {\n\t.n_reg_rules = 3,\n\t.alpha2 = \"99\",\n\t.reg_rules = {\n\t\t      RTL819x_2GHZ_CH01_11,\n\t\t\t  RTL819x_2GHZ_CH12_13,\n\t\t\t  RTL819x_5GHZ_5725_5850,\n\t\t      }\n};\n\nstatic const struct ieee80211_regdomain rtl_regdom_14_60_64 = {\n\t.n_reg_rules = 4,\n\t.alpha2 = \"99\",\n\t.reg_rules = {\n\t\t      RTL819x_2GHZ_CH01_11,\n\t\t\t  RTL819x_2GHZ_CH12_13,\n\t\t\t  RTL819x_2GHZ_CH14,\n\t\t\t  RTL819x_5GHZ_5725_5850,\n\t\t      }\n};\n\nstatic const struct ieee80211_regdomain rtl_regdom_12_13_5g_all = {\n\t.n_reg_rules = 4,\n\t.alpha2 = \"99\",\n\t.reg_rules = {\n\t\t\tRTL819x_2GHZ_CH01_11,\n\t\t\tRTL819x_2GHZ_CH12_13,\n\t\t\tRTL819x_5GHZ_5150_5350,\n\t\t\tRTL819x_5GHZ_5470_5850,\n\t\t}\n};\n\nstatic const struct ieee80211_regdomain rtl_regdom_14 = {\n\t.n_reg_rules = 3,\n\t.alpha2 = \"99\",\n\t.reg_rules = {\n\t\t      RTL819x_2GHZ_CH01_11,\n\t\t\t  RTL819x_2GHZ_CH12_13,\n\t\t\t  RTL819x_2GHZ_CH14,\n\t\t      }\n};\n\nstatic bool _rtl_is_radar_freq(u16 center_freq)\n{\n\treturn center_freq >= 5260 && center_freq <= 5700;\n}\n\nstatic void _rtl_reg_apply_beaconing_flags(struct wiphy *wiphy,\n\t\t\t\t\t   enum nl80211_reg_initiator initiator)\n{\n\tenum nl80211_band band;\n\tstruct ieee80211_supported_band *sband;\n\tconst struct ieee80211_reg_rule *reg_rule;\n\tstruct ieee80211_channel *ch;\n\tunsigned int i;\n\n\tfor (band = 0; band < NUM_NL80211_BANDS; band++) {\n\n\t\tif (!wiphy->bands[band])\n\t\t\tcontinue;\n\n\t\tsband = wiphy->bands[band];\n\n\t\tfor (i = 0; i < sband->n_channels; i++) {\n\t\t\tch = &sband->channels[i];\n\t\t\tif (_rtl_is_radar_freq(ch->center_freq) ||\n\t\t\t    (ch->flags & IEEE80211_CHAN_RADAR))\n\t\t\t\tcontinue;\n\t\t\tif (initiator == NL80211_REGDOM_SET_BY_COUNTRY_IE) {\n\t\t\t\treg_rule = freq_reg_info(wiphy,\n\t\t\t\t\t\t\t ch->center_freq);\n\t\t\t\tif (IS_ERR(reg_rule))\n\t\t\t\t\tcontinue;\n\t\t\t\t \n\n\t\t\t\tif (!(reg_rule->flags & NL80211_RRF_NO_IBSS))\n\t\t\t\t\tch->flags &= ~IEEE80211_CHAN_NO_IBSS;\n\t\t\t\tif (!(reg_rule->flags &\n\t\t\t\t      NL80211_RRF_PASSIVE_SCAN))\n\t\t\t\t\tch->flags &=\n\t\t\t\t\t    ~IEEE80211_CHAN_PASSIVE_SCAN;\n\t\t\t} else {\n\t\t\t\tif (ch->beacon_found)\n\t\t\t\t\tch->flags &= ~(IEEE80211_CHAN_NO_IBSS |\n\t\t\t\t\t\t   IEEE80211_CHAN_PASSIVE_SCAN);\n\t\t\t}\n\t\t}\n\t}\n}\n\n \nstatic void _rtl_reg_apply_active_scan_flags(struct wiphy *wiphy,\n\t\t\t\t\t     enum nl80211_reg_initiator\n\t\t\t\t\t     initiator)\n{\n\tstruct ieee80211_supported_band *sband;\n\tstruct ieee80211_channel *ch;\n\tconst struct ieee80211_reg_rule *reg_rule;\n\n\tif (!wiphy->bands[NL80211_BAND_2GHZ])\n\t\treturn;\n\tsband = wiphy->bands[NL80211_BAND_2GHZ];\n\n\t \n\tif (initiator != NL80211_REGDOM_SET_BY_COUNTRY_IE) {\n\t\tch = &sband->channels[11];\t \n\t\tif (ch->flags & IEEE80211_CHAN_PASSIVE_SCAN)\n\t\t\tch->flags &= ~IEEE80211_CHAN_PASSIVE_SCAN;\n\t\tch = &sband->channels[12];\t \n\t\tif (ch->flags & IEEE80211_CHAN_PASSIVE_SCAN)\n\t\t\tch->flags &= ~IEEE80211_CHAN_PASSIVE_SCAN;\n\t\treturn;\n\t}\n\n\t \n\n\tch = &sband->channels[11];\t \n\treg_rule = freq_reg_info(wiphy, ch->center_freq);\n\tif (!IS_ERR(reg_rule)) {\n\t\tif (!(reg_rule->flags & NL80211_RRF_PASSIVE_SCAN))\n\t\t\tif (ch->flags & IEEE80211_CHAN_PASSIVE_SCAN)\n\t\t\t\tch->flags &= ~IEEE80211_CHAN_PASSIVE_SCAN;\n\t}\n\n\tch = &sband->channels[12];\t \n\treg_rule = freq_reg_info(wiphy, ch->center_freq);\n\tif (!IS_ERR(reg_rule)) {\n\t\tif (!(reg_rule->flags & NL80211_RRF_PASSIVE_SCAN))\n\t\t\tif (ch->flags & IEEE80211_CHAN_PASSIVE_SCAN)\n\t\t\t\tch->flags &= ~IEEE80211_CHAN_PASSIVE_SCAN;\n\t}\n}\n\n \nstatic void _rtl_reg_apply_radar_flags(struct wiphy *wiphy)\n{\n\tstruct ieee80211_supported_band *sband;\n\tstruct ieee80211_channel *ch;\n\tunsigned int i;\n\n\tif (!wiphy->bands[NL80211_BAND_5GHZ])\n\t\treturn;\n\n\tsband = wiphy->bands[NL80211_BAND_5GHZ];\n\n\tfor (i = 0; i < sband->n_channels; i++) {\n\t\tch = &sband->channels[i];\n\t\tif (!_rtl_is_radar_freq(ch->center_freq))\n\t\t\tcontinue;\n\n\t\t \n\t\tif (!(ch->flags & IEEE80211_CHAN_DISABLED))\n\t\t\tch->flags |= IEEE80211_CHAN_RADAR |\n\t\t\t    IEEE80211_CHAN_NO_IBSS |\n\t\t\t    IEEE80211_CHAN_PASSIVE_SCAN;\n\t}\n}\n\nstatic void _rtl_reg_apply_world_flags(struct wiphy *wiphy,\n\t\t\t\t       enum nl80211_reg_initiator initiator,\n\t\t\t\t       struct rtl_regulatory *reg)\n{\n\t_rtl_reg_apply_beaconing_flags(wiphy, initiator);\n\t_rtl_reg_apply_active_scan_flags(wiphy, initiator);\n\treturn;\n}\n\nstatic int _rtl_reg_notifier_apply(struct wiphy *wiphy,\n\t\t\t\t   struct regulatory_request *request,\n\t\t\t\t   struct rtl_regulatory *reg)\n{\n\t \n\t_rtl_reg_apply_radar_flags(wiphy);\n\n\tswitch (request->initiator) {\n\tcase NL80211_REGDOM_SET_BY_DRIVER:\n\tcase NL80211_REGDOM_SET_BY_CORE:\n\tcase NL80211_REGDOM_SET_BY_USER:\n\t\tbreak;\n\tcase NL80211_REGDOM_SET_BY_COUNTRY_IE:\n\t\t_rtl_reg_apply_world_flags(wiphy, request->initiator, reg);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct ieee80211_regdomain *_rtl_regdomain_select(\n\t\t\t\t\t\tstruct rtl_regulatory *reg)\n{\n\tswitch (reg->country_code) {\n\tcase COUNTRY_CODE_FCC:\n\t\treturn &rtl_regdom_no_midband;\n\tcase COUNTRY_CODE_IC:\n\t\treturn &rtl_regdom_11;\n\tcase COUNTRY_CODE_TELEC_NETGEAR:\n\t\treturn &rtl_regdom_60_64;\n\tcase COUNTRY_CODE_ETSI:\n\tcase COUNTRY_CODE_SPAIN:\n\tcase COUNTRY_CODE_FRANCE:\n\tcase COUNTRY_CODE_ISRAEL:\n\t\treturn &rtl_regdom_12_13;\n\tcase COUNTRY_CODE_MKK:\n\tcase COUNTRY_CODE_MKK1:\n\tcase COUNTRY_CODE_TELEC:\n\tcase COUNTRY_CODE_MIC:\n\t\treturn &rtl_regdom_14_60_64;\n\tcase COUNTRY_CODE_GLOBAL_DOMAIN:\n\t\treturn &rtl_regdom_14;\n\tcase COUNTRY_CODE_WORLD_WIDE_13:\n\tcase COUNTRY_CODE_WORLD_WIDE_13_5G_ALL:\n\t\treturn &rtl_regdom_12_13_5g_all;\n\tdefault:\n\t\treturn &rtl_regdom_no_midband;\n\t}\n}\n\nstatic int _rtl_regd_init_wiphy(struct rtl_regulatory *reg,\n\t\t\t\tstruct wiphy *wiphy,\n\t\t\t\tvoid (*reg_notifier)(struct wiphy *wiphy,\n\t\t\t\t\t\t     struct regulatory_request *\n\t\t\t\t\t\t     request))\n{\n\tconst struct ieee80211_regdomain *regd;\n\n\twiphy->reg_notifier = reg_notifier;\n\n\twiphy->regulatory_flags |= REGULATORY_CUSTOM_REG;\n\twiphy->regulatory_flags &= ~REGULATORY_STRICT_REG;\n\twiphy->regulatory_flags &= ~REGULATORY_DISABLE_BEACON_HINTS;\n\tregd = _rtl_regdomain_select(reg);\n\twiphy_apply_custom_regulatory(wiphy, regd);\n\t_rtl_reg_apply_radar_flags(wiphy);\n\t_rtl_reg_apply_world_flags(wiphy, NL80211_REGDOM_SET_BY_DRIVER, reg);\n\treturn 0;\n}\n\nstatic struct country_code_to_enum_rd *_rtl_regd_find_country(u16 countrycode)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(all_countries); i++) {\n\t\tif (all_countries[i].countrycode == countrycode)\n\t\t\treturn &all_countries[i];\n\t}\n\treturn NULL;\n}\n\nstatic u8 channel_plan_to_country_code(u8 channelplan)\n{\n\tswitch (channelplan) {\n\tcase 0x20:\n\tcase 0x21:\n\t\treturn COUNTRY_CODE_WORLD_WIDE_13;\n\tcase 0x22:\n\t\treturn COUNTRY_CODE_IC;\n\tcase 0x25:\n\t\treturn COUNTRY_CODE_ETSI;\n\tcase 0x32:\n\t\treturn COUNTRY_CODE_TELEC_NETGEAR;\n\tcase 0x41:\n\t\treturn COUNTRY_CODE_GLOBAL_DOMAIN;\n\tcase 0x7f:\n\t\treturn COUNTRY_CODE_WORLD_WIDE_13_5G_ALL;\n\tdefault:\n\t\treturn COUNTRY_CODE_MAX;  \n\t}\n}\n\nint rtl_regd_init(struct ieee80211_hw *hw,\n\t\t  void (*reg_notifier)(struct wiphy *wiphy,\n\t\t\t\t       struct regulatory_request *request))\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct wiphy *wiphy = hw->wiphy;\n\tstruct country_code_to_enum_rd *country = NULL;\n\n\tif (!wiphy)\n\t\treturn -EINVAL;\n\n\t \n\trtlpriv->regd.country_code =\n\t\tchannel_plan_to_country_code(rtlpriv->efuse.channel_plan);\n\n\trtl_dbg(rtlpriv, COMP_REGD, DBG_DMESG,\n\t\t\"rtl: EEPROM regdomain: 0x%0x country code: %d\\n\",\n\t\trtlpriv->efuse.channel_plan, rtlpriv->regd.country_code);\n\n\tif (rtlpriv->regd.country_code >= COUNTRY_CODE_MAX) {\n\t\trtl_dbg(rtlpriv, COMP_REGD, DBG_DMESG,\n\t\t\t\"rtl: EEPROM indicates invalid country code, world wide 13 should be used\\n\");\n\n\t\trtlpriv->regd.country_code = COUNTRY_CODE_WORLD_WIDE_13;\n\t}\n\n\tcountry = _rtl_regd_find_country(rtlpriv->regd.country_code);\n\n\tif (country) {\n\t\trtlpriv->regd.alpha2[0] = country->iso_name[0];\n\t\trtlpriv->regd.alpha2[1] = country->iso_name[1];\n\t} else {\n\t\trtlpriv->regd.alpha2[0] = '0';\n\t\trtlpriv->regd.alpha2[1] = '0';\n\t}\n\n\trtl_dbg(rtlpriv, COMP_REGD, DBG_TRACE,\n\t\t\"rtl: Country alpha2 being used: %c%c\\n\",\n\t\trtlpriv->regd.alpha2[0], rtlpriv->regd.alpha2[1]);\n\n\t_rtl_regd_init_wiphy(&rtlpriv->regd, wiphy, reg_notifier);\n\n\treturn 0;\n}\n\nvoid rtl_reg_notifier(struct wiphy *wiphy, struct regulatory_request *request)\n{\n\tstruct ieee80211_hw *hw = wiphy_to_ieee80211_hw(wiphy);\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\trtl_dbg(rtlpriv, COMP_REGD, DBG_LOUD, \"\\n\");\n\n\t_rtl_reg_notifier_apply(wiphy, request, &rtlpriv->regd);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}