{
  "module_name": "hal_btc.c",
  "hash_id": "2f4c5ddc48b612a23a58a72adc3df2be88e9b1a712f226cde50ef2b1e5188e65",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtlwifi/rtl8723ae/hal_btc.c",
  "human_readable_source": "\n \n\n#include \"hal_btc.h\"\n#include \"../pci.h\"\n#include \"phy.h\"\n#include \"fw.h\"\n#include \"reg.h\"\n#include \"def.h\"\n#include \"../rtl8723com/phy_common.h\"\n\nstatic struct bt_coexist_8723 hal_coex_8723;\n\nvoid rtl8723e_dm_bt_turn_off_bt_coexist_before_enter_lps(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_ps_ctl *ppsc = rtl_psc(rtl_priv(hw));\n\n\tif (!rtlpriv->btcoexist.bt_coexistence)\n\t\treturn;\n\n\tif (ppsc->inactiveps) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BT][DM], Before enter IPS, turn off all Coexist DM\\n\");\n\t\trtlpriv->btcoexist.cstate = 0;\n\t\trtlpriv->btcoexist.previous_state = 0;\n\t\trtlpriv->btcoexist.cstate_h = 0;\n\t\trtlpriv->btcoexist.previous_state_h = 0;\n\t\trtl8723e_btdm_coex_all_off(hw);\n\t}\n}\n\nstatic enum rt_media_status mgnt_link_status_query(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tenum rt_media_status    m_status = RT_MEDIA_DISCONNECT;\n\tu8 bibss = (mac->opmode == NL80211_IFTYPE_ADHOC) ? 1 : 0;\n\tif (bibss || rtlpriv->mac80211.link_state >= MAC80211_LINKED)\n\t\tm_status = RT_MEDIA_CONNECT;\n\n\treturn m_status;\n}\n\nvoid rtl_8723e_bt_wifi_media_status_notify(struct ieee80211_hw *hw,\n\t\t\t\t\t\tbool mstatus)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &(rtlpriv->phy);\n\tu8 h2c_parameter[3] = {0};\n\tu8 chnl;\n\n\tif (!rtlpriv->btcoexist.bt_coexistence)\n\t\treturn;\n\n\tif (RT_MEDIA_CONNECT == mstatus)\n\t\th2c_parameter[0] = 0x1;  \n\telse\n\t\th2c_parameter[0] = 0x0;\n\n\tif (mgnt_link_status_query(hw))\t{\n\t\tchnl = rtlphy->current_channel;\n\t\th2c_parameter[1] = chnl;\n\t}\n\n\tif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20_40)\n\t\th2c_parameter[2] = 0x30;\n\telse\n\t\th2c_parameter[2] = 0x20;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"[BTCoex], FW write 0x19=0x%x\\n\",\n\t\th2c_parameter[0] << 16 | h2c_parameter[1] << 8 |\n\t\th2c_parameter[2]);\n\n\trtl8723e_fill_h2c_cmd(hw, 0x19, 3, h2c_parameter);\n}\n\nstatic bool rtl8723e_dm_bt_is_wifi_busy(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tif (rtlpriv->link_info.busytraffic ||\n\t\trtlpriv->link_info.rx_busy_traffic ||\n\t\trtlpriv->link_info.tx_busy_traffic)\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\nstatic void rtl8723e_dm_bt_set_fw_3a(struct ieee80211_hw *hw,\n\t\t\t\t     u8 byte1, u8 byte2, u8 byte3, u8 byte4,\n\t\t\t\t     u8 byte5)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 h2c_parameter[5];\n\n\th2c_parameter[0] = byte1;\n\th2c_parameter[1] = byte2;\n\th2c_parameter[2] = byte3;\n\th2c_parameter[3] = byte4;\n\th2c_parameter[4] = byte5;\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], FW write 0x3a(4bytes)=0x%x%8x\\n\",\n\t\th2c_parameter[0], h2c_parameter[1]<<24 |\n\t\th2c_parameter[2]<<16 | h2c_parameter[3]<<8 |\n\t\th2c_parameter[4]);\n\trtl8723e_fill_h2c_cmd(hw, 0x3a, 5, h2c_parameter);\n}\n\nstatic bool rtl8723e_dm_bt_need_to_dec_bt_pwr(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\tif (mgnt_link_status_query(hw) == RT_MEDIA_CONNECT) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"Need to decrease bt power\\n\");\n\t\trtlpriv->btcoexist.cstate |=\n\t\tBT_COEX_STATE_DEC_BT_POWER;\n\t\treturn true;\n\t}\n\n\trtlpriv->btcoexist.cstate &= ~BT_COEX_STATE_DEC_BT_POWER;\n\treturn false;\n}\n\nstatic bool rtl8723e_dm_bt_is_same_coexist_state(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\tif ((rtlpriv->btcoexist.previous_state ==\n\t     rtlpriv->btcoexist.cstate) &&\n\t    (rtlpriv->btcoexist.previous_state_h ==\n\t     rtlpriv->btcoexist.cstate_h)) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[DM][BT], Coexist state do not change!!\\n\");\n\t\treturn true;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[DM][BT], Coexist state changed!!\\n\");\n\t\treturn false;\n\t}\n}\n\nstatic void rtl8723e_dm_bt_set_coex_table(struct ieee80211_hw *hw,\n\t\t\t\t\t  u32 val_0x6c0, u32 val_0x6c8,\n\t\t\t\t\t  u32 val_0x6cc)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"set coex table, set 0x6c0=0x%x\\n\", val_0x6c0);\n\trtl_write_dword(rtlpriv, 0x6c0, val_0x6c0);\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"set coex table, set 0x6c8=0x%x\\n\", val_0x6c8);\n\trtl_write_dword(rtlpriv, 0x6c8, val_0x6c8);\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"set coex table, set 0x6cc=0x%x\\n\", val_0x6cc);\n\trtl_write_byte(rtlpriv, 0x6cc, val_0x6cc);\n}\n\nstatic void rtl8723e_dm_bt_set_hw_pta_mode(struct ieee80211_hw *hw, bool b_mode)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\tif (BT_PTA_MODE_ON == b_mode) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE, \"PTA mode on\\n\");\n\t\t \n\t\trtl_write_byte(rtlpriv, 0x40, 0x20);\n\t\trtlpriv->btcoexist.hw_coexist_all_off = false;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE, \"PTA mode off\\n\");\n\t\trtl_write_byte(rtlpriv, 0x40, 0x0);\n\t}\n}\n\nstatic void rtl8723e_dm_bt_set_sw_rf_rx_lpf_corner(struct ieee80211_hw *hw,\n\t\t\t\t\t\t   u8 type)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\tif (BT_RF_RX_LPF_CORNER_SHRINK == type) {\n\t\t \n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"Shrink RF Rx LPF corner!!\\n\");\n\t\trtl8723e_phy_set_rf_reg(hw, RF90_PATH_A, 0x1e,\n\t\t\t\t\t0xfffff, 0xf0ff7);\n\t\trtlpriv->btcoexist.sw_coexist_all_off = false;\n\t} else if (BT_RF_RX_LPF_CORNER_RESUME == type) {\n\t\t \n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"Resume RF Rx LPF corner!!\\n\");\n\t\trtl8723e_phy_set_rf_reg(hw, RF90_PATH_A, 0x1e, 0xfffff,\n\t\t\t\t\trtlpriv->btcoexist.bt_rfreg_origin_1e);\n\t}\n}\n\nstatic void dm_bt_set_sw_penalty_tx_rate_adapt(struct ieee80211_hw *hw,\n\t\t\t\t\t       u8 ra_type)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 tmp_u1;\n\n\ttmp_u1 = rtl_read_byte(rtlpriv, 0x4fd);\n\ttmp_u1 |= BIT(0);\n\tif (BT_TX_RATE_ADAPTIVE_LOW_PENALTY == ra_type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"Tx rate adaptive, set low penalty!!\\n\");\n\t\ttmp_u1 &= ~BIT(2);\n\t\trtlpriv->btcoexist.sw_coexist_all_off = false;\n\t} else if (BT_TX_RATE_ADAPTIVE_NORMAL == ra_type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"Tx rate adaptive, set normal!!\\n\");\n\t\ttmp_u1 |= BIT(2);\n\t}\n\n\trtl_write_byte(rtlpriv, 0x4fd, tmp_u1);\n}\n\nstatic void rtl8723e_dm_bt_btdm_structure_reload(struct ieee80211_hw *hw,\n\t\t\t\t\t\t struct btdm_8723 *btdm)\n{\n\tbtdm->all_off = false;\n\tbtdm->agc_table_en = false;\n\tbtdm->adc_back_off_on = false;\n\tbtdm->b2_ant_hid_en = false;\n\tbtdm->low_penalty_rate_adaptive = false;\n\tbtdm->rf_rx_lpf_shrink = false;\n\tbtdm->reject_aggre_pkt = false;\n\n\tbtdm->tdma_on = false;\n\tbtdm->tdma_ant = TDMA_2ANT;\n\tbtdm->tdma_nav = TDMA_NAV_OFF;\n\tbtdm->tdma_dac_swing = TDMA_DAC_SWING_OFF;\n\tbtdm->fw_dac_swing_lvl = 0x20;\n\n\tbtdm->tra_tdma_on = false;\n\tbtdm->tra_tdma_ant = TDMA_2ANT;\n\tbtdm->tra_tdma_nav = TDMA_NAV_OFF;\n\tbtdm->ignore_wlan_act = false;\n\n\tbtdm->ps_tdma_on = false;\n\tbtdm->ps_tdma_byte[0] = 0x0;\n\tbtdm->ps_tdma_byte[1] = 0x0;\n\tbtdm->ps_tdma_byte[2] = 0x0;\n\tbtdm->ps_tdma_byte[3] = 0x8;\n\tbtdm->ps_tdma_byte[4] = 0x0;\n\n\tbtdm->pta_on = true;\n\tbtdm->val_0x6c0 = 0x5a5aaaaa;\n\tbtdm->val_0x6c8 = 0xcc;\n\tbtdm->val_0x6cc = 0x3;\n\n\tbtdm->sw_dac_swing_on = false;\n\tbtdm->sw_dac_swing_lvl = 0xc0;\n\tbtdm->wlan_act_hi = 0x20;\n\tbtdm->wlan_act_lo = 0x10;\n\tbtdm->bt_retry_index = 2;\n\n\tbtdm->dec_bt_pwr = false;\n}\n\nstatic void rtl8723e_dm_bt_btdm_structure_reload_all_off(struct ieee80211_hw *hw,\n\t\t\t\t\t\t\t struct btdm_8723 *btdm)\n{\n\trtl8723e_dm_bt_btdm_structure_reload(hw, btdm);\n\tbtdm->all_off = true;\n\tbtdm->pta_on = false;\n\tbtdm->wlan_act_hi = 0x10;\n}\n\nstatic bool rtl8723e_dm_bt_is_2_ant_common_action(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct btdm_8723 btdm8723;\n\tbool b_common = false;\n\n\trtl8723e_dm_bt_btdm_structure_reload(hw, &btdm8723);\n\n\tif (!rtl8723e_dm_bt_is_wifi_busy(hw) &&\n\t    !rtlpriv->btcoexist.bt_busy) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"Wifi idle + Bt idle, bt coex mechanism always off!!\\n\");\n\t\trtl8723e_dm_bt_btdm_structure_reload_all_off(hw, &btdm8723);\n\t\tb_common = true;\n\t} else if (rtl8723e_dm_bt_is_wifi_busy(hw) &&\n\t\t   !rtlpriv->btcoexist.bt_busy) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"Wifi non-idle + Bt disabled/idle!!\\n\");\n\t\tbtdm8723.low_penalty_rate_adaptive = true;\n\t\tbtdm8723.rf_rx_lpf_shrink = false;\n\t\tbtdm8723.reject_aggre_pkt = false;\n\n\t\t \n\t\tbtdm8723.agc_table_en = false;\n\t\tbtdm8723.adc_back_off_on = false;\n\t\tbtdm8723.sw_dac_swing_on = false;\n\n\t\tbtdm8723.pta_on = true;\n\t\tbtdm8723.val_0x6c0 = 0x5a5aaaaa;\n\t\tbtdm8723.val_0x6c8 = 0xcccc;\n\t\tbtdm8723.val_0x6cc = 0x3;\n\n\t\tbtdm8723.tdma_on = false;\n\t\tbtdm8723.tdma_dac_swing = TDMA_DAC_SWING_OFF;\n\t\tbtdm8723.b2_ant_hid_en = false;\n\n\t\tb_common = true;\n\t} else if (rtlpriv->btcoexist.bt_busy) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"Bt non-idle!\\n\");\n\t\tif (mgnt_link_status_query(hw) == RT_MEDIA_CONNECT) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi connection exist\\n\");\n\t\t\tb_common = false;\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"No Wifi connection!\\n\");\n\t\t\tbtdm8723.rf_rx_lpf_shrink = true;\n\t\t\tbtdm8723.low_penalty_rate_adaptive = false;\n\t\t\tbtdm8723.reject_aggre_pkt = false;\n\n\t\t\t \n\t\t\tbtdm8723.agc_table_en = false;\n\t\t\tbtdm8723.adc_back_off_on = false;\n\t\t\tbtdm8723.sw_dac_swing_on = false;\n\n\t\t\tbtdm8723.pta_on = true;\n\t\t\tbtdm8723.val_0x6c0 = 0x55555555;\n\t\t\tbtdm8723.val_0x6c8 = 0x0000ffff;\n\t\t\tbtdm8723.val_0x6cc = 0x3;\n\n\t\t\tbtdm8723.tdma_on = false;\n\t\t\tbtdm8723.tdma_dac_swing = TDMA_DAC_SWING_OFF;\n\t\t\tbtdm8723.b2_ant_hid_en = false;\n\n\t\t\tb_common = true;\n\t\t}\n\t}\n\n\tif (rtl8723e_dm_bt_need_to_dec_bt_pwr(hw))\n\t\tbtdm8723.dec_bt_pwr = true;\n\n\tif (b_common)\n\t\trtlpriv->btcoexist.cstate |=\n\t\t\tBT_COEX_STATE_BTINFO_COMMON;\n\n\tif (b_common && rtl8723e_dm_bt_is_coexist_state_changed(hw))\n\t\trtl8723e_dm_bt_set_bt_dm(hw, &btdm8723);\n\n\treturn b_common;\n}\n\nstatic void rtl8723e_dm_bt_set_sw_full_time_dac_swing(\n\t\tstruct ieee80211_hw *hw,\n\t\tbool sw_dac_swing_on,\n\t\tu32 sw_dac_swing_lvl)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\tif (sw_dac_swing_on) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], SwDacSwing = 0x%x\\n\", sw_dac_swing_lvl);\n\t\trtl8723_phy_set_bb_reg(hw, 0x880, 0xff000000,\n\t\t\t\t       sw_dac_swing_lvl);\n\t\trtlpriv->btcoexist.sw_coexist_all_off = false;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], SwDacSwing Off!\\n\");\n\t\trtl8723_phy_set_bb_reg(hw, 0x880, 0xff000000, 0xc0);\n\t}\n}\n\nstatic void rtl8723e_dm_bt_set_fw_dec_bt_pwr(\n\t\tstruct ieee80211_hw *hw, bool dec_bt_pwr)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 h2c_parameter[1] = {0};\n\n\th2c_parameter[0] = 0;\n\n\tif (dec_bt_pwr) {\n\t\th2c_parameter[0] |= BIT(1);\n\t\trtlpriv->btcoexist.fw_coexist_all_off = false;\n\t}\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], decrease Bt Power : %s, write 0x21=0x%x\\n\",\n\t\t(dec_bt_pwr ? \"Yes!!\" : \"No!!\"), h2c_parameter[0]);\n\n\trtl8723e_fill_h2c_cmd(hw, 0x21, 1, h2c_parameter);\n}\n\nstatic void rtl8723e_dm_bt_set_fw_2_ant_hid(struct ieee80211_hw *hw,\n\t\t\t\t\t    bool b_enable, bool b_dac_swing_on)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 h2c_parameter[1] = {0};\n\n\tif (b_enable) {\n\t\th2c_parameter[0] |= BIT(0);\n\t\trtlpriv->btcoexist.fw_coexist_all_off = false;\n\t}\n\tif (b_dac_swing_on)\n\t\th2c_parameter[0] |= BIT(1);  \n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], turn 2-Ant+HID mode %s, DACSwing:%s, write 0x15=0x%x\\n\",\n\t\t(b_enable ? \"ON!!\" : \"OFF!!\"), (b_dac_swing_on ? \"ON\" : \"OFF\"),\n\t\th2c_parameter[0]);\n\n\trtl8723e_fill_h2c_cmd(hw, 0x15, 1, h2c_parameter);\n}\n\nstatic void rtl8723e_dm_bt_set_fw_tdma_ctrl(struct ieee80211_hw *hw,\n\t\t\t\t\t    bool b_enable, u8 ant_num,\n\t\t\t\t\t    u8 nav_en, u8 dac_swing_en)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 h2c_parameter[1] = {0};\n\tu8 h2c_parameter1[1] = {0};\n\n\th2c_parameter[0] = 0;\n\th2c_parameter1[0] = 0;\n\n\tif (b_enable) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], set BT PTA update manager to trigger update!!\\n\");\n\t\th2c_parameter1[0] |= BIT(0);\n\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], turn TDMA mode ON!!\\n\");\n\t\th2c_parameter[0] |= BIT(0);\t\t \n\t\tif (TDMA_1ANT == ant_num) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], TDMA_1ANT\\n\");\n\t\t\th2c_parameter[0] |= BIT(1);\n\t\t} else if (TDMA_2ANT == ant_num) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], TDMA_2ANT\\n\");\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], Unknown Ant\\n\");\n\t\t}\n\n\t\tif (TDMA_NAV_OFF == nav_en) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], TDMA_NAV_OFF\\n\");\n\t\t} else if (TDMA_NAV_ON == nav_en) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], TDMA_NAV_ON\\n\");\n\t\t\th2c_parameter[0] |= BIT(2);\n\t\t}\n\n\t\tif (TDMA_DAC_SWING_OFF == dac_swing_en) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], TDMA_DAC_SWING_OFF\\n\");\n\t\t} else if (TDMA_DAC_SWING_ON == dac_swing_en) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], TDMA_DAC_SWING_ON\\n\");\n\t\t\th2c_parameter[0] |= BIT(4);\n\t\t}\n\t\trtlpriv->btcoexist.fw_coexist_all_off = false;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], set BT PTA update manager to no update!!\\n\");\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], turn TDMA mode OFF!!\\n\");\n\t}\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], FW2AntTDMA, write 0x26=0x%x\\n\",\n\t\th2c_parameter1[0]);\n\trtl8723e_fill_h2c_cmd(hw, 0x26, 1, h2c_parameter1);\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], FW2AntTDMA, write 0x14=0x%x\\n\",\n\t\th2c_parameter[0]);\n\trtl8723e_fill_h2c_cmd(hw, 0x14, 1, h2c_parameter);\n}\n\nstatic void rtl8723e_dm_bt_set_fw_ignore_wlan_act(struct ieee80211_hw *hw,\n\t\t\t\t\t\t  bool b_enable)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 h2c_parameter[1] = {0};\n\n\tif (b_enable) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], BT Ignore Wlan_Act !!\\n\");\n\t\th2c_parameter[0] |= BIT(0);\t\t \n\t\trtlpriv->btcoexist.fw_coexist_all_off = false;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], BT don't ignore Wlan_Act !!\\n\");\n\t}\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], set FW for BT Ignore Wlan_Act, write 0x25=0x%x\\n\",\n\t\th2c_parameter[0]);\n\n\trtl8723e_fill_h2c_cmd(hw, 0x25, 1, h2c_parameter);\n}\n\nstatic void rtl8723e_dm_bt_set_fw_tra_tdma_ctrl(struct ieee80211_hw *hw,\n\t\t\t\t\t\tbool b_enable, u8 ant_num,\n\t\t\t\t\t\tu8 nav_en)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\n\n\tu8 h2c_parameter[2] = {0};\n\n\t \n\tif (IS_VENDOR_8723_A_CUT(rtlhal->version)) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], not 8723B cut, don't set Traditional TDMA!!\\n\");\n\t\treturn;\n\t}\n\n\tif (b_enable) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], turn TTDMA mode ON!!\\n\");\n\t\th2c_parameter[0] |= BIT(0);\t \n\t\tif (TDMA_1ANT == ant_num) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], TTDMA_1ANT\\n\");\n\t\t\th2c_parameter[0] |= BIT(1);\n\t\t} else if (TDMA_2ANT == ant_num) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], TTDMA_2ANT\\n\");\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], Unknown Ant\\n\");\n\t\t}\n\n\t\tif (TDMA_NAV_OFF == nav_en) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], TTDMA_NAV_OFF\\n\");\n\t\t} else if (TDMA_NAV_ON == nav_en) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"[BTCoex], TTDMA_NAV_ON\\n\");\n\t\t\th2c_parameter[1] |= BIT(0);\n\t\t}\n\n\t\trtlpriv->btcoexist.fw_coexist_all_off = false;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], turn TTDMA mode OFF!!\\n\");\n\t}\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], FW Traditional TDMA, write 0x33=0x%x\\n\",\n\t\th2c_parameter[0] << 8 | h2c_parameter[1]);\n\n\trtl8723e_fill_h2c_cmd(hw, 0x33, 2, h2c_parameter);\n}\n\nstatic void rtl8723e_dm_bt_set_fw_dac_swing_level(struct ieee80211_hw *hw,\n\t\t\t\t\t\t  u8 dac_swing_lvl)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 h2c_parameter[1] = {0};\n\th2c_parameter[0] = dac_swing_lvl;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], Set Dac Swing Level=0x%x\\n\", dac_swing_lvl);\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], write 0x29=0x%x\\n\", h2c_parameter[0]);\n\n\trtl8723e_fill_h2c_cmd(hw, 0x29, 1, h2c_parameter);\n}\n\nstatic void rtl8723e_dm_bt_set_fw_bt_hid_info(struct ieee80211_hw *hw,\n\t\t\t\t\t      bool b_enable)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 h2c_parameter[1] = {0};\n\th2c_parameter[0] = 0;\n\n\tif (b_enable) {\n\t\th2c_parameter[0] |= BIT(0);\n\t\trtlpriv->btcoexist.fw_coexist_all_off = false;\n\t}\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], Set BT HID information=0x%x\\n\", b_enable);\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], write 0x24=0x%x\\n\", h2c_parameter[0]);\n\n\trtl8723e_fill_h2c_cmd(hw, 0x24, 1, h2c_parameter);\n}\n\nstatic void rtl8723e_dm_bt_set_fw_bt_retry_index(struct ieee80211_hw *hw,\n\t\t\t\t\t\t u8 retry_index)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 h2c_parameter[1] = {0};\n\th2c_parameter[0] = retry_index;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], Set BT Retry Index=%d\\n\", retry_index);\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], write 0x23=0x%x\\n\", h2c_parameter[0]);\n\n\trtl8723e_fill_h2c_cmd(hw, 0x23, 1, h2c_parameter);\n}\n\nstatic void rtl8723e_dm_bt_set_fw_wlan_act(struct ieee80211_hw *hw,\n\t\t\t\t\t   u8 wlan_act_hi, u8 wlan_act_lo)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 h2c_parameter_hi[1] = {0};\n\tu8 h2c_parameter_lo[1] = {0};\n\th2c_parameter_hi[0] = wlan_act_hi;\n\th2c_parameter_lo[0] = wlan_act_lo;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], Set WLAN_ACT Hi:Lo=0x%x/0x%x\\n\",\n\t\twlan_act_hi, wlan_act_lo);\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], write 0x22=0x%x\\n\", h2c_parameter_hi[0]);\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"[BTCoex], write 0x11=0x%x\\n\", h2c_parameter_lo[0]);\n\n\t \n\trtl8723e_fill_h2c_cmd(hw, 0x22, 1, h2c_parameter_hi);\n\t \n\trtl8723e_fill_h2c_cmd(hw, 0x11, 1, h2c_parameter_lo);\n}\n\nvoid rtl8723e_dm_bt_set_bt_dm(struct ieee80211_hw *hw,\n\t\t\t      struct btdm_8723 *btdm)\n{\n\tstruct rtl_priv\t*rtlpriv = rtl_priv(hw);\n\tstruct btdm_8723 *btdm_8723 = &hal_coex_8723.btdm;\n\tu8 i;\n\n\tbool fw_current_inpsmode = false;\n\tbool fw_ps_awake = true;\n\n\trtlpriv->cfg->ops->get_hw_reg(hw, HW_VAR_FW_PSMODE_STATUS,\n\t\t\t\t\t      (u8 *)(&fw_current_inpsmode));\n\trtlpriv->cfg->ops->get_hw_reg(hw, HW_VAR_FWLPS_RF_ON,\n\t\t\t\t\t      (u8 *)(&fw_ps_awake));\n\n\t \n\t \n\tif (memcmp(btdm_8723, btdm, sizeof(struct btdm_8723)) == 0) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], the same coexist setting, return!!\\n\");\n\t\treturn;\n\t} else {\t \n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], UPDATE TO NEW COEX SETTING!!\\n\");\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new bAllOff=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->all_off, btdm->all_off);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new agc_table_en=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->agc_table_en, btdm->agc_table_en);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new adc_back_off_on=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->adc_back_off_on,\n\t\t\tbtdm->adc_back_off_on);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new b2_ant_hid_en=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->b2_ant_hid_en, btdm->b2_ant_hid_en);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new bLowPenaltyRateAdaptive=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->low_penalty_rate_adaptive,\n\t\t\tbtdm->low_penalty_rate_adaptive);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new bRfRxLpfShrink=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->rf_rx_lpf_shrink,\n\t\t\tbtdm->rf_rx_lpf_shrink);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new bRejectAggrePkt=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->reject_aggre_pkt,\n\t\t\tbtdm->reject_aggre_pkt);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new tdma_on=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->tdma_on, btdm->tdma_on);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new tdmaAnt=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->tdma_ant, btdm->tdma_ant);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new tdmaNav=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->tdma_nav, btdm->tdma_nav);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new tdma_dac_swing=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->tdma_dac_swing, btdm->tdma_dac_swing);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new fw_dac_swing_lvl=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->fw_dac_swing_lvl,\n\t\t\tbtdm->fw_dac_swing_lvl);\n\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new bTraTdmaOn=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->tra_tdma_on, btdm->tra_tdma_on);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new traTdmaAnt=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->tra_tdma_ant, btdm->tra_tdma_ant);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new traTdmaNav=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->tra_tdma_nav, btdm->tra_tdma_nav);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new bPsTdmaOn=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->ps_tdma_on, btdm->ps_tdma_on);\n\t\tfor (i = 0; i < 5; i++) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"[BTCoex], original/new psTdmaByte[i]=0x%x/ 0x%x\\n\",\n\t\t\t\tbtdm_8723->ps_tdma_byte[i],\n\t\t\t\tbtdm->ps_tdma_byte[i]);\n\t\t}\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new bIgnoreWlanAct=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->ignore_wlan_act,\n\t\t\tbtdm->ignore_wlan_act);\n\n\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new bPtaOn=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->pta_on, btdm->pta_on);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new val_0x6c0=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->val_0x6c0, btdm->val_0x6c0);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new val_0x6c8=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->val_0x6c8, btdm->val_0x6c8);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new val_0x6cc=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->val_0x6cc, btdm->val_0x6cc);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new sw_dac_swing_on=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->sw_dac_swing_on,\n\t\t\tbtdm->sw_dac_swing_on);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new sw_dac_swing_lvl=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->sw_dac_swing_lvl,\n\t\t\tbtdm->sw_dac_swing_lvl);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new wlanActHi=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->wlan_act_hi, btdm->wlan_act_hi);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new wlanActLo=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->wlan_act_lo, btdm->wlan_act_lo);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], original/new btRetryIndex=0x%x/ 0x%x\\n\",\n\t\t\tbtdm_8723->bt_retry_index, btdm->bt_retry_index);\n\n\t\tmemcpy(btdm_8723, btdm, sizeof(struct btdm_8723));\n\t}\n\t \n\n\tif (rtlpriv->btcoexist.hold_for_bt_operation) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], set to ignore wlanAct for BT OP!!\\n\");\n\t\trtl8723e_dm_bt_set_fw_ignore_wlan_act(hw, true);\n\t\treturn;\n\t}\n\n\tif (btdm->all_off) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], disable all coexist mechanism !!\\n\");\n\t\trtl8723e_btdm_coex_all_off(hw);\n\t\treturn;\n\t}\n\n\trtl8723e_dm_bt_reject_ap_aggregated_packet(hw, btdm->reject_aggre_pkt);\n\n\tif (btdm->low_penalty_rate_adaptive)\n\t\tdm_bt_set_sw_penalty_tx_rate_adapt(hw, BT_TX_RATE_ADAPTIVE_LOW_PENALTY);\n\telse\n\t\tdm_bt_set_sw_penalty_tx_rate_adapt(hw,\n\t\t\t\t\t\t   BT_TX_RATE_ADAPTIVE_NORMAL);\n\n\tif (btdm->rf_rx_lpf_shrink)\n\t\trtl8723e_dm_bt_set_sw_rf_rx_lpf_corner(hw,\n\t\t\t\tBT_RF_RX_LPF_CORNER_SHRINK);\n\telse\n\t\trtl8723e_dm_bt_set_sw_rf_rx_lpf_corner(hw,\n\t\t\t\tBT_RF_RX_LPF_CORNER_RESUME);\n\n\tif (btdm->agc_table_en)\n\t\trtl8723e_dm_bt_agc_table(hw, BT_AGCTABLE_ON);\n\telse\n\t\trtl8723e_dm_bt_agc_table(hw, BT_AGCTABLE_OFF);\n\n\tif (btdm->adc_back_off_on)\n\t\trtl8723e_dm_bt_bb_back_off_level(hw, BT_BB_BACKOFF_ON);\n\telse\n\t\trtl8723e_dm_bt_bb_back_off_level(hw, BT_BB_BACKOFF_OFF);\n\n\trtl8723e_dm_bt_set_fw_bt_retry_index(hw, btdm->bt_retry_index);\n\n\trtl8723e_dm_bt_set_fw_dac_swing_level(hw, btdm->fw_dac_swing_lvl);\n\trtl8723e_dm_bt_set_fw_wlan_act(hw, btdm->wlan_act_hi,\n\t\t\t\t       btdm->wlan_act_lo);\n\n\trtl8723e_dm_bt_set_coex_table(hw, btdm->val_0x6c0,\n\t\t\t\t      btdm->val_0x6c8, btdm->val_0x6cc);\n\trtl8723e_dm_bt_set_hw_pta_mode(hw, btdm->pta_on);\n\n\t \n\tif (btdm->b2_ant_hid_en) {\n\t\t \n\t\trtl8723e_dm_bt_set_fw_tra_tdma_ctrl(hw, btdm->tra_tdma_on,\n\t\t\t\t\t\t    btdm->tra_tdma_ant,\n\t\t\t\t\t\t    btdm->tra_tdma_nav);\n\t\trtl8723e_dm_bt_set_fw_tdma_ctrl(hw, false, btdm->tdma_ant,\n\t\t\t\t\t\tbtdm->tdma_nav,\n\t\t\t\t\t\tbtdm->tdma_dac_swing);\n\n\t\t \n\t\trtl8723e_dm_bt_set_fw_ignore_wlan_act(hw,\n\t\t\t\t\t\t      btdm->ignore_wlan_act);\n\t\t \n\t\trtl8723e_dm_bt_set_fw_3a(hw, 0x0, 0x0, 0x0, 0x8, 0x0);\n\n\t\t \n\t\trtl8723e_dm_bt_set_fw_bt_hid_info(hw, true);\n\t\trtl8723e_dm_bt_set_fw_2_ant_hid(hw, true, true);\n\t} else if (btdm->tdma_on) {\n\t\t \n\t\trtl8723e_dm_bt_set_fw_bt_hid_info(hw, false);\n\t\trtl8723e_dm_bt_set_fw_2_ant_hid(hw, false, false);\n\n\t\t \n\t\trtl8723e_dm_bt_set_fw_ignore_wlan_act(hw,\n\t\t\t\t\t\t      btdm->ignore_wlan_act);\n\t\t \n\t\trtl8723e_dm_bt_set_fw_3a(hw, 0x0, 0x0, 0x0, 0x8, 0x0);\n\n\t\t \n\t\trtl8723e_dm_bt_set_fw_tra_tdma_ctrl(hw, btdm->tra_tdma_on,\n\t\t\t\t\t\t    btdm->tra_tdma_ant,\n\t\t\t\t\t\t    btdm->tra_tdma_nav);\n\t\trtl8723e_dm_bt_set_fw_tdma_ctrl(hw, true, btdm->tdma_ant,\n\t\t\t\t\t\tbtdm->tdma_nav,\n\t\t\t\t\t\tbtdm->tdma_dac_swing);\n\t} else if (btdm->ps_tdma_on) {\n\t\t \n\t\trtl8723e_dm_bt_set_fw_bt_hid_info(hw, false);\n\t\trtl8723e_dm_bt_set_fw_2_ant_hid(hw, false, false);\n\n\t\t \n\t\trtl8723e_dm_bt_set_fw_tra_tdma_ctrl(hw, btdm->tra_tdma_on,\n\t\t\t\t\t\t    btdm->tra_tdma_ant,\n\t\t\t\t\t\t    btdm->tra_tdma_nav);\n\t\trtl8723e_dm_bt_set_fw_tdma_ctrl(hw, false, btdm->tdma_ant,\n\t\t\t\t\t\tbtdm->tdma_nav,\n\t\t\t\t\t\tbtdm->tdma_dac_swing);\n\n\t\t \n\t\trtl8723e_dm_bt_set_fw_ignore_wlan_act(hw,\n\t\t\t\t\t\t      btdm->ignore_wlan_act);\n\t\trtl8723e_dm_bt_set_fw_3a(hw, btdm->ps_tdma_byte[0],\n\t\t\t\t\t btdm->ps_tdma_byte[1],\n\t\t\t\t\t btdm->ps_tdma_byte[2],\n\t\t\t\t\t btdm->ps_tdma_byte[3],\n\t\t\t\t\t btdm->ps_tdma_byte[4]);\n\t} else {\n\t\t \n\t\trtl8723e_dm_bt_set_fw_bt_hid_info(hw, false);\n\t\trtl8723e_dm_bt_set_fw_2_ant_hid(hw, false, false);\n\n\t\t \n\t\trtl8723e_dm_bt_set_fw_tra_tdma_ctrl(hw, btdm->tra_tdma_on,\n\t\t\t\t\t\t    btdm->tra_tdma_ant,\n\t\t\t\t\t\t    btdm->tra_tdma_nav);\n\t\trtl8723e_dm_bt_set_fw_tdma_ctrl(hw, false, btdm->tdma_ant,\n\t\t\t\t\t\tbtdm->tdma_nav,\n\t\t\t\t\t\tbtdm->tdma_dac_swing);\n\n\t\t \n\t\trtl8723e_dm_bt_set_fw_ignore_wlan_act(hw,\n\t\t\t\t\t\tbtdm->ignore_wlan_act);\n\t\t \n\t\trtl8723e_dm_bt_set_fw_3a(hw, 0x0, 0x0, 0x0, 0x8, 0x0);\n\t}\n\n\t \n\tmdelay(30);\n\trtl8723e_dm_bt_set_sw_full_time_dac_swing(hw, btdm->sw_dac_swing_on,\n\t\t\t\t\t\t  btdm->sw_dac_swing_lvl);\n\trtl8723e_dm_bt_set_fw_dec_bt_pwr(hw, btdm->dec_bt_pwr);\n}\n\n \n \n \nstatic u32 rtl8723e_dm_bt_tx_rx_couter_h(struct ieee80211_hw *hw)\n{\n\tu32\tcounters = 0;\n\n\tcounters = hal_coex_8723.high_priority_tx +\n\t\t\thal_coex_8723.high_priority_rx;\n\treturn counters;\n}\n\nstatic u32 rtl8723e_dm_bt_tx_rx_couter_l(struct ieee80211_hw *hw)\n{\n\tu32 counters = 0;\n\n\tcounters = hal_coex_8723.low_priority_tx +\n\t\t\thal_coex_8723.low_priority_rx;\n\treturn counters;\n}\n\nstatic u8 rtl8723e_dm_bt_bt_tx_rx_counter_level(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32\tbt_tx_rx_cnt = 0;\n\tu8\tbt_tx_rx_cnt_lvl = 0;\n\n\tbt_tx_rx_cnt = rtl8723e_dm_bt_tx_rx_couter_h(hw)\n\t\t\t\t+ rtl8723e_dm_bt_tx_rx_couter_l(hw);\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"[BTCoex], BT TxRx Counters = %d\\n\", bt_tx_rx_cnt);\n\n\trtlpriv->btcoexist.cstate_h &= ~\n\t\t (BT_COEX_STATE_BT_CNT_LEVEL_0 | BT_COEX_STATE_BT_CNT_LEVEL_1|\n\t\t  BT_COEX_STATE_BT_CNT_LEVEL_2);\n\n\tif (bt_tx_rx_cnt >= BT_TXRX_CNT_THRES_3) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], BT TxRx Counters at level 3\\n\");\n\t\tbt_tx_rx_cnt_lvl = BT_TXRX_CNT_LEVEL_3;\n\t\trtlpriv->btcoexist.cstate_h |=\n\t\t\tBT_COEX_STATE_BT_CNT_LEVEL_3;\n\t} else if (bt_tx_rx_cnt >= BT_TXRX_CNT_THRES_2) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], BT TxRx Counters at level 2\\n\");\n\t\tbt_tx_rx_cnt_lvl = BT_TXRX_CNT_LEVEL_2;\n\t\trtlpriv->btcoexist.cstate_h |=\n\t\t\tBT_COEX_STATE_BT_CNT_LEVEL_2;\n\t} else if (bt_tx_rx_cnt >= BT_TXRX_CNT_THRES_1) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], BT TxRx Counters at level 1\\n\");\n\t\tbt_tx_rx_cnt_lvl = BT_TXRX_CNT_LEVEL_1;\n\t\trtlpriv->btcoexist.cstate_h  |=\n\t\t\tBT_COEX_STATE_BT_CNT_LEVEL_1;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], BT TxRx Counters at level 0\\n\");\n\t\tbt_tx_rx_cnt_lvl = BT_TXRX_CNT_LEVEL_0;\n\t\trtlpriv->btcoexist.cstate_h |=\n\t\t\tBT_COEX_STATE_BT_CNT_LEVEL_0;\n\t}\n\treturn bt_tx_rx_cnt_lvl;\n}\n\nstatic void rtl8723e_dm_bt_2_ant_hid_sco_esco(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &(rtlpriv->phy);\n\tstruct btdm_8723 btdm8723;\n\tu8 bt_rssi_state, bt_rssi_state1;\n\tu8\tbt_tx_rx_cnt_lvl = 0;\n\n\trtl8723e_dm_bt_btdm_structure_reload(hw, &btdm8723);\n\n\tbtdm8723.rf_rx_lpf_shrink = true;\n\tbtdm8723.low_penalty_rate_adaptive = true;\n\tbtdm8723.reject_aggre_pkt = false;\n\n\tbt_tx_rx_cnt_lvl = rtl8723e_dm_bt_bt_tx_rx_counter_level(hw);\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"[BTCoex], BT TxRx Counters = %d\\n\", bt_tx_rx_cnt_lvl);\n\n\tif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20_40) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG, \"HT40\\n\");\n\t\t \n\t\tbtdm8723.val_0x6c0 = 0x55555555;\n\t\tbtdm8723.val_0x6c8 = 0xffff;\n\t\tbtdm8723.val_0x6cc = 0x3;\n\n\t\t \n\t\tbtdm8723.agc_table_en = false;\n\t\tbtdm8723.adc_back_off_on = false;\n\t\tbtdm8723.sw_dac_swing_on = false;\n\n\t\t \n\t\tbtdm8723.ps_tdma_on = true;\n\t\tif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1400\\n\");\n\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\tbtdm8723.ps_tdma_byte[1] = 0x5;\n\t\t\tbtdm8723.ps_tdma_byte[2] = 0x5;\n\t\t\tbtdm8723.ps_tdma_byte[3] = 0x2;\n\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1200 && < 1400\\n\");\n\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\tbtdm8723.ps_tdma_byte[1] = 0xa;\n\t\t\tbtdm8723.ps_tdma_byte[2] = 0xa;\n\t\t\tbtdm8723.ps_tdma_byte[3] = 0x2;\n\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"[BTCoex], BT TxRx Counters < 1200\\n\");\n\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\tbtdm8723.ps_tdma_byte[1] = 0xf;\n\t\t\tbtdm8723.ps_tdma_byte[2] = 0xf;\n\t\t\tbtdm8723.ps_tdma_byte[3] = 0x2;\n\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t}\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"HT20 or Legacy\\n\");\n\t\tbt_rssi_state =\n\t\t  rtl8723e_dm_bt_check_coex_rssi_state(hw, 2, 47, 0);\n\t\tbt_rssi_state1 =\n\t\t  rtl8723e_dm_bt_check_coex_rssi_state1(hw, 2, 27, 0);\n\n\t\t \n\t\tbtdm8723.val_0x6c0 = 0x55555555;\n\t\tbtdm8723.val_0x6c8 = 0xffff;\n\t\tbtdm8723.val_0x6cc = 0x3;\n\n\t\t \n\t\tif ((bt_rssi_state == BT_RSSI_STATE_HIGH) ||\n\t\t\t(bt_rssi_state == BT_RSSI_STATE_STAY_HIGH)) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi rssi high\\n\");\n\t\t\tbtdm8723.agc_table_en = true;\n\t\t\tbtdm8723.adc_back_off_on = true;\n\t\t\tbtdm8723.sw_dac_swing_on = false;\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi rssi low\\n\");\n\t\t\tbtdm8723.agc_table_en = false;\n\t\t\tbtdm8723.adc_back_off_on = false;\n\t\t\tbtdm8723.sw_dac_swing_on = false;\n\t\t}\n\n\t\t \n\t\tbtdm8723.ps_tdma_on = true;\n\t\tif ((bt_rssi_state1 == BT_RSSI_STATE_HIGH) ||\n\t\t\t(bt_rssi_state1 == BT_RSSI_STATE_STAY_HIGH)) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi rssi-1 high\\n\");\n\t\t\t \n\t\t\t \n\t\t\trtl_write_byte(rtlpriv, 0x883, 0x40);\n\t\t\tif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x83;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters>= 1200 && < 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x83;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters < 1200\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x83;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t}\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi rssi-1 low\\n\");\n\t\t\tif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x2;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1200 && < 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x2;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters < 1200\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x2;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (rtl8723e_dm_bt_need_to_dec_bt_pwr(hw))\n\t\tbtdm8723.dec_bt_pwr = true;\n\n\t \n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"[BTCoex], BT btInqPageStartTime = 0x%x, btTxRxCntLvl = %d\\n\",\n\t\thal_coex_8723.bt_inq_page_start_time, bt_tx_rx_cnt_lvl);\n\tif ((hal_coex_8723.bt_inq_page_start_time) ||\n\t    (BT_TXRX_CNT_LEVEL_3 == bt_tx_rx_cnt_lvl)) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], Set BT inquiry / page scan 0x3a setting\\n\");\n\t\tbtdm8723.ps_tdma_on = true;\n\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\tbtdm8723.ps_tdma_byte[1] = 0x5;\n\t\tbtdm8723.ps_tdma_byte[2] = 0x5;\n\t\tbtdm8723.ps_tdma_byte[3] = 0x2;\n\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t}\n\n\tif (rtl8723e_dm_bt_is_coexist_state_changed(hw))\n\t\trtl8723e_dm_bt_set_bt_dm(hw, &btdm8723);\n\n}\n\nstatic void rtl8723e_dm_bt_2_ant_ftp_a2dp(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_phy *rtlphy = &(rtlpriv->phy);\n\tstruct btdm_8723 btdm8723;\n\n\tu8 bt_rssi_state, bt_rssi_state1;\n\tu32 bt_tx_rx_cnt_lvl = 0;\n\n\trtl8723e_dm_bt_btdm_structure_reload(hw, &btdm8723);\n\n\tbtdm8723.rf_rx_lpf_shrink = true;\n\tbtdm8723.low_penalty_rate_adaptive = true;\n\tbtdm8723.reject_aggre_pkt = false;\n\n\tbt_tx_rx_cnt_lvl = rtl8723e_dm_bt_bt_tx_rx_counter_level(hw);\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"[BTCoex], BT TxRx Counters = %d\\n\", bt_tx_rx_cnt_lvl);\n\n\tif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20_40) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG, \"HT40\\n\");\n\t\tbt_rssi_state =\n\t\t  rtl8723e_dm_bt_check_coex_rssi_state(hw, 2, 37, 0);\n\n\t\t \n\t\tbtdm8723.val_0x6c0 = 0x55555555;\n\t\tbtdm8723.val_0x6c8 = 0xffff;\n\t\tbtdm8723.val_0x6cc = 0x3;\n\n\t\t \n\t\tbtdm8723.agc_table_en = false;\n\t\tbtdm8723.adc_back_off_on = true;\n\t\tbtdm8723.sw_dac_swing_on = false;\n\n\t\t \n\t\tbtdm8723.ps_tdma_on = true;\n\t\tif ((bt_rssi_state == BT_RSSI_STATE_HIGH) ||\n\t\t\t(bt_rssi_state == BT_RSSI_STATE_STAY_HIGH)) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi rssi high\\n\");\n\t\t\tif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x81;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1200 && < 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x81;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters < 1200\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x81;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t}\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi rssi low\\n\");\n\t\t\tif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x0;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else if (bt_tx_rx_cnt_lvl ==\n\t\t\t\tBT_TXRX_CNT_LEVEL_1) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1200 && < 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x0;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters < 1200\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x0;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t}\n\t\t}\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"HT20 or Legacy\\n\");\n\t\tbt_rssi_state =\n\t\t  rtl8723e_dm_bt_check_coex_rssi_state(hw, 2, 47, 0);\n\t\tbt_rssi_state1 =\n\t\t  rtl8723e_dm_bt_check_coex_rssi_state1(hw, 2, 27, 0);\n\n\t\t \n\t\tbtdm8723.val_0x6c0 = 0x55555555;\n\t\tbtdm8723.val_0x6c8 = 0xffff;\n\t\tbtdm8723.val_0x6cc = 0x3;\n\n\t\t \n\t\tif ((bt_rssi_state == BT_RSSI_STATE_HIGH) ||\n\t\t\t(bt_rssi_state == BT_RSSI_STATE_STAY_HIGH)) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi rssi high\\n\");\n\t\t\tbtdm8723.agc_table_en = true;\n\t\t\tbtdm8723.adc_back_off_on = true;\n\t\t\tbtdm8723.sw_dac_swing_on = false;\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi rssi low\\n\");\n\t\t\tbtdm8723.agc_table_en = false;\n\t\t\tbtdm8723.adc_back_off_on = false;\n\t\t\tbtdm8723.sw_dac_swing_on = false;\n\t\t}\n\n\t\t \n\t\tbtdm8723.ps_tdma_on = true;\n\t\tif ((bt_rssi_state1 == BT_RSSI_STATE_HIGH) ||\n\t\t\t(bt_rssi_state1 == BT_RSSI_STATE_STAY_HIGH)) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi rssi-1 high\\n\");\n\t\t\t \n\t\t\t \n\t\t\trtl_write_byte(rtlpriv, 0x883, 0x40);\n\t\t\tif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x81;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1200 && < 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x81;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters < 1200\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x81;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t}\n\t\t} else {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"Wifi rssi-1 low\\n\");\n\t\t\tif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0x5;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x0;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters >= 1200 && < 1400\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xa;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x0;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t} else {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BT TxRx Counters < 1200\\n\");\n\t\t\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\t\t\tbtdm8723.ps_tdma_byte[1] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[2] = 0xf;\n\t\t\t\tbtdm8723.ps_tdma_byte[3] = 0x0;\n\t\t\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (rtl8723e_dm_bt_need_to_dec_bt_pwr(hw))\n\t\tbtdm8723.dec_bt_pwr = true;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"[BTCoex], BT btInqPageStartTime = 0x%x, btTxRxCntLvl = %d\\n\",\n\t\thal_coex_8723.bt_inq_page_start_time, bt_tx_rx_cnt_lvl);\n\n\tif ((hal_coex_8723.bt_inq_page_start_time) ||\n\t    (BT_TXRX_CNT_LEVEL_3 == bt_tx_rx_cnt_lvl)) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], Set BT inquiry / page scan 0x3a setting\\n\");\n\t\tbtdm8723.ps_tdma_on = true;\n\t\tbtdm8723.ps_tdma_byte[0] = 0xa3;\n\t\tbtdm8723.ps_tdma_byte[1] = 0x5;\n\t\tbtdm8723.ps_tdma_byte[2] = 0x5;\n\t\tbtdm8723.ps_tdma_byte[3] = 0x83;\n\t\tbtdm8723.ps_tdma_byte[4] = 0x80;\n\t}\n\n\tif (rtl8723e_dm_bt_is_coexist_state_changed(hw))\n\t\trtl8723e_dm_bt_set_bt_dm(hw, &btdm8723);\n\n}\n\nstatic void rtl8723e_dm_bt_inq_page_monitor(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 cur_time;\n\n\tcur_time = jiffies;\n\tif (hal_coex_8723.c2h_bt_inquiry_page) {\n\t\t \n\t\tif (hal_coex_8723.bt_inq_page_start_time == 0) {\n\t\t\trtlpriv->btcoexist.cstate  |=\n\t\t\tBT_COEX_STATE_BT_INQ_PAGE;\n\t\t\thal_coex_8723.bt_inq_page_start_time = cur_time;\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"[BTCoex], BT Inquiry/page is started at time : 0x%x\\n\",\n\t\t\t\thal_coex_8723.bt_inq_page_start_time);\n\t\t}\n\t}\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"[BTCoex], BT Inquiry/page started time : 0x%x, cur_time : 0x%x\\n\",\n\t\thal_coex_8723.bt_inq_page_start_time, cur_time);\n\n\tif (hal_coex_8723.bt_inq_page_start_time) {\n\t\tif ((((long)cur_time -\n\t\t\t(long)hal_coex_8723.bt_inq_page_start_time) / HZ)\n\t\t\t>= 10) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\"[BTCoex], BT Inquiry/page >= 10sec!!!\\n\");\n\t\t\thal_coex_8723.bt_inq_page_start_time = 0;\n\t\t\trtlpriv->btcoexist.cstate &=\n\t\t\t\t~BT_COEX_STATE_BT_INQ_PAGE;\n\t\t}\n\t}\n}\n\nstatic void rtl8723e_dm_bt_reset_action_profile_state(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\trtlpriv->btcoexist.cstate &= ~\n\t\t(BT_COEX_STATE_PROFILE_HID | BT_COEX_STATE_PROFILE_A2DP|\n\t\tBT_COEX_STATE_PROFILE_PAN | BT_COEX_STATE_PROFILE_SCO);\n\n\trtlpriv->btcoexist.cstate &= ~\n\t\t(BT_COEX_STATE_BTINFO_COMMON |\n\t\tBT_COEX_STATE_BTINFO_B_HID_SCOESCO|\n\t\tBT_COEX_STATE_BTINFO_B_FTP_A2DP);\n}\n\nstatic void _rtl8723e_dm_bt_coexist_2_ant(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 bt_info_original;\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"[BTCoex] Get bt info by fw!!\\n\");\n\n\t_rtl8723_dm_bt_check_wifi_state(hw);\n\n\tif (hal_coex_8723.c2h_bt_info_req_sent) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex] c2h for bt_info not rcvd yet!!\\n\");\n\t}\n\n\tbt_info_original = hal_coex_8723.c2h_bt_info_original;\n\n\t \n\t \n\trtl8723e_dm_bt_inq_page_monitor(hw);\n\trtl8723e_dm_bt_reset_action_profile_state(hw);\n\n\tif (rtl8723e_dm_bt_is_2_ant_common_action(hw)) {\n\t\trtlpriv->btcoexist.bt_profile_case = BT_COEX_MECH_COMMON;\n\t\trtlpriv->btcoexist.bt_profile_action = BT_COEX_MECH_COMMON;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"Action 2-Ant common.\\n\");\n\t} else {\n\t\tif ((bt_info_original & BTINFO_B_HID) ||\n\t\t\t(bt_info_original & BTINFO_B_SCO_BUSY) ||\n\t\t\t(bt_info_original & BTINFO_B_SCO_ESCO)) {\n\t\t\t\trtlpriv->btcoexist.cstate |=\n\t\t\t\t\tBT_COEX_STATE_BTINFO_B_HID_SCOESCO;\n\t\t\t\trtlpriv->btcoexist.bt_profile_case =\n\t\t\t\t\tBT_COEX_MECH_HID_SCO_ESCO;\n\t\t\t\trtlpriv->btcoexist.bt_profile_action =\n\t\t\t\t\tBT_COEX_MECH_HID_SCO_ESCO;\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BTInfo: bHid|bSCOBusy|bSCOeSCO\\n\");\n\t\t\t\trtl8723e_dm_bt_2_ant_hid_sco_esco(hw);\n\t\t} else if ((bt_info_original & BTINFO_B_FTP) ||\n\t\t\t\t(bt_info_original & BTINFO_B_A2DP)) {\n\t\t\t\trtlpriv->btcoexist.cstate |=\n\t\t\t\t\tBT_COEX_STATE_BTINFO_B_FTP_A2DP;\n\t\t\t\trtlpriv->btcoexist.bt_profile_case =\n\t\t\t\t\tBT_COEX_MECH_FTP_A2DP;\n\t\t\t\trtlpriv->btcoexist.bt_profile_action =\n\t\t\t\t\tBT_COEX_MECH_FTP_A2DP;\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"BTInfo: bFTP|bA2DP\\n\");\n\t\t\t\trtl8723e_dm_bt_2_ant_ftp_a2dp(hw);\n\t\t} else {\n\t\t\t\trtlpriv->btcoexist.cstate |=\n\t\t\t\t\tBT_COEX_STATE_BTINFO_B_HID_SCOESCO;\n\t\t\t\trtlpriv->btcoexist.bt_profile_case =\n\t\t\t\t\tBT_COEX_MECH_NONE;\n\t\t\t\trtlpriv->btcoexist.bt_profile_action =\n\t\t\t\t\tBT_COEX_MECH_NONE;\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\t\t\"[BTCoex], BTInfo: undefined case!!!!\\n\");\n\t\t\t\trtl8723e_dm_bt_2_ant_hid_sco_esco(hw);\n\t\t}\n\t}\n}\n\nstatic void _rtl8723e_dm_bt_coexist_1_ant(struct ieee80211_hw *hw)\n{\n\treturn;\n}\n\nvoid rtl8723e_dm_bt_hw_coex_all_off_8723a(struct ieee80211_hw *hw)\n{\n\trtl8723e_dm_bt_set_coex_table(hw, 0x5a5aaaaa, 0xcc, 0x3);\n\trtl8723e_dm_bt_set_hw_pta_mode(hw, true);\n}\n\nvoid rtl8723e_dm_bt_fw_coex_all_off_8723a(struct ieee80211_hw *hw)\n{\n\trtl8723e_dm_bt_set_fw_ignore_wlan_act(hw, false);\n\trtl8723e_dm_bt_set_fw_3a(hw, 0x0, 0x0, 0x0, 0x8, 0x0);\n\trtl8723e_dm_bt_set_fw_2_ant_hid(hw, false, false);\n\trtl8723e_dm_bt_set_fw_tra_tdma_ctrl(hw, false, TDMA_2ANT,\n\t\t\t\t\t    TDMA_NAV_OFF);\n\trtl8723e_dm_bt_set_fw_tdma_ctrl(hw, false, TDMA_2ANT, TDMA_NAV_OFF,\n\t\t\t\t\tTDMA_DAC_SWING_OFF);\n\trtl8723e_dm_bt_set_fw_dac_swing_level(hw, 0);\n\trtl8723e_dm_bt_set_fw_bt_hid_info(hw, false);\n\trtl8723e_dm_bt_set_fw_bt_retry_index(hw, 2);\n\trtl8723e_dm_bt_set_fw_wlan_act(hw, 0x10, 0x10);\n\trtl8723e_dm_bt_set_fw_dec_bt_pwr(hw, false);\n}\n\nvoid rtl8723e_dm_bt_sw_coex_all_off_8723a(struct ieee80211_hw *hw)\n{\n\trtl8723e_dm_bt_agc_table(hw, BT_AGCTABLE_OFF);\n\trtl8723e_dm_bt_bb_back_off_level(hw, BT_BB_BACKOFF_OFF);\n\trtl8723e_dm_bt_reject_ap_aggregated_packet(hw, false);\n\n\tdm_bt_set_sw_penalty_tx_rate_adapt(hw, BT_TX_RATE_ADAPTIVE_NORMAL);\n\trtl8723e_dm_bt_set_sw_rf_rx_lpf_corner(hw, BT_RF_RX_LPF_CORNER_RESUME);\n\trtl8723e_dm_bt_set_sw_full_time_dac_swing(hw, false, 0xc0);\n}\n\nstatic void rtl8723e_dm_bt_query_bt_information(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 h2c_parameter[1] = {0};\n\n\thal_coex_8723.c2h_bt_info_req_sent = true;\n\n\th2c_parameter[0] |=  BIT(0);\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\"Query Bt information, write 0x38=0x%x\\n\", h2c_parameter[0]);\n\n\trtl8723e_fill_h2c_cmd(hw, 0x38, 1, h2c_parameter);\n}\n\nstatic void rtl8723e_dm_bt_bt_hw_counters_monitor(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu32 reg_hp_tx_rx, reg_lp_tx_rx, u32_tmp;\n\tu32 reg_hp_tx = 0, reg_hp_rx = 0, reg_lp_tx = 0, reg_lp_rx = 0;\n\n\treg_hp_tx_rx = REG_HIGH_PRIORITY_TXRX;\n\treg_lp_tx_rx = REG_LOW_PRIORITY_TXRX;\n\n\tu32_tmp = rtl_read_dword(rtlpriv, reg_hp_tx_rx);\n\treg_hp_tx = u32_tmp & MASKLWORD;\n\treg_hp_rx = (u32_tmp & MASKHWORD)>>16;\n\n\tu32_tmp = rtl_read_dword(rtlpriv, reg_lp_tx_rx);\n\treg_lp_tx = u32_tmp & MASKLWORD;\n\treg_lp_rx = (u32_tmp & MASKHWORD)>>16;\n\n\tif (rtlpriv->btcoexist.lps_counter > 1) {\n\t\treg_hp_tx %= rtlpriv->btcoexist.lps_counter;\n\t\treg_hp_rx %= rtlpriv->btcoexist.lps_counter;\n\t\treg_lp_tx %= rtlpriv->btcoexist.lps_counter;\n\t\treg_lp_rx %= rtlpriv->btcoexist.lps_counter;\n\t}\n\n\thal_coex_8723.high_priority_tx = reg_hp_tx;\n\thal_coex_8723.high_priority_rx = reg_hp_rx;\n\thal_coex_8723.low_priority_tx = reg_lp_tx;\n\thal_coex_8723.low_priority_rx = reg_lp_rx;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"High Priority Tx/Rx (reg 0x%x)=%x(%d)/%x(%d)\\n\",\n\t\treg_hp_tx_rx, reg_hp_tx, reg_hp_tx, reg_hp_rx, reg_hp_rx);\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"Low Priority Tx/Rx (reg 0x%x)=%x(%d)/%x(%d)\\n\",\n\t\treg_lp_tx_rx, reg_lp_tx, reg_lp_tx, reg_lp_rx, reg_lp_rx);\n\trtlpriv->btcoexist.lps_counter = 0;\n\t \n}\n\nstatic void rtl8723e_dm_bt_bt_enable_disable_check(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tbool bt_alife = true;\n\n\tif (hal_coex_8723.high_priority_tx == 0 &&\n\t    hal_coex_8723.high_priority_rx == 0 &&\n\t    hal_coex_8723.low_priority_tx == 0 &&\n\t    hal_coex_8723.low_priority_rx == 0) {\n\t\tbt_alife = false;\n\t}\n\tif (hal_coex_8723.high_priority_tx == 0xeaea &&\n\t    hal_coex_8723.high_priority_rx == 0xeaea &&\n\t    hal_coex_8723.low_priority_tx == 0xeaea &&\n\t    hal_coex_8723.low_priority_rx == 0xeaea) {\n\t\tbt_alife = false;\n\t}\n\tif (hal_coex_8723.high_priority_tx == 0xffff &&\n\t    hal_coex_8723.high_priority_rx == 0xffff &&\n\t    hal_coex_8723.low_priority_tx == 0xffff &&\n\t    hal_coex_8723.low_priority_rx == 0xffff) {\n\t\tbt_alife = false;\n\t}\n\tif (bt_alife) {\n\t\trtlpriv->btcoexist.bt_active_zero_cnt = 0;\n\t\trtlpriv->btcoexist.cur_bt_disabled = false;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"8723A BT is enabled !!\\n\");\n\t} else {\n\t\trtlpriv->btcoexist.bt_active_zero_cnt++;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"8723A bt all counters=0, %d times!!\\n\",\n\t\t\trtlpriv->btcoexist.bt_active_zero_cnt);\n\t\tif (rtlpriv->btcoexist.bt_active_zero_cnt >= 2) {\n\t\t\trtlpriv->btcoexist.cur_bt_disabled = true;\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"8723A BT is disabled !!\\n\");\n\t\t}\n\t}\n\tif (rtlpriv->btcoexist.pre_bt_disabled !=\n\t\trtlpriv->btcoexist.cur_bt_disabled) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST,\n\t\t\tDBG_TRACE, \"8723A BT is from %s to %s!!\\n\",\n\t\t\t(rtlpriv->btcoexist.pre_bt_disabled ?\n\t\t\t\t\"disabled\" : \"enabled\"),\n\t\t\t(rtlpriv->btcoexist.cur_bt_disabled ?\n\t\t\t\t\"disabled\" : \"enabled\"));\n\t\trtlpriv->btcoexist.pre_bt_disabled\n\t\t\t= rtlpriv->btcoexist.cur_bt_disabled;\n\t}\n}\n\n\nvoid rtl8723e_dm_bt_coexist_8723(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\n\trtl8723e_dm_bt_query_bt_information(hw);\n\trtl8723e_dm_bt_bt_hw_counters_monitor(hw);\n\trtl8723e_dm_bt_bt_enable_disable_check(hw);\n\n\tif (rtlpriv->btcoexist.bt_ant_num == ANT_X2) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], 2 Ant mechanism\\n\");\n\t\t_rtl8723e_dm_bt_coexist_2_ant(hw);\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\"[BTCoex], 1 Ant mechanism\\n\");\n\t\t_rtl8723e_dm_bt_coexist_1_ant(hw);\n\t}\n\n\tif (!rtl8723e_dm_bt_is_same_coexist_state(hw)) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTCoex], Coexist State[bitMap] change from 0x%x%8x to 0x%x%8x\\n\",\n\t\t\trtlpriv->btcoexist.previous_state_h,\n\t\t\trtlpriv->btcoexist.previous_state,\n\t\t\trtlpriv->btcoexist.cstate_h,\n\t\t\trtlpriv->btcoexist.cstate);\n\t\trtlpriv->btcoexist.previous_state\n\t\t\t= rtlpriv->btcoexist.cstate;\n\t\trtlpriv->btcoexist.previous_state_h\n\t\t\t= rtlpriv->btcoexist.cstate_h;\n\t}\n}\n\nstatic void rtl8723e_dm_bt_parse_bt_info(struct ieee80211_hw *hw,\n\t\t\t\t\t u8 *tmp_buf, u8 len)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tu8 bt_info;\n\tu8 i;\n\n\thal_coex_8723.c2h_bt_info_req_sent = false;\n\thal_coex_8723.bt_retry_cnt = 0;\n\tfor (i = 0; i < len; i++) {\n\t\tif (i == 0)\n\t\t\thal_coex_8723.c2h_bt_info_original = tmp_buf[i];\n\t\telse if (i == 1)\n\t\t\thal_coex_8723.bt_retry_cnt = tmp_buf[i];\n\t\tif (i == len-1)\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"0x%2x]\", tmp_buf[i]);\n\t\telse\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\n\t\t\t\t\"0x%2x, \", tmp_buf[i]);\n\n\t}\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\"BT info bt_info (Data)= 0x%x\\n\",\n\t\t\thal_coex_8723.c2h_bt_info_original);\n\tbt_info = hal_coex_8723.c2h_bt_info_original;\n\n\tif (bt_info & BIT(2))\n\t\thal_coex_8723.c2h_bt_inquiry_page = true;\n\telse\n\t\thal_coex_8723.c2h_bt_inquiry_page = false;\n\n\n\tif (bt_info & BTINFO_B_CONNECTION) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTC2H], BTInfo: bConnect=true\\n\");\n\t\trtlpriv->btcoexist.bt_busy = true;\n\t\trtlpriv->btcoexist.cstate &= ~BT_COEX_STATE_BT_IDLE;\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\n\t\t\t\"[BTC2H], BTInfo: bConnect=false\\n\");\n\t\trtlpriv->btcoexist.bt_busy = false;\n\t\trtlpriv->btcoexist.cstate |= BT_COEX_STATE_BT_IDLE;\n\t}\n}\nvoid rtl_8723e_c2h_command_handle(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct c2h_evt_hdr c2h_event;\n\tu8 *ptmp_buf = NULL;\n\tu8 index = 0;\n\tu8 u1b_tmp = 0;\n\tmemset(&c2h_event, 0, sizeof(c2h_event));\n\tu1b_tmp = rtl_read_byte(rtlpriv, REG_C2HEVT_MSG_NORMAL);\n\trtl_dbg(rtlpriv, COMP_FW, DBG_DMESG,\n\t\t\"&&&&&&: REG_C2HEVT_MSG_NORMAL is 0x%x\\n\", u1b_tmp);\n\tc2h_event.cmd_id = u1b_tmp & 0xF;\n\tc2h_event.cmd_len = (u1b_tmp & 0xF0) >> 4;\n\tc2h_event.cmd_seq = rtl_read_byte(rtlpriv, REG_C2HEVT_MSG_NORMAL + 1);\n\trtl_dbg(rtlpriv, COMP_FW, DBG_DMESG,\n\t\t\"cmd_id: %d, cmd_len: %d, cmd_seq: %d\\n\",\n\t\tc2h_event.cmd_id, c2h_event.cmd_len, c2h_event.cmd_seq);\n\tu1b_tmp = rtl_read_byte(rtlpriv, 0x01AF);\n\tif (u1b_tmp == C2H_EVT_HOST_CLOSE) {\n\t\treturn;\n\t} else if (u1b_tmp != C2H_EVT_FW_CLOSE) {\n\t\trtl_write_byte(rtlpriv, 0x1AF, 0x00);\n\t\treturn;\n\t}\n\tptmp_buf = kzalloc(c2h_event.cmd_len, GFP_KERNEL);\n\tif (ptmp_buf == NULL) {\n\t\trtl_dbg(rtlpriv, COMP_FW, DBG_TRACE,\n\t\t\t\"malloc cmd buf failed\\n\");\n\t\treturn;\n\t}\n\n\t \n\tfor (index = 0; index < c2h_event.cmd_len; index++)\n\t\tptmp_buf[index] = rtl_read_byte(rtlpriv,\n\t\t\t\t\tREG_C2HEVT_MSG_NORMAL + 2 + index);\n\n\n\tswitch (c2h_event.cmd_id) {\n\tcase C2H_V0_BT_RSSI:\n\t\t\tbreak;\n\n\tcase C2H_V0_BT_OP_MODE:\n\t\t\tbreak;\n\n\tcase C2H_V0_BT_INFO:\n\t\trtl_dbg(rtlpriv, COMP_FW, DBG_TRACE,\n\t\t\t\"BT info Byte[0] (ID) is 0x%x\\n\",\n\t\t\tc2h_event.cmd_id);\n\t\trtl_dbg(rtlpriv, COMP_FW, DBG_TRACE,\n\t\t\t\"BT info Byte[1] (Seq) is 0x%x\\n\",\n\t\t\tc2h_event.cmd_seq);\n\t\trtl_dbg(rtlpriv, COMP_FW, DBG_TRACE,\n\t\t\t\"BT info Byte[2] (Data)= 0x%x\\n\", ptmp_buf[0]);\n\n\t\trtl8723e_dm_bt_parse_bt_info(hw, ptmp_buf, c2h_event.cmd_len);\n\n\t\tif (rtlpriv->cfg->ops->get_btc_status())\n\t\t\trtlpriv->btcoexist.btc_ops->btc_periodical(rtlpriv);\n\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\tkfree(ptmp_buf);\n\n\trtl_write_byte(rtlpriv, 0x01AF, C2H_EVT_HOST_CLOSE);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}