{
  "module_name": "halbtc8723b1ant.c",
  "hash_id": "69a73eac085e709aba66e70b133f8c2af4e6f1d387acfb8e46ddd54d22b8b6bc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtlwifi/btcoexist/halbtc8723b1ant.c",
  "human_readable_source": "\n \n\n \n\n \n#include \"halbt_precomp.h\"\n \nstatic struct coex_dm_8723b_1ant glcoex_dm_8723b_1ant;\nstatic struct coex_dm_8723b_1ant *coex_dm = &glcoex_dm_8723b_1ant;\nstatic struct coex_sta_8723b_1ant glcoex_sta_8723b_1ant;\nstatic struct coex_sta_8723b_1ant *coex_sta = &glcoex_sta_8723b_1ant;\n\nstatic const char *const glbt_info_src_8723b_1ant[] = {\n\t\"BT Info[wifi fw]\",\n\t\"BT Info[bt rsp]\",\n\t\"BT Info[bt auto report]\",\n};\n\nstatic u32 glcoex_ver_date_8723b_1ant = 20130918;\nstatic u32 glcoex_ver_8723b_1ant = 0x47;\n\n \n \n\nstatic void halbtc8723b1ant_updatera_mask(struct btc_coexist *btcoexist,\n\t\t\t\t\t  bool force_exec, u32 dis_rate_mask)\n{\n\tcoex_dm->curra_mask = dis_rate_mask;\n\n\tif (force_exec || (coex_dm->prera_mask != coex_dm->curra_mask))\n\t\tbtcoexist->btc_set(btcoexist, BTC_SET_ACT_UPDATE_RAMASK,\n\t\t\t\t   &coex_dm->curra_mask);\n\n\tcoex_dm->prera_mask = coex_dm->curra_mask;\n}\n\nstatic void btc8723b1ant_auto_rate_fb_retry(struct btc_coexist *btcoexist,\n\t\t\t\t\t    bool force_exec, u8 type)\n{\n\tbool wifi_under_bmode = false;\n\n\tcoex_dm->cur_arfr_type = type;\n\n\tif (force_exec || (coex_dm->pre_arfr_type != coex_dm->cur_arfr_type)) {\n\t\tswitch (coex_dm->cur_arfr_type) {\n\t\tcase 0:\t \n\t\t\tbtcoexist->btc_write_4byte(btcoexist, 0x430,\n\t\t\t\t\t\t   coex_dm->backup_arfr_cnt1);\n\t\t\tbtcoexist->btc_write_4byte(btcoexist, 0x434,\n\t\t\t\t\t\t   coex_dm->backup_arfr_cnt2);\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\tbtcoexist->btc_get(btcoexist,\n\t\t\t\t\t   BTC_GET_BL_WIFI_UNDER_B_MODE,\n\t\t\t\t\t   &wifi_under_bmode);\n\t\t\tif (wifi_under_bmode) {\n\t\t\t\tbtcoexist->btc_write_4byte(btcoexist,\n\t\t\t\t\t\t\t   0x430, 0x0);\n\t\t\t\tbtcoexist->btc_write_4byte(btcoexist,\n\t\t\t\t\t\t\t   0x434, 0x01010101);\n\t\t\t} else {\n\t\t\t\tbtcoexist->btc_write_4byte(btcoexist,\n\t\t\t\t\t\t\t   0x430, 0x0);\n\t\t\t\tbtcoexist->btc_write_4byte(btcoexist,\n\t\t\t\t\t\t\t   0x434, 0x04030201);\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tcoex_dm->pre_arfr_type = coex_dm->cur_arfr_type;\n}\n\nstatic void halbtc8723b1ant_retry_limit(struct btc_coexist *btcoexist,\n\t\t\t\t\tbool force_exec, u8 type)\n{\n\tcoex_dm->cur_retry_limit_type = type;\n\n\tif (force_exec || (coex_dm->pre_retry_limit_type !=\n\t\t\t   coex_dm->cur_retry_limit_type)) {\n\t\tswitch (coex_dm->cur_retry_limit_type) {\n\t\tcase 0:\t \n\t\t\tbtcoexist->btc_write_2byte(btcoexist, 0x42a,\n\t\t\t\t\t\t   coex_dm->backup_retry_limit);\n\t\t\tbreak;\n\t\tcase 1:\t \n\t\t\tbtcoexist->btc_write_2byte(btcoexist, 0x42a, 0x0808);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tcoex_dm->pre_retry_limit_type = coex_dm->cur_retry_limit_type;\n}\n\nstatic void halbtc8723b1ant_ampdu_maxtime(struct btc_coexist *btcoexist,\n\t\t\t\t\t  bool force_exec, u8 type)\n{\n\tcoex_dm->cur_ampdu_time_type = type;\n\n\tif (force_exec || (coex_dm->pre_ampdu_time_type !=\n\t\tcoex_dm->cur_ampdu_time_type)) {\n\t\tswitch (coex_dm->cur_ampdu_time_type) {\n\t\tcase 0:\t \n\t\t\tbtcoexist->btc_write_1byte(btcoexist, 0x456,\n\t\t\t\t\tcoex_dm->backup_ampdu_max_time);\n\t\t\tbreak;\n\t\tcase 1:\t \n\t\t\tbtcoexist->btc_write_1byte(btcoexist, 0x456, 0x38);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tcoex_dm->pre_ampdu_time_type = coex_dm->cur_ampdu_time_type;\n}\n\nstatic void halbtc8723b1ant_limited_tx(struct btc_coexist *btcoexist,\n\t\t\t\t       bool force_exec, u8 ra_masktype,\n\t\t\t\t       u8 arfr_type, u8 retry_limit_type,\n\t\t\t\t       u8 ampdu_time_type)\n{\n\tswitch (ra_masktype) {\n\tcase 0:\t \n\t\thalbtc8723b1ant_updatera_mask(btcoexist, force_exec, 0x0);\n\t\tbreak;\n\tcase 1:\t \n\t\thalbtc8723b1ant_updatera_mask(btcoexist, force_exec,\n\t\t\t\t\t      0x00000003);\n\t\tbreak;\n\t \n\tcase 2:\n\t\thalbtc8723b1ant_updatera_mask(btcoexist, force_exec,\n\t\t\t\t\t      0x0001f1f7);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tbtc8723b1ant_auto_rate_fb_retry(btcoexist, force_exec, arfr_type);\n\thalbtc8723b1ant_retry_limit(btcoexist, force_exec, retry_limit_type);\n\thalbtc8723b1ant_ampdu_maxtime(btcoexist, force_exec, ampdu_time_type);\n}\n\nstatic void halbtc8723b1ant_limited_rx(struct btc_coexist *btcoexist,\n\t\t\t\t       bool force_exec, bool rej_ap_agg_pkt,\n\t\t\t\t       bool bt_ctrl_agg_buf_size,\n\t\t\t\t       u8 agg_buf_size)\n{\n\tbool reject_rx_agg = rej_ap_agg_pkt;\n\tbool bt_ctrl_rx_agg_size = bt_ctrl_agg_buf_size;\n\tu8 rxaggsize = agg_buf_size;\n\n\t \n\tbtcoexist->btc_set(btcoexist, BTC_SET_BL_TO_REJ_AP_AGG_PKT,\n\t\t\t   &reject_rx_agg);\n\t \n\tbtcoexist->btc_set(btcoexist, BTC_SET_BL_BT_CTRL_AGG_SIZE,\n\t\t\t   &bt_ctrl_rx_agg_size);\n\t \n\tbtcoexist->btc_set(btcoexist, BTC_SET_U1_AGG_BUF_SIZE, &rxaggsize);\n\t \n\tbtcoexist->btc_set(btcoexist, BTC_SET_ACT_AGGREGATE_CTRL, NULL);\n}\n\nstatic void halbtc8723b1ant_query_bt_info(struct btc_coexist *btcoexist)\n{\n\tu8 h2c_parameter[1] = {0};\n\n\tcoex_sta->c2h_bt_info_req_sent = true;\n\n\t \n\th2c_parameter[0] |= BIT(0);\n\n\tbtcoexist->btc_fill_h2c(btcoexist, 0x61, 1, h2c_parameter);\n}\n\nstatic void halbtc8723b1ant_monitor_bt_ctr(struct btc_coexist *btcoexist)\n{\n\tu32 reg_hp_txrx, reg_lp_txrx, u32tmp;\n\tu32 reg_hp_tx = 0, reg_hp_rx = 0;\n\tu32 reg_lp_tx = 0, reg_lp_rx = 0;\n\tstatic u32 num_of_bt_counter_chk;\n\n\treg_hp_txrx = 0x770;\n\treg_lp_txrx = 0x774;\n\n\tu32tmp = btcoexist->btc_read_4byte(btcoexist, reg_hp_txrx);\n\treg_hp_tx = u32tmp & MASKLWORD;\n\treg_hp_rx = (u32tmp & MASKHWORD) >> 16;\n\n\tu32tmp = btcoexist->btc_read_4byte(btcoexist, reg_lp_txrx);\n\treg_lp_tx = u32tmp & MASKLWORD;\n\treg_lp_rx = (u32tmp & MASKHWORD) >> 16;\n\n\tcoex_sta->high_priority_tx = reg_hp_tx;\n\tcoex_sta->high_priority_rx = reg_hp_rx;\n\tcoex_sta->low_priority_tx = reg_lp_tx;\n\tcoex_sta->low_priority_rx = reg_lp_rx;\n\n\tif ((coex_sta->low_priority_tx > 1050) &&\n\t    (!coex_sta->c2h_bt_inquiry_page))\n\t\tcoex_sta->pop_event_cnt++;\n\n\t \n\tbtcoexist->btc_write_1byte(btcoexist, 0x76e, 0xc);\n\n\t \n\tif ((reg_hp_tx == 0) && (reg_hp_rx == 0) && (reg_lp_tx == 0) &&\n\t    (reg_lp_rx == 0)) {\n\t\tnum_of_bt_counter_chk++;\n\t\tif (num_of_bt_counter_chk == 3)\n\t\t\thalbtc8723b1ant_query_bt_info(btcoexist);\n\t} else {\n\t\tnum_of_bt_counter_chk = 0;\n\t}\n}\n\nstatic void halbtc8723b1ant_monitor_wifi_ctr(struct btc_coexist *btcoexist)\n{\n\ts32 wifi_rssi = 0;\n\tbool wifi_busy = false, wifi_under_b_mode = false;\n\tstatic u8 cck_lock_counter;\n\tu32 total_cnt;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_S4_WIFI_RSSI, &wifi_rssi);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_UNDER_B_MODE,\n\t\t\t   &wifi_under_b_mode);\n\n\tif (coex_sta->under_ips) {\n\t\tcoex_sta->crc_ok_cck = 0;\n\t\tcoex_sta->crc_ok_11g = 0;\n\t\tcoex_sta->crc_ok_11n = 0;\n\t\tcoex_sta->crc_ok_11n_agg = 0;\n\n\t\tcoex_sta->crc_err_cck = 0;\n\t\tcoex_sta->crc_err_11g = 0;\n\t\tcoex_sta->crc_err_11n = 0;\n\t\tcoex_sta->crc_err_11n_agg = 0;\n\t} else {\n\t\tcoex_sta->crc_ok_cck =\n\t\t\tbtcoexist->btc_read_4byte(btcoexist, 0xf88);\n\t\tcoex_sta->crc_ok_11g =\n\t\t\tbtcoexist->btc_read_2byte(btcoexist, 0xf94);\n\t\tcoex_sta->crc_ok_11n =\n\t\t\tbtcoexist->btc_read_2byte(btcoexist, 0xf90);\n\t\tcoex_sta->crc_ok_11n_agg =\n\t\t\tbtcoexist->btc_read_2byte(btcoexist, 0xfb8);\n\n\t\tcoex_sta->crc_err_cck =\n\t\t\tbtcoexist->btc_read_4byte(btcoexist, 0xf84);\n\t\tcoex_sta->crc_err_11g =\n\t\t\tbtcoexist->btc_read_2byte(btcoexist, 0xf96);\n\t\tcoex_sta->crc_err_11n =\n\t\t\tbtcoexist->btc_read_2byte(btcoexist, 0xf92);\n\t\tcoex_sta->crc_err_11n_agg =\n\t\t\tbtcoexist->btc_read_2byte(btcoexist, 0xfba);\n\t}\n\n\t \n\tbtcoexist->btc_write_1byte_bitmask(btcoexist, 0xf16, 0x1, 0x1);\n\tbtcoexist->btc_write_1byte_bitmask(btcoexist, 0xf16, 0x1, 0x0);\n\n\tif ((wifi_busy) && (wifi_rssi >= 30) && (!wifi_under_b_mode)) {\n\t\ttotal_cnt = coex_sta->crc_ok_cck + coex_sta->crc_ok_11g +\n\t\t\t    coex_sta->crc_ok_11n + coex_sta->crc_ok_11n_agg;\n\n\t\tif ((coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) ||\n\t\t    (coex_dm->bt_status ==\n\t\t     BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY) ||\n\t\t    (coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_SCO_BUSY)) {\n\t\t\tif (coex_sta->crc_ok_cck >\n\t\t\t    (total_cnt - coex_sta->crc_ok_cck)) {\n\t\t\t\tif (cck_lock_counter < 3)\n\t\t\t\t\tcck_lock_counter++;\n\t\t\t} else {\n\t\t\t\tif (cck_lock_counter > 0)\n\t\t\t\t\tcck_lock_counter--;\n\t\t\t}\n\n\t\t} else {\n\t\t\tif (cck_lock_counter > 0)\n\t\t\t\tcck_lock_counter--;\n\t\t}\n\t} else {\n\t\tif (cck_lock_counter > 0)\n\t\t\tcck_lock_counter--;\n\t}\n\n\tif (!coex_sta->pre_ccklock) {\n\t\tif (cck_lock_counter >= 3)\n\t\t\tcoex_sta->cck_lock = true;\n\t\telse\n\t\t\tcoex_sta->cck_lock = false;\n\t} else {\n\t\tif (cck_lock_counter == 0)\n\t\t\tcoex_sta->cck_lock = false;\n\t\telse\n\t\t\tcoex_sta->cck_lock = true;\n\t}\n\n\tif (coex_sta->cck_lock)\n\t\tcoex_sta->cck_ever_lock = true;\n\n\tcoex_sta->pre_ccklock = coex_sta->cck_lock;\n}\n\nstatic bool btc8723b1ant_is_wifi_status_changed(struct btc_coexist *btcoexist)\n{\n\tstatic bool pre_wifi_busy;\n\tstatic bool pre_under_4way, pre_bt_hs_on;\n\tbool wifi_busy = false, under_4way = false, bt_hs_on = false;\n\tbool wifi_connected = false;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED,\n\t\t\t   &wifi_connected);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_4_WAY_PROGRESS,\n\t\t\t   &under_4way);\n\n\tif (wifi_connected) {\n\t\tif (wifi_busy != pre_wifi_busy) {\n\t\t\tpre_wifi_busy = wifi_busy;\n\t\t\treturn true;\n\t\t}\n\t\tif (under_4way != pre_under_4way) {\n\t\t\tpre_under_4way = under_4way;\n\t\t\treturn true;\n\t\t}\n\t\tif (bt_hs_on != pre_bt_hs_on) {\n\t\t\tpre_bt_hs_on = bt_hs_on;\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\nstatic void halbtc8723b1ant_update_bt_link_info(struct btc_coexist *btcoexist)\n{\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\tbool bt_hs_on = false;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on);\n\n\tbt_link_info->bt_link_exist = coex_sta->bt_link_exist;\n\tbt_link_info->sco_exist = coex_sta->sco_exist;\n\tbt_link_info->a2dp_exist = coex_sta->a2dp_exist;\n\tbt_link_info->pan_exist = coex_sta->pan_exist;\n\tbt_link_info->hid_exist = coex_sta->hid_exist;\n\tbt_link_info->bt_hi_pri_link_exist = coex_sta->bt_hi_pri_link_exist;\n\n\t \n\tif (bt_hs_on) {\n\t\tbt_link_info->pan_exist = true;\n\t\tbt_link_info->bt_link_exist = true;\n\t}\n\n\t \n\tif (bt_link_info->sco_exist && !bt_link_info->a2dp_exist &&\n\t    !bt_link_info->pan_exist && !bt_link_info->hid_exist)\n\t\tbt_link_info->sco_only = true;\n\telse\n\t\tbt_link_info->sco_only = false;\n\n\t \n\tif (!bt_link_info->sco_exist && bt_link_info->a2dp_exist &&\n\t    !bt_link_info->pan_exist && !bt_link_info->hid_exist)\n\t\tbt_link_info->a2dp_only = true;\n\telse\n\t\tbt_link_info->a2dp_only = false;\n\n\t \n\tif (!bt_link_info->sco_exist && !bt_link_info->a2dp_exist &&\n\t    bt_link_info->pan_exist && !bt_link_info->hid_exist)\n\t\tbt_link_info->pan_only = true;\n\telse\n\t\tbt_link_info->pan_only = false;\n\n\t \n\tif (!bt_link_info->sco_exist && !bt_link_info->a2dp_exist &&\n\t    !bt_link_info->pan_exist && bt_link_info->hid_exist)\n\t\tbt_link_info->hid_only = true;\n\telse\n\t\tbt_link_info->hid_only = false;\n}\n\nstatic void halbtc8723b1ant_set_bt_auto_report(struct btc_coexist *btcoexist,\n\t\t\t\t\t       bool enable_auto_report)\n{\n\tu8 h2c_parameter[1] = {0};\n\n\th2c_parameter[0] = 0;\n\n\tif (enable_auto_report)\n\t\th2c_parameter[0] |= BIT(0);\n\n\tbtcoexist->btc_fill_h2c(btcoexist, 0x68, 1, h2c_parameter);\n}\n\nstatic void halbtc8723b1ant_bt_auto_report(struct btc_coexist *btcoexist,\n\t\t\t\t\t   bool force_exec,\n\t\t\t\t\t   bool enable_auto_report)\n{\n\tcoex_dm->cur_bt_auto_report = enable_auto_report;\n\n\tif (!force_exec) {\n\t\tif (coex_dm->pre_bt_auto_report == coex_dm->cur_bt_auto_report)\n\t\t\treturn;\n\t}\n\thalbtc8723b1ant_set_bt_auto_report(btcoexist,\n\t\t\t\t\t   coex_dm->cur_bt_auto_report);\n\n\tcoex_dm->pre_bt_auto_report = coex_dm->cur_bt_auto_report;\n}\n\nstatic void btc8723b1ant_set_sw_pen_tx_rate_adapt(struct btc_coexist *btcoexist,\n\t\t\t\t\t\t  bool low_penalty_ra)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tu8 h2c_parameter[6] = {0};\n\n\th2c_parameter[0] = 0x6;\t \n\n\tif (low_penalty_ra) {\n\t\th2c_parameter[1] |= BIT0;\n\t\t \n\t\th2c_parameter[2] = 0x00;\n\t\th2c_parameter[3] = 0xf7;   \n\t\th2c_parameter[4] = 0xf8;   \n\t\th2c_parameter[5] = 0xf9;   \n\t}\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], set WiFi Low-Penalty Retry: %s\",\n\t\t(low_penalty_ra ? \"ON!!\" : \"OFF!!\"));\n\n\tbtcoexist->btc_fill_h2c(btcoexist, 0x69, 6, h2c_parameter);\n}\n\nstatic void halbtc8723b1ant_low_penalty_ra(struct btc_coexist *btcoexist,\n\t\t\t\t\t   bool force_exec, bool low_penalty_ra)\n{\n\tcoex_dm->cur_low_penalty_ra = low_penalty_ra;\n\n\tif (!force_exec) {\n\t\tif (coex_dm->pre_low_penalty_ra == coex_dm->cur_low_penalty_ra)\n\t\t\treturn;\n\t}\n\tbtc8723b1ant_set_sw_pen_tx_rate_adapt(btcoexist,\n\t\t\t\t\t      coex_dm->cur_low_penalty_ra);\n\n\tcoex_dm->pre_low_penalty_ra = coex_dm->cur_low_penalty_ra;\n}\n\nstatic void halbtc8723b1ant_set_coex_table(struct btc_coexist *btcoexist,\n\t\t\t\t\t   u32 val0x6c0, u32 val0x6c4,\n\t\t\t\t\t   u32 val0x6c8, u8 val0x6cc)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], set coex table, set 0x6c0 = 0x%x\\n\", val0x6c0);\n\tbtcoexist->btc_write_4byte(btcoexist, 0x6c0, val0x6c0);\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], set coex table, set 0x6c4 = 0x%x\\n\", val0x6c4);\n\tbtcoexist->btc_write_4byte(btcoexist, 0x6c4, val0x6c4);\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], set coex table, set 0x6c8 = 0x%x\\n\", val0x6c8);\n\tbtcoexist->btc_write_4byte(btcoexist, 0x6c8, val0x6c8);\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], set coex table, set 0x6cc = 0x%x\\n\", val0x6cc);\n\tbtcoexist->btc_write_1byte(btcoexist, 0x6cc, val0x6cc);\n}\n\nstatic void halbtc8723b1ant_coex_table(struct btc_coexist *btcoexist,\n\t\t\t\t       bool force_exec, u32 val0x6c0,\n\t\t\t\t       u32 val0x6c4, u32 val0x6c8,\n\t\t\t\t       u8 val0x6cc)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], %s write Coex Table 0x6c0 = 0x%x, 0x6c4 = 0x%x, 0x6cc = 0x%x\\n\",\n\t\t (force_exec ? \"force to\" : \"\"),\n\t\t val0x6c0, val0x6c4, val0x6cc);\n\tcoex_dm->cur_val0x6c0 = val0x6c0;\n\tcoex_dm->cur_val0x6c4 = val0x6c4;\n\tcoex_dm->cur_val0x6c8 = val0x6c8;\n\tcoex_dm->cur_val0x6cc = val0x6cc;\n\n\tif (!force_exec) {\n\t\tif ((coex_dm->pre_val0x6c0 == coex_dm->cur_val0x6c0) &&\n\t\t    (coex_dm->pre_val0x6c4 == coex_dm->cur_val0x6c4) &&\n\t\t    (coex_dm->pre_val0x6c8 == coex_dm->cur_val0x6c8) &&\n\t\t    (coex_dm->pre_val0x6cc == coex_dm->cur_val0x6cc))\n\t\t\treturn;\n\t}\n\thalbtc8723b1ant_set_coex_table(btcoexist, val0x6c0, val0x6c4,\n\t\t\t\t       val0x6c8, val0x6cc);\n\n\tcoex_dm->pre_val0x6c0 = coex_dm->cur_val0x6c0;\n\tcoex_dm->pre_val0x6c4 = coex_dm->cur_val0x6c4;\n\tcoex_dm->pre_val0x6c8 = coex_dm->cur_val0x6c8;\n\tcoex_dm->pre_val0x6cc = coex_dm->cur_val0x6cc;\n}\n\nstatic void halbtc8723b1ant_coex_table_with_type(struct btc_coexist *btcoexist,\n\t\t\t\t\t\t bool force_exec, u8 type)\n{\n\tcoex_sta->coex_table_type = type;\n\n\tswitch (type) {\n\tcase 0:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x55555555,\n\t\t\t\t\t   0x55555555, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 1:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x55555555,\n\t\t\t\t\t   0x5a5a5a5a, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 2:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x5a5a5a5a,\n\t\t\t\t\t   0x5a5a5a5a, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 3:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x55555555,\n\t\t\t\t\t   0x5a5a5a5a, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 4:\n\t\tif ((coex_sta->cck_ever_lock) && (coex_sta->scan_ap_num <= 5))\n\t\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec,\n\t\t\t\t\t\t   0x55555555, 0xaaaa5a5a,\n\t\t\t\t\t\t   0xffffff, 0x3);\n\t\telse\n\t\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec,\n\t\t\t\t\t\t   0x55555555, 0x5a5a5a5a,\n\t\t\t\t\t\t   0xffffff, 0x3);\n\t\tbreak;\n\tcase 5:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x5a5a5a5a,\n\t\t\t\t\t   0x5aaa5a5a, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 6:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x55555555,\n\t\t\t\t\t   0xaaaaaaaa, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 7:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0xaaaaaaaa,\n\t\t\t\t\t   0xaaaaaaaa, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 8:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x55dd55dd,\n\t\t\t\t\t   0x5ada5ada, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 9:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x55dd55dd,\n\t\t\t\t\t   0x5ada5ada, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 10:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x55dd55dd,\n\t\t\t\t\t   0x5ada5ada, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 11:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x55dd55dd,\n\t\t\t\t\t   0x5ada5ada, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 12:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x55dd55dd,\n\t\t\t\t\t   0x5ada5ada, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 13:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x5fff5fff,\n\t\t\t\t\t   0xaaaaaaaa, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 14:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x5fff5fff,\n\t\t\t\t\t   0x5ada5ada, 0xffffff, 0x3);\n\t\tbreak;\n\tcase 15:\n\t\thalbtc8723b1ant_coex_table(btcoexist, force_exec, 0x55dd55dd,\n\t\t\t\t\t   0xaaaaaaaa, 0xffffff, 0x3);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void\nhalbtc8723b1ant_set_fw_ignore_wlan_act(struct btc_coexist *btcoexist,\n\t\t\t\t       bool enable)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tu8 h2c_parameter[1] = {0};\n\n\tif (enable)\n\t\th2c_parameter[0] |= BIT0;\t \n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], set FW for BT Ignore Wlan_Act, FW write 0x63 = 0x%x\\n\",\n\t\th2c_parameter[0]);\n\n\tbtcoexist->btc_fill_h2c(btcoexist, 0x63, 1, h2c_parameter);\n}\n\nstatic void halbtc8723b1ant_ignore_wlan_act(struct btc_coexist *btcoexist,\n\t\t\t\t\t    bool force_exec, bool enable)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], %s turn Ignore WlanAct %s\\n\",\n\t\t(force_exec ? \"force to\" : \"\"), (enable ? \"ON\" : \"OFF\"));\n\tcoex_dm->cur_ignore_wlan_act = enable;\n\n\tif (!force_exec) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], bPreIgnoreWlanAct = %d, bCurIgnoreWlanAct = %d!!\\n\",\n\t\t\tcoex_dm->pre_ignore_wlan_act,\n\t\t\t coex_dm->cur_ignore_wlan_act);\n\n\t\tif (coex_dm->pre_ignore_wlan_act ==\n\t\t    coex_dm->cur_ignore_wlan_act)\n\t\t\treturn;\n\t}\n\thalbtc8723b1ant_set_fw_ignore_wlan_act(btcoexist, enable);\n\n\tcoex_dm->pre_ignore_wlan_act = coex_dm->cur_ignore_wlan_act;\n}\n\nstatic void halbtc8723b1ant_set_fw_ps_tdma(struct btc_coexist *btcoexist,\n\t\t\t\t\t   u8 byte1, u8 byte2, u8 byte3,\n\t\t\t\t\t   u8 byte4, u8 byte5)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tu8 h2c_parameter[5] = {0};\n\tu8 real_byte1 = byte1, real_byte5 = byte5;\n\tbool ap_enable = false;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_AP_MODE_ENABLE,\n\t\t\t   &ap_enable);\n\n\tif (ap_enable) {\n\t\tif ((byte1 & BIT4) && !(byte1 & BIT5)) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\"[BTCoex], FW for 1Ant AP mode\\n\");\n\t\t\treal_byte1 &= ~BIT4;\n\t\t\treal_byte1 |= BIT5;\n\n\t\t\treal_byte5 |= BIT5;\n\t\t\treal_byte5 &= ~BIT6;\n\t\t}\n\t}\n\n\th2c_parameter[0] = real_byte1;\n\th2c_parameter[1] = byte2;\n\th2c_parameter[2] = byte3;\n\th2c_parameter[3] = byte4;\n\th2c_parameter[4] = real_byte5;\n\n\tcoex_dm->ps_tdma_para[0] = real_byte1;\n\tcoex_dm->ps_tdma_para[1] = byte2;\n\tcoex_dm->ps_tdma_para[2] = byte3;\n\tcoex_dm->ps_tdma_para[3] = byte4;\n\tcoex_dm->ps_tdma_para[4] = real_byte5;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], PS-TDMA H2C cmd =0x%x%08x\\n\",\n\t\th2c_parameter[0],\n\t\th2c_parameter[1] << 24 |\n\t\th2c_parameter[2] << 16 |\n\t\th2c_parameter[3] << 8 |\n\t\th2c_parameter[4]);\n\n\tbtcoexist->btc_fill_h2c(btcoexist, 0x60, 5, h2c_parameter);\n}\n\nstatic void halbtc8723b1ant_set_lps_rpwm(struct btc_coexist *btcoexist,\n\t\t\t\t\t u8 lps_val, u8 rpwm_val)\n{\n\tu8 lps = lps_val;\n\tu8 rpwm = rpwm_val;\n\n\tbtcoexist->btc_set(btcoexist, BTC_SET_U1_LPS_VAL, &lps);\n\tbtcoexist->btc_set(btcoexist, BTC_SET_U1_RPWM_VAL, &rpwm);\n}\n\nstatic void halbtc8723b1ant_lps_rpwm(struct btc_coexist *btcoexist,\n\t\t\t\t     bool force_exec,\n\t\t\t\t     u8 lps_val, u8 rpwm_val)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], %s set lps/rpwm = 0x%x/0x%x\\n\",\n\t\t(force_exec ? \"force to\" : \"\"), lps_val, rpwm_val);\n\tcoex_dm->cur_lps = lps_val;\n\tcoex_dm->cur_rpwm = rpwm_val;\n\n\tif (!force_exec) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], LPS-RxBeaconMode = 0x%x , LPS-RPWM = 0x%x!!\\n\",\n\t\t\tcoex_dm->cur_lps, coex_dm->cur_rpwm);\n\n\t\tif ((coex_dm->pre_lps == coex_dm->cur_lps) &&\n\t\t    (coex_dm->pre_rpwm == coex_dm->cur_rpwm)) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\"[BTCoex], LPS-RPWM_Last = 0x%x , LPS-RPWM_Now = 0x%x!!\\n\",\n\t\t\t\tcoex_dm->pre_rpwm, coex_dm->cur_rpwm);\n\n\t\t\treturn;\n\t\t}\n\t}\n\thalbtc8723b1ant_set_lps_rpwm(btcoexist, lps_val, rpwm_val);\n\n\tcoex_dm->pre_lps = coex_dm->cur_lps;\n\tcoex_dm->pre_rpwm = coex_dm->cur_rpwm;\n}\n\nstatic void halbtc8723b1ant_sw_mechanism(struct btc_coexist *btcoexist,\n\t\t\t\t\t bool low_penalty_ra)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], SM[LpRA] = %d\\n\", low_penalty_ra);\n\n\thalbtc8723b1ant_low_penalty_ra(btcoexist, NORMAL_EXEC, low_penalty_ra);\n}\n\nstatic void halbtc8723b1ant_set_ant_path(struct btc_coexist *btcoexist,\n\t\t\t\t\t u8 ant_pos_type, bool force_exec,\n\t\t\t\t\t bool init_hw_cfg, bool wifi_off)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tstruct btc_board_info *board_info = &btcoexist->board_info;\n\tu32 fw_ver = 0, u32tmp = 0, cnt_bt_cal_chk = 0;\n\tbool pg_ext_switch = false;\n\tbool use_ext_switch = false;\n\tbool is_in_mp_mode = false;\n\tu8 h2c_parameter[2] = {0}, u8tmp = 0;\n\n\tcoex_dm->cur_ant_pos_type = ant_pos_type;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_EXT_SWITCH, &pg_ext_switch);\n\t \n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_FW_VER, &fw_ver);\n\n\tif ((fw_ver < 0xc0000) || pg_ext_switch)\n\t\tuse_ext_switch = true;\n\n\tif (init_hw_cfg) {\n\t\t \n\t\tbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0x1, 0xfffff,\n\t\t\t\t\t  0x780);\n\t\t \n\n\t\tif (fw_ver >= 0x180000) {\n\t\t\t \n\t\t\th2c_parameter[0] = 1;\n\t\t\tbtcoexist->btc_fill_h2c(btcoexist, 0x6E, 1,\n\t\t\t\t\t\th2c_parameter);\n\t\t} else {\n\t\t\t \n\t\t\tbtcoexist->btc_write_1byte(btcoexist, 0x765, 0x18);\n\t\t}\n\t\t \n\t\tbtcoexist->btc_write_1byte(btcoexist, 0x76e, 0x4);\n\n\t\t \n\t\tbtcoexist->btc_write_1byte_bitmask(btcoexist, 0x67, 0x20, 0x0);\n\t\tbtcoexist->btc_write_1byte_bitmask(btcoexist, 0x39, 0x8, 0x1);\n\t\tbtcoexist->btc_write_1byte(btcoexist, 0x974, 0xff);\n\t\tbtcoexist->btc_write_1byte_bitmask(btcoexist, 0x944, 0x3, 0x3);\n\t\tbtcoexist->btc_write_1byte(btcoexist, 0x930, 0x77);\n\t} else if (wifi_off) {\n\t\tif (fw_ver >= 0x180000) {\n\t\t\t \n\t\t\th2c_parameter[0] = 1;\n\t\t\tbtcoexist->btc_fill_h2c(btcoexist, 0x6E, 1,\n\t\t\t\t\t\th2c_parameter);\n\t\t} else {\n\t\t\t \n\t\t\tbtcoexist->btc_write_1byte(btcoexist, 0x765, 0x18);\n\t\t}\n\t\t \n\t\tbtcoexist->btc_write_1byte(btcoexist, 0x76e, 0x4);\n\n\t\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_IS_IN_MP_MODE,\n\t\t\t\t   &is_in_mp_mode);\n\t\tif (!is_in_mp_mode)\n\t\t\t \n\t\t\tbtcoexist->btc_write_1byte_bitmask(btcoexist, 0x67,\n\t\t\t\t\t\t\t   0x20, 0x0);\n\t\telse\n\t\t\t \n\t\t\tbtcoexist->btc_write_1byte_bitmask(btcoexist, 0x67,\n\t\t\t\t\t\t\t   0x20, 0x1);\n\n\t\t \n\t\tu32tmp = btcoexist->btc_read_4byte(btcoexist, 0x4c);\n\t\tu32tmp &= ~BIT23;\n\t\tu32tmp &= ~BIT24;\n\t\tbtcoexist->btc_write_4byte(btcoexist, 0x4c, u32tmp);\n\t} else {\n\t\t \n\t\tif (fw_ver >= 0x180000) {\n\t\t\tif (btcoexist->btc_read_1byte(btcoexist, 0x765) != 0) {\n\t\t\t\th2c_parameter[0] = 0;\n\t\t\t\tbtcoexist->btc_fill_h2c(btcoexist, 0x6E, 1,\n\t\t\t\t\t\t\th2c_parameter);\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\twhile (cnt_bt_cal_chk <= 20) {\n\t\t\t\tu8tmp = btcoexist->btc_read_1byte(btcoexist,\n\t\t\t\t\t\t\t\t  0x49d);\n\t\t\t\tcnt_bt_cal_chk++;\n\t\t\t\tif (u8tmp & BIT(0)) {\n\t\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST,\n\t\t\t\t\t\tDBG_LOUD,\n\t\t\t\t\t\t\"[BTCoex], ########### BT is calibrating (wait cnt=%d) ###########\\n\",\n\t\t\t\t\t\tcnt_bt_cal_chk);\n\t\t\t\t\tmdelay(50);\n\t\t\t\t} else {\n\t\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST,\n\t\t\t\t\t\tDBG_LOUD,\n\t\t\t\t\t\t\"[BTCoex], ********** BT is NOT calibrating (wait cnt=%d)**********\\n\",\n\t\t\t\t\t\tcnt_bt_cal_chk);\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t \n\t\t\tbtcoexist->btc_write_1byte(btcoexist, 0x765, 0x0);\n\t\t}\n\n\t\tif (btcoexist->btc_read_1byte(btcoexist, 0x76e) != 0xc) {\n\t\t\t \n\t\t\tbtcoexist->btc_write_1byte(btcoexist, 0x76e, 0xc);\n\t\t}\n\n\t\tbtcoexist->btc_write_1byte_bitmask(\n\t\t\tbtcoexist, 0x67, 0x20,\n\t\t\t0x1);  \n\t}\n\n\tif (use_ext_switch) {\n\t\tif (init_hw_cfg) {\n\t\t\t \n\t\t\tu32tmp = btcoexist->btc_read_4byte(btcoexist, 0x4c);\n\t\t\tu32tmp &= ~BIT23;\n\t\t\tu32tmp |= BIT24;\n\t\t\tbtcoexist->btc_write_4byte(btcoexist, 0x4c, u32tmp);\n\n\t\t\t \n\t\t\tbtcoexist->btc_write_4byte(btcoexist, 0x948, 0x0);\n\n\t\t\tif (board_info->btdm_ant_pos ==\n\t\t\t    BTC_ANTENNA_AT_MAIN_PORT) {\n\t\t\t\t \n\t\t\t\th2c_parameter[0] = 0;\n\t\t\t\t \n\t\t\t\th2c_parameter[1] = 1;\n\t\t\t\tbtcoexist->btc_fill_h2c(btcoexist, 0x65, 2,\n\t\t\t\t\t\t\th2c_parameter);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\th2c_parameter[0] = 1;\n\t\t\t\t \n\t\t\t\th2c_parameter[1] = 1;\n\t\t\t\tbtcoexist->btc_fill_h2c(btcoexist, 0x65, 2,\n\t\t\t\t\t\t\th2c_parameter);\n\t\t\t}\n\t\t}\n\n\t\tif (force_exec ||\n\t\t    (coex_dm->cur_ant_pos_type != coex_dm->pre_ant_pos_type)) {\n\t\t\t \n\t\t\tswitch (ant_pos_type) {\n\t\t\tcase BTC_ANT_PATH_WIFI:\n\t\t\t\tif (board_info->btdm_ant_pos ==\n\t\t\t\t    BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\t\tbtcoexist->btc_write_1byte_bitmask(\n\t\t\t\t\t\tbtcoexist, 0x92c, 0x3, 0x1);\n\t\t\t\telse\n\t\t\t\t\tbtcoexist->btc_write_1byte_bitmask(\n\t\t\t\t\t\tbtcoexist, 0x92c, 0x3, 0x2);\n\t\t\t\tbreak;\n\t\t\tcase BTC_ANT_PATH_BT:\n\t\t\t\tif (board_info->btdm_ant_pos ==\n\t\t\t\t    BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\t\tbtcoexist->btc_write_1byte_bitmask(\n\t\t\t\t\t\tbtcoexist, 0x92c, 0x3, 0x2);\n\t\t\t\telse\n\t\t\t\t\tbtcoexist->btc_write_1byte_bitmask(\n\t\t\t\t\t\tbtcoexist, 0x92c, 0x3, 0x1);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\tcase BTC_ANT_PATH_PTA:\n\t\t\t\tif (board_info->btdm_ant_pos ==\n\t\t\t\t    BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\t\tbtcoexist->btc_write_1byte_bitmask(\n\t\t\t\t\t\tbtcoexist, 0x92c, 0x3, 0x1);\n\t\t\t\telse\n\t\t\t\t\tbtcoexist->btc_write_1byte_bitmask(\n\t\t\t\t\t\tbtcoexist, 0x92c, 0x3, 0x2);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t} else {\n\t\tif (init_hw_cfg) {\n\t\t\t \n\t\t\tu32tmp = btcoexist->btc_read_4byte(btcoexist, 0x4c);\n\t\t\tu32tmp |= BIT23;\n\t\t\tu32tmp &= ~BIT24;\n\t\t\tbtcoexist->btc_write_4byte(btcoexist, 0x4c, u32tmp);\n\n\t\t\t \n\t\t\tbtcoexist->btc_write_1byte_bitmask(btcoexist, 0x64, 0x1,\n\t\t\t\t\t\t\t   0x0);\n\n\t\t\tif (board_info->btdm_ant_pos ==\n\t\t\t    BTC_ANTENNA_AT_MAIN_PORT) {\n\t\t\t\t \n\t\t\t\th2c_parameter[0] = 0;\n\t\t\t\t \n\t\t\t\th2c_parameter[1] = 0;\n\t\t\t\tbtcoexist->btc_fill_h2c(btcoexist, 0x65, 2,\n\t\t\t\t\t\t\th2c_parameter);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\th2c_parameter[0] = 1;\n\t\t\t\t \n\t\t\t\th2c_parameter[1] = 0;\n\t\t\t\tbtcoexist->btc_fill_h2c(btcoexist, 0x65, 2,\n\t\t\t\t\t\t\th2c_parameter);\n\t\t\t}\n\t\t}\n\n\t\tif (force_exec ||\n\t\t    (coex_dm->cur_ant_pos_type != coex_dm->pre_ant_pos_type)) {\n\t\t\t \n\t\t\tswitch (ant_pos_type) {\n\t\t\tcase BTC_ANT_PATH_WIFI:\n\t\t\t\tif (board_info->btdm_ant_pos ==\n\t\t\t\t    BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\t\tbtcoexist->btc_write_4byte(btcoexist,\n\t\t\t\t\t\t\t0x948, 0x0);\n\t\t\t\telse\n\t\t\t\t\tbtcoexist->btc_write_4byte(btcoexist,\n\t\t\t\t\t\t\t0x948, 0x280);\n\t\t\t\tbreak;\n\t\t\tcase BTC_ANT_PATH_BT:\n\t\t\t\tif (board_info->btdm_ant_pos ==\n\t\t\t\t    BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\t\tbtcoexist->btc_write_4byte(btcoexist,\n\t\t\t\t\t\t\t0x948, 0x280);\n\t\t\t\telse\n\t\t\t\t\tbtcoexist->btc_write_4byte(btcoexist,\n\t\t\t\t\t\t\t0x948, 0x0);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\tcase BTC_ANT_PATH_PTA:\n\t\t\t\tif (board_info->btdm_ant_pos ==\n\t\t\t\t    BTC_ANTENNA_AT_MAIN_PORT)\n\t\t\t\t\tbtcoexist->btc_write_4byte(btcoexist,\n\t\t\t\t\t\t\t0x948, 0x200);\n\t\t\t\telse\n\t\t\t\t\tbtcoexist->btc_write_4byte(btcoexist,\n\t\t\t\t\t\t\t0x948, 0x80);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\n\tcoex_dm->pre_ant_pos_type = coex_dm->cur_ant_pos_type;\n}\n\nstatic void halbtc8723b1ant_ps_tdma(struct btc_coexist *btcoexist,\n\t\t\t\t    bool force_exec, bool turn_on, u8 type)\n{\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\tbool wifi_busy = false;\n\tu8 rssi_adjust_val = 0;\n\tu8 ps_tdma_byte0_val = 0x51;\n\tu8 ps_tdma_byte3_val = 0x10;\n\tu8 ps_tdma_byte4_val = 0x50;\n\ts8 wifi_duration_adjust = 0x0;\n\tstatic bool pre_wifi_busy;\n\n\tcoex_dm->cur_ps_tdma_on = turn_on;\n\tcoex_dm->cur_ps_tdma = type;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\n\n\tif (wifi_busy != pre_wifi_busy) {\n\t\tforce_exec = true;\n\t\tpre_wifi_busy = wifi_busy;\n\t}\n\n\tif (!force_exec) {\n\t\tif ((coex_dm->pre_ps_tdma_on == coex_dm->cur_ps_tdma_on) &&\n\t\t    (coex_dm->pre_ps_tdma == coex_dm->cur_ps_tdma))\n\t\t\treturn;\n\t}\n\n\tif (coex_sta->scan_ap_num <= 5) {\n\t\twifi_duration_adjust = 5;\n\n\t\tif (coex_sta->a2dp_bit_pool >= 35)\n\t\t\twifi_duration_adjust = -10;\n\t\telse if (coex_sta->a2dp_bit_pool >= 45)\n\t\t\twifi_duration_adjust = -15;\n\t} else if (coex_sta->scan_ap_num >= 40) {\n\t\twifi_duration_adjust = -15;\n\n\t\tif (coex_sta->a2dp_bit_pool < 35)\n\t\t\twifi_duration_adjust = -5;\n\t\telse if (coex_sta->a2dp_bit_pool < 45)\n\t\t\twifi_duration_adjust = -10;\n\t} else if (coex_sta->scan_ap_num >= 20) {\n\t\twifi_duration_adjust = -10;\n\n\t\tif (coex_sta->a2dp_bit_pool >= 45)\n\t\t\twifi_duration_adjust = -15;\n\t} else {\n\t\twifi_duration_adjust = 0;\n\n\t\tif (coex_sta->a2dp_bit_pool >= 35)\n\t\t\twifi_duration_adjust = -10;\n\t\telse if (coex_sta->a2dp_bit_pool >= 45)\n\t\t\twifi_duration_adjust = -15;\n\t}\n\n\tif ((type == 1) || (type == 2) || (type == 9) || (type == 11) ||\n\t    (type == 101) || (type == 102) || (type == 109) || (type == 111)) {\n\t\tif (!coex_sta->force_lps_on) {\n\t\t\t \n\n\t\t\t \n\t\t\tps_tdma_byte0_val = 0x61;\n\t\t\t \n\t\t\tps_tdma_byte3_val = 0x11;\n\t\t\t \n\t\t\tps_tdma_byte4_val = 0x10;\n\t\t} else {\n\t\t\t \n\t\t\tps_tdma_byte0_val = 0x51;\n\t\t\t \n\t\t\tps_tdma_byte3_val = 0x10;\n\t\t\t \n\t\t\tps_tdma_byte4_val = 0x50;\n\t\t}\n\t} else if ((type == 3) || (type == 13) || (type == 14) ||\n\t\t   (type == 103) || (type == 113) || (type == 114)) {\n\t\t \n\t\tps_tdma_byte0_val = 0x51;\n\t\t \n\t\tps_tdma_byte3_val = 0x10;\n\t\t \n\t\tps_tdma_byte4_val = 0x10;\n\t} else {  \n\t\t \n\t\tps_tdma_byte0_val = 0x61;\n\t\t \n\t\tps_tdma_byte3_val = 0x11;\n\t\t \n\t\tps_tdma_byte4_val = 0x11;\n\t\t \n\t}\n\n\t \n\tif ((bt_link_info->slave_role) && (bt_link_info->a2dp_exist))\n\t\t \n\t\tps_tdma_byte4_val = ps_tdma_byte4_val | 0x1;\n\n\tif (type > 100) {\n\t\t \n\t\tps_tdma_byte0_val = ps_tdma_byte0_val | 0x82;\n\t\t \n\t\tps_tdma_byte3_val = ps_tdma_byte3_val | 0x60;\n\t}\n\n\tif (turn_on) {\n\t\tswitch (type) {\n\t\tdefault:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x51, 0x1a,\n\t\t\t\t\t\t      0x1a, 0x0,\n\t\t\t\t\t\t      ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 1:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val,\n\t\t\t\t0x3a + wifi_duration_adjust, 0x03,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\n\t\t\trssi_adjust_val = 11;\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val,\n\t\t\t\t0x2d + wifi_duration_adjust, 0x03,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 3:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x30, 0x03,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x93, 0x15,\n\t\t\t\t\t\t      0x3, 0x14, 0x0);\n\t\t\tbreak;\n\t\tcase 5:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x1f, 0x3,\n\t\t\t\tps_tdma_byte3_val, 0x11);\n\t\t\tbreak;\n\t\tcase 6:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x20, 0x3,\n\t\t\t\tps_tdma_byte3_val, 0x11);\n\t\t\tbreak;\n\t\tcase 7:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x13, 0xc,\n\t\t\t\t\t\t       0x5, 0x0, 0x0);\n\t\t\tbreak;\n\t\tcase 8:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x93, 0x25,\n\t\t\t\t\t\t      0x3, 0x10, 0x0);\n\t\t\tbreak;\n\t\tcase 9:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x21, 0x3,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 10:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x13, 0xa,\n\t\t\t\t\t\t       0xa, 0x0, 0x40);\n\t\t\tbreak;\n\t\tcase 11:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x21, 0x03,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 12:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x51, 0x0a,\n\t\t\t\t\t\t      0x0a, 0x0, 0x50);\n\t\t\tbreak;\n\t\tcase 13:\n\t\t\tif (coex_sta->scan_ap_num <= 3)\n\t\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x40, 0x3,\n\t\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\telse\n\t\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x21, 0x3,\n\t\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 14:\n\t\t\tif (coex_sta->scan_ap_num <= 3)\n\t\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\t\tbtcoexist, 0x51, 0x30, 0x3, 0x10, 0x50);\n\t\t\telse\n\t\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x21, 0x3,\n\t\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 15:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x13, 0xa,\n\t\t\t\t\t\t       0x3, 0x8, 0x0);\n\t\t\tbreak;\n\t\tcase 16:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x93, 0x15,\n\t\t\t\t\t\t      0x3, 0x10, 0x0);\n\t\t\tbreak;\n\t\tcase 18:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x93, 0x25,\n\t\t\t\t\t\t      0x3, 0x10, 0x0);\n\t\t\tbreak;\n\t\tcase 20:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x3f, 0x03,\n\t\t\t\tps_tdma_byte3_val, 0x10);\n\t\t\tbreak;\n\t\tcase 21:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x61, 0x25,\n\t\t\t\t\t\t      0x03, 0x11, 0x11);\n\t\t\tbreak;\n\t\tcase 22:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x25, 0x03,\n\t\t\t\tps_tdma_byte3_val, 0x10);\n\t\t\tbreak;\n\t\tcase 23:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0xe3, 0x25,\n\t\t\t\t\t\t      0x3, 0x31, 0x18);\n\t\t\tbreak;\n\t\tcase 24:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0xe3, 0x15,\n\t\t\t\t\t\t      0x3, 0x31, 0x18);\n\t\t\tbreak;\n\t\tcase 25:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0xe3, 0xa,\n\t\t\t\t\t\t       0x3, 0x31, 0x18);\n\t\t\tbreak;\n\t\tcase 26:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0xe3, 0xa,\n\t\t\t\t\t\t       0x3, 0x31, 0x18);\n\t\t\tbreak;\n\t\tcase 27:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0xe3, 0x25,\n\t\t\t\t\t\t      0x3, 0x31, 0x98);\n\t\t\tbreak;\n\t\tcase 28:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x69, 0x25,\n\t\t\t\t\t\t      0x3, 0x31, 0x0);\n\t\t\tbreak;\n\t\tcase 29:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0xab, 0x1a,\n\t\t\t\t\t\t      0x1a, 0x1, 0x10);\n\t\t\tbreak;\n\t\tcase 30:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x51, 0x30,\n\t\t\t\t\t\t       0x3, 0x10, 0x10);\n\t\t\tbreak;\n\t\tcase 31:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0xd3, 0x1a,\n\t\t\t\t\t\t      0x1a, 0, 0x58);\n\t\t\tbreak;\n\t\tcase 32:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x35, 0x3,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 33:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x35, 0x3,\n\t\t\t\tps_tdma_byte3_val, 0x10);\n\t\t\tbreak;\n\t\tcase 34:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x53, 0x1a,\n\t\t\t\t\t\t      0x1a, 0x0, 0x10);\n\t\t\tbreak;\n\t\tcase 35:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x63, 0x1a,\n\t\t\t\t\t\t      0x1a, 0x0, 0x10);\n\t\t\tbreak;\n\t\tcase 36:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0xd3, 0x12,\n\t\t\t\t\t\t      0x3, 0x14, 0x50);\n\t\t\tbreak;\n\t\tcase 40:\n\t\t\t \n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x23, 0x18,\n\t\t\t\t\t\t      0x00, 0x10, 0x24);\n\t\t\tbreak;\n\n\t\tcase 101:\n\t\t\t \n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val,\n\t\t\t\t0x3a + wifi_duration_adjust, 0x03,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 102:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val,\n\t\t\t\t0x2d + wifi_duration_adjust, 0x03,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 103:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x3a, 0x03,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 105:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x15, 0x3,\n\t\t\t\tps_tdma_byte3_val, 0x11);\n\t\t\tbreak;\n\t\tcase 106:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x20, 0x3,\n\t\t\t\tps_tdma_byte3_val, 0x11);\n\t\t\tbreak;\n\t\tcase 109:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x21, 0x3,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 111:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x21, 0x03,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 113:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x21, 0x3,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 114:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x21, 0x3,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 120:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x3f, 0x03,\n\t\t\t\tps_tdma_byte3_val, 0x10);\n\t\t\tbreak;\n\t\tcase 122:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x25, 0x03,\n\t\t\t\tps_tdma_byte3_val, 0x10);\n\t\t\tbreak;\n\t\tcase 132:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x25, 0x03,\n\t\t\t\tps_tdma_byte3_val, ps_tdma_byte4_val);\n\t\t\tbreak;\n\t\tcase 133:\n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(\n\t\t\t\tbtcoexist, ps_tdma_byte0_val, 0x25, 0x03,\n\t\t\t\tps_tdma_byte3_val, 0x11);\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\t \n\t\tswitch (type) {\n\t\tcase 8:  \n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x8, 0x0,\n\t\t\t\t\t\t       0x0, 0x0, 0x0);\n\t\t\thalbtc8723b1ant_set_ant_path(btcoexist,\n\t\t\t\t\t\t     BTC_ANT_PATH_PTA,\n\t\t\t\t\t\t     FORCE_EXEC,\n\t\t\t\t\t\t     false, false);\n\t\t\tbreak;\n\t\tcase 0:\n\t\tdefault:\n\t\t\t \n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x0, 0x0,\n\t\t\t\t\t\t       0x0, 0x0, 0x0);\n\t\t\tbreak;\n\t\tcase 1:  \n\t\t\thalbtc8723b1ant_set_fw_ps_tdma(btcoexist, 0x0, 0x0, 0x0,\n\t\t\t\t\t\t       0x48, 0x0);\n\t\t\tbreak;\n\t\t}\n\t}\n\trssi_adjust_val = 0;\n\tbtcoexist->btc_set(btcoexist,\n\t\t\t   BTC_SET_U1_RSSI_ADJ_VAL_FOR_1ANT_COEX_TYPE,\n\t\t\t   &rssi_adjust_val);\n\n\t \n\tcoex_dm->pre_ps_tdma_on = coex_dm->cur_ps_tdma_on;\n\tcoex_dm->pre_ps_tdma = coex_dm->cur_ps_tdma;\n}\n\nstatic\nvoid btc8723b1ant_tdma_dur_adj_for_acl(struct btc_coexist *btcoexist,\n\t\t\t\t       u8 wifi_status)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tstatic s32 up, dn, m, n, wait_count;\n\t \n\ts32 result;\n\tu8 retry_count = 0;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], TdmaDurationAdjustForAcl()\\n\");\n\n\tif ((wifi_status ==\n\t     BT_8723B_1ANT_WIFI_STATUS_NON_CONNECTED_ASSO_AUTH_SCAN) ||\n\t    (wifi_status == BT_8723B_1ANT_WIFI_STATUS_CONNECTED_SCAN) ||\n\t    (wifi_status == BT_8723B_1ANT_WIFI_STATUS_CONNECTED_SPECIAL_PKT)) {\n\t\tif (coex_dm->cur_ps_tdma != 1 && coex_dm->cur_ps_tdma != 2 &&\n\t\t    coex_dm->cur_ps_tdma != 3 && coex_dm->cur_ps_tdma != 9) {\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\ttrue, 9);\n\t\t\tcoex_dm->ps_tdma_du_adj_type = 9;\n\n\t\t\tup = 0;\n\t\t\tdn = 0;\n\t\t\tm = 1;\n\t\t\tn = 3;\n\t\t\tresult = 0;\n\t\t\twait_count = 0;\n\t\t}\n\t\treturn;\n\t}\n\n\tif (!coex_dm->auto_tdma_adjust) {\n\t\tcoex_dm->auto_tdma_adjust = true;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], first run TdmaDurationAdjust()!!\\n\");\n\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 2);\n\t\tcoex_dm->ps_tdma_du_adj_type = 2;\n\n\t\tup = 0;\n\t\tdn = 0;\n\t\tm = 1;\n\t\tn = 3;\n\t\tresult = 0;\n\t\twait_count = 0;\n\t} else {\n\t\t \n\t\tretry_count = coex_sta->bt_retry_cnt;\n\n\t\tif ((coex_sta->low_priority_tx) > 1050 ||\n\t\t    (coex_sta->low_priority_rx) > 1250)\n\t\t\tretry_count++;\n\n\t\tresult = 0;\n\t\twait_count++;\n\t\t \n\t\tif (retry_count == 0) {\n\t\t\tup++;\n\t\t\tdn--;\n\n\t\t\tif (dn <= 0)\n\t\t\t\tdn = 0;\n\n\t\t\tif (up >= n) {\n\t\t\t\t \n\t\t\t\twait_count = 0;\n\t\t\t\tn = 3;\n\t\t\t\tup = 0;\n\t\t\t\tdn = 0;\n\t\t\t\tresult = 1;\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\t\"[BTCoex], Increase wifi duration!!\\n\");\n\t\t\t}\n\t\t} else if (retry_count <= 3) {\n\t\t\t \n\t\t\tup--;\n\t\t\tdn++;\n\n\t\t\tif (up <= 0)\n\t\t\t\tup = 0;\n\n\t\t\tif (dn == 2) {\n\t\t\t\t \n\t\t\t\tif (wait_count <= 2)\n\t\t\t\t\t \n\t\t\t\t\tm++;\n\t\t\t\telse\n\t\t\t\t\tm = 1;\n\n\t\t\t\tif (m >= 20)\n\t\t\t\t\t \n\t\t\t\t\tm = 20;\n\n\t\t\t\tn = 3 * m;\n\t\t\t\tup = 0;\n\t\t\t\tdn = 0;\n\t\t\t\twait_count = 0;\n\t\t\t\tresult = -1;\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\t\"[BTCoex], Decrease wifi duration for retryCounter<3!!\\n\");\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t\tif (wait_count == 1)\n\t\t\t\t \n\t\t\t\tm++;\n\t\t\telse\n\t\t\t\tm = 1;\n\n\t\t\tif (m >= 20)\n\t\t\t\t \n\t\t\t\tm = 20;\n\n\t\t\tn = 3 * m;\n\t\t\tup = 0;\n\t\t\tdn = 0;\n\t\t\twait_count = 0;\n\t\t\tresult = -1;\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\"[BTCoex], Decrease wifi duration for retryCounter>3!!\\n\");\n\t\t}\n\n\t\tif (result == -1) {\n\t\t\tif (coex_dm->cur_ps_tdma == 1) {\n\t\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\t\ttrue, 2);\n\t\t\t\tcoex_dm->ps_tdma_du_adj_type = 2;\n\t\t\t} else if (coex_dm->cur_ps_tdma == 2) {\n\t\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\t\ttrue, 9);\n\t\t\t\tcoex_dm->ps_tdma_du_adj_type = 9;\n\t\t\t} else if (coex_dm->cur_ps_tdma == 9) {\n\t\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\t\ttrue, 11);\n\t\t\t\tcoex_dm->ps_tdma_du_adj_type = 11;\n\t\t\t}\n\t\t} else if (result == 1) {\n\t\t\tif (coex_dm->cur_ps_tdma == 11) {\n\t\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\t\ttrue, 9);\n\t\t\t\tcoex_dm->ps_tdma_du_adj_type = 9;\n\t\t\t} else if (coex_dm->cur_ps_tdma == 9) {\n\t\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\t\ttrue, 2);\n\t\t\t\tcoex_dm->ps_tdma_du_adj_type = 2;\n\t\t\t} else if (coex_dm->cur_ps_tdma == 2) {\n\t\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\t\ttrue, 1);\n\t\t\t\tcoex_dm->ps_tdma_du_adj_type = 1;\n\t\t\t}\n\t\t}\n\n\t\tif (coex_dm->cur_ps_tdma != 1 && coex_dm->cur_ps_tdma != 2 &&\n\t\t    coex_dm->cur_ps_tdma != 9 && coex_dm->cur_ps_tdma != 11) {\n\t\t\t \n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true,\n\t\t\t\t\t\tcoex_dm->ps_tdma_du_adj_type);\n\t\t}\n\t}\n}\n\nstatic void halbtc8723b1ant_ps_tdma_chk_pwr_save(struct btc_coexist *btcoexist,\n\t\t\t\t\t  bool new_ps_state)\n{\n\tu8 lps_mode = 0x0;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U1_LPS_MODE, &lps_mode);\n\n\tif (lps_mode) {\n\t\t \n\t\tif (new_ps_state) {\n\t\t\t \n\t\t} else {\n\t\t\t \n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\tfalse, 0);\n\t\t}\n\t} else {\n\t\t \n\t\tif (new_ps_state) {\n\t\t\t \n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\tfalse, 0);\n\t\t} else {\n\t\t\t \n\t\t}\n\t}\n}\n\nstatic void halbtc8723b1ant_power_save_state(struct btc_coexist *btcoexist,\n\t\t\t\t\t     u8 ps_type, u8 lps_val,\n\t\t\t\t\t     u8 rpwm_val)\n{\n\tbool low_pwr_disable = false;\n\n\tswitch (ps_type) {\n\tcase BTC_PS_WIFI_NATIVE:\n\t\t \n\t\tlow_pwr_disable = false;\n\t\tbtcoexist->btc_set(btcoexist, BTC_SET_ACT_DISABLE_LOW_POWER,\n\t\t\t\t   &low_pwr_disable);\n\t\tbtcoexist->btc_set(btcoexist, BTC_SET_ACT_NORMAL_LPS, NULL);\n\t\tcoex_sta->force_lps_on = false;\n\t\tbreak;\n\tcase BTC_PS_LPS_ON:\n\t\thalbtc8723b1ant_ps_tdma_chk_pwr_save(btcoexist, true);\n\t\thalbtc8723b1ant_lps_rpwm(btcoexist, NORMAL_EXEC, lps_val,\n\t\t\t\t\t rpwm_val);\n\t\t \n\t\tlow_pwr_disable = true;\n\t\tbtcoexist->btc_set(btcoexist, BTC_SET_ACT_DISABLE_LOW_POWER,\n\t\t\t\t   &low_pwr_disable);\n\t\t \n\t\tbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ENTER_LPS, NULL);\n\t\tcoex_sta->force_lps_on = true;\n\t\tbreak;\n\tcase BTC_PS_LPS_OFF:\n\t\thalbtc8723b1ant_ps_tdma_chk_pwr_save(btcoexist, false);\n\t\tbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\n\t\tcoex_sta->force_lps_on = false;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nstatic void halbtc8723b1ant_action_wifi_only(struct btc_coexist *btcoexist)\n{\n\thalbtc8723b1ant_coex_table_with_type(btcoexist, FORCE_EXEC, 0);\n\thalbtc8723b1ant_ps_tdma(btcoexist, FORCE_EXEC, false, 8);\n\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA,\n\t\t\t\t     FORCE_EXEC, false, false);\n}\n\n \nstatic void halbtc8723b1ant_monitor_bt_enable_disable(struct btc_coexist\n\t\t\t\t\t\t      *btcoexist)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tstatic u32 bt_disable_cnt;\n\tbool bt_active = true, bt_disabled = false;\n\n\tif (coex_sta->high_priority_tx == 0 &&\n\t    coex_sta->high_priority_rx == 0 && coex_sta->low_priority_tx == 0 &&\n\t    coex_sta->low_priority_rx == 0)\n\t\tbt_active = false;\n\tif (coex_sta->high_priority_tx == 0xffff &&\n\t    coex_sta->high_priority_rx == 0xffff &&\n\t    coex_sta->low_priority_tx == 0xffff &&\n\t    coex_sta->low_priority_rx == 0xffff)\n\t\tbt_active = false;\n\tif (bt_active) {\n\t\tbt_disable_cnt = 0;\n\t\tbt_disabled = false;\n\t} else {\n\t\tbt_disable_cnt++;\n\t\tif (bt_disable_cnt >= 2)\n\t\t\tbt_disabled = true;\n\t}\n\tif (coex_sta->bt_disabled != bt_disabled) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], BT is from %s to %s!!\\n\",\n\t\t\t(coex_sta->bt_disabled ? \"disabled\" : \"enabled\"),\n\t\t\t(bt_disabled ? \"disabled\" : \"enabled\"));\n\n\t\tcoex_sta->bt_disabled = bt_disabled;\n\t\tbtcoexist->btc_set(btcoexist, BTC_SET_BL_BT_DISABLE,\n\t\t\t\t   &bt_disabled);\n\t\tif (bt_disabled) {\n\t\t\thalbtc8723b1ant_action_wifi_only(btcoexist);\n\t\t\tbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS,\n\t\t\t\t\t   NULL);\n\t\t\tbtcoexist->btc_set(btcoexist, BTC_SET_ACT_NORMAL_LPS,\n\t\t\t\t\t   NULL);\n\t\t}\n\t}\n}\n\n \n\nstatic void halbtc8723b1ant_action_bt_whck_test(struct btc_coexist *btcoexist)\n{\n\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE, 0x0,\n\t\t\t\t\t 0x0);\n\n\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, false, 8);\n\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA, NORMAL_EXEC,\n\t\t\t\t     false, false);\n\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 0);\n}\n\nstatic void halbtc8723b1ant_action_wifi_multiport(struct btc_coexist *btcoexist)\n{\n\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t 0x0, 0x0);\n\n\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, false, 8);\n\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA, NORMAL_EXEC,\n\t\t\t\t     false, false);\n\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 2);\n}\n\nstatic void halbtc8723b1ant_action_hs(struct btc_coexist *btcoexist)\n{\n\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 5);\n\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 2);\n}\n\nstatic void halbtc8723b1ant_action_bt_inquiry(struct btc_coexist *btcoexist)\n{\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\tbool wifi_connected = false, ap_enable = false;\n\tbool wifi_busy = false, bt_busy = false;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_AP_MODE_ENABLE,\n\t\t\t   &ap_enable);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED,\n\t\t\t   &wifi_connected);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\n\tbtcoexist->btc_set(btcoexist, BTC_SET_BL_BT_TRAFFIC_BUSY, &bt_busy);\n\n\tif (coex_sta->bt_abnormal_scan) {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 33);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 7);\n\t} else if (!wifi_connected && !coex_sta->wifi_is_high_pri_task) {\n\t\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t\t 0x0, 0x0);\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, false, 8);\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA,\n\t\t\t\t\t     NORMAL_EXEC, false, false);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 0);\n\t} else if (bt_link_info->sco_exist || bt_link_info->hid_exist ||\n\t\t   bt_link_info->a2dp_exist) {\n\t\t \n\t\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t\t 0x0, 0x0);\n\t\tif (coex_sta->c2h_bt_remote_name_req)\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true,\n\t\t\t\t\t\t33);\n\t\telse\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true,\n\t\t\t\t\t\t32);\n\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 4);\n\t} else if (bt_link_info->pan_exist || wifi_busy) {\n\t\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t\t 0x0, 0x0);\n\t\tif (coex_sta->c2h_bt_remote_name_req)\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true,\n\t\t\t\t\t\t33);\n\t\telse\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true,\n\t\t\t\t\t\t32);\n\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 4);\n\t} else {\n\t\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t\t 0x0, 0x0);\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, false, 8);\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA,\n\t\t\t\t\t     NORMAL_EXEC, false, false);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 7);\n\t}\n}\n\nstatic void btc8723b1ant_act_bt_sco_hid_only_busy(struct btc_coexist *btcoexist,\n\t\t\t\t\t\t  u8 wifi_status)\n{\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\tbool wifi_connected = false;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED,\n\t\t\t   &wifi_connected);\n\n\t \n\tif (bt_link_info->sco_exist) {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 5);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 5);\n\t} else {\n\t\t \n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 6);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 5);\n\t}\n}\n\nstatic void halbtc8723b1ant_action_wifi_connected_bt_acl_busy(\n\t\t\t\t\tstruct btc_coexist *btcoexist,\n\t\t\t\t\tu8 wifi_status)\n{\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\n\tif ((coex_sta->low_priority_rx >= 950) && (!coex_sta->under_ips))\n\t\tbt_link_info->slave_role = true;\n\telse\n\t\tbt_link_info->slave_role = false;\n\n\tif (bt_link_info->hid_only) {  \n\t\tbtc8723b1ant_act_bt_sco_hid_only_busy(btcoexist, wifi_status);\n\t\tcoex_dm->auto_tdma_adjust = false;\n\t\treturn;\n\t} else if (bt_link_info->a2dp_only) {  \n\t\tif (wifi_status == BT_8723B_1ANT_WIFI_STATUS_CONNECTED_IDLE) {\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\ttrue, 32);\n\t\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t\t     NORMAL_EXEC, 4);\n\t\t\tcoex_dm->auto_tdma_adjust = false;\n\t\t} else {\n\t\t\tbtc8723b1ant_tdma_dur_adj_for_acl(btcoexist,\n\t\t\t\t\t\t\t  wifi_status);\n\t\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t\t     NORMAL_EXEC, 1);\n\t\t\tcoex_dm->auto_tdma_adjust = true;\n\t\t}\n\t} else if (((bt_link_info->a2dp_exist) && (bt_link_info->pan_exist)) ||\n\t\t   (bt_link_info->hid_exist && bt_link_info->a2dp_exist &&\n\t\t    bt_link_info->pan_exist)) {\n\t\t \n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 13);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 4);\n\t\tcoex_dm->auto_tdma_adjust = false;\n\t} else if (bt_link_info->hid_exist && bt_link_info->a2dp_exist) {\n\t\t \n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\ttrue, 14);\n\t\tcoex_dm->auto_tdma_adjust = false;\n\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 4);\n\t} else if (bt_link_info->pan_only ||\n\t\t\t(bt_link_info->hid_exist && bt_link_info->pan_exist)) {\n\t\t \n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 3);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 4);\n\t\tcoex_dm->auto_tdma_adjust = false;\n\t} else {\n\t\t \n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 33);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 4);\n\t\tcoex_dm->auto_tdma_adjust = false;\n\t}\n}\n\nstatic void btc8723b1ant_action_wifi_not_conn(struct btc_coexist *btcoexist)\n{\n\t \n\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t 0x0, 0x0);\n\n\t \n\thalbtc8723b1ant_ps_tdma(btcoexist, FORCE_EXEC, false, 8);\n\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA, NORMAL_EXEC,\n\t\t\t\t     false, false);\n\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 0);\n}\n\nstatic void\nbtc8723b1ant_action_wifi_not_conn_scan(struct btc_coexist *btcoexist)\n{\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\n\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t 0x0, 0x0);\n\n\t \n\tif (coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) {\n\t\tif (bt_link_info->a2dp_exist) {\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\ttrue, 32);\n\t\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t\t     NORMAL_EXEC, 4);\n\t\t} else if (bt_link_info->pan_exist) {\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\ttrue, 22);\n\t\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t\t     NORMAL_EXEC, 4);\n\t\t} else {\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\ttrue, 20);\n\t\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t\t     NORMAL_EXEC, 1);\n\t\t}\n\t} else if (coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_SCO_BUSY ||\n\t\t   coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY){\n\t\tbtc8723b1ant_act_bt_sco_hid_only_busy(btcoexist,\n\t\t\t\tBT_8723B_1ANT_WIFI_STATUS_CONNECTED_SCAN);\n\t} else {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, false, 8);\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA,\n\t\t\t\t\t     NORMAL_EXEC, false, false);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 2);\n\t}\n}\n\nstatic void\nbtc8723b1ant_act_wifi_not_conn_asso_auth(struct btc_coexist *btcoexist)\n{\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\n\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t 0x0, 0x0);\n\n\t \n\tif ((bt_link_info->sco_exist) || (bt_link_info->hid_exist) ||\n\t    (bt_link_info->a2dp_exist)) {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 32);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, FORCE_EXEC, 4);\n\t} else if (bt_link_info->pan_exist) {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 20);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, FORCE_EXEC, 4);\n\t} else {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, false, 8);\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA,\n\t\t\t\t\t     NORMAL_EXEC, false, false);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, FORCE_EXEC, 2);\n\t}\n}\n\nstatic void btc8723b1ant_action_wifi_conn_scan(struct btc_coexist *btcoexist)\n{\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\n\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t 0x0, 0x0);\n\n\t \n\tif (coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) {\n\t\tif (bt_link_info->a2dp_exist) {\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\ttrue, 32);\n\t\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t\t     NORMAL_EXEC, 4);\n\t\t} else if (bt_link_info->pan_exist) {\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\ttrue, 22);\n\t\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t\t     NORMAL_EXEC, 4);\n\t\t} else {\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\ttrue, 20);\n\t\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t\t     NORMAL_EXEC, 4);\n\t\t}\n\t} else if (coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_SCO_BUSY ||\n\t\t   coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY) {\n\t\tbtc8723b1ant_act_bt_sco_hid_only_busy(btcoexist,\n\t\t\t\tBT_8723B_1ANT_WIFI_STATUS_CONNECTED_SCAN);\n\t} else {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, false, 8);\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA,\n\t\t\t\t\t     NORMAL_EXEC, false, false);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 2);\n\t}\n}\n\nstatic void halbtc8723b1ant_action_wifi_connected_special_packet(\n\t\t\t\t\t\tstruct btc_coexist *btcoexist)\n{\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\tbool wifi_busy = false;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\n\n\t \n\tif ((wifi_busy) &&\n\t    ((bt_link_info->pan_exist) || (coex_sta->num_of_profile >= 2)))\n\t\treturn;\n\n\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t 0x0, 0x0);\n\n\t \n\tif ((bt_link_info->sco_exist) || (bt_link_info->hid_exist)) {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 32);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 5);\n\t} else if (bt_link_info->a2dp_exist) {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 32);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 4);\n\t} else if (bt_link_info->pan_exist) {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, true, 20);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 4);\n\t} else {\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, false, 8);\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA,\n\t\t\t\t\t     NORMAL_EXEC, false, false);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 2);\n\t}\n}\n\nstatic void halbtc8723b1ant_action_wifi_connected(struct btc_coexist *btcoexist)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tbool wifi_busy = false;\n\tbool scan = false, link = false, roam = false;\n\tbool under_4way = false, ap_enable = false;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], CoexForWifiConnect()===>\\n\");\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_4_WAY_PROGRESS,\n\t\t\t   &under_4way);\n\tif (under_4way) {\n\t\thalbtc8723b1ant_action_wifi_connected_special_packet(btcoexist);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], CoexForWifiConnect(), return for wifi is under 4way<===\\n\");\n\t\treturn;\n\t}\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_SCAN, &scan);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_LINK, &link);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_ROAM, &roam);\n\n\tif (scan || link || roam) {\n\t\tif (scan)\n\t\t\tbtc8723b1ant_action_wifi_conn_scan(btcoexist);\n\t\telse\n\t\t\thalbtc8723b1ant_action_wifi_connected_special_packet(\n\t\t\t\t\t\t\t\t     btcoexist);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], CoexForWifiConnect(), return for wifi is under scan<===\\n\");\n\t\treturn;\n\t}\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_AP_MODE_ENABLE,\n\t\t\t   &ap_enable);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\n\t \n\tif (!ap_enable &&\n\t    coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_ACL_BUSY &&\n\t    !btcoexist->bt_link_info.hid_only) {\n\t\tif (btcoexist->bt_link_info.a2dp_only) {\n\t\t\tif (!wifi_busy) {\n\t\t\t\thalbtc8723b1ant_power_save_state(btcoexist,\n\t\t\t\t\t\t\t BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t\t\t 0x0, 0x0);\n\t\t\t} else {  \n\t\t\t\tif (coex_sta->scan_ap_num >=\n\t\t\t\t    BT_8723B_1ANT_WIFI_NOISY_THRESH)\n\t\t\t\t\t \n\t\t\t\t\thalbtc8723b1ant_power_save_state(\n\t\t\t\t\t\tbtcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t\t0x0, 0x0);\n\t\t\t\telse\n\t\t\t\t\thalbtc8723b1ant_power_save_state(\n\t\t\t\t\t\tbtcoexist, BTC_PS_LPS_ON, 0x50,\n\t\t\t\t\t\t0x4);\n\t\t\t}\n\t\t} else if ((!coex_sta->pan_exist) && (!coex_sta->a2dp_exist) &&\n\t\t\t   (!coex_sta->hid_exist))\n\t\t\thalbtc8723b1ant_power_save_state(\n\t\t\t\tbtcoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\n\t\telse\n\t\t\thalbtc8723b1ant_power_save_state(btcoexist,\n\t\t\t\t\t\t\t BTC_PS_LPS_ON,\n\t\t\t\t\t\t\t 0x50, 0x4);\n\t} else {\n\t\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t\t 0x0, 0x0);\n\t}\n\t \n\tif (!wifi_busy) {\n\t\tif (coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) {\n\t\t\thalbtc8723b1ant_action_wifi_connected_bt_acl_busy(\n\t\t\t\tbtcoexist,\n\t\t\t\tBT_8723B_1ANT_WIFI_STATUS_CONNECTED_IDLE);\n\t\t} else if (coex_dm->bt_status ==\n\t\t\t\tBT_8723B_1ANT_BT_STATUS_SCO_BUSY ||\n\t\t\t   coex_dm->bt_status ==\n\t\t\t\tBT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY) {\n\t\t\tbtc8723b1ant_act_bt_sco_hid_only_busy(btcoexist,\n\t\t\t\t     BT_8723B_1ANT_WIFI_STATUS_CONNECTED_IDLE);\n\t\t} else {\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\tfalse, 8);\n\t\t\thalbtc8723b1ant_set_ant_path(btcoexist,\n\t\t\t\t\t\t     BTC_ANT_PATH_PTA,\n\t\t\t\t\t\t     NORMAL_EXEC, false, false);\n\t\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t\t     NORMAL_EXEC, 2);\n\t\t}\n\t} else {\n\t\tif (coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_ACL_BUSY) {\n\t\t\thalbtc8723b1ant_action_wifi_connected_bt_acl_busy(\n\t\t\t\tbtcoexist,\n\t\t\t\tBT_8723B_1ANT_WIFI_STATUS_CONNECTED_BUSY);\n\t\t} else if (coex_dm->bt_status ==\n\t\t\t\tBT_8723B_1ANT_BT_STATUS_SCO_BUSY ||\n\t\t\t   coex_dm->bt_status ==\n\t\t\t\tBT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY) {\n\t\t\tbtc8723b1ant_act_bt_sco_hid_only_busy(btcoexist,\n\t\t\t\t    BT_8723B_1ANT_WIFI_STATUS_CONNECTED_BUSY);\n\t\t} else {\n\t\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC,\n\t\t\t\t\t\ttrue, 32);\n\t\t\thalbtc8723b1ant_set_ant_path(btcoexist,\n\t\t\t\t\t\t     BTC_ANT_PATH_PTA,\n\t\t\t\t\t\t     NORMAL_EXEC, false, false);\n\t\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t\t     NORMAL_EXEC, 4);\n\t\t}\n\t}\n}\n\nstatic void halbtc8723b1ant_run_coexist_mechanism(struct btc_coexist *btcoexist)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\tbool wifi_connected = false, bt_hs_on = false, wifi_busy = false;\n\tbool increase_scan_dev_num = false;\n\tbool bt_ctrl_agg_buf_size = false;\n\tbool miracast_plus_bt = false;\n\tu8 agg_buf_size = 5;\n\tu8 iot_peer = BTC_IOT_PEER_UNKNOWN;\n\tu32 wifi_link_status = 0;\n\tu32 num_of_wifi_link = 0;\n\tu32 wifi_bw;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], RunCoexistMechanism()===>\\n\");\n\n\tif (btcoexist->manual_control) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], RunCoexistMechanism(), return for Manual CTRL <===\\n\");\n\t\treturn;\n\t}\n\n\tif (btcoexist->stop_coex_dm) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], RunCoexistMechanism(), return for Stop Coex DM <===\\n\");\n\t\treturn;\n\t}\n\n\tif (coex_sta->under_ips) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], wifi is under IPS !!!\\n\");\n\t\treturn;\n\t}\n\n\tif (coex_sta->bt_whck_test) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], wifi is under IPS !!!\\n\");\n\t\thalbtc8723b1ant_action_bt_whck_test(btcoexist);\n\t\treturn;\n\t}\n\n\tif (coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_ACL_BUSY ||\n\t    coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_SCO_BUSY ||\n\t    coex_dm->bt_status == BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY)\n\t\tincrease_scan_dev_num = true;\n\n\tbtcoexist->btc_set(btcoexist, BTC_SET_BL_INC_SCAN_DEV_NUM,\n\t\t\t   &increase_scan_dev_num);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED,\n\t\t\t   &wifi_connected);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_LINK_STATUS,\n\t\t\t   &wifi_link_status);\n\tnum_of_wifi_link = wifi_link_status >> 16;\n\n\tif (num_of_wifi_link >= 2 ||\n\t    wifi_link_status & WIFI_P2P_GO_CONNECTED) {\n\t\tif (bt_link_info->bt_link_exist) {\n\t\t\thalbtc8723b1ant_limited_tx(btcoexist, NORMAL_EXEC, 1, 1,\n\t\t\t\t\t\t   0, 1);\n\t\t\tmiracast_plus_bt = true;\n\t\t} else {\n\t\t\thalbtc8723b1ant_limited_tx(btcoexist, NORMAL_EXEC, 0, 0,\n\t\t\t\t\t\t   0, 0);\n\t\t\tmiracast_plus_bt = false;\n\t\t}\n\t\tbtcoexist->btc_set(btcoexist, BTC_SET_BL_MIRACAST_PLUS_BT,\n\t\t\t\t   &miracast_plus_bt);\n\t\thalbtc8723b1ant_limited_rx(btcoexist, NORMAL_EXEC, false,\n\t\t\t\t\t   bt_ctrl_agg_buf_size, agg_buf_size);\n\n\t\tif ((bt_link_info->a2dp_exist || wifi_busy) &&\n\t\t    (coex_sta->c2h_bt_inquiry_page))\n\t\t\thalbtc8723b1ant_action_bt_inquiry(btcoexist);\n\t\telse\n\t\t\thalbtc8723b1ant_action_wifi_multiport(btcoexist);\n\n\t\treturn;\n\t}\n\n\tmiracast_plus_bt = false;\n\tbtcoexist->btc_set(btcoexist, BTC_SET_BL_MIRACAST_PLUS_BT,\n\t\t\t   &miracast_plus_bt);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\n\n\tif (bt_link_info->bt_link_exist && wifi_connected) {\n\t\thalbtc8723b1ant_limited_tx(btcoexist, NORMAL_EXEC, 1, 1, 0, 1);\n\n\t\tbtcoexist->btc_get(btcoexist, BTC_GET_U1_IOT_PEER, &iot_peer);\n\n\t\tif (iot_peer != BTC_IOT_PEER_CISCO &&\n\t\t    iot_peer != BTC_IOT_PEER_BROADCOM) {\n\t\t\tbool sco_exist = bt_link_info->sco_exist;\n\n\t\t\thalbtc8723b1ant_limited_rx(btcoexist,\n\t\t\t\t\t\t   NORMAL_EXEC, sco_exist,\n\t\t\t\t\t\t   false, 0x5);\n\t\t} else {\n\t\t\tif (bt_link_info->sco_exist) {\n\t\t\t\thalbtc8723b1ant_limited_rx(btcoexist,\n\t\t\t\t\t\t\t   NORMAL_EXEC, true,\n\t\t\t\t\t\t\t   false, 0x5);\n\t\t\t} else {\n\t\t\t\tif (wifi_bw == BTC_WIFI_BW_HT40)\n\t\t\t\t\thalbtc8723b1ant_limited_rx(\n\t\t\t\t\t\tbtcoexist, NORMAL_EXEC, false,\n\t\t\t\t\t\ttrue, 0x10);\n\t\t\t\telse\n\t\t\t\t\thalbtc8723b1ant_limited_rx(\n\t\t\t\t\t\tbtcoexist, NORMAL_EXEC, false,\n\t\t\t\t\t\ttrue, 0x8);\n\t\t\t}\n\t\t}\n\n\t\thalbtc8723b1ant_sw_mechanism(btcoexist, true);\n\t} else {\n\t\thalbtc8723b1ant_limited_tx(btcoexist, NORMAL_EXEC, 0, 0, 0, 0);\n\n\t\thalbtc8723b1ant_limited_rx(btcoexist, NORMAL_EXEC, false, false,\n\t\t\t\t\t   0x5);\n\n\t\thalbtc8723b1ant_sw_mechanism(btcoexist, false);\n\t}\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on);\n\n\tif (coex_sta->c2h_bt_inquiry_page) {\n\t\thalbtc8723b1ant_action_bt_inquiry(btcoexist);\n\t\treturn;\n\t} else if (bt_hs_on) {\n\t\thalbtc8723b1ant_action_hs(btcoexist);\n\t\treturn;\n\t}\n\n\tif (!wifi_connected) {\n\t\tbool scan = false, link = false, roam = false;\n\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], wifi is non connected-idle !!!\\n\");\n\n\t\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_SCAN, &scan);\n\t\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_LINK, &link);\n\t\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_ROAM, &roam);\n\n\t\tif (scan || link || roam) {\n\t\t\tif (scan)\n\t\t\t\tbtc8723b1ant_action_wifi_not_conn_scan(\n\t\t\t\t\t\t\t\t     btcoexist);\n\t\t\telse\n\t\t\t\tbtc8723b1ant_act_wifi_not_conn_asso_auth(\n\t\t\t\t\t\t\t\t     btcoexist);\n\t\t} else {\n\t\t\tbtc8723b1ant_action_wifi_not_conn(btcoexist);\n\t\t}\n\t} else {  \n\t\thalbtc8723b1ant_action_wifi_connected(btcoexist);\n\t}\n}\n\n \nstatic void halbtc8723b1ant_init_coex_dm(struct btc_coexist *btcoexist)\n{\n\t \n\thalbtc8723b1ant_sw_mechanism(btcoexist, false);\n\n\tcoex_sta->pop_event_cnt = 0;\n}\n\nstatic void halbtc8723b1ant_init_hw_config(struct btc_coexist *btcoexist,\n\t\t\t\t\t   bool backup, bool wifi_only)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tu32 u32tmp = 0;\n\tu8 u8tmpa = 0, u8tmpb = 0;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], 1Ant Init HW Config!!\\n\");\n\n\t \n\tcoex_sta->cut_version =\n\t\t(btcoexist->btc_read_1byte(btcoexist, 0xf1) & 0xf0) >> 4;\n\t \n\tbtcoexist->btc_write_1byte_bitmask(btcoexist, 0x550, 0x8, 0x1);\n\n\t \n\tbtcoexist->btc_write_1byte(btcoexist, 0x790, 0x5);\n\n\t \n\tbtcoexist->btc_write_1byte(btcoexist, 0x778, 0x1);\n\tbtcoexist->btc_write_1byte_bitmask(btcoexist, 0x40, 0x20, 0x1);\n\n\thalbtc8723b1ant_ps_tdma(btcoexist, FORCE_EXEC, false, 8);\n\n\t \n\tif (wifi_only)\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_WIFI,\n\t\t\t\t\t     FORCE_EXEC, true, false);\n\telse\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_BT,\n\t\t\t\t\t     FORCE_EXEC, true, false);\n\n\t \n\thalbtc8723b1ant_coex_table_with_type(btcoexist, FORCE_EXEC, 0);\n\n\tu32tmp = btcoexist->btc_read_4byte(btcoexist, 0x948);\n\tu8tmpa = btcoexist->btc_read_1byte(btcoexist, 0x765);\n\tu8tmpb = btcoexist->btc_read_1byte(btcoexist, 0x67);\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"############# [BTCoex], 0x948=0x%x, 0x765=0x%x, 0x67=0x%x\\n\",\n\t\tu32tmp, u8tmpa, u8tmpb);\n}\n\n \nvoid ex_btc8723b1ant_power_on_setting(struct btc_coexist *btcoexist)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tstruct btc_board_info *board_info = &btcoexist->board_info;\n\tu8 u8tmp = 0x0;\n\tu16 u16tmp = 0x0;\n\tu32 value;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"xxxxxxxxxxxxxxxx Execute 8723b 1-Ant PowerOn Setting xxxxxxxxxxxxxxxx!!\\n\");\n\n\tbtcoexist->stop_coex_dm = true;\n\n\tbtcoexist->btc_write_1byte(btcoexist, 0x67, 0x20);\n\n\t \n\tu16tmp = btcoexist->btc_read_2byte(btcoexist, 0x2);\n\tbtcoexist->btc_write_2byte(btcoexist, 0x2, u16tmp | BIT0 | BIT1);\n\n\t \n\tbtcoexist->btc_write_1byte(btcoexist, 0x765, 0x18);\n\t \n\tbtcoexist->btc_write_1byte(btcoexist, 0x76e, 0x4);\n\n\t \n\tif (btcoexist->chip_interface == BTC_INTF_USB) {\n\t\t \n\t\tbtcoexist->btc_write_4byte(btcoexist, 0x948, 0x0);\n\n\t\tu8tmp |= 0x1;  \n\t\tbtcoexist->btc_write_local_reg_1byte(btcoexist, 0xfe08, u8tmp);\n\n\t\tboard_info->btdm_ant_pos = BTC_ANTENNA_AT_AUX_PORT;\n\t} else {\n\t\t \n\t\tif (board_info->single_ant_path == 0) {\n\t\t\t \n\t\t\tbtcoexist->btc_write_4byte(btcoexist, 0x948, 0x280);\n\t\t\tboard_info->btdm_ant_pos = BTC_ANTENNA_AT_MAIN_PORT;\n\t\t\tvalue = 1;\n\t\t} else if (board_info->single_ant_path == 1) {\n\t\t\t \n\t\t\tbtcoexist->btc_write_4byte(btcoexist, 0x948, 0x0);\n\t\t\tu8tmp |= 0x1;  \n\t\t\tboard_info->btdm_ant_pos = BTC_ANTENNA_AT_AUX_PORT;\n\t\t\tvalue = 0;\n\t\t}\n\n\t\tbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ANTPOSREGRISTRY_CTRL,\n\t\t\t\t   &value);\n\n\t\tif (btcoexist->chip_interface == BTC_INTF_PCI)\n\t\t\tbtcoexist->btc_write_local_reg_1byte(btcoexist, 0x384,\n\t\t\t\t\t\t\t     u8tmp);\n\t\telse if (btcoexist->chip_interface == BTC_INTF_SDIO)\n\t\t\tbtcoexist->btc_write_local_reg_1byte(btcoexist, 0x60,\n\t\t\t\t\t\t\t     u8tmp);\n\t}\n}\n\n\nvoid ex_btc8723b1ant_init_hwconfig(struct btc_coexist *btcoexist,\n\t\t\t\t   bool wifi_only)\n{\n\thalbtc8723b1ant_init_hw_config(btcoexist, true, wifi_only);\n\tbtcoexist->stop_coex_dm = false;\n}\n\nvoid ex_btc8723b1ant_init_coex_dm(struct btc_coexist *btcoexist)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], Coex Mechanism Init!!\\n\");\n\n\tbtcoexist->stop_coex_dm = false;\n\n\thalbtc8723b1ant_init_coex_dm(btcoexist);\n\n\thalbtc8723b1ant_query_bt_info(btcoexist);\n}\n\nvoid ex_btc8723b1ant_display_coex_info(struct btc_coexist *btcoexist,\n\t\t\t\t       struct seq_file *m)\n{\n\tstruct btc_board_info *board_info = &btcoexist->board_info;\n\tstruct btc_stack_info *stack_info = &btcoexist->stack_info;\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\tu8 u8tmp[4], i, bt_info_ext, pstdmacase = 0;\n\tu16 u16tmp[4];\n\tu32 u32tmp[4];\n\tbool roam = false, scan = false;\n\tbool link = false, wifi_under_5g = false;\n\tbool bt_hs_on = false, wifi_busy = false;\n\ts32 wifi_rssi = 0, bt_hs_rssi = 0;\n\tu32 wifi_bw, wifi_traffic_dir, fa_ofdm, fa_cck, wifi_link_status;\n\tu8 wifi_dot11_chnl, wifi_hs_chnl;\n\tu32 fw_ver = 0, bt_patch_ver = 0;\n\n\tseq_puts(m, \"\\n ============[BT Coexist info]============\");\n\n\tif (btcoexist->manual_control) {\n\t\tseq_puts(m, \"\\n ============[Under Manual Control]==========\");\n\t\tseq_puts(m, \"\\n ==========================================\");\n\t}\n\tif (btcoexist->stop_coex_dm) {\n\t\tseq_puts(m, \"\\n ============[Coex is STOPPED]============\");\n\t\tseq_puts(m, \"\\n ==========================================\");\n\t}\n\n\tseq_printf(m, \"\\n %-35s = %d/ %d/ %d\",\n\t\t   \"Ant PG Num/ Ant Mech/ Ant Pos:\",\n\t\t   board_info->pg_ant_num, board_info->btdm_ant_num,\n\t\t   board_info->btdm_ant_pos);\n\n\tseq_printf(m, \"\\n %-35s = %s / %d\",\n\t\t   \"BT stack/ hci ext ver\",\n\t\t   ((stack_info->profile_notified) ? \"Yes\" : \"No\"),\n\t\t   stack_info->hci_version);\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_BT_PATCH_VER, &bt_patch_ver);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_FW_VER, &fw_ver);\n\tseq_printf(m, \"\\n %-35s = %d_%x/ 0x%x/ 0x%x(%d)\",\n\t\t   \"CoexVer/ FwVer/ PatchVer\",\n\t\t   glcoex_ver_date_8723b_1ant, glcoex_ver_8723b_1ant,\n\t\t   fw_ver, bt_patch_ver, bt_patch_ver);\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U1_WIFI_DOT11_CHNL,\n\t\t\t   &wifi_dot11_chnl);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U1_WIFI_HS_CHNL, &wifi_hs_chnl);\n\tseq_printf(m, \"\\n %-35s = %d / %d(%d)\",\n\t\t   \"Dot11 channel / HsChnl(HsMode)\",\n\t\t   wifi_dot11_chnl, wifi_hs_chnl, bt_hs_on);\n\n\tseq_printf(m, \"\\n %-35s = %3ph \",\n\t\t   \"H2C Wifi inform bt chnl Info\",\n\t\t   coex_dm->wifi_chnl_info);\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_S4_WIFI_RSSI, &wifi_rssi);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_S4_HS_RSSI, &bt_hs_rssi);\n\tseq_printf(m, \"\\n %-35s = %d/ %d\",\n\t\t   \"Wifi rssi/ HS rssi\", wifi_rssi, bt_hs_rssi);\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_SCAN, &scan);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_LINK, &link);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_ROAM, &roam);\n\tseq_printf(m, \"\\n %-35s = %d/ %d/ %d \",\n\t\t   \"Wifi link/ roam/ scan\", link, roam, scan);\n\n\tbtcoexist->btc_get(btcoexist , BTC_GET_BL_WIFI_UNDER_5G,\n\t\t\t   &wifi_under_5g);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_TRAFFIC_DIRECTION,\n\t\t\t   &wifi_traffic_dir);\n\n\tseq_printf(m, \"\\n %-35s = %s / %s/ %s \",\n\t\t   \"Wifi status\", (wifi_under_5g ? \"5G\" : \"2.4G\"),\n\t\t   ((wifi_bw == BTC_WIFI_BW_LEGACY) ? \"Legacy\" :\n\t\t    ((wifi_bw == BTC_WIFI_BW_HT40) ? \"HT40\" : \"HT20\")),\n\t\t    ((!wifi_busy) ? \"idle\" :\n\t\t     ((wifi_traffic_dir == BTC_WIFI_TRAFFIC_TX) ?\n\t\t     \"uplink\" : \"downlink\")));\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_LINK_STATUS,\n\t\t\t   &wifi_link_status);\n\tseq_printf(m, \"\\n %-35s = %d/ %d/ %d/ %d/ %d\",\n\t\t   \"sta/vwifi/hs/p2pGo/p2pGc\",\n\t\t   ((wifi_link_status & WIFI_STA_CONNECTED) ? 1 : 0),\n\t\t   ((wifi_link_status & WIFI_AP_CONNECTED) ? 1 : 0),\n\t\t   ((wifi_link_status & WIFI_HS_CONNECTED) ? 1 : 0),\n\t\t   ((wifi_link_status & WIFI_P2P_GO_CONNECTED) ? 1 : 0),\n\t\t   ((wifi_link_status & WIFI_P2P_GC_CONNECTED) ? 1 : 0));\n\n\tseq_printf(m, \"\\n %-35s = [%s/ %d/ %d] \",\n\t\t   \"BT [status/ rssi/ retryCnt]\",\n\t\t   ((coex_sta->bt_disabled) ? (\"disabled\") :\n\t\t    ((coex_sta->c2h_bt_inquiry_page) ? (\"inquiry/page scan\") :\n\t\t     ((BT_8723B_1ANT_BT_STATUS_NON_CONNECTED_IDLE ==\n\t\t       coex_dm->bt_status) ?\n\t\t      \"non-connected idle\" :\n\t\t      ((BT_8723B_1ANT_BT_STATUS_CONNECTED_IDLE ==\n\t\t\tcoex_dm->bt_status) ?\n\t\t       \"connected-idle\" : \"busy\")))),\n\t\t       coex_sta->bt_rssi, coex_sta->bt_retry_cnt);\n\n\tseq_printf(m, \"\\n %-35s = %d / %d / %d / %d\",\n\t\t   \"SCO/HID/PAN/A2DP\", bt_link_info->sco_exist,\n\t\t   bt_link_info->hid_exist, bt_link_info->pan_exist,\n\t\t   bt_link_info->a2dp_exist);\n\tbtcoexist->btc_disp_dbg_msg(btcoexist, BTC_DBG_DISP_BT_LINK_INFO, m);\n\n\tbt_info_ext = coex_sta->bt_info_ext;\n\tseq_printf(m, \"\\n %-35s = %s\",\n\t\t   \"BT Info A2DP rate\",\n\t\t   (bt_info_ext & BIT0) ? \"Basic rate\" : \"EDR rate\");\n\n\tfor (i = 0; i < BT_INFO_SRC_8723B_1ANT_MAX; i++) {\n\t\tif (coex_sta->bt_info_c2h_cnt[i]) {\n\t\t\tseq_printf(m, \"\\n %-35s = %7ph(%d)\",\n\t\t\t\t   glbt_info_src_8723b_1ant[i],\n\t\t\t\t   coex_sta->bt_info_c2h[i],\n\t\t\t\t   coex_sta->bt_info_c2h_cnt[i]);\n\t\t}\n\t}\n\tseq_printf(m, \"\\n %-35s = %s/%s, (0x%x/0x%x)\",\n\t\t   \"PS state, IPS/LPS, (lps/rpwm)\",\n\t\t   ((coex_sta->under_ips ? \"IPS ON\" : \"IPS OFF\")),\n\t\t   ((coex_sta->under_lps ? \"LPS ON\" : \"LPS OFF\")),\n\t\t   btcoexist->bt_info.lps_val,\n\t\t   btcoexist->bt_info.rpwm_val);\n\tbtcoexist->btc_disp_dbg_msg(btcoexist, BTC_DBG_DISP_FW_PWR_MODE_CMD, m);\n\n\tif (!btcoexist->manual_control) {\n\t\t \n\t\tseq_printf(m, \"\\n %-35s\",\n\t\t\t   \"============[Sw mechanism]============\");\n\n\t\tseq_printf(m, \"\\n %-35s = %d/\",\n\t\t\t   \"SM[LowPenaltyRA]\", coex_dm->cur_low_penalty_ra);\n\n\t\tseq_printf(m, \"\\n %-35s = %s/ %s/ %d \",\n\t\t\t   \"DelBA/ BtCtrlAgg/ AggSize\",\n\t\t\t   (btcoexist->bt_info.reject_agg_pkt ? \"Yes\" : \"No\"),\n\t\t\t   (btcoexist->bt_info.bt_ctrl_buf_size ? \"Yes\" : \"No\"),\n\t\t\t   btcoexist->bt_info.agg_buf_size);\n\n\t\tseq_printf(m, \"\\n %-35s = 0x%x \",\n\t\t\t   \"Rate Mask\", btcoexist->bt_info.ra_mask);\n\n\t\t \n\t\tseq_printf(m, \"\\n %-35s\",\n\t\t\t   \"============[Fw mechanism]============\");\n\n\t\tpstdmacase = coex_dm->cur_ps_tdma;\n\t\tseq_printf(m, \"\\n %-35s = %5ph case-%d (auto:%d)\",\n\t\t\t   \"PS TDMA\", coex_dm->ps_tdma_para,\n\t\t\t   pstdmacase, coex_dm->auto_tdma_adjust);\n\n\t\tseq_printf(m, \"\\n %-35s = %d \",\n\t\t\t   \"IgnWlanAct\", coex_dm->cur_ignore_wlan_act);\n\n\t\tseq_printf(m, \"\\n %-35s = 0x%x \",\n\t\t\t   \"Latest error condition(should be 0)\",\n\t\t\t   coex_dm->error_condition);\n\t}\n\n\tseq_printf(m, \"\\n %-35s = %d\",\n\t\t   \"Coex Table Type\", coex_sta->coex_table_type);\n\n\t \n\tseq_printf(m, \"\\n %-35s\",\n\t\t   \"============[Hw setting]============\");\n\n\tseq_printf(m, \"\\n %-35s = 0x%x/0x%x/0x%x/0x%x\",\n\t\t   \"backup ARFR1/ARFR2/RL/AMaxTime\", coex_dm->backup_arfr_cnt1,\n\t\t   coex_dm->backup_arfr_cnt2, coex_dm->backup_retry_limit,\n\t\t   coex_dm->backup_ampdu_max_time);\n\n\tu32tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0x430);\n\tu32tmp[1] = btcoexist->btc_read_4byte(btcoexist, 0x434);\n\tu16tmp[0] = btcoexist->btc_read_2byte(btcoexist, 0x42a);\n\tu8tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x456);\n\tseq_printf(m, \"\\n %-35s = 0x%x/0x%x/0x%x/0x%x\",\n\t\t   \"0x430/0x434/0x42a/0x456\",\n\t\t   u32tmp[0], u32tmp[1], u16tmp[0], u8tmp[0]);\n\n\tu8tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x778);\n\tu32tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0x6cc);\n\tu32tmp[1] = btcoexist->btc_read_4byte(btcoexist, 0x880);\n\tseq_printf(m, \"\\n %-35s = 0x%x/ 0x%x/ 0x%x\",\n\t\t   \"0x778/0x6cc/0x880[29:25]\", u8tmp[0], u32tmp[0],\n\t\t   (u32tmp[1] & 0x3e000000) >> 25);\n\n\tu32tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0x948);\n\tu8tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x67);\n\tu8tmp[1] = btcoexist->btc_read_1byte(btcoexist, 0x765);\n\tseq_printf(m, \"\\n %-35s = 0x%x/ 0x%x/ 0x%x\",\n\t\t   \"0x948/ 0x67[5] / 0x765\",\n\t\t   u32tmp[0], ((u8tmp[0] & 0x20) >> 5), u8tmp[1]);\n\n\tu32tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0x92c);\n\tu32tmp[1] = btcoexist->btc_read_4byte(btcoexist, 0x930);\n\tu32tmp[2] = btcoexist->btc_read_4byte(btcoexist, 0x944);\n\tseq_printf(m, \"\\n %-35s = 0x%x/ 0x%x/ 0x%x\",\n\t\t   \"0x92c[1:0]/ 0x930[7:0]/0x944[1:0]\",\n\t\t   u32tmp[0] & 0x3, u32tmp[1] & 0xff, u32tmp[2] & 0x3);\n\n\tu8tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x39);\n\tu8tmp[1] = btcoexist->btc_read_1byte(btcoexist, 0x40);\n\tu32tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0x4c);\n\tu8tmp[2] = btcoexist->btc_read_1byte(btcoexist, 0x64);\n\tseq_printf(m, \"\\n %-35s = 0x%x/ 0x%x/ 0x%x/ 0x%x\",\n\t\t   \"0x38[11]/0x40/0x4c[24:23]/0x64[0]\",\n\t\t   ((u8tmp[0] & 0x8) >> 3), u8tmp[1],\n\t\t    ((u32tmp[0] & 0x01800000) >> 23), u8tmp[2] & 0x1);\n\n\tu32tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0x550);\n\tu8tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x522);\n\tseq_printf(m, \"\\n %-35s = 0x%x/ 0x%x\",\n\t\t   \"0x550(bcn ctrl)/0x522\", u32tmp[0], u8tmp[0]);\n\n\tu32tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0xc50);\n\tu8tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x49c);\n\tseq_printf(m, \"\\n %-35s = 0x%x/ 0x%x\",\n\t\t   \"0xc50(dig)/0x49c(null-drop)\", u32tmp[0] & 0xff, u8tmp[0]);\n\n\tu32tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0xda0);\n\tu32tmp[1] = btcoexist->btc_read_4byte(btcoexist, 0xda4);\n\tu32tmp[2] = btcoexist->btc_read_4byte(btcoexist, 0xda8);\n\tu32tmp[3] = btcoexist->btc_read_4byte(btcoexist, 0xcf0);\n\n\tu8tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0xa5b);\n\tu8tmp[1] = btcoexist->btc_read_1byte(btcoexist, 0xa5c);\n\n\tfa_ofdm = ((u32tmp[0] & 0xffff0000) >> 16) +\n\t\t  ((u32tmp[1] & 0xffff0000) >> 16) +\n\t\t   (u32tmp[1] & 0xffff) +\n\t\t   (u32tmp[2] & 0xffff) +\n\t\t  ((u32tmp[3] & 0xffff0000) >> 16) +\n\t\t   (u32tmp[3] & 0xffff);\n\tfa_cck = (u8tmp[0] << 8) + u8tmp[1];\n\n\tseq_printf(m, \"\\n %-35s = 0x%x/ 0x%x/ 0x%x\",\n\t\t   \"OFDM-CCA/OFDM-FA/CCK-FA\",\n\t\t u32tmp[0] & 0xffff, fa_ofdm, fa_cck);\n\n\tu32tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0x6c0);\n\tu32tmp[1] = btcoexist->btc_read_4byte(btcoexist, 0x6c4);\n\tu32tmp[2] = btcoexist->btc_read_4byte(btcoexist, 0x6c8);\n\tseq_printf(m, \"\\n %-35s = 0x%x/ 0x%x/ 0x%x\",\n\t\t   \"0x6c0/0x6c4/0x6c8(coexTable)\",\n\t\t   u32tmp[0], u32tmp[1], u32tmp[2]);\n\n\tseq_printf(m, \"\\n %-35s = %d/ %d\",\n\t\t   \"0x770(high-pri rx/tx)\", coex_sta->high_priority_rx,\n\t\t   coex_sta->high_priority_tx);\n\tseq_printf(m, \"\\n %-35s = %d/ %d\",\n\t\t   \"0x774(low-pri rx/tx)\", coex_sta->low_priority_rx,\n\t\t   coex_sta->low_priority_tx);\n\tif (btcoexist->auto_report_1ant)\n\t\thalbtc8723b1ant_monitor_bt_ctr(btcoexist);\n\tbtcoexist->btc_disp_dbg_msg(btcoexist, BTC_DBG_DISP_COEX_STATISTICS, m);\n}\n\nvoid ex_btc8723b1ant_ips_notify(struct btc_coexist *btcoexist, u8 type)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\tif (btcoexist->manual_control || btcoexist->stop_coex_dm)\n\t\treturn;\n\n\tif (BTC_IPS_ENTER == type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], IPS ENTER notify\\n\");\n\t\tcoex_sta->under_ips = true;\n\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_BT,\n\t\t\t\t\t     FORCE_EXEC, false, true);\n\t\t \n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, false, 0);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist,\n\t\t\t\t\t\t     NORMAL_EXEC, 0);\n\t} else if (BTC_IPS_LEAVE == type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], IPS LEAVE notify\\n\");\n\t\tcoex_sta->under_ips = false;\n\n\t\thalbtc8723b1ant_init_hw_config(btcoexist, false, false);\n\t\thalbtc8723b1ant_init_coex_dm(btcoexist);\n\t\thalbtc8723b1ant_query_bt_info(btcoexist);\n\t}\n}\n\nvoid ex_btc8723b1ant_lps_notify(struct btc_coexist *btcoexist, u8 type)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\tif (btcoexist->manual_control || btcoexist->stop_coex_dm)\n\t\treturn;\n\n\tif (BTC_LPS_ENABLE == type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], LPS ENABLE notify\\n\");\n\t\tcoex_sta->under_lps = true;\n\t} else if (BTC_LPS_DISABLE == type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], LPS DISABLE notify\\n\");\n\t\tcoex_sta->under_lps = false;\n\t}\n}\n\nvoid ex_btc8723b1ant_scan_notify(struct btc_coexist *btcoexist, u8 type)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tbool wifi_connected = false, bt_hs_on = false;\n\tu8 u8tmpa, u8tmpb;\n\tu32 u32tmp;\n\tu32 wifi_link_status = 0;\n\tu32 num_of_wifi_link = 0;\n\tbool bt_ctrl_agg_buf_size = false;\n\tu8 agg_buf_size = 5;\n\n\tif (btcoexist->manual_control || btcoexist->stop_coex_dm)\n\t\treturn;\n\n\tif (type == BTC_SCAN_START) {\n\t\tcoex_sta->wifi_is_high_pri_task = true;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], SCAN START notify\\n\");\n\t\t \n\t\thalbtc8723b1ant_ps_tdma(btcoexist, FORCE_EXEC, false, 8);\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA,\n\t\t\t\t\t     FORCE_EXEC, false, false);\n\t\tu32tmp = btcoexist->btc_read_4byte(btcoexist, 0x948);\n\t\tu8tmpa = btcoexist->btc_read_1byte(btcoexist, 0x765);\n\t\tu8tmpb = btcoexist->btc_read_1byte(btcoexist, 0x67);\n\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], 0x948=0x%x, 0x765=0x%x, 0x67=0x%x\\n\",\n\t\t\tu32tmp, u8tmpa, u8tmpb);\n\t} else {\n\t\tcoex_sta->wifi_is_high_pri_task = false;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], SCAN FINISH notify\\n\");\n\n\t\tbtcoexist->btc_get(btcoexist, BTC_GET_U1_AP_NUM,\n\t\t\t\t   &coex_sta->scan_ap_num);\n\t}\n\n\tif (coex_sta->bt_disabled)\n\t\treturn;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on);\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED,\n\t\t\t   &wifi_connected);\n\n\thalbtc8723b1ant_query_bt_info(btcoexist);\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_LINK_STATUS,\n\t\t\t   &wifi_link_status);\n\tnum_of_wifi_link = wifi_link_status >> 16;\n\tif (num_of_wifi_link >= 2) {\n\t\thalbtc8723b1ant_limited_tx(btcoexist, NORMAL_EXEC, 0, 0, 0, 0);\n\t\thalbtc8723b1ant_limited_rx(btcoexist, NORMAL_EXEC, false,\n\t\t\t\t\t   bt_ctrl_agg_buf_size, agg_buf_size);\n\t\thalbtc8723b1ant_action_wifi_multiport(btcoexist);\n\t\treturn;\n\t}\n\n\tif (coex_sta->c2h_bt_inquiry_page) {\n\t\thalbtc8723b1ant_action_bt_inquiry(btcoexist);\n\t\treturn;\n\t} else if (bt_hs_on) {\n\t\thalbtc8723b1ant_action_hs(btcoexist);\n\t\treturn;\n\t}\n\n\tif (BTC_SCAN_START == type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], SCAN START notify\\n\");\n\t\tif (!wifi_connected)\n\t\t\t \n\t\t\tbtc8723b1ant_action_wifi_not_conn_scan(btcoexist);\n\t\telse\n\t\t\t \n\t\t\tbtc8723b1ant_action_wifi_conn_scan(btcoexist);\n\t} else if (BTC_SCAN_FINISH == type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], SCAN FINISH notify\\n\");\n\t\tif (!wifi_connected)\n\t\t\t \n\t\t\tbtc8723b1ant_action_wifi_not_conn(btcoexist);\n\t\telse\n\t\t\thalbtc8723b1ant_action_wifi_connected(btcoexist);\n\t}\n}\n\nvoid ex_btc8723b1ant_connect_notify(struct btc_coexist *btcoexist, u8 type)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tbool wifi_connected = false, bt_hs_on = false;\n\tu32 wifi_link_status = 0;\n\tu32 num_of_wifi_link = 0;\n\tbool bt_ctrl_agg_buf_size = false, under_4way = false;\n\tu8 agg_buf_size = 5;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_4_WAY_PROGRESS,\n\t\t\t   &under_4way);\n\n\tif (btcoexist->manual_control || btcoexist->stop_coex_dm ||\n\t    coex_sta->bt_disabled)\n\t\treturn;\n\n\tif (type == BTC_ASSOCIATE_START) {\n\t\tcoex_sta->wifi_is_high_pri_task = true;\n\n\t\t \n\t\thalbtc8723b1ant_ps_tdma(btcoexist, FORCE_EXEC, false, 8);\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA,\n\t\t\t\t\t     FORCE_EXEC, false, false);\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], CONNECT START notify\\n\");\n\t\tcoex_dm->arp_cnt = 0;\n\t} else {\n\t\tcoex_sta->wifi_is_high_pri_task = false;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], CONNECT FINISH notify\\n\");\n\t}\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_LINK_STATUS,\n\t\t\t   &wifi_link_status);\n\tnum_of_wifi_link = wifi_link_status>>16;\n\tif (num_of_wifi_link >= 2) {\n\t\thalbtc8723b1ant_limited_tx(btcoexist, NORMAL_EXEC, 0, 0, 0, 0);\n\t\thalbtc8723b1ant_limited_rx(btcoexist, NORMAL_EXEC, false,\n\t\t\t\t\t   bt_ctrl_agg_buf_size, agg_buf_size);\n\t\thalbtc8723b1ant_action_wifi_multiport(btcoexist);\n\t\treturn;\n\t}\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on);\n\tif (coex_sta->c2h_bt_inquiry_page) {\n\t\thalbtc8723b1ant_action_bt_inquiry(btcoexist);\n\t\treturn;\n\t} else if (bt_hs_on) {\n\t\thalbtc8723b1ant_action_hs(btcoexist);\n\t\treturn;\n\t}\n\n\tif (BTC_ASSOCIATE_START == type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], CONNECT START notify\\n\");\n\t\tbtc8723b1ant_act_wifi_not_conn_asso_auth(btcoexist);\n\t} else if (BTC_ASSOCIATE_FINISH == type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], CONNECT FINISH notify\\n\");\n\n\t\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED,\n\t\t\t\t   &wifi_connected);\n\t\tif (!wifi_connected)\n\t\t\t \n\t\t\tbtc8723b1ant_action_wifi_not_conn(btcoexist);\n\t\telse\n\t\t\thalbtc8723b1ant_action_wifi_connected(btcoexist);\n\t}\n}\n\nvoid ex_btc8723b1ant_media_status_notify(struct btc_coexist *btcoexist,\n\t\t\t\t\t u8 type)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tu8 h2c_parameter[3] = {0};\n\tu32 wifi_bw;\n\tu8 wifi_central_chnl;\n\tbool wifi_under_b_mode = false;\n\n\tif (btcoexist->manual_control || btcoexist->stop_coex_dm ||\n\t    coex_sta->bt_disabled)\n\t\treturn;\n\n\tif (type == BTC_MEDIA_CONNECT) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], MEDIA connect notify\\n\");\n\t\t \n\t\thalbtc8723b1ant_ps_tdma(btcoexist, FORCE_EXEC, false, 8);\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_PTA,\n\t\t\t\t\t     FORCE_EXEC, false, false);\n\t\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_UNDER_B_MODE,\n\t\t\t\t   &wifi_under_b_mode);\n\n\t\t \n\t\tif (wifi_under_b_mode) {\n\t\t\tbtcoexist->btc_write_1byte(btcoexist, 0x6cd,\n\t\t\t\t\t\t   0x00);  \n\t\t\tbtcoexist->btc_write_1byte(btcoexist, 0x6cf,\n\t\t\t\t\t\t   0x00);  \n\t\t} else {\n\t\t\tbtcoexist->btc_write_1byte(btcoexist, 0x6cd,\n\t\t\t\t\t\t   0x00);  \n\t\t\tbtcoexist->btc_write_1byte(btcoexist, 0x6cf,\n\t\t\t\t\t\t   0x10);  \n\t\t}\n\n\t\tcoex_dm->backup_arfr_cnt1 =\n\t\t\tbtcoexist->btc_read_4byte(btcoexist, 0x430);\n\t\tcoex_dm->backup_arfr_cnt2 =\n\t\t\tbtcoexist->btc_read_4byte(btcoexist, 0x434);\n\t\tcoex_dm->backup_retry_limit =\n\t\t\tbtcoexist->btc_read_2byte(btcoexist, 0x42a);\n\t\tcoex_dm->backup_ampdu_max_time =\n\t\t\tbtcoexist->btc_read_1byte(btcoexist, 0x456);\n\t} else {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], MEDIA disconnect notify\\n\");\n\t\tcoex_dm->arp_cnt = 0;\n\n\t\tbtcoexist->btc_write_1byte(btcoexist, 0x6cd, 0x0);  \n\t\tbtcoexist->btc_write_1byte(btcoexist, 0x6cf, 0x0);  \n\n\t\tcoex_sta->cck_ever_lock = false;\n\t}\n\n\t \n\tbtcoexist->btc_get(btcoexist, BTC_GET_U1_WIFI_CENTRAL_CHNL,\n\t\t\t   &wifi_central_chnl);\n\n\tif (type == BTC_MEDIA_CONNECT && wifi_central_chnl <= 14) {\n\t\th2c_parameter[0] = 0x0;\n\t\th2c_parameter[1] = wifi_central_chnl;\n\t\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\n\t\tif (BTC_WIFI_BW_HT40 == wifi_bw)\n\t\t\th2c_parameter[2] = 0x30;\n\t\telse\n\t\t\th2c_parameter[2] = 0x20;\n\t}\n\n\tcoex_dm->wifi_chnl_info[0] = h2c_parameter[0];\n\tcoex_dm->wifi_chnl_info[1] = h2c_parameter[1];\n\tcoex_dm->wifi_chnl_info[2] = h2c_parameter[2];\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], FW write 0x66 = 0x%x\\n\",\n\t\th2c_parameter[0] << 16 | h2c_parameter[1] << 8 |\n\t\th2c_parameter[2]);\n\n\tbtcoexist->btc_fill_h2c(btcoexist, 0x66, 3, h2c_parameter);\n}\n\nvoid ex_btc8723b1ant_special_packet_notify(struct btc_coexist *btcoexist,\n\t\t\t\t\t   u8 type)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tbool bt_hs_on = false;\n\tu32 wifi_link_status = 0;\n\tu32 num_of_wifi_link = 0;\n\tbool bt_ctrl_agg_buf_size = false, under_4way = false;\n\tu8 agg_buf_size = 5;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_4_WAY_PROGRESS,\n\t\t\t   &under_4way);\n\n\tif (btcoexist->manual_control || btcoexist->stop_coex_dm ||\n\t    coex_sta->bt_disabled)\n\t\treturn;\n\n\tif (type == BTC_PACKET_DHCP || type == BTC_PACKET_EAPOL ||\n\t    type == BTC_PACKET_ARP) {\n\t\tif (type == BTC_PACKET_ARP) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\"[BTCoex], special Packet ARP notify\\n\");\n\n\t\t\tcoex_dm->arp_cnt++;\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\"[BTCoex], ARP Packet Count = %d\\n\",\n\t\t\t\t coex_dm->arp_cnt);\n\n\t\t\tif ((coex_dm->arp_cnt >= 10) && (!under_4way))\n\t\t\t\t \n\t\t\t\tcoex_sta->wifi_is_high_pri_task = false;\n\t\t\telse\n\t\t\t\tcoex_sta->wifi_is_high_pri_task = true;\n\t\t} else {\n\t\t\tcoex_sta->wifi_is_high_pri_task = true;\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\"[BTCoex], special Packet DHCP or EAPOL notify\\n\");\n\t\t}\n\t} else {\n\t\tcoex_sta->wifi_is_high_pri_task = false;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], special Packet [Type = %d] notify\\n\",\n\t\t\t type);\n\t}\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_LINK_STATUS,\n\t\t&wifi_link_status);\n\tnum_of_wifi_link = wifi_link_status >> 16;\n\tif (num_of_wifi_link >= 2) {\n\t\thalbtc8723b1ant_limited_tx(btcoexist, NORMAL_EXEC, 0, 0, 0, 0);\n\t\thalbtc8723b1ant_limited_rx(btcoexist, NORMAL_EXEC, false,\n\t\t\t\t\t   bt_ctrl_agg_buf_size, agg_buf_size);\n\t\thalbtc8723b1ant_action_wifi_multiport(btcoexist);\n\t\treturn;\n\t}\n\n\tcoex_sta->special_pkt_period_cnt = 0;\n\n\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on);\n\tif (coex_sta->c2h_bt_inquiry_page) {\n\t\thalbtc8723b1ant_action_bt_inquiry(btcoexist);\n\t\treturn;\n\t} else if (bt_hs_on) {\n\t\thalbtc8723b1ant_action_hs(btcoexist);\n\t\treturn;\n\t}\n\n\tif (BTC_PACKET_DHCP == type ||\n\t    BTC_PACKET_EAPOL == type) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], special Packet(%d) notify\\n\", type);\n\t\thalbtc8723b1ant_action_wifi_connected_special_packet(btcoexist);\n\t}\n}\n\nvoid ex_btc8723b1ant_bt_info_notify(struct btc_coexist *btcoexist,\n\t\t\t\t    u8 *tmp_buf, u8 length)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tu8 bt_info = 0;\n\tu8 i, rsp_source = 0;\n\tbool wifi_connected = false;\n\tbool bt_busy = false;\n\n\tcoex_sta->c2h_bt_info_req_sent = false;\n\n\trsp_source = tmp_buf[0] & 0xf;\n\tif (rsp_source >= BT_INFO_SRC_8723B_1ANT_MAX)\n\t\trsp_source = BT_INFO_SRC_8723B_1ANT_WIFI_FW;\n\tcoex_sta->bt_info_c2h_cnt[rsp_source]++;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], Bt info[%d], length=%d, hex data = [\",\n\t\t rsp_source, length);\n\tfor (i = 0; i < length; i++) {\n\t\tcoex_sta->bt_info_c2h[rsp_source][i] = tmp_buf[i];\n\t\tif (i == 1)\n\t\t\tbt_info = tmp_buf[i];\n\t\tif (i == length - 1)\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\"0x%02x]\\n\", tmp_buf[i]);\n\t\telse\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\"0x%02x, \", tmp_buf[i]);\n\t}\n\n\t \n\tif (bt_info == 0xff)\n\t\tcoex_sta->bt_whck_test = true;\n\telse\n\t\tcoex_sta->bt_whck_test = false;\n\n\tif (rsp_source != BT_INFO_SRC_8723B_1ANT_WIFI_FW) {\n\t\tcoex_sta->bt_retry_cnt =  \n\t\t\tcoex_sta->bt_info_c2h[rsp_source][2] & 0xf;\n\n\t\tif (coex_sta->bt_retry_cnt >= 1)\n\t\t\tcoex_sta->pop_event_cnt++;\n\n\t\tif (coex_sta->bt_info_c2h[rsp_source][2] & 0x20)\n\t\t\tcoex_sta->c2h_bt_remote_name_req = true;\n\t\telse\n\t\t\tcoex_sta->c2h_bt_remote_name_req = false;\n\n\t\tcoex_sta->bt_rssi =\n\t\t\tcoex_sta->bt_info_c2h[rsp_source][3] * 2 - 90;\n\n\t\tcoex_sta->bt_info_ext =\n\t\t\tcoex_sta->bt_info_c2h[rsp_source][4];\n\n\t\tif (coex_sta->bt_info_c2h[rsp_source][1] == 0x49) {\n\t\t\tcoex_sta->a2dp_bit_pool =\n\t\t\t\tcoex_sta->bt_info_c2h[rsp_source][6];\n\t\t} else {\n\t\t\tcoex_sta->a2dp_bit_pool = 0;\n\t\t}\n\n\t\tcoex_sta->bt_tx_rx_mask =\n\t\t\t(coex_sta->bt_info_c2h[rsp_source][2] & 0x40);\n\t\tbtcoexist->btc_set(btcoexist, BTC_SET_BL_BT_TX_RX_MASK,\n\t\t\t\t   &coex_sta->bt_tx_rx_mask);\n\n\t\tif (!coex_sta->bt_tx_rx_mask) {\n\t\t\t \n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\"[BTCoex], Switch BT TRx Mask since BT RF REG 0x3C != 0x15\\n\");\n\t\t\tbtcoexist->btc_set_bt_reg(btcoexist, BTC_BT_REG_RF,\n\t\t\t\t\t\t  0x3c, 0x15);\n\n\t\t\t \n\t\t\tbtcoexist->btc_set_bt_reg(btcoexist, BTC_BT_REG_RF,\n\t\t\t\t\t\t  0x2c, 0x7c44);\n\t\t\tbtcoexist->btc_set_bt_reg(btcoexist, BTC_BT_REG_RF,\n\t\t\t\t\t\t  0x30, 0x7c44);\n\t\t}\n\n\t\t \n\t\tif (coex_sta->bt_info_ext & BIT1) {\n\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\"[BTCoex], BT ext info bit1 check, send wifi BW&Chnl to BT!!\\n\");\n\t\t\tbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED,\n\t\t\t\t\t   &wifi_connected);\n\t\t\tif (wifi_connected)\n\t\t\t\tex_btc8723b1ant_media_status_notify(btcoexist,\n\t\t\t\t\t\tBTC_MEDIA_CONNECT);\n\t\t\telse\n\t\t\t\tex_btc8723b1ant_media_status_notify(btcoexist,\n\t\t\t\t\t\tBTC_MEDIA_DISCONNECT);\n\t\t}\n\n\t\tif (coex_sta->bt_info_ext & BIT3) {\n\t\t\tif (!btcoexist->manual_control &&\n\t\t\t    !btcoexist->stop_coex_dm) {\n\t\t\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\t\t\"[BTCoex], BT ext info bit3 check, set BT NOT ignore Wlan active!!\\n\");\n\t\t\t\thalbtc8723b1ant_ignore_wlan_act(btcoexist,\n\t\t\t\t\t\t\t\tFORCE_EXEC,\n\t\t\t\t\t\t\t\tfalse);\n\t\t\t}\n\t\t} else {\n\t\t\t \n\t\t}\n\t\tif (!btcoexist->auto_report_1ant) {\n\t\t\tif (coex_sta->bt_info_ext & BIT4) {\n\t\t\t\t \n\t\t\t} else {\n\t\t\t\thalbtc8723b1ant_bt_auto_report(btcoexist,\n\t\t\t\t\t\t\t       FORCE_EXEC,\n\t\t\t\t\t\t\t       true);\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tif (bt_info & BT_INFO_8723B_1ANT_B_INQ_PAGE)\n\t\tcoex_sta->c2h_bt_inquiry_page = true;\n\telse\n\t\tcoex_sta->c2h_bt_inquiry_page = false;\n\n\tcoex_sta->num_of_profile = 0;\n\n\t \n\tif (!(bt_info & BT_INFO_8723B_1ANT_B_CONNECTION)) {\n\t\tcoex_sta->bt_link_exist = false;\n\t\tcoex_sta->pan_exist = false;\n\t\tcoex_sta->a2dp_exist = false;\n\t\tcoex_sta->hid_exist = false;\n\t\tcoex_sta->sco_exist = false;\n\n\t\tcoex_sta->bt_hi_pri_link_exist = false;\n\t} else {\n\t\t \n\t\tcoex_sta->bt_link_exist = true;\n\t\tif (bt_info & BT_INFO_8723B_1ANT_B_FTP) {\n\t\t\tcoex_sta->pan_exist = true;\n\t\t\tcoex_sta->num_of_profile++;\n\t\t} else {\n\t\t\tcoex_sta->pan_exist = false;\n\t\t}\n\t\tif (bt_info & BT_INFO_8723B_1ANT_B_A2DP) {\n\t\t\tcoex_sta->a2dp_exist = true;\n\t\t\tcoex_sta->num_of_profile++;\n\t\t} else {\n\t\t\tcoex_sta->a2dp_exist = false;\n\t\t}\n\t\tif (bt_info & BT_INFO_8723B_1ANT_B_HID) {\n\t\t\tcoex_sta->hid_exist = true;\n\t\t\tcoex_sta->num_of_profile++;\n\t\t} else {\n\t\t\tcoex_sta->hid_exist = false;\n\t\t}\n\t\tif (bt_info & BT_INFO_8723B_1ANT_B_SCO_ESCO) {\n\t\t\tcoex_sta->sco_exist = true;\n\t\t\tcoex_sta->num_of_profile++;\n\t\t} else {\n\t\t\tcoex_sta->sco_exist = false;\n\t\t}\n\n\t\tif ((!coex_sta->hid_exist) &&\n\t\t    (!coex_sta->c2h_bt_inquiry_page) &&\n\t\t    (!coex_sta->sco_exist)) {\n\t\t\tif (coex_sta->high_priority_tx +\n\t\t\t\t    coex_sta->high_priority_rx >=\n\t\t\t    160) {\n\t\t\t\tcoex_sta->hid_exist = true;\n\t\t\t\tcoex_sta->wrong_profile_notification++;\n\t\t\t\tcoex_sta->num_of_profile++;\n\t\t\t\tbt_info = bt_info | 0x28;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tif (((coex_sta->hid_exist) || (coex_sta->sco_exist)) &&\n\t\t    (coex_sta->high_priority_tx + coex_sta->high_priority_rx >=\n\t\t     160) &&\n\t\t    (!coex_sta->c2h_bt_inquiry_page))\n\t\t\tcoex_sta->bt_hi_pri_link_exist = true;\n\n\t\tif ((bt_info & BT_INFO_8723B_1ANT_B_ACL_BUSY) &&\n\t\t    (coex_sta->num_of_profile == 0)) {\n\t\t\tif (coex_sta->low_priority_tx +\n\t\t\t\t    coex_sta->low_priority_rx >=\n\t\t\t    160) {\n\t\t\t\tcoex_sta->pan_exist = true;\n\t\t\t\tcoex_sta->num_of_profile++;\n\t\t\t\tcoex_sta->wrong_profile_notification++;\n\t\t\t\tbt_info = bt_info | 0x88;\n\t\t\t}\n\t\t}\n\t}\n\n\thalbtc8723b1ant_update_bt_link_info(btcoexist);\n\n\t \n\tbt_info = bt_info & 0x1f;\n\n\tif (!(bt_info & BT_INFO_8723B_1ANT_B_CONNECTION)) {\n\t\tcoex_dm->bt_status = BT_8723B_1ANT_BT_STATUS_NON_CONNECTED_IDLE;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], BtInfoNotify(), BT Non-Connected idle!\\n\");\n\t \n\t} else if (bt_info == BT_INFO_8723B_1ANT_B_CONNECTION) {\n\t\tcoex_dm->bt_status = BT_8723B_1ANT_BT_STATUS_CONNECTED_IDLE;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], BtInfoNotify(), BT Connected-idle!!!\\n\");\n\t} else if ((bt_info & BT_INFO_8723B_1ANT_B_SCO_ESCO) ||\n\t\t(bt_info & BT_INFO_8723B_1ANT_B_SCO_BUSY)) {\n\t\tcoex_dm->bt_status = BT_8723B_1ANT_BT_STATUS_SCO_BUSY;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], BtInfoNotify(), BT SCO busy!!!\\n\");\n\t} else if (bt_info & BT_INFO_8723B_1ANT_B_ACL_BUSY) {\n\t\tif (BT_8723B_1ANT_BT_STATUS_ACL_BUSY != coex_dm->bt_status)\n\t\t\tcoex_dm->auto_tdma_adjust = false;\n\n\t\tcoex_dm->bt_status = BT_8723B_1ANT_BT_STATUS_ACL_BUSY;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], BtInfoNotify(), BT ACL busy!!!\\n\");\n\t} else {\n\t\tcoex_dm->bt_status = BT_8723B_1ANT_BT_STATUS_MAX;\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], BtInfoNotify(), BT Non-Defined state!!\\n\");\n\t}\n\n\tif ((BT_8723B_1ANT_BT_STATUS_ACL_BUSY == coex_dm->bt_status) ||\n\t    (BT_8723B_1ANT_BT_STATUS_SCO_BUSY == coex_dm->bt_status) ||\n\t    (BT_8723B_1ANT_BT_STATUS_ACL_SCO_BUSY == coex_dm->bt_status))\n\t\tbt_busy = true;\n\telse\n\t\tbt_busy = false;\n\tbtcoexist->btc_set(btcoexist, BTC_SET_BL_BT_TRAFFIC_BUSY, &bt_busy);\n\n\thalbtc8723b1ant_run_coexist_mechanism(btcoexist);\n}\n\nvoid ex_btc8723b1ant_rf_status_notify(struct btc_coexist *btcoexist, u8 type)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tu32 u32tmp;\n\tu8 u8tmpa, u8tmpb, u8tmpc;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], RF Status notify\\n\");\n\n\tif (type == BTC_RF_ON) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], RF is turned ON!!\\n\");\n\t\tbtcoexist->stop_coex_dm = false;\n\t} else if (type == BTC_RF_OFF) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], RF is turned OFF!!\\n\");\n\n\t\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t\t 0x0, 0x0);\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, FORCE_EXEC, false, 0);\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_BT,\n\t\t\t\t\t     FORCE_EXEC, false, true);\n\n\t\thalbtc8723b1ant_ignore_wlan_act(btcoexist, FORCE_EXEC, true);\n\t\tbtcoexist->stop_coex_dm = true;\n\n\t\tu32tmp = btcoexist->btc_read_4byte(btcoexist, 0x948);\n\t\tu8tmpa = btcoexist->btc_read_1byte(btcoexist, 0x765);\n\t\tu8tmpb = btcoexist->btc_read_1byte(btcoexist, 0x67);\n\t\tu8tmpc = btcoexist->btc_read_1byte(btcoexist, 0x76e);\n\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"############# [BTCoex], 0x948=0x%x, 0x765=0x%x, 0x67=0x%x, 0x76e=0x%x\\n\",\n\t\t\tu32tmp, u8tmpa, u8tmpb, u8tmpc);\n\t}\n}\n\nvoid ex_btc8723b1ant_halt_notify(struct btc_coexist *btcoexist)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD, \"[BTCoex], Halt notify\\n\");\n\n\tbtcoexist->stop_coex_dm = true;\n\n\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_BT, FORCE_EXEC,\n\t\t\t\t     false, true);\n\n\thalbtc8723b1ant_ignore_wlan_act(btcoexist, FORCE_EXEC, true);\n\n\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t 0x0, 0x0);\n\thalbtc8723b1ant_ps_tdma(btcoexist, FORCE_EXEC, false, 0);\n\n\tex_btc8723b1ant_media_status_notify(btcoexist, BTC_MEDIA_DISCONNECT);\n\n\tbtcoexist->stop_coex_dm = true;\n}\n\nvoid ex_btc8723b1ant_pnp_notify(struct btc_coexist *btcoexist, u8 pnp_state)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD, \"[BTCoex], Pnp notify\\n\");\n\n\tif (BTC_WIFI_PNP_SLEEP == pnp_state) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], Pnp notify to SLEEP\\n\");\n\t\thalbtc8723b1ant_set_ant_path(btcoexist, BTC_ANT_PATH_BT,\n\t\t\t\t\t     FORCE_EXEC, false, true);\n\t\thalbtc8723b1ant_power_save_state(btcoexist, BTC_PS_WIFI_NATIVE,\n\t\t\t\t\t\t 0x0, 0x0);\n\t\thalbtc8723b1ant_ps_tdma(btcoexist, NORMAL_EXEC, false, 0);\n\t\thalbtc8723b1ant_coex_table_with_type(btcoexist, NORMAL_EXEC, 2);\n\n\t\t \n\t\tcoex_sta->under_ips = false;\n\t\tcoex_sta->under_lps = false;\n\t\tbtcoexist->stop_coex_dm = true;\n\t} else if (BTC_WIFI_PNP_WAKE_UP == pnp_state) {\n\t\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\t\"[BTCoex], Pnp notify to WAKE UP\\n\");\n\t\tbtcoexist->stop_coex_dm = false;\n\t\thalbtc8723b1ant_init_hw_config(btcoexist, false, false);\n\t\thalbtc8723b1ant_init_coex_dm(btcoexist);\n\t\thalbtc8723b1ant_query_bt_info(btcoexist);\n\t}\n}\n\nvoid ex_btc8723b1ant_coex_dm_reset(struct btc_coexist *btcoexist)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], *****************Coex DM Reset****************\\n\");\n\n\thalbtc8723b1ant_init_hw_config(btcoexist, false, false);\n\thalbtc8723b1ant_init_coex_dm(btcoexist);\n}\n\nvoid ex_btc8723b1ant_periodical(struct btc_coexist *btcoexist)\n{\n\tstruct rtl_priv *rtlpriv = btcoexist->adapter;\n\tstruct btc_bt_link_info *bt_link_info = &btcoexist->bt_link_info;\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"[BTCoex], ==========================Periodical===========================\\n\");\n\n\tif (!btcoexist->auto_report_1ant) {\n\t\thalbtc8723b1ant_query_bt_info(btcoexist);\n\t\thalbtc8723b1ant_monitor_bt_enable_disable(btcoexist);\n\t} else {\n\t\thalbtc8723b1ant_monitor_bt_ctr(btcoexist);\n\t\thalbtc8723b1ant_monitor_wifi_ctr(btcoexist);\n\n\t\tif ((coex_sta->high_priority_tx + coex_sta->high_priority_rx < 50) &&\n\t\t    bt_link_info->hid_exist)\n\t\t\tbt_link_info->hid_exist = false;\n\n\t\tif (btc8723b1ant_is_wifi_status_changed(btcoexist) ||\n\t\t    coex_dm->auto_tdma_adjust) {\n\t\t\thalbtc8723b1ant_run_coexist_mechanism(btcoexist);\n\t\t}\n\t\tcoex_sta->special_pkt_period_cnt++;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}