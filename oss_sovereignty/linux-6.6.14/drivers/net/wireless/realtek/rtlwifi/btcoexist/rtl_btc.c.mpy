{
  "module_name": "rtl_btc.c",
  "hash_id": "d9eb902cae7e46c01d3ddea7349fb47ea4dff57d3d1684bfbba854b7c2ad7f94",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/wireless/realtek/rtlwifi/btcoexist/rtl_btc.c",
  "human_readable_source": "\n \n\n#include \"../wifi.h\"\n#include <linux/vmalloc.h>\n#include <linux/module.h>\n\n#include \"rtl_btc.h\"\n#include \"halbt_precomp.h\"\n\nstatic struct rtl_btc_ops rtl_btc_operation = {\n\t.btc_init_variables = rtl_btc_init_variables,\n\t.btc_init_variables_wifi_only = rtl_btc_init_variables_wifi_only,\n\t.btc_deinit_variables = rtl_btc_deinit_variables,\n\t.btc_init_hal_vars = rtl_btc_init_hal_vars,\n\t.btc_power_on_setting = rtl_btc_power_on_setting,\n\t.btc_init_hw_config = rtl_btc_init_hw_config,\n\t.btc_init_hw_config_wifi_only = rtl_btc_init_hw_config_wifi_only,\n\t.btc_ips_notify = rtl_btc_ips_notify,\n\t.btc_lps_notify = rtl_btc_lps_notify,\n\t.btc_scan_notify = rtl_btc_scan_notify,\n\t.btc_scan_notify_wifi_only = rtl_btc_scan_notify_wifi_only,\n\t.btc_connect_notify = rtl_btc_connect_notify,\n\t.btc_mediastatus_notify = rtl_btc_mediastatus_notify,\n\t.btc_periodical = rtl_btc_periodical,\n\t.btc_halt_notify = rtl_btc_halt_notify,\n\t.btc_btinfo_notify = rtl_btc_btinfo_notify,\n\t.btc_btmpinfo_notify = rtl_btc_btmpinfo_notify,\n\t.btc_is_limited_dig = rtl_btc_is_limited_dig,\n\t.btc_is_disable_edca_turbo = rtl_btc_is_disable_edca_turbo,\n\t.btc_is_bt_disabled = rtl_btc_is_bt_disabled,\n\t.btc_special_packet_notify = rtl_btc_special_packet_notify,\n\t.btc_switch_band_notify = rtl_btc_switch_band_notify,\n\t.btc_switch_band_notify_wifi_only = rtl_btc_switch_band_notify_wifionly,\n\t.btc_record_pwr_mode = rtl_btc_record_pwr_mode,\n\t.btc_get_lps_val = rtl_btc_get_lps_val,\n\t.btc_get_rpwm_val = rtl_btc_get_rpwm_val,\n\t.btc_is_bt_ctrl_lps = rtl_btc_is_bt_ctrl_lps,\n\t.btc_is_bt_lps_on = rtl_btc_is_bt_lps_on,\n\t.btc_get_ampdu_cfg = rtl_btc_get_ampdu_cfg,\n\t.btc_display_bt_coex_info = rtl_btc_display_bt_coex_info,\n};\n\nvoid rtl_btc_display_bt_coex_info(struct rtl_priv *rtlpriv, struct seq_file *m)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist) {\n\t\tseq_puts(m, \"btc_coexist context is NULL!\\n\");\n\t\treturn;\n\t}\n\n\texhalbtc_display_bt_coex_info(btcoexist, m);\n}\n\nvoid rtl_btc_record_pwr_mode(struct rtl_priv *rtlpriv, u8 *buf, u8 len)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\tu8 safe_len;\n\n\tif (!btcoexist)\n\t\treturn;\n\n\tsafe_len = sizeof(btcoexist->pwr_mode_val);\n\n\tif (safe_len > len)\n\t\tsafe_len = len;\n\n\tmemcpy(btcoexist->pwr_mode_val, buf, safe_len);\n}\n\nu8 rtl_btc_get_lps_val(struct rtl_priv *rtlpriv)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn 0;\n\n\treturn btcoexist->bt_info.lps_val;\n}\n\nu8 rtl_btc_get_rpwm_val(struct rtl_priv *rtlpriv)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn 0;\n\n\treturn btcoexist->bt_info.rpwm_val;\n}\n\nbool rtl_btc_is_bt_ctrl_lps(struct rtl_priv *rtlpriv)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn false;\n\n\treturn btcoexist->bt_info.bt_ctrl_lps;\n}\n\nbool rtl_btc_is_bt_lps_on(struct rtl_priv *rtlpriv)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn false;\n\n\treturn btcoexist->bt_info.bt_lps_on;\n}\n\nvoid rtl_btc_get_ampdu_cfg(struct rtl_priv *rtlpriv, u8 *reject_agg,\n\t\t\t   u8 *ctrl_agg_size, u8 *agg_size)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist) {\n\t\t*reject_agg = false;\n\t\t*ctrl_agg_size = false;\n\t\treturn;\n\t}\n\n\tif (reject_agg)\n\t\t*reject_agg = btcoexist->bt_info.reject_agg_pkt;\n\tif (ctrl_agg_size)\n\t\t*ctrl_agg_size = btcoexist->bt_info.bt_ctrl_agg_buf_size;\n\tif (agg_size)\n\t\t*agg_size = btcoexist->bt_info.agg_buf_size;\n}\n\nstatic void rtl_btc_alloc_variable(struct rtl_priv *rtlpriv, bool wifi_only)\n{\n\tif (wifi_only)\n\t\trtlpriv->btcoexist.wifi_only_context =\n\t\t\tkzalloc(sizeof(struct wifi_only_cfg), GFP_KERNEL);\n\telse\n\t\trtlpriv->btcoexist.btc_context =\n\t\t\tkzalloc(sizeof(struct btc_coexist), GFP_KERNEL);\n}\n\nstatic void rtl_btc_free_variable(struct rtl_priv *rtlpriv)\n{\n\tkfree(rtlpriv->btcoexist.btc_context);\n\trtlpriv->btcoexist.btc_context = NULL;\n\n\tkfree(rtlpriv->btcoexist.wifi_only_context);\n\trtlpriv->btcoexist.wifi_only_context = NULL;\n}\n\nvoid rtl_btc_init_variables(struct rtl_priv *rtlpriv)\n{\n\trtl_btc_alloc_variable(rtlpriv, false);\n\n\texhalbtc_initlize_variables(rtlpriv);\n\texhalbtc_bind_bt_coex_withadapter(rtlpriv);\n}\n\nvoid rtl_btc_init_variables_wifi_only(struct rtl_priv *rtlpriv)\n{\n\trtl_btc_alloc_variable(rtlpriv, true);\n\n\texhalbtc_initlize_variables_wifi_only(rtlpriv);\n}\n\nvoid rtl_btc_deinit_variables(struct rtl_priv *rtlpriv)\n{\n\trtl_btc_free_variable(rtlpriv);\n}\n\nvoid rtl_btc_init_hal_vars(struct rtl_priv *rtlpriv)\n{\n\t \n}\n\nvoid rtl_btc_power_on_setting(struct rtl_priv *rtlpriv)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\texhalbtc_power_on_setting(btcoexist);\n}\n\nvoid rtl_btc_init_hw_config(struct rtl_priv *rtlpriv)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tu8 bt_exist;\n\n\tbt_exist = rtl_get_hwpg_bt_exist(rtlpriv);\n\trtl_dbg(rtlpriv, COMP_INIT, DBG_DMESG,\n\t\t\"%s, bt_exist is %d\\n\", __func__, bt_exist);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\texhalbtc_init_hw_config(btcoexist, !bt_exist);\n\texhalbtc_init_coex_dm(btcoexist);\n}\n\nvoid rtl_btc_init_hw_config_wifi_only(struct rtl_priv *rtlpriv)\n{\n\tstruct wifi_only_cfg *wifionly_cfg = rtl_btc_wifi_only(rtlpriv);\n\n\tif (!wifionly_cfg)\n\t\treturn;\n\n\texhalbtc_init_hw_config_wifi_only(wifionly_cfg);\n}\n\nvoid rtl_btc_ips_notify(struct rtl_priv *rtlpriv, u8 type)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\texhalbtc_ips_notify(btcoexist, type);\n\n\tif (type == ERFON) {\n\t\t \n\t\texhalbtc_scan_notify(btcoexist, 1);\n\t\texhalbtc_scan_notify(btcoexist, 0);\n\t}\n}\n\nvoid rtl_btc_lps_notify(struct rtl_priv *rtlpriv, u8 type)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\texhalbtc_lps_notify(btcoexist, type);\n}\n\nvoid rtl_btc_scan_notify(struct rtl_priv *rtlpriv, u8 scantype)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\texhalbtc_scan_notify(btcoexist, scantype);\n}\n\nvoid rtl_btc_scan_notify_wifi_only(struct rtl_priv *rtlpriv, u8 scantype)\n{\n\tstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\n\tstruct wifi_only_cfg *wifionly_cfg = rtl_btc_wifi_only(rtlpriv);\n\tu8 is_5g = (rtlhal->current_bandtype == BAND_ON_5G);\n\n\tif (!wifionly_cfg)\n\t\treturn;\n\n\texhalbtc_scan_notify_wifi_only(wifionly_cfg, is_5g);\n}\n\nvoid rtl_btc_connect_notify(struct rtl_priv *rtlpriv, u8 action)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\texhalbtc_connect_notify(btcoexist, action);\n}\n\nvoid rtl_btc_mediastatus_notify(struct rtl_priv *rtlpriv,\n\t\t\t\tenum rt_media_status mstatus)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\texhalbtc_mediastatus_notify(btcoexist, mstatus);\n}\n\nvoid rtl_btc_periodical(struct rtl_priv *rtlpriv)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\t \n\texhalbtc_periodical(btcoexist);\n}\n\nvoid rtl_btc_halt_notify(struct rtl_priv *rtlpriv)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\texhalbtc_halt_notify(btcoexist);\n}\n\nvoid rtl_btc_btinfo_notify(struct rtl_priv *rtlpriv, u8 *tmp_buf, u8 length)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\texhalbtc_bt_info_notify(btcoexist, tmp_buf, length);\n}\n\nvoid rtl_btc_btmpinfo_notify(struct rtl_priv *rtlpriv, u8 *tmp_buf, u8 length)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\tu8 extid, seq;\n\tu16 bt_real_fw_ver;\n\tu8 bt_fw_ver;\n\tu8 *data;\n\n\tif (!btcoexist)\n\t\treturn;\n\n\tif ((length < 4) || (!tmp_buf))\n\t\treturn;\n\n\textid = tmp_buf[0];\n\t \n\tif (extid != 1)  \n\t\treturn;\n\n\tseq = tmp_buf[2] >> 4;\n\tdata = &tmp_buf[3];\n\n\t \n\tswitch (seq) {\n\tcase BT_SEQ_GET_BT_VERSION:\n\t\tbt_real_fw_ver = tmp_buf[3] | (tmp_buf[4] << 8);\n\t\tbt_fw_ver = tmp_buf[5];\n\n\t\tbtcoexist->bt_info.bt_real_fw_ver = bt_real_fw_ver;\n\t\tbtcoexist->bt_info.bt_fw_ver = bt_fw_ver;\n\t\tbreak;\n\tcase BT_SEQ_GET_AFH_MAP_L:\n\t\tbtcoexist->bt_info.afh_map_l = le32_to_cpu(*(__le32 *)data);\n\t\tbreak;\n\tcase BT_SEQ_GET_AFH_MAP_M:\n\t\tbtcoexist->bt_info.afh_map_m = le32_to_cpu(*(__le32 *)data);\n\t\tbreak;\n\tcase BT_SEQ_GET_AFH_MAP_H:\n\t\tbtcoexist->bt_info.afh_map_h = le16_to_cpu(*(__le16 *)data);\n\t\tbreak;\n\tcase BT_SEQ_GET_BT_COEX_SUPPORTED_FEATURE:\n\t\tbtcoexist->bt_info.bt_supported_feature = tmp_buf[3] |\n\t\t\t\t\t\t\t  (tmp_buf[4] << 8);\n\t\tbreak;\n\tcase BT_SEQ_GET_BT_COEX_SUPPORTED_VERSION:\n\t\tbtcoexist->bt_info.bt_supported_version = tmp_buf[3] |\n\t\t\t\t\t\t\t  (tmp_buf[4] << 8);\n\t\tbreak;\n\tcase BT_SEQ_GET_BT_ANT_DET_VAL:\n\t\tbtcoexist->bt_info.bt_ant_det_val = tmp_buf[3];\n\t\tbreak;\n\tcase BT_SEQ_GET_BT_BLE_SCAN_PARA:\n\t\tbtcoexist->bt_info.bt_ble_scan_para = tmp_buf[3] |\n\t\t\t\t\t\t      (tmp_buf[4] << 8) |\n\t\t\t\t\t\t      (tmp_buf[5] << 16) |\n\t\t\t\t\t\t      (tmp_buf[6] << 24);\n\t\tbreak;\n\tcase BT_SEQ_GET_BT_BLE_SCAN_TYPE:\n\t\tbtcoexist->bt_info.bt_ble_scan_type = tmp_buf[3];\n\t\tbreak;\n\tcase BT_SEQ_GET_BT_DEVICE_INFO:\n\t\tbtcoexist->bt_info.bt_device_info =\n\t\t\t\t\t\tle32_to_cpu(*(__le32 *)data);\n\t\tbreak;\n\tcase BT_OP_GET_BT_FORBIDDEN_SLOT_VAL:\n\t\tbtcoexist->bt_info.bt_forb_slot_val =\n\t\t\t\t\t\tle32_to_cpu(*(__le32 *)data);\n\t\tbreak;\n\t}\n\n\trtl_dbg(rtlpriv, COMP_BT_COEXIST, DBG_LOUD,\n\t\t\"btmpinfo complete req_num=%d\\n\", seq);\n\n\tcomplete(&btcoexist->bt_mp_comp);\n}\n\nbool rtl_btc_is_limited_dig(struct rtl_priv *rtlpriv)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn false;\n\n\treturn btcoexist->bt_info.limited_dig;\n}\n\nbool rtl_btc_is_disable_edca_turbo(struct rtl_priv *rtlpriv)\n{\n\tbool bt_change_edca = false;\n\tu32 cur_edca_val;\n\tu32 edca_bt_hs_uplink = 0x5ea42b, edca_bt_hs_downlink = 0x5ea42b;\n\tu32 edca_hs;\n\tu32 edca_addr = 0x504;\n\n\tcur_edca_val = rtl_read_dword(rtlpriv, edca_addr);\n\tif (halbtc_is_wifi_uplink(rtlpriv)) {\n\t\tif (cur_edca_val != edca_bt_hs_uplink) {\n\t\t\tedca_hs = edca_bt_hs_uplink;\n\t\t\tbt_change_edca = true;\n\t\t}\n\t} else {\n\t\tif (cur_edca_val != edca_bt_hs_downlink) {\n\t\t\tedca_hs = edca_bt_hs_downlink;\n\t\t\tbt_change_edca = true;\n\t\t}\n\t}\n\n\tif (bt_change_edca)\n\t\trtl_write_dword(rtlpriv, edca_addr, edca_hs);\n\n\treturn true;\n}\n\nbool rtl_btc_is_bt_disabled(struct rtl_priv *rtlpriv)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn true;\n\n\t \n\tif (btcoexist->bt_info.bt_disabled)\n\t\treturn true;\n\telse\n\t\treturn false;\n}\n\nvoid rtl_btc_special_packet_notify(struct rtl_priv *rtlpriv, u8 pkt_type)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\n\tif (!btcoexist)\n\t\treturn;\n\n\treturn exhalbtc_special_packet_notify(btcoexist, pkt_type);\n}\n\nvoid rtl_btc_switch_band_notify(struct rtl_priv *rtlpriv, u8 band_type,\n\t\t\t\tbool scanning)\n{\n\tstruct btc_coexist *btcoexist = rtl_btc_coexist(rtlpriv);\n\tu8 type = BTC_NOT_SWITCH;\n\n\tif (!btcoexist)\n\t\treturn;\n\n\tswitch (band_type) {\n\tcase BAND_ON_2_4G:\n\t\tif (scanning)\n\t\t\ttype = BTC_SWITCH_TO_24G;\n\t\telse\n\t\t\ttype = BTC_SWITCH_TO_24G_NOFORSCAN;\n\t\tbreak;\n\n\tcase BAND_ON_5G:\n\t\ttype = BTC_SWITCH_TO_5G;\n\t\tbreak;\n\t}\n\n\tif (type != BTC_NOT_SWITCH)\n\t\texhalbtc_switch_band_notify(btcoexist, type);\n}\n\nvoid rtl_btc_switch_band_notify_wifionly(struct rtl_priv *rtlpriv, u8 band_type,\n\t\t\t\t\t bool scanning)\n{\n\tstruct wifi_only_cfg *wifionly_cfg = rtl_btc_wifi_only(rtlpriv);\n\tu8 is_5g = (band_type == BAND_ON_5G);\n\n\tif (!wifionly_cfg)\n\t\treturn;\n\n\texhalbtc_switch_band_notify_wifi_only(wifionly_cfg, is_5g);\n}\n\nstruct rtl_btc_ops *rtl_btc_get_ops_pointer(void)\n{\n\treturn &rtl_btc_operation;\n}\nEXPORT_SYMBOL(rtl_btc_get_ops_pointer);\n\n\nenum rt_media_status mgnt_link_status_query(struct ieee80211_hw *hw)\n{\n\tstruct rtl_priv *rtlpriv = rtl_priv(hw);\n\tstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\n\tenum rt_media_status    m_status = RT_MEDIA_DISCONNECT;\n\n\tu8 bibss = (mac->opmode == NL80211_IFTYPE_ADHOC) ? 1 : 0;\n\n\tif (bibss || rtlpriv->mac80211.link_state >= MAC80211_LINKED)\n\t\tm_status = RT_MEDIA_CONNECT;\n\n\treturn m_status;\n}\n\nu8 rtl_get_hwpg_bt_exist(struct rtl_priv *rtlpriv)\n{\n\treturn rtlpriv->btcoexist.btc_info.btcoexist;\n}\n\nMODULE_AUTHOR(\"Page He\t<page_he@realsil.com.cn>\");\nMODULE_AUTHOR(\"Realtek WlanFAE\t<wlanfae@realtek.com>\");\nMODULE_AUTHOR(\"Larry Finger\t<Larry.FInger@lwfinger.net>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"Realtek 802.11n PCI wireless core\");\n\nstatic int __init rtl_btcoexist_module_init(void)\n{\n\treturn 0;\n}\n\nstatic void __exit rtl_btcoexist_module_exit(void)\n{\n\treturn;\n}\n\nmodule_init(rtl_btcoexist_module_init);\nmodule_exit(rtl_btcoexist_module_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}