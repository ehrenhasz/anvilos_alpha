{
  "module_name": "mdio-mvusb.c",
  "hash_id": "8852cbe432ac1c3ed515a8f27379f57888a7d673c05f3fb98b3b4e10bd2f0987",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/mdio/mdio-mvusb.c",
  "human_readable_source": "\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of_mdio.h>\n#include <linux/phy.h>\n#include <linux/usb.h>\n\n#define USB_MARVELL_VID\t0x1286\n\nstatic const struct usb_device_id mvusb_mdio_table[] = {\n\t{ USB_DEVICE(USB_MARVELL_VID, 0x1fa4) },\n\n\t{}\n};\nMODULE_DEVICE_TABLE(usb, mvusb_mdio_table);\n\nenum {\n\tMVUSB_CMD_PREAMBLE0,\n\tMVUSB_CMD_PREAMBLE1,\n\tMVUSB_CMD_ADDR,\n\tMVUSB_CMD_VAL,\n};\n\nstruct mvusb_mdio {\n\tstruct usb_device *udev;\n\tstruct mii_bus *mdio;\n\n\t__le16 buf[4];\n};\n\nstatic int mvusb_mdio_read(struct mii_bus *mdio, int dev, int reg)\n{\n\tstruct mvusb_mdio *mvusb = mdio->priv;\n\tint err, alen;\n\n\tmvusb->buf[MVUSB_CMD_ADDR] = cpu_to_le16(0xa400 | (dev << 5) | reg);\n\n\terr = usb_bulk_msg(mvusb->udev, usb_sndbulkpipe(mvusb->udev, 2),\n\t\t\t   mvusb->buf, 6, &alen, 100);\n\tif (err)\n\t\treturn err;\n\n\terr = usb_bulk_msg(mvusb->udev, usb_rcvbulkpipe(mvusb->udev, 6),\n\t\t\t   &mvusb->buf[MVUSB_CMD_VAL], 2, &alen, 100);\n\tif (err)\n\t\treturn err;\n\n\treturn le16_to_cpu(mvusb->buf[MVUSB_CMD_VAL]);\n}\n\nstatic int mvusb_mdio_write(struct mii_bus *mdio, int dev, int reg, u16 val)\n{\n\tstruct mvusb_mdio *mvusb = mdio->priv;\n\tint alen;\n\n\tmvusb->buf[MVUSB_CMD_ADDR] = cpu_to_le16(0x8000 | (dev << 5) | reg);\n\tmvusb->buf[MVUSB_CMD_VAL]  = cpu_to_le16(val);\n\n\treturn usb_bulk_msg(mvusb->udev, usb_sndbulkpipe(mvusb->udev, 2),\n\t\t\t    mvusb->buf, 8, &alen, 100);\n}\n\nstatic int mvusb_mdio_probe(struct usb_interface *interface,\n\t\t\t    const struct usb_device_id *id)\n{\n\tstruct device *dev = &interface->dev;\n\tstruct mvusb_mdio *mvusb;\n\tstruct mii_bus *mdio;\n\tint ret;\n\n\tmdio = devm_mdiobus_alloc_size(dev, sizeof(*mvusb));\n\tif (!mdio)\n\t\treturn -ENOMEM;\n\n\tmvusb = mdio->priv;\n\tmvusb->mdio = mdio;\n\tmvusb->udev = usb_get_dev(interface_to_usbdev(interface));\n\n\t \n\tmvusb->buf[MVUSB_CMD_PREAMBLE0] = cpu_to_le16(0xe800);\n\tmvusb->buf[MVUSB_CMD_PREAMBLE1] = cpu_to_le16(0x0001);\n\n\tsnprintf(mdio->id, MII_BUS_ID_SIZE, \"mvusb-%s\", dev_name(dev));\n\tmdio->name = mdio->id;\n\tmdio->parent = dev;\n\tmdio->read = mvusb_mdio_read;\n\tmdio->write = mvusb_mdio_write;\n\n\tusb_set_intfdata(interface, mvusb);\n\tret = of_mdiobus_register(mdio, dev->of_node);\n\tif (ret)\n\t\tgoto put_dev;\n\n\treturn 0;\n\nput_dev:\n\tusb_put_dev(mvusb->udev);\n\treturn ret;\n}\n\nstatic void mvusb_mdio_disconnect(struct usb_interface *interface)\n{\n\tstruct mvusb_mdio *mvusb = usb_get_intfdata(interface);\n\tstruct usb_device *udev = mvusb->udev;\n\n\tmdiobus_unregister(mvusb->mdio);\n\tusb_set_intfdata(interface, NULL);\n\tusb_put_dev(udev);\n}\n\nstatic struct usb_driver mvusb_mdio_driver = {\n\t.name       = \"mvusb_mdio\",\n\t.id_table   = mvusb_mdio_table,\n\t.probe      = mvusb_mdio_probe,\n\t.disconnect = mvusb_mdio_disconnect,\n};\n\nmodule_usb_driver(mvusb_mdio_driver);\n\nMODULE_AUTHOR(\"Tobias Waldekranz <tobias@waldekranz.com>\");\nMODULE_DESCRIPTION(\"Marvell USB MDIO Adapter\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}