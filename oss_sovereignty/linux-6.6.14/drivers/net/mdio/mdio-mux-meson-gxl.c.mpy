{
  "module_name": "mdio-mux-meson-gxl.c",
  "hash_id": "aa4d16a41c4e3eaae356d3ce451681fa071f8589f9277527de610effc8e2c39a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/mdio/mdio-mux-meson-gxl.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/delay.h>\n#include <linux/clk.h>\n#include <linux/io.h>\n#include <linux/mdio-mux.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n\n#define ETH_REG2\t\t0x0\n#define  REG2_PHYID\t\tGENMASK(21, 0)\n#define   EPHY_GXL_ID\t\t0x110181\n#define  REG2_LEDACT\t\tGENMASK(23, 22)\n#define  REG2_LEDLINK\t\tGENMASK(25, 24)\n#define  REG2_DIV4SEL\t\tBIT(27)\n#define  REG2_ADCBYPASS\t\tBIT(30)\n#define  REG2_CLKINSEL\t\tBIT(31)\n#define ETH_REG3\t\t0x4\n#define  REG3_ENH\t\tBIT(3)\n#define  REG3_CFGMODE\t\tGENMASK(6, 4)\n#define  REG3_AUTOMDIX\t\tBIT(7)\n#define  REG3_PHYADDR\t\tGENMASK(12, 8)\n#define  REG3_PWRUPRST\t\tBIT(21)\n#define  REG3_PWRDOWN\t\tBIT(22)\n#define  REG3_LEDPOL\t\tBIT(23)\n#define  REG3_PHYMDI\t\tBIT(26)\n#define  REG3_CLKINEN\t\tBIT(29)\n#define  REG3_PHYIP\t\tBIT(30)\n#define  REG3_PHYEN\t\tBIT(31)\n#define ETH_REG4\t\t0x8\n#define  REG4_PWRUPRSTSIG\tBIT(0)\n\n#define MESON_GXL_MDIO_EXTERNAL_ID 0\n#define MESON_GXL_MDIO_INTERNAL_ID 1\n\nstruct gxl_mdio_mux {\n\tvoid __iomem *regs;\n\tvoid *mux_handle;\n};\n\nstatic void gxl_enable_internal_mdio(struct gxl_mdio_mux *priv)\n{\n\tu32 val;\n\n\t \n\tval = (REG3_ENH |\n\t       FIELD_PREP(REG3_CFGMODE, 0x7) |\n\t       REG3_AUTOMDIX |\n\t       FIELD_PREP(REG3_PHYADDR, 8) |\n\t       REG3_LEDPOL |\n\t       REG3_PHYMDI |\n\t       REG3_CLKINEN |\n\t       REG3_PHYIP);\n\n\twritel(REG4_PWRUPRSTSIG, priv->regs + ETH_REG4);\n\twritel(val, priv->regs + ETH_REG3);\n\tmdelay(10);\n\n\t \n\twritel(FIELD_PREP(REG2_PHYID, EPHY_GXL_ID),\n\t       priv->regs + ETH_REG2);\n\n\t \n\tval |= REG3_PHYEN;\n\twritel(val, priv->regs + ETH_REG3);\n\twritel(0, priv->regs + ETH_REG4);\n\n\t \n\tmdelay(10);\n}\n\nstatic void gxl_enable_external_mdio(struct gxl_mdio_mux *priv)\n{\n\t \n\twritel(0, priv->regs + ETH_REG3);\n}\n\nstatic int gxl_mdio_switch_fn(int current_child, int desired_child,\n\t\t\t      void *data)\n{\n\tstruct gxl_mdio_mux *priv = dev_get_drvdata(data);\n\n\tif (current_child == desired_child)\n\t\treturn 0;\n\n\tswitch (desired_child) {\n\tcase MESON_GXL_MDIO_EXTERNAL_ID:\n\t\tgxl_enable_external_mdio(priv);\n\t\tbreak;\n\tcase MESON_GXL_MDIO_INTERNAL_ID:\n\t\tgxl_enable_internal_mdio(priv);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id gxl_mdio_mux_match[] = {\n\t{ .compatible = \"amlogic,gxl-mdio-mux\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, gxl_mdio_mux_match);\n\nstatic int gxl_mdio_mux_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct gxl_mdio_mux *priv;\n\tstruct clk *rclk;\n\tint ret;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\tplatform_set_drvdata(pdev, priv);\n\n\tpriv->regs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(priv->regs))\n\t\treturn PTR_ERR(priv->regs);\n\n\trclk = devm_clk_get_enabled(dev, \"ref\");\n\tif (IS_ERR(rclk))\n\t\treturn dev_err_probe(dev, PTR_ERR(rclk),\n\t\t\t\t     \"failed to get reference clock\\n\");\n\n\tret = mdio_mux_init(dev, dev->of_node, gxl_mdio_switch_fn,\n\t\t\t    &priv->mux_handle, dev, NULL);\n\tif (ret)\n\t\tdev_err_probe(dev, ret, \"mdio multiplexer init failed\\n\");\n\n\treturn ret;\n}\n\nstatic int gxl_mdio_mux_remove(struct platform_device *pdev)\n{\n\tstruct gxl_mdio_mux *priv = platform_get_drvdata(pdev);\n\n\tmdio_mux_uninit(priv->mux_handle);\n\n\treturn 0;\n}\n\nstatic struct platform_driver gxl_mdio_mux_driver = {\n\t.probe\t\t= gxl_mdio_mux_probe,\n\t.remove\t\t= gxl_mdio_mux_remove,\n\t.driver\t\t= {\n\t\t.name\t= \"gxl-mdio-mux\",\n\t\t.of_match_table = gxl_mdio_mux_match,\n\t},\n};\nmodule_platform_driver(gxl_mdio_mux_driver);\n\nMODULE_DESCRIPTION(\"Amlogic GXL MDIO multiplexer driver\");\nMODULE_AUTHOR(\"Jerome Brunet <jbrunet@baylibre.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}