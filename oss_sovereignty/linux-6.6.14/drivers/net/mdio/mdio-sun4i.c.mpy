{
  "module_name": "mdio-sun4i.c",
  "hash_id": "274040801c4ef6cc08b865a84f76752854d72f9a8ece66198d5f0a4e0ec475f3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/mdio/mdio-sun4i.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/of_address.h>\n#include <linux/of_mdio.h>\n#include <linux/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regulator/consumer.h>\n\n#define EMAC_MAC_MCMD_REG\t(0x00)\n#define EMAC_MAC_MADR_REG\t(0x04)\n#define EMAC_MAC_MWTD_REG\t(0x08)\n#define EMAC_MAC_MRDD_REG\t(0x0c)\n#define EMAC_MAC_MIND_REG\t(0x10)\n#define EMAC_MAC_SSRR_REG\t(0x14)\n\n#define MDIO_TIMEOUT\t\t(msecs_to_jiffies(100))\n\nstruct sun4i_mdio_data {\n\tvoid __iomem\t\t*membase;\n\tstruct regulator\t*regulator;\n};\n\nstatic int sun4i_mdio_read(struct mii_bus *bus, int mii_id, int regnum)\n{\n\tstruct sun4i_mdio_data *data = bus->priv;\n\tunsigned long timeout_jiffies;\n\tint value;\n\n\t \n\twritel((mii_id << 8) | regnum, data->membase + EMAC_MAC_MADR_REG);\n\t \n\twritel(0x1, data->membase + EMAC_MAC_MCMD_REG);\n\n\t \n\ttimeout_jiffies = jiffies + MDIO_TIMEOUT;\n\twhile (readl(data->membase + EMAC_MAC_MIND_REG) & 0x1) {\n\t\tif (time_is_before_jiffies(timeout_jiffies))\n\t\t\treturn -ETIMEDOUT;\n\t\tmsleep(1);\n\t}\n\n\t \n\twritel(0x0, data->membase + EMAC_MAC_MCMD_REG);\n\t \n\tvalue = readl(data->membase + EMAC_MAC_MRDD_REG);\n\n\treturn value;\n}\n\nstatic int sun4i_mdio_write(struct mii_bus *bus, int mii_id, int regnum,\n\t\t\t    u16 value)\n{\n\tstruct sun4i_mdio_data *data = bus->priv;\n\tunsigned long timeout_jiffies;\n\n\t \n\twritel((mii_id << 8) | regnum, data->membase + EMAC_MAC_MADR_REG);\n\t \n\twritel(0x1, data->membase + EMAC_MAC_MCMD_REG);\n\n\t \n\ttimeout_jiffies = jiffies + MDIO_TIMEOUT;\n\twhile (readl(data->membase + EMAC_MAC_MIND_REG) & 0x1) {\n\t\tif (time_is_before_jiffies(timeout_jiffies))\n\t\t\treturn -ETIMEDOUT;\n\t\tmsleep(1);\n\t}\n\n\t \n\twritel(0x0, data->membase + EMAC_MAC_MCMD_REG);\n\t \n\twritel(value, data->membase + EMAC_MAC_MWTD_REG);\n\n\treturn 0;\n}\n\nstatic int sun4i_mdio_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct mii_bus *bus;\n\tstruct sun4i_mdio_data *data;\n\tint ret;\n\n\tbus = mdiobus_alloc_size(sizeof(*data));\n\tif (!bus)\n\t\treturn -ENOMEM;\n\n\tbus->name = \"sun4i_mii_bus\";\n\tbus->read = &sun4i_mdio_read;\n\tbus->write = &sun4i_mdio_write;\n\tsnprintf(bus->id, MII_BUS_ID_SIZE, \"%s-mii\", dev_name(&pdev->dev));\n\tbus->parent = &pdev->dev;\n\n\tdata = bus->priv;\n\tdata->membase = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(data->membase)) {\n\t\tret = PTR_ERR(data->membase);\n\t\tgoto err_out_free_mdiobus;\n\t}\n\n\tdata->regulator = devm_regulator_get(&pdev->dev, \"phy\");\n\tif (IS_ERR(data->regulator)) {\n\t\tif (PTR_ERR(data->regulator) == -EPROBE_DEFER) {\n\t\t\tret = -EPROBE_DEFER;\n\t\t\tgoto err_out_free_mdiobus;\n\t\t}\n\n\t\tdev_info(&pdev->dev, \"no regulator found\\n\");\n\t\tdata->regulator = NULL;\n\t} else {\n\t\tret = regulator_enable(data->regulator);\n\t\tif (ret)\n\t\t\tgoto err_out_free_mdiobus;\n\t}\n\n\tret = of_mdiobus_register(bus, np);\n\tif (ret < 0)\n\t\tgoto err_out_disable_regulator;\n\n\tplatform_set_drvdata(pdev, bus);\n\n\treturn 0;\n\nerr_out_disable_regulator:\n\tif (data->regulator)\n\t\tregulator_disable(data->regulator);\nerr_out_free_mdiobus:\n\tmdiobus_free(bus);\n\treturn ret;\n}\n\nstatic int sun4i_mdio_remove(struct platform_device *pdev)\n{\n\tstruct mii_bus *bus = platform_get_drvdata(pdev);\n\tstruct sun4i_mdio_data *data = bus->priv;\n\n\tmdiobus_unregister(bus);\n\tif (data->regulator)\n\t\tregulator_disable(data->regulator);\n\tmdiobus_free(bus);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id sun4i_mdio_dt_ids[] = {\n\t{ .compatible = \"allwinner,sun4i-a10-mdio\" },\n\n\t \n\t{ .compatible = \"allwinner,sun4i-mdio\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, sun4i_mdio_dt_ids);\n\nstatic struct platform_driver sun4i_mdio_driver = {\n\t.probe = sun4i_mdio_probe,\n\t.remove = sun4i_mdio_remove,\n\t.driver = {\n\t\t.name = \"sun4i-mdio\",\n\t\t.of_match_table = sun4i_mdio_dt_ids,\n\t},\n};\n\nmodule_platform_driver(sun4i_mdio_driver);\n\nMODULE_DESCRIPTION(\"Allwinner EMAC MDIO interface driver\");\nMODULE_AUTHOR(\"Maxime Ripard <maxime.ripard@free-electrons.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}