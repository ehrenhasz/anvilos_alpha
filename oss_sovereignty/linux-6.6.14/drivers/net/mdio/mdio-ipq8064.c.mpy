{
  "module_name": "mdio-ipq8064.c",
  "hash_id": "8c00629457395372efc870ff784b5c5a037e34c0ab4e4c0dced636322c943539",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/mdio/mdio-ipq8064.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of_mdio.h>\n#include <linux/of_address.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n \n#define MII_ADDR_REG_ADDR\t\t\t0x10\n#define MII_BUSY\t\t\t\tBIT(0)\n#define MII_WRITE\t\t\t\tBIT(1)\n#define MII_CLKRANGE(x)\t\t\t\t((x) << 2)\n#define MII_CLKRANGE_60_100M\t\t\tMII_CLKRANGE(0)\n#define MII_CLKRANGE_100_150M\t\t\tMII_CLKRANGE(1)\n#define MII_CLKRANGE_20_35M\t\t\tMII_CLKRANGE(2)\n#define MII_CLKRANGE_35_60M\t\t\tMII_CLKRANGE(3)\n#define MII_CLKRANGE_150_250M\t\t\tMII_CLKRANGE(4)\n#define MII_CLKRANGE_250_300M\t\t\tMII_CLKRANGE(5)\n#define MII_CLKRANGE_MASK\t\t\tGENMASK(4, 2)\n#define MII_REG_SHIFT\t\t\t\t6\n#define MII_REG_MASK\t\t\t\tGENMASK(10, 6)\n#define MII_ADDR_SHIFT\t\t\t\t11\n#define MII_ADDR_MASK\t\t\t\tGENMASK(15, 11)\n\n#define MII_DATA_REG_ADDR\t\t\t0x14\n\n#define MII_MDIO_DELAY_USEC\t\t\t(1000)\n#define MII_MDIO_RETRY_MSEC\t\t\t(10)\n\nstruct ipq8064_mdio {\n\tstruct regmap *base;  \n};\n\nstatic int\nipq8064_mdio_wait_busy(struct ipq8064_mdio *priv)\n{\n\tu32 busy;\n\n\treturn regmap_read_poll_timeout(priv->base, MII_ADDR_REG_ADDR, busy,\n\t\t\t\t\t!(busy & MII_BUSY), MII_MDIO_DELAY_USEC,\n\t\t\t\t\tMII_MDIO_RETRY_MSEC * USEC_PER_MSEC);\n}\n\nstatic int\nipq8064_mdio_read(struct mii_bus *bus, int phy_addr, int reg_offset)\n{\n\tu32 miiaddr = MII_BUSY | MII_CLKRANGE_250_300M;\n\tstruct ipq8064_mdio *priv = bus->priv;\n\tu32 ret_val;\n\tint err;\n\n\tmiiaddr |= ((phy_addr << MII_ADDR_SHIFT) & MII_ADDR_MASK) |\n\t\t   ((reg_offset << MII_REG_SHIFT) & MII_REG_MASK);\n\n\tregmap_write(priv->base, MII_ADDR_REG_ADDR, miiaddr);\n\tusleep_range(10, 13);\n\n\terr = ipq8064_mdio_wait_busy(priv);\n\tif (err)\n\t\treturn err;\n\n\tregmap_read(priv->base, MII_DATA_REG_ADDR, &ret_val);\n\treturn (int)ret_val;\n}\n\nstatic int\nipq8064_mdio_write(struct mii_bus *bus, int phy_addr, int reg_offset, u16 data)\n{\n\tu32 miiaddr = MII_WRITE | MII_BUSY | MII_CLKRANGE_250_300M;\n\tstruct ipq8064_mdio *priv = bus->priv;\n\n\tregmap_write(priv->base, MII_DATA_REG_ADDR, data);\n\n\tmiiaddr |= ((phy_addr << MII_ADDR_SHIFT) & MII_ADDR_MASK) |\n\t\t   ((reg_offset << MII_REG_SHIFT) & MII_REG_MASK);\n\n\tregmap_write(priv->base, MII_ADDR_REG_ADDR, miiaddr);\n\n\t \n\tif (reg_offset == 31)\n\t\tusleep_range(30, 43);\n\telse\n\t\tusleep_range(10, 13);\n\n\treturn ipq8064_mdio_wait_busy(priv);\n}\n\nstatic const struct regmap_config ipq8064_mdio_regmap_config = {\n\t.reg_bits = 32,\n\t.reg_stride = 4,\n\t.val_bits = 32,\n\t.can_multi_write = false,\n\t \n\t.disable_locking = true,\n\n\t.cache_type = REGCACHE_NONE,\n};\n\nstatic int\nipq8064_mdio_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct ipq8064_mdio *priv;\n\tstruct resource res;\n\tstruct mii_bus *bus;\n\tvoid __iomem *base;\n\tint ret;\n\n\tif (of_address_to_resource(np, 0, &res))\n\t\treturn -ENOMEM;\n\n\tbase = devm_ioremap(&pdev->dev, res.start, resource_size(&res));\n\tif (!base)\n\t\treturn -ENOMEM;\n\n\tbus = devm_mdiobus_alloc_size(&pdev->dev, sizeof(*priv));\n\tif (!bus)\n\t\treturn -ENOMEM;\n\n\tbus->name = \"ipq8064_mdio_bus\";\n\tbus->read = ipq8064_mdio_read;\n\tbus->write = ipq8064_mdio_write;\n\tsnprintf(bus->id, MII_BUS_ID_SIZE, \"%s-mii\", dev_name(&pdev->dev));\n\tbus->parent = &pdev->dev;\n\n\tpriv = bus->priv;\n\tpriv->base = devm_regmap_init_mmio(&pdev->dev, base,\n\t\t\t\t\t   &ipq8064_mdio_regmap_config);\n\tif (IS_ERR(priv->base))\n\t\treturn PTR_ERR(priv->base);\n\n\tret = of_mdiobus_register(bus, np);\n\tif (ret)\n\t\treturn ret;\n\n\tplatform_set_drvdata(pdev, bus);\n\treturn 0;\n}\n\nstatic int\nipq8064_mdio_remove(struct platform_device *pdev)\n{\n\tstruct mii_bus *bus = platform_get_drvdata(pdev);\n\n\tmdiobus_unregister(bus);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id ipq8064_mdio_dt_ids[] = {\n\t{ .compatible = \"qcom,ipq8064-mdio\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, ipq8064_mdio_dt_ids);\n\nstatic struct platform_driver ipq8064_mdio_driver = {\n\t.probe = ipq8064_mdio_probe,\n\t.remove = ipq8064_mdio_remove,\n\t.driver = {\n\t\t.name = \"ipq8064-mdio\",\n\t\t.of_match_table = ipq8064_mdio_dt_ids,\n\t},\n};\n\nmodule_platform_driver(ipq8064_mdio_driver);\n\nMODULE_DESCRIPTION(\"Qualcomm IPQ8064 MDIO interface driver\");\nMODULE_AUTHOR(\"Christian Lamparter <chunkeey@gmail.com>\");\nMODULE_AUTHOR(\"Ansuel Smith <ansuelsmth@gmail.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}