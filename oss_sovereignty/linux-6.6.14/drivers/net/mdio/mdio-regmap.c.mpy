{
  "module_name": "mdio-regmap.c",
  "hash_id": "acbc8c8193263d3b57f8d0100f07e5e1d74abf143a4d9924b8af8d41c1aa5010",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/mdio/mdio-regmap.c",
  "human_readable_source": "\n \n#include <linux/bitfield.h>\n#include <linux/delay.h>\n#include <linux/mdio.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_mdio.h>\n#include <linux/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/mdio/mdio-regmap.h>\n\n#define DRV_NAME \"mdio-regmap\"\n\nstruct mdio_regmap_priv {\n\tstruct regmap *regmap;\n\tu8 valid_addr;\n};\n\nstatic int mdio_regmap_read_c22(struct mii_bus *bus, int addr, int regnum)\n{\n\tstruct mdio_regmap_priv *ctx = bus->priv;\n\tunsigned int val;\n\tint ret;\n\n\tif (ctx->valid_addr != addr)\n\t\treturn -ENODEV;\n\n\tret = regmap_read(ctx->regmap, regnum, &val);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn val;\n}\n\nstatic int mdio_regmap_write_c22(struct mii_bus *bus, int addr, int regnum,\n\t\t\t\t u16 val)\n{\n\tstruct mdio_regmap_priv *ctx = bus->priv;\n\n\tif (ctx->valid_addr != addr)\n\t\treturn -ENODEV;\n\n\treturn regmap_write(ctx->regmap, regnum, val);\n}\n\nstruct mii_bus *devm_mdio_regmap_register(struct device *dev,\n\t\t\t\t\t  const struct mdio_regmap_config *config)\n{\n\tstruct mdio_regmap_priv *mr;\n\tstruct mii_bus *mii;\n\tint rc;\n\n\tif (!config->parent)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tmii = devm_mdiobus_alloc_size(config->parent, sizeof(*mr));\n\tif (!mii)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tmr = mii->priv;\n\tmr->regmap = config->regmap;\n\tmr->valid_addr = config->valid_addr;\n\n\tmii->name = DRV_NAME;\n\tstrscpy(mii->id, config->name, MII_BUS_ID_SIZE);\n\tmii->parent = config->parent;\n\tmii->read = mdio_regmap_read_c22;\n\tmii->write = mdio_regmap_write_c22;\n\n\tif (config->autoscan)\n\t\tmii->phy_mask = ~BIT(config->valid_addr);\n\telse\n\t\tmii->phy_mask = ~0;\n\n\trc = devm_mdiobus_register(dev, mii);\n\tif (rc) {\n\t\tdev_err(config->parent, \"Cannot register MDIO bus![%s] (%d)\\n\", mii->id, rc);\n\t\treturn ERR_PTR(rc);\n\t}\n\n\treturn mii;\n}\nEXPORT_SYMBOL_GPL(devm_mdio_regmap_register);\n\nMODULE_DESCRIPTION(\"MDIO API over regmap\");\nMODULE_AUTHOR(\"Maxime Chevallier <maxime.chevallier@bootlin.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}