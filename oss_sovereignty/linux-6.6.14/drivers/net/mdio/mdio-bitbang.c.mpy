{
  "module_name": "mdio-bitbang.c",
  "hash_id": "edb2371fbecf3aaf276275707993b6e098f091ee5a4a8019e4e6d76b8586a9fb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/mdio/mdio-bitbang.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/mdio-bitbang.h>\n#include <linux/module.h>\n#include <linux/types.h>\n\n#define MDIO_READ 2\n#define MDIO_WRITE 1\n\n#define MDIO_C45 (1<<15)\n#define MDIO_C45_ADDR (MDIO_C45 | 0)\n#define MDIO_C45_READ (MDIO_C45 | 3)\n#define MDIO_C45_WRITE (MDIO_C45 | 1)\n\n#define MDIO_SETUP_TIME 10\n#define MDIO_HOLD_TIME 10\n\n \n#define MDIO_DELAY 250\n\n \n#define MDIO_READ_DELAY 350\n\n \nstatic void mdiobb_send_bit(struct mdiobb_ctrl *ctrl, int val)\n{\n\tconst struct mdiobb_ops *ops = ctrl->ops;\n\n\tops->set_mdio_data(ctrl, val);\n\tndelay(MDIO_DELAY);\n\tops->set_mdc(ctrl, 1);\n\tndelay(MDIO_DELAY);\n\tops->set_mdc(ctrl, 0);\n}\n\n \nstatic int mdiobb_get_bit(struct mdiobb_ctrl *ctrl)\n{\n\tconst struct mdiobb_ops *ops = ctrl->ops;\n\n\tndelay(MDIO_DELAY);\n\tops->set_mdc(ctrl, 1);\n\tndelay(MDIO_READ_DELAY);\n\tops->set_mdc(ctrl, 0);\n\n\treturn ops->get_mdio_data(ctrl);\n}\n\n \nstatic void mdiobb_send_num(struct mdiobb_ctrl *ctrl, u16 val, int bits)\n{\n\tint i;\n\n\tfor (i = bits - 1; i >= 0; i--)\n\t\tmdiobb_send_bit(ctrl, (val >> i) & 1);\n}\n\n \nstatic u16 mdiobb_get_num(struct mdiobb_ctrl *ctrl, int bits)\n{\n\tint i;\n\tu16 ret = 0;\n\n\tfor (i = bits - 1; i >= 0; i--) {\n\t\tret <<= 1;\n\t\tret |= mdiobb_get_bit(ctrl);\n\t}\n\n\treturn ret;\n}\n\n \nstatic void mdiobb_cmd(struct mdiobb_ctrl *ctrl, int op, u8 phy, u8 reg)\n{\n\tconst struct mdiobb_ops *ops = ctrl->ops;\n\tint i;\n\n\tops->set_mdio_dir(ctrl, 1);\n\n\t \n\n\tfor (i = 0; i < 32; i++)\n\t\tmdiobb_send_bit(ctrl, 1);\n\n\t \n\tmdiobb_send_bit(ctrl, 0);\n\tif (op & MDIO_C45)\n\t\tmdiobb_send_bit(ctrl, 0);\n\telse\n\t\tmdiobb_send_bit(ctrl, 1);\n\tmdiobb_send_bit(ctrl, (op >> 1) & 1);\n\tmdiobb_send_bit(ctrl, (op >> 0) & 1);\n\n\tmdiobb_send_num(ctrl, phy, 5);\n\tmdiobb_send_num(ctrl, reg, 5);\n}\n\n \nstatic void mdiobb_cmd_addr(struct mdiobb_ctrl *ctrl, int phy, int dev_addr,\n\t\t\t    int reg)\n{\n\tmdiobb_cmd(ctrl, MDIO_C45_ADDR, phy, dev_addr);\n\n\t \n\tmdiobb_send_bit(ctrl, 1);\n\tmdiobb_send_bit(ctrl, 0);\n\n\tmdiobb_send_num(ctrl, reg, 16);\n\n\tctrl->ops->set_mdio_dir(ctrl, 0);\n\tmdiobb_get_bit(ctrl);\n}\n\nstatic int mdiobb_read_common(struct mii_bus *bus, int phy)\n{\n\tstruct mdiobb_ctrl *ctrl = bus->priv;\n\tint ret, i;\n\n\tctrl->ops->set_mdio_dir(ctrl, 0);\n\n\t \n\tif (mdiobb_get_bit(ctrl) != 0 &&\n\t    !(bus->phy_ignore_ta_mask & (1 << phy))) {\n\t\t \n\t\tfor (i = 0; i < 32; i++)\n\t\t\tmdiobb_get_bit(ctrl);\n\n\t\treturn 0xffff;\n\t}\n\n\tret = mdiobb_get_num(ctrl, 16);\n\tmdiobb_get_bit(ctrl);\n\treturn ret;\n}\n\nint mdiobb_read_c22(struct mii_bus *bus, int phy, int reg)\n{\n\tstruct mdiobb_ctrl *ctrl = bus->priv;\n\n\tmdiobb_cmd(ctrl, ctrl->op_c22_read, phy, reg);\n\n\treturn mdiobb_read_common(bus, phy);\n}\nEXPORT_SYMBOL(mdiobb_read_c22);\n\nint mdiobb_read_c45(struct mii_bus *bus, int phy, int devad, int reg)\n{\n\tstruct mdiobb_ctrl *ctrl = bus->priv;\n\n\tmdiobb_cmd_addr(ctrl, phy, devad, reg);\n\tmdiobb_cmd(ctrl, MDIO_C45_READ, phy, devad);\n\n\treturn mdiobb_read_common(bus, phy);\n}\nEXPORT_SYMBOL(mdiobb_read_c45);\n\nstatic int mdiobb_write_common(struct mii_bus *bus, u16 val)\n{\n\tstruct mdiobb_ctrl *ctrl = bus->priv;\n\n\t \n\tmdiobb_send_bit(ctrl, 1);\n\tmdiobb_send_bit(ctrl, 0);\n\n\tmdiobb_send_num(ctrl, val, 16);\n\n\tctrl->ops->set_mdio_dir(ctrl, 0);\n\tmdiobb_get_bit(ctrl);\n\treturn 0;\n}\n\nint mdiobb_write_c22(struct mii_bus *bus, int phy, int reg, u16 val)\n{\n\tstruct mdiobb_ctrl *ctrl = bus->priv;\n\n\tmdiobb_cmd(ctrl, ctrl->op_c22_write, phy, reg);\n\n\treturn mdiobb_write_common(bus, val);\n}\nEXPORT_SYMBOL(mdiobb_write_c22);\n\nint mdiobb_write_c45(struct mii_bus *bus, int phy, int devad, int reg, u16 val)\n{\n\tstruct mdiobb_ctrl *ctrl = bus->priv;\n\n\tmdiobb_cmd_addr(ctrl, phy, devad, reg);\n\tmdiobb_cmd(ctrl, MDIO_C45_WRITE, phy, devad);\n\n\treturn mdiobb_write_common(bus, val);\n}\nEXPORT_SYMBOL(mdiobb_write_c45);\n\nstruct mii_bus *alloc_mdio_bitbang(struct mdiobb_ctrl *ctrl)\n{\n\tstruct mii_bus *bus;\n\n\tbus = mdiobus_alloc();\n\tif (!bus)\n\t\treturn NULL;\n\n\t__module_get(ctrl->ops->owner);\n\n\tbus->read = mdiobb_read_c22;\n\tbus->write = mdiobb_write_c22;\n\tbus->read_c45 = mdiobb_read_c45;\n\tbus->write_c45 = mdiobb_write_c45;\n\n\tbus->priv = ctrl;\n\tif (!ctrl->override_op_c22) {\n\t\tctrl->op_c22_read = MDIO_READ;\n\t\tctrl->op_c22_write = MDIO_WRITE;\n\t}\n\n\treturn bus;\n}\nEXPORT_SYMBOL(alloc_mdio_bitbang);\n\nvoid free_mdio_bitbang(struct mii_bus *bus)\n{\n\tstruct mdiobb_ctrl *ctrl = bus->priv;\n\n\tmodule_put(ctrl->ops->owner);\n\tmdiobus_free(bus);\n}\nEXPORT_SYMBOL(free_mdio_bitbang);\n\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}