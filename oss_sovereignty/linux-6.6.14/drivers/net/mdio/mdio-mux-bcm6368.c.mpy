{
  "module_name": "mdio-mux-bcm6368.c",
  "hash_id": "ad680acdde809e48aa5f507add5a8bec17738bb8b54bd5679ba95693cf7ee6e2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/mdio/mdio-mux-bcm6368.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/mdio-mux.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/of_mdio.h>\n#include <linux/phy.h>\n#include <linux/platform_device.h>\n#include <linux/sched.h>\n\n#define MDIOC_REG\t\t0x0\n#define MDIOC_EXT_MASK\t\tBIT(16)\n#define MDIOC_REG_SHIFT\t\t20\n#define MDIOC_PHYID_SHIFT\t25\n#define MDIOC_RD_MASK\t\tBIT(30)\n#define MDIOC_WR_MASK\t\tBIT(31)\n\n#define MDIOD_REG\t\t0x4\n\nstruct bcm6368_mdiomux_desc {\n\tvoid *mux_handle;\n\tvoid __iomem *base;\n\tstruct device *dev;\n\tstruct mii_bus *mii_bus;\n\tint ext_phy;\n};\n\nstatic int bcm6368_mdiomux_read(struct mii_bus *bus, int phy_id, int loc)\n{\n\tstruct bcm6368_mdiomux_desc *md = bus->priv;\n\tuint32_t reg;\n\tint ret;\n\n\t__raw_writel(0, md->base + MDIOC_REG);\n\n\treg = MDIOC_RD_MASK |\n\t      (phy_id << MDIOC_PHYID_SHIFT) |\n\t      (loc << MDIOC_REG_SHIFT);\n\tif (md->ext_phy)\n\t\treg |= MDIOC_EXT_MASK;\n\n\t__raw_writel(reg, md->base + MDIOC_REG);\n\tudelay(50);\n\tret = __raw_readw(md->base + MDIOD_REG);\n\n\treturn ret;\n}\n\nstatic int bcm6368_mdiomux_write(struct mii_bus *bus, int phy_id, int loc,\n\t\t\t\t uint16_t val)\n{\n\tstruct bcm6368_mdiomux_desc *md = bus->priv;\n\tuint32_t reg;\n\n\t__raw_writel(0, md->base + MDIOC_REG);\n\n\treg = MDIOC_WR_MASK |\n\t      (phy_id << MDIOC_PHYID_SHIFT) |\n\t      (loc << MDIOC_REG_SHIFT);\n\tif (md->ext_phy)\n\t\treg |= MDIOC_EXT_MASK;\n\treg |= val;\n\n\t__raw_writel(reg, md->base + MDIOC_REG);\n\tudelay(50);\n\n\treturn 0;\n}\n\nstatic int bcm6368_mdiomux_switch_fn(int current_child, int desired_child,\n\t\t\t\t     void *data)\n{\n\tstruct bcm6368_mdiomux_desc *md = data;\n\n\tmd->ext_phy = desired_child;\n\n\treturn 0;\n}\n\nstatic int bcm6368_mdiomux_probe(struct platform_device *pdev)\n{\n\tstruct bcm6368_mdiomux_desc *md;\n\tstruct mii_bus *bus;\n\tstruct resource *res;\n\tint rc;\n\n\tmd = devm_kzalloc(&pdev->dev, sizeof(*md), GFP_KERNEL);\n\tif (!md)\n\t\treturn -ENOMEM;\n\tmd->dev = &pdev->dev;\n\n\tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!res)\n\t\treturn -EINVAL;\n\n\t \n\tmd->base = devm_ioremap(&pdev->dev, res->start, resource_size(res));\n\tif (!md->base) {\n\t\tdev_err(&pdev->dev, \"failed to ioremap register\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tmd->mii_bus = devm_mdiobus_alloc(&pdev->dev);\n\tif (!md->mii_bus) {\n\t\tdev_err(&pdev->dev, \"mdiomux bus alloc failed\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tbus = md->mii_bus;\n\tbus->priv = md;\n\tbus->name = \"BCM6368 MDIO mux bus\";\n\tsnprintf(bus->id, MII_BUS_ID_SIZE, \"%s-%d\", pdev->name, pdev->id);\n\tbus->parent = &pdev->dev;\n\tbus->read = bcm6368_mdiomux_read;\n\tbus->write = bcm6368_mdiomux_write;\n\tbus->phy_mask = 0x3f;\n\tbus->dev.of_node = pdev->dev.of_node;\n\n\trc = mdiobus_register(bus);\n\tif (rc) {\n\t\tdev_err(&pdev->dev, \"mdiomux registration failed\\n\");\n\t\treturn rc;\n\t}\n\n\tplatform_set_drvdata(pdev, md);\n\n\trc = mdio_mux_init(md->dev, md->dev->of_node,\n\t\t\t   bcm6368_mdiomux_switch_fn, &md->mux_handle, md,\n\t\t\t   md->mii_bus);\n\tif (rc) {\n\t\tdev_info(md->dev, \"mdiomux initialization failed\\n\");\n\t\tgoto out_register;\n\t}\n\n\tdev_info(&pdev->dev, \"Broadcom BCM6368 MDIO mux bus\\n\");\n\n\treturn 0;\n\nout_register:\n\tmdiobus_unregister(bus);\n\treturn rc;\n}\n\nstatic int bcm6368_mdiomux_remove(struct platform_device *pdev)\n{\n\tstruct bcm6368_mdiomux_desc *md = platform_get_drvdata(pdev);\n\n\tmdio_mux_uninit(md->mux_handle);\n\tmdiobus_unregister(md->mii_bus);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id bcm6368_mdiomux_ids[] = {\n\t{ .compatible = \"brcm,bcm6368-mdio-mux\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, bcm6368_mdiomux_ids);\n\nstatic struct platform_driver bcm6368_mdiomux_driver = {\n\t.driver = {\n\t\t.name = \"bcm6368-mdio-mux\",\n\t\t.of_match_table = bcm6368_mdiomux_ids,\n\t},\n\t.probe\t= bcm6368_mdiomux_probe,\n\t.remove\t= bcm6368_mdiomux_remove,\n};\nmodule_platform_driver(bcm6368_mdiomux_driver);\n\nMODULE_AUTHOR(\"\u00c1lvaro Fern\u00e1ndez Rojas <noltari@gmail.com>\");\nMODULE_DESCRIPTION(\"BCM6368 mdiomux bus controller driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}