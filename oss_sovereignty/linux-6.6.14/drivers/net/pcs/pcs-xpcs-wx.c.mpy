{
  "module_name": "pcs-xpcs-wx.c",
  "hash_id": "236922e18d834a503a6d7a6ee0b3c5a44e117113cac1a330e1d5e20451476dbb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/pcs/pcs-xpcs-wx.c",
  "human_readable_source": "\n \n\n#include <linux/pcs/pcs-xpcs.h>\n#include <linux/mdio.h>\n#include \"pcs-xpcs.h\"\n\n \n#define TXGBE_PMA_MMD\t\t\t0x8020\n#define TXGBE_TX_GENCTL1\t\t0x11\n#define TXGBE_TX_GENCTL1_VBOOST_LVL\tGENMASK(10, 8)\n#define TXGBE_TX_GENCTL1_VBOOST_EN0\tBIT(4)\n#define TXGBE_TX_GEN_CTL2\t\t0x12\n#define TXGBE_TX_GEN_CTL2_TX0_WIDTH(v)\tFIELD_PREP(GENMASK(9, 8), v)\n#define TXGBE_TX_RATE_CTL\t\t0x14\n#define TXGBE_TX_RATE_CTL_TX0_RATE(v)\tFIELD_PREP(GENMASK(2, 0), v)\n#define TXGBE_RX_GEN_CTL2\t\t0x32\n#define TXGBE_RX_GEN_CTL2_RX0_WIDTH(v)\tFIELD_PREP(GENMASK(9, 8), v)\n#define TXGBE_RX_GEN_CTL3\t\t0x33\n#define TXGBE_RX_GEN_CTL3_LOS_TRSHLD0\tGENMASK(2, 0)\n#define TXGBE_RX_RATE_CTL\t\t0x34\n#define TXGBE_RX_RATE_CTL_RX0_RATE(v)\tFIELD_PREP(GENMASK(1, 0), v)\n#define TXGBE_RX_EQ_ATTN_CTL\t\t0x37\n#define TXGBE_RX_EQ_ATTN_LVL0\t\tGENMASK(2, 0)\n#define TXGBE_RX_EQ_CTL0\t\t0x38\n#define TXGBE_RX_EQ_CTL0_VGA1_GAIN(v)\tFIELD_PREP(GENMASK(15, 12), v)\n#define TXGBE_RX_EQ_CTL0_VGA2_GAIN(v)\tFIELD_PREP(GENMASK(11, 8), v)\n#define TXGBE_RX_EQ_CTL0_CTLE_POLE(v)\tFIELD_PREP(GENMASK(7, 5), v)\n#define TXGBE_RX_EQ_CTL0_CTLE_BOOST(v)\tFIELD_PREP(GENMASK(4, 0), v)\n#define TXGBE_RX_EQ_CTL4\t\t0x3C\n#define TXGBE_RX_EQ_CTL4_CONT_OFF_CAN0\tBIT(4)\n#define TXGBE_RX_EQ_CTL4_CONT_ADAPT0\tBIT(0)\n#define TXGBE_AFE_DFE_ENABLE\t\t0x3D\n#define TXGBE_DFE_EN_0\t\t\tBIT(4)\n#define TXGBE_AFE_EN_0\t\t\tBIT(0)\n#define TXGBE_DFE_TAP_CTL0\t\t0x3E\n#define TXGBE_MPLLA_CTL0\t\t0x51\n#define TXGBE_MPLLA_CTL2\t\t0x53\n#define TXGBE_MPLLA_CTL2_DIV16P5_CLK_EN\tBIT(10)\n#define TXGBE_MPLLA_CTL2_DIV10_CLK_EN\tBIT(9)\n#define TXGBE_MPLLA_CTL3\t\t0x57\n#define TXGBE_MISC_CTL0\t\t\t0x70\n#define TXGBE_MISC_CTL0_PLL\t\tBIT(15)\n#define TXGBE_MISC_CTL0_CR_PARA_SEL\tBIT(14)\n#define TXGBE_MISC_CTL0_RX_VREF(v)\tFIELD_PREP(GENMASK(12, 8), v)\n#define TXGBE_VCO_CAL_LD0\t\t0x72\n#define TXGBE_VCO_CAL_REF0\t\t0x76\n\nstatic int txgbe_read_pma(struct dw_xpcs *xpcs, int reg)\n{\n\treturn xpcs_read(xpcs, MDIO_MMD_PMAPMD, TXGBE_PMA_MMD + reg);\n}\n\nstatic int txgbe_write_pma(struct dw_xpcs *xpcs, int reg, u16 val)\n{\n\treturn xpcs_write(xpcs, MDIO_MMD_PMAPMD, TXGBE_PMA_MMD + reg, val);\n}\n\nstatic void txgbe_pma_config_10gbaser(struct dw_xpcs *xpcs)\n{\n\tint val;\n\n\ttxgbe_write_pma(xpcs, TXGBE_MPLLA_CTL0, 0x21);\n\ttxgbe_write_pma(xpcs, TXGBE_MPLLA_CTL3, 0);\n\tval = txgbe_read_pma(xpcs, TXGBE_TX_GENCTL1);\n\tval = u16_replace_bits(val, 0x5, TXGBE_TX_GENCTL1_VBOOST_LVL);\n\ttxgbe_write_pma(xpcs, TXGBE_TX_GENCTL1, val);\n\ttxgbe_write_pma(xpcs, TXGBE_MISC_CTL0, TXGBE_MISC_CTL0_PLL |\n\t\t\tTXGBE_MISC_CTL0_CR_PARA_SEL | TXGBE_MISC_CTL0_RX_VREF(0xF));\n\ttxgbe_write_pma(xpcs, TXGBE_VCO_CAL_LD0, 0x549);\n\ttxgbe_write_pma(xpcs, TXGBE_VCO_CAL_REF0, 0x29);\n\ttxgbe_write_pma(xpcs, TXGBE_TX_RATE_CTL, 0);\n\ttxgbe_write_pma(xpcs, TXGBE_RX_RATE_CTL, 0);\n\ttxgbe_write_pma(xpcs, TXGBE_TX_GEN_CTL2, TXGBE_TX_GEN_CTL2_TX0_WIDTH(3));\n\ttxgbe_write_pma(xpcs, TXGBE_RX_GEN_CTL2, TXGBE_RX_GEN_CTL2_RX0_WIDTH(3));\n\ttxgbe_write_pma(xpcs, TXGBE_MPLLA_CTL2, TXGBE_MPLLA_CTL2_DIV16P5_CLK_EN |\n\t\t\tTXGBE_MPLLA_CTL2_DIV10_CLK_EN);\n\n\ttxgbe_write_pma(xpcs, TXGBE_RX_EQ_CTL0, TXGBE_RX_EQ_CTL0_CTLE_POLE(2) |\n\t\t\tTXGBE_RX_EQ_CTL0_CTLE_BOOST(5));\n\tval = txgbe_read_pma(xpcs, TXGBE_RX_EQ_ATTN_CTL);\n\tval &= ~TXGBE_RX_EQ_ATTN_LVL0;\n\ttxgbe_write_pma(xpcs, TXGBE_RX_EQ_ATTN_CTL, val);\n\ttxgbe_write_pma(xpcs, TXGBE_DFE_TAP_CTL0, 0xBE);\n\tval = txgbe_read_pma(xpcs, TXGBE_AFE_DFE_ENABLE);\n\tval &= ~(TXGBE_DFE_EN_0 | TXGBE_AFE_EN_0);\n\ttxgbe_write_pma(xpcs, TXGBE_AFE_DFE_ENABLE, val);\n\tval = txgbe_read_pma(xpcs, TXGBE_RX_EQ_CTL4);\n\tval &= ~TXGBE_RX_EQ_CTL4_CONT_ADAPT0;\n\ttxgbe_write_pma(xpcs, TXGBE_RX_EQ_CTL4, val);\n}\n\nstatic void txgbe_pma_config_1g(struct dw_xpcs *xpcs)\n{\n\tint val;\n\n\tval = txgbe_read_pma(xpcs, TXGBE_TX_GENCTL1);\n\tval = u16_replace_bits(val, 0x5, TXGBE_TX_GENCTL1_VBOOST_LVL);\n\tval &= ~TXGBE_TX_GENCTL1_VBOOST_EN0;\n\ttxgbe_write_pma(xpcs, TXGBE_TX_GENCTL1, val);\n\ttxgbe_write_pma(xpcs, TXGBE_MISC_CTL0, TXGBE_MISC_CTL0_PLL |\n\t\t\tTXGBE_MISC_CTL0_CR_PARA_SEL | TXGBE_MISC_CTL0_RX_VREF(0xF));\n\n\ttxgbe_write_pma(xpcs, TXGBE_RX_EQ_CTL0, TXGBE_RX_EQ_CTL0_VGA1_GAIN(7) |\n\t\t\tTXGBE_RX_EQ_CTL0_VGA2_GAIN(7) | TXGBE_RX_EQ_CTL0_CTLE_BOOST(6));\n\tval = txgbe_read_pma(xpcs, TXGBE_RX_EQ_ATTN_CTL);\n\tval &= ~TXGBE_RX_EQ_ATTN_LVL0;\n\ttxgbe_write_pma(xpcs, TXGBE_RX_EQ_ATTN_CTL, val);\n\ttxgbe_write_pma(xpcs, TXGBE_DFE_TAP_CTL0, 0);\n\tval = txgbe_read_pma(xpcs, TXGBE_RX_GEN_CTL3);\n\tval = u16_replace_bits(val, 0x4, TXGBE_RX_GEN_CTL3_LOS_TRSHLD0);\n\ttxgbe_write_pma(xpcs, TXGBE_RX_EQ_ATTN_CTL, val);\n\n\ttxgbe_write_pma(xpcs, TXGBE_MPLLA_CTL0, 0x20);\n\ttxgbe_write_pma(xpcs, TXGBE_MPLLA_CTL3, 0x46);\n\ttxgbe_write_pma(xpcs, TXGBE_VCO_CAL_LD0, 0x540);\n\ttxgbe_write_pma(xpcs, TXGBE_VCO_CAL_REF0, 0x2A);\n\ttxgbe_write_pma(xpcs, TXGBE_AFE_DFE_ENABLE, 0);\n\ttxgbe_write_pma(xpcs, TXGBE_RX_EQ_CTL4, TXGBE_RX_EQ_CTL4_CONT_OFF_CAN0);\n\ttxgbe_write_pma(xpcs, TXGBE_TX_RATE_CTL, TXGBE_TX_RATE_CTL_TX0_RATE(3));\n\ttxgbe_write_pma(xpcs, TXGBE_RX_RATE_CTL, TXGBE_RX_RATE_CTL_RX0_RATE(3));\n\ttxgbe_write_pma(xpcs, TXGBE_TX_GEN_CTL2, TXGBE_TX_GEN_CTL2_TX0_WIDTH(1));\n\ttxgbe_write_pma(xpcs, TXGBE_RX_GEN_CTL2, TXGBE_RX_GEN_CTL2_RX0_WIDTH(1));\n\ttxgbe_write_pma(xpcs, TXGBE_MPLLA_CTL2, TXGBE_MPLLA_CTL2_DIV10_CLK_EN);\n}\n\nstatic int txgbe_pcs_poll_power_up(struct dw_xpcs *xpcs)\n{\n\tint val, ret;\n\n\t \n\tret = read_poll_timeout(xpcs_read_vpcs, val,\n\t\t\t\t(val & DW_PSEQ_ST) == DW_PSEQ_ST_GOOD,\n\t\t\t\t10000, 1000000, false,\n\t\t\t\txpcs, DW_VR_XS_PCS_DIG_STS);\n\tif (ret < 0)\n\t\tdev_err(&xpcs->mdiodev->dev, \"xpcs power-up timeout\\n\");\n\n\treturn ret;\n}\n\nstatic int txgbe_pma_init_done(struct dw_xpcs *xpcs)\n{\n\tint val, ret;\n\n\txpcs_write_vpcs(xpcs, DW_VR_XS_PCS_DIG_CTRL1, DW_VR_RST | DW_EN_VSMMD1);\n\n\t \n\tret = read_poll_timeout(xpcs_read_vpcs, val, !(val & DW_VR_RST),\n\t\t\t\t100000, 10000000, false,\n\t\t\t\txpcs, DW_VR_XS_PCS_DIG_CTRL1);\n\tif (ret < 0)\n\t\tdev_err(&xpcs->mdiodev->dev, \"xpcs pma initialization timeout\\n\");\n\n\treturn ret;\n}\n\nstatic bool txgbe_xpcs_mode_quirk(struct dw_xpcs *xpcs)\n{\n\tint ret;\n\n\t \n\tret = xpcs_read(xpcs, MDIO_MMD_PCS, MDIO_CTRL2);\n\tret &= MDIO_PCS_CTRL2_TYPE;\n\tif ((ret == MDIO_PCS_CTRL2_10GBR &&\n\t     xpcs->interface != PHY_INTERFACE_MODE_10GBASER) ||\n\t    xpcs->interface == PHY_INTERFACE_MODE_SGMII)\n\t\treturn true;\n\n\treturn false;\n}\n\nint txgbe_xpcs_switch_mode(struct dw_xpcs *xpcs, phy_interface_t interface)\n{\n\tint val, ret;\n\n\tswitch (interface) {\n\tcase PHY_INTERFACE_MODE_10GBASER:\n\tcase PHY_INTERFACE_MODE_SGMII:\n\tcase PHY_INTERFACE_MODE_1000BASEX:\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tif (xpcs->interface == interface && !txgbe_xpcs_mode_quirk(xpcs))\n\t\treturn 0;\n\n\txpcs->interface = interface;\n\n\tret = txgbe_pcs_poll_power_up(xpcs);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (interface == PHY_INTERFACE_MODE_10GBASER) {\n\t\txpcs_write(xpcs, MDIO_MMD_PCS, MDIO_CTRL2, MDIO_PCS_CTRL2_10GBR);\n\t\tval = xpcs_read(xpcs, MDIO_MMD_PMAPMD, MDIO_CTRL1);\n\t\tval |= MDIO_CTRL1_SPEED10G;\n\t\txpcs_write(xpcs, MDIO_MMD_PMAPMD, MDIO_CTRL1, val);\n\t\ttxgbe_pma_config_10gbaser(xpcs);\n\t} else {\n\t\txpcs_write(xpcs, MDIO_MMD_PCS, MDIO_CTRL2, MDIO_PCS_CTRL2_10GBX);\n\t\txpcs_write(xpcs, MDIO_MMD_PMAPMD, MDIO_CTRL1, 0);\n\t\txpcs_write(xpcs, MDIO_MMD_PCS, MDIO_CTRL1, 0);\n\t\ttxgbe_pma_config_1g(xpcs);\n\t}\n\n\treturn txgbe_pma_init_done(xpcs);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}