{
  "module_name": "sungem_phy.c",
  "hash_id": "99a3f58b2016137f321d2723ae2c2f9f2d0ef3ac8a4c9df5365d69443f68c761",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/sungem_phy.c",
  "human_readable_source": "\n \n\n\n#include <linux/module.h>\n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n#include <linux/mii.h>\n#include <linux/ethtool.h>\n#include <linux/delay.h>\n#include <linux/of.h>\n#include <linux/sungem_phy.h>\n\n \nstatic const int phy_BCM5400_link_table[8][3] = {\n\t{ 0, 0, 0 },\t \n\t{ 0, 0, 0 },\t \n\t{ 1, 0, 0 },\t \n\t{ 0, 1, 0 },\t \n\t{ 0, 1, 0 },\t \n\t{ 1, 1, 0 },\t \n\t{ 1, 0, 1 },\t \n\t{ 1, 0, 1 },\t \n};\n\nstatic inline int __sungem_phy_read(struct mii_phy* phy, int id, int reg)\n{\n\treturn phy->mdio_read(phy->dev, id, reg);\n}\n\nstatic inline void __sungem_phy_write(struct mii_phy* phy, int id, int reg, int val)\n{\n\tphy->mdio_write(phy->dev, id, reg, val);\n}\n\nstatic inline int sungem_phy_read(struct mii_phy* phy, int reg)\n{\n\treturn phy->mdio_read(phy->dev, phy->mii_id, reg);\n}\n\nstatic inline void sungem_phy_write(struct mii_phy* phy, int reg, int val)\n{\n\tphy->mdio_write(phy->dev, phy->mii_id, reg, val);\n}\n\nstatic int reset_one_mii_phy(struct mii_phy* phy, int phy_id)\n{\n\tu16 val;\n\tint limit = 10000;\n\n\tval = __sungem_phy_read(phy, phy_id, MII_BMCR);\n\tval &= ~(BMCR_ISOLATE | BMCR_PDOWN);\n\tval |= BMCR_RESET;\n\t__sungem_phy_write(phy, phy_id, MII_BMCR, val);\n\n\tudelay(100);\n\n\twhile (--limit) {\n\t\tval = __sungem_phy_read(phy, phy_id, MII_BMCR);\n\t\tif ((val & BMCR_RESET) == 0)\n\t\t\tbreak;\n\t\tudelay(10);\n\t}\n\tif ((val & BMCR_ISOLATE) && limit > 0)\n\t\t__sungem_phy_write(phy, phy_id, MII_BMCR, val & ~BMCR_ISOLATE);\n\n\treturn limit <= 0;\n}\n\nstatic int bcm5201_init(struct mii_phy* phy)\n{\n\tu16 data;\n\n\tdata = sungem_phy_read(phy, MII_BCM5201_MULTIPHY);\n\tdata &= ~MII_BCM5201_MULTIPHY_SUPERISOLATE;\n\tsungem_phy_write(phy, MII_BCM5201_MULTIPHY, data);\n\n\tsungem_phy_write(phy, MII_BCM5201_INTERRUPT, 0);\n\n\treturn 0;\n}\n\nstatic int bcm5201_suspend(struct mii_phy* phy)\n{\n\tsungem_phy_write(phy, MII_BCM5201_INTERRUPT, 0);\n\tsungem_phy_write(phy, MII_BCM5201_MULTIPHY, MII_BCM5201_MULTIPHY_SUPERISOLATE);\n\n\treturn 0;\n}\n\nstatic int bcm5221_init(struct mii_phy* phy)\n{\n\tu16 data;\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_TEST);\n\tsungem_phy_write(phy, MII_BCM5221_TEST,\n\t\tdata | MII_BCM5221_TEST_ENABLE_SHADOWS);\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_STAT2);\n\tsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_STAT2,\n\t\tdata | MII_BCM5221_SHDOW_AUX_STAT2_APD);\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_MODE4);\n\tsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_MODE4,\n\t\tdata | MII_BCM5221_SHDOW_AUX_MODE4_CLKLOPWR);\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_TEST);\n\tsungem_phy_write(phy, MII_BCM5221_TEST,\n\t\tdata & ~MII_BCM5221_TEST_ENABLE_SHADOWS);\n\n\treturn 0;\n}\n\nstatic int bcm5221_suspend(struct mii_phy* phy)\n{\n\tu16 data;\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_TEST);\n\tsungem_phy_write(phy, MII_BCM5221_TEST,\n\t\tdata | MII_BCM5221_TEST_ENABLE_SHADOWS);\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_MODE4);\n\tsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_MODE4,\n\t\t  data | MII_BCM5221_SHDOW_AUX_MODE4_IDDQMODE);\n\n\treturn 0;\n}\n\nstatic int bcm5241_init(struct mii_phy* phy)\n{\n\tu16 data;\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_TEST);\n\tsungem_phy_write(phy, MII_BCM5221_TEST,\n\t\tdata | MII_BCM5221_TEST_ENABLE_SHADOWS);\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_STAT2);\n\tsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_STAT2,\n\t\tdata | MII_BCM5221_SHDOW_AUX_STAT2_APD);\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_MODE4);\n\tsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_MODE4,\n\t\tdata & ~MII_BCM5241_SHDOW_AUX_MODE4_STANDBYPWR);\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_TEST);\n\tsungem_phy_write(phy, MII_BCM5221_TEST,\n\t\tdata & ~MII_BCM5221_TEST_ENABLE_SHADOWS);\n\n\treturn 0;\n}\n\nstatic int bcm5241_suspend(struct mii_phy* phy)\n{\n\tu16 data;\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_TEST);\n\tsungem_phy_write(phy, MII_BCM5221_TEST,\n\t\tdata | MII_BCM5221_TEST_ENABLE_SHADOWS);\n\n\tdata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_MODE4);\n\tsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_MODE4,\n\t\t  data | MII_BCM5241_SHDOW_AUX_MODE4_STANDBYPWR);\n\n\treturn 0;\n}\n\nstatic int bcm5400_init(struct mii_phy* phy)\n{\n\tu16 data;\n\n\t \n\tdata = sungem_phy_read(phy, MII_BCM5400_AUXCONTROL);\n\tdata |= MII_BCM5400_AUXCONTROL_PWR10BASET;\n\tsungem_phy_write(phy, MII_BCM5400_AUXCONTROL, data);\n\n\tdata = sungem_phy_read(phy, MII_BCM5400_GB_CONTROL);\n\tdata |= MII_BCM5400_GB_CONTROL_FULLDUPLEXCAP;\n\tsungem_phy_write(phy, MII_BCM5400_GB_CONTROL, data);\n\n\tudelay(100);\n\n\t \n\t(void)reset_one_mii_phy(phy, 0x1f);\n\n\tdata = __sungem_phy_read(phy, 0x1f, MII_BCM5201_MULTIPHY);\n\tdata |= MII_BCM5201_MULTIPHY_SERIALMODE;\n\t__sungem_phy_write(phy, 0x1f, MII_BCM5201_MULTIPHY, data);\n\n\tdata = sungem_phy_read(phy, MII_BCM5400_AUXCONTROL);\n\tdata &= ~MII_BCM5400_AUXCONTROL_PWR10BASET;\n\tsungem_phy_write(phy, MII_BCM5400_AUXCONTROL, data);\n\n\treturn 0;\n}\n\nstatic int bcm5400_suspend(struct mii_phy* phy)\n{\n#if 0  \n\tsungem_phy_write(phy, MII_BMCR, BMCR_PDOWN);\n#endif\n\treturn 0;\n}\n\nstatic int bcm5401_init(struct mii_phy* phy)\n{\n\tu16 data;\n\tint rev;\n\n\trev = sungem_phy_read(phy, MII_PHYSID2) & 0x000f;\n\tif (rev == 0 || rev == 3) {\n\t\t \n\t\tsungem_phy_write(phy, 0x18, 0x0c20);\n\t\tsungem_phy_write(phy, 0x17, 0x0012);\n\t\tsungem_phy_write(phy, 0x15, 0x1804);\n\t\tsungem_phy_write(phy, 0x17, 0x0013);\n\t\tsungem_phy_write(phy, 0x15, 0x1204);\n\t\tsungem_phy_write(phy, 0x17, 0x8006);\n\t\tsungem_phy_write(phy, 0x15, 0x0132);\n\t\tsungem_phy_write(phy, 0x17, 0x8006);\n\t\tsungem_phy_write(phy, 0x15, 0x0232);\n\t\tsungem_phy_write(phy, 0x17, 0x201f);\n\t\tsungem_phy_write(phy, 0x15, 0x0a20);\n\t}\n\n\t \n\tdata = sungem_phy_read(phy, MII_BCM5400_GB_CONTROL);\n\tdata |= MII_BCM5400_GB_CONTROL_FULLDUPLEXCAP;\n\tsungem_phy_write(phy, MII_BCM5400_GB_CONTROL, data);\n\n\tudelay(10);\n\n\t \n\t(void)reset_one_mii_phy(phy, 0x1f);\n\n\tdata = __sungem_phy_read(phy, 0x1f, MII_BCM5201_MULTIPHY);\n\tdata |= MII_BCM5201_MULTIPHY_SERIALMODE;\n\t__sungem_phy_write(phy, 0x1f, MII_BCM5201_MULTIPHY, data);\n\n\treturn 0;\n}\n\nstatic int bcm5401_suspend(struct mii_phy* phy)\n{\n#if 0  \n\tsungem_phy_write(phy, MII_BMCR, BMCR_PDOWN);\n#endif\n\treturn 0;\n}\n\nstatic int bcm5411_init(struct mii_phy* phy)\n{\n\tu16 data;\n\n\t \n\tsungem_phy_write(phy, 0x1c, 0x8c23);\n\tsungem_phy_write(phy, 0x1c, 0x8ca3);\n\tsungem_phy_write(phy, 0x1c, 0x8c23);\n\n\t \n\tsungem_phy_write(phy, MII_BMCR, BMCR_RESET);\n\tsungem_phy_write(phy, MII_BMCR, 0x1340);\n\n\tdata = sungem_phy_read(phy, MII_BCM5400_GB_CONTROL);\n\tdata |= MII_BCM5400_GB_CONTROL_FULLDUPLEXCAP;\n\tsungem_phy_write(phy, MII_BCM5400_GB_CONTROL, data);\n\n\tudelay(10);\n\n\t \n\t(void)reset_one_mii_phy(phy, 0x1f);\n\n\treturn 0;\n}\n\nstatic int genmii_setup_aneg(struct mii_phy *phy, u32 advertise)\n{\n\tu16 ctl, adv;\n\n\tphy->autoneg = 1;\n\tphy->speed = SPEED_10;\n\tphy->duplex = DUPLEX_HALF;\n\tphy->pause = 0;\n\tphy->advertising = advertise;\n\n\t \n\tadv = sungem_phy_read(phy, MII_ADVERTISE);\n\tadv &= ~(ADVERTISE_ALL | ADVERTISE_100BASE4);\n\tif (advertise & ADVERTISED_10baseT_Half)\n\t\tadv |= ADVERTISE_10HALF;\n\tif (advertise & ADVERTISED_10baseT_Full)\n\t\tadv |= ADVERTISE_10FULL;\n\tif (advertise & ADVERTISED_100baseT_Half)\n\t\tadv |= ADVERTISE_100HALF;\n\tif (advertise & ADVERTISED_100baseT_Full)\n\t\tadv |= ADVERTISE_100FULL;\n\tsungem_phy_write(phy, MII_ADVERTISE, adv);\n\n\t \n\tctl = sungem_phy_read(phy, MII_BMCR);\n\tctl |= (BMCR_ANENABLE | BMCR_ANRESTART);\n\tsungem_phy_write(phy, MII_BMCR, ctl);\n\n\treturn 0;\n}\n\nstatic int genmii_setup_forced(struct mii_phy *phy, int speed, int fd)\n{\n\tu16 ctl;\n\n\tphy->autoneg = 0;\n\tphy->speed = speed;\n\tphy->duplex = fd;\n\tphy->pause = 0;\n\n\tctl = sungem_phy_read(phy, MII_BMCR);\n\tctl &= ~(BMCR_FULLDPLX|BMCR_SPEED100|BMCR_ANENABLE);\n\n\t \n\tsungem_phy_write(phy, MII_BMCR, ctl | BMCR_RESET);\n\n\t \n\tswitch(speed) {\n\tcase SPEED_10:\n\t\tbreak;\n\tcase SPEED_100:\n\t\tctl |= BMCR_SPEED100;\n\t\tbreak;\n\tcase SPEED_1000:\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\tif (fd == DUPLEX_FULL)\n\t\tctl |= BMCR_FULLDPLX;\n\tsungem_phy_write(phy, MII_BMCR, ctl);\n\n\treturn 0;\n}\n\nstatic int genmii_poll_link(struct mii_phy *phy)\n{\n\tu16 status;\n\n\t(void)sungem_phy_read(phy, MII_BMSR);\n\tstatus = sungem_phy_read(phy, MII_BMSR);\n\tif ((status & BMSR_LSTATUS) == 0)\n\t\treturn 0;\n\tif (phy->autoneg && !(status & BMSR_ANEGCOMPLETE))\n\t\treturn 0;\n\treturn 1;\n}\n\nstatic int genmii_read_link(struct mii_phy *phy)\n{\n\tu16 lpa;\n\n\tif (phy->autoneg) {\n\t\tlpa = sungem_phy_read(phy, MII_LPA);\n\n\t\tif (lpa & (LPA_10FULL | LPA_100FULL))\n\t\t\tphy->duplex = DUPLEX_FULL;\n\t\telse\n\t\t\tphy->duplex = DUPLEX_HALF;\n\t\tif (lpa & (LPA_100FULL | LPA_100HALF))\n\t\t\tphy->speed = SPEED_100;\n\t\telse\n\t\t\tphy->speed = SPEED_10;\n\t\tphy->pause = 0;\n\t}\n\t \n\n\treturn 0;\n}\n\nstatic int generic_suspend(struct mii_phy* phy)\n{\n\tsungem_phy_write(phy, MII_BMCR, BMCR_PDOWN);\n\n\treturn 0;\n}\n\nstatic int bcm5421_init(struct mii_phy* phy)\n{\n\tu16 data;\n\tunsigned int id;\n\n\tid = (sungem_phy_read(phy, MII_PHYSID1) << 16 | sungem_phy_read(phy, MII_PHYSID2));\n\n\t \n\tif (id == 0x002060e0) {\n\t\t \n\t\tsungem_phy_write(phy, 0x18, 0x1007);\n\t\tdata = sungem_phy_read(phy, 0x18);\n\t\tsungem_phy_write(phy, 0x18, data | 0x0400);\n\t\tsungem_phy_write(phy, 0x18, 0x0007);\n\t\tdata = sungem_phy_read(phy, 0x18);\n\t\tsungem_phy_write(phy, 0x18, data | 0x0800);\n\t\tsungem_phy_write(phy, 0x17, 0x000a);\n\t\tdata = sungem_phy_read(phy, 0x15);\n\t\tsungem_phy_write(phy, 0x15, data | 0x0200);\n\t}\n\n\t \n\tif ((id & 0xfffffff0) == 0x002062e0) {\n\t\tsungem_phy_write(phy, 4, 0x01e1);\n\t\tsungem_phy_write(phy, 9, 0x0300);\n\t}\n\n\t \n#ifdef CONFIG_PPC_PMAC\n\tif (phy->platform_data) {\n\t\tstruct device_node *np = of_get_parent(phy->platform_data);\n\t\tint can_low_power = 1;\n\t\tif (np == NULL || of_get_property(np, \"no-autolowpower\", NULL))\n\t\t\tcan_low_power = 0;\n\t\tof_node_put(np);\n\t\tif (can_low_power) {\n\t\t\t \n\t\t\tsungem_phy_write(phy, 0x1c, 0x9002);\n\t\t\tsungem_phy_write(phy, 0x1c, 0xa821);\n\t\t\tsungem_phy_write(phy, 0x1c, 0x941d);\n\t\t}\n\t}\n#endif  \n\n\treturn 0;\n}\n\nstatic int bcm54xx_setup_aneg(struct mii_phy *phy, u32 advertise)\n{\n\tu16 ctl, adv;\n\n\tphy->autoneg = 1;\n\tphy->speed = SPEED_10;\n\tphy->duplex = DUPLEX_HALF;\n\tphy->pause = 0;\n\tphy->advertising = advertise;\n\n\t \n\tadv = sungem_phy_read(phy, MII_ADVERTISE);\n\tadv &= ~(ADVERTISE_ALL | ADVERTISE_100BASE4);\n\tif (advertise & ADVERTISED_10baseT_Half)\n\t\tadv |= ADVERTISE_10HALF;\n\tif (advertise & ADVERTISED_10baseT_Full)\n\t\tadv |= ADVERTISE_10FULL;\n\tif (advertise & ADVERTISED_100baseT_Half)\n\t\tadv |= ADVERTISE_100HALF;\n\tif (advertise & ADVERTISED_100baseT_Full)\n\t\tadv |= ADVERTISE_100FULL;\n\tif (advertise & ADVERTISED_Pause)\n\t\tadv |= ADVERTISE_PAUSE_CAP;\n\tif (advertise & ADVERTISED_Asym_Pause)\n\t\tadv |= ADVERTISE_PAUSE_ASYM;\n\tsungem_phy_write(phy, MII_ADVERTISE, adv);\n\n\t \n\tadv = sungem_phy_read(phy, MII_1000BASETCONTROL);\n\tadv &= ~(MII_1000BASETCONTROL_FULLDUPLEXCAP|MII_1000BASETCONTROL_HALFDUPLEXCAP);\n\tif (advertise & SUPPORTED_1000baseT_Half)\n\t\tadv |= MII_1000BASETCONTROL_HALFDUPLEXCAP;\n\tif (advertise & SUPPORTED_1000baseT_Full)\n\t\tadv |= MII_1000BASETCONTROL_FULLDUPLEXCAP;\n\tsungem_phy_write(phy, MII_1000BASETCONTROL, adv);\n\n\t \n\tctl = sungem_phy_read(phy, MII_BMCR);\n\tctl |= (BMCR_ANENABLE | BMCR_ANRESTART);\n\tsungem_phy_write(phy, MII_BMCR, ctl);\n\n\treturn 0;\n}\n\nstatic int bcm54xx_setup_forced(struct mii_phy *phy, int speed, int fd)\n{\n\tu16 ctl;\n\n\tphy->autoneg = 0;\n\tphy->speed = speed;\n\tphy->duplex = fd;\n\tphy->pause = 0;\n\n\tctl = sungem_phy_read(phy, MII_BMCR);\n\tctl &= ~(BMCR_FULLDPLX|BMCR_SPEED100|BMCR_SPD2|BMCR_ANENABLE);\n\n\t \n\tsungem_phy_write(phy, MII_BMCR, ctl | BMCR_RESET);\n\n\t \n\tswitch(speed) {\n\tcase SPEED_10:\n\t\tbreak;\n\tcase SPEED_100:\n\t\tctl |= BMCR_SPEED100;\n\t\tbreak;\n\tcase SPEED_1000:\n\t\tctl |= BMCR_SPD2;\n\t}\n\tif (fd == DUPLEX_FULL)\n\t\tctl |= BMCR_FULLDPLX;\n\n\t \n\n\tsungem_phy_write(phy, MII_BMCR, ctl);\n\n\treturn 0;\n}\n\nstatic int bcm54xx_read_link(struct mii_phy *phy)\n{\n\tint link_mode;\n\tu16 val;\n\n\tif (phy->autoneg) {\n\t    \tval = sungem_phy_read(phy, MII_BCM5400_AUXSTATUS);\n\t\tlink_mode = ((val & MII_BCM5400_AUXSTATUS_LINKMODE_MASK) >>\n\t\t\t     MII_BCM5400_AUXSTATUS_LINKMODE_SHIFT);\n\t\tphy->duplex = phy_BCM5400_link_table[link_mode][0] ?\n\t\t\tDUPLEX_FULL : DUPLEX_HALF;\n\t\tphy->speed = phy_BCM5400_link_table[link_mode][2] ?\n\t\t\t\tSPEED_1000 :\n\t\t\t\t(phy_BCM5400_link_table[link_mode][1] ?\n\t\t\t\t SPEED_100 : SPEED_10);\n\t\tval = sungem_phy_read(phy, MII_LPA);\n\t\tphy->pause = (phy->duplex == DUPLEX_FULL) &&\n\t\t\t((val & LPA_PAUSE) != 0);\n\t}\n\t \n\n\treturn 0;\n}\n\nstatic int marvell88e1111_init(struct mii_phy* phy)\n{\n\tu16 rev;\n\n\t \n\trev = sungem_phy_read(phy, MII_PHYSID2) & 0x000f;\n\tif (rev == 0) {\n\t\tsungem_phy_write(phy, 0x1d, 0x000a);\n\t\tsungem_phy_write(phy, 0x1e, 0x0821);\n\n\t\tsungem_phy_write(phy, 0x1d, 0x0006);\n\t\tsungem_phy_write(phy, 0x1e, 0x8600);\n\n\t\tsungem_phy_write(phy, 0x1d, 0x000b);\n\t\tsungem_phy_write(phy, 0x1e, 0x0100);\n\n\t\tsungem_phy_write(phy, 0x1d, 0x0004);\n\t\tsungem_phy_write(phy, 0x1e, 0x4850);\n\t}\n\treturn 0;\n}\n\n#define BCM5421_MODE_MASK\t(1 << 5)\n\nstatic int bcm5421_poll_link(struct mii_phy* phy)\n{\n\tu32 phy_reg;\n\tint mode;\n\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0x1000);\n\tphy_reg = sungem_phy_read(phy, MII_NCONFIG);\n\n\tmode = (phy_reg & BCM5421_MODE_MASK) >> 5;\n\n\tif ( mode == BCM54XX_COPPER)\n\t\treturn genmii_poll_link(phy);\n\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0x2000);\n\tphy_reg = sungem_phy_read(phy, MII_NCONFIG);\n\n\tif (phy_reg & 0x0020)\n\t\treturn 0;\n\telse\n\t\treturn 1;\n}\n\nstatic int bcm5421_read_link(struct mii_phy* phy)\n{\n\tu32 phy_reg;\n\tint mode;\n\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0x1000);\n\tphy_reg = sungem_phy_read(phy, MII_NCONFIG);\n\n\tmode = (phy_reg & BCM5421_MODE_MASK ) >> 5;\n\n\tif ( mode == BCM54XX_COPPER)\n\t\treturn bcm54xx_read_link(phy);\n\n\tphy->speed = SPEED_1000;\n\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0x2000);\n\tphy_reg = sungem_phy_read(phy, MII_NCONFIG);\n\n\tif ( (phy_reg & 0x0080) >> 7)\n\t\tphy->duplex |=  DUPLEX_HALF;\n\telse\n\t\tphy->duplex |=  DUPLEX_FULL;\n\n\treturn 0;\n}\n\nstatic int bcm5421_enable_fiber(struct mii_phy* phy, int autoneg)\n{\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0x9020);\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0x945f);\n\n\tif (!autoneg) {\n\t\t \n\t\tsungem_phy_write(phy, MII_NCONFIG, 0xfc01);\n\t\tsungem_phy_write(phy, 0x0b, 0x0004);\n\t}\n\n\tphy->autoneg = autoneg;\n\n\treturn 0;\n}\n\n#define BCM5461_FIBER_LINK\t(1 << 2)\n#define BCM5461_MODE_MASK\t(3 << 1)\n\nstatic int bcm5461_poll_link(struct mii_phy* phy)\n{\n\tu32 phy_reg;\n\tint mode;\n\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0x7c00);\n\tphy_reg = sungem_phy_read(phy, MII_NCONFIG);\n\n\tmode = (phy_reg & BCM5461_MODE_MASK ) >> 1;\n\n\tif ( mode == BCM54XX_COPPER)\n\t\treturn genmii_poll_link(phy);\n\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0x7000);\n\tphy_reg = sungem_phy_read(phy, MII_NCONFIG);\n\n\tif (phy_reg & BCM5461_FIBER_LINK)\n\t\treturn 1;\n\telse\n\t\treturn 0;\n}\n\n#define BCM5461_FIBER_DUPLEX\t(1 << 3)\n\nstatic int bcm5461_read_link(struct mii_phy* phy)\n{\n\tu32 phy_reg;\n\tint mode;\n\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0x7c00);\n\tphy_reg = sungem_phy_read(phy, MII_NCONFIG);\n\n\tmode = (phy_reg & BCM5461_MODE_MASK ) >> 1;\n\n\tif ( mode == BCM54XX_COPPER) {\n\t\treturn bcm54xx_read_link(phy);\n\t}\n\n\tphy->speed = SPEED_1000;\n\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0x7000);\n\tphy_reg = sungem_phy_read(phy, MII_NCONFIG);\n\n\tif (phy_reg & BCM5461_FIBER_DUPLEX)\n\t\tphy->duplex |=  DUPLEX_FULL;\n\telse\n\t\tphy->duplex |=  DUPLEX_HALF;\n\n\treturn 0;\n}\n\nstatic int bcm5461_enable_fiber(struct mii_phy* phy, int autoneg)\n{\n\t \n\tsungem_phy_write(phy, MII_NCONFIG, 0xfc0b);\n\n\tif (autoneg) {\n\t\t \n\t\tsungem_phy_write(phy, MII_ADVERTISE, 0x01e0);\n\t\tsungem_phy_write(phy, MII_BMCR, 0x1140);\n\t} else {\n\t\t \n\t\tsungem_phy_write(phy, MII_BMCR, 0x0140);\n\t}\n\n\tphy->autoneg = autoneg;\n\n\treturn 0;\n}\n\nstatic int marvell_setup_aneg(struct mii_phy *phy, u32 advertise)\n{\n\tu16 ctl, adv;\n\n\tphy->autoneg = 1;\n\tphy->speed = SPEED_10;\n\tphy->duplex = DUPLEX_HALF;\n\tphy->pause = 0;\n\tphy->advertising = advertise;\n\n\t \n\tadv = sungem_phy_read(phy, MII_ADVERTISE);\n\tadv &= ~(ADVERTISE_ALL | ADVERTISE_100BASE4);\n\tif (advertise & ADVERTISED_10baseT_Half)\n\t\tadv |= ADVERTISE_10HALF;\n\tif (advertise & ADVERTISED_10baseT_Full)\n\t\tadv |= ADVERTISE_10FULL;\n\tif (advertise & ADVERTISED_100baseT_Half)\n\t\tadv |= ADVERTISE_100HALF;\n\tif (advertise & ADVERTISED_100baseT_Full)\n\t\tadv |= ADVERTISE_100FULL;\n\tif (advertise & ADVERTISED_Pause)\n\t\tadv |= ADVERTISE_PAUSE_CAP;\n\tif (advertise & ADVERTISED_Asym_Pause)\n\t\tadv |= ADVERTISE_PAUSE_ASYM;\n\tsungem_phy_write(phy, MII_ADVERTISE, adv);\n\n\t \n\tadv = sungem_phy_read(phy, MII_M1011_PHY_SPEC_CONTROL);\n\tadv |= MII_M1011_PHY_SPEC_CONTROL_AUTO_MDIX;\n\tadv &= ~(MII_1000BASETCONTROL_FULLDUPLEXCAP |\n\t\t\tMII_1000BASETCONTROL_HALFDUPLEXCAP);\n\tif (advertise & SUPPORTED_1000baseT_Half)\n\t\tadv |= MII_1000BASETCONTROL_HALFDUPLEXCAP;\n\tif (advertise & SUPPORTED_1000baseT_Full)\n\t\tadv |= MII_1000BASETCONTROL_FULLDUPLEXCAP;\n\tsungem_phy_write(phy, MII_1000BASETCONTROL, adv);\n\n\t \n\tctl = sungem_phy_read(phy, MII_BMCR);\n\tctl |= (BMCR_ANENABLE | BMCR_ANRESTART);\n\tsungem_phy_write(phy, MII_BMCR, ctl);\n\n\treturn 0;\n}\n\nstatic int marvell_setup_forced(struct mii_phy *phy, int speed, int fd)\n{\n\tu16 ctl, ctl2;\n\n\tphy->autoneg = 0;\n\tphy->speed = speed;\n\tphy->duplex = fd;\n\tphy->pause = 0;\n\n\tctl = sungem_phy_read(phy, MII_BMCR);\n\tctl &= ~(BMCR_FULLDPLX|BMCR_SPEED100|BMCR_SPD2|BMCR_ANENABLE);\n\tctl |= BMCR_RESET;\n\n\t \n\tswitch(speed) {\n\tcase SPEED_10:\n\t\tbreak;\n\tcase SPEED_100:\n\t\tctl |= BMCR_SPEED100;\n\t\tbreak;\n\t \n\tcase SPEED_1000:\n\t\tctl |= BMCR_SPD2;\n\t}\n\tif (fd == DUPLEX_FULL)\n\t\tctl |= BMCR_FULLDPLX;\n\n\t \n\tctl2 = sungem_phy_read(phy, MII_M1011_PHY_SPEC_CONTROL);\n\tctl2 &= ~(MII_M1011_PHY_SPEC_CONTROL_MANUAL_MDIX |\n\t\tMII_M1011_PHY_SPEC_CONTROL_AUTO_MDIX |\n\t\tMII_1000BASETCONTROL_FULLDUPLEXCAP |\n\t\tMII_1000BASETCONTROL_HALFDUPLEXCAP);\n\tif (speed == SPEED_1000)\n\t\tctl2 |= (fd == DUPLEX_FULL) ?\n\t\t\tMII_1000BASETCONTROL_FULLDUPLEXCAP :\n\t\t\tMII_1000BASETCONTROL_HALFDUPLEXCAP;\n\tsungem_phy_write(phy, MII_1000BASETCONTROL, ctl2);\n\n\t\n\n\tsungem_phy_write(phy, MII_BMCR, ctl);\n\n\treturn 0;\n}\n\nstatic int marvell_read_link(struct mii_phy *phy)\n{\n\tu16 status, pmask;\n\n\tif (phy->autoneg) {\n\t\tstatus = sungem_phy_read(phy, MII_M1011_PHY_SPEC_STATUS);\n\t\tif ((status & MII_M1011_PHY_SPEC_STATUS_RESOLVED) == 0)\n\t\t\treturn -EAGAIN;\n\t\tif (status & MII_M1011_PHY_SPEC_STATUS_1000)\n\t\t\tphy->speed = SPEED_1000;\n\t\telse if (status & MII_M1011_PHY_SPEC_STATUS_100)\n\t\t\tphy->speed = SPEED_100;\n\t\telse\n\t\t\tphy->speed = SPEED_10;\n\t\tif (status & MII_M1011_PHY_SPEC_STATUS_FULLDUPLEX)\n\t\t\tphy->duplex = DUPLEX_FULL;\n\t\telse\n\t\t\tphy->duplex = DUPLEX_HALF;\n\t\tpmask = MII_M1011_PHY_SPEC_STATUS_TX_PAUSE |\n\t\t\tMII_M1011_PHY_SPEC_STATUS_RX_PAUSE;\n\t\tphy->pause = (status & pmask) == pmask;\n\t}\n\t \n\n\treturn 0;\n}\n\n#define MII_BASIC_FEATURES \\\n\t(SUPPORTED_10baseT_Half | SUPPORTED_10baseT_Full |\t\\\n\t SUPPORTED_100baseT_Half | SUPPORTED_100baseT_Full |\t\\\n\t SUPPORTED_Autoneg | SUPPORTED_TP | SUPPORTED_MII |\t\\\n\t SUPPORTED_Pause)\n\n \n#define MII_GBIT_FEATURES \\\n\t(MII_BASIC_FEATURES |\t\\\n\t SUPPORTED_1000baseT_Half | SUPPORTED_1000baseT_Full)\n\n \nstatic const struct mii_phy_ops bcm5201_phy_ops = {\n\t.init\t\t= bcm5201_init,\n\t.suspend\t= bcm5201_suspend,\n\t.setup_aneg\t= genmii_setup_aneg,\n\t.setup_forced\t= genmii_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= genmii_read_link,\n};\n\nstatic struct mii_phy_def bcm5201_phy_def = {\n\t.phy_id\t\t= 0x00406210,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"BCM5201\",\n\t.features\t= MII_BASIC_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &bcm5201_phy_ops\n};\n\n \nstatic const struct mii_phy_ops bcm5221_phy_ops = {\n\t.suspend\t= bcm5221_suspend,\n\t.init\t\t= bcm5221_init,\n\t.setup_aneg\t= genmii_setup_aneg,\n\t.setup_forced\t= genmii_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= genmii_read_link,\n};\n\nstatic struct mii_phy_def bcm5221_phy_def = {\n\t.phy_id\t\t= 0x004061e0,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"BCM5221\",\n\t.features\t= MII_BASIC_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &bcm5221_phy_ops\n};\n\n \nstatic const struct mii_phy_ops bcm5241_phy_ops = {\n\t.suspend\t= bcm5241_suspend,\n\t.init\t\t= bcm5241_init,\n\t.setup_aneg\t= genmii_setup_aneg,\n\t.setup_forced\t= genmii_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= genmii_read_link,\n};\nstatic struct mii_phy_def bcm5241_phy_def = {\n\t.phy_id\t\t= 0x0143bc30,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"BCM5241\",\n\t.features\t= MII_BASIC_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &bcm5241_phy_ops\n};\n\n \nstatic const struct mii_phy_ops bcm5400_phy_ops = {\n\t.init\t\t= bcm5400_init,\n\t.suspend\t= bcm5400_suspend,\n\t.setup_aneg\t= bcm54xx_setup_aneg,\n\t.setup_forced\t= bcm54xx_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= bcm54xx_read_link,\n};\n\nstatic struct mii_phy_def bcm5400_phy_def = {\n\t.phy_id\t\t= 0x00206040,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"BCM5400\",\n\t.features\t= MII_GBIT_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &bcm5400_phy_ops\n};\n\n \nstatic const struct mii_phy_ops bcm5401_phy_ops = {\n\t.init\t\t= bcm5401_init,\n\t.suspend\t= bcm5401_suspend,\n\t.setup_aneg\t= bcm54xx_setup_aneg,\n\t.setup_forced\t= bcm54xx_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= bcm54xx_read_link,\n};\n\nstatic struct mii_phy_def bcm5401_phy_def = {\n\t.phy_id\t\t= 0x00206050,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"BCM5401\",\n\t.features\t= MII_GBIT_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &bcm5401_phy_ops\n};\n\n \nstatic const struct mii_phy_ops bcm5411_phy_ops = {\n\t.init\t\t= bcm5411_init,\n\t.suspend\t= generic_suspend,\n\t.setup_aneg\t= bcm54xx_setup_aneg,\n\t.setup_forced\t= bcm54xx_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= bcm54xx_read_link,\n};\n\nstatic struct mii_phy_def bcm5411_phy_def = {\n\t.phy_id\t\t= 0x00206070,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"BCM5411\",\n\t.features\t= MII_GBIT_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &bcm5411_phy_ops\n};\n\n \nstatic const struct mii_phy_ops bcm5421_phy_ops = {\n\t.init\t\t= bcm5421_init,\n\t.suspend\t= generic_suspend,\n\t.setup_aneg\t= bcm54xx_setup_aneg,\n\t.setup_forced\t= bcm54xx_setup_forced,\n\t.poll_link\t= bcm5421_poll_link,\n\t.read_link\t= bcm5421_read_link,\n\t.enable_fiber   = bcm5421_enable_fiber,\n};\n\nstatic struct mii_phy_def bcm5421_phy_def = {\n\t.phy_id\t\t= 0x002060e0,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"BCM5421\",\n\t.features\t= MII_GBIT_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &bcm5421_phy_ops\n};\n\n \nstatic const struct mii_phy_ops bcm5421k2_phy_ops = {\n\t.init\t\t= bcm5421_init,\n\t.suspend\t= generic_suspend,\n\t.setup_aneg\t= bcm54xx_setup_aneg,\n\t.setup_forced\t= bcm54xx_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= bcm54xx_read_link,\n};\n\nstatic struct mii_phy_def bcm5421k2_phy_def = {\n\t.phy_id\t\t= 0x002062e0,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"BCM5421-K2\",\n\t.features\t= MII_GBIT_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &bcm5421k2_phy_ops\n};\n\nstatic const struct mii_phy_ops bcm5461_phy_ops = {\n\t.init\t\t= bcm5421_init,\n\t.suspend\t= generic_suspend,\n\t.setup_aneg\t= bcm54xx_setup_aneg,\n\t.setup_forced\t= bcm54xx_setup_forced,\n\t.poll_link\t= bcm5461_poll_link,\n\t.read_link\t= bcm5461_read_link,\n\t.enable_fiber   = bcm5461_enable_fiber,\n};\n\nstatic struct mii_phy_def bcm5461_phy_def = {\n\t.phy_id\t\t= 0x002060c0,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"BCM5461\",\n\t.features\t= MII_GBIT_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &bcm5461_phy_ops\n};\n\n \nstatic const struct mii_phy_ops bcm5462V_phy_ops = {\n\t.init\t\t= bcm5421_init,\n\t.suspend\t= generic_suspend,\n\t.setup_aneg\t= bcm54xx_setup_aneg,\n\t.setup_forced\t= bcm54xx_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= bcm54xx_read_link,\n};\n\nstatic struct mii_phy_def bcm5462V_phy_def = {\n\t.phy_id\t\t= 0x002060d0,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"BCM5462-Vesta\",\n\t.features\t= MII_GBIT_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &bcm5462V_phy_ops\n};\n\n \nstatic const struct mii_phy_ops marvell88e1101_phy_ops = {\n\t.suspend\t= generic_suspend,\n\t.setup_aneg\t= marvell_setup_aneg,\n\t.setup_forced\t= marvell_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= marvell_read_link\n};\n\nstatic const struct mii_phy_ops marvell88e1111_phy_ops = {\n\t.init\t\t= marvell88e1111_init,\n\t.suspend\t= generic_suspend,\n\t.setup_aneg\t= marvell_setup_aneg,\n\t.setup_forced\t= marvell_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= marvell_read_link\n};\n\n \nstatic struct mii_phy_def marvell88e1101v1_phy_def = {\n\t.phy_id\t\t= 0x01410c20,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"Marvell 88E1101v1\",\n\t.features\t= MII_GBIT_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &marvell88e1101_phy_ops\n};\nstatic struct mii_phy_def marvell88e1101v2_phy_def = {\n\t.phy_id\t\t= 0x01410c60,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"Marvell 88E1101v2\",\n\t.features\t= MII_GBIT_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &marvell88e1101_phy_ops\n};\nstatic struct mii_phy_def marvell88e1111_phy_def = {\n\t.phy_id\t\t= 0x01410cc0,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"Marvell 88E1111\",\n\t.features\t= MII_GBIT_FEATURES,\n\t.magic_aneg\t= 1,\n\t.ops\t\t= &marvell88e1111_phy_ops\n};\n\n \nstatic const struct mii_phy_ops generic_phy_ops = {\n\t.setup_aneg\t= genmii_setup_aneg,\n\t.setup_forced\t= genmii_setup_forced,\n\t.poll_link\t= genmii_poll_link,\n\t.read_link\t= genmii_read_link\n};\n\nstatic struct mii_phy_def genmii_phy_def = {\n\t.phy_id\t\t= 0x00000000,\n\t.phy_id_mask\t= 0x00000000,\n\t.name\t\t= \"Generic MII\",\n\t.features\t= MII_BASIC_FEATURES,\n\t.magic_aneg\t= 0,\n\t.ops\t\t= &generic_phy_ops\n};\n\nstatic struct mii_phy_def* mii_phy_table[] = {\n\t&bcm5201_phy_def,\n\t&bcm5221_phy_def,\n\t&bcm5241_phy_def,\n\t&bcm5400_phy_def,\n\t&bcm5401_phy_def,\n\t&bcm5411_phy_def,\n\t&bcm5421_phy_def,\n\t&bcm5421k2_phy_def,\n\t&bcm5461_phy_def,\n\t&bcm5462V_phy_def,\n\t&marvell88e1101v1_phy_def,\n\t&marvell88e1101v2_phy_def,\n\t&marvell88e1111_phy_def,\n\t&genmii_phy_def,\n\tNULL\n};\n\nint sungem_phy_probe(struct mii_phy *phy, int mii_id)\n{\n\tint rc;\n\tu32 id;\n\tstruct mii_phy_def* def;\n\tint i;\n\n\t \n\tphy->mii_id = mii_id;\n\n\t \n\trc = reset_one_mii_phy(phy, mii_id);\n\tif (rc)\n\t\tgoto fail;\n\n\t \n\tid = (sungem_phy_read(phy, MII_PHYSID1) << 16 | sungem_phy_read(phy, MII_PHYSID2));\n\tprintk(KERN_DEBUG KBUILD_MODNAME \": \" \"PHY ID: %x, addr: %x\\n\",\n\t       id, mii_id);\n\tfor (i=0; (def = mii_phy_table[i]) != NULL; i++)\n\t\tif ((id & def->phy_id_mask) == def->phy_id)\n\t\t\tbreak;\n\t \n\tif (def == NULL)\n\t\tgoto fail;\n\n\tphy->def = def;\n\n\treturn 0;\nfail:\n\tphy->speed = 0;\n\tphy->duplex = 0;\n\tphy->pause = 0;\n\tphy->advertising = 0;\n\treturn -ENODEV;\n}\n\nEXPORT_SYMBOL(sungem_phy_probe);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}