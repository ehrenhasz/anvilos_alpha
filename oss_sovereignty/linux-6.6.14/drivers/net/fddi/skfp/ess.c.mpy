{
  "module_name": "ess.c",
  "hash_id": "26b32c6f665567bc6138bb9cef3c56439d727c9f3d0b81e190a3dd16b5909493",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/fddi/skfp/ess.c",
  "human_readable_source": "\n \n\n \n\n#include \"h/types.h\"\n#include \"h/fddi.h\"\n#include \"h/smc.h\"\n#include \"h/smt_p.h\"\n\n\n#ifndef\tSLIM_SMT\n\n#ifdef ESS\n\n#ifndef lint\n#define LINT_USE(x)\n#else\n#define LINT_USE(x)\t(x)=(x)\n#endif\n#define MS2BCLK(x)\t((x)*12500L)\n\n \n\nstatic const u_short plist_raf_alc_res[] = { SMT_P0012, SMT_P320B, SMT_P320F,\n\t\t\t\t\tSMT_P3210, SMT_P0019, SMT_P001A,\n\t\t\t\t\tSMT_P001D, 0 } ;\n\nstatic const u_short plist_raf_chg_req[] = { SMT_P320B, SMT_P320F, SMT_P3210,\n\t\t\t\t\tSMT_P001A, 0 } ;\n\nstatic const struct fddi_addr smt_sba_da = {{0x80,0x01,0x43,0x00,0x80,0x0C}} ;\nstatic const struct fddi_addr null_addr = {{0,0,0,0,0,0}} ;\n\n \n\n\n \n\nstatic void ess_send_response(struct s_smc *smc, struct smt_header *sm,\n\t\t\t      int sba_cmd);\nstatic void ess_config_fifo(struct s_smc *smc);\nstatic void ess_send_alc_req(struct s_smc *smc);\nstatic void ess_send_frame(struct s_smc *smc, SMbuf *mb);\n\n \n\n \n\nvoid ess_timer_poll(struct s_smc *smc);\nvoid ess_para_change(struct s_smc *smc);\nint ess_raf_received_pack(struct s_smc *smc, SMbuf *mb, struct smt_header *sm,\n\t\t\t  int fs);\nstatic int process_bw_alloc(struct s_smc *smc, long int payload, long int overhead);\n\n\n \n\n \nint ess_raf_received_pack(struct s_smc *smc, SMbuf *mb, struct smt_header *sm,\n\t\t\t  int fs)\n{\n\tvoid\t\t\t*p ;\t\t \n\tstruct smt_p_0016\t*cmd ;\t\t \n\tSMbuf\t\t\t*db ;\n\tu_long\t\t\tmsg_res_type ;\t \n\tu_long\t\t\tpayload, overhead ;\n\tint\t\t\tlocal ;\n\tint\t\t\ti ;\n\n\t \n\t local = ((fs & L_INDICATOR) != 0) ;\n\n\t \n\tif (!(p = (void *) sm_to_para(smc,sm,SMT_P0015))) {\n\t\tDB_ESS(\"ESS: RAF frame error, parameter type not found\");\n\t\treturn fs;\n\t}\n\tmsg_res_type = ((struct smt_p_0015 *)p)->res_type ;\n\n\t \n\tif (!(cmd = (struct smt_p_0016 *) sm_to_para(smc,sm,SMT_P0016))) {\n\t\t \n\t\t DB_ESS(\"ESS: RAF frame error, parameter command not found\");\n\t\t return fs;\n\t}\n\n\tDB_ESSN(2, \"fc %x\tft %x\", sm->smt_class, sm->smt_type);\n\tDB_ESSN(2, \"ver %x\ttran %x\", sm->smt_version, sm->smt_tid);\n\tDB_ESSN(2, \"stn_id %pM\", &sm->smt_source);\n\n\tDB_ESSN(2, \"infolen %x\tres %lx\", sm->smt_len, msg_res_type);\n\tDB_ESSN(2, \"sbacmd %x\", cmd->sba_cmd);\n\n\t \n\tswitch (cmd->sba_cmd) {\n\n\t \n\tcase REQUEST_ALLOCATION :\n\t\t \n\t\tif (sm->smt_type == SMT_REQUEST) {\n\t\t\t \n\t\t\tif (!local || smc->mib.fddiESSPayload)\n\t\t\t\treturn fs;\n\t\t\t\n\t\t\tp = (void *) sm_to_para(smc,sm,SMT_P0019)  ;\n\t\t\tfor (i = 0; i < 5; i++) {\n\t\t\t\tif (((struct smt_p_0019 *)p)->alloc_addr.a[i]) {\n\t\t\t\t\treturn fs;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t \n\t\t\tsmc->ess.alloc_trans_id = sm->smt_tid ;\n\t\t\tDB_ESS(\"ESS: save Alloc Req Trans ID %x\", sm->smt_tid);\n\t\t\tp = (void *) sm_to_para(smc,sm,SMT_P320F) ;\n\t\t\t((struct smt_p_320f *)p)->mib_payload =\n\t\t\t\tsmc->mib.a[PATH0].fddiPATHSbaPayload ;\n\t\t\tp = (void *) sm_to_para(smc,sm,SMT_P3210) ;\n\t\t\t((struct smt_p_3210 *)p)->mib_overhead =\n\t\t\t\tsmc->mib.a[PATH0].fddiPATHSbaOverhead ;\n\t\t\tsm->smt_dest = smt_sba_da ;\n\n\t\t\tif (smc->ess.local_sba_active)\n\t\t\t\treturn fs | I_INDICATOR;\n\n\t\t\tif (!(db = smt_get_mbuf(smc)))\n\t\t\t\treturn fs;\n\n\t\t\tdb->sm_len = mb->sm_len ;\n\t\t\tdb->sm_off = mb->sm_off ;\n\t\t\tmemcpy(((char *)(db->sm_data+db->sm_off)),(char *)sm,\n\t\t\t\t(int)db->sm_len) ;\n\t\t\tdump_smt(smc,\n\t\t\t\t(struct smt_header *)(db->sm_data+db->sm_off),\n\t\t\t\t\"RAF\") ;\n\t\t\tsmt_send_frame(smc,db,FC_SMT_INFO,0) ;\n\t\t\treturn fs;\n\t\t}\n\n\t\t \n\t\tif (smt_check_para(smc,sm,plist_raf_alc_res)) {\n\t\t\tDB_ESS(\"ESS: RAF with para problem, ignoring\");\n\t\t\treturn fs;\n\t\t}\n\n\t\t \n\t\tif ((((struct smt_p_320b *)sm_to_para(smc,sm,SMT_P320B))->path_index\n\t\t\t!= PRIMARY_RING) ||\n\t\t\t(msg_res_type != SYNC_BW) ||\n\t\t(((struct smt_p_reason *)sm_to_para(smc,sm,SMT_P0012))->rdf_reason\n\t\t\t!= SMT_RDF_SUCCESS) ||\n\t\t\t(sm->smt_tid != smc->ess.alloc_trans_id)) {\n\n\t\t\tDB_ESS(\"ESS: Allocation Response not accepted\");\n\t\t\treturn fs;\n\t\t}\n\n\t\t \n\t\tp = (void *) sm_to_para(smc,sm,SMT_P320F) ;\n                if (!p) {\n                        printk(KERN_ERR \"ESS: sm_to_para failed\");\n                        return fs;\n                }       \n\t\tpayload = ((struct smt_p_320f *)p)->mib_payload ;\n\t\tp = (void *) sm_to_para(smc,sm,SMT_P3210) ;\n                if (!p) {\n                        printk(KERN_ERR \"ESS: sm_to_para failed\");\n                        return fs;\n                }       \n\t\toverhead = ((struct smt_p_3210 *)p)->mib_overhead ;\n\n\t\tDB_ESSN(2, \"payload= %lx\toverhead= %lx\",\n\t\t\tpayload, overhead);\n\n\t\t \n\t\t(void)process_bw_alloc(smc,(long)payload,(long)overhead) ;\n\n\t\treturn fs;\n\t\t \n\n\t \n\tcase CHANGE_ALLOCATION :\n\t\t \n\t\tif (sm->smt_type != SMT_REQUEST) {\n\t\t\tDB_ESS(\"ESS: Do not process Change Responses\");\n\t\t\treturn fs;\n\t\t}\n\n\t\t \n\t\tif (smt_check_para(smc,sm,plist_raf_chg_req)) {\n\t\t\tDB_ESS(\"ESS: RAF with para problem, ignoring\");\n\t\t\treturn fs;\n\t\t}\n\n\t\t \n\t\tif ((((struct smt_p_320b *)sm_to_para(smc,sm,SMT_P320B))->path_index\n\t\t\t!= PRIMARY_RING) || (msg_res_type != SYNC_BW)) {\n\t\t\tDB_ESS(\"ESS: RAF frame with para problem, ignoring\");\n\t\t\treturn fs;\n\t\t}\n\n\t\t \n\t\tp = (void *) sm_to_para(smc,sm,SMT_P320F) ;\n\t\tpayload = ((struct smt_p_320f *)p)->mib_payload ;\n\t\tp = (void *) sm_to_para(smc,sm,SMT_P3210) ;\n\t\toverhead = ((struct smt_p_3210 *)p)->mib_overhead ;\n\n\t\tDB_ESSN(2, \"ESS: Change Request from %pM\",\n\t\t\t&sm->smt_source);\n\t\tDB_ESSN(2, \"payload= %lx\toverhead= %lx\",\n\t\t\tpayload, overhead);\n\n\t\t \n\t\tif(!process_bw_alloc(smc,(long)payload,(long)overhead))\n\t\t\treturn fs;\n\n\t\t \n\t\tess_send_response(smc,sm,CHANGE_ALLOCATION) ;\n\n\t\treturn fs;\n\t\t \n\n\t \n\tcase REPORT_ALLOCATION :\n\t\t \n\t\tif (sm->smt_type != SMT_REQUEST) {\n\t\t\tDB_ESS(\"ESS: Do not process a Report Reply\");\n\t\t\treturn fs;\n\t\t}\n\n\t\tDB_ESSN(2, \"ESS: Report Request from %pM\",\n\t\t\t&sm->smt_source);\n\n\t\t \n\t\tif (msg_res_type != SYNC_BW) {\n\t\t\tDB_ESS(\"ESS: ignoring RAF with para problem\");\n\t\t\treturn fs;\n\t\t}\n\n\t\t \n\t\tess_send_response(smc,sm,REPORT_ALLOCATION) ;\n\n\t\treturn fs;\n\t\t \n\n\tdefault:\n\t\t \n\t\tDB_ESS(\"ESS: ignoring RAF with bad sba_cmd\");\n\t\tbreak ;\n\t}\n\n\treturn fs;\n}\n\n \nstatic int process_bw_alloc(struct s_smc *smc, long int payload, long int overhead)\n{\n\t \n\n\t \n \n\n\t \n\tif (payload > MAX_PAYLOAD || overhead > 5000) {\n\t\tDB_ESS(\"ESS: payload / overhead not accepted\");\n\t\treturn FALSE;\n\t}\n\n\t \n\tif (smc->mib.fddiESSPayload &&\n\t\t((u_long)payload != smc->mib.fddiESSPayload ||\n\t\t(u_long)overhead != smc->mib.fddiESSOverhead)) {\n\t\tsmc->ess.raf_act_timer_poll = TRUE ;\n\t\tsmc->ess.timer_count = 0 ;\n\t}\n\n\t \n\tif (payload) {\n\t\tDB_ESSN(2, \"ESS: turn SMT_ST_SYNC_SERVICE bit on\");\n\t\tsmc->ess.sync_bw_available = TRUE ;\n\n\t\tsmc->ess.sync_bw = overhead -\n\t\t\t(long)smc->mib.m[MAC0].fddiMACT_Neg *\n\t\t\tpayload / 1562 ;\n\t}\n\telse {\n\t\tDB_ESSN(2, \"ESS: turn SMT_ST_SYNC_SERVICE bit off\");\n\t\tsmc->ess.sync_bw_available = FALSE ;\n\t\tsmc->ess.sync_bw = 0 ;\n\t\toverhead = 0 ;\n\t}\n\n\tsmc->mib.a[PATH0].fddiPATHSbaPayload = payload ;\n\tsmc->mib.a[PATH0].fddiPATHSbaOverhead = overhead ;\n\n\n\tDB_ESSN(2, \"tsync = %lx\", smc->ess.sync_bw);\n\n\tess_config_fifo(smc) ;\n\tset_formac_tsync(smc,smc->ess.sync_bw) ;\n\treturn TRUE;\n}\n\nstatic void ess_send_response(struct s_smc *smc, struct smt_header *sm,\n\t\t\t      int sba_cmd)\n{\n\tstruct smt_sba_chg\t*chg ;\n\tSMbuf\t\t\t*mb ;\n\tvoid\t\t\t*p ;\n\n\t \n\tif (sba_cmd == CHANGE_ALLOCATION) {\n\t\tif (!(mb=smt_build_frame(smc,SMT_RAF,SMT_REPLY,\n\t\t\t\tsizeof(struct smt_sba_chg))))\n\t\t\t\treturn ;\n\t}\n\telse {\n\t\tif (!(mb=smt_build_frame(smc,SMT_RAF,SMT_REPLY,\n\t\t\t\tsizeof(struct smt_sba_rep_res))))\n\t\t\t\treturn ;\n\t}\n\n\tchg = smtod(mb,struct smt_sba_chg *) ;\n\tchg->smt.smt_tid = sm->smt_tid ;\n\tchg->smt.smt_dest = sm->smt_source ;\n\n\t \n\tchg->s_type.para.p_type = SMT_P0015 ;\n\tchg->s_type.para.p_len = sizeof(struct smt_p_0015) - PARA_LEN ;\n\tchg->s_type.res_type = SYNC_BW ;\n\n\t \n\tchg->cmd.para.p_type = SMT_P0016 ;\n\tchg->cmd.para.p_len = sizeof(struct smt_p_0016) - PARA_LEN ;\n\tchg->cmd.sba_cmd = sba_cmd ;\n\n\t \n\tchg->path.para.p_type = SMT_P320B ;\n\tchg->path.para.p_len = sizeof(struct smt_p_320b) - PARA_LEN ;\n\tchg->path.mib_index = SBAPATHINDEX ;\n\tchg->path.path_pad = 0;\n\tchg->path.path_index = PRIMARY_RING ;\n\n\t \n\tchg->payload.para.p_type = SMT_P320F ;\n\tchg->payload.para.p_len = sizeof(struct smt_p_320f) - PARA_LEN ;\n\tchg->payload.mib_index = SBAPATHINDEX ;\n\tchg->payload.mib_payload = smc->mib.a[PATH0].fddiPATHSbaPayload ;\n\n\t \n\tchg->overhead.para.p_type = SMT_P3210 ;\n\tchg->overhead.para.p_len = sizeof(struct smt_p_3210) - PARA_LEN ;\n\tchg->overhead.mib_index = SBAPATHINDEX ;\n\tchg->overhead.mib_overhead = smc->mib.a[PATH0].fddiPATHSbaOverhead ;\n\n\tif (sba_cmd == CHANGE_ALLOCATION) {\n\t\t \n\t\tchg->cat.para.p_type = SMT_P001A ;\n\t\tchg->cat.para.p_len = sizeof(struct smt_p_001a) - PARA_LEN ;\n\t\tp = (void *) sm_to_para(smc,sm,SMT_P001A) ;\n\t\tchg->cat.category = ((struct smt_p_001a *)p)->category ;\n\t}\n\tdump_smt(smc,(struct smt_header *)chg,\"RAF\") ;\n\tess_send_frame(smc,mb) ;\n}\n\nvoid ess_timer_poll(struct s_smc *smc)\n{\n\tif (!smc->ess.raf_act_timer_poll)\n\t\treturn ;\n\n\tDB_ESSN(2, \"ESS: timer_poll\");\n\n\tsmc->ess.timer_count++ ;\n\tif (smc->ess.timer_count == 10) {\n\t\tsmc->ess.timer_count = 0 ;\n\t\tess_send_alc_req(smc) ;\n\t}\n}\n\nstatic void ess_send_alc_req(struct s_smc *smc)\n{\n\tstruct smt_sba_alc_req *req ;\n\tSMbuf\t*mb ;\n\n\t \n\tif (!smc->mib.fddiESSPayload) {\n\t\tsmc->mib.fddiESSOverhead = 0 ;\n\t}\n\telse {\n\t\tif (!smc->mib.fddiESSOverhead)\n\t\t\tsmc->mib.fddiESSOverhead = DEFAULT_OV ;\n\t}\n\n\tif (smc->mib.fddiESSOverhead ==\n\t\tsmc->mib.a[PATH0].fddiPATHSbaOverhead &&\n\t\tsmc->mib.fddiESSPayload ==\n\t\tsmc->mib.a[PATH0].fddiPATHSbaPayload){\n\t\tsmc->ess.raf_act_timer_poll = FALSE ;\n\t\tsmc->ess.timer_count = 7 ;\t \n\t\treturn ;\n\t}\n\t\n\t \n\tif (!(mb=smt_build_frame(smc,SMT_RAF,SMT_REQUEST,\n\t\t\tsizeof(struct smt_sba_alc_req))))\n\t\t\treturn ;\n\treq = smtod(mb,struct smt_sba_alc_req *) ;\n\treq->smt.smt_tid = smc->ess.alloc_trans_id = smt_get_tid(smc) ;\n\treq->smt.smt_dest = smt_sba_da ;\n\n\t \n\treq->s_type.para.p_type = SMT_P0015 ;\n\treq->s_type.para.p_len = sizeof(struct smt_p_0015) - PARA_LEN ;\n\treq->s_type.res_type = SYNC_BW ;\n\n\t \n\treq->cmd.para.p_type = SMT_P0016 ;\n\treq->cmd.para.p_len = sizeof(struct smt_p_0016) - PARA_LEN ;\n\treq->cmd.sba_cmd = REQUEST_ALLOCATION ;\n\n\t \n\n\t \n\treq->path.para.p_type = SMT_P320B ;\n\treq->path.para.p_len = sizeof(struct smt_p_320b) - PARA_LEN ;\n\treq->path.mib_index = SBAPATHINDEX ;\n\treq->path.path_pad = 0;\n\treq->path.path_index = PRIMARY_RING ;\n\n\t \n\treq->pl_req.para.p_type = SMT_P0017 ;\n\treq->pl_req.para.p_len = sizeof(struct smt_p_0017) - PARA_LEN ;\n\treq->pl_req.sba_pl_req = smc->mib.fddiESSPayload -\n\t\tsmc->mib.a[PATH0].fddiPATHSbaPayload ;\n\n\t \n\treq->ov_req.para.p_type = SMT_P0018 ;\n\treq->ov_req.para.p_len = sizeof(struct smt_p_0018) - PARA_LEN ;\n\treq->ov_req.sba_ov_req = smc->mib.fddiESSOverhead -\n\t\tsmc->mib.a[PATH0].fddiPATHSbaOverhead ;\n\n\t \n\treq->payload.para.p_type = SMT_P320F ;\n\treq->payload.para.p_len = sizeof(struct smt_p_320f) - PARA_LEN ;\n\treq->payload.mib_index = SBAPATHINDEX ;\n\treq->payload.mib_payload = smc->mib.a[PATH0].fddiPATHSbaPayload ;\n\n\t \n\treq->overhead.para.p_type = SMT_P3210 ;\n\treq->overhead.para.p_len = sizeof(struct smt_p_3210) - PARA_LEN ;\n\treq->overhead.mib_index = SBAPATHINDEX ;\n\treq->overhead.mib_overhead = smc->mib.a[PATH0].fddiPATHSbaOverhead ;\n\n\t \n\treq->a_addr.para.p_type = SMT_P0019 ;\n\treq->a_addr.para.p_len = sizeof(struct smt_p_0019) - PARA_LEN ;\n\treq->a_addr.sba_pad = 0;\n\treq->a_addr.alloc_addr = null_addr ;\n\n\t \n\treq->cat.para.p_type = SMT_P001A ;\n\treq->cat.para.p_len = sizeof(struct smt_p_001a) - PARA_LEN ;\n\treq->cat.category = smc->mib.fddiESSCategory ;\n\n\t \n\treq->tneg.para.p_type = SMT_P001B ;\n\treq->tneg.para.p_len = sizeof(struct smt_p_001b) - PARA_LEN ;\n\treq->tneg.max_t_neg = smc->mib.fddiESSMaxTNeg ;\n\n\t \n\treq->segm.para.p_type = SMT_P001C ;\n\treq->segm.para.p_len = sizeof(struct smt_p_001c) - PARA_LEN ;\n\treq->segm.min_seg_siz = smc->mib.fddiESSMinSegmentSize ;\n\n\tdump_smt(smc,(struct smt_header *)req,\"RAF\") ;\n\tess_send_frame(smc,mb) ;\n}\n\nstatic void ess_send_frame(struct s_smc *smc, SMbuf *mb)\n{\n\t \n\tif (smc->ess.local_sba_active) {\n\t\t \n\t\tDB_ESS(\"ESS:Send to the local SBA\");\n\t\tif (!smc->ess.sba_reply_pend)\n\t\t\tsmc->ess.sba_reply_pend = mb ;\n\t\telse {\n\t\t\tDB_ESS(\"Frame is lost - another frame was pending\");\n\t\t\tsmt_free_mbuf(smc,mb) ;\n\t\t}\n\t}\n\telse {\n\t\t \n\t\tDB_ESS(\"ESS:Send to the network\");\n\t\tsmt_send_frame(smc,mb,FC_SMT_INFO,0) ;\n\t}\n}\n\nvoid ess_para_change(struct s_smc *smc)\n{\n\t(void)process_bw_alloc(smc,(long)smc->mib.a[PATH0].fddiPATHSbaPayload,\n\t\t(long)smc->mib.a[PATH0].fddiPATHSbaOverhead) ;\n}\n\nstatic void ess_config_fifo(struct s_smc *smc)\n{\n\t \n\tif (smc->mib.a[PATH0].fddiPATHSbaPayload) {\n\t\tif (smc->hw.fp.fifo.fifo_config_mode & SYNC_TRAFFIC_ON &&\n\t\t\t(smc->hw.fp.fifo.fifo_config_mode&SEND_ASYNC_AS_SYNC) ==\n\t\t\tsmc->mib.fddiESSSynchTxMode) {\n\t\t\treturn ;\n\t\t}\n\t}\n\telse {\n\t\tif (!(smc->hw.fp.fifo.fifo_config_mode & SYNC_TRAFFIC_ON)) {\n\t\t\treturn ;\n\t\t}\n\t}\n\n\t \n\tformac_reinit_tx(smc) ;\n}\n\n#endif  \n\n#endif\t \n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}