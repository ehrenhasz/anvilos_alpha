{
  "module_name": "emac-ethtool.c",
  "hash_id": "0353c8d213e85d0b48f41158297503a4f85b7bcdcefe80073459e6d5c6e0f308",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/qualcomm/emac/emac-ethtool.c",
  "human_readable_source": "\n \n\n#include <linux/ethtool.h>\n#include <linux/phy.h>\n\n#include \"emac.h\"\n\nstatic const char * const emac_ethtool_stat_strings[] = {\n\t\"rx_ok\",\n\t\"rx_bcast\",\n\t\"rx_mcast\",\n\t\"rx_pause\",\n\t\"rx_ctrl\",\n\t\"rx_fcs_err\",\n\t\"rx_len_err\",\n\t\"rx_byte_cnt\",\n\t\"rx_runt\",\n\t\"rx_frag\",\n\t\"rx_sz_64\",\n\t\"rx_sz_65_127\",\n\t\"rx_sz_128_255\",\n\t\"rx_sz_256_511\",\n\t\"rx_sz_512_1023\",\n\t\"rx_sz_1024_1518\",\n\t\"rx_sz_1519_max\",\n\t\"rx_sz_ov\",\n\t\"rx_rxf_ov\",\n\t\"rx_align_err\",\n\t\"rx_bcast_byte_cnt\",\n\t\"rx_mcast_byte_cnt\",\n\t\"rx_err_addr\",\n\t\"rx_crc_align\",\n\t\"rx_jabbers\",\n\t\"tx_ok\",\n\t\"tx_bcast\",\n\t\"tx_mcast\",\n\t\"tx_pause\",\n\t\"tx_exc_defer\",\n\t\"tx_ctrl\",\n\t\"tx_defer\",\n\t\"tx_byte_cnt\",\n\t\"tx_sz_64\",\n\t\"tx_sz_65_127\",\n\t\"tx_sz_128_255\",\n\t\"tx_sz_256_511\",\n\t\"tx_sz_512_1023\",\n\t\"tx_sz_1024_1518\",\n\t\"tx_sz_1519_max\",\n\t\"tx_1_col\",\n\t\"tx_2_col\",\n\t\"tx_late_col\",\n\t\"tx_abort_col\",\n\t\"tx_underrun\",\n\t\"tx_rd_eop\",\n\t\"tx_len_err\",\n\t\"tx_trunc\",\n\t\"tx_bcast_byte\",\n\t\"tx_mcast_byte\",\n\t\"tx_col\",\n};\n\n#define EMAC_STATS_LEN\tARRAY_SIZE(emac_ethtool_stat_strings)\n\nstatic u32 emac_get_msglevel(struct net_device *netdev)\n{\n\tstruct emac_adapter *adpt = netdev_priv(netdev);\n\n\treturn adpt->msg_enable;\n}\n\nstatic void emac_set_msglevel(struct net_device *netdev, u32 data)\n{\n\tstruct emac_adapter *adpt = netdev_priv(netdev);\n\n\tadpt->msg_enable = data;\n}\n\nstatic int emac_get_sset_count(struct net_device *netdev, int sset)\n{\n\tswitch (sset) {\n\tcase ETH_SS_PRIV_FLAGS:\n\t\treturn 1;\n\tcase ETH_SS_STATS:\n\t\treturn EMAC_STATS_LEN;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic void emac_get_strings(struct net_device *netdev, u32 stringset, u8 *data)\n{\n\tunsigned int i;\n\n\tswitch (stringset) {\n\tcase ETH_SS_PRIV_FLAGS:\n\t\tstrcpy(data, \"single-pause-mode\");\n\t\tbreak;\n\n\tcase ETH_SS_STATS:\n\t\tfor (i = 0; i < EMAC_STATS_LEN; i++) {\n\t\t\tstrscpy(data, emac_ethtool_stat_strings[i],\n\t\t\t\tETH_GSTRING_LEN);\n\t\t\tdata += ETH_GSTRING_LEN;\n\t\t}\n\t\tbreak;\n\t}\n}\n\nstatic void emac_get_ethtool_stats(struct net_device *netdev,\n\t\t\t\t   struct ethtool_stats *stats,\n\t\t\t\t   u64 *data)\n{\n\tstruct emac_adapter *adpt = netdev_priv(netdev);\n\n\tspin_lock(&adpt->stats.lock);\n\n\temac_update_hw_stats(adpt);\n\tmemcpy(data, &adpt->stats, EMAC_STATS_LEN * sizeof(u64));\n\n\tspin_unlock(&adpt->stats.lock);\n}\n\nstatic int emac_nway_reset(struct net_device *netdev)\n{\n\tstruct phy_device *phydev = netdev->phydev;\n\n\tif (!phydev)\n\t\treturn -ENODEV;\n\n\treturn genphy_restart_aneg(phydev);\n}\n\nstatic void emac_get_ringparam(struct net_device *netdev,\n\t\t\t       struct ethtool_ringparam *ring,\n\t\t\t       struct kernel_ethtool_ringparam *kernel_ring,\n\t\t\t       struct netlink_ext_ack *extack)\n{\n\tstruct emac_adapter *adpt = netdev_priv(netdev);\n\n\tring->rx_max_pending = EMAC_MAX_RX_DESCS;\n\tring->tx_max_pending = EMAC_MAX_TX_DESCS;\n\tring->rx_pending = adpt->rx_desc_cnt;\n\tring->tx_pending = adpt->tx_desc_cnt;\n}\n\nstatic int emac_set_ringparam(struct net_device *netdev,\n\t\t\t      struct ethtool_ringparam *ring,\n\t\t\t      struct kernel_ethtool_ringparam *kernel_ring,\n\t\t\t      struct netlink_ext_ack *extack)\n{\n\tstruct emac_adapter *adpt = netdev_priv(netdev);\n\n\t \n\tif (ring->rx_mini_pending || ring->rx_jumbo_pending)\n\t\treturn -EINVAL;\n\n\tadpt->tx_desc_cnt =\n\t\tclamp_val(ring->tx_pending, EMAC_MIN_TX_DESCS, EMAC_MAX_TX_DESCS);\n\n\tadpt->rx_desc_cnt =\n\t\tclamp_val(ring->rx_pending, EMAC_MIN_RX_DESCS, EMAC_MAX_RX_DESCS);\n\n\tif (netif_running(netdev))\n\t\treturn emac_reinit_locked(adpt);\n\n\treturn 0;\n}\n\nstatic void emac_get_pauseparam(struct net_device *netdev,\n\t\t\t\tstruct ethtool_pauseparam *pause)\n{\n\tstruct emac_adapter *adpt = netdev_priv(netdev);\n\n\tpause->autoneg = adpt->automatic ? AUTONEG_ENABLE : AUTONEG_DISABLE;\n\tpause->rx_pause = adpt->rx_flow_control ? 1 : 0;\n\tpause->tx_pause = adpt->tx_flow_control ? 1 : 0;\n}\n\nstatic int emac_set_pauseparam(struct net_device *netdev,\n\t\t\t       struct ethtool_pauseparam *pause)\n{\n\tstruct emac_adapter *adpt = netdev_priv(netdev);\n\n\tadpt->automatic = pause->autoneg == AUTONEG_ENABLE;\n\tadpt->rx_flow_control = pause->rx_pause != 0;\n\tadpt->tx_flow_control = pause->tx_pause != 0;\n\n\tif (netif_running(netdev))\n\t\treturn emac_reinit_locked(adpt);\n\n\treturn 0;\n}\n\n \nstatic const u16 emac_regs[] = {\n\tEMAC_DMA_MAS_CTRL,\n\tEMAC_MAC_CTRL,\n\tEMAC_TXQ_CTRL_0,\n\tEMAC_RXQ_CTRL_0,\n\tEMAC_DMA_CTRL,\n\tEMAC_INT_MASK,\n\tEMAC_AXI_MAST_CTRL,\n\tEMAC_CORE_HW_VERSION,\n\tEMAC_MISC_CTRL,\n};\n\n \n#define EMAC_REGS_VERSION\t0\n\n#define EMAC_MAX_REG_SIZE\tARRAY_SIZE(emac_regs)\n\nstatic void emac_get_regs(struct net_device *netdev,\n\t\t\t  struct ethtool_regs *regs, void *buff)\n{\n\tstruct emac_adapter *adpt = netdev_priv(netdev);\n\tu32 *val = buff;\n\tunsigned int i;\n\n\tregs->version = EMAC_REGS_VERSION;\n\tregs->len = EMAC_MAX_REG_SIZE * sizeof(u32);\n\n\tfor (i = 0; i < EMAC_MAX_REG_SIZE; i++)\n\t\tval[i] = readl(adpt->base + emac_regs[i]);\n}\n\nstatic int emac_get_regs_len(struct net_device *netdev)\n{\n\treturn EMAC_MAX_REG_SIZE * sizeof(u32);\n}\n\n#define EMAC_PRIV_ENABLE_SINGLE_PAUSE\tBIT(0)\n\nstatic int emac_set_priv_flags(struct net_device *netdev, u32 flags)\n{\n\tstruct emac_adapter *adpt = netdev_priv(netdev);\n\n\tadpt->single_pause_mode = !!(flags & EMAC_PRIV_ENABLE_SINGLE_PAUSE);\n\n\tif (netif_running(netdev))\n\t\treturn emac_reinit_locked(adpt);\n\n\treturn 0;\n}\n\nstatic u32 emac_get_priv_flags(struct net_device *netdev)\n{\n\tstruct emac_adapter *adpt = netdev_priv(netdev);\n\n\treturn adpt->single_pause_mode ? EMAC_PRIV_ENABLE_SINGLE_PAUSE : 0;\n}\n\nstatic const struct ethtool_ops emac_ethtool_ops = {\n\t.get_link_ksettings = phy_ethtool_get_link_ksettings,\n\t.set_link_ksettings = phy_ethtool_set_link_ksettings,\n\n\t.get_msglevel    = emac_get_msglevel,\n\t.set_msglevel    = emac_set_msglevel,\n\n\t.get_sset_count  = emac_get_sset_count,\n\t.get_strings = emac_get_strings,\n\t.get_ethtool_stats = emac_get_ethtool_stats,\n\n\t.get_ringparam = emac_get_ringparam,\n\t.set_ringparam = emac_set_ringparam,\n\n\t.get_pauseparam = emac_get_pauseparam,\n\t.set_pauseparam = emac_set_pauseparam,\n\n\t.nway_reset = emac_nway_reset,\n\n\t.get_link = ethtool_op_get_link,\n\n\t.get_regs_len    = emac_get_regs_len,\n\t.get_regs        = emac_get_regs,\n\n\t.set_priv_flags = emac_set_priv_flags,\n\t.get_priv_flags = emac_get_priv_flags,\n};\n\nvoid emac_set_ethtool_ops(struct net_device *netdev)\n{\n\tnetdev->ethtool_ops = &emac_ethtool_ops;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}