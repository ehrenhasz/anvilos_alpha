{
  "module_name": "emac-sgmii-fsm9900.c",
  "hash_id": "c5718605e507846e5457a25f135fc750a77ebbfe0accedf4c8e9d9413faad0d9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/qualcomm/emac/emac-sgmii-fsm9900.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/iopoll.h>\n#include \"emac.h\"\n\n \n#define EMAC_QSERDES_COM_SYS_CLK_CTRL\t\t0x0000\n#define EMAC_QSERDES_COM_PLL_CNTRL\t\t0x0014\n#define EMAC_QSERDES_COM_PLL_IP_SETI\t\t0x0018\n#define EMAC_QSERDES_COM_PLL_CP_SETI\t\t0x0024\n#define EMAC_QSERDES_COM_PLL_IP_SETP\t\t0x0028\n#define EMAC_QSERDES_COM_PLL_CP_SETP\t\t0x002c\n#define EMAC_QSERDES_COM_SYSCLK_EN_SEL\t\t0x0038\n#define EMAC_QSERDES_COM_RESETSM_CNTRL\t\t0x0040\n#define EMAC_QSERDES_COM_PLLLOCK_CMP1\t\t0x0044\n#define EMAC_QSERDES_COM_PLLLOCK_CMP2\t\t0x0048\n#define EMAC_QSERDES_COM_PLLLOCK_CMP3\t\t0x004c\n#define EMAC_QSERDES_COM_PLLLOCK_CMP_EN\t\t0x0050\n#define EMAC_QSERDES_COM_DEC_START1\t\t0x0064\n#define EMAC_QSERDES_COM_DIV_FRAC_START1\t0x0098\n#define EMAC_QSERDES_COM_DIV_FRAC_START2\t0x009c\n#define EMAC_QSERDES_COM_DIV_FRAC_START3\t0x00a0\n#define EMAC_QSERDES_COM_DEC_START2\t\t0x00a4\n#define EMAC_QSERDES_COM_PLL_CRCTRL\t\t0x00ac\n#define EMAC_QSERDES_COM_RESET_SM\t\t0x00bc\n#define EMAC_QSERDES_TX_BIST_MODE_LANENO\t0x0100\n#define EMAC_QSERDES_TX_TX_EMP_POST1_LVL\t0x0108\n#define EMAC_QSERDES_TX_TX_DRV_LVL\t\t0x010c\n#define EMAC_QSERDES_TX_LANE_MODE\t\t0x0150\n#define EMAC_QSERDES_TX_TRAN_DRVR_EMP_EN\t0x0170\n#define EMAC_QSERDES_RX_CDR_CONTROL\t\t0x0200\n#define EMAC_QSERDES_RX_CDR_CONTROL2\t\t0x0210\n#define EMAC_QSERDES_RX_RX_EQ_GAIN12\t\t0x0230\n\n \n#define EMAC_SGMII_PHY_SERDES_START\t\t0x0000\n#define EMAC_SGMII_PHY_CMN_PWR_CTRL\t\t0x0004\n#define EMAC_SGMII_PHY_RX_PWR_CTRL\t\t0x0008\n#define EMAC_SGMII_PHY_TX_PWR_CTRL\t\t0x000C\n#define EMAC_SGMII_PHY_LANE_CTRL1\t\t0x0018\n#define EMAC_SGMII_PHY_CDR_CTRL0\t\t0x0058\n#define EMAC_SGMII_PHY_POW_DWN_CTRL0\t\t0x0080\n#define EMAC_SGMII_PHY_INTERRUPT_MASK\t\t0x00b4\n\n#define PLL_IPSETI(x)\t\t\t\t((x) & 0x3f)\n\n#define PLL_CPSETI(x)\t\t\t\t((x) & 0xff)\n\n#define PLL_IPSETP(x)\t\t\t\t((x) & 0x3f)\n\n#define PLL_CPSETP(x)\t\t\t\t((x) & 0x1f)\n\n#define PLL_RCTRL(x)\t\t\t\t(((x) & 0xf) << 4)\n#define PLL_CCTRL(x)\t\t\t\t((x) & 0xf)\n\n#define LANE_MODE(x)\t\t\t\t((x) & 0x1f)\n\n#define SYSCLK_CM\t\t\t\tBIT(4)\n#define SYSCLK_AC_COUPLE\t\t\tBIT(3)\n\n#define OCP_EN\t\t\t\t\tBIT(5)\n#define PLL_DIV_FFEN\t\t\t\tBIT(2)\n#define PLL_DIV_ORD\t\t\t\tBIT(1)\n\n#define SYSCLK_SEL_CMOS\t\t\t\tBIT(3)\n\n#define FRQ_TUNE_MODE\t\t\t\tBIT(4)\n\n#define PLLLOCK_CMP_EN\t\t\t\tBIT(0)\n\n#define DEC_START1_MUX\t\t\t\tBIT(7)\n#define DEC_START1(x)\t\t\t\t((x) & 0x7f)\n\n#define DIV_FRAC_START_MUX\t\t\tBIT(7)\n#define DIV_FRAC_START(x)\t\t\t((x) & 0x7f)\n\n#define DIV_FRAC_START3_MUX\t\t\tBIT(4)\n#define DIV_FRAC_START3(x)\t\t\t((x) & 0xf)\n\n#define DEC_START2_MUX\t\t\t\tBIT(1)\n#define DEC_START2\t\t\t\tBIT(0)\n\n#define READY\t\t\t\t\tBIT(5)\n\n#define TX_EMP_POST1_LVL_MUX\t\t\tBIT(5)\n#define TX_EMP_POST1_LVL(x)\t\t\t((x) & 0x1f)\n\n#define TX_DRV_LVL_MUX\t\t\t\tBIT(4)\n#define TX_DRV_LVL(x)\t\t\t\t((x) & 0xf)\n\n#define EMP_EN_MUX\t\t\t\tBIT(1)\n#define EMP_EN\t\t\t\t\tBIT(0)\n\n#define SECONDORDERENABLE\t\t\tBIT(6)\n#define FIRSTORDER_THRESH(x)\t\t\t(((x) & 0x7) << 3)\n#define SECONDORDERGAIN(x)\t\t\t((x) & 0x7)\n\n#define RX_EQ_GAIN2(x)\t\t\t\t(((x) & 0xf) << 4)\n#define RX_EQ_GAIN1(x)\t\t\t\t((x) & 0xf)\n\n#define SERDES_START\t\t\t\tBIT(0)\n\n#define BIAS_EN\t\t\t\t\tBIT(6)\n#define PLL_EN\t\t\t\t\tBIT(5)\n#define SYSCLK_EN\t\t\t\tBIT(4)\n#define CLKBUF_L_EN\t\t\t\tBIT(3)\n#define PLL_TXCLK_EN\t\t\t\tBIT(1)\n#define PLL_RXCLK_EN\t\t\t\tBIT(0)\n\n#define L0_RX_SIGDET_EN\t\t\t\tBIT(7)\n#define L0_RX_TERM_MODE(x)\t\t\t(((x) & 3) << 4)\n#define L0_RX_I_EN\t\t\t\tBIT(1)\n\n#define L0_TX_EN\t\t\t\tBIT(5)\n#define L0_CLKBUF_EN\t\t\t\tBIT(4)\n#define L0_TRAN_BIAS_EN\t\t\t\tBIT(1)\n\n#define L0_RX_EQUALIZE_ENABLE\t\t\tBIT(6)\n#define L0_RESET_TSYNC_EN\t\t\tBIT(4)\n#define L0_DRV_LVL(x)\t\t\t\t((x) & 0xf)\n\n#define PWRDN_B\t\t\t\t\tBIT(0)\n#define CDR_MAX_CNT(x)\t\t\t\t((x) & 0xff)\n\n#define PLLLOCK_CMP(x)\t\t\t\t((x) & 0xff)\n\n#define SERDES_START_WAIT_TIMES\t\t\t100\n\nstruct emac_reg_write {\n\tunsigned int offset;\n\tu32 val;\n};\n\nstatic void emac_reg_write_all(void __iomem *base,\n\t\t\t       const struct emac_reg_write *itr, size_t size)\n{\n\tsize_t i;\n\n\tfor (i = 0; i < size; ++itr, ++i)\n\t\twritel(itr->val, base + itr->offset);\n}\n\nstatic const struct emac_reg_write physical_coding_sublayer_programming[] = {\n\t{EMAC_SGMII_PHY_CDR_CTRL0, CDR_MAX_CNT(15)},\n\t{EMAC_SGMII_PHY_POW_DWN_CTRL0, PWRDN_B},\n\t{EMAC_SGMII_PHY_CMN_PWR_CTRL,\n\t\tBIAS_EN | SYSCLK_EN | CLKBUF_L_EN | PLL_TXCLK_EN | PLL_RXCLK_EN},\n\t{EMAC_SGMII_PHY_TX_PWR_CTRL, L0_TX_EN | L0_CLKBUF_EN | L0_TRAN_BIAS_EN},\n\t{EMAC_SGMII_PHY_RX_PWR_CTRL,\n\t\tL0_RX_SIGDET_EN | L0_RX_TERM_MODE(1) | L0_RX_I_EN},\n\t{EMAC_SGMII_PHY_CMN_PWR_CTRL,\n\t\tBIAS_EN | PLL_EN | SYSCLK_EN | CLKBUF_L_EN | PLL_TXCLK_EN |\n\t\tPLL_RXCLK_EN},\n\t{EMAC_SGMII_PHY_LANE_CTRL1,\n\t\tL0_RX_EQUALIZE_ENABLE | L0_RESET_TSYNC_EN | L0_DRV_LVL(15)},\n};\n\nstatic const struct emac_reg_write sysclk_refclk_setting[] = {\n\t{EMAC_QSERDES_COM_SYSCLK_EN_SEL, SYSCLK_SEL_CMOS},\n\t{EMAC_QSERDES_COM_SYS_CLK_CTRL,\tSYSCLK_CM | SYSCLK_AC_COUPLE},\n};\n\nstatic const struct emac_reg_write pll_setting[] = {\n\t{EMAC_QSERDES_COM_PLL_IP_SETI, PLL_IPSETI(1)},\n\t{EMAC_QSERDES_COM_PLL_CP_SETI, PLL_CPSETI(59)},\n\t{EMAC_QSERDES_COM_PLL_IP_SETP, PLL_IPSETP(10)},\n\t{EMAC_QSERDES_COM_PLL_CP_SETP, PLL_CPSETP(9)},\n\t{EMAC_QSERDES_COM_PLL_CRCTRL, PLL_RCTRL(15) | PLL_CCTRL(11)},\n\t{EMAC_QSERDES_COM_PLL_CNTRL, OCP_EN | PLL_DIV_FFEN | PLL_DIV_ORD},\n\t{EMAC_QSERDES_COM_DEC_START1, DEC_START1_MUX | DEC_START1(2)},\n\t{EMAC_QSERDES_COM_DEC_START2, DEC_START2_MUX | DEC_START2},\n\t{EMAC_QSERDES_COM_DIV_FRAC_START1,\n\t\tDIV_FRAC_START_MUX | DIV_FRAC_START(85)},\n\t{EMAC_QSERDES_COM_DIV_FRAC_START2,\n\t\tDIV_FRAC_START_MUX | DIV_FRAC_START(42)},\n\t{EMAC_QSERDES_COM_DIV_FRAC_START3,\n\t\tDIV_FRAC_START3_MUX | DIV_FRAC_START3(3)},\n\t{EMAC_QSERDES_COM_PLLLOCK_CMP1, PLLLOCK_CMP(43)},\n\t{EMAC_QSERDES_COM_PLLLOCK_CMP2, PLLLOCK_CMP(104)},\n\t{EMAC_QSERDES_COM_PLLLOCK_CMP3, PLLLOCK_CMP(0)},\n\t{EMAC_QSERDES_COM_PLLLOCK_CMP_EN, PLLLOCK_CMP_EN},\n\t{EMAC_QSERDES_COM_RESETSM_CNTRL, FRQ_TUNE_MODE},\n};\n\nstatic const struct emac_reg_write cdr_setting[] = {\n\t{EMAC_QSERDES_RX_CDR_CONTROL,\n\t\tSECONDORDERENABLE | FIRSTORDER_THRESH(3) | SECONDORDERGAIN(2)},\n\t{EMAC_QSERDES_RX_CDR_CONTROL2,\n\t\tSECONDORDERENABLE | FIRSTORDER_THRESH(3) | SECONDORDERGAIN(4)},\n};\n\nstatic const struct emac_reg_write tx_rx_setting[] = {\n\t{EMAC_QSERDES_TX_BIST_MODE_LANENO, 0},\n\t{EMAC_QSERDES_TX_TX_DRV_LVL, TX_DRV_LVL_MUX | TX_DRV_LVL(15)},\n\t{EMAC_QSERDES_TX_TRAN_DRVR_EMP_EN, EMP_EN_MUX | EMP_EN},\n\t{EMAC_QSERDES_TX_TX_EMP_POST1_LVL,\n\t\tTX_EMP_POST1_LVL_MUX | TX_EMP_POST1_LVL(1)},\n\t{EMAC_QSERDES_RX_RX_EQ_GAIN12, RX_EQ_GAIN2(15) | RX_EQ_GAIN1(15)},\n\t{EMAC_QSERDES_TX_LANE_MODE, LANE_MODE(8)},\n};\n\nint emac_sgmii_init_fsm9900(struct emac_adapter *adpt)\n{\n\tstruct emac_sgmii *phy = &adpt->phy;\n\tunsigned int i;\n\n\temac_reg_write_all(phy->base, physical_coding_sublayer_programming,\n\t\t\t   ARRAY_SIZE(physical_coding_sublayer_programming));\n\temac_reg_write_all(phy->base, sysclk_refclk_setting,\n\t\t\t   ARRAY_SIZE(sysclk_refclk_setting));\n\temac_reg_write_all(phy->base, pll_setting, ARRAY_SIZE(pll_setting));\n\temac_reg_write_all(phy->base, cdr_setting, ARRAY_SIZE(cdr_setting));\n\temac_reg_write_all(phy->base, tx_rx_setting, ARRAY_SIZE(tx_rx_setting));\n\n\t \n\twritel(SERDES_START, phy->base + EMAC_SGMII_PHY_SERDES_START);\n\n\tfor (i = 0; i < SERDES_START_WAIT_TIMES; i++) {\n\t\tif (readl(phy->base + EMAC_QSERDES_COM_RESET_SM) & READY)\n\t\t\tbreak;\n\t\tusleep_range(100, 200);\n\t}\n\n\tif (i == SERDES_START_WAIT_TIMES) {\n\t\tnetdev_err(adpt->netdev, \"error: ser/des failed to start\\n\");\n\t\treturn -EIO;\n\t}\n\t \n\twritel(0, phy->base + EMAC_SGMII_PHY_INTERRUPT_MASK);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}