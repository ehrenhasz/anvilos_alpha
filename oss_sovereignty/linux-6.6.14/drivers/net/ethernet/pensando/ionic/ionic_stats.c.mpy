{
  "module_name": "ionic_stats.c",
  "hash_id": "44cea5bcf4f8dd96d3c734e16f16a65e0e755c22f4416cccdf8d30aacdae7cd1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/pensando/ionic/ionic_stats.c",
  "human_readable_source": "\n \n\n#include <linux/ethtool.h>\n#include <linux/kernel.h>\n#include <linux/mutex.h>\n#include <linux/netdevice.h>\n\n#include \"ionic.h\"\n#include \"ionic_lif.h\"\n#include \"ionic_stats.h\"\n\nstatic const struct ionic_stat_desc ionic_lif_stats_desc[] = {\n\tIONIC_LIF_STAT_DESC(tx_packets),\n\tIONIC_LIF_STAT_DESC(tx_bytes),\n\tIONIC_LIF_STAT_DESC(rx_packets),\n\tIONIC_LIF_STAT_DESC(rx_bytes),\n\tIONIC_LIF_STAT_DESC(tx_tso),\n\tIONIC_LIF_STAT_DESC(tx_tso_bytes),\n\tIONIC_LIF_STAT_DESC(tx_csum_none),\n\tIONIC_LIF_STAT_DESC(tx_csum),\n\tIONIC_LIF_STAT_DESC(rx_csum_none),\n\tIONIC_LIF_STAT_DESC(rx_csum_complete),\n\tIONIC_LIF_STAT_DESC(rx_csum_error),\n\tIONIC_LIF_STAT_DESC(hw_tx_dropped),\n\tIONIC_LIF_STAT_DESC(hw_rx_dropped),\n\tIONIC_LIF_STAT_DESC(hw_rx_over_errors),\n\tIONIC_LIF_STAT_DESC(hw_rx_missed_errors),\n\tIONIC_LIF_STAT_DESC(hw_tx_aborted_errors),\n};\n\nstatic const struct ionic_stat_desc ionic_port_stats_desc[] = {\n\tIONIC_PORT_STAT_DESC(frames_rx_ok),\n\tIONIC_PORT_STAT_DESC(frames_rx_all),\n\tIONIC_PORT_STAT_DESC(frames_rx_bad_fcs),\n\tIONIC_PORT_STAT_DESC(frames_rx_bad_all),\n\tIONIC_PORT_STAT_DESC(octets_rx_ok),\n\tIONIC_PORT_STAT_DESC(octets_rx_all),\n\tIONIC_PORT_STAT_DESC(frames_rx_unicast),\n\tIONIC_PORT_STAT_DESC(frames_rx_multicast),\n\tIONIC_PORT_STAT_DESC(frames_rx_broadcast),\n\tIONIC_PORT_STAT_DESC(frames_rx_pause),\n\tIONIC_PORT_STAT_DESC(frames_rx_bad_length),\n\tIONIC_PORT_STAT_DESC(frames_rx_undersized),\n\tIONIC_PORT_STAT_DESC(frames_rx_oversized),\n\tIONIC_PORT_STAT_DESC(frames_rx_fragments),\n\tIONIC_PORT_STAT_DESC(frames_rx_jabber),\n\tIONIC_PORT_STAT_DESC(frames_rx_pripause),\n\tIONIC_PORT_STAT_DESC(frames_rx_stomped_crc),\n\tIONIC_PORT_STAT_DESC(frames_rx_too_long),\n\tIONIC_PORT_STAT_DESC(frames_rx_vlan_good),\n\tIONIC_PORT_STAT_DESC(frames_rx_dropped),\n\tIONIC_PORT_STAT_DESC(frames_rx_less_than_64b),\n\tIONIC_PORT_STAT_DESC(frames_rx_64b),\n\tIONIC_PORT_STAT_DESC(frames_rx_65b_127b),\n\tIONIC_PORT_STAT_DESC(frames_rx_128b_255b),\n\tIONIC_PORT_STAT_DESC(frames_rx_256b_511b),\n\tIONIC_PORT_STAT_DESC(frames_rx_512b_1023b),\n\tIONIC_PORT_STAT_DESC(frames_rx_1024b_1518b),\n\tIONIC_PORT_STAT_DESC(frames_rx_1519b_2047b),\n\tIONIC_PORT_STAT_DESC(frames_rx_2048b_4095b),\n\tIONIC_PORT_STAT_DESC(frames_rx_4096b_8191b),\n\tIONIC_PORT_STAT_DESC(frames_rx_8192b_9215b),\n\tIONIC_PORT_STAT_DESC(frames_rx_other),\n\tIONIC_PORT_STAT_DESC(frames_tx_ok),\n\tIONIC_PORT_STAT_DESC(frames_tx_all),\n\tIONIC_PORT_STAT_DESC(frames_tx_bad),\n\tIONIC_PORT_STAT_DESC(octets_tx_ok),\n\tIONIC_PORT_STAT_DESC(octets_tx_total),\n\tIONIC_PORT_STAT_DESC(frames_tx_unicast),\n\tIONIC_PORT_STAT_DESC(frames_tx_multicast),\n\tIONIC_PORT_STAT_DESC(frames_tx_broadcast),\n\tIONIC_PORT_STAT_DESC(frames_tx_pause),\n\tIONIC_PORT_STAT_DESC(frames_tx_pripause),\n\tIONIC_PORT_STAT_DESC(frames_tx_vlan),\n\tIONIC_PORT_STAT_DESC(frames_tx_less_than_64b),\n\tIONIC_PORT_STAT_DESC(frames_tx_64b),\n\tIONIC_PORT_STAT_DESC(frames_tx_65b_127b),\n\tIONIC_PORT_STAT_DESC(frames_tx_128b_255b),\n\tIONIC_PORT_STAT_DESC(frames_tx_256b_511b),\n\tIONIC_PORT_STAT_DESC(frames_tx_512b_1023b),\n\tIONIC_PORT_STAT_DESC(frames_tx_1024b_1518b),\n\tIONIC_PORT_STAT_DESC(frames_tx_1519b_2047b),\n\tIONIC_PORT_STAT_DESC(frames_tx_2048b_4095b),\n\tIONIC_PORT_STAT_DESC(frames_tx_4096b_8191b),\n\tIONIC_PORT_STAT_DESC(frames_tx_8192b_9215b),\n\tIONIC_PORT_STAT_DESC(frames_tx_other),\n\tIONIC_PORT_STAT_DESC(frames_tx_pri_0),\n\tIONIC_PORT_STAT_DESC(frames_tx_pri_1),\n\tIONIC_PORT_STAT_DESC(frames_tx_pri_2),\n\tIONIC_PORT_STAT_DESC(frames_tx_pri_3),\n\tIONIC_PORT_STAT_DESC(frames_tx_pri_4),\n\tIONIC_PORT_STAT_DESC(frames_tx_pri_5),\n\tIONIC_PORT_STAT_DESC(frames_tx_pri_6),\n\tIONIC_PORT_STAT_DESC(frames_tx_pri_7),\n\tIONIC_PORT_STAT_DESC(frames_rx_pri_0),\n\tIONIC_PORT_STAT_DESC(frames_rx_pri_1),\n\tIONIC_PORT_STAT_DESC(frames_rx_pri_2),\n\tIONIC_PORT_STAT_DESC(frames_rx_pri_3),\n\tIONIC_PORT_STAT_DESC(frames_rx_pri_4),\n\tIONIC_PORT_STAT_DESC(frames_rx_pri_5),\n\tIONIC_PORT_STAT_DESC(frames_rx_pri_6),\n\tIONIC_PORT_STAT_DESC(frames_rx_pri_7),\n\tIONIC_PORT_STAT_DESC(tx_pripause_0_1us_count),\n\tIONIC_PORT_STAT_DESC(tx_pripause_1_1us_count),\n\tIONIC_PORT_STAT_DESC(tx_pripause_2_1us_count),\n\tIONIC_PORT_STAT_DESC(tx_pripause_3_1us_count),\n\tIONIC_PORT_STAT_DESC(tx_pripause_4_1us_count),\n\tIONIC_PORT_STAT_DESC(tx_pripause_5_1us_count),\n\tIONIC_PORT_STAT_DESC(tx_pripause_6_1us_count),\n\tIONIC_PORT_STAT_DESC(tx_pripause_7_1us_count),\n\tIONIC_PORT_STAT_DESC(rx_pripause_0_1us_count),\n\tIONIC_PORT_STAT_DESC(rx_pripause_1_1us_count),\n\tIONIC_PORT_STAT_DESC(rx_pripause_2_1us_count),\n\tIONIC_PORT_STAT_DESC(rx_pripause_3_1us_count),\n\tIONIC_PORT_STAT_DESC(rx_pripause_4_1us_count),\n\tIONIC_PORT_STAT_DESC(rx_pripause_5_1us_count),\n\tIONIC_PORT_STAT_DESC(rx_pripause_6_1us_count),\n\tIONIC_PORT_STAT_DESC(rx_pripause_7_1us_count),\n\tIONIC_PORT_STAT_DESC(rx_pause_1us_count),\n\tIONIC_PORT_STAT_DESC(frames_tx_truncated),\n};\n\nstatic const struct ionic_stat_desc ionic_tx_stats_desc[] = {\n\tIONIC_TX_STAT_DESC(pkts),\n\tIONIC_TX_STAT_DESC(bytes),\n\tIONIC_TX_STAT_DESC(clean),\n\tIONIC_TX_STAT_DESC(dma_map_err),\n\tIONIC_TX_STAT_DESC(linearize),\n\tIONIC_TX_STAT_DESC(frags),\n\tIONIC_TX_STAT_DESC(tso),\n\tIONIC_TX_STAT_DESC(tso_bytes),\n\tIONIC_TX_STAT_DESC(hwstamp_valid),\n\tIONIC_TX_STAT_DESC(hwstamp_invalid),\n\tIONIC_TX_STAT_DESC(csum_none),\n\tIONIC_TX_STAT_DESC(csum),\n\tIONIC_TX_STAT_DESC(vlan_inserted),\n};\n\nstatic const struct ionic_stat_desc ionic_rx_stats_desc[] = {\n\tIONIC_RX_STAT_DESC(pkts),\n\tIONIC_RX_STAT_DESC(bytes),\n\tIONIC_RX_STAT_DESC(dma_map_err),\n\tIONIC_RX_STAT_DESC(alloc_err),\n\tIONIC_RX_STAT_DESC(csum_none),\n\tIONIC_RX_STAT_DESC(csum_complete),\n\tIONIC_RX_STAT_DESC(csum_error),\n\tIONIC_RX_STAT_DESC(hwstamp_valid),\n\tIONIC_RX_STAT_DESC(hwstamp_invalid),\n\tIONIC_RX_STAT_DESC(dropped),\n\tIONIC_RX_STAT_DESC(vlan_stripped),\n};\n\n#define IONIC_NUM_LIF_STATS ARRAY_SIZE(ionic_lif_stats_desc)\n#define IONIC_NUM_PORT_STATS ARRAY_SIZE(ionic_port_stats_desc)\n#define IONIC_NUM_TX_STATS ARRAY_SIZE(ionic_tx_stats_desc)\n#define IONIC_NUM_RX_STATS ARRAY_SIZE(ionic_rx_stats_desc)\n\n#define MAX_Q(lif)   ((lif)->netdev->real_num_tx_queues)\n\nstatic void ionic_add_lif_txq_stats(struct ionic_lif *lif, int q_num,\n\t\t\t\t    struct ionic_lif_sw_stats *stats)\n{\n\tstruct ionic_tx_stats *txstats = &lif->txqstats[q_num];\n\n\tstats->tx_packets += txstats->pkts;\n\tstats->tx_bytes += txstats->bytes;\n\tstats->tx_tso += txstats->tso;\n\tstats->tx_tso_bytes += txstats->tso_bytes;\n\tstats->tx_csum_none += txstats->csum_none;\n\tstats->tx_csum += txstats->csum;\n\tstats->tx_hwstamp_valid += txstats->hwstamp_valid;\n\tstats->tx_hwstamp_invalid += txstats->hwstamp_invalid;\n}\n\nstatic void ionic_add_lif_rxq_stats(struct ionic_lif *lif, int q_num,\n\t\t\t\t    struct ionic_lif_sw_stats *stats)\n{\n\tstruct ionic_rx_stats *rxstats = &lif->rxqstats[q_num];\n\n\tstats->rx_packets += rxstats->pkts;\n\tstats->rx_bytes += rxstats->bytes;\n\tstats->rx_csum_none += rxstats->csum_none;\n\tstats->rx_csum_complete += rxstats->csum_complete;\n\tstats->rx_csum_error += rxstats->csum_error;\n\tstats->rx_hwstamp_valid += rxstats->hwstamp_valid;\n\tstats->rx_hwstamp_invalid += rxstats->hwstamp_invalid;\n}\n\nstatic void ionic_get_lif_stats(struct ionic_lif *lif,\n\t\t\t\tstruct ionic_lif_sw_stats *stats)\n{\n\tstruct rtnl_link_stats64 ns;\n\tint q_num;\n\n\tmemset(stats, 0, sizeof(*stats));\n\n\tfor (q_num = 0; q_num < MAX_Q(lif); q_num++) {\n\t\tionic_add_lif_txq_stats(lif, q_num, stats);\n\t\tionic_add_lif_rxq_stats(lif, q_num, stats);\n\t}\n\n\tif (lif->hwstamp_txq)\n\t\tionic_add_lif_txq_stats(lif, lif->hwstamp_txq->q.index, stats);\n\n\tif (lif->hwstamp_rxq)\n\t\tionic_add_lif_rxq_stats(lif, lif->hwstamp_rxq->q.index, stats);\n\n\tionic_get_stats64(lif->netdev, &ns);\n\tstats->hw_tx_dropped = ns.tx_dropped;\n\tstats->hw_rx_dropped = ns.rx_dropped;\n\tstats->hw_rx_over_errors = ns.rx_over_errors;\n\tstats->hw_rx_missed_errors = ns.rx_missed_errors;\n\tstats->hw_tx_aborted_errors = ns.tx_aborted_errors;\n}\n\nstatic u64 ionic_sw_stats_get_count(struct ionic_lif *lif)\n{\n\tu64 total = 0, tx_queues = MAX_Q(lif), rx_queues = MAX_Q(lif);\n\n\tif (lif->hwstamp_txq)\n\t\ttx_queues += 1;\n\n\tif (lif->hwstamp_rxq)\n\t\trx_queues += 1;\n\n\ttotal += IONIC_NUM_LIF_STATS;\n\ttotal += IONIC_NUM_PORT_STATS;\n\n\ttotal += tx_queues * IONIC_NUM_TX_STATS;\n\ttotal += rx_queues * IONIC_NUM_RX_STATS;\n\n\treturn total;\n}\n\nstatic void ionic_sw_stats_get_tx_strings(struct ionic_lif *lif, u8 **buf,\n\t\t\t\t\t  int q_num)\n{\n\tint i;\n\n\tfor (i = 0; i < IONIC_NUM_TX_STATS; i++)\n\t\tethtool_sprintf(buf, \"tx_%d_%s\", q_num,\n\t\t\t\tionic_tx_stats_desc[i].name);\n}\n\nstatic void ionic_sw_stats_get_rx_strings(struct ionic_lif *lif, u8 **buf,\n\t\t\t\t\t  int q_num)\n{\n\tint i;\n\n\tfor (i = 0; i < IONIC_NUM_RX_STATS; i++)\n\t\tethtool_sprintf(buf, \"rx_%d_%s\", q_num,\n\t\t\t\tionic_rx_stats_desc[i].name);\n}\n\nstatic void ionic_sw_stats_get_strings(struct ionic_lif *lif, u8 **buf)\n{\n\tint i, q_num;\n\n\tfor (i = 0; i < IONIC_NUM_LIF_STATS; i++)\n\t\tethtool_sprintf(buf, ionic_lif_stats_desc[i].name);\n\n\tfor (i = 0; i < IONIC_NUM_PORT_STATS; i++)\n\t\tethtool_sprintf(buf, ionic_port_stats_desc[i].name);\n\n\tfor (q_num = 0; q_num < MAX_Q(lif); q_num++)\n\t\tionic_sw_stats_get_tx_strings(lif, buf, q_num);\n\n\tif (lif->hwstamp_txq)\n\t\tionic_sw_stats_get_tx_strings(lif, buf, lif->hwstamp_txq->q.index);\n\n\tfor (q_num = 0; q_num < MAX_Q(lif); q_num++)\n\t\tionic_sw_stats_get_rx_strings(lif, buf, q_num);\n\n\tif (lif->hwstamp_rxq)\n\t\tionic_sw_stats_get_rx_strings(lif, buf, lif->hwstamp_rxq->q.index);\n}\n\nstatic void ionic_sw_stats_get_txq_values(struct ionic_lif *lif, u64 **buf,\n\t\t\t\t\t  int q_num)\n{\n\tstruct ionic_tx_stats *txstats;\n\tint i;\n\n\ttxstats = &lif->txqstats[q_num];\n\n\tfor (i = 0; i < IONIC_NUM_TX_STATS; i++) {\n\t\t**buf = IONIC_READ_STAT64(txstats, &ionic_tx_stats_desc[i]);\n\t\t(*buf)++;\n\t}\n}\n\nstatic void ionic_sw_stats_get_rxq_values(struct ionic_lif *lif, u64 **buf,\n\t\t\t\t\t  int q_num)\n{\n\tstruct ionic_rx_stats *rxstats;\n\tint i;\n\n\trxstats = &lif->rxqstats[q_num];\n\n\tfor (i = 0; i < IONIC_NUM_RX_STATS; i++) {\n\t\t**buf = IONIC_READ_STAT64(rxstats, &ionic_rx_stats_desc[i]);\n\t\t(*buf)++;\n\t}\n}\n\nstatic void ionic_sw_stats_get_values(struct ionic_lif *lif, u64 **buf)\n{\n\tstruct ionic_port_stats *port_stats;\n\tstruct ionic_lif_sw_stats lif_stats;\n\tint i, q_num;\n\n\tionic_get_lif_stats(lif, &lif_stats);\n\n\tfor (i = 0; i < IONIC_NUM_LIF_STATS; i++) {\n\t\t**buf = IONIC_READ_STAT64(&lif_stats, &ionic_lif_stats_desc[i]);\n\t\t(*buf)++;\n\t}\n\n\tport_stats = &lif->ionic->idev.port_info->stats;\n\tfor (i = 0; i < IONIC_NUM_PORT_STATS; i++) {\n\t\t**buf = IONIC_READ_STAT_LE64(port_stats,\n\t\t\t\t\t     &ionic_port_stats_desc[i]);\n\t\t(*buf)++;\n\t}\n\n\tfor (q_num = 0; q_num < MAX_Q(lif); q_num++)\n\t\tionic_sw_stats_get_txq_values(lif, buf, q_num);\n\n\tif (lif->hwstamp_txq)\n\t\tionic_sw_stats_get_txq_values(lif, buf, lif->hwstamp_txq->q.index);\n\n\tfor (q_num = 0; q_num < MAX_Q(lif); q_num++)\n\t\tionic_sw_stats_get_rxq_values(lif, buf, q_num);\n\n\tif (lif->hwstamp_rxq)\n\t\tionic_sw_stats_get_rxq_values(lif, buf, lif->hwstamp_rxq->q.index);\n}\n\nconst struct ionic_stats_group_intf ionic_stats_groups[] = {\n\t \n\t{\n\t\t.get_strings = ionic_sw_stats_get_strings,\n\t\t.get_values = ionic_sw_stats_get_values,\n\t\t.get_count = ionic_sw_stats_get_count,\n\t},\n\t \n};\n\nconst int ionic_num_stats_grps = ARRAY_SIZE(ionic_stats_groups);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}