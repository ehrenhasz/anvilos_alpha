{
  "module_name": "ionic_dev.h",
  "hash_id": "3559afdcd7f666312506fefb08bb3f9c2db1dbe882515840c4afd2eadfa61bab",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/pensando/ionic/ionic_dev.h",
  "human_readable_source": " \n \n\n#ifndef _IONIC_DEV_H_\n#define _IONIC_DEV_H_\n\n#include <linux/atomic.h>\n#include <linux/mutex.h>\n#include <linux/workqueue.h>\n\n#include \"ionic_if.h\"\n#include \"ionic_regs.h\"\n\n#define IONIC_MAX_TX_DESC\t\t8192\n#define IONIC_MAX_RX_DESC\t\t16384\n#define IONIC_MIN_TXRX_DESC\t\t64\n#define IONIC_DEF_TXRX_DESC\t\t4096\n#define IONIC_RX_FILL_THRESHOLD\t\t16\n#define IONIC_RX_FILL_DIV\t\t8\n#define IONIC_LIFS_MAX\t\t\t1024\n#define IONIC_WATCHDOG_SECS\t\t5\n#define IONIC_ITR_COAL_USEC_DEFAULT\t64\n\n#define IONIC_DEV_CMD_REG_VERSION\t1\n#define IONIC_DEV_INFO_REG_COUNT\t32\n#define IONIC_DEV_CMD_REG_COUNT\t\t32\n\n#define IONIC_NAPI_DEADLINE\t\t(HZ / 200)\t \n#define IONIC_ADMIN_DOORBELL_DEADLINE\t(HZ / 2)\t \n#define IONIC_TX_DOORBELL_DEADLINE\t(HZ / 100)\t \n#define IONIC_RX_MIN_DOORBELL_DEADLINE\t(HZ / 100)\t \n#define IONIC_RX_MAX_DOORBELL_DEADLINE\t(HZ * 5)\t \n\nstruct ionic_dev_bar {\n\tvoid __iomem *vaddr;\n\tphys_addr_t bus_addr;\n\tunsigned long len;\n\tint res_index;\n};\n\n#ifndef __CHECKER__\n \nstatic_assert(sizeof(struct ionic_intr) == 32);\n\nstatic_assert(sizeof(struct ionic_doorbell) == 8);\nstatic_assert(sizeof(struct ionic_intr_status) == 8);\nstatic_assert(sizeof(union ionic_dev_regs) == 4096);\nstatic_assert(sizeof(union ionic_dev_info_regs) == 2048);\nstatic_assert(sizeof(union ionic_dev_cmd_regs) == 2048);\nstatic_assert(sizeof(struct ionic_lif_stats) == 1024);\n\nstatic_assert(sizeof(struct ionic_admin_cmd) == 64);\nstatic_assert(sizeof(struct ionic_admin_comp) == 16);\nstatic_assert(sizeof(struct ionic_nop_cmd) == 64);\nstatic_assert(sizeof(struct ionic_nop_comp) == 16);\n\n \nstatic_assert(sizeof(struct ionic_dev_identify_cmd) == 64);\nstatic_assert(sizeof(struct ionic_dev_identify_comp) == 16);\nstatic_assert(sizeof(struct ionic_dev_init_cmd) == 64);\nstatic_assert(sizeof(struct ionic_dev_init_comp) == 16);\nstatic_assert(sizeof(struct ionic_dev_reset_cmd) == 64);\nstatic_assert(sizeof(struct ionic_dev_reset_comp) == 16);\nstatic_assert(sizeof(struct ionic_dev_getattr_cmd) == 64);\nstatic_assert(sizeof(struct ionic_dev_getattr_comp) == 16);\nstatic_assert(sizeof(struct ionic_dev_setattr_cmd) == 64);\nstatic_assert(sizeof(struct ionic_dev_setattr_comp) == 16);\nstatic_assert(sizeof(struct ionic_lif_setphc_cmd) == 64);\n\n \nstatic_assert(sizeof(struct ionic_port_identify_cmd) == 64);\nstatic_assert(sizeof(struct ionic_port_identify_comp) == 16);\nstatic_assert(sizeof(struct ionic_port_init_cmd) == 64);\nstatic_assert(sizeof(struct ionic_port_init_comp) == 16);\nstatic_assert(sizeof(struct ionic_port_reset_cmd) == 64);\nstatic_assert(sizeof(struct ionic_port_reset_comp) == 16);\nstatic_assert(sizeof(struct ionic_port_getattr_cmd) == 64);\nstatic_assert(sizeof(struct ionic_port_getattr_comp) == 16);\nstatic_assert(sizeof(struct ionic_port_setattr_cmd) == 64);\nstatic_assert(sizeof(struct ionic_port_setattr_comp) == 16);\n\n \nstatic_assert(sizeof(struct ionic_lif_init_cmd) == 64);\nstatic_assert(sizeof(struct ionic_lif_init_comp) == 16);\nstatic_assert(sizeof(struct ionic_lif_reset_cmd) == 64);\nstatic_assert(sizeof(ionic_lif_reset_comp) == 16);\nstatic_assert(sizeof(struct ionic_lif_getattr_cmd) == 64);\nstatic_assert(sizeof(struct ionic_lif_getattr_comp) == 16);\nstatic_assert(sizeof(struct ionic_lif_setattr_cmd) == 64);\nstatic_assert(sizeof(struct ionic_lif_setattr_comp) == 16);\n\nstatic_assert(sizeof(struct ionic_q_init_cmd) == 64);\nstatic_assert(sizeof(struct ionic_q_init_comp) == 16);\nstatic_assert(sizeof(struct ionic_q_control_cmd) == 64);\nstatic_assert(sizeof(ionic_q_control_comp) == 16);\nstatic_assert(sizeof(struct ionic_q_identify_cmd) == 64);\nstatic_assert(sizeof(struct ionic_q_identify_comp) == 16);\n\nstatic_assert(sizeof(struct ionic_rx_mode_set_cmd) == 64);\nstatic_assert(sizeof(ionic_rx_mode_set_comp) == 16);\nstatic_assert(sizeof(struct ionic_rx_filter_add_cmd) == 64);\nstatic_assert(sizeof(struct ionic_rx_filter_add_comp) == 16);\nstatic_assert(sizeof(struct ionic_rx_filter_del_cmd) == 64);\nstatic_assert(sizeof(ionic_rx_filter_del_comp) == 16);\n\n \nstatic_assert(sizeof(struct ionic_rdma_reset_cmd) == 64);\nstatic_assert(sizeof(struct ionic_rdma_queue_cmd) == 64);\n\n \nstatic_assert(sizeof(struct ionic_notifyq_cmd) == 4);\nstatic_assert(sizeof(union ionic_notifyq_comp) == 64);\nstatic_assert(sizeof(struct ionic_notifyq_event) == 64);\nstatic_assert(sizeof(struct ionic_link_change_event) == 64);\nstatic_assert(sizeof(struct ionic_reset_event) == 64);\nstatic_assert(sizeof(struct ionic_heartbeat_event) == 64);\nstatic_assert(sizeof(struct ionic_log_event) == 64);\n\n \nstatic_assert(sizeof(struct ionic_txq_desc) == 16);\nstatic_assert(sizeof(struct ionic_txq_sg_desc) == 128);\nstatic_assert(sizeof(struct ionic_txq_comp) == 16);\n\nstatic_assert(sizeof(struct ionic_rxq_desc) == 16);\nstatic_assert(sizeof(struct ionic_rxq_sg_desc) == 128);\nstatic_assert(sizeof(struct ionic_rxq_comp) == 16);\n\n \nstatic_assert(sizeof(struct ionic_vf_setattr_cmd) == 64);\nstatic_assert(sizeof(struct ionic_vf_setattr_comp) == 16);\nstatic_assert(sizeof(struct ionic_vf_getattr_cmd) == 64);\nstatic_assert(sizeof(struct ionic_vf_getattr_comp) == 16);\nstatic_assert(sizeof(struct ionic_vf_ctrl_cmd) == 64);\nstatic_assert(sizeof(struct ionic_vf_ctrl_comp) == 16);\n#endif  \n\nstruct ionic_devinfo {\n\tu8 asic_type;\n\tu8 asic_rev;\n\tchar fw_version[IONIC_DEVINFO_FWVERS_BUFLEN + 1];\n\tchar serial_num[IONIC_DEVINFO_SERIAL_BUFLEN + 1];\n};\n\nstruct ionic_dev {\n\tunion ionic_dev_info_regs __iomem *dev_info_regs;\n\tunion ionic_dev_cmd_regs __iomem *dev_cmd_regs;\n\tstruct ionic_hwstamp_regs __iomem *hwstamp_regs;\n\n\tatomic_long_t last_check_time;\n\tunsigned long last_hb_time;\n\tu32 last_fw_hb;\n\tbool fw_hb_ready;\n\tbool fw_status_ready;\n\tu8 fw_generation;\n\n\tu64 __iomem *db_pages;\n\tdma_addr_t phy_db_pages;\n\n\tstruct ionic_intr __iomem *intr_ctrl;\n\tu64 __iomem *intr_status;\n\n\tstruct mutex cmb_inuse_lock;  \n\tunsigned long *cmb_inuse;\n\tdma_addr_t phy_cmb_pages;\n\tu32 cmb_npages;\n\n\tu32 port_info_sz;\n\tstruct ionic_port_info *port_info;\n\tdma_addr_t port_info_pa;\n\n\tstruct ionic_devinfo dev_info;\n};\n\nstruct ionic_cq_info {\n\tunion {\n\t\tvoid *cq_desc;\n\t\tstruct ionic_admin_comp *admincq;\n\t\tstruct ionic_notifyq_event *notifyq;\n\t};\n};\n\nstruct ionic_queue;\nstruct ionic_qcq;\nstruct ionic_desc_info;\n\ntypedef void (*ionic_desc_cb)(struct ionic_queue *q,\n\t\t\t      struct ionic_desc_info *desc_info,\n\t\t\t      struct ionic_cq_info *cq_info, void *cb_arg);\n\n#define IONIC_MAX_BUF_LEN\t\t\t((u16)-1)\n#define IONIC_PAGE_SIZE\t\t\t\tPAGE_SIZE\n#define IONIC_PAGE_SPLIT_SZ\t\t\t(PAGE_SIZE / 2)\n#define IONIC_PAGE_GFP_MASK\t\t\t(GFP_ATOMIC | __GFP_NOWARN |\\\n\t\t\t\t\t\t __GFP_COMP | __GFP_MEMALLOC)\n\nstruct ionic_buf_info {\n\tstruct page *page;\n\tdma_addr_t dma_addr;\n\tu32 page_offset;\n\tu32 len;\n};\n\n#define IONIC_MAX_FRAGS\t\t\t(1 + IONIC_TX_MAX_SG_ELEMS_V1)\n\nstruct ionic_desc_info {\n\tunion {\n\t\tvoid *desc;\n\t\tstruct ionic_txq_desc *txq_desc;\n\t\tstruct ionic_rxq_desc *rxq_desc;\n\t\tstruct ionic_admin_cmd *adminq_desc;\n\t};\n\tvoid __iomem *cmb_desc;\n\tunion {\n\t\tvoid *sg_desc;\n\t\tstruct ionic_txq_sg_desc *txq_sg_desc;\n\t\tstruct ionic_rxq_sg_desc *rxq_sgl_desc;\n\t};\n\tunsigned int bytes;\n\tunsigned int nbufs;\n\tstruct ionic_buf_info bufs[IONIC_MAX_FRAGS];\n\tionic_desc_cb cb;\n\tvoid *cb_arg;\n};\n\n#define IONIC_QUEUE_NAME_MAX_SZ\t\t16\n\nstruct ionic_queue {\n\tstruct device *dev;\n\tstruct ionic_lif *lif;\n\tstruct ionic_desc_info *info;\n\tu64 dbval;\n\tunsigned long dbell_deadline;\n\tunsigned long dbell_jiffies;\n\tu16 head_idx;\n\tu16 tail_idx;\n\tunsigned int index;\n\tunsigned int num_descs;\n\tunsigned int max_sg_elems;\n\tu64 features;\n\tu64 drop;\n\tstruct ionic_dev *idev;\n\tunsigned int type;\n\tunsigned int hw_index;\n\tunsigned int hw_type;\n\tunion {\n\t\tvoid *base;\n\t\tstruct ionic_txq_desc *txq;\n\t\tstruct ionic_rxq_desc *rxq;\n\t\tstruct ionic_admin_cmd *adminq;\n\t};\n\tvoid __iomem *cmb_base;\n\tunion {\n\t\tvoid *sg_base;\n\t\tstruct ionic_txq_sg_desc *txq_sgl;\n\t\tstruct ionic_rxq_sg_desc *rxq_sgl;\n\t};\n\tdma_addr_t base_pa;\n\tdma_addr_t cmb_base_pa;\n\tdma_addr_t sg_base_pa;\n\tunsigned int desc_size;\n\tunsigned int sg_desc_size;\n\tunsigned int pid;\n\tchar name[IONIC_QUEUE_NAME_MAX_SZ];\n} ____cacheline_aligned_in_smp;\n\n#define IONIC_INTR_INDEX_NOT_ASSIGNED\t-1\n#define IONIC_INTR_NAME_MAX_SZ\t\t32\n\nstruct ionic_intr_info {\n\tchar name[IONIC_INTR_NAME_MAX_SZ];\n\tunsigned int index;\n\tunsigned int vector;\n\tu64 rearm_count;\n\tunsigned int cpu;\n\tcpumask_t affinity_mask;\n\tu32 dim_coal_hw;\n};\n\nstruct ionic_cq {\n\tstruct ionic_lif *lif;\n\tstruct ionic_cq_info *info;\n\tstruct ionic_queue *bound_q;\n\tstruct ionic_intr_info *bound_intr;\n\tu16 tail_idx;\n\tbool done_color;\n\tunsigned int num_descs;\n\tunsigned int desc_size;\n\tvoid *base;\n\tdma_addr_t base_pa;\n} ____cacheline_aligned_in_smp;\n\nstruct ionic;\n\nstatic inline void ionic_intr_init(struct ionic_dev *idev,\n\t\t\t\t   struct ionic_intr_info *intr,\n\t\t\t\t   unsigned long index)\n{\n\tionic_intr_clean(idev->intr_ctrl, index);\n\tintr->index = index;\n}\n\nstatic inline unsigned int ionic_q_space_avail(struct ionic_queue *q)\n{\n\tunsigned int avail = q->tail_idx;\n\n\tif (q->head_idx >= avail)\n\t\tavail += q->num_descs - q->head_idx - 1;\n\telse\n\t\tavail -= q->head_idx + 1;\n\n\treturn avail;\n}\n\nstatic inline bool ionic_q_has_space(struct ionic_queue *q, unsigned int want)\n{\n\treturn ionic_q_space_avail(q) >= want;\n}\n\nvoid ionic_init_devinfo(struct ionic *ionic);\nint ionic_dev_setup(struct ionic *ionic);\nvoid ionic_dev_teardown(struct ionic *ionic);\n\nvoid ionic_dev_cmd_go(struct ionic_dev *idev, union ionic_dev_cmd *cmd);\nu8 ionic_dev_cmd_status(struct ionic_dev *idev);\nbool ionic_dev_cmd_done(struct ionic_dev *idev);\nvoid ionic_dev_cmd_comp(struct ionic_dev *idev, union ionic_dev_cmd_comp *comp);\n\nvoid ionic_dev_cmd_identify(struct ionic_dev *idev, u8 ver);\nvoid ionic_dev_cmd_init(struct ionic_dev *idev);\nvoid ionic_dev_cmd_reset(struct ionic_dev *idev);\n\nvoid ionic_dev_cmd_port_identify(struct ionic_dev *idev);\nvoid ionic_dev_cmd_port_init(struct ionic_dev *idev);\nvoid ionic_dev_cmd_port_reset(struct ionic_dev *idev);\nvoid ionic_dev_cmd_port_state(struct ionic_dev *idev, u8 state);\nvoid ionic_dev_cmd_port_speed(struct ionic_dev *idev, u32 speed);\nvoid ionic_dev_cmd_port_autoneg(struct ionic_dev *idev, u8 an_enable);\nvoid ionic_dev_cmd_port_fec(struct ionic_dev *idev, u8 fec_type);\nvoid ionic_dev_cmd_port_pause(struct ionic_dev *idev, u8 pause_type);\n\nint ionic_set_vf_config(struct ionic *ionic, int vf,\n\t\t\tstruct ionic_vf_setattr_cmd *vfc);\nint ionic_dev_cmd_vf_getattr(struct ionic *ionic, int vf, u8 attr,\n\t\t\t     struct ionic_vf_getattr_comp *comp);\nvoid ionic_dev_cmd_queue_identify(struct ionic_dev *idev,\n\t\t\t\t  u16 lif_type, u8 qtype, u8 qver);\nvoid ionic_vf_start(struct ionic *ionic);\nvoid ionic_dev_cmd_lif_identify(struct ionic_dev *idev, u8 type, u8 ver);\nvoid ionic_dev_cmd_lif_init(struct ionic_dev *idev, u16 lif_index,\n\t\t\t    dma_addr_t addr);\nvoid ionic_dev_cmd_lif_reset(struct ionic_dev *idev, u16 lif_index);\nvoid ionic_dev_cmd_adminq_init(struct ionic_dev *idev, struct ionic_qcq *qcq,\n\t\t\t       u16 lif_index, u16 intr_index);\n\nint ionic_db_page_num(struct ionic_lif *lif, int pid);\n\nint ionic_get_cmb(struct ionic_lif *lif, u32 *pgid, phys_addr_t *pgaddr, int order);\nvoid ionic_put_cmb(struct ionic_lif *lif, u32 pgid, int order);\n\nint ionic_cq_init(struct ionic_lif *lif, struct ionic_cq *cq,\n\t\t  struct ionic_intr_info *intr,\n\t\t  unsigned int num_descs, size_t desc_size);\nvoid ionic_cq_map(struct ionic_cq *cq, void *base, dma_addr_t base_pa);\nvoid ionic_cq_bind(struct ionic_cq *cq, struct ionic_queue *q);\ntypedef bool (*ionic_cq_cb)(struct ionic_cq *cq, struct ionic_cq_info *cq_info);\ntypedef void (*ionic_cq_done_cb)(void *done_arg);\nunsigned int ionic_cq_service(struct ionic_cq *cq, unsigned int work_to_do,\n\t\t\t      ionic_cq_cb cb, ionic_cq_done_cb done_cb,\n\t\t\t      void *done_arg);\n\nint ionic_q_init(struct ionic_lif *lif, struct ionic_dev *idev,\n\t\t struct ionic_queue *q, unsigned int index, const char *name,\n\t\t unsigned int num_descs, size_t desc_size,\n\t\t size_t sg_desc_size, unsigned int pid);\nvoid ionic_q_map(struct ionic_queue *q, void *base, dma_addr_t base_pa);\nvoid ionic_q_cmb_map(struct ionic_queue *q, void __iomem *base, dma_addr_t base_pa);\nvoid ionic_q_sg_map(struct ionic_queue *q, void *base, dma_addr_t base_pa);\nvoid ionic_q_post(struct ionic_queue *q, bool ring_doorbell, ionic_desc_cb cb,\n\t\t  void *cb_arg);\nvoid ionic_q_service(struct ionic_queue *q, struct ionic_cq_info *cq_info,\n\t\t     unsigned int stop_index);\nint ionic_heartbeat_check(struct ionic *ionic);\nbool ionic_is_fw_running(struct ionic_dev *idev);\n\nbool ionic_adminq_poke_doorbell(struct ionic_queue *q);\nbool ionic_txq_poke_doorbell(struct ionic_queue *q);\nbool ionic_rxq_poke_doorbell(struct ionic_queue *q);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}