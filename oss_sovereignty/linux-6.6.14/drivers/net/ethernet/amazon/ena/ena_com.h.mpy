{
  "module_name": "ena_com.h",
  "hash_id": "b8183823cde19c3bfe3b762db3bddda584bd7bc8bf8b06fd9113910decae042c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/amazon/ena/ena_com.h",
  "human_readable_source": " \n \n\n#ifndef ENA_COM\n#define ENA_COM\n\n#include <linux/compiler.h>\n#include <linux/delay.h>\n#include <linux/dma-mapping.h>\n#include <linux/gfp.h>\n#include <linux/io.h>\n#include <linux/prefetch.h>\n#include <linux/sched.h>\n#include <linux/sizes.h>\n#include <linux/spinlock.h>\n#include <linux/types.h>\n#include <linux/wait.h>\n#include <linux/netdevice.h>\n\n#include \"ena_common_defs.h\"\n#include \"ena_admin_defs.h\"\n#include \"ena_eth_io_defs.h\"\n#include \"ena_regs_defs.h\"\n\n#undef pr_fmt\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#define ENA_MAX_NUM_IO_QUEUES 128U\n \n#define ENA_TOTAL_NUM_QUEUES (2 * (ENA_MAX_NUM_IO_QUEUES))\n\n#define ENA_MAX_HANDLERS 256\n\n#define ENA_MAX_PHYS_ADDR_SIZE_BITS 48\n\n \n#define ENA_REG_READ_TIMEOUT 200000\n\n#define ADMIN_SQ_SIZE(depth)\t((depth) * sizeof(struct ena_admin_aq_entry))\n#define ADMIN_CQ_SIZE(depth)\t((depth) * sizeof(struct ena_admin_acq_entry))\n#define ADMIN_AENQ_SIZE(depth)\t((depth) * sizeof(struct ena_admin_aenq_entry))\n\n \n \n \n\n#define ENA_INTR_INITIAL_TX_INTERVAL_USECS 64\n#define ENA_INTR_INITIAL_RX_INTERVAL_USECS 0\n#define ENA_DEFAULT_INTR_DELAY_RESOLUTION 1\n\n#define ENA_HASH_KEY_SIZE 40\n\n#define ENA_HW_HINTS_NO_TIMEOUT\t0xFFFF\n\n#define ENA_FEATURE_MAX_QUEUE_EXT_VER 1\n\nstruct ena_llq_configurations {\n\tenum ena_admin_llq_header_location llq_header_location;\n\tenum ena_admin_llq_ring_entry_size llq_ring_entry_size;\n\tenum ena_admin_llq_stride_ctrl  llq_stride_ctrl;\n\tenum ena_admin_llq_num_descs_before_header llq_num_decs_before_header;\n\tu16 llq_ring_entry_size_value;\n};\n\nenum queue_direction {\n\tENA_COM_IO_QUEUE_DIRECTION_TX,\n\tENA_COM_IO_QUEUE_DIRECTION_RX\n};\n\nstruct ena_com_buf {\n\tdma_addr_t paddr;  \n\tu16 len;  \n};\n\nstruct ena_com_rx_buf_info {\n\tu16 len;\n\tu16 req_id;\n};\n\nstruct ena_com_io_desc_addr {\n\tu8 __iomem *pbuf_dev_addr;  \n\tu8 *virt_addr;\n\tdma_addr_t phys_addr;\n};\n\nstruct ena_com_tx_meta {\n\tu16 mss;\n\tu16 l3_hdr_len;\n\tu16 l3_hdr_offset;\n\tu16 l4_hdr_len;  \n};\n\nstruct ena_com_llq_info {\n\tu16 header_location_ctrl;\n\tu16 desc_stride_ctrl;\n\tu16 desc_list_entry_size_ctrl;\n\tu16 desc_list_entry_size;\n\tu16 descs_num_before_header;\n\tu16 descs_per_entry;\n\tu16 max_entries_in_tx_burst;\n\tbool disable_meta_caching;\n};\n\nstruct ena_com_io_cq {\n\tstruct ena_com_io_desc_addr cdesc_addr;\n\n\t \n\tu32 __iomem *unmask_reg;\n\n\t \n\tu32 __iomem *cq_head_db_reg;\n\n\t \n\tu32 __iomem *numa_node_cfg_reg;\n\n\t \n\tu32 msix_vector;\n\n\tenum queue_direction direction;\n\n\t \n\tu16 cur_rx_pkt_cdesc_count;\n\t \n\tu16 cur_rx_pkt_cdesc_start_idx;\n\n\tu16 q_depth;\n\t \n\tu16 qid;\n\n\t \n\tu16 idx;\n\tu16 head;\n\tu16 last_head_update;\n\tu8 phase;\n\tu8 cdesc_entry_size_in_bytes;\n\n} ____cacheline_aligned;\n\nstruct ena_com_io_bounce_buffer_control {\n\tu8 *base_buffer;\n\tu16 next_to_use;\n\tu16 buffer_size;\n\tu16 buffers_num;   \n};\n\n \nstruct ena_com_llq_pkt_ctrl {\n\tu8 *curr_bounce_buf;\n\tu16 idx;\n\tu16 descs_left_in_line;\n};\n\nstruct ena_com_io_sq {\n\tstruct ena_com_io_desc_addr desc_addr;\n\n\tu32 __iomem *db_addr;\n\tu8 __iomem *header_addr;\n\n\tenum queue_direction direction;\n\tenum ena_admin_placement_policy_type mem_queue_type;\n\n\tbool disable_meta_caching;\n\n\tu32 msix_vector;\n\tstruct ena_com_tx_meta cached_tx_meta;\n\tstruct ena_com_llq_info llq_info;\n\tstruct ena_com_llq_pkt_ctrl llq_buf_ctrl;\n\tstruct ena_com_io_bounce_buffer_control bounce_buf_ctrl;\n\n\tu16 q_depth;\n\tu16 qid;\n\n\tu16 idx;\n\tu16 tail;\n\tu16 next_to_comp;\n\tu16 llq_last_copy_tail;\n\tu32 tx_max_header_size;\n\tu8 phase;\n\tu8 desc_entry_size;\n\tu8 dma_addr_bits;\n\tu16 entries_in_tx_burst_left;\n} ____cacheline_aligned;\n\nstruct ena_com_admin_cq {\n\tstruct ena_admin_acq_entry *entries;\n\tdma_addr_t dma_addr;\n\n\tu16 head;\n\tu8 phase;\n};\n\nstruct ena_com_admin_sq {\n\tstruct ena_admin_aq_entry *entries;\n\tdma_addr_t dma_addr;\n\n\tu32 __iomem *db_addr;\n\n\tu16 head;\n\tu16 tail;\n\tu8 phase;\n\n};\n\nstruct ena_com_stats_admin {\n\tu64 aborted_cmd;\n\tu64 submitted_cmd;\n\tu64 completed_cmd;\n\tu64 out_of_space;\n\tu64 no_completion;\n};\n\nstruct ena_com_admin_queue {\n\tvoid *q_dmadev;\n\tstruct ena_com_dev *ena_dev;\n\tspinlock_t q_lock;  \n\n\tstruct ena_comp_ctx *comp_ctx;\n\tu32 completion_timeout;\n\tu16 q_depth;\n\tstruct ena_com_admin_cq cq;\n\tstruct ena_com_admin_sq sq;\n\n\t \n\tbool polling;\n\n\t \n\tbool auto_polling;\n\n\tu16 curr_cmd_id;\n\n\t \n\tbool running_state;\n\n\t \n\tatomic_t outstanding_cmds;\n\n\tstruct ena_com_stats_admin stats;\n};\n\nstruct ena_aenq_handlers;\n\nstruct ena_com_aenq {\n\tu16 head;\n\tu8 phase;\n\tstruct ena_admin_aenq_entry *entries;\n\tdma_addr_t dma_addr;\n\tu16 q_depth;\n\tstruct ena_aenq_handlers *aenq_handlers;\n};\n\nstruct ena_com_mmio_read {\n\tstruct ena_admin_ena_mmio_req_read_less_resp *read_resp;\n\tdma_addr_t read_resp_dma_addr;\n\tu32 reg_read_to;  \n\tu16 seq_num;\n\tbool readless_supported;\n\t \n\tspinlock_t lock;\n};\n\nstruct ena_rss {\n\t \n\tu16 *host_rss_ind_tbl;\n\tstruct ena_admin_rss_ind_table_entry *rss_ind_tbl;\n\tdma_addr_t rss_ind_tbl_dma_addr;\n\tu16 tbl_log_size;\n\n\t \n\tenum ena_admin_hash_functions hash_func;\n\tstruct ena_admin_feature_rss_flow_hash_control *hash_key;\n\tdma_addr_t hash_key_dma_addr;\n\tu32 hash_init_val;\n\n\t \n\tstruct ena_admin_feature_rss_hash_control *hash_ctrl;\n\tdma_addr_t hash_ctrl_dma_addr;\n\n};\n\nstruct ena_host_attribute {\n\t \n\tu8 *debug_area_virt_addr;\n\tdma_addr_t debug_area_dma_addr;\n\tu32 debug_area_size;\n\n\t \n\tstruct ena_admin_host_info *host_info;\n\tdma_addr_t host_info_dma_addr;\n};\n\n \nstruct ena_com_dev {\n\tstruct ena_com_admin_queue admin_queue;\n\tstruct ena_com_aenq aenq;\n\tstruct ena_com_io_cq io_cq_queues[ENA_TOTAL_NUM_QUEUES];\n\tstruct ena_com_io_sq io_sq_queues[ENA_TOTAL_NUM_QUEUES];\n\tu8 __iomem *reg_bar;\n\tvoid __iomem *mem_bar;\n\tvoid *dmadev;\n\tstruct net_device *net_device;\n\n\tenum ena_admin_placement_policy_type tx_mem_queue_type;\n\tu32 tx_max_header_size;\n\tu16 stats_func;  \n\tu16 stats_queue;  \n\n\tstruct ena_com_mmio_read mmio_read;\n\n\tstruct ena_rss rss;\n\tu32 supported_features;\n\tu32 capabilities;\n\tu32 dma_addr_bits;\n\n\tstruct ena_host_attribute host_attr;\n\tbool adaptive_coalescing;\n\tu16 intr_delay_resolution;\n\n\t \n\tu32 intr_moder_tx_interval;\n\tu32 intr_moder_rx_interval;\n\n\tstruct ena_intr_moder_entry *intr_moder_tbl;\n\n\tstruct ena_com_llq_info llq_info;\n\n\tu32 ena_min_poll_delay_us;\n};\n\nstruct ena_com_dev_get_features_ctx {\n\tstruct ena_admin_queue_feature_desc max_queues;\n\tstruct ena_admin_queue_ext_feature_desc max_queue_ext;\n\tstruct ena_admin_device_attr_feature_desc dev_attr;\n\tstruct ena_admin_feature_aenq_desc aenq;\n\tstruct ena_admin_feature_offload_desc offload;\n\tstruct ena_admin_ena_hw_hints hw_hints;\n\tstruct ena_admin_feature_llq_desc llq;\n};\n\nstruct ena_com_create_io_ctx {\n\tenum ena_admin_placement_policy_type mem_queue_type;\n\tenum queue_direction direction;\n\tint numa_node;\n\tu32 msix_vector;\n\tu16 queue_size;\n\tu16 qid;\n};\n\ntypedef void (*ena_aenq_handler)(void *data,\n\tstruct ena_admin_aenq_entry *aenq_e);\n\n \nstruct ena_aenq_handlers {\n\tena_aenq_handler handlers[ENA_MAX_HANDLERS];\n\tena_aenq_handler unimplemented_handler;\n};\n\n \n \n\n \nint ena_com_mmio_reg_read_request_init(struct ena_com_dev *ena_dev);\n\n \nvoid ena_com_set_mmio_read_mode(struct ena_com_dev *ena_dev,\n\t\t\t\tbool readless_supported);\n\n \nvoid ena_com_mmio_reg_read_request_write_dev_addr(struct ena_com_dev *ena_dev);\n\n \nvoid ena_com_mmio_reg_read_request_destroy(struct ena_com_dev *ena_dev);\n\n \nint ena_com_admin_init(struct ena_com_dev *ena_dev,\n\t\t       struct ena_aenq_handlers *aenq_handlers);\n\n \nvoid ena_com_admin_destroy(struct ena_com_dev *ena_dev);\n\n \nint ena_com_dev_reset(struct ena_com_dev *ena_dev,\n\t\t      enum ena_regs_reset_reason_types reset_reason);\n\n \nint ena_com_create_io_queue(struct ena_com_dev *ena_dev,\n\t\t\t    struct ena_com_create_io_ctx *ctx);\n\n \nvoid ena_com_destroy_io_queue(struct ena_com_dev *ena_dev, u16 qid);\n\n \nint ena_com_get_io_handlers(struct ena_com_dev *ena_dev, u16 qid,\n\t\t\t    struct ena_com_io_sq **io_sq,\n\t\t\t    struct ena_com_io_cq **io_cq);\n\n \nvoid ena_com_admin_aenq_enable(struct ena_com_dev *ena_dev);\n\n \nvoid ena_com_set_admin_running_state(struct ena_com_dev *ena_dev, bool state);\n\n \nbool ena_com_get_admin_running_state(struct ena_com_dev *ena_dev);\n\n \nvoid ena_com_set_admin_polling_mode(struct ena_com_dev *ena_dev, bool polling);\n\n \nvoid ena_com_set_admin_auto_polling_mode(struct ena_com_dev *ena_dev,\n\t\t\t\t\t bool polling);\n\n \nvoid ena_com_admin_q_comp_intr_handler(struct ena_com_dev *ena_dev);\n\n \nvoid ena_com_aenq_intr_handler(struct ena_com_dev *ena_dev, void *data);\n\n \nvoid ena_com_abort_admin_commands(struct ena_com_dev *ena_dev);\n\n \nvoid ena_com_wait_for_abort_completion(struct ena_com_dev *ena_dev);\n\n \nint ena_com_validate_version(struct ena_com_dev *ena_dev);\n\n \nint ena_com_get_link_params(struct ena_com_dev *ena_dev,\n\t\t\t    struct ena_admin_get_feat_resp *resp);\n\n \nint ena_com_get_dma_width(struct ena_com_dev *ena_dev);\n\n \nint ena_com_set_aenq_config(struct ena_com_dev *ena_dev, u32 groups_flag);\n\n \nint ena_com_get_dev_attr_feat(struct ena_com_dev *ena_dev,\n\t\t\t      struct ena_com_dev_get_features_ctx *get_feat_ctx);\n\n \nint ena_com_get_dev_basic_stats(struct ena_com_dev *ena_dev,\n\t\t\t\tstruct ena_admin_basic_stats *stats);\n\n \nint ena_com_get_eni_stats(struct ena_com_dev *ena_dev,\n\t\t\t  struct ena_admin_eni_stats *stats);\n\n \nint ena_com_set_dev_mtu(struct ena_com_dev *ena_dev, u32 mtu);\n\n \nint ena_com_get_offload_settings(struct ena_com_dev *ena_dev,\n\t\t\t\t struct ena_admin_feature_offload_desc *offload);\n\n \nint ena_com_rss_init(struct ena_com_dev *ena_dev, u16 log_size);\n\n \nvoid ena_com_rss_destroy(struct ena_com_dev *ena_dev);\n\n \nint ena_com_get_current_hash_function(struct ena_com_dev *ena_dev);\n\n \nint ena_com_fill_hash_function(struct ena_com_dev *ena_dev,\n\t\t\t       enum ena_admin_hash_functions func,\n\t\t\t       const u8 *key, u16 key_len, u32 init_val);\n\n \nint ena_com_set_hash_function(struct ena_com_dev *ena_dev);\n\n \nint ena_com_get_hash_function(struct ena_com_dev *ena_dev,\n\t\t\t      enum ena_admin_hash_functions *func);\n\n \nint ena_com_get_hash_key(struct ena_com_dev *ena_dev, u8 *key);\n \nint ena_com_fill_hash_ctrl(struct ena_com_dev *ena_dev,\n\t\t\t   enum ena_admin_flow_hash_proto proto,\n\t\t\t   u16 hash_fields);\n\n \nint ena_com_set_hash_ctrl(struct ena_com_dev *ena_dev);\n\n \nint ena_com_get_hash_ctrl(struct ena_com_dev *ena_dev,\n\t\t\t  enum ena_admin_flow_hash_proto proto,\n\t\t\t  u16 *fields);\n\n \nint ena_com_set_default_hash_ctrl(struct ena_com_dev *ena_dev);\n\n \nint ena_com_indirect_table_fill_entry(struct ena_com_dev *ena_dev,\n\t\t\t\t      u16 entry_idx, u16 entry_value);\n\n \nint ena_com_indirect_table_set(struct ena_com_dev *ena_dev);\n\n \nint ena_com_indirect_table_get(struct ena_com_dev *ena_dev, u32 *ind_tbl);\n\n \nint ena_com_allocate_host_info(struct ena_com_dev *ena_dev);\n\n \nint ena_com_allocate_debug_area(struct ena_com_dev *ena_dev,\n\t\t\t\tu32 debug_area_size);\n\n \nvoid ena_com_delete_debug_area(struct ena_com_dev *ena_dev);\n\n \nvoid ena_com_delete_host_info(struct ena_com_dev *ena_dev);\n\n \nint ena_com_set_host_attributes(struct ena_com_dev *ena_dev);\n\n \nint ena_com_create_io_cq(struct ena_com_dev *ena_dev,\n\t\t\t struct ena_com_io_cq *io_cq);\n\n \nint ena_com_destroy_io_cq(struct ena_com_dev *ena_dev,\n\t\t\t  struct ena_com_io_cq *io_cq);\n\n \nint ena_com_execute_admin_command(struct ena_com_admin_queue *admin_queue,\n\t\t\t\t  struct ena_admin_aq_entry *cmd,\n\t\t\t\t  size_t cmd_size,\n\t\t\t\t  struct ena_admin_acq_entry *cmd_comp,\n\t\t\t\t  size_t cmd_comp_size);\n\n \nint ena_com_init_interrupt_moderation(struct ena_com_dev *ena_dev);\n\n \nbool ena_com_interrupt_moderation_supported(struct ena_com_dev *ena_dev);\n\n \nint ena_com_update_nonadaptive_moderation_interval_tx(struct ena_com_dev *ena_dev,\n\t\t\t\t\t\t      u32 tx_coalesce_usecs);\n\n \nint ena_com_update_nonadaptive_moderation_interval_rx(struct ena_com_dev *ena_dev,\n\t\t\t\t\t\t      u32 rx_coalesce_usecs);\n\n \nunsigned int ena_com_get_nonadaptive_moderation_interval_tx(struct ena_com_dev *ena_dev);\n\n \nunsigned int ena_com_get_nonadaptive_moderation_interval_rx(struct ena_com_dev *ena_dev);\n\n \nint ena_com_config_dev_mode(struct ena_com_dev *ena_dev,\n\t\t\t    struct ena_admin_feature_llq_desc *llq_features,\n\t\t\t    struct ena_llq_configurations *llq_default_config);\n\n \nstatic inline struct ena_com_dev *ena_com_io_sq_to_ena_dev(struct ena_com_io_sq *io_sq)\n{\n\treturn container_of(io_sq, struct ena_com_dev, io_sq_queues[io_sq->qid]);\n}\n\n \nstatic inline struct ena_com_dev *ena_com_io_cq_to_ena_dev(struct ena_com_io_cq *io_cq)\n{\n\treturn container_of(io_cq, struct ena_com_dev, io_cq_queues[io_cq->qid]);\n}\n\nstatic inline bool ena_com_get_adaptive_moderation_enabled(struct ena_com_dev *ena_dev)\n{\n\treturn ena_dev->adaptive_coalescing;\n}\n\nstatic inline void ena_com_enable_adaptive_moderation(struct ena_com_dev *ena_dev)\n{\n\tena_dev->adaptive_coalescing = true;\n}\n\nstatic inline void ena_com_disable_adaptive_moderation(struct ena_com_dev *ena_dev)\n{\n\tena_dev->adaptive_coalescing = false;\n}\n\n \nstatic inline bool ena_com_get_cap(struct ena_com_dev *ena_dev,\n\t\t\t\t   enum ena_admin_aq_caps_id cap_id)\n{\n\treturn !!(ena_dev->capabilities & BIT(cap_id));\n}\n\n \nstatic inline void ena_com_update_intr_reg(struct ena_eth_io_intr_reg *intr_reg,\n\t\t\t\t\t   u32 rx_delay_interval,\n\t\t\t\t\t   u32 tx_delay_interval,\n\t\t\t\t\t   bool unmask)\n{\n\tintr_reg->intr_control = 0;\n\tintr_reg->intr_control |= rx_delay_interval &\n\t\tENA_ETH_IO_INTR_REG_RX_INTR_DELAY_MASK;\n\n\tintr_reg->intr_control |=\n\t\t(tx_delay_interval << ENA_ETH_IO_INTR_REG_TX_INTR_DELAY_SHIFT)\n\t\t& ENA_ETH_IO_INTR_REG_TX_INTR_DELAY_MASK;\n\n\tif (unmask)\n\t\tintr_reg->intr_control |= ENA_ETH_IO_INTR_REG_INTR_UNMASK_MASK;\n}\n\nstatic inline u8 *ena_com_get_next_bounce_buffer(struct ena_com_io_bounce_buffer_control *bounce_buf_ctrl)\n{\n\tu16 size, buffers_num;\n\tu8 *buf;\n\n\tsize = bounce_buf_ctrl->buffer_size;\n\tbuffers_num = bounce_buf_ctrl->buffers_num;\n\n\tbuf = bounce_buf_ctrl->base_buffer +\n\t\t(bounce_buf_ctrl->next_to_use++ & (buffers_num - 1)) * size;\n\n\tprefetchw(bounce_buf_ctrl->base_buffer +\n\t\t(bounce_buf_ctrl->next_to_use & (buffers_num - 1)) * size);\n\n\treturn buf;\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}