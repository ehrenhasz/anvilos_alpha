{
  "module_name": "ocelot_stats.c",
  "hash_id": "538b3d066281eb37300aa90737e6205c59cc9c9960501b6969ffd7235be3db5f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mscc/ocelot_stats.c",
  "human_readable_source": "\n \n#include <linux/ethtool_netlink.h>\n#include <linux/spinlock.h>\n#include <linux/mutex.h>\n#include <linux/workqueue.h>\n#include \"ocelot.h\"\n\nenum ocelot_stat {\n\tOCELOT_STAT_RX_OCTETS,\n\tOCELOT_STAT_RX_UNICAST,\n\tOCELOT_STAT_RX_MULTICAST,\n\tOCELOT_STAT_RX_BROADCAST,\n\tOCELOT_STAT_RX_SHORTS,\n\tOCELOT_STAT_RX_FRAGMENTS,\n\tOCELOT_STAT_RX_JABBERS,\n\tOCELOT_STAT_RX_CRC_ALIGN_ERRS,\n\tOCELOT_STAT_RX_SYM_ERRS,\n\tOCELOT_STAT_RX_64,\n\tOCELOT_STAT_RX_65_127,\n\tOCELOT_STAT_RX_128_255,\n\tOCELOT_STAT_RX_256_511,\n\tOCELOT_STAT_RX_512_1023,\n\tOCELOT_STAT_RX_1024_1526,\n\tOCELOT_STAT_RX_1527_MAX,\n\tOCELOT_STAT_RX_PAUSE,\n\tOCELOT_STAT_RX_CONTROL,\n\tOCELOT_STAT_RX_LONGS,\n\tOCELOT_STAT_RX_CLASSIFIED_DROPS,\n\tOCELOT_STAT_RX_RED_PRIO_0,\n\tOCELOT_STAT_RX_RED_PRIO_1,\n\tOCELOT_STAT_RX_RED_PRIO_2,\n\tOCELOT_STAT_RX_RED_PRIO_3,\n\tOCELOT_STAT_RX_RED_PRIO_4,\n\tOCELOT_STAT_RX_RED_PRIO_5,\n\tOCELOT_STAT_RX_RED_PRIO_6,\n\tOCELOT_STAT_RX_RED_PRIO_7,\n\tOCELOT_STAT_RX_YELLOW_PRIO_0,\n\tOCELOT_STAT_RX_YELLOW_PRIO_1,\n\tOCELOT_STAT_RX_YELLOW_PRIO_2,\n\tOCELOT_STAT_RX_YELLOW_PRIO_3,\n\tOCELOT_STAT_RX_YELLOW_PRIO_4,\n\tOCELOT_STAT_RX_YELLOW_PRIO_5,\n\tOCELOT_STAT_RX_YELLOW_PRIO_6,\n\tOCELOT_STAT_RX_YELLOW_PRIO_7,\n\tOCELOT_STAT_RX_GREEN_PRIO_0,\n\tOCELOT_STAT_RX_GREEN_PRIO_1,\n\tOCELOT_STAT_RX_GREEN_PRIO_2,\n\tOCELOT_STAT_RX_GREEN_PRIO_3,\n\tOCELOT_STAT_RX_GREEN_PRIO_4,\n\tOCELOT_STAT_RX_GREEN_PRIO_5,\n\tOCELOT_STAT_RX_GREEN_PRIO_6,\n\tOCELOT_STAT_RX_GREEN_PRIO_7,\n\tOCELOT_STAT_RX_ASSEMBLY_ERRS,\n\tOCELOT_STAT_RX_SMD_ERRS,\n\tOCELOT_STAT_RX_ASSEMBLY_OK,\n\tOCELOT_STAT_RX_MERGE_FRAGMENTS,\n\tOCELOT_STAT_RX_PMAC_OCTETS,\n\tOCELOT_STAT_RX_PMAC_UNICAST,\n\tOCELOT_STAT_RX_PMAC_MULTICAST,\n\tOCELOT_STAT_RX_PMAC_BROADCAST,\n\tOCELOT_STAT_RX_PMAC_SHORTS,\n\tOCELOT_STAT_RX_PMAC_FRAGMENTS,\n\tOCELOT_STAT_RX_PMAC_JABBERS,\n\tOCELOT_STAT_RX_PMAC_CRC_ALIGN_ERRS,\n\tOCELOT_STAT_RX_PMAC_SYM_ERRS,\n\tOCELOT_STAT_RX_PMAC_64,\n\tOCELOT_STAT_RX_PMAC_65_127,\n\tOCELOT_STAT_RX_PMAC_128_255,\n\tOCELOT_STAT_RX_PMAC_256_511,\n\tOCELOT_STAT_RX_PMAC_512_1023,\n\tOCELOT_STAT_RX_PMAC_1024_1526,\n\tOCELOT_STAT_RX_PMAC_1527_MAX,\n\tOCELOT_STAT_RX_PMAC_PAUSE,\n\tOCELOT_STAT_RX_PMAC_CONTROL,\n\tOCELOT_STAT_RX_PMAC_LONGS,\n\tOCELOT_STAT_TX_OCTETS,\n\tOCELOT_STAT_TX_UNICAST,\n\tOCELOT_STAT_TX_MULTICAST,\n\tOCELOT_STAT_TX_BROADCAST,\n\tOCELOT_STAT_TX_COLLISION,\n\tOCELOT_STAT_TX_DROPS,\n\tOCELOT_STAT_TX_PAUSE,\n\tOCELOT_STAT_TX_64,\n\tOCELOT_STAT_TX_65_127,\n\tOCELOT_STAT_TX_128_255,\n\tOCELOT_STAT_TX_256_511,\n\tOCELOT_STAT_TX_512_1023,\n\tOCELOT_STAT_TX_1024_1526,\n\tOCELOT_STAT_TX_1527_MAX,\n\tOCELOT_STAT_TX_YELLOW_PRIO_0,\n\tOCELOT_STAT_TX_YELLOW_PRIO_1,\n\tOCELOT_STAT_TX_YELLOW_PRIO_2,\n\tOCELOT_STAT_TX_YELLOW_PRIO_3,\n\tOCELOT_STAT_TX_YELLOW_PRIO_4,\n\tOCELOT_STAT_TX_YELLOW_PRIO_5,\n\tOCELOT_STAT_TX_YELLOW_PRIO_6,\n\tOCELOT_STAT_TX_YELLOW_PRIO_7,\n\tOCELOT_STAT_TX_GREEN_PRIO_0,\n\tOCELOT_STAT_TX_GREEN_PRIO_1,\n\tOCELOT_STAT_TX_GREEN_PRIO_2,\n\tOCELOT_STAT_TX_GREEN_PRIO_3,\n\tOCELOT_STAT_TX_GREEN_PRIO_4,\n\tOCELOT_STAT_TX_GREEN_PRIO_5,\n\tOCELOT_STAT_TX_GREEN_PRIO_6,\n\tOCELOT_STAT_TX_GREEN_PRIO_7,\n\tOCELOT_STAT_TX_AGED,\n\tOCELOT_STAT_TX_MM_HOLD,\n\tOCELOT_STAT_TX_MERGE_FRAGMENTS,\n\tOCELOT_STAT_TX_PMAC_OCTETS,\n\tOCELOT_STAT_TX_PMAC_UNICAST,\n\tOCELOT_STAT_TX_PMAC_MULTICAST,\n\tOCELOT_STAT_TX_PMAC_BROADCAST,\n\tOCELOT_STAT_TX_PMAC_PAUSE,\n\tOCELOT_STAT_TX_PMAC_64,\n\tOCELOT_STAT_TX_PMAC_65_127,\n\tOCELOT_STAT_TX_PMAC_128_255,\n\tOCELOT_STAT_TX_PMAC_256_511,\n\tOCELOT_STAT_TX_PMAC_512_1023,\n\tOCELOT_STAT_TX_PMAC_1024_1526,\n\tOCELOT_STAT_TX_PMAC_1527_MAX,\n\tOCELOT_STAT_DROP_LOCAL,\n\tOCELOT_STAT_DROP_TAIL,\n\tOCELOT_STAT_DROP_YELLOW_PRIO_0,\n\tOCELOT_STAT_DROP_YELLOW_PRIO_1,\n\tOCELOT_STAT_DROP_YELLOW_PRIO_2,\n\tOCELOT_STAT_DROP_YELLOW_PRIO_3,\n\tOCELOT_STAT_DROP_YELLOW_PRIO_4,\n\tOCELOT_STAT_DROP_YELLOW_PRIO_5,\n\tOCELOT_STAT_DROP_YELLOW_PRIO_6,\n\tOCELOT_STAT_DROP_YELLOW_PRIO_7,\n\tOCELOT_STAT_DROP_GREEN_PRIO_0,\n\tOCELOT_STAT_DROP_GREEN_PRIO_1,\n\tOCELOT_STAT_DROP_GREEN_PRIO_2,\n\tOCELOT_STAT_DROP_GREEN_PRIO_3,\n\tOCELOT_STAT_DROP_GREEN_PRIO_4,\n\tOCELOT_STAT_DROP_GREEN_PRIO_5,\n\tOCELOT_STAT_DROP_GREEN_PRIO_6,\n\tOCELOT_STAT_DROP_GREEN_PRIO_7,\n\tOCELOT_NUM_STATS,\n};\n\nstruct ocelot_stat_layout {\n\tenum ocelot_reg reg;\n\tchar name[ETH_GSTRING_LEN];\n};\n\n \n#define OCELOT_STAT(kind) \\\n\t[OCELOT_STAT_ ## kind] = { .reg = SYS_COUNT_ ## kind }\n \n#define OCELOT_STAT_ETHTOOL(kind, ethtool_name) \\\n\t[OCELOT_STAT_ ## kind] = { .reg = SYS_COUNT_ ## kind, .name = ethtool_name }\n\n#define OCELOT_COMMON_STATS \\\n\tOCELOT_STAT_ETHTOOL(RX_OCTETS, \"rx_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_UNICAST, \"rx_unicast\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_MULTICAST, \"rx_multicast\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_BROADCAST, \"rx_broadcast\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_SHORTS, \"rx_shorts\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_FRAGMENTS, \"rx_fragments\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_JABBERS, \"rx_jabbers\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_CRC_ALIGN_ERRS, \"rx_crc_align_errs\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_SYM_ERRS, \"rx_sym_errs\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_64, \"rx_frames_below_65_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_65_127, \"rx_frames_65_to_127_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_128_255, \"rx_frames_128_to_255_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_256_511, \"rx_frames_256_to_511_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_512_1023, \"rx_frames_512_to_1023_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_1024_1526, \"rx_frames_1024_to_1526_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_1527_MAX, \"rx_frames_over_1526_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_PAUSE, \"rx_pause\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_CONTROL, \"rx_control\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_LONGS, \"rx_longs\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_CLASSIFIED_DROPS, \"rx_classified_drops\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_RED_PRIO_0, \"rx_red_prio_0\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_RED_PRIO_1, \"rx_red_prio_1\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_RED_PRIO_2, \"rx_red_prio_2\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_RED_PRIO_3, \"rx_red_prio_3\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_RED_PRIO_4, \"rx_red_prio_4\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_RED_PRIO_5, \"rx_red_prio_5\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_RED_PRIO_6, \"rx_red_prio_6\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_RED_PRIO_7, \"rx_red_prio_7\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_YELLOW_PRIO_0, \"rx_yellow_prio_0\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_YELLOW_PRIO_1, \"rx_yellow_prio_1\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_YELLOW_PRIO_2, \"rx_yellow_prio_2\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_YELLOW_PRIO_3, \"rx_yellow_prio_3\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_YELLOW_PRIO_4, \"rx_yellow_prio_4\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_YELLOW_PRIO_5, \"rx_yellow_prio_5\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_YELLOW_PRIO_6, \"rx_yellow_prio_6\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_YELLOW_PRIO_7, \"rx_yellow_prio_7\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_GREEN_PRIO_0, \"rx_green_prio_0\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_GREEN_PRIO_1, \"rx_green_prio_1\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_GREEN_PRIO_2, \"rx_green_prio_2\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_GREEN_PRIO_3, \"rx_green_prio_3\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_GREEN_PRIO_4, \"rx_green_prio_4\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_GREEN_PRIO_5, \"rx_green_prio_5\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_GREEN_PRIO_6, \"rx_green_prio_6\"), \\\n\tOCELOT_STAT_ETHTOOL(RX_GREEN_PRIO_7, \"rx_green_prio_7\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_OCTETS, \"tx_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_UNICAST, \"tx_unicast\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_MULTICAST, \"tx_multicast\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_BROADCAST, \"tx_broadcast\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_COLLISION, \"tx_collision\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_DROPS, \"tx_drops\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_PAUSE, \"tx_pause\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_64, \"tx_frames_below_65_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_65_127, \"tx_frames_65_to_127_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_128_255, \"tx_frames_128_255_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_256_511, \"tx_frames_256_511_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_512_1023, \"tx_frames_512_1023_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_1024_1526, \"tx_frames_1024_1526_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_1527_MAX, \"tx_frames_over_1526_octets\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_YELLOW_PRIO_0, \"tx_yellow_prio_0\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_YELLOW_PRIO_1, \"tx_yellow_prio_1\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_YELLOW_PRIO_2, \"tx_yellow_prio_2\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_YELLOW_PRIO_3, \"tx_yellow_prio_3\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_YELLOW_PRIO_4, \"tx_yellow_prio_4\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_YELLOW_PRIO_5, \"tx_yellow_prio_5\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_YELLOW_PRIO_6, \"tx_yellow_prio_6\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_YELLOW_PRIO_7, \"tx_yellow_prio_7\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_GREEN_PRIO_0, \"tx_green_prio_0\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_GREEN_PRIO_1, \"tx_green_prio_1\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_GREEN_PRIO_2, \"tx_green_prio_2\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_GREEN_PRIO_3, \"tx_green_prio_3\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_GREEN_PRIO_4, \"tx_green_prio_4\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_GREEN_PRIO_5, \"tx_green_prio_5\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_GREEN_PRIO_6, \"tx_green_prio_6\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_GREEN_PRIO_7, \"tx_green_prio_7\"), \\\n\tOCELOT_STAT_ETHTOOL(TX_AGED, \"tx_aged\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_LOCAL, \"drop_local\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_TAIL, \"drop_tail\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_YELLOW_PRIO_0, \"drop_yellow_prio_0\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_YELLOW_PRIO_1, \"drop_yellow_prio_1\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_YELLOW_PRIO_2, \"drop_yellow_prio_2\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_YELLOW_PRIO_3, \"drop_yellow_prio_3\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_YELLOW_PRIO_4, \"drop_yellow_prio_4\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_YELLOW_PRIO_5, \"drop_yellow_prio_5\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_YELLOW_PRIO_6, \"drop_yellow_prio_6\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_YELLOW_PRIO_7, \"drop_yellow_prio_7\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_GREEN_PRIO_0, \"drop_green_prio_0\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_GREEN_PRIO_1, \"drop_green_prio_1\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_GREEN_PRIO_2, \"drop_green_prio_2\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_GREEN_PRIO_3, \"drop_green_prio_3\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_GREEN_PRIO_4, \"drop_green_prio_4\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_GREEN_PRIO_5, \"drop_green_prio_5\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_GREEN_PRIO_6, \"drop_green_prio_6\"), \\\n\tOCELOT_STAT_ETHTOOL(DROP_GREEN_PRIO_7, \"drop_green_prio_7\")\n\nstruct ocelot_stats_region {\n\tstruct list_head node;\n\tenum ocelot_reg base;\n\tenum ocelot_stat first_stat;\n\tint count;\n\tu32 *buf;\n};\n\nstatic const struct ocelot_stat_layout ocelot_stats_layout[OCELOT_NUM_STATS] = {\n\tOCELOT_COMMON_STATS,\n};\n\nstatic const struct ocelot_stat_layout ocelot_mm_stats_layout[OCELOT_NUM_STATS] = {\n\tOCELOT_COMMON_STATS,\n\tOCELOT_STAT(RX_ASSEMBLY_ERRS),\n\tOCELOT_STAT(RX_SMD_ERRS),\n\tOCELOT_STAT(RX_ASSEMBLY_OK),\n\tOCELOT_STAT(RX_MERGE_FRAGMENTS),\n\tOCELOT_STAT(TX_MERGE_FRAGMENTS),\n\tOCELOT_STAT(TX_MM_HOLD),\n\tOCELOT_STAT(RX_PMAC_OCTETS),\n\tOCELOT_STAT(RX_PMAC_UNICAST),\n\tOCELOT_STAT(RX_PMAC_MULTICAST),\n\tOCELOT_STAT(RX_PMAC_BROADCAST),\n\tOCELOT_STAT(RX_PMAC_SHORTS),\n\tOCELOT_STAT(RX_PMAC_FRAGMENTS),\n\tOCELOT_STAT(RX_PMAC_JABBERS),\n\tOCELOT_STAT(RX_PMAC_CRC_ALIGN_ERRS),\n\tOCELOT_STAT(RX_PMAC_SYM_ERRS),\n\tOCELOT_STAT(RX_PMAC_64),\n\tOCELOT_STAT(RX_PMAC_65_127),\n\tOCELOT_STAT(RX_PMAC_128_255),\n\tOCELOT_STAT(RX_PMAC_256_511),\n\tOCELOT_STAT(RX_PMAC_512_1023),\n\tOCELOT_STAT(RX_PMAC_1024_1526),\n\tOCELOT_STAT(RX_PMAC_1527_MAX),\n\tOCELOT_STAT(RX_PMAC_PAUSE),\n\tOCELOT_STAT(RX_PMAC_CONTROL),\n\tOCELOT_STAT(RX_PMAC_LONGS),\n\tOCELOT_STAT(TX_PMAC_OCTETS),\n\tOCELOT_STAT(TX_PMAC_UNICAST),\n\tOCELOT_STAT(TX_PMAC_MULTICAST),\n\tOCELOT_STAT(TX_PMAC_BROADCAST),\n\tOCELOT_STAT(TX_PMAC_PAUSE),\n\tOCELOT_STAT(TX_PMAC_64),\n\tOCELOT_STAT(TX_PMAC_65_127),\n\tOCELOT_STAT(TX_PMAC_128_255),\n\tOCELOT_STAT(TX_PMAC_256_511),\n\tOCELOT_STAT(TX_PMAC_512_1023),\n\tOCELOT_STAT(TX_PMAC_1024_1526),\n\tOCELOT_STAT(TX_PMAC_1527_MAX),\n};\n\nstatic const struct ocelot_stat_layout *\nocelot_get_stats_layout(struct ocelot *ocelot)\n{\n\tif (ocelot->mm_supported)\n\t\treturn ocelot_mm_stats_layout;\n\n\treturn ocelot_stats_layout;\n}\n\n \nstatic int ocelot_port_update_stats(struct ocelot *ocelot, int port)\n{\n\tstruct ocelot_stats_region *region;\n\tint err;\n\n\t \n\tocelot_write(ocelot, SYS_STAT_CFG_STAT_VIEW(port), SYS_STAT_CFG);\n\n\tlist_for_each_entry(region, &ocelot->stats_regions, node) {\n\t\terr = ocelot_bulk_read(ocelot, region->base, region->buf,\n\t\t\t\t       region->count);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\n \nstatic void ocelot_port_transfer_stats(struct ocelot *ocelot, int port)\n{\n\tstruct ocelot_stats_region *region;\n\tint j;\n\n\tlist_for_each_entry(region, &ocelot->stats_regions, node) {\n\t\tunsigned int idx = port * OCELOT_NUM_STATS + region->first_stat;\n\n\t\tfor (j = 0; j < region->count; j++) {\n\t\t\tu64 *stat = &ocelot->stats[idx + j];\n\t\t\tu64 val = region->buf[j];\n\n\t\t\tif (val < (*stat & U32_MAX))\n\t\t\t\t*stat += (u64)1 << 32;\n\n\t\t\t*stat = (*stat & ~(u64)U32_MAX) + val;\n\t\t}\n\t}\n}\n\nstatic void ocelot_check_stats_work(struct work_struct *work)\n{\n\tstruct delayed_work *del_work = to_delayed_work(work);\n\tstruct ocelot *ocelot = container_of(del_work, struct ocelot,\n\t\t\t\t\t     stats_work);\n\tint port, err;\n\n\tmutex_lock(&ocelot->stat_view_lock);\n\n\tfor (port = 0; port < ocelot->num_phys_ports; port++) {\n\t\terr = ocelot_port_update_stats(ocelot, port);\n\t\tif (err)\n\t\t\tbreak;\n\n\t\tspin_lock(&ocelot->stats_lock);\n\t\tocelot_port_transfer_stats(ocelot, port);\n\t\tspin_unlock(&ocelot->stats_lock);\n\t}\n\n\tif (!err && ocelot->ops->update_stats)\n\t\tocelot->ops->update_stats(ocelot);\n\n\tmutex_unlock(&ocelot->stat_view_lock);\n\n\tif (err)\n\t\tdev_err(ocelot->dev, \"Error %d updating ethtool stats\\n\",  err);\n\n\tqueue_delayed_work(ocelot->stats_queue, &ocelot->stats_work,\n\t\t\t   OCELOT_STATS_CHECK_DELAY);\n}\n\nvoid ocelot_get_strings(struct ocelot *ocelot, int port, u32 sset, u8 *data)\n{\n\tconst struct ocelot_stat_layout *layout;\n\tenum ocelot_stat i;\n\n\tif (sset != ETH_SS_STATS)\n\t\treturn;\n\n\tlayout = ocelot_get_stats_layout(ocelot);\n\n\tfor (i = 0; i < OCELOT_NUM_STATS; i++) {\n\t\tif (layout[i].name[0] == '\\0')\n\t\t\tcontinue;\n\n\t\tmemcpy(data, layout[i].name, ETH_GSTRING_LEN);\n\t\tdata += ETH_GSTRING_LEN;\n\t}\n}\nEXPORT_SYMBOL(ocelot_get_strings);\n\n \nstatic void ocelot_port_stats_run(struct ocelot *ocelot, int port, void *priv,\n\t\t\t\t  void (*cb)(struct ocelot *ocelot, int port,\n\t\t\t\t\t     void *priv))\n{\n\tint err;\n\n\tmutex_lock(&ocelot->stat_view_lock);\n\n\terr = ocelot_port_update_stats(ocelot, port);\n\tif (err) {\n\t\tdev_err(ocelot->dev, \"Failed to update port %d stats: %pe\\n\",\n\t\t\tport, ERR_PTR(err));\n\t\tgoto out_unlock;\n\t}\n\n\tspin_lock(&ocelot->stats_lock);\n\n\tocelot_port_transfer_stats(ocelot, port);\n\tcb(ocelot, port, priv);\n\n\tspin_unlock(&ocelot->stats_lock);\n\nout_unlock:\n\tmutex_unlock(&ocelot->stat_view_lock);\n}\n\nint ocelot_get_sset_count(struct ocelot *ocelot, int port, int sset)\n{\n\tconst struct ocelot_stat_layout *layout;\n\tenum ocelot_stat i;\n\tint num_stats = 0;\n\n\tif (sset != ETH_SS_STATS)\n\t\treturn -EOPNOTSUPP;\n\n\tlayout = ocelot_get_stats_layout(ocelot);\n\n\tfor (i = 0; i < OCELOT_NUM_STATS; i++)\n\t\tif (layout[i].name[0] != '\\0')\n\t\t\tnum_stats++;\n\n\treturn num_stats;\n}\nEXPORT_SYMBOL(ocelot_get_sset_count);\n\nstatic void ocelot_port_ethtool_stats_cb(struct ocelot *ocelot, int port,\n\t\t\t\t\t void *priv)\n{\n\tconst struct ocelot_stat_layout *layout;\n\tenum ocelot_stat i;\n\tu64 *data = priv;\n\n\tlayout = ocelot_get_stats_layout(ocelot);\n\n\t \n\tfor (i = 0; i < OCELOT_NUM_STATS; i++) {\n\t\tint index = port * OCELOT_NUM_STATS + i;\n\n\t\tif (layout[i].name[0] == '\\0')\n\t\t\tcontinue;\n\n\t\t*data++ = ocelot->stats[index];\n\t}\n}\n\nvoid ocelot_get_ethtool_stats(struct ocelot *ocelot, int port, u64 *data)\n{\n\tocelot_port_stats_run(ocelot, port, data, ocelot_port_ethtool_stats_cb);\n}\nEXPORT_SYMBOL(ocelot_get_ethtool_stats);\n\nstatic void ocelot_port_pause_stats_cb(struct ocelot *ocelot, int port, void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_pause_stats *pause_stats = priv;\n\n\tpause_stats->tx_pause_frames = s[OCELOT_STAT_TX_PAUSE];\n\tpause_stats->rx_pause_frames = s[OCELOT_STAT_RX_PAUSE];\n}\n\nstatic void ocelot_port_pmac_pause_stats_cb(struct ocelot *ocelot, int port,\n\t\t\t\t\t    void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_pause_stats *pause_stats = priv;\n\n\tpause_stats->tx_pause_frames = s[OCELOT_STAT_TX_PMAC_PAUSE];\n\tpause_stats->rx_pause_frames = s[OCELOT_STAT_RX_PMAC_PAUSE];\n}\n\nstatic void ocelot_port_mm_stats_cb(struct ocelot *ocelot, int port,\n\t\t\t\t    void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_mm_stats *stats = priv;\n\n\tstats->MACMergeFrameAssErrorCount = s[OCELOT_STAT_RX_ASSEMBLY_ERRS];\n\tstats->MACMergeFrameSmdErrorCount = s[OCELOT_STAT_RX_SMD_ERRS];\n\tstats->MACMergeFrameAssOkCount = s[OCELOT_STAT_RX_ASSEMBLY_OK];\n\tstats->MACMergeFragCountRx = s[OCELOT_STAT_RX_MERGE_FRAGMENTS];\n\tstats->MACMergeFragCountTx = s[OCELOT_STAT_TX_MERGE_FRAGMENTS];\n\tstats->MACMergeHoldCount = s[OCELOT_STAT_TX_MM_HOLD];\n}\n\nvoid ocelot_port_get_pause_stats(struct ocelot *ocelot, int port,\n\t\t\t\t struct ethtool_pause_stats *pause_stats)\n{\n\tstruct net_device *dev;\n\n\tswitch (pause_stats->src) {\n\tcase ETHTOOL_MAC_STATS_SRC_EMAC:\n\t\tocelot_port_stats_run(ocelot, port, pause_stats,\n\t\t\t\t      ocelot_port_pause_stats_cb);\n\t\tbreak;\n\tcase ETHTOOL_MAC_STATS_SRC_PMAC:\n\t\tif (ocelot->mm_supported)\n\t\t\tocelot_port_stats_run(ocelot, port, pause_stats,\n\t\t\t\t\t      ocelot_port_pmac_pause_stats_cb);\n\t\tbreak;\n\tcase ETHTOOL_MAC_STATS_SRC_AGGREGATE:\n\t\tdev = ocelot->ops->port_to_netdev(ocelot, port);\n\t\tethtool_aggregate_pause_stats(dev, pause_stats);\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL_GPL(ocelot_port_get_pause_stats);\n\nvoid ocelot_port_get_mm_stats(struct ocelot *ocelot, int port,\n\t\t\t      struct ethtool_mm_stats *stats)\n{\n\tif (!ocelot->mm_supported)\n\t\treturn;\n\n\tocelot_port_stats_run(ocelot, port, stats, ocelot_port_mm_stats_cb);\n}\nEXPORT_SYMBOL_GPL(ocelot_port_get_mm_stats);\n\nstatic const struct ethtool_rmon_hist_range ocelot_rmon_ranges[] = {\n\t{   64,    64 },\n\t{   65,   127 },\n\t{  128,   255 },\n\t{  256,   511 },\n\t{  512,  1023 },\n\t{ 1024,  1526 },\n\t{ 1527, 65535 },\n\t{},\n};\n\nstatic void ocelot_port_rmon_stats_cb(struct ocelot *ocelot, int port, void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_rmon_stats *rmon_stats = priv;\n\n\trmon_stats->undersize_pkts = s[OCELOT_STAT_RX_SHORTS];\n\trmon_stats->oversize_pkts = s[OCELOT_STAT_RX_LONGS];\n\trmon_stats->fragments = s[OCELOT_STAT_RX_FRAGMENTS];\n\trmon_stats->jabbers = s[OCELOT_STAT_RX_JABBERS];\n\n\trmon_stats->hist[0] = s[OCELOT_STAT_RX_64];\n\trmon_stats->hist[1] = s[OCELOT_STAT_RX_65_127];\n\trmon_stats->hist[2] = s[OCELOT_STAT_RX_128_255];\n\trmon_stats->hist[3] = s[OCELOT_STAT_RX_256_511];\n\trmon_stats->hist[4] = s[OCELOT_STAT_RX_512_1023];\n\trmon_stats->hist[5] = s[OCELOT_STAT_RX_1024_1526];\n\trmon_stats->hist[6] = s[OCELOT_STAT_RX_1527_MAX];\n\n\trmon_stats->hist_tx[0] = s[OCELOT_STAT_TX_64];\n\trmon_stats->hist_tx[1] = s[OCELOT_STAT_TX_65_127];\n\trmon_stats->hist_tx[2] = s[OCELOT_STAT_TX_128_255];\n\trmon_stats->hist_tx[3] = s[OCELOT_STAT_TX_256_511];\n\trmon_stats->hist_tx[4] = s[OCELOT_STAT_TX_512_1023];\n\trmon_stats->hist_tx[5] = s[OCELOT_STAT_TX_1024_1526];\n\trmon_stats->hist_tx[6] = s[OCELOT_STAT_TX_1527_MAX];\n}\n\nstatic void ocelot_port_pmac_rmon_stats_cb(struct ocelot *ocelot, int port,\n\t\t\t\t\t   void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_rmon_stats *rmon_stats = priv;\n\n\trmon_stats->undersize_pkts = s[OCELOT_STAT_RX_PMAC_SHORTS];\n\trmon_stats->oversize_pkts = s[OCELOT_STAT_RX_PMAC_LONGS];\n\trmon_stats->fragments = s[OCELOT_STAT_RX_PMAC_FRAGMENTS];\n\trmon_stats->jabbers = s[OCELOT_STAT_RX_PMAC_JABBERS];\n\n\trmon_stats->hist[0] = s[OCELOT_STAT_RX_PMAC_64];\n\trmon_stats->hist[1] = s[OCELOT_STAT_RX_PMAC_65_127];\n\trmon_stats->hist[2] = s[OCELOT_STAT_RX_PMAC_128_255];\n\trmon_stats->hist[3] = s[OCELOT_STAT_RX_PMAC_256_511];\n\trmon_stats->hist[4] = s[OCELOT_STAT_RX_PMAC_512_1023];\n\trmon_stats->hist[5] = s[OCELOT_STAT_RX_PMAC_1024_1526];\n\trmon_stats->hist[6] = s[OCELOT_STAT_RX_PMAC_1527_MAX];\n\n\trmon_stats->hist_tx[0] = s[OCELOT_STAT_TX_PMAC_64];\n\trmon_stats->hist_tx[1] = s[OCELOT_STAT_TX_PMAC_65_127];\n\trmon_stats->hist_tx[2] = s[OCELOT_STAT_TX_PMAC_128_255];\n\trmon_stats->hist_tx[3] = s[OCELOT_STAT_TX_PMAC_256_511];\n\trmon_stats->hist_tx[4] = s[OCELOT_STAT_TX_PMAC_512_1023];\n\trmon_stats->hist_tx[5] = s[OCELOT_STAT_TX_PMAC_1024_1526];\n\trmon_stats->hist_tx[6] = s[OCELOT_STAT_TX_PMAC_1527_MAX];\n}\n\nvoid ocelot_port_get_rmon_stats(struct ocelot *ocelot, int port,\n\t\t\t\tstruct ethtool_rmon_stats *rmon_stats,\n\t\t\t\tconst struct ethtool_rmon_hist_range **ranges)\n{\n\tstruct net_device *dev;\n\n\t*ranges = ocelot_rmon_ranges;\n\n\tswitch (rmon_stats->src) {\n\tcase ETHTOOL_MAC_STATS_SRC_EMAC:\n\t\tocelot_port_stats_run(ocelot, port, rmon_stats,\n\t\t\t\t      ocelot_port_rmon_stats_cb);\n\t\tbreak;\n\tcase ETHTOOL_MAC_STATS_SRC_PMAC:\n\t\tif (ocelot->mm_supported)\n\t\t\tocelot_port_stats_run(ocelot, port, rmon_stats,\n\t\t\t\t\t      ocelot_port_pmac_rmon_stats_cb);\n\t\tbreak;\n\tcase ETHTOOL_MAC_STATS_SRC_AGGREGATE:\n\t\tdev = ocelot->ops->port_to_netdev(ocelot, port);\n\t\tethtool_aggregate_rmon_stats(dev, rmon_stats);\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL_GPL(ocelot_port_get_rmon_stats);\n\nstatic void ocelot_port_ctrl_stats_cb(struct ocelot *ocelot, int port, void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_eth_ctrl_stats *ctrl_stats = priv;\n\n\tctrl_stats->MACControlFramesReceived = s[OCELOT_STAT_RX_CONTROL];\n}\n\nstatic void ocelot_port_pmac_ctrl_stats_cb(struct ocelot *ocelot, int port,\n\t\t\t\t\t   void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_eth_ctrl_stats *ctrl_stats = priv;\n\n\tctrl_stats->MACControlFramesReceived = s[OCELOT_STAT_RX_PMAC_CONTROL];\n}\n\nvoid ocelot_port_get_eth_ctrl_stats(struct ocelot *ocelot, int port,\n\t\t\t\t    struct ethtool_eth_ctrl_stats *ctrl_stats)\n{\n\tstruct net_device *dev;\n\n\tswitch (ctrl_stats->src) {\n\tcase ETHTOOL_MAC_STATS_SRC_EMAC:\n\t\tocelot_port_stats_run(ocelot, port, ctrl_stats,\n\t\t\t\t      ocelot_port_ctrl_stats_cb);\n\t\tbreak;\n\tcase ETHTOOL_MAC_STATS_SRC_PMAC:\n\t\tif (ocelot->mm_supported)\n\t\t\tocelot_port_stats_run(ocelot, port, ctrl_stats,\n\t\t\t\t\t      ocelot_port_pmac_ctrl_stats_cb);\n\t\tbreak;\n\tcase ETHTOOL_MAC_STATS_SRC_AGGREGATE:\n\t\tdev = ocelot->ops->port_to_netdev(ocelot, port);\n\t\tethtool_aggregate_ctrl_stats(dev, ctrl_stats);\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL_GPL(ocelot_port_get_eth_ctrl_stats);\n\nstatic void ocelot_port_mac_stats_cb(struct ocelot *ocelot, int port, void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_eth_mac_stats *mac_stats = priv;\n\n\tmac_stats->OctetsTransmittedOK = s[OCELOT_STAT_TX_OCTETS];\n\tmac_stats->FramesTransmittedOK = s[OCELOT_STAT_TX_64] +\n\t\t\t\t\t s[OCELOT_STAT_TX_65_127] +\n\t\t\t\t\t s[OCELOT_STAT_TX_128_255] +\n\t\t\t\t\t s[OCELOT_STAT_TX_256_511] +\n\t\t\t\t\t s[OCELOT_STAT_TX_512_1023] +\n\t\t\t\t\t s[OCELOT_STAT_TX_1024_1526] +\n\t\t\t\t\t s[OCELOT_STAT_TX_1527_MAX];\n\tmac_stats->OctetsReceivedOK = s[OCELOT_STAT_RX_OCTETS];\n\tmac_stats->FramesReceivedOK = s[OCELOT_STAT_RX_GREEN_PRIO_0] +\n\t\t\t\t      s[OCELOT_STAT_RX_GREEN_PRIO_1] +\n\t\t\t\t      s[OCELOT_STAT_RX_GREEN_PRIO_2] +\n\t\t\t\t      s[OCELOT_STAT_RX_GREEN_PRIO_3] +\n\t\t\t\t      s[OCELOT_STAT_RX_GREEN_PRIO_4] +\n\t\t\t\t      s[OCELOT_STAT_RX_GREEN_PRIO_5] +\n\t\t\t\t      s[OCELOT_STAT_RX_GREEN_PRIO_6] +\n\t\t\t\t      s[OCELOT_STAT_RX_GREEN_PRIO_7] +\n\t\t\t\t      s[OCELOT_STAT_RX_YELLOW_PRIO_0] +\n\t\t\t\t      s[OCELOT_STAT_RX_YELLOW_PRIO_1] +\n\t\t\t\t      s[OCELOT_STAT_RX_YELLOW_PRIO_2] +\n\t\t\t\t      s[OCELOT_STAT_RX_YELLOW_PRIO_3] +\n\t\t\t\t      s[OCELOT_STAT_RX_YELLOW_PRIO_4] +\n\t\t\t\t      s[OCELOT_STAT_RX_YELLOW_PRIO_5] +\n\t\t\t\t      s[OCELOT_STAT_RX_YELLOW_PRIO_6] +\n\t\t\t\t      s[OCELOT_STAT_RX_YELLOW_PRIO_7];\n\tmac_stats->MulticastFramesXmittedOK = s[OCELOT_STAT_TX_MULTICAST];\n\tmac_stats->BroadcastFramesXmittedOK = s[OCELOT_STAT_TX_BROADCAST];\n\tmac_stats->MulticastFramesReceivedOK = s[OCELOT_STAT_RX_MULTICAST];\n\tmac_stats->BroadcastFramesReceivedOK = s[OCELOT_STAT_RX_BROADCAST];\n\tmac_stats->FrameTooLongErrors = s[OCELOT_STAT_RX_LONGS];\n\t \n\tmac_stats->FrameCheckSequenceErrors = s[OCELOT_STAT_RX_CRC_ALIGN_ERRS];\n\tmac_stats->AlignmentErrors = s[OCELOT_STAT_RX_CRC_ALIGN_ERRS];\n}\n\nstatic void ocelot_port_pmac_mac_stats_cb(struct ocelot *ocelot, int port,\n\t\t\t\t\t  void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_eth_mac_stats *mac_stats = priv;\n\n\tmac_stats->OctetsTransmittedOK = s[OCELOT_STAT_TX_PMAC_OCTETS];\n\tmac_stats->FramesTransmittedOK = s[OCELOT_STAT_TX_PMAC_64] +\n\t\t\t\t\t s[OCELOT_STAT_TX_PMAC_65_127] +\n\t\t\t\t\t s[OCELOT_STAT_TX_PMAC_128_255] +\n\t\t\t\t\t s[OCELOT_STAT_TX_PMAC_256_511] +\n\t\t\t\t\t s[OCELOT_STAT_TX_PMAC_512_1023] +\n\t\t\t\t\t s[OCELOT_STAT_TX_PMAC_1024_1526] +\n\t\t\t\t\t s[OCELOT_STAT_TX_PMAC_1527_MAX];\n\tmac_stats->OctetsReceivedOK = s[OCELOT_STAT_RX_PMAC_OCTETS];\n\tmac_stats->FramesReceivedOK = s[OCELOT_STAT_RX_PMAC_64] +\n\t\t\t\t      s[OCELOT_STAT_RX_PMAC_65_127] +\n\t\t\t\t      s[OCELOT_STAT_RX_PMAC_128_255] +\n\t\t\t\t      s[OCELOT_STAT_RX_PMAC_256_511] +\n\t\t\t\t      s[OCELOT_STAT_RX_PMAC_512_1023] +\n\t\t\t\t      s[OCELOT_STAT_RX_PMAC_1024_1526] +\n\t\t\t\t      s[OCELOT_STAT_RX_PMAC_1527_MAX];\n\tmac_stats->MulticastFramesXmittedOK = s[OCELOT_STAT_TX_PMAC_MULTICAST];\n\tmac_stats->BroadcastFramesXmittedOK = s[OCELOT_STAT_TX_PMAC_BROADCAST];\n\tmac_stats->MulticastFramesReceivedOK = s[OCELOT_STAT_RX_PMAC_MULTICAST];\n\tmac_stats->BroadcastFramesReceivedOK = s[OCELOT_STAT_RX_PMAC_BROADCAST];\n\tmac_stats->FrameTooLongErrors = s[OCELOT_STAT_RX_PMAC_LONGS];\n\t \n\tmac_stats->FrameCheckSequenceErrors = s[OCELOT_STAT_RX_PMAC_CRC_ALIGN_ERRS];\n\tmac_stats->AlignmentErrors = s[OCELOT_STAT_RX_PMAC_CRC_ALIGN_ERRS];\n}\n\nvoid ocelot_port_get_eth_mac_stats(struct ocelot *ocelot, int port,\n\t\t\t\t   struct ethtool_eth_mac_stats *mac_stats)\n{\n\tstruct net_device *dev;\n\n\tswitch (mac_stats->src) {\n\tcase ETHTOOL_MAC_STATS_SRC_EMAC:\n\t\tocelot_port_stats_run(ocelot, port, mac_stats,\n\t\t\t\t      ocelot_port_mac_stats_cb);\n\t\tbreak;\n\tcase ETHTOOL_MAC_STATS_SRC_PMAC:\n\t\tif (ocelot->mm_supported)\n\t\t\tocelot_port_stats_run(ocelot, port, mac_stats,\n\t\t\t\t\t      ocelot_port_pmac_mac_stats_cb);\n\t\tbreak;\n\tcase ETHTOOL_MAC_STATS_SRC_AGGREGATE:\n\t\tdev = ocelot->ops->port_to_netdev(ocelot, port);\n\t\tethtool_aggregate_mac_stats(dev, mac_stats);\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL_GPL(ocelot_port_get_eth_mac_stats);\n\nstatic void ocelot_port_phy_stats_cb(struct ocelot *ocelot, int port, void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_eth_phy_stats *phy_stats = priv;\n\n\tphy_stats->SymbolErrorDuringCarrier = s[OCELOT_STAT_RX_SYM_ERRS];\n}\n\nstatic void ocelot_port_pmac_phy_stats_cb(struct ocelot *ocelot, int port,\n\t\t\t\t\t  void *priv)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\tstruct ethtool_eth_phy_stats *phy_stats = priv;\n\n\tphy_stats->SymbolErrorDuringCarrier = s[OCELOT_STAT_RX_PMAC_SYM_ERRS];\n}\n\nvoid ocelot_port_get_eth_phy_stats(struct ocelot *ocelot, int port,\n\t\t\t\t   struct ethtool_eth_phy_stats *phy_stats)\n{\n\tstruct net_device *dev;\n\n\tswitch (phy_stats->src) {\n\tcase ETHTOOL_MAC_STATS_SRC_EMAC:\n\t\tocelot_port_stats_run(ocelot, port, phy_stats,\n\t\t\t\t      ocelot_port_phy_stats_cb);\n\t\tbreak;\n\tcase ETHTOOL_MAC_STATS_SRC_PMAC:\n\t\tif (ocelot->mm_supported)\n\t\t\tocelot_port_stats_run(ocelot, port, phy_stats,\n\t\t\t\t\t      ocelot_port_pmac_phy_stats_cb);\n\t\tbreak;\n\tcase ETHTOOL_MAC_STATS_SRC_AGGREGATE:\n\t\tdev = ocelot->ops->port_to_netdev(ocelot, port);\n\t\tethtool_aggregate_phy_stats(dev, phy_stats);\n\t\tbreak;\n\t}\n}\nEXPORT_SYMBOL_GPL(ocelot_port_get_eth_phy_stats);\n\nvoid ocelot_port_get_stats64(struct ocelot *ocelot, int port,\n\t\t\t     struct rtnl_link_stats64 *stats)\n{\n\tu64 *s = &ocelot->stats[port * OCELOT_NUM_STATS];\n\n\tspin_lock(&ocelot->stats_lock);\n\n\t \n\tstats->rx_bytes = s[OCELOT_STAT_RX_OCTETS];\n\tstats->rx_packets = s[OCELOT_STAT_RX_SHORTS] +\n\t\t\t    s[OCELOT_STAT_RX_FRAGMENTS] +\n\t\t\t    s[OCELOT_STAT_RX_JABBERS] +\n\t\t\t    s[OCELOT_STAT_RX_LONGS] +\n\t\t\t    s[OCELOT_STAT_RX_64] +\n\t\t\t    s[OCELOT_STAT_RX_65_127] +\n\t\t\t    s[OCELOT_STAT_RX_128_255] +\n\t\t\t    s[OCELOT_STAT_RX_256_511] +\n\t\t\t    s[OCELOT_STAT_RX_512_1023] +\n\t\t\t    s[OCELOT_STAT_RX_1024_1526] +\n\t\t\t    s[OCELOT_STAT_RX_1527_MAX];\n\tstats->multicast = s[OCELOT_STAT_RX_MULTICAST];\n\tstats->rx_missed_errors = s[OCELOT_STAT_DROP_TAIL];\n\tstats->rx_dropped = s[OCELOT_STAT_RX_RED_PRIO_0] +\n\t\t\t    s[OCELOT_STAT_RX_RED_PRIO_1] +\n\t\t\t    s[OCELOT_STAT_RX_RED_PRIO_2] +\n\t\t\t    s[OCELOT_STAT_RX_RED_PRIO_3] +\n\t\t\t    s[OCELOT_STAT_RX_RED_PRIO_4] +\n\t\t\t    s[OCELOT_STAT_RX_RED_PRIO_5] +\n\t\t\t    s[OCELOT_STAT_RX_RED_PRIO_6] +\n\t\t\t    s[OCELOT_STAT_RX_RED_PRIO_7] +\n\t\t\t    s[OCELOT_STAT_DROP_LOCAL] +\n\t\t\t    s[OCELOT_STAT_DROP_YELLOW_PRIO_0] +\n\t\t\t    s[OCELOT_STAT_DROP_YELLOW_PRIO_1] +\n\t\t\t    s[OCELOT_STAT_DROP_YELLOW_PRIO_2] +\n\t\t\t    s[OCELOT_STAT_DROP_YELLOW_PRIO_3] +\n\t\t\t    s[OCELOT_STAT_DROP_YELLOW_PRIO_4] +\n\t\t\t    s[OCELOT_STAT_DROP_YELLOW_PRIO_5] +\n\t\t\t    s[OCELOT_STAT_DROP_YELLOW_PRIO_6] +\n\t\t\t    s[OCELOT_STAT_DROP_YELLOW_PRIO_7] +\n\t\t\t    s[OCELOT_STAT_DROP_GREEN_PRIO_0] +\n\t\t\t    s[OCELOT_STAT_DROP_GREEN_PRIO_1] +\n\t\t\t    s[OCELOT_STAT_DROP_GREEN_PRIO_2] +\n\t\t\t    s[OCELOT_STAT_DROP_GREEN_PRIO_3] +\n\t\t\t    s[OCELOT_STAT_DROP_GREEN_PRIO_4] +\n\t\t\t    s[OCELOT_STAT_DROP_GREEN_PRIO_5] +\n\t\t\t    s[OCELOT_STAT_DROP_GREEN_PRIO_6] +\n\t\t\t    s[OCELOT_STAT_DROP_GREEN_PRIO_7];\n\n\t \n\tstats->tx_bytes = s[OCELOT_STAT_TX_OCTETS];\n\tstats->tx_packets = s[OCELOT_STAT_TX_64] +\n\t\t\t    s[OCELOT_STAT_TX_65_127] +\n\t\t\t    s[OCELOT_STAT_TX_128_255] +\n\t\t\t    s[OCELOT_STAT_TX_256_511] +\n\t\t\t    s[OCELOT_STAT_TX_512_1023] +\n\t\t\t    s[OCELOT_STAT_TX_1024_1526] +\n\t\t\t    s[OCELOT_STAT_TX_1527_MAX];\n\tstats->tx_dropped = s[OCELOT_STAT_TX_DROPS] +\n\t\t\t    s[OCELOT_STAT_TX_AGED];\n\tstats->collisions = s[OCELOT_STAT_TX_COLLISION];\n\n\tspin_unlock(&ocelot->stats_lock);\n}\nEXPORT_SYMBOL(ocelot_port_get_stats64);\n\nstatic int ocelot_prepare_stats_regions(struct ocelot *ocelot)\n{\n\tstruct ocelot_stats_region *region = NULL;\n\tconst struct ocelot_stat_layout *layout;\n\tenum ocelot_reg last = 0;\n\tenum ocelot_stat i;\n\n\tINIT_LIST_HEAD(&ocelot->stats_regions);\n\n\tlayout = ocelot_get_stats_layout(ocelot);\n\n\tfor (i = 0; i < OCELOT_NUM_STATS; i++) {\n\t\tif (!layout[i].reg)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (last) {\n\t\t\tWARN(ocelot->map[SYS][last & REG_MASK] >= ocelot->map[SYS][layout[i].reg & REG_MASK],\n\t\t\t     \"reg 0x%x had address 0x%x but reg 0x%x has address 0x%x, bulking broken!\",\n\t\t\t     last, ocelot->map[SYS][last & REG_MASK],\n\t\t\t     layout[i].reg, ocelot->map[SYS][layout[i].reg & REG_MASK]);\n\t\t}\n\n\t\tif (region && ocelot->map[SYS][layout[i].reg & REG_MASK] ==\n\t\t    ocelot->map[SYS][last & REG_MASK] + 4) {\n\t\t\tregion->count++;\n\t\t} else {\n\t\t\tregion = devm_kzalloc(ocelot->dev, sizeof(*region),\n\t\t\t\t\t      GFP_KERNEL);\n\t\t\tif (!region)\n\t\t\t\treturn -ENOMEM;\n\n\t\t\tregion->base = layout[i].reg;\n\t\t\tregion->first_stat = i;\n\t\t\tregion->count = 1;\n\t\t\tlist_add_tail(&region->node, &ocelot->stats_regions);\n\t\t}\n\n\t\tlast = layout[i].reg;\n\t}\n\n\tlist_for_each_entry(region, &ocelot->stats_regions, node) {\n\t\tenum ocelot_target target;\n\t\tu32 addr;\n\n\t\tocelot_reg_to_target_addr(ocelot, region->base, &target,\n\t\t\t\t\t  &addr);\n\n\t\tdev_dbg(ocelot->dev,\n\t\t\t\"region of %d contiguous counters starting with SYS:STAT:CNT[0x%03x]\\n\",\n\t\t\tregion->count, addr / 4);\n\t\tregion->buf = devm_kcalloc(ocelot->dev, region->count,\n\t\t\t\t\t   sizeof(*region->buf), GFP_KERNEL);\n\t\tif (!region->buf)\n\t\t\treturn -ENOMEM;\n\t}\n\n\treturn 0;\n}\n\nint ocelot_stats_init(struct ocelot *ocelot)\n{\n\tchar queue_name[32];\n\tint ret;\n\n\tocelot->stats = devm_kcalloc(ocelot->dev,\n\t\t\t\t     ocelot->num_phys_ports * OCELOT_NUM_STATS,\n\t\t\t\t     sizeof(u64), GFP_KERNEL);\n\tif (!ocelot->stats)\n\t\treturn -ENOMEM;\n\n\tsnprintf(queue_name, sizeof(queue_name), \"%s-stats\",\n\t\t dev_name(ocelot->dev));\n\tocelot->stats_queue = create_singlethread_workqueue(queue_name);\n\tif (!ocelot->stats_queue)\n\t\treturn -ENOMEM;\n\n\tspin_lock_init(&ocelot->stats_lock);\n\tmutex_init(&ocelot->stat_view_lock);\n\n\tret = ocelot_prepare_stats_regions(ocelot);\n\tif (ret) {\n\t\tdestroy_workqueue(ocelot->stats_queue);\n\t\treturn ret;\n\t}\n\n\tINIT_DELAYED_WORK(&ocelot->stats_work, ocelot_check_stats_work);\n\tqueue_delayed_work(ocelot->stats_queue, &ocelot->stats_work,\n\t\t\t   OCELOT_STATS_CHECK_DELAY);\n\n\treturn 0;\n}\n\nvoid ocelot_stats_deinit(struct ocelot *ocelot)\n{\n\tcancel_delayed_work(&ocelot->stats_work);\n\tdestroy_workqueue(ocelot->stats_queue);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}