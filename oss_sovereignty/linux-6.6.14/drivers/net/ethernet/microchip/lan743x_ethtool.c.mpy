{
  "module_name": "lan743x_ethtool.c",
  "hash_id": "bd6711efc681803be4e9fce6ac09ff11031c93c74f9b6a8a62d2f441071d7497",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/lan743x_ethtool.c",
  "human_readable_source": " \n \n\n#include <linux/netdevice.h>\n#include <linux/net_tstamp.h>\n#include <linux/pci.h>\n#include <linux/phy.h>\n#include \"lan743x_main.h\"\n#include \"lan743x_ethtool.h\"\n#include <linux/sched.h>\n#include <linux/iopoll.h>\n\n \n#define LAN743X_EEPROM_MAGIC\t\t    (0x74A5)\n#define LAN743X_OTP_MAGIC\t\t    (0x74F3)\n#define EEPROM_INDICATOR_1\t\t    (0xA5)\n#define EEPROM_INDICATOR_2\t\t    (0xAA)\n#define EEPROM_MAC_OFFSET\t\t    (0x01)\n#define MAX_EEPROM_SIZE\t\t\t    (512)\n#define MAX_OTP_SIZE\t\t\t    (1024)\n#define OTP_INDICATOR_1\t\t\t    (0xF3)\n#define OTP_INDICATOR_2\t\t\t    (0xF7)\n\n#define LOCK_TIMEOUT_MAX_CNT\t\t    (100) \n\n#define LAN743X_CSR_READ_OP(offset)\t     lan743x_csr_read(adapter, offset)\n\nstatic int lan743x_otp_power_up(struct lan743x_adapter *adapter)\n{\n\tu32 reg_value;\n\n\treg_value = lan743x_csr_read(adapter, OTP_PWR_DN);\n\n\tif (reg_value & OTP_PWR_DN_PWRDN_N_) {\n\t\t \n\t\treg_value &= ~OTP_PWR_DN_PWRDN_N_;\n\t\tlan743x_csr_write(adapter, OTP_PWR_DN, reg_value);\n\n\t\tusleep_range(100, 20000);\n\t}\n\n\treturn 0;\n}\n\nstatic void lan743x_otp_power_down(struct lan743x_adapter *adapter)\n{\n\tu32 reg_value;\n\n\treg_value = lan743x_csr_read(adapter, OTP_PWR_DN);\n\tif (!(reg_value & OTP_PWR_DN_PWRDN_N_)) {\n\t\t \n\t\treg_value |= OTP_PWR_DN_PWRDN_N_;\n\t\tlan743x_csr_write(adapter, OTP_PWR_DN, reg_value);\n\t}\n}\n\nstatic void lan743x_otp_set_address(struct lan743x_adapter *adapter,\n\t\t\t\t    u32 address)\n{\n\tlan743x_csr_write(adapter, OTP_ADDR_HIGH, (address >> 8) & 0x03);\n\tlan743x_csr_write(adapter, OTP_ADDR_LOW, address & 0xFF);\n}\n\nstatic void lan743x_otp_read_go(struct lan743x_adapter *adapter)\n{\n\tlan743x_csr_write(adapter, OTP_FUNC_CMD, OTP_FUNC_CMD_READ_);\n\tlan743x_csr_write(adapter, OTP_CMD_GO, OTP_CMD_GO_GO_);\n}\n\nstatic int lan743x_otp_wait_till_not_busy(struct lan743x_adapter *adapter)\n{\n\tunsigned long timeout;\n\tu32 reg_val;\n\n\ttimeout = jiffies + HZ;\n\tdo {\n\t\tif (time_after(jiffies, timeout)) {\n\t\t\tnetif_warn(adapter, drv, adapter->netdev,\n\t\t\t\t   \"Timeout on OTP_STATUS completion\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t\tudelay(1);\n\t\treg_val = lan743x_csr_read(adapter, OTP_STATUS);\n\t} while (reg_val & OTP_STATUS_BUSY_);\n\n\treturn 0;\n}\n\nstatic int lan743x_otp_read(struct lan743x_adapter *adapter, u32 offset,\n\t\t\t    u32 length, u8 *data)\n{\n\tint ret;\n\tint i;\n\n\tif (offset + length > MAX_OTP_SIZE)\n\t\treturn -EINVAL;\n\n\tret = lan743x_otp_power_up(adapter);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = lan743x_otp_wait_till_not_busy(adapter);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfor (i = 0; i < length; i++) {\n\t\tlan743x_otp_set_address(adapter, offset + i);\n\n\t\tlan743x_otp_read_go(adapter);\n\t\tret = lan743x_otp_wait_till_not_busy(adapter);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tdata[i] = lan743x_csr_read(adapter, OTP_READ_DATA);\n\t}\n\n\tlan743x_otp_power_down(adapter);\n\n\treturn 0;\n}\n\nstatic int lan743x_otp_write(struct lan743x_adapter *adapter, u32 offset,\n\t\t\t     u32 length, u8 *data)\n{\n\tint ret;\n\tint i;\n\n\tif (offset + length > MAX_OTP_SIZE)\n\t\treturn -EINVAL;\n\n\tret = lan743x_otp_power_up(adapter);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = lan743x_otp_wait_till_not_busy(adapter);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tlan743x_csr_write(adapter, OTP_PRGM_MODE, OTP_PRGM_MODE_BYTE_);\n\n\tfor (i = 0; i < length; i++) {\n\t\tlan743x_otp_set_address(adapter, offset + i);\n\n\t\tlan743x_csr_write(adapter, OTP_PRGM_DATA, data[i]);\n\t\tlan743x_csr_write(adapter, OTP_TST_CMD, OTP_TST_CMD_PRGVRFY_);\n\t\tlan743x_csr_write(adapter, OTP_CMD_GO, OTP_CMD_GO_GO_);\n\n\t\tret = lan743x_otp_wait_till_not_busy(adapter);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tlan743x_otp_power_down(adapter);\n\n\treturn 0;\n}\n\nint lan743x_hs_syslock_acquire(struct lan743x_adapter *adapter,\n\t\t\t       u16 timeout)\n{\n\tu16 timeout_cnt = 0;\n\tu32 val;\n\n\tdo {\n\t\tspin_lock(&adapter->eth_syslock_spinlock);\n\t\tif (adapter->eth_syslock_acquire_cnt == 0) {\n\t\t\tlan743x_csr_write(adapter, ETH_SYSTEM_SYS_LOCK_REG,\n\t\t\t\t\t  SYS_LOCK_REG_ENET_SS_LOCK_);\n\t\t\tval = lan743x_csr_read(adapter,\n\t\t\t\t\t       ETH_SYSTEM_SYS_LOCK_REG);\n\t\t\tif (val & SYS_LOCK_REG_ENET_SS_LOCK_) {\n\t\t\t\tadapter->eth_syslock_acquire_cnt++;\n\t\t\t\tWARN_ON(adapter->eth_syslock_acquire_cnt == 0);\n\t\t\t\tspin_unlock(&adapter->eth_syslock_spinlock);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t} else {\n\t\t\tadapter->eth_syslock_acquire_cnt++;\n\t\t\tWARN_ON(adapter->eth_syslock_acquire_cnt == 0);\n\t\t\tspin_unlock(&adapter->eth_syslock_spinlock);\n\t\t\tbreak;\n\t\t}\n\n\t\tspin_unlock(&adapter->eth_syslock_spinlock);\n\n\t\tif (timeout_cnt++ < timeout)\n\t\t\tusleep_range(10000, 11000);\n\t\telse\n\t\t\treturn -ETIMEDOUT;\n\t} while (true);\n\n\treturn 0;\n}\n\nvoid lan743x_hs_syslock_release(struct lan743x_adapter *adapter)\n{\n\tu32 val;\n\n\tspin_lock(&adapter->eth_syslock_spinlock);\n\tWARN_ON(adapter->eth_syslock_acquire_cnt == 0);\n\n\tif (adapter->eth_syslock_acquire_cnt) {\n\t\tadapter->eth_syslock_acquire_cnt--;\n\t\tif (adapter->eth_syslock_acquire_cnt == 0) {\n\t\t\tlan743x_csr_write(adapter, ETH_SYSTEM_SYS_LOCK_REG, 0);\n\t\t\tval = lan743x_csr_read(adapter,\n\t\t\t\t\t       ETH_SYSTEM_SYS_LOCK_REG);\n\t\t\tWARN_ON((val & SYS_LOCK_REG_ENET_SS_LOCK_) != 0);\n\t\t}\n\t}\n\n\tspin_unlock(&adapter->eth_syslock_spinlock);\n}\n\nstatic void lan743x_hs_otp_power_up(struct lan743x_adapter *adapter)\n{\n\tu32 reg_value;\n\n\treg_value = lan743x_csr_read(adapter, HS_OTP_PWR_DN);\n\tif (reg_value & OTP_PWR_DN_PWRDN_N_) {\n\t\treg_value &= ~OTP_PWR_DN_PWRDN_N_;\n\t\tlan743x_csr_write(adapter, HS_OTP_PWR_DN, reg_value);\n\t\t \n\t\tlan743x_csr_read(adapter, HS_OTP_PWR_DN);\n\t\tudelay(1);\n\t}\n}\n\nstatic void lan743x_hs_otp_power_down(struct lan743x_adapter *adapter)\n{\n\tu32 reg_value;\n\n\treg_value = lan743x_csr_read(adapter, HS_OTP_PWR_DN);\n\tif (!(reg_value & OTP_PWR_DN_PWRDN_N_)) {\n\t\treg_value |= OTP_PWR_DN_PWRDN_N_;\n\t\tlan743x_csr_write(adapter, HS_OTP_PWR_DN, reg_value);\n\t\t \n\t\tlan743x_csr_read(adapter, HS_OTP_PWR_DN);\n\t\tudelay(1);\n\t}\n}\n\nstatic void lan743x_hs_otp_set_address(struct lan743x_adapter *adapter,\n\t\t\t\t       u32 address)\n{\n\tlan743x_csr_write(adapter, HS_OTP_ADDR_HIGH, (address >> 8) & 0x03);\n\tlan743x_csr_write(adapter, HS_OTP_ADDR_LOW, address & 0xFF);\n}\n\nstatic void lan743x_hs_otp_read_go(struct lan743x_adapter *adapter)\n{\n\tlan743x_csr_write(adapter, HS_OTP_FUNC_CMD, OTP_FUNC_CMD_READ_);\n\tlan743x_csr_write(adapter, HS_OTP_CMD_GO, OTP_CMD_GO_GO_);\n}\n\nstatic int lan743x_hs_otp_cmd_cmplt_chk(struct lan743x_adapter *adapter)\n{\n\tu32 val;\n\n\treturn readx_poll_timeout(LAN743X_CSR_READ_OP, HS_OTP_STATUS, val,\n\t\t\t\t  !(val & OTP_STATUS_BUSY_),\n\t\t\t\t  80, 10000);\n}\n\nstatic int lan743x_hs_otp_read(struct lan743x_adapter *adapter, u32 offset,\n\t\t\t       u32 length, u8 *data)\n{\n\tint ret;\n\tint i;\n\n\tret = lan743x_hs_syslock_acquire(adapter, LOCK_TIMEOUT_MAX_CNT);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tlan743x_hs_otp_power_up(adapter);\n\n\tret = lan743x_hs_otp_cmd_cmplt_chk(adapter);\n\tif (ret < 0)\n\t\tgoto power_down;\n\n\tlan743x_hs_syslock_release(adapter);\n\n\tfor (i = 0; i < length; i++) {\n\t\tret = lan743x_hs_syslock_acquire(adapter,\n\t\t\t\t\t\t LOCK_TIMEOUT_MAX_CNT);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tlan743x_hs_otp_set_address(adapter, offset + i);\n\n\t\tlan743x_hs_otp_read_go(adapter);\n\t\tret = lan743x_hs_otp_cmd_cmplt_chk(adapter);\n\t\tif (ret < 0)\n\t\t\tgoto power_down;\n\n\t\tdata[i] = lan743x_csr_read(adapter, HS_OTP_READ_DATA);\n\n\t\tlan743x_hs_syslock_release(adapter);\n\t}\n\n\tret = lan743x_hs_syslock_acquire(adapter,\n\t\t\t\t\t LOCK_TIMEOUT_MAX_CNT);\n\tif (ret < 0)\n\t\treturn ret;\n\npower_down:\n\tlan743x_hs_otp_power_down(adapter);\n\tlan743x_hs_syslock_release(adapter);\n\n\treturn ret;\n}\n\nstatic int lan743x_hs_otp_write(struct lan743x_adapter *adapter, u32 offset,\n\t\t\t\tu32 length, u8 *data)\n{\n\tint ret;\n\tint i;\n\n\tret = lan743x_hs_syslock_acquire(adapter, LOCK_TIMEOUT_MAX_CNT);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tlan743x_hs_otp_power_up(adapter);\n\n\tret = lan743x_hs_otp_cmd_cmplt_chk(adapter);\n\tif (ret < 0)\n\t\tgoto power_down;\n\n\t \n\tlan743x_csr_write(adapter, HS_OTP_PRGM_MODE, OTP_PRGM_MODE_BYTE_);\n\n\tlan743x_hs_syslock_release(adapter);\n\n\tfor (i = 0; i < length; i++) {\n\t\tret = lan743x_hs_syslock_acquire(adapter,\n\t\t\t\t\t\t LOCK_TIMEOUT_MAX_CNT);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tlan743x_hs_otp_set_address(adapter, offset + i);\n\n\t\tlan743x_csr_write(adapter, HS_OTP_PRGM_DATA, data[i]);\n\t\tlan743x_csr_write(adapter, HS_OTP_TST_CMD,\n\t\t\t\t  OTP_TST_CMD_PRGVRFY_);\n\t\tlan743x_csr_write(adapter, HS_OTP_CMD_GO, OTP_CMD_GO_GO_);\n\n\t\tret = lan743x_hs_otp_cmd_cmplt_chk(adapter);\n\t\tif (ret < 0)\n\t\t\tgoto power_down;\n\n\t\tlan743x_hs_syslock_release(adapter);\n\t}\n\n\tret = lan743x_hs_syslock_acquire(adapter, LOCK_TIMEOUT_MAX_CNT);\n\tif (ret < 0)\n\t\treturn ret;\n\npower_down:\n\tlan743x_hs_otp_power_down(adapter);\n\tlan743x_hs_syslock_release(adapter);\n\n\treturn ret;\n}\n\nstatic int lan743x_eeprom_wait(struct lan743x_adapter *adapter)\n{\n\tunsigned long start_time = jiffies;\n\tu32 val;\n\n\tdo {\n\t\tval = lan743x_csr_read(adapter, E2P_CMD);\n\n\t\tif (!(val & E2P_CMD_EPC_BUSY_) ||\n\t\t    (val & E2P_CMD_EPC_TIMEOUT_))\n\t\t\tbreak;\n\t\tusleep_range(40, 100);\n\t} while (!time_after(jiffies, start_time + HZ));\n\n\tif (val & (E2P_CMD_EPC_TIMEOUT_ | E2P_CMD_EPC_BUSY_)) {\n\t\tnetif_warn(adapter, drv, adapter->netdev,\n\t\t\t   \"EEPROM read operation timeout\\n\");\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nstatic int lan743x_eeprom_confirm_not_busy(struct lan743x_adapter *adapter)\n{\n\tunsigned long start_time = jiffies;\n\tu32 val;\n\n\tdo {\n\t\tval = lan743x_csr_read(adapter, E2P_CMD);\n\n\t\tif (!(val & E2P_CMD_EPC_BUSY_))\n\t\t\treturn 0;\n\n\t\tusleep_range(40, 100);\n\t} while (!time_after(jiffies, start_time + HZ));\n\n\tnetif_warn(adapter, drv, adapter->netdev, \"EEPROM is busy\\n\");\n\treturn -EIO;\n}\n\nstatic int lan743x_eeprom_read(struct lan743x_adapter *adapter,\n\t\t\t       u32 offset, u32 length, u8 *data)\n{\n\tint retval;\n\tu32 val;\n\tint i;\n\n\tif (offset + length > MAX_EEPROM_SIZE)\n\t\treturn -EINVAL;\n\n\tretval = lan743x_eeprom_confirm_not_busy(adapter);\n\tif (retval)\n\t\treturn retval;\n\n\tfor (i = 0; i < length; i++) {\n\t\tval = E2P_CMD_EPC_BUSY_ | E2P_CMD_EPC_CMD_READ_;\n\t\tval |= (offset & E2P_CMD_EPC_ADDR_MASK_);\n\t\tlan743x_csr_write(adapter, E2P_CMD, val);\n\n\t\tretval = lan743x_eeprom_wait(adapter);\n\t\tif (retval < 0)\n\t\t\treturn retval;\n\n\t\tval = lan743x_csr_read(adapter, E2P_DATA);\n\t\tdata[i] = val & 0xFF;\n\t\toffset++;\n\t}\n\n\treturn 0;\n}\n\nstatic int lan743x_eeprom_write(struct lan743x_adapter *adapter,\n\t\t\t\tu32 offset, u32 length, u8 *data)\n{\n\tint retval;\n\tu32 val;\n\tint i;\n\n\tif (offset + length > MAX_EEPROM_SIZE)\n\t\treturn -EINVAL;\n\n\tretval = lan743x_eeprom_confirm_not_busy(adapter);\n\tif (retval)\n\t\treturn retval;\n\n\t \n\tval = E2P_CMD_EPC_BUSY_ | E2P_CMD_EPC_CMD_EWEN_;\n\tlan743x_csr_write(adapter, E2P_CMD, val);\n\n\tretval = lan743x_eeprom_wait(adapter);\n\tif (retval < 0)\n\t\treturn retval;\n\n\tfor (i = 0; i < length; i++) {\n\t\t \n\t\tval = data[i];\n\t\tlan743x_csr_write(adapter, E2P_DATA, val);\n\n\t\t \n\t\tval = E2P_CMD_EPC_BUSY_ | E2P_CMD_EPC_CMD_WRITE_;\n\t\tval |= (offset & E2P_CMD_EPC_ADDR_MASK_);\n\t\tlan743x_csr_write(adapter, E2P_CMD, val);\n\n\t\tretval = lan743x_eeprom_wait(adapter);\n\t\tif (retval < 0)\n\t\t\treturn retval;\n\n\t\toffset++;\n\t}\n\n\treturn 0;\n}\n\nstatic int lan743x_hs_eeprom_cmd_cmplt_chk(struct lan743x_adapter *adapter)\n{\n\tu32 val;\n\n\treturn readx_poll_timeout(LAN743X_CSR_READ_OP, HS_E2P_CMD, val,\n\t\t\t\t  (!(val & HS_E2P_CMD_EPC_BUSY_) ||\n\t\t\t\t    (val & HS_E2P_CMD_EPC_TIMEOUT_)),\n\t\t\t\t  50, 10000);\n}\n\nstatic int lan743x_hs_eeprom_read(struct lan743x_adapter *adapter,\n\t\t\t\t  u32 offset, u32 length, u8 *data)\n{\n\tint retval;\n\tu32 val;\n\tint i;\n\n\tretval = lan743x_hs_syslock_acquire(adapter, LOCK_TIMEOUT_MAX_CNT);\n\tif (retval < 0)\n\t\treturn retval;\n\n\tretval = lan743x_hs_eeprom_cmd_cmplt_chk(adapter);\n\tlan743x_hs_syslock_release(adapter);\n\tif (retval < 0)\n\t\treturn retval;\n\n\tfor (i = 0; i < length; i++) {\n\t\tretval = lan743x_hs_syslock_acquire(adapter,\n\t\t\t\t\t\t    LOCK_TIMEOUT_MAX_CNT);\n\t\tif (retval < 0)\n\t\t\treturn retval;\n\n\t\tval = HS_E2P_CMD_EPC_BUSY_ | HS_E2P_CMD_EPC_CMD_READ_;\n\t\tval |= (offset & HS_E2P_CMD_EPC_ADDR_MASK_);\n\t\tlan743x_csr_write(adapter, HS_E2P_CMD, val);\n\t\tretval = lan743x_hs_eeprom_cmd_cmplt_chk(adapter);\n\t\tif (retval < 0) {\n\t\t\tlan743x_hs_syslock_release(adapter);\n\t\t\treturn retval;\n\t\t}\n\n\t\tval = lan743x_csr_read(adapter, HS_E2P_DATA);\n\n\t\tlan743x_hs_syslock_release(adapter);\n\n\t\tdata[i] = val & 0xFF;\n\t\toffset++;\n\t}\n\n\treturn 0;\n}\n\nstatic int lan743x_hs_eeprom_write(struct lan743x_adapter *adapter,\n\t\t\t\t   u32 offset, u32 length, u8 *data)\n{\n\tint retval;\n\tu32 val;\n\tint i;\n\n\tretval = lan743x_hs_syslock_acquire(adapter, LOCK_TIMEOUT_MAX_CNT);\n\tif (retval < 0)\n\t\treturn retval;\n\n\tretval = lan743x_hs_eeprom_cmd_cmplt_chk(adapter);\n\tlan743x_hs_syslock_release(adapter);\n\tif (retval < 0)\n\t\treturn retval;\n\n\tfor (i = 0; i < length; i++) {\n\t\tretval = lan743x_hs_syslock_acquire(adapter,\n\t\t\t\t\t\t    LOCK_TIMEOUT_MAX_CNT);\n\t\tif (retval < 0)\n\t\t\treturn retval;\n\n\t\t \n\t\tval = data[i];\n\t\tlan743x_csr_write(adapter, HS_E2P_DATA, val);\n\n\t\t \n\t\tval = HS_E2P_CMD_EPC_BUSY_ | HS_E2P_CMD_EPC_CMD_WRITE_;\n\t\tval |= (offset & HS_E2P_CMD_EPC_ADDR_MASK_);\n\t\tlan743x_csr_write(adapter, HS_E2P_CMD, val);\n\n\t\tretval = lan743x_hs_eeprom_cmd_cmplt_chk(adapter);\n\t\tlan743x_hs_syslock_release(adapter);\n\t\tif (retval < 0)\n\t\t\treturn retval;\n\n\t\toffset++;\n\t}\n\n\treturn 0;\n}\n\nstatic void lan743x_ethtool_get_drvinfo(struct net_device *netdev,\n\t\t\t\t\tstruct ethtool_drvinfo *info)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\tstrscpy(info->driver, DRIVER_NAME, sizeof(info->driver));\n\tstrscpy(info->bus_info,\n\t\tpci_name(adapter->pdev), sizeof(info->bus_info));\n}\n\nstatic u32 lan743x_ethtool_get_msglevel(struct net_device *netdev)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\treturn adapter->msg_enable;\n}\n\nstatic void lan743x_ethtool_set_msglevel(struct net_device *netdev,\n\t\t\t\t\t u32 msglevel)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\tadapter->msg_enable = msglevel;\n}\n\nstatic int lan743x_ethtool_get_eeprom_len(struct net_device *netdev)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\tif (adapter->flags & LAN743X_ADAPTER_FLAG_OTP)\n\t\treturn MAX_OTP_SIZE;\n\n\treturn MAX_EEPROM_SIZE;\n}\n\nstatic int lan743x_ethtool_get_eeprom(struct net_device *netdev,\n\t\t\t\t      struct ethtool_eeprom *ee, u8 *data)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\tint ret = 0;\n\n\tif (adapter->flags & LAN743X_ADAPTER_FLAG_OTP) {\n\t\tif (adapter->is_pci11x1x)\n\t\t\tret = lan743x_hs_otp_read(adapter, ee->offset,\n\t\t\t\t\t\t  ee->len, data);\n\t\telse\n\t\t\tret = lan743x_otp_read(adapter, ee->offset,\n\t\t\t\t\t       ee->len, data);\n\t} else {\n\t\tif (adapter->is_pci11x1x)\n\t\t\tret = lan743x_hs_eeprom_read(adapter, ee->offset,\n\t\t\t\t\t\t     ee->len, data);\n\t\telse\n\t\t\tret = lan743x_eeprom_read(adapter, ee->offset,\n\t\t\t\t\t\t  ee->len, data);\n\t}\n\n\treturn ret;\n}\n\nstatic int lan743x_ethtool_set_eeprom(struct net_device *netdev,\n\t\t\t\t      struct ethtool_eeprom *ee, u8 *data)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\tint ret = -EINVAL;\n\n\tif (adapter->flags & LAN743X_ADAPTER_FLAG_OTP) {\n\t\t \n\t\tif (ee->magic == LAN743X_OTP_MAGIC) {\n\t\t\tif (adapter->is_pci11x1x)\n\t\t\t\tret = lan743x_hs_otp_write(adapter, ee->offset,\n\t\t\t\t\t\t\t   ee->len, data);\n\t\t\telse\n\t\t\t\tret = lan743x_otp_write(adapter, ee->offset,\n\t\t\t\t\t\t\tee->len, data);\n\t\t}\n\t} else {\n\t\tif (ee->magic == LAN743X_EEPROM_MAGIC) {\n\t\t\tif (adapter->is_pci11x1x)\n\t\t\t\tret = lan743x_hs_eeprom_write(adapter,\n\t\t\t\t\t\t\t      ee->offset,\n\t\t\t\t\t\t\t      ee->len, data);\n\t\t\telse\n\t\t\t\tret = lan743x_eeprom_write(adapter, ee->offset,\n\t\t\t\t\t\t\t   ee->len, data);\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic const char lan743x_set0_hw_cnt_strings[][ETH_GSTRING_LEN] = {\n\t\"RX FCS Errors\",\n\t\"RX Alignment Errors\",\n\t\"Rx Fragment Errors\",\n\t\"RX Jabber Errors\",\n\t\"RX Undersize Frame Errors\",\n\t\"RX Oversize Frame Errors\",\n\t\"RX Dropped Frames\",\n\t\"RX Unicast Byte Count\",\n\t\"RX Broadcast Byte Count\",\n\t\"RX Multicast Byte Count\",\n\t\"RX Unicast Frames\",\n\t\"RX Broadcast Frames\",\n\t\"RX Multicast Frames\",\n\t\"RX Pause Frames\",\n\t\"RX 64 Byte Frames\",\n\t\"RX 65 - 127 Byte Frames\",\n\t\"RX 128 - 255 Byte Frames\",\n\t\"RX 256 - 511 Bytes Frames\",\n\t\"RX 512 - 1023 Byte Frames\",\n\t\"RX 1024 - 1518 Byte Frames\",\n\t\"RX Greater 1518 Byte Frames\",\n};\n\nstatic const char lan743x_set1_sw_cnt_strings[][ETH_GSTRING_LEN] = {\n\t\"RX Queue 0 Frames\",\n\t\"RX Queue 1 Frames\",\n\t\"RX Queue 2 Frames\",\n\t\"RX Queue 3 Frames\",\n};\n\nstatic const char lan743x_tx_queue_cnt_strings[][ETH_GSTRING_LEN] = {\n\t\"TX Queue 0 Frames\",\n\t\"TX Queue 1 Frames\",\n\t\"TX Queue 2 Frames\",\n\t\"TX Queue 3 Frames\",\n\t\"TX Total Queue Frames\",\n};\n\nstatic const char lan743x_set2_hw_cnt_strings[][ETH_GSTRING_LEN] = {\n\t\"RX Total Frames\",\n\t\"EEE RX LPI Transitions\",\n\t\"EEE RX LPI Time\",\n\t\"RX Counter Rollover Status\",\n\t\"TX FCS Errors\",\n\t\"TX Excess Deferral Errors\",\n\t\"TX Carrier Errors\",\n\t\"TX Bad Byte Count\",\n\t\"TX Single Collisions\",\n\t\"TX Multiple Collisions\",\n\t\"TX Excessive Collision\",\n\t\"TX Late Collisions\",\n\t\"TX Unicast Byte Count\",\n\t\"TX Broadcast Byte Count\",\n\t\"TX Multicast Byte Count\",\n\t\"TX Unicast Frames\",\n\t\"TX Broadcast Frames\",\n\t\"TX Multicast Frames\",\n\t\"TX Pause Frames\",\n\t\"TX 64 Byte Frames\",\n\t\"TX 65 - 127 Byte Frames\",\n\t\"TX 128 - 255 Byte Frames\",\n\t\"TX 256 - 511 Bytes Frames\",\n\t\"TX 512 - 1023 Byte Frames\",\n\t\"TX 1024 - 1518 Byte Frames\",\n\t\"TX Greater 1518 Byte Frames\",\n\t\"TX Total Frames\",\n\t\"EEE TX LPI Transitions\",\n\t\"EEE TX LPI Time\",\n\t\"TX Counter Rollover Status\",\n};\n\nstatic const u32 lan743x_set0_hw_cnt_addr[] = {\n\tSTAT_RX_FCS_ERRORS,\n\tSTAT_RX_ALIGNMENT_ERRORS,\n\tSTAT_RX_FRAGMENT_ERRORS,\n\tSTAT_RX_JABBER_ERRORS,\n\tSTAT_RX_UNDERSIZE_FRAME_ERRORS,\n\tSTAT_RX_OVERSIZE_FRAME_ERRORS,\n\tSTAT_RX_DROPPED_FRAMES,\n\tSTAT_RX_UNICAST_BYTE_COUNT,\n\tSTAT_RX_BROADCAST_BYTE_COUNT,\n\tSTAT_RX_MULTICAST_BYTE_COUNT,\n\tSTAT_RX_UNICAST_FRAMES,\n\tSTAT_RX_BROADCAST_FRAMES,\n\tSTAT_RX_MULTICAST_FRAMES,\n\tSTAT_RX_PAUSE_FRAMES,\n\tSTAT_RX_64_BYTE_FRAMES,\n\tSTAT_RX_65_127_BYTE_FRAMES,\n\tSTAT_RX_128_255_BYTE_FRAMES,\n\tSTAT_RX_256_511_BYTES_FRAMES,\n\tSTAT_RX_512_1023_BYTE_FRAMES,\n\tSTAT_RX_1024_1518_BYTE_FRAMES,\n\tSTAT_RX_GREATER_1518_BYTE_FRAMES,\n};\n\nstatic const u32 lan743x_set2_hw_cnt_addr[] = {\n\tSTAT_RX_TOTAL_FRAMES,\n\tSTAT_EEE_RX_LPI_TRANSITIONS,\n\tSTAT_EEE_RX_LPI_TIME,\n\tSTAT_RX_COUNTER_ROLLOVER_STATUS,\n\tSTAT_TX_FCS_ERRORS,\n\tSTAT_TX_EXCESS_DEFERRAL_ERRORS,\n\tSTAT_TX_CARRIER_ERRORS,\n\tSTAT_TX_BAD_BYTE_COUNT,\n\tSTAT_TX_SINGLE_COLLISIONS,\n\tSTAT_TX_MULTIPLE_COLLISIONS,\n\tSTAT_TX_EXCESSIVE_COLLISION,\n\tSTAT_TX_LATE_COLLISIONS,\n\tSTAT_TX_UNICAST_BYTE_COUNT,\n\tSTAT_TX_BROADCAST_BYTE_COUNT,\n\tSTAT_TX_MULTICAST_BYTE_COUNT,\n\tSTAT_TX_UNICAST_FRAMES,\n\tSTAT_TX_BROADCAST_FRAMES,\n\tSTAT_TX_MULTICAST_FRAMES,\n\tSTAT_TX_PAUSE_FRAMES,\n\tSTAT_TX_64_BYTE_FRAMES,\n\tSTAT_TX_65_127_BYTE_FRAMES,\n\tSTAT_TX_128_255_BYTE_FRAMES,\n\tSTAT_TX_256_511_BYTES_FRAMES,\n\tSTAT_TX_512_1023_BYTE_FRAMES,\n\tSTAT_TX_1024_1518_BYTE_FRAMES,\n\tSTAT_TX_GREATER_1518_BYTE_FRAMES,\n\tSTAT_TX_TOTAL_FRAMES,\n\tSTAT_EEE_TX_LPI_TRANSITIONS,\n\tSTAT_EEE_TX_LPI_TIME,\n\tSTAT_TX_COUNTER_ROLLOVER_STATUS\n};\n\nstatic const char lan743x_priv_flags_strings[][ETH_GSTRING_LEN] = {\n\t\"OTP_ACCESS\",\n};\n\nstatic void lan743x_ethtool_get_strings(struct net_device *netdev,\n\t\t\t\t\tu32 stringset, u8 *data)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\tswitch (stringset) {\n\tcase ETH_SS_STATS:\n\t\tmemcpy(data, lan743x_set0_hw_cnt_strings,\n\t\t       sizeof(lan743x_set0_hw_cnt_strings));\n\t\tmemcpy(&data[sizeof(lan743x_set0_hw_cnt_strings)],\n\t\t       lan743x_set1_sw_cnt_strings,\n\t\t       sizeof(lan743x_set1_sw_cnt_strings));\n\t\tmemcpy(&data[sizeof(lan743x_set0_hw_cnt_strings) +\n\t\t       sizeof(lan743x_set1_sw_cnt_strings)],\n\t\t       lan743x_set2_hw_cnt_strings,\n\t\t       sizeof(lan743x_set2_hw_cnt_strings));\n\t\tif (adapter->is_pci11x1x) {\n\t\t\tmemcpy(&data[sizeof(lan743x_set0_hw_cnt_strings) +\n\t\t\t       sizeof(lan743x_set1_sw_cnt_strings) +\n\t\t\t       sizeof(lan743x_set2_hw_cnt_strings)],\n\t\t\t       lan743x_tx_queue_cnt_strings,\n\t\t\t       sizeof(lan743x_tx_queue_cnt_strings));\n\t\t}\n\t\tbreak;\n\tcase ETH_SS_PRIV_FLAGS:\n\t\tmemcpy(data, lan743x_priv_flags_strings,\n\t\t       sizeof(lan743x_priv_flags_strings));\n\t\tbreak;\n\t}\n}\n\nstatic void lan743x_ethtool_get_ethtool_stats(struct net_device *netdev,\n\t\t\t\t\t      struct ethtool_stats *stats,\n\t\t\t\t\t      u64 *data)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\tu64 total_queue_count = 0;\n\tint data_index = 0;\n\tu64 pkt_cnt;\n\tu32 buf;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(lan743x_set0_hw_cnt_addr); i++) {\n\t\tbuf = lan743x_csr_read(adapter, lan743x_set0_hw_cnt_addr[i]);\n\t\tdata[data_index++] = (u64)buf;\n\t}\n\tfor (i = 0; i < ARRAY_SIZE(adapter->rx); i++)\n\t\tdata[data_index++] = (u64)(adapter->rx[i].frame_count);\n\tfor (i = 0; i < ARRAY_SIZE(lan743x_set2_hw_cnt_addr); i++) {\n\t\tbuf = lan743x_csr_read(adapter, lan743x_set2_hw_cnt_addr[i]);\n\t\tdata[data_index++] = (u64)buf;\n\t}\n\tif (adapter->is_pci11x1x) {\n\t\tfor (i = 0; i < ARRAY_SIZE(adapter->tx); i++) {\n\t\t\tpkt_cnt = (u64)(adapter->tx[i].frame_count);\n\t\t\tdata[data_index++] = pkt_cnt;\n\t\t\ttotal_queue_count += pkt_cnt;\n\t\t}\n\t\tdata[data_index++] = total_queue_count;\n\t}\n}\n\nstatic u32 lan743x_ethtool_get_priv_flags(struct net_device *netdev)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\treturn adapter->flags;\n}\n\nstatic int lan743x_ethtool_set_priv_flags(struct net_device *netdev, u32 flags)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\tadapter->flags = flags;\n\n\treturn 0;\n}\n\nstatic int lan743x_ethtool_get_sset_count(struct net_device *netdev, int sset)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\tswitch (sset) {\n\tcase ETH_SS_STATS:\n\t{\n\t\tint ret;\n\n\t\tret = ARRAY_SIZE(lan743x_set0_hw_cnt_strings);\n\t\tret += ARRAY_SIZE(lan743x_set1_sw_cnt_strings);\n\t\tret += ARRAY_SIZE(lan743x_set2_hw_cnt_strings);\n\t\tif (adapter->is_pci11x1x)\n\t\t\tret += ARRAY_SIZE(lan743x_tx_queue_cnt_strings);\n\t\treturn ret;\n\t}\n\tcase ETH_SS_PRIV_FLAGS:\n\t\treturn ARRAY_SIZE(lan743x_priv_flags_strings);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int lan743x_ethtool_get_rxnfc(struct net_device *netdev,\n\t\t\t\t     struct ethtool_rxnfc *rxnfc,\n\t\t\t\t     u32 *rule_locs)\n{\n\tswitch (rxnfc->cmd) {\n\tcase ETHTOOL_GRXFH:\n\t\trxnfc->data = 0;\n\t\tswitch (rxnfc->flow_type) {\n\t\tcase TCP_V4_FLOW:case UDP_V4_FLOW:\n\t\tcase TCP_V6_FLOW:case UDP_V6_FLOW:\n\t\t\trxnfc->data |= RXH_L4_B_0_1 | RXH_L4_B_2_3;\n\t\t\tfallthrough;\n\t\tcase IPV4_FLOW: case IPV6_FLOW:\n\t\t\trxnfc->data |= RXH_IP_SRC | RXH_IP_DST;\n\t\t\treturn 0;\n\t\t}\n\t\tbreak;\n\tcase ETHTOOL_GRXRINGS:\n\t\trxnfc->data = LAN743X_USED_RX_CHANNELS;\n\t\treturn 0;\n\t}\n\treturn -EOPNOTSUPP;\n}\n\nstatic u32 lan743x_ethtool_get_rxfh_key_size(struct net_device *netdev)\n{\n\treturn 40;\n}\n\nstatic u32 lan743x_ethtool_get_rxfh_indir_size(struct net_device *netdev)\n{\n\treturn 128;\n}\n\nstatic int lan743x_ethtool_get_rxfh(struct net_device *netdev,\n\t\t\t\t    u32 *indir, u8 *key, u8 *hfunc)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\tif (indir) {\n\t\tint dw_index;\n\t\tint byte_index = 0;\n\n\t\tfor (dw_index = 0; dw_index < 32; dw_index++) {\n\t\t\tu32 four_entries =\n\t\t\t\tlan743x_csr_read(adapter, RFE_INDX(dw_index));\n\n\t\t\tbyte_index = dw_index << 2;\n\t\t\tindir[byte_index + 0] =\n\t\t\t\t((four_entries >> 0) & 0x000000FF);\n\t\t\tindir[byte_index + 1] =\n\t\t\t\t((four_entries >> 8) & 0x000000FF);\n\t\t\tindir[byte_index + 2] =\n\t\t\t\t((four_entries >> 16) & 0x000000FF);\n\t\t\tindir[byte_index + 3] =\n\t\t\t\t((four_entries >> 24) & 0x000000FF);\n\t\t}\n\t}\n\tif (key) {\n\t\tint dword_index;\n\t\tint byte_index = 0;\n\n\t\tfor (dword_index = 0; dword_index < 10; dword_index++) {\n\t\t\tu32 four_entries =\n\t\t\t\tlan743x_csr_read(adapter,\n\t\t\t\t\t\t RFE_HASH_KEY(dword_index));\n\n\t\t\tbyte_index = dword_index << 2;\n\t\t\tkey[byte_index + 0] =\n\t\t\t\t((four_entries >> 0) & 0x000000FF);\n\t\t\tkey[byte_index + 1] =\n\t\t\t\t((four_entries >> 8) & 0x000000FF);\n\t\t\tkey[byte_index + 2] =\n\t\t\t\t((four_entries >> 16) & 0x000000FF);\n\t\t\tkey[byte_index + 3] =\n\t\t\t\t((four_entries >> 24) & 0x000000FF);\n\t\t}\n\t}\n\tif (hfunc)\n\t\t(*hfunc) = ETH_RSS_HASH_TOP;\n\treturn 0;\n}\n\nstatic int lan743x_ethtool_set_rxfh(struct net_device *netdev,\n\t\t\t\t    const u32 *indir, const u8 *key,\n\t\t\t\t    const u8 hfunc)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\tif (hfunc != ETH_RSS_HASH_NO_CHANGE && hfunc != ETH_RSS_HASH_TOP)\n\t\treturn -EOPNOTSUPP;\n\n\tif (indir) {\n\t\tu32 indir_value = 0;\n\t\tint dword_index = 0;\n\t\tint byte_index = 0;\n\n\t\tfor (dword_index = 0; dword_index < 32; dword_index++) {\n\t\t\tbyte_index = dword_index << 2;\n\t\t\tindir_value =\n\t\t\t\t(((indir[byte_index + 0] & 0x000000FF) << 0) |\n\t\t\t\t((indir[byte_index + 1] & 0x000000FF) << 8) |\n\t\t\t\t((indir[byte_index + 2] & 0x000000FF) << 16) |\n\t\t\t\t((indir[byte_index + 3] & 0x000000FF) << 24));\n\t\t\tlan743x_csr_write(adapter, RFE_INDX(dword_index),\n\t\t\t\t\t  indir_value);\n\t\t}\n\t}\n\tif (key) {\n\t\tint dword_index = 0;\n\t\tint byte_index = 0;\n\t\tu32 key_value = 0;\n\n\t\tfor (dword_index = 0; dword_index < 10; dword_index++) {\n\t\t\tbyte_index = dword_index << 2;\n\t\t\tkey_value =\n\t\t\t\t((((u32)(key[byte_index + 0])) << 0) |\n\t\t\t\t(((u32)(key[byte_index + 1])) << 8) |\n\t\t\t\t(((u32)(key[byte_index + 2])) << 16) |\n\t\t\t\t(((u32)(key[byte_index + 3])) << 24));\n\t\t\tlan743x_csr_write(adapter, RFE_HASH_KEY(dword_index),\n\t\t\t\t\t  key_value);\n\t\t}\n\t}\n\treturn 0;\n}\n\nstatic int lan743x_ethtool_get_ts_info(struct net_device *netdev,\n\t\t\t\t       struct ethtool_ts_info *ts_info)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\tts_info->so_timestamping = SOF_TIMESTAMPING_TX_SOFTWARE |\n\t\t\t\t   SOF_TIMESTAMPING_RX_SOFTWARE |\n\t\t\t\t   SOF_TIMESTAMPING_SOFTWARE |\n\t\t\t\t   SOF_TIMESTAMPING_TX_HARDWARE |\n\t\t\t\t   SOF_TIMESTAMPING_RX_HARDWARE |\n\t\t\t\t   SOF_TIMESTAMPING_RAW_HARDWARE;\n\n\tif (adapter->ptp.ptp_clock)\n\t\tts_info->phc_index = ptp_clock_index(adapter->ptp.ptp_clock);\n\telse\n\t\tts_info->phc_index = -1;\n\n\tts_info->tx_types = BIT(HWTSTAMP_TX_OFF) |\n\t\t\t    BIT(HWTSTAMP_TX_ON) |\n\t\t\t    BIT(HWTSTAMP_TX_ONESTEP_SYNC);\n\tts_info->rx_filters = BIT(HWTSTAMP_FILTER_NONE) |\n\t\t\t      BIT(HWTSTAMP_FILTER_ALL);\n\treturn 0;\n}\n\nstatic int lan743x_ethtool_get_eee(struct net_device *netdev,\n\t\t\t\t   struct ethtool_eee *eee)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\tstruct phy_device *phydev = netdev->phydev;\n\tu32 buf;\n\tint ret;\n\n\tif (!phydev)\n\t\treturn -EIO;\n\tif (!phydev->drv) {\n\t\tnetif_err(adapter, drv, adapter->netdev,\n\t\t\t  \"Missing PHY Driver\\n\");\n\t\treturn -EIO;\n\t}\n\n\tret = phy_ethtool_get_eee(phydev, eee);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tbuf = lan743x_csr_read(adapter, MAC_CR);\n\tif (buf & MAC_CR_EEE_EN_) {\n\t\teee->eee_enabled = true;\n\t\teee->eee_active = !!(eee->advertised & eee->lp_advertised);\n\t\teee->tx_lpi_enabled = true;\n\t\t \n\t\tbuf = lan743x_csr_read(adapter, MAC_EEE_TX_LPI_REQ_DLY_CNT);\n\t\teee->tx_lpi_timer = buf;\n\t} else {\n\t\teee->eee_enabled = false;\n\t\teee->eee_active = false;\n\t\teee->tx_lpi_enabled = false;\n\t\teee->tx_lpi_timer = 0;\n\t}\n\n\treturn 0;\n}\n\nstatic int lan743x_ethtool_set_eee(struct net_device *netdev,\n\t\t\t\t   struct ethtool_eee *eee)\n{\n\tstruct lan743x_adapter *adapter;\n\tstruct phy_device *phydev;\n\tu32 buf = 0;\n\tint ret = 0;\n\n\tif (!netdev)\n\t\treturn -EINVAL;\n\tadapter = netdev_priv(netdev);\n\tif (!adapter)\n\t\treturn -EINVAL;\n\tphydev = netdev->phydev;\n\tif (!phydev)\n\t\treturn -EIO;\n\tif (!phydev->drv) {\n\t\tnetif_err(adapter, drv, adapter->netdev,\n\t\t\t  \"Missing PHY Driver\\n\");\n\t\treturn -EIO;\n\t}\n\n\tif (eee->eee_enabled) {\n\t\tret = phy_init_eee(phydev, false);\n\t\tif (ret) {\n\t\t\tnetif_err(adapter, drv, adapter->netdev,\n\t\t\t\t  \"EEE initialization failed\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tbuf = (u32)eee->tx_lpi_timer;\n\t\tlan743x_csr_write(adapter, MAC_EEE_TX_LPI_REQ_DLY_CNT, buf);\n\n\t\tbuf = lan743x_csr_read(adapter, MAC_CR);\n\t\tbuf |= MAC_CR_EEE_EN_;\n\t\tlan743x_csr_write(adapter, MAC_CR, buf);\n\t} else {\n\t\tbuf = lan743x_csr_read(adapter, MAC_CR);\n\t\tbuf &= ~MAC_CR_EEE_EN_;\n\t\tlan743x_csr_write(adapter, MAC_CR, buf);\n\t}\n\n\treturn phy_ethtool_set_eee(phydev, eee);\n}\n\n#ifdef CONFIG_PM\nstatic void lan743x_ethtool_get_wol(struct net_device *netdev,\n\t\t\t\t    struct ethtool_wolinfo *wol)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\twol->supported = 0;\n\twol->wolopts = 0;\n\n\tif (netdev->phydev)\n\t\tphy_ethtool_get_wol(netdev->phydev, wol);\n\n\twol->supported |= WAKE_BCAST | WAKE_UCAST | WAKE_MCAST |\n\t\tWAKE_MAGIC | WAKE_PHY | WAKE_ARP;\n\n\tif (adapter->is_pci11x1x)\n\t\twol->supported |= WAKE_MAGICSECURE;\n\n\twol->wolopts |= adapter->wolopts;\n\tif (adapter->wolopts & WAKE_MAGICSECURE)\n\t\tmemcpy(wol->sopass, adapter->sopass, sizeof(wol->sopass));\n}\n\nstatic int lan743x_ethtool_set_wol(struct net_device *netdev,\n\t\t\t\t   struct ethtool_wolinfo *wol)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(netdev);\n\n\tadapter->wolopts = 0;\n\tif (wol->wolopts & WAKE_UCAST)\n\t\tadapter->wolopts |= WAKE_UCAST;\n\tif (wol->wolopts & WAKE_MCAST)\n\t\tadapter->wolopts |= WAKE_MCAST;\n\tif (wol->wolopts & WAKE_BCAST)\n\t\tadapter->wolopts |= WAKE_BCAST;\n\tif (wol->wolopts & WAKE_MAGIC)\n\t\tadapter->wolopts |= WAKE_MAGIC;\n\tif (wol->wolopts & WAKE_PHY)\n\t\tadapter->wolopts |= WAKE_PHY;\n\tif (wol->wolopts & WAKE_ARP)\n\t\tadapter->wolopts |= WAKE_ARP;\n\tif (wol->wolopts & WAKE_MAGICSECURE &&\n\t    wol->wolopts & WAKE_MAGIC) {\n\t\tmemcpy(adapter->sopass, wol->sopass, sizeof(wol->sopass));\n\t\tadapter->wolopts |= WAKE_MAGICSECURE;\n\t} else {\n\t\tmemset(adapter->sopass, 0, sizeof(u8) * SOPASS_MAX);\n\t}\n\n\tdevice_set_wakeup_enable(&adapter->pdev->dev, (bool)wol->wolopts);\n\n\treturn netdev->phydev ? phy_ethtool_set_wol(netdev->phydev, wol)\n\t\t\t: -ENETDOWN;\n}\n#endif  \n\nstatic void lan743x_common_regs(struct net_device *dev, void *p)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(dev);\n\tu32 *rb = p;\n\n\tmemset(p, 0, (MAX_LAN743X_ETH_COMMON_REGS * sizeof(u32)));\n\n\trb[ETH_PRIV_FLAGS] = adapter->flags;\n\trb[ETH_ID_REV]     = lan743x_csr_read(adapter, ID_REV);\n\trb[ETH_FPGA_REV]   = lan743x_csr_read(adapter, FPGA_REV);\n\trb[ETH_STRAP_READ] = lan743x_csr_read(adapter, STRAP_READ);\n\trb[ETH_INT_STS]    = lan743x_csr_read(adapter, INT_STS);\n\trb[ETH_HW_CFG]     = lan743x_csr_read(adapter, HW_CFG);\n\trb[ETH_PMT_CTL]    = lan743x_csr_read(adapter, PMT_CTL);\n\trb[ETH_E2P_CMD]    = lan743x_csr_read(adapter, E2P_CMD);\n\trb[ETH_E2P_DATA]   = lan743x_csr_read(adapter, E2P_DATA);\n\trb[ETH_MAC_CR]     = lan743x_csr_read(adapter, MAC_CR);\n\trb[ETH_MAC_RX]     = lan743x_csr_read(adapter, MAC_RX);\n\trb[ETH_MAC_TX]     = lan743x_csr_read(adapter, MAC_TX);\n\trb[ETH_FLOW]       = lan743x_csr_read(adapter, MAC_FLOW);\n\trb[ETH_MII_ACC]    = lan743x_csr_read(adapter, MAC_MII_ACC);\n\trb[ETH_MII_DATA]   = lan743x_csr_read(adapter, MAC_MII_DATA);\n\trb[ETH_EEE_TX_LPI_REQ_DLY]  = lan743x_csr_read(adapter,\n\t\t\t\t\t\t       MAC_EEE_TX_LPI_REQ_DLY_CNT);\n\trb[ETH_WUCSR]      = lan743x_csr_read(adapter, MAC_WUCSR);\n\trb[ETH_WK_SRC]     = lan743x_csr_read(adapter, MAC_WK_SRC);\n}\n\nstatic void lan743x_sgmii_regs(struct net_device *dev, void *p)\n{\n\tstruct lan743x_adapter *adp = netdev_priv(dev);\n\tu32 *rb = p;\n\tu16 idx;\n\tint val;\n\tstruct {\n\t\tu8 id;\n\t\tu8 dev;\n\t\tu16 addr;\n\t} regs[] = {\n\t\t{ ETH_SR_VSMMD_DEV_ID1,                MDIO_MMD_VEND1, 0x0002},\n\t\t{ ETH_SR_VSMMD_DEV_ID2,                MDIO_MMD_VEND1, 0x0003},\n\t\t{ ETH_SR_VSMMD_PCS_ID1,                MDIO_MMD_VEND1, 0x0004},\n\t\t{ ETH_SR_VSMMD_PCS_ID2,                MDIO_MMD_VEND1, 0x0005},\n\t\t{ ETH_SR_VSMMD_STS,                    MDIO_MMD_VEND1, 0x0008},\n\t\t{ ETH_SR_VSMMD_CTRL,                   MDIO_MMD_VEND1, 0x0009},\n\t\t{ ETH_SR_MII_CTRL,                     MDIO_MMD_VEND2, 0x0000},\n\t\t{ ETH_SR_MII_STS,                      MDIO_MMD_VEND2, 0x0001},\n\t\t{ ETH_SR_MII_DEV_ID1,                  MDIO_MMD_VEND2, 0x0002},\n\t\t{ ETH_SR_MII_DEV_ID2,                  MDIO_MMD_VEND2, 0x0003},\n\t\t{ ETH_SR_MII_AN_ADV,                   MDIO_MMD_VEND2, 0x0004},\n\t\t{ ETH_SR_MII_LP_BABL,                  MDIO_MMD_VEND2, 0x0005},\n\t\t{ ETH_SR_MII_EXPN,                     MDIO_MMD_VEND2, 0x0006},\n\t\t{ ETH_SR_MII_EXT_STS,                  MDIO_MMD_VEND2, 0x000F},\n\t\t{ ETH_SR_MII_TIME_SYNC_ABL,            MDIO_MMD_VEND2, 0x0708},\n\t\t{ ETH_SR_MII_TIME_SYNC_TX_MAX_DLY_LWR, MDIO_MMD_VEND2, 0x0709},\n\t\t{ ETH_SR_MII_TIME_SYNC_TX_MAX_DLY_UPR, MDIO_MMD_VEND2, 0x070A},\n\t\t{ ETH_SR_MII_TIME_SYNC_TX_MIN_DLY_LWR, MDIO_MMD_VEND2, 0x070B},\n\t\t{ ETH_SR_MII_TIME_SYNC_TX_MIN_DLY_UPR, MDIO_MMD_VEND2, 0x070C},\n\t\t{ ETH_SR_MII_TIME_SYNC_RX_MAX_DLY_LWR, MDIO_MMD_VEND2, 0x070D},\n\t\t{ ETH_SR_MII_TIME_SYNC_RX_MAX_DLY_UPR, MDIO_MMD_VEND2, 0x070E},\n\t\t{ ETH_SR_MII_TIME_SYNC_RX_MIN_DLY_LWR, MDIO_MMD_VEND2, 0x070F},\n\t\t{ ETH_SR_MII_TIME_SYNC_RX_MIN_DLY_UPR, MDIO_MMD_VEND2, 0x0710},\n\t\t{ ETH_VR_MII_DIG_CTRL1,                MDIO_MMD_VEND2, 0x8000},\n\t\t{ ETH_VR_MII_AN_CTRL,                  MDIO_MMD_VEND2, 0x8001},\n\t\t{ ETH_VR_MII_AN_INTR_STS,              MDIO_MMD_VEND2, 0x8002},\n\t\t{ ETH_VR_MII_TC,                       MDIO_MMD_VEND2, 0x8003},\n\t\t{ ETH_VR_MII_DBG_CTRL,                 MDIO_MMD_VEND2, 0x8005},\n\t\t{ ETH_VR_MII_EEE_MCTRL0,               MDIO_MMD_VEND2, 0x8006},\n\t\t{ ETH_VR_MII_EEE_TXTIMER,              MDIO_MMD_VEND2, 0x8008},\n\t\t{ ETH_VR_MII_EEE_RXTIMER,              MDIO_MMD_VEND2, 0x8009},\n\t\t{ ETH_VR_MII_LINK_TIMER_CTRL,          MDIO_MMD_VEND2, 0x800A},\n\t\t{ ETH_VR_MII_EEE_MCTRL1,               MDIO_MMD_VEND2, 0x800B},\n\t\t{ ETH_VR_MII_DIG_STS,                  MDIO_MMD_VEND2, 0x8010},\n\t\t{ ETH_VR_MII_ICG_ERRCNT1,              MDIO_MMD_VEND2, 0x8011},\n\t\t{ ETH_VR_MII_GPIO,                     MDIO_MMD_VEND2, 0x8015},\n\t\t{ ETH_VR_MII_EEE_LPI_STATUS,           MDIO_MMD_VEND2, 0x8016},\n\t\t{ ETH_VR_MII_EEE_WKERR,                MDIO_MMD_VEND2, 0x8017},\n\t\t{ ETH_VR_MII_MISC_STS,                 MDIO_MMD_VEND2, 0x8018},\n\t\t{ ETH_VR_MII_RX_LSTS,                  MDIO_MMD_VEND2, 0x8020},\n\t\t{ ETH_VR_MII_GEN2_GEN4_TX_BSTCTRL0,    MDIO_MMD_VEND2, 0x8038},\n\t\t{ ETH_VR_MII_GEN2_GEN4_TX_LVLCTRL0,    MDIO_MMD_VEND2, 0x803A},\n\t\t{ ETH_VR_MII_GEN2_GEN4_TXGENCTRL0,     MDIO_MMD_VEND2, 0x803C},\n\t\t{ ETH_VR_MII_GEN2_GEN4_TXGENCTRL1,     MDIO_MMD_VEND2, 0x803D},\n\t\t{ ETH_VR_MII_GEN4_TXGENCTRL2,          MDIO_MMD_VEND2, 0x803E},\n\t\t{ ETH_VR_MII_GEN2_GEN4_TX_STS,         MDIO_MMD_VEND2, 0x8048},\n\t\t{ ETH_VR_MII_GEN2_GEN4_RXGENCTRL0,     MDIO_MMD_VEND2, 0x8058},\n\t\t{ ETH_VR_MII_GEN2_GEN4_RXGENCTRL1,     MDIO_MMD_VEND2, 0x8059},\n\t\t{ ETH_VR_MII_GEN4_RXEQ_CTRL,           MDIO_MMD_VEND2, 0x805B},\n\t\t{ ETH_VR_MII_GEN4_RXLOS_CTRL0,         MDIO_MMD_VEND2, 0x805D},\n\t\t{ ETH_VR_MII_GEN2_GEN4_MPLL_CTRL0,     MDIO_MMD_VEND2, 0x8078},\n\t\t{ ETH_VR_MII_GEN2_GEN4_MPLL_CTRL1,     MDIO_MMD_VEND2, 0x8079},\n\t\t{ ETH_VR_MII_GEN2_GEN4_MPLL_STS,       MDIO_MMD_VEND2, 0x8088},\n\t\t{ ETH_VR_MII_GEN2_GEN4_LVL_CTRL,       MDIO_MMD_VEND2, 0x8090},\n\t\t{ ETH_VR_MII_GEN4_MISC_CTRL2,          MDIO_MMD_VEND2, 0x8093},\n\t\t{ ETH_VR_MII_GEN2_GEN4_MISC_CTRL0,     MDIO_MMD_VEND2, 0x8099},\n\t\t{ ETH_VR_MII_GEN2_GEN4_MISC_CTRL1,     MDIO_MMD_VEND2, 0x809A},\n\t\t{ ETH_VR_MII_SNPS_CR_CTRL,             MDIO_MMD_VEND2, 0x80A0},\n\t\t{ ETH_VR_MII_SNPS_CR_ADDR,             MDIO_MMD_VEND2, 0x80A1},\n\t\t{ ETH_VR_MII_SNPS_CR_DATA,             MDIO_MMD_VEND2, 0x80A2},\n\t\t{ ETH_VR_MII_DIG_CTRL2,                MDIO_MMD_VEND2, 0x80E1},\n\t\t{ ETH_VR_MII_DIG_ERRCNT,               MDIO_MMD_VEND2, 0x80E2},\n\t};\n\n\tfor (idx = 0; idx < ARRAY_SIZE(regs); idx++) {\n\t\tval = lan743x_sgmii_read(adp, regs[idx].dev, regs[idx].addr);\n\t\tif (val < 0)\n\t\t\trb[regs[idx].id] = 0xFFFF;\n\t\telse\n\t\t\trb[regs[idx].id] = val;\n\t}\n}\n\nstatic int lan743x_get_regs_len(struct net_device *dev)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(dev);\n\tu32 num_regs = MAX_LAN743X_ETH_COMMON_REGS;\n\n\tif (adapter->is_sgmii_en)\n\t\tnum_regs += MAX_LAN743X_ETH_SGMII_REGS;\n\n\treturn num_regs * sizeof(u32);\n}\n\nstatic void lan743x_get_regs(struct net_device *dev,\n\t\t\t     struct ethtool_regs *regs, void *p)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(dev);\n\tint regs_len;\n\n\tregs_len = lan743x_get_regs_len(dev);\n\tmemset(p, 0, regs_len);\n\n\tregs->version = LAN743X_ETH_REG_VERSION;\n\tregs->len = regs_len;\n\n\tlan743x_common_regs(dev, p);\n\tp = (u32 *)p + MAX_LAN743X_ETH_COMMON_REGS;\n\n\tif (adapter->is_sgmii_en) {\n\t\tlan743x_sgmii_regs(dev, p);\n\t\tp = (u32 *)p + MAX_LAN743X_ETH_SGMII_REGS;\n\t}\n}\n\nstatic void lan743x_get_pauseparam(struct net_device *dev,\n\t\t\t\t   struct ethtool_pauseparam *pause)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(dev);\n\tstruct lan743x_phy *phy = &adapter->phy;\n\n\tif (phy->fc_request_control & FLOW_CTRL_TX)\n\t\tpause->tx_pause = 1;\n\tif (phy->fc_request_control & FLOW_CTRL_RX)\n\t\tpause->rx_pause = 1;\n\tpause->autoneg = phy->fc_autoneg;\n}\n\nstatic int lan743x_set_pauseparam(struct net_device *dev,\n\t\t\t\t  struct ethtool_pauseparam *pause)\n{\n\tstruct lan743x_adapter *adapter = netdev_priv(dev);\n\tstruct phy_device *phydev = dev->phydev;\n\tstruct lan743x_phy *phy = &adapter->phy;\n\n\tif (!phydev)\n\t\treturn -ENODEV;\n\n\tif (!phy_validate_pause(phydev, pause))\n\t\treturn -EINVAL;\n\n\tphy->fc_request_control = 0;\n\tif (pause->rx_pause)\n\t\tphy->fc_request_control |= FLOW_CTRL_RX;\n\n\tif (pause->tx_pause)\n\t\tphy->fc_request_control |= FLOW_CTRL_TX;\n\n\tphy->fc_autoneg = pause->autoneg;\n\n\tif (pause->autoneg == AUTONEG_DISABLE)\n\t\tlan743x_mac_flow_ctrl_set_enables(adapter, pause->tx_pause,\n\t\t\t\t\t\t  pause->rx_pause);\n\telse\n\t\tphy_set_asym_pause(phydev, pause->rx_pause,  pause->tx_pause);\n\n\treturn 0;\n}\n\nconst struct ethtool_ops lan743x_ethtool_ops = {\n\t.get_drvinfo = lan743x_ethtool_get_drvinfo,\n\t.get_msglevel = lan743x_ethtool_get_msglevel,\n\t.set_msglevel = lan743x_ethtool_set_msglevel,\n\t.get_link = ethtool_op_get_link,\n\n\t.get_eeprom_len = lan743x_ethtool_get_eeprom_len,\n\t.get_eeprom = lan743x_ethtool_get_eeprom,\n\t.set_eeprom = lan743x_ethtool_set_eeprom,\n\t.get_strings = lan743x_ethtool_get_strings,\n\t.get_ethtool_stats = lan743x_ethtool_get_ethtool_stats,\n\t.get_priv_flags = lan743x_ethtool_get_priv_flags,\n\t.set_priv_flags = lan743x_ethtool_set_priv_flags,\n\t.get_sset_count = lan743x_ethtool_get_sset_count,\n\t.get_rxnfc = lan743x_ethtool_get_rxnfc,\n\t.get_rxfh_key_size = lan743x_ethtool_get_rxfh_key_size,\n\t.get_rxfh_indir_size = lan743x_ethtool_get_rxfh_indir_size,\n\t.get_rxfh = lan743x_ethtool_get_rxfh,\n\t.set_rxfh = lan743x_ethtool_set_rxfh,\n\t.get_ts_info = lan743x_ethtool_get_ts_info,\n\t.get_eee = lan743x_ethtool_get_eee,\n\t.set_eee = lan743x_ethtool_set_eee,\n\t.get_link_ksettings = phy_ethtool_get_link_ksettings,\n\t.set_link_ksettings = phy_ethtool_set_link_ksettings,\n\t.get_regs_len = lan743x_get_regs_len,\n\t.get_regs = lan743x_get_regs,\n\t.get_pauseparam = lan743x_get_pauseparam,\n\t.set_pauseparam = lan743x_set_pauseparam,\n#ifdef CONFIG_PM\n\t.get_wol = lan743x_ethtool_get_wol,\n\t.set_wol = lan743x_ethtool_set_wol,\n#endif\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}