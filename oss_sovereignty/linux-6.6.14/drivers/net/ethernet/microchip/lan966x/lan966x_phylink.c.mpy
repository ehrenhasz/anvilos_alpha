{
  "module_name": "lan966x_phylink.c",
  "hash_id": "fd2c261bfacf647ca91080e298f96da1e850f2e0fe497b3812cb6fdac50c032c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/lan966x/lan966x_phylink.c",
  "human_readable_source": "\n\n#include <linux/module.h>\n#include <linux/phylink.h>\n#include <linux/device.h>\n#include <linux/netdevice.h>\n#include <linux/phy/phy.h>\n\n#include \"lan966x_main.h\"\n\nstatic struct phylink_pcs *lan966x_phylink_mac_select(struct phylink_config *config,\n\t\t\t\t\t\t      phy_interface_t interface)\n{\n\tstruct lan966x_port *port = netdev_priv(to_net_dev(config->dev));\n\n\treturn &port->phylink_pcs;\n}\n\nstatic void lan966x_phylink_mac_config(struct phylink_config *config,\n\t\t\t\t       unsigned int mode,\n\t\t\t\t       const struct phylink_link_state *state)\n{\n}\n\nstatic int lan966x_phylink_mac_prepare(struct phylink_config *config,\n\t\t\t\t       unsigned int mode,\n\t\t\t\t       phy_interface_t iface)\n{\n\tstruct lan966x_port *port = netdev_priv(to_net_dev(config->dev));\n\tphy_interface_t serdes_mode = iface;\n\tint err;\n\n\tif (port->serdes) {\n\t\terr = phy_set_mode_ext(port->serdes, PHY_MODE_ETHERNET,\n\t\t\t\t       serdes_mode);\n\t\tif (err) {\n\t\t\tnetdev_err(to_net_dev(config->dev),\n\t\t\t\t   \"Could not set mode of SerDes\\n\");\n\t\t\treturn err;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic void lan966x_phylink_mac_link_up(struct phylink_config *config,\n\t\t\t\t\tstruct phy_device *phy,\n\t\t\t\t\tunsigned int mode,\n\t\t\t\t\tphy_interface_t interface,\n\t\t\t\t\tint speed, int duplex,\n\t\t\t\t\tbool tx_pause, bool rx_pause)\n{\n\tstruct lan966x_port *port = netdev_priv(to_net_dev(config->dev));\n\tstruct lan966x_port_config *port_config = &port->config;\n\n\tport_config->duplex = duplex;\n\tport_config->speed = speed;\n\tport_config->pause = 0;\n\tport_config->pause |= tx_pause ? MLO_PAUSE_TX : 0;\n\tport_config->pause |= rx_pause ? MLO_PAUSE_RX : 0;\n\n\tif (phy_interface_mode_is_rgmii(interface))\n\t\tphy_set_speed(port->serdes, speed);\n\n\tlan966x_port_config_up(port);\n}\n\nstatic void lan966x_phylink_mac_link_down(struct phylink_config *config,\n\t\t\t\t\t  unsigned int mode,\n\t\t\t\t\t  phy_interface_t interface)\n{\n\tstruct lan966x_port *port = netdev_priv(to_net_dev(config->dev));\n\tstruct lan966x *lan966x = port->lan966x;\n\n\tlan966x_port_config_down(port);\n\n\t \n\tlan_rmw(DEV_CLOCK_CFG_PCS_RX_RST_SET(0) |\n\t\tDEV_CLOCK_CFG_PCS_TX_RST_SET(0),\n\t\tDEV_CLOCK_CFG_PCS_RX_RST |\n\t\tDEV_CLOCK_CFG_PCS_TX_RST,\n\t\tlan966x, DEV_CLOCK_CFG(port->chip_port));\n}\n\nstatic struct lan966x_port *lan966x_pcs_to_port(struct phylink_pcs *pcs)\n{\n\treturn container_of(pcs, struct lan966x_port, phylink_pcs);\n}\n\nstatic void lan966x_pcs_get_state(struct phylink_pcs *pcs,\n\t\t\t\t  struct phylink_link_state *state)\n{\n\tstruct lan966x_port *port = lan966x_pcs_to_port(pcs);\n\n\tlan966x_port_status_get(port, state);\n}\n\nstatic int lan966x_pcs_config(struct phylink_pcs *pcs, unsigned int neg_mode,\n\t\t\t      phy_interface_t interface,\n\t\t\t      const unsigned long *advertising,\n\t\t\t      bool permit_pause_to_mac)\n{\n\tstruct lan966x_port *port = lan966x_pcs_to_port(pcs);\n\tstruct lan966x_port_config config;\n\tint ret;\n\n\tconfig = port->config;\n\tconfig.portmode = interface;\n\tconfig.inband = neg_mode & PHYLINK_PCS_NEG_INBAND;\n\tconfig.autoneg = neg_mode == PHYLINK_PCS_NEG_INBAND_ENABLED;\n\tconfig.advertising = advertising;\n\n\tret = lan966x_port_pcs_set(port, &config);\n\tif (ret)\n\t\tnetdev_err(port->dev, \"port PCS config failed: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic void lan966x_pcs_aneg_restart(struct phylink_pcs *pcs)\n{\n\t \n}\n\nconst struct phylink_mac_ops lan966x_phylink_mac_ops = {\n\t.mac_select_pcs = lan966x_phylink_mac_select,\n\t.mac_config = lan966x_phylink_mac_config,\n\t.mac_prepare = lan966x_phylink_mac_prepare,\n\t.mac_link_down = lan966x_phylink_mac_link_down,\n\t.mac_link_up = lan966x_phylink_mac_link_up,\n};\n\nconst struct phylink_pcs_ops lan966x_phylink_pcs_ops = {\n\t.pcs_get_state = lan966x_pcs_get_state,\n\t.pcs_config = lan966x_pcs_config,\n\t.pcs_an_restart = lan966x_pcs_aneg_restart,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}