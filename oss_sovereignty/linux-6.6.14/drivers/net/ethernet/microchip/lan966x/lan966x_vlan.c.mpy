{
  "module_name": "lan966x_vlan.c",
  "hash_id": "671ca87191bff46b6188602283b828adda1cd2f7f345dd1ddfa2a7170a1d7f7e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/lan966x/lan966x_vlan.c",
  "human_readable_source": "\n\n#include \"lan966x_main.h\"\n\n#define VLANACCESS_CMD_IDLE\t\t0\n#define VLANACCESS_CMD_READ\t\t1\n#define VLANACCESS_CMD_WRITE\t\t2\n#define VLANACCESS_CMD_INIT\t\t3\n\nstatic int lan966x_vlan_get_status(struct lan966x *lan966x)\n{\n\treturn lan_rd(lan966x, ANA_VLANACCESS);\n}\n\nstatic int lan966x_vlan_wait_for_completion(struct lan966x *lan966x)\n{\n\tu32 val;\n\n\treturn readx_poll_timeout(lan966x_vlan_get_status,\n\t\tlan966x, val,\n\t\t(val & ANA_VLANACCESS_VLAN_TBL_CMD) ==\n\t\tVLANACCESS_CMD_IDLE,\n\t\tTABLE_UPDATE_SLEEP_US, TABLE_UPDATE_TIMEOUT_US);\n}\n\nstatic void lan966x_vlan_set_mask(struct lan966x *lan966x, u16 vid)\n{\n\tu16 mask = lan966x->vlan_mask[vid];\n\tbool cpu_dis;\n\n\tcpu_dis = !(mask & BIT(CPU_PORT));\n\n\t \n\tlan_rmw(ANA_VLANTIDX_VLAN_PGID_CPU_DIS_SET(cpu_dis) |\n\t\tANA_VLANTIDX_V_INDEX_SET(vid),\n\t\tANA_VLANTIDX_VLAN_PGID_CPU_DIS |\n\t\tANA_VLANTIDX_V_INDEX,\n\t\tlan966x, ANA_VLANTIDX);\n\n\t \n\tlan_rmw(ANA_VLAN_PORT_MASK_VLAN_PORT_MASK_SET(mask),\n\t\tANA_VLAN_PORT_MASK_VLAN_PORT_MASK,\n\t\tlan966x, ANA_VLAN_PORT_MASK);\n\n\t \n\tlan_rmw(ANA_VLANACCESS_VLAN_TBL_CMD_SET(VLANACCESS_CMD_WRITE),\n\t\tANA_VLANACCESS_VLAN_TBL_CMD,\n\t\tlan966x, ANA_VLANACCESS);\n\n\tif (lan966x_vlan_wait_for_completion(lan966x))\n\t\tdev_err(lan966x->dev, \"Vlan set mask failed\\n\");\n}\n\nstatic void lan966x_vlan_port_add_vlan_mask(struct lan966x_port *port, u16 vid)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tu8 p = port->chip_port;\n\n\tlan966x->vlan_mask[vid] |= BIT(p);\n\tlan966x_vlan_set_mask(lan966x, vid);\n}\n\nstatic void lan966x_vlan_port_del_vlan_mask(struct lan966x_port *port, u16 vid)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tu8 p = port->chip_port;\n\n\tlan966x->vlan_mask[vid] &= ~BIT(p);\n\tlan966x_vlan_set_mask(lan966x, vid);\n}\n\nstatic bool lan966x_vlan_port_any_vlan_mask(struct lan966x *lan966x, u16 vid)\n{\n\treturn !!(lan966x->vlan_mask[vid] & ~BIT(CPU_PORT));\n}\n\nstatic void lan966x_vlan_cpu_add_vlan_mask(struct lan966x *lan966x, u16 vid)\n{\n\tlan966x->vlan_mask[vid] |= BIT(CPU_PORT);\n\tlan966x_vlan_set_mask(lan966x, vid);\n}\n\nstatic void lan966x_vlan_cpu_del_vlan_mask(struct lan966x *lan966x, u16 vid)\n{\n\tlan966x->vlan_mask[vid] &= ~BIT(CPU_PORT);\n\tlan966x_vlan_set_mask(lan966x, vid);\n}\n\nstatic void lan966x_vlan_cpu_add_cpu_vlan_mask(struct lan966x *lan966x, u16 vid)\n{\n\t__set_bit(vid, lan966x->cpu_vlan_mask);\n}\n\nstatic void lan966x_vlan_cpu_del_cpu_vlan_mask(struct lan966x *lan966x, u16 vid)\n{\n\t__clear_bit(vid, lan966x->cpu_vlan_mask);\n}\n\nbool lan966x_vlan_cpu_member_cpu_vlan_mask(struct lan966x *lan966x, u16 vid)\n{\n\treturn test_bit(vid, lan966x->cpu_vlan_mask);\n}\n\nstatic u16 lan966x_vlan_port_get_pvid(struct lan966x_port *port)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\n\tif (!(lan966x->bridge_mask & BIT(port->chip_port)))\n\t\treturn HOST_PVID;\n\n\treturn port->vlan_aware ? port->pvid : UNAWARE_PVID;\n}\n\nint lan966x_vlan_port_set_vid(struct lan966x_port *port, u16 vid,\n\t\t\t      bool pvid, bool untagged)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\n\t \n\tif (untagged && port->vid != vid) {\n\t\tif (port->vid) {\n\t\t\tdev_err(lan966x->dev,\n\t\t\t\t\"Port already has a native VLAN: %d\\n\",\n\t\t\t\tport->vid);\n\t\t\treturn -EBUSY;\n\t\t}\n\t\tport->vid = vid;\n\t}\n\n\t \n\tif (pvid)\n\t\tport->pvid = vid;\n\n\treturn 0;\n}\n\nstatic void lan966x_vlan_port_remove_vid(struct lan966x_port *port, u16 vid)\n{\n\tif (port->pvid == vid)\n\t\tport->pvid = 0;\n\n\tif (port->vid == vid)\n\t\tport->vid = 0;\n}\n\nvoid lan966x_vlan_port_set_vlan_aware(struct lan966x_port *port,\n\t\t\t\t      bool vlan_aware)\n{\n\tport->vlan_aware = vlan_aware;\n}\n\nvoid lan966x_vlan_port_apply(struct lan966x_port *port)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tu16 pvid;\n\tu32 val;\n\n\tpvid = lan966x_vlan_port_get_pvid(port);\n\n\t \n\t \n\tval = ANA_VLAN_CFG_VLAN_VID_SET(pvid);\n\tif (port->vlan_aware)\n\t\tval |= ANA_VLAN_CFG_VLAN_AWARE_ENA_SET(1) |\n\t\t       ANA_VLAN_CFG_VLAN_POP_CNT_SET(1);\n\n\tlan_rmw(val,\n\t\tANA_VLAN_CFG_VLAN_VID | ANA_VLAN_CFG_VLAN_AWARE_ENA |\n\t\tANA_VLAN_CFG_VLAN_POP_CNT,\n\t\tlan966x, ANA_VLAN_CFG(port->chip_port));\n\n\tlan_rmw(DEV_MAC_TAGS_CFG_VLAN_AWR_ENA_SET(port->vlan_aware) |\n\t\tDEV_MAC_TAGS_CFG_VLAN_DBL_AWR_ENA_SET(port->vlan_aware),\n\t\tDEV_MAC_TAGS_CFG_VLAN_AWR_ENA |\n\t\tDEV_MAC_TAGS_CFG_VLAN_DBL_AWR_ENA,\n\t\tlan966x, DEV_MAC_TAGS_CFG(port->chip_port));\n\n\t \n\tval = ANA_DROP_CFG_DROP_MC_SMAC_ENA_SET(1);\n\tif (port->vlan_aware && !pvid)\n\t\t \n\t\tval |= ANA_DROP_CFG_DROP_UNTAGGED_ENA_SET(1) |\n\t\t       ANA_DROP_CFG_DROP_PRIO_S_TAGGED_ENA_SET(1) |\n\t\t       ANA_DROP_CFG_DROP_PRIO_C_TAGGED_ENA_SET(1);\n\n\tlan_wr(val, lan966x, ANA_DROP_CFG(port->chip_port));\n\n\t \n\tval = REW_TAG_CFG_TAG_TPID_CFG_SET(0);\n\tif (port->vlan_aware) {\n\t\tif (port->vid)\n\t\t\t \n\t\t\tval |= REW_TAG_CFG_TAG_CFG_SET(1);\n\t\telse\n\t\t\tval |= REW_TAG_CFG_TAG_CFG_SET(3);\n\t}\n\n\t \n\tlan_rmw(val,\n\t\tREW_TAG_CFG_TAG_TPID_CFG | REW_TAG_CFG_TAG_CFG,\n\t\tlan966x, REW_TAG_CFG(port->chip_port));\n\n\t \n\tlan_rmw(REW_PORT_VLAN_CFG_PORT_TPID_SET(ETH_P_8021Q) |\n\t\tREW_PORT_VLAN_CFG_PORT_VID_SET(port->vid),\n\t\tREW_PORT_VLAN_CFG_PORT_TPID |\n\t\tREW_PORT_VLAN_CFG_PORT_VID,\n\t\tlan966x, REW_PORT_VLAN_CFG(port->chip_port));\n}\n\nvoid lan966x_vlan_port_add_vlan(struct lan966x_port *port,\n\t\t\t\tu16 vid,\n\t\t\t\tbool pvid,\n\t\t\t\tbool untagged)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\n\t \n\tif (lan966x_vlan_cpu_member_cpu_vlan_mask(lan966x, vid)) {\n\t\tlan966x_vlan_cpu_add_vlan_mask(lan966x, vid);\n\t\tlan966x_fdb_write_entries(lan966x, vid);\n\t\tlan966x_mdb_write_entries(lan966x, vid);\n\t}\n\n\tlan966x_vlan_port_set_vid(port, vid, pvid, untagged);\n\tlan966x_vlan_port_add_vlan_mask(port, vid);\n\tlan966x_vlan_port_apply(port);\n}\n\nvoid lan966x_vlan_port_del_vlan(struct lan966x_port *port, u16 vid)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\n\tlan966x_vlan_port_remove_vid(port, vid);\n\tlan966x_vlan_port_del_vlan_mask(port, vid);\n\tlan966x_vlan_port_apply(port);\n\n\t \n\tif (!lan966x_vlan_port_any_vlan_mask(lan966x, vid)) {\n\t\tlan966x_vlan_cpu_del_vlan_mask(lan966x, vid);\n\t\tlan966x_fdb_erase_entries(lan966x, vid);\n\t\tlan966x_mdb_erase_entries(lan966x, vid);\n\t}\n}\n\nvoid lan966x_vlan_cpu_add_vlan(struct lan966x *lan966x, u16 vid)\n{\n\t \n\tif (lan966x_vlan_port_any_vlan_mask(lan966x, vid)) {\n\t\tlan966x_vlan_cpu_add_vlan_mask(lan966x, vid);\n\t\tlan966x_mdb_write_entries(lan966x, vid);\n\t}\n\n\tlan966x_vlan_cpu_add_cpu_vlan_mask(lan966x, vid);\n\tlan966x_fdb_write_entries(lan966x, vid);\n}\n\nvoid lan966x_vlan_cpu_del_vlan(struct lan966x *lan966x, u16 vid)\n{\n\t \n\tlan966x_vlan_cpu_del_cpu_vlan_mask(lan966x, vid);\n\tlan966x_vlan_cpu_del_vlan_mask(lan966x, vid);\n\tlan966x_fdb_erase_entries(lan966x, vid);\n\tlan966x_mdb_erase_entries(lan966x, vid);\n}\n\nvoid lan966x_vlan_init(struct lan966x *lan966x)\n{\n\tu16 port, vid;\n\n\t \n\tlan_rmw(ANA_VLANACCESS_VLAN_TBL_CMD_SET(VLANACCESS_CMD_INIT),\n\t\tANA_VLANACCESS_VLAN_TBL_CMD,\n\t\tlan966x, ANA_VLANACCESS);\n\tlan966x_vlan_wait_for_completion(lan966x);\n\n\tfor (vid = 1; vid < VLAN_N_VID; vid++) {\n\t\tlan966x->vlan_mask[vid] = 0;\n\t\tlan966x_vlan_set_mask(lan966x, vid);\n\t}\n\n\t \n\tlan966x->vlan_mask[HOST_PVID] =\n\t\tGENMASK(lan966x->num_phys_ports - 1, 0) | BIT(CPU_PORT);\n\tlan966x_vlan_set_mask(lan966x, HOST_PVID);\n\n\tlan966x->vlan_mask[UNAWARE_PVID] =\n\t\tGENMASK(lan966x->num_phys_ports - 1, 0) | BIT(CPU_PORT);\n\tlan966x_vlan_set_mask(lan966x, UNAWARE_PVID);\n\n\tlan966x_vlan_cpu_add_cpu_vlan_mask(lan966x, UNAWARE_PVID);\n\n\t \n\tlan_wr(ANA_VLAN_CFG_VLAN_VID_SET(0) |\n\t       ANA_VLAN_CFG_VLAN_AWARE_ENA_SET(1) |\n\t       ANA_VLAN_CFG_VLAN_POP_CNT_SET(1),\n\t       lan966x, ANA_VLAN_CFG(CPU_PORT));\n\n\t \n\tlan_wr(GENMASK(lan966x->num_phys_ports, 0),\n\t       lan966x, ANA_VLANMASK);\n\n\tfor (port = 0; port < lan966x->num_phys_ports; port++) {\n\t\tlan_wr(0, lan966x, REW_PORT_VLAN_CFG(port));\n\t\tlan_wr(0, lan966x, REW_TAG_CFG(port));\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}