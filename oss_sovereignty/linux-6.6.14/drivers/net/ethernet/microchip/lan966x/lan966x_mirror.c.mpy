{
  "module_name": "lan966x_mirror.c",
  "hash_id": "a562815ec23ee5b558da27d3e21b0dc1f262dd0038cb013a009116a6322e6f3a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/lan966x/lan966x_mirror.c",
  "human_readable_source": "\n\n#include \"lan966x_main.h\"\n\nint lan966x_mirror_port_add(struct lan966x_port *port,\n\t\t\t    struct flow_action_entry *action,\n\t\t\t    unsigned long mirror_id,\n\t\t\t    bool ingress,\n\t\t\t    struct netlink_ext_ack *extack)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tstruct lan966x_port *monitor_port;\n\n\tif (!lan966x_netdevice_check(action->dev)) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Destination not an lan966x port\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tmonitor_port = netdev_priv(action->dev);\n\n\tif (lan966x->mirror_mask[ingress] & BIT(port->chip_port)) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Mirror already exists\");\n\t\treturn -EEXIST;\n\t}\n\n\tif (lan966x->mirror_monitor &&\n\t    lan966x->mirror_monitor != monitor_port) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Cannot change mirror port while in use\");\n\t\treturn -EBUSY;\n\t}\n\n\tif (port == monitor_port) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Cannot mirror the monitor port\");\n\t\treturn -EINVAL;\n\t}\n\n\tlan966x->mirror_mask[ingress] |= BIT(port->chip_port);\n\n\tlan966x->mirror_monitor = monitor_port;\n\tlan_wr(BIT(monitor_port->chip_port), lan966x, ANA_MIRRORPORTS);\n\n\tif (ingress) {\n\t\tlan_rmw(ANA_PORT_CFG_SRC_MIRROR_ENA_SET(1),\n\t\t\tANA_PORT_CFG_SRC_MIRROR_ENA,\n\t\t\tlan966x, ANA_PORT_CFG(port->chip_port));\n\t} else {\n\t\tlan_wr(lan966x->mirror_mask[0], lan966x,\n\t\t       ANA_EMIRRORPORTS);\n\t}\n\n\tlan966x->mirror_count++;\n\n\tif (ingress)\n\t\tport->tc.ingress_mirror_id = mirror_id;\n\telse\n\t\tport->tc.egress_mirror_id = mirror_id;\n\n\treturn 0;\n}\n\nint lan966x_mirror_port_del(struct lan966x_port *port,\n\t\t\t    bool ingress,\n\t\t\t    struct netlink_ext_ack *extack)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\n\tif (!(lan966x->mirror_mask[ingress] & BIT(port->chip_port))) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"There is no mirroring for this port\");\n\t\treturn -ENOENT;\n\t}\n\n\tlan966x->mirror_mask[ingress] &= ~BIT(port->chip_port);\n\n\tif (ingress) {\n\t\tlan_rmw(ANA_PORT_CFG_SRC_MIRROR_ENA_SET(0),\n\t\t\tANA_PORT_CFG_SRC_MIRROR_ENA,\n\t\t\tlan966x, ANA_PORT_CFG(port->chip_port));\n\t} else {\n\t\tlan_wr(lan966x->mirror_mask[0], lan966x,\n\t\t       ANA_EMIRRORPORTS);\n\t}\n\n\tlan966x->mirror_count--;\n\n\tif (lan966x->mirror_count == 0) {\n\t\tlan966x->mirror_monitor = NULL;\n\t\tlan_wr(0, lan966x, ANA_MIRRORPORTS);\n\t}\n\n\tif (ingress)\n\t\tport->tc.ingress_mirror_id = 0;\n\telse\n\t\tport->tc.egress_mirror_id = 0;\n\n\treturn 0;\n}\n\nvoid lan966x_mirror_port_stats(struct lan966x_port *port,\n\t\t\t       struct flow_stats *stats,\n\t\t\t       bool ingress)\n{\n\tstruct rtnl_link_stats64 new_stats;\n\tstruct flow_stats *old_stats;\n\n\told_stats = &port->tc.mirror_stat;\n\tlan966x_stats_get(port->dev, &new_stats);\n\n\tif (ingress) {\n\t\tflow_stats_update(stats,\n\t\t\t\t  new_stats.rx_bytes - old_stats->bytes,\n\t\t\t\t  new_stats.rx_packets - old_stats->pkts,\n\t\t\t\t  new_stats.rx_dropped - old_stats->drops,\n\t\t\t\t  old_stats->lastused,\n\t\t\t\t  FLOW_ACTION_HW_STATS_IMMEDIATE);\n\n\t\told_stats->bytes = new_stats.rx_bytes;\n\t\told_stats->pkts = new_stats.rx_packets;\n\t\told_stats->drops = new_stats.rx_dropped;\n\t\told_stats->lastused = jiffies;\n\t} else {\n\t\tflow_stats_update(stats,\n\t\t\t\t  new_stats.tx_bytes - old_stats->bytes,\n\t\t\t\t  new_stats.tx_packets - old_stats->pkts,\n\t\t\t\t  new_stats.tx_dropped - old_stats->drops,\n\t\t\t\t  old_stats->lastused,\n\t\t\t\t  FLOW_ACTION_HW_STATS_IMMEDIATE);\n\n\t\told_stats->bytes = new_stats.tx_bytes;\n\t\told_stats->pkts = new_stats.tx_packets;\n\t\told_stats->drops = new_stats.tx_dropped;\n\t\told_stats->lastused = jiffies;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}