{
  "module_name": "lan966x_tbf.c",
  "hash_id": "91b9324bc92df841ff47b14dce2a2853819dac6302ac6e83936cf9c3c3cc1cdb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/lan966x/lan966x_tbf.c",
  "human_readable_source": "\n\n#include \"lan966x_main.h\"\n\nint lan966x_tbf_add(struct lan966x_port *port,\n\t\t    struct tc_tbf_qopt_offload *qopt)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tbool root = qopt->parent == TC_H_ROOT;\n\tu32 queue = 0;\n\tu32 cir, cbs;\n\tu32 se_idx;\n\n\tif (!root) {\n\t\tqueue = TC_H_MIN(qopt->parent) - 1;\n\t\tif (queue >= NUM_PRIO_QUEUES)\n\t\t\treturn -EOPNOTSUPP;\n\t}\n\n\tif (root)\n\t\tse_idx = SE_IDX_PORT + port->chip_port;\n\telse\n\t\tse_idx = SE_IDX_QUEUE + port->chip_port * NUM_PRIO_QUEUES + queue;\n\n\tcir = div_u64(qopt->replace_params.rate.rate_bytes_ps, 1000) * 8;\n\tcbs = qopt->replace_params.max_size;\n\n\t \n\tcir = DIV_ROUND_UP(cir, 100);\n\t \n\tcir = cir ?: 1;\n\t \n\tcbs = DIV_ROUND_UP(cbs, 4096);\n\t \n\tcbs = cbs ?: 1;\n\n\t \n\tif (cir > GENMASK(15, 0) ||\n\t    cbs > GENMASK(6, 0))\n\t\treturn -EINVAL;\n\n\tlan_rmw(QSYS_SE_CFG_SE_AVB_ENA_SET(0) |\n\t\tQSYS_SE_CFG_SE_FRM_MODE_SET(1),\n\t\tQSYS_SE_CFG_SE_AVB_ENA |\n\t\tQSYS_SE_CFG_SE_FRM_MODE,\n\t\tlan966x, QSYS_SE_CFG(se_idx));\n\n\tlan_wr(QSYS_CIR_CFG_CIR_RATE_SET(cir) |\n\t       QSYS_CIR_CFG_CIR_BURST_SET(cbs),\n\t       lan966x, QSYS_CIR_CFG(se_idx));\n\n\treturn 0;\n}\n\nint lan966x_tbf_del(struct lan966x_port *port,\n\t\t    struct tc_tbf_qopt_offload *qopt)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tbool root = qopt->parent == TC_H_ROOT;\n\tu32 queue = 0;\n\tu32 se_idx;\n\n\tif (!root) {\n\t\tqueue = TC_H_MIN(qopt->parent) - 1;\n\t\tif (queue >= NUM_PRIO_QUEUES)\n\t\t\treturn -EOPNOTSUPP;\n\t}\n\n\tif (root)\n\t\tse_idx = SE_IDX_PORT + port->chip_port;\n\telse\n\t\tse_idx = SE_IDX_QUEUE + port->chip_port * NUM_PRIO_QUEUES + queue;\n\n\tlan_rmw(QSYS_SE_CFG_SE_AVB_ENA_SET(0) |\n\t\tQSYS_SE_CFG_SE_FRM_MODE_SET(0),\n\t\tQSYS_SE_CFG_SE_AVB_ENA |\n\t\tQSYS_SE_CFG_SE_FRM_MODE,\n\t\tlan966x, QSYS_SE_CFG(se_idx));\n\n\tlan_wr(QSYS_CIR_CFG_CIR_RATE_SET(0) |\n\t       QSYS_CIR_CFG_CIR_BURST_SET(0),\n\t       lan966x, QSYS_CIR_CFG(se_idx));\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}