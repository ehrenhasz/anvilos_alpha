{
  "module_name": "lan966x_taprio.c",
  "hash_id": "5adde19738b309e1ccbb5b5ffe515e2f32d62be1642a39c5548bc6d2e0ecc488",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/lan966x/lan966x_taprio.c",
  "human_readable_source": "\n\n#include \"lan966x_main.h\"\n\n#define LAN966X_TAPRIO_TIMEOUT_MS\t\t1000\n#define LAN966X_TAPRIO_ENTRIES_PER_PORT\t\t2\n\n \n#define LAN966X_TAPRIO_MIN_CYCLE_TIME_NS\tNSEC_PER_USEC\n\n \n#define LAN966X_TAPRIO_MAX_CYCLE_TIME_NS\t(NSEC_PER_SEC - 1)\n\n \n#define LAN966X_TAPRIO_NUM_GCL\t\t\t256\n\n \nenum lan966x_taprio_link_speed {\n\tLAN966X_TAPRIO_SPEED_NO_GB,\n\tLAN966X_TAPRIO_SPEED_10,\n\tLAN966X_TAPRIO_SPEED_100,\n\tLAN966X_TAPRIO_SPEED_1000,\n\tLAN966X_TAPRIO_SPEED_2500,\n};\n\n \nenum lan966x_taprio_state {\n\tLAN966X_TAPRIO_STATE_ADMIN,\n\tLAN966X_TAPRIO_STATE_ADVANCING,\n\tLAN966X_TAPRIO_STATE_PENDING,\n\tLAN966X_TAPRIO_STATE_OPERATING,\n\tLAN966X_TAPRIO_STATE_TERMINATING,\n\tLAN966X_TAPRIO_STATE_MAX,\n};\n\n \nenum lan966x_taprio_gcl_cmd {\n\tLAN966X_TAPRIO_GCL_CMD_SET_GATE_STATES = 0,\n};\n\nstatic u32 lan966x_taprio_list_index(struct lan966x_port *port, u8 entry)\n{\n\treturn port->chip_port * LAN966X_TAPRIO_ENTRIES_PER_PORT + entry;\n}\n\nstatic u32 lan966x_taprio_list_state_get(struct lan966x_port *port)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tu32 val;\n\n\tval = lan_rd(lan966x, QSYS_TAS_LST);\n\treturn QSYS_TAS_LST_LIST_STATE_GET(val);\n}\n\nstatic u32 lan966x_taprio_list_index_state_get(struct lan966x_port *port,\n\t\t\t\t\t       u32 list)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\n\tlan_rmw(QSYS_TAS_CFG_CTRL_LIST_NUM_SET(list),\n\t\tQSYS_TAS_CFG_CTRL_LIST_NUM,\n\t\tlan966x, QSYS_TAS_CFG_CTRL);\n\n\treturn lan966x_taprio_list_state_get(port);\n}\n\nstatic void lan966x_taprio_list_state_set(struct lan966x_port *port,\n\t\t\t\t\t  u32 state)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\n\tlan_rmw(QSYS_TAS_LST_LIST_STATE_SET(state),\n\t\tQSYS_TAS_LST_LIST_STATE,\n\t\tlan966x, QSYS_TAS_LST);\n}\n\nstatic int lan966x_taprio_list_shutdown(struct lan966x_port *port,\n\t\t\t\t\tu32 list)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tbool pending, operating;\n\tunsigned long end;\n\tu32 state;\n\n\tend = jiffies +  msecs_to_jiffies(LAN966X_TAPRIO_TIMEOUT_MS);\n\t \n\tdo {\n\t\tstate = lan966x_taprio_list_state_get(port);\n\n\t\tpending = false;\n\t\toperating = false;\n\n\t\tif (state == LAN966X_TAPRIO_STATE_ADVANCING ||\n\t\t    state == LAN966X_TAPRIO_STATE_PENDING) {\n\t\t\tlan966x_taprio_list_state_set(port,\n\t\t\t\t\t\t      LAN966X_TAPRIO_STATE_ADMIN);\n\t\t\tpending = true;\n\t\t}\n\n\t\tif (state == LAN966X_TAPRIO_STATE_OPERATING) {\n\t\t\tlan966x_taprio_list_state_set(port,\n\t\t\t\t\t\t      LAN966X_TAPRIO_STATE_TERMINATING);\n\t\t\toperating = true;\n\t\t}\n\n\t\t \n\t\tstate = lan966x_taprio_list_state_get(port);\n\t\tif (pending &&\n\t\t    state == LAN966X_TAPRIO_STATE_ADMIN)\n\t\t\treturn 0;\n\n\t\t \n\t\tif (operating &&\n\t\t    (state == LAN966X_TAPRIO_STATE_TERMINATING ||\n\t\t     state == LAN966X_TAPRIO_STATE_ADMIN))\n\t\t\tbreak;\n\n\t} while (!time_after(jiffies, end));\n\n\tend = jiffies + msecs_to_jiffies(LAN966X_TAPRIO_TIMEOUT_MS);\n\tdo {\n\t\tstate = lan966x_taprio_list_state_get(port);\n\t\tif (state == LAN966X_TAPRIO_STATE_ADMIN)\n\t\t\tbreak;\n\n\t} while (!time_after(jiffies, end));\n\n\t \n\tif (operating) {\n\t\tlan_wr(QSYS_TAS_GS_CTRL_HSCH_POS_SET(port->chip_port),\n\t\t       lan966x, QSYS_TAS_GS_CTRL);\n\n\t\tlan_wr(QSYS_TAS_GATE_STATE_TAS_GATE_STATE_SET(0xff),\n\t\t       lan966x, QSYS_TAS_GATE_STATE);\n\t}\n\n\treturn 0;\n}\n\nstatic int lan966x_taprio_shutdown(struct lan966x_port *port)\n{\n\tu32 i, list, state;\n\tint err;\n\n\tfor (i = 0; i < LAN966X_TAPRIO_ENTRIES_PER_PORT; ++i) {\n\t\tlist = lan966x_taprio_list_index(port, i);\n\t\tstate = lan966x_taprio_list_index_state_get(port, list);\n\t\tif (state == LAN966X_TAPRIO_STATE_ADMIN)\n\t\t\tcontinue;\n\n\t\terr = lan966x_taprio_list_shutdown(port, list);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int lan966x_taprio_find_list(struct lan966x_port *port,\n\t\t\t\t    struct tc_taprio_qopt_offload *qopt,\n\t\t\t\t    int *new_list, int *obs_list)\n{\n\tint state[LAN966X_TAPRIO_ENTRIES_PER_PORT];\n\tint list[LAN966X_TAPRIO_ENTRIES_PER_PORT];\n\tint err, oper = -1;\n\tu32 i;\n\n\t*new_list = -1;\n\t*obs_list = -1;\n\n\t \n\tfor (i = 0; i < LAN966X_TAPRIO_ENTRIES_PER_PORT; ++i) {\n\t\tlist[i] = lan966x_taprio_list_index(port, i);\n\t\tstate[i] = lan966x_taprio_list_index_state_get(port, list[i]);\n\t\tif (state[i] == LAN966X_TAPRIO_STATE_OPERATING)\n\t\t\toper = list[i];\n\t}\n\n\tfor (i = 0; i < LAN966X_TAPRIO_ENTRIES_PER_PORT; ++i) {\n\t\tif (state[i] == LAN966X_TAPRIO_STATE_PENDING) {\n\t\t\terr = lan966x_taprio_shutdown(port);\n\t\t\tif (err)\n\t\t\t\treturn err;\n\n\t\t\t*new_list = list[i];\n\t\t\t*obs_list = (oper == -1) ? *new_list : oper;\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\tfor (i = 0; i < LAN966X_TAPRIO_ENTRIES_PER_PORT; ++i) {\n\t\tif (state[i] == LAN966X_TAPRIO_STATE_ADMIN) {\n\t\t\t*new_list = list[i];\n\t\t\t*obs_list = (oper == -1) ? *new_list : oper;\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\treturn -ENOSPC;\n}\n\nstatic int lan966x_taprio_check(struct tc_taprio_qopt_offload *qopt)\n{\n\tu64 total_time = 0;\n\tu32 i;\n\n\t \n\tif (qopt->cycle_time_extension)\n\t\treturn -EOPNOTSUPP;\n\n\t \n\tif (qopt->num_entries > LAN966X_TAPRIO_NUM_GCL)\n\t\treturn -EINVAL;\n\n\t \n\tif (qopt->cycle_time < LAN966X_TAPRIO_MIN_CYCLE_TIME_NS ||\n\t    qopt->cycle_time > LAN966X_TAPRIO_MAX_CYCLE_TIME_NS)\n\t\treturn -EINVAL;\n\n\tfor (i = 0; i < qopt->num_entries; ++i) {\n\t\tstruct tc_taprio_sched_entry *entry = &qopt->entries[i];\n\n\t\t \n\t\tif (entry->interval < LAN966X_TAPRIO_MIN_CYCLE_TIME_NS ||\n\t\t    entry->interval > LAN966X_TAPRIO_MAX_CYCLE_TIME_NS)\n\t\t\treturn -EINVAL;\n\n\t\tif (qopt->entries[i].command != TC_TAPRIO_CMD_SET_GATES)\n\t\t\treturn -EINVAL;\n\n\t\ttotal_time += qopt->entries[i].interval;\n\t}\n\n\t \n\tif (total_time > LAN966X_TAPRIO_MAX_CYCLE_TIME_NS)\n\t\treturn -EINVAL;\n\n\t \n\tif (qopt->cycle_time < total_time)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic int lan966x_taprio_gcl_free_get(struct lan966x_port *port,\n\t\t\t\t       unsigned long *free_list)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tu32 num_free, state, list;\n\tu32 base, next, max_list;\n\n\t \n\tbitmap_fill(free_list, LAN966X_TAPRIO_NUM_GCL);\n\tnum_free = LAN966X_TAPRIO_NUM_GCL;\n\n\t \n\tmax_list = lan966x->num_phys_ports * LAN966X_TAPRIO_ENTRIES_PER_PORT;\n\tfor (list = 0; list < max_list; ++list) {\n\t\tstate = lan966x_taprio_list_index_state_get(port, list);\n\t\tif (state == LAN966X_TAPRIO_STATE_ADMIN)\n\t\t\tcontinue;\n\n\t\tbase = lan_rd(lan966x, QSYS_TAS_LIST_CFG);\n\t\tbase = QSYS_TAS_LIST_CFG_LIST_BASE_ADDR_GET(base);\n\t\tnext = base;\n\n\t\tdo {\n\t\t\tclear_bit(next, free_list);\n\t\t\tnum_free--;\n\n\t\t\tlan_rmw(QSYS_TAS_CFG_CTRL_GCL_ENTRY_NUM_SET(next),\n\t\t\t\tQSYS_TAS_CFG_CTRL_GCL_ENTRY_NUM,\n\t\t\t\tlan966x, QSYS_TAS_CFG_CTRL);\n\n\t\t\tnext = lan_rd(lan966x, QSYS_TAS_GCL_CT_CFG2);\n\t\t\tnext = QSYS_TAS_GCL_CT_CFG2_NEXT_GCL_GET(next);\n\t\t} while (base != next);\n\t}\n\n\treturn num_free;\n}\n\nstatic void lan966x_taprio_gcl_setup_entry(struct lan966x_port *port,\n\t\t\t\t\t   struct tc_taprio_sched_entry *entry,\n\t\t\t\t\t   u32 next_entry)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\n\t \n\tlan_wr(QSYS_TAS_GCL_CT_CFG_GATE_STATE_SET(entry->gate_mask) |\n\t       QSYS_TAS_GCL_CT_CFG_HSCH_POS_SET(port->chip_port) |\n\t       QSYS_TAS_GCL_CT_CFG_OP_TYPE_SET(LAN966X_TAPRIO_GCL_CMD_SET_GATE_STATES),\n\t       lan966x, QSYS_TAS_GCL_CT_CFG);\n\n\tlan_wr(QSYS_TAS_GCL_CT_CFG2_PORT_PROFILE_SET(port->chip_port) |\n\t       QSYS_TAS_GCL_CT_CFG2_NEXT_GCL_SET(next_entry),\n\t       lan966x, QSYS_TAS_GCL_CT_CFG2);\n\n\tlan_wr(entry->interval, lan966x, QSYS_TAS_GCL_TM_CFG);\n}\n\nstatic int lan966x_taprio_gcl_setup(struct lan966x_port *port,\n\t\t\t\t    struct tc_taprio_qopt_offload *qopt,\n\t\t\t\t    int list)\n{\n\tDECLARE_BITMAP(free_list, LAN966X_TAPRIO_NUM_GCL);\n\tstruct lan966x *lan966x = port->lan966x;\n\tu32 i, base, next;\n\n\tif (lan966x_taprio_gcl_free_get(port, free_list) < qopt->num_entries)\n\t\treturn -ENOSPC;\n\n\t \n\tlan_rmw(QSYS_TAS_CFG_CTRL_LIST_NUM_SET(list),\n\t\tQSYS_TAS_CFG_CTRL_LIST_NUM,\n\t\tlan966x, QSYS_TAS_CFG_CTRL);\n\n\t \n\tbase = find_first_bit(free_list, LAN966X_TAPRIO_NUM_GCL);\n\tlan_rmw(QSYS_TAS_LIST_CFG_LIST_BASE_ADDR_SET(base),\n\t\tQSYS_TAS_LIST_CFG_LIST_BASE_ADDR,\n\t\tlan966x, QSYS_TAS_LIST_CFG);\n\n\t \n\tnext = base;\n\tfor (i = 0; i < qopt->num_entries; ++i) {\n\t\tlan_rmw(QSYS_TAS_CFG_CTRL_GCL_ENTRY_NUM_SET(next),\n\t\t\tQSYS_TAS_CFG_CTRL_GCL_ENTRY_NUM,\n\t\t\tlan966x, QSYS_TAS_CFG_CTRL);\n\n\t\t \n\t\tif (i == qopt->num_entries - 1)\n\t\t\tnext = base;\n\t\telse\n\t\t\tnext = find_next_bit(free_list, LAN966X_TAPRIO_NUM_GCL,\n\t\t\t\t\t     next + 1);\n\n\t\tlan966x_taprio_gcl_setup_entry(port, &qopt->entries[i], next);\n\t}\n\n\treturn 0;\n}\n\n \nstatic void lan966x_taprio_new_base_time(struct lan966x *lan966x,\n\t\t\t\t\t const u32 cycle_time,\n\t\t\t\t\t const ktime_t org_base_time,\n\t\t\t\t\t ktime_t *new_base_time)\n{\n\tktime_t current_time, threshold_time;\n\tstruct timespec64 ts;\n\n\t \n\tlan966x_ptp_gettime64(&lan966x->phc[LAN966X_PHC_PORT].info, &ts);\n\tcurrent_time = timespec64_to_ktime(ts);\n\tthreshold_time = current_time + (2 * cycle_time);\n\n\t \n\tif (org_base_time >= threshold_time) {\n\t\t*new_base_time = org_base_time;\n\t\treturn;\n\t}\n\n\t \n\tif (org_base_time <= current_time) {\n\t\tu64 tmp = current_time - org_base_time;\n\t\tu32 rem = 0;\n\n\t\tif (tmp > cycle_time)\n\t\t\tdiv_u64_rem(tmp, cycle_time, &rem);\n\t\trem = cycle_time - rem;\n\t\t*new_base_time = threshold_time + rem;\n\t\treturn;\n\t}\n\n\t \n\t*new_base_time = org_base_time + 2 * cycle_time;\n}\n\nint lan966x_taprio_speed_set(struct lan966x_port *port, int speed)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tu8 taprio_speed;\n\n\tswitch (speed) {\n\tcase SPEED_10:\n\t\ttaprio_speed = LAN966X_TAPRIO_SPEED_10;\n\t\tbreak;\n\tcase SPEED_100:\n\t\ttaprio_speed = LAN966X_TAPRIO_SPEED_100;\n\t\tbreak;\n\tcase SPEED_1000:\n\t\ttaprio_speed = LAN966X_TAPRIO_SPEED_1000;\n\t\tbreak;\n\tcase SPEED_2500:\n\t\ttaprio_speed = LAN966X_TAPRIO_SPEED_2500;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tlan_rmw(QSYS_TAS_PROFILE_CFG_LINK_SPEED_SET(taprio_speed),\n\t\tQSYS_TAS_PROFILE_CFG_LINK_SPEED,\n\t\tlan966x, QSYS_TAS_PROFILE_CFG(port->chip_port));\n\n\treturn 0;\n}\n\nint lan966x_taprio_add(struct lan966x_port *port,\n\t\t       struct tc_taprio_qopt_offload *qopt)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tint err, new_list, obs_list;\n\tstruct timespec64 ts;\n\tktime_t base_time;\n\n\terr = lan966x_taprio_check(qopt);\n\tif (err)\n\t\treturn err;\n\n\terr = lan966x_taprio_find_list(port, qopt, &new_list, &obs_list);\n\tif (err)\n\t\treturn err;\n\n\terr = lan966x_taprio_gcl_setup(port, qopt, new_list);\n\tif (err)\n\t\treturn err;\n\n\tlan966x_taprio_new_base_time(lan966x, qopt->cycle_time,\n\t\t\t\t     qopt->base_time, &base_time);\n\n\tts = ktime_to_timespec64(base_time);\n\tlan_wr(QSYS_TAS_BT_NSEC_NSEC_SET(ts.tv_nsec),\n\t       lan966x, QSYS_TAS_BT_NSEC);\n\n\tlan_wr(lower_32_bits(ts.tv_sec),\n\t       lan966x, QSYS_TAS_BT_SEC_LSB);\n\n\tlan_wr(QSYS_TAS_BT_SEC_MSB_SEC_MSB_SET(upper_32_bits(ts.tv_sec)),\n\t       lan966x, QSYS_TAS_BT_SEC_MSB);\n\n\tlan_wr(qopt->cycle_time, lan966x, QSYS_TAS_CT_CFG);\n\n\tlan_rmw(QSYS_TAS_STARTUP_CFG_OBSOLETE_IDX_SET(obs_list),\n\t\tQSYS_TAS_STARTUP_CFG_OBSOLETE_IDX,\n\t\tlan966x, QSYS_TAS_STARTUP_CFG);\n\n\t \n\tlan_rmw(QSYS_TAS_LST_LIST_STATE_SET(LAN966X_TAPRIO_STATE_ADVANCING),\n\t\tQSYS_TAS_LST_LIST_STATE,\n\t\tlan966x, QSYS_TAS_LST);\n\n\treturn err;\n}\n\nint lan966x_taprio_del(struct lan966x_port *port)\n{\n\treturn lan966x_taprio_shutdown(port);\n}\n\nvoid lan966x_taprio_init(struct lan966x *lan966x)\n{\n\tint num_taprio_lists;\n\tint p;\n\n\tlan_wr(QSYS_TAS_STM_CFG_REVISIT_DLY_SET((256 * 1000) /\n\t\t\t\t\t\tlan966x_ptp_get_period_ps()),\n\t       lan966x, QSYS_TAS_STM_CFG);\n\n\tnum_taprio_lists = lan966x->num_phys_ports *\n\t\t\t   LAN966X_TAPRIO_ENTRIES_PER_PORT;\n\n\t \n\tlan_rmw(QSYS_TAS_CFG_CTRL_LIST_NUM_MAX_SET(num_taprio_lists) |\n\t\tQSYS_TAS_CFG_CTRL_ALWAYS_GB_SCH_Q_SET(1),\n\t\tQSYS_TAS_CFG_CTRL_LIST_NUM_MAX |\n\t\tQSYS_TAS_CFG_CTRL_ALWAYS_GB_SCH_Q,\n\t\tlan966x, QSYS_TAS_CFG_CTRL);\n\n\tfor (p = 0; p < lan966x->num_phys_ports; p++)\n\t\tlan_rmw(QSYS_TAS_PROFILE_CFG_PORT_NUM_SET(p),\n\t\t\tQSYS_TAS_PROFILE_CFG_PORT_NUM,\n\t\t\tlan966x, QSYS_TAS_PROFILE_CFG(p));\n}\n\nvoid lan966x_taprio_deinit(struct lan966x *lan966x)\n{\n\tint p;\n\n\tfor (p = 0; p < lan966x->num_phys_ports; ++p) {\n\t\tif (!lan966x->ports[p])\n\t\t\tcontinue;\n\n\t\tlan966x_taprio_del(lan966x->ports[p]);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}