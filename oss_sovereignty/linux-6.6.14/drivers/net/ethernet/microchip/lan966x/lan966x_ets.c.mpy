{
  "module_name": "lan966x_ets.c",
  "hash_id": "2246cefcacd67cfd787ee7492d604127fcb6da3343002e564859c239f99b8b67",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/lan966x/lan966x_ets.c",
  "human_readable_source": "\n\n#include \"lan966x_main.h\"\n\n#define DWRR_COST_BIT_WIDTH\tBIT(5)\n\nstatic u32 lan966x_ets_hw_cost(u32 w_min, u32 weight)\n{\n\tu32 res;\n\n\t \n\tres = (((DWRR_COST_BIT_WIDTH << 4) * w_min / weight) + 8) >> 4;\n\treturn max_t(u32, 1, res) - 1;\n}\n\nint lan966x_ets_add(struct lan966x_port *port,\n\t\t    struct tc_ets_qopt_offload *qopt)\n{\n\tstruct tc_ets_qopt_offload_replace_params *params;\n\tstruct lan966x *lan966x = port->lan966x;\n\tu32 w_min = 100;\n\tu8 count = 0;\n\tu32 se_idx;\n\tu8 i;\n\n\t \n\tif (qopt->parent != TC_H_ROOT)\n\t\treturn -EINVAL;\n\n\tparams = &qopt->replace_params;\n\tif (params->bands != NUM_PRIO_QUEUES)\n\t\treturn -EINVAL;\n\n\tfor (i = 0; i < params->bands; ++i) {\n\t\t \n\t\tif (params->priomap[i] != (7 - i))\n\t\t\treturn -EINVAL;\n\n\t\tif (params->quanta[i] && params->weights[i] == 0)\n\t\t\treturn -EINVAL;\n\t}\n\n\tse_idx = SE_IDX_PORT + port->chip_port;\n\n\t \n\tfor (i = 0; i < params->bands; ++i) {\n\t\tif (params->quanta[i] == 0)\n\t\t\tcontinue;\n\n\t\tw_min = min(w_min, params->weights[i]);\n\t}\n\n\tfor (i = 0; i < params->bands; ++i) {\n\t\tif (params->quanta[i] == 0)\n\t\t\tcontinue;\n\n\t\t++count;\n\n\t\tlan_wr(lan966x_ets_hw_cost(w_min, params->weights[i]),\n\t\t       lan966x, QSYS_SE_DWRR_CFG(se_idx, 7 - i));\n\t}\n\n\tlan_rmw(QSYS_SE_CFG_SE_DWRR_CNT_SET(count) |\n\t\tQSYS_SE_CFG_SE_RR_ENA_SET(0),\n\t\tQSYS_SE_CFG_SE_DWRR_CNT |\n\t\tQSYS_SE_CFG_SE_RR_ENA,\n\t\tlan966x, QSYS_SE_CFG(se_idx));\n\n\treturn 0;\n}\n\nint lan966x_ets_del(struct lan966x_port *port,\n\t\t    struct tc_ets_qopt_offload *qopt)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tu32 se_idx;\n\tint i;\n\n\tse_idx = SE_IDX_PORT + port->chip_port;\n\n\tfor (i = 0; i < NUM_PRIO_QUEUES; ++i)\n\t\tlan_wr(0, lan966x, QSYS_SE_DWRR_CFG(se_idx, i));\n\n\tlan_rmw(QSYS_SE_CFG_SE_DWRR_CNT_SET(0) |\n\t\tQSYS_SE_CFG_SE_RR_ENA_SET(0),\n\t\tQSYS_SE_CFG_SE_DWRR_CNT |\n\t\tQSYS_SE_CFG_SE_RR_ENA,\n\t\tlan966x, QSYS_SE_CFG(se_idx));\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}