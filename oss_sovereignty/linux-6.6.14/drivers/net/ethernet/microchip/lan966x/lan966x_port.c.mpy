{
  "module_name": "lan966x_port.c",
  "hash_id": "a6edca5161b69fb6d704c669817f3d3f23f55e48625e2d672bb93c3e4fd3ca80",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/lan966x/lan966x_port.c",
  "human_readable_source": "\n\n#include <linux/netdevice.h>\n#include <linux/phy/phy.h>\n\n#include \"lan966x_main.h\"\n\n \n#define MULTIPLIER_BIT BIT(8)\nstatic u32 lan966x_wm_enc(u32 value)\n{\n\tvalue /= LAN966X_BUFFER_CELL_SZ;\n\n\tif (value >= MULTIPLIER_BIT) {\n\t\tvalue /= 16;\n\t\tif (value >= MULTIPLIER_BIT)\n\t\t\tvalue = (MULTIPLIER_BIT - 1);\n\n\t\tvalue |= MULTIPLIER_BIT;\n\t}\n\n\treturn value;\n}\n\nstatic void lan966x_port_link_down(struct lan966x_port *port)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tu32 val, delay = 0;\n\n\t \n\tlan_rmw(AFI_PORT_CFG_FC_SKIP_TTI_INJ_SET(1) |\n\t\tAFI_PORT_CFG_FRM_OUT_MAX_SET(0),\n\t\tAFI_PORT_CFG_FC_SKIP_TTI_INJ |\n\t\tAFI_PORT_CFG_FRM_OUT_MAX,\n\t\tlan966x, AFI_PORT_CFG(port->chip_port));\n\n\t \n\twhile (true) {\n\t\tval = lan_rd(lan966x, AFI_PORT_FRM_OUT(port->chip_port));\n\t\tif (!AFI_PORT_FRM_OUT_FRM_OUT_CNT_GET(val))\n\t\t\tbreak;\n\n\t\tusleep_range(USEC_PER_MSEC, 2 * USEC_PER_MSEC);\n\t\tdelay++;\n\t\tif (delay == 2000) {\n\t\t\tpr_err(\"AFI timeout chip port %u\", port->chip_port);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tdelay = 0;\n\n\t \n\tlan_rmw(DEV_CLOCK_CFG_PCS_RX_RST_SET(1),\n\t\tDEV_CLOCK_CFG_PCS_RX_RST,\n\t\tlan966x, DEV_CLOCK_CFG(port->chip_port));\n\n\t \n\tlan_rmw(DEV_MAC_ENA_CFG_RX_ENA_SET(0),\n\t\tDEV_MAC_ENA_CFG_RX_ENA,\n\t\tlan966x, DEV_MAC_ENA_CFG(port->chip_port));\n\n\t \n\tlan_rmw(QSYS_SW_PORT_MODE_PORT_ENA_SET(0),\n\t\tQSYS_SW_PORT_MODE_PORT_ENA,\n\t\tlan966x, QSYS_SW_PORT_MODE(port->chip_port));\n\n\t \n\tlan_rmw(QSYS_PORT_MODE_DEQUEUE_DIS_SET(1),\n\t\tQSYS_PORT_MODE_DEQUEUE_DIS,\n\t\tlan966x, QSYS_PORT_MODE(port->chip_port));\n\n\t \n\tlan_rmw(SYS_PAUSE_CFG_PAUSE_ENA_SET(0),\n\t\tSYS_PAUSE_CFG_PAUSE_ENA,\n\t\tlan966x, SYS_PAUSE_CFG(port->chip_port));\n\n\t \n\tlan_rmw(QSYS_SW_PORT_MODE_TX_PFC_ENA_SET(0),\n\t\tQSYS_SW_PORT_MODE_TX_PFC_ENA,\n\t\tlan966x, QSYS_SW_PORT_MODE(port->chip_port));\n\n\t \n\tusleep_range(8 * USEC_PER_MSEC, 9 * USEC_PER_MSEC);\n\n\t \n\tlan_rmw(SYS_FRONT_PORT_MODE_HDX_MODE_SET(0),\n\t\tSYS_FRONT_PORT_MODE_HDX_MODE,\n\t\tlan966x, SYS_FRONT_PORT_MODE(port->chip_port));\n\n\t \n\tlan_rmw(QSYS_SW_PORT_MODE_AGING_MODE_SET(3),\n\t\tQSYS_SW_PORT_MODE_AGING_MODE,\n\t\tlan966x, QSYS_SW_PORT_MODE(port->chip_port));\n\n\t \n\tlan_rmw(QSYS_PORT_MODE_DEQUEUE_DIS_SET(0),\n\t\tQSYS_PORT_MODE_DEQUEUE_DIS,\n\t\tlan966x, QSYS_PORT_MODE(port->chip_port));\n\n\t \n\twhile (true) {\n\t\tval = lan_rd(lan966x, QSYS_SW_STATUS(port->chip_port));\n\t\tif (!QSYS_SW_STATUS_EQ_AVAIL_GET(val))\n\t\t\tbreak;\n\n\t\tusleep_range(USEC_PER_MSEC, 2 * USEC_PER_MSEC);\n\t\tdelay++;\n\t\tif (delay == 2000) {\n\t\t\tpr_err(\"Flush timeout chip port %u\", port->chip_port);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\tlan_rmw(DEV_MAC_ENA_CFG_TX_ENA_SET(0),\n\t\tDEV_MAC_ENA_CFG_TX_ENA,\n\t\tlan966x, DEV_MAC_ENA_CFG(port->chip_port));\n\n\tlan_rmw(DEV_CLOCK_CFG_PORT_RST_SET(1),\n\t\tDEV_CLOCK_CFG_PORT_RST,\n\t\tlan966x, DEV_CLOCK_CFG(port->chip_port));\n\n\tusleep_range(USEC_PER_MSEC, 2 * USEC_PER_MSEC);\n\n\tlan_rmw(DEV_CLOCK_CFG_MAC_TX_RST_SET(1) |\n\t\tDEV_CLOCK_CFG_MAC_RX_RST_SET(1) |\n\t\tDEV_CLOCK_CFG_PORT_RST_SET(1),\n\t\tDEV_CLOCK_CFG_MAC_TX_RST |\n\t\tDEV_CLOCK_CFG_MAC_RX_RST |\n\t\tDEV_CLOCK_CFG_PORT_RST,\n\t\tlan966x, DEV_CLOCK_CFG(port->chip_port));\n\n\t \n\tlan_rmw(QSYS_SW_PORT_MODE_AGING_MODE_SET(2),\n\t\tQSYS_SW_PORT_MODE_AGING_MODE,\n\t\tlan966x, QSYS_SW_PORT_MODE(port->chip_port));\n\n\t \n}\n\nstatic void lan966x_port_link_up(struct lan966x_port *port)\n{\n\tstruct lan966x_port_config *config = &port->config;\n\tstruct lan966x *lan966x = port->lan966x;\n\tint speed = 0, mode = 0;\n\tint atop_wm = 0;\n\n\tswitch (config->speed) {\n\tcase SPEED_10:\n\t\tspeed = LAN966X_SPEED_10;\n\t\tbreak;\n\tcase SPEED_100:\n\t\tspeed = LAN966X_SPEED_100;\n\t\tbreak;\n\tcase SPEED_1000:\n\t\tspeed = LAN966X_SPEED_1000;\n\t\tmode = DEV_MAC_MODE_CFG_GIGA_MODE_ENA_SET(1);\n\t\tbreak;\n\tcase SPEED_2500:\n\t\tspeed = LAN966X_SPEED_2500;\n\t\tmode = DEV_MAC_MODE_CFG_GIGA_MODE_ENA_SET(1);\n\t\tbreak;\n\t}\n\n\tlan966x_taprio_speed_set(port, config->speed);\n\n\t \n\tif (phy_interface_num_ports(config->portmode) == 4)\n\t\tmode = DEV_MAC_MODE_CFG_GIGA_MODE_ENA_SET(1);\n\n\tlan_wr(config->duplex | mode,\n\t       lan966x, DEV_MAC_MODE_CFG(port->chip_port));\n\n\tlan_rmw(DEV_MAC_IFG_CFG_TX_IFG_SET(config->duplex ? 6 : 5) |\n\t\tDEV_MAC_IFG_CFG_RX_IFG1_SET(config->speed == SPEED_10 ? 2 : 1) |\n\t\tDEV_MAC_IFG_CFG_RX_IFG2_SET(2),\n\t\tDEV_MAC_IFG_CFG_TX_IFG |\n\t\tDEV_MAC_IFG_CFG_RX_IFG1 |\n\t\tDEV_MAC_IFG_CFG_RX_IFG2,\n\t\tlan966x, DEV_MAC_IFG_CFG(port->chip_port));\n\n\tlan_rmw(DEV_MAC_HDX_CFG_SEED_SET(4) |\n\t\tDEV_MAC_HDX_CFG_SEED_LOAD_SET(1),\n\t\tDEV_MAC_HDX_CFG_SEED |\n\t\tDEV_MAC_HDX_CFG_SEED_LOAD,\n\t\tlan966x, DEV_MAC_HDX_CFG(port->chip_port));\n\n\tif (config->portmode == PHY_INTERFACE_MODE_GMII) {\n\t\tif (config->speed == SPEED_1000)\n\t\t\tlan_rmw(CHIP_TOP_CUPHY_PORT_CFG_GTX_CLK_ENA_SET(1),\n\t\t\t\tCHIP_TOP_CUPHY_PORT_CFG_GTX_CLK_ENA,\n\t\t\t\tlan966x,\n\t\t\t\tCHIP_TOP_CUPHY_PORT_CFG(port->chip_port));\n\t\telse\n\t\t\tlan_rmw(CHIP_TOP_CUPHY_PORT_CFG_GTX_CLK_ENA_SET(0),\n\t\t\t\tCHIP_TOP_CUPHY_PORT_CFG_GTX_CLK_ENA,\n\t\t\t\tlan966x,\n\t\t\t\tCHIP_TOP_CUPHY_PORT_CFG(port->chip_port));\n\t}\n\n\t \n\tlan_wr(ANA_PFC_CFG_FC_LINK_SPEED_SET(speed),\n\t       lan966x, ANA_PFC_CFG(port->chip_port));\n\n\tlan_rmw(DEV_PCS1G_CFG_PCS_ENA_SET(1),\n\t\tDEV_PCS1G_CFG_PCS_ENA,\n\t\tlan966x, DEV_PCS1G_CFG(port->chip_port));\n\n\tlan_rmw(DEV_PCS1G_SD_CFG_SD_ENA_SET(0),\n\t\tDEV_PCS1G_SD_CFG_SD_ENA,\n\t\tlan966x, DEV_PCS1G_SD_CFG(port->chip_port));\n\n\t \n\tlan_wr(SYS_PAUSE_CFG_PAUSE_ENA_SET(1) |\n\t       SYS_PAUSE_CFG_PAUSE_STOP_SET(lan966x_wm_enc(4 * 1518)) |\n\t       SYS_PAUSE_CFG_PAUSE_START_SET(lan966x_wm_enc(6 * 1518)),\n\t       lan966x, SYS_PAUSE_CFG(port->chip_port));\n\n\t \n\tlan_wr(0, lan966x, DEV_FC_MAC_LOW_CFG(port->chip_port));\n\tlan_wr(0, lan966x, DEV_FC_MAC_HIGH_CFG(port->chip_port));\n\n\t \n\tlan_rmw(SYS_MAC_FC_CFG_FC_LINK_SPEED_SET(speed) |\n\t\tSYS_MAC_FC_CFG_FC_LATENCY_CFG_SET(7) |\n\t\tSYS_MAC_FC_CFG_ZERO_PAUSE_ENA_SET(1) |\n\t\tSYS_MAC_FC_CFG_PAUSE_VAL_CFG_SET(0xffff) |\n\t\tSYS_MAC_FC_CFG_RX_FC_ENA_SET(config->pause & MLO_PAUSE_RX ? 1 : 0) |\n\t\tSYS_MAC_FC_CFG_TX_FC_ENA_SET(config->pause & MLO_PAUSE_TX ? 1 : 0),\n\t\tSYS_MAC_FC_CFG_FC_LINK_SPEED |\n\t\tSYS_MAC_FC_CFG_FC_LATENCY_CFG |\n\t\tSYS_MAC_FC_CFG_ZERO_PAUSE_ENA |\n\t\tSYS_MAC_FC_CFG_PAUSE_VAL_CFG |\n\t\tSYS_MAC_FC_CFG_RX_FC_ENA |\n\t\tSYS_MAC_FC_CFG_TX_FC_ENA,\n\t\tlan966x, SYS_MAC_FC_CFG(port->chip_port));\n\n\t \n\tatop_wm = lan966x->shared_queue_sz;\n\n\t \n\tlan_wr(lan966x_wm_enc(atop_wm / lan966x->num_phys_ports + 1), lan966x,\n\t       SYS_ATOP(port->chip_port));\n\tlan_wr(lan966x_wm_enc(atop_wm), lan966x, SYS_ATOP_TOT_CFG);\n\n\t \n\t \n\tlan_wr(DEV_MAC_ENA_CFG_RX_ENA_SET(1) |\n\t       DEV_MAC_ENA_CFG_TX_ENA_SET(1),\n\t       lan966x, DEV_MAC_ENA_CFG(port->chip_port));\n\n\t \n\tlan_wr(DEV_CLOCK_CFG_LINK_SPEED_SET(speed),\n\t       lan966x, DEV_CLOCK_CFG(port->chip_port));\n\n\t \n\tlan_wr(QSYS_SW_PORT_MODE_PORT_ENA_SET(1) |\n\t       QSYS_SW_PORT_MODE_SCH_NEXT_CFG_SET(1) |\n\t       QSYS_SW_PORT_MODE_INGRESS_DROP_MODE_SET(1),\n\t       lan966x, QSYS_SW_PORT_MODE(port->chip_port));\n\n\tlan_rmw(AFI_PORT_CFG_FC_SKIP_TTI_INJ_SET(0) |\n\t\tAFI_PORT_CFG_FRM_OUT_MAX_SET(16),\n\t\tAFI_PORT_CFG_FC_SKIP_TTI_INJ |\n\t\tAFI_PORT_CFG_FRM_OUT_MAX,\n\t\tlan966x, AFI_PORT_CFG(port->chip_port));\n}\n\nvoid lan966x_port_config_down(struct lan966x_port *port)\n{\n\tlan966x_port_link_down(port);\n}\n\nvoid lan966x_port_config_up(struct lan966x_port *port)\n{\n\tlan966x_port_link_up(port);\n}\n\nvoid lan966x_port_status_get(struct lan966x_port *port,\n\t\t\t     struct phylink_link_state *state)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tbool link_down;\n\tu16 bmsr = 0;\n\tu16 lp_adv;\n\tu32 val;\n\n\tval = lan_rd(lan966x, DEV_PCS1G_STICKY(port->chip_port));\n\tlink_down = DEV_PCS1G_STICKY_LINK_DOWN_STICKY_GET(val);\n\tif (link_down)\n\t\tlan_wr(val, lan966x, DEV_PCS1G_STICKY(port->chip_port));\n\n\t \n\tval = lan_rd(lan966x, DEV_PCS1G_LINK_STATUS(port->chip_port));\n\tstate->link = DEV_PCS1G_LINK_STATUS_LINK_STATUS_GET(val) &&\n\t\t      DEV_PCS1G_LINK_STATUS_SYNC_STATUS_GET(val);\n\tstate->link &= !link_down;\n\n\t \n\tval = lan_rd(lan966x, DEV_PCS1G_ANEG_STATUS(port->chip_port));\n\t \n\tif (DEV_PCS1G_ANEG_STATUS_ANEG_COMPLETE_GET(val)) {\n\t\tstate->an_complete = true;\n\n\t\tbmsr |= state->link ? BMSR_LSTATUS : 0;\n\t\tbmsr |= BMSR_ANEGCOMPLETE;\n\n\t\tlp_adv = DEV_PCS1G_ANEG_STATUS_LP_ADV_GET(val);\n\t\tphylink_mii_c22_pcs_decode_state(state, bmsr, lp_adv);\n\t} else {\n\t\tif (!state->link)\n\t\t\treturn;\n\n\t\tif (state->interface == PHY_INTERFACE_MODE_1000BASEX)\n\t\t\tstate->speed = SPEED_1000;\n\t\telse if (state->interface == PHY_INTERFACE_MODE_2500BASEX)\n\t\t\tstate->speed = SPEED_2500;\n\n\t\tstate->duplex = DUPLEX_FULL;\n\t}\n}\n\nint lan966x_port_pcs_set(struct lan966x_port *port,\n\t\t\t struct lan966x_port_config *config)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\tbool inband_aneg = false;\n\tbool outband;\n\tbool full_preamble = false;\n\n\tif (config->portmode == PHY_INTERFACE_MODE_QUSGMII)\n\t\tfull_preamble = true;\n\n\tif (config->inband) {\n\t\tif (config->portmode == PHY_INTERFACE_MODE_SGMII ||\n\t\t    phy_interface_num_ports(config->portmode) == 4)\n\t\t\tinband_aneg = true;  \n\t\telse if (config->portmode == PHY_INTERFACE_MODE_1000BASEX &&\n\t\t\t config->autoneg)\n\t\t\tinband_aneg = true;  \n\n\t\toutband = false;\n\t} else {\n\t\toutband = true;\n\t}\n\n\t \n\tlan_rmw(DEV_PCS1G_MODE_CFG_SGMII_MODE_ENA_SET(outband) |\n\t\tDEV_PCS1G_MODE_CFG_SAVE_PREAMBLE_ENA_SET(full_preamble),\n\t\tDEV_PCS1G_MODE_CFG_SGMII_MODE_ENA |\n\t\tDEV_PCS1G_MODE_CFG_SAVE_PREAMBLE_ENA,\n\t\tlan966x, DEV_PCS1G_MODE_CFG(port->chip_port));\n\n\t \n\tlan_wr(DEV_PCS1G_CFG_PCS_ENA_SET(1),\n\t       lan966x, DEV_PCS1G_CFG(port->chip_port));\n\n\tif (inband_aneg) {\n\t\tint adv = phylink_mii_c22_pcs_encode_advertisement(config->portmode,\n\t\t\t\t\t\t\t\t   config->advertising);\n\t\tif (adv >= 0)\n\t\t\t \n\t\t\tlan_wr(DEV_PCS1G_ANEG_CFG_ADV_ABILITY_SET(adv) |\n\t\t\t       DEV_PCS1G_ANEG_CFG_SW_RESOLVE_ENA_SET(1) |\n\t\t\t       DEV_PCS1G_ANEG_CFG_ENA_SET(1) |\n\t\t\t       DEV_PCS1G_ANEG_CFG_RESTART_ONE_SHOT_SET(1),\n\t\t\t       lan966x, DEV_PCS1G_ANEG_CFG(port->chip_port));\n\t} else {\n\t\tlan_wr(0, lan966x, DEV_PCS1G_ANEG_CFG(port->chip_port));\n\t}\n\n\t \n\tlan_rmw(DEV_CLOCK_CFG_LINK_SPEED_SET(LAN966X_SPEED_1000) |\n\t\tDEV_CLOCK_CFG_PCS_RX_RST_SET(0) |\n\t\tDEV_CLOCK_CFG_PCS_TX_RST_SET(0),\n\t\tDEV_CLOCK_CFG_LINK_SPEED |\n\t\tDEV_CLOCK_CFG_PCS_RX_RST |\n\t\tDEV_CLOCK_CFG_PCS_TX_RST,\n\t\tlan966x, DEV_CLOCK_CFG(port->chip_port));\n\n\tport->config = *config;\n\n\treturn 0;\n}\n\nstatic void lan966x_port_qos_pcp_set(struct lan966x_port *port,\n\t\t\t\t     struct lan966x_port_qos_pcp *qos)\n{\n\tu8 *pcp_itr = qos->map;\n\tu8 pcp, dp;\n\n\tlan_rmw(ANA_QOS_CFG_QOS_PCP_ENA_SET(qos->enable),\n\t\tANA_QOS_CFG_QOS_PCP_ENA,\n\t\tport->lan966x, ANA_QOS_CFG(port->chip_port));\n\n\t \n\tfor (int i = 0; i < ARRAY_SIZE(qos->map); i++) {\n\t\tpcp = *(pcp_itr + i);\n\t\tdp = (i < LAN966X_PORT_QOS_PCP_COUNT) ? 0 : 1;\n\n\t\tlan_rmw(ANA_PCP_DEI_CFG_QOS_PCP_DEI_VAL_SET(pcp) |\n\t\t\tANA_PCP_DEI_CFG_DP_PCP_DEI_VAL_SET(dp),\n\t\t\tANA_PCP_DEI_CFG_QOS_PCP_DEI_VAL |\n\t\t\tANA_PCP_DEI_CFG_DP_PCP_DEI_VAL,\n\t\t\tport->lan966x,\n\t\t\tANA_PCP_DEI_CFG(port->chip_port, i));\n\t}\n}\n\nstatic void lan966x_port_qos_dscp_set(struct lan966x_port *port,\n\t\t\t\t      struct lan966x_port_qos_dscp *qos)\n{\n\tstruct lan966x *lan966x = port->lan966x;\n\n\t \n\tlan_rmw(ANA_QOS_CFG_QOS_DSCP_ENA_SET(qos->enable),\n\t\tANA_QOS_CFG_QOS_DSCP_ENA,\n\t\tlan966x, ANA_QOS_CFG(port->chip_port));\n\n\t \n\tfor (int i = 0; i < ARRAY_SIZE(qos->map); i++)\n\t\tlan_rmw(ANA_DSCP_CFG_DP_DSCP_VAL_SET(0) |\n\t\t\tANA_DSCP_CFG_QOS_DSCP_VAL_SET(*(qos->map + i)),\n\t\t\tANA_DSCP_CFG_DP_DSCP_VAL |\n\t\t\tANA_DSCP_CFG_QOS_DSCP_VAL,\n\t\t\tlan966x, ANA_DSCP_CFG(i));\n\n\t \n\tfor (int i = 0; i <  ARRAY_SIZE(qos->map); i++)\n\t\tlan_rmw(ANA_DSCP_CFG_DSCP_TRUST_ENA_SET(qos->enable),\n\t\t\tANA_DSCP_CFG_DSCP_TRUST_ENA,\n\t\t\tlan966x, ANA_DSCP_CFG(i));\n}\n\nstatic int lan966x_port_qos_default_set(struct lan966x_port *port,\n\t\t\t\t\tstruct lan966x_port_qos *qos)\n{\n\t \n\tlan_rmw(ANA_QOS_CFG_DP_DEFAULT_VAL_SET(0) |\n\t\tANA_QOS_CFG_QOS_DEFAULT_VAL_SET(qos->default_prio),\n\t\tANA_QOS_CFG_DP_DEFAULT_VAL |\n\t\tANA_QOS_CFG_QOS_DEFAULT_VAL,\n\t\tport->lan966x, ANA_QOS_CFG(port->chip_port));\n\n\t \n\tlan_rmw(ANA_VLAN_CFG_VLAN_DEI_SET(0) |\n\t\tANA_VLAN_CFG_VLAN_PCP_SET(0),\n\t\tANA_VLAN_CFG_VLAN_DEI |\n\t\tANA_VLAN_CFG_VLAN_PCP,\n\t\tport->lan966x, ANA_VLAN_CFG(port->chip_port));\n\n\treturn 0;\n}\n\nstatic void lan966x_port_qos_pcp_rewr_set(struct lan966x_port *port,\n\t\t\t\t\t  struct lan966x_port_qos_pcp_rewr *qos)\n{\n\tu8 mode = LAN966X_PORT_REW_TAG_CTRL_CLASSIFIED;\n\tu8 pcp, dei;\n\n\tif (qos->enable)\n\t\tmode = LAN966X_PORT_REW_TAG_CTRL_MAPPED;\n\n\t \n\tlan_rmw(REW_TAG_CFG_TAG_PCP_CFG_SET(mode) |\n\t\tREW_TAG_CFG_TAG_DEI_CFG_SET(mode),\n\t\tREW_TAG_CFG_TAG_PCP_CFG |\n\t\tREW_TAG_CFG_TAG_DEI_CFG,\n\t\tport->lan966x, REW_TAG_CFG(port->chip_port));\n\n\t \n\tfor (int i = 0; i < ARRAY_SIZE(qos->map); i++) {\n\t\tpcp = qos->map[i];\n\t\tif (pcp > LAN966X_PORT_QOS_PCP_COUNT)\n\t\t\tdei = 1;\n\t\telse\n\t\t\tdei = 0;\n\n\t\tlan_rmw(REW_PCP_DEI_CFG_DEI_QOS_VAL_SET(dei) |\n\t\t\tREW_PCP_DEI_CFG_PCP_QOS_VAL_SET(pcp),\n\t\t\tREW_PCP_DEI_CFG_DEI_QOS_VAL |\n\t\t\tREW_PCP_DEI_CFG_PCP_QOS_VAL,\n\t\t\tport->lan966x,\n\t\t\tREW_PCP_DEI_CFG(port->chip_port,\n\t\t\t\t\ti + dei * LAN966X_PORT_QOS_PCP_COUNT));\n\t}\n}\n\nstatic void lan966x_port_qos_dscp_rewr_set(struct lan966x_port *port,\n\t\t\t\t\t   struct lan966x_port_qos_dscp_rewr *qos)\n{\n\tu16 dscp;\n\tu8 mode;\n\n\tif (qos->enable)\n\t\tmode = LAN966X_PORT_REW_DSCP_ANALIZER;\n\telse\n\t\tmode = LAN966X_PORT_REW_DSCP_FRAME;\n\n\t \n\tlan_rmw(REW_DSCP_CFG_DSCP_REWR_CFG_SET(mode),\n\t\tREW_DSCP_CFG_DSCP_REWR_CFG,\n\t\tport->lan966x, REW_DSCP_CFG(port->chip_port));\n\n\t \n\tfor (int i = 0; i < ARRAY_SIZE(qos->map); i++) {\n\t\tdscp = qos->map[i];\n\n\t\tlan_rmw(ANA_DSCP_REWR_CFG_DSCP_QOS_REWR_VAL_SET(dscp),\n\t\t\tANA_DSCP_REWR_CFG_DSCP_QOS_REWR_VAL,\n\t\t\tport->lan966x, ANA_DSCP_REWR_CFG(i));\n\t}\n}\n\nvoid lan966x_port_qos_dscp_rewr_mode_set(struct lan966x_port *port,\n\t\t\t\t\t int mode)\n{\n\tlan_rmw(ANA_QOS_CFG_DSCP_REWR_CFG_SET(mode),\n\t\tANA_QOS_CFG_DSCP_REWR_CFG,\n\t\tport->lan966x, ANA_QOS_CFG(port->chip_port));\n}\n\nvoid lan966x_port_qos_set(struct lan966x_port *port,\n\t\t\t  struct lan966x_port_qos *qos)\n{\n\tlan966x_port_qos_pcp_set(port, &qos->pcp);\n\tlan966x_port_qos_dscp_set(port, &qos->dscp);\n\tlan966x_port_qos_default_set(port, qos);\n\tlan966x_port_qos_pcp_rewr_set(port, &qos->pcp_rewr);\n\tlan966x_port_qos_dscp_rewr_set(port, &qos->dscp_rewr);\n}\n\nvoid lan966x_port_init(struct lan966x_port *port)\n{\n\tstruct lan966x_port_config *config = &port->config;\n\tstruct lan966x *lan966x = port->lan966x;\n\n\tlan_rmw(ANA_PORT_CFG_LEARN_ENA_SET(0),\n\t\tANA_PORT_CFG_LEARN_ENA,\n\t\tlan966x, ANA_PORT_CFG(port->chip_port));\n\n\tlan966x_port_config_down(port);\n\n\tif (lan966x->fdma)\n\t\tlan966x_fdma_netdev_init(lan966x, port->dev);\n\n\tif (phy_interface_num_ports(config->portmode) != 4)\n\t\treturn;\n\n\tlan_rmw(DEV_CLOCK_CFG_PCS_RX_RST_SET(0) |\n\t\tDEV_CLOCK_CFG_PCS_TX_RST_SET(0) |\n\t\tDEV_CLOCK_CFG_LINK_SPEED_SET(LAN966X_SPEED_1000),\n\t\tDEV_CLOCK_CFG_PCS_RX_RST |\n\t\tDEV_CLOCK_CFG_PCS_TX_RST |\n\t\tDEV_CLOCK_CFG_LINK_SPEED,\n\t\tlan966x, DEV_CLOCK_CFG(port->chip_port));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}