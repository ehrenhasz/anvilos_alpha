{
  "module_name": "lan966x_ethtool.c",
  "hash_id": "0362e47118429cad18427045a751d26db2998444a0ea59dab5ec408e07b3acef",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/lan966x/lan966x_ethtool.c",
  "human_readable_source": "\n\n#include <linux/netdevice.h>\n\n#include \"lan966x_main.h\"\n\n \n#define LAN966X_NUM_TC\t\t\t8\n#define LAN966X_STATS_CHECK_DELAY\t(2 * HZ)\n\nstatic const struct lan966x_stat_layout lan966x_stats_layout[] = {\n\t{ .name = \"rx_octets\", .offset = 0x00, },\n\t{ .name = \"rx_unicast\", .offset = 0x01, },\n\t{ .name = \"rx_multicast\", .offset = 0x02 },\n\t{ .name = \"rx_broadcast\", .offset = 0x03 },\n\t{ .name = \"rx_short\", .offset = 0x04 },\n\t{ .name = \"rx_frag\", .offset = 0x05 },\n\t{ .name = \"rx_jabber\", .offset = 0x06 },\n\t{ .name = \"rx_crc\", .offset = 0x07 },\n\t{ .name = \"rx_symbol_err\", .offset = 0x08 },\n\t{ .name = \"rx_sz_64\", .offset = 0x09 },\n\t{ .name = \"rx_sz_65_127\", .offset = 0x0a},\n\t{ .name = \"rx_sz_128_255\", .offset = 0x0b},\n\t{ .name = \"rx_sz_256_511\", .offset = 0x0c },\n\t{ .name = \"rx_sz_512_1023\", .offset = 0x0d },\n\t{ .name = \"rx_sz_1024_1526\", .offset = 0x0e },\n\t{ .name = \"rx_sz_jumbo\", .offset = 0x0f },\n\t{ .name = \"rx_pause\", .offset = 0x10 },\n\t{ .name = \"rx_control\", .offset = 0x11 },\n\t{ .name = \"rx_long\", .offset = 0x12 },\n\t{ .name = \"rx_cat_drop\", .offset = 0x13 },\n\t{ .name = \"rx_red_prio_0\", .offset = 0x14 },\n\t{ .name = \"rx_red_prio_1\", .offset = 0x15 },\n\t{ .name = \"rx_red_prio_2\", .offset = 0x16 },\n\t{ .name = \"rx_red_prio_3\", .offset = 0x17 },\n\t{ .name = \"rx_red_prio_4\", .offset = 0x18 },\n\t{ .name = \"rx_red_prio_5\", .offset = 0x19 },\n\t{ .name = \"rx_red_prio_6\", .offset = 0x1a },\n\t{ .name = \"rx_red_prio_7\", .offset = 0x1b },\n\t{ .name = \"rx_yellow_prio_0\", .offset = 0x1c },\n\t{ .name = \"rx_yellow_prio_1\", .offset = 0x1d },\n\t{ .name = \"rx_yellow_prio_2\", .offset = 0x1e },\n\t{ .name = \"rx_yellow_prio_3\", .offset = 0x1f },\n\t{ .name = \"rx_yellow_prio_4\", .offset = 0x20 },\n\t{ .name = \"rx_yellow_prio_5\", .offset = 0x21 },\n\t{ .name = \"rx_yellow_prio_6\", .offset = 0x22 },\n\t{ .name = \"rx_yellow_prio_7\", .offset = 0x23 },\n\t{ .name = \"rx_green_prio_0\", .offset = 0x24 },\n\t{ .name = \"rx_green_prio_1\", .offset = 0x25 },\n\t{ .name = \"rx_green_prio_2\", .offset = 0x26 },\n\t{ .name = \"rx_green_prio_3\", .offset = 0x27 },\n\t{ .name = \"rx_green_prio_4\", .offset = 0x28 },\n\t{ .name = \"rx_green_prio_5\", .offset = 0x29 },\n\t{ .name = \"rx_green_prio_6\", .offset = 0x2a },\n\t{ .name = \"rx_green_prio_7\", .offset = 0x2b },\n\t{ .name = \"rx_assembly_err\", .offset = 0x2c },\n\t{ .name = \"rx_smd_err\", .offset = 0x2d },\n\t{ .name = \"rx_assembly_ok\", .offset = 0x2e },\n\t{ .name = \"rx_merge_frag\", .offset = 0x2f },\n\t{ .name = \"rx_pmac_octets\", .offset = 0x30, },\n\t{ .name = \"rx_pmac_unicast\", .offset = 0x31, },\n\t{ .name = \"rx_pmac_multicast\", .offset = 0x32 },\n\t{ .name = \"rx_pmac_broadcast\", .offset = 0x33 },\n\t{ .name = \"rx_pmac_short\", .offset = 0x34 },\n\t{ .name = \"rx_pmac_frag\", .offset = 0x35 },\n\t{ .name = \"rx_pmac_jabber\", .offset = 0x36 },\n\t{ .name = \"rx_pmac_crc\", .offset = 0x37 },\n\t{ .name = \"rx_pmac_symbol_err\", .offset = 0x38 },\n\t{ .name = \"rx_pmac_sz_64\", .offset = 0x39 },\n\t{ .name = \"rx_pmac_sz_65_127\", .offset = 0x3a },\n\t{ .name = \"rx_pmac_sz_128_255\", .offset = 0x3b },\n\t{ .name = \"rx_pmac_sz_256_511\", .offset = 0x3c },\n\t{ .name = \"rx_pmac_sz_512_1023\", .offset = 0x3d },\n\t{ .name = \"rx_pmac_sz_1024_1526\", .offset = 0x3e },\n\t{ .name = \"rx_pmac_sz_jumbo\", .offset = 0x3f },\n\t{ .name = \"rx_pmac_pause\", .offset = 0x40 },\n\t{ .name = \"rx_pmac_control\", .offset = 0x41 },\n\t{ .name = \"rx_pmac_long\", .offset = 0x42 },\n\n\t{ .name = \"tx_octets\", .offset = 0x80, },\n\t{ .name = \"tx_unicast\", .offset = 0x81, },\n\t{ .name = \"tx_multicast\", .offset = 0x82 },\n\t{ .name = \"tx_broadcast\", .offset = 0x83 },\n\t{ .name = \"tx_col\", .offset = 0x84 },\n\t{ .name = \"tx_drop\", .offset = 0x85 },\n\t{ .name = \"tx_pause\", .offset = 0x86 },\n\t{ .name = \"tx_sz_64\", .offset = 0x87 },\n\t{ .name = \"tx_sz_65_127\", .offset = 0x88 },\n\t{ .name = \"tx_sz_128_255\", .offset = 0x89 },\n\t{ .name = \"tx_sz_256_511\", .offset = 0x8a },\n\t{ .name = \"tx_sz_512_1023\", .offset = 0x8b },\n\t{ .name = \"tx_sz_1024_1526\", .offset = 0x8c },\n\t{ .name = \"tx_sz_jumbo\", .offset = 0x8d },\n\t{ .name = \"tx_yellow_prio_0\", .offset = 0x8e },\n\t{ .name = \"tx_yellow_prio_1\", .offset = 0x8f },\n\t{ .name = \"tx_yellow_prio_2\", .offset = 0x90 },\n\t{ .name = \"tx_yellow_prio_3\", .offset = 0x91 },\n\t{ .name = \"tx_yellow_prio_4\", .offset = 0x92 },\n\t{ .name = \"tx_yellow_prio_5\", .offset = 0x93 },\n\t{ .name = \"tx_yellow_prio_6\", .offset = 0x94 },\n\t{ .name = \"tx_yellow_prio_7\", .offset = 0x95 },\n\t{ .name = \"tx_green_prio_0\", .offset = 0x96 },\n\t{ .name = \"tx_green_prio_1\", .offset = 0x97 },\n\t{ .name = \"tx_green_prio_2\", .offset = 0x98 },\n\t{ .name = \"tx_green_prio_3\", .offset = 0x99 },\n\t{ .name = \"tx_green_prio_4\", .offset = 0x9a },\n\t{ .name = \"tx_green_prio_5\", .offset = 0x9b },\n\t{ .name = \"tx_green_prio_6\", .offset = 0x9c },\n\t{ .name = \"tx_green_prio_7\", .offset = 0x9d },\n\t{ .name = \"tx_aged\", .offset = 0x9e },\n\t{ .name = \"tx_llct\", .offset = 0x9f },\n\t{ .name = \"tx_ct\", .offset = 0xa0 },\n\t{ .name = \"tx_mm_hold\", .offset = 0xa1 },\n\t{ .name = \"tx_merge_frag\", .offset = 0xa2 },\n\t{ .name = \"tx_pmac_octets\", .offset = 0xa3, },\n\t{ .name = \"tx_pmac_unicast\", .offset = 0xa4, },\n\t{ .name = \"tx_pmac_multicast\", .offset = 0xa5 },\n\t{ .name = \"tx_pmac_broadcast\", .offset = 0xa6 },\n\t{ .name = \"tx_pmac_pause\", .offset = 0xa7 },\n\t{ .name = \"tx_pmac_sz_64\", .offset = 0xa8 },\n\t{ .name = \"tx_pmac_sz_65_127\", .offset = 0xa9 },\n\t{ .name = \"tx_pmac_sz_128_255\", .offset = 0xaa },\n\t{ .name = \"tx_pmac_sz_256_511\", .offset = 0xab },\n\t{ .name = \"tx_pmac_sz_512_1023\", .offset = 0xac },\n\t{ .name = \"tx_pmac_sz_1024_1526\", .offset = 0xad },\n\t{ .name = \"tx_pmac_sz_jumbo\", .offset = 0xae },\n\n\t{ .name = \"dr_local\", .offset = 0x100 },\n\t{ .name = \"dr_tail\", .offset = 0x101 },\n\t{ .name = \"dr_yellow_prio_0\", .offset = 0x102 },\n\t{ .name = \"dr_yellow_prio_1\", .offset = 0x103 },\n\t{ .name = \"dr_yellow_prio_2\", .offset = 0x104 },\n\t{ .name = \"dr_yellow_prio_3\", .offset = 0x105 },\n\t{ .name = \"dr_yellow_prio_4\", .offset = 0x106 },\n\t{ .name = \"dr_yellow_prio_5\", .offset = 0x107 },\n\t{ .name = \"dr_yellow_prio_6\", .offset = 0x108 },\n\t{ .name = \"dr_yellow_prio_7\", .offset = 0x109 },\n\t{ .name = \"dr_green_prio_0\", .offset = 0x10a },\n\t{ .name = \"dr_green_prio_1\", .offset = 0x10b },\n\t{ .name = \"dr_green_prio_2\", .offset = 0x10c },\n\t{ .name = \"dr_green_prio_3\", .offset = 0x10d },\n\t{ .name = \"dr_green_prio_4\", .offset = 0x10e },\n\t{ .name = \"dr_green_prio_5\", .offset = 0x10f },\n\t{ .name = \"dr_green_prio_6\", .offset = 0x110 },\n\t{ .name = \"dr_green_prio_7\", .offset = 0x111 },\n};\n\n \n#define SYS_COUNT_RX_OCT\t\t  0\n#define SYS_COUNT_RX_UC\t\t\t  1\n#define SYS_COUNT_RX_MC\t\t\t  2\n#define SYS_COUNT_RX_BC\t\t\t  3\n#define SYS_COUNT_RX_SHORT\t\t  4\n#define SYS_COUNT_RX_FRAG\t\t  5\n#define SYS_COUNT_RX_JABBER\t\t  6\n#define SYS_COUNT_RX_CRC\t\t  7\n#define SYS_COUNT_RX_SYMBOL_ERR\t\t  8\n#define SYS_COUNT_RX_SZ_64\t\t  9\n#define SYS_COUNT_RX_SZ_65_127\t\t 10\n#define SYS_COUNT_RX_SZ_128_255\t\t 11\n#define SYS_COUNT_RX_SZ_256_511\t\t 12\n#define SYS_COUNT_RX_SZ_512_1023\t 13\n#define SYS_COUNT_RX_SZ_1024_1526\t 14\n#define SYS_COUNT_RX_SZ_JUMBO\t\t 15\n#define SYS_COUNT_RX_PAUSE\t\t 16\n#define SYS_COUNT_RX_CONTROL\t\t 17\n#define SYS_COUNT_RX_LONG\t\t 18\n#define SYS_COUNT_RX_CAT_DROP\t\t 19\n#define SYS_COUNT_RX_RED_PRIO_0\t\t 20\n#define SYS_COUNT_RX_RED_PRIO_1\t\t 21\n#define SYS_COUNT_RX_RED_PRIO_2\t\t 22\n#define SYS_COUNT_RX_RED_PRIO_3\t\t 23\n#define SYS_COUNT_RX_RED_PRIO_4\t\t 24\n#define SYS_COUNT_RX_RED_PRIO_5\t\t 25\n#define SYS_COUNT_RX_RED_PRIO_6\t\t 26\n#define SYS_COUNT_RX_RED_PRIO_7\t\t 27\n#define SYS_COUNT_RX_YELLOW_PRIO_0\t 28\n#define SYS_COUNT_RX_YELLOW_PRIO_1\t 29\n#define SYS_COUNT_RX_YELLOW_PRIO_2\t 30\n#define SYS_COUNT_RX_YELLOW_PRIO_3\t 31\n#define SYS_COUNT_RX_YELLOW_PRIO_4\t 32\n#define SYS_COUNT_RX_YELLOW_PRIO_5\t 33\n#define SYS_COUNT_RX_YELLOW_PRIO_6\t 34\n#define SYS_COUNT_RX_YELLOW_PRIO_7\t 35\n#define SYS_COUNT_RX_GREEN_PRIO_0\t 36\n#define SYS_COUNT_RX_GREEN_PRIO_1\t 37\n#define SYS_COUNT_RX_GREEN_PRIO_2\t 38\n#define SYS_COUNT_RX_GREEN_PRIO_3\t 39\n#define SYS_COUNT_RX_GREEN_PRIO_4\t 40\n#define SYS_COUNT_RX_GREEN_PRIO_5\t 41\n#define SYS_COUNT_RX_GREEN_PRIO_6\t 42\n#define SYS_COUNT_RX_GREEN_PRIO_7\t 43\n#define SYS_COUNT_RX_ASSEMBLY_ERR\t 44\n#define SYS_COUNT_RX_SMD_ERR\t\t 45\n#define SYS_COUNT_RX_ASSEMBLY_OK\t 46\n#define SYS_COUNT_RX_MERGE_FRAG\t\t 47\n#define SYS_COUNT_RX_PMAC_OCT\t\t 48\n#define SYS_COUNT_RX_PMAC_UC\t\t 49\n#define SYS_COUNT_RX_PMAC_MC\t\t 50\n#define SYS_COUNT_RX_PMAC_BC\t\t 51\n#define SYS_COUNT_RX_PMAC_SHORT\t\t 52\n#define SYS_COUNT_RX_PMAC_FRAG\t\t 53\n#define SYS_COUNT_RX_PMAC_JABBER\t 54\n#define SYS_COUNT_RX_PMAC_CRC\t\t 55\n#define SYS_COUNT_RX_PMAC_SYMBOL_ERR\t 56\n#define SYS_COUNT_RX_PMAC_SZ_64\t\t 57\n#define SYS_COUNT_RX_PMAC_SZ_65_127\t 58\n#define SYS_COUNT_RX_PMAC_SZ_128_255\t 59\n#define SYS_COUNT_RX_PMAC_SZ_256_511\t 60\n#define SYS_COUNT_RX_PMAC_SZ_512_1023\t 61\n#define SYS_COUNT_RX_PMAC_SZ_1024_1526\t 62\n#define SYS_COUNT_RX_PMAC_SZ_JUMBO\t 63\n#define SYS_COUNT_RX_PMAC_PAUSE\t\t 64\n#define SYS_COUNT_RX_PMAC_CONTROL\t 65\n#define SYS_COUNT_RX_PMAC_LONG\t\t 66\n\n#define SYS_COUNT_TX_OCT\t\t 67\n#define SYS_COUNT_TX_UC\t\t\t 68\n#define SYS_COUNT_TX_MC\t\t\t 69\n#define SYS_COUNT_TX_BC\t\t\t 70\n#define SYS_COUNT_TX_COL\t\t 71\n#define SYS_COUNT_TX_DROP\t\t 72\n#define SYS_COUNT_TX_PAUSE\t\t 73\n#define SYS_COUNT_TX_SZ_64\t\t 74\n#define SYS_COUNT_TX_SZ_65_127\t\t 75\n#define SYS_COUNT_TX_SZ_128_255\t\t 76\n#define SYS_COUNT_TX_SZ_256_511\t\t 77\n#define SYS_COUNT_TX_SZ_512_1023\t 78\n#define SYS_COUNT_TX_SZ_1024_1526\t 79\n#define SYS_COUNT_TX_SZ_JUMBO\t\t 80\n#define SYS_COUNT_TX_YELLOW_PRIO_0\t 81\n#define SYS_COUNT_TX_YELLOW_PRIO_1\t 82\n#define SYS_COUNT_TX_YELLOW_PRIO_2\t 83\n#define SYS_COUNT_TX_YELLOW_PRIO_3\t 84\n#define SYS_COUNT_TX_YELLOW_PRIO_4\t 85\n#define SYS_COUNT_TX_YELLOW_PRIO_5\t 86\n#define SYS_COUNT_TX_YELLOW_PRIO_6\t 87\n#define SYS_COUNT_TX_YELLOW_PRIO_7\t 88\n#define SYS_COUNT_TX_GREEN_PRIO_0\t 89\n#define SYS_COUNT_TX_GREEN_PRIO_1\t 90\n#define SYS_COUNT_TX_GREEN_PRIO_2\t 91\n#define SYS_COUNT_TX_GREEN_PRIO_3\t 92\n#define SYS_COUNT_TX_GREEN_PRIO_4\t 93\n#define SYS_COUNT_TX_GREEN_PRIO_5\t 94\n#define SYS_COUNT_TX_GREEN_PRIO_6\t 95\n#define SYS_COUNT_TX_GREEN_PRIO_7\t 96\n#define SYS_COUNT_TX_AGED\t\t 97\n#define SYS_COUNT_TX_LLCT\t\t 98\n#define SYS_COUNT_TX_CT\t\t\t 99\n#define SYS_COUNT_TX_MM_HOLD\t\t100\n#define SYS_COUNT_TX_MERGE_FRAG\t\t101\n#define SYS_COUNT_TX_PMAC_OCT\t\t102\n#define SYS_COUNT_TX_PMAC_UC\t\t103\n#define SYS_COUNT_TX_PMAC_MC\t\t104\n#define SYS_COUNT_TX_PMAC_BC\t\t105\n#define SYS_COUNT_TX_PMAC_PAUSE\t\t106\n#define SYS_COUNT_TX_PMAC_SZ_64\t\t107\n#define SYS_COUNT_TX_PMAC_SZ_65_127\t108\n#define SYS_COUNT_TX_PMAC_SZ_128_255\t109\n#define SYS_COUNT_TX_PMAC_SZ_256_511\t110\n#define SYS_COUNT_TX_PMAC_SZ_512_1023\t111\n#define SYS_COUNT_TX_PMAC_SZ_1024_1526\t112\n#define SYS_COUNT_TX_PMAC_SZ_JUMBO\t113\n\n#define SYS_COUNT_DR_LOCAL\t\t114\n#define SYS_COUNT_DR_TAIL\t\t115\n#define SYS_COUNT_DR_YELLOW_PRIO_0\t116\n#define SYS_COUNT_DR_YELLOW_PRIO_1\t117\n#define SYS_COUNT_DR_YELLOW_PRIO_2\t118\n#define SYS_COUNT_DR_YELLOW_PRIO_3\t119\n#define SYS_COUNT_DR_YELLOW_PRIO_4\t120\n#define SYS_COUNT_DR_YELLOW_PRIO_5\t121\n#define SYS_COUNT_DR_YELLOW_PRIO_6\t122\n#define SYS_COUNT_DR_YELLOW_PRIO_7\t123\n#define SYS_COUNT_DR_GREEN_PRIO_0\t124\n#define SYS_COUNT_DR_GREEN_PRIO_1\t125\n#define SYS_COUNT_DR_GREEN_PRIO_2\t126\n#define SYS_COUNT_DR_GREEN_PRIO_3\t127\n#define SYS_COUNT_DR_GREEN_PRIO_4\t128\n#define SYS_COUNT_DR_GREEN_PRIO_5\t129\n#define SYS_COUNT_DR_GREEN_PRIO_6\t130\n#define SYS_COUNT_DR_GREEN_PRIO_7\t131\n\n \nstatic void lan966x_add_cnt(u64 *cnt, u32 val)\n{\n\tif (val < (*cnt & U32_MAX))\n\t\t*cnt += (u64)1 << 32;  \n\n\t*cnt = (*cnt & ~(u64)U32_MAX) + val;\n}\n\nstatic void lan966x_stats_update(struct lan966x *lan966x)\n{\n\tint i, j;\n\n\tmutex_lock(&lan966x->stats_lock);\n\n\tfor (i = 0; i < lan966x->num_phys_ports; i++) {\n\t\tuint idx = i * lan966x->num_stats;\n\n\t\tlan_wr(SYS_STAT_CFG_STAT_VIEW_SET(i),\n\t\t       lan966x, SYS_STAT_CFG);\n\n\t\tfor (j = 0; j < lan966x->num_stats; j++) {\n\t\t\tu32 offset = lan966x->stats_layout[j].offset;\n\n\t\t\tlan966x_add_cnt(&lan966x->stats[idx++],\n\t\t\t\t\tlan_rd(lan966x, SYS_CNT(offset)));\n\t\t}\n\t}\n\n\tmutex_unlock(&lan966x->stats_lock);\n}\n\nstatic int lan966x_get_sset_count(struct net_device *dev, int sset)\n{\n\tstruct lan966x_port *port = netdev_priv(dev);\n\tstruct lan966x *lan966x = port->lan966x;\n\n\tif (sset != ETH_SS_STATS)\n\t\treturn -EOPNOTSUPP;\n\n\treturn lan966x->num_stats;\n}\n\nstatic void lan966x_get_strings(struct net_device *netdev, u32 sset, u8 *data)\n{\n\tstruct lan966x_port *port = netdev_priv(netdev);\n\tstruct lan966x *lan966x = port->lan966x;\n\tint i;\n\n\tif (sset != ETH_SS_STATS)\n\t\treturn;\n\n\tfor (i = 0; i < lan966x->num_stats; i++)\n\t\tmemcpy(data + i * ETH_GSTRING_LEN,\n\t\t       lan966x->stats_layout[i].name, ETH_GSTRING_LEN);\n}\n\nstatic void lan966x_get_ethtool_stats(struct net_device *dev,\n\t\t\t\t      struct ethtool_stats *stats, u64 *data)\n{\n\tstruct lan966x_port *port = netdev_priv(dev);\n\tstruct lan966x *lan966x = port->lan966x;\n\tint i;\n\n\t \n\tlan966x_stats_update(lan966x);\n\n\t \n\tfor (i = 0; i < lan966x->num_stats; i++)\n\t\t*data++ = lan966x->stats[port->chip_port *\n\t\t\t\t\t lan966x->num_stats + i];\n}\n\nstatic void lan966x_get_eth_mac_stats(struct net_device *dev,\n\t\t\t\t      struct ethtool_eth_mac_stats *mac_stats)\n{\n\tstruct lan966x_port *port = netdev_priv(dev);\n\tstruct lan966x *lan966x = port->lan966x;\n\tu32 idx;\n\n\tlan966x_stats_update(lan966x);\n\n\tidx = port->chip_port * lan966x->num_stats;\n\n\tmutex_lock(&lan966x->stats_lock);\n\n\tmac_stats->FramesTransmittedOK =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_UC] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_MC] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_BC] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_UC] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_MC] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_BC];\n\tmac_stats->SingleCollisionFrames =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_COL];\n\tmac_stats->MultipleCollisionFrames = 0;\n\tmac_stats->FramesReceivedOK =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_UC] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_MC] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_BC];\n\tmac_stats->FrameCheckSequenceErrors =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_CRC] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_CRC];\n\tmac_stats->AlignmentErrors = 0;\n\tmac_stats->OctetsTransmittedOK =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_OCT] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_OCT];\n\tmac_stats->FramesWithDeferredXmissions =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_MM_HOLD];\n\tmac_stats->LateCollisions = 0;\n\tmac_stats->FramesAbortedDueToXSColls = 0;\n\tmac_stats->FramesLostDueToIntMACXmitError = 0;\n\tmac_stats->CarrierSenseErrors = 0;\n\tmac_stats->OctetsReceivedOK =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_OCT];\n\tmac_stats->FramesLostDueToIntMACRcvError = 0;\n\tmac_stats->MulticastFramesXmittedOK =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_MC] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_MC];\n\tmac_stats->BroadcastFramesXmittedOK =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_BC] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_BC];\n\tmac_stats->FramesWithExcessiveDeferral = 0;\n\tmac_stats->MulticastFramesReceivedOK =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_MC];\n\tmac_stats->BroadcastFramesReceivedOK =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_BC];\n\tmac_stats->InRangeLengthErrors =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_FRAG] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_JABBER] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_CRC] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_FRAG] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_JABBER] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_CRC];\n\tmac_stats->OutOfRangeLengthField =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SHORT] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SHORT] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_LONG] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_LONG];\n\tmac_stats->FrameTooLongErrors =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_LONG] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_LONG];\n\n\tmutex_unlock(&lan966x->stats_lock);\n}\n\nstatic const struct ethtool_rmon_hist_range lan966x_rmon_ranges[] = {\n\t{    0,    64 },\n\t{   65,   127 },\n\t{  128,   255 },\n\t{  256,   511 },\n\t{  512,  1023 },\n\t{ 1024,  1518 },\n\t{ 1519, 10239 },\n\t{}\n};\n\nstatic void lan966x_get_eth_rmon_stats(struct net_device *dev,\n\t\t\t\t       struct ethtool_rmon_stats *rmon_stats,\n\t\t\t\t       const struct ethtool_rmon_hist_range **ranges)\n{\n\tstruct lan966x_port *port = netdev_priv(dev);\n\tstruct lan966x *lan966x = port->lan966x;\n\tu32 idx;\n\n\tlan966x_stats_update(lan966x);\n\n\tidx = port->chip_port * lan966x->num_stats;\n\n\tmutex_lock(&lan966x->stats_lock);\n\n\trmon_stats->undersize_pkts =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SHORT] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SHORT];\n\trmon_stats->oversize_pkts =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_LONG] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_LONG];\n\trmon_stats->fragments =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_FRAG] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_FRAG];\n\trmon_stats->jabbers =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_JABBER] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_JABBER];\n\trmon_stats->hist[0] =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_64] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_64];\n\trmon_stats->hist[1] =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_65_127] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_65_127];\n\trmon_stats->hist[2] =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_128_255] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_128_255];\n\trmon_stats->hist[3] =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_256_511] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_256_511];\n\trmon_stats->hist[4] =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_512_1023] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_512_1023];\n\trmon_stats->hist[5] =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_1024_1526] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_1024_1526];\n\trmon_stats->hist[6] =\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_1024_1526] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_1024_1526];\n\n\trmon_stats->hist_tx[0] =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_64] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_64];\n\trmon_stats->hist_tx[1] =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_65_127] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_65_127];\n\trmon_stats->hist_tx[2] =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_128_255] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_128_255];\n\trmon_stats->hist_tx[3] =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_256_511] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_256_511];\n\trmon_stats->hist_tx[4] =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_512_1023] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_512_1023];\n\trmon_stats->hist_tx[5] =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_1024_1526] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_1024_1526];\n\trmon_stats->hist_tx[6] =\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_1024_1526] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_1024_1526];\n\n\tmutex_unlock(&lan966x->stats_lock);\n\n\t*ranges = lan966x_rmon_ranges;\n}\n\nstatic int lan966x_get_link_ksettings(struct net_device *ndev,\n\t\t\t\t      struct ethtool_link_ksettings *cmd)\n{\n\tstruct lan966x_port *port = netdev_priv(ndev);\n\n\treturn phylink_ethtool_ksettings_get(port->phylink, cmd);\n}\n\nstatic int lan966x_set_link_ksettings(struct net_device *ndev,\n\t\t\t\t      const struct ethtool_link_ksettings *cmd)\n{\n\tstruct lan966x_port *port = netdev_priv(ndev);\n\n\treturn phylink_ethtool_ksettings_set(port->phylink, cmd);\n}\n\nstatic void lan966x_get_pauseparam(struct net_device *dev,\n\t\t\t\t   struct ethtool_pauseparam *pause)\n{\n\tstruct lan966x_port *port = netdev_priv(dev);\n\n\tphylink_ethtool_get_pauseparam(port->phylink, pause);\n}\n\nstatic int lan966x_set_pauseparam(struct net_device *dev,\n\t\t\t\t  struct ethtool_pauseparam *pause)\n{\n\tstruct lan966x_port *port = netdev_priv(dev);\n\n\treturn phylink_ethtool_set_pauseparam(port->phylink, pause);\n}\n\nstatic int lan966x_get_ts_info(struct net_device *dev,\n\t\t\t       struct ethtool_ts_info *info)\n{\n\tstruct lan966x_port *port = netdev_priv(dev);\n\tstruct lan966x *lan966x = port->lan966x;\n\tstruct lan966x_phc *phc;\n\n\tif (!lan966x->ptp)\n\t\treturn ethtool_op_get_ts_info(dev, info);\n\n\tphc = &lan966x->phc[LAN966X_PHC_PORT];\n\n\tinfo->phc_index = phc->clock ? ptp_clock_index(phc->clock) : -1;\n\tif (info->phc_index == -1) {\n\t\tinfo->so_timestamping |= SOF_TIMESTAMPING_TX_SOFTWARE |\n\t\t\t\t\t SOF_TIMESTAMPING_RX_SOFTWARE |\n\t\t\t\t\t SOF_TIMESTAMPING_SOFTWARE;\n\t\treturn 0;\n\t}\n\tinfo->so_timestamping |= SOF_TIMESTAMPING_TX_SOFTWARE |\n\t\t\t\t SOF_TIMESTAMPING_RX_SOFTWARE |\n\t\t\t\t SOF_TIMESTAMPING_SOFTWARE |\n\t\t\t\t SOF_TIMESTAMPING_TX_HARDWARE |\n\t\t\t\t SOF_TIMESTAMPING_RX_HARDWARE |\n\t\t\t\t SOF_TIMESTAMPING_RAW_HARDWARE;\n\tinfo->tx_types = BIT(HWTSTAMP_TX_OFF) | BIT(HWTSTAMP_TX_ON) |\n\t\t\t BIT(HWTSTAMP_TX_ONESTEP_SYNC);\n\tinfo->rx_filters = BIT(HWTSTAMP_FILTER_NONE) |\n\t\t\t   BIT(HWTSTAMP_FILTER_ALL);\n\n\treturn 0;\n}\n\nconst struct ethtool_ops lan966x_ethtool_ops = {\n\t.get_link_ksettings     = lan966x_get_link_ksettings,\n\t.set_link_ksettings     = lan966x_set_link_ksettings,\n\t.get_pauseparam\t\t= lan966x_get_pauseparam,\n\t.set_pauseparam\t\t= lan966x_set_pauseparam,\n\t.get_sset_count\t\t= lan966x_get_sset_count,\n\t.get_strings\t\t= lan966x_get_strings,\n\t.get_ethtool_stats\t= lan966x_get_ethtool_stats,\n\t.get_eth_mac_stats      = lan966x_get_eth_mac_stats,\n\t.get_rmon_stats\t\t= lan966x_get_eth_rmon_stats,\n\t.get_link\t\t= ethtool_op_get_link,\n\t.get_ts_info\t\t= lan966x_get_ts_info,\n};\n\nstatic void lan966x_check_stats_work(struct work_struct *work)\n{\n\tstruct delayed_work *del_work = to_delayed_work(work);\n\tstruct lan966x *lan966x = container_of(del_work, struct lan966x,\n\t\t\t\t\t       stats_work);\n\n\tlan966x_stats_update(lan966x);\n\n\tqueue_delayed_work(lan966x->stats_queue, &lan966x->stats_work,\n\t\t\t   LAN966X_STATS_CHECK_DELAY);\n}\n\nvoid lan966x_stats_get(struct net_device *dev,\n\t\t       struct rtnl_link_stats64 *stats)\n{\n\tstruct lan966x_port *port = netdev_priv(dev);\n\tstruct lan966x *lan966x = port->lan966x;\n\tu32 idx;\n\tint i;\n\n\tidx = port->chip_port * lan966x->num_stats;\n\n\tmutex_lock(&lan966x->stats_lock);\n\n\tstats->rx_bytes = lan966x->stats[idx + SYS_COUNT_RX_OCT] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_OCT];\n\n\tstats->rx_packets = lan966x->stats[idx + SYS_COUNT_RX_SHORT] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_FRAG] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_JABBER] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_CRC] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SYMBOL_ERR] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_64] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_65_127] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_128_255] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_256_511] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_512_1023] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_1024_1526] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SZ_JUMBO] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_LONG] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SHORT] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_FRAG] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_JABBER] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_64] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_65_127] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_128_255] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_256_511] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_512_1023] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_1024_1526] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_SZ_JUMBO];\n\n\tstats->multicast = lan966x->stats[idx + SYS_COUNT_RX_MC] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_PMAC_MC];\n\n\tstats->rx_errors = lan966x->stats[idx + SYS_COUNT_RX_SHORT] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_FRAG] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_JABBER] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_CRC] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_SYMBOL_ERR] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_LONG];\n\n\tstats->rx_dropped = dev->stats.rx_dropped +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_LONG] +\n\t\tlan966x->stats[idx + SYS_COUNT_DR_LOCAL] +\n\t\tlan966x->stats[idx + SYS_COUNT_DR_TAIL] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_RED_PRIO_0] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_RED_PRIO_1] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_RED_PRIO_2] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_RED_PRIO_3] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_RED_PRIO_4] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_RED_PRIO_5] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_RED_PRIO_6] +\n\t\tlan966x->stats[idx + SYS_COUNT_RX_RED_PRIO_7];\n\n\tfor (i = 0; i < LAN966X_NUM_TC; i++) {\n\t\tstats->rx_dropped +=\n\t\t\t(lan966x->stats[idx + SYS_COUNT_DR_YELLOW_PRIO_0 + i] +\n\t\t\t lan966x->stats[idx + SYS_COUNT_DR_GREEN_PRIO_0 + i]);\n\t}\n\n\t \n\tstats->tx_bytes = lan966x->stats[idx + SYS_COUNT_TX_OCT] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_OCT];\n\n\tstats->tx_packets = lan966x->stats[idx + SYS_COUNT_TX_SZ_64] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_65_127] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_128_255] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_256_511] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_512_1023] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_1024_1526] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_SZ_JUMBO] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_64] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_65_127] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_128_255] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_256_511] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_512_1023] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_1024_1526] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_PMAC_SZ_JUMBO];\n\n\tstats->tx_dropped = lan966x->stats[idx + SYS_COUNT_TX_DROP] +\n\t\tlan966x->stats[idx + SYS_COUNT_TX_AGED];\n\n\tstats->collisions = lan966x->stats[idx + SYS_COUNT_TX_COL];\n\n\tmutex_unlock(&lan966x->stats_lock);\n}\n\nint lan966x_stats_init(struct lan966x *lan966x)\n{\n\tchar queue_name[32];\n\n\tlan966x->stats_layout = lan966x_stats_layout;\n\tlan966x->num_stats = ARRAY_SIZE(lan966x_stats_layout);\n\tlan966x->stats = devm_kcalloc(lan966x->dev, lan966x->num_phys_ports *\n\t\t\t\t      lan966x->num_stats,\n\t\t\t\t      sizeof(u64), GFP_KERNEL);\n\tif (!lan966x->stats)\n\t\treturn -ENOMEM;\n\n\t \n\tmutex_init(&lan966x->stats_lock);\n\tsnprintf(queue_name, sizeof(queue_name), \"%s-stats\",\n\t\t dev_name(lan966x->dev));\n\tlan966x->stats_queue = create_singlethread_workqueue(queue_name);\n\tif (!lan966x->stats_queue)\n\t\treturn -ENOMEM;\n\n\tINIT_DELAYED_WORK(&lan966x->stats_work, lan966x_check_stats_work);\n\tqueue_delayed_work(lan966x->stats_queue, &lan966x->stats_work,\n\t\t\t   LAN966X_STATS_CHECK_DELAY);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}