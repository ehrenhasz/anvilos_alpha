{
  "module_name": "sparx5_psfp.c",
  "hash_id": "95403c3e7264e1baf6fc87ddd221ae6118173e78d084b0013632c1cd8933b9d4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/sparx5/sparx5_psfp.c",
  "human_readable_source": "\n \n\n#include \"sparx5_main_regs.h\"\n#include \"sparx5_main.h\"\n\n#define SPX5_PSFP_SF_CNT 1024\n#define SPX5_PSFP_SG_CONFIG_CHANGE_SLEEP 1000\n#define SPX5_PSFP_SG_CONFIG_CHANGE_TIMEO 100000\n\n \nstatic struct sparx5_pool_entry sparx5_psfp_fm_pool[SPX5_SDLB_CNT];\n\n \nstatic struct sparx5_pool_entry sparx5_psfp_sg_pool[SPX5_PSFP_SG_CNT];\n\n \nstatic struct sparx5_pool_entry sparx5_psfp_sf_pool[SPX5_PSFP_SF_CNT];\n\nstatic int sparx5_psfp_sf_get(u32 *id)\n{\n\treturn sparx5_pool_get(sparx5_psfp_sf_pool, SPX5_PSFP_SF_CNT, id);\n}\n\nstatic int sparx5_psfp_sf_put(u32 id)\n{\n\treturn sparx5_pool_put(sparx5_psfp_sf_pool, SPX5_PSFP_SF_CNT, id);\n}\n\nstatic int sparx5_psfp_sg_get(u32 idx, u32 *id)\n{\n\treturn sparx5_pool_get_with_idx(sparx5_psfp_sg_pool, SPX5_PSFP_SG_CNT,\n\t\t\t\t\tidx, id);\n}\n\nstatic int sparx5_psfp_sg_put(u32 id)\n{\n\treturn sparx5_pool_put(sparx5_psfp_sg_pool, SPX5_PSFP_SG_CNT, id);\n}\n\nstatic int sparx5_psfp_fm_get(u32 idx, u32 *id)\n{\n\treturn sparx5_pool_get_with_idx(sparx5_psfp_fm_pool, SPX5_SDLB_CNT, idx,\n\t\t\t\t\tid);\n}\n\nstatic int sparx5_psfp_fm_put(u32 id)\n{\n\treturn sparx5_pool_put(sparx5_psfp_fm_pool, SPX5_SDLB_CNT, id);\n}\n\nu32 sparx5_psfp_isdx_get_sf(struct sparx5 *sparx5, u32 isdx)\n{\n\treturn ANA_L2_TSN_CFG_TSN_SFID_GET(spx5_rd(sparx5,\n\t\t\t\t\t\t   ANA_L2_TSN_CFG(isdx)));\n}\n\nu32 sparx5_psfp_isdx_get_fm(struct sparx5 *sparx5, u32 isdx)\n{\n\treturn ANA_L2_DLB_CFG_DLB_IDX_GET(spx5_rd(sparx5,\n\t\t\t\t\t\t  ANA_L2_DLB_CFG(isdx)));\n}\n\nu32 sparx5_psfp_sf_get_sg(struct sparx5 *sparx5, u32 sfid)\n{\n\treturn ANA_AC_TSN_SF_CFG_TSN_SGID_GET(spx5_rd(sparx5,\n\t\t\t\t\t\t      ANA_AC_TSN_SF_CFG(sfid)));\n}\n\nvoid sparx5_isdx_conf_set(struct sparx5 *sparx5, u32 isdx, u32 sfid, u32 fmid)\n{\n\tspx5_rmw(ANA_L2_TSN_CFG_TSN_SFID_SET(sfid), ANA_L2_TSN_CFG_TSN_SFID,\n\t\t sparx5, ANA_L2_TSN_CFG(isdx));\n\n\tspx5_rmw(ANA_L2_DLB_CFG_DLB_IDX_SET(fmid), ANA_L2_DLB_CFG_DLB_IDX,\n\t\t sparx5, ANA_L2_DLB_CFG(isdx));\n}\n\n \nstatic u32 sparx5_psfp_ipv_to_ips(s32 ipv)\n{\n\treturn ipv > 0 ? (ipv | BIT(3)) : 0;\n}\n\nstatic int sparx5_psfp_sgid_get_status(struct sparx5 *sparx5)\n{\n\treturn spx5_rd(sparx5, ANA_AC_SG_ACCESS_CTRL);\n}\n\nstatic int sparx5_psfp_sgid_wait_for_completion(struct sparx5 *sparx5)\n{\n\tu32 val;\n\n\treturn readx_poll_timeout(sparx5_psfp_sgid_get_status, sparx5, val,\n\t\t\t\t  !ANA_AC_SG_ACCESS_CTRL_CONFIG_CHANGE_GET(val),\n\t\t\t\t  SPX5_PSFP_SG_CONFIG_CHANGE_SLEEP,\n\t\t\t\t  SPX5_PSFP_SG_CONFIG_CHANGE_TIMEO);\n}\n\nstatic void sparx5_psfp_sg_config_change(struct sparx5 *sparx5, u32 id)\n{\n\tspx5_wr(ANA_AC_SG_ACCESS_CTRL_SGID_SET(id), sparx5,\n\t\tANA_AC_SG_ACCESS_CTRL);\n\n\tspx5_wr(ANA_AC_SG_ACCESS_CTRL_CONFIG_CHANGE_SET(1) |\n\t\tANA_AC_SG_ACCESS_CTRL_SGID_SET(id),\n\t\tsparx5, ANA_AC_SG_ACCESS_CTRL);\n\n\tif (sparx5_psfp_sgid_wait_for_completion(sparx5) < 0)\n\t\tpr_debug(\"%s:%d timed out waiting for sgid completion\",\n\t\t\t __func__, __LINE__);\n}\n\nstatic void sparx5_psfp_sf_set(struct sparx5 *sparx5, u32 id,\n\t\t\t       const struct sparx5_psfp_sf *sf)\n{\n\t \n\tspx5_rmw(ANA_AC_TSN_SF_CFG_TSN_SGID_SET(sf->sgid) |\n\t\tANA_AC_TSN_SF_CFG_TSN_MAX_SDU_SET(sf->max_sdu) |\n\t\tANA_AC_TSN_SF_CFG_BLOCK_OVERSIZE_STATE_SET(sf->sblock_osize) |\n\t\tANA_AC_TSN_SF_CFG_BLOCK_OVERSIZE_ENA_SET(sf->sblock_osize_ena),\n\t\tANA_AC_TSN_SF_CFG_TSN_SGID | ANA_AC_TSN_SF_CFG_TSN_MAX_SDU |\n\t\tANA_AC_TSN_SF_CFG_BLOCK_OVERSIZE_STATE |\n\t\tANA_AC_TSN_SF_CFG_BLOCK_OVERSIZE_ENA,\n\t\tsparx5, ANA_AC_TSN_SF_CFG(id));\n}\n\nstatic int sparx5_psfp_sg_set(struct sparx5 *sparx5, u32 id,\n\t\t\t      const struct sparx5_psfp_sg *sg)\n{\n\tu32 ips, base_lsb, base_msb, accum_time_interval = 0;\n\tconst struct sparx5_psfp_gce *gce;\n\tint i;\n\n\tips = sparx5_psfp_ipv_to_ips(sg->ipv);\n\tbase_lsb = sg->basetime.tv_sec & 0xffffffff;\n\tbase_msb = sg->basetime.tv_sec >> 32;\n\n\t \n\tspx5_wr(ANA_AC_SG_ACCESS_CTRL_SGID_SET(id), sparx5,\n\t\tANA_AC_SG_ACCESS_CTRL);\n\n\t \n\tspx5_wr(sg->basetime.tv_nsec, sparx5, ANA_AC_SG_CONFIG_REG_1);\n\tspx5_wr(base_lsb, sparx5, ANA_AC_SG_CONFIG_REG_2);\n\n\tspx5_rmw(ANA_AC_SG_CONFIG_REG_3_BASE_TIME_SEC_MSB_SET(base_msb) |\n\t\tANA_AC_SG_CONFIG_REG_3_INIT_IPS_SET(ips) |\n\t\tANA_AC_SG_CONFIG_REG_3_LIST_LENGTH_SET(sg->num_entries) |\n\t\tANA_AC_SG_CONFIG_REG_3_INIT_GATE_STATE_SET(sg->gate_state) |\n\t\tANA_AC_SG_CONFIG_REG_3_GATE_ENABLE_SET(1),\n\t\tANA_AC_SG_CONFIG_REG_3_BASE_TIME_SEC_MSB |\n\t\tANA_AC_SG_CONFIG_REG_3_INIT_IPS |\n\t\tANA_AC_SG_CONFIG_REG_3_LIST_LENGTH |\n\t\tANA_AC_SG_CONFIG_REG_3_INIT_GATE_STATE |\n\t\tANA_AC_SG_CONFIG_REG_3_GATE_ENABLE,\n\t\tsparx5, ANA_AC_SG_CONFIG_REG_3);\n\n\tspx5_wr(sg->cycletime, sparx5, ANA_AC_SG_CONFIG_REG_4);\n\tspx5_wr(sg->cycletimeext, sparx5, ANA_AC_SG_CONFIG_REG_5);\n\n\t \n\tfor (i = 0; i < sg->num_entries; i++) {\n\t\tgce = &sg->gce[i];\n\t\tips = sparx5_psfp_ipv_to_ips(gce->ipv);\n\t\t \n\t\taccum_time_interval += gce->interval;\n\t\t \n\t\tspx5_wr(ANA_AC_SG_GCL_GS_CONFIG_IPS_SET(ips) |\n\t\t\tANA_AC_SG_GCL_GS_CONFIG_GATE_STATE_SET(gce->gate_state),\n\t\t\tsparx5, ANA_AC_SG_GCL_GS_CONFIG(i));\n\n\t\t \n\t\tspx5_wr(accum_time_interval, sparx5,\n\t\t\tANA_AC_SG_GCL_TI_CONFIG(i));\n\n\t\t \n\t\tspx5_wr(gce->maxoctets, sparx5, ANA_AC_SG_GCL_OCT_CONFIG(i));\n\t}\n\n\treturn 0;\n}\n\nstatic int sparx5_sdlb_conf_set(struct sparx5 *sparx5,\n\t\t\t\tstruct sparx5_psfp_fm *fm)\n{\n\tint (*sparx5_sdlb_group_action)(struct sparx5 *sparx5, u32 group,\n\t\t\t\t\tu32 idx);\n\n\tif (!fm->pol.rate && !fm->pol.burst)\n\t\tsparx5_sdlb_group_action = &sparx5_sdlb_group_del;\n\telse\n\t\tsparx5_sdlb_group_action = &sparx5_sdlb_group_add;\n\n\tsparx5_policer_conf_set(sparx5, &fm->pol);\n\n\treturn sparx5_sdlb_group_action(sparx5, fm->pol.group, fm->pol.idx);\n}\n\nint sparx5_psfp_sf_add(struct sparx5 *sparx5, const struct sparx5_psfp_sf *sf,\n\t\t       u32 *id)\n{\n\tint ret;\n\n\tret = sparx5_psfp_sf_get(id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tsparx5_psfp_sf_set(sparx5, *id, sf);\n\n\treturn 0;\n}\n\nint sparx5_psfp_sf_del(struct sparx5 *sparx5, u32 id)\n{\n\tconst struct sparx5_psfp_sf sf = { 0 };\n\n\tsparx5_psfp_sf_set(sparx5, id, &sf);\n\n\treturn sparx5_psfp_sf_put(id);\n}\n\nint sparx5_psfp_sg_add(struct sparx5 *sparx5, u32 uidx,\n\t\t       struct sparx5_psfp_sg *sg, u32 *id)\n{\n\tktime_t basetime;\n\tint ret;\n\n\tret = sparx5_psfp_sg_get(uidx, id);\n\tif (ret < 0)\n\t\treturn ret;\n\t \n\tif (ret > 1)\n\t\treturn 0;\n\n\t \n\tsparx5_new_base_time(sparx5, sg->cycletime, 0, &basetime);\n\tsg->basetime = ktime_to_timespec64(basetime);\n\n\tsparx5_psfp_sg_set(sparx5, *id, sg);\n\n\t \n\tsparx5_psfp_sg_config_change(sparx5, *id);\n\n\treturn 0;\n}\n\nint sparx5_psfp_sg_del(struct sparx5 *sparx5, u32 id)\n{\n\tconst struct sparx5_psfp_sg sg = { 0 };\n\tint ret;\n\n\tret = sparx5_psfp_sg_put(id);\n\tif (ret < 0)\n\t\treturn ret;\n\t \n\tif (ret > 0)\n\t\treturn 0;\n\n\treturn sparx5_psfp_sg_set(sparx5, id, &sg);\n}\n\nint sparx5_psfp_fm_add(struct sparx5 *sparx5, u32 uidx,\n\t\t       struct sparx5_psfp_fm *fm, u32 *id)\n{\n\tstruct sparx5_policer *pol = &fm->pol;\n\tint ret;\n\n\t \n\tret = sparx5_psfp_fm_get(uidx, &fm->pol.idx);\n\tif (ret < 0)\n\t\treturn ret;\n\t \n\tif (ret > 1)\n\t\treturn 0;\n\n\tret = sparx5_sdlb_group_get_by_rate(sparx5, pol->rate, pol->burst);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfm->pol.group = ret;\n\n\tret = sparx5_sdlb_conf_set(sparx5, fm);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*id = fm->pol.idx;\n\n\treturn 0;\n}\n\nint sparx5_psfp_fm_del(struct sparx5 *sparx5, u32 id)\n{\n\tstruct sparx5_psfp_fm fm = { .pol.idx = id,\n\t\t\t\t     .pol.type = SPX5_POL_SERVICE };\n\tint ret;\n\n\t \n\tret = sparx5_sdlb_group_get_by_index(sparx5, id, &fm.pol.group);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = sparx5_psfp_fm_put(id);\n\tif (ret < 0)\n\t\treturn ret;\n\t \n\tif (ret > 0)\n\t\treturn 0;\n\n\treturn sparx5_sdlb_conf_set(sparx5, &fm);\n}\n\nvoid sparx5_psfp_init(struct sparx5 *sparx5)\n{\n\tconst struct sparx5_sdlb_group *group;\n\tint i;\n\n\tfor (i = 0; i < SPX5_SDLB_GROUP_CNT; i++) {\n\t\tgroup = &sdlb_groups[i];\n\t\tsparx5_sdlb_group_init(sparx5, group->max_rate,\n\t\t\t\t       group->min_burst, group->frame_size, i);\n\t}\n\n\tspx5_wr(ANA_AC_SG_CYCLETIME_UPDATE_PERIOD_SG_CT_UPDATE_ENA_SET(1),\n\t\tsparx5, ANA_AC_SG_CYCLETIME_UPDATE_PERIOD);\n\n\tspx5_rmw(ANA_L2_FWD_CFG_ISDX_LOOKUP_ENA_SET(1),\n\t\t ANA_L2_FWD_CFG_ISDX_LOOKUP_ENA, sparx5, ANA_L2_FWD_CFG);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}