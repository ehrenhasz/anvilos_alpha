{
  "module_name": "sparx5_phylink.c",
  "hash_id": "e6d74425d9003e51fc5374bde6134a5a849bd3dc511ef71cbc26929c7c24a279",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/sparx5/sparx5_phylink.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/phylink.h>\n#include <linux/device.h>\n#include <linux/netdevice.h>\n#include <linux/sfp.h>\n\n#include \"sparx5_main_regs.h\"\n#include \"sparx5_main.h\"\n#include \"sparx5_port.h\"\n\nstatic bool port_conf_has_changed(struct sparx5_port_config *a, struct sparx5_port_config *b)\n{\n\tif (a->speed != b->speed ||\n\t    a->portmode != b->portmode ||\n\t    a->autoneg != b->autoneg ||\n\t    a->pause_adv != b->pause_adv ||\n\t    a->power_down != b->power_down ||\n\t    a->media != b->media)\n\t\treturn true;\n\treturn false;\n}\n\nstatic struct phylink_pcs *\nsparx5_phylink_mac_select_pcs(struct phylink_config *config,\n\t\t\t      phy_interface_t interface)\n{\n\tstruct sparx5_port *port = netdev_priv(to_net_dev(config->dev));\n\n\treturn &port->phylink_pcs;\n}\n\nstatic void sparx5_phylink_mac_config(struct phylink_config *config,\n\t\t\t\t      unsigned int mode,\n\t\t\t\t      const struct phylink_link_state *state)\n{\n\t \n}\n\nstatic void sparx5_phylink_mac_link_up(struct phylink_config *config,\n\t\t\t\t       struct phy_device *phy,\n\t\t\t\t       unsigned int mode,\n\t\t\t\t       phy_interface_t interface,\n\t\t\t\t       int speed, int duplex,\n\t\t\t\t       bool tx_pause, bool rx_pause)\n{\n\tstruct sparx5_port *port = netdev_priv(to_net_dev(config->dev));\n\tstruct sparx5_port_config conf;\n\tint err;\n\n\tconf = port->conf;\n\tconf.duplex = duplex;\n\tconf.pause = 0;\n\tconf.pause |= tx_pause ? MLO_PAUSE_TX : 0;\n\tconf.pause |= rx_pause ? MLO_PAUSE_RX : 0;\n\tconf.speed = speed;\n\t \n\terr = sparx5_port_config(port->sparx5, port, &conf);\n\tif (err)\n\t\tnetdev_err(port->ndev, \"port config failed: %d\\n\", err);\n}\n\nstatic void sparx5_phylink_mac_link_down(struct phylink_config *config,\n\t\t\t\t\t unsigned int mode,\n\t\t\t\t\t phy_interface_t interface)\n{\n\t \n}\n\nstatic struct sparx5_port *sparx5_pcs_to_port(struct phylink_pcs *pcs)\n{\n\treturn container_of(pcs, struct sparx5_port, phylink_pcs);\n}\n\nstatic void sparx5_pcs_get_state(struct phylink_pcs *pcs,\n\t\t\t\t struct phylink_link_state *state)\n{\n\tstruct sparx5_port *port = sparx5_pcs_to_port(pcs);\n\tstruct sparx5_port_status status;\n\n\tsparx5_get_port_status(port->sparx5, port, &status);\n\tstate->link = status.link && !status.link_down;\n\tstate->an_complete = status.an_complete;\n\tstate->speed = status.speed;\n\tstate->duplex = status.duplex;\n\tstate->pause = status.pause;\n}\n\nstatic int sparx5_pcs_config(struct phylink_pcs *pcs, unsigned int neg_mode,\n\t\t\t     phy_interface_t interface,\n\t\t\t     const unsigned long *advertising,\n\t\t\t     bool permit_pause_to_mac)\n{\n\tstruct sparx5_port *port = sparx5_pcs_to_port(pcs);\n\tstruct sparx5_port_config conf;\n\tint ret = 0;\n\n\tconf = port->conf;\n\tconf.power_down = false;\n\tconf.portmode = interface;\n\tconf.inband = neg_mode == PHYLINK_PCS_NEG_INBAND_DISABLED ||\n\t\t      neg_mode == PHYLINK_PCS_NEG_INBAND_ENABLED;\n\tconf.autoneg = neg_mode == PHYLINK_PCS_NEG_INBAND_ENABLED;\n\tconf.pause_adv = 0;\n\tif (phylink_test(advertising, Pause))\n\t\tconf.pause_adv |= ADVERTISE_1000XPAUSE;\n\tif (phylink_test(advertising, Asym_Pause))\n\t\tconf.pause_adv |= ADVERTISE_1000XPSE_ASYM;\n\tif (sparx5_is_baser(interface)) {\n\t\tif (phylink_test(advertising, FIBRE))\n\t\t\tconf.media = PHY_MEDIA_SR;\n\t\telse\n\t\t\tconf.media = PHY_MEDIA_DAC;\n\t}\n\tif (!port_conf_has_changed(&port->conf, &conf))\n\t\treturn ret;\n\t \n\tret = sparx5_port_pcs_set(port->sparx5, port, &conf);\n\tif (ret)\n\t\tnetdev_err(port->ndev, \"port PCS config failed: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic void sparx5_pcs_aneg_restart(struct phylink_pcs *pcs)\n{\n\t \n}\n\nconst struct phylink_pcs_ops sparx5_phylink_pcs_ops = {\n\t.pcs_get_state = sparx5_pcs_get_state,\n\t.pcs_config = sparx5_pcs_config,\n\t.pcs_an_restart = sparx5_pcs_aneg_restart,\n};\n\nconst struct phylink_mac_ops sparx5_phylink_mac_ops = {\n\t.mac_select_pcs = sparx5_phylink_mac_select_pcs,\n\t.mac_config = sparx5_phylink_mac_config,\n\t.mac_link_down = sparx5_phylink_mac_link_down,\n\t.mac_link_up = sparx5_phylink_mac_link_up,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}