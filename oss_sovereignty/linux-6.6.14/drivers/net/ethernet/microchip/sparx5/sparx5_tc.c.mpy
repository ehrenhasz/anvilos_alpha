{
  "module_name": "sparx5_tc.c",
  "hash_id": "9f931fa6568b4cde4ee21a52ea0d54aa810080f9ce8e55b9847d90c42853a872",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/microchip/sparx5/sparx5_tc.c",
  "human_readable_source": "\n \n\n#include <net/pkt_cls.h>\n#include <net/pkt_sched.h>\n\n#include \"sparx5_tc.h\"\n#include \"sparx5_main.h\"\n#include \"sparx5_qos.h\"\n\n \nstatic LIST_HEAD(sparx5_block_cb_list);\n\nstatic int sparx5_tc_block_cb(enum tc_setup_type type,\n\t\t\t      void *type_data,\n\t\t\t      void *cb_priv, bool ingress)\n{\n\tstruct net_device *ndev = cb_priv;\n\n\tswitch (type) {\n\tcase TC_SETUP_CLSMATCHALL:\n\t\treturn sparx5_tc_matchall(ndev, type_data, ingress);\n\tcase TC_SETUP_CLSFLOWER:\n\t\treturn sparx5_tc_flower(ndev, type_data, ingress);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int sparx5_tc_block_cb_ingress(enum tc_setup_type type,\n\t\t\t\t      void *type_data,\n\t\t\t\t      void *cb_priv)\n{\n\treturn sparx5_tc_block_cb(type, type_data, cb_priv, true);\n}\n\nstatic int sparx5_tc_block_cb_egress(enum tc_setup_type type,\n\t\t\t\t     void *type_data,\n\t\t\t\t     void *cb_priv)\n{\n\treturn sparx5_tc_block_cb(type, type_data, cb_priv, false);\n}\n\nstatic int sparx5_tc_setup_block(struct net_device *ndev,\n\t\t\t\t struct flow_block_offload *fbo)\n{\n\tflow_setup_cb_t *cb;\n\n\tif (fbo->binder_type == FLOW_BLOCK_BINDER_TYPE_CLSACT_INGRESS)\n\t\tcb = sparx5_tc_block_cb_ingress;\n\telse if (fbo->binder_type == FLOW_BLOCK_BINDER_TYPE_CLSACT_EGRESS)\n\t\tcb = sparx5_tc_block_cb_egress;\n\telse\n\t\treturn -EOPNOTSUPP;\n\n\treturn flow_block_cb_setup_simple(fbo, &sparx5_block_cb_list,\n\t\t\t\t\t  cb, ndev, ndev, false);\n}\n\nstatic void sparx5_tc_get_layer_and_idx(u32 parent, u32 portno, u32 *layer,\n\t\t\t\t\tu32 *idx)\n{\n\tif (parent == TC_H_ROOT) {\n\t\t*layer = 2;\n\t\t*idx = portno;\n\t} else {\n\t\tu32 queue = TC_H_MIN(parent) - 1;\n\t\t*layer = 0;\n\t\t*idx = SPX5_HSCH_L0_GET_IDX(portno, queue);\n\t}\n}\n\nstatic int sparx5_tc_setup_qdisc_mqprio(struct net_device *ndev,\n\t\t\t\t\tstruct tc_mqprio_qopt_offload *m)\n{\n\tm->qopt.hw = TC_MQPRIO_HW_OFFLOAD_TCS;\n\n\tif (m->qopt.num_tc == 0)\n\t\treturn sparx5_tc_mqprio_del(ndev);\n\telse\n\t\treturn sparx5_tc_mqprio_add(ndev, m->qopt.num_tc);\n}\n\nstatic int sparx5_tc_setup_qdisc_tbf(struct net_device *ndev,\n\t\t\t\t     struct tc_tbf_qopt_offload *qopt)\n{\n\tstruct sparx5_port *port = netdev_priv(ndev);\n\tu32 layer, se_idx;\n\n\tsparx5_tc_get_layer_and_idx(qopt->parent, port->portno, &layer,\n\t\t\t\t    &se_idx);\n\n\tswitch (qopt->command) {\n\tcase TC_TBF_REPLACE:\n\t\treturn sparx5_tc_tbf_add(port, &qopt->replace_params, layer,\n\t\t\t\t\t se_idx);\n\tcase TC_TBF_DESTROY:\n\t\treturn sparx5_tc_tbf_del(port, layer, se_idx);\n\tcase TC_TBF_STATS:\n\t\treturn -EOPNOTSUPP;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\treturn -EOPNOTSUPP;\n}\n\nstatic int sparx5_tc_setup_qdisc_ets(struct net_device *ndev,\n\t\t\t\t     struct tc_ets_qopt_offload *qopt)\n{\n\tstruct tc_ets_qopt_offload_replace_params *params =\n\t\t&qopt->replace_params;\n\tstruct sparx5_port *port = netdev_priv(ndev);\n\tint i;\n\n\t \n\tif (qopt->parent != TC_H_ROOT)\n\t\treturn -EOPNOTSUPP;\n\n\tswitch (qopt->command) {\n\tcase TC_ETS_REPLACE:\n\n\t\t \n\t\tif (params->bands != SPX5_PRIOS)\n\t\t\treturn -EOPNOTSUPP;\n\n\t\t \n\t\tfor (i = 0; i < SPX5_PRIOS; ++i) {\n\t\t\t \n\t\t\tif (params->priomap[i] != (7 - i))\n\t\t\t\treturn -EOPNOTSUPP;\n\t\t\t \n\t\t\tif (params->quanta[i] && params->weights[i] == 0) {\n\t\t\t\tpr_err(\"Invalid ets configuration; band %d has weight zero\",\n\t\t\t\t       i);\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t}\n\n\t\treturn sparx5_tc_ets_add(port, params);\n\tcase TC_ETS_DESTROY:\n\n\t\treturn sparx5_tc_ets_del(port);\n\tcase TC_ETS_GRAFT:\n\t\treturn -EOPNOTSUPP;\n\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\treturn -EOPNOTSUPP;\n}\n\nint sparx5_port_setup_tc(struct net_device *ndev, enum tc_setup_type type,\n\t\t\t void *type_data)\n{\n\tswitch (type) {\n\tcase TC_SETUP_BLOCK:\n\t\treturn sparx5_tc_setup_block(ndev, type_data);\n\tcase TC_SETUP_QDISC_MQPRIO:\n\t\treturn sparx5_tc_setup_qdisc_mqprio(ndev, type_data);\n\tcase TC_SETUP_QDISC_TBF:\n\t\treturn sparx5_tc_setup_qdisc_tbf(ndev, type_data);\n\tcase TC_SETUP_QDISC_ETS:\n\t\treturn sparx5_tc_setup_qdisc_ets(ndev, type_data);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}