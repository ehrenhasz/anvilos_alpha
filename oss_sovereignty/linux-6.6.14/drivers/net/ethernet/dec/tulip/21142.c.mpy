{
  "module_name": "21142.c",
  "hash_id": "c7b0e2a4f16849a85dae9c0486d8784d25c46bc4d9544f0c36a167f814f66772",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/dec/tulip/21142.c",
  "human_readable_source": " \n\n#include <linux/delay.h>\n#include \"tulip.h\"\n\n\nstatic u16 t21142_csr13[] = { 0x0001, 0x0009, 0x0009, 0x0000, 0x0001, };\nu16 t21142_csr14[] =\t    { 0xFFFF, 0x0705, 0x0705, 0x0000, 0x7F3D, };\nstatic u16 t21142_csr15[] = { 0x0008, 0x0006, 0x000E, 0x0008, 0x0008, };\n\n\n \nvoid t21142_media_task(struct work_struct *work)\n{\n\tstruct tulip_private *tp =\n\t\tcontainer_of(work, struct tulip_private, media_work);\n\tstruct net_device *dev = tp->dev;\n\tvoid __iomem *ioaddr = tp->base_addr;\n\tint csr12 = ioread32(ioaddr + CSR12);\n\tint next_tick = 60*HZ;\n\tint new_csr6 = 0;\n\tint csr14 = ioread32(ioaddr + CSR14);\n\n\t \n\tif ((csr14 & 0x80) && (csr12 & 0x7000) != 0x5000)\n\t\tcsr12 |= 6;\n\tif (tulip_debug > 2)\n\t\tdev_info(&dev->dev, \"21143 negotiation status %08x, %s\\n\",\n\t\t\t csr12, medianame[dev->if_port]);\n\tif (tulip_media_cap[dev->if_port] & MediaIsMII) {\n\t\tif (tulip_check_duplex(dev) < 0) {\n\t\t\tnetif_carrier_off(dev);\n\t\t\tnext_tick = 3*HZ;\n\t\t} else {\n\t\t\tnetif_carrier_on(dev);\n\t\t\tnext_tick = 60*HZ;\n\t\t}\n\t} else if (tp->nwayset) {\n\t\t \n\t\tif (tulip_debug > 1)\n\t\t\tdev_info(&dev->dev,\n\t\t\t\t \"Using NWay-set %s media, csr12 %08x\\n\",\n\t\t\t\t medianame[dev->if_port], csr12);\n\t} else if (tp->medialock) {\n\t\t\t;\n\t} else if (dev->if_port == 3) {\n\t\tif (csr12 & 2) {\t \n\t\t\tif (tulip_debug > 1)\n\t\t\t\tdev_info(&dev->dev,\n\t\t\t\t\t \"No 21143 100baseTx link beat, %08x, trying NWay\\n\",\n\t\t\t\t\t csr12);\n\t\t\tt21142_start_nway(dev);\n\t\t\tnext_tick = 3*HZ;\n\t\t}\n\t} else if ((csr12 & 0x7000) != 0x5000) {\n\t\t \n\t\tif (tulip_debug > 1)\n\t\t\tdev_info(&dev->dev,\n\t\t\t\t \"21143 negotiation failed, status %08x\\n\",\n\t\t\t\t csr12);\n\t\tif (!(csr12 & 4)) {\t\t \n\t\t\tnew_csr6 = 0x82420000;\n\t\t\tdev->if_port = 0;\n\t\t\tiowrite32(0, ioaddr + CSR13);\n\t\t\tiowrite32(0x0003FFFF, ioaddr + CSR14);\n\t\t\tiowrite16(t21142_csr15[dev->if_port], ioaddr + CSR15);\n\t\t\tiowrite32(t21142_csr13[dev->if_port], ioaddr + CSR13);\n\t\t} else {\n\t\t\t \n\t\t\tnew_csr6 = 0x83860000;\n\t\t\tdev->if_port = 3;\n\t\t\tiowrite32(0, ioaddr + CSR13);\n\t\t\tiowrite32(0x0003FFFF, ioaddr + CSR14);\n\t\t\tiowrite16(8, ioaddr + CSR15);\n\t\t\tiowrite32(1, ioaddr + CSR13);\n\t\t}\n\t\tif (tulip_debug > 1)\n\t\t\tdev_info(&dev->dev, \"Testing new 21143 media %s\\n\",\n\t\t\t\t medianame[dev->if_port]);\n\t\tif (new_csr6 != (tp->csr6 & ~0x00D5)) {\n\t\t\ttp->csr6 &= 0x00D5;\n\t\t\ttp->csr6 |= new_csr6;\n\t\t\tiowrite32(0x0301, ioaddr + CSR12);\n\t\t\ttulip_restart_rxtx(tp);\n\t\t}\n\t\tnext_tick = 3*HZ;\n\t}\n\n\t \n\tmod_timer(&tp->timer, RUN_AT(next_tick));\n}\n\n\nvoid t21142_start_nway(struct net_device *dev)\n{\n\tstruct tulip_private *tp = netdev_priv(dev);\n\tvoid __iomem *ioaddr = tp->base_addr;\n\tint csr14 = ((tp->sym_advertise & 0x0780) << 9)  |\n\t\t((tp->sym_advertise & 0x0020) << 1) | 0xffbf;\n\n\tdev->if_port = 0;\n\ttp->nway = tp->mediasense = 1;\n\ttp->nwayset = tp->lpar = 0;\n\tif (tulip_debug > 1)\n\t\tnetdev_dbg(dev, \"Restarting 21143 autonegotiation, csr14=%08x\\n\",\n\t\t\t   csr14);\n\tiowrite32(0x0001, ioaddr + CSR13);\n\tudelay(100);\n\tiowrite32(csr14, ioaddr + CSR14);\n\ttp->csr6 = 0x82420000 | (tp->sym_advertise & 0x0040 ? FullDuplex : 0);\n\tiowrite32(tp->csr6, ioaddr + CSR6);\n\tif (tp->mtable  &&  tp->mtable->csr15dir) {\n\t\tiowrite32(tp->mtable->csr15dir, ioaddr + CSR15);\n\t\tiowrite32(tp->mtable->csr15val, ioaddr + CSR15);\n\t} else\n\t\tiowrite16(0x0008, ioaddr + CSR15);\n\tiowrite32(0x1301, ioaddr + CSR12); \t\t \n}\n\n\n\nvoid t21142_lnk_change(struct net_device *dev, int csr5)\n{\n\tstruct tulip_private *tp = netdev_priv(dev);\n\tvoid __iomem *ioaddr = tp->base_addr;\n\tint csr12 = ioread32(ioaddr + CSR12);\n\tint csr14 = ioread32(ioaddr + CSR14);\n\n\t \n\tif ((csr14 & 0x80) && (csr12 & 0x7000) != 0x5000)\n\t\tcsr12 |= 6;\n\tif (tulip_debug > 1)\n\t\tdev_info(&dev->dev,\n\t\t\t \"21143 link status interrupt %08x, CSR5 %x, %08x\\n\",\n\t\t\t csr12, csr5, csr14);\n\n\t \n\tif (tp->nway  &&  !tp->nwayset  &&  (csr12 & 0x7000) == 0x5000) {\n\t\tint setup_done = 0;\n\t\tint negotiated = tp->sym_advertise & (csr12 >> 16);\n\t\ttp->lpar = csr12 >> 16;\n\t\ttp->nwayset = 1;\n\t\t \n\t\tif (!(csr12 & 0x8000))\t\tdev->if_port = 0;\n\t\telse if (negotiated & 0x0100)\tdev->if_port = 5;\n\t\telse if (negotiated & 0x0080)\tdev->if_port = 3;\n\t\telse if (negotiated & 0x0040)\tdev->if_port = 4;\n\t\telse if (negotiated & 0x0020)\tdev->if_port = 0;\n\t\telse {\n\t\t\ttp->nwayset = 0;\n\t\t\tif ((csr12 & 2) == 0  &&  (tp->sym_advertise & 0x0180))\n\t\t\t\tdev->if_port = 3;\n\t\t}\n\t\ttp->full_duplex = (tulip_media_cap[dev->if_port] & MediaAlwaysFD) ? 1:0;\n\n\t\tif (tulip_debug > 1) {\n\t\t\tif (tp->nwayset)\n\t\t\t\tdev_info(&dev->dev,\n\t\t\t\t\t \"Switching to %s based on link negotiation %04x & %04x = %04x\\n\",\n\t\t\t\t\t medianame[dev->if_port],\n\t\t\t\t\t tp->sym_advertise, tp->lpar,\n\t\t\t\t\t negotiated);\n\t\t\telse\n\t\t\t\tdev_info(&dev->dev,\n\t\t\t\t\t \"Autonegotiation failed, using %s, link beat status %04x\\n\",\n\t\t\t\t\t medianame[dev->if_port], csr12);\n\t\t}\n\n\t\tif (tp->mtable) {\n\t\t\tint i;\n\t\t\tfor (i = 0; i < tp->mtable->leafcount; i++)\n\t\t\t\tif (tp->mtable->mleaf[i].media == dev->if_port) {\n\t\t\t\t\tint startup = ! ((tp->chip_id == DC21143 && (tp->revision == 48 || tp->revision == 65)));\n\t\t\t\t\ttp->cur_index = i;\n\t\t\t\t\ttulip_select_media(dev, startup);\n\t\t\t\t\tsetup_done = 1;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t}\n\t\tif ( ! setup_done) {\n\t\t\ttp->csr6 = (dev->if_port & 1 ? 0x838E0000 : 0x82420000) | (tp->csr6 & 0x20ff);\n\t\t\tif (tp->full_duplex)\n\t\t\t\ttp->csr6 |= 0x0200;\n\t\t\tiowrite32(1, ioaddr + CSR13);\n\t\t}\n#if 0\t\t\t\t\t\t\t \n\t\tiowrite32(tp->csr6 | RxOn, ioaddr + CSR6);\n\t\tif (tulip_debug > 2)\n\t\t\tnetdev_dbg(dev, \" Restarting Tx and Rx, CSR5 is %08x\\n\",\n\t\t\t\t   ioread32(ioaddr + CSR5));\n#endif\n\t\ttulip_start_rxtx(tp);\n\t\tif (tulip_debug > 2)\n\t\t\tnetdev_dbg(dev, \" Setting CSR6 %08x/%x CSR12 %08x\\n\",\n\t\t\t\t   tp->csr6, ioread32(ioaddr + CSR6),\n\t\t\t\t   ioread32(ioaddr + CSR12));\n\t} else if ((tp->nwayset  &&  (csr5 & 0x08000000) &&\n\t\t    (dev->if_port == 3  ||  dev->if_port == 5) &&\n\t\t    (csr12 & 2) == 2) ||\n\t\t   (tp->nway && (csr5 & (TPLnkFail)))) {\n\t\t \n\t\tdel_timer_sync(&tp->timer);\n\t\tt21142_start_nway(dev);\n\t\ttp->timer.expires = RUN_AT(3*HZ);\n\t\tadd_timer(&tp->timer);\n\t} else if (dev->if_port == 3  ||  dev->if_port == 5) {\n\t\tif (tulip_debug > 1)\n\t\t\tdev_info(&dev->dev, \"21143 %s link beat %s\\n\",\n\t\t\t\t medianame[dev->if_port],\n\t\t\t\t (csr12 & 2) ? \"failed\" : \"good\");\n\t\tif ((csr12 & 2)  &&  ! tp->medialock) {\n\t\t\tdel_timer_sync(&tp->timer);\n\t\t\tt21142_start_nway(dev);\n\t\t\ttp->timer.expires = RUN_AT(3*HZ);\n\t\t\tadd_timer(&tp->timer);\n\t\t} else if (dev->if_port == 5)\n\t\t\tiowrite32(csr14 & ~0x080, ioaddr + CSR14);\n\t} else if (dev->if_port == 0  ||  dev->if_port == 4) {\n\t\tif ((csr12 & 4) == 0)\n\t\t\tdev_info(&dev->dev, \"21143 10baseT link beat good\\n\");\n\t} else if (!(csr12 & 4)) {\t\t \n\t\tif (tulip_debug)\n\t\t\tdev_info(&dev->dev, \"21143 10mbps sensed media\\n\");\n\t\tdev->if_port = 0;\n\t} else if (tp->nwayset) {\n\t\tif (tulip_debug)\n\t\t\tdev_info(&dev->dev, \"21143 using NWay-set %s, csr6 %08x\\n\",\n\t\t\t\t medianame[dev->if_port], tp->csr6);\n\t} else {\t\t \n\t\tif (tulip_debug)\n\t\t\tdev_info(&dev->dev, \"21143 100baseTx sensed media\\n\");\n\t\tdev->if_port = 3;\n\t\ttp->csr6 = 0x838E0000 | (tp->csr6 & 0x20ff);\n\t\tiowrite32(0x0003FF7F, ioaddr + CSR14);\n\t\tiowrite32(0x0301, ioaddr + CSR12);\n\t\ttulip_restart_rxtx(tp);\n\t}\n}\n\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}