{
  "module_name": "pnic2.c",
  "hash_id": "779346f7f89a877e6d0450d613488f2b5e8ad8a278cd2b6388a57455a0936480",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/dec/tulip/pnic2.c",
  "human_readable_source": " \n\n\n \n\n\n\n#include \"tulip.h\"\n#include <linux/delay.h>\n\n\nvoid pnic2_timer(struct timer_list *t)\n{\n\tstruct tulip_private *tp = from_timer(tp, t, timer);\n\tstruct net_device *dev = tp->dev;\n\tvoid __iomem *ioaddr = tp->base_addr;\n\tint next_tick = 60*HZ;\n\n\tif (tulip_debug > 3)\n\t\tdev_info(&dev->dev, \"PNIC2 negotiation status %08x\\n\",\n\t\t\t ioread32(ioaddr + CSR12));\n\n\tif (next_tick) {\n\t\tmod_timer(&tp->timer, RUN_AT(next_tick));\n\t}\n}\n\n\nvoid pnic2_start_nway(struct net_device *dev)\n{\n\tstruct tulip_private *tp = netdev_priv(dev);\n\tvoid __iomem *ioaddr = tp->base_addr;\n        int csr14;\n        int csr12;\n\n         \n\n         \n\tcsr14 = (ioread32(ioaddr + CSR14) & 0xfff0ee39);\n\n         \n        if (tp->sym_advertise & 0x0100) csr14 |= 0x00020000;\n\n         \n        if (tp->sym_advertise & 0x0080) csr14 |= 0x00010000;\n\n         \n        if (tp->sym_advertise & 0x0020) csr14 |= 0x00000040;\n\n         \n        csr14 |= 0x00001184;\n\n\tif (tulip_debug > 1)\n\t\tnetdev_dbg(dev, \"Restarting PNIC2 autonegotiation, csr14=%08x\\n\",\n\t\t\t   csr14);\n\n         \n\tdev->if_port = 0;\n\ttp->nway = tp->mediasense = 1;\n\ttp->nwayset = tp->lpar = 0;\n\n         \n\n\ttp->csr6 = ioread32(ioaddr + CSR6);\n\tif (tulip_debug > 1)\n\t\tnetdev_dbg(dev, \"On Entry to Nway, csr6=%08x\\n\", tp->csr6);\n\n         \n\ttp->csr6 = tp->csr6 & 0xfe3bd1fd;\n\n         \n         \n        if (tp->sym_advertise & 0x0040) tp->csr6 |= 0x00000200;\n\n         \n        tp->csr6 |= 0x01000000;\n\tiowrite32(csr14, ioaddr + CSR14);\n\tiowrite32(tp->csr6, ioaddr + CSR6);\n        udelay(100);\n\n         \n\n         \n        csr12 = (ioread32(ioaddr + CSR12) & 0xffff8fff);\n        csr12 |= 0x1000;\n\tiowrite32(csr12, ioaddr + CSR12);\n}\n\n\n\nvoid pnic2_lnk_change(struct net_device *dev, int csr5)\n{\n\tstruct tulip_private *tp = netdev_priv(dev);\n\tvoid __iomem *ioaddr = tp->base_addr;\n        int csr14;\n\n         \n\tint csr12 = ioread32(ioaddr + CSR12);\n\n\tif (tulip_debug > 1)\n\t\tdev_info(&dev->dev,\n\t\t\t \"PNIC2 link status interrupt %08x,  CSR5 %x, %08x\\n\",\n\t\t\t csr12, csr5, ioread32(ioaddr + CSR14));\n\n\t \n\tif (tp->nway  &&  !tp->nwayset) {\n\n\t         \n\n                if ((csr12 & 0x7000) == 0x5000) {\n\n\t                \n\n\t                \n\n\t\t        int negotiated = ((csr12 >> 16) & 0x01E0) & tp->sym_advertise;\n\t\t        tp->lpar = (csr12 >> 16);\n\t\t        tp->nwayset = 1;\n\n                        if (negotiated & 0x0100)        dev->if_port = 5;\n\t\t        else if (negotiated & 0x0080)\tdev->if_port = 3;\n\t\t        else if (negotiated & 0x0040)\tdev->if_port = 4;\n\t\t\telse if (negotiated & 0x0020)\tdev->if_port = 0;\n\t\t\telse {\n\t\t\t     if (tulip_debug > 1)\n\t\t\t\t     dev_info(&dev->dev,\n\t\t\t\t\t      \"funny autonegotiate result csr12 %08x advertising %04x\\n\",\n\t\t\t\t\t      csr12, tp->sym_advertise);\n\t\t\t     tp->nwayset = 0;\n\t\t\t      \n\t\t\t     if ((csr12 & 2) == 0  &&  (tp->sym_advertise & 0x0180))\n\t\t\t       dev->if_port = 3;\n\t\t\t}\n\n\t\t\t \n\t\t\ttp->full_duplex = 0;\n\t\t\tif ((dev->if_port == 4) || (dev->if_port == 5))\n\t\t\t       tp->full_duplex = 1;\n\n\t\t\tif (tulip_debug > 1) {\n\t\t\t       if (tp->nwayset)\n\t\t\t\t       dev_info(&dev->dev,\n\t\t\t\t\t\t\"Switching to %s based on link negotiation %04x & %04x = %04x\\n\",\n\t\t\t\t\t\tmedianame[dev->if_port],\n\t\t\t\t\t\ttp->sym_advertise, tp->lpar,\n\t\t\t\t\t\tnegotiated);\n\t\t\t}\n\n                         \n\t                csr14 = (ioread32(ioaddr + CSR14) & 0xffffff7f);\n                        iowrite32(csr14,ioaddr + CSR14);\n\n\n                         \n\n\t\t\t \n\t\t\t \n\n\t\t\ttp->csr6 = (ioread32(ioaddr + CSR6) & 0xfe3bd1fd);\n\n\t\t\t \n\t\t\tif (dev->if_port & 1) tp->csr6 |= 0x01840000;\n\t\t\telse tp->csr6 |= 0x00400000;\n\n\t\t\t \n\t\t\tif (tp->full_duplex) tp->csr6 |= 0x00000200;\n\n\t\t\tiowrite32(1, ioaddr + CSR13);\n\n\t\t\tif (tulip_debug > 2)\n\t\t\t\tnetdev_dbg(dev, \"Setting CSR6 %08x/%x CSR12 %08x\\n\",\n\t\t\t\t\t   tp->csr6,\n\t\t\t\t\t   ioread32(ioaddr + CSR6),\n\t\t\t\t\t   ioread32(ioaddr + CSR12));\n\n\t\t\t \n\t\t\ttulip_start_rxtx(tp);\n\n                        return;\n\n\t        } else {\n\t                dev_info(&dev->dev,\n\t\t\t\t \"Autonegotiation failed, using %s, link beat status %04x\\n\",\n\t\t\t\t medianame[dev->if_port], csr12);\n\n                         \n\t                csr14 = (ioread32(ioaddr + CSR14) & 0xffffff7f);\n                        iowrite32(csr14,ioaddr + CSR14);\n\n                         \n\n\t                 dev->if_port = 0;\n                         tp->nway = 0;\n                         tp->nwayset = 1;\n\n                          \n\t                 tp->csr6 = (ioread32(ioaddr + CSR6) & 0xfe3bd1fd);\n                         tp->csr6 |= 0x00400000;\n\n\t                 tulip_restart_rxtx(tp);\n\n                         return;\n\n\t\t}\n\t}\n\n\tif ((tp->nwayset  &&  (csr5 & 0x08000000) &&\n\t     (dev->if_port == 3  ||  dev->if_port == 5) &&\n\t     (csr12 & 2) == 2) || (tp->nway && (csr5 & (TPLnkFail)))) {\n\n\t\t \n\n\t\tif (tulip_debug > 2)\n\t\t\tnetdev_dbg(dev, \"Ugh! Link blew?\\n\");\n\n\t\tdel_timer_sync(&tp->timer);\n\t\tpnic2_start_nway(dev);\n\t\ttp->timer.expires = RUN_AT(3*HZ);\n\t\tadd_timer(&tp->timer);\n\n                return;\n\t}\n\n\n        if (dev->if_port == 3  ||  dev->if_port == 5) {\n\n\t         \n\n\t\tif (tulip_debug > 1)\n\t\t\tdev_info(&dev->dev, \"PNIC2 %s link beat %s\\n\",\n\t\t\t\t medianame[dev->if_port],\n\t\t\t\t (csr12 & 2) ? \"failed\" : \"good\");\n\n                 \n\n                tp->nway = 0;\n                tp->nwayset = 1;\n\n                 \n\t\tif ((csr12 & 2)  &&  ! tp->medialock) {\n\t\t\tdel_timer_sync(&tp->timer);\n\t\t\tpnic2_start_nway(dev);\n\t\t\ttp->timer.expires = RUN_AT(3*HZ);\n\t\t\tadd_timer(&tp->timer);\n                }\n\n                return;\n        }\n\n\tif (dev->if_port == 0  ||  dev->if_port == 4) {\n\n\t         \n\n\t\tif (tulip_debug > 1)\n\t\t\tdev_info(&dev->dev, \"PNIC2 %s link beat %s\\n\",\n\t\t\t\t medianame[dev->if_port],\n\t\t\t\t (csr12 & 4) ? \"failed\" : \"good\");\n\n\n                tp->nway = 0;\n                tp->nwayset = 1;\n\n                 \n\t\tif ((csr12 & 4)  &&  ! tp->medialock) {\n\t\t\tdel_timer_sync(&tp->timer);\n\t\t\tpnic2_start_nway(dev);\n\t\t\ttp->timer.expires = RUN_AT(3*HZ);\n\t\t\tadd_timer(&tp->timer);\n                }\n\n                return;\n        }\n\n\n\tif (tulip_debug > 1)\n\t\tdev_info(&dev->dev, \"PNIC2 Link Change Default?\\n\");\n\n         \n\tdev->if_port = 0;\n\n         \n\tcsr14 = (ioread32(ioaddr + CSR14) & 0xffffff7f);\n        iowrite32(csr14,ioaddr + CSR14);\n\n         \n\ttp->csr6 = (ioread32(ioaddr + CSR6) & 0xfe3bd1fd);\n        tp->csr6 |= 0x00400000;\n\n\ttulip_restart_rxtx(tp);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}