{
  "module_name": "w5300.c",
  "hash_id": "5fcec3acd9cac773113c90f92fd7835515f86eb06733d2f89fbf976d3b0f9c22",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/wiznet/w5300.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n#include <linux/platform_device.h>\n#include <linux/platform_data/wiznet.h>\n#include <linux/ethtool.h>\n#include <linux/skbuff.h>\n#include <linux/types.h>\n#include <linux/errno.h>\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <linux/spinlock.h>\n#include <linux/io.h>\n#include <linux/ioport.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/gpio.h>\n\n#define DRV_NAME\t\"w5300\"\n#define DRV_VERSION\t\"2012-04-04\"\n\nMODULE_DESCRIPTION(\"WIZnet W5300 Ethernet driver v\"DRV_VERSION);\nMODULE_AUTHOR(\"Mike Sinkovsky <msink@permonline.ru>\");\nMODULE_ALIAS(\"platform:\"DRV_NAME);\nMODULE_LICENSE(\"GPL\");\n\n \n#define W5300_MR\t\t0x0000\t \n#define   MR_DBW\t\t  (1 << 15)  \n#define   MR_MPF\t\t  (1 << 14)  \n#define   MR_WDF(n)\t\t  (((n)&7)<<11)  \n#define   MR_RDH\t\t  (1 << 10)  \n#define   MR_FS\t\t\t  (1 << 8)   \n#define   MR_RST\t\t  (1 << 7)   \n#define   MR_PB\t\t\t  (1 << 4)   \n#define   MR_DBS\t\t  (1 << 2)   \n#define   MR_IND\t\t  (1 << 0)   \n#define W5300_IR\t\t0x0002\t \n#define W5300_IMR\t\t0x0004\t \n#define   IR_S0\t\t\t  0x0001   \n#define W5300_SHARL\t\t0x0008\t \n#define W5300_SHARH\t\t0x000c\t \n#define W5300_TMSRL\t\t0x0020\t \n#define W5300_TMSRH\t\t0x0024\t \n#define W5300_RMSRL\t\t0x0028\t \n#define W5300_RMSRH\t\t0x002c\t \n#define W5300_MTYPE\t\t0x0030\t \n#define W5300_IDR\t\t0x00fe\t \n#define   IDR_W5300\t\t  0x5300   \n#define W5300_S0_MR\t\t0x0200\t \n#define   S0_MR_CLOSED\t\t  0x0000   \n#define   S0_MR_MACRAW\t\t  0x0004   \n#define   S0_MR_MACRAW_MF\t  0x0044   \n#define W5300_S0_CR\t\t0x0202\t \n#define   S0_CR_OPEN\t\t  0x0001   \n#define   S0_CR_CLOSE\t\t  0x0010   \n#define   S0_CR_SEND\t\t  0x0020   \n#define   S0_CR_RECV\t\t  0x0040   \n#define W5300_S0_IMR\t\t0x0204\t \n#define W5300_S0_IR\t\t0x0206\t \n#define   S0_IR_RECV\t\t  0x0004   \n#define   S0_IR_SENDOK\t\t  0x0010   \n#define W5300_S0_SSR\t\t0x0208\t \n#define W5300_S0_TX_WRSR\t0x0220\t \n#define W5300_S0_TX_FSR\t\t0x0224\t \n#define W5300_S0_RX_RSR\t\t0x0228\t \n#define W5300_S0_TX_FIFO\t0x022e\t \n#define W5300_S0_RX_FIFO\t0x0230\t \n#define W5300_REGS_LEN\t\t0x0400\n\n \nstruct w5300_priv {\n\tvoid __iomem *base;\n\tspinlock_t reg_lock;\n\tbool indirect;\n\tu16  (*read) (struct w5300_priv *priv, u16 addr);\n\tvoid (*write)(struct w5300_priv *priv, u16 addr, u16 data);\n\tint irq;\n\tint link_irq;\n\tint link_gpio;\n\n\tstruct napi_struct napi;\n\tstruct net_device *ndev;\n\tbool promisc;\n\tu32 msg_enable;\n};\n\n \n\n \nstatic inline u16 w5300_read_direct(struct w5300_priv *priv, u16 addr)\n{\n\treturn ioread16(priv->base + (addr << CONFIG_WIZNET_BUS_SHIFT));\n}\n\nstatic inline void w5300_write_direct(struct w5300_priv *priv,\n\t\t\t\t      u16 addr, u16 data)\n{\n\tiowrite16(data, priv->base + (addr << CONFIG_WIZNET_BUS_SHIFT));\n}\n\n \n#define W5300_IDM_AR\t\t0x0002\t  \n#define W5300_IDM_DR\t\t0x0004\t  \n\nstatic u16 w5300_read_indirect(struct w5300_priv *priv, u16 addr)\n{\n\tunsigned long flags;\n\tu16 data;\n\n\tspin_lock_irqsave(&priv->reg_lock, flags);\n\tw5300_write_direct(priv, W5300_IDM_AR, addr);\n\tdata = w5300_read_direct(priv, W5300_IDM_DR);\n\tspin_unlock_irqrestore(&priv->reg_lock, flags);\n\n\treturn data;\n}\n\nstatic void w5300_write_indirect(struct w5300_priv *priv, u16 addr, u16 data)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&priv->reg_lock, flags);\n\tw5300_write_direct(priv, W5300_IDM_AR, addr);\n\tw5300_write_direct(priv, W5300_IDM_DR, data);\n\tspin_unlock_irqrestore(&priv->reg_lock, flags);\n}\n\n#if defined(CONFIG_WIZNET_BUS_DIRECT)\n#define w5300_read\tw5300_read_direct\n#define w5300_write\tw5300_write_direct\n\n#elif defined(CONFIG_WIZNET_BUS_INDIRECT)\n#define w5300_read\tw5300_read_indirect\n#define w5300_write\tw5300_write_indirect\n\n#else  \n#define w5300_read\tpriv->read\n#define w5300_write\tpriv->write\n#endif\n\nstatic u32 w5300_read32(struct w5300_priv *priv, u16 addr)\n{\n\tu32 data;\n\tdata  = w5300_read(priv, addr) << 16;\n\tdata |= w5300_read(priv, addr + 2);\n\treturn data;\n}\n\nstatic void w5300_write32(struct w5300_priv *priv, u16 addr, u32 data)\n{\n\tw5300_write(priv, addr, data >> 16);\n\tw5300_write(priv, addr + 2, data);\n}\n\nstatic int w5300_command(struct w5300_priv *priv, u16 cmd)\n{\n\tunsigned long timeout = jiffies + msecs_to_jiffies(100);\n\n\tw5300_write(priv, W5300_S0_CR, cmd);\n\n\twhile (w5300_read(priv, W5300_S0_CR) != 0) {\n\t\tif (time_after(jiffies, timeout))\n\t\t\treturn -EIO;\n\t\tcpu_relax();\n\t}\n\n\treturn 0;\n}\n\nstatic void w5300_read_frame(struct w5300_priv *priv, u8 *buf, int len)\n{\n\tu16 fifo;\n\tint i;\n\n\tfor (i = 0; i < len; i += 2) {\n\t\tfifo = w5300_read(priv, W5300_S0_RX_FIFO);\n\t\t*buf++ = fifo >> 8;\n\t\t*buf++ = fifo;\n\t}\n\tfifo = w5300_read(priv, W5300_S0_RX_FIFO);\n\tfifo = w5300_read(priv, W5300_S0_RX_FIFO);\n}\n\nstatic void w5300_write_frame(struct w5300_priv *priv, u8 *buf, int len)\n{\n\tu16 fifo;\n\tint i;\n\n\tfor (i = 0; i < len; i += 2) {\n\t\tfifo  = *buf++ << 8;\n\t\tfifo |= *buf++;\n\t\tw5300_write(priv, W5300_S0_TX_FIFO, fifo);\n\t}\n\tw5300_write32(priv, W5300_S0_TX_WRSR, len);\n}\n\nstatic void w5300_write_macaddr(struct w5300_priv *priv)\n{\n\tstruct net_device *ndev = priv->ndev;\n\tw5300_write32(priv, W5300_SHARL,\n\t\t      ndev->dev_addr[0] << 24 |\n\t\t      ndev->dev_addr[1] << 16 |\n\t\t      ndev->dev_addr[2] << 8 |\n\t\t      ndev->dev_addr[3]);\n\tw5300_write(priv, W5300_SHARH,\n\t\t      ndev->dev_addr[4] << 8 |\n\t\t      ndev->dev_addr[5]);\n}\n\nstatic void w5300_hw_reset(struct w5300_priv *priv)\n{\n\tw5300_write_direct(priv, W5300_MR, MR_RST);\n\tmdelay(5);\n\tw5300_write_direct(priv, W5300_MR, priv->indirect ?\n\t\t\t\t MR_WDF(7) | MR_PB | MR_IND :\n\t\t\t\t MR_WDF(7) | MR_PB);\n\tw5300_write(priv, W5300_IMR, 0);\n\tw5300_write_macaddr(priv);\n\n\t \n\tw5300_write32(priv, W5300_RMSRL, 64 << 24);\n\tw5300_write32(priv, W5300_RMSRH, 0);\n\tw5300_write32(priv, W5300_TMSRL, 64 << 24);\n\tw5300_write32(priv, W5300_TMSRH, 0);\n\tw5300_write(priv, W5300_MTYPE, 0x00ff);\n}\n\nstatic void w5300_hw_start(struct w5300_priv *priv)\n{\n\tw5300_write(priv, W5300_S0_MR, priv->promisc ?\n\t\t\t  S0_MR_MACRAW : S0_MR_MACRAW_MF);\n\tw5300_command(priv, S0_CR_OPEN);\n\tw5300_write(priv, W5300_S0_IMR, S0_IR_RECV | S0_IR_SENDOK);\n\tw5300_write(priv, W5300_IMR, IR_S0);\n}\n\nstatic void w5300_hw_close(struct w5300_priv *priv)\n{\n\tw5300_write(priv, W5300_IMR, 0);\n\tw5300_command(priv, S0_CR_CLOSE);\n}\n\n \n\nstatic void w5300_get_drvinfo(struct net_device *ndev,\n\t\t\t      struct ethtool_drvinfo *info)\n{\n\tstrscpy(info->driver, DRV_NAME, sizeof(info->driver));\n\tstrscpy(info->version, DRV_VERSION, sizeof(info->version));\n\tstrscpy(info->bus_info, dev_name(ndev->dev.parent),\n\t\tsizeof(info->bus_info));\n}\n\nstatic u32 w5300_get_link(struct net_device *ndev)\n{\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tif (gpio_is_valid(priv->link_gpio))\n\t\treturn !!gpio_get_value(priv->link_gpio);\n\n\treturn 1;\n}\n\nstatic u32 w5300_get_msglevel(struct net_device *ndev)\n{\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\treturn priv->msg_enable;\n}\n\nstatic void w5300_set_msglevel(struct net_device *ndev, u32 value)\n{\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tpriv->msg_enable = value;\n}\n\nstatic int w5300_get_regs_len(struct net_device *ndev)\n{\n\treturn W5300_REGS_LEN;\n}\n\nstatic void w5300_get_regs(struct net_device *ndev,\n\t\t\t   struct ethtool_regs *regs, void *_buf)\n{\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\tu8 *buf = _buf;\n\tu16 addr;\n\tu16 data;\n\n\tregs->version = 1;\n\tfor (addr = 0; addr < W5300_REGS_LEN; addr += 2) {\n\t\tswitch (addr & 0x23f) {\n\t\tcase W5300_S0_TX_FIFO:  \n\t\tcase W5300_S0_RX_FIFO:  \n\t\t\tdata = 0xffff;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdata = w5300_read(priv, addr);\n\t\t\tbreak;\n\t\t}\n\t\t*buf++ = data >> 8;\n\t\t*buf++ = data;\n\t}\n}\n\nstatic void w5300_tx_timeout(struct net_device *ndev, unsigned int txqueue)\n{\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tnetif_stop_queue(ndev);\n\tw5300_hw_reset(priv);\n\tw5300_hw_start(priv);\n\tndev->stats.tx_errors++;\n\tnetif_trans_update(ndev);\n\tnetif_wake_queue(ndev);\n}\n\nstatic netdev_tx_t w5300_start_tx(struct sk_buff *skb, struct net_device *ndev)\n{\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tnetif_stop_queue(ndev);\n\n\tw5300_write_frame(priv, skb->data, skb->len);\n\tndev->stats.tx_packets++;\n\tndev->stats.tx_bytes += skb->len;\n\tdev_kfree_skb(skb);\n\tnetif_dbg(priv, tx_queued, ndev, \"tx queued\\n\");\n\n\tw5300_command(priv, S0_CR_SEND);\n\n\treturn NETDEV_TX_OK;\n}\n\nstatic int w5300_napi_poll(struct napi_struct *napi, int budget)\n{\n\tstruct w5300_priv *priv = container_of(napi, struct w5300_priv, napi);\n\tstruct net_device *ndev = priv->ndev;\n\tstruct sk_buff *skb;\n\tint rx_count;\n\tu16 rx_len;\n\n\tfor (rx_count = 0; rx_count < budget; rx_count++) {\n\t\tu32 rx_fifo_len = w5300_read32(priv, W5300_S0_RX_RSR);\n\t\tif (rx_fifo_len == 0)\n\t\t\tbreak;\n\n\t\trx_len = w5300_read(priv, W5300_S0_RX_FIFO);\n\n\t\tskb = netdev_alloc_skb_ip_align(ndev, roundup(rx_len, 2));\n\t\tif (unlikely(!skb)) {\n\t\t\tu32 i;\n\t\t\tfor (i = 0; i < rx_fifo_len; i += 2)\n\t\t\t\tw5300_read(priv, W5300_S0_RX_FIFO);\n\t\t\tndev->stats.rx_dropped++;\n\t\t\treturn -ENOMEM;\n\t\t}\n\n\t\tskb_put(skb, rx_len);\n\t\tw5300_read_frame(priv, skb->data, rx_len);\n\t\tskb->protocol = eth_type_trans(skb, ndev);\n\n\t\tnetif_receive_skb(skb);\n\t\tndev->stats.rx_packets++;\n\t\tndev->stats.rx_bytes += rx_len;\n\t}\n\n\tif (rx_count < budget) {\n\t\tnapi_complete_done(napi, rx_count);\n\t\tw5300_write(priv, W5300_IMR, IR_S0);\n\t}\n\n\treturn rx_count;\n}\n\nstatic irqreturn_t w5300_interrupt(int irq, void *ndev_instance)\n{\n\tstruct net_device *ndev = ndev_instance;\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tint ir = w5300_read(priv, W5300_S0_IR);\n\tif (!ir)\n\t\treturn IRQ_NONE;\n\tw5300_write(priv, W5300_S0_IR, ir);\n\n\tif (ir & S0_IR_SENDOK) {\n\t\tnetif_dbg(priv, tx_done, ndev, \"tx done\\n\");\n\t\tnetif_wake_queue(ndev);\n\t}\n\n\tif (ir & S0_IR_RECV) {\n\t\tif (napi_schedule_prep(&priv->napi)) {\n\t\t\tw5300_write(priv, W5300_IMR, 0);\n\t\t\t__napi_schedule(&priv->napi);\n\t\t}\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t w5300_detect_link(int irq, void *ndev_instance)\n{\n\tstruct net_device *ndev = ndev_instance;\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tif (netif_running(ndev)) {\n\t\tif (gpio_get_value(priv->link_gpio) != 0) {\n\t\t\tnetif_info(priv, link, ndev, \"link is up\\n\");\n\t\t\tnetif_carrier_on(ndev);\n\t\t} else {\n\t\t\tnetif_info(priv, link, ndev, \"link is down\\n\");\n\t\t\tnetif_carrier_off(ndev);\n\t\t}\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void w5300_set_rx_mode(struct net_device *ndev)\n{\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\tbool set_promisc = (ndev->flags & IFF_PROMISC) != 0;\n\n\tif (priv->promisc != set_promisc) {\n\t\tpriv->promisc = set_promisc;\n\t\tw5300_hw_start(priv);\n\t}\n}\n\nstatic int w5300_set_macaddr(struct net_device *ndev, void *addr)\n{\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\tstruct sockaddr *sock_addr = addr;\n\n\tif (!is_valid_ether_addr(sock_addr->sa_data))\n\t\treturn -EADDRNOTAVAIL;\n\teth_hw_addr_set(ndev, sock_addr->sa_data);\n\tw5300_write_macaddr(priv);\n\treturn 0;\n}\n\nstatic int w5300_open(struct net_device *ndev)\n{\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tnetif_info(priv, ifup, ndev, \"enabling\\n\");\n\tw5300_hw_start(priv);\n\tnapi_enable(&priv->napi);\n\tnetif_start_queue(ndev);\n\tif (!gpio_is_valid(priv->link_gpio) ||\n\t    gpio_get_value(priv->link_gpio) != 0)\n\t\tnetif_carrier_on(ndev);\n\treturn 0;\n}\n\nstatic int w5300_stop(struct net_device *ndev)\n{\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tnetif_info(priv, ifdown, ndev, \"shutting down\\n\");\n\tw5300_hw_close(priv);\n\tnetif_carrier_off(ndev);\n\tnetif_stop_queue(ndev);\n\tnapi_disable(&priv->napi);\n\treturn 0;\n}\n\nstatic const struct ethtool_ops w5300_ethtool_ops = {\n\t.get_drvinfo\t\t= w5300_get_drvinfo,\n\t.get_msglevel\t\t= w5300_get_msglevel,\n\t.set_msglevel\t\t= w5300_set_msglevel,\n\t.get_link\t\t= w5300_get_link,\n\t.get_regs_len\t\t= w5300_get_regs_len,\n\t.get_regs\t\t= w5300_get_regs,\n};\n\nstatic const struct net_device_ops w5300_netdev_ops = {\n\t.ndo_open\t\t= w5300_open,\n\t.ndo_stop\t\t= w5300_stop,\n\t.ndo_start_xmit\t\t= w5300_start_tx,\n\t.ndo_tx_timeout\t\t= w5300_tx_timeout,\n\t.ndo_set_rx_mode\t= w5300_set_rx_mode,\n\t.ndo_set_mac_address\t= w5300_set_macaddr,\n\t.ndo_validate_addr\t= eth_validate_addr,\n};\n\nstatic int w5300_hw_probe(struct platform_device *pdev)\n{\n\tstruct wiznet_platform_data *data = dev_get_platdata(&pdev->dev);\n\tstruct net_device *ndev = platform_get_drvdata(pdev);\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\tconst char *name = netdev_name(ndev);\n\tstruct resource *mem;\n\tint mem_size;\n\tint irq;\n\tint ret;\n\n\tif (data && is_valid_ether_addr(data->mac_addr)) {\n\t\teth_hw_addr_set(ndev, data->mac_addr);\n\t} else {\n\t\teth_hw_addr_random(ndev);\n\t}\n\n\tmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tpriv->base = devm_ioremap_resource(&pdev->dev, mem);\n\tif (IS_ERR(priv->base))\n\t\treturn PTR_ERR(priv->base);\n\n\tmem_size = resource_size(mem);\n\n\tspin_lock_init(&priv->reg_lock);\n\tpriv->indirect = mem_size < W5300_BUS_DIRECT_SIZE;\n\tif (priv->indirect) {\n\t\tpriv->read  = w5300_read_indirect;\n\t\tpriv->write = w5300_write_indirect;\n\t} else {\n\t\tpriv->read  = w5300_read_direct;\n\t\tpriv->write = w5300_write_direct;\n\t}\n\n\tw5300_hw_reset(priv);\n\tif (w5300_read(priv, W5300_IDR) != IDR_W5300)\n\t\treturn -ENODEV;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\tret = request_irq(irq, w5300_interrupt,\n\t\t\t  IRQ_TYPE_LEVEL_LOW, name, ndev);\n\tif (ret < 0)\n\t\treturn ret;\n\tpriv->irq = irq;\n\n\tpriv->link_gpio = data ? data->link_gpio : -EINVAL;\n\tif (gpio_is_valid(priv->link_gpio)) {\n\t\tchar *link_name = devm_kzalloc(&pdev->dev, 16, GFP_KERNEL);\n\t\tif (!link_name)\n\t\t\treturn -ENOMEM;\n\t\tsnprintf(link_name, 16, \"%s-link\", name);\n\t\tpriv->link_irq = gpio_to_irq(priv->link_gpio);\n\t\tif (request_any_context_irq(priv->link_irq, w5300_detect_link,\n\t\t\t\tIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\n\t\t\t\tlink_name, priv->ndev) < 0)\n\t\t\tpriv->link_gpio = -EINVAL;\n\t}\n\n\tnetdev_info(ndev, \"at 0x%llx irq %d\\n\", (u64)mem->start, irq);\n\treturn 0;\n}\n\nstatic int w5300_probe(struct platform_device *pdev)\n{\n\tstruct w5300_priv *priv;\n\tstruct net_device *ndev;\n\tint err;\n\n\tndev = alloc_etherdev(sizeof(*priv));\n\tif (!ndev)\n\t\treturn -ENOMEM;\n\tSET_NETDEV_DEV(ndev, &pdev->dev);\n\tplatform_set_drvdata(pdev, ndev);\n\tpriv = netdev_priv(ndev);\n\tpriv->ndev = ndev;\n\n\tndev->netdev_ops = &w5300_netdev_ops;\n\tndev->ethtool_ops = &w5300_ethtool_ops;\n\tndev->watchdog_timeo = HZ;\n\tnetif_napi_add_weight(ndev, &priv->napi, w5300_napi_poll, 16);\n\n\t \n\tndev->features |= NETIF_F_VLAN_CHALLENGED;\n\n\terr = register_netdev(ndev);\n\tif (err < 0)\n\t\tgoto err_register;\n\n\terr = w5300_hw_probe(pdev);\n\tif (err < 0)\n\t\tgoto err_hw_probe;\n\n\treturn 0;\n\nerr_hw_probe:\n\tunregister_netdev(ndev);\nerr_register:\n\tfree_netdev(ndev);\n\treturn err;\n}\n\nstatic int w5300_remove(struct platform_device *pdev)\n{\n\tstruct net_device *ndev = platform_get_drvdata(pdev);\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tw5300_hw_reset(priv);\n\tfree_irq(priv->irq, ndev);\n\tif (gpio_is_valid(priv->link_gpio))\n\t\tfree_irq(priv->link_irq, ndev);\n\n\tunregister_netdev(ndev);\n\tfree_netdev(ndev);\n\treturn 0;\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int w5300_suspend(struct device *dev)\n{\n\tstruct net_device *ndev = dev_get_drvdata(dev);\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tif (netif_running(ndev)) {\n\t\tnetif_carrier_off(ndev);\n\t\tnetif_device_detach(ndev);\n\n\t\tw5300_hw_close(priv);\n\t}\n\treturn 0;\n}\n\nstatic int w5300_resume(struct device *dev)\n{\n\tstruct net_device *ndev = dev_get_drvdata(dev);\n\tstruct w5300_priv *priv = netdev_priv(ndev);\n\n\tif (!netif_running(ndev)) {\n\t\tw5300_hw_reset(priv);\n\t\tw5300_hw_start(priv);\n\n\t\tnetif_device_attach(ndev);\n\t\tif (!gpio_is_valid(priv->link_gpio) ||\n\t\t    gpio_get_value(priv->link_gpio) != 0)\n\t\t\tnetif_carrier_on(ndev);\n\t}\n\treturn 0;\n}\n#endif  \n\nstatic SIMPLE_DEV_PM_OPS(w5300_pm_ops, w5300_suspend, w5300_resume);\n\nstatic struct platform_driver w5300_driver = {\n\t.driver\t\t= {\n\t\t.name\t= DRV_NAME,\n\t\t.pm\t= &w5300_pm_ops,\n\t},\n\t.probe\t\t= w5300_probe,\n\t.remove\t\t= w5300_remove,\n};\n\nmodule_platform_driver(w5300_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}