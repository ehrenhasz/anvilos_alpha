{
  "module_name": "w5100.c",
  "hash_id": "82bfe370811d88c7ba4245b298ba36135209ffcb1977aa0bf5eeb5ad68e49c7d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/wiznet/w5100.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n#include <linux/platform_device.h>\n#include <linux/platform_data/wiznet.h>\n#include <linux/ethtool.h>\n#include <linux/skbuff.h>\n#include <linux/types.h>\n#include <linux/errno.h>\n#include <linux/delay.h>\n#include <linux/slab.h>\n#include <linux/spinlock.h>\n#include <linux/io.h>\n#include <linux/ioport.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/gpio.h>\n\n#include \"w5100.h\"\n\n#define DRV_NAME\t\"w5100\"\n#define DRV_VERSION\t\"2012-04-04\"\n\nMODULE_DESCRIPTION(\"WIZnet W5100 Ethernet driver v\"DRV_VERSION);\nMODULE_AUTHOR(\"Mike Sinkovsky <msink@permonline.ru>\");\nMODULE_ALIAS(\"platform:\"DRV_NAME);\nMODULE_LICENSE(\"GPL\");\n\n \n#define W5100_COMMON_REGS\t0x0000\n#define W5100_MR\t\t0x0000  \n#define   MR_RST\t\t  0x80  \n#define   MR_PB\t\t\t  0x10  \n#define   MR_AI\t\t\t  0x02  \n#define   MR_IND\t\t  0x01  \n#define W5100_SHAR\t\t0x0009  \n#define W5100_IR\t\t0x0015  \n#define W5100_COMMON_REGS_LEN\t0x0040\n\n#define W5100_Sn_MR\t\t0x0000  \n#define W5100_Sn_CR\t\t0x0001  \n#define W5100_Sn_IR\t\t0x0002  \n#define W5100_Sn_SR\t\t0x0003  \n#define W5100_Sn_TX_FSR\t\t0x0020  \n#define W5100_Sn_TX_RD\t\t0x0022  \n#define W5100_Sn_TX_WR\t\t0x0024  \n#define W5100_Sn_RX_RSR\t\t0x0026  \n#define W5100_Sn_RX_RD\t\t0x0028  \n\n#define S0_REGS(priv)\t\t((priv)->s0_regs)\n\n#define W5100_S0_MR(priv)\t(S0_REGS(priv) + W5100_Sn_MR)\n#define   S0_MR_MACRAW\t\t  0x04  \n#define   S0_MR_MF\t\t  0x40  \n#define   W5500_S0_MR_MF\t  0x80  \n#define W5100_S0_CR(priv)\t(S0_REGS(priv) + W5100_Sn_CR)\n#define   S0_CR_OPEN\t\t  0x01  \n#define   S0_CR_CLOSE\t\t  0x10  \n#define   S0_CR_SEND\t\t  0x20  \n#define   S0_CR_RECV\t\t  0x40  \n#define W5100_S0_IR(priv)\t(S0_REGS(priv) + W5100_Sn_IR)\n#define   S0_IR_SENDOK\t\t  0x10  \n#define   S0_IR_RECV\t\t  0x04  \n#define W5100_S0_SR(priv)\t(S0_REGS(priv) + W5100_Sn_SR)\n#define   S0_SR_MACRAW\t\t  0x42  \n#define W5100_S0_TX_FSR(priv)\t(S0_REGS(priv) + W5100_Sn_TX_FSR)\n#define W5100_S0_TX_RD(priv)\t(S0_REGS(priv) + W5100_Sn_TX_RD)\n#define W5100_S0_TX_WR(priv)\t(S0_REGS(priv) + W5100_Sn_TX_WR)\n#define W5100_S0_RX_RSR(priv)\t(S0_REGS(priv) + W5100_Sn_RX_RSR)\n#define W5100_S0_RX_RD(priv)\t(S0_REGS(priv) + W5100_Sn_RX_RD)\n\n#define W5100_S0_REGS_LEN\t0x0040\n\n \n#define W5100_IMR\t\t0x0016  \n#define   IR_S0\t\t\t  0x01  \n#define W5100_RTR\t\t0x0017  \n#define   RTR_DEFAULT\t\t  2000  \n\n \n#define W5100_RMSR\t\t0x001a  \n#define W5100_TMSR\t\t0x001b  \n\n#define W5100_S0_REGS\t\t0x0400\n\n#define W5100_TX_MEM_START\t0x4000\n#define W5100_TX_MEM_SIZE\t0x2000\n#define W5100_RX_MEM_START\t0x6000\n#define W5100_RX_MEM_SIZE\t0x2000\n\n \n#define W5200_S0_REGS\t\t0x4000\n\n#define W5200_Sn_RXMEM_SIZE(n)\t(0x401e + (n) * 0x0100)  \n#define W5200_Sn_TXMEM_SIZE(n)\t(0x401f + (n) * 0x0100)  \n\n#define W5200_TX_MEM_START\t0x8000\n#define W5200_TX_MEM_SIZE\t0x4000\n#define W5200_RX_MEM_START\t0xc000\n#define W5200_RX_MEM_SIZE\t0x4000\n\n \n#define W5500_SIMR\t\t0x0018  \n#define W5500_RTR\t\t0x0019  \n\n#define W5500_S0_REGS\t\t0x10000\n\n#define W5500_Sn_RXMEM_SIZE(n)\t\\\n\t\t(0x1001e + (n) * 0x40000)  \n#define W5500_Sn_TXMEM_SIZE(n)\t\\\n\t\t(0x1001f + (n) * 0x40000)  \n\n#define W5500_TX_MEM_START\t0x20000\n#define W5500_TX_MEM_SIZE\t0x04000\n#define W5500_RX_MEM_START\t0x30000\n#define W5500_RX_MEM_SIZE\t0x04000\n\n \n\nstruct w5100_priv {\n\tconst struct w5100_ops *ops;\n\n\t \n\tu32 s0_regs;\n\t \n\tu32 s0_tx_buf;\n\tu16 s0_tx_buf_size;\n\t \n\tu32 s0_rx_buf;\n\tu16 s0_rx_buf_size;\n\n\tint irq;\n\tint link_irq;\n\tint link_gpio;\n\n\tstruct napi_struct napi;\n\tstruct net_device *ndev;\n\tbool promisc;\n\tu32 msg_enable;\n\n\tstruct workqueue_struct *xfer_wq;\n\tstruct work_struct rx_work;\n\tstruct sk_buff *tx_skb;\n\tstruct work_struct tx_work;\n\tstruct work_struct setrx_work;\n\tstruct work_struct restart_work;\n};\n\n \n\nstruct w5100_mmio_priv {\n\tvoid __iomem *base;\n\t \n\tspinlock_t reg_lock;\n};\n\nstatic inline struct w5100_mmio_priv *w5100_mmio_priv(struct net_device *dev)\n{\n\treturn w5100_ops_priv(dev);\n}\n\nstatic inline void __iomem *w5100_mmio(struct net_device *ndev)\n{\n\tstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\n\n\treturn mmio_priv->base;\n}\n\n \nstatic inline int w5100_read_direct(struct net_device *ndev, u32 addr)\n{\n\treturn ioread8(w5100_mmio(ndev) + (addr << CONFIG_WIZNET_BUS_SHIFT));\n}\n\nstatic inline int __w5100_write_direct(struct net_device *ndev, u32 addr,\n\t\t\t\t       u8 data)\n{\n\tiowrite8(data, w5100_mmio(ndev) + (addr << CONFIG_WIZNET_BUS_SHIFT));\n\n\treturn 0;\n}\n\nstatic inline int w5100_write_direct(struct net_device *ndev, u32 addr, u8 data)\n{\n\t__w5100_write_direct(ndev, addr, data);\n\n\treturn 0;\n}\n\nstatic int w5100_read16_direct(struct net_device *ndev, u32 addr)\n{\n\tu16 data;\n\tdata  = w5100_read_direct(ndev, addr) << 8;\n\tdata |= w5100_read_direct(ndev, addr + 1);\n\treturn data;\n}\n\nstatic int w5100_write16_direct(struct net_device *ndev, u32 addr, u16 data)\n{\n\t__w5100_write_direct(ndev, addr, data >> 8);\n\t__w5100_write_direct(ndev, addr + 1, data);\n\n\treturn 0;\n}\n\nstatic int w5100_readbulk_direct(struct net_device *ndev, u32 addr, u8 *buf,\n\t\t\t\t int len)\n{\n\tint i;\n\n\tfor (i = 0; i < len; i++, addr++)\n\t\t*buf++ = w5100_read_direct(ndev, addr);\n\n\treturn 0;\n}\n\nstatic int w5100_writebulk_direct(struct net_device *ndev, u32 addr,\n\t\t\t\t  const u8 *buf, int len)\n{\n\tint i;\n\n\tfor (i = 0; i < len; i++, addr++)\n\t\t__w5100_write_direct(ndev, addr, *buf++);\n\n\treturn 0;\n}\n\nstatic int w5100_mmio_init(struct net_device *ndev)\n{\n\tstruct platform_device *pdev = to_platform_device(ndev->dev.parent);\n\tstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\n\n\tspin_lock_init(&mmio_priv->reg_lock);\n\n\tmmio_priv->base = devm_platform_get_and_ioremap_resource(pdev, 0, NULL);\n\tif (IS_ERR(mmio_priv->base))\n\t\treturn PTR_ERR(mmio_priv->base);\n\n\treturn 0;\n}\n\nstatic const struct w5100_ops w5100_mmio_direct_ops = {\n\t.chip_id = W5100,\n\t.read = w5100_read_direct,\n\t.write = w5100_write_direct,\n\t.read16 = w5100_read16_direct,\n\t.write16 = w5100_write16_direct,\n\t.readbulk = w5100_readbulk_direct,\n\t.writebulk = w5100_writebulk_direct,\n\t.init = w5100_mmio_init,\n};\n\n \n#define W5100_IDM_AR\t\t0x01    \n#define W5100_IDM_DR\t\t0x03    \n\nstatic int w5100_read_indirect(struct net_device *ndev, u32 addr)\n{\n\tstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\n\tunsigned long flags;\n\tu8 data;\n\n\tspin_lock_irqsave(&mmio_priv->reg_lock, flags);\n\tw5100_write16_direct(ndev, W5100_IDM_AR, addr);\n\tdata = w5100_read_direct(ndev, W5100_IDM_DR);\n\tspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\n\n\treturn data;\n}\n\nstatic int w5100_write_indirect(struct net_device *ndev, u32 addr, u8 data)\n{\n\tstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&mmio_priv->reg_lock, flags);\n\tw5100_write16_direct(ndev, W5100_IDM_AR, addr);\n\tw5100_write_direct(ndev, W5100_IDM_DR, data);\n\tspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\n\n\treturn 0;\n}\n\nstatic int w5100_read16_indirect(struct net_device *ndev, u32 addr)\n{\n\tstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\n\tunsigned long flags;\n\tu16 data;\n\n\tspin_lock_irqsave(&mmio_priv->reg_lock, flags);\n\tw5100_write16_direct(ndev, W5100_IDM_AR, addr);\n\tdata  = w5100_read_direct(ndev, W5100_IDM_DR) << 8;\n\tdata |= w5100_read_direct(ndev, W5100_IDM_DR);\n\tspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\n\n\treturn data;\n}\n\nstatic int w5100_write16_indirect(struct net_device *ndev, u32 addr, u16 data)\n{\n\tstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&mmio_priv->reg_lock, flags);\n\tw5100_write16_direct(ndev, W5100_IDM_AR, addr);\n\t__w5100_write_direct(ndev, W5100_IDM_DR, data >> 8);\n\tw5100_write_direct(ndev, W5100_IDM_DR, data);\n\tspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\n\n\treturn 0;\n}\n\nstatic int w5100_readbulk_indirect(struct net_device *ndev, u32 addr, u8 *buf,\n\t\t\t\t   int len)\n{\n\tstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\n\tunsigned long flags;\n\tint i;\n\n\tspin_lock_irqsave(&mmio_priv->reg_lock, flags);\n\tw5100_write16_direct(ndev, W5100_IDM_AR, addr);\n\n\tfor (i = 0; i < len; i++)\n\t\t*buf++ = w5100_read_direct(ndev, W5100_IDM_DR);\n\n\tspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\n\n\treturn 0;\n}\n\nstatic int w5100_writebulk_indirect(struct net_device *ndev, u32 addr,\n\t\t\t\t    const u8 *buf, int len)\n{\n\tstruct w5100_mmio_priv *mmio_priv = w5100_mmio_priv(ndev);\n\tunsigned long flags;\n\tint i;\n\n\tspin_lock_irqsave(&mmio_priv->reg_lock, flags);\n\tw5100_write16_direct(ndev, W5100_IDM_AR, addr);\n\n\tfor (i = 0; i < len; i++)\n\t\t__w5100_write_direct(ndev, W5100_IDM_DR, *buf++);\n\n\tspin_unlock_irqrestore(&mmio_priv->reg_lock, flags);\n\n\treturn 0;\n}\n\nstatic int w5100_reset_indirect(struct net_device *ndev)\n{\n\tw5100_write_direct(ndev, W5100_MR, MR_RST);\n\tmdelay(5);\n\tw5100_write_direct(ndev, W5100_MR, MR_PB | MR_AI | MR_IND);\n\n\treturn 0;\n}\n\nstatic const struct w5100_ops w5100_mmio_indirect_ops = {\n\t.chip_id = W5100,\n\t.read = w5100_read_indirect,\n\t.write = w5100_write_indirect,\n\t.read16 = w5100_read16_indirect,\n\t.write16 = w5100_write16_indirect,\n\t.readbulk = w5100_readbulk_indirect,\n\t.writebulk = w5100_writebulk_indirect,\n\t.init = w5100_mmio_init,\n\t.reset = w5100_reset_indirect,\n};\n\n#if defined(CONFIG_WIZNET_BUS_DIRECT)\n\nstatic int w5100_read(struct w5100_priv *priv, u32 addr)\n{\n\treturn w5100_read_direct(priv->ndev, addr);\n}\n\nstatic int w5100_write(struct w5100_priv *priv, u32 addr, u8 data)\n{\n\treturn w5100_write_direct(priv->ndev, addr, data);\n}\n\nstatic int w5100_read16(struct w5100_priv *priv, u32 addr)\n{\n\treturn w5100_read16_direct(priv->ndev, addr);\n}\n\nstatic int w5100_write16(struct w5100_priv *priv, u32 addr, u16 data)\n{\n\treturn w5100_write16_direct(priv->ndev, addr, data);\n}\n\nstatic int w5100_readbulk(struct w5100_priv *priv, u32 addr, u8 *buf, int len)\n{\n\treturn w5100_readbulk_direct(priv->ndev, addr, buf, len);\n}\n\nstatic int w5100_writebulk(struct w5100_priv *priv, u32 addr, const u8 *buf,\n\t\t\t   int len)\n{\n\treturn w5100_writebulk_direct(priv->ndev, addr, buf, len);\n}\n\n#elif defined(CONFIG_WIZNET_BUS_INDIRECT)\n\nstatic int w5100_read(struct w5100_priv *priv, u32 addr)\n{\n\treturn w5100_read_indirect(priv->ndev, addr);\n}\n\nstatic int w5100_write(struct w5100_priv *priv, u32 addr, u8 data)\n{\n\treturn w5100_write_indirect(priv->ndev, addr, data);\n}\n\nstatic int w5100_read16(struct w5100_priv *priv, u32 addr)\n{\n\treturn w5100_read16_indirect(priv->ndev, addr);\n}\n\nstatic int w5100_write16(struct w5100_priv *priv, u32 addr, u16 data)\n{\n\treturn w5100_write16_indirect(priv->ndev, addr, data);\n}\n\nstatic int w5100_readbulk(struct w5100_priv *priv, u32 addr, u8 *buf, int len)\n{\n\treturn w5100_readbulk_indirect(priv->ndev, addr, buf, len);\n}\n\nstatic int w5100_writebulk(struct w5100_priv *priv, u32 addr, const u8 *buf,\n\t\t\t   int len)\n{\n\treturn w5100_writebulk_indirect(priv->ndev, addr, buf, len);\n}\n\n#else  \n\nstatic int w5100_read(struct w5100_priv *priv, u32 addr)\n{\n\treturn priv->ops->read(priv->ndev, addr);\n}\n\nstatic int w5100_write(struct w5100_priv *priv, u32 addr, u8 data)\n{\n\treturn priv->ops->write(priv->ndev, addr, data);\n}\n\nstatic int w5100_read16(struct w5100_priv *priv, u32 addr)\n{\n\treturn priv->ops->read16(priv->ndev, addr);\n}\n\nstatic int w5100_write16(struct w5100_priv *priv, u32 addr, u16 data)\n{\n\treturn priv->ops->write16(priv->ndev, addr, data);\n}\n\nstatic int w5100_readbulk(struct w5100_priv *priv, u32 addr, u8 *buf, int len)\n{\n\treturn priv->ops->readbulk(priv->ndev, addr, buf, len);\n}\n\nstatic int w5100_writebulk(struct w5100_priv *priv, u32 addr, const u8 *buf,\n\t\t\t   int len)\n{\n\treturn priv->ops->writebulk(priv->ndev, addr, buf, len);\n}\n\n#endif\n\nstatic int w5100_readbuf(struct w5100_priv *priv, u16 offset, u8 *buf, int len)\n{\n\tu32 addr;\n\tint remain = 0;\n\tint ret;\n\tconst u32 mem_start = priv->s0_rx_buf;\n\tconst u16 mem_size = priv->s0_rx_buf_size;\n\n\toffset %= mem_size;\n\taddr = mem_start + offset;\n\n\tif (offset + len > mem_size) {\n\t\tremain = (offset + len) % mem_size;\n\t\tlen = mem_size - offset;\n\t}\n\n\tret = w5100_readbulk(priv, addr, buf, len);\n\tif (ret || !remain)\n\t\treturn ret;\n\n\treturn w5100_readbulk(priv, mem_start, buf + len, remain);\n}\n\nstatic int w5100_writebuf(struct w5100_priv *priv, u16 offset, const u8 *buf,\n\t\t\t  int len)\n{\n\tu32 addr;\n\tint ret;\n\tint remain = 0;\n\tconst u32 mem_start = priv->s0_tx_buf;\n\tconst u16 mem_size = priv->s0_tx_buf_size;\n\n\toffset %= mem_size;\n\taddr = mem_start + offset;\n\n\tif (offset + len > mem_size) {\n\t\tremain = (offset + len) % mem_size;\n\t\tlen = mem_size - offset;\n\t}\n\n\tret = w5100_writebulk(priv, addr, buf, len);\n\tif (ret || !remain)\n\t\treturn ret;\n\n\treturn w5100_writebulk(priv, mem_start, buf + len, remain);\n}\n\nstatic int w5100_reset(struct w5100_priv *priv)\n{\n\tif (priv->ops->reset)\n\t\treturn priv->ops->reset(priv->ndev);\n\n\tw5100_write(priv, W5100_MR, MR_RST);\n\tmdelay(5);\n\tw5100_write(priv, W5100_MR, MR_PB);\n\n\treturn 0;\n}\n\nstatic int w5100_command(struct w5100_priv *priv, u16 cmd)\n{\n\tunsigned long timeout;\n\n\tw5100_write(priv, W5100_S0_CR(priv), cmd);\n\n\ttimeout = jiffies + msecs_to_jiffies(100);\n\n\twhile (w5100_read(priv, W5100_S0_CR(priv)) != 0) {\n\t\tif (time_after(jiffies, timeout))\n\t\t\treturn -EIO;\n\t\tcpu_relax();\n\t}\n\n\treturn 0;\n}\n\nstatic void w5100_write_macaddr(struct w5100_priv *priv)\n{\n\tstruct net_device *ndev = priv->ndev;\n\n\tw5100_writebulk(priv, W5100_SHAR, ndev->dev_addr, ETH_ALEN);\n}\n\nstatic void w5100_socket_intr_mask(struct w5100_priv *priv, u8 mask)\n{\n\tu32 imr;\n\n\tif (priv->ops->chip_id == W5500)\n\t\timr = W5500_SIMR;\n\telse\n\t\timr = W5100_IMR;\n\n\tw5100_write(priv, imr, mask);\n}\n\nstatic void w5100_enable_intr(struct w5100_priv *priv)\n{\n\tw5100_socket_intr_mask(priv, IR_S0);\n}\n\nstatic void w5100_disable_intr(struct w5100_priv *priv)\n{\n\tw5100_socket_intr_mask(priv, 0);\n}\n\nstatic void w5100_memory_configure(struct w5100_priv *priv)\n{\n\t \n\tw5100_write(priv, W5100_RMSR, 0x03);\n\tw5100_write(priv, W5100_TMSR, 0x03);\n}\n\nstatic void w5200_memory_configure(struct w5100_priv *priv)\n{\n\tint i;\n\n\t \n\tw5100_write(priv, W5200_Sn_RXMEM_SIZE(0), 0x10);\n\tw5100_write(priv, W5200_Sn_TXMEM_SIZE(0), 0x10);\n\n\tfor (i = 1; i < 8; i++) {\n\t\tw5100_write(priv, W5200_Sn_RXMEM_SIZE(i), 0);\n\t\tw5100_write(priv, W5200_Sn_TXMEM_SIZE(i), 0);\n\t}\n}\n\nstatic void w5500_memory_configure(struct w5100_priv *priv)\n{\n\tint i;\n\n\t \n\tw5100_write(priv, W5500_Sn_RXMEM_SIZE(0), 0x10);\n\tw5100_write(priv, W5500_Sn_TXMEM_SIZE(0), 0x10);\n\n\tfor (i = 1; i < 8; i++) {\n\t\tw5100_write(priv, W5500_Sn_RXMEM_SIZE(i), 0);\n\t\tw5100_write(priv, W5500_Sn_TXMEM_SIZE(i), 0);\n\t}\n}\n\nstatic int w5100_hw_reset(struct w5100_priv *priv)\n{\n\tu32 rtr;\n\n\tw5100_reset(priv);\n\n\tw5100_disable_intr(priv);\n\tw5100_write_macaddr(priv);\n\n\tswitch (priv->ops->chip_id) {\n\tcase W5100:\n\t\tw5100_memory_configure(priv);\n\t\trtr = W5100_RTR;\n\t\tbreak;\n\tcase W5200:\n\t\tw5200_memory_configure(priv);\n\t\trtr = W5100_RTR;\n\t\tbreak;\n\tcase W5500:\n\t\tw5500_memory_configure(priv);\n\t\trtr = W5500_RTR;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (w5100_read16(priv, rtr) != RTR_DEFAULT)\n\t\treturn -ENODEV;\n\n\treturn 0;\n}\n\nstatic void w5100_hw_start(struct w5100_priv *priv)\n{\n\tu8 mode = S0_MR_MACRAW;\n\n\tif (!priv->promisc) {\n\t\tif (priv->ops->chip_id == W5500)\n\t\t\tmode |= W5500_S0_MR_MF;\n\t\telse\n\t\t\tmode |= S0_MR_MF;\n\t}\n\n\tw5100_write(priv, W5100_S0_MR(priv), mode);\n\tw5100_command(priv, S0_CR_OPEN);\n\tw5100_enable_intr(priv);\n}\n\nstatic void w5100_hw_close(struct w5100_priv *priv)\n{\n\tw5100_disable_intr(priv);\n\tw5100_command(priv, S0_CR_CLOSE);\n}\n\n \n\nstatic void w5100_get_drvinfo(struct net_device *ndev,\n\t\t\t      struct ethtool_drvinfo *info)\n{\n\tstrscpy(info->driver, DRV_NAME, sizeof(info->driver));\n\tstrscpy(info->version, DRV_VERSION, sizeof(info->version));\n\tstrscpy(info->bus_info, dev_name(ndev->dev.parent),\n\t\tsizeof(info->bus_info));\n}\n\nstatic u32 w5100_get_link(struct net_device *ndev)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tif (gpio_is_valid(priv->link_gpio))\n\t\treturn !!gpio_get_value(priv->link_gpio);\n\n\treturn 1;\n}\n\nstatic u32 w5100_get_msglevel(struct net_device *ndev)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\treturn priv->msg_enable;\n}\n\nstatic void w5100_set_msglevel(struct net_device *ndev, u32 value)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tpriv->msg_enable = value;\n}\n\nstatic int w5100_get_regs_len(struct net_device *ndev)\n{\n\treturn W5100_COMMON_REGS_LEN + W5100_S0_REGS_LEN;\n}\n\nstatic void w5100_get_regs(struct net_device *ndev,\n\t\t\t   struct ethtool_regs *regs, void *buf)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tregs->version = 1;\n\tw5100_readbulk(priv, W5100_COMMON_REGS, buf, W5100_COMMON_REGS_LEN);\n\tbuf += W5100_COMMON_REGS_LEN;\n\tw5100_readbulk(priv, S0_REGS(priv), buf, W5100_S0_REGS_LEN);\n}\n\nstatic void w5100_restart(struct net_device *ndev)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tnetif_stop_queue(ndev);\n\tw5100_hw_reset(priv);\n\tw5100_hw_start(priv);\n\tndev->stats.tx_errors++;\n\tnetif_trans_update(ndev);\n\tnetif_wake_queue(ndev);\n}\n\nstatic void w5100_restart_work(struct work_struct *work)\n{\n\tstruct w5100_priv *priv = container_of(work, struct w5100_priv,\n\t\t\t\t\t       restart_work);\n\n\tw5100_restart(priv->ndev);\n}\n\nstatic void w5100_tx_timeout(struct net_device *ndev, unsigned int txqueue)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tif (priv->ops->may_sleep)\n\t\tschedule_work(&priv->restart_work);\n\telse\n\t\tw5100_restart(ndev);\n}\n\nstatic void w5100_tx_skb(struct net_device *ndev, struct sk_buff *skb)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\tu16 offset;\n\n\toffset = w5100_read16(priv, W5100_S0_TX_WR(priv));\n\tw5100_writebuf(priv, offset, skb->data, skb->len);\n\tw5100_write16(priv, W5100_S0_TX_WR(priv), offset + skb->len);\n\tndev->stats.tx_bytes += skb->len;\n\tndev->stats.tx_packets++;\n\tdev_kfree_skb(skb);\n\n\tw5100_command(priv, S0_CR_SEND);\n}\n\nstatic void w5100_tx_work(struct work_struct *work)\n{\n\tstruct w5100_priv *priv = container_of(work, struct w5100_priv,\n\t\t\t\t\t       tx_work);\n\tstruct sk_buff *skb = priv->tx_skb;\n\n\tpriv->tx_skb = NULL;\n\n\tif (WARN_ON(!skb))\n\t\treturn;\n\tw5100_tx_skb(priv->ndev, skb);\n}\n\nstatic netdev_tx_t w5100_start_tx(struct sk_buff *skb, struct net_device *ndev)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tnetif_stop_queue(ndev);\n\n\tif (priv->ops->may_sleep) {\n\t\tWARN_ON(priv->tx_skb);\n\t\tpriv->tx_skb = skb;\n\t\tqueue_work(priv->xfer_wq, &priv->tx_work);\n\t} else {\n\t\tw5100_tx_skb(ndev, skb);\n\t}\n\n\treturn NETDEV_TX_OK;\n}\n\nstatic struct sk_buff *w5100_rx_skb(struct net_device *ndev)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\tstruct sk_buff *skb;\n\tu16 rx_len;\n\tu16 offset;\n\tu8 header[2];\n\tu16 rx_buf_len = w5100_read16(priv, W5100_S0_RX_RSR(priv));\n\n\tif (rx_buf_len == 0)\n\t\treturn NULL;\n\n\toffset = w5100_read16(priv, W5100_S0_RX_RD(priv));\n\tw5100_readbuf(priv, offset, header, 2);\n\trx_len = get_unaligned_be16(header) - 2;\n\n\tskb = netdev_alloc_skb_ip_align(ndev, rx_len);\n\tif (unlikely(!skb)) {\n\t\tw5100_write16(priv, W5100_S0_RX_RD(priv), offset + rx_buf_len);\n\t\tw5100_command(priv, S0_CR_RECV);\n\t\tndev->stats.rx_dropped++;\n\t\treturn NULL;\n\t}\n\n\tskb_put(skb, rx_len);\n\tw5100_readbuf(priv, offset + 2, skb->data, rx_len);\n\tw5100_write16(priv, W5100_S0_RX_RD(priv), offset + 2 + rx_len);\n\tw5100_command(priv, S0_CR_RECV);\n\tskb->protocol = eth_type_trans(skb, ndev);\n\n\tndev->stats.rx_packets++;\n\tndev->stats.rx_bytes += rx_len;\n\n\treturn skb;\n}\n\nstatic void w5100_rx_work(struct work_struct *work)\n{\n\tstruct w5100_priv *priv = container_of(work, struct w5100_priv,\n\t\t\t\t\t       rx_work);\n\tstruct sk_buff *skb;\n\n\twhile ((skb = w5100_rx_skb(priv->ndev)))\n\t\tnetif_rx(skb);\n\n\tw5100_enable_intr(priv);\n}\n\nstatic int w5100_napi_poll(struct napi_struct *napi, int budget)\n{\n\tstruct w5100_priv *priv = container_of(napi, struct w5100_priv, napi);\n\tint rx_count;\n\n\tfor (rx_count = 0; rx_count < budget; rx_count++) {\n\t\tstruct sk_buff *skb = w5100_rx_skb(priv->ndev);\n\n\t\tif (skb)\n\t\t\tnetif_receive_skb(skb);\n\t\telse\n\t\t\tbreak;\n\t}\n\n\tif (rx_count < budget) {\n\t\tnapi_complete_done(napi, rx_count);\n\t\tw5100_enable_intr(priv);\n\t}\n\n\treturn rx_count;\n}\n\nstatic irqreturn_t w5100_interrupt(int irq, void *ndev_instance)\n{\n\tstruct net_device *ndev = ndev_instance;\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tint ir = w5100_read(priv, W5100_S0_IR(priv));\n\tif (!ir)\n\t\treturn IRQ_NONE;\n\tw5100_write(priv, W5100_S0_IR(priv), ir);\n\n\tif (ir & S0_IR_SENDOK) {\n\t\tnetif_dbg(priv, tx_done, ndev, \"tx done\\n\");\n\t\tnetif_wake_queue(ndev);\n\t}\n\n\tif (ir & S0_IR_RECV) {\n\t\tw5100_disable_intr(priv);\n\n\t\tif (priv->ops->may_sleep)\n\t\t\tqueue_work(priv->xfer_wq, &priv->rx_work);\n\t\telse if (napi_schedule_prep(&priv->napi))\n\t\t\t__napi_schedule(&priv->napi);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t w5100_detect_link(int irq, void *ndev_instance)\n{\n\tstruct net_device *ndev = ndev_instance;\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tif (netif_running(ndev)) {\n\t\tif (gpio_get_value(priv->link_gpio) != 0) {\n\t\t\tnetif_info(priv, link, ndev, \"link is up\\n\");\n\t\t\tnetif_carrier_on(ndev);\n\t\t} else {\n\t\t\tnetif_info(priv, link, ndev, \"link is down\\n\");\n\t\t\tnetif_carrier_off(ndev);\n\t\t}\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void w5100_setrx_work(struct work_struct *work)\n{\n\tstruct w5100_priv *priv = container_of(work, struct w5100_priv,\n\t\t\t\t\t       setrx_work);\n\n\tw5100_hw_start(priv);\n}\n\nstatic void w5100_set_rx_mode(struct net_device *ndev)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\tbool set_promisc = (ndev->flags & IFF_PROMISC) != 0;\n\n\tif (priv->promisc != set_promisc) {\n\t\tpriv->promisc = set_promisc;\n\n\t\tif (priv->ops->may_sleep)\n\t\t\tschedule_work(&priv->setrx_work);\n\t\telse\n\t\t\tw5100_hw_start(priv);\n\t}\n}\n\nstatic int w5100_set_macaddr(struct net_device *ndev, void *addr)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\tstruct sockaddr *sock_addr = addr;\n\n\tif (!is_valid_ether_addr(sock_addr->sa_data))\n\t\treturn -EADDRNOTAVAIL;\n\teth_hw_addr_set(ndev, sock_addr->sa_data);\n\tw5100_write_macaddr(priv);\n\treturn 0;\n}\n\nstatic int w5100_open(struct net_device *ndev)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tnetif_info(priv, ifup, ndev, \"enabling\\n\");\n\tw5100_hw_start(priv);\n\tnapi_enable(&priv->napi);\n\tnetif_start_queue(ndev);\n\tif (!gpio_is_valid(priv->link_gpio) ||\n\t    gpio_get_value(priv->link_gpio) != 0)\n\t\tnetif_carrier_on(ndev);\n\treturn 0;\n}\n\nstatic int w5100_stop(struct net_device *ndev)\n{\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tnetif_info(priv, ifdown, ndev, \"shutting down\\n\");\n\tw5100_hw_close(priv);\n\tnetif_carrier_off(ndev);\n\tnetif_stop_queue(ndev);\n\tnapi_disable(&priv->napi);\n\treturn 0;\n}\n\nstatic const struct ethtool_ops w5100_ethtool_ops = {\n\t.get_drvinfo\t\t= w5100_get_drvinfo,\n\t.get_msglevel\t\t= w5100_get_msglevel,\n\t.set_msglevel\t\t= w5100_set_msglevel,\n\t.get_link\t\t= w5100_get_link,\n\t.get_regs_len\t\t= w5100_get_regs_len,\n\t.get_regs\t\t= w5100_get_regs,\n};\n\nstatic const struct net_device_ops w5100_netdev_ops = {\n\t.ndo_open\t\t= w5100_open,\n\t.ndo_stop\t\t= w5100_stop,\n\t.ndo_start_xmit\t\t= w5100_start_tx,\n\t.ndo_tx_timeout\t\t= w5100_tx_timeout,\n\t.ndo_set_rx_mode\t= w5100_set_rx_mode,\n\t.ndo_set_mac_address\t= w5100_set_macaddr,\n\t.ndo_validate_addr\t= eth_validate_addr,\n};\n\nstatic int w5100_mmio_probe(struct platform_device *pdev)\n{\n\tstruct wiznet_platform_data *data = dev_get_platdata(&pdev->dev);\n\tconst void *mac_addr = NULL;\n\tstruct resource *mem;\n\tconst struct w5100_ops *ops;\n\tint irq;\n\n\tif (data && is_valid_ether_addr(data->mac_addr))\n\t\tmac_addr = data->mac_addr;\n\n\tmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!mem)\n\t\treturn -EINVAL;\n\tif (resource_size(mem) < W5100_BUS_DIRECT_SIZE)\n\t\tops = &w5100_mmio_indirect_ops;\n\telse\n\t\tops = &w5100_mmio_direct_ops;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\treturn w5100_probe(&pdev->dev, ops, sizeof(struct w5100_mmio_priv),\n\t\t\t   mac_addr, irq, data ? data->link_gpio : -EINVAL);\n}\n\nstatic int w5100_mmio_remove(struct platform_device *pdev)\n{\n\tw5100_remove(&pdev->dev);\n\n\treturn 0;\n}\n\nvoid *w5100_ops_priv(const struct net_device *ndev)\n{\n\treturn netdev_priv(ndev) +\n\t       ALIGN(sizeof(struct w5100_priv), NETDEV_ALIGN);\n}\nEXPORT_SYMBOL_GPL(w5100_ops_priv);\n\nint w5100_probe(struct device *dev, const struct w5100_ops *ops,\n\t\tint sizeof_ops_priv, const void *mac_addr, int irq,\n\t\tint link_gpio)\n{\n\tstruct w5100_priv *priv;\n\tstruct net_device *ndev;\n\tint err;\n\tsize_t alloc_size;\n\n\talloc_size = sizeof(*priv);\n\tif (sizeof_ops_priv) {\n\t\talloc_size = ALIGN(alloc_size, NETDEV_ALIGN);\n\t\talloc_size += sizeof_ops_priv;\n\t}\n\talloc_size += NETDEV_ALIGN - 1;\n\n\tndev = alloc_etherdev(alloc_size);\n\tif (!ndev)\n\t\treturn -ENOMEM;\n\tSET_NETDEV_DEV(ndev, dev);\n\tdev_set_drvdata(dev, ndev);\n\tpriv = netdev_priv(ndev);\n\n\tswitch (ops->chip_id) {\n\tcase W5100:\n\t\tpriv->s0_regs = W5100_S0_REGS;\n\t\tpriv->s0_tx_buf = W5100_TX_MEM_START;\n\t\tpriv->s0_tx_buf_size = W5100_TX_MEM_SIZE;\n\t\tpriv->s0_rx_buf = W5100_RX_MEM_START;\n\t\tpriv->s0_rx_buf_size = W5100_RX_MEM_SIZE;\n\t\tbreak;\n\tcase W5200:\n\t\tpriv->s0_regs = W5200_S0_REGS;\n\t\tpriv->s0_tx_buf = W5200_TX_MEM_START;\n\t\tpriv->s0_tx_buf_size = W5200_TX_MEM_SIZE;\n\t\tpriv->s0_rx_buf = W5200_RX_MEM_START;\n\t\tpriv->s0_rx_buf_size = W5200_RX_MEM_SIZE;\n\t\tbreak;\n\tcase W5500:\n\t\tpriv->s0_regs = W5500_S0_REGS;\n\t\tpriv->s0_tx_buf = W5500_TX_MEM_START;\n\t\tpriv->s0_tx_buf_size = W5500_TX_MEM_SIZE;\n\t\tpriv->s0_rx_buf = W5500_RX_MEM_START;\n\t\tpriv->s0_rx_buf_size = W5500_RX_MEM_SIZE;\n\t\tbreak;\n\tdefault:\n\t\terr = -EINVAL;\n\t\tgoto err_register;\n\t}\n\n\tpriv->ndev = ndev;\n\tpriv->ops = ops;\n\tpriv->irq = irq;\n\tpriv->link_gpio = link_gpio;\n\n\tndev->netdev_ops = &w5100_netdev_ops;\n\tndev->ethtool_ops = &w5100_ethtool_ops;\n\tnetif_napi_add_weight(ndev, &priv->napi, w5100_napi_poll, 16);\n\n\t \n\tndev->features |= NETIF_F_VLAN_CHALLENGED;\n\n\terr = register_netdev(ndev);\n\tif (err < 0)\n\t\tgoto err_register;\n\n\tpriv->xfer_wq = alloc_workqueue(\"%s\", WQ_MEM_RECLAIM, 0,\n\t\t\t\t\tnetdev_name(ndev));\n\tif (!priv->xfer_wq) {\n\t\terr = -ENOMEM;\n\t\tgoto err_wq;\n\t}\n\n\tINIT_WORK(&priv->rx_work, w5100_rx_work);\n\tINIT_WORK(&priv->tx_work, w5100_tx_work);\n\tINIT_WORK(&priv->setrx_work, w5100_setrx_work);\n\tINIT_WORK(&priv->restart_work, w5100_restart_work);\n\n\tif (mac_addr)\n\t\teth_hw_addr_set(ndev, mac_addr);\n\telse\n\t\teth_hw_addr_random(ndev);\n\n\tif (priv->ops->init) {\n\t\terr = priv->ops->init(priv->ndev);\n\t\tif (err)\n\t\t\tgoto err_hw;\n\t}\n\n\terr = w5100_hw_reset(priv);\n\tif (err)\n\t\tgoto err_hw;\n\n\tif (ops->may_sleep) {\n\t\terr = request_threaded_irq(priv->irq, NULL, w5100_interrupt,\n\t\t\t\t\t   IRQF_TRIGGER_LOW | IRQF_ONESHOT,\n\t\t\t\t\t   netdev_name(ndev), ndev);\n\t} else {\n\t\terr = request_irq(priv->irq, w5100_interrupt,\n\t\t\t\t  IRQF_TRIGGER_LOW, netdev_name(ndev), ndev);\n\t}\n\tif (err)\n\t\tgoto err_hw;\n\n\tif (gpio_is_valid(priv->link_gpio)) {\n\t\tchar *link_name = devm_kzalloc(dev, 16, GFP_KERNEL);\n\n\t\tif (!link_name) {\n\t\t\terr = -ENOMEM;\n\t\t\tgoto err_gpio;\n\t\t}\n\t\tsnprintf(link_name, 16, \"%s-link\", netdev_name(ndev));\n\t\tpriv->link_irq = gpio_to_irq(priv->link_gpio);\n\t\tif (request_any_context_irq(priv->link_irq, w5100_detect_link,\n\t\t\t\t\t    IRQF_TRIGGER_RISING |\n\t\t\t\t\t    IRQF_TRIGGER_FALLING,\n\t\t\t\t\t    link_name, priv->ndev) < 0)\n\t\t\tpriv->link_gpio = -EINVAL;\n\t}\n\n\treturn 0;\n\nerr_gpio:\n\tfree_irq(priv->irq, ndev);\nerr_hw:\n\tdestroy_workqueue(priv->xfer_wq);\nerr_wq:\n\tunregister_netdev(ndev);\nerr_register:\n\tfree_netdev(ndev);\n\treturn err;\n}\nEXPORT_SYMBOL_GPL(w5100_probe);\n\nvoid w5100_remove(struct device *dev)\n{\n\tstruct net_device *ndev = dev_get_drvdata(dev);\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tw5100_hw_reset(priv);\n\tfree_irq(priv->irq, ndev);\n\tif (gpio_is_valid(priv->link_gpio))\n\t\tfree_irq(priv->link_irq, ndev);\n\n\tflush_work(&priv->setrx_work);\n\tflush_work(&priv->restart_work);\n\tdestroy_workqueue(priv->xfer_wq);\n\n\tunregister_netdev(ndev);\n\tfree_netdev(ndev);\n}\nEXPORT_SYMBOL_GPL(w5100_remove);\n\n#ifdef CONFIG_PM_SLEEP\nstatic int w5100_suspend(struct device *dev)\n{\n\tstruct net_device *ndev = dev_get_drvdata(dev);\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tif (netif_running(ndev)) {\n\t\tnetif_carrier_off(ndev);\n\t\tnetif_device_detach(ndev);\n\n\t\tw5100_hw_close(priv);\n\t}\n\treturn 0;\n}\n\nstatic int w5100_resume(struct device *dev)\n{\n\tstruct net_device *ndev = dev_get_drvdata(dev);\n\tstruct w5100_priv *priv = netdev_priv(ndev);\n\n\tif (netif_running(ndev)) {\n\t\tw5100_hw_reset(priv);\n\t\tw5100_hw_start(priv);\n\n\t\tnetif_device_attach(ndev);\n\t\tif (!gpio_is_valid(priv->link_gpio) ||\n\t\t    gpio_get_value(priv->link_gpio) != 0)\n\t\t\tnetif_carrier_on(ndev);\n\t}\n\treturn 0;\n}\n#endif  \n\nSIMPLE_DEV_PM_OPS(w5100_pm_ops, w5100_suspend, w5100_resume);\nEXPORT_SYMBOL_GPL(w5100_pm_ops);\n\nstatic struct platform_driver w5100_mmio_driver = {\n\t.driver\t\t= {\n\t\t.name\t= DRV_NAME,\n\t\t.pm\t= &w5100_pm_ops,\n\t},\n\t.probe\t\t= w5100_mmio_probe,\n\t.remove\t\t= w5100_mmio_remove,\n};\nmodule_platform_driver(w5100_mmio_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}