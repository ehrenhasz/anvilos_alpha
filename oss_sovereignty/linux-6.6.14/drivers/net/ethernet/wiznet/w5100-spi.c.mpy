{
  "module_name": "w5100-spi.c",
  "hash_id": "fea79775113d713e2112a59083d398df679d7e04e4d44046f990e12b445dfec3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/wiznet/w5100-spi.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/netdevice.h>\n#include <linux/of_net.h>\n#include <linux/of_device.h>\n#include <linux/spi/spi.h>\n\n#include \"w5100.h\"\n\n#define W5100_SPI_WRITE_OPCODE 0xf0\n#define W5100_SPI_READ_OPCODE 0x0f\n\nstatic int w5100_spi_read(struct net_device *ndev, u32 addr)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tu8 cmd[3] = { W5100_SPI_READ_OPCODE, addr >> 8, addr & 0xff };\n\tu8 data;\n\tint ret;\n\n\tret = spi_write_then_read(spi, cmd, sizeof(cmd), &data, 1);\n\n\treturn ret ? ret : data;\n}\n\nstatic int w5100_spi_write(struct net_device *ndev, u32 addr, u8 data)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tu8 cmd[4] = { W5100_SPI_WRITE_OPCODE, addr >> 8, addr & 0xff, data};\n\n\treturn spi_write_then_read(spi, cmd, sizeof(cmd), NULL, 0);\n}\n\nstatic int w5100_spi_read16(struct net_device *ndev, u32 addr)\n{\n\tu16 data;\n\tint ret;\n\n\tret = w5100_spi_read(ndev, addr);\n\tif (ret < 0)\n\t\treturn ret;\n\tdata = ret << 8;\n\tret = w5100_spi_read(ndev, addr + 1);\n\n\treturn ret < 0 ? ret : data | ret;\n}\n\nstatic int w5100_spi_write16(struct net_device *ndev, u32 addr, u16 data)\n{\n\tint ret;\n\n\tret = w5100_spi_write(ndev, addr, data >> 8);\n\tif (ret)\n\t\treturn ret;\n\n\treturn w5100_spi_write(ndev, addr + 1, data & 0xff);\n}\n\nstatic int w5100_spi_readbulk(struct net_device *ndev, u32 addr, u8 *buf,\n\t\t\t      int len)\n{\n\tint i;\n\n\tfor (i = 0; i < len; i++) {\n\t\tint ret = w5100_spi_read(ndev, addr + i);\n\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tbuf[i] = ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int w5100_spi_writebulk(struct net_device *ndev, u32 addr, const u8 *buf,\n\t\t\t       int len)\n{\n\tint i;\n\n\tfor (i = 0; i < len; i++) {\n\t\tint ret = w5100_spi_write(ndev, addr + i, buf[i]);\n\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct w5100_ops w5100_spi_ops = {\n\t.may_sleep = true,\n\t.chip_id = W5100,\n\t.read = w5100_spi_read,\n\t.write = w5100_spi_write,\n\t.read16 = w5100_spi_read16,\n\t.write16 = w5100_spi_write16,\n\t.readbulk = w5100_spi_readbulk,\n\t.writebulk = w5100_spi_writebulk,\n};\n\n#define W5200_SPI_WRITE_OPCODE 0x80\n\nstruct w5200_spi_priv {\n\t \n\tstruct mutex cmd_lock;\n\n\t \n\tu8 cmd_buf[4] ____cacheline_aligned;\n};\n\nstatic struct w5200_spi_priv *w5200_spi_priv(struct net_device *ndev)\n{\n\treturn w5100_ops_priv(ndev);\n}\n\nstatic int w5200_spi_init(struct net_device *ndev)\n{\n\tstruct w5200_spi_priv *spi_priv = w5200_spi_priv(ndev);\n\n\tmutex_init(&spi_priv->cmd_lock);\n\n\treturn 0;\n}\n\nstatic int w5200_spi_read(struct net_device *ndev, u32 addr)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tu8 cmd[4] = { addr >> 8, addr & 0xff, 0, 1 };\n\tu8 data;\n\tint ret;\n\n\tret = spi_write_then_read(spi, cmd, sizeof(cmd), &data, 1);\n\n\treturn ret ? ret : data;\n}\n\nstatic int w5200_spi_write(struct net_device *ndev, u32 addr, u8 data)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tu8 cmd[5] = { addr >> 8, addr & 0xff, W5200_SPI_WRITE_OPCODE, 1, data };\n\n\treturn spi_write_then_read(spi, cmd, sizeof(cmd), NULL, 0);\n}\n\nstatic int w5200_spi_read16(struct net_device *ndev, u32 addr)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tu8 cmd[4] = { addr >> 8, addr & 0xff, 0, 2 };\n\t__be16 data;\n\tint ret;\n\n\tret = spi_write_then_read(spi, cmd, sizeof(cmd), &data, sizeof(data));\n\n\treturn ret ? ret : be16_to_cpu(data);\n}\n\nstatic int w5200_spi_write16(struct net_device *ndev, u32 addr, u16 data)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tu8 cmd[6] = {\n\t\taddr >> 8, addr & 0xff,\n\t\tW5200_SPI_WRITE_OPCODE, 2,\n\t\tdata >> 8, data & 0xff\n\t};\n\n\treturn spi_write_then_read(spi, cmd, sizeof(cmd), NULL, 0);\n}\n\nstatic int w5200_spi_readbulk(struct net_device *ndev, u32 addr, u8 *buf,\n\t\t\t      int len)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tstruct w5200_spi_priv *spi_priv = w5200_spi_priv(ndev);\n\tstruct spi_transfer xfer[] = {\n\t\t{\n\t\t\t.tx_buf = spi_priv->cmd_buf,\n\t\t\t.len = sizeof(spi_priv->cmd_buf),\n\t\t},\n\t\t{\n\t\t\t.rx_buf = buf,\n\t\t\t.len = len,\n\t\t},\n\t};\n\tint ret;\n\n\tmutex_lock(&spi_priv->cmd_lock);\n\n\tspi_priv->cmd_buf[0] = addr >> 8;\n\tspi_priv->cmd_buf[1] = addr;\n\tspi_priv->cmd_buf[2] = len >> 8;\n\tspi_priv->cmd_buf[3] = len;\n\tret = spi_sync_transfer(spi, xfer, ARRAY_SIZE(xfer));\n\n\tmutex_unlock(&spi_priv->cmd_lock);\n\n\treturn ret;\n}\n\nstatic int w5200_spi_writebulk(struct net_device *ndev, u32 addr, const u8 *buf,\n\t\t\t       int len)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tstruct w5200_spi_priv *spi_priv = w5200_spi_priv(ndev);\n\tstruct spi_transfer xfer[] = {\n\t\t{\n\t\t\t.tx_buf = spi_priv->cmd_buf,\n\t\t\t.len = sizeof(spi_priv->cmd_buf),\n\t\t},\n\t\t{\n\t\t\t.tx_buf = buf,\n\t\t\t.len = len,\n\t\t},\n\t};\n\tint ret;\n\n\tmutex_lock(&spi_priv->cmd_lock);\n\n\tspi_priv->cmd_buf[0] = addr >> 8;\n\tspi_priv->cmd_buf[1] = addr;\n\tspi_priv->cmd_buf[2] = W5200_SPI_WRITE_OPCODE | (len >> 8);\n\tspi_priv->cmd_buf[3] = len;\n\tret = spi_sync_transfer(spi, xfer, ARRAY_SIZE(xfer));\n\n\tmutex_unlock(&spi_priv->cmd_lock);\n\n\treturn ret;\n}\n\nstatic const struct w5100_ops w5200_ops = {\n\t.may_sleep = true,\n\t.chip_id = W5200,\n\t.read = w5200_spi_read,\n\t.write = w5200_spi_write,\n\t.read16 = w5200_spi_read16,\n\t.write16 = w5200_spi_write16,\n\t.readbulk = w5200_spi_readbulk,\n\t.writebulk = w5200_spi_writebulk,\n\t.init = w5200_spi_init,\n};\n\n#define W5500_SPI_BLOCK_SELECT(addr) (((addr) >> 16) & 0x1f)\n#define W5500_SPI_READ_CONTROL(addr) (W5500_SPI_BLOCK_SELECT(addr) << 3)\n#define W5500_SPI_WRITE_CONTROL(addr)\t\\\n\t((W5500_SPI_BLOCK_SELECT(addr) << 3) | BIT(2))\n\nstruct w5500_spi_priv {\n\t \n\tstruct mutex cmd_lock;\n\n\t \n\tu8 cmd_buf[3] ____cacheline_aligned;\n};\n\nstatic struct w5500_spi_priv *w5500_spi_priv(struct net_device *ndev)\n{\n\treturn w5100_ops_priv(ndev);\n}\n\nstatic int w5500_spi_init(struct net_device *ndev)\n{\n\tstruct w5500_spi_priv *spi_priv = w5500_spi_priv(ndev);\n\n\tmutex_init(&spi_priv->cmd_lock);\n\n\treturn 0;\n}\n\nstatic int w5500_spi_read(struct net_device *ndev, u32 addr)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tu8 cmd[3] = {\n\t\taddr >> 8,\n\t\taddr,\n\t\tW5500_SPI_READ_CONTROL(addr)\n\t};\n\tu8 data;\n\tint ret;\n\n\tret = spi_write_then_read(spi, cmd, sizeof(cmd), &data, 1);\n\n\treturn ret ? ret : data;\n}\n\nstatic int w5500_spi_write(struct net_device *ndev, u32 addr, u8 data)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tu8 cmd[4] = {\n\t\taddr >> 8,\n\t\taddr,\n\t\tW5500_SPI_WRITE_CONTROL(addr),\n\t\tdata\n\t};\n\n\treturn spi_write_then_read(spi, cmd, sizeof(cmd), NULL, 0);\n}\n\nstatic int w5500_spi_read16(struct net_device *ndev, u32 addr)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tu8 cmd[3] = {\n\t\taddr >> 8,\n\t\taddr,\n\t\tW5500_SPI_READ_CONTROL(addr)\n\t};\n\t__be16 data;\n\tint ret;\n\n\tret = spi_write_then_read(spi, cmd, sizeof(cmd), &data, sizeof(data));\n\n\treturn ret ? ret : be16_to_cpu(data);\n}\n\nstatic int w5500_spi_write16(struct net_device *ndev, u32 addr, u16 data)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tu8 cmd[5] = {\n\t\taddr >> 8,\n\t\taddr,\n\t\tW5500_SPI_WRITE_CONTROL(addr),\n\t\tdata >> 8,\n\t\tdata\n\t};\n\n\treturn spi_write_then_read(spi, cmd, sizeof(cmd), NULL, 0);\n}\n\nstatic int w5500_spi_readbulk(struct net_device *ndev, u32 addr, u8 *buf,\n\t\t\t      int len)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tstruct w5500_spi_priv *spi_priv = w5500_spi_priv(ndev);\n\tstruct spi_transfer xfer[] = {\n\t\t{\n\t\t\t.tx_buf = spi_priv->cmd_buf,\n\t\t\t.len = sizeof(spi_priv->cmd_buf),\n\t\t},\n\t\t{\n\t\t\t.rx_buf = buf,\n\t\t\t.len = len,\n\t\t},\n\t};\n\tint ret;\n\n\tmutex_lock(&spi_priv->cmd_lock);\n\n\tspi_priv->cmd_buf[0] = addr >> 8;\n\tspi_priv->cmd_buf[1] = addr;\n\tspi_priv->cmd_buf[2] = W5500_SPI_READ_CONTROL(addr);\n\tret = spi_sync_transfer(spi, xfer, ARRAY_SIZE(xfer));\n\n\tmutex_unlock(&spi_priv->cmd_lock);\n\n\treturn ret;\n}\n\nstatic int w5500_spi_writebulk(struct net_device *ndev, u32 addr, const u8 *buf,\n\t\t\t       int len)\n{\n\tstruct spi_device *spi = to_spi_device(ndev->dev.parent);\n\tstruct w5500_spi_priv *spi_priv = w5500_spi_priv(ndev);\n\tstruct spi_transfer xfer[] = {\n\t\t{\n\t\t\t.tx_buf = spi_priv->cmd_buf,\n\t\t\t.len = sizeof(spi_priv->cmd_buf),\n\t\t},\n\t\t{\n\t\t\t.tx_buf = buf,\n\t\t\t.len = len,\n\t\t},\n\t};\n\tint ret;\n\n\tmutex_lock(&spi_priv->cmd_lock);\n\n\tspi_priv->cmd_buf[0] = addr >> 8;\n\tspi_priv->cmd_buf[1] = addr;\n\tspi_priv->cmd_buf[2] = W5500_SPI_WRITE_CONTROL(addr);\n\tret = spi_sync_transfer(spi, xfer, ARRAY_SIZE(xfer));\n\n\tmutex_unlock(&spi_priv->cmd_lock);\n\n\treturn ret;\n}\n\nstatic const struct w5100_ops w5500_ops = {\n\t.may_sleep = true,\n\t.chip_id = W5500,\n\t.read = w5500_spi_read,\n\t.write = w5500_spi_write,\n\t.read16 = w5500_spi_read16,\n\t.write16 = w5500_spi_write16,\n\t.readbulk = w5500_spi_readbulk,\n\t.writebulk = w5500_spi_writebulk,\n\t.init = w5500_spi_init,\n};\n\nstatic const struct of_device_id w5100_of_match[] = {\n\t{ .compatible = \"wiznet,w5100\", .data = (const void*)W5100, },\n\t{ .compatible = \"wiznet,w5200\", .data = (const void*)W5200, },\n\t{ .compatible = \"wiznet,w5500\", .data = (const void*)W5500, },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, w5100_of_match);\n\nstatic int w5100_spi_probe(struct spi_device *spi)\n{\n\tconst struct of_device_id *of_id;\n\tconst struct w5100_ops *ops;\n\tkernel_ulong_t driver_data;\n\tconst void *mac = NULL;\n\tu8 tmpmac[ETH_ALEN];\n\tint priv_size;\n\tint ret;\n\n\tret = of_get_mac_address(spi->dev.of_node, tmpmac);\n\tif (!ret)\n\t\tmac = tmpmac;\n\n\tif (spi->dev.of_node) {\n\t\tof_id = of_match_device(w5100_of_match, &spi->dev);\n\t\tif (!of_id)\n\t\t\treturn -ENODEV;\n\t\tdriver_data = (kernel_ulong_t)of_id->data;\n\t} else {\n\t\tdriver_data = spi_get_device_id(spi)->driver_data;\n\t}\n\n\tswitch (driver_data) {\n\tcase W5100:\n\t\tops = &w5100_spi_ops;\n\t\tpriv_size = 0;\n\t\tbreak;\n\tcase W5200:\n\t\tops = &w5200_ops;\n\t\tpriv_size = sizeof(struct w5200_spi_priv);\n\t\tbreak;\n\tcase W5500:\n\t\tops = &w5500_ops;\n\t\tpriv_size = sizeof(struct w5500_spi_priv);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn w5100_probe(&spi->dev, ops, priv_size, mac, spi->irq, -EINVAL);\n}\n\nstatic void w5100_spi_remove(struct spi_device *spi)\n{\n\tw5100_remove(&spi->dev);\n}\n\nstatic const struct spi_device_id w5100_spi_ids[] = {\n\t{ \"w5100\", W5100 },\n\t{ \"w5200\", W5200 },\n\t{ \"w5500\", W5500 },\n\t{}\n};\nMODULE_DEVICE_TABLE(spi, w5100_spi_ids);\n\nstatic struct spi_driver w5100_spi_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"w5100\",\n\t\t.pm\t= &w5100_pm_ops,\n\t\t.of_match_table = w5100_of_match,\n\t},\n\t.probe\t\t= w5100_spi_probe,\n\t.remove\t\t= w5100_spi_remove,\n\t.id_table\t= w5100_spi_ids,\n};\nmodule_spi_driver(w5100_spi_driver);\n\nMODULE_DESCRIPTION(\"WIZnet W5100/W5200/W5500 Ethernet driver for SPI mode\");\nMODULE_AUTHOR(\"Akinobu Mita <akinobu.mita@gmail.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}