{
  "module_name": "hw.c",
  "hash_id": "bf0ff5d90c0ef049ef342d60e8ef6dd8b3b8a4a4b0e58917028ef5a6784a436c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/atheros/alx/hw.c",
  "human_readable_source": " \n#include <linux/etherdevice.h>\n#include <linux/delay.h>\n#include <linux/pci.h>\n#include <linux/mdio.h>\n#include \"reg.h\"\n#include \"hw.h\"\n\nstatic inline bool alx_is_rev_a(u8 rev)\n{\n\treturn rev == ALX_REV_A0 || rev == ALX_REV_A1;\n}\n\nstatic int alx_wait_mdio_idle(struct alx_hw *hw)\n{\n\tu32 val;\n\tint i;\n\n\tfor (i = 0; i < ALX_MDIO_MAX_AC_TO; i++) {\n\t\tval = alx_read_mem32(hw, ALX_MDIO);\n\t\tif (!(val & ALX_MDIO_BUSY))\n\t\t\treturn 0;\n\t\tudelay(10);\n\t}\n\n\treturn -ETIMEDOUT;\n}\n\nstatic int alx_read_phy_core(struct alx_hw *hw, bool ext, u8 dev,\n\t\t\t     u16 reg, u16 *phy_data)\n{\n\tu32 val, clk_sel;\n\tint err;\n\n\t*phy_data = 0;\n\n\t \n\tclk_sel = hw->link_speed != SPEED_UNKNOWN ?\n\t\t\tALX_MDIO_CLK_SEL_25MD4 :\n\t\t\tALX_MDIO_CLK_SEL_25MD128;\n\n\tif (ext) {\n\t\tval = dev << ALX_MDIO_EXTN_DEVAD_SHIFT |\n\t\t      reg << ALX_MDIO_EXTN_REG_SHIFT;\n\t\talx_write_mem32(hw, ALX_MDIO_EXTN, val);\n\n\t\tval = ALX_MDIO_SPRES_PRMBL | ALX_MDIO_START |\n\t\t      ALX_MDIO_MODE_EXT | ALX_MDIO_OP_READ |\n\t\t      clk_sel << ALX_MDIO_CLK_SEL_SHIFT;\n\t} else {\n\t\tval = ALX_MDIO_SPRES_PRMBL |\n\t\t      clk_sel << ALX_MDIO_CLK_SEL_SHIFT |\n\t\t      reg << ALX_MDIO_REG_SHIFT |\n\t\t      ALX_MDIO_START | ALX_MDIO_OP_READ;\n\t}\n\talx_write_mem32(hw, ALX_MDIO, val);\n\n\terr = alx_wait_mdio_idle(hw);\n\tif (err)\n\t\treturn err;\n\tval = alx_read_mem32(hw, ALX_MDIO);\n\t*phy_data = ALX_GET_FIELD(val, ALX_MDIO_DATA);\n\treturn 0;\n}\n\nstatic int alx_write_phy_core(struct alx_hw *hw, bool ext, u8 dev,\n\t\t\t      u16 reg, u16 phy_data)\n{\n\tu32 val, clk_sel;\n\n\t \n\tclk_sel = hw->link_speed != SPEED_UNKNOWN ?\n\t\t\tALX_MDIO_CLK_SEL_25MD4 :\n\t\t\tALX_MDIO_CLK_SEL_25MD128;\n\n\tif (ext) {\n\t\tval = dev << ALX_MDIO_EXTN_DEVAD_SHIFT |\n\t\t      reg << ALX_MDIO_EXTN_REG_SHIFT;\n\t\talx_write_mem32(hw, ALX_MDIO_EXTN, val);\n\n\t\tval = ALX_MDIO_SPRES_PRMBL |\n\t\t      clk_sel << ALX_MDIO_CLK_SEL_SHIFT |\n\t\t      phy_data << ALX_MDIO_DATA_SHIFT |\n\t\t      ALX_MDIO_START | ALX_MDIO_MODE_EXT;\n\t} else {\n\t\tval = ALX_MDIO_SPRES_PRMBL |\n\t\t      clk_sel << ALX_MDIO_CLK_SEL_SHIFT |\n\t\t      reg << ALX_MDIO_REG_SHIFT |\n\t\t      phy_data << ALX_MDIO_DATA_SHIFT |\n\t\t      ALX_MDIO_START;\n\t}\n\talx_write_mem32(hw, ALX_MDIO, val);\n\n\treturn alx_wait_mdio_idle(hw);\n}\n\nstatic int __alx_read_phy_reg(struct alx_hw *hw, u16 reg, u16 *phy_data)\n{\n\treturn alx_read_phy_core(hw, false, 0, reg, phy_data);\n}\n\nstatic int __alx_write_phy_reg(struct alx_hw *hw, u16 reg, u16 phy_data)\n{\n\treturn alx_write_phy_core(hw, false, 0, reg, phy_data);\n}\n\nstatic int __alx_read_phy_ext(struct alx_hw *hw, u8 dev, u16 reg, u16 *pdata)\n{\n\treturn alx_read_phy_core(hw, true, dev, reg, pdata);\n}\n\nstatic int __alx_write_phy_ext(struct alx_hw *hw, u8 dev, u16 reg, u16 data)\n{\n\treturn alx_write_phy_core(hw, true, dev, reg, data);\n}\n\nstatic int __alx_read_phy_dbg(struct alx_hw *hw, u16 reg, u16 *pdata)\n{\n\tint err;\n\n\terr = __alx_write_phy_reg(hw, ALX_MII_DBG_ADDR, reg);\n\tif (err)\n\t\treturn err;\n\n\treturn __alx_read_phy_reg(hw, ALX_MII_DBG_DATA, pdata);\n}\n\nstatic int __alx_write_phy_dbg(struct alx_hw *hw, u16 reg, u16 data)\n{\n\tint err;\n\n\terr = __alx_write_phy_reg(hw, ALX_MII_DBG_ADDR, reg);\n\tif (err)\n\t\treturn err;\n\n\treturn __alx_write_phy_reg(hw, ALX_MII_DBG_DATA, data);\n}\n\nint alx_read_phy_reg(struct alx_hw *hw, u16 reg, u16 *phy_data)\n{\n\tint err;\n\n\tspin_lock(&hw->mdio_lock);\n\terr = __alx_read_phy_reg(hw, reg, phy_data);\n\tspin_unlock(&hw->mdio_lock);\n\n\treturn err;\n}\n\nint alx_write_phy_reg(struct alx_hw *hw, u16 reg, u16 phy_data)\n{\n\tint err;\n\n\tspin_lock(&hw->mdio_lock);\n\terr = __alx_write_phy_reg(hw, reg, phy_data);\n\tspin_unlock(&hw->mdio_lock);\n\n\treturn err;\n}\n\nint alx_read_phy_ext(struct alx_hw *hw, u8 dev, u16 reg, u16 *pdata)\n{\n\tint err;\n\n\tspin_lock(&hw->mdio_lock);\n\terr = __alx_read_phy_ext(hw, dev, reg, pdata);\n\tspin_unlock(&hw->mdio_lock);\n\n\treturn err;\n}\n\nint alx_write_phy_ext(struct alx_hw *hw, u8 dev, u16 reg, u16 data)\n{\n\tint err;\n\n\tspin_lock(&hw->mdio_lock);\n\terr = __alx_write_phy_ext(hw, dev, reg, data);\n\tspin_unlock(&hw->mdio_lock);\n\n\treturn err;\n}\n\nstatic int alx_read_phy_dbg(struct alx_hw *hw, u16 reg, u16 *pdata)\n{\n\tint err;\n\n\tspin_lock(&hw->mdio_lock);\n\terr = __alx_read_phy_dbg(hw, reg, pdata);\n\tspin_unlock(&hw->mdio_lock);\n\n\treturn err;\n}\n\nstatic int alx_write_phy_dbg(struct alx_hw *hw, u16 reg, u16 data)\n{\n\tint err;\n\n\tspin_lock(&hw->mdio_lock);\n\terr = __alx_write_phy_dbg(hw, reg, data);\n\tspin_unlock(&hw->mdio_lock);\n\n\treturn err;\n}\n\nstatic u16 alx_get_phy_config(struct alx_hw *hw)\n{\n\tu32 val;\n\tu16 phy_val;\n\n\tval = alx_read_mem32(hw, ALX_PHY_CTRL);\n\t \n\tif ((val & ALX_PHY_CTRL_DSPRST_OUT) == 0)\n\t\treturn ALX_DRV_PHY_UNKNOWN;\n\n\tval = alx_read_mem32(hw, ALX_DRV);\n\tval = ALX_GET_FIELD(val, ALX_DRV_PHY);\n\tif (ALX_DRV_PHY_UNKNOWN == val)\n\t\treturn ALX_DRV_PHY_UNKNOWN;\n\n\talx_read_phy_reg(hw, ALX_MII_DBG_ADDR, &phy_val);\n\tif (ALX_PHY_INITED == phy_val)\n\t\treturn val;\n\n\treturn ALX_DRV_PHY_UNKNOWN;\n}\n\nstatic bool alx_wait_reg(struct alx_hw *hw, u32 reg, u32 wait, u32 *val)\n{\n\tu32 read;\n\tint i;\n\n\tfor (i = 0; i < ALX_SLD_MAX_TO; i++) {\n\t\tread = alx_read_mem32(hw, reg);\n\t\tif ((read & wait) == 0) {\n\t\t\tif (val)\n\t\t\t\t*val = read;\n\t\t\treturn true;\n\t\t}\n\t\tmdelay(1);\n\t}\n\n\treturn false;\n}\n\nstatic bool alx_read_macaddr(struct alx_hw *hw, u8 *addr)\n{\n\tu32 mac0, mac1;\n\n\tmac0 = alx_read_mem32(hw, ALX_STAD0);\n\tmac1 = alx_read_mem32(hw, ALX_STAD1);\n\n\t \n\tput_unaligned(cpu_to_be32(mac0), (__be32 *)(addr + 2));\n\tput_unaligned(cpu_to_be16(mac1), (__be16 *)addr);\n\n\treturn is_valid_ether_addr(addr);\n}\n\nint alx_get_perm_macaddr(struct alx_hw *hw, u8 *addr)\n{\n\tu32 val;\n\n\t \n\tif (alx_read_macaddr(hw, addr))\n\t\treturn 0;\n\n\t \n\tif (!alx_wait_reg(hw, ALX_SLD, ALX_SLD_STAT | ALX_SLD_START, &val))\n\t\treturn -EIO;\n\talx_write_mem32(hw, ALX_SLD, val | ALX_SLD_START);\n\tif (!alx_wait_reg(hw, ALX_SLD, ALX_SLD_START, NULL))\n\t\treturn -EIO;\n\tif (alx_read_macaddr(hw, addr))\n\t\treturn 0;\n\n\t \n\tval = alx_read_mem32(hw, ALX_EFLD);\n\tif (val & (ALX_EFLD_F_EXIST | ALX_EFLD_E_EXIST)) {\n\t\tif (!alx_wait_reg(hw, ALX_EFLD,\n\t\t\t\t  ALX_EFLD_STAT | ALX_EFLD_START, &val))\n\t\t\treturn -EIO;\n\t\talx_write_mem32(hw, ALX_EFLD, val | ALX_EFLD_START);\n\t\tif (!alx_wait_reg(hw, ALX_EFLD, ALX_EFLD_START, NULL))\n\t\t\treturn -EIO;\n\t\tif (alx_read_macaddr(hw, addr))\n\t\t\treturn 0;\n\t}\n\n\treturn -EIO;\n}\n\nvoid alx_set_macaddr(struct alx_hw *hw, const u8 *addr)\n{\n\tu32 val;\n\n\t \n\tval = be32_to_cpu(get_unaligned((__be32 *)(addr + 2)));\n\talx_write_mem32(hw, ALX_STAD0, val);\n\tval = be16_to_cpu(get_unaligned((__be16 *)addr));\n\talx_write_mem32(hw, ALX_STAD1, val);\n}\n\nstatic void alx_reset_osc(struct alx_hw *hw, u8 rev)\n{\n\tu32 val, val2;\n\n\t \n\tval = alx_read_mem32(hw, ALX_MISC3);\n\talx_write_mem32(hw, ALX_MISC3,\n\t\t\t(val & ~ALX_MISC3_25M_BY_SW) |\n\t\t\tALX_MISC3_25M_NOTO_INTNL);\n\n\t \n\tval = alx_read_mem32(hw, ALX_MISC);\n\tif (rev >= ALX_REV_B0) {\n\t\t \n\t\tALX_SET_FIELD(val, ALX_MISC_PSW_OCP, ALX_MISC_PSW_OCP_DEF);\n\t\t \n\t\tval &= ~ALX_MISC_INTNLOSC_OPEN;\n\t\talx_write_mem32(hw, ALX_MISC, val);\n\t\talx_write_mem32(hw, ALX_MISC, val | ALX_MISC_INTNLOSC_OPEN);\n\t\t \n\t\tval2 = alx_read_mem32(hw, ALX_MSIC2);\n\t\tval2 &= ~ALX_MSIC2_CALB_START;\n\t\talx_write_mem32(hw, ALX_MSIC2, val2);\n\t\talx_write_mem32(hw, ALX_MSIC2, val2 | ALX_MSIC2_CALB_START);\n\t} else {\n\t\tval &= ~ALX_MISC_INTNLOSC_OPEN;\n\t\t \n\t\tif (alx_is_rev_a(rev))\n\t\t\tval &= ~ALX_MISC_ISO_EN;\n\n\t\talx_write_mem32(hw, ALX_MISC, val | ALX_MISC_INTNLOSC_OPEN);\n\t\talx_write_mem32(hw, ALX_MISC, val);\n\t}\n\n\tudelay(20);\n}\n\nstatic int alx_stop_mac(struct alx_hw *hw)\n{\n\tu32 rxq, txq, val;\n\tu16 i;\n\n\trxq = alx_read_mem32(hw, ALX_RXQ0);\n\talx_write_mem32(hw, ALX_RXQ0, rxq & ~ALX_RXQ0_EN);\n\ttxq = alx_read_mem32(hw, ALX_TXQ0);\n\talx_write_mem32(hw, ALX_TXQ0, txq & ~ALX_TXQ0_EN);\n\n\tudelay(40);\n\n\thw->rx_ctrl &= ~(ALX_MAC_CTRL_RX_EN | ALX_MAC_CTRL_TX_EN);\n\talx_write_mem32(hw, ALX_MAC_CTRL, hw->rx_ctrl);\n\n\tfor (i = 0; i < ALX_DMA_MAC_RST_TO; i++) {\n\t\tval = alx_read_mem32(hw, ALX_MAC_STS);\n\t\tif (!(val & ALX_MAC_STS_IDLE))\n\t\t\treturn 0;\n\t\tudelay(10);\n\t}\n\n\treturn -ETIMEDOUT;\n}\n\nint alx_reset_mac(struct alx_hw *hw)\n{\n\tu32 val, pmctrl;\n\tint i, ret;\n\tu8 rev;\n\tbool a_cr;\n\n\tpmctrl = 0;\n\trev = alx_hw_revision(hw);\n\ta_cr = alx_is_rev_a(rev) && alx_hw_with_cr(hw);\n\n\t \n\talx_write_mem32(hw, ALX_MSIX_MASK, 0xFFFFFFFF);\n\talx_write_mem32(hw, ALX_IMR, 0);\n\talx_write_mem32(hw, ALX_ISR, ALX_ISR_DIS);\n\n\tret = alx_stop_mac(hw);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\talx_write_mem32(hw, ALX_RFD_PIDX, 1);\n\n\t \n\tif (a_cr) {\n\t\tpmctrl = alx_read_mem32(hw, ALX_PMCTRL);\n\t\tif (pmctrl & (ALX_PMCTRL_L1_EN | ALX_PMCTRL_L0S_EN))\n\t\t\talx_write_mem32(hw, ALX_PMCTRL,\n\t\t\t\t\tpmctrl & ~(ALX_PMCTRL_L1_EN |\n\t\t\t\t\t\t   ALX_PMCTRL_L0S_EN));\n\t}\n\n\t \n\tval = alx_read_mem32(hw, ALX_MASTER);\n\talx_write_mem32(hw, ALX_MASTER,\n\t\t\tval | ALX_MASTER_DMA_MAC_RST | ALX_MASTER_OOB_DIS);\n\n\t \n\tudelay(10);\n\tfor (i = 0; i < ALX_DMA_MAC_RST_TO; i++) {\n\t\tval = alx_read_mem32(hw, ALX_RFD_PIDX);\n\t\tif (val == 0)\n\t\t\tbreak;\n\t\tudelay(10);\n\t}\n\tfor (; i < ALX_DMA_MAC_RST_TO; i++) {\n\t\tval = alx_read_mem32(hw, ALX_MASTER);\n\t\tif ((val & ALX_MASTER_DMA_MAC_RST) == 0)\n\t\t\tbreak;\n\t\tudelay(10);\n\t}\n\tif (i == ALX_DMA_MAC_RST_TO)\n\t\treturn -EIO;\n\tudelay(10);\n\n\tif (a_cr) {\n\t\talx_write_mem32(hw, ALX_MASTER, val | ALX_MASTER_PCLKSEL_SRDS);\n\t\t \n\t\tif (pmctrl & (ALX_PMCTRL_L1_EN | ALX_PMCTRL_L0S_EN))\n\t\t\talx_write_mem32(hw, ALX_PMCTRL, pmctrl);\n\t}\n\n\talx_reset_osc(hw, rev);\n\n\t \n\tval = alx_read_mem32(hw, ALX_MISC3);\n\talx_write_mem32(hw, ALX_MISC3,\n\t\t\t(val & ~ALX_MISC3_25M_BY_SW) |\n\t\t\tALX_MISC3_25M_NOTO_INTNL);\n\tval = alx_read_mem32(hw, ALX_MISC);\n\tval &= ~ALX_MISC_INTNLOSC_OPEN;\n\tif (alx_is_rev_a(rev))\n\t\tval &= ~ALX_MISC_ISO_EN;\n\talx_write_mem32(hw, ALX_MISC, val);\n\tudelay(20);\n\n\t \n\talx_write_mem32(hw, ALX_MAC_CTRL, hw->rx_ctrl);\n\n\tval = alx_read_mem32(hw, ALX_SERDES);\n\talx_write_mem32(hw, ALX_SERDES,\n\t\t\tval | ALX_SERDES_MACCLK_SLWDWN |\n\t\t\tALX_SERDES_PHYCLK_SLWDWN);\n\n\treturn 0;\n}\n\nvoid alx_reset_phy(struct alx_hw *hw)\n{\n\tint i;\n\tu32 val;\n\tu16 phy_val;\n\n\t \n\tval = alx_read_mem32(hw, ALX_PHY_CTRL);\n\tval &= ~(ALX_PHY_CTRL_DSPRST_OUT | ALX_PHY_CTRL_IDDQ |\n\t\t ALX_PHY_CTRL_GATE_25M | ALX_PHY_CTRL_POWER_DOWN |\n\t\t ALX_PHY_CTRL_CLS);\n\tval |= ALX_PHY_CTRL_RST_ANALOG;\n\n\tval |= (ALX_PHY_CTRL_HIB_PULSE | ALX_PHY_CTRL_HIB_EN);\n\talx_write_mem32(hw, ALX_PHY_CTRL, val);\n\tudelay(10);\n\talx_write_mem32(hw, ALX_PHY_CTRL, val | ALX_PHY_CTRL_DSPRST_OUT);\n\n\tfor (i = 0; i < ALX_PHY_CTRL_DSPRST_TO; i++)\n\t\tudelay(10);\n\n\t \n\talx_write_phy_dbg(hw, ALX_MIIDBG_LEGCYPS, ALX_LEGCYPS_DEF);\n\talx_write_phy_dbg(hw, ALX_MIIDBG_SYSMODCTRL,\n\t\t\t  ALX_SYSMODCTRL_IECHOADJ_DEF);\n\talx_write_phy_ext(hw, ALX_MIIEXT_PCS, ALX_MIIEXT_VDRVBIAS,\n\t\t\t  ALX_VDRVBIAS_DEF);\n\n\t \n\tval = alx_read_mem32(hw, ALX_LPI_CTRL);\n\talx_write_mem32(hw, ALX_LPI_CTRL, val & ~ALX_LPI_CTRL_EN);\n\talx_write_phy_ext(hw, ALX_MIIEXT_ANEG, ALX_MIIEXT_LOCAL_EEEADV, 0);\n\n\t \n\talx_write_phy_dbg(hw, ALX_MIIDBG_TST10BTCFG, ALX_TST10BTCFG_DEF);\n\talx_write_phy_dbg(hw, ALX_MIIDBG_SRDSYSMOD, ALX_SRDSYSMOD_DEF);\n\talx_write_phy_dbg(hw, ALX_MIIDBG_TST100BTCFG, ALX_TST100BTCFG_DEF);\n\talx_write_phy_dbg(hw, ALX_MIIDBG_ANACTRL, ALX_ANACTRL_DEF);\n\talx_read_phy_dbg(hw, ALX_MIIDBG_GREENCFG2, &phy_val);\n\talx_write_phy_dbg(hw, ALX_MIIDBG_GREENCFG2,\n\t\t\t  phy_val & ~ALX_GREENCFG2_GATE_DFSE_EN);\n\t \n\talx_write_phy_ext(hw, ALX_MIIEXT_ANEG, ALX_MIIEXT_NLP78,\n\t\t\t  ALX_MIIEXT_NLP78_120M_DEF);\n\talx_write_phy_ext(hw, ALX_MIIEXT_ANEG, ALX_MIIEXT_S3DIG10,\n\t\t\t  ALX_MIIEXT_S3DIG10_DEF);\n\n\tif (hw->lnk_patch) {\n\t\t \n\t\talx_read_phy_ext(hw, ALX_MIIEXT_PCS, ALX_MIIEXT_CLDCTRL3,\n\t\t\t\t &phy_val);\n\t\talx_write_phy_ext(hw, ALX_MIIEXT_PCS, ALX_MIIEXT_CLDCTRL3,\n\t\t\t\t  phy_val | ALX_CLDCTRL3_BP_CABLE1TH_DET_GT);\n\t\t \n\t\talx_read_phy_dbg(hw, ALX_MIIDBG_GREENCFG2, &phy_val);\n\t\talx_write_phy_dbg(hw, ALX_MIIDBG_GREENCFG2,\n\t\t\t\t  phy_val | ALX_GREENCFG2_BP_GREEN);\n\t\t \n\t\talx_read_phy_ext(hw, ALX_MIIEXT_PCS, ALX_MIIEXT_CLDCTRL5,\n\t\t\t\t &phy_val);\n\t\talx_write_phy_ext(hw, ALX_MIIEXT_PCS, ALX_MIIEXT_CLDCTRL5,\n\t\t\t\t  phy_val | ALX_CLDCTRL5_BP_VD_HLFBIAS);\n\t}\n\n\t \n\talx_write_phy_reg(hw, ALX_MII_IER, ALX_IER_LINK_UP | ALX_IER_LINK_DOWN);\n}\n\n#define ALX_PCI_CMD (PCI_COMMAND_MASTER | PCI_COMMAND_MEMORY | PCI_COMMAND_IO)\n\nvoid alx_reset_pcie(struct alx_hw *hw)\n{\n\tu8 rev = alx_hw_revision(hw);\n\tu32 val;\n\tu16 val16;\n\n\t \n\tpci_read_config_word(hw->pdev, PCI_COMMAND, &val16);\n\tif (!(val16 & ALX_PCI_CMD) || (val16 & PCI_COMMAND_INTX_DISABLE)) {\n\t\tval16 = (val16 | ALX_PCI_CMD) & ~PCI_COMMAND_INTX_DISABLE;\n\t\tpci_write_config_word(hw->pdev, PCI_COMMAND, val16);\n\t}\n\n\t \n\tval = alx_read_mem32(hw, ALX_WOL0);\n\talx_write_mem32(hw, ALX_WOL0, 0);\n\n\tval = alx_read_mem32(hw, ALX_PDLL_TRNS1);\n\talx_write_mem32(hw, ALX_PDLL_TRNS1, val & ~ALX_PDLL_TRNS1_D3PLLOFF_EN);\n\n\t \n\tval = alx_read_mem32(hw, ALX_UE_SVRT);\n\tval &= ~(ALX_UE_SVRT_DLPROTERR | ALX_UE_SVRT_FCPROTERR);\n\talx_write_mem32(hw, ALX_UE_SVRT, val);\n\n\t \n\tval = alx_read_mem32(hw, ALX_MASTER);\n\tif (alx_is_rev_a(rev) && alx_hw_with_cr(hw)) {\n\t\tif ((val & ALX_MASTER_WAKEN_25M) == 0 ||\n\t\t    (val & ALX_MASTER_PCLKSEL_SRDS) == 0)\n\t\t\talx_write_mem32(hw, ALX_MASTER,\n\t\t\t\t\tval | ALX_MASTER_PCLKSEL_SRDS |\n\t\t\t\t\tALX_MASTER_WAKEN_25M);\n\t} else {\n\t\tif ((val & ALX_MASTER_WAKEN_25M) == 0 ||\n\t\t    (val & ALX_MASTER_PCLKSEL_SRDS) != 0)\n\t\t\talx_write_mem32(hw, ALX_MASTER,\n\t\t\t\t\t(val & ~ALX_MASTER_PCLKSEL_SRDS) |\n\t\t\t\t\tALX_MASTER_WAKEN_25M);\n\t}\n\n\t \n\talx_enable_aspm(hw, true, true);\n\n\tudelay(10);\n}\n\nvoid alx_start_mac(struct alx_hw *hw)\n{\n\tu32 mac, txq, rxq;\n\n\trxq = alx_read_mem32(hw, ALX_RXQ0);\n\talx_write_mem32(hw, ALX_RXQ0, rxq | ALX_RXQ0_EN);\n\ttxq = alx_read_mem32(hw, ALX_TXQ0);\n\talx_write_mem32(hw, ALX_TXQ0, txq | ALX_TXQ0_EN);\n\n\tmac = hw->rx_ctrl;\n\tif (hw->duplex == DUPLEX_FULL)\n\t\tmac |= ALX_MAC_CTRL_FULLD;\n\telse\n\t\tmac &= ~ALX_MAC_CTRL_FULLD;\n\tALX_SET_FIELD(mac, ALX_MAC_CTRL_SPEED,\n\t\t      hw->link_speed == SPEED_1000 ? ALX_MAC_CTRL_SPEED_1000 :\n\t\t\t\t\t\t     ALX_MAC_CTRL_SPEED_10_100);\n\tmac |= ALX_MAC_CTRL_TX_EN | ALX_MAC_CTRL_RX_EN;\n\thw->rx_ctrl = mac;\n\talx_write_mem32(hw, ALX_MAC_CTRL, mac);\n}\n\nvoid alx_cfg_mac_flowcontrol(struct alx_hw *hw, u8 fc)\n{\n\tif (fc & ALX_FC_RX)\n\t\thw->rx_ctrl |= ALX_MAC_CTRL_RXFC_EN;\n\telse\n\t\thw->rx_ctrl &= ~ALX_MAC_CTRL_RXFC_EN;\n\n\tif (fc & ALX_FC_TX)\n\t\thw->rx_ctrl |= ALX_MAC_CTRL_TXFC_EN;\n\telse\n\t\thw->rx_ctrl &= ~ALX_MAC_CTRL_TXFC_EN;\n\n\talx_write_mem32(hw, ALX_MAC_CTRL, hw->rx_ctrl);\n}\n\nvoid alx_enable_aspm(struct alx_hw *hw, bool l0s_en, bool l1_en)\n{\n\tu32 pmctrl;\n\tu8 rev = alx_hw_revision(hw);\n\n\tpmctrl = alx_read_mem32(hw, ALX_PMCTRL);\n\n\tALX_SET_FIELD(pmctrl, ALX_PMCTRL_LCKDET_TIMER,\n\t\t      ALX_PMCTRL_LCKDET_TIMER_DEF);\n\tpmctrl |= ALX_PMCTRL_RCVR_WT_1US |\n\t\t  ALX_PMCTRL_L1_CLKSW_EN |\n\t\t  ALX_PMCTRL_L1_SRDSRX_PWD;\n\tALX_SET_FIELD(pmctrl, ALX_PMCTRL_L1REQ_TO, ALX_PMCTRL_L1REG_TO_DEF);\n\tALX_SET_FIELD(pmctrl, ALX_PMCTRL_L1_TIMER, ALX_PMCTRL_L1_TIMER_16US);\n\tpmctrl &= ~(ALX_PMCTRL_L1_SRDS_EN |\n\t\t    ALX_PMCTRL_L1_SRDSPLL_EN |\n\t\t    ALX_PMCTRL_L1_BUFSRX_EN |\n\t\t    ALX_PMCTRL_SADLY_EN |\n\t\t    ALX_PMCTRL_HOTRST_WTEN|\n\t\t    ALX_PMCTRL_L0S_EN |\n\t\t    ALX_PMCTRL_L1_EN |\n\t\t    ALX_PMCTRL_ASPM_FCEN |\n\t\t    ALX_PMCTRL_TXL1_AFTER_L0S |\n\t\t    ALX_PMCTRL_RXL1_AFTER_L0S);\n\tif (alx_is_rev_a(rev) && alx_hw_with_cr(hw))\n\t\tpmctrl |= ALX_PMCTRL_L1_SRDS_EN | ALX_PMCTRL_L1_SRDSPLL_EN;\n\n\tif (l0s_en)\n\t\tpmctrl |= (ALX_PMCTRL_L0S_EN | ALX_PMCTRL_ASPM_FCEN);\n\tif (l1_en)\n\t\tpmctrl |= (ALX_PMCTRL_L1_EN | ALX_PMCTRL_ASPM_FCEN);\n\n\talx_write_mem32(hw, ALX_PMCTRL, pmctrl);\n}\n\n\nstatic u32 ethadv_to_hw_cfg(struct alx_hw *hw, u32 ethadv_cfg)\n{\n\tu32 cfg = 0;\n\n\tif (ethadv_cfg & ADVERTISED_Autoneg) {\n\t\tcfg |= ALX_DRV_PHY_AUTO;\n\t\tif (ethadv_cfg & ADVERTISED_10baseT_Half)\n\t\t\tcfg |= ALX_DRV_PHY_10;\n\t\tif (ethadv_cfg & ADVERTISED_10baseT_Full)\n\t\t\tcfg |= ALX_DRV_PHY_10 | ALX_DRV_PHY_DUPLEX;\n\t\tif (ethadv_cfg & ADVERTISED_100baseT_Half)\n\t\t\tcfg |= ALX_DRV_PHY_100;\n\t\tif (ethadv_cfg & ADVERTISED_100baseT_Full)\n\t\t\tcfg |= ALX_DRV_PHY_100 | ALX_DRV_PHY_DUPLEX;\n\t\tif (ethadv_cfg & ADVERTISED_1000baseT_Half)\n\t\t\tcfg |= ALX_DRV_PHY_1000;\n\t\tif (ethadv_cfg & ADVERTISED_1000baseT_Full)\n\t\t\tcfg |= ALX_DRV_PHY_100 | ALX_DRV_PHY_DUPLEX;\n\t\tif (ethadv_cfg & ADVERTISED_Pause)\n\t\t\tcfg |= ADVERTISE_PAUSE_CAP;\n\t\tif (ethadv_cfg & ADVERTISED_Asym_Pause)\n\t\t\tcfg |= ADVERTISE_PAUSE_ASYM;\n\t} else {\n\t\tswitch (ethadv_cfg) {\n\t\tcase ADVERTISED_10baseT_Half:\n\t\t\tcfg |= ALX_DRV_PHY_10;\n\t\t\tbreak;\n\t\tcase ADVERTISED_100baseT_Half:\n\t\t\tcfg |= ALX_DRV_PHY_100;\n\t\t\tbreak;\n\t\tcase ADVERTISED_10baseT_Full:\n\t\t\tcfg |= ALX_DRV_PHY_10 | ALX_DRV_PHY_DUPLEX;\n\t\t\tbreak;\n\t\tcase ADVERTISED_100baseT_Full:\n\t\t\tcfg |= ALX_DRV_PHY_100 | ALX_DRV_PHY_DUPLEX;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn cfg;\n}\n\nint alx_setup_speed_duplex(struct alx_hw *hw, u32 ethadv, u8 flowctrl)\n{\n\tu16 adv, giga, cr;\n\tu32 val;\n\tint err = 0;\n\n\talx_write_phy_reg(hw, ALX_MII_DBG_ADDR, 0);\n\tval = alx_read_mem32(hw, ALX_DRV);\n\tALX_SET_FIELD(val, ALX_DRV_PHY, 0);\n\n\tif (ethadv & ADVERTISED_Autoneg) {\n\t\tadv = ADVERTISE_CSMA;\n\t\tadv |= ethtool_adv_to_mii_adv_t(ethadv);\n\n\t\tif (flowctrl & ALX_FC_ANEG) {\n\t\t\tif (flowctrl & ALX_FC_RX) {\n\t\t\t\tadv |= ADVERTISED_Pause;\n\t\t\t\tif (!(flowctrl & ALX_FC_TX))\n\t\t\t\t\tadv |= ADVERTISED_Asym_Pause;\n\t\t\t} else if (flowctrl & ALX_FC_TX) {\n\t\t\t\tadv |= ADVERTISED_Asym_Pause;\n\t\t\t}\n\t\t}\n\t\tgiga = 0;\n\t\tif (alx_hw_giga(hw))\n\t\t\tgiga = ethtool_adv_to_mii_ctrl1000_t(ethadv);\n\n\t\tcr = BMCR_RESET | BMCR_ANENABLE | BMCR_ANRESTART;\n\n\t\tif (alx_write_phy_reg(hw, MII_ADVERTISE, adv) ||\n\t\t    alx_write_phy_reg(hw, MII_CTRL1000, giga) ||\n\t\t    alx_write_phy_reg(hw, MII_BMCR, cr))\n\t\t\terr = -EBUSY;\n\t} else {\n\t\tcr = BMCR_RESET;\n\t\tif (ethadv == ADVERTISED_100baseT_Half ||\n\t\t    ethadv == ADVERTISED_100baseT_Full)\n\t\t\tcr |= BMCR_SPEED100;\n\t\tif (ethadv == ADVERTISED_10baseT_Full ||\n\t\t    ethadv == ADVERTISED_100baseT_Full)\n\t\t\tcr |= BMCR_FULLDPLX;\n\n\t\terr = alx_write_phy_reg(hw, MII_BMCR, cr);\n\t}\n\n\tif (!err) {\n\t\talx_write_phy_reg(hw, ALX_MII_DBG_ADDR, ALX_PHY_INITED);\n\t\tval |= ethadv_to_hw_cfg(hw, ethadv);\n\t}\n\n\talx_write_mem32(hw, ALX_DRV, val);\n\n\treturn err;\n}\n\n\nvoid alx_post_phy_link(struct alx_hw *hw)\n{\n\tu16 phy_val, len, agc;\n\tu8 revid = alx_hw_revision(hw);\n\tbool adj_th = revid == ALX_REV_B0;\n\n\tif (revid != ALX_REV_B0 && !alx_is_rev_a(revid))\n\t\treturn;\n\n\t \n\tif (hw->link_speed != SPEED_UNKNOWN) {\n\t\talx_read_phy_ext(hw, ALX_MIIEXT_PCS, ALX_MIIEXT_CLDCTRL6,\n\t\t\t\t &phy_val);\n\t\tlen = ALX_GET_FIELD(phy_val, ALX_CLDCTRL6_CAB_LEN);\n\t\talx_read_phy_dbg(hw, ALX_MIIDBG_AGC, &phy_val);\n\t\tagc = ALX_GET_FIELD(phy_val, ALX_AGC_2_VGA);\n\n\t\tif ((hw->link_speed == SPEED_1000 &&\n\t\t     (len > ALX_CLDCTRL6_CAB_LEN_SHORT1G ||\n\t\t      (len == 0 && agc > ALX_AGC_LONG1G_LIMT))) ||\n\t\t    (hw->link_speed == SPEED_100 &&\n\t\t     (len > ALX_CLDCTRL6_CAB_LEN_SHORT100M ||\n\t\t      (len == 0 && agc > ALX_AGC_LONG100M_LIMT)))) {\n\t\t\talx_write_phy_dbg(hw, ALX_MIIDBG_AZ_ANADECT,\n\t\t\t\t\t  ALX_AZ_ANADECT_LONG);\n\t\t\talx_read_phy_ext(hw, ALX_MIIEXT_ANEG, ALX_MIIEXT_AFE,\n\t\t\t\t\t &phy_val);\n\t\t\talx_write_phy_ext(hw, ALX_MIIEXT_ANEG, ALX_MIIEXT_AFE,\n\t\t\t\t\t  phy_val | ALX_AFE_10BT_100M_TH);\n\t\t} else {\n\t\t\talx_write_phy_dbg(hw, ALX_MIIDBG_AZ_ANADECT,\n\t\t\t\t\t  ALX_AZ_ANADECT_DEF);\n\t\t\talx_read_phy_ext(hw, ALX_MIIEXT_ANEG,\n\t\t\t\t\t ALX_MIIEXT_AFE, &phy_val);\n\t\t\talx_write_phy_ext(hw, ALX_MIIEXT_ANEG, ALX_MIIEXT_AFE,\n\t\t\t\t\t  phy_val & ~ALX_AFE_10BT_100M_TH);\n\t\t}\n\n\t\t \n\t\tif (adj_th && hw->lnk_patch) {\n\t\t\tif (hw->link_speed == SPEED_100) {\n\t\t\t\talx_write_phy_dbg(hw, ALX_MIIDBG_MSE16DB,\n\t\t\t\t\t\t  ALX_MSE16DB_UP);\n\t\t\t} else if (hw->link_speed == SPEED_1000) {\n\t\t\t\t \n\t\t\t\talx_read_phy_dbg(hw, ALX_MIIDBG_MSE20DB,\n\t\t\t\t\t\t &phy_val);\n\t\t\t\tALX_SET_FIELD(phy_val, ALX_MSE20DB_TH,\n\t\t\t\t\t      ALX_MSE20DB_TH_HI);\n\t\t\t\talx_write_phy_dbg(hw, ALX_MIIDBG_MSE20DB,\n\t\t\t\t\t\t  phy_val);\n\t\t\t}\n\t\t}\n\t} else {\n\t\talx_read_phy_ext(hw, ALX_MIIEXT_ANEG, ALX_MIIEXT_AFE,\n\t\t\t\t &phy_val);\n\t\talx_write_phy_ext(hw, ALX_MIIEXT_ANEG, ALX_MIIEXT_AFE,\n\t\t\t\t  phy_val & ~ALX_AFE_10BT_100M_TH);\n\n\t\tif (adj_th && hw->lnk_patch) {\n\t\t\talx_write_phy_dbg(hw, ALX_MIIDBG_MSE16DB,\n\t\t\t\t\t  ALX_MSE16DB_DOWN);\n\t\t\talx_read_phy_dbg(hw, ALX_MIIDBG_MSE20DB, &phy_val);\n\t\t\tALX_SET_FIELD(phy_val, ALX_MSE20DB_TH,\n\t\t\t\t      ALX_MSE20DB_TH_DEF);\n\t\t\talx_write_phy_dbg(hw, ALX_MIIDBG_MSE20DB, phy_val);\n\t\t}\n\t}\n}\n\nbool alx_phy_configured(struct alx_hw *hw)\n{\n\tu32 cfg, hw_cfg;\n\n\tcfg = ethadv_to_hw_cfg(hw, hw->adv_cfg);\n\tcfg = ALX_GET_FIELD(cfg, ALX_DRV_PHY);\n\thw_cfg = alx_get_phy_config(hw);\n\n\tif (hw_cfg == ALX_DRV_PHY_UNKNOWN)\n\t\treturn false;\n\n\treturn cfg == hw_cfg;\n}\n\nint alx_read_phy_link(struct alx_hw *hw)\n{\n\tstruct pci_dev *pdev = hw->pdev;\n\tu16 bmsr, giga;\n\tint err;\n\n\terr = alx_read_phy_reg(hw, MII_BMSR, &bmsr);\n\tif (err)\n\t\treturn err;\n\n\terr = alx_read_phy_reg(hw, MII_BMSR, &bmsr);\n\tif (err)\n\t\treturn err;\n\n\tif (!(bmsr & BMSR_LSTATUS)) {\n\t\thw->link_speed = SPEED_UNKNOWN;\n\t\thw->duplex = DUPLEX_UNKNOWN;\n\t\treturn 0;\n\t}\n\n\t \n\terr = alx_read_phy_reg(hw, ALX_MII_GIGA_PSSR, &giga);\n\tif (err)\n\t\treturn err;\n\n\tif (!(giga & ALX_GIGA_PSSR_SPD_DPLX_RESOLVED))\n\t\tgoto wrong_speed;\n\n\tswitch (giga & ALX_GIGA_PSSR_SPEED) {\n\tcase ALX_GIGA_PSSR_1000MBS:\n\t\thw->link_speed = SPEED_1000;\n\t\tbreak;\n\tcase ALX_GIGA_PSSR_100MBS:\n\t\thw->link_speed = SPEED_100;\n\t\tbreak;\n\tcase ALX_GIGA_PSSR_10MBS:\n\t\thw->link_speed = SPEED_10;\n\t\tbreak;\n\tdefault:\n\t\tgoto wrong_speed;\n\t}\n\n\thw->duplex = (giga & ALX_GIGA_PSSR_DPLX) ? DUPLEX_FULL : DUPLEX_HALF;\n\treturn 0;\n\nwrong_speed:\n\tdev_err(&pdev->dev, \"invalid PHY speed/duplex: 0x%x\\n\", giga);\n\treturn -EINVAL;\n}\n\nint alx_clear_phy_intr(struct alx_hw *hw)\n{\n\tu16 isr;\n\n\t \n\treturn alx_read_phy_reg(hw, ALX_MII_ISR, &isr);\n}\n\nvoid alx_disable_rss(struct alx_hw *hw)\n{\n\tu32 ctrl = alx_read_mem32(hw, ALX_RXQ0);\n\n\tctrl &= ~ALX_RXQ0_RSS_HASH_EN;\n\talx_write_mem32(hw, ALX_RXQ0, ctrl);\n}\n\nvoid alx_configure_basic(struct alx_hw *hw)\n{\n\tu32 val, raw_mtu, max_payload;\n\tu16 val16;\n\tu8 chip_rev = alx_hw_revision(hw);\n\n\talx_set_macaddr(hw, hw->mac_addr);\n\n\talx_write_mem32(hw, ALX_CLK_GATE, ALX_CLK_GATE_ALL);\n\n\t \n\tif (chip_rev >= ALX_REV_B0)\n\t\talx_write_mem32(hw, ALX_IDLE_DECISN_TIMER,\n\t\t\t\tALX_IDLE_DECISN_TIMER_DEF);\n\n\talx_write_mem32(hw, ALX_SMB_TIMER, hw->smb_timer * 500UL);\n\n\tval = alx_read_mem32(hw, ALX_MASTER);\n\tval |= ALX_MASTER_IRQMOD2_EN |\n\t       ALX_MASTER_IRQMOD1_EN |\n\t       ALX_MASTER_SYSALVTIMER_EN;\n\talx_write_mem32(hw, ALX_MASTER, val);\n\talx_write_mem32(hw, ALX_IRQ_MODU_TIMER,\n\t\t\t(hw->imt >> 1) << ALX_IRQ_MODU_TIMER1_SHIFT);\n\t \n\talx_write_mem32(hw, ALX_INT_RETRIG, ALX_INT_RETRIG_TO);\n\t \n\talx_write_mem32(hw, ALX_TINT_TPD_THRSHLD, hw->ith_tpd);\n\talx_write_mem32(hw, ALX_TINT_TIMER, hw->imt);\n\n\traw_mtu = ALX_RAW_MTU(hw->mtu);\n\talx_write_mem32(hw, ALX_MTU, raw_mtu);\n\tif (raw_mtu > (ALX_MTU_JUMBO_TH + ETH_FCS_LEN + VLAN_HLEN))\n\t\thw->rx_ctrl &= ~ALX_MAC_CTRL_FAST_PAUSE;\n\n\tif (raw_mtu < ALX_TXQ1_JUMBO_TSO_TH)\n\t\tval = (raw_mtu + 7) >> 3;\n\telse\n\t\tval = ALX_TXQ1_JUMBO_TSO_TH >> 3;\n\talx_write_mem32(hw, ALX_TXQ1, val | ALX_TXQ1_ERRLGPKT_DROP_EN);\n\n\tmax_payload = pcie_get_readrq(hw->pdev) >> 8;\n\t \n\tif (max_payload < ALX_DEV_CTRL_MAXRRS_MIN)\n\t\tpcie_set_readrq(hw->pdev, 128 << ALX_DEV_CTRL_MAXRRS_MIN);\n\n\tval = ALX_TXQ_TPD_BURSTPREF_DEF << ALX_TXQ0_TPD_BURSTPREF_SHIFT |\n\t      ALX_TXQ0_MODE_ENHANCE | ALX_TXQ0_LSO_8023_EN |\n\t      ALX_TXQ0_SUPT_IPOPT |\n\t      ALX_TXQ_TXF_BURST_PREF_DEF << ALX_TXQ0_TXF_BURST_PREF_SHIFT;\n\talx_write_mem32(hw, ALX_TXQ0, val);\n\tval = ALX_TXQ_TPD_BURSTPREF_DEF << ALX_HQTPD_Q1_NUMPREF_SHIFT |\n\t      ALX_TXQ_TPD_BURSTPREF_DEF << ALX_HQTPD_Q2_NUMPREF_SHIFT |\n\t      ALX_TXQ_TPD_BURSTPREF_DEF << ALX_HQTPD_Q3_NUMPREF_SHIFT |\n\t      ALX_HQTPD_BURST_EN;\n\talx_write_mem32(hw, ALX_HQTPD, val);\n\n\t \n\tval = alx_read_mem32(hw, ALX_SRAM5);\n\tval = ALX_GET_FIELD(val, ALX_SRAM_RXF_LEN) << 3;\n\tif (val > ALX_SRAM_RXF_LEN_8K) {\n\t\tval16 = ALX_MTU_STD_ALGN >> 3;\n\t\tval = (val - ALX_RXQ2_RXF_FLOW_CTRL_RSVD) >> 3;\n\t} else {\n\t\tval16 = ALX_MTU_STD_ALGN >> 3;\n\t\tval = (val - ALX_MTU_STD_ALGN) >> 3;\n\t}\n\talx_write_mem32(hw, ALX_RXQ2,\n\t\t\tval16 << ALX_RXQ2_RXF_XOFF_THRESH_SHIFT |\n\t\t\tval << ALX_RXQ2_RXF_XON_THRESH_SHIFT);\n\tval = ALX_RXQ0_NUM_RFD_PREF_DEF << ALX_RXQ0_NUM_RFD_PREF_SHIFT |\n\t      ALX_RXQ0_RSS_MODE_DIS << ALX_RXQ0_RSS_MODE_SHIFT |\n\t      ALX_RXQ0_IDT_TBL_SIZE_DEF << ALX_RXQ0_IDT_TBL_SIZE_SHIFT |\n\t      ALX_RXQ0_RSS_HSTYP_ALL | ALX_RXQ0_RSS_HASH_EN |\n\t      ALX_RXQ0_IPV6_PARSE_EN;\n\n\tif (alx_hw_giga(hw))\n\t\tALX_SET_FIELD(val, ALX_RXQ0_ASPM_THRESH,\n\t\t\t      ALX_RXQ0_ASPM_THRESH_100M);\n\n\talx_write_mem32(hw, ALX_RXQ0, val);\n\n\tval = alx_read_mem32(hw, ALX_DMA);\n\tval = ALX_DMA_RORDER_MODE_OUT << ALX_DMA_RORDER_MODE_SHIFT |\n\t      ALX_DMA_RREQ_PRI_DATA |\n\t      max_payload << ALX_DMA_RREQ_BLEN_SHIFT |\n\t      ALX_DMA_WDLY_CNT_DEF << ALX_DMA_WDLY_CNT_SHIFT |\n\t      ALX_DMA_RDLY_CNT_DEF << ALX_DMA_RDLY_CNT_SHIFT |\n\t      (hw->dma_chnl - 1) << ALX_DMA_RCHNL_SEL_SHIFT;\n\talx_write_mem32(hw, ALX_DMA, val);\n\n\t \n\tval = ALX_WRR_PRI_RESTRICT_NONE << ALX_WRR_PRI_SHIFT |\n\t      4 << ALX_WRR_PRI0_SHIFT |\n\t      4 << ALX_WRR_PRI1_SHIFT |\n\t      4 << ALX_WRR_PRI2_SHIFT |\n\t      4 << ALX_WRR_PRI3_SHIFT;\n\talx_write_mem32(hw, ALX_WRR, val);\n}\n\nvoid alx_mask_msix(struct alx_hw *hw, int index, bool mask)\n{\n\tu32 reg, val;\n\n\treg = ALX_MSIX_ENTRY_BASE + index * PCI_MSIX_ENTRY_SIZE +\n\t\tPCI_MSIX_ENTRY_VECTOR_CTRL;\n\n\tval = mask ? PCI_MSIX_ENTRY_CTRL_MASKBIT : 0;\n\n\talx_write_mem32(hw, reg, val);\n\talx_post_write(hw);\n}\n\n\nbool alx_get_phy_info(struct alx_hw *hw)\n{\n\tu16  devs1, devs2;\n\n\tif (alx_read_phy_reg(hw, MII_PHYSID1, &hw->phy_id[0]) ||\n\t    alx_read_phy_reg(hw, MII_PHYSID2, &hw->phy_id[1]))\n\t\treturn false;\n\n\t \n\tif (alx_read_phy_ext(hw, 3, MDIO_DEVS1, &devs1) ||\n\t    alx_read_phy_ext(hw, 3, MDIO_DEVS2, &devs2))\n\t\treturn false;\n\thw->mdio.mmds = devs1 | devs2 << 16;\n\n\treturn true;\n}\n\nvoid alx_update_hw_stats(struct alx_hw *hw)\n{\n\t \n\thw->stats.rx_ok          += alx_read_mem32(hw, ALX_MIB_RX_OK);\n\thw->stats.rx_bcast       += alx_read_mem32(hw, ALX_MIB_RX_BCAST);\n\thw->stats.rx_mcast       += alx_read_mem32(hw, ALX_MIB_RX_MCAST);\n\thw->stats.rx_pause       += alx_read_mem32(hw, ALX_MIB_RX_PAUSE);\n\thw->stats.rx_ctrl        += alx_read_mem32(hw, ALX_MIB_RX_CTRL);\n\thw->stats.rx_fcs_err     += alx_read_mem32(hw, ALX_MIB_RX_FCS_ERR);\n\thw->stats.rx_len_err     += alx_read_mem32(hw, ALX_MIB_RX_LEN_ERR);\n\thw->stats.rx_byte_cnt    += alx_read_mem32(hw, ALX_MIB_RX_BYTE_CNT);\n\thw->stats.rx_runt        += alx_read_mem32(hw, ALX_MIB_RX_RUNT);\n\thw->stats.rx_frag        += alx_read_mem32(hw, ALX_MIB_RX_FRAG);\n\thw->stats.rx_sz_64B      += alx_read_mem32(hw, ALX_MIB_RX_SZ_64B);\n\thw->stats.rx_sz_127B     += alx_read_mem32(hw, ALX_MIB_RX_SZ_127B);\n\thw->stats.rx_sz_255B     += alx_read_mem32(hw, ALX_MIB_RX_SZ_255B);\n\thw->stats.rx_sz_511B     += alx_read_mem32(hw, ALX_MIB_RX_SZ_511B);\n\thw->stats.rx_sz_1023B    += alx_read_mem32(hw, ALX_MIB_RX_SZ_1023B);\n\thw->stats.rx_sz_1518B    += alx_read_mem32(hw, ALX_MIB_RX_SZ_1518B);\n\thw->stats.rx_sz_max      += alx_read_mem32(hw, ALX_MIB_RX_SZ_MAX);\n\thw->stats.rx_ov_sz       += alx_read_mem32(hw, ALX_MIB_RX_OV_SZ);\n\thw->stats.rx_ov_rxf      += alx_read_mem32(hw, ALX_MIB_RX_OV_RXF);\n\thw->stats.rx_ov_rrd      += alx_read_mem32(hw, ALX_MIB_RX_OV_RRD);\n\thw->stats.rx_align_err   += alx_read_mem32(hw, ALX_MIB_RX_ALIGN_ERR);\n\thw->stats.rx_bc_byte_cnt += alx_read_mem32(hw, ALX_MIB_RX_BCCNT);\n\thw->stats.rx_mc_byte_cnt += alx_read_mem32(hw, ALX_MIB_RX_MCCNT);\n\thw->stats.rx_err_addr    += alx_read_mem32(hw, ALX_MIB_RX_ERRADDR);\n\n\t \n\thw->stats.tx_ok          += alx_read_mem32(hw, ALX_MIB_TX_OK);\n\thw->stats.tx_bcast       += alx_read_mem32(hw, ALX_MIB_TX_BCAST);\n\thw->stats.tx_mcast       += alx_read_mem32(hw, ALX_MIB_TX_MCAST);\n\thw->stats.tx_pause       += alx_read_mem32(hw, ALX_MIB_TX_PAUSE);\n\thw->stats.tx_exc_defer   += alx_read_mem32(hw, ALX_MIB_TX_EXC_DEFER);\n\thw->stats.tx_ctrl        += alx_read_mem32(hw, ALX_MIB_TX_CTRL);\n\thw->stats.tx_defer       += alx_read_mem32(hw, ALX_MIB_TX_DEFER);\n\thw->stats.tx_byte_cnt    += alx_read_mem32(hw, ALX_MIB_TX_BYTE_CNT);\n\thw->stats.tx_sz_64B      += alx_read_mem32(hw, ALX_MIB_TX_SZ_64B);\n\thw->stats.tx_sz_127B     += alx_read_mem32(hw, ALX_MIB_TX_SZ_127B);\n\thw->stats.tx_sz_255B     += alx_read_mem32(hw, ALX_MIB_TX_SZ_255B);\n\thw->stats.tx_sz_511B     += alx_read_mem32(hw, ALX_MIB_TX_SZ_511B);\n\thw->stats.tx_sz_1023B    += alx_read_mem32(hw, ALX_MIB_TX_SZ_1023B);\n\thw->stats.tx_sz_1518B    += alx_read_mem32(hw, ALX_MIB_TX_SZ_1518B);\n\thw->stats.tx_sz_max      += alx_read_mem32(hw, ALX_MIB_TX_SZ_MAX);\n\thw->stats.tx_single_col  += alx_read_mem32(hw, ALX_MIB_TX_SINGLE_COL);\n\thw->stats.tx_multi_col   += alx_read_mem32(hw, ALX_MIB_TX_MULTI_COL);\n\thw->stats.tx_late_col    += alx_read_mem32(hw, ALX_MIB_TX_LATE_COL);\n\thw->stats.tx_abort_col   += alx_read_mem32(hw, ALX_MIB_TX_ABORT_COL);\n\thw->stats.tx_underrun    += alx_read_mem32(hw, ALX_MIB_TX_UNDERRUN);\n\thw->stats.tx_trd_eop     += alx_read_mem32(hw, ALX_MIB_TX_TRD_EOP);\n\thw->stats.tx_len_err     += alx_read_mem32(hw, ALX_MIB_TX_LEN_ERR);\n\thw->stats.tx_trunc       += alx_read_mem32(hw, ALX_MIB_TX_TRUNC);\n\thw->stats.tx_bc_byte_cnt += alx_read_mem32(hw, ALX_MIB_TX_BCCNT);\n\thw->stats.tx_mc_byte_cnt += alx_read_mem32(hw, ALX_MIB_TX_MCCNT);\n\n\thw->stats.update         += alx_read_mem32(hw, ALX_MIB_UPDATE);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}