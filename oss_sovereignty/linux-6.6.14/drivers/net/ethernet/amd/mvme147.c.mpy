{
  "module_name": "mvme147.c",
  "hash_id": "e2347d16a6aa3db38d9c0c21f06f8b3cd097e45495e5f593e9f752e1a5ecc3eb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/amd/mvme147.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/interrupt.h>\n#include <linux/ioport.h>\n#include <linux/string.h>\n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/errno.h>\n#include <linux/gfp.h>\n#include <linux/pgtable.h>\n \n#include <linux/socket.h>\n#include <linux/route.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n#include <linux/skbuff.h>\n\n#include <asm/io.h>\n#include <asm/mvme147hw.h>\n\n \n#define LANCE_LOG_TX_BUFFERS 1\n#define LANCE_LOG_RX_BUFFERS 3\n\n#include \"7990.h\"                                  \n\n \nstruct m147lance_private {\n\tstruct lance_private lance;\n\tunsigned long ram;\n};\n\n \nstatic int m147lance_open(struct net_device *dev);\nstatic int m147lance_close(struct net_device *dev);\nstatic void m147lance_writerap(struct lance_private *lp, unsigned short value);\nstatic void m147lance_writerdp(struct lance_private *lp, unsigned short value);\nstatic unsigned short m147lance_readrdp(struct lance_private *lp);\n\ntypedef void (*writerap_t)(void *, unsigned short);\ntypedef void (*writerdp_t)(void *, unsigned short);\ntypedef unsigned short (*readrdp_t)(void *);\n\nstatic const struct net_device_ops lance_netdev_ops = {\n\t.ndo_open\t\t= m147lance_open,\n\t.ndo_stop\t\t= m147lance_close,\n\t.ndo_start_xmit\t\t= lance_start_xmit,\n\t.ndo_set_rx_mode\t= lance_set_multicast,\n\t.ndo_tx_timeout\t\t= lance_tx_timeout,\n\t.ndo_validate_addr\t= eth_validate_addr,\n\t.ndo_set_mac_address\t= eth_mac_addr,\n};\n\n \nstatic struct net_device * __init mvme147lance_probe(void)\n{\n\tstruct net_device *dev;\n\tstatic int called;\n\tstatic const char name[] = \"MVME147 LANCE\";\n\tstruct m147lance_private *lp;\n\tu8 macaddr[ETH_ALEN];\n\tu_long *addr;\n\tu_long address;\n\tint err;\n\n\tif (!MACH_IS_MVME147 || called)\n\t\treturn ERR_PTR(-ENODEV);\n\tcalled++;\n\n\tdev = alloc_etherdev(sizeof(struct m147lance_private));\n\tif (!dev)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\t \n\tdev->base_addr = (unsigned long)MVME147_LANCE_BASE;\n\tdev->netdev_ops = &lance_netdev_ops;\n\tdev->dma = 0;\n\n\taddr = (u_long *)ETHERNET_ADDRESS;\n\taddress = *addr;\n\tmacaddr[0] = 0x08;\n\tmacaddr[1] = 0x00;\n\tmacaddr[2] = 0x3e;\n\taddress = address >> 8;\n\tmacaddr[5] = address&0xff;\n\taddress = address >> 8;\n\tmacaddr[4] = address&0xff;\n\taddress = address >> 8;\n\tmacaddr[3] = address&0xff;\n\teth_hw_addr_set(dev, macaddr);\n\n\tprintk(\"%s: MVME147 at 0x%08lx, irq %d, Hardware Address %pM\\n\",\n\t       dev->name, dev->base_addr, MVME147_LANCE_IRQ,\n\t       dev->dev_addr);\n\n\tlp = netdev_priv(dev);\n\tlp->ram = __get_dma_pages(GFP_ATOMIC, 3);\t \n\tif (!lp->ram) {\n\t\tprintk(\"%s: No memory for LANCE buffers\\n\", dev->name);\n\t\tfree_netdev(dev);\n\t\treturn ERR_PTR(-ENOMEM);\n\t}\n\n\tlp->lance.name = name;\n\tlp->lance.base = dev->base_addr;\n\tlp->lance.init_block = (struct lance_init_block *)(lp->ram);  \n\tlp->lance.lance_init_block = (struct lance_init_block *)(lp->ram);                  \n\tlp->lance.busmaster_regval = LE_C3_BSWP;         \n\tlp->lance.irq = MVME147_LANCE_IRQ;\n\tlp->lance.writerap = (writerap_t)m147lance_writerap;\n\tlp->lance.writerdp = (writerdp_t)m147lance_writerdp;\n\tlp->lance.readrdp = (readrdp_t)m147lance_readrdp;\n\tlp->lance.lance_log_rx_bufs = LANCE_LOG_RX_BUFFERS;\n\tlp->lance.lance_log_tx_bufs = LANCE_LOG_TX_BUFFERS;\n\tlp->lance.rx_ring_mod_mask = RX_RING_MOD_MASK;\n\tlp->lance.tx_ring_mod_mask = TX_RING_MOD_MASK;\n\n\terr = register_netdev(dev);\n\tif (err) {\n\t\tfree_pages(lp->ram, 3);\n\t\tfree_netdev(dev);\n\t\treturn ERR_PTR(err);\n\t}\n\n\treturn dev;\n}\n\nstatic void m147lance_writerap(struct lance_private *lp, unsigned short value)\n{\n\tout_be16(lp->base + LANCE_RAP, value);\n}\n\nstatic void m147lance_writerdp(struct lance_private *lp, unsigned short value)\n{\n\tout_be16(lp->base + LANCE_RDP, value);\n}\n\nstatic unsigned short m147lance_readrdp(struct lance_private *lp)\n{\n\treturn in_be16(lp->base + LANCE_RDP);\n}\n\nstatic int m147lance_open(struct net_device *dev)\n{\n\tint status;\n\n\tstatus = lance_open(dev);                  \n\tif (status)\n\t\treturn status;\n\t \n\tm147_pcc->lan_cntrl = 0;        \n\tm147_pcc->lan_cntrl = 0x08 | 0x04;      \n\n\treturn 0;\n}\n\nstatic int m147lance_close(struct net_device *dev)\n{\n\t \n\tm147_pcc->lan_cntrl = 0x0;  \n\tlance_close(dev);\n\treturn 0;\n}\n\nMODULE_LICENSE(\"GPL\");\n\nstatic struct net_device *dev_mvme147_lance;\nstatic int __init m147lance_init(void)\n{\n\tdev_mvme147_lance = mvme147lance_probe();\n\treturn PTR_ERR_OR_ZERO(dev_mvme147_lance);\n}\nmodule_init(m147lance_init);\n\nstatic void __exit m147lance_exit(void)\n{\n\tstruct m147lance_private *lp = netdev_priv(dev_mvme147_lance);\n\tunregister_netdev(dev_mvme147_lance);\n\tfree_pages(lp->ram, 3);\n\tfree_netdev(dev_mvme147_lance);\n}\nmodule_exit(m147lance_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}