{
  "module_name": "core.h",
  "hash_id": "4032769b8aa527265663584881df7f2261a888461ec8f4270030d987c0ef8a7b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/amd/pds_core/core.h",
  "human_readable_source": " \n \n\n#ifndef _PDSC_H_\n#define _PDSC_H_\n\n#include <linux/debugfs.h>\n#include <net/devlink.h>\n\n#include <linux/pds/pds_common.h>\n#include <linux/pds/pds_core_if.h>\n#include <linux/pds/pds_adminq.h>\n#include <linux/pds/pds_intr.h>\n\n#define PDSC_DRV_DESCRIPTION\t\"AMD/Pensando Core Driver\"\n\n#define PDSC_WATCHDOG_SECS\t5\n#define PDSC_QUEUE_NAME_MAX_SZ  16\n#define PDSC_ADMINQ_MIN_LENGTH\t16\t \n#define PDSC_NOTIFYQ_LENGTH\t64\t \n#define PDSC_TEARDOWN_RECOVERY\tfalse\n#define PDSC_TEARDOWN_REMOVING\ttrue\n#define PDSC_SETUP_RECOVERY\tfalse\n#define PDSC_SETUP_INIT\t\ttrue\n\nstruct pdsc_dev_bar {\n\tvoid __iomem *vaddr;\n\tphys_addr_t bus_addr;\n\tunsigned long len;\n\tint res_index;\n};\n\nstruct pdsc;\n\nstruct pdsc_vf {\n\tstruct pds_auxiliary_dev *padev;\n\tstruct pdsc *vf;\n\tu16     index;\n\t__le16  vif_types[PDS_DEV_TYPE_MAX];\n};\n\nstruct pdsc_devinfo {\n\tu8 asic_type;\n\tu8 asic_rev;\n\tchar fw_version[PDS_CORE_DEVINFO_FWVERS_BUFLEN + 1];\n\tchar serial_num[PDS_CORE_DEVINFO_SERIAL_BUFLEN + 1];\n};\n\nstruct pdsc_queue {\n\tstruct pdsc_q_info *info;\n\tu64 dbval;\n\tu16 head_idx;\n\tu16 tail_idx;\n\tu8 hw_type;\n\tunsigned int index;\n\tunsigned int num_descs;\n\tu64 dbell_count;\n\tu64 features;\n\tunsigned int type;\n\tunsigned int hw_index;\n\tunion {\n\t\tvoid *base;\n\t\tstruct pds_core_admin_cmd *adminq;\n\t};\n\tdma_addr_t base_pa;\t \n\tunsigned int desc_size;\n\tunsigned int pid;\n\tchar name[PDSC_QUEUE_NAME_MAX_SZ];\n};\n\n#define PDSC_INTR_NAME_MAX_SZ\t\t32\n\nstruct pdsc_intr_info {\n\tchar name[PDSC_INTR_NAME_MAX_SZ];\n\tunsigned int index;\n\tunsigned int vector;\n\tvoid *data;\n};\n\nstruct pdsc_cq_info {\n\tvoid *comp;\n};\n\nstruct pdsc_buf_info {\n\tstruct page *page;\n\tdma_addr_t dma_addr;\n\tu32 page_offset;\n\tu32 len;\n};\n\nstruct pdsc_q_info {\n\tunion {\n\t\tvoid *desc;\n\t\tstruct pdsc_admin_cmd *adminq_desc;\n\t};\n\tunsigned int bytes;\n\tunsigned int nbufs;\n\tstruct pdsc_buf_info bufs[PDS_CORE_MAX_FRAGS];\n\tstruct pdsc_wait_context *wc;\n\tvoid *dest;\n};\n\nstruct pdsc_cq {\n\tstruct pdsc_cq_info *info;\n\tstruct pdsc_queue *bound_q;\n\tstruct pdsc_intr_info *bound_intr;\n\tu16 tail_idx;\n\tbool done_color;\n\tunsigned int num_descs;\n\tunsigned int desc_size;\n\tvoid *base;\n\tdma_addr_t base_pa;\t \n} ____cacheline_aligned_in_smp;\n\nstruct pdsc_qcq {\n\tstruct pdsc *pdsc;\n\tvoid *q_base;\n\tdma_addr_t q_base_pa;\t \n\tvoid *cq_base;\n\tdma_addr_t cq_base_pa;\t \n\tu32 q_size;\n\tu32 cq_size;\n\tbool armed;\n\tunsigned int flags;\n\n\tstruct work_struct work;\n\tstruct pdsc_queue q;\n\tstruct pdsc_cq cq;\n\tint intx;\n\n\tu32 accum_work;\n\tstruct dentry *dentry;\n};\n\nstruct pdsc_viftype {\n\tchar *name;\n\tbool supported;\n\tbool enabled;\n\tint dl_id;\n\tint vif_id;\n\tstruct pds_auxiliary_dev *padev;\n};\n\n \nenum pdsc_state_flags {\n\tPDSC_S_FW_DEAD,\t\t     \n\tPDSC_S_INITING_DRIVER,\t     \n\tPDSC_S_STOPPING_DRIVER,\t     \n\n\t \n\tPDSC_S_STATE_SIZE\n};\n\nstruct pdsc {\n\tstruct pci_dev *pdev;\n\tstruct dentry *dentry;\n\tstruct device *dev;\n\tstruct pdsc_dev_bar bars[PDS_CORE_BARS_MAX];\n\tstruct pdsc_vf *vfs;\n\tint num_vfs;\n\tint vf_id;\n\tint hw_index;\n\tint uid;\n\n\tunsigned long state;\n\tu8 fw_status;\n\tu8 fw_generation;\n\tunsigned long last_fw_time;\n\tu32 last_hb;\n\tstruct timer_list wdtimer;\n\tunsigned int wdtimer_period;\n\tstruct work_struct health_work;\n\tstruct devlink_health_reporter *fw_reporter;\n\tu32 fw_recoveries;\n\n\tstruct pdsc_devinfo dev_info;\n\tstruct pds_core_dev_identity dev_ident;\n\tunsigned int nintrs;\n\tstruct pdsc_intr_info *intr_info;\t \n\n\tstruct workqueue_struct *wq;\n\n\tunsigned int devcmd_timeout;\n\tstruct mutex devcmd_lock;\t \n\tstruct mutex config_lock;\t \n\tspinlock_t adminq_lock;\t\t \n\tstruct pds_core_dev_info_regs __iomem *info_regs;\n\tstruct pds_core_dev_cmd_regs __iomem *cmd_regs;\n\tstruct pds_core_intr __iomem *intr_ctrl;\n\tu64 __iomem *intr_status;\n\tu64 __iomem *db_pages;\n\tdma_addr_t phy_db_pages;\n\tu64 __iomem *kern_dbpage;\n\n\tstruct pdsc_qcq adminqcq;\n\tstruct pdsc_qcq notifyqcq;\n\tu64 last_eid;\n\tstruct pdsc_viftype *viftype_status;\n};\n\n \nenum pds_core_dbell_bits {\n\tPDS_CORE_DBELL_QID_MASK\t\t= 0xffffff,\n\tPDS_CORE_DBELL_QID_SHIFT\t\t= 24,\n\n#define PDS_CORE_DBELL_QID(n) \\\n\t(((u64)(n) & PDS_CORE_DBELL_QID_MASK) << PDS_CORE_DBELL_QID_SHIFT)\n\n\tPDS_CORE_DBELL_RING_MASK\t\t= 0x7,\n\tPDS_CORE_DBELL_RING_SHIFT\t\t= 16,\n\n#define PDS_CORE_DBELL_RING(n) \\\n\t(((u64)(n) & PDS_CORE_DBELL_RING_MASK) << PDS_CORE_DBELL_RING_SHIFT)\n\n\tPDS_CORE_DBELL_RING_0\t\t= 0,\n\tPDS_CORE_DBELL_RING_1\t\t= PDS_CORE_DBELL_RING(1),\n\tPDS_CORE_DBELL_RING_2\t\t= PDS_CORE_DBELL_RING(2),\n\tPDS_CORE_DBELL_RING_3\t\t= PDS_CORE_DBELL_RING(3),\n\n\tPDS_CORE_DBELL_INDEX_MASK\t\t= 0xffff,\n};\n\nstatic inline void pds_core_dbell_ring(u64 __iomem *db_page,\n\t\t\t\t       enum pds_core_logical_qtype qtype,\n\t\t\t\t       u64 val)\n{\n\twriteq(val, &db_page[qtype]);\n}\n\nint pdsc_fw_reporter_diagnose(struct devlink_health_reporter *reporter,\n\t\t\t      struct devlink_fmsg *fmsg,\n\t\t\t      struct netlink_ext_ack *extack);\nint pdsc_dl_info_get(struct devlink *dl, struct devlink_info_req *req,\n\t\t     struct netlink_ext_ack *extack);\nint pdsc_dl_flash_update(struct devlink *dl,\n\t\t\t struct devlink_flash_update_params *params,\n\t\t\t struct netlink_ext_ack *extack);\nint pdsc_dl_enable_get(struct devlink *dl, u32 id,\n\t\t       struct devlink_param_gset_ctx *ctx);\nint pdsc_dl_enable_set(struct devlink *dl, u32 id,\n\t\t       struct devlink_param_gset_ctx *ctx);\nint pdsc_dl_enable_validate(struct devlink *dl, u32 id,\n\t\t\t    union devlink_param_value val,\n\t\t\t    struct netlink_ext_ack *extack);\n\nvoid __iomem *pdsc_map_dbpage(struct pdsc *pdsc, int page_num);\n\nvoid pdsc_debugfs_create(void);\nvoid pdsc_debugfs_destroy(void);\nvoid pdsc_debugfs_add_dev(struct pdsc *pdsc);\nvoid pdsc_debugfs_del_dev(struct pdsc *pdsc);\nvoid pdsc_debugfs_add_ident(struct pdsc *pdsc);\nvoid pdsc_debugfs_add_viftype(struct pdsc *pdsc);\nvoid pdsc_debugfs_add_irqs(struct pdsc *pdsc);\nvoid pdsc_debugfs_add_qcq(struct pdsc *pdsc, struct pdsc_qcq *qcq);\nvoid pdsc_debugfs_del_qcq(struct pdsc_qcq *qcq);\n\nint pdsc_err_to_errno(enum pds_core_status_code code);\nbool pdsc_is_fw_running(struct pdsc *pdsc);\nbool pdsc_is_fw_good(struct pdsc *pdsc);\nint pdsc_devcmd(struct pdsc *pdsc, union pds_core_dev_cmd *cmd,\n\t\tunion pds_core_dev_comp *comp, int max_seconds);\nint pdsc_devcmd_locked(struct pdsc *pdsc, union pds_core_dev_cmd *cmd,\n\t\t       union pds_core_dev_comp *comp, int max_seconds);\nint pdsc_devcmd_init(struct pdsc *pdsc);\nint pdsc_devcmd_reset(struct pdsc *pdsc);\nint pdsc_dev_reinit(struct pdsc *pdsc);\nint pdsc_dev_init(struct pdsc *pdsc);\n\nint pdsc_intr_alloc(struct pdsc *pdsc, char *name,\n\t\t    irq_handler_t handler, void *data);\nvoid pdsc_intr_free(struct pdsc *pdsc, int index);\nvoid pdsc_qcq_free(struct pdsc *pdsc, struct pdsc_qcq *qcq);\nint pdsc_qcq_alloc(struct pdsc *pdsc, unsigned int type, unsigned int index,\n\t\t   const char *name, unsigned int flags, unsigned int num_descs,\n\t\t   unsigned int desc_size, unsigned int cq_desc_size,\n\t\t   unsigned int pid, struct pdsc_qcq *qcq);\nint pdsc_setup(struct pdsc *pdsc, bool init);\nvoid pdsc_teardown(struct pdsc *pdsc, bool removing);\nint pdsc_start(struct pdsc *pdsc);\nvoid pdsc_stop(struct pdsc *pdsc);\nvoid pdsc_health_thread(struct work_struct *work);\n\nint pdsc_register_notify(struct notifier_block *nb);\nvoid pdsc_unregister_notify(struct notifier_block *nb);\nvoid pdsc_notify(unsigned long event, void *data);\nint pdsc_auxbus_dev_add(struct pdsc *cf, struct pdsc *pf);\nint pdsc_auxbus_dev_del(struct pdsc *cf, struct pdsc *pf);\n\nvoid pdsc_process_adminq(struct pdsc_qcq *qcq);\nvoid pdsc_work_thread(struct work_struct *work);\nirqreturn_t pdsc_adminq_isr(int irq, void *data);\n\nint pdsc_firmware_update(struct pdsc *pdsc, const struct firmware *fw,\n\t\t\t struct netlink_ext_ack *extack);\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}