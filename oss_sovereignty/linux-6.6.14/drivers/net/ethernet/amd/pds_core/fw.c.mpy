{
  "module_name": "fw.c",
  "hash_id": "250c1dc8c1d663a3f544c934864d96584ba89dad8ffa868ad40fe041ad3dc510",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/amd/pds_core/fw.c",
  "human_readable_source": "\n \n\n#include \"core.h\"\n\n \n#define PDSC_FW_INSTALL_TIMEOUT\t(25 * 60)\n#define PDSC_FW_SELECT_TIMEOUT\t30\n\n \n#define PDSC_FW_INTERVAL_FRACTION\t32\n\nstatic int pdsc_devcmd_fw_download_locked(struct pdsc *pdsc, u64 addr,\n\t\t\t\t\t  u32 offset, u32 length)\n{\n\tunion pds_core_dev_cmd cmd = {\n\t\t.fw_download.opcode = PDS_CORE_CMD_FW_DOWNLOAD,\n\t\t.fw_download.offset = cpu_to_le32(offset),\n\t\t.fw_download.addr = cpu_to_le64(addr),\n\t\t.fw_download.length = cpu_to_le32(length),\n\t};\n\tunion pds_core_dev_comp comp;\n\n\treturn pdsc_devcmd_locked(pdsc, &cmd, &comp, pdsc->devcmd_timeout);\n}\n\nstatic int pdsc_devcmd_fw_install(struct pdsc *pdsc)\n{\n\tunion pds_core_dev_cmd cmd = {\n\t\t.fw_control.opcode = PDS_CORE_CMD_FW_CONTROL,\n\t\t.fw_control.oper = PDS_CORE_FW_INSTALL_ASYNC\n\t};\n\tunion pds_core_dev_comp comp;\n\tint err;\n\n\terr = pdsc_devcmd(pdsc, &cmd, &comp, pdsc->devcmd_timeout);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn comp.fw_control.slot;\n}\n\nstatic int pdsc_devcmd_fw_activate(struct pdsc *pdsc,\n\t\t\t\t   enum pds_core_fw_slot slot)\n{\n\tunion pds_core_dev_cmd cmd = {\n\t\t.fw_control.opcode = PDS_CORE_CMD_FW_CONTROL,\n\t\t.fw_control.oper = PDS_CORE_FW_ACTIVATE_ASYNC,\n\t\t.fw_control.slot = slot\n\t};\n\tunion pds_core_dev_comp comp;\n\n\treturn pdsc_devcmd(pdsc, &cmd, &comp, pdsc->devcmd_timeout);\n}\n\nstatic int pdsc_fw_status_long_wait(struct pdsc *pdsc,\n\t\t\t\t    const char *label,\n\t\t\t\t    unsigned long timeout,\n\t\t\t\t    u8 fw_cmd,\n\t\t\t\t    struct netlink_ext_ack *extack)\n{\n\tunion pds_core_dev_cmd cmd = {\n\t\t.fw_control.opcode = PDS_CORE_CMD_FW_CONTROL,\n\t\t.fw_control.oper = fw_cmd,\n\t};\n\tunion pds_core_dev_comp comp;\n\tunsigned long start_time;\n\tunsigned long end_time;\n\tint err;\n\n\t \n\tstart_time = jiffies;\n\tend_time = start_time + (timeout * HZ);\n\tdo {\n\t\terr = pdsc_devcmd(pdsc, &cmd, &comp, pdsc->devcmd_timeout);\n\t\tmsleep(20);\n\t} while (time_before(jiffies, end_time) &&\n\t\t (err == -EAGAIN || err == -ETIMEDOUT));\n\n\tif (err == -EAGAIN || err == -ETIMEDOUT) {\n\t\tNL_SET_ERR_MSG_MOD(extack, \"Firmware wait timed out\");\n\t\tdev_err(pdsc->dev, \"DEV_CMD firmware wait %s timed out\\n\",\n\t\t\tlabel);\n\t} else if (err) {\n\t\tNL_SET_ERR_MSG_MOD(extack, \"Firmware wait failed\");\n\t}\n\n\treturn err;\n}\n\nint pdsc_firmware_update(struct pdsc *pdsc, const struct firmware *fw,\n\t\t\t struct netlink_ext_ack *extack)\n{\n\tu32 buf_sz, copy_sz, offset;\n\tstruct devlink *dl;\n\tint next_interval;\n\tu64 data_addr;\n\tint err = 0;\n\tint fw_slot;\n\n\tdev_info(pdsc->dev, \"Installing firmware\\n\");\n\n\tdl = priv_to_devlink(pdsc);\n\tdevlink_flash_update_status_notify(dl, \"Preparing to flash\",\n\t\t\t\t\t   NULL, 0, 0);\n\n\tbuf_sz = sizeof(pdsc->cmd_regs->data);\n\n\tdev_dbg(pdsc->dev,\n\t\t\"downloading firmware - size %d part_sz %d nparts %lu\\n\",\n\t\t(int)fw->size, buf_sz, DIV_ROUND_UP(fw->size, buf_sz));\n\n\toffset = 0;\n\tnext_interval = 0;\n\tdata_addr = offsetof(struct pds_core_dev_cmd_regs, data);\n\twhile (offset < fw->size) {\n\t\tif (offset >= next_interval) {\n\t\t\tdevlink_flash_update_status_notify(dl, \"Downloading\",\n\t\t\t\t\t\t\t   NULL, offset,\n\t\t\t\t\t\t\t   fw->size);\n\t\t\tnext_interval = offset +\n\t\t\t\t\t(fw->size / PDSC_FW_INTERVAL_FRACTION);\n\t\t}\n\n\t\tcopy_sz = min_t(unsigned int, buf_sz, fw->size - offset);\n\t\tmutex_lock(&pdsc->devcmd_lock);\n\t\tmemcpy_toio(&pdsc->cmd_regs->data, fw->data + offset, copy_sz);\n\t\terr = pdsc_devcmd_fw_download_locked(pdsc, data_addr,\n\t\t\t\t\t\t     offset, copy_sz);\n\t\tmutex_unlock(&pdsc->devcmd_lock);\n\t\tif (err) {\n\t\t\tdev_err(pdsc->dev,\n\t\t\t\t\"download failed offset 0x%x addr 0x%llx len 0x%x: %pe\\n\",\n\t\t\t\toffset, data_addr, copy_sz, ERR_PTR(err));\n\t\t\tNL_SET_ERR_MSG_MOD(extack, \"Segment download failed\");\n\t\t\tgoto err_out;\n\t\t}\n\t\toffset += copy_sz;\n\t}\n\tdevlink_flash_update_status_notify(dl, \"Downloading\", NULL,\n\t\t\t\t\t   fw->size, fw->size);\n\n\tdevlink_flash_update_timeout_notify(dl, \"Installing\", NULL,\n\t\t\t\t\t    PDSC_FW_INSTALL_TIMEOUT);\n\n\tfw_slot = pdsc_devcmd_fw_install(pdsc);\n\tif (fw_slot < 0) {\n\t\terr = fw_slot;\n\t\tdev_err(pdsc->dev, \"install failed: %pe\\n\", ERR_PTR(err));\n\t\tNL_SET_ERR_MSG_MOD(extack, \"Failed to start firmware install\");\n\t\tgoto err_out;\n\t}\n\n\terr = pdsc_fw_status_long_wait(pdsc, \"Installing\",\n\t\t\t\t       PDSC_FW_INSTALL_TIMEOUT,\n\t\t\t\t       PDS_CORE_FW_INSTALL_STATUS,\n\t\t\t\t       extack);\n\tif (err)\n\t\tgoto err_out;\n\n\tdevlink_flash_update_timeout_notify(dl, \"Selecting\", NULL,\n\t\t\t\t\t    PDSC_FW_SELECT_TIMEOUT);\n\n\terr = pdsc_devcmd_fw_activate(pdsc, fw_slot);\n\tif (err) {\n\t\tNL_SET_ERR_MSG_MOD(extack, \"Failed to start firmware select\");\n\t\tgoto err_out;\n\t}\n\n\terr = pdsc_fw_status_long_wait(pdsc, \"Selecting\",\n\t\t\t\t       PDSC_FW_SELECT_TIMEOUT,\n\t\t\t\t       PDS_CORE_FW_ACTIVATE_STATUS,\n\t\t\t\t       extack);\n\tif (err)\n\t\tgoto err_out;\n\n\tdev_info(pdsc->dev, \"Firmware update completed, slot %d\\n\", fw_slot);\n\nerr_out:\n\tif (err)\n\t\tdevlink_flash_update_status_notify(dl, \"Flash failed\",\n\t\t\t\t\t\t   NULL, 0, 0);\n\telse\n\t\tdevlink_flash_update_status_notify(dl, \"Flash done\",\n\t\t\t\t\t\t   NULL, 0, 0);\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}