{
  "module_name": "bfa_msgq.c",
  "hash_id": "20eb32dd93dfdc6cff7abccf02c55f72f09010cb5d96dea724e39f184d47f7b9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/brocade/bna/bfa_msgq.c",
  "human_readable_source": "\n \n \n\n \n\n#include \"bfi.h\"\n#include \"bfa_msgq.h\"\n#include \"bfa_ioc.h\"\n\n#define call_cmdq_ent_cbfn(_cmdq_ent, _status)\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\tbfa_msgq_cmdcbfn_t cbfn;\t\t\t\t\t\\\n\tvoid *cbarg;\t\t\t\t\t\t\t\\\n\tcbfn = (_cmdq_ent)->cbfn;\t\t\t\t\t\\\n\tcbarg = (_cmdq_ent)->cbarg;\t\t\t\t\t\\\n\t(_cmdq_ent)->cbfn = NULL;\t\t\t\t\t\\\n\t(_cmdq_ent)->cbarg = NULL;\t\t\t\t\t\\\n\tif (cbfn) {\t\t\t\t\t\t\t\\\n\t\tcbfn(cbarg, (_status));\t\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n}\n\nstatic void bfa_msgq_cmdq_dbell(struct bfa_msgq_cmdq *cmdq);\nstatic void bfa_msgq_cmdq_copy_rsp(struct bfa_msgq_cmdq *cmdq);\n\nenum cmdq_event {\n\tCMDQ_E_START\t\t\t= 1,\n\tCMDQ_E_STOP\t\t\t= 2,\n\tCMDQ_E_FAIL\t\t\t= 3,\n\tCMDQ_E_POST\t\t\t= 4,\n\tCMDQ_E_INIT_RESP\t\t= 5,\n\tCMDQ_E_DB_READY\t\t\t= 6,\n};\n\nbfa_fsm_state_decl(cmdq, stopped, struct bfa_msgq_cmdq, enum cmdq_event);\nbfa_fsm_state_decl(cmdq, init_wait, struct bfa_msgq_cmdq, enum cmdq_event);\nbfa_fsm_state_decl(cmdq, ready, struct bfa_msgq_cmdq, enum cmdq_event);\nbfa_fsm_state_decl(cmdq, dbell_wait, struct bfa_msgq_cmdq,\n\t\t\tenum cmdq_event);\n\nstatic void\ncmdq_sm_stopped_entry(struct bfa_msgq_cmdq *cmdq)\n{\n\tstruct bfa_msgq_cmd_entry *cmdq_ent;\n\n\tcmdq->producer_index = 0;\n\tcmdq->consumer_index = 0;\n\tcmdq->flags = 0;\n\tcmdq->token = 0;\n\tcmdq->offset = 0;\n\tcmdq->bytes_to_copy = 0;\n\twhile (!list_empty(&cmdq->pending_q)) {\n\t\tcmdq_ent = list_first_entry(&cmdq->pending_q,\n\t\t\t\t\t    struct bfa_msgq_cmd_entry, qe);\n\t\tlist_del(&cmdq_ent->qe);\n\t\tcall_cmdq_ent_cbfn(cmdq_ent, BFA_STATUS_FAILED);\n\t}\n}\n\nstatic void\ncmdq_sm_stopped(struct bfa_msgq_cmdq *cmdq, enum cmdq_event event)\n{\n\tswitch (event) {\n\tcase CMDQ_E_START:\n\t\tbfa_fsm_set_state(cmdq, cmdq_sm_init_wait);\n\t\tbreak;\n\n\tcase CMDQ_E_STOP:\n\tcase CMDQ_E_FAIL:\n\t\t \n\t\tbreak;\n\n\tcase CMDQ_E_POST:\n\t\tcmdq->flags |= BFA_MSGQ_CMDQ_F_DB_UPDATE;\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\ncmdq_sm_init_wait_entry(struct bfa_msgq_cmdq *cmdq)\n{\n\tbfa_wc_down(&cmdq->msgq->init_wc);\n}\n\nstatic void\ncmdq_sm_init_wait(struct bfa_msgq_cmdq *cmdq, enum cmdq_event event)\n{\n\tswitch (event) {\n\tcase CMDQ_E_STOP:\n\tcase CMDQ_E_FAIL:\n\t\tbfa_fsm_set_state(cmdq, cmdq_sm_stopped);\n\t\tbreak;\n\n\tcase CMDQ_E_POST:\n\t\tcmdq->flags |= BFA_MSGQ_CMDQ_F_DB_UPDATE;\n\t\tbreak;\n\n\tcase CMDQ_E_INIT_RESP:\n\t\tif (cmdq->flags & BFA_MSGQ_CMDQ_F_DB_UPDATE) {\n\t\t\tcmdq->flags &= ~BFA_MSGQ_CMDQ_F_DB_UPDATE;\n\t\t\tbfa_fsm_set_state(cmdq, cmdq_sm_dbell_wait);\n\t\t} else\n\t\t\tbfa_fsm_set_state(cmdq, cmdq_sm_ready);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\ncmdq_sm_ready_entry(struct bfa_msgq_cmdq *cmdq)\n{\n}\n\nstatic void\ncmdq_sm_ready(struct bfa_msgq_cmdq *cmdq, enum cmdq_event event)\n{\n\tswitch (event) {\n\tcase CMDQ_E_STOP:\n\tcase CMDQ_E_FAIL:\n\t\tbfa_fsm_set_state(cmdq, cmdq_sm_stopped);\n\t\tbreak;\n\n\tcase CMDQ_E_POST:\n\t\tbfa_fsm_set_state(cmdq, cmdq_sm_dbell_wait);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\ncmdq_sm_dbell_wait_entry(struct bfa_msgq_cmdq *cmdq)\n{\n\tbfa_msgq_cmdq_dbell(cmdq);\n}\n\nstatic void\ncmdq_sm_dbell_wait(struct bfa_msgq_cmdq *cmdq, enum cmdq_event event)\n{\n\tswitch (event) {\n\tcase CMDQ_E_STOP:\n\tcase CMDQ_E_FAIL:\n\t\tbfa_fsm_set_state(cmdq, cmdq_sm_stopped);\n\t\tbreak;\n\n\tcase CMDQ_E_POST:\n\t\tcmdq->flags |= BFA_MSGQ_CMDQ_F_DB_UPDATE;\n\t\tbreak;\n\n\tcase CMDQ_E_DB_READY:\n\t\tif (cmdq->flags & BFA_MSGQ_CMDQ_F_DB_UPDATE) {\n\t\t\tcmdq->flags &= ~BFA_MSGQ_CMDQ_F_DB_UPDATE;\n\t\t\tbfa_fsm_set_state(cmdq, cmdq_sm_dbell_wait);\n\t\t} else\n\t\t\tbfa_fsm_set_state(cmdq, cmdq_sm_ready);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbfa_msgq_cmdq_dbell_ready(void *arg)\n{\n\tstruct bfa_msgq_cmdq *cmdq = (struct bfa_msgq_cmdq *)arg;\n\tbfa_fsm_send_event(cmdq, CMDQ_E_DB_READY);\n}\n\nstatic void\nbfa_msgq_cmdq_dbell(struct bfa_msgq_cmdq *cmdq)\n{\n\tstruct bfi_msgq_h2i_db *dbell =\n\t\t(struct bfi_msgq_h2i_db *)(&cmdq->dbell_mb.msg[0]);\n\n\tmemset(dbell, 0, sizeof(struct bfi_msgq_h2i_db));\n\tbfi_h2i_set(dbell->mh, BFI_MC_MSGQ, BFI_MSGQ_H2I_DOORBELL_PI, 0);\n\tdbell->mh.mtag.i2htok = 0;\n\tdbell->idx.cmdq_pi = htons(cmdq->producer_index);\n\n\tif (!bfa_nw_ioc_mbox_queue(cmdq->msgq->ioc, &cmdq->dbell_mb,\n\t\t\t\tbfa_msgq_cmdq_dbell_ready, cmdq)) {\n\t\tbfa_msgq_cmdq_dbell_ready(cmdq);\n\t}\n}\n\nstatic void\n__cmd_copy(struct bfa_msgq_cmdq *cmdq, struct bfa_msgq_cmd_entry *cmd)\n{\n\tsize_t len = cmd->msg_size;\n\tsize_t to_copy;\n\tu8 *src, *dst;\n\n\tsrc = (u8 *)cmd->msg_hdr;\n\tdst = (u8 *)cmdq->addr.kva;\n\tdst += (cmdq->producer_index * BFI_MSGQ_CMD_ENTRY_SIZE);\n\n\twhile (len) {\n\t\tto_copy = (len < BFI_MSGQ_CMD_ENTRY_SIZE) ?\n\t\t\t\tlen : BFI_MSGQ_CMD_ENTRY_SIZE;\n\t\tmemcpy(dst, src, to_copy);\n\t\tlen -= to_copy;\n\t\tsrc += BFI_MSGQ_CMD_ENTRY_SIZE;\n\t\tBFA_MSGQ_INDX_ADD(cmdq->producer_index, 1, cmdq->depth);\n\t\tdst = (u8 *)cmdq->addr.kva;\n\t\tdst += (cmdq->producer_index * BFI_MSGQ_CMD_ENTRY_SIZE);\n\t}\n\n}\n\nstatic void\nbfa_msgq_cmdq_ci_update(struct bfa_msgq_cmdq *cmdq, struct bfi_mbmsg *mb)\n{\n\tstruct bfi_msgq_i2h_db *dbell = (struct bfi_msgq_i2h_db *)mb;\n\tstruct bfa_msgq_cmd_entry *cmd;\n\tint posted = 0;\n\n\tcmdq->consumer_index = ntohs(dbell->idx.cmdq_ci);\n\n\t \n\twhile (!list_empty(&cmdq->pending_q)) {\n\t\tcmd = list_first_entry(&cmdq->pending_q,\n\t\t\t\t       struct bfa_msgq_cmd_entry, qe);\n\t\tif (ntohs(cmd->msg_hdr->num_entries) <=\n\t\t\tBFA_MSGQ_FREE_CNT(cmdq)) {\n\t\t\tlist_del(&cmd->qe);\n\t\t\t__cmd_copy(cmdq, cmd);\n\t\t\tposted = 1;\n\t\t\tcall_cmdq_ent_cbfn(cmd, BFA_STATUS_OK);\n\t\t} else {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (posted)\n\t\tbfa_fsm_send_event(cmdq, CMDQ_E_POST);\n}\n\nstatic void\nbfa_msgq_cmdq_copy_next(void *arg)\n{\n\tstruct bfa_msgq_cmdq *cmdq = (struct bfa_msgq_cmdq *)arg;\n\n\tif (cmdq->bytes_to_copy)\n\t\tbfa_msgq_cmdq_copy_rsp(cmdq);\n}\n\nstatic void\nbfa_msgq_cmdq_copy_req(struct bfa_msgq_cmdq *cmdq, struct bfi_mbmsg *mb)\n{\n\tstruct bfi_msgq_i2h_cmdq_copy_req *req =\n\t\t(struct bfi_msgq_i2h_cmdq_copy_req *)mb;\n\n\tcmdq->token = 0;\n\tcmdq->offset = ntohs(req->offset);\n\tcmdq->bytes_to_copy = ntohs(req->len);\n\tbfa_msgq_cmdq_copy_rsp(cmdq);\n}\n\nstatic void\nbfa_msgq_cmdq_copy_rsp(struct bfa_msgq_cmdq *cmdq)\n{\n\tstruct bfi_msgq_h2i_cmdq_copy_rsp *rsp =\n\t\t(struct bfi_msgq_h2i_cmdq_copy_rsp *)&cmdq->copy_mb.msg[0];\n\tint copied;\n\tu8 *addr = (u8 *)cmdq->addr.kva;\n\n\tmemset(rsp, 0, sizeof(struct bfi_msgq_h2i_cmdq_copy_rsp));\n\tbfi_h2i_set(rsp->mh, BFI_MC_MSGQ, BFI_MSGQ_H2I_CMDQ_COPY_RSP, 0);\n\trsp->mh.mtag.i2htok = htons(cmdq->token);\n\tcopied = (cmdq->bytes_to_copy >= BFI_CMD_COPY_SZ) ? BFI_CMD_COPY_SZ :\n\t\tcmdq->bytes_to_copy;\n\taddr += cmdq->offset;\n\tmemcpy(rsp->data, addr, copied);\n\n\tcmdq->token++;\n\tcmdq->offset += copied;\n\tcmdq->bytes_to_copy -= copied;\n\n\tif (!bfa_nw_ioc_mbox_queue(cmdq->msgq->ioc, &cmdq->copy_mb,\n\t\t\t\tbfa_msgq_cmdq_copy_next, cmdq)) {\n\t\tbfa_msgq_cmdq_copy_next(cmdq);\n\t}\n}\n\nstatic void\nbfa_msgq_cmdq_attach(struct bfa_msgq_cmdq *cmdq, struct bfa_msgq *msgq)\n{\n\tcmdq->depth = BFA_MSGQ_CMDQ_NUM_ENTRY;\n\tINIT_LIST_HEAD(&cmdq->pending_q);\n\tcmdq->msgq = msgq;\n\tbfa_fsm_set_state(cmdq, cmdq_sm_stopped);\n}\n\nstatic void bfa_msgq_rspq_dbell(struct bfa_msgq_rspq *rspq);\n\nenum rspq_event {\n\tRSPQ_E_START\t\t\t= 1,\n\tRSPQ_E_STOP\t\t\t= 2,\n\tRSPQ_E_FAIL\t\t\t= 3,\n\tRSPQ_E_RESP\t\t\t= 4,\n\tRSPQ_E_INIT_RESP\t\t= 5,\n\tRSPQ_E_DB_READY\t\t\t= 6,\n};\n\nbfa_fsm_state_decl(rspq, stopped, struct bfa_msgq_rspq, enum rspq_event);\nbfa_fsm_state_decl(rspq, init_wait, struct bfa_msgq_rspq,\n\t\t\tenum rspq_event);\nbfa_fsm_state_decl(rspq, ready, struct bfa_msgq_rspq, enum rspq_event);\nbfa_fsm_state_decl(rspq, dbell_wait, struct bfa_msgq_rspq,\n\t\t\tenum rspq_event);\n\nstatic void\nrspq_sm_stopped_entry(struct bfa_msgq_rspq *rspq)\n{\n\trspq->producer_index = 0;\n\trspq->consumer_index = 0;\n\trspq->flags = 0;\n}\n\nstatic void\nrspq_sm_stopped(struct bfa_msgq_rspq *rspq, enum rspq_event event)\n{\n\tswitch (event) {\n\tcase RSPQ_E_START:\n\t\tbfa_fsm_set_state(rspq, rspq_sm_init_wait);\n\t\tbreak;\n\n\tcase RSPQ_E_STOP:\n\tcase RSPQ_E_FAIL:\n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nrspq_sm_init_wait_entry(struct bfa_msgq_rspq *rspq)\n{\n\tbfa_wc_down(&rspq->msgq->init_wc);\n}\n\nstatic void\nrspq_sm_init_wait(struct bfa_msgq_rspq *rspq, enum rspq_event event)\n{\n\tswitch (event) {\n\tcase RSPQ_E_FAIL:\n\tcase RSPQ_E_STOP:\n\t\tbfa_fsm_set_state(rspq, rspq_sm_stopped);\n\t\tbreak;\n\n\tcase RSPQ_E_INIT_RESP:\n\t\tbfa_fsm_set_state(rspq, rspq_sm_ready);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nrspq_sm_ready_entry(struct bfa_msgq_rspq *rspq)\n{\n}\n\nstatic void\nrspq_sm_ready(struct bfa_msgq_rspq *rspq, enum rspq_event event)\n{\n\tswitch (event) {\n\tcase RSPQ_E_STOP:\n\tcase RSPQ_E_FAIL:\n\t\tbfa_fsm_set_state(rspq, rspq_sm_stopped);\n\t\tbreak;\n\n\tcase RSPQ_E_RESP:\n\t\tbfa_fsm_set_state(rspq, rspq_sm_dbell_wait);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nrspq_sm_dbell_wait_entry(struct bfa_msgq_rspq *rspq)\n{\n\tif (!bfa_nw_ioc_is_disabled(rspq->msgq->ioc))\n\t\tbfa_msgq_rspq_dbell(rspq);\n}\n\nstatic void\nrspq_sm_dbell_wait(struct bfa_msgq_rspq *rspq, enum rspq_event event)\n{\n\tswitch (event) {\n\tcase RSPQ_E_STOP:\n\tcase RSPQ_E_FAIL:\n\t\tbfa_fsm_set_state(rspq, rspq_sm_stopped);\n\t\tbreak;\n\n\tcase RSPQ_E_RESP:\n\t\trspq->flags |= BFA_MSGQ_RSPQ_F_DB_UPDATE;\n\t\tbreak;\n\n\tcase RSPQ_E_DB_READY:\n\t\tif (rspq->flags & BFA_MSGQ_RSPQ_F_DB_UPDATE) {\n\t\t\trspq->flags &= ~BFA_MSGQ_RSPQ_F_DB_UPDATE;\n\t\t\tbfa_fsm_set_state(rspq, rspq_sm_dbell_wait);\n\t\t} else\n\t\t\tbfa_fsm_set_state(rspq, rspq_sm_ready);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbfa_msgq_rspq_dbell_ready(void *arg)\n{\n\tstruct bfa_msgq_rspq *rspq = (struct bfa_msgq_rspq *)arg;\n\tbfa_fsm_send_event(rspq, RSPQ_E_DB_READY);\n}\n\nstatic void\nbfa_msgq_rspq_dbell(struct bfa_msgq_rspq *rspq)\n{\n\tstruct bfi_msgq_h2i_db *dbell =\n\t\t(struct bfi_msgq_h2i_db *)(&rspq->dbell_mb.msg[0]);\n\n\tmemset(dbell, 0, sizeof(struct bfi_msgq_h2i_db));\n\tbfi_h2i_set(dbell->mh, BFI_MC_MSGQ, BFI_MSGQ_H2I_DOORBELL_CI, 0);\n\tdbell->mh.mtag.i2htok = 0;\n\tdbell->idx.rspq_ci = htons(rspq->consumer_index);\n\n\tif (!bfa_nw_ioc_mbox_queue(rspq->msgq->ioc, &rspq->dbell_mb,\n\t\t\t\tbfa_msgq_rspq_dbell_ready, rspq)) {\n\t\tbfa_msgq_rspq_dbell_ready(rspq);\n\t}\n}\n\nstatic void\nbfa_msgq_rspq_pi_update(struct bfa_msgq_rspq *rspq, struct bfi_mbmsg *mb)\n{\n\tstruct bfi_msgq_i2h_db *dbell = (struct bfi_msgq_i2h_db *)mb;\n\tstruct bfi_msgq_mhdr *msghdr;\n\tint num_entries;\n\tint mc;\n\tu8 *rspq_qe;\n\n\trspq->producer_index = ntohs(dbell->idx.rspq_pi);\n\n\twhile (rspq->consumer_index != rspq->producer_index) {\n\t\trspq_qe = (u8 *)rspq->addr.kva;\n\t\trspq_qe += (rspq->consumer_index * BFI_MSGQ_RSP_ENTRY_SIZE);\n\t\tmsghdr = (struct bfi_msgq_mhdr *)rspq_qe;\n\n\t\tmc = msghdr->msg_class;\n\t\tnum_entries = ntohs(msghdr->num_entries);\n\n\t\tif ((mc >= BFI_MC_MAX) || (rspq->rsphdlr[mc].cbfn == NULL))\n\t\t\tbreak;\n\n\t\t(rspq->rsphdlr[mc].cbfn)(rspq->rsphdlr[mc].cbarg, msghdr);\n\n\t\tBFA_MSGQ_INDX_ADD(rspq->consumer_index, num_entries,\n\t\t\t\trspq->depth);\n\t}\n\n\tbfa_fsm_send_event(rspq, RSPQ_E_RESP);\n}\n\nstatic void\nbfa_msgq_rspq_attach(struct bfa_msgq_rspq *rspq, struct bfa_msgq *msgq)\n{\n\trspq->depth = BFA_MSGQ_RSPQ_NUM_ENTRY;\n\trspq->msgq = msgq;\n\tbfa_fsm_set_state(rspq, rspq_sm_stopped);\n}\n\nstatic void\nbfa_msgq_init_rsp(struct bfa_msgq *msgq,\n\t\t struct bfi_mbmsg *mb)\n{\n\tbfa_fsm_send_event(&msgq->cmdq, CMDQ_E_INIT_RESP);\n\tbfa_fsm_send_event(&msgq->rspq, RSPQ_E_INIT_RESP);\n}\n\nstatic void\nbfa_msgq_init(void *arg)\n{\n\tstruct bfa_msgq *msgq = (struct bfa_msgq *)arg;\n\tstruct bfi_msgq_cfg_req *msgq_cfg =\n\t\t(struct bfi_msgq_cfg_req *)&msgq->init_mb.msg[0];\n\n\tmemset(msgq_cfg, 0, sizeof(struct bfi_msgq_cfg_req));\n\tbfi_h2i_set(msgq_cfg->mh, BFI_MC_MSGQ, BFI_MSGQ_H2I_INIT_REQ, 0);\n\tmsgq_cfg->mh.mtag.i2htok = 0;\n\n\tbfa_dma_be_addr_set(msgq_cfg->cmdq.addr, msgq->cmdq.addr.pa);\n\tmsgq_cfg->cmdq.q_depth = htons(msgq->cmdq.depth);\n\tbfa_dma_be_addr_set(msgq_cfg->rspq.addr, msgq->rspq.addr.pa);\n\tmsgq_cfg->rspq.q_depth = htons(msgq->rspq.depth);\n\n\tbfa_nw_ioc_mbox_queue(msgq->ioc, &msgq->init_mb, NULL, NULL);\n}\n\nstatic void\nbfa_msgq_isr(void *cbarg, struct bfi_mbmsg *msg)\n{\n\tstruct bfa_msgq *msgq = (struct bfa_msgq *)cbarg;\n\n\tswitch (msg->mh.msg_id) {\n\tcase BFI_MSGQ_I2H_INIT_RSP:\n\t\tbfa_msgq_init_rsp(msgq, msg);\n\t\tbreak;\n\n\tcase BFI_MSGQ_I2H_DOORBELL_PI:\n\t\tbfa_msgq_rspq_pi_update(&msgq->rspq, msg);\n\t\tbreak;\n\n\tcase BFI_MSGQ_I2H_DOORBELL_CI:\n\t\tbfa_msgq_cmdq_ci_update(&msgq->cmdq, msg);\n\t\tbreak;\n\n\tcase BFI_MSGQ_I2H_CMDQ_COPY_REQ:\n\t\tbfa_msgq_cmdq_copy_req(&msgq->cmdq, msg);\n\t\tbreak;\n\n\tdefault:\n\t\tBUG_ON(1);\n\t}\n}\n\nstatic void\nbfa_msgq_notify(void *cbarg, enum bfa_ioc_event event)\n{\n\tstruct bfa_msgq *msgq = (struct bfa_msgq *)cbarg;\n\n\tswitch (event) {\n\tcase BFA_IOC_E_ENABLED:\n\t\tbfa_wc_init(&msgq->init_wc, bfa_msgq_init, msgq);\n\t\tbfa_wc_up(&msgq->init_wc);\n\t\tbfa_fsm_send_event(&msgq->cmdq, CMDQ_E_START);\n\t\tbfa_wc_up(&msgq->init_wc);\n\t\tbfa_fsm_send_event(&msgq->rspq, RSPQ_E_START);\n\t\tbfa_wc_wait(&msgq->init_wc);\n\t\tbreak;\n\n\tcase BFA_IOC_E_DISABLED:\n\t\tbfa_fsm_send_event(&msgq->cmdq, CMDQ_E_STOP);\n\t\tbfa_fsm_send_event(&msgq->rspq, RSPQ_E_STOP);\n\t\tbreak;\n\n\tcase BFA_IOC_E_FAILED:\n\t\tbfa_fsm_send_event(&msgq->cmdq, CMDQ_E_FAIL);\n\t\tbfa_fsm_send_event(&msgq->rspq, RSPQ_E_FAIL);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n}\n\nu32\nbfa_msgq_meminfo(void)\n{\n\treturn roundup(BFA_MSGQ_CMDQ_SIZE, BFA_DMA_ALIGN_SZ) +\n\t\troundup(BFA_MSGQ_RSPQ_SIZE, BFA_DMA_ALIGN_SZ);\n}\n\nvoid\nbfa_msgq_memclaim(struct bfa_msgq *msgq, u8 *kva, u64 pa)\n{\n\tmsgq->cmdq.addr.kva = kva;\n\tmsgq->cmdq.addr.pa  = pa;\n\n\tkva += roundup(BFA_MSGQ_CMDQ_SIZE, BFA_DMA_ALIGN_SZ);\n\tpa += roundup(BFA_MSGQ_CMDQ_SIZE, BFA_DMA_ALIGN_SZ);\n\n\tmsgq->rspq.addr.kva = kva;\n\tmsgq->rspq.addr.pa = pa;\n}\n\nvoid\nbfa_msgq_attach(struct bfa_msgq *msgq, struct bfa_ioc *ioc)\n{\n\tmsgq->ioc    = ioc;\n\n\tbfa_msgq_cmdq_attach(&msgq->cmdq, msgq);\n\tbfa_msgq_rspq_attach(&msgq->rspq, msgq);\n\n\tbfa_nw_ioc_mbox_regisr(msgq->ioc, BFI_MC_MSGQ, bfa_msgq_isr, msgq);\n\tbfa_ioc_notify_init(&msgq->ioc_notify, bfa_msgq_notify, msgq);\n\tbfa_nw_ioc_notify_register(msgq->ioc, &msgq->ioc_notify);\n}\n\nvoid\nbfa_msgq_regisr(struct bfa_msgq *msgq, enum bfi_mclass mc,\n\t\tbfa_msgq_mcfunc_t cbfn, void *cbarg)\n{\n\tmsgq->rspq.rsphdlr[mc].cbfn\t= cbfn;\n\tmsgq->rspq.rsphdlr[mc].cbarg\t= cbarg;\n}\n\nvoid\nbfa_msgq_cmd_post(struct bfa_msgq *msgq,  struct bfa_msgq_cmd_entry *cmd)\n{\n\tif (ntohs(cmd->msg_hdr->num_entries) <=\n\t\tBFA_MSGQ_FREE_CNT(&msgq->cmdq)) {\n\t\t__cmd_copy(&msgq->cmdq, cmd);\n\t\tcall_cmdq_ent_cbfn(cmd, BFA_STATUS_OK);\n\t\tbfa_fsm_send_event(&msgq->cmdq, CMDQ_E_POST);\n\t} else {\n\t\tlist_add_tail(&cmd->qe, &msgq->cmdq.pending_q);\n\t}\n}\n\nvoid\nbfa_msgq_rsp_copy(struct bfa_msgq *msgq, u8 *buf, size_t buf_len)\n{\n\tstruct bfa_msgq_rspq *rspq = &msgq->rspq;\n\tsize_t len = buf_len;\n\tsize_t to_copy;\n\tint ci;\n\tu8 *src, *dst;\n\n\tci = rspq->consumer_index;\n\tsrc = (u8 *)rspq->addr.kva;\n\tsrc += (ci * BFI_MSGQ_RSP_ENTRY_SIZE);\n\tdst = buf;\n\n\twhile (len) {\n\t\tto_copy = (len < BFI_MSGQ_RSP_ENTRY_SIZE) ?\n\t\t\t\tlen : BFI_MSGQ_RSP_ENTRY_SIZE;\n\t\tmemcpy(dst, src, to_copy);\n\t\tlen -= to_copy;\n\t\tdst += BFI_MSGQ_RSP_ENTRY_SIZE;\n\t\tBFA_MSGQ_INDX_ADD(ci, 1, rspq->depth);\n\t\tsrc = (u8 *)rspq->addr.kva;\n\t\tsrc += (ci * BFI_MSGQ_RSP_ENTRY_SIZE);\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}