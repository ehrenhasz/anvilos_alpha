{
  "module_name": "bna_enet.c",
  "hash_id": "95fd2a9d4397941b7e883ad533bfc0c37455dea7e7a136f85c32e2f6d7019a6c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/brocade/bna/bna_enet.c",
  "human_readable_source": "\n \n \n#include \"bna.h\"\n\nstatic inline int\nethport_can_be_up(struct bna_ethport *ethport)\n{\n\tint ready = 0;\n\tif (ethport->bna->enet.type == BNA_ENET_T_REGULAR)\n\t\tready = ((ethport->flags & BNA_ETHPORT_F_ADMIN_UP) &&\n\t\t\t (ethport->flags & BNA_ETHPORT_F_RX_STARTED) &&\n\t\t\t (ethport->flags & BNA_ETHPORT_F_PORT_ENABLED));\n\telse\n\t\tready = ((ethport->flags & BNA_ETHPORT_F_ADMIN_UP) &&\n\t\t\t (ethport->flags & BNA_ETHPORT_F_RX_STARTED) &&\n\t\t\t !(ethport->flags & BNA_ETHPORT_F_PORT_ENABLED));\n\treturn ready;\n}\n\n#define ethport_is_up ethport_can_be_up\n\nenum bna_ethport_event {\n\tETHPORT_E_START\t\t\t= 1,\n\tETHPORT_E_STOP\t\t\t= 2,\n\tETHPORT_E_FAIL\t\t\t= 3,\n\tETHPORT_E_UP\t\t\t= 4,\n\tETHPORT_E_DOWN\t\t\t= 5,\n\tETHPORT_E_FWRESP_UP_OK\t\t= 6,\n\tETHPORT_E_FWRESP_DOWN\t\t= 7,\n\tETHPORT_E_FWRESP_UP_FAIL\t= 8,\n};\n\nenum bna_enet_event {\n\tENET_E_START\t\t\t= 1,\n\tENET_E_STOP\t\t\t= 2,\n\tENET_E_FAIL\t\t\t= 3,\n\tENET_E_PAUSE_CFG\t\t= 4,\n\tENET_E_MTU_CFG\t\t\t= 5,\n\tENET_E_FWRESP_PAUSE\t\t= 6,\n\tENET_E_CHLD_STOPPED\t\t= 7,\n};\n\nenum bna_ioceth_event {\n\tIOCETH_E_ENABLE\t\t\t= 1,\n\tIOCETH_E_DISABLE\t\t= 2,\n\tIOCETH_E_IOC_RESET\t\t= 3,\n\tIOCETH_E_IOC_FAILED\t\t= 4,\n\tIOCETH_E_IOC_READY\t\t= 5,\n\tIOCETH_E_ENET_ATTR_RESP\t\t= 6,\n\tIOCETH_E_ENET_STOPPED\t\t= 7,\n\tIOCETH_E_IOC_DISABLED\t\t= 8,\n};\n\n#define bna_stats_copy(_name, _type)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tcount = sizeof(struct bfi_enet_stats_ ## _type) / sizeof(u64);\t\\\n\tstats_src = (u64 *)&bna->stats.hw_stats_kva->_name ## _stats;\t\\\n\tstats_dst = (u64 *)&bna->stats.hw_stats._name ## _stats;\t\\\n\tfor (i = 0; i < count; i++)\t\t\t\t\t\\\n\t\tstats_dst[i] = be64_to_cpu(stats_src[i]);\t\t\\\n} while (0)\t\t\t\t\t\t\t\t\\\n\n \n\nstatic void\nbna_bfi_ethport_enable_aen(struct bna_ethport *ethport,\n\t\t\t\tstruct bfi_msgq_mhdr *msghdr)\n{\n\tethport->flags |= BNA_ETHPORT_F_PORT_ENABLED;\n\n\tif (ethport_can_be_up(ethport))\n\t\tbfa_fsm_send_event(ethport, ETHPORT_E_UP);\n}\n\nstatic void\nbna_bfi_ethport_disable_aen(struct bna_ethport *ethport,\n\t\t\t\tstruct bfi_msgq_mhdr *msghdr)\n{\n\tint ethport_up = ethport_is_up(ethport);\n\n\tethport->flags &= ~BNA_ETHPORT_F_PORT_ENABLED;\n\n\tif (ethport_up)\n\t\tbfa_fsm_send_event(ethport, ETHPORT_E_DOWN);\n}\n\nstatic void\nbna_bfi_ethport_admin_rsp(struct bna_ethport *ethport,\n\t\t\t\tstruct bfi_msgq_mhdr *msghdr)\n{\n\tstruct bfi_enet_enable_req *admin_req =\n\t\t&ethport->bfi_enet_cmd.admin_req;\n\tstruct bfi_enet_rsp *rsp =\n\t\tcontainer_of(msghdr, struct bfi_enet_rsp, mh);\n\n\tswitch (admin_req->enable) {\n\tcase BNA_STATUS_T_ENABLED:\n\t\tif (rsp->error == BFI_ENET_CMD_OK)\n\t\t\tbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_UP_OK);\n\t\telse {\n\t\t\tethport->flags &= ~BNA_ETHPORT_F_PORT_ENABLED;\n\t\t\tbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_UP_FAIL);\n\t\t}\n\t\tbreak;\n\n\tcase BNA_STATUS_T_DISABLED:\n\t\tbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_DOWN);\n\t\tethport->link_status = BNA_LINK_DOWN;\n\t\tethport->link_cbfn(ethport->bna->bnad, BNA_LINK_DOWN);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbna_bfi_ethport_lpbk_rsp(struct bna_ethport *ethport,\n\t\t\t\tstruct bfi_msgq_mhdr *msghdr)\n{\n\tstruct bfi_enet_diag_lb_req *diag_lb_req =\n\t\t&ethport->bfi_enet_cmd.lpbk_req;\n\tstruct bfi_enet_rsp *rsp =\n\t\tcontainer_of(msghdr, struct bfi_enet_rsp, mh);\n\n\tswitch (diag_lb_req->enable) {\n\tcase BNA_STATUS_T_ENABLED:\n\t\tif (rsp->error == BFI_ENET_CMD_OK)\n\t\t\tbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_UP_OK);\n\t\telse {\n\t\t\tethport->flags &= ~BNA_ETHPORT_F_ADMIN_UP;\n\t\t\tbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_UP_FAIL);\n\t\t}\n\t\tbreak;\n\n\tcase BNA_STATUS_T_DISABLED:\n\t\tbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_DOWN);\n\t\tbreak;\n\t}\n}\n\nstatic void\nbna_bfi_pause_set_rsp(struct bna_enet *enet, struct bfi_msgq_mhdr *msghdr)\n{\n\tbfa_fsm_send_event(enet, ENET_E_FWRESP_PAUSE);\n}\n\nstatic void\nbna_bfi_attr_get_rsp(struct bna_ioceth *ioceth,\n\t\t\tstruct bfi_msgq_mhdr *msghdr)\n{\n\tstruct bfi_enet_attr_rsp *rsp =\n\t\tcontainer_of(msghdr, struct bfi_enet_attr_rsp, mh);\n\n\t \n\tif (!ioceth->attr.fw_query_complete) {\n\t\tioceth->attr.num_txq = ntohl(rsp->max_cfg);\n\t\tioceth->attr.num_rxp = ntohl(rsp->max_cfg);\n\t\tioceth->attr.num_ucmac = ntohl(rsp->max_ucmac);\n\t\tioceth->attr.num_mcmac = BFI_ENET_MAX_MCAM;\n\t\tioceth->attr.max_rit_size = ntohl(rsp->rit_size);\n\t\tioceth->attr.fw_query_complete = true;\n\t}\n\n\tbfa_fsm_send_event(ioceth, IOCETH_E_ENET_ATTR_RESP);\n}\n\nstatic void\nbna_bfi_stats_get_rsp(struct bna *bna, struct bfi_msgq_mhdr *msghdr)\n{\n\tstruct bfi_enet_stats_req *stats_req = &bna->stats_mod.stats_get;\n\tu64 *stats_src;\n\tu64 *stats_dst;\n\tu32 tx_enet_mask = ntohl(stats_req->tx_enet_mask);\n\tu32 rx_enet_mask = ntohl(stats_req->rx_enet_mask);\n\tint count;\n\tint i;\n\n\tbna_stats_copy(mac, mac);\n\tbna_stats_copy(bpc, bpc);\n\tbna_stats_copy(rad, rad);\n\tbna_stats_copy(rlb, rad);\n\tbna_stats_copy(fc_rx, fc_rx);\n\tbna_stats_copy(fc_tx, fc_tx);\n\n\tstats_src = (u64 *)&(bna->stats.hw_stats_kva->rxf_stats[0]);\n\n\t \n\tfor (i = 0; i < BFI_ENET_CFG_MAX; i++) {\n\t\tstats_dst = (u64 *)&(bna->stats.hw_stats.rxf_stats[i]);\n\t\tmemset(stats_dst, 0, sizeof(struct bfi_enet_stats_rxf));\n\t\tif (rx_enet_mask & BIT(i)) {\n\t\t\tint k;\n\t\t\tcount = sizeof(struct bfi_enet_stats_rxf) /\n\t\t\t\tsizeof(u64);\n\t\t\tfor (k = 0; k < count; k++) {\n\t\t\t\tstats_dst[k] = be64_to_cpu(*stats_src);\n\t\t\t\tstats_src++;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tfor (i = 0; i < BFI_ENET_CFG_MAX; i++) {\n\t\tstats_dst = (u64 *)&(bna->stats.hw_stats.txf_stats[i]);\n\t\tmemset(stats_dst, 0, sizeof(struct bfi_enet_stats_txf));\n\t\tif (tx_enet_mask & BIT(i)) {\n\t\t\tint k;\n\t\t\tcount = sizeof(struct bfi_enet_stats_txf) /\n\t\t\t\tsizeof(u64);\n\t\t\tfor (k = 0; k < count; k++) {\n\t\t\t\tstats_dst[k] = be64_to_cpu(*stats_src);\n\t\t\t\tstats_src++;\n\t\t\t}\n\t\t}\n\t}\n\n\tbna->stats_mod.stats_get_busy = false;\n\tbnad_cb_stats_get(bna->bnad, BNA_CB_SUCCESS, &bna->stats);\n}\n\nstatic void\nbna_bfi_ethport_linkup_aen(struct bna_ethport *ethport,\n\t\t\tstruct bfi_msgq_mhdr *msghdr)\n{\n\tethport->link_status = BNA_LINK_UP;\n\n\t \n\tethport->link_cbfn(ethport->bna->bnad, ethport->link_status);\n}\n\nstatic void\nbna_bfi_ethport_linkdown_aen(struct bna_ethport *ethport,\n\t\t\t\tstruct bfi_msgq_mhdr *msghdr)\n{\n\tethport->link_status = BNA_LINK_DOWN;\n\n\t \n\tethport->link_cbfn(ethport->bna->bnad, BNA_LINK_DOWN);\n}\n\nstatic void\nbna_err_handler(struct bna *bna, u32 intr_status)\n{\n\tif (BNA_IS_HALT_INTR(bna, intr_status))\n\t\tbna_halt_clear(bna);\n\n\tbfa_nw_ioc_error_isr(&bna->ioceth.ioc);\n}\n\nvoid\nbna_mbox_handler(struct bna *bna, u32 intr_status)\n{\n\tif (BNA_IS_ERR_INTR(bna, intr_status)) {\n\t\tbna_err_handler(bna, intr_status);\n\t\treturn;\n\t}\n\tif (BNA_IS_MBOX_INTR(bna, intr_status))\n\t\tbfa_nw_ioc_mbox_isr(&bna->ioceth.ioc);\n}\n\nstatic void\nbna_msgq_rsp_handler(void *arg, struct bfi_msgq_mhdr *msghdr)\n{\n\tstruct bna *bna = (struct bna *)arg;\n\tstruct bna_tx *tx;\n\tstruct bna_rx *rx;\n\n\tswitch (msghdr->msg_id) {\n\tcase BFI_ENET_I2H_RX_CFG_SET_RSP:\n\t\tbna_rx_from_rid(bna, msghdr->enet_id, rx);\n\t\tif (rx)\n\t\t\tbna_bfi_rx_enet_start_rsp(rx, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_RX_CFG_CLR_RSP:\n\t\tbna_rx_from_rid(bna, msghdr->enet_id, rx);\n\t\tif (rx)\n\t\t\tbna_bfi_rx_enet_stop_rsp(rx, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_RIT_CFG_RSP:\n\tcase BFI_ENET_I2H_RSS_CFG_RSP:\n\tcase BFI_ENET_I2H_RSS_ENABLE_RSP:\n\tcase BFI_ENET_I2H_RX_PROMISCUOUS_RSP:\n\tcase BFI_ENET_I2H_RX_DEFAULT_RSP:\n\tcase BFI_ENET_I2H_MAC_UCAST_CLR_RSP:\n\tcase BFI_ENET_I2H_MAC_UCAST_ADD_RSP:\n\tcase BFI_ENET_I2H_MAC_UCAST_DEL_RSP:\n\tcase BFI_ENET_I2H_MAC_MCAST_DEL_RSP:\n\tcase BFI_ENET_I2H_MAC_MCAST_FILTER_RSP:\n\tcase BFI_ENET_I2H_RX_VLAN_SET_RSP:\n\tcase BFI_ENET_I2H_RX_VLAN_STRIP_ENABLE_RSP:\n\t\tbna_rx_from_rid(bna, msghdr->enet_id, rx);\n\t\tif (rx)\n\t\t\tbna_bfi_rxf_cfg_rsp(&rx->rxf, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_MAC_UCAST_SET_RSP:\n\t\tbna_rx_from_rid(bna, msghdr->enet_id, rx);\n\t\tif (rx)\n\t\t\tbna_bfi_rxf_ucast_set_rsp(&rx->rxf, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_MAC_MCAST_ADD_RSP:\n\t\tbna_rx_from_rid(bna, msghdr->enet_id, rx);\n\t\tif (rx)\n\t\t\tbna_bfi_rxf_mcast_add_rsp(&rx->rxf, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_TX_CFG_SET_RSP:\n\t\tbna_tx_from_rid(bna, msghdr->enet_id, tx);\n\t\tif (tx)\n\t\t\tbna_bfi_tx_enet_start_rsp(tx, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_TX_CFG_CLR_RSP:\n\t\tbna_tx_from_rid(bna, msghdr->enet_id, tx);\n\t\tif (tx)\n\t\t\tbna_bfi_tx_enet_stop_rsp(tx, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_PORT_ADMIN_RSP:\n\t\tbna_bfi_ethport_admin_rsp(&bna->ethport, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_DIAG_LOOPBACK_RSP:\n\t\tbna_bfi_ethport_lpbk_rsp(&bna->ethport, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_SET_PAUSE_RSP:\n\t\tbna_bfi_pause_set_rsp(&bna->enet, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_GET_ATTR_RSP:\n\t\tbna_bfi_attr_get_rsp(&bna->ioceth, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_STATS_GET_RSP:\n\t\tbna_bfi_stats_get_rsp(bna, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_STATS_CLR_RSP:\n\t\t \n\t\tbreak;\n\n\tcase BFI_ENET_I2H_LINK_UP_AEN:\n\t\tbna_bfi_ethport_linkup_aen(&bna->ethport, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_LINK_DOWN_AEN:\n\t\tbna_bfi_ethport_linkdown_aen(&bna->ethport, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_PORT_ENABLE_AEN:\n\t\tbna_bfi_ethport_enable_aen(&bna->ethport, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_PORT_DISABLE_AEN:\n\t\tbna_bfi_ethport_disable_aen(&bna->ethport, msghdr);\n\t\tbreak;\n\n\tcase BFI_ENET_I2H_BW_UPDATE_AEN:\n\t\tbna_bfi_bw_update_aen(&bna->tx_mod);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n}\n\n \n\n#define call_ethport_stop_cbfn(_ethport)\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tif ((_ethport)->stop_cbfn) {\t\t\t\t\t\\\n\t\tvoid (*cbfn)(struct bna_enet *);\t\t\t\\\n\t\tcbfn = (_ethport)->stop_cbfn;\t\t\t\t\\\n\t\t(_ethport)->stop_cbfn = NULL;\t\t\t\t\\\n\t\tcbfn(&(_ethport)->bna->enet);\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n} while (0)\n\n#define call_ethport_adminup_cbfn(ethport, status)\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tif ((ethport)->adminup_cbfn) {\t\t\t\t\t\\\n\t\tvoid (*cbfn)(struct bnad *, enum bna_cb_status);\t\\\n\t\tcbfn = (ethport)->adminup_cbfn;\t\t\t\t\\\n\t\t(ethport)->adminup_cbfn = NULL;\t\t\t\t\\\n\t\tcbfn((ethport)->bna->bnad, status);\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n} while (0)\n\nstatic void\nbna_bfi_ethport_admin_up(struct bna_ethport *ethport)\n{\n\tstruct bfi_enet_enable_req *admin_up_req =\n\t\t&ethport->bfi_enet_cmd.admin_req;\n\n\tbfi_msgq_mhdr_set(admin_up_req->mh, BFI_MC_ENET,\n\t\tBFI_ENET_H2I_PORT_ADMIN_UP_REQ, 0, 0);\n\tadmin_up_req->mh.num_entries = htons(\n\t\tbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_enable_req)));\n\tadmin_up_req->enable = BNA_STATUS_T_ENABLED;\n\n\tbfa_msgq_cmd_set(&ethport->msgq_cmd, NULL, NULL,\n\t\tsizeof(struct bfi_enet_enable_req), &admin_up_req->mh);\n\tbfa_msgq_cmd_post(&ethport->bna->msgq, &ethport->msgq_cmd);\n}\n\nstatic void\nbna_bfi_ethport_admin_down(struct bna_ethport *ethport)\n{\n\tstruct bfi_enet_enable_req *admin_down_req =\n\t\t&ethport->bfi_enet_cmd.admin_req;\n\n\tbfi_msgq_mhdr_set(admin_down_req->mh, BFI_MC_ENET,\n\t\tBFI_ENET_H2I_PORT_ADMIN_UP_REQ, 0, 0);\n\tadmin_down_req->mh.num_entries = htons(\n\t\tbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_enable_req)));\n\tadmin_down_req->enable = BNA_STATUS_T_DISABLED;\n\n\tbfa_msgq_cmd_set(&ethport->msgq_cmd, NULL, NULL,\n\t\tsizeof(struct bfi_enet_enable_req), &admin_down_req->mh);\n\tbfa_msgq_cmd_post(&ethport->bna->msgq, &ethport->msgq_cmd);\n}\n\nstatic void\nbna_bfi_ethport_lpbk_up(struct bna_ethport *ethport)\n{\n\tstruct bfi_enet_diag_lb_req *lpbk_up_req =\n\t\t&ethport->bfi_enet_cmd.lpbk_req;\n\n\tbfi_msgq_mhdr_set(lpbk_up_req->mh, BFI_MC_ENET,\n\t\tBFI_ENET_H2I_DIAG_LOOPBACK_REQ, 0, 0);\n\tlpbk_up_req->mh.num_entries = htons(\n\t\tbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_diag_lb_req)));\n\tlpbk_up_req->mode = (ethport->bna->enet.type ==\n\t\t\t\tBNA_ENET_T_LOOPBACK_INTERNAL) ?\n\t\t\t\tBFI_ENET_DIAG_LB_OPMODE_EXT :\n\t\t\t\tBFI_ENET_DIAG_LB_OPMODE_CBL;\n\tlpbk_up_req->enable = BNA_STATUS_T_ENABLED;\n\n\tbfa_msgq_cmd_set(&ethport->msgq_cmd, NULL, NULL,\n\t\tsizeof(struct bfi_enet_diag_lb_req), &lpbk_up_req->mh);\n\tbfa_msgq_cmd_post(&ethport->bna->msgq, &ethport->msgq_cmd);\n}\n\nstatic void\nbna_bfi_ethport_lpbk_down(struct bna_ethport *ethport)\n{\n\tstruct bfi_enet_diag_lb_req *lpbk_down_req =\n\t\t&ethport->bfi_enet_cmd.lpbk_req;\n\n\tbfi_msgq_mhdr_set(lpbk_down_req->mh, BFI_MC_ENET,\n\t\tBFI_ENET_H2I_DIAG_LOOPBACK_REQ, 0, 0);\n\tlpbk_down_req->mh.num_entries = htons(\n\t\tbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_diag_lb_req)));\n\tlpbk_down_req->enable = BNA_STATUS_T_DISABLED;\n\n\tbfa_msgq_cmd_set(&ethport->msgq_cmd, NULL, NULL,\n\t\tsizeof(struct bfi_enet_diag_lb_req), &lpbk_down_req->mh);\n\tbfa_msgq_cmd_post(&ethport->bna->msgq, &ethport->msgq_cmd);\n}\n\nstatic void\nbna_bfi_ethport_up(struct bna_ethport *ethport)\n{\n\tif (ethport->bna->enet.type == BNA_ENET_T_REGULAR)\n\t\tbna_bfi_ethport_admin_up(ethport);\n\telse\n\t\tbna_bfi_ethport_lpbk_up(ethport);\n}\n\nstatic void\nbna_bfi_ethport_down(struct bna_ethport *ethport)\n{\n\tif (ethport->bna->enet.type == BNA_ENET_T_REGULAR)\n\t\tbna_bfi_ethport_admin_down(ethport);\n\telse\n\t\tbna_bfi_ethport_lpbk_down(ethport);\n}\n\nbfa_fsm_state_decl(bna_ethport, stopped, struct bna_ethport,\n\t\t\tenum bna_ethport_event);\nbfa_fsm_state_decl(bna_ethport, down, struct bna_ethport,\n\t\t\tenum bna_ethport_event);\nbfa_fsm_state_decl(bna_ethport, up_resp_wait, struct bna_ethport,\n\t\t\tenum bna_ethport_event);\nbfa_fsm_state_decl(bna_ethport, down_resp_wait, struct bna_ethport,\n\t\t\tenum bna_ethport_event);\nbfa_fsm_state_decl(bna_ethport, up, struct bna_ethport,\n\t\t\tenum bna_ethport_event);\nbfa_fsm_state_decl(bna_ethport, last_resp_wait, struct bna_ethport,\n\t\t\tenum bna_ethport_event);\n\nstatic void\nbna_ethport_sm_stopped_entry(struct bna_ethport *ethport)\n{\n\tcall_ethport_stop_cbfn(ethport);\n}\n\nstatic void\nbna_ethport_sm_stopped(struct bna_ethport *ethport,\n\t\t\tenum bna_ethport_event event)\n{\n\tswitch (event) {\n\tcase ETHPORT_E_START:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_down);\n\t\tbreak;\n\n\tcase ETHPORT_E_STOP:\n\t\tcall_ethport_stop_cbfn(ethport);\n\t\tbreak;\n\n\tcase ETHPORT_E_FAIL:\n\t\t \n\t\tbreak;\n\n\tcase ETHPORT_E_DOWN:\n\t\t \n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ethport_sm_down_entry(struct bna_ethport *ethport)\n{\n}\n\nstatic void\nbna_ethport_sm_down(struct bna_ethport *ethport,\n\t\t\tenum bna_ethport_event event)\n{\n\tswitch (event) {\n\tcase ETHPORT_E_STOP:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\n\t\tbreak;\n\n\tcase ETHPORT_E_FAIL:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\n\t\tbreak;\n\n\tcase ETHPORT_E_UP:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_up_resp_wait);\n\t\tbna_bfi_ethport_up(ethport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ethport_sm_up_resp_wait_entry(struct bna_ethport *ethport)\n{\n}\n\nstatic void\nbna_ethport_sm_up_resp_wait(struct bna_ethport *ethport,\n\t\t\tenum bna_ethport_event event)\n{\n\tswitch (event) {\n\tcase ETHPORT_E_STOP:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_last_resp_wait);\n\t\tbreak;\n\n\tcase ETHPORT_E_FAIL:\n\t\tcall_ethport_adminup_cbfn(ethport, BNA_CB_FAIL);\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\n\t\tbreak;\n\n\tcase ETHPORT_E_DOWN:\n\t\tcall_ethport_adminup_cbfn(ethport, BNA_CB_INTERRUPT);\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_down_resp_wait);\n\t\tbreak;\n\n\tcase ETHPORT_E_FWRESP_UP_OK:\n\t\tcall_ethport_adminup_cbfn(ethport, BNA_CB_SUCCESS);\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_up);\n\t\tbreak;\n\n\tcase ETHPORT_E_FWRESP_UP_FAIL:\n\t\tcall_ethport_adminup_cbfn(ethport, BNA_CB_FAIL);\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_down);\n\t\tbreak;\n\n\tcase ETHPORT_E_FWRESP_DOWN:\n\t\t \n\t\tbna_bfi_ethport_up(ethport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ethport_sm_down_resp_wait_entry(struct bna_ethport *ethport)\n{\n\t \n}\n\nstatic void\nbna_ethport_sm_down_resp_wait(struct bna_ethport *ethport,\n\t\t\tenum bna_ethport_event event)\n{\n\tswitch (event) {\n\tcase ETHPORT_E_STOP:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_last_resp_wait);\n\t\tbreak;\n\n\tcase ETHPORT_E_FAIL:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\n\t\tbreak;\n\n\tcase ETHPORT_E_UP:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_up_resp_wait);\n\t\tbreak;\n\n\tcase ETHPORT_E_FWRESP_UP_OK:\n\t\t \n\t\tbna_bfi_ethport_down(ethport);\n\t\tbreak;\n\n\tcase ETHPORT_E_FWRESP_UP_FAIL:\n\tcase ETHPORT_E_FWRESP_DOWN:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_down);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ethport_sm_up_entry(struct bna_ethport *ethport)\n{\n}\n\nstatic void\nbna_ethport_sm_up(struct bna_ethport *ethport,\n\t\t\tenum bna_ethport_event event)\n{\n\tswitch (event) {\n\tcase ETHPORT_E_STOP:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_last_resp_wait);\n\t\tbna_bfi_ethport_down(ethport);\n\t\tbreak;\n\n\tcase ETHPORT_E_FAIL:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\n\t\tbreak;\n\n\tcase ETHPORT_E_DOWN:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_down_resp_wait);\n\t\tbna_bfi_ethport_down(ethport);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ethport_sm_last_resp_wait_entry(struct bna_ethport *ethport)\n{\n}\n\nstatic void\nbna_ethport_sm_last_resp_wait(struct bna_ethport *ethport,\n\t\t\tenum bna_ethport_event event)\n{\n\tswitch (event) {\n\tcase ETHPORT_E_FAIL:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\n\t\tbreak;\n\n\tcase ETHPORT_E_DOWN:\n\t\t \n\t\t \n\t\tbreak;\n\n\tcase ETHPORT_E_FWRESP_UP_OK:\n\t\t \n\t\tbna_bfi_ethport_down(ethport);\n\t\tbreak;\n\n\tcase ETHPORT_E_FWRESP_UP_FAIL:\n\tcase ETHPORT_E_FWRESP_DOWN:\n\t\tbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ethport_init(struct bna_ethport *ethport, struct bna *bna)\n{\n\tethport->flags |= (BNA_ETHPORT_F_ADMIN_UP | BNA_ETHPORT_F_PORT_ENABLED);\n\tethport->bna = bna;\n\n\tethport->link_status = BNA_LINK_DOWN;\n\tethport->link_cbfn = bnad_cb_ethport_link_status;\n\n\tethport->rx_started_count = 0;\n\n\tethport->stop_cbfn = NULL;\n\tethport->adminup_cbfn = NULL;\n\n\tbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\n}\n\nstatic void\nbna_ethport_uninit(struct bna_ethport *ethport)\n{\n\tethport->flags &= ~BNA_ETHPORT_F_ADMIN_UP;\n\tethport->flags &= ~BNA_ETHPORT_F_PORT_ENABLED;\n\n\tethport->bna = NULL;\n}\n\nstatic void\nbna_ethport_start(struct bna_ethport *ethport)\n{\n\tbfa_fsm_send_event(ethport, ETHPORT_E_START);\n}\n\nstatic void\nbna_enet_cb_ethport_stopped(struct bna_enet *enet)\n{\n\tbfa_wc_down(&enet->chld_stop_wc);\n}\n\nstatic void\nbna_ethport_stop(struct bna_ethport *ethport)\n{\n\tethport->stop_cbfn = bna_enet_cb_ethport_stopped;\n\tbfa_fsm_send_event(ethport, ETHPORT_E_STOP);\n}\n\nstatic void\nbna_ethport_fail(struct bna_ethport *ethport)\n{\n\t \n\tethport->flags |= BNA_ETHPORT_F_PORT_ENABLED;\n\n\tif (ethport->link_status != BNA_LINK_DOWN) {\n\t\tethport->link_status = BNA_LINK_DOWN;\n\t\tethport->link_cbfn(ethport->bna->bnad, BNA_LINK_DOWN);\n\t}\n\tbfa_fsm_send_event(ethport, ETHPORT_E_FAIL);\n}\n\n \nvoid\nbna_ethport_cb_rx_started(struct bna_ethport *ethport)\n{\n\tethport->rx_started_count++;\n\n\tif (ethport->rx_started_count == 1) {\n\t\tethport->flags |= BNA_ETHPORT_F_RX_STARTED;\n\n\t\tif (ethport_can_be_up(ethport))\n\t\t\tbfa_fsm_send_event(ethport, ETHPORT_E_UP);\n\t}\n}\n\nvoid\nbna_ethport_cb_rx_stopped(struct bna_ethport *ethport)\n{\n\tint ethport_up = ethport_is_up(ethport);\n\n\tethport->rx_started_count--;\n\n\tif (ethport->rx_started_count == 0) {\n\t\tethport->flags &= ~BNA_ETHPORT_F_RX_STARTED;\n\n\t\tif (ethport_up)\n\t\t\tbfa_fsm_send_event(ethport, ETHPORT_E_DOWN);\n\t}\n}\n\n \n\n#define bna_enet_chld_start(enet)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tenum bna_tx_type tx_type =\t\t\t\t\t\\\n\t\t((enet)->type == BNA_ENET_T_REGULAR) ?\t\t\t\\\n\t\tBNA_TX_T_REGULAR : BNA_TX_T_LOOPBACK;\t\t\t\\\n\tenum bna_rx_type rx_type =\t\t\t\t\t\\\n\t\t((enet)->type == BNA_ENET_T_REGULAR) ?\t\t\t\\\n\t\tBNA_RX_T_REGULAR : BNA_RX_T_LOOPBACK;\t\t\t\\\n\tbna_ethport_start(&(enet)->bna->ethport);\t\t\t\\\n\tbna_tx_mod_start(&(enet)->bna->tx_mod, tx_type);\t\t\\\n\tbna_rx_mod_start(&(enet)->bna->rx_mod, rx_type);\t\t\\\n} while (0)\n\n#define bna_enet_chld_stop(enet)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tenum bna_tx_type tx_type =\t\t\t\t\t\\\n\t\t((enet)->type == BNA_ENET_T_REGULAR) ?\t\t\t\\\n\t\tBNA_TX_T_REGULAR : BNA_TX_T_LOOPBACK;\t\t\t\\\n\tenum bna_rx_type rx_type =\t\t\t\t\t\\\n\t\t((enet)->type == BNA_ENET_T_REGULAR) ?\t\t\t\\\n\t\tBNA_RX_T_REGULAR : BNA_RX_T_LOOPBACK;\t\t\t\\\n\tbfa_wc_init(&(enet)->chld_stop_wc, bna_enet_cb_chld_stopped, (enet));\\\n\tbfa_wc_up(&(enet)->chld_stop_wc);\t\t\t\t\\\n\tbna_ethport_stop(&(enet)->bna->ethport);\t\t\t\\\n\tbfa_wc_up(&(enet)->chld_stop_wc);\t\t\t\t\\\n\tbna_tx_mod_stop(&(enet)->bna->tx_mod, tx_type);\t\t\t\\\n\tbfa_wc_up(&(enet)->chld_stop_wc);\t\t\t\t\\\n\tbna_rx_mod_stop(&(enet)->bna->rx_mod, rx_type);\t\t\t\\\n\tbfa_wc_wait(&(enet)->chld_stop_wc);\t\t\t\t\\\n} while (0)\n\n#define bna_enet_chld_fail(enet)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tbna_ethport_fail(&(enet)->bna->ethport);\t\t\t\\\n\tbna_tx_mod_fail(&(enet)->bna->tx_mod);\t\t\t\t\\\n\tbna_rx_mod_fail(&(enet)->bna->rx_mod);\t\t\t\t\\\n} while (0)\n\n#define bna_enet_rx_start(enet)\t\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tenum bna_rx_type rx_type =\t\t\t\t\t\\\n\t\t((enet)->type == BNA_ENET_T_REGULAR) ?\t\t\t\\\n\t\tBNA_RX_T_REGULAR : BNA_RX_T_LOOPBACK;\t\t\t\\\n\tbna_rx_mod_start(&(enet)->bna->rx_mod, rx_type);\t\t\\\n} while (0)\n\n#define bna_enet_rx_stop(enet)\t\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tenum bna_rx_type rx_type =\t\t\t\t\t\\\n\t\t((enet)->type == BNA_ENET_T_REGULAR) ?\t\t\t\\\n\t\tBNA_RX_T_REGULAR : BNA_RX_T_LOOPBACK;\t\t\t\\\n\tbfa_wc_init(&(enet)->chld_stop_wc, bna_enet_cb_chld_stopped, (enet));\\\n\tbfa_wc_up(&(enet)->chld_stop_wc);\t\t\t\t\\\n\tbna_rx_mod_stop(&(enet)->bna->rx_mod, rx_type);\t\t\t\\\n\tbfa_wc_wait(&(enet)->chld_stop_wc);\t\t\t\t\\\n} while (0)\n\n#define call_enet_stop_cbfn(enet)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tif ((enet)->stop_cbfn) {\t\t\t\t\t\\\n\t\tvoid (*cbfn)(void *);\t\t\t\t\t\\\n\t\tvoid *cbarg;\t\t\t\t\t\t\\\n\t\tcbfn = (enet)->stop_cbfn;\t\t\t\t\\\n\t\tcbarg = (enet)->stop_cbarg;\t\t\t\t\\\n\t\t(enet)->stop_cbfn = NULL;\t\t\t\t\\\n\t\t(enet)->stop_cbarg = NULL;\t\t\t\t\\\n\t\tcbfn(cbarg);\t\t\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n} while (0)\n\n#define call_enet_mtu_cbfn(enet)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tif ((enet)->mtu_cbfn) {\t\t\t\t\t\t\\\n\t\tvoid (*cbfn)(struct bnad *);\t\t\t\t\\\n\t\tcbfn = (enet)->mtu_cbfn;\t\t\t\t\\\n\t\t(enet)->mtu_cbfn = NULL;\t\t\t\t\\\n\t\tcbfn((enet)->bna->bnad);\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n} while (0)\n\nstatic void bna_enet_cb_chld_stopped(void *arg);\nstatic void bna_bfi_pause_set(struct bna_enet *enet);\n\nbfa_fsm_state_decl(bna_enet, stopped, struct bna_enet,\n\t\t\tenum bna_enet_event);\nbfa_fsm_state_decl(bna_enet, pause_init_wait, struct bna_enet,\n\t\t\tenum bna_enet_event);\nbfa_fsm_state_decl(bna_enet, last_resp_wait, struct bna_enet,\n\t\t\tenum bna_enet_event);\nbfa_fsm_state_decl(bna_enet, started, struct bna_enet,\n\t\t\tenum bna_enet_event);\nbfa_fsm_state_decl(bna_enet, cfg_wait, struct bna_enet,\n\t\t\tenum bna_enet_event);\nbfa_fsm_state_decl(bna_enet, cfg_stop_wait, struct bna_enet,\n\t\t\tenum bna_enet_event);\nbfa_fsm_state_decl(bna_enet, chld_stop_wait, struct bna_enet,\n\t\t\tenum bna_enet_event);\n\nstatic void\nbna_enet_sm_stopped_entry(struct bna_enet *enet)\n{\n\tcall_enet_mtu_cbfn(enet);\n\tcall_enet_stop_cbfn(enet);\n}\n\nstatic void\nbna_enet_sm_stopped(struct bna_enet *enet, enum bna_enet_event event)\n{\n\tswitch (event) {\n\tcase ENET_E_START:\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_pause_init_wait);\n\t\tbreak;\n\n\tcase ENET_E_STOP:\n\t\tcall_enet_stop_cbfn(enet);\n\t\tbreak;\n\n\tcase ENET_E_FAIL:\n\t\t \n\t\tbreak;\n\n\tcase ENET_E_PAUSE_CFG:\n\t\tbreak;\n\n\tcase ENET_E_MTU_CFG:\n\t\tcall_enet_mtu_cbfn(enet);\n\t\tbreak;\n\n\tcase ENET_E_CHLD_STOPPED:\n\t\t \n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_enet_sm_pause_init_wait_entry(struct bna_enet *enet)\n{\n\tbna_bfi_pause_set(enet);\n}\n\nstatic void\nbna_enet_sm_pause_init_wait(struct bna_enet *enet,\n\t\t\t\tenum bna_enet_event event)\n{\n\tswitch (event) {\n\tcase ENET_E_STOP:\n\t\tenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_last_resp_wait);\n\t\tbreak;\n\n\tcase ENET_E_FAIL:\n\t\tenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_stopped);\n\t\tbreak;\n\n\tcase ENET_E_PAUSE_CFG:\n\t\tenet->flags |= BNA_ENET_F_PAUSE_CHANGED;\n\t\tbreak;\n\n\tcase ENET_E_MTU_CFG:\n\t\t \n\t\tbreak;\n\n\tcase ENET_E_FWRESP_PAUSE:\n\t\tif (enet->flags & BNA_ENET_F_PAUSE_CHANGED) {\n\t\t\tenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\n\t\t\tbna_bfi_pause_set(enet);\n\t\t} else {\n\t\t\tbfa_fsm_set_state(enet, bna_enet_sm_started);\n\t\t\tbna_enet_chld_start(enet);\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_enet_sm_last_resp_wait_entry(struct bna_enet *enet)\n{\n\tenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\n}\n\nstatic void\nbna_enet_sm_last_resp_wait(struct bna_enet *enet,\n\t\t\t\tenum bna_enet_event event)\n{\n\tswitch (event) {\n\tcase ENET_E_FAIL:\n\tcase ENET_E_FWRESP_PAUSE:\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_stopped);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_enet_sm_started_entry(struct bna_enet *enet)\n{\n\t \n\tcall_enet_mtu_cbfn(enet);\n}\n\nstatic void\nbna_enet_sm_started(struct bna_enet *enet,\n\t\t\tenum bna_enet_event event)\n{\n\tswitch (event) {\n\tcase ENET_E_STOP:\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_chld_stop_wait);\n\t\tbreak;\n\n\tcase ENET_E_FAIL:\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_stopped);\n\t\tbna_enet_chld_fail(enet);\n\t\tbreak;\n\n\tcase ENET_E_PAUSE_CFG:\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_cfg_wait);\n\t\tbna_bfi_pause_set(enet);\n\t\tbreak;\n\n\tcase ENET_E_MTU_CFG:\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_cfg_wait);\n\t\tbna_enet_rx_stop(enet);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_enet_sm_cfg_wait_entry(struct bna_enet *enet)\n{\n}\n\nstatic void\nbna_enet_sm_cfg_wait(struct bna_enet *enet,\n\t\t\tenum bna_enet_event event)\n{\n\tswitch (event) {\n\tcase ENET_E_STOP:\n\t\tenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\n\t\tenet->flags &= ~BNA_ENET_F_MTU_CHANGED;\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_cfg_stop_wait);\n\t\tbreak;\n\n\tcase ENET_E_FAIL:\n\t\tenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\n\t\tenet->flags &= ~BNA_ENET_F_MTU_CHANGED;\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_stopped);\n\t\tbna_enet_chld_fail(enet);\n\t\tbreak;\n\n\tcase ENET_E_PAUSE_CFG:\n\t\tenet->flags |= BNA_ENET_F_PAUSE_CHANGED;\n\t\tbreak;\n\n\tcase ENET_E_MTU_CFG:\n\t\tenet->flags |= BNA_ENET_F_MTU_CHANGED;\n\t\tbreak;\n\n\tcase ENET_E_CHLD_STOPPED:\n\t\tbna_enet_rx_start(enet);\n\t\tfallthrough;\n\tcase ENET_E_FWRESP_PAUSE:\n\t\tif (enet->flags & BNA_ENET_F_PAUSE_CHANGED) {\n\t\t\tenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\n\t\t\tbna_bfi_pause_set(enet);\n\t\t} else if (enet->flags & BNA_ENET_F_MTU_CHANGED) {\n\t\t\tenet->flags &= ~BNA_ENET_F_MTU_CHANGED;\n\t\t\tbna_enet_rx_stop(enet);\n\t\t} else {\n\t\t\tbfa_fsm_set_state(enet, bna_enet_sm_started);\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_enet_sm_cfg_stop_wait_entry(struct bna_enet *enet)\n{\n\tenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\n\tenet->flags &= ~BNA_ENET_F_MTU_CHANGED;\n}\n\nstatic void\nbna_enet_sm_cfg_stop_wait(struct bna_enet *enet,\n\t\t\t\tenum bna_enet_event event)\n{\n\tswitch (event) {\n\tcase ENET_E_FAIL:\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_stopped);\n\t\tbna_enet_chld_fail(enet);\n\t\tbreak;\n\n\tcase ENET_E_FWRESP_PAUSE:\n\tcase ENET_E_CHLD_STOPPED:\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_chld_stop_wait);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_enet_sm_chld_stop_wait_entry(struct bna_enet *enet)\n{\n\tbna_enet_chld_stop(enet);\n}\n\nstatic void\nbna_enet_sm_chld_stop_wait(struct bna_enet *enet,\n\t\t\t\tenum bna_enet_event event)\n{\n\tswitch (event) {\n\tcase ENET_E_FAIL:\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_stopped);\n\t\tbna_enet_chld_fail(enet);\n\t\tbreak;\n\n\tcase ENET_E_CHLD_STOPPED:\n\t\tbfa_fsm_set_state(enet, bna_enet_sm_stopped);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_bfi_pause_set(struct bna_enet *enet)\n{\n\tstruct bfi_enet_set_pause_req *pause_req = &enet->pause_req;\n\n\tbfi_msgq_mhdr_set(pause_req->mh, BFI_MC_ENET,\n\t\tBFI_ENET_H2I_SET_PAUSE_REQ, 0, 0);\n\tpause_req->mh.num_entries = htons(\n\tbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_set_pause_req)));\n\tpause_req->tx_pause = enet->pause_config.tx_pause;\n\tpause_req->rx_pause = enet->pause_config.rx_pause;\n\n\tbfa_msgq_cmd_set(&enet->msgq_cmd, NULL, NULL,\n\t\tsizeof(struct bfi_enet_set_pause_req), &pause_req->mh);\n\tbfa_msgq_cmd_post(&enet->bna->msgq, &enet->msgq_cmd);\n}\n\nstatic void\nbna_enet_cb_chld_stopped(void *arg)\n{\n\tstruct bna_enet *enet = (struct bna_enet *)arg;\n\n\tbfa_fsm_send_event(enet, ENET_E_CHLD_STOPPED);\n}\n\nstatic void\nbna_enet_init(struct bna_enet *enet, struct bna *bna)\n{\n\tenet->bna = bna;\n\tenet->flags = 0;\n\tenet->mtu = 0;\n\tenet->type = BNA_ENET_T_REGULAR;\n\n\tenet->stop_cbfn = NULL;\n\tenet->stop_cbarg = NULL;\n\n\tenet->mtu_cbfn = NULL;\n\n\tbfa_fsm_set_state(enet, bna_enet_sm_stopped);\n}\n\nstatic void\nbna_enet_uninit(struct bna_enet *enet)\n{\n\tenet->flags = 0;\n\n\tenet->bna = NULL;\n}\n\nstatic void\nbna_enet_start(struct bna_enet *enet)\n{\n\tenet->flags |= BNA_ENET_F_IOCETH_READY;\n\tif (enet->flags & BNA_ENET_F_ENABLED)\n\t\tbfa_fsm_send_event(enet, ENET_E_START);\n}\n\nstatic void\nbna_ioceth_cb_enet_stopped(void *arg)\n{\n\tstruct bna_ioceth *ioceth = (struct bna_ioceth *)arg;\n\n\tbfa_fsm_send_event(ioceth, IOCETH_E_ENET_STOPPED);\n}\n\nstatic void\nbna_enet_stop(struct bna_enet *enet)\n{\n\tenet->stop_cbfn = bna_ioceth_cb_enet_stopped;\n\tenet->stop_cbarg = &enet->bna->ioceth;\n\n\tenet->flags &= ~BNA_ENET_F_IOCETH_READY;\n\tbfa_fsm_send_event(enet, ENET_E_STOP);\n}\n\nstatic void\nbna_enet_fail(struct bna_enet *enet)\n{\n\tenet->flags &= ~BNA_ENET_F_IOCETH_READY;\n\tbfa_fsm_send_event(enet, ENET_E_FAIL);\n}\n\nvoid\nbna_enet_cb_tx_stopped(struct bna_enet *enet)\n{\n\tbfa_wc_down(&enet->chld_stop_wc);\n}\n\nvoid\nbna_enet_cb_rx_stopped(struct bna_enet *enet)\n{\n\tbfa_wc_down(&enet->chld_stop_wc);\n}\n\nint\nbna_enet_mtu_get(struct bna_enet *enet)\n{\n\treturn enet->mtu;\n}\n\nvoid\nbna_enet_enable(struct bna_enet *enet)\n{\n\tif (enet->fsm != bna_enet_sm_stopped)\n\t\treturn;\n\n\tenet->flags |= BNA_ENET_F_ENABLED;\n\n\tif (enet->flags & BNA_ENET_F_IOCETH_READY)\n\t\tbfa_fsm_send_event(enet, ENET_E_START);\n}\n\nvoid\nbna_enet_disable(struct bna_enet *enet, enum bna_cleanup_type type,\n\t\t void (*cbfn)(void *))\n{\n\tif (type == BNA_SOFT_CLEANUP) {\n\t\t(*cbfn)(enet->bna->bnad);\n\t\treturn;\n\t}\n\n\tenet->stop_cbfn = cbfn;\n\tenet->stop_cbarg = enet->bna->bnad;\n\n\tenet->flags &= ~BNA_ENET_F_ENABLED;\n\n\tbfa_fsm_send_event(enet, ENET_E_STOP);\n}\n\nvoid\nbna_enet_pause_config(struct bna_enet *enet,\n\t\t      struct bna_pause_config *pause_config)\n{\n\tenet->pause_config = *pause_config;\n\n\tbfa_fsm_send_event(enet, ENET_E_PAUSE_CFG);\n}\n\nvoid\nbna_enet_mtu_set(struct bna_enet *enet, int mtu,\n\t\t void (*cbfn)(struct bnad *))\n{\n\tenet->mtu = mtu;\n\n\tenet->mtu_cbfn = cbfn;\n\n\tbfa_fsm_send_event(enet, ENET_E_MTU_CFG);\n}\n\nvoid\nbna_enet_perm_mac_get(struct bna_enet *enet, u8 *mac)\n{\n\tbfa_nw_ioc_get_mac(&enet->bna->ioceth.ioc, mac);\n}\n\n \n\n#define enable_mbox_intr(_ioceth)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tu32 intr_status;\t\t\t\t\t\t\\\n\tbna_intr_status_get((_ioceth)->bna, intr_status);\t\t\\\n\tbnad_cb_mbox_intr_enable((_ioceth)->bna->bnad);\t\t\t\\\n\tbna_mbox_intr_enable((_ioceth)->bna);\t\t\t\t\\\n} while (0)\n\n#define disable_mbox_intr(_ioceth)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tbna_mbox_intr_disable((_ioceth)->bna);\t\t\t\t\\\n\tbnad_cb_mbox_intr_disable((_ioceth)->bna->bnad);\t\t\\\n} while (0)\n\n#define call_ioceth_stop_cbfn(_ioceth)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\tif ((_ioceth)->stop_cbfn) {\t\t\t\t\t\\\n\t\tvoid (*cbfn)(struct bnad *);\t\t\t\t\\\n\t\tstruct bnad *cbarg;\t\t\t\t\t\\\n\t\tcbfn = (_ioceth)->stop_cbfn;\t\t\t\t\\\n\t\tcbarg = (_ioceth)->stop_cbarg;\t\t\t\t\\\n\t\t(_ioceth)->stop_cbfn = NULL;\t\t\t\t\\\n\t\t(_ioceth)->stop_cbarg = NULL;\t\t\t\t\\\n\t\tcbfn(cbarg);\t\t\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n} while (0)\n\n#define bna_stats_mod_uninit(_stats_mod)\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n} while (0)\n\n#define bna_stats_mod_start(_stats_mod)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\t(_stats_mod)->ioc_ready = true;\t\t\t\t\t\\\n} while (0)\n\n#define bna_stats_mod_stop(_stats_mod)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\t(_stats_mod)->ioc_ready = false;\t\t\t\t\\\n} while (0)\n\n#define bna_stats_mod_fail(_stats_mod)\t\t\t\t\t\\\ndo {\t\t\t\t\t\t\t\t\t\\\n\t(_stats_mod)->ioc_ready = false;\t\t\t\t\\\n\t(_stats_mod)->stats_get_busy = false;\t\t\t\t\\\n\t(_stats_mod)->stats_clr_busy = false;\t\t\t\t\\\n} while (0)\n\nstatic void bna_bfi_attr_get(struct bna_ioceth *ioceth);\n\nbfa_fsm_state_decl(bna_ioceth, stopped, struct bna_ioceth,\n\t\t\tenum bna_ioceth_event);\nbfa_fsm_state_decl(bna_ioceth, ioc_ready_wait, struct bna_ioceth,\n\t\t\tenum bna_ioceth_event);\nbfa_fsm_state_decl(bna_ioceth, enet_attr_wait, struct bna_ioceth,\n\t\t\tenum bna_ioceth_event);\nbfa_fsm_state_decl(bna_ioceth, ready, struct bna_ioceth,\n\t\t\tenum bna_ioceth_event);\nbfa_fsm_state_decl(bna_ioceth, last_resp_wait, struct bna_ioceth,\n\t\t\tenum bna_ioceth_event);\nbfa_fsm_state_decl(bna_ioceth, enet_stop_wait, struct bna_ioceth,\n\t\t\tenum bna_ioceth_event);\nbfa_fsm_state_decl(bna_ioceth, ioc_disable_wait, struct bna_ioceth,\n\t\t\tenum bna_ioceth_event);\nbfa_fsm_state_decl(bna_ioceth, failed, struct bna_ioceth,\n\t\t\tenum bna_ioceth_event);\n\nstatic void\nbna_ioceth_sm_stopped_entry(struct bna_ioceth *ioceth)\n{\n\tcall_ioceth_stop_cbfn(ioceth);\n}\n\nstatic void\nbna_ioceth_sm_stopped(struct bna_ioceth *ioceth,\n\t\t\tenum bna_ioceth_event event)\n{\n\tswitch (event) {\n\tcase IOCETH_E_ENABLE:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_ready_wait);\n\t\tbfa_nw_ioc_enable(&ioceth->ioc);\n\t\tbreak;\n\n\tcase IOCETH_E_DISABLE:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_stopped);\n\t\tbreak;\n\n\tcase IOCETH_E_IOC_RESET:\n\t\tenable_mbox_intr(ioceth);\n\t\tbreak;\n\n\tcase IOCETH_E_IOC_FAILED:\n\t\tdisable_mbox_intr(ioceth);\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_failed);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ioceth_sm_ioc_ready_wait_entry(struct bna_ioceth *ioceth)\n{\n\t \n}\n\nstatic void\nbna_ioceth_sm_ioc_ready_wait(struct bna_ioceth *ioceth,\n\t\t\t\tenum bna_ioceth_event event)\n{\n\tswitch (event) {\n\tcase IOCETH_E_DISABLE:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\n\t\tbfa_nw_ioc_disable(&ioceth->ioc);\n\t\tbreak;\n\n\tcase IOCETH_E_IOC_RESET:\n\t\tenable_mbox_intr(ioceth);\n\t\tbreak;\n\n\tcase IOCETH_E_IOC_FAILED:\n\t\tdisable_mbox_intr(ioceth);\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_failed);\n\t\tbreak;\n\n\tcase IOCETH_E_IOC_READY:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_enet_attr_wait);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ioceth_sm_enet_attr_wait_entry(struct bna_ioceth *ioceth)\n{\n\tbna_bfi_attr_get(ioceth);\n}\n\nstatic void\nbna_ioceth_sm_enet_attr_wait(struct bna_ioceth *ioceth,\n\t\t\t\tenum bna_ioceth_event event)\n{\n\tswitch (event) {\n\tcase IOCETH_E_DISABLE:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_last_resp_wait);\n\t\tbreak;\n\n\tcase IOCETH_E_IOC_FAILED:\n\t\tdisable_mbox_intr(ioceth);\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_failed);\n\t\tbreak;\n\n\tcase IOCETH_E_ENET_ATTR_RESP:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_ready);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ioceth_sm_ready_entry(struct bna_ioceth *ioceth)\n{\n\tbna_enet_start(&ioceth->bna->enet);\n\tbna_stats_mod_start(&ioceth->bna->stats_mod);\n\tbnad_cb_ioceth_ready(ioceth->bna->bnad);\n}\n\nstatic void\nbna_ioceth_sm_ready(struct bna_ioceth *ioceth, enum bna_ioceth_event event)\n{\n\tswitch (event) {\n\tcase IOCETH_E_DISABLE:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_enet_stop_wait);\n\t\tbreak;\n\n\tcase IOCETH_E_IOC_FAILED:\n\t\tdisable_mbox_intr(ioceth);\n\t\tbna_enet_fail(&ioceth->bna->enet);\n\t\tbna_stats_mod_fail(&ioceth->bna->stats_mod);\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_failed);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ioceth_sm_last_resp_wait_entry(struct bna_ioceth *ioceth)\n{\n}\n\nstatic void\nbna_ioceth_sm_last_resp_wait(struct bna_ioceth *ioceth,\n\t\t\t\tenum bna_ioceth_event event)\n{\n\tswitch (event) {\n\tcase IOCETH_E_IOC_FAILED:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\n\t\tdisable_mbox_intr(ioceth);\n\t\tbfa_nw_ioc_disable(&ioceth->ioc);\n\t\tbreak;\n\n\tcase IOCETH_E_ENET_ATTR_RESP:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\n\t\tbfa_nw_ioc_disable(&ioceth->ioc);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ioceth_sm_enet_stop_wait_entry(struct bna_ioceth *ioceth)\n{\n\tbna_stats_mod_stop(&ioceth->bna->stats_mod);\n\tbna_enet_stop(&ioceth->bna->enet);\n}\n\nstatic void\nbna_ioceth_sm_enet_stop_wait(struct bna_ioceth *ioceth,\n\t\t\t\tenum bna_ioceth_event event)\n{\n\tswitch (event) {\n\tcase IOCETH_E_IOC_FAILED:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\n\t\tdisable_mbox_intr(ioceth);\n\t\tbna_enet_fail(&ioceth->bna->enet);\n\t\tbna_stats_mod_fail(&ioceth->bna->stats_mod);\n\t\tbfa_nw_ioc_disable(&ioceth->ioc);\n\t\tbreak;\n\n\tcase IOCETH_E_ENET_STOPPED:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\n\t\tbfa_nw_ioc_disable(&ioceth->ioc);\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ioceth_sm_ioc_disable_wait_entry(struct bna_ioceth *ioceth)\n{\n}\n\nstatic void\nbna_ioceth_sm_ioc_disable_wait(struct bna_ioceth *ioceth,\n\t\t\t\tenum bna_ioceth_event event)\n{\n\tswitch (event) {\n\tcase IOCETH_E_IOC_DISABLED:\n\t\tdisable_mbox_intr(ioceth);\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_stopped);\n\t\tbreak;\n\n\tcase IOCETH_E_ENET_STOPPED:\n\t\t \n\t\t \n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_ioceth_sm_failed_entry(struct bna_ioceth *ioceth)\n{\n\tbnad_cb_ioceth_failed(ioceth->bna->bnad);\n}\n\nstatic void\nbna_ioceth_sm_failed(struct bna_ioceth *ioceth,\n\t\t\tenum bna_ioceth_event event)\n{\n\tswitch (event) {\n\tcase IOCETH_E_DISABLE:\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\n\t\tbfa_nw_ioc_disable(&ioceth->ioc);\n\t\tbreak;\n\n\tcase IOCETH_E_IOC_RESET:\n\t\tenable_mbox_intr(ioceth);\n\t\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_ready_wait);\n\t\tbreak;\n\n\tcase IOCETH_E_IOC_FAILED:\n\t\tbreak;\n\n\tdefault:\n\t\tbfa_sm_fault(event);\n\t}\n}\n\nstatic void\nbna_bfi_attr_get(struct bna_ioceth *ioceth)\n{\n\tstruct bfi_enet_attr_req *attr_req = &ioceth->attr_req;\n\n\tbfi_msgq_mhdr_set(attr_req->mh, BFI_MC_ENET,\n\t\tBFI_ENET_H2I_GET_ATTR_REQ, 0, 0);\n\tattr_req->mh.num_entries = htons(\n\tbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_attr_req)));\n\tbfa_msgq_cmd_set(&ioceth->msgq_cmd, NULL, NULL,\n\t\tsizeof(struct bfi_enet_attr_req), &attr_req->mh);\n\tbfa_msgq_cmd_post(&ioceth->bna->msgq, &ioceth->msgq_cmd);\n}\n\n \n\nstatic void\nbna_cb_ioceth_enable(void *arg, enum bfa_status error)\n{\n\tstruct bna_ioceth *ioceth = (struct bna_ioceth *)arg;\n\n\tif (error)\n\t\tbfa_fsm_send_event(ioceth, IOCETH_E_IOC_FAILED);\n\telse\n\t\tbfa_fsm_send_event(ioceth, IOCETH_E_IOC_READY);\n}\n\nstatic void\nbna_cb_ioceth_disable(void *arg)\n{\n\tstruct bna_ioceth *ioceth = (struct bna_ioceth *)arg;\n\n\tbfa_fsm_send_event(ioceth, IOCETH_E_IOC_DISABLED);\n}\n\nstatic void\nbna_cb_ioceth_hbfail(void *arg)\n{\n\tstruct bna_ioceth *ioceth = (struct bna_ioceth *)arg;\n\n\tbfa_fsm_send_event(ioceth, IOCETH_E_IOC_FAILED);\n}\n\nstatic void\nbna_cb_ioceth_reset(void *arg)\n{\n\tstruct bna_ioceth *ioceth = (struct bna_ioceth *)arg;\n\n\tbfa_fsm_send_event(ioceth, IOCETH_E_IOC_RESET);\n}\n\nstatic struct bfa_ioc_cbfn bna_ioceth_cbfn = {\n\t.enable_cbfn = bna_cb_ioceth_enable,\n\t.disable_cbfn = bna_cb_ioceth_disable,\n\t.hbfail_cbfn = bna_cb_ioceth_hbfail,\n\t.reset_cbfn = bna_cb_ioceth_reset\n};\n\nstatic void bna_attr_init(struct bna_ioceth *ioceth)\n{\n\tioceth->attr.num_txq = BFI_ENET_DEF_TXQ;\n\tioceth->attr.num_rxp = BFI_ENET_DEF_RXP;\n\tioceth->attr.num_ucmac = BFI_ENET_DEF_UCAM;\n\tioceth->attr.num_mcmac = BFI_ENET_MAX_MCAM;\n\tioceth->attr.max_rit_size = BFI_ENET_DEF_RITSZ;\n\tioceth->attr.fw_query_complete = false;\n}\n\nstatic void\nbna_ioceth_init(struct bna_ioceth *ioceth, struct bna *bna,\n\t\tstruct bna_res_info *res_info)\n{\n\tu64 dma;\n\tu8 *kva;\n\n\tioceth->bna = bna;\n\n\t \n\tbfa_nw_ioc_attach(&ioceth->ioc, ioceth, &bna_ioceth_cbfn);\n\tbfa_nw_ioc_pci_init(&ioceth->ioc, &bna->pcidev, BFI_PCIFN_CLASS_ETH);\n\n\tBNA_GET_DMA_ADDR(\n\t\t&res_info[BNA_RES_MEM_T_ATTR].res_u.mem_info.mdl[0].dma, dma);\n\tkva = res_info[BNA_RES_MEM_T_ATTR].res_u.mem_info.mdl[0].kva;\n\tbfa_nw_ioc_mem_claim(&ioceth->ioc, kva, dma);\n\n\tkva = res_info[BNA_RES_MEM_T_FWTRC].res_u.mem_info.mdl[0].kva;\n\tbfa_nw_ioc_debug_memclaim(&ioceth->ioc, kva);\n\n\t \n\tBNA_GET_DMA_ADDR(\n\t\t&res_info[BNA_RES_MEM_T_COM].res_u.mem_info.mdl[0].dma, dma);\n\tkva = res_info[BNA_RES_MEM_T_COM].res_u.mem_info.mdl[0].kva;\n\tbfa_nw_cee_attach(&bna->cee, &ioceth->ioc, bna);\n\tbfa_nw_cee_mem_claim(&bna->cee, kva, dma);\n\tkva += bfa_nw_cee_meminfo();\n\tdma += bfa_nw_cee_meminfo();\n\n\tbfa_nw_flash_attach(&bna->flash, &ioceth->ioc, bna);\n\tbfa_nw_flash_memclaim(&bna->flash, kva, dma);\n\tkva += bfa_nw_flash_meminfo();\n\tdma += bfa_nw_flash_meminfo();\n\n\tbfa_msgq_attach(&bna->msgq, &ioceth->ioc);\n\tbfa_msgq_memclaim(&bna->msgq, kva, dma);\n\tbfa_msgq_regisr(&bna->msgq, BFI_MC_ENET, bna_msgq_rsp_handler, bna);\n\tkva += bfa_msgq_meminfo();\n\tdma += bfa_msgq_meminfo();\n\n\tioceth->stop_cbfn = NULL;\n\tioceth->stop_cbarg = NULL;\n\n\tbna_attr_init(ioceth);\n\n\tbfa_fsm_set_state(ioceth, bna_ioceth_sm_stopped);\n}\n\nstatic void\nbna_ioceth_uninit(struct bna_ioceth *ioceth)\n{\n\tbfa_nw_ioc_detach(&ioceth->ioc);\n\n\tioceth->bna = NULL;\n}\n\nvoid\nbna_ioceth_enable(struct bna_ioceth *ioceth)\n{\n\tif (ioceth->fsm == bna_ioceth_sm_ready) {\n\t\tbnad_cb_ioceth_ready(ioceth->bna->bnad);\n\t\treturn;\n\t}\n\n\tif (ioceth->fsm == bna_ioceth_sm_stopped)\n\t\tbfa_fsm_send_event(ioceth, IOCETH_E_ENABLE);\n}\n\nvoid\nbna_ioceth_disable(struct bna_ioceth *ioceth, enum bna_cleanup_type type)\n{\n\tif (type == BNA_SOFT_CLEANUP) {\n\t\tbnad_cb_ioceth_disabled(ioceth->bna->bnad);\n\t\treturn;\n\t}\n\n\tioceth->stop_cbfn = bnad_cb_ioceth_disabled;\n\tioceth->stop_cbarg = ioceth->bna->bnad;\n\n\tbfa_fsm_send_event(ioceth, IOCETH_E_DISABLE);\n}\n\nstatic void\nbna_ucam_mod_init(struct bna_ucam_mod *ucam_mod, struct bna *bna,\n\t\t  struct bna_res_info *res_info)\n{\n\tint i;\n\n\tucam_mod->ucmac = (struct bna_mac *)\n\tres_info[BNA_MOD_RES_MEM_T_UCMAC_ARRAY].res_u.mem_info.mdl[0].kva;\n\n\tINIT_LIST_HEAD(&ucam_mod->free_q);\n\tfor (i = 0; i < bna->ioceth.attr.num_ucmac; i++)\n\t\tlist_add_tail(&ucam_mod->ucmac[i].qe, &ucam_mod->free_q);\n\n\t \n\tINIT_LIST_HEAD(&ucam_mod->del_q);\n\tfor (; i < (bna->ioceth.attr.num_ucmac * 2); i++)\n\t\tlist_add_tail(&ucam_mod->ucmac[i].qe, &ucam_mod->del_q);\n\n\tucam_mod->bna = bna;\n}\n\nstatic void\nbna_ucam_mod_uninit(struct bna_ucam_mod *ucam_mod)\n{\n\tucam_mod->bna = NULL;\n}\n\nstatic void\nbna_mcam_mod_init(struct bna_mcam_mod *mcam_mod, struct bna *bna,\n\t\t  struct bna_res_info *res_info)\n{\n\tint i;\n\n\tmcam_mod->mcmac = (struct bna_mac *)\n\tres_info[BNA_MOD_RES_MEM_T_MCMAC_ARRAY].res_u.mem_info.mdl[0].kva;\n\n\tINIT_LIST_HEAD(&mcam_mod->free_q);\n\tfor (i = 0; i < bna->ioceth.attr.num_mcmac; i++)\n\t\tlist_add_tail(&mcam_mod->mcmac[i].qe, &mcam_mod->free_q);\n\n\tmcam_mod->mchandle = (struct bna_mcam_handle *)\n\tres_info[BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY].res_u.mem_info.mdl[0].kva;\n\n\tINIT_LIST_HEAD(&mcam_mod->free_handle_q);\n\tfor (i = 0; i < bna->ioceth.attr.num_mcmac; i++)\n\t\tlist_add_tail(&mcam_mod->mchandle[i].qe,\n\t\t\t      &mcam_mod->free_handle_q);\n\n\t \n\tINIT_LIST_HEAD(&mcam_mod->del_q);\n\tfor (; i < (bna->ioceth.attr.num_mcmac * 2); i++)\n\t\tlist_add_tail(&mcam_mod->mcmac[i].qe, &mcam_mod->del_q);\n\n\tmcam_mod->bna = bna;\n}\n\nstatic void\nbna_mcam_mod_uninit(struct bna_mcam_mod *mcam_mod)\n{\n\tmcam_mod->bna = NULL;\n}\n\nstatic void\nbna_bfi_stats_get(struct bna *bna)\n{\n\tstruct bfi_enet_stats_req *stats_req = &bna->stats_mod.stats_get;\n\n\tbna->stats_mod.stats_get_busy = true;\n\n\tbfi_msgq_mhdr_set(stats_req->mh, BFI_MC_ENET,\n\t\tBFI_ENET_H2I_STATS_GET_REQ, 0, 0);\n\tstats_req->mh.num_entries = htons(\n\t\tbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_stats_req)));\n\tstats_req->stats_mask = htons(BFI_ENET_STATS_ALL);\n\tstats_req->tx_enet_mask = htonl(bna->tx_mod.rid_mask);\n\tstats_req->rx_enet_mask = htonl(bna->rx_mod.rid_mask);\n\tstats_req->host_buffer.a32.addr_hi = bna->stats.hw_stats_dma.msb;\n\tstats_req->host_buffer.a32.addr_lo = bna->stats.hw_stats_dma.lsb;\n\n\tbfa_msgq_cmd_set(&bna->stats_mod.stats_get_cmd, NULL, NULL,\n\t\tsizeof(struct bfi_enet_stats_req), &stats_req->mh);\n\tbfa_msgq_cmd_post(&bna->msgq, &bna->stats_mod.stats_get_cmd);\n}\n\nvoid\nbna_res_req(struct bna_res_info *res_info)\n{\n\t \n\tres_info[BNA_RES_MEM_T_COM].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_RES_MEM_T_COM].res_u.mem_info.mem_type = BNA_MEM_T_DMA;\n\tres_info[BNA_RES_MEM_T_COM].res_u.mem_info.num = 1;\n\tres_info[BNA_RES_MEM_T_COM].res_u.mem_info.len = ALIGN(\n\t\t\t\t(bfa_nw_cee_meminfo() +\n\t\t\t\t bfa_nw_flash_meminfo() +\n\t\t\t\t bfa_msgq_meminfo()), PAGE_SIZE);\n\n\t \n\tres_info[BNA_RES_MEM_T_ATTR].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_RES_MEM_T_ATTR].res_u.mem_info.mem_type = BNA_MEM_T_DMA;\n\tres_info[BNA_RES_MEM_T_ATTR].res_u.mem_info.num = 1;\n\tres_info[BNA_RES_MEM_T_ATTR].res_u.mem_info.len =\n\t\t\t\tALIGN(bfa_nw_ioc_meminfo(), PAGE_SIZE);\n\n\t \n\tres_info[BNA_RES_MEM_T_FWTRC].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_RES_MEM_T_FWTRC].res_u.mem_info.mem_type = BNA_MEM_T_KVA;\n\tres_info[BNA_RES_MEM_T_FWTRC].res_u.mem_info.num = 1;\n\tres_info[BNA_RES_MEM_T_FWTRC].res_u.mem_info.len = BNA_DBG_FWTRC_LEN;\n\n\t \n\tres_info[BNA_RES_MEM_T_STATS].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.mem_type = BNA_MEM_T_DMA;\n\tres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.num = 1;\n\tres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.len =\n\t\t\t\tALIGN(sizeof(struct bfi_enet_stats),\n\t\t\t\t\tPAGE_SIZE);\n}\n\nvoid\nbna_mod_res_req(struct bna *bna, struct bna_res_info *res_info)\n{\n\tstruct bna_attr *attr = &bna->ioceth.attr;\n\n\t \n\tres_info[BNA_MOD_RES_MEM_T_TX_ARRAY].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_MOD_RES_MEM_T_TX_ARRAY].res_u.mem_info.mem_type =\n\t\tBNA_MEM_T_KVA;\n\tres_info[BNA_MOD_RES_MEM_T_TX_ARRAY].res_u.mem_info.num = 1;\n\tres_info[BNA_MOD_RES_MEM_T_TX_ARRAY].res_u.mem_info.len =\n\t\tattr->num_txq * sizeof(struct bna_tx);\n\n\t \n\tres_info[BNA_MOD_RES_MEM_T_TXQ_ARRAY].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_MOD_RES_MEM_T_TXQ_ARRAY].res_u.mem_info.mem_type =\n\t\tBNA_MEM_T_KVA;\n\tres_info[BNA_MOD_RES_MEM_T_TXQ_ARRAY].res_u.mem_info.num = 1;\n\tres_info[BNA_MOD_RES_MEM_T_TXQ_ARRAY].res_u.mem_info.len =\n\t\tattr->num_txq * sizeof(struct bna_txq);\n\n\t \n\tres_info[BNA_MOD_RES_MEM_T_RX_ARRAY].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_MOD_RES_MEM_T_RX_ARRAY].res_u.mem_info.mem_type =\n\t\tBNA_MEM_T_KVA;\n\tres_info[BNA_MOD_RES_MEM_T_RX_ARRAY].res_u.mem_info.num = 1;\n\tres_info[BNA_MOD_RES_MEM_T_RX_ARRAY].res_u.mem_info.len =\n\t\tattr->num_rxp * sizeof(struct bna_rx);\n\n\t \n\tres_info[BNA_MOD_RES_MEM_T_RXP_ARRAY].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_MOD_RES_MEM_T_RXP_ARRAY].res_u.mem_info.mem_type =\n\t\tBNA_MEM_T_KVA;\n\tres_info[BNA_MOD_RES_MEM_T_RXP_ARRAY].res_u.mem_info.num = 1;\n\tres_info[BNA_MOD_RES_MEM_T_RXP_ARRAY].res_u.mem_info.len =\n\t\tattr->num_rxp * sizeof(struct bna_rxp);\n\n\t \n\tres_info[BNA_MOD_RES_MEM_T_RXQ_ARRAY].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_MOD_RES_MEM_T_RXQ_ARRAY].res_u.mem_info.mem_type =\n\t\tBNA_MEM_T_KVA;\n\tres_info[BNA_MOD_RES_MEM_T_RXQ_ARRAY].res_u.mem_info.num = 1;\n\tres_info[BNA_MOD_RES_MEM_T_RXQ_ARRAY].res_u.mem_info.len =\n\t\t(attr->num_rxp * 2) * sizeof(struct bna_rxq);\n\n\t \n\tres_info[BNA_MOD_RES_MEM_T_UCMAC_ARRAY].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_MOD_RES_MEM_T_UCMAC_ARRAY].res_u.mem_info.mem_type =\n\t\tBNA_MEM_T_KVA;\n\tres_info[BNA_MOD_RES_MEM_T_UCMAC_ARRAY].res_u.mem_info.num = 1;\n\tres_info[BNA_MOD_RES_MEM_T_UCMAC_ARRAY].res_u.mem_info.len =\n\t\t(attr->num_ucmac * 2) * sizeof(struct bna_mac);\n\n\t \n\tres_info[BNA_MOD_RES_MEM_T_MCMAC_ARRAY].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_MOD_RES_MEM_T_MCMAC_ARRAY].res_u.mem_info.mem_type =\n\t\tBNA_MEM_T_KVA;\n\tres_info[BNA_MOD_RES_MEM_T_MCMAC_ARRAY].res_u.mem_info.num = 1;\n\tres_info[BNA_MOD_RES_MEM_T_MCMAC_ARRAY].res_u.mem_info.len =\n\t\t(attr->num_mcmac * 2) * sizeof(struct bna_mac);\n\n\t \n\tres_info[BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY].res_type = BNA_RES_T_MEM;\n\tres_info[BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY].res_u.mem_info.mem_type =\n\t\tBNA_MEM_T_KVA;\n\tres_info[BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY].res_u.mem_info.num = 1;\n\tres_info[BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY].res_u.mem_info.len =\n\t\tattr->num_mcmac * sizeof(struct bna_mcam_handle);\n}\n\nvoid\nbna_init(struct bna *bna, struct bnad *bnad,\n\t\tstruct bfa_pcidev *pcidev, struct bna_res_info *res_info)\n{\n\tbna->bnad = bnad;\n\tbna->pcidev = *pcidev;\n\n\tbna->stats.hw_stats_kva = (struct bfi_enet_stats *)\n\t\tres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.mdl[0].kva;\n\tbna->stats.hw_stats_dma.msb =\n\t\tres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.mdl[0].dma.msb;\n\tbna->stats.hw_stats_dma.lsb =\n\t\tres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.mdl[0].dma.lsb;\n\n\tbna_reg_addr_init(bna, &bna->pcidev);\n\n\t \n\tbna_ioceth_init(&bna->ioceth, bna, res_info);\n\n\tbna_enet_init(&bna->enet, bna);\n\tbna_ethport_init(&bna->ethport, bna);\n}\n\nvoid\nbna_mod_init(struct bna *bna, struct bna_res_info *res_info)\n{\n\tbna_tx_mod_init(&bna->tx_mod, bna, res_info);\n\n\tbna_rx_mod_init(&bna->rx_mod, bna, res_info);\n\n\tbna_ucam_mod_init(&bna->ucam_mod, bna, res_info);\n\n\tbna_mcam_mod_init(&bna->mcam_mod, bna, res_info);\n\n\tbna->default_mode_rid = BFI_INVALID_RID;\n\tbna->promisc_rid = BFI_INVALID_RID;\n\n\tbna->mod_flags |= BNA_MOD_F_INIT_DONE;\n}\n\nvoid\nbna_uninit(struct bna *bna)\n{\n\tif (bna->mod_flags & BNA_MOD_F_INIT_DONE) {\n\t\tbna_mcam_mod_uninit(&bna->mcam_mod);\n\t\tbna_ucam_mod_uninit(&bna->ucam_mod);\n\t\tbna_rx_mod_uninit(&bna->rx_mod);\n\t\tbna_tx_mod_uninit(&bna->tx_mod);\n\t\tbna->mod_flags &= ~BNA_MOD_F_INIT_DONE;\n\t}\n\n\tbna_stats_mod_uninit(&bna->stats_mod);\n\tbna_ethport_uninit(&bna->ethport);\n\tbna_enet_uninit(&bna->enet);\n\n\tbna_ioceth_uninit(&bna->ioceth);\n\n\tbna->bnad = NULL;\n}\n\nint\nbna_num_txq_set(struct bna *bna, int num_txq)\n{\n\tif (bna->ioceth.attr.fw_query_complete &&\n\t\t(num_txq <= bna->ioceth.attr.num_txq)) {\n\t\tbna->ioceth.attr.num_txq = num_txq;\n\t\treturn BNA_CB_SUCCESS;\n\t}\n\n\treturn BNA_CB_FAIL;\n}\n\nint\nbna_num_rxp_set(struct bna *bna, int num_rxp)\n{\n\tif (bna->ioceth.attr.fw_query_complete &&\n\t\t(num_rxp <= bna->ioceth.attr.num_rxp)) {\n\t\tbna->ioceth.attr.num_rxp = num_rxp;\n\t\treturn BNA_CB_SUCCESS;\n\t}\n\n\treturn BNA_CB_FAIL;\n}\n\nstruct bna_mac *\nbna_cam_mod_mac_get(struct list_head *head)\n{\n\tstruct bna_mac *mac;\n\n\tmac = list_first_entry_or_null(head, struct bna_mac, qe);\n\tif (mac)\n\t\tlist_del(&mac->qe);\n\n\treturn mac;\n}\n\nstruct bna_mcam_handle *\nbna_mcam_mod_handle_get(struct bna_mcam_mod *mcam_mod)\n{\n\tstruct bna_mcam_handle *handle;\n\n\thandle = list_first_entry_or_null(&mcam_mod->free_handle_q,\n\t\t\t\t\t  struct bna_mcam_handle, qe);\n\tif (handle)\n\t\tlist_del(&handle->qe);\n\n\treturn handle;\n}\n\nvoid\nbna_mcam_mod_handle_put(struct bna_mcam_mod *mcam_mod,\n\t\t\tstruct bna_mcam_handle *handle)\n{\n\tlist_add_tail(&handle->qe, &mcam_mod->free_handle_q);\n}\n\nvoid\nbna_hw_stats_get(struct bna *bna)\n{\n\tif (!bna->stats_mod.ioc_ready) {\n\t\tbnad_cb_stats_get(bna->bnad, BNA_CB_FAIL, &bna->stats);\n\t\treturn;\n\t}\n\tif (bna->stats_mod.stats_get_busy) {\n\t\tbnad_cb_stats_get(bna->bnad, BNA_CB_BUSY, &bna->stats);\n\t\treturn;\n\t}\n\n\tbna_bfi_stats_get(bna);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}