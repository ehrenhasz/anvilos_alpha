{
  "module_name": "cxgb4_thermal.c",
  "hash_id": "df8cd1102d29c32d8afe49f355a6c8b3a1e6f7fcc281437fe60adda8df3a7369",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/chelsio/cxgb4/cxgb4_thermal.c",
  "human_readable_source": "\n \n\n#include \"cxgb4.h\"\n\n#define CXGB4_NUM_TRIPS 1\n\nstatic int cxgb4_thermal_get_temp(struct thermal_zone_device *tzdev,\n\t\t\t\t  int *temp)\n{\n\tstruct adapter *adap = thermal_zone_device_priv(tzdev);\n\tu32 param, val;\n\tint ret;\n\n\tparam = (FW_PARAMS_MNEM_V(FW_PARAMS_MNEM_DEV) |\n\t\t FW_PARAMS_PARAM_X_V(FW_PARAMS_PARAM_DEV_DIAG) |\n\t\t FW_PARAMS_PARAM_Y_V(FW_PARAM_DEV_DIAG_TMP));\n\n\tret = t4_query_params(adap, adap->mbox, adap->pf, 0, 1,\n\t\t\t      &param, &val);\n\tif (ret < 0 || val == 0)\n\t\treturn -1;\n\n\t*temp = val * 1000;\n\treturn 0;\n}\n\nstatic struct thermal_zone_device_ops cxgb4_thermal_ops = {\n\t.get_temp = cxgb4_thermal_get_temp,\n};\n\nstatic struct thermal_trip trip = { .type = THERMAL_TRIP_CRITICAL } ;\n\nint cxgb4_thermal_init(struct adapter *adap)\n{\n\tstruct ch_thermal *ch_thermal = &adap->ch_thermal;\n\tchar ch_tz_name[THERMAL_NAME_LENGTH];\n\tint num_trip = CXGB4_NUM_TRIPS;\n\tu32 param, val;\n\tint ret;\n\n\t \n\tparam = (FW_PARAMS_MNEM_V(FW_PARAMS_MNEM_DEV) |\n\t\t FW_PARAMS_PARAM_X_V(FW_PARAMS_PARAM_DEV_DIAG) |\n\t\t FW_PARAMS_PARAM_Y_V(FW_PARAM_DEV_DIAG_MAXTMPTHRESH));\n\n\tret = t4_query_params(adap, adap->mbox, adap->pf, 0, 1,\n\t\t\t      &param, &val);\n\tif (ret < 0) {\n\t\tnum_trip = 0;  \n\t} else {\n\t\ttrip.temperature = val * 1000;\n\t}\n\n\tsnprintf(ch_tz_name, sizeof(ch_tz_name), \"cxgb4_%s\", adap->name);\n\tch_thermal->tzdev = thermal_zone_device_register_with_trips(ch_tz_name, &trip, num_trip,\n\t\t\t\t\t\t\t\t    0, adap,\n\t\t\t\t\t\t\t\t    &cxgb4_thermal_ops,\n\t\t\t\t\t\t\t\t    NULL, 0, 0);\n\tif (IS_ERR(ch_thermal->tzdev)) {\n\t\tret = PTR_ERR(ch_thermal->tzdev);\n\t\tdev_err(adap->pdev_dev, \"Failed to register thermal zone\\n\");\n\t\tch_thermal->tzdev = NULL;\n\t\treturn ret;\n\t}\n\n\tret = thermal_zone_device_enable(ch_thermal->tzdev);\n\tif (ret) {\n\t\tdev_err(adap->pdev_dev, \"Failed to enable thermal zone\\n\");\n\t\tthermal_zone_device_unregister(adap->ch_thermal.tzdev);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nint cxgb4_thermal_remove(struct adapter *adap)\n{\n\tif (adap->ch_thermal.tzdev) {\n\t\tthermal_zone_device_unregister(adap->ch_thermal.tzdev);\n\t\tadap->ch_thermal.tzdev = NULL;\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}