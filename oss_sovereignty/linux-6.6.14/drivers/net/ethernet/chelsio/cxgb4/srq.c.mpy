{
  "module_name": "srq.c",
  "hash_id": "bfa2a900b1ebc209d1a287dc13dd08b0051afb94841438440f144bdd5ff969eb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/chelsio/cxgb4/srq.c",
  "human_readable_source": " \n\n#include \"cxgb4.h\"\n#include \"t4_msg.h\"\n#include \"srq.h\"\n\nstruct srq_data *t4_init_srq(int srq_size)\n{\n\tstruct srq_data *s;\n\n\ts = kvzalloc(sizeof(*s), GFP_KERNEL);\n\tif (!s)\n\t\treturn NULL;\n\n\ts->srq_size = srq_size;\n\tinit_completion(&s->comp);\n\tmutex_init(&s->lock);\n\n\treturn s;\n}\n\n \nint cxgb4_get_srq_entry(struct net_device *dev,\n\t\t\tint srq_idx, struct srq_entry *entryp)\n{\n\tstruct cpl_srq_table_req *req;\n\tstruct adapter *adap;\n\tstruct sk_buff *skb;\n\tstruct srq_data *s;\n\tint rc = -ENODEV;\n\n\tadap = netdev2adap(dev);\n\ts = adap->srq;\n\n\tif (!(adap->flags & CXGB4_FULL_INIT_DONE) || !s)\n\t\tgoto out;\n\n\tskb = alloc_skb(sizeof(*req), GFP_KERNEL);\n\tif (!skb)\n\t\treturn -ENOMEM;\n\treq = (struct cpl_srq_table_req *)\n\t\t__skb_put_zero(skb, sizeof(*req));\n\tINIT_TP_WR(req, 0);\n\tOPCODE_TID(req) = htonl(MK_OPCODE_TID(CPL_SRQ_TABLE_REQ,\n\t\t\t\t\t      TID_TID_V(srq_idx) |\n\t\t\t\tTID_QID_V(adap->sge.fw_evtq.abs_id)));\n\treq->idx = srq_idx;\n\n\tmutex_lock(&s->lock);\n\n\ts->entryp = entryp;\n\tt4_mgmt_tx(adap, skb);\n\n\trc = wait_for_completion_timeout(&s->comp, SRQ_WAIT_TO);\n\tif (rc)\n\t\trc = 0;\n\telse  \n\t\trc = -ETIMEDOUT;\n\n\tWARN_ON_ONCE(entryp->idx != srq_idx);\n\tmutex_unlock(&s->lock);\nout:\n\treturn rc;\n}\nEXPORT_SYMBOL(cxgb4_get_srq_entry);\n\nvoid do_srq_table_rpl(struct adapter *adap,\n\t\t      const struct cpl_srq_table_rpl *rpl)\n{\n\tunsigned int idx = TID_TID_G(GET_TID(rpl));\n\tstruct srq_data *s = adap->srq;\n\tstruct srq_entry *e;\n\n\tif (unlikely(rpl->status != CPL_CONTAINS_READ_RPL)) {\n\t\tdev_err(adap->pdev_dev,\n\t\t\t\"Unexpected SRQ_TABLE_RPL status %u for entry %u\\n\",\n\t\t\t\trpl->status, idx);\n\t\tgoto out;\n\t}\n\n\t \n\te = s->entryp;\n\te->valid = 1;\n\te->idx = idx;\n\te->pdid = SRQT_PDID_G(be64_to_cpu(rpl->rsvd_pdid));\n\te->qlen = SRQT_QLEN_G(be32_to_cpu(rpl->qlen_qbase));\n\te->qbase = SRQT_QBASE_G(be32_to_cpu(rpl->qlen_qbase));\n\te->cur_msn = be16_to_cpu(rpl->cur_msn);\n\te->max_msn = be16_to_cpu(rpl->max_msn);\nout:\n\tcomplete(&s->comp);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}