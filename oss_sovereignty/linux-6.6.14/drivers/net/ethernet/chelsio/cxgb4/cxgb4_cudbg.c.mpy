{
  "module_name": "cxgb4_cudbg.c",
  "hash_id": "761ff4d491c24a3c6fb6586b7674cb6c03c3f65f3bdb871375a5b7b029ee3a77",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/chelsio/cxgb4/cxgb4_cudbg.c",
  "human_readable_source": "\n \n\n#include \"t4_regs.h\"\n#include \"cxgb4.h\"\n#include \"cxgb4_cudbg.h\"\n#include \"cudbg_zlib.h\"\n\nstatic const struct cxgb4_collect_entity cxgb4_collect_mem_dump[] = {\n\t{ CUDBG_EDC0, cudbg_collect_edc0_meminfo },\n\t{ CUDBG_EDC1, cudbg_collect_edc1_meminfo },\n\t{ CUDBG_MC0, cudbg_collect_mc0_meminfo },\n\t{ CUDBG_MC1, cudbg_collect_mc1_meminfo },\n\t{ CUDBG_HMA, cudbg_collect_hma_meminfo },\n};\n\nstatic const struct cxgb4_collect_entity cxgb4_collect_hw_dump[] = {\n\t{ CUDBG_MBOX_LOG, cudbg_collect_mbox_log },\n\t{ CUDBG_QDESC, cudbg_collect_qdesc },\n\t{ CUDBG_DEV_LOG, cudbg_collect_fw_devlog },\n\t{ CUDBG_REG_DUMP, cudbg_collect_reg_dump },\n\t{ CUDBG_CIM_LA, cudbg_collect_cim_la },\n\t{ CUDBG_CIM_MA_LA, cudbg_collect_cim_ma_la },\n\t{ CUDBG_CIM_QCFG, cudbg_collect_cim_qcfg },\n\t{ CUDBG_CIM_IBQ_TP0, cudbg_collect_cim_ibq_tp0 },\n\t{ CUDBG_CIM_IBQ_TP1, cudbg_collect_cim_ibq_tp1 },\n\t{ CUDBG_CIM_IBQ_ULP, cudbg_collect_cim_ibq_ulp },\n\t{ CUDBG_CIM_IBQ_SGE0, cudbg_collect_cim_ibq_sge0 },\n\t{ CUDBG_CIM_IBQ_SGE1, cudbg_collect_cim_ibq_sge1 },\n\t{ CUDBG_CIM_IBQ_NCSI, cudbg_collect_cim_ibq_ncsi },\n\t{ CUDBG_CIM_OBQ_ULP0, cudbg_collect_cim_obq_ulp0 },\n\t{ CUDBG_CIM_OBQ_ULP1, cudbg_collect_cim_obq_ulp1 },\n\t{ CUDBG_CIM_OBQ_ULP2, cudbg_collect_cim_obq_ulp2 },\n\t{ CUDBG_CIM_OBQ_ULP3, cudbg_collect_cim_obq_ulp3 },\n\t{ CUDBG_CIM_OBQ_SGE, cudbg_collect_cim_obq_sge },\n\t{ CUDBG_CIM_OBQ_NCSI, cudbg_collect_cim_obq_ncsi },\n\t{ CUDBG_RSS, cudbg_collect_rss },\n\t{ CUDBG_RSS_VF_CONF, cudbg_collect_rss_vf_config },\n\t{ CUDBG_PATH_MTU, cudbg_collect_path_mtu },\n\t{ CUDBG_PM_STATS, cudbg_collect_pm_stats },\n\t{ CUDBG_HW_SCHED, cudbg_collect_hw_sched },\n\t{ CUDBG_TP_INDIRECT, cudbg_collect_tp_indirect },\n\t{ CUDBG_SGE_INDIRECT, cudbg_collect_sge_indirect },\n\t{ CUDBG_ULPRX_LA, cudbg_collect_ulprx_la },\n\t{ CUDBG_TP_LA, cudbg_collect_tp_la },\n\t{ CUDBG_MEMINFO, cudbg_collect_meminfo },\n\t{ CUDBG_CIM_PIF_LA, cudbg_collect_cim_pif_la },\n\t{ CUDBG_CLK, cudbg_collect_clk_info },\n\t{ CUDBG_CIM_OBQ_RXQ0, cudbg_collect_obq_sge_rx_q0 },\n\t{ CUDBG_CIM_OBQ_RXQ1, cudbg_collect_obq_sge_rx_q1 },\n\t{ CUDBG_PCIE_INDIRECT, cudbg_collect_pcie_indirect },\n\t{ CUDBG_PM_INDIRECT, cudbg_collect_pm_indirect },\n\t{ CUDBG_TID_INFO, cudbg_collect_tid },\n\t{ CUDBG_PCIE_CONFIG, cudbg_collect_pcie_config },\n\t{ CUDBG_DUMP_CONTEXT, cudbg_collect_dump_context },\n\t{ CUDBG_MPS_TCAM, cudbg_collect_mps_tcam },\n\t{ CUDBG_VPD_DATA, cudbg_collect_vpd_data },\n\t{ CUDBG_LE_TCAM, cudbg_collect_le_tcam },\n\t{ CUDBG_CCTRL, cudbg_collect_cctrl },\n\t{ CUDBG_MA_INDIRECT, cudbg_collect_ma_indirect },\n\t{ CUDBG_ULPTX_LA, cudbg_collect_ulptx_la },\n\t{ CUDBG_UP_CIM_INDIRECT, cudbg_collect_up_cim_indirect },\n\t{ CUDBG_PBT_TABLE, cudbg_collect_pbt_tables },\n\t{ CUDBG_HMA_INDIRECT, cudbg_collect_hma_indirect },\n};\n\nstatic const struct cxgb4_collect_entity cxgb4_collect_flash_dump[] = {\n\t{ CUDBG_FLASH, cudbg_collect_flash },\n};\n\nu32 cxgb4_get_dump_length(struct adapter *adap, u32 flag)\n{\n\tu32 i, entity;\n\tu32 len = 0;\n\tu32 wsize;\n\n\tif (flag & CXGB4_ETH_DUMP_HW) {\n\t\tfor (i = 0; i < ARRAY_SIZE(cxgb4_collect_hw_dump); i++) {\n\t\t\tentity = cxgb4_collect_hw_dump[i].entity;\n\t\t\tlen += cudbg_get_entity_length(adap, entity);\n\t\t}\n\t}\n\n\tif (flag & CXGB4_ETH_DUMP_MEM) {\n\t\tfor (i = 0; i < ARRAY_SIZE(cxgb4_collect_mem_dump); i++) {\n\t\t\tentity = cxgb4_collect_mem_dump[i].entity;\n\t\t\tlen += cudbg_get_entity_length(adap, entity);\n\t\t}\n\t}\n\n\tif (flag & CXGB4_ETH_DUMP_FLASH)\n\t\tlen += adap->params.sf_size;\n\n\t \n\twsize = cudbg_get_workspace_size();\n\tif (wsize && len > CUDBG_DUMP_BUFF_SIZE)\n\t\tlen = CUDBG_DUMP_BUFF_SIZE;\n\n\treturn len;\n}\n\nstatic void cxgb4_cudbg_collect_entity(struct cudbg_init *pdbg_init,\n\t\t\t\t       struct cudbg_buffer *dbg_buff,\n\t\t\t\t       const struct cxgb4_collect_entity *e_arr,\n\t\t\t\t       u32 arr_size, void *buf, u32 *tot_size)\n{\n\tstruct cudbg_error cudbg_err = { 0 };\n\tstruct cudbg_entity_hdr *entity_hdr;\n\tu32 i, total_size = 0;\n\tint ret;\n\n\tfor (i = 0; i < arr_size; i++) {\n\t\tconst struct cxgb4_collect_entity *e = &e_arr[i];\n\n\t\tentity_hdr = cudbg_get_entity_hdr(buf, e->entity);\n\t\tentity_hdr->entity_type = e->entity;\n\t\tentity_hdr->start_offset = dbg_buff->offset;\n\t\tmemset(&cudbg_err, 0, sizeof(struct cudbg_error));\n\t\tret = e->collect_cb(pdbg_init, dbg_buff, &cudbg_err);\n\t\tif (ret) {\n\t\t\tentity_hdr->size = 0;\n\t\t\tdbg_buff->offset = entity_hdr->start_offset;\n\t\t} else {\n\t\t\tcudbg_align_debug_buffer(dbg_buff, entity_hdr);\n\t\t}\n\n\t\t \n\t\tif (cudbg_err.sys_err)\n\t\t\tret = CUDBG_SYSTEM_ERROR;\n\n\t\tentity_hdr->hdr_flags = ret;\n\t\tentity_hdr->sys_err = cudbg_err.sys_err;\n\t\tentity_hdr->sys_warn = cudbg_err.sys_warn;\n\t\ttotal_size += entity_hdr->size;\n\t}\n\n\t*tot_size += total_size;\n}\n\nstatic int cudbg_alloc_compress_buff(struct cudbg_init *pdbg_init)\n{\n\tu32 workspace_size;\n\n\tworkspace_size = cudbg_get_workspace_size();\n\tpdbg_init->compress_buff = vzalloc(CUDBG_COMPRESS_BUFF_SIZE +\n\t\t\t\t\t   workspace_size);\n\tif (!pdbg_init->compress_buff)\n\t\treturn -ENOMEM;\n\n\tpdbg_init->compress_buff_size = CUDBG_COMPRESS_BUFF_SIZE;\n\tpdbg_init->workspace = (u8 *)pdbg_init->compress_buff +\n\t\t\t       CUDBG_COMPRESS_BUFF_SIZE - workspace_size;\n\treturn 0;\n}\n\nstatic void cudbg_free_compress_buff(struct cudbg_init *pdbg_init)\n{\n\tvfree(pdbg_init->compress_buff);\n}\n\nint cxgb4_cudbg_collect(struct adapter *adap, void *buf, u32 *buf_size,\n\t\t\tu32 flag)\n{\n\tstruct cudbg_buffer dbg_buff = { 0 };\n\tu32 size, min_size, total_size = 0;\n\tstruct cudbg_init cudbg_init;\n\tstruct cudbg_hdr *cudbg_hdr;\n\tint rc;\n\n\tsize = *buf_size;\n\n\tmemset(&cudbg_init, 0, sizeof(struct cudbg_init));\n\tcudbg_init.adap = adap;\n\tcudbg_init.outbuf = buf;\n\tcudbg_init.outbuf_size = size;\n\n\tdbg_buff.data = buf;\n\tdbg_buff.size = size;\n\tdbg_buff.offset = 0;\n\n\tcudbg_hdr = (struct cudbg_hdr *)buf;\n\tcudbg_hdr->signature = CUDBG_SIGNATURE;\n\tcudbg_hdr->hdr_len = sizeof(struct cudbg_hdr);\n\tcudbg_hdr->major_ver = CUDBG_MAJOR_VERSION;\n\tcudbg_hdr->minor_ver = CUDBG_MINOR_VERSION;\n\tcudbg_hdr->max_entities = CUDBG_MAX_ENTITY;\n\tcudbg_hdr->chip_ver = adap->params.chip;\n\tcudbg_hdr->dump_type = CUDBG_DUMP_TYPE_MINI;\n\n\tmin_size = sizeof(struct cudbg_hdr) +\n\t\t   sizeof(struct cudbg_entity_hdr) *\n\t\t   cudbg_hdr->max_entities;\n\tif (size < min_size)\n\t\treturn -ENOMEM;\n\n\trc = cudbg_get_workspace_size();\n\tif (rc) {\n\t\t \n\t\tcudbg_init.compress_type = CUDBG_COMPRESSION_ZLIB;\n\t\trc = cudbg_alloc_compress_buff(&cudbg_init);\n\t\tif (rc) {\n\t\t\t \n\t\t\tdev_warn(adap->pdev_dev,\n\t\t\t\t \"Fail allocating compression buffer ret: %d.  Continuing without compression.\\n\",\n\t\t\t\t rc);\n\t\t\tcudbg_init.compress_type = CUDBG_COMPRESSION_NONE;\n\t\t\trc = 0;\n\t\t}\n\t} else {\n\t\tcudbg_init.compress_type = CUDBG_COMPRESSION_NONE;\n\t}\n\n\tcudbg_hdr->compress_type = cudbg_init.compress_type;\n\tdbg_buff.offset += min_size;\n\ttotal_size = dbg_buff.offset;\n\n\tif (flag & CXGB4_ETH_DUMP_HW)\n\t\tcxgb4_cudbg_collect_entity(&cudbg_init, &dbg_buff,\n\t\t\t\t\t   cxgb4_collect_hw_dump,\n\t\t\t\t\t   ARRAY_SIZE(cxgb4_collect_hw_dump),\n\t\t\t\t\t   buf,\n\t\t\t\t\t   &total_size);\n\n\tif (flag & CXGB4_ETH_DUMP_MEM)\n\t\tcxgb4_cudbg_collect_entity(&cudbg_init, &dbg_buff,\n\t\t\t\t\t   cxgb4_collect_mem_dump,\n\t\t\t\t\t   ARRAY_SIZE(cxgb4_collect_mem_dump),\n\t\t\t\t\t   buf,\n\t\t\t\t\t   &total_size);\n\n\tif (flag & CXGB4_ETH_DUMP_FLASH)\n\t\tcxgb4_cudbg_collect_entity(&cudbg_init, &dbg_buff,\n\t\t\t\t\t   cxgb4_collect_flash_dump,\n\t\t\t\t\t   ARRAY_SIZE(cxgb4_collect_flash_dump),\n\t\t\t\t\t   buf,\n\t\t\t\t\t   &total_size);\n\n\tcudbg_free_compress_buff(&cudbg_init);\n\tcudbg_hdr->data_len = total_size;\n\tif (cudbg_init.compress_type != CUDBG_COMPRESSION_NONE)\n\t\t*buf_size = size;\n\telse\n\t\t*buf_size = total_size;\n\treturn 0;\n}\n\nvoid cxgb4_init_ethtool_dump(struct adapter *adapter)\n{\n\tadapter->eth_dump.flag = CXGB4_ETH_DUMP_NONE;\n\tadapter->eth_dump.version = adapter->params.fw_vers;\n\tadapter->eth_dump.len = 0;\n}\n\nstatic int cxgb4_cudbg_vmcoredd_collect(struct vmcoredd_data *data, void *buf)\n{\n\tstruct adapter *adap = container_of(data, struct adapter, vmcoredd);\n\tu32 len = data->size;\n\n\treturn cxgb4_cudbg_collect(adap, buf, &len, CXGB4_ETH_DUMP_ALL);\n}\n\nint cxgb4_cudbg_vmcore_add_dump(struct adapter *adap)\n{\n\tstruct vmcoredd_data *data = &adap->vmcoredd;\n\tu32 len;\n\n\tlen = sizeof(struct cudbg_hdr) +\n\t      sizeof(struct cudbg_entity_hdr) * CUDBG_MAX_ENTITY;\n\tlen += CUDBG_DUMP_BUFF_SIZE;\n\n\tdata->size = len;\n\tsnprintf(data->dump_name, sizeof(data->dump_name), \"%s_%s\",\n\t\t cxgb4_driver_name, adap->name);\n\tdata->vmcoredd_callback = cxgb4_cudbg_vmcoredd_collect;\n\n\treturn vmcore_add_device_dump(data);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}