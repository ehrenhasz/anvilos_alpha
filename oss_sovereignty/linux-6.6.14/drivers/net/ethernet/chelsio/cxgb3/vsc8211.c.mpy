{
  "module_name": "vsc8211.c",
  "hash_id": "09d1d0560b0ffdf0cf645c5bf16803e4f67344134c5ad76654d63c0a6300e83d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/chelsio/cxgb3/vsc8211.c",
  "human_readable_source": " \n#include \"common.h\"\n\n \nenum {\n\tVSC8211_SIGDET_CTRL = 19,\n\tVSC8211_EXT_CTRL = 23,\n\tVSC8211_INTR_ENABLE = 25,\n\tVSC8211_INTR_STATUS = 26,\n\tVSC8211_LED_CTRL = 27,\n\tVSC8211_AUX_CTRL_STAT = 28,\n\tVSC8211_EXT_PAGE_AXS = 31,\n};\n\nenum {\n\tVSC_INTR_RX_ERR = 1 << 0,\n\tVSC_INTR_MS_ERR = 1 << 1,   \n\tVSC_INTR_CABLE = 1 << 2,   \n\tVSC_INTR_FALSE_CARR = 1 << 3,   \n\tVSC_INTR_MEDIA_CHG = 1 << 4,   \n\tVSC_INTR_RX_FIFO = 1 << 5,   \n\tVSC_INTR_TX_FIFO = 1 << 6,   \n\tVSC_INTR_DESCRAMBL = 1 << 7,   \n\tVSC_INTR_SYMBOL_ERR = 1 << 8,   \n\tVSC_INTR_NEG_DONE = 1 << 10,  \n\tVSC_INTR_NEG_ERR = 1 << 11,  \n\tVSC_INTR_DPLX_CHG = 1 << 12,  \n\tVSC_INTR_LINK_CHG = 1 << 13,  \n\tVSC_INTR_SPD_CHG = 1 << 14,  \n\tVSC_INTR_ENABLE = 1 << 15,  \n};\n\nenum {\n\tVSC_CTRL_CLAUSE37_VIEW = 1 << 4,    \n\tVSC_CTRL_MEDIA_MODE_HI = 0xf000     \n};\n\n#define CFG_CHG_INTR_MASK (VSC_INTR_LINK_CHG | VSC_INTR_NEG_ERR | \\\n\t\t\t   VSC_INTR_DPLX_CHG | VSC_INTR_SPD_CHG | \\\n\t \t\t   VSC_INTR_NEG_DONE)\n#define INTR_MASK (CFG_CHG_INTR_MASK | VSC_INTR_TX_FIFO | VSC_INTR_RX_FIFO | \\\n\t\t   VSC_INTR_ENABLE)\n\n \n#define S_ACSR_ACTIPHY_TMR    0\n#define M_ACSR_ACTIPHY_TMR    0x3\n#define V_ACSR_ACTIPHY_TMR(x) ((x) << S_ACSR_ACTIPHY_TMR)\n\n#define S_ACSR_SPEED    3\n#define M_ACSR_SPEED    0x3\n#define G_ACSR_SPEED(x) (((x) >> S_ACSR_SPEED) & M_ACSR_SPEED)\n\n#define S_ACSR_DUPLEX 5\n#define F_ACSR_DUPLEX (1 << S_ACSR_DUPLEX)\n\n#define S_ACSR_ACTIPHY 6\n#define F_ACSR_ACTIPHY (1 << S_ACSR_ACTIPHY)\n\n \nstatic int vsc8211_reset(struct cphy *cphy, int wait)\n{\n\treturn t3_phy_reset(cphy, MDIO_DEVAD_NONE, 0);\n}\n\nstatic int vsc8211_intr_enable(struct cphy *cphy)\n{\n\treturn t3_mdio_write(cphy, MDIO_DEVAD_NONE, VSC8211_INTR_ENABLE,\n\t\t\t     INTR_MASK);\n}\n\nstatic int vsc8211_intr_disable(struct cphy *cphy)\n{\n\treturn t3_mdio_write(cphy, MDIO_DEVAD_NONE, VSC8211_INTR_ENABLE, 0);\n}\n\nstatic int vsc8211_intr_clear(struct cphy *cphy)\n{\n\tu32 val;\n\n\t \n\treturn t3_mdio_read(cphy, MDIO_DEVAD_NONE, VSC8211_INTR_STATUS, &val);\n}\n\nstatic int vsc8211_autoneg_enable(struct cphy *cphy)\n{\n\treturn t3_mdio_change_bits(cphy, MDIO_DEVAD_NONE, MII_BMCR,\n\t\t\t\t   BMCR_PDOWN | BMCR_ISOLATE,\n\t\t\t\t   BMCR_ANENABLE | BMCR_ANRESTART);\n}\n\nstatic int vsc8211_autoneg_restart(struct cphy *cphy)\n{\n\treturn t3_mdio_change_bits(cphy, MDIO_DEVAD_NONE, MII_BMCR,\n\t\t\t\t   BMCR_PDOWN | BMCR_ISOLATE,\n\t\t\t\t   BMCR_ANRESTART);\n}\n\nstatic int vsc8211_get_link_status(struct cphy *cphy, int *link_ok,\n\t\t\t\t   int *speed, int *duplex, int *fc)\n{\n\tunsigned int bmcr, status, lpa, adv;\n\tint err, sp = -1, dplx = -1, pause = 0;\n\n\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMCR, &bmcr);\n\tif (!err)\n\t\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMSR, &status);\n\tif (err)\n\t\treturn err;\n\n\tif (link_ok) {\n\t\t \n\t\tif (!(status & BMSR_LSTATUS))\n\t\t\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMSR,\n\t\t\t\t\t   &status);\n\t\tif (err)\n\t\t\treturn err;\n\t\t*link_ok = (status & BMSR_LSTATUS) != 0;\n\t}\n\tif (!(bmcr & BMCR_ANENABLE)) {\n\t\tdplx = (bmcr & BMCR_FULLDPLX) ? DUPLEX_FULL : DUPLEX_HALF;\n\t\tif (bmcr & BMCR_SPEED1000)\n\t\t\tsp = SPEED_1000;\n\t\telse if (bmcr & BMCR_SPEED100)\n\t\t\tsp = SPEED_100;\n\t\telse\n\t\t\tsp = SPEED_10;\n\t} else if (status & BMSR_ANEGCOMPLETE) {\n\t\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, VSC8211_AUX_CTRL_STAT,\n\t\t\t\t   &status);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tdplx = (status & F_ACSR_DUPLEX) ? DUPLEX_FULL : DUPLEX_HALF;\n\t\tsp = G_ACSR_SPEED(status);\n\t\tif (sp == 0)\n\t\t\tsp = SPEED_10;\n\t\telse if (sp == 1)\n\t\t\tsp = SPEED_100;\n\t\telse\n\t\t\tsp = SPEED_1000;\n\n\t\tif (fc && dplx == DUPLEX_FULL) {\n\t\t\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_LPA,\n\t\t\t\t\t   &lpa);\n\t\t\tif (!err)\n\t\t\t\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE,\n\t\t\t\t\t\t   MII_ADVERTISE, &adv);\n\t\t\tif (err)\n\t\t\t\treturn err;\n\n\t\t\tif (lpa & adv & ADVERTISE_PAUSE_CAP)\n\t\t\t\tpause = PAUSE_RX | PAUSE_TX;\n\t\t\telse if ((lpa & ADVERTISE_PAUSE_CAP) &&\n\t\t\t\t (lpa & ADVERTISE_PAUSE_ASYM) &&\n\t\t\t\t (adv & ADVERTISE_PAUSE_ASYM))\n\t\t\t\tpause = PAUSE_TX;\n\t\t\telse if ((lpa & ADVERTISE_PAUSE_ASYM) &&\n\t\t\t\t (adv & ADVERTISE_PAUSE_CAP))\n\t\t\t\tpause = PAUSE_RX;\n\t\t}\n\t}\n\tif (speed)\n\t\t*speed = sp;\n\tif (duplex)\n\t\t*duplex = dplx;\n\tif (fc)\n\t\t*fc = pause;\n\treturn 0;\n}\n\nstatic int vsc8211_get_link_status_fiber(struct cphy *cphy, int *link_ok,\n\t\t\t\t\t int *speed, int *duplex, int *fc)\n{\n\tunsigned int bmcr, status, lpa, adv;\n\tint err, sp = -1, dplx = -1, pause = 0;\n\n\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMCR, &bmcr);\n\tif (!err)\n\t\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMSR, &status);\n\tif (err)\n\t\treturn err;\n\n\tif (link_ok) {\n\t\t \n\t\tif (!(status & BMSR_LSTATUS))\n\t\t\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMSR,\n\t\t\t\t\t   &status);\n\t\tif (err)\n\t\t\treturn err;\n\t\t*link_ok = (status & BMSR_LSTATUS) != 0;\n\t}\n\tif (!(bmcr & BMCR_ANENABLE)) {\n\t\tdplx = (bmcr & BMCR_FULLDPLX) ? DUPLEX_FULL : DUPLEX_HALF;\n\t\tif (bmcr & BMCR_SPEED1000)\n\t\t\tsp = SPEED_1000;\n\t\telse if (bmcr & BMCR_SPEED100)\n\t\t\tsp = SPEED_100;\n\t\telse\n\t\t\tsp = SPEED_10;\n\t} else if (status & BMSR_ANEGCOMPLETE) {\n\t\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_LPA, &lpa);\n\t\tif (!err)\n\t\t\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_ADVERTISE,\n\t\t\t\t\t   &adv);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tif (adv & lpa & ADVERTISE_1000XFULL) {\n\t\t\tdplx = DUPLEX_FULL;\n\t\t\tsp = SPEED_1000;\n\t\t} else if (adv & lpa & ADVERTISE_1000XHALF) {\n\t\t\tdplx = DUPLEX_HALF;\n\t\t\tsp = SPEED_1000;\n\t\t}\n\n\t\tif (fc && dplx == DUPLEX_FULL) {\n\t\t\tif (lpa & adv & ADVERTISE_1000XPAUSE)\n\t\t\t\tpause = PAUSE_RX | PAUSE_TX;\n\t\t\telse if ((lpa & ADVERTISE_1000XPAUSE) &&\n\t\t\t\t (adv & lpa & ADVERTISE_1000XPSE_ASYM))\n\t\t\t\tpause = PAUSE_TX;\n\t\t\telse if ((lpa & ADVERTISE_1000XPSE_ASYM) &&\n\t\t\t\t (adv & ADVERTISE_1000XPAUSE))\n\t\t\t\tpause = PAUSE_RX;\n\t\t}\n\t}\n\tif (speed)\n\t\t*speed = sp;\n\tif (duplex)\n\t\t*duplex = dplx;\n\tif (fc)\n\t\t*fc = pause;\n\treturn 0;\n}\n\n#ifdef UNUSED\n \nstatic int vsc8211_set_automdi(struct cphy *phy, int enable)\n{\n\tint err;\n\n\terr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_EXT_PAGE_AXS, 0x52b5);\n\tif (err)\n\t\treturn err;\n\n\terr = t3_mdio_write(phy, MDIO_DEVAD_NONE, 18, 0x12);\n\tif (err)\n\t\treturn err;\n\n\terr = t3_mdio_write(phy, MDIO_DEVAD_NONE, 17, enable ? 0x2803 : 0x3003);\n\tif (err)\n\t\treturn err;\n\n\terr = t3_mdio_write(phy, MDIO_DEVAD_NONE, 16, 0x87fa);\n\tif (err)\n\t\treturn err;\n\n\terr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_EXT_PAGE_AXS, 0);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\nint vsc8211_set_speed_duplex(struct cphy *phy, int speed, int duplex)\n{\n\tint err;\n\n\terr = t3_set_phy_speed_duplex(phy, speed, duplex);\n\tif (!err)\n\t\terr = vsc8211_set_automdi(phy, 1);\n\treturn err;\n}\n#endif  \n\nstatic int vsc8211_power_down(struct cphy *cphy, int enable)\n{\n\treturn t3_mdio_change_bits(cphy, 0, MII_BMCR, BMCR_PDOWN,\n\t\t\t\t   enable ? BMCR_PDOWN : 0);\n}\n\nstatic int vsc8211_intr_handler(struct cphy *cphy)\n{\n\tunsigned int cause;\n\tint err, cphy_cause = 0;\n\n\terr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, VSC8211_INTR_STATUS, &cause);\n\tif (err)\n\t\treturn err;\n\n\tcause &= INTR_MASK;\n\tif (cause & CFG_CHG_INTR_MASK)\n\t\tcphy_cause |= cphy_cause_link_change;\n\tif (cause & (VSC_INTR_RX_FIFO | VSC_INTR_TX_FIFO))\n\t\tcphy_cause |= cphy_cause_fifo_error;\n\treturn cphy_cause;\n}\n\nstatic const struct cphy_ops vsc8211_ops = {\n\t.reset = vsc8211_reset,\n\t.intr_enable = vsc8211_intr_enable,\n\t.intr_disable = vsc8211_intr_disable,\n\t.intr_clear = vsc8211_intr_clear,\n\t.intr_handler = vsc8211_intr_handler,\n\t.autoneg_enable = vsc8211_autoneg_enable,\n\t.autoneg_restart = vsc8211_autoneg_restart,\n\t.advertise = t3_phy_advertise,\n\t.set_speed_duplex = t3_set_phy_speed_duplex,\n\t.get_link_status = vsc8211_get_link_status,\n\t.power_down = vsc8211_power_down,\n};\n\nstatic const struct cphy_ops vsc8211_fiber_ops = {\n\t.reset = vsc8211_reset,\n\t.intr_enable = vsc8211_intr_enable,\n\t.intr_disable = vsc8211_intr_disable,\n\t.intr_clear = vsc8211_intr_clear,\n\t.intr_handler = vsc8211_intr_handler,\n\t.autoneg_enable = vsc8211_autoneg_enable,\n\t.autoneg_restart = vsc8211_autoneg_restart,\n\t.advertise = t3_phy_advertise_fiber,\n\t.set_speed_duplex = t3_set_phy_speed_duplex,\n\t.get_link_status = vsc8211_get_link_status_fiber,\n\t.power_down = vsc8211_power_down,\n};\n\nint t3_vsc8211_phy_prep(struct cphy *phy, struct adapter *adapter,\n\t\t\tint phy_addr, const struct mdio_ops *mdio_ops)\n{\n\tint err;\n\tunsigned int val;\n\n\tcphy_init(phy, adapter, phy_addr, &vsc8211_ops, mdio_ops,\n\t\t  SUPPORTED_10baseT_Full | SUPPORTED_100baseT_Full |\n\t\t  SUPPORTED_1000baseT_Full | SUPPORTED_Autoneg | SUPPORTED_MII |\n\t\t  SUPPORTED_TP | SUPPORTED_IRQ, \"10/100/1000BASE-T\");\n\tmsleep(20);        \n\n\terr = t3_mdio_read(phy, MDIO_DEVAD_NONE, VSC8211_EXT_CTRL, &val);\n\tif (err)\n\t\treturn err;\n\tif (val & VSC_CTRL_MEDIA_MODE_HI) {\n\t\t \n\t\treturn t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_LED_CTRL,\n\t\t\t\t     0x100);\n\t}\n\n\tphy->caps = SUPPORTED_1000baseT_Full | SUPPORTED_Autoneg |\n\t\t    SUPPORTED_MII | SUPPORTED_FIBRE | SUPPORTED_IRQ;\n\tphy->desc = \"1000BASE-X\";\n\tphy->ops = &vsc8211_fiber_ops;\n\n\terr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_EXT_PAGE_AXS, 1);\n\tif (err)\n\t\treturn err;\n\n\terr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_SIGDET_CTRL, 1);\n\tif (err)\n\t\treturn err;\n\n\terr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_EXT_PAGE_AXS, 0);\n\tif (err)\n\t\treturn err;\n\n\terr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_EXT_CTRL,\n\t\t\t    val | VSC_CTRL_CLAUSE37_VIEW);\n\tif (err)\n\t\treturn err;\n\n\terr = vsc8211_reset(phy, 0);\n\tif (err)\n\t\treturn err;\n\n\tudelay(5);  \n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}