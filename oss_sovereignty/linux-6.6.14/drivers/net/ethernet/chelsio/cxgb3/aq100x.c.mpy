{
  "module_name": "aq100x.c",
  "hash_id": "8d2efcaa30beba2a55136ba7925a8fec99c8b5838af4fb39cc31a346e0d295ad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/chelsio/cxgb3/aq100x.c",
  "human_readable_source": " \n\n#include \"common.h\"\n#include \"regs.h\"\n\nenum {\n\t \n\tAQ_LINK_STAT\t= 0xe800,\n\tAQ_IMASK_PMA\t= 0xf000,\n\n\t \n\tAQ_XAUI_RX_CFG\t= 0xc400,\n\tAQ_XAUI_TX_CFG\t= 0xe400,\n\n\t \n\tAQ_1G_CTRL\t= 0xc400,\n\tAQ_ANEG_STAT\t= 0xc800,\n\n\t \n\tAQ_FW_VERSION\t= 0x0020,\n\tAQ_IFLAG_GLOBAL\t= 0xfc00,\n\tAQ_IMASK_GLOBAL\t= 0xff00,\n};\n\nenum {\n\tIMASK_PMA\t= 1 << 2,\n\tIMASK_GLOBAL\t= 1 << 15,\n\tADV_1G_FULL\t= 1 << 15,\n\tADV_1G_HALF\t= 1 << 14,\n\tADV_10G_FULL\t= 1 << 12,\n\tAQ_RESET\t= (1 << 14) | (1 << 15),\n\tAQ_LOWPOWER\t= 1 << 12,\n};\n\nstatic int aq100x_reset(struct cphy *phy, int wait)\n{\n\t \n\tint err = t3_phy_reset(phy, MDIO_MMD_VEND1, 3000);\n\n\tif (err)\n\t\tCH_WARN(phy->adapter, \"PHY%d: reset failed (0x%x).\\n\",\n\t\t\tphy->mdio.prtad, err);\n\n\treturn err;\n}\n\nstatic int aq100x_intr_enable(struct cphy *phy)\n{\n\tint err = t3_mdio_write(phy, MDIO_MMD_PMAPMD, AQ_IMASK_PMA, IMASK_PMA);\n\tif (err)\n\t\treturn err;\n\n\terr = t3_mdio_write(phy, MDIO_MMD_VEND1, AQ_IMASK_GLOBAL, IMASK_GLOBAL);\n\treturn err;\n}\n\nstatic int aq100x_intr_disable(struct cphy *phy)\n{\n\treturn t3_mdio_write(phy, MDIO_MMD_VEND1, AQ_IMASK_GLOBAL, 0);\n}\n\nstatic int aq100x_intr_clear(struct cphy *phy)\n{\n\tunsigned int v;\n\n\tt3_mdio_read(phy, MDIO_MMD_VEND1, AQ_IFLAG_GLOBAL, &v);\n\tt3_mdio_read(phy, MDIO_MMD_PMAPMD, MDIO_STAT1, &v);\n\n\treturn 0;\n}\n\nstatic int aq100x_intr_handler(struct cphy *phy)\n{\n\tint err;\n\tunsigned int cause, v;\n\n\terr = t3_mdio_read(phy, MDIO_MMD_VEND1, AQ_IFLAG_GLOBAL, &cause);\n\tif (err)\n\t\treturn err;\n\n\t \n\tt3_mdio_read(phy, MDIO_MMD_PMAPMD, MDIO_STAT1, &v);\n\n\treturn cphy_cause_link_change;\n}\n\nstatic int aq100x_power_down(struct cphy *phy, int off)\n{\n\treturn mdio_set_flag(&phy->mdio, phy->mdio.prtad,\n\t\t\t     MDIO_MMD_PMAPMD, MDIO_CTRL1,\n\t\t\t     MDIO_CTRL1_LPOWER, off);\n}\n\nstatic int aq100x_autoneg_enable(struct cphy *phy)\n{\n\tint err;\n\n\terr = aq100x_power_down(phy, 0);\n\tif (!err)\n\t\terr = mdio_set_flag(&phy->mdio, phy->mdio.prtad,\n\t\t\t\t    MDIO_MMD_AN, MDIO_CTRL1,\n\t\t\t\t    BMCR_ANENABLE | BMCR_ANRESTART, 1);\n\n\treturn err;\n}\n\nstatic int aq100x_autoneg_restart(struct cphy *phy)\n{\n\tint err;\n\n\terr = aq100x_power_down(phy, 0);\n\tif (!err)\n\t\terr = mdio_set_flag(&phy->mdio, phy->mdio.prtad,\n\t\t\t\t    MDIO_MMD_AN, MDIO_CTRL1,\n\t\t\t\t    BMCR_ANENABLE | BMCR_ANRESTART, 1);\n\n\treturn err;\n}\n\nstatic int aq100x_advertise(struct cphy *phy, unsigned int advertise_map)\n{\n\tunsigned int adv;\n\tint err;\n\n\t \n\tadv = 0;\n\tif (advertise_map & ADVERTISED_10000baseT_Full)\n\t\tadv |= ADV_10G_FULL;\n\terr = t3_mdio_change_bits(phy, MDIO_MMD_AN, MDIO_AN_10GBT_CTRL,\n\t\t\t\t  ADV_10G_FULL, adv);\n\tif (err)\n\t\treturn err;\n\n\t \n\tadv = 0;\n\tif (advertise_map & ADVERTISED_1000baseT_Full)\n\t\tadv |= ADV_1G_FULL;\n\tif (advertise_map & ADVERTISED_1000baseT_Half)\n\t\tadv |= ADV_1G_HALF;\n\terr = t3_mdio_change_bits(phy, MDIO_MMD_AN, AQ_1G_CTRL,\n\t\t\t\t  ADV_1G_FULL | ADV_1G_HALF, adv);\n\tif (err)\n\t\treturn err;\n\n\t \n\tadv = 0;\n\tif (advertise_map & ADVERTISED_100baseT_Half)\n\t\tadv |= ADVERTISE_100HALF;\n\tif (advertise_map & ADVERTISED_100baseT_Full)\n\t\tadv |= ADVERTISE_100FULL;\n\tif (advertise_map & ADVERTISED_Pause)\n\t\tadv |= ADVERTISE_PAUSE_CAP;\n\tif (advertise_map & ADVERTISED_Asym_Pause)\n\t\tadv |= ADVERTISE_PAUSE_ASYM;\n\terr = t3_mdio_change_bits(phy, MDIO_MMD_AN, MDIO_AN_ADVERTISE,\n\t\t\t\t  0xfe0, adv);\n\n\treturn err;\n}\n\nstatic int aq100x_set_loopback(struct cphy *phy, int mmd, int dir, int enable)\n{\n\treturn mdio_set_flag(&phy->mdio, phy->mdio.prtad,\n\t\t\t     MDIO_MMD_PMAPMD, MDIO_CTRL1,\n\t\t\t     BMCR_LOOPBACK, enable);\n}\n\nstatic int aq100x_set_speed_duplex(struct cphy *phy, int speed, int duplex)\n{\n\t \n\treturn -1;\n}\n\nstatic int aq100x_get_link_status(struct cphy *phy, int *link_ok,\n\t\t\t\t  int *speed, int *duplex, int *fc)\n{\n\tint err;\n\tunsigned int v;\n\n\tif (link_ok) {\n\t\terr = t3_mdio_read(phy, MDIO_MMD_PMAPMD, AQ_LINK_STAT, &v);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\t*link_ok = v & 1;\n\t\tif (!*link_ok)\n\t\t\treturn 0;\n\t}\n\n\terr = t3_mdio_read(phy, MDIO_MMD_AN, AQ_ANEG_STAT, &v);\n\tif (err)\n\t\treturn err;\n\n\tif (speed) {\n\t\tswitch (v & 0x6) {\n\t\tcase 0x6:\n\t\t\t*speed = SPEED_10000;\n\t\t\tbreak;\n\t\tcase 0x4:\n\t\t\t*speed = SPEED_1000;\n\t\t\tbreak;\n\t\tcase 0x2:\n\t\t\t*speed = SPEED_100;\n\t\t\tbreak;\n\t\tcase 0x0:\n\t\t\t*speed = SPEED_10;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (duplex)\n\t\t*duplex = v & 1 ? DUPLEX_FULL : DUPLEX_HALF;\n\n\treturn 0;\n}\n\nstatic const struct cphy_ops aq100x_ops = {\n\t.reset             = aq100x_reset,\n\t.intr_enable       = aq100x_intr_enable,\n\t.intr_disable      = aq100x_intr_disable,\n\t.intr_clear        = aq100x_intr_clear,\n\t.intr_handler      = aq100x_intr_handler,\n\t.autoneg_enable    = aq100x_autoneg_enable,\n\t.autoneg_restart   = aq100x_autoneg_restart,\n\t.advertise         = aq100x_advertise,\n\t.set_loopback      = aq100x_set_loopback,\n\t.set_speed_duplex  = aq100x_set_speed_duplex,\n\t.get_link_status   = aq100x_get_link_status,\n\t.power_down        = aq100x_power_down,\n\t.mmds \t\t   = MDIO_DEVS_PMAPMD | MDIO_DEVS_PCS | MDIO_DEVS_PHYXS,\n};\n\nint t3_aq100x_phy_prep(struct cphy *phy, struct adapter *adapter, int phy_addr,\n\t\t       const struct mdio_ops *mdio_ops)\n{\n\tunsigned int v, v2, gpio, wait;\n\tint err;\n\n\tcphy_init(phy, adapter, phy_addr, &aq100x_ops, mdio_ops,\n\t\t  SUPPORTED_1000baseT_Full | SUPPORTED_10000baseT_Full |\n\t\t  SUPPORTED_TP | SUPPORTED_Autoneg | SUPPORTED_AUI,\n\t\t  \"1000/10GBASE-T\");\n\n\t \n\tgpio = phy_addr ? F_GPIO10_OUT_VAL : F_GPIO6_OUT_VAL;\n\tt3_set_reg_field(adapter, A_T3DBG_GPIO_EN, gpio, 0);\n\tmsleep(1);\n\tt3_set_reg_field(adapter, A_T3DBG_GPIO_EN, gpio, gpio);\n\n\t \n\tmsleep(1000);\n\twait = 500;  \n\tdo {\n\t\terr = t3_mdio_read(phy, MDIO_MMD_VEND1, MDIO_CTRL1, &v);\n\t\tif (err || v == 0xffff) {\n\n\t\t\t \n\n\t\t\tCH_WARN(adapter, \"PHY%d: reset failed (0x%x, 0x%x).\\n\",\n\t\t\t\tphy_addr, err, v);\n\t\t\tgoto done;\n\t\t}\n\n\t\tv &= AQ_RESET;\n\t\tif (v)\n\t\t\tmsleep(10);\n\t} while (v && --wait);\n\tif (v) {\n\t\tCH_WARN(adapter, \"PHY%d: reset timed out (0x%x).\\n\",\n\t\t\tphy_addr, v);\n\n\t\tgoto done;  \n\t}\n\n\t \n\twait = (500 - wait) * 10 + 1000;\n\tif (wait > 3000)\n\t\tCH_WARN(adapter, \"PHY%d: reset took %ums\\n\", phy_addr, wait);\n\n\t \n\tt3_mdio_read(phy, MDIO_MMD_VEND1, AQ_FW_VERSION, &v);\n\tif (v != 101)\n\t\tCH_WARN(adapter, \"PHY%d: unsupported firmware %d\\n\",\n\t\t\tphy_addr, v);\n\n\t \n\terr = t3_mdio_read(phy, MDIO_MMD_VEND1, MDIO_CTRL1, &v);\n\tif (err)\n\t\treturn err;\n\tif (v & AQ_LOWPOWER) {\n\t\terr = t3_mdio_change_bits(phy, MDIO_MMD_VEND1, MDIO_CTRL1,\n\t\t\t\t\t  AQ_LOWPOWER, 0);\n\t\tif (err)\n\t\t\treturn err;\n\t\tmsleep(10);\n\t} else\n\t\tCH_WARN(adapter, \"PHY%d does not start in low power mode.\\n\",\n\t\t\tphy_addr);\n\n\t \n\tv = v2 = 0;\n\tt3_mdio_read(phy, MDIO_MMD_PHYXS, AQ_XAUI_RX_CFG, &v);\n\tt3_mdio_read(phy, MDIO_MMD_PHYXS, AQ_XAUI_TX_CFG, &v2);\n\tif (v != 0x1b || v2 != 0x1b)\n\t\tCH_WARN(adapter,\n\t\t\t\"PHY%d: incorrect XAUI settings (0x%x, 0x%x).\\n\",\n\t\t\tphy_addr, v, v2);\n\ndone:\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}