{
  "module_name": "libcxgb_ppm.h",
  "hash_id": "5ec439df5ecd741b5ef5b6650f426e42ade60a90d3514577e1a9ac08aa08393e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/chelsio/libcxgb/libcxgb_ppm.h",
  "human_readable_source": " \n\n#ifndef\t__LIBCXGB_PPM_H__\n#define\t__LIBCXGB_PPM_H__\n\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/types.h>\n#include <linux/debugfs.h>\n#include <linux/list.h>\n#include <linux/netdevice.h>\n#include <linux/scatterlist.h>\n#include <linux/skbuff.h>\n#include <linux/vmalloc.h>\n#include <linux/bitmap.h>\n\nstruct cxgbi_pagepod_hdr {\n\tu32 vld_tid;\n\tu32 pgsz_tag_clr;\n\tu32 max_offset;\n\tu32 page_offset;\n\tu64 rsvd;\n};\n\n#define PPOD_PAGES_MAX\t\t\t4\nstruct cxgbi_pagepod {\n\tstruct cxgbi_pagepod_hdr hdr;\n\t__be64 addr[PPOD_PAGES_MAX + 1];\n};\n\n \n\n#define DDP_PGIDX_MAX\t\t4\n#define DDP_PGSZ_BASE_SHIFT\t12\t \n\nstruct cxgbi_task_tag_info {\n\tunsigned char flags;\n#define CXGBI_PPOD_INFO_FLAG_VALID\t0x1\n#define CXGBI_PPOD_INFO_FLAG_MAPPED\t0x2\n\tunsigned char cid;\n\tunsigned short pg_shift;\n\tunsigned int npods;\n\tunsigned int idx;\n\tunsigned int tag;\n\tstruct cxgbi_pagepod_hdr hdr;\n\tint nents;\n\tint nr_pages;\n\tstruct scatterlist *sgl;\n};\n\nstruct cxgbi_tag_format {\n\tunsigned char pgsz_order[DDP_PGIDX_MAX];\n\tunsigned char pgsz_idx_dflt;\n\tunsigned char free_bits:4;\n\tunsigned char color_bits:4;\n\tunsigned char idx_bits;\n\tunsigned char rsvd_bits;\n\tunsigned int  no_ddp_mask;\n\tunsigned int  idx_mask;\n\tunsigned int  color_mask;\n\tunsigned int  idx_clr_mask;\n\tunsigned int  rsvd_mask;\n};\n\nstruct cxgbi_ppod_data {\n\tunsigned char pg_idx:2;\n\tunsigned char color:6;\n\tunsigned char chan_id;\n\tunsigned short npods;\n\tunsigned long caller_data;\n};\n\n \nstruct cxgbi_ppm_pool {\n\tunsigned int base;\t\t \n\tunsigned int next;\t\t \n\tspinlock_t lock;\t\t \n\tunsigned long bmap[];\n} ____cacheline_aligned_in_smp;\n\nstruct cxgbi_ppm {\n\tstruct kref refcnt;\n\tstruct net_device *ndev;\t \n\tstruct pci_dev *pdev;\n\tvoid *lldev;\n\tvoid **ppm_pp;\n\tstruct cxgbi_tag_format tformat;\n\tunsigned int ppmax;\n\tunsigned int llimit;\n\tunsigned int base_idx;\n\n\tunsigned int pool_rsvd;\n\tunsigned int pool_index_max;\n\tstruct cxgbi_ppm_pool __percpu *pool;\n\t \n\tspinlock_t map_lock;\t\t \n\tunsigned int bmap_index_max;\n\tunsigned int next;\n\tunsigned int max_index_in_edram;\n\tunsigned long *ppod_bmap;\n\tstruct cxgbi_ppod_data ppod_data[];\n};\n\n#define DDP_THRESHOLD\t\t512\n\n#define PPOD_PAGES_SHIFT\t2        \n\n#define IPPOD_SIZE               sizeof(struct cxgbi_pagepod)   \n#define PPOD_SIZE_SHIFT         6\n\n \n#define PPOD_CLUSTER_SIZE\t16U\n\n#define ULPMEM_DSGL_MAX_NPPODS\t16\t \n#define ULPMEM_IDATA_MAX_NPPODS\t3\t \n#define PCIE_MEMWIN_MAX_NPPODS\t16\t \n\n#define PPOD_COLOR_SHIFT\t0\n#define PPOD_COLOR(x)\t\t((x) << PPOD_COLOR_SHIFT)\n\n#define PPOD_IDX_SHIFT          6\n#define PPOD_IDX_MAX_SIZE       24\n\n#define PPOD_TID_SHIFT\t\t0\n#define PPOD_TID(x)\t\t((x) << PPOD_TID_SHIFT)\n\n#define PPOD_TAG_SHIFT\t\t6\n#define PPOD_TAG(x)\t\t((x) << PPOD_TAG_SHIFT)\n\n#define PPOD_VALID_SHIFT\t24\n#define PPOD_VALID(x)\t\t((x) << PPOD_VALID_SHIFT)\n#define PPOD_VALID_FLAG\t\tPPOD_VALID(1U)\n\n#define PPOD_PI_EXTRACT_CTL_SHIFT\t31\n#define PPOD_PI_EXTRACT_CTL(x)\t\t((x) << PPOD_PI_EXTRACT_CTL_SHIFT)\n#define PPOD_PI_EXTRACT_CTL_FLAG\tV_PPOD_PI_EXTRACT_CTL(1U)\n\n#define PPOD_PI_TYPE_SHIFT\t\t29\n#define PPOD_PI_TYPE_MASK\t\t0x3\n#define PPOD_PI_TYPE(x)\t\t\t((x) << PPOD_PI_TYPE_SHIFT)\n\n#define PPOD_PI_CHECK_CTL_SHIFT\t\t27\n#define PPOD_PI_CHECK_CTL_MASK\t\t0x3\n#define PPOD_PI_CHECK_CTL(x)\t\t((x) << PPOD_PI_CHECK_CTL_SHIFT)\n\n#define PPOD_PI_REPORT_CTL_SHIFT\t25\n#define PPOD_PI_REPORT_CTL_MASK\t\t0x3\n#define PPOD_PI_REPORT_CTL(x)\t\t((x) << PPOD_PI_REPORT_CTL_SHIFT)\n\nstatic inline int cxgbi_ppm_is_ddp_tag(struct cxgbi_ppm *ppm, u32 tag)\n{\n\treturn !(tag & ppm->tformat.no_ddp_mask);\n}\n\nstatic inline int cxgbi_ppm_sw_tag_is_usable(struct cxgbi_ppm *ppm,\n\t\t\t\t\t     u32 tag)\n{\n\t \n\treturn !(tag & 0x80000000U);\n}\n\nstatic inline int cxgbi_ppm_make_non_ddp_tag(struct cxgbi_ppm *ppm,\n\t\t\t\t\t     u32 sw_tag,\n\t\t\t\t\t     u32 *final_tag)\n{\n\tstruct cxgbi_tag_format *tformat = &ppm->tformat;\n\n\tif (!cxgbi_ppm_sw_tag_is_usable(ppm, sw_tag)) {\n\t\tpr_info(\"sw_tag 0x%x NOT usable.\\n\", sw_tag);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!sw_tag) {\n\t\t*final_tag = tformat->no_ddp_mask;\n\t} else {\n\t\tunsigned int shift = tformat->idx_bits + tformat->color_bits;\n\t\tu32 lower = sw_tag & tformat->idx_clr_mask;\n\t\tu32 upper = (sw_tag >> shift) << (shift + 1);\n\n\t\t*final_tag = upper | tformat->no_ddp_mask | lower;\n\t}\n\treturn 0;\n}\n\nstatic inline u32 cxgbi_ppm_decode_non_ddp_tag(struct cxgbi_ppm *ppm,\n\t\t\t\t\t       u32 tag)\n{\n\tstruct cxgbi_tag_format *tformat = &ppm->tformat;\n\tunsigned int shift = tformat->idx_bits + tformat->color_bits;\n\tu32 lower = tag & tformat->idx_clr_mask;\n\tu32 upper = (tag >> tformat->rsvd_bits) << shift;\n\n\treturn upper | lower;\n}\n\nstatic inline u32 cxgbi_ppm_ddp_tag_get_idx(struct cxgbi_ppm *ppm,\n\t\t\t\t\t    u32 ddp_tag)\n{\n\tu32 hw_idx = (ddp_tag >> PPOD_IDX_SHIFT) &\n\t\t\tppm->tformat.idx_mask;\n\n\treturn hw_idx - ppm->base_idx;\n}\n\nstatic inline u32 cxgbi_ppm_make_ddp_tag(unsigned int hw_idx,\n\t\t\t\t\t unsigned char color)\n{\n\treturn (hw_idx << PPOD_IDX_SHIFT) | ((u32)color);\n}\n\nstatic inline unsigned long\ncxgbi_ppm_get_tag_caller_data(struct cxgbi_ppm *ppm,\n\t\t\t      u32 ddp_tag)\n{\n\tu32 idx = cxgbi_ppm_ddp_tag_get_idx(ppm, ddp_tag);\n\n\treturn ppm->ppod_data[idx].caller_data;\n}\n\n \nstatic inline int cxgbi_ppm_ddp_tag_update_sw_bits(struct cxgbi_ppm *ppm,\n\t\t\t\t\t\t   u32 val, u32 orig_tag,\n\t\t\t\t\t\t   u32 *final_tag)\n{\n\tstruct cxgbi_tag_format *tformat = &ppm->tformat;\n\tu32 v = val >> tformat->free_bits;\n\n\tif (v) {\n\t\tpr_info(\"sw_bits 0x%x too large, avail bits %u.\\n\",\n\t\t\tval, tformat->free_bits);\n\t\treturn -EINVAL;\n\t}\n\tif (!cxgbi_ppm_is_ddp_tag(ppm, orig_tag))\n\t\treturn -EINVAL;\n\n\t*final_tag = (val << tformat->rsvd_bits) |\n\t\t     (orig_tag & ppm->tformat.rsvd_mask);\n\treturn 0;\n}\n\nstatic inline void cxgbi_ppm_ppod_clear(struct cxgbi_pagepod *ppod)\n{\n\tppod->hdr.vld_tid = 0U;\n}\n\nstatic inline void cxgbi_tagmask_check(unsigned int tagmask,\n\t\t\t\t       struct cxgbi_tag_format *tformat)\n{\n\tunsigned int bits = fls(tagmask);\n\n\t \n\ttformat->free_bits = 32 - 2 - bits;\n\ttformat->rsvd_bits = bits;\n\ttformat->color_bits = PPOD_IDX_SHIFT;\n\ttformat->idx_bits = bits - 1 - PPOD_IDX_SHIFT;\n\ttformat->no_ddp_mask = 1 << (bits - 1);\n\ttformat->idx_mask = (1 << tformat->idx_bits) - 1;\n\ttformat->color_mask = (1 << PPOD_IDX_SHIFT) - 1;\n\ttformat->idx_clr_mask = (1 << (bits - 1)) - 1;\n\ttformat->rsvd_mask = (1 << bits) - 1;\n\n\tpr_info(\"ippm: tagmask 0x%x, rsvd %u=%u+%u+1, mask 0x%x,0x%x, \"\n\t\t\"pg %u,%u,%u,%u.\\n\",\n\t\ttagmask, tformat->rsvd_bits, tformat->idx_bits,\n\t\ttformat->color_bits, tformat->no_ddp_mask, tformat->rsvd_mask,\n\t\ttformat->pgsz_order[0], tformat->pgsz_order[1],\n\t\ttformat->pgsz_order[2], tformat->pgsz_order[3]);\n}\n\nint cxgbi_ppm_find_page_index(struct cxgbi_ppm *ppm, unsigned long pgsz);\nvoid cxgbi_ppm_make_ppod_hdr(struct cxgbi_ppm *ppm, u32 tag,\n\t\t\t     unsigned int tid, unsigned int offset,\n\t\t\t     unsigned int length,\n\t\t\t     struct cxgbi_pagepod_hdr *hdr);\nvoid cxgbi_ppm_ppod_release(struct cxgbi_ppm *, u32 idx);\nint cxgbi_ppm_ppods_reserve(struct cxgbi_ppm *, unsigned short nr_pages,\n\t\t\t    u32 per_tag_pg_idx, u32 *ppod_idx, u32 *ddp_tag,\n\t\t\t    unsigned long caller_data);\nint cxgbi_ppm_init(void **ppm_pp, struct net_device *, struct pci_dev *,\n\t\t   void *lldev, struct cxgbi_tag_format *,\n\t\t   unsigned int iscsi_size, unsigned int llimit,\n\t\t   unsigned int start, unsigned int reserve_factor,\n\t\t   unsigned int edram_start, unsigned int edram_size);\nint cxgbi_ppm_release(struct cxgbi_ppm *ppm);\nvoid cxgbi_tagmask_check(unsigned int tagmask, struct cxgbi_tag_format *);\nunsigned int cxgbi_tagmask_set(unsigned int ppmax);\n\n#endif\t \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}