{
  "module_name": "pm3393.c",
  "hash_id": "be4e0aa65ea832fd6f0a382d67afd56ec8afda0c93cf5f0d6859078be0bc7541",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/chelsio/cxgb/pm3393.c",
  "human_readable_source": "\n \n\n#include \"common.h\"\n#include \"regs.h\"\n#include \"gmac.h\"\n#include \"elmer0.h\"\n#include \"suni1x10gexp_regs.h\"\n\n#include <linux/crc32.h>\n#include <linux/slab.h>\n\n#define OFFSET(REG_ADDR)    ((REG_ADDR) << 2)\n\n#define IPG 12\n#define TXXG_CONF1_VAL ((IPG << SUNI1x10GEXP_BITOFF_TXXG_IPGT) | \\\n\tSUNI1x10GEXP_BITMSK_TXXG_32BIT_ALIGN | SUNI1x10GEXP_BITMSK_TXXG_CRCEN | \\\n\tSUNI1x10GEXP_BITMSK_TXXG_PADEN)\n#define RXXG_CONF1_VAL (SUNI1x10GEXP_BITMSK_RXXG_PUREP | 0x14 | \\\n\tSUNI1x10GEXP_BITMSK_RXXG_FLCHK | SUNI1x10GEXP_BITMSK_RXXG_CRC_STRIP)\n\n \n#define STATS_TICK_SECS (15 * 60)\n\nenum {                      \n\tRxOctetsReceivedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_1_LOW,\n\tRxUnicastFramesReceivedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_4_LOW,\n\tRxMulticastFramesReceivedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_5_LOW,\n\tRxBroadcastFramesReceivedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_6_LOW,\n\tRxPAUSEMACCtrlFramesReceived = SUNI1x10GEXP_REG_MSTAT_COUNTER_8_LOW,\n\tRxFrameCheckSequenceErrors = SUNI1x10GEXP_REG_MSTAT_COUNTER_10_LOW,\n\tRxFramesLostDueToInternalMACErrors = SUNI1x10GEXP_REG_MSTAT_COUNTER_11_LOW,\n\tRxSymbolErrors = SUNI1x10GEXP_REG_MSTAT_COUNTER_12_LOW,\n\tRxInRangeLengthErrors = SUNI1x10GEXP_REG_MSTAT_COUNTER_13_LOW,\n\tRxFramesTooLongErrors = SUNI1x10GEXP_REG_MSTAT_COUNTER_15_LOW,\n\tRxJabbers = SUNI1x10GEXP_REG_MSTAT_COUNTER_16_LOW,\n\tRxFragments = SUNI1x10GEXP_REG_MSTAT_COUNTER_17_LOW,\n\tRxUndersizedFrames =  SUNI1x10GEXP_REG_MSTAT_COUNTER_18_LOW,\n\tRxJumboFramesReceivedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_25_LOW,\n\tRxJumboOctetsReceivedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_26_LOW,\n\n\tTxOctetsTransmittedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_33_LOW,\n\tTxFramesLostDueToInternalMACTransmissionError = SUNI1x10GEXP_REG_MSTAT_COUNTER_35_LOW,\n\tTxTransmitSystemError = SUNI1x10GEXP_REG_MSTAT_COUNTER_36_LOW,\n\tTxUnicastFramesTransmittedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_38_LOW,\n\tTxMulticastFramesTransmittedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_40_LOW,\n\tTxBroadcastFramesTransmittedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_42_LOW,\n\tTxPAUSEMACCtrlFramesTransmitted = SUNI1x10GEXP_REG_MSTAT_COUNTER_43_LOW,\n\tTxJumboFramesReceivedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_51_LOW,\n\tTxJumboOctetsReceivedOK = SUNI1x10GEXP_REG_MSTAT_COUNTER_52_LOW\n};\n\nstruct _cmac_instance {\n\tu8 enabled;\n\tu8 fc;\n\tu8 mac_addr[6];\n};\n\nstatic int pmread(struct cmac *cmac, u32 reg, u32 * data32)\n{\n\tt1_tpi_read(cmac->adapter, OFFSET(reg), data32);\n\treturn 0;\n}\n\nstatic int pmwrite(struct cmac *cmac, u32 reg, u32 data32)\n{\n\tt1_tpi_write(cmac->adapter, OFFSET(reg), data32);\n\treturn 0;\n}\n\n \nstatic int pm3393_reset(struct cmac *cmac)\n{\n\treturn 0;\n}\n\n \nstatic int pm3393_interrupt_enable(struct cmac *cmac)\n{\n\tu32 pl_intr;\n\n\t \n\tpmwrite(cmac, SUNI1x10GEXP_REG_SERDES_3125_INTERRUPT_ENABLE, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_XRF_INTERRUPT_ENABLE, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_XRF_DIAG_INTERRUPT_ENABLE, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXOAM_INTERRUPT_ENABLE, 0xffff);\n\n\t \n\tpmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_0, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_1, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_2, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_3, 0);\n\n\tpmwrite(cmac, SUNI1x10GEXP_REG_IFLX_FIFO_OVERFLOW_ENABLE, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_PL4ODP_INTERRUPT_MASK, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_XTEF_INTERRUPT_ENABLE, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_TXOAM_INTERRUPT_ENABLE, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_CONFIG_3, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_MASK, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_TXXG_CONFIG_3, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_PL4IDU_INTERRUPT_MASK, 0xffff);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_EFLX_FIFO_OVERFLOW_ERROR_ENABLE, 0xffff);\n\n\t \n\t \n\tpmwrite(cmac, SUNI1x10GEXP_REG_GLOBAL_INTERRUPT_ENABLE,\n\t\t0   );\n\n\t \n\tpl_intr = readl(cmac->adapter->regs + A_PL_ENABLE);\n\tpl_intr |= F_PL_INTR_EXT;\n\twritel(pl_intr, cmac->adapter->regs + A_PL_ENABLE);\n\treturn 0;\n}\n\nstatic int pm3393_interrupt_disable(struct cmac *cmac)\n{\n\tu32 elmer;\n\n\t \n\tpmwrite(cmac, SUNI1x10GEXP_REG_SERDES_3125_INTERRUPT_ENABLE, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_XRF_INTERRUPT_ENABLE, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_XRF_DIAG_INTERRUPT_ENABLE, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXOAM_INTERRUPT_ENABLE, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_0, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_1, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_2, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_INTERRUPT_MASK_3, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_IFLX_FIFO_OVERFLOW_ENABLE, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_PL4ODP_INTERRUPT_MASK, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_XTEF_INTERRUPT_ENABLE, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_TXOAM_INTERRUPT_ENABLE, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_CONFIG_3, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_MASK, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_TXXG_CONFIG_3, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_PL4IDU_INTERRUPT_MASK, 0);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_EFLX_FIFO_OVERFLOW_ERROR_ENABLE, 0);\n\n\t \n\tpmwrite(cmac, SUNI1x10GEXP_REG_GLOBAL_INTERRUPT_ENABLE, 0);\n\n\t \n\tt1_tpi_read(cmac->adapter, A_ELMER0_INT_ENABLE, &elmer);\n\telmer &= ~ELMER0_GP_BIT1;\n\tt1_tpi_write(cmac->adapter, A_ELMER0_INT_ENABLE, elmer);\n\n\t \n\t \n\n\treturn 0;\n}\n\nstatic int pm3393_interrupt_clear(struct cmac *cmac)\n{\n\tu32 elmer;\n\tu32 pl_intr;\n\tu32 val32;\n\n\t \n\tpmread(cmac, SUNI1x10GEXP_REG_SERDES_3125_INTERRUPT_STATUS, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_XRF_INTERRUPT_STATUS, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_XRF_DIAG_INTERRUPT_STATUS, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_RXOAM_INTERRUPT_STATUS, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_PL4ODP_INTERRUPT, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_XTEF_INTERRUPT_STATUS, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_IFLX_FIFO_OVERFLOW_INTERRUPT, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_TXOAM_INTERRUPT_STATUS, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_RXXG_INTERRUPT, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_TXXG_INTERRUPT, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_PL4IDU_INTERRUPT, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_EFLX_FIFO_OVERFLOW_ERROR_INDICATION,\n\t       &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_STATUS, &val32);\n\tpmread(cmac, SUNI1x10GEXP_REG_PL4IO_LOCK_DETECT_CHANGE, &val32);\n\n\t \n\tpmread(cmac, SUNI1x10GEXP_REG_MASTER_INTERRUPT_STATUS, &val32);\n\n\t \n\tt1_tpi_read(cmac->adapter, A_ELMER0_INT_CAUSE, &elmer);\n\telmer |= ELMER0_GP_BIT1;\n\tt1_tpi_write(cmac->adapter, A_ELMER0_INT_CAUSE, elmer);\n\n\t \n\tpl_intr = readl(cmac->adapter->regs + A_PL_CAUSE);\n\tpl_intr |= F_PL_INTR_EXT;\n\twritel(pl_intr, cmac->adapter->regs + A_PL_CAUSE);\n\n\treturn 0;\n}\n\n \nstatic int pm3393_interrupt_handler(struct cmac *cmac)\n{\n\tu32 master_intr_status;\n\n\t \n\tpmread(cmac, SUNI1x10GEXP_REG_MASTER_INTERRUPT_STATUS,\n\t       &master_intr_status);\n\tif (netif_msg_intr(cmac->adapter))\n\t\tdev_dbg(&cmac->adapter->pdev->dev, \"PM3393 intr cause 0x%x\\n\",\n\t\t\tmaster_intr_status);\n\n\t \n\tpm3393_interrupt_clear(cmac);\n\n\treturn 0;\n}\n\nstatic int pm3393_enable(struct cmac *cmac, int which)\n{\n\tif (which & MAC_DIRECTION_RX)\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_CONFIG_1,\n\t\t\t(RXXG_CONF1_VAL | SUNI1x10GEXP_BITMSK_RXXG_RXEN));\n\n\tif (which & MAC_DIRECTION_TX) {\n\t\tu32 val = TXXG_CONF1_VAL | SUNI1x10GEXP_BITMSK_TXXG_TXEN0;\n\n\t\tif (cmac->instance->fc & PAUSE_RX)\n\t\t\tval |= SUNI1x10GEXP_BITMSK_TXXG_FCRX;\n\t\tif (cmac->instance->fc & PAUSE_TX)\n\t\t\tval |= SUNI1x10GEXP_BITMSK_TXXG_FCTX;\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_TXXG_CONFIG_1, val);\n\t}\n\n\tcmac->instance->enabled |= which;\n\treturn 0;\n}\n\nstatic int pm3393_enable_port(struct cmac *cmac, int which)\n{\n\t \n\tpmwrite(cmac, SUNI1x10GEXP_REG_MSTAT_CONTROL,\n\t\tSUNI1x10GEXP_BITMSK_MSTAT_CLEAR);\n\tudelay(2);\n\tmemset(&cmac->stats, 0, sizeof(struct cmac_statistics));\n\n\tpm3393_enable(cmac, which);\n\n\t \n\tt1_link_changed(cmac->adapter, 0);\n\treturn 0;\n}\n\nstatic int pm3393_disable(struct cmac *cmac, int which)\n{\n\tif (which & MAC_DIRECTION_RX)\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_CONFIG_1, RXXG_CONF1_VAL);\n\tif (which & MAC_DIRECTION_TX)\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_TXXG_CONFIG_1, TXXG_CONF1_VAL);\n\n\t \n\tudelay(20);\n\n\tcmac->instance->enabled &= ~which;\n\treturn 0;\n}\n\nstatic int pm3393_loopback_enable(struct cmac *cmac)\n{\n\treturn 0;\n}\n\nstatic int pm3393_loopback_disable(struct cmac *cmac)\n{\n\treturn 0;\n}\n\nstatic int pm3393_set_mtu(struct cmac *cmac, int mtu)\n{\n\tint enabled = cmac->instance->enabled;\n\n\tmtu += ETH_HLEN + ETH_FCS_LEN;\n\n\t \n\tif (enabled)\n\t\tpm3393_disable(cmac, MAC_DIRECTION_RX | MAC_DIRECTION_TX);\n\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MAX_FRAME_LENGTH, mtu);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_TXXG_MAX_FRAME_SIZE, mtu);\n\n\tif (enabled)\n\t\tpm3393_enable(cmac, enabled);\n\treturn 0;\n}\n\nstatic int pm3393_set_rx_mode(struct cmac *cmac, struct t1_rx_mode *rm)\n{\n\tint enabled = cmac->instance->enabled & MAC_DIRECTION_RX;\n\tu32 rx_mode;\n\n\t \n\tif (enabled)\n\t\tpm3393_disable(cmac, MAC_DIRECTION_RX);\n\n\tpmread(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_2, &rx_mode);\n\trx_mode &= ~(SUNI1x10GEXP_BITMSK_RXXG_PMODE |\n\t\t     SUNI1x10GEXP_BITMSK_RXXG_MHASH_EN);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_2,\n\t\t(u16)rx_mode);\n\n\tif (t1_rx_mode_promisc(rm)) {\n\t\t \n\t\trx_mode |= SUNI1x10GEXP_BITMSK_RXXG_PMODE;\n\t}\n\tif (t1_rx_mode_allmulti(rm)) {\n\t\t \n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_LOW, 0xffff);\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDLOW, 0xffff);\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDHIGH, 0xffff);\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_HIGH, 0xffff);\n\t\trx_mode |= SUNI1x10GEXP_BITMSK_RXXG_MHASH_EN;\n\t} else if (t1_rx_mode_mc_cnt(rm)) {\n\t\t \n\t\tstruct netdev_hw_addr *ha;\n\t\tint bit;\n\t\tu16 mc_filter[4] = { 0, };\n\n\t\tnetdev_for_each_mc_addr(ha, t1_get_netdev(rm)) {\n\t\t\t \n\t\t\tbit = (ether_crc(ETH_ALEN, ha->addr) >> 23) & 0x3f;\n\t\t\tmc_filter[bit >> 4] |= 1 << (bit & 0xf);\n\t\t}\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_LOW, mc_filter[0]);\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDLOW, mc_filter[1]);\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_MIDHIGH, mc_filter[2]);\n\t\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_MULTICAST_HASH_HIGH, mc_filter[3]);\n\t\trx_mode |= SUNI1x10GEXP_BITMSK_RXXG_MHASH_EN;\n\t}\n\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_2, (u16)rx_mode);\n\n\tif (enabled)\n\t\tpm3393_enable(cmac, MAC_DIRECTION_RX);\n\n\treturn 0;\n}\n\nstatic int pm3393_get_speed_duplex_fc(struct cmac *cmac, int *speed,\n\t\t\t\t      int *duplex, int *fc)\n{\n\tif (speed)\n\t\t*speed = SPEED_10000;\n\tif (duplex)\n\t\t*duplex = DUPLEX_FULL;\n\tif (fc)\n\t\t*fc = cmac->instance->fc;\n\treturn 0;\n}\n\nstatic int pm3393_set_speed_duplex_fc(struct cmac *cmac, int speed, int duplex,\n\t\t\t\t      int fc)\n{\n\tif (speed >= 0 && speed != SPEED_10000)\n\t\treturn -1;\n\tif (duplex >= 0 && duplex != DUPLEX_FULL)\n\t\treturn -1;\n\tif (fc & ~(PAUSE_TX | PAUSE_RX))\n\t\treturn -1;\n\n\tif (fc != cmac->instance->fc) {\n\t\tcmac->instance->fc = (u8) fc;\n\t\tif (cmac->instance->enabled & MAC_DIRECTION_TX)\n\t\t\tpm3393_enable(cmac, MAC_DIRECTION_TX);\n\t}\n\treturn 0;\n}\n\n#define RMON_UPDATE(mac, name, stat_name) \\\n{ \\\n\tt1_tpi_read((mac)->adapter, OFFSET(name), &val0);     \\\n\tt1_tpi_read((mac)->adapter, OFFSET((name)+1), &val1); \\\n\tt1_tpi_read((mac)->adapter, OFFSET((name)+2), &val2); \\\n\t(mac)->stats.stat_name = (u64)(val0 & 0xffff) | \\\n\t\t\t\t ((u64)(val1 & 0xffff) << 16) | \\\n\t\t\t\t ((u64)(val2 & 0xff) << 32) | \\\n\t\t\t\t ((mac)->stats.stat_name & \\\n\t\t\t\t\t0xffffff0000000000ULL); \\\n\tif (ro & \\\n\t    (1ULL << ((name - SUNI1x10GEXP_REG_MSTAT_COUNTER_0_LOW) >> 2))) \\\n\t\t(mac)->stats.stat_name += 1ULL << 40; \\\n}\n\nstatic const struct cmac_statistics *pm3393_update_statistics(struct cmac *mac,\n\t\t\t\t\t\t\t      int flag)\n{\n\tu64\tro;\n\tu32\tval0, val1, val2, val3;\n\n\t \n\tpmwrite(mac, SUNI1x10GEXP_REG_MSTAT_CONTROL,\n\t\tSUNI1x10GEXP_BITMSK_MSTAT_SNAP);\n\n\t \n\tpmread(mac, SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_0, &val0);\n\tpmread(mac, SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_1, &val1);\n\tpmread(mac, SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_2, &val2);\n\tpmread(mac, SUNI1x10GEXP_REG_MSTAT_COUNTER_ROLLOVER_3, &val3);\n\tro = ((u64)val0 & 0xffff) | (((u64)val1 & 0xffff) << 16) |\n\t\t(((u64)val2 & 0xffff) << 32) | (((u64)val3 & 0xffff) << 48);\n\n\t \n\tRMON_UPDATE(mac, RxOctetsReceivedOK, RxOctetsOK);\n\tRMON_UPDATE(mac, RxUnicastFramesReceivedOK, RxUnicastFramesOK);\n\tRMON_UPDATE(mac, RxMulticastFramesReceivedOK, RxMulticastFramesOK);\n\tRMON_UPDATE(mac, RxBroadcastFramesReceivedOK, RxBroadcastFramesOK);\n\tRMON_UPDATE(mac, RxPAUSEMACCtrlFramesReceived, RxPauseFrames);\n\tRMON_UPDATE(mac, RxFrameCheckSequenceErrors, RxFCSErrors);\n\tRMON_UPDATE(mac, RxFramesLostDueToInternalMACErrors,\n\t\t\t\tRxInternalMACRcvError);\n\tRMON_UPDATE(mac, RxSymbolErrors, RxSymbolErrors);\n\tRMON_UPDATE(mac, RxInRangeLengthErrors, RxInRangeLengthErrors);\n\tRMON_UPDATE(mac, RxFramesTooLongErrors , RxFrameTooLongErrors);\n\tRMON_UPDATE(mac, RxJabbers, RxJabberErrors);\n\tRMON_UPDATE(mac, RxFragments, RxRuntErrors);\n\tRMON_UPDATE(mac, RxUndersizedFrames, RxRuntErrors);\n\tRMON_UPDATE(mac, RxJumboFramesReceivedOK, RxJumboFramesOK);\n\tRMON_UPDATE(mac, RxJumboOctetsReceivedOK, RxJumboOctetsOK);\n\n\t \n\tRMON_UPDATE(mac, TxOctetsTransmittedOK, TxOctetsOK);\n\tRMON_UPDATE(mac, TxFramesLostDueToInternalMACTransmissionError,\n\t\t\t\tTxInternalMACXmitError);\n\tRMON_UPDATE(mac, TxTransmitSystemError, TxFCSErrors);\n\tRMON_UPDATE(mac, TxUnicastFramesTransmittedOK, TxUnicastFramesOK);\n\tRMON_UPDATE(mac, TxMulticastFramesTransmittedOK, TxMulticastFramesOK);\n\tRMON_UPDATE(mac, TxBroadcastFramesTransmittedOK, TxBroadcastFramesOK);\n\tRMON_UPDATE(mac, TxPAUSEMACCtrlFramesTransmitted, TxPauseFrames);\n\tRMON_UPDATE(mac, TxJumboFramesReceivedOK, TxJumboFramesOK);\n\tRMON_UPDATE(mac, TxJumboOctetsReceivedOK, TxJumboOctetsOK);\n\n\treturn &mac->stats;\n}\n\nstatic int pm3393_macaddress_get(struct cmac *cmac, u8 mac_addr[6])\n{\n\tmemcpy(mac_addr, cmac->instance->mac_addr, ETH_ALEN);\n\treturn 0;\n}\n\nstatic int pm3393_macaddress_set(struct cmac *cmac, const u8 ma[6])\n{\n\tu32 val, lo, mid, hi, enabled = cmac->instance->enabled;\n\n\t \n\n\t \n\tmemcpy(cmac->instance->mac_addr, ma, ETH_ALEN);\n\n\tlo  = ((u32) ma[1] << 8) | (u32) ma[0];\n\tmid = ((u32) ma[3] << 8) | (u32) ma[2];\n\thi  = ((u32) ma[5] << 8) | (u32) ma[4];\n\n\t \n\tif (enabled)\n\t\tpm3393_disable(cmac, MAC_DIRECTION_RX | MAC_DIRECTION_TX);\n\n\t \n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_SA_15_0, lo);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_SA_31_16, mid);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_SA_47_32, hi);\n\n\t \n\tpmwrite(cmac, SUNI1x10GEXP_REG_TXXG_SA_15_0, lo);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_TXXG_SA_31_16, mid);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_TXXG_SA_47_32, hi);\n\n\t \n\tpmread(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_0, &val);\n\tval &= 0xff0f;\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_0, val);\n\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_EXACT_MATCH_ADDR_1_LOW, lo);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_EXACT_MATCH_ADDR_1_MID, mid);\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_EXACT_MATCH_ADDR_1_HIGH, hi);\n\n\tval |= 0x0090;\n\tpmwrite(cmac, SUNI1x10GEXP_REG_RXXG_ADDRESS_FILTER_CONTROL_0, val);\n\n\tif (enabled)\n\t\tpm3393_enable(cmac, enabled);\n\treturn 0;\n}\n\nstatic void pm3393_destroy(struct cmac *cmac)\n{\n\tkfree(cmac);\n}\n\nstatic const struct cmac_ops pm3393_ops = {\n\t.destroy                 = pm3393_destroy,\n\t.reset                   = pm3393_reset,\n\t.interrupt_enable        = pm3393_interrupt_enable,\n\t.interrupt_disable       = pm3393_interrupt_disable,\n\t.interrupt_clear         = pm3393_interrupt_clear,\n\t.interrupt_handler       = pm3393_interrupt_handler,\n\t.enable                  = pm3393_enable_port,\n\t.disable                 = pm3393_disable,\n\t.loopback_enable         = pm3393_loopback_enable,\n\t.loopback_disable        = pm3393_loopback_disable,\n\t.set_mtu                 = pm3393_set_mtu,\n\t.set_rx_mode             = pm3393_set_rx_mode,\n\t.get_speed_duplex_fc     = pm3393_get_speed_duplex_fc,\n\t.set_speed_duplex_fc     = pm3393_set_speed_duplex_fc,\n\t.statistics_update       = pm3393_update_statistics,\n\t.macaddress_get          = pm3393_macaddress_get,\n\t.macaddress_set          = pm3393_macaddress_set\n};\n\nstatic struct cmac *pm3393_mac_create(adapter_t *adapter, int index)\n{\n\tstruct cmac *cmac;\n\n\tcmac = kzalloc(sizeof(*cmac) + sizeof(cmac_instance), GFP_KERNEL);\n\tif (!cmac)\n\t\treturn NULL;\n\n\tcmac->ops = &pm3393_ops;\n\tcmac->instance = (cmac_instance *) (cmac + 1);\n\tcmac->adapter = adapter;\n\tcmac->instance->fc = PAUSE_TX | PAUSE_RX;\n\n\tt1_tpi_write(adapter, OFFSET(0x0001), 0x00008000);\n\tt1_tpi_write(adapter, OFFSET(0x0001), 0x00000000);\n\tt1_tpi_write(adapter, OFFSET(0x2308), 0x00009800);\n\tt1_tpi_write(adapter, OFFSET(0x2305), 0x00001001);    \n\tt1_tpi_write(adapter, OFFSET(0x2320), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x2321), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x2322), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x2323), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x2324), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x2325), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x2326), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x2327), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x2328), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x2329), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x232a), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x232b), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x232c), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x232d), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x232e), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x232f), 0x00008800);\n\tt1_tpi_write(adapter, OFFSET(0x230d), 0x00009c00);\n\tt1_tpi_write(adapter, OFFSET(0x2304), 0x00000202);\t \n\n\tt1_tpi_write(adapter, OFFSET(0x3200), 0x00008080);\t \n\tt1_tpi_write(adapter, OFFSET(0x3210), 0x00000000);\t \n\tt1_tpi_write(adapter, OFFSET(0x3203), 0x00000000);\t \n\tt1_tpi_write(adapter, OFFSET(0x3204), 0x00000040);\t \n\tt1_tpi_write(adapter, OFFSET(0x3205), 0x000002cc);\t \n\tt1_tpi_write(adapter, OFFSET(0x3206), 0x00000199);\t \n\tt1_tpi_write(adapter, OFFSET(0x3207), 0x00000240);\t \n\tt1_tpi_write(adapter, OFFSET(0x3202), 0x00000000);\t \n\tt1_tpi_write(adapter, OFFSET(0x3210), 0x00000001);\t \n\tt1_tpi_write(adapter, OFFSET(0x3208), 0x0000ffff);\t \n\tt1_tpi_write(adapter, OFFSET(0x320a), 0x0000ffff);\t \n\tt1_tpi_write(adapter, OFFSET(0x320c), 0x0000ffff);\t \n\tt1_tpi_write(adapter, OFFSET(0x320e), 0x0000ffff);\t \n\n\tt1_tpi_write(adapter, OFFSET(0x2200), 0x0000c000);\t \n\tt1_tpi_write(adapter, OFFSET(0x2201), 0x00000000);\t \n\tt1_tpi_write(adapter, OFFSET(0x220e), 0x00000000);\t \n\tt1_tpi_write(adapter, OFFSET(0x220f), 0x00000100);\t \n\tt1_tpi_write(adapter, OFFSET(0x2210), 0x00000c00);\t \n\tt1_tpi_write(adapter, OFFSET(0x2211), 0x00000599);\t \n\tt1_tpi_write(adapter, OFFSET(0x220d), 0x00000000);\t \n\tt1_tpi_write(adapter, OFFSET(0x2201), 0x00000001);\t \n\tt1_tpi_write(adapter, OFFSET(0x2203), 0x0000ffff);\t \n\tt1_tpi_write(adapter, OFFSET(0x2205), 0x0000ffff);\t \n\tt1_tpi_write(adapter, OFFSET(0x2209), 0x0000ffff);\t \n\n\tt1_tpi_write(adapter, OFFSET(0x2241), 0xfffffffe);\t \n\tt1_tpi_write(adapter, OFFSET(0x2242), 0x0000ffff);\t \n\tt1_tpi_write(adapter, OFFSET(0x2243), 0x00000008);\t \n\tt1_tpi_write(adapter, OFFSET(0x2244), 0x00000008);\t \n\tt1_tpi_write(adapter, OFFSET(0x2245), 0x00000008);\t \n\tt1_tpi_write(adapter, OFFSET(0x2240), 0x00000005);\t \n\n\tt1_tpi_write(adapter, OFFSET(0x2280), 0x00002103);\t \n\tt1_tpi_write(adapter, OFFSET(0x2284), 0x00000000);\t \n\n\tt1_tpi_write(adapter, OFFSET(0x3280), 0x00000087);\t \n\tt1_tpi_write(adapter, OFFSET(0x3282), 0x0000001f);\t \n\n\tt1_tpi_write(adapter, OFFSET(0x3040), 0x0c32);\t \n\t \n\tt1_tpi_write(adapter, OFFSET(0x304d), 0x8000);\n\tt1_tpi_write(adapter, OFFSET(0x2040), 0x059c);\t \n\tt1_tpi_write(adapter, OFFSET(0x2049), 0x0001);\t \n\tt1_tpi_write(adapter, OFFSET(0x2070), 0x0000);\t \n\n\t \n\tt1_tpi_write(adapter, OFFSET(0x206e), 0x0000);\t \n\tt1_tpi_write(adapter, OFFSET(0x204a), 0xffff);\t \n\tt1_tpi_write(adapter, OFFSET(0x204b), 0xffff);\t \n\tt1_tpi_write(adapter, OFFSET(0x204c), 0xffff);\t \n\tt1_tpi_write(adapter, OFFSET(0x206e), 0x0009);\t \n\n\tt1_tpi_write(adapter, OFFSET(0x0003), 0x0000);\t \n\tt1_tpi_write(adapter, OFFSET(0x0100), 0x0ff0);\t \n\tt1_tpi_write(adapter, OFFSET(0x0101), 0x0f0f);\t \n\n\treturn cmac;\n}\n\nstatic int pm3393_mac_reset(adapter_t * adapter)\n{\n\tu32 val;\n\tu32 x;\n\tu32 is_pl4_reset_finished;\n\tu32 is_pl4_outof_lock;\n\tu32 is_xaui_mabc_pll_locked;\n\tu32 successful_reset;\n\tint i;\n\n\t \n\n\tsuccessful_reset = 0;\n\tfor (i = 0; i < 3 && !successful_reset; i++) {\n\t\t \n\t\tt1_tpi_read(adapter, A_ELMER0_GPO, &val);\n\t\tval &= ~1;\n\t\tt1_tpi_write(adapter, A_ELMER0_GPO, val);\n\n\t\t \n\t\tmsleep(1);\n\n\t\t \n\t\tmsleep(1);\n\n\t\t \n\t\tmsleep(2   );\n\n\t\t \n\t\tval |= 1;\n\t\tt1_tpi_write(adapter, A_ELMER0_GPO, val);\n\n\t\t \n\t\tmsleep(15   );\n\n\t\t \n\t\tmsleep(1);\n\n\t\t \n\n\t\t \n\t\tt1_tpi_read(adapter, OFFSET(SUNI1x10GEXP_REG_DEVICE_STATUS), &val);\n\t\tis_pl4_reset_finished = (val & SUNI1x10GEXP_BITMSK_TOP_EXPIRED);\n\n\t\t \n\n\t\t \n\t\tx = (SUNI1x10GEXP_BITMSK_TOP_PL4_ID_DOOL\n\t\t        |\n\t\t     SUNI1x10GEXP_BITMSK_TOP_PL4_ID_ROOL |\n\t\t     SUNI1x10GEXP_BITMSK_TOP_PL4_IS_ROOL |\n\t\t     SUNI1x10GEXP_BITMSK_TOP_PL4_OUT_ROOL);\n\t\tis_pl4_outof_lock = (val & x);\n\n\t\t \n\t\t \n\t\tis_xaui_mabc_pll_locked =\n\t\t    (val & SUNI1x10GEXP_BITMSK_TOP_SXRA_EXPIRED);\n\n\t\tsuccessful_reset = (is_pl4_reset_finished && !is_pl4_outof_lock\n\t\t\t\t    && is_xaui_mabc_pll_locked);\n\n\t\tif (netif_msg_hw(adapter))\n\t\t\tdev_dbg(&adapter->pdev->dev,\n\t\t\t\t\"PM3393 HW reset %d: pl4_reset 0x%x, val 0x%x, \"\n\t\t\t\t\"is_pl4_outof_lock 0x%x, xaui_locked 0x%x\\n\",\n\t\t\t\ti, is_pl4_reset_finished, val,\n\t\t\t\tis_pl4_outof_lock, is_xaui_mabc_pll_locked);\n\t}\n\treturn successful_reset ? 0 : 1;\n}\n\nconst struct gmac t1_pm3393_ops = {\n\t.stats_update_period = STATS_TICK_SECS,\n\t.create              = pm3393_mac_create,\n\t.reset               = pm3393_mac_reset,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}