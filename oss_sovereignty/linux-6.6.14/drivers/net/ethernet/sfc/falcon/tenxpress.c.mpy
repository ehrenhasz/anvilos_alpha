{
  "module_name": "tenxpress.c",
  "hash_id": "2535436a34542cb5d761b3718812a3ce308048af885421f4e63f43d1791ac48b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/sfc/falcon/tenxpress.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/rtnetlink.h>\n#include <linux/seq_file.h>\n#include <linux/slab.h>\n#include \"efx.h\"\n#include \"mdio_10g.h\"\n#include \"nic.h\"\n#include \"phy.h\"\n#include \"workarounds.h\"\n\n \n#define TENXPRESS_REQUIRED_DEVS (MDIO_DEVS_PMAPMD\t| \\\n\t\t\t\t MDIO_DEVS_PCS\t\t| \\\n\t\t\t\t MDIO_DEVS_PHYXS\t| \\\n\t\t\t\t MDIO_DEVS_AN)\n\n#define SFX7101_LOOPBACKS ((1 << LOOPBACK_PHYXS) |\t\\\n\t\t\t   (1 << LOOPBACK_PCS) |\t\\\n\t\t\t   (1 << LOOPBACK_PMAPMD) |\t\\\n\t\t\t   (1 << LOOPBACK_PHYXS_WS))\n\n \n#define MAX_BAD_LP_TRIES\t(5)\n\n \n#define PMA_PMD_XCONTROL_REG\t49152\n#define PMA_PMD_EXT_GMII_EN_LBN\t1\n#define PMA_PMD_EXT_GMII_EN_WIDTH 1\n#define PMA_PMD_EXT_CLK_OUT_LBN\t2\n#define PMA_PMD_EXT_CLK_OUT_WIDTH 1\n#define PMA_PMD_LNPGA_POWERDOWN_LBN 8\n#define PMA_PMD_LNPGA_POWERDOWN_WIDTH 1\n#define PMA_PMD_EXT_CLK312_WIDTH 1\n#define PMA_PMD_EXT_LPOWER_LBN  12\n#define PMA_PMD_EXT_LPOWER_WIDTH 1\n#define PMA_PMD_EXT_ROBUST_LBN\t14\n#define PMA_PMD_EXT_ROBUST_WIDTH 1\n#define PMA_PMD_EXT_SSR_LBN\t15\n#define PMA_PMD_EXT_SSR_WIDTH\t1\n\n \n#define PMA_PMD_XSTATUS_REG\t49153\n#define PMA_PMD_XSTAT_MDIX_LBN\t14\n#define PMA_PMD_XSTAT_FLP_LBN   (12)\n\n \n#define PMA_PMD_LED_CTRL_REG\t49159\n#define PMA_PMA_LED_ACTIVITY_LBN\t(3)\n\n \n#define PMA_PMD_LED_OVERR_REG\t49161\n \n#define PMA_PMD_LED_LINK_LBN\t(0)\n#define PMA_PMD_LED_SPEED_LBN\t(2)\n#define PMA_PMD_LED_TX_LBN\t(4)\n#define PMA_PMD_LED_RX_LBN\t(6)\n \n#define\tPMA_PMD_LED_AUTO\t(0)\t \n#define\tPMA_PMD_LED_ON\t\t(1)\n#define\tPMA_PMD_LED_OFF\t\t(2)\n#define PMA_PMD_LED_FLASH\t(3)\n#define PMA_PMD_LED_MASK\t3\n \n \n#define SFX7101_PMA_PMD_LED_DEFAULT (PMA_PMD_LED_OFF << PMA_PMD_LED_RX_LBN)\n\n#define PMA_PMD_SPEED_ENABLE_REG 49192\n#define PMA_PMD_100TX_ADV_LBN    1\n#define PMA_PMD_100TX_ADV_WIDTH  1\n#define PMA_PMD_1000T_ADV_LBN    2\n#define PMA_PMD_1000T_ADV_WIDTH  1\n#define PMA_PMD_10000T_ADV_LBN   3\n#define PMA_PMD_10000T_ADV_WIDTH 1\n#define PMA_PMD_SPEED_LBN        4\n#define PMA_PMD_SPEED_WIDTH      4\n\n \n#define PCS_CLOCK_CTRL_REG\t55297\n#define PLL312_RST_N_LBN 2\n\n#define PCS_SOFT_RST2_REG\t55302\n#define SERDES_RST_N_LBN 13\n#define XGXS_RST_N_LBN 12\n\n#define\tPCS_TEST_SELECT_REG\t55303\t \n#define\tCLK312_EN_LBN 3\n\n \n#define PHYXS_XCONTROL_REG\t49152\n#define PHYXS_RESET_LBN\t\t15\n#define PHYXS_RESET_WIDTH\t1\n\n#define PHYXS_TEST1         (49162)\n#define LOOPBACK_NEAR_LBN   (8)\n#define LOOPBACK_NEAR_WIDTH (1)\n\n \n#define PCS_BOOT_STATUS_REG\t\t53248\n#define PCS_BOOT_FATAL_ERROR_LBN\t0\n#define PCS_BOOT_PROGRESS_LBN\t\t1\n#define PCS_BOOT_PROGRESS_WIDTH\t\t2\n#define PCS_BOOT_PROGRESS_INIT\t\t0\n#define PCS_BOOT_PROGRESS_WAIT_MDIO\t1\n#define PCS_BOOT_PROGRESS_CHECKSUM\t2\n#define PCS_BOOT_PROGRESS_JUMP\t\t3\n#define PCS_BOOT_DOWNLOAD_WAIT_LBN\t3\n#define PCS_BOOT_CODE_STARTED_LBN\t4\n\n \n#define GPHY_XCONTROL_REG\t49152\n#define GPHY_ISOLATE_LBN\t10\n#define GPHY_ISOLATE_WIDTH\t1\n#define GPHY_DUPLEX_LBN\t\t8\n#define GPHY_DUPLEX_WIDTH\t1\n#define GPHY_LOOPBACK_NEAR_LBN\t14\n#define GPHY_LOOPBACK_NEAR_WIDTH 1\n\n#define C22EXT_STATUS_REG       49153\n#define C22EXT_STATUS_LINK_LBN  2\n#define C22EXT_STATUS_LINK_WIDTH 1\n\n#define C22EXT_MSTSLV_CTRL\t\t\t49161\n#define C22EXT_MSTSLV_CTRL_ADV_1000_HD_LBN\t8\n#define C22EXT_MSTSLV_CTRL_ADV_1000_FD_LBN\t9\n\n#define C22EXT_MSTSLV_STATUS\t\t\t49162\n#define C22EXT_MSTSLV_STATUS_LP_1000_HD_LBN\t10\n#define C22EXT_MSTSLV_STATUS_LP_1000_FD_LBN\t11\n\n \n#define LNPGA_PDOWN_WAIT\t(HZ / 5)\n\nstruct tenxpress_phy_data {\n\tenum ef4_loopback_mode loopback_mode;\n\tenum ef4_phy_mode phy_mode;\n\tint bad_lp_tries;\n};\n\nstatic int tenxpress_init(struct ef4_nic *efx)\n{\n\t \n\tef4_mdio_write(efx, MDIO_MMD_PCS, PCS_TEST_SELECT_REG,\n\t\t       1 << CLK312_EN_LBN);\n\n\t \n\tef4_mdio_set_flag(efx, MDIO_MMD_PMAPMD, PMA_PMD_LED_CTRL_REG,\n\t\t\t  1 << PMA_PMA_LED_ACTIVITY_LBN, true);\n\tef4_mdio_write(efx, MDIO_MMD_PMAPMD, PMA_PMD_LED_OVERR_REG,\n\t\t       SFX7101_PMA_PMD_LED_DEFAULT);\n\n\treturn 0;\n}\n\nstatic int tenxpress_phy_probe(struct ef4_nic *efx)\n{\n\tstruct tenxpress_phy_data *phy_data;\n\n\t \n\tphy_data = kzalloc(sizeof(*phy_data), GFP_KERNEL);\n\tif (!phy_data)\n\t\treturn -ENOMEM;\n\tefx->phy_data = phy_data;\n\tphy_data->phy_mode = efx->phy_mode;\n\n\tefx->mdio.mmds = TENXPRESS_REQUIRED_DEVS;\n\tefx->mdio.mode_support = MDIO_SUPPORTS_C45;\n\n\tefx->loopback_modes = SFX7101_LOOPBACKS | FALCON_XMAC_LOOPBACKS;\n\n\tefx->link_advertising = (ADVERTISED_TP | ADVERTISED_Autoneg |\n\t\t\t\t ADVERTISED_10000baseT_Full);\n\n\treturn 0;\n}\n\nstatic int tenxpress_phy_init(struct ef4_nic *efx)\n{\n\tint rc;\n\n\tfalcon_board(efx)->type->init_phy(efx);\n\n\tif (!(efx->phy_mode & PHY_MODE_SPECIAL)) {\n\t\trc = ef4_mdio_wait_reset_mmds(efx, TENXPRESS_REQUIRED_DEVS);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = ef4_mdio_check_mmds(efx, TENXPRESS_REQUIRED_DEVS);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t}\n\n\trc = tenxpress_init(efx);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\tef4_link_set_wanted_fc(efx, efx->wanted_fc);\n\tef4_mdio_an_reconfigure(efx);\n\n\tschedule_timeout_uninterruptible(HZ / 5);  \n\n\t \n\tfalcon_reset_xaui(efx);\n\n\treturn 0;\n}\n\n \nstatic int tenxpress_special_reset(struct ef4_nic *efx)\n{\n\tint rc, reg;\n\n\t \n\tfalcon_stop_nic_stats(efx);\n\n\t \n\treg = ef4_mdio_read(efx, MDIO_MMD_PMAPMD, PMA_PMD_XCONTROL_REG);\n\treg |= (1 << PMA_PMD_EXT_SSR_LBN);\n\tef4_mdio_write(efx, MDIO_MMD_PMAPMD, PMA_PMD_XCONTROL_REG, reg);\n\n\tmdelay(200);\n\n\t \n\trc = ef4_mdio_wait_reset_mmds(efx, TENXPRESS_REQUIRED_DEVS);\n\tif (rc < 0)\n\t\tgoto out;\n\n\t \n\trc = tenxpress_init(efx);\n\tif (rc < 0)\n\t\tgoto out;\n\n\t \n\tmdelay(10);\nout:\n\tfalcon_start_nic_stats(efx);\n\treturn rc;\n}\n\nstatic void sfx7101_check_bad_lp(struct ef4_nic *efx, bool link_ok)\n{\n\tstruct tenxpress_phy_data *pd = efx->phy_data;\n\tbool bad_lp;\n\tint reg;\n\n\tif (link_ok) {\n\t\tbad_lp = false;\n\t} else {\n\t\t \n\t\treg = ef4_mdio_read(efx, MDIO_MMD_AN, MDIO_STAT1);\n\t\tif (!(reg & MDIO_AN_STAT1_LPABLE))\n\t\t\treturn;  \n\t\tbad_lp = !(reg & MDIO_AN_STAT1_COMPLETE);\n\t\tif (bad_lp)\n\t\t\tpd->bad_lp_tries++;\n\t}\n\n\t \n\tif (!pd->bad_lp_tries)\n\t\treturn;\n\n\t \n\tif (!bad_lp || pd->bad_lp_tries == MAX_BAD_LP_TRIES) {\n\t\treg = ef4_mdio_read(efx, MDIO_MMD_PMAPMD,\n\t\t\t\t    PMA_PMD_LED_OVERR_REG);\n\t\treg &= ~(PMA_PMD_LED_MASK << PMA_PMD_LED_RX_LBN);\n\t\tif (!bad_lp) {\n\t\t\treg |= PMA_PMD_LED_OFF << PMA_PMD_LED_RX_LBN;\n\t\t} else {\n\t\t\treg |= PMA_PMD_LED_FLASH << PMA_PMD_LED_RX_LBN;\n\t\t\tnetif_err(efx, link, efx->net_dev,\n\t\t\t\t  \"appears to be plugged into a port\"\n\t\t\t\t  \" that is not 10GBASE-T capable. The PHY\"\n\t\t\t\t  \" supports 10GBASE-T ONLY, so no link can\"\n\t\t\t\t  \" be established\\n\");\n\t\t}\n\t\tef4_mdio_write(efx, MDIO_MMD_PMAPMD,\n\t\t\t       PMA_PMD_LED_OVERR_REG, reg);\n\t\tpd->bad_lp_tries = bad_lp;\n\t}\n}\n\nstatic bool sfx7101_link_ok(struct ef4_nic *efx)\n{\n\treturn ef4_mdio_links_ok(efx,\n\t\t\t\t MDIO_DEVS_PMAPMD |\n\t\t\t\t MDIO_DEVS_PCS |\n\t\t\t\t MDIO_DEVS_PHYXS);\n}\n\nstatic void tenxpress_ext_loopback(struct ef4_nic *efx)\n{\n\tef4_mdio_set_flag(efx, MDIO_MMD_PHYXS, PHYXS_TEST1,\n\t\t\t  1 << LOOPBACK_NEAR_LBN,\n\t\t\t  efx->loopback_mode == LOOPBACK_PHYXS);\n}\n\nstatic void tenxpress_low_power(struct ef4_nic *efx)\n{\n\tef4_mdio_set_mmds_lpower(\n\t\tefx, !!(efx->phy_mode & PHY_MODE_LOW_POWER),\n\t\tTENXPRESS_REQUIRED_DEVS);\n}\n\nstatic int tenxpress_phy_reconfigure(struct ef4_nic *efx)\n{\n\tstruct tenxpress_phy_data *phy_data = efx->phy_data;\n\tbool phy_mode_change, loop_reset;\n\n\tif (efx->phy_mode & (PHY_MODE_OFF | PHY_MODE_SPECIAL)) {\n\t\tphy_data->phy_mode = efx->phy_mode;\n\t\treturn 0;\n\t}\n\n\tphy_mode_change = (efx->phy_mode == PHY_MODE_NORMAL &&\n\t\t\t   phy_data->phy_mode != PHY_MODE_NORMAL);\n\tloop_reset = (LOOPBACK_OUT_OF(phy_data, efx, LOOPBACKS_EXTERNAL(efx)) ||\n\t\t      LOOPBACK_CHANGED(phy_data, efx, 1 << LOOPBACK_GPHY));\n\n\tif (loop_reset || phy_mode_change) {\n\t\ttenxpress_special_reset(efx);\n\t\tfalcon_reset_xaui(efx);\n\t}\n\n\ttenxpress_low_power(efx);\n\tef4_mdio_transmit_disable(efx);\n\tef4_mdio_phy_reconfigure(efx);\n\ttenxpress_ext_loopback(efx);\n\tef4_mdio_an_reconfigure(efx);\n\n\tphy_data->loopback_mode = efx->loopback_mode;\n\tphy_data->phy_mode = efx->phy_mode;\n\n\treturn 0;\n}\n\n \nstatic bool tenxpress_phy_poll(struct ef4_nic *efx)\n{\n\tstruct ef4_link_state old_state = efx->link_state;\n\n\tefx->link_state.up = sfx7101_link_ok(efx);\n\tefx->link_state.speed = 10000;\n\tefx->link_state.fd = true;\n\tefx->link_state.fc = ef4_mdio_get_pause(efx);\n\n\tsfx7101_check_bad_lp(efx, efx->link_state.up);\n\n\treturn !ef4_link_state_equal(&efx->link_state, &old_state);\n}\n\nstatic void sfx7101_phy_fini(struct ef4_nic *efx)\n{\n\tint reg;\n\n\t \n\treg = (1 << PMA_PMD_LNPGA_POWERDOWN_LBN);\n\tef4_mdio_write(efx, MDIO_MMD_PMAPMD, PMA_PMD_XCONTROL_REG, reg);\n\n\t \n\tschedule_timeout_uninterruptible(LNPGA_PDOWN_WAIT);  \n}\n\nstatic void tenxpress_phy_remove(struct ef4_nic *efx)\n{\n\tkfree(efx->phy_data);\n\tefx->phy_data = NULL;\n}\n\n\n \nvoid tenxpress_set_id_led(struct ef4_nic *efx, enum ef4_led_mode mode)\n{\n\tint reg;\n\n\tswitch (mode) {\n\tcase EF4_LED_OFF:\n\t\treg = (PMA_PMD_LED_OFF << PMA_PMD_LED_TX_LBN) |\n\t\t\t(PMA_PMD_LED_OFF << PMA_PMD_LED_RX_LBN) |\n\t\t\t(PMA_PMD_LED_OFF << PMA_PMD_LED_LINK_LBN);\n\t\tbreak;\n\tcase EF4_LED_ON:\n\t\treg = (PMA_PMD_LED_ON << PMA_PMD_LED_TX_LBN) |\n\t\t\t(PMA_PMD_LED_ON << PMA_PMD_LED_RX_LBN) |\n\t\t\t(PMA_PMD_LED_ON << PMA_PMD_LED_LINK_LBN);\n\t\tbreak;\n\tdefault:\n\t\treg = SFX7101_PMA_PMD_LED_DEFAULT;\n\t\tbreak;\n\t}\n\n\tef4_mdio_write(efx, MDIO_MMD_PMAPMD, PMA_PMD_LED_OVERR_REG, reg);\n}\n\nstatic const char *const sfx7101_test_names[] = {\n\t\"bist\"\n};\n\nstatic const char *sfx7101_test_name(struct ef4_nic *efx, unsigned int index)\n{\n\tif (index < ARRAY_SIZE(sfx7101_test_names))\n\t\treturn sfx7101_test_names[index];\n\treturn NULL;\n}\n\nstatic int\nsfx7101_run_tests(struct ef4_nic *efx, int *results, unsigned flags)\n{\n\tint rc;\n\n\tif (!(flags & ETH_TEST_FL_OFFLINE))\n\t\treturn 0;\n\n\t \n\trc = tenxpress_special_reset(efx);\n\tresults[0] = rc ? -1 : 1;\n\n\tef4_mdio_an_reconfigure(efx);\n\n\treturn rc;\n}\n\nstatic void\ntenxpress_get_link_ksettings(struct ef4_nic *efx,\n\t\t\t     struct ethtool_link_ksettings *cmd)\n{\n\tu32 adv = 0, lpa = 0;\n\tint reg;\n\n\treg = ef4_mdio_read(efx, MDIO_MMD_AN, MDIO_AN_10GBT_CTRL);\n\tif (reg & MDIO_AN_10GBT_CTRL_ADV10G)\n\t\tadv |= ADVERTISED_10000baseT_Full;\n\treg = ef4_mdio_read(efx, MDIO_MMD_AN, MDIO_AN_10GBT_STAT);\n\tif (reg & MDIO_AN_10GBT_STAT_LP10G)\n\t\tlpa |= ADVERTISED_10000baseT_Full;\n\n\tmdio45_ethtool_ksettings_get_npage(&efx->mdio, cmd, adv, lpa);\n\n\t \n\tif (LOOPBACK_EXTERNAL(efx))\n\t\tcmd->base.speed = SPEED_10000;\n}\n\nstatic int\ntenxpress_set_link_ksettings(struct ef4_nic *efx,\n\t\t\t     const struct ethtool_link_ksettings *cmd)\n{\n\tif (!cmd->base.autoneg)\n\t\treturn -EINVAL;\n\n\treturn ef4_mdio_set_link_ksettings(efx, cmd);\n}\n\nstatic void sfx7101_set_npage_adv(struct ef4_nic *efx, u32 advertising)\n{\n\tef4_mdio_set_flag(efx, MDIO_MMD_AN, MDIO_AN_10GBT_CTRL,\n\t\t\t  MDIO_AN_10GBT_CTRL_ADV10G,\n\t\t\t  advertising & ADVERTISED_10000baseT_Full);\n}\n\nconst struct ef4_phy_operations falcon_sfx7101_phy_ops = {\n\t.probe\t\t  = tenxpress_phy_probe,\n\t.init             = tenxpress_phy_init,\n\t.reconfigure      = tenxpress_phy_reconfigure,\n\t.poll             = tenxpress_phy_poll,\n\t.fini             = sfx7101_phy_fini,\n\t.remove\t\t  = tenxpress_phy_remove,\n\t.get_link_ksettings = tenxpress_get_link_ksettings,\n\t.set_link_ksettings = tenxpress_set_link_ksettings,\n\t.set_npage_adv    = sfx7101_set_npage_adv,\n\t.test_alive\t  = ef4_mdio_test_alive,\n\t.test_name\t  = sfx7101_test_name,\n\t.run_tests\t  = sfx7101_run_tests,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}