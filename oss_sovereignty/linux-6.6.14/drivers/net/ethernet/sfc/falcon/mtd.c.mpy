{
  "module_name": "mtd.c",
  "hash_id": "854084e6ac5d707b5ba80a3061f0c317bce9b72f811f1a6a8bc329b37ccdddc1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/sfc/falcon/mtd.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/mtd/mtd.h>\n#include <linux/slab.h>\n#include <linux/rtnetlink.h>\n\n#include \"net_driver.h\"\n#include \"efx.h\"\n\n#define to_ef4_mtd_partition(mtd)\t\t\t\t\\\n\tcontainer_of(mtd, struct ef4_mtd_partition, mtd)\n\n \n\nstatic int ef4_mtd_erase(struct mtd_info *mtd, struct erase_info *erase)\n{\n\tstruct ef4_nic *efx = mtd->priv;\n\n\treturn efx->type->mtd_erase(mtd, erase->addr, erase->len);\n}\n\nstatic void ef4_mtd_sync(struct mtd_info *mtd)\n{\n\tstruct ef4_mtd_partition *part = to_ef4_mtd_partition(mtd);\n\tstruct ef4_nic *efx = mtd->priv;\n\tint rc;\n\n\trc = efx->type->mtd_sync(mtd);\n\tif (rc)\n\t\tpr_err(\"%s: %s sync failed (%d)\\n\",\n\t\t       part->name, part->dev_type_name, rc);\n}\n\nstatic void ef4_mtd_remove_partition(struct ef4_mtd_partition *part)\n{\n\tint rc;\n\n\tfor (;;) {\n\t\trc = mtd_device_unregister(&part->mtd);\n\t\tif (rc != -EBUSY)\n\t\t\tbreak;\n\t\tssleep(1);\n\t}\n\tWARN_ON(rc);\n\tlist_del(&part->node);\n}\n\nint ef4_mtd_add(struct ef4_nic *efx, struct ef4_mtd_partition *parts,\n\t\tsize_t n_parts, size_t sizeof_part)\n{\n\tstruct ef4_mtd_partition *part;\n\tsize_t i;\n\n\tfor (i = 0; i < n_parts; i++) {\n\t\tpart = (struct ef4_mtd_partition *)((char *)parts +\n\t\t\t\t\t\t    i * sizeof_part);\n\n\t\tpart->mtd.writesize = 1;\n\n\t\tpart->mtd.owner = THIS_MODULE;\n\t\tpart->mtd.priv = efx;\n\t\tpart->mtd.name = part->name;\n\t\tpart->mtd._erase = ef4_mtd_erase;\n\t\tpart->mtd._read = efx->type->mtd_read;\n\t\tpart->mtd._write = efx->type->mtd_write;\n\t\tpart->mtd._sync = ef4_mtd_sync;\n\n\t\tefx->type->mtd_rename(part);\n\n\t\tif (mtd_device_register(&part->mtd, NULL, 0))\n\t\t\tgoto fail;\n\n\t\t \n\t\tlist_add_tail(&part->node, &efx->mtd_list);\n\t}\n\n\treturn 0;\n\nfail:\n\twhile (i--) {\n\t\tpart = (struct ef4_mtd_partition *)((char *)parts +\n\t\t\t\t\t\t    i * sizeof_part);\n\t\tef4_mtd_remove_partition(part);\n\t}\n\t \n\treturn -ENOMEM;\n}\n\nvoid ef4_mtd_remove(struct ef4_nic *efx)\n{\n\tstruct ef4_mtd_partition *parts, *part, *next;\n\n\tWARN_ON(ef4_dev_registered(efx));\n\n\tif (list_empty(&efx->mtd_list))\n\t\treturn;\n\n\tparts = list_first_entry(&efx->mtd_list, struct ef4_mtd_partition,\n\t\t\t\t node);\n\n\tlist_for_each_entry_safe(part, next, &efx->mtd_list, node)\n\t\tef4_mtd_remove_partition(part);\n\n\tkfree(parts);\n}\n\nvoid ef4_mtd_rename(struct ef4_nic *efx)\n{\n\tstruct ef4_mtd_partition *part;\n\n\tASSERT_RTNL();\n\n\tlist_for_each_entry(part, &efx->mtd_list, node)\n\t\tefx->type->mtd_rename(part);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}