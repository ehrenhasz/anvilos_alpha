{
  "module_name": "spl2sw_desc.c",
  "hash_id": "9d2861a0d4a7a82ef9a09b643530686cc8bb6e035f8502f6ddefe2b763810de6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/sunplus/spl2sw_desc.c",
  "human_readable_source": "\n \n\n#include <linux/platform_device.h>\n#include <linux/netdevice.h>\n#include <linux/of_mdio.h>\n\n#include \"spl2sw_define.h\"\n#include \"spl2sw_desc.h\"\n\nvoid spl2sw_rx_descs_flush(struct spl2sw_common *comm)\n{\n\tstruct spl2sw_skb_info *rx_skbinfo;\n\tstruct spl2sw_mac_desc *rx_desc;\n\tu32 i, j;\n\n\tfor (i = 0; i < RX_DESC_QUEUE_NUM; i++) {\n\t\trx_desc = comm->rx_desc[i];\n\t\trx_skbinfo = comm->rx_skb_info[i];\n\t\tfor (j = 0; j < comm->rx_desc_num[i]; j++) {\n\t\t\trx_desc[j].addr1 = rx_skbinfo[j].mapping;\n\t\t\trx_desc[j].cmd2 = (j == comm->rx_desc_num[i] - 1) ?\n\t\t\t\t\t  RXD_EOR | comm->rx_desc_buff_size :\n\t\t\t\t\t  comm->rx_desc_buff_size;\n\t\t\twmb();\t \n\t\t\trx_desc[j].cmd1 = RXD_OWN;\n\t\t}\n\t}\n}\n\nvoid spl2sw_tx_descs_clean(struct spl2sw_common *comm)\n{\n\tu32 i;\n\n\tif (!comm->tx_desc)\n\t\treturn;\n\n\tfor (i = 0; i < TX_DESC_NUM; i++) {\n\t\tcomm->tx_desc[i].cmd1 = 0;\n\t\twmb();\t \n\t\tcomm->tx_desc[i].cmd2 = 0;\n\t\tcomm->tx_desc[i].addr1 = 0;\n\t\tcomm->tx_desc[i].addr2 = 0;\n\n\t\tif (comm->tx_temp_skb_info[i].mapping) {\n\t\t\tdma_unmap_single(&comm->pdev->dev, comm->tx_temp_skb_info[i].mapping,\n\t\t\t\t\t comm->tx_temp_skb_info[i].skb->len, DMA_TO_DEVICE);\n\t\t\tcomm->tx_temp_skb_info[i].mapping = 0;\n\t\t}\n\n\t\tif (comm->tx_temp_skb_info[i].skb) {\n\t\t\tdev_kfree_skb_any(comm->tx_temp_skb_info[i].skb);\n\t\t\tcomm->tx_temp_skb_info[i].skb = NULL;\n\t\t}\n\t}\n}\n\nvoid spl2sw_rx_descs_clean(struct spl2sw_common *comm)\n{\n\tstruct spl2sw_skb_info *rx_skbinfo;\n\tstruct spl2sw_mac_desc *rx_desc;\n\tu32 i, j;\n\n\tfor (i = 0; i < RX_DESC_QUEUE_NUM; i++) {\n\t\tif (!comm->rx_skb_info[i])\n\t\t\tcontinue;\n\n\t\trx_desc = comm->rx_desc[i];\n\t\trx_skbinfo = comm->rx_skb_info[i];\n\t\tfor (j = 0; j < comm->rx_desc_num[i]; j++) {\n\t\t\trx_desc[j].cmd1 = 0;\n\t\t\twmb();\t \n\t\t\trx_desc[j].cmd2 = 0;\n\t\t\trx_desc[j].addr1 = 0;\n\n\t\t\tif (rx_skbinfo[j].skb) {\n\t\t\t\tdma_unmap_single(&comm->pdev->dev, rx_skbinfo[j].mapping,\n\t\t\t\t\t\t comm->rx_desc_buff_size, DMA_FROM_DEVICE);\n\t\t\t\tdev_kfree_skb_any(rx_skbinfo[j].skb);\n\t\t\t\trx_skbinfo[j].skb = NULL;\n\t\t\t\trx_skbinfo[j].mapping = 0;\n\t\t\t}\n\t\t}\n\n\t\tkfree(rx_skbinfo);\n\t\tcomm->rx_skb_info[i] = NULL;\n\t}\n}\n\nvoid spl2sw_descs_clean(struct spl2sw_common *comm)\n{\n\tspl2sw_rx_descs_clean(comm);\n\tspl2sw_tx_descs_clean(comm);\n}\n\nvoid spl2sw_descs_free(struct spl2sw_common *comm)\n{\n\tu32 i;\n\n\tspl2sw_descs_clean(comm);\n\tcomm->tx_desc = NULL;\n\tfor (i = 0; i < RX_DESC_QUEUE_NUM; i++)\n\t\tcomm->rx_desc[i] = NULL;\n\n\t \n\tif (comm->desc_base) {\n\t\tdma_free_coherent(&comm->pdev->dev, comm->desc_size, comm->desc_base,\n\t\t\t\t  comm->desc_dma);\n\t\tcomm->desc_base = NULL;\n\t\tcomm->desc_dma = 0;\n\t\tcomm->desc_size = 0;\n\t}\n}\n\nvoid spl2sw_tx_descs_init(struct spl2sw_common *comm)\n{\n\tmemset(comm->tx_desc, '\\0', sizeof(struct spl2sw_mac_desc) *\n\t       (TX_DESC_NUM + MAC_GUARD_DESC_NUM));\n}\n\nint spl2sw_rx_descs_init(struct spl2sw_common *comm)\n{\n\tstruct spl2sw_skb_info *rx_skbinfo;\n\tstruct spl2sw_mac_desc *rx_desc;\n\tstruct sk_buff *skb;\n\tu32 mapping;\n\tu32 i, j;\n\n\tfor (i = 0; i < RX_DESC_QUEUE_NUM; i++) {\n\t\tcomm->rx_skb_info[i] = kcalloc(comm->rx_desc_num[i], sizeof(*rx_skbinfo),\n\t\t\t\t\t       GFP_KERNEL | GFP_DMA);\n\t\tif (!comm->rx_skb_info[i])\n\t\t\tgoto mem_alloc_fail;\n\n\t\trx_skbinfo = comm->rx_skb_info[i];\n\t\trx_desc = comm->rx_desc[i];\n\t\tfor (j = 0; j < comm->rx_desc_num[i]; j++) {\n\t\t\tskb = netdev_alloc_skb(NULL, comm->rx_desc_buff_size);\n\t\t\tif (!skb)\n\t\t\t\tgoto mem_alloc_fail;\n\n\t\t\trx_skbinfo[j].skb = skb;\n\t\t\tmapping = dma_map_single(&comm->pdev->dev, skb->data,\n\t\t\t\t\t\t comm->rx_desc_buff_size,\n\t\t\t\t\t\t DMA_FROM_DEVICE);\n\t\t\tif (dma_mapping_error(&comm->pdev->dev, mapping))\n\t\t\t\tgoto mem_alloc_fail;\n\n\t\t\trx_skbinfo[j].mapping = mapping;\n\t\t\trx_desc[j].addr1 = mapping;\n\t\t\trx_desc[j].addr2 = 0;\n\t\t\trx_desc[j].cmd2 = (j == comm->rx_desc_num[i] - 1) ?\n\t\t\t\t\t  RXD_EOR | comm->rx_desc_buff_size :\n\t\t\t\t\t  comm->rx_desc_buff_size;\n\t\t\twmb();\t \n\t\t\trx_desc[j].cmd1 = RXD_OWN;\n\t\t}\n\t}\n\n\treturn 0;\n\nmem_alloc_fail:\n\tspl2sw_rx_descs_clean(comm);\n\treturn -ENOMEM;\n}\n\nint spl2sw_descs_alloc(struct spl2sw_common *comm)\n{\n\ts32 desc_size;\n\tu32 i;\n\n\t \n\tdesc_size = (TX_DESC_NUM + MAC_GUARD_DESC_NUM) * sizeof(struct spl2sw_mac_desc);\n\tfor (i = 0; i < RX_DESC_QUEUE_NUM; i++)\n\t\tdesc_size += comm->rx_desc_num[i] * sizeof(struct spl2sw_mac_desc);\n\n\tcomm->desc_base = dma_alloc_coherent(&comm->pdev->dev, desc_size, &comm->desc_dma,\n\t\t\t\t\t     GFP_KERNEL);\n\tif (!comm->desc_base)\n\t\treturn -ENOMEM;\n\n\tcomm->desc_size = desc_size;\n\n\t \n\tcomm->tx_desc = comm->desc_base;\n\n\t \n\tcomm->rx_desc[0] = &comm->tx_desc[TX_DESC_NUM + MAC_GUARD_DESC_NUM];\n\tfor (i = 1; i < RX_DESC_QUEUE_NUM; i++)\n\t\tcomm->rx_desc[i] = comm->rx_desc[i - 1] + comm->rx_desc_num[i - 1];\n\n\treturn 0;\n}\n\nint spl2sw_descs_init(struct spl2sw_common *comm)\n{\n\tu32 i, ret;\n\n\t \n\tcomm->rx_desc_num[0] = RX_QUEUE0_DESC_NUM;\n\tcomm->rx_desc_num[1] = RX_QUEUE1_DESC_NUM;\n\n\tfor (i = 0; i < RX_DESC_QUEUE_NUM; i++) {\n\t\tcomm->rx_desc[i] = NULL;\n\t\tcomm->rx_skb_info[i] = NULL;\n\t\tcomm->rx_pos[i] = 0;\n\t}\n\tcomm->rx_desc_buff_size = MAC_RX_LEN_MAX;\n\n\t \n\tcomm->tx_done_pos = 0;\n\tcomm->tx_desc = NULL;\n\tcomm->tx_pos = 0;\n\tcomm->tx_desc_full = 0;\n\tfor (i = 0; i < TX_DESC_NUM; i++)\n\t\tcomm->tx_temp_skb_info[i].skb = NULL;\n\n\t \n\tret = spl2sw_descs_alloc(comm);\n\tif (ret)\n\t\treturn ret;\n\n\tspl2sw_tx_descs_init(comm);\n\n\treturn spl2sw_rx_descs_init(comm);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}