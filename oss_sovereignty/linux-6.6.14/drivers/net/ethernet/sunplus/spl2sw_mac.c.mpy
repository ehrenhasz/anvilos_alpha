{
  "module_name": "spl2sw_mac.c",
  "hash_id": "df304bca7a81d6148512ffc4d8da6f9fc66fca64d413dd811fa26518af8e16af",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/sunplus/spl2sw_mac.c",
  "human_readable_source": "\n \n\n#include <linux/platform_device.h>\n#include <linux/netdevice.h>\n#include <linux/bitfield.h>\n#include <linux/of_mdio.h>\n\n#include \"spl2sw_register.h\"\n#include \"spl2sw_define.h\"\n#include \"spl2sw_desc.h\"\n#include \"spl2sw_mac.h\"\n\nvoid spl2sw_mac_hw_stop(struct spl2sw_common *comm)\n{\n\tu32 reg;\n\n\tif (comm->enable == 0) {\n\t\t \n\t\twritel(0xffffffff, comm->l2sw_reg_base + L2SW_SW_INT_MASK_0);\n\t\twritel(0xffffffff, comm->l2sw_reg_base + L2SW_SW_INT_STATUS_0);\n\n\t\t \n\t\treg = readl(comm->l2sw_reg_base + L2SW_CPU_CNTL);\n\t\treg |= MAC_DIS_SOC1_CPU | MAC_DIS_SOC0_CPU;\n\t\twritel(reg, comm->l2sw_reg_base + L2SW_CPU_CNTL);\n\t}\n\n\t \n\treg = readl(comm->l2sw_reg_base + L2SW_PORT_CNTL0);\n\treg |= FIELD_PREP(MAC_DIS_PORT, ~comm->enable);\n\twritel(reg, comm->l2sw_reg_base + L2SW_PORT_CNTL0);\n}\n\nvoid spl2sw_mac_hw_start(struct spl2sw_common *comm)\n{\n\tu32 reg;\n\n\t \n\treg = readl(comm->l2sw_reg_base + L2SW_CPU_CNTL);\n\treg &= ~MAC_DIS_SOC0_CPU;\n\treg |= MAC_EN_CRC_SOC0;\n\twritel(reg, comm->l2sw_reg_base + L2SW_CPU_CNTL);\n\n\t \n\treg = readl(comm->l2sw_reg_base + L2SW_PORT_CNTL0);\n\treg &= FIELD_PREP(MAC_DIS_PORT, ~comm->enable) | ~MAC_DIS_PORT;\n\twritel(reg, comm->l2sw_reg_base + L2SW_PORT_CNTL0);\n}\n\nint spl2sw_mac_addr_add(struct spl2sw_mac *mac)\n{\n\tstruct spl2sw_common *comm = mac->comm;\n\tu32 reg;\n\tint ret;\n\n\t \n\twritel((mac->mac_addr[0] << 0) + (mac->mac_addr[1] << 8),\n\t       comm->l2sw_reg_base + L2SW_W_MAC_15_0);\n\twritel((mac->mac_addr[2] << 0) + (mac->mac_addr[3] << 8) +\n\t       (mac->mac_addr[4] << 16) + (mac->mac_addr[5] << 24),\n\t       comm->l2sw_reg_base + L2SW_W_MAC_47_16);\n\n\t \n\treg = MAC_W_CPU_PORT_0 | FIELD_PREP(MAC_W_VID, mac->vlan_id) |\n\t      FIELD_PREP(MAC_W_AGE, 1) | MAC_W_MAC_CMD;\n\twritel(reg, comm->l2sw_reg_base + L2SW_WT_MAC_AD0);\n\n\t \n\tret = read_poll_timeout(readl, reg, reg & MAC_W_MAC_DONE, 1, 200, true,\n\t\t\t\tcomm->l2sw_reg_base + L2SW_WT_MAC_AD0);\n\tif (ret) {\n\t\tnetdev_err(mac->ndev, \"Failed to add address to table!\\n\");\n\t\treturn ret;\n\t}\n\n\tnetdev_dbg(mac->ndev, \"mac_ad0 = %08x, mac_ad = %08x%04x\\n\",\n\t\t   readl(comm->l2sw_reg_base + L2SW_WT_MAC_AD0),\n\t\t   (u32)FIELD_GET(MAC_W_MAC_47_16,\n\t\t   readl(comm->l2sw_reg_base + L2SW_W_MAC_47_16)),\n\t\t   (u32)FIELD_GET(MAC_W_MAC_15_0,\n\t\t   readl(comm->l2sw_reg_base + L2SW_W_MAC_15_0)));\n\treturn 0;\n}\n\nint spl2sw_mac_addr_del(struct spl2sw_mac *mac)\n{\n\tstruct spl2sw_common *comm = mac->comm;\n\tu32 reg;\n\tint ret;\n\n\t \n\twritel((mac->mac_addr[0] << 0) + (mac->mac_addr[1] << 8),\n\t       comm->l2sw_reg_base + L2SW_W_MAC_15_0);\n\twritel((mac->mac_addr[2] << 0) + (mac->mac_addr[3] << 8) +\n\t       (mac->mac_addr[4] << 16) + (mac->mac_addr[5] << 24),\n\t       comm->l2sw_reg_base + L2SW_W_MAC_47_16);\n\n\t \n\treg = MAC_W_LAN_PORT_0 | FIELD_PREP(MAC_W_VID, mac->vlan_id) | MAC_W_MAC_CMD;\n\twritel(reg, comm->l2sw_reg_base + L2SW_WT_MAC_AD0);\n\n\t \n\tret = read_poll_timeout(readl, reg, reg & MAC_W_MAC_DONE, 1, 200, true,\n\t\t\t\tcomm->l2sw_reg_base + L2SW_WT_MAC_AD0);\n\tif (ret) {\n\t\tnetdev_err(mac->ndev, \"Failed to delete address from table!\\n\");\n\t\treturn ret;\n\t}\n\n\tnetdev_dbg(mac->ndev, \"mac_ad0 = %08x, mac_ad = %08x%04x\\n\",\n\t\t   readl(comm->l2sw_reg_base + L2SW_WT_MAC_AD0),\n\t\t   (u32)FIELD_GET(MAC_W_MAC_47_16,\n\t\t   readl(comm->l2sw_reg_base + L2SW_W_MAC_47_16)),\n\t\t   (u32)FIELD_GET(MAC_W_MAC_15_0,\n\t\t   readl(comm->l2sw_reg_base + L2SW_W_MAC_15_0)));\n\treturn 0;\n}\n\nvoid spl2sw_mac_hw_init(struct spl2sw_common *comm)\n{\n\tu32 reg;\n\n\t \n\treg = readl(comm->l2sw_reg_base + L2SW_CPU_CNTL);\n\treg |= MAC_DIS_SOC1_CPU | MAC_DIS_SOC0_CPU;\n\twritel(reg, comm->l2sw_reg_base + L2SW_CPU_CNTL);\n\n\t \n\twritel(comm->desc_dma, comm->l2sw_reg_base + L2SW_TX_LBASE_ADDR_0);\n\twritel(comm->desc_dma + sizeof(struct spl2sw_mac_desc) * TX_DESC_NUM,\n\t       comm->l2sw_reg_base + L2SW_TX_HBASE_ADDR_0);\n\twritel(comm->desc_dma + sizeof(struct spl2sw_mac_desc) * (TX_DESC_NUM +\n\t       MAC_GUARD_DESC_NUM), comm->l2sw_reg_base + L2SW_RX_HBASE_ADDR_0);\n\twritel(comm->desc_dma + sizeof(struct spl2sw_mac_desc) * (TX_DESC_NUM +\n\t       MAC_GUARD_DESC_NUM + RX_QUEUE0_DESC_NUM),\n\t       comm->l2sw_reg_base + L2SW_RX_LBASE_ADDR_0);\n\n\t \n\twritel(0x4a3a2d1d, comm->l2sw_reg_base + L2SW_FL_CNTL_TH);\n\n\t \n\twritel(0x4a3a1212, comm->l2sw_reg_base + L2SW_CPU_FL_CNTL_TH);\n\n\t \n\twritel(0xf6680000, comm->l2sw_reg_base + L2SW_PRI_FL_CNTL);\n\n\t \n\treg = readl(comm->l2sw_reg_base + L2SW_LED_PORT0);\n\treg |= MAC_LED_ACT_HI;\n\twritel(reg, comm->l2sw_reg_base + L2SW_LED_PORT0);\n\n\t \n\treg = readl(comm->l2sw_reg_base + L2SW_CPU_CNTL);\n\treg &= ~(MAC_EN_SOC1_AGING | MAC_EN_SOC0_AGING |\n\t\t MAC_DIS_BC2CPU_P1 | MAC_DIS_BC2CPU_P0 |\n\t\t MAC_DIS_MC2CPU_P1 | MAC_DIS_MC2CPU_P0);\n\treg |= MAC_DIS_LRN_SOC1 | MAC_DIS_LRN_SOC0;\n\twritel(reg, comm->l2sw_reg_base + L2SW_CPU_CNTL);\n\n\t \n\treg = readl(comm->l2sw_reg_base + L2SW_PORT_CNTL0);\n\treg &= ~(MAC_DIS_RMC2CPU_P1 | MAC_DIS_RMC2CPU_P0);\n\treg |= MAC_EN_FLOW_CTL_P1 | MAC_EN_FLOW_CTL_P0 |\n\t       MAC_EN_BACK_PRESS_P1 | MAC_EN_BACK_PRESS_P0;\n\twritel(reg, comm->l2sw_reg_base + L2SW_PORT_CNTL0);\n\n\t \n\treg = readl(comm->l2sw_reg_base + L2SW_PORT_CNTL1);\n\treg |= MAC_DIS_SA_LRN_P1 | MAC_DIS_SA_LRN_P0;\n\twritel(reg, comm->l2sw_reg_base + L2SW_PORT_CNTL1);\n\n\t \n\treg = readl(comm->l2sw_reg_base + L2SW_MAC_FORCE_MODE);\n\treg &= ~(MAC_EXT_PHY1_ADDR | MAC_EXT_PHY0_ADDR);\n\treg |= FIELD_PREP(MAC_EXT_PHY1_ADDR, 31) | FIELD_PREP(MAC_EXT_PHY0_ADDR, 31);\n\treg |= MAC_FORCE_RMII_EN_1 | MAC_FORCE_RMII_EN_0;\n\twritel(reg, comm->l2sw_reg_base + L2SW_MAC_FORCE_MODE);\n\n\t \n\treg = FIELD_PREP(MAC_P1_PVID, 1) | FIELD_PREP(MAC_P0_PVID, 0);\n\twritel(reg, comm->l2sw_reg_base + L2SW_PVID_CONFIG0);\n\n\t \n\treg = FIELD_PREP(MAC_VLAN_MEMSET_1, 0xa) | FIELD_PREP(MAC_VLAN_MEMSET_0, 9);\n\twritel(reg, comm->l2sw_reg_base + L2SW_VLAN_MEMSET_CONFIG0);\n\n\t \n\treg = readl(comm->l2sw_reg_base + L2SW_SW_GLB_CNTL);\n\treg &= ~(MAC_RMC_TB_FAULT_RULE | MAC_LED_FLASH_TIME | MAC_BC_STORM_PREV);\n\treg |= FIELD_PREP(MAC_RMC_TB_FAULT_RULE, 1) |\n\t       FIELD_PREP(MAC_LED_FLASH_TIME, 1) |\n\t       FIELD_PREP(MAC_BC_STORM_PREV, 1);\n\twritel(reg, comm->l2sw_reg_base + L2SW_SW_GLB_CNTL);\n\n\twritel(MAC_INT_MASK_DEF, comm->l2sw_reg_base + L2SW_SW_INT_MASK_0);\n}\n\nvoid spl2sw_mac_rx_mode_set(struct spl2sw_mac *mac)\n{\n\tstruct spl2sw_common *comm = mac->comm;\n\tstruct net_device *ndev = mac->ndev;\n\tu32 mask, reg, rx_mode;\n\n\tnetdev_dbg(ndev, \"ndev->flags = %08x\\n\", ndev->flags);\n\tmask = FIELD_PREP(MAC_DIS_MC2CPU, mac->lan_port) |\n\t       FIELD_PREP(MAC_DIS_UN2CPU, mac->lan_port);\n\treg = readl(comm->l2sw_reg_base + L2SW_CPU_CNTL);\n\n\tif (ndev->flags & IFF_PROMISC) {\n\t\t \n\t\trx_mode = FIELD_PREP(MAC_DIS_MC2CPU, mac->lan_port) |\n\t\t\t  FIELD_PREP(MAC_DIS_UN2CPU, mac->lan_port);\n\t} else if ((!netdev_mc_empty(ndev) && (ndev->flags & IFF_MULTICAST)) ||\n\t\t   (ndev->flags & IFF_ALLMULTI)) {\n\t\t \n\t\trx_mode = FIELD_PREP(MAC_DIS_MC2CPU, mac->lan_port);\n\t} else {\n\t\t \n\t\trx_mode = 0;\n\t}\n\n\twritel((reg & (~mask)) | ((~rx_mode) & mask), comm->l2sw_reg_base + L2SW_CPU_CNTL);\n\tnetdev_dbg(ndev, \"cpu_cntl = %08x\\n\", readl(comm->l2sw_reg_base + L2SW_CPU_CNTL));\n}\n\nvoid spl2sw_mac_init(struct spl2sw_common *comm)\n{\n\tu32 i;\n\n\tfor (i = 0; i < RX_DESC_QUEUE_NUM; i++)\n\t\tcomm->rx_pos[i] = 0;\n\tmb();\t \n\n\tspl2sw_mac_hw_init(comm);\n}\n\nvoid spl2sw_mac_soft_reset(struct spl2sw_common *comm)\n{\n\tu32 i;\n\n\tspl2sw_mac_hw_stop(comm);\n\n\tspl2sw_rx_descs_flush(comm);\n\tcomm->tx_pos = 0;\n\tcomm->tx_done_pos = 0;\n\tcomm->tx_desc_full = 0;\n\n\tfor (i = 0; i < RX_DESC_QUEUE_NUM; i++)\n\t\tcomm->rx_pos[i] = 0;\n\tmb();\t \n\n\tspl2sw_mac_hw_init(comm);\n\tspl2sw_mac_hw_start(comm);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}