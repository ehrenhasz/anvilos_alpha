{
  "module_name": "hw_atl_a0.c",
  "hash_id": "67de5a076d80af5c6beb6d5f8739ab95d6841fa899b6775171688048849cd646",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/aquantia/atlantic/hw_atl/hw_atl_a0.c",
  "human_readable_source": "\n \n\n \n\n#include \"../aq_hw.h\"\n#include \"../aq_hw_utils.h\"\n#include \"../aq_ring.h\"\n#include \"../aq_nic.h\"\n#include \"hw_atl_a0.h\"\n#include \"hw_atl_utils.h\"\n#include \"hw_atl_llh.h\"\n#include \"hw_atl_a0_internal.h\"\n\n#define DEFAULT_A0_BOARD_BASIC_CAPABILITIES\t     \\\n\t.is_64_dma = true,\t\t\t     \\\n\t.op64bit = false,\t\t\t     \\\n\t.msix_irqs = 4U,\t\t\t     \\\n\t.irq_mask = ~0U,\t\t\t     \\\n\t.vecs = HW_ATL_A0_RSS_MAX,\t\t     \\\n\t.tcs_max = HW_ATL_A0_TC_MAX,\t\t     \\\n\t.rxd_alignment = 1U,\t\t\t     \\\n\t.rxd_size = HW_ATL_A0_RXD_SIZE,\t\t     \\\n\t.rxds_max = HW_ATL_A0_MAX_RXD,\t\t     \\\n\t.rxds_min = HW_ATL_A0_MIN_RXD,\t\t     \\\n\t.txd_alignment = 1U,\t\t\t     \\\n\t.txd_size = HW_ATL_A0_TXD_SIZE,\t\t     \\\n\t.txds_max = HW_ATL_A0_MAX_TXD,\t\t     \\\n\t.txds_min = HW_ATL_A0_MIN_RXD,\t\t     \\\n\t.txhwb_alignment = 4096U,\t\t     \\\n\t.tx_rings = HW_ATL_A0_TX_RINGS,\t\t     \\\n\t.rx_rings = HW_ATL_A0_RX_RINGS,\t\t     \\\n\t.hw_features = NETIF_F_HW_CSUM |\t     \\\n\t\t\tNETIF_F_RXHASH |\t     \\\n\t\t\tNETIF_F_RXCSUM |\t     \\\n\t\t\tNETIF_F_SG |\t\t     \\\n\t\t\tNETIF_F_TSO |\t\t     \\\n\t\t\tNETIF_F_NTUPLE |\t     \\\n\t\t\tNETIF_F_HW_VLAN_CTAG_FILTER, \\\n\t.hw_priv_flags = IFF_UNICAST_FLT,\t     \\\n\t.flow_control = true,\t\t\t     \\\n\t.mtu = HW_ATL_A0_MTU_JUMBO,\t\t     \\\n\t.mac_regs_count = 88,\t\t\t     \\\n\t.hw_alive_check_addr = 0x10U\n\nconst struct aq_hw_caps_s hw_atl_a0_caps_aqc100 = {\n\tDEFAULT_A0_BOARD_BASIC_CAPABILITIES,\n\t.media_type = AQ_HW_MEDIA_TYPE_FIBRE,\n\t.link_speed_msk = AQ_NIC_RATE_5G |\n\t\t\t  AQ_NIC_RATE_2G5 |\n\t\t\t  AQ_NIC_RATE_1G |\n\t\t\t  AQ_NIC_RATE_100M,\n};\n\nconst struct aq_hw_caps_s hw_atl_a0_caps_aqc107 = {\n\tDEFAULT_A0_BOARD_BASIC_CAPABILITIES,\n\t.media_type = AQ_HW_MEDIA_TYPE_TP,\n\t.link_speed_msk = AQ_NIC_RATE_10G |\n\t\t\t  AQ_NIC_RATE_5G |\n\t\t\t  AQ_NIC_RATE_2G5 |\n\t\t\t  AQ_NIC_RATE_1G |\n\t\t\t  AQ_NIC_RATE_100M,\n};\n\nconst struct aq_hw_caps_s hw_atl_a0_caps_aqc108 = {\n\tDEFAULT_A0_BOARD_BASIC_CAPABILITIES,\n\t.media_type = AQ_HW_MEDIA_TYPE_TP,\n\t.link_speed_msk = AQ_NIC_RATE_5G |\n\t\t\t  AQ_NIC_RATE_2G5 |\n\t\t\t  AQ_NIC_RATE_1G |\n\t\t\t  AQ_NIC_RATE_100M,\n};\n\nconst struct aq_hw_caps_s hw_atl_a0_caps_aqc109 = {\n\tDEFAULT_A0_BOARD_BASIC_CAPABILITIES,\n\t.media_type = AQ_HW_MEDIA_TYPE_TP,\n\t.link_speed_msk = AQ_NIC_RATE_2G5 |\n\t\t\t  AQ_NIC_RATE_1G |\n\t\t\t  AQ_NIC_RATE_100M,\n};\n\nstatic int hw_atl_a0_hw_reset(struct aq_hw_s *self)\n{\n\tint err = 0;\n\tu32 val;\n\n\thw_atl_glb_glb_reg_res_dis_set(self, 1U);\n\thw_atl_pci_pci_reg_res_dis_set(self, 0U);\n\thw_atl_rx_rx_reg_res_dis_set(self, 0U);\n\thw_atl_tx_tx_reg_res_dis_set(self, 0U);\n\n\tHW_ATL_FLUSH();\n\thw_atl_glb_soft_res_set(self, 1);\n\n\t \n\terr = readx_poll_timeout_atomic(hw_atl_glb_soft_res_get,\n\t\t\t\t\tself, val, val == 0,\n\t\t\t\t\t1000U, 10000U);\n\tif (err < 0)\n\t\tgoto err_exit;\n\n\thw_atl_itr_irq_reg_res_dis_set(self, 0U);\n\thw_atl_itr_res_irq_set(self, 1U);\n\n\t \n\terr = readx_poll_timeout_atomic(hw_atl_itr_res_irq_get,\n\t\t\t\t\tself, val, val == 0,\n\t\t\t\t\t1000U, 10000U);\n\tif (err < 0)\n\t\tgoto err_exit;\n\n\tself->aq_fw_ops->set_state(self, MPI_RESET);\n\n\terr = aq_hw_err_from_flags(self);\n\nerr_exit:\n\treturn err;\n}\n\nstatic int hw_atl_a0_hw_qos_set(struct aq_hw_s *self)\n{\n\tbool is_rx_flow_control = false;\n\tunsigned int i_priority = 0U;\n\tu32 buff_size = 0U;\n\tu32 tc = 0U;\n\n\t \n\thw_atl_tps_tx_pkt_shed_desc_rate_curr_time_res_set(self, 0x0U);\n\thw_atl_tps_tx_pkt_shed_desc_rate_lim_set(self, 0xA);\n\n\t \n\thw_atl_tps_tx_pkt_shed_desc_vm_arb_mode_set(self, 0U);\n\n\t \n\thw_atl_tps_tx_pkt_shed_desc_tc_arb_mode_set(self, 0U);\n\thw_atl_tps_tx_pkt_shed_data_arb_mode_set(self, 0U);\n\n\thw_atl_tps_tx_pkt_shed_tc_data_max_credit_set(self, 0U, 0xFFF);\n\thw_atl_tps_tx_pkt_shed_tc_data_weight_set(self, 0U, 0x64);\n\thw_atl_tps_tx_pkt_shed_desc_tc_max_credit_set(self, 0U, 0x50);\n\thw_atl_tps_tx_pkt_shed_desc_tc_weight_set(self, 0U, 0x1E);\n\n\t \n\tbuff_size = HW_ATL_A0_TXBUF_MAX;\n\n\thw_atl_tpb_tx_pkt_buff_size_per_tc_set(self, buff_size, tc);\n\thw_atl_tpb_tx_buff_hi_threshold_per_tc_set(self,\n\t\t\t\t\t\t   (buff_size *\n\t\t\t\t\t\t   (1024 / 32U) * 66U) /\n\t\t\t\t\t\t   100U, tc);\n\thw_atl_tpb_tx_buff_lo_threshold_per_tc_set(self,\n\t\t\t\t\t\t   (buff_size *\n\t\t\t\t\t\t   (1024 / 32U) * 50U) /\n\t\t\t\t\t\t   100U, tc);\n\n\t \n\ttc = 0;\n\tis_rx_flow_control = (AQ_NIC_FC_RX & self->aq_nic_cfg->fc.req);\n\tbuff_size = HW_ATL_A0_RXBUF_MAX;\n\n\thw_atl_rpb_rx_pkt_buff_size_per_tc_set(self, buff_size, tc);\n\thw_atl_rpb_rx_buff_hi_threshold_per_tc_set(self,\n\t\t\t\t\t\t   (buff_size *\n\t\t\t\t\t\t   (1024U / 32U) * 66U) /\n\t\t\t\t\t\t   100U, tc);\n\thw_atl_rpb_rx_buff_lo_threshold_per_tc_set(self,\n\t\t\t\t\t\t   (buff_size *\n\t\t\t\t\t\t   (1024U / 32U) * 50U) /\n\t\t\t\t\t\t   100U, tc);\n\thw_atl_rpb_rx_xoff_en_per_tc_set(self, is_rx_flow_control ? 1U : 0U, tc);\n\n\t \n\tfor (i_priority = 8U; i_priority--;)\n\t\thw_atl_rpf_rpb_user_priority_tc_map_set(self, i_priority, 0U);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_rss_hash_set(struct aq_hw_s *self,\n\t\t\t\t     struct aq_rss_parameters *rss_params)\n{\n\tstruct aq_nic_cfg_s *cfg = self->aq_nic_cfg;\n\tunsigned int addr = 0U;\n\tunsigned int i = 0U;\n\tint err = 0;\n\tu32 val;\n\n\tfor (i = 10, addr = 0U; i--; ++addr) {\n\t\tu32 key_data = cfg->is_rss ?\n\t\t\t__swab32(rss_params->hash_secret_key[i]) : 0U;\n\t\thw_atl_rpf_rss_key_wr_data_set(self, key_data);\n\t\thw_atl_rpf_rss_key_addr_set(self, addr);\n\t\thw_atl_rpf_rss_key_wr_en_set(self, 1U);\n\t\terr = readx_poll_timeout_atomic(hw_atl_rpf_rss_key_wr_en_get,\n\t\t\t\t\t\tself, val, val == 0,\n\t\t\t\t\t\t1000U, 10000U);\n\t\tif (err < 0)\n\t\t\tgoto err_exit;\n\t}\n\n\terr = aq_hw_err_from_flags(self);\n\nerr_exit:\n\treturn err;\n}\n\nstatic int hw_atl_a0_hw_rss_set(struct aq_hw_s *self,\n\t\t\t\tstruct aq_rss_parameters *rss_params)\n{\n\tu32 num_rss_queues = max(1U, self->aq_nic_cfg->num_rss_queues);\n\tu8 *indirection_table =\trss_params->indirection_table;\n\tu16 bitary[1 + (HW_ATL_A0_RSS_REDIRECTION_MAX *\n\t\t   HW_ATL_A0_RSS_REDIRECTION_BITS / 16U)];\n\tint err = 0;\n\tu32 i = 0U;\n\tu32 val;\n\n\tmemset(bitary, 0, sizeof(bitary));\n\n\tfor (i = HW_ATL_A0_RSS_REDIRECTION_MAX; i--; ) {\n\t\t(*(u32 *)(bitary + ((i * 3U) / 16U))) |=\n\t\t\t((indirection_table[i] % num_rss_queues) <<\n\t\t\t((i * 3U) & 0xFU));\n\t}\n\n\tfor (i = ARRAY_SIZE(bitary); i--;) {\n\t\thw_atl_rpf_rss_redir_tbl_wr_data_set(self, bitary[i]);\n\t\thw_atl_rpf_rss_redir_tbl_addr_set(self, i);\n\t\thw_atl_rpf_rss_redir_wr_en_set(self, 1U);\n\t\terr = readx_poll_timeout_atomic(hw_atl_rpf_rss_redir_wr_en_get,\n\t\t\t\t\t\tself, val, val == 0,\n\t\t\t\t\t\t1000U, 10000U);\n\t\tif (err < 0)\n\t\t\tgoto err_exit;\n\t}\n\n\terr = aq_hw_err_from_flags(self);\n\nerr_exit:\n\treturn err;\n}\n\nstatic int hw_atl_a0_hw_offload_set(struct aq_hw_s *self,\n\t\t\t\t    struct aq_nic_cfg_s *aq_nic_cfg)\n{\n\t \n\thw_atl_tpo_ipv4header_crc_offload_en_set(self, 1);\n\thw_atl_tpo_tcp_udp_crc_offload_en_set(self, 1);\n\n\t \n\thw_atl_rpo_ipv4header_crc_offload_en_set(self, 1);\n\thw_atl_rpo_tcp_udp_crc_offload_en_set(self, 1);\n\n\t \n\thw_atl_tdm_large_send_offload_en_set(self, 0xFFFFFFFFU);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_init_tx_path(struct aq_hw_s *self)\n{\n\thw_atl_thm_lso_tcp_flag_of_first_pkt_set(self, 0x0FF6U);\n\thw_atl_thm_lso_tcp_flag_of_middle_pkt_set(self, 0x0FF6U);\n\thw_atl_thm_lso_tcp_flag_of_last_pkt_set(self, 0x0F7FU);\n\n\t \n\thw_atl_tdm_tx_desc_wr_wb_irq_en_set(self, 1U);\n\n\t \n\taq_hw_write_reg(self, 0x00007040U, 0x00000000U);\n\thw_atl_tdm_tx_dca_en_set(self, 0U);\n\thw_atl_tdm_tx_dca_mode_set(self, 0U);\n\n\thw_atl_tpb_tx_path_scp_ins_en_set(self, 1U);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_init_rx_path(struct aq_hw_s *self)\n{\n\tstruct aq_nic_cfg_s *cfg = self->aq_nic_cfg;\n\tint i;\n\n\t \n\thw_atl_rpb_rpf_rx_traf_class_mode_set(self, 1U);\n\n\t \n\thw_atl_rpb_rx_flow_ctl_mode_set(self, 1U);\n\n\t \n\thw_atl_reg_rx_flr_rss_control1set(self, cfg->is_rss ?\n\t\t\t\t\t  0xB3333333U : 0x00000000U);\n\n\t \n\tfor (i = HW_ATL_A0_MAC_MAX; i--;) {\n\t\thw_atl_rpfl2_uc_flr_en_set(self, (i == 0U) ? 1U : 0U, i);\n\t\thw_atl_rpfl2unicast_flr_act_set(self, 1U, i);\n\t}\n\n\thw_atl_reg_rx_flr_mcst_flr_msk_set(self, 0x00000000U);\n\thw_atl_reg_rx_flr_mcst_flr_set(self, 0x00010FFFU, 0U);\n\n\t \n\thw_atl_rpf_vlan_outer_etht_set(self, 0x88A8U);\n\thw_atl_rpf_vlan_inner_etht_set(self, 0x8100U);\n\thw_atl_rpf_vlan_prom_mode_en_set(self, 1);\n\n\t \n\thw_atl_rdm_rx_desc_wr_wb_irq_en_set(self, 1U);\n\n\t \n\thw_atl_rpfl2broadcast_flr_act_set(self, 1U);\n\thw_atl_rpfl2broadcast_count_threshold_set(self, 0xFFFFU & (~0U / 256U));\n\n\thw_atl_rdm_rx_dca_en_set(self, 0U);\n\thw_atl_rdm_rx_dca_mode_set(self, 0U);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_mac_addr_set(struct aq_hw_s *self, const u8 *mac_addr)\n{\n\tunsigned int h = 0U;\n\tunsigned int l = 0U;\n\tint err = 0;\n\n\tif (!mac_addr) {\n\t\terr = -EINVAL;\n\t\tgoto err_exit;\n\t}\n\n\th = (mac_addr[0] << 8) | (mac_addr[1]);\n\tl = (mac_addr[2] << 24) | (mac_addr[3] << 16) |\n\t    (mac_addr[4] << 8) | mac_addr[5];\n\n\thw_atl_rpfl2_uc_flr_en_set(self, 0U, HW_ATL_A0_MAC);\n\thw_atl_rpfl2unicast_dest_addresslsw_set(self, l, HW_ATL_A0_MAC);\n\thw_atl_rpfl2unicast_dest_addressmsw_set(self, h, HW_ATL_A0_MAC);\n\thw_atl_rpfl2_uc_flr_en_set(self, 1U, HW_ATL_A0_MAC);\n\n\terr = aq_hw_err_from_flags(self);\n\nerr_exit:\n\treturn err;\n}\n\nstatic int hw_atl_a0_hw_init(struct aq_hw_s *self, const u8 *mac_addr)\n{\n\tstatic u32 aq_hw_atl_igcr_table_[4][2] = {\n\t\t[AQ_HW_IRQ_INVALID] = { 0x20000000U, 0x20000000U },\n\t\t[AQ_HW_IRQ_LEGACY]  = { 0x20000080U, 0x20000080U },\n\t\t[AQ_HW_IRQ_MSI]     = { 0x20000021U, 0x20000025U },\n\t\t[AQ_HW_IRQ_MSIX]    = { 0x20000022U, 0x20000026U },\n\t};\n\tstruct aq_nic_cfg_s *aq_nic_cfg = self->aq_nic_cfg;\n\tint err = 0;\n\n\thw_atl_a0_hw_init_tx_path(self);\n\thw_atl_a0_hw_init_rx_path(self);\n\n\thw_atl_a0_hw_mac_addr_set(self, mac_addr);\n\n\tself->aq_fw_ops->set_link_speed(self, aq_nic_cfg->link_speed_msk);\n\tself->aq_fw_ops->set_state(self, MPI_INIT);\n\n\thw_atl_reg_tx_dma_debug_ctl_set(self, 0x800000b8U);\n\thw_atl_reg_tx_dma_debug_ctl_set(self, 0x000000b8U);\n\n\thw_atl_a0_hw_qos_set(self);\n\thw_atl_a0_hw_rss_set(self, &aq_nic_cfg->aq_rss);\n\thw_atl_a0_hw_rss_hash_set(self, &aq_nic_cfg->aq_rss);\n\n\t \n\tself->aq_link_status.mbps = 0;\n\tself->aq_fw_ops->update_stats(self);\n\n\terr = aq_hw_err_from_flags(self);\n\tif (err < 0)\n\t\tgoto err_exit;\n\n\t \n\thw_atl_reg_irq_glb_ctl_set(self,\n\t\t\t\t   aq_hw_atl_igcr_table_[aq_nic_cfg->irq_type]\n\t\t\t\t\t[(aq_nic_cfg->vecs > 1U) ? 1 : 0]);\n\n\thw_atl_itr_irq_auto_masklsw_set(self, aq_nic_cfg->aq_hw_caps->irq_mask);\n\n\t \n\thw_atl_reg_gen_irq_map_set(self,\n\t\t\t\t   ((HW_ATL_A0_ERR_INT << 0x18) | (1U << 0x1F)) |\n\t\t\t\t   ((HW_ATL_A0_ERR_INT << 0x10) | (1U << 0x17)) |\n\t\t\t\t   ((HW_ATL_A0_ERR_INT << 8) | (1U << 0xF)) |\n\t\t\t\t   ((HW_ATL_A0_ERR_INT) | (1U << 0x7)), 0U);\n\n\thw_atl_a0_hw_offload_set(self, aq_nic_cfg);\n\nerr_exit:\n\treturn err;\n}\n\nstatic int hw_atl_a0_hw_ring_tx_start(struct aq_hw_s *self,\n\t\t\t\t      struct aq_ring_s *ring)\n{\n\thw_atl_tdm_tx_desc_en_set(self, 1, ring->idx);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_ring_rx_start(struct aq_hw_s *self,\n\t\t\t\t      struct aq_ring_s *ring)\n{\n\thw_atl_rdm_rx_desc_en_set(self, 1, ring->idx);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_start(struct aq_hw_s *self)\n{\n\thw_atl_tpb_tx_buff_en_set(self, 1);\n\thw_atl_rpb_rx_buff_en_set(self, 1);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_tx_ring_tail_update(struct aq_hw_s *self,\n\t\t\t\t\t    struct aq_ring_s *ring)\n{\n\thw_atl_reg_tx_dma_desc_tail_ptr_set(self, ring->sw_tail, ring->idx);\n\n\treturn 0;\n}\n\nstatic int hw_atl_a0_hw_ring_tx_xmit(struct aq_hw_s *self,\n\t\t\t\t     struct aq_ring_s *ring,\n\t\t\t\t     unsigned int frags)\n{\n\tstruct aq_ring_buff_s *buff = NULL;\n\tstruct hw_atl_txd_s *txd = NULL;\n\tunsigned int buff_pa_len = 0U;\n\tunsigned int frag_count = 0U;\n\tunsigned int pkt_len = 0U;\n\tbool is_gso = false;\n\n\tbuff = &ring->buff_ring[ring->sw_tail];\n\tpkt_len = (buff->is_eop && buff->is_sop) ? buff->len : buff->len_pkt;\n\n\tfor (frag_count = 0; frag_count < frags; frag_count++) {\n\t\ttxd = (struct hw_atl_txd_s *)&ring->dx_ring[ring->sw_tail *\n\t\t\t\t\t\tHW_ATL_A0_TXD_SIZE];\n\t\ttxd->ctl = 0;\n\t\ttxd->ctl2 = 0;\n\t\ttxd->buf_addr = 0;\n\n\t\tbuff = &ring->buff_ring[ring->sw_tail];\n\n\t\tif (buff->is_gso_tcp) {\n\t\t\ttxd->ctl |= (buff->len_l3 << 31) |\n\t\t\t\t(buff->len_l2 << 24) |\n\t\t\t\tHW_ATL_A0_TXD_CTL_CMD_TCP |\n\t\t\t\tHW_ATL_A0_TXD_CTL_DESC_TYPE_TXC;\n\t\t\ttxd->ctl2 |= (buff->mss << 16) |\n\t\t\t\t(buff->len_l4 << 8) |\n\t\t\t\t(buff->len_l3 >> 1);\n\n\t\t\tpkt_len -= (buff->len_l4 +\n\t\t\t\t    buff->len_l3 +\n\t\t\t\t    buff->len_l2);\n\t\t\tis_gso = true;\n\n\t\t\tif (buff->is_ipv6)\n\t\t\t\ttxd->ctl |= HW_ATL_A0_TXD_CTL_CMD_IPV6;\n\t\t} else {\n\t\t\tbuff_pa_len = buff->len;\n\n\t\t\ttxd->buf_addr = buff->pa;\n\t\t\ttxd->ctl |= (HW_ATL_A0_TXD_CTL_BLEN &\n\t\t\t\t\t\t((u32)buff_pa_len << 4));\n\t\t\ttxd->ctl |= HW_ATL_A0_TXD_CTL_DESC_TYPE_TXD;\n\t\t\t \n\t\t\ttxd->ctl2 |= HW_ATL_A0_TXD_CTL2_LEN & (pkt_len << 14);\n\n\t\t\tif (is_gso) {\n\t\t\t\ttxd->ctl |= HW_ATL_A0_TXD_CTL_CMD_LSO;\n\t\t\t\ttxd->ctl2 |= HW_ATL_A0_TXD_CTL2_CTX_EN;\n\t\t\t}\n\n\t\t\t \n\t\t\tif (buff->is_ip_cso)\n\t\t\t\ttxd->ctl |= HW_ATL_A0_TXD_CTL_CMD_IPCSO;\n\n\t\t\tif (buff->is_udp_cso || buff->is_tcp_cso)\n\t\t\t\ttxd->ctl |= HW_ATL_A0_TXD_CTL_CMD_TUCSO;\n\n\t\t\tif (unlikely(buff->is_eop)) {\n\t\t\t\ttxd->ctl |= HW_ATL_A0_TXD_CTL_EOP;\n\t\t\t\ttxd->ctl |= HW_ATL_A0_TXD_CTL_CMD_WB;\n\t\t\t\tis_gso = false;\n\t\t\t}\n\t\t}\n\n\t\tring->sw_tail = aq_ring_next_dx(ring, ring->sw_tail);\n\t}\n\n\thw_atl_a0_hw_tx_ring_tail_update(self, ring);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_ring_rx_init(struct aq_hw_s *self,\n\t\t\t\t     struct aq_ring_s *aq_ring,\n\t\t\t\t     struct aq_ring_param_s *aq_ring_param)\n{\n\tu32 dma_desc_addr_msw = (u32)(((u64)aq_ring->dx_ring_pa) >> 32);\n\tu32 dma_desc_addr_lsw = (u32)aq_ring->dx_ring_pa;\n\n\thw_atl_rdm_rx_desc_en_set(self, false, aq_ring->idx);\n\n\thw_atl_rdm_rx_desc_head_splitting_set(self, 0U, aq_ring->idx);\n\n\thw_atl_reg_rx_dma_desc_base_addresslswset(self, dma_desc_addr_lsw,\n\t\t\t\t\t\t  aq_ring->idx);\n\n\thw_atl_reg_rx_dma_desc_base_addressmswset(self,\n\t\t\t\t\t\t  dma_desc_addr_msw,\n\t\t\t\t\t\t  aq_ring->idx);\n\n\thw_atl_rdm_rx_desc_len_set(self, aq_ring->size / 8U, aq_ring->idx);\n\n\thw_atl_rdm_rx_desc_data_buff_size_set(self,\n\t\t\t\t\t      aq_ring->frame_max / 1024U,\n\t\t\t\t\t      aq_ring->idx);\n\n\thw_atl_rdm_rx_desc_head_buff_size_set(self, 0U, aq_ring->idx);\n\thw_atl_rdm_rx_desc_head_splitting_set(self, 0U, aq_ring->idx);\n\thw_atl_rpo_rx_desc_vlan_stripping_set(self, 0U, aq_ring->idx);\n\n\t \n\n\t \n\thw_atl_itr_irq_map_rx_set(self, aq_ring_param->vec_idx, aq_ring->idx);\n\thw_atl_itr_irq_map_en_rx_set(self, true, aq_ring->idx);\n\n\thw_atl_rdm_cpu_id_set(self, aq_ring_param->cpu, aq_ring->idx);\n\thw_atl_rdm_rx_desc_dca_en_set(self, 0U, aq_ring->idx);\n\thw_atl_rdm_rx_head_dca_en_set(self, 0U, aq_ring->idx);\n\thw_atl_rdm_rx_pld_dca_en_set(self, 0U, aq_ring->idx);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_ring_tx_init(struct aq_hw_s *self,\n\t\t\t\t     struct aq_ring_s *aq_ring,\n\t\t\t\t     struct aq_ring_param_s *aq_ring_param)\n{\n\tu32 dma_desc_msw_addr = (u32)(((u64)aq_ring->dx_ring_pa) >> 32);\n\tu32 dma_desc_lsw_addr = (u32)aq_ring->dx_ring_pa;\n\n\thw_atl_reg_tx_dma_desc_base_addresslswset(self, dma_desc_lsw_addr,\n\t\t\t\t\t\t  aq_ring->idx);\n\n\thw_atl_reg_tx_dma_desc_base_addressmswset(self, dma_desc_msw_addr,\n\t\t\t\t\t\t  aq_ring->idx);\n\n\thw_atl_tdm_tx_desc_len_set(self, aq_ring->size / 8U, aq_ring->idx);\n\n\thw_atl_a0_hw_tx_ring_tail_update(self, aq_ring);\n\n\t \n\thw_atl_tdm_tx_desc_wr_wb_threshold_set(self, 0U, aq_ring->idx);\n\n\t \n\thw_atl_itr_irq_map_tx_set(self, aq_ring_param->vec_idx, aq_ring->idx);\n\thw_atl_itr_irq_map_en_tx_set(self, true, aq_ring->idx);\n\n\thw_atl_tdm_cpu_id_set(self, aq_ring_param->cpu, aq_ring->idx);\n\thw_atl_tdm_tx_desc_dca_en_set(self, 0U, aq_ring->idx);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_ring_rx_fill(struct aq_hw_s *self,\n\t\t\t\t     struct aq_ring_s *ring,\n\t\t\t\t     unsigned int sw_tail_old)\n{\n\tfor (; sw_tail_old != ring->sw_tail;\n\t\tsw_tail_old = aq_ring_next_dx(ring, sw_tail_old)) {\n\t\tstruct hw_atl_rxd_s *rxd =\n\t\t\t(struct hw_atl_rxd_s *)&ring->dx_ring[sw_tail_old *\n\t\t\t\t\t\t\tHW_ATL_A0_RXD_SIZE];\n\n\t\tstruct aq_ring_buff_s *buff = &ring->buff_ring[sw_tail_old];\n\n\t\trxd->buf_addr = buff->pa;\n\t\trxd->hdr_addr = 0U;\n\t}\n\n\thw_atl_reg_rx_dma_desc_tail_ptr_set(self, sw_tail_old, ring->idx);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_ring_tx_head_update(struct aq_hw_s *self,\n\t\t\t\t\t    struct aq_ring_s *ring)\n{\n\tunsigned int hw_head = hw_atl_tdm_tx_desc_head_ptr_get(self, ring->idx);\n\tint err = 0;\n\n\tif (aq_utils_obj_test(&self->flags, AQ_HW_FLAG_ERR_UNPLUG)) {\n\t\terr = -ENXIO;\n\t\tgoto err_exit;\n\t}\n\tring->hw_head = hw_head;\n\terr = aq_hw_err_from_flags(self);\n\nerr_exit:\n\treturn err;\n}\n\nstatic int hw_atl_a0_hw_ring_rx_receive(struct aq_hw_s *self,\n\t\t\t\t\tstruct aq_ring_s *ring)\n{\n\tfor (; ring->hw_head != ring->sw_tail;\n\t\tring->hw_head = aq_ring_next_dx(ring, ring->hw_head)) {\n\t\tstruct aq_ring_buff_s *buff = NULL;\n\t\tstruct hw_atl_rxd_wb_s *rxd_wb = (struct hw_atl_rxd_wb_s *)\n\t\t\t&ring->dx_ring[ring->hw_head * HW_ATL_A0_RXD_SIZE];\n\n\t\tunsigned int is_err = 1U;\n\t\tunsigned int is_rx_check_sum_enabled = 0U;\n\t\tunsigned int pkt_type = 0U;\n\n\t\tif (!(rxd_wb->status & 0x5U)) {  \n\t\t\tif ((1U << 4) &\n\t\t\thw_atl_reg_rx_dma_desc_status_get(self, ring->idx)) {\n\t\t\t\thw_atl_rdm_rx_desc_en_set(self, false, ring->idx);\n\t\t\t\thw_atl_rdm_rx_desc_res_set(self, true, ring->idx);\n\t\t\t\thw_atl_rdm_rx_desc_res_set(self, false, ring->idx);\n\t\t\t\thw_atl_rdm_rx_desc_en_set(self, true, ring->idx);\n\t\t\t}\n\n\t\t\tif (ring->hw_head ||\n\t\t\t    (hw_atl_rdm_rx_desc_head_ptr_get(self,\n\t\t\t\t\t\t\t     ring->idx) < 2U)) {\n\t\t\t\tbreak;\n\t\t\t} else if (!(rxd_wb->status & 0x1U)) {\n\t\t\t\tstruct hw_atl_rxd_wb_s *rxd_wb1 =\n\t\t\t\t\t(struct hw_atl_rxd_wb_s *)\n\t\t\t\t\t(&ring->dx_ring[(1U) *\n\t\t\t\t\t\tHW_ATL_A0_RXD_SIZE]);\n\n\t\t\t\tif ((rxd_wb1->status & 0x1U)) {\n\t\t\t\t\trxd_wb->pkt_len = 1514U;\n\t\t\t\t\trxd_wb->status = 3U;\n\t\t\t\t} else {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tbuff = &ring->buff_ring[ring->hw_head];\n\n\t\tif (0x3U != (rxd_wb->status & 0x3U))\n\t\t\trxd_wb->status |= 4;\n\n\t\tis_err = (0x0000001CU & rxd_wb->status);\n\t\tis_rx_check_sum_enabled = (rxd_wb->type) & (0x3U << 19);\n\t\tpkt_type = 0xFFU & (rxd_wb->type >> 4);\n\n\t\tif (is_rx_check_sum_enabled) {\n\t\t\tif (0x0U == (pkt_type & 0x3U))\n\t\t\t\tbuff->is_ip_cso = (is_err & 0x08U) ? 0 : 1;\n\n\t\t\tif (0x4U == (pkt_type & 0x1CU))\n\t\t\t\tbuff->is_udp_cso = (is_err & 0x10U) ? 0 : 1;\n\t\t\telse if (0x0U == (pkt_type & 0x1CU))\n\t\t\t\tbuff->is_tcp_cso = (is_err & 0x10U) ? 0 : 1;\n\n\t\t\t \n\t\t\tif (rxd_wb->pkt_len <= 60) {\n\t\t\t\tbuff->is_ip_cso = 0U;\n\t\t\t\tbuff->is_cso_err = 0U;\n\t\t\t}\n\t\t}\n\n\t\tis_err &= ~0x18U;\n\t\tis_err &= ~0x04U;\n\n\t\tif (is_err || rxd_wb->type & 0x1000U) {\n\t\t\t \n\t\t\tbuff->is_error = 1U;\n\t\t} else {\n\t\t\tif (self->aq_nic_cfg->is_rss) {\n\t\t\t\t \n\t\t\t\tu16 rss_type = rxd_wb->type & 0xFU;\n\n\t\t\t\tif (rss_type && rss_type < 0x8U) {\n\t\t\t\t\tbuff->is_hash_l4 = (rss_type == 0x4 ||\n\t\t\t\t\t\t\trss_type == 0x5);\n\t\t\t\t\tbuff->rss_hash = rxd_wb->rss_hash;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (HW_ATL_A0_RXD_WB_STAT2_EOP & rxd_wb->status) {\n\t\t\t\tbuff->len = rxd_wb->pkt_len %\n\t\t\t\t\t    ring->frame_max;\n\t\t\t\tbuff->len = buff->len ?\n\t\t\t\t\tbuff->len : ring->frame_max;\n\t\t\t\tbuff->next = 0U;\n\t\t\t\tbuff->is_eop = 1U;\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tbuff->next = aq_ring_next_dx(ring,\n\t\t\t\t\t\t\t     ring->hw_head);\n\t\t\t\t++ring->stats.rx.jumbo_packets;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_irq_enable(struct aq_hw_s *self, u64 mask)\n{\n\thw_atl_itr_irq_msk_setlsw_set(self, LODWORD(mask) |\n\t\t\t       (1U << HW_ATL_A0_ERR_INT));\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_irq_disable(struct aq_hw_s *self, u64 mask)\n{\n\thw_atl_itr_irq_msk_clearlsw_set(self, LODWORD(mask));\n\thw_atl_itr_irq_status_clearlsw_set(self, LODWORD(mask));\n\n\tif ((1U << 16) & hw_atl_reg_gen_irq_status_get(self))\n\t\tatomic_inc(&self->dpc);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_irq_read(struct aq_hw_s *self, u64 *mask)\n{\n\t*mask = hw_atl_itr_irq_statuslsw_get(self);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\n#define IS_FILTER_ENABLED(_F_) ((packet_filter & (_F_)) ? 1U : 0U)\n\nstatic int hw_atl_a0_hw_packet_filter_set(struct aq_hw_s *self,\n\t\t\t\t\t  unsigned int packet_filter)\n{\n\tstruct aq_nic_cfg_s *cfg = self->aq_nic_cfg;\n\tunsigned int i = 0U;\n\n\thw_atl_rpfl2promiscuous_mode_en_set(self,\n\t\t\t\t\t    IS_FILTER_ENABLED(IFF_PROMISC));\n\thw_atl_rpfl2multicast_flr_en_set(self,\n\t\t\t\t\t IS_FILTER_ENABLED(IFF_MULTICAST), 0);\n\thw_atl_rpfl2broadcast_en_set(self, IS_FILTER_ENABLED(IFF_BROADCAST));\n\n\tcfg->is_mc_list_enabled = IS_FILTER_ENABLED(IFF_MULTICAST);\n\n\tfor (i = HW_ATL_A0_MAC_MIN; i < HW_ATL_A0_MAC_MAX; ++i)\n\t\thw_atl_rpfl2_uc_flr_en_set(self,\n\t\t\t\t\t   (cfg->is_mc_list_enabled &&\n\t\t\t\t\t    (i <= cfg->mc_list_count)) ? 1U : 0U,\n\t\t\t\t\t   i);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\n#undef IS_FILTER_ENABLED\n\nstatic int hw_atl_a0_hw_multicast_list_set(struct aq_hw_s *self,\n\t\t\t\t\t   u8 ar_mac\n\t\t\t\t\t   [AQ_HW_MULTICAST_ADDRESS_MAX]\n\t\t\t\t\t   [ETH_ALEN],\n\t\t\t\t\t   u32 count)\n{\n\tstruct aq_nic_cfg_s *cfg = self->aq_nic_cfg;\n\tint err = 0;\n\n\tif (count > (HW_ATL_A0_MAC_MAX - HW_ATL_A0_MAC_MIN)) {\n\t\terr = -EBADRQC;\n\t\tgoto err_exit;\n\t}\n\tfor (cfg->mc_list_count = 0U; cfg->mc_list_count < count; ++cfg->mc_list_count) {\n\t\tu32 i = cfg->mc_list_count;\n\t\tu32 h = (ar_mac[i][0] << 8) | (ar_mac[i][1]);\n\t\tu32 l = (ar_mac[i][2] << 24) | (ar_mac[i][3] << 16) |\n\t\t\t(ar_mac[i][4] << 8) | ar_mac[i][5];\n\n\t\thw_atl_rpfl2_uc_flr_en_set(self, 0U, HW_ATL_A0_MAC_MIN + i);\n\n\t\thw_atl_rpfl2unicast_dest_addresslsw_set(self,\n\t\t\t\t\t\t\tl,\n\t\t\t\t\t\t\tHW_ATL_A0_MAC_MIN + i);\n\n\t\thw_atl_rpfl2unicast_dest_addressmsw_set(self,\n\t\t\t\t\t\t\th,\n\t\t\t\t\t\t\tHW_ATL_A0_MAC_MIN + i);\n\n\t\thw_atl_rpfl2_uc_flr_en_set(self,\n\t\t\t\t\t   (cfg->is_mc_list_enabled),\n\t\t\t\t\t   HW_ATL_A0_MAC_MIN + i);\n\t}\n\n\terr = aq_hw_err_from_flags(self);\n\nerr_exit:\n\treturn err;\n}\n\nstatic int hw_atl_a0_hw_interrupt_moderation_set(struct aq_hw_s *self)\n{\n\tunsigned int i = 0U;\n\tu32 itr_rx;\n\n\tif (self->aq_nic_cfg->itr) {\n\t\tif (self->aq_nic_cfg->itr != AQ_CFG_INTERRUPT_MODERATION_AUTO) {\n\t\t\tu32 itr_ = (self->aq_nic_cfg->itr >> 1);\n\n\t\t\titr_ = min(AQ_CFG_IRQ_MASK, itr_);\n\n\t\t\titr_rx = 0x80000000U | (itr_ << 0x10);\n\t\t} else  {\n\t\t\tu32 n = 0xFFFFU & aq_hw_read_reg(self, 0x00002A00U);\n\n\t\t\tif (n < self->aq_link_status.mbps) {\n\t\t\t\titr_rx = 0U;\n\t\t\t} else {\n\t\t\t\tstatic unsigned int hw_timers_tbl_[] = {\n\t\t\t\t\t0x01CU,  \n\t\t\t\t\t0x039U,  \n\t\t\t\t\t0x039U,  \n\t\t\t\t\t0x073U,  \n\t\t\t\t\t0x120U,  \n\t\t\t\t\t0x1FFU,  \n\t\t\t\t};\n\n\t\t\t\tunsigned int speed_index =\n\t\t\t\t\thw_atl_utils_mbps_2_speed_index(\n\t\t\t\t\t\tself->aq_link_status.mbps);\n\n\t\t\t\titr_rx = 0x80000000U |\n\t\t\t\t\t(hw_timers_tbl_[speed_index] << 0x10U);\n\t\t\t}\n\n\t\t\taq_hw_write_reg(self, 0x00002A00U, 0x40000000U);\n\t\t\taq_hw_write_reg(self, 0x00002A00U, 0x8D000000U);\n\t\t}\n\t} else {\n\t\titr_rx = 0U;\n\t}\n\n\tfor (i = HW_ATL_A0_RINGS_MAX; i--;)\n\t\thw_atl_reg_irq_thr_set(self, itr_rx, i);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_stop(struct aq_hw_s *self)\n{\n\thw_atl_a0_hw_irq_disable(self, HW_ATL_A0_INT_MASK);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_ring_tx_stop(struct aq_hw_s *self,\n\t\t\t\t     struct aq_ring_s *ring)\n{\n\thw_atl_tdm_tx_desc_en_set(self, 0U, ring->idx);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_ring_rx_stop(struct aq_hw_s *self,\n\t\t\t\t     struct aq_ring_s *ring)\n{\n\thw_atl_rdm_rx_desc_en_set(self, 0U, ring->idx);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_fl3l4_clear(struct aq_hw_s *self,\n\t\t\t\t    struct aq_rx_filter_l3l4 *data)\n{\n\tu8 location = data->location;\n\n\tif (!data->is_ipv6) {\n\t\thw_atl_rpfl3l4_cmd_clear(self, location);\n\t\thw_atl_rpf_l4_spd_set(self, 0U, location);\n\t\thw_atl_rpf_l4_dpd_set(self, 0U, location);\n\t\thw_atl_rpfl3l4_ipv4_src_addr_clear(self, location);\n\t\thw_atl_rpfl3l4_ipv4_dest_addr_clear(self, location);\n\t} else {\n\t\tint i;\n\n\t\tfor (i = 0; i < HW_ATL_RX_CNT_REG_ADDR_IPV6; ++i) {\n\t\t\thw_atl_rpfl3l4_cmd_clear(self, location + i);\n\t\t\thw_atl_rpf_l4_spd_set(self, 0U, location + i);\n\t\t\thw_atl_rpf_l4_dpd_set(self, 0U, location + i);\n\t\t}\n\t\thw_atl_rpfl3l4_ipv6_src_addr_clear(self, location);\n\t\thw_atl_rpfl3l4_ipv6_dest_addr_clear(self, location);\n\t}\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl_a0_hw_fl3l4_set(struct aq_hw_s *self,\n\t\t\t\t  struct aq_rx_filter_l3l4 *data)\n{\n\tu8 location = data->location;\n\n\thw_atl_a0_hw_fl3l4_clear(self, data);\n\n\tif (data->cmd) {\n\t\tif (!data->is_ipv6) {\n\t\t\thw_atl_rpfl3l4_ipv4_dest_addr_set(self,\n\t\t\t\t\t\t\t  location,\n\t\t\t\t\t\t\t  data->ip_dst[0]);\n\t\t\thw_atl_rpfl3l4_ipv4_src_addr_set(self,\n\t\t\t\t\t\t\t location,\n\t\t\t\t\t\t\t data->ip_src[0]);\n\t\t} else {\n\t\t\thw_atl_rpfl3l4_ipv6_dest_addr_set(self,\n\t\t\t\t\t\t\t  location,\n\t\t\t\t\t\t\t  data->ip_dst);\n\t\t\thw_atl_rpfl3l4_ipv6_src_addr_set(self,\n\t\t\t\t\t\t\t location,\n\t\t\t\t\t\t\t data->ip_src);\n\t\t}\n\t}\n\thw_atl_rpf_l4_dpd_set(self, data->p_dst, location);\n\thw_atl_rpf_l4_spd_set(self, data->p_src, location);\n\thw_atl_rpfl3l4_cmd_set(self, location, data->cmd);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nconst struct aq_hw_ops hw_atl_ops_a0 = {\n\t.hw_soft_reset        = hw_atl_utils_soft_reset,\n\t.hw_prepare           = hw_atl_utils_initfw,\n\t.hw_set_mac_address   = hw_atl_a0_hw_mac_addr_set,\n\t.hw_init              = hw_atl_a0_hw_init,\n\t.hw_reset             = hw_atl_a0_hw_reset,\n\t.hw_start             = hw_atl_a0_hw_start,\n\t.hw_ring_tx_start     = hw_atl_a0_hw_ring_tx_start,\n\t.hw_ring_tx_stop      = hw_atl_a0_hw_ring_tx_stop,\n\t.hw_ring_rx_start     = hw_atl_a0_hw_ring_rx_start,\n\t.hw_ring_rx_stop      = hw_atl_a0_hw_ring_rx_stop,\n\t.hw_stop              = hw_atl_a0_hw_stop,\n\n\t.hw_ring_tx_xmit         = hw_atl_a0_hw_ring_tx_xmit,\n\t.hw_ring_tx_head_update  = hw_atl_a0_hw_ring_tx_head_update,\n\n\t.hw_ring_rx_receive      = hw_atl_a0_hw_ring_rx_receive,\n\t.hw_ring_rx_fill         = hw_atl_a0_hw_ring_rx_fill,\n\n\t.hw_irq_enable           = hw_atl_a0_hw_irq_enable,\n\t.hw_irq_disable          = hw_atl_a0_hw_irq_disable,\n\t.hw_irq_read             = hw_atl_a0_hw_irq_read,\n\n\t.hw_ring_rx_init             = hw_atl_a0_hw_ring_rx_init,\n\t.hw_ring_tx_init             = hw_atl_a0_hw_ring_tx_init,\n\t.hw_packet_filter_set        = hw_atl_a0_hw_packet_filter_set,\n\t.hw_filter_l3l4_set          = hw_atl_a0_hw_fl3l4_set,\n\t.hw_multicast_list_set       = hw_atl_a0_hw_multicast_list_set,\n\t.hw_interrupt_moderation_set = hw_atl_a0_hw_interrupt_moderation_set,\n\t.hw_rss_set                  = hw_atl_a0_hw_rss_set,\n\t.hw_rss_hash_set             = hw_atl_a0_hw_rss_hash_set,\n\t.hw_get_regs                 = hw_atl_utils_hw_get_regs,\n\t.hw_get_hw_stats             = hw_atl_utils_get_hw_stats,\n\t.hw_get_fw_version           = hw_atl_utils_get_fw_version,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}