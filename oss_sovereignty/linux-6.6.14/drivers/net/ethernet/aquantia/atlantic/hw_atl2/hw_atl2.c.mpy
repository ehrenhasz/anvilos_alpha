{
  "module_name": "hw_atl2.c",
  "hash_id": "6119dd616436c61f7dcb3e3c8ab935c3aabad56b6a813e95ebc8a8c49e3362c9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/aquantia/atlantic/hw_atl2/hw_atl2.c",
  "human_readable_source": "\n \n\n#include \"aq_hw.h\"\n#include \"aq_hw_utils.h\"\n#include \"aq_ring.h\"\n#include \"aq_nic.h\"\n#include \"hw_atl/hw_atl_b0.h\"\n#include \"hw_atl/hw_atl_utils.h\"\n#include \"hw_atl/hw_atl_llh.h\"\n#include \"hw_atl/hw_atl_llh_internal.h\"\n#include \"hw_atl2_utils.h\"\n#include \"hw_atl2_llh.h\"\n#include \"hw_atl2_internal.h\"\n#include \"hw_atl2_llh_internal.h\"\n\nstatic int hw_atl2_act_rslvr_table_set(struct aq_hw_s *self, u8 location,\n\t\t\t\t       u32 tag, u32 mask, u32 action);\n\n#define DEFAULT_BOARD_BASIC_CAPABILITIES \\\n\t.is_64_dma = true,\t\t  \\\n\t.op64bit = true,\t\t  \\\n\t.msix_irqs = 8U,\t\t  \\\n\t.irq_mask = ~0U,\t\t  \\\n\t.vecs = HW_ATL2_RSS_MAX,\t  \\\n\t.tcs_max = HW_ATL2_TC_MAX,\t  \\\n\t.rxd_alignment = 1U,\t\t  \\\n\t.rxd_size = HW_ATL2_RXD_SIZE,   \\\n\t.rxds_max = HW_ATL2_MAX_RXD,    \\\n\t.rxds_min = HW_ATL2_MIN_RXD,    \\\n\t.txd_alignment = 1U,\t\t  \\\n\t.txd_size = HW_ATL2_TXD_SIZE,   \\\n\t.txds_max = HW_ATL2_MAX_TXD,    \\\n\t.txds_min = HW_ATL2_MIN_TXD,    \\\n\t.txhwb_alignment = 4096U,\t  \\\n\t.tx_rings = HW_ATL2_TX_RINGS,   \\\n\t.rx_rings = HW_ATL2_RX_RINGS,   \\\n\t.hw_features = NETIF_F_HW_CSUM |  \\\n\t\t\tNETIF_F_RXCSUM |  \\\n\t\t\tNETIF_F_RXHASH |  \\\n\t\t\tNETIF_F_SG |      \\\n\t\t\tNETIF_F_TSO |     \\\n\t\t\tNETIF_F_TSO6 |    \\\n\t\t\tNETIF_F_LRO |     \\\n\t\t\tNETIF_F_NTUPLE |  \\\n\t\t\tNETIF_F_HW_VLAN_CTAG_FILTER | \\\n\t\t\tNETIF_F_HW_VLAN_CTAG_RX |     \\\n\t\t\tNETIF_F_HW_VLAN_CTAG_TX |     \\\n\t\t\tNETIF_F_GSO_UDP_L4      |     \\\n\t\t\tNETIF_F_GSO_PARTIAL     |     \\\n\t\t\tNETIF_F_HW_TC,                \\\n\t.hw_priv_flags = IFF_UNICAST_FLT, \\\n\t.flow_control = true,\t\t  \\\n\t.mtu = HW_ATL2_MTU_JUMBO,\t  \\\n\t.mac_regs_count = 72,\t\t  \\\n\t.hw_alive_check_addr = 0x10U,     \\\n\t.priv_data_len = sizeof(struct hw_atl2_priv)\n\nconst struct aq_hw_caps_s hw_atl2_caps_aqc113 = {\n\tDEFAULT_BOARD_BASIC_CAPABILITIES,\n\t.media_type = AQ_HW_MEDIA_TYPE_TP,\n\t.link_speed_msk = AQ_NIC_RATE_10G |\n\t\t\t  AQ_NIC_RATE_5G  |\n\t\t\t  AQ_NIC_RATE_2G5 |\n\t\t\t  AQ_NIC_RATE_1G  |\n\t\t\t  AQ_NIC_RATE_100M      |\n\t\t\t  AQ_NIC_RATE_10M,\n};\n\nconst struct aq_hw_caps_s hw_atl2_caps_aqc115c = {\n\tDEFAULT_BOARD_BASIC_CAPABILITIES,\n\t.media_type = AQ_HW_MEDIA_TYPE_TP,\n\t.link_speed_msk = AQ_NIC_RATE_2G5 |\n\t\t\t  AQ_NIC_RATE_1G  |\n\t\t\t  AQ_NIC_RATE_100M      |\n\t\t\t  AQ_NIC_RATE_10M,\n};\n\nconst struct aq_hw_caps_s hw_atl2_caps_aqc116c = {\n\tDEFAULT_BOARD_BASIC_CAPABILITIES,\n\t.media_type = AQ_HW_MEDIA_TYPE_TP,\n\t.link_speed_msk = AQ_NIC_RATE_1G  |\n\t\t\t  AQ_NIC_RATE_100M      |\n\t\t\t  AQ_NIC_RATE_10M,\n};\n\nstatic u32 hw_atl2_sem_act_rslvr_get(struct aq_hw_s *self)\n{\n\treturn hw_atl_reg_glb_cpu_sem_get(self, HW_ATL2_FW_SM_ACT_RSLVR);\n}\n\nstatic int hw_atl2_hw_reset(struct aq_hw_s *self)\n{\n\tstruct hw_atl2_priv *priv = self->priv;\n\tint err;\n\n\terr = hw_atl2_utils_soft_reset(self);\n\tif (err)\n\t\treturn err;\n\n\tmemset(priv, 0, sizeof(*priv));\n\n\tself->aq_fw_ops->set_state(self, MPI_RESET);\n\n\terr = aq_hw_err_from_flags(self);\n\n\treturn err;\n}\n\nstatic int hw_atl2_hw_queue_to_tc_map_set(struct aq_hw_s *self)\n{\n\tstruct aq_nic_cfg_s *cfg = self->aq_nic_cfg;\n\tunsigned int tcs, q_per_tc;\n\tunsigned int tc, q;\n\tu32 rx_map = 0;\n\tu32 tx_map = 0;\n\n\thw_atl2_tpb_tx_tc_q_rand_map_en_set(self, 1U);\n\n\tswitch (cfg->tc_mode) {\n\tcase AQ_TC_MODE_8TCS:\n\t\ttcs = 8;\n\t\tq_per_tc = 4;\n\t\tbreak;\n\tcase AQ_TC_MODE_4TCS:\n\t\ttcs = 4;\n\t\tq_per_tc = 8;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tfor (tc = 0; tc != tcs; tc++) {\n\t\tunsigned int tc_q_offset = tc * q_per_tc;\n\n\t\tfor (q = tc_q_offset; q != tc_q_offset + q_per_tc; q++) {\n\t\t\trx_map |= tc << HW_ATL2_RX_Q_TC_MAP_SHIFT(q);\n\t\t\tif (HW_ATL2_RX_Q_TC_MAP_ADR(q) !=\n\t\t\t    HW_ATL2_RX_Q_TC_MAP_ADR(q + 1)) {\n\t\t\t\taq_hw_write_reg(self,\n\t\t\t\t\t\tHW_ATL2_RX_Q_TC_MAP_ADR(q),\n\t\t\t\t\t\trx_map);\n\t\t\t\trx_map = 0;\n\t\t\t}\n\n\t\t\ttx_map |= tc << HW_ATL2_TX_Q_TC_MAP_SHIFT(q);\n\t\t\tif (HW_ATL2_TX_Q_TC_MAP_ADR(q) !=\n\t\t\t    HW_ATL2_TX_Q_TC_MAP_ADR(q + 1)) {\n\t\t\t\taq_hw_write_reg(self,\n\t\t\t\t\t\tHW_ATL2_TX_Q_TC_MAP_ADR(q),\n\t\t\t\t\t\ttx_map);\n\t\t\t\ttx_map = 0;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl2_hw_qos_set(struct aq_hw_s *self)\n{\n\tstruct aq_nic_cfg_s *cfg = self->aq_nic_cfg;\n\tu32 tx_buff_size = HW_ATL2_TXBUF_MAX;\n\tu32 rx_buff_size = HW_ATL2_RXBUF_MAX;\n\tunsigned int prio = 0U;\n\tu32 tc = 0U;\n\n\t \n\thw_atl_tps_tx_pkt_shed_desc_rate_curr_time_res_set(self, 0x0U);\n\thw_atl_tps_tx_pkt_shed_desc_rate_lim_set(self, 0xA);\n\n\t \n\thw_atl_tps_tx_pkt_shed_desc_vm_arb_mode_set(self, 0U);\n\n\ttx_buff_size /= cfg->tcs;\n\trx_buff_size /= cfg->tcs;\n\tfor (tc = 0; tc < cfg->tcs; tc++) {\n\t\tu32 threshold = 0U;\n\n\t\t \n\t\thw_atl_tpb_tx_pkt_buff_size_per_tc_set(self, tx_buff_size, tc);\n\n\t\tthreshold = (tx_buff_size * (1024 / 32U) * 66U) / 100U;\n\t\thw_atl_tpb_tx_buff_hi_threshold_per_tc_set(self, threshold, tc);\n\n\t\tthreshold = (tx_buff_size * (1024 / 32U) * 50U) / 100U;\n\t\thw_atl_tpb_tx_buff_lo_threshold_per_tc_set(self, threshold, tc);\n\n\t\t \n\t\thw_atl_rpb_rx_pkt_buff_size_per_tc_set(self, rx_buff_size, tc);\n\n\t\tthreshold = (rx_buff_size * (1024U / 32U) * 66U) / 100U;\n\t\thw_atl_rpb_rx_buff_hi_threshold_per_tc_set(self, threshold, tc);\n\n\t\tthreshold = (rx_buff_size * (1024U / 32U) * 50U) / 100U;\n\t\thw_atl_rpb_rx_buff_lo_threshold_per_tc_set(self, threshold, tc);\n\n\t\thw_atl_b0_set_fc(self, self->aq_nic_cfg->fc.req, tc);\n\t}\n\n\t \n\tfor (prio = 0; prio < 8; ++prio)\n\t\thw_atl_rpf_rpb_user_priority_tc_map_set(self, prio,\n\t\t\t\t\t\t\tcfg->prio_tc_map[prio]);\n\n\t \n\thw_atl2_hw_queue_to_tc_map_set(self);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl2_hw_rss_set(struct aq_hw_s *self,\n\t\t\t      struct aq_rss_parameters *rss_params)\n{\n\tu8 *indirection_table = rss_params->indirection_table;\n\tconst u32 num_tcs = aq_hw_num_tcs(self);\n\tu32 rpf_redir2_enable;\n\tint tc;\n\tint i;\n\n\trpf_redir2_enable = num_tcs > 4 ? 1 : 0;\n\n\thw_atl2_rpf_redirection_table2_select_set(self, rpf_redir2_enable);\n\n\tfor (i = HW_ATL2_RSS_REDIRECTION_MAX; i--;) {\n\t\tfor (tc = 0; tc != num_tcs; tc++) {\n\t\t\thw_atl2_new_rpf_rss_redir_set(self, tc, i,\n\t\t\t\t\t\t      tc *\n\t\t\t\t\t\t      aq_hw_q_per_tc(self) +\n\t\t\t\t\t\t      indirection_table[i]);\n\t\t}\n\t}\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl2_hw_init_tx_tc_rate_limit(struct aq_hw_s *self)\n{\n\tstatic const u32 max_weight = BIT(HW_ATL2_TPS_DATA_TCTWEIGHT_WIDTH) - 1;\n\t \n\tstatic const u32 scale = BIT(HW_ATL_TPS_DESC_RATE_Y_WIDTH);\n\tstatic const u32 frac_msk = HW_ATL_TPS_DESC_RATE_Y_MSK >>\n\t\t\t\t    HW_ATL_TPS_DESC_RATE_Y_SHIFT;\n\tconst u32 link_speed = self->aq_link_status.mbps;\n\tstruct aq_nic_cfg_s *nic_cfg = self->aq_nic_cfg;\n\tunsigned long num_min_rated_tcs = 0;\n\tu32 tc_weight[AQ_CFG_TCS_MAX];\n\tu32 fixed_max_credit_4b;\n\tu32 fixed_max_credit;\n\tu8 min_rate_msk = 0;\n\tu32 sum_weight = 0;\n\tint tc;\n\n\t \n\tfixed_max_credit = nic_cfg->aq_hw_caps->mtu / 64;\n\t \n\tfixed_max_credit_4b = nic_cfg->aq_hw_caps->mtu / 4;\n\n\tif (link_speed) {\n\t\tmin_rate_msk = nic_cfg->tc_min_rate_msk &\n\t\t\t       (BIT(nic_cfg->tcs) - 1);\n\t\tnum_min_rated_tcs = hweight8(min_rate_msk);\n\t}\n\n\t \n\tif (num_min_rated_tcs) {\n\t\tfor (tc = 0; tc != nic_cfg->tcs; tc++) {\n\t\t\tif (!nic_cfg->tc_min_rate[tc]) {\n\t\t\t\ttc_weight[tc] = 0;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\ttc_weight[tc] = (-1L + link_speed +\n\t\t\t\t\t nic_cfg->tc_min_rate[tc] *\n\t\t\t\t\t max_weight) /\n\t\t\t\t\tlink_speed;\n\t\t\ttc_weight[tc] = min(tc_weight[tc], max_weight);\n\t\t\tsum_weight += tc_weight[tc];\n\t\t}\n\t}\n\n\t \n\thw_atl2_tps_tx_pkt_shed_data_arb_mode_set(self, min_rate_msk ? 1U : 0U);\n\t \n\thw_atl_tps_tx_pkt_shed_desc_tc_arb_mode_set(self, 0U);\n\n\thw_atl_tps_tx_desc_rate_mode_set(self, nic_cfg->is_qos ? 1U : 0U);\n\n\tfor (tc = 0; tc != nic_cfg->tcs; tc++) {\n\t\tconst u32 en = (nic_cfg->tc_max_rate[tc] != 0) ? 1U : 0U;\n\t\tconst u32 desc = AQ_NIC_CFG_TCVEC2RING(nic_cfg, tc, 0);\n\t\tu32 weight, max_credit;\n\n\t\thw_atl_tps_tx_pkt_shed_desc_tc_max_credit_set(self, tc,\n\t\t\t\t\t\t\t      fixed_max_credit);\n\t\thw_atl_tps_tx_pkt_shed_desc_tc_weight_set(self, tc, 0x1E);\n\n\t\tif (num_min_rated_tcs) {\n\t\t\tweight = tc_weight[tc];\n\n\t\t\tif (!weight && sum_weight < max_weight)\n\t\t\t\tweight = (max_weight - sum_weight) /\n\t\t\t\t\t (nic_cfg->tcs - num_min_rated_tcs);\n\t\t\telse if (!weight)\n\t\t\t\tweight = 0x640;\n\n\t\t\tmax_credit = max(2 * weight, fixed_max_credit_4b);\n\t\t} else {\n\t\t\tweight = 0x640;\n\t\t\tmax_credit = 0xFFF0;\n\t\t}\n\n\t\thw_atl2_tps_tx_pkt_shed_tc_data_weight_set(self, tc, weight);\n\t\thw_atl2_tps_tx_pkt_shed_tc_data_max_credit_set(self, tc,\n\t\t\t\t\t\t\t       max_credit);\n\n\t\thw_atl_tps_tx_desc_rate_en_set(self, desc, en);\n\n\t\tif (en) {\n\t\t\t \n\t\t\tconst u32 rate = 10000U * scale /\n\t\t\t\t\t nic_cfg->tc_max_rate[tc];\n\t\t\tconst u32 rate_int = rate >>\n\t\t\t\t\t     HW_ATL_TPS_DESC_RATE_Y_WIDTH;\n\t\t\tconst u32 rate_frac = rate & frac_msk;\n\n\t\t\thw_atl_tps_tx_desc_rate_x_set(self, desc, rate_int);\n\t\t\thw_atl_tps_tx_desc_rate_y_set(self, desc, rate_frac);\n\t\t} else {\n\t\t\t \n\t\t\thw_atl_tps_tx_desc_rate_x_set(self, desc, 1U);\n\t\t\thw_atl_tps_tx_desc_rate_y_set(self, desc, 0U);\n\t\t}\n\t}\n\tfor (tc = nic_cfg->tcs; tc != AQ_CFG_TCS_MAX; tc++) {\n\t\tconst u32 desc = AQ_NIC_CFG_TCVEC2RING(nic_cfg, tc, 0);\n\n\t\thw_atl_tps_tx_desc_rate_en_set(self, desc, 0U);\n\t\thw_atl_tps_tx_desc_rate_x_set(self, desc, 1U);\n\t\thw_atl_tps_tx_desc_rate_y_set(self, desc, 0U);\n\t}\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl2_hw_init_tx_path(struct aq_hw_s *self)\n{\n\tstruct aq_nic_cfg_s *nic_cfg = self->aq_nic_cfg;\n\n\t \n\thw_atl_tpb_tps_tx_tc_mode_set(self, nic_cfg->tc_mode);\n\n\thw_atl_thm_lso_tcp_flag_of_first_pkt_set(self, 0x0FF6U);\n\thw_atl_thm_lso_tcp_flag_of_middle_pkt_set(self, 0x0FF6U);\n\thw_atl_thm_lso_tcp_flag_of_last_pkt_set(self, 0x0F7FU);\n\n\t \n\thw_atl_tdm_tx_desc_wr_wb_irq_en_set(self, 1U);\n\n\t \n\thw_atl_tdm_tx_dca_en_set(self, 0U);\n\thw_atl_tdm_tx_dca_mode_set(self, 0U);\n\n\thw_atl_tpb_tx_path_scp_ins_en_set(self, 1U);\n\n\thw_atl2_tpb_tx_buf_clk_gate_en_set(self, 0U);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic void hw_atl2_hw_init_new_rx_filters(struct aq_hw_s *self)\n{\n\tu8 *prio_tc_map = self->aq_nic_cfg->prio_tc_map;\n\tstruct hw_atl2_priv *priv = self->priv;\n\tu16 action;\n\tu8 index;\n\tint i;\n\n\t \n\thw_atl2_rpf_act_rslvr_section_en_set(self, 0xFFFF);\n\thw_atl2_rpfl2_uc_flr_tag_set(self, HW_ATL2_RPF_TAG_BASE_UC,\n\t\t\t\t     HW_ATL2_MAC_UC);\n\thw_atl2_rpfl2_bc_flr_tag_set(self, HW_ATL2_RPF_TAG_BASE_UC);\n\n\t \n\tindex = priv->art_base_index + HW_ATL2_RPF_L2_PROMISC_OFF_INDEX;\n\thw_atl2_act_rslvr_table_set(self, index, 0,\n\t\t\t\t    HW_ATL2_RPF_TAG_UC_MASK |\n\t\t\t\t\tHW_ATL2_RPF_TAG_ALLMC_MASK,\n\t\t\t\t    HW_ATL2_ACTION_DROP);\n\n\tindex = priv->art_base_index + HW_ATL2_RPF_VLAN_PROMISC_OFF_INDEX;\n\thw_atl2_act_rslvr_table_set(self, index, 0,\n\t\t\t\t    HW_ATL2_RPF_TAG_VLAN_MASK |\n\t\t\t\t\tHW_ATL2_RPF_TAG_UNTAG_MASK,\n\t\t\t\t    HW_ATL2_ACTION_DROP);\n\n\t \n\tfor (i = 0; i < 8; i++) {\n\t\taction = HW_ATL2_ACTION_ASSIGN_TC(prio_tc_map[i]);\n\n\t\tindex = priv->art_base_index + HW_ATL2_RPF_PCP_TO_TC_INDEX + i;\n\t\thw_atl2_act_rslvr_table_set(self, index,\n\t\t\t\t\t    i << HW_ATL2_RPF_TAG_PCP_OFFSET,\n\t\t\t\t\t    HW_ATL2_RPF_TAG_PCP_MASK, action);\n\t}\n}\n\nstatic void hw_atl2_hw_new_rx_filter_vlan_promisc(struct aq_hw_s *self,\n\t\t\t\t\t\t  bool promisc)\n{\n\tu16 off_action = (!promisc &&\n\t\t\t  !hw_atl_rpfl2promiscuous_mode_en_get(self)) ?\n\t\t\t\tHW_ATL2_ACTION_DROP : HW_ATL2_ACTION_DISABLE;\n\tstruct hw_atl2_priv *priv = self->priv;\n\tu8 index;\n\n\tindex = priv->art_base_index + HW_ATL2_RPF_VLAN_PROMISC_OFF_INDEX;\n\thw_atl2_act_rslvr_table_set(self, index, 0,\n\t\t\t\t    HW_ATL2_RPF_TAG_VLAN_MASK |\n\t\t\t\t    HW_ATL2_RPF_TAG_UNTAG_MASK, off_action);\n}\n\nstatic void hw_atl2_hw_new_rx_filter_promisc(struct aq_hw_s *self, bool promisc)\n{\n\tu16 off_action = promisc ? HW_ATL2_ACTION_DISABLE : HW_ATL2_ACTION_DROP;\n\tstruct hw_atl2_priv *priv = self->priv;\n\tbool vlan_promisc_enable;\n\tu8 index;\n\n\tindex = priv->art_base_index + HW_ATL2_RPF_L2_PROMISC_OFF_INDEX;\n\thw_atl2_act_rslvr_table_set(self, index, 0,\n\t\t\t\t    HW_ATL2_RPF_TAG_UC_MASK |\n\t\t\t\t    HW_ATL2_RPF_TAG_ALLMC_MASK,\n\t\t\t\t    off_action);\n\n\t \n\tvlan_promisc_enable = hw_atl_rpf_vlan_prom_mode_en_get(self);\n\thw_atl2_hw_new_rx_filter_vlan_promisc(self, promisc |\n\t\t\t\t\t      vlan_promisc_enable);\n}\n\nstatic int hw_atl2_act_rslvr_table_set(struct aq_hw_s *self, u8 location,\n\t\t\t\t       u32 tag, u32 mask, u32 action)\n{\n\tu32 val;\n\tint err;\n\n\terr = readx_poll_timeout_atomic(hw_atl2_sem_act_rslvr_get,\n\t\t\t\t\tself, val, val == 1,\n\t\t\t\t\t1, 10000U);\n\tif (err)\n\t\treturn err;\n\n\thw_atl2_rpf_act_rslvr_record_set(self, location, tag, mask,\n\t\t\t\t\t action);\n\n\thw_atl_reg_glb_cpu_sem_set(self, 1, HW_ATL2_FW_SM_ACT_RSLVR);\n\n\treturn err;\n}\n\nstatic int hw_atl2_hw_init_rx_path(struct aq_hw_s *self)\n{\n\tstruct aq_nic_cfg_s *cfg = self->aq_nic_cfg;\n\tint i;\n\n\t \n\thw_atl_rpb_rpf_rx_traf_class_mode_set(self, cfg->tc_mode);\n\n\t \n\thw_atl_rpb_rx_flow_ctl_mode_set(self, 1U);\n\n\thw_atl2_rpf_rss_hash_type_set(self, HW_ATL2_RPF_RSS_HASH_TYPE_ALL);\n\n\t \n\thw_atl_b0_hw_init_rx_rss_ctrl1(self);\n\n\t \n\tfor (i = HW_ATL2_MAC_MAX; i--;) {\n\t\thw_atl_rpfl2_uc_flr_en_set(self, (i == 0U) ? 1U : 0U, i);\n\t\thw_atl_rpfl2unicast_flr_act_set(self, 1U, i);\n\t}\n\n\thw_atl_reg_rx_flr_mcst_flr_msk_set(self, 0x00000000U);\n\thw_atl_reg_rx_flr_mcst_flr_set(self, HW_ATL_MCAST_FLT_ANY_TO_HOST, 0U);\n\n\t \n\thw_atl_rpf_vlan_outer_etht_set(self, ETH_P_8021AD);\n\thw_atl_rpf_vlan_inner_etht_set(self, ETH_P_8021Q);\n\n\thw_atl_rpf_vlan_prom_mode_en_set(self, 1);\n\n\t \n\thw_atl_rpf_vlan_accept_untagged_packets_set(self, 1U);\n\thw_atl_rpf_vlan_untagged_act_set(self, 1U);\n\n\thw_atl2_hw_init_new_rx_filters(self);\n\n\t \n\thw_atl_rdm_rx_desc_wr_wb_irq_en_set(self, 1U);\n\n\thw_atl_rpfl2broadcast_flr_act_set(self, 1U);\n\thw_atl_rpfl2broadcast_count_threshold_set(self, 0xFFFFU & (~0U / 256U));\n\n\thw_atl_rdm_rx_dca_en_set(self, 0U);\n\thw_atl_rdm_rx_dca_mode_set(self, 0U);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl2_hw_init(struct aq_hw_s *self, const u8 *mac_addr)\n{\n\tstatic u32 aq_hw_atl2_igcr_table_[4][2] = {\n\t\t[AQ_HW_IRQ_INVALID] = { 0x20000000U, 0x20000000U },\n\t\t[AQ_HW_IRQ_LEGACY]  = { 0x20000080U, 0x20000080U },\n\t\t[AQ_HW_IRQ_MSI]     = { 0x20000021U, 0x20000025U },\n\t\t[AQ_HW_IRQ_MSIX]    = { 0x20000022U, 0x20000026U },\n\t};\n\n\tstruct aq_nic_cfg_s *aq_nic_cfg = self->aq_nic_cfg;\n\tstruct hw_atl2_priv *priv = self->priv;\n\tu8 base_index, count;\n\tint err;\n\n\terr = hw_atl2_utils_get_action_resolve_table_caps(self, &base_index,\n\t\t\t\t\t\t\t  &count);\n\tif (err)\n\t\treturn err;\n\n\tpriv->art_base_index = 8 * base_index;\n\n\thw_atl2_init_launchtime(self);\n\n\thw_atl2_hw_init_tx_path(self);\n\thw_atl2_hw_init_rx_path(self);\n\n\thw_atl_b0_hw_mac_addr_set(self, mac_addr);\n\n\tself->aq_fw_ops->set_link_speed(self, aq_nic_cfg->link_speed_msk);\n\tself->aq_fw_ops->set_state(self, MPI_INIT);\n\n\thw_atl2_hw_qos_set(self);\n\thw_atl2_hw_rss_set(self, &aq_nic_cfg->aq_rss);\n\thw_atl_b0_hw_rss_hash_set(self, &aq_nic_cfg->aq_rss);\n\n\thw_atl2_rpf_new_enable_set(self, 1);\n\n\t \n\tself->aq_link_status.mbps = 0;\n\tself->aq_fw_ops->update_stats(self);\n\n\terr = aq_hw_err_from_flags(self);\n\tif (err < 0)\n\t\tgoto err_exit;\n\n\t \n\thw_atl_reg_irq_glb_ctl_set(self,\n\t\t\t\t   aq_hw_atl2_igcr_table_[aq_nic_cfg->irq_type]\n\t\t\t\t\t\t [(aq_nic_cfg->vecs > 1U) ?\n\t\t\t\t\t\t  1 : 0]);\n\n\thw_atl_itr_irq_auto_masklsw_set(self, aq_nic_cfg->aq_hw_caps->irq_mask);\n\n\t \n\thw_atl_reg_gen_irq_map_set(self,\n\t\t\t\t   ((HW_ATL2_ERR_INT << 0x18) |\n\t\t\t\t    (1U << 0x1F)) |\n\t\t\t\t   ((HW_ATL2_ERR_INT << 0x10) |\n\t\t\t\t    (1U << 0x17)), 0U);\n\n\thw_atl_b0_hw_offload_set(self, aq_nic_cfg);\n\nerr_exit:\n\treturn err;\n}\n\nstatic int hw_atl2_hw_ring_rx_init(struct aq_hw_s *self,\n\t\t\t\t   struct aq_ring_s *aq_ring,\n\t\t\t\t   struct aq_ring_param_s *aq_ring_param)\n{\n\treturn hw_atl_b0_hw_ring_rx_init(self, aq_ring, aq_ring_param);\n}\n\nstatic int hw_atl2_hw_ring_tx_init(struct aq_hw_s *self,\n\t\t\t\t   struct aq_ring_s *aq_ring,\n\t\t\t\t   struct aq_ring_param_s *aq_ring_param)\n{\n\treturn hw_atl_b0_hw_ring_tx_init(self, aq_ring, aq_ring_param);\n}\n\n#define IS_FILTER_ENABLED(_F_) ((packet_filter & (_F_)) ? 1U : 0U)\n\nstatic int hw_atl2_hw_packet_filter_set(struct aq_hw_s *self,\n\t\t\t\t\tunsigned int packet_filter)\n{\n\thw_atl2_hw_new_rx_filter_promisc(self, IS_FILTER_ENABLED(IFF_PROMISC));\n\n\treturn hw_atl_b0_hw_packet_filter_set(self, packet_filter);\n}\n\n#undef IS_FILTER_ENABLED\n\nstatic int hw_atl2_hw_multicast_list_set(struct aq_hw_s *self,\n\t\t\t\t\t u8 ar_mac\n\t\t\t\t\t [AQ_HW_MULTICAST_ADDRESS_MAX]\n\t\t\t\t\t [ETH_ALEN],\n\t\t\t\t\t u32 count)\n{\n\tstruct aq_nic_cfg_s *cfg = self->aq_nic_cfg;\n\tint err = 0;\n\n\tif (count > (HW_ATL2_MAC_MAX - HW_ATL2_MAC_MIN)) {\n\t\terr = -EBADRQC;\n\t\tgoto err_exit;\n\t}\n\tfor (cfg->mc_list_count = 0U;\n\t\t\tcfg->mc_list_count < count;\n\t\t\t++cfg->mc_list_count) {\n\t\tu32 i = cfg->mc_list_count;\n\t\tu32 h = (ar_mac[i][0] << 8) | (ar_mac[i][1]);\n\t\tu32 l = (ar_mac[i][2] << 24) | (ar_mac[i][3] << 16) |\n\t\t\t\t\t(ar_mac[i][4] << 8) | ar_mac[i][5];\n\n\t\thw_atl_rpfl2_uc_flr_en_set(self, 0U, HW_ATL2_MAC_MIN + i);\n\n\t\thw_atl_rpfl2unicast_dest_addresslsw_set(self, l,\n\t\t\t\t\t\t\tHW_ATL2_MAC_MIN + i);\n\n\t\thw_atl_rpfl2unicast_dest_addressmsw_set(self, h,\n\t\t\t\t\t\t\tHW_ATL2_MAC_MIN + i);\n\n\t\thw_atl2_rpfl2_uc_flr_tag_set(self, 1, HW_ATL2_MAC_MIN + i);\n\n\t\thw_atl_rpfl2_uc_flr_en_set(self, (cfg->is_mc_list_enabled),\n\t\t\t\t\t   HW_ATL2_MAC_MIN + i);\n\t}\n\n\terr = aq_hw_err_from_flags(self);\n\nerr_exit:\n\treturn err;\n}\n\nstatic int hw_atl2_hw_interrupt_moderation_set(struct aq_hw_s *self)\n{\n\tunsigned int i = 0U;\n\tu32 itr_tx = 2U;\n\tu32 itr_rx = 2U;\n\n\tswitch (self->aq_nic_cfg->itr) {\n\tcase  AQ_CFG_INTERRUPT_MODERATION_ON:\n\tcase  AQ_CFG_INTERRUPT_MODERATION_AUTO:\n\t\thw_atl_tdm_tx_desc_wr_wb_irq_en_set(self, 0U);\n\t\thw_atl_tdm_tdm_intr_moder_en_set(self, 1U);\n\t\thw_atl_rdm_rx_desc_wr_wb_irq_en_set(self, 0U);\n\t\thw_atl_rdm_rdm_intr_moder_en_set(self, 1U);\n\n\t\tif (self->aq_nic_cfg->itr == AQ_CFG_INTERRUPT_MODERATION_ON) {\n\t\t\t \n\t\t\tint tx_max_timer = self->aq_nic_cfg->tx_itr / 2;\n\t\t\tint tx_min_timer = tx_max_timer / 2;\n\n\t\t\tint rx_max_timer = self->aq_nic_cfg->rx_itr / 2;\n\t\t\tint rx_min_timer = rx_max_timer / 2;\n\n\t\t\ttx_max_timer = min(HW_ATL2_INTR_MODER_MAX,\n\t\t\t\t\t   tx_max_timer);\n\t\t\ttx_min_timer = min(HW_ATL2_INTR_MODER_MIN,\n\t\t\t\t\t   tx_min_timer);\n\t\t\trx_max_timer = min(HW_ATL2_INTR_MODER_MAX,\n\t\t\t\t\t   rx_max_timer);\n\t\t\trx_min_timer = min(HW_ATL2_INTR_MODER_MIN,\n\t\t\t\t\t   rx_min_timer);\n\n\t\t\titr_tx |= tx_min_timer << 0x8U;\n\t\t\titr_tx |= tx_max_timer << 0x10U;\n\t\t\titr_rx |= rx_min_timer << 0x8U;\n\t\t\titr_rx |= rx_max_timer << 0x10U;\n\t\t} else {\n\t\t\tstatic unsigned int hw_atl2_timers_table_tx_[][2] = {\n\t\t\t\t{0xfU, 0xffU},  \n\t\t\t\t{0xfU, 0x1ffU},  \n\t\t\t\t{0xfU, 0x1ffU},  \n\t\t\t\t{0xfU, 0x1ffU},  \n\t\t\t\t{0xfU, 0x1ffU},  \n\t\t\t\t{0xfU, 0x1ffU},  \n\t\t\t};\n\t\t\tstatic unsigned int hw_atl2_timers_table_rx_[][2] = {\n\t\t\t\t{0x6U, 0x38U}, \n\t\t\t\t{0xCU, 0x70U}, \n\t\t\t\t{0xCU, 0x70U}, \n\t\t\t\t{0x18U, 0xE0U}, \n\t\t\t\t{0x30U, 0x80U}, \n\t\t\t\t{0x4U, 0x50U}, \n\t\t\t};\n\t\t\tunsigned int mbps = self->aq_link_status.mbps;\n\t\t\tunsigned int speed_index;\n\n\t\t\tspeed_index = hw_atl_utils_mbps_2_speed_index(mbps);\n\n\t\t\t \n\t\t\tself->aq_nic_cfg->tx_itr = hw_atl2_timers_table_tx_\n\t\t\t\t\t\t\t[speed_index][1] * 2;\n\t\t\tself->aq_nic_cfg->rx_itr = hw_atl2_timers_table_rx_\n\t\t\t\t\t\t\t[speed_index][1] * 2;\n\n\t\t\titr_tx |= hw_atl2_timers_table_tx_\n\t\t\t\t\t\t[speed_index][0] << 0x8U;\n\t\t\titr_tx |= hw_atl2_timers_table_tx_\n\t\t\t\t\t\t[speed_index][1] << 0x10U;\n\n\t\t\titr_rx |= hw_atl2_timers_table_rx_\n\t\t\t\t\t\t[speed_index][0] << 0x8U;\n\t\t\titr_rx |= hw_atl2_timers_table_rx_\n\t\t\t\t\t\t[speed_index][1] << 0x10U;\n\t\t}\n\t\tbreak;\n\tcase AQ_CFG_INTERRUPT_MODERATION_OFF:\n\t\thw_atl_tdm_tx_desc_wr_wb_irq_en_set(self, 1U);\n\t\thw_atl_tdm_tdm_intr_moder_en_set(self, 0U);\n\t\thw_atl_rdm_rx_desc_wr_wb_irq_en_set(self, 1U);\n\t\thw_atl_rdm_rdm_intr_moder_en_set(self, 0U);\n\t\titr_tx = 0U;\n\t\titr_rx = 0U;\n\t\tbreak;\n\t}\n\n\tfor (i = HW_ATL2_RINGS_MAX; i--;) {\n\t\thw_atl2_reg_tx_intr_moder_ctrl_set(self, itr_tx, i);\n\t\thw_atl_reg_rx_intr_moder_ctrl_set(self, itr_rx, i);\n\t}\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl2_hw_stop(struct aq_hw_s *self)\n{\n\thw_atl_b0_hw_irq_disable(self, HW_ATL2_INT_MASK);\n\n\treturn 0;\n}\n\nstatic struct aq_stats_s *hw_atl2_utils_get_hw_stats(struct aq_hw_s *self)\n{\n\treturn &self->curr_stats;\n}\n\nstatic int hw_atl2_hw_vlan_set(struct aq_hw_s *self,\n\t\t\t       struct aq_rx_filter_vlan *aq_vlans)\n{\n\tstruct hw_atl2_priv *priv = self->priv;\n\tu32 queue;\n\tu8 index;\n\tint i;\n\n\thw_atl_rpf_vlan_prom_mode_en_set(self, 1U);\n\n\tfor (i = 0; i < HW_ATL_VLAN_MAX_FILTERS; i++) {\n\t\tqueue = HW_ATL2_ACTION_ASSIGN_QUEUE(aq_vlans[i].queue);\n\n\t\thw_atl_rpf_vlan_flr_en_set(self, 0U, i);\n\t\thw_atl_rpf_vlan_rxq_en_flr_set(self, 0U, i);\n\t\tindex = priv->art_base_index + HW_ATL2_RPF_VLAN_USER_INDEX + i;\n\t\thw_atl2_act_rslvr_table_set(self, index, 0, 0,\n\t\t\t\t\t    HW_ATL2_ACTION_DISABLE);\n\t\tif (aq_vlans[i].enable) {\n\t\t\thw_atl_rpf_vlan_id_flr_set(self,\n\t\t\t\t\t\t   aq_vlans[i].vlan_id, i);\n\t\t\thw_atl_rpf_vlan_flr_act_set(self, 1U, i);\n\t\t\thw_atl_rpf_vlan_flr_en_set(self, 1U, i);\n\n\t\t\tif (aq_vlans[i].queue != 0xFF) {\n\t\t\t\thw_atl_rpf_vlan_rxq_flr_set(self,\n\t\t\t\t\t\t\t    aq_vlans[i].queue,\n\t\t\t\t\t\t\t    i);\n\t\t\t\thw_atl_rpf_vlan_rxq_en_flr_set(self, 1U, i);\n\n\t\t\t\thw_atl2_rpf_vlan_flr_tag_set(self, i + 2, i);\n\n\t\t\t\tindex = priv->art_base_index +\n\t\t\t\t\tHW_ATL2_RPF_VLAN_USER_INDEX + i;\n\t\t\t\thw_atl2_act_rslvr_table_set(self, index,\n\t\t\t\t\t(i + 2) << HW_ATL2_RPF_TAG_VLAN_OFFSET,\n\t\t\t\t\tHW_ATL2_RPF_TAG_VLAN_MASK, queue);\n\t\t\t} else {\n\t\t\t\thw_atl2_rpf_vlan_flr_tag_set(self, 1, i);\n\t\t\t}\n\t\t}\n\t}\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nstatic int hw_atl2_hw_vlan_ctrl(struct aq_hw_s *self, bool enable)\n{\n\t \n\thw_atl_rpf_vlan_prom_mode_en_set(self, !enable);\n\thw_atl2_hw_new_rx_filter_vlan_promisc(self, !enable);\n\n\treturn aq_hw_err_from_flags(self);\n}\n\nconst struct aq_hw_ops hw_atl2_ops = {\n\t.hw_soft_reset        = hw_atl2_utils_soft_reset,\n\t.hw_prepare           = hw_atl2_utils_initfw,\n\t.hw_set_mac_address   = hw_atl_b0_hw_mac_addr_set,\n\t.hw_init              = hw_atl2_hw_init,\n\t.hw_reset             = hw_atl2_hw_reset,\n\t.hw_start             = hw_atl_b0_hw_start,\n\t.hw_ring_tx_start     = hw_atl_b0_hw_ring_tx_start,\n\t.hw_ring_tx_stop      = hw_atl_b0_hw_ring_tx_stop,\n\t.hw_ring_rx_start     = hw_atl_b0_hw_ring_rx_start,\n\t.hw_ring_rx_stop      = hw_atl_b0_hw_ring_rx_stop,\n\t.hw_stop              = hw_atl2_hw_stop,\n\n\t.hw_ring_tx_xmit         = hw_atl_b0_hw_ring_tx_xmit,\n\t.hw_ring_tx_head_update  = hw_atl_b0_hw_ring_tx_head_update,\n\n\t.hw_ring_rx_receive      = hw_atl_b0_hw_ring_rx_receive,\n\t.hw_ring_rx_fill         = hw_atl_b0_hw_ring_rx_fill,\n\n\t.hw_irq_enable           = hw_atl_b0_hw_irq_enable,\n\t.hw_irq_disable          = hw_atl_b0_hw_irq_disable,\n\t.hw_irq_read             = hw_atl_b0_hw_irq_read,\n\n\t.hw_ring_rx_init             = hw_atl2_hw_ring_rx_init,\n\t.hw_ring_tx_init             = hw_atl2_hw_ring_tx_init,\n\t.hw_packet_filter_set        = hw_atl2_hw_packet_filter_set,\n\t.hw_filter_vlan_set          = hw_atl2_hw_vlan_set,\n\t.hw_filter_vlan_ctrl         = hw_atl2_hw_vlan_ctrl,\n\t.hw_multicast_list_set       = hw_atl2_hw_multicast_list_set,\n\t.hw_interrupt_moderation_set = hw_atl2_hw_interrupt_moderation_set,\n\t.hw_rss_set                  = hw_atl2_hw_rss_set,\n\t.hw_rss_hash_set             = hw_atl_b0_hw_rss_hash_set,\n\t.hw_tc_rate_limit_set        = hw_atl2_hw_init_tx_tc_rate_limit,\n\t.hw_get_hw_stats             = hw_atl2_utils_get_hw_stats,\n\t.hw_get_fw_version           = hw_atl2_utils_get_fw_version,\n\t.hw_set_offload              = hw_atl_b0_hw_offload_set,\n\t.hw_set_loopback             = hw_atl_b0_set_loopback,\n\t.hw_set_fc                   = hw_atl_b0_set_fc,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}