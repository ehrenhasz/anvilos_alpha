{
  "module_name": "hw_atl2_utils.c",
  "hash_id": "9014ecc36817fb38f747419214dcb9a16028bf17447c6d2a244025cadddc9ab1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/aquantia/atlantic/hw_atl2/hw_atl2_utils.c",
  "human_readable_source": "\n \n\n#include <linux/iopoll.h>\n\n#include \"aq_hw_utils.h\"\n#include \"hw_atl/hw_atl_utils.h\"\n#include \"hw_atl2_utils.h\"\n#include \"hw_atl2_llh.h\"\n#include \"hw_atl2_llh_internal.h\"\n\n#define HW_ATL2_FW_VER_1X          0x01000000U\n\n#define AQ_A2_BOOT_STARTED         BIT(0x18)\n#define AQ_A2_CRASH_INIT           BIT(0x1B)\n#define AQ_A2_BOOT_CODE_FAILED     BIT(0x1C)\n#define AQ_A2_FW_INIT_FAILED       BIT(0x1D)\n#define AQ_A2_FW_INIT_COMP_SUCCESS BIT(0x1F)\n\n#define AQ_A2_FW_BOOT_FAILED_MASK (AQ_A2_CRASH_INIT | \\\n\t\t\t\t   AQ_A2_BOOT_CODE_FAILED | \\\n\t\t\t\t   AQ_A2_FW_INIT_FAILED)\n#define AQ_A2_FW_BOOT_COMPLETE_MASK (AQ_A2_FW_BOOT_FAILED_MASK | \\\n\t\t\t\t     AQ_A2_FW_INIT_COMP_SUCCESS)\n\n#define AQ_A2_FW_BOOT_REQ_REBOOT        BIT(0x0)\n#define AQ_A2_FW_BOOT_REQ_HOST_BOOT     BIT(0x8)\n#define AQ_A2_FW_BOOT_REQ_MAC_FAST_BOOT BIT(0xA)\n#define AQ_A2_FW_BOOT_REQ_PHY_FAST_BOOT BIT(0xB)\n\nint hw_atl2_utils_initfw(struct aq_hw_s *self, const struct aq_fw_ops **fw_ops)\n{\n\tint err;\n\n\tself->fw_ver_actual = hw_atl2_utils_get_fw_version(self);\n\n\tif (hw_atl_utils_ver_match(HW_ATL2_FW_VER_1X, self->fw_ver_actual)) {\n\t\t*fw_ops = &aq_a2_fw_ops;\n\t} else {\n\t\taq_pr_err(\"Bad FW version detected: %x, but continue\\n\",\n\t\t\t  self->fw_ver_actual);\n\t\t*fw_ops = &aq_a2_fw_ops;\n\t}\n\taq_pr_trace(\"Detect ATL2FW %x\\n\", self->fw_ver_actual);\n\tself->aq_fw_ops = *fw_ops;\n\terr = self->aq_fw_ops->init(self);\n\n\tself->chip_features |= ATL_HW_CHIP_ANTIGUA;\n\n\treturn err;\n}\n\nstatic bool hw_atl2_mcp_boot_complete(struct aq_hw_s *self)\n{\n\tu32 rbl_status;\n\n\trbl_status = hw_atl2_mif_mcp_boot_reg_get(self);\n\tif (rbl_status & AQ_A2_FW_BOOT_COMPLETE_MASK)\n\t\treturn true;\n\n\t \n\tif (hw_atl2_mif_host_req_int_get(self) & HW_ATL2_MCP_HOST_REQ_INT_READY)\n\t\treturn true;\n\n\treturn false;\n}\n\nint hw_atl2_utils_soft_reset(struct aq_hw_s *self)\n{\n\tbool rbl_complete = false;\n\tu32 rbl_status = 0;\n\tu32 rbl_request;\n\tint err;\n\n\thw_atl2_mif_host_req_int_clr(self, 0x01);\n\trbl_request = AQ_A2_FW_BOOT_REQ_REBOOT;\n#ifdef AQ_CFG_FAST_START\n\trbl_request |= AQ_A2_FW_BOOT_REQ_MAC_FAST_BOOT;\n#endif\n\thw_atl2_mif_mcp_boot_reg_set(self, rbl_request);\n\n\t \n\terr = readx_poll_timeout_atomic(hw_atl2_mif_mcp_boot_reg_get, self,\n\t\t\t\trbl_status,\n\t\t\t\t((rbl_status & AQ_A2_BOOT_STARTED) &&\n\t\t\t\t (rbl_status != 0xFFFFFFFFu)),\n\t\t\t\t10, 200000);\n\tif (err) {\n\t\taq_pr_err(\"Boot code hanged\");\n\t\tgoto err_exit;\n\t}\n\n\terr = readx_poll_timeout_atomic(hw_atl2_mcp_boot_complete, self,\n\t\t\t\t\trbl_complete,\n\t\t\t\t\trbl_complete,\n\t\t\t\t\t10, 2000000);\n\n\tif (err) {\n\t\taq_pr_err(\"FW Restart timed out\");\n\t\tgoto err_exit;\n\t}\n\n\trbl_status = hw_atl2_mif_mcp_boot_reg_get(self);\n\n\tif (rbl_status & AQ_A2_FW_BOOT_FAILED_MASK) {\n\t\terr = -EIO;\n\t\taq_pr_err(\"FW Restart failed\");\n\t\tgoto err_exit;\n\t}\n\n\tif (hw_atl2_mif_host_req_int_get(self) &\n\t    HW_ATL2_MCP_HOST_REQ_INT_READY) {\n\t\terr = -EIO;\n\t\taq_pr_err(\"No FW detected. Dynamic FW load not implemented\");\n\t\tgoto err_exit;\n\t}\n\n\tif (self->aq_fw_ops) {\n\t\terr = self->aq_fw_ops->init(self);\n\t\tif (err) {\n\t\t\taq_pr_err(\"FW Init failed\");\n\t\t\tgoto err_exit;\n\t\t}\n\t}\n\nerr_exit:\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}