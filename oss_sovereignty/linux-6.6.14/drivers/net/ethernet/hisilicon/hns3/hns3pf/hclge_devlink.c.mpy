{
  "module_name": "hclge_devlink.c",
  "hash_id": "02b5de57cb2580400714aba8509d78554102518d897d99d4f26db439fd00ce03",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/hisilicon/hns3/hns3pf/hclge_devlink.c",
  "human_readable_source": "\n \n\n#include <net/devlink.h>\n\n#include \"hclge_devlink.h\"\n\nstatic int hclge_devlink_info_get(struct devlink *devlink,\n\t\t\t\t  struct devlink_info_req *req,\n\t\t\t\t  struct netlink_ext_ack *extack)\n{\n#define\tHCLGE_DEVLINK_FW_STRING_LEN\t32\n\tstruct hclge_devlink_priv *priv = devlink_priv(devlink);\n\tchar version_str[HCLGE_DEVLINK_FW_STRING_LEN];\n\tstruct hclge_dev *hdev = priv->hdev;\n\n\tsnprintf(version_str, sizeof(version_str), \"%lu.%lu.%lu.%lu\",\n\t\t hnae3_get_field(hdev->fw_version, HNAE3_FW_VERSION_BYTE3_MASK,\n\t\t\t\t HNAE3_FW_VERSION_BYTE3_SHIFT),\n\t\t hnae3_get_field(hdev->fw_version, HNAE3_FW_VERSION_BYTE2_MASK,\n\t\t\t\t HNAE3_FW_VERSION_BYTE2_SHIFT),\n\t\t hnae3_get_field(hdev->fw_version, HNAE3_FW_VERSION_BYTE1_MASK,\n\t\t\t\t HNAE3_FW_VERSION_BYTE1_SHIFT),\n\t\t hnae3_get_field(hdev->fw_version, HNAE3_FW_VERSION_BYTE0_MASK,\n\t\t\t\t HNAE3_FW_VERSION_BYTE0_SHIFT));\n\n\treturn devlink_info_version_running_put(req,\n\t\t\t\t\t\tDEVLINK_INFO_VERSION_GENERIC_FW,\n\t\t\t\t\t\tversion_str);\n}\n\nstatic int hclge_devlink_reload_down(struct devlink *devlink, bool netns_change,\n\t\t\t\t     enum devlink_reload_action action,\n\t\t\t\t     enum devlink_reload_limit limit,\n\t\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct hclge_devlink_priv *priv = devlink_priv(devlink);\n\tstruct hclge_dev *hdev = priv->hdev;\n\tstruct hnae3_handle *h = &hdev->vport->nic;\n\tstruct pci_dev *pdev = hdev->pdev;\n\tint ret;\n\n\tif (test_bit(HCLGE_STATE_RST_HANDLING, &hdev->state)) {\n\t\tdev_err(&pdev->dev, \"reset is handling\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\tswitch (action) {\n\tcase DEVLINK_RELOAD_ACTION_DRIVER_REINIT:\n\t\trtnl_lock();\n\t\tret = hdev->nic_client->ops->reset_notify(h, HNAE3_DOWN_CLIENT);\n\t\tif (ret) {\n\t\t\trtnl_unlock();\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = hdev->nic_client->ops->reset_notify(h,\n\t\t\t\t\t\t\t  HNAE3_UNINIT_CLIENT);\n\t\trtnl_unlock();\n\t\treturn ret;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int hclge_devlink_reload_up(struct devlink *devlink,\n\t\t\t\t   enum devlink_reload_action action,\n\t\t\t\t   enum devlink_reload_limit limit,\n\t\t\t\t   u32 *actions_performed,\n\t\t\t\t   struct netlink_ext_ack *extack)\n{\n\tstruct hclge_devlink_priv *priv = devlink_priv(devlink);\n\tstruct hclge_dev *hdev = priv->hdev;\n\tstruct hnae3_handle *h = &hdev->vport->nic;\n\tint ret;\n\n\t*actions_performed = BIT(action);\n\tswitch (action) {\n\tcase DEVLINK_RELOAD_ACTION_DRIVER_REINIT:\n\t\trtnl_lock();\n\t\tret = hdev->nic_client->ops->reset_notify(h, HNAE3_INIT_CLIENT);\n\t\tif (ret) {\n\t\t\trtnl_unlock();\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = hdev->nic_client->ops->reset_notify(h, HNAE3_UP_CLIENT);\n\t\trtnl_unlock();\n\t\treturn ret;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic const struct devlink_ops hclge_devlink_ops = {\n\t.info_get = hclge_devlink_info_get,\n\t.reload_actions = BIT(DEVLINK_RELOAD_ACTION_DRIVER_REINIT),\n\t.reload_down = hclge_devlink_reload_down,\n\t.reload_up = hclge_devlink_reload_up,\n};\n\nint hclge_devlink_init(struct hclge_dev *hdev)\n{\n\tstruct pci_dev *pdev = hdev->pdev;\n\tstruct hclge_devlink_priv *priv;\n\tstruct devlink *devlink;\n\n\tdevlink = devlink_alloc(&hclge_devlink_ops,\n\t\t\t\tsizeof(struct hclge_devlink_priv), &pdev->dev);\n\tif (!devlink)\n\t\treturn -ENOMEM;\n\n\tpriv = devlink_priv(devlink);\n\tpriv->hdev = hdev;\n\thdev->devlink = devlink;\n\n\tdevlink_register(devlink);\n\treturn 0;\n}\n\nvoid hclge_devlink_uninit(struct hclge_dev *hdev)\n{\n\tstruct devlink *devlink = hdev->devlink;\n\n\tdevlink_unregister(devlink);\n\n\tdevlink_free(devlink);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}