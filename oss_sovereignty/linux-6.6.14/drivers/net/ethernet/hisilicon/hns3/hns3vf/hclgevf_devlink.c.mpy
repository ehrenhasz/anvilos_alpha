{
  "module_name": "hclgevf_devlink.c",
  "hash_id": "0c3577a14b7b462c9774acba33ea421f13bc0575a294cc1368fee62aa22f777a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/hisilicon/hns3/hns3vf/hclgevf_devlink.c",
  "human_readable_source": "\n \n\n#include <net/devlink.h>\n\n#include \"hclgevf_devlink.h\"\n\nstatic int hclgevf_devlink_info_get(struct devlink *devlink,\n\t\t\t\t    struct devlink_info_req *req,\n\t\t\t\t    struct netlink_ext_ack *extack)\n{\n#define\tHCLGEVF_DEVLINK_FW_STRING_LEN\t32\n\tstruct hclgevf_devlink_priv *priv = devlink_priv(devlink);\n\tchar version_str[HCLGEVF_DEVLINK_FW_STRING_LEN];\n\tstruct hclgevf_dev *hdev = priv->hdev;\n\n\tsnprintf(version_str, sizeof(version_str), \"%lu.%lu.%lu.%lu\",\n\t\t hnae3_get_field(hdev->fw_version, HNAE3_FW_VERSION_BYTE3_MASK,\n\t\t\t\t HNAE3_FW_VERSION_BYTE3_SHIFT),\n\t\t hnae3_get_field(hdev->fw_version, HNAE3_FW_VERSION_BYTE2_MASK,\n\t\t\t\t HNAE3_FW_VERSION_BYTE2_SHIFT),\n\t\t hnae3_get_field(hdev->fw_version, HNAE3_FW_VERSION_BYTE1_MASK,\n\t\t\t\t HNAE3_FW_VERSION_BYTE1_SHIFT),\n\t\t hnae3_get_field(hdev->fw_version, HNAE3_FW_VERSION_BYTE0_MASK,\n\t\t\t\t HNAE3_FW_VERSION_BYTE0_SHIFT));\n\n\treturn devlink_info_version_running_put(req,\n\t\t\t\t\t\tDEVLINK_INFO_VERSION_GENERIC_FW,\n\t\t\t\t\t\tversion_str);\n}\n\nstatic int hclgevf_devlink_reload_down(struct devlink *devlink,\n\t\t\t\t       bool netns_change,\n\t\t\t\t       enum devlink_reload_action action,\n\t\t\t\t       enum devlink_reload_limit limit,\n\t\t\t\t       struct netlink_ext_ack *extack)\n{\n\tstruct hclgevf_devlink_priv *priv = devlink_priv(devlink);\n\tstruct hclgevf_dev *hdev = priv->hdev;\n\tstruct hnae3_handle *h = &hdev->nic;\n\tstruct pci_dev *pdev = hdev->pdev;\n\tint ret;\n\n\tif (test_bit(HCLGEVF_STATE_RST_HANDLING, &hdev->state)) {\n\t\tdev_err(&pdev->dev, \"reset is handling\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\tswitch (action) {\n\tcase DEVLINK_RELOAD_ACTION_DRIVER_REINIT:\n\t\trtnl_lock();\n\t\tret = hdev->nic_client->ops->reset_notify(h, HNAE3_DOWN_CLIENT);\n\t\tif (ret) {\n\t\t\trtnl_unlock();\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = hdev->nic_client->ops->reset_notify(h,\n\t\t\t\t\t\t\t  HNAE3_UNINIT_CLIENT);\n\t\trtnl_unlock();\n\t\treturn ret;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int hclgevf_devlink_reload_up(struct devlink *devlink,\n\t\t\t\t     enum devlink_reload_action action,\n\t\t\t\t     enum devlink_reload_limit limit,\n\t\t\t\t     u32 *actions_performed,\n\t\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct hclgevf_devlink_priv *priv = devlink_priv(devlink);\n\tstruct hclgevf_dev *hdev = priv->hdev;\n\tstruct hnae3_handle *h = &hdev->nic;\n\tint ret;\n\n\t*actions_performed = BIT(action);\n\tswitch (action) {\n\tcase DEVLINK_RELOAD_ACTION_DRIVER_REINIT:\n\t\trtnl_lock();\n\t\tret = hdev->nic_client->ops->reset_notify(h, HNAE3_INIT_CLIENT);\n\t\tif (ret) {\n\t\t\trtnl_unlock();\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = hdev->nic_client->ops->reset_notify(h, HNAE3_UP_CLIENT);\n\t\trtnl_unlock();\n\t\treturn ret;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic const struct devlink_ops hclgevf_devlink_ops = {\n\t.info_get = hclgevf_devlink_info_get,\n\t.reload_actions = BIT(DEVLINK_RELOAD_ACTION_DRIVER_REINIT),\n\t.reload_down = hclgevf_devlink_reload_down,\n\t.reload_up = hclgevf_devlink_reload_up,\n};\n\nint hclgevf_devlink_init(struct hclgevf_dev *hdev)\n{\n\tstruct pci_dev *pdev = hdev->pdev;\n\tstruct hclgevf_devlink_priv *priv;\n\tstruct devlink *devlink;\n\n\tdevlink =\n\t\tdevlink_alloc(&hclgevf_devlink_ops,\n\t\t\t      sizeof(struct hclgevf_devlink_priv), &pdev->dev);\n\tif (!devlink)\n\t\treturn -ENOMEM;\n\n\tpriv = devlink_priv(devlink);\n\tpriv->hdev = hdev;\n\thdev->devlink = devlink;\n\n\tdevlink_register(devlink);\n\treturn 0;\n}\n\nvoid hclgevf_devlink_uninit(struct hclgevf_dev *hdev)\n{\n\tstruct devlink *devlink = hdev->devlink;\n\n\tdevlink_unregister(devlink);\n\n\tdevlink_free(devlink);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}