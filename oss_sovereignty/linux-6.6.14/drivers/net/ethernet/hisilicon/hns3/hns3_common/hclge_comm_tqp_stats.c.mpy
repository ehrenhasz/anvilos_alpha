{
  "module_name": "hclge_comm_tqp_stats.c",
  "hash_id": "3241f3f1bf6a240d2f83514c9d6124007b34f7e3b8a176643e79a7b10d29798b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/hisilicon/hns3/hns3_common/hclge_comm_tqp_stats.c",
  "human_readable_source": "\n\n\n#include <linux/err.h>\n\n#include \"hnae3.h\"\n#include \"hclge_comm_cmd.h\"\n#include \"hclge_comm_tqp_stats.h\"\n\nu64 *hclge_comm_tqps_get_stats(struct hnae3_handle *handle, u64 *data)\n{\n\tstruct hnae3_knic_private_info *kinfo = &handle->kinfo;\n\tstruct hclge_comm_tqp *tqp;\n\tu64 *buff = data;\n\tu16 i;\n\n\tfor (i = 0; i < kinfo->num_tqps; i++) {\n\t\ttqp = container_of(kinfo->tqp[i], struct hclge_comm_tqp, q);\n\t\t*buff++ = tqp->tqp_stats.rcb_tx_ring_pktnum_rcd;\n\t}\n\n\tfor (i = 0; i < kinfo->num_tqps; i++) {\n\t\ttqp = container_of(kinfo->tqp[i], struct hclge_comm_tqp, q);\n\t\t*buff++ = tqp->tqp_stats.rcb_rx_ring_pktnum_rcd;\n\t}\n\n\treturn buff;\n}\n\nint hclge_comm_tqps_get_sset_count(struct hnae3_handle *handle)\n{\n\tstruct hnae3_knic_private_info *kinfo = &handle->kinfo;\n\n\treturn kinfo->num_tqps * HCLGE_COMM_QUEUE_PAIR_SIZE;\n}\n\nu8 *hclge_comm_tqps_get_strings(struct hnae3_handle *handle, u8 *data)\n{\n\tstruct hnae3_knic_private_info *kinfo = &handle->kinfo;\n\tu8 *buff = data;\n\tu16 i;\n\n\tfor (i = 0; i < kinfo->num_tqps; i++) {\n\t\tstruct hclge_comm_tqp *tqp =\n\t\t\tcontainer_of(kinfo->tqp[i], struct hclge_comm_tqp, q);\n\t\tsnprintf(buff, ETH_GSTRING_LEN, \"txq%u_pktnum_rcd\", tqp->index);\n\t\tbuff += ETH_GSTRING_LEN;\n\t}\n\n\tfor (i = 0; i < kinfo->num_tqps; i++) {\n\t\tstruct hclge_comm_tqp *tqp =\n\t\t\tcontainer_of(kinfo->tqp[i], struct hclge_comm_tqp, q);\n\t\tsnprintf(buff, ETH_GSTRING_LEN, \"rxq%u_pktnum_rcd\", tqp->index);\n\t\tbuff += ETH_GSTRING_LEN;\n\t}\n\n\treturn buff;\n}\n\nint hclge_comm_tqps_update_stats(struct hnae3_handle *handle,\n\t\t\t\t struct hclge_comm_hw *hw)\n{\n\tstruct hnae3_knic_private_info *kinfo = &handle->kinfo;\n\tstruct hclge_comm_tqp *tqp;\n\tstruct hclge_desc desc;\n\tint ret;\n\tu16 i;\n\n\tfor (i = 0; i < kinfo->num_tqps; i++) {\n\t\ttqp = container_of(kinfo->tqp[i], struct hclge_comm_tqp, q);\n\t\thclge_comm_cmd_setup_basic_desc(&desc, HCLGE_OPC_QUERY_RX_STATS,\n\t\t\t\t\t\ttrue);\n\n\t\tdesc.data[0] = cpu_to_le32(tqp->index);\n\t\tret = hclge_comm_cmd_send(hw, &desc, 1);\n\t\tif (ret) {\n\t\t\tdev_err(&hw->cmq.csq.pdev->dev,\n\t\t\t\t\"failed to get tqp stat, ret = %d, rx = %u.\\n\",\n\t\t\t\tret, i);\n\t\t\treturn ret;\n\t\t}\n\t\ttqp->tqp_stats.rcb_rx_ring_pktnum_rcd +=\n\t\t\tle32_to_cpu(desc.data[1]);\n\n\t\thclge_comm_cmd_setup_basic_desc(&desc, HCLGE_OPC_QUERY_TX_STATS,\n\t\t\t\t\t\ttrue);\n\n\t\tdesc.data[0] = cpu_to_le32(tqp->index & 0x1ff);\n\t\tret = hclge_comm_cmd_send(hw, &desc, 1);\n\t\tif (ret) {\n\t\t\tdev_err(&hw->cmq.csq.pdev->dev,\n\t\t\t\t\"failed to get tqp stat, ret = %d, tx = %u.\\n\",\n\t\t\t\tret, i);\n\t\t\treturn ret;\n\t\t}\n\t\ttqp->tqp_stats.rcb_tx_ring_pktnum_rcd +=\n\t\t\tle32_to_cpu(desc.data[1]);\n\t}\n\n\treturn 0;\n}\n\nvoid hclge_comm_reset_tqp_stats(struct hnae3_handle *handle)\n{\n\tstruct hnae3_knic_private_info *kinfo = &handle->kinfo;\n\tstruct hclge_comm_tqp *tqp;\n\tstruct hnae3_queue *queue;\n\tu16 i;\n\n\tfor (i = 0; i < kinfo->num_tqps; i++) {\n\t\tqueue = kinfo->tqp[i];\n\t\ttqp = container_of(queue, struct hclge_comm_tqp, q);\n\t\tmemset(&tqp->tqp_stats, 0, sizeof(tqp->tqp_stats));\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}