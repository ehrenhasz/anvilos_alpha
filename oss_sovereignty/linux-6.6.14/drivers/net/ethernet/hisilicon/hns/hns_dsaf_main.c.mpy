{
  "module_name": "hns_dsaf_main.c",
  "hash_id": "b644fceb6ca8c0546cc9f9824b2156c5a7eb756f00167cbec2373a7b81972d76",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/hisilicon/hns/hns_dsaf_main.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/device.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/netdevice.h>\n#include <linux/mfd/syscon.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/of_irq.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n#include <linux/vmalloc.h>\n\n#include \"hns_dsaf_mac.h\"\n#include \"hns_dsaf_main.h\"\n#include \"hns_dsaf_ppe.h\"\n#include \"hns_dsaf_rcb.h\"\n#include \"hns_dsaf_misc.h\"\n\nstatic const char *g_dsaf_mode_match[DSAF_MODE_MAX] = {\n\t[DSAF_MODE_DISABLE_2PORT_64VM] = \"2port-64vf\",\n\t[DSAF_MODE_DISABLE_6PORT_0VM] = \"6port-16rss\",\n\t[DSAF_MODE_DISABLE_6PORT_16VM] = \"6port-16vf\",\n\t[DSAF_MODE_DISABLE_SP] = \"single-port\",\n};\n\nstatic const struct acpi_device_id hns_dsaf_acpi_match[] = {\n\t{ \"HISI00B1\", 0 },\n\t{ \"HISI00B2\", 0 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(acpi, hns_dsaf_acpi_match);\n\nstatic int hns_dsaf_get_cfg(struct dsaf_device *dsaf_dev)\n{\n\tint ret, i;\n\tu32 desc_num;\n\tu32 buf_size;\n\tu32 reset_offset = 0;\n\tu32 res_idx = 0;\n\tconst char *mode_str;\n\tstruct regmap *syscon;\n\tstruct resource *res;\n\tstruct device_node *np = dsaf_dev->dev->of_node, *np_temp;\n\tstruct platform_device *pdev = to_platform_device(dsaf_dev->dev);\n\n\tif (dev_of_node(dsaf_dev->dev)) {\n\t\tif (of_device_is_compatible(np, \"hisilicon,hns-dsaf-v1\"))\n\t\t\tdsaf_dev->dsaf_ver = AE_VERSION_1;\n\t\telse\n\t\t\tdsaf_dev->dsaf_ver = AE_VERSION_2;\n\t} else if (is_acpi_node(dsaf_dev->dev->fwnode)) {\n\t\tif (acpi_dev_found(hns_dsaf_acpi_match[0].id))\n\t\t\tdsaf_dev->dsaf_ver = AE_VERSION_1;\n\t\telse if (acpi_dev_found(hns_dsaf_acpi_match[1].id))\n\t\t\tdsaf_dev->dsaf_ver = AE_VERSION_2;\n\t\telse\n\t\t\treturn -ENXIO;\n\t} else {\n\t\tdev_err(dsaf_dev->dev, \"cannot get cfg data from of or acpi\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\tret = device_property_read_string(dsaf_dev->dev, \"mode\", &mode_str);\n\tif (ret) {\n\t\tdev_err(dsaf_dev->dev, \"get dsaf mode fail, ret=%d!\\n\", ret);\n\t\treturn ret;\n\t}\n\tfor (i = 0; i < DSAF_MODE_MAX; i++) {\n\t\tif (g_dsaf_mode_match[i] &&\n\t\t    !strcmp(mode_str, g_dsaf_mode_match[i]))\n\t\t\tbreak;\n\t}\n\tif (i >= DSAF_MODE_MAX ||\n\t    i == DSAF_MODE_INVALID || i == DSAF_MODE_ENABLE) {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"%s prs mode str fail!\\n\", dsaf_dev->ae_dev.name);\n\t\treturn -EINVAL;\n\t}\n\tdsaf_dev->dsaf_mode = (enum dsaf_mode)i;\n\n\tif (dsaf_dev->dsaf_mode > DSAF_MODE_ENABLE)\n\t\tdsaf_dev->dsaf_en = HRD_DSAF_NO_DSAF_MODE;\n\telse\n\t\tdsaf_dev->dsaf_en = HRD_DSAF_MODE;\n\n\tif ((i == DSAF_MODE_ENABLE_16VM) ||\n\t    (i == DSAF_MODE_DISABLE_2PORT_8VM) ||\n\t    (i == DSAF_MODE_DISABLE_6PORT_2VM))\n\t\tdsaf_dev->dsaf_tc_mode = HRD_DSAF_8TC_MODE;\n\telse\n\t\tdsaf_dev->dsaf_tc_mode = HRD_DSAF_4TC_MODE;\n\n\tif (dev_of_node(dsaf_dev->dev)) {\n\t\tnp_temp = of_parse_phandle(np, \"subctrl-syscon\", 0);\n\t\tsyscon = syscon_node_to_regmap(np_temp);\n\t\tof_node_put(np_temp);\n\t\tif (IS_ERR_OR_NULL(syscon)) {\n\t\t\tres = platform_get_resource(pdev, IORESOURCE_MEM,\n\t\t\t\t\t\t    res_idx++);\n\t\t\tif (!res) {\n\t\t\t\tdev_err(dsaf_dev->dev, \"subctrl info is needed!\\n\");\n\t\t\t\treturn -ENOMEM;\n\t\t\t}\n\n\t\t\tdsaf_dev->sc_base = devm_ioremap_resource(&pdev->dev,\n\t\t\t\t\t\t\t\t  res);\n\t\t\tif (IS_ERR(dsaf_dev->sc_base))\n\t\t\t\treturn PTR_ERR(dsaf_dev->sc_base);\n\n\t\t\tres = platform_get_resource(pdev, IORESOURCE_MEM,\n\t\t\t\t\t\t    res_idx++);\n\t\t\tif (!res) {\n\t\t\t\tdev_err(dsaf_dev->dev, \"serdes-ctrl info is needed!\\n\");\n\t\t\t\treturn -ENOMEM;\n\t\t\t}\n\n\t\t\tdsaf_dev->sds_base = devm_ioremap_resource(&pdev->dev,\n\t\t\t\t\t\t\t\t   res);\n\t\t\tif (IS_ERR(dsaf_dev->sds_base))\n\t\t\t\treturn PTR_ERR(dsaf_dev->sds_base);\n\t\t} else {\n\t\t\tdsaf_dev->sub_ctrl = syscon;\n\t\t}\n\t}\n\n\tres = platform_get_resource_byname(pdev, IORESOURCE_MEM, \"ppe-base\");\n\tif (!res) {\n\t\tres = platform_get_resource(pdev, IORESOURCE_MEM, res_idx++);\n\t\tif (!res) {\n\t\t\tdev_err(dsaf_dev->dev, \"ppe-base info is needed!\\n\");\n\t\t\treturn -ENOMEM;\n\t\t}\n\t}\n\tdsaf_dev->ppe_base = devm_ioremap_resource(&pdev->dev, res);\n\tif (IS_ERR(dsaf_dev->ppe_base))\n\t\treturn PTR_ERR(dsaf_dev->ppe_base);\n\tdsaf_dev->ppe_paddr = res->start;\n\n\tif (!HNS_DSAF_IS_DEBUG(dsaf_dev)) {\n\t\tres = platform_get_resource_byname(pdev, IORESOURCE_MEM,\n\t\t\t\t\t\t   \"dsaf-base\");\n\t\tif (!res) {\n\t\t\tres = platform_get_resource(pdev, IORESOURCE_MEM,\n\t\t\t\t\t\t    res_idx);\n\t\t\tif (!res) {\n\t\t\t\tdev_err(dsaf_dev->dev,\n\t\t\t\t\t\"dsaf-base info is needed!\\n\");\n\t\t\t\treturn -ENOMEM;\n\t\t\t}\n\t\t}\n\t\tdsaf_dev->io_base = devm_ioremap_resource(&pdev->dev, res);\n\t\tif (IS_ERR(dsaf_dev->io_base))\n\t\t\treturn PTR_ERR(dsaf_dev->io_base);\n\t}\n\n\tret = device_property_read_u32(dsaf_dev->dev, \"desc-num\", &desc_num);\n\tif (ret < 0 || desc_num < HNS_DSAF_MIN_DESC_CNT ||\n\t    desc_num > HNS_DSAF_MAX_DESC_CNT) {\n\t\tdev_err(dsaf_dev->dev, \"get desc-num(%d) fail, ret=%d!\\n\",\n\t\t\tdesc_num, ret);\n\t\treturn -EINVAL;\n\t}\n\tdsaf_dev->desc_num = desc_num;\n\n\tret = device_property_read_u32(dsaf_dev->dev, \"reset-field-offset\",\n\t\t\t\t       &reset_offset);\n\tif (ret < 0) {\n\t\tdev_dbg(dsaf_dev->dev,\n\t\t\t\"get reset-field-offset fail, ret=%d!\\r\\n\", ret);\n\t}\n\tdsaf_dev->reset_offset = reset_offset;\n\n\tret = device_property_read_u32(dsaf_dev->dev, \"buf-size\", &buf_size);\n\tif (ret < 0) {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"get buf-size fail, ret=%d!\\r\\n\", ret);\n\t\treturn ret;\n\t}\n\tdsaf_dev->buf_size = buf_size;\n\n\tdsaf_dev->buf_size_type = hns_rcb_buf_size2type(buf_size);\n\tif (dsaf_dev->buf_size_type < 0) {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"buf_size(%d) is wrong!\\n\", buf_size);\n\t\treturn -EINVAL;\n\t}\n\n\tdsaf_dev->misc_op = hns_misc_op_get(dsaf_dev);\n\tif (!dsaf_dev->misc_op)\n\t\treturn -ENOMEM;\n\n\tif (!dma_set_mask_and_coherent(dsaf_dev->dev, DMA_BIT_MASK(64ULL)))\n\t\tdev_dbg(dsaf_dev->dev, \"set mask to 64bit\\n\");\n\telse\n\t\tdev_err(dsaf_dev->dev, \"set mask to 64bit fail!\\n\");\n\n\treturn 0;\n}\n\n \nstatic void hns_dsaf_sbm_link_sram_init_en(struct dsaf_device *dsaf_dev)\n{\n\tdsaf_set_dev_bit(dsaf_dev, DSAF_CFG_0_REG, DSAF_CFG_SBM_INIT_S, 1);\n}\n\n \nstatic void\nhns_dsaf_reg_cnt_clr_ce(struct dsaf_device *dsaf_dev, u32 reg_cnt_clr_ce)\n{\n\tdsaf_set_dev_bit(dsaf_dev, DSAF_DSA_REG_CNT_CLR_CE_REG,\n\t\t\t DSAF_CNT_CLR_CE_S, reg_cnt_clr_ce);\n}\n\n \nstatic void\nhns_dsaf_ppe_qid_cfg(struct dsaf_device *dsaf_dev, u32 qid_cfg)\n{\n\tu32 i;\n\n\tfor (i = 0; i < DSAF_COMM_CHN; i++) {\n\t\tdsaf_set_dev_field(dsaf_dev,\n\t\t\t\t   DSAF_PPE_QID_CFG_0_REG + 0x0004 * i,\n\t\t\t\t   DSAF_PPE_QID_CFG_M, DSAF_PPE_QID_CFG_S,\n\t\t\t\t   qid_cfg);\n\t}\n}\n\nstatic void hns_dsaf_mix_def_qid_cfg(struct dsaf_device *dsaf_dev)\n{\n\tu16 max_q_per_vf, max_vfn;\n\tu32 q_id, q_num_per_port;\n\tu32 i;\n\n\thns_rcb_get_queue_mode(dsaf_dev->dsaf_mode, &max_vfn, &max_q_per_vf);\n\tq_num_per_port = max_vfn * max_q_per_vf;\n\n\tfor (i = 0, q_id = 0; i < DSAF_SERVICE_NW_NUM; i++) {\n\t\tdsaf_set_dev_field(dsaf_dev,\n\t\t\t\t   DSAF_MIX_DEF_QID_0_REG + 0x0004 * i,\n\t\t\t\t   0xff, 0, q_id);\n\t\tq_id += q_num_per_port;\n\t}\n}\n\nstatic void hns_dsaf_inner_qid_cfg(struct dsaf_device *dsaf_dev)\n{\n\tu16 max_q_per_vf, max_vfn;\n\tu32 q_id, q_num_per_port;\n\tu32 mac_id;\n\n\tif (AE_IS_VER1(dsaf_dev->dsaf_ver))\n\t\treturn;\n\n\thns_rcb_get_queue_mode(dsaf_dev->dsaf_mode, &max_vfn, &max_q_per_vf);\n\tq_num_per_port = max_vfn * max_q_per_vf;\n\n\tfor (mac_id = 0, q_id = 0; mac_id < DSAF_SERVICE_NW_NUM; mac_id++) {\n\t\tdsaf_set_dev_field(dsaf_dev,\n\t\t\t\t   DSAFV2_SERDES_LBK_0_REG + 4 * mac_id,\n\t\t\t\t   DSAFV2_SERDES_LBK_QID_M,\n\t\t\t\t   DSAFV2_SERDES_LBK_QID_S,\n\t\t\t\t   q_id);\n\t\tq_id += q_num_per_port;\n\t}\n}\n\n \nstatic void hns_dsaf_sw_port_type_cfg(struct dsaf_device *dsaf_dev,\n\t\t\t\t      enum dsaf_sw_port_type port_type)\n{\n\tu32 i;\n\n\tfor (i = 0; i < DSAF_SW_PORT_NUM; i++) {\n\t\tdsaf_set_dev_field(dsaf_dev,\n\t\t\t\t   DSAF_SW_PORT_TYPE_0_REG + 0x0004 * i,\n\t\t\t\t   DSAF_SW_PORT_TYPE_M, DSAF_SW_PORT_TYPE_S,\n\t\t\t\t   port_type);\n\t}\n}\n\n \nstatic void hns_dsaf_stp_port_type_cfg(struct dsaf_device *dsaf_dev,\n\t\t\t\t       enum dsaf_stp_port_type port_type)\n{\n\tu32 i;\n\n\tfor (i = 0; i < DSAF_COMM_CHN; i++) {\n\t\tdsaf_set_dev_field(dsaf_dev,\n\t\t\t\t   DSAF_STP_PORT_TYPE_0_REG + 0x0004 * i,\n\t\t\t\t   DSAF_STP_PORT_TYPE_M, DSAF_STP_PORT_TYPE_S,\n\t\t\t\t   port_type);\n\t}\n}\n\n#define HNS_DSAF_SBM_NUM(dev) \\\n\t(AE_IS_VER1((dev)->dsaf_ver) ? DSAF_SBM_NUM : DSAFV2_SBM_NUM)\n \nstatic void hns_dsaf_sbm_cfg(struct dsaf_device *dsaf_dev)\n{\n\tu32 o_sbm_cfg;\n\tu32 i;\n\n\tfor (i = 0; i < HNS_DSAF_SBM_NUM(dsaf_dev); i++) {\n\t\to_sbm_cfg = dsaf_read_dev(dsaf_dev,\n\t\t\t\t\t  DSAF_SBM_CFG_REG_0_REG + 0x80 * i);\n\t\tdsaf_set_bit(o_sbm_cfg, DSAF_SBM_CFG_EN_S, 1);\n\t\tdsaf_set_bit(o_sbm_cfg, DSAF_SBM_CFG_SHCUT_EN_S, 0);\n\t\tdsaf_write_dev(dsaf_dev,\n\t\t\t       DSAF_SBM_CFG_REG_0_REG + 0x80 * i, o_sbm_cfg);\n\t}\n}\n\n \nstatic int hns_dsaf_sbm_cfg_mib_en(struct dsaf_device *dsaf_dev)\n{\n\tu32 sbm_cfg_mib_en;\n\tu32 i;\n\tu32 reg;\n\tu32 read_cnt;\n\n\t \n\tfor (i = 0; i < HNS_DSAF_SBM_NUM(dsaf_dev); i++) {\n\t\treg = DSAF_SBM_CFG_REG_0_REG + 0x80 * i;\n\t\tdsaf_set_dev_bit(dsaf_dev, reg, DSAF_SBM_CFG_MIB_EN_S, 0);\n\t}\n\n\tfor (i = 0; i < HNS_DSAF_SBM_NUM(dsaf_dev); i++) {\n\t\treg = DSAF_SBM_CFG_REG_0_REG + 0x80 * i;\n\t\tdsaf_set_dev_bit(dsaf_dev, reg, DSAF_SBM_CFG_MIB_EN_S, 1);\n\t}\n\n\t \n\tfor (i = 0; i < HNS_DSAF_SBM_NUM(dsaf_dev); i++) {\n\t\tread_cnt = 0;\n\t\treg = DSAF_SBM_CFG_REG_0_REG + 0x80 * i;\n\t\tdo {\n\t\t\tudelay(1);\n\t\t\tsbm_cfg_mib_en = dsaf_get_dev_bit(\n\t\t\t\t\tdsaf_dev, reg, DSAF_SBM_CFG_MIB_EN_S);\n\t\t\tread_cnt++;\n\t\t} while (sbm_cfg_mib_en == 0 &&\n\t\t\tread_cnt < DSAF_CFG_READ_CNT);\n\n\t\tif (sbm_cfg_mib_en == 0) {\n\t\t\tdev_err(dsaf_dev->dev,\n\t\t\t\t\"sbm_cfg_mib_en fail,%s,sbm_num=%d\\n\",\n\t\t\t\tdsaf_dev->ae_dev.name, i);\n\t\t\treturn -ENODEV;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n \nstatic void hns_dsaf_sbm_bp_wl_cfg(struct dsaf_device *dsaf_dev)\n{\n\tu32 o_sbm_bp_cfg;\n\tu32 reg;\n\tu32 i;\n\n\t \n\tfor (i = 0; i < DSAF_XGE_NUM; i++) {\n\t\treg = DSAF_SBM_BP_CFG_0_XGE_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG0_COM_MAX_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG0_COM_MAX_BUF_NUM_S, 512);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG0_VC0_MAX_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG0_VC0_MAX_BUF_NUM_S, 0);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG0_VC1_MAX_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG0_VC1_MAX_BUF_NUM_S, 0);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\n\t\treg = DSAF_SBM_BP_CFG_1_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG1_TC4_MAX_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG1_TC4_MAX_BUF_NUM_S, 0);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG1_TC0_MAX_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG1_TC0_MAX_BUF_NUM_S, 0);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\n\t\treg = DSAF_SBM_BP_CFG_2_XGE_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_SET_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG2_SET_BUF_NUM_S, 104);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_RESET_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG2_RESET_BUF_NUM_S, 128);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\n\t\treg = DSAF_SBM_BP_CFG_3_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAF_SBM_CFG3_SET_BUF_NUM_NO_PFC_M,\n\t\t\t       DSAF_SBM_CFG3_SET_BUF_NUM_NO_PFC_S, 110);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAF_SBM_CFG3_RESET_BUF_NUM_NO_PFC_M,\n\t\t\t       DSAF_SBM_CFG3_RESET_BUF_NUM_NO_PFC_S, 160);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\n\t\t \n\t\treg = DSAF_SBM_BP_CFG_4_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAF_SBM_CFG3_SET_BUF_NUM_NO_PFC_M,\n\t\t\t       DSAF_SBM_CFG3_SET_BUF_NUM_NO_PFC_S, 128);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAF_SBM_CFG3_RESET_BUF_NUM_NO_PFC_M,\n\t\t\t       DSAF_SBM_CFG3_RESET_BUF_NUM_NO_PFC_S, 192);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\t}\n\n\t \n\tfor (i = 0; i < DSAF_COMM_CHN; i++) {\n\t\treg = DSAF_SBM_BP_CFG_2_PPE_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_SET_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG2_SET_BUF_NUM_S, 10);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_RESET_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG2_RESET_BUF_NUM_S, 12);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\t}\n\n\t \n\tfor (i = 0; i < DSAF_COMM_CHN; i++) {\n\t\treg = DSAF_SBM_BP_CFG_2_ROCEE_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_SET_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG2_SET_BUF_NUM_S, 2);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAF_SBM_CFG2_RESET_BUF_NUM_M,\n\t\t\t       DSAF_SBM_CFG2_RESET_BUF_NUM_S, 4);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\t}\n}\n\nstatic void hns_dsafv2_sbm_bp_wl_cfg(struct dsaf_device *dsaf_dev)\n{\n\tu32 o_sbm_bp_cfg;\n\tu32 reg;\n\tu32 i;\n\n\t \n\tfor (i = 0; i < DSAFV2_SBM_XGE_CHN; i++) {\n\t\treg = DSAF_SBM_BP_CFG_0_XGE_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG0_COM_MAX_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG0_COM_MAX_BUF_NUM_S, 256);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG0_VC0_MAX_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG0_VC0_MAX_BUF_NUM_S, 0);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG0_VC1_MAX_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG0_VC1_MAX_BUF_NUM_S, 0);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\n\t\treg = DSAF_SBM_BP_CFG_1_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG1_TC4_MAX_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG1_TC4_MAX_BUF_NUM_S, 0);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG1_TC0_MAX_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG1_TC0_MAX_BUF_NUM_S, 0);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\n\t\treg = DSAF_SBM_BP_CFG_2_XGE_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG2_SET_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG2_SET_BUF_NUM_S, 104);\n\t\tdsaf_set_field(o_sbm_bp_cfg, DSAFV2_SBM_CFG2_RESET_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG2_RESET_BUF_NUM_S, 128);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\n\t\treg = DSAF_SBM_BP_CFG_3_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAFV2_SBM_CFG3_SET_BUF_NUM_NO_PFC_M,\n\t\t\t       DSAFV2_SBM_CFG3_SET_BUF_NUM_NO_PFC_S, 55);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAFV2_SBM_CFG3_RESET_BUF_NUM_NO_PFC_M,\n\t\t\t       DSAFV2_SBM_CFG3_RESET_BUF_NUM_NO_PFC_S, 110);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\n\t\t \n\t\treg = DSAF_SBM_BP_CFG_4_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAFV2_SBM_CFG4_SET_BUF_NUM_NO_PFC_M,\n\t\t\t       DSAFV2_SBM_CFG4_SET_BUF_NUM_NO_PFC_S, 128);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAFV2_SBM_CFG4_RESET_BUF_NUM_NO_PFC_M,\n\t\t\t       DSAFV2_SBM_CFG4_RESET_BUF_NUM_NO_PFC_S, 192);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\t}\n\n\t \n\tfor (i = 0; i < DSAFV2_SBM_PPE_CHN; i++) {\n\t\treg = DSAF_SBM_BP_CFG_2_PPE_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAFV2_SBM_CFG2_PPE_SET_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG2_PPE_SET_BUF_NUM_S, 2);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAFV2_SBM_CFG2_PPE_RESET_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG2_PPE_RESET_BUF_NUM_S, 3);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAFV2_SBM_CFG2_PPE_CFG_USEFUL_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG2_PPE_CFG_USEFUL_NUM_S, 52);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\t}\n\n\t \n\tfor (i = 0; i < DASFV2_ROCEE_CRD_NUM; i++) {\n\t\treg = DSAFV2_SBM_BP_CFG_2_ROCEE_REG_0_REG + 0x80 * i;\n\t\to_sbm_bp_cfg = dsaf_read_dev(dsaf_dev, reg);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAFV2_SBM_CFG2_ROCEE_SET_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG2_ROCEE_SET_BUF_NUM_S, 2);\n\t\tdsaf_set_field(o_sbm_bp_cfg,\n\t\t\t       DSAFV2_SBM_CFG2_ROCEE_RESET_BUF_NUM_M,\n\t\t\t       DSAFV2_SBM_CFG2_ROCEE_RESET_BUF_NUM_S, 4);\n\t\tdsaf_write_dev(dsaf_dev, reg, o_sbm_bp_cfg);\n\t}\n}\n\n \nstatic void hns_dsaf_voq_bp_all_thrd_cfg(struct dsaf_device *dsaf_dev)\n{\n\tu32 voq_bp_all_thrd;\n\tu32 i;\n\n\tfor (i = 0; i < DSAF_VOQ_NUM; i++) {\n\t\tvoq_bp_all_thrd = dsaf_read_dev(\n\t\t\tdsaf_dev, DSAF_VOQ_BP_ALL_THRD_0_REG + 0x40 * i);\n\t\tif (i < DSAF_XGE_NUM) {\n\t\t\tdsaf_set_field(voq_bp_all_thrd,\n\t\t\t\t       DSAF_VOQ_BP_ALL_DOWNTHRD_M,\n\t\t\t\t       DSAF_VOQ_BP_ALL_DOWNTHRD_S, 930);\n\t\t\tdsaf_set_field(voq_bp_all_thrd,\n\t\t\t\t       DSAF_VOQ_BP_ALL_UPTHRD_M,\n\t\t\t\t       DSAF_VOQ_BP_ALL_UPTHRD_S, 950);\n\t\t} else {\n\t\t\tdsaf_set_field(voq_bp_all_thrd,\n\t\t\t\t       DSAF_VOQ_BP_ALL_DOWNTHRD_M,\n\t\t\t\t       DSAF_VOQ_BP_ALL_DOWNTHRD_S, 220);\n\t\t\tdsaf_set_field(voq_bp_all_thrd,\n\t\t\t\t       DSAF_VOQ_BP_ALL_UPTHRD_M,\n\t\t\t\t       DSAF_VOQ_BP_ALL_UPTHRD_S, 230);\n\t\t}\n\t\tdsaf_write_dev(\n\t\t\tdsaf_dev, DSAF_VOQ_BP_ALL_THRD_0_REG + 0x40 * i,\n\t\t\tvoq_bp_all_thrd);\n\t}\n}\n\nstatic void hns_dsaf_tbl_tcam_match_cfg(\n\tstruct dsaf_device *dsaf_dev,\n\tstruct dsaf_tbl_tcam_data *ptbl_tcam_data)\n{\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MATCH_CFG_L_REG,\n\t\t       ptbl_tcam_data->tbl_tcam_data_low);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MATCH_CFG_H_REG,\n\t\t       ptbl_tcam_data->tbl_tcam_data_high);\n}\n\n \nstatic void hns_dsaf_tbl_tcam_data_cfg(\n\tstruct dsaf_device *dsaf_dev,\n\tstruct dsaf_tbl_tcam_data *ptbl_tcam_data)\n{\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_LOW_0_REG,\n\t\t       ptbl_tcam_data->tbl_tcam_data_low);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_HIGH_0_REG,\n\t\t       ptbl_tcam_data->tbl_tcam_data_high);\n}\n\n \nstatic void hns_dsaf_tbl_tcam_mcast_cfg(\n\tstruct dsaf_device *dsaf_dev,\n\tstruct dsaf_tbl_tcam_mcast_cfg *mcast)\n{\n\tu32 mcast_cfg4;\n\n\tmcast_cfg4 = dsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_4_0_REG);\n\tdsaf_set_bit(mcast_cfg4, DSAF_TBL_MCAST_CFG4_ITEM_VLD_S,\n\t\t     mcast->tbl_mcast_item_vld);\n\tdsaf_set_bit(mcast_cfg4, DSAF_TBL_MCAST_CFG4_OLD_EN_S,\n\t\t     mcast->tbl_mcast_old_en);\n\tdsaf_set_field(mcast_cfg4, DSAF_TBL_MCAST_CFG4_VM128_112_M,\n\t\t       DSAF_TBL_MCAST_CFG4_VM128_112_S,\n\t\t       mcast->tbl_mcast_port_msk[4]);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_4_0_REG, mcast_cfg4);\n\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_3_0_REG,\n\t\t       mcast->tbl_mcast_port_msk[3]);\n\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_2_0_REG,\n\t\t       mcast->tbl_mcast_port_msk[2]);\n\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_1_0_REG,\n\t\t       mcast->tbl_mcast_port_msk[1]);\n\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_0_0_REG,\n\t\t       mcast->tbl_mcast_port_msk[0]);\n}\n\n \nstatic void hns_dsaf_tbl_tcam_ucast_cfg(\n\tstruct dsaf_device *dsaf_dev,\n\tstruct dsaf_tbl_tcam_ucast_cfg *tbl_tcam_ucast)\n{\n\tu32 ucast_cfg1;\n\n\tucast_cfg1 = dsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_UCAST_CFG_0_REG);\n\tdsaf_set_bit(ucast_cfg1, DSAF_TBL_UCAST_CFG1_MAC_DISCARD_S,\n\t\t     tbl_tcam_ucast->tbl_ucast_mac_discard);\n\tdsaf_set_bit(ucast_cfg1, DSAF_TBL_UCAST_CFG1_ITEM_VLD_S,\n\t\t     tbl_tcam_ucast->tbl_ucast_item_vld);\n\tdsaf_set_bit(ucast_cfg1, DSAF_TBL_UCAST_CFG1_OLD_EN_S,\n\t\t     tbl_tcam_ucast->tbl_ucast_old_en);\n\tdsaf_set_bit(ucast_cfg1, DSAF_TBL_UCAST_CFG1_DVC_S,\n\t\t     tbl_tcam_ucast->tbl_ucast_dvc);\n\tdsaf_set_field(ucast_cfg1, DSAF_TBL_UCAST_CFG1_OUT_PORT_M,\n\t\t       DSAF_TBL_UCAST_CFG1_OUT_PORT_S,\n\t\t       tbl_tcam_ucast->tbl_ucast_out_port);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_UCAST_CFG_0_REG, ucast_cfg1);\n}\n\n \nstatic void hns_dsaf_tbl_line_cfg(struct dsaf_device *dsaf_dev,\n\t\t\t\t  struct dsaf_tbl_line_cfg *tbl_lin)\n{\n\tu32 tbl_line;\n\n\ttbl_line = dsaf_read_dev(dsaf_dev, DSAF_TBL_LIN_CFG_0_REG);\n\tdsaf_set_bit(tbl_line, DSAF_TBL_LINE_CFG_MAC_DISCARD_S,\n\t\t     tbl_lin->tbl_line_mac_discard);\n\tdsaf_set_bit(tbl_line, DSAF_TBL_LINE_CFG_DVC_S,\n\t\t     tbl_lin->tbl_line_dvc);\n\tdsaf_set_field(tbl_line, DSAF_TBL_LINE_CFG_OUT_PORT_M,\n\t\t       DSAF_TBL_LINE_CFG_OUT_PORT_S,\n\t\t       tbl_lin->tbl_line_out_port);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_LIN_CFG_0_REG, tbl_line);\n}\n\n \nstatic void hns_dsaf_tbl_tcam_mcast_pul(struct dsaf_device *dsaf_dev)\n{\n\tu32 o_tbl_pul;\n\n\to_tbl_pul = dsaf_read_dev(dsaf_dev, DSAF_TBL_PUL_0_REG);\n\tdsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_MCAST_VLD_S, 1);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\n\tdsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_MCAST_VLD_S, 0);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\n}\n\n \nstatic void hns_dsaf_tbl_line_pul(struct dsaf_device *dsaf_dev)\n{\n\tu32 tbl_pul;\n\n\ttbl_pul = dsaf_read_dev(dsaf_dev, DSAF_TBL_PUL_0_REG);\n\tdsaf_set_bit(tbl_pul, DSAF_TBL_PUL_LINE_VLD_S, 1);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, tbl_pul);\n\tdsaf_set_bit(tbl_pul, DSAF_TBL_PUL_LINE_VLD_S, 0);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, tbl_pul);\n}\n\n \nstatic void hns_dsaf_tbl_tcam_data_mcast_pul(\n\tstruct dsaf_device *dsaf_dev)\n{\n\tu32 o_tbl_pul;\n\n\to_tbl_pul = dsaf_read_dev(dsaf_dev, DSAF_TBL_PUL_0_REG);\n\tdsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_TCAM_DATA_VLD_S, 1);\n\tdsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_MCAST_VLD_S, 1);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\n\tdsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_TCAM_DATA_VLD_S, 0);\n\tdsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_MCAST_VLD_S, 0);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\n}\n\n \nstatic void hns_dsaf_tbl_tcam_data_ucast_pul(\n\tstruct dsaf_device *dsaf_dev)\n{\n\tu32 o_tbl_pul;\n\n\to_tbl_pul = dsaf_read_dev(dsaf_dev, DSAF_TBL_PUL_0_REG);\n\tdsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_TCAM_DATA_VLD_S, 1);\n\tdsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_UCAST_VLD_S, 1);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\n\tdsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_TCAM_DATA_VLD_S, 0);\n\tdsaf_set_bit(o_tbl_pul, DSAF_TBL_PUL_UCAST_VLD_S, 0);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_PUL_0_REG, o_tbl_pul);\n}\n\nvoid hns_dsaf_set_promisc_mode(struct dsaf_device *dsaf_dev, u32 en)\n{\n\tif (AE_IS_VER1(dsaf_dev->dsaf_ver) && !HNS_DSAF_IS_DEBUG(dsaf_dev))\n\t\tdsaf_set_dev_bit(dsaf_dev, DSAF_CFG_0_REG,\n\t\t\t\t DSAF_CFG_MIX_MODE_S, !!en);\n}\n\n \nstatic void hns_dsaf_tbl_stat_en(struct dsaf_device *dsaf_dev)\n{\n\tu32 o_tbl_ctrl;\n\n\to_tbl_ctrl = dsaf_read_dev(dsaf_dev, DSAF_TBL_DFX_CTRL_0_REG);\n\tdsaf_set_bit(o_tbl_ctrl, DSAF_TBL_DFX_LINE_LKUP_NUM_EN_S, 1);\n\tdsaf_set_bit(o_tbl_ctrl, DSAF_TBL_DFX_UC_LKUP_NUM_EN_S, 1);\n\tdsaf_set_bit(o_tbl_ctrl, DSAF_TBL_DFX_MC_LKUP_NUM_EN_S, 1);\n\tdsaf_set_bit(o_tbl_ctrl, DSAF_TBL_DFX_BC_LKUP_NUM_EN_S, 1);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_DFX_CTRL_0_REG, o_tbl_ctrl);\n}\n\n \nstatic void hns_dsaf_rocee_bp_en(struct dsaf_device *dsaf_dev)\n{\n\tif (AE_IS_VER1(dsaf_dev->dsaf_ver))\n\t\tdsaf_set_dev_bit(dsaf_dev, DSAF_XGE_CTRL_SIG_CFG_0_REG,\n\t\t\t\t DSAF_FC_XGE_TX_PAUSE_S, 1);\n}\n\n \nstatic void hns_dsaf_int_xge_msk_set(struct dsaf_device *dsaf_dev,\n\t\t\t\t     u32 chnn_num, u32 mask_set)\n{\n\tdsaf_write_dev(dsaf_dev,\n\t\t       DSAF_XGE_INT_MSK_0_REG + 0x4 * chnn_num, mask_set);\n}\n\nstatic void hns_dsaf_int_ppe_msk_set(struct dsaf_device *dsaf_dev,\n\t\t\t\t     u32 chnn_num, u32 msk_set)\n{\n\tdsaf_write_dev(dsaf_dev,\n\t\t       DSAF_PPE_INT_MSK_0_REG + 0x4 * chnn_num, msk_set);\n}\n\nstatic void hns_dsaf_int_rocee_msk_set(struct dsaf_device *dsaf_dev,\n\t\t\t\t       u32 chnn, u32 msk_set)\n{\n\tdsaf_write_dev(dsaf_dev,\n\t\t       DSAF_ROCEE_INT_MSK_0_REG + 0x4 * chnn, msk_set);\n}\n\nstatic void\nhns_dsaf_int_tbl_msk_set(struct dsaf_device *dsaf_dev, u32 msk_set)\n{\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_INT_MSK_0_REG, msk_set);\n}\n\n \nstatic void hns_dsaf_int_xge_src_clr(struct dsaf_device *dsaf_dev,\n\t\t\t\t     u32 chnn_num, u32 int_src)\n{\n\tdsaf_write_dev(dsaf_dev,\n\t\t       DSAF_XGE_INT_SRC_0_REG + 0x4 * chnn_num, int_src);\n}\n\nstatic void hns_dsaf_int_ppe_src_clr(struct dsaf_device *dsaf_dev,\n\t\t\t\t     u32 chnn, u32 int_src)\n{\n\tdsaf_write_dev(dsaf_dev,\n\t\t       DSAF_PPE_INT_SRC_0_REG + 0x4 * chnn, int_src);\n}\n\nstatic void hns_dsaf_int_rocee_src_clr(struct dsaf_device *dsaf_dev,\n\t\t\t\t       u32 chnn, u32 int_src)\n{\n\tdsaf_write_dev(dsaf_dev,\n\t\t       DSAF_ROCEE_INT_SRC_0_REG + 0x4 * chnn, int_src);\n}\n\nstatic void hns_dsaf_int_tbl_src_clr(struct dsaf_device *dsaf_dev,\n\t\t\t\t     u32 int_src)\n{\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_INT_SRC_0_REG, int_src);\n}\n\n \nstatic void hns_dsaf_single_line_tbl_cfg(\n\tstruct dsaf_device *dsaf_dev,\n\tu32 address, struct dsaf_tbl_line_cfg *ptbl_line)\n{\n\tspin_lock_bh(&dsaf_dev->tcam_lock);\n\n\t \n\thns_dsaf_tbl_line_addr_cfg(dsaf_dev, address);\n\n\t \n\thns_dsaf_tbl_line_cfg(dsaf_dev, ptbl_line);\n\n\t \n\thns_dsaf_tbl_line_pul(dsaf_dev);\n\n\tspin_unlock_bh(&dsaf_dev->tcam_lock);\n}\n\n \nstatic void hns_dsaf_tcam_uc_cfg(\n\tstruct dsaf_device *dsaf_dev, u32 address,\n\tstruct dsaf_tbl_tcam_data *ptbl_tcam_data,\n\tstruct dsaf_tbl_tcam_ucast_cfg *ptbl_tcam_ucast)\n{\n\tspin_lock_bh(&dsaf_dev->tcam_lock);\n\n\t \n\thns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\n\t \n\thns_dsaf_tbl_tcam_data_cfg(dsaf_dev, ptbl_tcam_data);\n\t \n\thns_dsaf_tbl_tcam_ucast_cfg(dsaf_dev, ptbl_tcam_ucast);\n\t \n\thns_dsaf_tbl_tcam_data_ucast_pul(dsaf_dev);\n\n\tspin_unlock_bh(&dsaf_dev->tcam_lock);\n}\n\n \nstatic void hns_dsaf_tcam_mc_cfg(\n\tstruct dsaf_device *dsaf_dev, u32 address,\n\tstruct dsaf_tbl_tcam_data *ptbl_tcam_data,\n\tstruct dsaf_tbl_tcam_data *ptbl_tcam_mask,\n\tstruct dsaf_tbl_tcam_mcast_cfg *ptbl_tcam_mcast)\n{\n\tspin_lock_bh(&dsaf_dev->tcam_lock);\n\n\t \n\thns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\n\t \n\thns_dsaf_tbl_tcam_data_cfg(dsaf_dev, ptbl_tcam_data);\n\t \n\thns_dsaf_tbl_tcam_mcast_cfg(dsaf_dev, ptbl_tcam_mcast);\n\t \n\tif (ptbl_tcam_mask)\n\t\thns_dsaf_tbl_tcam_match_cfg(dsaf_dev, ptbl_tcam_mask);\n\n\t \n\thns_dsaf_tbl_tcam_data_mcast_pul(dsaf_dev);\n\n\tspin_unlock_bh(&dsaf_dev->tcam_lock);\n}\n\n \nstatic void hns_dsaf_tcam_uc_cfg_vague(struct dsaf_device *dsaf_dev,\n\t\t\t\t       u32 address,\n\t\t\t\t       struct dsaf_tbl_tcam_data *tcam_data,\n\t\t\t\t       struct dsaf_tbl_tcam_data *tcam_mask,\n\t\t\t\t       struct dsaf_tbl_tcam_ucast_cfg *tcam_uc)\n{\n\tspin_lock_bh(&dsaf_dev->tcam_lock);\n\thns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\n\thns_dsaf_tbl_tcam_data_cfg(dsaf_dev, tcam_data);\n\thns_dsaf_tbl_tcam_ucast_cfg(dsaf_dev, tcam_uc);\n\thns_dsaf_tbl_tcam_match_cfg(dsaf_dev, tcam_mask);\n\thns_dsaf_tbl_tcam_data_ucast_pul(dsaf_dev);\n\n\t \n\ttcam_mask->tbl_tcam_data_high = 0xffffffff;\n\ttcam_mask->tbl_tcam_data_low = 0xffffffff;\n\thns_dsaf_tbl_tcam_match_cfg(dsaf_dev, tcam_mask);\n\n\tspin_unlock_bh(&dsaf_dev->tcam_lock);\n}\n\n \nstatic void hns_dsaf_tcam_mc_cfg_vague(struct dsaf_device *dsaf_dev,\n\t\t\t\t       u32 address,\n\t\t\t\t       struct dsaf_tbl_tcam_data *tcam_data,\n\t\t\t\t       struct dsaf_tbl_tcam_data *tcam_mask,\n\t\t\t\t       struct dsaf_tbl_tcam_mcast_cfg *tcam_mc)\n{\n\tspin_lock_bh(&dsaf_dev->tcam_lock);\n\thns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\n\thns_dsaf_tbl_tcam_data_cfg(dsaf_dev, tcam_data);\n\thns_dsaf_tbl_tcam_mcast_cfg(dsaf_dev, tcam_mc);\n\thns_dsaf_tbl_tcam_match_cfg(dsaf_dev, tcam_mask);\n\thns_dsaf_tbl_tcam_data_mcast_pul(dsaf_dev);\n\n\t \n\ttcam_mask->tbl_tcam_data_high = 0xffffffff;\n\ttcam_mask->tbl_tcam_data_low = 0xffffffff;\n\thns_dsaf_tbl_tcam_match_cfg(dsaf_dev, tcam_mask);\n\n\tspin_unlock_bh(&dsaf_dev->tcam_lock);\n}\n\n \nstatic void hns_dsaf_tcam_mc_invld(struct dsaf_device *dsaf_dev, u32 address)\n{\n\tspin_lock_bh(&dsaf_dev->tcam_lock);\n\n\t \n\thns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\n\n\t \n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_0_0_REG, 0);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_1_0_REG, 0);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_2_0_REG, 0);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_3_0_REG, 0);\n\tdsaf_write_dev(dsaf_dev, DSAF_TBL_TCAM_MCAST_CFG_4_0_REG, 0);\n\n\t \n\thns_dsaf_tbl_tcam_mcast_pul(dsaf_dev);\n\n\tspin_unlock_bh(&dsaf_dev->tcam_lock);\n}\n\nstatic void\nhns_dsaf_tcam_addr_get(struct dsaf_drv_tbl_tcam_key *mac_key, u8 *addr)\n{\n\taddr[0] = mac_key->high.bits.mac_0;\n\taddr[1] = mac_key->high.bits.mac_1;\n\taddr[2] = mac_key->high.bits.mac_2;\n\taddr[3] = mac_key->high.bits.mac_3;\n\taddr[4] = mac_key->low.bits.mac_4;\n\taddr[5] = mac_key->low.bits.mac_5;\n}\n\n \nstatic void hns_dsaf_tcam_uc_get(\n\tstruct dsaf_device *dsaf_dev, u32 address,\n\tstruct dsaf_tbl_tcam_data *ptbl_tcam_data,\n\tstruct dsaf_tbl_tcam_ucast_cfg *ptbl_tcam_ucast)\n{\n\tu32 tcam_read_data0;\n\tu32 tcam_read_data4;\n\n\tspin_lock_bh(&dsaf_dev->tcam_lock);\n\n\t \n\thns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\n\n\t \n\thns_dsaf_tbl_tcam_load_pul(dsaf_dev);\n\n\t \n\tptbl_tcam_data->tbl_tcam_data_high\n\t\t= dsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RDATA_HIGH_0_REG);\n\tptbl_tcam_data->tbl_tcam_data_low\n\t\t= dsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RDATA_LOW_0_REG);\n\n\t \n\ttcam_read_data0 = dsaf_read_dev(dsaf_dev,\n\t\t\t\t\tDSAF_TBL_TCAM_RAM_RDATA0_0_REG);\n\ttcam_read_data4 = dsaf_read_dev(dsaf_dev,\n\t\t\t\t\tDSAF_TBL_TCAM_RAM_RDATA4_0_REG);\n\n\tptbl_tcam_ucast->tbl_ucast_item_vld\n\t\t= dsaf_get_bit(tcam_read_data4,\n\t\t\t       DSAF_TBL_MCAST_CFG4_ITEM_VLD_S);\n\tptbl_tcam_ucast->tbl_ucast_old_en\n\t\t= dsaf_get_bit(tcam_read_data4, DSAF_TBL_MCAST_CFG4_OLD_EN_S);\n\tptbl_tcam_ucast->tbl_ucast_mac_discard\n\t\t= dsaf_get_bit(tcam_read_data0,\n\t\t\t       DSAF_TBL_UCAST_CFG1_MAC_DISCARD_S);\n\tptbl_tcam_ucast->tbl_ucast_out_port\n\t\t= dsaf_get_field(tcam_read_data0,\n\t\t\t\t DSAF_TBL_UCAST_CFG1_OUT_PORT_M,\n\t\t\t\t DSAF_TBL_UCAST_CFG1_OUT_PORT_S);\n\tptbl_tcam_ucast->tbl_ucast_dvc\n\t\t= dsaf_get_bit(tcam_read_data0, DSAF_TBL_UCAST_CFG1_DVC_S);\n\n\tspin_unlock_bh(&dsaf_dev->tcam_lock);\n}\n\n \nstatic void hns_dsaf_tcam_mc_get(\n\tstruct dsaf_device *dsaf_dev, u32 address,\n\tstruct dsaf_tbl_tcam_data *ptbl_tcam_data,\n\tstruct dsaf_tbl_tcam_mcast_cfg *ptbl_tcam_mcast)\n{\n\tu32 data_tmp;\n\n\tspin_lock_bh(&dsaf_dev->tcam_lock);\n\n\t \n\thns_dsaf_tbl_tcam_addr_cfg(dsaf_dev, address);\n\n\t \n\thns_dsaf_tbl_tcam_load_pul(dsaf_dev);\n\n\t \n\tptbl_tcam_data->tbl_tcam_data_high =\n\t\tdsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RDATA_HIGH_0_REG);\n\tptbl_tcam_data->tbl_tcam_data_low =\n\t\tdsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RDATA_LOW_0_REG);\n\n\t \n\tptbl_tcam_mcast->tbl_mcast_port_msk[0] =\n\t\tdsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RAM_RDATA0_0_REG);\n\tptbl_tcam_mcast->tbl_mcast_port_msk[1] =\n\t\tdsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RAM_RDATA1_0_REG);\n\tptbl_tcam_mcast->tbl_mcast_port_msk[2] =\n\t\tdsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RAM_RDATA2_0_REG);\n\tptbl_tcam_mcast->tbl_mcast_port_msk[3] =\n\t\tdsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RAM_RDATA3_0_REG);\n\n\tdata_tmp = dsaf_read_dev(dsaf_dev, DSAF_TBL_TCAM_RAM_RDATA4_0_REG);\n\tptbl_tcam_mcast->tbl_mcast_item_vld =\n\t\tdsaf_get_bit(data_tmp, DSAF_TBL_MCAST_CFG4_ITEM_VLD_S);\n\tptbl_tcam_mcast->tbl_mcast_old_en =\n\t\tdsaf_get_bit(data_tmp, DSAF_TBL_MCAST_CFG4_OLD_EN_S);\n\tptbl_tcam_mcast->tbl_mcast_port_msk[4] =\n\t\tdsaf_get_field(data_tmp, DSAF_TBL_MCAST_CFG4_VM128_112_M,\n\t\t\t       DSAF_TBL_MCAST_CFG4_VM128_112_S);\n\n\tspin_unlock_bh(&dsaf_dev->tcam_lock);\n}\n\n \nstatic void hns_dsaf_tbl_line_init(struct dsaf_device *dsaf_dev)\n{\n\tu32 i;\n\t \n\tstruct dsaf_tbl_line_cfg tbl_line[] = {{1, 0, 0} };\n\n\tfor (i = 0; i < DSAF_LINE_SUM; i++)\n\t\thns_dsaf_single_line_tbl_cfg(dsaf_dev, i, tbl_line);\n}\n\n \nstatic void hns_dsaf_tbl_tcam_init(struct dsaf_device *dsaf_dev)\n{\n\tu32 i;\n\tstruct dsaf_tbl_tcam_data tcam_data[] = {{0, 0} };\n\tstruct dsaf_tbl_tcam_ucast_cfg tcam_ucast[] = {{0, 0, 0, 0, 0} };\n\n\t \n\tfor (i = 0; i < DSAF_TCAM_SUM; i++)\n\t\thns_dsaf_tcam_uc_cfg(dsaf_dev, i, tcam_data, tcam_ucast);\n}\n\n \nstatic void hns_dsaf_pfc_en_cfg(struct dsaf_device *dsaf_dev,\n\t\t\t\tint mac_id, int tc_en)\n{\n\tdsaf_write_dev(dsaf_dev, DSAF_PFC_EN_0_REG + mac_id * 4, tc_en);\n}\n\nstatic void hns_dsaf_set_pfc_pause(struct dsaf_device *dsaf_dev,\n\t\t\t\t   int mac_id, int tx_en, int rx_en)\n{\n\tif (AE_IS_VER1(dsaf_dev->dsaf_ver)) {\n\t\tif (!tx_en || !rx_en)\n\t\t\tdev_err(dsaf_dev->dev, \"dsaf v1 can not close pfc!\\n\");\n\n\t\treturn;\n\t}\n\n\tdsaf_set_dev_bit(dsaf_dev, DSAF_PAUSE_CFG_REG + mac_id * 4,\n\t\t\t DSAF_PFC_PAUSE_RX_EN_B, !!rx_en);\n\tdsaf_set_dev_bit(dsaf_dev, DSAF_PAUSE_CFG_REG + mac_id * 4,\n\t\t\t DSAF_PFC_PAUSE_TX_EN_B, !!tx_en);\n}\n\nint hns_dsaf_set_rx_mac_pause_en(struct dsaf_device *dsaf_dev, int mac_id,\n\t\t\t\t u32 en)\n{\n\tif (AE_IS_VER1(dsaf_dev->dsaf_ver)) {\n\t\tif (!en) {\n\t\t\tdev_err(dsaf_dev->dev, \"dsafv1 can't close rx_pause!\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tdsaf_set_dev_bit(dsaf_dev, DSAF_PAUSE_CFG_REG + mac_id * 4,\n\t\t\t DSAF_MAC_PAUSE_RX_EN_B, !!en);\n\n\treturn 0;\n}\n\nvoid hns_dsaf_get_rx_mac_pause_en(struct dsaf_device *dsaf_dev, int mac_id,\n\t\t\t\t  u32 *en)\n{\n\tif (AE_IS_VER1(dsaf_dev->dsaf_ver))\n\t\t*en = 1;\n\telse\n\t\t*en = dsaf_get_dev_bit(dsaf_dev,\n\t\t\t\t       DSAF_PAUSE_CFG_REG + mac_id * 4,\n\t\t\t\t       DSAF_MAC_PAUSE_RX_EN_B);\n}\n\n \nstatic void hns_dsaf_comm_init(struct dsaf_device *dsaf_dev)\n{\n\tu32 i;\n\tu32 o_dsaf_cfg;\n\tbool is_ver1 = AE_IS_VER1(dsaf_dev->dsaf_ver);\n\n\to_dsaf_cfg = dsaf_read_dev(dsaf_dev, DSAF_CFG_0_REG);\n\tdsaf_set_bit(o_dsaf_cfg, DSAF_CFG_EN_S, dsaf_dev->dsaf_en);\n\tdsaf_set_bit(o_dsaf_cfg, DSAF_CFG_TC_MODE_S, dsaf_dev->dsaf_tc_mode);\n\tdsaf_set_bit(o_dsaf_cfg, DSAF_CFG_CRC_EN_S, 0);\n\tdsaf_set_bit(o_dsaf_cfg, DSAF_CFG_MIX_MODE_S, 0);\n\tdsaf_set_bit(o_dsaf_cfg, DSAF_CFG_LOCA_ADDR_EN_S, 0);\n\tdsaf_write_dev(dsaf_dev, DSAF_CFG_0_REG, o_dsaf_cfg);\n\n\thns_dsaf_reg_cnt_clr_ce(dsaf_dev, 1);\n\thns_dsaf_stp_port_type_cfg(dsaf_dev, DSAF_STP_PORT_TYPE_FORWARD);\n\n\t \n\thns_dsaf_ppe_qid_cfg(dsaf_dev, DSAF_DEFAUTL_QUEUE_NUM_PER_PPE);\n\n\t \n\thns_dsaf_mix_def_qid_cfg(dsaf_dev);\n\n\t \n\thns_dsaf_inner_qid_cfg(dsaf_dev);\n\n\t \n\thns_dsaf_sw_port_type_cfg(dsaf_dev, DSAF_SW_PORT_TYPE_NON_VLAN);\n\n\t \n\tfor (i = 0; i < DSAF_COMM_CHN; i++) {\n\t\thns_dsaf_pfc_en_cfg(dsaf_dev, i, 0);\n\t\thns_dsaf_set_pfc_pause(dsaf_dev, i, is_ver1, is_ver1);\n\t}\n\n\t \n\tfor (i = 0; i < DSAF_COMM_CHN; i++) {\n\t\thns_dsaf_int_xge_src_clr(dsaf_dev, i, 0xfffffffful);\n\t\thns_dsaf_int_ppe_src_clr(dsaf_dev, i, 0xfffffffful);\n\t\thns_dsaf_int_rocee_src_clr(dsaf_dev, i, 0xfffffffful);\n\n\t\thns_dsaf_int_xge_msk_set(dsaf_dev, i, 0xfffffffful);\n\t\thns_dsaf_int_ppe_msk_set(dsaf_dev, i, 0xfffffffful);\n\t\thns_dsaf_int_rocee_msk_set(dsaf_dev, i, 0xfffffffful);\n\t}\n\thns_dsaf_int_tbl_src_clr(dsaf_dev, 0xfffffffful);\n\thns_dsaf_int_tbl_msk_set(dsaf_dev, 0xfffffffful);\n}\n\n \nstatic void hns_dsaf_inode_init(struct dsaf_device *dsaf_dev)\n{\n\tu32 reg;\n\tu32 tc_cfg;\n\tu32 i;\n\n\tif (dsaf_dev->dsaf_tc_mode == HRD_DSAF_4TC_MODE)\n\t\ttc_cfg = HNS_DSAF_I4TC_CFG;\n\telse\n\t\ttc_cfg = HNS_DSAF_I8TC_CFG;\n\n\tif (AE_IS_VER1(dsaf_dev->dsaf_ver)) {\n\t\tfor (i = 0; i < DSAF_INODE_NUM; i++) {\n\t\t\treg = DSAF_INODE_IN_PORT_NUM_0_REG + 0x80 * i;\n\t\t\tdsaf_set_dev_field(dsaf_dev, reg,\n\t\t\t\t\t   DSAF_INODE_IN_PORT_NUM_M,\n\t\t\t\t\t   DSAF_INODE_IN_PORT_NUM_S,\n\t\t\t\t\t   i % DSAF_XGE_NUM);\n\t\t}\n\t} else {\n\t\tfor (i = 0; i < DSAF_PORT_TYPE_NUM; i++) {\n\t\t\treg = DSAF_INODE_IN_PORT_NUM_0_REG + 0x80 * i;\n\t\t\tdsaf_set_dev_field(dsaf_dev, reg,\n\t\t\t\t\t   DSAF_INODE_IN_PORT_NUM_M,\n\t\t\t\t\t   DSAF_INODE_IN_PORT_NUM_S, 0);\n\t\t\tdsaf_set_dev_field(dsaf_dev, reg,\n\t\t\t\t\t   DSAFV2_INODE_IN_PORT1_NUM_M,\n\t\t\t\t\t   DSAFV2_INODE_IN_PORT1_NUM_S, 1);\n\t\t\tdsaf_set_dev_field(dsaf_dev, reg,\n\t\t\t\t\t   DSAFV2_INODE_IN_PORT2_NUM_M,\n\t\t\t\t\t   DSAFV2_INODE_IN_PORT2_NUM_S, 2);\n\t\t\tdsaf_set_dev_field(dsaf_dev, reg,\n\t\t\t\t\t   DSAFV2_INODE_IN_PORT3_NUM_M,\n\t\t\t\t\t   DSAFV2_INODE_IN_PORT3_NUM_S, 3);\n\t\t\tdsaf_set_dev_field(dsaf_dev, reg,\n\t\t\t\t\t   DSAFV2_INODE_IN_PORT4_NUM_M,\n\t\t\t\t\t   DSAFV2_INODE_IN_PORT4_NUM_S, 4);\n\t\t\tdsaf_set_dev_field(dsaf_dev, reg,\n\t\t\t\t\t   DSAFV2_INODE_IN_PORT5_NUM_M,\n\t\t\t\t\t   DSAFV2_INODE_IN_PORT5_NUM_S, 5);\n\t\t}\n\t}\n\tfor (i = 0; i < DSAF_INODE_NUM; i++) {\n\t\treg = DSAF_INODE_PRI_TC_CFG_0_REG + 0x80 * i;\n\t\tdsaf_write_dev(dsaf_dev, reg, tc_cfg);\n\t}\n}\n\n \nstatic int hns_dsaf_sbm_init(struct dsaf_device *dsaf_dev)\n{\n\tu32 flag;\n\tu32 finish_msk;\n\tu32 cnt = 0;\n\tint ret;\n\n\tif (AE_IS_VER1(dsaf_dev->dsaf_ver)) {\n\t\thns_dsaf_sbm_bp_wl_cfg(dsaf_dev);\n\t\tfinish_msk = DSAF_SRAM_INIT_OVER_M;\n\t} else {\n\t\thns_dsafv2_sbm_bp_wl_cfg(dsaf_dev);\n\t\tfinish_msk = DSAFV2_SRAM_INIT_OVER_M;\n\t}\n\n\t \n\thns_dsaf_sbm_cfg(dsaf_dev);\n\n\t \n\tret = hns_dsaf_sbm_cfg_mib_en(dsaf_dev);\n\tif (ret) {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"hns_dsaf_sbm_cfg_mib_en fail,%s, ret=%d\\n\",\n\t\t\tdsaf_dev->ae_dev.name, ret);\n\t\treturn ret;\n\t}\n\n\t \n\thns_dsaf_sbm_link_sram_init_en(dsaf_dev);\n\n\tdo {\n\t\tusleep_range(200, 210); \n\t\tflag = dsaf_get_dev_field(dsaf_dev, DSAF_SRAM_INIT_OVER_0_REG,\n\t\t\t\t\t  finish_msk, DSAF_SRAM_INIT_OVER_S);\n\t\tcnt++;\n\t} while (flag != (finish_msk >> DSAF_SRAM_INIT_OVER_S) &&\n\t\t cnt < DSAF_CFG_READ_CNT);\n\n\tif (flag != (finish_msk >> DSAF_SRAM_INIT_OVER_S)) {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"hns_dsaf_sbm_init fail %s, flag=%d, cnt=%d\\n\",\n\t\t\tdsaf_dev->ae_dev.name, flag, cnt);\n\t\treturn -ENODEV;\n\t}\n\n\thns_dsaf_rocee_bp_en(dsaf_dev);\n\n\treturn 0;\n}\n\n \nstatic void hns_dsaf_tbl_init(struct dsaf_device *dsaf_dev)\n{\n\thns_dsaf_tbl_stat_en(dsaf_dev);\n\n\thns_dsaf_tbl_tcam_init(dsaf_dev);\n\thns_dsaf_tbl_line_init(dsaf_dev);\n}\n\n \nstatic void hns_dsaf_voq_init(struct dsaf_device *dsaf_dev)\n{\n\thns_dsaf_voq_bp_all_thrd_cfg(dsaf_dev);\n}\n\n \nstatic int hns_dsaf_init_hw(struct dsaf_device *dsaf_dev)\n{\n\tint ret;\n\n\tdev_dbg(dsaf_dev->dev,\n\t\t\"hns_dsaf_init_hw begin %s !\\n\", dsaf_dev->ae_dev.name);\n\n\tdsaf_dev->misc_op->dsaf_reset(dsaf_dev, 0);\n\tmdelay(10);\n\tdsaf_dev->misc_op->dsaf_reset(dsaf_dev, 1);\n\n\thns_dsaf_comm_init(dsaf_dev);\n\n\t \n\thns_dsaf_inode_init(dsaf_dev);\n\n\t \n\tret = hns_dsaf_sbm_init(dsaf_dev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\thns_dsaf_tbl_init(dsaf_dev);\n\n\t \n\thns_dsaf_voq_init(dsaf_dev);\n\n\treturn 0;\n}\n\n \nstatic void hns_dsaf_remove_hw(struct dsaf_device *dsaf_dev)\n{\n\t \n\tdsaf_dev->misc_op->dsaf_reset(dsaf_dev, 0);\n}\n\n \nstatic int hns_dsaf_init(struct dsaf_device *dsaf_dev)\n{\n\tstruct dsaf_drv_priv *priv =\n\t    (struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\n\tu32 i;\n\tint ret;\n\n\tif (HNS_DSAF_IS_DEBUG(dsaf_dev))\n\t\treturn 0;\n\n\tif (AE_IS_VER1(dsaf_dev->dsaf_ver))\n\t\tdsaf_dev->tcam_max_num = DSAF_TCAM_SUM;\n\telse\n\t\tdsaf_dev->tcam_max_num =\n\t\t\tDSAF_TCAM_SUM - DSAFV2_MAC_FUZZY_TCAM_NUM;\n\n\tspin_lock_init(&dsaf_dev->tcam_lock);\n\tret = hns_dsaf_init_hw(dsaf_dev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tpriv->soft_mac_tbl = vzalloc(array_size(DSAF_TCAM_SUM,\n\t\t\t\t\t\tsizeof(*priv->soft_mac_tbl)));\n\tif (!priv->soft_mac_tbl) {\n\t\tret = -ENOMEM;\n\t\tgoto remove_hw;\n\t}\n\n\t \n\tfor (i = 0; i < DSAF_TCAM_SUM; i++)\n\t\t(priv->soft_mac_tbl + i)->index = DSAF_INVALID_ENTRY_IDX;\n\n\treturn 0;\n\nremove_hw:\n\thns_dsaf_remove_hw(dsaf_dev);\n\treturn ret;\n}\n\n \nstatic void hns_dsaf_free(struct dsaf_device *dsaf_dev)\n{\n\tstruct dsaf_drv_priv *priv =\n\t    (struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\n\n\thns_dsaf_remove_hw(dsaf_dev);\n\n\t \n\tvfree(priv->soft_mac_tbl);\n\tpriv->soft_mac_tbl = NULL;\n}\n\n \nstatic u16 hns_dsaf_find_soft_mac_entry(\n\tstruct dsaf_device *dsaf_dev,\n\tstruct dsaf_drv_tbl_tcam_key *mac_key)\n{\n\tstruct dsaf_drv_priv *priv =\n\t    (struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\n\tstruct dsaf_drv_soft_mac_tbl *soft_mac_entry;\n\tu32 i;\n\n\tsoft_mac_entry = priv->soft_mac_tbl;\n\tfor (i = 0; i < dsaf_dev->tcam_max_num; i++) {\n\t\t \n\t\tif ((soft_mac_entry->index != DSAF_INVALID_ENTRY_IDX) &&\n\t\t    (soft_mac_entry->tcam_key.high.val == mac_key->high.val) &&\n\t\t    (soft_mac_entry->tcam_key.low.val == mac_key->low.val))\n\t\t\t \n\t\t\treturn soft_mac_entry->index;\n\n\t\tsoft_mac_entry++;\n\t}\n\treturn DSAF_INVALID_ENTRY_IDX;\n}\n\n \nstatic u16 hns_dsaf_find_empty_mac_entry(struct dsaf_device *dsaf_dev)\n{\n\tstruct dsaf_drv_priv *priv =\n\t    (struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\n\tstruct dsaf_drv_soft_mac_tbl *soft_mac_entry;\n\tu32 i;\n\n\tsoft_mac_entry = priv->soft_mac_tbl;\n\tfor (i = 0; i < dsaf_dev->tcam_max_num; i++) {\n\t\t \n\t\tif (soft_mac_entry->index == DSAF_INVALID_ENTRY_IDX)\n\t\t\t \n\t\t\treturn i;\n\n\t\tsoft_mac_entry++;\n\t}\n\treturn DSAF_INVALID_ENTRY_IDX;\n}\n\n \nstatic u16 hns_dsaf_find_empty_mac_entry_reverse(struct dsaf_device *dsaf_dev)\n{\n\tstruct dsaf_drv_priv *priv = hns_dsaf_dev_priv(dsaf_dev);\n\tstruct dsaf_drv_soft_mac_tbl *soft_mac_entry;\n\tint i;\n\n\tsoft_mac_entry = priv->soft_mac_tbl + (DSAF_TCAM_SUM - 1);\n\tfor (i = (DSAF_TCAM_SUM - 1); i > 0; i--) {\n\t\t \n\t\tif (soft_mac_entry->index == DSAF_INVALID_ENTRY_IDX)\n\t\t\treturn i;\n\t\tsoft_mac_entry--;\n\t}\n\treturn DSAF_INVALID_ENTRY_IDX;\n}\n\n \nstatic void hns_dsaf_set_mac_key(\n\tstruct dsaf_device *dsaf_dev,\n\tstruct dsaf_drv_tbl_tcam_key *mac_key, u16 vlan_id, u8 in_port_num,\n\tu8 *addr)\n{\n\tu8 port;\n\n\tif (dsaf_dev->dsaf_mode <= DSAF_MODE_ENABLE)\n\t\t \n\t\tport = 0;\n\telse\n\t\t \n\t\tport = in_port_num;\n\n\tmac_key->high.bits.mac_0 = addr[0];\n\tmac_key->high.bits.mac_1 = addr[1];\n\tmac_key->high.bits.mac_2 = addr[2];\n\tmac_key->high.bits.mac_3 = addr[3];\n\tmac_key->low.bits.mac_4 = addr[4];\n\tmac_key->low.bits.mac_5 = addr[5];\n\tmac_key->low.bits.port_vlan = 0;\n\tdsaf_set_field(mac_key->low.bits.port_vlan, DSAF_TBL_TCAM_KEY_VLAN_M,\n\t\t       DSAF_TBL_TCAM_KEY_VLAN_S, vlan_id);\n\tdsaf_set_field(mac_key->low.bits.port_vlan, DSAF_TBL_TCAM_KEY_PORT_M,\n\t\t       DSAF_TBL_TCAM_KEY_PORT_S, port);\n}\n\n \nint hns_dsaf_set_mac_uc_entry(\n\tstruct dsaf_device *dsaf_dev,\n\tstruct dsaf_drv_mac_single_dest_entry *mac_entry)\n{\n\tu16 entry_index;\n\tstruct dsaf_drv_tbl_tcam_key mac_key;\n\tstruct dsaf_tbl_tcam_ucast_cfg mac_data;\n\tstruct dsaf_drv_priv *priv =\n\t    (struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\n\tstruct dsaf_drv_soft_mac_tbl *soft_mac_entry = priv->soft_mac_tbl;\n\tstruct dsaf_tbl_tcam_data tcam_data;\n\n\t \n\tif (MAC_IS_ALL_ZEROS(mac_entry->addr) ||\n\t    MAC_IS_BROADCAST(mac_entry->addr) ||\n\t    MAC_IS_MULTICAST(mac_entry->addr)) {\n\t\tdev_err(dsaf_dev->dev, \"set_uc %s Mac %pM err!\\n\",\n\t\t\tdsaf_dev->ae_dev.name, mac_entry->addr);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\thns_dsaf_set_mac_key(dsaf_dev, &mac_key, mac_entry->in_vlan_id,\n\t\t\t     mac_entry->in_port_num, mac_entry->addr);\n\n\t \n\tentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\n\tif (entry_index == DSAF_INVALID_ENTRY_IDX) {\n\t\t \n\t\tentry_index = hns_dsaf_find_empty_mac_entry(dsaf_dev);\n\t\tif (entry_index == DSAF_INVALID_ENTRY_IDX) {\n\t\t\t \n\t\t\tdev_err(dsaf_dev->dev,\n\t\t\t\t\"set_uc_entry failed, %s Mac key(%#x:%#x)\\n\",\n\t\t\t\tdsaf_dev->ae_dev.name,\n\t\t\t\tmac_key.high.val, mac_key.low.val);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tdev_dbg(dsaf_dev->dev,\n\t\t\"set_uc_entry, %s Mac key(%#x:%#x) entry_index%d\\n\",\n\t\tdsaf_dev->ae_dev.name, mac_key.high.val,\n\t\tmac_key.low.val, entry_index);\n\n\t \n\tmac_data.tbl_ucast_item_vld = 1;\n\tmac_data.tbl_ucast_mac_discard = 0;\n\tmac_data.tbl_ucast_old_en = 0;\n\t \n\tmac_data.tbl_ucast_dvc = 0;\n\tmac_data.tbl_ucast_out_port = mac_entry->port_num;\n\ttcam_data.tbl_tcam_data_high = mac_key.high.val;\n\ttcam_data.tbl_tcam_data_low = mac_key.low.val;\n\n\thns_dsaf_tcam_uc_cfg(dsaf_dev, entry_index, &tcam_data, &mac_data);\n\n\t \n\tsoft_mac_entry += entry_index;\n\tsoft_mac_entry->index = entry_index;\n\tsoft_mac_entry->tcam_key.high.val = mac_key.high.val;\n\tsoft_mac_entry->tcam_key.low.val = mac_key.low.val;\n\n\treturn 0;\n}\n\nint hns_dsaf_rm_mac_addr(\n\tstruct dsaf_device *dsaf_dev,\n\tstruct dsaf_drv_mac_single_dest_entry *mac_entry)\n{\n\tu16 entry_index;\n\tstruct dsaf_tbl_tcam_ucast_cfg mac_data;\n\tstruct dsaf_drv_tbl_tcam_key mac_key;\n\n\t \n\tif (!is_valid_ether_addr(mac_entry->addr)) {\n\t\tdev_err(dsaf_dev->dev, \"rm_uc_addr %s Mac %pM err!\\n\",\n\t\t\tdsaf_dev->ae_dev.name, mac_entry->addr);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\thns_dsaf_set_mac_key(dsaf_dev, &mac_key, mac_entry->in_vlan_id,\n\t\t\t     mac_entry->in_port_num, mac_entry->addr);\n\n\tentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\n\tif (entry_index == DSAF_INVALID_ENTRY_IDX) {\n\t\t \n\t\tdev_info(dsaf_dev->dev,\n\t\t\t \"rm_uc_addr no tcam, %s Mac key(%#x:%#x)\\n\",\n\t\t\t dsaf_dev->ae_dev.name,\n\t\t\t mac_key.high.val, mac_key.low.val);\n\t\treturn 0;\n\t}\n\n\tdev_dbg(dsaf_dev->dev,\n\t\t\"rm_uc_addr, %s Mac key(%#x:%#x) entry_index%d\\n\",\n\t\tdsaf_dev->ae_dev.name, mac_key.high.val,\n\t\tmac_key.low.val, entry_index);\n\n\thns_dsaf_tcam_uc_get(\n\t\t\tdsaf_dev, entry_index,\n\t\t\t(struct dsaf_tbl_tcam_data *)&mac_key,\n\t\t\t&mac_data);\n\n\t \n\tif (mac_entry->port_num != mac_data.tbl_ucast_out_port)\n\t\treturn -EFAULT;\n\n\treturn hns_dsaf_del_mac_entry(dsaf_dev,\n\t\t\t\t      mac_entry->in_vlan_id,\n\t\t\t\t      mac_entry->in_port_num,\n\t\t\t\t      mac_entry->addr);\n}\n\nstatic void hns_dsaf_setup_mc_mask(struct dsaf_device *dsaf_dev,\n\t\t\t\t   u8 port_num, u8 *mask, u8 *addr)\n{\n\tif (MAC_IS_BROADCAST(addr))\n\t\teth_broadcast_addr(mask);\n\telse\n\t\tmemcpy(mask, dsaf_dev->mac_cb[port_num]->mc_mask, ETH_ALEN);\n}\n\nstatic void hns_dsaf_mc_mask_bit_clear(char *dst, const char *src)\n{\n\tu16 *a = (u16 *)dst;\n\tconst u16 *b = (const u16 *)src;\n\n\ta[0] &= b[0];\n\ta[1] &= b[1];\n\ta[2] &= b[2];\n}\n\n \nint hns_dsaf_add_mac_mc_port(struct dsaf_device *dsaf_dev,\n\t\t\t     struct dsaf_drv_mac_single_dest_entry *mac_entry)\n{\n\tu16 entry_index;\n\tstruct dsaf_drv_tbl_tcam_key mac_key;\n\tstruct dsaf_drv_tbl_tcam_key mask_key;\n\tstruct dsaf_tbl_tcam_data *pmask_key = NULL;\n\tstruct dsaf_tbl_tcam_mcast_cfg mac_data;\n\tstruct dsaf_drv_priv *priv = hns_dsaf_dev_priv(dsaf_dev);\n\tstruct dsaf_drv_soft_mac_tbl *soft_mac_entry = priv->soft_mac_tbl;\n\tstruct dsaf_tbl_tcam_data tcam_data;\n\tu8 mc_addr[ETH_ALEN];\n\tint mskid;\n\n\t \n\tif (MAC_IS_ALL_ZEROS(mac_entry->addr)) {\n\t\tdev_err(dsaf_dev->dev, \"set_entry failed,addr %pM!\\n\",\n\t\t\tmac_entry->addr);\n\t\treturn -EINVAL;\n\t}\n\n\tether_addr_copy(mc_addr, mac_entry->addr);\n\tif (!AE_IS_VER1(dsaf_dev->dsaf_ver)) {\n\t\tu8 mc_mask[ETH_ALEN];\n\n\t\t \n\t\thns_dsaf_setup_mc_mask(dsaf_dev, mac_entry->in_port_num,\n\t\t\t\t       mc_mask, mac_entry->addr);\n\t\thns_dsaf_mc_mask_bit_clear(mc_addr, mc_mask);\n\n\t\t \n\t\thns_dsaf_set_mac_key(dsaf_dev, &mask_key,\n\t\t\t\t     0x0,\n\t\t\t\t     0xff,\n\t\t\t\t     mc_mask);\n\n\t\tpmask_key = (struct dsaf_tbl_tcam_data *)(&mask_key);\n\t}\n\n\t \n\thns_dsaf_set_mac_key(\n\t\tdsaf_dev, &mac_key, mac_entry->in_vlan_id,\n\t\tmac_entry->in_port_num, mc_addr);\n\n\tmemset(&mac_data, 0, sizeof(struct dsaf_tbl_tcam_mcast_cfg));\n\n\t \n\tentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\n\tif (entry_index == DSAF_INVALID_ENTRY_IDX) {\n\t\t \n\t\tentry_index = hns_dsaf_find_empty_mac_entry(dsaf_dev);\n\t\tif (entry_index == DSAF_INVALID_ENTRY_IDX) {\n\t\t\t \n\t\t\tdev_err(dsaf_dev->dev,\n\t\t\t\t\"set_uc_entry failed, %s Mac key(%#x:%#x)\\n\",\n\t\t\t\tdsaf_dev->ae_dev.name, mac_key.high.val,\n\t\t\t\tmac_key.low.val);\n\t\t\treturn -EINVAL;\n\t\t}\n\t} else {\n\t\t \n\t\thns_dsaf_tcam_mc_get(dsaf_dev, entry_index, &tcam_data,\n\t\t\t\t     &mac_data);\n\t}\n\n\t \n\tif (mac_entry->port_num < DSAF_SERVICE_NW_NUM) {\n\t\tmskid = mac_entry->port_num;\n\t} else if (mac_entry->port_num >= DSAF_BASE_INNER_PORT_NUM) {\n\t\tmskid = mac_entry->port_num -\n\t\t\tDSAF_BASE_INNER_PORT_NUM + DSAF_SERVICE_NW_NUM;\n\t} else {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"%s,pnum(%d)error,key(%#x:%#x)\\n\",\n\t\t\tdsaf_dev->ae_dev.name, mac_entry->port_num,\n\t\t\tmac_key.high.val, mac_key.low.val);\n\t\treturn -EINVAL;\n\t}\n\tdsaf_set_bit(mac_data.tbl_mcast_port_msk[mskid / 32], mskid % 32, 1);\n\tmac_data.tbl_mcast_old_en = 0;\n\tmac_data.tbl_mcast_item_vld = 1;\n\n\tdev_dbg(dsaf_dev->dev,\n\t\t\"set_uc_entry, %s Mac key(%#x:%#x) entry_index%d\\n\",\n\t\tdsaf_dev->ae_dev.name, mac_key.high.val,\n\t\tmac_key.low.val, entry_index);\n\n\ttcam_data.tbl_tcam_data_high = mac_key.high.val;\n\ttcam_data.tbl_tcam_data_low = mac_key.low.val;\n\n\t \n\thns_dsaf_tcam_mc_cfg(dsaf_dev, entry_index, &tcam_data,\n\t\t\t     pmask_key, &mac_data);\n\n\t \n\tsoft_mac_entry += entry_index;\n\tsoft_mac_entry->index = entry_index;\n\tsoft_mac_entry->tcam_key.high.val = mac_key.high.val;\n\tsoft_mac_entry->tcam_key.low.val = mac_key.low.val;\n\n\treturn 0;\n}\n\n \nint hns_dsaf_del_mac_entry(struct dsaf_device *dsaf_dev, u16 vlan_id,\n\t\t\t   u8 in_port_num, u8 *addr)\n{\n\tu16 entry_index;\n\tstruct dsaf_drv_tbl_tcam_key mac_key;\n\tstruct dsaf_drv_priv *priv =\n\t    (struct dsaf_drv_priv *)hns_dsaf_dev_priv(dsaf_dev);\n\tstruct dsaf_drv_soft_mac_tbl *soft_mac_entry = priv->soft_mac_tbl;\n\n\t \n\tif (MAC_IS_ALL_ZEROS(addr) || MAC_IS_BROADCAST(addr)) {\n\t\tdev_err(dsaf_dev->dev, \"del_entry failed,addr %pM!\\n\",\n\t\t\taddr);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\thns_dsaf_set_mac_key(dsaf_dev, &mac_key, vlan_id, in_port_num, addr);\n\n\t \n\tentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\n\tif (entry_index == DSAF_INVALID_ENTRY_IDX) {\n\t\t \n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"del_mac_entry failed, %s Mac key(%#x:%#x)\\n\",\n\t\t\tdsaf_dev->ae_dev.name,\n\t\t\tmac_key.high.val, mac_key.low.val);\n\t\treturn -EINVAL;\n\t}\n\tdev_dbg(dsaf_dev->dev,\n\t\t\"del_mac_entry, %s Mac key(%#x:%#x) entry_index%d\\n\",\n\t\tdsaf_dev->ae_dev.name, mac_key.high.val,\n\t\tmac_key.low.val, entry_index);\n\n\t \n\thns_dsaf_tcam_mc_invld(dsaf_dev, entry_index);\n\n\t \n\tsoft_mac_entry += entry_index;\n\tsoft_mac_entry->index = DSAF_INVALID_ENTRY_IDX;\n\n\treturn 0;\n}\n\n \nint hns_dsaf_del_mac_mc_port(struct dsaf_device *dsaf_dev,\n\t\t\t     struct dsaf_drv_mac_single_dest_entry *mac_entry)\n{\n\tu16 entry_index;\n\tstruct dsaf_drv_tbl_tcam_key mac_key;\n\tstruct dsaf_drv_priv *priv = hns_dsaf_dev_priv(dsaf_dev);\n\tstruct dsaf_drv_soft_mac_tbl *soft_mac_entry = priv->soft_mac_tbl;\n\tu16 vlan_id;\n\tu8 in_port_num;\n\tstruct dsaf_tbl_tcam_mcast_cfg mac_data;\n\tstruct dsaf_tbl_tcam_data tcam_data;\n\tint mskid;\n\tconst u8 empty_msk[sizeof(mac_data.tbl_mcast_port_msk)] = {0};\n\tstruct dsaf_drv_tbl_tcam_key mask_key;\n\tstruct dsaf_tbl_tcam_data *pmask_key = NULL;\n\tu8 mc_addr[ETH_ALEN];\n\n\tif (!(void *)mac_entry) {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"hns_dsaf_del_mac_mc_port mac_entry is NULL\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (MAC_IS_ALL_ZEROS(mac_entry->addr)) {\n\t\tdev_err(dsaf_dev->dev, \"del_port failed, addr %pM!\\n\",\n\t\t\tmac_entry->addr);\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tether_addr_copy(mc_addr, mac_entry->addr);\n\n\tif (!AE_IS_VER1(dsaf_dev->dsaf_ver)) {\n\t\tu8 mc_mask[ETH_ALEN];\n\n\t\t \n\t\thns_dsaf_setup_mc_mask(dsaf_dev, mac_entry->in_port_num,\n\t\t\t\t       mc_mask, mac_entry->addr);\n\t\thns_dsaf_mc_mask_bit_clear(mc_addr, mc_mask);\n\n\t\t \n\t\thns_dsaf_set_mac_key(dsaf_dev, &mask_key, 0x00, 0xff, mc_mask);\n\n\t\tpmask_key = (struct dsaf_tbl_tcam_data *)(&mask_key);\n\t}\n\n\t \n\tvlan_id = mac_entry->in_vlan_id;\n\tin_port_num = mac_entry->in_port_num;\n\n\t \n\thns_dsaf_set_mac_key(dsaf_dev, &mac_key, vlan_id, in_port_num, mc_addr);\n\n\t \n\tentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\n\tif (entry_index == DSAF_INVALID_ENTRY_IDX) {\n\t\t \n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"find_soft_mac_entry failed, %s Mac key(%#x:%#x)\\n\",\n\t\t\tdsaf_dev->ae_dev.name,\n\t\t\tmac_key.high.val, mac_key.low.val);\n\t\treturn -EINVAL;\n\t}\n\n\tdev_dbg(dsaf_dev->dev,\n\t\t\"del_mac_mc_port, %s key(%#x:%#x) index%d\\n\",\n\t\tdsaf_dev->ae_dev.name, mac_key.high.val,\n\t\tmac_key.low.val, entry_index);\n\n\t \n\thns_dsaf_tcam_mc_get(dsaf_dev, entry_index, &tcam_data, &mac_data);\n\n\t \n\tif (mac_entry->port_num < DSAF_SERVICE_NW_NUM) {\n\t\tmskid = mac_entry->port_num;\n\t} else if (mac_entry->port_num >= DSAF_BASE_INNER_PORT_NUM) {\n\t\tmskid = mac_entry->port_num -\n\t\t\tDSAF_BASE_INNER_PORT_NUM + DSAF_SERVICE_NW_NUM;\n\t} else {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"%s,pnum(%d)error,key(%#x:%#x)\\n\",\n\t\t\tdsaf_dev->ae_dev.name, mac_entry->port_num,\n\t\t\tmac_key.high.val, mac_key.low.val);\n\t\treturn -EINVAL;\n\t}\n\tdsaf_set_bit(mac_data.tbl_mcast_port_msk[mskid / 32], mskid % 32, 0);\n\n\t \n\tif (!memcmp(mac_data.tbl_mcast_port_msk, empty_msk,\n\t\t    sizeof(mac_data.tbl_mcast_port_msk))) {\n\t\thns_dsaf_tcam_mc_invld(dsaf_dev, entry_index);\n\n\t\t \n\t\tsoft_mac_entry += entry_index;\n\t\tsoft_mac_entry->index = DSAF_INVALID_ENTRY_IDX;\n\t} else {  \n\t\ttcam_data.tbl_tcam_data_high = mac_key.high.val;\n\t\ttcam_data.tbl_tcam_data_low = mac_key.low.val;\n\n\t\thns_dsaf_tcam_mc_cfg(dsaf_dev, entry_index,\n\t\t\t\t     &tcam_data,\n\t\t\t\t     pmask_key, &mac_data);\n\t}\n\n\treturn 0;\n}\n\nint hns_dsaf_clr_mac_mc_port(struct dsaf_device *dsaf_dev, u8 mac_id,\n\t\t\t     u8 port_num)\n{\n\tstruct dsaf_drv_priv *priv = hns_dsaf_dev_priv(dsaf_dev);\n\tstruct dsaf_drv_soft_mac_tbl *soft_mac_entry;\n\tstruct dsaf_tbl_tcam_mcast_cfg mac_data;\n\tint ret = 0, i;\n\n\tif (HNS_DSAF_IS_DEBUG(dsaf_dev))\n\t\treturn 0;\n\n\tfor (i = 0; i < DSAF_TCAM_SUM - DSAFV2_MAC_FUZZY_TCAM_NUM; i++) {\n\t\tu8 addr[ETH_ALEN];\n\t\tu8 port;\n\n\t\tsoft_mac_entry = priv->soft_mac_tbl + i;\n\n\t\thns_dsaf_tcam_addr_get(&soft_mac_entry->tcam_key, addr);\n\t\tport = dsaf_get_field(\n\t\t\t\tsoft_mac_entry->tcam_key.low.bits.port_vlan,\n\t\t\t\tDSAF_TBL_TCAM_KEY_PORT_M,\n\t\t\t\tDSAF_TBL_TCAM_KEY_PORT_S);\n\t\t \n\t\tif (soft_mac_entry->index != DSAF_INVALID_ENTRY_IDX &&\n\t\t    port == mac_id &&\n\t\t    is_multicast_ether_addr(addr) &&\n\t\t    !is_broadcast_ether_addr(addr)) {\n\t\t\tconst u32 empty_msk[DSAF_PORT_MSK_NUM] = {0};\n\t\t\tstruct dsaf_drv_mac_single_dest_entry mac_entry;\n\n\t\t\t \n\t\t\tether_addr_copy(mac_entry.addr, addr);\n\t\t\tmac_entry.in_vlan_id = dsaf_get_field(\n\t\t\t\tsoft_mac_entry->tcam_key.low.bits.port_vlan,\n\t\t\t\tDSAF_TBL_TCAM_KEY_VLAN_M,\n\t\t\t\tDSAF_TBL_TCAM_KEY_VLAN_S);\n\t\t\tmac_entry.in_port_num = mac_id;\n\t\t\tmac_entry.port_num = port_num;\n\t\t\tif (hns_dsaf_del_mac_mc_port(dsaf_dev, &mac_entry)) {\n\t\t\t\tret = -EINVAL;\n\t\t\t\tcontinue;\n\t\t\t}\n\n\t\t\t \n\t\t\thns_dsaf_tcam_mc_get(dsaf_dev, i,\n\t\t\t\t\t     (struct dsaf_tbl_tcam_data *)\n\t\t\t\t\t     (&soft_mac_entry->tcam_key),\n\t\t\t\t\t     &mac_data);\n\t\t\tdsaf_set_bit(mac_data.tbl_mcast_port_msk[mac_id / 32],\n\t\t\t\t     mac_id % 32, 0);\n\t\t\tif (!memcmp(mac_data.tbl_mcast_port_msk, empty_msk,\n\t\t\t\t    sizeof(u32) * DSAF_PORT_MSK_NUM)) {\n\t\t\t\tmac_entry.port_num = mac_id;\n\t\t\t\tif (hns_dsaf_del_mac_mc_port(dsaf_dev,\n\t\t\t\t\t\t\t     &mac_entry)) {\n\t\t\t\t\tret = -EINVAL;\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\treturn ret;\n}\n\nstatic struct dsaf_device *hns_dsaf_alloc_dev(struct device *dev,\n\t\t\t\t\t      size_t sizeof_priv)\n{\n\tstruct dsaf_device *dsaf_dev;\n\n\tdsaf_dev = devm_kzalloc(dev,\n\t\t\t\tsizeof(*dsaf_dev) + sizeof_priv, GFP_KERNEL);\n\tif (unlikely(!dsaf_dev)) {\n\t\tdsaf_dev = ERR_PTR(-ENOMEM);\n\t} else {\n\t\tdsaf_dev->dev = dev;\n\t\tdev_set_drvdata(dev, dsaf_dev);\n\t}\n\n\treturn dsaf_dev;\n}\n\n \nstatic void hns_dsaf_free_dev(struct dsaf_device *dsaf_dev)\n{\n\t(void)dev_set_drvdata(dsaf_dev->dev, NULL);\n}\n\n \nstatic void hns_dsaf_pfc_unit_cnt(struct dsaf_device *dsaf_dev, int  mac_id,\n\t\t\t\t  enum dsaf_port_rate_mode rate)\n{\n\tu32 unit_cnt;\n\n\tswitch (rate) {\n\tcase DSAF_PORT_RATE_10000:\n\t\tunit_cnt = HNS_DSAF_PFC_UNIT_CNT_FOR_XGE;\n\t\tbreak;\n\tcase DSAF_PORT_RATE_1000:\n\t\tunit_cnt = HNS_DSAF_PFC_UNIT_CNT_FOR_GE_1000;\n\t\tbreak;\n\tcase DSAF_PORT_RATE_2500:\n\t\tunit_cnt = HNS_DSAF_PFC_UNIT_CNT_FOR_GE_1000;\n\t\tbreak;\n\tdefault:\n\t\tunit_cnt = HNS_DSAF_PFC_UNIT_CNT_FOR_XGE;\n\t}\n\n\tdsaf_set_dev_field(dsaf_dev,\n\t\t\t   (DSAF_PFC_UNIT_CNT_0_REG + 0x4 * (u64)mac_id),\n\t\t\t   DSAF_PFC_UNINT_CNT_M, DSAF_PFC_UNINT_CNT_S,\n\t\t\t   unit_cnt);\n}\n\n \nstatic void\nhns_dsaf_port_work_rate_cfg(struct dsaf_device *dsaf_dev, int mac_id,\n\t\t\t    enum dsaf_port_rate_mode rate_mode)\n{\n\tu32 port_work_mode;\n\n\tport_work_mode = dsaf_read_dev(\n\t\tdsaf_dev, DSAF_XGE_GE_WORK_MODE_0_REG + 0x4 * (u64)mac_id);\n\n\tif (rate_mode == DSAF_PORT_RATE_10000)\n\t\tdsaf_set_bit(port_work_mode, DSAF_XGE_GE_WORK_MODE_S, 1);\n\telse\n\t\tdsaf_set_bit(port_work_mode, DSAF_XGE_GE_WORK_MODE_S, 0);\n\n\tdsaf_write_dev(dsaf_dev,\n\t\t       DSAF_XGE_GE_WORK_MODE_0_REG + 0x4 * (u64)mac_id,\n\t\t       port_work_mode);\n\n\thns_dsaf_pfc_unit_cnt(dsaf_dev, mac_id, rate_mode);\n}\n\n \nvoid hns_dsaf_fix_mac_mode(struct hns_mac_cb *mac_cb)\n{\n\tenum dsaf_port_rate_mode mode;\n\tstruct dsaf_device *dsaf_dev = mac_cb->dsaf_dev;\n\tint mac_id = mac_cb->mac_id;\n\n\tif (mac_cb->mac_type != HNAE_PORT_SERVICE)\n\t\treturn;\n\tif (mac_cb->phy_if == PHY_INTERFACE_MODE_XGMII)\n\t\tmode = DSAF_PORT_RATE_10000;\n\telse\n\t\tmode = DSAF_PORT_RATE_1000;\n\n\thns_dsaf_port_work_rate_cfg(dsaf_dev, mac_id, mode);\n}\n\nstatic u32 hns_dsaf_get_inode_prio_reg(int index)\n{\n\tint base_index, offset;\n\tu32 base_addr = DSAF_INODE_IN_PRIO_PAUSE_BASE_REG;\n\n\tbase_index = (index + 1) / DSAF_REG_PER_ZONE;\n\toffset = (index + 1) % DSAF_REG_PER_ZONE;\n\n\treturn base_addr + DSAF_INODE_IN_PRIO_PAUSE_BASE_OFFSET * base_index +\n\t\tDSAF_INODE_IN_PRIO_PAUSE_OFFSET * offset;\n}\n\nvoid hns_dsaf_update_stats(struct dsaf_device *dsaf_dev, u32 node_num)\n{\n\tstruct dsaf_hw_stats *hw_stats\n\t\t= &dsaf_dev->hw_stats[node_num];\n\tbool is_ver1 = AE_IS_VER1(dsaf_dev->dsaf_ver);\n\tint i;\n\tu32 reg_tmp;\n\n\thw_stats->pad_drop += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_PAD_DISCARD_NUM_0_REG + 0x80 * (u64)node_num);\n\thw_stats->man_pkts += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_FINAL_IN_MAN_NUM_0_REG + 0x80 * (u64)node_num);\n\thw_stats->rx_pkts += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_FINAL_IN_PKT_NUM_0_REG + 0x80 * (u64)node_num);\n\thw_stats->rx_pkt_id += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_SBM_PID_NUM_0_REG + 0x80 * (u64)node_num);\n\n\treg_tmp = is_ver1 ? DSAF_INODE_FINAL_IN_PAUSE_NUM_0_REG :\n\t\t\t    DSAFV2_INODE_FINAL_IN_PAUSE_NUM_0_REG;\n\thw_stats->rx_pause_frame +=\n\t\tdsaf_read_dev(dsaf_dev, reg_tmp + 0x80 * (u64)node_num);\n\n\thw_stats->release_buf_num += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_SBM_RELS_NUM_0_REG + 0x80 * (u64)node_num);\n\thw_stats->sbm_drop += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_SBM_DROP_NUM_0_REG + 0x80 * (u64)node_num);\n\thw_stats->crc_false += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_CRC_FALSE_NUM_0_REG + 0x80 * (u64)node_num);\n\thw_stats->bp_drop += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_BP_DISCARD_NUM_0_REG + 0x80 * (u64)node_num);\n\thw_stats->rslt_drop += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_RSLT_DISCARD_NUM_0_REG + 0x80 * (u64)node_num);\n\thw_stats->local_addr_false += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_LOCAL_ADDR_FALSE_NUM_0_REG + 0x80 * (u64)node_num);\n\n\thw_stats->vlan_drop += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_SW_VLAN_TAG_DISC_0_REG + 4 * (u64)node_num);\n\thw_stats->stp_drop += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_INODE_IN_DATA_STP_DISC_0_REG + 4 * (u64)node_num);\n\n\t \n\tif ((node_num < DSAF_SERVICE_NW_NUM) && !is_ver1) {\n\t\tfor (i = 0; i < DSAF_PRIO_NR; i++) {\n\t\t\treg_tmp = hns_dsaf_get_inode_prio_reg(i);\n\t\t\thw_stats->rx_pfc[i] += dsaf_read_dev(dsaf_dev,\n\t\t\t\treg_tmp + 0x4 * (u64)node_num);\n\t\t\thw_stats->tx_pfc[i] += dsaf_read_dev(dsaf_dev,\n\t\t\t\tDSAF_XOD_XGE_PFC_PRIO_CNT_BASE_REG +\n\t\t\t\tDSAF_XOD_XGE_PFC_PRIO_CNT_OFFSET * i +\n\t\t\t\t0xF0 * (u64)node_num);\n\t\t}\n\t}\n\thw_stats->tx_pkts += dsaf_read_dev(dsaf_dev,\n\t\tDSAF_XOD_RCVPKT_CNT_0_REG + 0x90 * (u64)node_num);\n}\n\n \nvoid hns_dsaf_get_regs(struct dsaf_device *ddev, u32 port, void *data)\n{\n\tu32 i;\n\tu32 j;\n\tu32 *p = data;\n\tu32 reg_tmp;\n\tbool is_ver1 = AE_IS_VER1(ddev->dsaf_ver);\n\n\t \n\tp[0] = dsaf_read_dev(ddev, DSAF_SRAM_INIT_OVER_0_REG);\n\tp[1] = dsaf_read_dev(ddev, DSAF_CFG_0_REG);\n\tp[2] = dsaf_read_dev(ddev, DSAF_ECC_ERR_INVERT_0_REG);\n\tp[3] = dsaf_read_dev(ddev, DSAF_ABNORMAL_TIMEOUT_0_REG);\n\tp[4] = dsaf_read_dev(ddev, DSAF_FSM_TIMEOUT_0_REG);\n\tp[5] = dsaf_read_dev(ddev, DSAF_DSA_REG_CNT_CLR_CE_REG);\n\tp[6] = dsaf_read_dev(ddev, DSAF_DSA_SBM_INF_FIFO_THRD_REG);\n\tp[7] = dsaf_read_dev(ddev, DSAF_DSA_SRAM_1BIT_ECC_SEL_REG);\n\tp[8] = dsaf_read_dev(ddev, DSAF_DSA_SRAM_1BIT_ECC_CNT_REG);\n\n\tp[9] = dsaf_read_dev(ddev, DSAF_PFC_EN_0_REG + port * 4);\n\tp[10] = dsaf_read_dev(ddev, DSAF_PFC_UNIT_CNT_0_REG + port * 4);\n\tp[11] = dsaf_read_dev(ddev, DSAF_XGE_INT_MSK_0_REG + port * 4);\n\tp[12] = dsaf_read_dev(ddev, DSAF_XGE_INT_SRC_0_REG + port * 4);\n\tp[13] = dsaf_read_dev(ddev, DSAF_XGE_INT_STS_0_REG + port * 4);\n\tp[14] = dsaf_read_dev(ddev, DSAF_XGE_INT_MSK_0_REG + port * 4);\n\tp[15] = dsaf_read_dev(ddev, DSAF_PPE_INT_MSK_0_REG + port * 4);\n\tp[16] = dsaf_read_dev(ddev, DSAF_ROCEE_INT_MSK_0_REG + port * 4);\n\tp[17] = dsaf_read_dev(ddev, DSAF_XGE_INT_SRC_0_REG + port * 4);\n\tp[18] = dsaf_read_dev(ddev, DSAF_PPE_INT_SRC_0_REG + port * 4);\n\tp[19] =  dsaf_read_dev(ddev, DSAF_ROCEE_INT_SRC_0_REG + port * 4);\n\tp[20] = dsaf_read_dev(ddev, DSAF_XGE_INT_STS_0_REG + port * 4);\n\tp[21] = dsaf_read_dev(ddev, DSAF_PPE_INT_STS_0_REG + port * 4);\n\tp[22] = dsaf_read_dev(ddev, DSAF_ROCEE_INT_STS_0_REG + port * 4);\n\tp[23] = dsaf_read_dev(ddev, DSAF_PPE_QID_CFG_0_REG + port * 4);\n\n\tfor (i = 0; i < DSAF_SW_PORT_NUM; i++)\n\t\tp[24 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SW_PORT_TYPE_0_REG + i * 4);\n\n\tp[32] = dsaf_read_dev(ddev, DSAF_MIX_DEF_QID_0_REG + port * 4);\n\n\tfor (i = 0; i < DSAF_SW_PORT_NUM; i++)\n\t\tp[33 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_PORT_DEF_VLAN_0_REG + i * 4);\n\n\tfor (i = 0; i < DSAF_TOTAL_QUEUE_NUM; i++)\n\t\tp[41 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_VM_DEF_VLAN_0_REG + i * 4);\n\n\t \n\tp[170] = dsaf_read_dev(ddev, DSAF_INODE_CUT_THROUGH_CFG_0_REG);\n\n\tp[171] = dsaf_read_dev(ddev,\n\t\t\tDSAF_INODE_ECC_ERR_ADDR_0_REG + port * 0x80);\n\n\tfor (i = 0; i < DSAF_INODE_NUM / DSAF_COMM_CHN; i++) {\n\t\tj = i * DSAF_COMM_CHN + port;\n\t\tp[172 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_IN_PORT_NUM_0_REG + j * 0x80);\n\t\tp[175 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_PRI_TC_CFG_0_REG + j * 0x80);\n\t\tp[178 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_BP_STATUS_0_REG + j * 0x80);\n\t\tp[181 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_PAD_DISCARD_NUM_0_REG + j * 0x80);\n\t\tp[184 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_FINAL_IN_MAN_NUM_0_REG + j * 0x80);\n\t\tp[187 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_FINAL_IN_PKT_NUM_0_REG + j * 0x80);\n\t\tp[190 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_SBM_PID_NUM_0_REG + j * 0x80);\n\t\treg_tmp = is_ver1 ? DSAF_INODE_FINAL_IN_PAUSE_NUM_0_REG :\n\t\t\t\t    DSAFV2_INODE_FINAL_IN_PAUSE_NUM_0_REG;\n\t\tp[193 + i] = dsaf_read_dev(ddev, reg_tmp + j * 0x80);\n\t\tp[196 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_SBM_RELS_NUM_0_REG + j * 0x80);\n\t\tp[199 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_SBM_DROP_NUM_0_REG + j * 0x80);\n\t\tp[202 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_CRC_FALSE_NUM_0_REG + j * 0x80);\n\t\tp[205 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_BP_DISCARD_NUM_0_REG + j * 0x80);\n\t\tp[208 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_RSLT_DISCARD_NUM_0_REG + j * 0x80);\n\t\tp[211 + i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_INODE_LOCAL_ADDR_FALSE_NUM_0_REG + j * 0x80);\n\t\tp[214 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_VOQ_OVER_NUM_0_REG + j * 0x80);\n\t\tp[217 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_BD_SAVE_STATUS_0_REG + j * 4);\n\t\tp[220 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_BD_ORDER_STATUS_0_REG + j * 4);\n\t\tp[223 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_SW_VLAN_TAG_DISC_0_REG + j * 4);\n\t\tp[226 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_IN_DATA_STP_DISC_0_REG + j * 4);\n\t}\n\n\tp[229] = dsaf_read_dev(ddev, DSAF_INODE_GE_FC_EN_0_REG + port * 4);\n\n\tfor (i = 0; i < DSAF_INODE_NUM / DSAF_COMM_CHN; i++) {\n\t\tj = i * DSAF_COMM_CHN + port;\n\t\tp[230 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_INODE_VC0_IN_PKT_NUM_0_REG + j * 4);\n\t}\n\n\tp[233] = dsaf_read_dev(ddev,\n\t\tDSAF_INODE_VC1_IN_PKT_NUM_0_REG + port * 0x80);\n\n\t \n\tfor (i = 0; i < HNS_DSAF_SBM_NUM(ddev) / DSAF_COMM_CHN; i++) {\n\t\tj = i * DSAF_COMM_CHN + port;\n\t\tp[234 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_CFG_REG_0_REG + j * 0x80);\n\t\tp[237 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_BP_CFG_0_XGE_REG_0_REG + j * 0x80);\n\t\tp[240 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_BP_CFG_1_REG_0_REG + j * 0x80);\n\t\tp[243 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_BP_CFG_2_XGE_REG_0_REG + j * 0x80);\n\t\tp[246 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_FREE_CNT_0_0_REG + j * 0x80);\n\t\tp[249 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_FREE_CNT_1_0_REG + j * 0x80);\n\t\tp[252 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_BP_CNT_0_0_REG + j * 0x80);\n\t\tp[255 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_BP_CNT_1_0_REG + j * 0x80);\n\t\tp[258 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_BP_CNT_2_0_REG + j * 0x80);\n\t\tp[261 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_BP_CNT_3_0_REG + j * 0x80);\n\t\tp[264 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_INER_ST_0_REG + j * 0x80);\n\t\tp[267 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_MIB_REQ_FAILED_TC_0_REG + j * 0x80);\n\t\tp[270 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_INPORT_CNT_0_REG + j * 0x80);\n\t\tp[273 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_DROP_CNT_0_REG + j * 0x80);\n\t\tp[276 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_INF_OUTPORT_CNT_0_REG + j * 0x80);\n\t\tp[279 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_INPORT_TC0_CNT_0_REG + j * 0x80);\n\t\tp[282 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_INPORT_TC1_CNT_0_REG + j * 0x80);\n\t\tp[285 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_INPORT_TC2_CNT_0_REG + j * 0x80);\n\t\tp[288 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_INPORT_TC3_CNT_0_REG + j * 0x80);\n\t\tp[291 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_INPORT_TC4_CNT_0_REG + j * 0x80);\n\t\tp[294 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_INPORT_TC5_CNT_0_REG + j * 0x80);\n\t\tp[297 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_INPORT_TC6_CNT_0_REG + j * 0x80);\n\t\tp[300 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_INPORT_TC7_CNT_0_REG + j * 0x80);\n\t\tp[303 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_REQ_CNT_0_REG + j * 0x80);\n\t\tp[306 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_LNK_RELS_CNT_0_REG + j * 0x80);\n\t\tp[309 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_BP_CFG_3_REG_0_REG + j * 0x80);\n\t\tp[312 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_SBM_BP_CFG_4_REG_0_REG + j * 0x80);\n\t}\n\n\t \n\tfor (i = 0; i < DSAF_XOD_NUM; i++) {\n\t\tp[315 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_ETS_TSA_TC0_TC3_CFG_0_REG + i * 0x90);\n\t\tp[323 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_ETS_TSA_TC4_TC7_CFG_0_REG + i * 0x90);\n\t\tp[331 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_ETS_BW_TC0_TC3_CFG_0_REG + i * 0x90);\n\t\tp[339 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_ETS_BW_TC4_TC7_CFG_0_REG + i * 0x90);\n\t\tp[347 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_ETS_BW_OFFSET_CFG_0_REG + i * 0x90);\n\t\tp[355 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_ETS_TOKEN_CFG_0_REG + i * 0x90);\n\t}\n\n\tp[363] = dsaf_read_dev(ddev, DSAF_XOD_PFS_CFG_0_0_REG + port * 0x90);\n\tp[364] = dsaf_read_dev(ddev, DSAF_XOD_PFS_CFG_1_0_REG + port * 0x90);\n\tp[365] = dsaf_read_dev(ddev, DSAF_XOD_PFS_CFG_2_0_REG + port * 0x90);\n\n\tfor (i = 0; i < DSAF_XOD_BIG_NUM / DSAF_COMM_CHN; i++) {\n\t\tj = i * DSAF_COMM_CHN + port;\n\t\tp[366 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_GNT_L_0_REG + j * 0x90);\n\t\tp[369 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_GNT_H_0_REG + j * 0x90);\n\t\tp[372 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_CONNECT_STATE_0_REG + j * 0x90);\n\t\tp[375 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_RCVPKT_CNT_0_REG + j * 0x90);\n\t\tp[378 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_RCVTC0_CNT_0_REG + j * 0x90);\n\t\tp[381 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_RCVTC1_CNT_0_REG + j * 0x90);\n\t\tp[384 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_RCVTC2_CNT_0_REG + j * 0x90);\n\t\tp[387 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_RCVTC3_CNT_0_REG + j * 0x90);\n\t\tp[390 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_RCVVC0_CNT_0_REG + j * 0x90);\n\t\tp[393 + i] = dsaf_read_dev(ddev,\n\t\t\t\tDSAF_XOD_RCVVC1_CNT_0_REG + j * 0x90);\n\t}\n\n\tp[396] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_XGE_RCVIN0_CNT_0_REG + port * 0x90);\n\tp[397] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_XGE_RCVIN1_CNT_0_REG + port * 0x90);\n\tp[398] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_XGE_RCVIN2_CNT_0_REG + port * 0x90);\n\tp[399] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_XGE_RCVIN3_CNT_0_REG + port * 0x90);\n\tp[400] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_XGE_RCVIN4_CNT_0_REG + port * 0x90);\n\tp[401] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_XGE_RCVIN5_CNT_0_REG + port * 0x90);\n\tp[402] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_XGE_RCVIN6_CNT_0_REG + port * 0x90);\n\tp[403] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_XGE_RCVIN7_CNT_0_REG + port * 0x90);\n\tp[404] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_PPE_RCVIN0_CNT_0_REG + port * 0x90);\n\tp[405] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_PPE_RCVIN1_CNT_0_REG + port * 0x90);\n\tp[406] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_ROCEE_RCVIN0_CNT_0_REG + port * 0x90);\n\tp[407] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_ROCEE_RCVIN1_CNT_0_REG + port * 0x90);\n\tp[408] = dsaf_read_dev(ddev,\n\t\tDSAF_XOD_FIFO_STATUS_0_REG + port * 0x90);\n\n\t \n\tfor (i = 0; i < DSAF_VOQ_NUM / DSAF_COMM_CHN; i++) {\n\t\tj = (i * DSAF_COMM_CHN + port) * 0x90;\n\t\tp[409 + i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_VOQ_ECC_INVERT_EN_0_REG + j);\n\t\tp[412 + i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_VOQ_SRAM_PKT_NUM_0_REG + j);\n\t\tp[415 + i] = dsaf_read_dev(ddev, DSAF_VOQ_IN_PKT_NUM_0_REG + j);\n\t\tp[418 + i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_VOQ_OUT_PKT_NUM_0_REG + j);\n\t\tp[421 + i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_VOQ_ECC_ERR_ADDR_0_REG + j);\n\t\tp[424 + i] = dsaf_read_dev(ddev, DSAF_VOQ_BP_STATUS_0_REG + j);\n\t\tp[427 + i] = dsaf_read_dev(ddev, DSAF_VOQ_SPUP_IDLE_0_REG + j);\n\t\tp[430 + i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_VOQ_XGE_XOD_REQ_0_0_REG + j);\n\t\tp[433 + i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_VOQ_XGE_XOD_REQ_1_0_REG + j);\n\t\tp[436 + i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_VOQ_PPE_XOD_REQ_0_REG + j);\n\t\tp[439 + i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_VOQ_ROCEE_XOD_REQ_0_REG + j);\n\t\tp[442 + i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_VOQ_BP_ALL_THRD_0_REG + j);\n\t}\n\n\t \n\tp[445] = dsaf_read_dev(ddev, DSAF_TBL_CTRL_0_REG);\n\tp[446] = dsaf_read_dev(ddev, DSAF_TBL_INT_MSK_0_REG);\n\tp[447] = dsaf_read_dev(ddev, DSAF_TBL_INT_SRC_0_REG);\n\tp[448] = dsaf_read_dev(ddev, DSAF_TBL_INT_STS_0_REG);\n\tp[449] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_ADDR_0_REG);\n\tp[450] = dsaf_read_dev(ddev, DSAF_TBL_LINE_ADDR_0_REG);\n\tp[451] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_HIGH_0_REG);\n\tp[452] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_LOW_0_REG);\n\tp[453] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_MCAST_CFG_4_0_REG);\n\tp[454] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_MCAST_CFG_3_0_REG);\n\tp[455] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_MCAST_CFG_2_0_REG);\n\tp[456] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_MCAST_CFG_1_0_REG);\n\tp[457] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_MCAST_CFG_0_0_REG);\n\tp[458] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_UCAST_CFG_0_REG);\n\tp[459] = dsaf_read_dev(ddev, DSAF_TBL_LIN_CFG_0_REG);\n\tp[460] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RDATA_HIGH_0_REG);\n\tp[461] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RDATA_LOW_0_REG);\n\tp[462] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RAM_RDATA4_0_REG);\n\tp[463] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RAM_RDATA3_0_REG);\n\tp[464] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RAM_RDATA2_0_REG);\n\tp[465] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RAM_RDATA1_0_REG);\n\tp[466] = dsaf_read_dev(ddev, DSAF_TBL_TCAM_RAM_RDATA0_0_REG);\n\tp[467] = dsaf_read_dev(ddev, DSAF_TBL_LIN_RDATA_0_REG);\n\n\tfor (i = 0; i < DSAF_SW_PORT_NUM; i++) {\n\t\tj = i * 0x8;\n\t\tp[468 + 2 * i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_TBL_DA0_MIS_INFO1_0_REG + j);\n\t\tp[469 + 2 * i] = dsaf_read_dev(ddev,\n\t\t\tDSAF_TBL_DA0_MIS_INFO0_0_REG + j);\n\t}\n\n\tp[484] = dsaf_read_dev(ddev, DSAF_TBL_SA_MIS_INFO2_0_REG);\n\tp[485] = dsaf_read_dev(ddev, DSAF_TBL_SA_MIS_INFO1_0_REG);\n\tp[486] = dsaf_read_dev(ddev, DSAF_TBL_SA_MIS_INFO0_0_REG);\n\tp[487] = dsaf_read_dev(ddev, DSAF_TBL_PUL_0_REG);\n\tp[488] = dsaf_read_dev(ddev, DSAF_TBL_OLD_RSLT_0_REG);\n\tp[489] = dsaf_read_dev(ddev, DSAF_TBL_OLD_SCAN_VAL_0_REG);\n\tp[490] = dsaf_read_dev(ddev, DSAF_TBL_DFX_CTRL_0_REG);\n\tp[491] = dsaf_read_dev(ddev, DSAF_TBL_DFX_STAT_0_REG);\n\tp[492] = dsaf_read_dev(ddev, DSAF_TBL_DFX_STAT_2_0_REG);\n\tp[493] = dsaf_read_dev(ddev, DSAF_TBL_LKUP_NUM_I_0_REG);\n\tp[494] = dsaf_read_dev(ddev, DSAF_TBL_LKUP_NUM_O_0_REG);\n\tp[495] = dsaf_read_dev(ddev, DSAF_TBL_UCAST_BCAST_MIS_INFO_0_0_REG);\n\n\t \n\tp[496] = dsaf_read_dev(ddev, DSAF_INODE_FIFO_WL_0_REG + port * 0x4);\n\tp[497] = dsaf_read_dev(ddev, DSAF_ONODE_FIFO_WL_0_REG + port * 0x4);\n\tp[498] = dsaf_read_dev(ddev, DSAF_XGE_GE_WORK_MODE_0_REG + port * 0x4);\n\tp[499] = dsaf_read_dev(ddev,\n\t\tDSAF_XGE_APP_RX_LINK_UP_0_REG + port * 0x4);\n\tp[500] = dsaf_read_dev(ddev, DSAF_NETPORT_CTRL_SIG_0_REG + port * 0x4);\n\tp[501] = dsaf_read_dev(ddev, DSAF_XGE_CTRL_SIG_CFG_0_REG + port * 0x4);\n\n\tif (!is_ver1)\n\t\tp[502] = dsaf_read_dev(ddev, DSAF_PAUSE_CFG_REG + port * 0x4);\n\n\t \n\tfor (i = 503; i < 504; i++)\n\t\tp[i] = 0xdddddddd;\n}\n\nstatic char *hns_dsaf_get_node_stats_strings(char *data, int node,\n\t\t\t\t\t     struct dsaf_device *dsaf_dev)\n{\n\tchar *buff = data;\n\tint i;\n\tbool is_ver1 = AE_IS_VER1(dsaf_dev->dsaf_ver);\n\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_pad_drop_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_manage_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_rx_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_rx_pkt_id\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_rx_pause_frame\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_release_buf_num\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_sbm_drop_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_crc_false_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_bp_drop_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_lookup_rslt_drop_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_local_rslt_fail_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_vlan_drop_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tsnprintf(buff, ETH_GSTRING_LEN, \"innod%d_stp_drop_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\tif (node < DSAF_SERVICE_NW_NUM && !is_ver1) {\n\t\tfor (i = 0; i < DSAF_PRIO_NR; i++) {\n\t\t\tsnprintf(buff + 0 * ETH_GSTRING_LEN * DSAF_PRIO_NR,\n\t\t\t\t ETH_GSTRING_LEN, \"inod%d_pfc_prio%d_pkts\",\n\t\t\t\t node, i);\n\t\t\tsnprintf(buff + 1 * ETH_GSTRING_LEN * DSAF_PRIO_NR,\n\t\t\t\t ETH_GSTRING_LEN, \"onod%d_pfc_prio%d_pkts\",\n\t\t\t\t node, i);\n\t\t\tbuff += ETH_GSTRING_LEN;\n\t\t}\n\t\tbuff += 1 * DSAF_PRIO_NR * ETH_GSTRING_LEN;\n\t}\n\tsnprintf(buff, ETH_GSTRING_LEN, \"onnod%d_tx_pkts\", node);\n\tbuff += ETH_GSTRING_LEN;\n\n\treturn buff;\n}\n\nstatic u64 *hns_dsaf_get_node_stats(struct dsaf_device *ddev, u64 *data,\n\t\t\t\t    int node_num)\n{\n\tu64 *p = data;\n\tint i;\n\tstruct dsaf_hw_stats *hw_stats = &ddev->hw_stats[node_num];\n\tbool is_ver1 = AE_IS_VER1(ddev->dsaf_ver);\n\n\tp[0] = hw_stats->pad_drop;\n\tp[1] = hw_stats->man_pkts;\n\tp[2] = hw_stats->rx_pkts;\n\tp[3] = hw_stats->rx_pkt_id;\n\tp[4] = hw_stats->rx_pause_frame;\n\tp[5] = hw_stats->release_buf_num;\n\tp[6] = hw_stats->sbm_drop;\n\tp[7] = hw_stats->crc_false;\n\tp[8] = hw_stats->bp_drop;\n\tp[9] = hw_stats->rslt_drop;\n\tp[10] = hw_stats->local_addr_false;\n\tp[11] = hw_stats->vlan_drop;\n\tp[12] = hw_stats->stp_drop;\n\tif (node_num < DSAF_SERVICE_NW_NUM && !is_ver1) {\n\t\tfor (i = 0; i < DSAF_PRIO_NR; i++) {\n\t\t\tp[13 + i + 0 * DSAF_PRIO_NR] = hw_stats->rx_pfc[i];\n\t\t\tp[13 + i + 1 * DSAF_PRIO_NR] = hw_stats->tx_pfc[i];\n\t\t}\n\t\tp[29] = hw_stats->tx_pkts;\n\t\treturn &p[30];\n\t}\n\n\tp[13] = hw_stats->tx_pkts;\n\treturn &p[14];\n}\n\n \nvoid hns_dsaf_get_stats(struct dsaf_device *ddev, u64 *data, int port)\n{\n\tu64 *p = data;\n\tint node_num = port;\n\n\t \n\tp = hns_dsaf_get_node_stats(ddev, p, node_num);\n\n\t \n\tnode_num = port + DSAF_PPE_INODE_BASE;\n\t(void)hns_dsaf_get_node_stats(ddev, p, node_num);\n}\n\n \nint hns_dsaf_get_sset_count(struct dsaf_device *dsaf_dev, int stringset)\n{\n\tbool is_ver1 = AE_IS_VER1(dsaf_dev->dsaf_ver);\n\n\tif (stringset == ETH_SS_STATS) {\n\t\tif (is_ver1)\n\t\t\treturn DSAF_STATIC_NUM;\n\t\telse\n\t\t\treturn DSAF_V2_STATIC_NUM;\n\t}\n\treturn 0;\n}\n\n \nvoid hns_dsaf_get_strings(int stringset, u8 *data, int port,\n\t\t\t  struct dsaf_device *dsaf_dev)\n{\n\tchar *buff = (char *)data;\n\tint node = port;\n\n\tif (stringset != ETH_SS_STATS)\n\t\treturn;\n\n\t \n\tbuff = hns_dsaf_get_node_stats_strings(buff, node, dsaf_dev);\n\n\t \n\tnode = port + DSAF_PPE_INODE_BASE;\n\t(void)hns_dsaf_get_node_stats_strings(buff, node, dsaf_dev);\n}\n\n \nint hns_dsaf_get_regs_count(void)\n{\n\treturn DSAF_DUMP_REGS_NUM;\n}\n\nstatic int hns_dsaf_get_port_id(u8 port)\n{\n\tif (port < DSAF_SERVICE_NW_NUM)\n\t\treturn port;\n\n\tif (port >= DSAF_BASE_INNER_PORT_NUM)\n\t\treturn port - DSAF_BASE_INNER_PORT_NUM + DSAF_SERVICE_NW_NUM;\n\n\treturn -EINVAL;\n}\n\nstatic void set_promisc_tcam_enable(struct dsaf_device *dsaf_dev, u32 port)\n{\n\tstruct dsaf_tbl_tcam_ucast_cfg tbl_tcam_ucast = {0, 1, 0, 0, 0x80};\n\tstruct dsaf_tbl_tcam_data tbl_tcam_data_mc = {0x01000000, port};\n\tstruct dsaf_tbl_tcam_data tbl_tcam_mask_uc = {0x01000000, 0xf};\n\tstruct dsaf_tbl_tcam_mcast_cfg tbl_tcam_mcast = {0, 0, {0} };\n\tstruct dsaf_drv_priv *priv = hns_dsaf_dev_priv(dsaf_dev);\n\tstruct dsaf_tbl_tcam_data tbl_tcam_data_uc = {0, port};\n\tstruct dsaf_drv_mac_single_dest_entry mask_entry;\n\tstruct dsaf_drv_tbl_tcam_key temp_key, mask_key;\n\tstruct dsaf_drv_soft_mac_tbl *soft_mac_entry;\n\tu16 entry_index;\n\tstruct dsaf_drv_tbl_tcam_key mac_key;\n\tstruct hns_mac_cb *mac_cb;\n\tu8 addr[ETH_ALEN] = {0};\n\tu8 port_num;\n\tint mskid;\n\n\t \n\thns_dsaf_set_mac_key(dsaf_dev, &mac_key, 0x00, port, addr);\n\tentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\n\tif (entry_index != DSAF_INVALID_ENTRY_IDX)\n\t\treturn;\n\n\t \n\t \n\tentry_index = hns_dsaf_find_empty_mac_entry_reverse(dsaf_dev);\n\tif (entry_index == DSAF_INVALID_ENTRY_IDX) {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"enable uc promisc failed (port:%#x)\\n\",\n\t\t\tport);\n\t\treturn;\n\t}\n\n\tmac_cb = dsaf_dev->mac_cb[port];\n\t(void)hns_mac_get_inner_port_num(mac_cb, 0, &port_num);\n\ttbl_tcam_ucast.tbl_ucast_out_port = port_num;\n\n\t \n\thns_dsaf_tcam_uc_cfg_vague(dsaf_dev, entry_index, &tbl_tcam_data_uc,\n\t\t\t\t   &tbl_tcam_mask_uc, &tbl_tcam_ucast);\n\n\t \n\tsoft_mac_entry = priv->soft_mac_tbl;\n\tsoft_mac_entry += entry_index;\n\tsoft_mac_entry->index = entry_index;\n\tsoft_mac_entry->tcam_key.high.val = mac_key.high.val;\n\tsoft_mac_entry->tcam_key.low.val = mac_key.low.val;\n\t \n\tsoft_mac_entry = priv->soft_mac_tbl;\n\n\t \n\tentry_index = hns_dsaf_find_empty_mac_entry_reverse(dsaf_dev);\n\tif (entry_index == DSAF_INVALID_ENTRY_IDX) {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"enable mc promisc failed (port:%#x)\\n\",\n\t\t\tport);\n\t\treturn;\n\t}\n\n\tmemset(&mask_entry, 0x0, sizeof(mask_entry));\n\tmemset(&mask_key, 0x0, sizeof(mask_key));\n\tmemset(&temp_key, 0x0, sizeof(temp_key));\n\tmask_entry.addr[0] = 0x01;\n\thns_dsaf_set_mac_key(dsaf_dev, &mask_key, mask_entry.in_vlan_id,\n\t\t\t     0xf, mask_entry.addr);\n\ttbl_tcam_mcast.tbl_mcast_item_vld = 1;\n\ttbl_tcam_mcast.tbl_mcast_old_en = 0;\n\n\t \n\tmskid = hns_dsaf_get_port_id(port);\n\tif (mskid == -EINVAL) {\n\t\tdev_err(dsaf_dev->dev, \"%s,pnum(%d)error,key(%#x:%#x)\\n\",\n\t\t\tdsaf_dev->ae_dev.name, port,\n\t\t\tmask_key.high.val, mask_key.low.val);\n\t\treturn;\n\t}\n\tdsaf_set_bit(tbl_tcam_mcast.tbl_mcast_port_msk[mskid / 32],\n\t\t     mskid % 32, 1);\n\n\t \n\tmskid = hns_dsaf_get_port_id(port_num);\n\tif (mskid == -EINVAL) {\n\t\tdev_err(dsaf_dev->dev,\n\t\t\t\"%s, pool bit map pnum(%d)error,key(%#x:%#x)\\n\",\n\t\t\tdsaf_dev->ae_dev.name, port_num,\n\t\t\tmask_key.high.val, mask_key.low.val);\n\t\treturn;\n\t}\n\tdsaf_set_bit(tbl_tcam_mcast.tbl_mcast_port_msk[mskid / 32],\n\t\t     mskid % 32, 1);\n\n\tmemcpy(&temp_key, &mask_key, sizeof(mask_key));\n\thns_dsaf_tcam_mc_cfg_vague(dsaf_dev, entry_index, &tbl_tcam_data_mc,\n\t\t\t\t   (struct dsaf_tbl_tcam_data *)(&mask_key),\n\t\t\t\t   &tbl_tcam_mcast);\n\n\t \n\tsoft_mac_entry += entry_index;\n\tsoft_mac_entry->index = entry_index;\n\tsoft_mac_entry->tcam_key.high.val = temp_key.high.val;\n\tsoft_mac_entry->tcam_key.low.val = temp_key.low.val;\n}\n\nstatic void set_promisc_tcam_disable(struct dsaf_device *dsaf_dev, u32 port)\n{\n\tstruct dsaf_tbl_tcam_data tbl_tcam_data_mc = {0x01000000, port};\n\tstruct dsaf_tbl_tcam_ucast_cfg tbl_tcam_ucast = {0, 0, 0, 0, 0};\n\tstruct dsaf_tbl_tcam_mcast_cfg tbl_tcam_mcast = {0, 0, {0} };\n\tstruct dsaf_drv_priv *priv = hns_dsaf_dev_priv(dsaf_dev);\n\tstruct dsaf_tbl_tcam_data tbl_tcam_data_uc = {0, 0};\n\tstruct dsaf_tbl_tcam_data tbl_tcam_mask = {0, 0};\n\tstruct dsaf_drv_soft_mac_tbl *soft_mac_entry;\n\tu16 entry_index;\n\tstruct dsaf_drv_tbl_tcam_key mac_key;\n\tu8 addr[ETH_ALEN] = {0};\n\n\t \n\t \n\thns_dsaf_set_mac_key(dsaf_dev, &mac_key, 0x00, port, addr);\n\tentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\n\n\tif (entry_index == DSAF_INVALID_ENTRY_IDX)\n\t\treturn;\n\n\t \n\thns_dsaf_tcam_uc_cfg_vague(dsaf_dev, entry_index, &tbl_tcam_data_uc,\n\t\t\t\t   &tbl_tcam_mask, &tbl_tcam_ucast);\n\t \n\tsoft_mac_entry = priv->soft_mac_tbl;\n\tsoft_mac_entry += entry_index;\n\tsoft_mac_entry->index = DSAF_INVALID_ENTRY_IDX;\n\t \n\tsoft_mac_entry = priv->soft_mac_tbl;\n\n\t \n\taddr[0] = 0x01;\n\tmemset(&mac_key, 0x0, sizeof(mac_key));\n\thns_dsaf_set_mac_key(dsaf_dev, &mac_key, 0x00, port, addr);\n\tentry_index = hns_dsaf_find_soft_mac_entry(dsaf_dev, &mac_key);\n\n\tif (entry_index == DSAF_INVALID_ENTRY_IDX)\n\t\treturn;\n\n\t \n\thns_dsaf_tcam_mc_cfg_vague(dsaf_dev, entry_index, &tbl_tcam_data_mc,\n\t\t\t\t   &tbl_tcam_mask, &tbl_tcam_mcast);\n\t \n\tsoft_mac_entry += entry_index;\n\tsoft_mac_entry->index = DSAF_INVALID_ENTRY_IDX;\n}\n\n \nvoid hns_dsaf_set_promisc_tcam(struct dsaf_device *dsaf_dev,\n\t\t\t       u32 port, bool enable)\n{\n\tif (enable)\n\t\tset_promisc_tcam_enable(dsaf_dev, port);\n\telse\n\t\tset_promisc_tcam_disable(dsaf_dev, port);\n}\n\nint hns_dsaf_wait_pkt_clean(struct dsaf_device *dsaf_dev, int port)\n{\n\tu32 val, val_tmp;\n\tint wait_cnt;\n\n\tif (port >= DSAF_SERVICE_NW_NUM)\n\t\treturn 0;\n\n\twait_cnt = 0;\n\twhile (wait_cnt++ < HNS_MAX_WAIT_CNT) {\n\t\tval = dsaf_read_dev(dsaf_dev, DSAF_VOQ_IN_PKT_NUM_0_REG +\n\t\t\t(port + DSAF_XGE_NUM) * 0x40);\n\t\tval_tmp = dsaf_read_dev(dsaf_dev, DSAF_VOQ_OUT_PKT_NUM_0_REG +\n\t\t\t(port + DSAF_XGE_NUM) * 0x40);\n\t\tif (val == val_tmp)\n\t\t\tbreak;\n\n\t\tusleep_range(100, 200);\n\t}\n\n\tif (wait_cnt >= HNS_MAX_WAIT_CNT) {\n\t\tdev_err(dsaf_dev->dev, \"hns dsaf clean wait timeout(%u - %u).\\n\",\n\t\t\tval, val_tmp);\n\t\treturn -EBUSY;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int hns_dsaf_probe(struct platform_device *pdev)\n{\n\tstruct dsaf_device *dsaf_dev;\n\tint ret;\n\n\tdsaf_dev = hns_dsaf_alloc_dev(&pdev->dev, sizeof(struct dsaf_drv_priv));\n\tif (IS_ERR(dsaf_dev)) {\n\t\tret = PTR_ERR(dsaf_dev);\n\t\tdev_err(&pdev->dev,\n\t\t\t\"dsaf_probe dsaf_alloc_dev failed, ret = %#x!\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = hns_dsaf_get_cfg(dsaf_dev);\n\tif (ret)\n\t\tgoto free_dev;\n\n\tret = hns_dsaf_init(dsaf_dev);\n\tif (ret)\n\t\tgoto free_dev;\n\n\tret = hns_mac_init(dsaf_dev);\n\tif (ret)\n\t\tgoto uninit_dsaf;\n\n\tret = hns_ppe_init(dsaf_dev);\n\tif (ret)\n\t\tgoto uninit_mac;\n\n\tret = hns_dsaf_ae_init(dsaf_dev);\n\tif (ret)\n\t\tgoto uninit_ppe;\n\n\treturn 0;\n\nuninit_ppe:\n\thns_ppe_uninit(dsaf_dev);\n\nuninit_mac:\n\thns_mac_uninit(dsaf_dev);\n\nuninit_dsaf:\n\thns_dsaf_free(dsaf_dev);\n\nfree_dev:\n\thns_dsaf_free_dev(dsaf_dev);\n\n\treturn ret;\n}\n\n \nstatic int hns_dsaf_remove(struct platform_device *pdev)\n{\n\tstruct dsaf_device *dsaf_dev = dev_get_drvdata(&pdev->dev);\n\n\thns_dsaf_ae_uninit(dsaf_dev);\n\n\thns_ppe_uninit(dsaf_dev);\n\n\thns_mac_uninit(dsaf_dev);\n\n\thns_dsaf_free(dsaf_dev);\n\n\thns_dsaf_free_dev(dsaf_dev);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id g_dsaf_match[] = {\n\t{.compatible = \"hisilicon,hns-dsaf-v1\"},\n\t{.compatible = \"hisilicon,hns-dsaf-v2\"},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, g_dsaf_match);\n\nstatic struct platform_driver g_dsaf_driver = {\n\t.probe = hns_dsaf_probe,\n\t.remove = hns_dsaf_remove,\n\t.driver = {\n\t\t.name = DSAF_DRV_NAME,\n\t\t.of_match_table = g_dsaf_match,\n\t\t.acpi_match_table = hns_dsaf_acpi_match,\n\t},\n};\n\nmodule_platform_driver(g_dsaf_driver);\n\n \nint hns_dsaf_roce_reset(struct fwnode_handle *dsaf_fwnode, bool dereset)\n{\n\tstruct dsaf_device *dsaf_dev;\n\tstruct platform_device *pdev;\n\tu32 mp;\n\tu32 sl;\n\tu32 credit;\n\tint i;\n\tstatic const u32 port_map[DSAF_ROCE_CREDIT_CHN][DSAF_ROCE_CHAN_MODE_NUM] = {\n\t\t{DSAF_ROCE_PORT_0, DSAF_ROCE_PORT_0, DSAF_ROCE_PORT_0},\n\t\t{DSAF_ROCE_PORT_1, DSAF_ROCE_PORT_0, DSAF_ROCE_PORT_0},\n\t\t{DSAF_ROCE_PORT_2, DSAF_ROCE_PORT_1, DSAF_ROCE_PORT_0},\n\t\t{DSAF_ROCE_PORT_3, DSAF_ROCE_PORT_1, DSAF_ROCE_PORT_0},\n\t\t{DSAF_ROCE_PORT_4, DSAF_ROCE_PORT_2, DSAF_ROCE_PORT_1},\n\t\t{DSAF_ROCE_PORT_4, DSAF_ROCE_PORT_2, DSAF_ROCE_PORT_1},\n\t\t{DSAF_ROCE_PORT_5, DSAF_ROCE_PORT_3, DSAF_ROCE_PORT_1},\n\t\t{DSAF_ROCE_PORT_5, DSAF_ROCE_PORT_3, DSAF_ROCE_PORT_1},\n\t};\n\tstatic const u32 sl_map[DSAF_ROCE_CREDIT_CHN][DSAF_ROCE_CHAN_MODE_NUM] = {\n\t\t{DSAF_ROCE_SL_0, DSAF_ROCE_SL_0, DSAF_ROCE_SL_0},\n\t\t{DSAF_ROCE_SL_0, DSAF_ROCE_SL_1, DSAF_ROCE_SL_1},\n\t\t{DSAF_ROCE_SL_0, DSAF_ROCE_SL_0, DSAF_ROCE_SL_2},\n\t\t{DSAF_ROCE_SL_0, DSAF_ROCE_SL_1, DSAF_ROCE_SL_3},\n\t\t{DSAF_ROCE_SL_0, DSAF_ROCE_SL_0, DSAF_ROCE_SL_0},\n\t\t{DSAF_ROCE_SL_1, DSAF_ROCE_SL_1, DSAF_ROCE_SL_1},\n\t\t{DSAF_ROCE_SL_0, DSAF_ROCE_SL_0, DSAF_ROCE_SL_2},\n\t\t{DSAF_ROCE_SL_1, DSAF_ROCE_SL_1, DSAF_ROCE_SL_3},\n\t};\n\n\t \n\tif (is_of_node(dsaf_fwnode)) {\n\t\tpdev = of_find_device_by_node(to_of_node(dsaf_fwnode));\n\t} else if (is_acpi_device_node(dsaf_fwnode)) {\n\t\tpdev = hns_dsaf_find_platform_device(dsaf_fwnode);\n\t} else {\n\t\tpr_err(\"fwnode is neither OF or ACPI type\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (!pdev) {\n\t\tpr_err(\"couldn't find platform device for node\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tdsaf_dev = dev_get_drvdata(&pdev->dev);\n\tif (!dsaf_dev) {\n\t\tdev_err(&pdev->dev, \"dsaf_dev is NULL\\n\");\n\t\tput_device(&pdev->dev);\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tif (AE_IS_VER1(dsaf_dev->dsaf_ver)) {\n\t\tdev_err(dsaf_dev->dev, \"%s v1 chip doesn't support RoCE!\\n\",\n\t\t\tdsaf_dev->ae_dev.name);\n\t\tput_device(&pdev->dev);\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tif (!dereset) {\n\t\t \n\t\tdsaf_dev->misc_op->hns_dsaf_srst_chns(dsaf_dev, DSAF_CHNS_MASK,\n\t\t\t\t\t\t      false);\n\t\tdsaf_dev->misc_op->hns_dsaf_roce_srst(dsaf_dev, false);\n\t} else {\n\t\t \n\t\tmp = dsaf_read_dev(dsaf_dev, DSAF_ROCE_PORT_MAP_REG);\n\t\tfor (i = 0; i < DSAF_ROCE_CREDIT_CHN; i++)\n\t\t\tdsaf_set_field(mp, 7 << i * 3, i * 3,\n\t\t\t\t       port_map[i][DSAF_ROCE_6PORT_MODE]);\n\t\tdsaf_set_field(mp, 3 << i * 3, i * 3, 0);\n\t\tdsaf_write_dev(dsaf_dev, DSAF_ROCE_PORT_MAP_REG, mp);\n\n\t\tsl = dsaf_read_dev(dsaf_dev, DSAF_ROCE_SL_MAP_REG);\n\t\tfor (i = 0; i < DSAF_ROCE_CREDIT_CHN; i++)\n\t\t\tdsaf_set_field(sl, 3 << i * 2, i * 2,\n\t\t\t\t       sl_map[i][DSAF_ROCE_6PORT_MODE]);\n\t\tdsaf_write_dev(dsaf_dev, DSAF_ROCE_SL_MAP_REG, sl);\n\n\t\t \n\t\tdsaf_dev->misc_op->hns_dsaf_srst_chns(dsaf_dev, DSAF_CHNS_MASK,\n\t\t\t\t\t\t      true);\n\t\tmsleep(SRST_TIME_INTERVAL);\n\t\tdsaf_dev->misc_op->hns_dsaf_roce_srst(dsaf_dev, true);\n\n\t\t \n\t\tcredit = dsaf_read_dev(dsaf_dev, DSAF_SBM_ROCEE_CFG_REG_REG);\n\t\tdsaf_set_bit(credit, DSAF_SBM_ROCEE_CFG_CRD_EN_B, 0);\n\t\tdsaf_write_dev(dsaf_dev, DSAF_SBM_ROCEE_CFG_REG_REG, credit);\n\n\t\tdsaf_set_bit(credit, DSAF_SBM_ROCEE_CFG_CRD_EN_B, 1);\n\t\tdsaf_write_dev(dsaf_dev, DSAF_SBM_ROCEE_CFG_REG_REG, credit);\n\t}\n\n\tput_device(&pdev->dev);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(hns_dsaf_roce_reset);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Huawei Tech. Co., Ltd.\");\nMODULE_DESCRIPTION(\"HNS DSAF driver\");\nMODULE_VERSION(DSAF_MOD_VERSION);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}