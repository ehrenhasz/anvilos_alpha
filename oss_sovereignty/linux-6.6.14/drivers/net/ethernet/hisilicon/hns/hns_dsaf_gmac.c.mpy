{
  "module_name": "hns_dsaf_gmac.c",
  "hash_id": "7804a1862ccec088c36bb27b281783a9c08bc7d024b8abe95892dd1fc9f7f606",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/hisilicon/hns/hns_dsaf_gmac.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/of_mdio.h>\n#include \"hns_dsaf_main.h\"\n#include \"hns_dsaf_mac.h\"\n#include \"hns_dsaf_gmac.h\"\n\nstatic const struct mac_stats_string g_gmac_stats_string[] = {\n\t{\"gmac_rx_octets_total_ok\", MAC_STATS_FIELD_OFF(rx_good_bytes)},\n\t{\"gmac_rx_octets_bad\", MAC_STATS_FIELD_OFF(rx_bad_bytes)},\n\t{\"gmac_rx_uc_pkts\", MAC_STATS_FIELD_OFF(rx_uc_pkts)},\n\t{\"gmac_rx_mc_pkts\", MAC_STATS_FIELD_OFF(rx_mc_pkts)},\n\t{\"gmac_rx_bc_pkts\", MAC_STATS_FIELD_OFF(rx_bc_pkts)},\n\t{\"gmac_rx_pkts_64octets\", MAC_STATS_FIELD_OFF(rx_64bytes)},\n\t{\"gmac_rx_pkts_65to127\", MAC_STATS_FIELD_OFF(rx_65to127)},\n\t{\"gmac_rx_pkts_128to255\", MAC_STATS_FIELD_OFF(rx_128to255)},\n\t{\"gmac_rx_pkts_256to511\", MAC_STATS_FIELD_OFF(rx_256to511)},\n\t{\"gmac_rx_pkts_512to1023\", MAC_STATS_FIELD_OFF(rx_512to1023)},\n\t{\"gmac_rx_pkts_1024to1518\", MAC_STATS_FIELD_OFF(rx_1024to1518)},\n\t{\"gmac_rx_pkts_1519tomax\", MAC_STATS_FIELD_OFF(rx_1519tomax)},\n\t{\"gmac_rx_fcs_errors\", MAC_STATS_FIELD_OFF(rx_fcs_err)},\n\t{\"gmac_rx_tagged\", MAC_STATS_FIELD_OFF(rx_vlan_pkts)},\n\t{\"gmac_rx_data_err\", MAC_STATS_FIELD_OFF(rx_data_err)},\n\t{\"gmac_rx_align_errors\", MAC_STATS_FIELD_OFF(rx_align_err)},\n\t{\"gmac_rx_long_errors\", MAC_STATS_FIELD_OFF(rx_oversize)},\n\t{\"gmac_rx_jabber_errors\", MAC_STATS_FIELD_OFF(rx_jabber_err)},\n\t{\"gmac_rx_pause_maccontrol\", MAC_STATS_FIELD_OFF(rx_pfc_tc0)},\n\t{\"gmac_rx_unknown_maccontrol\", MAC_STATS_FIELD_OFF(rx_unknown_ctrl)},\n\t{\"gmac_rx_very_long_err\", MAC_STATS_FIELD_OFF(rx_long_err)},\n\t{\"gmac_rx_runt_err\", MAC_STATS_FIELD_OFF(rx_minto64)},\n\t{\"gmac_rx_short_err\", MAC_STATS_FIELD_OFF(rx_under_min)},\n\t{\"gmac_rx_filt_pkt\", MAC_STATS_FIELD_OFF(rx_filter_pkts)},\n\t{\"gmac_rx_octets_total_filt\", MAC_STATS_FIELD_OFF(rx_filter_bytes)},\n\t{\"gmac_rx_overrun_cnt\", MAC_STATS_FIELD_OFF(rx_fifo_overrun_err)},\n\t{\"gmac_rx_length_err\", MAC_STATS_FIELD_OFF(rx_len_err)},\n\t{\"gmac_rx_fail_comma\", MAC_STATS_FIELD_OFF(rx_comma_err)},\n\n\t{\"gmac_tx_octets_ok\", MAC_STATS_FIELD_OFF(tx_good_bytes)},\n\t{\"gmac_tx_octets_bad\", MAC_STATS_FIELD_OFF(tx_bad_bytes)},\n\t{\"gmac_tx_uc_pkts\", MAC_STATS_FIELD_OFF(tx_uc_pkts)},\n\t{\"gmac_tx_mc_pkts\", MAC_STATS_FIELD_OFF(tx_mc_pkts)},\n\t{\"gmac_tx_bc_pkts\", MAC_STATS_FIELD_OFF(tx_bc_pkts)},\n\t{\"gmac_tx_pkts_64octets\", MAC_STATS_FIELD_OFF(tx_64bytes)},\n\t{\"gmac_tx_pkts_65to127\", MAC_STATS_FIELD_OFF(tx_65to127)},\n\t{\"gmac_tx_pkts_128to255\", MAC_STATS_FIELD_OFF(tx_128to255)},\n\t{\"gmac_tx_pkts_256to511\", MAC_STATS_FIELD_OFF(tx_256to511)},\n\t{\"gmac_tx_pkts_512to1023\", MAC_STATS_FIELD_OFF(tx_512to1023)},\n\t{\"gmac_tx_pkts_1024to1518\", MAC_STATS_FIELD_OFF(tx_1024to1518)},\n\t{\"gmac_tx_pkts_1519tomax\", MAC_STATS_FIELD_OFF(tx_1519tomax)},\n\t{\"gmac_tx_excessive_length_drop\", MAC_STATS_FIELD_OFF(tx_jabber_err)},\n\t{\"gmac_tx_underrun\", MAC_STATS_FIELD_OFF(tx_underrun_err)},\n\t{\"gmac_tx_tagged\", MAC_STATS_FIELD_OFF(tx_vlan)},\n\t{\"gmac_tx_crc_error\", MAC_STATS_FIELD_OFF(tx_crc_err)},\n\t{\"gmac_tx_pause_frames\", MAC_STATS_FIELD_OFF(tx_pfc_tc0)}\n};\n\nstatic void hns_gmac_enable(void *mac_drv, enum mac_commom_mode mode)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\t \n\tif (mode == MAC_COMM_MODE_TX || mode == MAC_COMM_MODE_RX_AND_TX)\n\t\tdsaf_set_dev_bit(drv, GMAC_PORT_EN_REG, GMAC_PORT_TX_EN_B, 1);\n\n\tif (mode == MAC_COMM_MODE_RX || mode == MAC_COMM_MODE_RX_AND_TX) {\n\t\t \n\t\tdsaf_set_dev_bit(drv, GMAC_PCS_RX_EN_REG, 0, 0);\n\t\tdsaf_set_dev_bit(drv, GMAC_PORT_EN_REG, GMAC_PORT_RX_EN_B, 1);\n\t}\n}\n\nstatic void hns_gmac_disable(void *mac_drv, enum mac_commom_mode mode)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\t \n\tif (mode == MAC_COMM_MODE_TX || mode == MAC_COMM_MODE_RX_AND_TX)\n\t\tdsaf_set_dev_bit(drv, GMAC_PORT_EN_REG, GMAC_PORT_TX_EN_B, 0);\n\n\tif (mode == MAC_COMM_MODE_RX || mode == MAC_COMM_MODE_RX_AND_TX) {\n\t\t \n\t\tdsaf_set_dev_bit(drv, GMAC_PCS_RX_EN_REG, 0, 1);\n\t\tdsaf_set_dev_bit(drv, GMAC_PORT_EN_REG, GMAC_PORT_RX_EN_B, 0);\n\t}\n}\n\n \nstatic void hns_gmac_get_en(void *mac_drv, u32 *rx, u32 *tx)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\tu32 porten;\n\n\tporten = dsaf_read_dev(drv, GMAC_PORT_EN_REG);\n\t*tx = dsaf_get_bit(porten, GMAC_PORT_TX_EN_B);\n\t*rx = dsaf_get_bit(porten, GMAC_PORT_RX_EN_B);\n}\n\nstatic void hns_gmac_free(void *mac_drv)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\tstruct dsaf_device *dsaf_dev\n\t\t= (struct dsaf_device *)dev_get_drvdata(drv->dev);\n\n\tu32 mac_id = drv->mac_id;\n\n\tdsaf_dev->misc_op->ge_srst(dsaf_dev, mac_id, 0);\n}\n\nstatic void hns_gmac_set_tx_auto_pause_frames(void *mac_drv, u16 newval)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\tdsaf_set_dev_field(drv, GMAC_FC_TX_TIMER_REG, GMAC_FC_TX_TIMER_M,\n\t\t\t   GMAC_FC_TX_TIMER_S, newval);\n}\n\nstatic void hns_gmac_get_tx_auto_pause_frames(void *mac_drv, u16 *newval)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\t*newval = dsaf_get_dev_field(drv, GMAC_FC_TX_TIMER_REG,\n\t\t\t\t     GMAC_FC_TX_TIMER_M, GMAC_FC_TX_TIMER_S);\n}\n\nstatic void hns_gmac_config_max_frame_length(void *mac_drv, u16 newval)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\tdsaf_set_dev_field(drv, GMAC_MAX_FRM_SIZE_REG, GMAC_MAX_FRM_SIZE_M,\n\t\t\t   GMAC_MAX_FRM_SIZE_S, newval);\n\n\tdsaf_set_dev_field(drv, GAMC_RX_MAX_FRAME, GMAC_MAX_FRM_SIZE_M,\n\t\t\t   GMAC_MAX_FRM_SIZE_S, newval);\n}\n\nstatic void hns_gmac_config_pad_and_crc(void *mac_drv, u8 newval)\n{\n\tu32 tx_ctrl;\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\ttx_ctrl = dsaf_read_dev(drv, GMAC_TRANSMIT_CONTROL_REG);\n\tdsaf_set_bit(tx_ctrl, GMAC_TX_PAD_EN_B, !!newval);\n\tdsaf_set_bit(tx_ctrl, GMAC_TX_CRC_ADD_B, !!newval);\n\tdsaf_write_dev(drv, GMAC_TRANSMIT_CONTROL_REG, tx_ctrl);\n}\n\nstatic void hns_gmac_config_an_mode(void *mac_drv, u8 newval)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\tdsaf_set_dev_bit(drv, GMAC_TRANSMIT_CONTROL_REG,\n\t\t\t GMAC_TX_AN_EN_B, !!newval);\n}\n\nstatic void hns_gmac_tx_loop_pkt_dis(void *mac_drv)\n{\n\tu32 tx_loop_pkt_pri;\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\ttx_loop_pkt_pri = dsaf_read_dev(drv, GMAC_TX_LOOP_PKT_PRI_REG);\n\tdsaf_set_bit(tx_loop_pkt_pri, GMAC_TX_LOOP_PKT_EN_B, 1);\n\tdsaf_set_bit(tx_loop_pkt_pri, GMAC_TX_LOOP_PKT_HIG_PRI_B, 0);\n\tdsaf_write_dev(drv, GMAC_TX_LOOP_PKT_PRI_REG, tx_loop_pkt_pri);\n}\n\nstatic void hns_gmac_get_duplex_type(void *mac_drv,\n\t\t\t\t     enum hns_gmac_duplex_mdoe *duplex_mode)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\t*duplex_mode = (enum hns_gmac_duplex_mdoe)dsaf_get_dev_bit(\n\t\tdrv, GMAC_DUPLEX_TYPE_REG, GMAC_DUPLEX_TYPE_B);\n}\n\nstatic void hns_gmac_get_port_mode(void *mac_drv, enum hns_port_mode *port_mode)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\t*port_mode = (enum hns_port_mode)dsaf_get_dev_field(\n\t\tdrv, GMAC_PORT_MODE_REG, GMAC_PORT_MODE_M, GMAC_PORT_MODE_S);\n}\n\nstatic void hns_gmac_port_mode_get(void *mac_drv,\n\t\t\t\t   struct hns_gmac_port_mode_cfg *port_mode)\n{\n\tu32 tx_ctrl;\n\tu32 recv_ctrl;\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\tport_mode->port_mode = (enum hns_port_mode)dsaf_get_dev_field(\n\t\tdrv, GMAC_PORT_MODE_REG, GMAC_PORT_MODE_M, GMAC_PORT_MODE_S);\n\n\ttx_ctrl = dsaf_read_dev(drv, GMAC_TRANSMIT_CONTROL_REG);\n\trecv_ctrl = dsaf_read_dev(drv, GMAC_RECV_CONTROL_REG);\n\n\tport_mode->max_frm_size =\n\t\tdsaf_get_dev_field(drv, GMAC_MAX_FRM_SIZE_REG,\n\t\t\t\t   GMAC_MAX_FRM_SIZE_M, GMAC_MAX_FRM_SIZE_S);\n\tport_mode->short_runts_thr =\n\t\tdsaf_get_dev_field(drv, GMAC_SHORT_RUNTS_THR_REG,\n\t\t\t\t   GMAC_SHORT_RUNTS_THR_M,\n\t\t\t\t   GMAC_SHORT_RUNTS_THR_S);\n\n\tport_mode->pad_enable = dsaf_get_bit(tx_ctrl, GMAC_TX_PAD_EN_B);\n\tport_mode->crc_add = dsaf_get_bit(tx_ctrl, GMAC_TX_CRC_ADD_B);\n\tport_mode->an_enable = dsaf_get_bit(tx_ctrl, GMAC_TX_AN_EN_B);\n\n\tport_mode->runt_pkt_en =\n\t\tdsaf_get_bit(recv_ctrl, GMAC_RECV_CTRL_RUNT_PKT_EN_B);\n\tport_mode->strip_pad_en =\n\t\tdsaf_get_bit(recv_ctrl, GMAC_RECV_CTRL_STRIP_PAD_EN_B);\n}\n\nstatic void hns_gmac_pause_frm_cfg(void *mac_drv, u32 rx_pause_en,\n\t\t\t\t   u32 tx_pause_en)\n{\n\tu32 pause_en;\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\tpause_en = dsaf_read_dev(drv, GMAC_PAUSE_EN_REG);\n\tdsaf_set_bit(pause_en, GMAC_PAUSE_EN_RX_FDFC_B, !!rx_pause_en);\n\tdsaf_set_bit(pause_en, GMAC_PAUSE_EN_TX_FDFC_B, !!tx_pause_en);\n\tdsaf_write_dev(drv, GMAC_PAUSE_EN_REG, pause_en);\n}\n\nstatic void hns_gmac_get_pausefrm_cfg(void *mac_drv, u32 *rx_pause_en,\n\t\t\t\t      u32 *tx_pause_en)\n{\n\tu32 pause_en;\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\tpause_en = dsaf_read_dev(drv, GMAC_PAUSE_EN_REG);\n\n\t*rx_pause_en = dsaf_get_bit(pause_en, GMAC_PAUSE_EN_RX_FDFC_B);\n\t*tx_pause_en = dsaf_get_bit(pause_en, GMAC_PAUSE_EN_TX_FDFC_B);\n}\n\nstatic bool hns_gmac_need_adjust_link(void *mac_drv, enum mac_speed speed,\n\t\t\t\t      int duplex)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\tstruct hns_mac_cb *mac_cb = drv->mac_cb;\n\n\treturn (mac_cb->speed != speed) ||\n\t\t(mac_cb->half_duplex == duplex);\n}\n\nstatic int hns_gmac_adjust_link(void *mac_drv, enum mac_speed speed,\n\t\t\t\tu32 full_duplex)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\tdsaf_set_dev_bit(drv, GMAC_DUPLEX_TYPE_REG,\n\t\t\t GMAC_DUPLEX_TYPE_B, !!full_duplex);\n\n\tswitch (speed) {\n\tcase MAC_SPEED_10:\n\t\tdsaf_set_dev_field(\n\t\t\tdrv, GMAC_PORT_MODE_REG,\n\t\t\tGMAC_PORT_MODE_M, GMAC_PORT_MODE_S, 0x6);\n\t\tbreak;\n\tcase MAC_SPEED_100:\n\t\tdsaf_set_dev_field(\n\t\t\tdrv, GMAC_PORT_MODE_REG,\n\t\t\tGMAC_PORT_MODE_M, GMAC_PORT_MODE_S, 0x7);\n\t\tbreak;\n\tcase MAC_SPEED_1000:\n\t\tdsaf_set_dev_field(\n\t\t\tdrv, GMAC_PORT_MODE_REG,\n\t\t\tGMAC_PORT_MODE_M, GMAC_PORT_MODE_S, 0x8);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(drv->dev,\n\t\t\t\"hns_gmac_adjust_link fail, speed%d mac%d\\n\",\n\t\t\tspeed, drv->mac_id);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void hns_gmac_set_uc_match(void *mac_drv, u16 en)\n{\n\tstruct mac_driver *drv = mac_drv;\n\n\tdsaf_set_dev_bit(drv, GMAC_REC_FILT_CONTROL_REG,\n\t\t\t GMAC_UC_MATCH_EN_B, !en);\n\tdsaf_set_dev_bit(drv, GMAC_STATION_ADDR_HIGH_2_REG,\n\t\t\t GMAC_ADDR_EN_B, !en);\n}\n\nstatic void hns_gmac_set_promisc(void *mac_drv, u8 en)\n{\n\tstruct mac_driver *drv = mac_drv;\n\n\tif (drv->mac_cb->mac_type == HNAE_PORT_DEBUG)\n\t\thns_gmac_set_uc_match(mac_drv, en);\n}\n\nstatic int hns_gmac_wait_fifo_clean(void *mac_drv)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\tint wait_cnt;\n\tu32 val;\n\n\twait_cnt = 0;\n\twhile (wait_cnt++ < HNS_MAX_WAIT_CNT) {\n\t\tval = dsaf_read_dev(drv, GMAC_FIFO_STATE_REG);\n\t\t \n\t\tif ((val & 0x3f) == 0)\n\t\t\tbreak;\n\t\tusleep_range(100, 200);\n\t}\n\n\tif (wait_cnt >= HNS_MAX_WAIT_CNT) {\n\t\tdev_err(drv->dev,\n\t\t\t\"hns ge %d fifo was not idle.\\n\", drv->mac_id);\n\t\treturn -EBUSY;\n\t}\n\n\treturn 0;\n}\n\nstatic void hns_gmac_init(void *mac_drv)\n{\n\tu32 port;\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\tstruct dsaf_device *dsaf_dev\n\t\t= (struct dsaf_device *)dev_get_drvdata(drv->dev);\n\n\tport = drv->mac_id;\n\n\tdsaf_dev->misc_op->ge_srst(dsaf_dev, port, 0);\n\tmdelay(10);\n\tdsaf_dev->misc_op->ge_srst(dsaf_dev, port, 1);\n\tmdelay(10);\n\thns_gmac_disable(mac_drv, MAC_COMM_MODE_RX_AND_TX);\n\thns_gmac_tx_loop_pkt_dis(mac_drv);\n\tif (drv->mac_cb->mac_type == HNAE_PORT_DEBUG)\n\t\thns_gmac_set_uc_match(mac_drv, 0);\n\n\thns_gmac_config_pad_and_crc(mac_drv, 1);\n\n\tdsaf_set_dev_bit(drv, GMAC_MODE_CHANGE_EN_REG,\n\t\t\t GMAC_MODE_CHANGE_EB_B, 1);\n\n\t \n\tdsaf_set_dev_field(drv, GMAC_TX_WATER_LINE_REG, GMAC_TX_WATER_LINE_MASK,\n\t\t\t   GMAC_TX_WATER_LINE_SHIFT, 8);\n}\n\nstatic void hns_gmac_update_stats(void *mac_drv)\n{\n\tstruct mac_hw_stats *hw_stats = NULL;\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\thw_stats = &drv->mac_cb->hw_stats;\n\n\t \n\thw_stats->rx_good_bytes\n\t\t+= dsaf_read_dev(drv, GMAC_RX_OCTETS_TOTAL_OK_REG);\n\thw_stats->rx_bad_bytes\n\t\t+= dsaf_read_dev(drv, GMAC_RX_OCTETS_BAD_REG);\n\thw_stats->rx_uc_pkts += dsaf_read_dev(drv, GMAC_RX_UC_PKTS_REG);\n\thw_stats->rx_mc_pkts += dsaf_read_dev(drv, GMAC_RX_MC_PKTS_REG);\n\thw_stats->rx_bc_pkts += dsaf_read_dev(drv, GMAC_RX_BC_PKTS_REG);\n\thw_stats->rx_64bytes\n\t\t+= dsaf_read_dev(drv, GMAC_RX_PKTS_64OCTETS_REG);\n\thw_stats->rx_65to127\n\t\t+= dsaf_read_dev(drv, GMAC_RX_PKTS_65TO127OCTETS_REG);\n\thw_stats->rx_128to255\n\t\t+= dsaf_read_dev(drv, GMAC_RX_PKTS_128TO255OCTETS_REG);\n\thw_stats->rx_256to511\n\t\t+= dsaf_read_dev(drv, GMAC_RX_PKTS_255TO511OCTETS_REG);\n\thw_stats->rx_512to1023\n\t\t+= dsaf_read_dev(drv, GMAC_RX_PKTS_512TO1023OCTETS_REG);\n\thw_stats->rx_1024to1518\n\t\t+= dsaf_read_dev(drv, GMAC_RX_PKTS_1024TO1518OCTETS_REG);\n\thw_stats->rx_1519tomax\n\t\t+= dsaf_read_dev(drv, GMAC_RX_PKTS_1519TOMAXOCTETS_REG);\n\thw_stats->rx_fcs_err += dsaf_read_dev(drv, GMAC_RX_FCS_ERRORS_REG);\n\thw_stats->rx_vlan_pkts += dsaf_read_dev(drv, GMAC_RX_TAGGED_REG);\n\thw_stats->rx_data_err += dsaf_read_dev(drv, GMAC_RX_DATA_ERR_REG);\n\thw_stats->rx_align_err\n\t\t+= dsaf_read_dev(drv, GMAC_RX_ALIGN_ERRORS_REG);\n\thw_stats->rx_oversize\n\t\t+= dsaf_read_dev(drv, GMAC_RX_LONG_ERRORS_REG);\n\thw_stats->rx_jabber_err\n\t\t+= dsaf_read_dev(drv, GMAC_RX_JABBER_ERRORS_REG);\n\thw_stats->rx_pfc_tc0\n\t\t+= dsaf_read_dev(drv, GMAC_RX_PAUSE_MACCTRL_FRAM_REG);\n\thw_stats->rx_unknown_ctrl\n\t\t+= dsaf_read_dev(drv, GMAC_RX_UNKNOWN_MACCTRL_FRAM_REG);\n\thw_stats->rx_long_err\n\t\t+= dsaf_read_dev(drv, GMAC_RX_VERY_LONG_ERR_CNT_REG);\n\thw_stats->rx_minto64\n\t\t+= dsaf_read_dev(drv, GMAC_RX_RUNT_ERR_CNT_REG);\n\thw_stats->rx_under_min\n\t\t+= dsaf_read_dev(drv, GMAC_RX_SHORT_ERR_CNT_REG);\n\thw_stats->rx_filter_pkts\n\t\t+= dsaf_read_dev(drv, GMAC_RX_FILT_PKT_CNT_REG);\n\thw_stats->rx_filter_bytes\n\t\t+= dsaf_read_dev(drv, GMAC_RX_OCTETS_TOTAL_FILT_REG);\n\thw_stats->rx_fifo_overrun_err\n\t\t+= dsaf_read_dev(drv, GMAC_RX_OVERRUN_CNT_REG);\n\thw_stats->rx_len_err\n\t\t+= dsaf_read_dev(drv, GMAC_RX_LENGTHFIELD_ERR_CNT_REG);\n\thw_stats->rx_comma_err\n\t\t+= dsaf_read_dev(drv, GMAC_RX_FAIL_COMMA_CNT_REG);\n\n\t \n\thw_stats->tx_good_bytes\n\t\t+= dsaf_read_dev(drv, GMAC_OCTETS_TRANSMITTED_OK_REG);\n\thw_stats->tx_bad_bytes\n\t\t+= dsaf_read_dev(drv, GMAC_OCTETS_TRANSMITTED_BAD_REG);\n\thw_stats->tx_uc_pkts += dsaf_read_dev(drv, GMAC_TX_UC_PKTS_REG);\n\thw_stats->tx_mc_pkts += dsaf_read_dev(drv, GMAC_TX_MC_PKTS_REG);\n\thw_stats->tx_bc_pkts += dsaf_read_dev(drv, GMAC_TX_BC_PKTS_REG);\n\thw_stats->tx_64bytes\n\t\t+= dsaf_read_dev(drv, GMAC_TX_PKTS_64OCTETS_REG);\n\thw_stats->tx_65to127\n\t\t+= dsaf_read_dev(drv, GMAC_TX_PKTS_65TO127OCTETS_REG);\n\thw_stats->tx_128to255\n\t\t+= dsaf_read_dev(drv, GMAC_TX_PKTS_128TO255OCTETS_REG);\n\thw_stats->tx_256to511\n\t\t+= dsaf_read_dev(drv, GMAC_TX_PKTS_255TO511OCTETS_REG);\n\thw_stats->tx_512to1023\n\t\t+= dsaf_read_dev(drv, GMAC_TX_PKTS_512TO1023OCTETS_REG);\n\thw_stats->tx_1024to1518\n\t\t+= dsaf_read_dev(drv, GMAC_TX_PKTS_1024TO1518OCTETS_REG);\n\thw_stats->tx_1519tomax\n\t\t+= dsaf_read_dev(drv, GMAC_TX_PKTS_1519TOMAXOCTETS_REG);\n\thw_stats->tx_jabber_err\n\t\t+= dsaf_read_dev(drv, GMAC_TX_EXCESSIVE_LENGTH_DROP_REG);\n\thw_stats->tx_underrun_err\n\t\t+= dsaf_read_dev(drv, GMAC_TX_UNDERRUN_REG);\n\thw_stats->tx_vlan += dsaf_read_dev(drv, GMAC_TX_TAGGED_REG);\n\thw_stats->tx_crc_err += dsaf_read_dev(drv, GMAC_TX_CRC_ERROR_REG);\n\thw_stats->tx_pfc_tc0\n\t\t+= dsaf_read_dev(drv, GMAC_TX_PAUSE_FRAMES_REG);\n}\n\nstatic void hns_gmac_set_mac_addr(void *mac_drv, const char *mac_addr)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\tu32 high_val = mac_addr[1] | (mac_addr[0] << 8);\n\n\tu32 low_val = mac_addr[5] | (mac_addr[4] << 8)\n\t\t| (mac_addr[3] << 16) | (mac_addr[2] << 24);\n\n\tu32 val = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_2_REG);\n\tu32 sta_addr_en = dsaf_get_bit(val, GMAC_ADDR_EN_B);\n\n\tdsaf_write_dev(drv, GMAC_STATION_ADDR_LOW_2_REG, low_val);\n\tdsaf_write_dev(drv, GMAC_STATION_ADDR_HIGH_2_REG,\n\t\t       high_val | (sta_addr_en << GMAC_ADDR_EN_B));\n}\n\nstatic int hns_gmac_config_loopback(void *mac_drv, enum hnae_loop loop_mode,\n\t\t\t\t    u8 enable)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\tswitch (loop_mode) {\n\tcase MAC_INTERNALLOOP_MAC:\n\t\tdsaf_set_dev_bit(drv, GMAC_LOOP_REG, GMAC_LP_REG_CF2MI_LP_EN_B,\n\t\t\t\t !!enable);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(drv->dev, \"loop_mode error\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void hns_gmac_get_info(void *mac_drv, struct mac_info *mac_info)\n{\n\tenum hns_gmac_duplex_mdoe duplex;\n\tenum hns_port_mode speed;\n\tu32 rx_pause;\n\tu32 tx_pause;\n\tu32 rx;\n\tu32 tx;\n\tu16 fc_tx_timer;\n\tstruct hns_gmac_port_mode_cfg port_mode = { GMAC_10M_MII, 0 };\n\n\thns_gmac_port_mode_get(mac_drv, &port_mode);\n\tmac_info->pad_and_crc_en = port_mode.crc_add && port_mode.pad_enable;\n\tmac_info->auto_neg = port_mode.an_enable;\n\n\thns_gmac_get_tx_auto_pause_frames(mac_drv, &fc_tx_timer);\n\tmac_info->tx_pause_time = fc_tx_timer;\n\n\thns_gmac_get_en(mac_drv, &rx, &tx);\n\tmac_info->port_en = rx && tx;\n\n\thns_gmac_get_duplex_type(mac_drv, &duplex);\n\tmac_info->duplex = duplex;\n\n\thns_gmac_get_port_mode(mac_drv, &speed);\n\tswitch (speed) {\n\tcase GMAC_10M_SGMII:\n\t\tmac_info->speed = MAC_SPEED_10;\n\t\tbreak;\n\tcase GMAC_100M_SGMII:\n\t\tmac_info->speed = MAC_SPEED_100;\n\t\tbreak;\n\tcase GMAC_1000M_SGMII:\n\t\tmac_info->speed = MAC_SPEED_1000;\n\t\tbreak;\n\tdefault:\n\t\tmac_info->speed = 0;\n\t\tbreak;\n\t}\n\n\thns_gmac_get_pausefrm_cfg(mac_drv, &rx_pause, &tx_pause);\n\tmac_info->rx_pause_en = rx_pause;\n\tmac_info->tx_pause_en = tx_pause;\n}\n\nstatic void hns_gmac_autoneg_stat(void *mac_drv, u32 *enable)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\t*enable = dsaf_get_dev_bit(drv, GMAC_TRANSMIT_CONTROL_REG,\n\t\t\t\t   GMAC_TX_AN_EN_B);\n}\n\nstatic void hns_gmac_get_link_status(void *mac_drv, u32 *link_stat)\n{\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\t*link_stat = dsaf_get_dev_bit(drv, GMAC_AN_NEG_STATE_REG,\n\t\t\t\t      GMAC_AN_NEG_STAT_RX_SYNC_OK_B);\n}\n\nstatic void hns_gmac_get_regs(void *mac_drv, void *data)\n{\n\tu32 *regs = data;\n\tint i;\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\n\t \n\tregs[0] = dsaf_read_dev(drv, GMAC_DUPLEX_TYPE_REG);\n\tregs[1] = dsaf_read_dev(drv, GMAC_FD_FC_TYPE_REG);\n\tregs[2] = dsaf_read_dev(drv, GMAC_FC_TX_TIMER_REG);\n\tregs[3] = dsaf_read_dev(drv, GMAC_FD_FC_ADDR_LOW_REG);\n\tregs[4] = dsaf_read_dev(drv, GMAC_FD_FC_ADDR_HIGH_REG);\n\tregs[5] = dsaf_read_dev(drv, GMAC_IPG_TX_TIMER_REG);\n\tregs[6] = dsaf_read_dev(drv, GMAC_PAUSE_THR_REG);\n\tregs[7] = dsaf_read_dev(drv, GMAC_MAX_FRM_SIZE_REG);\n\tregs[8] = dsaf_read_dev(drv, GMAC_PORT_MODE_REG);\n\tregs[9] = dsaf_read_dev(drv, GMAC_PORT_EN_REG);\n\tregs[10] = dsaf_read_dev(drv, GMAC_PAUSE_EN_REG);\n\tregs[11] = dsaf_read_dev(drv, GMAC_SHORT_RUNTS_THR_REG);\n\tregs[12] = dsaf_read_dev(drv, GMAC_AN_NEG_STATE_REG);\n\tregs[13] = dsaf_read_dev(drv, GMAC_TX_LOCAL_PAGE_REG);\n\tregs[14] = dsaf_read_dev(drv, GMAC_TRANSMIT_CONTROL_REG);\n\tregs[15] = dsaf_read_dev(drv, GMAC_REC_FILT_CONTROL_REG);\n\tregs[16] = dsaf_read_dev(drv, GMAC_PTP_CONFIG_REG);\n\n\t \n\tregs[17] = dsaf_read_dev(drv, GMAC_RX_OCTETS_TOTAL_OK_REG);\n\tregs[18] = dsaf_read_dev(drv, GMAC_RX_OCTETS_BAD_REG);\n\tregs[19] = dsaf_read_dev(drv, GMAC_RX_UC_PKTS_REG);\n\tregs[20] = dsaf_read_dev(drv, GMAC_RX_MC_PKTS_REG);\n\tregs[21] = dsaf_read_dev(drv, GMAC_RX_BC_PKTS_REG);\n\tregs[22] = dsaf_read_dev(drv, GMAC_RX_PKTS_64OCTETS_REG);\n\tregs[23] = dsaf_read_dev(drv, GMAC_RX_PKTS_65TO127OCTETS_REG);\n\tregs[24] = dsaf_read_dev(drv, GMAC_RX_PKTS_128TO255OCTETS_REG);\n\tregs[25] = dsaf_read_dev(drv, GMAC_RX_PKTS_255TO511OCTETS_REG);\n\tregs[26] = dsaf_read_dev(drv, GMAC_RX_PKTS_512TO1023OCTETS_REG);\n\tregs[27] = dsaf_read_dev(drv, GMAC_RX_PKTS_1024TO1518OCTETS_REG);\n\tregs[28] = dsaf_read_dev(drv, GMAC_RX_PKTS_1519TOMAXOCTETS_REG);\n\tregs[29] = dsaf_read_dev(drv, GMAC_RX_FCS_ERRORS_REG);\n\tregs[30] = dsaf_read_dev(drv, GMAC_RX_TAGGED_REG);\n\tregs[31] = dsaf_read_dev(drv, GMAC_RX_DATA_ERR_REG);\n\tregs[32] = dsaf_read_dev(drv, GMAC_RX_ALIGN_ERRORS_REG);\n\tregs[33] = dsaf_read_dev(drv, GMAC_RX_LONG_ERRORS_REG);\n\tregs[34] = dsaf_read_dev(drv, GMAC_RX_JABBER_ERRORS_REG);\n\tregs[35] = dsaf_read_dev(drv, GMAC_RX_PAUSE_MACCTRL_FRAM_REG);\n\tregs[36] = dsaf_read_dev(drv, GMAC_RX_UNKNOWN_MACCTRL_FRAM_REG);\n\tregs[37] = dsaf_read_dev(drv, GMAC_RX_VERY_LONG_ERR_CNT_REG);\n\tregs[38] = dsaf_read_dev(drv, GMAC_RX_RUNT_ERR_CNT_REG);\n\tregs[39] = dsaf_read_dev(drv, GMAC_RX_SHORT_ERR_CNT_REG);\n\tregs[40] = dsaf_read_dev(drv, GMAC_RX_FILT_PKT_CNT_REG);\n\tregs[41] = dsaf_read_dev(drv, GMAC_RX_OCTETS_TOTAL_FILT_REG);\n\n\t \n\tregs[42] = dsaf_read_dev(drv, GMAC_OCTETS_TRANSMITTED_OK_REG);\n\tregs[43] = dsaf_read_dev(drv, GMAC_OCTETS_TRANSMITTED_BAD_REG);\n\tregs[44] = dsaf_read_dev(drv, GMAC_TX_UC_PKTS_REG);\n\tregs[45] = dsaf_read_dev(drv, GMAC_TX_MC_PKTS_REG);\n\tregs[46] = dsaf_read_dev(drv, GMAC_TX_BC_PKTS_REG);\n\tregs[47] = dsaf_read_dev(drv, GMAC_TX_PKTS_64OCTETS_REG);\n\tregs[48] = dsaf_read_dev(drv, GMAC_TX_PKTS_65TO127OCTETS_REG);\n\tregs[49] = dsaf_read_dev(drv, GMAC_TX_PKTS_128TO255OCTETS_REG);\n\tregs[50] = dsaf_read_dev(drv, GMAC_TX_PKTS_255TO511OCTETS_REG);\n\tregs[51] = dsaf_read_dev(drv, GMAC_TX_PKTS_512TO1023OCTETS_REG);\n\tregs[52] = dsaf_read_dev(drv, GMAC_TX_PKTS_1024TO1518OCTETS_REG);\n\tregs[53] = dsaf_read_dev(drv, GMAC_TX_PKTS_1519TOMAXOCTETS_REG);\n\tregs[54] = dsaf_read_dev(drv, GMAC_TX_EXCESSIVE_LENGTH_DROP_REG);\n\tregs[55] = dsaf_read_dev(drv, GMAC_TX_UNDERRUN_REG);\n\tregs[56] = dsaf_read_dev(drv, GMAC_TX_TAGGED_REG);\n\tregs[57] = dsaf_read_dev(drv, GMAC_TX_CRC_ERROR_REG);\n\tregs[58] = dsaf_read_dev(drv, GMAC_TX_PAUSE_FRAMES_REG);\n\n\tregs[59] = dsaf_read_dev(drv, GAMC_RX_MAX_FRAME);\n\tregs[60] = dsaf_read_dev(drv, GMAC_LINE_LOOP_BACK_REG);\n\tregs[61] = dsaf_read_dev(drv, GMAC_CF_CRC_STRIP_REG);\n\tregs[62] = dsaf_read_dev(drv, GMAC_MODE_CHANGE_EN_REG);\n\tregs[63] = dsaf_read_dev(drv, GMAC_SIXTEEN_BIT_CNTR_REG);\n\tregs[64] = dsaf_read_dev(drv, GMAC_LD_LINK_COUNTER_REG);\n\tregs[65] = dsaf_read_dev(drv, GMAC_LOOP_REG);\n\tregs[66] = dsaf_read_dev(drv, GMAC_RECV_CONTROL_REG);\n\tregs[67] = dsaf_read_dev(drv, GMAC_VLAN_CODE_REG);\n\tregs[68] = dsaf_read_dev(drv, GMAC_RX_OVERRUN_CNT_REG);\n\tregs[69] = dsaf_read_dev(drv, GMAC_RX_LENGTHFIELD_ERR_CNT_REG);\n\tregs[70] = dsaf_read_dev(drv, GMAC_RX_FAIL_COMMA_CNT_REG);\n\n\tregs[71] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_0_REG);\n\tregs[72] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_0_REG);\n\tregs[73] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_1_REG);\n\tregs[74] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_1_REG);\n\tregs[75] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_2_REG);\n\tregs[76] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_2_REG);\n\tregs[77] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_3_REG);\n\tregs[78] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_3_REG);\n\tregs[79] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_4_REG);\n\tregs[80] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_4_REG);\n\tregs[81] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_5_REG);\n\tregs[82] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_5_REG);\n\tregs[83] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_MSK_0_REG);\n\tregs[84] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_MSK_0_REG);\n\tregs[85] = dsaf_read_dev(drv, GMAC_STATION_ADDR_LOW_MSK_1_REG);\n\tregs[86] = dsaf_read_dev(drv, GMAC_STATION_ADDR_HIGH_MSK_1_REG);\n\tregs[87] = dsaf_read_dev(drv, GMAC_MAC_SKIP_LEN_REG);\n\tregs[88] = dsaf_read_dev(drv, GMAC_TX_LOOP_PKT_PRI_REG);\n\n\t \n\tfor (i = 89; i < 96; i++)\n\t\tregs[i] = 0xaaaaaaaa;\n}\n\nstatic void hns_gmac_get_stats(void *mac_drv, u64 *data)\n{\n\tu32 i;\n\tu64 *buf = data;\n\tstruct mac_driver *drv = (struct mac_driver *)mac_drv;\n\tstruct mac_hw_stats *hw_stats = NULL;\n\n\thw_stats = &drv->mac_cb->hw_stats;\n\n\tfor (i = 0; i < ARRAY_SIZE(g_gmac_stats_string); i++) {\n\t\tbuf[i] = DSAF_STATS_READ(hw_stats,\n\t\t\tg_gmac_stats_string[i].offset);\n\t}\n}\n\nstatic void hns_gmac_get_strings(u32 stringset, u8 *data)\n{\n\tu8 *buff = data;\n\tu32 i;\n\n\tif (stringset != ETH_SS_STATS)\n\t\treturn;\n\n\tfor (i = 0; i < ARRAY_SIZE(g_gmac_stats_string); i++)\n\t\tethtool_sprintf(&buff, g_gmac_stats_string[i].desc);\n}\n\nstatic int hns_gmac_get_sset_count(int stringset)\n{\n\tif (stringset == ETH_SS_STATS)\n\t\treturn ARRAY_SIZE(g_gmac_stats_string);\n\n\treturn 0;\n}\n\nstatic int hns_gmac_get_regs_count(void)\n{\n\treturn ETH_GMAC_DUMP_NUM;\n}\n\nvoid *hns_gmac_config(struct hns_mac_cb *mac_cb, struct mac_params *mac_param)\n{\n\tstruct mac_driver *mac_drv;\n\n\tmac_drv = devm_kzalloc(mac_cb->dev, sizeof(*mac_drv), GFP_KERNEL);\n\tif (!mac_drv)\n\t\treturn NULL;\n\n\tmac_drv->mac_init = hns_gmac_init;\n\tmac_drv->mac_enable = hns_gmac_enable;\n\tmac_drv->mac_disable = hns_gmac_disable;\n\tmac_drv->mac_free = hns_gmac_free;\n\tmac_drv->adjust_link = hns_gmac_adjust_link;\n\tmac_drv->need_adjust_link = hns_gmac_need_adjust_link;\n\tmac_drv->set_tx_auto_pause_frames = hns_gmac_set_tx_auto_pause_frames;\n\tmac_drv->config_max_frame_length = hns_gmac_config_max_frame_length;\n\tmac_drv->mac_pausefrm_cfg = hns_gmac_pause_frm_cfg;\n\n\tmac_drv->mac_id = mac_param->mac_id;\n\tmac_drv->mac_mode = mac_param->mac_mode;\n\tmac_drv->io_base = mac_param->vaddr;\n\tmac_drv->dev = mac_param->dev;\n\tmac_drv->mac_cb = mac_cb;\n\n\tmac_drv->set_mac_addr = hns_gmac_set_mac_addr;\n\tmac_drv->set_an_mode = hns_gmac_config_an_mode;\n\tmac_drv->config_loopback = hns_gmac_config_loopback;\n\tmac_drv->config_pad_and_crc = hns_gmac_config_pad_and_crc;\n\tmac_drv->get_info = hns_gmac_get_info;\n\tmac_drv->autoneg_stat = hns_gmac_autoneg_stat;\n\tmac_drv->get_pause_enable = hns_gmac_get_pausefrm_cfg;\n\tmac_drv->get_link_status = hns_gmac_get_link_status;\n\tmac_drv->get_regs = hns_gmac_get_regs;\n\tmac_drv->get_regs_count = hns_gmac_get_regs_count;\n\tmac_drv->get_ethtool_stats = hns_gmac_get_stats;\n\tmac_drv->get_sset_count = hns_gmac_get_sset_count;\n\tmac_drv->get_strings = hns_gmac_get_strings;\n\tmac_drv->update_stats = hns_gmac_update_stats;\n\tmac_drv->set_promiscuous = hns_gmac_set_promisc;\n\tmac_drv->wait_fifo_clean = hns_gmac_wait_fifo_clean;\n\n\treturn (void *)mac_drv;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}