{
  "module_name": "otx2_devlink.c",
  "hash_id": "03e0b414a6aba483d7d046b4855957a2c4795d2298c787966a19b25baee82bff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/marvell/octeontx2/nic/otx2_devlink.c",
  "human_readable_source": "\n \n\n#include \"otx2_common.h\"\n\n \nstatic int otx2_dl_mcam_count_validate(struct devlink *devlink, u32 id,\n\t\t\t\t       union devlink_param_value val,\n\t\t\t\t       struct netlink_ext_ack *extack)\n{\n\tstruct otx2_devlink *otx2_dl = devlink_priv(devlink);\n\tstruct otx2_nic *pfvf = otx2_dl->pfvf;\n\tstruct otx2_flow_config *flow_cfg;\n\n\tif (!pfvf->flow_cfg) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"pfvf->flow_cfg not initialized\");\n\t\treturn -EINVAL;\n\t}\n\n\tflow_cfg = pfvf->flow_cfg;\n\tif (flow_cfg && flow_cfg->nr_flows) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Cannot modify count when there are active rules\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int otx2_dl_mcam_count_set(struct devlink *devlink, u32 id,\n\t\t\t\t  struct devlink_param_gset_ctx *ctx)\n{\n\tstruct otx2_devlink *otx2_dl = devlink_priv(devlink);\n\tstruct otx2_nic *pfvf = otx2_dl->pfvf;\n\n\tif (!pfvf->flow_cfg)\n\t\treturn 0;\n\n\totx2_alloc_mcam_entries(pfvf, ctx->val.vu16);\n\n\treturn 0;\n}\n\nstatic int otx2_dl_mcam_count_get(struct devlink *devlink, u32 id,\n\t\t\t\t  struct devlink_param_gset_ctx *ctx)\n{\n\tstruct otx2_devlink *otx2_dl = devlink_priv(devlink);\n\tstruct otx2_nic *pfvf = otx2_dl->pfvf;\n\tstruct otx2_flow_config *flow_cfg;\n\n\tif (!pfvf->flow_cfg) {\n\t\tctx->val.vu16 = 0;\n\t\treturn 0;\n\t}\n\n\tflow_cfg = pfvf->flow_cfg;\n\tctx->val.vu16 = flow_cfg->max_flows;\n\n\treturn 0;\n}\n\nenum otx2_dl_param_id {\n\tOTX2_DEVLINK_PARAM_ID_BASE = DEVLINK_PARAM_GENERIC_ID_MAX,\n\tOTX2_DEVLINK_PARAM_ID_MCAM_COUNT,\n};\n\nstatic const struct devlink_param otx2_dl_params[] = {\n\tDEVLINK_PARAM_DRIVER(OTX2_DEVLINK_PARAM_ID_MCAM_COUNT,\n\t\t\t     \"mcam_count\", DEVLINK_PARAM_TYPE_U16,\n\t\t\t     BIT(DEVLINK_PARAM_CMODE_RUNTIME),\n\t\t\t     otx2_dl_mcam_count_get, otx2_dl_mcam_count_set,\n\t\t\t     otx2_dl_mcam_count_validate),\n};\n\nstatic const struct devlink_ops otx2_devlink_ops = {\n};\n\nint otx2_register_dl(struct otx2_nic *pfvf)\n{\n\tstruct otx2_devlink *otx2_dl;\n\tstruct devlink *dl;\n\tint err;\n\n\tdl = devlink_alloc(&otx2_devlink_ops,\n\t\t\t   sizeof(struct otx2_devlink), pfvf->dev);\n\tif (!dl) {\n\t\tdev_warn(pfvf->dev, \"devlink_alloc failed\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\totx2_dl = devlink_priv(dl);\n\totx2_dl->dl = dl;\n\totx2_dl->pfvf = pfvf;\n\tpfvf->dl = otx2_dl;\n\n\terr = devlink_params_register(dl, otx2_dl_params,\n\t\t\t\t      ARRAY_SIZE(otx2_dl_params));\n\tif (err) {\n\t\tdev_err(pfvf->dev,\n\t\t\t\"devlink params register failed with error %d\", err);\n\t\tgoto err_dl;\n\t}\n\n\tdevlink_register(dl);\n\treturn 0;\n\nerr_dl:\n\tdevlink_free(dl);\n\treturn err;\n}\n\nvoid otx2_unregister_dl(struct otx2_nic *pfvf)\n{\n\tstruct otx2_devlink *otx2_dl = pfvf->dl;\n\tstruct devlink *dl = otx2_dl->dl;\n\n\tdevlink_unregister(dl);\n\tdevlink_params_unregister(dl, otx2_dl_params,\n\t\t\t\t  ARRAY_SIZE(otx2_dl_params));\n\tdevlink_free(dl);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}