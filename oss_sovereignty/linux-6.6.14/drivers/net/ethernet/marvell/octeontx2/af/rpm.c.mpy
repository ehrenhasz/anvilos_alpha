{
  "module_name": "rpm.c",
  "hash_id": "660bae14277dbe5f2850f4144e186d7732dae4e133829dcfc5398e6a6c441dd1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/marvell/octeontx2/af/rpm.c",
  "human_readable_source": "\n \n\n#include \"cgx.h\"\n#include \"lmac_common.h\"\n\nstatic struct mac_ops\t\trpm_mac_ops   = {\n\t.name\t\t=       \"rpm\",\n\t.csr_offset     =       0x4e00,\n\t.lmac_offset    =       20,\n\t.int_register\t=       RPMX_CMRX_SW_INT,\n\t.int_set_reg    =       RPMX_CMRX_SW_INT_ENA_W1S,\n\t.irq_offset     =       1,\n\t.int_ena_bit    =       BIT_ULL(0),\n\t.lmac_fwi\t=\tRPM_LMAC_FWI,\n\t.non_contiguous_serdes_lane = true,\n\t.rx_stats_cnt   =       43,\n\t.tx_stats_cnt   =       34,\n\t.dmac_filter_count =\t32,\n\t.get_nr_lmacs\t=\trpm_get_nr_lmacs,\n\t.get_lmac_type  =       rpm_get_lmac_type,\n\t.lmac_fifo_len\t=\trpm_get_lmac_fifo_len,\n\t.mac_lmac_intl_lbk =    rpm_lmac_internal_loopback,\n\t.mac_get_rx_stats  =\trpm_get_rx_stats,\n\t.mac_get_tx_stats  =\trpm_get_tx_stats,\n\t.get_fec_stats\t   =\trpm_get_fec_stats,\n\t.mac_enadis_rx_pause_fwding =\trpm_lmac_enadis_rx_pause_fwding,\n\t.mac_get_pause_frm_status =\trpm_lmac_get_pause_frm_status,\n\t.mac_enadis_pause_frm =\t\trpm_lmac_enadis_pause_frm,\n\t.mac_pause_frm_config =\t\trpm_lmac_pause_frm_config,\n\t.mac_enadis_ptp_config =\trpm_lmac_ptp_config,\n\t.mac_rx_tx_enable =\t\trpm_lmac_rx_tx_enable,\n\t.mac_tx_enable =\t\trpm_lmac_tx_enable,\n\t.pfc_config =                   rpm_lmac_pfc_config,\n\t.mac_get_pfc_frm_cfg   =        rpm_lmac_get_pfc_frm_cfg,\n\t.mac_reset   =\t\t\trpm_lmac_reset,\n};\n\nstatic struct mac_ops\t\trpm2_mac_ops   = {\n\t.name\t\t=       \"rpm\",\n\t.csr_offset     =       RPM2_CSR_OFFSET,\n\t.lmac_offset    =       20,\n\t.int_register\t=       RPM2_CMRX_SW_INT,\n\t.int_set_reg    =       RPM2_CMRX_SW_INT_ENA_W1S,\n\t.irq_offset     =       1,\n\t.int_ena_bit    =       BIT_ULL(0),\n\t.lmac_fwi\t=\tRPM2_LMAC_FWI,\n\t.non_contiguous_serdes_lane = true,\n\t.rx_stats_cnt   =       43,\n\t.tx_stats_cnt   =       34,\n\t.dmac_filter_count =\t64,\n\t.get_nr_lmacs\t=\trpm2_get_nr_lmacs,\n\t.get_lmac_type  =       rpm_get_lmac_type,\n\t.lmac_fifo_len\t=\trpm2_get_lmac_fifo_len,\n\t.mac_lmac_intl_lbk =    rpm_lmac_internal_loopback,\n\t.mac_get_rx_stats  =\trpm_get_rx_stats,\n\t.mac_get_tx_stats  =\trpm_get_tx_stats,\n\t.get_fec_stats\t   =\trpm_get_fec_stats,\n\t.mac_enadis_rx_pause_fwding =\trpm_lmac_enadis_rx_pause_fwding,\n\t.mac_get_pause_frm_status =\trpm_lmac_get_pause_frm_status,\n\t.mac_enadis_pause_frm =\t\trpm_lmac_enadis_pause_frm,\n\t.mac_pause_frm_config =\t\trpm_lmac_pause_frm_config,\n\t.mac_enadis_ptp_config =\trpm_lmac_ptp_config,\n\t.mac_rx_tx_enable =\t\trpm_lmac_rx_tx_enable,\n\t.mac_tx_enable =\t\trpm_lmac_tx_enable,\n\t.pfc_config =                   rpm_lmac_pfc_config,\n\t.mac_get_pfc_frm_cfg   =        rpm_lmac_get_pfc_frm_cfg,\n\t.mac_reset   =\t\t\trpm_lmac_reset,\n};\n\nbool is_dev_rpm2(void *rpmd)\n{\n\trpm_t *rpm = rpmd;\n\n\treturn (rpm->pdev->device == PCI_DEVID_CN10KB_RPM);\n}\n\nstruct mac_ops *rpm_get_mac_ops(rpm_t *rpm)\n{\n\tif (is_dev_rpm2(rpm))\n\t\treturn &rpm2_mac_ops;\n\telse\n\t\treturn &rpm_mac_ops;\n}\n\nstatic void rpm_write(rpm_t *rpm, u64 lmac, u64 offset, u64 val)\n{\n\tcgx_write(rpm, lmac, offset, val);\n}\n\nstatic u64 rpm_read(rpm_t *rpm, u64 lmac, u64 offset)\n{\n\treturn\tcgx_read(rpm, lmac, offset);\n}\n\n \nstatic bool is_mac_rpmusx(void *rpmd)\n{\n\trpm_t *rpm = rpmd;\n\n\treturn rpm_read(rpm, 0, RPMX_CONST1) & 0x700ULL;\n}\n\nint rpm_get_nr_lmacs(void *rpmd)\n{\n\trpm_t *rpm = rpmd;\n\n\treturn hweight8(rpm_read(rpm, 0, CGXX_CMRX_RX_LMACS) & 0xFULL);\n}\n\nint rpm2_get_nr_lmacs(void *rpmd)\n{\n\trpm_t *rpm = rpmd;\n\n\treturn hweight8(rpm_read(rpm, 0, RPM2_CMRX_RX_LMACS) & 0xFFULL);\n}\n\nint rpm_lmac_tx_enable(void *rpmd, int lmac_id, bool enable)\n{\n\trpm_t *rpm = rpmd;\n\tu64 cfg, last;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tlast = cfg;\n\tif (enable)\n\t\tcfg |= RPM_TX_EN;\n\telse\n\t\tcfg &= ~(RPM_TX_EN);\n\n\tif (cfg != last)\n\t\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\treturn !!(last & RPM_TX_EN);\n}\n\nint rpm_lmac_rx_tx_enable(void *rpmd, int lmac_id, bool enable)\n{\n\trpm_t *rpm = rpmd;\n\tu64 cfg;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tif (enable)\n\t\tcfg |= RPM_RX_EN | RPM_TX_EN;\n\telse\n\t\tcfg &= ~(RPM_RX_EN | RPM_TX_EN);\n\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\treturn 0;\n}\n\nvoid rpm_lmac_enadis_rx_pause_fwding(void *rpmd, int lmac_id, bool enable)\n{\n\trpm_t *rpm = rpmd;\n\tstruct lmac *lmac;\n\tu64 cfg;\n\n\tif (!rpm)\n\t\treturn;\n\n\tlmac = lmac_pdata(lmac_id, rpm);\n\tif (!lmac)\n\t\treturn;\n\n\t \n\tif (!bitmap_weight(lmac->rx_fc_pfvf_bmap.bmap, lmac->rx_fc_pfvf_bmap.max))\n\t\treturn;\n\n\tif (enable) {\n\t\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\t\tcfg &= ~RPMX_MTI_MAC100X_COMMAND_CONFIG_PAUSE_IGNORE;\n\t\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\t} else {\n\t\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\t\tcfg |= RPMX_MTI_MAC100X_COMMAND_CONFIG_PAUSE_IGNORE;\n\t\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\t}\n}\n\nint rpm_lmac_get_pause_frm_status(void *rpmd, int lmac_id,\n\t\t\t\t  u8 *tx_pause, u8 *rx_pause)\n{\n\trpm_t *rpm = rpmd;\n\tu64 cfg;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tif (!(cfg & RPMX_MTI_MAC100X_COMMAND_CONFIG_PFC_MODE)) {\n\t\t*rx_pause = !(cfg & RPMX_MTI_MAC100X_COMMAND_CONFIG_RX_P_DISABLE);\n\t\t*tx_pause = !(cfg & RPMX_MTI_MAC100X_COMMAND_CONFIG_TX_P_DISABLE);\n\t}\n\n\treturn 0;\n}\n\nstatic void rpm_cfg_pfc_quanta_thresh(rpm_t *rpm, int lmac_id,\n\t\t\t\t      unsigned long pfc_en,\n\t\t\t\t      bool enable)\n{\n\tu64 quanta_offset = 0, quanta_thresh = 0, cfg;\n\tint i, shift;\n\n\t \n\tfor_each_set_bit(i, &pfc_en, 16) {\n\t\tswitch (i) {\n\t\tcase 0:\n\t\tcase 1:\n\t\t\tquanta_offset = RPMX_MTI_MAC100X_CL01_PAUSE_QUANTA;\n\t\t\tquanta_thresh = RPMX_MTI_MAC100X_CL01_QUANTA_THRESH;\n\t\t\tbreak;\n\t\tcase 2:\n\t\tcase 3:\n\t\t\tquanta_offset = RPMX_MTI_MAC100X_CL23_PAUSE_QUANTA;\n\t\t\tquanta_thresh = RPMX_MTI_MAC100X_CL23_QUANTA_THRESH;\n\t\t\tbreak;\n\t\tcase 4:\n\t\tcase 5:\n\t\t\tquanta_offset = RPMX_MTI_MAC100X_CL45_PAUSE_QUANTA;\n\t\t\tquanta_thresh = RPMX_MTI_MAC100X_CL45_QUANTA_THRESH;\n\t\t\tbreak;\n\t\tcase 6:\n\t\tcase 7:\n\t\t\tquanta_offset = RPMX_MTI_MAC100X_CL67_PAUSE_QUANTA;\n\t\t\tquanta_thresh = RPMX_MTI_MAC100X_CL67_QUANTA_THRESH;\n\t\t\tbreak;\n\t\tcase 8:\n\t\tcase 9:\n\t\t\tquanta_offset = RPMX_MTI_MAC100X_CL89_PAUSE_QUANTA;\n\t\t\tquanta_thresh = RPMX_MTI_MAC100X_CL89_QUANTA_THRESH;\n\t\t\tbreak;\n\t\tcase 10:\n\t\tcase 11:\n\t\t\tquanta_offset = RPMX_MTI_MAC100X_CL1011_PAUSE_QUANTA;\n\t\t\tquanta_thresh = RPMX_MTI_MAC100X_CL1011_QUANTA_THRESH;\n\t\t\tbreak;\n\t\tcase 12:\n\t\tcase 13:\n\t\t\tquanta_offset = RPMX_MTI_MAC100X_CL1213_PAUSE_QUANTA;\n\t\t\tquanta_thresh = RPMX_MTI_MAC100X_CL1213_QUANTA_THRESH;\n\t\t\tbreak;\n\t\tcase 14:\n\t\tcase 15:\n\t\t\tquanta_offset = RPMX_MTI_MAC100X_CL1415_PAUSE_QUANTA;\n\t\t\tquanta_thresh = RPMX_MTI_MAC100X_CL1415_QUANTA_THRESH;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (!quanta_offset || !quanta_thresh)\n\t\t\tcontinue;\n\n\t\tshift = (i % 2) ? 1 : 0;\n\t\tcfg = rpm_read(rpm, lmac_id, quanta_offset);\n\t\tif (enable) {\n\t\t\tcfg |= ((u64)RPM_DEFAULT_PAUSE_TIME <<  shift * 16);\n\t\t} else {\n\t\t\tif (!shift)\n\t\t\t\tcfg &= ~GENMASK_ULL(15, 0);\n\t\t\telse\n\t\t\t\tcfg &= ~GENMASK_ULL(31, 16);\n\t\t}\n\t\trpm_write(rpm, lmac_id, quanta_offset, cfg);\n\n\t\tcfg = rpm_read(rpm, lmac_id, quanta_thresh);\n\t\tif (enable) {\n\t\t\tcfg |= ((u64)(RPM_DEFAULT_PAUSE_TIME / 2) <<  shift * 16);\n\t\t} else {\n\t\t\tif (!shift)\n\t\t\t\tcfg &= ~GENMASK_ULL(15, 0);\n\t\t\telse\n\t\t\t\tcfg &= ~GENMASK_ULL(31, 16);\n\t\t}\n\t\trpm_write(rpm, lmac_id, quanta_thresh, cfg);\n\t}\n}\n\nstatic void rpm2_lmac_cfg_bp(rpm_t *rpm, int lmac_id, u8 tx_pause, u8 rx_pause)\n{\n\tu64 cfg;\n\n\tcfg = rpm_read(rpm, lmac_id, RPM2_CMR_RX_OVR_BP);\n\tif (tx_pause) {\n\t\t \n\t\trpm_cfg_pfc_quanta_thresh(rpm, lmac_id, 1, true);\n\t\tcfg &= ~RPM2_CMR_RX_OVR_BP_EN;\n\t} else {\n\t\t \n\t\trpm_cfg_pfc_quanta_thresh(rpm, lmac_id, 0xffff, false);\n\t\tcfg |= RPM2_CMR_RX_OVR_BP_EN;\n\t\tcfg &= ~RPM2_CMR_RX_OVR_BP_BP;\n\t}\n\trpm_write(rpm, lmac_id, RPM2_CMR_RX_OVR_BP, cfg);\n}\n\nstatic void rpm_lmac_cfg_bp(rpm_t *rpm, int lmac_id, u8 tx_pause, u8 rx_pause)\n{\n\tu64 cfg;\n\n\tcfg = rpm_read(rpm, 0, RPMX_CMR_RX_OVR_BP);\n\tif (tx_pause) {\n\t\t \n\t\trpm_cfg_pfc_quanta_thresh(rpm, lmac_id, 1, true);\n\t\tcfg &= ~RPMX_CMR_RX_OVR_BP_EN(lmac_id);\n\t} else {\n\t\t \n\t\trpm_cfg_pfc_quanta_thresh(rpm, lmac_id, 0xffff, false);\n\t\tcfg |= RPMX_CMR_RX_OVR_BP_EN(lmac_id);\n\t\tcfg &= ~RPMX_CMR_RX_OVR_BP_BP(lmac_id);\n\t}\n\trpm_write(rpm, 0, RPMX_CMR_RX_OVR_BP, cfg);\n}\n\nint rpm_lmac_enadis_pause_frm(void *rpmd, int lmac_id, u8 tx_pause,\n\t\t\t      u8 rx_pause)\n{\n\trpm_t *rpm = rpmd;\n\tu64 cfg;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tcfg &= ~RPMX_MTI_MAC100X_COMMAND_CONFIG_RX_P_DISABLE;\n\tcfg |= rx_pause ? 0x0 : RPMX_MTI_MAC100X_COMMAND_CONFIG_RX_P_DISABLE;\n\tcfg &= ~RPMX_MTI_MAC100X_COMMAND_CONFIG_PAUSE_IGNORE;\n\tcfg |= rx_pause ? 0x0 : RPMX_MTI_MAC100X_COMMAND_CONFIG_PAUSE_IGNORE;\n\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tcfg &= ~RPMX_MTI_MAC100X_COMMAND_CONFIG_TX_P_DISABLE;\n\tcfg |= tx_pause ? 0x0 : RPMX_MTI_MAC100X_COMMAND_CONFIG_TX_P_DISABLE;\n\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\n\tif (is_dev_rpm2(rpm))\n\t\trpm2_lmac_cfg_bp(rpm, lmac_id, tx_pause, rx_pause);\n\telse\n\t\trpm_lmac_cfg_bp(rpm, lmac_id, tx_pause, rx_pause);\n\n\treturn 0;\n}\n\nvoid rpm_lmac_pause_frm_config(void *rpmd, int lmac_id, bool enable)\n{\n\tu64 cfg, pfc_class_mask_cfg;\n\trpm_t *rpm = rpmd;\n\n\t \n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tcfg |= RPMX_MTI_MAC100X_COMMAND_CONFIG_RX_P_DISABLE;\n\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\n\t \n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tcfg |= RPMX_MTI_MAC100X_COMMAND_CONFIG_PAUSE_IGNORE;\n\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\n\t \n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tcfg |= RPMX_MTI_MAC100X_COMMAND_CONFIG_TX_P_DISABLE;\n\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\n\t \n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tcfg &= ~RPMX_MTI_MAC100X_COMMAND_CONFIG_PAUSE_FWD;\n\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\n\t \n\tif (is_dev_rpm2(rpm))\n\t\trpm_write(rpm, lmac_id, RPM2_CMR_CHAN_MSK_OR, 0xffff);\n\telse\n\t\trpm_write(rpm, 0, RPMX_CMR_CHAN_MSK_OR, ~0ULL);\n\n\t \n\tpfc_class_mask_cfg = is_dev_rpm2(rpm) ? RPM2_CMRX_PRT_CBFC_CTL :\n\t\t\t\t\t\tRPMX_CMRX_PRT_CBFC_CTL;\n\tcfg = rpm_read(rpm, lmac_id, pfc_class_mask_cfg);\n\tcfg = FIELD_SET(RPM_PFC_CLASS_MASK, 0, cfg);\n\trpm_write(rpm, lmac_id, pfc_class_mask_cfg, cfg);\n}\n\nint rpm_get_rx_stats(void *rpmd, int lmac_id, int idx, u64 *rx_stat)\n{\n\trpm_t *rpm = rpmd;\n\tu64 val_lo, val_hi;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\tmutex_lock(&rpm->lock);\n\n\t \n\tidx += lmac_id * rpm->mac_ops->rx_stats_cnt;\n\n\t \n\tval_lo = rpm_read(rpm, 0, RPMX_MTI_STAT_RX_STAT_PAGES_COUNTERX +\n\t\t\t  (idx * 8));\n\n\t \n\tval_hi = rpm_read(rpm, 0, RPMX_MTI_STAT_DATA_HI_CDC);\n\n\t*rx_stat = (val_hi << 32 | val_lo);\n\n\tmutex_unlock(&rpm->lock);\n\treturn 0;\n}\n\nint rpm_get_tx_stats(void *rpmd, int lmac_id, int idx, u64 *tx_stat)\n{\n\trpm_t *rpm = rpmd;\n\tu64 val_lo, val_hi;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\tmutex_lock(&rpm->lock);\n\n\t \n\tidx += lmac_id * rpm->mac_ops->tx_stats_cnt;\n\n\tval_lo = rpm_read(rpm, 0, RPMX_MTI_STAT_TX_STAT_PAGES_COUNTERX +\n\t\t\t    (idx * 8));\n\tval_hi = rpm_read(rpm, 0, RPMX_MTI_STAT_DATA_HI_CDC);\n\n\t*tx_stat = (val_hi << 32 | val_lo);\n\n\tmutex_unlock(&rpm->lock);\n\treturn 0;\n}\n\nu8 rpm_get_lmac_type(void *rpmd, int lmac_id)\n{\n\trpm_t *rpm = rpmd;\n\tu64 req = 0, resp;\n\tint err;\n\n\treq = FIELD_SET(CMDREG_ID, CGX_CMD_GET_LINK_STS, req);\n\terr = cgx_fwi_cmd_generic(req, &resp, rpm, 0);\n\tif (!err)\n\t\treturn FIELD_GET(RESP_LINKSTAT_LMAC_TYPE, resp);\n\treturn err;\n}\n\nu32 rpm_get_lmac_fifo_len(void *rpmd, int lmac_id)\n{\n\trpm_t *rpm = rpmd;\n\tu64 hi_perf_lmac;\n\tu8 num_lmacs;\n\tu32 fifo_len;\n\n\tfifo_len = rpm->mac_ops->fifo_len;\n\tnum_lmacs = rpm->mac_ops->get_nr_lmacs(rpm);\n\n\tswitch (num_lmacs) {\n\tcase 1:\n\t\treturn fifo_len;\n\tcase 2:\n\t\treturn fifo_len / 2;\n\tcase 3:\n\t\t \n\t\thi_perf_lmac = rpm_read(rpm, 0, CGXX_CMRX_RX_LMACS);\n\t\thi_perf_lmac = (hi_perf_lmac >> 4) & 0x3ULL;\n\t\tif (lmac_id == hi_perf_lmac)\n\t\t\treturn fifo_len / 2;\n\t\treturn fifo_len / 4;\n\tcase 4:\n\tdefault:\n\t\treturn fifo_len / 4;\n\t}\n\treturn 0;\n}\n\nstatic int rpmusx_lmac_internal_loopback(rpm_t *rpm, int lmac_id, bool enable)\n{\n\tu64 cfg;\n\n\tcfg = rpm_read(rpm, lmac_id, RPM2_USX_PCSX_CONTROL1);\n\n\tif (enable)\n\t\tcfg |= RPM2_USX_PCS_LBK;\n\telse\n\t\tcfg &= ~RPM2_USX_PCS_LBK;\n\trpm_write(rpm, lmac_id, RPM2_USX_PCSX_CONTROL1, cfg);\n\n\treturn 0;\n}\n\nu32 rpm2_get_lmac_fifo_len(void *rpmd, int lmac_id)\n{\n\tu64 hi_perf_lmac, lmac_info;\n\trpm_t *rpm = rpmd;\n\tu8 num_lmacs;\n\tu32 fifo_len;\n\tu16 max_lmac;\n\n\tlmac_info = rpm_read(rpm, 0, RPM2_CMRX_RX_LMACS);\n\t \n\tmax_lmac = (rpm_read(rpm, 0, CGX_CONST) >> 24) & 0xFF;\n\tif (max_lmac > 4)\n\t\tfifo_len = rpm->mac_ops->fifo_len / 2;\n\telse\n\t\tfifo_len = rpm->mac_ops->fifo_len;\n\n\tif (lmac_id < 4) {\n\t\tnum_lmacs = hweight8(lmac_info & 0xF);\n\t\thi_perf_lmac = (lmac_info >> 8) & 0x3ULL;\n\t} else {\n\t\tnum_lmacs = hweight8(lmac_info & 0xF0);\n\t\thi_perf_lmac = (lmac_info >> 10) & 0x3ULL;\n\t\thi_perf_lmac += 4;\n\t}\n\n\tswitch (num_lmacs) {\n\tcase 1:\n\t\treturn fifo_len;\n\tcase 2:\n\t\treturn fifo_len / 2;\n\tcase 3:\n\t\t \n\t\tif (lmac_id == hi_perf_lmac)\n\t\t\treturn fifo_len / 2;\n\t\treturn fifo_len / 4;\n\tcase 4:\n\tdefault:\n\t\treturn fifo_len / 4;\n\t}\n\treturn 0;\n}\n\nint rpm_lmac_internal_loopback(void *rpmd, int lmac_id, bool enable)\n{\n\trpm_t *rpm = rpmd;\n\tstruct lmac *lmac;\n\tu64 cfg;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\tlmac = lmac_pdata(lmac_id, rpm);\n\tif (lmac->lmac_type == LMAC_MODE_QSGMII ||\n\t    lmac->lmac_type == LMAC_MODE_SGMII) {\n\t\tdev_err(&rpm->pdev->dev, \"loopback not supported for LPC mode\\n\");\n\t\treturn 0;\n\t}\n\n\tif (is_dev_rpm2(rpm) && is_mac_rpmusx(rpm))\n\t\treturn rpmusx_lmac_internal_loopback(rpm, lmac_id, enable);\n\n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_PCS100X_CONTROL1);\n\n\tif (enable)\n\t\tcfg |= RPMX_MTI_PCS_LBK;\n\telse\n\t\tcfg &= ~RPMX_MTI_PCS_LBK;\n\trpm_write(rpm, lmac_id, RPMX_MTI_PCS100X_CONTROL1, cfg);\n\n\treturn 0;\n}\n\nvoid rpm_lmac_ptp_config(void *rpmd, int lmac_id, bool enable)\n{\n\trpm_t *rpm = rpmd;\n\tu64 cfg;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn;\n\n\tcfg = rpm_read(rpm, lmac_id, RPMX_CMRX_CFG);\n\tif (enable) {\n\t\tcfg |= RPMX_RX_TS_PREPEND;\n\t\tcfg |= RPMX_TX_PTP_1S_SUPPORT;\n\t} else {\n\t\tcfg &= ~RPMX_RX_TS_PREPEND;\n\t\tcfg &= ~RPMX_TX_PTP_1S_SUPPORT;\n\t}\n\n\trpm_write(rpm, lmac_id, RPMX_CMRX_CFG, cfg);\n\n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_XIF_MODE);\n\n\tif (enable) {\n\t\tcfg |= RPMX_ONESTEP_ENABLE;\n\t\tcfg &= ~RPMX_TS_BINARY_MODE;\n\t} else {\n\t\tcfg &= ~RPMX_ONESTEP_ENABLE;\n\t}\n\n\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_XIF_MODE, cfg);\n}\n\nint rpm_lmac_pfc_config(void *rpmd, int lmac_id, u8 tx_pause, u8 rx_pause, u16 pfc_en)\n{\n\tu64 cfg, class_en, pfc_class_mask_cfg;\n\trpm_t *rpm = rpmd;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\tpfc_class_mask_cfg = is_dev_rpm2(rpm) ? RPM2_CMRX_PRT_CBFC_CTL :\n\t\t\t\t\t\tRPMX_CMRX_PRT_CBFC_CTL;\n\n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tclass_en = rpm_read(rpm, lmac_id, pfc_class_mask_cfg);\n\tpfc_en |= FIELD_GET(RPM_PFC_CLASS_MASK, class_en);\n\n\tif (rx_pause) {\n\t\tcfg &= ~(RPMX_MTI_MAC100X_COMMAND_CONFIG_RX_P_DISABLE |\n\t\t\t RPMX_MTI_MAC100X_COMMAND_CONFIG_PAUSE_IGNORE);\n\t} else {\n\t\tcfg |= (RPMX_MTI_MAC100X_COMMAND_CONFIG_RX_P_DISABLE |\n\t\t\tRPMX_MTI_MAC100X_COMMAND_CONFIG_PAUSE_IGNORE);\n\t}\n\n\tif (tx_pause) {\n\t\trpm_cfg_pfc_quanta_thresh(rpm, lmac_id, pfc_en, true);\n\t\tcfg &= ~RPMX_MTI_MAC100X_COMMAND_CONFIG_TX_P_DISABLE;\n\t\tclass_en = FIELD_SET(RPM_PFC_CLASS_MASK, pfc_en, class_en);\n\t} else {\n\t\trpm_cfg_pfc_quanta_thresh(rpm, lmac_id, 0xfff, false);\n\t\tcfg |= RPMX_MTI_MAC100X_COMMAND_CONFIG_TX_P_DISABLE;\n\t\tclass_en = FIELD_SET(RPM_PFC_CLASS_MASK, 0, class_en);\n\t}\n\n\tif (!rx_pause && !tx_pause)\n\t\tcfg &= ~RPMX_MTI_MAC100X_COMMAND_CONFIG_PFC_MODE;\n\telse\n\t\tcfg |= RPMX_MTI_MAC100X_COMMAND_CONFIG_PFC_MODE;\n\n\trpm_write(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG, cfg);\n\trpm_write(rpm, lmac_id, pfc_class_mask_cfg, class_en);\n\n\treturn 0;\n}\n\nint  rpm_lmac_get_pfc_frm_cfg(void *rpmd, int lmac_id, u8 *tx_pause, u8 *rx_pause)\n{\n\trpm_t *rpm = rpmd;\n\tu64 cfg;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\tcfg = rpm_read(rpm, lmac_id, RPMX_MTI_MAC100X_COMMAND_CONFIG);\n\tif (cfg & RPMX_MTI_MAC100X_COMMAND_CONFIG_PFC_MODE) {\n\t\t*rx_pause = !(cfg & RPMX_MTI_MAC100X_COMMAND_CONFIG_RX_P_DISABLE);\n\t\t*tx_pause = !(cfg & RPMX_MTI_MAC100X_COMMAND_CONFIG_TX_P_DISABLE);\n\t}\n\n\treturn 0;\n}\n\nint rpm_get_fec_stats(void *rpmd, int lmac_id, struct cgx_fec_stats_rsp *rsp)\n{\n\tu64 val_lo, val_hi;\n\trpm_t *rpm = rpmd;\n\tu64 cfg;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\tif (rpm->lmac_idmap[lmac_id]->link_info.fec == OTX2_FEC_NONE)\n\t\treturn 0;\n\n\tif (rpm->lmac_idmap[lmac_id]->link_info.fec == OTX2_FEC_BASER) {\n\t\tval_lo = rpm_read(rpm, lmac_id, RPMX_MTI_FCFECX_VL0_CCW_LO);\n\t\tval_hi = rpm_read(rpm, lmac_id, RPMX_MTI_FCFECX_CW_HI);\n\t\trsp->fec_corr_blks = (val_hi << 16 | val_lo);\n\n\t\tval_lo = rpm_read(rpm, lmac_id, RPMX_MTI_FCFECX_VL0_NCCW_LO);\n\t\tval_hi = rpm_read(rpm, lmac_id, RPMX_MTI_FCFECX_CW_HI);\n\t\trsp->fec_uncorr_blks = (val_hi << 16 | val_lo);\n\n\t\t \n\t\tif (rpm->lmac_idmap[lmac_id]->link_info.lmac_type_id ==\n\t\t    LMAC_MODE_50G_R) {\n\t\t\tval_lo = rpm_read(rpm, lmac_id,\n\t\t\t\t\t  RPMX_MTI_FCFECX_VL1_CCW_LO);\n\t\t\tval_hi = rpm_read(rpm, lmac_id,\n\t\t\t\t\t  RPMX_MTI_FCFECX_CW_HI);\n\t\t\trsp->fec_corr_blks += (val_hi << 16 | val_lo);\n\n\t\t\tval_lo = rpm_read(rpm, lmac_id,\n\t\t\t\t\t  RPMX_MTI_FCFECX_VL1_NCCW_LO);\n\t\t\tval_hi = rpm_read(rpm, lmac_id,\n\t\t\t\t\t  RPMX_MTI_FCFECX_CW_HI);\n\t\t\trsp->fec_uncorr_blks += (val_hi << 16 | val_lo);\n\t\t}\n\t} else {\n\t\t \n\t\tcfg = rpm_read(rpm, 0, RPMX_MTI_STAT_STATN_CONTROL);\n\t\tcfg |= RPMX_RSFEC_RX_CAPTURE | BIT(lmac_id);\n\t\trpm_write(rpm, 0, RPMX_MTI_STAT_STATN_CONTROL, cfg);\n\n\t\tval_lo = rpm_read(rpm, 0,\n\t\t\t\t  RPMX_MTI_RSFEC_STAT_COUNTER_CAPTURE_2);\n\t\tval_hi = rpm_read(rpm, 0, RPMX_MTI_STAT_DATA_HI_CDC);\n\t\trsp->fec_corr_blks = (val_hi << 32 | val_lo);\n\n\t\tval_lo = rpm_read(rpm, 0,\n\t\t\t\t  RPMX_MTI_RSFEC_STAT_COUNTER_CAPTURE_3);\n\t\tval_hi = rpm_read(rpm, 0, RPMX_MTI_STAT_DATA_HI_CDC);\n\t\trsp->fec_uncorr_blks = (val_hi << 32 | val_lo);\n\t}\n\n\treturn 0;\n}\n\nint rpm_lmac_reset(void *rpmd, int lmac_id, u8 pf_req_flr)\n{\n\tu64 rx_logl_xon, cfg;\n\trpm_t *rpm = rpmd;\n\n\tif (!is_lmac_valid(rpm, lmac_id))\n\t\treturn -ENODEV;\n\n\t \n\trx_logl_xon = is_dev_rpm2(rpm) ? RPM2_CMRX_RX_LOGL_XON :\n\t\t\t\t\t RPMX_CMRX_RX_LOGL_XON;\n\tcfg = 0xff;\n\n\trpm_write(rpm, lmac_id, rx_logl_xon, cfg);\n\n\tif (pf_req_flr)\n\t\trpm_lmac_internal_loopback(rpm, lmac_id, false);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}