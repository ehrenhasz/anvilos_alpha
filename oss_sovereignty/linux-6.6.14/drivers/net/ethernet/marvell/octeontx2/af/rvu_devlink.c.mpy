{
  "module_name": "rvu_devlink.c",
  "hash_id": "4c2803da153a374e45682cb50658be6e1e8f54d3ae9b9828dea8e000cbee279a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/marvell/octeontx2/af/rvu_devlink.c",
  "human_readable_source": "\n \n\n#include<linux/bitfield.h>\n\n#include \"rvu.h\"\n#include \"rvu_reg.h\"\n#include \"rvu_struct.h\"\n#include \"rvu_npc_hash.h\"\n\n#define DRV_NAME \"octeontx2-af\"\n\nstatic int rvu_report_pair_start(struct devlink_fmsg *fmsg, const char *name)\n{\n\tint err;\n\n\terr = devlink_fmsg_pair_nest_start(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\treturn  devlink_fmsg_obj_nest_start(fmsg);\n}\n\nstatic int rvu_report_pair_end(struct devlink_fmsg *fmsg)\n{\n\tint err;\n\n\terr = devlink_fmsg_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn devlink_fmsg_pair_nest_end(fmsg);\n}\n\nstatic bool rvu_common_request_irq(struct rvu *rvu, int offset,\n\t\t\t\t   const char *name, irq_handler_t fn)\n{\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tint rc;\n\n\tsprintf(&rvu->irq_name[offset * NAME_SIZE], \"%s\", name);\n\trc = request_irq(pci_irq_vector(rvu->pdev, offset), fn, 0,\n\t\t\t &rvu->irq_name[offset * NAME_SIZE], rvu_dl);\n\tif (rc)\n\t\tdev_warn(rvu->dev, \"Failed to register %s irq\\n\", name);\n\telse\n\t\trvu->irq_allocated[offset] = true;\n\n\treturn rvu->irq_allocated[offset];\n}\n\nstatic void rvu_nix_intr_work(struct work_struct *work)\n{\n\tstruct rvu_nix_health_reporters *rvu_nix_health_reporter;\n\n\trvu_nix_health_reporter = container_of(work, struct rvu_nix_health_reporters, intr_work);\n\tdevlink_health_report(rvu_nix_health_reporter->rvu_hw_nix_intr_reporter,\n\t\t\t      \"NIX_AF_RVU Error\",\n\t\t\t      rvu_nix_health_reporter->nix_event_ctx);\n}\n\nstatic irqreturn_t rvu_nix_af_rvu_intr_handler(int irq, void *rvu_irq)\n{\n\tstruct rvu_nix_event_ctx *nix_event_context;\n\tstruct rvu_devlink *rvu_dl = rvu_irq;\n\tstruct rvu *rvu;\n\tint blkaddr;\n\tu64 intr;\n\n\trvu = rvu_dl->rvu;\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NIX, 0);\n\tif (blkaddr < 0)\n\t\treturn IRQ_NONE;\n\n\tnix_event_context = rvu_dl->rvu_nix_health_reporter->nix_event_ctx;\n\tintr = rvu_read64(rvu, blkaddr, NIX_AF_RVU_INT);\n\tnix_event_context->nix_af_rvu_int = intr;\n\n\t \n\trvu_write64(rvu, blkaddr, NIX_AF_RVU_INT, intr);\n\trvu_write64(rvu, blkaddr, NIX_AF_RVU_INT_ENA_W1C, ~0ULL);\n\tqueue_work(rvu_dl->devlink_wq, &rvu_dl->rvu_nix_health_reporter->intr_work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rvu_nix_gen_work(struct work_struct *work)\n{\n\tstruct rvu_nix_health_reporters *rvu_nix_health_reporter;\n\n\trvu_nix_health_reporter = container_of(work, struct rvu_nix_health_reporters, gen_work);\n\tdevlink_health_report(rvu_nix_health_reporter->rvu_hw_nix_gen_reporter,\n\t\t\t      \"NIX_AF_GEN Error\",\n\t\t\t      rvu_nix_health_reporter->nix_event_ctx);\n}\n\nstatic irqreturn_t rvu_nix_af_rvu_gen_handler(int irq, void *rvu_irq)\n{\n\tstruct rvu_nix_event_ctx *nix_event_context;\n\tstruct rvu_devlink *rvu_dl = rvu_irq;\n\tstruct rvu *rvu;\n\tint blkaddr;\n\tu64 intr;\n\n\trvu = rvu_dl->rvu;\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NIX, 0);\n\tif (blkaddr < 0)\n\t\treturn IRQ_NONE;\n\n\tnix_event_context = rvu_dl->rvu_nix_health_reporter->nix_event_ctx;\n\tintr = rvu_read64(rvu, blkaddr, NIX_AF_GEN_INT);\n\tnix_event_context->nix_af_rvu_gen = intr;\n\n\t \n\trvu_write64(rvu, blkaddr, NIX_AF_GEN_INT, intr);\n\trvu_write64(rvu, blkaddr, NIX_AF_GEN_INT_ENA_W1C, ~0ULL);\n\tqueue_work(rvu_dl->devlink_wq, &rvu_dl->rvu_nix_health_reporter->gen_work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rvu_nix_err_work(struct work_struct *work)\n{\n\tstruct rvu_nix_health_reporters *rvu_nix_health_reporter;\n\n\trvu_nix_health_reporter = container_of(work, struct rvu_nix_health_reporters, err_work);\n\tdevlink_health_report(rvu_nix_health_reporter->rvu_hw_nix_err_reporter,\n\t\t\t      \"NIX_AF_ERR Error\",\n\t\t\t      rvu_nix_health_reporter->nix_event_ctx);\n}\n\nstatic irqreturn_t rvu_nix_af_rvu_err_handler(int irq, void *rvu_irq)\n{\n\tstruct rvu_nix_event_ctx *nix_event_context;\n\tstruct rvu_devlink *rvu_dl = rvu_irq;\n\tstruct rvu *rvu;\n\tint blkaddr;\n\tu64 intr;\n\n\trvu = rvu_dl->rvu;\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NIX, 0);\n\tif (blkaddr < 0)\n\t\treturn IRQ_NONE;\n\n\tnix_event_context = rvu_dl->rvu_nix_health_reporter->nix_event_ctx;\n\tintr = rvu_read64(rvu, blkaddr, NIX_AF_ERR_INT);\n\tnix_event_context->nix_af_rvu_err = intr;\n\n\t \n\trvu_write64(rvu, blkaddr, NIX_AF_ERR_INT, intr);\n\trvu_write64(rvu, blkaddr, NIX_AF_ERR_INT_ENA_W1C, ~0ULL);\n\tqueue_work(rvu_dl->devlink_wq, &rvu_dl->rvu_nix_health_reporter->err_work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rvu_nix_ras_work(struct work_struct *work)\n{\n\tstruct rvu_nix_health_reporters *rvu_nix_health_reporter;\n\n\trvu_nix_health_reporter = container_of(work, struct rvu_nix_health_reporters, ras_work);\n\tdevlink_health_report(rvu_nix_health_reporter->rvu_hw_nix_ras_reporter,\n\t\t\t      \"NIX_AF_RAS Error\",\n\t\t\t      rvu_nix_health_reporter->nix_event_ctx);\n}\n\nstatic irqreturn_t rvu_nix_af_rvu_ras_handler(int irq, void *rvu_irq)\n{\n\tstruct rvu_nix_event_ctx *nix_event_context;\n\tstruct rvu_devlink *rvu_dl = rvu_irq;\n\tstruct rvu *rvu;\n\tint blkaddr;\n\tu64 intr;\n\n\trvu = rvu_dl->rvu;\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NIX, 0);\n\tif (blkaddr < 0)\n\t\treturn IRQ_NONE;\n\n\tnix_event_context = rvu_dl->rvu_nix_health_reporter->nix_event_ctx;\n\tintr = rvu_read64(rvu, blkaddr, NIX_AF_ERR_INT);\n\tnix_event_context->nix_af_rvu_ras = intr;\n\n\t \n\trvu_write64(rvu, blkaddr, NIX_AF_RAS, intr);\n\trvu_write64(rvu, blkaddr, NIX_AF_RAS_ENA_W1C, ~0ULL);\n\tqueue_work(rvu_dl->devlink_wq, &rvu_dl->rvu_nix_health_reporter->ras_work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rvu_nix_unregister_interrupts(struct rvu *rvu)\n{\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tint offs, i, blkaddr;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NIX, 0);\n\tif (blkaddr < 0)\n\t\treturn;\n\n\toffs = rvu_read64(rvu, blkaddr, NIX_PRIV_AF_INT_CFG) & 0x3ff;\n\tif (!offs)\n\t\treturn;\n\n\trvu_write64(rvu, blkaddr, NIX_AF_RVU_INT_ENA_W1C, ~0ULL);\n\trvu_write64(rvu, blkaddr, NIX_AF_GEN_INT_ENA_W1C, ~0ULL);\n\trvu_write64(rvu, blkaddr, NIX_AF_ERR_INT_ENA_W1C, ~0ULL);\n\trvu_write64(rvu, blkaddr, NIX_AF_RAS_ENA_W1C, ~0ULL);\n\n\tif (rvu->irq_allocated[offs + NIX_AF_INT_VEC_RVU]) {\n\t\tfree_irq(pci_irq_vector(rvu->pdev, offs + NIX_AF_INT_VEC_RVU),\n\t\t\t rvu_dl);\n\t\trvu->irq_allocated[offs + NIX_AF_INT_VEC_RVU] = false;\n\t}\n\n\tfor (i = NIX_AF_INT_VEC_AF_ERR; i < NIX_AF_INT_VEC_CNT; i++)\n\t\tif (rvu->irq_allocated[offs + i]) {\n\t\t\tfree_irq(pci_irq_vector(rvu->pdev, offs + i), rvu_dl);\n\t\t\trvu->irq_allocated[offs + i] = false;\n\t\t}\n}\n\nstatic int rvu_nix_register_interrupts(struct rvu *rvu)\n{\n\tint blkaddr, base;\n\tbool rc;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NIX, 0);\n\tif (blkaddr < 0)\n\t\treturn blkaddr;\n\n\t \n\tbase = rvu_read64(rvu, blkaddr, NIX_PRIV_AF_INT_CFG) & 0x3ff;\n\tif (!base) {\n\t\tdev_warn(rvu->dev,\n\t\t\t \"Failed to get NIX%d NIX_AF_INT vector offsets\\n\",\n\t\t\t blkaddr - BLKADDR_NIX0);\n\t\treturn 0;\n\t}\n\t \n\trc = rvu_common_request_irq(rvu, base +  NIX_AF_INT_VEC_RVU,\n\t\t\t\t    \"NIX_AF_RVU_INT\",\n\t\t\t\t    rvu_nix_af_rvu_intr_handler);\n\tif (!rc)\n\t\tgoto err;\n\trvu_write64(rvu, blkaddr, NIX_AF_RVU_INT_ENA_W1S, ~0ULL);\n\n\t \n\trc = rvu_common_request_irq(rvu, base +  NIX_AF_INT_VEC_GEN,\n\t\t\t\t    \"NIX_AF_GEN_INT\",\n\t\t\t\t    rvu_nix_af_rvu_gen_handler);\n\tif (!rc)\n\t\tgoto err;\n\trvu_write64(rvu, blkaddr, NIX_AF_GEN_INT_ENA_W1S, ~0ULL);\n\n\t \n\trc = rvu_common_request_irq(rvu, base + NIX_AF_INT_VEC_AF_ERR,\n\t\t\t\t    \"NIX_AF_ERR_INT\",\n\t\t\t\t    rvu_nix_af_rvu_err_handler);\n\tif (!rc)\n\t\tgoto err;\n\trvu_write64(rvu, blkaddr, NIX_AF_ERR_INT_ENA_W1S, ~0ULL);\n\n\t \n\trc = rvu_common_request_irq(rvu, base + NIX_AF_INT_VEC_POISON,\n\t\t\t\t    \"NIX_AF_RAS\",\n\t\t\t\t    rvu_nix_af_rvu_ras_handler);\n\tif (!rc)\n\t\tgoto err;\n\trvu_write64(rvu, blkaddr, NIX_AF_RAS_ENA_W1S, ~0ULL);\n\n\treturn 0;\nerr:\n\trvu_nix_unregister_interrupts(rvu);\n\treturn rc;\n}\n\nstatic int rvu_nix_report_show(struct devlink_fmsg *fmsg, void *ctx,\n\t\t\t       enum nix_af_rvu_health health_reporter)\n{\n\tstruct rvu_nix_event_ctx *nix_event_context;\n\tu64 intr_val;\n\tint err;\n\n\tnix_event_context = ctx;\n\tswitch (health_reporter) {\n\tcase NIX_AF_RVU_INTR:\n\t\tintr_val = nix_event_context->nix_af_rvu_int;\n\t\terr = rvu_report_pair_start(fmsg, \"NIX_AF_RVU\");\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_u64_pair_put(fmsg, \"\\tNIX RVU Interrupt Reg \",\n\t\t\t\t\t\tnix_event_context->nix_af_rvu_int);\n\t\tif (err)\n\t\t\treturn err;\n\t\tif (intr_val & BIT_ULL(0)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tUnmap Slot Error\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\terr = rvu_report_pair_end(fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t\tbreak;\n\tcase NIX_AF_RVU_GEN:\n\t\tintr_val = nix_event_context->nix_af_rvu_gen;\n\t\terr = rvu_report_pair_start(fmsg, \"NIX_AF_GENERAL\");\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_u64_pair_put(fmsg, \"\\tNIX General Interrupt Reg \",\n\t\t\t\t\t\tnix_event_context->nix_af_rvu_gen);\n\t\tif (err)\n\t\t\treturn err;\n\t\tif (intr_val & BIT_ULL(0)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tRx multicast pkt drop\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(1)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tRx mirror pkt drop\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(4)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tSMQ flush done\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\terr = rvu_report_pair_end(fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t\tbreak;\n\tcase NIX_AF_RVU_ERR:\n\t\tintr_val = nix_event_context->nix_af_rvu_err;\n\t\terr = rvu_report_pair_start(fmsg, \"NIX_AF_ERR\");\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_u64_pair_put(fmsg, \"\\tNIX Error Interrupt Reg \",\n\t\t\t\t\t\tnix_event_context->nix_af_rvu_err);\n\t\tif (err)\n\t\t\treturn err;\n\t\tif (intr_val & BIT_ULL(14)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFault on NIX_AQ_INST_S read\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(13)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFault on NIX_AQ_RES_S write\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(12)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tAQ Doorbell Error\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(6)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tRx on unmapped PF_FUNC\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(5)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tRx multicast replication error\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(4)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFault on NIX_RX_MCE_S read\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(3)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFault on multicast WQE read\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(2)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFault on mirror WQE read\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(1)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFault on mirror pkt write\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(0)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFault on multicast pkt write\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\terr = rvu_report_pair_end(fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t\tbreak;\n\tcase NIX_AF_RVU_RAS:\n\t\tintr_val = nix_event_context->nix_af_rvu_err;\n\t\terr = rvu_report_pair_start(fmsg, \"NIX_AF_RAS\");\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_u64_pair_put(fmsg, \"\\tNIX RAS Interrupt Reg \",\n\t\t\t\t\t\tnix_event_context->nix_af_rvu_err);\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tPoison Data on:\");\n\t\tif (err)\n\t\t\treturn err;\n\t\tif (intr_val & BIT_ULL(34)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX_AQ_INST_S\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(33)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX_AQ_RES_S\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(32)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tHW ctx\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(4)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tPacket from mirror buffer\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(3)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tPacket from multicast buffer\");\n\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(2)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tWQE read from mirror buffer\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(1)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tWQE read from multicast buffer\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (intr_val & BIT_ULL(0)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX_RX_MCE_S read\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\terr = rvu_report_pair_end(fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int rvu_hw_nix_intr_dump(struct devlink_health_reporter *reporter,\n\t\t\t\tstruct devlink_fmsg *fmsg, void *ctx,\n\t\t\t\tstruct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tstruct rvu_nix_event_ctx *nix_ctx;\n\n\tnix_ctx = rvu_dl->rvu_nix_health_reporter->nix_event_ctx;\n\n\treturn ctx ? rvu_nix_report_show(fmsg, ctx, NIX_AF_RVU_INTR) :\n\t\t     rvu_nix_report_show(fmsg, nix_ctx, NIX_AF_RVU_INTR);\n}\n\nstatic int rvu_hw_nix_intr_recover(struct devlink_health_reporter *reporter,\n\t\t\t\t   void *ctx, struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_nix_event_ctx *nix_event_ctx = ctx;\n\tint blkaddr;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NIX, 0);\n\tif (blkaddr < 0)\n\t\treturn blkaddr;\n\n\tif (nix_event_ctx->nix_af_rvu_int)\n\t\trvu_write64(rvu, blkaddr, NIX_AF_RVU_INT_ENA_W1S, ~0ULL);\n\n\treturn 0;\n}\n\nstatic int rvu_hw_nix_gen_dump(struct devlink_health_reporter *reporter,\n\t\t\t       struct devlink_fmsg *fmsg, void *ctx,\n\t\t\t       struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tstruct rvu_nix_event_ctx *nix_ctx;\n\n\tnix_ctx = rvu_dl->rvu_nix_health_reporter->nix_event_ctx;\n\n\treturn ctx ? rvu_nix_report_show(fmsg, ctx, NIX_AF_RVU_GEN) :\n\t\t     rvu_nix_report_show(fmsg, nix_ctx, NIX_AF_RVU_GEN);\n}\n\nstatic int rvu_hw_nix_gen_recover(struct devlink_health_reporter *reporter,\n\t\t\t\t  void *ctx, struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_nix_event_ctx *nix_event_ctx = ctx;\n\tint blkaddr;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NIX, 0);\n\tif (blkaddr < 0)\n\t\treturn blkaddr;\n\n\tif (nix_event_ctx->nix_af_rvu_gen)\n\t\trvu_write64(rvu, blkaddr, NIX_AF_GEN_INT_ENA_W1S, ~0ULL);\n\n\treturn 0;\n}\n\nstatic int rvu_hw_nix_err_dump(struct devlink_health_reporter *reporter,\n\t\t\t       struct devlink_fmsg *fmsg, void *ctx,\n\t\t\t       struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tstruct rvu_nix_event_ctx *nix_ctx;\n\n\tnix_ctx = rvu_dl->rvu_nix_health_reporter->nix_event_ctx;\n\n\treturn ctx ? rvu_nix_report_show(fmsg, ctx, NIX_AF_RVU_ERR) :\n\t\t     rvu_nix_report_show(fmsg, nix_ctx, NIX_AF_RVU_ERR);\n}\n\nstatic int rvu_hw_nix_err_recover(struct devlink_health_reporter *reporter,\n\t\t\t\t  void *ctx, struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_nix_event_ctx *nix_event_ctx = ctx;\n\tint blkaddr;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NIX, 0);\n\tif (blkaddr < 0)\n\t\treturn blkaddr;\n\n\tif (nix_event_ctx->nix_af_rvu_err)\n\t\trvu_write64(rvu, blkaddr, NIX_AF_ERR_INT_ENA_W1S, ~0ULL);\n\n\treturn 0;\n}\n\nstatic int rvu_hw_nix_ras_dump(struct devlink_health_reporter *reporter,\n\t\t\t       struct devlink_fmsg *fmsg, void *ctx,\n\t\t\t       struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tstruct rvu_nix_event_ctx *nix_ctx;\n\n\tnix_ctx = rvu_dl->rvu_nix_health_reporter->nix_event_ctx;\n\n\treturn ctx ? rvu_nix_report_show(fmsg, ctx, NIX_AF_RVU_RAS) :\n\t\t     rvu_nix_report_show(fmsg, nix_ctx, NIX_AF_RVU_RAS);\n}\n\nstatic int rvu_hw_nix_ras_recover(struct devlink_health_reporter *reporter,\n\t\t\t\t  void *ctx, struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_nix_event_ctx *nix_event_ctx = ctx;\n\tint blkaddr;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NIX, 0);\n\tif (blkaddr < 0)\n\t\treturn blkaddr;\n\n\tif (nix_event_ctx->nix_af_rvu_int)\n\t\trvu_write64(rvu, blkaddr, NIX_AF_RAS_ENA_W1S, ~0ULL);\n\n\treturn 0;\n}\n\nRVU_REPORTERS(hw_nix_intr);\nRVU_REPORTERS(hw_nix_gen);\nRVU_REPORTERS(hw_nix_err);\nRVU_REPORTERS(hw_nix_ras);\n\nstatic void rvu_nix_health_reporters_destroy(struct rvu_devlink *rvu_dl);\n\nstatic int rvu_nix_register_reporters(struct rvu_devlink *rvu_dl)\n{\n\tstruct rvu_nix_health_reporters *rvu_reporters;\n\tstruct rvu_nix_event_ctx *nix_event_context;\n\tstruct rvu *rvu = rvu_dl->rvu;\n\n\trvu_reporters = kzalloc(sizeof(*rvu_reporters), GFP_KERNEL);\n\tif (!rvu_reporters)\n\t\treturn -ENOMEM;\n\n\trvu_dl->rvu_nix_health_reporter = rvu_reporters;\n\tnix_event_context = kzalloc(sizeof(*nix_event_context), GFP_KERNEL);\n\tif (!nix_event_context)\n\t\treturn -ENOMEM;\n\n\trvu_reporters->nix_event_ctx = nix_event_context;\n\trvu_reporters->rvu_hw_nix_intr_reporter =\n\t\tdevlink_health_reporter_create(rvu_dl->dl, &rvu_hw_nix_intr_reporter_ops, 0, rvu);\n\tif (IS_ERR(rvu_reporters->rvu_hw_nix_intr_reporter)) {\n\t\tdev_warn(rvu->dev, \"Failed to create hw_nix_intr reporter, err=%ld\\n\",\n\t\t\t PTR_ERR(rvu_reporters->rvu_hw_nix_intr_reporter));\n\t\treturn PTR_ERR(rvu_reporters->rvu_hw_nix_intr_reporter);\n\t}\n\n\trvu_reporters->rvu_hw_nix_gen_reporter =\n\t\tdevlink_health_reporter_create(rvu_dl->dl, &rvu_hw_nix_gen_reporter_ops, 0, rvu);\n\tif (IS_ERR(rvu_reporters->rvu_hw_nix_gen_reporter)) {\n\t\tdev_warn(rvu->dev, \"Failed to create hw_nix_gen reporter, err=%ld\\n\",\n\t\t\t PTR_ERR(rvu_reporters->rvu_hw_nix_gen_reporter));\n\t\treturn PTR_ERR(rvu_reporters->rvu_hw_nix_gen_reporter);\n\t}\n\n\trvu_reporters->rvu_hw_nix_err_reporter =\n\t\tdevlink_health_reporter_create(rvu_dl->dl, &rvu_hw_nix_err_reporter_ops, 0, rvu);\n\tif (IS_ERR(rvu_reporters->rvu_hw_nix_err_reporter)) {\n\t\tdev_warn(rvu->dev, \"Failed to create hw_nix_err reporter, err=%ld\\n\",\n\t\t\t PTR_ERR(rvu_reporters->rvu_hw_nix_err_reporter));\n\t\treturn PTR_ERR(rvu_reporters->rvu_hw_nix_err_reporter);\n\t}\n\n\trvu_reporters->rvu_hw_nix_ras_reporter =\n\t\tdevlink_health_reporter_create(rvu_dl->dl, &rvu_hw_nix_ras_reporter_ops, 0, rvu);\n\tif (IS_ERR(rvu_reporters->rvu_hw_nix_ras_reporter)) {\n\t\tdev_warn(rvu->dev, \"Failed to create hw_nix_ras reporter, err=%ld\\n\",\n\t\t\t PTR_ERR(rvu_reporters->rvu_hw_nix_ras_reporter));\n\t\treturn PTR_ERR(rvu_reporters->rvu_hw_nix_ras_reporter);\n\t}\n\n\trvu_dl->devlink_wq = create_workqueue(\"rvu_devlink_wq\");\n\tif (!rvu_dl->devlink_wq)\n\t\treturn -ENOMEM;\n\n\tINIT_WORK(&rvu_reporters->intr_work, rvu_nix_intr_work);\n\tINIT_WORK(&rvu_reporters->gen_work, rvu_nix_gen_work);\n\tINIT_WORK(&rvu_reporters->err_work, rvu_nix_err_work);\n\tINIT_WORK(&rvu_reporters->ras_work, rvu_nix_ras_work);\n\n\treturn 0;\n}\n\nstatic int rvu_nix_health_reporters_create(struct rvu_devlink *rvu_dl)\n{\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tint err;\n\n\terr = rvu_nix_register_reporters(rvu_dl);\n\tif (err) {\n\t\tdev_warn(rvu->dev, \"Failed to create nix reporter, err =%d\\n\",\n\t\t\t err);\n\t\treturn err;\n\t}\n\trvu_nix_register_interrupts(rvu);\n\n\treturn 0;\n}\n\nstatic void rvu_nix_health_reporters_destroy(struct rvu_devlink *rvu_dl)\n{\n\tstruct rvu_nix_health_reporters *nix_reporters;\n\tstruct rvu *rvu = rvu_dl->rvu;\n\n\tnix_reporters = rvu_dl->rvu_nix_health_reporter;\n\n\tif (!nix_reporters->rvu_hw_nix_ras_reporter)\n\t\treturn;\n\tif (!IS_ERR_OR_NULL(nix_reporters->rvu_hw_nix_intr_reporter))\n\t\tdevlink_health_reporter_destroy(nix_reporters->rvu_hw_nix_intr_reporter);\n\n\tif (!IS_ERR_OR_NULL(nix_reporters->rvu_hw_nix_gen_reporter))\n\t\tdevlink_health_reporter_destroy(nix_reporters->rvu_hw_nix_gen_reporter);\n\n\tif (!IS_ERR_OR_NULL(nix_reporters->rvu_hw_nix_err_reporter))\n\t\tdevlink_health_reporter_destroy(nix_reporters->rvu_hw_nix_err_reporter);\n\n\tif (!IS_ERR_OR_NULL(nix_reporters->rvu_hw_nix_ras_reporter))\n\t\tdevlink_health_reporter_destroy(nix_reporters->rvu_hw_nix_ras_reporter);\n\n\trvu_nix_unregister_interrupts(rvu);\n\tkfree(rvu_dl->rvu_nix_health_reporter->nix_event_ctx);\n\tkfree(rvu_dl->rvu_nix_health_reporter);\n}\n\nstatic void rvu_npa_intr_work(struct work_struct *work)\n{\n\tstruct rvu_npa_health_reporters *rvu_npa_health_reporter;\n\n\trvu_npa_health_reporter = container_of(work, struct rvu_npa_health_reporters, intr_work);\n\tdevlink_health_report(rvu_npa_health_reporter->rvu_hw_npa_intr_reporter,\n\t\t\t      \"NPA_AF_RVU Error\",\n\t\t\t      rvu_npa_health_reporter->npa_event_ctx);\n}\n\nstatic irqreturn_t rvu_npa_af_rvu_intr_handler(int irq, void *rvu_irq)\n{\n\tstruct rvu_npa_event_ctx *npa_event_context;\n\tstruct rvu_devlink *rvu_dl = rvu_irq;\n\tstruct rvu *rvu;\n\tint blkaddr;\n\tu64 intr;\n\n\trvu = rvu_dl->rvu;\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NPA, 0);\n\tif (blkaddr < 0)\n\t\treturn IRQ_NONE;\n\n\tnpa_event_context = rvu_dl->rvu_npa_health_reporter->npa_event_ctx;\n\tintr = rvu_read64(rvu, blkaddr, NPA_AF_RVU_INT);\n\tnpa_event_context->npa_af_rvu_int = intr;\n\n\t \n\trvu_write64(rvu, blkaddr, NPA_AF_RVU_INT, intr);\n\trvu_write64(rvu, blkaddr, NPA_AF_RVU_INT_ENA_W1C, ~0ULL);\n\tqueue_work(rvu_dl->devlink_wq, &rvu_dl->rvu_npa_health_reporter->intr_work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rvu_npa_gen_work(struct work_struct *work)\n{\n\tstruct rvu_npa_health_reporters *rvu_npa_health_reporter;\n\n\trvu_npa_health_reporter = container_of(work, struct rvu_npa_health_reporters, gen_work);\n\tdevlink_health_report(rvu_npa_health_reporter->rvu_hw_npa_gen_reporter,\n\t\t\t      \"NPA_AF_GEN Error\",\n\t\t\t      rvu_npa_health_reporter->npa_event_ctx);\n}\n\nstatic irqreturn_t rvu_npa_af_gen_intr_handler(int irq, void *rvu_irq)\n{\n\tstruct rvu_npa_event_ctx *npa_event_context;\n\tstruct rvu_devlink *rvu_dl = rvu_irq;\n\tstruct rvu *rvu;\n\tint blkaddr;\n\tu64 intr;\n\n\trvu = rvu_dl->rvu;\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NPA, 0);\n\tif (blkaddr < 0)\n\t\treturn IRQ_NONE;\n\n\tnpa_event_context = rvu_dl->rvu_npa_health_reporter->npa_event_ctx;\n\tintr = rvu_read64(rvu, blkaddr, NPA_AF_GEN_INT);\n\tnpa_event_context->npa_af_rvu_gen = intr;\n\n\t \n\trvu_write64(rvu, blkaddr, NPA_AF_GEN_INT, intr);\n\trvu_write64(rvu, blkaddr, NPA_AF_GEN_INT_ENA_W1C, ~0ULL);\n\tqueue_work(rvu_dl->devlink_wq, &rvu_dl->rvu_npa_health_reporter->gen_work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rvu_npa_err_work(struct work_struct *work)\n{\n\tstruct rvu_npa_health_reporters *rvu_npa_health_reporter;\n\n\trvu_npa_health_reporter = container_of(work, struct rvu_npa_health_reporters, err_work);\n\tdevlink_health_report(rvu_npa_health_reporter->rvu_hw_npa_err_reporter,\n\t\t\t      \"NPA_AF_ERR Error\",\n\t\t\t      rvu_npa_health_reporter->npa_event_ctx);\n}\n\nstatic irqreturn_t rvu_npa_af_err_intr_handler(int irq, void *rvu_irq)\n{\n\tstruct rvu_npa_event_ctx *npa_event_context;\n\tstruct rvu_devlink *rvu_dl = rvu_irq;\n\tstruct rvu *rvu;\n\tint blkaddr;\n\tu64 intr;\n\n\trvu = rvu_dl->rvu;\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NPA, 0);\n\tif (blkaddr < 0)\n\t\treturn IRQ_NONE;\n\tnpa_event_context = rvu_dl->rvu_npa_health_reporter->npa_event_ctx;\n\tintr = rvu_read64(rvu, blkaddr, NPA_AF_ERR_INT);\n\tnpa_event_context->npa_af_rvu_err = intr;\n\n\t \n\trvu_write64(rvu, blkaddr, NPA_AF_ERR_INT, intr);\n\trvu_write64(rvu, blkaddr, NPA_AF_ERR_INT_ENA_W1C, ~0ULL);\n\tqueue_work(rvu_dl->devlink_wq, &rvu_dl->rvu_npa_health_reporter->err_work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rvu_npa_ras_work(struct work_struct *work)\n{\n\tstruct rvu_npa_health_reporters *rvu_npa_health_reporter;\n\n\trvu_npa_health_reporter = container_of(work, struct rvu_npa_health_reporters, ras_work);\n\tdevlink_health_report(rvu_npa_health_reporter->rvu_hw_npa_ras_reporter,\n\t\t\t      \"HW NPA_AF_RAS Error reported\",\n\t\t\t      rvu_npa_health_reporter->npa_event_ctx);\n}\n\nstatic irqreturn_t rvu_npa_af_ras_intr_handler(int irq, void *rvu_irq)\n{\n\tstruct rvu_npa_event_ctx *npa_event_context;\n\tstruct rvu_devlink *rvu_dl = rvu_irq;\n\tstruct rvu *rvu;\n\tint blkaddr;\n\tu64 intr;\n\n\trvu = rvu_dl->rvu;\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NPA, 0);\n\tif (blkaddr < 0)\n\t\treturn IRQ_NONE;\n\n\tnpa_event_context = rvu_dl->rvu_npa_health_reporter->npa_event_ctx;\n\tintr = rvu_read64(rvu, blkaddr, NPA_AF_RAS);\n\tnpa_event_context->npa_af_rvu_ras = intr;\n\n\t \n\trvu_write64(rvu, blkaddr, NPA_AF_RAS, intr);\n\trvu_write64(rvu, blkaddr, NPA_AF_RAS_ENA_W1C, ~0ULL);\n\tqueue_work(rvu_dl->devlink_wq, &rvu_dl->rvu_npa_health_reporter->ras_work);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void rvu_npa_unregister_interrupts(struct rvu *rvu)\n{\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tint i, offs, blkaddr;\n\tu64 reg;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NPA, 0);\n\tif (blkaddr < 0)\n\t\treturn;\n\n\treg = rvu_read64(rvu, blkaddr, NPA_PRIV_AF_INT_CFG);\n\toffs = reg & 0x3FF;\n\n\trvu_write64(rvu, blkaddr, NPA_AF_RVU_INT_ENA_W1C, ~0ULL);\n\trvu_write64(rvu, blkaddr, NPA_AF_GEN_INT_ENA_W1C, ~0ULL);\n\trvu_write64(rvu, blkaddr, NPA_AF_ERR_INT_ENA_W1C, ~0ULL);\n\trvu_write64(rvu, blkaddr, NPA_AF_RAS_ENA_W1C, ~0ULL);\n\n\tfor (i = 0; i < NPA_AF_INT_VEC_CNT; i++)\n\t\tif (rvu->irq_allocated[offs + i]) {\n\t\t\tfree_irq(pci_irq_vector(rvu->pdev, offs + i), rvu_dl);\n\t\t\trvu->irq_allocated[offs + i] = false;\n\t\t}\n}\n\nstatic int rvu_npa_register_interrupts(struct rvu *rvu)\n{\n\tint blkaddr, base;\n\tbool rc;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NPA, 0);\n\tif (blkaddr < 0)\n\t\treturn blkaddr;\n\n\t \n\tbase = rvu_read64(rvu, blkaddr, NPA_PRIV_AF_INT_CFG) & 0x3ff;\n\tif (!base) {\n\t\tdev_warn(rvu->dev,\n\t\t\t \"Failed to get NPA_AF_INT vector offsets\\n\");\n\t\treturn 0;\n\t}\n\n\t \n\trc = rvu_common_request_irq(rvu, base +  NPA_AF_INT_VEC_RVU,\n\t\t\t\t    \"NPA_AF_RVU_INT\",\n\t\t\t\t    rvu_npa_af_rvu_intr_handler);\n\tif (!rc)\n\t\tgoto err;\n\trvu_write64(rvu, blkaddr, NPA_AF_RVU_INT_ENA_W1S, ~0ULL);\n\n\t \n\trc = rvu_common_request_irq(rvu, base + NPA_AF_INT_VEC_GEN,\n\t\t\t\t    \"NPA_AF_RVU_GEN\",\n\t\t\t\t    rvu_npa_af_gen_intr_handler);\n\tif (!rc)\n\t\tgoto err;\n\trvu_write64(rvu, blkaddr, NPA_AF_GEN_INT_ENA_W1S, ~0ULL);\n\n\t \n\trc = rvu_common_request_irq(rvu, base + NPA_AF_INT_VEC_AF_ERR,\n\t\t\t\t    \"NPA_AF_ERR_INT\",\n\t\t\t\t    rvu_npa_af_err_intr_handler);\n\tif (!rc)\n\t\tgoto err;\n\trvu_write64(rvu, blkaddr, NPA_AF_ERR_INT_ENA_W1S, ~0ULL);\n\n\t \n\trc = rvu_common_request_irq(rvu, base + NPA_AF_INT_VEC_POISON,\n\t\t\t\t    \"NPA_AF_RAS\",\n\t\t\t\t    rvu_npa_af_ras_intr_handler);\n\tif (!rc)\n\t\tgoto err;\n\trvu_write64(rvu, blkaddr, NPA_AF_RAS_ENA_W1S, ~0ULL);\n\n\treturn 0;\nerr:\n\trvu_npa_unregister_interrupts(rvu);\n\treturn rc;\n}\n\nstatic int rvu_npa_report_show(struct devlink_fmsg *fmsg, void *ctx,\n\t\t\t       enum npa_af_rvu_health health_reporter)\n{\n\tstruct rvu_npa_event_ctx *npa_event_context;\n\tunsigned int alloc_dis, free_dis;\n\tu64 intr_val;\n\tint err;\n\n\tnpa_event_context = ctx;\n\tswitch (health_reporter) {\n\tcase NPA_AF_RVU_GEN:\n\t\tintr_val = npa_event_context->npa_af_rvu_gen;\n\t\terr = rvu_report_pair_start(fmsg, \"NPA_AF_GENERAL\");\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_u64_pair_put(fmsg, \"\\tNPA General Interrupt Reg \",\n\t\t\t\t\t\tnpa_event_context->npa_af_rvu_gen);\n\t\tif (err)\n\t\t\treturn err;\n\t\tif (intr_val & BIT_ULL(32)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tUnmap PF Error\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\n\t\tfree_dis = FIELD_GET(GENMASK(15, 0), intr_val);\n\t\tif (free_dis & BIT(NPA_INPQ_NIX0_RX)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX0: free disabled RX\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (free_dis & BIT(NPA_INPQ_NIX0_TX)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX0:free disabled TX\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (free_dis & BIT(NPA_INPQ_NIX1_RX)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX1: free disabled RX\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (free_dis & BIT(NPA_INPQ_NIX1_TX)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX1:free disabled TX\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (free_dis & BIT(NPA_INPQ_SSO)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFree Disabled for SSO\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (free_dis & BIT(NPA_INPQ_TIM)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFree Disabled for TIM\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (free_dis & BIT(NPA_INPQ_DPI)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFree Disabled for DPI\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (free_dis & BIT(NPA_INPQ_AURA_OP)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFree Disabled for AURA\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\n\t\talloc_dis = FIELD_GET(GENMASK(31, 16), intr_val);\n\t\tif (alloc_dis & BIT(NPA_INPQ_NIX0_RX)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX0: alloc disabled RX\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (alloc_dis & BIT(NPA_INPQ_NIX0_TX)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX0:alloc disabled TX\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (alloc_dis & BIT(NPA_INPQ_NIX1_RX)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX1: alloc disabled RX\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (alloc_dis & BIT(NPA_INPQ_NIX1_TX)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tNIX1:alloc disabled TX\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (alloc_dis & BIT(NPA_INPQ_SSO)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tAlloc Disabled for SSO\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (alloc_dis & BIT(NPA_INPQ_TIM)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tAlloc Disabled for TIM\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (alloc_dis & BIT(NPA_INPQ_DPI)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tAlloc Disabled for DPI\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (alloc_dis & BIT(NPA_INPQ_AURA_OP)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tAlloc Disabled for AURA\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\terr = rvu_report_pair_end(fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t\tbreak;\n\tcase NPA_AF_RVU_ERR:\n\t\terr = rvu_report_pair_start(fmsg, \"NPA_AF_ERR\");\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_u64_pair_put(fmsg, \"\\tNPA Error Interrupt Reg \",\n\t\t\t\t\t\tnpa_event_context->npa_af_rvu_err);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\tif (npa_event_context->npa_af_rvu_err & BIT_ULL(14)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFault on NPA_AQ_INST_S read\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (npa_event_context->npa_af_rvu_err & BIT_ULL(13)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tFault on NPA_AQ_RES_S write\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (npa_event_context->npa_af_rvu_err & BIT_ULL(12)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tAQ Doorbell Error\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\terr = rvu_report_pair_end(fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t\tbreak;\n\tcase NPA_AF_RVU_RAS:\n\t\terr = rvu_report_pair_start(fmsg, \"NPA_AF_RVU_RAS\");\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_u64_pair_put(fmsg, \"\\tNPA RAS Interrupt Reg \",\n\t\t\t\t\t\tnpa_event_context->npa_af_rvu_ras);\n\t\tif (err)\n\t\t\treturn err;\n\t\tif (npa_event_context->npa_af_rvu_ras & BIT_ULL(34)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tPoison data on NPA_AQ_INST_S\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (npa_event_context->npa_af_rvu_ras & BIT_ULL(33)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tPoison data on NPA_AQ_RES_S\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\tif (npa_event_context->npa_af_rvu_ras & BIT_ULL(32)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tPoison data on HW context\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\terr = rvu_report_pair_end(fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t\tbreak;\n\tcase NPA_AF_RVU_INTR:\n\t\terr = rvu_report_pair_start(fmsg, \"NPA_AF_RVU\");\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_u64_pair_put(fmsg, \"\\tNPA RVU Interrupt Reg \",\n\t\t\t\t\t\tnpa_event_context->npa_af_rvu_int);\n\t\tif (err)\n\t\t\treturn err;\n\t\tif (npa_event_context->npa_af_rvu_int & BIT_ULL(0)) {\n\t\t\terr = devlink_fmsg_string_put(fmsg, \"\\n\\tUnmap Slot Error\");\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t\treturn rvu_report_pair_end(fmsg);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int rvu_hw_npa_intr_dump(struct devlink_health_reporter *reporter,\n\t\t\t\tstruct devlink_fmsg *fmsg, void *ctx,\n\t\t\t\tstruct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tstruct rvu_npa_event_ctx *npa_ctx;\n\n\tnpa_ctx = rvu_dl->rvu_npa_health_reporter->npa_event_ctx;\n\n\treturn ctx ? rvu_npa_report_show(fmsg, ctx, NPA_AF_RVU_INTR) :\n\t\t     rvu_npa_report_show(fmsg, npa_ctx, NPA_AF_RVU_INTR);\n}\n\nstatic int rvu_hw_npa_intr_recover(struct devlink_health_reporter *reporter,\n\t\t\t\t   void *ctx, struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_npa_event_ctx *npa_event_ctx = ctx;\n\tint blkaddr;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NPA, 0);\n\tif (blkaddr < 0)\n\t\treturn blkaddr;\n\n\tif (npa_event_ctx->npa_af_rvu_int)\n\t\trvu_write64(rvu, blkaddr, NPA_AF_RVU_INT_ENA_W1S, ~0ULL);\n\n\treturn 0;\n}\n\nstatic int rvu_hw_npa_gen_dump(struct devlink_health_reporter *reporter,\n\t\t\t       struct devlink_fmsg *fmsg, void *ctx,\n\t\t\t       struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tstruct rvu_npa_event_ctx *npa_ctx;\n\n\tnpa_ctx = rvu_dl->rvu_npa_health_reporter->npa_event_ctx;\n\n\treturn ctx ? rvu_npa_report_show(fmsg, ctx, NPA_AF_RVU_GEN) :\n\t\t     rvu_npa_report_show(fmsg, npa_ctx, NPA_AF_RVU_GEN);\n}\n\nstatic int rvu_hw_npa_gen_recover(struct devlink_health_reporter *reporter,\n\t\t\t\t  void *ctx, struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_npa_event_ctx *npa_event_ctx = ctx;\n\tint blkaddr;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NPA, 0);\n\tif (blkaddr < 0)\n\t\treturn blkaddr;\n\n\tif (npa_event_ctx->npa_af_rvu_gen)\n\t\trvu_write64(rvu, blkaddr, NPA_AF_GEN_INT_ENA_W1S, ~0ULL);\n\n\treturn 0;\n}\n\nstatic int rvu_hw_npa_err_dump(struct devlink_health_reporter *reporter,\n\t\t\t       struct devlink_fmsg *fmsg, void *ctx,\n\t\t\t       struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tstruct rvu_npa_event_ctx *npa_ctx;\n\n\tnpa_ctx = rvu_dl->rvu_npa_health_reporter->npa_event_ctx;\n\n\treturn ctx ? rvu_npa_report_show(fmsg, ctx, NPA_AF_RVU_ERR) :\n\t\t     rvu_npa_report_show(fmsg, npa_ctx, NPA_AF_RVU_ERR);\n}\n\nstatic int rvu_hw_npa_err_recover(struct devlink_health_reporter *reporter,\n\t\t\t\t  void *ctx, struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_npa_event_ctx *npa_event_ctx = ctx;\n\tint blkaddr;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NPA, 0);\n\tif (blkaddr < 0)\n\t\treturn blkaddr;\n\n\tif (npa_event_ctx->npa_af_rvu_err)\n\t\trvu_write64(rvu, blkaddr, NPA_AF_ERR_INT_ENA_W1S, ~0ULL);\n\n\treturn 0;\n}\n\nstatic int rvu_hw_npa_ras_dump(struct devlink_health_reporter *reporter,\n\t\t\t       struct devlink_fmsg *fmsg, void *ctx,\n\t\t\t       struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tstruct rvu_npa_event_ctx *npa_ctx;\n\n\tnpa_ctx = rvu_dl->rvu_npa_health_reporter->npa_event_ctx;\n\n\treturn ctx ? rvu_npa_report_show(fmsg, ctx, NPA_AF_RVU_RAS) :\n\t\t     rvu_npa_report_show(fmsg, npa_ctx, NPA_AF_RVU_RAS);\n}\n\nstatic int rvu_hw_npa_ras_recover(struct devlink_health_reporter *reporter,\n\t\t\t\t  void *ctx, struct netlink_ext_ack *netlink_extack)\n{\n\tstruct rvu *rvu = devlink_health_reporter_priv(reporter);\n\tstruct rvu_npa_event_ctx *npa_event_ctx = ctx;\n\tint blkaddr;\n\n\tblkaddr = rvu_get_blkaddr(rvu, BLKTYPE_NPA, 0);\n\tif (blkaddr < 0)\n\t\treturn blkaddr;\n\n\tif (npa_event_ctx->npa_af_rvu_ras)\n\t\trvu_write64(rvu, blkaddr, NPA_AF_RAS_ENA_W1S, ~0ULL);\n\n\treturn 0;\n}\n\nRVU_REPORTERS(hw_npa_intr);\nRVU_REPORTERS(hw_npa_gen);\nRVU_REPORTERS(hw_npa_err);\nRVU_REPORTERS(hw_npa_ras);\n\nstatic void rvu_npa_health_reporters_destroy(struct rvu_devlink *rvu_dl);\n\nstatic int rvu_npa_register_reporters(struct rvu_devlink *rvu_dl)\n{\n\tstruct rvu_npa_health_reporters *rvu_reporters;\n\tstruct rvu_npa_event_ctx *npa_event_context;\n\tstruct rvu *rvu = rvu_dl->rvu;\n\n\trvu_reporters = kzalloc(sizeof(*rvu_reporters), GFP_KERNEL);\n\tif (!rvu_reporters)\n\t\treturn -ENOMEM;\n\n\trvu_dl->rvu_npa_health_reporter = rvu_reporters;\n\tnpa_event_context = kzalloc(sizeof(*npa_event_context), GFP_KERNEL);\n\tif (!npa_event_context)\n\t\treturn -ENOMEM;\n\n\trvu_reporters->npa_event_ctx = npa_event_context;\n\trvu_reporters->rvu_hw_npa_intr_reporter =\n\t\tdevlink_health_reporter_create(rvu_dl->dl, &rvu_hw_npa_intr_reporter_ops, 0, rvu);\n\tif (IS_ERR(rvu_reporters->rvu_hw_npa_intr_reporter)) {\n\t\tdev_warn(rvu->dev, \"Failed to create hw_npa_intr reporter, err=%ld\\n\",\n\t\t\t PTR_ERR(rvu_reporters->rvu_hw_npa_intr_reporter));\n\t\treturn PTR_ERR(rvu_reporters->rvu_hw_npa_intr_reporter);\n\t}\n\n\trvu_reporters->rvu_hw_npa_gen_reporter =\n\t\tdevlink_health_reporter_create(rvu_dl->dl, &rvu_hw_npa_gen_reporter_ops, 0, rvu);\n\tif (IS_ERR(rvu_reporters->rvu_hw_npa_gen_reporter)) {\n\t\tdev_warn(rvu->dev, \"Failed to create hw_npa_gen reporter, err=%ld\\n\",\n\t\t\t PTR_ERR(rvu_reporters->rvu_hw_npa_gen_reporter));\n\t\treturn PTR_ERR(rvu_reporters->rvu_hw_npa_gen_reporter);\n\t}\n\n\trvu_reporters->rvu_hw_npa_err_reporter =\n\t\tdevlink_health_reporter_create(rvu_dl->dl, &rvu_hw_npa_err_reporter_ops, 0, rvu);\n\tif (IS_ERR(rvu_reporters->rvu_hw_npa_err_reporter)) {\n\t\tdev_warn(rvu->dev, \"Failed to create hw_npa_err reporter, err=%ld\\n\",\n\t\t\t PTR_ERR(rvu_reporters->rvu_hw_npa_err_reporter));\n\t\treturn PTR_ERR(rvu_reporters->rvu_hw_npa_err_reporter);\n\t}\n\n\trvu_reporters->rvu_hw_npa_ras_reporter =\n\t\tdevlink_health_reporter_create(rvu_dl->dl, &rvu_hw_npa_ras_reporter_ops, 0, rvu);\n\tif (IS_ERR(rvu_reporters->rvu_hw_npa_ras_reporter)) {\n\t\tdev_warn(rvu->dev, \"Failed to create hw_npa_ras reporter, err=%ld\\n\",\n\t\t\t PTR_ERR(rvu_reporters->rvu_hw_npa_ras_reporter));\n\t\treturn PTR_ERR(rvu_reporters->rvu_hw_npa_ras_reporter);\n\t}\n\n\trvu_dl->devlink_wq = create_workqueue(\"rvu_devlink_wq\");\n\tif (!rvu_dl->devlink_wq)\n\t\treturn -ENOMEM;\n\n\tINIT_WORK(&rvu_reporters->intr_work, rvu_npa_intr_work);\n\tINIT_WORK(&rvu_reporters->err_work, rvu_npa_err_work);\n\tINIT_WORK(&rvu_reporters->gen_work, rvu_npa_gen_work);\n\tINIT_WORK(&rvu_reporters->ras_work, rvu_npa_ras_work);\n\n\treturn 0;\n}\n\nstatic int rvu_npa_health_reporters_create(struct rvu_devlink *rvu_dl)\n{\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tint err;\n\n\terr = rvu_npa_register_reporters(rvu_dl);\n\tif (err) {\n\t\tdev_warn(rvu->dev, \"Failed to create npa reporter, err =%d\\n\",\n\t\t\t err);\n\t\treturn err;\n\t}\n\trvu_npa_register_interrupts(rvu);\n\n\treturn 0;\n}\n\nstatic void rvu_npa_health_reporters_destroy(struct rvu_devlink *rvu_dl)\n{\n\tstruct rvu_npa_health_reporters *npa_reporters;\n\tstruct rvu *rvu = rvu_dl->rvu;\n\n\tnpa_reporters = rvu_dl->rvu_npa_health_reporter;\n\n\tif (!npa_reporters->rvu_hw_npa_ras_reporter)\n\t\treturn;\n\tif (!IS_ERR_OR_NULL(npa_reporters->rvu_hw_npa_intr_reporter))\n\t\tdevlink_health_reporter_destroy(npa_reporters->rvu_hw_npa_intr_reporter);\n\n\tif (!IS_ERR_OR_NULL(npa_reporters->rvu_hw_npa_gen_reporter))\n\t\tdevlink_health_reporter_destroy(npa_reporters->rvu_hw_npa_gen_reporter);\n\n\tif (!IS_ERR_OR_NULL(npa_reporters->rvu_hw_npa_err_reporter))\n\t\tdevlink_health_reporter_destroy(npa_reporters->rvu_hw_npa_err_reporter);\n\n\tif (!IS_ERR_OR_NULL(npa_reporters->rvu_hw_npa_ras_reporter))\n\t\tdevlink_health_reporter_destroy(npa_reporters->rvu_hw_npa_ras_reporter);\n\n\trvu_npa_unregister_interrupts(rvu);\n\tkfree(rvu_dl->rvu_npa_health_reporter->npa_event_ctx);\n\tkfree(rvu_dl->rvu_npa_health_reporter);\n}\n\nstatic int rvu_health_reporters_create(struct rvu *rvu)\n{\n\tstruct rvu_devlink *rvu_dl;\n\tint err;\n\n\trvu_dl = rvu->rvu_dl;\n\terr = rvu_npa_health_reporters_create(rvu_dl);\n\tif (err)\n\t\treturn err;\n\n\treturn rvu_nix_health_reporters_create(rvu_dl);\n}\n\nstatic void rvu_health_reporters_destroy(struct rvu *rvu)\n{\n\tstruct rvu_devlink *rvu_dl;\n\n\tif (!rvu->rvu_dl)\n\t\treturn;\n\n\trvu_dl = rvu->rvu_dl;\n\trvu_npa_health_reporters_destroy(rvu_dl);\n\trvu_nix_health_reporters_destroy(rvu_dl);\n}\n\n \nstatic int rvu_af_dl_dwrr_mtu_validate(struct devlink *devlink, u32 id,\n\t\t\t\t       union devlink_param_value val,\n\t\t\t\t       struct netlink_ext_ack *extack)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tint dwrr_mtu = val.vu32;\n\tstruct nix_txsch *txsch;\n\tstruct nix_hw *nix_hw;\n\n\tif (!rvu->hw->cap.nix_common_dwrr_mtu) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Setting DWRR_MTU is not supported on this silicon\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tif ((dwrr_mtu > 65536 || !is_power_of_2(dwrr_mtu)) &&\n\t    (dwrr_mtu != 9728 && dwrr_mtu != 10240)) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Invalid, supported MTUs are 0,2,4,8.16,32,64....4K,8K,32K,64K and 9728, 10240\");\n\t\treturn -EINVAL;\n\t}\n\n\tnix_hw = get_nix_hw(rvu->hw, BLKADDR_NIX0);\n\tif (!nix_hw)\n\t\treturn -ENODEV;\n\n\ttxsch = &nix_hw->txsch[NIX_TXSCH_LVL_SMQ];\n\tif (rvu_rsrc_free_count(&txsch->schq) != txsch->schq.max) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Changing DWRR MTU is not supported when there are active NIXLFs\");\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Make sure none of the PF/VF interfaces are initialized and retry\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\treturn 0;\n}\n\nstatic int rvu_af_dl_dwrr_mtu_set(struct devlink *devlink, u32 id,\n\t\t\t\t  struct devlink_param_gset_ctx *ctx)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tu64 dwrr_mtu;\n\n\tdwrr_mtu = convert_bytes_to_dwrr_mtu(ctx->val.vu32);\n\trvu_write64(rvu, BLKADDR_NIX0,\n\t\t    nix_get_dwrr_mtu_reg(rvu->hw, SMQ_LINK_TYPE_RPM), dwrr_mtu);\n\n\treturn 0;\n}\n\nstatic int rvu_af_dl_dwrr_mtu_get(struct devlink *devlink, u32 id,\n\t\t\t\t  struct devlink_param_gset_ctx *ctx)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tu64 dwrr_mtu;\n\n\tif (!rvu->hw->cap.nix_common_dwrr_mtu)\n\t\treturn -EOPNOTSUPP;\n\n\tdwrr_mtu = rvu_read64(rvu, BLKADDR_NIX0,\n\t\t\t      nix_get_dwrr_mtu_reg(rvu->hw, SMQ_LINK_TYPE_RPM));\n\tctx->val.vu32 = convert_dwrr_mtu_to_bytes(dwrr_mtu);\n\n\treturn 0;\n}\n\nenum rvu_af_dl_param_id {\n\tRVU_AF_DEVLINK_PARAM_ID_BASE = DEVLINK_PARAM_GENERIC_ID_MAX,\n\tRVU_AF_DEVLINK_PARAM_ID_DWRR_MTU,\n\tRVU_AF_DEVLINK_PARAM_ID_NPC_EXACT_FEATURE_DISABLE,\n\tRVU_AF_DEVLINK_PARAM_ID_NPC_MCAM_ZONE_PERCENT,\n};\n\nstatic int rvu_af_npc_exact_feature_get(struct devlink *devlink, u32 id,\n\t\t\t\t\tstruct devlink_param_gset_ctx *ctx)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tbool enabled;\n\n\tenabled = rvu_npc_exact_has_match_table(rvu);\n\n\tsnprintf(ctx->val.vstr, sizeof(ctx->val.vstr), \"%s\",\n\t\t enabled ? \"enabled\" : \"disabled\");\n\n\treturn 0;\n}\n\nstatic int rvu_af_npc_exact_feature_disable(struct devlink *devlink, u32 id,\n\t\t\t\t\t    struct devlink_param_gset_ctx *ctx)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\n\trvu_npc_exact_disable_feature(rvu);\n\n\treturn 0;\n}\n\nstatic int rvu_af_npc_exact_feature_validate(struct devlink *devlink, u32 id,\n\t\t\t\t\t     union devlink_param_value val,\n\t\t\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tu64 enable;\n\n\tif (kstrtoull(val.vstr, 10, &enable)) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Only 1 value is supported\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (enable != 1) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"Only disabling exact match feature is supported\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (rvu_npc_exact_can_disable_feature(rvu))\n\t\treturn 0;\n\n\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t   \"Can't disable exact match feature; Please try before any configuration\");\n\treturn -EFAULT;\n}\n\nstatic int rvu_af_dl_npc_mcam_high_zone_percent_get(struct devlink *devlink, u32 id,\n\t\t\t\t\t\t    struct devlink_param_gset_ctx *ctx)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tstruct npc_mcam *mcam;\n\tu32 percent;\n\n\tmcam = &rvu->hw->mcam;\n\tpercent = (mcam->hprio_count * 100) / mcam->bmap_entries;\n\tctx->val.vu8 = (u8)percent;\n\n\treturn 0;\n}\n\nstatic int rvu_af_dl_npc_mcam_high_zone_percent_set(struct devlink *devlink, u32 id,\n\t\t\t\t\t\t    struct devlink_param_gset_ctx *ctx)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tstruct npc_mcam *mcam;\n\tu32 percent;\n\n\tpercent = ctx->val.vu8;\n\tmcam = &rvu->hw->mcam;\n\tmcam->hprio_count = (mcam->bmap_entries * percent) / 100;\n\tmcam->hprio_end = mcam->hprio_count;\n\tmcam->lprio_count = (mcam->bmap_entries - mcam->hprio_count) / 2;\n\tmcam->lprio_start = mcam->bmap_entries - mcam->lprio_count;\n\n\treturn 0;\n}\n\nstatic int rvu_af_dl_npc_mcam_high_zone_percent_validate(struct devlink *devlink, u32 id,\n\t\t\t\t\t\t\t union devlink_param_value val,\n\t\t\t\t\t\t\t struct netlink_ext_ack *extack)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tstruct npc_mcam *mcam;\n\n\t \n\tif (val.vu8 < 12 || val.vu8 > 100) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"mcam high zone percent must be between 12% to 100%\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tmcam = &rvu->hw->mcam;\n\tif (mcam->bmap_fcnt < mcam->bmap_entries) {\n\t\tNL_SET_ERR_MSG_MOD(extack,\n\t\t\t\t   \"mcam entries have already been assigned, can't resize\");\n\t\treturn -EPERM;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct devlink_param rvu_af_dl_params[] = {\n\tDEVLINK_PARAM_DRIVER(RVU_AF_DEVLINK_PARAM_ID_DWRR_MTU,\n\t\t\t     \"dwrr_mtu\", DEVLINK_PARAM_TYPE_U32,\n\t\t\t     BIT(DEVLINK_PARAM_CMODE_RUNTIME),\n\t\t\t     rvu_af_dl_dwrr_mtu_get, rvu_af_dl_dwrr_mtu_set,\n\t\t\t     rvu_af_dl_dwrr_mtu_validate),\n};\n\nstatic const struct devlink_param rvu_af_dl_param_exact_match[] = {\n\tDEVLINK_PARAM_DRIVER(RVU_AF_DEVLINK_PARAM_ID_NPC_EXACT_FEATURE_DISABLE,\n\t\t\t     \"npc_exact_feature_disable\", DEVLINK_PARAM_TYPE_STRING,\n\t\t\t     BIT(DEVLINK_PARAM_CMODE_RUNTIME),\n\t\t\t     rvu_af_npc_exact_feature_get,\n\t\t\t     rvu_af_npc_exact_feature_disable,\n\t\t\t     rvu_af_npc_exact_feature_validate),\n\tDEVLINK_PARAM_DRIVER(RVU_AF_DEVLINK_PARAM_ID_NPC_MCAM_ZONE_PERCENT,\n\t\t\t     \"npc_mcam_high_zone_percent\", DEVLINK_PARAM_TYPE_U8,\n\t\t\t     BIT(DEVLINK_PARAM_CMODE_RUNTIME),\n\t\t\t     rvu_af_dl_npc_mcam_high_zone_percent_get,\n\t\t\t     rvu_af_dl_npc_mcam_high_zone_percent_set,\n\t\t\t     rvu_af_dl_npc_mcam_high_zone_percent_validate),\n};\n\n \nstatic int rvu_devlink_eswitch_mode_get(struct devlink *devlink, u16 *mode)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tstruct rvu_switch *rswitch;\n\n\trswitch = &rvu->rswitch;\n\t*mode = rswitch->mode;\n\n\treturn 0;\n}\n\nstatic int rvu_devlink_eswitch_mode_set(struct devlink *devlink, u16 mode,\n\t\t\t\t\tstruct netlink_ext_ack *extack)\n{\n\tstruct rvu_devlink *rvu_dl = devlink_priv(devlink);\n\tstruct rvu *rvu = rvu_dl->rvu;\n\tstruct rvu_switch *rswitch;\n\n\trswitch = &rvu->rswitch;\n\tswitch (mode) {\n\tcase DEVLINK_ESWITCH_MODE_LEGACY:\n\tcase DEVLINK_ESWITCH_MODE_SWITCHDEV:\n\t\tif (rswitch->mode == mode)\n\t\t\treturn 0;\n\t\trswitch->mode = mode;\n\t\tif (mode == DEVLINK_ESWITCH_MODE_SWITCHDEV)\n\t\t\trvu_switch_enable(rvu);\n\t\telse\n\t\t\trvu_switch_disable(rvu);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct devlink_ops rvu_devlink_ops = {\n\t.eswitch_mode_get = rvu_devlink_eswitch_mode_get,\n\t.eswitch_mode_set = rvu_devlink_eswitch_mode_set,\n};\n\nint rvu_register_dl(struct rvu *rvu)\n{\n\tstruct rvu_devlink *rvu_dl;\n\tstruct devlink *dl;\n\tint err;\n\n\tdl = devlink_alloc(&rvu_devlink_ops, sizeof(struct rvu_devlink),\n\t\t\t   rvu->dev);\n\tif (!dl) {\n\t\tdev_warn(rvu->dev, \"devlink_alloc failed\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\trvu_dl = devlink_priv(dl);\n\trvu_dl->dl = dl;\n\trvu_dl->rvu = rvu;\n\trvu->rvu_dl = rvu_dl;\n\n\terr = rvu_health_reporters_create(rvu);\n\tif (err) {\n\t\tdev_err(rvu->dev,\n\t\t\t\"devlink health reporter creation failed with error %d\\n\", err);\n\t\tgoto err_dl_health;\n\t}\n\n\terr = devlink_params_register(dl, rvu_af_dl_params, ARRAY_SIZE(rvu_af_dl_params));\n\tif (err) {\n\t\tdev_err(rvu->dev,\n\t\t\t\"devlink params register failed with error %d\", err);\n\t\tgoto err_dl_health;\n\t}\n\n\t \n\tif (!rvu_npc_exact_has_match_table(rvu))\n\t\tgoto done;\n\n\terr = devlink_params_register(dl, rvu_af_dl_param_exact_match,\n\t\t\t\t      ARRAY_SIZE(rvu_af_dl_param_exact_match));\n\tif (err) {\n\t\tdev_err(rvu->dev,\n\t\t\t\"devlink exact match params register failed with error %d\", err);\n\t\tgoto err_dl_exact_match;\n\t}\n\ndone:\n\tdevlink_register(dl);\n\treturn 0;\n\nerr_dl_exact_match:\n\tdevlink_params_unregister(dl, rvu_af_dl_params, ARRAY_SIZE(rvu_af_dl_params));\n\nerr_dl_health:\n\trvu_health_reporters_destroy(rvu);\n\tdevlink_free(dl);\n\treturn err;\n}\n\nvoid rvu_unregister_dl(struct rvu *rvu)\n{\n\tstruct rvu_devlink *rvu_dl = rvu->rvu_dl;\n\tstruct devlink *dl = rvu_dl->dl;\n\n\tdevlink_unregister(dl);\n\n\tdevlink_params_unregister(dl, rvu_af_dl_params, ARRAY_SIZE(rvu_af_dl_params));\n\n\t \n\tif (rvu_npc_exact_has_match_table(rvu))\n\t\tdevlink_params_unregister(dl, rvu_af_dl_param_exact_match,\n\t\t\t\t\t  ARRAY_SIZE(rvu_af_dl_param_exact_match));\n\n\trvu_health_reporters_destroy(rvu);\n\tdevlink_free(dl);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}