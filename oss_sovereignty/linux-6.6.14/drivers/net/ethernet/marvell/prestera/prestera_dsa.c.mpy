{
  "module_name": "prestera_dsa.c",
  "hash_id": "41b43e065e1ec26606fefbff0349a74498382ff758d90c809d2491a9d5a43855",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/marvell/prestera/prestera_dsa.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/bitops.h>\n#include <linux/errno.h>\n#include <linux/string.h>\n\n#include \"prestera_dsa.h\"\n\n#define PRESTERA_DSA_W0_CMD\t\tGENMASK(31, 30)\n#define PRESTERA_DSA_W0_IS_TAGGED\tBIT(29)\n#define PRESTERA_DSA_W0_DEV_NUM\t\tGENMASK(28, 24)\n#define PRESTERA_DSA_W0_PORT_NUM\tGENMASK(23, 19)\n#define PRESTERA_DSA_W0_VPT\t\tGENMASK(15, 13)\n#define PRESTERA_DSA_W0_EXT_BIT\t\tBIT(12)\n#define PRESTERA_DSA_W0_VID\t\tGENMASK(11, 0)\n\n#define PRESTERA_DSA_W1_EXT_BIT\t\tBIT(31)\n#define PRESTERA_DSA_W1_CFI_BIT\t\tBIT(30)\n#define PRESTERA_DSA_W1_PORT_NUM\tGENMASK(11, 10)\n#define PRESTERA_DSA_W1_MASK_CPU_CODE\tGENMASK(7, 0)\n\n#define PRESTERA_DSA_W2_EXT_BIT\t\tBIT(31)\n#define PRESTERA_DSA_W2_PORT_NUM\tBIT(20)\n\n#define PRESTERA_DSA_W3_VID\t\tGENMASK(30, 27)\n#define PRESTERA_DSA_W3_DST_EPORT\tGENMASK(23, 7)\n#define PRESTERA_DSA_W3_DEV_NUM\t\tGENMASK(6, 0)\n\n#define PRESTERA_DSA_VID\t\tGENMASK(15, 12)\n#define PRESTERA_DSA_DEV_NUM\t\tGENMASK(11, 5)\n\nint prestera_dsa_parse(struct prestera_dsa *dsa, const u8 *dsa_buf)\n{\n\t__be32 *dsa_words = (__be32 *)dsa_buf;\n\tenum prestera_dsa_cmd cmd;\n\tu32 words[4];\n\tu32 field;\n\n\twords[0] = ntohl(dsa_words[0]);\n\twords[1] = ntohl(dsa_words[1]);\n\twords[2] = ntohl(dsa_words[2]);\n\twords[3] = ntohl(dsa_words[3]);\n\n\t \n\tcmd = (enum prestera_dsa_cmd)FIELD_GET(PRESTERA_DSA_W0_CMD, words[0]);\n\n\t \n\tif (unlikely(cmd != PRESTERA_DSA_CMD_TO_CPU))\n\t\treturn -EINVAL;\n\n\tif (FIELD_GET(PRESTERA_DSA_W0_EXT_BIT, words[0]) == 0)\n\t\treturn -EINVAL;\n\tif (FIELD_GET(PRESTERA_DSA_W1_EXT_BIT, words[1]) == 0)\n\t\treturn -EINVAL;\n\tif (FIELD_GET(PRESTERA_DSA_W2_EXT_BIT, words[2]) == 0)\n\t\treturn -EINVAL;\n\n\tfield = FIELD_GET(PRESTERA_DSA_W3_VID, words[3]);\n\n\tdsa->vlan.is_tagged = FIELD_GET(PRESTERA_DSA_W0_IS_TAGGED, words[0]);\n\tdsa->vlan.cfi_bit = FIELD_GET(PRESTERA_DSA_W1_CFI_BIT, words[1]);\n\tdsa->vlan.vpt = FIELD_GET(PRESTERA_DSA_W0_VPT, words[0]);\n\tdsa->vlan.vid = FIELD_GET(PRESTERA_DSA_W0_VID, words[0]);\n\tdsa->vlan.vid &= ~PRESTERA_DSA_VID;\n\tdsa->vlan.vid |= FIELD_PREP(PRESTERA_DSA_VID, field);\n\n\tfield = FIELD_GET(PRESTERA_DSA_W3_DEV_NUM, words[3]);\n\n\tdsa->hw_dev_num = FIELD_GET(PRESTERA_DSA_W0_DEV_NUM, words[0]);\n\tdsa->hw_dev_num |= FIELD_PREP(PRESTERA_DSA_DEV_NUM, field);\n\n\tdsa->port_num = (FIELD_GET(PRESTERA_DSA_W0_PORT_NUM, words[0]) << 0) |\n\t\t\t(FIELD_GET(PRESTERA_DSA_W1_PORT_NUM, words[1]) << 5) |\n\t\t\t(FIELD_GET(PRESTERA_DSA_W2_PORT_NUM, words[2]) << 7);\n\n\tdsa->cpu_code = FIELD_GET(PRESTERA_DSA_W1_MASK_CPU_CODE, words[1]);\n\n\treturn 0;\n}\n\nint prestera_dsa_build(const struct prestera_dsa *dsa, u8 *dsa_buf)\n{\n\t__be32 *dsa_words = (__be32 *)dsa_buf;\n\tu32 dev_num = dsa->hw_dev_num;\n\tu32 words[4] = { 0 };\n\n\twords[0] |= FIELD_PREP(PRESTERA_DSA_W0_CMD, PRESTERA_DSA_CMD_FROM_CPU);\n\n\twords[0] |= FIELD_PREP(PRESTERA_DSA_W0_DEV_NUM, dev_num);\n\tdev_num = FIELD_GET(PRESTERA_DSA_DEV_NUM, dev_num);\n\twords[3] |= FIELD_PREP(PRESTERA_DSA_W3_DEV_NUM, dev_num);\n\n\twords[3] |= FIELD_PREP(PRESTERA_DSA_W3_DST_EPORT, dsa->port_num);\n\n\twords[0] |= FIELD_PREP(PRESTERA_DSA_W0_EXT_BIT, 1);\n\twords[1] |= FIELD_PREP(PRESTERA_DSA_W1_EXT_BIT, 1);\n\twords[2] |= FIELD_PREP(PRESTERA_DSA_W2_EXT_BIT, 1);\n\n\tdsa_words[0] = htonl(words[0]);\n\tdsa_words[1] = htonl(words[1]);\n\tdsa_words[2] = htonl(words[2]);\n\tdsa_words[3] = htonl(words[3]);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}