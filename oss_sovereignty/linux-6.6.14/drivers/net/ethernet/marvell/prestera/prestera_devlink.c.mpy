{
  "module_name": "prestera_devlink.c",
  "hash_id": "b08b60e41fb235b3180f2ebc73ebf2fdae552045d5120acd4253d7f08072605b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/marvell/prestera/prestera_devlink.c",
  "human_readable_source": "\n \n\n#include <net/devlink.h>\n\n#include \"prestera_devlink.h\"\n#include \"prestera_hw.h\"\n\n \nenum {\n\tDEVLINK_PRESTERA_TRAP_ID_BASE = DEVLINK_TRAP_GENERIC_ID_MAX,\n\tDEVLINK_PRESTERA_TRAP_ID_ARP_BC,\n\tDEVLINK_PRESTERA_TRAP_ID_IS_IS,\n\tDEVLINK_PRESTERA_TRAP_ID_OSPF,\n\tDEVLINK_PRESTERA_TRAP_ID_IP_BC_MAC,\n\tDEVLINK_PRESTERA_TRAP_ID_ROUTER_MC,\n\tDEVLINK_PRESTERA_TRAP_ID_VRRP,\n\tDEVLINK_PRESTERA_TRAP_ID_DHCP,\n\tDEVLINK_PRESTERA_TRAP_ID_MAC_TO_ME,\n\tDEVLINK_PRESTERA_TRAP_ID_IPV4_OPTIONS,\n\tDEVLINK_PRESTERA_TRAP_ID_IP_DEFAULT_ROUTE,\n\tDEVLINK_PRESTERA_TRAP_ID_IP_TO_ME,\n\tDEVLINK_PRESTERA_TRAP_ID_IPV4_ICMP_REDIRECT,\n\tDEVLINK_PRESTERA_TRAP_ID_ACL_CODE_0,\n\tDEVLINK_PRESTERA_TRAP_ID_ACL_CODE_1,\n\tDEVLINK_PRESTERA_TRAP_ID_ACL_CODE_2,\n\tDEVLINK_PRESTERA_TRAP_ID_ACL_CODE_3,\n\tDEVLINK_PRESTERA_TRAP_ID_ACL_CODE_4,\n\tDEVLINK_PRESTERA_TRAP_ID_ACL_CODE_5,\n\tDEVLINK_PRESTERA_TRAP_ID_ACL_CODE_6,\n\tDEVLINK_PRESTERA_TRAP_ID_ACL_CODE_7,\n\tDEVLINK_PRESTERA_TRAP_ID_BGP,\n\tDEVLINK_PRESTERA_TRAP_ID_SSH,\n\tDEVLINK_PRESTERA_TRAP_ID_TELNET,\n\tDEVLINK_PRESTERA_TRAP_ID_ICMP,\n\tDEVLINK_PRESTERA_TRAP_ID_MET_RED,\n\tDEVLINK_PRESTERA_TRAP_ID_IP_SIP_IS_ZERO,\n\tDEVLINK_PRESTERA_TRAP_ID_IP_UC_DIP_DA_MISMATCH,\n\tDEVLINK_PRESTERA_TRAP_ID_ILLEGAL_IPV4_HDR,\n\tDEVLINK_PRESTERA_TRAP_ID_ILLEGAL_IP_ADDR,\n\tDEVLINK_PRESTERA_TRAP_ID_INVALID_SA,\n\tDEVLINK_PRESTERA_TRAP_ID_LOCAL_PORT,\n\tDEVLINK_PRESTERA_TRAP_ID_PORT_NO_VLAN,\n\tDEVLINK_PRESTERA_TRAP_ID_RXDMA_DROP,\n};\n\n#define DEVLINK_PRESTERA_TRAP_NAME_ARP_BC \\\n\t\"arp_bc\"\n#define DEVLINK_PRESTERA_TRAP_NAME_IS_IS \\\n\t\"is_is\"\n#define DEVLINK_PRESTERA_TRAP_NAME_OSPF \\\n\t\"ospf\"\n#define DEVLINK_PRESTERA_TRAP_NAME_IP_BC_MAC \\\n\t\"ip_bc_mac\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ROUTER_MC \\\n\t\"router_mc\"\n#define DEVLINK_PRESTERA_TRAP_NAME_VRRP \\\n\t\"vrrp\"\n#define DEVLINK_PRESTERA_TRAP_NAME_DHCP \\\n\t\"dhcp\"\n#define DEVLINK_PRESTERA_TRAP_NAME_MAC_TO_ME \\\n\t\"mac_to_me\"\n#define DEVLINK_PRESTERA_TRAP_NAME_IPV4_OPTIONS \\\n\t\"ipv4_options\"\n#define DEVLINK_PRESTERA_TRAP_NAME_IP_DEFAULT_ROUTE \\\n\t\"ip_default_route\"\n#define DEVLINK_PRESTERA_TRAP_NAME_IP_TO_ME \\\n\t\"ip_to_me\"\n#define DEVLINK_PRESTERA_TRAP_NAME_IPV4_ICMP_REDIRECT \\\n\t\"ipv4_icmp_redirect\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ACL_CODE_0 \\\n\t\"acl_code_0\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ACL_CODE_1 \\\n\t\"acl_code_1\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ACL_CODE_2 \\\n\t\"acl_code_2\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ACL_CODE_3 \\\n\t\"acl_code_3\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ACL_CODE_4 \\\n\t\"acl_code_4\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ACL_CODE_5 \\\n\t\"acl_code_5\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ACL_CODE_6 \\\n\t\"acl_code_6\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ACL_CODE_7 \\\n\t\"acl_code_7\"\n#define DEVLINK_PRESTERA_TRAP_NAME_BGP \\\n\t\"bgp\"\n#define DEVLINK_PRESTERA_TRAP_NAME_SSH \\\n\t\"ssh\"\n#define DEVLINK_PRESTERA_TRAP_NAME_TELNET \\\n\t\"telnet\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ICMP \\\n\t\"icmp\"\n#define DEVLINK_PRESTERA_TRAP_NAME_RXDMA_DROP \\\n\t\"rxdma_drop\"\n#define DEVLINK_PRESTERA_TRAP_NAME_PORT_NO_VLAN \\\n\t\"port_no_vlan\"\n#define DEVLINK_PRESTERA_TRAP_NAME_LOCAL_PORT \\\n\t\"local_port\"\n#define DEVLINK_PRESTERA_TRAP_NAME_INVALID_SA \\\n\t\"invalid_sa\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ILLEGAL_IP_ADDR \\\n\t\"illegal_ip_addr\"\n#define DEVLINK_PRESTERA_TRAP_NAME_ILLEGAL_IPV4_HDR \\\n\t\"illegal_ipv4_hdr\"\n#define DEVLINK_PRESTERA_TRAP_NAME_IP_UC_DIP_DA_MISMATCH \\\n\t\"ip_uc_dip_da_mismatch\"\n#define DEVLINK_PRESTERA_TRAP_NAME_IP_SIP_IS_ZERO \\\n\t\"ip_sip_is_zero\"\n#define DEVLINK_PRESTERA_TRAP_NAME_MET_RED \\\n\t\"met_red\"\n\nstruct prestera_trap {\n\tstruct devlink_trap trap;\n\tu8 cpu_code;\n};\n\nstruct prestera_trap_item {\n\tenum devlink_trap_action action;\n\tvoid *trap_ctx;\n};\n\nstruct prestera_trap_data {\n\tstruct prestera_switch *sw;\n\tstruct prestera_trap_item *trap_items_arr;\n\tu32 traps_count;\n};\n\n#define PRESTERA_TRAP_METADATA DEVLINK_TRAP_METADATA_TYPE_F_IN_PORT\n\n#define PRESTERA_TRAP_CONTROL(_id, _group_id, _action)\t\t\t      \\\n\tDEVLINK_TRAP_GENERIC(CONTROL, _action, _id,\t\t\t      \\\n\t\t\t     DEVLINK_TRAP_GROUP_GENERIC_ID_##_group_id,\t      \\\n\t\t\t     PRESTERA_TRAP_METADATA)\n\n#define PRESTERA_TRAP_DRIVER_CONTROL(_id, _group_id)\t\t\t      \\\n\tDEVLINK_TRAP_DRIVER(CONTROL, TRAP, DEVLINK_PRESTERA_TRAP_ID_##_id,    \\\n\t\t\t    DEVLINK_PRESTERA_TRAP_NAME_##_id,\t\t      \\\n\t\t\t    DEVLINK_TRAP_GROUP_GENERIC_ID_##_group_id,\t      \\\n\t\t\t    PRESTERA_TRAP_METADATA)\n\n#define PRESTERA_TRAP_EXCEPTION(_id, _group_id)\t\t\t\t      \\\n\tDEVLINK_TRAP_GENERIC(EXCEPTION, TRAP, _id,\t\t\t      \\\n\t\t\t     DEVLINK_TRAP_GROUP_GENERIC_ID_##_group_id,\t      \\\n\t\t\t     PRESTERA_TRAP_METADATA)\n\n#define PRESTERA_TRAP_DRIVER_EXCEPTION(_id, _group_id)\t\t\t      \\\n\tDEVLINK_TRAP_DRIVER(EXCEPTION, TRAP, DEVLINK_PRESTERA_TRAP_ID_##_id,  \\\n\t\t\t    DEVLINK_PRESTERA_TRAP_NAME_##_id,\t\t      \\\n\t\t\t    DEVLINK_TRAP_GROUP_GENERIC_ID_##_group_id,\t      \\\n\t\t\t    PRESTERA_TRAP_METADATA)\n\n#define PRESTERA_TRAP_DRIVER_DROP(_id, _group_id)\t\t\t      \\\n\tDEVLINK_TRAP_DRIVER(DROP, DROP, DEVLINK_PRESTERA_TRAP_ID_##_id,\t      \\\n\t\t\t    DEVLINK_PRESTERA_TRAP_NAME_##_id,\t\t      \\\n\t\t\t    DEVLINK_TRAP_GROUP_GENERIC_ID_##_group_id,\t      \\\n\t\t\t    PRESTERA_TRAP_METADATA)\n\nstatic const struct devlink_trap_group prestera_trap_groups_arr[] = {\n\t \n\tDEVLINK_TRAP_GROUP_GENERIC(L2_DROPS, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(L3_DROPS, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(L3_EXCEPTIONS, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(NEIGH_DISCOVERY, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(ACL_TRAP, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(ACL_DROPS, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(ACL_SAMPLE, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(OSPF, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(STP, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(LACP, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(LLDP, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(VRRP, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(DHCP, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(BGP, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(LOCAL_DELIVERY, 0),\n\tDEVLINK_TRAP_GROUP_GENERIC(BUFFER_DROPS, 0),\n};\n\n \nstatic struct prestera_trap prestera_trap_items_arr[] = {\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ARP_BC, NEIGH_DISCOVERY),\n\t\t.cpu_code = 5,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(IS_IS, LOCAL_DELIVERY),\n\t\t.cpu_code = 13,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(OSPF, OSPF),\n\t\t.cpu_code = 16,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(IP_BC_MAC, LOCAL_DELIVERY),\n\t\t.cpu_code = 19,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_CONTROL(STP, STP, TRAP),\n\t\t.cpu_code = 26,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_CONTROL(LACP, LACP, TRAP),\n\t\t.cpu_code = 27,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_CONTROL(LLDP, LLDP, TRAP),\n\t\t.cpu_code = 28,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ROUTER_MC, LOCAL_DELIVERY),\n\t\t.cpu_code = 29,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(VRRP, VRRP),\n\t\t.cpu_code = 30,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(DHCP, DHCP),\n\t\t.cpu_code = 33,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_EXCEPTION(MTU_ERROR, L3_EXCEPTIONS),\n\t\t.cpu_code = 63,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(MAC_TO_ME, LOCAL_DELIVERY),\n\t\t.cpu_code = 65,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_EXCEPTION(TTL_ERROR, L3_EXCEPTIONS),\n\t\t.cpu_code = 133,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_EXCEPTION(IPV4_OPTIONS,\n\t\t\t\t\t\t       L3_EXCEPTIONS),\n\t\t.cpu_code = 141,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(IP_DEFAULT_ROUTE,\n\t\t\t\t\t\t     LOCAL_DELIVERY),\n\t\t.cpu_code = 160,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_CONTROL(LOCAL_ROUTE, LOCAL_DELIVERY,\n\t\t\t\t\t      TRAP),\n\t\t.cpu_code = 161,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_EXCEPTION(IPV4_ICMP_REDIRECT,\n\t\t\t\t\t\t       L3_EXCEPTIONS),\n\t\t.cpu_code = 180,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_CONTROL(ARP_RESPONSE, NEIGH_DISCOVERY,\n\t\t\t\t\t      TRAP),\n\t\t.cpu_code = 188,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ACL_CODE_0, ACL_TRAP),\n\t\t.cpu_code = 192,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ACL_CODE_1, ACL_TRAP),\n\t\t.cpu_code = 193,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ACL_CODE_2, ACL_TRAP),\n\t\t.cpu_code = 194,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ACL_CODE_3, ACL_TRAP),\n\t\t.cpu_code = 195,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ACL_CODE_4, ACL_TRAP),\n\t\t.cpu_code = 196,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ACL_CODE_5, ACL_TRAP),\n\t\t.cpu_code = 197,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ACL_CODE_6, ACL_TRAP),\n\t\t.cpu_code = 198,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ACL_CODE_7, ACL_TRAP),\n\t\t.cpu_code = 199,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(BGP, BGP),\n\t\t.cpu_code = 206,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(SSH, LOCAL_DELIVERY),\n\t\t.cpu_code = 207,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(TELNET, LOCAL_DELIVERY),\n\t\t.cpu_code = 208,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_CONTROL(ICMP, LOCAL_DELIVERY),\n\t\t.cpu_code = 209,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_DROP(RXDMA_DROP, BUFFER_DROPS),\n\t\t.cpu_code = 37,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_DROP(PORT_NO_VLAN, L2_DROPS),\n\t\t.cpu_code = 39,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_DROP(LOCAL_PORT, L2_DROPS),\n\t\t.cpu_code = 56,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_DROP(INVALID_SA, L2_DROPS),\n\t\t.cpu_code = 60,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_DROP(ILLEGAL_IP_ADDR, L3_DROPS),\n\t\t.cpu_code = 136,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_DROP(ILLEGAL_IPV4_HDR, L3_DROPS),\n\t\t.cpu_code = 137,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_DROP(IP_UC_DIP_DA_MISMATCH,\n\t\t\t\t\t\t  L3_DROPS),\n\t\t.cpu_code = 138,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_DROP(IP_SIP_IS_ZERO, L3_DROPS),\n\t\t.cpu_code = 145,\n\t},\n\t{\n\t\t.trap = PRESTERA_TRAP_DRIVER_DROP(MET_RED, BUFFER_DROPS),\n\t\t.cpu_code = 185,\n\t},\n};\n\nstatic int prestera_drop_counter_get(struct devlink *devlink,\n\t\t\t\t     const struct devlink_trap *trap,\n\t\t\t\t     u64 *p_drops);\n\nstatic int prestera_dl_info_get(struct devlink *dl,\n\t\t\t\tstruct devlink_info_req *req,\n\t\t\t\tstruct netlink_ext_ack *extack)\n{\n\tstruct prestera_switch *sw = devlink_priv(dl);\n\tchar buf[16];\n\n\tsnprintf(buf, sizeof(buf), \"%d.%d.%d\",\n\t\t sw->dev->fw_rev.maj,\n\t\t sw->dev->fw_rev.min,\n\t\t sw->dev->fw_rev.sub);\n\n\treturn devlink_info_version_running_put(req,\n\t\t\t\t\t       DEVLINK_INFO_VERSION_GENERIC_FW,\n\t\t\t\t\t       buf);\n}\n\nstatic int prestera_trap_init(struct devlink *devlink,\n\t\t\t      const struct devlink_trap *trap, void *trap_ctx);\n\nstatic int prestera_trap_action_set(struct devlink *devlink,\n\t\t\t\t    const struct devlink_trap *trap,\n\t\t\t\t    enum devlink_trap_action action,\n\t\t\t\t    struct netlink_ext_ack *extack);\n\nstatic const struct devlink_ops prestera_dl_ops = {\n\t.info_get = prestera_dl_info_get,\n\t.trap_init = prestera_trap_init,\n\t.trap_action_set = prestera_trap_action_set,\n\t.trap_drop_counter_get = prestera_drop_counter_get,\n};\n\nstruct prestera_switch *prestera_devlink_alloc(struct prestera_device *dev)\n{\n\tstruct devlink *dl;\n\n\tdl = devlink_alloc(&prestera_dl_ops, sizeof(struct prestera_switch),\n\t\t\t   dev->dev);\n\n\treturn devlink_priv(dl);\n}\n\nvoid prestera_devlink_free(struct prestera_switch *sw)\n{\n\tstruct devlink *dl = priv_to_devlink(sw);\n\n\tdevlink_free(dl);\n}\n\nvoid prestera_devlink_register(struct prestera_switch *sw)\n{\n\tstruct devlink *dl = priv_to_devlink(sw);\n\n\tdevlink_register(dl);\n}\n\nvoid prestera_devlink_unregister(struct prestera_switch *sw)\n{\n\tstruct devlink *dl = priv_to_devlink(sw);\n\n\tdevlink_unregister(dl);\n}\n\nint prestera_devlink_port_register(struct prestera_port *port)\n{\n\tstruct prestera_switch *sw = port->sw;\n\tstruct devlink *dl = priv_to_devlink(sw);\n\tstruct devlink_port_attrs attrs = {};\n\tint err;\n\n\tattrs.flavour = DEVLINK_PORT_FLAVOUR_PHYSICAL;\n\tattrs.phys.port_number = port->fp_id;\n\tattrs.switch_id.id_len = sizeof(sw->id);\n\tmemcpy(attrs.switch_id.id, &sw->id, attrs.switch_id.id_len);\n\n\tdevlink_port_attrs_set(&port->dl_port, &attrs);\n\n\terr = devlink_port_register(dl, &port->dl_port, port->fp_id);\n\tif (err) {\n\t\tdev_err(prestera_dev(sw), \"devlink_port_register failed: %d\\n\", err);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nvoid prestera_devlink_port_unregister(struct prestera_port *port)\n{\n\tdevlink_port_unregister(&port->dl_port);\n}\n\nint prestera_devlink_traps_register(struct prestera_switch *sw)\n{\n\tconst u32 groups_count = ARRAY_SIZE(prestera_trap_groups_arr);\n\tconst u32 traps_count = ARRAY_SIZE(prestera_trap_items_arr);\n\tstruct devlink *devlink = priv_to_devlink(sw);\n\tstruct prestera_trap_data *trap_data;\n\tstruct prestera_trap *prestera_trap;\n\tint err, i;\n\n\ttrap_data = kzalloc(sizeof(*trap_data), GFP_KERNEL);\n\tif (!trap_data)\n\t\treturn -ENOMEM;\n\n\ttrap_data->trap_items_arr = kcalloc(traps_count,\n\t\t\t\t\t    sizeof(struct prestera_trap_item),\n\t\t\t\t\t    GFP_KERNEL);\n\tif (!trap_data->trap_items_arr) {\n\t\terr = -ENOMEM;\n\t\tgoto err_trap_items_alloc;\n\t}\n\n\ttrap_data->sw = sw;\n\ttrap_data->traps_count = traps_count;\n\tsw->trap_data = trap_data;\n\n\terr = devlink_trap_groups_register(devlink, prestera_trap_groups_arr,\n\t\t\t\t\t   groups_count);\n\tif (err)\n\t\tgoto err_groups_register;\n\n\tfor (i = 0; i < traps_count; i++) {\n\t\tprestera_trap = &prestera_trap_items_arr[i];\n\t\terr = devlink_traps_register(devlink, &prestera_trap->trap, 1,\n\t\t\t\t\t     sw);\n\t\tif (err)\n\t\t\tgoto err_trap_register;\n\t}\n\n\treturn 0;\n\nerr_trap_register:\n\tfor (i--; i >= 0; i--) {\n\t\tprestera_trap = &prestera_trap_items_arr[i];\n\t\tdevlink_traps_unregister(devlink, &prestera_trap->trap, 1);\n\t}\n\tdevlink_trap_groups_unregister(devlink, prestera_trap_groups_arr,\n\t\t\t\t       groups_count);\nerr_groups_register:\n\tkfree(trap_data->trap_items_arr);\nerr_trap_items_alloc:\n\tkfree(trap_data);\n\treturn err;\n}\n\nstatic struct prestera_trap_item *\nprestera_get_trap_item_by_cpu_code(struct prestera_switch *sw, u8 cpu_code)\n{\n\tstruct prestera_trap_data *trap_data = sw->trap_data;\n\tstruct prestera_trap *prestera_trap;\n\tint i;\n\n\tfor (i = 0; i < trap_data->traps_count; i++) {\n\t\tprestera_trap = &prestera_trap_items_arr[i];\n\t\tif (cpu_code == prestera_trap->cpu_code)\n\t\t\treturn &trap_data->trap_items_arr[i];\n\t}\n\n\treturn NULL;\n}\n\nvoid prestera_devlink_trap_report(struct prestera_port *port,\n\t\t\t\t  struct sk_buff *skb, u8 cpu_code)\n{\n\tstruct prestera_trap_item *trap_item;\n\tstruct devlink *devlink;\n\n\tdevlink = port->dl_port.devlink;\n\n\ttrap_item = prestera_get_trap_item_by_cpu_code(port->sw, cpu_code);\n\tif (unlikely(!trap_item))\n\t\treturn;\n\n\tdevlink_trap_report(devlink, skb, trap_item->trap_ctx,\n\t\t\t    &port->dl_port, NULL);\n}\n\nstatic struct prestera_trap_item *\nprestera_devlink_trap_item_lookup(struct prestera_switch *sw, u16 trap_id)\n{\n\tstruct prestera_trap_data *trap_data = sw->trap_data;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(prestera_trap_items_arr); i++) {\n\t\tif (prestera_trap_items_arr[i].trap.id == trap_id)\n\t\t\treturn &trap_data->trap_items_arr[i];\n\t}\n\n\treturn NULL;\n}\n\nstatic int prestera_trap_init(struct devlink *devlink,\n\t\t\t      const struct devlink_trap *trap, void *trap_ctx)\n{\n\tstruct prestera_switch *sw = devlink_priv(devlink);\n\tstruct prestera_trap_item *trap_item;\n\n\ttrap_item = prestera_devlink_trap_item_lookup(sw, trap->id);\n\tif (WARN_ON(!trap_item))\n\t\treturn -EINVAL;\n\n\ttrap_item->trap_ctx = trap_ctx;\n\ttrap_item->action = trap->init_action;\n\n\treturn 0;\n}\n\nstatic int prestera_trap_action_set(struct devlink *devlink,\n\t\t\t\t    const struct devlink_trap *trap,\n\t\t\t\t    enum devlink_trap_action action,\n\t\t\t\t    struct netlink_ext_ack *extack)\n{\n\t \n\treturn -EOPNOTSUPP;\n}\n\nstatic int prestera_drop_counter_get(struct devlink *devlink,\n\t\t\t\t     const struct devlink_trap *trap,\n\t\t\t\t     u64 *p_drops)\n{\n\tstruct prestera_switch *sw = devlink_priv(devlink);\n\tenum prestera_hw_cpu_code_cnt_t cpu_code_type =\n\t\tPRESTERA_HW_CPU_CODE_CNT_TYPE_DROP;\n\tstruct prestera_trap *prestera_trap =\n\t\tcontainer_of(trap, struct prestera_trap, trap);\n\n\treturn prestera_hw_cpu_code_counters_get(sw, prestera_trap->cpu_code,\n\t\t\t\t\t\t cpu_code_type, p_drops);\n}\n\nvoid prestera_devlink_traps_unregister(struct prestera_switch *sw)\n{\n\tstruct prestera_trap_data *trap_data = sw->trap_data;\n\tstruct devlink *dl = priv_to_devlink(sw);\n\tconst struct devlink_trap *trap;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(prestera_trap_items_arr); ++i) {\n\t\ttrap = &prestera_trap_items_arr[i].trap;\n\t\tdevlink_traps_unregister(dl, trap, 1);\n\t}\n\n\tdevlink_trap_groups_unregister(dl, prestera_trap_groups_arr,\n\t\t\t\t       ARRAY_SIZE(prestera_trap_groups_arr));\n\tkfree(trap_data->trap_items_arr);\n\tkfree(trap_data);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}