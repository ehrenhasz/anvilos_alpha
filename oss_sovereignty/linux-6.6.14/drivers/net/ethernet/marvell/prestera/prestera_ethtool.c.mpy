{
  "module_name": "prestera_ethtool.c",
  "hash_id": "9b72338ca3781dd7d027176b2936aed56b385959600d08e66aafa553d915a51e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/marvell/prestera/prestera_ethtool.c",
  "human_readable_source": "\n \n\n#include <linux/ethtool.h>\n#include <linux/kernel.h>\n#include <linux/netdevice.h>\n\n#include \"prestera_ethtool.h\"\n#include \"prestera.h\"\n#include \"prestera_hw.h\"\n\n#define PRESTERA_STATS_CNT \\\n\t(sizeof(struct prestera_port_stats) / sizeof(u64))\n#define PRESTERA_STATS_IDX(name) \\\n\t(offsetof(struct prestera_port_stats, name) / sizeof(u64))\n#define PRESTERA_STATS_FIELD(name)\t\\\n\t[PRESTERA_STATS_IDX(name)] = __stringify(name)\n\nstatic const char driver_kind[] = \"prestera\";\n\nstatic const struct prestera_link_mode {\n\tenum ethtool_link_mode_bit_indices eth_mode;\n\tu32 speed;\n\tu64 pr_mask;\n\tu8 duplex;\n\tu8 port_type;\n} port_link_modes[PRESTERA_LINK_MODE_MAX] = {\n\t[PRESTERA_LINK_MODE_10baseT_Half] = {\n\t\t.eth_mode =  ETHTOOL_LINK_MODE_10baseT_Half_BIT,\n\t\t.speed = 10,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_10baseT_Half,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_HALF,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_10baseT_Full] = {\n\t\t.eth_mode =  ETHTOOL_LINK_MODE_10baseT_Full_BIT,\n\t\t.speed = 10,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_10baseT_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_100baseT_Half] = {\n\t\t.eth_mode =  ETHTOOL_LINK_MODE_100baseT_Half_BIT,\n\t\t.speed = 100,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_100baseT_Half,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_HALF,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_100baseT_Full] = {\n\t\t.eth_mode =  ETHTOOL_LINK_MODE_100baseT_Full_BIT,\n\t\t.speed = 100,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_100baseT_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_1000baseT_Half] = {\n\t\t.eth_mode =  ETHTOOL_LINK_MODE_1000baseT_Half_BIT,\n\t\t.speed = 1000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_1000baseT_Half,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_HALF,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_1000baseT_Full] = {\n\t\t.eth_mode =  ETHTOOL_LINK_MODE_1000baseT_Full_BIT,\n\t\t.speed = 1000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_1000baseT_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_1000baseX_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_1000baseX_Full_BIT,\n\t\t.speed = 1000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_1000baseX_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_FIBRE,\n\t},\n\t[PRESTERA_LINK_MODE_1000baseKX_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_1000baseKX_Full_BIT,\n\t\t.speed = 1000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_1000baseKX_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_2500baseX_Full] = {\n\t\t.eth_mode =  ETHTOOL_LINK_MODE_2500baseX_Full_BIT,\n\t\t.speed = 2500,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_2500baseX_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t},\n\t[PRESTERA_LINK_MODE_10GbaseKR_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_10000baseKR_Full_BIT,\n\t\t.speed = 10000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_10GbaseKR_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_10GbaseSR_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_10000baseSR_Full_BIT,\n\t\t.speed = 10000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_10GbaseSR_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_FIBRE,\n\t},\n\t[PRESTERA_LINK_MODE_10GbaseLR_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_10000baseLR_Full_BIT,\n\t\t.speed = 10000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_10GbaseLR_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_FIBRE,\n\t},\n\t[PRESTERA_LINK_MODE_20GbaseKR2_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_20000baseKR2_Full_BIT,\n\t\t.speed = 20000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_20GbaseKR2_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_25GbaseCR_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_25000baseCR_Full_BIT,\n\t\t.speed = 25000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_25GbaseCR_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_DA,\n\t},\n\t[PRESTERA_LINK_MODE_25GbaseKR_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_25000baseKR_Full_BIT,\n\t\t.speed = 25000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_25GbaseKR_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_25GbaseSR_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_25000baseSR_Full_BIT,\n\t\t.speed = 25000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_25GbaseSR_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_FIBRE,\n\t},\n\t[PRESTERA_LINK_MODE_40GbaseKR4_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_40000baseKR4_Full_BIT,\n\t\t.speed = 40000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_40GbaseKR4_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_40GbaseCR4_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_40000baseCR4_Full_BIT,\n\t\t.speed = 40000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_40GbaseCR4_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_DA,\n\t},\n\t[PRESTERA_LINK_MODE_40GbaseSR4_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_40000baseSR4_Full_BIT,\n\t\t.speed = 40000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_40GbaseSR4_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_FIBRE,\n\t},\n\t[PRESTERA_LINK_MODE_50GbaseCR2_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_50000baseCR2_Full_BIT,\n\t\t.speed = 50000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_50GbaseCR2_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_DA,\n\t},\n\t[PRESTERA_LINK_MODE_50GbaseKR2_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_50000baseKR2_Full_BIT,\n\t\t.speed = 50000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_50GbaseKR2_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_50GbaseSR2_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_50000baseSR2_Full_BIT,\n\t\t.speed = 50000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_50GbaseSR2_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_FIBRE,\n\t},\n\t[PRESTERA_LINK_MODE_100GbaseKR4_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_100000baseKR4_Full_BIT,\n\t\t.speed = 100000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_100GbaseKR4_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_TP,\n\t},\n\t[PRESTERA_LINK_MODE_100GbaseSR4_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_100000baseSR4_Full_BIT,\n\t\t.speed = 100000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_100GbaseSR4_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_FIBRE,\n\t},\n\t[PRESTERA_LINK_MODE_100GbaseCR4_Full] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_100000baseCR4_Full_BIT,\n\t\t.speed = 100000,\n\t\t.pr_mask = 1 << PRESTERA_LINK_MODE_100GbaseCR4_Full,\n\t\t.duplex = PRESTERA_PORT_DUPLEX_FULL,\n\t\t.port_type = PRESTERA_PORT_TYPE_DA,\n\t}\n};\n\nstatic const struct prestera_fec {\n\tu32 eth_fec;\n\tenum ethtool_link_mode_bit_indices eth_mode;\n\tu8 pr_fec;\n} port_fec_caps[PRESTERA_PORT_FEC_MAX] = {\n\t[PRESTERA_PORT_FEC_OFF] = {\n\t\t.eth_fec = ETHTOOL_FEC_OFF,\n\t\t.eth_mode = ETHTOOL_LINK_MODE_FEC_NONE_BIT,\n\t\t.pr_fec = 1 << PRESTERA_PORT_FEC_OFF,\n\t},\n\t[PRESTERA_PORT_FEC_BASER] = {\n\t\t.eth_fec = ETHTOOL_FEC_BASER,\n\t\t.eth_mode = ETHTOOL_LINK_MODE_FEC_BASER_BIT,\n\t\t.pr_fec = 1 << PRESTERA_PORT_FEC_BASER,\n\t},\n\t[PRESTERA_PORT_FEC_RS] = {\n\t\t.eth_fec = ETHTOOL_FEC_RS,\n\t\t.eth_mode = ETHTOOL_LINK_MODE_FEC_RS_BIT,\n\t\t.pr_fec = 1 << PRESTERA_PORT_FEC_RS,\n\t}\n};\n\nstatic const struct prestera_port_type {\n\tenum ethtool_link_mode_bit_indices eth_mode;\n\tu8 eth_type;\n} port_types[PRESTERA_PORT_TYPE_MAX] = {\n\t[PRESTERA_PORT_TYPE_NONE] = {\n\t\t.eth_mode = __ETHTOOL_LINK_MODE_MASK_NBITS,\n\t\t.eth_type = PORT_NONE,\n\t},\n\t[PRESTERA_PORT_TYPE_TP] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_TP_BIT,\n\t\t.eth_type = PORT_TP,\n\t},\n\t[PRESTERA_PORT_TYPE_AUI] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_AUI_BIT,\n\t\t.eth_type = PORT_AUI,\n\t},\n\t[PRESTERA_PORT_TYPE_MII] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_MII_BIT,\n\t\t.eth_type = PORT_MII,\n\t},\n\t[PRESTERA_PORT_TYPE_FIBRE] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_FIBRE_BIT,\n\t\t.eth_type = PORT_FIBRE,\n\t},\n\t[PRESTERA_PORT_TYPE_BNC] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_BNC_BIT,\n\t\t.eth_type = PORT_BNC,\n\t},\n\t[PRESTERA_PORT_TYPE_DA] = {\n\t\t.eth_mode = ETHTOOL_LINK_MODE_TP_BIT,\n\t\t.eth_type = PORT_TP,\n\t},\n\t[PRESTERA_PORT_TYPE_OTHER] = {\n\t\t.eth_mode = __ETHTOOL_LINK_MODE_MASK_NBITS,\n\t\t.eth_type = PORT_OTHER,\n\t}\n};\n\nstatic const char prestera_cnt_name[PRESTERA_STATS_CNT][ETH_GSTRING_LEN] = {\n\tPRESTERA_STATS_FIELD(good_octets_received),\n\tPRESTERA_STATS_FIELD(bad_octets_received),\n\tPRESTERA_STATS_FIELD(mac_trans_error),\n\tPRESTERA_STATS_FIELD(broadcast_frames_received),\n\tPRESTERA_STATS_FIELD(multicast_frames_received),\n\tPRESTERA_STATS_FIELD(frames_64_octets),\n\tPRESTERA_STATS_FIELD(frames_65_to_127_octets),\n\tPRESTERA_STATS_FIELD(frames_128_to_255_octets),\n\tPRESTERA_STATS_FIELD(frames_256_to_511_octets),\n\tPRESTERA_STATS_FIELD(frames_512_to_1023_octets),\n\tPRESTERA_STATS_FIELD(frames_1024_to_max_octets),\n\tPRESTERA_STATS_FIELD(excessive_collision),\n\tPRESTERA_STATS_FIELD(multicast_frames_sent),\n\tPRESTERA_STATS_FIELD(broadcast_frames_sent),\n\tPRESTERA_STATS_FIELD(fc_sent),\n\tPRESTERA_STATS_FIELD(fc_received),\n\tPRESTERA_STATS_FIELD(buffer_overrun),\n\tPRESTERA_STATS_FIELD(undersize),\n\tPRESTERA_STATS_FIELD(fragments),\n\tPRESTERA_STATS_FIELD(oversize),\n\tPRESTERA_STATS_FIELD(jabber),\n\tPRESTERA_STATS_FIELD(rx_error_frame_received),\n\tPRESTERA_STATS_FIELD(bad_crc),\n\tPRESTERA_STATS_FIELD(collisions),\n\tPRESTERA_STATS_FIELD(late_collision),\n\tPRESTERA_STATS_FIELD(unicast_frames_received),\n\tPRESTERA_STATS_FIELD(unicast_frames_sent),\n\tPRESTERA_STATS_FIELD(sent_multiple),\n\tPRESTERA_STATS_FIELD(sent_deferred),\n\tPRESTERA_STATS_FIELD(good_octets_sent),\n};\n\nstatic void prestera_ethtool_get_drvinfo(struct net_device *dev,\n\t\t\t\t\t struct ethtool_drvinfo *drvinfo)\n{\n\tstruct prestera_port *port = netdev_priv(dev);\n\tstruct prestera_switch *sw = port->sw;\n\n\tstrscpy(drvinfo->driver, driver_kind, sizeof(drvinfo->driver));\n\tstrscpy(drvinfo->bus_info, dev_name(prestera_dev(sw)),\n\t\tsizeof(drvinfo->bus_info));\n\tsnprintf(drvinfo->fw_version, sizeof(drvinfo->fw_version),\n\t\t \"%d.%d.%d\",\n\t\t sw->dev->fw_rev.maj,\n\t\t sw->dev->fw_rev.min,\n\t\t sw->dev->fw_rev.sub);\n}\n\nstatic u8 prestera_port_type_get(struct prestera_port *port)\n{\n\tif (port->caps.type < PRESTERA_PORT_TYPE_MAX)\n\t\treturn port_types[port->caps.type].eth_type;\n\n\treturn PORT_OTHER;\n}\n\nstatic int prestera_port_type_set(const struct ethtool_link_ksettings *ecmd,\n\t\t\t\t  struct prestera_port *port)\n{\n\tu32 new_mode = PRESTERA_LINK_MODE_MAX;\n\tu32 type, mode;\n\n\tfor (type = 0; type < PRESTERA_PORT_TYPE_MAX; type++) {\n\t\tif (port_types[type].eth_type == ecmd->base.port &&\n\t\t    test_bit(port_types[type].eth_mode,\n\t\t\t     ecmd->link_modes.supported)) {\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (type == port->caps.type)\n\t\treturn 0;\n\tif (type != port->caps.type && ecmd->base.autoneg == AUTONEG_ENABLE)\n\t\treturn -EINVAL;\n\tif (type == PRESTERA_PORT_TYPE_MAX)\n\t\treturn -EOPNOTSUPP;\n\n\tfor (mode = 0; mode < PRESTERA_LINK_MODE_MAX; mode++) {\n\t\tif ((port_link_modes[mode].pr_mask &\n\t\t    port->caps.supp_link_modes) &&\n\t\t    type == port_link_modes[mode].port_type) {\n\t\t\tnew_mode = mode;\n\t\t}\n\t}\n\n\tif (new_mode >= PRESTERA_LINK_MODE_MAX)\n\t\treturn -EINVAL;\n\n\tport->caps.type = type;\n\tport->autoneg = false;\n\n\treturn 0;\n}\n\nstatic void prestera_modes_to_eth(unsigned long *eth_modes, u64 link_modes,\n\t\t\t\t  u8 fec, u8 type)\n{\n\tu32 mode;\n\n\tfor (mode = 0; mode < PRESTERA_LINK_MODE_MAX; mode++) {\n\t\tif ((port_link_modes[mode].pr_mask & link_modes) == 0)\n\t\t\tcontinue;\n\n\t\tif (type != PRESTERA_PORT_TYPE_NONE &&\n\t\t    port_link_modes[mode].port_type != type)\n\t\t\tcontinue;\n\n\t\t__set_bit(port_link_modes[mode].eth_mode, eth_modes);\n\t}\n\n\tfor (mode = 0; mode < PRESTERA_PORT_FEC_MAX; mode++) {\n\t\tif ((port_fec_caps[mode].pr_fec & fec) == 0)\n\t\t\tcontinue;\n\n\t\t__set_bit(port_fec_caps[mode].eth_mode, eth_modes);\n\t}\n}\n\nstatic void prestera_modes_from_eth(const unsigned long *eth_modes,\n\t\t\t\t    u64 *link_modes, u8 *fec, u8 type)\n{\n\tu64 adver_modes = 0;\n\tu32 fec_modes = 0;\n\tu32 mode;\n\n\tfor (mode = 0; mode < PRESTERA_LINK_MODE_MAX; mode++) {\n\t\tif (!test_bit(port_link_modes[mode].eth_mode, eth_modes))\n\t\t\tcontinue;\n\n\t\tif (port_link_modes[mode].port_type != type)\n\t\t\tcontinue;\n\n\t\tadver_modes |= port_link_modes[mode].pr_mask;\n\t}\n\n\tfor (mode = 0; mode < PRESTERA_PORT_FEC_MAX; mode++) {\n\t\tif (!test_bit(port_fec_caps[mode].eth_mode, eth_modes))\n\t\t\tcontinue;\n\n\t\tfec_modes |= port_fec_caps[mode].pr_fec;\n\t}\n\n\t*link_modes = adver_modes;\n\t*fec = fec_modes;\n}\n\nstatic void prestera_port_supp_types_get(struct ethtool_link_ksettings *ecmd,\n\t\t\t\t\t struct prestera_port *port)\n{\n\tu32 mode;\n\tu8 ptype;\n\n\tfor (mode = 0; mode < PRESTERA_LINK_MODE_MAX; mode++) {\n\t\tif ((port_link_modes[mode].pr_mask &\n\t\t    port->caps.supp_link_modes) == 0)\n\t\t\tcontinue;\n\n\t\tptype = port_link_modes[mode].port_type;\n\t\t__set_bit(port_types[ptype].eth_mode,\n\t\t\t  ecmd->link_modes.supported);\n\t}\n}\n\nstatic void prestera_port_remote_cap_get(struct ethtool_link_ksettings *ecmd,\n\t\t\t\t\t struct prestera_port *port)\n{\n\tstruct prestera_port_phy_state *state = &port->state_phy;\n\tbool asym_pause;\n\tbool pause;\n\tu64 bitmap;\n\tint err;\n\n\terr = prestera_hw_port_phy_mode_get(port, NULL, &state->lmode_bmap,\n\t\t\t\t\t    &state->remote_fc.pause,\n\t\t\t\t\t    &state->remote_fc.asym_pause);\n\tif (err)\n\t\tnetdev_warn(port->dev, \"Remote link caps get failed %d\",\n\t\t\t    port->caps.transceiver);\n\n\tbitmap = state->lmode_bmap;\n\n\tprestera_modes_to_eth(ecmd->link_modes.lp_advertising,\n\t\t\t      bitmap, 0, PRESTERA_PORT_TYPE_NONE);\n\n\tif (!bitmap_empty(ecmd->link_modes.lp_advertising,\n\t\t\t  __ETHTOOL_LINK_MODE_MASK_NBITS)) {\n\t\tethtool_link_ksettings_add_link_mode(ecmd,\n\t\t\t\t\t\t     lp_advertising,\n\t\t\t\t\t\t     Autoneg);\n\t}\n\n\tpause = state->remote_fc.pause;\n\tasym_pause = state->remote_fc.asym_pause;\n\n\tif (pause)\n\t\tethtool_link_ksettings_add_link_mode(ecmd,\n\t\t\t\t\t\t     lp_advertising,\n\t\t\t\t\t\t     Pause);\n\tif (asym_pause)\n\t\tethtool_link_ksettings_add_link_mode(ecmd,\n\t\t\t\t\t\t     lp_advertising,\n\t\t\t\t\t\t     Asym_Pause);\n}\n\nstatic void prestera_port_link_mode_get(struct ethtool_link_ksettings *ecmd,\n\t\t\t\t\tstruct prestera_port *port)\n{\n\tstruct prestera_port_mac_state *state = &port->state_mac;\n\tu32 speed;\n\tu8 duplex;\n\tint err;\n\n\tif (!port->state_mac.oper)\n\t\treturn;\n\n\tif (state->speed == SPEED_UNKNOWN || state->duplex == DUPLEX_UNKNOWN) {\n\t\terr = prestera_hw_port_mac_mode_get(port, NULL, &speed,\n\t\t\t\t\t\t    &duplex, NULL);\n\t\tif (err) {\n\t\t\tstate->speed = SPEED_UNKNOWN;\n\t\t\tstate->duplex = DUPLEX_UNKNOWN;\n\t\t} else {\n\t\t\tstate->speed = speed;\n\t\t\tstate->duplex = duplex == PRESTERA_PORT_DUPLEX_FULL ?\n\t\t\t\t\t  DUPLEX_FULL : DUPLEX_HALF;\n\t\t}\n\t}\n\n\tecmd->base.speed = port->state_mac.speed;\n\tecmd->base.duplex = port->state_mac.duplex;\n}\n\nstatic void prestera_port_mdix_get(struct ethtool_link_ksettings *ecmd,\n\t\t\t\t   struct prestera_port *port)\n{\n\tstruct prestera_port_phy_state *state = &port->state_phy;\n\n\tif (prestera_hw_port_phy_mode_get(port,\n\t\t\t\t\t  &state->mdix, NULL, NULL, NULL)) {\n\t\tnetdev_warn(port->dev, \"MDIX params get failed\");\n\t\tstate->mdix = ETH_TP_MDI_INVALID;\n\t}\n\n\tecmd->base.eth_tp_mdix = port->state_phy.mdix;\n\tecmd->base.eth_tp_mdix_ctrl = port->cfg_phy.mdix;\n}\n\nstatic int\nprestera_ethtool_get_link_ksettings(struct net_device *dev,\n\t\t\t\t    struct ethtool_link_ksettings *ecmd)\n{\n\tstruct prestera_port *port = netdev_priv(dev);\n\n\tethtool_link_ksettings_zero_link_mode(ecmd, supported);\n\tethtool_link_ksettings_zero_link_mode(ecmd, advertising);\n\tethtool_link_ksettings_zero_link_mode(ecmd, lp_advertising);\n\tecmd->base.speed = SPEED_UNKNOWN;\n\tecmd->base.duplex = DUPLEX_UNKNOWN;\n\n\tif (port->phy_link)\n\t\treturn phylink_ethtool_ksettings_get(port->phy_link, ecmd);\n\n\tecmd->base.autoneg = port->autoneg ? AUTONEG_ENABLE : AUTONEG_DISABLE;\n\n\tif (port->caps.type == PRESTERA_PORT_TYPE_TP) {\n\t\tethtool_link_ksettings_add_link_mode(ecmd, supported, Autoneg);\n\n\t\tif (netif_running(dev) &&\n\t\t    (port->autoneg ||\n\t\t     port->caps.transceiver == PRESTERA_PORT_TCVR_COPPER))\n\t\t\tethtool_link_ksettings_add_link_mode(ecmd, advertising,\n\t\t\t\t\t\t\t     Autoneg);\n\t}\n\n\tprestera_modes_to_eth(ecmd->link_modes.supported,\n\t\t\t      port->caps.supp_link_modes,\n\t\t\t      port->caps.supp_fec,\n\t\t\t      port->caps.type);\n\n\tprestera_port_supp_types_get(ecmd, port);\n\n\tif (netif_carrier_ok(dev))\n\t\tprestera_port_link_mode_get(ecmd, port);\n\n\tecmd->base.port = prestera_port_type_get(port);\n\n\tif (port->autoneg) {\n\t\tif (netif_running(dev))\n\t\t\tprestera_modes_to_eth(ecmd->link_modes.advertising,\n\t\t\t\t\t      port->adver_link_modes,\n\t\t\t\t\t      port->adver_fec,\n\t\t\t\t\t      port->caps.type);\n\n\t\tif (netif_carrier_ok(dev) &&\n\t\t    port->caps.transceiver == PRESTERA_PORT_TCVR_COPPER)\n\t\t\tprestera_port_remote_cap_get(ecmd, port);\n\t}\n\n\tif (port->caps.type == PRESTERA_PORT_TYPE_TP &&\n\t    port->caps.transceiver == PRESTERA_PORT_TCVR_COPPER)\n\t\tprestera_port_mdix_get(ecmd, port);\n\n\treturn 0;\n}\n\nstatic int prestera_port_mdix_set(const struct ethtool_link_ksettings *ecmd,\n\t\t\t\t  struct prestera_port *port)\n{\n\tif (ecmd->base.eth_tp_mdix_ctrl != ETH_TP_MDI_INVALID &&\n\t    port->caps.transceiver ==  PRESTERA_PORT_TCVR_COPPER &&\n\t    port->caps.type == PRESTERA_PORT_TYPE_TP) {\n\t\tport->cfg_phy.mdix = ecmd->base.eth_tp_mdix_ctrl;\n\t\treturn prestera_hw_port_phy_mode_set(port, port->cfg_phy.admin,\n\t\t\t\t\t\t     port->autoneg,\n\t\t\t\t\t\t     port->cfg_phy.mode,\n\t\t\t\t\t\t     port->adver_link_modes,\n\t\t\t\t\t\t     port->cfg_phy.mdix);\n\t}\n\treturn 0;\n\n}\n\nstatic int prestera_port_link_mode_set(struct prestera_port *port,\n\t\t\t\t       u32 speed, u8 duplex, u8 type)\n{\n\tu32 new_mode = PRESTERA_LINK_MODE_MAX;\n\tu32 mode;\n\tint err;\n\n\tfor (mode = 0; mode < PRESTERA_LINK_MODE_MAX; mode++) {\n\t\tif (speed != SPEED_UNKNOWN &&\n\t\t    speed != port_link_modes[mode].speed)\n\t\t\tcontinue;\n\n\t\tif (duplex != DUPLEX_UNKNOWN &&\n\t\t    duplex != port_link_modes[mode].duplex)\n\t\t\tcontinue;\n\n\t\tif (!(port_link_modes[mode].pr_mask &\n\t\t    port->caps.supp_link_modes))\n\t\t\tcontinue;\n\n\t\tif (type != port_link_modes[mode].port_type)\n\t\t\tcontinue;\n\n\t\tnew_mode = mode;\n\t\tbreak;\n\t}\n\n\tif (new_mode == PRESTERA_LINK_MODE_MAX)\n\t\treturn -EOPNOTSUPP;\n\n\terr = prestera_hw_port_phy_mode_set(port, port->cfg_phy.admin,\n\t\t\t\t\t    false, new_mode, 0,\n\t\t\t\t\t    port->cfg_phy.mdix);\n\tif (err)\n\t\treturn err;\n\n\tport->adver_fec = BIT(PRESTERA_PORT_FEC_OFF);\n\tport->adver_link_modes = 0;\n\tport->cfg_phy.mode = new_mode;\n\tport->autoneg = false;\n\n\treturn 0;\n}\n\nstatic int\nprestera_port_speed_duplex_set(const struct ethtool_link_ksettings *ecmd,\n\t\t\t       struct prestera_port *port)\n{\n\tu8 duplex = DUPLEX_UNKNOWN;\n\n\tif (ecmd->base.duplex != DUPLEX_UNKNOWN)\n\t\tduplex = ecmd->base.duplex == DUPLEX_FULL ?\n\t\t\t PRESTERA_PORT_DUPLEX_FULL : PRESTERA_PORT_DUPLEX_HALF;\n\n\treturn prestera_port_link_mode_set(port, ecmd->base.speed, duplex,\n\t\t\t\t\t   port->caps.type);\n}\n\nstatic int\nprestera_ethtool_set_link_ksettings(struct net_device *dev,\n\t\t\t\t    const struct ethtool_link_ksettings *ecmd)\n{\n\tstruct prestera_port *port = netdev_priv(dev);\n\tu64 adver_modes;\n\tu8 adver_fec;\n\tint err;\n\n\tif (port->phy_link)\n\t\treturn phylink_ethtool_ksettings_set(port->phy_link, ecmd);\n\n\terr = prestera_port_type_set(ecmd, port);\n\tif (err)\n\t\treturn err;\n\n\tif (port->caps.transceiver == PRESTERA_PORT_TCVR_COPPER) {\n\t\terr = prestera_port_mdix_set(ecmd, port);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tprestera_modes_from_eth(ecmd->link_modes.advertising, &adver_modes,\n\t\t\t\t&adver_fec, port->caps.type);\n\n\tif (ecmd->base.autoneg == AUTONEG_ENABLE)\n\t\terr = prestera_port_autoneg_set(port, adver_modes);\n\telse\n\t\terr = prestera_port_speed_duplex_set(ecmd, port);\n\n\treturn err;\n}\n\nstatic int prestera_ethtool_get_fecparam(struct net_device *dev,\n\t\t\t\t\t struct ethtool_fecparam *fecparam)\n{\n\tstruct prestera_port *port = netdev_priv(dev);\n\tu8 active;\n\tu32 mode;\n\tint err;\n\n\terr = prestera_hw_port_mac_mode_get(port, NULL, NULL, NULL, &active);\n\tif (err)\n\t\treturn err;\n\n\tfecparam->fec = 0;\n\n\tfor (mode = 0; mode < PRESTERA_PORT_FEC_MAX; mode++) {\n\t\tif ((port_fec_caps[mode].pr_fec & port->caps.supp_fec) == 0)\n\t\t\tcontinue;\n\n\t\tfecparam->fec |= port_fec_caps[mode].eth_fec;\n\t}\n\n\tif (active < PRESTERA_PORT_FEC_MAX)\n\t\tfecparam->active_fec = port_fec_caps[active].eth_fec;\n\telse\n\t\tfecparam->active_fec = ETHTOOL_FEC_AUTO;\n\n\treturn 0;\n}\n\nstatic int prestera_ethtool_set_fecparam(struct net_device *dev,\n\t\t\t\t\t struct ethtool_fecparam *fecparam)\n{\n\tstruct prestera_port *port = netdev_priv(dev);\n\tstruct prestera_port_mac_config cfg_mac;\n\tu32 mode;\n\tu8 fec;\n\n\tif (port->autoneg) {\n\t\tnetdev_err(dev, \"FEC set is not allowed while autoneg is on\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (port->caps.transceiver == PRESTERA_PORT_TCVR_SFP) {\n\t\tnetdev_err(dev, \"FEC set is not allowed on non-SFP ports\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tfec = PRESTERA_PORT_FEC_MAX;\n\tfor (mode = 0; mode < PRESTERA_PORT_FEC_MAX; mode++) {\n\t\tif ((port_fec_caps[mode].eth_fec & fecparam->fec) &&\n\t\t    (port_fec_caps[mode].pr_fec & port->caps.supp_fec)) {\n\t\t\tfec = mode;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tprestera_port_cfg_mac_read(port, &cfg_mac);\n\n\tif (fec == cfg_mac.fec)\n\t\treturn 0;\n\n\tif (fec == PRESTERA_PORT_FEC_MAX) {\n\t\tnetdev_err(dev, \"Unsupported FEC requested\");\n\t\treturn -EINVAL;\n\t}\n\n\tcfg_mac.fec = fec;\n\n\treturn prestera_port_cfg_mac_write(port, &cfg_mac);\n}\n\nstatic int prestera_ethtool_get_sset_count(struct net_device *dev, int sset)\n{\n\tswitch (sset) {\n\tcase ETH_SS_STATS:\n\t\treturn PRESTERA_STATS_CNT;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic void prestera_ethtool_get_strings(struct net_device *dev,\n\t\t\t\t\t u32 stringset, u8 *data)\n{\n\tif (stringset != ETH_SS_STATS)\n\t\treturn;\n\n\tmemcpy(data, prestera_cnt_name, sizeof(prestera_cnt_name));\n}\n\nstatic void prestera_ethtool_get_stats(struct net_device *dev,\n\t\t\t\t       struct ethtool_stats *stats, u64 *data)\n{\n\tstruct prestera_port *port = netdev_priv(dev);\n\tstruct prestera_port_stats *port_stats;\n\n\tport_stats = &port->cached_hw_stats.stats;\n\n\tmemcpy(data, port_stats, sizeof(*port_stats));\n}\n\nstatic int prestera_ethtool_nway_reset(struct net_device *dev)\n{\n\tstruct prestera_port *port = netdev_priv(dev);\n\n\tif (netif_running(dev) &&\n\t    port->caps.transceiver == PRESTERA_PORT_TCVR_COPPER &&\n\t    port->caps.type == PRESTERA_PORT_TYPE_TP)\n\t\treturn prestera_hw_port_autoneg_restart(port);\n\n\treturn -EINVAL;\n}\n\nconst struct ethtool_ops prestera_ethtool_ops = {\n\t.get_drvinfo = prestera_ethtool_get_drvinfo,\n\t.get_link_ksettings = prestera_ethtool_get_link_ksettings,\n\t.set_link_ksettings = prestera_ethtool_set_link_ksettings,\n\t.get_fecparam = prestera_ethtool_get_fecparam,\n\t.set_fecparam = prestera_ethtool_set_fecparam,\n\t.get_sset_count = prestera_ethtool_get_sset_count,\n\t.get_strings = prestera_ethtool_get_strings,\n\t.get_ethtool_stats = prestera_ethtool_get_stats,\n\t.get_link = ethtool_op_get_link,\n\t.nway_reset = prestera_ethtool_nway_reset\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}