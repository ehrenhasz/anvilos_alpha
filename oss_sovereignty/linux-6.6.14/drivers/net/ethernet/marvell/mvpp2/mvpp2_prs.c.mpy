{
  "module_name": "mvpp2_prs.c",
  "hash_id": "6aa5358162f0e8b7dc5ae00de69eaa18f7d46d054aa64074deaee7d1b09e5646",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/marvell/mvpp2/mvpp2_prs.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n#include <linux/platform_device.h>\n#include <uapi/linux/ppp_defs.h>\n#include <net/ip.h>\n#include <net/ipv6.h>\n\n#include \"mvpp2.h\"\n#include \"mvpp2_prs.h\"\n\n \nstatic int mvpp2_prs_hw_write(struct mvpp2 *priv, struct mvpp2_prs_entry *pe)\n{\n\tint i;\n\n\tif (pe->index > MVPP2_PRS_TCAM_SRAM_SIZE - 1)\n\t\treturn -EINVAL;\n\n\t \n\tpe->tcam[MVPP2_PRS_TCAM_INV_WORD] &= ~MVPP2_PRS_TCAM_INV_MASK;\n\n\t \n\tmvpp2_write(priv, MVPP2_PRS_SRAM_IDX_REG, pe->index);\n\tfor (i = 0; i < MVPP2_PRS_SRAM_WORDS; i++)\n\t\tmvpp2_write(priv, MVPP2_PRS_SRAM_DATA_REG(i), pe->sram[i]);\n\n\t \n\tmvpp2_write(priv, MVPP2_PRS_TCAM_IDX_REG, pe->index);\n\tfor (i = 0; i < MVPP2_PRS_TCAM_WORDS; i++)\n\t\tmvpp2_write(priv, MVPP2_PRS_TCAM_DATA_REG(i), pe->tcam[i]);\n\n\treturn 0;\n}\n\n \nint mvpp2_prs_init_from_hw(struct mvpp2 *priv, struct mvpp2_prs_entry *pe,\n\t\t\t   int tid)\n{\n\tint i;\n\n\tif (tid > MVPP2_PRS_TCAM_SRAM_SIZE - 1)\n\t\treturn -EINVAL;\n\n\tmemset(pe, 0, sizeof(*pe));\n\tpe->index = tid;\n\n\t \n\tmvpp2_write(priv, MVPP2_PRS_TCAM_IDX_REG, pe->index);\n\n\tpe->tcam[MVPP2_PRS_TCAM_INV_WORD] = mvpp2_read(priv,\n\t\t\t      MVPP2_PRS_TCAM_DATA_REG(MVPP2_PRS_TCAM_INV_WORD));\n\tif (pe->tcam[MVPP2_PRS_TCAM_INV_WORD] & MVPP2_PRS_TCAM_INV_MASK)\n\t\treturn MVPP2_PRS_TCAM_ENTRY_INVALID;\n\n\tfor (i = 0; i < MVPP2_PRS_TCAM_WORDS; i++)\n\t\tpe->tcam[i] = mvpp2_read(priv, MVPP2_PRS_TCAM_DATA_REG(i));\n\n\t \n\tmvpp2_write(priv, MVPP2_PRS_SRAM_IDX_REG, pe->index);\n\tfor (i = 0; i < MVPP2_PRS_SRAM_WORDS; i++)\n\t\tpe->sram[i] = mvpp2_read(priv, MVPP2_PRS_SRAM_DATA_REG(i));\n\n\treturn 0;\n}\n\n \nstatic void mvpp2_prs_hw_inv(struct mvpp2 *priv, int index)\n{\n\t \n\tmvpp2_write(priv, MVPP2_PRS_TCAM_IDX_REG, index);\n\tmvpp2_write(priv, MVPP2_PRS_TCAM_DATA_REG(MVPP2_PRS_TCAM_INV_WORD),\n\t\t    MVPP2_PRS_TCAM_INV_MASK);\n}\n\n \nstatic void mvpp2_prs_shadow_set(struct mvpp2 *priv, int index, int lu)\n{\n\tpriv->prs_shadow[index].valid = true;\n\tpriv->prs_shadow[index].lu = lu;\n}\n\n \nstatic void mvpp2_prs_shadow_ri_set(struct mvpp2 *priv, int index,\n\t\t\t\t    unsigned int ri, unsigned int ri_mask)\n{\n\tpriv->prs_shadow[index].ri_mask = ri_mask;\n\tpriv->prs_shadow[index].ri = ri;\n}\n\n \nstatic void mvpp2_prs_tcam_lu_set(struct mvpp2_prs_entry *pe, unsigned int lu)\n{\n\tpe->tcam[MVPP2_PRS_TCAM_LU_WORD] &= ~MVPP2_PRS_TCAM_LU(MVPP2_PRS_LU_MASK);\n\tpe->tcam[MVPP2_PRS_TCAM_LU_WORD] &= ~MVPP2_PRS_TCAM_LU_EN(MVPP2_PRS_LU_MASK);\n\tpe->tcam[MVPP2_PRS_TCAM_LU_WORD] |= MVPP2_PRS_TCAM_LU(lu & MVPP2_PRS_LU_MASK);\n\tpe->tcam[MVPP2_PRS_TCAM_LU_WORD] |= MVPP2_PRS_TCAM_LU_EN(MVPP2_PRS_LU_MASK);\n}\n\n \nstatic void mvpp2_prs_tcam_port_set(struct mvpp2_prs_entry *pe,\n\t\t\t\t    unsigned int port, bool add)\n{\n\tif (add)\n\t\tpe->tcam[MVPP2_PRS_TCAM_PORT_WORD] &= ~MVPP2_PRS_TCAM_PORT_EN(BIT(port));\n\telse\n\t\tpe->tcam[MVPP2_PRS_TCAM_PORT_WORD] |= MVPP2_PRS_TCAM_PORT_EN(BIT(port));\n}\n\n \nstatic void mvpp2_prs_tcam_port_map_set(struct mvpp2_prs_entry *pe,\n\t\t\t\t\tunsigned int ports)\n{\n\tpe->tcam[MVPP2_PRS_TCAM_PORT_WORD] &= ~MVPP2_PRS_TCAM_PORT(MVPP2_PRS_PORT_MASK);\n\tpe->tcam[MVPP2_PRS_TCAM_PORT_WORD] &= ~MVPP2_PRS_TCAM_PORT_EN(MVPP2_PRS_PORT_MASK);\n\tpe->tcam[MVPP2_PRS_TCAM_PORT_WORD] |= MVPP2_PRS_TCAM_PORT_EN(~ports & MVPP2_PRS_PORT_MASK);\n}\n\n \nunsigned int mvpp2_prs_tcam_port_map_get(struct mvpp2_prs_entry *pe)\n{\n\treturn (~pe->tcam[MVPP2_PRS_TCAM_PORT_WORD] >> 24) & MVPP2_PRS_PORT_MASK;\n}\n\n \nstatic void mvpp2_prs_tcam_data_byte_set(struct mvpp2_prs_entry *pe,\n\t\t\t\t\t unsigned int offs, unsigned char byte,\n\t\t\t\t\t unsigned char enable)\n{\n\tint pos = MVPP2_PRS_BYTE_IN_WORD(offs) * BITS_PER_BYTE;\n\n\tpe->tcam[MVPP2_PRS_BYTE_TO_WORD(offs)] &= ~(0xff << pos);\n\tpe->tcam[MVPP2_PRS_BYTE_TO_WORD(offs)] &= ~(MVPP2_PRS_TCAM_EN(0xff) << pos);\n\tpe->tcam[MVPP2_PRS_BYTE_TO_WORD(offs)] |= byte << pos;\n\tpe->tcam[MVPP2_PRS_BYTE_TO_WORD(offs)] |= MVPP2_PRS_TCAM_EN(enable << pos);\n}\n\n \nvoid mvpp2_prs_tcam_data_byte_get(struct mvpp2_prs_entry *pe,\n\t\t\t\t  unsigned int offs, unsigned char *byte,\n\t\t\t\t  unsigned char *enable)\n{\n\tint pos = MVPP2_PRS_BYTE_IN_WORD(offs) * BITS_PER_BYTE;\n\n\t*byte = (pe->tcam[MVPP2_PRS_BYTE_TO_WORD(offs)] >> pos) & 0xff;\n\t*enable = (pe->tcam[MVPP2_PRS_BYTE_TO_WORD(offs)] >> (pos + 16)) & 0xff;\n}\n\n \nstatic bool mvpp2_prs_tcam_data_cmp(struct mvpp2_prs_entry *pe, int offs,\n\t\t\t\t    u16 data)\n{\n\tu16 tcam_data;\n\n\ttcam_data = pe->tcam[MVPP2_PRS_BYTE_TO_WORD(offs)] & 0xffff;\n\treturn tcam_data == data;\n}\n\n \nstatic void mvpp2_prs_tcam_ai_update(struct mvpp2_prs_entry *pe,\n\t\t\t\t     unsigned int bits, unsigned int enable)\n{\n\tint i;\n\n\tfor (i = 0; i < MVPP2_PRS_AI_BITS; i++) {\n\t\tif (!(enable & BIT(i)))\n\t\t\tcontinue;\n\n\t\tif (bits & BIT(i))\n\t\t\tpe->tcam[MVPP2_PRS_TCAM_AI_WORD] |= BIT(i);\n\t\telse\n\t\t\tpe->tcam[MVPP2_PRS_TCAM_AI_WORD] &= ~BIT(i);\n\t}\n\n\tpe->tcam[MVPP2_PRS_TCAM_AI_WORD] |= MVPP2_PRS_TCAM_AI_EN(enable);\n}\n\n \nstatic int mvpp2_prs_tcam_ai_get(struct mvpp2_prs_entry *pe)\n{\n\treturn pe->tcam[MVPP2_PRS_TCAM_AI_WORD] & MVPP2_PRS_AI_MASK;\n}\n\n \nstatic void mvpp2_prs_match_etype(struct mvpp2_prs_entry *pe, int offset,\n\t\t\t\t  unsigned short ethertype)\n{\n\tmvpp2_prs_tcam_data_byte_set(pe, offset + 0, ethertype >> 8, 0xff);\n\tmvpp2_prs_tcam_data_byte_set(pe, offset + 1, ethertype & 0xff, 0xff);\n}\n\n \nstatic void mvpp2_prs_match_vid(struct mvpp2_prs_entry *pe, int offset,\n\t\t\t\tunsigned short vid)\n{\n\tmvpp2_prs_tcam_data_byte_set(pe, offset + 0, (vid & 0xf00) >> 8, 0xf);\n\tmvpp2_prs_tcam_data_byte_set(pe, offset + 1, vid & 0xff, 0xff);\n}\n\n \nstatic void mvpp2_prs_sram_bits_set(struct mvpp2_prs_entry *pe, int bit_num,\n\t\t\t\t    u32 val)\n{\n\tpe->sram[MVPP2_BIT_TO_WORD(bit_num)] |= (val << (MVPP2_BIT_IN_WORD(bit_num)));\n}\n\n \nstatic void mvpp2_prs_sram_bits_clear(struct mvpp2_prs_entry *pe, int bit_num,\n\t\t\t\t      u32 val)\n{\n\tpe->sram[MVPP2_BIT_TO_WORD(bit_num)] &= ~(val << (MVPP2_BIT_IN_WORD(bit_num)));\n}\n\n \nstatic void mvpp2_prs_sram_ri_update(struct mvpp2_prs_entry *pe,\n\t\t\t\t     unsigned int bits, unsigned int mask)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < MVPP2_PRS_SRAM_RI_CTRL_BITS; i++) {\n\t\tif (!(mask & BIT(i)))\n\t\t\tcontinue;\n\n\t\tif (bits & BIT(i))\n\t\t\tmvpp2_prs_sram_bits_set(pe, MVPP2_PRS_SRAM_RI_OFFS + i,\n\t\t\t\t\t\t1);\n\t\telse\n\t\t\tmvpp2_prs_sram_bits_clear(pe,\n\t\t\t\t\t\t  MVPP2_PRS_SRAM_RI_OFFS + i,\n\t\t\t\t\t\t  1);\n\n\t\tmvpp2_prs_sram_bits_set(pe, MVPP2_PRS_SRAM_RI_CTRL_OFFS + i, 1);\n\t}\n}\n\n \nstatic int mvpp2_prs_sram_ri_get(struct mvpp2_prs_entry *pe)\n{\n\treturn pe->sram[MVPP2_PRS_SRAM_RI_WORD];\n}\n\n \nstatic void mvpp2_prs_sram_ai_update(struct mvpp2_prs_entry *pe,\n\t\t\t\t     unsigned int bits, unsigned int mask)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < MVPP2_PRS_SRAM_AI_CTRL_BITS; i++) {\n\t\tif (!(mask & BIT(i)))\n\t\t\tcontinue;\n\n\t\tif (bits & BIT(i))\n\t\t\tmvpp2_prs_sram_bits_set(pe, MVPP2_PRS_SRAM_AI_OFFS + i,\n\t\t\t\t\t\t1);\n\t\telse\n\t\t\tmvpp2_prs_sram_bits_clear(pe,\n\t\t\t\t\t\t  MVPP2_PRS_SRAM_AI_OFFS + i,\n\t\t\t\t\t\t  1);\n\n\t\tmvpp2_prs_sram_bits_set(pe, MVPP2_PRS_SRAM_AI_CTRL_OFFS + i, 1);\n\t}\n}\n\n \nstatic int mvpp2_prs_sram_ai_get(struct mvpp2_prs_entry *pe)\n{\n\tu8 bits;\n\t \n\tint ai_off = MVPP2_BIT_TO_WORD(MVPP2_PRS_SRAM_AI_OFFS);\n\tint ai_shift = MVPP2_BIT_IN_WORD(MVPP2_PRS_SRAM_AI_OFFS);\n\n\tbits = (pe->sram[ai_off] >> ai_shift) |\n\t       (pe->sram[ai_off + 1] << (32 - ai_shift));\n\n\treturn bits;\n}\n\n \nstatic void mvpp2_prs_sram_next_lu_set(struct mvpp2_prs_entry *pe,\n\t\t\t\t       unsigned int lu)\n{\n\tint sram_next_off = MVPP2_PRS_SRAM_NEXT_LU_OFFS;\n\n\tmvpp2_prs_sram_bits_clear(pe, sram_next_off,\n\t\t\t\t  MVPP2_PRS_SRAM_NEXT_LU_MASK);\n\tmvpp2_prs_sram_bits_set(pe, sram_next_off, lu);\n}\n\n \nstatic void mvpp2_prs_sram_shift_set(struct mvpp2_prs_entry *pe, int shift,\n\t\t\t\t     unsigned int op)\n{\n\t \n\tif (shift < 0) {\n\t\tmvpp2_prs_sram_bits_set(pe, MVPP2_PRS_SRAM_SHIFT_SIGN_BIT, 1);\n\t\tshift = 0 - shift;\n\t} else {\n\t\tmvpp2_prs_sram_bits_clear(pe, MVPP2_PRS_SRAM_SHIFT_SIGN_BIT, 1);\n\t}\n\n\t \n\tpe->sram[MVPP2_BIT_TO_WORD(MVPP2_PRS_SRAM_SHIFT_OFFS)] |=\n\t\tshift & MVPP2_PRS_SRAM_SHIFT_MASK;\n\n\t \n\tmvpp2_prs_sram_bits_clear(pe, MVPP2_PRS_SRAM_OP_SEL_SHIFT_OFFS,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_SHIFT_MASK);\n\tmvpp2_prs_sram_bits_set(pe, MVPP2_PRS_SRAM_OP_SEL_SHIFT_OFFS, op);\n\n\t \n\tmvpp2_prs_sram_bits_clear(pe, MVPP2_PRS_SRAM_OP_SEL_BASE_OFFS, 1);\n}\n\n \nstatic void mvpp2_prs_sram_offset_set(struct mvpp2_prs_entry *pe,\n\t\t\t\t      unsigned int type, int offset,\n\t\t\t\t      unsigned int op)\n{\n\t \n\tif (offset < 0) {\n\t\tmvpp2_prs_sram_bits_set(pe, MVPP2_PRS_SRAM_UDF_SIGN_BIT, 1);\n\t\toffset = 0 - offset;\n\t} else {\n\t\tmvpp2_prs_sram_bits_clear(pe, MVPP2_PRS_SRAM_UDF_SIGN_BIT, 1);\n\t}\n\n\t \n\tmvpp2_prs_sram_bits_clear(pe, MVPP2_PRS_SRAM_UDF_OFFS,\n\t\t\t\t  MVPP2_PRS_SRAM_UDF_MASK);\n\tmvpp2_prs_sram_bits_set(pe, MVPP2_PRS_SRAM_UDF_OFFS,\n\t\t\t\toffset & MVPP2_PRS_SRAM_UDF_MASK);\n\n\t \n\tmvpp2_prs_sram_bits_clear(pe, MVPP2_PRS_SRAM_UDF_TYPE_OFFS,\n\t\t\t\t  MVPP2_PRS_SRAM_UDF_TYPE_MASK);\n\tmvpp2_prs_sram_bits_set(pe, MVPP2_PRS_SRAM_UDF_TYPE_OFFS, type);\n\n\t \n\tmvpp2_prs_sram_bits_clear(pe, MVPP2_PRS_SRAM_OP_SEL_UDF_OFFS,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_MASK);\n\tmvpp2_prs_sram_bits_set(pe, MVPP2_PRS_SRAM_OP_SEL_UDF_OFFS,\n\t\t\t\top & MVPP2_PRS_SRAM_OP_SEL_UDF_MASK);\n\n\t \n\tmvpp2_prs_sram_bits_clear(pe, MVPP2_PRS_SRAM_OP_SEL_BASE_OFFS, 1);\n}\n\n \nstatic int mvpp2_prs_flow_find(struct mvpp2 *priv, int flow)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid;\n\n\t \n\tfor (tid = MVPP2_PRS_TCAM_SRAM_SIZE - 1; tid >= 0; tid--) {\n\t\tu8 bits;\n\n\t\tif (!priv->prs_shadow[tid].valid ||\n\t\t    priv->prs_shadow[tid].lu != MVPP2_PRS_LU_FLOWS)\n\t\t\tcontinue;\n\n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\t\tbits = mvpp2_prs_sram_ai_get(&pe);\n\n\t\t \n\t\tif ((bits & MVPP2_PRS_FLOW_ID_MASK) == flow)\n\t\t\treturn tid;\n\t}\n\n\treturn -ENOENT;\n}\n\n \nstatic int mvpp2_prs_tcam_first_free(struct mvpp2 *priv, unsigned char start,\n\t\t\t\t     unsigned char end)\n{\n\tint tid;\n\n\tif (start > end)\n\t\tswap(start, end);\n\n\tfor (tid = start; tid <= end; tid++) {\n\t\tif (!priv->prs_shadow[tid].valid)\n\t\t\treturn tid;\n\t}\n\n\treturn -EINVAL;\n}\n\n \nstatic void mvpp2_prs_drop_fc(struct mvpp2 *priv)\n{\n\tunsigned char da[ETH_ALEN] = { 0x01, 0x80, 0xC2, 0x00, 0x00, 0x01 };\n\tstruct mvpp2_prs_entry pe;\n\tunsigned int len;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\t \n\tpe.index = MVPP2_PE_FC_DROP;\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_MAC);\n\n\t \n\tlen = ETH_ALEN;\n\twhile (len--)\n\t\tmvpp2_prs_tcam_data_byte_set(&pe, len, da[len], 0xff);\n\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_DROP_MASK,\n\t\t\t\t MVPP2_PRS_RI_DROP_MASK);\n\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_MAC);\n\tmvpp2_prs_hw_write(priv, &pe);\n}\n\n \nstatic void mvpp2_prs_mac_drop_all_set(struct mvpp2 *priv, int port, bool add)\n{\n\tstruct mvpp2_prs_entry pe;\n\n\tif (priv->prs_shadow[MVPP2_PE_DROP_ALL].valid) {\n\t\t \n\t\tmvpp2_prs_init_from_hw(priv, &pe, MVPP2_PE_DROP_ALL);\n\t} else {\n\t\t \n\t\tmemset(&pe, 0, sizeof(pe));\n\t\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_MAC);\n\t\tpe.index = MVPP2_PE_DROP_ALL;\n\n\t\t \n\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_DROP_MASK,\n\t\t\t\t\t MVPP2_PRS_RI_DROP_MASK);\n\n\t\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\t\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\n\t\t \n\t\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_MAC);\n\n\t\t \n\t\tmvpp2_prs_tcam_port_map_set(&pe, 0);\n\t}\n\n\t \n\tmvpp2_prs_tcam_port_set(&pe, port, add);\n\n\tmvpp2_prs_hw_write(priv, &pe);\n}\n\n \nvoid mvpp2_prs_mac_promisc_set(struct mvpp2 *priv, int port,\n\t\t\t       enum mvpp2_prs_l2_cast l2_cast, bool add)\n{\n\tstruct mvpp2_prs_entry pe;\n\tunsigned char cast_match;\n\tunsigned int ri;\n\tint tid;\n\n\tif (l2_cast == MVPP2_PRS_L2_UNI_CAST) {\n\t\tcast_match = MVPP2_PRS_UCAST_VAL;\n\t\ttid = MVPP2_PE_MAC_UC_PROMISCUOUS;\n\t\tri = MVPP2_PRS_RI_L2_UCAST;\n\t} else {\n\t\tcast_match = MVPP2_PRS_MCAST_VAL;\n\t\ttid = MVPP2_PE_MAC_MC_PROMISCUOUS;\n\t\tri = MVPP2_PRS_RI_L2_MCAST;\n\t}\n\n\t \n\tif (priv->prs_shadow[tid].valid) {\n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\t} else {\n\t\tmemset(&pe, 0, sizeof(pe));\n\t\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_MAC);\n\t\tpe.index = tid;\n\n\t\t \n\t\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_DSA);\n\n\t\t \n\t\tmvpp2_prs_sram_ri_update(&pe, ri, MVPP2_PRS_RI_L2_CAST_MASK);\n\n\t\t \n\t\tmvpp2_prs_tcam_data_byte_set(&pe, 0, cast_match,\n\t\t\t\t\t     MVPP2_PRS_CAST_MASK);\n\n\t\t \n\t\tmvpp2_prs_sram_shift_set(&pe, 2 * ETH_ALEN,\n\t\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\t\t \n\t\tmvpp2_prs_tcam_port_map_set(&pe, 0);\n\n\t\t \n\t\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_MAC);\n\t}\n\n\t \n\tmvpp2_prs_tcam_port_set(&pe, port, add);\n\n\tmvpp2_prs_hw_write(priv, &pe);\n}\n\n \nstatic void mvpp2_prs_dsa_tag_set(struct mvpp2 *priv, int port, bool add,\n\t\t\t\t  bool tagged, bool extend)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid, shift;\n\n\tif (extend) {\n\t\ttid = tagged ? MVPP2_PE_EDSA_TAGGED : MVPP2_PE_EDSA_UNTAGGED;\n\t\tshift = 8;\n\t} else {\n\t\ttid = tagged ? MVPP2_PE_DSA_TAGGED : MVPP2_PE_DSA_UNTAGGED;\n\t\tshift = 4;\n\t}\n\n\tif (priv->prs_shadow[tid].valid) {\n\t\t \n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\t} else {\n\t\t \n\t\tmemset(&pe, 0, sizeof(pe));\n\t\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_DSA);\n\t\tpe.index = tid;\n\n\t\t \n\t\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_DSA);\n\n\t\tif (tagged) {\n\t\t\t \n\t\t\tmvpp2_prs_tcam_data_byte_set(&pe, 0,\n\t\t\t\t\t     MVPP2_PRS_TCAM_DSA_TAGGED_BIT,\n\t\t\t\t\t     MVPP2_PRS_TCAM_DSA_TAGGED_BIT);\n\n\t\t\t \n\t\t\tif (extend)\n\t\t\t\tmvpp2_prs_sram_ai_update(&pe, 1,\n\t\t\t\t\t\t\tMVPP2_PRS_SRAM_AI_MASK);\n\t\t\telse\n\t\t\t\tmvpp2_prs_sram_ai_update(&pe, 0,\n\t\t\t\t\t\t\tMVPP2_PRS_SRAM_AI_MASK);\n\n\t\t\t \n\t\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_VLAN_SINGLE,\n\t\t\t\t\t\t MVPP2_PRS_RI_VLAN_MASK);\n\t\t\t \n\t\t\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_VID);\n\t\t} else {\n\t\t\t \n\t\t\tmvpp2_prs_sram_shift_set(&pe, shift,\n\t\t\t\t\tMVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\t\t\t \n\t\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_VLAN_NONE,\n\t\t\t\t\t\t MVPP2_PRS_RI_VLAN_MASK);\n\t\t\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_L2);\n\t\t}\n\n\t\t \n\t\tmvpp2_prs_tcam_port_map_set(&pe, 0);\n\t}\n\n\t \n\tmvpp2_prs_tcam_port_set(&pe, port, add);\n\n\tmvpp2_prs_hw_write(priv, &pe);\n}\n\n \nstatic void mvpp2_prs_dsa_tag_ethertype_set(struct mvpp2 *priv, int port,\n\t\t\t\t\t    bool add, bool tagged, bool extend)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid, shift, port_mask;\n\n\tif (extend) {\n\t\ttid = tagged ? MVPP2_PE_ETYPE_EDSA_TAGGED :\n\t\t      MVPP2_PE_ETYPE_EDSA_UNTAGGED;\n\t\tport_mask = 0;\n\t\tshift = 8;\n\t} else {\n\t\ttid = tagged ? MVPP2_PE_ETYPE_DSA_TAGGED :\n\t\t      MVPP2_PE_ETYPE_DSA_UNTAGGED;\n\t\tport_mask = MVPP2_PRS_PORT_MASK;\n\t\tshift = 4;\n\t}\n\n\tif (priv->prs_shadow[tid].valid) {\n\t\t \n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\t} else {\n\t\t \n\t\tmemset(&pe, 0, sizeof(pe));\n\t\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_DSA);\n\t\tpe.index = tid;\n\n\t\t \n\t\tmvpp2_prs_match_etype(&pe, 0, ETH_P_EDSA);\n\t\tmvpp2_prs_match_etype(&pe, 2, 0);\n\n\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_DSA_MASK,\n\t\t\t\t\t MVPP2_PRS_RI_DSA_MASK);\n\t\t \n\t\tmvpp2_prs_sram_shift_set(&pe, 2 + MVPP2_ETH_TYPE_LEN + shift,\n\t\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\t\t \n\t\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_DSA);\n\n\t\tif (tagged) {\n\t\t\t \n\t\t\tmvpp2_prs_tcam_data_byte_set(&pe,\n\t\t\t\t\t\t     MVPP2_ETH_TYPE_LEN + 2 + 3,\n\t\t\t\t\t\t MVPP2_PRS_TCAM_DSA_TAGGED_BIT,\n\t\t\t\t\t\t MVPP2_PRS_TCAM_DSA_TAGGED_BIT);\n\t\t\t \n\t\t\tmvpp2_prs_sram_ai_update(&pe, 0,\n\t\t\t\t\t\t MVPP2_PRS_SRAM_AI_MASK);\n\t\t\t \n\t\t\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_VLAN);\n\t\t} else {\n\t\t\t \n\t\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_VLAN_NONE,\n\t\t\t\t\t\t MVPP2_PRS_RI_VLAN_MASK);\n\t\t\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_L2);\n\t\t}\n\t\t \n\t\tmvpp2_prs_tcam_port_map_set(&pe, port_mask);\n\t}\n\n\t \n\tmvpp2_prs_tcam_port_set(&pe, port, add);\n\n\tmvpp2_prs_hw_write(priv, &pe);\n}\n\n \nstatic int mvpp2_prs_vlan_find(struct mvpp2 *priv, unsigned short tpid, int ai)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid;\n\n\t \n\tfor (tid = MVPP2_PE_FIRST_FREE_TID;\n\t     tid <= MVPP2_PE_LAST_FREE_TID; tid++) {\n\t\tunsigned int ri_bits, ai_bits;\n\t\tbool match;\n\n\t\tif (!priv->prs_shadow[tid].valid ||\n\t\t    priv->prs_shadow[tid].lu != MVPP2_PRS_LU_VLAN)\n\t\t\tcontinue;\n\n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\t\tmatch = mvpp2_prs_tcam_data_cmp(&pe, 0, tpid);\n\t\tif (!match)\n\t\t\tcontinue;\n\n\t\t \n\t\tri_bits = mvpp2_prs_sram_ri_get(&pe);\n\t\tri_bits &= MVPP2_PRS_RI_VLAN_MASK;\n\n\t\t \n\t\tai_bits = mvpp2_prs_tcam_ai_get(&pe);\n\t\t \n\t\tai_bits &= ~MVPP2_PRS_DBL_VLAN_AI_BIT;\n\n\t\tif (ai != ai_bits)\n\t\t\tcontinue;\n\n\t\tif (ri_bits == MVPP2_PRS_RI_VLAN_SINGLE ||\n\t\t    ri_bits == MVPP2_PRS_RI_VLAN_TRIPLE)\n\t\t\treturn tid;\n\t}\n\n\treturn -ENOENT;\n}\n\n \nstatic int mvpp2_prs_vlan_add(struct mvpp2 *priv, unsigned short tpid, int ai,\n\t\t\t      unsigned int port_map)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid_aux, tid;\n\tint ret = 0;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\ttid = mvpp2_prs_vlan_find(priv, tpid, ai);\n\n\tif (tid < 0) {\n\t\t \n\t\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_LAST_FREE_TID,\n\t\t\t\t\t\tMVPP2_PE_FIRST_FREE_TID);\n\t\tif (tid < 0)\n\t\t\treturn tid;\n\n\t\t \n\t\tfor (tid_aux = MVPP2_PE_LAST_FREE_TID;\n\t\t     tid_aux >= MVPP2_PE_FIRST_FREE_TID; tid_aux--) {\n\t\t\tunsigned int ri_bits;\n\n\t\t\tif (!priv->prs_shadow[tid_aux].valid ||\n\t\t\t    priv->prs_shadow[tid_aux].lu != MVPP2_PRS_LU_VLAN)\n\t\t\t\tcontinue;\n\n\t\t\tmvpp2_prs_init_from_hw(priv, &pe, tid_aux);\n\t\t\tri_bits = mvpp2_prs_sram_ri_get(&pe);\n\t\t\tif ((ri_bits & MVPP2_PRS_RI_VLAN_MASK) ==\n\t\t\t    MVPP2_PRS_RI_VLAN_DOUBLE)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (tid <= tid_aux)\n\t\t\treturn -EINVAL;\n\n\t\tmemset(&pe, 0, sizeof(pe));\n\t\tpe.index = tid;\n\t\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_VLAN);\n\n\t\tmvpp2_prs_match_etype(&pe, 0, tpid);\n\n\t\t \n\t\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_VID);\n\n\t\t \n\t\tmvpp2_prs_sram_ai_update(&pe, 0, MVPP2_PRS_SRAM_AI_MASK);\n\n\t\tif (ai == MVPP2_PRS_SINGLE_VLAN_AI) {\n\t\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_VLAN_SINGLE,\n\t\t\t\t\t\t MVPP2_PRS_RI_VLAN_MASK);\n\t\t} else {\n\t\t\tai |= MVPP2_PRS_DBL_VLAN_AI_BIT;\n\t\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_VLAN_TRIPLE,\n\t\t\t\t\t\t MVPP2_PRS_RI_VLAN_MASK);\n\t\t}\n\t\tmvpp2_prs_tcam_ai_update(&pe, ai, MVPP2_PRS_SRAM_AI_MASK);\n\n\t\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_VLAN);\n\t} else {\n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\t}\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, port_map);\n\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn ret;\n}\n\n \nstatic int mvpp2_prs_double_vlan_ai_free_get(struct mvpp2 *priv)\n{\n\tint i;\n\n\tfor (i = 1; i < MVPP2_PRS_DBL_VLANS_MAX; i++) {\n\t\tif (!priv->prs_double_vlans[i])\n\t\t\treturn i;\n\t}\n\n\treturn -EINVAL;\n}\n\n \nstatic int mvpp2_prs_double_vlan_find(struct mvpp2 *priv, unsigned short tpid1,\n\t\t\t\t      unsigned short tpid2)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid;\n\n\t \n\tfor (tid = MVPP2_PE_FIRST_FREE_TID;\n\t     tid <= MVPP2_PE_LAST_FREE_TID; tid++) {\n\t\tunsigned int ri_mask;\n\t\tbool match;\n\n\t\tif (!priv->prs_shadow[tid].valid ||\n\t\t    priv->prs_shadow[tid].lu != MVPP2_PRS_LU_VLAN)\n\t\t\tcontinue;\n\n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\n\t\tmatch = mvpp2_prs_tcam_data_cmp(&pe, 0, tpid1) &&\n\t\t\tmvpp2_prs_tcam_data_cmp(&pe, 4, tpid2);\n\n\t\tif (!match)\n\t\t\tcontinue;\n\n\t\tri_mask = mvpp2_prs_sram_ri_get(&pe) & MVPP2_PRS_RI_VLAN_MASK;\n\t\tif (ri_mask == MVPP2_PRS_RI_VLAN_DOUBLE)\n\t\t\treturn tid;\n\t}\n\n\treturn -ENOENT;\n}\n\n \nstatic int mvpp2_prs_double_vlan_add(struct mvpp2 *priv, unsigned short tpid1,\n\t\t\t\t     unsigned short tpid2,\n\t\t\t\t     unsigned int port_map)\n{\n\tint tid_aux, tid, ai, ret = 0;\n\tstruct mvpp2_prs_entry pe;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\ttid = mvpp2_prs_double_vlan_find(priv, tpid1, tpid2);\n\n\tif (tid < 0) {\n\t\t \n\t\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\t\tif (tid < 0)\n\t\t\treturn tid;\n\n\t\t \n\t\tai = mvpp2_prs_double_vlan_ai_free_get(priv);\n\t\tif (ai < 0)\n\t\t\treturn ai;\n\n\t\t \n\t\tfor (tid_aux = MVPP2_PE_FIRST_FREE_TID;\n\t\t     tid_aux <= MVPP2_PE_LAST_FREE_TID; tid_aux++) {\n\t\t\tunsigned int ri_bits;\n\n\t\t\tif (!priv->prs_shadow[tid_aux].valid ||\n\t\t\t    priv->prs_shadow[tid_aux].lu != MVPP2_PRS_LU_VLAN)\n\t\t\t\tcontinue;\n\n\t\t\tmvpp2_prs_init_from_hw(priv, &pe, tid_aux);\n\t\t\tri_bits = mvpp2_prs_sram_ri_get(&pe);\n\t\t\tri_bits &= MVPP2_PRS_RI_VLAN_MASK;\n\t\t\tif (ri_bits == MVPP2_PRS_RI_VLAN_SINGLE ||\n\t\t\t    ri_bits == MVPP2_PRS_RI_VLAN_TRIPLE)\n\t\t\t\tbreak;\n\t\t}\n\n\t\tif (tid >= tid_aux)\n\t\t\treturn -ERANGE;\n\n\t\tmemset(&pe, 0, sizeof(pe));\n\t\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_VLAN);\n\t\tpe.index = tid;\n\n\t\tpriv->prs_double_vlans[ai] = true;\n\n\t\tmvpp2_prs_match_etype(&pe, 0, tpid1);\n\t\tmvpp2_prs_match_etype(&pe, 4, tpid2);\n\n\t\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_VLAN);\n\t\t \n\t\tmvpp2_prs_sram_shift_set(&pe, MVPP2_VLAN_TAG_LEN,\n\t\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_VLAN_DOUBLE,\n\t\t\t\t\t MVPP2_PRS_RI_VLAN_MASK);\n\t\tmvpp2_prs_sram_ai_update(&pe, ai | MVPP2_PRS_DBL_VLAN_AI_BIT,\n\t\t\t\t\t MVPP2_PRS_SRAM_AI_MASK);\n\n\t\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_VLAN);\n\t} else {\n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\t}\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, port_map);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn ret;\n}\n\n \nstatic int mvpp2_prs_ip4_proto(struct mvpp2 *priv, unsigned short proto,\n\t\t\t       unsigned int ri, unsigned int ri_mask)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid;\n\n\tif ((proto != IPPROTO_TCP) && (proto != IPPROTO_UDP) &&\n\t    (proto != IPPROTO_IGMP))\n\t\treturn -EINVAL;\n\n\t \n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_IP4);\n\tpe.index = tid;\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\n\t \n\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L3, -4,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\tmvpp2_prs_sram_ai_update(&pe, 0, MVPP2_PRS_IPV4_DIP_AI_BIT);\n\tmvpp2_prs_sram_ri_update(&pe, ri, ri_mask | MVPP2_PRS_RI_IP_FRAG_MASK);\n\n\tmvpp2_prs_tcam_data_byte_set(&pe, 2, 0x00,\n\t\t\t\t     MVPP2_PRS_TCAM_PROTO_MASK_L);\n\tmvpp2_prs_tcam_data_byte_set(&pe, 3, 0x00,\n\t\t\t\t     MVPP2_PRS_TCAM_PROTO_MASK);\n\n\tmvpp2_prs_tcam_data_byte_set(&pe, 5, proto, MVPP2_PRS_TCAM_PROTO_MASK);\n\tmvpp2_prs_tcam_ai_update(&pe, MVPP2_PRS_IPV4_DIP_AI_BIT,\n\t\t\t\t MVPP2_PRS_IPV4_DIP_AI_BIT);\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP4);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tpe.index = tid;\n\t \n\tpe.sram[MVPP2_PRS_SRAM_RI_WORD] = 0x0;\n\tpe.sram[MVPP2_PRS_SRAM_RI_CTRL_WORD] = 0x0;\n\tmvpp2_prs_sram_ri_update(&pe, ri, ri_mask);\n\n\tmvpp2_prs_sram_ri_update(&pe, ri | MVPP2_PRS_RI_IP_FRAG_TRUE,\n\t\t\t\t ri_mask | MVPP2_PRS_RI_IP_FRAG_MASK);\n\n\tmvpp2_prs_tcam_data_byte_set(&pe, 2, 0x00, 0x0);\n\tmvpp2_prs_tcam_data_byte_set(&pe, 3, 0x00, 0x0);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP4);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nstatic int mvpp2_prs_ip4_cast(struct mvpp2 *priv, unsigned short l3_cast)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint mask, tid;\n\n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_IP4);\n\tpe.index = tid;\n\n\tswitch (l3_cast) {\n\tcase MVPP2_PRS_L3_MULTI_CAST:\n\t\tmvpp2_prs_tcam_data_byte_set(&pe, 0, MVPP2_PRS_IPV4_MC,\n\t\t\t\t\t     MVPP2_PRS_IPV4_MC_MASK);\n\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_MCAST,\n\t\t\t\t\t MVPP2_PRS_RI_L3_ADDR_MASK);\n\t\tbreak;\n\tcase  MVPP2_PRS_L3_BROAD_CAST:\n\t\tmask = MVPP2_PRS_IPV4_BC_MASK;\n\t\tmvpp2_prs_tcam_data_byte_set(&pe, 0, mask, mask);\n\t\tmvpp2_prs_tcam_data_byte_set(&pe, 1, mask, mask);\n\t\tmvpp2_prs_tcam_data_byte_set(&pe, 2, mask, mask);\n\t\tmvpp2_prs_tcam_data_byte_set(&pe, 3, mask, mask);\n\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_BCAST,\n\t\t\t\t\t MVPP2_PRS_RI_L3_ADDR_MASK);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_IP4);\n\n\tmvpp2_prs_sram_ai_update(&pe, MVPP2_PRS_IPV4_DIP_AI_BIT,\n\t\t\t\t MVPP2_PRS_IPV4_DIP_AI_BIT);\n\n\t \n\tmvpp2_prs_sram_shift_set(&pe, -12, MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\tmvpp2_prs_tcam_ai_update(&pe, 0, MVPP2_PRS_IPV4_DIP_AI_BIT);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP4);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nstatic int mvpp2_prs_ip6_proto(struct mvpp2 *priv, unsigned short proto,\n\t\t\t       unsigned int ri, unsigned int ri_mask)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid;\n\n\tif ((proto != IPPROTO_TCP) && (proto != IPPROTO_UDP) &&\n\t    (proto != IPPROTO_ICMPV6) && (proto != IPPROTO_IPIP))\n\t\treturn -EINVAL;\n\n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_IP6);\n\tpe.index = tid;\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\tmvpp2_prs_sram_ri_update(&pe, ri, ri_mask);\n\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L4,\n\t\t\t\t  sizeof(struct ipv6hdr) - 6,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\n\tmvpp2_prs_tcam_data_byte_set(&pe, 0, proto, MVPP2_PRS_TCAM_PROTO_MASK);\n\tmvpp2_prs_tcam_ai_update(&pe, MVPP2_PRS_IPV6_NO_EXT_AI_BIT,\n\t\t\t\t MVPP2_PRS_IPV6_NO_EXT_AI_BIT);\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP6);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nstatic int mvpp2_prs_ip6_cast(struct mvpp2 *priv, unsigned short l3_cast)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid;\n\n\tif (l3_cast != MVPP2_PRS_L3_MULTI_CAST)\n\t\treturn -EINVAL;\n\n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_IP6);\n\tpe.index = tid;\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_IP6);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_MCAST,\n\t\t\t\t MVPP2_PRS_RI_L3_ADDR_MASK);\n\tmvpp2_prs_sram_ai_update(&pe, MVPP2_PRS_IPV6_NO_EXT_AI_BIT,\n\t\t\t\t MVPP2_PRS_IPV6_NO_EXT_AI_BIT);\n\t \n\tmvpp2_prs_sram_shift_set(&pe, -18, MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\tmvpp2_prs_tcam_data_byte_set(&pe, 0, MVPP2_PRS_IPV6_MC,\n\t\t\t\t     MVPP2_PRS_IPV6_MC_MASK);\n\tmvpp2_prs_tcam_ai_update(&pe, 0, MVPP2_PRS_IPV6_NO_EXT_AI_BIT);\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP6);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nstatic void mvpp2_prs_hw_port_init(struct mvpp2 *priv, int port, int lu_first,\n\t\t\t\t   int lu_max, int offset)\n{\n\tu32 val;\n\n\t \n\tval = mvpp2_read(priv, MVPP2_PRS_INIT_LOOKUP_REG);\n\tval &= ~MVPP2_PRS_PORT_LU_MASK(port);\n\tval |=  MVPP2_PRS_PORT_LU_VAL(port, lu_first);\n\tmvpp2_write(priv, MVPP2_PRS_INIT_LOOKUP_REG, val);\n\n\t \n\tval = mvpp2_read(priv, MVPP2_PRS_MAX_LOOP_REG(port));\n\tval &= ~MVPP2_PRS_MAX_LOOP_MASK(port);\n\tval |= MVPP2_PRS_MAX_LOOP_VAL(port, lu_max);\n\tmvpp2_write(priv, MVPP2_PRS_MAX_LOOP_REG(port), val);\n\n\t \n\tval = mvpp2_read(priv, MVPP2_PRS_INIT_OFFS_REG(port));\n\tval &= ~MVPP2_PRS_INIT_OFF_MASK(port);\n\tval |= MVPP2_PRS_INIT_OFF_VAL(port, offset);\n\tmvpp2_write(priv, MVPP2_PRS_INIT_OFFS_REG(port), val);\n}\n\n \nstatic void mvpp2_prs_def_flow_init(struct mvpp2 *priv)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint port;\n\n\tfor (port = 0; port < MVPP2_MAX_PORTS; port++) {\n\t\tmemset(&pe, 0, sizeof(pe));\n\t\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\t\tpe.index = MVPP2_PE_FIRST_DEFAULT_FLOW - port;\n\n\t\t \n\t\tmvpp2_prs_tcam_port_map_set(&pe, 0);\n\n\t\t \n\t\tmvpp2_prs_sram_ai_update(&pe, port, MVPP2_PRS_FLOW_ID_MASK);\n\t\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_DONE_BIT, 1);\n\n\t\t \n\t\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_FLOWS);\n\t\tmvpp2_prs_hw_write(priv, &pe);\n\t}\n}\n\n \nstatic void mvpp2_prs_mh_init(struct mvpp2 *priv)\n{\n\tstruct mvpp2_prs_entry pe;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\tpe.index = MVPP2_PE_MH_DEFAULT;\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_MH);\n\tmvpp2_prs_sram_shift_set(&pe, MVPP2_MH_SIZE,\n\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_MAC);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_MH);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\tpe.index = MVPP2_PE_MH_SKIP_PRS;\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_MH);\n\tmvpp2_prs_sram_shift_set(&pe, MVPP2_MH_SIZE,\n\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, 0);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_MH);\n\tmvpp2_prs_hw_write(priv, &pe);\n}\n\n \nstatic void mvpp2_prs_mac_init(struct mvpp2 *priv)\n{\n\tstruct mvpp2_prs_entry pe;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\t \n\tpe.index = MVPP2_PE_MAC_NON_PROMISCUOUS;\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_MAC);\n\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_DROP_MASK,\n\t\t\t\t MVPP2_PRS_RI_DROP_MASK);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_MAC);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\tmvpp2_prs_drop_fc(priv);\n\tmvpp2_prs_mac_drop_all_set(priv, 0, false);\n\tmvpp2_prs_mac_promisc_set(priv, 0, MVPP2_PRS_L2_UNI_CAST, false);\n\tmvpp2_prs_mac_promisc_set(priv, 0, MVPP2_PRS_L2_MULTI_CAST, false);\n}\n\n \nstatic void mvpp2_prs_dsa_init(struct mvpp2 *priv)\n{\n\tstruct mvpp2_prs_entry pe;\n\n\t \n\tmvpp2_prs_dsa_tag_set(priv, 0, false, MVPP2_PRS_UNTAGGED,\n\t\t\t      MVPP2_PRS_EDSA);\n\n\t \n\tmvpp2_prs_dsa_tag_set(priv, 0, false, MVPP2_PRS_TAGGED, MVPP2_PRS_EDSA);\n\n\t \n\tmvpp2_prs_dsa_tag_set(priv, 0, false, MVPP2_PRS_UNTAGGED,\n\t\t\t      MVPP2_PRS_DSA);\n\n\t \n\tmvpp2_prs_dsa_tag_set(priv, 0, false, MVPP2_PRS_TAGGED, MVPP2_PRS_DSA);\n\n\t \n\tmvpp2_prs_dsa_tag_ethertype_set(priv, 0, false,\n\t\t\t\t\tMVPP2_PRS_UNTAGGED, MVPP2_PRS_EDSA);\n\n\t \n\tmvpp2_prs_dsa_tag_ethertype_set(priv, 0, false,\n\t\t\t\t\tMVPP2_PRS_TAGGED, MVPP2_PRS_EDSA);\n\n\t \n\tmvpp2_prs_dsa_tag_ethertype_set(priv, 0, true,\n\t\t\t\t\tMVPP2_PRS_UNTAGGED, MVPP2_PRS_DSA);\n\n\t \n\tmvpp2_prs_dsa_tag_ethertype_set(priv, 0, true,\n\t\t\t\t\tMVPP2_PRS_TAGGED, MVPP2_PRS_DSA);\n\n\t \n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_DSA);\n\tpe.index = MVPP2_PE_DSA_DEFAULT;\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_VLAN);\n\n\t \n\tmvpp2_prs_sram_shift_set(&pe, 0, MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_MAC);\n\n\t \n\tmvpp2_prs_sram_ai_update(&pe, 0, MVPP2_PRS_SRAM_AI_MASK);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\tmvpp2_prs_hw_write(priv, &pe);\n}\n\n \nstatic void mvpp2_prs_vid_init(struct mvpp2 *priv)\n{\n\tstruct mvpp2_prs_entry pe;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\t \n\tpe.index = MVPP2_PE_VID_FLTR_DEFAULT;\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_VID);\n\n\tmvpp2_prs_tcam_ai_update(&pe, 0, MVPP2_PRS_EDSA_VID_AI_BIT);\n\n\t \n\tmvpp2_prs_sram_shift_set(&pe, MVPP2_VLAN_TAG_LEN,\n\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\t \n\tmvpp2_prs_sram_ai_update(&pe, 0, MVPP2_PRS_SRAM_AI_MASK);\n\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_L2);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_VID);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\tmemset(&pe, 0, sizeof(pe));\n\n\t \n\tpe.index = MVPP2_PE_VID_EDSA_FLTR_DEFAULT;\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_VID);\n\n\tmvpp2_prs_tcam_ai_update(&pe, MVPP2_PRS_EDSA_VID_AI_BIT,\n\t\t\t\t MVPP2_PRS_EDSA_VID_AI_BIT);\n\n\t \n\tmvpp2_prs_sram_shift_set(&pe, MVPP2_VLAN_TAG_EDSA_LEN,\n\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\t \n\tmvpp2_prs_sram_ai_update(&pe, 0, MVPP2_PRS_SRAM_AI_MASK);\n\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_L2);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_VID);\n\tmvpp2_prs_hw_write(priv, &pe);\n}\n\n \nstatic int mvpp2_prs_etype_init(struct mvpp2 *priv)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid, ihl;\n\n\t \n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_L2);\n\tpe.index = tid;\n\n\tmvpp2_prs_match_etype(&pe, 0, ETH_P_PPP_SES);\n\n\tmvpp2_prs_sram_shift_set(&pe, MVPP2_PPPOE_HDR_SIZE,\n\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_PPPOE);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_PPPOE_MASK,\n\t\t\t\t MVPP2_PRS_RI_PPPOE_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_L2);\n\tpriv->prs_shadow[pe.index].udf = MVPP2_PRS_UDF_L2_DEF;\n\tpriv->prs_shadow[pe.index].finish = false;\n\tmvpp2_prs_shadow_ri_set(priv, pe.index, MVPP2_PRS_RI_PPPOE_MASK,\n\t\t\t\tMVPP2_PRS_RI_PPPOE_MASK);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_L2);\n\tpe.index = tid;\n\n\tmvpp2_prs_match_etype(&pe, 0, ETH_P_ARP);\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_ARP,\n\t\t\t\t MVPP2_PRS_RI_L3_PROTO_MASK);\n\t \n\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L3,\n\t\t\t\t  MVPP2_ETH_TYPE_LEN,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_L2);\n\tpriv->prs_shadow[pe.index].udf = MVPP2_PRS_UDF_L2_DEF;\n\tpriv->prs_shadow[pe.index].finish = true;\n\tmvpp2_prs_shadow_ri_set(priv, pe.index, MVPP2_PRS_RI_L3_ARP,\n\t\t\t\tMVPP2_PRS_RI_L3_PROTO_MASK);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_L2);\n\tpe.index = tid;\n\n\tmvpp2_prs_match_etype(&pe, 0, MVPP2_IP_LBDT_TYPE);\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_CPU_CODE_RX_SPEC |\n\t\t\t\t MVPP2_PRS_RI_UDF3_RX_SPECIAL,\n\t\t\t\t MVPP2_PRS_RI_CPU_CODE_MASK |\n\t\t\t\t MVPP2_PRS_RI_UDF3_MASK);\n\t \n\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L3,\n\t\t\t\t  MVPP2_ETH_TYPE_LEN,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_L2);\n\tpriv->prs_shadow[pe.index].udf = MVPP2_PRS_UDF_L2_DEF;\n\tpriv->prs_shadow[pe.index].finish = true;\n\tmvpp2_prs_shadow_ri_set(priv, pe.index, MVPP2_PRS_RI_CPU_CODE_RX_SPEC |\n\t\t\t\tMVPP2_PRS_RI_UDF3_RX_SPECIAL,\n\t\t\t\tMVPP2_PRS_RI_CPU_CODE_MASK |\n\t\t\t\tMVPP2_PRS_RI_UDF3_MASK);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\tfor (ihl = MVPP2_PRS_IPV4_IHL_MIN; ihl <= MVPP2_PRS_IPV4_IHL_MAX; ihl++) {\n\t\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\t\tif (tid < 0)\n\t\t\treturn tid;\n\n\t\tmemset(&pe, 0, sizeof(pe));\n\t\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_L2);\n\t\tpe.index = tid;\n\n\t\tmvpp2_prs_match_etype(&pe, 0, ETH_P_IP);\n\t\tmvpp2_prs_tcam_data_byte_set(&pe, MVPP2_ETH_TYPE_LEN,\n\t\t\t\t\t     MVPP2_PRS_IPV4_HEAD | ihl,\n\t\t\t\t\t     MVPP2_PRS_IPV4_HEAD_MASK |\n\t\t\t\t\t     MVPP2_PRS_IPV4_IHL_MASK);\n\n\t\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_IP4);\n\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_IP4,\n\t\t\t\t\t MVPP2_PRS_RI_L3_PROTO_MASK);\n\t\t \n\t\tmvpp2_prs_sram_shift_set(&pe, MVPP2_ETH_TYPE_LEN +\n\t\t\t\t\t sizeof(struct iphdr) - 4,\n\t\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\t\t \n\t\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L4,\n\t\t\t\t\t  MVPP2_ETH_TYPE_LEN + (ihl * 4),\n\t\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\n\t\t \n\t\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_L2);\n\t\tpriv->prs_shadow[pe.index].udf = MVPP2_PRS_UDF_L2_DEF;\n\t\tpriv->prs_shadow[pe.index].finish = false;\n\t\tmvpp2_prs_shadow_ri_set(priv, pe.index, MVPP2_PRS_RI_L3_IP4,\n\t\t\t\t\tMVPP2_PRS_RI_L3_PROTO_MASK);\n\t\tmvpp2_prs_hw_write(priv, &pe);\n\t}\n\n\t \n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_L2);\n\tpe.index = tid;\n\n\tmvpp2_prs_match_etype(&pe, 0, ETH_P_IPV6);\n\n\t \n\tmvpp2_prs_sram_shift_set(&pe, MVPP2_ETH_TYPE_LEN + 8 +\n\t\t\t\t MVPP2_MAX_L3_ADDR_SIZE,\n\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_IP6);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_IP6,\n\t\t\t\t MVPP2_PRS_RI_L3_PROTO_MASK);\n\t \n\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L3,\n\t\t\t\t  MVPP2_ETH_TYPE_LEN,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_L2);\n\tpriv->prs_shadow[pe.index].udf = MVPP2_PRS_UDF_L2_DEF;\n\tpriv->prs_shadow[pe.index].finish = false;\n\tmvpp2_prs_shadow_ri_set(priv, pe.index, MVPP2_PRS_RI_L3_IP6,\n\t\t\t\tMVPP2_PRS_RI_L3_PROTO_MASK);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\tmemset(&pe, 0, sizeof(struct mvpp2_prs_entry));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_L2);\n\tpe.index = MVPP2_PE_ETH_TYPE_UN;\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_UN,\n\t\t\t\t MVPP2_PRS_RI_L3_PROTO_MASK);\n\t \n\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L3,\n\t\t\t\t  MVPP2_ETH_TYPE_LEN,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_L2);\n\tpriv->prs_shadow[pe.index].udf = MVPP2_PRS_UDF_L2_DEF;\n\tpriv->prs_shadow[pe.index].finish = true;\n\tmvpp2_prs_shadow_ri_set(priv, pe.index, MVPP2_PRS_RI_L3_UN,\n\t\t\t\tMVPP2_PRS_RI_L3_PROTO_MASK);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nstatic int mvpp2_prs_vlan_init(struct platform_device *pdev, struct mvpp2 *priv)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint err;\n\n\tpriv->prs_double_vlans = devm_kcalloc(&pdev->dev, sizeof(bool),\n\t\t\t\t\t      MVPP2_PRS_DBL_VLANS_MAX,\n\t\t\t\t\t      GFP_KERNEL);\n\tif (!priv->prs_double_vlans)\n\t\treturn -ENOMEM;\n\n\t \n\terr = mvpp2_prs_double_vlan_add(priv, ETH_P_8021AD, ETH_P_8021Q,\n\t\t\t\t\tMVPP2_PRS_PORT_MASK);\n\tif (err)\n\t\treturn err;\n\n\t \n\terr = mvpp2_prs_double_vlan_add(priv, ETH_P_8021Q, ETH_P_8021Q,\n\t\t\t\t\tMVPP2_PRS_PORT_MASK);\n\tif (err)\n\t\treturn err;\n\n\t \n\terr = mvpp2_prs_vlan_add(priv, ETH_P_8021AD, MVPP2_PRS_SINGLE_VLAN_AI,\n\t\t\t\t MVPP2_PRS_PORT_MASK);\n\tif (err)\n\t\treturn err;\n\n\t \n\terr = mvpp2_prs_vlan_add(priv, ETH_P_8021Q, MVPP2_PRS_SINGLE_VLAN_AI,\n\t\t\t\t MVPP2_PRS_PORT_MASK);\n\tif (err)\n\t\treturn err;\n\n\t \n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_VLAN);\n\tpe.index = MVPP2_PE_VLAN_DBL;\n\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_VID);\n\n\t \n\tmvpp2_prs_sram_ai_update(&pe, 0, MVPP2_PRS_SRAM_AI_MASK);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_VLAN_DOUBLE,\n\t\t\t\t MVPP2_PRS_RI_VLAN_MASK);\n\n\tmvpp2_prs_tcam_ai_update(&pe, MVPP2_PRS_DBL_VLAN_AI_BIT,\n\t\t\t\t MVPP2_PRS_DBL_VLAN_AI_BIT);\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_VLAN);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_VLAN);\n\tpe.index = MVPP2_PE_VLAN_NONE;\n\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_L2);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_VLAN_NONE,\n\t\t\t\t MVPP2_PRS_RI_VLAN_MASK);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_VLAN);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nstatic int mvpp2_prs_pppoe_init(struct mvpp2 *priv)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid, ihl;\n\n\t \n\tfor (ihl = MVPP2_PRS_IPV4_IHL_MIN; ihl <= MVPP2_PRS_IPV4_IHL_MAX; ihl++) {\n\t\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\t\tif (tid < 0)\n\t\t\treturn tid;\n\n\t\tmemset(&pe, 0, sizeof(pe));\n\t\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_PPPOE);\n\t\tpe.index = tid;\n\n\t\tmvpp2_prs_match_etype(&pe, 0, PPP_IP);\n\t\tmvpp2_prs_tcam_data_byte_set(&pe, MVPP2_ETH_TYPE_LEN,\n\t\t\t\t\t     MVPP2_PRS_IPV4_HEAD | ihl,\n\t\t\t\t\t     MVPP2_PRS_IPV4_HEAD_MASK |\n\t\t\t\t\t     MVPP2_PRS_IPV4_IHL_MASK);\n\n\t\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_IP4);\n\t\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_IP4,\n\t\t\t\t\t MVPP2_PRS_RI_L3_PROTO_MASK);\n\t\t \n\t\tmvpp2_prs_sram_shift_set(&pe, MVPP2_ETH_TYPE_LEN +\n\t\t\t\t\t sizeof(struct iphdr) - 4,\n\t\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\t\t \n\t\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L3,\n\t\t\t\t\t  MVPP2_ETH_TYPE_LEN,\n\t\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\t\t \n\t\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L4,\n\t\t\t\t\t  MVPP2_ETH_TYPE_LEN + (ihl * 4),\n\t\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\n\t\t \n\t\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_PPPOE);\n\t\tmvpp2_prs_hw_write(priv, &pe);\n\t}\n\n\t \n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_PPPOE);\n\tpe.index = tid;\n\n\tmvpp2_prs_match_etype(&pe, 0, PPP_IPV6);\n\n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_IP6);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_IP6,\n\t\t\t\t MVPP2_PRS_RI_L3_PROTO_MASK);\n\t \n\tmvpp2_prs_sram_shift_set(&pe, MVPP2_ETH_TYPE_LEN + 8 +\n\t\t\t\t MVPP2_MAX_L3_ADDR_SIZE,\n\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\t \n\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L3,\n\t\t\t\t  MVPP2_ETH_TYPE_LEN,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_PPPOE);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_PPPOE);\n\tpe.index = tid;\n\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_UN,\n\t\t\t\t MVPP2_PRS_RI_L3_PROTO_MASK);\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\t \n\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L3,\n\t\t\t\t  MVPP2_ETH_TYPE_LEN,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_PPPOE);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nstatic int mvpp2_prs_ip4_init(struct mvpp2 *priv)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint err;\n\n\t \n\terr = mvpp2_prs_ip4_proto(priv, IPPROTO_TCP, MVPP2_PRS_RI_L4_TCP,\n\t\t\t\t  MVPP2_PRS_RI_L4_PROTO_MASK);\n\tif (err)\n\t\treturn err;\n\n\terr = mvpp2_prs_ip4_proto(priv, IPPROTO_UDP, MVPP2_PRS_RI_L4_UDP,\n\t\t\t\t  MVPP2_PRS_RI_L4_PROTO_MASK);\n\tif (err)\n\t\treturn err;\n\n\terr = mvpp2_prs_ip4_proto(priv, IPPROTO_IGMP,\n\t\t\t\t  MVPP2_PRS_RI_CPU_CODE_RX_SPEC |\n\t\t\t\t  MVPP2_PRS_RI_UDF3_RX_SPECIAL,\n\t\t\t\t  MVPP2_PRS_RI_CPU_CODE_MASK |\n\t\t\t\t  MVPP2_PRS_RI_UDF3_MASK);\n\tif (err)\n\t\treturn err;\n\n\t \n\terr = mvpp2_prs_ip4_cast(priv, MVPP2_PRS_L3_BROAD_CAST);\n\tif (err)\n\t\treturn err;\n\n\t \n\terr = mvpp2_prs_ip4_cast(priv, MVPP2_PRS_L3_MULTI_CAST);\n\tif (err)\n\t\treturn err;\n\n\t \n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_IP4);\n\tpe.index = MVPP2_PE_IP4_PROTO_UN;\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\n\t \n\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L3, -4,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\tmvpp2_prs_sram_ai_update(&pe, 0, MVPP2_PRS_IPV4_DIP_AI_BIT);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L4_OTHER,\n\t\t\t\t MVPP2_PRS_RI_L4_PROTO_MASK);\n\n\tmvpp2_prs_tcam_ai_update(&pe, MVPP2_PRS_IPV4_DIP_AI_BIT,\n\t\t\t\t MVPP2_PRS_IPV4_DIP_AI_BIT);\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP4);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_IP4);\n\tpe.index = MVPP2_PE_IP4_ADDR_UN;\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_IP4);\n\n\tmvpp2_prs_sram_ai_update(&pe, MVPP2_PRS_IPV4_DIP_AI_BIT,\n\t\t\t\t MVPP2_PRS_IPV4_DIP_AI_BIT);\n\n\t \n\tmvpp2_prs_sram_shift_set(&pe, -12, MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_UCAST,\n\t\t\t\t MVPP2_PRS_RI_L3_ADDR_MASK);\n\tmvpp2_prs_tcam_ai_update(&pe, 0, MVPP2_PRS_IPV4_DIP_AI_BIT);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP4);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nstatic int mvpp2_prs_ip6_init(struct mvpp2 *priv)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid, err;\n\n\t \n\terr = mvpp2_prs_ip6_proto(priv, IPPROTO_TCP,\n\t\t\t\t  MVPP2_PRS_RI_L4_TCP,\n\t\t\t\t  MVPP2_PRS_RI_L4_PROTO_MASK);\n\tif (err)\n\t\treturn err;\n\n\terr = mvpp2_prs_ip6_proto(priv, IPPROTO_UDP,\n\t\t\t\t  MVPP2_PRS_RI_L4_UDP,\n\t\t\t\t  MVPP2_PRS_RI_L4_PROTO_MASK);\n\tif (err)\n\t\treturn err;\n\n\terr = mvpp2_prs_ip6_proto(priv, IPPROTO_ICMPV6,\n\t\t\t\t  MVPP2_PRS_RI_CPU_CODE_RX_SPEC |\n\t\t\t\t  MVPP2_PRS_RI_UDF3_RX_SPECIAL,\n\t\t\t\t  MVPP2_PRS_RI_CPU_CODE_MASK |\n\t\t\t\t  MVPP2_PRS_RI_UDF3_MASK);\n\tif (err)\n\t\treturn err;\n\n\t \n\t \n\terr = mvpp2_prs_ip6_proto(priv, IPPROTO_IPIP,\n\t\t\t\t  MVPP2_PRS_RI_UDF7_IP6_LITE,\n\t\t\t\t  MVPP2_PRS_RI_UDF7_MASK);\n\tif (err)\n\t\treturn err;\n\n\t \n\terr = mvpp2_prs_ip6_cast(priv, MVPP2_PRS_L3_MULTI_CAST);\n\tif (err)\n\t\treturn err;\n\n\t \n\ttid = mvpp2_prs_tcam_first_free(priv, MVPP2_PE_FIRST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_IP6);\n\tpe.index = tid;\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_UN |\n\t\t\t\t MVPP2_PRS_RI_DROP_MASK,\n\t\t\t\t MVPP2_PRS_RI_L3_PROTO_MASK |\n\t\t\t\t MVPP2_PRS_RI_DROP_MASK);\n\n\tmvpp2_prs_tcam_data_byte_set(&pe, 1, 0x00, MVPP2_PRS_IPV6_HOP_MASK);\n\tmvpp2_prs_tcam_ai_update(&pe, MVPP2_PRS_IPV6_NO_EXT_AI_BIT,\n\t\t\t\t MVPP2_PRS_IPV6_NO_EXT_AI_BIT);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP4);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\tmemset(&pe, 0, sizeof(pe));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_IP6);\n\tpe.index = MVPP2_PE_IP6_PROTO_UN;\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L4_OTHER,\n\t\t\t\t MVPP2_PRS_RI_L4_PROTO_MASK);\n\t \n\tmvpp2_prs_sram_offset_set(&pe, MVPP2_PRS_SRAM_UDF_TYPE_L4,\n\t\t\t\t  sizeof(struct ipv6hdr) - 4,\n\t\t\t\t  MVPP2_PRS_SRAM_OP_SEL_UDF_ADD);\n\n\tmvpp2_prs_tcam_ai_update(&pe, MVPP2_PRS_IPV6_NO_EXT_AI_BIT,\n\t\t\t\t MVPP2_PRS_IPV6_NO_EXT_AI_BIT);\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP4);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\tmemset(&pe, 0, sizeof(struct mvpp2_prs_entry));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_IP6);\n\tpe.index = MVPP2_PE_IP6_EXT_PROTO_UN;\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_GEN_BIT, 1);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L4_OTHER,\n\t\t\t\t MVPP2_PRS_RI_L4_PROTO_MASK);\n\n\tmvpp2_prs_tcam_ai_update(&pe, MVPP2_PRS_IPV6_EXT_AI_BIT,\n\t\t\t\t MVPP2_PRS_IPV6_EXT_AI_BIT);\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP4);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\t \n\tmemset(&pe, 0, sizeof(struct mvpp2_prs_entry));\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_IP6);\n\tpe.index = MVPP2_PE_IP6_ADDR_UN;\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_IP6);\n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_L3_UCAST,\n\t\t\t\t MVPP2_PRS_RI_L3_ADDR_MASK);\n\tmvpp2_prs_sram_ai_update(&pe, MVPP2_PRS_IPV6_NO_EXT_AI_BIT,\n\t\t\t\t MVPP2_PRS_IPV6_NO_EXT_AI_BIT);\n\t \n\tmvpp2_prs_sram_shift_set(&pe, -18, MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\tmvpp2_prs_tcam_ai_update(&pe, 0, MVPP2_PRS_IPV6_NO_EXT_AI_BIT);\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_IP6);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nstatic int mvpp2_prs_vid_range_find(struct mvpp2_port *port, u16 vid, u16 mask)\n{\n\tunsigned char byte[2], enable[2];\n\tstruct mvpp2_prs_entry pe;\n\tu16 rvid, rmask;\n\tint tid;\n\n\t \n\tfor (tid = MVPP2_PRS_VID_PORT_FIRST(port->id);\n\t     tid <= MVPP2_PRS_VID_PORT_LAST(port->id); tid++) {\n\t\tif (!port->priv->prs_shadow[tid].valid ||\n\t\t    port->priv->prs_shadow[tid].lu != MVPP2_PRS_LU_VID)\n\t\t\tcontinue;\n\n\t\tmvpp2_prs_init_from_hw(port->priv, &pe, tid);\n\n\t\tmvpp2_prs_tcam_data_byte_get(&pe, 2, &byte[0], &enable[0]);\n\t\tmvpp2_prs_tcam_data_byte_get(&pe, 3, &byte[1], &enable[1]);\n\n\t\trvid = ((byte[0] & 0xf) << 8) + byte[1];\n\t\trmask = ((enable[0] & 0xf) << 8) + enable[1];\n\n\t\tif (rvid != vid || rmask != mask)\n\t\t\tcontinue;\n\n\t\treturn tid;\n\t}\n\n\treturn -ENOENT;\n}\n\n \nint mvpp2_prs_vid_entry_add(struct mvpp2_port *port, u16 vid)\n{\n\tunsigned int vid_start = MVPP2_PE_VID_FILT_RANGE_START +\n\t\t\t\t port->id * MVPP2_PRS_VLAN_FILT_MAX;\n\tunsigned int mask = 0xfff, reg_val, shift;\n\tstruct mvpp2 *priv = port->priv;\n\tstruct mvpp2_prs_entry pe;\n\tint tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\t \n\ttid = mvpp2_prs_vid_range_find(port, vid, mask);\n\n\treg_val = mvpp2_read(priv, MVPP2_MH_REG(port->id));\n\tif (reg_val & MVPP2_DSA_EXTENDED)\n\t\tshift = MVPP2_VLAN_TAG_EDSA_LEN;\n\telse\n\t\tshift = MVPP2_VLAN_TAG_LEN;\n\n\t \n\tif (tid < 0) {\n\n\t\t \n\t\ttid = mvpp2_prs_tcam_first_free(priv, vid_start,\n\t\t\t\t\t\tvid_start +\n\t\t\t\t\t\tMVPP2_PRS_VLAN_FILT_MAX_ENTRY);\n\n\t\t \n\t\tif (tid < 0)\n\t\t\treturn tid;\n\n\t\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_VID);\n\t\tpe.index = tid;\n\n\t\t \n\t\tmvpp2_prs_tcam_port_map_set(&pe, 0);\n\t} else {\n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\t}\n\n\t \n\tmvpp2_prs_tcam_port_set(&pe, port->id, true);\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_L2);\n\n\t \n\tmvpp2_prs_sram_shift_set(&pe, shift, MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\t \n\tmvpp2_prs_match_vid(&pe, MVPP2_PRS_VID_TCAM_BYTE, vid);\n\n\t \n\tmvpp2_prs_sram_ai_update(&pe, 0, MVPP2_PRS_SRAM_AI_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_VID);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nvoid mvpp2_prs_vid_entry_remove(struct mvpp2_port *port, u16 vid)\n{\n\tstruct mvpp2 *priv = port->priv;\n\tint tid;\n\n\t \n\ttid = mvpp2_prs_vid_range_find(port, vid, 0xfff);\n\n\t \n\tif (tid < 0)\n\t\treturn;\n\n\tmvpp2_prs_hw_inv(priv, tid);\n\tpriv->prs_shadow[tid].valid = false;\n}\n\n \nvoid mvpp2_prs_vid_remove_all(struct mvpp2_port *port)\n{\n\tstruct mvpp2 *priv = port->priv;\n\tint tid;\n\n\tfor (tid = MVPP2_PRS_VID_PORT_FIRST(port->id);\n\t     tid <= MVPP2_PRS_VID_PORT_LAST(port->id); tid++) {\n\t\tif (priv->prs_shadow[tid].valid) {\n\t\t\tmvpp2_prs_hw_inv(priv, tid);\n\t\t\tpriv->prs_shadow[tid].valid = false;\n\t\t}\n\t}\n}\n\n \nvoid mvpp2_prs_vid_disable_filtering(struct mvpp2_port *port)\n{\n\tunsigned int tid = MVPP2_PRS_VID_PORT_DFLT(port->id);\n\tstruct mvpp2 *priv = port->priv;\n\n\t \n\tmvpp2_prs_hw_inv(priv, tid);\n\n\tpriv->prs_shadow[tid].valid = false;\n}\n\n \nvoid mvpp2_prs_vid_enable_filtering(struct mvpp2_port *port)\n{\n\tunsigned int tid = MVPP2_PRS_VID_PORT_DFLT(port->id);\n\tstruct mvpp2 *priv = port->priv;\n\tunsigned int reg_val, shift;\n\tstruct mvpp2_prs_entry pe;\n\n\tif (priv->prs_shadow[tid].valid)\n\t\treturn;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\tpe.index = tid;\n\n\treg_val = mvpp2_read(priv, MVPP2_MH_REG(port->id));\n\tif (reg_val & MVPP2_DSA_EXTENDED)\n\t\tshift = MVPP2_VLAN_TAG_EDSA_LEN;\n\telse\n\t\tshift = MVPP2_VLAN_TAG_LEN;\n\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_VID);\n\n\t \n\tmvpp2_prs_tcam_port_map_set(&pe, 0);\n\n\t \n\tmvpp2_prs_tcam_port_set(&pe, port->id, true);\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_L2);\n\n\t \n\tmvpp2_prs_sram_shift_set(&pe, shift, MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\t \n\tmvpp2_prs_sram_ri_update(&pe, MVPP2_PRS_RI_DROP_MASK,\n\t\t\t\t MVPP2_PRS_RI_DROP_MASK);\n\n\t \n\tmvpp2_prs_sram_ai_update(&pe, 0, MVPP2_PRS_SRAM_AI_MASK);\n\n\t \n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_VID);\n\tmvpp2_prs_hw_write(priv, &pe);\n}\n\n \nint mvpp2_prs_default_init(struct platform_device *pdev, struct mvpp2 *priv)\n{\n\tint err, index, i;\n\n\t \n\tmvpp2_write(priv, MVPP2_PRS_TCAM_CTRL_REG, MVPP2_PRS_TCAM_EN_MASK);\n\n\t \n\tfor (index = 0; index < MVPP2_PRS_TCAM_SRAM_SIZE; index++) {\n\t\tmvpp2_write(priv, MVPP2_PRS_TCAM_IDX_REG, index);\n\t\tfor (i = 0; i < MVPP2_PRS_TCAM_WORDS; i++)\n\t\t\tmvpp2_write(priv, MVPP2_PRS_TCAM_DATA_REG(i), 0);\n\n\t\tmvpp2_write(priv, MVPP2_PRS_SRAM_IDX_REG, index);\n\t\tfor (i = 0; i < MVPP2_PRS_SRAM_WORDS; i++)\n\t\t\tmvpp2_write(priv, MVPP2_PRS_SRAM_DATA_REG(i), 0);\n\t}\n\n\t \n\tfor (index = 0; index < MVPP2_PRS_TCAM_SRAM_SIZE; index++)\n\t\tmvpp2_prs_hw_inv(priv, index);\n\n\tpriv->prs_shadow = devm_kcalloc(&pdev->dev, MVPP2_PRS_TCAM_SRAM_SIZE,\n\t\t\t\t\tsizeof(*priv->prs_shadow),\n\t\t\t\t\tGFP_KERNEL);\n\tif (!priv->prs_shadow)\n\t\treturn -ENOMEM;\n\n\t \n\tfor (index = 0; index < MVPP2_MAX_PORTS; index++)\n\t\tmvpp2_prs_hw_port_init(priv, index, MVPP2_PRS_LU_MH,\n\t\t\t\t       MVPP2_PRS_PORT_LU_MAX, 0);\n\n\tmvpp2_prs_def_flow_init(priv);\n\n\tmvpp2_prs_mh_init(priv);\n\n\tmvpp2_prs_mac_init(priv);\n\n\tmvpp2_prs_dsa_init(priv);\n\n\tmvpp2_prs_vid_init(priv);\n\n\terr = mvpp2_prs_etype_init(priv);\n\tif (err)\n\t\treturn err;\n\n\terr = mvpp2_prs_vlan_init(pdev, priv);\n\tif (err)\n\t\treturn err;\n\n\terr = mvpp2_prs_pppoe_init(priv);\n\tif (err)\n\t\treturn err;\n\n\terr = mvpp2_prs_ip6_init(priv);\n\tif (err)\n\t\treturn err;\n\n\terr = mvpp2_prs_ip4_init(priv);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\n \nstatic bool mvpp2_prs_mac_range_equals(struct mvpp2_prs_entry *pe,\n\t\t\t\t       const u8 *da, unsigned char *mask)\n{\n\tunsigned char tcam_byte, tcam_mask;\n\tint index;\n\n\tfor (index = 0; index < ETH_ALEN; index++) {\n\t\tmvpp2_prs_tcam_data_byte_get(pe, index, &tcam_byte, &tcam_mask);\n\t\tif (tcam_mask != mask[index])\n\t\t\treturn false;\n\n\t\tif ((tcam_mask & tcam_byte) != (da[index] & mask[index]))\n\t\t\treturn false;\n\t}\n\n\treturn true;\n}\n\n \nstatic int\nmvpp2_prs_mac_da_range_find(struct mvpp2 *priv, int pmap, const u8 *da,\n\t\t\t    unsigned char *mask, int udf_type)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid;\n\n\t \n\tfor (tid = MVPP2_PE_MAC_RANGE_START;\n\t     tid <= MVPP2_PE_MAC_RANGE_END; tid++) {\n\t\tunsigned int entry_pmap;\n\n\t\tif (!priv->prs_shadow[tid].valid ||\n\t\t    (priv->prs_shadow[tid].lu != MVPP2_PRS_LU_MAC) ||\n\t\t    (priv->prs_shadow[tid].udf != udf_type))\n\t\t\tcontinue;\n\n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\t\tentry_pmap = mvpp2_prs_tcam_port_map_get(&pe);\n\n\t\tif (mvpp2_prs_mac_range_equals(&pe, da, mask) &&\n\t\t    entry_pmap == pmap)\n\t\t\treturn tid;\n\t}\n\n\treturn -ENOENT;\n}\n\n \nint mvpp2_prs_mac_da_accept(struct mvpp2_port *port, const u8 *da, bool add)\n{\n\tunsigned char mask[ETH_ALEN] = { 0xff, 0xff, 0xff, 0xff, 0xff, 0xff };\n\tstruct mvpp2 *priv = port->priv;\n\tunsigned int pmap, len, ri;\n\tstruct mvpp2_prs_entry pe;\n\tint tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\t \n\ttid = mvpp2_prs_mac_da_range_find(priv, BIT(port->id), da, mask,\n\t\t\t\t\t  MVPP2_PRS_UDF_MAC_DEF);\n\n\t \n\tif (tid < 0) {\n\t\tif (!add)\n\t\t\treturn 0;\n\n\t\t \n\t\t \n\t\ttid = mvpp2_prs_tcam_first_free(priv,\n\t\t\t\t\t\tMVPP2_PE_MAC_RANGE_START,\n\t\t\t\t\t\tMVPP2_PE_MAC_RANGE_END);\n\t\tif (tid < 0)\n\t\t\treturn tid;\n\n\t\tpe.index = tid;\n\n\t\t \n\t\tmvpp2_prs_tcam_port_map_set(&pe, 0);\n\t} else {\n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\t}\n\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_MAC);\n\n\t \n\tmvpp2_prs_tcam_port_set(&pe, port->id, add);\n\n\t \n\tpmap = mvpp2_prs_tcam_port_map_get(&pe);\n\tif (pmap == 0) {\n\t\tif (add)\n\t\t\treturn -EINVAL;\n\n\t\tmvpp2_prs_hw_inv(priv, pe.index);\n\t\tpriv->prs_shadow[pe.index].valid = false;\n\t\treturn 0;\n\t}\n\n\t \n\tmvpp2_prs_sram_next_lu_set(&pe, MVPP2_PRS_LU_DSA);\n\n\t \n\tlen = ETH_ALEN;\n\twhile (len--)\n\t\tmvpp2_prs_tcam_data_byte_set(&pe, len, da[len], 0xff);\n\n\t \n\tif (is_broadcast_ether_addr(da)) {\n\t\tri = MVPP2_PRS_RI_L2_BCAST;\n\t} else if (is_multicast_ether_addr(da)) {\n\t\tri = MVPP2_PRS_RI_L2_MCAST;\n\t} else {\n\t\tri = MVPP2_PRS_RI_L2_UCAST;\n\n\t\tif (ether_addr_equal(da, port->dev->dev_addr))\n\t\t\tri |= MVPP2_PRS_RI_MAC_ME_MASK;\n\t}\n\n\tmvpp2_prs_sram_ri_update(&pe, ri, MVPP2_PRS_RI_L2_CAST_MASK |\n\t\t\t\t MVPP2_PRS_RI_MAC_ME_MASK);\n\tmvpp2_prs_shadow_ri_set(priv, pe.index, ri, MVPP2_PRS_RI_L2_CAST_MASK |\n\t\t\t\tMVPP2_PRS_RI_MAC_ME_MASK);\n\n\t \n\tmvpp2_prs_sram_shift_set(&pe, 2 * ETH_ALEN,\n\t\t\t\t MVPP2_PRS_SRAM_OP_SEL_SHIFT_ADD);\n\n\t \n\tpriv->prs_shadow[pe.index].udf = MVPP2_PRS_UDF_MAC_DEF;\n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_MAC);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\nint mvpp2_prs_update_mac_da(struct net_device *dev, const u8 *da)\n{\n\tstruct mvpp2_port *port = netdev_priv(dev);\n\tint err;\n\n\t \n\terr = mvpp2_prs_mac_da_accept(port, dev->dev_addr, false);\n\tif (err)\n\t\treturn err;\n\n\t \n\terr = mvpp2_prs_mac_da_accept(port, da, true);\n\tif (err)\n\t\treturn err;\n\n\t \n\teth_hw_addr_set(dev, da);\n\n\treturn 0;\n}\n\nvoid mvpp2_prs_mac_del_all(struct mvpp2_port *port)\n{\n\tstruct mvpp2 *priv = port->priv;\n\tstruct mvpp2_prs_entry pe;\n\tunsigned long pmap;\n\tint index, tid;\n\n\tfor (tid = MVPP2_PE_MAC_RANGE_START;\n\t     tid <= MVPP2_PE_MAC_RANGE_END; tid++) {\n\t\tunsigned char da[ETH_ALEN], da_mask[ETH_ALEN];\n\n\t\tif (!priv->prs_shadow[tid].valid ||\n\t\t    (priv->prs_shadow[tid].lu != MVPP2_PRS_LU_MAC) ||\n\t\t    (priv->prs_shadow[tid].udf != MVPP2_PRS_UDF_MAC_DEF))\n\t\t\tcontinue;\n\n\t\tmvpp2_prs_init_from_hw(priv, &pe, tid);\n\n\t\tpmap = mvpp2_prs_tcam_port_map_get(&pe);\n\n\t\t \n\t\tif (!test_bit(port->id, &pmap))\n\t\t\tcontinue;\n\n\t\t \n\t\tfor (index = 0; index < ETH_ALEN; index++)\n\t\t\tmvpp2_prs_tcam_data_byte_get(&pe, index, &da[index],\n\t\t\t\t\t\t     &da_mask[index]);\n\n\t\t \n\t\tif (is_broadcast_ether_addr(da) ||\n\t\t    ether_addr_equal(da, port->dev->dev_addr))\n\t\t\tcontinue;\n\n\t\t \n\t\tmvpp2_prs_mac_da_accept(port, da, false);\n\t}\n}\n\nint mvpp2_prs_tag_mode_set(struct mvpp2 *priv, int port, int type)\n{\n\tswitch (type) {\n\tcase MVPP2_TAG_TYPE_EDSA:\n\t\t \n\t\tmvpp2_prs_dsa_tag_set(priv, port, true,\n\t\t\t\t      MVPP2_PRS_TAGGED, MVPP2_PRS_EDSA);\n\t\tmvpp2_prs_dsa_tag_set(priv, port, true,\n\t\t\t\t      MVPP2_PRS_UNTAGGED, MVPP2_PRS_EDSA);\n\t\t \n\t\tmvpp2_prs_dsa_tag_set(priv, port, false,\n\t\t\t\t      MVPP2_PRS_TAGGED, MVPP2_PRS_DSA);\n\t\tmvpp2_prs_dsa_tag_set(priv, port, false,\n\t\t\t\t      MVPP2_PRS_UNTAGGED, MVPP2_PRS_DSA);\n\t\tbreak;\n\n\tcase MVPP2_TAG_TYPE_DSA:\n\t\t \n\t\tmvpp2_prs_dsa_tag_set(priv, port, true,\n\t\t\t\t      MVPP2_PRS_TAGGED, MVPP2_PRS_DSA);\n\t\tmvpp2_prs_dsa_tag_set(priv, port, true,\n\t\t\t\t      MVPP2_PRS_UNTAGGED, MVPP2_PRS_DSA);\n\t\t \n\t\tmvpp2_prs_dsa_tag_set(priv, port, false,\n\t\t\t\t      MVPP2_PRS_TAGGED, MVPP2_PRS_EDSA);\n\t\tmvpp2_prs_dsa_tag_set(priv, port, false,\n\t\t\t\t      MVPP2_PRS_UNTAGGED, MVPP2_PRS_EDSA);\n\t\tbreak;\n\n\tcase MVPP2_TAG_TYPE_MH:\n\tcase MVPP2_TAG_TYPE_NONE:\n\t\t \n\t\tmvpp2_prs_dsa_tag_set(priv, port, false,\n\t\t\t\t      MVPP2_PRS_TAGGED, MVPP2_PRS_DSA);\n\t\tmvpp2_prs_dsa_tag_set(priv, port, false,\n\t\t\t\t      MVPP2_PRS_UNTAGGED, MVPP2_PRS_DSA);\n\t\tmvpp2_prs_dsa_tag_set(priv, port, false,\n\t\t\t\t      MVPP2_PRS_TAGGED, MVPP2_PRS_EDSA);\n\t\tmvpp2_prs_dsa_tag_set(priv, port, false,\n\t\t\t\t      MVPP2_PRS_UNTAGGED, MVPP2_PRS_EDSA);\n\t\tbreak;\n\n\tdefault:\n\t\tif ((type < 0) || (type > MVPP2_TAG_TYPE_EDSA))\n\t\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nint mvpp2_prs_add_flow(struct mvpp2 *priv, int flow, u32 ri, u32 ri_mask)\n{\n\tstruct mvpp2_prs_entry pe;\n\tu8 *ri_byte, *ri_byte_mask;\n\tint tid, i;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\ttid = mvpp2_prs_tcam_first_free(priv,\n\t\t\t\t\tMVPP2_PE_LAST_FREE_TID,\n\t\t\t\t\tMVPP2_PE_FIRST_FREE_TID);\n\tif (tid < 0)\n\t\treturn tid;\n\n\tpe.index = tid;\n\n\tri_byte = (u8 *)&ri;\n\tri_byte_mask = (u8 *)&ri_mask;\n\n\tmvpp2_prs_sram_ai_update(&pe, flow, MVPP2_PRS_FLOW_ID_MASK);\n\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_DONE_BIT, 1);\n\n\tfor (i = 0; i < 4; i++) {\n\t\tmvpp2_prs_tcam_data_byte_set(&pe, i, ri_byte[i],\n\t\t\t\t\t     ri_byte_mask[i]);\n\t}\n\n\tmvpp2_prs_shadow_set(priv, pe.index, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_tcam_port_map_set(&pe, MVPP2_PRS_PORT_MASK);\n\tmvpp2_prs_hw_write(priv, &pe);\n\n\treturn 0;\n}\n\n \nint mvpp2_prs_def_flow(struct mvpp2_port *port)\n{\n\tstruct mvpp2_prs_entry pe;\n\tint tid;\n\n\tmemset(&pe, 0, sizeof(pe));\n\n\ttid = mvpp2_prs_flow_find(port->priv, port->id);\n\n\t \n\tif (tid < 0) {\n\t\t \n\t\ttid = mvpp2_prs_tcam_first_free(port->priv,\n\t\t\t\t\t\tMVPP2_PE_LAST_FREE_TID,\n\t\t\t\t\t       MVPP2_PE_FIRST_FREE_TID);\n\t\tif (tid < 0)\n\t\t\treturn tid;\n\n\t\tpe.index = tid;\n\n\t\t \n\t\tmvpp2_prs_sram_ai_update(&pe, port->id, MVPP2_PRS_FLOW_ID_MASK);\n\t\tmvpp2_prs_sram_bits_set(&pe, MVPP2_PRS_SRAM_LU_DONE_BIT, 1);\n\n\t\t \n\t\tmvpp2_prs_shadow_set(port->priv, pe.index, MVPP2_PRS_LU_FLOWS);\n\t} else {\n\t\tmvpp2_prs_init_from_hw(port->priv, &pe, tid);\n\t}\n\n\tmvpp2_prs_tcam_lu_set(&pe, MVPP2_PRS_LU_FLOWS);\n\tmvpp2_prs_tcam_port_map_set(&pe, (1 << port->id));\n\tmvpp2_prs_hw_write(port->priv, &pe);\n\n\treturn 0;\n}\n\nint mvpp2_prs_hits(struct mvpp2 *priv, int index)\n{\n\tu32 val;\n\n\tif (index > MVPP2_PRS_TCAM_SRAM_SIZE)\n\t\treturn -EINVAL;\n\n\tmvpp2_write(priv, MVPP2_PRS_TCAM_HIT_IDX_REG, index);\n\n\tval = mvpp2_read(priv, MVPP2_PRS_TCAM_HIT_CNT_REG);\n\n\tval &= MVPP2_PRS_TCAM_HIT_CNT_MASK;\n\n\treturn val;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}