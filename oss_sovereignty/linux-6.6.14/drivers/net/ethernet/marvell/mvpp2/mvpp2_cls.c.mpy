{
  "module_name": "mvpp2_cls.c",
  "hash_id": "a12b3865e912bb6408deb3f888290fb74d79ad3afaa78de79dfc09a74a90d392",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/marvell/mvpp2/mvpp2_cls.c",
  "human_readable_source": "\n \n\n#include \"mvpp2.h\"\n#include \"mvpp2_cls.h\"\n#include \"mvpp2_prs.h\"\n\n#define MVPP2_DEF_FLOW(_type, _id, _opts, _ri, _ri_mask)\t\\\n{\t\t\t\t\t\t\t\t\\\n\t.flow_type = _type,\t\t\t\t\t\\\n\t.flow_id = _id,\t\t\t\t\t\t\\\n\t.supported_hash_opts = _opts,\t\t\t\t\\\n\t.prs_ri = {\t\t\t\t\t\t\\\n\t\t.ri = _ri,\t\t\t\t\t\\\n\t\t.ri_mask = _ri_mask\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\\\n}\n\nstatic const struct mvpp2_cls_flow cls_flows[MVPP2_N_PRS_FLOWS] = {\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_NF_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4 |\n\t\t       MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_NF_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4_OPT |\n\t\t       MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_NF_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4_OTHER |\n\t\t       MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_NF_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4 | MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_NF_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4_OPT | MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_NF_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4_OTHER | MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_FRAG_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4 |\n\t\t       MVPP2_PRS_RI_IP_FRAG_TRUE | MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_FRAG_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4_OPT |\n\t\t       MVPP2_PRS_RI_IP_FRAG_TRUE | MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_FRAG_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4_OTHER |\n\t\t       MVPP2_PRS_RI_IP_FRAG_TRUE | MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_FRAG_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4 | MVPP2_PRS_RI_IP_FRAG_TRUE |\n\t\t\t   MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_FRAG_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4_OPT | MVPP2_PRS_RI_IP_FRAG_TRUE |\n\t\t\t   MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP4, MVPP2_FL_IP4_TCP_FRAG_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4_OTHER | MVPP2_PRS_RI_IP_FRAG_TRUE |\n\t\t\t   MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_NF_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4 |\n\t\t       MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_NF_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4_OPT |\n\t\t       MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_NF_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4_OTHER |\n\t\t       MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_NF_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4 | MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_NF_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4_OPT | MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_NF_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_5T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4_OTHER | MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_FRAG_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4 |\n\t\t       MVPP2_PRS_RI_IP_FRAG_TRUE | MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_FRAG_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4_OPT |\n\t\t       MVPP2_PRS_RI_IP_FRAG_TRUE | MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_FRAG_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4_OTHER |\n\t\t       MVPP2_PRS_RI_IP_FRAG_TRUE | MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_FRAG_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4 | MVPP2_PRS_RI_IP_FRAG_TRUE |\n\t\t\t   MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_FRAG_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4_OPT | MVPP2_PRS_RI_IP_FRAG_TRUE |\n\t\t\t   MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP4, MVPP2_FL_IP4_UDP_FRAG_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4_OTHER | MVPP2_PRS_RI_IP_FRAG_TRUE |\n\t\t\t   MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP6, MVPP2_FL_IP6_TCP_NF_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP6_5T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP6 |\n\t\t       MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP6, MVPP2_FL_IP6_TCP_NF_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP6_5T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP6_EXT |\n\t\t       MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP6, MVPP2_FL_IP6_TCP_NF_TAG,\n\t\t       MVPP22_CLS_HEK_IP6_5T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP6 | MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP6, MVPP2_FL_IP6_TCP_NF_TAG,\n\t\t       MVPP22_CLS_HEK_IP6_5T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP6_EXT | MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP6, MVPP2_FL_IP6_TCP_FRAG_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP6 |\n\t\t       MVPP2_PRS_RI_IP_FRAG_TRUE | MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP6, MVPP2_FL_IP6_TCP_FRAG_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP6_EXT |\n\t\t       MVPP2_PRS_RI_IP_FRAG_TRUE | MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP6, MVPP2_FL_IP6_TCP_FRAG_TAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP6 | MVPP2_PRS_RI_IP_FRAG_TRUE |\n\t\t       MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_TCP6, MVPP2_FL_IP6_TCP_FRAG_TAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP6_EXT | MVPP2_PRS_RI_IP_FRAG_TRUE |\n\t\t       MVPP2_PRS_RI_L4_TCP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP6, MVPP2_FL_IP6_UDP_NF_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP6_5T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP6 |\n\t\t       MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP6, MVPP2_FL_IP6_UDP_NF_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP6_5T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP6_EXT |\n\t\t       MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP6, MVPP2_FL_IP6_UDP_NF_TAG,\n\t\t       MVPP22_CLS_HEK_IP6_5T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP6 | MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP6, MVPP2_FL_IP6_UDP_NF_TAG,\n\t\t       MVPP22_CLS_HEK_IP6_5T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP6_EXT | MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP6, MVPP2_FL_IP6_UDP_FRAG_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP6 |\n\t\t       MVPP2_PRS_RI_IP_FRAG_TRUE | MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP6, MVPP2_FL_IP6_UDP_FRAG_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP6_EXT |\n\t\t       MVPP2_PRS_RI_IP_FRAG_TRUE | MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK | MVPP2_PRS_RI_VLAN_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP6, MVPP2_FL_IP6_UDP_FRAG_TAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP6 | MVPP2_PRS_RI_IP_FRAG_TRUE |\n\t\t       MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_UDP6, MVPP2_FL_IP6_UDP_FRAG_TAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP6_EXT | MVPP2_PRS_RI_IP_FRAG_TRUE |\n\t\t       MVPP2_PRS_RI_L4_UDP,\n\t\t       MVPP2_PRS_IP_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_IP4, MVPP2_FL_IP4_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4,\n\t\t       MVPP2_PRS_RI_VLAN_MASK | MVPP2_PRS_RI_L3_PROTO_MASK),\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_IP4, MVPP2_FL_IP4_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4_OPT,\n\t\t       MVPP2_PRS_RI_VLAN_MASK | MVPP2_PRS_RI_L3_PROTO_MASK),\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_IP4, MVPP2_FL_IP4_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP4_OTHER,\n\t\t       MVPP2_PRS_RI_VLAN_MASK | MVPP2_PRS_RI_L3_PROTO_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_IP4, MVPP2_FL_IP4_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4,\n\t\t       MVPP2_PRS_RI_L3_PROTO_MASK),\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_IP4, MVPP2_FL_IP4_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4_OPT,\n\t\t       MVPP2_PRS_RI_L3_PROTO_MASK),\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_IP4, MVPP2_FL_IP4_TAG,\n\t\t       MVPP22_CLS_HEK_IP4_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP4_OTHER,\n\t\t       MVPP2_PRS_RI_L3_PROTO_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_IP6, MVPP2_FL_IP6_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP6,\n\t\t       MVPP2_PRS_RI_VLAN_MASK | MVPP2_PRS_RI_L3_PROTO_MASK),\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_IP6, MVPP2_FL_IP6_UNTAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T,\n\t\t       MVPP2_PRS_RI_VLAN_NONE | MVPP2_PRS_RI_L3_IP6,\n\t\t       MVPP2_PRS_RI_VLAN_MASK | MVPP2_PRS_RI_L3_PROTO_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_IP6, MVPP2_FL_IP6_TAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP6,\n\t\t       MVPP2_PRS_RI_L3_PROTO_MASK),\n\tMVPP2_DEF_FLOW(MVPP22_FLOW_IP6, MVPP2_FL_IP6_TAG,\n\t\t       MVPP22_CLS_HEK_IP6_2T | MVPP22_CLS_HEK_TAGGED,\n\t\t       MVPP2_PRS_RI_L3_IP6,\n\t\t       MVPP2_PRS_RI_L3_PROTO_MASK),\n\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_ETHERNET, MVPP2_FL_NON_IP_UNTAG,\n\t\t       0,\n\t\t       MVPP2_PRS_RI_VLAN_NONE,\n\t\t       MVPP2_PRS_RI_VLAN_MASK),\n\t \n\tMVPP2_DEF_FLOW(MVPP22_FLOW_ETHERNET, MVPP2_FL_NON_IP_TAG,\n\t\t       MVPP22_CLS_HEK_OPT_VLAN,\n\t\t       0, 0),\n};\n\nu32 mvpp2_cls_flow_hits(struct mvpp2 *priv, int index)\n{\n\tmvpp2_write(priv, MVPP2_CTRS_IDX, index);\n\n\treturn mvpp2_read(priv, MVPP2_CLS_FLOW_TBL_HIT_CTR);\n}\n\nvoid mvpp2_cls_flow_read(struct mvpp2 *priv, int index,\n\t\t\t struct mvpp2_cls_flow_entry *fe)\n{\n\tfe->index = index;\n\tmvpp2_write(priv, MVPP2_CLS_FLOW_INDEX_REG, index);\n\tfe->data[0] = mvpp2_read(priv, MVPP2_CLS_FLOW_TBL0_REG);\n\tfe->data[1] = mvpp2_read(priv, MVPP2_CLS_FLOW_TBL1_REG);\n\tfe->data[2] = mvpp2_read(priv, MVPP2_CLS_FLOW_TBL2_REG);\n}\n\n \nstatic void mvpp2_cls_flow_write(struct mvpp2 *priv,\n\t\t\t\t struct mvpp2_cls_flow_entry *fe)\n{\n\tmvpp2_write(priv, MVPP2_CLS_FLOW_INDEX_REG, fe->index);\n\tmvpp2_write(priv, MVPP2_CLS_FLOW_TBL0_REG, fe->data[0]);\n\tmvpp2_write(priv, MVPP2_CLS_FLOW_TBL1_REG, fe->data[1]);\n\tmvpp2_write(priv, MVPP2_CLS_FLOW_TBL2_REG, fe->data[2]);\n}\n\nu32 mvpp2_cls_lookup_hits(struct mvpp2 *priv, int index)\n{\n\tmvpp2_write(priv, MVPP2_CTRS_IDX, index);\n\n\treturn mvpp2_read(priv, MVPP2_CLS_DEC_TBL_HIT_CTR);\n}\n\nvoid mvpp2_cls_lookup_read(struct mvpp2 *priv, int lkpid, int way,\n\t\t\t   struct mvpp2_cls_lookup_entry *le)\n{\n\tu32 val;\n\n\tval = (way << MVPP2_CLS_LKP_INDEX_WAY_OFFS) | lkpid;\n\tmvpp2_write(priv, MVPP2_CLS_LKP_INDEX_REG, val);\n\tle->way = way;\n\tle->lkpid = lkpid;\n\tle->data = mvpp2_read(priv, MVPP2_CLS_LKP_TBL_REG);\n}\n\n \nstatic void mvpp2_cls_lookup_write(struct mvpp2 *priv,\n\t\t\t\t   struct mvpp2_cls_lookup_entry *le)\n{\n\tu32 val;\n\n\tval = (le->way << MVPP2_CLS_LKP_INDEX_WAY_OFFS) | le->lkpid;\n\tmvpp2_write(priv, MVPP2_CLS_LKP_INDEX_REG, val);\n\tmvpp2_write(priv, MVPP2_CLS_LKP_TBL_REG, le->data);\n}\n\n \nstatic int mvpp2_cls_flow_hek_num_get(struct mvpp2_cls_flow_entry *fe)\n{\n\treturn fe->data[1] & MVPP2_CLS_FLOW_TBL1_N_FIELDS_MASK;\n}\n\nstatic void mvpp2_cls_flow_hek_num_set(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t       int num_of_fields)\n{\n\tfe->data[1] &= ~MVPP2_CLS_FLOW_TBL1_N_FIELDS_MASK;\n\tfe->data[1] |= MVPP2_CLS_FLOW_TBL1_N_FIELDS(num_of_fields);\n}\n\nstatic int mvpp2_cls_flow_hek_get(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t  int field_index)\n{\n\treturn (fe->data[2] >> MVPP2_CLS_FLOW_TBL2_FLD_OFFS(field_index)) &\n\t\tMVPP2_CLS_FLOW_TBL2_FLD_MASK;\n}\n\nstatic void mvpp2_cls_flow_hek_set(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t   int field_index, int field_id)\n{\n\tfe->data[2] &= ~MVPP2_CLS_FLOW_TBL2_FLD(field_index,\n\t\t\t\t\t\tMVPP2_CLS_FLOW_TBL2_FLD_MASK);\n\tfe->data[2] |= MVPP2_CLS_FLOW_TBL2_FLD(field_index, field_id);\n}\n\nstatic void mvpp2_cls_flow_eng_set(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t   int engine)\n{\n\tfe->data[0] &= ~MVPP2_CLS_FLOW_TBL0_ENG(MVPP2_CLS_FLOW_TBL0_ENG_MASK);\n\tfe->data[0] |= MVPP2_CLS_FLOW_TBL0_ENG(engine);\n}\n\nint mvpp2_cls_flow_eng_get(struct mvpp2_cls_flow_entry *fe)\n{\n\treturn (fe->data[0] >> MVPP2_CLS_FLOW_TBL0_OFFS) &\n\t\tMVPP2_CLS_FLOW_TBL0_ENG_MASK;\n}\n\nstatic void mvpp2_cls_flow_port_id_sel(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t       bool from_packet)\n{\n\tif (from_packet)\n\t\tfe->data[0] |= MVPP2_CLS_FLOW_TBL0_PORT_ID_SEL;\n\telse\n\t\tfe->data[0] &= ~MVPP2_CLS_FLOW_TBL0_PORT_ID_SEL;\n}\n\nstatic void mvpp2_cls_flow_last_set(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t    bool is_last)\n{\n\tfe->data[0] &= ~MVPP2_CLS_FLOW_TBL0_LAST;\n\tfe->data[0] |= !!is_last;\n}\n\nstatic void mvpp2_cls_flow_pri_set(struct mvpp2_cls_flow_entry *fe, int prio)\n{\n\tfe->data[1] &= ~MVPP2_CLS_FLOW_TBL1_PRIO(MVPP2_CLS_FLOW_TBL1_PRIO_MASK);\n\tfe->data[1] |= MVPP2_CLS_FLOW_TBL1_PRIO(prio);\n}\n\nstatic void mvpp2_cls_flow_port_add(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t    u32 port)\n{\n\tfe->data[0] |= MVPP2_CLS_FLOW_TBL0_PORT_ID(port);\n}\n\nstatic void mvpp2_cls_flow_port_remove(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t       u32 port)\n{\n\tfe->data[0] &= ~MVPP2_CLS_FLOW_TBL0_PORT_ID(port);\n}\n\nstatic void mvpp2_cls_flow_lu_type_set(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t       u8 lu_type)\n{\n\tfe->data[1] &= ~MVPP2_CLS_FLOW_TBL1_LU_TYPE(MVPP2_CLS_LU_TYPE_MASK);\n\tfe->data[1] |= MVPP2_CLS_FLOW_TBL1_LU_TYPE(lu_type);\n}\n\n \nstatic void mvpp2_cls_flow_prs_init(struct mvpp2 *priv,\n\t\t\t\t    const struct mvpp2_cls_flow *flow)\n{\n\tmvpp2_prs_add_flow(priv, flow->flow_id, flow->prs_ri.ri,\n\t\t\t   flow->prs_ri.ri_mask);\n}\n\n \nstatic void mvpp2_cls_flow_lkp_init(struct mvpp2 *priv,\n\t\t\t\t    const struct mvpp2_cls_flow *flow)\n{\n\tstruct mvpp2_cls_lookup_entry le;\n\n\tle.way = 0;\n\tle.lkpid = flow->flow_id;\n\n\t \n\tle.data = 0;\n\n\t \n\tle.data |= MVPP2_CLS_LKP_FLOW_PTR(MVPP2_CLS_FLT_FIRST(flow->flow_id));\n\n\t \n\tle.data |= MVPP2_CLS_LKP_TBL_LOOKUP_EN_MASK;\n\n\tmvpp2_cls_lookup_write(priv, &le);\n}\n\nstatic void mvpp2_cls_c2_write(struct mvpp2 *priv,\n\t\t\t       struct mvpp2_cls_c2_entry *c2)\n{\n\tu32 val;\n\tmvpp2_write(priv, MVPP22_CLS_C2_TCAM_IDX, c2->index);\n\n\tval = mvpp2_read(priv, MVPP22_CLS_C2_TCAM_INV);\n\tif (c2->valid)\n\t\tval &= ~MVPP22_CLS_C2_TCAM_INV_BIT;\n\telse\n\t\tval |= MVPP22_CLS_C2_TCAM_INV_BIT;\n\tmvpp2_write(priv, MVPP22_CLS_C2_TCAM_INV, val);\n\n\tmvpp2_write(priv, MVPP22_CLS_C2_ACT, c2->act);\n\n\tmvpp2_write(priv, MVPP22_CLS_C2_ATTR0, c2->attr[0]);\n\tmvpp2_write(priv, MVPP22_CLS_C2_ATTR1, c2->attr[1]);\n\tmvpp2_write(priv, MVPP22_CLS_C2_ATTR2, c2->attr[2]);\n\tmvpp2_write(priv, MVPP22_CLS_C2_ATTR3, c2->attr[3]);\n\n\tmvpp2_write(priv, MVPP22_CLS_C2_TCAM_DATA0, c2->tcam[0]);\n\tmvpp2_write(priv, MVPP22_CLS_C2_TCAM_DATA1, c2->tcam[1]);\n\tmvpp2_write(priv, MVPP22_CLS_C2_TCAM_DATA2, c2->tcam[2]);\n\tmvpp2_write(priv, MVPP22_CLS_C2_TCAM_DATA3, c2->tcam[3]);\n\t \n\tmvpp2_write(priv, MVPP22_CLS_C2_TCAM_DATA4, c2->tcam[4]);\n}\n\nvoid mvpp2_cls_c2_read(struct mvpp2 *priv, int index,\n\t\t       struct mvpp2_cls_c2_entry *c2)\n{\n\tu32 val;\n\tmvpp2_write(priv, MVPP22_CLS_C2_TCAM_IDX, index);\n\n\tc2->index = index;\n\n\tc2->tcam[0] = mvpp2_read(priv, MVPP22_CLS_C2_TCAM_DATA0);\n\tc2->tcam[1] = mvpp2_read(priv, MVPP22_CLS_C2_TCAM_DATA1);\n\tc2->tcam[2] = mvpp2_read(priv, MVPP22_CLS_C2_TCAM_DATA2);\n\tc2->tcam[3] = mvpp2_read(priv, MVPP22_CLS_C2_TCAM_DATA3);\n\tc2->tcam[4] = mvpp2_read(priv, MVPP22_CLS_C2_TCAM_DATA4);\n\n\tc2->act = mvpp2_read(priv, MVPP22_CLS_C2_ACT);\n\n\tc2->attr[0] = mvpp2_read(priv, MVPP22_CLS_C2_ATTR0);\n\tc2->attr[1] = mvpp2_read(priv, MVPP22_CLS_C2_ATTR1);\n\tc2->attr[2] = mvpp2_read(priv, MVPP22_CLS_C2_ATTR2);\n\tc2->attr[3] = mvpp2_read(priv, MVPP22_CLS_C2_ATTR3);\n\n\tval = mvpp2_read(priv, MVPP22_CLS_C2_TCAM_INV);\n\tc2->valid = !(val & MVPP22_CLS_C2_TCAM_INV_BIT);\n}\n\nstatic int mvpp2_cls_ethtool_flow_to_type(int flow_type)\n{\n\tswitch (flow_type & ~(FLOW_EXT | FLOW_MAC_EXT | FLOW_RSS)) {\n\tcase ETHER_FLOW:\n\t\treturn MVPP22_FLOW_ETHERNET;\n\tcase TCP_V4_FLOW:\n\t\treturn MVPP22_FLOW_TCP4;\n\tcase TCP_V6_FLOW:\n\t\treturn MVPP22_FLOW_TCP6;\n\tcase UDP_V4_FLOW:\n\t\treturn MVPP22_FLOW_UDP4;\n\tcase UDP_V6_FLOW:\n\t\treturn MVPP22_FLOW_UDP6;\n\tcase IPV4_FLOW:\n\t\treturn MVPP22_FLOW_IP4;\n\tcase IPV6_FLOW:\n\t\treturn MVPP22_FLOW_IP6;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int mvpp2_cls_c2_port_flow_index(struct mvpp2_port *port, int loc)\n{\n\treturn MVPP22_CLS_C2_RFS_LOC(port->id, loc);\n}\n\n \nstatic void mvpp2_cls_flow_init(struct mvpp2 *priv,\n\t\t\t\tconst struct mvpp2_cls_flow *flow)\n{\n\tstruct mvpp2_cls_flow_entry fe;\n\tint i, pri = 0;\n\n\t \n\tfor (i = MVPP2_CLS_FLT_FIRST(flow->flow_id);\n\t     i <= MVPP2_CLS_FLT_LAST(flow->flow_id); i++) {\n\t\tmemset(&fe, 0, sizeof(fe));\n\t\tfe.index = i;\n\t\tmvpp2_cls_flow_pri_set(&fe, pri++);\n\n\t\tif (i == MVPP2_CLS_FLT_LAST(flow->flow_id))\n\t\t\tmvpp2_cls_flow_last_set(&fe, 1);\n\n\t\tmvpp2_cls_flow_write(priv, &fe);\n\t}\n\n\t \n\tmvpp2_cls_flow_read(priv, MVPP2_CLS_FLT_C2_RSS_ENTRY(flow->flow_id),\n\t\t\t    &fe);\n\n\tmvpp2_cls_flow_eng_set(&fe, MVPP22_CLS_ENGINE_C2);\n\tmvpp2_cls_flow_port_id_sel(&fe, true);\n\tmvpp2_cls_flow_lu_type_set(&fe, MVPP22_CLS_LU_TYPE_ALL);\n\n\t \n\tfor (i = 0; i < MVPP2_MAX_PORTS; i++)\n\t\tmvpp2_cls_flow_port_add(&fe, BIT(i));\n\n\tmvpp2_cls_flow_write(priv, &fe);\n\n\t \n\tfor (i = 0; i < MVPP2_MAX_PORTS; i++) {\n\t\tmvpp2_cls_flow_read(priv,\n\t\t\t\t    MVPP2_CLS_FLT_HASH_ENTRY(i, flow->flow_id),\n\t\t\t\t    &fe);\n\n\t\t \n\t\tmvpp2_cls_flow_eng_set(&fe, MVPP22_CLS_ENGINE_C3HA);\n\t\tmvpp2_cls_flow_port_id_sel(&fe, true);\n\t\tmvpp2_cls_flow_port_add(&fe, BIT(i));\n\n\t\tmvpp2_cls_flow_write(priv, &fe);\n\t}\n}\n\n \nstatic int mvpp2_flow_add_hek_field(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t    u32 field_id)\n{\n\tint nb_fields = mvpp2_cls_flow_hek_num_get(fe);\n\n\tif (nb_fields == MVPP2_FLOW_N_FIELDS)\n\t\treturn -EINVAL;\n\n\tmvpp2_cls_flow_hek_set(fe, nb_fields, field_id);\n\n\tmvpp2_cls_flow_hek_num_set(fe, nb_fields + 1);\n\n\treturn 0;\n}\n\nstatic int mvpp2_flow_set_hek_fields(struct mvpp2_cls_flow_entry *fe,\n\t\t\t\t     unsigned long hash_opts)\n{\n\tu32 field_id;\n\tint i;\n\n\t \n\tmvpp2_cls_flow_hek_num_set(fe, 0);\n\tfe->data[2] = 0;\n\n\tfor_each_set_bit(i, &hash_opts, MVPP22_CLS_HEK_N_FIELDS) {\n\t\tswitch (BIT(i)) {\n\t\tcase MVPP22_CLS_HEK_OPT_MAC_DA:\n\t\t\tfield_id = MVPP22_CLS_FIELD_MAC_DA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_VLAN:\n\t\t\tfield_id = MVPP22_CLS_FIELD_VLAN;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_VLAN_PRI:\n\t\t\tfield_id = MVPP22_CLS_FIELD_VLAN_PRI;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_IP4SA:\n\t\t\tfield_id = MVPP22_CLS_FIELD_IP4SA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_IP4DA:\n\t\t\tfield_id = MVPP22_CLS_FIELD_IP4DA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_IP6SA:\n\t\t\tfield_id = MVPP22_CLS_FIELD_IP6SA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_IP6DA:\n\t\t\tfield_id = MVPP22_CLS_FIELD_IP6DA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_L4SIP:\n\t\t\tfield_id = MVPP22_CLS_FIELD_L4SIP;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_L4DIP:\n\t\t\tfield_id = MVPP22_CLS_FIELD_L4DIP;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tif (mvpp2_flow_add_hek_field(fe, field_id))\n\t\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int mvpp2_cls_hek_field_size(u32 field)\n{\n\tswitch (field) {\n\tcase MVPP22_CLS_HEK_OPT_MAC_DA:\n\t\treturn 48;\n\tcase MVPP22_CLS_HEK_OPT_VLAN:\n\t\treturn 12;\n\tcase MVPP22_CLS_HEK_OPT_VLAN_PRI:\n\t\treturn 3;\n\tcase MVPP22_CLS_HEK_OPT_IP4SA:\n\tcase MVPP22_CLS_HEK_OPT_IP4DA:\n\t\treturn 32;\n\tcase MVPP22_CLS_HEK_OPT_IP6SA:\n\tcase MVPP22_CLS_HEK_OPT_IP6DA:\n\t\treturn 128;\n\tcase MVPP22_CLS_HEK_OPT_L4SIP:\n\tcase MVPP22_CLS_HEK_OPT_L4DIP:\n\t\treturn 16;\n\tdefault:\n\t\treturn -1;\n\t}\n}\n\nconst struct mvpp2_cls_flow *mvpp2_cls_flow_get(int flow)\n{\n\tif (flow >= MVPP2_N_PRS_FLOWS)\n\t\treturn NULL;\n\n\treturn &cls_flows[flow];\n}\n\n \nstatic int mvpp2_port_rss_hash_opts_set(struct mvpp2_port *port, int flow_type,\n\t\t\t\t\tu16 requested_opts)\n{\n\tconst struct mvpp2_cls_flow *flow;\n\tstruct mvpp2_cls_flow_entry fe;\n\tint i, engine, flow_index;\n\tu16 hash_opts;\n\n\tfor_each_cls_flow_id_with_type(i, flow_type) {\n\t\tflow = mvpp2_cls_flow_get(i);\n\t\tif (!flow)\n\t\t\treturn -EINVAL;\n\n\t\tflow_index = MVPP2_CLS_FLT_HASH_ENTRY(port->id, flow->flow_id);\n\n\t\tmvpp2_cls_flow_read(port->priv, flow_index, &fe);\n\n\t\thash_opts = flow->supported_hash_opts & requested_opts;\n\n\t\t \n\t\tif (hash_opts & MVPP22_CLS_HEK_L4_OPTS)\n\t\t\tengine = MVPP22_CLS_ENGINE_C3HB;\n\t\telse\n\t\t\tengine = MVPP22_CLS_ENGINE_C3HA;\n\n\t\tif (mvpp2_flow_set_hek_fields(&fe, hash_opts))\n\t\t\treturn -EINVAL;\n\n\t\tmvpp2_cls_flow_eng_set(&fe, engine);\n\n\t\tmvpp2_cls_flow_write(port->priv, &fe);\n\t}\n\n\treturn 0;\n}\n\nu16 mvpp2_flow_get_hek_fields(struct mvpp2_cls_flow_entry *fe)\n{\n\tu16 hash_opts = 0;\n\tint n_fields, i, field;\n\n\tn_fields = mvpp2_cls_flow_hek_num_get(fe);\n\n\tfor (i = 0; i < n_fields; i++) {\n\t\tfield = mvpp2_cls_flow_hek_get(fe, i);\n\n\t\tswitch (field) {\n\t\tcase MVPP22_CLS_FIELD_MAC_DA:\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_MAC_DA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_FIELD_VLAN:\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_VLAN;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_FIELD_VLAN_PRI:\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_VLAN_PRI;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_FIELD_L3_PROTO:\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_L3_PROTO;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_FIELD_IP4SA:\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_IP4SA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_FIELD_IP4DA:\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_IP4DA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_FIELD_IP6SA:\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_IP6SA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_FIELD_IP6DA:\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_IP6DA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_FIELD_L4SIP:\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_L4SIP;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_FIELD_L4DIP:\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_L4DIP;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn hash_opts;\n}\n\n \nstatic u16 mvpp2_port_rss_hash_opts_get(struct mvpp2_port *port, int flow_type)\n{\n\tconst struct mvpp2_cls_flow *flow;\n\tstruct mvpp2_cls_flow_entry fe;\n\tint i, flow_index;\n\tu16 hash_opts = 0;\n\n\tfor_each_cls_flow_id_with_type(i, flow_type) {\n\t\tflow = mvpp2_cls_flow_get(i);\n\t\tif (!flow)\n\t\t\treturn 0;\n\n\t\tflow_index = MVPP2_CLS_FLT_HASH_ENTRY(port->id, flow->flow_id);\n\n\t\tmvpp2_cls_flow_read(port->priv, flow_index, &fe);\n\n\t\thash_opts |= mvpp2_flow_get_hek_fields(&fe);\n\t}\n\n\treturn hash_opts;\n}\n\nstatic void mvpp2_cls_port_init_flows(struct mvpp2 *priv)\n{\n\tconst struct mvpp2_cls_flow *flow;\n\tint i;\n\n\tfor (i = 0; i < MVPP2_N_PRS_FLOWS; i++) {\n\t\tflow = mvpp2_cls_flow_get(i);\n\t\tif (!flow)\n\t\t\tbreak;\n\n\t\tmvpp2_cls_flow_prs_init(priv, flow);\n\t\tmvpp2_cls_flow_lkp_init(priv, flow);\n\t\tmvpp2_cls_flow_init(priv, flow);\n\t}\n}\n\nstatic void mvpp2_port_c2_cls_init(struct mvpp2_port *port)\n{\n\tstruct mvpp2_cls_c2_entry c2;\n\tu8 qh, ql, pmap;\n\n\tmemset(&c2, 0, sizeof(c2));\n\n\tc2.index = MVPP22_CLS_C2_RSS_ENTRY(port->id);\n\n\tpmap = BIT(port->id);\n\tc2.tcam[4] = MVPP22_CLS_C2_PORT_ID(pmap);\n\tc2.tcam[4] |= MVPP22_CLS_C2_TCAM_EN(MVPP22_CLS_C2_PORT_ID(pmap));\n\n\t \n\tc2.tcam[4] |= MVPP22_CLS_C2_TCAM_EN(MVPP22_CLS_C2_LU_TYPE(MVPP2_CLS_LU_TYPE_MASK));\n\tc2.tcam[4] |= MVPP22_CLS_C2_LU_TYPE(MVPP22_CLS_LU_TYPE_ALL);\n\n\t \n\tc2.act = MVPP22_CLS_C2_ACT_RSS_EN(MVPP22_C2_UPD_LOCK);\n\n\t \n\tc2.act |= MVPP22_CLS_C2_ACT_FWD(MVPP22_C2_FWD_SW_LOCK);\n\n\t \n\tc2.act |= MVPP22_CLS_C2_ACT_QHIGH(MVPP22_C2_UPD) |\n\t\t   MVPP22_CLS_C2_ACT_QLOW(MVPP22_C2_UPD);\n\n\tqh = (port->first_rxq >> 3) & MVPP22_CLS_C2_ATTR0_QHIGH_MASK;\n\tql = port->first_rxq & MVPP22_CLS_C2_ATTR0_QLOW_MASK;\n\n\tc2.attr[0] = MVPP22_CLS_C2_ATTR0_QHIGH(qh) |\n\t\t      MVPP22_CLS_C2_ATTR0_QLOW(ql);\n\n\tc2.valid = true;\n\n\tmvpp2_cls_c2_write(port->priv, &c2);\n}\n\n \nvoid mvpp2_cls_init(struct mvpp2 *priv)\n{\n\tstruct mvpp2_cls_lookup_entry le;\n\tstruct mvpp2_cls_flow_entry fe;\n\tstruct mvpp2_cls_c2_entry c2;\n\tint index;\n\n\t \n\tmvpp2_write(priv, MVPP2_CLS_MODE_REG, MVPP2_CLS_MODE_ACTIVE_MASK);\n\n\t \n\tmemset(&fe.data, 0, sizeof(fe.data));\n\tfor (index = 0; index < MVPP2_CLS_FLOWS_TBL_SIZE; index++) {\n\t\tfe.index = index;\n\t\tmvpp2_cls_flow_write(priv, &fe);\n\t}\n\n\t \n\tle.data = 0;\n\tfor (index = 0; index < MVPP2_CLS_LKP_TBL_SIZE; index++) {\n\t\tle.lkpid = index;\n\t\tle.way = 0;\n\t\tmvpp2_cls_lookup_write(priv, &le);\n\n\t\tle.way = 1;\n\t\tmvpp2_cls_lookup_write(priv, &le);\n\t}\n\n\t \n\tmemset(&c2, 0, sizeof(c2));\n\tc2.valid = false;\n\tfor (index = 0; index < MVPP22_CLS_C2_N_ENTRIES; index++) {\n\t\tc2.index = index;\n\t\tmvpp2_cls_c2_write(priv, &c2);\n\t}\n\n\t \n\tmvpp2_write(priv, MVPP22_CLS_C2_TCAM_CTRL,\n\t\t    MVPP22_CLS_C2_TCAM_BYPASS_FIFO);\n\n\tmvpp2_cls_port_init_flows(priv);\n}\n\nvoid mvpp2_cls_port_config(struct mvpp2_port *port)\n{\n\tstruct mvpp2_cls_lookup_entry le;\n\tu32 val;\n\n\t \n\tval = mvpp2_read(port->priv, MVPP2_CLS_PORT_WAY_REG);\n\tval &= ~MVPP2_CLS_PORT_WAY_MASK(port->id);\n\tmvpp2_write(port->priv, MVPP2_CLS_PORT_WAY_REG, val);\n\n\t \n\tle.lkpid = port->id;\n\tle.way = 0;\n\tle.data = 0;\n\n\t \n\tle.data &= ~MVPP2_CLS_LKP_TBL_RXQ_MASK;\n\tle.data |= port->first_rxq;\n\n\t \n\tle.data &= ~MVPP2_CLS_LKP_TBL_LOOKUP_EN_MASK;\n\n\t \n\tmvpp2_cls_lookup_write(port->priv, &le);\n\n\tmvpp2_port_c2_cls_init(port);\n}\n\nu32 mvpp2_cls_c2_hit_count(struct mvpp2 *priv, int c2_index)\n{\n\tmvpp2_write(priv, MVPP22_CLS_C2_TCAM_IDX, c2_index);\n\n\treturn mvpp2_read(priv, MVPP22_CLS_C2_HIT_CTR);\n}\n\nstatic void mvpp2_rss_port_c2_enable(struct mvpp2_port *port, u32 ctx)\n{\n\tstruct mvpp2_cls_c2_entry c2;\n\tu8 qh, ql;\n\n\tmvpp2_cls_c2_read(port->priv, MVPP22_CLS_C2_RSS_ENTRY(port->id), &c2);\n\n\t \n\tqh = (ctx >> 3) & MVPP22_CLS_C2_ATTR0_QHIGH_MASK;\n\tql = ctx & MVPP22_CLS_C2_ATTR0_QLOW_MASK;\n\n\tc2.attr[0] = MVPP22_CLS_C2_ATTR0_QHIGH(qh) |\n\t\t     MVPP22_CLS_C2_ATTR0_QLOW(ql);\n\n\tc2.attr[2] |= MVPP22_CLS_C2_ATTR2_RSS_EN;\n\n\tmvpp2_cls_c2_write(port->priv, &c2);\n}\n\nstatic void mvpp2_rss_port_c2_disable(struct mvpp2_port *port)\n{\n\tstruct mvpp2_cls_c2_entry c2;\n\tu8 qh, ql;\n\n\tmvpp2_cls_c2_read(port->priv, MVPP22_CLS_C2_RSS_ENTRY(port->id), &c2);\n\n\t \n\tqh = (port->first_rxq >> 3) & MVPP22_CLS_C2_ATTR0_QHIGH_MASK;\n\tql = port->first_rxq & MVPP22_CLS_C2_ATTR0_QLOW_MASK;\n\n\tc2.attr[0] = MVPP22_CLS_C2_ATTR0_QHIGH(qh) |\n\t\t      MVPP22_CLS_C2_ATTR0_QLOW(ql);\n\n\tc2.attr[2] &= ~MVPP22_CLS_C2_ATTR2_RSS_EN;\n\n\tmvpp2_cls_c2_write(port->priv, &c2);\n}\n\nstatic inline int mvpp22_rss_ctx(struct mvpp2_port *port, int port_rss_ctx)\n{\n\treturn port->rss_ctx[port_rss_ctx];\n}\n\nint mvpp22_port_rss_enable(struct mvpp2_port *port)\n{\n\tif (mvpp22_rss_ctx(port, 0) < 0)\n\t\treturn -EINVAL;\n\n\tmvpp2_rss_port_c2_enable(port, mvpp22_rss_ctx(port, 0));\n\n\treturn 0;\n}\n\nint mvpp22_port_rss_disable(struct mvpp2_port *port)\n{\n\tif (mvpp22_rss_ctx(port, 0) < 0)\n\t\treturn -EINVAL;\n\n\tmvpp2_rss_port_c2_disable(port);\n\n\treturn 0;\n}\n\nstatic void mvpp22_port_c2_lookup_disable(struct mvpp2_port *port, int entry)\n{\n\tstruct mvpp2_cls_c2_entry c2;\n\n\tmvpp2_cls_c2_read(port->priv, entry, &c2);\n\n\t \n\tc2.tcam[4] &= ~(MVPP22_CLS_C2_PORT_ID(BIT(port->id)));\n\n\tmvpp2_cls_c2_write(port->priv, &c2);\n}\n\n \nvoid mvpp2_cls_oversize_rxq_set(struct mvpp2_port *port)\n{\n\tu32 val;\n\n\tmvpp2_write(port->priv, MVPP2_CLS_OVERSIZE_RXQ_LOW_REG(port->id),\n\t\t    port->first_rxq & MVPP2_CLS_OVERSIZE_RXQ_LOW_MASK);\n\n\tmvpp2_write(port->priv, MVPP2_CLS_SWFWD_P2HQ_REG(port->id),\n\t\t    (port->first_rxq >> MVPP2_CLS_OVERSIZE_RXQ_LOW_BITS));\n\n\tval = mvpp2_read(port->priv, MVPP2_CLS_SWFWD_PCTRL_REG);\n\tval &= ~MVPP2_CLS_SWFWD_PCTRL_MASK(port->id);\n\tmvpp2_write(port->priv, MVPP2_CLS_SWFWD_PCTRL_REG, val);\n}\n\nstatic int mvpp2_port_c2_tcam_rule_add(struct mvpp2_port *port,\n\t\t\t\t       struct mvpp2_rfs_rule *rule)\n{\n\tstruct flow_action_entry *act;\n\tstruct mvpp2_cls_c2_entry c2;\n\tu8 qh, ql, pmap;\n\tint index, ctx;\n\n\tif (!flow_action_basic_hw_stats_check(&rule->flow->action, NULL))\n\t\treturn -EOPNOTSUPP;\n\n\tmemset(&c2, 0, sizeof(c2));\n\n\tindex = mvpp2_cls_c2_port_flow_index(port, rule->loc);\n\tif (index < 0)\n\t\treturn -EINVAL;\n\tc2.index = index;\n\n\tact = &rule->flow->action.entries[0];\n\n\trule->c2_index = c2.index;\n\n\tc2.tcam[3] = (rule->c2_tcam & 0xffff) |\n\t\t     ((rule->c2_tcam_mask & 0xffff) << 16);\n\tc2.tcam[2] = ((rule->c2_tcam >> 16) & 0xffff) |\n\t\t     (((rule->c2_tcam_mask >> 16) & 0xffff) << 16);\n\tc2.tcam[1] = ((rule->c2_tcam >> 32) & 0xffff) |\n\t\t     (((rule->c2_tcam_mask >> 32) & 0xffff) << 16);\n\tc2.tcam[0] = ((rule->c2_tcam >> 48) & 0xffff) |\n\t\t     (((rule->c2_tcam_mask >> 48) & 0xffff) << 16);\n\n\tpmap = BIT(port->id);\n\tc2.tcam[4] = MVPP22_CLS_C2_PORT_ID(pmap);\n\tc2.tcam[4] |= MVPP22_CLS_C2_TCAM_EN(MVPP22_CLS_C2_PORT_ID(pmap));\n\n\t \n\tc2.tcam[4] |= MVPP22_CLS_C2_TCAM_EN(MVPP22_CLS_C2_LU_TYPE(MVPP2_CLS_LU_TYPE_MASK));\n\tc2.tcam[4] |= MVPP22_CLS_C2_LU_TYPE(rule->loc);\n\n\tif (act->id == FLOW_ACTION_DROP) {\n\t\tc2.act = MVPP22_CLS_C2_ACT_COLOR(MVPP22_C2_COL_RED_LOCK);\n\t} else {\n\t\t \n\t\tc2.act = MVPP22_CLS_C2_ACT_COLOR(MVPP22_C2_COL_NO_UPD_LOCK);\n\n\t\t \n\t\tif (act->queue.ctx)\n\t\t\tc2.attr[2] |= MVPP22_CLS_C2_ATTR2_RSS_EN;\n\n\t\t \n\t\tc2.act = MVPP22_CLS_C2_ACT_RSS_EN(MVPP22_C2_UPD_LOCK);\n\n\t\t \n\t\tc2.act |= MVPP22_CLS_C2_ACT_FWD(MVPP22_C2_FWD_SW_LOCK);\n\n\t\tc2.act |= MVPP22_CLS_C2_ACT_QHIGH(MVPP22_C2_UPD_LOCK) |\n\t\t\t   MVPP22_CLS_C2_ACT_QLOW(MVPP22_C2_UPD_LOCK);\n\n\t\tif (act->queue.ctx) {\n\t\t\t \n\t\t\tctx = mvpp22_rss_ctx(port, act->queue.ctx);\n\t\t\tif (ctx < 0)\n\t\t\t\treturn -EINVAL;\n\n\t\t\tqh = (ctx >> 3) & MVPP22_CLS_C2_ATTR0_QHIGH_MASK;\n\t\t\tql = ctx & MVPP22_CLS_C2_ATTR0_QLOW_MASK;\n\t\t} else {\n\t\t\tqh = ((act->queue.index + port->first_rxq) >> 3) &\n\t\t\t      MVPP22_CLS_C2_ATTR0_QHIGH_MASK;\n\t\t\tql = (act->queue.index + port->first_rxq) &\n\t\t\t      MVPP22_CLS_C2_ATTR0_QLOW_MASK;\n\t\t}\n\n\t\tc2.attr[0] = MVPP22_CLS_C2_ATTR0_QHIGH(qh) |\n\t\t\t      MVPP22_CLS_C2_ATTR0_QLOW(ql);\n\t}\n\n\tc2.valid = true;\n\n\tmvpp2_cls_c2_write(port->priv, &c2);\n\n\treturn 0;\n}\n\nstatic int mvpp2_port_c2_rfs_rule_insert(struct mvpp2_port *port,\n\t\t\t\t\t struct mvpp2_rfs_rule *rule)\n{\n\treturn mvpp2_port_c2_tcam_rule_add(port, rule);\n}\n\nstatic int mvpp2_port_cls_rfs_rule_remove(struct mvpp2_port *port,\n\t\t\t\t\t  struct mvpp2_rfs_rule *rule)\n{\n\tconst struct mvpp2_cls_flow *flow;\n\tstruct mvpp2_cls_flow_entry fe;\n\tint index, i;\n\n\tfor_each_cls_flow_id_containing_type(i, rule->flow_type) {\n\t\tflow = mvpp2_cls_flow_get(i);\n\t\tif (!flow)\n\t\t\treturn 0;\n\n\t\tindex = MVPP2_CLS_FLT_C2_RFS(port->id, flow->flow_id, rule->loc);\n\n\t\tmvpp2_cls_flow_read(port->priv, index, &fe);\n\t\tmvpp2_cls_flow_port_remove(&fe, BIT(port->id));\n\t\tmvpp2_cls_flow_write(port->priv, &fe);\n\t}\n\n\tif (rule->c2_index >= 0)\n\t\tmvpp22_port_c2_lookup_disable(port, rule->c2_index);\n\n\treturn 0;\n}\n\nstatic int mvpp2_port_flt_rfs_rule_insert(struct mvpp2_port *port,\n\t\t\t\t\t  struct mvpp2_rfs_rule *rule)\n{\n\tconst struct mvpp2_cls_flow *flow;\n\tstruct mvpp2 *priv = port->priv;\n\tstruct mvpp2_cls_flow_entry fe;\n\tint index, ret, i;\n\n\tif (rule->engine != MVPP22_CLS_ENGINE_C2)\n\t\treturn -EOPNOTSUPP;\n\n\tret = mvpp2_port_c2_rfs_rule_insert(port, rule);\n\tif (ret)\n\t\treturn ret;\n\n\tfor_each_cls_flow_id_containing_type(i, rule->flow_type) {\n\t\tflow = mvpp2_cls_flow_get(i);\n\t\tif (!flow)\n\t\t\treturn 0;\n\n\t\tif ((rule->hek_fields & flow->supported_hash_opts) != rule->hek_fields)\n\t\t\tcontinue;\n\n\t\tindex = MVPP2_CLS_FLT_C2_RFS(port->id, flow->flow_id, rule->loc);\n\n\t\tmvpp2_cls_flow_read(priv, index, &fe);\n\t\tmvpp2_cls_flow_eng_set(&fe, rule->engine);\n\t\tmvpp2_cls_flow_port_id_sel(&fe, true);\n\t\tmvpp2_flow_set_hek_fields(&fe, rule->hek_fields);\n\t\tmvpp2_cls_flow_lu_type_set(&fe, rule->loc);\n\t\tmvpp2_cls_flow_port_add(&fe, 0xf);\n\n\t\tmvpp2_cls_flow_write(priv, &fe);\n\t}\n\n\treturn 0;\n}\n\nstatic int mvpp2_cls_c2_build_match(struct mvpp2_rfs_rule *rule)\n{\n\tstruct flow_rule *flow = rule->flow;\n\tint offs = 0;\n\n\t \n\tif (flow_rule_match_key(flow, FLOW_DISSECTOR_KEY_VLAN)) {\n\t\tstruct flow_match_vlan match;\n\n\t\tflow_rule_match_vlan(flow, &match);\n\t\tif (match.mask->vlan_id) {\n\t\t\trule->hek_fields |= MVPP22_CLS_HEK_OPT_VLAN;\n\n\t\t\trule->c2_tcam |= ((u64)match.key->vlan_id) << offs;\n\t\t\trule->c2_tcam_mask |= ((u64)match.mask->vlan_id) << offs;\n\n\t\t\t \n\t\t}\n\n\t\tif (match.mask->vlan_priority) {\n\t\t\trule->hek_fields |= MVPP22_CLS_HEK_OPT_VLAN_PRI;\n\n\t\t\t \n\t\t\trule->c2_tcam |= ((u64)match.key->vlan_priority) <<\n\t\t\t\t(offs + 13);\n\t\t\trule->c2_tcam_mask |= ((u64)match.mask->vlan_priority) <<\n\t\t\t\t(offs + 13);\n\t\t}\n\n\t\tif (match.mask->vlan_dei)\n\t\t\treturn -EOPNOTSUPP;\n\n\t\t \n\t\toffs += 16;\n\t}\n\n\tif (flow_rule_match_key(flow, FLOW_DISSECTOR_KEY_PORTS)) {\n\t\tstruct flow_match_ports match;\n\n\t\tflow_rule_match_ports(flow, &match);\n\t\tif (match.mask->src) {\n\t\t\trule->hek_fields |= MVPP22_CLS_HEK_OPT_L4SIP;\n\n\t\t\trule->c2_tcam |= ((u64)ntohs(match.key->src)) << offs;\n\t\t\trule->c2_tcam_mask |= ((u64)ntohs(match.mask->src)) << offs;\n\t\t\toffs += mvpp2_cls_hek_field_size(MVPP22_CLS_HEK_OPT_L4SIP);\n\t\t}\n\n\t\tif (match.mask->dst) {\n\t\t\trule->hek_fields |= MVPP22_CLS_HEK_OPT_L4DIP;\n\n\t\t\trule->c2_tcam |= ((u64)ntohs(match.key->dst)) << offs;\n\t\t\trule->c2_tcam_mask |= ((u64)ntohs(match.mask->dst)) << offs;\n\t\t\toffs += mvpp2_cls_hek_field_size(MVPP22_CLS_HEK_OPT_L4DIP);\n\t\t}\n\t}\n\n\tif (hweight16(rule->hek_fields) > MVPP2_FLOW_N_FIELDS)\n\t\treturn -EOPNOTSUPP;\n\n\treturn 0;\n}\n\nstatic int mvpp2_cls_rfs_parse_rule(struct mvpp2_rfs_rule *rule)\n{\n\tstruct flow_rule *flow = rule->flow;\n\tstruct flow_action_entry *act;\n\n\tif (!flow_action_basic_hw_stats_check(&rule->flow->action, NULL))\n\t\treturn -EOPNOTSUPP;\n\n\tact = &flow->action.entries[0];\n\tif (act->id != FLOW_ACTION_QUEUE && act->id != FLOW_ACTION_DROP)\n\t\treturn -EOPNOTSUPP;\n\n\t \n\tif (act->queue.ctx && act->queue.index)\n\t\treturn -EOPNOTSUPP;\n\n\t \n\trule->engine = MVPP22_CLS_ENGINE_C2;\n\n\tif (mvpp2_cls_c2_build_match(rule))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nint mvpp2_ethtool_cls_rule_get(struct mvpp2_port *port,\n\t\t\t       struct ethtool_rxnfc *rxnfc)\n{\n\tstruct mvpp2_ethtool_fs *efs;\n\n\tif (rxnfc->fs.location >= MVPP2_N_RFS_ENTRIES_PER_FLOW)\n\t\treturn -EINVAL;\n\n\tefs = port->rfs_rules[rxnfc->fs.location];\n\tif (!efs)\n\t\treturn -ENOENT;\n\n\tmemcpy(rxnfc, &efs->rxnfc, sizeof(efs->rxnfc));\n\n\treturn 0;\n}\n\nint mvpp2_ethtool_cls_rule_ins(struct mvpp2_port *port,\n\t\t\t       struct ethtool_rxnfc *info)\n{\n\tstruct ethtool_rx_flow_spec_input input = {};\n\tstruct ethtool_rx_flow_rule *ethtool_rule;\n\tstruct mvpp2_ethtool_fs *efs, *old_efs;\n\tint ret = 0;\n\n\tif (info->fs.location >= MVPP2_N_RFS_ENTRIES_PER_FLOW)\n\t\treturn -EINVAL;\n\n\tefs = kzalloc(sizeof(*efs), GFP_KERNEL);\n\tif (!efs)\n\t\treturn -ENOMEM;\n\n\tinput.fs = &info->fs;\n\n\t \n\tif (info->fs.flow_type & FLOW_RSS)\n\t\tinput.rss_ctx = info->rss_context;\n\n\tethtool_rule = ethtool_rx_flow_rule_create(&input);\n\tif (IS_ERR(ethtool_rule)) {\n\t\tret = PTR_ERR(ethtool_rule);\n\t\tgoto clean_rule;\n\t}\n\n\tefs->rule.flow = ethtool_rule->rule;\n\tefs->rule.flow_type = mvpp2_cls_ethtool_flow_to_type(info->fs.flow_type);\n\tif (efs->rule.flow_type < 0) {\n\t\tret = efs->rule.flow_type;\n\t\tgoto clean_rule;\n\t}\n\n\tret = mvpp2_cls_rfs_parse_rule(&efs->rule);\n\tif (ret)\n\t\tgoto clean_eth_rule;\n\n\tefs->rule.loc = info->fs.location;\n\n\t \n\tif (port->rfs_rules[efs->rule.loc]) {\n\t\told_efs = port->rfs_rules[efs->rule.loc];\n\t\tret = mvpp2_port_cls_rfs_rule_remove(port, &old_efs->rule);\n\t\tif (ret)\n\t\t\tgoto clean_eth_rule;\n\t\tkfree(old_efs);\n\t\tport->n_rfs_rules--;\n\t}\n\n\tret = mvpp2_port_flt_rfs_rule_insert(port, &efs->rule);\n\tif (ret)\n\t\tgoto clean_eth_rule;\n\n\tethtool_rx_flow_rule_destroy(ethtool_rule);\n\tefs->rule.flow = NULL;\n\n\tmemcpy(&efs->rxnfc, info, sizeof(*info));\n\tport->rfs_rules[efs->rule.loc] = efs;\n\tport->n_rfs_rules++;\n\n\treturn ret;\n\nclean_eth_rule:\n\tethtool_rx_flow_rule_destroy(ethtool_rule);\nclean_rule:\n\tkfree(efs);\n\treturn ret;\n}\n\nint mvpp2_ethtool_cls_rule_del(struct mvpp2_port *port,\n\t\t\t       struct ethtool_rxnfc *info)\n{\n\tstruct mvpp2_ethtool_fs *efs;\n\tint ret;\n\n\tif (info->fs.location >= MVPP2_N_RFS_ENTRIES_PER_FLOW)\n\t\treturn -EINVAL;\n\n\tefs = port->rfs_rules[info->fs.location];\n\tif (!efs)\n\t\treturn -EINVAL;\n\n\t \n\tret = mvpp2_port_cls_rfs_rule_remove(port, &efs->rule);\n\tif (ret)\n\t\treturn ret;\n\n\tport->n_rfs_rules--;\n\tport->rfs_rules[info->fs.location] = NULL;\n\tkfree(efs);\n\n\treturn 0;\n}\n\nstatic inline u32 mvpp22_rxfh_indir(struct mvpp2_port *port, u32 rxq)\n{\n\tint nrxqs, cpu, cpus = num_possible_cpus();\n\n\t \n\tnrxqs = port->nrxqs / cpus;\n\n\t \n\tcpu = rxq / nrxqs;\n\n\tif (!cpu_online(cpu))\n\t\treturn port->first_rxq;\n\n\t \n\treturn port->first_rxq + ((rxq * nrxqs + rxq / cpus) % port->nrxqs);\n}\n\nstatic void mvpp22_rss_fill_table(struct mvpp2_port *port,\n\t\t\t\t  struct mvpp2_rss_table *table,\n\t\t\t\t  u32 rss_ctx)\n{\n\tstruct mvpp2 *priv = port->priv;\n\tint i;\n\n\tfor (i = 0; i < MVPP22_RSS_TABLE_ENTRIES; i++) {\n\t\tu32 sel = MVPP22_RSS_INDEX_TABLE(rss_ctx) |\n\t\t\t  MVPP22_RSS_INDEX_TABLE_ENTRY(i);\n\t\tmvpp2_write(priv, MVPP22_RSS_INDEX, sel);\n\n\t\tmvpp2_write(priv, MVPP22_RSS_TABLE_ENTRY,\n\t\t\t    mvpp22_rxfh_indir(port, table->indir[i]));\n\t}\n}\n\nstatic int mvpp22_rss_context_create(struct mvpp2_port *port, u32 *rss_ctx)\n{\n\tstruct mvpp2 *priv = port->priv;\n\tu32 ctx;\n\n\t \n\tfor (ctx = 0; ctx < MVPP22_N_RSS_TABLES; ctx++) {\n\t\tif (!priv->rss_tables[ctx])\n\t\t\tbreak;\n\t}\n\n\tif (ctx == MVPP22_N_RSS_TABLES)\n\t\treturn -EINVAL;\n\n\tpriv->rss_tables[ctx] = kzalloc(sizeof(*priv->rss_tables[ctx]),\n\t\t\t\t\tGFP_KERNEL);\n\tif (!priv->rss_tables[ctx])\n\t\treturn -ENOMEM;\n\n\t*rss_ctx = ctx;\n\n\t \n\tmvpp2_write(priv, MVPP22_RSS_INDEX, MVPP22_RSS_INDEX_TABLE(ctx));\n\tmvpp2_write(priv, MVPP22_RSS_WIDTH, 8);\n\n\tmvpp2_write(priv, MVPP22_RSS_INDEX, MVPP22_RSS_INDEX_QUEUE(ctx));\n\tmvpp2_write(priv, MVPP22_RXQ2RSS_TABLE, MVPP22_RSS_TABLE_POINTER(ctx));\n\n\treturn 0;\n}\n\nint mvpp22_port_rss_ctx_create(struct mvpp2_port *port, u32 *port_ctx)\n{\n\tu32 rss_ctx;\n\tint ret, i;\n\n\tret = mvpp22_rss_context_create(port, &rss_ctx);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tfor (i = 1; i < MVPP22_N_RSS_TABLES; i++) {\n\t\tif (port->rss_ctx[i] < 0)\n\t\t\tbreak;\n\t}\n\n\tif (i == MVPP22_N_RSS_TABLES)\n\t\treturn -EINVAL;\n\n\tport->rss_ctx[i] = rss_ctx;\n\t*port_ctx = i;\n\n\treturn 0;\n}\n\nstatic struct mvpp2_rss_table *mvpp22_rss_table_get(struct mvpp2 *priv,\n\t\t\t\t\t\t    int rss_ctx)\n{\n\tif (rss_ctx < 0 || rss_ctx >= MVPP22_N_RSS_TABLES)\n\t\treturn NULL;\n\n\treturn priv->rss_tables[rss_ctx];\n}\n\nint mvpp22_port_rss_ctx_delete(struct mvpp2_port *port, u32 port_ctx)\n{\n\tstruct mvpp2 *priv = port->priv;\n\tstruct ethtool_rxnfc *rxnfc;\n\tint i, rss_ctx, ret;\n\n\trss_ctx = mvpp22_rss_ctx(port, port_ctx);\n\n\tif (rss_ctx < 0 || rss_ctx >= MVPP22_N_RSS_TABLES)\n\t\treturn -EINVAL;\n\n\t \n\tfor (i = 0; i < MVPP2_N_RFS_ENTRIES_PER_FLOW; i++) {\n\t\tif (!port->rfs_rules[i])\n\t\t\tcontinue;\n\n\t\trxnfc = &port->rfs_rules[i]->rxnfc;\n\t\tif (!(rxnfc->fs.flow_type & FLOW_RSS) ||\n\t\t    rxnfc->rss_context != port_ctx)\n\t\t\tcontinue;\n\n\t\tret = mvpp2_ethtool_cls_rule_del(port, rxnfc);\n\t\tif (ret) {\n\t\t\tnetdev_warn(port->dev,\n\t\t\t\t    \"couldn't remove classification rule %d associated to this context\",\n\t\t\t\t    rxnfc->fs.location);\n\t\t}\n\t}\n\n\tkfree(priv->rss_tables[rss_ctx]);\n\n\tpriv->rss_tables[rss_ctx] = NULL;\n\tport->rss_ctx[port_ctx] = -1;\n\n\treturn 0;\n}\n\nint mvpp22_port_rss_ctx_indir_set(struct mvpp2_port *port, u32 port_ctx,\n\t\t\t\t  const u32 *indir)\n{\n\tint rss_ctx = mvpp22_rss_ctx(port, port_ctx);\n\tstruct mvpp2_rss_table *rss_table = mvpp22_rss_table_get(port->priv,\n\t\t\t\t\t\t\t\t rss_ctx);\n\n\tif (!rss_table)\n\t\treturn -EINVAL;\n\n\tmemcpy(rss_table->indir, indir,\n\t       MVPP22_RSS_TABLE_ENTRIES * sizeof(rss_table->indir[0]));\n\n\tmvpp22_rss_fill_table(port, rss_table, rss_ctx);\n\n\treturn 0;\n}\n\nint mvpp22_port_rss_ctx_indir_get(struct mvpp2_port *port, u32 port_ctx,\n\t\t\t\t  u32 *indir)\n{\n\tint rss_ctx =  mvpp22_rss_ctx(port, port_ctx);\n\tstruct mvpp2_rss_table *rss_table = mvpp22_rss_table_get(port->priv,\n\t\t\t\t\t\t\t\t rss_ctx);\n\n\tif (!rss_table)\n\t\treturn -EINVAL;\n\n\tmemcpy(indir, rss_table->indir,\n\t       MVPP22_RSS_TABLE_ENTRIES * sizeof(rss_table->indir[0]));\n\n\treturn 0;\n}\n\nint mvpp2_ethtool_rxfh_set(struct mvpp2_port *port, struct ethtool_rxnfc *info)\n{\n\tu16 hash_opts = 0;\n\tu32 flow_type;\n\n\tflow_type = mvpp2_cls_ethtool_flow_to_type(info->flow_type);\n\n\tswitch (flow_type) {\n\tcase MVPP22_FLOW_TCP4:\n\tcase MVPP22_FLOW_UDP4:\n\tcase MVPP22_FLOW_TCP6:\n\tcase MVPP22_FLOW_UDP6:\n\t\tif (info->data & RXH_L4_B_0_1)\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_L4SIP;\n\t\tif (info->data & RXH_L4_B_2_3)\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_L4DIP;\n\t\tfallthrough;\n\tcase MVPP22_FLOW_IP4:\n\tcase MVPP22_FLOW_IP6:\n\t\tif (info->data & RXH_L2DA)\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_MAC_DA;\n\t\tif (info->data & RXH_VLAN)\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_VLAN;\n\t\tif (info->data & RXH_L3_PROTO)\n\t\t\thash_opts |= MVPP22_CLS_HEK_OPT_L3_PROTO;\n\t\tif (info->data & RXH_IP_SRC)\n\t\t\thash_opts |= (MVPP22_CLS_HEK_OPT_IP4SA |\n\t\t\t\t     MVPP22_CLS_HEK_OPT_IP6SA);\n\t\tif (info->data & RXH_IP_DST)\n\t\t\thash_opts |= (MVPP22_CLS_HEK_OPT_IP4DA |\n\t\t\t\t     MVPP22_CLS_HEK_OPT_IP6DA);\n\t\tbreak;\n\tdefault: return -EOPNOTSUPP;\n\t}\n\n\treturn mvpp2_port_rss_hash_opts_set(port, flow_type, hash_opts);\n}\n\nint mvpp2_ethtool_rxfh_get(struct mvpp2_port *port, struct ethtool_rxnfc *info)\n{\n\tunsigned long hash_opts;\n\tu32 flow_type;\n\tint i;\n\n\tflow_type = mvpp2_cls_ethtool_flow_to_type(info->flow_type);\n\n\thash_opts = mvpp2_port_rss_hash_opts_get(port, flow_type);\n\tinfo->data = 0;\n\n\tfor_each_set_bit(i, &hash_opts, MVPP22_CLS_HEK_N_FIELDS) {\n\t\tswitch (BIT(i)) {\n\t\tcase MVPP22_CLS_HEK_OPT_MAC_DA:\n\t\t\tinfo->data |= RXH_L2DA;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_VLAN:\n\t\t\tinfo->data |= RXH_VLAN;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_L3_PROTO:\n\t\t\tinfo->data |= RXH_L3_PROTO;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_IP4SA:\n\t\tcase MVPP22_CLS_HEK_OPT_IP6SA:\n\t\t\tinfo->data |= RXH_IP_SRC;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_IP4DA:\n\t\tcase MVPP22_CLS_HEK_OPT_IP6DA:\n\t\t\tinfo->data |= RXH_IP_DST;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_L4SIP:\n\t\t\tinfo->data |= RXH_L4_B_0_1;\n\t\t\tbreak;\n\t\tcase MVPP22_CLS_HEK_OPT_L4DIP:\n\t\t\tinfo->data |= RXH_L4_B_2_3;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\treturn 0;\n}\n\nint mvpp22_port_rss_init(struct mvpp2_port *port)\n{\n\tstruct mvpp2_rss_table *table;\n\tu32 context = 0;\n\tint i, ret;\n\n\tfor (i = 0; i < MVPP22_N_RSS_TABLES; i++)\n\t\tport->rss_ctx[i] = -1;\n\n\tret = mvpp22_rss_context_create(port, &context);\n\tif (ret)\n\t\treturn ret;\n\n\ttable = mvpp22_rss_table_get(port->priv, context);\n\tif (!table)\n\t\treturn -EINVAL;\n\n\tport->rss_ctx[0] = context;\n\n\t \n\tfor (i = 0; i < MVPP22_RSS_TABLE_ENTRIES; i++)\n\t\ttable->indir[i] = ethtool_rxfh_indir_default(i, port->nrxqs);\n\n\tmvpp22_rss_fill_table(port, table, mvpp22_rss_ctx(port, 0));\n\n\t \n\tmvpp2_port_rss_hash_opts_set(port, MVPP22_FLOW_IP4, MVPP22_CLS_HEK_IP4_2T);\n\tmvpp2_port_rss_hash_opts_set(port, MVPP22_FLOW_IP6, MVPP22_CLS_HEK_IP6_2T);\n\tmvpp2_port_rss_hash_opts_set(port, MVPP22_FLOW_TCP4, MVPP22_CLS_HEK_IP4_5T);\n\tmvpp2_port_rss_hash_opts_set(port, MVPP22_FLOW_TCP6, MVPP22_CLS_HEK_IP6_5T);\n\tmvpp2_port_rss_hash_opts_set(port, MVPP22_FLOW_UDP4, MVPP22_CLS_HEK_IP4_5T);\n\tmvpp2_port_rss_hash_opts_set(port, MVPP22_FLOW_UDP6, MVPP22_CLS_HEK_IP6_5T);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}