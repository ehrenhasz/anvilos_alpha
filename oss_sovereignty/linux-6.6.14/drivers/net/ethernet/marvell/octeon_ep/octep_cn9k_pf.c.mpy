{
  "module_name": "octep_cn9k_pf.c",
  "hash_id": "7f84c26ceed137315ec85ecdabc77136143bcd6d284b888e2206d7c9a113ae64",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/marvell/octeon_ep/octep_cn9k_pf.c",
  "human_readable_source": "\n \n\n#include <linux/pci.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n\n#include \"octep_config.h\"\n#include \"octep_main.h\"\n#include \"octep_regs_cn9k_pf.h\"\n\n#define CTRL_MBOX_MAX_PF\t128\n#define CTRL_MBOX_SZ\t\t((size_t)(0x400000 / CTRL_MBOX_MAX_PF))\n\n#define FW_HB_INTERVAL_IN_SECS\t\t1\n#define FW_HB_MISS_COUNT\t\t10\n\n \nstatic char *cn93_non_ioq_msix_names[] = {\n\t\"epf_ire_rint\",\n\t\"epf_ore_rint\",\n\t\"epf_vfire_rint0\",\n\t\"epf_vfire_rint1\",\n\t\"epf_vfore_rint0\",\n\t\"epf_vfore_rint1\",\n\t\"epf_mbox_rint0\",\n\t\"epf_mbox_rint1\",\n\t\"epf_oei_rint\",\n\t\"epf_dma_rint\",\n\t\"epf_dma_vf_rint0\",\n\t\"epf_dma_vf_rint1\",\n\t\"epf_pp_vf_rint0\",\n\t\"epf_pp_vf_rint1\",\n\t\"epf_misc_rint\",\n\t\"epf_rsvd\",\n};\n\n \nstatic void cn93_dump_regs(struct octep_device *oct, int qno)\n{\n\tstruct device *dev = &oct->pdev->dev;\n\n\tdev_info(dev, \"IQ-%d register dump\\n\", qno);\n\tdev_info(dev, \"R[%d]_IN_INSTR_DBELL[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_IN_INSTR_DBELL(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_IN_INSTR_DBELL(qno)));\n\tdev_info(dev, \"R[%d]_IN_CONTROL[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_IN_CONTROL(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_IN_CONTROL(qno)));\n\tdev_info(dev, \"R[%d]_IN_ENABLE[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_IN_ENABLE(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_IN_ENABLE(qno)));\n\tdev_info(dev, \"R[%d]_IN_INSTR_BADDR[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_IN_INSTR_BADDR(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_IN_INSTR_BADDR(qno)));\n\tdev_info(dev, \"R[%d]_IN_INSTR_RSIZE[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_IN_INSTR_RSIZE(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_IN_INSTR_RSIZE(qno)));\n\tdev_info(dev, \"R[%d]_IN_CNTS[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_IN_CNTS(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_IN_CNTS(qno)));\n\tdev_info(dev, \"R[%d]_IN_INT_LEVELS[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_IN_INT_LEVELS(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_IN_INT_LEVELS(qno)));\n\tdev_info(dev, \"R[%d]_IN_PKT_CNT[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_IN_PKT_CNT(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_IN_PKT_CNT(qno)));\n\tdev_info(dev, \"R[%d]_IN_BYTE_CNT[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_IN_BYTE_CNT(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_IN_BYTE_CNT(qno)));\n\n\tdev_info(dev, \"OQ-%d register dump\\n\", qno);\n\tdev_info(dev, \"R[%d]_OUT_SLIST_DBELL[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_OUT_SLIST_DBELL(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_OUT_SLIST_DBELL(qno)));\n\tdev_info(dev, \"R[%d]_OUT_CONTROL[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_OUT_CONTROL(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_OUT_CONTROL(qno)));\n\tdev_info(dev, \"R[%d]_OUT_ENABLE[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_OUT_ENABLE(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_OUT_ENABLE(qno)));\n\tdev_info(dev, \"R[%d]_OUT_SLIST_BADDR[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_OUT_SLIST_BADDR(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_OUT_SLIST_BADDR(qno)));\n\tdev_info(dev, \"R[%d]_OUT_SLIST_RSIZE[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_OUT_SLIST_RSIZE(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_OUT_SLIST_RSIZE(qno)));\n\tdev_info(dev, \"R[%d]_OUT_CNTS[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_OUT_CNTS(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_OUT_CNTS(qno)));\n\tdev_info(dev, \"R[%d]_OUT_INT_LEVELS[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_OUT_INT_LEVELS(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_OUT_INT_LEVELS(qno)));\n\tdev_info(dev, \"R[%d]_OUT_PKT_CNT[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_OUT_PKT_CNT(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_OUT_PKT_CNT(qno)));\n\tdev_info(dev, \"R[%d]_OUT_BYTE_CNT[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_OUT_BYTE_CNT(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_OUT_BYTE_CNT(qno)));\n\tdev_info(dev, \"R[%d]_ERR_TYPE[0x%llx]: 0x%016llx\\n\",\n\t\t qno, CN93_SDP_R_ERR_TYPE(qno),\n\t\t octep_read_csr64(oct, CN93_SDP_R_ERR_TYPE(qno)));\n}\n\n \nstatic int cn93_reset_iq(struct octep_device *oct, int q_no)\n{\n\tstruct octep_config *conf = oct->conf;\n\tu64 val = 0ULL;\n\n\tdev_dbg(&oct->pdev->dev, \"Reset PF IQ-%d\\n\", q_no);\n\n\t \n\tq_no += conf->pf_ring_cfg.srn;\n\n\t \n\toctep_write_csr64(oct, CN93_SDP_R_IN_ENABLE(q_no), val);\n\n\t \n\toctep_write_csr64(oct, CN93_SDP_R_IN_CNTS(q_no), val);\n\toctep_write_csr64(oct, CN93_SDP_R_IN_INT_LEVELS(q_no), val);\n\toctep_write_csr64(oct, CN93_SDP_R_IN_PKT_CNT(q_no), val);\n\toctep_write_csr64(oct, CN93_SDP_R_IN_BYTE_CNT(q_no), val);\n\toctep_write_csr64(oct, CN93_SDP_R_IN_INSTR_BADDR(q_no), val);\n\toctep_write_csr64(oct, CN93_SDP_R_IN_INSTR_RSIZE(q_no), val);\n\n\tval = 0xFFFFFFFF;\n\toctep_write_csr64(oct, CN93_SDP_R_IN_INSTR_DBELL(q_no), val);\n\n\treturn 0;\n}\n\n \nstatic void cn93_reset_oq(struct octep_device *oct, int q_no)\n{\n\tu64 val = 0ULL;\n\n\tq_no += CFG_GET_PORTS_PF_SRN(oct->conf);\n\n\t \n\toctep_write_csr64(oct, CN93_SDP_R_OUT_ENABLE(q_no), val);\n\n\t \n\tval = octep_read_csr(oct, CN93_SDP_R_OUT_CNTS(q_no));\n\toctep_write_csr(oct, CN93_SDP_R_OUT_CNTS(q_no), val);\n\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_PKT_CNT(q_no), 0xFFFFFFFFFULL);\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_SLIST_DBELL(q_no), 0xFFFFFFFF);\n}\n\n \nstatic void octep_reset_io_queues_cn93_pf(struct octep_device *oct)\n{\n\tstruct pci_dev *pdev = oct->pdev;\n\tint q;\n\n\tdev_dbg(&pdev->dev, \"Reset OCTEP_CN93 PF IO Queues\\n\");\n\n\tfor (q = 0; q < CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf); q++) {\n\t\tcn93_reset_iq(oct, q);\n\t\tcn93_reset_oq(oct, q);\n\t}\n}\n\n \nstatic void octep_setup_pci_window_regs_cn93_pf(struct octep_device *oct)\n{\n\tu8 __iomem *bar0_pciaddr = oct->mmio[0].hw_addr;\n\n\toct->pci_win_regs.pci_win_wr_addr = (u8 __iomem *)(bar0_pciaddr + CN93_SDP_WIN_WR_ADDR64);\n\toct->pci_win_regs.pci_win_rd_addr = (u8 __iomem *)(bar0_pciaddr + CN93_SDP_WIN_RD_ADDR64);\n\toct->pci_win_regs.pci_win_wr_data = (u8 __iomem *)(bar0_pciaddr + CN93_SDP_WIN_WR_DATA64);\n\toct->pci_win_regs.pci_win_rd_data = (u8 __iomem *)(bar0_pciaddr + CN93_SDP_WIN_RD_DATA64);\n}\n\n \nstatic void octep_configure_ring_mapping_cn93_pf(struct octep_device *oct)\n{\n\tstruct octep_config *conf = oct->conf;\n\tstruct pci_dev *pdev = oct->pdev;\n\tu64 pf_srn = CFG_GET_PORTS_PF_SRN(oct->conf);\n\tint q;\n\n\tfor (q = 0; q < CFG_GET_PORTS_ACTIVE_IO_RINGS(conf); q++) {\n\t\tu64 regval = 0;\n\n\t\tif (oct->pcie_port)\n\t\t\tregval = 8 << CN93_SDP_FUNC_SEL_EPF_BIT_POS;\n\n\t\toctep_write_csr64(oct, CN93_SDP_EPVF_RING(pf_srn + q), regval);\n\n\t\tregval = octep_read_csr64(oct, CN93_SDP_EPVF_RING(pf_srn + q));\n\t\tdev_dbg(&pdev->dev, \"Write SDP_EPVF_RING[0x%llx] = 0x%llx\\n\",\n\t\t\tCN93_SDP_EPVF_RING(pf_srn + q), regval);\n\t}\n}\n\n \nstatic void octep_init_config_cn93_pf(struct octep_device *oct)\n{\n\tstruct octep_config *conf = oct->conf;\n\tstruct pci_dev *pdev = oct->pdev;\n\tu8 link = 0;\n\tu64 val;\n\tint pos;\n\n\t \n\tval = octep_read_csr64(oct, CN93_SDP_EPF_RINFO);\n\tconf->sriov_cfg.max_rings_per_vf = CN93_SDP_EPF_RINFO_RPVF(val);\n\tconf->sriov_cfg.active_rings_per_vf = conf->sriov_cfg.max_rings_per_vf;\n\tconf->sriov_cfg.max_vfs = CN93_SDP_EPF_RINFO_NVFS(val);\n\tconf->sriov_cfg.active_vfs = conf->sriov_cfg.max_vfs;\n\tconf->sriov_cfg.vf_srn = CN93_SDP_EPF_RINFO_SRN(val);\n\n\tval = octep_read_csr64(oct, CN93_SDP_MAC_PF_RING_CTL(oct->pcie_port));\n\tconf->pf_ring_cfg.srn =  CN93_SDP_MAC_PF_RING_CTL_SRN(val);\n\tconf->pf_ring_cfg.max_io_rings = CN93_SDP_MAC_PF_RING_CTL_RPPF(val);\n\tconf->pf_ring_cfg.active_io_rings = conf->pf_ring_cfg.max_io_rings;\n\tdev_info(&pdev->dev, \"pf_srn=%u rpvf=%u nvfs=%u rppf=%u\\n\",\n\t\t conf->pf_ring_cfg.srn, conf->sriov_cfg.active_rings_per_vf,\n\t\t conf->sriov_cfg.active_vfs, conf->pf_ring_cfg.active_io_rings);\n\n\tconf->iq.num_descs = OCTEP_IQ_MAX_DESCRIPTORS;\n\tconf->iq.instr_type = OCTEP_64BYTE_INSTR;\n\tconf->iq.pkind = 0;\n\tconf->iq.db_min = OCTEP_DB_MIN;\n\tconf->iq.intr_threshold = OCTEP_IQ_INTR_THRESHOLD;\n\n\tconf->oq.num_descs = OCTEP_OQ_MAX_DESCRIPTORS;\n\tconf->oq.buf_size = OCTEP_OQ_BUF_SIZE;\n\tconf->oq.refill_threshold = OCTEP_OQ_REFILL_THRESHOLD;\n\tconf->oq.oq_intr_pkt = OCTEP_OQ_INTR_PKT_THRESHOLD;\n\tconf->oq.oq_intr_time = OCTEP_OQ_INTR_TIME_THRESHOLD;\n\n\tconf->msix_cfg.non_ioq_msix = CN93_NUM_NON_IOQ_INTR;\n\tconf->msix_cfg.ioq_msix = conf->pf_ring_cfg.active_io_rings;\n\tconf->msix_cfg.non_ioq_msix_names = cn93_non_ioq_msix_names;\n\n\tpos = pci_find_ext_capability(oct->pdev, PCI_EXT_CAP_ID_SRIOV);\n\tif (pos) {\n\t\tpci_read_config_byte(oct->pdev,\n\t\t\t\t     pos + PCI_SRIOV_FUNC_LINK,\n\t\t\t\t     &link);\n\t\tlink = PCI_DEVFN(PCI_SLOT(oct->pdev->devfn), link);\n\t}\n\tconf->ctrl_mbox_cfg.barmem_addr = (void __iomem *)oct->mmio[2].hw_addr +\n\t\t\t\t\t   (0x400000ull * 7) +\n\t\t\t\t\t   (link * CTRL_MBOX_SZ);\n\n\tconf->hb_interval = FW_HB_INTERVAL_IN_SECS;\n\tconf->max_hb_miss_cnt = FW_HB_MISS_COUNT;\n\n}\n\n \nstatic void octep_setup_iq_regs_cn93_pf(struct octep_device *oct, int iq_no)\n{\n\tstruct octep_iq *iq = oct->iq[iq_no];\n\tu32 reset_instr_cnt;\n\tu64 reg_val;\n\n\tiq_no += CFG_GET_PORTS_PF_SRN(oct->conf);\n\treg_val = octep_read_csr64(oct, CN93_SDP_R_IN_CONTROL(iq_no));\n\n\t \n\tif (!(reg_val & CN93_R_IN_CTL_IDLE)) {\n\t\tdo {\n\t\t\treg_val = octep_read_csr64(oct, CN93_SDP_R_IN_CONTROL(iq_no));\n\t\t} while (!(reg_val & CN93_R_IN_CTL_IDLE));\n\t}\n\n\treg_val |= CN93_R_IN_CTL_RDSIZE;\n\treg_val |= CN93_R_IN_CTL_IS_64B;\n\treg_val |= CN93_R_IN_CTL_ESR;\n\toctep_write_csr64(oct, CN93_SDP_R_IN_CONTROL(iq_no), reg_val);\n\n\t \n\toctep_write_csr64(oct, CN93_SDP_R_IN_INSTR_BADDR(iq_no),\n\t\t\t  iq->desc_ring_dma);\n\toctep_write_csr64(oct, CN93_SDP_R_IN_INSTR_RSIZE(iq_no),\n\t\t\t  iq->max_count);\n\n\t \n\tiq->doorbell_reg = oct->mmio[0].hw_addr +\n\t\t\t   CN93_SDP_R_IN_INSTR_DBELL(iq_no);\n\tiq->inst_cnt_reg = oct->mmio[0].hw_addr +\n\t\t\t   CN93_SDP_R_IN_CNTS(iq_no);\n\tiq->intr_lvl_reg = oct->mmio[0].hw_addr +\n\t\t\t   CN93_SDP_R_IN_INT_LEVELS(iq_no);\n\n\t \n\treset_instr_cnt = readl(iq->inst_cnt_reg);\n\twritel(reset_instr_cnt, iq->inst_cnt_reg);\n\n\t \n\treg_val = CFG_GET_IQ_INTR_THRESHOLD(oct->conf) & 0xffffffff;\n\toctep_write_csr64(oct, CN93_SDP_R_IN_INT_LEVELS(iq_no), reg_val);\n}\n\n \nstatic void octep_setup_oq_regs_cn93_pf(struct octep_device *oct, int oq_no)\n{\n\tu64 reg_val;\n\tu64 oq_ctl = 0ULL;\n\tu32 time_threshold = 0;\n\tstruct octep_oq *oq = oct->oq[oq_no];\n\n\toq_no += CFG_GET_PORTS_PF_SRN(oct->conf);\n\treg_val = octep_read_csr64(oct, CN93_SDP_R_OUT_CONTROL(oq_no));\n\n\t \n\tif (!(reg_val & CN93_R_OUT_CTL_IDLE)) {\n\t\tdo {\n\t\t\treg_val = octep_read_csr64(oct, CN93_SDP_R_OUT_CONTROL(oq_no));\n\t\t} while (!(reg_val & CN93_R_OUT_CTL_IDLE));\n\t}\n\n\treg_val &= ~(CN93_R_OUT_CTL_IMODE);\n\treg_val &= ~(CN93_R_OUT_CTL_ROR_P);\n\treg_val &= ~(CN93_R_OUT_CTL_NSR_P);\n\treg_val &= ~(CN93_R_OUT_CTL_ROR_I);\n\treg_val &= ~(CN93_R_OUT_CTL_NSR_I);\n\treg_val &= ~(CN93_R_OUT_CTL_ES_I);\n\treg_val &= ~(CN93_R_OUT_CTL_ROR_D);\n\treg_val &= ~(CN93_R_OUT_CTL_NSR_D);\n\treg_val &= ~(CN93_R_OUT_CTL_ES_D);\n\treg_val |= (CN93_R_OUT_CTL_ES_P);\n\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_CONTROL(oq_no), reg_val);\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_SLIST_BADDR(oq_no),\n\t\t\t  oq->desc_ring_dma);\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_SLIST_RSIZE(oq_no),\n\t\t\t  oq->max_count);\n\n\toq_ctl = octep_read_csr64(oct, CN93_SDP_R_OUT_CONTROL(oq_no));\n\toq_ctl &= ~0x7fffffULL;\t\n\toq_ctl |= (oq->buffer_size & 0xffff);\t\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_CONTROL(oq_no), oq_ctl);\n\n\t \n\toq->pkts_sent_reg = oct->mmio[0].hw_addr + CN93_SDP_R_OUT_CNTS(oq_no);\n\toq->pkts_credit_reg = oct->mmio[0].hw_addr +\n\t\t\t      CN93_SDP_R_OUT_SLIST_DBELL(oq_no);\n\n\ttime_threshold = CFG_GET_OQ_INTR_TIME(oct->conf);\n\treg_val = ((u64)time_threshold << 32) |\n\t\t  CFG_GET_OQ_INTR_PKT(oct->conf);\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_INT_LEVELS(oq_no), reg_val);\n}\n\n \nstatic void octep_setup_mbox_regs_cn93_pf(struct octep_device *oct, int q_no)\n{\n\tstruct octep_mbox *mbox = oct->mbox[q_no];\n\n\tmbox->q_no = q_no;\n\n\t \n\tmbox->mbox_int_reg = oct->mmio[0].hw_addr + CN93_SDP_EPF_MBOX_RINT(0);\n\n\t \n\tmbox->mbox_write_reg = oct->mmio[0].hw_addr + CN93_SDP_R_MBOX_PF_VF_DATA(q_no);\n\n\t \n\tmbox->mbox_read_reg = oct->mmio[0].hw_addr + CN93_SDP_R_MBOX_VF_PF_DATA(q_no);\n}\n\n \nstatic bool octep_poll_non_ioq_interrupts_cn93_pf(struct octep_device *oct)\n{\n\tbool handled = false;\n\tu64 reg0;\n\n\t \n\treg0 = octep_read_csr64(oct, CN93_SDP_EPF_OEI_RINT);\n\tif (reg0) {\n\t\tdev_info(&oct->pdev->dev,\n\t\t\t \"Received OEI_RINT intr: 0x%llx\\n\",\n\t\t\t reg0);\n\t\toctep_write_csr64(oct, CN93_SDP_EPF_OEI_RINT, reg0);\n\t\tif (reg0 & CN93_SDP_EPF_OEI_RINT_DATA_BIT_MBOX)\n\t\t\tqueue_work(octep_wq, &oct->ctrl_mbox_task);\n\t\telse if (reg0 & CN93_SDP_EPF_OEI_RINT_DATA_BIT_HBEAT)\n\t\t\tatomic_set(&oct->hb_miss_cnt, 0);\n\n\t\thandled = true;\n\t}\n\n\treturn handled;\n}\n\n \nstatic irqreturn_t octep_non_ioq_intr_handler_cn93_pf(void *dev)\n{\n\tstruct octep_device *oct = (struct octep_device *)dev;\n\tstruct pci_dev *pdev = oct->pdev;\n\tu64 reg_val = 0;\n\tint i = 0;\n\n\t \n\treg_val = octep_read_csr64(oct, CN93_SDP_EPF_IRERR_RINT);\n\tif (reg_val) {\n\t\tdev_info(&pdev->dev,\n\t\t\t \"received IRERR_RINT intr: 0x%llx\\n\", reg_val);\n\t\toctep_write_csr64(oct, CN93_SDP_EPF_IRERR_RINT, reg_val);\n\n\t\tfor (i = 0; i < CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf); i++) {\n\t\t\treg_val = octep_read_csr64(oct,\n\t\t\t\t\t\t   CN93_SDP_R_ERR_TYPE(i));\n\t\t\tif (reg_val) {\n\t\t\t\tdev_info(&pdev->dev,\n\t\t\t\t\t \"Received err type on IQ-%d: 0x%llx\\n\",\n\t\t\t\t\t i, reg_val);\n\t\t\t\toctep_write_csr64(oct, CN93_SDP_R_ERR_TYPE(i),\n\t\t\t\t\t\t  reg_val);\n\t\t\t}\n\t\t}\n\t\tgoto irq_handled;\n\t}\n\n\t \n\treg_val = octep_read_csr64(oct, CN93_SDP_EPF_ORERR_RINT);\n\tif (reg_val) {\n\t\tdev_info(&pdev->dev,\n\t\t\t \"Received ORERR_RINT intr: 0x%llx\\n\", reg_val);\n\t\toctep_write_csr64(oct, CN93_SDP_EPF_ORERR_RINT, reg_val);\n\t\tfor (i = 0; i < CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf); i++) {\n\t\t\treg_val = octep_read_csr64(oct, CN93_SDP_R_ERR_TYPE(i));\n\t\t\tif (reg_val) {\n\t\t\t\tdev_info(&pdev->dev,\n\t\t\t\t\t \"Received err type on OQ-%d: 0x%llx\\n\",\n\t\t\t\t\t i, reg_val);\n\t\t\t\toctep_write_csr64(oct, CN93_SDP_R_ERR_TYPE(i),\n\t\t\t\t\t\t  reg_val);\n\t\t\t}\n\t\t}\n\n\t\tgoto irq_handled;\n\t}\n\n\t \n\treg_val = octep_read_csr64(oct, CN93_SDP_EPF_VFIRE_RINT(0));\n\tif (reg_val) {\n\t\tdev_info(&pdev->dev,\n\t\t\t \"Received VFIRE_RINT intr: 0x%llx\\n\", reg_val);\n\t\toctep_write_csr64(oct, CN93_SDP_EPF_VFIRE_RINT(0), reg_val);\n\t\tgoto irq_handled;\n\t}\n\n\t \n\treg_val = octep_read_csr64(oct, CN93_SDP_EPF_VFORE_RINT(0));\n\tif (reg_val) {\n\t\tdev_info(&pdev->dev,\n\t\t\t \"Received VFORE_RINT intr: 0x%llx\\n\", reg_val);\n\t\toctep_write_csr64(oct, CN93_SDP_EPF_VFORE_RINT(0), reg_val);\n\t\tgoto irq_handled;\n\t}\n\n\t \n\tif (octep_poll_non_ioq_interrupts_cn93_pf(oct))\n\t\tgoto irq_handled;\n\n\t \n\treg_val = octep_read_csr64(oct, CN93_SDP_EPF_DMA_RINT);\n\tif (reg_val) {\n\t\toctep_write_csr64(oct, CN93_SDP_EPF_DMA_RINT, reg_val);\n\t\tgoto irq_handled;\n\t}\n\n\t \n\treg_val = octep_read_csr64(oct, CN93_SDP_EPF_DMA_VF_RINT(0));\n\tif (reg_val) {\n\t\tdev_info(&pdev->dev,\n\t\t\t \"Received DMA_VF_RINT intr: 0x%llx\\n\", reg_val);\n\t\toctep_write_csr64(oct, CN93_SDP_EPF_DMA_VF_RINT(0), reg_val);\n\t\tgoto irq_handled;\n\t}\n\n\t \n\treg_val = octep_read_csr64(oct, CN93_SDP_EPF_PP_VF_RINT(0));\n\tif (reg_val) {\n\t\tdev_info(&pdev->dev,\n\t\t\t \"Received PP_VF_RINT intr: 0x%llx\\n\", reg_val);\n\t\toctep_write_csr64(oct, CN93_SDP_EPF_PP_VF_RINT(0), reg_val);\n\t\tgoto irq_handled;\n\t}\n\n\t \n\treg_val = octep_read_csr64(oct, CN93_SDP_EPF_MISC_RINT);\n\tif (reg_val) {\n\t\tdev_info(&pdev->dev,\n\t\t\t \"Received MISC_RINT intr: 0x%llx\\n\", reg_val);\n\t\toctep_write_csr64(oct, CN93_SDP_EPF_MISC_RINT, reg_val);\n\t\tgoto irq_handled;\n\t}\n\n\tdev_info(&pdev->dev, \"Reserved interrupts raised; Ignore\\n\");\nirq_handled:\n\treturn IRQ_HANDLED;\n}\n\n \nstatic irqreturn_t octep_ioq_intr_handler_cn93_pf(void *data)\n{\n\tstruct octep_ioq_vector *vector = (struct octep_ioq_vector *)data;\n\tstruct octep_oq *oq = vector->oq;\n\n\tnapi_schedule_irqoff(oq->napi);\n\treturn IRQ_HANDLED;\n}\n\n \nstatic int octep_soft_reset_cn93_pf(struct octep_device *oct)\n{\n\tdev_info(&oct->pdev->dev, \"CN93XX: Doing soft reset\\n\");\n\n\toctep_write_csr64(oct, CN93_SDP_WIN_WR_MASK_REG, 0xFF);\n\n\t \n\tOCTEP_PCI_WIN_WRITE(oct, CN93_RST_CORE_DOMAIN_W1S, 1);\n\t \n\tmdelay(100);\n\t \n\tOCTEP_PCI_WIN_WRITE(oct, CN93_RST_CORE_DOMAIN_W1C, 1);\n\n\treturn 0;\n}\n\n \nstatic void octep_reinit_regs_cn93_pf(struct octep_device *oct)\n{\n\tu32 i;\n\n\tfor (i = 0; i < CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf); i++)\n\t\toct->hw_ops.setup_iq_regs(oct, i);\n\n\tfor (i = 0; i < CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf); i++)\n\t\toct->hw_ops.setup_oq_regs(oct, i);\n\n\toct->hw_ops.enable_interrupts(oct);\n\toct->hw_ops.enable_io_queues(oct);\n\n\tfor (i = 0; i < CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf); i++)\n\t\twritel(oct->oq[i]->max_count, oct->oq[i]->pkts_credit_reg);\n}\n\n \nstatic void octep_enable_interrupts_cn93_pf(struct octep_device *oct)\n{\n\tu64 intr_mask = 0ULL;\n\tint srn, num_rings, i;\n\n\tsrn = CFG_GET_PORTS_PF_SRN(oct->conf);\n\tnum_rings = CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf);\n\n\tfor (i = 0; i < num_rings; i++)\n\t\tintr_mask |= (0x1ULL << (srn + i));\n\n\toctep_write_csr64(oct, CN93_SDP_EPF_IRERR_RINT_ENA_W1S, intr_mask);\n\toctep_write_csr64(oct, CN93_SDP_EPF_ORERR_RINT_ENA_W1S, intr_mask);\n\toctep_write_csr64(oct, CN93_SDP_EPF_OEI_RINT_ENA_W1S, -1ULL);\n\toctep_write_csr64(oct, CN93_SDP_EPF_MISC_RINT_ENA_W1S, intr_mask);\n\toctep_write_csr64(oct, CN93_SDP_EPF_DMA_RINT_ENA_W1S, intr_mask);\n}\n\n \nstatic void octep_disable_interrupts_cn93_pf(struct octep_device *oct)\n{\n\tu64 intr_mask = 0ULL;\n\tint srn, num_rings, i;\n\n\tsrn = CFG_GET_PORTS_PF_SRN(oct->conf);\n\tnum_rings = CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf);\n\n\tfor (i = 0; i < num_rings; i++)\n\t\tintr_mask |= (0x1ULL << (srn + i));\n\n\toctep_write_csr64(oct, CN93_SDP_EPF_IRERR_RINT_ENA_W1C, intr_mask);\n\toctep_write_csr64(oct, CN93_SDP_EPF_ORERR_RINT_ENA_W1C, intr_mask);\n\toctep_write_csr64(oct, CN93_SDP_EPF_OEI_RINT_ENA_W1C, -1ULL);\n\toctep_write_csr64(oct, CN93_SDP_EPF_MISC_RINT_ENA_W1C, intr_mask);\n\toctep_write_csr64(oct, CN93_SDP_EPF_DMA_RINT_ENA_W1C, intr_mask);\n}\n\n \nstatic u32 octep_update_iq_read_index_cn93_pf(struct octep_iq *iq)\n{\n\tu32 pkt_in_done = readl(iq->inst_cnt_reg);\n\tu32 last_done, new_idx;\n\n\tlast_done = pkt_in_done - iq->pkt_in_done;\n\tiq->pkt_in_done = pkt_in_done;\n\n\tnew_idx = (iq->octep_read_index + last_done) % iq->max_count;\n\n\treturn new_idx;\n}\n\n \nstatic void octep_enable_iq_cn93_pf(struct octep_device *oct, int iq_no)\n{\n\tu64 loop = HZ;\n\tu64 reg_val;\n\n\tiq_no += CFG_GET_PORTS_PF_SRN(oct->conf);\n\n\toctep_write_csr64(oct, CN93_SDP_R_IN_INSTR_DBELL(iq_no), 0xFFFFFFFF);\n\n\twhile (octep_read_csr64(oct, CN93_SDP_R_IN_INSTR_DBELL(iq_no)) &&\n\t       loop--) {\n\t\tschedule_timeout_interruptible(1);\n\t}\n\n\treg_val = octep_read_csr64(oct,  CN93_SDP_R_IN_INT_LEVELS(iq_no));\n\treg_val |= (0x1ULL << 62);\n\toctep_write_csr64(oct, CN93_SDP_R_IN_INT_LEVELS(iq_no), reg_val);\n\n\treg_val = octep_read_csr64(oct, CN93_SDP_R_IN_ENABLE(iq_no));\n\treg_val |= 0x1ULL;\n\toctep_write_csr64(oct, CN93_SDP_R_IN_ENABLE(iq_no), reg_val);\n}\n\n \nstatic void octep_enable_oq_cn93_pf(struct octep_device *oct, int oq_no)\n{\n\tu64 reg_val = 0ULL;\n\n\toq_no += CFG_GET_PORTS_PF_SRN(oct->conf);\n\n\treg_val = octep_read_csr64(oct,  CN93_SDP_R_OUT_INT_LEVELS(oq_no));\n\treg_val |= (0x1ULL << 62);\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_INT_LEVELS(oq_no), reg_val);\n\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_SLIST_DBELL(oq_no), 0xFFFFFFFF);\n\n\treg_val = octep_read_csr64(oct, CN93_SDP_R_OUT_ENABLE(oq_no));\n\treg_val |= 0x1ULL;\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_ENABLE(oq_no), reg_val);\n}\n\n \nstatic void octep_enable_io_queues_cn93_pf(struct octep_device *oct)\n{\n\tu8 q;\n\n\tfor (q = 0; q < CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf); q++) {\n\t\toctep_enable_iq_cn93_pf(oct, q);\n\t\toctep_enable_oq_cn93_pf(oct, q);\n\t}\n}\n\n \nstatic void octep_disable_iq_cn93_pf(struct octep_device *oct, int iq_no)\n{\n\tu64 reg_val = 0ULL;\n\n\tiq_no += CFG_GET_PORTS_PF_SRN(oct->conf);\n\n\treg_val = octep_read_csr64(oct, CN93_SDP_R_IN_ENABLE(iq_no));\n\treg_val &= ~0x1ULL;\n\toctep_write_csr64(oct, CN93_SDP_R_IN_ENABLE(iq_no), reg_val);\n}\n\n \nstatic void octep_disable_oq_cn93_pf(struct octep_device *oct, int oq_no)\n{\n\tu64 reg_val = 0ULL;\n\n\toq_no += CFG_GET_PORTS_PF_SRN(oct->conf);\n\treg_val = octep_read_csr64(oct, CN93_SDP_R_OUT_ENABLE(oq_no));\n\treg_val &= ~0x1ULL;\n\toctep_write_csr64(oct, CN93_SDP_R_OUT_ENABLE(oq_no), reg_val);\n}\n\n \nstatic void octep_disable_io_queues_cn93_pf(struct octep_device *oct)\n{\n\tint q = 0;\n\n\tfor (q = 0; q < CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf); q++) {\n\t\toctep_disable_iq_cn93_pf(oct, q);\n\t\toctep_disable_oq_cn93_pf(oct, q);\n\t}\n}\n\n \nstatic void octep_dump_registers_cn93_pf(struct octep_device *oct)\n{\n\tu8 srn, num_rings, q;\n\n\tsrn = CFG_GET_PORTS_PF_SRN(oct->conf);\n\tnum_rings = CFG_GET_PORTS_ACTIVE_IO_RINGS(oct->conf);\n\n\tfor (q = srn; q < srn + num_rings; q++)\n\t\tcn93_dump_regs(oct, q);\n}\n\n \nvoid octep_device_setup_cn93_pf(struct octep_device *oct)\n{\n\toct->hw_ops.setup_iq_regs = octep_setup_iq_regs_cn93_pf;\n\toct->hw_ops.setup_oq_regs = octep_setup_oq_regs_cn93_pf;\n\toct->hw_ops.setup_mbox_regs = octep_setup_mbox_regs_cn93_pf;\n\n\toct->hw_ops.non_ioq_intr_handler = octep_non_ioq_intr_handler_cn93_pf;\n\toct->hw_ops.ioq_intr_handler = octep_ioq_intr_handler_cn93_pf;\n\toct->hw_ops.soft_reset = octep_soft_reset_cn93_pf;\n\toct->hw_ops.reinit_regs = octep_reinit_regs_cn93_pf;\n\n\toct->hw_ops.enable_interrupts = octep_enable_interrupts_cn93_pf;\n\toct->hw_ops.disable_interrupts = octep_disable_interrupts_cn93_pf;\n\toct->hw_ops.poll_non_ioq_interrupts = octep_poll_non_ioq_interrupts_cn93_pf;\n\n\toct->hw_ops.update_iq_read_idx = octep_update_iq_read_index_cn93_pf;\n\n\toct->hw_ops.enable_iq = octep_enable_iq_cn93_pf;\n\toct->hw_ops.enable_oq = octep_enable_oq_cn93_pf;\n\toct->hw_ops.enable_io_queues = octep_enable_io_queues_cn93_pf;\n\n\toct->hw_ops.disable_iq = octep_disable_iq_cn93_pf;\n\toct->hw_ops.disable_oq = octep_disable_oq_cn93_pf;\n\toct->hw_ops.disable_io_queues = octep_disable_io_queues_cn93_pf;\n\toct->hw_ops.reset_io_queues = octep_reset_io_queues_cn93_pf;\n\n\toct->hw_ops.dump_registers = octep_dump_registers_cn93_pf;\n\n\toctep_setup_pci_window_regs_cn93_pf(oct);\n\n\toct->pcie_port = octep_read_csr64(oct, CN93_SDP_MAC_NUMBER) & 0xff;\n\tdev_info(&oct->pdev->dev,\n\t\t \"Octeon device using PCIE Port %d\\n\", oct->pcie_port);\n\n\toctep_init_config_cn93_pf(oct);\n\toctep_configure_ring_mapping_cn93_pf(oct);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}