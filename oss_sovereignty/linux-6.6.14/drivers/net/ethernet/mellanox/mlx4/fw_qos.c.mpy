{
  "module_name": "fw_qos.c",
  "hash_id": "18b36faf087be87aeb8b078efa244714c36916abbdd341290b83800522ee57bf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx4/fw_qos.c",
  "human_readable_source": " \n\n#include <linux/export.h>\n#include \"fw_qos.h\"\n#include \"fw.h\"\n\nenum {\n\t \n\tMLX4_ALLOCATE_VPP_ALLOCATE\t= 0x0,\n\tMLX4_ALLOCATE_VPP_QUERY\t\t= 0x1\n};\n\nenum {\n\t \n\tMLX4_SET_VPORT_QOS_SET\t\t= 0x0,\n\tMLX4_SET_VPORT_QOS_QUERY\t= 0x1\n};\n\nstruct mlx4_set_port_prio2tc_context {\n\tu8 prio2tc[4];\n};\n\nstruct mlx4_port_scheduler_tc_cfg_be {\n\t__be16 pg;\n\t__be16 bw_precentage;\n\t__be16 max_bw_units;  \n\t__be16 max_bw_value;\n};\n\nstruct mlx4_set_port_scheduler_context {\n\tstruct mlx4_port_scheduler_tc_cfg_be tc[MLX4_NUM_TC];\n};\n\n \nstruct mlx4_alloc_vpp_param {\n\t__be32 available_vpp;\n\t__be32 vpp_p_up[MLX4_NUM_UP];\n};\n\nstruct mlx4_prio_qos_param {\n\t__be32 bw_share;\n\t__be32 max_avg_bw;\n\t__be32 reserved;\n\t__be32 enable;\n\t__be32 reserved1[4];\n};\n\nstruct mlx4_set_vport_context {\n\t__be32 reserved[8];\n\tstruct mlx4_prio_qos_param qos_p_up[MLX4_NUM_UP];\n};\n\nint mlx4_SET_PORT_PRIO2TC(struct mlx4_dev *dev, u8 port, u8 *prio2tc)\n{\n\tstruct mlx4_cmd_mailbox *mailbox;\n\tstruct mlx4_set_port_prio2tc_context *context;\n\tint err;\n\tu32 in_mod;\n\tint i;\n\n\tmailbox = mlx4_alloc_cmd_mailbox(dev);\n\tif (IS_ERR(mailbox))\n\t\treturn PTR_ERR(mailbox);\n\n\tcontext = mailbox->buf;\n\n\tfor (i = 0; i < MLX4_NUM_UP; i += 2)\n\t\tcontext->prio2tc[i >> 1] = prio2tc[i] << 4 | prio2tc[i + 1];\n\n\tin_mod = MLX4_SET_PORT_PRIO2TC << 8 | port;\n\terr = mlx4_cmd(dev, mailbox->dma, in_mod, 1, MLX4_CMD_SET_PORT,\n\t\t       MLX4_CMD_TIME_CLASS_B, MLX4_CMD_NATIVE);\n\n\tmlx4_free_cmd_mailbox(dev, mailbox);\n\treturn err;\n}\nEXPORT_SYMBOL(mlx4_SET_PORT_PRIO2TC);\n\nint mlx4_SET_PORT_SCHEDULER(struct mlx4_dev *dev, u8 port, u8 *tc_tx_bw,\n\t\t\t    u8 *pg, u16 *ratelimit)\n{\n\tstruct mlx4_cmd_mailbox *mailbox;\n\tstruct mlx4_set_port_scheduler_context *context;\n\tint err;\n\tu32 in_mod;\n\tint i;\n\n\tmailbox = mlx4_alloc_cmd_mailbox(dev);\n\tif (IS_ERR(mailbox))\n\t\treturn PTR_ERR(mailbox);\n\n\tcontext = mailbox->buf;\n\n\tfor (i = 0; i < MLX4_NUM_TC; i++) {\n\t\tstruct mlx4_port_scheduler_tc_cfg_be *tc = &context->tc[i];\n\t\tu16 r;\n\n\t\tif (ratelimit && ratelimit[i]) {\n\t\t\tif (ratelimit[i] <= MLX4_MAX_100M_UNITS_VAL) {\n\t\t\t\tr = ratelimit[i];\n\t\t\t\ttc->max_bw_units =\n\t\t\t\t\thtons(MLX4_RATELIMIT_100M_UNITS);\n\t\t\t} else {\n\t\t\t\tr = ratelimit[i] / 10;\n\t\t\t\ttc->max_bw_units =\n\t\t\t\t\thtons(MLX4_RATELIMIT_1G_UNITS);\n\t\t\t}\n\t\t\ttc->max_bw_value = htons(r);\n\t\t} else {\n\t\t\ttc->max_bw_value = htons(MLX4_RATELIMIT_DEFAULT);\n\t\t\ttc->max_bw_units = htons(MLX4_RATELIMIT_1G_UNITS);\n\t\t}\n\n\t\ttc->pg = htons(pg[i]);\n\t\ttc->bw_precentage = htons(tc_tx_bw[i]);\n\t}\n\n\tin_mod = MLX4_SET_PORT_SCHEDULER << 8 | port;\n\terr = mlx4_cmd(dev, mailbox->dma, in_mod, 1, MLX4_CMD_SET_PORT,\n\t\t       MLX4_CMD_TIME_CLASS_B, MLX4_CMD_NATIVE);\n\n\tmlx4_free_cmd_mailbox(dev, mailbox);\n\treturn err;\n}\nEXPORT_SYMBOL(mlx4_SET_PORT_SCHEDULER);\n\nint mlx4_ALLOCATE_VPP_get(struct mlx4_dev *dev, u8 port,\n\t\t\t  u16 *available_vpp, u8 *vpp_p_up)\n{\n\tint i;\n\tint err;\n\tstruct mlx4_cmd_mailbox *mailbox;\n\tstruct mlx4_alloc_vpp_param *out_param;\n\n\tmailbox = mlx4_alloc_cmd_mailbox(dev);\n\tif (IS_ERR(mailbox))\n\t\treturn PTR_ERR(mailbox);\n\n\tout_param = mailbox->buf;\n\n\terr = mlx4_cmd_box(dev, 0, mailbox->dma, port,\n\t\t\t   MLX4_ALLOCATE_VPP_QUERY,\n\t\t\t   MLX4_CMD_ALLOCATE_VPP,\n\t\t\t   MLX4_CMD_TIME_CLASS_A,\n\t\t\t   MLX4_CMD_NATIVE);\n\tif (err)\n\t\tgoto out;\n\n\t \n\t*available_vpp = (u16)be32_to_cpu(out_param->available_vpp);\n\n\tfor (i = 0; i < MLX4_NUM_UP; i++)\n\t\tvpp_p_up[i] = (u8)be32_to_cpu(out_param->vpp_p_up[i]);\n\nout:\n\tmlx4_free_cmd_mailbox(dev, mailbox);\n\n\treturn err;\n}\nEXPORT_SYMBOL(mlx4_ALLOCATE_VPP_get);\n\nint mlx4_ALLOCATE_VPP_set(struct mlx4_dev *dev, u8 port, u8 *vpp_p_up)\n{\n\tint i;\n\tint err;\n\tstruct mlx4_cmd_mailbox *mailbox;\n\tstruct mlx4_alloc_vpp_param *in_param;\n\n\tmailbox = mlx4_alloc_cmd_mailbox(dev);\n\tif (IS_ERR(mailbox))\n\t\treturn PTR_ERR(mailbox);\n\n\tin_param = mailbox->buf;\n\n\tfor (i = 0; i < MLX4_NUM_UP; i++)\n\t\tin_param->vpp_p_up[i] = cpu_to_be32(vpp_p_up[i]);\n\n\terr = mlx4_cmd(dev, mailbox->dma, port,\n\t\t       MLX4_ALLOCATE_VPP_ALLOCATE,\n\t\t       MLX4_CMD_ALLOCATE_VPP,\n\t\t       MLX4_CMD_TIME_CLASS_A,\n\t\t       MLX4_CMD_NATIVE);\n\n\tmlx4_free_cmd_mailbox(dev, mailbox);\n\treturn err;\n}\nEXPORT_SYMBOL(mlx4_ALLOCATE_VPP_set);\n\nint mlx4_SET_VPORT_QOS_get(struct mlx4_dev *dev, u8 port, u8 vport,\n\t\t\t   struct mlx4_vport_qos_param *out_param)\n{\n\tint i;\n\tint err;\n\tstruct mlx4_cmd_mailbox *mailbox;\n\tstruct mlx4_set_vport_context *ctx;\n\n\tmailbox = mlx4_alloc_cmd_mailbox(dev);\n\tif (IS_ERR(mailbox))\n\t\treturn PTR_ERR(mailbox);\n\n\tctx = mailbox->buf;\n\n\terr = mlx4_cmd_box(dev, 0, mailbox->dma, (vport << 8) | port,\n\t\t\t   MLX4_SET_VPORT_QOS_QUERY,\n\t\t\t   MLX4_CMD_SET_VPORT_QOS,\n\t\t\t   MLX4_CMD_TIME_CLASS_A,\n\t\t\t   MLX4_CMD_NATIVE);\n\tif (err)\n\t\tgoto out;\n\n\tfor (i = 0; i < MLX4_NUM_UP; i++) {\n\t\tout_param[i].bw_share = be32_to_cpu(ctx->qos_p_up[i].bw_share);\n\t\tout_param[i].max_avg_bw =\n\t\t\tbe32_to_cpu(ctx->qos_p_up[i].max_avg_bw);\n\t\tout_param[i].enable =\n\t\t\t!!(be32_to_cpu(ctx->qos_p_up[i].enable) & 31);\n\t}\n\nout:\n\tmlx4_free_cmd_mailbox(dev, mailbox);\n\n\treturn err;\n}\nEXPORT_SYMBOL(mlx4_SET_VPORT_QOS_get);\n\nint mlx4_SET_VPORT_QOS_set(struct mlx4_dev *dev, u8 port, u8 vport,\n\t\t\t   struct mlx4_vport_qos_param *in_param)\n{\n\tint i;\n\tint err;\n\tstruct mlx4_cmd_mailbox *mailbox;\n\tstruct mlx4_set_vport_context *ctx;\n\n\tmailbox = mlx4_alloc_cmd_mailbox(dev);\n\tif (IS_ERR(mailbox))\n\t\treturn PTR_ERR(mailbox);\n\n\tctx = mailbox->buf;\n\n\tfor (i = 0; i < MLX4_NUM_UP; i++) {\n\t\tctx->qos_p_up[i].bw_share = cpu_to_be32(in_param[i].bw_share);\n\t\tctx->qos_p_up[i].max_avg_bw =\n\t\t\t\tcpu_to_be32(in_param[i].max_avg_bw);\n\t\tctx->qos_p_up[i].enable =\n\t\t\t\tcpu_to_be32(in_param[i].enable << 31);\n\t}\n\n\terr = mlx4_cmd(dev, mailbox->dma, (vport << 8) | port,\n\t\t       MLX4_SET_VPORT_QOS_SET,\n\t\t       MLX4_CMD_SET_VPORT_QOS,\n\t\t       MLX4_CMD_TIME_CLASS_A,\n\t\t       MLX4_CMD_NATIVE);\n\n\tmlx4_free_cmd_mailbox(dev, mailbox);\n\treturn err;\n}\nEXPORT_SYMBOL(mlx4_SET_VPORT_QOS_set);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}