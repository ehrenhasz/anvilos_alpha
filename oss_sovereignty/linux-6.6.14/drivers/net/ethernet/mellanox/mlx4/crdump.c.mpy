{
  "module_name": "crdump.c",
  "hash_id": "e2455ed780f2c26b11d1af63851643c4f1357f01dcf214393930d61fa1088ee2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx4/crdump.c",
  "human_readable_source": " \n\n#include \"mlx4.h\"\n\n#define BAD_ACCESS\t\t\t0xBADACCE5\n#define HEALTH_BUFFER_SIZE\t\t0x40\n#define CR_ENABLE_BIT\t\t\tswab32(BIT(6))\n#define CR_ENABLE_BIT_OFFSET\t\t0xF3F04\n#define MAX_NUM_OF_DUMPS_TO_STORE\t(8)\n\n#define REGION_CR_SPACE \"cr-space\"\n#define REGION_FW_HEALTH \"fw-health\"\n\nstatic const char * const region_cr_space_str = REGION_CR_SPACE;\nstatic const char * const region_fw_health_str = REGION_FW_HEALTH;\n\nstatic const struct devlink_region_ops region_cr_space_ops = {\n\t.name = REGION_CR_SPACE,\n\t.destructor = &kvfree,\n};\n\nstatic const struct devlink_region_ops region_fw_health_ops = {\n\t.name = REGION_FW_HEALTH,\n\t.destructor = &kvfree,\n};\n\n \nstatic bool crdump_enbale_bit_set;\n\nstatic void crdump_enable_crspace_access(struct mlx4_dev *dev,\n\t\t\t\t\t u8 __iomem *cr_space)\n{\n\t \n\tcrdump_enbale_bit_set =\n\t\treadl(cr_space + CR_ENABLE_BIT_OFFSET) & CR_ENABLE_BIT;\n\n\t \n\tif (crdump_enbale_bit_set)\n\t\twritel(readl(cr_space + CR_ENABLE_BIT_OFFSET) & ~CR_ENABLE_BIT,\n\t\t       cr_space + CR_ENABLE_BIT_OFFSET);\n\n\t \n\twritel(swab32(1), cr_space + dev->caps.health_buffer_addrs +\n\t       HEALTH_BUFFER_SIZE);\n}\n\nstatic void crdump_disable_crspace_access(struct mlx4_dev *dev,\n\t\t\t\t\t  u8 __iomem *cr_space)\n{\n\t \n\twritel(0, cr_space + dev->caps.health_buffer_addrs +\n\t       HEALTH_BUFFER_SIZE);\n\n\t \n\tif (crdump_enbale_bit_set)\n\t\twritel(readl(cr_space + CR_ENABLE_BIT_OFFSET) | CR_ENABLE_BIT,\n\t\t       cr_space + CR_ENABLE_BIT_OFFSET);\n}\n\nstatic void mlx4_crdump_collect_crspace(struct mlx4_dev *dev,\n\t\t\t\t\tu8 __iomem *cr_space,\n\t\t\t\t\tu32 id)\n{\n\tstruct mlx4_fw_crdump *crdump = &dev->persist->crdump;\n\tstruct pci_dev *pdev = dev->persist->pdev;\n\tunsigned long cr_res_size;\n\tu8 *crspace_data;\n\tint offset;\n\tint err;\n\n\tif (!crdump->region_crspace) {\n\t\tmlx4_err(dev, \"crdump: cr-space region is NULL\\n\");\n\t\treturn;\n\t}\n\n\t \n\tcr_res_size = pci_resource_len(pdev, 0);\n\tcrspace_data = kvmalloc(cr_res_size, GFP_KERNEL);\n\tif (crspace_data) {\n\t\tfor (offset = 0; offset < cr_res_size; offset += 4)\n\t\t\t*(u32 *)(crspace_data + offset) =\n\t\t\t\t\treadl(cr_space + offset);\n\n\t\terr = devlink_region_snapshot_create(crdump->region_crspace,\n\t\t\t\t\t\t     crspace_data, id);\n\t\tif (err) {\n\t\t\tkvfree(crspace_data);\n\t\t\tmlx4_warn(dev, \"crdump: devlink create %s snapshot id %d err %d\\n\",\n\t\t\t\t  region_cr_space_str, id, err);\n\t\t} else {\n\t\t\tmlx4_info(dev, \"crdump: added snapshot %d to devlink region %s\\n\",\n\t\t\t\t  id, region_cr_space_str);\n\t\t}\n\t} else {\n\t\tmlx4_err(dev, \"crdump: Failed to allocate crspace buffer\\n\");\n\t}\n}\n\nstatic void mlx4_crdump_collect_fw_health(struct mlx4_dev *dev,\n\t\t\t\t\t  u8 __iomem *cr_space,\n\t\t\t\t\t  u32 id)\n{\n\tstruct mlx4_fw_crdump *crdump = &dev->persist->crdump;\n\tu8 *health_data;\n\tint offset;\n\tint err;\n\n\tif (!crdump->region_fw_health) {\n\t\tmlx4_err(dev, \"crdump: fw-health region is NULL\\n\");\n\t\treturn;\n\t}\n\n\t \n\thealth_data = kvmalloc(HEALTH_BUFFER_SIZE, GFP_KERNEL);\n\tif (health_data) {\n\t\tu8 __iomem *health_buf_start =\n\t\t\t\tcr_space + dev->caps.health_buffer_addrs;\n\n\t\tfor (offset = 0; offset < HEALTH_BUFFER_SIZE; offset += 4)\n\t\t\t*(u32 *)(health_data + offset) =\n\t\t\t\t\treadl(health_buf_start + offset);\n\n\t\terr = devlink_region_snapshot_create(crdump->region_fw_health,\n\t\t\t\t\t\t     health_data, id);\n\t\tif (err) {\n\t\t\tkvfree(health_data);\n\t\t\tmlx4_warn(dev, \"crdump: devlink create %s snapshot id %d err %d\\n\",\n\t\t\t\t  region_fw_health_str, id, err);\n\t\t} else {\n\t\t\tmlx4_info(dev, \"crdump: added snapshot %d to devlink region %s\\n\",\n\t\t\t\t  id, region_fw_health_str);\n\t\t}\n\t} else {\n\t\tmlx4_err(dev, \"crdump: Failed to allocate health buffer\\n\");\n\t}\n}\n\nint mlx4_crdump_collect(struct mlx4_dev *dev)\n{\n\tstruct devlink *devlink = priv_to_devlink(mlx4_priv(dev));\n\tstruct mlx4_fw_crdump *crdump = &dev->persist->crdump;\n\tstruct pci_dev *pdev = dev->persist->pdev;\n\tunsigned long cr_res_size;\n\tu8 __iomem *cr_space;\n\tint err;\n\tu32 id;\n\n\tif (!dev->caps.health_buffer_addrs) {\n\t\tmlx4_info(dev, \"crdump: FW doesn't support health buffer access, skipping\\n\");\n\t\treturn 0;\n\t}\n\n\tif (!crdump->snapshot_enable) {\n\t\tmlx4_info(dev, \"crdump: devlink snapshot disabled, skipping\\n\");\n\t\treturn 0;\n\t}\n\n\tcr_res_size = pci_resource_len(pdev, 0);\n\n\tcr_space = ioremap(pci_resource_start(pdev, 0), cr_res_size);\n\tif (!cr_space) {\n\t\tmlx4_err(dev, \"crdump: Failed to map pci cr region\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\t \n\terr = devlink_region_snapshot_id_get(devlink, &id);\n\tif (err) {\n\t\tmlx4_err(dev, \"crdump: devlink get snapshot id err %d\\n\", err);\n\t\tiounmap(cr_space);\n\t\treturn err;\n\t}\n\n\tcrdump_enable_crspace_access(dev, cr_space);\n\n\t \n\tmlx4_crdump_collect_crspace(dev, cr_space, id);\n\tmlx4_crdump_collect_fw_health(dev, cr_space, id);\n\n\t \n\tdevlink_region_snapshot_id_put(devlink, id);\n\n\tcrdump_disable_crspace_access(dev, cr_space);\n\n\tiounmap(cr_space);\n\treturn 0;\n}\n\nint mlx4_crdump_init(struct mlx4_dev *dev)\n{\n\tstruct devlink *devlink = priv_to_devlink(mlx4_priv(dev));\n\tstruct mlx4_fw_crdump *crdump = &dev->persist->crdump;\n\tstruct pci_dev *pdev = dev->persist->pdev;\n\n\tcrdump->snapshot_enable = false;\n\n\t \n\tcrdump->region_crspace =\n\t\tdevl_region_create(devlink,\n\t\t\t\t   &region_cr_space_ops,\n\t\t\t\t   MAX_NUM_OF_DUMPS_TO_STORE,\n\t\t\t\t   pci_resource_len(pdev, 0));\n\tif (IS_ERR(crdump->region_crspace))\n\t\tmlx4_warn(dev, \"crdump: create devlink region %s err %ld\\n\",\n\t\t\t  region_cr_space_str,\n\t\t\t  PTR_ERR(crdump->region_crspace));\n\n\t \n\tcrdump->region_fw_health =\n\t\tdevl_region_create(devlink,\n\t\t\t\t   &region_fw_health_ops,\n\t\t\t\t   MAX_NUM_OF_DUMPS_TO_STORE,\n\t\t\t\t   HEALTH_BUFFER_SIZE);\n\tif (IS_ERR(crdump->region_fw_health))\n\t\tmlx4_warn(dev, \"crdump: create devlink region %s err %ld\\n\",\n\t\t\t  region_fw_health_str,\n\t\t\t  PTR_ERR(crdump->region_fw_health));\n\n\treturn 0;\n}\n\nvoid mlx4_crdump_end(struct mlx4_dev *dev)\n{\n\tstruct mlx4_fw_crdump *crdump = &dev->persist->crdump;\n\n\tdevl_region_destroy(crdump->region_fw_health);\n\tdevl_region_destroy(crdump->region_crspace);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}