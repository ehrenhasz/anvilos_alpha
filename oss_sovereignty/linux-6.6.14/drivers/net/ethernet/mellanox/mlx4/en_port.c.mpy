{
  "module_name": "en_port.c",
  "hash_id": "e7f4b227ad1e2e5e575ff99689870ce54df5925f906357925de57963cfadf94b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx4/en_port.c",
  "human_readable_source": " \n\n\n#include <linux/if_vlan.h>\n\n#include <linux/mlx4/device.h>\n#include <linux/mlx4/cmd.h>\n\n#include \"en_port.h\"\n#include \"mlx4_en.h\"\n\n\nint mlx4_SET_VLAN_FLTR(struct mlx4_dev *dev, struct mlx4_en_priv *priv)\n{\n\tstruct mlx4_cmd_mailbox *mailbox;\n\tstruct mlx4_set_vlan_fltr_mbox *filter;\n\tint i;\n\tint j;\n\tint index = 0;\n\tu32 entry;\n\tint err = 0;\n\n\tmailbox = mlx4_alloc_cmd_mailbox(dev);\n\tif (IS_ERR(mailbox))\n\t\treturn PTR_ERR(mailbox);\n\n\tfilter = mailbox->buf;\n\tfor (i = VLAN_FLTR_SIZE - 1; i >= 0; i--) {\n\t\tentry = 0;\n\t\tfor (j = 0; j < 32; j++)\n\t\t\tif (test_bit(index++, priv->active_vlans))\n\t\t\t\tentry |= 1 << j;\n\t\tfilter->entry[i] = cpu_to_be32(entry);\n\t}\n\terr = mlx4_cmd(dev, mailbox->dma, priv->port, 0, MLX4_CMD_SET_VLAN_FLTR,\n\t\t       MLX4_CMD_TIME_CLASS_B, MLX4_CMD_WRAPPED);\n\tmlx4_free_cmd_mailbox(dev, mailbox);\n\treturn err;\n}\n\nint mlx4_en_QUERY_PORT(struct mlx4_en_dev *mdev, u8 port)\n{\n\tstruct mlx4_en_query_port_context *qport_context;\n\tstruct mlx4_en_priv *priv = netdev_priv(mdev->pndev[port]);\n\tstruct mlx4_en_port_state *state = &priv->port_state;\n\tstruct mlx4_cmd_mailbox *mailbox;\n\tint err;\n\n\tmailbox = mlx4_alloc_cmd_mailbox(mdev->dev);\n\tif (IS_ERR(mailbox))\n\t\treturn PTR_ERR(mailbox);\n\terr = mlx4_cmd_box(mdev->dev, 0, mailbox->dma, port, 0,\n\t\t\t   MLX4_CMD_QUERY_PORT, MLX4_CMD_TIME_CLASS_B,\n\t\t\t   MLX4_CMD_WRAPPED);\n\tif (err)\n\t\tgoto out;\n\tqport_context = mailbox->buf;\n\n\t \n\tstate->link_state = !!(qport_context->link_up & MLX4_EN_LINK_UP_MASK);\n\tswitch (qport_context->link_speed & MLX4_EN_SPEED_MASK) {\n\tcase MLX4_EN_100M_SPEED:\n\t\tstate->link_speed = SPEED_100;\n\t\tbreak;\n\tcase MLX4_EN_1G_SPEED:\n\t\tstate->link_speed = SPEED_1000;\n\t\tbreak;\n\tcase MLX4_EN_10G_SPEED_XAUI:\n\tcase MLX4_EN_10G_SPEED_XFI:\n\t\tstate->link_speed = SPEED_10000;\n\t\tbreak;\n\tcase MLX4_EN_20G_SPEED:\n\t\tstate->link_speed = SPEED_20000;\n\t\tbreak;\n\tcase MLX4_EN_40G_SPEED:\n\t\tstate->link_speed = SPEED_40000;\n\t\tbreak;\n\tcase MLX4_EN_56G_SPEED:\n\t\tstate->link_speed = SPEED_56000;\n\t\tbreak;\n\tdefault:\n\t\tstate->link_speed = -1;\n\t\tbreak;\n\t}\n\n\tstate->transceiver = qport_context->transceiver;\n\n\tstate->flags = 0;  \n\tstate->flags |= (qport_context->link_up & MLX4_EN_ANC_MASK) ?\n\t\tMLX4_EN_PORT_ANC : 0;\n\tstate->flags |= (qport_context->autoneg & MLX4_EN_AUTONEG_MASK) ?\n\t\tMLX4_EN_PORT_ANE : 0;\n\nout:\n\tmlx4_free_cmd_mailbox(mdev->dev, mailbox);\n\treturn err;\n}\n\n \nstatic unsigned long en_stats_adder(__be64 *start, __be64 *next, int num)\n{\n\t__be64 *curr = start;\n\tunsigned long ret = 0;\n\tint i;\n\tint offset = next - start;\n\n\tfor (i = 0; i < num; i++) {\n\t\tret += be64_to_cpu(*curr);\n\t\tcurr += offset;\n\t}\n\n\treturn ret;\n}\n\nvoid mlx4_en_fold_software_stats(struct net_device *dev)\n{\n\tstruct mlx4_en_priv *priv = netdev_priv(dev);\n\tstruct mlx4_en_dev *mdev = priv->mdev;\n\tunsigned long packets, bytes;\n\tint i;\n\n\tif (!priv->port_up || mlx4_is_master(mdev->dev))\n\t\treturn;\n\n\tpackets = 0;\n\tbytes = 0;\n\tfor (i = 0; i < priv->rx_ring_num; i++) {\n\t\tconst struct mlx4_en_rx_ring *ring = priv->rx_ring[i];\n\n\t\tpackets += READ_ONCE(ring->packets);\n\t\tbytes   += READ_ONCE(ring->bytes);\n\t}\n\tdev->stats.rx_packets = packets;\n\tdev->stats.rx_bytes = bytes;\n\n\tpackets = 0;\n\tbytes = 0;\n\tfor (i = 0; i < priv->tx_ring_num[TX]; i++) {\n\t\tconst struct mlx4_en_tx_ring *ring = priv->tx_ring[TX][i];\n\n\t\tpackets += READ_ONCE(ring->packets);\n\t\tbytes   += READ_ONCE(ring->bytes);\n\t}\n\tdev->stats.tx_packets = packets;\n\tdev->stats.tx_bytes = bytes;\n}\n\nint mlx4_en_DUMP_ETH_STATS(struct mlx4_en_dev *mdev, u8 port, u8 reset)\n{\n\tstruct mlx4_counter tmp_counter_stats;\n\tstruct mlx4_en_stat_out_mbox *mlx4_en_stats;\n\tstruct mlx4_en_stat_out_flow_control_mbox *flowstats;\n\tstruct net_device *dev = mdev->pndev[port];\n\tstruct mlx4_en_priv *priv = netdev_priv(dev);\n\tstruct net_device_stats *stats = &dev->stats;\n\tstruct mlx4_cmd_mailbox *mailbox, *mailbox_priority;\n\tu64 in_mod = reset << 8 | port;\n\tint err;\n\tint i, counter_index;\n\tunsigned long sw_tx_dropped = 0;\n\tunsigned long sw_rx_dropped = 0;\n\n\tmailbox = mlx4_alloc_cmd_mailbox(mdev->dev);\n\tif (IS_ERR(mailbox))\n\t\treturn PTR_ERR(mailbox);\n\n\tmailbox_priority = mlx4_alloc_cmd_mailbox(mdev->dev);\n\tif (IS_ERR(mailbox_priority)) {\n\t\tmlx4_free_cmd_mailbox(mdev->dev, mailbox);\n\t\treturn PTR_ERR(mailbox_priority);\n\t}\n\n\terr = mlx4_cmd_box(mdev->dev, 0, mailbox->dma, in_mod, 0,\n\t\t\t   MLX4_CMD_DUMP_ETH_STATS, MLX4_CMD_TIME_CLASS_B,\n\t\t\t   MLX4_CMD_NATIVE);\n\tif (err)\n\t\tgoto out;\n\n\tmlx4_en_stats = mailbox->buf;\n\n\tmemset(&tmp_counter_stats, 0, sizeof(tmp_counter_stats));\n\tcounter_index = mlx4_get_default_counter_index(mdev->dev, port);\n\terr = mlx4_get_counter_stats(mdev->dev, counter_index,\n\t\t\t\t     &tmp_counter_stats, reset);\n\n\t \n\tmemset(mailbox_priority->buf, 0xff,\n\t       sizeof(*flowstats) * MLX4_NUM_PRIORITIES);\n\n\tif (mdev->dev->caps.flags2 & MLX4_DEV_CAP_FLAG2_FLOWSTATS_EN) {\n\t\tmemset(mailbox_priority->buf, 0,\n\t\t       sizeof(*flowstats) * MLX4_NUM_PRIORITIES);\n\t\terr = mlx4_cmd_box(mdev->dev, 0, mailbox_priority->dma,\n\t\t\t\t   in_mod | MLX4_DUMP_ETH_STATS_FLOW_CONTROL,\n\t\t\t\t   0, MLX4_CMD_DUMP_ETH_STATS,\n\t\t\t\t   MLX4_CMD_TIME_CLASS_B, MLX4_CMD_NATIVE);\n\t\tif (err)\n\t\t\tgoto out;\n\t}\n\n\tflowstats = mailbox_priority->buf;\n\n\tspin_lock_bh(&priv->stats_lock);\n\n\tmlx4_en_fold_software_stats(dev);\n\n\tpriv->port_stats.rx_chksum_good = 0;\n\tpriv->port_stats.rx_chksum_none = 0;\n\tpriv->port_stats.rx_chksum_complete = 0;\n\tpriv->port_stats.rx_alloc_pages = 0;\n\tpriv->xdp_stats.rx_xdp_drop    = 0;\n\tpriv->xdp_stats.rx_xdp_redirect = 0;\n\tpriv->xdp_stats.rx_xdp_redirect_fail = 0;\n\tpriv->xdp_stats.rx_xdp_tx      = 0;\n\tpriv->xdp_stats.rx_xdp_tx_full = 0;\n\tfor (i = 0; i < priv->rx_ring_num; i++) {\n\t\tconst struct mlx4_en_rx_ring *ring = priv->rx_ring[i];\n\n\t\tsw_rx_dropped\t\t\t+= READ_ONCE(ring->dropped);\n\t\tpriv->port_stats.rx_chksum_good += READ_ONCE(ring->csum_ok);\n\t\tpriv->port_stats.rx_chksum_none += READ_ONCE(ring->csum_none);\n\t\tpriv->port_stats.rx_chksum_complete += READ_ONCE(ring->csum_complete);\n\t\tpriv->port_stats.rx_alloc_pages += READ_ONCE(ring->rx_alloc_pages);\n\t\tpriv->xdp_stats.rx_xdp_drop\t+= READ_ONCE(ring->xdp_drop);\n\t\tpriv->xdp_stats.rx_xdp_redirect += READ_ONCE(ring->xdp_redirect);\n\t\tpriv->xdp_stats.rx_xdp_redirect_fail += READ_ONCE(ring->xdp_redirect_fail);\n\t\tpriv->xdp_stats.rx_xdp_tx\t+= READ_ONCE(ring->xdp_tx);\n\t\tpriv->xdp_stats.rx_xdp_tx_full\t+= READ_ONCE(ring->xdp_tx_full);\n\t}\n\tpriv->port_stats.tx_chksum_offload = 0;\n\tpriv->port_stats.queue_stopped = 0;\n\tpriv->port_stats.wake_queue = 0;\n\tpriv->port_stats.tso_packets = 0;\n\tpriv->port_stats.xmit_more = 0;\n\n\tfor (i = 0; i < priv->tx_ring_num[TX]; i++) {\n\t\tconst struct mlx4_en_tx_ring *ring = priv->tx_ring[TX][i];\n\n\t\tsw_tx_dropped\t\t\t   += READ_ONCE(ring->tx_dropped);\n\t\tpriv->port_stats.tx_chksum_offload += READ_ONCE(ring->tx_csum);\n\t\tpriv->port_stats.queue_stopped     += READ_ONCE(ring->queue_stopped);\n\t\tpriv->port_stats.wake_queue        += READ_ONCE(ring->wake_queue);\n\t\tpriv->port_stats.tso_packets       += READ_ONCE(ring->tso_packets);\n\t\tpriv->port_stats.xmit_more         += READ_ONCE(ring->xmit_more);\n\t}\n\n\tif (!mlx4_is_slave(mdev->dev)) {\n\t\tstruct mlx4_en_phy_stats *p_stats = &priv->phy_stats;\n\n\t\tp_stats->rx_packets_phy =\n\t\t\ten_stats_adder(&mlx4_en_stats->RTOT_prio_0,\n\t\t\t\t       &mlx4_en_stats->RTOT_prio_1,\n\t\t\t\t       NUM_PRIORITIES);\n\t\tp_stats->tx_packets_phy =\n\t\t\ten_stats_adder(&mlx4_en_stats->TTOT_prio_0,\n\t\t\t\t       &mlx4_en_stats->TTOT_prio_1,\n\t\t\t\t       NUM_PRIORITIES);\n\t\tp_stats->rx_bytes_phy =\n\t\t\ten_stats_adder(&mlx4_en_stats->ROCT_prio_0,\n\t\t\t\t       &mlx4_en_stats->ROCT_prio_1,\n\t\t\t\t       NUM_PRIORITIES);\n\t\tp_stats->tx_bytes_phy =\n\t\t\ten_stats_adder(&mlx4_en_stats->TOCT_prio_0,\n\t\t\t\t       &mlx4_en_stats->TOCT_prio_1,\n\t\t\t\t       NUM_PRIORITIES);\n\t\tif (mlx4_is_master(mdev->dev)) {\n\t\t\tstats->rx_packets = p_stats->rx_packets_phy;\n\t\t\tstats->tx_packets = p_stats->tx_packets_phy;\n\t\t\tstats->rx_bytes = p_stats->rx_bytes_phy;\n\t\t\tstats->tx_bytes = p_stats->tx_bytes_phy;\n\t\t}\n\t}\n\n\t \n\tstats->rx_errors = be64_to_cpu(mlx4_en_stats->PCS) +\n\t\t\t   be32_to_cpu(mlx4_en_stats->RJBBR) +\n\t\t\t   be32_to_cpu(mlx4_en_stats->RCRC) +\n\t\t\t   be32_to_cpu(mlx4_en_stats->RRUNT) +\n\t\t\t   be64_to_cpu(mlx4_en_stats->RInRangeLengthErr) +\n\t\t\t   be64_to_cpu(mlx4_en_stats->ROutRangeLengthErr) +\n\t\t\t   be32_to_cpu(mlx4_en_stats->RSHORT) +\n\t\t\t   en_stats_adder(&mlx4_en_stats->RGIANT_prio_0,\n\t\t\t\t\t  &mlx4_en_stats->RGIANT_prio_1,\n\t\t\t\t\t  NUM_PRIORITIES);\n\tstats->tx_errors = en_stats_adder(&mlx4_en_stats->TGIANT_prio_0,\n\t\t\t\t\t  &mlx4_en_stats->TGIANT_prio_1,\n\t\t\t\t\t  NUM_PRIORITIES);\n\tstats->multicast = en_stats_adder(&mlx4_en_stats->MCAST_prio_0,\n\t\t\t\t\t  &mlx4_en_stats->MCAST_prio_1,\n\t\t\t\t\t  NUM_PRIORITIES);\n\tstats->rx_dropped = be32_to_cpu(mlx4_en_stats->RDROP) +\n\t\t\t    sw_rx_dropped;\n\tstats->rx_length_errors = be32_to_cpu(mlx4_en_stats->RdropLength);\n\tstats->rx_crc_errors = be32_to_cpu(mlx4_en_stats->RCRC);\n\tstats->rx_fifo_errors = be32_to_cpu(mlx4_en_stats->RdropOvflw);\n\tstats->tx_dropped = be32_to_cpu(mlx4_en_stats->TDROP) +\n\t\t\t    sw_tx_dropped;\n\n\t \n\tpriv->pkstats.rx_multicast_packets = stats->multicast;\n\tpriv->pkstats.rx_broadcast_packets =\n\t\t\ten_stats_adder(&mlx4_en_stats->RBCAST_prio_0,\n\t\t\t\t       &mlx4_en_stats->RBCAST_prio_1,\n\t\t\t\t       NUM_PRIORITIES);\n\tpriv->pkstats.rx_jabbers = be32_to_cpu(mlx4_en_stats->RJBBR);\n\tpriv->pkstats.rx_in_range_length_error =\n\t\tbe64_to_cpu(mlx4_en_stats->RInRangeLengthErr);\n\tpriv->pkstats.rx_out_range_length_error =\n\t\tbe64_to_cpu(mlx4_en_stats->ROutRangeLengthErr);\n\n\t \n\tpriv->pkstats.tx_multicast_packets =\n\t\ten_stats_adder(&mlx4_en_stats->TMCAST_prio_0,\n\t\t\t       &mlx4_en_stats->TMCAST_prio_1,\n\t\t\t       NUM_PRIORITIES);\n\tpriv->pkstats.tx_broadcast_packets =\n\t\ten_stats_adder(&mlx4_en_stats->TBCAST_prio_0,\n\t\t\t       &mlx4_en_stats->TBCAST_prio_1,\n\t\t\t       NUM_PRIORITIES);\n\n\tpriv->pkstats.rx_prio[0][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_0);\n\tpriv->pkstats.rx_prio[0][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_0);\n\tpriv->pkstats.rx_prio[1][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_1);\n\tpriv->pkstats.rx_prio[1][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_1);\n\tpriv->pkstats.rx_prio[2][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_2);\n\tpriv->pkstats.rx_prio[2][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_2);\n\tpriv->pkstats.rx_prio[3][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_3);\n\tpriv->pkstats.rx_prio[3][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_3);\n\tpriv->pkstats.rx_prio[4][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_4);\n\tpriv->pkstats.rx_prio[4][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_4);\n\tpriv->pkstats.rx_prio[5][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_5);\n\tpriv->pkstats.rx_prio[5][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_5);\n\tpriv->pkstats.rx_prio[6][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_6);\n\tpriv->pkstats.rx_prio[6][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_6);\n\tpriv->pkstats.rx_prio[7][0] = be64_to_cpu(mlx4_en_stats->RTOT_prio_7);\n\tpriv->pkstats.rx_prio[7][1] = be64_to_cpu(mlx4_en_stats->ROCT_prio_7);\n\tpriv->pkstats.rx_prio[8][0] = be64_to_cpu(mlx4_en_stats->RTOT_novlan);\n\tpriv->pkstats.rx_prio[8][1] = be64_to_cpu(mlx4_en_stats->ROCT_novlan);\n\tpriv->pkstats.tx_prio[0][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_0);\n\tpriv->pkstats.tx_prio[0][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_0);\n\tpriv->pkstats.tx_prio[1][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_1);\n\tpriv->pkstats.tx_prio[1][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_1);\n\tpriv->pkstats.tx_prio[2][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_2);\n\tpriv->pkstats.tx_prio[2][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_2);\n\tpriv->pkstats.tx_prio[3][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_3);\n\tpriv->pkstats.tx_prio[3][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_3);\n\tpriv->pkstats.tx_prio[4][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_4);\n\tpriv->pkstats.tx_prio[4][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_4);\n\tpriv->pkstats.tx_prio[5][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_5);\n\tpriv->pkstats.tx_prio[5][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_5);\n\tpriv->pkstats.tx_prio[6][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_6);\n\tpriv->pkstats.tx_prio[6][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_6);\n\tpriv->pkstats.tx_prio[7][0] = be64_to_cpu(mlx4_en_stats->TTOT_prio_7);\n\tpriv->pkstats.tx_prio[7][1] = be64_to_cpu(mlx4_en_stats->TOCT_prio_7);\n\tpriv->pkstats.tx_prio[8][0] = be64_to_cpu(mlx4_en_stats->TTOT_novlan);\n\tpriv->pkstats.tx_prio[8][1] = be64_to_cpu(mlx4_en_stats->TOCT_novlan);\n\n\tif (tmp_counter_stats.counter_mode == 0) {\n\t\tpriv->pf_stats.rx_bytes   = be64_to_cpu(tmp_counter_stats.rx_bytes);\n\t\tpriv->pf_stats.tx_bytes   = be64_to_cpu(tmp_counter_stats.tx_bytes);\n\t\tpriv->pf_stats.rx_packets = be64_to_cpu(tmp_counter_stats.rx_frames);\n\t\tpriv->pf_stats.tx_packets = be64_to_cpu(tmp_counter_stats.tx_frames);\n\t}\n\n\tfor (i = 0; i < MLX4_NUM_PRIORITIES; i++)\t{\n\t\tpriv->rx_priority_flowstats[i].rx_pause =\n\t\t\tbe64_to_cpu(flowstats[i].rx_pause);\n\t\tpriv->rx_priority_flowstats[i].rx_pause_duration =\n\t\t\tbe64_to_cpu(flowstats[i].rx_pause_duration);\n\t\tpriv->rx_priority_flowstats[i].rx_pause_transition =\n\t\t\tbe64_to_cpu(flowstats[i].rx_pause_transition);\n\t\tpriv->tx_priority_flowstats[i].tx_pause =\n\t\t\tbe64_to_cpu(flowstats[i].tx_pause);\n\t\tpriv->tx_priority_flowstats[i].tx_pause_duration =\n\t\t\tbe64_to_cpu(flowstats[i].tx_pause_duration);\n\t\tpriv->tx_priority_flowstats[i].tx_pause_transition =\n\t\t\tbe64_to_cpu(flowstats[i].tx_pause_transition);\n\t}\n\n\t \n\tpriv->rx_flowstats.rx_pause =\n\t\tbe64_to_cpu(flowstats[0].rx_pause);\n\tpriv->rx_flowstats.rx_pause_duration =\n\t\tbe64_to_cpu(flowstats[0].rx_pause_duration);\n\tpriv->rx_flowstats.rx_pause_transition =\n\t\tbe64_to_cpu(flowstats[0].rx_pause_transition);\n\tpriv->tx_flowstats.tx_pause =\n\t\tbe64_to_cpu(flowstats[0].tx_pause);\n\tpriv->tx_flowstats.tx_pause_duration =\n\t\tbe64_to_cpu(flowstats[0].tx_pause_duration);\n\tpriv->tx_flowstats.tx_pause_transition =\n\t\tbe64_to_cpu(flowstats[0].tx_pause_transition);\n\n\tspin_unlock_bh(&priv->stats_lock);\n\nout:\n\tmlx4_free_cmd_mailbox(mdev->dev, mailbox);\n\tmlx4_free_cmd_mailbox(mdev->dev, mailbox_priority);\n\treturn err;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}