{
  "module_name": "spectrum2_mr_tcam.c",
  "hash_id": "ba49edeb9efedd3fd65d9ad032dbaa0c7eba9357c100cb80505e70341adf1300",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlxsw/spectrum2_mr_tcam.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n\n#include \"core_acl_flex_actions.h\"\n#include \"spectrum.h\"\n#include \"spectrum_mr.h\"\n\nstruct mlxsw_sp2_mr_tcam {\n\tstruct mlxsw_sp *mlxsw_sp;\n\tstruct mlxsw_sp_flow_block *flow_block;\n\tstruct mlxsw_sp_acl_ruleset *ruleset4;\n\tstruct mlxsw_sp_acl_ruleset *ruleset6;\n};\n\nstruct mlxsw_sp2_mr_route {\n\tstruct mlxsw_sp2_mr_tcam *mr_tcam;\n};\n\nstatic struct mlxsw_sp_acl_ruleset *\nmlxsw_sp2_mr_tcam_proto_ruleset(struct mlxsw_sp2_mr_tcam *mr_tcam,\n\t\t\t\tenum mlxsw_sp_l3proto proto)\n{\n\tswitch (proto) {\n\tcase MLXSW_SP_L3_PROTO_IPV4:\n\t\treturn mr_tcam->ruleset4;\n\tcase MLXSW_SP_L3_PROTO_IPV6:\n\t\treturn mr_tcam->ruleset6;\n\t}\n\treturn NULL;\n}\n\nstatic int mlxsw_sp2_mr_tcam_bind_group(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\tenum mlxsw_reg_pemrbt_protocol protocol,\n\t\t\t\t\tstruct mlxsw_sp_acl_ruleset *ruleset)\n{\n\tchar pemrbt_pl[MLXSW_REG_PEMRBT_LEN];\n\tu16 group_id;\n\n\tgroup_id = mlxsw_sp_acl_ruleset_group_id(ruleset);\n\n\tmlxsw_reg_pemrbt_pack(pemrbt_pl, protocol, group_id);\n\treturn mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(pemrbt), pemrbt_pl);\n}\n\nstatic const enum mlxsw_afk_element mlxsw_sp2_mr_tcam_usage_ipv4[] = {\n\t\tMLXSW_AFK_ELEMENT_VIRT_ROUTER_MSB,\n\t\tMLXSW_AFK_ELEMENT_VIRT_ROUTER_LSB,\n\t\tMLXSW_AFK_ELEMENT_SRC_IP_0_31,\n\t\tMLXSW_AFK_ELEMENT_DST_IP_0_31,\n};\n\nstatic int mlxsw_sp2_mr_tcam_ipv4_init(struct mlxsw_sp2_mr_tcam *mr_tcam)\n{\n\tstruct mlxsw_afk_element_usage elusage;\n\tint err;\n\n\t \n\tmlxsw_afk_element_usage_fill(&elusage,\n\t\t\t\t     mlxsw_sp2_mr_tcam_usage_ipv4,\n\t\t\t\t     ARRAY_SIZE(mlxsw_sp2_mr_tcam_usage_ipv4));\n\tmr_tcam->ruleset4 = mlxsw_sp_acl_ruleset_get(mr_tcam->mlxsw_sp,\n\t\t\t\t\t\t     mr_tcam->flow_block,\n\t\t\t\t\t\t     MLXSW_SP_L3_PROTO_IPV4,\n\t\t\t\t\t\t     MLXSW_SP_ACL_PROFILE_MR,\n\t\t\t\t\t\t     &elusage);\n\n\tif (IS_ERR(mr_tcam->ruleset4))\n\t\treturn PTR_ERR(mr_tcam->ruleset4);\n\n\t \n\terr = mlxsw_sp2_mr_tcam_bind_group(mr_tcam->mlxsw_sp,\n\t\t\t\t\t   MLXSW_REG_PEMRBT_PROTO_IPV4,\n\t\t\t\t\t   mr_tcam->ruleset4);\n\tif (err)\n\t\tgoto err_bind_group;\n\n\treturn 0;\n\nerr_bind_group:\n\tmlxsw_sp_acl_ruleset_put(mr_tcam->mlxsw_sp, mr_tcam->ruleset4);\n\treturn err;\n}\n\nstatic void mlxsw_sp2_mr_tcam_ipv4_fini(struct mlxsw_sp2_mr_tcam *mr_tcam)\n{\n\tmlxsw_sp_acl_ruleset_put(mr_tcam->mlxsw_sp, mr_tcam->ruleset4);\n}\n\nstatic const enum mlxsw_afk_element mlxsw_sp2_mr_tcam_usage_ipv6[] = {\n\t\tMLXSW_AFK_ELEMENT_VIRT_ROUTER_MSB,\n\t\tMLXSW_AFK_ELEMENT_VIRT_ROUTER_LSB,\n\t\tMLXSW_AFK_ELEMENT_SRC_IP_96_127,\n\t\tMLXSW_AFK_ELEMENT_SRC_IP_64_95,\n\t\tMLXSW_AFK_ELEMENT_SRC_IP_32_63,\n\t\tMLXSW_AFK_ELEMENT_SRC_IP_0_31,\n\t\tMLXSW_AFK_ELEMENT_DST_IP_96_127,\n\t\tMLXSW_AFK_ELEMENT_DST_IP_64_95,\n\t\tMLXSW_AFK_ELEMENT_DST_IP_32_63,\n\t\tMLXSW_AFK_ELEMENT_DST_IP_0_31,\n};\n\nstatic int mlxsw_sp2_mr_tcam_ipv6_init(struct mlxsw_sp2_mr_tcam *mr_tcam)\n{\n\tstruct mlxsw_afk_element_usage elusage;\n\tint err;\n\n\t \n\tmlxsw_afk_element_usage_fill(&elusage,\n\t\t\t\t     mlxsw_sp2_mr_tcam_usage_ipv6,\n\t\t\t\t     ARRAY_SIZE(mlxsw_sp2_mr_tcam_usage_ipv6));\n\tmr_tcam->ruleset6 = mlxsw_sp_acl_ruleset_get(mr_tcam->mlxsw_sp,\n\t\t\t\t\t\t     mr_tcam->flow_block,\n\t\t\t\t\t\t     MLXSW_SP_L3_PROTO_IPV6,\n\t\t\t\t\t\t     MLXSW_SP_ACL_PROFILE_MR,\n\t\t\t\t\t\t     &elusage);\n\n\tif (IS_ERR(mr_tcam->ruleset6))\n\t\treturn PTR_ERR(mr_tcam->ruleset6);\n\n\t \n\terr = mlxsw_sp2_mr_tcam_bind_group(mr_tcam->mlxsw_sp,\n\t\t\t\t\t   MLXSW_REG_PEMRBT_PROTO_IPV6,\n\t\t\t\t\t   mr_tcam->ruleset6);\n\tif (err)\n\t\tgoto err_bind_group;\n\n\treturn 0;\n\nerr_bind_group:\n\tmlxsw_sp_acl_ruleset_put(mr_tcam->mlxsw_sp, mr_tcam->ruleset6);\n\treturn err;\n}\n\nstatic void mlxsw_sp2_mr_tcam_ipv6_fini(struct mlxsw_sp2_mr_tcam *mr_tcam)\n{\n\tmlxsw_sp_acl_ruleset_put(mr_tcam->mlxsw_sp, mr_tcam->ruleset6);\n}\n\nstatic void\nmlxsw_sp2_mr_tcam_rule_parse4(struct mlxsw_sp_acl_rule_info *rulei,\n\t\t\t      struct mlxsw_sp_mr_route_key *key)\n{\n\tmlxsw_sp_acl_rulei_keymask_buf(rulei, MLXSW_AFK_ELEMENT_SRC_IP_0_31,\n\t\t\t\t       (char *) &key->source.addr4,\n\t\t\t\t       (char *) &key->source_mask.addr4, 4);\n\tmlxsw_sp_acl_rulei_keymask_buf(rulei, MLXSW_AFK_ELEMENT_DST_IP_0_31,\n\t\t\t\t       (char *) &key->group.addr4,\n\t\t\t\t       (char *) &key->group_mask.addr4, 4);\n}\n\nstatic void\nmlxsw_sp2_mr_tcam_rule_parse6(struct mlxsw_sp_acl_rule_info *rulei,\n\t\t\t      struct mlxsw_sp_mr_route_key *key)\n{\n\tmlxsw_sp_acl_rulei_keymask_buf(rulei, MLXSW_AFK_ELEMENT_SRC_IP_96_127,\n\t\t\t\t       &key->source.addr6.s6_addr[0x0],\n\t\t\t\t       &key->source_mask.addr6.s6_addr[0x0], 4);\n\tmlxsw_sp_acl_rulei_keymask_buf(rulei, MLXSW_AFK_ELEMENT_SRC_IP_64_95,\n\t\t\t\t       &key->source.addr6.s6_addr[0x4],\n\t\t\t\t       &key->source_mask.addr6.s6_addr[0x4], 4);\n\tmlxsw_sp_acl_rulei_keymask_buf(rulei, MLXSW_AFK_ELEMENT_SRC_IP_32_63,\n\t\t\t\t       &key->source.addr6.s6_addr[0x8],\n\t\t\t\t       &key->source_mask.addr6.s6_addr[0x8], 4);\n\tmlxsw_sp_acl_rulei_keymask_buf(rulei, MLXSW_AFK_ELEMENT_SRC_IP_0_31,\n\t\t\t\t       &key->source.addr6.s6_addr[0xc],\n\t\t\t\t       &key->source_mask.addr6.s6_addr[0xc], 4);\n\tmlxsw_sp_acl_rulei_keymask_buf(rulei, MLXSW_AFK_ELEMENT_DST_IP_96_127,\n\t\t\t\t       &key->group.addr6.s6_addr[0x0],\n\t\t\t\t       &key->group_mask.addr6.s6_addr[0x0], 4);\n\tmlxsw_sp_acl_rulei_keymask_buf(rulei, MLXSW_AFK_ELEMENT_DST_IP_64_95,\n\t\t\t\t       &key->group.addr6.s6_addr[0x4],\n\t\t\t\t       &key->group_mask.addr6.s6_addr[0x4], 4);\n\tmlxsw_sp_acl_rulei_keymask_buf(rulei, MLXSW_AFK_ELEMENT_DST_IP_32_63,\n\t\t\t\t       &key->group.addr6.s6_addr[0x8],\n\t\t\t\t       &key->group_mask.addr6.s6_addr[0x8], 4);\n\tmlxsw_sp_acl_rulei_keymask_buf(rulei, MLXSW_AFK_ELEMENT_DST_IP_0_31,\n\t\t\t\t       &key->group.addr6.s6_addr[0xc],\n\t\t\t\t       &key->group_mask.addr6.s6_addr[0xc], 4);\n}\n\nstatic void\nmlxsw_sp2_mr_tcam_rule_parse(struct mlxsw_sp_acl_rule *rule,\n\t\t\t     struct mlxsw_sp_mr_route_key *key,\n\t\t\t     unsigned int priority)\n{\n\tstruct mlxsw_sp_acl_rule_info *rulei;\n\n\trulei = mlxsw_sp_acl_rule_rulei(rule);\n\trulei->priority = priority;\n\tmlxsw_sp_acl_rulei_keymask_u32(rulei, MLXSW_AFK_ELEMENT_VIRT_ROUTER_LSB,\n\t\t\t\t       key->vrid, GENMASK(7, 0));\n\tmlxsw_sp_acl_rulei_keymask_u32(rulei,\n\t\t\t\t       MLXSW_AFK_ELEMENT_VIRT_ROUTER_MSB,\n\t\t\t\t       key->vrid >> 8, GENMASK(3, 0));\n\tswitch (key->proto) {\n\tcase MLXSW_SP_L3_PROTO_IPV4:\n\t\treturn mlxsw_sp2_mr_tcam_rule_parse4(rulei, key);\n\tcase MLXSW_SP_L3_PROTO_IPV6:\n\t\treturn mlxsw_sp2_mr_tcam_rule_parse6(rulei, key);\n\t}\n}\n\nstatic int\nmlxsw_sp2_mr_tcam_route_create(struct mlxsw_sp *mlxsw_sp, void *priv,\n\t\t\t       void *route_priv,\n\t\t\t       struct mlxsw_sp_mr_route_key *key,\n\t\t\t       struct mlxsw_afa_block *afa_block,\n\t\t\t       enum mlxsw_sp_mr_route_prio prio)\n{\n\tstruct mlxsw_sp2_mr_route *mr_route = route_priv;\n\tstruct mlxsw_sp2_mr_tcam *mr_tcam = priv;\n\tstruct mlxsw_sp_acl_ruleset *ruleset;\n\tstruct mlxsw_sp_acl_rule *rule;\n\tint err;\n\n\tmr_route->mr_tcam = mr_tcam;\n\truleset = mlxsw_sp2_mr_tcam_proto_ruleset(mr_tcam, key->proto);\n\tif (WARN_ON(!ruleset))\n\t\treturn -EINVAL;\n\n\trule = mlxsw_sp_acl_rule_create(mlxsw_sp, ruleset,\n\t\t\t\t\t(unsigned long) route_priv, afa_block,\n\t\t\t\t\tNULL);\n\tif (IS_ERR(rule))\n\t\treturn PTR_ERR(rule);\n\n\tmlxsw_sp2_mr_tcam_rule_parse(rule, key, prio);\n\terr = mlxsw_sp_acl_rule_add(mlxsw_sp, rule);\n\tif (err)\n\t\tgoto err_rule_add;\n\n\treturn 0;\n\nerr_rule_add:\n\tmlxsw_sp_acl_rule_destroy(mlxsw_sp, rule);\n\treturn err;\n}\n\nstatic void\nmlxsw_sp2_mr_tcam_route_destroy(struct mlxsw_sp *mlxsw_sp, void *priv,\n\t\t\t\tvoid *route_priv,\n\t\t\t\tstruct mlxsw_sp_mr_route_key *key)\n{\n\tstruct mlxsw_sp2_mr_tcam *mr_tcam = priv;\n\tstruct mlxsw_sp_acl_ruleset *ruleset;\n\tstruct mlxsw_sp_acl_rule *rule;\n\n\truleset = mlxsw_sp2_mr_tcam_proto_ruleset(mr_tcam, key->proto);\n\tif (WARN_ON(!ruleset))\n\t\treturn;\n\n\trule = mlxsw_sp_acl_rule_lookup(mlxsw_sp, ruleset,\n\t\t\t\t\t(unsigned long) route_priv);\n\tif (WARN_ON(!rule))\n\t\treturn;\n\n\tmlxsw_sp_acl_rule_del(mlxsw_sp, rule);\n\tmlxsw_sp_acl_rule_destroy(mlxsw_sp, rule);\n}\n\nstatic int\nmlxsw_sp2_mr_tcam_route_update(struct mlxsw_sp *mlxsw_sp,\n\t\t\t       void *route_priv,\n\t\t\t       struct mlxsw_sp_mr_route_key *key,\n\t\t\t       struct mlxsw_afa_block *afa_block)\n{\n\tstruct mlxsw_sp2_mr_route *mr_route = route_priv;\n\tstruct mlxsw_sp2_mr_tcam *mr_tcam = mr_route->mr_tcam;\n\tstruct mlxsw_sp_acl_ruleset *ruleset;\n\tstruct mlxsw_sp_acl_rule *rule;\n\n\truleset = mlxsw_sp2_mr_tcam_proto_ruleset(mr_tcam, key->proto);\n\tif (WARN_ON(!ruleset))\n\t\treturn -EINVAL;\n\n\trule = mlxsw_sp_acl_rule_lookup(mlxsw_sp, ruleset,\n\t\t\t\t\t(unsigned long) route_priv);\n\tif (WARN_ON(!rule))\n\t\treturn -EINVAL;\n\n\treturn mlxsw_sp_acl_rule_action_replace(mlxsw_sp, rule, afa_block);\n}\n\nstatic int mlxsw_sp2_mr_tcam_init(struct mlxsw_sp *mlxsw_sp, void *priv)\n{\n\tstruct mlxsw_sp2_mr_tcam *mr_tcam = priv;\n\tint err;\n\n\tmr_tcam->mlxsw_sp = mlxsw_sp;\n\tmr_tcam->flow_block = mlxsw_sp_flow_block_create(mlxsw_sp, NULL);\n\tif (!mr_tcam->flow_block)\n\t\treturn -ENOMEM;\n\n\terr = mlxsw_sp2_mr_tcam_ipv4_init(mr_tcam);\n\tif (err)\n\t\tgoto err_ipv4_init;\n\n\terr = mlxsw_sp2_mr_tcam_ipv6_init(mr_tcam);\n\tif (err)\n\t\tgoto err_ipv6_init;\n\n\treturn 0;\n\nerr_ipv6_init:\n\tmlxsw_sp2_mr_tcam_ipv4_fini(mr_tcam);\nerr_ipv4_init:\n\tmlxsw_sp_flow_block_destroy(mr_tcam->flow_block);\n\treturn err;\n}\n\nstatic void mlxsw_sp2_mr_tcam_fini(void *priv)\n{\n\tstruct mlxsw_sp2_mr_tcam *mr_tcam = priv;\n\n\tmlxsw_sp2_mr_tcam_ipv6_fini(mr_tcam);\n\tmlxsw_sp2_mr_tcam_ipv4_fini(mr_tcam);\n\tmlxsw_sp_flow_block_destroy(mr_tcam->flow_block);\n}\n\nconst struct mlxsw_sp_mr_tcam_ops mlxsw_sp2_mr_tcam_ops = {\n\t.priv_size = sizeof(struct mlxsw_sp2_mr_tcam),\n\t.init = mlxsw_sp2_mr_tcam_init,\n\t.fini = mlxsw_sp2_mr_tcam_fini,\n\t.route_priv_size = sizeof(struct mlxsw_sp2_mr_route),\n\t.route_create = mlxsw_sp2_mr_tcam_route_create,\n\t.route_destroy = mlxsw_sp2_mr_tcam_route_destroy,\n\t.route_update = mlxsw_sp2_mr_tcam_route_update,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}