{
  "module_name": "spectrum_ethtool.c",
  "hash_id": "e0282e8349fa8246acba0702db84ccfb3614ba87376ccc234a3ad0a19bc0a60e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlxsw/spectrum_ethtool.c",
  "human_readable_source": "\n \n\n#include \"reg.h\"\n#include \"core.h\"\n#include \"spectrum.h\"\n#include \"core_env.h\"\n\nstatic const char mlxsw_sp_driver_version[] = \"1.0\";\n\nstatic void mlxsw_sp_port_get_drvinfo(struct net_device *dev,\n\t\t\t\t      struct ethtool_drvinfo *drvinfo)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\n\tstrscpy(drvinfo->driver, mlxsw_sp->bus_info->device_kind,\n\t\tsizeof(drvinfo->driver));\n\tstrscpy(drvinfo->version, mlxsw_sp_driver_version,\n\t\tsizeof(drvinfo->version));\n\tsnprintf(drvinfo->fw_version, sizeof(drvinfo->fw_version),\n\t\t \"%d.%d.%d\",\n\t\t mlxsw_sp->bus_info->fw_rev.major,\n\t\t mlxsw_sp->bus_info->fw_rev.minor,\n\t\t mlxsw_sp->bus_info->fw_rev.subminor);\n\tstrscpy(drvinfo->bus_info, mlxsw_sp->bus_info->device_name,\n\t\tsizeof(drvinfo->bus_info));\n}\n\nstruct mlxsw_sp_ethtool_link_ext_state_opcode_mapping {\n\tu32 status_opcode;\n\tenum ethtool_link_ext_state link_ext_state;\n\tu8 link_ext_substate;\n};\n\nstatic const struct mlxsw_sp_ethtool_link_ext_state_opcode_mapping\nmlxsw_sp_link_ext_state_opcode_map[] = {\n\t{2, ETHTOOL_LINK_EXT_STATE_AUTONEG,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_AN_NO_PARTNER_DETECTED},\n\t{3, ETHTOOL_LINK_EXT_STATE_AUTONEG,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_AN_ACK_NOT_RECEIVED},\n\t{4, ETHTOOL_LINK_EXT_STATE_AUTONEG,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_AN_NEXT_PAGE_EXCHANGE_FAILED},\n\t{36, ETHTOOL_LINK_EXT_STATE_AUTONEG,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_AN_NO_PARTNER_DETECTED_FORCE_MODE},\n\t{38, ETHTOOL_LINK_EXT_STATE_AUTONEG,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_AN_FEC_MISMATCH_DURING_OVERRIDE},\n\t{39, ETHTOOL_LINK_EXT_STATE_AUTONEG,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_AN_NO_HCD},\n\n\t{5, ETHTOOL_LINK_EXT_STATE_LINK_TRAINING_FAILURE,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_LT_KR_FRAME_LOCK_NOT_ACQUIRED},\n\t{6, ETHTOOL_LINK_EXT_STATE_LINK_TRAINING_FAILURE,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_LT_KR_LINK_INHIBIT_TIMEOUT},\n\t{7, ETHTOOL_LINK_EXT_STATE_LINK_TRAINING_FAILURE,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_LT_KR_LINK_PARTNER_DID_NOT_SET_RECEIVER_READY},\n\t{8, ETHTOOL_LINK_EXT_STATE_LINK_TRAINING_FAILURE, 0},\n\t{14, ETHTOOL_LINK_EXT_STATE_LINK_TRAINING_FAILURE,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_LT_REMOTE_FAULT},\n\n\t{9, ETHTOOL_LINK_EXT_STATE_LINK_LOGICAL_MISMATCH,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_LLM_PCS_DID_NOT_ACQUIRE_BLOCK_LOCK},\n\t{10, ETHTOOL_LINK_EXT_STATE_LINK_LOGICAL_MISMATCH,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_LLM_PCS_DID_NOT_ACQUIRE_AM_LOCK},\n\t{11, ETHTOOL_LINK_EXT_STATE_LINK_LOGICAL_MISMATCH,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_LLM_PCS_DID_NOT_GET_ALIGN_STATUS},\n\t{12, ETHTOOL_LINK_EXT_STATE_LINK_LOGICAL_MISMATCH,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_LLM_FC_FEC_IS_NOT_LOCKED},\n\t{13, ETHTOOL_LINK_EXT_STATE_LINK_LOGICAL_MISMATCH,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_LLM_RS_FEC_IS_NOT_LOCKED},\n\n\t{15, ETHTOOL_LINK_EXT_STATE_BAD_SIGNAL_INTEGRITY, 0},\n\t{17, ETHTOOL_LINK_EXT_STATE_BAD_SIGNAL_INTEGRITY,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_BSI_LARGE_NUMBER_OF_PHYSICAL_ERRORS},\n\t{42, ETHTOOL_LINK_EXT_STATE_BAD_SIGNAL_INTEGRITY,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_BSI_UNSUPPORTED_RATE},\n\n\t{1024, ETHTOOL_LINK_EXT_STATE_NO_CABLE, 0},\n\n\t{16, ETHTOOL_LINK_EXT_STATE_CABLE_ISSUE,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_CI_UNSUPPORTED_CABLE},\n\t{20, ETHTOOL_LINK_EXT_STATE_CABLE_ISSUE,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_CI_UNSUPPORTED_CABLE},\n\t{29, ETHTOOL_LINK_EXT_STATE_CABLE_ISSUE,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_CI_UNSUPPORTED_CABLE},\n\t{1025, ETHTOOL_LINK_EXT_STATE_CABLE_ISSUE,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_CI_UNSUPPORTED_CABLE},\n\t{1029, ETHTOOL_LINK_EXT_STATE_CABLE_ISSUE,\n\t\tETHTOOL_LINK_EXT_SUBSTATE_CI_UNSUPPORTED_CABLE},\n\t{1031, ETHTOOL_LINK_EXT_STATE_CABLE_ISSUE, 0},\n\n\t{1027, ETHTOOL_LINK_EXT_STATE_EEPROM_ISSUE, 0},\n\n\t{23, ETHTOOL_LINK_EXT_STATE_CALIBRATION_FAILURE, 0},\n\n\t{1032, ETHTOOL_LINK_EXT_STATE_POWER_BUDGET_EXCEEDED, 0},\n\n\t{1030, ETHTOOL_LINK_EXT_STATE_OVERHEAT, 0},\n\n\t{1042, ETHTOOL_LINK_EXT_STATE_MODULE,\n\t ETHTOOL_LINK_EXT_SUBSTATE_MODULE_CMIS_NOT_READY},\n};\n\nstatic void\nmlxsw_sp_port_set_link_ext_state(struct mlxsw_sp_ethtool_link_ext_state_opcode_mapping\n\t\t\t\t link_ext_state_mapping,\n\t\t\t\t struct ethtool_link_ext_state_info *link_ext_state_info)\n{\n\tswitch (link_ext_state_mapping.link_ext_state) {\n\tcase ETHTOOL_LINK_EXT_STATE_AUTONEG:\n\t\tlink_ext_state_info->autoneg =\n\t\t\tlink_ext_state_mapping.link_ext_substate;\n\t\tbreak;\n\tcase ETHTOOL_LINK_EXT_STATE_LINK_TRAINING_FAILURE:\n\t\tlink_ext_state_info->link_training =\n\t\t\tlink_ext_state_mapping.link_ext_substate;\n\t\tbreak;\n\tcase ETHTOOL_LINK_EXT_STATE_LINK_LOGICAL_MISMATCH:\n\t\tlink_ext_state_info->link_logical_mismatch =\n\t\t\tlink_ext_state_mapping.link_ext_substate;\n\t\tbreak;\n\tcase ETHTOOL_LINK_EXT_STATE_BAD_SIGNAL_INTEGRITY:\n\t\tlink_ext_state_info->bad_signal_integrity =\n\t\t\tlink_ext_state_mapping.link_ext_substate;\n\t\tbreak;\n\tcase ETHTOOL_LINK_EXT_STATE_CABLE_ISSUE:\n\t\tlink_ext_state_info->cable_issue =\n\t\t\tlink_ext_state_mapping.link_ext_substate;\n\t\tbreak;\n\tcase ETHTOOL_LINK_EXT_STATE_MODULE:\n\t\tlink_ext_state_info->module =\n\t\t\tlink_ext_state_mapping.link_ext_substate;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tlink_ext_state_info->link_ext_state = link_ext_state_mapping.link_ext_state;\n}\n\nstatic int\nmlxsw_sp_port_get_link_ext_state(struct net_device *dev,\n\t\t\t\t struct ethtool_link_ext_state_info *link_ext_state_info)\n{\n\tstruct mlxsw_sp_ethtool_link_ext_state_opcode_mapping link_ext_state_mapping;\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tchar pddr_pl[MLXSW_REG_PDDR_LEN];\n\tint opcode, err, i;\n\tu32 status_opcode;\n\n\tif (netif_carrier_ok(dev))\n\t\treturn -ENODATA;\n\n\tmlxsw_reg_pddr_pack(pddr_pl, mlxsw_sp_port->local_port,\n\t\t\t    MLXSW_REG_PDDR_PAGE_SELECT_TROUBLESHOOTING_INFO);\n\n\topcode = MLXSW_REG_PDDR_TRBLSH_GROUP_OPCODE_MONITOR;\n\tmlxsw_reg_pddr_trblsh_group_opcode_set(pddr_pl, opcode);\n\n\terr = mlxsw_reg_query(mlxsw_sp_port->mlxsw_sp->core, MLXSW_REG(pddr),\n\t\t\t      pddr_pl);\n\tif (err)\n\t\treturn err;\n\n\tstatus_opcode = mlxsw_reg_pddr_trblsh_status_opcode_get(pddr_pl);\n\tif (!status_opcode)\n\t\treturn -ENODATA;\n\n\tfor (i = 0; i < ARRAY_SIZE(mlxsw_sp_link_ext_state_opcode_map); i++) {\n\t\tlink_ext_state_mapping = mlxsw_sp_link_ext_state_opcode_map[i];\n\t\tif (link_ext_state_mapping.status_opcode == status_opcode) {\n\t\t\tmlxsw_sp_port_set_link_ext_state(link_ext_state_mapping,\n\t\t\t\t\t\t\t link_ext_state_info);\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\treturn -ENODATA;\n}\n\nstatic void mlxsw_sp_port_get_pauseparam(struct net_device *dev,\n\t\t\t\t\t struct ethtool_pauseparam *pause)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\n\tpause->rx_pause = mlxsw_sp_port->link.rx_pause;\n\tpause->tx_pause = mlxsw_sp_port->link.tx_pause;\n}\n\nstatic int mlxsw_sp_port_pause_set(struct mlxsw_sp_port *mlxsw_sp_port,\n\t\t\t\t   struct ethtool_pauseparam *pause)\n{\n\tchar pfcc_pl[MLXSW_REG_PFCC_LEN];\n\n\tmlxsw_reg_pfcc_pack(pfcc_pl, mlxsw_sp_port->local_port);\n\tmlxsw_reg_pfcc_pprx_set(pfcc_pl, pause->rx_pause);\n\tmlxsw_reg_pfcc_pptx_set(pfcc_pl, pause->tx_pause);\n\n\treturn mlxsw_reg_write(mlxsw_sp_port->mlxsw_sp->core, MLXSW_REG(pfcc),\n\t\t\t       pfcc_pl);\n}\n\n \n#define MLXSW_SP_PAUSE_DELAY_BYTES 19476\n\nstatic int mlxsw_sp_port_set_pauseparam(struct net_device *dev,\n\t\t\t\t\tstruct ethtool_pauseparam *pause)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tbool pause_en = pause->tx_pause || pause->rx_pause;\n\tstruct mlxsw_sp_hdroom orig_hdroom;\n\tstruct mlxsw_sp_hdroom hdroom;\n\tint prio;\n\tint err;\n\n\tif (mlxsw_sp_port->dcb.pfc && mlxsw_sp_port->dcb.pfc->pfc_en) {\n\t\tnetdev_err(dev, \"PFC already enabled on port\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (pause->autoneg) {\n\t\tnetdev_err(dev, \"PAUSE frames autonegotiation isn't supported\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\torig_hdroom = *mlxsw_sp_port->hdroom;\n\n\thdroom = orig_hdroom;\n\tif (pause_en)\n\t\thdroom.delay_bytes = MLXSW_SP_PAUSE_DELAY_BYTES;\n\telse\n\t\thdroom.delay_bytes = 0;\n\n\tfor (prio = 0; prio < IEEE_8021QAZ_MAX_TCS; prio++)\n\t\thdroom.prios.prio[prio].lossy = !pause_en;\n\n\tmlxsw_sp_hdroom_bufs_reset_lossiness(&hdroom);\n\tmlxsw_sp_hdroom_bufs_reset_sizes(mlxsw_sp_port, &hdroom);\n\n\terr = mlxsw_sp_hdroom_configure(mlxsw_sp_port, &hdroom);\n\tif (err) {\n\t\tnetdev_err(dev, \"Failed to configure port's headroom\\n\");\n\t\treturn err;\n\t}\n\n\terr = mlxsw_sp_port_pause_set(mlxsw_sp_port, pause);\n\tif (err) {\n\t\tnetdev_err(dev, \"Failed to set PAUSE parameters\\n\");\n\t\tgoto err_port_pause_configure;\n\t}\n\n\tmlxsw_sp_port->link.rx_pause = pause->rx_pause;\n\tmlxsw_sp_port->link.tx_pause = pause->tx_pause;\n\n\treturn 0;\n\nerr_port_pause_configure:\n\tmlxsw_sp_hdroom_configure(mlxsw_sp_port, &orig_hdroom);\n\treturn err;\n}\n\nstruct mlxsw_sp_port_hw_stats {\n\tchar str[ETH_GSTRING_LEN];\n\tu64 (*getter)(const char *payload);\n\tbool cells_bytes;\n};\n\nstatic struct mlxsw_sp_port_hw_stats mlxsw_sp_port_hw_stats[] = {\n\t{\n\t\t.str = \"a_frames_transmitted_ok\",\n\t\t.getter = mlxsw_reg_ppcnt_a_frames_transmitted_ok_get,\n\t},\n\t{\n\t\t.str = \"a_frames_received_ok\",\n\t\t.getter = mlxsw_reg_ppcnt_a_frames_received_ok_get,\n\t},\n\t{\n\t\t.str = \"a_frame_check_sequence_errors\",\n\t\t.getter = mlxsw_reg_ppcnt_a_frame_check_sequence_errors_get,\n\t},\n\t{\n\t\t.str = \"a_alignment_errors\",\n\t\t.getter = mlxsw_reg_ppcnt_a_alignment_errors_get,\n\t},\n\t{\n\t\t.str = \"a_octets_transmitted_ok\",\n\t\t.getter = mlxsw_reg_ppcnt_a_octets_transmitted_ok_get,\n\t},\n\t{\n\t\t.str = \"a_octets_received_ok\",\n\t\t.getter = mlxsw_reg_ppcnt_a_octets_received_ok_get,\n\t},\n\t{\n\t\t.str = \"a_multicast_frames_xmitted_ok\",\n\t\t.getter = mlxsw_reg_ppcnt_a_multicast_frames_xmitted_ok_get,\n\t},\n\t{\n\t\t.str = \"a_broadcast_frames_xmitted_ok\",\n\t\t.getter = mlxsw_reg_ppcnt_a_broadcast_frames_xmitted_ok_get,\n\t},\n\t{\n\t\t.str = \"a_multicast_frames_received_ok\",\n\t\t.getter = mlxsw_reg_ppcnt_a_multicast_frames_received_ok_get,\n\t},\n\t{\n\t\t.str = \"a_broadcast_frames_received_ok\",\n\t\t.getter = mlxsw_reg_ppcnt_a_broadcast_frames_received_ok_get,\n\t},\n\t{\n\t\t.str = \"a_in_range_length_errors\",\n\t\t.getter = mlxsw_reg_ppcnt_a_in_range_length_errors_get,\n\t},\n\t{\n\t\t.str = \"a_out_of_range_length_field\",\n\t\t.getter = mlxsw_reg_ppcnt_a_out_of_range_length_field_get,\n\t},\n\t{\n\t\t.str = \"a_frame_too_long_errors\",\n\t\t.getter = mlxsw_reg_ppcnt_a_frame_too_long_errors_get,\n\t},\n\t{\n\t\t.str = \"a_symbol_error_during_carrier\",\n\t\t.getter = mlxsw_reg_ppcnt_a_symbol_error_during_carrier_get,\n\t},\n\t{\n\t\t.str = \"a_mac_control_frames_transmitted\",\n\t\t.getter = mlxsw_reg_ppcnt_a_mac_control_frames_transmitted_get,\n\t},\n\t{\n\t\t.str = \"a_mac_control_frames_received\",\n\t\t.getter = mlxsw_reg_ppcnt_a_mac_control_frames_received_get,\n\t},\n\t{\n\t\t.str = \"a_unsupported_opcodes_received\",\n\t\t.getter = mlxsw_reg_ppcnt_a_unsupported_opcodes_received_get,\n\t},\n\t{\n\t\t.str = \"a_pause_mac_ctrl_frames_received\",\n\t\t.getter = mlxsw_reg_ppcnt_a_pause_mac_ctrl_frames_received_get,\n\t},\n\t{\n\t\t.str = \"a_pause_mac_ctrl_frames_xmitted\",\n\t\t.getter = mlxsw_reg_ppcnt_a_pause_mac_ctrl_frames_transmitted_get,\n\t},\n};\n\n#define MLXSW_SP_PORT_HW_STATS_LEN ARRAY_SIZE(mlxsw_sp_port_hw_stats)\n\nstatic struct mlxsw_sp_port_hw_stats mlxsw_sp_port_hw_rfc_2863_stats[] = {\n\t{\n\t\t.str = \"if_in_discards\",\n\t\t.getter = mlxsw_reg_ppcnt_if_in_discards_get,\n\t},\n\t{\n\t\t.str = \"if_out_discards\",\n\t\t.getter = mlxsw_reg_ppcnt_if_out_discards_get,\n\t},\n\t{\n\t\t.str = \"if_out_errors\",\n\t\t.getter = mlxsw_reg_ppcnt_if_out_errors_get,\n\t},\n};\n\n#define MLXSW_SP_PORT_HW_RFC_2863_STATS_LEN \\\n\tARRAY_SIZE(mlxsw_sp_port_hw_rfc_2863_stats)\n\nstatic struct mlxsw_sp_port_hw_stats mlxsw_sp_port_hw_rfc_2819_stats[] = {\n\t{\n\t\t.str = \"ether_stats_undersize_pkts\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_undersize_pkts_get,\n\t},\n\t{\n\t\t.str = \"ether_stats_oversize_pkts\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_oversize_pkts_get,\n\t},\n\t{\n\t\t.str = \"ether_stats_fragments\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_fragments_get,\n\t},\n\t{\n\t\t.str = \"ether_pkts64octets\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_pkts64octets_get,\n\t},\n\t{\n\t\t.str = \"ether_pkts65to127octets\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_pkts65to127octets_get,\n\t},\n\t{\n\t\t.str = \"ether_pkts128to255octets\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_pkts128to255octets_get,\n\t},\n\t{\n\t\t.str = \"ether_pkts256to511octets\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_pkts256to511octets_get,\n\t},\n\t{\n\t\t.str = \"ether_pkts512to1023octets\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_pkts512to1023octets_get,\n\t},\n\t{\n\t\t.str = \"ether_pkts1024to1518octets\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_pkts1024to1518octets_get,\n\t},\n\t{\n\t\t.str = \"ether_pkts1519to2047octets\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_pkts1519to2047octets_get,\n\t},\n\t{\n\t\t.str = \"ether_pkts2048to4095octets\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_pkts2048to4095octets_get,\n\t},\n\t{\n\t\t.str = \"ether_pkts4096to8191octets\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_pkts4096to8191octets_get,\n\t},\n\t{\n\t\t.str = \"ether_pkts8192to10239octets\",\n\t\t.getter = mlxsw_reg_ppcnt_ether_stats_pkts8192to10239octets_get,\n\t},\n};\n\n#define MLXSW_SP_PORT_HW_RFC_2819_STATS_LEN \\\n\tARRAY_SIZE(mlxsw_sp_port_hw_rfc_2819_stats)\n\nstatic struct mlxsw_sp_port_hw_stats mlxsw_sp_port_hw_rfc_3635_stats[] = {\n\t{\n\t\t.str = \"dot3stats_fcs_errors\",\n\t\t.getter = mlxsw_reg_ppcnt_dot3stats_fcs_errors_get,\n\t},\n\t{\n\t\t.str = \"dot3stats_symbol_errors\",\n\t\t.getter = mlxsw_reg_ppcnt_dot3stats_symbol_errors_get,\n\t},\n\t{\n\t\t.str = \"dot3control_in_unknown_opcodes\",\n\t\t.getter = mlxsw_reg_ppcnt_dot3control_in_unknown_opcodes_get,\n\t},\n\t{\n\t\t.str = \"dot3in_pause_frames\",\n\t\t.getter = mlxsw_reg_ppcnt_dot3in_pause_frames_get,\n\t},\n};\n\n#define MLXSW_SP_PORT_HW_RFC_3635_STATS_LEN \\\n\tARRAY_SIZE(mlxsw_sp_port_hw_rfc_3635_stats)\n\nstatic struct mlxsw_sp_port_hw_stats mlxsw_sp_port_hw_ext_stats[] = {\n\t{\n\t\t.str = \"ecn_marked\",\n\t\t.getter = mlxsw_reg_ppcnt_ecn_marked_get,\n\t},\n};\n\n#define MLXSW_SP_PORT_HW_EXT_STATS_LEN ARRAY_SIZE(mlxsw_sp_port_hw_ext_stats)\n\nstatic struct mlxsw_sp_port_hw_stats mlxsw_sp_port_hw_discard_stats[] = {\n\t{\n\t\t.str = \"discard_ingress_general\",\n\t\t.getter = mlxsw_reg_ppcnt_ingress_general_get,\n\t},\n\t{\n\t\t.str = \"discard_ingress_policy_engine\",\n\t\t.getter = mlxsw_reg_ppcnt_ingress_policy_engine_get,\n\t},\n\t{\n\t\t.str = \"discard_ingress_vlan_membership\",\n\t\t.getter = mlxsw_reg_ppcnt_ingress_vlan_membership_get,\n\t},\n\t{\n\t\t.str = \"discard_ingress_tag_frame_type\",\n\t\t.getter = mlxsw_reg_ppcnt_ingress_tag_frame_type_get,\n\t},\n\t{\n\t\t.str = \"discard_egress_vlan_membership\",\n\t\t.getter = mlxsw_reg_ppcnt_egress_vlan_membership_get,\n\t},\n\t{\n\t\t.str = \"discard_loopback_filter\",\n\t\t.getter = mlxsw_reg_ppcnt_loopback_filter_get,\n\t},\n\t{\n\t\t.str = \"discard_egress_general\",\n\t\t.getter = mlxsw_reg_ppcnt_egress_general_get,\n\t},\n\t{\n\t\t.str = \"discard_egress_hoq\",\n\t\t.getter = mlxsw_reg_ppcnt_egress_hoq_get,\n\t},\n\t{\n\t\t.str = \"discard_egress_policy_engine\",\n\t\t.getter = mlxsw_reg_ppcnt_egress_policy_engine_get,\n\t},\n\t{\n\t\t.str = \"discard_ingress_tx_link_down\",\n\t\t.getter = mlxsw_reg_ppcnt_ingress_tx_link_down_get,\n\t},\n\t{\n\t\t.str = \"discard_egress_stp_filter\",\n\t\t.getter = mlxsw_reg_ppcnt_egress_stp_filter_get,\n\t},\n\t{\n\t\t.str = \"discard_egress_sll\",\n\t\t.getter = mlxsw_reg_ppcnt_egress_sll_get,\n\t},\n};\n\n#define MLXSW_SP_PORT_HW_DISCARD_STATS_LEN \\\n\tARRAY_SIZE(mlxsw_sp_port_hw_discard_stats)\n\nstatic struct mlxsw_sp_port_hw_stats mlxsw_sp_port_hw_prio_stats[] = {\n\t{\n\t\t.str = \"rx_octets_prio\",\n\t\t.getter = mlxsw_reg_ppcnt_rx_octets_get,\n\t},\n\t{\n\t\t.str = \"rx_frames_prio\",\n\t\t.getter = mlxsw_reg_ppcnt_rx_frames_get,\n\t},\n\t{\n\t\t.str = \"tx_octets_prio\",\n\t\t.getter = mlxsw_reg_ppcnt_tx_octets_get,\n\t},\n\t{\n\t\t.str = \"tx_frames_prio\",\n\t\t.getter = mlxsw_reg_ppcnt_tx_frames_get,\n\t},\n\t{\n\t\t.str = \"rx_pause_prio\",\n\t\t.getter = mlxsw_reg_ppcnt_rx_pause_get,\n\t},\n\t{\n\t\t.str = \"rx_pause_duration_prio\",\n\t\t.getter = mlxsw_reg_ppcnt_rx_pause_duration_get,\n\t},\n\t{\n\t\t.str = \"tx_pause_prio\",\n\t\t.getter = mlxsw_reg_ppcnt_tx_pause_get,\n\t},\n\t{\n\t\t.str = \"tx_pause_duration_prio\",\n\t\t.getter = mlxsw_reg_ppcnt_tx_pause_duration_get,\n\t},\n};\n\n#define MLXSW_SP_PORT_HW_PRIO_STATS_LEN ARRAY_SIZE(mlxsw_sp_port_hw_prio_stats)\n\nstatic struct mlxsw_sp_port_hw_stats mlxsw_sp_port_hw_tc_stats[] = {\n\t{\n\t\t.str = \"tc_transmit_queue_tc\",\n\t\t.getter = mlxsw_reg_ppcnt_tc_transmit_queue_get,\n\t\t.cells_bytes = true,\n\t},\n\t{\n\t\t.str = \"tc_no_buffer_discard_uc_tc\",\n\t\t.getter = mlxsw_reg_ppcnt_tc_no_buffer_discard_uc_get,\n\t},\n};\n\n#define MLXSW_SP_PORT_HW_TC_STATS_LEN ARRAY_SIZE(mlxsw_sp_port_hw_tc_stats)\n\nstruct mlxsw_sp_port_stats {\n\tchar str[ETH_GSTRING_LEN];\n\tu64 (*getter)(struct mlxsw_sp_port *mlxsw_sp_port);\n};\n\nstatic u64\nmlxsw_sp_port_get_transceiver_overheat_stats(struct mlxsw_sp_port *mlxsw_sp_port)\n{\n\tstruct mlxsw_core *mlxsw_core = mlxsw_sp_port->mlxsw_sp->core;\n\tu8 slot_index = mlxsw_sp_port->mapping.slot_index;\n\tu8 module = mlxsw_sp_port->mapping.module;\n\tu64 stats;\n\tint err;\n\n\terr = mlxsw_env_module_overheat_counter_get(mlxsw_core, slot_index,\n\t\t\t\t\t\t    module, &stats);\n\tif (err)\n\t\treturn mlxsw_sp_port->module_overheat_initial_val;\n\n\treturn stats - mlxsw_sp_port->module_overheat_initial_val;\n}\n\nstatic struct mlxsw_sp_port_stats mlxsw_sp_port_transceiver_stats[] = {\n\t{\n\t\t.str = \"transceiver_overheat\",\n\t\t.getter = mlxsw_sp_port_get_transceiver_overheat_stats,\n\t},\n};\n\n#define MLXSW_SP_PORT_HW_TRANSCEIVER_STATS_LEN ARRAY_SIZE(mlxsw_sp_port_transceiver_stats)\n\n#define MLXSW_SP_PORT_ETHTOOL_STATS_LEN (MLXSW_SP_PORT_HW_STATS_LEN + \\\n\t\t\t\t\t MLXSW_SP_PORT_HW_RFC_2863_STATS_LEN + \\\n\t\t\t\t\t MLXSW_SP_PORT_HW_RFC_2819_STATS_LEN + \\\n\t\t\t\t\t MLXSW_SP_PORT_HW_RFC_3635_STATS_LEN + \\\n\t\t\t\t\t MLXSW_SP_PORT_HW_EXT_STATS_LEN + \\\n\t\t\t\t\t MLXSW_SP_PORT_HW_DISCARD_STATS_LEN + \\\n\t\t\t\t\t (MLXSW_SP_PORT_HW_PRIO_STATS_LEN * \\\n\t\t\t\t\t  IEEE_8021QAZ_MAX_TCS) + \\\n\t\t\t\t\t (MLXSW_SP_PORT_HW_TC_STATS_LEN * \\\n\t\t\t\t\t  TC_MAX_QUEUE) + \\\n\t\t\t\t\t  MLXSW_SP_PORT_HW_TRANSCEIVER_STATS_LEN)\n\nstatic void mlxsw_sp_port_get_prio_strings(u8 **p, int prio)\n{\n\tint i;\n\n\tfor (i = 0; i < MLXSW_SP_PORT_HW_PRIO_STATS_LEN; i++) {\n\t\tsnprintf(*p, ETH_GSTRING_LEN, \"%.29s_%.1d\",\n\t\t\t mlxsw_sp_port_hw_prio_stats[i].str, prio);\n\t\t*p += ETH_GSTRING_LEN;\n\t}\n}\n\nstatic void mlxsw_sp_port_get_tc_strings(u8 **p, int tc)\n{\n\tint i;\n\n\tfor (i = 0; i < MLXSW_SP_PORT_HW_TC_STATS_LEN; i++) {\n\t\tsnprintf(*p, ETH_GSTRING_LEN, \"%.29s_%.1d\",\n\t\t\t mlxsw_sp_port_hw_tc_stats[i].str, tc);\n\t\t*p += ETH_GSTRING_LEN;\n\t}\n}\n\nstatic void mlxsw_sp_port_get_strings(struct net_device *dev,\n\t\t\t\t      u32 stringset, u8 *data)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tu8 *p = data;\n\tint i;\n\n\tswitch (stringset) {\n\tcase ETH_SS_STATS:\n\t\tfor (i = 0; i < MLXSW_SP_PORT_HW_STATS_LEN; i++) {\n\t\t\tmemcpy(p, mlxsw_sp_port_hw_stats[i].str,\n\t\t\t       ETH_GSTRING_LEN);\n\t\t\tp += ETH_GSTRING_LEN;\n\t\t}\n\n\t\tfor (i = 0; i < MLXSW_SP_PORT_HW_RFC_2863_STATS_LEN; i++) {\n\t\t\tmemcpy(p, mlxsw_sp_port_hw_rfc_2863_stats[i].str,\n\t\t\t       ETH_GSTRING_LEN);\n\t\t\tp += ETH_GSTRING_LEN;\n\t\t}\n\n\t\tfor (i = 0; i < MLXSW_SP_PORT_HW_RFC_2819_STATS_LEN; i++) {\n\t\t\tmemcpy(p, mlxsw_sp_port_hw_rfc_2819_stats[i].str,\n\t\t\t       ETH_GSTRING_LEN);\n\t\t\tp += ETH_GSTRING_LEN;\n\t\t}\n\n\t\tfor (i = 0; i < MLXSW_SP_PORT_HW_RFC_3635_STATS_LEN; i++) {\n\t\t\tmemcpy(p, mlxsw_sp_port_hw_rfc_3635_stats[i].str,\n\t\t\t       ETH_GSTRING_LEN);\n\t\t\tp += ETH_GSTRING_LEN;\n\t\t}\n\n\t\tfor (i = 0; i < MLXSW_SP_PORT_HW_EXT_STATS_LEN; i++) {\n\t\t\tmemcpy(p, mlxsw_sp_port_hw_ext_stats[i].str,\n\t\t\t       ETH_GSTRING_LEN);\n\t\t\tp += ETH_GSTRING_LEN;\n\t\t}\n\n\t\tfor (i = 0; i < MLXSW_SP_PORT_HW_DISCARD_STATS_LEN; i++) {\n\t\t\tmemcpy(p, mlxsw_sp_port_hw_discard_stats[i].str,\n\t\t\t       ETH_GSTRING_LEN);\n\t\t\tp += ETH_GSTRING_LEN;\n\t\t}\n\n\t\tfor (i = 0; i < IEEE_8021QAZ_MAX_TCS; i++)\n\t\t\tmlxsw_sp_port_get_prio_strings(&p, i);\n\n\t\tfor (i = 0; i < TC_MAX_QUEUE; i++)\n\t\t\tmlxsw_sp_port_get_tc_strings(&p, i);\n\n\t\tmlxsw_sp_port->mlxsw_sp->ptp_ops->get_stats_strings(&p);\n\n\t\tfor (i = 0; i < MLXSW_SP_PORT_HW_TRANSCEIVER_STATS_LEN; i++) {\n\t\t\tmemcpy(p, mlxsw_sp_port_transceiver_stats[i].str,\n\t\t\t       ETH_GSTRING_LEN);\n\t\t\tp += ETH_GSTRING_LEN;\n\t\t}\n\t\tbreak;\n\t}\n}\n\nstatic int mlxsw_sp_port_set_phys_id(struct net_device *dev,\n\t\t\t\t     enum ethtool_phys_id_state state)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\tchar mlcr_pl[MLXSW_REG_MLCR_LEN];\n\tbool active;\n\n\tswitch (state) {\n\tcase ETHTOOL_ID_ACTIVE:\n\t\tactive = true;\n\t\tbreak;\n\tcase ETHTOOL_ID_INACTIVE:\n\t\tactive = false;\n\t\tbreak;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tmlxsw_reg_mlcr_pack(mlcr_pl, mlxsw_sp_port->local_port, active);\n\treturn mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(mlcr), mlcr_pl);\n}\n\nstatic int\nmlxsw_sp_get_hw_stats_by_group(struct mlxsw_sp_port_hw_stats **p_hw_stats,\n\t\t\t       int *p_len, enum mlxsw_reg_ppcnt_grp grp)\n{\n\tswitch (grp) {\n\tcase MLXSW_REG_PPCNT_IEEE_8023_CNT:\n\t\t*p_hw_stats = mlxsw_sp_port_hw_stats;\n\t\t*p_len = MLXSW_SP_PORT_HW_STATS_LEN;\n\t\tbreak;\n\tcase MLXSW_REG_PPCNT_RFC_2863_CNT:\n\t\t*p_hw_stats = mlxsw_sp_port_hw_rfc_2863_stats;\n\t\t*p_len = MLXSW_SP_PORT_HW_RFC_2863_STATS_LEN;\n\t\tbreak;\n\tcase MLXSW_REG_PPCNT_RFC_2819_CNT:\n\t\t*p_hw_stats = mlxsw_sp_port_hw_rfc_2819_stats;\n\t\t*p_len = MLXSW_SP_PORT_HW_RFC_2819_STATS_LEN;\n\t\tbreak;\n\tcase MLXSW_REG_PPCNT_RFC_3635_CNT:\n\t\t*p_hw_stats = mlxsw_sp_port_hw_rfc_3635_stats;\n\t\t*p_len = MLXSW_SP_PORT_HW_RFC_3635_STATS_LEN;\n\t\tbreak;\n\tcase MLXSW_REG_PPCNT_EXT_CNT:\n\t\t*p_hw_stats = mlxsw_sp_port_hw_ext_stats;\n\t\t*p_len = MLXSW_SP_PORT_HW_EXT_STATS_LEN;\n\t\tbreak;\n\tcase MLXSW_REG_PPCNT_DISCARD_CNT:\n\t\t*p_hw_stats = mlxsw_sp_port_hw_discard_stats;\n\t\t*p_len = MLXSW_SP_PORT_HW_DISCARD_STATS_LEN;\n\t\tbreak;\n\tcase MLXSW_REG_PPCNT_PRIO_CNT:\n\t\t*p_hw_stats = mlxsw_sp_port_hw_prio_stats;\n\t\t*p_len = MLXSW_SP_PORT_HW_PRIO_STATS_LEN;\n\t\tbreak;\n\tcase MLXSW_REG_PPCNT_TC_CNT:\n\t\t*p_hw_stats = mlxsw_sp_port_hw_tc_stats;\n\t\t*p_len = MLXSW_SP_PORT_HW_TC_STATS_LEN;\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON(1);\n\t\treturn -EOPNOTSUPP;\n\t}\n\treturn 0;\n}\n\nstatic void __mlxsw_sp_port_get_stats(struct net_device *dev,\n\t\t\t\t      enum mlxsw_reg_ppcnt_grp grp, int prio,\n\t\t\t\t      u64 *data, int data_index)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\tstruct mlxsw_sp_port_hw_stats *hw_stats;\n\tchar ppcnt_pl[MLXSW_REG_PPCNT_LEN];\n\tint i, len;\n\tint err;\n\n\terr = mlxsw_sp_get_hw_stats_by_group(&hw_stats, &len, grp);\n\tif (err)\n\t\treturn;\n\tmlxsw_sp_port_get_stats_raw(dev, grp, prio, ppcnt_pl);\n\tfor (i = 0; i < len; i++) {\n\t\tdata[data_index + i] = hw_stats[i].getter(ppcnt_pl);\n\t\tif (!hw_stats[i].cells_bytes)\n\t\t\tcontinue;\n\t\tdata[data_index + i] = mlxsw_sp_cells_bytes(mlxsw_sp,\n\t\t\t\t\t\t\t    data[data_index + i]);\n\t}\n}\n\nstatic void __mlxsw_sp_port_get_env_stats(struct net_device *dev, u64 *data, int data_index,\n\t\t\t\t\t  struct mlxsw_sp_port_stats *port_stats,\n\t\t\t\t\t  int len)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tint i;\n\n\tfor (i = 0; i < len; i++)\n\t\tdata[data_index + i] = port_stats[i].getter(mlxsw_sp_port);\n}\n\nstatic void mlxsw_sp_port_get_stats(struct net_device *dev,\n\t\t\t\t    struct ethtool_stats *stats, u64 *data)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tint i, data_index = 0;\n\n\t \n\t__mlxsw_sp_port_get_stats(dev, MLXSW_REG_PPCNT_IEEE_8023_CNT, 0,\n\t\t\t\t  data, data_index);\n\tdata_index = MLXSW_SP_PORT_HW_STATS_LEN;\n\n\t \n\t__mlxsw_sp_port_get_stats(dev, MLXSW_REG_PPCNT_RFC_2863_CNT, 0,\n\t\t\t\t  data, data_index);\n\tdata_index += MLXSW_SP_PORT_HW_RFC_2863_STATS_LEN;\n\n\t \n\t__mlxsw_sp_port_get_stats(dev, MLXSW_REG_PPCNT_RFC_2819_CNT, 0,\n\t\t\t\t  data, data_index);\n\tdata_index += MLXSW_SP_PORT_HW_RFC_2819_STATS_LEN;\n\n\t \n\t__mlxsw_sp_port_get_stats(dev, MLXSW_REG_PPCNT_RFC_3635_CNT, 0,\n\t\t\t\t  data, data_index);\n\tdata_index += MLXSW_SP_PORT_HW_RFC_3635_STATS_LEN;\n\n\t \n\t__mlxsw_sp_port_get_stats(dev, MLXSW_REG_PPCNT_EXT_CNT, 0,\n\t\t\t\t  data, data_index);\n\tdata_index += MLXSW_SP_PORT_HW_EXT_STATS_LEN;\n\n\t \n\t__mlxsw_sp_port_get_stats(dev, MLXSW_REG_PPCNT_DISCARD_CNT, 0,\n\t\t\t\t  data, data_index);\n\tdata_index += MLXSW_SP_PORT_HW_DISCARD_STATS_LEN;\n\n\t \n\tfor (i = 0; i < IEEE_8021QAZ_MAX_TCS; i++) {\n\t\t__mlxsw_sp_port_get_stats(dev, MLXSW_REG_PPCNT_PRIO_CNT, i,\n\t\t\t\t\t  data, data_index);\n\t\tdata_index += MLXSW_SP_PORT_HW_PRIO_STATS_LEN;\n\t}\n\n\t \n\tfor (i = 0; i < TC_MAX_QUEUE; i++) {\n\t\t__mlxsw_sp_port_get_stats(dev, MLXSW_REG_PPCNT_TC_CNT, i,\n\t\t\t\t\t  data, data_index);\n\t\tdata_index += MLXSW_SP_PORT_HW_TC_STATS_LEN;\n\t}\n\n\t \n\tmlxsw_sp_port->mlxsw_sp->ptp_ops->get_stats(mlxsw_sp_port,\n\t\t\t\t\t\t    data, data_index);\n\tdata_index += mlxsw_sp_port->mlxsw_sp->ptp_ops->get_stats_count();\n\n\t \n\t__mlxsw_sp_port_get_env_stats(dev, data, data_index, mlxsw_sp_port_transceiver_stats,\n\t\t\t\t      MLXSW_SP_PORT_HW_TRANSCEIVER_STATS_LEN);\n\tdata_index += MLXSW_SP_PORT_HW_TRANSCEIVER_STATS_LEN;\n}\n\nstatic int mlxsw_sp_port_get_sset_count(struct net_device *dev, int sset)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\n\tswitch (sset) {\n\tcase ETH_SS_STATS:\n\t\treturn MLXSW_SP_PORT_ETHTOOL_STATS_LEN +\n\t\t\tmlxsw_sp_port->mlxsw_sp->ptp_ops->get_stats_count();\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic void\nmlxsw_sp_port_get_link_supported(struct mlxsw_sp *mlxsw_sp, u32 eth_proto_cap,\n\t\t\t\t struct ethtool_link_ksettings *cmd)\n{\n\tconst struct mlxsw_sp_port_type_speed_ops *ops;\n\n\tops = mlxsw_sp->port_type_speed_ops;\n\n\tethtool_link_ksettings_add_link_mode(cmd, supported, Asym_Pause);\n\tethtool_link_ksettings_add_link_mode(cmd, supported, Autoneg);\n\tethtool_link_ksettings_add_link_mode(cmd, supported, Pause);\n\n\tops->from_ptys_supported_port(mlxsw_sp, eth_proto_cap, cmd);\n\tops->from_ptys_link(mlxsw_sp, eth_proto_cap,\n\t\t\t    cmd->link_modes.supported);\n}\n\nstatic void\nmlxsw_sp_port_get_link_advertise(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t u32 eth_proto_admin, bool autoneg,\n\t\t\t\t struct ethtool_link_ksettings *cmd)\n{\n\tconst struct mlxsw_sp_port_type_speed_ops *ops;\n\n\tops = mlxsw_sp->port_type_speed_ops;\n\n\tif (!autoneg)\n\t\treturn;\n\n\tethtool_link_ksettings_add_link_mode(cmd, advertising, Autoneg);\n\tops->from_ptys_link(mlxsw_sp, eth_proto_admin,\n\t\t\t    cmd->link_modes.advertising);\n}\n\nstatic u8\nmlxsw_sp_port_connector_port(enum mlxsw_reg_ptys_connector_type connector_type)\n{\n\tswitch (connector_type) {\n\tcase MLXSW_REG_PTYS_CONNECTOR_TYPE_UNKNOWN_OR_NO_CONNECTOR:\n\t\treturn PORT_OTHER;\n\tcase MLXSW_REG_PTYS_CONNECTOR_TYPE_PORT_NONE:\n\t\treturn PORT_NONE;\n\tcase MLXSW_REG_PTYS_CONNECTOR_TYPE_PORT_TP:\n\t\treturn PORT_TP;\n\tcase MLXSW_REG_PTYS_CONNECTOR_TYPE_PORT_AUI:\n\t\treturn PORT_AUI;\n\tcase MLXSW_REG_PTYS_CONNECTOR_TYPE_PORT_BNC:\n\t\treturn PORT_BNC;\n\tcase MLXSW_REG_PTYS_CONNECTOR_TYPE_PORT_MII:\n\t\treturn PORT_MII;\n\tcase MLXSW_REG_PTYS_CONNECTOR_TYPE_PORT_FIBRE:\n\t\treturn PORT_FIBRE;\n\tcase MLXSW_REG_PTYS_CONNECTOR_TYPE_PORT_DA:\n\t\treturn PORT_DA;\n\tcase MLXSW_REG_PTYS_CONNECTOR_TYPE_PORT_OTHER:\n\t\treturn PORT_OTHER;\n\tdefault:\n\t\tWARN_ON_ONCE(1);\n\t\treturn PORT_OTHER;\n\t}\n}\n\nstatic int mlxsw_sp_port_ptys_query(struct mlxsw_sp_port *mlxsw_sp_port,\n\t\t\t\t    u32 *p_eth_proto_cap, u32 *p_eth_proto_admin,\n\t\t\t\t    u32 *p_eth_proto_oper, u8 *p_connector_type)\n{\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\tconst struct mlxsw_sp_port_type_speed_ops *ops;\n\tchar ptys_pl[MLXSW_REG_PTYS_LEN];\n\tint err;\n\n\tops = mlxsw_sp->port_type_speed_ops;\n\n\tops->reg_ptys_eth_pack(mlxsw_sp, ptys_pl, mlxsw_sp_port->local_port, 0, false);\n\terr = mlxsw_reg_query(mlxsw_sp->core, MLXSW_REG(ptys), ptys_pl);\n\tif (err)\n\t\treturn err;\n\n\tops->reg_ptys_eth_unpack(mlxsw_sp, ptys_pl, p_eth_proto_cap, p_eth_proto_admin,\n\t\t\t\t p_eth_proto_oper);\n\tif (p_connector_type)\n\t\t*p_connector_type = mlxsw_reg_ptys_connector_type_get(ptys_pl);\n\treturn 0;\n}\n\nstatic int mlxsw_sp_port_get_link_ksettings(struct net_device *dev,\n\t\t\t\t\t    struct ethtool_link_ksettings *cmd)\n{\n\tu32 eth_proto_cap, eth_proto_admin, eth_proto_oper;\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\tconst struct mlxsw_sp_port_type_speed_ops *ops;\n\tu8 connector_type;\n\tbool autoneg;\n\tint err;\n\n\terr = mlxsw_sp_port_ptys_query(mlxsw_sp_port, &eth_proto_cap, &eth_proto_admin,\n\t\t\t\t       &eth_proto_oper, &connector_type);\n\tif (err)\n\t\treturn err;\n\n\tops = mlxsw_sp->port_type_speed_ops;\n\tautoneg = mlxsw_sp_port->link.autoneg;\n\n\tmlxsw_sp_port_get_link_supported(mlxsw_sp, eth_proto_cap, cmd);\n\n\tmlxsw_sp_port_get_link_advertise(mlxsw_sp, eth_proto_admin, autoneg, cmd);\n\n\tcmd->base.autoneg = autoneg ? AUTONEG_ENABLE : AUTONEG_DISABLE;\n\tcmd->base.port = mlxsw_sp_port_connector_port(connector_type);\n\tops->from_ptys_link_mode(mlxsw_sp, netif_carrier_ok(dev),\n\t\t\t\t eth_proto_oper, cmd);\n\n\treturn 0;\n}\n\nstatic int\nmlxsw_sp_port_set_link_ksettings(struct net_device *dev,\n\t\t\t\t const struct ethtool_link_ksettings *cmd)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\tconst struct mlxsw_sp_port_type_speed_ops *ops;\n\tchar ptys_pl[MLXSW_REG_PTYS_LEN];\n\tu32 eth_proto_cap, eth_proto_new;\n\tbool autoneg;\n\tint err;\n\n\tops = mlxsw_sp->port_type_speed_ops;\n\n\tops->reg_ptys_eth_pack(mlxsw_sp, ptys_pl, mlxsw_sp_port->local_port,\n\t\t\t       0, false);\n\terr = mlxsw_reg_query(mlxsw_sp->core, MLXSW_REG(ptys), ptys_pl);\n\tif (err)\n\t\treturn err;\n\tops->reg_ptys_eth_unpack(mlxsw_sp, ptys_pl, &eth_proto_cap, NULL, NULL);\n\n\tautoneg = cmd->base.autoneg == AUTONEG_ENABLE;\n\teth_proto_new = autoneg ?\n\t\tops->to_ptys_advert_link(mlxsw_sp, cmd) :\n\t\tops->to_ptys_speed_lanes(mlxsw_sp, mlxsw_sp_port->mapping.width,\n\t\t\t\t\t cmd);\n\n\teth_proto_new = eth_proto_new & eth_proto_cap;\n\tif (!eth_proto_new) {\n\t\tnetdev_err(dev, \"No supported speed or lanes requested\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tops->reg_ptys_eth_pack(mlxsw_sp, ptys_pl, mlxsw_sp_port->local_port,\n\t\t\t       eth_proto_new, autoneg);\n\terr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(ptys), ptys_pl);\n\tif (err)\n\t\treturn err;\n\n\tmlxsw_sp_port->link.autoneg = autoneg;\n\n\tif (!netif_running(dev))\n\t\treturn 0;\n\n\tmlxsw_sp_port_admin_status_set(mlxsw_sp_port, false);\n\tmlxsw_sp_port_admin_status_set(mlxsw_sp_port, true);\n\n\treturn 0;\n}\n\nstatic int mlxsw_sp_get_module_info(struct net_device *netdev,\n\t\t\t\t    struct ethtool_modinfo *modinfo)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(netdev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\n\treturn mlxsw_env_get_module_info(netdev, mlxsw_sp->core,\n\t\t\t\t\t mlxsw_sp_port->mapping.slot_index,\n\t\t\t\t\t mlxsw_sp_port->mapping.module,\n\t\t\t\t\t modinfo);\n}\n\nstatic int mlxsw_sp_get_module_eeprom(struct net_device *netdev,\n\t\t\t\t      struct ethtool_eeprom *ee, u8 *data)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(netdev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\tu8 slot_index = mlxsw_sp_port->mapping.slot_index;\n\tu8 module = mlxsw_sp_port->mapping.module;\n\n\treturn mlxsw_env_get_module_eeprom(netdev, mlxsw_sp->core, slot_index,\n\t\t\t\t\t   module, ee, data);\n}\n\nstatic int\nmlxsw_sp_get_module_eeprom_by_page(struct net_device *dev,\n\t\t\t\t   const struct ethtool_module_eeprom *page,\n\t\t\t\t   struct netlink_ext_ack *extack)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\tu8 slot_index = mlxsw_sp_port->mapping.slot_index;\n\tu8 module = mlxsw_sp_port->mapping.module;\n\n\treturn mlxsw_env_get_module_eeprom_by_page(mlxsw_sp->core, slot_index,\n\t\t\t\t\t\t   module, page, extack);\n}\n\nstatic int\nmlxsw_sp_get_ts_info(struct net_device *netdev, struct ethtool_ts_info *info)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(netdev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\n\treturn mlxsw_sp->ptp_ops->get_ts_info(mlxsw_sp, info);\n}\n\nstatic void\nmlxsw_sp_get_eth_phy_stats(struct net_device *dev,\n\t\t\t   struct ethtool_eth_phy_stats *phy_stats)\n{\n\tchar ppcnt_pl[MLXSW_REG_PPCNT_LEN];\n\n\tif (mlxsw_sp_port_get_stats_raw(dev, MLXSW_REG_PPCNT_IEEE_8023_CNT,\n\t\t\t\t\t0, ppcnt_pl))\n\t\treturn;\n\n\tphy_stats->SymbolErrorDuringCarrier =\n\t\tmlxsw_reg_ppcnt_a_symbol_error_during_carrier_get(ppcnt_pl);\n}\n\nstatic void\nmlxsw_sp_get_eth_mac_stats(struct net_device *dev,\n\t\t\t   struct ethtool_eth_mac_stats *mac_stats)\n{\n\tchar ppcnt_pl[MLXSW_REG_PPCNT_LEN];\n\n\tif (mlxsw_sp_port_get_stats_raw(dev, MLXSW_REG_PPCNT_IEEE_8023_CNT,\n\t\t\t\t\t0, ppcnt_pl))\n\t\treturn;\n\n\tmac_stats->FramesTransmittedOK =\n\t\tmlxsw_reg_ppcnt_a_frames_transmitted_ok_get(ppcnt_pl);\n\tmac_stats->FramesReceivedOK =\n\t\tmlxsw_reg_ppcnt_a_frames_received_ok_get(ppcnt_pl);\n\tmac_stats->FrameCheckSequenceErrors =\n\t\tmlxsw_reg_ppcnt_a_frame_check_sequence_errors_get(ppcnt_pl);\n\tmac_stats->AlignmentErrors =\n\t\tmlxsw_reg_ppcnt_a_alignment_errors_get(ppcnt_pl);\n\tmac_stats->OctetsTransmittedOK =\n\t\tmlxsw_reg_ppcnt_a_octets_transmitted_ok_get(ppcnt_pl);\n\tmac_stats->OctetsReceivedOK =\n\t\tmlxsw_reg_ppcnt_a_octets_received_ok_get(ppcnt_pl);\n\tmac_stats->MulticastFramesXmittedOK =\n\t\tmlxsw_reg_ppcnt_a_multicast_frames_xmitted_ok_get(ppcnt_pl);\n\tmac_stats->BroadcastFramesXmittedOK =\n\t\tmlxsw_reg_ppcnt_a_broadcast_frames_xmitted_ok_get(ppcnt_pl);\n\tmac_stats->MulticastFramesReceivedOK =\n\t\tmlxsw_reg_ppcnt_a_multicast_frames_received_ok_get(ppcnt_pl);\n\tmac_stats->BroadcastFramesReceivedOK =\n\t\tmlxsw_reg_ppcnt_a_broadcast_frames_received_ok_get(ppcnt_pl);\n\tmac_stats->InRangeLengthErrors =\n\t\tmlxsw_reg_ppcnt_a_in_range_length_errors_get(ppcnt_pl);\n\tmac_stats->OutOfRangeLengthField =\n\t\tmlxsw_reg_ppcnt_a_out_of_range_length_field_get(ppcnt_pl);\n\tmac_stats->FrameTooLongErrors =\n\t\tmlxsw_reg_ppcnt_a_frame_too_long_errors_get(ppcnt_pl);\n}\n\nstatic void\nmlxsw_sp_get_eth_ctrl_stats(struct net_device *dev,\n\t\t\t    struct ethtool_eth_ctrl_stats *ctrl_stats)\n{\n\tchar ppcnt_pl[MLXSW_REG_PPCNT_LEN];\n\n\tif (mlxsw_sp_port_get_stats_raw(dev, MLXSW_REG_PPCNT_IEEE_8023_CNT,\n\t\t\t\t\t0, ppcnt_pl))\n\t\treturn;\n\n\tctrl_stats->MACControlFramesTransmitted =\n\t\tmlxsw_reg_ppcnt_a_mac_control_frames_transmitted_get(ppcnt_pl);\n\tctrl_stats->MACControlFramesReceived =\n\t\tmlxsw_reg_ppcnt_a_mac_control_frames_received_get(ppcnt_pl);\n\tctrl_stats->UnsupportedOpcodesReceived =\n\t\tmlxsw_reg_ppcnt_a_unsupported_opcodes_received_get(ppcnt_pl);\n}\n\nstatic const struct ethtool_rmon_hist_range mlxsw_rmon_ranges[] = {\n\t{    0,    64 },\n\t{   65,   127 },\n\t{  128,   255 },\n\t{  256,   511 },\n\t{  512,  1023 },\n\t{ 1024,  1518 },\n\t{ 1519,  2047 },\n\t{ 2048,  4095 },\n\t{ 4096,  8191 },\n\t{ 8192, 10239 },\n\t{}\n};\n\nstatic void\nmlxsw_sp_get_rmon_stats(struct net_device *dev,\n\t\t\tstruct ethtool_rmon_stats *rmon,\n\t\t\tconst struct ethtool_rmon_hist_range **ranges)\n{\n\tchar ppcnt_pl[MLXSW_REG_PPCNT_LEN];\n\n\tif (mlxsw_sp_port_get_stats_raw(dev, MLXSW_REG_PPCNT_RFC_2819_CNT,\n\t\t\t\t\t0, ppcnt_pl))\n\t\treturn;\n\n\trmon->undersize_pkts =\n\t\tmlxsw_reg_ppcnt_ether_stats_undersize_pkts_get(ppcnt_pl);\n\trmon->oversize_pkts =\n\t\tmlxsw_reg_ppcnt_ether_stats_oversize_pkts_get(ppcnt_pl);\n\trmon->fragments =\n\t\tmlxsw_reg_ppcnt_ether_stats_fragments_get(ppcnt_pl);\n\n\trmon->hist[0] = mlxsw_reg_ppcnt_ether_stats_pkts64octets_get(ppcnt_pl);\n\trmon->hist[1] =\n\t\tmlxsw_reg_ppcnt_ether_stats_pkts65to127octets_get(ppcnt_pl);\n\trmon->hist[2] =\n\t\tmlxsw_reg_ppcnt_ether_stats_pkts128to255octets_get(ppcnt_pl);\n\trmon->hist[3] =\n\t\tmlxsw_reg_ppcnt_ether_stats_pkts256to511octets_get(ppcnt_pl);\n\trmon->hist[4] =\n\t\tmlxsw_reg_ppcnt_ether_stats_pkts512to1023octets_get(ppcnt_pl);\n\trmon->hist[5] =\n\t\tmlxsw_reg_ppcnt_ether_stats_pkts1024to1518octets_get(ppcnt_pl);\n\trmon->hist[6] =\n\t\tmlxsw_reg_ppcnt_ether_stats_pkts1519to2047octets_get(ppcnt_pl);\n\trmon->hist[7] =\n\t\tmlxsw_reg_ppcnt_ether_stats_pkts2048to4095octets_get(ppcnt_pl);\n\trmon->hist[8] =\n\t\tmlxsw_reg_ppcnt_ether_stats_pkts4096to8191octets_get(ppcnt_pl);\n\trmon->hist[9] =\n\t\tmlxsw_reg_ppcnt_ether_stats_pkts8192to10239octets_get(ppcnt_pl);\n\n\t*ranges = mlxsw_rmon_ranges;\n}\n\nstatic int mlxsw_sp_reset(struct net_device *dev, u32 *flags)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\tu8 slot_index = mlxsw_sp_port->mapping.slot_index;\n\tu8 module = mlxsw_sp_port->mapping.module;\n\n\treturn mlxsw_env_reset_module(dev, mlxsw_sp->core, slot_index,\n\t\t\t\t      module, flags);\n}\n\nstatic int\nmlxsw_sp_get_module_power_mode(struct net_device *dev,\n\t\t\t       struct ethtool_module_power_mode_params *params,\n\t\t\t       struct netlink_ext_ack *extack)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\tu8 slot_index = mlxsw_sp_port->mapping.slot_index;\n\tu8 module = mlxsw_sp_port->mapping.module;\n\n\treturn mlxsw_env_get_module_power_mode(mlxsw_sp->core, slot_index,\n\t\t\t\t\t       module, params, extack);\n}\n\nstatic int\nmlxsw_sp_set_module_power_mode(struct net_device *dev,\n\t\t\t       const struct ethtool_module_power_mode_params *params,\n\t\t\t       struct netlink_ext_ack *extack)\n{\n\tstruct mlxsw_sp_port *mlxsw_sp_port = netdev_priv(dev);\n\tstruct mlxsw_sp *mlxsw_sp = mlxsw_sp_port->mlxsw_sp;\n\tu8 slot_index = mlxsw_sp_port->mapping.slot_index;\n\tu8 module = mlxsw_sp_port->mapping.module;\n\n\treturn mlxsw_env_set_module_power_mode(mlxsw_sp->core, slot_index,\n\t\t\t\t\t       module, params->policy, extack);\n}\n\nconst struct ethtool_ops mlxsw_sp_port_ethtool_ops = {\n\t.cap_link_lanes_supported\t= true,\n\t.get_drvinfo\t\t\t= mlxsw_sp_port_get_drvinfo,\n\t.get_link\t\t\t= ethtool_op_get_link,\n\t.get_link_ext_state\t\t= mlxsw_sp_port_get_link_ext_state,\n\t.get_pauseparam\t\t\t= mlxsw_sp_port_get_pauseparam,\n\t.set_pauseparam\t\t\t= mlxsw_sp_port_set_pauseparam,\n\t.get_strings\t\t\t= mlxsw_sp_port_get_strings,\n\t.set_phys_id\t\t\t= mlxsw_sp_port_set_phys_id,\n\t.get_ethtool_stats\t\t= mlxsw_sp_port_get_stats,\n\t.get_sset_count\t\t\t= mlxsw_sp_port_get_sset_count,\n\t.get_link_ksettings\t\t= mlxsw_sp_port_get_link_ksettings,\n\t.set_link_ksettings\t\t= mlxsw_sp_port_set_link_ksettings,\n\t.get_module_info\t\t= mlxsw_sp_get_module_info,\n\t.get_module_eeprom\t\t= mlxsw_sp_get_module_eeprom,\n\t.get_module_eeprom_by_page\t= mlxsw_sp_get_module_eeprom_by_page,\n\t.get_ts_info\t\t\t= mlxsw_sp_get_ts_info,\n\t.get_eth_phy_stats\t\t= mlxsw_sp_get_eth_phy_stats,\n\t.get_eth_mac_stats\t\t= mlxsw_sp_get_eth_mac_stats,\n\t.get_eth_ctrl_stats\t\t= mlxsw_sp_get_eth_ctrl_stats,\n\t.get_rmon_stats\t\t\t= mlxsw_sp_get_rmon_stats,\n\t.reset\t\t\t\t= mlxsw_sp_reset,\n\t.get_module_power_mode\t\t= mlxsw_sp_get_module_power_mode,\n\t.set_module_power_mode\t\t= mlxsw_sp_set_module_power_mode,\n};\n\nstruct mlxsw_sp1_port_link_mode {\n\tenum ethtool_link_mode_bit_indices mask_ethtool;\n\tu32 mask;\n\tu32 speed;\n};\n\nstatic const struct mlxsw_sp1_port_link_mode mlxsw_sp1_port_link_mode[] = {\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_100BASE_T,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_100baseT_Full_BIT,\n\t\t.speed\t\t= SPEED_100,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_SGMII |\n\t\t\t\t  MLXSW_REG_PTYS_ETH_SPEED_1000BASE_KX,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_1000baseKX_Full_BIT,\n\t\t.speed\t\t= SPEED_1000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_1000BASE_T,\n\t\t.mask_ethtool   = ETHTOOL_LINK_MODE_1000baseT_Full_BIT,\n\t\t.speed          = SPEED_1000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_10GBASE_CX4 |\n\t\t\t\t  MLXSW_REG_PTYS_ETH_SPEED_10GBASE_KX4,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_10000baseKX4_Full_BIT,\n\t\t.speed\t\t= SPEED_10000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_10GBASE_KR |\n\t\t\t\t  MLXSW_REG_PTYS_ETH_SPEED_10GBASE_CR |\n\t\t\t\t  MLXSW_REG_PTYS_ETH_SPEED_10GBASE_SR |\n\t\t\t\t  MLXSW_REG_PTYS_ETH_SPEED_10GBASE_ER_LR,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_10000baseKR_Full_BIT,\n\t\t.speed\t\t= SPEED_10000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_40GBASE_CR4,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_40000baseCR4_Full_BIT,\n\t\t.speed\t\t= SPEED_40000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_40GBASE_KR4,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_40000baseKR4_Full_BIT,\n\t\t.speed\t\t= SPEED_40000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_40GBASE_SR4,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_40000baseSR4_Full_BIT,\n\t\t.speed\t\t= SPEED_40000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_40GBASE_LR4_ER4,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_40000baseLR4_Full_BIT,\n\t\t.speed\t\t= SPEED_40000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_25GBASE_CR,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_25000baseCR_Full_BIT,\n\t\t.speed\t\t= SPEED_25000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_25GBASE_KR,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_25000baseKR_Full_BIT,\n\t\t.speed\t\t= SPEED_25000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_25GBASE_SR,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_25000baseSR_Full_BIT,\n\t\t.speed\t\t= SPEED_25000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_50GBASE_CR2,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_50000baseCR2_Full_BIT,\n\t\t.speed\t\t= SPEED_50000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_50GBASE_KR2,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_50000baseKR2_Full_BIT,\n\t\t.speed\t\t= SPEED_50000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_50GBASE_SR2,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_50000baseSR2_Full_BIT,\n\t\t.speed\t\t= SPEED_50000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_100GBASE_CR4,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_100000baseCR4_Full_BIT,\n\t\t.speed\t\t= SPEED_100000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_100GBASE_SR4,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_100000baseSR4_Full_BIT,\n\t\t.speed\t\t= SPEED_100000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_100GBASE_KR4,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_100000baseKR4_Full_BIT,\n\t\t.speed\t\t= SPEED_100000,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_ETH_SPEED_100GBASE_LR4_ER4,\n\t\t.mask_ethtool\t= ETHTOOL_LINK_MODE_100000baseLR4_ER4_Full_BIT,\n\t\t.speed\t\t= SPEED_100000,\n\t},\n};\n\n#define MLXSW_SP1_PORT_LINK_MODE_LEN ARRAY_SIZE(mlxsw_sp1_port_link_mode)\n\nstatic void\nmlxsw_sp1_from_ptys_supported_port(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t   u32 ptys_eth_proto,\n\t\t\t\t   struct ethtool_link_ksettings *cmd)\n{\n\tif (ptys_eth_proto & (MLXSW_REG_PTYS_ETH_SPEED_10GBASE_CR |\n\t\t\t      MLXSW_REG_PTYS_ETH_SPEED_10GBASE_SR |\n\t\t\t      MLXSW_REG_PTYS_ETH_SPEED_40GBASE_CR4 |\n\t\t\t      MLXSW_REG_PTYS_ETH_SPEED_40GBASE_SR4 |\n\t\t\t      MLXSW_REG_PTYS_ETH_SPEED_100GBASE_SR4 |\n\t\t\t      MLXSW_REG_PTYS_ETH_SPEED_SGMII))\n\t\tethtool_link_ksettings_add_link_mode(cmd, supported, FIBRE);\n\n\tif (ptys_eth_proto & (MLXSW_REG_PTYS_ETH_SPEED_10GBASE_KR |\n\t\t\t      MLXSW_REG_PTYS_ETH_SPEED_10GBASE_KX4 |\n\t\t\t      MLXSW_REG_PTYS_ETH_SPEED_40GBASE_KR4 |\n\t\t\t      MLXSW_REG_PTYS_ETH_SPEED_100GBASE_KR4 |\n\t\t\t      MLXSW_REG_PTYS_ETH_SPEED_1000BASE_KX))\n\t\tethtool_link_ksettings_add_link_mode(cmd, supported, Backplane);\n}\n\nstatic void\nmlxsw_sp1_from_ptys_link(struct mlxsw_sp *mlxsw_sp, u32 ptys_eth_proto,\n\t\t\t unsigned long *mode)\n{\n\tint i;\n\n\tfor (i = 0; i < MLXSW_SP1_PORT_LINK_MODE_LEN; i++) {\n\t\tif (ptys_eth_proto & mlxsw_sp1_port_link_mode[i].mask)\n\t\t\t__set_bit(mlxsw_sp1_port_link_mode[i].mask_ethtool,\n\t\t\t\t  mode);\n\t}\n}\n\nstatic u32\nmlxsw_sp1_from_ptys_speed(struct mlxsw_sp *mlxsw_sp, u32 ptys_eth_proto)\n{\n\tint i;\n\n\tfor (i = 0; i < MLXSW_SP1_PORT_LINK_MODE_LEN; i++) {\n\t\tif (ptys_eth_proto & mlxsw_sp1_port_link_mode[i].mask)\n\t\t\treturn mlxsw_sp1_port_link_mode[i].speed;\n\t}\n\n\treturn SPEED_UNKNOWN;\n}\n\nstatic void\nmlxsw_sp1_from_ptys_link_mode(struct mlxsw_sp *mlxsw_sp, bool carrier_ok,\n\t\t\t      u32 ptys_eth_proto,\n\t\t\t      struct ethtool_link_ksettings *cmd)\n{\n\tstruct mlxsw_sp1_port_link_mode link;\n\tint i;\n\n\tcmd->base.speed = SPEED_UNKNOWN;\n\tcmd->base.duplex = DUPLEX_UNKNOWN;\n\tcmd->lanes = 0;\n\n\tif (!carrier_ok)\n\t\treturn;\n\n\tfor (i = 0; i < MLXSW_SP1_PORT_LINK_MODE_LEN; i++) {\n\t\tif (ptys_eth_proto & mlxsw_sp1_port_link_mode[i].mask) {\n\t\t\tlink = mlxsw_sp1_port_link_mode[i];\n\t\t\tethtool_params_from_link_mode(cmd,\n\t\t\t\t\t\t      link.mask_ethtool);\n\t\t}\n\t}\n}\n\nstatic int mlxsw_sp1_ptys_max_speed(struct mlxsw_sp_port *mlxsw_sp_port, u32 *p_max_speed)\n{\n\tu32 eth_proto_cap;\n\tu32 max_speed = 0;\n\tint err;\n\tint i;\n\n\terr = mlxsw_sp_port_ptys_query(mlxsw_sp_port, &eth_proto_cap, NULL, NULL, NULL);\n\tif (err)\n\t\treturn err;\n\n\tfor (i = 0; i < MLXSW_SP1_PORT_LINK_MODE_LEN; i++) {\n\t\tif ((eth_proto_cap & mlxsw_sp1_port_link_mode[i].mask) &&\n\t\t    mlxsw_sp1_port_link_mode[i].speed > max_speed)\n\t\t\tmax_speed = mlxsw_sp1_port_link_mode[i].speed;\n\t}\n\n\t*p_max_speed = max_speed;\n\treturn 0;\n}\n\nstatic u32\nmlxsw_sp1_to_ptys_advert_link(struct mlxsw_sp *mlxsw_sp,\n\t\t\t      const struct ethtool_link_ksettings *cmd)\n{\n\tu32 ptys_proto = 0;\n\tint i;\n\n\tfor (i = 0; i < MLXSW_SP1_PORT_LINK_MODE_LEN; i++) {\n\t\tif (test_bit(mlxsw_sp1_port_link_mode[i].mask_ethtool,\n\t\t\t     cmd->link_modes.advertising))\n\t\t\tptys_proto |= mlxsw_sp1_port_link_mode[i].mask;\n\t}\n\treturn ptys_proto;\n}\n\nstatic u32 mlxsw_sp1_to_ptys_speed_lanes(struct mlxsw_sp *mlxsw_sp, u8 width,\n\t\t\t\t\t const struct ethtool_link_ksettings *cmd)\n{\n\tu32 ptys_proto = 0;\n\tint i;\n\n\tif (cmd->lanes > width)\n\t\treturn ptys_proto;\n\n\tfor (i = 0; i < MLXSW_SP1_PORT_LINK_MODE_LEN; i++) {\n\t\tif (cmd->base.speed == mlxsw_sp1_port_link_mode[i].speed)\n\t\t\tptys_proto |= mlxsw_sp1_port_link_mode[i].mask;\n\t}\n\treturn ptys_proto;\n}\n\nstatic void\nmlxsw_sp1_reg_ptys_eth_pack(struct mlxsw_sp *mlxsw_sp, char *payload,\n\t\t\t    u16 local_port, u32 proto_admin, bool autoneg)\n{\n\tmlxsw_reg_ptys_eth_pack(payload, local_port, proto_admin, autoneg);\n}\n\nstatic void\nmlxsw_sp1_reg_ptys_eth_unpack(struct mlxsw_sp *mlxsw_sp, char *payload,\n\t\t\t      u32 *p_eth_proto_cap, u32 *p_eth_proto_admin,\n\t\t\t      u32 *p_eth_proto_oper)\n{\n\tmlxsw_reg_ptys_eth_unpack(payload, p_eth_proto_cap, p_eth_proto_admin,\n\t\t\t\t  p_eth_proto_oper);\n}\n\nstatic u32 mlxsw_sp1_ptys_proto_cap_masked_get(u32 eth_proto_cap)\n{\n\tu32 ptys_proto_cap_masked = 0;\n\tint i;\n\n\tfor (i = 0; i < MLXSW_SP1_PORT_LINK_MODE_LEN; i++) {\n\t\tif (mlxsw_sp1_port_link_mode[i].mask & eth_proto_cap)\n\t\t\tptys_proto_cap_masked |=\n\t\t\t\tmlxsw_sp1_port_link_mode[i].mask;\n\t}\n\n\treturn ptys_proto_cap_masked;\n}\n\nconst struct mlxsw_sp_port_type_speed_ops mlxsw_sp1_port_type_speed_ops = {\n\t.from_ptys_supported_port\t= mlxsw_sp1_from_ptys_supported_port,\n\t.from_ptys_link\t\t\t= mlxsw_sp1_from_ptys_link,\n\t.from_ptys_speed\t\t= mlxsw_sp1_from_ptys_speed,\n\t.from_ptys_link_mode\t\t= mlxsw_sp1_from_ptys_link_mode,\n\t.ptys_max_speed\t\t\t= mlxsw_sp1_ptys_max_speed,\n\t.to_ptys_advert_link\t\t= mlxsw_sp1_to_ptys_advert_link,\n\t.to_ptys_speed_lanes\t\t= mlxsw_sp1_to_ptys_speed_lanes,\n\t.reg_ptys_eth_pack\t\t= mlxsw_sp1_reg_ptys_eth_pack,\n\t.reg_ptys_eth_unpack\t\t= mlxsw_sp1_reg_ptys_eth_unpack,\n\t.ptys_proto_cap_masked_get\t= mlxsw_sp1_ptys_proto_cap_masked_get,\n};\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_sgmii_100m[] = {\n\tETHTOOL_LINK_MODE_100baseT_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_SGMII_100M_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_sgmii_100m)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_1000base_x_sgmii[] = {\n\tETHTOOL_LINK_MODE_1000baseT_Full_BIT,\n\tETHTOOL_LINK_MODE_1000baseKX_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_1000BASE_X_SGMII_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_1000base_x_sgmii)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_5gbase_r[] = {\n\tETHTOOL_LINK_MODE_5000baseT_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_5GBASE_R_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_5gbase_r)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_xfi_xaui_1_10g[] = {\n\tETHTOOL_LINK_MODE_10000baseT_Full_BIT,\n\tETHTOOL_LINK_MODE_10000baseKR_Full_BIT,\n\tETHTOOL_LINK_MODE_10000baseR_FEC_BIT,\n\tETHTOOL_LINK_MODE_10000baseCR_Full_BIT,\n\tETHTOOL_LINK_MODE_10000baseSR_Full_BIT,\n\tETHTOOL_LINK_MODE_10000baseLR_Full_BIT,\n\tETHTOOL_LINK_MODE_10000baseER_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_XFI_XAUI_1_10G_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_xfi_xaui_1_10g)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_xlaui_4_xlppi_4_40g[] = {\n\tETHTOOL_LINK_MODE_40000baseKR4_Full_BIT,\n\tETHTOOL_LINK_MODE_40000baseCR4_Full_BIT,\n\tETHTOOL_LINK_MODE_40000baseSR4_Full_BIT,\n\tETHTOOL_LINK_MODE_40000baseLR4_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_XLAUI_4_XLPPI_4_40G_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_xlaui_4_xlppi_4_40g)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_25gaui_1_25gbase_cr_kr[] = {\n\tETHTOOL_LINK_MODE_25000baseCR_Full_BIT,\n\tETHTOOL_LINK_MODE_25000baseKR_Full_BIT,\n\tETHTOOL_LINK_MODE_25000baseSR_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_25GAUI_1_25GBASE_CR_KR_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_25gaui_1_25gbase_cr_kr)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_50gaui_2_laui_2_50gbase_cr2_kr2[] = {\n\tETHTOOL_LINK_MODE_50000baseCR2_Full_BIT,\n\tETHTOOL_LINK_MODE_50000baseKR2_Full_BIT,\n\tETHTOOL_LINK_MODE_50000baseSR2_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_50GAUI_2_LAUI_2_50GBASE_CR2_KR2_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_50gaui_2_laui_2_50gbase_cr2_kr2)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_50gaui_1_laui_1_50gbase_cr_kr[] = {\n\tETHTOOL_LINK_MODE_50000baseKR_Full_BIT,\n\tETHTOOL_LINK_MODE_50000baseSR_Full_BIT,\n\tETHTOOL_LINK_MODE_50000baseCR_Full_BIT,\n\tETHTOOL_LINK_MODE_50000baseLR_ER_FR_Full_BIT,\n\tETHTOOL_LINK_MODE_50000baseDR_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_50GAUI_1_LAUI_1_50GBASE_CR_KR_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_50gaui_1_laui_1_50gbase_cr_kr)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_caui_4_100gbase_cr4_kr4[] = {\n\tETHTOOL_LINK_MODE_100000baseKR4_Full_BIT,\n\tETHTOOL_LINK_MODE_100000baseSR4_Full_BIT,\n\tETHTOOL_LINK_MODE_100000baseCR4_Full_BIT,\n\tETHTOOL_LINK_MODE_100000baseLR4_ER4_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_CAUI_4_100GBASE_CR4_KR4_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_caui_4_100gbase_cr4_kr4)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_100gaui_2_100gbase_cr2_kr2[] = {\n\tETHTOOL_LINK_MODE_100000baseKR2_Full_BIT,\n\tETHTOOL_LINK_MODE_100000baseSR2_Full_BIT,\n\tETHTOOL_LINK_MODE_100000baseCR2_Full_BIT,\n\tETHTOOL_LINK_MODE_100000baseLR2_ER2_FR2_Full_BIT,\n\tETHTOOL_LINK_MODE_100000baseDR2_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_100GAUI_2_100GBASE_CR2_KR2_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_100gaui_2_100gbase_cr2_kr2)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_200gaui_4_200gbase_cr4_kr4[] = {\n\tETHTOOL_LINK_MODE_200000baseKR4_Full_BIT,\n\tETHTOOL_LINK_MODE_200000baseSR4_Full_BIT,\n\tETHTOOL_LINK_MODE_200000baseLR4_ER4_FR4_Full_BIT,\n\tETHTOOL_LINK_MODE_200000baseDR4_Full_BIT,\n\tETHTOOL_LINK_MODE_200000baseCR4_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_200GAUI_4_200GBASE_CR4_KR4_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_200gaui_4_200gbase_cr4_kr4)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_400gaui_8[] = {\n\tETHTOOL_LINK_MODE_400000baseKR8_Full_BIT,\n\tETHTOOL_LINK_MODE_400000baseSR8_Full_BIT,\n\tETHTOOL_LINK_MODE_400000baseLR8_ER8_FR8_Full_BIT,\n\tETHTOOL_LINK_MODE_400000baseDR8_Full_BIT,\n\tETHTOOL_LINK_MODE_400000baseCR8_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_400GAUI_8_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_400gaui_8)\n\nstatic const enum ethtool_link_mode_bit_indices\nmlxsw_sp2_mask_ethtool_800gaui_8[] = {\n\tETHTOOL_LINK_MODE_800000baseCR8_Full_BIT,\n\tETHTOOL_LINK_MODE_800000baseKR8_Full_BIT,\n\tETHTOOL_LINK_MODE_800000baseDR8_Full_BIT,\n\tETHTOOL_LINK_MODE_800000baseDR8_2_Full_BIT,\n\tETHTOOL_LINK_MODE_800000baseSR8_Full_BIT,\n\tETHTOOL_LINK_MODE_800000baseVR8_Full_BIT,\n};\n\n#define MLXSW_SP2_MASK_ETHTOOL_800GAUI_8_LEN \\\n\tARRAY_SIZE(mlxsw_sp2_mask_ethtool_800gaui_8)\n\n#define MLXSW_SP_PORT_MASK_WIDTH_1X\tBIT(0)\n#define MLXSW_SP_PORT_MASK_WIDTH_2X\tBIT(1)\n#define MLXSW_SP_PORT_MASK_WIDTH_4X\tBIT(2)\n#define MLXSW_SP_PORT_MASK_WIDTH_8X\tBIT(3)\n\nstatic u8 mlxsw_sp_port_mask_width_get(u8 width)\n{\n\tswitch (width) {\n\tcase 1:\n\t\treturn MLXSW_SP_PORT_MASK_WIDTH_1X;\n\tcase 2:\n\t\treturn MLXSW_SP_PORT_MASK_WIDTH_2X;\n\tcase 4:\n\t\treturn MLXSW_SP_PORT_MASK_WIDTH_4X;\n\tcase 8:\n\t\treturn MLXSW_SP_PORT_MASK_WIDTH_8X;\n\tdefault:\n\t\tWARN_ON_ONCE(1);\n\t\treturn 0;\n\t}\n}\n\nstruct mlxsw_sp2_port_link_mode {\n\tconst enum ethtool_link_mode_bit_indices *mask_ethtool;\n\tint m_ethtool_len;\n\tu32 mask;\n\tu32 speed;\n\tu32 width;\n\tu8 mask_sup_width;\n};\n\nstatic const struct mlxsw_sp2_port_link_mode mlxsw_sp2_port_link_mode[] = {\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_SGMII_100M,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_sgmii_100m,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_SGMII_100M_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_1X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_2X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_4X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_100,\n\t\t.width\t\t= 1,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_1000BASE_X_SGMII,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_1000base_x_sgmii,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_1000BASE_X_SGMII_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_1X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_2X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_4X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_1000,\n\t\t.width\t\t= 1,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_5GBASE_R,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_5gbase_r,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_5GBASE_R_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_1X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_2X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_4X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_5000,\n\t\t.width\t\t= 1,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_XFI_XAUI_1_10G,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_xfi_xaui_1_10g,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_XFI_XAUI_1_10G_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_1X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_2X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_4X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_10000,\n\t\t.width\t\t= 1,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_XLAUI_4_XLPPI_4_40G,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_xlaui_4_xlppi_4_40g,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_XLAUI_4_XLPPI_4_40G_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_4X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_40000,\n\t\t.width\t\t= 4,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_25GAUI_1_25GBASE_CR_KR,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_25gaui_1_25gbase_cr_kr,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_25GAUI_1_25GBASE_CR_KR_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_1X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_2X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_4X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_25000,\n\t\t.width\t\t= 1,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_50GAUI_2_LAUI_2_50GBASE_CR2_KR2,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_50gaui_2_laui_2_50gbase_cr2_kr2,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_50GAUI_2_LAUI_2_50GBASE_CR2_KR2_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_2X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_4X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_50000,\n\t\t.width\t\t= 2,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_50GAUI_1_LAUI_1_50GBASE_CR_KR,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_50gaui_1_laui_1_50gbase_cr_kr,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_50GAUI_1_LAUI_1_50GBASE_CR_KR_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_1X,\n\t\t.speed\t\t= SPEED_50000,\n\t\t.width\t\t= 1,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_CAUI_4_100GBASE_CR4_KR4,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_caui_4_100gbase_cr4_kr4,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_CAUI_4_100GBASE_CR4_KR4_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_4X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_100000,\n\t\t.width\t\t= 4,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_100GAUI_2_100GBASE_CR2_KR2,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_100gaui_2_100gbase_cr2_kr2,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_100GAUI_2_100GBASE_CR2_KR2_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_2X,\n\t\t.speed\t\t= SPEED_100000,\n\t\t.width\t\t= 2,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_200GAUI_4_200GBASE_CR4_KR4,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_200gaui_4_200gbase_cr4_kr4,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_200GAUI_4_200GBASE_CR4_KR4_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_4X |\n\t\t\t\t  MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_200000,\n\t\t.width\t\t= 4,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_400GAUI_8,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_400gaui_8,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_400GAUI_8_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_400000,\n\t\t.width\t\t= 8,\n\t},\n\t{\n\t\t.mask\t\t= MLXSW_REG_PTYS_EXT_ETH_SPEED_800GAUI_8,\n\t\t.mask_ethtool\t= mlxsw_sp2_mask_ethtool_800gaui_8,\n\t\t.m_ethtool_len\t= MLXSW_SP2_MASK_ETHTOOL_800GAUI_8_LEN,\n\t\t.mask_sup_width\t= MLXSW_SP_PORT_MASK_WIDTH_8X,\n\t\t.speed\t\t= SPEED_800000,\n\t\t.width\t\t= 8,\n\t},\n};\n\n#define MLXSW_SP2_PORT_LINK_MODE_LEN ARRAY_SIZE(mlxsw_sp2_port_link_mode)\n\nstatic void\nmlxsw_sp2_from_ptys_supported_port(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t   u32 ptys_eth_proto,\n\t\t\t\t   struct ethtool_link_ksettings *cmd)\n{\n\tethtool_link_ksettings_add_link_mode(cmd, supported, FIBRE);\n\tethtool_link_ksettings_add_link_mode(cmd, supported, Backplane);\n}\n\nstatic void\nmlxsw_sp2_set_bit_ethtool(const struct mlxsw_sp2_port_link_mode *link_mode,\n\t\t\t  unsigned long *mode)\n{\n\tint i;\n\n\tfor (i = 0; i < link_mode->m_ethtool_len; i++)\n\t\t__set_bit(link_mode->mask_ethtool[i], mode);\n}\n\nstatic void\nmlxsw_sp2_from_ptys_link(struct mlxsw_sp *mlxsw_sp, u32 ptys_eth_proto,\n\t\t\t unsigned long *mode)\n{\n\tint i;\n\n\tfor (i = 0; i < MLXSW_SP2_PORT_LINK_MODE_LEN; i++) {\n\t\tif (ptys_eth_proto & mlxsw_sp2_port_link_mode[i].mask)\n\t\t\tmlxsw_sp2_set_bit_ethtool(&mlxsw_sp2_port_link_mode[i],\n\t\t\t\t\t\t  mode);\n\t}\n}\n\nstatic u32\nmlxsw_sp2_from_ptys_speed(struct mlxsw_sp *mlxsw_sp, u32 ptys_eth_proto)\n{\n\tint i;\n\n\tfor (i = 0; i < MLXSW_SP2_PORT_LINK_MODE_LEN; i++) {\n\t\tif (ptys_eth_proto & mlxsw_sp2_port_link_mode[i].mask)\n\t\t\treturn mlxsw_sp2_port_link_mode[i].speed;\n\t}\n\n\treturn SPEED_UNKNOWN;\n}\n\nstatic void\nmlxsw_sp2_from_ptys_link_mode(struct mlxsw_sp *mlxsw_sp, bool carrier_ok,\n\t\t\t      u32 ptys_eth_proto,\n\t\t\t      struct ethtool_link_ksettings *cmd)\n{\n\tstruct mlxsw_sp2_port_link_mode link;\n\tint i;\n\n\tcmd->base.speed = SPEED_UNKNOWN;\n\tcmd->base.duplex = DUPLEX_UNKNOWN;\n\tcmd->lanes = 0;\n\n\tif (!carrier_ok)\n\t\treturn;\n\n\tfor (i = 0; i < MLXSW_SP2_PORT_LINK_MODE_LEN; i++) {\n\t\tif (ptys_eth_proto & mlxsw_sp2_port_link_mode[i].mask) {\n\t\t\tlink = mlxsw_sp2_port_link_mode[i];\n\t\t\tethtool_params_from_link_mode(cmd,\n\t\t\t\t\t\t      link.mask_ethtool[1]);\n\t\t}\n\t}\n}\n\nstatic int mlxsw_sp2_ptys_max_speed(struct mlxsw_sp_port *mlxsw_sp_port, u32 *p_max_speed)\n{\n\tu32 eth_proto_cap;\n\tu32 max_speed = 0;\n\tint err;\n\tint i;\n\n\terr = mlxsw_sp_port_ptys_query(mlxsw_sp_port, &eth_proto_cap, NULL, NULL, NULL);\n\tif (err)\n\t\treturn err;\n\n\tfor (i = 0; i < MLXSW_SP2_PORT_LINK_MODE_LEN; i++) {\n\t\tif ((eth_proto_cap & mlxsw_sp2_port_link_mode[i].mask) &&\n\t\t    mlxsw_sp2_port_link_mode[i].speed > max_speed)\n\t\t\tmax_speed = mlxsw_sp2_port_link_mode[i].speed;\n\t}\n\n\t*p_max_speed = max_speed;\n\treturn 0;\n}\n\nstatic bool\nmlxsw_sp2_test_bit_ethtool(const struct mlxsw_sp2_port_link_mode *link_mode,\n\t\t\t   const unsigned long *mode)\n{\n\tint cnt = 0;\n\tint i;\n\n\tfor (i = 0; i < link_mode->m_ethtool_len; i++) {\n\t\tif (test_bit(link_mode->mask_ethtool[i], mode))\n\t\t\tcnt++;\n\t}\n\n\treturn cnt == link_mode->m_ethtool_len;\n}\n\nstatic u32\nmlxsw_sp2_to_ptys_advert_link(struct mlxsw_sp *mlxsw_sp,\n\t\t\t      const struct ethtool_link_ksettings *cmd)\n{\n\tu32 ptys_proto = 0;\n\tint i;\n\n\tfor (i = 0; i < MLXSW_SP2_PORT_LINK_MODE_LEN; i++) {\n\t\tif (mlxsw_sp2_test_bit_ethtool(&mlxsw_sp2_port_link_mode[i],\n\t\t\t\t\t       cmd->link_modes.advertising))\n\t\t\tptys_proto |= mlxsw_sp2_port_link_mode[i].mask;\n\t}\n\treturn ptys_proto;\n}\n\nstatic u32 mlxsw_sp2_to_ptys_speed_lanes(struct mlxsw_sp *mlxsw_sp, u8 width,\n\t\t\t\t\t const struct ethtool_link_ksettings *cmd)\n{\n\tu8 mask_width = mlxsw_sp_port_mask_width_get(width);\n\tstruct mlxsw_sp2_port_link_mode link_mode;\n\tu32 ptys_proto = 0;\n\tint i;\n\n\tif (cmd->lanes > width)\n\t\treturn ptys_proto;\n\n\tfor (i = 0; i < MLXSW_SP2_PORT_LINK_MODE_LEN; i++) {\n\t\tif (cmd->base.speed == mlxsw_sp2_port_link_mode[i].speed) {\n\t\t\tlink_mode = mlxsw_sp2_port_link_mode[i];\n\n\t\t\tif (!cmd->lanes) {\n\t\t\t\t \n\t\t\t\tif (mask_width & link_mode.mask_sup_width)\n\t\t\t\t\tptys_proto |= link_mode.mask;\n\t\t\t} else if (cmd->lanes == link_mode.width) {\n\t\t\t\t \n\t\t\t\tptys_proto |= link_mode.mask;\n\t\t\t}\n\t\t}\n\t}\n\treturn ptys_proto;\n}\n\nstatic void\nmlxsw_sp2_reg_ptys_eth_pack(struct mlxsw_sp *mlxsw_sp, char *payload,\n\t\t\t    u16 local_port, u32 proto_admin,\n\t\t\t    bool autoneg)\n{\n\tmlxsw_reg_ptys_ext_eth_pack(payload, local_port, proto_admin, autoneg);\n}\n\nstatic void\nmlxsw_sp2_reg_ptys_eth_unpack(struct mlxsw_sp *mlxsw_sp, char *payload,\n\t\t\t      u32 *p_eth_proto_cap, u32 *p_eth_proto_admin,\n\t\t\t      u32 *p_eth_proto_oper)\n{\n\tmlxsw_reg_ptys_ext_eth_unpack(payload, p_eth_proto_cap,\n\t\t\t\t      p_eth_proto_admin, p_eth_proto_oper);\n}\n\nstatic u32 mlxsw_sp2_ptys_proto_cap_masked_get(u32 eth_proto_cap)\n{\n\tu32 ptys_proto_cap_masked = 0;\n\tint i;\n\n\tfor (i = 0; i < MLXSW_SP2_PORT_LINK_MODE_LEN; i++) {\n\t\tif (mlxsw_sp2_port_link_mode[i].mask & eth_proto_cap)\n\t\t\tptys_proto_cap_masked |=\n\t\t\t\tmlxsw_sp2_port_link_mode[i].mask;\n\t}\n\n\treturn ptys_proto_cap_masked;\n}\n\nconst struct mlxsw_sp_port_type_speed_ops mlxsw_sp2_port_type_speed_ops = {\n\t.from_ptys_supported_port\t= mlxsw_sp2_from_ptys_supported_port,\n\t.from_ptys_link\t\t\t= mlxsw_sp2_from_ptys_link,\n\t.from_ptys_speed\t\t= mlxsw_sp2_from_ptys_speed,\n\t.from_ptys_link_mode\t\t= mlxsw_sp2_from_ptys_link_mode,\n\t.ptys_max_speed\t\t\t= mlxsw_sp2_ptys_max_speed,\n\t.to_ptys_advert_link\t\t= mlxsw_sp2_to_ptys_advert_link,\n\t.to_ptys_speed_lanes\t\t= mlxsw_sp2_to_ptys_speed_lanes,\n\t.reg_ptys_eth_pack\t\t= mlxsw_sp2_reg_ptys_eth_pack,\n\t.reg_ptys_eth_unpack\t\t= mlxsw_sp2_reg_ptys_eth_unpack,\n\t.ptys_proto_cap_masked_get\t= mlxsw_sp2_ptys_proto_cap_masked_get,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}