{
  "module_name": "spectrum_acl_ctcam.c",
  "hash_id": "79cda7c2b109b86880ed88271dd63c56bf8e4b970aeb69202654f0d148587695",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_ctcam.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/parman.h>\n\n#include \"reg.h\"\n#include \"core.h\"\n#include \"spectrum.h\"\n#include \"spectrum_acl_tcam.h\"\n\nstatic int\nmlxsw_sp_acl_ctcam_region_resize(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t struct mlxsw_sp_acl_tcam_region *region,\n\t\t\t\t u16 new_size)\n{\n\tchar ptar_pl[MLXSW_REG_PTAR_LEN];\n\n\tmlxsw_reg_ptar_pack(ptar_pl, MLXSW_REG_PTAR_OP_RESIZE,\n\t\t\t    region->key_type, new_size, region->id,\n\t\t\t    region->tcam_region_info);\n\treturn mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(ptar), ptar_pl);\n}\n\nstatic void\nmlxsw_sp_acl_ctcam_region_move(struct mlxsw_sp *mlxsw_sp,\n\t\t\t       struct mlxsw_sp_acl_tcam_region *region,\n\t\t\t       u16 src_offset, u16 dst_offset, u16 size)\n{\n\tchar prcr_pl[MLXSW_REG_PRCR_LEN];\n\n\tmlxsw_reg_prcr_pack(prcr_pl, MLXSW_REG_PRCR_OP_MOVE,\n\t\t\t    region->tcam_region_info, src_offset,\n\t\t\t    region->tcam_region_info, dst_offset, size);\n\tmlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(prcr), prcr_pl);\n}\n\nstatic int\nmlxsw_sp_acl_ctcam_region_entry_insert(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t       struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t       struct mlxsw_sp_acl_ctcam_entry *centry,\n\t\t\t\t       struct mlxsw_sp_acl_rule_info *rulei,\n\t\t\t\t       bool fillup_priority)\n{\n\tstruct mlxsw_sp_acl_tcam_region *region = cregion->region;\n\tstruct mlxsw_afk *afk = mlxsw_sp_acl_afk(mlxsw_sp->acl);\n\tchar ptce2_pl[MLXSW_REG_PTCE2_LEN];\n\tchar *act_set;\n\tu32 priority;\n\tchar *mask;\n\tchar *key;\n\tint err;\n\n\terr = mlxsw_sp_acl_tcam_priority_get(mlxsw_sp, rulei, &priority,\n\t\t\t\t\t     fillup_priority);\n\tif (err)\n\t\treturn err;\n\n\tmlxsw_reg_ptce2_pack(ptce2_pl, true, MLXSW_REG_PTCE2_OP_WRITE_WRITE,\n\t\t\t     region->tcam_region_info,\n\t\t\t     centry->parman_item.index, priority);\n\tkey = mlxsw_reg_ptce2_flex_key_blocks_data(ptce2_pl);\n\tmask = mlxsw_reg_ptce2_mask_data(ptce2_pl);\n\tmlxsw_afk_encode(afk, region->key_info, &rulei->values, key, mask);\n\n\terr = cregion->ops->entry_insert(cregion, centry, mask);\n\tif (err)\n\t\treturn err;\n\n\t \n\tact_set = mlxsw_afa_block_first_set(rulei->act_block);\n\tmlxsw_reg_ptce2_flex_action_set_memcpy_to(ptce2_pl, act_set);\n\n\terr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(ptce2), ptce2_pl);\n\tif (err)\n\t\tgoto err_ptce2_write;\n\n\treturn 0;\n\nerr_ptce2_write:\n\tcregion->ops->entry_remove(cregion, centry);\n\treturn err;\n}\n\nstatic void\nmlxsw_sp_acl_ctcam_region_entry_remove(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t       struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t       struct mlxsw_sp_acl_ctcam_entry *centry)\n{\n\tchar ptce2_pl[MLXSW_REG_PTCE2_LEN];\n\n\tmlxsw_reg_ptce2_pack(ptce2_pl, false, MLXSW_REG_PTCE2_OP_WRITE_WRITE,\n\t\t\t     cregion->region->tcam_region_info,\n\t\t\t     centry->parman_item.index, 0);\n\tmlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(ptce2), ptce2_pl);\n\tcregion->ops->entry_remove(cregion, centry);\n}\n\nstatic int\nmlxsw_sp_acl_ctcam_region_entry_action_replace(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\t       struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t\t       struct mlxsw_sp_acl_ctcam_entry *centry,\n\t\t\t\t\t       struct mlxsw_afa_block *afa_block,\n\t\t\t\t\t       unsigned int priority)\n{\n\tchar ptce2_pl[MLXSW_REG_PTCE2_LEN];\n\tchar *act_set;\n\n\tmlxsw_reg_ptce2_pack(ptce2_pl, true, MLXSW_REG_PTCE2_OP_WRITE_UPDATE,\n\t\t\t     cregion->region->tcam_region_info,\n\t\t\t     centry->parman_item.index, priority);\n\n\tact_set = mlxsw_afa_block_first_set(afa_block);\n\tmlxsw_reg_ptce2_flex_action_set_memcpy_to(ptce2_pl, act_set);\n\n\treturn mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(ptce2), ptce2_pl);\n}\n\n\nstatic int mlxsw_sp_acl_ctcam_region_parman_resize(void *priv,\n\t\t\t\t\t\t   unsigned long new_count)\n{\n\tstruct mlxsw_sp_acl_ctcam_region *cregion = priv;\n\tstruct mlxsw_sp_acl_tcam_region *region = cregion->region;\n\tstruct mlxsw_sp *mlxsw_sp = region->mlxsw_sp;\n\tu64 max_tcam_rules;\n\n\tmax_tcam_rules = MLXSW_CORE_RES_GET(mlxsw_sp->core, ACL_MAX_TCAM_RULES);\n\tif (new_count > max_tcam_rules)\n\t\treturn -EINVAL;\n\treturn mlxsw_sp_acl_ctcam_region_resize(mlxsw_sp, region, new_count);\n}\n\nstatic void mlxsw_sp_acl_ctcam_region_parman_move(void *priv,\n\t\t\t\t\t\t  unsigned long from_index,\n\t\t\t\t\t\t  unsigned long to_index,\n\t\t\t\t\t\t  unsigned long count)\n{\n\tstruct mlxsw_sp_acl_ctcam_region *cregion = priv;\n\tstruct mlxsw_sp_acl_tcam_region *region = cregion->region;\n\tstruct mlxsw_sp *mlxsw_sp = region->mlxsw_sp;\n\n\tmlxsw_sp_acl_ctcam_region_move(mlxsw_sp, region,\n\t\t\t\t       from_index, to_index, count);\n}\n\nstatic const struct parman_ops mlxsw_sp_acl_ctcam_region_parman_ops = {\n\t.base_count\t= MLXSW_SP_ACL_TCAM_REGION_BASE_COUNT,\n\t.resize_step\t= MLXSW_SP_ACL_TCAM_REGION_RESIZE_STEP,\n\t.resize\t\t= mlxsw_sp_acl_ctcam_region_parman_resize,\n\t.move\t\t= mlxsw_sp_acl_ctcam_region_parman_move,\n\t.algo\t\t= PARMAN_ALGO_TYPE_LSORT,\n};\n\nint\nmlxsw_sp_acl_ctcam_region_init(struct mlxsw_sp *mlxsw_sp,\n\t\t\t       struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t       struct mlxsw_sp_acl_tcam_region *region,\n\t\t\t       const struct mlxsw_sp_acl_ctcam_region_ops *ops)\n{\n\tcregion->region = region;\n\tcregion->ops = ops;\n\tcregion->parman = parman_create(&mlxsw_sp_acl_ctcam_region_parman_ops,\n\t\t\t\t\tcregion);\n\tif (!cregion->parman)\n\t\treturn -ENOMEM;\n\treturn 0;\n}\n\nvoid mlxsw_sp_acl_ctcam_region_fini(struct mlxsw_sp_acl_ctcam_region *cregion)\n{\n\tparman_destroy(cregion->parman);\n}\n\nvoid mlxsw_sp_acl_ctcam_chunk_init(struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t   struct mlxsw_sp_acl_ctcam_chunk *cchunk,\n\t\t\t\t   unsigned int priority)\n{\n\tparman_prio_init(cregion->parman, &cchunk->parman_prio, priority);\n}\n\nvoid mlxsw_sp_acl_ctcam_chunk_fini(struct mlxsw_sp_acl_ctcam_chunk *cchunk)\n{\n\tparman_prio_fini(&cchunk->parman_prio);\n}\n\nint mlxsw_sp_acl_ctcam_entry_add(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t struct mlxsw_sp_acl_ctcam_chunk *cchunk,\n\t\t\t\t struct mlxsw_sp_acl_ctcam_entry *centry,\n\t\t\t\t struct mlxsw_sp_acl_rule_info *rulei,\n\t\t\t\t bool fillup_priority)\n{\n\tint err;\n\n\terr = parman_item_add(cregion->parman, &cchunk->parman_prio,\n\t\t\t      &centry->parman_item);\n\tif (err)\n\t\treturn err;\n\n\terr = mlxsw_sp_acl_ctcam_region_entry_insert(mlxsw_sp, cregion, centry,\n\t\t\t\t\t\t     rulei, fillup_priority);\n\tif (err)\n\t\tgoto err_rule_insert;\n\treturn 0;\n\nerr_rule_insert:\n\tparman_item_remove(cregion->parman, &cchunk->parman_prio,\n\t\t\t   &centry->parman_item);\n\treturn err;\n}\n\nvoid mlxsw_sp_acl_ctcam_entry_del(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t  struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t  struct mlxsw_sp_acl_ctcam_chunk *cchunk,\n\t\t\t\t  struct mlxsw_sp_acl_ctcam_entry *centry)\n{\n\tmlxsw_sp_acl_ctcam_region_entry_remove(mlxsw_sp, cregion, centry);\n\tparman_item_remove(cregion->parman, &cchunk->parman_prio,\n\t\t\t   &centry->parman_item);\n}\n\nint mlxsw_sp_acl_ctcam_entry_action_replace(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\t    struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t\t    struct mlxsw_sp_acl_ctcam_entry *centry,\n\t\t\t\t\t    struct mlxsw_sp_acl_rule_info *rulei)\n{\n\treturn mlxsw_sp_acl_ctcam_region_entry_action_replace(mlxsw_sp, cregion,\n\t\t\t\t\t\t\t      centry,\n\t\t\t\t\t\t\t      rulei->act_block,\n\t\t\t\t\t\t\t      rulei->priority);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}