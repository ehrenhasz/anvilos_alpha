{
  "module_name": "spectrum_acl_atcam.c",
  "hash_id": "99bb83908cb7019039037217782c2af4b44998cf47085db6917920ec3f3b4a96",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlxsw/spectrum_acl_atcam.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/err.h>\n#include <linux/errno.h>\n#include <linux/gfp.h>\n#include <linux/refcount.h>\n#include <linux/rhashtable.h>\n#define CREATE_TRACE_POINTS\n#include <trace/events/mlxsw.h>\n\n#include \"reg.h\"\n#include \"core.h\"\n#include \"spectrum.h\"\n#include \"spectrum_acl_tcam.h\"\n#include \"core_acl_flex_keys.h\"\n\n#define MLXSW_SP_ACL_ATCAM_LKEY_ID_BLOCK_CLEAR_START\t0\n#define MLXSW_SP_ACL_ATCAM_LKEY_ID_BLOCK_CLEAR_END\t5\n\nstruct mlxsw_sp_acl_atcam_lkey_id_ht_key {\n\tchar enc_key[MLXSW_REG_PTCEX_FLEX_KEY_BLOCKS_LEN];  \n\tu8 erp_id;\n};\n\nstruct mlxsw_sp_acl_atcam_lkey_id {\n\tstruct rhash_head ht_node;\n\tstruct mlxsw_sp_acl_atcam_lkey_id_ht_key ht_key;\n\trefcount_t refcnt;\n\tu32 id;\n};\n\nstruct mlxsw_sp_acl_atcam_region_ops {\n\tint (*init)(struct mlxsw_sp_acl_atcam_region *aregion);\n\tvoid (*fini)(struct mlxsw_sp_acl_atcam_region *aregion);\n\tstruct mlxsw_sp_acl_atcam_lkey_id *\n\t\t(*lkey_id_get)(struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t       char *enc_key, u8 erp_id);\n\tvoid (*lkey_id_put)(struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t    struct mlxsw_sp_acl_atcam_lkey_id *lkey_id);\n};\n\nstruct mlxsw_sp_acl_atcam_region_generic {\n\tstruct mlxsw_sp_acl_atcam_lkey_id dummy_lkey_id;\n};\n\nstruct mlxsw_sp_acl_atcam_region_12kb {\n\tstruct rhashtable lkey_ht;\n\tunsigned int max_lkey_id;\n\tunsigned long *used_lkey_id;\n};\n\nstatic const struct rhashtable_params mlxsw_sp_acl_atcam_lkey_id_ht_params = {\n\t.key_len = sizeof(struct mlxsw_sp_acl_atcam_lkey_id_ht_key),\n\t.key_offset = offsetof(struct mlxsw_sp_acl_atcam_lkey_id, ht_key),\n\t.head_offset = offsetof(struct mlxsw_sp_acl_atcam_lkey_id, ht_node),\n};\n\nstatic const struct rhashtable_params mlxsw_sp_acl_atcam_entries_ht_params = {\n\t.key_len = sizeof(struct mlxsw_sp_acl_atcam_entry_ht_key),\n\t.key_offset = offsetof(struct mlxsw_sp_acl_atcam_entry, ht_key),\n\t.head_offset = offsetof(struct mlxsw_sp_acl_atcam_entry, ht_node),\n};\n\nstatic bool\nmlxsw_sp_acl_atcam_is_centry(const struct mlxsw_sp_acl_atcam_entry *aentry)\n{\n\treturn mlxsw_sp_acl_erp_mask_is_ctcam(aentry->erp_mask);\n}\n\nstatic int\nmlxsw_sp_acl_atcam_region_generic_init(struct mlxsw_sp_acl_atcam_region *aregion)\n{\n\tstruct mlxsw_sp_acl_atcam_region_generic *region_generic;\n\n\tregion_generic = kzalloc(sizeof(*region_generic), GFP_KERNEL);\n\tif (!region_generic)\n\t\treturn -ENOMEM;\n\n\trefcount_set(&region_generic->dummy_lkey_id.refcnt, 1);\n\taregion->priv = region_generic;\n\n\treturn 0;\n}\n\nstatic void\nmlxsw_sp_acl_atcam_region_generic_fini(struct mlxsw_sp_acl_atcam_region *aregion)\n{\n\tkfree(aregion->priv);\n}\n\nstatic struct mlxsw_sp_acl_atcam_lkey_id *\nmlxsw_sp_acl_atcam_generic_lkey_id_get(struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t       char *enc_key, u8 erp_id)\n{\n\tstruct mlxsw_sp_acl_atcam_region_generic *region_generic;\n\n\tregion_generic = aregion->priv;\n\treturn &region_generic->dummy_lkey_id;\n}\n\nstatic void\nmlxsw_sp_acl_atcam_generic_lkey_id_put(struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t       struct mlxsw_sp_acl_atcam_lkey_id *lkey_id)\n{\n}\n\nstatic const struct mlxsw_sp_acl_atcam_region_ops\nmlxsw_sp_acl_atcam_region_generic_ops = {\n\t.init\t\t= mlxsw_sp_acl_atcam_region_generic_init,\n\t.fini\t\t= mlxsw_sp_acl_atcam_region_generic_fini,\n\t.lkey_id_get\t= mlxsw_sp_acl_atcam_generic_lkey_id_get,\n\t.lkey_id_put\t= mlxsw_sp_acl_atcam_generic_lkey_id_put,\n};\n\nstatic int\nmlxsw_sp_acl_atcam_region_12kb_init(struct mlxsw_sp_acl_atcam_region *aregion)\n{\n\tstruct mlxsw_sp *mlxsw_sp = aregion->region->mlxsw_sp;\n\tstruct mlxsw_sp_acl_atcam_region_12kb *region_12kb;\n\tu64 max_lkey_id;\n\tint err;\n\n\tif (!MLXSW_CORE_RES_VALID(mlxsw_sp->core, ACL_MAX_LARGE_KEY_ID))\n\t\treturn -EIO;\n\n\tmax_lkey_id = MLXSW_CORE_RES_GET(mlxsw_sp->core, ACL_MAX_LARGE_KEY_ID);\n\tregion_12kb = kzalloc(sizeof(*region_12kb), GFP_KERNEL);\n\tif (!region_12kb)\n\t\treturn -ENOMEM;\n\n\tregion_12kb->used_lkey_id = bitmap_zalloc(max_lkey_id, GFP_KERNEL);\n\tif (!region_12kb->used_lkey_id) {\n\t\terr = -ENOMEM;\n\t\tgoto err_used_lkey_id_alloc;\n\t}\n\n\terr = rhashtable_init(&region_12kb->lkey_ht,\n\t\t\t      &mlxsw_sp_acl_atcam_lkey_id_ht_params);\n\tif (err)\n\t\tgoto err_rhashtable_init;\n\n\tregion_12kb->max_lkey_id = max_lkey_id;\n\taregion->priv = region_12kb;\n\n\treturn 0;\n\nerr_rhashtable_init:\n\tbitmap_free(region_12kb->used_lkey_id);\nerr_used_lkey_id_alloc:\n\tkfree(region_12kb);\n\treturn err;\n}\n\nstatic void\nmlxsw_sp_acl_atcam_region_12kb_fini(struct mlxsw_sp_acl_atcam_region *aregion)\n{\n\tstruct mlxsw_sp_acl_atcam_region_12kb *region_12kb = aregion->priv;\n\n\trhashtable_destroy(&region_12kb->lkey_ht);\n\tbitmap_free(region_12kb->used_lkey_id);\n\tkfree(region_12kb);\n}\n\nstatic struct mlxsw_sp_acl_atcam_lkey_id *\nmlxsw_sp_acl_atcam_lkey_id_create(struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t  struct mlxsw_sp_acl_atcam_lkey_id_ht_key *ht_key)\n{\n\tstruct mlxsw_sp_acl_atcam_region_12kb *region_12kb = aregion->priv;\n\tstruct mlxsw_sp_acl_atcam_lkey_id *lkey_id;\n\tu32 id;\n\tint err;\n\n\tid = find_first_zero_bit(region_12kb->used_lkey_id,\n\t\t\t\t region_12kb->max_lkey_id);\n\tif (id < region_12kb->max_lkey_id)\n\t\t__set_bit(id, region_12kb->used_lkey_id);\n\telse\n\t\treturn ERR_PTR(-ENOBUFS);\n\n\tlkey_id = kzalloc(sizeof(*lkey_id), GFP_KERNEL);\n\tif (!lkey_id) {\n\t\terr = -ENOMEM;\n\t\tgoto err_lkey_id_alloc;\n\t}\n\n\tlkey_id->id = id;\n\tmemcpy(&lkey_id->ht_key, ht_key, sizeof(*ht_key));\n\trefcount_set(&lkey_id->refcnt, 1);\n\n\terr = rhashtable_insert_fast(&region_12kb->lkey_ht,\n\t\t\t\t     &lkey_id->ht_node,\n\t\t\t\t     mlxsw_sp_acl_atcam_lkey_id_ht_params);\n\tif (err)\n\t\tgoto err_rhashtable_insert;\n\n\treturn lkey_id;\n\nerr_rhashtable_insert:\n\tkfree(lkey_id);\nerr_lkey_id_alloc:\n\t__clear_bit(id, region_12kb->used_lkey_id);\n\treturn ERR_PTR(err);\n}\n\nstatic void\nmlxsw_sp_acl_atcam_lkey_id_destroy(struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t   struct mlxsw_sp_acl_atcam_lkey_id *lkey_id)\n{\n\tstruct mlxsw_sp_acl_atcam_region_12kb *region_12kb = aregion->priv;\n\tu32 id = lkey_id->id;\n\n\trhashtable_remove_fast(&region_12kb->lkey_ht, &lkey_id->ht_node,\n\t\t\t       mlxsw_sp_acl_atcam_lkey_id_ht_params);\n\tkfree(lkey_id);\n\t__clear_bit(id, region_12kb->used_lkey_id);\n}\n\nstatic struct mlxsw_sp_acl_atcam_lkey_id *\nmlxsw_sp_acl_atcam_12kb_lkey_id_get(struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t    char *enc_key, u8 erp_id)\n{\n\tstruct mlxsw_sp_acl_atcam_region_12kb *region_12kb = aregion->priv;\n\tstruct mlxsw_sp_acl_tcam_region *region = aregion->region;\n\tstruct mlxsw_sp_acl_atcam_lkey_id_ht_key ht_key = {{ 0 } };\n\tstruct mlxsw_sp *mlxsw_sp = region->mlxsw_sp;\n\tstruct mlxsw_afk *afk = mlxsw_sp_acl_afk(mlxsw_sp->acl);\n\tstruct mlxsw_sp_acl_atcam_lkey_id *lkey_id;\n\n\tmemcpy(ht_key.enc_key, enc_key, sizeof(ht_key.enc_key));\n\tmlxsw_afk_clear(afk, ht_key.enc_key,\n\t\t\tMLXSW_SP_ACL_ATCAM_LKEY_ID_BLOCK_CLEAR_START,\n\t\t\tMLXSW_SP_ACL_ATCAM_LKEY_ID_BLOCK_CLEAR_END);\n\tht_key.erp_id = erp_id;\n\tlkey_id = rhashtable_lookup_fast(&region_12kb->lkey_ht, &ht_key,\n\t\t\t\t\t mlxsw_sp_acl_atcam_lkey_id_ht_params);\n\tif (lkey_id) {\n\t\trefcount_inc(&lkey_id->refcnt);\n\t\treturn lkey_id;\n\t}\n\n\treturn mlxsw_sp_acl_atcam_lkey_id_create(aregion, &ht_key);\n}\n\nstatic void\nmlxsw_sp_acl_atcam_12kb_lkey_id_put(struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t    struct mlxsw_sp_acl_atcam_lkey_id *lkey_id)\n{\n\tif (refcount_dec_and_test(&lkey_id->refcnt))\n\t\tmlxsw_sp_acl_atcam_lkey_id_destroy(aregion, lkey_id);\n}\n\nstatic const struct mlxsw_sp_acl_atcam_region_ops\nmlxsw_sp_acl_atcam_region_12kb_ops = {\n\t.init\t\t= mlxsw_sp_acl_atcam_region_12kb_init,\n\t.fini\t\t= mlxsw_sp_acl_atcam_region_12kb_fini,\n\t.lkey_id_get\t= mlxsw_sp_acl_atcam_12kb_lkey_id_get,\n\t.lkey_id_put\t= mlxsw_sp_acl_atcam_12kb_lkey_id_put,\n};\n\nstatic const struct mlxsw_sp_acl_atcam_region_ops *\nmlxsw_sp_acl_atcam_region_ops_arr[] = {\n\t[MLXSW_SP_ACL_ATCAM_REGION_TYPE_2KB]\t=\n\t\t&mlxsw_sp_acl_atcam_region_generic_ops,\n\t[MLXSW_SP_ACL_ATCAM_REGION_TYPE_4KB]\t=\n\t\t&mlxsw_sp_acl_atcam_region_generic_ops,\n\t[MLXSW_SP_ACL_ATCAM_REGION_TYPE_8KB]\t=\n\t\t&mlxsw_sp_acl_atcam_region_generic_ops,\n\t[MLXSW_SP_ACL_ATCAM_REGION_TYPE_12KB]\t=\n\t\t&mlxsw_sp_acl_atcam_region_12kb_ops,\n};\n\nint mlxsw_sp_acl_atcam_region_associate(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\tu16 region_id)\n{\n\tchar perar_pl[MLXSW_REG_PERAR_LEN];\n\t \n\tu16 hw_region = region_id * 3;\n\tu64 max_regions;\n\n\tmax_regions = MLXSW_CORE_RES_GET(mlxsw_sp->core, ACL_MAX_REGIONS);\n\tif (hw_region >= max_regions)\n\t\treturn -ENOBUFS;\n\n\tmlxsw_reg_perar_pack(perar_pl, region_id, hw_region);\n\treturn mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(perar), perar_pl);\n}\n\nstatic void\nmlxsw_sp_acl_atcam_region_type_init(struct mlxsw_sp_acl_atcam_region *aregion)\n{\n\tstruct mlxsw_sp_acl_tcam_region *region = aregion->region;\n\tenum mlxsw_sp_acl_atcam_region_type region_type;\n\tunsigned int blocks_count;\n\n\t \n\tblocks_count = mlxsw_afk_key_info_blocks_count_get(region->key_info);\n\tif (blocks_count <= 2)\n\t\tregion_type = MLXSW_SP_ACL_ATCAM_REGION_TYPE_2KB;\n\telse if (blocks_count <= 4)\n\t\tregion_type = MLXSW_SP_ACL_ATCAM_REGION_TYPE_4KB;\n\telse if (blocks_count <= 8)\n\t\tregion_type = MLXSW_SP_ACL_ATCAM_REGION_TYPE_8KB;\n\telse\n\t\tregion_type = MLXSW_SP_ACL_ATCAM_REGION_TYPE_12KB;\n\n\taregion->type = region_type;\n\taregion->ops = mlxsw_sp_acl_atcam_region_ops_arr[region_type];\n}\n\nint\nmlxsw_sp_acl_atcam_region_init(struct mlxsw_sp *mlxsw_sp,\n\t\t\t       struct mlxsw_sp_acl_atcam *atcam,\n\t\t\t       struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t       struct mlxsw_sp_acl_tcam_region *region,\n\t\t\t       void *hints_priv,\n\t\t\t       const struct mlxsw_sp_acl_ctcam_region_ops *ops)\n{\n\tint err;\n\n\taregion->region = region;\n\taregion->atcam = atcam;\n\tmlxsw_sp_acl_atcam_region_type_init(aregion);\n\tINIT_LIST_HEAD(&aregion->entries_list);\n\n\terr = rhashtable_init(&aregion->entries_ht,\n\t\t\t      &mlxsw_sp_acl_atcam_entries_ht_params);\n\tif (err)\n\t\treturn err;\n\terr = aregion->ops->init(aregion);\n\tif (err)\n\t\tgoto err_ops_init;\n\terr = mlxsw_sp_acl_erp_region_init(aregion, hints_priv);\n\tif (err)\n\t\tgoto err_erp_region_init;\n\terr = mlxsw_sp_acl_ctcam_region_init(mlxsw_sp, &aregion->cregion,\n\t\t\t\t\t     region, ops);\n\tif (err)\n\t\tgoto err_ctcam_region_init;\n\n\treturn 0;\n\nerr_ctcam_region_init:\n\tmlxsw_sp_acl_erp_region_fini(aregion);\nerr_erp_region_init:\n\taregion->ops->fini(aregion);\nerr_ops_init:\n\trhashtable_destroy(&aregion->entries_ht);\n\treturn err;\n}\n\nvoid mlxsw_sp_acl_atcam_region_fini(struct mlxsw_sp_acl_atcam_region *aregion)\n{\n\tmlxsw_sp_acl_ctcam_region_fini(&aregion->cregion);\n\tmlxsw_sp_acl_erp_region_fini(aregion);\n\taregion->ops->fini(aregion);\n\trhashtable_destroy(&aregion->entries_ht);\n\tWARN_ON(!list_empty(&aregion->entries_list));\n}\n\nvoid mlxsw_sp_acl_atcam_chunk_init(struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t   struct mlxsw_sp_acl_atcam_chunk *achunk,\n\t\t\t\t   unsigned int priority)\n{\n\tmlxsw_sp_acl_ctcam_chunk_init(&aregion->cregion, &achunk->cchunk,\n\t\t\t\t      priority);\n}\n\nvoid mlxsw_sp_acl_atcam_chunk_fini(struct mlxsw_sp_acl_atcam_chunk *achunk)\n{\n\tmlxsw_sp_acl_ctcam_chunk_fini(&achunk->cchunk);\n}\n\nstatic int\nmlxsw_sp_acl_atcam_region_entry_insert(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t       struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t       struct mlxsw_sp_acl_atcam_entry *aentry,\n\t\t\t\t       struct mlxsw_sp_acl_rule_info *rulei)\n{\n\tstruct mlxsw_sp_acl_tcam_region *region = aregion->region;\n\tu8 erp_id = mlxsw_sp_acl_erp_mask_erp_id(aentry->erp_mask);\n\tstruct mlxsw_sp_acl_atcam_lkey_id *lkey_id;\n\tchar ptce3_pl[MLXSW_REG_PTCE3_LEN];\n\tu32 kvdl_index, priority;\n\tint err;\n\n\terr = mlxsw_sp_acl_tcam_priority_get(mlxsw_sp, rulei, &priority, true);\n\tif (err)\n\t\treturn err;\n\n\tlkey_id = aregion->ops->lkey_id_get(aregion, aentry->enc_key, erp_id);\n\tif (IS_ERR(lkey_id))\n\t\treturn PTR_ERR(lkey_id);\n\taentry->lkey_id = lkey_id;\n\n\tkvdl_index = mlxsw_afa_block_first_kvdl_index(rulei->act_block);\n\tmlxsw_reg_ptce3_pack(ptce3_pl, true, MLXSW_REG_PTCE3_OP_WRITE_WRITE,\n\t\t\t     priority, region->tcam_region_info,\n\t\t\t     aentry->enc_key, erp_id,\n\t\t\t     aentry->delta_info.start,\n\t\t\t     aentry->delta_info.mask,\n\t\t\t     aentry->delta_info.value,\n\t\t\t     refcount_read(&lkey_id->refcnt) != 1, lkey_id->id,\n\t\t\t     kvdl_index);\n\terr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(ptce3), ptce3_pl);\n\tif (err)\n\t\tgoto err_ptce3_write;\n\n\treturn 0;\n\nerr_ptce3_write:\n\taregion->ops->lkey_id_put(aregion, lkey_id);\n\treturn err;\n}\n\nstatic void\nmlxsw_sp_acl_atcam_region_entry_remove(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t       struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t       struct mlxsw_sp_acl_atcam_entry *aentry)\n{\n\tstruct mlxsw_sp_acl_atcam_lkey_id *lkey_id = aentry->lkey_id;\n\tstruct mlxsw_sp_acl_tcam_region *region = aregion->region;\n\tu8 erp_id = mlxsw_sp_acl_erp_mask_erp_id(aentry->erp_mask);\n\tchar ptce3_pl[MLXSW_REG_PTCE3_LEN];\n\n\tmlxsw_reg_ptce3_pack(ptce3_pl, false, MLXSW_REG_PTCE3_OP_WRITE_WRITE, 0,\n\t\t\t     region->tcam_region_info,\n\t\t\t     aentry->enc_key, erp_id,\n\t\t\t     aentry->delta_info.start,\n\t\t\t     aentry->delta_info.mask,\n\t\t\t     aentry->delta_info.value,\n\t\t\t     refcount_read(&lkey_id->refcnt) != 1,\n\t\t\t     lkey_id->id, 0);\n\tmlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(ptce3), ptce3_pl);\n\taregion->ops->lkey_id_put(aregion, lkey_id);\n}\n\nstatic int\nmlxsw_sp_acl_atcam_region_entry_action_replace(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\t       struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t\t       struct mlxsw_sp_acl_atcam_entry *aentry,\n\t\t\t\t\t       struct mlxsw_sp_acl_rule_info *rulei)\n{\n\tstruct mlxsw_sp_acl_atcam_lkey_id *lkey_id = aentry->lkey_id;\n\tu8 erp_id = mlxsw_sp_acl_erp_mask_erp_id(aentry->erp_mask);\n\tstruct mlxsw_sp_acl_tcam_region *region = aregion->region;\n\tchar ptce3_pl[MLXSW_REG_PTCE3_LEN];\n\tu32 kvdl_index, priority;\n\tint err;\n\n\terr = mlxsw_sp_acl_tcam_priority_get(mlxsw_sp, rulei, &priority, true);\n\tif (err)\n\t\treturn err;\n\tkvdl_index = mlxsw_afa_block_first_kvdl_index(rulei->act_block);\n\tmlxsw_reg_ptce3_pack(ptce3_pl, true, MLXSW_REG_PTCE3_OP_WRITE_UPDATE,\n\t\t\t     priority, region->tcam_region_info,\n\t\t\t     aentry->enc_key, erp_id,\n\t\t\t     aentry->delta_info.start,\n\t\t\t     aentry->delta_info.mask,\n\t\t\t     aentry->delta_info.value,\n\t\t\t     refcount_read(&lkey_id->refcnt) != 1, lkey_id->id,\n\t\t\t     kvdl_index);\n\treturn mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(ptce3), ptce3_pl);\n}\n\nstatic int\n__mlxsw_sp_acl_atcam_entry_add(struct mlxsw_sp *mlxsw_sp,\n\t\t\t       struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t       struct mlxsw_sp_acl_atcam_entry *aentry,\n\t\t\t       struct mlxsw_sp_acl_rule_info *rulei)\n{\n\tstruct mlxsw_sp_acl_tcam_region *region = aregion->region;\n\tchar mask[MLXSW_REG_PTCEX_FLEX_KEY_BLOCKS_LEN] = { 0 };\n\tstruct mlxsw_afk *afk = mlxsw_sp_acl_afk(mlxsw_sp->acl);\n\tconst struct mlxsw_sp_acl_erp_delta *delta;\n\tstruct mlxsw_sp_acl_erp_mask *erp_mask;\n\tint err;\n\n\tmlxsw_afk_encode(afk, region->key_info, &rulei->values,\n\t\t\t aentry->ht_key.full_enc_key, mask);\n\n\terp_mask = mlxsw_sp_acl_erp_mask_get(aregion, mask, false);\n\tif (IS_ERR(erp_mask))\n\t\treturn PTR_ERR(erp_mask);\n\taentry->erp_mask = erp_mask;\n\taentry->ht_key.erp_id = mlxsw_sp_acl_erp_mask_erp_id(erp_mask);\n\tmemcpy(aentry->enc_key, aentry->ht_key.full_enc_key,\n\t       sizeof(aentry->enc_key));\n\n\t \n\tdelta = mlxsw_sp_acl_erp_delta(aentry->erp_mask);\n\taentry->delta_info.start = mlxsw_sp_acl_erp_delta_start(delta);\n\taentry->delta_info.mask = mlxsw_sp_acl_erp_delta_mask(delta);\n\taentry->delta_info.value =\n\t\tmlxsw_sp_acl_erp_delta_value(delta,\n\t\t\t\t\t     aentry->ht_key.full_enc_key);\n\tmlxsw_sp_acl_erp_delta_clear(delta, aentry->enc_key);\n\n\t \n\tlist_add(&aentry->list, &aregion->entries_list);\n\n\t \n\terr = rhashtable_lookup_insert_fast(&aregion->entries_ht,\n\t\t\t\t\t    &aentry->ht_node,\n\t\t\t\t\t    mlxsw_sp_acl_atcam_entries_ht_params);\n\tif (err)\n\t\tgoto err_rhashtable_insert;\n\n\t \n\terr = mlxsw_sp_acl_erp_bf_insert(mlxsw_sp, aregion, erp_mask, aentry);\n\tif (err)\n\t\tgoto err_bf_insert;\n\n\terr = mlxsw_sp_acl_atcam_region_entry_insert(mlxsw_sp, aregion, aentry,\n\t\t\t\t\t\t     rulei);\n\tif (err)\n\t\tgoto err_rule_insert;\n\n\treturn 0;\n\nerr_rule_insert:\n\tmlxsw_sp_acl_erp_bf_remove(mlxsw_sp, aregion, erp_mask, aentry);\nerr_bf_insert:\n\trhashtable_remove_fast(&aregion->entries_ht, &aentry->ht_node,\n\t\t\t       mlxsw_sp_acl_atcam_entries_ht_params);\nerr_rhashtable_insert:\n\tlist_del(&aentry->list);\n\tmlxsw_sp_acl_erp_mask_put(aregion, erp_mask);\n\treturn err;\n}\n\nstatic void\n__mlxsw_sp_acl_atcam_entry_del(struct mlxsw_sp *mlxsw_sp,\n\t\t\t       struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t       struct mlxsw_sp_acl_atcam_entry *aentry)\n{\n\tmlxsw_sp_acl_atcam_region_entry_remove(mlxsw_sp, aregion, aentry);\n\tmlxsw_sp_acl_erp_bf_remove(mlxsw_sp, aregion, aentry->erp_mask, aentry);\n\trhashtable_remove_fast(&aregion->entries_ht, &aentry->ht_node,\n\t\t\t       mlxsw_sp_acl_atcam_entries_ht_params);\n\tlist_del(&aentry->list);\n\tmlxsw_sp_acl_erp_mask_put(aregion, aentry->erp_mask);\n}\n\nstatic int\n__mlxsw_sp_acl_atcam_entry_action_replace(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\t  struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t\t  struct mlxsw_sp_acl_atcam_entry *aentry,\n\t\t\t\t\t  struct mlxsw_sp_acl_rule_info *rulei)\n{\n\treturn mlxsw_sp_acl_atcam_region_entry_action_replace(mlxsw_sp, aregion,\n\t\t\t\t\t\t\t      aentry, rulei);\n}\n\nint mlxsw_sp_acl_atcam_entry_add(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t struct mlxsw_sp_acl_atcam_chunk *achunk,\n\t\t\t\t struct mlxsw_sp_acl_atcam_entry *aentry,\n\t\t\t\t struct mlxsw_sp_acl_rule_info *rulei)\n{\n\tint err;\n\n\terr = __mlxsw_sp_acl_atcam_entry_add(mlxsw_sp, aregion, aentry, rulei);\n\tif (!err)\n\t\treturn 0;\n\n\t \n\ttrace_mlxsw_sp_acl_atcam_entry_add_ctcam_spill(mlxsw_sp, aregion);\n\terr = mlxsw_sp_acl_ctcam_entry_add(mlxsw_sp, &aregion->cregion,\n\t\t\t\t\t   &achunk->cchunk, &aentry->centry,\n\t\t\t\t\t   rulei, true);\n\tif (!err)\n\t\treturn 0;\n\n\treturn err;\n}\n\nvoid mlxsw_sp_acl_atcam_entry_del(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t  struct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t  struct mlxsw_sp_acl_atcam_chunk *achunk,\n\t\t\t\t  struct mlxsw_sp_acl_atcam_entry *aentry)\n{\n\tif (mlxsw_sp_acl_atcam_is_centry(aentry))\n\t\tmlxsw_sp_acl_ctcam_entry_del(mlxsw_sp, &aregion->cregion,\n\t\t\t\t\t     &achunk->cchunk, &aentry->centry);\n\telse\n\t\t__mlxsw_sp_acl_atcam_entry_del(mlxsw_sp, aregion, aentry);\n}\n\nint\nmlxsw_sp_acl_atcam_entry_action_replace(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\tstruct mlxsw_sp_acl_atcam_region *aregion,\n\t\t\t\t\tstruct mlxsw_sp_acl_atcam_entry *aentry,\n\t\t\t\t\tstruct mlxsw_sp_acl_rule_info *rulei)\n{\n\tint err;\n\n\tif (mlxsw_sp_acl_atcam_is_centry(aentry))\n\t\terr = mlxsw_sp_acl_ctcam_entry_action_replace(mlxsw_sp,\n\t\t\t\t\t\t\t      &aregion->cregion,\n\t\t\t\t\t\t\t      &aentry->centry,\n\t\t\t\t\t\t\t      rulei);\n\telse\n\t\terr = __mlxsw_sp_acl_atcam_entry_action_replace(mlxsw_sp,\n\t\t\t\t\t\t\t\taregion, aentry,\n\t\t\t\t\t\t\t\trulei);\n\n\treturn err;\n}\n\nint mlxsw_sp_acl_atcam_init(struct mlxsw_sp *mlxsw_sp,\n\t\t\t    struct mlxsw_sp_acl_atcam *atcam)\n{\n\treturn mlxsw_sp_acl_erps_init(mlxsw_sp, atcam);\n}\n\nvoid mlxsw_sp_acl_atcam_fini(struct mlxsw_sp *mlxsw_sp,\n\t\t\t     struct mlxsw_sp_acl_atcam *atcam)\n{\n\tmlxsw_sp_acl_erps_fini(mlxsw_sp, atcam);\n}\n\nvoid *\nmlxsw_sp_acl_atcam_rehash_hints_get(struct mlxsw_sp_acl_atcam_region *aregion)\n{\n\treturn mlxsw_sp_acl_erp_rehash_hints_get(aregion);\n}\n\nvoid mlxsw_sp_acl_atcam_rehash_hints_put(void *hints_priv)\n{\n\tmlxsw_sp_acl_erp_rehash_hints_put(hints_priv);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}