{
  "module_name": "spectrum1_acl_tcam.c",
  "hash_id": "aa4b4eeb2f1ce70c3a7b87c70730a27efcdfc00102714c79743273d2a2aa83e5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlxsw/spectrum1_acl_tcam.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n\n#include \"reg.h\"\n#include \"core.h\"\n#include \"spectrum.h\"\n#include \"spectrum_acl_tcam.h\"\n\nstruct mlxsw_sp1_acl_tcam_region {\n\tstruct mlxsw_sp_acl_ctcam_region cregion;\n\tstruct mlxsw_sp_acl_tcam_region *region;\n\tstruct {\n\t\tstruct mlxsw_sp_acl_ctcam_chunk cchunk;\n\t\tstruct mlxsw_sp_acl_ctcam_entry centry;\n\t\tstruct mlxsw_sp_acl_rule_info *rulei;\n\t} catchall;\n};\n\nstruct mlxsw_sp1_acl_tcam_chunk {\n\tstruct mlxsw_sp_acl_ctcam_chunk cchunk;\n};\n\nstruct mlxsw_sp1_acl_tcam_entry {\n\tstruct mlxsw_sp_acl_ctcam_entry centry;\n};\n\nstatic int\nmlxsw_sp1_acl_ctcam_region_entry_insert(struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t\tstruct mlxsw_sp_acl_ctcam_entry *centry,\n\t\t\t\t\tconst char *mask)\n{\n\treturn 0;\n}\n\nstatic void\nmlxsw_sp1_acl_ctcam_region_entry_remove(struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t\tstruct mlxsw_sp_acl_ctcam_entry *centry)\n{\n}\n\nstatic const struct mlxsw_sp_acl_ctcam_region_ops\nmlxsw_sp1_acl_ctcam_region_ops = {\n\t.entry_insert = mlxsw_sp1_acl_ctcam_region_entry_insert,\n\t.entry_remove = mlxsw_sp1_acl_ctcam_region_entry_remove,\n};\n\nstatic int mlxsw_sp1_acl_tcam_init(struct mlxsw_sp *mlxsw_sp, void *priv,\n\t\t\t\t   struct mlxsw_sp_acl_tcam *tcam)\n{\n\treturn 0;\n}\n\nstatic void mlxsw_sp1_acl_tcam_fini(struct mlxsw_sp *mlxsw_sp, void *priv)\n{\n}\n\nstatic int\nmlxsw_sp1_acl_ctcam_region_catchall_add(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\tstruct mlxsw_sp1_acl_tcam_region *region)\n{\n\tstruct mlxsw_sp_acl_rule_info *rulei;\n\tint err;\n\n\tmlxsw_sp_acl_ctcam_chunk_init(&region->cregion,\n\t\t\t\t      &region->catchall.cchunk,\n\t\t\t\t      MLXSW_SP_ACL_TCAM_CATCHALL_PRIO);\n\trulei = mlxsw_sp_acl_rulei_create(mlxsw_sp->acl, NULL);\n\tif (IS_ERR(rulei)) {\n\t\terr = PTR_ERR(rulei);\n\t\tgoto err_rulei_create;\n\t}\n\terr = mlxsw_sp_acl_rulei_act_continue(rulei);\n\tif (WARN_ON(err))\n\t\tgoto err_rulei_act_continue;\n\terr = mlxsw_sp_acl_rulei_commit(rulei);\n\tif (err)\n\t\tgoto err_rulei_commit;\n\terr = mlxsw_sp_acl_ctcam_entry_add(mlxsw_sp, &region->cregion,\n\t\t\t\t\t   &region->catchall.cchunk,\n\t\t\t\t\t   &region->catchall.centry,\n\t\t\t\t\t   rulei, false);\n\tif (err)\n\t\tgoto err_entry_add;\n\tregion->catchall.rulei = rulei;\n\treturn 0;\n\nerr_entry_add:\nerr_rulei_commit:\nerr_rulei_act_continue:\n\tmlxsw_sp_acl_rulei_destroy(mlxsw_sp, rulei);\nerr_rulei_create:\n\tmlxsw_sp_acl_ctcam_chunk_fini(&region->catchall.cchunk);\n\treturn err;\n}\n\nstatic void\nmlxsw_sp1_acl_ctcam_region_catchall_del(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\tstruct mlxsw_sp1_acl_tcam_region *region)\n{\n\tstruct mlxsw_sp_acl_rule_info *rulei = region->catchall.rulei;\n\n\tmlxsw_sp_acl_ctcam_entry_del(mlxsw_sp, &region->cregion,\n\t\t\t\t     &region->catchall.cchunk,\n\t\t\t\t     &region->catchall.centry);\n\tmlxsw_sp_acl_rulei_destroy(mlxsw_sp, rulei);\n\tmlxsw_sp_acl_ctcam_chunk_fini(&region->catchall.cchunk);\n}\n\nstatic int\nmlxsw_sp1_acl_tcam_region_init(struct mlxsw_sp *mlxsw_sp, void *region_priv,\n\t\t\t       void *tcam_priv,\n\t\t\t       struct mlxsw_sp_acl_tcam_region *_region,\n\t\t\t       void *hints_priv)\n{\n\tstruct mlxsw_sp1_acl_tcam_region *region = region_priv;\n\tint err;\n\n\terr = mlxsw_sp_acl_ctcam_region_init(mlxsw_sp, &region->cregion,\n\t\t\t\t\t     _region,\n\t\t\t\t\t     &mlxsw_sp1_acl_ctcam_region_ops);\n\tif (err)\n\t\treturn err;\n\terr = mlxsw_sp1_acl_ctcam_region_catchall_add(mlxsw_sp, region);\n\tif (err)\n\t\tgoto err_catchall_add;\n\tregion->region = _region;\n\treturn 0;\n\nerr_catchall_add:\n\tmlxsw_sp_acl_ctcam_region_fini(&region->cregion);\n\treturn err;\n}\n\nstatic void\nmlxsw_sp1_acl_tcam_region_fini(struct mlxsw_sp *mlxsw_sp, void *region_priv)\n{\n\tstruct mlxsw_sp1_acl_tcam_region *region = region_priv;\n\n\tmlxsw_sp1_acl_ctcam_region_catchall_del(mlxsw_sp, region);\n\tmlxsw_sp_acl_ctcam_region_fini(&region->cregion);\n}\n\nstatic int\nmlxsw_sp1_acl_tcam_region_associate(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t    struct mlxsw_sp_acl_tcam_region *region)\n{\n\treturn 0;\n}\n\nstatic void mlxsw_sp1_acl_tcam_chunk_init(void *region_priv, void *chunk_priv,\n\t\t\t\t\t  unsigned int priority)\n{\n\tstruct mlxsw_sp1_acl_tcam_region *region = region_priv;\n\tstruct mlxsw_sp1_acl_tcam_chunk *chunk = chunk_priv;\n\n\tmlxsw_sp_acl_ctcam_chunk_init(&region->cregion, &chunk->cchunk,\n\t\t\t\t      priority);\n}\n\nstatic void mlxsw_sp1_acl_tcam_chunk_fini(void *chunk_priv)\n{\n\tstruct mlxsw_sp1_acl_tcam_chunk *chunk = chunk_priv;\n\n\tmlxsw_sp_acl_ctcam_chunk_fini(&chunk->cchunk);\n}\n\nstatic int mlxsw_sp1_acl_tcam_entry_add(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\tvoid *region_priv, void *chunk_priv,\n\t\t\t\t\tvoid *entry_priv,\n\t\t\t\t\tstruct mlxsw_sp_acl_rule_info *rulei)\n{\n\tstruct mlxsw_sp1_acl_tcam_region *region = region_priv;\n\tstruct mlxsw_sp1_acl_tcam_chunk *chunk = chunk_priv;\n\tstruct mlxsw_sp1_acl_tcam_entry *entry = entry_priv;\n\n\treturn mlxsw_sp_acl_ctcam_entry_add(mlxsw_sp, &region->cregion,\n\t\t\t\t\t    &chunk->cchunk, &entry->centry,\n\t\t\t\t\t    rulei, false);\n}\n\nstatic void mlxsw_sp1_acl_tcam_entry_del(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\t void *region_priv, void *chunk_priv,\n\t\t\t\t\t void *entry_priv)\n{\n\tstruct mlxsw_sp1_acl_tcam_region *region = region_priv;\n\tstruct mlxsw_sp1_acl_tcam_chunk *chunk = chunk_priv;\n\tstruct mlxsw_sp1_acl_tcam_entry *entry = entry_priv;\n\n\tmlxsw_sp_acl_ctcam_entry_del(mlxsw_sp, &region->cregion,\n\t\t\t\t     &chunk->cchunk, &entry->centry);\n}\n\nstatic int\nmlxsw_sp1_acl_tcam_entry_action_replace(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\tvoid *region_priv, void *entry_priv,\n\t\t\t\t\tstruct mlxsw_sp_acl_rule_info *rulei)\n{\n\treturn -EOPNOTSUPP;\n}\n\nstatic int\nmlxsw_sp1_acl_tcam_region_entry_activity_get(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\t     struct mlxsw_sp_acl_tcam_region *_region,\n\t\t\t\t\t     unsigned int offset,\n\t\t\t\t\t     bool *activity)\n{\n\tchar ptce2_pl[MLXSW_REG_PTCE2_LEN];\n\tint err;\n\n\tmlxsw_reg_ptce2_pack(ptce2_pl, true, MLXSW_REG_PTCE2_OP_QUERY_CLEAR_ON_READ,\n\t\t\t     _region->tcam_region_info, offset, 0);\n\terr = mlxsw_reg_query(mlxsw_sp->core, MLXSW_REG(ptce2), ptce2_pl);\n\tif (err)\n\t\treturn err;\n\t*activity = mlxsw_reg_ptce2_a_get(ptce2_pl);\n\treturn 0;\n}\n\nstatic int\nmlxsw_sp1_acl_tcam_entry_activity_get(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t      void *region_priv, void *entry_priv,\n\t\t\t\t      bool *activity)\n{\n\tstruct mlxsw_sp1_acl_tcam_region *region = region_priv;\n\tstruct mlxsw_sp1_acl_tcam_entry *entry = entry_priv;\n\tunsigned int offset;\n\n\toffset = mlxsw_sp_acl_ctcam_entry_offset(&entry->centry);\n\treturn mlxsw_sp1_acl_tcam_region_entry_activity_get(mlxsw_sp,\n\t\t\t\t\t\t\t    region->region,\n\t\t\t\t\t\t\t    offset, activity);\n}\n\nconst struct mlxsw_sp_acl_tcam_ops mlxsw_sp1_acl_tcam_ops = {\n\t.key_type\t\t= MLXSW_REG_PTAR_KEY_TYPE_FLEX,\n\t.priv_size\t\t= 0,\n\t.init\t\t\t= mlxsw_sp1_acl_tcam_init,\n\t.fini\t\t\t= mlxsw_sp1_acl_tcam_fini,\n\t.region_priv_size\t= sizeof(struct mlxsw_sp1_acl_tcam_region),\n\t.region_init\t\t= mlxsw_sp1_acl_tcam_region_init,\n\t.region_fini\t\t= mlxsw_sp1_acl_tcam_region_fini,\n\t.region_associate\t= mlxsw_sp1_acl_tcam_region_associate,\n\t.chunk_priv_size\t= sizeof(struct mlxsw_sp1_acl_tcam_chunk),\n\t.chunk_init\t\t= mlxsw_sp1_acl_tcam_chunk_init,\n\t.chunk_fini\t\t= mlxsw_sp1_acl_tcam_chunk_fini,\n\t.entry_priv_size\t= sizeof(struct mlxsw_sp1_acl_tcam_entry),\n\t.entry_add\t\t= mlxsw_sp1_acl_tcam_entry_add,\n\t.entry_del\t\t= mlxsw_sp1_acl_tcam_entry_del,\n\t.entry_action_replace\t= mlxsw_sp1_acl_tcam_entry_action_replace,\n\t.entry_activity_get\t= mlxsw_sp1_acl_tcam_entry_activity_get,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}