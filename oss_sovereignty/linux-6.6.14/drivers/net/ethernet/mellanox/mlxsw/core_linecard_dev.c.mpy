{
  "module_name": "core_linecard_dev.c",
  "hash_id": "0ab3a8369d0cb79bc21ea746a74f1df77d85e71d491aa68243cdadfee98c0469",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlxsw/core_linecard_dev.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/err.h>\n#include <linux/types.h>\n#include <linux/auxiliary_bus.h>\n#include <linux/idr.h>\n#include <linux/gfp.h>\n#include <linux/slab.h>\n#include <net/devlink.h>\n#include \"core.h\"\n\n#define MLXSW_LINECARD_DEV_ID_NAME \"lc\"\n\nstruct mlxsw_linecard_dev {\n\tstruct mlxsw_linecard *linecard;\n};\n\nstruct mlxsw_linecard_bdev {\n\tstruct auxiliary_device adev;\n\tstruct mlxsw_linecard *linecard;\n\tstruct mlxsw_linecard_dev *linecard_dev;\n};\n\nstatic DEFINE_IDA(mlxsw_linecard_bdev_ida);\n\nstatic int mlxsw_linecard_bdev_id_alloc(void)\n{\n\treturn ida_alloc(&mlxsw_linecard_bdev_ida, GFP_KERNEL);\n}\n\nstatic void mlxsw_linecard_bdev_id_free(int id)\n{\n\tida_free(&mlxsw_linecard_bdev_ida, id);\n}\n\nstatic void mlxsw_linecard_bdev_release(struct device *device)\n{\n\tstruct auxiliary_device *adev =\n\t\t\tcontainer_of(device, struct auxiliary_device, dev);\n\tstruct mlxsw_linecard_bdev *linecard_bdev =\n\t\t\tcontainer_of(adev, struct mlxsw_linecard_bdev, adev);\n\n\tmlxsw_linecard_bdev_id_free(adev->id);\n\tkfree(linecard_bdev);\n}\n\nint mlxsw_linecard_bdev_add(struct mlxsw_linecard *linecard)\n{\n\tstruct mlxsw_linecard_bdev *linecard_bdev;\n\tint err;\n\tint id;\n\n\tid = mlxsw_linecard_bdev_id_alloc();\n\tif (id < 0)\n\t\treturn id;\n\n\tlinecard_bdev = kzalloc(sizeof(*linecard_bdev), GFP_KERNEL);\n\tif (!linecard_bdev) {\n\t\tmlxsw_linecard_bdev_id_free(id);\n\t\treturn -ENOMEM;\n\t}\n\tlinecard_bdev->adev.id = id;\n\tlinecard_bdev->adev.name = MLXSW_LINECARD_DEV_ID_NAME;\n\tlinecard_bdev->adev.dev.release = mlxsw_linecard_bdev_release;\n\tlinecard_bdev->adev.dev.parent = linecard->linecards->bus_info->dev;\n\tlinecard_bdev->linecard = linecard;\n\n\terr = auxiliary_device_init(&linecard_bdev->adev);\n\tif (err) {\n\t\tmlxsw_linecard_bdev_id_free(id);\n\t\tkfree(linecard_bdev);\n\t\treturn err;\n\t}\n\n\terr = auxiliary_device_add(&linecard_bdev->adev);\n\tif (err) {\n\t\tauxiliary_device_uninit(&linecard_bdev->adev);\n\t\treturn err;\n\t}\n\n\tlinecard->bdev = linecard_bdev;\n\treturn 0;\n}\n\nvoid mlxsw_linecard_bdev_del(struct mlxsw_linecard *linecard)\n{\n\tstruct mlxsw_linecard_bdev *linecard_bdev = linecard->bdev;\n\n\tif (!linecard_bdev)\n\t\t \n\t\treturn;\n\tauxiliary_device_delete(&linecard_bdev->adev);\n\tauxiliary_device_uninit(&linecard_bdev->adev);\n\tlinecard->bdev = NULL;\n}\n\nstatic int mlxsw_linecard_dev_devlink_info_get(struct devlink *devlink,\n\t\t\t\t\t       struct devlink_info_req *req,\n\t\t\t\t\t       struct netlink_ext_ack *extack)\n{\n\tstruct mlxsw_linecard_dev *linecard_dev = devlink_priv(devlink);\n\tstruct mlxsw_linecard *linecard = linecard_dev->linecard;\n\n\treturn mlxsw_linecard_devlink_info_get(linecard, req, extack);\n}\n\nstatic int\nmlxsw_linecard_dev_devlink_flash_update(struct devlink *devlink,\n\t\t\t\t\tstruct devlink_flash_update_params *params,\n\t\t\t\t\tstruct netlink_ext_ack *extack)\n{\n\tstruct mlxsw_linecard_dev *linecard_dev = devlink_priv(devlink);\n\tstruct mlxsw_linecard *linecard = linecard_dev->linecard;\n\n\treturn mlxsw_linecard_flash_update(devlink, linecard,\n\t\t\t\t\t   params->fw, extack);\n}\n\nstatic const struct devlink_ops mlxsw_linecard_dev_devlink_ops = {\n\t.info_get\t\t\t= mlxsw_linecard_dev_devlink_info_get,\n\t.flash_update\t\t\t= mlxsw_linecard_dev_devlink_flash_update,\n};\n\nstatic int mlxsw_linecard_bdev_probe(struct auxiliary_device *adev,\n\t\t\t\t     const struct auxiliary_device_id *id)\n{\n\tstruct mlxsw_linecard_bdev *linecard_bdev =\n\t\t\tcontainer_of(adev, struct mlxsw_linecard_bdev, adev);\n\tstruct mlxsw_linecard *linecard = linecard_bdev->linecard;\n\tstruct mlxsw_linecard_dev *linecard_dev;\n\tstruct devlink *devlink;\n\n\tdevlink = devlink_alloc(&mlxsw_linecard_dev_devlink_ops,\n\t\t\t\tsizeof(*linecard_dev), &adev->dev);\n\tif (!devlink)\n\t\treturn -ENOMEM;\n\tlinecard_dev = devlink_priv(devlink);\n\tlinecard_dev->linecard = linecard_bdev->linecard;\n\tlinecard_bdev->linecard_dev = linecard_dev;\n\n\tdevlink_register(devlink);\n\tdevlink_linecard_nested_dl_set(linecard->devlink_linecard, devlink);\n\treturn 0;\n}\n\nstatic void mlxsw_linecard_bdev_remove(struct auxiliary_device *adev)\n{\n\tstruct mlxsw_linecard_bdev *linecard_bdev =\n\t\t\tcontainer_of(adev, struct mlxsw_linecard_bdev, adev);\n\tstruct devlink *devlink = priv_to_devlink(linecard_bdev->linecard_dev);\n\tstruct mlxsw_linecard *linecard = linecard_bdev->linecard;\n\n\tdevlink_linecard_nested_dl_set(linecard->devlink_linecard, NULL);\n\tdevlink_unregister(devlink);\n\tdevlink_free(devlink);\n}\n\nstatic const struct auxiliary_device_id mlxsw_linecard_bdev_id_table[] = {\n\t{ .name = KBUILD_MODNAME \".\" MLXSW_LINECARD_DEV_ID_NAME },\n\t{},\n};\n\nMODULE_DEVICE_TABLE(auxiliary, mlxsw_linecard_bdev_id_table);\n\nstatic struct auxiliary_driver mlxsw_linecard_driver = {\n\t.name = MLXSW_LINECARD_DEV_ID_NAME,\n\t.probe = mlxsw_linecard_bdev_probe,\n\t.remove = mlxsw_linecard_bdev_remove,\n\t.id_table = mlxsw_linecard_bdev_id_table,\n};\n\nint mlxsw_linecard_driver_register(void)\n{\n\treturn auxiliary_driver_register(&mlxsw_linecard_driver);\n}\n\nvoid mlxsw_linecard_driver_unregister(void)\n{\n\tauxiliary_driver_unregister(&mlxsw_linecard_driver);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}