{
  "module_name": "core_hwmon.c",
  "hash_id": "410349c89f018c229f2367601b3f57a927917513fadc9893c22891354cd6cdc6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlxsw/core_hwmon.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/device.h>\n#include <linux/sysfs.h>\n#include <linux/hwmon.h>\n#include <linux/err.h>\n#include <linux/sfp.h>\n\n#include \"core.h\"\n#include \"core_env.h\"\n\n#define MLXSW_HWMON_SENSORS_MAX_COUNT 64\n#define MLXSW_HWMON_MODULES_MAX_COUNT 64\n#define MLXSW_HWMON_GEARBOXES_MAX_COUNT 32\n\n#define MLXSW_HWMON_ATTR_PER_SENSOR 3\n#define MLXSW_HWMON_ATTR_PER_MODULE 7\n#define MLXSW_HWMON_ATTR_PER_GEARBOX 4\n#define MLXSW_HWMON_DEV_NAME_LEN_MAX 16\n\n#define MLXSW_HWMON_ATTR_COUNT (MLXSW_HWMON_SENSORS_MAX_COUNT * MLXSW_HWMON_ATTR_PER_SENSOR + \\\n\t\t\t\tMLXSW_HWMON_MODULES_MAX_COUNT * MLXSW_HWMON_ATTR_PER_MODULE + \\\n\t\t\t\tMLXSW_HWMON_GEARBOXES_MAX_COUNT * MLXSW_HWMON_ATTR_PER_GEARBOX + \\\n\t\t\t\tMLXSW_MFCR_TACHOS_MAX + MLXSW_MFCR_PWMS_MAX)\n\nstruct mlxsw_hwmon_attr {\n\tstruct device_attribute dev_attr;\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev;\n\tunsigned int type_index;\n\tchar name[32];\n};\n\nstatic int mlxsw_hwmon_get_attr_index(int index, int count)\n{\n\tif (index >= count)\n\t\treturn index % count + MLXSW_REG_MTMP_GBOX_INDEX_MIN;\n\n\treturn index;\n}\n\nstruct mlxsw_hwmon_dev {\n\tchar name[MLXSW_HWMON_DEV_NAME_LEN_MAX];\n\tstruct mlxsw_hwmon *hwmon;\n\tstruct device *hwmon_dev;\n\tstruct attribute_group group;\n\tconst struct attribute_group *groups[2];\n\tstruct attribute *attrs[MLXSW_HWMON_ATTR_COUNT + 1];\n\tstruct mlxsw_hwmon_attr hwmon_attrs[MLXSW_HWMON_ATTR_COUNT];\n\tunsigned int attrs_count;\n\tu8 sensor_count;\n\tu8 module_sensor_max;\n\tu8 slot_index;\n\tbool active;\n};\n\nstruct mlxsw_hwmon {\n\tstruct mlxsw_core *core;\n\tconst struct mlxsw_bus_info *bus_info;\n\tstruct mlxsw_hwmon_dev line_cards[];\n};\n\nstatic ssize_t mlxsw_hwmon_temp_show(struct device *dev,\n\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t     char *buf)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mtmp_pl[MLXSW_REG_MTMP_LEN];\n\tint temp, index;\n\tint err;\n\n\tindex = mlxsw_hwmon_get_attr_index(mlxsw_hwmon_attr->type_index,\n\t\t\t\t\t   mlxsw_hwmon_dev->module_sensor_max);\n\tmlxsw_reg_mtmp_pack(mtmp_pl, mlxsw_hwmon_dev->slot_index, index, false,\n\t\t\t    false);\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mtmp), mtmp_pl);\n\tif (err) {\n\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to query temp sensor\\n\");\n\t\treturn err;\n\t}\n\tmlxsw_reg_mtmp_unpack(mtmp_pl, &temp, NULL, NULL, NULL, NULL);\n\treturn sprintf(buf, \"%d\\n\", temp);\n}\n\nstatic ssize_t mlxsw_hwmon_temp_max_show(struct device *dev,\n\t\t\t\t\t struct device_attribute *attr,\n\t\t\t\t\t char *buf)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mtmp_pl[MLXSW_REG_MTMP_LEN];\n\tint temp_max, index;\n\tint err;\n\n\tindex = mlxsw_hwmon_get_attr_index(mlxsw_hwmon_attr->type_index,\n\t\t\t\t\t   mlxsw_hwmon_dev->module_sensor_max);\n\tmlxsw_reg_mtmp_pack(mtmp_pl, mlxsw_hwmon_dev->slot_index, index, false,\n\t\t\t    false);\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mtmp), mtmp_pl);\n\tif (err) {\n\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to query temp sensor\\n\");\n\t\treturn err;\n\t}\n\tmlxsw_reg_mtmp_unpack(mtmp_pl, NULL, &temp_max, NULL, NULL, NULL);\n\treturn sprintf(buf, \"%d\\n\", temp_max);\n}\n\nstatic ssize_t mlxsw_hwmon_temp_rst_store(struct device *dev,\n\t\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t\t  const char *buf, size_t len)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mtmp_pl[MLXSW_REG_MTMP_LEN];\n\tunsigned long val;\n\tint index;\n\tint err;\n\n\terr = kstrtoul(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\tif (val != 1)\n\t\treturn -EINVAL;\n\n\tindex = mlxsw_hwmon_get_attr_index(mlxsw_hwmon_attr->type_index,\n\t\t\t\t\t   mlxsw_hwmon_dev->module_sensor_max);\n\n\tmlxsw_reg_mtmp_slot_index_set(mtmp_pl, mlxsw_hwmon_dev->slot_index);\n\tmlxsw_reg_mtmp_sensor_index_set(mtmp_pl, index);\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mtmp), mtmp_pl);\n\tif (err)\n\t\treturn err;\n\tmlxsw_reg_mtmp_mte_set(mtmp_pl, true);\n\tmlxsw_reg_mtmp_mtr_set(mtmp_pl, true);\n\terr = mlxsw_reg_write(mlxsw_hwmon->core, MLXSW_REG(mtmp), mtmp_pl);\n\tif (err) {\n\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to reset temp sensor history\\n\");\n\t\treturn err;\n\t}\n\treturn len;\n}\n\nstatic ssize_t mlxsw_hwmon_fan_rpm_show(struct device *dev,\n\t\t\t\t\tstruct device_attribute *attr,\n\t\t\t\t\tchar *buf)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mfsm_pl[MLXSW_REG_MFSM_LEN];\n\tint err;\n\n\tmlxsw_reg_mfsm_pack(mfsm_pl, mlxsw_hwmon_attr->type_index);\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mfsm), mfsm_pl);\n\tif (err) {\n\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to query fan\\n\");\n\t\treturn err;\n\t}\n\treturn sprintf(buf, \"%u\\n\", mlxsw_reg_mfsm_rpm_get(mfsm_pl));\n}\n\nstatic ssize_t mlxsw_hwmon_fan_fault_show(struct device *dev,\n\t\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t\t  char *buf)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar fore_pl[MLXSW_REG_FORE_LEN];\n\tbool fault;\n\tint err;\n\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(fore), fore_pl);\n\tif (err) {\n\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to query fan\\n\");\n\t\treturn err;\n\t}\n\tmlxsw_reg_fore_unpack(fore_pl, mlxsw_hwmon_attr->type_index, &fault);\n\n\treturn sprintf(buf, \"%u\\n\", fault);\n}\n\nstatic ssize_t mlxsw_hwmon_pwm_show(struct device *dev,\n\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t    char *buf)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mfsc_pl[MLXSW_REG_MFSC_LEN];\n\tint err;\n\n\tmlxsw_reg_mfsc_pack(mfsc_pl, mlxsw_hwmon_attr->type_index, 0);\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mfsc), mfsc_pl);\n\tif (err) {\n\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to query PWM\\n\");\n\t\treturn err;\n\t}\n\treturn sprintf(buf, \"%u\\n\",\n\t\t       mlxsw_reg_mfsc_pwm_duty_cycle_get(mfsc_pl));\n}\n\nstatic ssize_t mlxsw_hwmon_pwm_store(struct device *dev,\n\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t     const char *buf, size_t len)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mfsc_pl[MLXSW_REG_MFSC_LEN];\n\tunsigned long val;\n\tint err;\n\n\terr = kstrtoul(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\tif (val > 255)\n\t\treturn -EINVAL;\n\n\tmlxsw_reg_mfsc_pack(mfsc_pl, mlxsw_hwmon_attr->type_index, val);\n\terr = mlxsw_reg_write(mlxsw_hwmon->core, MLXSW_REG(mfsc), mfsc_pl);\n\tif (err) {\n\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to write PWM\\n\");\n\t\treturn err;\n\t}\n\treturn len;\n}\n\nstatic int mlxsw_hwmon_module_temp_get(struct device *dev,\n\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t       int *p_temp)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mtmp_pl[MLXSW_REG_MTMP_LEN];\n\tu8 module;\n\tint err;\n\n\tmodule = mlxsw_hwmon_attr->type_index - mlxsw_hwmon_dev->sensor_count;\n\tmlxsw_reg_mtmp_pack(mtmp_pl, mlxsw_hwmon_dev->slot_index,\n\t\t\t    MLXSW_REG_MTMP_MODULE_INDEX_MIN + module, false,\n\t\t\t    false);\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mtmp), mtmp_pl);\n\tif (err) {\n\t\tdev_err(dev, \"Failed to query module temperature\\n\");\n\t\treturn err;\n\t}\n\tmlxsw_reg_mtmp_unpack(mtmp_pl, p_temp, NULL, NULL, NULL, NULL);\n\n\treturn 0;\n}\n\nstatic ssize_t mlxsw_hwmon_module_temp_show(struct device *dev,\n\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t    char *buf)\n{\n\tint err, temp;\n\n\terr = mlxsw_hwmon_module_temp_get(dev, attr, &temp);\n\tif (err)\n\t\treturn err;\n\n\treturn sprintf(buf, \"%d\\n\", temp);\n}\n\nstatic ssize_t mlxsw_hwmon_module_temp_fault_show(struct device *dev,\n\t\t\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t\t\t  char *buf)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mtbr_pl[MLXSW_REG_MTBR_LEN] = {0};\n\tu8 module, fault;\n\tu16 temp;\n\tint err;\n\n\tmodule = mlxsw_hwmon_attr->type_index - mlxsw_hwmon_dev->sensor_count;\n\tmlxsw_reg_mtbr_pack(mtbr_pl, mlxsw_hwmon_dev->slot_index,\n\t\t\t    MLXSW_REG_MTBR_BASE_MODULE_INDEX + module, 1);\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mtbr), mtbr_pl);\n\tif (err) {\n\t\tdev_err(dev, \"Failed to query module temperature sensor\\n\");\n\t\treturn err;\n\t}\n\n\tmlxsw_reg_mtbr_temp_unpack(mtbr_pl, 0, &temp, NULL);\n\n\t \n\tswitch (temp) {\n\tcase MLXSW_REG_MTBR_BAD_SENS_INFO:\n\t\t \n\t\tfault = 1;\n\t\tbreak;\n\tcase MLXSW_REG_MTBR_NO_CONN:\n\tcase MLXSW_REG_MTBR_NO_TEMP_SENS:\n\tcase MLXSW_REG_MTBR_INDEX_NA:\n\tdefault:\n\t\tfault = 0;\n\t\tbreak;\n\t}\n\n\treturn sprintf(buf, \"%u\\n\", fault);\n}\n\nstatic int mlxsw_hwmon_module_temp_critical_get(struct device *dev,\n\t\t\t\t\t\tstruct device_attribute *attr,\n\t\t\t\t\t\tint *p_temp)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tu8 module;\n\tint err;\n\n\tmodule = mlxsw_hwmon_attr->type_index - mlxsw_hwmon_dev->sensor_count;\n\terr = mlxsw_env_module_temp_thresholds_get(mlxsw_hwmon->core,\n\t\t\t\t\t\t   mlxsw_hwmon_dev->slot_index,\n\t\t\t\t\t\t   module, SFP_TEMP_HIGH_WARN,\n\t\t\t\t\t\t   p_temp);\n\tif (err) {\n\t\tdev_err(dev, \"Failed to query module temperature thresholds\\n\");\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic ssize_t\nmlxsw_hwmon_module_temp_critical_show(struct device *dev,\n\t\t\t\t      struct device_attribute *attr, char *buf)\n{\n\tint err, temp;\n\n\terr = mlxsw_hwmon_module_temp_critical_get(dev, attr, &temp);\n\tif (err)\n\t\treturn err;\n\n\treturn sprintf(buf, \"%u\\n\", temp);\n}\n\nstatic int mlxsw_hwmon_module_temp_emergency_get(struct device *dev,\n\t\t\t\t\t\t struct device_attribute *attr,\n\t\t\t\t\t\t int *p_temp)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tu8 module;\n\tint err;\n\n\tmodule = mlxsw_hwmon_attr->type_index - mlxsw_hwmon_dev->sensor_count;\n\terr = mlxsw_env_module_temp_thresholds_get(mlxsw_hwmon->core,\n\t\t\t\t\t\t   mlxsw_hwmon_dev->slot_index,\n\t\t\t\t\t\t   module, SFP_TEMP_HIGH_ALARM,\n\t\t\t\t\t\t   p_temp);\n\tif (err) {\n\t\tdev_err(dev, \"Failed to query module temperature thresholds\\n\");\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic ssize_t\nmlxsw_hwmon_module_temp_emergency_show(struct device *dev,\n\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t       char *buf)\n{\n\tint err, temp;\n\n\terr = mlxsw_hwmon_module_temp_emergency_get(dev, attr, &temp);\n\tif (err)\n\t\treturn err;\n\n\treturn sprintf(buf, \"%u\\n\", temp);\n}\n\nstatic ssize_t\nmlxsw_hwmon_module_temp_label_show(struct device *dev,\n\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t   char *buf)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\n\treturn sprintf(buf, \"front panel %03u\\n\",\n\t\t       mlxsw_hwmon_attr->type_index + 1 -\n\t\t       mlxsw_hwmon_attr->mlxsw_hwmon_dev->sensor_count);\n}\n\nstatic ssize_t\nmlxsw_hwmon_gbox_temp_label_show(struct device *dev,\n\t\t\t\t struct device_attribute *attr,\n\t\t\t\t char *buf)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr =\n\t\t\tcontainer_of(attr, struct mlxsw_hwmon_attr, dev_attr);\n\tstruct mlxsw_hwmon_dev *mlxsw_hwmon_dev = mlxsw_hwmon_attr->mlxsw_hwmon_dev;\n\tint index = mlxsw_hwmon_attr->type_index -\n\t\t    mlxsw_hwmon_dev->module_sensor_max + 1;\n\n\treturn sprintf(buf, \"gearbox %03u\\n\", index);\n}\n\nstatic ssize_t mlxsw_hwmon_temp_critical_alarm_show(struct device *dev,\n\t\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t\t    char *buf)\n{\n\tint err, temp, emergency_temp, critic_temp;\n\n\terr = mlxsw_hwmon_module_temp_get(dev, attr, &temp);\n\tif (err)\n\t\treturn err;\n\n\tif (temp <= 0)\n\t\treturn sprintf(buf, \"%d\\n\", false);\n\n\terr = mlxsw_hwmon_module_temp_emergency_get(dev, attr, &emergency_temp);\n\tif (err)\n\t\treturn err;\n\n\tif (temp >= emergency_temp)\n\t\treturn sprintf(buf, \"%d\\n\", false);\n\n\terr = mlxsw_hwmon_module_temp_critical_get(dev, attr, &critic_temp);\n\tif (err)\n\t\treturn err;\n\n\treturn sprintf(buf, \"%d\\n\", temp >= critic_temp);\n}\n\nstatic ssize_t mlxsw_hwmon_temp_emergency_alarm_show(struct device *dev,\n\t\t\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t\t\t     char *buf)\n{\n\tint err, temp, emergency_temp;\n\n\terr = mlxsw_hwmon_module_temp_get(dev, attr, &temp);\n\tif (err)\n\t\treturn err;\n\n\tif (temp <= 0)\n\t\treturn sprintf(buf, \"%d\\n\", false);\n\n\terr = mlxsw_hwmon_module_temp_emergency_get(dev, attr, &emergency_temp);\n\tif (err)\n\t\treturn err;\n\n\treturn sprintf(buf, \"%d\\n\", temp >= emergency_temp);\n}\n\nenum mlxsw_hwmon_attr_type {\n\tMLXSW_HWMON_ATTR_TYPE_TEMP,\n\tMLXSW_HWMON_ATTR_TYPE_TEMP_MAX,\n\tMLXSW_HWMON_ATTR_TYPE_TEMP_RST,\n\tMLXSW_HWMON_ATTR_TYPE_FAN_RPM,\n\tMLXSW_HWMON_ATTR_TYPE_FAN_FAULT,\n\tMLXSW_HWMON_ATTR_TYPE_PWM,\n\tMLXSW_HWMON_ATTR_TYPE_TEMP_MODULE,\n\tMLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_FAULT,\n\tMLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_CRIT,\n\tMLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_EMERG,\n\tMLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_LABEL,\n\tMLXSW_HWMON_ATTR_TYPE_TEMP_GBOX_LABEL,\n\tMLXSW_HWMON_ATTR_TYPE_TEMP_CRIT_ALARM,\n\tMLXSW_HWMON_ATTR_TYPE_TEMP_EMERGENCY_ALARM,\n};\n\nstatic void mlxsw_hwmon_attr_add(struct mlxsw_hwmon_dev *mlxsw_hwmon_dev,\n\t\t\t\t enum mlxsw_hwmon_attr_type attr_type,\n\t\t\t\t unsigned int type_index, unsigned int num)\n{\n\tstruct mlxsw_hwmon_attr *mlxsw_hwmon_attr;\n\tunsigned int attr_index;\n\n\tattr_index = mlxsw_hwmon_dev->attrs_count;\n\tmlxsw_hwmon_attr = &mlxsw_hwmon_dev->hwmon_attrs[attr_index];\n\n\tswitch (attr_type) {\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP:\n\t\tmlxsw_hwmon_attr->dev_attr.show = mlxsw_hwmon_temp_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_input\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP_MAX:\n\t\tmlxsw_hwmon_attr->dev_attr.show = mlxsw_hwmon_temp_max_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_highest\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP_RST:\n\t\tmlxsw_hwmon_attr->dev_attr.store = mlxsw_hwmon_temp_rst_store;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0200;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_reset_history\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_FAN_RPM:\n\t\tmlxsw_hwmon_attr->dev_attr.show = mlxsw_hwmon_fan_rpm_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"fan%u_input\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_FAN_FAULT:\n\t\tmlxsw_hwmon_attr->dev_attr.show = mlxsw_hwmon_fan_fault_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"fan%u_fault\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_PWM:\n\t\tmlxsw_hwmon_attr->dev_attr.show = mlxsw_hwmon_pwm_show;\n\t\tmlxsw_hwmon_attr->dev_attr.store = mlxsw_hwmon_pwm_store;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0644;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"pwm%u\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP_MODULE:\n\t\tmlxsw_hwmon_attr->dev_attr.show = mlxsw_hwmon_module_temp_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_input\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_FAULT:\n\t\tmlxsw_hwmon_attr->dev_attr.show =\n\t\t\t\t\tmlxsw_hwmon_module_temp_fault_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_fault\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_CRIT:\n\t\tmlxsw_hwmon_attr->dev_attr.show =\n\t\t\tmlxsw_hwmon_module_temp_critical_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_crit\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_EMERG:\n\t\tmlxsw_hwmon_attr->dev_attr.show =\n\t\t\tmlxsw_hwmon_module_temp_emergency_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_emergency\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_LABEL:\n\t\tmlxsw_hwmon_attr->dev_attr.show =\n\t\t\tmlxsw_hwmon_module_temp_label_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_label\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP_GBOX_LABEL:\n\t\tmlxsw_hwmon_attr->dev_attr.show =\n\t\t\tmlxsw_hwmon_gbox_temp_label_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_label\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP_CRIT_ALARM:\n\t\tmlxsw_hwmon_attr->dev_attr.show =\n\t\t\tmlxsw_hwmon_temp_critical_alarm_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_crit_alarm\", num + 1);\n\t\tbreak;\n\tcase MLXSW_HWMON_ATTR_TYPE_TEMP_EMERGENCY_ALARM:\n\t\tmlxsw_hwmon_attr->dev_attr.show =\n\t\t\tmlxsw_hwmon_temp_emergency_alarm_show;\n\t\tmlxsw_hwmon_attr->dev_attr.attr.mode = 0444;\n\t\tsnprintf(mlxsw_hwmon_attr->name, sizeof(mlxsw_hwmon_attr->name),\n\t\t\t \"temp%u_emergency_alarm\", num + 1);\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON(1);\n\t}\n\n\tmlxsw_hwmon_attr->type_index = type_index;\n\tmlxsw_hwmon_attr->mlxsw_hwmon_dev = mlxsw_hwmon_dev;\n\tmlxsw_hwmon_attr->dev_attr.attr.name = mlxsw_hwmon_attr->name;\n\tsysfs_attr_init(&mlxsw_hwmon_attr->dev_attr.attr);\n\n\tmlxsw_hwmon_dev->attrs[attr_index] = &mlxsw_hwmon_attr->dev_attr.attr;\n\tmlxsw_hwmon_dev->attrs_count++;\n}\n\nstatic int mlxsw_hwmon_temp_init(struct mlxsw_hwmon_dev *mlxsw_hwmon_dev)\n{\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mtcap_pl[MLXSW_REG_MTCAP_LEN] = {0};\n\tint i;\n\tint err;\n\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mtcap), mtcap_pl);\n\tif (err) {\n\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to get number of temp sensors\\n\");\n\t\treturn err;\n\t}\n\tmlxsw_hwmon_dev->sensor_count = mlxsw_reg_mtcap_sensor_count_get(mtcap_pl);\n\tfor (i = 0; i < mlxsw_hwmon_dev->sensor_count; i++) {\n\t\tchar mtmp_pl[MLXSW_REG_MTMP_LEN] = {0};\n\n\t\tmlxsw_reg_mtmp_slot_index_set(mtmp_pl,\n\t\t\t\t\t      mlxsw_hwmon_dev->slot_index);\n\t\tmlxsw_reg_mtmp_sensor_index_set(mtmp_pl, i);\n\t\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mtmp),\n\t\t\t\t      mtmp_pl);\n\t\tif (err)\n\t\t\treturn err;\n\t\tmlxsw_reg_mtmp_mte_set(mtmp_pl, true);\n\t\tmlxsw_reg_mtmp_mtr_set(mtmp_pl, true);\n\t\terr = mlxsw_reg_write(mlxsw_hwmon->core,\n\t\t\t\t      MLXSW_REG(mtmp), mtmp_pl);\n\t\tif (err) {\n\t\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to setup temp sensor number %d\\n\",\n\t\t\t\ti);\n\t\t\treturn err;\n\t\t}\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP, i, i);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_MAX, i, i);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_RST, i, i);\n\t}\n\treturn 0;\n}\n\nstatic int mlxsw_hwmon_fans_init(struct mlxsw_hwmon_dev *mlxsw_hwmon_dev)\n{\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mfcr_pl[MLXSW_REG_MFCR_LEN] = {0};\n\tenum mlxsw_reg_mfcr_pwm_frequency freq;\n\tunsigned int type_index;\n\tunsigned int num;\n\tu16 tacho_active;\n\tu8 pwm_active;\n\tint err;\n\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mfcr), mfcr_pl);\n\tif (err) {\n\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to get to probe PWMs and Tachometers\\n\");\n\t\treturn err;\n\t}\n\tmlxsw_reg_mfcr_unpack(mfcr_pl, &freq, &tacho_active, &pwm_active);\n\tnum = 0;\n\tfor (type_index = 0; type_index < MLXSW_MFCR_TACHOS_MAX; type_index++) {\n\t\tif (tacho_active & BIT(type_index)) {\n\t\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_FAN_RPM,\n\t\t\t\t\t     type_index, num);\n\t\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_FAN_FAULT,\n\t\t\t\t\t     type_index, num++);\n\t\t}\n\t}\n\tnum = 0;\n\tfor (type_index = 0; type_index < MLXSW_MFCR_PWMS_MAX; type_index++) {\n\t\tif (pwm_active & BIT(type_index))\n\t\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_PWM,\n\t\t\t\t\t     type_index, num++);\n\t}\n\treturn 0;\n}\n\nstatic int mlxsw_hwmon_module_init(struct mlxsw_hwmon_dev *mlxsw_hwmon_dev)\n{\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tchar mgpir_pl[MLXSW_REG_MGPIR_LEN];\n\tu8 module_sensor_max;\n\tint i, err;\n\n\tmlxsw_reg_mgpir_pack(mgpir_pl, mlxsw_hwmon_dev->slot_index);\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mgpir), mgpir_pl);\n\tif (err)\n\t\treturn err;\n\n\tmlxsw_reg_mgpir_unpack(mgpir_pl, NULL, NULL, NULL,\n\t\t\t       &module_sensor_max, NULL);\n\n\t \n\tmlxsw_hwmon_dev->module_sensor_max = mlxsw_hwmon_dev->sensor_count +\n\t\t\t\t\t     module_sensor_max;\n\tfor (i = mlxsw_hwmon_dev->sensor_count;\n\t     i < mlxsw_hwmon_dev->module_sensor_max; i++) {\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_MODULE, i, i);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_FAULT,\n\t\t\t\t     i, i);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_CRIT, i,\n\t\t\t\t     i);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_EMERG,\n\t\t\t\t     i, i);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_MODULE_LABEL,\n\t\t\t\t     i, i);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_CRIT_ALARM,\n\t\t\t\t     i, i);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_EMERGENCY_ALARM,\n\t\t\t\t     i, i);\n\t}\n\n\treturn 0;\n}\n\nstatic int mlxsw_hwmon_gearbox_init(struct mlxsw_hwmon_dev *mlxsw_hwmon_dev)\n{\n\tstruct mlxsw_hwmon *mlxsw_hwmon = mlxsw_hwmon_dev->hwmon;\n\tenum mlxsw_reg_mgpir_device_type device_type;\n\tint index, max_index, sensor_index;\n\tchar mgpir_pl[MLXSW_REG_MGPIR_LEN];\n\tchar mtmp_pl[MLXSW_REG_MTMP_LEN];\n\tu8 gbox_num;\n\tint err;\n\n\tmlxsw_reg_mgpir_pack(mgpir_pl, mlxsw_hwmon_dev->slot_index);\n\terr = mlxsw_reg_query(mlxsw_hwmon->core, MLXSW_REG(mgpir), mgpir_pl);\n\tif (err)\n\t\treturn err;\n\n\tmlxsw_reg_mgpir_unpack(mgpir_pl, &gbox_num, &device_type, NULL, NULL,\n\t\t\t       NULL);\n\tif (device_type != MLXSW_REG_MGPIR_DEVICE_TYPE_GEARBOX_DIE ||\n\t    !gbox_num)\n\t\treturn 0;\n\n\tindex = mlxsw_hwmon_dev->module_sensor_max;\n\tmax_index = mlxsw_hwmon_dev->module_sensor_max + gbox_num;\n\twhile (index < max_index) {\n\t\tsensor_index = index % mlxsw_hwmon_dev->module_sensor_max +\n\t\t\t       MLXSW_REG_MTMP_GBOX_INDEX_MIN;\n\t\tmlxsw_reg_mtmp_pack(mtmp_pl, mlxsw_hwmon_dev->slot_index,\n\t\t\t\t    sensor_index, true, true);\n\t\terr = mlxsw_reg_write(mlxsw_hwmon->core,\n\t\t\t\t      MLXSW_REG(mtmp), mtmp_pl);\n\t\tif (err) {\n\t\t\tdev_err(mlxsw_hwmon->bus_info->dev, \"Failed to setup temp sensor number %d\\n\",\n\t\t\t\tsensor_index);\n\t\t\treturn err;\n\t\t}\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP, index, index);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_MAX, index,\n\t\t\t\t     index);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_RST, index,\n\t\t\t\t     index);\n\t\tmlxsw_hwmon_attr_add(mlxsw_hwmon_dev,\n\t\t\t\t     MLXSW_HWMON_ATTR_TYPE_TEMP_GBOX_LABEL,\n\t\t\t\t     index, index);\n\t\tindex++;\n\t}\n\n\treturn 0;\n}\n\nstatic void\nmlxsw_hwmon_got_active(struct mlxsw_core *mlxsw_core, u8 slot_index,\n\t\t       void *priv)\n{\n\tstruct mlxsw_hwmon *hwmon = priv;\n\tstruct mlxsw_hwmon_dev *linecard;\n\tstruct device *dev;\n\tint err;\n\n\tdev = hwmon->bus_info->dev;\n\tlinecard = &hwmon->line_cards[slot_index];\n\tif (linecard->active)\n\t\treturn;\n\t \n\tlinecard->sensor_count = 1;\n\tlinecard->slot_index = slot_index;\n\tlinecard->hwmon = hwmon;\n\terr = mlxsw_hwmon_module_init(linecard);\n\tif (err) {\n\t\tdev_err(dev, \"Failed to configure hwmon objects for line card modules in slot %d\\n\",\n\t\t\tslot_index);\n\t\treturn;\n\t}\n\n\terr = mlxsw_hwmon_gearbox_init(linecard);\n\tif (err) {\n\t\tdev_err(dev, \"Failed to configure hwmon objects for line card gearboxes in slot %d\\n\",\n\t\t\tslot_index);\n\t\treturn;\n\t}\n\n\tlinecard->groups[0] = &linecard->group;\n\tlinecard->group.attrs = linecard->attrs;\n\tsprintf(linecard->name, \"%s#%02u\", \"linecard\", slot_index);\n\tlinecard->hwmon_dev =\n\t\thwmon_device_register_with_groups(dev, linecard->name,\n\t\t\t\t\t\t  linecard, linecard->groups);\n\tif (IS_ERR(linecard->hwmon_dev)) {\n\t\tdev_err(dev, \"Failed to register hwmon objects for line card in slot %d\\n\",\n\t\t\tslot_index);\n\t\treturn;\n\t}\n\n\tlinecard->active = true;\n}\n\nstatic void\nmlxsw_hwmon_got_inactive(struct mlxsw_core *mlxsw_core, u8 slot_index,\n\t\t\t void *priv)\n{\n\tstruct mlxsw_hwmon *hwmon = priv;\n\tstruct mlxsw_hwmon_dev *linecard;\n\n\tlinecard = &hwmon->line_cards[slot_index];\n\tif (!linecard->active)\n\t\treturn;\n\tlinecard->active = false;\n\thwmon_device_unregister(linecard->hwmon_dev);\n\t \n\tlinecard->attrs_count = 0;\n}\n\nstatic struct mlxsw_linecards_event_ops mlxsw_hwmon_event_ops = {\n\t.got_active = mlxsw_hwmon_got_active,\n\t.got_inactive = mlxsw_hwmon_got_inactive,\n};\n\nint mlxsw_hwmon_init(struct mlxsw_core *mlxsw_core,\n\t\t     const struct mlxsw_bus_info *mlxsw_bus_info,\n\t\t     struct mlxsw_hwmon **p_hwmon)\n{\n\tchar mgpir_pl[MLXSW_REG_MGPIR_LEN];\n\tstruct mlxsw_hwmon *mlxsw_hwmon;\n\tstruct device *hwmon_dev;\n\tu8 num_of_slots;\n\tint err;\n\n\tmlxsw_reg_mgpir_pack(mgpir_pl, 0);\n\terr = mlxsw_reg_query(mlxsw_core, MLXSW_REG(mgpir), mgpir_pl);\n\tif (err)\n\t\treturn err;\n\n\tmlxsw_reg_mgpir_unpack(mgpir_pl, NULL, NULL, NULL, NULL,\n\t\t\t       &num_of_slots);\n\n\tmlxsw_hwmon = kzalloc(struct_size(mlxsw_hwmon, line_cards,\n\t\t\t\t\t  num_of_slots + 1), GFP_KERNEL);\n\tif (!mlxsw_hwmon)\n\t\treturn -ENOMEM;\n\n\tmlxsw_hwmon->core = mlxsw_core;\n\tmlxsw_hwmon->bus_info = mlxsw_bus_info;\n\tmlxsw_hwmon->line_cards[0].hwmon = mlxsw_hwmon;\n\tmlxsw_hwmon->line_cards[0].slot_index = 0;\n\n\terr = mlxsw_hwmon_temp_init(&mlxsw_hwmon->line_cards[0]);\n\tif (err)\n\t\tgoto err_temp_init;\n\n\terr = mlxsw_hwmon_fans_init(&mlxsw_hwmon->line_cards[0]);\n\tif (err)\n\t\tgoto err_fans_init;\n\n\terr = mlxsw_hwmon_module_init(&mlxsw_hwmon->line_cards[0]);\n\tif (err)\n\t\tgoto err_temp_module_init;\n\n\terr = mlxsw_hwmon_gearbox_init(&mlxsw_hwmon->line_cards[0]);\n\tif (err)\n\t\tgoto err_temp_gearbox_init;\n\n\tmlxsw_hwmon->line_cards[0].groups[0] = &mlxsw_hwmon->line_cards[0].group;\n\tmlxsw_hwmon->line_cards[0].group.attrs = mlxsw_hwmon->line_cards[0].attrs;\n\n\thwmon_dev = hwmon_device_register_with_groups(mlxsw_bus_info->dev,\n\t\t\t\t\t\t      \"mlxsw\",\n\t\t\t\t\t\t      &mlxsw_hwmon->line_cards[0],\n\t\t\t\t\t\t      mlxsw_hwmon->line_cards[0].groups);\n\tif (IS_ERR(hwmon_dev)) {\n\t\terr = PTR_ERR(hwmon_dev);\n\t\tgoto err_hwmon_register;\n\t}\n\n\terr = mlxsw_linecards_event_ops_register(mlxsw_hwmon->core,\n\t\t\t\t\t\t &mlxsw_hwmon_event_ops,\n\t\t\t\t\t\t mlxsw_hwmon);\n\tif (err)\n\t\tgoto err_linecards_event_ops_register;\n\n\tmlxsw_hwmon->line_cards[0].hwmon_dev = hwmon_dev;\n\tmlxsw_hwmon->line_cards[0].active = true;\n\t*p_hwmon = mlxsw_hwmon;\n\treturn 0;\n\nerr_linecards_event_ops_register:\n\thwmon_device_unregister(mlxsw_hwmon->line_cards[0].hwmon_dev);\nerr_hwmon_register:\nerr_temp_gearbox_init:\nerr_temp_module_init:\nerr_fans_init:\nerr_temp_init:\n\tkfree(mlxsw_hwmon);\n\treturn err;\n}\n\nvoid mlxsw_hwmon_fini(struct mlxsw_hwmon *mlxsw_hwmon)\n{\n\tmlxsw_hwmon->line_cards[0].active = false;\n\tmlxsw_linecards_event_ops_unregister(mlxsw_hwmon->core,\n\t\t\t\t\t     &mlxsw_hwmon_event_ops, mlxsw_hwmon);\n\thwmon_device_unregister(mlxsw_hwmon->line_cards[0].hwmon_dev);\n\tkfree(mlxsw_hwmon);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}