{
  "module_name": "spectrum2_acl_tcam.c",
  "hash_id": "7e5c87aff2a0681e64ff261b21ba06d244f15661d2f1f81891aa14c4f1e7c241",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlxsw/spectrum2_acl_tcam.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n\n#include \"spectrum.h\"\n#include \"spectrum_acl_tcam.h\"\n#include \"core_acl_flex_actions.h\"\n\nstruct mlxsw_sp2_acl_tcam {\n\tstruct mlxsw_sp_acl_atcam atcam;\n\tu32 kvdl_index;\n\tunsigned int kvdl_count;\n};\n\nstruct mlxsw_sp2_acl_tcam_region {\n\tstruct mlxsw_sp_acl_atcam_region aregion;\n\tstruct mlxsw_sp_acl_tcam_region *region;\n};\n\nstruct mlxsw_sp2_acl_tcam_chunk {\n\tstruct mlxsw_sp_acl_atcam_chunk achunk;\n};\n\nstruct mlxsw_sp2_acl_tcam_entry {\n\tstruct mlxsw_sp_acl_atcam_entry aentry;\n\tstruct mlxsw_afa_block *act_block;\n};\n\nstatic int\nmlxsw_sp2_acl_ctcam_region_entry_insert(struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t\tstruct mlxsw_sp_acl_ctcam_entry *centry,\n\t\t\t\t\tconst char *mask)\n{\n\tstruct mlxsw_sp_acl_atcam_region *aregion;\n\tstruct mlxsw_sp_acl_atcam_entry *aentry;\n\tstruct mlxsw_sp_acl_erp_mask *erp_mask;\n\n\taregion = mlxsw_sp_acl_tcam_cregion_aregion(cregion);\n\taentry = mlxsw_sp_acl_tcam_centry_aentry(centry);\n\n\terp_mask = mlxsw_sp_acl_erp_mask_get(aregion, mask, true);\n\tif (IS_ERR(erp_mask))\n\t\treturn PTR_ERR(erp_mask);\n\taentry->erp_mask = erp_mask;\n\n\treturn 0;\n}\n\nstatic void\nmlxsw_sp2_acl_ctcam_region_entry_remove(struct mlxsw_sp_acl_ctcam_region *cregion,\n\t\t\t\t\tstruct mlxsw_sp_acl_ctcam_entry *centry)\n{\n\tstruct mlxsw_sp_acl_atcam_region *aregion;\n\tstruct mlxsw_sp_acl_atcam_entry *aentry;\n\n\taregion = mlxsw_sp_acl_tcam_cregion_aregion(cregion);\n\taentry = mlxsw_sp_acl_tcam_centry_aentry(centry);\n\n\tmlxsw_sp_acl_erp_mask_put(aregion, aentry->erp_mask);\n}\n\nstatic const struct mlxsw_sp_acl_ctcam_region_ops\nmlxsw_sp2_acl_ctcam_region_ops = {\n\t.entry_insert = mlxsw_sp2_acl_ctcam_region_entry_insert,\n\t.entry_remove = mlxsw_sp2_acl_ctcam_region_entry_remove,\n};\n\nstatic int mlxsw_sp2_acl_tcam_init(struct mlxsw_sp *mlxsw_sp, void *priv,\n\t\t\t\t   struct mlxsw_sp_acl_tcam *_tcam)\n{\n\tstruct mlxsw_sp2_acl_tcam *tcam = priv;\n\tstruct mlxsw_afa_block *afa_block;\n\tchar pefa_pl[MLXSW_REG_PEFA_LEN];\n\tchar pgcr_pl[MLXSW_REG_PGCR_LEN];\n\tchar *enc_actions;\n\tint i;\n\tint err;\n\n\t \n\ttcam->kvdl_count = _tcam->max_regions;\n\tif (MLXSW_CORE_RES_VALID(mlxsw_sp->core, ACL_MAX_DEFAULT_ACTIONS))\n\t\ttcam->kvdl_count = MLXSW_CORE_RES_GET(mlxsw_sp->core,\n\t\t\t\t\t\t      ACL_MAX_DEFAULT_ACTIONS);\n\terr = mlxsw_sp_kvdl_alloc(mlxsw_sp, MLXSW_SP_KVDL_ENTRY_TYPE_ACTSET,\n\t\t\t\t  tcam->kvdl_count, &tcam->kvdl_index);\n\tif (err)\n\t\treturn err;\n\n\t \n\tafa_block = mlxsw_afa_block_create(mlxsw_sp->afa);\n\tif (IS_ERR(afa_block)) {\n\t\terr = PTR_ERR(afa_block);\n\t\tgoto err_afa_block;\n\t}\n\terr = mlxsw_afa_block_continue(afa_block);\n\tif (WARN_ON(err))\n\t\tgoto err_afa_block_continue;\n\tenc_actions = mlxsw_afa_block_cur_set(afa_block);\n\n\t \n\tfor (i = 0; i < _tcam->max_regions; i++) {\n\t\tmlxsw_reg_pefa_pack(pefa_pl, tcam->kvdl_index + i,\n\t\t\t\t    true, enc_actions);\n\t\terr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(pefa), pefa_pl);\n\t\tif (err)\n\t\t\tgoto err_pefa_write;\n\t}\n\tmlxsw_reg_pgcr_pack(pgcr_pl, tcam->kvdl_index);\n\terr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(pgcr), pgcr_pl);\n\tif (err)\n\t\tgoto err_pgcr_write;\n\n\terr = mlxsw_sp_acl_atcam_init(mlxsw_sp, &tcam->atcam);\n\tif (err)\n\t\tgoto err_atcam_init;\n\n\tmlxsw_afa_block_destroy(afa_block);\n\treturn 0;\n\nerr_atcam_init:\nerr_pgcr_write:\nerr_pefa_write:\nerr_afa_block_continue:\n\tmlxsw_afa_block_destroy(afa_block);\nerr_afa_block:\n\tmlxsw_sp_kvdl_free(mlxsw_sp, MLXSW_SP_KVDL_ENTRY_TYPE_ACTSET,\n\t\t\t   tcam->kvdl_count, tcam->kvdl_index);\n\treturn err;\n}\n\nstatic void mlxsw_sp2_acl_tcam_fini(struct mlxsw_sp *mlxsw_sp, void *priv)\n{\n\tstruct mlxsw_sp2_acl_tcam *tcam = priv;\n\n\tmlxsw_sp_acl_atcam_fini(mlxsw_sp, &tcam->atcam);\n\tmlxsw_sp_kvdl_free(mlxsw_sp, MLXSW_SP_KVDL_ENTRY_TYPE_ACTSET,\n\t\t\t   tcam->kvdl_count, tcam->kvdl_index);\n}\n\nstatic int\nmlxsw_sp2_acl_tcam_region_init(struct mlxsw_sp *mlxsw_sp, void *region_priv,\n\t\t\t       void *tcam_priv,\n\t\t\t       struct mlxsw_sp_acl_tcam_region *_region,\n\t\t\t       void *hints_priv)\n{\n\tstruct mlxsw_sp2_acl_tcam_region *region = region_priv;\n\tstruct mlxsw_sp2_acl_tcam *tcam = tcam_priv;\n\n\tregion->region = _region;\n\n\treturn mlxsw_sp_acl_atcam_region_init(mlxsw_sp, &tcam->atcam,\n\t\t\t\t\t      &region->aregion,\n\t\t\t\t\t      _region, hints_priv,\n\t\t\t\t\t      &mlxsw_sp2_acl_ctcam_region_ops);\n}\n\nstatic void\nmlxsw_sp2_acl_tcam_region_fini(struct mlxsw_sp *mlxsw_sp, void *region_priv)\n{\n\tstruct mlxsw_sp2_acl_tcam_region *region = region_priv;\n\n\tmlxsw_sp_acl_atcam_region_fini(&region->aregion);\n}\n\nstatic int\nmlxsw_sp2_acl_tcam_region_associate(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t    struct mlxsw_sp_acl_tcam_region *region)\n{\n\treturn mlxsw_sp_acl_atcam_region_associate(mlxsw_sp, region->id);\n}\n\nstatic void *mlxsw_sp2_acl_tcam_region_rehash_hints_get(void *region_priv)\n{\n\tstruct mlxsw_sp2_acl_tcam_region *region = region_priv;\n\n\treturn mlxsw_sp_acl_atcam_rehash_hints_get(&region->aregion);\n}\n\nstatic void mlxsw_sp2_acl_tcam_region_rehash_hints_put(void *hints_priv)\n{\n\tmlxsw_sp_acl_atcam_rehash_hints_put(hints_priv);\n}\n\nstatic void mlxsw_sp2_acl_tcam_chunk_init(void *region_priv, void *chunk_priv,\n\t\t\t\t\t  unsigned int priority)\n{\n\tstruct mlxsw_sp2_acl_tcam_region *region = region_priv;\n\tstruct mlxsw_sp2_acl_tcam_chunk *chunk = chunk_priv;\n\n\tmlxsw_sp_acl_atcam_chunk_init(&region->aregion, &chunk->achunk,\n\t\t\t\t      priority);\n}\n\nstatic void mlxsw_sp2_acl_tcam_chunk_fini(void *chunk_priv)\n{\n\tstruct mlxsw_sp2_acl_tcam_chunk *chunk = chunk_priv;\n\n\tmlxsw_sp_acl_atcam_chunk_fini(&chunk->achunk);\n}\n\nstatic int mlxsw_sp2_acl_tcam_entry_add(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\tvoid *region_priv, void *chunk_priv,\n\t\t\t\t\tvoid *entry_priv,\n\t\t\t\t\tstruct mlxsw_sp_acl_rule_info *rulei)\n{\n\tstruct mlxsw_sp2_acl_tcam_region *region = region_priv;\n\tstruct mlxsw_sp2_acl_tcam_chunk *chunk = chunk_priv;\n\tstruct mlxsw_sp2_acl_tcam_entry *entry = entry_priv;\n\n\tentry->act_block = rulei->act_block;\n\treturn mlxsw_sp_acl_atcam_entry_add(mlxsw_sp, &region->aregion,\n\t\t\t\t\t    &chunk->achunk, &entry->aentry,\n\t\t\t\t\t    rulei);\n}\n\nstatic void mlxsw_sp2_acl_tcam_entry_del(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\t void *region_priv, void *chunk_priv,\n\t\t\t\t\t void *entry_priv)\n{\n\tstruct mlxsw_sp2_acl_tcam_region *region = region_priv;\n\tstruct mlxsw_sp2_acl_tcam_chunk *chunk = chunk_priv;\n\tstruct mlxsw_sp2_acl_tcam_entry *entry = entry_priv;\n\n\tmlxsw_sp_acl_atcam_entry_del(mlxsw_sp, &region->aregion, &chunk->achunk,\n\t\t\t\t     &entry->aentry);\n}\n\nstatic int\nmlxsw_sp2_acl_tcam_entry_action_replace(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t\tvoid *region_priv, void *entry_priv,\n\t\t\t\t\tstruct mlxsw_sp_acl_rule_info *rulei)\n{\n\tstruct mlxsw_sp2_acl_tcam_region *region = region_priv;\n\tstruct mlxsw_sp2_acl_tcam_entry *entry = entry_priv;\n\n\tentry->act_block = rulei->act_block;\n\treturn mlxsw_sp_acl_atcam_entry_action_replace(mlxsw_sp,\n\t\t\t\t\t\t       &region->aregion,\n\t\t\t\t\t\t       &entry->aentry, rulei);\n}\n\nstatic int\nmlxsw_sp2_acl_tcam_entry_activity_get(struct mlxsw_sp *mlxsw_sp,\n\t\t\t\t      void *region_priv, void *entry_priv,\n\t\t\t\t      bool *activity)\n{\n\tstruct mlxsw_sp2_acl_tcam_entry *entry = entry_priv;\n\n\treturn mlxsw_afa_block_activity_get(entry->act_block, activity);\n}\n\nconst struct mlxsw_sp_acl_tcam_ops mlxsw_sp2_acl_tcam_ops = {\n\t.key_type\t\t= MLXSW_REG_PTAR_KEY_TYPE_FLEX2,\n\t.priv_size\t\t= sizeof(struct mlxsw_sp2_acl_tcam),\n\t.init\t\t\t= mlxsw_sp2_acl_tcam_init,\n\t.fini\t\t\t= mlxsw_sp2_acl_tcam_fini,\n\t.region_priv_size\t= sizeof(struct mlxsw_sp2_acl_tcam_region),\n\t.region_init\t\t= mlxsw_sp2_acl_tcam_region_init,\n\t.region_fini\t\t= mlxsw_sp2_acl_tcam_region_fini,\n\t.region_associate\t= mlxsw_sp2_acl_tcam_region_associate,\n\t.region_rehash_hints_get = mlxsw_sp2_acl_tcam_region_rehash_hints_get,\n\t.region_rehash_hints_put = mlxsw_sp2_acl_tcam_region_rehash_hints_put,\n\t.chunk_priv_size\t= sizeof(struct mlxsw_sp2_acl_tcam_chunk),\n\t.chunk_init\t\t= mlxsw_sp2_acl_tcam_chunk_init,\n\t.chunk_fini\t\t= mlxsw_sp2_acl_tcam_chunk_fini,\n\t.entry_priv_size\t= sizeof(struct mlxsw_sp2_acl_tcam_entry),\n\t.entry_add\t\t= mlxsw_sp2_acl_tcam_entry_add,\n\t.entry_del\t\t= mlxsw_sp2_acl_tcam_entry_del,\n\t.entry_action_replace\t= mlxsw_sp2_acl_tcam_entry_action_replace,\n\t.entry_activity_get\t= mlxsw_sp2_acl_tcam_entry_activity_get,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}