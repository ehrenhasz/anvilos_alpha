{
  "module_name": "mlxbf_gige_mdio.c",
  "hash_id": "9aa78d8172be717150ba2e92022d2a63e33fdfc85400ffa4e071596dbc374704",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlxbf_gige/mlxbf_gige_mdio.c",
  "human_readable_source": "\n\n \n\n#include <linux/acpi.h>\n#include <linux/bitfield.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/iopoll.h>\n#include <linux/ioport.h>\n#include <linux/irqreturn.h>\n#include <linux/jiffies.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/phy.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n\n#include \"mlxbf_gige.h\"\n#include \"mlxbf_gige_regs.h\"\n#include \"mlxbf_gige_mdio_bf2.h\"\n#include \"mlxbf_gige_mdio_bf3.h\"\n\nstatic struct mlxbf_gige_mdio_gw mlxbf_gige_mdio_gw_t[] = {\n\t[MLXBF_GIGE_VERSION_BF2] = {\n\t\t.gw_address = MLXBF2_GIGE_MDIO_GW_OFFSET,\n\t\t.read_data_address = MLXBF2_GIGE_MDIO_GW_OFFSET,\n\t\t.busy = {\n\t\t\t.mask = MLXBF2_GIGE_MDIO_GW_BUSY_MASK,\n\t\t\t.shift = MLXBF2_GIGE_MDIO_GW_BUSY_SHIFT,\n\t\t},\n\t\t.read_data = {\n\t\t\t.mask = MLXBF2_GIGE_MDIO_GW_AD_MASK,\n\t\t\t.shift = MLXBF2_GIGE_MDIO_GW_AD_SHIFT,\n\t\t},\n\t\t.write_data = {\n\t\t\t.mask = MLXBF2_GIGE_MDIO_GW_AD_MASK,\n\t\t\t.shift = MLXBF2_GIGE_MDIO_GW_AD_SHIFT,\n\t\t},\n\t\t.devad = {\n\t\t\t.mask = MLXBF2_GIGE_MDIO_GW_DEVAD_MASK,\n\t\t\t.shift = MLXBF2_GIGE_MDIO_GW_DEVAD_SHIFT,\n\t\t},\n\t\t.partad = {\n\t\t\t.mask = MLXBF2_GIGE_MDIO_GW_PARTAD_MASK,\n\t\t\t.shift = MLXBF2_GIGE_MDIO_GW_PARTAD_SHIFT,\n\t\t},\n\t\t.opcode = {\n\t\t\t.mask = MLXBF2_GIGE_MDIO_GW_OPCODE_MASK,\n\t\t\t.shift = MLXBF2_GIGE_MDIO_GW_OPCODE_SHIFT,\n\t\t},\n\t\t.st1 = {\n\t\t\t.mask = MLXBF2_GIGE_MDIO_GW_ST1_MASK,\n\t\t\t.shift = MLXBF2_GIGE_MDIO_GW_ST1_SHIFT,\n\t\t},\n\t},\n\t[MLXBF_GIGE_VERSION_BF3] = {\n\t\t.gw_address = MLXBF3_GIGE_MDIO_GW_OFFSET,\n\t\t.read_data_address = MLXBF3_GIGE_MDIO_DATA_READ,\n\t\t.busy = {\n\t\t\t.mask = MLXBF3_GIGE_MDIO_GW_BUSY_MASK,\n\t\t\t.shift = MLXBF3_GIGE_MDIO_GW_BUSY_SHIFT,\n\t\t},\n\t\t.read_data = {\n\t\t\t.mask = MLXBF3_GIGE_MDIO_GW_DATA_READ_MASK,\n\t\t\t.shift = MLXBF3_GIGE_MDIO_GW_DATA_READ_SHIFT,\n\t\t},\n\t\t.write_data = {\n\t\t\t.mask = MLXBF3_GIGE_MDIO_GW_DATA_MASK,\n\t\t\t.shift = MLXBF3_GIGE_MDIO_GW_DATA_SHIFT,\n\t\t},\n\t\t.devad = {\n\t\t\t.mask = MLXBF3_GIGE_MDIO_GW_DEVAD_MASK,\n\t\t\t.shift = MLXBF3_GIGE_MDIO_GW_DEVAD_SHIFT,\n\t\t},\n\t\t.partad = {\n\t\t\t.mask = MLXBF3_GIGE_MDIO_GW_PARTAD_MASK,\n\t\t\t.shift = MLXBF3_GIGE_MDIO_GW_PARTAD_SHIFT,\n\t\t},\n\t\t.opcode = {\n\t\t\t.mask = MLXBF3_GIGE_MDIO_GW_OPCODE_MASK,\n\t\t\t.shift = MLXBF3_GIGE_MDIO_GW_OPCODE_SHIFT,\n\t\t},\n\t\t.st1 = {\n\t\t\t.mask = MLXBF3_GIGE_MDIO_GW_ST1_MASK,\n\t\t\t.shift = MLXBF3_GIGE_MDIO_GW_ST1_SHIFT,\n\t\t},\n\t},\n};\n\n#define MLXBF_GIGE_MDIO_FREQ_REFERENCE 156250000ULL\n#define MLXBF_GIGE_MDIO_COREPLL_CONST  16384ULL\n#define MLXBF_GIGE_MDC_CLK_NS          400\n#define MLXBF_GIGE_MDIO_PLL_I1CLK_REG1 0x4\n#define MLXBF_GIGE_MDIO_PLL_I1CLK_REG2 0x8\n#define MLXBF_GIGE_MDIO_CORE_F_SHIFT   0\n#define MLXBF_GIGE_MDIO_CORE_F_MASK    GENMASK(25, 0)\n#define MLXBF_GIGE_MDIO_CORE_R_SHIFT   26\n#define MLXBF_GIGE_MDIO_CORE_R_MASK    GENMASK(31, 26)\n#define MLXBF_GIGE_MDIO_CORE_OD_SHIFT  0\n#define MLXBF_GIGE_MDIO_CORE_OD_MASK   GENMASK(3, 0)\n\n \n#define MLXBF_GIGE_MDIO_CL22_ST1\t0x1\n#define MLXBF_GIGE_MDIO_CL22_WRITE\t0x1\n#define MLXBF_GIGE_MDIO_CL22_READ\t0x2\n\n \n#define MLXBF_GIGE_MDIO_SET_BUSY\t0x1\n\n#define MLXBF_GIGE_BF2_COREPLL_ADDR 0x02800c30\n#define MLXBF_GIGE_BF2_COREPLL_SIZE 0x0000000c\n#define MLXBF_GIGE_BF3_COREPLL_ADDR 0x13409824\n#define MLXBF_GIGE_BF3_COREPLL_SIZE 0x00000010\n\nstatic struct resource corepll_params[] = {\n\t[MLXBF_GIGE_VERSION_BF2] = {\n\t\t.start = MLXBF_GIGE_BF2_COREPLL_ADDR,\n\t\t.end = MLXBF_GIGE_BF2_COREPLL_ADDR + MLXBF_GIGE_BF2_COREPLL_SIZE - 1,\n\t\t.name = \"COREPLL_RES\"\n\t},\n\t[MLXBF_GIGE_VERSION_BF3] = {\n\t\t.start = MLXBF_GIGE_BF3_COREPLL_ADDR,\n\t\t.end = MLXBF_GIGE_BF3_COREPLL_ADDR + MLXBF_GIGE_BF3_COREPLL_SIZE - 1,\n\t\t.name = \"COREPLL_RES\"\n\t}\n};\n\n \nstatic u64 calculate_i1clk(struct mlxbf_gige *priv)\n{\n\tu8 core_od, core_r;\n\tu64 freq_output;\n\tu32 reg1, reg2;\n\tu32 core_f;\n\n\treg1 = readl(priv->clk_io + MLXBF_GIGE_MDIO_PLL_I1CLK_REG1);\n\treg2 = readl(priv->clk_io + MLXBF_GIGE_MDIO_PLL_I1CLK_REG2);\n\n\tcore_f = (reg1 & MLXBF_GIGE_MDIO_CORE_F_MASK) >>\n\t\tMLXBF_GIGE_MDIO_CORE_F_SHIFT;\n\tcore_r = (reg1 & MLXBF_GIGE_MDIO_CORE_R_MASK) >>\n\t\tMLXBF_GIGE_MDIO_CORE_R_SHIFT;\n\tcore_od = (reg2 & MLXBF_GIGE_MDIO_CORE_OD_MASK) >>\n\t\tMLXBF_GIGE_MDIO_CORE_OD_SHIFT;\n\n\t \n\tfreq_output = div_u64((MLXBF_GIGE_MDIO_FREQ_REFERENCE * core_f),\n\t\t\t      MLXBF_GIGE_MDIO_COREPLL_CONST);\n\tfreq_output = div_u64(freq_output, (core_r + 1) * (core_od + 1));\n\n\treturn freq_output;\n}\n\n \nstatic u8 mdio_period_map(struct mlxbf_gige *priv)\n{\n\tu8 mdio_period;\n\tu64 i1clk;\n\n\ti1clk = calculate_i1clk(priv);\n\n\tmdio_period = div_u64((MLXBF_GIGE_MDC_CLK_NS >> 1) * i1clk, 1000000000) - 1;\n\n\treturn mdio_period;\n}\n\nstatic u32 mlxbf_gige_mdio_create_cmd(struct mlxbf_gige_mdio_gw *mdio_gw, u16 data, int phy_add,\n\t\t\t\t      int phy_reg, u32 opcode)\n{\n\tu32 gw_reg = 0;\n\n\tgw_reg |= ((data << mdio_gw->write_data.shift) &\n\t\t   mdio_gw->write_data.mask);\n\tgw_reg |= ((phy_reg << mdio_gw->devad.shift) &\n\t\t   mdio_gw->devad.mask);\n\tgw_reg |= ((phy_add << mdio_gw->partad.shift) &\n\t\t   mdio_gw->partad.mask);\n\tgw_reg |= ((opcode << mdio_gw->opcode.shift) &\n\t\t   mdio_gw->opcode.mask);\n\tgw_reg |= ((MLXBF_GIGE_MDIO_CL22_ST1 << mdio_gw->st1.shift) &\n\t\t   mdio_gw->st1.mask);\n\tgw_reg |= ((MLXBF_GIGE_MDIO_SET_BUSY << mdio_gw->busy.shift) &\n\t\t   mdio_gw->busy.mask);\n\n\treturn gw_reg;\n}\n\nstatic int mlxbf_gige_mdio_read(struct mii_bus *bus, int phy_add, int phy_reg)\n{\n\tstruct mlxbf_gige *priv = bus->priv;\n\tu32 cmd;\n\tint ret;\n\tu32 val;\n\n\t \n\tcmd = mlxbf_gige_mdio_create_cmd(priv->mdio_gw, 0, phy_add, phy_reg,\n\t\t\t\t\t MLXBF_GIGE_MDIO_CL22_READ);\n\n\twritel(cmd, priv->mdio_io + priv->mdio_gw->gw_address);\n\n\tret = readl_poll_timeout_atomic(priv->mdio_io + priv->mdio_gw->gw_address,\n\t\t\t\t\tval, !(val & priv->mdio_gw->busy.mask),\n\t\t\t\t\t5, 1000000);\n\n\tif (ret) {\n\t\twritel(0, priv->mdio_io + priv->mdio_gw->gw_address);\n\t\treturn ret;\n\t}\n\n\tret = readl(priv->mdio_io + priv->mdio_gw->read_data_address);\n\t \n\tret &= priv->mdio_gw->read_data.mask;\n\n\t \n\twritel(0, priv->mdio_io + priv->mdio_gw->gw_address);\n\n\treturn ret;\n}\n\nstatic int mlxbf_gige_mdio_write(struct mii_bus *bus, int phy_add,\n\t\t\t\t int phy_reg, u16 val)\n{\n\tstruct mlxbf_gige *priv = bus->priv;\n\tu32 temp;\n\tu32 cmd;\n\tint ret;\n\n\t \n\tcmd = mlxbf_gige_mdio_create_cmd(priv->mdio_gw, val, phy_add, phy_reg,\n\t\t\t\t\t MLXBF_GIGE_MDIO_CL22_WRITE);\n\twritel(cmd, priv->mdio_io + priv->mdio_gw->gw_address);\n\n\t \n\tret = readl_poll_timeout_atomic(priv->mdio_io + priv->mdio_gw->gw_address,\n\t\t\t\t\ttemp, !(temp & priv->mdio_gw->busy.mask),\n\t\t\t\t\t5, 1000000);\n\n\t \n\twritel(0, priv->mdio_io + priv->mdio_gw->gw_address);\n\n\treturn ret;\n}\n\nstatic void mlxbf_gige_mdio_cfg(struct mlxbf_gige *priv)\n{\n\tu8 mdio_period;\n\tu32 val;\n\n\tmdio_period = mdio_period_map(priv);\n\n\tif (priv->hw_version == MLXBF_GIGE_VERSION_BF2) {\n\t\tval = MLXBF2_GIGE_MDIO_CFG_VAL;\n\t\tval |= FIELD_PREP(MLXBF2_GIGE_MDIO_CFG_MDC_PERIOD_MASK, mdio_period);\n\t\twritel(val, priv->mdio_io + MLXBF2_GIGE_MDIO_CFG_OFFSET);\n\t} else {\n\t\tval = FIELD_PREP(MLXBF3_GIGE_MDIO_CFG_MDIO_MODE_MASK, 1) |\n\t\t      FIELD_PREP(MLXBF3_GIGE_MDIO_CFG_MDIO_FULL_DRIVE_MASK, 1);\n\t\twritel(val, priv->mdio_io + MLXBF3_GIGE_MDIO_CFG_REG0);\n\t\tval = FIELD_PREP(MLXBF3_GIGE_MDIO_CFG_MDC_PERIOD_MASK, mdio_period);\n\t\twritel(val, priv->mdio_io + MLXBF3_GIGE_MDIO_CFG_REG1);\n\t\tval = FIELD_PREP(MLXBF3_GIGE_MDIO_CFG_MDIO_IN_SAMP_MASK, 6) |\n\t\t      FIELD_PREP(MLXBF3_GIGE_MDIO_CFG_MDIO_OUT_SAMP_MASK, 13);\n\t\twritel(val, priv->mdio_io + MLXBF3_GIGE_MDIO_CFG_REG2);\n\t}\n}\n\nint mlxbf_gige_mdio_probe(struct platform_device *pdev, struct mlxbf_gige *priv)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct resource *res;\n\tint ret;\n\n\tif (priv->hw_version > MLXBF_GIGE_VERSION_BF3)\n\t\treturn -ENODEV;\n\n\tpriv->mdio_io = devm_platform_ioremap_resource(pdev, MLXBF_GIGE_RES_MDIO9);\n\tif (IS_ERR(priv->mdio_io))\n\t\treturn PTR_ERR(priv->mdio_io);\n\n\t \n\tres = platform_get_resource(pdev, IORESOURCE_MEM, MLXBF_GIGE_RES_CLK);\n\tif (!res) {\n\t\t \n\t\tres = &corepll_params[priv->hw_version];\n\t}\n\n\tpriv->clk_io = devm_ioremap(dev, res->start, resource_size(res));\n\tif (!priv->clk_io)\n\t\treturn -ENOMEM;\n\n\tpriv->mdio_gw = &mlxbf_gige_mdio_gw_t[priv->hw_version];\n\n\tmlxbf_gige_mdio_cfg(priv);\n\n\tpriv->mdiobus = devm_mdiobus_alloc(dev);\n\tif (!priv->mdiobus) {\n\t\tdev_err(dev, \"Failed to alloc MDIO bus\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tpriv->mdiobus->name = \"mlxbf-mdio\";\n\tpriv->mdiobus->read = mlxbf_gige_mdio_read;\n\tpriv->mdiobus->write = mlxbf_gige_mdio_write;\n\tpriv->mdiobus->parent = dev;\n\tpriv->mdiobus->priv = priv;\n\tsnprintf(priv->mdiobus->id, MII_BUS_ID_SIZE, \"%s\",\n\t\t dev_name(dev));\n\n\tret = mdiobus_register(priv->mdiobus);\n\tif (ret)\n\t\tdev_err(dev, \"Failed to register MDIO bus\\n\");\n\n\treturn ret;\n}\n\nvoid mlxbf_gige_mdio_remove(struct mlxbf_gige *priv)\n{\n\tmdiobus_unregister(priv->mdiobus);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}