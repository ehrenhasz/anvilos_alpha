{
  "module_name": "ipsec.h",
  "hash_id": "eee49cdfd4ceafe28c3150e9d887e61208ba078bbf9d65daa4d0957e05a95d99",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/en_accel/ipsec.h",
  "human_readable_source": " \n\n#ifndef __MLX5E_IPSEC_H__\n#define __MLX5E_IPSEC_H__\n\n#include <linux/mlx5/device.h>\n#include <net/xfrm.h>\n#include <linux/idr.h>\n#include \"lib/aso.h\"\n\n#define MLX5E_IPSEC_SADB_RX_BITS 10\n#define MLX5E_IPSEC_ESN_SCOPE_MID 0x80000000L\n\nstruct aes_gcm_keymat {\n\tu64   seq_iv;\n\n\tu32   salt;\n\tu32   icv_len;\n\n\tu32   key_len;\n\tu32   aes_key[256 / 32];\n};\n\nstruct upspec {\n\tu16 dport;\n\tu16 dport_mask;\n\tu16 sport;\n\tu16 sport_mask;\n\tu8 proto;\n};\n\nstruct mlx5_ipsec_lft {\n\tu64 hard_packet_limit;\n\tu64 soft_packet_limit;\n\tu64 numb_rounds_hard;\n\tu64 numb_rounds_soft;\n};\n\nstruct mlx5_replay_esn {\n\tu32 replay_window;\n\tu32 esn;\n\tu32 esn_msb;\n\tu8 overlap : 1;\n\tu8 trigger : 1;\n};\n\nstruct mlx5_accel_esp_xfrm_attrs {\n\tu32   spi;\n\tu32   mode;\n\tstruct aes_gcm_keymat aes_gcm;\n\n\tunion {\n\t\t__be32 a4;\n\t\t__be32 a6[4];\n\t} saddr;\n\n\tunion {\n\t\t__be32 a4;\n\t\t__be32 a6[4];\n\t} daddr;\n\n\tstruct upspec upspec;\n\tu8 dir : 2;\n\tu8 type : 2;\n\tu8 drop : 1;\n\tu8 encap : 1;\n\tu8 family;\n\tstruct mlx5_replay_esn replay_esn;\n\tu32 authsize;\n\tu32 reqid;\n\tstruct mlx5_ipsec_lft lft;\n\tunion {\n\t\tu8 smac[ETH_ALEN];\n\t\t__be16 sport;\n\t};\n\tunion {\n\t\tu8 dmac[ETH_ALEN];\n\t\t__be16 dport;\n\t};\n};\n\nenum mlx5_ipsec_cap {\n\tMLX5_IPSEC_CAP_CRYPTO\t\t= 1 << 0,\n\tMLX5_IPSEC_CAP_ESN\t\t= 1 << 1,\n\tMLX5_IPSEC_CAP_PACKET_OFFLOAD\t= 1 << 2,\n\tMLX5_IPSEC_CAP_ROCE             = 1 << 3,\n\tMLX5_IPSEC_CAP_PRIO             = 1 << 4,\n\tMLX5_IPSEC_CAP_TUNNEL           = 1 << 5,\n\tMLX5_IPSEC_CAP_ESPINUDP         = 1 << 6,\n};\n\nstruct mlx5e_priv;\n\nstruct mlx5e_ipsec_hw_stats {\n\tu64 ipsec_rx_pkts;\n\tu64 ipsec_rx_bytes;\n\tu64 ipsec_rx_drop_pkts;\n\tu64 ipsec_rx_drop_bytes;\n\tu64 ipsec_tx_pkts;\n\tu64 ipsec_tx_bytes;\n\tu64 ipsec_tx_drop_pkts;\n\tu64 ipsec_tx_drop_bytes;\n};\n\nstruct mlx5e_ipsec_sw_stats {\n\tatomic64_t ipsec_rx_drop_sp_alloc;\n\tatomic64_t ipsec_rx_drop_sadb_miss;\n\tatomic64_t ipsec_rx_drop_syndrome;\n\tatomic64_t ipsec_tx_drop_bundle;\n\tatomic64_t ipsec_tx_drop_no_state;\n\tatomic64_t ipsec_tx_drop_not_ip;\n\tatomic64_t ipsec_tx_drop_trailer;\n};\n\nstruct mlx5e_ipsec_fc;\nstruct mlx5e_ipsec_tx;\n\nstruct mlx5e_ipsec_work {\n\tstruct work_struct work;\n\tstruct mlx5e_ipsec_sa_entry *sa_entry;\n\tvoid *data;\n};\n\nstruct mlx5e_ipsec_netevent_data {\n\tu8 addr[ETH_ALEN];\n};\n\nstruct mlx5e_ipsec_dwork {\n\tstruct delayed_work dwork;\n\tstruct mlx5e_ipsec_sa_entry *sa_entry;\n};\n\nstruct mlx5e_ipsec_aso {\n\tu8 __aligned(64) ctx[MLX5_ST_SZ_BYTES(ipsec_aso)];\n\tdma_addr_t dma_addr;\n\tstruct mlx5_aso *aso;\n\t \n\tspinlock_t lock;\n};\n\nstruct mlx5e_ipsec_rx_create_attr {\n\tstruct mlx5_flow_namespace *ns;\n\tstruct mlx5_ttc_table *ttc;\n\tu32 family;\n\tint prio;\n\tint pol_level;\n\tint sa_level;\n\tint status_level;\n\tenum mlx5_flow_namespace_type chains_ns;\n};\n\nstruct mlx5e_ipsec_ft {\n\tstruct mutex mutex;  \n\tstruct mlx5_flow_table *pol;\n\tstruct mlx5_flow_table *sa;\n\tstruct mlx5_flow_table *status;\n\tu32 refcnt;\n};\n\nstruct mlx5e_ipsec_rule {\n\tstruct mlx5_flow_handle *rule;\n\tstruct mlx5_modify_hdr *modify_hdr;\n\tstruct mlx5_pkt_reformat *pkt_reformat;\n\tstruct mlx5_fc *fc;\n};\n\nstruct mlx5e_ipsec_miss {\n\tstruct mlx5_flow_group *group;\n\tstruct mlx5_flow_handle *rule;\n};\n\nstruct mlx5e_ipsec_rx {\n\tstruct mlx5e_ipsec_ft ft;\n\tstruct mlx5e_ipsec_miss pol;\n\tstruct mlx5e_ipsec_miss sa;\n\tstruct mlx5e_ipsec_rule status;\n\tstruct mlx5e_ipsec_miss status_drop;\n\tstruct mlx5_fc *status_drop_cnt;\n\tstruct mlx5e_ipsec_fc *fc;\n\tstruct mlx5_fs_chains *chains;\n\tu8 allow_tunnel_mode : 1;\n\tstruct xarray ipsec_obj_id_map;\n};\n\nstruct mlx5e_ipsec_tx_create_attr {\n\tint prio;\n\tint pol_level;\n\tint sa_level;\n\tint cnt_level;\n\tenum mlx5_flow_namespace_type chains_ns;\n};\n\nstruct mlx5e_ipsec {\n\tstruct mlx5_core_dev *mdev;\n\tstruct xarray sadb;\n\tstruct mlx5e_ipsec_sw_stats sw_stats;\n\tstruct mlx5e_ipsec_hw_stats hw_stats;\n\tstruct workqueue_struct *wq;\n\tstruct mlx5e_flow_steering *fs;\n\tstruct mlx5e_ipsec_rx *rx_ipv4;\n\tstruct mlx5e_ipsec_rx *rx_ipv6;\n\tstruct mlx5e_ipsec_rx *rx_esw;\n\tstruct mlx5e_ipsec_tx *tx;\n\tstruct mlx5e_ipsec_tx *tx_esw;\n\tstruct mlx5e_ipsec_aso *aso;\n\tstruct notifier_block nb;\n\tstruct notifier_block netevent_nb;\n\tstruct mlx5_ipsec_fs *roce;\n\tu8 is_uplink_rep: 1;\n};\n\nstruct mlx5e_ipsec_esn_state {\n\tu32 esn;\n\tu32 esn_msb;\n\tu8 overlap: 1;\n};\n\nstruct mlx5e_ipsec_limits {\n\tu64 round;\n\tu8 soft_limit_hit : 1;\n\tu8 fix_limit : 1;\n};\n\nstruct mlx5e_ipsec_sa_entry {\n\tstruct mlx5e_ipsec_esn_state esn_state;\n\tstruct xfrm_state *x;\n\tstruct mlx5e_ipsec *ipsec;\n\tstruct mlx5_accel_esp_xfrm_attrs attrs;\n\tvoid (*set_iv_op)(struct sk_buff *skb, struct xfrm_state *x,\n\t\t\t  struct xfrm_offload *xo);\n\tu32 ipsec_obj_id;\n\tu32 enc_key_id;\n\tstruct mlx5e_ipsec_rule ipsec_rule;\n\tstruct mlx5e_ipsec_work *work;\n\tstruct mlx5e_ipsec_dwork *dwork;\n\tstruct mlx5e_ipsec_limits limits;\n\tu32 rx_mapped_id;\n};\n\nstruct mlx5_accel_pol_xfrm_attrs {\n\tunion {\n\t\t__be32 a4;\n\t\t__be32 a6[4];\n\t} saddr;\n\n\tunion {\n\t\t__be32 a4;\n\t\t__be32 a6[4];\n\t} daddr;\n\n\tstruct upspec upspec;\n\tu8 family;\n\tu8 action;\n\tu8 type : 2;\n\tu8 dir : 2;\n\tu32 reqid;\n\tu32 prio;\n};\n\nstruct mlx5e_ipsec_pol_entry {\n\tstruct xfrm_policy *x;\n\tstruct mlx5e_ipsec *ipsec;\n\tstruct mlx5e_ipsec_rule ipsec_rule;\n\tstruct mlx5_accel_pol_xfrm_attrs attrs;\n};\n\n#ifdef CONFIG_MLX5_EN_IPSEC\n\nvoid mlx5e_ipsec_init(struct mlx5e_priv *priv);\nvoid mlx5e_ipsec_cleanup(struct mlx5e_priv *priv);\nvoid mlx5e_ipsec_build_netdev(struct mlx5e_priv *priv);\n\nvoid mlx5e_accel_ipsec_fs_cleanup(struct mlx5e_ipsec *ipsec);\nint mlx5e_accel_ipsec_fs_init(struct mlx5e_ipsec *ipsec);\nint mlx5e_accel_ipsec_fs_add_rule(struct mlx5e_ipsec_sa_entry *sa_entry);\nvoid mlx5e_accel_ipsec_fs_del_rule(struct mlx5e_ipsec_sa_entry *sa_entry);\nint mlx5e_accel_ipsec_fs_add_pol(struct mlx5e_ipsec_pol_entry *pol_entry);\nvoid mlx5e_accel_ipsec_fs_del_pol(struct mlx5e_ipsec_pol_entry *pol_entry);\nvoid mlx5e_accel_ipsec_fs_modify(struct mlx5e_ipsec_sa_entry *sa_entry);\nbool mlx5e_ipsec_fs_tunnel_enabled(struct mlx5e_ipsec_sa_entry *sa_entry);\n\nint mlx5_ipsec_create_sa_ctx(struct mlx5e_ipsec_sa_entry *sa_entry);\nvoid mlx5_ipsec_free_sa_ctx(struct mlx5e_ipsec_sa_entry *sa_entry);\n\nu32 mlx5_ipsec_device_caps(struct mlx5_core_dev *mdev);\n\nvoid mlx5_accel_esp_modify_xfrm(struct mlx5e_ipsec_sa_entry *sa_entry,\n\t\t\t\tconst struct mlx5_accel_esp_xfrm_attrs *attrs);\n\nint mlx5e_ipsec_aso_init(struct mlx5e_ipsec *ipsec);\nvoid mlx5e_ipsec_aso_cleanup(struct mlx5e_ipsec *ipsec);\n\nint mlx5e_ipsec_aso_query(struct mlx5e_ipsec_sa_entry *sa_entry,\n\t\t\t  struct mlx5_wqe_aso_ctrl_seg *data);\nvoid mlx5e_accel_ipsec_fs_read_stats(struct mlx5e_priv *priv,\n\t\t\t\t     void *ipsec_stats);\n\nvoid mlx5e_ipsec_build_accel_xfrm_attrs(struct mlx5e_ipsec_sa_entry *sa_entry,\n\t\t\t\t\tstruct mlx5_accel_esp_xfrm_attrs *attrs);\nstatic inline struct mlx5_core_dev *\nmlx5e_ipsec_sa2dev(struct mlx5e_ipsec_sa_entry *sa_entry)\n{\n\treturn sa_entry->ipsec->mdev;\n}\n\nstatic inline struct mlx5_core_dev *\nmlx5e_ipsec_pol2dev(struct mlx5e_ipsec_pol_entry *pol_entry)\n{\n\treturn pol_entry->ipsec->mdev;\n}\n\nstatic inline bool addr6_all_zero(__be32 *addr6)\n{\n\tstatic const __be32 zaddr6[4] = {};\n\n\treturn !memcmp(addr6, zaddr6, sizeof(zaddr6));\n}\n#else\nstatic inline void mlx5e_ipsec_init(struct mlx5e_priv *priv)\n{\n}\n\nstatic inline void mlx5e_ipsec_cleanup(struct mlx5e_priv *priv)\n{\n}\n\nstatic inline void mlx5e_ipsec_build_netdev(struct mlx5e_priv *priv)\n{\n}\n\nstatic inline u32 mlx5_ipsec_device_caps(struct mlx5_core_dev *mdev)\n{\n\treturn 0;\n}\n#endif\n\n#endif\t \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}