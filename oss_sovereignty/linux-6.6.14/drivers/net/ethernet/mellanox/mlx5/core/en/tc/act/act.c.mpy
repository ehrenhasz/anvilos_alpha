{
  "module_name": "act.c",
  "hash_id": "37f5d4b8191f7675ba170b542d913002fd66daf220bc57887a64e404c9c480f4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/en/tc/act/act.c",
  "human_readable_source": "\n\n\n#include \"act.h\"\n#include \"en/tc/post_act.h\"\n#include \"en/tc_priv.h\"\n#include \"mlx5_core.h\"\n\nstatic struct mlx5e_tc_act *tc_acts_fdb[NUM_FLOW_ACTIONS] = {\n\t[FLOW_ACTION_ACCEPT] = &mlx5e_tc_act_accept,\n\t[FLOW_ACTION_DROP] = &mlx5e_tc_act_drop,\n\t[FLOW_ACTION_TRAP] = &mlx5e_tc_act_trap,\n\t[FLOW_ACTION_GOTO] = &mlx5e_tc_act_goto,\n\t[FLOW_ACTION_REDIRECT] = &mlx5e_tc_act_redirect,\n\t[FLOW_ACTION_MIRRED] = &mlx5e_tc_act_mirred,\n\t[FLOW_ACTION_REDIRECT_INGRESS] = &mlx5e_tc_act_redirect_ingress,\n\t[FLOW_ACTION_VLAN_PUSH] = &mlx5e_tc_act_vlan,\n\t[FLOW_ACTION_VLAN_POP] = &mlx5e_tc_act_vlan,\n\t[FLOW_ACTION_VLAN_MANGLE] = &mlx5e_tc_act_vlan_mangle,\n\t[FLOW_ACTION_TUNNEL_ENCAP] = &mlx5e_tc_act_tun_encap,\n\t[FLOW_ACTION_TUNNEL_DECAP] = &mlx5e_tc_act_tun_decap,\n\t[FLOW_ACTION_MANGLE] = &mlx5e_tc_act_pedit,\n\t[FLOW_ACTION_ADD] = &mlx5e_tc_act_pedit,\n\t[FLOW_ACTION_CSUM] = &mlx5e_tc_act_csum,\n\t[FLOW_ACTION_PTYPE] = &mlx5e_tc_act_ptype,\n\t[FLOW_ACTION_SAMPLE] = &mlx5e_tc_act_sample,\n\t[FLOW_ACTION_POLICE] = &mlx5e_tc_act_police,\n\t[FLOW_ACTION_CT] = &mlx5e_tc_act_ct,\n\t[FLOW_ACTION_MPLS_PUSH] = &mlx5e_tc_act_mpls_push,\n\t[FLOW_ACTION_MPLS_POP] = &mlx5e_tc_act_mpls_pop,\n\t[FLOW_ACTION_VLAN_PUSH_ETH] = &mlx5e_tc_act_vlan,\n\t[FLOW_ACTION_VLAN_POP_ETH] = &mlx5e_tc_act_vlan,\n};\n\nstatic struct mlx5e_tc_act *tc_acts_nic[NUM_FLOW_ACTIONS] = {\n\t[FLOW_ACTION_ACCEPT] = &mlx5e_tc_act_accept,\n\t[FLOW_ACTION_DROP] = &mlx5e_tc_act_drop,\n\t[FLOW_ACTION_GOTO] = &mlx5e_tc_act_goto,\n\t[FLOW_ACTION_REDIRECT] = &mlx5e_tc_act_mirred_nic,\n\t[FLOW_ACTION_MANGLE] = &mlx5e_tc_act_pedit,\n\t[FLOW_ACTION_ADD] = &mlx5e_tc_act_pedit,\n\t[FLOW_ACTION_CSUM] = &mlx5e_tc_act_csum,\n\t[FLOW_ACTION_MARK] = &mlx5e_tc_act_mark,\n\t[FLOW_ACTION_CT] = &mlx5e_tc_act_ct,\n};\n\n \nstruct mlx5e_tc_act *\nmlx5e_tc_act_get(enum flow_action_id act_id,\n\t\t enum mlx5_flow_namespace_type ns_type)\n{\n\tstruct mlx5e_tc_act **tc_acts;\n\n\ttc_acts = ns_type == MLX5_FLOW_NAMESPACE_FDB ? tc_acts_fdb : tc_acts_nic;\n\n\treturn tc_acts[act_id];\n}\n\n \nvoid\nmlx5e_tc_act_init_parse_state(struct mlx5e_tc_act_parse_state *parse_state,\n\t\t\t      struct mlx5e_tc_flow *flow,\n\t\t\t      struct flow_action *flow_action,\n\t\t\t      struct netlink_ext_ack *extack)\n{\n\tmemset(parse_state, 0, sizeof(*parse_state));\n\tparse_state->flow = flow;\n\tparse_state->extack = extack;\n\tparse_state->flow_action = flow_action;\n}\n\nint\nmlx5e_tc_act_post_parse(struct mlx5e_tc_act_parse_state *parse_state,\n\t\t\tstruct flow_action *flow_action, int from, int to,\n\t\t\tstruct mlx5_flow_attr *attr,\n\t\t\tenum mlx5_flow_namespace_type ns_type)\n{\n\tstruct flow_action_entry *act;\n\tstruct mlx5e_tc_act *tc_act;\n\tstruct mlx5e_priv *priv;\n\tint err = 0, i;\n\n\tpriv = parse_state->flow->priv;\n\n\tflow_action_for_each(i, act, flow_action) {\n\t\tif (i < from)\n\t\t\tcontinue;\n\t\telse if (i > to)\n\t\t\tbreak;\n\n\t\ttc_act = mlx5e_tc_act_get(act->id, ns_type);\n\t\tif (!tc_act || !tc_act->post_parse)\n\t\t\tcontinue;\n\n\t\terr = tc_act->post_parse(parse_state, priv, attr);\n\t\tif (err)\n\t\t\tgoto out;\n\t}\n\nout:\n\treturn err;\n}\n\nint\nmlx5e_tc_act_set_next_post_act(struct mlx5e_tc_flow *flow,\n\t\t\t       struct mlx5_flow_attr *attr,\n\t\t\t       struct mlx5_flow_attr *next_attr)\n{\n\tstruct mlx5_core_dev *mdev = flow->priv->mdev;\n\tstruct mlx5e_tc_mod_hdr_acts *mod_acts;\n\tint err;\n\n\tmod_acts = &attr->parse_attr->mod_hdr_acts;\n\n\t \n\terr = mlx5e_tc_post_act_set_handle(mdev, next_attr->post_act_handle, mod_acts);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"Failed setting post action handle\");\n\t\treturn err;\n\t}\n\n\tattr->action |= MLX5_FLOW_CONTEXT_ACTION_FWD_DEST |\n\t\t\tMLX5_FLOW_CONTEXT_ACTION_MOD_HDR;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}