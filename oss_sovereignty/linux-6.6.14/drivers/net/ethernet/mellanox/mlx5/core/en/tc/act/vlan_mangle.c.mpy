{
  "module_name": "vlan_mangle.c",
  "hash_id": "71dfd9345ae87cfb76192623e882b027ea572243ecbd8a7039a3b414f54ee650",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/en/tc/act/vlan_mangle.c",
  "human_readable_source": "\n\n\n#include <linux/if_vlan.h>\n#include \"act.h\"\n#include \"vlan.h\"\n#include \"en/tc_priv.h\"\n\nstruct pedit_headers_action;\n\nint\nmlx5e_tc_act_vlan_add_rewrite_action(struct mlx5e_priv *priv, int namespace,\n\t\t\t\t     const struct flow_action_entry *act,\n\t\t\t\t     struct mlx5e_tc_flow_parse_attr *parse_attr,\n\t\t\t\t     u32 *action, struct netlink_ext_ack *extack)\n{\n\tu16 mask16 = VLAN_VID_MASK;\n\tu16 val16 = act->vlan.vid & VLAN_VID_MASK;\n\tconst struct flow_action_entry pedit_act = {\n\t\t.id = FLOW_ACTION_MANGLE,\n\t\t.mangle.htype = FLOW_ACT_MANGLE_HDR_TYPE_ETH,\n\t\t.mangle.offset = offsetof(struct vlan_ethhdr, h_vlan_TCI),\n\t\t.mangle.mask = ~(u32)be16_to_cpu(*(__be16 *)&mask16),\n\t\t.mangle.val = (u32)be16_to_cpu(*(__be16 *)&val16),\n\t};\n\tu8 match_prio_mask, match_prio_val;\n\tvoid *headers_c, *headers_v;\n\tint err;\n\n\theaders_c = mlx5e_get_match_headers_criteria(*action, &parse_attr->spec);\n\theaders_v = mlx5e_get_match_headers_value(*action, &parse_attr->spec);\n\n\tif (!(MLX5_GET(fte_match_set_lyr_2_4, headers_c, cvlan_tag) &&\n\t      MLX5_GET(fte_match_set_lyr_2_4, headers_v, cvlan_tag))) {\n\t\tNL_SET_ERR_MSG_MOD(extack, \"VLAN rewrite action must have VLAN protocol match\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tmatch_prio_mask = MLX5_GET(fte_match_set_lyr_2_4, headers_c, first_prio);\n\tmatch_prio_val = MLX5_GET(fte_match_set_lyr_2_4, headers_v, first_prio);\n\tif (act->vlan.prio != (match_prio_val & match_prio_mask)) {\n\t\tNL_SET_ERR_MSG_MOD(extack, \"Changing VLAN prio is not supported\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\terr = mlx5e_tc_act_pedit_parse_action(priv, &pedit_act, namespace, parse_attr->hdrs,\n\t\t\t\t\t      extack);\n\t*action |= MLX5_FLOW_CONTEXT_ACTION_MOD_HDR;\n\n\treturn err;\n}\n\nstatic int\ntc_act_parse_vlan_mangle(struct mlx5e_tc_act_parse_state *parse_state,\n\t\t\t const struct flow_action_entry *act,\n\t\t\t struct mlx5e_priv *priv,\n\t\t\t struct mlx5_flow_attr *attr)\n{\n\tenum mlx5_flow_namespace_type ns_type;\n\tint err;\n\n\tns_type = mlx5e_get_flow_namespace(parse_state->flow);\n\terr = mlx5e_tc_act_vlan_add_rewrite_action(priv, ns_type, act, attr->parse_attr,\n\t\t\t\t\t\t   &attr->action, parse_state->extack);\n\tif (err)\n\t\treturn err;\n\n\tif (ns_type == MLX5_FLOW_NAMESPACE_FDB) {\n\t\tattr->esw_attr->split_count = attr->esw_attr->out_count;\n\t\tparse_state->if_count = 0;\n\t}\n\n\treturn 0;\n}\n\nstruct mlx5e_tc_act mlx5e_tc_act_vlan_mangle = {\n\t.parse_action = tc_act_parse_vlan_mangle,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}