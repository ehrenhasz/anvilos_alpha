{
  "module_name": "dr_fw.c",
  "hash_id": "093f86cac9a6d90cc91e867fc34cffa8aaaf129e8def794da4c448b68529a4f1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_fw.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include \"dr_types.h\"\n\nstruct mlx5dr_fw_recalc_cs_ft *\nmlx5dr_fw_create_recalc_cs_ft(struct mlx5dr_domain *dmn, u16 vport_num)\n{\n\tstruct mlx5dr_cmd_create_flow_table_attr ft_attr = {};\n\tstruct mlx5dr_fw_recalc_cs_ft *recalc_cs_ft;\n\tu32 table_id, group_id, modify_hdr_id;\n\tu64 rx_icm_addr, modify_ttl_action;\n\tint ret;\n\n\trecalc_cs_ft = kzalloc(sizeof(*recalc_cs_ft), GFP_KERNEL);\n\tif (!recalc_cs_ft)\n\t\treturn NULL;\n\n\tft_attr.table_type = MLX5_FLOW_TABLE_TYPE_FDB;\n\tft_attr.level = dmn->info.caps.max_ft_level - 1;\n\tft_attr.term_tbl = true;\n\n\tret = mlx5dr_cmd_create_flow_table(dmn->mdev,\n\t\t\t\t\t   &ft_attr,\n\t\t\t\t\t   &rx_icm_addr,\n\t\t\t\t\t   &table_id);\n\tif (ret) {\n\t\tmlx5dr_err(dmn, \"Failed creating TTL W/A FW flow table %d\\n\", ret);\n\t\tgoto free_ttl_tbl;\n\t}\n\n\tret = mlx5dr_cmd_create_empty_flow_group(dmn->mdev,\n\t\t\t\t\t\t MLX5_FLOW_TABLE_TYPE_FDB,\n\t\t\t\t\t\t table_id, &group_id);\n\tif (ret) {\n\t\tmlx5dr_err(dmn, \"Failed creating TTL W/A FW flow group %d\\n\", ret);\n\t\tgoto destroy_flow_table;\n\t}\n\n\t \n\tmodify_ttl_action = 0;\n\tMLX5_SET(set_action_in, &modify_ttl_action, action_type, MLX5_ACTION_TYPE_ADD);\n\tMLX5_SET(set_action_in, &modify_ttl_action, field, MLX5_ACTION_IN_FIELD_OUT_IP_TTL);\n\n\tret = mlx5dr_cmd_alloc_modify_header(dmn->mdev, MLX5_FLOW_TABLE_TYPE_FDB, 1,\n\t\t\t\t\t     &modify_ttl_action,\n\t\t\t\t\t     &modify_hdr_id);\n\tif (ret) {\n\t\tmlx5dr_err(dmn, \"Failed modify header TTL %d\\n\", ret);\n\t\tgoto destroy_flow_group;\n\t}\n\n\tret = mlx5dr_cmd_set_fte_modify_and_vport(dmn->mdev,\n\t\t\t\t\t\t  MLX5_FLOW_TABLE_TYPE_FDB,\n\t\t\t\t\t\t  table_id, group_id, modify_hdr_id,\n\t\t\t\t\t\t  vport_num);\n\tif (ret) {\n\t\tmlx5dr_err(dmn, \"Failed setting TTL W/A flow table entry %d\\n\", ret);\n\t\tgoto dealloc_modify_header;\n\t}\n\n\trecalc_cs_ft->modify_hdr_id = modify_hdr_id;\n\trecalc_cs_ft->rx_icm_addr = rx_icm_addr;\n\trecalc_cs_ft->table_id = table_id;\n\trecalc_cs_ft->group_id = group_id;\n\n\treturn recalc_cs_ft;\n\ndealloc_modify_header:\n\tmlx5dr_cmd_dealloc_modify_header(dmn->mdev, modify_hdr_id);\ndestroy_flow_group:\n\tmlx5dr_cmd_destroy_flow_group(dmn->mdev,\n\t\t\t\t      MLX5_FLOW_TABLE_TYPE_FDB,\n\t\t\t\t      table_id, group_id);\ndestroy_flow_table:\n\tmlx5dr_cmd_destroy_flow_table(dmn->mdev, table_id, MLX5_FLOW_TABLE_TYPE_FDB);\nfree_ttl_tbl:\n\tkfree(recalc_cs_ft);\n\treturn NULL;\n}\n\nvoid mlx5dr_fw_destroy_recalc_cs_ft(struct mlx5dr_domain *dmn,\n\t\t\t\t    struct mlx5dr_fw_recalc_cs_ft *recalc_cs_ft)\n{\n\tmlx5dr_cmd_del_flow_table_entry(dmn->mdev,\n\t\t\t\t\tMLX5_FLOW_TABLE_TYPE_FDB,\n\t\t\t\t\trecalc_cs_ft->table_id);\n\tmlx5dr_cmd_dealloc_modify_header(dmn->mdev, recalc_cs_ft->modify_hdr_id);\n\tmlx5dr_cmd_destroy_flow_group(dmn->mdev,\n\t\t\t\t      MLX5_FLOW_TABLE_TYPE_FDB,\n\t\t\t\t      recalc_cs_ft->table_id,\n\t\t\t\t      recalc_cs_ft->group_id);\n\tmlx5dr_cmd_destroy_flow_table(dmn->mdev,\n\t\t\t\t      recalc_cs_ft->table_id,\n\t\t\t\t      MLX5_FLOW_TABLE_TYPE_FDB);\n\n\tkfree(recalc_cs_ft);\n}\n\nint mlx5dr_fw_create_md_tbl(struct mlx5dr_domain *dmn,\n\t\t\t    struct mlx5dr_cmd_flow_destination_hw_info *dest,\n\t\t\t    int num_dest,\n\t\t\t    bool reformat_req,\n\t\t\t    u32 *tbl_id,\n\t\t\t    u32 *group_id,\n\t\t\t    bool ignore_flow_level,\n\t\t\t    u32 flow_source)\n{\n\tstruct mlx5dr_cmd_create_flow_table_attr ft_attr = {};\n\tstruct mlx5dr_cmd_fte_info fte_info = {};\n\tu32 val[MLX5_ST_SZ_DW_MATCH_PARAM] = {};\n\tstruct mlx5dr_cmd_ft_info ft_info = {};\n\tint ret;\n\n\tft_attr.table_type = MLX5_FLOW_TABLE_TYPE_FDB;\n\tft_attr.level = min_t(int, dmn->info.caps.max_ft_level - 2,\n\t\t\t      MLX5_FT_MAX_MULTIPATH_LEVEL);\n\tft_attr.reformat_en = reformat_req;\n\tft_attr.decap_en = reformat_req;\n\n\tret = mlx5dr_cmd_create_flow_table(dmn->mdev, &ft_attr, NULL, tbl_id);\n\tif (ret) {\n\t\tmlx5dr_err(dmn, \"Failed creating multi dest FW flow table %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = mlx5dr_cmd_create_empty_flow_group(dmn->mdev,\n\t\t\t\t\t\t MLX5_FLOW_TABLE_TYPE_FDB,\n\t\t\t\t\t\t *tbl_id, group_id);\n\tif (ret) {\n\t\tmlx5dr_err(dmn, \"Failed creating multi dest FW flow group %d\\n\", ret);\n\t\tgoto free_flow_table;\n\t}\n\n\tft_info.id = *tbl_id;\n\tft_info.type = FS_FT_FDB;\n\tfte_info.action.action = MLX5_FLOW_CONTEXT_ACTION_FWD_DEST;\n\tfte_info.dests_size = num_dest;\n\tfte_info.val = val;\n\tfte_info.dest_arr = dest;\n\tfte_info.ignore_flow_level = ignore_flow_level;\n\tfte_info.flow_context.flow_source = flow_source;\n\n\tret = mlx5dr_cmd_set_fte(dmn->mdev, 0, 0, &ft_info, *group_id, &fte_info);\n\tif (ret) {\n\t\tmlx5dr_err(dmn, \"Failed setting fte into table %d\\n\", ret);\n\t\tgoto free_flow_group;\n\t}\n\n\treturn 0;\n\nfree_flow_group:\n\tmlx5dr_cmd_destroy_flow_group(dmn->mdev, MLX5_FLOW_TABLE_TYPE_FDB,\n\t\t\t\t      *tbl_id, *group_id);\nfree_flow_table:\n\tmlx5dr_cmd_destroy_flow_table(dmn->mdev, *tbl_id,\n\t\t\t\t      MLX5_FLOW_TABLE_TYPE_FDB);\n\treturn ret;\n}\n\nvoid mlx5dr_fw_destroy_md_tbl(struct mlx5dr_domain *dmn,\n\t\t\t      u32 tbl_id, u32 group_id)\n{\n\tmlx5dr_cmd_del_flow_table_entry(dmn->mdev, FS_FT_FDB, tbl_id);\n\tmlx5dr_cmd_destroy_flow_group(dmn->mdev,\n\t\t\t\t      MLX5_FLOW_TABLE_TYPE_FDB,\n\t\t\t\t      tbl_id, group_id);\n\tmlx5dr_cmd_destroy_flow_table(dmn->mdev, tbl_id,\n\t\t\t\t      MLX5_FLOW_TABLE_TYPE_FDB);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}