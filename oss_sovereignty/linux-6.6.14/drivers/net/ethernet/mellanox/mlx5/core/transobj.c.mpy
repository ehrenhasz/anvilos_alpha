{
  "module_name": "transobj.c",
  "hash_id": "906e3b9e17a42a6eda237ec4b88d5e4824407a0ed77427df447535bf1c8fb087",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/transobj.c",
  "human_readable_source": " \n\n#include <linux/mlx5/driver.h>\n#include \"mlx5_core.h\"\n#include <linux/mlx5/transobj.h>\n\nint mlx5_core_alloc_transport_domain(struct mlx5_core_dev *dev, u32 *tdn)\n{\n\tu32 out[MLX5_ST_SZ_DW(alloc_transport_domain_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(alloc_transport_domain_in)] = {};\n\tint err;\n\n\tMLX5_SET(alloc_transport_domain_in, in, opcode,\n\t\t MLX5_CMD_OP_ALLOC_TRANSPORT_DOMAIN);\n\n\terr = mlx5_cmd_exec_inout(dev, alloc_transport_domain, in, out);\n\tif (!err)\n\t\t*tdn = MLX5_GET(alloc_transport_domain_out, out,\n\t\t\t\ttransport_domain);\n\n\treturn err;\n}\nEXPORT_SYMBOL(mlx5_core_alloc_transport_domain);\n\nvoid mlx5_core_dealloc_transport_domain(struct mlx5_core_dev *dev, u32 tdn)\n{\n\tu32 in[MLX5_ST_SZ_DW(dealloc_transport_domain_in)] = {};\n\n\tMLX5_SET(dealloc_transport_domain_in, in, opcode,\n\t\t MLX5_CMD_OP_DEALLOC_TRANSPORT_DOMAIN);\n\tMLX5_SET(dealloc_transport_domain_in, in, transport_domain, tdn);\n\tmlx5_cmd_exec_in(dev, dealloc_transport_domain, in);\n}\nEXPORT_SYMBOL(mlx5_core_dealloc_transport_domain);\n\nint mlx5_core_create_rq(struct mlx5_core_dev *dev, u32 *in, int inlen, u32 *rqn)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_rq_out)] = {};\n\tint err;\n\n\tMLX5_SET(create_rq_in, in, opcode, MLX5_CMD_OP_CREATE_RQ);\n\terr = mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\n\tif (!err)\n\t\t*rqn = MLX5_GET(create_rq_out, out, rqn);\n\n\treturn err;\n}\nEXPORT_SYMBOL(mlx5_core_create_rq);\n\nint mlx5_core_modify_rq(struct mlx5_core_dev *dev, u32 rqn, u32 *in)\n{\n\tMLX5_SET(modify_rq_in, in, rqn, rqn);\n\tMLX5_SET(modify_rq_in, in, opcode, MLX5_CMD_OP_MODIFY_RQ);\n\n\treturn mlx5_cmd_exec_in(dev, modify_rq, in);\n}\nEXPORT_SYMBOL(mlx5_core_modify_rq);\n\nvoid mlx5_core_destroy_rq(struct mlx5_core_dev *dev, u32 rqn)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_rq_in)] = {};\n\n\tMLX5_SET(destroy_rq_in, in, opcode, MLX5_CMD_OP_DESTROY_RQ);\n\tMLX5_SET(destroy_rq_in, in, rqn, rqn);\n\tmlx5_cmd_exec_in(dev, destroy_rq, in);\n}\nEXPORT_SYMBOL(mlx5_core_destroy_rq);\n\nint mlx5_core_query_rq(struct mlx5_core_dev *dev, u32 rqn, u32 *out)\n{\n\tu32 in[MLX5_ST_SZ_DW(query_rq_in)] = {};\n\n\tMLX5_SET(query_rq_in, in, opcode, MLX5_CMD_OP_QUERY_RQ);\n\tMLX5_SET(query_rq_in, in, rqn, rqn);\n\n\treturn mlx5_cmd_exec_inout(dev, query_rq, in, out);\n}\nEXPORT_SYMBOL(mlx5_core_query_rq);\n\nint mlx5_core_create_sq(struct mlx5_core_dev *dev, u32 *in, int inlen, u32 *sqn)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_sq_out)] = {};\n\tint err;\n\n\tMLX5_SET(create_sq_in, in, opcode, MLX5_CMD_OP_CREATE_SQ);\n\terr = mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\n\tif (!err)\n\t\t*sqn = MLX5_GET(create_sq_out, out, sqn);\n\n\treturn err;\n}\n\nint mlx5_core_modify_sq(struct mlx5_core_dev *dev, u32 sqn, u32 *in)\n{\n\tMLX5_SET(modify_sq_in, in, sqn, sqn);\n\tMLX5_SET(modify_sq_in, in, opcode, MLX5_CMD_OP_MODIFY_SQ);\n\treturn mlx5_cmd_exec_in(dev, modify_sq, in);\n}\nEXPORT_SYMBOL(mlx5_core_modify_sq);\n\nvoid mlx5_core_destroy_sq(struct mlx5_core_dev *dev, u32 sqn)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_sq_in)] = {};\n\n\tMLX5_SET(destroy_sq_in, in, opcode, MLX5_CMD_OP_DESTROY_SQ);\n\tMLX5_SET(destroy_sq_in, in, sqn, sqn);\n\tmlx5_cmd_exec_in(dev, destroy_sq, in);\n}\n\nint mlx5_core_query_sq(struct mlx5_core_dev *dev, u32 sqn, u32 *out)\n{\n\tu32 in[MLX5_ST_SZ_DW(query_sq_in)] = {};\n\n\tMLX5_SET(query_sq_in, in, opcode, MLX5_CMD_OP_QUERY_SQ);\n\tMLX5_SET(query_sq_in, in, sqn, sqn);\n\treturn mlx5_cmd_exec_inout(dev, query_sq, in, out);\n}\nEXPORT_SYMBOL(mlx5_core_query_sq);\n\nint mlx5_core_query_sq_state(struct mlx5_core_dev *dev, u32 sqn, u8 *state)\n{\n\tvoid *out;\n\tvoid *sqc;\n\tint inlen;\n\tint err;\n\n\tinlen = MLX5_ST_SZ_BYTES(query_sq_out);\n\tout = kvzalloc(inlen, GFP_KERNEL);\n\tif (!out)\n\t\treturn -ENOMEM;\n\n\terr = mlx5_core_query_sq(dev, sqn, out);\n\tif (err)\n\t\tgoto out;\n\n\tsqc = MLX5_ADDR_OF(query_sq_out, out, sq_context);\n\t*state = MLX5_GET(sqc, sqc, state);\n\nout:\n\tkvfree(out);\n\treturn err;\n}\nEXPORT_SYMBOL_GPL(mlx5_core_query_sq_state);\n\nint mlx5_core_create_tir(struct mlx5_core_dev *dev, u32 *in, u32 *tirn)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_tir_out)] = {};\n\tint err;\n\n\tMLX5_SET(create_tir_in, in, opcode, MLX5_CMD_OP_CREATE_TIR);\n\terr = mlx5_cmd_exec_inout(dev, create_tir, in, out);\n\tif (!err)\n\t\t*tirn = MLX5_GET(create_tir_out, out, tirn);\n\n\treturn err;\n}\nEXPORT_SYMBOL(mlx5_core_create_tir);\n\nint mlx5_core_modify_tir(struct mlx5_core_dev *dev, u32 tirn, u32 *in)\n{\n\tMLX5_SET(modify_tir_in, in, tirn, tirn);\n\tMLX5_SET(modify_tir_in, in, opcode, MLX5_CMD_OP_MODIFY_TIR);\n\treturn mlx5_cmd_exec_in(dev, modify_tir, in);\n}\n\nvoid mlx5_core_destroy_tir(struct mlx5_core_dev *dev, u32 tirn)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_tir_in)] = {};\n\n\tMLX5_SET(destroy_tir_in, in, opcode, MLX5_CMD_OP_DESTROY_TIR);\n\tMLX5_SET(destroy_tir_in, in, tirn, tirn);\n\tmlx5_cmd_exec_in(dev, destroy_tir, in);\n}\nEXPORT_SYMBOL(mlx5_core_destroy_tir);\n\nint mlx5_core_create_tis(struct mlx5_core_dev *dev, u32 *in, u32 *tisn)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_tis_out)] = {};\n\tint err;\n\n\tMLX5_SET(create_tis_in, in, opcode, MLX5_CMD_OP_CREATE_TIS);\n\terr = mlx5_cmd_exec_inout(dev, create_tis, in, out);\n\tif (!err)\n\t\t*tisn = MLX5_GET(create_tis_out, out, tisn);\n\n\treturn err;\n}\nEXPORT_SYMBOL(mlx5_core_create_tis);\n\nint mlx5_core_modify_tis(struct mlx5_core_dev *dev, u32 tisn, u32 *in)\n{\n\tMLX5_SET(modify_tis_in, in, tisn, tisn);\n\tMLX5_SET(modify_tis_in, in, opcode, MLX5_CMD_OP_MODIFY_TIS);\n\n\treturn mlx5_cmd_exec_in(dev, modify_tis, in);\n}\nEXPORT_SYMBOL(mlx5_core_modify_tis);\n\nvoid mlx5_core_destroy_tis(struct mlx5_core_dev *dev, u32 tisn)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_tis_in)] = {};\n\n\tMLX5_SET(destroy_tis_in, in, opcode, MLX5_CMD_OP_DESTROY_TIS);\n\tMLX5_SET(destroy_tis_in, in, tisn, tisn);\n\tmlx5_cmd_exec_in(dev, destroy_tis, in);\n}\nEXPORT_SYMBOL(mlx5_core_destroy_tis);\n\nint mlx5_core_create_rqt(struct mlx5_core_dev *dev, u32 *in, int inlen,\n\t\t\t u32 *rqtn)\n{\n\tu32 out[MLX5_ST_SZ_DW(create_rqt_out)] = {};\n\tint err;\n\n\tMLX5_SET(create_rqt_in, in, opcode, MLX5_CMD_OP_CREATE_RQT);\n\terr = mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\n\tif (!err)\n\t\t*rqtn = MLX5_GET(create_rqt_out, out, rqtn);\n\n\treturn err;\n}\nEXPORT_SYMBOL(mlx5_core_create_rqt);\n\nint mlx5_core_modify_rqt(struct mlx5_core_dev *dev, u32 rqtn, u32 *in,\n\t\t\t int inlen)\n{\n\tu32 out[MLX5_ST_SZ_DW(modify_rqt_out)] = {};\n\n\tMLX5_SET(modify_rqt_in, in, rqtn, rqtn);\n\tMLX5_SET(modify_rqt_in, in, opcode, MLX5_CMD_OP_MODIFY_RQT);\n\treturn mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\n}\n\nvoid mlx5_core_destroy_rqt(struct mlx5_core_dev *dev, u32 rqtn)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_rqt_in)] = {};\n\n\tMLX5_SET(destroy_rqt_in, in, opcode, MLX5_CMD_OP_DESTROY_RQT);\n\tMLX5_SET(destroy_rqt_in, in, rqtn, rqtn);\n\tmlx5_cmd_exec_in(dev, destroy_rqt, in);\n}\nEXPORT_SYMBOL(mlx5_core_destroy_rqt);\n\nstatic int mlx5_hairpin_create_rq(struct mlx5_core_dev *mdev,\n\t\t\t\t  struct mlx5_hairpin_params *params, u32 *rqn)\n{\n\tu32 in[MLX5_ST_SZ_DW(create_rq_in)] = {0};\n\tvoid *rqc, *wq;\n\n\trqc = MLX5_ADDR_OF(create_rq_in, in, ctx);\n\twq  = MLX5_ADDR_OF(rqc, rqc, wq);\n\n\tMLX5_SET(rqc, rqc, hairpin, 1);\n\tMLX5_SET(rqc, rqc, state, MLX5_RQC_STATE_RST);\n\tMLX5_SET(rqc, rqc, counter_set_id, params->q_counter);\n\n\tMLX5_SET(wq, wq, log_hairpin_data_sz, params->log_data_size);\n\tMLX5_SET(wq, wq, log_hairpin_num_packets, params->log_num_packets);\n\n\treturn mlx5_core_create_rq(mdev, in, MLX5_ST_SZ_BYTES(create_rq_in), rqn);\n}\n\nstatic int mlx5_hairpin_create_sq(struct mlx5_core_dev *mdev,\n\t\t\t\t  struct mlx5_hairpin_params *params, u32 *sqn)\n{\n\tu32 in[MLX5_ST_SZ_DW(create_sq_in)] = {0};\n\tvoid *sqc, *wq;\n\n\tsqc = MLX5_ADDR_OF(create_sq_in, in, ctx);\n\twq  = MLX5_ADDR_OF(sqc, sqc, wq);\n\n\tMLX5_SET(sqc, sqc, hairpin, 1);\n\tMLX5_SET(sqc, sqc, state, MLX5_SQC_STATE_RST);\n\n\tMLX5_SET(wq, wq, log_hairpin_data_sz, params->log_data_size);\n\tMLX5_SET(wq, wq, log_hairpin_num_packets, params->log_num_packets);\n\n\treturn mlx5_core_create_sq(mdev, in, MLX5_ST_SZ_BYTES(create_sq_in), sqn);\n}\n\nstatic int mlx5_hairpin_create_queues(struct mlx5_hairpin *hp,\n\t\t\t\t      struct mlx5_hairpin_params *params)\n{\n\tint i, j, err;\n\n\tfor (i = 0; i < hp->num_channels; i++) {\n\t\terr = mlx5_hairpin_create_rq(hp->func_mdev, params, &hp->rqn[i]);\n\t\tif (err)\n\t\t\tgoto out_err_rq;\n\t}\n\n\tfor (i = 0; i < hp->num_channels; i++) {\n\t\terr = mlx5_hairpin_create_sq(hp->peer_mdev, params, &hp->sqn[i]);\n\t\tif (err)\n\t\t\tgoto out_err_sq;\n\t}\n\n\treturn 0;\n\nout_err_sq:\n\tfor (j = 0; j < i; j++)\n\t\tmlx5_core_destroy_sq(hp->peer_mdev, hp->sqn[j]);\n\ti = hp->num_channels;\nout_err_rq:\n\tfor (j = 0; j < i; j++)\n\t\tmlx5_core_destroy_rq(hp->func_mdev, hp->rqn[j]);\n\treturn err;\n}\n\nstatic void mlx5_hairpin_destroy_queues(struct mlx5_hairpin *hp)\n{\n\tint i;\n\n\tfor (i = 0; i < hp->num_channels; i++) {\n\t\tmlx5_core_destroy_rq(hp->func_mdev, hp->rqn[i]);\n\t\tif (!hp->peer_gone)\n\t\t\tmlx5_core_destroy_sq(hp->peer_mdev, hp->sqn[i]);\n\t}\n}\n\nstatic int mlx5_hairpin_modify_rq(struct mlx5_core_dev *func_mdev, u32 rqn,\n\t\t\t\t  int curr_state, int next_state,\n\t\t\t\t  u16 peer_vhca, u32 peer_sq)\n{\n\tu32 in[MLX5_ST_SZ_DW(modify_rq_in)] = {};\n\tvoid *rqc;\n\n\trqc = MLX5_ADDR_OF(modify_rq_in, in, ctx);\n\n\tif (next_state == MLX5_RQC_STATE_RDY) {\n\t\tMLX5_SET(rqc, rqc, hairpin_peer_sq, peer_sq);\n\t\tMLX5_SET(rqc, rqc, hairpin_peer_vhca, peer_vhca);\n\t}\n\n\tMLX5_SET(modify_rq_in, in, rq_state, curr_state);\n\tMLX5_SET(rqc, rqc, state, next_state);\n\n\treturn mlx5_core_modify_rq(func_mdev, rqn, in);\n}\n\nstatic int mlx5_hairpin_modify_sq(struct mlx5_core_dev *peer_mdev, u32 sqn,\n\t\t\t\t  int curr_state, int next_state,\n\t\t\t\t  u16 peer_vhca, u32 peer_rq)\n{\n\tu32 in[MLX5_ST_SZ_DW(modify_sq_in)] = {0};\n\tvoid *sqc;\n\n\tsqc = MLX5_ADDR_OF(modify_sq_in, in, ctx);\n\n\tif (next_state == MLX5_SQC_STATE_RDY) {\n\t\tMLX5_SET(sqc, sqc, hairpin_peer_rq, peer_rq);\n\t\tMLX5_SET(sqc, sqc, hairpin_peer_vhca, peer_vhca);\n\t}\n\n\tMLX5_SET(modify_sq_in, in, sq_state, curr_state);\n\tMLX5_SET(sqc, sqc, state, next_state);\n\n\treturn mlx5_core_modify_sq(peer_mdev, sqn, in);\n}\n\nstatic int mlx5_hairpin_pair_queues(struct mlx5_hairpin *hp)\n{\n\tint i, j, err;\n\n\t \n\tfor (i = 0; i < hp->num_channels; i++) {\n\t\terr = mlx5_hairpin_modify_sq(hp->peer_mdev, hp->sqn[i],\n\t\t\t\t\t     MLX5_SQC_STATE_RST, MLX5_SQC_STATE_RDY,\n\t\t\t\t\t     MLX5_CAP_GEN(hp->func_mdev, vhca_id), hp->rqn[i]);\n\t\tif (err)\n\t\t\tgoto err_modify_sq;\n\t}\n\n\t \n\tfor (i = 0; i < hp->num_channels; i++) {\n\t\terr = mlx5_hairpin_modify_rq(hp->func_mdev, hp->rqn[i],\n\t\t\t\t\t     MLX5_RQC_STATE_RST, MLX5_RQC_STATE_RDY,\n\t\t\t\t\t     MLX5_CAP_GEN(hp->peer_mdev, vhca_id), hp->sqn[i]);\n\t\tif (err)\n\t\t\tgoto err_modify_rq;\n\t}\n\n\treturn 0;\n\nerr_modify_rq:\n\tfor (j = 0; j < i; j++)\n\t\tmlx5_hairpin_modify_rq(hp->func_mdev, hp->rqn[j], MLX5_RQC_STATE_RDY,\n\t\t\t\t       MLX5_RQC_STATE_RST, 0, 0);\n\ti = hp->num_channels;\nerr_modify_sq:\n\tfor (j = 0; j < i; j++)\n\t\tmlx5_hairpin_modify_sq(hp->peer_mdev, hp->sqn[j], MLX5_SQC_STATE_RDY,\n\t\t\t\t       MLX5_SQC_STATE_RST, 0, 0);\n\treturn err;\n}\n\nstatic void mlx5_hairpin_unpair_peer_sq(struct mlx5_hairpin *hp)\n{\n\tint i;\n\n\tfor (i = 0; i < hp->num_channels; i++)\n\t\tmlx5_hairpin_modify_sq(hp->peer_mdev, hp->sqn[i], MLX5_SQC_STATE_RDY,\n\t\t\t\t       MLX5_SQC_STATE_RST, 0, 0);\n}\n\nstatic void mlx5_hairpin_unpair_queues(struct mlx5_hairpin *hp)\n{\n\tint i;\n\n\t \n\tfor (i = 0; i < hp->num_channels; i++)\n\t\tmlx5_hairpin_modify_rq(hp->func_mdev, hp->rqn[i], MLX5_RQC_STATE_RDY,\n\t\t\t\t       MLX5_RQC_STATE_RST, 0, 0);\n\t \n\tif (!hp->peer_gone)\n\t\tmlx5_hairpin_unpair_peer_sq(hp);\n}\n\nstruct mlx5_hairpin *\nmlx5_core_hairpin_create(struct mlx5_core_dev *func_mdev,\n\t\t\t struct mlx5_core_dev *peer_mdev,\n\t\t\t struct mlx5_hairpin_params *params)\n{\n\tstruct mlx5_hairpin *hp;\n\tint size, err;\n\n\tsize = sizeof(*hp) + params->num_channels * 2 * sizeof(u32);\n\thp = kzalloc(size, GFP_KERNEL);\n\tif (!hp)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\thp->func_mdev = func_mdev;\n\thp->peer_mdev = peer_mdev;\n\thp->num_channels = params->num_channels;\n\n\thp->rqn = (void *)hp + sizeof(*hp);\n\thp->sqn = hp->rqn + params->num_channels;\n\n\t \n\terr = mlx5_hairpin_create_queues(hp, params);\n\tif (err)\n\t\tgoto err_create_queues;\n\n\terr = mlx5_hairpin_pair_queues(hp);\n\tif (err)\n\t\tgoto err_pair_queues;\n\n\treturn hp;\n\nerr_pair_queues:\n\tmlx5_hairpin_destroy_queues(hp);\nerr_create_queues:\n\tkfree(hp);\n\treturn ERR_PTR(err);\n}\n\nvoid mlx5_core_hairpin_destroy(struct mlx5_hairpin *hp)\n{\n\tmlx5_hairpin_unpair_queues(hp);\n\tmlx5_hairpin_destroy_queues(hp);\n\tkfree(hp);\n}\n\nvoid mlx5_core_hairpin_clear_dead_peer(struct mlx5_hairpin *hp)\n{\n\tint i;\n\n\tmlx5_hairpin_unpair_peer_sq(hp);\n\n\t \n\tfor (i = 0; i < hp->num_channels; i++)\n\t\tmlx5_core_destroy_sq(hp->peer_mdev, hp->sqn[i]);\n\n\thp->peer_gone = true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}