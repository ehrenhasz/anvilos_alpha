{
  "module_name": "dr_dbg.c",
  "hash_id": "fba8658029cb4d34abe40a20cd6d47260ddbf26286d4a0e43f24259c9ef72aeb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_dbg.c",
  "human_readable_source": "\n\n\n#include <linux/debugfs.h>\n#include <linux/kernel.h>\n#include <linux/seq_file.h>\n#include <linux/version.h>\n#include \"dr_types.h\"\n\n#define DR_DBG_PTR_TO_ID(p) ((u64)(uintptr_t)(p) & 0xFFFFFFFFULL)\n\nenum dr_dump_rec_type {\n\tDR_DUMP_REC_TYPE_DOMAIN = 3000,\n\tDR_DUMP_REC_TYPE_DOMAIN_INFO_FLEX_PARSER = 3001,\n\tDR_DUMP_REC_TYPE_DOMAIN_INFO_DEV_ATTR = 3002,\n\tDR_DUMP_REC_TYPE_DOMAIN_INFO_VPORT = 3003,\n\tDR_DUMP_REC_TYPE_DOMAIN_INFO_CAPS = 3004,\n\tDR_DUMP_REC_TYPE_DOMAIN_SEND_RING = 3005,\n\n\tDR_DUMP_REC_TYPE_TABLE = 3100,\n\tDR_DUMP_REC_TYPE_TABLE_RX = 3101,\n\tDR_DUMP_REC_TYPE_TABLE_TX = 3102,\n\n\tDR_DUMP_REC_TYPE_MATCHER = 3200,\n\tDR_DUMP_REC_TYPE_MATCHER_MASK_DEPRECATED = 3201,\n\tDR_DUMP_REC_TYPE_MATCHER_RX = 3202,\n\tDR_DUMP_REC_TYPE_MATCHER_TX = 3203,\n\tDR_DUMP_REC_TYPE_MATCHER_BUILDER = 3204,\n\tDR_DUMP_REC_TYPE_MATCHER_MASK = 3205,\n\n\tDR_DUMP_REC_TYPE_RULE = 3300,\n\tDR_DUMP_REC_TYPE_RULE_RX_ENTRY_V0 = 3301,\n\tDR_DUMP_REC_TYPE_RULE_TX_ENTRY_V0 = 3302,\n\tDR_DUMP_REC_TYPE_RULE_RX_ENTRY_V1 = 3303,\n\tDR_DUMP_REC_TYPE_RULE_TX_ENTRY_V1 = 3304,\n\n\tDR_DUMP_REC_TYPE_ACTION_ENCAP_L2 = 3400,\n\tDR_DUMP_REC_TYPE_ACTION_ENCAP_L3 = 3401,\n\tDR_DUMP_REC_TYPE_ACTION_MODIFY_HDR = 3402,\n\tDR_DUMP_REC_TYPE_ACTION_DROP = 3403,\n\tDR_DUMP_REC_TYPE_ACTION_QP = 3404,\n\tDR_DUMP_REC_TYPE_ACTION_FT = 3405,\n\tDR_DUMP_REC_TYPE_ACTION_CTR = 3406,\n\tDR_DUMP_REC_TYPE_ACTION_TAG = 3407,\n\tDR_DUMP_REC_TYPE_ACTION_VPORT = 3408,\n\tDR_DUMP_REC_TYPE_ACTION_DECAP_L2 = 3409,\n\tDR_DUMP_REC_TYPE_ACTION_DECAP_L3 = 3410,\n\tDR_DUMP_REC_TYPE_ACTION_DEVX_TIR = 3411,\n\tDR_DUMP_REC_TYPE_ACTION_PUSH_VLAN = 3412,\n\tDR_DUMP_REC_TYPE_ACTION_POP_VLAN = 3413,\n\tDR_DUMP_REC_TYPE_ACTION_SAMPLER = 3415,\n\tDR_DUMP_REC_TYPE_ACTION_INSERT_HDR = 3420,\n\tDR_DUMP_REC_TYPE_ACTION_REMOVE_HDR = 3421,\n\tDR_DUMP_REC_TYPE_ACTION_MATCH_RANGE = 3425,\n};\n\nvoid mlx5dr_dbg_tbl_add(struct mlx5dr_table *tbl)\n{\n\tmutex_lock(&tbl->dmn->dump_info.dbg_mutex);\n\tlist_add_tail(&tbl->dbg_node, &tbl->dmn->dbg_tbl_list);\n\tmutex_unlock(&tbl->dmn->dump_info.dbg_mutex);\n}\n\nvoid mlx5dr_dbg_tbl_del(struct mlx5dr_table *tbl)\n{\n\tmutex_lock(&tbl->dmn->dump_info.dbg_mutex);\n\tlist_del(&tbl->dbg_node);\n\tmutex_unlock(&tbl->dmn->dump_info.dbg_mutex);\n}\n\nvoid mlx5dr_dbg_rule_add(struct mlx5dr_rule *rule)\n{\n\tstruct mlx5dr_domain *dmn = rule->matcher->tbl->dmn;\n\n\tmutex_lock(&dmn->dump_info.dbg_mutex);\n\tlist_add_tail(&rule->dbg_node, &rule->matcher->dbg_rule_list);\n\tmutex_unlock(&dmn->dump_info.dbg_mutex);\n}\n\nvoid mlx5dr_dbg_rule_del(struct mlx5dr_rule *rule)\n{\n\tstruct mlx5dr_domain *dmn = rule->matcher->tbl->dmn;\n\n\tmutex_lock(&dmn->dump_info.dbg_mutex);\n\tlist_del(&rule->dbg_node);\n\tmutex_unlock(&dmn->dump_info.dbg_mutex);\n}\n\nstatic u64 dr_dump_icm_to_idx(u64 icm_addr)\n{\n\treturn (icm_addr >> 6) & 0xffffffff;\n}\n\n#define DR_HEX_SIZE 256\n\nstatic void\ndr_dump_hex_print(char hex[DR_HEX_SIZE], char *src, u32 size)\n{\n\tif (WARN_ON_ONCE(DR_HEX_SIZE < 2 * size + 1))\n\t\tsize = DR_HEX_SIZE / 2 - 1;  \n\n\tbin2hex(hex, src, size);\n\thex[2 * size] = 0;  \n}\n\nstatic int\ndr_dump_rule_action_mem(struct seq_file *file, const u64 rule_id,\n\t\t\tstruct mlx5dr_rule_action_member *action_mem)\n{\n\tstruct mlx5dr_action *action = action_mem->action;\n\tconst u64 action_id = DR_DBG_PTR_TO_ID(action);\n\tu64 hit_tbl_ptr, miss_tbl_ptr;\n\tu32 hit_tbl_id, miss_tbl_id;\n\n\tswitch (action->action_type) {\n\tcase DR_ACTION_TYP_DROP:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_DROP, action_id, rule_id);\n\t\tbreak;\n\tcase DR_ACTION_TYP_FT:\n\t\tif (action->dest_tbl->is_fw_tbl)\n\t\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x,0x%x\\n\",\n\t\t\t\t   DR_DUMP_REC_TYPE_ACTION_FT, action_id,\n\t\t\t\t   rule_id, action->dest_tbl->fw_tbl.id,\n\t\t\t\t   -1);\n\t\telse\n\t\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x,0x%llx\\n\",\n\t\t\t\t   DR_DUMP_REC_TYPE_ACTION_FT, action_id,\n\t\t\t\t   rule_id, action->dest_tbl->tbl->table_id,\n\t\t\t\t   DR_DBG_PTR_TO_ID(action->dest_tbl->tbl));\n\n\t\tbreak;\n\tcase DR_ACTION_TYP_CTR:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_CTR, action_id, rule_id,\n\t\t\t   action->ctr->ctr_id + action->ctr->offset);\n\t\tbreak;\n\tcase DR_ACTION_TYP_TAG:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_TAG, action_id, rule_id,\n\t\t\t   action->flow_tag->flow_tag);\n\t\tbreak;\n\tcase DR_ACTION_TYP_MODIFY_HDR:\n\t{\n\t\tstruct mlx5dr_ptrn_obj *ptrn = action->rewrite->ptrn;\n\t\tstruct mlx5dr_arg_obj *arg = action->rewrite->arg;\n\t\tu8 *rewrite_data = action->rewrite->data;\n\t\tbool ptrn_arg;\n\t\tint i;\n\n\t\tptrn_arg = !action->rewrite->single_action_opt && ptrn && arg;\n\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x,%d,0x%x,0x%x,0x%x\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_MODIFY_HDR, action_id,\n\t\t\t   rule_id, action->rewrite->index,\n\t\t\t   action->rewrite->single_action_opt,\n\t\t\t   ptrn_arg ? action->rewrite->num_of_actions : 0,\n\t\t\t   ptrn_arg ? ptrn->index : 0,\n\t\t\t   ptrn_arg ? mlx5dr_arg_get_obj_id(arg) : 0);\n\n\t\tif (ptrn_arg) {\n\t\t\tfor (i = 0; i < action->rewrite->num_of_actions; i++) {\n\t\t\t\tseq_printf(file, \",0x%016llx\",\n\t\t\t\t\t   be64_to_cpu(((__be64 *)rewrite_data)[i]));\n\t\t\t}\n\t\t}\n\n\t\tseq_puts(file, \"\\n\");\n\t\tbreak;\n\t}\n\tcase DR_ACTION_TYP_VPORT:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_VPORT, action_id, rule_id,\n\t\t\t   action->vport->caps->num);\n\t\tbreak;\n\tcase DR_ACTION_TYP_TNL_L2_TO_L2:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_DECAP_L2, action_id,\n\t\t\t   rule_id);\n\t\tbreak;\n\tcase DR_ACTION_TYP_TNL_L3_TO_L2:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_DECAP_L3, action_id,\n\t\t\t   rule_id,\n\t\t\t   (action->rewrite->ptrn && action->rewrite->arg) ?\n\t\t\t   mlx5dr_arg_get_obj_id(action->rewrite->arg) :\n\t\t\t   action->rewrite->index);\n\t\tbreak;\n\tcase DR_ACTION_TYP_L2_TO_TNL_L2:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_ENCAP_L2, action_id,\n\t\t\t   rule_id, action->reformat->id);\n\t\tbreak;\n\tcase DR_ACTION_TYP_L2_TO_TNL_L3:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_ENCAP_L3, action_id,\n\t\t\t   rule_id, action->reformat->id);\n\t\tbreak;\n\tcase DR_ACTION_TYP_POP_VLAN:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_POP_VLAN, action_id,\n\t\t\t   rule_id);\n\t\tbreak;\n\tcase DR_ACTION_TYP_PUSH_VLAN:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_PUSH_VLAN, action_id,\n\t\t\t   rule_id, action->push_vlan->vlan_hdr);\n\t\tbreak;\n\tcase DR_ACTION_TYP_INSERT_HDR:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x,0x%x,0x%x\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_INSERT_HDR, action_id,\n\t\t\t   rule_id, action->reformat->id,\n\t\t\t   action->reformat->param_0,\n\t\t\t   action->reformat->param_1);\n\t\tbreak;\n\tcase DR_ACTION_TYP_REMOVE_HDR:\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x,0x%x,0x%x\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_REMOVE_HDR, action_id,\n\t\t\t   rule_id, action->reformat->id,\n\t\t\t   action->reformat->param_0,\n\t\t\t   action->reformat->param_1);\n\t\tbreak;\n\tcase DR_ACTION_TYP_SAMPLER:\n\t\tseq_printf(file,\n\t\t\t   \"%d,0x%llx,0x%llx,0x%x,0x%x,0x%x,0x%llx,0x%llx\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_SAMPLER, action_id, rule_id,\n\t\t\t   0, 0, action->sampler->sampler_id,\n\t\t\t   action->sampler->rx_icm_addr,\n\t\t\t   action->sampler->tx_icm_addr);\n\t\tbreak;\n\tcase DR_ACTION_TYP_RANGE:\n\t\tif (action->range->hit_tbl_action->dest_tbl->is_fw_tbl) {\n\t\t\thit_tbl_id = action->range->hit_tbl_action->dest_tbl->fw_tbl.id;\n\t\t\thit_tbl_ptr = 0;\n\t\t} else {\n\t\t\thit_tbl_id = action->range->hit_tbl_action->dest_tbl->tbl->table_id;\n\t\t\thit_tbl_ptr =\n\t\t\t\tDR_DBG_PTR_TO_ID(action->range->hit_tbl_action->dest_tbl->tbl);\n\t\t}\n\n\t\tif (action->range->miss_tbl_action->dest_tbl->is_fw_tbl) {\n\t\t\tmiss_tbl_id = action->range->miss_tbl_action->dest_tbl->fw_tbl.id;\n\t\t\tmiss_tbl_ptr = 0;\n\t\t} else {\n\t\t\tmiss_tbl_id = action->range->miss_tbl_action->dest_tbl->tbl->table_id;\n\t\t\tmiss_tbl_ptr =\n\t\t\t\tDR_DBG_PTR_TO_ID(action->range->miss_tbl_action->dest_tbl->tbl);\n\t\t}\n\n\t\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x,0x%llx,0x%x,0x%llx,0x%x\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_ACTION_MATCH_RANGE, action_id, rule_id,\n\t\t\t   hit_tbl_id, hit_tbl_ptr, miss_tbl_id, miss_tbl_ptr,\n\t\t\t   action->range->definer_id);\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\treturn 0;\n}\n\nstatic int\ndr_dump_rule_mem(struct seq_file *file, struct mlx5dr_ste *ste,\n\t\t bool is_rx, const u64 rule_id, u8 format_ver)\n{\n\tchar hw_ste_dump[DR_HEX_SIZE];\n\tu32 mem_rec_type;\n\n\tif (format_ver == MLX5_STEERING_FORMAT_CONNECTX_5) {\n\t\tmem_rec_type = is_rx ? DR_DUMP_REC_TYPE_RULE_RX_ENTRY_V0 :\n\t\t\t\t       DR_DUMP_REC_TYPE_RULE_TX_ENTRY_V0;\n\t} else {\n\t\tmem_rec_type = is_rx ? DR_DUMP_REC_TYPE_RULE_RX_ENTRY_V1 :\n\t\t\t\t       DR_DUMP_REC_TYPE_RULE_TX_ENTRY_V1;\n\t}\n\n\tdr_dump_hex_print(hw_ste_dump, (char *)mlx5dr_ste_get_hw_ste(ste),\n\t\t\t  DR_STE_SIZE_REDUCED);\n\n\tseq_printf(file, \"%d,0x%llx,0x%llx,%s\\n\", mem_rec_type,\n\t\t   dr_dump_icm_to_idx(mlx5dr_ste_get_icm_addr(ste)), rule_id,\n\t\t   hw_ste_dump);\n\n\treturn 0;\n}\n\nstatic int\ndr_dump_rule_rx_tx(struct seq_file *file, struct mlx5dr_rule_rx_tx *rule_rx_tx,\n\t\t   bool is_rx, const u64 rule_id, u8 format_ver)\n{\n\tstruct mlx5dr_ste *ste_arr[DR_RULE_MAX_STES + DR_ACTION_MAX_STES];\n\tstruct mlx5dr_ste *curr_ste = rule_rx_tx->last_rule_ste;\n\tint ret, i;\n\n\tif (mlx5dr_rule_get_reverse_rule_members(ste_arr, curr_ste, &i))\n\t\treturn 0;\n\n\twhile (i--) {\n\t\tret = dr_dump_rule_mem(file, ste_arr[i], is_rx, rule_id,\n\t\t\t\t       format_ver);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int dr_dump_rule(struct seq_file *file, struct mlx5dr_rule *rule)\n{\n\tstruct mlx5dr_rule_action_member *action_mem;\n\tconst u64 rule_id = DR_DBG_PTR_TO_ID(rule);\n\tstruct mlx5dr_rule_rx_tx *rx = &rule->rx;\n\tstruct mlx5dr_rule_rx_tx *tx = &rule->tx;\n\tu8 format_ver;\n\tint ret;\n\n\tformat_ver = rule->matcher->tbl->dmn->info.caps.sw_format_ver;\n\n\tseq_printf(file, \"%d,0x%llx,0x%llx\\n\", DR_DUMP_REC_TYPE_RULE, rule_id,\n\t\t   DR_DBG_PTR_TO_ID(rule->matcher));\n\n\tif (rx->nic_matcher) {\n\t\tret = dr_dump_rule_rx_tx(file, rx, true, rule_id, format_ver);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (tx->nic_matcher) {\n\t\tret = dr_dump_rule_rx_tx(file, tx, false, rule_id, format_ver);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tlist_for_each_entry(action_mem, &rule->rule_actions_list, list) {\n\t\tret = dr_dump_rule_action_mem(file, rule_id, action_mem);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int\ndr_dump_matcher_mask(struct seq_file *file, struct mlx5dr_match_param *mask,\n\t\t     u8 criteria, const u64 matcher_id)\n{\n\tchar dump[DR_HEX_SIZE];\n\n\tseq_printf(file, \"%d,0x%llx,\", DR_DUMP_REC_TYPE_MATCHER_MASK,\n\t\t   matcher_id);\n\n\tif (criteria & DR_MATCHER_CRITERIA_OUTER) {\n\t\tdr_dump_hex_print(dump, (char *)&mask->outer, sizeof(mask->outer));\n\t\tseq_printf(file, \"%s,\", dump);\n\t} else {\n\t\tseq_puts(file, \",\");\n\t}\n\n\tif (criteria & DR_MATCHER_CRITERIA_INNER) {\n\t\tdr_dump_hex_print(dump, (char *)&mask->inner, sizeof(mask->inner));\n\t\tseq_printf(file, \"%s,\", dump);\n\t} else {\n\t\tseq_puts(file, \",\");\n\t}\n\n\tif (criteria & DR_MATCHER_CRITERIA_MISC) {\n\t\tdr_dump_hex_print(dump, (char *)&mask->misc, sizeof(mask->misc));\n\t\tseq_printf(file, \"%s,\", dump);\n\t} else {\n\t\tseq_puts(file, \",\");\n\t}\n\n\tif (criteria & DR_MATCHER_CRITERIA_MISC2) {\n\t\tdr_dump_hex_print(dump, (char *)&mask->misc2, sizeof(mask->misc2));\n\t\tseq_printf(file, \"%s,\", dump);\n\t} else {\n\t\tseq_puts(file, \",\");\n\t}\n\n\tif (criteria & DR_MATCHER_CRITERIA_MISC3) {\n\t\tdr_dump_hex_print(dump, (char *)&mask->misc3, sizeof(mask->misc3));\n\t\tseq_printf(file, \"%s\\n\", dump);\n\t} else {\n\t\tseq_puts(file, \",\\n\");\n\t}\n\n\treturn 0;\n}\n\nstatic int\ndr_dump_matcher_builder(struct seq_file *file, struct mlx5dr_ste_build *builder,\n\t\t\tu32 index, bool is_rx, const u64 matcher_id)\n{\n\tseq_printf(file, \"%d,0x%llx,%d,%d,0x%x\\n\",\n\t\t   DR_DUMP_REC_TYPE_MATCHER_BUILDER, matcher_id, index, is_rx,\n\t\t   builder->lu_type);\n\n\treturn 0;\n}\n\nstatic int\ndr_dump_matcher_rx_tx(struct seq_file *file, bool is_rx,\n\t\t      struct mlx5dr_matcher_rx_tx *matcher_rx_tx,\n\t\t      const u64 matcher_id)\n{\n\tenum dr_dump_rec_type rec_type;\n\tu64 s_icm_addr, e_icm_addr;\n\tint i, ret;\n\n\trec_type = is_rx ? DR_DUMP_REC_TYPE_MATCHER_RX :\n\t\t\t   DR_DUMP_REC_TYPE_MATCHER_TX;\n\n\ts_icm_addr = mlx5dr_icm_pool_get_chunk_icm_addr(matcher_rx_tx->s_htbl->chunk);\n\te_icm_addr = mlx5dr_icm_pool_get_chunk_icm_addr(matcher_rx_tx->e_anchor->chunk);\n\tseq_printf(file, \"%d,0x%llx,0x%llx,%d,0x%llx,0x%llx\\n\",\n\t\t   rec_type, DR_DBG_PTR_TO_ID(matcher_rx_tx),\n\t\t   matcher_id, matcher_rx_tx->num_of_builders,\n\t\t   dr_dump_icm_to_idx(s_icm_addr),\n\t\t   dr_dump_icm_to_idx(e_icm_addr));\n\n\tfor (i = 0; i < matcher_rx_tx->num_of_builders; i++) {\n\t\tret = dr_dump_matcher_builder(file,\n\t\t\t\t\t      &matcher_rx_tx->ste_builder[i],\n\t\t\t\t\t      i, is_rx, matcher_id);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int\ndr_dump_matcher(struct seq_file *file, struct mlx5dr_matcher *matcher)\n{\n\tstruct mlx5dr_matcher_rx_tx *rx = &matcher->rx;\n\tstruct mlx5dr_matcher_rx_tx *tx = &matcher->tx;\n\tu64 matcher_id;\n\tint ret;\n\n\tmatcher_id = DR_DBG_PTR_TO_ID(matcher);\n\n\tseq_printf(file, \"%d,0x%llx,0x%llx,%d\\n\", DR_DUMP_REC_TYPE_MATCHER,\n\t\t   matcher_id, DR_DBG_PTR_TO_ID(matcher->tbl), matcher->prio);\n\n\tret = dr_dump_matcher_mask(file, &matcher->mask,\n\t\t\t\t   matcher->match_criteria, matcher_id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (rx->nic_tbl) {\n\t\tret = dr_dump_matcher_rx_tx(file, true, rx, matcher_id);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (tx->nic_tbl) {\n\t\tret = dr_dump_matcher_rx_tx(file, false, tx, matcher_id);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int\ndr_dump_matcher_all(struct seq_file *file, struct mlx5dr_matcher *matcher)\n{\n\tstruct mlx5dr_rule *rule;\n\tint ret;\n\n\tret = dr_dump_matcher(file, matcher);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tlist_for_each_entry(rule, &matcher->dbg_rule_list, dbg_node) {\n\t\tret = dr_dump_rule(file, rule);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int\ndr_dump_table_rx_tx(struct seq_file *file, bool is_rx,\n\t\t    struct mlx5dr_table_rx_tx *table_rx_tx,\n\t\t    const u64 table_id)\n{\n\tenum dr_dump_rec_type rec_type;\n\tu64 s_icm_addr;\n\n\trec_type = is_rx ? DR_DUMP_REC_TYPE_TABLE_RX :\n\t\t\t   DR_DUMP_REC_TYPE_TABLE_TX;\n\n\ts_icm_addr = mlx5dr_icm_pool_get_chunk_icm_addr(table_rx_tx->s_anchor->chunk);\n\tseq_printf(file, \"%d,0x%llx,0x%llx\\n\", rec_type, table_id,\n\t\t   dr_dump_icm_to_idx(s_icm_addr));\n\n\treturn 0;\n}\n\nstatic int dr_dump_table(struct seq_file *file, struct mlx5dr_table *table)\n{\n\tstruct mlx5dr_table_rx_tx *rx = &table->rx;\n\tstruct mlx5dr_table_rx_tx *tx = &table->tx;\n\tint ret;\n\n\tseq_printf(file, \"%d,0x%llx,0x%llx,%d,%d\\n\", DR_DUMP_REC_TYPE_TABLE,\n\t\t   DR_DBG_PTR_TO_ID(table), DR_DBG_PTR_TO_ID(table->dmn),\n\t\t   table->table_type, table->level);\n\n\tif (rx->nic_dmn) {\n\t\tret = dr_dump_table_rx_tx(file, true, rx,\n\t\t\t\t\t  DR_DBG_PTR_TO_ID(table));\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (tx->nic_dmn) {\n\t\tret = dr_dump_table_rx_tx(file, false, tx,\n\t\t\t\t\t  DR_DBG_PTR_TO_ID(table));\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic int dr_dump_table_all(struct seq_file *file, struct mlx5dr_table *tbl)\n{\n\tstruct mlx5dr_matcher *matcher;\n\tint ret;\n\n\tret = dr_dump_table(file, tbl);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tlist_for_each_entry(matcher, &tbl->matcher_list, list_node) {\n\t\tret = dr_dump_matcher_all(file, matcher);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic int\ndr_dump_send_ring(struct seq_file *file, struct mlx5dr_send_ring *ring,\n\t\t  const u64 domain_id)\n{\n\tseq_printf(file, \"%d,0x%llx,0x%llx,0x%x,0x%x\\n\",\n\t\t   DR_DUMP_REC_TYPE_DOMAIN_SEND_RING, DR_DBG_PTR_TO_ID(ring),\n\t\t   domain_id, ring->cq->mcq.cqn, ring->qp->qpn);\n\treturn 0;\n}\n\nstatic int\ndr_dump_domain_info_flex_parser(struct seq_file *file,\n\t\t\t\tconst char *flex_parser_name,\n\t\t\t\tconst u8 flex_parser_value,\n\t\t\t\tconst u64 domain_id)\n{\n\tseq_printf(file, \"%d,0x%llx,%s,0x%x\\n\",\n\t\t   DR_DUMP_REC_TYPE_DOMAIN_INFO_FLEX_PARSER, domain_id,\n\t\t   flex_parser_name, flex_parser_value);\n\treturn 0;\n}\n\nstatic int\ndr_dump_domain_info_caps(struct seq_file *file, struct mlx5dr_cmd_caps *caps,\n\t\t\t const u64 domain_id)\n{\n\tstruct mlx5dr_cmd_vport_cap *vport_caps;\n\tunsigned long i, vports_num;\n\n\txa_for_each(&caps->vports.vports_caps_xa, vports_num, vport_caps)\n\t\t;  \n\n\tseq_printf(file, \"%d,0x%llx,0x%x,0x%llx,0x%llx,0x%x,%lu,%d\\n\",\n\t\t   DR_DUMP_REC_TYPE_DOMAIN_INFO_CAPS, domain_id, caps->gvmi,\n\t\t   caps->nic_rx_drop_address, caps->nic_tx_drop_address,\n\t\t   caps->flex_protocols, vports_num, caps->eswitch_manager);\n\n\txa_for_each(&caps->vports.vports_caps_xa, i, vport_caps) {\n\t\tvport_caps = xa_load(&caps->vports.vports_caps_xa, i);\n\n\t\tseq_printf(file, \"%d,0x%llx,%lu,0x%x,0x%llx,0x%llx\\n\",\n\t\t\t   DR_DUMP_REC_TYPE_DOMAIN_INFO_VPORT, domain_id, i,\n\t\t\t   vport_caps->vport_gvmi, vport_caps->icm_address_rx,\n\t\t\t   vport_caps->icm_address_tx);\n\t}\n\treturn 0;\n}\n\nstatic int\ndr_dump_domain_info(struct seq_file *file, struct mlx5dr_domain_info *info,\n\t\t    const u64 domain_id)\n{\n\tint ret;\n\n\tret = dr_dump_domain_info_caps(file, &info->caps, domain_id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = dr_dump_domain_info_flex_parser(file, \"icmp_dw0\",\n\t\t\t\t\t      info->caps.flex_parser_id_icmp_dw0,\n\t\t\t\t\t      domain_id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = dr_dump_domain_info_flex_parser(file, \"icmp_dw1\",\n\t\t\t\t\t      info->caps.flex_parser_id_icmp_dw1,\n\t\t\t\t\t      domain_id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = dr_dump_domain_info_flex_parser(file, \"icmpv6_dw0\",\n\t\t\t\t\t      info->caps.flex_parser_id_icmpv6_dw0,\n\t\t\t\t\t      domain_id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = dr_dump_domain_info_flex_parser(file, \"icmpv6_dw1\",\n\t\t\t\t\t      info->caps.flex_parser_id_icmpv6_dw1,\n\t\t\t\t\t      domain_id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int\ndr_dump_domain(struct seq_file *file, struct mlx5dr_domain *dmn)\n{\n\tu64 domain_id = DR_DBG_PTR_TO_ID(dmn);\n\tint ret;\n\n\tseq_printf(file, \"%d,0x%llx,%d,0%x,%d,%u.%u.%u,%s,%d,%u,%u,%u\\n\",\n\t\t   DR_DUMP_REC_TYPE_DOMAIN,\n\t\t   domain_id, dmn->type, dmn->info.caps.gvmi,\n\t\t   dmn->info.supp_sw_steering,\n\t\t    \n\t\t   LINUX_VERSION_MAJOR, LINUX_VERSION_PATCHLEVEL,\n\t\t   LINUX_VERSION_SUBLEVEL,\n\t\t   pci_name(dmn->mdev->pdev),\n\t\t   0,  \n\t\t   dmn->num_buddies[DR_ICM_TYPE_STE],\n\t\t   dmn->num_buddies[DR_ICM_TYPE_MODIFY_ACTION],\n\t\t   dmn->num_buddies[DR_ICM_TYPE_MODIFY_HDR_PTRN]);\n\n\tret = dr_dump_domain_info(file, &dmn->info, domain_id);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (dmn->info.supp_sw_steering) {\n\t\tret = dr_dump_send_ring(file, dmn->send_ring, domain_id);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int dr_dump_domain_all(struct seq_file *file, struct mlx5dr_domain *dmn)\n{\n\tstruct mlx5dr_table *tbl;\n\tint ret;\n\n\tmutex_lock(&dmn->dump_info.dbg_mutex);\n\tmlx5dr_domain_lock(dmn);\n\n\tret = dr_dump_domain(file, dmn);\n\tif (ret < 0)\n\t\tgoto unlock_mutex;\n\n\tlist_for_each_entry(tbl, &dmn->dbg_tbl_list, dbg_node) {\n\t\tret = dr_dump_table_all(file, tbl);\n\t\tif (ret < 0)\n\t\t\tbreak;\n\t}\n\nunlock_mutex:\n\tmlx5dr_domain_unlock(dmn);\n\tmutex_unlock(&dmn->dump_info.dbg_mutex);\n\treturn ret;\n}\n\nstatic int dr_dump_show(struct seq_file *file, void *priv)\n{\n\treturn dr_dump_domain_all(file, file->private);\n}\nDEFINE_SHOW_ATTRIBUTE(dr_dump);\n\nvoid mlx5dr_dbg_init_dump(struct mlx5dr_domain *dmn)\n{\n\tstruct mlx5_core_dev *dev = dmn->mdev;\n\tchar file_name[128];\n\n\tif (dmn->type != MLX5DR_DOMAIN_TYPE_FDB) {\n\t\tmlx5_core_warn(dev,\n\t\t\t       \"Steering dump is not supported for NIC RX/TX domains\\n\");\n\t\treturn;\n\t}\n\n\tdmn->dump_info.steering_debugfs =\n\t\tdebugfs_create_dir(\"steering\", mlx5_debugfs_get_dev_root(dev));\n\tdmn->dump_info.fdb_debugfs =\n\t\tdebugfs_create_dir(\"fdb\", dmn->dump_info.steering_debugfs);\n\n\tsprintf(file_name, \"dmn_%p\", dmn);\n\tdebugfs_create_file(file_name, 0444, dmn->dump_info.fdb_debugfs,\n\t\t\t    dmn, &dr_dump_fops);\n\n\tINIT_LIST_HEAD(&dmn->dbg_tbl_list);\n\tmutex_init(&dmn->dump_info.dbg_mutex);\n}\n\nvoid mlx5dr_dbg_uninit_dump(struct mlx5dr_domain *dmn)\n{\n\tdebugfs_remove_recursive(dmn->dump_info.steering_debugfs);\n\tmutex_destroy(&dmn->dump_info.dbg_mutex);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}