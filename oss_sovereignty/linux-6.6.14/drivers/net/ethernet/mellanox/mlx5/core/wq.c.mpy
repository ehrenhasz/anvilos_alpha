{
  "module_name": "wq.c",
  "hash_id": "e807ee88bfb01197c1ccbfaf6a43abc49b71250c846ffc50f3515cafd9f8a0c9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/wq.c",
  "human_readable_source": " \n\n#include <linux/mlx5/driver.h>\n#include \"wq.h\"\n#include \"mlx5_core.h\"\n\nint mlx5_wq_cyc_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\n\t\t       void *wqc, struct mlx5_wq_cyc *wq,\n\t\t       struct mlx5_wq_ctrl *wq_ctrl)\n{\n\tu8 log_wq_stride = MLX5_GET(wq, wqc, log_wq_stride);\n\tu8 log_wq_sz     = MLX5_GET(wq, wqc, log_wq_sz);\n\tstruct mlx5_frag_buf_ctrl *fbc = &wq->fbc;\n\tint err;\n\n\terr = mlx5_db_alloc_node(mdev, &wq_ctrl->db, param->db_numa_node);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"mlx5_db_alloc_node() failed, %d\\n\", err);\n\t\treturn err;\n\t}\n\n\twq->db  = wq_ctrl->db.db;\n\n\terr = mlx5_frag_buf_alloc_node(mdev, wq_get_byte_sz(log_wq_sz, log_wq_stride),\n\t\t\t\t       &wq_ctrl->buf, param->buf_numa_node);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"mlx5_frag_buf_alloc_node() failed, %d\\n\", err);\n\t\tgoto err_db_free;\n\t}\n\n\tmlx5_init_fbc(wq_ctrl->buf.frags, log_wq_stride, log_wq_sz, fbc);\n\twq->sz = mlx5_wq_cyc_get_size(wq);\n\n\twq_ctrl->mdev = mdev;\n\n\treturn 0;\n\nerr_db_free:\n\tmlx5_db_free(mdev, &wq_ctrl->db);\n\n\treturn err;\n}\n\nvoid mlx5_wq_cyc_wqe_dump(struct mlx5_wq_cyc *wq, u16 ix, u8 nstrides)\n{\n\tsize_t len;\n\tvoid *wqe;\n\n\tif (!net_ratelimit())\n\t\treturn;\n\n\tnstrides = max_t(u8, nstrides, 1);\n\n\tlen = nstrides << wq->fbc.log_stride;\n\twqe = mlx5_wq_cyc_get_wqe(wq, ix);\n\n\tpr_info(\"WQE DUMP: WQ size %d WQ cur size %d, WQE index 0x%x, len: %zu\\n\",\n\t\tmlx5_wq_cyc_get_size(wq), wq->cur_sz, ix, len);\n\tprint_hex_dump(KERN_WARNING, \"\", DUMP_PREFIX_OFFSET, 16, 1, wqe, len, false);\n}\n\nvoid mlx5_wq_cyc_reset(struct mlx5_wq_cyc *wq)\n{\n\twq->wqe_ctr = 0;\n\twq->cur_sz = 0;\n\tmlx5_wq_cyc_update_db_record(wq);\n}\n\nint mlx5_wq_qp_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\n\t\t      void *qpc, struct mlx5_wq_qp *wq,\n\t\t      struct mlx5_wq_ctrl *wq_ctrl)\n{\n\tu8 log_rq_stride = MLX5_GET(qpc, qpc, log_rq_stride) + 4;\n\tu8 log_rq_sz     = MLX5_GET(qpc, qpc, log_rq_size);\n\tu8 log_sq_stride = ilog2(MLX5_SEND_WQE_BB);\n\tu8 log_sq_sz     = MLX5_GET(qpc, qpc, log_sq_size);\n\n\tu32 rq_byte_size;\n\tint err;\n\n\n\n\terr = mlx5_db_alloc_node(mdev, &wq_ctrl->db, param->db_numa_node);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"mlx5_db_alloc_node() failed, %d\\n\", err);\n\t\treturn err;\n\t}\n\n\terr = mlx5_frag_buf_alloc_node(mdev,\n\t\t\t\t       wq_get_byte_sz(log_rq_sz, log_rq_stride) +\n\t\t\t\t       wq_get_byte_sz(log_sq_sz, log_sq_stride),\n\t\t\t\t       &wq_ctrl->buf, param->buf_numa_node);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"mlx5_frag_buf_alloc_node() failed, %d\\n\", err);\n\t\tgoto err_db_free;\n\t}\n\n\tmlx5_init_fbc(wq_ctrl->buf.frags, log_rq_stride, log_rq_sz, &wq->rq.fbc);\n\n\trq_byte_size = wq_get_byte_sz(log_rq_sz, log_rq_stride);\n\n\tif (rq_byte_size < PAGE_SIZE) {\n\t\t \n\t\tu16 sq_strides_offset = rq_byte_size / MLX5_SEND_WQE_BB;\n\n\t\tmlx5_init_fbc_offset(wq_ctrl->buf.frags,\n\t\t\t\t     log_sq_stride, log_sq_sz, sq_strides_offset,\n\t\t\t\t     &wq->sq.fbc);\n\t} else {\n\t\tu16 rq_npages = rq_byte_size >> PAGE_SHIFT;\n\n\t\tmlx5_init_fbc(wq_ctrl->buf.frags + rq_npages,\n\t\t\t      log_sq_stride, log_sq_sz, &wq->sq.fbc);\n\t}\n\n\twq->rq.db  = &wq_ctrl->db.db[MLX5_RCV_DBR];\n\twq->sq.db  = &wq_ctrl->db.db[MLX5_SND_DBR];\n\n\twq_ctrl->mdev = mdev;\n\n\treturn 0;\n\nerr_db_free:\n\tmlx5_db_free(mdev, &wq_ctrl->db);\n\n\treturn err;\n}\n\nint mlx5_cqwq_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\n\t\t     void *cqc, struct mlx5_cqwq *wq,\n\t\t     struct mlx5_wq_ctrl *wq_ctrl)\n{\n\t \n\tu8 log_wq_stride = MLX5_GET(cqc, cqc, cqe_sz) == CQE_STRIDE_64 ? 6 : 7;\n\tu8 log_wq_sz     = MLX5_GET(cqc, cqc, log_cq_size);\n\tint err;\n\n\terr = mlx5_db_alloc_node(mdev, &wq_ctrl->db, param->db_numa_node);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"mlx5_db_alloc_node() failed, %d\\n\", err);\n\t\treturn err;\n\t}\n\n\twq->db  = wq_ctrl->db.db;\n\n\terr = mlx5_frag_buf_alloc_node(mdev, wq_get_byte_sz(log_wq_sz, log_wq_stride),\n\t\t\t\t       &wq_ctrl->buf,\n\t\t\t\t       param->buf_numa_node);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"mlx5_frag_buf_alloc_node() failed, %d\\n\",\n\t\t\t       err);\n\t\tgoto err_db_free;\n\t}\n\n\tmlx5_init_fbc(wq_ctrl->buf.frags, log_wq_stride, log_wq_sz, &wq->fbc);\n\n\twq_ctrl->mdev = mdev;\n\n\treturn 0;\n\nerr_db_free:\n\tmlx5_db_free(mdev, &wq_ctrl->db);\n\n\treturn err;\n}\n\nstatic void mlx5_wq_ll_init_list(struct mlx5_wq_ll *wq)\n{\n\tstruct mlx5_wqe_srq_next_seg *next_seg;\n\tint i;\n\n\tfor (i = 0; i < wq->fbc.sz_m1; i++) {\n\t\tnext_seg = mlx5_wq_ll_get_wqe(wq, i);\n\t\tnext_seg->next_wqe_index = cpu_to_be16(i + 1);\n\t}\n\tnext_seg = mlx5_wq_ll_get_wqe(wq, i);\n\twq->tail_next = &next_seg->next_wqe_index;\n}\n\nint mlx5_wq_ll_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\n\t\t      void *wqc, struct mlx5_wq_ll *wq,\n\t\t      struct mlx5_wq_ctrl *wq_ctrl)\n{\n\tu8 log_wq_stride = MLX5_GET(wq, wqc, log_wq_stride);\n\tu8 log_wq_sz     = MLX5_GET(wq, wqc, log_wq_sz);\n\tstruct mlx5_frag_buf_ctrl *fbc = &wq->fbc;\n\tint err;\n\n\terr = mlx5_db_alloc_node(mdev, &wq_ctrl->db, param->db_numa_node);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"mlx5_db_alloc_node() failed, %d\\n\", err);\n\t\treturn err;\n\t}\n\n\twq->db  = wq_ctrl->db.db;\n\n\terr = mlx5_frag_buf_alloc_node(mdev, wq_get_byte_sz(log_wq_sz, log_wq_stride),\n\t\t\t\t       &wq_ctrl->buf, param->buf_numa_node);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"mlx5_frag_buf_alloc_node() failed, %d\\n\", err);\n\t\tgoto err_db_free;\n\t}\n\n\tmlx5_init_fbc(wq_ctrl->buf.frags, log_wq_stride, log_wq_sz, fbc);\n\n\tmlx5_wq_ll_init_list(wq);\n\twq_ctrl->mdev = mdev;\n\n\treturn 0;\n\nerr_db_free:\n\tmlx5_db_free(mdev, &wq_ctrl->db);\n\n\treturn err;\n}\n\nvoid mlx5_wq_ll_reset(struct mlx5_wq_ll *wq)\n{\n\twq->head = 0;\n\twq->wqe_ctr = 0;\n\twq->cur_sz = 0;\n\tmlx5_wq_ll_init_list(wq);\n\tmlx5_wq_ll_update_db_record(wq);\n}\n\nvoid mlx5_wq_destroy(struct mlx5_wq_ctrl *wq_ctrl)\n{\n\tmlx5_frag_buf_free(wq_ctrl->mdev, &wq_ctrl->buf);\n\tmlx5_db_free(wq_ctrl->mdev, &wq_ctrl->db);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}