{
  "module_name": "dr_action.c",
  "hash_id": "dd4af640f48fe032b1fb1073404e3a113e1178fccd95eaaf97a8ac1afd0ce9ac",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_action.c",
  "human_readable_source": "\n \n\n#include \"dr_types.h\"\n#include \"dr_ste.h\"\n\nenum dr_action_domain {\n\tDR_ACTION_DOMAIN_NIC_INGRESS,\n\tDR_ACTION_DOMAIN_NIC_EGRESS,\n\tDR_ACTION_DOMAIN_FDB_INGRESS,\n\tDR_ACTION_DOMAIN_FDB_EGRESS,\n\tDR_ACTION_DOMAIN_MAX,\n};\n\nenum dr_action_valid_state {\n\tDR_ACTION_STATE_ERR,\n\tDR_ACTION_STATE_NO_ACTION,\n\tDR_ACTION_STATE_ENCAP,\n\tDR_ACTION_STATE_DECAP,\n\tDR_ACTION_STATE_MODIFY_HDR,\n\tDR_ACTION_STATE_POP_VLAN,\n\tDR_ACTION_STATE_PUSH_VLAN,\n\tDR_ACTION_STATE_NON_TERM,\n\tDR_ACTION_STATE_TERM,\n\tDR_ACTION_STATE_ASO,\n\tDR_ACTION_STATE_MAX,\n};\n\nstatic const char * const action_type_to_str[] = {\n\t[DR_ACTION_TYP_TNL_L2_TO_L2] = \"DR_ACTION_TYP_TNL_L2_TO_L2\",\n\t[DR_ACTION_TYP_L2_TO_TNL_L2] = \"DR_ACTION_TYP_L2_TO_TNL_L2\",\n\t[DR_ACTION_TYP_TNL_L3_TO_L2] = \"DR_ACTION_TYP_TNL_L3_TO_L2\",\n\t[DR_ACTION_TYP_L2_TO_TNL_L3] = \"DR_ACTION_TYP_L2_TO_TNL_L3\",\n\t[DR_ACTION_TYP_DROP] = \"DR_ACTION_TYP_DROP\",\n\t[DR_ACTION_TYP_QP] = \"DR_ACTION_TYP_QP\",\n\t[DR_ACTION_TYP_FT] = \"DR_ACTION_TYP_FT\",\n\t[DR_ACTION_TYP_CTR] = \"DR_ACTION_TYP_CTR\",\n\t[DR_ACTION_TYP_TAG] = \"DR_ACTION_TYP_TAG\",\n\t[DR_ACTION_TYP_MODIFY_HDR] = \"DR_ACTION_TYP_MODIFY_HDR\",\n\t[DR_ACTION_TYP_VPORT] = \"DR_ACTION_TYP_VPORT\",\n\t[DR_ACTION_TYP_POP_VLAN] = \"DR_ACTION_TYP_POP_VLAN\",\n\t[DR_ACTION_TYP_PUSH_VLAN] = \"DR_ACTION_TYP_PUSH_VLAN\",\n\t[DR_ACTION_TYP_SAMPLER] = \"DR_ACTION_TYP_SAMPLER\",\n\t[DR_ACTION_TYP_INSERT_HDR] = \"DR_ACTION_TYP_INSERT_HDR\",\n\t[DR_ACTION_TYP_REMOVE_HDR] = \"DR_ACTION_TYP_REMOVE_HDR\",\n\t[DR_ACTION_TYP_ASO_FLOW_METER] = \"DR_ACTION_TYP_ASO_FLOW_METER\",\n\t[DR_ACTION_TYP_RANGE] = \"DR_ACTION_TYP_RANGE\",\n\t[DR_ACTION_TYP_MAX] = \"DR_ACTION_UNKNOWN\",\n};\n\nstatic const char *dr_action_id_to_str(enum mlx5dr_action_type action_id)\n{\n\tif (action_id > DR_ACTION_TYP_MAX)\n\t\taction_id = DR_ACTION_TYP_MAX;\n\treturn action_type_to_str[action_id];\n}\n\nstatic const enum dr_action_valid_state\nnext_action_state[DR_ACTION_DOMAIN_MAX][DR_ACTION_STATE_MAX][DR_ACTION_TYP_MAX] = {\n\t[DR_ACTION_DOMAIN_NIC_INGRESS] = {\n\t\t[DR_ACTION_STATE_NO_ACTION] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_QP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_TAG]\t\t= DR_ACTION_STATE_NON_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_NON_TERM,\n\t\t\t[DR_ACTION_TYP_TNL_L2_TO_L2]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_TNL_L3_TO_L2]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_REMOVE_HDR]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_DECAP] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_QP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_TAG]\t\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_ENCAP] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_QP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_TAG]\t\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_MODIFY_HDR] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_QP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_TAG]\t\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_POP_VLAN] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_QP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_TAG]\t\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_PUSH_VLAN] = {\n\t\t\t[DR_ACTION_TYP_QP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_TAG]\t\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_NON_TERM] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_QP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_TAG]\t\t= DR_ACTION_STATE_NON_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_NON_TERM,\n\t\t\t[DR_ACTION_TYP_TNL_L2_TO_L2]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_TNL_L3_TO_L2]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_REMOVE_HDR]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_ASO] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_QP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]             = DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_TERM] = {\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_TERM,\n\t\t},\n\t},\n\t[DR_ACTION_DOMAIN_NIC_EGRESS] = {\n\t\t[DR_ACTION_STATE_NO_ACTION] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_NON_TERM,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_REMOVE_HDR]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_DECAP] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_ENCAP] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_MODIFY_HDR] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_POP_VLAN] = {\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_PUSH_VLAN] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_NON_TERM] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_NON_TERM,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_REMOVE_HDR]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_ASO] = {\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]    = DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]    = DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]      = DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]       = DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_CTR]             = DR_ACTION_STATE_ASO,\n\t\t\t[DR_ACTION_TYP_DROP]            = DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]              = DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t},\n\t\t[DR_ACTION_STATE_TERM] = {\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_TERM,\n\t\t},\n\t},\n\t[DR_ACTION_DOMAIN_FDB_INGRESS] = {\n\t\t[DR_ACTION_STATE_NO_ACTION] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_NON_TERM,\n\t\t\t[DR_ACTION_TYP_TNL_L2_TO_L2]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_TNL_L3_TO_L2]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_REMOVE_HDR]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_DECAP] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_ENCAP] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_QP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_MODIFY_HDR] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_POP_VLAN] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_PUSH_VLAN] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_NON_TERM] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_NON_TERM,\n\t\t\t[DR_ACTION_TYP_TNL_L2_TO_L2]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_TNL_L3_TO_L2]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_REMOVE_HDR]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_ASO] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_VPORT]           = DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]             = DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_TERM] = {\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_TERM,\n\t\t},\n\t},\n\t[DR_ACTION_DOMAIN_FDB_EGRESS] = {\n\t\t[DR_ACTION_STATE_NO_ACTION] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_NON_TERM,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_REMOVE_HDR]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_DECAP] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]  = DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_ENCAP] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]  = DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_MODIFY_HDR] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]\t= DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_POP_VLAN] = {\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]  = DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_PUSH_VLAN] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]  = DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_NON_TERM] = {\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_SAMPLER]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_NON_TERM,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]\t= DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_INSERT_HDR]\t= DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_REMOVE_HDR]\t= DR_ACTION_STATE_DECAP,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]\t= DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_POP_VLAN]\t= DR_ACTION_STATE_POP_VLAN,\n\t\t\t[DR_ACTION_TYP_VPORT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_ASO_FLOW_METER]  = DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_ASO] = {\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L2]    = DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_L2_TO_TNL_L3]    = DR_ACTION_STATE_ENCAP,\n\t\t\t[DR_ACTION_TYP_MODIFY_HDR]      = DR_ACTION_STATE_MODIFY_HDR,\n\t\t\t[DR_ACTION_TYP_PUSH_VLAN]       = DR_ACTION_STATE_PUSH_VLAN,\n\t\t\t[DR_ACTION_TYP_DROP]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_FT]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_RANGE]\t\t= DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_VPORT]           = DR_ACTION_STATE_TERM,\n\t\t\t[DR_ACTION_TYP_CTR]             = DR_ACTION_STATE_ASO,\n\t\t},\n\t\t[DR_ACTION_STATE_TERM] = {\n\t\t\t[DR_ACTION_TYP_CTR]\t\t= DR_ACTION_STATE_TERM,\n\t\t},\n\t},\n};\n\nstatic int\ndr_action_reformat_to_action_type(enum mlx5dr_action_reformat_type reformat_type,\n\t\t\t\t  enum mlx5dr_action_type *action_type)\n{\n\tswitch (reformat_type) {\n\tcase DR_ACTION_REFORMAT_TYP_TNL_L2_TO_L2:\n\t\t*action_type = DR_ACTION_TYP_TNL_L2_TO_L2;\n\t\tbreak;\n\tcase DR_ACTION_REFORMAT_TYP_L2_TO_TNL_L2:\n\t\t*action_type = DR_ACTION_TYP_L2_TO_TNL_L2;\n\t\tbreak;\n\tcase DR_ACTION_REFORMAT_TYP_TNL_L3_TO_L2:\n\t\t*action_type = DR_ACTION_TYP_TNL_L3_TO_L2;\n\t\tbreak;\n\tcase DR_ACTION_REFORMAT_TYP_L2_TO_TNL_L3:\n\t\t*action_type = DR_ACTION_TYP_L2_TO_TNL_L3;\n\t\tbreak;\n\tcase DR_ACTION_REFORMAT_TYP_INSERT_HDR:\n\t\t*action_type = DR_ACTION_TYP_INSERT_HDR;\n\t\tbreak;\n\tcase DR_ACTION_REFORMAT_TYP_REMOVE_HDR:\n\t\t*action_type = DR_ACTION_TYP_REMOVE_HDR;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\n \nstatic void dr_actions_apply(struct mlx5dr_domain *dmn,\n\t\t\t     enum mlx5dr_domain_nic_type nic_type,\n\t\t\t     u8 *action_type_set,\n\t\t\t     u8 *last_ste,\n\t\t\t     struct mlx5dr_ste_actions_attr *attr,\n\t\t\t     u32 *new_num_stes)\n{\n\tstruct mlx5dr_ste_ctx *ste_ctx = dmn->ste_ctx;\n\tu32 added_stes = 0;\n\n\tif (nic_type == DR_DOMAIN_NIC_TYPE_RX)\n\t\tmlx5dr_ste_set_actions_rx(ste_ctx, dmn, action_type_set,\n\t\t\t\t\t  last_ste, attr, &added_stes);\n\telse\n\t\tmlx5dr_ste_set_actions_tx(ste_ctx, dmn, action_type_set,\n\t\t\t\t\t  last_ste, attr, &added_stes);\n\n\t*new_num_stes += added_stes;\n}\n\nstatic enum dr_action_domain\ndr_action_get_action_domain(enum mlx5dr_domain_type domain,\n\t\t\t    enum mlx5dr_domain_nic_type nic_type)\n{\n\tswitch (domain) {\n\tcase MLX5DR_DOMAIN_TYPE_NIC_RX:\n\t\treturn DR_ACTION_DOMAIN_NIC_INGRESS;\n\tcase MLX5DR_DOMAIN_TYPE_NIC_TX:\n\t\treturn DR_ACTION_DOMAIN_NIC_EGRESS;\n\tcase MLX5DR_DOMAIN_TYPE_FDB:\n\t\tif (nic_type == DR_DOMAIN_NIC_TYPE_RX)\n\t\t\treturn DR_ACTION_DOMAIN_FDB_INGRESS;\n\t\treturn DR_ACTION_DOMAIN_FDB_EGRESS;\n\tdefault:\n\t\tWARN_ON(true);\n\t\treturn DR_ACTION_DOMAIN_MAX;\n\t}\n}\n\nstatic\nint dr_action_validate_and_get_next_state(enum dr_action_domain action_domain,\n\t\t\t\t\t  u32 action_type,\n\t\t\t\t\t  u32 *state)\n{\n\tu32 cur_state = *state;\n\n\t \n\t*state = next_action_state[action_domain][cur_state][action_type];\n\n\tif (*state == DR_ACTION_STATE_ERR)\n\t\treturn -EOPNOTSUPP;\n\n\treturn 0;\n}\n\nstatic int dr_action_handle_cs_recalc(struct mlx5dr_domain *dmn,\n\t\t\t\t      struct mlx5dr_action *dest_action,\n\t\t\t\t      u64 *final_icm_addr)\n{\n\tint ret;\n\n\tswitch (dest_action->action_type) {\n\tcase DR_ACTION_TYP_FT:\n\t\t \n\t\tif (dest_action->dest_tbl->is_fw_tbl) {\n\t\t\t*final_icm_addr = dest_action->dest_tbl->fw_tbl.rx_icm_addr;\n\t\t} else {\n\t\t\tmlx5dr_dbg(dmn,\n\t\t\t\t   \"Destination FT should be terminating when modify TTL is used\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\n\tcase DR_ACTION_TYP_VPORT:\n\t\t \n\t\tret = mlx5dr_domain_get_recalc_cs_ft_addr(dest_action->vport->dmn,\n\t\t\t\t\t\t\t  dest_action->vport->caps->num,\n\t\t\t\t\t\t\t  final_icm_addr);\n\t\tif (ret) {\n\t\t\tmlx5dr_err(dmn, \"Failed to get FW cs recalc flow table\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic void dr_action_modify_ttl_adjust(struct mlx5dr_domain *dmn,\n\t\t\t\t\tstruct mlx5dr_ste_actions_attr *attr,\n\t\t\t\t\tbool rx_rule,\n\t\t\t\t\tbool *recalc_cs_required)\n{\n\t*recalc_cs_required = false;\n\n\t \n\tif (mlx5dr_ste_supp_ttl_cs_recalc(&dmn->info.caps))\n\t\treturn;\n\n\t \n\tif (!rx_rule)\n\t\treturn;\n\n\tif (!MLX5_CAP_ESW_FLOWTABLE(dmn->mdev, fdb_ipv4_ttl_modify)) {\n\t\t \n\t\tattr->modify_actions--;\n\t\treturn;\n\t}\n\n\tif (dmn->type == MLX5DR_DOMAIN_TYPE_FDB)\n\t\t \n\t\t*recalc_cs_required = true;\n}\n\nstatic void dr_action_print_sequence(struct mlx5dr_domain *dmn,\n\t\t\t\t     struct mlx5dr_action *actions[],\n\t\t\t\t     int last_idx)\n{\n\tint i;\n\n\tfor (i = 0; i <= last_idx; i++)\n\t\tmlx5dr_err(dmn, \"< %s (%d) > \",\n\t\t\t   dr_action_id_to_str(actions[i]->action_type),\n\t\t\t   actions[i]->action_type);\n}\n\nstatic int dr_action_get_dest_fw_tbl_addr(struct mlx5dr_matcher *matcher,\n\t\t\t\t\t  struct mlx5dr_action_dest_tbl *dest_tbl,\n\t\t\t\t\t  bool is_rx_rule,\n\t\t\t\t\t  u64 *final_icm_addr)\n{\n\tstruct mlx5dr_cmd_query_flow_table_details output;\n\tstruct mlx5dr_domain *dmn = matcher->tbl->dmn;\n\tint ret;\n\n\tif (!dest_tbl->fw_tbl.rx_icm_addr) {\n\t\tret = mlx5dr_cmd_query_flow_table(dmn->mdev,\n\t\t\t\t\t\t  dest_tbl->fw_tbl.type,\n\t\t\t\t\t\t  dest_tbl->fw_tbl.id,\n\t\t\t\t\t\t  &output);\n\t\tif (ret) {\n\t\t\tmlx5dr_err(dmn,\n\t\t\t\t   \"Failed mlx5_cmd_query_flow_table ret: %d\\n\",\n\t\t\t\t   ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tdest_tbl->fw_tbl.tx_icm_addr = output.sw_owner_icm_root_1;\n\t\tdest_tbl->fw_tbl.rx_icm_addr = output.sw_owner_icm_root_0;\n\t}\n\n\t*final_icm_addr = is_rx_rule ? dest_tbl->fw_tbl.rx_icm_addr :\n\t\t\t\t       dest_tbl->fw_tbl.tx_icm_addr;\n\treturn 0;\n}\n\nstatic int dr_action_get_dest_sw_tbl_addr(struct mlx5dr_matcher *matcher,\n\t\t\t\t\t  struct mlx5dr_action_dest_tbl *dest_tbl,\n\t\t\t\t\t  bool is_rx_rule,\n\t\t\t\t\t  u64 *final_icm_addr)\n{\n\tstruct mlx5dr_domain *dmn = matcher->tbl->dmn;\n\tstruct mlx5dr_icm_chunk *chunk;\n\n\tif (dest_tbl->tbl->dmn != dmn) {\n\t\tmlx5dr_err(dmn,\n\t\t\t   \"Destination table belongs to a different domain\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (dest_tbl->tbl->level <= matcher->tbl->level) {\n\t\tmlx5_core_dbg_once(dmn->mdev,\n\t\t\t\t   \"Connecting table to a lower/same level destination table\\n\");\n\t\tmlx5dr_dbg(dmn,\n\t\t\t   \"Connecting table at level %d to a destination table at level %d\\n\",\n\t\t\t   matcher->tbl->level,\n\t\t\t   dest_tbl->tbl->level);\n\t}\n\n\tchunk = is_rx_rule ? dest_tbl->tbl->rx.s_anchor->chunk :\n\t\t\t     dest_tbl->tbl->tx.s_anchor->chunk;\n\n\t*final_icm_addr = mlx5dr_icm_pool_get_chunk_icm_addr(chunk);\n\treturn 0;\n}\n\nstatic int dr_action_get_dest_tbl_addr(struct mlx5dr_matcher *matcher,\n\t\t\t\t       struct mlx5dr_action_dest_tbl *dest_tbl,\n\t\t\t\t       bool is_rx_rule,\n\t\t\t\t       u64 *final_icm_addr)\n{\n\tif (dest_tbl->is_fw_tbl)\n\t\treturn dr_action_get_dest_fw_tbl_addr(matcher,\n\t\t\t\t\t\t      dest_tbl,\n\t\t\t\t\t\t      is_rx_rule,\n\t\t\t\t\t\t      final_icm_addr);\n\n\treturn dr_action_get_dest_sw_tbl_addr(matcher,\n\t\t\t\t\t      dest_tbl,\n\t\t\t\t\t      is_rx_rule,\n\t\t\t\t\t      final_icm_addr);\n}\n\n#define WITH_VLAN_NUM_HW_ACTIONS 6\n\nint mlx5dr_actions_build_ste_arr(struct mlx5dr_matcher *matcher,\n\t\t\t\t struct mlx5dr_matcher_rx_tx *nic_matcher,\n\t\t\t\t struct mlx5dr_action *actions[],\n\t\t\t\t u32 num_actions,\n\t\t\t\t u8 *ste_arr,\n\t\t\t\t u32 *new_hw_ste_arr_sz)\n{\n\tstruct mlx5dr_domain_rx_tx *nic_dmn = nic_matcher->nic_tbl->nic_dmn;\n\tbool rx_rule = nic_dmn->type == DR_DOMAIN_NIC_TYPE_RX;\n\tstruct mlx5dr_domain *dmn = matcher->tbl->dmn;\n\tu8 action_type_set[DR_ACTION_TYP_MAX] = {};\n\tstruct mlx5dr_ste_actions_attr attr = {};\n\tstruct mlx5dr_action *dest_action = NULL;\n\tu32 state = DR_ACTION_STATE_NO_ACTION;\n\tenum dr_action_domain action_domain;\n\tbool recalc_cs_required = false;\n\tu8 *last_ste;\n\tint i, ret;\n\n\tattr.gvmi = dmn->info.caps.gvmi;\n\tattr.hit_gvmi = dmn->info.caps.gvmi;\n\tattr.final_icm_addr = nic_dmn->default_icm_addr;\n\taction_domain = dr_action_get_action_domain(dmn->type, nic_dmn->type);\n\n\tfor (i = 0; i < num_actions; i++) {\n\t\tstruct mlx5dr_action *action;\n\t\tint max_actions_type = 1;\n\t\tu32 action_type;\n\n\t\taction = actions[i];\n\t\taction_type = action->action_type;\n\n\t\tswitch (action_type) {\n\t\tcase DR_ACTION_TYP_DROP:\n\t\t\tattr.final_icm_addr = nic_dmn->drop_icm_addr;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_FT:\n\t\t\tdest_action = action;\n\t\t\tret = dr_action_get_dest_tbl_addr(matcher, action->dest_tbl,\n\t\t\t\t\t\t\t  rx_rule, &attr.final_icm_addr);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_RANGE:\n\t\t\tret = dr_action_get_dest_tbl_addr(matcher,\n\t\t\t\t\t\t\t  action->range->hit_tbl_action->dest_tbl,\n\t\t\t\t\t\t\t  rx_rule, &attr.final_icm_addr);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tret = dr_action_get_dest_tbl_addr(matcher,\n\t\t\t\t\t\t\t  action->range->miss_tbl_action->dest_tbl,\n\t\t\t\t\t\t\t  rx_rule, &attr.range.miss_icm_addr);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tattr.range.definer_id = action->range->definer_id;\n\t\t\tattr.range.min = action->range->min;\n\t\t\tattr.range.max = action->range->max;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_QP:\n\t\t\tmlx5dr_info(dmn, \"Domain doesn't support QP\\n\");\n\t\t\treturn -EOPNOTSUPP;\n\t\tcase DR_ACTION_TYP_CTR:\n\t\t\tattr.ctr_id = action->ctr->ctr_id +\n\t\t\t\taction->ctr->offset;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_TAG:\n\t\t\tattr.flow_tag = action->flow_tag->flow_tag;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_TNL_L2_TO_L2:\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_TNL_L3_TO_L2:\n\t\t\tif (action->rewrite->ptrn && action->rewrite->arg) {\n\t\t\t\tattr.decap_index = mlx5dr_arg_get_obj_id(action->rewrite->arg);\n\t\t\t\tattr.decap_actions = action->rewrite->ptrn->num_of_actions;\n\t\t\t\tattr.decap_pat_idx = action->rewrite->ptrn->index;\n\t\t\t} else {\n\t\t\t\tattr.decap_index = action->rewrite->index;\n\t\t\t\tattr.decap_actions = action->rewrite->num_of_actions;\n\t\t\t\tattr.decap_with_vlan =\n\t\t\t\t\tattr.decap_actions == WITH_VLAN_NUM_HW_ACTIONS;\n\t\t\t\tattr.decap_pat_idx = MLX5DR_INVALID_PATTERN_INDEX;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_MODIFY_HDR:\n\t\t\tif (action->rewrite->single_action_opt) {\n\t\t\t\tattr.modify_actions = action->rewrite->num_of_actions;\n\t\t\t\tattr.single_modify_action = action->rewrite->data;\n\t\t\t} else {\n\t\t\t\tif (action->rewrite->ptrn && action->rewrite->arg) {\n\t\t\t\t\tattr.modify_index =\n\t\t\t\t\t\tmlx5dr_arg_get_obj_id(action->rewrite->arg);\n\t\t\t\t\tattr.modify_actions = action->rewrite->ptrn->num_of_actions;\n\t\t\t\t\tattr.modify_pat_idx = action->rewrite->ptrn->index;\n\t\t\t\t} else {\n\t\t\t\t\tattr.modify_index = action->rewrite->index;\n\t\t\t\t\tattr.modify_actions = action->rewrite->num_of_actions;\n\t\t\t\t\tattr.modify_pat_idx = MLX5DR_INVALID_PATTERN_INDEX;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (action->rewrite->modify_ttl)\n\t\t\t\tdr_action_modify_ttl_adjust(dmn, &attr, rx_rule,\n\t\t\t\t\t\t\t    &recalc_cs_required);\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_L2_TO_TNL_L2:\n\t\tcase DR_ACTION_TYP_L2_TO_TNL_L3:\n\t\t\tif (rx_rule &&\n\t\t\t    !(dmn->ste_ctx->actions_caps & DR_STE_CTX_ACTION_CAP_RX_ENCAP)) {\n\t\t\t\tmlx5dr_info(dmn, \"Device doesn't support Encap on RX\\n\");\n\t\t\t\treturn -EOPNOTSUPP;\n\t\t\t}\n\t\t\tattr.reformat.size = action->reformat->size;\n\t\t\tattr.reformat.id = action->reformat->id;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_SAMPLER:\n\t\t\tattr.final_icm_addr = rx_rule ? action->sampler->rx_icm_addr :\n\t\t\t\t\t\t\taction->sampler->tx_icm_addr;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_VPORT:\n\t\t\tattr.hit_gvmi = action->vport->caps->vhca_gvmi;\n\t\t\tdest_action = action;\n\t\t\tattr.final_icm_addr = rx_rule ?\n\t\t\t\taction->vport->caps->icm_address_rx :\n\t\t\t\taction->vport->caps->icm_address_tx;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_POP_VLAN:\n\t\t\tif (!rx_rule && !(dmn->ste_ctx->actions_caps &\n\t\t\t\t\t  DR_STE_CTX_ACTION_CAP_TX_POP)) {\n\t\t\t\tmlx5dr_dbg(dmn, \"Device doesn't support POP VLAN action on TX\\n\");\n\t\t\t\treturn -EOPNOTSUPP;\n\t\t\t}\n\n\t\t\tmax_actions_type = MLX5DR_MAX_VLANS;\n\t\t\tattr.vlans.count++;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_PUSH_VLAN:\n\t\t\tif (rx_rule && !(dmn->ste_ctx->actions_caps &\n\t\t\t\t\t DR_STE_CTX_ACTION_CAP_RX_PUSH)) {\n\t\t\t\tmlx5dr_dbg(dmn, \"Device doesn't support PUSH VLAN action on RX\\n\");\n\t\t\t\treturn -EOPNOTSUPP;\n\t\t\t}\n\n\t\t\tmax_actions_type = MLX5DR_MAX_VLANS;\n\t\t\tif (attr.vlans.count == MLX5DR_MAX_VLANS) {\n\t\t\t\tmlx5dr_dbg(dmn, \"Max VLAN push/pop count exceeded\\n\");\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\n\t\t\tattr.vlans.headers[attr.vlans.count++] = action->push_vlan->vlan_hdr;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_INSERT_HDR:\n\t\tcase DR_ACTION_TYP_REMOVE_HDR:\n\t\t\tattr.reformat.size = action->reformat->size;\n\t\t\tattr.reformat.id = action->reformat->id;\n\t\t\tattr.reformat.param_0 = action->reformat->param_0;\n\t\t\tattr.reformat.param_1 = action->reformat->param_1;\n\t\t\tbreak;\n\t\tcase DR_ACTION_TYP_ASO_FLOW_METER:\n\t\t\tattr.aso_flow_meter.obj_id = action->aso->obj_id;\n\t\t\tattr.aso_flow_meter.offset = action->aso->offset;\n\t\t\tattr.aso_flow_meter.dest_reg_id = action->aso->dest_reg_id;\n\t\t\tattr.aso_flow_meter.init_color = action->aso->init_color;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tmlx5dr_err(dmn, \"Unsupported action type %d\\n\", action_type);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tif (++action_type_set[action_type] > max_actions_type) {\n\t\t\tmlx5dr_err(dmn, \"Action type %d supports only max %d time(s)\\n\",\n\t\t\t\t   action_type, max_actions_type);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tif (dr_action_validate_and_get_next_state(action_domain,\n\t\t\t\t\t\t\t  action_type,\n\t\t\t\t\t\t\t  &state)) {\n\t\t\tmlx5dr_err(dmn, \"Invalid action (gvmi: %d, is_rx: %d) sequence provided:\",\n\t\t\t\t   attr.gvmi, rx_rule);\n\t\t\tdr_action_print_sequence(dmn, actions, i);\n\t\t\treturn -EOPNOTSUPP;\n\t\t}\n\t}\n\n\t*new_hw_ste_arr_sz = nic_matcher->num_of_builders;\n\tlast_ste = ste_arr + DR_STE_SIZE * (nic_matcher->num_of_builders - 1);\n\n\tif (recalc_cs_required && dest_action) {\n\t\tret = dr_action_handle_cs_recalc(dmn, dest_action, &attr.final_icm_addr);\n\t\tif (ret) {\n\t\t\tmlx5dr_err(dmn,\n\t\t\t\t   \"Failed to handle checksum recalculation err %d\\n\",\n\t\t\t\t   ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tdr_actions_apply(dmn,\n\t\t\t nic_dmn->type,\n\t\t\t action_type_set,\n\t\t\t last_ste,\n\t\t\t &attr,\n\t\t\t new_hw_ste_arr_sz);\n\n\treturn 0;\n}\n\nstatic unsigned int action_size[DR_ACTION_TYP_MAX] = {\n\t[DR_ACTION_TYP_TNL_L2_TO_L2] = sizeof(struct mlx5dr_action_reformat),\n\t[DR_ACTION_TYP_L2_TO_TNL_L2] = sizeof(struct mlx5dr_action_reformat),\n\t[DR_ACTION_TYP_TNL_L3_TO_L2] = sizeof(struct mlx5dr_action_rewrite),\n\t[DR_ACTION_TYP_L2_TO_TNL_L3] = sizeof(struct mlx5dr_action_reformat),\n\t[DR_ACTION_TYP_FT]           = sizeof(struct mlx5dr_action_dest_tbl),\n\t[DR_ACTION_TYP_CTR]          = sizeof(struct mlx5dr_action_ctr),\n\t[DR_ACTION_TYP_TAG]          = sizeof(struct mlx5dr_action_flow_tag),\n\t[DR_ACTION_TYP_MODIFY_HDR]   = sizeof(struct mlx5dr_action_rewrite),\n\t[DR_ACTION_TYP_VPORT]        = sizeof(struct mlx5dr_action_vport),\n\t[DR_ACTION_TYP_PUSH_VLAN]    = sizeof(struct mlx5dr_action_push_vlan),\n\t[DR_ACTION_TYP_INSERT_HDR]   = sizeof(struct mlx5dr_action_reformat),\n\t[DR_ACTION_TYP_REMOVE_HDR]   = sizeof(struct mlx5dr_action_reformat),\n\t[DR_ACTION_TYP_SAMPLER]      = sizeof(struct mlx5dr_action_sampler),\n\t[DR_ACTION_TYP_ASO_FLOW_METER] = sizeof(struct mlx5dr_action_aso_flow_meter),\n\t[DR_ACTION_TYP_RANGE]        = sizeof(struct mlx5dr_action_range),\n};\n\nstatic struct mlx5dr_action *\ndr_action_create_generic(enum mlx5dr_action_type action_type)\n{\n\tstruct mlx5dr_action *action;\n\tint extra_size;\n\n\tif (action_type < DR_ACTION_TYP_MAX)\n\t\textra_size = action_size[action_type];\n\telse\n\t\treturn NULL;\n\n\taction = kzalloc(sizeof(*action) + extra_size, GFP_KERNEL);\n\tif (!action)\n\t\treturn NULL;\n\n\taction->action_type = action_type;\n\trefcount_set(&action->refcount, 1);\n\taction->data = action + 1;\n\n\treturn action;\n}\n\nstruct mlx5dr_action *mlx5dr_action_create_drop(void)\n{\n\treturn dr_action_create_generic(DR_ACTION_TYP_DROP);\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_dest_table_num(struct mlx5dr_domain *dmn, u32 table_num)\n{\n\tstruct mlx5dr_action *action;\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_FT);\n\tif (!action)\n\t\treturn NULL;\n\n\taction->dest_tbl->is_fw_tbl = true;\n\taction->dest_tbl->fw_tbl.dmn = dmn;\n\taction->dest_tbl->fw_tbl.id = table_num;\n\taction->dest_tbl->fw_tbl.type = FS_FT_FDB;\n\trefcount_inc(&dmn->refcount);\n\n\treturn action;\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_dest_table(struct mlx5dr_table *tbl)\n{\n\tstruct mlx5dr_action *action;\n\n\trefcount_inc(&tbl->refcount);\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_FT);\n\tif (!action)\n\t\tgoto dec_ref;\n\n\taction->dest_tbl->tbl = tbl;\n\n\treturn action;\n\ndec_ref:\n\trefcount_dec(&tbl->refcount);\n\treturn NULL;\n}\n\nstatic void dr_action_range_definer_fill(u16 *format_id,\n\t\t\t\t\t u8 *dw_selectors,\n\t\t\t\t\t u8 *byte_selectors,\n\t\t\t\t\t u8 *match_mask)\n{\n\tint i;\n\n\t*format_id = MLX5_IFC_DEFINER_FORMAT_ID_SELECT;\n\n\tdw_selectors[0] = MLX5_IFC_DEFINER_FORMAT_OFFSET_OUTER_ETH_PKT_LEN / 4;\n\n\tfor (i = 1; i < MLX5_IFC_DEFINER_DW_SELECTORS_NUM; i++)\n\t\tdw_selectors[i] = MLX5_IFC_DEFINER_FORMAT_OFFSET_UNUSED;\n\n\tfor (i = 0; i < MLX5_IFC_DEFINER_BYTE_SELECTORS_NUM; i++)\n\t\tbyte_selectors[i] = MLX5_IFC_DEFINER_FORMAT_OFFSET_UNUSED;\n\n\tMLX5_SET(match_definer_match_mask, match_mask,\n\t\t match_dw_0, 0xffffUL << 16);\n}\n\nstatic int dr_action_create_range_definer(struct mlx5dr_action *action)\n{\n\tu8 match_mask[MLX5_FLD_SZ_BYTES(match_definer, match_mask)] = {};\n\tu8 byte_selectors[MLX5_IFC_DEFINER_BYTE_SELECTORS_NUM] = {};\n\tu8 dw_selectors[MLX5_IFC_DEFINER_DW_SELECTORS_NUM] = {};\n\tstruct mlx5dr_domain *dmn = action->range->dmn;\n\tu32 definer_id;\n\tu16 format_id;\n\tint ret;\n\n\tdr_action_range_definer_fill(&format_id,\n\t\t\t\t     dw_selectors,\n\t\t\t\t     byte_selectors,\n\t\t\t\t     match_mask);\n\n\tret = mlx5dr_definer_get(dmn, format_id,\n\t\t\t\t dw_selectors, byte_selectors,\n\t\t\t\t match_mask, &definer_id);\n\tif (ret)\n\t\treturn ret;\n\n\taction->range->definer_id = definer_id;\n\treturn 0;\n}\n\nstatic void dr_action_destroy_range_definer(struct mlx5dr_action *action)\n{\n\tmlx5dr_definer_put(action->range->dmn, action->range->definer_id);\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_dest_match_range(struct mlx5dr_domain *dmn,\n\t\t\t\t      u32 field,\n\t\t\t\t      struct mlx5_flow_table *hit_ft,\n\t\t\t\t      struct mlx5_flow_table *miss_ft,\n\t\t\t\t      u32 min,\n\t\t\t\t      u32 max)\n{\n\tstruct mlx5dr_action *action;\n\tint ret;\n\n\tif (!mlx5dr_supp_match_ranges(dmn->mdev)) {\n\t\tmlx5dr_dbg(dmn, \"SELECT definer support is needed for match range\\n\");\n\t\treturn NULL;\n\t}\n\n\tif (field != MLX5_FLOW_DEST_RANGE_FIELD_PKT_LEN ||\n\t    min > 0xffff || max > 0xffff) {\n\t\tmlx5dr_err(dmn, \"Invalid match range parameters\\n\");\n\t\treturn NULL;\n\t}\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_RANGE);\n\tif (!action)\n\t\treturn NULL;\n\n\taction->range->hit_tbl_action =\n\t\tmlx5dr_is_fw_table(hit_ft) ?\n\t\t\tmlx5dr_action_create_dest_flow_fw_table(dmn, hit_ft) :\n\t\t\tmlx5dr_action_create_dest_table(hit_ft->fs_dr_table.dr_table);\n\n\tif (!action->range->hit_tbl_action)\n\t\tgoto free_action;\n\n\taction->range->miss_tbl_action =\n\t\tmlx5dr_is_fw_table(miss_ft) ?\n\t\t\tmlx5dr_action_create_dest_flow_fw_table(dmn, miss_ft) :\n\t\t\tmlx5dr_action_create_dest_table(miss_ft->fs_dr_table.dr_table);\n\n\tif (!action->range->miss_tbl_action)\n\t\tgoto free_hit_tbl_action;\n\n\taction->range->min = min;\n\taction->range->max = max;\n\taction->range->dmn = dmn;\n\n\tret = dr_action_create_range_definer(action);\n\tif (ret)\n\t\tgoto free_miss_tbl_action;\n\n\t \n\n\treturn action;\n\nfree_miss_tbl_action:\n\tmlx5dr_action_destroy(action->range->miss_tbl_action);\nfree_hit_tbl_action:\n\tmlx5dr_action_destroy(action->range->hit_tbl_action);\nfree_action:\n\tkfree(action);\n\n\treturn NULL;\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_mult_dest_tbl(struct mlx5dr_domain *dmn,\n\t\t\t\t   struct mlx5dr_action_dest *dests,\n\t\t\t\t   u32 num_of_dests,\n\t\t\t\t   bool ignore_flow_level,\n\t\t\t\t   u32 flow_source)\n{\n\tstruct mlx5dr_cmd_flow_destination_hw_info *hw_dests;\n\tstruct mlx5dr_action **ref_actions;\n\tstruct mlx5dr_action *action;\n\tbool reformat_req = false;\n\tu32 num_of_ref = 0;\n\tu32 ref_act_cnt;\n\tint ret;\n\tint i;\n\n\tif (dmn->type != MLX5DR_DOMAIN_TYPE_FDB) {\n\t\tmlx5dr_err(dmn, \"Multiple destination support is for FDB only\\n\");\n\t\treturn NULL;\n\t}\n\n\thw_dests = kcalloc(num_of_dests, sizeof(*hw_dests), GFP_KERNEL);\n\tif (!hw_dests)\n\t\treturn NULL;\n\n\tif (unlikely(check_mul_overflow(num_of_dests, 2u, &ref_act_cnt)))\n\t\tgoto free_hw_dests;\n\n\tref_actions = kcalloc(ref_act_cnt, sizeof(*ref_actions), GFP_KERNEL);\n\tif (!ref_actions)\n\t\tgoto free_hw_dests;\n\n\tfor (i = 0; i < num_of_dests; i++) {\n\t\tstruct mlx5dr_action *reformat_action = dests[i].reformat;\n\t\tstruct mlx5dr_action *dest_action = dests[i].dest;\n\n\t\tref_actions[num_of_ref++] = dest_action;\n\n\t\tswitch (dest_action->action_type) {\n\t\tcase DR_ACTION_TYP_VPORT:\n\t\t\thw_dests[i].vport.flags = MLX5_FLOW_DEST_VPORT_VHCA_ID;\n\t\t\thw_dests[i].type = MLX5_FLOW_DESTINATION_TYPE_VPORT;\n\t\t\thw_dests[i].vport.num = dest_action->vport->caps->num;\n\t\t\thw_dests[i].vport.vhca_id = dest_action->vport->caps->vhca_gvmi;\n\t\t\tif (reformat_action) {\n\t\t\t\treformat_req = true;\n\t\t\t\thw_dests[i].vport.reformat_id =\n\t\t\t\t\treformat_action->reformat->id;\n\t\t\t\tref_actions[num_of_ref++] = reformat_action;\n\t\t\t\thw_dests[i].vport.flags |= MLX5_FLOW_DEST_VPORT_REFORMAT_ID;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase DR_ACTION_TYP_FT:\n\t\t\thw_dests[i].type = MLX5_FLOW_DESTINATION_TYPE_FLOW_TABLE;\n\t\t\tif (dest_action->dest_tbl->is_fw_tbl)\n\t\t\t\thw_dests[i].ft_id = dest_action->dest_tbl->fw_tbl.id;\n\t\t\telse\n\t\t\t\thw_dests[i].ft_id = dest_action->dest_tbl->tbl->table_id;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tmlx5dr_dbg(dmn, \"Invalid multiple destinations action\\n\");\n\t\t\tgoto free_ref_actions;\n\t\t}\n\t}\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_FT);\n\tif (!action)\n\t\tgoto free_ref_actions;\n\n\tret = mlx5dr_fw_create_md_tbl(dmn,\n\t\t\t\t      hw_dests,\n\t\t\t\t      num_of_dests,\n\t\t\t\t      reformat_req,\n\t\t\t\t      &action->dest_tbl->fw_tbl.id,\n\t\t\t\t      &action->dest_tbl->fw_tbl.group_id,\n\t\t\t\t      ignore_flow_level,\n\t\t\t\t      flow_source);\n\tif (ret)\n\t\tgoto free_action;\n\n\trefcount_inc(&dmn->refcount);\n\n\tfor (i = 0; i < num_of_ref; i++)\n\t\trefcount_inc(&ref_actions[i]->refcount);\n\n\taction->dest_tbl->is_fw_tbl = true;\n\taction->dest_tbl->fw_tbl.dmn = dmn;\n\taction->dest_tbl->fw_tbl.type = FS_FT_FDB;\n\taction->dest_tbl->fw_tbl.ref_actions = ref_actions;\n\taction->dest_tbl->fw_tbl.num_of_ref_actions = num_of_ref;\n\n\tkfree(hw_dests);\n\n\treturn action;\n\nfree_action:\n\tkfree(action);\nfree_ref_actions:\n\tkfree(ref_actions);\nfree_hw_dests:\n\tkfree(hw_dests);\n\treturn NULL;\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_dest_flow_fw_table(struct mlx5dr_domain *dmn,\n\t\t\t\t\tstruct mlx5_flow_table *ft)\n{\n\tstruct mlx5dr_action *action;\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_FT);\n\tif (!action)\n\t\treturn NULL;\n\n\taction->dest_tbl->is_fw_tbl = 1;\n\taction->dest_tbl->fw_tbl.type = ft->type;\n\taction->dest_tbl->fw_tbl.id = ft->id;\n\taction->dest_tbl->fw_tbl.dmn = dmn;\n\n\trefcount_inc(&dmn->refcount);\n\n\treturn action;\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_flow_counter(u32 counter_id)\n{\n\tstruct mlx5dr_action *action;\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_CTR);\n\tif (!action)\n\t\treturn NULL;\n\n\taction->ctr->ctr_id = counter_id;\n\n\treturn action;\n}\n\nstruct mlx5dr_action *mlx5dr_action_create_tag(u32 tag_value)\n{\n\tstruct mlx5dr_action *action;\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_TAG);\n\tif (!action)\n\t\treturn NULL;\n\n\taction->flow_tag->flow_tag = tag_value & 0xffffff;\n\n\treturn action;\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_flow_sampler(struct mlx5dr_domain *dmn, u32 sampler_id)\n{\n\tstruct mlx5dr_action *action;\n\tu64 icm_rx, icm_tx;\n\tint ret;\n\n\tret = mlx5dr_cmd_query_flow_sampler(dmn->mdev, sampler_id,\n\t\t\t\t\t    &icm_rx, &icm_tx);\n\tif (ret)\n\t\treturn NULL;\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_SAMPLER);\n\tif (!action)\n\t\treturn NULL;\n\n\taction->sampler->dmn = dmn;\n\taction->sampler->sampler_id = sampler_id;\n\taction->sampler->rx_icm_addr = icm_rx;\n\taction->sampler->tx_icm_addr = icm_tx;\n\n\trefcount_inc(&dmn->refcount);\n\treturn action;\n}\n\nstatic int\ndr_action_verify_reformat_params(enum mlx5dr_action_type reformat_type,\n\t\t\t\t struct mlx5dr_domain *dmn,\n\t\t\t\t u8 reformat_param_0,\n\t\t\t\t u8 reformat_param_1,\n\t\t\t\t size_t data_sz,\n\t\t\t\t void *data)\n{\n\tif (reformat_type == DR_ACTION_TYP_INSERT_HDR) {\n\t\tif ((!data && data_sz) || (data && !data_sz) ||\n\t\t    MLX5_CAP_GEN_2(dmn->mdev, max_reformat_insert_size) < data_sz ||\n\t\t    MLX5_CAP_GEN_2(dmn->mdev, max_reformat_insert_offset) < reformat_param_1) {\n\t\t\tmlx5dr_dbg(dmn, \"Invalid reformat parameters for INSERT_HDR\\n\");\n\t\t\tgoto out_err;\n\t\t}\n\t} else if (reformat_type == DR_ACTION_TYP_REMOVE_HDR) {\n\t\tif (data ||\n\t\t    MLX5_CAP_GEN_2(dmn->mdev, max_reformat_remove_size) < data_sz ||\n\t\t    MLX5_CAP_GEN_2(dmn->mdev, max_reformat_remove_offset) < reformat_param_1) {\n\t\t\tmlx5dr_dbg(dmn, \"Invalid reformat parameters for REMOVE_HDR\\n\");\n\t\t\tgoto out_err;\n\t\t}\n\t} else if (reformat_param_0 || reformat_param_1 ||\n\t\t   reformat_type > DR_ACTION_TYP_REMOVE_HDR) {\n\t\tmlx5dr_dbg(dmn, \"Invalid reformat parameters\\n\");\n\t\tgoto out_err;\n\t}\n\n\tif (dmn->type == MLX5DR_DOMAIN_TYPE_FDB)\n\t\treturn 0;\n\n\tif (dmn->type == MLX5DR_DOMAIN_TYPE_NIC_RX) {\n\t\tif (reformat_type != DR_ACTION_TYP_TNL_L2_TO_L2 &&\n\t\t    reformat_type != DR_ACTION_TYP_TNL_L3_TO_L2) {\n\t\t\tmlx5dr_dbg(dmn, \"Action reformat type not support on RX domain\\n\");\n\t\t\tgoto out_err;\n\t\t}\n\t} else if (dmn->type == MLX5DR_DOMAIN_TYPE_NIC_TX) {\n\t\tif (reformat_type != DR_ACTION_TYP_L2_TO_TNL_L2 &&\n\t\t    reformat_type != DR_ACTION_TYP_L2_TO_TNL_L3) {\n\t\t\tmlx5dr_dbg(dmn, \"Action reformat type not support on TX domain\\n\");\n\t\t\tgoto out_err;\n\t\t}\n\t}\n\n\treturn 0;\n\nout_err:\n\treturn -EINVAL;\n}\n\nstatic int\ndr_action_create_reformat_action(struct mlx5dr_domain *dmn,\n\t\t\t\t u8 reformat_param_0, u8 reformat_param_1,\n\t\t\t\t size_t data_sz, void *data,\n\t\t\t\t struct mlx5dr_action *action)\n{\n\tu32 reformat_id;\n\tint ret;\n\n\tswitch (action->action_type) {\n\tcase DR_ACTION_TYP_L2_TO_TNL_L2:\n\tcase DR_ACTION_TYP_L2_TO_TNL_L3:\n\t{\n\t\tenum mlx5_reformat_ctx_type rt;\n\n\t\tif (action->action_type == DR_ACTION_TYP_L2_TO_TNL_L2)\n\t\t\trt = MLX5_REFORMAT_TYPE_L2_TO_L2_TUNNEL;\n\t\telse\n\t\t\trt = MLX5_REFORMAT_TYPE_L2_TO_L3_TUNNEL;\n\n\t\tret = mlx5dr_cmd_create_reformat_ctx(dmn->mdev, rt, 0, 0,\n\t\t\t\t\t\t     data_sz, data,\n\t\t\t\t\t\t     &reformat_id);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\taction->reformat->id = reformat_id;\n\t\taction->reformat->size = data_sz;\n\t\treturn 0;\n\t}\n\tcase DR_ACTION_TYP_TNL_L2_TO_L2:\n\t{\n\t\treturn 0;\n\t}\n\tcase DR_ACTION_TYP_TNL_L3_TO_L2:\n\t{\n\t\tu8 *hw_actions;\n\n\t\thw_actions = kzalloc(DR_ACTION_CACHE_LINE_SIZE, GFP_KERNEL);\n\t\tif (!hw_actions)\n\t\t\treturn -ENOMEM;\n\n\t\tret = mlx5dr_ste_set_action_decap_l3_list(dmn->ste_ctx,\n\t\t\t\t\t\t\t  data, data_sz,\n\t\t\t\t\t\t\t  hw_actions,\n\t\t\t\t\t\t\t  DR_ACTION_CACHE_LINE_SIZE,\n\t\t\t\t\t\t\t  &action->rewrite->num_of_actions);\n\t\tif (ret) {\n\t\t\tmlx5dr_dbg(dmn, \"Failed creating decap l3 action list\\n\");\n\t\t\tkfree(hw_actions);\n\t\t\treturn ret;\n\t\t}\n\n\t\taction->rewrite->data = hw_actions;\n\t\taction->rewrite->dmn = dmn;\n\n\t\tret = mlx5dr_ste_alloc_modify_hdr(action);\n\t\tif (ret) {\n\t\t\tmlx5dr_dbg(dmn, \"Failed preparing reformat data\\n\");\n\t\t\tkfree(hw_actions);\n\t\t\treturn ret;\n\t\t}\n\t\treturn 0;\n\t}\n\tcase DR_ACTION_TYP_INSERT_HDR:\n\t\tret = mlx5dr_cmd_create_reformat_ctx(dmn->mdev,\n\t\t\t\t\t\t     MLX5_REFORMAT_TYPE_INSERT_HDR,\n\t\t\t\t\t\t     reformat_param_0,\n\t\t\t\t\t\t     reformat_param_1,\n\t\t\t\t\t\t     data_sz, data,\n\t\t\t\t\t\t     &reformat_id);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\taction->reformat->id = reformat_id;\n\t\taction->reformat->size = data_sz;\n\t\taction->reformat->param_0 = reformat_param_0;\n\t\taction->reformat->param_1 = reformat_param_1;\n\t\treturn 0;\n\tcase DR_ACTION_TYP_REMOVE_HDR:\n\t\taction->reformat->id = 0;\n\t\taction->reformat->size = data_sz;\n\t\taction->reformat->param_0 = reformat_param_0;\n\t\taction->reformat->param_1 = reformat_param_1;\n\t\treturn 0;\n\tdefault:\n\t\tmlx5dr_info(dmn, \"Reformat type is not supported %d\\n\", action->action_type);\n\t\treturn -EINVAL;\n\t}\n}\n\n#define CVLAN_ETHERTYPE 0x8100\n#define SVLAN_ETHERTYPE 0x88a8\n\nstruct mlx5dr_action *mlx5dr_action_create_pop_vlan(void)\n{\n\treturn dr_action_create_generic(DR_ACTION_TYP_POP_VLAN);\n}\n\nstruct mlx5dr_action *mlx5dr_action_create_push_vlan(struct mlx5dr_domain *dmn,\n\t\t\t\t\t\t     __be32 vlan_hdr)\n{\n\tu32 vlan_hdr_h = ntohl(vlan_hdr);\n\tu16 ethertype = vlan_hdr_h >> 16;\n\tstruct mlx5dr_action *action;\n\n\tif (ethertype != SVLAN_ETHERTYPE && ethertype != CVLAN_ETHERTYPE) {\n\t\tmlx5dr_dbg(dmn, \"Invalid vlan ethertype\\n\");\n\t\treturn NULL;\n\t}\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_PUSH_VLAN);\n\tif (!action)\n\t\treturn NULL;\n\n\taction->push_vlan->vlan_hdr = vlan_hdr_h;\n\treturn action;\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_packet_reformat(struct mlx5dr_domain *dmn,\n\t\t\t\t     enum mlx5dr_action_reformat_type reformat_type,\n\t\t\t\t     u8 reformat_param_0,\n\t\t\t\t     u8 reformat_param_1,\n\t\t\t\t     size_t data_sz,\n\t\t\t\t     void *data)\n{\n\tenum mlx5dr_action_type action_type;\n\tstruct mlx5dr_action *action;\n\tint ret;\n\n\trefcount_inc(&dmn->refcount);\n\n\t \n\tret = dr_action_reformat_to_action_type(reformat_type, &action_type);\n\tif (ret) {\n\t\tmlx5dr_dbg(dmn, \"Invalid reformat_type provided\\n\");\n\t\tgoto dec_ref;\n\t}\n\n\tret = dr_action_verify_reformat_params(action_type, dmn,\n\t\t\t\t\t       reformat_param_0, reformat_param_1,\n\t\t\t\t\t       data_sz, data);\n\tif (ret)\n\t\tgoto dec_ref;\n\n\taction = dr_action_create_generic(action_type);\n\tif (!action)\n\t\tgoto dec_ref;\n\n\taction->reformat->dmn = dmn;\n\n\tret = dr_action_create_reformat_action(dmn,\n\t\t\t\t\t       reformat_param_0,\n\t\t\t\t\t       reformat_param_1,\n\t\t\t\t\t       data_sz,\n\t\t\t\t\t       data,\n\t\t\t\t\t       action);\n\tif (ret) {\n\t\tmlx5dr_dbg(dmn, \"Failed creating reformat action %d\\n\", ret);\n\t\tgoto free_action;\n\t}\n\n\treturn action;\n\nfree_action:\n\tkfree(action);\ndec_ref:\n\trefcount_dec(&dmn->refcount);\n\treturn NULL;\n}\n\nstatic int\ndr_action_modify_sw_to_hw_add(struct mlx5dr_domain *dmn,\n\t\t\t      __be64 *sw_action,\n\t\t\t      __be64 *hw_action,\n\t\t\t      const struct mlx5dr_ste_action_modify_field **ret_hw_info)\n{\n\tconst struct mlx5dr_ste_action_modify_field *hw_action_info;\n\tu8 max_length;\n\tu16 sw_field;\n\tu32 data;\n\n\t \n\tsw_field = MLX5_GET(set_action_in, sw_action, field);\n\tdata = MLX5_GET(set_action_in, sw_action, data);\n\n\t \n\thw_action_info = mlx5dr_ste_conv_modify_hdr_sw_field(dmn->ste_ctx, sw_field);\n\tif (!hw_action_info) {\n\t\tmlx5dr_dbg(dmn, \"Modify add action invalid field given\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tmax_length = hw_action_info->end - hw_action_info->start + 1;\n\n\tmlx5dr_ste_set_action_add(dmn->ste_ctx,\n\t\t\t\t  hw_action,\n\t\t\t\t  hw_action_info->hw_field,\n\t\t\t\t  hw_action_info->start,\n\t\t\t\t  max_length,\n\t\t\t\t  data);\n\n\t*ret_hw_info = hw_action_info;\n\n\treturn 0;\n}\n\nstatic int\ndr_action_modify_sw_to_hw_set(struct mlx5dr_domain *dmn,\n\t\t\t      __be64 *sw_action,\n\t\t\t      __be64 *hw_action,\n\t\t\t      const struct mlx5dr_ste_action_modify_field **ret_hw_info)\n{\n\tconst struct mlx5dr_ste_action_modify_field *hw_action_info;\n\tu8 offset, length, max_length;\n\tu16 sw_field;\n\tu32 data;\n\n\t \n\tlength = MLX5_GET(set_action_in, sw_action, length);\n\toffset = MLX5_GET(set_action_in, sw_action, offset);\n\tsw_field = MLX5_GET(set_action_in, sw_action, field);\n\tdata = MLX5_GET(set_action_in, sw_action, data);\n\n\t \n\thw_action_info = mlx5dr_ste_conv_modify_hdr_sw_field(dmn->ste_ctx, sw_field);\n\tif (!hw_action_info) {\n\t\tmlx5dr_dbg(dmn, \"Modify set action invalid field given\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tlength = length ? length : 32;\n\n\tmax_length = hw_action_info->end - hw_action_info->start + 1;\n\n\tif (length + offset > max_length) {\n\t\tmlx5dr_dbg(dmn, \"Modify action length + offset exceeds limit\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tmlx5dr_ste_set_action_set(dmn->ste_ctx,\n\t\t\t\t  hw_action,\n\t\t\t\t  hw_action_info->hw_field,\n\t\t\t\t  hw_action_info->start + offset,\n\t\t\t\t  length,\n\t\t\t\t  data);\n\n\t*ret_hw_info = hw_action_info;\n\n\treturn 0;\n}\n\nstatic int\ndr_action_modify_sw_to_hw_copy(struct mlx5dr_domain *dmn,\n\t\t\t       __be64 *sw_action,\n\t\t\t       __be64 *hw_action,\n\t\t\t       const struct mlx5dr_ste_action_modify_field **ret_dst_hw_info,\n\t\t\t       const struct mlx5dr_ste_action_modify_field **ret_src_hw_info)\n{\n\tu8 src_offset, dst_offset, src_max_length, dst_max_length, length;\n\tconst struct mlx5dr_ste_action_modify_field *hw_dst_action_info;\n\tconst struct mlx5dr_ste_action_modify_field *hw_src_action_info;\n\tu16 src_field, dst_field;\n\n\t \n\tsrc_field = MLX5_GET(copy_action_in, sw_action, src_field);\n\tdst_field = MLX5_GET(copy_action_in, sw_action, dst_field);\n\tsrc_offset = MLX5_GET(copy_action_in, sw_action, src_offset);\n\tdst_offset = MLX5_GET(copy_action_in, sw_action, dst_offset);\n\tlength = MLX5_GET(copy_action_in, sw_action, length);\n\n\t \n\thw_src_action_info = mlx5dr_ste_conv_modify_hdr_sw_field(dmn->ste_ctx, src_field);\n\thw_dst_action_info = mlx5dr_ste_conv_modify_hdr_sw_field(dmn->ste_ctx, dst_field);\n\tif (!hw_src_action_info || !hw_dst_action_info) {\n\t\tmlx5dr_dbg(dmn, \"Modify copy action invalid field given\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tlength = length ? length : 32;\n\n\tsrc_max_length = hw_src_action_info->end -\n\t\t\t hw_src_action_info->start + 1;\n\tdst_max_length = hw_dst_action_info->end -\n\t\t\t hw_dst_action_info->start + 1;\n\n\tif (length + src_offset > src_max_length ||\n\t    length + dst_offset > dst_max_length) {\n\t\tmlx5dr_dbg(dmn, \"Modify action length + offset exceeds limit\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tmlx5dr_ste_set_action_copy(dmn->ste_ctx,\n\t\t\t\t   hw_action,\n\t\t\t\t   hw_dst_action_info->hw_field,\n\t\t\t\t   hw_dst_action_info->start + dst_offset,\n\t\t\t\t   length,\n\t\t\t\t   hw_src_action_info->hw_field,\n\t\t\t\t   hw_src_action_info->start + src_offset);\n\n\t*ret_dst_hw_info = hw_dst_action_info;\n\t*ret_src_hw_info = hw_src_action_info;\n\n\treturn 0;\n}\n\nstatic int\ndr_action_modify_sw_to_hw(struct mlx5dr_domain *dmn,\n\t\t\t  __be64 *sw_action,\n\t\t\t  __be64 *hw_action,\n\t\t\t  const struct mlx5dr_ste_action_modify_field **ret_dst_hw_info,\n\t\t\t  const struct mlx5dr_ste_action_modify_field **ret_src_hw_info)\n{\n\tu8 action;\n\tint ret;\n\n\t*hw_action = 0;\n\t*ret_src_hw_info = NULL;\n\n\t \n\taction = MLX5_GET(set_action_in, sw_action, action_type);\n\n\tswitch (action) {\n\tcase MLX5_ACTION_TYPE_SET:\n\t\tret = dr_action_modify_sw_to_hw_set(dmn, sw_action,\n\t\t\t\t\t\t    hw_action,\n\t\t\t\t\t\t    ret_dst_hw_info);\n\t\tbreak;\n\n\tcase MLX5_ACTION_TYPE_ADD:\n\t\tret = dr_action_modify_sw_to_hw_add(dmn, sw_action,\n\t\t\t\t\t\t    hw_action,\n\t\t\t\t\t\t    ret_dst_hw_info);\n\t\tbreak;\n\n\tcase MLX5_ACTION_TYPE_COPY:\n\t\tret = dr_action_modify_sw_to_hw_copy(dmn, sw_action,\n\t\t\t\t\t\t     hw_action,\n\t\t\t\t\t\t     ret_dst_hw_info,\n\t\t\t\t\t\t     ret_src_hw_info);\n\t\tbreak;\n\n\tdefault:\n\t\tmlx5dr_info(dmn, \"Unsupported action_type for modify action\\n\");\n\t\tret = -EOPNOTSUPP;\n\t}\n\n\treturn ret;\n}\n\nstatic int\ndr_action_modify_check_set_field_limitation(struct mlx5dr_action *action,\n\t\t\t\t\t    const __be64 *sw_action)\n{\n\tu16 sw_field = MLX5_GET(set_action_in, sw_action, field);\n\tstruct mlx5dr_domain *dmn = action->rewrite->dmn;\n\n\tif (sw_field == MLX5_ACTION_IN_FIELD_METADATA_REG_A) {\n\t\taction->rewrite->allow_rx = 0;\n\t\tif (dmn->type != MLX5DR_DOMAIN_TYPE_NIC_TX) {\n\t\t\tmlx5dr_dbg(dmn, \"Unsupported field %d for RX/FDB set action\\n\",\n\t\t\t\t   sw_field);\n\t\t\treturn -EINVAL;\n\t\t}\n\t} else if (sw_field == MLX5_ACTION_IN_FIELD_METADATA_REG_B) {\n\t\taction->rewrite->allow_tx = 0;\n\t\tif (dmn->type != MLX5DR_DOMAIN_TYPE_NIC_RX) {\n\t\t\tmlx5dr_dbg(dmn, \"Unsupported field %d for TX/FDB set action\\n\",\n\t\t\t\t   sw_field);\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tif (!action->rewrite->allow_rx && !action->rewrite->allow_tx) {\n\t\tmlx5dr_dbg(dmn, \"Modify SET actions not supported on both RX and TX\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int\ndr_action_modify_check_add_field_limitation(struct mlx5dr_action *action,\n\t\t\t\t\t    const __be64 *sw_action)\n{\n\tu16 sw_field = MLX5_GET(set_action_in, sw_action, field);\n\tstruct mlx5dr_domain *dmn = action->rewrite->dmn;\n\n\tif (sw_field != MLX5_ACTION_IN_FIELD_OUT_IP_TTL &&\n\t    sw_field != MLX5_ACTION_IN_FIELD_OUT_IPV6_HOPLIMIT &&\n\t    sw_field != MLX5_ACTION_IN_FIELD_OUT_TCP_SEQ_NUM &&\n\t    sw_field != MLX5_ACTION_IN_FIELD_OUT_TCP_ACK_NUM) {\n\t\tmlx5dr_dbg(dmn, \"Unsupported field %d for add action\\n\",\n\t\t\t   sw_field);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int\ndr_action_modify_check_copy_field_limitation(struct mlx5dr_action *action,\n\t\t\t\t\t     const __be64 *sw_action)\n{\n\tstruct mlx5dr_domain *dmn = action->rewrite->dmn;\n\tu16 sw_fields[2];\n\tint i;\n\n\tsw_fields[0] = MLX5_GET(copy_action_in, sw_action, src_field);\n\tsw_fields[1] = MLX5_GET(copy_action_in, sw_action, dst_field);\n\n\tfor (i = 0; i < 2; i++) {\n\t\tif (sw_fields[i] == MLX5_ACTION_IN_FIELD_METADATA_REG_A) {\n\t\t\taction->rewrite->allow_rx = 0;\n\t\t\tif (dmn->type != MLX5DR_DOMAIN_TYPE_NIC_TX) {\n\t\t\t\tmlx5dr_dbg(dmn, \"Unsupported field %d for RX/FDB set action\\n\",\n\t\t\t\t\t   sw_fields[i]);\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t} else if (sw_fields[i] == MLX5_ACTION_IN_FIELD_METADATA_REG_B) {\n\t\t\taction->rewrite->allow_tx = 0;\n\t\t\tif (dmn->type != MLX5DR_DOMAIN_TYPE_NIC_RX) {\n\t\t\t\tmlx5dr_dbg(dmn, \"Unsupported field %d for TX/FDB set action\\n\",\n\t\t\t\t\t   sw_fields[i]);\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t}\n\t}\n\n\tif (!action->rewrite->allow_rx && !action->rewrite->allow_tx) {\n\t\tmlx5dr_dbg(dmn, \"Modify copy actions not supported on both RX and TX\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int\ndr_action_modify_check_field_limitation(struct mlx5dr_action *action,\n\t\t\t\t\tconst __be64 *sw_action)\n{\n\tstruct mlx5dr_domain *dmn = action->rewrite->dmn;\n\tu8 action_type;\n\tint ret;\n\n\taction_type = MLX5_GET(set_action_in, sw_action, action_type);\n\n\tswitch (action_type) {\n\tcase MLX5_ACTION_TYPE_SET:\n\t\tret = dr_action_modify_check_set_field_limitation(action,\n\t\t\t\t\t\t\t\t  sw_action);\n\t\tbreak;\n\n\tcase MLX5_ACTION_TYPE_ADD:\n\t\tret = dr_action_modify_check_add_field_limitation(action,\n\t\t\t\t\t\t\t\t  sw_action);\n\t\tbreak;\n\n\tcase MLX5_ACTION_TYPE_COPY:\n\t\tret = dr_action_modify_check_copy_field_limitation(action,\n\t\t\t\t\t\t\t\t   sw_action);\n\t\tbreak;\n\n\tdefault:\n\t\tmlx5dr_info(dmn, \"Unsupported action %d modify action\\n\",\n\t\t\t    action_type);\n\t\tret = -EOPNOTSUPP;\n\t}\n\n\treturn ret;\n}\n\nstatic bool\ndr_action_modify_check_is_ttl_modify(const void *sw_action)\n{\n\tu16 sw_field = MLX5_GET(set_action_in, sw_action, field);\n\n\treturn sw_field == MLX5_ACTION_IN_FIELD_OUT_IP_TTL;\n}\n\nstatic int dr_actions_convert_modify_header(struct mlx5dr_action *action,\n\t\t\t\t\t    u32 max_hw_actions,\n\t\t\t\t\t    u32 num_sw_actions,\n\t\t\t\t\t    __be64 sw_actions[],\n\t\t\t\t\t    __be64 hw_actions[],\n\t\t\t\t\t    u32 *num_hw_actions,\n\t\t\t\t\t    bool *modify_ttl)\n{\n\tconst struct mlx5dr_ste_action_modify_field *hw_dst_action_info;\n\tconst struct mlx5dr_ste_action_modify_field *hw_src_action_info;\n\tstruct mlx5dr_domain *dmn = action->rewrite->dmn;\n\t__be64 *modify_ttl_sw_action = NULL;\n\tint ret, i, hw_idx = 0;\n\t__be64 *sw_action;\n\t__be64 hw_action;\n\tu16 hw_field = 0;\n\tu32 l3_type = 0;\n\tu32 l4_type = 0;\n\n\t*modify_ttl = false;\n\n\taction->rewrite->allow_rx = 1;\n\taction->rewrite->allow_tx = 1;\n\n\tfor (i = 0; i < num_sw_actions || modify_ttl_sw_action; i++) {\n\t\t \n\t\tif (i == num_sw_actions) {\n\t\t\tsw_action = modify_ttl_sw_action;\n\t\t\tmodify_ttl_sw_action = NULL;\n\t\t} else {\n\t\t\tsw_action = &sw_actions[i];\n\t\t}\n\n\t\tret = dr_action_modify_check_field_limitation(action,\n\t\t\t\t\t\t\t      sw_action);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (!(*modify_ttl) &&\n\t\t    dr_action_modify_check_is_ttl_modify(sw_action)) {\n\t\t\tmodify_ttl_sw_action = sw_action;\n\t\t\t*modify_ttl = true;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tret = dr_action_modify_sw_to_hw(dmn,\n\t\t\t\t\t\tsw_action,\n\t\t\t\t\t\t&hw_action,\n\t\t\t\t\t\t&hw_dst_action_info,\n\t\t\t\t\t\t&hw_src_action_info);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tif (l3_type && hw_dst_action_info->l3_type &&\n\t\t    hw_dst_action_info->l3_type != l3_type) {\n\t\t\tmlx5dr_dbg(dmn, \"Action list can't support two different L3 types\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tif (hw_dst_action_info->l3_type)\n\t\t\tl3_type = hw_dst_action_info->l3_type;\n\n\t\t \n\t\tif (l4_type && hw_dst_action_info->l4_type &&\n\t\t    hw_dst_action_info->l4_type != l4_type) {\n\t\t\tmlx5dr_dbg(dmn, \"Action list can't support two different L4 types\\n\");\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tif (hw_dst_action_info->l4_type)\n\t\t\tl4_type = hw_dst_action_info->l4_type;\n\n\t\t \n\t\tif ((hw_idx % 2) && (hw_field == hw_dst_action_info->hw_field ||\n\t\t\t\t     (hw_src_action_info &&\n\t\t\t\t      hw_field == hw_src_action_info->hw_field))) {\n\t\t\t \n\t\t\thw_idx++;\n\t\t\tif (hw_idx >= max_hw_actions) {\n\t\t\t\tmlx5dr_dbg(dmn, \"Modify header action number exceeds HW limit\\n\");\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t}\n\t\thw_field = hw_dst_action_info->hw_field;\n\n\t\thw_actions[hw_idx] = hw_action;\n\t\thw_idx++;\n\t}\n\n\t \n\tif (!hw_idx)\n\t\thw_idx++;\n\n\t*num_hw_actions = hw_idx;\n\n\treturn 0;\n}\n\nstatic int dr_action_create_modify_action(struct mlx5dr_domain *dmn,\n\t\t\t\t\t  size_t actions_sz,\n\t\t\t\t\t  __be64 actions[],\n\t\t\t\t\t  struct mlx5dr_action *action)\n{\n\tu32 max_hw_actions;\n\tu32 num_hw_actions;\n\tu32 num_sw_actions;\n\t__be64 *hw_actions;\n\tbool modify_ttl;\n\tint ret;\n\n\tnum_sw_actions = actions_sz / DR_MODIFY_ACTION_SIZE;\n\tmax_hw_actions = mlx5dr_icm_pool_chunk_size_to_entries(DR_CHUNK_SIZE_16);\n\n\tif (num_sw_actions > max_hw_actions) {\n\t\tmlx5dr_dbg(dmn, \"Max number of actions %d exceeds limit %d\\n\",\n\t\t\t   num_sw_actions, max_hw_actions);\n\t\treturn -EINVAL;\n\t}\n\n\thw_actions = kcalloc(1, max_hw_actions * DR_MODIFY_ACTION_SIZE, GFP_KERNEL);\n\tif (!hw_actions)\n\t\treturn -ENOMEM;\n\n\tret = dr_actions_convert_modify_header(action,\n\t\t\t\t\t       max_hw_actions,\n\t\t\t\t\t       num_sw_actions,\n\t\t\t\t\t       actions,\n\t\t\t\t\t       hw_actions,\n\t\t\t\t\t       &num_hw_actions,\n\t\t\t\t\t       &modify_ttl);\n\tif (ret)\n\t\tgoto free_hw_actions;\n\n\taction->rewrite->modify_ttl = modify_ttl;\n\taction->rewrite->data = (u8 *)hw_actions;\n\taction->rewrite->num_of_actions = num_hw_actions;\n\n\tif (num_hw_actions == 1 &&\n\t    dmn->info.caps.sw_format_ver >= MLX5_STEERING_FORMAT_CONNECTX_6DX) {\n\t\taction->rewrite->single_action_opt = true;\n\t} else {\n\t\taction->rewrite->single_action_opt = false;\n\t\tret = mlx5dr_ste_alloc_modify_hdr(action);\n\t\tif (ret)\n\t\t\tgoto free_hw_actions;\n\t}\n\n\treturn 0;\n\nfree_hw_actions:\n\tkfree(hw_actions);\n\treturn ret;\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_modify_header(struct mlx5dr_domain *dmn,\n\t\t\t\t   u32 flags,\n\t\t\t\t   size_t actions_sz,\n\t\t\t\t   __be64 actions[])\n{\n\tstruct mlx5dr_action *action;\n\tint ret = 0;\n\n\trefcount_inc(&dmn->refcount);\n\n\tif (actions_sz % DR_MODIFY_ACTION_SIZE) {\n\t\tmlx5dr_dbg(dmn, \"Invalid modify actions size provided\\n\");\n\t\tgoto dec_ref;\n\t}\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_MODIFY_HDR);\n\tif (!action)\n\t\tgoto dec_ref;\n\n\taction->rewrite->dmn = dmn;\n\n\tret = dr_action_create_modify_action(dmn,\n\t\t\t\t\t     actions_sz,\n\t\t\t\t\t     actions,\n\t\t\t\t\t     action);\n\tif (ret) {\n\t\tmlx5dr_dbg(dmn, \"Failed creating modify header action %d\\n\", ret);\n\t\tgoto free_action;\n\t}\n\n\treturn action;\n\nfree_action:\n\tkfree(action);\ndec_ref:\n\trefcount_dec(&dmn->refcount);\n\treturn NULL;\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_dest_vport(struct mlx5dr_domain *dmn,\n\t\t\t\tu16 vport, u8 vhca_id_valid,\n\t\t\t\tu16 vhca_id)\n{\n\tstruct mlx5dr_cmd_vport_cap *vport_cap;\n\tstruct mlx5dr_domain *vport_dmn;\n\tstruct mlx5dr_action *action;\n\tu8 peer_vport;\n\n\tpeer_vport = vhca_id_valid && mlx5_core_is_pf(dmn->mdev) &&\n\t\t(vhca_id != dmn->info.caps.gvmi);\n\tvport_dmn = peer_vport ? xa_load(&dmn->peer_dmn_xa, vhca_id) : dmn;\n\tif (!vport_dmn) {\n\t\tmlx5dr_dbg(dmn, \"No peer vport domain for given vhca_id\\n\");\n\t\treturn NULL;\n\t}\n\n\tif (vport_dmn->type != MLX5DR_DOMAIN_TYPE_FDB) {\n\t\tmlx5dr_dbg(dmn, \"Domain doesn't support vport actions\\n\");\n\t\treturn NULL;\n\t}\n\n\tvport_cap = mlx5dr_domain_get_vport_cap(vport_dmn, vport);\n\tif (!vport_cap) {\n\t\tmlx5dr_err(dmn,\n\t\t\t   \"Failed to get vport 0x%x caps - vport is disabled or invalid\\n\",\n\t\t\t   vport);\n\t\treturn NULL;\n\t}\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_VPORT);\n\tif (!action)\n\t\treturn NULL;\n\n\taction->vport->dmn = vport_dmn;\n\taction->vport->caps = vport_cap;\n\n\treturn action;\n}\n\nstruct mlx5dr_action *\nmlx5dr_action_create_aso(struct mlx5dr_domain *dmn, u32 obj_id,\n\t\t\t u8 dest_reg_id, u8 aso_type,\n\t\t\t u8 init_color, u8 meter_id)\n{\n\tstruct mlx5dr_action *action;\n\n\tif (aso_type != MLX5_EXE_ASO_FLOW_METER)\n\t\treturn NULL;\n\n\tif (init_color > MLX5_FLOW_METER_COLOR_UNDEFINED)\n\t\treturn NULL;\n\n\taction = dr_action_create_generic(DR_ACTION_TYP_ASO_FLOW_METER);\n\tif (!action)\n\t\treturn NULL;\n\n\taction->aso->obj_id = obj_id;\n\taction->aso->offset = meter_id;\n\taction->aso->dest_reg_id = dest_reg_id;\n\taction->aso->init_color = init_color;\n\taction->aso->dmn = dmn;\n\n\trefcount_inc(&dmn->refcount);\n\n\treturn action;\n}\n\nu32 mlx5dr_action_get_pkt_reformat_id(struct mlx5dr_action *action)\n{\n\treturn action->reformat->id;\n}\n\nint mlx5dr_action_destroy(struct mlx5dr_action *action)\n{\n\tif (WARN_ON_ONCE(refcount_read(&action->refcount) > 1))\n\t\treturn -EBUSY;\n\n\tswitch (action->action_type) {\n\tcase DR_ACTION_TYP_FT:\n\t\tif (action->dest_tbl->is_fw_tbl)\n\t\t\trefcount_dec(&action->dest_tbl->fw_tbl.dmn->refcount);\n\t\telse\n\t\t\trefcount_dec(&action->dest_tbl->tbl->refcount);\n\n\t\tif (action->dest_tbl->is_fw_tbl &&\n\t\t    action->dest_tbl->fw_tbl.num_of_ref_actions) {\n\t\t\tstruct mlx5dr_action **ref_actions;\n\t\t\tint i;\n\n\t\t\tref_actions = action->dest_tbl->fw_tbl.ref_actions;\n\t\t\tfor (i = 0; i < action->dest_tbl->fw_tbl.num_of_ref_actions; i++)\n\t\t\t\trefcount_dec(&ref_actions[i]->refcount);\n\n\t\t\tkfree(ref_actions);\n\n\t\t\tmlx5dr_fw_destroy_md_tbl(action->dest_tbl->fw_tbl.dmn,\n\t\t\t\t\t\t action->dest_tbl->fw_tbl.id,\n\t\t\t\t\t\t action->dest_tbl->fw_tbl.group_id);\n\t\t}\n\t\tbreak;\n\tcase DR_ACTION_TYP_TNL_L2_TO_L2:\n\tcase DR_ACTION_TYP_REMOVE_HDR:\n\t\trefcount_dec(&action->reformat->dmn->refcount);\n\t\tbreak;\n\tcase DR_ACTION_TYP_TNL_L3_TO_L2:\n\t\tmlx5dr_ste_free_modify_hdr(action);\n\t\tkfree(action->rewrite->data);\n\t\trefcount_dec(&action->rewrite->dmn->refcount);\n\t\tbreak;\n\tcase DR_ACTION_TYP_L2_TO_TNL_L2:\n\tcase DR_ACTION_TYP_L2_TO_TNL_L3:\n\tcase DR_ACTION_TYP_INSERT_HDR:\n\t\tmlx5dr_cmd_destroy_reformat_ctx((action->reformat->dmn)->mdev,\n\t\t\t\t\t\taction->reformat->id);\n\t\trefcount_dec(&action->reformat->dmn->refcount);\n\t\tbreak;\n\tcase DR_ACTION_TYP_MODIFY_HDR:\n\t\tif (!action->rewrite->single_action_opt)\n\t\t\tmlx5dr_ste_free_modify_hdr(action);\n\t\tkfree(action->rewrite->data);\n\t\trefcount_dec(&action->rewrite->dmn->refcount);\n\t\tbreak;\n\tcase DR_ACTION_TYP_SAMPLER:\n\t\trefcount_dec(&action->sampler->dmn->refcount);\n\t\tbreak;\n\tcase DR_ACTION_TYP_ASO_FLOW_METER:\n\t\trefcount_dec(&action->aso->dmn->refcount);\n\t\tbreak;\n\tcase DR_ACTION_TYP_RANGE:\n\t\tdr_action_destroy_range_definer(action);\n\t\tmlx5dr_action_destroy(action->range->miss_tbl_action);\n\t\tmlx5dr_action_destroy(action->range->hit_tbl_action);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tkfree(action);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}