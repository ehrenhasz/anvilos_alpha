{
  "module_name": "dr_types.h",
  "hash_id": "75e4177506754b8203fd35fabc766261f43b4b3971df5d40b99f552ed5c9a9ec",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_types.h",
  "human_readable_source": " \n \n\n#ifndef\t_DR_TYPES_\n#define\t_DR_TYPES_\n\n#include <linux/mlx5/vport.h>\n#include <linux/refcount.h>\n#include \"fs_core.h\"\n#include \"wq.h\"\n#include \"lib/mlx5.h\"\n#include \"mlx5_ifc_dr.h\"\n#include \"mlx5dr.h\"\n#include \"dr_dbg.h\"\n\n#define DR_RULE_MAX_STES 18\n#define DR_ACTION_MAX_STES 5\n#define DR_STE_SVLAN 0x1\n#define DR_STE_CVLAN 0x2\n#define DR_SZ_MATCH_PARAM (MLX5_ST_SZ_DW_MATCH_PARAM * 4)\n#define DR_NUM_OF_FLEX_PARSERS 8\n#define DR_STE_MAX_FLEX_0_ID 3\n#define DR_STE_MAX_FLEX_1_ID 7\n#define DR_ACTION_CACHE_LINE_SIZE 64\n\n#define mlx5dr_err(dmn, arg...) mlx5_core_err((dmn)->mdev, ##arg)\n#define mlx5dr_info(dmn, arg...) mlx5_core_info((dmn)->mdev, ##arg)\n#define mlx5dr_dbg(dmn, arg...) mlx5_core_dbg((dmn)->mdev, ##arg)\n\nstruct mlx5dr_ptrn_mgr;\nstruct mlx5dr_arg_mgr;\nstruct mlx5dr_arg_obj;\n\nstatic inline bool dr_is_flex_parser_0_id(u8 parser_id)\n{\n\treturn parser_id <= DR_STE_MAX_FLEX_0_ID;\n}\n\nstatic inline bool dr_is_flex_parser_1_id(u8 parser_id)\n{\n\treturn parser_id > DR_STE_MAX_FLEX_0_ID;\n}\n\nenum mlx5dr_icm_chunk_size {\n\tDR_CHUNK_SIZE_1,\n\tDR_CHUNK_SIZE_MIN = DR_CHUNK_SIZE_1,  \n\tDR_CHUNK_SIZE_2,\n\tDR_CHUNK_SIZE_4,\n\tDR_CHUNK_SIZE_8,\n\tDR_CHUNK_SIZE_16,\n\tDR_CHUNK_SIZE_32,\n\tDR_CHUNK_SIZE_64,\n\tDR_CHUNK_SIZE_128,\n\tDR_CHUNK_SIZE_256,\n\tDR_CHUNK_SIZE_512,\n\tDR_CHUNK_SIZE_1K,\n\tDR_CHUNK_SIZE_2K,\n\tDR_CHUNK_SIZE_4K,\n\tDR_CHUNK_SIZE_8K,\n\tDR_CHUNK_SIZE_16K,\n\tDR_CHUNK_SIZE_32K,\n\tDR_CHUNK_SIZE_64K,\n\tDR_CHUNK_SIZE_128K,\n\tDR_CHUNK_SIZE_256K,\n\tDR_CHUNK_SIZE_512K,\n\tDR_CHUNK_SIZE_1024K,\n\tDR_CHUNK_SIZE_2048K,\n\tDR_CHUNK_SIZE_MAX,\n};\n\nenum mlx5dr_icm_type {\n\tDR_ICM_TYPE_STE,\n\tDR_ICM_TYPE_MODIFY_ACTION,\n\tDR_ICM_TYPE_MODIFY_HDR_PTRN,\n\tDR_ICM_TYPE_MAX,\n};\n\nstatic inline enum mlx5dr_icm_chunk_size\nmlx5dr_icm_next_higher_chunk(enum mlx5dr_icm_chunk_size chunk)\n{\n\tchunk += 2;\n\tif (chunk < DR_CHUNK_SIZE_MAX)\n\t\treturn chunk;\n\n\treturn DR_CHUNK_SIZE_MAX;\n}\n\nenum {\n\tDR_STE_SIZE = 64,\n\tDR_STE_SIZE_CTRL = 32,\n\tDR_STE_SIZE_MATCH_TAG = 32,\n\tDR_STE_SIZE_TAG = 16,\n\tDR_STE_SIZE_MASK = 16,\n\tDR_STE_SIZE_REDUCED = DR_STE_SIZE - DR_STE_SIZE_MASK,\n};\n\nenum mlx5dr_ste_ctx_action_cap {\n\tDR_STE_CTX_ACTION_CAP_NONE = 0,\n\tDR_STE_CTX_ACTION_CAP_TX_POP   = 1 << 0,\n\tDR_STE_CTX_ACTION_CAP_RX_PUSH  = 1 << 1,\n\tDR_STE_CTX_ACTION_CAP_RX_ENCAP = 1 << 2,\n\tDR_STE_CTX_ACTION_CAP_POP_MDFY = 1 << 3,\n};\n\nenum {\n\tDR_MODIFY_ACTION_SIZE = 8,\n};\n\nenum mlx5dr_matcher_criteria {\n\tDR_MATCHER_CRITERIA_EMPTY = 0,\n\tDR_MATCHER_CRITERIA_OUTER = 1 << 0,\n\tDR_MATCHER_CRITERIA_MISC = 1 << 1,\n\tDR_MATCHER_CRITERIA_INNER = 1 << 2,\n\tDR_MATCHER_CRITERIA_MISC2 = 1 << 3,\n\tDR_MATCHER_CRITERIA_MISC3 = 1 << 4,\n\tDR_MATCHER_CRITERIA_MISC4 = 1 << 5,\n\tDR_MATCHER_CRITERIA_MISC5 = 1 << 6,\n\tDR_MATCHER_CRITERIA_MAX = 1 << 7,\n};\n\nenum mlx5dr_action_type {\n\tDR_ACTION_TYP_TNL_L2_TO_L2,\n\tDR_ACTION_TYP_L2_TO_TNL_L2,\n\tDR_ACTION_TYP_TNL_L3_TO_L2,\n\tDR_ACTION_TYP_L2_TO_TNL_L3,\n\tDR_ACTION_TYP_DROP,\n\tDR_ACTION_TYP_QP,\n\tDR_ACTION_TYP_FT,\n\tDR_ACTION_TYP_CTR,\n\tDR_ACTION_TYP_TAG,\n\tDR_ACTION_TYP_MODIFY_HDR,\n\tDR_ACTION_TYP_VPORT,\n\tDR_ACTION_TYP_POP_VLAN,\n\tDR_ACTION_TYP_PUSH_VLAN,\n\tDR_ACTION_TYP_INSERT_HDR,\n\tDR_ACTION_TYP_REMOVE_HDR,\n\tDR_ACTION_TYP_SAMPLER,\n\tDR_ACTION_TYP_ASO_FLOW_METER,\n\tDR_ACTION_TYP_RANGE,\n\tDR_ACTION_TYP_MAX,\n};\n\nenum mlx5dr_ipv {\n\tDR_RULE_IPV4,\n\tDR_RULE_IPV6,\n\tDR_RULE_IPV_MAX,\n};\n\nstruct mlx5dr_icm_pool;\nstruct mlx5dr_icm_chunk;\nstruct mlx5dr_icm_buddy_mem;\nstruct mlx5dr_ste_htbl;\nstruct mlx5dr_match_param;\nstruct mlx5dr_cmd_caps;\nstruct mlx5dr_rule_rx_tx;\nstruct mlx5dr_matcher_rx_tx;\nstruct mlx5dr_ste_ctx;\nstruct mlx5dr_send_info_pool;\nstruct mlx5dr_icm_hot_chunk;\n\nstruct mlx5dr_ste {\n\t \n\tu32 refcount;\n\n\t \n\tu8 ste_chain_location;\n\n\t \n\tstruct list_head miss_list_node;\n\n\t \n\tstruct mlx5dr_ste_htbl *htbl;\n\n\tstruct mlx5dr_ste_htbl *next_htbl;\n\n\t \n\tstruct mlx5dr_rule_rx_tx *rule_rx_tx;\n};\n\nstruct mlx5dr_ste_htbl_ctrl {\n\t \n\tunsigned int num_of_valid_entries;\n\n\t \n\tunsigned int num_of_collisions;\n};\n\nstruct mlx5dr_ste_htbl {\n\tu16 lu_type;\n\tu16 byte_mask;\n\tu32 refcount;\n\tstruct mlx5dr_icm_chunk *chunk;\n\tstruct mlx5dr_ste *pointing_ste;\n\tstruct mlx5dr_ste_htbl_ctrl ctrl;\n};\n\nstruct mlx5dr_ste_send_info {\n\tstruct mlx5dr_ste *ste;\n\tstruct list_head send_list;\n\tu16 size;\n\tu16 offset;\n\tu8 data_cont[DR_STE_SIZE];\n\tu8 *data;\n};\n\nvoid mlx5dr_send_fill_and_append_ste_send_info(struct mlx5dr_ste *ste, u16 size,\n\t\t\t\t\t       u16 offset, u8 *data,\n\t\t\t\t\t       struct mlx5dr_ste_send_info *ste_info,\n\t\t\t\t\t       struct list_head *send_list,\n\t\t\t\t\t       bool copy_data);\n\nstruct mlx5dr_ste_build {\n\tu8 inner:1;\n\tu8 rx:1;\n\tu8 vhca_id_valid:1;\n\tstruct mlx5dr_domain *dmn;\n\tstruct mlx5dr_cmd_caps *caps;\n\tu16 lu_type;\n\tu16 byte_mask;\n\tu8 bit_mask[DR_STE_SIZE_MASK];\n\tint (*ste_build_tag_func)(struct mlx5dr_match_param *spec,\n\t\t\t\t  struct mlx5dr_ste_build *sb,\n\t\t\t\t  u8 *tag);\n};\n\nstruct mlx5dr_ste_htbl *\nmlx5dr_ste_htbl_alloc(struct mlx5dr_icm_pool *pool,\n\t\t      enum mlx5dr_icm_chunk_size chunk_size,\n\t\t      u16 lu_type, u16 byte_mask);\n\nint mlx5dr_ste_htbl_free(struct mlx5dr_ste_htbl *htbl);\n\nstatic inline void mlx5dr_htbl_put(struct mlx5dr_ste_htbl *htbl)\n{\n\thtbl->refcount--;\n\tif (!htbl->refcount)\n\t\tmlx5dr_ste_htbl_free(htbl);\n}\n\nstatic inline void mlx5dr_htbl_get(struct mlx5dr_ste_htbl *htbl)\n{\n\thtbl->refcount++;\n}\n\n \nu32 mlx5dr_ste_calc_hash_index(u8 *hw_ste_p, struct mlx5dr_ste_htbl *htbl);\nbool mlx5dr_ste_is_miss_addr_set(struct mlx5dr_ste_ctx *ste_ctx, u8 *hw_ste_p);\nvoid mlx5dr_ste_set_miss_addr(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t      u8 *hw_ste, u64 miss_addr);\nvoid mlx5dr_ste_set_hit_addr(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t     u8 *hw_ste, u64 icm_addr, u32 ht_size);\nvoid mlx5dr_ste_set_hit_addr_by_next_htbl(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t\t  u8 *hw_ste,\n\t\t\t\t\t  struct mlx5dr_ste_htbl *next_htbl);\nvoid mlx5dr_ste_set_bit_mask(u8 *hw_ste_p, u8 *bit_mask);\nbool mlx5dr_ste_is_last_in_rule(struct mlx5dr_matcher_rx_tx *nic_matcher,\n\t\t\t\tu8 ste_location);\nu64 mlx5dr_ste_get_icm_addr(struct mlx5dr_ste *ste);\nu64 mlx5dr_ste_get_mr_addr(struct mlx5dr_ste *ste);\nstruct list_head *mlx5dr_ste_get_miss_list(struct mlx5dr_ste *ste);\n\n#define MLX5DR_MAX_VLANS 2\n#define MLX5DR_INVALID_PATTERN_INDEX 0xffffffff\n\nstruct mlx5dr_ste_actions_attr {\n\tu32\tmodify_index;\n\tu32\tmodify_pat_idx;\n\tu16\tmodify_actions;\n\tu8\t*single_modify_action;\n\tu32\tdecap_index;\n\tu32\tdecap_pat_idx;\n\tu16\tdecap_actions;\n\tu8\tdecap_with_vlan:1;\n\tu64\tfinal_icm_addr;\n\tu32\tflow_tag;\n\tu32\tctr_id;\n\tu16\tgvmi;\n\tu16\thit_gvmi;\n\tstruct {\n\t\tu32\tid;\n\t\tu32\tsize;\n\t\tu8\tparam_0;\n\t\tu8\tparam_1;\n\t} reformat;\n\tstruct {\n\t\tint\tcount;\n\t\tu32\theaders[MLX5DR_MAX_VLANS];\n\t} vlans;\n\n\tstruct {\n\t\tu32 obj_id;\n\t\tu32 offset;\n\t\tu8 dest_reg_id;\n\t\tu8 init_color;\n\t} aso_flow_meter;\n\n\tstruct {\n\t\tu64\tmiss_icm_addr;\n\t\tu32\tdefiner_id;\n\t\tu32\tmin;\n\t\tu32\tmax;\n\t} range;\n};\n\nvoid mlx5dr_ste_set_actions_rx(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t       struct mlx5dr_domain *dmn,\n\t\t\t       u8 *action_type_set,\n\t\t\t       u8 *last_ste,\n\t\t\t       struct mlx5dr_ste_actions_attr *attr,\n\t\t\t       u32 *added_stes);\nvoid mlx5dr_ste_set_actions_tx(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t       struct mlx5dr_domain *dmn,\n\t\t\t       u8 *action_type_set,\n\t\t\t       u8 *last_ste,\n\t\t\t       struct mlx5dr_ste_actions_attr *attr,\n\t\t\t       u32 *added_stes);\n\nvoid mlx5dr_ste_set_action_set(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t       __be64 *hw_action,\n\t\t\t       u8 hw_field,\n\t\t\t       u8 shifter,\n\t\t\t       u8 length,\n\t\t\t       u32 data);\nvoid mlx5dr_ste_set_action_add(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t       __be64 *hw_action,\n\t\t\t       u8 hw_field,\n\t\t\t       u8 shifter,\n\t\t\t       u8 length,\n\t\t\t       u32 data);\nvoid mlx5dr_ste_set_action_copy(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t__be64 *hw_action,\n\t\t\t\tu8 dst_hw_field,\n\t\t\t\tu8 dst_shifter,\n\t\t\t\tu8 dst_len,\n\t\t\t\tu8 src_hw_field,\n\t\t\t\tu8 src_shifter);\nint mlx5dr_ste_set_action_decap_l3_list(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t\tvoid *data,\n\t\t\t\t\tu32 data_sz,\n\t\t\t\t\tu8 *hw_action,\n\t\t\t\t\tu32 hw_action_sz,\n\t\t\t\t\tu16 *used_hw_action_num);\nint mlx5dr_ste_alloc_modify_hdr(struct mlx5dr_action *action);\nvoid mlx5dr_ste_free_modify_hdr(struct mlx5dr_action *action);\n\nconst struct mlx5dr_ste_action_modify_field *\nmlx5dr_ste_conv_modify_hdr_sw_field(struct mlx5dr_ste_ctx *ste_ctx, u16 sw_field);\n\nstruct mlx5dr_ste_ctx *mlx5dr_ste_get_ctx(u8 version);\nvoid mlx5dr_ste_free(struct mlx5dr_ste *ste,\n\t\t     struct mlx5dr_matcher *matcher,\n\t\t     struct mlx5dr_matcher_rx_tx *nic_matcher);\nstatic inline void mlx5dr_ste_put(struct mlx5dr_ste *ste,\n\t\t\t\t  struct mlx5dr_matcher *matcher,\n\t\t\t\t  struct mlx5dr_matcher_rx_tx *nic_matcher)\n{\n\tste->refcount--;\n\tif (!ste->refcount)\n\t\tmlx5dr_ste_free(ste, matcher, nic_matcher);\n}\n\n \nstatic inline void mlx5dr_ste_get(struct mlx5dr_ste *ste)\n{\n\tste->refcount++;\n}\n\nstatic inline bool mlx5dr_ste_is_not_used(struct mlx5dr_ste *ste)\n{\n\treturn !ste->refcount;\n}\n\nbool mlx5dr_ste_equal_tag(void *src, void *dst);\nint mlx5dr_ste_create_next_htbl(struct mlx5dr_matcher *matcher,\n\t\t\t\tstruct mlx5dr_matcher_rx_tx *nic_matcher,\n\t\t\t\tstruct mlx5dr_ste *ste,\n\t\t\t\tu8 *cur_hw_ste,\n\t\t\t\tenum mlx5dr_icm_chunk_size log_table_size);\n\n \nint mlx5dr_ste_build_pre_check(struct mlx5dr_domain *dmn,\n\t\t\t       u8 match_criteria,\n\t\t\t       struct mlx5dr_match_param *mask,\n\t\t\t       struct mlx5dr_match_param *value);\nint mlx5dr_ste_build_ste_arr(struct mlx5dr_matcher *matcher,\n\t\t\t     struct mlx5dr_matcher_rx_tx *nic_matcher,\n\t\t\t     struct mlx5dr_match_param *value,\n\t\t\t     u8 *ste_arr);\nvoid mlx5dr_ste_build_eth_l2_src_dst(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t     struct mlx5dr_ste_build *builder,\n\t\t\t\t     struct mlx5dr_match_param *mask,\n\t\t\t\t     bool inner, bool rx);\nvoid mlx5dr_ste_build_eth_l3_ipv4_5_tuple(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t\t  struct mlx5dr_ste_build *sb,\n\t\t\t\t\t  struct mlx5dr_match_param *mask,\n\t\t\t\t\t  bool inner, bool rx);\nvoid mlx5dr_ste_build_eth_l3_ipv4_misc(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t\t       struct mlx5dr_match_param *mask,\n\t\t\t\t       bool inner, bool rx);\nvoid mlx5dr_ste_build_eth_l3_ipv6_dst(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t      struct mlx5dr_match_param *mask,\n\t\t\t\t      bool inner, bool rx);\nvoid mlx5dr_ste_build_eth_l3_ipv6_src(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t      struct mlx5dr_match_param *mask,\n\t\t\t\t      bool inner, bool rx);\nvoid mlx5dr_ste_build_eth_l2_src(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t struct mlx5dr_match_param *mask,\n\t\t\t\t bool inner, bool rx);\nvoid mlx5dr_ste_build_eth_l2_dst(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t struct mlx5dr_match_param *mask,\n\t\t\t\t bool inner, bool rx);\nvoid mlx5dr_ste_build_eth_l2_tnl(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t struct mlx5dr_match_param *mask,\n\t\t\t\t bool inner, bool rx);\nvoid mlx5dr_ste_build_eth_ipv6_l3_l4(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t     struct mlx5dr_ste_build *sb,\n\t\t\t\t     struct mlx5dr_match_param *mask,\n\t\t\t\t     bool inner, bool rx);\nvoid mlx5dr_ste_build_eth_l4_misc(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t  struct mlx5dr_ste_build *sb,\n\t\t\t\t  struct mlx5dr_match_param *mask,\n\t\t\t\t  bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_gre(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t      struct mlx5dr_match_param *mask,\n\t\t\t      bool inner, bool rx);\nvoid mlx5dr_ste_build_mpls(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t   struct mlx5dr_match_param *mask,\n\t\t\t   bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_mpls(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t       struct mlx5dr_match_param *mask,\n\t\t\t       bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_mpls_over_gre(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t\tstruct mlx5dr_ste_build *sb,\n\t\t\t\t\tstruct mlx5dr_match_param *mask,\n\t\t\t\t\tstruct mlx5dr_cmd_caps *caps,\n\t\t\t\t\tbool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_mpls_over_udp(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t\tstruct mlx5dr_ste_build *sb,\n\t\t\t\t\tstruct mlx5dr_match_param *mask,\n\t\t\t\t\tstruct mlx5dr_cmd_caps *caps,\n\t\t\t\t\tbool inner, bool rx);\nvoid mlx5dr_ste_build_icmp(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t   struct mlx5dr_match_param *mask,\n\t\t\t   struct mlx5dr_cmd_caps *caps,\n\t\t\t   bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_vxlan_gpe(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t    struct mlx5dr_match_param *mask,\n\t\t\t\t    bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_geneve(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t struct mlx5dr_match_param *mask,\n\t\t\t\t bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_geneve_tlv_opt(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t\t struct mlx5dr_match_param *mask,\n\t\t\t\t\t struct mlx5dr_cmd_caps *caps,\n\t\t\t\t\t bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_geneve_tlv_opt_exist(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t\t\t       struct mlx5dr_match_param *mask,\n\t\t\t\t\t       struct mlx5dr_cmd_caps *caps,\n\t\t\t\t\t       bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_gtpu(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t       struct mlx5dr_match_param *mask,\n\t\t\t       bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_gtpu_flex_parser_0(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t\t     struct mlx5dr_ste_build *sb,\n\t\t\t\t\t     struct mlx5dr_match_param *mask,\n\t\t\t\t\t     struct mlx5dr_cmd_caps *caps,\n\t\t\t\t\t     bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_gtpu_flex_parser_1(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t\t     struct mlx5dr_ste_build *sb,\n\t\t\t\t\t     struct mlx5dr_match_param *mask,\n\t\t\t\t\t     struct mlx5dr_cmd_caps *caps,\n\t\t\t\t\t     bool inner, bool rx);\nvoid mlx5dr_ste_build_tnl_header_0_1(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t     struct mlx5dr_ste_build *sb,\n\t\t\t\t     struct mlx5dr_match_param *mask,\n\t\t\t\t     bool inner, bool rx);\nvoid mlx5dr_ste_build_general_purpose(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t      struct mlx5dr_match_param *mask,\n\t\t\t\t      bool inner, bool rx);\nvoid mlx5dr_ste_build_register_0(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t struct mlx5dr_match_param *mask,\n\t\t\t\t bool inner, bool rx);\nvoid mlx5dr_ste_build_register_1(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t struct mlx5dr_match_param *mask,\n\t\t\t\t bool inner, bool rx);\nvoid mlx5dr_ste_build_src_gvmi_qpn(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t   struct mlx5dr_match_param *mask,\n\t\t\t\t   struct mlx5dr_domain *dmn,\n\t\t\t\t   bool inner, bool rx);\nvoid mlx5dr_ste_build_flex_parser_0(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t    struct mlx5dr_match_param *mask,\n\t\t\t\t    bool inner, bool rx);\nvoid mlx5dr_ste_build_flex_parser_1(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t    struct mlx5dr_match_param *mask,\n\t\t\t\t    bool inner, bool rx);\nvoid mlx5dr_ste_build_empty_always_hit(struct mlx5dr_ste_build *sb, bool rx);\n\n \nint mlx5dr_actions_build_ste_arr(struct mlx5dr_matcher *matcher,\n\t\t\t\t struct mlx5dr_matcher_rx_tx *nic_matcher,\n\t\t\t\t struct mlx5dr_action *actions[],\n\t\t\t\t u32 num_actions,\n\t\t\t\t u8 *ste_arr,\n\t\t\t\t u32 *new_hw_ste_arr_sz);\n\nstruct mlx5dr_match_spec {\n\tu32 smac_47_16;\t\t \n\t \n\tu32 smac_15_0:16;\t \n\tu32 ethertype:16;\n\n\tu32 dmac_47_16;\t\t \n\n\tu32 dmac_15_0:16;\t \n\t \n\tu32 first_prio:3;\n\t \n\tu32 first_cfi:1;\n\t \n\tu32 first_vid:12;\n\n\tu32 ip_protocol:8;\t \n\t \n\tu32 ip_dscp:6;\n\t \n\tu32 ip_ecn:2;\n\t \n\tu32 cvlan_tag:1;\n\t \n\tu32 svlan_tag:1;\n\tu32 frag:1;\t\t \n\tu32 ip_version:4;\t \n\t \n\tu32 tcp_flags:9;\n\n\t \n\tu32 tcp_sport:16;\n\t \n\tu32 tcp_dport:16;\n\n\tu32 reserved_auto1:16;\n\tu32 ipv4_ihl:4;\n\tu32 reserved_auto2:4;\n\tu32 ttl_hoplimit:8;\n\n\t \n\tu32 udp_sport:16;\n\t \n\tu32 udp_dport:16;\n\n\t \n\tu32 src_ip_127_96;\n\t \n\tu32 src_ip_95_64;\n\t \n\tu32 src_ip_63_32;\n\t \n\tu32 src_ip_31_0;\n\t \n\tu32 dst_ip_127_96;\n\t \n\tu32 dst_ip_95_64;\n\t \n\tu32 dst_ip_63_32;\n\t \n\tu32 dst_ip_31_0;\n};\n\nstruct mlx5dr_match_misc {\n\t \n\tu32 gre_c_present:1;\n\tu32 reserved_auto1:1;\n\t \n\tu32 gre_k_present:1;\n\t \n\tu32 gre_s_present:1;\n\tu32 source_vhca_port:4;\n\tu32 source_sqn:24;\t\t \n\n\tu32 source_eswitch_owner_vhca_id:16;\n\t \n\tu32 source_port:16;\n\n\t \n\tu32 outer_second_prio:3;\n\t \n\tu32 outer_second_cfi:1;\n\t \n\tu32 outer_second_vid:12;\n\t \n\tu32 inner_second_prio:3;\n\t \n\tu32 inner_second_cfi:1;\n\t \n\tu32 inner_second_vid:12;\n\n\tu32 outer_second_cvlan_tag:1;\n\tu32 inner_second_cvlan_tag:1;\n\t \n\tu32 outer_second_svlan_tag:1;\n\t \n\tu32 inner_second_svlan_tag:1;\n\t \n\tu32 reserved_auto2:12;\n\t \n\tu32 gre_protocol:16;\t\t \n\n\tu32 gre_key_h:24;\t\t \n\tu32 gre_key_l:8;\t\t \n\n\tu32 vxlan_vni:24;\t\t \n\tu32 reserved_auto3:8;\n\n\tu32 geneve_vni:24;\t\t \n\tu32 reserved_auto4:6;\n\tu32 geneve_tlv_option_0_exist:1;\n\tu32 geneve_oam:1;\t\t \n\n\tu32 reserved_auto5:12;\n\tu32 outer_ipv6_flow_label:20;\t \n\n\tu32 reserved_auto6:12;\n\tu32 inner_ipv6_flow_label:20;\t \n\n\tu32 reserved_auto7:10;\n\tu32 geneve_opt_len:6;\t\t \n\tu32 geneve_protocol_type:16;\t \n\n\tu32 reserved_auto8:8;\n\tu32 bth_dst_qp:24;\t\t \n\n\tu32 reserved_auto9;\n\tu32 outer_esp_spi;\n\tu32 reserved_auto10[3];\n};\n\nstruct mlx5dr_match_misc2 {\n\tu32 outer_first_mpls_label:20;\t\t \n\tu32 outer_first_mpls_exp:3;\t\t \n\tu32 outer_first_mpls_s_bos:1;\t\t \n\tu32 outer_first_mpls_ttl:8;\t\t \n\n\tu32 inner_first_mpls_label:20;\t\t \n\tu32 inner_first_mpls_exp:3;\t\t \n\tu32 inner_first_mpls_s_bos:1;\t\t \n\tu32 inner_first_mpls_ttl:8;\t\t \n\n\tu32 outer_first_mpls_over_gre_label:20;\t \n\tu32 outer_first_mpls_over_gre_exp:3;\t \n\tu32 outer_first_mpls_over_gre_s_bos:1;\t \n\tu32 outer_first_mpls_over_gre_ttl:8;\t \n\n\tu32 outer_first_mpls_over_udp_label:20;\t \n\tu32 outer_first_mpls_over_udp_exp:3;\t \n\tu32 outer_first_mpls_over_udp_s_bos:1;\t \n\tu32 outer_first_mpls_over_udp_ttl:8;\t \n\n\tu32 metadata_reg_c_7;\t\t\t \n\tu32 metadata_reg_c_6;\t\t\t \n\tu32 metadata_reg_c_5;\t\t\t \n\tu32 metadata_reg_c_4;\t\t\t \n\tu32 metadata_reg_c_3;\t\t\t \n\tu32 metadata_reg_c_2;\t\t\t \n\tu32 metadata_reg_c_1;\t\t\t \n\tu32 metadata_reg_c_0;\t\t\t \n\tu32 metadata_reg_a;\t\t\t \n\tu32 reserved_auto1[3];\n};\n\nstruct mlx5dr_match_misc3 {\n\tu32 inner_tcp_seq_num;\n\tu32 outer_tcp_seq_num;\n\tu32 inner_tcp_ack_num;\n\tu32 outer_tcp_ack_num;\n\n\tu32 reserved_auto1:8;\n\tu32 outer_vxlan_gpe_vni:24;\n\n\tu32 outer_vxlan_gpe_next_protocol:8;\n\tu32 outer_vxlan_gpe_flags:8;\n\tu32 reserved_auto2:16;\n\n\tu32 icmpv4_header_data;\n\tu32 icmpv6_header_data;\n\n\tu8 icmpv4_type;\n\tu8 icmpv4_code;\n\tu8 icmpv6_type;\n\tu8 icmpv6_code;\n\n\tu32 geneve_tlv_option_0_data;\n\n\tu32 gtpu_teid;\n\n\tu8 gtpu_msg_type;\n\tu8 gtpu_msg_flags;\n\tu32 reserved_auto3:16;\n\n\tu32 gtpu_dw_2;\n\tu32 gtpu_first_ext_dw_0;\n\tu32 gtpu_dw_0;\n\tu32 reserved_auto4;\n};\n\nstruct mlx5dr_match_misc4 {\n\tu32 prog_sample_field_value_0;\n\tu32 prog_sample_field_id_0;\n\tu32 prog_sample_field_value_1;\n\tu32 prog_sample_field_id_1;\n\tu32 prog_sample_field_value_2;\n\tu32 prog_sample_field_id_2;\n\tu32 prog_sample_field_value_3;\n\tu32 prog_sample_field_id_3;\n\tu32 reserved_auto1[8];\n};\n\nstruct mlx5dr_match_misc5 {\n\tu32 macsec_tag_0;\n\tu32 macsec_tag_1;\n\tu32 macsec_tag_2;\n\tu32 macsec_tag_3;\n\tu32 tunnel_header_0;\n\tu32 tunnel_header_1;\n\tu32 tunnel_header_2;\n\tu32 tunnel_header_3;\n};\n\nstruct mlx5dr_match_param {\n\tstruct mlx5dr_match_spec outer;\n\tstruct mlx5dr_match_misc misc;\n\tstruct mlx5dr_match_spec inner;\n\tstruct mlx5dr_match_misc2 misc2;\n\tstruct mlx5dr_match_misc3 misc3;\n\tstruct mlx5dr_match_misc4 misc4;\n\tstruct mlx5dr_match_misc5 misc5;\n};\n\n#define DR_MASK_IS_ICMPV4_SET(_misc3) ((_misc3)->icmpv4_type || \\\n\t\t\t\t       (_misc3)->icmpv4_code || \\\n\t\t\t\t       (_misc3)->icmpv4_header_data)\n\n#define DR_MASK_IS_SRC_IP_SET(_spec) ((_spec)->src_ip_127_96 || \\\n\t\t\t\t      (_spec)->src_ip_95_64  || \\\n\t\t\t\t      (_spec)->src_ip_63_32  || \\\n\t\t\t\t      (_spec)->src_ip_31_0)\n\n#define DR_MASK_IS_DST_IP_SET(_spec) ((_spec)->dst_ip_127_96 || \\\n\t\t\t\t      (_spec)->dst_ip_95_64  || \\\n\t\t\t\t      (_spec)->dst_ip_63_32  || \\\n\t\t\t\t      (_spec)->dst_ip_31_0)\n\nstruct mlx5dr_esw_caps {\n\tu64 drop_icm_address_rx;\n\tu64 drop_icm_address_tx;\n\tu64 uplink_icm_address_rx;\n\tu64 uplink_icm_address_tx;\n\tu8 sw_owner:1;\n\tu8 sw_owner_v2:1;\n};\n\nstruct mlx5dr_cmd_vport_cap {\n\tu16 vport_gvmi;\n\tu16 vhca_gvmi;\n\tu16 num;\n\tu64 icm_address_rx;\n\tu64 icm_address_tx;\n};\n\nstruct mlx5dr_roce_cap {\n\tu8 roce_en:1;\n\tu8 fl_rc_qp_when_roce_disabled:1;\n\tu8 fl_rc_qp_when_roce_enabled:1;\n};\n\nstruct mlx5dr_vports {\n\tstruct mlx5dr_cmd_vport_cap esw_manager_caps;\n\tstruct mlx5dr_cmd_vport_cap uplink_caps;\n\tstruct xarray vports_caps_xa;\n};\n\nstruct mlx5dr_cmd_caps {\n\tu16 gvmi;\n\tu64 nic_rx_drop_address;\n\tu64 nic_tx_drop_address;\n\tu64 nic_tx_allow_address;\n\tu64 esw_rx_drop_address;\n\tu64 esw_tx_drop_address;\n\tu32 log_icm_size;\n\tu64 hdr_modify_icm_addr;\n\tu32 log_modify_pattern_icm_size;\n\tu64 hdr_modify_pattern_icm_addr;\n\tu32 flex_protocols;\n\tu8 flex_parser_id_icmp_dw0;\n\tu8 flex_parser_id_icmp_dw1;\n\tu8 flex_parser_id_icmpv6_dw0;\n\tu8 flex_parser_id_icmpv6_dw1;\n\tu8 flex_parser_id_geneve_tlv_option_0;\n\tu8 flex_parser_id_mpls_over_gre;\n\tu8 flex_parser_id_mpls_over_udp;\n\tu8 flex_parser_id_gtpu_dw_0;\n\tu8 flex_parser_id_gtpu_teid;\n\tu8 flex_parser_id_gtpu_dw_2;\n\tu8 flex_parser_id_gtpu_first_ext_dw_0;\n\tu8 flex_parser_ok_bits_supp;\n\tu8 max_ft_level;\n\tu16 roce_min_src_udp;\n\tu8 sw_format_ver;\n\tbool eswitch_manager;\n\tbool rx_sw_owner;\n\tbool tx_sw_owner;\n\tbool fdb_sw_owner;\n\tu8 rx_sw_owner_v2:1;\n\tu8 tx_sw_owner_v2:1;\n\tu8 fdb_sw_owner_v2:1;\n\tstruct mlx5dr_esw_caps esw_caps;\n\tstruct mlx5dr_vports vports;\n\tbool prio_tag_required;\n\tstruct mlx5dr_roce_cap roce_caps;\n\tu16 log_header_modify_argument_granularity;\n\tu16 log_header_modify_argument_max_alloc;\n\tbool support_modify_argument;\n\tu8 is_ecpf:1;\n\tu8 isolate_vl_tc:1;\n};\n\nenum mlx5dr_domain_nic_type {\n\tDR_DOMAIN_NIC_TYPE_RX,\n\tDR_DOMAIN_NIC_TYPE_TX,\n};\n\nstruct mlx5dr_domain_rx_tx {\n\tu64 drop_icm_addr;\n\tu64 default_icm_addr;\n\tenum mlx5dr_domain_nic_type type;\n\tstruct mutex mutex;  \n};\n\nstruct mlx5dr_domain_info {\n\tbool supp_sw_steering;\n\tu32 max_inline_size;\n\tu32 max_send_wr;\n\tu32 max_log_sw_icm_sz;\n\tu32 max_log_action_icm_sz;\n\tu32 max_log_modify_hdr_pattern_icm_sz;\n\tstruct mlx5dr_domain_rx_tx rx;\n\tstruct mlx5dr_domain_rx_tx tx;\n\tstruct mlx5dr_cmd_caps caps;\n};\n\nstruct mlx5dr_domain {\n\tstruct mlx5_core_dev *mdev;\n\tu32 pdn;\n\tstruct mlx5_uars_page *uar;\n\tenum mlx5dr_domain_type type;\n\trefcount_t refcount;\n\tstruct mlx5dr_icm_pool *ste_icm_pool;\n\tstruct mlx5dr_icm_pool *action_icm_pool;\n\tstruct mlx5dr_send_info_pool *send_info_pool_rx;\n\tstruct mlx5dr_send_info_pool *send_info_pool_tx;\n\tstruct kmem_cache *chunks_kmem_cache;\n\tstruct kmem_cache *htbls_kmem_cache;\n\tstruct mlx5dr_ptrn_mgr *ptrn_mgr;\n\tstruct mlx5dr_arg_mgr *arg_mgr;\n\tstruct mlx5dr_send_ring *send_ring;\n\tstruct mlx5dr_domain_info info;\n\tstruct xarray csum_fts_xa;\n\tstruct mlx5dr_ste_ctx *ste_ctx;\n\tstruct list_head dbg_tbl_list;\n\tstruct mlx5dr_dbg_dump_info dump_info;\n\tstruct xarray definers_xa;\n\tstruct xarray peer_dmn_xa;\n\t \n\tu32 num_buddies[DR_ICM_TYPE_MAX];\n};\n\nstruct mlx5dr_table_rx_tx {\n\tstruct mlx5dr_ste_htbl *s_anchor;\n\tstruct mlx5dr_domain_rx_tx *nic_dmn;\n\tu64 default_icm_addr;\n\tstruct list_head nic_matcher_list;\n};\n\nstruct mlx5dr_table {\n\tstruct mlx5dr_domain *dmn;\n\tstruct mlx5dr_table_rx_tx rx;\n\tstruct mlx5dr_table_rx_tx tx;\n\tu32 level;\n\tu32 table_type;\n\tu32 table_id;\n\tu32 flags;\n\tstruct list_head matcher_list;\n\tstruct mlx5dr_action *miss_action;\n\trefcount_t refcount;\n\tstruct list_head dbg_node;\n};\n\nstruct mlx5dr_matcher_rx_tx {\n\tstruct mlx5dr_ste_htbl *s_htbl;\n\tstruct mlx5dr_ste_htbl *e_anchor;\n\tstruct mlx5dr_ste_build *ste_builder;\n\tstruct mlx5dr_ste_build ste_builder_arr[DR_RULE_IPV_MAX]\n\t\t\t\t\t       [DR_RULE_IPV_MAX]\n\t\t\t\t\t       [DR_RULE_MAX_STES];\n\tu8 num_of_builders;\n\tu8 num_of_builders_arr[DR_RULE_IPV_MAX][DR_RULE_IPV_MAX];\n\tu64 default_icm_addr;\n\tstruct mlx5dr_table_rx_tx *nic_tbl;\n\tu32 prio;\n\tstruct list_head list_node;\n\tu32 rules;\n};\n\nstruct mlx5dr_matcher {\n\tstruct mlx5dr_table *tbl;\n\tstruct mlx5dr_matcher_rx_tx rx;\n\tstruct mlx5dr_matcher_rx_tx tx;\n\tstruct list_head list_node;  \n\tu32 prio;\n\tstruct mlx5dr_match_param mask;\n\tu8 match_criteria;\n\trefcount_t refcount;\n\tstruct list_head dbg_rule_list;\n};\n\nstruct mlx5dr_ste_action_modify_field {\n\tu16 hw_field;\n\tu8 start;\n\tu8 end;\n\tu8 l3_type;\n\tu8 l4_type;\n};\n\nstruct mlx5dr_ptrn_obj {\n\tstruct mlx5dr_icm_chunk *chunk;\n\tu8 *data;\n\tu16 num_of_actions;\n\tu32 index;\n\trefcount_t refcount;\n\tstruct list_head list;\n};\n\nstruct mlx5dr_arg_obj {\n\tu32 obj_id;\n\tu32 obj_offset;\n\tstruct list_head list_node;\n\tu32 log_chunk_size;\n};\n\nstruct mlx5dr_action_rewrite {\n\tstruct mlx5dr_domain *dmn;\n\tstruct mlx5dr_icm_chunk *chunk;\n\tu8 *data;\n\tu16 num_of_actions;\n\tu32 index;\n\tu8 single_action_opt:1;\n\tu8 allow_rx:1;\n\tu8 allow_tx:1;\n\tu8 modify_ttl:1;\n\tstruct mlx5dr_ptrn_obj *ptrn;\n\tstruct mlx5dr_arg_obj *arg;\n};\n\nstruct mlx5dr_action_reformat {\n\tstruct mlx5dr_domain *dmn;\n\tu32 id;\n\tu32 size;\n\tu8 param_0;\n\tu8 param_1;\n};\n\nstruct mlx5dr_action_sampler {\n\tstruct mlx5dr_domain *dmn;\n\tu64 rx_icm_addr;\n\tu64 tx_icm_addr;\n\tu32 sampler_id;\n};\n\nstruct mlx5dr_action_dest_tbl {\n\tu8 is_fw_tbl:1;\n\tunion {\n\t\tstruct mlx5dr_table *tbl;\n\t\tstruct {\n\t\t\tstruct mlx5dr_domain *dmn;\n\t\t\tu32 id;\n\t\t\tu32 group_id;\n\t\t\tenum fs_flow_table_type type;\n\t\t\tu64 rx_icm_addr;\n\t\t\tu64 tx_icm_addr;\n\t\t\tstruct mlx5dr_action **ref_actions;\n\t\t\tu32 num_of_ref_actions;\n\t\t} fw_tbl;\n\t};\n};\n\nstruct mlx5dr_action_range {\n\tstruct mlx5dr_domain *dmn;\n\tstruct mlx5dr_action *hit_tbl_action;\n\tstruct mlx5dr_action *miss_tbl_action;\n\tu32 definer_id;\n\tu32 min;\n\tu32 max;\n};\n\nstruct mlx5dr_action_ctr {\n\tu32 ctr_id;\n\tu32 offset;\n};\n\nstruct mlx5dr_action_vport {\n\tstruct mlx5dr_domain *dmn;\n\tstruct mlx5dr_cmd_vport_cap *caps;\n};\n\nstruct mlx5dr_action_push_vlan {\n\tu32 vlan_hdr;  \n};\n\nstruct mlx5dr_action_flow_tag {\n\tu32 flow_tag;\n};\n\nstruct mlx5dr_rule_action_member {\n\tstruct mlx5dr_action *action;\n\tstruct list_head list;\n};\n\nstruct mlx5dr_action_aso_flow_meter {\n\tstruct mlx5dr_domain *dmn;\n\tu32 obj_id;\n\tu32 offset;\n\tu8 dest_reg_id;\n\tu8 init_color;\n};\n\nstruct mlx5dr_action {\n\tenum mlx5dr_action_type action_type;\n\trefcount_t refcount;\n\n\tunion {\n\t\tvoid *data;\n\t\tstruct mlx5dr_action_rewrite *rewrite;\n\t\tstruct mlx5dr_action_reformat *reformat;\n\t\tstruct mlx5dr_action_sampler *sampler;\n\t\tstruct mlx5dr_action_dest_tbl *dest_tbl;\n\t\tstruct mlx5dr_action_ctr *ctr;\n\t\tstruct mlx5dr_action_vport *vport;\n\t\tstruct mlx5dr_action_push_vlan *push_vlan;\n\t\tstruct mlx5dr_action_flow_tag *flow_tag;\n\t\tstruct mlx5dr_action_aso_flow_meter *aso;\n\t\tstruct mlx5dr_action_range *range;\n\t};\n};\n\nenum mlx5dr_connect_type {\n\tCONNECT_HIT\t= 1,\n\tCONNECT_MISS\t= 2,\n};\n\nstruct mlx5dr_htbl_connect_info {\n\tenum mlx5dr_connect_type type;\n\tunion {\n\t\tstruct mlx5dr_ste_htbl *hit_next_htbl;\n\t\tu64 miss_icm_addr;\n\t};\n};\n\nstruct mlx5dr_rule_rx_tx {\n\tstruct mlx5dr_matcher_rx_tx *nic_matcher;\n\tstruct mlx5dr_ste *last_rule_ste;\n};\n\nstruct mlx5dr_rule {\n\tstruct mlx5dr_matcher *matcher;\n\tstruct mlx5dr_rule_rx_tx rx;\n\tstruct mlx5dr_rule_rx_tx tx;\n\tstruct list_head rule_actions_list;\n\tstruct list_head dbg_node;\n\tu32 flow_source;\n};\n\nvoid mlx5dr_rule_set_last_member(struct mlx5dr_rule_rx_tx *nic_rule,\n\t\t\t\t struct mlx5dr_ste *ste,\n\t\t\t\t bool force);\nint mlx5dr_rule_get_reverse_rule_members(struct mlx5dr_ste **ste_arr,\n\t\t\t\t\t struct mlx5dr_ste *curr_ste,\n\t\t\t\t\t int *num_of_stes);\n\nstruct mlx5dr_icm_chunk {\n\tstruct mlx5dr_icm_buddy_mem *buddy_mem;\n\n\t \n\tunsigned int seg;\n\tenum mlx5dr_icm_chunk_size size;\n\n\t \n\tstruct mlx5dr_ste *ste_arr;\n\tu8 *hw_ste_arr;\n\tstruct list_head *miss_list;\n};\n\nstatic inline void mlx5dr_domain_nic_lock(struct mlx5dr_domain_rx_tx *nic_dmn)\n{\n\tmutex_lock(&nic_dmn->mutex);\n}\n\nstatic inline void mlx5dr_domain_nic_unlock(struct mlx5dr_domain_rx_tx *nic_dmn)\n{\n\tmutex_unlock(&nic_dmn->mutex);\n}\n\nstatic inline void mlx5dr_domain_lock(struct mlx5dr_domain *dmn)\n{\n\tmlx5dr_domain_nic_lock(&dmn->info.rx);\n\tmlx5dr_domain_nic_lock(&dmn->info.tx);\n}\n\nstatic inline void mlx5dr_domain_unlock(struct mlx5dr_domain *dmn)\n{\n\tmlx5dr_domain_nic_unlock(&dmn->info.tx);\n\tmlx5dr_domain_nic_unlock(&dmn->info.rx);\n}\n\nint mlx5dr_matcher_add_to_tbl_nic(struct mlx5dr_domain *dmn,\n\t\t\t\t  struct mlx5dr_matcher_rx_tx *nic_matcher);\nint mlx5dr_matcher_remove_from_tbl_nic(struct mlx5dr_domain *dmn,\n\t\t\t\t       struct mlx5dr_matcher_rx_tx *nic_matcher);\n\nint mlx5dr_matcher_select_builders(struct mlx5dr_matcher *matcher,\n\t\t\t\t   struct mlx5dr_matcher_rx_tx *nic_matcher,\n\t\t\t\t   enum mlx5dr_ipv outer_ipv,\n\t\t\t\t   enum mlx5dr_ipv inner_ipv);\n\nu64 mlx5dr_icm_pool_get_chunk_mr_addr(struct mlx5dr_icm_chunk *chunk);\nu32 mlx5dr_icm_pool_get_chunk_rkey(struct mlx5dr_icm_chunk *chunk);\nu64 mlx5dr_icm_pool_get_chunk_icm_addr(struct mlx5dr_icm_chunk *chunk);\nu32 mlx5dr_icm_pool_get_chunk_num_of_entries(struct mlx5dr_icm_chunk *chunk);\nu32 mlx5dr_icm_pool_get_chunk_byte_size(struct mlx5dr_icm_chunk *chunk);\nu8 *mlx5dr_ste_get_hw_ste(struct mlx5dr_ste *ste);\n\nstruct mlx5dr_ste_htbl *mlx5dr_icm_pool_alloc_htbl(struct mlx5dr_icm_pool *pool);\nvoid mlx5dr_icm_pool_free_htbl(struct mlx5dr_icm_pool *pool, struct mlx5dr_ste_htbl *htbl);\n\nstatic inline int\nmlx5dr_icm_pool_dm_type_to_entry_size(enum mlx5dr_icm_type icm_type)\n{\n\tif (icm_type == DR_ICM_TYPE_STE)\n\t\treturn DR_STE_SIZE;\n\n\treturn DR_MODIFY_ACTION_SIZE;\n}\n\nstatic inline u32\nmlx5dr_icm_pool_chunk_size_to_entries(enum mlx5dr_icm_chunk_size chunk_size)\n{\n\treturn 1 << chunk_size;\n}\n\nstatic inline int\nmlx5dr_icm_pool_chunk_size_to_byte(enum mlx5dr_icm_chunk_size chunk_size,\n\t\t\t\t   enum mlx5dr_icm_type icm_type)\n{\n\tint num_of_entries;\n\tint entry_size;\n\n\tentry_size = mlx5dr_icm_pool_dm_type_to_entry_size(icm_type);\n\tnum_of_entries = mlx5dr_icm_pool_chunk_size_to_entries(chunk_size);\n\n\treturn entry_size * num_of_entries;\n}\n\nstatic inline int\nmlx5dr_ste_htbl_increase_threshold(struct mlx5dr_ste_htbl *htbl)\n{\n\tint num_of_entries =\n\t\tmlx5dr_icm_pool_chunk_size_to_entries(htbl->chunk->size);\n\n\t \n\treturn (num_of_entries + 1) / 2;\n}\n\nstatic inline bool\nmlx5dr_ste_htbl_may_grow(struct mlx5dr_ste_htbl *htbl)\n{\n\tif (htbl->chunk->size == DR_CHUNK_SIZE_MAX - 1 || !htbl->byte_mask)\n\t\treturn false;\n\n\treturn true;\n}\n\nstruct mlx5dr_cmd_vport_cap *\nmlx5dr_domain_get_vport_cap(struct mlx5dr_domain *dmn, u16 vport);\n\nstruct mlx5dr_cmd_query_flow_table_details {\n\tu8 status;\n\tu8 level;\n\tu64 sw_owner_icm_root_1;\n\tu64 sw_owner_icm_root_0;\n};\n\nstruct mlx5dr_cmd_create_flow_table_attr {\n\tu32 table_type;\n\tu16 uid;\n\tu64 icm_addr_rx;\n\tu64 icm_addr_tx;\n\tu8 level;\n\tbool sw_owner;\n\tbool term_tbl;\n\tbool decap_en;\n\tbool reformat_en;\n};\n\n \nint mlx5dr_cmd_query_device(struct mlx5_core_dev *mdev,\n\t\t\t    struct mlx5dr_cmd_caps *caps);\nint mlx5dr_cmd_query_esw_vport_context(struct mlx5_core_dev *mdev,\n\t\t\t\t       bool other_vport, u16 vport_number,\n\t\t\t\t       u64 *icm_address_rx,\n\t\t\t\t       u64 *icm_address_tx);\nint mlx5dr_cmd_query_gvmi(struct mlx5_core_dev *mdev,\n\t\t\t  bool other_vport, u16 vport_number, u16 *gvmi);\nint mlx5dr_cmd_query_esw_caps(struct mlx5_core_dev *mdev,\n\t\t\t      struct mlx5dr_esw_caps *caps);\nint mlx5dr_cmd_query_flow_sampler(struct mlx5_core_dev *dev,\n\t\t\t\t  u32 sampler_id,\n\t\t\t\t  u64 *rx_icm_addr,\n\t\t\t\t  u64 *tx_icm_addr);\nint mlx5dr_cmd_sync_steering(struct mlx5_core_dev *mdev);\nint mlx5dr_cmd_set_fte_modify_and_vport(struct mlx5_core_dev *mdev,\n\t\t\t\t\tu32 table_type,\n\t\t\t\t\tu32 table_id,\n\t\t\t\t\tu32 group_id,\n\t\t\t\t\tu32 modify_header_id,\n\t\t\t\t\tu16 vport_id);\nint mlx5dr_cmd_del_flow_table_entry(struct mlx5_core_dev *mdev,\n\t\t\t\t    u32 table_type,\n\t\t\t\t    u32 table_id);\nint mlx5dr_cmd_alloc_modify_header(struct mlx5_core_dev *mdev,\n\t\t\t\t   u32 table_type,\n\t\t\t\t   u8 num_of_actions,\n\t\t\t\t   u64 *actions,\n\t\t\t\t   u32 *modify_header_id);\nint mlx5dr_cmd_dealloc_modify_header(struct mlx5_core_dev *mdev,\n\t\t\t\t     u32 modify_header_id);\nint mlx5dr_cmd_create_empty_flow_group(struct mlx5_core_dev *mdev,\n\t\t\t\t       u32 table_type,\n\t\t\t\t       u32 table_id,\n\t\t\t\t       u32 *group_id);\nint mlx5dr_cmd_destroy_flow_group(struct mlx5_core_dev *mdev,\n\t\t\t\t  u32 table_type,\n\t\t\t\t  u32 table_id,\n\t\t\t\t  u32 group_id);\nint mlx5dr_cmd_create_flow_table(struct mlx5_core_dev *mdev,\n\t\t\t\t struct mlx5dr_cmd_create_flow_table_attr *attr,\n\t\t\t\t u64 *fdb_rx_icm_addr,\n\t\t\t\t u32 *table_id);\nint mlx5dr_cmd_destroy_flow_table(struct mlx5_core_dev *mdev,\n\t\t\t\t  u32 table_id,\n\t\t\t\t  u32 table_type);\nint mlx5dr_cmd_query_flow_table(struct mlx5_core_dev *dev,\n\t\t\t\tenum fs_flow_table_type type,\n\t\t\t\tu32 table_id,\n\t\t\t\tstruct mlx5dr_cmd_query_flow_table_details *output);\nint mlx5dr_cmd_create_reformat_ctx(struct mlx5_core_dev *mdev,\n\t\t\t\t   enum mlx5_reformat_ctx_type rt,\n\t\t\t\t   u8 reformat_param_0,\n\t\t\t\t   u8 reformat_param_1,\n\t\t\t\t   size_t reformat_size,\n\t\t\t\t   void *reformat_data,\n\t\t\t\t   u32 *reformat_id);\nvoid mlx5dr_cmd_destroy_reformat_ctx(struct mlx5_core_dev *mdev,\n\t\t\t\t     u32 reformat_id);\nint mlx5dr_cmd_create_definer(struct mlx5_core_dev *mdev,\n\t\t\t      u16 format_id,\n\t\t\t      u8 *dw_selectors,\n\t\t\t      u8 *byte_selectors,\n\t\t\t      u8 *match_mask,\n\t\t\t      u32 *definer_id);\nvoid mlx5dr_cmd_destroy_definer(struct mlx5_core_dev *mdev,\n\t\t\t\tu32 definer_id);\n\nstruct mlx5dr_cmd_gid_attr {\n\tu8 gid[16];\n\tu8 mac[6];\n\tu32 roce_ver;\n};\n\nint mlx5dr_cmd_query_gid(struct mlx5_core_dev *mdev, u8 vhca_port_num,\n\t\t\t u16 index, struct mlx5dr_cmd_gid_attr *attr);\n\nint mlx5dr_cmd_create_modify_header_arg(struct mlx5_core_dev *dev,\n\t\t\t\t\tu16 log_obj_range, u32 pd,\n\t\t\t\t\tu32 *obj_id);\nvoid mlx5dr_cmd_destroy_modify_header_arg(struct mlx5_core_dev *dev,\n\t\t\t\t\t  u32 obj_id);\n\nstruct mlx5dr_icm_pool *mlx5dr_icm_pool_create(struct mlx5dr_domain *dmn,\n\t\t\t\t\t       enum mlx5dr_icm_type icm_type);\nvoid mlx5dr_icm_pool_destroy(struct mlx5dr_icm_pool *pool);\n\nstruct mlx5dr_icm_chunk *\nmlx5dr_icm_alloc_chunk(struct mlx5dr_icm_pool *pool,\n\t\t       enum mlx5dr_icm_chunk_size chunk_size);\nvoid mlx5dr_icm_free_chunk(struct mlx5dr_icm_chunk *chunk);\n\nvoid mlx5dr_ste_prepare_for_postsend(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t     u8 *hw_ste_p, u32 ste_size);\nint mlx5dr_ste_htbl_init_and_postsend(struct mlx5dr_domain *dmn,\n\t\t\t\t      struct mlx5dr_domain_rx_tx *nic_dmn,\n\t\t\t\t      struct mlx5dr_ste_htbl *htbl,\n\t\t\t\t      struct mlx5dr_htbl_connect_info *connect_info,\n\t\t\t\t      bool update_hw_ste);\nvoid mlx5dr_ste_set_formatted_ste(struct mlx5dr_ste_ctx *ste_ctx,\n\t\t\t\t  u16 gvmi,\n\t\t\t\t  enum mlx5dr_domain_nic_type nic_type,\n\t\t\t\t  struct mlx5dr_ste_htbl *htbl,\n\t\t\t\t  u8 *formatted_ste,\n\t\t\t\t  struct mlx5dr_htbl_connect_info *connect_info);\nvoid mlx5dr_ste_copy_param(u8 match_criteria,\n\t\t\t   struct mlx5dr_match_param *set_param,\n\t\t\t   struct mlx5dr_match_parameters *mask,\n\t\t\t   bool clear);\n\nstruct mlx5dr_qp {\n\tstruct mlx5_core_dev *mdev;\n\tstruct mlx5_wq_qp wq;\n\tstruct mlx5_uars_page *uar;\n\tstruct mlx5_wq_ctrl wq_ctrl;\n\tu32 qpn;\n\tstruct {\n\t\tunsigned int head;\n\t\tunsigned int pc;\n\t\tunsigned int cc;\n\t\tunsigned int size;\n\t\tunsigned int *wqe_head;\n\t\tunsigned int wqe_cnt;\n\t} sq;\n\tstruct {\n\t\tunsigned int pc;\n\t\tunsigned int cc;\n\t\tunsigned int size;\n\t\tunsigned int wqe_cnt;\n\t} rq;\n\tint max_inline_data;\n};\n\nstruct mlx5dr_cq {\n\tstruct mlx5_core_dev *mdev;\n\tstruct mlx5_cqwq wq;\n\tstruct mlx5_wq_ctrl wq_ctrl;\n\tstruct mlx5_core_cq mcq;\n\tstruct mlx5dr_qp *qp;\n};\n\nstruct mlx5dr_mr {\n\tstruct mlx5_core_dev *mdev;\n\tu32 mkey;\n\tdma_addr_t dma_addr;\n\tvoid *addr;\n\tsize_t size;\n};\n\nstruct mlx5dr_send_ring {\n\tstruct mlx5dr_cq *cq;\n\tstruct mlx5dr_qp *qp;\n\tstruct mlx5dr_mr *mr;\n\t \n\tu32 pending_wqe;\n\t \n\tu16 signal_th;\n\t \n\tu32 max_post_send_size;\n\t \n\tu32 tx_head;\n\tvoid *buf;\n\tu32 buf_size;\n\tu8 *sync_buff;\n\tstruct mlx5dr_mr *sync_mr;\n\tspinlock_t lock;  \n\tbool err_state;  \n};\n\nint mlx5dr_send_ring_alloc(struct mlx5dr_domain *dmn);\nvoid mlx5dr_send_ring_free(struct mlx5dr_domain *dmn,\n\t\t\t   struct mlx5dr_send_ring *send_ring);\nint mlx5dr_send_ring_force_drain(struct mlx5dr_domain *dmn);\nint mlx5dr_send_postsend_ste(struct mlx5dr_domain *dmn,\n\t\t\t     struct mlx5dr_ste *ste,\n\t\t\t     u8 *data,\n\t\t\t     u16 size,\n\t\t\t     u16 offset);\nint mlx5dr_send_postsend_htbl(struct mlx5dr_domain *dmn,\n\t\t\t      struct mlx5dr_ste_htbl *htbl,\n\t\t\t      u8 *formatted_ste, u8 *mask);\nint mlx5dr_send_postsend_formatted_htbl(struct mlx5dr_domain *dmn,\n\t\t\t\t\tstruct mlx5dr_ste_htbl *htbl,\n\t\t\t\t\tu8 *ste_init_data,\n\t\t\t\t\tbool update_hw_ste);\nint mlx5dr_send_postsend_action(struct mlx5dr_domain *dmn,\n\t\t\t\tstruct mlx5dr_action *action);\nint mlx5dr_send_postsend_pattern(struct mlx5dr_domain *dmn,\n\t\t\t\t struct mlx5dr_icm_chunk *chunk,\n\t\t\t\t u16 num_of_actions,\n\t\t\t\t u8 *data);\nint mlx5dr_send_postsend_args(struct mlx5dr_domain *dmn, u64 arg_id,\n\t\t\t      u16 num_of_actions, u8 *actions_data);\n\nint mlx5dr_send_info_pool_create(struct mlx5dr_domain *dmn);\nvoid mlx5dr_send_info_pool_destroy(struct mlx5dr_domain *dmn);\nstruct mlx5dr_ste_send_info *mlx5dr_send_info_alloc(struct mlx5dr_domain *dmn,\n\t\t\t\t\t\t    enum mlx5dr_domain_nic_type nic_type);\nvoid mlx5dr_send_info_free(struct mlx5dr_ste_send_info *ste_send_info);\n\nstruct mlx5dr_cmd_ft_info {\n\tu32 id;\n\tu16 vport;\n\tenum fs_flow_table_type type;\n};\n\nstruct mlx5dr_cmd_flow_destination_hw_info {\n\tenum mlx5_flow_destination_type type;\n\tunion {\n\t\tu32 tir_num;\n\t\tu32 ft_num;\n\t\tu32 ft_id;\n\t\tu32 counter_id;\n\t\tu32 sampler_id;\n\t\tstruct {\n\t\t\tu16 num;\n\t\t\tu16 vhca_id;\n\t\t\tu32 reformat_id;\n\t\t\tu8 flags;\n\t\t} vport;\n\t};\n};\n\nstruct mlx5dr_cmd_fte_info {\n\tu32 dests_size;\n\tu32 index;\n\tstruct mlx5_flow_context flow_context;\n\tu32 *val;\n\tstruct mlx5_flow_act action;\n\tstruct mlx5dr_cmd_flow_destination_hw_info *dest_arr;\n\tbool ignore_flow_level;\n};\n\nint mlx5dr_cmd_set_fte(struct mlx5_core_dev *dev,\n\t\t       int opmod, int modify_mask,\n\t\t       struct mlx5dr_cmd_ft_info *ft,\n\t\t       u32 group_id,\n\t\t       struct mlx5dr_cmd_fte_info *fte);\n\nbool mlx5dr_ste_supp_ttl_cs_recalc(struct mlx5dr_cmd_caps *caps);\n\nstruct mlx5dr_fw_recalc_cs_ft {\n\tu64 rx_icm_addr;\n\tu32 table_id;\n\tu32 group_id;\n\tu32 modify_hdr_id;\n};\n\nstruct mlx5dr_fw_recalc_cs_ft *\nmlx5dr_fw_create_recalc_cs_ft(struct mlx5dr_domain *dmn, u16 vport_num);\nvoid mlx5dr_fw_destroy_recalc_cs_ft(struct mlx5dr_domain *dmn,\n\t\t\t\t    struct mlx5dr_fw_recalc_cs_ft *recalc_cs_ft);\nint mlx5dr_domain_get_recalc_cs_ft_addr(struct mlx5dr_domain *dmn,\n\t\t\t\t\tu16 vport_num,\n\t\t\t\t\tu64 *rx_icm_addr);\nint mlx5dr_fw_create_md_tbl(struct mlx5dr_domain *dmn,\n\t\t\t    struct mlx5dr_cmd_flow_destination_hw_info *dest,\n\t\t\t    int num_dest,\n\t\t\t    bool reformat_req,\n\t\t\t    u32 *tbl_id,\n\t\t\t    u32 *group_id,\n\t\t\t    bool ignore_flow_level,\n\t\t\t    u32 flow_source);\nvoid mlx5dr_fw_destroy_md_tbl(struct mlx5dr_domain *dmn, u32 tbl_id,\n\t\t\t      u32 group_id);\n\nstatic inline bool mlx5dr_is_fw_table(struct mlx5_flow_table *ft)\n{\n\treturn !ft->fs_dr_table.dr_table;\n}\n\nstatic inline bool mlx5dr_supp_match_ranges(struct mlx5_core_dev *dev)\n{\n\treturn (MLX5_CAP_GEN(dev, steering_format_version) >=\n\t\tMLX5_STEERING_FORMAT_CONNECTX_6DX) &&\n\t       (MLX5_CAP_GEN_64(dev, match_definer_format_supported) &\n\t\t\t(1ULL << MLX5_IFC_DEFINER_FORMAT_ID_SELECT));\n}\n\nbool mlx5dr_domain_is_support_ptrn_arg(struct mlx5dr_domain *dmn);\nstruct mlx5dr_ptrn_mgr *mlx5dr_ptrn_mgr_create(struct mlx5dr_domain *dmn);\nvoid mlx5dr_ptrn_mgr_destroy(struct mlx5dr_ptrn_mgr *mgr);\nstruct mlx5dr_ptrn_obj *mlx5dr_ptrn_cache_get_pattern(struct mlx5dr_ptrn_mgr *mgr,\n\t\t\t\t\t\t      u16 num_of_actions, u8 *data);\nvoid mlx5dr_ptrn_cache_put_pattern(struct mlx5dr_ptrn_mgr *mgr,\n\t\t\t\t   struct mlx5dr_ptrn_obj *pattern);\nstruct mlx5dr_arg_mgr *mlx5dr_arg_mgr_create(struct mlx5dr_domain *dmn);\nvoid mlx5dr_arg_mgr_destroy(struct mlx5dr_arg_mgr *mgr);\nstruct mlx5dr_arg_obj *mlx5dr_arg_get_obj(struct mlx5dr_arg_mgr *mgr,\n\t\t\t\t\t  u16 num_of_actions,\n\t\t\t\t\t  u8 *data);\nvoid mlx5dr_arg_put_obj(struct mlx5dr_arg_mgr *mgr,\n\t\t\tstruct mlx5dr_arg_obj *arg_obj);\nu32 mlx5dr_arg_get_obj_id(struct mlx5dr_arg_obj *arg_obj);\n\n#endif   \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}