{
  "module_name": "port_sel.c",
  "hash_id": "321d7a22123b50bd15953608492a71f727ef31650614eec7bae079c835985ada",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/lag/port_sel.c",
  "human_readable_source": "\n \n\n#include <linux/netdevice.h>\n#include \"lag.h\"\n\nenum {\n\tMLX5_LAG_FT_LEVEL_TTC,\n\tMLX5_LAG_FT_LEVEL_INNER_TTC,\n\tMLX5_LAG_FT_LEVEL_DEFINER,\n};\n\nstatic struct mlx5_flow_group *\nmlx5_create_hash_flow_group(struct mlx5_flow_table *ft,\n\t\t\t    struct mlx5_flow_definer *definer,\n\t\t\t    u8 rules)\n{\n\tint inlen = MLX5_ST_SZ_BYTES(create_flow_group_in);\n\tstruct mlx5_flow_group *fg;\n\tu32 *in;\n\n\tin = kvzalloc(inlen, GFP_KERNEL);\n\tif (!in)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tMLX5_SET(create_flow_group_in, in, match_definer_id,\n\t\t mlx5_get_match_definer_id(definer));\n\tMLX5_SET(create_flow_group_in, in, start_flow_index, 0);\n\tMLX5_SET(create_flow_group_in, in, end_flow_index, rules - 1);\n\tMLX5_SET(create_flow_group_in, in, group_type,\n\t\t MLX5_CREATE_FLOW_GROUP_IN_GROUP_TYPE_HASH_SPLIT);\n\n\tfg = mlx5_create_flow_group(ft, in);\n\tkvfree(in);\n\treturn fg;\n}\n\nstatic int mlx5_lag_create_port_sel_table(struct mlx5_lag *ldev,\n\t\t\t\t\t  struct mlx5_lag_definer *lag_definer,\n\t\t\t\t\t  u8 *ports)\n{\n\tstruct mlx5_core_dev *dev = ldev->pf[MLX5_LAG_P1].dev;\n\tstruct mlx5_flow_table_attr ft_attr = {};\n\tstruct mlx5_flow_destination dest = {};\n\tMLX5_DECLARE_FLOW_ACT(flow_act);\n\tstruct mlx5_flow_namespace *ns;\n\tint err, i;\n\tint idx;\n\tint j;\n\n\tft_attr.max_fte = ldev->ports * ldev->buckets;\n\tft_attr.level = MLX5_LAG_FT_LEVEL_DEFINER;\n\n\tns = mlx5_get_flow_namespace(dev, MLX5_FLOW_NAMESPACE_PORT_SEL);\n\tif (!ns) {\n\t\tmlx5_core_warn(dev, \"Failed to get port selection namespace\\n\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tlag_definer->ft = mlx5_create_flow_table(ns, &ft_attr);\n\tif (IS_ERR(lag_definer->ft)) {\n\t\tmlx5_core_warn(dev, \"Failed to create port selection table\\n\");\n\t\treturn PTR_ERR(lag_definer->ft);\n\t}\n\n\tlag_definer->fg = mlx5_create_hash_flow_group(lag_definer->ft,\n\t\t\t\t\t\t      lag_definer->definer,\n\t\t\t\t\t\t      ft_attr.max_fte);\n\tif (IS_ERR(lag_definer->fg)) {\n\t\terr = PTR_ERR(lag_definer->fg);\n\t\tgoto destroy_ft;\n\t}\n\n\tdest.type = MLX5_FLOW_DESTINATION_TYPE_UPLINK;\n\tdest.vport.flags |= MLX5_FLOW_DEST_VPORT_VHCA_ID;\n\tflow_act.flags |= FLOW_ACT_NO_APPEND;\n\tfor (i = 0; i < ldev->ports; i++) {\n\t\tfor (j = 0; j < ldev->buckets; j++) {\n\t\t\tu8 affinity;\n\n\t\t\tidx = i * ldev->buckets + j;\n\t\t\taffinity = ports[idx];\n\n\t\t\tdest.vport.vhca_id = MLX5_CAP_GEN(ldev->pf[affinity - 1].dev,\n\t\t\t\t\t\t\t  vhca_id);\n\t\t\tlag_definer->rules[idx] = mlx5_add_flow_rules(lag_definer->ft,\n\t\t\t\t\t\t\t\t      NULL, &flow_act,\n\t\t\t\t\t\t\t\t      &dest, 1);\n\t\t\tif (IS_ERR(lag_definer->rules[idx])) {\n\t\t\t\terr = PTR_ERR(lag_definer->rules[idx]);\n\t\t\t\twhile (i--)\n\t\t\t\t\twhile (j--)\n\t\t\t\t\t\tmlx5_del_flow_rules(lag_definer->rules[idx]);\n\t\t\t\tgoto destroy_fg;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 0;\n\ndestroy_fg:\n\tmlx5_destroy_flow_group(lag_definer->fg);\ndestroy_ft:\n\tmlx5_destroy_flow_table(lag_definer->ft);\n\treturn err;\n}\n\nstatic int mlx5_lag_set_definer_inner(u32 *match_definer_mask,\n\t\t\t\t      enum mlx5_traffic_types tt)\n{\n\tint format_id;\n\tu8 *ipv6;\n\n\tswitch (tt) {\n\tcase MLX5_TT_IPV4_UDP:\n\tcase MLX5_TT_IPV4_TCP:\n\t\tformat_id = 23;\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_l4_sport);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_l4_dport);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_ip_src_addr);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_ip_dest_addr);\n\t\tbreak;\n\tcase MLX5_TT_IPV4:\n\t\tformat_id = 23;\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_l3_type);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_dmac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_dmac_15_0);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_smac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_smac_15_0);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_ip_src_addr);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_ip_dest_addr);\n\t\tbreak;\n\tcase MLX5_TT_IPV6_TCP:\n\tcase MLX5_TT_IPV6_UDP:\n\t\tformat_id = 31;\n\t\tMLX5_SET_TO_ONES(match_definer_format_31, match_definer_mask,\n\t\t\t\t inner_l4_sport);\n\t\tMLX5_SET_TO_ONES(match_definer_format_31, match_definer_mask,\n\t\t\t\t inner_l4_dport);\n\t\tipv6 = MLX5_ADDR_OF(match_definer_format_31, match_definer_mask,\n\t\t\t\t    inner_ip_dest_addr);\n\t\tmemset(ipv6, 0xff, 16);\n\t\tipv6 = MLX5_ADDR_OF(match_definer_format_31, match_definer_mask,\n\t\t\t\t    inner_ip_src_addr);\n\t\tmemset(ipv6, 0xff, 16);\n\t\tbreak;\n\tcase MLX5_TT_IPV6:\n\t\tformat_id = 32;\n\t\tipv6 = MLX5_ADDR_OF(match_definer_format_32, match_definer_mask,\n\t\t\t\t    inner_ip_dest_addr);\n\t\tmemset(ipv6, 0xff, 16);\n\t\tipv6 = MLX5_ADDR_OF(match_definer_format_32, match_definer_mask,\n\t\t\t\t    inner_ip_src_addr);\n\t\tmemset(ipv6, 0xff, 16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_32, match_definer_mask,\n\t\t\t\t inner_dmac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_32, match_definer_mask,\n\t\t\t\t inner_dmac_15_0);\n\t\tMLX5_SET_TO_ONES(match_definer_format_32, match_definer_mask,\n\t\t\t\t inner_smac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_32, match_definer_mask,\n\t\t\t\t inner_smac_15_0);\n\t\tbreak;\n\tdefault:\n\t\tformat_id = 23;\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_l3_type);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_dmac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_dmac_15_0);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_smac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_23, match_definer_mask,\n\t\t\t\t inner_smac_15_0);\n\t\tbreak;\n\t}\n\n\treturn format_id;\n}\n\nstatic int mlx5_lag_set_definer(u32 *match_definer_mask,\n\t\t\t\tenum mlx5_traffic_types tt, bool tunnel,\n\t\t\t\tenum netdev_lag_hash hash)\n{\n\tint format_id;\n\tu8 *ipv6;\n\n\tif (tunnel)\n\t\treturn mlx5_lag_set_definer_inner(match_definer_mask, tt);\n\n\tswitch (tt) {\n\tcase MLX5_TT_IPV4_UDP:\n\tcase MLX5_TT_IPV4_TCP:\n\t\tformat_id = 22;\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_l4_sport);\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_l4_dport);\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_ip_src_addr);\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_ip_dest_addr);\n\t\tbreak;\n\tcase MLX5_TT_IPV4:\n\t\tformat_id = 22;\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_l3_type);\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_dmac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_dmac_15_0);\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_smac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_smac_15_0);\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_ip_src_addr);\n\t\tMLX5_SET_TO_ONES(match_definer_format_22, match_definer_mask,\n\t\t\t\t outer_ip_dest_addr);\n\t\tbreak;\n\tcase MLX5_TT_IPV6_TCP:\n\tcase MLX5_TT_IPV6_UDP:\n\t\tformat_id = 29;\n\t\tMLX5_SET_TO_ONES(match_definer_format_29, match_definer_mask,\n\t\t\t\t outer_l4_sport);\n\t\tMLX5_SET_TO_ONES(match_definer_format_29, match_definer_mask,\n\t\t\t\t outer_l4_dport);\n\t\tipv6 = MLX5_ADDR_OF(match_definer_format_29, match_definer_mask,\n\t\t\t\t    outer_ip_dest_addr);\n\t\tmemset(ipv6, 0xff, 16);\n\t\tipv6 = MLX5_ADDR_OF(match_definer_format_29, match_definer_mask,\n\t\t\t\t    outer_ip_src_addr);\n\t\tmemset(ipv6, 0xff, 16);\n\t\tbreak;\n\tcase MLX5_TT_IPV6:\n\t\tformat_id = 30;\n\t\tipv6 = MLX5_ADDR_OF(match_definer_format_30, match_definer_mask,\n\t\t\t\t    outer_ip_dest_addr);\n\t\tmemset(ipv6, 0xff, 16);\n\t\tipv6 = MLX5_ADDR_OF(match_definer_format_30, match_definer_mask,\n\t\t\t\t    outer_ip_src_addr);\n\t\tmemset(ipv6, 0xff, 16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_30, match_definer_mask,\n\t\t\t\t outer_dmac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_30, match_definer_mask,\n\t\t\t\t outer_dmac_15_0);\n\t\tMLX5_SET_TO_ONES(match_definer_format_30, match_definer_mask,\n\t\t\t\t outer_smac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_30, match_definer_mask,\n\t\t\t\t outer_smac_15_0);\n\t\tbreak;\n\tdefault:\n\t\tformat_id = 0;\n\t\tMLX5_SET_TO_ONES(match_definer_format_0, match_definer_mask,\n\t\t\t\t outer_smac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_0, match_definer_mask,\n\t\t\t\t outer_smac_15_0);\n\n\t\tif (hash == NETDEV_LAG_HASH_VLAN_SRCMAC) {\n\t\t\tMLX5_SET_TO_ONES(match_definer_format_0,\n\t\t\t\t\t match_definer_mask,\n\t\t\t\t\t outer_first_vlan_vid);\n\t\t\tbreak;\n\t\t}\n\n\t\tMLX5_SET_TO_ONES(match_definer_format_0, match_definer_mask,\n\t\t\t\t outer_ethertype);\n\t\tMLX5_SET_TO_ONES(match_definer_format_0, match_definer_mask,\n\t\t\t\t outer_dmac_47_16);\n\t\tMLX5_SET_TO_ONES(match_definer_format_0, match_definer_mask,\n\t\t\t\t outer_dmac_15_0);\n\t\tbreak;\n\t}\n\n\treturn format_id;\n}\n\nstatic struct mlx5_lag_definer *\nmlx5_lag_create_definer(struct mlx5_lag *ldev, enum netdev_lag_hash hash,\n\t\t\tenum mlx5_traffic_types tt, bool tunnel, u8 *ports)\n{\n\tstruct mlx5_core_dev *dev = ldev->pf[MLX5_LAG_P1].dev;\n\tstruct mlx5_lag_definer *lag_definer;\n\tu32 *match_definer_mask;\n\tint format_id, err;\n\n\tlag_definer = kzalloc(sizeof(*lag_definer), GFP_KERNEL);\n\tif (!lag_definer)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tmatch_definer_mask = kvzalloc(MLX5_FLD_SZ_BYTES(match_definer,\n\t\t\t\t\t\t\tmatch_mask),\n\t\t\t\t      GFP_KERNEL);\n\tif (!match_definer_mask) {\n\t\terr = -ENOMEM;\n\t\tgoto free_lag_definer;\n\t}\n\n\tformat_id = mlx5_lag_set_definer(match_definer_mask, tt, tunnel, hash);\n\tlag_definer->definer =\n\t\tmlx5_create_match_definer(dev, MLX5_FLOW_NAMESPACE_PORT_SEL,\n\t\t\t\t\t  format_id, match_definer_mask);\n\tif (IS_ERR(lag_definer->definer)) {\n\t\terr = PTR_ERR(lag_definer->definer);\n\t\tgoto free_mask;\n\t}\n\n\terr = mlx5_lag_create_port_sel_table(ldev, lag_definer, ports);\n\tif (err)\n\t\tgoto destroy_match_definer;\n\n\tkvfree(match_definer_mask);\n\n\treturn lag_definer;\n\ndestroy_match_definer:\n\tmlx5_destroy_match_definer(dev, lag_definer->definer);\nfree_mask:\n\tkvfree(match_definer_mask);\nfree_lag_definer:\n\tkfree(lag_definer);\n\treturn ERR_PTR(err);\n}\n\nstatic void mlx5_lag_destroy_definer(struct mlx5_lag *ldev,\n\t\t\t\t     struct mlx5_lag_definer *lag_definer)\n{\n\tstruct mlx5_core_dev *dev = ldev->pf[MLX5_LAG_P1].dev;\n\tint idx;\n\tint i;\n\tint j;\n\n\tfor (i = 0; i < ldev->ports; i++) {\n\t\tfor (j = 0; j < ldev->buckets; j++) {\n\t\t\tidx = i * ldev->buckets + j;\n\t\t\tmlx5_del_flow_rules(lag_definer->rules[idx]);\n\t\t}\n\t}\n\tmlx5_destroy_flow_group(lag_definer->fg);\n\tmlx5_destroy_flow_table(lag_definer->ft);\n\tmlx5_destroy_match_definer(dev, lag_definer->definer);\n\tkfree(lag_definer);\n}\n\nstatic void mlx5_lag_destroy_definers(struct mlx5_lag *ldev)\n{\n\tstruct mlx5_lag_port_sel *port_sel = &ldev->port_sel;\n\tint tt;\n\n\tfor_each_set_bit(tt, port_sel->tt_map, MLX5_NUM_TT) {\n\t\tif (port_sel->outer.definers[tt])\n\t\t\tmlx5_lag_destroy_definer(ldev,\n\t\t\t\t\t\t port_sel->outer.definers[tt]);\n\t\tif (port_sel->inner.definers[tt])\n\t\t\tmlx5_lag_destroy_definer(ldev,\n\t\t\t\t\t\t port_sel->inner.definers[tt]);\n\t}\n}\n\nstatic int mlx5_lag_create_definers(struct mlx5_lag *ldev,\n\t\t\t\t    enum netdev_lag_hash hash_type,\n\t\t\t\t    u8 *ports)\n{\n\tstruct mlx5_lag_port_sel *port_sel = &ldev->port_sel;\n\tstruct mlx5_lag_definer *lag_definer;\n\tint tt, err;\n\n\tfor_each_set_bit(tt, port_sel->tt_map, MLX5_NUM_TT) {\n\t\tlag_definer = mlx5_lag_create_definer(ldev, hash_type, tt,\n\t\t\t\t\t\t      false, ports);\n\t\tif (IS_ERR(lag_definer)) {\n\t\t\terr = PTR_ERR(lag_definer);\n\t\t\tgoto destroy_definers;\n\t\t}\n\t\tport_sel->outer.definers[tt] = lag_definer;\n\n\t\tif (!port_sel->tunnel)\n\t\t\tcontinue;\n\n\t\tlag_definer =\n\t\t\tmlx5_lag_create_definer(ldev, hash_type, tt,\n\t\t\t\t\t\ttrue, ports);\n\t\tif (IS_ERR(lag_definer)) {\n\t\t\terr = PTR_ERR(lag_definer);\n\t\t\tgoto destroy_definers;\n\t\t}\n\t\tport_sel->inner.definers[tt] = lag_definer;\n\t}\n\n\treturn 0;\n\ndestroy_definers:\n\tmlx5_lag_destroy_definers(ldev);\n\treturn err;\n}\n\nstatic void set_tt_map(struct mlx5_lag_port_sel *port_sel,\n\t\t       enum netdev_lag_hash hash)\n{\n\tport_sel->tunnel = false;\n\n\tswitch (hash) {\n\tcase NETDEV_LAG_HASH_E34:\n\t\tport_sel->tunnel = true;\n\t\tfallthrough;\n\tcase NETDEV_LAG_HASH_L34:\n\t\tset_bit(MLX5_TT_IPV4_TCP, port_sel->tt_map);\n\t\tset_bit(MLX5_TT_IPV4_UDP, port_sel->tt_map);\n\t\tset_bit(MLX5_TT_IPV6_TCP, port_sel->tt_map);\n\t\tset_bit(MLX5_TT_IPV6_UDP, port_sel->tt_map);\n\t\tset_bit(MLX5_TT_IPV4, port_sel->tt_map);\n\t\tset_bit(MLX5_TT_IPV6, port_sel->tt_map);\n\t\tset_bit(MLX5_TT_ANY, port_sel->tt_map);\n\t\tbreak;\n\tcase NETDEV_LAG_HASH_E23:\n\t\tport_sel->tunnel = true;\n\t\tfallthrough;\n\tcase NETDEV_LAG_HASH_L23:\n\t\tset_bit(MLX5_TT_IPV4, port_sel->tt_map);\n\t\tset_bit(MLX5_TT_IPV6, port_sel->tt_map);\n\t\tset_bit(MLX5_TT_ANY, port_sel->tt_map);\n\t\tbreak;\n\tdefault:\n\t\tset_bit(MLX5_TT_ANY, port_sel->tt_map);\n\t\tbreak;\n\t}\n}\n\n#define SET_IGNORE_DESTS_BITS(tt_map, dests)\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\\\n\t\tint idx;\t\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t\tfor_each_clear_bit(idx, tt_map, MLX5_NUM_TT)\t\t\\\n\t\t\tset_bit(idx, dests);\t\t\t\t\\\n\t} while (0)\n\nstatic void mlx5_lag_set_inner_ttc_params(struct mlx5_lag *ldev,\n\t\t\t\t\t  struct ttc_params *ttc_params)\n{\n\tstruct mlx5_core_dev *dev = ldev->pf[MLX5_LAG_P1].dev;\n\tstruct mlx5_lag_port_sel *port_sel = &ldev->port_sel;\n\tstruct mlx5_flow_table_attr *ft_attr;\n\tint tt;\n\n\tttc_params->ns = mlx5_get_flow_namespace(dev,\n\t\t\t\t\t\t MLX5_FLOW_NAMESPACE_PORT_SEL);\n\tft_attr = &ttc_params->ft_attr;\n\tft_attr->level = MLX5_LAG_FT_LEVEL_INNER_TTC;\n\n\tfor_each_set_bit(tt, port_sel->tt_map, MLX5_NUM_TT) {\n\t\tttc_params->dests[tt].type =\n\t\t\tMLX5_FLOW_DESTINATION_TYPE_FLOW_TABLE;\n\t\tttc_params->dests[tt].ft = port_sel->inner.definers[tt]->ft;\n\t}\n\tSET_IGNORE_DESTS_BITS(port_sel->tt_map, ttc_params->ignore_dests);\n}\n\nstatic void mlx5_lag_set_outer_ttc_params(struct mlx5_lag *ldev,\n\t\t\t\t\t  struct ttc_params *ttc_params)\n{\n\tstruct mlx5_core_dev *dev = ldev->pf[MLX5_LAG_P1].dev;\n\tstruct mlx5_lag_port_sel *port_sel = &ldev->port_sel;\n\tstruct mlx5_flow_table_attr *ft_attr;\n\tint tt;\n\n\tttc_params->ns = mlx5_get_flow_namespace(dev,\n\t\t\t\t\t\t MLX5_FLOW_NAMESPACE_PORT_SEL);\n\tft_attr = &ttc_params->ft_attr;\n\tft_attr->level = MLX5_LAG_FT_LEVEL_TTC;\n\n\tfor_each_set_bit(tt, port_sel->tt_map, MLX5_NUM_TT) {\n\t\tttc_params->dests[tt].type =\n\t\t\tMLX5_FLOW_DESTINATION_TYPE_FLOW_TABLE;\n\t\tttc_params->dests[tt].ft = port_sel->outer.definers[tt]->ft;\n\t}\n\tSET_IGNORE_DESTS_BITS(port_sel->tt_map, ttc_params->ignore_dests);\n\n\tttc_params->inner_ttc = port_sel->tunnel;\n\tif (!port_sel->tunnel)\n\t\treturn;\n\n\tfor (tt = 0; tt < MLX5_NUM_TUNNEL_TT; tt++) {\n\t\tttc_params->tunnel_dests[tt].type =\n\t\t\tMLX5_FLOW_DESTINATION_TYPE_FLOW_TABLE;\n\t\tttc_params->tunnel_dests[tt].ft =\n\t\t\tmlx5_get_ttc_flow_table(port_sel->inner.ttc);\n\t}\n}\n\nstatic int mlx5_lag_create_ttc_table(struct mlx5_lag *ldev)\n{\n\tstruct mlx5_core_dev *dev = ldev->pf[MLX5_LAG_P1].dev;\n\tstruct mlx5_lag_port_sel *port_sel = &ldev->port_sel;\n\tstruct ttc_params ttc_params = {};\n\n\tmlx5_lag_set_outer_ttc_params(ldev, &ttc_params);\n\tport_sel->outer.ttc = mlx5_create_ttc_table(dev, &ttc_params);\n\tif (IS_ERR(port_sel->outer.ttc))\n\t\treturn PTR_ERR(port_sel->outer.ttc);\n\n\treturn 0;\n}\n\nstatic int mlx5_lag_create_inner_ttc_table(struct mlx5_lag *ldev)\n{\n\tstruct mlx5_core_dev *dev = ldev->pf[MLX5_LAG_P1].dev;\n\tstruct mlx5_lag_port_sel *port_sel = &ldev->port_sel;\n\tstruct ttc_params ttc_params = {};\n\n\tmlx5_lag_set_inner_ttc_params(ldev, &ttc_params);\n\tport_sel->inner.ttc = mlx5_create_inner_ttc_table(dev, &ttc_params);\n\tif (IS_ERR(port_sel->inner.ttc))\n\t\treturn PTR_ERR(port_sel->inner.ttc);\n\n\treturn 0;\n}\n\nint mlx5_lag_port_sel_create(struct mlx5_lag *ldev,\n\t\t\t     enum netdev_lag_hash hash_type, u8 *ports)\n{\n\tstruct mlx5_lag_port_sel *port_sel = &ldev->port_sel;\n\tint err;\n\n\tset_tt_map(port_sel, hash_type);\n\terr = mlx5_lag_create_definers(ldev, hash_type, ports);\n\tif (err)\n\t\treturn err;\n\n\tif (port_sel->tunnel) {\n\t\terr = mlx5_lag_create_inner_ttc_table(ldev);\n\t\tif (err)\n\t\t\tgoto destroy_definers;\n\t}\n\n\terr = mlx5_lag_create_ttc_table(ldev);\n\tif (err)\n\t\tgoto destroy_inner;\n\n\treturn 0;\n\ndestroy_inner:\n\tif (port_sel->tunnel)\n\t\tmlx5_destroy_ttc_table(port_sel->inner.ttc);\ndestroy_definers:\n\tmlx5_lag_destroy_definers(ldev);\n\treturn err;\n}\n\nstatic int __mlx5_lag_modify_definers_destinations(struct mlx5_lag *ldev,\n\t\t\t\t\t\t   struct mlx5_lag_definer *def,\n\t\t\t\t\t\t   u8 *ports)\n{\n\tstruct mlx5_flow_destination dest = {};\n\tint idx;\n\tint err;\n\tint i;\n\tint j;\n\n\tdest.type = MLX5_FLOW_DESTINATION_TYPE_UPLINK;\n\tdest.vport.flags |= MLX5_FLOW_DEST_VPORT_VHCA_ID;\n\n\tfor (i = 0; i < ldev->ports; i++) {\n\t\tfor (j = 0; j < ldev->buckets; j++) {\n\t\t\tidx = i * ldev->buckets + j;\n\t\t\tif (ldev->v2p_map[idx] == ports[idx])\n\t\t\t\tcontinue;\n\n\t\t\tdest.vport.vhca_id = MLX5_CAP_GEN(ldev->pf[ports[idx] - 1].dev,\n\t\t\t\t\t\t\t  vhca_id);\n\t\t\terr = mlx5_modify_rule_destination(def->rules[idx], &dest, NULL);\n\t\t\tif (err)\n\t\t\t\treturn err;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int\nmlx5_lag_modify_definers_destinations(struct mlx5_lag *ldev,\n\t\t\t\t      struct mlx5_lag_definer **definers,\n\t\t\t\t      u8 *ports)\n{\n\tstruct mlx5_lag_port_sel *port_sel = &ldev->port_sel;\n\tint err;\n\tint tt;\n\n\tfor_each_set_bit(tt, port_sel->tt_map, MLX5_NUM_TT) {\n\t\terr = __mlx5_lag_modify_definers_destinations(ldev, definers[tt], ports);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint mlx5_lag_port_sel_modify(struct mlx5_lag *ldev, u8 *ports)\n{\n\tstruct mlx5_lag_port_sel *port_sel = &ldev->port_sel;\n\tint err;\n\n\terr = mlx5_lag_modify_definers_destinations(ldev,\n\t\t\t\t\t\t    port_sel->outer.definers,\n\t\t\t\t\t\t    ports);\n\tif (err)\n\t\treturn err;\n\n\tif (!port_sel->tunnel)\n\t\treturn 0;\n\n\treturn mlx5_lag_modify_definers_destinations(ldev,\n\t\t\t\t\t\t     port_sel->inner.definers,\n\t\t\t\t\t\t     ports);\n}\n\nvoid mlx5_lag_port_sel_destroy(struct mlx5_lag *ldev)\n{\n\tstruct mlx5_lag_port_sel *port_sel = &ldev->port_sel;\n\n\tmlx5_destroy_ttc_table(port_sel->outer.ttc);\n\tif (port_sel->tunnel)\n\t\tmlx5_destroy_ttc_table(port_sel->inner.ttc);\n\tmlx5_lag_destroy_definers(ldev);\n\tmemset(port_sel, 0, sizeof(*port_sel));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}