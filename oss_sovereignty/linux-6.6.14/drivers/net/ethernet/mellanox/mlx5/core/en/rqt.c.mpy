{
  "module_name": "rqt.c",
  "hash_id": "608c9957201712ad36ac05d4235f980a9d62ed54e2f5ea745cd6a9a04e9b3b15",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/en/rqt.c",
  "human_readable_source": "\n \n\n#include \"rqt.h\"\n#include <linux/mlx5/transobj.h>\n\nvoid mlx5e_rss_params_indir_init_uniform(struct mlx5e_rss_params_indir *indir,\n\t\t\t\t\t unsigned int num_channels)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < MLX5E_INDIR_RQT_SIZE; i++)\n\t\tindir->table[i] = i % num_channels;\n}\n\nstatic int mlx5e_rqt_init(struct mlx5e_rqt *rqt, struct mlx5_core_dev *mdev,\n\t\t\t  u16 max_size, u32 *init_rqns, u16 init_size)\n{\n\tvoid *rqtc;\n\tint inlen;\n\tint err;\n\tu32 *in;\n\tint i;\n\n\trqt->mdev = mdev;\n\trqt->size = max_size;\n\n\tinlen = MLX5_ST_SZ_BYTES(create_rqt_in) + sizeof(u32) * init_size;\n\tin = kvzalloc(inlen, GFP_KERNEL);\n\tif (!in)\n\t\treturn -ENOMEM;\n\n\trqtc = MLX5_ADDR_OF(create_rqt_in, in, rqt_context);\n\n\tMLX5_SET(rqtc, rqtc, rqt_max_size, rqt->size);\n\n\tMLX5_SET(rqtc, rqtc, rqt_actual_size, init_size);\n\tfor (i = 0; i < init_size; i++)\n\t\tMLX5_SET(rqtc, rqtc, rq_num[i], init_rqns[i]);\n\n\terr = mlx5_core_create_rqt(rqt->mdev, in, inlen, &rqt->rqtn);\n\n\tkvfree(in);\n\treturn err;\n}\n\nint mlx5e_rqt_init_direct(struct mlx5e_rqt *rqt, struct mlx5_core_dev *mdev,\n\t\t\t  bool indir_enabled, u32 init_rqn)\n{\n\tu16 max_size = indir_enabled ? MLX5E_INDIR_RQT_SIZE : 1;\n\n\treturn mlx5e_rqt_init(rqt, mdev, max_size, &init_rqn, 1);\n}\n\nstatic int mlx5e_bits_invert(unsigned long a, int size)\n{\n\tint inv = 0;\n\tint i;\n\n\tfor (i = 0; i < size; i++)\n\t\tinv |= (test_bit(size - i - 1, &a) ? 1 : 0) << i;\n\n\treturn inv;\n}\n\nstatic int mlx5e_calc_indir_rqns(u32 *rss_rqns, u32 *rqns, unsigned int num_rqns,\n\t\t\t\t u8 hfunc, struct mlx5e_rss_params_indir *indir)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < MLX5E_INDIR_RQT_SIZE; i++) {\n\t\tunsigned int ix = i;\n\n\t\tif (hfunc == ETH_RSS_HASH_XOR)\n\t\t\tix = mlx5e_bits_invert(ix, ilog2(MLX5E_INDIR_RQT_SIZE));\n\n\t\tix = indir->table[ix];\n\n\t\tif (WARN_ON(ix >= num_rqns))\n\t\t\t \n\t\t\treturn -EINVAL;\n\t\trss_rqns[i] = rqns[ix];\n\t}\n\n\treturn 0;\n}\n\nint mlx5e_rqt_init_indir(struct mlx5e_rqt *rqt, struct mlx5_core_dev *mdev,\n\t\t\t u32 *rqns, unsigned int num_rqns,\n\t\t\t u8 hfunc, struct mlx5e_rss_params_indir *indir)\n{\n\tu32 *rss_rqns;\n\tint err;\n\n\trss_rqns = kvmalloc_array(MLX5E_INDIR_RQT_SIZE, sizeof(*rss_rqns), GFP_KERNEL);\n\tif (!rss_rqns)\n\t\treturn -ENOMEM;\n\n\terr = mlx5e_calc_indir_rqns(rss_rqns, rqns, num_rqns, hfunc, indir);\n\tif (err)\n\t\tgoto out;\n\n\terr = mlx5e_rqt_init(rqt, mdev, MLX5E_INDIR_RQT_SIZE, rss_rqns, MLX5E_INDIR_RQT_SIZE);\n\nout:\n\tkvfree(rss_rqns);\n\treturn err;\n}\n\nvoid mlx5e_rqt_destroy(struct mlx5e_rqt *rqt)\n{\n\tmlx5_core_destroy_rqt(rqt->mdev, rqt->rqtn);\n}\n\nstatic int mlx5e_rqt_redirect(struct mlx5e_rqt *rqt, u32 *rqns, unsigned int size)\n{\n\tunsigned int i;\n\tvoid *rqtc;\n\tint inlen;\n\tu32 *in;\n\tint err;\n\n\tinlen = MLX5_ST_SZ_BYTES(modify_rqt_in) + sizeof(u32) * size;\n\tin = kvzalloc(inlen, GFP_KERNEL);\n\tif (!in)\n\t\treturn -ENOMEM;\n\n\trqtc = MLX5_ADDR_OF(modify_rqt_in, in, ctx);\n\n\tMLX5_SET(modify_rqt_in, in, bitmask.rqn_list, 1);\n\tMLX5_SET(rqtc, rqtc, rqt_actual_size, size);\n\tfor (i = 0; i < size; i++)\n\t\tMLX5_SET(rqtc, rqtc, rq_num[i], rqns[i]);\n\n\terr = mlx5_core_modify_rqt(rqt->mdev, rqt->rqtn, in, inlen);\n\n\tkvfree(in);\n\treturn err;\n}\n\nint mlx5e_rqt_redirect_direct(struct mlx5e_rqt *rqt, u32 rqn)\n{\n\treturn mlx5e_rqt_redirect(rqt, &rqn, 1);\n}\n\nint mlx5e_rqt_redirect_indir(struct mlx5e_rqt *rqt, u32 *rqns, unsigned int num_rqns,\n\t\t\t     u8 hfunc, struct mlx5e_rss_params_indir *indir)\n{\n\tu32 *rss_rqns;\n\tint err;\n\n\tif (WARN_ON(rqt->size != MLX5E_INDIR_RQT_SIZE))\n\t\treturn -EINVAL;\n\n\trss_rqns = kvmalloc_array(MLX5E_INDIR_RQT_SIZE, sizeof(*rss_rqns), GFP_KERNEL);\n\tif (!rss_rqns)\n\t\treturn -ENOMEM;\n\n\terr = mlx5e_calc_indir_rqns(rss_rqns, rqns, num_rqns, hfunc, indir);\n\tif (err)\n\t\tgoto out;\n\n\terr = mlx5e_rqt_redirect(rqt, rss_rqns, MLX5E_INDIR_RQT_SIZE);\n\nout:\n\tkvfree(rss_rqns);\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}