{
  "module_name": "ecpf.c",
  "hash_id": "32933e3ce20124d92d703fed6bcb83cb8456ecb6bc703ddd93ad8bc01f6f0095",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/ecpf.c",
  "human_readable_source": " \n \n\n#include \"ecpf.h\"\n\nbool mlx5_read_embedded_cpu(struct mlx5_core_dev *dev)\n{\n\treturn (ioread32be(&dev->iseg->initializing) >> MLX5_ECPU_BIT_NUM) & 1;\n}\n\nstatic bool mlx5_ecpf_esw_admins_host_pf(const struct mlx5_core_dev *dev)\n{\n\t \n\treturn mlx5_core_is_ecpf_esw_manager(dev);\n}\n\nint mlx5_cmd_host_pf_enable_hca(struct mlx5_core_dev *dev)\n{\n\tu32 out[MLX5_ST_SZ_DW(enable_hca_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(enable_hca_in)]   = {};\n\n\tMLX5_SET(enable_hca_in, in, opcode, MLX5_CMD_OP_ENABLE_HCA);\n\tMLX5_SET(enable_hca_in, in, function_id, 0);\n\tMLX5_SET(enable_hca_in, in, embedded_cpu_function, 0);\n\treturn mlx5_cmd_exec(dev, &in, sizeof(in), &out, sizeof(out));\n}\n\nint mlx5_cmd_host_pf_disable_hca(struct mlx5_core_dev *dev)\n{\n\tu32 out[MLX5_ST_SZ_DW(disable_hca_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(disable_hca_in)]   = {};\n\n\tMLX5_SET(disable_hca_in, in, opcode, MLX5_CMD_OP_DISABLE_HCA);\n\tMLX5_SET(disable_hca_in, in, function_id, 0);\n\tMLX5_SET(disable_hca_in, in, embedded_cpu_function, 0);\n\treturn mlx5_cmd_exec(dev, in, sizeof(in), out, sizeof(out));\n}\n\nstatic int mlx5_host_pf_init(struct mlx5_core_dev *dev)\n{\n\tint err;\n\n\tif (mlx5_ecpf_esw_admins_host_pf(dev))\n\t\treturn 0;\n\n\t \n\terr = mlx5_cmd_host_pf_enable_hca(dev);\n\tif (err)\n\t\tmlx5_core_err(dev, \"Failed to enable external host PF HCA err(%d)\\n\", err);\n\n\treturn err;\n}\n\nstatic void mlx5_host_pf_cleanup(struct mlx5_core_dev *dev)\n{\n\tint err;\n\n\tif (mlx5_ecpf_esw_admins_host_pf(dev))\n\t\treturn;\n\n\terr = mlx5_cmd_host_pf_disable_hca(dev);\n\tif (err) {\n\t\tmlx5_core_err(dev, \"Failed to disable external host PF HCA err(%d)\\n\", err);\n\t\treturn;\n\t}\n}\n\nint mlx5_ec_init(struct mlx5_core_dev *dev)\n{\n\tif (!mlx5_core_is_ecpf(dev))\n\t\treturn 0;\n\n\treturn mlx5_host_pf_init(dev);\n}\n\nvoid mlx5_ec_cleanup(struct mlx5_core_dev *dev)\n{\n\tint err;\n\n\tif (!mlx5_core_is_ecpf(dev))\n\t\treturn;\n\n\tmlx5_host_pf_cleanup(dev);\n\n\terr = mlx5_wait_for_pages(dev, &dev->priv.page_counters[MLX5_HOST_PF]);\n\tif (err)\n\t\tmlx5_core_warn(dev, \"Timeout reclaiming external host PF pages err(%d)\\n\", err);\n\n\terr = mlx5_wait_for_pages(dev, &dev->priv.page_counters[MLX5_VF]);\n\tif (err)\n\t\tmlx5_core_warn(dev, \"Timeout reclaiming external host VFs pages err(%d)\\n\", err);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}