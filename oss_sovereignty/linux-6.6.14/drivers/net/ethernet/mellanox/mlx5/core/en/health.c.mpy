{
  "module_name": "health.c",
  "hash_id": "5ff145b78c3a5d097190db5e3640be2f80072e58ed2443a3a1a62959d53ccc1c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/en/health.c",
  "human_readable_source": "\n\n\n#include \"health.h\"\n#include \"lib/eq.h\"\n#include \"lib/mlx5.h\"\n\nint mlx5e_health_fmsg_named_obj_nest_start(struct devlink_fmsg *fmsg, char *name)\n{\n\tint err;\n\n\terr = devlink_fmsg_pair_nest_start(fmsg, name);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_obj_nest_start(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\nint mlx5e_health_fmsg_named_obj_nest_end(struct devlink_fmsg *fmsg)\n{\n\tint err;\n\n\terr = devlink_fmsg_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_pair_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\nint mlx5e_health_cq_diag_fmsg(struct mlx5e_cq *cq, struct devlink_fmsg *fmsg)\n{\n\tu32 out[MLX5_ST_SZ_DW(query_cq_out)] = {};\n\tu8 hw_status;\n\tvoid *cqc;\n\tint err;\n\n\terr = mlx5_core_query_cq(cq->mdev, &cq->mcq, out);\n\tif (err)\n\t\treturn err;\n\n\tcqc = MLX5_ADDR_OF(query_cq_out, out, cq_context);\n\thw_status = MLX5_GET(cqc, cqc, status);\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"CQ\");\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"cqn\", cq->mcq.cqn);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u8_pair_put(fmsg, \"HW status\", hw_status);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"ci\", mlx5_cqwq_get_ci(&cq->wq));\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"size\", mlx5_cqwq_get_size(&cq->wq));\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\nint mlx5e_health_cq_common_diag_fmsg(struct mlx5e_cq *cq, struct devlink_fmsg *fmsg)\n{\n\tu8 cq_log_stride;\n\tu32 cq_sz;\n\tint err;\n\n\tcq_sz = mlx5_cqwq_get_size(&cq->wq);\n\tcq_log_stride = mlx5_cqwq_get_log_stride_size(&cq->wq);\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"CQ\");\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u64_pair_put(fmsg, \"stride size\", BIT(cq_log_stride));\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"size\", cq_sz);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\nint mlx5e_health_eq_diag_fmsg(struct mlx5_eq_comp *eq, struct devlink_fmsg *fmsg)\n{\n\tint err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"EQ\");\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u8_pair_put(fmsg, \"eqn\", eq->core.eqn);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"irqn\", eq->core.irqn);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"vecidx\", eq->core.vecidx);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"ci\", eq->core.cons_index);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"size\", eq_get_size(&eq->core));\n\tif (err)\n\t\treturn err;\n\n\treturn mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n}\n\nvoid mlx5e_health_create_reporters(struct mlx5e_priv *priv)\n{\n\tmlx5e_reporter_tx_create(priv);\n\tmlx5e_reporter_rx_create(priv);\n}\n\nvoid mlx5e_health_destroy_reporters(struct mlx5e_priv *priv)\n{\n\tmlx5e_reporter_rx_destroy(priv);\n\tmlx5e_reporter_tx_destroy(priv);\n}\n\nvoid mlx5e_health_channels_update(struct mlx5e_priv *priv)\n{\n\tif (priv->tx_reporter)\n\t\tdevlink_health_reporter_state_update(priv->tx_reporter,\n\t\t\t\t\t\t     DEVLINK_HEALTH_REPORTER_STATE_HEALTHY);\n\tif (priv->rx_reporter)\n\t\tdevlink_health_reporter_state_update(priv->rx_reporter,\n\t\t\t\t\t\t     DEVLINK_HEALTH_REPORTER_STATE_HEALTHY);\n}\n\nint mlx5e_health_sq_to_ready(struct mlx5_core_dev *mdev, struct net_device *dev, u32 sqn)\n{\n\tstruct mlx5e_modify_sq_param msp = {};\n\tint err;\n\n\tmsp.curr_state = MLX5_SQC_STATE_ERR;\n\tmsp.next_state = MLX5_SQC_STATE_RST;\n\n\terr = mlx5e_modify_sq(mdev, sqn, &msp);\n\tif (err) {\n\t\tnetdev_err(dev, \"Failed to move sq 0x%x to reset\\n\", sqn);\n\t\treturn err;\n\t}\n\n\tmemset(&msp, 0, sizeof(msp));\n\tmsp.curr_state = MLX5_SQC_STATE_RST;\n\tmsp.next_state = MLX5_SQC_STATE_RDY;\n\n\terr = mlx5e_modify_sq(mdev, sqn, &msp);\n\tif (err) {\n\t\tnetdev_err(dev, \"Failed to move sq 0x%x to ready\\n\", sqn);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nint mlx5e_health_recover_channels(struct mlx5e_priv *priv)\n{\n\tint err = 0;\n\n\trtnl_lock();\n\tmutex_lock(&priv->state_lock);\n\n\tif (!test_bit(MLX5E_STATE_OPENED, &priv->state))\n\t\tgoto out;\n\n\terr = mlx5e_safe_reopen_channels(priv);\n\nout:\n\tmutex_unlock(&priv->state_lock);\n\trtnl_unlock();\n\n\treturn err;\n}\n\nint mlx5e_health_channel_eq_recover(struct net_device *dev, struct mlx5_eq_comp *eq,\n\t\t\t\t    struct mlx5e_ch_stats *stats)\n{\n\tu32 eqe_count;\n\n\tnetdev_err(dev, \"EQ 0x%x: Cons = 0x%x, irqn = 0x%x\\n\",\n\t\t   eq->core.eqn, eq->core.cons_index, eq->core.irqn);\n\n\teqe_count = mlx5_eq_poll_irq_disabled(eq);\n\tif (!eqe_count)\n\t\treturn -EIO;\n\n\tnetdev_err(dev, \"Recovered %d eqes on EQ 0x%x\\n\",\n\t\t   eqe_count, eq->core.eqn);\n\n\tstats->eq_rearm++;\n\treturn 0;\n}\n\nint mlx5e_health_report(struct mlx5e_priv *priv,\n\t\t\tstruct devlink_health_reporter *reporter, char *err_str,\n\t\t\tstruct mlx5e_err_ctx *err_ctx)\n{\n\tnetdev_err(priv->netdev, \"%s\\n\", err_str);\n\n\tif (!reporter)\n\t\treturn err_ctx->recover(err_ctx->ctx);\n\n\treturn devlink_health_report(reporter, err_str, err_ctx);\n}\n\n#define MLX5_HEALTH_DEVLINK_MAX_SIZE 1024\nstatic int mlx5e_health_rsc_fmsg_binary(struct devlink_fmsg *fmsg,\n\t\t\t\t\tconst void *value, u32 value_len)\n\n{\n\tu32 data_size;\n\tint err = 0;\n\tu32 offset;\n\n\tfor (offset = 0; offset < value_len; offset += data_size) {\n\t\tdata_size = value_len - offset;\n\t\tif (data_size > MLX5_HEALTH_DEVLINK_MAX_SIZE)\n\t\t\tdata_size = MLX5_HEALTH_DEVLINK_MAX_SIZE;\n\t\terr = devlink_fmsg_binary_put(fmsg, value + offset, data_size);\n\t\tif (err)\n\t\t\tbreak;\n\t}\n\treturn err;\n}\n\nint mlx5e_health_rsc_fmsg_dump(struct mlx5e_priv *priv, struct mlx5_rsc_key *key,\n\t\t\t       struct devlink_fmsg *fmsg)\n{\n\tstruct mlx5_core_dev *mdev = priv->mdev;\n\tstruct mlx5_rsc_dump_cmd *cmd;\n\tstruct page *page;\n\tint cmd_err, err;\n\tint end_err;\n\tint size;\n\n\tif (IS_ERR_OR_NULL(mdev->rsc_dump))\n\t\treturn -EOPNOTSUPP;\n\n\tpage = alloc_page(GFP_KERNEL);\n\tif (!page)\n\t\treturn -ENOMEM;\n\n\terr = devlink_fmsg_binary_pair_nest_start(fmsg, \"data\");\n\tif (err)\n\t\tgoto free_page;\n\n\tcmd = mlx5_rsc_dump_cmd_create(mdev, key);\n\tif (IS_ERR(cmd)) {\n\t\terr = PTR_ERR(cmd);\n\t\tgoto free_page;\n\t}\n\n\tdo {\n\t\tcmd_err = mlx5_rsc_dump_next(mdev, cmd, page, &size);\n\t\tif (cmd_err < 0) {\n\t\t\terr = cmd_err;\n\t\t\tgoto destroy_cmd;\n\t\t}\n\n\t\terr = mlx5e_health_rsc_fmsg_binary(fmsg, page_address(page), size);\n\t\tif (err)\n\t\t\tgoto destroy_cmd;\n\n\t} while (cmd_err > 0);\n\ndestroy_cmd:\n\tmlx5_rsc_dump_cmd_destroy(cmd);\n\tend_err = devlink_fmsg_binary_pair_nest_end(fmsg);\n\tif (end_err)\n\t\terr = end_err;\nfree_page:\n\t__free_page(page);\n\treturn err;\n}\n\nint mlx5e_health_queue_dump(struct mlx5e_priv *priv, struct devlink_fmsg *fmsg,\n\t\t\t    int queue_idx, char *lbl)\n{\n\tstruct mlx5_rsc_key key = {};\n\tint err;\n\n\tkey.rsc = MLX5_SGMT_TYPE_FULL_QPC;\n\tkey.index1 = queue_idx;\n\tkey.size = PAGE_SIZE;\n\tkey.num_of_obj1 = 1;\n\n\terr = devlink_fmsg_obj_nest_start(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, lbl);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"index\", queue_idx);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_rsc_fmsg_dump(priv, &key, fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn devlink_fmsg_obj_nest_end(fmsg);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}