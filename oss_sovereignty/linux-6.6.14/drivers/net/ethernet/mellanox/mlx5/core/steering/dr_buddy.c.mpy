{
  "module_name": "dr_buddy.c",
  "hash_id": "b19775fa45a6e3eed9346ec1a6221c837a66efc67a4f82d391eb0a366d5bd39b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_buddy.c",
  "human_readable_source": "\n \n\n#include \"dr_types.h\"\n\nint mlx5dr_buddy_init(struct mlx5dr_icm_buddy_mem *buddy,\n\t\t      unsigned int max_order)\n{\n\tint i;\n\n\tbuddy->max_order = max_order;\n\n\tINIT_LIST_HEAD(&buddy->list_node);\n\n\tbuddy->bitmap = kcalloc(buddy->max_order + 1,\n\t\t\t\tsizeof(*buddy->bitmap),\n\t\t\t\tGFP_KERNEL);\n\tbuddy->num_free = kcalloc(buddy->max_order + 1,\n\t\t\t\t  sizeof(*buddy->num_free),\n\t\t\t\t  GFP_KERNEL);\n\n\tif (!buddy->bitmap || !buddy->num_free)\n\t\tgoto err_free_all;\n\n\t \n\n\tfor (i = 0; i <= buddy->max_order; ++i) {\n\t\tunsigned int size = 1 << (buddy->max_order - i);\n\n\t\tbuddy->bitmap[i] = bitmap_zalloc(size, GFP_KERNEL);\n\t\tif (!buddy->bitmap[i])\n\t\t\tgoto err_out_free_each_bit_per_order;\n\t}\n\n\t \n\n\tbitmap_set(buddy->bitmap[buddy->max_order], 0, 1);\n\n\tbuddy->num_free[buddy->max_order] = 1;\n\n\treturn 0;\n\nerr_out_free_each_bit_per_order:\n\tfor (i = 0; i <= buddy->max_order; ++i)\n\t\tbitmap_free(buddy->bitmap[i]);\n\nerr_free_all:\n\tkfree(buddy->num_free);\n\tkfree(buddy->bitmap);\n\treturn -ENOMEM;\n}\n\nvoid mlx5dr_buddy_cleanup(struct mlx5dr_icm_buddy_mem *buddy)\n{\n\tint i;\n\n\tlist_del(&buddy->list_node);\n\n\tfor (i = 0; i <= buddy->max_order; ++i)\n\t\tbitmap_free(buddy->bitmap[i]);\n\n\tkfree(buddy->num_free);\n\tkfree(buddy->bitmap);\n}\n\nstatic int dr_buddy_find_free_seg(struct mlx5dr_icm_buddy_mem *buddy,\n\t\t\t\t  unsigned int start_order,\n\t\t\t\t  unsigned int *segment,\n\t\t\t\t  unsigned int *order)\n{\n\tunsigned int seg, order_iter, m;\n\n\tfor (order_iter = start_order;\n\t     order_iter <= buddy->max_order; ++order_iter) {\n\t\tif (!buddy->num_free[order_iter])\n\t\t\tcontinue;\n\n\t\tm = 1 << (buddy->max_order - order_iter);\n\t\tseg = find_first_bit(buddy->bitmap[order_iter], m);\n\n\t\tif (WARN(seg >= m,\n\t\t\t \"ICM Buddy: failed finding free mem for order %d\\n\",\n\t\t\t order_iter))\n\t\t\treturn -ENOMEM;\n\n\t\tbreak;\n\t}\n\n\tif (order_iter > buddy->max_order)\n\t\treturn -ENOMEM;\n\n\t*segment = seg;\n\t*order = order_iter;\n\treturn 0;\n}\n\n \nint mlx5dr_buddy_alloc_mem(struct mlx5dr_icm_buddy_mem *buddy,\n\t\t\t   unsigned int order,\n\t\t\t   unsigned int *segment)\n{\n\tunsigned int seg, order_iter;\n\tint err;\n\n\terr = dr_buddy_find_free_seg(buddy, order, &seg, &order_iter);\n\tif (err)\n\t\treturn err;\n\n\tbitmap_clear(buddy->bitmap[order_iter], seg, 1);\n\t--buddy->num_free[order_iter];\n\n\t \n\twhile (order_iter > order) {\n\t\t--order_iter;\n\t\tseg <<= 1;\n\t\tbitmap_set(buddy->bitmap[order_iter], seg ^ 1, 1);\n\t\t++buddy->num_free[order_iter];\n\t}\n\n\tseg <<= order;\n\t*segment = seg;\n\n\treturn 0;\n}\n\nvoid mlx5dr_buddy_free_mem(struct mlx5dr_icm_buddy_mem *buddy,\n\t\t\t   unsigned int seg, unsigned int order)\n{\n\tseg >>= order;\n\n\t \n\twhile (test_bit(seg ^ 1, buddy->bitmap[order])) {\n\t\tbitmap_clear(buddy->bitmap[order], seg ^ 1, 1);\n\t\t--buddy->num_free[order];\n\t\tseg >>= 1;\n\t\t++order;\n\t}\n\tbitmap_set(buddy->bitmap[order], seg, 1);\n\n\t++buddy->num_free[order];\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}