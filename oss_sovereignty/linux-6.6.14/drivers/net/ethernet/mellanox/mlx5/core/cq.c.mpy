{
  "module_name": "cq.c",
  "hash_id": "d1421eb28321aee194d6b0dd9b5b22c0c10c46f10ddd9bd116e1071c7d912212",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/cq.c",
  "human_readable_source": " \n\n#include <linux/kernel.h>\n#include <linux/hardirq.h>\n#include <linux/mlx5/driver.h>\n#include <rdma/ib_verbs.h>\n#include <linux/mlx5/cq.h>\n#include \"mlx5_core.h\"\n#include \"lib/eq.h\"\n\n#define TASKLET_MAX_TIME 2\n#define TASKLET_MAX_TIME_JIFFIES msecs_to_jiffies(TASKLET_MAX_TIME)\n\nvoid mlx5_cq_tasklet_cb(struct tasklet_struct *t)\n{\n\tunsigned long flags;\n\tunsigned long end = jiffies + TASKLET_MAX_TIME_JIFFIES;\n\tstruct mlx5_eq_tasklet *ctx = from_tasklet(ctx, t, task);\n\tstruct mlx5_core_cq *mcq;\n\tstruct mlx5_core_cq *temp;\n\n\tspin_lock_irqsave(&ctx->lock, flags);\n\tlist_splice_tail_init(&ctx->list, &ctx->process_list);\n\tspin_unlock_irqrestore(&ctx->lock, flags);\n\n\tlist_for_each_entry_safe(mcq, temp, &ctx->process_list,\n\t\t\t\t tasklet_ctx.list) {\n\t\tlist_del_init(&mcq->tasklet_ctx.list);\n\t\tmcq->tasklet_ctx.comp(mcq, NULL);\n\t\tmlx5_cq_put(mcq);\n\t\tif (time_after(jiffies, end))\n\t\t\tbreak;\n\t}\n\n\tif (!list_empty(&ctx->process_list))\n\t\ttasklet_schedule(&ctx->task);\n}\n\nstatic void mlx5_add_cq_to_tasklet(struct mlx5_core_cq *cq,\n\t\t\t\t   struct mlx5_eqe *eqe)\n{\n\tunsigned long flags;\n\tstruct mlx5_eq_tasklet *tasklet_ctx = cq->tasklet_ctx.priv;\n\n\tspin_lock_irqsave(&tasklet_ctx->lock, flags);\n\t \n\tif (list_empty_careful(&cq->tasklet_ctx.list)) {\n\t\tmlx5_cq_hold(cq);\n\t\tlist_add_tail(&cq->tasklet_ctx.list, &tasklet_ctx->list);\n\t}\n\tspin_unlock_irqrestore(&tasklet_ctx->lock, flags);\n}\n\n \nint mlx5_create_cq(struct mlx5_core_dev *dev, struct mlx5_core_cq *cq,\n\t\t   u32 *in, int inlen, u32 *out, int outlen)\n{\n\tint eqn = MLX5_GET(cqc, MLX5_ADDR_OF(create_cq_in, in, cq_context),\n\t\t\t   c_eqn_or_apu_element);\n\tu32 din[MLX5_ST_SZ_DW(destroy_cq_in)] = {};\n\tstruct mlx5_eq_comp *eq;\n\tint err;\n\n\teq = mlx5_eqn2comp_eq(dev, eqn);\n\tif (IS_ERR(eq))\n\t\treturn PTR_ERR(eq);\n\n\tmemset(out, 0, outlen);\n\tMLX5_SET(create_cq_in, in, opcode, MLX5_CMD_OP_CREATE_CQ);\n\terr = mlx5_cmd_do(dev, in, inlen, out, outlen);\n\tif (err)\n\t\treturn err;\n\n\tcq->cqn = MLX5_GET(create_cq_out, out, cqn);\n\tcq->cons_index = 0;\n\tcq->arm_sn     = 0;\n\tcq->eq         = eq;\n\tcq->uid = MLX5_GET(create_cq_in, in, uid);\n\trefcount_set(&cq->refcount, 1);\n\tinit_completion(&cq->free);\n\tif (!cq->comp)\n\t\tcq->comp = mlx5_add_cq_to_tasklet;\n\t \n\tcq->tasklet_ctx.priv = &eq->tasklet_ctx;\n\tINIT_LIST_HEAD(&cq->tasklet_ctx.list);\n\n\t \n\terr = mlx5_eq_add_cq(&eq->core, cq);\n\tif (err)\n\t\tgoto err_cmd;\n\n\t \n\terr = mlx5_eq_add_cq(mlx5_get_async_eq(dev), cq);\n\tif (err)\n\t\tgoto err_cq_add;\n\n\tcq->pid = current->pid;\n\terr = mlx5_debug_cq_add(dev, cq);\n\tif (err)\n\t\tmlx5_core_dbg(dev, \"failed adding CP 0x%x to debug file system\\n\",\n\t\t\t      cq->cqn);\n\n\tcq->uar = dev->priv.uar;\n\tcq->irqn = eq->core.irqn;\n\n\treturn 0;\n\nerr_cq_add:\n\tmlx5_eq_del_cq(&eq->core, cq);\nerr_cmd:\n\tMLX5_SET(destroy_cq_in, din, opcode, MLX5_CMD_OP_DESTROY_CQ);\n\tMLX5_SET(destroy_cq_in, din, cqn, cq->cqn);\n\tMLX5_SET(destroy_cq_in, din, uid, cq->uid);\n\tmlx5_cmd_exec_in(dev, destroy_cq, din);\n\treturn err;\n}\nEXPORT_SYMBOL(mlx5_create_cq);\n\n \nint mlx5_core_create_cq(struct mlx5_core_dev *dev, struct mlx5_core_cq *cq,\n\t\t\tu32 *in, int inlen, u32 *out, int outlen)\n{\n\tint err = mlx5_create_cq(dev, cq, in, inlen, out, outlen);\n\n\treturn mlx5_cmd_check(dev, err, in, out);\n}\nEXPORT_SYMBOL(mlx5_core_create_cq);\n\nint mlx5_core_destroy_cq(struct mlx5_core_dev *dev, struct mlx5_core_cq *cq)\n{\n\tu32 in[MLX5_ST_SZ_DW(destroy_cq_in)] = {};\n\tint err;\n\n\tmlx5_debug_cq_remove(dev, cq);\n\n\tmlx5_eq_del_cq(mlx5_get_async_eq(dev), cq);\n\tmlx5_eq_del_cq(&cq->eq->core, cq);\n\n\tMLX5_SET(destroy_cq_in, in, opcode, MLX5_CMD_OP_DESTROY_CQ);\n\tMLX5_SET(destroy_cq_in, in, cqn, cq->cqn);\n\tMLX5_SET(destroy_cq_in, in, uid, cq->uid);\n\terr = mlx5_cmd_exec_in(dev, destroy_cq, in);\n\tif (err)\n\t\treturn err;\n\n\tsynchronize_irq(cq->irqn);\n\tmlx5_cq_put(cq);\n\twait_for_completion(&cq->free);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(mlx5_core_destroy_cq);\n\nint mlx5_core_query_cq(struct mlx5_core_dev *dev, struct mlx5_core_cq *cq,\n\t\t       u32 *out)\n{\n\tu32 in[MLX5_ST_SZ_DW(query_cq_in)] = {};\n\n\tMLX5_SET(query_cq_in, in, opcode, MLX5_CMD_OP_QUERY_CQ);\n\tMLX5_SET(query_cq_in, in, cqn, cq->cqn);\n\treturn mlx5_cmd_exec_inout(dev, query_cq, in, out);\n}\nEXPORT_SYMBOL(mlx5_core_query_cq);\n\nint mlx5_core_modify_cq(struct mlx5_core_dev *dev, struct mlx5_core_cq *cq,\n\t\t\tu32 *in, int inlen)\n{\n\tu32 out[MLX5_ST_SZ_DW(modify_cq_out)] = {};\n\n\tMLX5_SET(modify_cq_in, in, opcode, MLX5_CMD_OP_MODIFY_CQ);\n\tMLX5_SET(modify_cq_in, in, uid, cq->uid);\n\treturn mlx5_cmd_exec(dev, in, inlen, out, sizeof(out));\n}\nEXPORT_SYMBOL(mlx5_core_modify_cq);\n\nint mlx5_core_modify_cq_moderation(struct mlx5_core_dev *dev,\n\t\t\t\t   struct mlx5_core_cq *cq,\n\t\t\t\t   u16 cq_period,\n\t\t\t\t   u16 cq_max_count)\n{\n\tu32 in[MLX5_ST_SZ_DW(modify_cq_in)] = {};\n\tvoid *cqc;\n\n\tMLX5_SET(modify_cq_in, in, cqn, cq->cqn);\n\tcqc = MLX5_ADDR_OF(modify_cq_in, in, cq_context);\n\tMLX5_SET(cqc, cqc, cq_period, cq_period);\n\tMLX5_SET(cqc, cqc, cq_max_count, cq_max_count);\n\tMLX5_SET(modify_cq_in, in,\n\t\t modify_field_select_resize_field_select.modify_field_select.modify_field_select,\n\t\t MLX5_CQ_MODIFY_PERIOD | MLX5_CQ_MODIFY_COUNT);\n\n\treturn mlx5_core_modify_cq(dev, cq, in, sizeof(in));\n}\nEXPORT_SYMBOL(mlx5_core_modify_cq_moderation);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}