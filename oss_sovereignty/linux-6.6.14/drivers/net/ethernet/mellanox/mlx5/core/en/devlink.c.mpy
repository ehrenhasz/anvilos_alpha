{
  "module_name": "devlink.c",
  "hash_id": "ed21a450bf4183443d7287b7312eb607f055498b3551488e13a1cc72fe59ccdc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/en/devlink.c",
  "human_readable_source": "\n \n\n#include \"en/devlink.h\"\n#include \"eswitch.h\"\n\nstatic const struct devlink_ops mlx5e_devlink_ops = {\n};\n\nstruct mlx5e_dev *mlx5e_create_devlink(struct device *dev,\n\t\t\t\t       struct mlx5_core_dev *mdev)\n{\n\tstruct mlx5e_dev *mlx5e_dev;\n\tstruct devlink *devlink;\n\n\tdevlink = devlink_alloc_ns(&mlx5e_devlink_ops, sizeof(*mlx5e_dev),\n\t\t\t\t   devlink_net(priv_to_devlink(mdev)), dev);\n\tif (!devlink)\n\t\treturn ERR_PTR(-ENOMEM);\n\tdevlink_register(devlink);\n\treturn devlink_priv(devlink);\n}\n\nvoid mlx5e_destroy_devlink(struct mlx5e_dev *mlx5e_dev)\n{\n\tstruct devlink *devlink = priv_to_devlink(mlx5e_dev);\n\n\tdevlink_unregister(devlink);\n\tdevlink_free(devlink);\n}\n\nstatic void\nmlx5e_devlink_get_port_parent_id(struct mlx5_core_dev *dev, struct netdev_phys_item_id *ppid)\n{\n\tu64 parent_id;\n\n\tparent_id = mlx5_query_nic_system_image_guid(dev);\n\tppid->id_len = sizeof(parent_id);\n\tmemcpy(ppid->id, &parent_id, sizeof(parent_id));\n}\n\nint mlx5e_devlink_port_register(struct mlx5e_dev *mlx5e_dev,\n\t\t\t\tstruct mlx5_core_dev *mdev)\n{\n\tstruct devlink *devlink = priv_to_devlink(mlx5e_dev);\n\tstruct devlink_port_attrs attrs = {};\n\tstruct netdev_phys_item_id ppid = {};\n\tunsigned int dl_port_index;\n\n\tif (mlx5_core_is_pf(mdev)) {\n\t\tattrs.flavour = DEVLINK_PORT_FLAVOUR_PHYSICAL;\n\t\tattrs.phys.port_number = mlx5_get_dev_index(mdev);\n\t\tif (MLX5_ESWITCH_MANAGER(mdev)) {\n\t\t\tmlx5e_devlink_get_port_parent_id(mdev, &ppid);\n\t\t\tmemcpy(attrs.switch_id.id, ppid.id, ppid.id_len);\n\t\t\tattrs.switch_id.id_len = ppid.id_len;\n\t\t}\n\t\tdl_port_index = mlx5_esw_vport_to_devlink_port_index(mdev,\n\t\t\t\t\t\t\t\t     MLX5_VPORT_UPLINK);\n\t} else {\n\t\tattrs.flavour = DEVLINK_PORT_FLAVOUR_VIRTUAL;\n\t\tdl_port_index = mlx5_esw_vport_to_devlink_port_index(mdev, 0);\n\t}\n\n\tdevlink_port_attrs_set(&mlx5e_dev->dl_port, &attrs);\n\n\treturn devlink_port_register(devlink, &mlx5e_dev->dl_port,\n\t\t\t\t     dl_port_index);\n}\n\nvoid mlx5e_devlink_port_unregister(struct mlx5e_dev *mlx5e_dev)\n{\n\tdevlink_port_unregister(&mlx5e_dev->dl_port);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}