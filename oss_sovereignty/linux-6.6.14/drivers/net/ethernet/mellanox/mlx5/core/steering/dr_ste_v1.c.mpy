{
  "module_name": "dr_ste_v1.c",
  "hash_id": "bf274a2268bef01eeb6674aa133de298f6a46f271965ad3e57f910e0c17d609b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_ste_v1.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include \"mlx5_ifc_dr_ste_v1.h\"\n#include \"dr_ste_v1.h\"\n\n#define DR_STE_CALC_DFNR_TYPE(lookup_type, inner) \\\n\t((inner) ? DR_STE_V1_LU_TYPE_##lookup_type##_I : \\\n\t\t   DR_STE_V1_LU_TYPE_##lookup_type##_O)\n\nenum dr_ste_v1_entry_format {\n\tDR_STE_V1_TYPE_BWC_BYTE\t= 0x0,\n\tDR_STE_V1_TYPE_BWC_DW\t= 0x1,\n\tDR_STE_V1_TYPE_MATCH\t= 0x2,\n\tDR_STE_V1_TYPE_MATCH_RANGES = 0x7,\n};\n\n \nenum {\n\tDR_STE_V1_LU_TYPE_NOP\t\t\t\t= 0x0000,\n\tDR_STE_V1_LU_TYPE_ETHL2_TNL\t\t\t= 0x0002,\n\tDR_STE_V1_LU_TYPE_IBL3_EXT\t\t\t= 0x0102,\n\tDR_STE_V1_LU_TYPE_ETHL2_O\t\t\t= 0x0003,\n\tDR_STE_V1_LU_TYPE_IBL4\t\t\t\t= 0x0103,\n\tDR_STE_V1_LU_TYPE_ETHL2_I\t\t\t= 0x0004,\n\tDR_STE_V1_LU_TYPE_SRC_QP_GVMI\t\t\t= 0x0104,\n\tDR_STE_V1_LU_TYPE_ETHL2_SRC_O\t\t\t= 0x0005,\n\tDR_STE_V1_LU_TYPE_ETHL2_HEADERS_O\t\t= 0x0105,\n\tDR_STE_V1_LU_TYPE_ETHL2_SRC_I\t\t\t= 0x0006,\n\tDR_STE_V1_LU_TYPE_ETHL2_HEADERS_I\t\t= 0x0106,\n\tDR_STE_V1_LU_TYPE_ETHL3_IPV4_5_TUPLE_O\t\t= 0x0007,\n\tDR_STE_V1_LU_TYPE_IPV6_DES_O\t\t\t= 0x0107,\n\tDR_STE_V1_LU_TYPE_ETHL3_IPV4_5_TUPLE_I\t\t= 0x0008,\n\tDR_STE_V1_LU_TYPE_IPV6_DES_I\t\t\t= 0x0108,\n\tDR_STE_V1_LU_TYPE_ETHL4_O\t\t\t= 0x0009,\n\tDR_STE_V1_LU_TYPE_IPV6_SRC_O\t\t\t= 0x0109,\n\tDR_STE_V1_LU_TYPE_ETHL4_I\t\t\t= 0x000a,\n\tDR_STE_V1_LU_TYPE_IPV6_SRC_I\t\t\t= 0x010a,\n\tDR_STE_V1_LU_TYPE_ETHL2_SRC_DST_O\t\t= 0x000b,\n\tDR_STE_V1_LU_TYPE_MPLS_O\t\t\t= 0x010b,\n\tDR_STE_V1_LU_TYPE_ETHL2_SRC_DST_I\t\t= 0x000c,\n\tDR_STE_V1_LU_TYPE_MPLS_I\t\t\t= 0x010c,\n\tDR_STE_V1_LU_TYPE_ETHL3_IPV4_MISC_O\t\t= 0x000d,\n\tDR_STE_V1_LU_TYPE_GRE\t\t\t\t= 0x010d,\n\tDR_STE_V1_LU_TYPE_FLEX_PARSER_TNL_HEADER\t= 0x000e,\n\tDR_STE_V1_LU_TYPE_GENERAL_PURPOSE\t\t= 0x010e,\n\tDR_STE_V1_LU_TYPE_ETHL3_IPV4_MISC_I\t\t= 0x000f,\n\tDR_STE_V1_LU_TYPE_STEERING_REGISTERS_0\t\t= 0x010f,\n\tDR_STE_V1_LU_TYPE_STEERING_REGISTERS_1\t\t= 0x0110,\n\tDR_STE_V1_LU_TYPE_FLEX_PARSER_OK\t\t= 0x0011,\n\tDR_STE_V1_LU_TYPE_FLEX_PARSER_0\t\t\t= 0x0111,\n\tDR_STE_V1_LU_TYPE_FLEX_PARSER_1\t\t\t= 0x0112,\n\tDR_STE_V1_LU_TYPE_ETHL4_MISC_O\t\t\t= 0x0113,\n\tDR_STE_V1_LU_TYPE_ETHL4_MISC_I\t\t\t= 0x0114,\n\tDR_STE_V1_LU_TYPE_INVALID\t\t\t= 0x00ff,\n\tDR_STE_V1_LU_TYPE_DONT_CARE\t\t\t= MLX5DR_STE_LU_TYPE_DONT_CARE,\n};\n\nenum dr_ste_v1_header_anchors {\n\tDR_STE_HEADER_ANCHOR_START_OUTER\t\t= 0x00,\n\tDR_STE_HEADER_ANCHOR_1ST_VLAN\t\t\t= 0x02,\n\tDR_STE_HEADER_ANCHOR_IPV6_IPV4\t\t\t= 0x07,\n\tDR_STE_HEADER_ANCHOR_INNER_MAC\t\t\t= 0x13,\n\tDR_STE_HEADER_ANCHOR_INNER_IPV6_IPV4\t\t= 0x19,\n};\n\nenum dr_ste_v1_action_size {\n\tDR_STE_ACTION_SINGLE_SZ = 4,\n\tDR_STE_ACTION_DOUBLE_SZ = 8,\n\tDR_STE_ACTION_TRIPLE_SZ = 12,\n};\n\nenum dr_ste_v1_action_insert_ptr_attr {\n\tDR_STE_V1_ACTION_INSERT_PTR_ATTR_NONE = 0,   \n\tDR_STE_V1_ACTION_INSERT_PTR_ATTR_ENCAP = 1,  \n\tDR_STE_V1_ACTION_INSERT_PTR_ATTR_ESP = 2,    \n};\n\nenum dr_ste_v1_action_id {\n\tDR_STE_V1_ACTION_ID_NOP\t\t\t\t= 0x00,\n\tDR_STE_V1_ACTION_ID_COPY\t\t\t= 0x05,\n\tDR_STE_V1_ACTION_ID_SET\t\t\t\t= 0x06,\n\tDR_STE_V1_ACTION_ID_ADD\t\t\t\t= 0x07,\n\tDR_STE_V1_ACTION_ID_REMOVE_BY_SIZE\t\t= 0x08,\n\tDR_STE_V1_ACTION_ID_REMOVE_HEADER_TO_HEADER\t= 0x09,\n\tDR_STE_V1_ACTION_ID_INSERT_INLINE\t\t= 0x0a,\n\tDR_STE_V1_ACTION_ID_INSERT_POINTER\t\t= 0x0b,\n\tDR_STE_V1_ACTION_ID_FLOW_TAG\t\t\t= 0x0c,\n\tDR_STE_V1_ACTION_ID_QUEUE_ID_SEL\t\t= 0x0d,\n\tDR_STE_V1_ACTION_ID_ACCELERATED_LIST\t\t= 0x0e,\n\tDR_STE_V1_ACTION_ID_MODIFY_LIST\t\t\t= 0x0f,\n\tDR_STE_V1_ACTION_ID_ASO\t\t\t\t= 0x12,\n\tDR_STE_V1_ACTION_ID_TRAILER\t\t\t= 0x13,\n\tDR_STE_V1_ACTION_ID_COUNTER_ID\t\t\t= 0x14,\n\tDR_STE_V1_ACTION_ID_MAX\t\t\t\t= 0x21,\n\t \n\tDR_STE_V1_ACTION_ID_SPECIAL_ENCAP_L3\t\t= 0x22,\n};\n\nenum {\n\tDR_STE_V1_ACTION_MDFY_FLD_L2_OUT_0\t\t= 0x00,\n\tDR_STE_V1_ACTION_MDFY_FLD_L2_OUT_1\t\t= 0x01,\n\tDR_STE_V1_ACTION_MDFY_FLD_L2_OUT_2\t\t= 0x02,\n\tDR_STE_V1_ACTION_MDFY_FLD_SRC_L2_OUT_0\t\t= 0x08,\n\tDR_STE_V1_ACTION_MDFY_FLD_SRC_L2_OUT_1\t\t= 0x09,\n\tDR_STE_V1_ACTION_MDFY_FLD_L3_OUT_0\t\t= 0x0e,\n\tDR_STE_V1_ACTION_MDFY_FLD_L4_OUT_0\t\t= 0x18,\n\tDR_STE_V1_ACTION_MDFY_FLD_L4_OUT_1\t\t= 0x19,\n\tDR_STE_V1_ACTION_MDFY_FLD_IPV4_OUT_0\t\t= 0x40,\n\tDR_STE_V1_ACTION_MDFY_FLD_IPV4_OUT_1\t\t= 0x41,\n\tDR_STE_V1_ACTION_MDFY_FLD_IPV6_DST_OUT_0\t= 0x44,\n\tDR_STE_V1_ACTION_MDFY_FLD_IPV6_DST_OUT_1\t= 0x45,\n\tDR_STE_V1_ACTION_MDFY_FLD_IPV6_DST_OUT_2\t= 0x46,\n\tDR_STE_V1_ACTION_MDFY_FLD_IPV6_DST_OUT_3\t= 0x47,\n\tDR_STE_V1_ACTION_MDFY_FLD_IPV6_SRC_OUT_0\t= 0x4c,\n\tDR_STE_V1_ACTION_MDFY_FLD_IPV6_SRC_OUT_1\t= 0x4d,\n\tDR_STE_V1_ACTION_MDFY_FLD_IPV6_SRC_OUT_2\t= 0x4e,\n\tDR_STE_V1_ACTION_MDFY_FLD_IPV6_SRC_OUT_3\t= 0x4f,\n\tDR_STE_V1_ACTION_MDFY_FLD_TCP_MISC_0\t\t= 0x5e,\n\tDR_STE_V1_ACTION_MDFY_FLD_TCP_MISC_1\t\t= 0x5f,\n\tDR_STE_V1_ACTION_MDFY_FLD_CFG_HDR_0_0\t\t= 0x6f,\n\tDR_STE_V1_ACTION_MDFY_FLD_CFG_HDR_0_1\t\t= 0x70,\n\tDR_STE_V1_ACTION_MDFY_FLD_METADATA_2_CQE\t= 0x7b,\n\tDR_STE_V1_ACTION_MDFY_FLD_GNRL_PURPOSE\t\t= 0x7c,\n\tDR_STE_V1_ACTION_MDFY_FLD_REGISTER_2_0\t\t= 0x8c,\n\tDR_STE_V1_ACTION_MDFY_FLD_REGISTER_2_1\t\t= 0x8d,\n\tDR_STE_V1_ACTION_MDFY_FLD_REGISTER_1_0\t\t= 0x8e,\n\tDR_STE_V1_ACTION_MDFY_FLD_REGISTER_1_1\t\t= 0x8f,\n\tDR_STE_V1_ACTION_MDFY_FLD_REGISTER_0_0\t\t= 0x90,\n\tDR_STE_V1_ACTION_MDFY_FLD_REGISTER_0_1\t\t= 0x91,\n};\n\nenum dr_ste_v1_aso_ctx_type {\n\tDR_STE_V1_ASO_CTX_TYPE_POLICERS = 0x2,\n};\n\nstatic const struct mlx5dr_ste_action_modify_field dr_ste_v1_action_modify_field_arr[] = {\n\t[MLX5_ACTION_IN_FIELD_OUT_SMAC_47_16] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_SRC_L2_OUT_0, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SMAC_15_0] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_SRC_L2_OUT_1, .start = 16, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_ETHERTYPE] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L2_OUT_1, .start = 0, .end = 15,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DMAC_47_16] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L2_OUT_0, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DMAC_15_0] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L2_OUT_1, .start = 16, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_IP_DSCP] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L3_OUT_0, .start = 18, .end = 23,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_TCP_FLAGS] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L4_OUT_1, .start = 16, .end = 24,\n\t\t.l4_type = DR_STE_ACTION_MDFY_TYPE_L4_TCP,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_TCP_SPORT] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L4_OUT_0, .start = 16, .end = 31,\n\t\t.l4_type = DR_STE_ACTION_MDFY_TYPE_L4_TCP,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_TCP_DPORT] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L4_OUT_0, .start = 0, .end = 15,\n\t\t.l4_type = DR_STE_ACTION_MDFY_TYPE_L4_TCP,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_IP_TTL] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L3_OUT_0, .start = 8, .end = 15,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV4,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_IPV6_HOPLIMIT] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L3_OUT_0, .start = 8, .end = 15,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_UDP_SPORT] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L4_OUT_0, .start = 16, .end = 31,\n\t\t.l4_type = DR_STE_ACTION_MDFY_TYPE_L4_UDP,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_UDP_DPORT] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L4_OUT_0, .start = 0, .end = 15,\n\t\t.l4_type = DR_STE_ACTION_MDFY_TYPE_L4_UDP,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SIPV6_127_96] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_IPV6_SRC_OUT_0, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SIPV6_95_64] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_IPV6_SRC_OUT_1, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SIPV6_63_32] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_IPV6_SRC_OUT_2, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SIPV6_31_0] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_IPV6_SRC_OUT_3, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DIPV6_127_96] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_IPV6_DST_OUT_0, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DIPV6_95_64] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_IPV6_DST_OUT_1, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DIPV6_63_32] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_IPV6_DST_OUT_2, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DIPV6_31_0] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_IPV6_DST_OUT_3, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SIPV4] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_IPV4_OUT_0, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV4,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DIPV4] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_IPV4_OUT_1, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV4,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_A] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_GNRL_PURPOSE, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_B] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_METADATA_2_CQE, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_0] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_REGISTER_0_0, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_1] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_REGISTER_0_1, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_2] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_REGISTER_1_0, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_3] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_REGISTER_1_1, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_4] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_REGISTER_2_0, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_5] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_REGISTER_2_1, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_TCP_SEQ_NUM] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_TCP_MISC_0, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_TCP_ACK_NUM] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_TCP_MISC_1, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_FIRST_VID] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_L2_OUT_2, .start = 0, .end = 15,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_EMD_31_0] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_CFG_HDR_0_1, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_EMD_47_32] = {\n\t\t.hw_field = DR_STE_V1_ACTION_MDFY_FLD_CFG_HDR_0_0, .start = 0, .end = 15,\n\t},\n};\n\nstatic void dr_ste_v1_set_entry_type(u8 *hw_ste_p, u8 entry_type)\n{\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, entry_format, entry_type);\n}\n\nbool dr_ste_v1_is_miss_addr_set(u8 *hw_ste_p)\n{\n\tu8 entry_type = MLX5_GET(ste_match_bwc_v1, hw_ste_p, entry_format);\n\n\t \n\treturn entry_type == DR_STE_V1_TYPE_MATCH_RANGES;\n}\n\nvoid dr_ste_v1_set_miss_addr(u8 *hw_ste_p, u64 miss_addr)\n{\n\tu64 index = miss_addr >> 6;\n\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, miss_address_39_32, index >> 26);\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, miss_address_31_6, index);\n}\n\nu64 dr_ste_v1_get_miss_addr(u8 *hw_ste_p)\n{\n\tu64 index =\n\t\t((u64)MLX5_GET(ste_match_bwc_v1, hw_ste_p, miss_address_31_6) |\n\t\t ((u64)MLX5_GET(ste_match_bwc_v1, hw_ste_p, miss_address_39_32)) << 26);\n\n\treturn index << 6;\n}\n\nvoid dr_ste_v1_set_byte_mask(u8 *hw_ste_p, u16 byte_mask)\n{\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, byte_mask, byte_mask);\n}\n\nu16 dr_ste_v1_get_byte_mask(u8 *hw_ste_p)\n{\n\treturn MLX5_GET(ste_match_bwc_v1, hw_ste_p, byte_mask);\n}\n\nstatic void dr_ste_v1_set_lu_type(u8 *hw_ste_p, u16 lu_type)\n{\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, entry_format, lu_type >> 8);\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, match_definer_ctx_idx, lu_type & 0xFF);\n}\n\nvoid dr_ste_v1_set_next_lu_type(u8 *hw_ste_p, u16 lu_type)\n{\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, next_entry_format, lu_type >> 8);\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, hash_definer_ctx_idx, lu_type & 0xFF);\n}\n\nu16 dr_ste_v1_get_next_lu_type(u8 *hw_ste_p)\n{\n\tu8 mode = MLX5_GET(ste_match_bwc_v1, hw_ste_p, next_entry_format);\n\tu8 index = MLX5_GET(ste_match_bwc_v1, hw_ste_p, hash_definer_ctx_idx);\n\n\treturn (mode << 8 | index);\n}\n\nstatic void dr_ste_v1_set_hit_gvmi(u8 *hw_ste_p, u16 gvmi)\n{\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, next_table_base_63_48, gvmi);\n}\n\nvoid dr_ste_v1_set_hit_addr(u8 *hw_ste_p, u64 icm_addr, u32 ht_size)\n{\n\tu64 index = (icm_addr >> 5) | ht_size;\n\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, next_table_base_39_32_size, index >> 27);\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, next_table_base_31_5_size, index);\n}\n\nvoid dr_ste_v1_init(u8 *hw_ste_p, u16 lu_type, bool is_rx, u16 gvmi)\n{\n\tdr_ste_v1_set_lu_type(hw_ste_p, lu_type);\n\tdr_ste_v1_set_next_lu_type(hw_ste_p, MLX5DR_STE_LU_TYPE_DONT_CARE);\n\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, gvmi, gvmi);\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, next_table_base_63_48, gvmi);\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, miss_address_63_48, gvmi);\n}\n\nvoid dr_ste_v1_prepare_for_postsend(u8 *hw_ste_p, u32 ste_size)\n{\n\tu8 *tag = hw_ste_p + DR_STE_SIZE_CTRL;\n\tu8 *mask = tag + DR_STE_SIZE_TAG;\n\tu8 tmp_tag[DR_STE_SIZE_TAG] = {};\n\n\tif (ste_size == DR_STE_SIZE_CTRL)\n\t\treturn;\n\n\tWARN_ON(ste_size != DR_STE_SIZE);\n\n\t \n\tmemcpy(tmp_tag, tag, DR_STE_SIZE_TAG);\n\n\t \n\tmemcpy(tag, mask, DR_STE_SIZE_MASK);\n\tmemcpy(mask, tmp_tag, DR_STE_SIZE_TAG);\n}\n\nstatic void dr_ste_v1_set_rx_flow_tag(u8 *s_action, u32 flow_tag)\n{\n\tMLX5_SET(ste_single_action_flow_tag_v1, s_action, action_id,\n\t\t DR_STE_V1_ACTION_ID_FLOW_TAG);\n\tMLX5_SET(ste_single_action_flow_tag_v1, s_action, flow_tag, flow_tag);\n}\n\nstatic void dr_ste_v1_set_counter_id(u8 *hw_ste_p, u32 ctr_id)\n{\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, counter_id, ctr_id);\n}\n\nstatic void dr_ste_v1_set_reparse(u8 *hw_ste_p)\n{\n\tMLX5_SET(ste_match_bwc_v1, hw_ste_p, reparse, 1);\n}\n\nstatic void dr_ste_v1_set_encap(u8 *hw_ste_p, u8 *d_action,\n\t\t\t\tu32 reformat_id, int size)\n{\n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, d_action, action_id,\n\t\t DR_STE_V1_ACTION_ID_INSERT_POINTER);\n\t \n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, d_action, size, size / 2);\n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, d_action, pointer, reformat_id);\n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, d_action, attributes,\n\t\t DR_STE_V1_ACTION_INSERT_PTR_ATTR_ENCAP);\n\tdr_ste_v1_set_reparse(hw_ste_p);\n}\n\nstatic void dr_ste_v1_set_insert_hdr(u8 *hw_ste_p, u8 *d_action,\n\t\t\t\t     u32 reformat_id,\n\t\t\t\t     u8 anchor, u8 offset,\n\t\t\t\t     int size)\n{\n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, d_action,\n\t\t action_id, DR_STE_V1_ACTION_ID_INSERT_POINTER);\n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, d_action, start_anchor, anchor);\n\n\t \n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, d_action, size, size / 2);\n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, d_action, start_offset, offset / 2);\n\n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, d_action, pointer, reformat_id);\n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, d_action, attributes,\n\t\t DR_STE_V1_ACTION_INSERT_PTR_ATTR_NONE);\n\n\tdr_ste_v1_set_reparse(hw_ste_p);\n}\n\nstatic void dr_ste_v1_set_remove_hdr(u8 *hw_ste_p, u8 *s_action,\n\t\t\t\t     u8 anchor, u8 offset,\n\t\t\t\t     int size)\n{\n\tMLX5_SET(ste_single_action_remove_header_size_v1, s_action,\n\t\t action_id, DR_STE_V1_ACTION_ID_REMOVE_BY_SIZE);\n\tMLX5_SET(ste_single_action_remove_header_size_v1, s_action, start_anchor, anchor);\n\n\t \n\tMLX5_SET(ste_single_action_remove_header_size_v1, s_action, remove_size, size / 2);\n\tMLX5_SET(ste_single_action_remove_header_size_v1, s_action, start_offset, offset / 2);\n\n\tdr_ste_v1_set_reparse(hw_ste_p);\n}\n\nstatic void dr_ste_v1_set_push_vlan(u8 *hw_ste_p, u8 *d_action,\n\t\t\t\t    u32 vlan_hdr)\n{\n\tMLX5_SET(ste_double_action_insert_with_inline_v1, d_action,\n\t\t action_id, DR_STE_V1_ACTION_ID_INSERT_INLINE);\n\t \n\tMLX5_SET(ste_double_action_insert_with_inline_v1, d_action,\n\t\t start_offset, HDR_LEN_L2_MACS >> 1);\n\tMLX5_SET(ste_double_action_insert_with_inline_v1, d_action,\n\t\t inline_data, vlan_hdr);\n\n\tdr_ste_v1_set_reparse(hw_ste_p);\n}\n\nstatic void dr_ste_v1_set_pop_vlan(u8 *hw_ste_p, u8 *s_action, u8 vlans_num)\n{\n\tMLX5_SET(ste_single_action_remove_header_size_v1, s_action,\n\t\t action_id, DR_STE_V1_ACTION_ID_REMOVE_BY_SIZE);\n\tMLX5_SET(ste_single_action_remove_header_size_v1, s_action,\n\t\t start_anchor, DR_STE_HEADER_ANCHOR_1ST_VLAN);\n\t \n\tMLX5_SET(ste_single_action_remove_header_size_v1, s_action,\n\t\t remove_size, (HDR_LEN_L2_VLAN >> 1) * vlans_num);\n\n\tdr_ste_v1_set_reparse(hw_ste_p);\n}\n\nstatic void dr_ste_v1_set_encap_l3(u8 *hw_ste_p,\n\t\t\t\t   u8 *frst_s_action,\n\t\t\t\t   u8 *scnd_d_action,\n\t\t\t\t   u32 reformat_id,\n\t\t\t\t   int size)\n{\n\t \n\tMLX5_SET(ste_single_action_remove_header_v1, frst_s_action, action_id,\n\t\t DR_STE_V1_ACTION_ID_REMOVE_HEADER_TO_HEADER);\n\tMLX5_SET(ste_single_action_remove_header_v1, frst_s_action, end_anchor,\n\t\t DR_STE_HEADER_ANCHOR_IPV6_IPV4);\n\n\t \n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, scnd_d_action, action_id,\n\t\t DR_STE_V1_ACTION_ID_INSERT_POINTER);\n\t \n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, scnd_d_action, size, size / 2);\n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, scnd_d_action, pointer, reformat_id);\n\tMLX5_SET(ste_double_action_insert_with_ptr_v1, scnd_d_action, attributes,\n\t\t DR_STE_V1_ACTION_INSERT_PTR_ATTR_ENCAP);\n\n\tdr_ste_v1_set_reparse(hw_ste_p);\n}\n\nstatic void dr_ste_v1_set_rx_decap(u8 *hw_ste_p, u8 *s_action)\n{\n\tMLX5_SET(ste_single_action_remove_header_v1, s_action, action_id,\n\t\t DR_STE_V1_ACTION_ID_REMOVE_HEADER_TO_HEADER);\n\tMLX5_SET(ste_single_action_remove_header_v1, s_action, decap, 1);\n\tMLX5_SET(ste_single_action_remove_header_v1, s_action, vni_to_cqe, 1);\n\tMLX5_SET(ste_single_action_remove_header_v1, s_action, end_anchor,\n\t\t DR_STE_HEADER_ANCHOR_INNER_MAC);\n\n\tdr_ste_v1_set_reparse(hw_ste_p);\n}\n\nstatic void dr_ste_v1_set_accelerated_rewrite_actions(u8 *hw_ste_p,\n\t\t\t\t\t\t      u8 *d_action,\n\t\t\t\t\t\t      u16 num_of_actions,\n\t\t\t\t\t\t      u32 rewrite_pattern,\n\t\t\t\t\t\t      u32 rewrite_args,\n\t\t\t\t\t\t      u8 *action_data)\n{\n\tif (action_data) {\n\t\tmemcpy(d_action, action_data, DR_MODIFY_ACTION_SIZE);\n\t} else {\n\t\tMLX5_SET(ste_double_action_accelerated_modify_action_list_v1, d_action,\n\t\t\t action_id, DR_STE_V1_ACTION_ID_ACCELERATED_LIST);\n\t\tMLX5_SET(ste_double_action_accelerated_modify_action_list_v1, d_action,\n\t\t\t modify_actions_pattern_pointer, rewrite_pattern);\n\t\tMLX5_SET(ste_double_action_accelerated_modify_action_list_v1, d_action,\n\t\t\t number_of_modify_actions, num_of_actions);\n\t\tMLX5_SET(ste_double_action_accelerated_modify_action_list_v1, d_action,\n\t\t\t modify_actions_argument_pointer, rewrite_args);\n\t}\n\n\tdr_ste_v1_set_reparse(hw_ste_p);\n}\n\nstatic void dr_ste_v1_set_basic_rewrite_actions(u8 *hw_ste_p,\n\t\t\t\t\t\tu8 *s_action,\n\t\t\t\t\t\tu16 num_of_actions,\n\t\t\t\t\t\tu32 rewrite_index)\n{\n\tMLX5_SET(ste_single_action_modify_list_v1, s_action, action_id,\n\t\t DR_STE_V1_ACTION_ID_MODIFY_LIST);\n\tMLX5_SET(ste_single_action_modify_list_v1, s_action, num_of_modify_actions,\n\t\t num_of_actions);\n\tMLX5_SET(ste_single_action_modify_list_v1, s_action, modify_actions_ptr,\n\t\t rewrite_index);\n\n\tdr_ste_v1_set_reparse(hw_ste_p);\n}\n\nstatic void dr_ste_v1_set_rewrite_actions(u8 *hw_ste_p,\n\t\t\t\t\t  u8 *action,\n\t\t\t\t\t  u16 num_of_actions,\n\t\t\t\t\t  u32 rewrite_pattern,\n\t\t\t\t\t  u32 rewrite_args,\n\t\t\t\t\t  u8 *action_data)\n{\n\tif (rewrite_pattern != MLX5DR_INVALID_PATTERN_INDEX)\n\t\treturn dr_ste_v1_set_accelerated_rewrite_actions(hw_ste_p,\n\t\t\t\t\t\t\t\t action,\n\t\t\t\t\t\t\t\t num_of_actions,\n\t\t\t\t\t\t\t\t rewrite_pattern,\n\t\t\t\t\t\t\t\t rewrite_args,\n\t\t\t\t\t\t\t\t action_data);\n\n\t \n\treturn dr_ste_v1_set_basic_rewrite_actions(hw_ste_p,\n\t\t\t\t\t\t   action,\n\t\t\t\t\t\t   num_of_actions,\n\t\t\t\t\t\t   rewrite_args);\n}\n\nstatic void dr_ste_v1_set_aso_flow_meter(u8 *d_action,\n\t\t\t\t\t u32 object_id,\n\t\t\t\t\t u32 offset,\n\t\t\t\t\t u8 dest_reg_id,\n\t\t\t\t\t u8 init_color)\n{\n\tMLX5_SET(ste_double_action_aso_v1, d_action, action_id,\n\t\t DR_STE_V1_ACTION_ID_ASO);\n\tMLX5_SET(ste_double_action_aso_v1, d_action, aso_context_number,\n\t\t object_id + (offset / MLX5DR_ASO_FLOW_METER_NUM_PER_OBJ));\n\t \n\tMLX5_SET(ste_double_action_aso_v1, d_action, dest_reg_id,\n\t\t (dest_reg_id - 1) / 2);\n\tMLX5_SET(ste_double_action_aso_v1, d_action, aso_context_type,\n\t\t DR_STE_V1_ASO_CTX_TYPE_POLICERS);\n\tMLX5_SET(ste_double_action_aso_v1, d_action, flow_meter.line_id,\n\t\t offset % MLX5DR_ASO_FLOW_METER_NUM_PER_OBJ);\n\tMLX5_SET(ste_double_action_aso_v1, d_action, flow_meter.initial_color,\n\t\t init_color);\n}\n\nstatic void dr_ste_v1_set_match_range_pkt_len(u8 *hw_ste_p, u32 definer_id,\n\t\t\t\t\t      u32 min, u32 max)\n{\n\tMLX5_SET(ste_match_ranges_v1, hw_ste_p, match_definer_ctx_idx, definer_id);\n\n\t \n\tMLX5_SET(ste_match_ranges_v1, hw_ste_p, min_value_0, min << 16);\n\tMLX5_SET(ste_match_ranges_v1, hw_ste_p, max_value_0, max << 16);\n}\n\nstatic void dr_ste_v1_arr_init_next_match(u8 **last_ste,\n\t\t\t\t\t  u32 *added_stes,\n\t\t\t\t\t  u16 gvmi)\n{\n\tu8 *action;\n\n\t(*added_stes)++;\n\t*last_ste += DR_STE_SIZE;\n\tdr_ste_v1_init(*last_ste, MLX5DR_STE_LU_TYPE_DONT_CARE, 0, gvmi);\n\tdr_ste_v1_set_entry_type(*last_ste, DR_STE_V1_TYPE_MATCH);\n\n\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, *last_ste, action);\n\tmemset(action, 0, MLX5_FLD_SZ_BYTES(ste_mask_and_match_v1, action));\n}\n\nstatic void dr_ste_v1_arr_init_next_match_range(u8 **last_ste,\n\t\t\t\t\t\tu32 *added_stes,\n\t\t\t\t\t\tu16 gvmi)\n{\n\tdr_ste_v1_arr_init_next_match(last_ste, added_stes, gvmi);\n\tdr_ste_v1_set_entry_type(*last_ste, DR_STE_V1_TYPE_MATCH_RANGES);\n}\n\nvoid dr_ste_v1_set_actions_tx(struct mlx5dr_domain *dmn,\n\t\t\t      u8 *action_type_set,\n\t\t\t      u32 actions_caps,\n\t\t\t      u8 *last_ste,\n\t\t\t      struct mlx5dr_ste_actions_attr *attr,\n\t\t\t      u32 *added_stes)\n{\n\tu8 *action = MLX5_ADDR_OF(ste_match_bwc_v1, last_ste, action);\n\tu8 action_sz = DR_STE_ACTION_DOUBLE_SZ;\n\tbool allow_modify_hdr = true;\n\tbool allow_encap = true;\n\n\tif (action_type_set[DR_ACTION_TYP_POP_VLAN]) {\n\t\tif (action_sz < DR_STE_ACTION_SINGLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes,\n\t\t\t\t\t\t      attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1,\n\t\t\t\t\t      last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\t\tdr_ste_v1_set_pop_vlan(last_ste, action, attr->vlans.count);\n\t\taction_sz -= DR_STE_ACTION_SINGLE_SZ;\n\t\taction += DR_STE_ACTION_SINGLE_SZ;\n\n\t\t \n\t\tif (!(actions_caps & DR_STE_CTX_ACTION_CAP_POP_MDFY))\n\t\t\tallow_modify_hdr = false;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_MODIFY_HDR]) {\n\t\tif (!allow_modify_hdr || action_sz < DR_STE_ACTION_DOUBLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes,\n\t\t\t\t\t\t      attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1,\n\t\t\t\t\t      last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\t\tdr_ste_v1_set_rewrite_actions(last_ste, action,\n\t\t\t\t\t      attr->modify_actions,\n\t\t\t\t\t      attr->modify_pat_idx,\n\t\t\t\t\t      attr->modify_index,\n\t\t\t\t\t      attr->single_modify_action);\n\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t\tallow_encap = false;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_PUSH_VLAN]) {\n\t\tint i;\n\n\t\tfor (i = 0; i < attr->vlans.count; i++) {\n\t\t\tif (action_sz < DR_STE_ACTION_DOUBLE_SZ || !allow_encap) {\n\t\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t\t\tallow_encap = true;\n\t\t\t}\n\t\t\tdr_ste_v1_set_push_vlan(last_ste, action,\n\t\t\t\t\t\tattr->vlans.headers[i]);\n\t\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t\t}\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_L2_TO_TNL_L2]) {\n\t\tif (!allow_encap || action_sz < DR_STE_ACTION_DOUBLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t\tallow_encap = true;\n\t\t}\n\t\tdr_ste_v1_set_encap(last_ste, action,\n\t\t\t\t    attr->reformat.id,\n\t\t\t\t    attr->reformat.size);\n\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t} else if (action_type_set[DR_ACTION_TYP_L2_TO_TNL_L3]) {\n\t\tu8 *d_action;\n\n\t\tif (action_sz < DR_STE_ACTION_TRIPLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\t\td_action = action + DR_STE_ACTION_SINGLE_SZ;\n\n\t\tdr_ste_v1_set_encap_l3(last_ste,\n\t\t\t\t       action, d_action,\n\t\t\t\t       attr->reformat.id,\n\t\t\t\t       attr->reformat.size);\n\t\taction_sz -= DR_STE_ACTION_TRIPLE_SZ;\n\t\taction += DR_STE_ACTION_TRIPLE_SZ;\n\t} else if (action_type_set[DR_ACTION_TYP_INSERT_HDR]) {\n\t\tif (!allow_encap || action_sz < DR_STE_ACTION_DOUBLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\t\tdr_ste_v1_set_insert_hdr(last_ste, action,\n\t\t\t\t\t attr->reformat.id,\n\t\t\t\t\t attr->reformat.param_0,\n\t\t\t\t\t attr->reformat.param_1,\n\t\t\t\t\t attr->reformat.size);\n\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t} else if (action_type_set[DR_ACTION_TYP_REMOVE_HDR]) {\n\t\tif (action_sz < DR_STE_ACTION_SINGLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\t\tdr_ste_v1_set_remove_hdr(last_ste, action,\n\t\t\t\t\t attr->reformat.param_0,\n\t\t\t\t\t attr->reformat.param_1,\n\t\t\t\t\t attr->reformat.size);\n\t\taction_sz -= DR_STE_ACTION_SINGLE_SZ;\n\t\taction += DR_STE_ACTION_SINGLE_SZ;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_ASO_FLOW_METER]) {\n\t\tif (action_sz < DR_STE_ACTION_DOUBLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\t\tdr_ste_v1_set_aso_flow_meter(action,\n\t\t\t\t\t     attr->aso_flow_meter.obj_id,\n\t\t\t\t\t     attr->aso_flow_meter.offset,\n\t\t\t\t\t     attr->aso_flow_meter.dest_reg_id,\n\t\t\t\t\t     attr->aso_flow_meter.init_color);\n\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_RANGE]) {\n\t\t \n\t\tdr_ste_v1_arr_init_next_match_range(&last_ste, added_stes, attr->gvmi);\n\t\tdr_ste_v1_set_miss_addr(last_ste, attr->range.miss_icm_addr);\n\n\t\t \n\t\taction_sz = 0;\n\n\t\tdr_ste_v1_set_match_range_pkt_len(last_ste,\n\t\t\t\t\t\t  attr->range.definer_id,\n\t\t\t\t\t\t  attr->range.min,\n\t\t\t\t\t\t  attr->range.max);\n\t}\n\n\t \n\tif (action_type_set[DR_ACTION_TYP_CTR])\n\t\tdr_ste_v1_set_counter_id(last_ste, attr->ctr_id);\n\n\tdr_ste_v1_set_hit_gvmi(last_ste, attr->hit_gvmi);\n\tdr_ste_v1_set_hit_addr(last_ste, attr->final_icm_addr, 1);\n}\n\nvoid dr_ste_v1_set_actions_rx(struct mlx5dr_domain *dmn,\n\t\t\t      u8 *action_type_set,\n\t\t\t      u32 actions_caps,\n\t\t\t      u8 *last_ste,\n\t\t\t      struct mlx5dr_ste_actions_attr *attr,\n\t\t\t      u32 *added_stes)\n{\n\tu8 *action = MLX5_ADDR_OF(ste_match_bwc_v1, last_ste, action);\n\tu8 action_sz = DR_STE_ACTION_DOUBLE_SZ;\n\tbool allow_modify_hdr = true;\n\tbool allow_ctr = true;\n\n\tif (action_type_set[DR_ACTION_TYP_TNL_L3_TO_L2]) {\n\t\tdr_ste_v1_set_rewrite_actions(last_ste, action,\n\t\t\t\t\t      attr->decap_actions,\n\t\t\t\t\t      attr->decap_pat_idx,\n\t\t\t\t\t      attr->decap_index,\n\t\t\t\t\t      NULL);\n\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t\tallow_modify_hdr = false;\n\t\tallow_ctr = false;\n\t} else if (action_type_set[DR_ACTION_TYP_TNL_L2_TO_L2]) {\n\t\tdr_ste_v1_set_rx_decap(last_ste, action);\n\t\taction_sz -= DR_STE_ACTION_SINGLE_SZ;\n\t\taction += DR_STE_ACTION_SINGLE_SZ;\n\t\tallow_modify_hdr = false;\n\t\tallow_ctr = false;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_TAG]) {\n\t\tif (action_sz < DR_STE_ACTION_SINGLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t\tallow_modify_hdr = true;\n\t\t\tallow_ctr = true;\n\t\t}\n\t\tdr_ste_v1_set_rx_flow_tag(action, attr->flow_tag);\n\t\taction_sz -= DR_STE_ACTION_SINGLE_SZ;\n\t\taction += DR_STE_ACTION_SINGLE_SZ;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_POP_VLAN]) {\n\t\tif (action_sz < DR_STE_ACTION_SINGLE_SZ ||\n\t\t    !allow_modify_hdr) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\n\t\tdr_ste_v1_set_pop_vlan(last_ste, action, attr->vlans.count);\n\t\taction_sz -= DR_STE_ACTION_SINGLE_SZ;\n\t\taction += DR_STE_ACTION_SINGLE_SZ;\n\t\tallow_ctr = false;\n\n\t\t \n\t\tif (!(actions_caps & DR_STE_CTX_ACTION_CAP_POP_MDFY))\n\t\t\tallow_modify_hdr = false;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_MODIFY_HDR]) {\n\t\t \n\t\tif (!allow_modify_hdr || action_sz < DR_STE_ACTION_DOUBLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t\tallow_modify_hdr = true;\n\t\t\tallow_ctr = true;\n\t\t}\n\t\tdr_ste_v1_set_rewrite_actions(last_ste, action,\n\t\t\t\t\t      attr->modify_actions,\n\t\t\t\t\t      attr->modify_pat_idx,\n\t\t\t\t\t      attr->modify_index,\n\t\t\t\t\t      attr->single_modify_action);\n\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_PUSH_VLAN]) {\n\t\tint i;\n\n\t\tfor (i = 0; i < attr->vlans.count; i++) {\n\t\t\tif (action_sz < DR_STE_ACTION_DOUBLE_SZ ||\n\t\t\t    !allow_modify_hdr) {\n\t\t\t\tdr_ste_v1_arr_init_next_match(&last_ste,\n\t\t\t\t\t\t\t      added_stes,\n\t\t\t\t\t\t\t      attr->gvmi);\n\t\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1,\n\t\t\t\t\t\t      last_ste, action);\n\t\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t\t}\n\t\t\tdr_ste_v1_set_push_vlan(last_ste, action,\n\t\t\t\t\t\tattr->vlans.headers[i]);\n\t\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t\t}\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_CTR]) {\n\t\t \n\t\tif (!allow_ctr) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t\tallow_modify_hdr = true;\n\t\t}\n\t\tdr_ste_v1_set_counter_id(last_ste, attr->ctr_id);\n\t\tallow_ctr = false;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_L2_TO_TNL_L2]) {\n\t\tif (action_sz < DR_STE_ACTION_DOUBLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\t\tdr_ste_v1_set_encap(last_ste, action,\n\t\t\t\t    attr->reformat.id,\n\t\t\t\t    attr->reformat.size);\n\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t\tallow_modify_hdr = false;\n\t} else if (action_type_set[DR_ACTION_TYP_L2_TO_TNL_L3]) {\n\t\tu8 *d_action;\n\n\t\tif (action_sz < DR_STE_ACTION_TRIPLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\n\t\td_action = action + DR_STE_ACTION_SINGLE_SZ;\n\n\t\tdr_ste_v1_set_encap_l3(last_ste,\n\t\t\t\t       action, d_action,\n\t\t\t\t       attr->reformat.id,\n\t\t\t\t       attr->reformat.size);\n\t\taction_sz -= DR_STE_ACTION_TRIPLE_SZ;\n\t\tallow_modify_hdr = false;\n\t} else if (action_type_set[DR_ACTION_TYP_INSERT_HDR]) {\n\t\t \n\t\tif (!allow_modify_hdr || action_sz < DR_STE_ACTION_DOUBLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\t\tdr_ste_v1_set_insert_hdr(last_ste, action,\n\t\t\t\t\t attr->reformat.id,\n\t\t\t\t\t attr->reformat.param_0,\n\t\t\t\t\t attr->reformat.param_1,\n\t\t\t\t\t attr->reformat.size);\n\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t\tallow_modify_hdr = false;\n\t} else if (action_type_set[DR_ACTION_TYP_REMOVE_HDR]) {\n\t\tif (action_sz < DR_STE_ACTION_SINGLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t\tallow_modify_hdr = true;\n\t\t\tallow_ctr = true;\n\t\t}\n\t\tdr_ste_v1_set_remove_hdr(last_ste, action,\n\t\t\t\t\t attr->reformat.param_0,\n\t\t\t\t\t attr->reformat.param_1,\n\t\t\t\t\t attr->reformat.size);\n\t\taction_sz -= DR_STE_ACTION_SINGLE_SZ;\n\t\taction += DR_STE_ACTION_SINGLE_SZ;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_ASO_FLOW_METER]) {\n\t\tif (action_sz < DR_STE_ACTION_DOUBLE_SZ) {\n\t\t\tdr_ste_v1_arr_init_next_match(&last_ste, added_stes, attr->gvmi);\n\t\t\taction = MLX5_ADDR_OF(ste_mask_and_match_v1, last_ste, action);\n\t\t\taction_sz = DR_STE_ACTION_TRIPLE_SZ;\n\t\t}\n\t\tdr_ste_v1_set_aso_flow_meter(action,\n\t\t\t\t\t     attr->aso_flow_meter.obj_id,\n\t\t\t\t\t     attr->aso_flow_meter.offset,\n\t\t\t\t\t     attr->aso_flow_meter.dest_reg_id,\n\t\t\t\t\t     attr->aso_flow_meter.init_color);\n\t\taction_sz -= DR_STE_ACTION_DOUBLE_SZ;\n\t\taction += DR_STE_ACTION_DOUBLE_SZ;\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_RANGE]) {\n\t\t \n\t\tdr_ste_v1_arr_init_next_match_range(&last_ste, added_stes, attr->gvmi);\n\t\tdr_ste_v1_set_miss_addr(last_ste, attr->range.miss_icm_addr);\n\n\t\t \n\t\taction_sz = 0;\n\n\t\tdr_ste_v1_set_match_range_pkt_len(last_ste,\n\t\t\t\t\t\t  attr->range.definer_id,\n\t\t\t\t\t\t  attr->range.min,\n\t\t\t\t\t\t  attr->range.max);\n\t}\n\n\tdr_ste_v1_set_hit_gvmi(last_ste, attr->hit_gvmi);\n\tdr_ste_v1_set_hit_addr(last_ste, attr->final_icm_addr, 1);\n}\n\nvoid dr_ste_v1_set_action_set(u8 *d_action,\n\t\t\t      u8 hw_field,\n\t\t\t      u8 shifter,\n\t\t\t      u8 length,\n\t\t\t      u32 data)\n{\n\tshifter += MLX5_MODIFY_HEADER_V1_QW_OFFSET;\n\tMLX5_SET(ste_double_action_set_v1, d_action, action_id, DR_STE_V1_ACTION_ID_SET);\n\tMLX5_SET(ste_double_action_set_v1, d_action, destination_dw_offset, hw_field);\n\tMLX5_SET(ste_double_action_set_v1, d_action, destination_left_shifter, shifter);\n\tMLX5_SET(ste_double_action_set_v1, d_action, destination_length, length);\n\tMLX5_SET(ste_double_action_set_v1, d_action, inline_data, data);\n}\n\nvoid dr_ste_v1_set_action_add(u8 *d_action,\n\t\t\t      u8 hw_field,\n\t\t\t      u8 shifter,\n\t\t\t      u8 length,\n\t\t\t      u32 data)\n{\n\tshifter += MLX5_MODIFY_HEADER_V1_QW_OFFSET;\n\tMLX5_SET(ste_double_action_add_v1, d_action, action_id, DR_STE_V1_ACTION_ID_ADD);\n\tMLX5_SET(ste_double_action_add_v1, d_action, destination_dw_offset, hw_field);\n\tMLX5_SET(ste_double_action_add_v1, d_action, destination_left_shifter, shifter);\n\tMLX5_SET(ste_double_action_add_v1, d_action, destination_length, length);\n\tMLX5_SET(ste_double_action_add_v1, d_action, add_value, data);\n}\n\nvoid dr_ste_v1_set_action_copy(u8 *d_action,\n\t\t\t       u8 dst_hw_field,\n\t\t\t       u8 dst_shifter,\n\t\t\t       u8 dst_len,\n\t\t\t       u8 src_hw_field,\n\t\t\t       u8 src_shifter)\n{\n\tdst_shifter += MLX5_MODIFY_HEADER_V1_QW_OFFSET;\n\tsrc_shifter += MLX5_MODIFY_HEADER_V1_QW_OFFSET;\n\tMLX5_SET(ste_double_action_copy_v1, d_action, action_id, DR_STE_V1_ACTION_ID_COPY);\n\tMLX5_SET(ste_double_action_copy_v1, d_action, destination_dw_offset, dst_hw_field);\n\tMLX5_SET(ste_double_action_copy_v1, d_action, destination_left_shifter, dst_shifter);\n\tMLX5_SET(ste_double_action_copy_v1, d_action, destination_length, dst_len);\n\tMLX5_SET(ste_double_action_copy_v1, d_action, source_dw_offset, src_hw_field);\n\tMLX5_SET(ste_double_action_copy_v1, d_action, source_right_shifter, src_shifter);\n}\n\n#define DR_STE_DECAP_L3_ACTION_NUM\t8\n#define DR_STE_L2_HDR_MAX_SZ\t\t20\n\nint dr_ste_v1_set_action_decap_l3_list(void *data,\n\t\t\t\t       u32 data_sz,\n\t\t\t\t       u8 *hw_action,\n\t\t\t\t       u32 hw_action_sz,\n\t\t\t\t       u16 *used_hw_action_num)\n{\n\tu8 padded_data[DR_STE_L2_HDR_MAX_SZ] = {};\n\tvoid *data_ptr = padded_data;\n\tu16 used_actions = 0;\n\tu32 inline_data_sz;\n\tu32 i;\n\n\tif (hw_action_sz / DR_STE_ACTION_DOUBLE_SZ < DR_STE_DECAP_L3_ACTION_NUM)\n\t\treturn -EINVAL;\n\n\tinline_data_sz =\n\t\tMLX5_FLD_SZ_BYTES(ste_double_action_insert_with_inline_v1, inline_data);\n\n\t \n\tmemcpy(padded_data + data_sz % inline_data_sz, data, data_sz);\n\n\t \n\tMLX5_SET(ste_single_action_remove_header_v1, hw_action, action_id,\n\t\t DR_STE_V1_ACTION_ID_REMOVE_HEADER_TO_HEADER);\n\tMLX5_SET(ste_single_action_remove_header_v1, hw_action, decap, 1);\n\tMLX5_SET(ste_single_action_remove_header_v1, hw_action, vni_to_cqe, 1);\n\tMLX5_SET(ste_single_action_remove_header_v1, hw_action, end_anchor,\n\t\t DR_STE_HEADER_ANCHOR_INNER_IPV6_IPV4);\n\thw_action += DR_STE_ACTION_DOUBLE_SZ;\n\tused_actions++;  \n\n\t \n\tdata_ptr += (data_sz / inline_data_sz) * inline_data_sz;\n\n\t \n\tfor (i = 0; i < data_sz / inline_data_sz + 1; i++) {\n\t\tvoid *addr_inline;\n\n\t\tMLX5_SET(ste_double_action_insert_with_inline_v1, hw_action, action_id,\n\t\t\t DR_STE_V1_ACTION_ID_INSERT_INLINE);\n\t\t \n\t\tMLX5_SET(ste_double_action_insert_with_inline_v1, hw_action, start_offset, 0);\n\n\t\t \n\t\taddr_inline = MLX5_ADDR_OF(ste_double_action_insert_with_inline_v1,\n\t\t\t\t\t   hw_action, inline_data);\n\t\tmemcpy(addr_inline, data_ptr - i * inline_data_sz, inline_data_sz);\n\t\thw_action += DR_STE_ACTION_DOUBLE_SZ;\n\t\tused_actions++;\n\t}\n\n\t \n\tMLX5_SET(ste_single_action_remove_header_size_v1, hw_action, action_id,\n\t\t DR_STE_V1_ACTION_ID_REMOVE_BY_SIZE);\n\tMLX5_SET(ste_single_action_remove_header_size_v1, hw_action, start_offset, 0);\n\t \n\tMLX5_SET(ste_single_action_remove_header_size_v1, hw_action, remove_size, 1);\n\tused_actions++;\n\n\t*used_hw_action_num = used_actions;\n\n\treturn 0;\n}\n\nstatic void dr_ste_v1_build_eth_l2_src_dst_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t    bool inner, u8 *bit_mask)\n{\n\tstruct mlx5dr_match_spec *mask = inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, bit_mask, dmac_47_16, mask, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, bit_mask, dmac_15_0, mask, dmac_15_0);\n\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, bit_mask, smac_47_16, mask, smac_47_16);\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, bit_mask, smac_15_0, mask, smac_15_0);\n\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, bit_mask, first_vlan_id, mask, first_vid);\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, bit_mask, first_cfi, mask, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, bit_mask, first_priority, mask, first_prio);\n\tDR_STE_SET_ONES(eth_l2_src_dst_v1, bit_mask, l3_type, mask, ip_version);\n\n\tif (mask->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_dst_v1, bit_mask, first_vlan_qualifier, -1);\n\t\tmask->cvlan_tag = 0;\n\t} else if (mask->svlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_dst_v1, bit_mask, first_vlan_qualifier, -1);\n\t\tmask->svlan_tag = 0;\n\t}\n}\n\nstatic int dr_ste_v1_build_eth_l2_src_dst_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t\t      u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, tag, dmac_47_16, spec, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, tag, dmac_15_0, spec, dmac_15_0);\n\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, tag, smac_47_16, spec, smac_47_16);\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, tag, smac_15_0, spec, smac_15_0);\n\n\tif (spec->ip_version == IP_VERSION_IPV4) {\n\t\tMLX5_SET(ste_eth_l2_src_dst_v1, tag, l3_type, STE_IPV4);\n\t\tspec->ip_version = 0;\n\t} else if (spec->ip_version == IP_VERSION_IPV6) {\n\t\tMLX5_SET(ste_eth_l2_src_dst_v1, tag, l3_type, STE_IPV6);\n\t\tspec->ip_version = 0;\n\t} else if (spec->ip_version) {\n\t\treturn -EINVAL;\n\t}\n\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, tag, first_vlan_id, spec, first_vid);\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, tag, first_cfi, spec, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_src_dst_v1, tag, first_priority, spec, first_prio);\n\n\tif (spec->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_dst_v1, tag, first_vlan_qualifier, DR_STE_CVLAN);\n\t\tspec->cvlan_tag = 0;\n\t} else if (spec->svlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_dst_v1, tag, first_vlan_qualifier, DR_STE_SVLAN);\n\t\tspec->svlan_tag = 0;\n\t}\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_eth_l2_src_dst_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_eth_l2_src_dst_bit_mask(mask, sb->inner, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_DFNR_TYPE(ETHL2_SRC_DST, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_eth_l2_src_dst_tag;\n}\n\nstatic int dr_ste_v1_build_eth_l3_ipv6_dst_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t\t\t       u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l3_ipv6_dst, tag, dst_ip_127_96, spec, dst_ip_127_96);\n\tDR_STE_SET_TAG(eth_l3_ipv6_dst, tag, dst_ip_95_64, spec, dst_ip_95_64);\n\tDR_STE_SET_TAG(eth_l3_ipv6_dst, tag, dst_ip_63_32, spec, dst_ip_63_32);\n\tDR_STE_SET_TAG(eth_l3_ipv6_dst, tag, dst_ip_31_0, spec, dst_ip_31_0);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_eth_l3_ipv6_dst_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t  struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_eth_l3_ipv6_dst_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_DFNR_TYPE(IPV6_DES, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_eth_l3_ipv6_dst_tag;\n}\n\nstatic int dr_ste_v1_build_eth_l3_ipv6_src_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t\t\t       u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l3_ipv6_src, tag, src_ip_127_96, spec, src_ip_127_96);\n\tDR_STE_SET_TAG(eth_l3_ipv6_src, tag, src_ip_95_64, spec, src_ip_95_64);\n\tDR_STE_SET_TAG(eth_l3_ipv6_src, tag, src_ip_63_32, spec, src_ip_63_32);\n\tDR_STE_SET_TAG(eth_l3_ipv6_src, tag, src_ip_31_0, spec, src_ip_31_0);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_eth_l3_ipv6_src_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t  struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_eth_l3_ipv6_src_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_DFNR_TYPE(IPV6_SRC, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_eth_l3_ipv6_src_tag;\n}\n\nstatic int dr_ste_v1_build_eth_l3_ipv4_5_tuple_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t   u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple_v1, tag, destination_address, spec, dst_ip_31_0);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple_v1, tag, source_address, spec, src_ip_31_0);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple_v1, tag, destination_port, spec, tcp_dport);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple_v1, tag, destination_port, spec, udp_dport);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple_v1, tag, source_port, spec, tcp_sport);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple_v1, tag, source_port, spec, udp_sport);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple_v1, tag, protocol, spec, ip_protocol);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple_v1, tag, fragmented, spec, frag);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple_v1, tag, dscp, spec, ip_dscp);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple_v1, tag, ecn, spec, ip_ecn);\n\n\tif (spec->tcp_flags) {\n\t\tDR_STE_SET_TCP_FLAGS(eth_l3_ipv4_5_tuple_v1, tag, spec);\n\t\tspec->tcp_flags = 0;\n\t}\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_eth_l3_ipv4_5_tuple_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t      struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_eth_l3_ipv4_5_tuple_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_DFNR_TYPE(ETHL3_IPV4_5_TUPLE, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_eth_l3_ipv4_5_tuple_tag;\n}\n\nstatic void dr_ste_v1_build_eth_l2_src_or_dst_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t       bool inner, u8 *bit_mask)\n{\n\tstruct mlx5dr_match_spec *mask = inner ? &value->inner : &value->outer;\n\tstruct mlx5dr_match_misc *misc_mask = &value->misc;\n\n\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask, first_vlan_id, mask, first_vid);\n\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask, first_cfi, mask, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask, first_priority, mask, first_prio);\n\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask, ip_fragmented, mask, frag);\n\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask, l3_ethertype, mask, ethertype);\n\tDR_STE_SET_ONES(eth_l2_src_v1, bit_mask, l3_type, mask, ip_version);\n\n\tif (mask->svlan_tag || mask->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_v1, bit_mask, first_vlan_qualifier, -1);\n\t\tmask->cvlan_tag = 0;\n\t\tmask->svlan_tag = 0;\n\t}\n\n\tif (inner) {\n\t\tif (misc_mask->inner_second_cvlan_tag ||\n\t\t    misc_mask->inner_second_svlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src_v1, bit_mask, second_vlan_qualifier, -1);\n\t\t\tmisc_mask->inner_second_cvlan_tag = 0;\n\t\t\tmisc_mask->inner_second_svlan_tag = 0;\n\t\t}\n\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask,\n\t\t\t       second_vlan_id, misc_mask, inner_second_vid);\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask,\n\t\t\t       second_cfi, misc_mask, inner_second_cfi);\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask,\n\t\t\t       second_priority, misc_mask, inner_second_prio);\n\t} else {\n\t\tif (misc_mask->outer_second_cvlan_tag ||\n\t\t    misc_mask->outer_second_svlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src_v1, bit_mask, second_vlan_qualifier, -1);\n\t\t\tmisc_mask->outer_second_cvlan_tag = 0;\n\t\t\tmisc_mask->outer_second_svlan_tag = 0;\n\t\t}\n\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask,\n\t\t\t       second_vlan_id, misc_mask, outer_second_vid);\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask,\n\t\t\t       second_cfi, misc_mask, outer_second_cfi);\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask,\n\t\t\t       second_priority, misc_mask, outer_second_prio);\n\t}\n}\n\nstatic int dr_ste_v1_build_eth_l2_src_or_dst_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t bool inner, u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = inner ? &value->inner : &value->outer;\n\tstruct mlx5dr_match_misc *misc_spec = &value->misc;\n\n\tDR_STE_SET_TAG(eth_l2_src_v1, tag, first_vlan_id, spec, first_vid);\n\tDR_STE_SET_TAG(eth_l2_src_v1, tag, first_cfi, spec, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_src_v1, tag, first_priority, spec, first_prio);\n\tDR_STE_SET_TAG(eth_l2_src_v1, tag, ip_fragmented, spec, frag);\n\tDR_STE_SET_TAG(eth_l2_src_v1, tag, l3_ethertype, spec, ethertype);\n\n\tif (spec->ip_version == IP_VERSION_IPV4) {\n\t\tMLX5_SET(ste_eth_l2_src_v1, tag, l3_type, STE_IPV4);\n\t\tspec->ip_version = 0;\n\t} else if (spec->ip_version == IP_VERSION_IPV6) {\n\t\tMLX5_SET(ste_eth_l2_src_v1, tag, l3_type, STE_IPV6);\n\t\tspec->ip_version = 0;\n\t} else if (spec->ip_version) {\n\t\treturn -EINVAL;\n\t}\n\n\tif (spec->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_v1, tag, first_vlan_qualifier, DR_STE_CVLAN);\n\t\tspec->cvlan_tag = 0;\n\t} else if (spec->svlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_v1, tag, first_vlan_qualifier, DR_STE_SVLAN);\n\t\tspec->svlan_tag = 0;\n\t}\n\n\tif (inner) {\n\t\tif (misc_spec->inner_second_cvlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src_v1, tag, second_vlan_qualifier, DR_STE_CVLAN);\n\t\t\tmisc_spec->inner_second_cvlan_tag = 0;\n\t\t} else if (misc_spec->inner_second_svlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src_v1, tag, second_vlan_qualifier, DR_STE_SVLAN);\n\t\t\tmisc_spec->inner_second_svlan_tag = 0;\n\t\t}\n\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, tag, second_vlan_id, misc_spec, inner_second_vid);\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, tag, second_cfi, misc_spec, inner_second_cfi);\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, tag, second_priority, misc_spec, inner_second_prio);\n\t} else {\n\t\tif (misc_spec->outer_second_cvlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src_v1, tag, second_vlan_qualifier, DR_STE_CVLAN);\n\t\t\tmisc_spec->outer_second_cvlan_tag = 0;\n\t\t} else if (misc_spec->outer_second_svlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src_v1, tag, second_vlan_qualifier, DR_STE_SVLAN);\n\t\t\tmisc_spec->outer_second_svlan_tag = 0;\n\t\t}\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, tag, second_vlan_id, misc_spec, outer_second_vid);\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, tag, second_cfi, misc_spec, outer_second_cfi);\n\t\tDR_STE_SET_TAG(eth_l2_src_v1, tag, second_priority, misc_spec, outer_second_prio);\n\t}\n\n\treturn 0;\n}\n\nstatic void dr_ste_v1_build_eth_l2_src_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t\t\tbool inner, u8 *bit_mask)\n{\n\tstruct mlx5dr_match_spec *mask = inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask, smac_47_16, mask, smac_47_16);\n\tDR_STE_SET_TAG(eth_l2_src_v1, bit_mask, smac_15_0, mask, smac_15_0);\n\n\tdr_ste_v1_build_eth_l2_src_or_dst_bit_mask(value, inner, bit_mask);\n}\n\nstatic int dr_ste_v1_build_eth_l2_src_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t  struct mlx5dr_ste_build *sb,\n\t\t\t\t\t  u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_src_v1, tag, smac_47_16, spec, smac_47_16);\n\tDR_STE_SET_TAG(eth_l2_src_v1, tag, smac_15_0, spec, smac_15_0);\n\n\treturn dr_ste_v1_build_eth_l2_src_or_dst_tag(value, sb->inner, tag);\n}\n\nvoid dr_ste_v1_build_eth_l2_src_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t     struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_eth_l2_src_bit_mask(mask, sb->inner, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_DFNR_TYPE(ETHL2_SRC, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_eth_l2_src_tag;\n}\n\nstatic void dr_ste_v1_build_eth_l2_dst_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t\t\tbool inner, u8 *bit_mask)\n{\n\tstruct mlx5dr_match_spec *mask = inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_dst_v1, bit_mask, dmac_47_16, mask, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_dst_v1, bit_mask, dmac_15_0, mask, dmac_15_0);\n\n\tdr_ste_v1_build_eth_l2_src_or_dst_bit_mask(value, inner, bit_mask);\n}\n\nstatic int dr_ste_v1_build_eth_l2_dst_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t  struct mlx5dr_ste_build *sb,\n\t\t\t\t\t  u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_dst_v1, tag, dmac_47_16, spec, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_dst_v1, tag, dmac_15_0, spec, dmac_15_0);\n\n\treturn dr_ste_v1_build_eth_l2_src_or_dst_tag(value, sb->inner, tag);\n}\n\nvoid dr_ste_v1_build_eth_l2_dst_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t     struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_eth_l2_dst_bit_mask(mask, sb->inner, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_DFNR_TYPE(ETHL2, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_eth_l2_dst_tag;\n}\n\nstatic void dr_ste_v1_build_eth_l2_tnl_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t\t\tbool inner, u8 *bit_mask)\n{\n\tstruct mlx5dr_match_spec *mask = inner ? &value->inner : &value->outer;\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, bit_mask, dmac_47_16, mask, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, bit_mask, dmac_15_0, mask, dmac_15_0);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, bit_mask, first_vlan_id, mask, first_vid);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, bit_mask, first_cfi, mask, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, bit_mask, first_priority, mask, first_prio);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, bit_mask, ip_fragmented, mask, frag);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, bit_mask, l3_ethertype, mask, ethertype);\n\tDR_STE_SET_ONES(eth_l2_tnl_v1, bit_mask, l3_type, mask, ip_version);\n\n\tif (misc->vxlan_vni) {\n\t\tMLX5_SET(ste_eth_l2_tnl_v1, bit_mask,\n\t\t\t l2_tunneling_network_id, (misc->vxlan_vni << 8));\n\t\tmisc->vxlan_vni = 0;\n\t}\n\n\tif (mask->svlan_tag || mask->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_tnl_v1, bit_mask, first_vlan_qualifier, -1);\n\t\tmask->cvlan_tag = 0;\n\t\tmask->svlan_tag = 0;\n\t}\n}\n\nstatic int dr_ste_v1_build_eth_l2_tnl_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t  struct mlx5dr_ste_build *sb,\n\t\t\t\t\t  u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, tag, dmac_47_16, spec, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, tag, dmac_15_0, spec, dmac_15_0);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, tag, first_vlan_id, spec, first_vid);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, tag, first_cfi, spec, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, tag, ip_fragmented, spec, frag);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, tag, first_priority, spec, first_prio);\n\tDR_STE_SET_TAG(eth_l2_tnl_v1, tag, l3_ethertype, spec, ethertype);\n\n\tif (misc->vxlan_vni) {\n\t\tMLX5_SET(ste_eth_l2_tnl_v1, tag, l2_tunneling_network_id,\n\t\t\t (misc->vxlan_vni << 8));\n\t\tmisc->vxlan_vni = 0;\n\t}\n\n\tif (spec->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_tnl_v1, tag, first_vlan_qualifier, DR_STE_CVLAN);\n\t\tspec->cvlan_tag = 0;\n\t} else if (spec->svlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_tnl_v1, tag, first_vlan_qualifier, DR_STE_SVLAN);\n\t\tspec->svlan_tag = 0;\n\t}\n\n\tif (spec->ip_version == IP_VERSION_IPV4) {\n\t\tMLX5_SET(ste_eth_l2_tnl_v1, tag, l3_type, STE_IPV4);\n\t\tspec->ip_version = 0;\n\t} else if (spec->ip_version == IP_VERSION_IPV6) {\n\t\tMLX5_SET(ste_eth_l2_tnl_v1, tag, l3_type, STE_IPV6);\n\t\tspec->ip_version = 0;\n\t} else if (spec->ip_version) {\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_eth_l2_tnl_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t     struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_eth_l2_tnl_bit_mask(mask, sb->inner, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_ETHL2_TNL;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_eth_l2_tnl_tag;\n}\n\nstatic int dr_ste_v1_build_eth_l3_ipv4_misc_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t\tstruct mlx5dr_ste_build *sb,\n\t\t\t\t\t\tu8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l3_ipv4_misc_v1, tag, time_to_live, spec, ttl_hoplimit);\n\tDR_STE_SET_TAG(eth_l3_ipv4_misc_v1, tag, ihl, spec, ipv4_ihl);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_eth_l3_ipv4_misc_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t   struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_eth_l3_ipv4_misc_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_DFNR_TYPE(ETHL3_IPV4_MISC, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_eth_l3_ipv4_misc_tag;\n}\n\nstatic int dr_ste_v1_build_eth_ipv6_l3_l4_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t\t      u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\n\tDR_STE_SET_TAG(eth_l4_v1, tag, dst_port, spec, tcp_dport);\n\tDR_STE_SET_TAG(eth_l4_v1, tag, src_port, spec, tcp_sport);\n\tDR_STE_SET_TAG(eth_l4_v1, tag, dst_port, spec, udp_dport);\n\tDR_STE_SET_TAG(eth_l4_v1, tag, src_port, spec, udp_sport);\n\tDR_STE_SET_TAG(eth_l4_v1, tag, protocol, spec, ip_protocol);\n\tDR_STE_SET_TAG(eth_l4_v1, tag, fragmented, spec, frag);\n\tDR_STE_SET_TAG(eth_l4_v1, tag, dscp, spec, ip_dscp);\n\tDR_STE_SET_TAG(eth_l4_v1, tag, ecn, spec, ip_ecn);\n\tDR_STE_SET_TAG(eth_l4_v1, tag, ipv6_hop_limit, spec, ttl_hoplimit);\n\n\tif (sb->inner)\n\t\tDR_STE_SET_TAG(eth_l4_v1, tag, flow_label, misc, inner_ipv6_flow_label);\n\telse\n\t\tDR_STE_SET_TAG(eth_l4_v1, tag, flow_label, misc, outer_ipv6_flow_label);\n\n\tif (spec->tcp_flags) {\n\t\tDR_STE_SET_TCP_FLAGS(eth_l4_v1, tag, spec);\n\t\tspec->tcp_flags = 0;\n\t}\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_eth_ipv6_l3_l4_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_eth_ipv6_l3_l4_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_DFNR_TYPE(ETHL4, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_eth_ipv6_l3_l4_tag;\n}\n\nstatic int dr_ste_v1_build_mpls_tag(struct mlx5dr_match_param *value,\n\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t    u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\n\tif (sb->inner)\n\t\tDR_STE_SET_MPLS(mpls_v1, misc2, inner, tag);\n\telse\n\t\tDR_STE_SET_MPLS(mpls_v1, misc2, outer, tag);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_mpls_init(struct mlx5dr_ste_build *sb,\n\t\t\t       struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_mpls_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_DFNR_TYPE(MPLS, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_mpls_tag;\n}\n\nstatic int dr_ste_v1_build_tnl_gre_tag(struct mlx5dr_match_param *value,\n\t\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t\t       u8 *tag)\n{\n\tstruct  mlx5dr_match_misc *misc = &value->misc;\n\n\tDR_STE_SET_TAG(gre_v1, tag, gre_protocol, misc, gre_protocol);\n\tDR_STE_SET_TAG(gre_v1, tag, gre_k_present, misc, gre_k_present);\n\tDR_STE_SET_TAG(gre_v1, tag, gre_key_h, misc, gre_key_h);\n\tDR_STE_SET_TAG(gre_v1, tag, gre_key_l, misc, gre_key_l);\n\n\tDR_STE_SET_TAG(gre_v1, tag, gre_c_present, misc, gre_c_present);\n\tDR_STE_SET_TAG(gre_v1, tag, gre_s_present, misc, gre_s_present);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_tnl_gre_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t  struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_tnl_gre_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_GRE;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_tnl_gre_tag;\n}\n\nstatic int dr_ste_v1_build_tnl_mpls_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\tstruct mlx5dr_ste_build *sb,\n\t\t\t\t\tu8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\n\tif (DR_STE_IS_OUTER_MPLS_OVER_GRE_SET(misc2)) {\n\t\tDR_STE_SET_TAG(mpls_v1, tag, mpls0_label,\n\t\t\t       misc2, outer_first_mpls_over_gre_label);\n\n\t\tDR_STE_SET_TAG(mpls_v1, tag, mpls0_exp,\n\t\t\t       misc2, outer_first_mpls_over_gre_exp);\n\n\t\tDR_STE_SET_TAG(mpls_v1, tag, mpls0_s_bos,\n\t\t\t       misc2, outer_first_mpls_over_gre_s_bos);\n\n\t\tDR_STE_SET_TAG(mpls_v1, tag, mpls0_ttl,\n\t\t\t       misc2, outer_first_mpls_over_gre_ttl);\n\t} else {\n\t\tDR_STE_SET_TAG(mpls_v1, tag, mpls0_label,\n\t\t\t       misc2, outer_first_mpls_over_udp_label);\n\n\t\tDR_STE_SET_TAG(mpls_v1, tag, mpls0_exp,\n\t\t\t       misc2, outer_first_mpls_over_udp_exp);\n\n\t\tDR_STE_SET_TAG(mpls_v1, tag, mpls0_s_bos,\n\t\t\t       misc2, outer_first_mpls_over_udp_s_bos);\n\n\t\tDR_STE_SET_TAG(mpls_v1, tag, mpls0_ttl,\n\t\t\t       misc2, outer_first_mpls_over_udp_ttl);\n\t}\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_tnl_mpls_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t   struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_tnl_mpls_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_MPLS_I;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_tnl_mpls_tag;\n}\n\nstatic int dr_ste_v1_build_tnl_mpls_over_udp_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\tu8 *parser_ptr;\n\tu8 parser_id;\n\tu32 mpls_hdr;\n\n\tmpls_hdr = misc2->outer_first_mpls_over_udp_label << HDR_MPLS_OFFSET_LABEL;\n\tmisc2->outer_first_mpls_over_udp_label = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_udp_exp << HDR_MPLS_OFFSET_EXP;\n\tmisc2->outer_first_mpls_over_udp_exp = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_udp_s_bos << HDR_MPLS_OFFSET_S_BOS;\n\tmisc2->outer_first_mpls_over_udp_s_bos = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_udp_ttl << HDR_MPLS_OFFSET_TTL;\n\tmisc2->outer_first_mpls_over_udp_ttl = 0;\n\n\tparser_id = sb->caps->flex_parser_id_mpls_over_udp;\n\tparser_ptr = dr_ste_calc_flex_parser_offset(tag, parser_id);\n\t*(__be32 *)parser_ptr = cpu_to_be32(mpls_hdr);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_tnl_mpls_over_udp_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_tnl_mpls_over_udp_tag(mask, sb, sb->bit_mask);\n\n\t \n\tsb->lu_type = sb->caps->flex_parser_id_mpls_over_udp > DR_STE_MAX_FLEX_0_ID ?\n\t\t      DR_STE_V1_LU_TYPE_FLEX_PARSER_1 :\n\t\t      DR_STE_V1_LU_TYPE_FLEX_PARSER_0;\n\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_tnl_mpls_over_udp_tag;\n}\n\nstatic int dr_ste_v1_build_tnl_mpls_over_gre_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\tu8 *parser_ptr;\n\tu8 parser_id;\n\tu32 mpls_hdr;\n\n\tmpls_hdr = misc2->outer_first_mpls_over_gre_label << HDR_MPLS_OFFSET_LABEL;\n\tmisc2->outer_first_mpls_over_gre_label = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_gre_exp << HDR_MPLS_OFFSET_EXP;\n\tmisc2->outer_first_mpls_over_gre_exp = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_gre_s_bos << HDR_MPLS_OFFSET_S_BOS;\n\tmisc2->outer_first_mpls_over_gre_s_bos = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_gre_ttl << HDR_MPLS_OFFSET_TTL;\n\tmisc2->outer_first_mpls_over_gre_ttl = 0;\n\n\tparser_id = sb->caps->flex_parser_id_mpls_over_gre;\n\tparser_ptr = dr_ste_calc_flex_parser_offset(tag, parser_id);\n\t*(__be32 *)parser_ptr = cpu_to_be32(mpls_hdr);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_tnl_mpls_over_gre_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_tnl_mpls_over_gre_tag(mask, sb, sb->bit_mask);\n\n\t \n\tsb->lu_type = sb->caps->flex_parser_id_mpls_over_gre > DR_STE_MAX_FLEX_0_ID ?\n\t\t      DR_STE_V1_LU_TYPE_FLEX_PARSER_1 :\n\t\t      DR_STE_V1_LU_TYPE_FLEX_PARSER_0;\n\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_tnl_mpls_over_gre_tag;\n}\n\nstatic int dr_ste_v1_build_icmp_tag(struct mlx5dr_match_param *value,\n\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t    u8 *tag)\n{\n\tstruct mlx5dr_match_misc3 *misc3 = &value->misc3;\n\tbool is_ipv4 = DR_MASK_IS_ICMPV4_SET(misc3);\n\tu32 *icmp_header_data;\n\tu8 *icmp_type;\n\tu8 *icmp_code;\n\n\tif (is_ipv4) {\n\t\ticmp_header_data\t= &misc3->icmpv4_header_data;\n\t\ticmp_type\t\t= &misc3->icmpv4_type;\n\t\ticmp_code\t\t= &misc3->icmpv4_code;\n\t} else {\n\t\ticmp_header_data\t= &misc3->icmpv6_header_data;\n\t\ticmp_type\t\t= &misc3->icmpv6_type;\n\t\ticmp_code\t\t= &misc3->icmpv6_code;\n\t}\n\n\tMLX5_SET(ste_icmp_v1, tag, icmp_header_data, *icmp_header_data);\n\tMLX5_SET(ste_icmp_v1, tag, icmp_type, *icmp_type);\n\tMLX5_SET(ste_icmp_v1, tag, icmp_code, *icmp_code);\n\n\t*icmp_header_data = 0;\n\t*icmp_type = 0;\n\t*icmp_code = 0;\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_icmp_init(struct mlx5dr_ste_build *sb,\n\t\t\t       struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_icmp_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_ETHL4_MISC_O;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_icmp_tag;\n}\n\nstatic int dr_ste_v1_build_general_purpose_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t\t\t       u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\n\tDR_STE_SET_TAG(general_purpose, tag, general_purpose_lookup_field,\n\t\t       misc2, metadata_reg_a);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_general_purpose_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t  struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_general_purpose_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_GENERAL_PURPOSE;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_general_purpose_tag;\n}\n\nstatic int dr_ste_v1_build_eth_l4_misc_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t   u8 *tag)\n{\n\tstruct mlx5dr_match_misc3 *misc3 = &value->misc3;\n\n\tif (sb->inner) {\n\t\tDR_STE_SET_TAG(eth_l4_misc_v1, tag, seq_num, misc3, inner_tcp_seq_num);\n\t\tDR_STE_SET_TAG(eth_l4_misc_v1, tag, ack_num, misc3, inner_tcp_ack_num);\n\t} else {\n\t\tDR_STE_SET_TAG(eth_l4_misc_v1, tag, seq_num, misc3, outer_tcp_seq_num);\n\t\tDR_STE_SET_TAG(eth_l4_misc_v1, tag, ack_num, misc3, outer_tcp_ack_num);\n\t}\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_eth_l4_misc_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t      struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_eth_l4_misc_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_ETHL4_MISC_O;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_eth_l4_misc_tag;\n}\n\nstatic int\ndr_ste_v1_build_flex_parser_tnl_vxlan_gpe_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t\t      u8 *tag)\n{\n\tstruct mlx5dr_match_misc3 *misc3 = &value->misc3;\n\n\tDR_STE_SET_TAG(flex_parser_tnl_vxlan_gpe, tag,\n\t\t       outer_vxlan_gpe_flags, misc3,\n\t\t       outer_vxlan_gpe_flags);\n\tDR_STE_SET_TAG(flex_parser_tnl_vxlan_gpe, tag,\n\t\t       outer_vxlan_gpe_next_protocol, misc3,\n\t\t       outer_vxlan_gpe_next_protocol);\n\tDR_STE_SET_TAG(flex_parser_tnl_vxlan_gpe, tag,\n\t\t       outer_vxlan_gpe_vni, misc3,\n\t\t       outer_vxlan_gpe_vni);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_flex_parser_tnl_vxlan_gpe_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_flex_parser_tnl_vxlan_gpe_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_FLEX_PARSER_TNL_HEADER;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_flex_parser_tnl_vxlan_gpe_tag;\n}\n\nstatic int\ndr_ste_v1_build_flex_parser_tnl_geneve_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t   u8 *tag)\n{\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\n\tDR_STE_SET_TAG(flex_parser_tnl_geneve, tag,\n\t\t       geneve_protocol_type, misc, geneve_protocol_type);\n\tDR_STE_SET_TAG(flex_parser_tnl_geneve, tag,\n\t\t       geneve_oam, misc, geneve_oam);\n\tDR_STE_SET_TAG(flex_parser_tnl_geneve, tag,\n\t\t       geneve_opt_len, misc, geneve_opt_len);\n\tDR_STE_SET_TAG(flex_parser_tnl_geneve, tag,\n\t\t       geneve_vni, misc, geneve_vni);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_flex_parser_tnl_geneve_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_flex_parser_tnl_geneve_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_FLEX_PARSER_TNL_HEADER;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_flex_parser_tnl_geneve_tag;\n}\n\nstatic int dr_ste_v1_build_tnl_header_0_1_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t\t      uint8_t *tag)\n{\n\tstruct mlx5dr_match_misc5 *misc5 = &value->misc5;\n\n\tDR_STE_SET_TAG(tunnel_header, tag, tunnel_header_0, misc5, tunnel_header_0);\n\tDR_STE_SET_TAG(tunnel_header, tag, tunnel_header_1, misc5, tunnel_header_1);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_tnl_header_0_1_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t struct mlx5dr_match_param *mask)\n{\n\tsb->lu_type = DR_STE_V1_LU_TYPE_FLEX_PARSER_TNL_HEADER;\n\tdr_ste_v1_build_tnl_header_0_1_tag(mask, sb, sb->bit_mask);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_tnl_header_0_1_tag;\n}\n\nstatic int dr_ste_v1_build_register_0_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t  struct mlx5dr_ste_build *sb,\n\t\t\t\t\t  u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\n\tDR_STE_SET_TAG(register_0, tag, register_0_h, misc2, metadata_reg_c_0);\n\tDR_STE_SET_TAG(register_0, tag, register_0_l, misc2, metadata_reg_c_1);\n\tDR_STE_SET_TAG(register_0, tag, register_1_h, misc2, metadata_reg_c_2);\n\tDR_STE_SET_TAG(register_0, tag, register_1_l, misc2, metadata_reg_c_3);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_register_0_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t     struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_register_0_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_STEERING_REGISTERS_0;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_register_0_tag;\n}\n\nstatic int dr_ste_v1_build_register_1_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t  struct mlx5dr_ste_build *sb,\n\t\t\t\t\t  u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\n\tDR_STE_SET_TAG(register_1, tag, register_2_h, misc2, metadata_reg_c_4);\n\tDR_STE_SET_TAG(register_1, tag, register_2_l, misc2, metadata_reg_c_5);\n\tDR_STE_SET_TAG(register_1, tag, register_3_h, misc2, metadata_reg_c_6);\n\tDR_STE_SET_TAG(register_1, tag, register_3_l, misc2, metadata_reg_c_7);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_register_1_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t     struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_register_1_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_STEERING_REGISTERS_1;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_register_1_tag;\n}\n\nstatic void dr_ste_v1_build_src_gvmi_qpn_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t  u8 *bit_mask)\n{\n\tstruct mlx5dr_match_misc *misc_mask = &value->misc;\n\n\tDR_STE_SET_ONES(src_gvmi_qp_v1, bit_mask, source_gvmi, misc_mask, source_port);\n\tDR_STE_SET_ONES(src_gvmi_qp_v1, bit_mask, source_qp, misc_mask, source_sqn);\n\tmisc_mask->source_eswitch_owner_vhca_id = 0;\n}\n\nstatic int dr_ste_v1_build_src_gvmi_qpn_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t\t    u8 *tag)\n{\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\tint id = misc->source_eswitch_owner_vhca_id;\n\tstruct mlx5dr_cmd_vport_cap *vport_cap;\n\tstruct mlx5dr_domain *dmn = sb->dmn;\n\tstruct mlx5dr_domain *vport_dmn;\n\tu8 *bit_mask = sb->bit_mask;\n\tstruct mlx5dr_domain *peer;\n\n\tDR_STE_SET_TAG(src_gvmi_qp_v1, tag, source_qp, misc, source_sqn);\n\n\tif (sb->vhca_id_valid) {\n\t\tpeer = xa_load(&dmn->peer_dmn_xa, id);\n\t\t \n\t\tif (id == dmn->info.caps.gvmi)\n\t\t\tvport_dmn = dmn;\n\t\telse if (peer && (id == peer->info.caps.gvmi))\n\t\t\tvport_dmn = peer;\n\t\telse\n\t\t\treturn -EINVAL;\n\n\t\tmisc->source_eswitch_owner_vhca_id = 0;\n\t} else {\n\t\tvport_dmn = dmn;\n\t}\n\n\tif (!MLX5_GET(ste_src_gvmi_qp_v1, bit_mask, source_gvmi))\n\t\treturn 0;\n\n\tvport_cap = mlx5dr_domain_get_vport_cap(vport_dmn, misc->source_port);\n\tif (!vport_cap) {\n\t\tmlx5dr_err(dmn, \"Vport 0x%x is disabled or invalid\\n\",\n\t\t\t   misc->source_port);\n\t\treturn -EINVAL;\n\t}\n\n\tif (vport_cap->vport_gvmi)\n\t\tMLX5_SET(ste_src_gvmi_qp_v1, tag, source_gvmi, vport_cap->vport_gvmi);\n\n\tmisc->source_port = 0;\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_src_gvmi_qpn_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t       struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_src_gvmi_qpn_bit_mask(mask, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_SRC_QP_GVMI;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_src_gvmi_qpn_tag;\n}\n\nstatic void dr_ste_v1_set_flex_parser(u32 *misc4_field_id,\n\t\t\t\t      u32 *misc4_field_value,\n\t\t\t\t      bool *parser_is_used,\n\t\t\t\t      u8 *tag)\n{\n\tu32 id = *misc4_field_id;\n\tu8 *parser_ptr;\n\n\tif (id >= DR_NUM_OF_FLEX_PARSERS || parser_is_used[id])\n\t\treturn;\n\n\tparser_is_used[id] = true;\n\tparser_ptr = dr_ste_calc_flex_parser_offset(tag, id);\n\n\t*(__be32 *)parser_ptr = cpu_to_be32(*misc4_field_value);\n\t*misc4_field_id = 0;\n\t*misc4_field_value = 0;\n}\n\nstatic int dr_ste_v1_build_felx_parser_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t   u8 *tag)\n{\n\tstruct mlx5dr_match_misc4 *misc_4_mask = &value->misc4;\n\tbool parser_is_used[DR_NUM_OF_FLEX_PARSERS] = {};\n\n\tdr_ste_v1_set_flex_parser(&misc_4_mask->prog_sample_field_id_0,\n\t\t\t\t  &misc_4_mask->prog_sample_field_value_0,\n\t\t\t\t  parser_is_used, tag);\n\n\tdr_ste_v1_set_flex_parser(&misc_4_mask->prog_sample_field_id_1,\n\t\t\t\t  &misc_4_mask->prog_sample_field_value_1,\n\t\t\t\t  parser_is_used, tag);\n\n\tdr_ste_v1_set_flex_parser(&misc_4_mask->prog_sample_field_id_2,\n\t\t\t\t  &misc_4_mask->prog_sample_field_value_2,\n\t\t\t\t  parser_is_used, tag);\n\n\tdr_ste_v1_set_flex_parser(&misc_4_mask->prog_sample_field_id_3,\n\t\t\t\t  &misc_4_mask->prog_sample_field_value_3,\n\t\t\t\t  parser_is_used, tag);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_flex_parser_0_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\tstruct mlx5dr_match_param *mask)\n{\n\tsb->lu_type = DR_STE_V1_LU_TYPE_FLEX_PARSER_0;\n\tdr_ste_v1_build_felx_parser_tag(mask, sb, sb->bit_mask);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_felx_parser_tag;\n}\n\nvoid dr_ste_v1_build_flex_parser_1_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\tstruct mlx5dr_match_param *mask)\n{\n\tsb->lu_type = DR_STE_V1_LU_TYPE_FLEX_PARSER_1;\n\tdr_ste_v1_build_felx_parser_tag(mask, sb, sb->bit_mask);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_felx_parser_tag;\n}\n\nstatic int\ndr_ste_v1_build_flex_parser_tnl_geneve_tlv_opt_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t   u8 *tag)\n{\n\tstruct mlx5dr_match_misc3 *misc3 = &value->misc3;\n\tu8 parser_id = sb->caps->flex_parser_id_geneve_tlv_option_0;\n\tu8 *parser_ptr = dr_ste_calc_flex_parser_offset(tag, parser_id);\n\n\tMLX5_SET(ste_flex_parser_0, parser_ptr, flex_parser_3,\n\t\t misc3->geneve_tlv_option_0_data);\n\tmisc3->geneve_tlv_option_0_data = 0;\n\n\treturn 0;\n}\n\nvoid\ndr_ste_v1_build_flex_parser_tnl_geneve_tlv_opt_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_flex_parser_tnl_geneve_tlv_opt_tag(mask, sb, sb->bit_mask);\n\n\t \n\tsb->lu_type = sb->caps->flex_parser_id_geneve_tlv_option_0 > 3 ?\n\t\t      DR_STE_V1_LU_TYPE_FLEX_PARSER_1 :\n\t\t      DR_STE_V1_LU_TYPE_FLEX_PARSER_0;\n\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_flex_parser_tnl_geneve_tlv_opt_tag;\n}\n\nstatic int\ndr_ste_v1_build_flex_parser_tnl_geneve_tlv_opt_exist_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t\t uint8_t *tag)\n{\n\tu8 parser_id = sb->caps->flex_parser_id_geneve_tlv_option_0;\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\n\tif (misc->geneve_tlv_option_0_exist) {\n\t\tMLX5_SET(ste_flex_parser_ok, tag, flex_parsers_ok, 1 << parser_id);\n\t\tmisc->geneve_tlv_option_0_exist = 0;\n\t}\n\n\treturn 0;\n}\n\nvoid\ndr_ste_v1_build_flex_parser_tnl_geneve_tlv_opt_exist_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t\t  struct mlx5dr_match_param *mask)\n{\n\tsb->lu_type = DR_STE_V1_LU_TYPE_FLEX_PARSER_OK;\n\tdr_ste_v1_build_flex_parser_tnl_geneve_tlv_opt_exist_tag(mask, sb, sb->bit_mask);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_flex_parser_tnl_geneve_tlv_opt_exist_tag;\n}\n\nstatic int dr_ste_v1_build_flex_parser_tnl_gtpu_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t    u8 *tag)\n{\n\tstruct mlx5dr_match_misc3 *misc3 = &value->misc3;\n\n\tDR_STE_SET_TAG(flex_parser_tnl_gtpu, tag, gtpu_msg_flags, misc3, gtpu_msg_flags);\n\tDR_STE_SET_TAG(flex_parser_tnl_gtpu, tag, gtpu_msg_type, misc3, gtpu_msg_type);\n\tDR_STE_SET_TAG(flex_parser_tnl_gtpu, tag, gtpu_teid, misc3, gtpu_teid);\n\n\treturn 0;\n}\n\nvoid dr_ste_v1_build_flex_parser_tnl_gtpu_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t       struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_flex_parser_tnl_gtpu_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_FLEX_PARSER_TNL_HEADER;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_flex_parser_tnl_gtpu_tag;\n}\n\nstatic int\ndr_ste_v1_build_tnl_gtpu_flex_parser_0_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t   u8 *tag)\n{\n\tif (dr_is_flex_parser_0_id(sb->caps->flex_parser_id_gtpu_dw_0))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_dw_0, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_0_id(sb->caps->flex_parser_id_gtpu_teid))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_teid, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_0_id(sb->caps->flex_parser_id_gtpu_dw_2))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_dw_2, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_0_id(sb->caps->flex_parser_id_gtpu_first_ext_dw_0))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_first_ext_dw_0, sb->caps, &value->misc3);\n\treturn 0;\n}\n\nvoid\ndr_ste_v1_build_tnl_gtpu_flex_parser_0_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_tnl_gtpu_flex_parser_0_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_FLEX_PARSER_0;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_tnl_gtpu_flex_parser_0_tag;\n}\n\nstatic int\ndr_ste_v1_build_tnl_gtpu_flex_parser_1_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t   u8 *tag)\n{\n\tif (dr_is_flex_parser_1_id(sb->caps->flex_parser_id_gtpu_dw_0))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_dw_0, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_1_id(sb->caps->flex_parser_id_gtpu_teid))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_teid, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_1_id(sb->caps->flex_parser_id_gtpu_dw_2))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_dw_2, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_1_id(sb->caps->flex_parser_id_gtpu_first_ext_dw_0))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_first_ext_dw_0, sb->caps, &value->misc3);\n\treturn 0;\n}\n\nvoid\ndr_ste_v1_build_tnl_gtpu_flex_parser_1_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v1_build_tnl_gtpu_flex_parser_1_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V1_LU_TYPE_FLEX_PARSER_1;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v1_build_tnl_gtpu_flex_parser_1_tag;\n}\n\nint dr_ste_v1_alloc_modify_hdr_ptrn_arg(struct mlx5dr_action *action)\n{\n\tstruct mlx5dr_ptrn_mgr *ptrn_mgr;\n\tint ret;\n\n\tptrn_mgr = action->rewrite->dmn->ptrn_mgr;\n\tif (!ptrn_mgr)\n\t\treturn -EOPNOTSUPP;\n\n\taction->rewrite->arg = mlx5dr_arg_get_obj(action->rewrite->dmn->arg_mgr,\n\t\t\t\t\t\t  action->rewrite->num_of_actions,\n\t\t\t\t\t\t  action->rewrite->data);\n\tif (!action->rewrite->arg) {\n\t\tmlx5dr_err(action->rewrite->dmn, \"Failed allocating args for modify header\\n\");\n\t\treturn -EAGAIN;\n\t}\n\n\taction->rewrite->ptrn =\n\t\tmlx5dr_ptrn_cache_get_pattern(ptrn_mgr,\n\t\t\t\t\t      action->rewrite->num_of_actions,\n\t\t\t\t\t      action->rewrite->data);\n\tif (!action->rewrite->ptrn) {\n\t\tmlx5dr_err(action->rewrite->dmn, \"Failed to get pattern\\n\");\n\t\tret = -EAGAIN;\n\t\tgoto put_arg;\n\t}\n\n\treturn 0;\n\nput_arg:\n\tmlx5dr_arg_put_obj(action->rewrite->dmn->arg_mgr,\n\t\t\t   action->rewrite->arg);\n\treturn ret;\n}\n\nvoid dr_ste_v1_free_modify_hdr_ptrn_arg(struct mlx5dr_action *action)\n{\n\tmlx5dr_ptrn_cache_put_pattern(action->rewrite->dmn->ptrn_mgr,\n\t\t\t\t      action->rewrite->ptrn);\n\tmlx5dr_arg_put_obj(action->rewrite->dmn->arg_mgr,\n\t\t\t   action->rewrite->arg);\n}\n\nstatic struct mlx5dr_ste_ctx ste_ctx_v1 = {\n\t \n\t.build_eth_l2_src_dst_init\t= &dr_ste_v1_build_eth_l2_src_dst_init,\n\t.build_eth_l3_ipv6_src_init\t= &dr_ste_v1_build_eth_l3_ipv6_src_init,\n\t.build_eth_l3_ipv6_dst_init\t= &dr_ste_v1_build_eth_l3_ipv6_dst_init,\n\t.build_eth_l3_ipv4_5_tuple_init\t= &dr_ste_v1_build_eth_l3_ipv4_5_tuple_init,\n\t.build_eth_l2_src_init\t\t= &dr_ste_v1_build_eth_l2_src_init,\n\t.build_eth_l2_dst_init\t\t= &dr_ste_v1_build_eth_l2_dst_init,\n\t.build_eth_l2_tnl_init\t\t= &dr_ste_v1_build_eth_l2_tnl_init,\n\t.build_eth_l3_ipv4_misc_init\t= &dr_ste_v1_build_eth_l3_ipv4_misc_init,\n\t.build_eth_ipv6_l3_l4_init\t= &dr_ste_v1_build_eth_ipv6_l3_l4_init,\n\t.build_mpls_init\t\t= &dr_ste_v1_build_mpls_init,\n\t.build_tnl_gre_init\t\t= &dr_ste_v1_build_tnl_gre_init,\n\t.build_tnl_mpls_init\t\t= &dr_ste_v1_build_tnl_mpls_init,\n\t.build_tnl_mpls_over_udp_init\t= &dr_ste_v1_build_tnl_mpls_over_udp_init,\n\t.build_tnl_mpls_over_gre_init\t= &dr_ste_v1_build_tnl_mpls_over_gre_init,\n\t.build_icmp_init\t\t= &dr_ste_v1_build_icmp_init,\n\t.build_general_purpose_init\t= &dr_ste_v1_build_general_purpose_init,\n\t.build_eth_l4_misc_init\t\t= &dr_ste_v1_build_eth_l4_misc_init,\n\t.build_tnl_vxlan_gpe_init\t= &dr_ste_v1_build_flex_parser_tnl_vxlan_gpe_init,\n\t.build_tnl_geneve_init\t\t= &dr_ste_v1_build_flex_parser_tnl_geneve_init,\n\t.build_tnl_geneve_tlv_opt_init\t= &dr_ste_v1_build_flex_parser_tnl_geneve_tlv_opt_init,\n\t.build_tnl_geneve_tlv_opt_exist_init = &dr_ste_v1_build_flex_parser_tnl_geneve_tlv_opt_exist_init,\n\t.build_register_0_init\t\t= &dr_ste_v1_build_register_0_init,\n\t.build_register_1_init\t\t= &dr_ste_v1_build_register_1_init,\n\t.build_src_gvmi_qpn_init\t= &dr_ste_v1_build_src_gvmi_qpn_init,\n\t.build_flex_parser_0_init\t= &dr_ste_v1_build_flex_parser_0_init,\n\t.build_flex_parser_1_init\t= &dr_ste_v1_build_flex_parser_1_init,\n\t.build_tnl_gtpu_init\t\t= &dr_ste_v1_build_flex_parser_tnl_gtpu_init,\n\t.build_tnl_header_0_1_init\t= &dr_ste_v1_build_tnl_header_0_1_init,\n\t.build_tnl_gtpu_flex_parser_0_init = &dr_ste_v1_build_tnl_gtpu_flex_parser_0_init,\n\t.build_tnl_gtpu_flex_parser_1_init = &dr_ste_v1_build_tnl_gtpu_flex_parser_1_init,\n\n\t \n\t.ste_init\t\t\t= &dr_ste_v1_init,\n\t.set_next_lu_type\t\t= &dr_ste_v1_set_next_lu_type,\n\t.get_next_lu_type\t\t= &dr_ste_v1_get_next_lu_type,\n\t.is_miss_addr_set\t\t= &dr_ste_v1_is_miss_addr_set,\n\t.set_miss_addr\t\t\t= &dr_ste_v1_set_miss_addr,\n\t.get_miss_addr\t\t\t= &dr_ste_v1_get_miss_addr,\n\t.set_hit_addr\t\t\t= &dr_ste_v1_set_hit_addr,\n\t.set_byte_mask\t\t\t= &dr_ste_v1_set_byte_mask,\n\t.get_byte_mask\t\t\t= &dr_ste_v1_get_byte_mask,\n\t \n\t.actions_caps\t\t\t= DR_STE_CTX_ACTION_CAP_TX_POP |\n\t\t\t\t\t  DR_STE_CTX_ACTION_CAP_RX_PUSH |\n\t\t\t\t\t  DR_STE_CTX_ACTION_CAP_RX_ENCAP |\n\t\t\t\t\t  DR_STE_CTX_ACTION_CAP_POP_MDFY,\n\t.set_actions_rx\t\t\t= &dr_ste_v1_set_actions_rx,\n\t.set_actions_tx\t\t\t= &dr_ste_v1_set_actions_tx,\n\t.modify_field_arr_sz\t\t= ARRAY_SIZE(dr_ste_v1_action_modify_field_arr),\n\t.modify_field_arr\t\t= dr_ste_v1_action_modify_field_arr,\n\t.set_action_set\t\t\t= &dr_ste_v1_set_action_set,\n\t.set_action_add\t\t\t= &dr_ste_v1_set_action_add,\n\t.set_action_copy\t\t= &dr_ste_v1_set_action_copy,\n\t.set_action_decap_l3_list\t= &dr_ste_v1_set_action_decap_l3_list,\n\t.alloc_modify_hdr_chunk\t\t= &dr_ste_v1_alloc_modify_hdr_ptrn_arg,\n\t.dealloc_modify_hdr_chunk\t= &dr_ste_v1_free_modify_hdr_ptrn_arg,\n\n\t \n\t.prepare_for_postsend\t\t= &dr_ste_v1_prepare_for_postsend,\n};\n\nstruct mlx5dr_ste_ctx *mlx5dr_ste_get_ctx_v1(void)\n{\n\treturn &ste_ctx_v1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}