{
  "module_name": "fs_ft_pool.c",
  "hash_id": "6fbec625f481da7dc8b44255bc586cf5ab8366fef472f78b8ccf37f5430cc6ef",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/fs_ft_pool.c",
  "human_readable_source": "\n \n\n#include \"fs_ft_pool.h\"\n\n \n#define FT_SIZE (16 * 1024 * 1024)\nstatic const unsigned int FT_POOLS[] = { 4 * 1024 * 1024,\n\t\t\t\t\t 1 * 1024 * 1024,\n\t\t\t\t\t 64 * 1024,\n\t\t\t\t\t 128,\n\t\t\t\t\t 1   };\nstruct mlx5_ft_pool {\n\tint ft_left[ARRAY_SIZE(FT_POOLS)];\n};\n\nint mlx5_ft_pool_init(struct mlx5_core_dev *dev)\n{\n\tstruct mlx5_ft_pool *ft_pool;\n\tint i;\n\n\tft_pool = kzalloc(sizeof(*ft_pool), GFP_KERNEL);\n\tif (!ft_pool)\n\t\treturn -ENOMEM;\n\n\tfor (i = ARRAY_SIZE(FT_POOLS) - 1; i >= 0; i--)\n\t\tft_pool->ft_left[i] = FT_SIZE / FT_POOLS[i];\n\n\tdev->priv.ft_pool = ft_pool;\n\treturn 0;\n}\n\nvoid mlx5_ft_pool_destroy(struct mlx5_core_dev *dev)\n{\n\tkfree(dev->priv.ft_pool);\n}\n\nint\nmlx5_ft_pool_get_avail_sz(struct mlx5_core_dev *dev, enum fs_flow_table_type table_type,\n\t\t\t  int desired_size)\n{\n\tu32 max_ft_size = 1 << MLX5_CAP_FLOWTABLE_TYPE(dev, log_max_ft_size, table_type);\n\tint i, found_i = -1;\n\n\tfor (i = ARRAY_SIZE(FT_POOLS) - 1; i >= 0; i--) {\n\t\tif (dev->priv.ft_pool->ft_left[i] && FT_POOLS[i] >= desired_size &&\n\t\t    FT_POOLS[i] <= max_ft_size) {\n\t\t\tfound_i = i;\n\t\t\tif (desired_size != POOL_NEXT_SIZE)\n\t\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (found_i != -1) {\n\t\t--dev->priv.ft_pool->ft_left[found_i];\n\t\treturn FT_POOLS[found_i];\n\t}\n\n\treturn 0;\n}\n\nvoid\nmlx5_ft_pool_put_sz(struct mlx5_core_dev *dev, int sz)\n{\n\tint i;\n\n\tif (!sz)\n\t\treturn;\n\n\tfor (i = ARRAY_SIZE(FT_POOLS) - 1; i >= 0; i--) {\n\t\tif (sz == FT_POOLS[i]) {\n\t\t\t++dev->priv.ft_pool->ft_left[i];\n\t\t\treturn;\n\t\t}\n\t}\n\n\tWARN_ONCE(1, \"Couldn't find size %d in flow table size pool\", sz);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}