{
  "module_name": "tx.c",
  "hash_id": "76214093e006186a4391806e40d35e27bbd9b77471b571c42ad138fe819dc578",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/en/xsk/tx.c",
  "human_readable_source": "\n \n\n#include \"tx.h\"\n#include \"pool.h\"\n#include \"en/xdp.h\"\n#include \"en/params.h\"\n#include <net/xdp_sock_drv.h>\n\nint mlx5e_xsk_wakeup(struct net_device *dev, u32 qid, u32 flags)\n{\n\tstruct mlx5e_priv *priv = netdev_priv(dev);\n\tstruct mlx5e_params *params = &priv->channels.params;\n\tstruct mlx5e_channel *c;\n\n\tif (unlikely(!mlx5e_xdp_is_active(priv)))\n\t\treturn -ENETDOWN;\n\n\tif (unlikely(qid >= params->num_channels))\n\t\treturn -EINVAL;\n\n\tc = priv->channels.c[qid];\n\n\tif (!napi_if_scheduled_mark_missed(&c->napi)) {\n\t\t \n\t\tif (unlikely(!test_bit(MLX5E_SQ_STATE_ENABLED, &c->async_icosq.state)))\n\t\t\treturn 0;\n\n\t\tif (test_and_set_bit(MLX5E_SQ_STATE_PENDING_XSK_TX, &c->async_icosq.state))\n\t\t\treturn 0;\n\n\t\tmlx5e_trigger_napi_icosq(c);\n\t}\n\n\treturn 0;\n}\n\n \nstatic void mlx5e_xsk_tx_post_err(struct mlx5e_xdpsq *sq,\n\t\t\t\t  union mlx5e_xdp_info *xdpi)\n{\n\tu16 pi = mlx5_wq_cyc_ctr2ix(&sq->wq, sq->pc);\n\tstruct mlx5e_xdp_wqe_info *wi = &sq->db.wqe_info[pi];\n\tstruct mlx5e_tx_wqe *nopwqe;\n\n\twi->num_wqebbs = 1;\n\twi->num_pkts = 1;\n\n\tnopwqe = mlx5e_post_nop(&sq->wq, sq->sqn, &sq->pc);\n\tmlx5e_xdpi_fifo_push(&sq->db.xdpi_fifo, *xdpi);\n\tsq->doorbell_cseg = &nopwqe->ctrl;\n}\n\nbool mlx5e_xsk_tx(struct mlx5e_xdpsq *sq, unsigned int budget)\n{\n\tstruct xsk_buff_pool *pool = sq->xsk_pool;\n\tunion mlx5e_xdp_info xdpi;\n\tbool work_done = true;\n\tbool flush = false;\n\n\txdpi.mode = MLX5E_XDP_XMIT_MODE_XSK;\n\n\tfor (; budget; budget--) {\n\t\tint check_result = INDIRECT_CALL_2(sq->xmit_xdp_frame_check,\n\t\t\t\t\t\t   mlx5e_xmit_xdp_frame_check_mpwqe,\n\t\t\t\t\t\t   mlx5e_xmit_xdp_frame_check,\n\t\t\t\t\t\t   sq);\n\t\tstruct mlx5e_xmit_data xdptxd = {};\n\t\tstruct xdp_desc desc;\n\t\tbool ret;\n\n\t\tif (unlikely(check_result < 0)) {\n\t\t\twork_done = false;\n\t\t\tbreak;\n\t\t}\n\n\t\tif (!xsk_tx_peek_desc(pool, &desc)) {\n\t\t\t \n\t\t\tbreak;\n\t\t}\n\n\t\txdptxd.dma_addr = xsk_buff_raw_get_dma(pool, desc.addr);\n\t\txdptxd.data = xsk_buff_raw_get_data(pool, desc.addr);\n\t\txdptxd.len = desc.len;\n\n\t\txsk_buff_raw_dma_sync_for_device(pool, xdptxd.dma_addr, xdptxd.len);\n\n\t\tret = INDIRECT_CALL_2(sq->xmit_xdp_frame, mlx5e_xmit_xdp_frame_mpwqe,\n\t\t\t\t      mlx5e_xmit_xdp_frame, sq, &xdptxd,\n\t\t\t\t      check_result);\n\t\tif (unlikely(!ret)) {\n\t\t\tif (sq->mpwqe.wqe)\n\t\t\t\tmlx5e_xdp_mpwqe_complete(sq);\n\n\t\t\tmlx5e_xsk_tx_post_err(sq, &xdpi);\n\t\t} else {\n\t\t\tmlx5e_xdpi_fifo_push(&sq->db.xdpi_fifo, xdpi);\n\t\t}\n\n\t\tflush = true;\n\t}\n\n\tif (flush) {\n\t\tif (sq->mpwqe.wqe)\n\t\t\tmlx5e_xdp_mpwqe_complete(sq);\n\t\tmlx5e_xmit_xdp_doorbell(sq);\n\n\t\txsk_tx_release(pool);\n\t}\n\n\treturn !(budget && work_done);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}