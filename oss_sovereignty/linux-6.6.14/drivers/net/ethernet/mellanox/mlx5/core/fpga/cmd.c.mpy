{
  "module_name": "cmd.c",
  "hash_id": "e0a3984e4be239d4a2819885878fad1b204187c1f6b0d53359ea654225fb323e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/fpga/cmd.c",
  "human_readable_source": " \n\n#include <linux/etherdevice.h>\n#include <linux/mlx5/driver.h>\n#include <linux/mlx5/device.h>\n\n#include \"mlx5_core.h\"\n#include \"fpga/cmd.h\"\n\n#define MLX5_FPGA_ACCESS_REG_SZ (MLX5_ST_SZ_DW(fpga_access_reg) + \\\n\t\t\t\t MLX5_FPGA_ACCESS_REG_SIZE_MAX)\n\nint mlx5_fpga_access_reg(struct mlx5_core_dev *dev, u8 size, u64 addr,\n\t\t\t void *buf, bool write)\n{\n\tu32 in[MLX5_FPGA_ACCESS_REG_SZ] = {0};\n\tu32 out[MLX5_FPGA_ACCESS_REG_SZ];\n\tint err;\n\n\tif (size & 3)\n\t\treturn -EINVAL;\n\tif (addr & 3)\n\t\treturn -EINVAL;\n\tif (size > MLX5_FPGA_ACCESS_REG_SIZE_MAX)\n\t\treturn -EINVAL;\n\n\tMLX5_SET(fpga_access_reg, in, size, size);\n\tMLX5_SET64(fpga_access_reg, in, address, addr);\n\tif (write)\n\t\tmemcpy(MLX5_ADDR_OF(fpga_access_reg, in, data), buf, size);\n\n\terr = mlx5_core_access_reg(dev, in, sizeof(in), out, sizeof(out),\n\t\t\t\t   MLX5_REG_FPGA_ACCESS_REG, 0, write);\n\tif (err)\n\t\treturn err;\n\n\tif (!write)\n\t\tmemcpy(buf, MLX5_ADDR_OF(fpga_access_reg, out, data), size);\n\n\treturn 0;\n}\n\nint mlx5_fpga_caps(struct mlx5_core_dev *dev)\n{\n\tu32 in[MLX5_ST_SZ_DW(fpga_cap)] = {0};\n\n\treturn mlx5_core_access_reg(dev, in, sizeof(in), dev->caps.fpga,\n\t\t\t\t    MLX5_ST_SZ_BYTES(fpga_cap),\n\t\t\t\t    MLX5_REG_FPGA_CAP, 0, 0);\n}\n\nint mlx5_fpga_ctrl_op(struct mlx5_core_dev *dev, u8 op)\n{\n\tu32 in[MLX5_ST_SZ_DW(fpga_ctrl)] = {0};\n\tu32 out[MLX5_ST_SZ_DW(fpga_ctrl)];\n\n\tMLX5_SET(fpga_ctrl, in, operation, op);\n\n\treturn mlx5_core_access_reg(dev, in, sizeof(in), out, sizeof(out),\n\t\t\t\t    MLX5_REG_FPGA_CTRL, 0, true);\n}\n\nint mlx5_fpga_sbu_caps(struct mlx5_core_dev *dev, void *caps, int size)\n{\n\tunsigned int cap_size = MLX5_CAP_FPGA(dev, sandbox_extended_caps_len);\n\tu64 addr = MLX5_CAP64_FPGA(dev, sandbox_extended_caps_addr);\n\tunsigned int read;\n\tint ret = 0;\n\n\tif (cap_size > size) {\n\t\tmlx5_core_warn(dev, \"Not enough buffer %u for FPGA SBU caps %u\",\n\t\t\t       size, cap_size);\n\t\treturn -EINVAL;\n\t}\n\n\twhile (cap_size > 0) {\n\t\tread = min_t(unsigned int, cap_size,\n\t\t\t     MLX5_FPGA_ACCESS_REG_SIZE_MAX);\n\n\t\tret = mlx5_fpga_access_reg(dev, read, addr, caps, false);\n\t\tif (ret) {\n\t\t\tmlx5_core_warn(dev, \"Error reading FPGA SBU caps %u bytes at address 0x%llx: %d\",\n\t\t\t\t       read, addr, ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tcap_size -= read;\n\t\taddr += read;\n\t\tcaps += read;\n\t}\n\n\treturn ret;\n}\n\nint mlx5_fpga_query(struct mlx5_core_dev *dev, struct mlx5_fpga_query *query)\n{\n\tu32 in[MLX5_ST_SZ_DW(fpga_ctrl)] = {0};\n\tu32 out[MLX5_ST_SZ_DW(fpga_ctrl)];\n\tint err;\n\n\terr = mlx5_core_access_reg(dev, in, sizeof(in), out, sizeof(out),\n\t\t\t\t   MLX5_REG_FPGA_CTRL, 0, false);\n\tif (err)\n\t\treturn err;\n\n\tquery->status = MLX5_GET(fpga_ctrl, out, status);\n\tquery->admin_image = MLX5_GET(fpga_ctrl, out, flash_select_admin);\n\tquery->oper_image = MLX5_GET(fpga_ctrl, out, flash_select_oper);\n\treturn 0;\n}\n\nint mlx5_fpga_create_qp(struct mlx5_core_dev *dev, void *fpga_qpc,\n\t\t\tu32 *fpga_qpn)\n{\n\tu32 out[MLX5_ST_SZ_DW(fpga_create_qp_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(fpga_create_qp_in)] = {};\n\tint ret;\n\n\tMLX5_SET(fpga_create_qp_in, in, opcode, MLX5_CMD_OP_FPGA_CREATE_QP);\n\tmemcpy(MLX5_ADDR_OF(fpga_create_qp_in, in, fpga_qpc), fpga_qpc,\n\t       MLX5_FLD_SZ_BYTES(fpga_create_qp_in, fpga_qpc));\n\n\tret = mlx5_cmd_exec_inout(dev, fpga_create_qp, in, out);\n\tif (ret)\n\t\treturn ret;\n\n\tmemcpy(fpga_qpc, MLX5_ADDR_OF(fpga_create_qp_out, out, fpga_qpc),\n\t       MLX5_FLD_SZ_BYTES(fpga_create_qp_out, fpga_qpc));\n\t*fpga_qpn = MLX5_GET(fpga_create_qp_out, out, fpga_qpn);\n\treturn ret;\n}\n\nint mlx5_fpga_modify_qp(struct mlx5_core_dev *dev, u32 fpga_qpn,\n\t\t\tenum mlx5_fpga_qpc_field_select fields,\n\t\t\tvoid *fpga_qpc)\n{\n\tu32 in[MLX5_ST_SZ_DW(fpga_modify_qp_in)] = {};\n\n\tMLX5_SET(fpga_modify_qp_in, in, opcode, MLX5_CMD_OP_FPGA_MODIFY_QP);\n\tMLX5_SET(fpga_modify_qp_in, in, field_select, fields);\n\tMLX5_SET(fpga_modify_qp_in, in, fpga_qpn, fpga_qpn);\n\tmemcpy(MLX5_ADDR_OF(fpga_modify_qp_in, in, fpga_qpc), fpga_qpc,\n\t       MLX5_FLD_SZ_BYTES(fpga_modify_qp_in, fpga_qpc));\n\n\treturn mlx5_cmd_exec_in(dev, fpga_modify_qp, in);\n}\n\nint mlx5_fpga_query_qp(struct mlx5_core_dev *dev,\n\t\t       u32 fpga_qpn, void *fpga_qpc)\n{\n\tu32 out[MLX5_ST_SZ_DW(fpga_query_qp_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(fpga_query_qp_in)] = {};\n\tint ret;\n\n\tMLX5_SET(fpga_query_qp_in, in, opcode, MLX5_CMD_OP_FPGA_QUERY_QP);\n\tMLX5_SET(fpga_query_qp_in, in, fpga_qpn, fpga_qpn);\n\n\tret = mlx5_cmd_exec_inout(dev, fpga_query_qp, in, out);\n\tif (ret)\n\t\treturn ret;\n\n\tmemcpy(fpga_qpc, MLX5_ADDR_OF(fpga_query_qp_out, out, fpga_qpc),\n\t       MLX5_FLD_SZ_BYTES(fpga_query_qp_out, fpga_qpc));\n\treturn ret;\n}\n\nint mlx5_fpga_destroy_qp(struct mlx5_core_dev *dev, u32 fpga_qpn)\n{\n\tu32 in[MLX5_ST_SZ_DW(fpga_destroy_qp_in)] = {};\n\n\tMLX5_SET(fpga_destroy_qp_in, in, opcode, MLX5_CMD_OP_FPGA_DESTROY_QP);\n\tMLX5_SET(fpga_destroy_qp_in, in, fpga_qpn, fpga_qpn);\n\n\treturn mlx5_cmd_exec_in(dev, fpga_destroy_qp, in);\n}\n\nint mlx5_fpga_query_qp_counters(struct mlx5_core_dev *dev, u32 fpga_qpn,\n\t\t\t\tbool clear, struct mlx5_fpga_qp_counters *data)\n{\n\tu32 out[MLX5_ST_SZ_DW(fpga_query_qp_counters_out)] = {};\n\tu32 in[MLX5_ST_SZ_DW(fpga_query_qp_counters_in)] = {};\n\tint ret;\n\n\tMLX5_SET(fpga_query_qp_counters_in, in, opcode,\n\t\t MLX5_CMD_OP_FPGA_QUERY_QP_COUNTERS);\n\tMLX5_SET(fpga_query_qp_counters_in, in, clear, clear);\n\tMLX5_SET(fpga_query_qp_counters_in, in, fpga_qpn, fpga_qpn);\n\n\tret = mlx5_cmd_exec_inout(dev, fpga_query_qp_counters, in, out);\n\tif (ret)\n\t\treturn ret;\n\n\tdata->rx_ack_packets = MLX5_GET64(fpga_query_qp_counters_out, out,\n\t\t\t\t\t  rx_ack_packets);\n\tdata->rx_send_packets = MLX5_GET64(fpga_query_qp_counters_out, out,\n\t\t\t\t\t   rx_send_packets);\n\tdata->tx_ack_packets = MLX5_GET64(fpga_query_qp_counters_out, out,\n\t\t\t\t\t  tx_ack_packets);\n\tdata->tx_send_packets = MLX5_GET64(fpga_query_qp_counters_out, out,\n\t\t\t\t\t   tx_send_packets);\n\tdata->rx_total_drop = MLX5_GET64(fpga_query_qp_counters_out, out,\n\t\t\t\t\t rx_total_drop);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}