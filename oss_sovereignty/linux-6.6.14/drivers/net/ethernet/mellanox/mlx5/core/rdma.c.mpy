{
  "module_name": "rdma.c",
  "hash_id": "c06b1ddca0f3e0f7eb1892e76d065823dc0e24e07466894cedb452f325d7d726",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/rdma.c",
  "human_readable_source": "\n \n\n#include <linux/mlx5/vport.h>\n#include <rdma/ib_verbs.h>\n#include <net/addrconf.h>\n\n#include \"lib/mlx5.h\"\n#include \"eswitch.h\"\n#include \"fs_core.h\"\n#include \"rdma.h\"\n\nstatic void mlx5_rdma_disable_roce_steering(struct mlx5_core_dev *dev)\n{\n\tstruct mlx5_core_roce *roce = &dev->priv.roce;\n\n\tmlx5_del_flow_rules(roce->allow_rule);\n\tmlx5_destroy_flow_group(roce->fg);\n\tmlx5_destroy_flow_table(roce->ft);\n}\n\nstatic int mlx5_rdma_enable_roce_steering(struct mlx5_core_dev *dev)\n{\n\tint inlen = MLX5_ST_SZ_BYTES(create_flow_group_in);\n\tstruct mlx5_core_roce *roce = &dev->priv.roce;\n\tstruct mlx5_flow_handle *flow_rule = NULL;\n\tstruct mlx5_flow_table_attr ft_attr = {};\n\tstruct mlx5_flow_namespace *ns = NULL;\n\tstruct mlx5_flow_act flow_act = {};\n\tstruct mlx5_flow_spec *spec;\n\tstruct mlx5_flow_table *ft;\n\tstruct mlx5_flow_group *fg;\n\tstruct mlx5_eswitch *esw;\n\tu32 *flow_group_in;\n\tint err;\n\n\tif (!(MLX5_CAP_FLOWTABLE_RDMA_RX(dev, ft_support) &&\n\t      MLX5_CAP_FLOWTABLE_RDMA_RX(dev, table_miss_action_domain)))\n\t\treturn -EOPNOTSUPP;\n\n\tflow_group_in = kvzalloc(inlen, GFP_KERNEL);\n\tif (!flow_group_in)\n\t\treturn -ENOMEM;\n\tspec = kvzalloc(sizeof(*spec), GFP_KERNEL);\n\tif (!spec) {\n\t\tkvfree(flow_group_in);\n\t\treturn -ENOMEM;\n\t}\n\n\tns = mlx5_get_flow_namespace(dev, MLX5_FLOW_NAMESPACE_RDMA_RX_KERNEL);\n\tif (!ns) {\n\t\tmlx5_core_err(dev, \"Failed to get RDMA RX namespace\");\n\t\terr = -EOPNOTSUPP;\n\t\tgoto free;\n\t}\n\n\tft_attr.max_fte = 1;\n\tft = mlx5_create_flow_table(ns, &ft_attr);\n\tif (IS_ERR(ft)) {\n\t\tmlx5_core_err(dev, \"Failed to create RDMA RX flow table\");\n\t\terr = PTR_ERR(ft);\n\t\tgoto free;\n\t}\n\n\tesw = dev->priv.eswitch;\n\tmlx5_esw_set_flow_group_source_port(esw, flow_group_in, 0);\n\n\tfg = mlx5_create_flow_group(ft, flow_group_in);\n\tif (IS_ERR(fg)) {\n\t\terr = PTR_ERR(fg);\n\t\tmlx5_core_err(dev, \"Failed to create RDMA RX flow group err(%d)\\n\", err);\n\t\tgoto destroy_flow_table;\n\t}\n\n\tmlx5_esw_set_spec_source_port(esw, esw->manager_vport, spec);\n\n\tflow_act.action = MLX5_FLOW_CONTEXT_ACTION_ALLOW;\n\tflow_rule = mlx5_add_flow_rules(ft, spec, &flow_act, NULL, 0);\n\tif (IS_ERR(flow_rule)) {\n\t\terr = PTR_ERR(flow_rule);\n\t\tmlx5_core_err(dev, \"Failed to add RoCE allow rule, err=%d\\n\",\n\t\t\t      err);\n\t\tgoto destroy_flow_group;\n\t}\n\n\tkvfree(spec);\n\tkvfree(flow_group_in);\n\troce->ft = ft;\n\troce->fg = fg;\n\troce->allow_rule = flow_rule;\n\n\treturn 0;\n\ndestroy_flow_group:\n\tmlx5_destroy_flow_group(fg);\ndestroy_flow_table:\n\tmlx5_destroy_flow_table(ft);\nfree:\n\tkvfree(spec);\n\tkvfree(flow_group_in);\n\treturn err;\n}\n\nstatic void mlx5_rdma_del_roce_addr(struct mlx5_core_dev *dev)\n{\n\tmlx5_core_roce_gid_set(dev, 0, MLX5_ROCE_VERSION_2, 0,\n\t\t\t       NULL, NULL, false, 0, 1);\n}\n\nstatic void mlx5_rdma_make_default_gid(struct mlx5_core_dev *dev, union ib_gid *gid)\n{\n\tu8 hw_id[ETH_ALEN];\n\n\tmlx5_query_mac_address(dev, hw_id);\n\tgid->global.subnet_prefix = cpu_to_be64(0xfe80000000000000LL);\n\taddrconf_addr_eui48(&gid->raw[8], hw_id);\n}\n\nstatic int mlx5_rdma_add_roce_addr(struct mlx5_core_dev *dev)\n{\n\tunion ib_gid gid;\n\tu8 mac[ETH_ALEN];\n\n\tmlx5_rdma_make_default_gid(dev, &gid);\n\treturn mlx5_core_roce_gid_set(dev, 0,\n\t\t\t\t      MLX5_ROCE_VERSION_2,\n\t\t\t\t      0, gid.raw, mac,\n\t\t\t\t      false, 0, 1);\n}\n\nvoid mlx5_rdma_disable_roce(struct mlx5_core_dev *dev)\n{\n\tstruct mlx5_core_roce *roce = &dev->priv.roce;\n\n\tif (!roce->ft)\n\t\treturn;\n\n\tmlx5_rdma_disable_roce_steering(dev);\n\tmlx5_rdma_del_roce_addr(dev);\n\tmlx5_nic_vport_disable_roce(dev);\n}\n\nvoid mlx5_rdma_enable_roce(struct mlx5_core_dev *dev)\n{\n\tint err;\n\n\tif (!MLX5_CAP_GEN(dev, roce))\n\t\treturn;\n\n\terr = mlx5_nic_vport_enable_roce(dev);\n\tif (err) {\n\t\tmlx5_core_err(dev, \"Failed to enable RoCE: %d\\n\", err);\n\t\treturn;\n\t}\n\n\terr = mlx5_rdma_add_roce_addr(dev);\n\tif (err) {\n\t\tmlx5_core_err(dev, \"Failed to add RoCE address: %d\\n\", err);\n\t\tgoto disable_roce;\n\t}\n\n\terr = mlx5_rdma_enable_roce_steering(dev);\n\tif (err) {\n\t\tmlx5_core_err(dev, \"Failed to enable RoCE steering: %d\\n\", err);\n\t\tgoto del_roce_addr;\n\t}\n\n\treturn;\n\ndel_roce_addr:\n\tmlx5_rdma_del_roce_addr(dev);\ndisable_roce:\n\tmlx5_nic_vport_disable_roce(dev);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}