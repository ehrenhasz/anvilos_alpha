{
  "module_name": "tc_tun_mplsoudp.c",
  "hash_id": "2b2abb6e86b48e1a939da7c090ac408b02c96589c90347bbfdef063d933e080d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/en/tc_tun_mplsoudp.c",
  "human_readable_source": "\n \n\n#include <net/bareudp.h>\n#include <net/mpls.h>\n#include \"en/tc_tun.h\"\n\nstatic bool can_offload(struct mlx5e_priv *priv)\n{\n\treturn MLX5_CAP_ESW_FLOWTABLE_FDB(priv->mdev, reformat_l3_tunnel_to_l2);\n}\n\nstatic int calc_hlen(struct mlx5e_encap_entry *e)\n{\n\treturn sizeof(struct udphdr) + MPLS_HLEN;\n}\n\nstatic int init_encap_attr(struct net_device *tunnel_dev,\n\t\t\t   struct mlx5e_priv *priv,\n\t\t\t   struct mlx5e_encap_entry *e,\n\t\t\t   struct netlink_ext_ack *extack)\n{\n\te->tunnel = &mplsoudp_tunnel;\n\te->reformat_type = MLX5_REFORMAT_TYPE_L2_TO_L3_TUNNEL;\n\treturn 0;\n}\n\nstatic int generate_ip_tun_hdr(char buf[],\n\t\t\t       __u8 *ip_proto,\n\t\t\t       struct mlx5e_encap_entry *r)\n{\n\tconst struct ip_tunnel_key *tun_key = &r->tun_info->key;\n\tconst struct mlx5e_mpls_info *mpls_info = &r->mpls_info;\n\tstruct udphdr *udp = (struct udphdr *)(buf);\n\tstruct mpls_shim_hdr *mpls;\n\n\tmpls = (struct mpls_shim_hdr *)(udp + 1);\n\t*ip_proto = IPPROTO_UDP;\n\n\tudp->dest = tun_key->tp_dst;\n\t*mpls = mpls_entry_encode(mpls_info->label, mpls_info->ttl, mpls_info->tc, mpls_info->bos);\n\n\treturn 0;\n}\n\nstatic int parse_udp_ports(struct mlx5e_priv *priv,\n\t\t\t   struct mlx5_flow_spec *spec,\n\t\t\t   struct flow_cls_offload *f,\n\t\t\t   void *headers_c,\n\t\t\t   void *headers_v)\n{\n\treturn mlx5e_tc_tun_parse_udp_ports(priv, spec, f, headers_c, headers_v);\n}\n\nstatic int parse_tunnel(struct mlx5e_priv *priv,\n\t\t\tstruct mlx5_flow_spec *spec,\n\t\t\tstruct flow_cls_offload *f,\n\t\t\tvoid *headers_c,\n\t\t\tvoid *headers_v)\n{\n\tstruct flow_rule *rule = flow_cls_offload_flow_rule(f);\n\tstruct flow_match_mpls match;\n\tvoid *misc2_c;\n\tvoid *misc2_v;\n\n\tif (!MLX5_CAP_ETH(priv->mdev, tunnel_stateless_mpls_over_udp) &&\n\t    !(MLX5_CAP_GEN(priv->mdev, flex_parser_protocols) & MLX5_FLEX_PROTO_CW_MPLS_UDP))\n\t\treturn -EOPNOTSUPP;\n\n\tif (flow_rule_match_key(rule, FLOW_DISSECTOR_KEY_ENC_KEYID))\n\t\treturn -EOPNOTSUPP;\n\n\tif (!flow_rule_match_key(rule, FLOW_DISSECTOR_KEY_MPLS))\n\t\treturn 0;\n\n\tflow_rule_match_mpls(rule, &match);\n\n\t \n\tif (match.mask->used_lses != 1)\n\t\treturn -EOPNOTSUPP;\n\n\tmisc2_c = MLX5_ADDR_OF(fte_match_param, spec->match_criteria,\n\t\t\t       misc_parameters_2);\n\tmisc2_v = MLX5_ADDR_OF(fte_match_param, spec->match_value,\n\t\t\t       misc_parameters_2);\n\n\tMLX5_SET(fte_match_set_misc2, misc2_c,\n\t\t outer_first_mpls_over_udp.mpls_label,\n\t\t match.mask->ls[0].mpls_label);\n\tMLX5_SET(fte_match_set_misc2, misc2_v,\n\t\t outer_first_mpls_over_udp.mpls_label,\n\t\t match.key->ls[0].mpls_label);\n\n\tMLX5_SET(fte_match_set_misc2, misc2_c,\n\t\t outer_first_mpls_over_udp.mpls_exp,\n\t\t match.mask->ls[0].mpls_tc);\n\tMLX5_SET(fte_match_set_misc2, misc2_v,\n\t\t outer_first_mpls_over_udp.mpls_exp, match.key->ls[0].mpls_tc);\n\n\tMLX5_SET(fte_match_set_misc2, misc2_c,\n\t\t outer_first_mpls_over_udp.mpls_s_bos,\n\t\t match.mask->ls[0].mpls_bos);\n\tMLX5_SET(fte_match_set_misc2, misc2_v,\n\t\t outer_first_mpls_over_udp.mpls_s_bos,\n\t\t match.key->ls[0].mpls_bos);\n\n\tMLX5_SET(fte_match_set_misc2, misc2_c,\n\t\t outer_first_mpls_over_udp.mpls_ttl,\n\t\t match.mask->ls[0].mpls_ttl);\n\tMLX5_SET(fte_match_set_misc2, misc2_v,\n\t\t outer_first_mpls_over_udp.mpls_ttl,\n\t\t match.key->ls[0].mpls_ttl);\n\tspec->match_criteria_enable |= MLX5_MATCH_MISC_PARAMETERS_2;\n\n\treturn 0;\n}\n\nstruct mlx5e_tc_tunnel mplsoudp_tunnel = {\n\t.tunnel_type          = MLX5E_TC_TUNNEL_TYPE_MPLSOUDP,\n\t.match_level          = MLX5_MATCH_L4,\n\t.can_offload          = can_offload,\n\t.calc_hlen            = calc_hlen,\n\t.init_encap_attr      = init_encap_attr,\n\t.generate_ip_tun_hdr  = generate_ip_tun_hdr,\n\t.parse_udp_ports      = parse_udp_ports,\n\t.parse_tunnel         = parse_tunnel,\n\t.encap_info_equal     = mlx5e_tc_tun_encap_info_equal_generic,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}