{
  "module_name": "qos.c",
  "hash_id": "1f6aa901bb64defcaebc6f60e52dafd66750cf9e851251712bca0c53f8363863",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/qos.c",
  "human_readable_source": "\n \n\n#include \"qos.h\"\n\n#define MLX5_QOS_DEFAULT_DWRR_UID 0\n\nbool mlx5_qos_is_supported(struct mlx5_core_dev *mdev)\n{\n\tif (!MLX5_CAP_GEN(mdev, qos))\n\t\treturn false;\n\tif (!MLX5_CAP_QOS(mdev, nic_sq_scheduling))\n\t\treturn false;\n\tif (!MLX5_CAP_QOS(mdev, nic_bw_share))\n\t\treturn false;\n\tif (!MLX5_CAP_QOS(mdev, nic_rate_limit))\n\t\treturn false;\n\treturn true;\n}\n\nint mlx5_qos_max_leaf_nodes(struct mlx5_core_dev *mdev)\n{\n\treturn 1 << MLX5_CAP_QOS(mdev, log_max_qos_nic_queue_group);\n}\n\nint mlx5_qos_create_leaf_node(struct mlx5_core_dev *mdev, u32 parent_id,\n\t\t\t      u32 bw_share, u32 max_avg_bw, u32 *id)\n{\n\tu32 sched_ctx[MLX5_ST_SZ_DW(scheduling_context)] = {0};\n\n\tMLX5_SET(scheduling_context, sched_ctx, parent_element_id, parent_id);\n\tMLX5_SET(scheduling_context, sched_ctx, element_type,\n\t\t SCHEDULING_CONTEXT_ELEMENT_TYPE_QUEUE_GROUP);\n\tMLX5_SET(scheduling_context, sched_ctx, bw_share, bw_share);\n\tMLX5_SET(scheduling_context, sched_ctx, max_average_bw, max_avg_bw);\n\n\treturn mlx5_create_scheduling_element_cmd(mdev, SCHEDULING_HIERARCHY_NIC,\n\t\t\t\t\t\t  sched_ctx, id);\n}\n\nint mlx5_qos_create_inner_node(struct mlx5_core_dev *mdev, u32 parent_id,\n\t\t\t       u32 bw_share, u32 max_avg_bw, u32 *id)\n{\n\tu32 sched_ctx[MLX5_ST_SZ_DW(scheduling_context)] = {0};\n\tvoid *attr;\n\n\tMLX5_SET(scheduling_context, sched_ctx, parent_element_id, parent_id);\n\tMLX5_SET(scheduling_context, sched_ctx, element_type,\n\t\t SCHEDULING_CONTEXT_ELEMENT_TYPE_TSAR);\n\tMLX5_SET(scheduling_context, sched_ctx, bw_share, bw_share);\n\tMLX5_SET(scheduling_context, sched_ctx, max_average_bw, max_avg_bw);\n\n\tattr = MLX5_ADDR_OF(scheduling_context, sched_ctx, element_attributes);\n\tMLX5_SET(tsar_element, attr, tsar_type, TSAR_ELEMENT_TSAR_TYPE_DWRR);\n\n\treturn mlx5_create_scheduling_element_cmd(mdev, SCHEDULING_HIERARCHY_NIC,\n\t\t\t\t\t\t  sched_ctx, id);\n}\n\nint mlx5_qos_create_root_node(struct mlx5_core_dev *mdev, u32 *id)\n{\n\treturn mlx5_qos_create_inner_node(mdev, MLX5_QOS_DEFAULT_DWRR_UID, 0, 0, id);\n}\n\nint mlx5_qos_update_node(struct mlx5_core_dev *mdev,\n\t\t\t u32 bw_share, u32 max_avg_bw, u32 id)\n{\n\tu32 sched_ctx[MLX5_ST_SZ_DW(scheduling_context)] = {0};\n\tu32 bitmask = 0;\n\n\tMLX5_SET(scheduling_context, sched_ctx, bw_share, bw_share);\n\tMLX5_SET(scheduling_context, sched_ctx, max_average_bw, max_avg_bw);\n\n\tbitmask |= MODIFY_SCHEDULING_ELEMENT_IN_MODIFY_BITMASK_BW_SHARE;\n\tbitmask |= MODIFY_SCHEDULING_ELEMENT_IN_MODIFY_BITMASK_MAX_AVERAGE_BW;\n\n\treturn mlx5_modify_scheduling_element_cmd(mdev, SCHEDULING_HIERARCHY_NIC,\n\t\t\t\t\t\t  sched_ctx, id, bitmask);\n}\n\nint mlx5_qos_destroy_node(struct mlx5_core_dev *mdev, u32 id)\n{\n\treturn mlx5_destroy_scheduling_element_cmd(mdev, SCHEDULING_HIERARCHY_NIC, id);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}