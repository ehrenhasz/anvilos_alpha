{
  "module_name": "dr_definer.c",
  "hash_id": "f435b7dac52e229fc7ca756a539a4a92645050faedfde78a5f485e72ceb626f1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_definer.c",
  "human_readable_source": "\n\n\n#include \"dr_types.h\"\n#include \"dr_ste.h\"\n\nstruct dr_definer_object {\n\tu32 id;\n\tu16 format_id;\n\tu8 dw_selectors[MLX5_IFC_DEFINER_DW_SELECTORS_NUM];\n\tu8 byte_selectors[MLX5_IFC_DEFINER_BYTE_SELECTORS_NUM];\n\tu8 match_mask[DR_STE_SIZE_MATCH_TAG];\n\trefcount_t refcount;\n};\n\nstatic bool dr_definer_compare(struct dr_definer_object *definer,\n\t\t\t       u16 format_id, u8 *dw_selectors,\n\t\t\t       u8 *byte_selectors, u8 *match_mask)\n{\n\tint i;\n\n\tif (definer->format_id != format_id)\n\t\treturn false;\n\n\tfor (i = 0; i < MLX5_IFC_DEFINER_DW_SELECTORS_NUM; i++)\n\t\tif (definer->dw_selectors[i] != dw_selectors[i])\n\t\t\treturn false;\n\n\tfor (i = 0; i < MLX5_IFC_DEFINER_BYTE_SELECTORS_NUM; i++)\n\t\tif (definer->byte_selectors[i] != byte_selectors[i])\n\t\t\treturn false;\n\n\tif (memcmp(definer->match_mask, match_mask, DR_STE_SIZE_MATCH_TAG))\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic struct dr_definer_object *\ndr_definer_find_obj(struct mlx5dr_domain *dmn, u16 format_id,\n\t\t    u8 *dw_selectors, u8 *byte_selectors, u8 *match_mask)\n{\n\tstruct dr_definer_object *definer_obj;\n\tunsigned long id;\n\n\txa_for_each(&dmn->definers_xa, id, definer_obj) {\n\t\tif (dr_definer_compare(definer_obj, format_id,\n\t\t\t\t       dw_selectors, byte_selectors,\n\t\t\t\t       match_mask))\n\t\t\treturn definer_obj;\n\t}\n\n\treturn NULL;\n}\n\nstatic struct dr_definer_object *\ndr_definer_create_obj(struct mlx5dr_domain *dmn, u16 format_id,\n\t\t      u8 *dw_selectors, u8 *byte_selectors, u8 *match_mask)\n{\n\tstruct dr_definer_object *definer_obj;\n\tint ret = 0;\n\n\tdefiner_obj = kzalloc(sizeof(*definer_obj), GFP_KERNEL);\n\tif (!definer_obj)\n\t\treturn NULL;\n\n\tret = mlx5dr_cmd_create_definer(dmn->mdev,\n\t\t\t\t\tformat_id,\n\t\t\t\t\tdw_selectors,\n\t\t\t\t\tbyte_selectors,\n\t\t\t\t\tmatch_mask,\n\t\t\t\t\t&definer_obj->id);\n\tif (ret)\n\t\tgoto err_free_definer_obj;\n\n\t \n\tif (definer_obj->id > 0xff) {\n\t\tmlx5dr_err(dmn, \"Unsupported definer ID (%d)\\n\", definer_obj->id);\n\t\tgoto err_destroy_definer;\n\t}\n\n\tdefiner_obj->format_id = format_id;\n\tmemcpy(definer_obj->dw_selectors, dw_selectors, sizeof(definer_obj->dw_selectors));\n\tmemcpy(definer_obj->byte_selectors, byte_selectors, sizeof(definer_obj->byte_selectors));\n\tmemcpy(definer_obj->match_mask, match_mask, sizeof(definer_obj->match_mask));\n\n\trefcount_set(&definer_obj->refcount, 1);\n\n\tret = xa_insert(&dmn->definers_xa, definer_obj->id, definer_obj, GFP_KERNEL);\n\tif (ret) {\n\t\tmlx5dr_dbg(dmn, \"Couldn't insert new definer into xarray (%d)\\n\", ret);\n\t\tgoto err_destroy_definer;\n\t}\n\n\treturn definer_obj;\n\nerr_destroy_definer:\n\tmlx5dr_cmd_destroy_definer(dmn->mdev, definer_obj->id);\nerr_free_definer_obj:\n\tkfree(definer_obj);\n\n\treturn NULL;\n}\n\nstatic void dr_definer_destroy_obj(struct mlx5dr_domain *dmn,\n\t\t\t\t   struct dr_definer_object *definer_obj)\n{\n\tmlx5dr_cmd_destroy_definer(dmn->mdev, definer_obj->id);\n\txa_erase(&dmn->definers_xa, definer_obj->id);\n\tkfree(definer_obj);\n}\n\nint mlx5dr_definer_get(struct mlx5dr_domain *dmn, u16 format_id,\n\t\t       u8 *dw_selectors, u8 *byte_selectors,\n\t\t       u8 *match_mask, u32 *definer_id)\n{\n\tstruct dr_definer_object *definer_obj;\n\tint ret = 0;\n\n\tdefiner_obj = dr_definer_find_obj(dmn, format_id, dw_selectors,\n\t\t\t\t\t  byte_selectors, match_mask);\n\tif (!definer_obj) {\n\t\tdefiner_obj = dr_definer_create_obj(dmn, format_id,\n\t\t\t\t\t\t    dw_selectors, byte_selectors,\n\t\t\t\t\t\t    match_mask);\n\t\tif (!definer_obj)\n\t\t\treturn -ENOMEM;\n\t} else {\n\t\trefcount_inc(&definer_obj->refcount);\n\t}\n\n\t*definer_id = definer_obj->id;\n\n\treturn ret;\n}\n\nvoid mlx5dr_definer_put(struct mlx5dr_domain *dmn, u32 definer_id)\n{\n\tstruct dr_definer_object *definer_obj;\n\n\tdefiner_obj = xa_load(&dmn->definers_xa, definer_id);\n\tif (!definer_obj) {\n\t\tmlx5dr_err(dmn, \"Definer ID %d not found\\n\", definer_id);\n\t\treturn;\n\t}\n\n\tif (refcount_dec_and_test(&definer_obj->refcount))\n\t\tdr_definer_destroy_obj(dmn, definer_obj);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}