{
  "module_name": "clock.h",
  "hash_id": "94de3aa7c95177ac038e1e53c194024c8f9b9c20d450ba8da3296f04dae5384d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/lib/clock.h",
  "human_readable_source": " \n\n#ifndef __LIB_CLOCK_H__\n#define __LIB_CLOCK_H__\n\nstatic inline bool mlx5_is_real_time_rq(struct mlx5_core_dev *mdev)\n{\n\tu8 rq_ts_format_cap = MLX5_CAP_GEN(mdev, rq_ts_format);\n\n\treturn (rq_ts_format_cap == MLX5_TIMESTAMP_FORMAT_CAP_REAL_TIME ||\n\t\trq_ts_format_cap ==\n\t\t\tMLX5_TIMESTAMP_FORMAT_CAP_FREE_RUNNING_AND_REAL_TIME);\n}\n\nstatic inline bool mlx5_is_real_time_sq(struct mlx5_core_dev *mdev)\n{\n\tu8 sq_ts_format_cap = MLX5_CAP_GEN(mdev, sq_ts_format);\n\n\treturn (sq_ts_format_cap == MLX5_TIMESTAMP_FORMAT_CAP_REAL_TIME ||\n\t\tsq_ts_format_cap ==\n\t\t\tMLX5_TIMESTAMP_FORMAT_CAP_FREE_RUNNING_AND_REAL_TIME);\n}\n\ntypedef ktime_t (*cqe_ts_to_ns)(struct mlx5_clock *, u64);\n\n#if IS_ENABLED(CONFIG_PTP_1588_CLOCK)\nvoid mlx5_init_clock(struct mlx5_core_dev *mdev);\nvoid mlx5_cleanup_clock(struct mlx5_core_dev *mdev);\n\nstatic inline int mlx5_clock_get_ptp_index(struct mlx5_core_dev *mdev)\n{\n\treturn mdev->clock.ptp ? ptp_clock_index(mdev->clock.ptp) : -1;\n}\n\nstatic inline ktime_t mlx5_timecounter_cyc2time(struct mlx5_clock *clock,\n\t\t\t\t\t\tu64 timestamp)\n{\n\tstruct mlx5_timer *timer = &clock->timer;\n\tunsigned int seq;\n\tu64 nsec;\n\n\tdo {\n\t\tseq = read_seqbegin(&clock->lock);\n\t\tnsec = timecounter_cyc2time(&timer->tc, timestamp);\n\t} while (read_seqretry(&clock->lock, seq));\n\n\treturn ns_to_ktime(nsec);\n}\n\n#define REAL_TIME_TO_NS(hi, low) (((u64)hi) * NSEC_PER_SEC + ((u64)low))\n\nstatic inline ktime_t mlx5_real_time_cyc2time(struct mlx5_clock *clock,\n\t\t\t\t\t      u64 timestamp)\n{\n\tu64 time = REAL_TIME_TO_NS(timestamp >> 32, timestamp & 0xFFFFFFFF);\n\n\treturn ns_to_ktime(time);\n}\n#else\nstatic inline void mlx5_init_clock(struct mlx5_core_dev *mdev) {}\nstatic inline void mlx5_cleanup_clock(struct mlx5_core_dev *mdev) {}\nstatic inline int mlx5_clock_get_ptp_index(struct mlx5_core_dev *mdev)\n{\n\treturn -1;\n}\n\nstatic inline ktime_t mlx5_timecounter_cyc2time(struct mlx5_clock *clock,\n\t\t\t\t\t\tu64 timestamp)\n{\n\treturn 0;\n}\n\nstatic inline ktime_t mlx5_real_time_cyc2time(struct mlx5_clock *clock,\n\t\t\t\t\t      u64 timestamp)\n{\n\treturn 0;\n}\n#endif\n\nstatic inline cqe_ts_to_ns mlx5_rq_ts_translator(struct mlx5_core_dev *mdev)\n{\n\treturn mlx5_is_real_time_rq(mdev) ? mlx5_real_time_cyc2time :\n\t\t\t\t\t    mlx5_timecounter_cyc2time;\n}\n\nstatic inline cqe_ts_to_ns mlx5_sq_ts_translator(struct mlx5_core_dev *mdev)\n{\n\treturn mlx5_is_real_time_sq(mdev) ? mlx5_real_time_cyc2time :\n\t\t\t\t\t    mlx5_timecounter_cyc2time;\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}