{
  "module_name": "reporter_rx.c",
  "hash_id": "4bb84136ce85eb23e9db08b8235f99644ead3deac90cfde6caf034a9e1c7a9cc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/en/reporter_rx.c",
  "human_readable_source": "\n\n\n#include \"health.h\"\n#include \"params.h\"\n#include \"txrx.h\"\n#include \"devlink.h\"\n#include \"ptp.h\"\n#include \"lib/tout.h\"\n\n \nstatic const char * const rq_sw_state_type_name[] = {\n\t[MLX5E_RQ_STATE_ENABLED] = \"enabled\",\n\t[MLX5E_RQ_STATE_RECOVERING] = \"recovering\",\n\t[MLX5E_RQ_STATE_DIM] = \"dim\",\n\t[MLX5E_RQ_STATE_NO_CSUM_COMPLETE] = \"no_csum_complete\",\n\t[MLX5E_RQ_STATE_CSUM_FULL] = \"csum_full\",\n\t[MLX5E_RQ_STATE_MINI_CQE_HW_STRIDX] = \"mini_cqe_hw_stridx\",\n\t[MLX5E_RQ_STATE_SHAMPO] = \"shampo\",\n\t[MLX5E_RQ_STATE_MINI_CQE_ENHANCED] = \"mini_cqe_enhanced\",\n\t[MLX5E_RQ_STATE_XSK] = \"xsk\",\n};\n\nstatic int mlx5e_query_rq_state(struct mlx5_core_dev *dev, u32 rqn, u8 *state)\n{\n\tint outlen = MLX5_ST_SZ_BYTES(query_rq_out);\n\tvoid *out;\n\tvoid *rqc;\n\tint err;\n\n\tout = kvzalloc(outlen, GFP_KERNEL);\n\tif (!out)\n\t\treturn -ENOMEM;\n\n\terr = mlx5_core_query_rq(dev, rqn, out);\n\tif (err)\n\t\tgoto out;\n\n\trqc = MLX5_ADDR_OF(query_rq_out, out, rq_context);\n\t*state = MLX5_GET(rqc, rqc, state);\n\nout:\n\tkvfree(out);\n\treturn err;\n}\n\nstatic int mlx5e_wait_for_icosq_flush(struct mlx5e_icosq *icosq)\n{\n\tstruct mlx5_core_dev *dev = icosq->channel->mdev;\n\tunsigned long exp_time;\n\n\texp_time = jiffies + msecs_to_jiffies(mlx5_tout_ms(dev, FLUSH_ON_ERROR));\n\n\twhile (time_before(jiffies, exp_time)) {\n\t\tif (icosq->cc == icosq->pc)\n\t\t\treturn 0;\n\n\t\tmsleep(20);\n\t}\n\n\tnetdev_err(icosq->channel->netdev,\n\t\t   \"Wait for ICOSQ 0x%x flush timeout (cc = 0x%x, pc = 0x%x)\\n\",\n\t\t   icosq->sqn, icosq->cc, icosq->pc);\n\n\treturn -ETIMEDOUT;\n}\n\nstatic void mlx5e_reset_icosq_cc_pc(struct mlx5e_icosq *icosq)\n{\n\tWARN_ONCE(icosq->cc != icosq->pc, \"ICOSQ 0x%x: cc (0x%x) != pc (0x%x)\\n\",\n\t\t  icosq->sqn, icosq->cc, icosq->pc);\n\ticosq->cc = 0;\n\ticosq->pc = 0;\n}\n\nstatic int mlx5e_rx_reporter_err_icosq_cqe_recover(void *ctx)\n{\n\tstruct mlx5e_rq *xskrq = NULL;\n\tstruct mlx5_core_dev *mdev;\n\tstruct mlx5e_icosq *icosq;\n\tstruct net_device *dev;\n\tstruct mlx5e_rq *rq;\n\tu8 state;\n\tint err;\n\n\ticosq = ctx;\n\n\tmutex_lock(&icosq->channel->icosq_recovery_lock);\n\n\t \n\trq = &icosq->channel->rq;\n\tif (test_bit(MLX5E_RQ_STATE_ENABLED, &icosq->channel->xskrq.state))\n\t\txskrq = &icosq->channel->xskrq;\n\tmdev = icosq->channel->mdev;\n\tdev = icosq->channel->netdev;\n\terr = mlx5_core_query_sq_state(mdev, icosq->sqn, &state);\n\tif (err) {\n\t\tnetdev_err(dev, \"Failed to query ICOSQ 0x%x state. err = %d\\n\",\n\t\t\t   icosq->sqn, err);\n\t\tgoto out;\n\t}\n\n\tif (state != MLX5_SQC_STATE_ERR)\n\t\tgoto out;\n\n\tmlx5e_deactivate_rq(rq);\n\tif (xskrq)\n\t\tmlx5e_deactivate_rq(xskrq);\n\n\terr = mlx5e_wait_for_icosq_flush(icosq);\n\tif (err)\n\t\tgoto out;\n\n\tmlx5e_deactivate_icosq(icosq);\n\n\t \n\n\terr = mlx5e_health_sq_to_ready(mdev, dev, icosq->sqn);\n\tif (err)\n\t\tgoto out;\n\n\tmlx5e_reset_icosq_cc_pc(icosq);\n\n\tmlx5e_free_rx_missing_descs(rq);\n\tif (xskrq)\n\t\tmlx5e_free_rx_missing_descs(xskrq);\n\n\tclear_bit(MLX5E_SQ_STATE_RECOVERING, &icosq->state);\n\tmlx5e_activate_icosq(icosq);\n\n\tmlx5e_activate_rq(rq);\n\trq->stats->recover++;\n\n\tif (xskrq) {\n\t\tmlx5e_activate_rq(xskrq);\n\t\txskrq->stats->recover++;\n\t}\n\n\tmlx5e_trigger_napi_icosq(icosq->channel);\n\n\tmutex_unlock(&icosq->channel->icosq_recovery_lock);\n\n\treturn 0;\nout:\n\tclear_bit(MLX5E_SQ_STATE_RECOVERING, &icosq->state);\n\tmutex_unlock(&icosq->channel->icosq_recovery_lock);\n\treturn err;\n}\n\nstatic int mlx5e_rx_reporter_err_rq_cqe_recover(void *ctx)\n{\n\tstruct mlx5e_rq *rq = ctx;\n\tint err;\n\n\tmlx5e_deactivate_rq(rq);\n\terr = mlx5e_flush_rq(rq, MLX5_RQC_STATE_ERR);\n\tclear_bit(MLX5E_RQ_STATE_RECOVERING, &rq->state);\n\tif (err)\n\t\treturn err;\n\n\tmlx5e_activate_rq(rq);\n\trq->stats->recover++;\n\tif (rq->channel)\n\t\tmlx5e_trigger_napi_icosq(rq->channel);\n\telse\n\t\tmlx5e_trigger_napi_sched(rq->cq.napi);\n\treturn 0;\n}\n\nstatic int mlx5e_rx_reporter_timeout_recover(void *ctx)\n{\n\tstruct mlx5_eq_comp *eq;\n\tstruct mlx5e_rq *rq;\n\tint err;\n\n\trq = ctx;\n\teq = rq->cq.mcq.eq;\n\n\terr = mlx5e_health_channel_eq_recover(rq->netdev, eq, rq->cq.ch_stats);\n\tif (err && rq->icosq)\n\t\tclear_bit(MLX5E_SQ_STATE_ENABLED, &rq->icosq->state);\n\n\treturn err;\n}\n\nstatic int mlx5e_rx_reporter_recover_from_ctx(struct mlx5e_err_ctx *err_ctx)\n{\n\treturn err_ctx->recover(err_ctx->ctx);\n}\n\nstatic int mlx5e_rx_reporter_recover(struct devlink_health_reporter *reporter,\n\t\t\t\t     void *context,\n\t\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct mlx5e_priv *priv = devlink_health_reporter_priv(reporter);\n\tstruct mlx5e_err_ctx *err_ctx = context;\n\n\treturn err_ctx ? mlx5e_rx_reporter_recover_from_ctx(err_ctx) :\n\t\t\t mlx5e_health_recover_channels(priv);\n}\n\nstatic int mlx5e_reporter_icosq_diagnose(struct mlx5e_icosq *icosq, u8 hw_state,\n\t\t\t\t\t struct devlink_fmsg *fmsg)\n{\n\tint err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"ICOSQ\");\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"sqn\", icosq->sqn);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u8_pair_put(fmsg, \"HW state\", hw_state);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"cc\", icosq->cc);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"pc\", icosq->pc);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"WQE size\",\n\t\t\t\t\tmlx5_wq_cyc_get_size(&icosq->wq));\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"CQ\");\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"cqn\", icosq->cq.mcq.cqn);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"cc\", icosq->cq.wq.cc);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"size\", mlx5_cqwq_get_size(&icosq->cq.wq));\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n}\n\nstatic int mlx5e_health_rq_put_sw_state(struct devlink_fmsg *fmsg, struct mlx5e_rq *rq)\n{\n\tint err;\n\tint i;\n\n\tBUILD_BUG_ON_MSG(ARRAY_SIZE(rq_sw_state_type_name) != MLX5E_NUM_RQ_STATES,\n\t\t\t \"rq_sw_state_type_name string array must be consistent with MLX5E_RQ_STATE_* enum in en.h\");\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"SW State\");\n\tif (err)\n\t\treturn err;\n\n\tfor (i = 0; i < ARRAY_SIZE(rq_sw_state_type_name); ++i) {\n\t\terr = devlink_fmsg_u32_pair_put(fmsg, rq_sw_state_type_name[i],\n\t\t\t\t\t\ttest_bit(i, &rq->state));\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n}\n\nstatic int\nmlx5e_rx_reporter_build_diagnose_output_rq_common(struct mlx5e_rq *rq,\n\t\t\t\t\t\t  struct devlink_fmsg *fmsg)\n{\n\tu16 wqe_counter;\n\tint wqes_sz;\n\tu8 hw_state;\n\tu16 wq_head;\n\tint err;\n\n\terr = mlx5e_query_rq_state(rq->mdev, rq->rqn, &hw_state);\n\tif (err)\n\t\treturn err;\n\n\twqes_sz = mlx5e_rqwq_get_cur_sz(rq);\n\twq_head = mlx5e_rqwq_get_head(rq);\n\twqe_counter = mlx5e_rqwq_get_wqe_counter(rq);\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"rqn\", rq->rqn);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u8_pair_put(fmsg, \"HW state\", hw_state);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"WQE counter\", wqe_counter);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"posted WQEs\", wqes_sz);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"cc\", wq_head);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_rq_put_sw_state(fmsg, rq);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_cq_diag_fmsg(&rq->cq, fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_eq_diag_fmsg(rq->cq.mcq.eq, fmsg);\n\tif (err)\n\t\treturn err;\n\n\tif (rq->icosq) {\n\t\tstruct mlx5e_icosq *icosq = rq->icosq;\n\t\tu8 icosq_hw_state;\n\n\t\terr = mlx5_core_query_sq_state(rq->mdev, icosq->sqn, &icosq_hw_state);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = mlx5e_reporter_icosq_diagnose(icosq, icosq_hw_state, fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int mlx5e_rx_reporter_build_diagnose_output(struct mlx5e_rq *rq,\n\t\t\t\t\t\t   struct devlink_fmsg *fmsg)\n{\n\tint err;\n\n\terr = devlink_fmsg_obj_nest_start(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"channel ix\", rq->ix);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_rx_reporter_build_diagnose_output_rq_common(rq, fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn devlink_fmsg_obj_nest_end(fmsg);\n}\n\nstatic int mlx5e_rx_reporter_diagnose_generic_rq(struct mlx5e_rq *rq,\n\t\t\t\t\t\t struct devlink_fmsg *fmsg)\n{\n\tstruct mlx5e_priv *priv = rq->priv;\n\tstruct mlx5e_params *params;\n\tu32 rq_stride, rq_sz;\n\tbool real_time;\n\tint err;\n\n\tparams = &priv->channels.params;\n\trq_sz = mlx5e_rqwq_get_size(rq);\n\treal_time =  mlx5_is_real_time_rq(priv->mdev);\n\trq_stride = BIT(mlx5e_mpwqe_get_log_stride_size(priv->mdev, params, NULL));\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"RQ\");\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u8_pair_put(fmsg, \"type\", params->rq_wq_type);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u64_pair_put(fmsg, \"stride size\", rq_stride);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"size\", rq_sz);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_string_pair_put(fmsg, \"ts_format\", real_time ? \"RT\" : \"FRC\");\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_cq_common_diag_fmsg(&rq->cq, fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n}\n\nstatic int\nmlx5e_rx_reporter_diagnose_common_ptp_config(struct mlx5e_priv *priv, struct mlx5e_ptp *ptp_ch,\n\t\t\t\t\t     struct devlink_fmsg *fmsg)\n{\n\tint err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"PTP\");\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"filter_type\", priv->tstamp.rx_filter);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_rx_reporter_diagnose_generic_rq(&ptp_ch->rq, fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n}\n\nstatic int\nmlx5e_rx_reporter_diagnose_common_config(struct devlink_health_reporter *reporter,\n\t\t\t\t\t struct devlink_fmsg *fmsg)\n{\n\tstruct mlx5e_priv *priv = devlink_health_reporter_priv(reporter);\n\tstruct mlx5e_rq *generic_rq = &priv->channels.c[0]->rq;\n\tstruct mlx5e_ptp *ptp_ch = priv->channels.ptp;\n\tint err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"Common config\");\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_rx_reporter_diagnose_generic_rq(generic_rq, fmsg);\n\tif (err)\n\t\treturn err;\n\n\tif (ptp_ch && test_bit(MLX5E_PTP_STATE_RX, ptp_ch->state)) {\n\t\terr = mlx5e_rx_reporter_diagnose_common_ptp_config(priv, ptp_ch, fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n}\n\nstatic int mlx5e_rx_reporter_build_diagnose_output_ptp_rq(struct mlx5e_rq *rq,\n\t\t\t\t\t\t\t  struct devlink_fmsg *fmsg)\n{\n\tint err;\n\n\terr = devlink_fmsg_obj_nest_start(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_string_pair_put(fmsg, \"channel\", \"ptp\");\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_rx_reporter_build_diagnose_output_rq_common(rq, fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic int mlx5e_rx_reporter_diagnose(struct devlink_health_reporter *reporter,\n\t\t\t\t      struct devlink_fmsg *fmsg,\n\t\t\t\t      struct netlink_ext_ack *extack)\n{\n\tstruct mlx5e_priv *priv = devlink_health_reporter_priv(reporter);\n\tstruct mlx5e_ptp *ptp_ch = priv->channels.ptp;\n\tint i, err = 0;\n\n\tmutex_lock(&priv->state_lock);\n\n\tif (!test_bit(MLX5E_STATE_OPENED, &priv->state))\n\t\tgoto unlock;\n\n\terr = mlx5e_rx_reporter_diagnose_common_config(reporter, fmsg);\n\tif (err)\n\t\tgoto unlock;\n\n\terr = devlink_fmsg_arr_pair_nest_start(fmsg, \"RQs\");\n\tif (err)\n\t\tgoto unlock;\n\n\tfor (i = 0; i < priv->channels.num; i++) {\n\t\tstruct mlx5e_channel *c = priv->channels.c[i];\n\t\tstruct mlx5e_rq *rq;\n\n\t\trq = test_bit(MLX5E_CHANNEL_STATE_XSK, c->state) ?\n\t\t\t&c->xskrq : &c->rq;\n\n\t\terr = mlx5e_rx_reporter_build_diagnose_output(rq, fmsg);\n\t\tif (err)\n\t\t\tgoto unlock;\n\t}\n\tif (ptp_ch && test_bit(MLX5E_PTP_STATE_RX, ptp_ch->state)) {\n\t\terr = mlx5e_rx_reporter_build_diagnose_output_ptp_rq(&ptp_ch->rq, fmsg);\n\t\tif (err)\n\t\t\tgoto unlock;\n\t}\n\terr = devlink_fmsg_arr_pair_nest_end(fmsg);\nunlock:\n\tmutex_unlock(&priv->state_lock);\n\treturn err;\n}\n\nstatic int mlx5e_rx_reporter_dump_icosq(struct mlx5e_priv *priv, struct devlink_fmsg *fmsg,\n\t\t\t\t\tvoid *ctx)\n{\n\tstruct mlx5e_txqsq *icosq = ctx;\n\tstruct mlx5_rsc_key key = {};\n\tint err;\n\n\tif (!test_bit(MLX5E_STATE_OPENED, &priv->state))\n\t\treturn 0;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"SX Slice\");\n\tif (err)\n\t\treturn err;\n\n\tkey.size = PAGE_SIZE;\n\tkey.rsc = MLX5_SGMT_TYPE_SX_SLICE_ALL;\n\terr = mlx5e_health_rsc_fmsg_dump(priv, &key, fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"ICOSQ\");\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"QPC\");\n\tif (err)\n\t\treturn err;\n\n\tkey.rsc = MLX5_SGMT_TYPE_FULL_QPC;\n\tkey.index1 = icosq->sqn;\n\tkey.num_of_obj1 = 1;\n\n\terr = mlx5e_health_rsc_fmsg_dump(priv, &key, fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"send_buff\");\n\tif (err)\n\t\treturn err;\n\n\tkey.rsc = MLX5_SGMT_TYPE_SND_BUFF;\n\tkey.num_of_obj2 = MLX5_RSC_DUMP_ALL;\n\n\terr = mlx5e_health_rsc_fmsg_dump(priv, &key, fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n}\n\nstatic int mlx5e_rx_reporter_dump_rq(struct mlx5e_priv *priv, struct devlink_fmsg *fmsg,\n\t\t\t\t     void *ctx)\n{\n\tstruct mlx5_rsc_key key = {};\n\tstruct mlx5e_rq *rq = ctx;\n\tint err;\n\n\tif (!test_bit(MLX5E_STATE_OPENED, &priv->state))\n\t\treturn 0;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"RX Slice\");\n\tif (err)\n\t\treturn err;\n\n\tkey.size = PAGE_SIZE;\n\tkey.rsc = MLX5_SGMT_TYPE_RX_SLICE_ALL;\n\terr = mlx5e_health_rsc_fmsg_dump(priv, &key, fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"RQ\");\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"QPC\");\n\tif (err)\n\t\treturn err;\n\n\tkey.rsc = MLX5_SGMT_TYPE_FULL_QPC;\n\tkey.index1 = rq->rqn;\n\tkey.num_of_obj1 = 1;\n\n\terr = mlx5e_health_rsc_fmsg_dump(priv, &key, fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"receive_buff\");\n\tif (err)\n\t\treturn err;\n\n\tkey.rsc = MLX5_SGMT_TYPE_RCV_BUFF;\n\tkey.num_of_obj2 = MLX5_RSC_DUMP_ALL;\n\terr = mlx5e_health_rsc_fmsg_dump(priv, &key, fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\treturn mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n}\n\nstatic int mlx5e_rx_reporter_dump_all_rqs(struct mlx5e_priv *priv,\n\t\t\t\t\t  struct devlink_fmsg *fmsg)\n{\n\tstruct mlx5e_ptp *ptp_ch = priv->channels.ptp;\n\tstruct mlx5_rsc_key key = {};\n\tint i, err;\n\n\tif (!test_bit(MLX5E_STATE_OPENED, &priv->state))\n\t\treturn 0;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_start(fmsg, \"RX Slice\");\n\tif (err)\n\t\treturn err;\n\n\tkey.size = PAGE_SIZE;\n\tkey.rsc = MLX5_SGMT_TYPE_RX_SLICE_ALL;\n\terr = mlx5e_health_rsc_fmsg_dump(priv, &key, fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = mlx5e_health_fmsg_named_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_arr_pair_nest_start(fmsg, \"RQs\");\n\tif (err)\n\t\treturn err;\n\n\tfor (i = 0; i < priv->channels.num; i++) {\n\t\tstruct mlx5e_rq *rq = &priv->channels.c[i]->rq;\n\n\t\terr = mlx5e_health_queue_dump(priv, fmsg, rq->rqn, \"RQ\");\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tif (ptp_ch && test_bit(MLX5E_PTP_STATE_RX, ptp_ch->state)) {\n\t\terr = mlx5e_health_queue_dump(priv, fmsg, ptp_ch->rq.rqn, \"PTP RQ\");\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn devlink_fmsg_arr_pair_nest_end(fmsg);\n}\n\nstatic int mlx5e_rx_reporter_dump_from_ctx(struct mlx5e_priv *priv,\n\t\t\t\t\t   struct mlx5e_err_ctx *err_ctx,\n\t\t\t\t\t   struct devlink_fmsg *fmsg)\n{\n\treturn err_ctx->dump(priv, fmsg, err_ctx->ctx);\n}\n\nstatic int mlx5e_rx_reporter_dump(struct devlink_health_reporter *reporter,\n\t\t\t\t  struct devlink_fmsg *fmsg, void *context,\n\t\t\t\t  struct netlink_ext_ack *extack)\n{\n\tstruct mlx5e_priv *priv = devlink_health_reporter_priv(reporter);\n\tstruct mlx5e_err_ctx *err_ctx = context;\n\n\treturn err_ctx ? mlx5e_rx_reporter_dump_from_ctx(priv, err_ctx, fmsg) :\n\t\t\t mlx5e_rx_reporter_dump_all_rqs(priv, fmsg);\n}\n\nvoid mlx5e_reporter_rx_timeout(struct mlx5e_rq *rq)\n{\n\tchar err_str[MLX5E_REPORTER_PER_Q_MAX_LEN];\n\tstruct mlx5e_icosq *icosq = rq->icosq;\n\tstruct mlx5e_priv *priv = rq->priv;\n\tstruct mlx5e_err_ctx err_ctx = {};\n\tchar icosq_str[32] = {};\n\n\terr_ctx.ctx = rq;\n\terr_ctx.recover = mlx5e_rx_reporter_timeout_recover;\n\terr_ctx.dump = mlx5e_rx_reporter_dump_rq;\n\n\tif (icosq)\n\t\tsnprintf(icosq_str, sizeof(icosq_str), \"ICOSQ: 0x%x, \", icosq->sqn);\n\tsnprintf(err_str, sizeof(err_str),\n\t\t \"RX timeout on channel: %d, %s RQ: 0x%x, CQ: 0x%x\",\n\t\t rq->ix, icosq_str, rq->rqn, rq->cq.mcq.cqn);\n\n\tmlx5e_health_report(priv, priv->rx_reporter, err_str, &err_ctx);\n}\n\nvoid mlx5e_reporter_rq_cqe_err(struct mlx5e_rq *rq)\n{\n\tchar err_str[MLX5E_REPORTER_PER_Q_MAX_LEN];\n\tstruct mlx5e_priv *priv = rq->priv;\n\tstruct mlx5e_err_ctx err_ctx = {};\n\n\terr_ctx.ctx = rq;\n\terr_ctx.recover = mlx5e_rx_reporter_err_rq_cqe_recover;\n\terr_ctx.dump = mlx5e_rx_reporter_dump_rq;\n\tsnprintf(err_str, sizeof(err_str), \"ERR CQE on RQ: 0x%x\", rq->rqn);\n\n\tmlx5e_health_report(priv, priv->rx_reporter, err_str, &err_ctx);\n}\n\nvoid mlx5e_reporter_icosq_cqe_err(struct mlx5e_icosq *icosq)\n{\n\tstruct mlx5e_priv *priv = icosq->channel->priv;\n\tchar err_str[MLX5E_REPORTER_PER_Q_MAX_LEN];\n\tstruct mlx5e_err_ctx err_ctx = {};\n\n\terr_ctx.ctx = icosq;\n\terr_ctx.recover = mlx5e_rx_reporter_err_icosq_cqe_recover;\n\terr_ctx.dump = mlx5e_rx_reporter_dump_icosq;\n\tsnprintf(err_str, sizeof(err_str), \"ERR CQE on ICOSQ: 0x%x\", icosq->sqn);\n\n\tmlx5e_health_report(priv, priv->rx_reporter, err_str, &err_ctx);\n}\n\nvoid mlx5e_reporter_icosq_suspend_recovery(struct mlx5e_channel *c)\n{\n\tmutex_lock(&c->icosq_recovery_lock);\n}\n\nvoid mlx5e_reporter_icosq_resume_recovery(struct mlx5e_channel *c)\n{\n\tmutex_unlock(&c->icosq_recovery_lock);\n}\n\nstatic const struct devlink_health_reporter_ops mlx5_rx_reporter_ops = {\n\t.name = \"rx\",\n\t.recover = mlx5e_rx_reporter_recover,\n\t.diagnose = mlx5e_rx_reporter_diagnose,\n\t.dump = mlx5e_rx_reporter_dump,\n};\n\n#define MLX5E_REPORTER_RX_GRACEFUL_PERIOD 500\n\nvoid mlx5e_reporter_rx_create(struct mlx5e_priv *priv)\n{\n\tstruct devlink_health_reporter *reporter;\n\n\treporter = devlink_port_health_reporter_create(priv->netdev->devlink_port,\n\t\t\t\t\t\t       &mlx5_rx_reporter_ops,\n\t\t\t\t\t\t       MLX5E_REPORTER_RX_GRACEFUL_PERIOD, priv);\n\tif (IS_ERR(reporter)) {\n\t\tnetdev_warn(priv->netdev, \"Failed to create rx reporter, err = %ld\\n\",\n\t\t\t    PTR_ERR(reporter));\n\t\treturn;\n\t}\n\tpriv->rx_reporter = reporter;\n}\n\nvoid mlx5e_reporter_rx_destroy(struct mlx5e_priv *priv)\n{\n\tif (!priv->rx_reporter)\n\t\treturn;\n\n\tdevlink_health_reporter_destroy(priv->rx_reporter);\n\tpriv->rx_reporter = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}