{
  "module_name": "driver.c",
  "hash_id": "6e43b003a4c238cc5133d6bc36c9fe64300fc4bb8bcc43ebd9e03cb3daff1118",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/sf/dev/driver.c",
  "human_readable_source": "\n \n\n#include <linux/mlx5/driver.h>\n#include <linux/mlx5/device.h>\n#include <linux/mlx5/eswitch.h>\n#include \"mlx5_core.h\"\n#include \"dev.h\"\n#include \"devlink.h\"\n\nstatic int mlx5_sf_dev_probe(struct auxiliary_device *adev, const struct auxiliary_device_id *id)\n{\n\tstruct mlx5_sf_dev *sf_dev = container_of(adev, struct mlx5_sf_dev, adev);\n\tstruct mlx5_core_dev *mdev;\n\tstruct devlink *devlink;\n\tint err;\n\n\tdevlink = mlx5_devlink_alloc(&adev->dev);\n\tif (!devlink)\n\t\treturn -ENOMEM;\n\n\tmdev = devlink_priv(devlink);\n\tmdev->device = &adev->dev;\n\tmdev->pdev = sf_dev->parent_mdev->pdev;\n\tmdev->bar_addr = sf_dev->bar_base_addr;\n\tmdev->iseg_base = sf_dev->bar_base_addr;\n\tmdev->coredev_type = MLX5_COREDEV_SF;\n\tmdev->priv.parent_mdev = sf_dev->parent_mdev;\n\tmdev->priv.adev_idx = adev->id;\n\tsf_dev->mdev = mdev;\n\n\t \n\tif (MLX5_ESWITCH_MANAGER(sf_dev->parent_mdev))\n\t\tmlx5_dev_set_lightweight(mdev);\n\n\terr = mlx5_mdev_init(mdev, MLX5_SF_PROF);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"mlx5_mdev_init on err=%d\\n\", err);\n\t\tgoto mdev_err;\n\t}\n\n\tmdev->iseg = ioremap(mdev->iseg_base, sizeof(*mdev->iseg));\n\tif (!mdev->iseg) {\n\t\tmlx5_core_warn(mdev, \"remap error\\n\");\n\t\terr = -ENOMEM;\n\t\tgoto remap_err;\n\t}\n\n\tif (MLX5_ESWITCH_MANAGER(sf_dev->parent_mdev))\n\t\terr = mlx5_init_one_light(mdev);\n\telse\n\t\terr = mlx5_init_one(mdev);\n\tif (err) {\n\t\tmlx5_core_warn(mdev, \"mlx5_init_one err=%d\\n\", err);\n\t\tgoto init_one_err;\n\t}\n\tdevlink_register(devlink);\n\treturn 0;\n\ninit_one_err:\n\tiounmap(mdev->iseg);\nremap_err:\n\tmlx5_mdev_uninit(mdev);\nmdev_err:\n\tmlx5_devlink_free(devlink);\n\treturn err;\n}\n\nstatic void mlx5_sf_dev_remove(struct auxiliary_device *adev)\n{\n\tstruct mlx5_sf_dev *sf_dev = container_of(adev, struct mlx5_sf_dev, adev);\n\tstruct devlink *devlink = priv_to_devlink(sf_dev->mdev);\n\n\tmlx5_drain_health_wq(sf_dev->mdev);\n\tdevlink_unregister(devlink);\n\tif (mlx5_dev_is_lightweight(sf_dev->mdev))\n\t\tmlx5_uninit_one_light(sf_dev->mdev);\n\telse\n\t\tmlx5_uninit_one(sf_dev->mdev);\n\tiounmap(sf_dev->mdev->iseg);\n\tmlx5_mdev_uninit(sf_dev->mdev);\n\tmlx5_devlink_free(devlink);\n}\n\nstatic void mlx5_sf_dev_shutdown(struct auxiliary_device *adev)\n{\n\tstruct mlx5_sf_dev *sf_dev = container_of(adev, struct mlx5_sf_dev, adev);\n\n\tmlx5_unload_one(sf_dev->mdev, false);\n}\n\nstatic const struct auxiliary_device_id mlx5_sf_dev_id_table[] = {\n\t{ .name = MLX5_ADEV_NAME \".\" MLX5_SF_DEV_ID_NAME, },\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(auxiliary, mlx5_sf_dev_id_table);\n\nstatic struct auxiliary_driver mlx5_sf_driver = {\n\t.name = MLX5_SF_DEV_ID_NAME,\n\t.probe = mlx5_sf_dev_probe,\n\t.remove = mlx5_sf_dev_remove,\n\t.shutdown = mlx5_sf_dev_shutdown,\n\t.id_table = mlx5_sf_dev_id_table,\n};\n\nint mlx5_sf_driver_register(void)\n{\n\treturn auxiliary_driver_register(&mlx5_sf_driver);\n}\n\nvoid mlx5_sf_driver_unregister(void)\n{\n\tauxiliary_driver_unregister(&mlx5_sf_driver);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}