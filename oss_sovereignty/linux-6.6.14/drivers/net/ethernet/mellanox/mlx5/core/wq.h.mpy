{
  "module_name": "wq.h",
  "hash_id": "a13f8d5eee1dae1b17964e54da4c3cc84d7989e63209b28471c658994d68a396",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/wq.h",
  "human_readable_source": " \n\n#ifndef __MLX5_WQ_H__\n#define __MLX5_WQ_H__\n\n#include <linux/mlx5/mlx5_ifc.h>\n#include <linux/mlx5/cq.h>\n#include <linux/mlx5/qp.h>\n\nstruct mlx5_wq_param {\n\tint\t\tbuf_numa_node;\n\tint\t\tdb_numa_node;\n};\n\nstruct mlx5_wq_ctrl {\n\tstruct mlx5_core_dev\t*mdev;\n\tstruct mlx5_frag_buf\tbuf;\n\tstruct mlx5_db\t\tdb;\n};\n\nstruct mlx5_wq_cyc {\n\tstruct mlx5_frag_buf_ctrl fbc;\n\t__be32\t\t\t*db;\n\tu16\t\t\tsz;\n\tu16\t\t\twqe_ctr;\n\tu16\t\t\tcur_sz;\n};\n\nstruct mlx5_wq_qp {\n\tstruct mlx5_wq_cyc\trq;\n\tstruct mlx5_wq_cyc\tsq;\n};\n\nstruct mlx5_cqwq {\n\tstruct mlx5_frag_buf_ctrl fbc;\n\t__be32\t\t\t  *db;\n\tu32\t\t\t  cc;  \n};\n\nstruct mlx5_wq_ll {\n\tstruct mlx5_frag_buf_ctrl fbc;\n\t__be32\t\t\t*db;\n\t__be16\t\t\t*tail_next;\n\tu16\t\t\thead;\n\tu16\t\t\twqe_ctr;\n\tu16\t\t\tcur_sz;\n};\n\nint mlx5_wq_cyc_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\n\t\t       void *wqc, struct mlx5_wq_cyc *wq,\n\t\t       struct mlx5_wq_ctrl *wq_ctrl);\nvoid mlx5_wq_cyc_wqe_dump(struct mlx5_wq_cyc *wq, u16 ix, u8 nstrides);\nvoid mlx5_wq_cyc_reset(struct mlx5_wq_cyc *wq);\n\nint mlx5_wq_qp_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\n\t\t      void *qpc, struct mlx5_wq_qp *wq,\n\t\t      struct mlx5_wq_ctrl *wq_ctrl);\n\nint mlx5_cqwq_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\n\t\t     void *cqc, struct mlx5_cqwq *wq,\n\t\t     struct mlx5_wq_ctrl *wq_ctrl);\n\nint mlx5_wq_ll_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\n\t\t      void *wqc, struct mlx5_wq_ll *wq,\n\t\t      struct mlx5_wq_ctrl *wq_ctrl);\nvoid mlx5_wq_ll_reset(struct mlx5_wq_ll *wq);\n\nvoid mlx5_wq_destroy(struct mlx5_wq_ctrl *wq_ctrl);\n\nstatic inline u32 mlx5_wq_cyc_get_size(struct mlx5_wq_cyc *wq)\n{\n\treturn (u32)wq->fbc.sz_m1 + 1;\n}\n\nstatic inline int mlx5_wq_cyc_is_full(struct mlx5_wq_cyc *wq)\n{\n\treturn wq->cur_sz == wq->sz;\n}\n\nstatic inline int mlx5_wq_cyc_missing(struct mlx5_wq_cyc *wq)\n{\n\treturn wq->sz - wq->cur_sz;\n}\n\nstatic inline int mlx5_wq_cyc_is_empty(struct mlx5_wq_cyc *wq)\n{\n\treturn !wq->cur_sz;\n}\n\nstatic inline void mlx5_wq_cyc_push(struct mlx5_wq_cyc *wq)\n{\n\twq->wqe_ctr++;\n\twq->cur_sz++;\n}\n\nstatic inline void mlx5_wq_cyc_push_n(struct mlx5_wq_cyc *wq, u16 n)\n{\n\twq->wqe_ctr += n;\n\twq->cur_sz += n;\n}\n\nstatic inline void mlx5_wq_cyc_pop(struct mlx5_wq_cyc *wq)\n{\n\twq->cur_sz--;\n}\n\nstatic inline void mlx5_wq_cyc_update_db_record(struct mlx5_wq_cyc *wq)\n{\n\t*wq->db = cpu_to_be32(wq->wqe_ctr);\n}\n\nstatic inline u16 mlx5_wq_cyc_ctr2ix(struct mlx5_wq_cyc *wq, u16 ctr)\n{\n\treturn ctr & wq->fbc.sz_m1;\n}\n\nstatic inline u16 mlx5_wq_cyc_get_head(struct mlx5_wq_cyc *wq)\n{\n\treturn mlx5_wq_cyc_ctr2ix(wq, wq->wqe_ctr);\n}\n\nstatic inline u16 mlx5_wq_cyc_get_tail(struct mlx5_wq_cyc *wq)\n{\n\treturn mlx5_wq_cyc_ctr2ix(wq, wq->wqe_ctr - wq->cur_sz);\n}\n\nstatic inline void *mlx5_wq_cyc_get_wqe(struct mlx5_wq_cyc *wq, u16 ix)\n{\n\treturn mlx5_frag_buf_get_wqe(&wq->fbc, ix);\n}\n\nstatic inline u16 mlx5_wq_cyc_get_contig_wqebbs(struct mlx5_wq_cyc *wq, u16 ix)\n{\n\treturn mlx5_frag_buf_get_idx_last_contig_stride(&wq->fbc, ix) - ix + 1;\n}\n\nstatic inline int mlx5_wq_cyc_cc_bigger(u16 cc1, u16 cc2)\n{\n\tint equal   = (cc1 == cc2);\n\tint smaller = 0x8000 & (cc1 - cc2);\n\n\treturn !equal && !smaller;\n}\n\nstatic inline u16 mlx5_wq_cyc_get_counter(struct mlx5_wq_cyc *wq)\n{\n\treturn wq->wqe_ctr;\n}\n\nstatic inline u32 mlx5_cqwq_get_size(struct mlx5_cqwq *wq)\n{\n\treturn wq->fbc.sz_m1 + 1;\n}\n\nstatic inline u8 mlx5_cqwq_get_log_stride_size(struct mlx5_cqwq *wq)\n{\n\treturn wq->fbc.log_stride;\n}\n\nstatic inline u32 mlx5_cqwq_ctr2ix(struct mlx5_cqwq *wq, u32 ctr)\n{\n\treturn ctr & wq->fbc.sz_m1;\n}\n\nstatic inline u32 mlx5_cqwq_get_ci(struct mlx5_cqwq *wq)\n{\n\treturn mlx5_cqwq_ctr2ix(wq, wq->cc);\n}\n\nstatic inline struct mlx5_cqe64 *mlx5_cqwq_get_wqe(struct mlx5_cqwq *wq, u32 ix)\n{\n\tstruct mlx5_cqe64 *cqe = mlx5_frag_buf_get_wqe(&wq->fbc, ix);\n\n\t \n\tcqe += wq->fbc.log_stride == 7;\n\n\treturn cqe;\n}\n\nstatic inline u32 mlx5_cqwq_get_ctr_wrap_cnt(struct mlx5_cqwq *wq, u32 ctr)\n{\n\treturn ctr >> wq->fbc.log_sz;\n}\n\nstatic inline u32 mlx5_cqwq_get_wrap_cnt(struct mlx5_cqwq *wq)\n{\n\treturn mlx5_cqwq_get_ctr_wrap_cnt(wq, wq->cc);\n}\n\nstatic inline void mlx5_cqwq_pop(struct mlx5_cqwq *wq)\n{\n\twq->cc++;\n}\n\nstatic inline void mlx5_cqwq_update_db_record(struct mlx5_cqwq *wq)\n{\n\t*wq->db = cpu_to_be32(wq->cc & 0xffffff);\n}\n\nstatic inline struct mlx5_cqe64 *mlx5_cqwq_get_cqe(struct mlx5_cqwq *wq)\n{\n\tu32 ci = mlx5_cqwq_get_ci(wq);\n\tstruct mlx5_cqe64 *cqe = mlx5_cqwq_get_wqe(wq, ci);\n\tu8 cqe_ownership_bit = cqe->op_own & MLX5_CQE_OWNER_MASK;\n\tu8 sw_ownership_val = mlx5_cqwq_get_wrap_cnt(wq) & 1;\n\n\tif (cqe_ownership_bit != sw_ownership_val)\n\t\treturn NULL;\n\n\t \n\tdma_rmb();\n\n\treturn cqe;\n}\n\nstatic inline\nstruct mlx5_cqe64 *mlx5_cqwq_get_cqe_enahnced_comp(struct mlx5_cqwq *wq)\n{\n\tu8 sw_validity_iteration_count = mlx5_cqwq_get_wrap_cnt(wq) & 0xff;\n\tu32 ci = mlx5_cqwq_get_ci(wq);\n\tstruct mlx5_cqe64 *cqe;\n\n\tcqe = mlx5_cqwq_get_wqe(wq, ci);\n\tif (cqe->validity_iteration_count != sw_validity_iteration_count)\n\t\treturn NULL;\n\n\t \n\tdma_rmb();\n\n\treturn cqe;\n}\n\nstatic inline u32 mlx5_wq_ll_get_size(struct mlx5_wq_ll *wq)\n{\n\treturn (u32)wq->fbc.sz_m1 + 1;\n}\n\nstatic inline int mlx5_wq_ll_is_full(struct mlx5_wq_ll *wq)\n{\n\treturn wq->cur_sz == wq->fbc.sz_m1;\n}\n\nstatic inline int mlx5_wq_ll_is_empty(struct mlx5_wq_ll *wq)\n{\n\treturn !wq->cur_sz;\n}\n\nstatic inline int mlx5_wq_ll_missing(struct mlx5_wq_ll *wq)\n{\n\treturn wq->fbc.sz_m1 - wq->cur_sz;\n}\n\nstatic inline void *mlx5_wq_ll_get_wqe(struct mlx5_wq_ll *wq, u16 ix)\n{\n\treturn mlx5_frag_buf_get_wqe(&wq->fbc, ix);\n}\n\nstatic inline u16 mlx5_wq_ll_get_wqe_next_ix(struct mlx5_wq_ll *wq, u16 ix)\n{\n\tstruct mlx5_wqe_srq_next_seg *wqe = mlx5_wq_ll_get_wqe(wq, ix);\n\n\treturn be16_to_cpu(wqe->next_wqe_index);\n}\n\nstatic inline void mlx5_wq_ll_push(struct mlx5_wq_ll *wq, u16 head_next)\n{\n\twq->head = head_next;\n\twq->wqe_ctr++;\n\twq->cur_sz++;\n}\n\nstatic inline void mlx5_wq_ll_pop(struct mlx5_wq_ll *wq, __be16 ix,\n\t\t\t\t  __be16 *next_tail_next)\n{\n\t*wq->tail_next = ix;\n\twq->tail_next = next_tail_next;\n\twq->cur_sz--;\n}\n\nstatic inline void mlx5_wq_ll_update_db_record(struct mlx5_wq_ll *wq)\n{\n\t*wq->db = cpu_to_be32(wq->wqe_ctr);\n}\n\nstatic inline u16 mlx5_wq_ll_get_head(struct mlx5_wq_ll *wq)\n{\n\treturn wq->head;\n}\n\nstatic inline u16 mlx5_wq_ll_get_counter(struct mlx5_wq_ll *wq)\n{\n\treturn wq->wqe_ctr;\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}