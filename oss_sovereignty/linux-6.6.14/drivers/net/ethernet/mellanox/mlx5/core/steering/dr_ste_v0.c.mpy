{
  "module_name": "dr_ste_v0.c",
  "hash_id": "4f7bb6e1b61af82bd172c75fec1194a42c6f761446d782231c7756b6f0999107",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_ste_v0.c",
  "human_readable_source": "\n \n\n#include <linux/types.h>\n#include <linux/crc32.h>\n#include \"dr_ste.h\"\n\n#define SVLAN_ETHERTYPE\t\t0x88a8\n#define DR_STE_ENABLE_FLOW_TAG\tBIT(31)\n\nenum dr_ste_v0_entry_type {\n\tDR_STE_TYPE_TX          = 1,\n\tDR_STE_TYPE_RX          = 2,\n\tDR_STE_TYPE_MODIFY_PKT  = 6,\n};\n\nenum dr_ste_v0_action_tunl {\n\tDR_STE_TUNL_ACTION_NONE\t\t= 0,\n\tDR_STE_TUNL_ACTION_ENABLE\t= 1,\n\tDR_STE_TUNL_ACTION_DECAP\t= 2,\n\tDR_STE_TUNL_ACTION_L3_DECAP\t= 3,\n\tDR_STE_TUNL_ACTION_POP_VLAN\t= 4,\n};\n\nenum dr_ste_v0_action_type {\n\tDR_STE_ACTION_TYPE_PUSH_VLAN\t= 1,\n\tDR_STE_ACTION_TYPE_ENCAP_L3\t= 3,\n\tDR_STE_ACTION_TYPE_ENCAP\t= 4,\n};\n\nenum dr_ste_v0_action_mdfy_op {\n\tDR_STE_ACTION_MDFY_OP_COPY\t= 0x1,\n\tDR_STE_ACTION_MDFY_OP_SET\t= 0x2,\n\tDR_STE_ACTION_MDFY_OP_ADD\t= 0x3,\n};\n\n#define DR_STE_CALC_LU_TYPE(lookup_type, rx, inner) \\\n\t((inner) ? DR_STE_V0_LU_TYPE_##lookup_type##_I : \\\n\t\t   (rx) ? DR_STE_V0_LU_TYPE_##lookup_type##_D : \\\n\t\t\t  DR_STE_V0_LU_TYPE_##lookup_type##_O)\n\nenum {\n\tDR_STE_V0_LU_TYPE_NOP\t\t\t\t= 0x00,\n\tDR_STE_V0_LU_TYPE_SRC_GVMI_AND_QP\t\t= 0x05,\n\tDR_STE_V0_LU_TYPE_ETHL2_TUNNELING_I\t\t= 0x0a,\n\tDR_STE_V0_LU_TYPE_ETHL2_DST_O\t\t\t= 0x06,\n\tDR_STE_V0_LU_TYPE_ETHL2_DST_I\t\t\t= 0x07,\n\tDR_STE_V0_LU_TYPE_ETHL2_DST_D\t\t\t= 0x1b,\n\tDR_STE_V0_LU_TYPE_ETHL2_SRC_O\t\t\t= 0x08,\n\tDR_STE_V0_LU_TYPE_ETHL2_SRC_I\t\t\t= 0x09,\n\tDR_STE_V0_LU_TYPE_ETHL2_SRC_D\t\t\t= 0x1c,\n\tDR_STE_V0_LU_TYPE_ETHL2_SRC_DST_O\t\t= 0x36,\n\tDR_STE_V0_LU_TYPE_ETHL2_SRC_DST_I\t\t= 0x37,\n\tDR_STE_V0_LU_TYPE_ETHL2_SRC_DST_D\t\t= 0x38,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV6_DST_O\t\t= 0x0d,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV6_DST_I\t\t= 0x0e,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV6_DST_D\t\t= 0x1e,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV6_SRC_O\t\t= 0x0f,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV6_SRC_I\t\t= 0x10,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV6_SRC_D\t\t= 0x1f,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV4_5_TUPLE_O\t\t= 0x11,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV4_5_TUPLE_I\t\t= 0x12,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV4_5_TUPLE_D\t\t= 0x20,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV4_MISC_O\t\t= 0x29,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV4_MISC_I\t\t= 0x2a,\n\tDR_STE_V0_LU_TYPE_ETHL3_IPV4_MISC_D\t\t= 0x2b,\n\tDR_STE_V0_LU_TYPE_ETHL4_O\t\t\t= 0x13,\n\tDR_STE_V0_LU_TYPE_ETHL4_I\t\t\t= 0x14,\n\tDR_STE_V0_LU_TYPE_ETHL4_D\t\t\t= 0x21,\n\tDR_STE_V0_LU_TYPE_ETHL4_MISC_O\t\t\t= 0x2c,\n\tDR_STE_V0_LU_TYPE_ETHL4_MISC_I\t\t\t= 0x2d,\n\tDR_STE_V0_LU_TYPE_ETHL4_MISC_D\t\t\t= 0x2e,\n\tDR_STE_V0_LU_TYPE_MPLS_FIRST_O\t\t\t= 0x15,\n\tDR_STE_V0_LU_TYPE_MPLS_FIRST_I\t\t\t= 0x24,\n\tDR_STE_V0_LU_TYPE_MPLS_FIRST_D\t\t\t= 0x25,\n\tDR_STE_V0_LU_TYPE_GRE\t\t\t\t= 0x16,\n\tDR_STE_V0_LU_TYPE_FLEX_PARSER_0\t\t\t= 0x22,\n\tDR_STE_V0_LU_TYPE_FLEX_PARSER_1\t\t\t= 0x23,\n\tDR_STE_V0_LU_TYPE_FLEX_PARSER_TNL_HEADER\t= 0x19,\n\tDR_STE_V0_LU_TYPE_GENERAL_PURPOSE\t\t= 0x18,\n\tDR_STE_V0_LU_TYPE_STEERING_REGISTERS_0\t\t= 0x2f,\n\tDR_STE_V0_LU_TYPE_STEERING_REGISTERS_1\t\t= 0x30,\n\tDR_STE_V0_LU_TYPE_TUNNEL_HEADER\t\t\t= 0x34,\n\tDR_STE_V0_LU_TYPE_DONT_CARE\t\t\t= MLX5DR_STE_LU_TYPE_DONT_CARE,\n};\n\nenum {\n\tDR_STE_V0_ACTION_MDFY_FLD_L2_0\t\t= 0,\n\tDR_STE_V0_ACTION_MDFY_FLD_L2_1\t\t= 1,\n\tDR_STE_V0_ACTION_MDFY_FLD_L2_2\t\t= 2,\n\tDR_STE_V0_ACTION_MDFY_FLD_L3_0\t\t= 3,\n\tDR_STE_V0_ACTION_MDFY_FLD_L3_1\t\t= 4,\n\tDR_STE_V0_ACTION_MDFY_FLD_L3_2\t\t= 5,\n\tDR_STE_V0_ACTION_MDFY_FLD_L3_3\t\t= 6,\n\tDR_STE_V0_ACTION_MDFY_FLD_L3_4\t\t= 7,\n\tDR_STE_V0_ACTION_MDFY_FLD_L4_0\t\t= 8,\n\tDR_STE_V0_ACTION_MDFY_FLD_L4_1\t\t= 9,\n\tDR_STE_V0_ACTION_MDFY_FLD_MPLS\t\t= 10,\n\tDR_STE_V0_ACTION_MDFY_FLD_L2_TNL_0\t= 11,\n\tDR_STE_V0_ACTION_MDFY_FLD_REG_0\t\t= 12,\n\tDR_STE_V0_ACTION_MDFY_FLD_REG_1\t\t= 13,\n\tDR_STE_V0_ACTION_MDFY_FLD_REG_2\t\t= 14,\n\tDR_STE_V0_ACTION_MDFY_FLD_REG_3\t\t= 15,\n\tDR_STE_V0_ACTION_MDFY_FLD_L4_2\t\t= 16,\n\tDR_STE_V0_ACTION_MDFY_FLD_FLEX_0\t= 17,\n\tDR_STE_V0_ACTION_MDFY_FLD_FLEX_1\t= 18,\n\tDR_STE_V0_ACTION_MDFY_FLD_FLEX_2\t= 19,\n\tDR_STE_V0_ACTION_MDFY_FLD_FLEX_3\t= 20,\n\tDR_STE_V0_ACTION_MDFY_FLD_L2_TNL_1\t= 21,\n\tDR_STE_V0_ACTION_MDFY_FLD_METADATA\t= 22,\n\tDR_STE_V0_ACTION_MDFY_FLD_RESERVED\t= 23,\n};\n\nstatic const struct mlx5dr_ste_action_modify_field dr_ste_v0_action_modify_field_arr[] = {\n\t[MLX5_ACTION_IN_FIELD_OUT_SMAC_47_16] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L2_1, .start = 16, .end = 47,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SMAC_15_0] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L2_1, .start = 0, .end = 15,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_ETHERTYPE] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L2_2, .start = 32, .end = 47,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DMAC_47_16] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L2_0, .start = 16, .end = 47,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DMAC_15_0] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L2_0, .start = 0, .end = 15,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_IP_DSCP] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_1, .start = 0, .end = 5,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_TCP_FLAGS] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L4_0, .start = 48, .end = 56,\n\t\t.l4_type = DR_STE_ACTION_MDFY_TYPE_L4_TCP,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_TCP_SPORT] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L4_0, .start = 0, .end = 15,\n\t\t.l4_type = DR_STE_ACTION_MDFY_TYPE_L4_TCP,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_TCP_DPORT] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L4_0, .start = 16, .end = 31,\n\t\t.l4_type = DR_STE_ACTION_MDFY_TYPE_L4_TCP,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_IP_TTL] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_1, .start = 8, .end = 15,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV4,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_IPV6_HOPLIMIT] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_1, .start = 8, .end = 15,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_UDP_SPORT] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L4_0, .start = 0, .end = 15,\n\t\t.l4_type = DR_STE_ACTION_MDFY_TYPE_L4_UDP,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_UDP_DPORT] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L4_0, .start = 16, .end = 31,\n\t\t.l4_type = DR_STE_ACTION_MDFY_TYPE_L4_UDP,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SIPV6_127_96] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_3, .start = 32, .end = 63,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SIPV6_95_64] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_3, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SIPV6_63_32] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_4, .start = 32, .end = 63,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SIPV6_31_0] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_4, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DIPV6_127_96] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_0, .start = 32, .end = 63,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DIPV6_95_64] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_0, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DIPV6_63_32] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_2, .start = 32, .end = 63,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DIPV6_31_0] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_2, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV6,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_SIPV4] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_0, .start = 0, .end = 31,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV4,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_DIPV4] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L3_0, .start = 32, .end = 63,\n\t\t.l3_type = DR_STE_ACTION_MDFY_TYPE_L3_IPV4,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_A] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_METADATA, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_B] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_METADATA, .start = 32, .end = 63,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_0] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_REG_0, .start = 32, .end = 63,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_1] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_REG_0, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_2] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_REG_1, .start = 32, .end = 63,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_3] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_REG_1, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_4] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_REG_2, .start = 32, .end = 63,\n\t},\n\t[MLX5_ACTION_IN_FIELD_METADATA_REG_C_5] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_REG_2, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_TCP_SEQ_NUM] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L4_1, .start = 32, .end = 63,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_TCP_ACK_NUM] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L4_1, .start = 0, .end = 31,\n\t},\n\t[MLX5_ACTION_IN_FIELD_OUT_FIRST_VID] = {\n\t\t.hw_field = DR_STE_V0_ACTION_MDFY_FLD_L2_2, .start = 0, .end = 15,\n\t},\n};\n\nstatic void dr_ste_v0_set_entry_type(u8 *hw_ste_p, u8 entry_type)\n{\n\tMLX5_SET(ste_general, hw_ste_p, entry_type, entry_type);\n}\n\nstatic u8 dr_ste_v0_get_entry_type(u8 *hw_ste_p)\n{\n\treturn MLX5_GET(ste_general, hw_ste_p, entry_type);\n}\n\nstatic void dr_ste_v0_set_miss_addr(u8 *hw_ste_p, u64 miss_addr)\n{\n\tu64 index = miss_addr >> 6;\n\n\t \n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, miss_address_39_32, index >> 26);\n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, miss_address_31_6, index);\n}\n\nstatic u64 dr_ste_v0_get_miss_addr(u8 *hw_ste_p)\n{\n\tu64 index =\n\t\t((u64)MLX5_GET(ste_rx_steering_mult, hw_ste_p, miss_address_31_6) |\n\t\t ((u64)MLX5_GET(ste_rx_steering_mult, hw_ste_p, miss_address_39_32)) << 26);\n\n\treturn index << 6;\n}\n\nstatic void dr_ste_v0_set_byte_mask(u8 *hw_ste_p, u16 byte_mask)\n{\n\tMLX5_SET(ste_general, hw_ste_p, byte_mask, byte_mask);\n}\n\nstatic u16 dr_ste_v0_get_byte_mask(u8 *hw_ste_p)\n{\n\treturn MLX5_GET(ste_general, hw_ste_p, byte_mask);\n}\n\nstatic void dr_ste_v0_set_lu_type(u8 *hw_ste_p, u16 lu_type)\n{\n\tMLX5_SET(ste_general, hw_ste_p, entry_sub_type, lu_type);\n}\n\nstatic void dr_ste_v0_set_next_lu_type(u8 *hw_ste_p, u16 lu_type)\n{\n\tMLX5_SET(ste_general, hw_ste_p, next_lu_type, lu_type);\n}\n\nstatic u16 dr_ste_v0_get_next_lu_type(u8 *hw_ste_p)\n{\n\treturn MLX5_GET(ste_general, hw_ste_p, next_lu_type);\n}\n\nstatic void dr_ste_v0_set_hit_gvmi(u8 *hw_ste_p, u16 gvmi)\n{\n\tMLX5_SET(ste_general, hw_ste_p, next_table_base_63_48, gvmi);\n}\n\nstatic void dr_ste_v0_set_hit_addr(u8 *hw_ste_p, u64 icm_addr, u32 ht_size)\n{\n\tu64 index = (icm_addr >> 5) | ht_size;\n\n\tMLX5_SET(ste_general, hw_ste_p, next_table_base_39_32_size, index >> 27);\n\tMLX5_SET(ste_general, hw_ste_p, next_table_base_31_5_size, index);\n}\n\nstatic void dr_ste_v0_init_full(u8 *hw_ste_p, u16 lu_type,\n\t\t\t\tenum dr_ste_v0_entry_type entry_type, u16 gvmi)\n{\n\tdr_ste_v0_set_entry_type(hw_ste_p, entry_type);\n\tdr_ste_v0_set_lu_type(hw_ste_p, lu_type);\n\tdr_ste_v0_set_next_lu_type(hw_ste_p, MLX5DR_STE_LU_TYPE_DONT_CARE);\n\n\t \n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, gvmi, gvmi);\n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, next_table_base_63_48, gvmi);\n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, miss_address_63_48, gvmi);\n}\n\nstatic void dr_ste_v0_init(u8 *hw_ste_p, u16 lu_type,\n\t\t\t   bool is_rx, u16 gvmi)\n{\n\tenum dr_ste_v0_entry_type entry_type;\n\n\tentry_type = is_rx ? DR_STE_TYPE_RX : DR_STE_TYPE_TX;\n\tdr_ste_v0_init_full(hw_ste_p, lu_type, entry_type, gvmi);\n}\n\nstatic void dr_ste_v0_rx_set_flow_tag(u8 *hw_ste_p, u32 flow_tag)\n{\n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, qp_list_pointer,\n\t\t DR_STE_ENABLE_FLOW_TAG | flow_tag);\n}\n\nstatic void dr_ste_v0_set_counter_id(u8 *hw_ste_p, u32 ctr_id)\n{\n\t \n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, counter_trigger_15_0, ctr_id);\n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, counter_trigger_23_16, ctr_id >> 16);\n}\n\nstatic void dr_ste_v0_set_go_back_bit(u8 *hw_ste_p)\n{\n\tMLX5_SET(ste_sx_transmit, hw_ste_p, go_back, 1);\n}\n\nstatic void dr_ste_v0_set_tx_push_vlan(u8 *hw_ste_p, u32 vlan_hdr,\n\t\t\t\t       bool go_back)\n{\n\tMLX5_SET(ste_sx_transmit, hw_ste_p, action_type,\n\t\t DR_STE_ACTION_TYPE_PUSH_VLAN);\n\tMLX5_SET(ste_sx_transmit, hw_ste_p, encap_pointer_vlan_data, vlan_hdr);\n\t \n\tif (go_back)\n\t\tdr_ste_v0_set_go_back_bit(hw_ste_p);\n}\n\nstatic void dr_ste_v0_set_tx_encap(void *hw_ste_p, u32 reformat_id,\n\t\t\t\t   int size, bool encap_l3)\n{\n\tMLX5_SET(ste_sx_transmit, hw_ste_p, action_type,\n\t\t encap_l3 ? DR_STE_ACTION_TYPE_ENCAP_L3 : DR_STE_ACTION_TYPE_ENCAP);\n\t \n\tMLX5_SET(ste_sx_transmit, hw_ste_p, action_description, size / 2);\n\tMLX5_SET(ste_sx_transmit, hw_ste_p, encap_pointer_vlan_data, reformat_id);\n}\n\nstatic void dr_ste_v0_set_rx_decap(u8 *hw_ste_p)\n{\n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, tunneling_action,\n\t\t DR_STE_TUNL_ACTION_DECAP);\n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, fail_on_error, 1);\n}\n\nstatic void dr_ste_v0_set_rx_pop_vlan(u8 *hw_ste_p)\n{\n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, tunneling_action,\n\t\t DR_STE_TUNL_ACTION_POP_VLAN);\n}\n\nstatic void dr_ste_v0_set_rx_decap_l3(u8 *hw_ste_p, bool vlan)\n{\n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, tunneling_action,\n\t\t DR_STE_TUNL_ACTION_L3_DECAP);\n\tMLX5_SET(ste_modify_packet, hw_ste_p, action_description, vlan ? 1 : 0);\n\tMLX5_SET(ste_rx_steering_mult, hw_ste_p, fail_on_error, 1);\n}\n\nstatic void dr_ste_v0_set_rewrite_actions(u8 *hw_ste_p, u16 num_of_actions,\n\t\t\t\t\t  u32 re_write_index)\n{\n\tMLX5_SET(ste_modify_packet, hw_ste_p, number_of_re_write_actions,\n\t\t num_of_actions);\n\tMLX5_SET(ste_modify_packet, hw_ste_p, header_re_write_actions_pointer,\n\t\t re_write_index);\n}\n\nstatic void dr_ste_v0_arr_init_next(u8 **last_ste,\n\t\t\t\t    u32 *added_stes,\n\t\t\t\t    enum dr_ste_v0_entry_type entry_type,\n\t\t\t\t    u16 gvmi)\n{\n\t(*added_stes)++;\n\t*last_ste += DR_STE_SIZE;\n\tdr_ste_v0_init_full(*last_ste, MLX5DR_STE_LU_TYPE_DONT_CARE,\n\t\t\t    entry_type, gvmi);\n}\n\nstatic void\ndr_ste_v0_set_actions_tx(struct mlx5dr_domain *dmn,\n\t\t\t u8 *action_type_set,\n\t\t\t u32 actions_caps,\n\t\t\t u8 *last_ste,\n\t\t\t struct mlx5dr_ste_actions_attr *attr,\n\t\t\t u32 *added_stes)\n{\n\tbool encap = action_type_set[DR_ACTION_TYP_L2_TO_TNL_L2] ||\n\t\taction_type_set[DR_ACTION_TYP_L2_TO_TNL_L3];\n\n\t \n\tif (action_type_set[DR_ACTION_TYP_MODIFY_HDR] && attr->modify_actions) {\n\t\tdr_ste_v0_set_entry_type(last_ste, DR_STE_TYPE_MODIFY_PKT);\n\t\tdr_ste_v0_set_rewrite_actions(last_ste,\n\t\t\t\t\t      attr->modify_actions,\n\t\t\t\t\t      attr->modify_index);\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_PUSH_VLAN]) {\n\t\tint i;\n\n\t\tfor (i = 0; i < attr->vlans.count; i++) {\n\t\t\tif (i || action_type_set[DR_ACTION_TYP_MODIFY_HDR])\n\t\t\t\tdr_ste_v0_arr_init_next(&last_ste,\n\t\t\t\t\t\t\tadded_stes,\n\t\t\t\t\t\t\tDR_STE_TYPE_TX,\n\t\t\t\t\t\t\tattr->gvmi);\n\n\t\t\tdr_ste_v0_set_tx_push_vlan(last_ste,\n\t\t\t\t\t\t   attr->vlans.headers[i],\n\t\t\t\t\t\t   encap);\n\t\t}\n\t}\n\n\tif (encap) {\n\t\t \n\t\tif (action_type_set[DR_ACTION_TYP_MODIFY_HDR] ||\n\t\t    action_type_set[DR_ACTION_TYP_PUSH_VLAN])\n\t\t\tdr_ste_v0_arr_init_next(&last_ste,\n\t\t\t\t\t\tadded_stes,\n\t\t\t\t\t\tDR_STE_TYPE_TX,\n\t\t\t\t\t\tattr->gvmi);\n\n\t\tdr_ste_v0_set_tx_encap(last_ste,\n\t\t\t\t       attr->reformat.id,\n\t\t\t\t       attr->reformat.size,\n\t\t\t\t       action_type_set[DR_ACTION_TYP_L2_TO_TNL_L3]);\n\t\t \n\t\tif (MLX5_CAP_GEN(dmn->mdev, prio_tag_required))\n\t\t\tdr_ste_v0_set_go_back_bit(last_ste);\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_CTR])\n\t\tdr_ste_v0_set_counter_id(last_ste, attr->ctr_id);\n\n\tdr_ste_v0_set_hit_gvmi(last_ste, attr->hit_gvmi);\n\tdr_ste_v0_set_hit_addr(last_ste, attr->final_icm_addr, 1);\n}\n\nstatic void\ndr_ste_v0_set_actions_rx(struct mlx5dr_domain *dmn,\n\t\t\t u8 *action_type_set,\n\t\t\t u32 actions_caps,\n\t\t\t u8 *last_ste,\n\t\t\t struct mlx5dr_ste_actions_attr *attr,\n\t\t\t u32 *added_stes)\n{\n\tif (action_type_set[DR_ACTION_TYP_CTR])\n\t\tdr_ste_v0_set_counter_id(last_ste, attr->ctr_id);\n\n\tif (action_type_set[DR_ACTION_TYP_TNL_L3_TO_L2]) {\n\t\tdr_ste_v0_set_entry_type(last_ste, DR_STE_TYPE_MODIFY_PKT);\n\t\tdr_ste_v0_set_rx_decap_l3(last_ste, attr->decap_with_vlan);\n\t\tdr_ste_v0_set_rewrite_actions(last_ste,\n\t\t\t\t\t      attr->decap_actions,\n\t\t\t\t\t      attr->decap_index);\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_TNL_L2_TO_L2])\n\t\tdr_ste_v0_set_rx_decap(last_ste);\n\n\tif (action_type_set[DR_ACTION_TYP_POP_VLAN]) {\n\t\tint i;\n\n\t\tfor (i = 0; i < attr->vlans.count; i++) {\n\t\t\tif (i ||\n\t\t\t    action_type_set[DR_ACTION_TYP_TNL_L2_TO_L2] ||\n\t\t\t    action_type_set[DR_ACTION_TYP_TNL_L3_TO_L2])\n\t\t\t\tdr_ste_v0_arr_init_next(&last_ste,\n\t\t\t\t\t\t\tadded_stes,\n\t\t\t\t\t\t\tDR_STE_TYPE_RX,\n\t\t\t\t\t\t\tattr->gvmi);\n\n\t\t\tdr_ste_v0_set_rx_pop_vlan(last_ste);\n\t\t}\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_MODIFY_HDR] && attr->modify_actions) {\n\t\tif (dr_ste_v0_get_entry_type(last_ste) == DR_STE_TYPE_MODIFY_PKT)\n\t\t\tdr_ste_v0_arr_init_next(&last_ste,\n\t\t\t\t\t\tadded_stes,\n\t\t\t\t\t\tDR_STE_TYPE_MODIFY_PKT,\n\t\t\t\t\t\tattr->gvmi);\n\t\telse\n\t\t\tdr_ste_v0_set_entry_type(last_ste, DR_STE_TYPE_MODIFY_PKT);\n\n\t\tdr_ste_v0_set_rewrite_actions(last_ste,\n\t\t\t\t\t      attr->modify_actions,\n\t\t\t\t\t      attr->modify_index);\n\t}\n\n\tif (action_type_set[DR_ACTION_TYP_TAG]) {\n\t\tif (dr_ste_v0_get_entry_type(last_ste) == DR_STE_TYPE_MODIFY_PKT)\n\t\t\tdr_ste_v0_arr_init_next(&last_ste,\n\t\t\t\t\t\tadded_stes,\n\t\t\t\t\t\tDR_STE_TYPE_RX,\n\t\t\t\t\t\tattr->gvmi);\n\n\t\tdr_ste_v0_rx_set_flow_tag(last_ste, attr->flow_tag);\n\t}\n\n\tdr_ste_v0_set_hit_gvmi(last_ste, attr->hit_gvmi);\n\tdr_ste_v0_set_hit_addr(last_ste, attr->final_icm_addr, 1);\n}\n\nstatic void dr_ste_v0_set_action_set(u8 *hw_action,\n\t\t\t\t     u8 hw_field,\n\t\t\t\t     u8 shifter,\n\t\t\t\t     u8 length,\n\t\t\t\t     u32 data)\n{\n\tlength = (length == 32) ? 0 : length;\n\tMLX5_SET(dr_action_hw_set, hw_action, opcode, DR_STE_ACTION_MDFY_OP_SET);\n\tMLX5_SET(dr_action_hw_set, hw_action, destination_field_code, hw_field);\n\tMLX5_SET(dr_action_hw_set, hw_action, destination_left_shifter, shifter);\n\tMLX5_SET(dr_action_hw_set, hw_action, destination_length, length);\n\tMLX5_SET(dr_action_hw_set, hw_action, inline_data, data);\n}\n\nstatic void dr_ste_v0_set_action_add(u8 *hw_action,\n\t\t\t\t     u8 hw_field,\n\t\t\t\t     u8 shifter,\n\t\t\t\t     u8 length,\n\t\t\t\t     u32 data)\n{\n\tlength = (length == 32) ? 0 : length;\n\tMLX5_SET(dr_action_hw_set, hw_action, opcode, DR_STE_ACTION_MDFY_OP_ADD);\n\tMLX5_SET(dr_action_hw_set, hw_action, destination_field_code, hw_field);\n\tMLX5_SET(dr_action_hw_set, hw_action, destination_left_shifter, shifter);\n\tMLX5_SET(dr_action_hw_set, hw_action, destination_length, length);\n\tMLX5_SET(dr_action_hw_set, hw_action, inline_data, data);\n}\n\nstatic void dr_ste_v0_set_action_copy(u8 *hw_action,\n\t\t\t\t      u8 dst_hw_field,\n\t\t\t\t      u8 dst_shifter,\n\t\t\t\t      u8 dst_len,\n\t\t\t\t      u8 src_hw_field,\n\t\t\t\t      u8 src_shifter)\n{\n\tMLX5_SET(dr_action_hw_copy, hw_action, opcode, DR_STE_ACTION_MDFY_OP_COPY);\n\tMLX5_SET(dr_action_hw_copy, hw_action, destination_field_code, dst_hw_field);\n\tMLX5_SET(dr_action_hw_copy, hw_action, destination_left_shifter, dst_shifter);\n\tMLX5_SET(dr_action_hw_copy, hw_action, destination_length, dst_len);\n\tMLX5_SET(dr_action_hw_copy, hw_action, source_field_code, src_hw_field);\n\tMLX5_SET(dr_action_hw_copy, hw_action, source_left_shifter, src_shifter);\n}\n\n#define DR_STE_DECAP_L3_MIN_ACTION_NUM\t5\n\nstatic int\ndr_ste_v0_set_action_decap_l3_list(void *data, u32 data_sz,\n\t\t\t\t   u8 *hw_action, u32 hw_action_sz,\n\t\t\t\t   u16 *used_hw_action_num)\n{\n\tstruct mlx5_ifc_l2_hdr_bits *l2_hdr = data;\n\tu32 hw_action_num;\n\tint required_actions;\n\tu32 hdr_fld_4b;\n\tu16 hdr_fld_2b;\n\tu16 vlan_type;\n\tbool vlan;\n\n\tvlan = (data_sz != HDR_LEN_L2);\n\thw_action_num = hw_action_sz / MLX5_ST_SZ_BYTES(dr_action_hw_set);\n\trequired_actions = DR_STE_DECAP_L3_MIN_ACTION_NUM + !!vlan;\n\n\tif (hw_action_num < required_actions)\n\t\treturn -ENOMEM;\n\n\t \n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t opcode, DR_STE_ACTION_MDFY_OP_SET);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_length, 0);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_field_code, DR_STE_V0_ACTION_MDFY_FLD_L2_0);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_left_shifter, 16);\n\thdr_fld_4b = MLX5_GET(l2_hdr, l2_hdr, dmac_47_16);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t inline_data, hdr_fld_4b);\n\thw_action += MLX5_ST_SZ_BYTES(dr_action_hw_set);\n\n\t \n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t opcode, DR_STE_ACTION_MDFY_OP_SET);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_length, 0);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_field_code, DR_STE_V0_ACTION_MDFY_FLD_L2_1);\n\tMLX5_SET(dr_action_hw_set, hw_action, destination_left_shifter, 16);\n\thdr_fld_4b = (MLX5_GET(l2_hdr, l2_hdr, smac_31_0) >> 16 |\n\t\t      MLX5_GET(l2_hdr, l2_hdr, smac_47_32) << 16);\n\tMLX5_SET(dr_action_hw_set, hw_action, inline_data, hdr_fld_4b);\n\thw_action += MLX5_ST_SZ_BYTES(dr_action_hw_set);\n\n\t \n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t opcode, DR_STE_ACTION_MDFY_OP_SET);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_length, 16);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_field_code, DR_STE_V0_ACTION_MDFY_FLD_L2_0);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_left_shifter, 0);\n\thdr_fld_2b = MLX5_GET(l2_hdr, l2_hdr, dmac_15_0);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t inline_data, hdr_fld_2b);\n\thw_action += MLX5_ST_SZ_BYTES(dr_action_hw_set);\n\n\t \n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t opcode, DR_STE_ACTION_MDFY_OP_SET);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_field_code, DR_STE_V0_ACTION_MDFY_FLD_L2_2);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_left_shifter, 32);\n\tif (!vlan) {\n\t\thdr_fld_2b = MLX5_GET(l2_hdr, l2_hdr, ethertype);\n\t\tMLX5_SET(dr_action_hw_set, hw_action, inline_data, hdr_fld_2b);\n\t\tMLX5_SET(dr_action_hw_set, hw_action, destination_length, 16);\n\t} else {\n\t\thdr_fld_2b = MLX5_GET(l2_hdr, l2_hdr, ethertype);\n\t\tvlan_type = hdr_fld_2b == SVLAN_ETHERTYPE ? DR_STE_SVLAN : DR_STE_CVLAN;\n\t\thdr_fld_2b = MLX5_GET(l2_hdr, l2_hdr, vlan);\n\t\thdr_fld_4b = (vlan_type << 16) | hdr_fld_2b;\n\t\tMLX5_SET(dr_action_hw_set, hw_action, inline_data, hdr_fld_4b);\n\t\tMLX5_SET(dr_action_hw_set, hw_action, destination_length, 18);\n\t}\n\thw_action += MLX5_ST_SZ_BYTES(dr_action_hw_set);\n\n\t \n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t opcode, DR_STE_ACTION_MDFY_OP_SET);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_length, 16);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_field_code, DR_STE_V0_ACTION_MDFY_FLD_L2_1);\n\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t destination_left_shifter, 0);\n\thdr_fld_2b = MLX5_GET(l2_hdr, l2_hdr, smac_31_0);\n\tMLX5_SET(dr_action_hw_set, hw_action, inline_data, hdr_fld_2b);\n\thw_action += MLX5_ST_SZ_BYTES(dr_action_hw_set);\n\n\tif (vlan) {\n\t\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t\t opcode, DR_STE_ACTION_MDFY_OP_SET);\n\t\thdr_fld_2b = MLX5_GET(l2_hdr, l2_hdr, vlan_type);\n\t\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t\t inline_data, hdr_fld_2b);\n\t\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t\t destination_length, 16);\n\t\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t\t destination_field_code, DR_STE_V0_ACTION_MDFY_FLD_L2_2);\n\t\tMLX5_SET(dr_action_hw_set, hw_action,\n\t\t\t destination_left_shifter, 0);\n\t}\n\n\t*used_hw_action_num = required_actions;\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_eth_l2_src_dst_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t\tbool inner, u8 *bit_mask)\n{\n\tstruct mlx5dr_match_spec *mask = inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_src_dst, bit_mask, dmac_47_16, mask, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_src_dst, bit_mask, dmac_15_0, mask, dmac_15_0);\n\n\tif (mask->smac_47_16 || mask->smac_15_0) {\n\t\tMLX5_SET(ste_eth_l2_src_dst, bit_mask, smac_47_32,\n\t\t\t mask->smac_47_16 >> 16);\n\t\tMLX5_SET(ste_eth_l2_src_dst, bit_mask, smac_31_0,\n\t\t\t mask->smac_47_16 << 16 | mask->smac_15_0);\n\t\tmask->smac_47_16 = 0;\n\t\tmask->smac_15_0 = 0;\n\t}\n\n\tDR_STE_SET_TAG(eth_l2_src_dst, bit_mask, first_vlan_id, mask, first_vid);\n\tDR_STE_SET_TAG(eth_l2_src_dst, bit_mask, first_cfi, mask, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_src_dst, bit_mask, first_priority, mask, first_prio);\n\tDR_STE_SET_ONES(eth_l2_src_dst, bit_mask, l3_type, mask, ip_version);\n\n\tif (mask->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_dst, bit_mask, first_vlan_qualifier, -1);\n\t\tmask->cvlan_tag = 0;\n\t} else if (mask->svlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_dst, bit_mask, first_vlan_qualifier, -1);\n\t\tmask->svlan_tag = 0;\n\t}\n}\n\nstatic int\ndr_ste_v0_build_eth_l2_src_dst_tag(struct mlx5dr_match_param *value,\n\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t   u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_src_dst, tag, dmac_47_16, spec, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_src_dst, tag, dmac_15_0, spec, dmac_15_0);\n\n\tif (spec->smac_47_16 || spec->smac_15_0) {\n\t\tMLX5_SET(ste_eth_l2_src_dst, tag, smac_47_32,\n\t\t\t spec->smac_47_16 >> 16);\n\t\tMLX5_SET(ste_eth_l2_src_dst, tag, smac_31_0,\n\t\t\t spec->smac_47_16 << 16 | spec->smac_15_0);\n\t\tspec->smac_47_16 = 0;\n\t\tspec->smac_15_0 = 0;\n\t}\n\n\tif (spec->ip_version) {\n\t\tif (spec->ip_version == IP_VERSION_IPV4) {\n\t\t\tMLX5_SET(ste_eth_l2_src_dst, tag, l3_type, STE_IPV4);\n\t\t\tspec->ip_version = 0;\n\t\t} else if (spec->ip_version == IP_VERSION_IPV6) {\n\t\t\tMLX5_SET(ste_eth_l2_src_dst, tag, l3_type, STE_IPV6);\n\t\t\tspec->ip_version = 0;\n\t\t} else {\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tDR_STE_SET_TAG(eth_l2_src_dst, tag, first_vlan_id, spec, first_vid);\n\tDR_STE_SET_TAG(eth_l2_src_dst, tag, first_cfi, spec, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_src_dst, tag, first_priority, spec, first_prio);\n\n\tif (spec->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_dst, tag, first_vlan_qualifier, DR_STE_CVLAN);\n\t\tspec->cvlan_tag = 0;\n\t} else if (spec->svlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src_dst, tag, first_vlan_qualifier, DR_STE_SVLAN);\n\t\tspec->svlan_tag = 0;\n\t}\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_eth_l2_src_dst_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_eth_l2_src_dst_bit_mask(mask, sb->inner, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_LU_TYPE(ETHL2_SRC_DST, sb->rx, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_eth_l2_src_dst_tag;\n}\n\nstatic int\ndr_ste_v0_build_eth_l3_ipv6_dst_tag(struct mlx5dr_match_param *value,\n\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t    u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l3_ipv6_dst, tag, dst_ip_127_96, spec, dst_ip_127_96);\n\tDR_STE_SET_TAG(eth_l3_ipv6_dst, tag, dst_ip_95_64, spec, dst_ip_95_64);\n\tDR_STE_SET_TAG(eth_l3_ipv6_dst, tag, dst_ip_63_32, spec, dst_ip_63_32);\n\tDR_STE_SET_TAG(eth_l3_ipv6_dst, tag, dst_ip_31_0, spec, dst_ip_31_0);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_eth_l3_ipv6_dst_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t     struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_eth_l3_ipv6_dst_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_LU_TYPE(ETHL3_IPV6_DST, sb->rx, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_eth_l3_ipv6_dst_tag;\n}\n\nstatic int\ndr_ste_v0_build_eth_l3_ipv6_src_tag(struct mlx5dr_match_param *value,\n\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t    u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l3_ipv6_src, tag, src_ip_127_96, spec, src_ip_127_96);\n\tDR_STE_SET_TAG(eth_l3_ipv6_src, tag, src_ip_95_64, spec, src_ip_95_64);\n\tDR_STE_SET_TAG(eth_l3_ipv6_src, tag, src_ip_63_32, spec, src_ip_63_32);\n\tDR_STE_SET_TAG(eth_l3_ipv6_src, tag, src_ip_31_0, spec, src_ip_31_0);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_eth_l3_ipv6_src_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t     struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_eth_l3_ipv6_src_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_LU_TYPE(ETHL3_IPV6_SRC, sb->rx, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_eth_l3_ipv6_src_tag;\n}\n\nstatic int\ndr_ste_v0_build_eth_l3_ipv4_5_tuple_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\tstruct mlx5dr_ste_build *sb,\n\t\t\t\t\tu8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple, tag, destination_address, spec, dst_ip_31_0);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple, tag, source_address, spec, src_ip_31_0);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple, tag, destination_port, spec, tcp_dport);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple, tag, destination_port, spec, udp_dport);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple, tag, source_port, spec, tcp_sport);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple, tag, source_port, spec, udp_sport);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple, tag, protocol, spec, ip_protocol);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple, tag, fragmented, spec, frag);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple, tag, dscp, spec, ip_dscp);\n\tDR_STE_SET_TAG(eth_l3_ipv4_5_tuple, tag, ecn, spec, ip_ecn);\n\n\tif (spec->tcp_flags) {\n\t\tDR_STE_SET_TCP_FLAGS(eth_l3_ipv4_5_tuple, tag, spec);\n\t\tspec->tcp_flags = 0;\n\t}\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_eth_l3_ipv4_5_tuple_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_eth_l3_ipv4_5_tuple_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_LU_TYPE(ETHL3_IPV4_5_TUPLE, sb->rx, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_eth_l3_ipv4_5_tuple_tag;\n}\n\nstatic void\ndr_ste_v0_build_eth_l2_src_or_dst_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t\t   bool inner, u8 *bit_mask)\n{\n\tstruct mlx5dr_match_spec *mask = inner ? &value->inner : &value->outer;\n\tstruct mlx5dr_match_misc *misc_mask = &value->misc;\n\n\tDR_STE_SET_TAG(eth_l2_src, bit_mask, first_vlan_id, mask, first_vid);\n\tDR_STE_SET_TAG(eth_l2_src, bit_mask, first_cfi, mask, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_src, bit_mask, first_priority, mask, first_prio);\n\tDR_STE_SET_TAG(eth_l2_src, bit_mask, ip_fragmented, mask, frag);\n\tDR_STE_SET_TAG(eth_l2_src, bit_mask, l3_ethertype, mask, ethertype);\n\tDR_STE_SET_ONES(eth_l2_src, bit_mask, l3_type, mask, ip_version);\n\n\tif (mask->svlan_tag || mask->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src, bit_mask, first_vlan_qualifier, -1);\n\t\tmask->cvlan_tag = 0;\n\t\tmask->svlan_tag = 0;\n\t}\n\n\tif (inner) {\n\t\tif (misc_mask->inner_second_cvlan_tag ||\n\t\t    misc_mask->inner_second_svlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src, bit_mask, second_vlan_qualifier, -1);\n\t\t\tmisc_mask->inner_second_cvlan_tag = 0;\n\t\t\tmisc_mask->inner_second_svlan_tag = 0;\n\t\t}\n\n\t\tDR_STE_SET_TAG(eth_l2_src, bit_mask,\n\t\t\t       second_vlan_id, misc_mask, inner_second_vid);\n\t\tDR_STE_SET_TAG(eth_l2_src, bit_mask,\n\t\t\t       second_cfi, misc_mask, inner_second_cfi);\n\t\tDR_STE_SET_TAG(eth_l2_src, bit_mask,\n\t\t\t       second_priority, misc_mask, inner_second_prio);\n\t} else {\n\t\tif (misc_mask->outer_second_cvlan_tag ||\n\t\t    misc_mask->outer_second_svlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src, bit_mask, second_vlan_qualifier, -1);\n\t\t\tmisc_mask->outer_second_cvlan_tag = 0;\n\t\t\tmisc_mask->outer_second_svlan_tag = 0;\n\t\t}\n\n\t\tDR_STE_SET_TAG(eth_l2_src, bit_mask,\n\t\t\t       second_vlan_id, misc_mask, outer_second_vid);\n\t\tDR_STE_SET_TAG(eth_l2_src, bit_mask,\n\t\t\t       second_cfi, misc_mask, outer_second_cfi);\n\t\tDR_STE_SET_TAG(eth_l2_src, bit_mask,\n\t\t\t       second_priority, misc_mask, outer_second_prio);\n\t}\n}\n\nstatic int\ndr_ste_v0_build_eth_l2_src_or_dst_tag(struct mlx5dr_match_param *value,\n\t\t\t\t      bool inner, u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = inner ? &value->inner : &value->outer;\n\tstruct mlx5dr_match_misc *misc_spec = &value->misc;\n\n\tDR_STE_SET_TAG(eth_l2_src, tag, first_vlan_id, spec, first_vid);\n\tDR_STE_SET_TAG(eth_l2_src, tag, first_cfi, spec, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_src, tag, first_priority, spec, first_prio);\n\tDR_STE_SET_TAG(eth_l2_src, tag, ip_fragmented, spec, frag);\n\tDR_STE_SET_TAG(eth_l2_src, tag, l3_ethertype, spec, ethertype);\n\n\tif (spec->ip_version) {\n\t\tif (spec->ip_version == IP_VERSION_IPV4) {\n\t\t\tMLX5_SET(ste_eth_l2_src, tag, l3_type, STE_IPV4);\n\t\t\tspec->ip_version = 0;\n\t\t} else if (spec->ip_version == IP_VERSION_IPV6) {\n\t\t\tMLX5_SET(ste_eth_l2_src, tag, l3_type, STE_IPV6);\n\t\t\tspec->ip_version = 0;\n\t\t} else {\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tif (spec->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src, tag, first_vlan_qualifier, DR_STE_CVLAN);\n\t\tspec->cvlan_tag = 0;\n\t} else if (spec->svlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_src, tag, first_vlan_qualifier, DR_STE_SVLAN);\n\t\tspec->svlan_tag = 0;\n\t}\n\n\tif (inner) {\n\t\tif (misc_spec->inner_second_cvlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src, tag, second_vlan_qualifier, DR_STE_CVLAN);\n\t\t\tmisc_spec->inner_second_cvlan_tag = 0;\n\t\t} else if (misc_spec->inner_second_svlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src, tag, second_vlan_qualifier, DR_STE_SVLAN);\n\t\t\tmisc_spec->inner_second_svlan_tag = 0;\n\t\t}\n\n\t\tDR_STE_SET_TAG(eth_l2_src, tag, second_vlan_id, misc_spec, inner_second_vid);\n\t\tDR_STE_SET_TAG(eth_l2_src, tag, second_cfi, misc_spec, inner_second_cfi);\n\t\tDR_STE_SET_TAG(eth_l2_src, tag, second_priority, misc_spec, inner_second_prio);\n\t} else {\n\t\tif (misc_spec->outer_second_cvlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src, tag, second_vlan_qualifier, DR_STE_CVLAN);\n\t\t\tmisc_spec->outer_second_cvlan_tag = 0;\n\t\t} else if (misc_spec->outer_second_svlan_tag) {\n\t\t\tMLX5_SET(ste_eth_l2_src, tag, second_vlan_qualifier, DR_STE_SVLAN);\n\t\t\tmisc_spec->outer_second_svlan_tag = 0;\n\t\t}\n\t\tDR_STE_SET_TAG(eth_l2_src, tag, second_vlan_id, misc_spec, outer_second_vid);\n\t\tDR_STE_SET_TAG(eth_l2_src, tag, second_cfi, misc_spec, outer_second_cfi);\n\t\tDR_STE_SET_TAG(eth_l2_src, tag, second_priority, misc_spec, outer_second_prio);\n\t}\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_eth_l2_src_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t    bool inner, u8 *bit_mask)\n{\n\tstruct mlx5dr_match_spec *mask = inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_src, bit_mask, smac_47_16, mask, smac_47_16);\n\tDR_STE_SET_TAG(eth_l2_src, bit_mask, smac_15_0, mask, smac_15_0);\n\n\tdr_ste_v0_build_eth_l2_src_or_dst_bit_mask(value, inner, bit_mask);\n}\n\nstatic int\ndr_ste_v0_build_eth_l2_src_tag(struct mlx5dr_match_param *value,\n\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t       u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_src, tag, smac_47_16, spec, smac_47_16);\n\tDR_STE_SET_TAG(eth_l2_src, tag, smac_15_0, spec, smac_15_0);\n\n\treturn dr_ste_v0_build_eth_l2_src_or_dst_tag(value, sb->inner, tag);\n}\n\nstatic void\ndr_ste_v0_build_eth_l2_src_init(struct mlx5dr_ste_build *sb,\n\t\t\t\tstruct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_eth_l2_src_bit_mask(mask, sb->inner, sb->bit_mask);\n\tsb->lu_type = DR_STE_CALC_LU_TYPE(ETHL2_SRC, sb->rx, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_eth_l2_src_tag;\n}\n\nstatic void\ndr_ste_v0_build_eth_l2_dst_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t    u8 *bit_mask)\n{\n\tstruct mlx5dr_match_spec *mask = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_dst, bit_mask, dmac_47_16, mask, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_dst, bit_mask, dmac_15_0, mask, dmac_15_0);\n\n\tdr_ste_v0_build_eth_l2_src_or_dst_bit_mask(value, sb->inner, bit_mask);\n}\n\nstatic int\ndr_ste_v0_build_eth_l2_dst_tag(struct mlx5dr_match_param *value,\n\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t       u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l2_dst, tag, dmac_47_16, spec, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_dst, tag, dmac_15_0, spec, dmac_15_0);\n\n\treturn dr_ste_v0_build_eth_l2_src_or_dst_tag(value, sb->inner, tag);\n}\n\nstatic void\ndr_ste_v0_build_eth_l2_dst_init(struct mlx5dr_ste_build *sb,\n\t\t\t\tstruct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_eth_l2_dst_bit_mask(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_LU_TYPE(ETHL2_DST, sb->rx, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_eth_l2_dst_tag;\n}\n\nstatic void\ndr_ste_v0_build_eth_l2_tnl_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t    bool inner, u8 *bit_mask)\n{\n\tstruct mlx5dr_match_spec *mask = inner ? &value->inner : &value->outer;\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\n\tDR_STE_SET_TAG(eth_l2_tnl, bit_mask, dmac_47_16, mask, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_tnl, bit_mask, dmac_15_0, mask, dmac_15_0);\n\tDR_STE_SET_TAG(eth_l2_tnl, bit_mask, first_vlan_id, mask, first_vid);\n\tDR_STE_SET_TAG(eth_l2_tnl, bit_mask, first_cfi, mask, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_tnl, bit_mask, first_priority, mask, first_prio);\n\tDR_STE_SET_TAG(eth_l2_tnl, bit_mask, ip_fragmented, mask, frag);\n\tDR_STE_SET_TAG(eth_l2_tnl, bit_mask, l3_ethertype, mask, ethertype);\n\tDR_STE_SET_ONES(eth_l2_tnl, bit_mask, l3_type, mask, ip_version);\n\n\tif (misc->vxlan_vni) {\n\t\tMLX5_SET(ste_eth_l2_tnl, bit_mask,\n\t\t\t l2_tunneling_network_id, (misc->vxlan_vni << 8));\n\t\tmisc->vxlan_vni = 0;\n\t}\n\n\tif (mask->svlan_tag || mask->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_tnl, bit_mask, first_vlan_qualifier, -1);\n\t\tmask->cvlan_tag = 0;\n\t\tmask->svlan_tag = 0;\n\t}\n}\n\nstatic int\ndr_ste_v0_build_eth_l2_tnl_tag(struct mlx5dr_match_param *value,\n\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t       u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\n\tDR_STE_SET_TAG(eth_l2_tnl, tag, dmac_47_16, spec, dmac_47_16);\n\tDR_STE_SET_TAG(eth_l2_tnl, tag, dmac_15_0, spec, dmac_15_0);\n\tDR_STE_SET_TAG(eth_l2_tnl, tag, first_vlan_id, spec, first_vid);\n\tDR_STE_SET_TAG(eth_l2_tnl, tag, first_cfi, spec, first_cfi);\n\tDR_STE_SET_TAG(eth_l2_tnl, tag, ip_fragmented, spec, frag);\n\tDR_STE_SET_TAG(eth_l2_tnl, tag, first_priority, spec, first_prio);\n\tDR_STE_SET_TAG(eth_l2_tnl, tag, l3_ethertype, spec, ethertype);\n\n\tif (misc->vxlan_vni) {\n\t\tMLX5_SET(ste_eth_l2_tnl, tag, l2_tunneling_network_id,\n\t\t\t (misc->vxlan_vni << 8));\n\t\tmisc->vxlan_vni = 0;\n\t}\n\n\tif (spec->cvlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_tnl, tag, first_vlan_qualifier, DR_STE_CVLAN);\n\t\tspec->cvlan_tag = 0;\n\t} else if (spec->svlan_tag) {\n\t\tMLX5_SET(ste_eth_l2_tnl, tag, first_vlan_qualifier, DR_STE_SVLAN);\n\t\tspec->svlan_tag = 0;\n\t}\n\n\tif (spec->ip_version) {\n\t\tif (spec->ip_version == IP_VERSION_IPV4) {\n\t\t\tMLX5_SET(ste_eth_l2_tnl, tag, l3_type, STE_IPV4);\n\t\t\tspec->ip_version = 0;\n\t\t} else if (spec->ip_version == IP_VERSION_IPV6) {\n\t\t\tMLX5_SET(ste_eth_l2_tnl, tag, l3_type, STE_IPV6);\n\t\t\tspec->ip_version = 0;\n\t\t} else {\n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_eth_l2_tnl_init(struct mlx5dr_ste_build *sb,\n\t\t\t\tstruct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_eth_l2_tnl_bit_mask(mask, sb->inner, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V0_LU_TYPE_ETHL2_TUNNELING_I;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_eth_l2_tnl_tag;\n}\n\nstatic int\ndr_ste_v0_build_eth_l3_ipv4_misc_tag(struct mlx5dr_match_param *value,\n\t\t\t\t     struct mlx5dr_ste_build *sb,\n\t\t\t\t     u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\n\tDR_STE_SET_TAG(eth_l3_ipv4_misc, tag, time_to_live, spec, ttl_hoplimit);\n\tDR_STE_SET_TAG(eth_l3_ipv4_misc, tag, ihl, spec, ipv4_ihl);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_eth_l3_ipv4_misc_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t      struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_eth_l3_ipv4_misc_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_LU_TYPE(ETHL3_IPV4_MISC, sb->rx, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_eth_l3_ipv4_misc_tag;\n}\n\nstatic int\ndr_ste_v0_build_eth_ipv6_l3_l4_tag(struct mlx5dr_match_param *value,\n\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t   u8 *tag)\n{\n\tstruct mlx5dr_match_spec *spec = sb->inner ? &value->inner : &value->outer;\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\n\tDR_STE_SET_TAG(eth_l4, tag, dst_port, spec, tcp_dport);\n\tDR_STE_SET_TAG(eth_l4, tag, src_port, spec, tcp_sport);\n\tDR_STE_SET_TAG(eth_l4, tag, dst_port, spec, udp_dport);\n\tDR_STE_SET_TAG(eth_l4, tag, src_port, spec, udp_sport);\n\tDR_STE_SET_TAG(eth_l4, tag, protocol, spec, ip_protocol);\n\tDR_STE_SET_TAG(eth_l4, tag, fragmented, spec, frag);\n\tDR_STE_SET_TAG(eth_l4, tag, dscp, spec, ip_dscp);\n\tDR_STE_SET_TAG(eth_l4, tag, ecn, spec, ip_ecn);\n\tDR_STE_SET_TAG(eth_l4, tag, ipv6_hop_limit, spec, ttl_hoplimit);\n\n\tif (sb->inner)\n\t\tDR_STE_SET_TAG(eth_l4, tag, flow_label, misc, inner_ipv6_flow_label);\n\telse\n\t\tDR_STE_SET_TAG(eth_l4, tag, flow_label, misc, outer_ipv6_flow_label);\n\n\tif (spec->tcp_flags) {\n\t\tDR_STE_SET_TCP_FLAGS(eth_l4, tag, spec);\n\t\tspec->tcp_flags = 0;\n\t}\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_eth_ipv6_l3_l4_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_eth_ipv6_l3_l4_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_LU_TYPE(ETHL4, sb->rx, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_eth_ipv6_l3_l4_tag;\n}\n\nstatic int\ndr_ste_v0_build_mpls_tag(struct mlx5dr_match_param *value,\n\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\n\tif (sb->inner)\n\t\tDR_STE_SET_MPLS(mpls, misc2, inner, tag);\n\telse\n\t\tDR_STE_SET_MPLS(mpls, misc2, outer, tag);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_mpls_init(struct mlx5dr_ste_build *sb,\n\t\t\t  struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_mpls_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_LU_TYPE(MPLS_FIRST, sb->rx, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_mpls_tag;\n}\n\nstatic int\ndr_ste_v0_build_tnl_gre_tag(struct mlx5dr_match_param *value,\n\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t    u8 *tag)\n{\n\tstruct  mlx5dr_match_misc *misc = &value->misc;\n\n\tDR_STE_SET_TAG(gre, tag, gre_protocol, misc, gre_protocol);\n\n\tDR_STE_SET_TAG(gre, tag, gre_k_present, misc, gre_k_present);\n\tDR_STE_SET_TAG(gre, tag, gre_key_h, misc, gre_key_h);\n\tDR_STE_SET_TAG(gre, tag, gre_key_l, misc, gre_key_l);\n\n\tDR_STE_SET_TAG(gre, tag, gre_c_present, misc, gre_c_present);\n\n\tDR_STE_SET_TAG(gre, tag, gre_s_present, misc, gre_s_present);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_tnl_gre_init(struct mlx5dr_ste_build *sb,\n\t\t\t     struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_tnl_gre_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V0_LU_TYPE_GRE;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_tnl_gre_tag;\n}\n\nstatic int\ndr_ste_v0_build_tnl_mpls_tag(struct mlx5dr_match_param *value,\n\t\t\t     struct mlx5dr_ste_build *sb,\n\t\t\t     u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc_2 = &value->misc2;\n\tu32 mpls_hdr;\n\n\tif (DR_STE_IS_OUTER_MPLS_OVER_GRE_SET(misc_2)) {\n\t\tmpls_hdr = misc_2->outer_first_mpls_over_gre_label << HDR_MPLS_OFFSET_LABEL;\n\t\tmisc_2->outer_first_mpls_over_gre_label = 0;\n\t\tmpls_hdr |= misc_2->outer_first_mpls_over_gre_exp << HDR_MPLS_OFFSET_EXP;\n\t\tmisc_2->outer_first_mpls_over_gre_exp = 0;\n\t\tmpls_hdr |= misc_2->outer_first_mpls_over_gre_s_bos << HDR_MPLS_OFFSET_S_BOS;\n\t\tmisc_2->outer_first_mpls_over_gre_s_bos = 0;\n\t\tmpls_hdr |= misc_2->outer_first_mpls_over_gre_ttl << HDR_MPLS_OFFSET_TTL;\n\t\tmisc_2->outer_first_mpls_over_gre_ttl = 0;\n\t} else {\n\t\tmpls_hdr = misc_2->outer_first_mpls_over_udp_label << HDR_MPLS_OFFSET_LABEL;\n\t\tmisc_2->outer_first_mpls_over_udp_label = 0;\n\t\tmpls_hdr |= misc_2->outer_first_mpls_over_udp_exp << HDR_MPLS_OFFSET_EXP;\n\t\tmisc_2->outer_first_mpls_over_udp_exp = 0;\n\t\tmpls_hdr |= misc_2->outer_first_mpls_over_udp_s_bos << HDR_MPLS_OFFSET_S_BOS;\n\t\tmisc_2->outer_first_mpls_over_udp_s_bos = 0;\n\t\tmpls_hdr |= misc_2->outer_first_mpls_over_udp_ttl << HDR_MPLS_OFFSET_TTL;\n\t\tmisc_2->outer_first_mpls_over_udp_ttl = 0;\n\t}\n\n\tMLX5_SET(ste_flex_parser_0, tag, flex_parser_3, mpls_hdr);\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_tnl_mpls_init(struct mlx5dr_ste_build *sb,\n\t\t\t      struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_tnl_mpls_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V0_LU_TYPE_FLEX_PARSER_0;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_tnl_mpls_tag;\n}\n\nstatic int\ndr_ste_v0_build_tnl_mpls_over_udp_tag(struct mlx5dr_match_param *value,\n\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t      u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\tu8 *parser_ptr;\n\tu8 parser_id;\n\tu32 mpls_hdr;\n\n\tmpls_hdr = misc2->outer_first_mpls_over_udp_label << HDR_MPLS_OFFSET_LABEL;\n\tmisc2->outer_first_mpls_over_udp_label = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_udp_exp << HDR_MPLS_OFFSET_EXP;\n\tmisc2->outer_first_mpls_over_udp_exp = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_udp_s_bos << HDR_MPLS_OFFSET_S_BOS;\n\tmisc2->outer_first_mpls_over_udp_s_bos = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_udp_ttl << HDR_MPLS_OFFSET_TTL;\n\tmisc2->outer_first_mpls_over_udp_ttl = 0;\n\n\tparser_id = sb->caps->flex_parser_id_mpls_over_udp;\n\tparser_ptr = dr_ste_calc_flex_parser_offset(tag, parser_id);\n\t*(__be32 *)parser_ptr = cpu_to_be32(mpls_hdr);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_tnl_mpls_over_udp_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t       struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_tnl_mpls_over_udp_tag(mask, sb, sb->bit_mask);\n\t \n\tsb->lu_type = sb->caps->flex_parser_id_mpls_over_udp > DR_STE_MAX_FLEX_0_ID ?\n\t\t      DR_STE_V0_LU_TYPE_FLEX_PARSER_1 :\n\t\t      DR_STE_V0_LU_TYPE_FLEX_PARSER_0;\n\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_tnl_mpls_over_udp_tag;\n}\n\nstatic int\ndr_ste_v0_build_tnl_mpls_over_gre_tag(struct mlx5dr_match_param *value,\n\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t      u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\tu8 *parser_ptr;\n\tu8 parser_id;\n\tu32 mpls_hdr;\n\n\tmpls_hdr = misc2->outer_first_mpls_over_gre_label << HDR_MPLS_OFFSET_LABEL;\n\tmisc2->outer_first_mpls_over_gre_label = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_gre_exp << HDR_MPLS_OFFSET_EXP;\n\tmisc2->outer_first_mpls_over_gre_exp = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_gre_s_bos << HDR_MPLS_OFFSET_S_BOS;\n\tmisc2->outer_first_mpls_over_gre_s_bos = 0;\n\tmpls_hdr |= misc2->outer_first_mpls_over_gre_ttl << HDR_MPLS_OFFSET_TTL;\n\tmisc2->outer_first_mpls_over_gre_ttl = 0;\n\n\tparser_id = sb->caps->flex_parser_id_mpls_over_gre;\n\tparser_ptr = dr_ste_calc_flex_parser_offset(tag, parser_id);\n\t*(__be32 *)parser_ptr = cpu_to_be32(mpls_hdr);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_tnl_mpls_over_gre_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t       struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_tnl_mpls_over_gre_tag(mask, sb, sb->bit_mask);\n\n\t \n\tsb->lu_type = sb->caps->flex_parser_id_mpls_over_gre > DR_STE_MAX_FLEX_0_ID ?\n\t\t      DR_STE_V0_LU_TYPE_FLEX_PARSER_1 :\n\t\t      DR_STE_V0_LU_TYPE_FLEX_PARSER_0;\n\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_tnl_mpls_over_gre_tag;\n}\n\n#define ICMP_TYPE_OFFSET_FIRST_DW\t24\n#define ICMP_CODE_OFFSET_FIRST_DW\t16\n\nstatic int\ndr_ste_v0_build_icmp_tag(struct mlx5dr_match_param *value,\n\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t u8 *tag)\n{\n\tstruct mlx5dr_match_misc3 *misc_3 = &value->misc3;\n\tu32 *icmp_header_data;\n\tint dw0_location;\n\tint dw1_location;\n\tu8 *parser_ptr;\n\tu8 *icmp_type;\n\tu8 *icmp_code;\n\tbool is_ipv4;\n\tu32 icmp_hdr;\n\n\tis_ipv4 = DR_MASK_IS_ICMPV4_SET(misc_3);\n\tif (is_ipv4) {\n\t\ticmp_header_data\t= &misc_3->icmpv4_header_data;\n\t\ticmp_type\t\t= &misc_3->icmpv4_type;\n\t\ticmp_code\t\t= &misc_3->icmpv4_code;\n\t\tdw0_location\t\t= sb->caps->flex_parser_id_icmp_dw0;\n\t\tdw1_location\t\t= sb->caps->flex_parser_id_icmp_dw1;\n\t} else {\n\t\ticmp_header_data\t= &misc_3->icmpv6_header_data;\n\t\ticmp_type\t\t= &misc_3->icmpv6_type;\n\t\ticmp_code\t\t= &misc_3->icmpv6_code;\n\t\tdw0_location\t\t= sb->caps->flex_parser_id_icmpv6_dw0;\n\t\tdw1_location\t\t= sb->caps->flex_parser_id_icmpv6_dw1;\n\t}\n\n\tparser_ptr = dr_ste_calc_flex_parser_offset(tag, dw0_location);\n\ticmp_hdr = (*icmp_type << ICMP_TYPE_OFFSET_FIRST_DW) |\n\t\t   (*icmp_code << ICMP_CODE_OFFSET_FIRST_DW);\n\t*(__be32 *)parser_ptr = cpu_to_be32(icmp_hdr);\n\t*icmp_code = 0;\n\t*icmp_type = 0;\n\n\tparser_ptr = dr_ste_calc_flex_parser_offset(tag, dw1_location);\n\t*(__be32 *)parser_ptr = cpu_to_be32(*icmp_header_data);\n\t*icmp_header_data = 0;\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_icmp_init(struct mlx5dr_ste_build *sb,\n\t\t\t  struct mlx5dr_match_param *mask)\n{\n\tu8 parser_id;\n\tbool is_ipv4;\n\n\tdr_ste_v0_build_icmp_tag(mask, sb, sb->bit_mask);\n\n\t \n\tis_ipv4 = DR_MASK_IS_ICMPV4_SET(&mask->misc3);\n\tparser_id = is_ipv4 ? sb->caps->flex_parser_id_icmp_dw0 :\n\t\t    sb->caps->flex_parser_id_icmpv6_dw0;\n\tsb->lu_type = parser_id > DR_STE_MAX_FLEX_0_ID ?\n\t\t      DR_STE_V0_LU_TYPE_FLEX_PARSER_1 :\n\t\t      DR_STE_V0_LU_TYPE_FLEX_PARSER_0;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_icmp_tag;\n}\n\nstatic int\ndr_ste_v0_build_general_purpose_tag(struct mlx5dr_match_param *value,\n\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t    u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc_2 = &value->misc2;\n\n\tDR_STE_SET_TAG(general_purpose, tag, general_purpose_lookup_field,\n\t\t       misc_2, metadata_reg_a);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_general_purpose_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t     struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_general_purpose_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V0_LU_TYPE_GENERAL_PURPOSE;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_general_purpose_tag;\n}\n\nstatic int\ndr_ste_v0_build_eth_l4_misc_tag(struct mlx5dr_match_param *value,\n\t\t\t\tstruct mlx5dr_ste_build *sb,\n\t\t\t\tu8 *tag)\n{\n\tstruct mlx5dr_match_misc3 *misc3 = &value->misc3;\n\n\tif (sb->inner) {\n\t\tDR_STE_SET_TAG(eth_l4_misc, tag, seq_num, misc3, inner_tcp_seq_num);\n\t\tDR_STE_SET_TAG(eth_l4_misc, tag, ack_num, misc3, inner_tcp_ack_num);\n\t} else {\n\t\tDR_STE_SET_TAG(eth_l4_misc, tag, seq_num, misc3, outer_tcp_seq_num);\n\t\tDR_STE_SET_TAG(eth_l4_misc, tag, ack_num, misc3, outer_tcp_ack_num);\n\t}\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_eth_l4_misc_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_eth_l4_misc_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_CALC_LU_TYPE(ETHL4_MISC, sb->rx, sb->inner);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_eth_l4_misc_tag;\n}\n\nstatic int\ndr_ste_v0_build_flex_parser_tnl_vxlan_gpe_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t\t      u8 *tag)\n{\n\tstruct mlx5dr_match_misc3 *misc3 = &value->misc3;\n\n\tDR_STE_SET_TAG(flex_parser_tnl_vxlan_gpe, tag,\n\t\t       outer_vxlan_gpe_flags, misc3,\n\t\t       outer_vxlan_gpe_flags);\n\tDR_STE_SET_TAG(flex_parser_tnl_vxlan_gpe, tag,\n\t\t       outer_vxlan_gpe_next_protocol, misc3,\n\t\t       outer_vxlan_gpe_next_protocol);\n\tDR_STE_SET_TAG(flex_parser_tnl_vxlan_gpe, tag,\n\t\t       outer_vxlan_gpe_vni, misc3,\n\t\t       outer_vxlan_gpe_vni);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_flex_parser_tnl_vxlan_gpe_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t       struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_flex_parser_tnl_vxlan_gpe_tag(mask, sb, sb->bit_mask);\n\tsb->lu_type = DR_STE_V0_LU_TYPE_FLEX_PARSER_TNL_HEADER;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_flex_parser_tnl_vxlan_gpe_tag;\n}\n\nstatic int\ndr_ste_v0_build_flex_parser_tnl_geneve_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t   u8 *tag)\n{\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\n\tDR_STE_SET_TAG(flex_parser_tnl_geneve, tag,\n\t\t       geneve_protocol_type, misc, geneve_protocol_type);\n\tDR_STE_SET_TAG(flex_parser_tnl_geneve, tag,\n\t\t       geneve_oam, misc, geneve_oam);\n\tDR_STE_SET_TAG(flex_parser_tnl_geneve, tag,\n\t\t       geneve_opt_len, misc, geneve_opt_len);\n\tDR_STE_SET_TAG(flex_parser_tnl_geneve, tag,\n\t\t       geneve_vni, misc, geneve_vni);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_flex_parser_tnl_geneve_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_flex_parser_tnl_geneve_tag(mask, sb, sb->bit_mask);\n\tsb->lu_type = DR_STE_V0_LU_TYPE_FLEX_PARSER_TNL_HEADER;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_flex_parser_tnl_geneve_tag;\n}\n\nstatic int\ndr_ste_v0_build_register_0_tag(struct mlx5dr_match_param *value,\n\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t       u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\n\tDR_STE_SET_TAG(register_0, tag, register_0_h, misc2, metadata_reg_c_0);\n\tDR_STE_SET_TAG(register_0, tag, register_0_l, misc2, metadata_reg_c_1);\n\tDR_STE_SET_TAG(register_0, tag, register_1_h, misc2, metadata_reg_c_2);\n\tDR_STE_SET_TAG(register_0, tag, register_1_l, misc2, metadata_reg_c_3);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_register_0_init(struct mlx5dr_ste_build *sb,\n\t\t\t\tstruct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_register_0_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V0_LU_TYPE_STEERING_REGISTERS_0;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_register_0_tag;\n}\n\nstatic int\ndr_ste_v0_build_register_1_tag(struct mlx5dr_match_param *value,\n\t\t\t       struct mlx5dr_ste_build *sb,\n\t\t\t       u8 *tag)\n{\n\tstruct mlx5dr_match_misc2 *misc2 = &value->misc2;\n\n\tDR_STE_SET_TAG(register_1, tag, register_2_h, misc2, metadata_reg_c_4);\n\tDR_STE_SET_TAG(register_1, tag, register_2_l, misc2, metadata_reg_c_5);\n\tDR_STE_SET_TAG(register_1, tag, register_3_h, misc2, metadata_reg_c_6);\n\tDR_STE_SET_TAG(register_1, tag, register_3_l, misc2, metadata_reg_c_7);\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_register_1_init(struct mlx5dr_ste_build *sb,\n\t\t\t\tstruct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_register_1_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V0_LU_TYPE_STEERING_REGISTERS_1;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_register_1_tag;\n}\n\nstatic void\ndr_ste_v0_build_src_gvmi_qpn_bit_mask(struct mlx5dr_match_param *value,\n\t\t\t\t      u8 *bit_mask)\n{\n\tstruct mlx5dr_match_misc *misc_mask = &value->misc;\n\n\tDR_STE_SET_ONES(src_gvmi_qp, bit_mask, source_gvmi, misc_mask, source_port);\n\tDR_STE_SET_ONES(src_gvmi_qp, bit_mask, source_qp, misc_mask, source_sqn);\n\tmisc_mask->source_eswitch_owner_vhca_id = 0;\n}\n\nstatic int\ndr_ste_v0_build_src_gvmi_qpn_tag(struct mlx5dr_match_param *value,\n\t\t\t\t struct mlx5dr_ste_build *sb,\n\t\t\t\t u8 *tag)\n{\n\tstruct mlx5dr_match_misc *misc = &value->misc;\n\tint id = misc->source_eswitch_owner_vhca_id;\n\tstruct mlx5dr_cmd_vport_cap *vport_cap;\n\tstruct mlx5dr_domain *dmn = sb->dmn;\n\tstruct mlx5dr_domain *vport_dmn;\n\tu8 *bit_mask = sb->bit_mask;\n\tstruct mlx5dr_domain *peer;\n\tbool source_gvmi_set;\n\n\tDR_STE_SET_TAG(src_gvmi_qp, tag, source_qp, misc, source_sqn);\n\n\tif (sb->vhca_id_valid) {\n\t\tpeer = xa_load(&dmn->peer_dmn_xa, id);\n\t\t \n\t\tif (id == dmn->info.caps.gvmi)\n\t\t\tvport_dmn = dmn;\n\t\telse if (peer && (id == peer->info.caps.gvmi))\n\t\t\tvport_dmn = peer;\n\t\telse\n\t\t\treturn -EINVAL;\n\n\t\tmisc->source_eswitch_owner_vhca_id = 0;\n\t} else {\n\t\tvport_dmn = dmn;\n\t}\n\n\tsource_gvmi_set = MLX5_GET(ste_src_gvmi_qp, bit_mask, source_gvmi);\n\tif (source_gvmi_set) {\n\t\tvport_cap = mlx5dr_domain_get_vport_cap(vport_dmn,\n\t\t\t\t\t\t\tmisc->source_port);\n\t\tif (!vport_cap) {\n\t\t\tmlx5dr_err(dmn, \"Vport 0x%x is disabled or invalid\\n\",\n\t\t\t\t   misc->source_port);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tif (vport_cap->vport_gvmi)\n\t\t\tMLX5_SET(ste_src_gvmi_qp, tag, source_gvmi, vport_cap->vport_gvmi);\n\n\t\tmisc->source_port = 0;\n\t}\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_src_gvmi_qpn_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t  struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_src_gvmi_qpn_bit_mask(mask, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V0_LU_TYPE_SRC_GVMI_AND_QP;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_src_gvmi_qpn_tag;\n}\n\nstatic void dr_ste_v0_set_flex_parser(u32 *misc4_field_id,\n\t\t\t\t      u32 *misc4_field_value,\n\t\t\t\t      bool *parser_is_used,\n\t\t\t\t      u8 *tag)\n{\n\tu32 id = *misc4_field_id;\n\tu8 *parser_ptr;\n\n\tif (id >= DR_NUM_OF_FLEX_PARSERS || parser_is_used[id])\n\t\treturn;\n\n\tparser_is_used[id] = true;\n\tparser_ptr = dr_ste_calc_flex_parser_offset(tag, id);\n\n\t*(__be32 *)parser_ptr = cpu_to_be32(*misc4_field_value);\n\t*misc4_field_id = 0;\n\t*misc4_field_value = 0;\n}\n\nstatic int dr_ste_v0_build_flex_parser_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t   u8 *tag)\n{\n\tstruct mlx5dr_match_misc4 *misc_4_mask = &value->misc4;\n\tbool parser_is_used[DR_NUM_OF_FLEX_PARSERS] = {};\n\n\tdr_ste_v0_set_flex_parser(&misc_4_mask->prog_sample_field_id_0,\n\t\t\t\t  &misc_4_mask->prog_sample_field_value_0,\n\t\t\t\t  parser_is_used, tag);\n\n\tdr_ste_v0_set_flex_parser(&misc_4_mask->prog_sample_field_id_1,\n\t\t\t\t  &misc_4_mask->prog_sample_field_value_1,\n\t\t\t\t  parser_is_used, tag);\n\n\tdr_ste_v0_set_flex_parser(&misc_4_mask->prog_sample_field_id_2,\n\t\t\t\t  &misc_4_mask->prog_sample_field_value_2,\n\t\t\t\t  parser_is_used, tag);\n\n\tdr_ste_v0_set_flex_parser(&misc_4_mask->prog_sample_field_id_3,\n\t\t\t\t  &misc_4_mask->prog_sample_field_value_3,\n\t\t\t\t  parser_is_used, tag);\n\n\treturn 0;\n}\n\nstatic void dr_ste_v0_build_flex_parser_0_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t       struct mlx5dr_match_param *mask)\n{\n\tsb->lu_type = DR_STE_V0_LU_TYPE_FLEX_PARSER_0;\n\tdr_ste_v0_build_flex_parser_tag(mask, sb, sb->bit_mask);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_flex_parser_tag;\n}\n\nstatic void dr_ste_v0_build_flex_parser_1_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t       struct mlx5dr_match_param *mask)\n{\n\tsb->lu_type = DR_STE_V0_LU_TYPE_FLEX_PARSER_1;\n\tdr_ste_v0_build_flex_parser_tag(mask, sb, sb->bit_mask);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_flex_parser_tag;\n}\n\nstatic int\ndr_ste_v0_build_flex_parser_tnl_geneve_tlv_opt_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t   u8 *tag)\n{\n\tstruct mlx5dr_match_misc3 *misc3 = &value->misc3;\n\tu8 parser_id = sb->caps->flex_parser_id_geneve_tlv_option_0;\n\tu8 *parser_ptr = dr_ste_calc_flex_parser_offset(tag, parser_id);\n\n\tMLX5_SET(ste_flex_parser_0, parser_ptr, flex_parser_3,\n\t\t misc3->geneve_tlv_option_0_data);\n\tmisc3->geneve_tlv_option_0_data = 0;\n\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_flex_parser_tnl_geneve_tlv_opt_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_flex_parser_tnl_geneve_tlv_opt_tag(mask, sb, sb->bit_mask);\n\n\t \n\tsb->lu_type = sb->caps->flex_parser_id_geneve_tlv_option_0 > 3 ?\n\t\tDR_STE_V0_LU_TYPE_FLEX_PARSER_1 :\n\t\tDR_STE_V0_LU_TYPE_FLEX_PARSER_0;\n\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_flex_parser_tnl_geneve_tlv_opt_tag;\n}\n\nstatic int dr_ste_v0_build_flex_parser_tnl_gtpu_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t\t    struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t    u8 *tag)\n{\n\tstruct mlx5dr_match_misc3 *misc3 = &value->misc3;\n\n\tDR_STE_SET_TAG(flex_parser_tnl_gtpu, tag,\n\t\t       gtpu_msg_flags, misc3,\n\t\t       gtpu_msg_flags);\n\tDR_STE_SET_TAG(flex_parser_tnl_gtpu, tag,\n\t\t       gtpu_msg_type, misc3,\n\t\t       gtpu_msg_type);\n\tDR_STE_SET_TAG(flex_parser_tnl_gtpu, tag,\n\t\t       gtpu_teid, misc3,\n\t\t       gtpu_teid);\n\n\treturn 0;\n}\n\nstatic void dr_ste_v0_build_flex_parser_tnl_gtpu_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\t      struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_flex_parser_tnl_gtpu_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V0_LU_TYPE_FLEX_PARSER_TNL_HEADER;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_flex_parser_tnl_gtpu_tag;\n}\n\nstatic int\ndr_ste_v0_build_tnl_gtpu_flex_parser_0_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t   u8 *tag)\n{\n\tif (dr_is_flex_parser_0_id(sb->caps->flex_parser_id_gtpu_dw_0))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_dw_0, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_0_id(sb->caps->flex_parser_id_gtpu_teid))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_teid, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_0_id(sb->caps->flex_parser_id_gtpu_dw_2))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_dw_2, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_0_id(sb->caps->flex_parser_id_gtpu_first_ext_dw_0))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_first_ext_dw_0, sb->caps, &value->misc3);\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_tnl_gtpu_flex_parser_0_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_tnl_gtpu_flex_parser_0_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V0_LU_TYPE_FLEX_PARSER_0;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_tnl_gtpu_flex_parser_0_tag;\n}\n\nstatic int\ndr_ste_v0_build_tnl_gtpu_flex_parser_1_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t   struct mlx5dr_ste_build *sb,\n\t\t\t\t\t   u8 *tag)\n{\n\tif (dr_is_flex_parser_1_id(sb->caps->flex_parser_id_gtpu_dw_0))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_dw_0, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_1_id(sb->caps->flex_parser_id_gtpu_teid))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_teid, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_1_id(sb->caps->flex_parser_id_gtpu_dw_2))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_dw_2, sb->caps, &value->misc3);\n\tif (dr_is_flex_parser_1_id(sb->caps->flex_parser_id_gtpu_first_ext_dw_0))\n\t\tDR_STE_SET_FLEX_PARSER_FIELD(tag, gtpu_first_ext_dw_0, sb->caps, &value->misc3);\n\treturn 0;\n}\n\nstatic void\ndr_ste_v0_build_tnl_gtpu_flex_parser_1_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t    struct mlx5dr_match_param *mask)\n{\n\tdr_ste_v0_build_tnl_gtpu_flex_parser_1_tag(mask, sb, sb->bit_mask);\n\n\tsb->lu_type = DR_STE_V0_LU_TYPE_FLEX_PARSER_1;\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_tnl_gtpu_flex_parser_1_tag;\n}\n\nstatic int dr_ste_v0_build_tnl_header_0_1_tag(struct mlx5dr_match_param *value,\n\t\t\t\t\t      struct mlx5dr_ste_build *sb,\n\t\t\t\t\t      uint8_t *tag)\n{\n\tstruct mlx5dr_match_misc5 *misc5 = &value->misc5;\n\n\tDR_STE_SET_TAG(tunnel_header, tag, tunnel_header_0, misc5, tunnel_header_0);\n\tDR_STE_SET_TAG(tunnel_header, tag, tunnel_header_1, misc5, tunnel_header_1);\n\n\treturn 0;\n}\n\nstatic void dr_ste_v0_build_tnl_header_0_1_init(struct mlx5dr_ste_build *sb,\n\t\t\t\t\t\tstruct mlx5dr_match_param *mask)\n{\n\tsb->lu_type = DR_STE_V0_LU_TYPE_TUNNEL_HEADER;\n\tdr_ste_v0_build_tnl_header_0_1_tag(mask, sb, sb->bit_mask);\n\tsb->byte_mask = mlx5dr_ste_conv_bit_to_byte_mask(sb->bit_mask);\n\tsb->ste_build_tag_func = &dr_ste_v0_build_tnl_header_0_1_tag;\n}\n\nstatic struct mlx5dr_ste_ctx ste_ctx_v0 = {\n\t \n\t.build_eth_l2_src_dst_init\t= &dr_ste_v0_build_eth_l2_src_dst_init,\n\t.build_eth_l3_ipv6_src_init\t= &dr_ste_v0_build_eth_l3_ipv6_src_init,\n\t.build_eth_l3_ipv6_dst_init\t= &dr_ste_v0_build_eth_l3_ipv6_dst_init,\n\t.build_eth_l3_ipv4_5_tuple_init\t= &dr_ste_v0_build_eth_l3_ipv4_5_tuple_init,\n\t.build_eth_l2_src_init\t\t= &dr_ste_v0_build_eth_l2_src_init,\n\t.build_eth_l2_dst_init\t\t= &dr_ste_v0_build_eth_l2_dst_init,\n\t.build_eth_l2_tnl_init\t\t= &dr_ste_v0_build_eth_l2_tnl_init,\n\t.build_eth_l3_ipv4_misc_init\t= &dr_ste_v0_build_eth_l3_ipv4_misc_init,\n\t.build_eth_ipv6_l3_l4_init\t= &dr_ste_v0_build_eth_ipv6_l3_l4_init,\n\t.build_mpls_init\t\t= &dr_ste_v0_build_mpls_init,\n\t.build_tnl_gre_init\t\t= &dr_ste_v0_build_tnl_gre_init,\n\t.build_tnl_mpls_init\t\t= &dr_ste_v0_build_tnl_mpls_init,\n\t.build_tnl_mpls_over_udp_init\t= &dr_ste_v0_build_tnl_mpls_over_udp_init,\n\t.build_tnl_mpls_over_gre_init\t= &dr_ste_v0_build_tnl_mpls_over_gre_init,\n\t.build_icmp_init\t\t= &dr_ste_v0_build_icmp_init,\n\t.build_general_purpose_init\t= &dr_ste_v0_build_general_purpose_init,\n\t.build_eth_l4_misc_init\t\t= &dr_ste_v0_build_eth_l4_misc_init,\n\t.build_tnl_vxlan_gpe_init\t= &dr_ste_v0_build_flex_parser_tnl_vxlan_gpe_init,\n\t.build_tnl_geneve_init\t\t= &dr_ste_v0_build_flex_parser_tnl_geneve_init,\n\t.build_tnl_geneve_tlv_opt_init\t= &dr_ste_v0_build_flex_parser_tnl_geneve_tlv_opt_init,\n\t.build_register_0_init\t\t= &dr_ste_v0_build_register_0_init,\n\t.build_register_1_init\t\t= &dr_ste_v0_build_register_1_init,\n\t.build_src_gvmi_qpn_init\t= &dr_ste_v0_build_src_gvmi_qpn_init,\n\t.build_flex_parser_0_init\t= &dr_ste_v0_build_flex_parser_0_init,\n\t.build_flex_parser_1_init\t= &dr_ste_v0_build_flex_parser_1_init,\n\t.build_tnl_gtpu_init\t\t= &dr_ste_v0_build_flex_parser_tnl_gtpu_init,\n\t.build_tnl_header_0_1_init\t= &dr_ste_v0_build_tnl_header_0_1_init,\n\t.build_tnl_gtpu_flex_parser_0_init   = &dr_ste_v0_build_tnl_gtpu_flex_parser_0_init,\n\t.build_tnl_gtpu_flex_parser_1_init   = &dr_ste_v0_build_tnl_gtpu_flex_parser_1_init,\n\n\t \n\t.ste_init\t\t\t= &dr_ste_v0_init,\n\t.set_next_lu_type\t\t= &dr_ste_v0_set_next_lu_type,\n\t.get_next_lu_type\t\t= &dr_ste_v0_get_next_lu_type,\n\t.set_miss_addr\t\t\t= &dr_ste_v0_set_miss_addr,\n\t.get_miss_addr\t\t\t= &dr_ste_v0_get_miss_addr,\n\t.set_hit_addr\t\t\t= &dr_ste_v0_set_hit_addr,\n\t.set_byte_mask\t\t\t= &dr_ste_v0_set_byte_mask,\n\t.get_byte_mask\t\t\t= &dr_ste_v0_get_byte_mask,\n\n\t \n\t.actions_caps\t\t\t= DR_STE_CTX_ACTION_CAP_NONE,\n\t.set_actions_rx\t\t\t= &dr_ste_v0_set_actions_rx,\n\t.set_actions_tx\t\t\t= &dr_ste_v0_set_actions_tx,\n\t.modify_field_arr_sz\t\t= ARRAY_SIZE(dr_ste_v0_action_modify_field_arr),\n\t.modify_field_arr\t\t= dr_ste_v0_action_modify_field_arr,\n\t.set_action_set\t\t\t= &dr_ste_v0_set_action_set,\n\t.set_action_add\t\t\t= &dr_ste_v0_set_action_add,\n\t.set_action_copy\t\t= &dr_ste_v0_set_action_copy,\n\t.set_action_decap_l3_list\t= &dr_ste_v0_set_action_decap_l3_list,\n};\n\nstruct mlx5dr_ste_ctx *mlx5dr_ste_get_ctx_v0(void)\n{\n\treturn &ste_ctx_v0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}