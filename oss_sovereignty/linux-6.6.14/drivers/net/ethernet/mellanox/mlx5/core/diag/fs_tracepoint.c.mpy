{
  "module_name": "fs_tracepoint.c",
  "hash_id": "180f5ae79c6c3189a534b00c443638d54e72c378f8d0e48500ea1acdd68b1048",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mellanox/mlx5/core/diag/fs_tracepoint.c",
  "human_readable_source": " \n\n#define CREATE_TRACE_POINTS\n\n#include \"fs_tracepoint.h\"\n#include <linux/stringify.h>\n\n#define DECLARE_MASK_VAL(type, name) struct {type m; type v; } name\n#define MASK_VAL(type, spec, name, mask, val, fld)\t\\\n\t\tDECLARE_MASK_VAL(type, name) =\t\t\\\n\t\t\t{.m = MLX5_GET(spec, mask, fld),\\\n\t\t\t .v = MLX5_GET(spec, val, fld)}\n#define MASK_VAL_BE(type, spec, name, mask, val, fld)\t\\\n\t\t    DECLARE_MASK_VAL(type, name) =\t\\\n\t\t\t{.m = MLX5_GET_BE(type, spec, mask, fld),\\\n\t\t\t .v = MLX5_GET_BE(type, spec, val, fld)}\n#define GET_MASKED_VAL(name) (name.m & name.v)\n\n#define GET_MASK_VAL(name, type, mask, val, fld)\t\\\n\t\t(name.m = MLX5_GET(type, mask, fld),\t\\\n\t\t name.v = MLX5_GET(type, val, fld),\t\\\n\t\t name.m & name.v)\n#define PRINT_MASKED_VAL(name, p, format) {\t\t\\\n\tif (name.m)\t\t\t\\\n\t\ttrace_seq_printf(p, __stringify(name) \"=\" format \" \", name.v); \\\n\t}\n#define PRINT_MASKED_VALP(name, cast, p, format) {\t\\\n\tif (name.m)\t\t\t\\\n\t\ttrace_seq_printf(p, __stringify(name) \"=\" format \" \",\t       \\\n\t\t\t\t (cast)&name.v);\\\n\t}\n\nstatic void print_lyr_2_4_hdrs(struct trace_seq *p,\n\t\t\t       const u32 *mask, const u32 *value)\n{\n#define MASK_VAL_L2(type, name, fld) \\\n\tMASK_VAL(type, fte_match_set_lyr_2_4, name, mask, value, fld)\n\tDECLARE_MASK_VAL(u64, smac) = {\n\t\t.m = MLX5_GET(fte_match_set_lyr_2_4, mask, smac_47_16) << 16 |\n\t\t     MLX5_GET(fte_match_set_lyr_2_4, mask, smac_15_0),\n\t\t.v = MLX5_GET(fte_match_set_lyr_2_4, value, smac_47_16) << 16 |\n\t\t     MLX5_GET(fte_match_set_lyr_2_4, value, smac_15_0)};\n\tDECLARE_MASK_VAL(u64, dmac) = {\n\t\t.m = MLX5_GET(fte_match_set_lyr_2_4, mask, dmac_47_16) << 16 |\n\t\t     MLX5_GET(fte_match_set_lyr_2_4, mask, dmac_15_0),\n\t\t.v = MLX5_GET(fte_match_set_lyr_2_4, value, dmac_47_16) << 16 |\n\t\t     MLX5_GET(fte_match_set_lyr_2_4, value, dmac_15_0)};\n\tMASK_VAL_L2(u16, ethertype, ethertype);\n\tMASK_VAL_L2(u8, ip_version, ip_version);\n\n\tPRINT_MASKED_VALP(smac, u8 *, p, \"%pM\");\n\tPRINT_MASKED_VALP(dmac, u8 *, p, \"%pM\");\n\tPRINT_MASKED_VAL(ethertype, p, \"%04x\");\n\n\tif ((ethertype.m == 0xffff && ethertype.v == ETH_P_IP) ||\n\t    (ip_version.m == 0xf && ip_version.v == 4)) {\n#define MASK_VAL_L2_BE(type, name, fld) \\\n\tMASK_VAL_BE(type, fte_match_set_lyr_2_4, name, mask, value, fld)\n\t\tMASK_VAL_L2_BE(u32, src_ipv4,\n\t\t\t       src_ipv4_src_ipv6.ipv4_layout.ipv4);\n\t\tMASK_VAL_L2_BE(u32, dst_ipv4,\n\t\t\t       dst_ipv4_dst_ipv6.ipv4_layout.ipv4);\n\n\t\tPRINT_MASKED_VALP(src_ipv4, typeof(&src_ipv4.v), p,\n\t\t\t\t  \"%pI4\");\n\t\tPRINT_MASKED_VALP(dst_ipv4, typeof(&dst_ipv4.v), p,\n\t\t\t\t  \"%pI4\");\n\t} else if ((ethertype.m == 0xffff && ethertype.v == ETH_P_IPV6) ||\n\t\t   (ip_version.m == 0xf && ip_version.v == 6)) {\n\t\tstatic const struct in6_addr full_ones = {\n\t\t\t.in6_u.u6_addr32 = {__constant_htonl(0xffffffff),\n\t\t\t\t\t    __constant_htonl(0xffffffff),\n\t\t\t\t\t    __constant_htonl(0xffffffff),\n\t\t\t\t\t    __constant_htonl(0xffffffff)},\n\t\t};\n\t\tDECLARE_MASK_VAL(struct in6_addr, src_ipv6);\n\t\tDECLARE_MASK_VAL(struct in6_addr, dst_ipv6);\n\n\t\tmemcpy(src_ipv6.m.in6_u.u6_addr8,\n\t\t       MLX5_ADDR_OF(fte_match_set_lyr_2_4, mask,\n\t\t\t\t    src_ipv4_src_ipv6.ipv6_layout.ipv6),\n\t\t       sizeof(src_ipv6.m));\n\t\tmemcpy(dst_ipv6.m.in6_u.u6_addr8,\n\t\t       MLX5_ADDR_OF(fte_match_set_lyr_2_4, mask,\n\t\t\t\t    dst_ipv4_dst_ipv6.ipv6_layout.ipv6),\n\t\t       sizeof(dst_ipv6.m));\n\t\tmemcpy(src_ipv6.v.in6_u.u6_addr8,\n\t\t       MLX5_ADDR_OF(fte_match_set_lyr_2_4, value,\n\t\t\t\t    src_ipv4_src_ipv6.ipv6_layout.ipv6),\n\t\t       sizeof(src_ipv6.v));\n\t\tmemcpy(dst_ipv6.v.in6_u.u6_addr8,\n\t\t       MLX5_ADDR_OF(fte_match_set_lyr_2_4, value,\n\t\t\t\t    dst_ipv4_dst_ipv6.ipv6_layout.ipv6),\n\t\t       sizeof(dst_ipv6.v));\n\n\t\tif (!memcmp(&src_ipv6.m, &full_ones, sizeof(full_ones)))\n\t\t\ttrace_seq_printf(p, \"src_ipv6=%pI6 \",\n\t\t\t\t\t &src_ipv6.v);\n\t\tif (!memcmp(&dst_ipv6.m, &full_ones, sizeof(full_ones)))\n\t\t\ttrace_seq_printf(p, \"dst_ipv6=%pI6 \",\n\t\t\t\t\t &dst_ipv6.v);\n\t}\n\n#define PRINT_MASKED_VAL_L2(type, name, fld, p, format) {\\\n\tMASK_VAL_L2(type, name, fld);\t\t         \\\n\tPRINT_MASKED_VAL(name, p, format);\t\t \\\n}\n\n\tPRINT_MASKED_VAL_L2(u8, ip_protocol, ip_protocol, p, \"%02x\");\n\tPRINT_MASKED_VAL_L2(u16, tcp_flags, tcp_flags, p, \"%x\");\n\tPRINT_MASKED_VAL_L2(u16, tcp_sport, tcp_sport, p, \"%u\");\n\tPRINT_MASKED_VAL_L2(u16, tcp_dport, tcp_dport, p, \"%u\");\n\tPRINT_MASKED_VAL_L2(u16, udp_sport, udp_sport, p, \"%u\");\n\tPRINT_MASKED_VAL_L2(u16, udp_dport, udp_dport, p, \"%u\");\n\tPRINT_MASKED_VAL_L2(u16, first_vid, first_vid, p, \"%04x\");\n\tPRINT_MASKED_VAL_L2(u8, first_prio, first_prio, p, \"%x\");\n\tPRINT_MASKED_VAL_L2(u8, first_cfi, first_cfi, p, \"%d\");\n\tPRINT_MASKED_VAL_L2(u8, ip_dscp, ip_dscp, p, \"%02x\");\n\tPRINT_MASKED_VAL_L2(u8, ip_ecn, ip_ecn, p, \"%x\");\n\tPRINT_MASKED_VAL_L2(u8, cvlan_tag, cvlan_tag, p, \"%d\");\n\tPRINT_MASKED_VAL_L2(u8, svlan_tag, svlan_tag, p, \"%d\");\n\tPRINT_MASKED_VAL_L2(u8, frag, frag, p, \"%d\");\n}\n\nstatic void print_misc_parameters_hdrs(struct trace_seq *p,\n\t\t\t\t       const u32 *mask, const u32 *value)\n{\n#define MASK_VAL_MISC(type, name, fld) \\\n\tMASK_VAL(type, fte_match_set_misc, name, mask, value, fld)\n#define PRINT_MASKED_VAL_MISC(type, name, fld, p, format) {\\\n\tMASK_VAL_MISC(type, name, fld);\t\t\t   \\\n\tPRINT_MASKED_VAL(name, p, format);\t\t   \\\n}\n\tDECLARE_MASK_VAL(u64, gre_key) = {\n\t\t.m = MLX5_GET(fte_match_set_misc, mask, gre_key.nvgre.hi) << 8 |\n\t\t     MLX5_GET(fte_match_set_misc, mask, gre_key.nvgre.lo),\n\t\t.v = MLX5_GET(fte_match_set_misc, value, gre_key.nvgre.hi) << 8 |\n\t\t     MLX5_GET(fte_match_set_misc, value, gre_key.nvgre.lo)};\n\n\tPRINT_MASKED_VAL(gre_key, p, \"%llu\");\n\tPRINT_MASKED_VAL_MISC(u32, source_sqn, source_sqn, p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u16, source_port, source_port, p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u8, outer_second_prio, outer_second_prio,\n\t\t\t      p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u8, outer_second_cfi, outer_second_cfi, p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u16, outer_second_vid, outer_second_vid, p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u8, inner_second_prio, inner_second_prio,\n\t\t\t      p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u8, inner_second_cfi, inner_second_cfi, p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u16, inner_second_vid, inner_second_vid, p, \"%u\");\n\n\tPRINT_MASKED_VAL_MISC(u8, outer_second_cvlan_tag,\n\t\t\t      outer_second_cvlan_tag, p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u8, inner_second_cvlan_tag,\n\t\t\t      inner_second_cvlan_tag, p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u8, outer_second_svlan_tag,\n\t\t\t      outer_second_svlan_tag, p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u8, inner_second_svlan_tag,\n\t\t\t      inner_second_svlan_tag, p, \"%u\");\n\n\tPRINT_MASKED_VAL_MISC(u8, gre_protocol, gre_protocol, p, \"%u\");\n\n\tPRINT_MASKED_VAL_MISC(u32, vxlan_vni, vxlan_vni, p, \"%u\");\n\tPRINT_MASKED_VAL_MISC(u32, outer_ipv6_flow_label, outer_ipv6_flow_label,\n\t\t\t      p, \"%x\");\n\tPRINT_MASKED_VAL_MISC(u32, inner_ipv6_flow_label, inner_ipv6_flow_label,\n\t\t\t      p, \"%x\");\n}\n\nconst char *parse_fs_hdrs(struct trace_seq *p,\n\t\t\t  u8 match_criteria_enable,\n\t\t\t  const u32 *mask_outer,\n\t\t\t  const u32 *mask_misc,\n\t\t\t  const u32 *mask_inner,\n\t\t\t  const u32 *value_outer,\n\t\t\t  const u32 *value_misc,\n\t\t\t  const u32 *value_inner)\n{\n\tconst char *ret = trace_seq_buffer_ptr(p);\n\n\tif (match_criteria_enable &\n\t    1 << MLX5_CREATE_FLOW_GROUP_IN_MATCH_CRITERIA_ENABLE_OUTER_HEADERS) {\n\t\ttrace_seq_printf(p, \"[outer] \");\n\t\tprint_lyr_2_4_hdrs(p, mask_outer, value_outer);\n\t}\n\n\tif (match_criteria_enable &\n\t    1 << MLX5_CREATE_FLOW_GROUP_IN_MATCH_CRITERIA_ENABLE_MISC_PARAMETERS) {\n\t\ttrace_seq_printf(p, \"[misc] \");\n\t\tprint_misc_parameters_hdrs(p, mask_misc, value_misc);\n\t}\n\tif (match_criteria_enable &\n\t    1 << MLX5_CREATE_FLOW_GROUP_IN_MATCH_CRITERIA_ENABLE_INNER_HEADERS) {\n\t\ttrace_seq_printf(p, \"[inner] \");\n\t\tprint_lyr_2_4_hdrs(p, mask_inner, value_inner);\n\t}\n\ttrace_seq_putc(p, 0);\n\treturn ret;\n}\n\nstatic const char\n*fs_dest_range_field_to_str(enum mlx5_flow_dest_range_field field)\n{\n\tswitch (field) {\n\tcase MLX5_FLOW_DEST_RANGE_FIELD_PKT_LEN:\n\t\treturn \"packet len\";\n\tdefault:\n\t\treturn \"unknown dest range field\";\n\t}\n}\n\nconst char *parse_fs_dst(struct trace_seq *p,\n\t\t\t const struct mlx5_flow_destination *dst,\n\t\t\t u32 counter_id)\n{\n\tconst char *ret = trace_seq_buffer_ptr(p);\n\n\tswitch (dst->type) {\n\tcase MLX5_FLOW_DESTINATION_TYPE_UPLINK:\n\t\ttrace_seq_printf(p, \"uplink\\n\");\n\t\tbreak;\n\tcase MLX5_FLOW_DESTINATION_TYPE_VPORT:\n\t\ttrace_seq_printf(p, \"vport=%u\\n\", dst->vport.num);\n\t\tbreak;\n\tcase MLX5_FLOW_DESTINATION_TYPE_FLOW_TABLE:\n\t\ttrace_seq_printf(p, \"ft=%p\\n\", dst->ft);\n\t\tbreak;\n\tcase MLX5_FLOW_DESTINATION_TYPE_FLOW_TABLE_NUM:\n\t\ttrace_seq_printf(p, \"ft_num=%u\\n\", dst->ft_num);\n\t\tbreak;\n\tcase MLX5_FLOW_DESTINATION_TYPE_TIR:\n\t\ttrace_seq_printf(p, \"tir=%u\\n\", dst->tir_num);\n\t\tbreak;\n\tcase MLX5_FLOW_DESTINATION_TYPE_FLOW_SAMPLER:\n\t\ttrace_seq_printf(p, \"sampler_id=%u\\n\", dst->sampler_id);\n\t\tbreak;\n\tcase MLX5_FLOW_DESTINATION_TYPE_COUNTER:\n\t\ttrace_seq_printf(p, \"counter_id=%u\\n\", counter_id);\n\t\tbreak;\n\tcase MLX5_FLOW_DESTINATION_TYPE_PORT:\n\t\ttrace_seq_printf(p, \"port\\n\");\n\t\tbreak;\n\tcase MLX5_FLOW_DESTINATION_TYPE_RANGE:\n\t\ttrace_seq_printf(p, \"field=%s min=%d max=%d\\n\",\n\t\t\t\t fs_dest_range_field_to_str(dst->range.field),\n\t\t\t\t dst->range.min, dst->range.max);\n\t\tbreak;\n\tcase MLX5_FLOW_DESTINATION_TYPE_TABLE_TYPE:\n\t\ttrace_seq_printf(p, \"flow_table_type=%u id:%u\\n\", dst->ft->type,\n\t\t\t\t dst->ft->id);\n\t\tbreak;\n\tcase MLX5_FLOW_DESTINATION_TYPE_NONE:\n\t\ttrace_seq_printf(p, \"none\\n\");\n\t\tbreak;\n\t}\n\n\ttrace_seq_putc(p, 0);\n\treturn ret;\n}\n\nEXPORT_TRACEPOINT_SYMBOL(mlx5_fs_add_ft);\nEXPORT_TRACEPOINT_SYMBOL(mlx5_fs_del_ft);\nEXPORT_TRACEPOINT_SYMBOL(mlx5_fs_add_fg);\nEXPORT_TRACEPOINT_SYMBOL(mlx5_fs_del_fg);\nEXPORT_TRACEPOINT_SYMBOL(mlx5_fs_set_fte);\nEXPORT_TRACEPOINT_SYMBOL(mlx5_fs_del_fte);\nEXPORT_TRACEPOINT_SYMBOL(mlx5_fs_add_rule);\nEXPORT_TRACEPOINT_SYMBOL(mlx5_fs_del_rule);\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}