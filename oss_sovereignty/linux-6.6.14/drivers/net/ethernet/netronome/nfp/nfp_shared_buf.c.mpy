{
  "module_name": "nfp_shared_buf.c",
  "hash_id": "327307c6230eacb30940bb5eb8f543edc2281c563d0814366d88238b79879f3f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/netronome/nfp/nfp_shared_buf.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <net/devlink.h>\n\n#include \"nfpcore/nfp_cpp.h\"\n#include \"nfpcore/nfp_nffw.h\"\n#include \"nfp_abi.h\"\n#include \"nfp_app.h\"\n#include \"nfp_main.h\"\n\nstatic u32 nfp_shared_buf_pool_unit(struct nfp_pf *pf, unsigned int sb)\n{\n\t__le32 sb_id = cpu_to_le32(sb);\n\tunsigned int i;\n\n\tfor (i = 0; i < pf->num_shared_bufs; i++)\n\t\tif (pf->shared_bufs[i].id == sb_id)\n\t\t\treturn le32_to_cpu(pf->shared_bufs[i].pool_size_unit);\n\n\tWARN_ON_ONCE(1);\n\treturn 0;\n}\n\nint nfp_shared_buf_pool_get(struct nfp_pf *pf, unsigned int sb, u16 pool_index,\n\t\t\t    struct devlink_sb_pool_info *pool_info)\n{\n\tstruct nfp_shared_buf_pool_info_get get_data;\n\tstruct nfp_shared_buf_pool_id id = {\n\t\t.shared_buf\t= cpu_to_le32(sb),\n\t\t.pool\t\t= cpu_to_le32(pool_index),\n\t};\n\tunsigned int unit_size;\n\tint n;\n\n\tunit_size = nfp_shared_buf_pool_unit(pf, sb);\n\tif (!unit_size)\n\t\treturn -EINVAL;\n\n\tn = nfp_mbox_cmd(pf, NFP_MBOX_POOL_GET, &id, sizeof(id),\n\t\t\t &get_data, sizeof(get_data));\n\tif (n < 0)\n\t\treturn n;\n\tif (n < sizeof(get_data))\n\t\treturn -EIO;\n\n\tpool_info->pool_type = le32_to_cpu(get_data.pool_type);\n\tpool_info->threshold_type = le32_to_cpu(get_data.threshold_type);\n\tpool_info->size = le32_to_cpu(get_data.size) * unit_size;\n\tpool_info->cell_size = unit_size;\n\n\treturn 0;\n}\n\nint nfp_shared_buf_pool_set(struct nfp_pf *pf, unsigned int sb,\n\t\t\t    u16 pool_index, u32 size,\n\t\t\t    enum devlink_sb_threshold_type threshold_type)\n{\n\tstruct nfp_shared_buf_pool_info_set set_data = {\n\t\t.id = {\n\t\t\t.shared_buf\t= cpu_to_le32(sb),\n\t\t\t.pool\t\t= cpu_to_le32(pool_index),\n\t\t},\n\t\t.threshold_type\t= cpu_to_le32(threshold_type),\n\t};\n\tunsigned int unit_size;\n\n\tunit_size = nfp_shared_buf_pool_unit(pf, sb);\n\tif (!unit_size || size % unit_size)\n\t\treturn -EINVAL;\n\tset_data.size = cpu_to_le32(size / unit_size);\n\n\treturn nfp_mbox_cmd(pf, NFP_MBOX_POOL_SET, &set_data, sizeof(set_data),\n\t\t\t    NULL, 0);\n}\n\nint nfp_shared_buf_register(struct nfp_pf *pf)\n{\n\tstruct devlink *devlink = priv_to_devlink(pf);\n\tunsigned int i, num_entries, entry_sz;\n\tstruct nfp_cpp_area *sb_desc_area;\n\tu8 __iomem *sb_desc;\n\tint n, err;\n\n\tif (!pf->mbox)\n\t\treturn 0;\n\n\tn = nfp_pf_rtsym_read_optional(pf, NFP_SHARED_BUF_COUNT_SYM_NAME, 0);\n\tif (n <= 0)\n\t\treturn n;\n\tnum_entries = n;\n\n\tsb_desc = nfp_pf_map_rtsym(pf, \"sb_tbl\", NFP_SHARED_BUF_TABLE_SYM_NAME,\n\t\t\t\t   num_entries * sizeof(pf->shared_bufs[0]),\n\t\t\t\t   &sb_desc_area);\n\tif (IS_ERR(sb_desc))\n\t\treturn PTR_ERR(sb_desc);\n\n\tentry_sz = nfp_cpp_area_size(sb_desc_area) / num_entries;\n\n\tpf->shared_bufs = kmalloc_array(num_entries, sizeof(pf->shared_bufs[0]),\n\t\t\t\t\tGFP_KERNEL);\n\tif (!pf->shared_bufs) {\n\t\terr = -ENOMEM;\n\t\tgoto err_release_area;\n\t}\n\n\tfor (i = 0; i < num_entries; i++) {\n\t\tstruct nfp_shared_buf *sb = &pf->shared_bufs[i];\n\n\t\t \n\t\tmemcpy_fromio(sb, sb_desc + i * entry_sz, sizeof(*sb));\n\n\t\terr = devlink_sb_register(devlink,\n\t\t\t\t\t  le32_to_cpu(sb->id),\n\t\t\t\t\t  le32_to_cpu(sb->size),\n\t\t\t\t\t  le16_to_cpu(sb->ingress_pools_count),\n\t\t\t\t\t  le16_to_cpu(sb->egress_pools_count),\n\t\t\t\t\t  le16_to_cpu(sb->ingress_tc_count),\n\t\t\t\t\t  le16_to_cpu(sb->egress_tc_count));\n\t\tif (err)\n\t\t\tgoto err_unreg_prev;\n\t}\n\tpf->num_shared_bufs = num_entries;\n\n\tnfp_cpp_area_release_free(sb_desc_area);\n\n\treturn 0;\n\nerr_unreg_prev:\n\twhile (i--)\n\t\tdevlink_sb_unregister(devlink,\n\t\t\t\t      le32_to_cpu(pf->shared_bufs[i].id));\n\tkfree(pf->shared_bufs);\nerr_release_area:\n\tnfp_cpp_area_release_free(sb_desc_area);\n\treturn err;\n}\n\nvoid nfp_shared_buf_unregister(struct nfp_pf *pf)\n{\n\tstruct devlink *devlink = priv_to_devlink(pf);\n\tunsigned int i;\n\n\tfor (i = 0; i < pf->num_shared_bufs; i++)\n\t\tdevlink_sb_unregister(devlink,\n\t\t\t\t      le32_to_cpu(pf->shared_bufs[i].id));\n\tkfree(pf->shared_bufs);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}