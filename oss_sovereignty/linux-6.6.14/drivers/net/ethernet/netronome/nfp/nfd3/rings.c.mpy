{
  "module_name": "rings.c",
  "hash_id": "e4b11723f268f15ede8abb882f574fa77c3f8b0e2e824b60af583bef15212e08",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/netronome/nfp/nfd3/rings.c",
  "human_readable_source": "\n \n\n#include <linux/seq_file.h>\n\n#include \"../nfp_net.h\"\n#include \"../nfp_net_dp.h\"\n#include \"../nfp_net_xsk.h\"\n#include \"nfd3.h\"\n\nstatic void nfp_nfd3_xsk_tx_bufs_free(struct nfp_net_tx_ring *tx_ring)\n{\n\tstruct nfp_nfd3_tx_buf *txbuf;\n\tunsigned int idx;\n\n\twhile (tx_ring->rd_p != tx_ring->wr_p) {\n\t\tidx = D_IDX(tx_ring, tx_ring->rd_p);\n\t\ttxbuf = &tx_ring->txbufs[idx];\n\n\t\ttxbuf->real_len = 0;\n\n\t\ttx_ring->qcp_rd_p++;\n\t\ttx_ring->rd_p++;\n\n\t\tif (tx_ring->r_vec->xsk_pool) {\n\t\t\tif (txbuf->is_xsk_tx)\n\t\t\t\tnfp_nfd3_xsk_tx_free(txbuf);\n\n\t\t\txsk_tx_completed(tx_ring->r_vec->xsk_pool, 1);\n\t\t}\n\t}\n}\n\n \nstatic void\nnfp_nfd3_tx_ring_reset(struct nfp_net_dp *dp, struct nfp_net_tx_ring *tx_ring)\n{\n\tstruct netdev_queue *nd_q;\n\tconst skb_frag_t *frag;\n\n\twhile (!tx_ring->is_xdp && tx_ring->rd_p != tx_ring->wr_p) {\n\t\tstruct nfp_nfd3_tx_buf *tx_buf;\n\t\tstruct sk_buff *skb;\n\t\tint idx, nr_frags;\n\n\t\tidx = D_IDX(tx_ring, tx_ring->rd_p);\n\t\ttx_buf = &tx_ring->txbufs[idx];\n\n\t\tskb = tx_ring->txbufs[idx].skb;\n\t\tnr_frags = skb_shinfo(skb)->nr_frags;\n\n\t\tif (tx_buf->fidx == -1) {\n\t\t\t \n\t\t\tdma_unmap_single(dp->dev, tx_buf->dma_addr,\n\t\t\t\t\t skb_headlen(skb), DMA_TO_DEVICE);\n\t\t} else {\n\t\t\t \n\t\t\tfrag = &skb_shinfo(skb)->frags[tx_buf->fidx];\n\t\t\tdma_unmap_page(dp->dev, tx_buf->dma_addr,\n\t\t\t\t       skb_frag_size(frag), DMA_TO_DEVICE);\n\t\t}\n\n\t\t \n\t\tif (tx_buf->fidx == nr_frags - 1)\n\t\t\tdev_kfree_skb_any(skb);\n\n\t\ttx_buf->dma_addr = 0;\n\t\ttx_buf->skb = NULL;\n\t\ttx_buf->fidx = -2;\n\n\t\ttx_ring->qcp_rd_p++;\n\t\ttx_ring->rd_p++;\n\t}\n\n\tif (tx_ring->is_xdp)\n\t\tnfp_nfd3_xsk_tx_bufs_free(tx_ring);\n\n\tmemset(tx_ring->txds, 0, tx_ring->size);\n\ttx_ring->wr_p = 0;\n\ttx_ring->rd_p = 0;\n\ttx_ring->qcp_rd_p = 0;\n\ttx_ring->wr_ptr_add = 0;\n\n\tif (tx_ring->is_xdp || !dp->netdev)\n\t\treturn;\n\n\tnd_q = netdev_get_tx_queue(dp->netdev, tx_ring->idx);\n\tnetdev_tx_reset_queue(nd_q);\n}\n\n \nstatic void nfp_nfd3_tx_ring_free(struct nfp_net_tx_ring *tx_ring)\n{\n\tstruct nfp_net_r_vector *r_vec = tx_ring->r_vec;\n\tstruct nfp_net_dp *dp = &r_vec->nfp_net->dp;\n\n\tkvfree(tx_ring->txbufs);\n\n\tif (tx_ring->txds)\n\t\tdma_free_coherent(dp->dev, tx_ring->size,\n\t\t\t\t  tx_ring->txds, tx_ring->dma);\n\n\ttx_ring->cnt = 0;\n\ttx_ring->txbufs = NULL;\n\ttx_ring->txds = NULL;\n\ttx_ring->dma = 0;\n\ttx_ring->size = 0;\n}\n\n \nstatic int\nnfp_nfd3_tx_ring_alloc(struct nfp_net_dp *dp, struct nfp_net_tx_ring *tx_ring)\n{\n\tstruct nfp_net_r_vector *r_vec = tx_ring->r_vec;\n\n\ttx_ring->cnt = dp->txd_cnt;\n\n\ttx_ring->size = array_size(tx_ring->cnt, sizeof(*tx_ring->txds));\n\ttx_ring->txds = dma_alloc_coherent(dp->dev, tx_ring->size,\n\t\t\t\t\t   &tx_ring->dma,\n\t\t\t\t\t   GFP_KERNEL | __GFP_NOWARN);\n\tif (!tx_ring->txds) {\n\t\tnetdev_warn(dp->netdev, \"failed to allocate TX descriptor ring memory, requested descriptor count: %d, consider lowering descriptor count\\n\",\n\t\t\t    tx_ring->cnt);\n\t\tgoto err_alloc;\n\t}\n\n\ttx_ring->txbufs = kvcalloc(tx_ring->cnt, sizeof(*tx_ring->txbufs),\n\t\t\t\t   GFP_KERNEL);\n\tif (!tx_ring->txbufs)\n\t\tgoto err_alloc;\n\n\tif (!tx_ring->is_xdp && dp->netdev)\n\t\tnetif_set_xps_queue(dp->netdev, &r_vec->affinity_mask,\n\t\t\t\t    tx_ring->idx);\n\n\treturn 0;\n\nerr_alloc:\n\tnfp_nfd3_tx_ring_free(tx_ring);\n\treturn -ENOMEM;\n}\n\nstatic void\nnfp_nfd3_tx_ring_bufs_free(struct nfp_net_dp *dp,\n\t\t\t   struct nfp_net_tx_ring *tx_ring)\n{\n\tunsigned int i;\n\n\tif (!tx_ring->is_xdp)\n\t\treturn;\n\n\tfor (i = 0; i < tx_ring->cnt; i++) {\n\t\tif (!tx_ring->txbufs[i].frag)\n\t\t\treturn;\n\n\t\tnfp_net_dma_unmap_rx(dp, tx_ring->txbufs[i].dma_addr);\n\t\t__free_page(virt_to_page(tx_ring->txbufs[i].frag));\n\t}\n}\n\nstatic int\nnfp_nfd3_tx_ring_bufs_alloc(struct nfp_net_dp *dp,\n\t\t\t    struct nfp_net_tx_ring *tx_ring)\n{\n\tstruct nfp_nfd3_tx_buf *txbufs = tx_ring->txbufs;\n\tunsigned int i;\n\n\tif (!tx_ring->is_xdp)\n\t\treturn 0;\n\n\tfor (i = 0; i < tx_ring->cnt; i++) {\n\t\ttxbufs[i].frag = nfp_net_rx_alloc_one(dp, &txbufs[i].dma_addr);\n\t\tif (!txbufs[i].frag) {\n\t\t\tnfp_nfd3_tx_ring_bufs_free(dp, tx_ring);\n\t\t\treturn -ENOMEM;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic void\nnfp_nfd3_print_tx_descs(struct seq_file *file,\n\t\t\tstruct nfp_net_r_vector *r_vec,\n\t\t\tstruct nfp_net_tx_ring *tx_ring,\n\t\t\tu32 d_rd_p, u32 d_wr_p)\n{\n\tstruct nfp_nfd3_tx_desc *txd;\n\tu32 txd_cnt = tx_ring->cnt;\n\tint i;\n\n\tfor (i = 0; i < txd_cnt; i++) {\n\t\tstruct xdp_buff *xdp;\n\t\tstruct sk_buff *skb;\n\n\t\ttxd = &tx_ring->txds[i];\n\t\tseq_printf(file, \"%04d: 0x%08x 0x%08x 0x%08x 0x%08x\", i,\n\t\t\t   txd->vals[0], txd->vals[1],\n\t\t\t   txd->vals[2], txd->vals[3]);\n\n\t\tif (!tx_ring->is_xdp) {\n\t\t\tskb = READ_ONCE(tx_ring->txbufs[i].skb);\n\t\t\tif (skb)\n\t\t\t\tseq_printf(file, \" skb->head=%p skb->data=%p\",\n\t\t\t\t\t   skb->head, skb->data);\n\t\t} else {\n\t\t\txdp = READ_ONCE(tx_ring->txbufs[i].xdp);\n\t\t\tif (xdp)\n\t\t\t\tseq_printf(file, \" xdp->data=%p\", xdp->data);\n\t\t}\n\n\t\tif (tx_ring->txbufs[i].dma_addr)\n\t\t\tseq_printf(file, \" dma_addr=%pad\",\n\t\t\t\t   &tx_ring->txbufs[i].dma_addr);\n\n\t\tif (i == tx_ring->rd_p % txd_cnt)\n\t\t\tseq_puts(file, \" H_RD\");\n\t\tif (i == tx_ring->wr_p % txd_cnt)\n\t\t\tseq_puts(file, \" H_WR\");\n\t\tif (i == d_rd_p % txd_cnt)\n\t\t\tseq_puts(file, \" D_RD\");\n\t\tif (i == d_wr_p % txd_cnt)\n\t\t\tseq_puts(file, \" D_WR\");\n\n\t\tseq_putc(file, '\\n');\n\t}\n}\n\n#define NFP_NFD3_CFG_CTRL_SUPPORTED\t\t\t\t\t\\\n\t(NFP_NET_CFG_CTRL_ENABLE | NFP_NET_CFG_CTRL_PROMISC |\t\t\\\n\t NFP_NET_CFG_CTRL_L2BC | NFP_NET_CFG_CTRL_L2MC |\t\t\\\n\t NFP_NET_CFG_CTRL_RXCSUM | NFP_NET_CFG_CTRL_TXCSUM |\t\t\\\n\t NFP_NET_CFG_CTRL_RXVLAN | NFP_NET_CFG_CTRL_TXVLAN |\t\t\\\n\t NFP_NET_CFG_CTRL_RXVLAN_V2 | NFP_NET_CFG_CTRL_RXQINQ |\t\t\\\n\t NFP_NET_CFG_CTRL_TXVLAN_V2 |\t\t\t\t\t\\\n\t NFP_NET_CFG_CTRL_GATHER | NFP_NET_CFG_CTRL_LSO |\t\t\\\n\t NFP_NET_CFG_CTRL_CTAG_FILTER | NFP_NET_CFG_CTRL_CMSG_DATA |\t\\\n\t NFP_NET_CFG_CTRL_RINGCFG | NFP_NET_CFG_CTRL_RSS |\t\t\\\n\t NFP_NET_CFG_CTRL_IRQMOD | NFP_NET_CFG_CTRL_TXRWB |\t\t\\\n\t NFP_NET_CFG_CTRL_VEPA |\t\t\t\t\t\\\n\t NFP_NET_CFG_CTRL_VXLAN | NFP_NET_CFG_CTRL_NVGRE |\t\t\\\n\t NFP_NET_CFG_CTRL_BPF | NFP_NET_CFG_CTRL_LSO2 |\t\t\t\\\n\t NFP_NET_CFG_CTRL_RSS2 | NFP_NET_CFG_CTRL_CSUM_COMPLETE |\t\\\n\t NFP_NET_CFG_CTRL_LIVE_ADDR)\n\nconst struct nfp_dp_ops nfp_nfd3_ops = {\n\t.version\t\t= NFP_NFD_VER_NFD3,\n\t.tx_min_desc_per_pkt\t= 1,\n\t.cap_mask\t\t= NFP_NFD3_CFG_CTRL_SUPPORTED,\n\t.dma_mask\t\t= DMA_BIT_MASK(40),\n\t.poll\t\t\t= nfp_nfd3_poll,\n\t.xsk_poll\t\t= nfp_nfd3_xsk_poll,\n\t.ctrl_poll\t\t= nfp_nfd3_ctrl_poll,\n\t.xmit\t\t\t= nfp_nfd3_tx,\n\t.ctrl_tx_one\t\t= nfp_nfd3_ctrl_tx_one,\n\t.rx_ring_fill_freelist\t= nfp_nfd3_rx_ring_fill_freelist,\n\t.tx_ring_alloc\t\t= nfp_nfd3_tx_ring_alloc,\n\t.tx_ring_reset\t\t= nfp_nfd3_tx_ring_reset,\n\t.tx_ring_free\t\t= nfp_nfd3_tx_ring_free,\n\t.tx_ring_bufs_alloc\t= nfp_nfd3_tx_ring_bufs_alloc,\n\t.tx_ring_bufs_free\t= nfp_nfd3_tx_ring_bufs_free,\n\t.print_tx_descs\t\t= nfp_nfd3_print_tx_descs\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}