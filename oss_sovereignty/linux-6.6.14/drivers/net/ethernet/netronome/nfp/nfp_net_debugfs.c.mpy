{
  "module_name": "nfp_net_debugfs.c",
  "hash_id": "4a56c3db4db48d966374417123a4ae3944739aa7cdb053a8468696262c2f6ef7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/netronome/nfp/nfp_net_debugfs.c",
  "human_readable_source": "\n \n#include <linux/debugfs.h>\n#include <linux/module.h>\n#include <linux/rtnetlink.h>\n\n#include \"nfp_net.h\"\n#include \"nfp_net_dp.h\"\n\nstatic struct dentry *nfp_dir;\n\nstatic int nfp_rx_q_show(struct seq_file *file, void *data)\n{\n\tstruct nfp_net_r_vector *r_vec = file->private;\n\tstruct nfp_net_rx_ring *rx_ring;\n\tint fl_rd_p, fl_wr_p, rxd_cnt;\n\tstruct nfp_net_rx_desc *rxd;\n\tstruct nfp_net *nn;\n\tvoid *frag;\n\tint i;\n\n\trtnl_lock();\n\n\tif (!r_vec->nfp_net || !r_vec->rx_ring)\n\t\tgoto out;\n\tnn = r_vec->nfp_net;\n\trx_ring = r_vec->rx_ring;\n\tif (!nfp_net_running(nn))\n\t\tgoto out;\n\n\trxd_cnt = rx_ring->cnt;\n\n\tfl_rd_p = nfp_qcp_rd_ptr_read(rx_ring->qcp_fl);\n\tfl_wr_p = nfp_qcp_wr_ptr_read(rx_ring->qcp_fl);\n\n\tseq_printf(file, \"RX[%02d,%02d]: cnt=%u dma=%pad host=%p   H_RD=%u H_WR=%u FL_RD=%u FL_WR=%u\\n\",\n\t\t   rx_ring->idx, rx_ring->fl_qcidx,\n\t\t   rx_ring->cnt, &rx_ring->dma, rx_ring->rxds,\n\t\t   rx_ring->rd_p, rx_ring->wr_p, fl_rd_p, fl_wr_p);\n\n\tfor (i = 0; i < rxd_cnt; i++) {\n\t\trxd = &rx_ring->rxds[i];\n\t\tseq_printf(file, \"%04d: 0x%08x 0x%08x\", i,\n\t\t\t   rxd->vals[0], rxd->vals[1]);\n\n\t\tif (!r_vec->xsk_pool) {\n\t\t\tfrag = READ_ONCE(rx_ring->rxbufs[i].frag);\n\t\t\tif (frag)\n\t\t\t\tseq_printf(file, \" frag=%p\", frag);\n\n\t\t\tif (rx_ring->rxbufs[i].dma_addr)\n\t\t\t\tseq_printf(file, \" dma_addr=%pad\",\n\t\t\t\t\t   &rx_ring->rxbufs[i].dma_addr);\n\t\t} else {\n\t\t\tif (rx_ring->xsk_rxbufs[i].dma_addr)\n\t\t\t\tseq_printf(file, \" dma_addr=%pad\",\n\t\t\t\t\t   &rx_ring->xsk_rxbufs[i].dma_addr);\n\t\t}\n\n\t\tif (i == rx_ring->rd_p % rxd_cnt)\n\t\t\tseq_puts(file, \" H_RD \");\n\t\tif (i == rx_ring->wr_p % rxd_cnt)\n\t\t\tseq_puts(file, \" H_WR \");\n\t\tif (i == fl_rd_p % rxd_cnt)\n\t\t\tseq_puts(file, \" FL_RD\");\n\t\tif (i == fl_wr_p % rxd_cnt)\n\t\t\tseq_puts(file, \" FL_WR\");\n\n\t\tseq_putc(file, '\\n');\n\t}\nout:\n\trtnl_unlock();\n\treturn 0;\n}\nDEFINE_SHOW_ATTRIBUTE(nfp_rx_q);\n\nstatic int nfp_tx_q_show(struct seq_file *file, void *data);\nDEFINE_SHOW_ATTRIBUTE(nfp_tx_q);\n\nstatic int nfp_tx_q_show(struct seq_file *file, void *data)\n{\n\tstruct nfp_net_r_vector *r_vec = file->private;\n\tstruct nfp_net_tx_ring *tx_ring;\n\tstruct nfp_net *nn;\n\tint d_rd_p, d_wr_p;\n\n\trtnl_lock();\n\n\tif (debugfs_real_fops(file->file) == &nfp_tx_q_fops)\n\t\ttx_ring = r_vec->tx_ring;\n\telse\n\t\ttx_ring = r_vec->xdp_ring;\n\tif (!r_vec->nfp_net || !tx_ring)\n\t\tgoto out;\n\tnn = r_vec->nfp_net;\n\tif (!nfp_net_running(nn))\n\t\tgoto out;\n\n\td_rd_p = nfp_qcp_rd_ptr_read(tx_ring->qcp_q);\n\td_wr_p = nfp_qcp_wr_ptr_read(tx_ring->qcp_q);\n\n\tseq_printf(file, \"TX[%02d,%02d%s]: cnt=%u dma=%pad host=%p   H_RD=%u H_WR=%u D_RD=%u D_WR=%u\",\n\t\t   tx_ring->idx, tx_ring->qcidx,\n\t\t   tx_ring == r_vec->tx_ring ? \"\" : \"xdp\",\n\t\t   tx_ring->cnt, &tx_ring->dma, tx_ring->txds,\n\t\t   tx_ring->rd_p, tx_ring->wr_p, d_rd_p, d_wr_p);\n\tif (tx_ring->txrwb)\n\t\tseq_printf(file, \" TXRWB=%llu\", *tx_ring->txrwb);\n\tseq_putc(file, '\\n');\n\n\tnfp_net_debugfs_print_tx_descs(file, &nn->dp, r_vec, tx_ring,\n\t\t\t\t       d_rd_p, d_wr_p);\nout:\n\trtnl_unlock();\n\treturn 0;\n}\n\nstatic int nfp_xdp_q_show(struct seq_file *file, void *data)\n{\n\treturn nfp_tx_q_show(file, data);\n}\nDEFINE_SHOW_ATTRIBUTE(nfp_xdp_q);\n\nvoid nfp_net_debugfs_vnic_add(struct nfp_net *nn, struct dentry *ddir)\n{\n\tstruct dentry *queues, *tx, *rx, *xdp;\n\tchar name[20];\n\tint i;\n\n\tif (IS_ERR_OR_NULL(nfp_dir))\n\t\treturn;\n\n\tif (nfp_net_is_data_vnic(nn))\n\t\tsprintf(name, \"vnic%d\", nn->id);\n\telse\n\t\tstrcpy(name, \"ctrl-vnic\");\n\tnn->debugfs_dir = debugfs_create_dir(name, ddir);\n\n\t \n\tqueues = debugfs_create_dir(\"queue\", nn->debugfs_dir);\n\n\trx = debugfs_create_dir(\"rx\", queues);\n\ttx = debugfs_create_dir(\"tx\", queues);\n\txdp = debugfs_create_dir(\"xdp\", queues);\n\n\tfor (i = 0; i < min(nn->max_rx_rings, nn->max_r_vecs); i++) {\n\t\tsprintf(name, \"%d\", i);\n\t\tdebugfs_create_file(name, 0400, rx,\n\t\t\t\t    &nn->r_vecs[i], &nfp_rx_q_fops);\n\t\tdebugfs_create_file(name, 0400, xdp,\n\t\t\t\t    &nn->r_vecs[i], &nfp_xdp_q_fops);\n\t}\n\n\tfor (i = 0; i < min(nn->max_tx_rings, nn->max_r_vecs); i++) {\n\t\tsprintf(name, \"%d\", i);\n\t\tdebugfs_create_file(name, 0400, tx,\n\t\t\t\t    &nn->r_vecs[i], &nfp_tx_q_fops);\n\t}\n}\n\nstruct dentry *nfp_net_debugfs_device_add(struct pci_dev *pdev)\n{\n\treturn debugfs_create_dir(pci_name(pdev), nfp_dir);\n}\n\nvoid nfp_net_debugfs_dir_clean(struct dentry **dir)\n{\n\tdebugfs_remove_recursive(*dir);\n\t*dir = NULL;\n}\n\nvoid nfp_net_debugfs_create(void)\n{\n\tnfp_dir = debugfs_create_dir(\"nfp_net\", NULL);\n}\n\nvoid nfp_net_debugfs_destroy(void)\n{\n\tdebugfs_remove_recursive(nfp_dir);\n\tnfp_dir = NULL;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}