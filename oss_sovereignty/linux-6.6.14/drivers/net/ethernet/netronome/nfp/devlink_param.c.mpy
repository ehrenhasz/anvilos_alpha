{
  "module_name": "devlink_param.c",
  "hash_id": "a070e4b497661147079463cbe212d80a4506b4d2251668ee854c02677009ad3d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/netronome/nfp/devlink_param.c",
  "human_readable_source": "\n \n\n#include <net/devlink.h>\n\n#include \"nfpcore/nfp.h\"\n#include \"nfpcore/nfp_nsp.h\"\n#include \"nfp_main.h\"\n\n \nstruct nfp_devlink_param_u8_arg {\n\tconst char *hwinfo_name;\n\tconst char *default_hi_val;\n\tint invalid_dl_val;\n\tu8 hi_to_dl[4];\n\tu8 dl_to_hi[4];\n\tu8 max_dl_val;\n\tu8 max_hi_val;\n};\n\nstatic const struct nfp_devlink_param_u8_arg nfp_devlink_u8_args[] = {\n\t[DEVLINK_PARAM_GENERIC_ID_FW_LOAD_POLICY] = {\n\t\t.hwinfo_name = \"app_fw_from_flash\",\n\t\t.default_hi_val = NFP_NSP_APP_FW_LOAD_DEFAULT,\n\t\t.invalid_dl_val =\n\t\t\tDEVLINK_PARAM_FW_LOAD_POLICY_VALUE_UNKNOWN,\n\t\t.hi_to_dl = {\n\t\t\t[NFP_NSP_APP_FW_LOAD_DISK] =\n\t\t\t\tDEVLINK_PARAM_FW_LOAD_POLICY_VALUE_DISK,\n\t\t\t[NFP_NSP_APP_FW_LOAD_FLASH] =\n\t\t\t\tDEVLINK_PARAM_FW_LOAD_POLICY_VALUE_FLASH,\n\t\t\t[NFP_NSP_APP_FW_LOAD_PREF] =\n\t\t\t\tDEVLINK_PARAM_FW_LOAD_POLICY_VALUE_DRIVER,\n\t\t},\n\t\t.dl_to_hi = {\n\t\t\t[DEVLINK_PARAM_FW_LOAD_POLICY_VALUE_DRIVER] =\n\t\t\t\tNFP_NSP_APP_FW_LOAD_PREF,\n\t\t\t[DEVLINK_PARAM_FW_LOAD_POLICY_VALUE_FLASH] =\n\t\t\t\tNFP_NSP_APP_FW_LOAD_FLASH,\n\t\t\t[DEVLINK_PARAM_FW_LOAD_POLICY_VALUE_DISK] =\n\t\t\t\tNFP_NSP_APP_FW_LOAD_DISK,\n\t\t},\n\t\t.max_dl_val = DEVLINK_PARAM_FW_LOAD_POLICY_VALUE_DISK,\n\t\t.max_hi_val = NFP_NSP_APP_FW_LOAD_PREF,\n\t},\n\t[DEVLINK_PARAM_GENERIC_ID_RESET_DEV_ON_DRV_PROBE] = {\n\t\t.hwinfo_name = \"abi_drv_reset\",\n\t\t.default_hi_val = NFP_NSP_DRV_RESET_DEFAULT,\n\t\t.invalid_dl_val =\n\t\t\tDEVLINK_PARAM_RESET_DEV_ON_DRV_PROBE_VALUE_UNKNOWN,\n\t\t.hi_to_dl = {\n\t\t\t[NFP_NSP_DRV_RESET_ALWAYS] =\n\t\t\t\tDEVLINK_PARAM_RESET_DEV_ON_DRV_PROBE_VALUE_ALWAYS,\n\t\t\t[NFP_NSP_DRV_RESET_NEVER] =\n\t\t\t\tDEVLINK_PARAM_RESET_DEV_ON_DRV_PROBE_VALUE_NEVER,\n\t\t\t[NFP_NSP_DRV_RESET_DISK] =\n\t\t\t\tDEVLINK_PARAM_RESET_DEV_ON_DRV_PROBE_VALUE_DISK,\n\t\t},\n\t\t.dl_to_hi = {\n\t\t\t[DEVLINK_PARAM_RESET_DEV_ON_DRV_PROBE_VALUE_ALWAYS] =\n\t\t\t\tNFP_NSP_DRV_RESET_ALWAYS,\n\t\t\t[DEVLINK_PARAM_RESET_DEV_ON_DRV_PROBE_VALUE_NEVER] =\n\t\t\t\tNFP_NSP_DRV_RESET_NEVER,\n\t\t\t[DEVLINK_PARAM_RESET_DEV_ON_DRV_PROBE_VALUE_DISK] =\n\t\t\t\tNFP_NSP_DRV_RESET_DISK,\n\t\t},\n\t\t.max_dl_val = DEVLINK_PARAM_RESET_DEV_ON_DRV_PROBE_VALUE_DISK,\n\t\t.max_hi_val = NFP_NSP_DRV_RESET_NEVER,\n\t}\n};\n\nstatic int\nnfp_devlink_param_u8_get(struct devlink *devlink, u32 id,\n\t\t\t struct devlink_param_gset_ctx *ctx)\n{\n\tconst struct nfp_devlink_param_u8_arg *arg;\n\tstruct nfp_pf *pf = devlink_priv(devlink);\n\tstruct nfp_nsp *nsp;\n\tchar hwinfo[32];\n\tlong value;\n\tint err;\n\n\tif (id >= ARRAY_SIZE(nfp_devlink_u8_args))\n\t\treturn -EOPNOTSUPP;\n\n\targ = &nfp_devlink_u8_args[id];\n\n\tnsp = nfp_nsp_open(pf->cpp);\n\tif (IS_ERR(nsp)) {\n\t\terr = PTR_ERR(nsp);\n\t\tnfp_warn(pf->cpp, \"can't access NSP: %d\\n\", err);\n\t\treturn err;\n\t}\n\n\tsnprintf(hwinfo, sizeof(hwinfo), arg->hwinfo_name);\n\terr = nfp_nsp_hwinfo_lookup_optional(nsp, hwinfo, sizeof(hwinfo),\n\t\t\t\t\t     arg->default_hi_val);\n\tif (err) {\n\t\tnfp_warn(pf->cpp, \"HWinfo lookup failed: %d\\n\", err);\n\t\tgoto exit_close_nsp;\n\t}\n\n\terr = kstrtol(hwinfo, 0, &value);\n\tif (err || value < 0 || value > arg->max_hi_val) {\n\t\tnfp_warn(pf->cpp, \"HWinfo '%s' value %li invalid\\n\",\n\t\t\t arg->hwinfo_name, value);\n\n\t\tif (arg->invalid_dl_val >= 0)\n\t\t\tctx->val.vu8 = arg->invalid_dl_val;\n\t\telse\n\t\t\terr = arg->invalid_dl_val;\n\n\t\tgoto exit_close_nsp;\n\t}\n\n\tctx->val.vu8 = arg->hi_to_dl[value];\n\nexit_close_nsp:\n\tnfp_nsp_close(nsp);\n\treturn err;\n}\n\nstatic int\nnfp_devlink_param_u8_set(struct devlink *devlink, u32 id,\n\t\t\t struct devlink_param_gset_ctx *ctx)\n{\n\tconst struct nfp_devlink_param_u8_arg *arg;\n\tstruct nfp_pf *pf = devlink_priv(devlink);\n\tstruct nfp_nsp *nsp;\n\tchar hwinfo[32];\n\tint err;\n\n\tif (id >= ARRAY_SIZE(nfp_devlink_u8_args))\n\t\treturn -EOPNOTSUPP;\n\n\targ = &nfp_devlink_u8_args[id];\n\n\tnsp = nfp_nsp_open(pf->cpp);\n\tif (IS_ERR(nsp)) {\n\t\terr = PTR_ERR(nsp);\n\t\tnfp_warn(pf->cpp, \"can't access NSP: %d\\n\", err);\n\t\treturn err;\n\t}\n\n\t \n\tsnprintf(hwinfo, sizeof(hwinfo), \"%s=%u\",\n\t\t arg->hwinfo_name, arg->dl_to_hi[ctx->val.vu8]);\n\terr = nfp_nsp_hwinfo_set(nsp, hwinfo, sizeof(hwinfo));\n\tif (err) {\n\t\tnfp_warn(pf->cpp, \"HWinfo set failed: %d\\n\", err);\n\t\tgoto exit_close_nsp;\n\t}\n\nexit_close_nsp:\n\tnfp_nsp_close(nsp);\n\treturn err;\n}\n\nstatic int\nnfp_devlink_param_u8_validate(struct devlink *devlink, u32 id,\n\t\t\t      union devlink_param_value val,\n\t\t\t      struct netlink_ext_ack *extack)\n{\n\tconst struct nfp_devlink_param_u8_arg *arg;\n\n\tif (id >= ARRAY_SIZE(nfp_devlink_u8_args))\n\t\treturn -EOPNOTSUPP;\n\n\targ = &nfp_devlink_u8_args[id];\n\n\tif (val.vu8 > arg->max_dl_val) {\n\t\tNL_SET_ERR_MSG_MOD(extack, \"parameter out of range\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (val.vu8 == arg->invalid_dl_val) {\n\t\tNL_SET_ERR_MSG_MOD(extack, \"unknown/invalid value specified\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct devlink_param nfp_devlink_params[] = {\n\tDEVLINK_PARAM_GENERIC(FW_LOAD_POLICY,\n\t\t\t      BIT(DEVLINK_PARAM_CMODE_PERMANENT),\n\t\t\t      nfp_devlink_param_u8_get,\n\t\t\t      nfp_devlink_param_u8_set,\n\t\t\t      nfp_devlink_param_u8_validate),\n\tDEVLINK_PARAM_GENERIC(RESET_DEV_ON_DRV_PROBE,\n\t\t\t      BIT(DEVLINK_PARAM_CMODE_PERMANENT),\n\t\t\t      nfp_devlink_param_u8_get,\n\t\t\t      nfp_devlink_param_u8_set,\n\t\t\t      nfp_devlink_param_u8_validate),\n};\n\nstatic int nfp_devlink_supports_params(struct nfp_pf *pf)\n{\n\tstruct nfp_nsp *nsp;\n\tbool supported;\n\tint err;\n\n\tnsp = nfp_nsp_open(pf->cpp);\n\tif (IS_ERR(nsp)) {\n\t\terr = PTR_ERR(nsp);\n\t\tdev_err(&pf->pdev->dev, \"Failed to access the NSP: %d\\n\", err);\n\t\treturn err;\n\t}\n\n\tsupported = nfp_nsp_has_hwinfo_lookup(nsp) &&\n\t\t    nfp_nsp_has_hwinfo_set(nsp);\n\n\tnfp_nsp_close(nsp);\n\treturn supported;\n}\n\nint nfp_devlink_params_register(struct nfp_pf *pf)\n{\n\tstruct devlink *devlink = priv_to_devlink(pf);\n\tint err;\n\n\terr = nfp_devlink_supports_params(pf);\n\tif (err <= 0)\n\t\treturn err;\n\n\treturn devl_params_register(devlink, nfp_devlink_params,\n\t\t\t\t    ARRAY_SIZE(nfp_devlink_params));\n}\n\nvoid nfp_devlink_params_unregister(struct nfp_pf *pf)\n{\n\tint err;\n\n\terr = nfp_devlink_supports_params(pf);\n\tif (err <= 0)\n\t\treturn;\n\n\tdevl_params_unregister(priv_to_devlink(pf), nfp_devlink_params,\n\t\t\t       ARRAY_SIZE(nfp_devlink_params));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}