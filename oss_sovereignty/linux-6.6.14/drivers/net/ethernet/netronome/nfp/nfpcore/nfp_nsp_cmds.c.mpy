{
  "module_name": "nfp_nsp_cmds.c",
  "hash_id": "3a386b438dbf153574108c1b4a31de54b4a2a394a9d655cf90323e40ab48c321",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/netronome/nfp/nfpcore/nfp_nsp_cmds.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n\n#include \"nfp.h\"\n#include \"nfp_nsp.h\"\n\nstruct nsp_identify {\n\tu8 version[40];\n\tu8 flags;\n\tu8 br_primary;\n\tu8 br_secondary;\n\tu8 br_nsp;\n\t__le16 primary;\n\t__le16 secondary;\n\t__le16 nsp;\n\tu8 reserved[6];\n\t__le64 sensor_mask;\n};\n\nstruct nfp_nsp_identify *__nfp_nsp_identify(struct nfp_nsp *nsp)\n{\n\tstruct nfp_nsp_identify *nspi = NULL;\n\tstruct nsp_identify *ni;\n\tint ret;\n\n\tif (nfp_nsp_get_abi_ver_minor(nsp) < 15)\n\t\treturn NULL;\n\n\tni = kzalloc(sizeof(*ni), GFP_KERNEL);\n\tif (!ni)\n\t\treturn NULL;\n\n\tret = nfp_nsp_read_identify(nsp, ni, sizeof(*ni));\n\tif (ret < 0) {\n\t\tnfp_err(nfp_nsp_cpp(nsp), \"reading bsp version failed %d\\n\",\n\t\t\tret);\n\t\tgoto exit_free;\n\t}\n\n\tnspi = kzalloc(sizeof(*nspi), GFP_KERNEL);\n\tif (!nspi)\n\t\tgoto exit_free;\n\n\tmemcpy(nspi->version, ni->version, sizeof(nspi->version));\n\tnspi->version[sizeof(nspi->version) - 1] = '\\0';\n\tnspi->flags = ni->flags;\n\tnspi->br_primary = ni->br_primary;\n\tnspi->br_secondary = ni->br_secondary;\n\tnspi->br_nsp = ni->br_nsp;\n\tnspi->primary = le16_to_cpu(ni->primary);\n\tnspi->secondary = le16_to_cpu(ni->secondary);\n\tnspi->nsp = le16_to_cpu(ni->nsp);\n\tnspi->sensor_mask = le64_to_cpu(ni->sensor_mask);\n\nexit_free:\n\tkfree(ni);\n\treturn nspi;\n}\n\nstruct nfp_sensors {\n\t__le32 chip_temp;\n\t__le32 assembly_power;\n\t__le32 assembly_12v_power;\n\t__le32 assembly_3v3_power;\n};\n\nint nfp_hwmon_read_sensor(struct nfp_cpp *cpp, enum nfp_nsp_sensor_id id,\n\t\t\t  long *val)\n{\n\tstruct nfp_sensors s;\n\tstruct nfp_nsp *nsp;\n\tint ret;\n\n\tnsp = nfp_nsp_open(cpp);\n\tif (IS_ERR(nsp))\n\t\treturn PTR_ERR(nsp);\n\n\tret = nfp_nsp_read_sensors(nsp, BIT(id), &s, sizeof(s));\n\tnfp_nsp_close(nsp);\n\n\tif (ret < 0)\n\t\treturn ret;\n\n\tswitch (id) {\n\tcase NFP_SENSOR_CHIP_TEMPERATURE:\n\t\t*val = le32_to_cpu(s.chip_temp);\n\t\tbreak;\n\tcase NFP_SENSOR_ASSEMBLY_POWER:\n\t\t*val = le32_to_cpu(s.assembly_power);\n\t\tbreak;\n\tcase NFP_SENSOR_ASSEMBLY_12V_POWER:\n\t\t*val = le32_to_cpu(s.assembly_12v_power);\n\t\tbreak;\n\tcase NFP_SENSOR_ASSEMBLY_3V3_POWER:\n\t\t*val = le32_to_cpu(s.assembly_3v3_power);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}