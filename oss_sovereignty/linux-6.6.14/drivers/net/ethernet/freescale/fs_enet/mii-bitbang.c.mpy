{
  "module_name": "mii-bitbang.c",
  "hash_id": "cd74ab82100c51c16c77800a5c57683895457379fcc0b7a74fa5b005568eeb5d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/freescale/fs_enet/mii-bitbang.c",
  "human_readable_source": " \n\n#include <linux/module.h>\n#include <linux/ioport.h>\n#include <linux/slab.h>\n#include <linux/interrupt.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n#include <linux/mii.h>\n#include <linux/platform_device.h>\n#include <linux/mdio-bitbang.h>\n#include <linux/of_address.h>\n#include <linux/of_mdio.h>\n#include <linux/of_platform.h>\n\n#include \"fs_enet.h\"\n\nstruct bb_info {\n\tstruct mdiobb_ctrl ctrl;\n\tu32 __iomem *dir;\n\tu32 __iomem *dat;\n\tu32 mdio_msk;\n\tu32 mdc_msk;\n};\n\n \nstatic inline void bb_set(u32 __iomem *p, u32 m)\n{\n\tout_be32(p, in_be32(p) | m);\n}\n\nstatic inline void bb_clr(u32 __iomem *p, u32 m)\n{\n\tout_be32(p, in_be32(p) & ~m);\n}\n\nstatic inline int bb_read(u32 __iomem *p, u32 m)\n{\n\treturn (in_be32(p) & m) != 0;\n}\n\nstatic inline void mdio_dir(struct mdiobb_ctrl *ctrl, int dir)\n{\n\tstruct bb_info *bitbang = container_of(ctrl, struct bb_info, ctrl);\n\n\tif (dir)\n\t\tbb_set(bitbang->dir, bitbang->mdio_msk);\n\telse\n\t\tbb_clr(bitbang->dir, bitbang->mdio_msk);\n\n\t \n\tin_be32(bitbang->dir);\n}\n\nstatic inline int mdio_read(struct mdiobb_ctrl *ctrl)\n{\n\tstruct bb_info *bitbang = container_of(ctrl, struct bb_info, ctrl);\n\treturn bb_read(bitbang->dat, bitbang->mdio_msk);\n}\n\nstatic inline void mdio(struct mdiobb_ctrl *ctrl, int what)\n{\n\tstruct bb_info *bitbang = container_of(ctrl, struct bb_info, ctrl);\n\n\tif (what)\n\t\tbb_set(bitbang->dat, bitbang->mdio_msk);\n\telse\n\t\tbb_clr(bitbang->dat, bitbang->mdio_msk);\n\n\t \n\tin_be32(bitbang->dat);\n}\n\nstatic inline void mdc(struct mdiobb_ctrl *ctrl, int what)\n{\n\tstruct bb_info *bitbang = container_of(ctrl, struct bb_info, ctrl);\n\n\tif (what)\n\t\tbb_set(bitbang->dat, bitbang->mdc_msk);\n\telse\n\t\tbb_clr(bitbang->dat, bitbang->mdc_msk);\n\n\t \n\tin_be32(bitbang->dat);\n}\n\nstatic const struct mdiobb_ops bb_ops = {\n\t.owner = THIS_MODULE,\n\t.set_mdc = mdc,\n\t.set_mdio_dir = mdio_dir,\n\t.set_mdio_data = mdio,\n\t.get_mdio_data = mdio_read,\n};\n\nstatic int fs_mii_bitbang_init(struct mii_bus *bus, struct device_node *np)\n{\n\tstruct resource res;\n\tconst u32 *data;\n\tint mdio_pin, mdc_pin, len;\n\tstruct bb_info *bitbang = bus->priv;\n\n\tint ret = of_address_to_resource(np, 0, &res);\n\tif (ret)\n\t\treturn ret;\n\n\tif (resource_size(&res) <= 13)\n\t\treturn -ENODEV;\n\n\t \n\tsnprintf(bus->id, MII_BUS_ID_SIZE, \"%x\", res.start);\n\n\tdata = of_get_property(np, \"fsl,mdio-pin\", &len);\n\tif (!data || len != 4)\n\t\treturn -ENODEV;\n\tmdio_pin = *data;\n\n\tdata = of_get_property(np, \"fsl,mdc-pin\", &len);\n\tif (!data || len != 4)\n\t\treturn -ENODEV;\n\tmdc_pin = *data;\n\n\tbitbang->dir = ioremap(res.start, resource_size(&res));\n\tif (!bitbang->dir)\n\t\treturn -ENOMEM;\n\n\tbitbang->dat = bitbang->dir + 4;\n\tbitbang->mdio_msk = 1 << (31 - mdio_pin);\n\tbitbang->mdc_msk = 1 << (31 - mdc_pin);\n\n\treturn 0;\n}\n\nstatic int fs_enet_mdio_probe(struct platform_device *ofdev)\n{\n\tstruct mii_bus *new_bus;\n\tstruct bb_info *bitbang;\n\tint ret = -ENOMEM;\n\n\tbitbang = kzalloc(sizeof(struct bb_info), GFP_KERNEL);\n\tif (!bitbang)\n\t\tgoto out;\n\n\tbitbang->ctrl.ops = &bb_ops;\n\n\tnew_bus = alloc_mdio_bitbang(&bitbang->ctrl);\n\tif (!new_bus)\n\t\tgoto out_free_priv;\n\n\tnew_bus->name = \"CPM2 Bitbanged MII\",\n\n\tret = fs_mii_bitbang_init(new_bus, ofdev->dev.of_node);\n\tif (ret)\n\t\tgoto out_free_bus;\n\n\tnew_bus->phy_mask = ~0;\n\n\tnew_bus->parent = &ofdev->dev;\n\tplatform_set_drvdata(ofdev, new_bus);\n\n\tret = of_mdiobus_register(new_bus, ofdev->dev.of_node);\n\tif (ret)\n\t\tgoto out_unmap_regs;\n\n\treturn 0;\n\nout_unmap_regs:\n\tiounmap(bitbang->dir);\nout_free_bus:\n\tfree_mdio_bitbang(new_bus);\nout_free_priv:\n\tkfree(bitbang);\nout:\n\treturn ret;\n}\n\nstatic void fs_enet_mdio_remove(struct platform_device *ofdev)\n{\n\tstruct mii_bus *bus = platform_get_drvdata(ofdev);\n\tstruct bb_info *bitbang = bus->priv;\n\n\tmdiobus_unregister(bus);\n\tfree_mdio_bitbang(bus);\n\tiounmap(bitbang->dir);\n\tkfree(bitbang);\n}\n\nstatic const struct of_device_id fs_enet_mdio_bb_match[] = {\n\t{\n\t\t.compatible = \"fsl,cpm2-mdio-bitbang\",\n\t},\n\t{},\n};\nMODULE_DEVICE_TABLE(of, fs_enet_mdio_bb_match);\n\nstatic struct platform_driver fs_enet_bb_mdio_driver = {\n\t.driver = {\n\t\t.name = \"fsl-bb-mdio\",\n\t\t.of_match_table = fs_enet_mdio_bb_match,\n\t},\n\t.probe = fs_enet_mdio_probe,\n\t.remove_new = fs_enet_mdio_remove,\n};\n\nmodule_platform_driver(fs_enet_bb_mdio_driver);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}