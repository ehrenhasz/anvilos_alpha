{
  "module_name": "fman_muram.c",
  "hash_id": "eb0d6044f30bdb574291609d9d6a7315ca3c47c0fff6b63a39174238176d58ff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/freescale/fman/fman_muram.c",
  "human_readable_source": "\n \n\n#include \"fman_muram.h\"\n\n#include <linux/io.h>\n#include <linux/slab.h>\n#include <linux/genalloc.h>\n\nstruct muram_info {\n\tstruct gen_pool *pool;\n\tvoid __iomem *vbase;\n\tsize_t size;\n\tphys_addr_t pbase;\n};\n\nstatic unsigned long fman_muram_vbase_to_offset(struct muram_info *muram,\n\t\t\t\t\t\tunsigned long vaddr)\n{\n\treturn vaddr - (unsigned long)muram->vbase;\n}\n\n \nstruct muram_info *fman_muram_init(phys_addr_t base, size_t size)\n{\n\tstruct muram_info *muram;\n\tvoid __iomem *vaddr;\n\tint ret;\n\n\tmuram = kzalloc(sizeof(*muram), GFP_KERNEL);\n\tif (!muram)\n\t\treturn NULL;\n\n\tmuram->pool = gen_pool_create(ilog2(64), -1);\n\tif (!muram->pool) {\n\t\tpr_err(\"%s(): MURAM pool create failed\\n\", __func__);\n\t\tgoto  muram_free;\n\t}\n\n\tvaddr = ioremap(base, size);\n\tif (!vaddr) {\n\t\tpr_err(\"%s(): MURAM ioremap failed\\n\", __func__);\n\t\tgoto pool_destroy;\n\t}\n\n\tret = gen_pool_add_virt(muram->pool, (unsigned long)vaddr,\n\t\t\t\tbase, size, -1);\n\tif (ret < 0) {\n\t\tpr_err(\"%s(): MURAM pool add failed\\n\", __func__);\n\t\tiounmap(vaddr);\n\t\tgoto pool_destroy;\n\t}\n\n\tmemset_io(vaddr, 0, (int)size);\n\n\tmuram->vbase = vaddr;\n\tmuram->pbase = base;\n\treturn muram;\n\npool_destroy:\n\tgen_pool_destroy(muram->pool);\nmuram_free:\n\tkfree(muram);\n\treturn NULL;\n}\n\n \nunsigned long fman_muram_offset_to_vbase(struct muram_info *muram,\n\t\t\t\t\t unsigned long offset)\n{\n\treturn offset + (unsigned long)muram->vbase;\n}\n\n \nunsigned long fman_muram_alloc(struct muram_info *muram, size_t size)\n{\n\tunsigned long vaddr;\n\n\tvaddr = gen_pool_alloc(muram->pool, size);\n\tif (!vaddr)\n\t\treturn -ENOMEM;\n\n\tmemset_io((void __iomem *)vaddr, 0, size);\n\n\treturn fman_muram_vbase_to_offset(muram, vaddr);\n}\n\n \nvoid fman_muram_free_mem(struct muram_info *muram, unsigned long offset,\n\t\t\t size_t size)\n{\n\tunsigned long addr = fman_muram_offset_to_vbase(muram, offset);\n\n\tgen_pool_free(muram->pool, addr, size);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}