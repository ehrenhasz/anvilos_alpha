{
  "module_name": "funeth_txrx.h",
  "hash_id": "f02f05fe1f0e7dd77433b89b6e30706d4cbe46a1b5a1d21ee8c922e5f0f4867a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/fungible/funeth/funeth_txrx.h",
  "human_readable_source": " \n\n#ifndef _FUNETH_TXRX_H\n#define _FUNETH_TXRX_H\n\n#include <linux/netdevice.h>\n#include <linux/u64_stats_sync.h>\n#include <net/xdp.h>\n\n \n#define FUNETH_SQE_SIZE 64U\n\n \n#define FUNETH_FUNOS_HDR_SZ (sizeof(struct fun_eth_tx_req))\n\n \n#define FUNETH_GLE_PER_DESC (FUNETH_SQE_SIZE / sizeof(struct fun_dataop_gl))\n\n \n#define FUNETH_MAX_GL_SZ ((MAX_SKB_FRAGS + 1) * sizeof(struct fun_dataop_gl))\n\n#if IS_ENABLED(CONFIG_TLS_DEVICE)\n# define FUNETH_TLS_SZ sizeof(struct fun_eth_tls)\n#else\n# define FUNETH_TLS_SZ 0\n#endif\n\n \n#define FUNETH_MAX_GL_DESC \\\n\tDIV_ROUND_UP((FUNETH_FUNOS_HDR_SZ + FUNETH_MAX_GL_SZ + FUNETH_TLS_SZ), \\\n\t\t     FUNETH_SQE_SIZE)\n\n \n#define FUNETH_MAX_PKT_DESC FUNETH_MAX_GL_DESC\n\n \n#define FUNETH_CQE_SIZE 64U\n\n \n#define FUNETH_CQE_INFO_OFFSET (FUNETH_CQE_SIZE - sizeof(struct fun_cqe_info))\n\n \n#define FUN_IRQ_CQ_DB(usec, pkts) \\\n\t(FUN_DB_IRQ_ARM_F | ((usec) << FUN_DB_INTCOAL_USEC_S) | \\\n\t ((pkts) << FUN_DB_INTCOAL_ENTRIES_S))\n\n \n#define FUN_IRQ_SQ_DB(usec, pkts) \\\n\t(FUN_DB_IRQ_ARM_F | \\\n\t ((usec) << FUN_DB_INTCOAL_USEC_S) | \\\n\t ((pkts) << FUN_DB_INTCOAL_ENTRIES_S))\n\n \n#define FUN_RX_TAILROOM SKB_DATA_ALIGN(sizeof(struct skb_shared_info))\n\n \n#define FUN_XDP_HEADROOM 192\n\n \nenum {\n\tFUN_QSTATE_DESTROYED,  \n\tFUN_QSTATE_INIT_SW,    \n\tFUN_QSTATE_INIT_FULL,  \n};\n\n \nenum {\n\tFUN_IRQ_INIT,       \n\tFUN_IRQ_REQUESTED,  \n\tFUN_IRQ_ENABLED,    \n\tFUN_IRQ_DISABLED,   \n};\n\nstruct bpf_prog;\n\nstruct funeth_txq_stats {   \n\tu64 tx_pkts;        \n\tu64 tx_bytes;       \n\tu64 tx_cso;         \n\tu64 tx_tso;         \n\tu64 tx_encap_tso;   \n\tu64 tx_uso;         \n\tu64 tx_more;        \n\tu64 tx_nstops;      \n\tu64 tx_nrestarts;   \n\tu64 tx_map_err;     \n\tu64 tx_xdp_full;    \n\tu64 tx_tls_pkts;    \n\tu64 tx_tls_bytes;   \n\tu64 tx_tls_fallback;  \n\tu64 tx_tls_drops;   \n};\n\nstruct funeth_tx_info {       \n\tunion {\n\t\tstruct sk_buff *skb;     \n\t\tstruct xdp_frame *xdpf;  \n\t};\n};\n\nstruct funeth_txq {\n\t \n\tu32 mask;                \n\tu32 hw_qid;              \n\tvoid *desc;              \n\tstruct funeth_tx_info *info;\n\tstruct device *dma_dev;  \n\tvolatile __be64 *hw_wb;  \n\tu32 __iomem *db;         \n\tstruct netdev_queue *ndq;\n\tdma_addr_t dma_addr;     \n\t \n\tu16 qidx;                \n\tu16 ethid;\n\tu32 prod_cnt;            \n\tstruct funeth_txq_stats stats;\n\t \n\tu32 irq_db_val;          \n\tu32 cons_cnt;            \n\tstruct net_device *netdev;\n\tstruct fun_irq *irq;\n\tint numa_node;\n\tu8 init_state;           \n\tstruct u64_stats_sync syncp;\n};\n\nstruct funeth_rxq_stats {   \n\tu64 rx_pkts;        \n\tu64 rx_bytes;       \n\tu64 rx_cso;         \n\tu64 rx_bufs;        \n\tu64 gro_pkts;       \n\tu64 gro_merged;     \n\tu64 rx_page_alloc;  \n\tu64 rx_budget;      \n\tu64 rx_mem_drops;   \n\tu64 rx_map_err;     \n\tu64 xdp_drops;      \n\tu64 xdp_tx;         \n\tu64 xdp_redir;      \n\tu64 xdp_err;        \n};\n\nstruct funeth_rxbuf {           \n\tstruct page *page;      \n\tdma_addr_t dma_addr;    \n\tint pg_refs;            \n\tint node;               \n};\n\nstruct funeth_rx_cache {        \n\tstruct funeth_rxbuf *bufs;  \n\tunsigned int prod_cnt;      \n\tunsigned int cons_cnt;      \n\tunsigned int mask;          \n};\n\n \nstruct funeth_rxq {\n\tstruct net_device *netdev;\n\tstruct napi_struct *napi;\n\tstruct device *dma_dev;     \n\tvoid *cqes;                 \n\tconst void *next_cqe_info;  \n\tu32 __iomem *cq_db;         \n\tunsigned int cq_head;       \n\tunsigned int cq_mask;       \n\tu16 phase;                  \n\tu16 qidx;                   \n\tunsigned int irq_db_val;    \n\tstruct fun_eprq_rqbuf *rqes;  \n\tstruct funeth_rxbuf *bufs;  \n\tstruct funeth_rxbuf *cur_buf;  \n\tu32 __iomem *rq_db;         \n\tunsigned int rq_cons;       \n\tunsigned int rq_mask;       \n\tunsigned int buf_offset;    \n\tu8 xdp_flush;               \n\tu8 init_state;              \n\tu16 headroom;               \n\tunsigned int rq_cons_db;    \n\tunsigned int rq_db_thres;   \n\tstruct funeth_rxbuf spare_buf;  \n\tstruct funeth_rx_cache cache;  \n\tstruct bpf_prog *xdp_prog;  \n\tstruct funeth_rxq_stats stats;\n\tdma_addr_t cq_dma_addr;     \n\tdma_addr_t rq_dma_addr;     \n\tu16 irq_cnt;\n\tu32 hw_cqid;                \n\tu32 hw_sqid;                \n\tint numa_node;\n\tstruct u64_stats_sync syncp;\n\tstruct xdp_rxq_info xdp_rxq;\n};\n\n#define FUN_QSTAT_INC(q, counter) \\\n\tdo { \\\n\t\tu64_stats_update_begin(&(q)->syncp); \\\n\t\t(q)->stats.counter++; \\\n\t\tu64_stats_update_end(&(q)->syncp); \\\n\t} while (0)\n\n#define FUN_QSTAT_READ(q, seq, stats_copy) \\\n\tdo { \\\n\t\tseq = u64_stats_fetch_begin(&(q)->syncp); \\\n\t\tstats_copy = (q)->stats; \\\n\t} while (u64_stats_fetch_retry(&(q)->syncp, (seq)))\n\n#define FUN_INT_NAME_LEN (IFNAMSIZ + 16)\n\nstruct fun_irq {\n\tstruct napi_struct napi;\n\tstruct funeth_txq *txq;\n\tstruct funeth_rxq *rxq;\n\tu8 state;\n\tu16 irq_idx;               \n\tint irq;                   \n\tcpumask_t affinity_mask;   \n\tstruct irq_affinity_notify aff_notify;\n\tchar name[FUN_INT_NAME_LEN];\n} ____cacheline_internodealigned_in_smp;\n\n \nstatic inline void *fun_tx_desc_addr(const struct funeth_txq *q,\n\t\t\t\t     unsigned int idx)\n{\n\treturn q->desc + idx * FUNETH_SQE_SIZE;\n}\n\nstatic inline void fun_txq_wr_db(const struct funeth_txq *q)\n{\n\tunsigned int tail = q->prod_cnt & q->mask;\n\n\twritel(tail, q->db);\n}\n\nstatic inline int fun_irq_node(const struct fun_irq *p)\n{\n\treturn cpu_to_mem(cpumask_first(&p->affinity_mask));\n}\n\nint fun_rxq_napi_poll(struct napi_struct *napi, int budget);\nint fun_txq_napi_poll(struct napi_struct *napi, int budget);\nnetdev_tx_t fun_start_xmit(struct sk_buff *skb, struct net_device *netdev);\nbool fun_xdp_tx(struct funeth_txq *q, struct xdp_frame *xdpf);\nint fun_xdp_xmit_frames(struct net_device *dev, int n,\n\t\t\tstruct xdp_frame **frames, u32 flags);\n\nint funeth_txq_create(struct net_device *dev, unsigned int qidx,\n\t\t      unsigned int ndesc, struct fun_irq *irq, int state,\n\t\t      struct funeth_txq **qp);\nint fun_txq_create_dev(struct funeth_txq *q, struct fun_irq *irq);\nstruct funeth_txq *funeth_txq_free(struct funeth_txq *q, int state);\nint funeth_rxq_create(struct net_device *dev, unsigned int qidx,\n\t\t      unsigned int ncqe, unsigned int nrqe, struct fun_irq *irq,\n\t\t      int state, struct funeth_rxq **qp);\nint fun_rxq_create_dev(struct funeth_rxq *q, struct fun_irq *irq);\nstruct funeth_rxq *funeth_rxq_free(struct funeth_rxq *q, int state);\nint fun_rxq_set_bpf(struct funeth_rxq *q, struct bpf_prog *prog);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}