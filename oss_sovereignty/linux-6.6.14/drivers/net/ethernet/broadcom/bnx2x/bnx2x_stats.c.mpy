{
  "module_name": "bnx2x_stats.c",
  "hash_id": "3555b19bcf5d1cd9f20ef8b3558bac73a4162ded5f047c035b9f8a3a4f9a1425",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/broadcom/bnx2x/bnx2x_stats.c",
  "human_readable_source": " \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include \"bnx2x_stats.h\"\n#include \"bnx2x_cmn.h\"\n#include \"bnx2x_sriov.h\"\n\nextern const u32 dmae_reg_go_c[];\n\n \n\n \n\nstatic inline long bnx2x_hilo(u32 *hiref)\n{\n\tu32 lo = *(hiref + 1);\n#if (BITS_PER_LONG == 64)\n\tu32 hi = *hiref;\n\n\treturn HILO_U64(hi, lo);\n#else\n\treturn lo;\n#endif\n}\n\nstatic inline u16 bnx2x_get_port_stats_dma_len(struct bnx2x *bp)\n{\n\tu16 res = 0;\n\n\t \n\tif (SHMEM2_HAS(bp, sizeof_port_stats)) {\n\t\tu32 size = SHMEM2_RD(bp, sizeof_port_stats);\n\t\tif (size)\n\t\t\tres = size;\n\n\t\t \n\t\tif (res > sizeof(struct host_port_stats))\n\t\t\tres = sizeof(struct host_port_stats);\n\t}\n\n\t \n\tif (!res) {\n\t\tres = offsetof(struct host_port_stats, not_used) + 4;\n\n\t\t \n\t\tif (bp->flags & BC_SUPPORTS_PFC_STATS) {\n\t\t\tres += offsetof(struct host_port_stats,\n\t\t\t\t\tpfc_frames_rx_lo) -\n\t\t\t       offsetof(struct host_port_stats,\n\t\t\t\t\tpfc_frames_tx_hi) + 4 ;\n\t\t}\n\t}\n\n\tres >>= 2;\n\n\tWARN_ON(res > 2 * DMAE_LEN32_RD_MAX);\n\treturn res;\n}\n\n \n\nstatic void bnx2x_dp_stats(struct bnx2x *bp)\n{\n\tint i;\n\n\tDP(BNX2X_MSG_STATS, \"dumping stats:\\n\"\n\t   \"fw_stats_req\\n\"\n\t   \"    hdr\\n\"\n\t   \"        cmd_num %d\\n\"\n\t   \"        reserved0 %d\\n\"\n\t   \"        drv_stats_counter %d\\n\"\n\t   \"        reserved1 %d\\n\"\n\t   \"        stats_counters_addrs %x %x\\n\",\n\t   bp->fw_stats_req->hdr.cmd_num,\n\t   bp->fw_stats_req->hdr.reserved0,\n\t   bp->fw_stats_req->hdr.drv_stats_counter,\n\t   bp->fw_stats_req->hdr.reserved1,\n\t   bp->fw_stats_req->hdr.stats_counters_addrs.hi,\n\t   bp->fw_stats_req->hdr.stats_counters_addrs.lo);\n\n\tfor (i = 0; i < bp->fw_stats_req->hdr.cmd_num; i++) {\n\t\tDP(BNX2X_MSG_STATS,\n\t\t   \"query[%d]\\n\"\n\t\t   \"              kind %d\\n\"\n\t\t   \"              index %d\\n\"\n\t\t   \"              funcID %d\\n\"\n\t\t   \"              reserved %d\\n\"\n\t\t   \"              address %x %x\\n\",\n\t\t   i, bp->fw_stats_req->query[i].kind,\n\t\t   bp->fw_stats_req->query[i].index,\n\t\t   bp->fw_stats_req->query[i].funcID,\n\t\t   bp->fw_stats_req->query[i].reserved,\n\t\t   bp->fw_stats_req->query[i].address.hi,\n\t\t   bp->fw_stats_req->query[i].address.lo);\n\t}\n}\n\n \nstatic void bnx2x_storm_stats_post(struct bnx2x *bp)\n{\n\tint rc;\n\n\tif (bp->stats_pending)\n\t\treturn;\n\n\tbp->fw_stats_req->hdr.drv_stats_counter =\n\t\tcpu_to_le16(bp->stats_counter++);\n\n\tDP(BNX2X_MSG_STATS, \"Sending statistics ramrod %d\\n\",\n\t   le16_to_cpu(bp->fw_stats_req->hdr.drv_stats_counter));\n\n\t \n\tbnx2x_iov_adjust_stats_req(bp);\n\tbnx2x_dp_stats(bp);\n\n\t \n\trc = bnx2x_sp_post(bp, RAMROD_CMD_ID_COMMON_STAT_QUERY, 0,\n\t\t\t   U64_HI(bp->fw_stats_req_mapping),\n\t\t\t   U64_LO(bp->fw_stats_req_mapping),\n\t\t\t   NONE_CONNECTION_TYPE);\n\tif (rc == 0)\n\t\tbp->stats_pending = 1;\n}\n\nstatic void bnx2x_hw_stats_post(struct bnx2x *bp)\n{\n\tstruct dmae_command *dmae = &bp->stats_dmae;\n\tu32 *stats_comp = bnx2x_sp(bp, stats_comp);\n\n\t*stats_comp = DMAE_COMP_VAL;\n\tif (CHIP_REV_IS_SLOW(bp))\n\t\treturn;\n\n\t \n\tif (bp->func_stx)\n\t\tmemcpy(bnx2x_sp(bp, func_stats), &bp->func_stats,\n\t\t       sizeof(bp->func_stats));\n\n\t \n\tif (bp->executer_idx) {\n\t\tint loader_idx = PMF_DMAE_C(bp);\n\t\tu32 opcode =  bnx2x_dmae_opcode(bp, DMAE_SRC_PCI, DMAE_DST_GRC,\n\t\t\t\t\t\t true, DMAE_COMP_GRC);\n\t\topcode = bnx2x_dmae_opcode_clr_src_reset(opcode);\n\n\t\tmemset(dmae, 0, sizeof(struct dmae_command));\n\t\tdmae->opcode = opcode;\n\t\tdmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, dmae[0]));\n\t\tdmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, dmae[0]));\n\t\tdmae->dst_addr_lo = (DMAE_REG_CMD_MEM +\n\t\t\t\t     sizeof(struct dmae_command) *\n\t\t\t\t     (loader_idx + 1)) >> 2;\n\t\tdmae->dst_addr_hi = 0;\n\t\tdmae->len = sizeof(struct dmae_command) >> 2;\n\t\tif (CHIP_IS_E1(bp))\n\t\t\tdmae->len--;\n\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx + 1] >> 2;\n\t\tdmae->comp_addr_hi = 0;\n\t\tdmae->comp_val = 1;\n\n\t\t*stats_comp = 0;\n\t\tbnx2x_post_dmae(bp, dmae, loader_idx);\n\n\t} else if (bp->func_stx) {\n\t\t*stats_comp = 0;\n\t\tbnx2x_issue_dmae_with_comp(bp, dmae, stats_comp);\n\t}\n}\n\nstatic void bnx2x_stats_comp(struct bnx2x *bp)\n{\n\tu32 *stats_comp = bnx2x_sp(bp, stats_comp);\n\tint cnt = 10;\n\n\tmight_sleep();\n\twhile (*stats_comp != DMAE_COMP_VAL) {\n\t\tif (!cnt) {\n\t\t\tBNX2X_ERR(\"timeout waiting for stats finished\\n\");\n\t\t\tbreak;\n\t\t}\n\t\tcnt--;\n\t\tusleep_range(1000, 2000);\n\t}\n}\n\n \n\n \nstatic void bnx2x_stats_pmf_update(struct bnx2x *bp)\n{\n\tstruct dmae_command *dmae;\n\tu32 opcode;\n\tint loader_idx = PMF_DMAE_C(bp);\n\tu32 *stats_comp = bnx2x_sp(bp, stats_comp);\n\n\t \n\tif (!bp->port.pmf || !bp->port.port_stx) {\n\t\tBNX2X_ERR(\"BUG!\\n\");\n\t\treturn;\n\t}\n\n\tbp->executer_idx = 0;\n\n\topcode = bnx2x_dmae_opcode(bp, DMAE_SRC_GRC, DMAE_DST_PCI, false, 0);\n\n\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\tdmae->opcode = bnx2x_dmae_opcode_add_comp(opcode, DMAE_COMP_GRC);\n\tdmae->src_addr_lo = bp->port.port_stx >> 2;\n\tdmae->src_addr_hi = 0;\n\tdmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, port_stats));\n\tdmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, port_stats));\n\tdmae->len = DMAE_LEN32_RD_MAX;\n\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\tdmae->comp_addr_hi = 0;\n\tdmae->comp_val = 1;\n\n\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\tdmae->opcode = bnx2x_dmae_opcode_add_comp(opcode, DMAE_COMP_PCI);\n\tdmae->src_addr_lo = (bp->port.port_stx >> 2) + DMAE_LEN32_RD_MAX;\n\tdmae->src_addr_hi = 0;\n\tdmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, port_stats) +\n\t\t\t\t   DMAE_LEN32_RD_MAX * 4);\n\tdmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, port_stats) +\n\t\t\t\t   DMAE_LEN32_RD_MAX * 4);\n\tdmae->len = bnx2x_get_port_stats_dma_len(bp) - DMAE_LEN32_RD_MAX;\n\n\tdmae->comp_addr_lo = U64_LO(bnx2x_sp_mapping(bp, stats_comp));\n\tdmae->comp_addr_hi = U64_HI(bnx2x_sp_mapping(bp, stats_comp));\n\tdmae->comp_val = DMAE_COMP_VAL;\n\n\t*stats_comp = 0;\n\tbnx2x_hw_stats_post(bp);\n\tbnx2x_stats_comp(bp);\n}\n\nstatic void bnx2x_port_stats_init(struct bnx2x *bp)\n{\n\tstruct dmae_command *dmae;\n\tint port = BP_PORT(bp);\n\tu32 opcode;\n\tint loader_idx = PMF_DMAE_C(bp);\n\tu32 mac_addr;\n\tu32 *stats_comp = bnx2x_sp(bp, stats_comp);\n\n\t \n\tif (!bp->link_vars.link_up || !bp->port.pmf) {\n\t\tBNX2X_ERR(\"BUG!\\n\");\n\t\treturn;\n\t}\n\n\tbp->executer_idx = 0;\n\n\t \n\topcode = bnx2x_dmae_opcode(bp, DMAE_SRC_PCI, DMAE_DST_GRC,\n\t\t\t\t    true, DMAE_COMP_GRC);\n\n\tif (bp->port.port_stx) {\n\n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tdmae->opcode = opcode;\n\t\tdmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, port_stats));\n\t\tdmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, port_stats));\n\t\tdmae->dst_addr_lo = bp->port.port_stx >> 2;\n\t\tdmae->dst_addr_hi = 0;\n\t\tdmae->len = bnx2x_get_port_stats_dma_len(bp);\n\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\t\tdmae->comp_addr_hi = 0;\n\t\tdmae->comp_val = 1;\n\t}\n\n\tif (bp->func_stx) {\n\n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tdmae->opcode = opcode;\n\t\tdmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, func_stats));\n\t\tdmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, func_stats));\n\t\tdmae->dst_addr_lo = bp->func_stx >> 2;\n\t\tdmae->dst_addr_hi = 0;\n\t\tdmae->len = sizeof(struct host_func_stats) >> 2;\n\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\t\tdmae->comp_addr_hi = 0;\n\t\tdmae->comp_val = 1;\n\t}\n\n\t \n\topcode = bnx2x_dmae_opcode(bp, DMAE_SRC_GRC, DMAE_DST_PCI,\n\t\t\t\t   true, DMAE_COMP_GRC);\n\n\t \n\tif (bp->link_vars.mac_type == MAC_TYPE_EMAC) {\n\t\tmac_addr = (port ? GRCBASE_EMAC1 : GRCBASE_EMAC0);\n\n\t\t \n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tdmae->opcode = opcode;\n\t\tdmae->src_addr_lo = (mac_addr +\n\t\t\t\t     EMAC_REG_EMAC_RX_STAT_AC) >> 2;\n\t\tdmae->src_addr_hi = 0;\n\t\tdmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, mac_stats));\n\t\tdmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, mac_stats));\n\t\tdmae->len = EMAC_REG_EMAC_RX_STAT_AC_COUNT;\n\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\t\tdmae->comp_addr_hi = 0;\n\t\tdmae->comp_val = 1;\n\n\t\t \n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tdmae->opcode = opcode;\n\t\tdmae->src_addr_lo = (mac_addr +\n\t\t\t\t     EMAC_REG_EMAC_RX_STAT_AC_28) >> 2;\n\t\tdmae->src_addr_hi = 0;\n\t\tdmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, mac_stats) +\n\t\t     offsetof(struct emac_stats, rx_stat_falsecarriererrors));\n\t\tdmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, mac_stats) +\n\t\t     offsetof(struct emac_stats, rx_stat_falsecarriererrors));\n\t\tdmae->len = 1;\n\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\t\tdmae->comp_addr_hi = 0;\n\t\tdmae->comp_val = 1;\n\n\t\t \n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tdmae->opcode = opcode;\n\t\tdmae->src_addr_lo = (mac_addr +\n\t\t\t\t     EMAC_REG_EMAC_TX_STAT_AC) >> 2;\n\t\tdmae->src_addr_hi = 0;\n\t\tdmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, mac_stats) +\n\t\t\toffsetof(struct emac_stats, tx_stat_ifhcoutoctets));\n\t\tdmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, mac_stats) +\n\t\t\toffsetof(struct emac_stats, tx_stat_ifhcoutoctets));\n\t\tdmae->len = EMAC_REG_EMAC_TX_STAT_AC_COUNT;\n\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\t\tdmae->comp_addr_hi = 0;\n\t\tdmae->comp_val = 1;\n\t} else {\n\t\tu32 tx_src_addr_lo, rx_src_addr_lo;\n\t\tu16 rx_len, tx_len;\n\n\t\t \n\t\tswitch (bp->link_vars.mac_type) {\n\t\tcase MAC_TYPE_BMAC:\n\t\t\tmac_addr = (port ? NIG_REG_INGRESS_BMAC1_MEM :\n\t\t\t\t\t   NIG_REG_INGRESS_BMAC0_MEM);\n\n\t\t\t \n\t\t\tif (CHIP_IS_E1x(bp)) {\n\t\t\t\ttx_src_addr_lo = (mac_addr +\n\t\t\t\t\tBIGMAC_REGISTER_TX_STAT_GTPKT) >> 2;\n\t\t\t\ttx_len = (8 + BIGMAC_REGISTER_TX_STAT_GTBYT -\n\t\t\t\t\t  BIGMAC_REGISTER_TX_STAT_GTPKT) >> 2;\n\t\t\t\trx_src_addr_lo = (mac_addr +\n\t\t\t\t\tBIGMAC_REGISTER_RX_STAT_GR64) >> 2;\n\t\t\t\trx_len = (8 + BIGMAC_REGISTER_RX_STAT_GRIPJ -\n\t\t\t\t\t  BIGMAC_REGISTER_RX_STAT_GR64) >> 2;\n\t\t\t} else {\n\t\t\t\ttx_src_addr_lo = (mac_addr +\n\t\t\t\t\tBIGMAC2_REGISTER_TX_STAT_GTPOK) >> 2;\n\t\t\t\ttx_len = (8 + BIGMAC2_REGISTER_TX_STAT_GTBYT -\n\t\t\t\t\t  BIGMAC2_REGISTER_TX_STAT_GTPOK) >> 2;\n\t\t\t\trx_src_addr_lo = (mac_addr +\n\t\t\t\t\tBIGMAC2_REGISTER_RX_STAT_GR64) >> 2;\n\t\t\t\trx_len = (8 + BIGMAC2_REGISTER_RX_STAT_GRIPJ -\n\t\t\t\t\t  BIGMAC2_REGISTER_RX_STAT_GR64) >> 2;\n\t\t\t}\n\t\t\tbreak;\n\n\t\tcase MAC_TYPE_UMAC:  \n\t\tcase MAC_TYPE_XMAC:  \n\t\tdefault:\n\t\t\tmac_addr = port ? GRCBASE_MSTAT1 : GRCBASE_MSTAT0;\n\t\t\ttx_src_addr_lo = (mac_addr +\n\t\t\t\t\t  MSTAT_REG_TX_STAT_GTXPOK_LO) >> 2;\n\t\t\trx_src_addr_lo = (mac_addr +\n\t\t\t\t\t  MSTAT_REG_RX_STAT_GR64_LO) >> 2;\n\t\t\ttx_len = sizeof(bp->slowpath->\n\t\t\t\t\tmac_stats.mstat_stats.stats_tx) >> 2;\n\t\t\trx_len = sizeof(bp->slowpath->\n\t\t\t\t\tmac_stats.mstat_stats.stats_rx) >> 2;\n\t\t\tbreak;\n\t\t}\n\n\t\t \n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tdmae->opcode = opcode;\n\t\tdmae->src_addr_lo = tx_src_addr_lo;\n\t\tdmae->src_addr_hi = 0;\n\t\tdmae->len = tx_len;\n\t\tdmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, mac_stats));\n\t\tdmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, mac_stats));\n\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\t\tdmae->comp_addr_hi = 0;\n\t\tdmae->comp_val = 1;\n\n\t\t \n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tdmae->opcode = opcode;\n\t\tdmae->src_addr_hi = 0;\n\t\tdmae->src_addr_lo = rx_src_addr_lo;\n\t\tdmae->dst_addr_lo =\n\t\t\tU64_LO(bnx2x_sp_mapping(bp, mac_stats) + (tx_len << 2));\n\t\tdmae->dst_addr_hi =\n\t\t\tU64_HI(bnx2x_sp_mapping(bp, mac_stats) + (tx_len << 2));\n\t\tdmae->len = rx_len;\n\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\t\tdmae->comp_addr_hi = 0;\n\t\tdmae->comp_val = 1;\n\t}\n\n\t \n\tif (!CHIP_IS_E3(bp)) {\n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tdmae->opcode = opcode;\n\t\tdmae->src_addr_lo = (port ? NIG_REG_STAT1_EGRESS_MAC_PKT0 :\n\t\t\t\t\t    NIG_REG_STAT0_EGRESS_MAC_PKT0) >> 2;\n\t\tdmae->src_addr_hi = 0;\n\t\tdmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, nig_stats) +\n\t\t\t\toffsetof(struct nig_stats, egress_mac_pkt0_lo));\n\t\tdmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, nig_stats) +\n\t\t\t\toffsetof(struct nig_stats, egress_mac_pkt0_lo));\n\t\tdmae->len = (2*sizeof(u32)) >> 2;\n\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\t\tdmae->comp_addr_hi = 0;\n\t\tdmae->comp_val = 1;\n\n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tdmae->opcode = opcode;\n\t\tdmae->src_addr_lo = (port ? NIG_REG_STAT1_EGRESS_MAC_PKT1 :\n\t\t\t\t\t    NIG_REG_STAT0_EGRESS_MAC_PKT1) >> 2;\n\t\tdmae->src_addr_hi = 0;\n\t\tdmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, nig_stats) +\n\t\t\t\toffsetof(struct nig_stats, egress_mac_pkt1_lo));\n\t\tdmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, nig_stats) +\n\t\t\t\toffsetof(struct nig_stats, egress_mac_pkt1_lo));\n\t\tdmae->len = (2*sizeof(u32)) >> 2;\n\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\t\tdmae->comp_addr_hi = 0;\n\t\tdmae->comp_val = 1;\n\t}\n\n\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\tdmae->opcode = bnx2x_dmae_opcode(bp, DMAE_SRC_GRC, DMAE_DST_PCI,\n\t\t\t\t\t\t true, DMAE_COMP_PCI);\n\tdmae->src_addr_lo = (port ? NIG_REG_STAT1_BRB_DISCARD :\n\t\t\t\t    NIG_REG_STAT0_BRB_DISCARD) >> 2;\n\tdmae->src_addr_hi = 0;\n\tdmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, nig_stats));\n\tdmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, nig_stats));\n\tdmae->len = (sizeof(struct nig_stats) - 4*sizeof(u32)) >> 2;\n\n\tdmae->comp_addr_lo = U64_LO(bnx2x_sp_mapping(bp, stats_comp));\n\tdmae->comp_addr_hi = U64_HI(bnx2x_sp_mapping(bp, stats_comp));\n\tdmae->comp_val = DMAE_COMP_VAL;\n\n\t*stats_comp = 0;\n}\n\nstatic void bnx2x_func_stats_init(struct bnx2x *bp)\n{\n\tstruct dmae_command *dmae = &bp->stats_dmae;\n\tu32 *stats_comp = bnx2x_sp(bp, stats_comp);\n\n\t \n\tif (!bp->func_stx) {\n\t\tBNX2X_ERR(\"BUG!\\n\");\n\t\treturn;\n\t}\n\n\tbp->executer_idx = 0;\n\tmemset(dmae, 0, sizeof(struct dmae_command));\n\n\tdmae->opcode = bnx2x_dmae_opcode(bp, DMAE_SRC_PCI, DMAE_DST_GRC,\n\t\t\t\t\t true, DMAE_COMP_PCI);\n\tdmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, func_stats));\n\tdmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, func_stats));\n\tdmae->dst_addr_lo = bp->func_stx >> 2;\n\tdmae->dst_addr_hi = 0;\n\tdmae->len = sizeof(struct host_func_stats) >> 2;\n\tdmae->comp_addr_lo = U64_LO(bnx2x_sp_mapping(bp, stats_comp));\n\tdmae->comp_addr_hi = U64_HI(bnx2x_sp_mapping(bp, stats_comp));\n\tdmae->comp_val = DMAE_COMP_VAL;\n\n\t*stats_comp = 0;\n}\n\n \nstatic void bnx2x_stats_start(struct bnx2x *bp)\n{\n\tif (IS_PF(bp)) {\n\t\tif (bp->port.pmf)\n\t\t\tbnx2x_port_stats_init(bp);\n\n\t\telse if (bp->func_stx)\n\t\t\tbnx2x_func_stats_init(bp);\n\n\t\tbnx2x_hw_stats_post(bp);\n\t\tbnx2x_storm_stats_post(bp);\n\t}\n}\n\nstatic void bnx2x_stats_pmf_start(struct bnx2x *bp)\n{\n\tbnx2x_stats_comp(bp);\n\tbnx2x_stats_pmf_update(bp);\n\tbnx2x_stats_start(bp);\n}\n\nstatic void bnx2x_stats_restart(struct bnx2x *bp)\n{\n\t \n\tif (IS_VF(bp))\n\t\treturn;\n\n\tbnx2x_stats_comp(bp);\n\tbnx2x_stats_start(bp);\n}\n\nstatic void bnx2x_bmac_stats_update(struct bnx2x *bp)\n{\n\tstruct host_port_stats *pstats = bnx2x_sp(bp, port_stats);\n\tstruct bnx2x_eth_stats *estats = &bp->eth_stats;\n\tstruct {\n\t\tu32 lo;\n\t\tu32 hi;\n\t} diff;\n\n\tif (CHIP_IS_E1x(bp)) {\n\t\tstruct bmac1_stats *new = bnx2x_sp(bp, mac_stats.bmac1_stats);\n\n\t\t \n\t\tUPDATE_STAT64(rx_stat_grerb, rx_stat_ifhcinbadoctets);\n\t\tUPDATE_STAT64(rx_stat_grfcs, rx_stat_dot3statsfcserrors);\n\t\tUPDATE_STAT64(rx_stat_grund, rx_stat_etherstatsundersizepkts);\n\t\tUPDATE_STAT64(rx_stat_grovr, rx_stat_dot3statsframestoolong);\n\t\tUPDATE_STAT64(rx_stat_grfrg, rx_stat_etherstatsfragments);\n\t\tUPDATE_STAT64(rx_stat_grjbr, rx_stat_etherstatsjabbers);\n\t\tUPDATE_STAT64(rx_stat_grxcf, rx_stat_maccontrolframesreceived);\n\t\tUPDATE_STAT64(rx_stat_grxpf, rx_stat_xoffstateentered);\n\t\tUPDATE_STAT64(rx_stat_grxpf, rx_stat_mac_xpf);\n\n\t\tUPDATE_STAT64(tx_stat_gtxpf, tx_stat_outxoffsent);\n\t\tUPDATE_STAT64(tx_stat_gtxpf, tx_stat_flowcontroldone);\n\t\tUPDATE_STAT64(tx_stat_gt64, tx_stat_etherstatspkts64octets);\n\t\tUPDATE_STAT64(tx_stat_gt127,\n\t\t\t\ttx_stat_etherstatspkts65octetsto127octets);\n\t\tUPDATE_STAT64(tx_stat_gt255,\n\t\t\t\ttx_stat_etherstatspkts128octetsto255octets);\n\t\tUPDATE_STAT64(tx_stat_gt511,\n\t\t\t\ttx_stat_etherstatspkts256octetsto511octets);\n\t\tUPDATE_STAT64(tx_stat_gt1023,\n\t\t\t\ttx_stat_etherstatspkts512octetsto1023octets);\n\t\tUPDATE_STAT64(tx_stat_gt1518,\n\t\t\t\ttx_stat_etherstatspkts1024octetsto1522octets);\n\t\tUPDATE_STAT64(tx_stat_gt2047, tx_stat_mac_2047);\n\t\tUPDATE_STAT64(tx_stat_gt4095, tx_stat_mac_4095);\n\t\tUPDATE_STAT64(tx_stat_gt9216, tx_stat_mac_9216);\n\t\tUPDATE_STAT64(tx_stat_gt16383, tx_stat_mac_16383);\n\t\tUPDATE_STAT64(tx_stat_gterr,\n\t\t\t\ttx_stat_dot3statsinternalmactransmiterrors);\n\t\tUPDATE_STAT64(tx_stat_gtufl, tx_stat_mac_ufl);\n\n\t} else {\n\t\tstruct bmac2_stats *new = bnx2x_sp(bp, mac_stats.bmac2_stats);\n\n\t\t \n\t\tUPDATE_STAT64(rx_stat_grerb, rx_stat_ifhcinbadoctets);\n\t\tUPDATE_STAT64(rx_stat_grfcs, rx_stat_dot3statsfcserrors);\n\t\tUPDATE_STAT64(rx_stat_grund, rx_stat_etherstatsundersizepkts);\n\t\tUPDATE_STAT64(rx_stat_grovr, rx_stat_dot3statsframestoolong);\n\t\tUPDATE_STAT64(rx_stat_grfrg, rx_stat_etherstatsfragments);\n\t\tUPDATE_STAT64(rx_stat_grjbr, rx_stat_etherstatsjabbers);\n\t\tUPDATE_STAT64(rx_stat_grxcf, rx_stat_maccontrolframesreceived);\n\t\tUPDATE_STAT64(rx_stat_grxpf, rx_stat_xoffstateentered);\n\t\tUPDATE_STAT64(rx_stat_grxpf, rx_stat_mac_xpf);\n\t\tUPDATE_STAT64(tx_stat_gtxpf, tx_stat_outxoffsent);\n\t\tUPDATE_STAT64(tx_stat_gtxpf, tx_stat_flowcontroldone);\n\t\tUPDATE_STAT64(tx_stat_gt64, tx_stat_etherstatspkts64octets);\n\t\tUPDATE_STAT64(tx_stat_gt127,\n\t\t\t\ttx_stat_etherstatspkts65octetsto127octets);\n\t\tUPDATE_STAT64(tx_stat_gt255,\n\t\t\t\ttx_stat_etherstatspkts128octetsto255octets);\n\t\tUPDATE_STAT64(tx_stat_gt511,\n\t\t\t\ttx_stat_etherstatspkts256octetsto511octets);\n\t\tUPDATE_STAT64(tx_stat_gt1023,\n\t\t\t\ttx_stat_etherstatspkts512octetsto1023octets);\n\t\tUPDATE_STAT64(tx_stat_gt1518,\n\t\t\t\ttx_stat_etherstatspkts1024octetsto1522octets);\n\t\tUPDATE_STAT64(tx_stat_gt2047, tx_stat_mac_2047);\n\t\tUPDATE_STAT64(tx_stat_gt4095, tx_stat_mac_4095);\n\t\tUPDATE_STAT64(tx_stat_gt9216, tx_stat_mac_9216);\n\t\tUPDATE_STAT64(tx_stat_gt16383, tx_stat_mac_16383);\n\t\tUPDATE_STAT64(tx_stat_gterr,\n\t\t\t\ttx_stat_dot3statsinternalmactransmiterrors);\n\t\tUPDATE_STAT64(tx_stat_gtufl, tx_stat_mac_ufl);\n\n\t\t \n\t\tpstats->pfc_frames_tx_hi = new->tx_stat_gtpp_hi;\n\t\tpstats->pfc_frames_tx_lo = new->tx_stat_gtpp_lo;\n\n\t\tpstats->pfc_frames_rx_hi = new->rx_stat_grpp_hi;\n\t\tpstats->pfc_frames_rx_lo = new->rx_stat_grpp_lo;\n\t}\n\n\testats->pause_frames_received_hi =\n\t\t\t\tpstats->mac_stx[1].rx_stat_mac_xpf_hi;\n\testats->pause_frames_received_lo =\n\t\t\t\tpstats->mac_stx[1].rx_stat_mac_xpf_lo;\n\n\testats->pause_frames_sent_hi =\n\t\t\t\tpstats->mac_stx[1].tx_stat_outxoffsent_hi;\n\testats->pause_frames_sent_lo =\n\t\t\t\tpstats->mac_stx[1].tx_stat_outxoffsent_lo;\n\n\testats->pfc_frames_received_hi =\n\t\t\t\tpstats->pfc_frames_rx_hi;\n\testats->pfc_frames_received_lo =\n\t\t\t\tpstats->pfc_frames_rx_lo;\n\testats->pfc_frames_sent_hi =\n\t\t\t\tpstats->pfc_frames_tx_hi;\n\testats->pfc_frames_sent_lo =\n\t\t\t\tpstats->pfc_frames_tx_lo;\n}\n\nstatic void bnx2x_mstat_stats_update(struct bnx2x *bp)\n{\n\tstruct host_port_stats *pstats = bnx2x_sp(bp, port_stats);\n\tstruct bnx2x_eth_stats *estats = &bp->eth_stats;\n\n\tstruct mstat_stats *new = bnx2x_sp(bp, mac_stats.mstat_stats);\n\n\tADD_STAT64(stats_rx.rx_grerb, rx_stat_ifhcinbadoctets);\n\tADD_STAT64(stats_rx.rx_grfcs, rx_stat_dot3statsfcserrors);\n\tADD_STAT64(stats_rx.rx_grund, rx_stat_etherstatsundersizepkts);\n\tADD_STAT64(stats_rx.rx_grovr, rx_stat_dot3statsframestoolong);\n\tADD_STAT64(stats_rx.rx_grfrg, rx_stat_etherstatsfragments);\n\tADD_STAT64(stats_rx.rx_grxcf, rx_stat_maccontrolframesreceived);\n\tADD_STAT64(stats_rx.rx_grxpf, rx_stat_xoffstateentered);\n\tADD_STAT64(stats_rx.rx_grxpf, rx_stat_mac_xpf);\n\tADD_STAT64(stats_tx.tx_gtxpf, tx_stat_outxoffsent);\n\tADD_STAT64(stats_tx.tx_gtxpf, tx_stat_flowcontroldone);\n\n\t \n\tADD_64(pstats->pfc_frames_tx_hi, new->stats_tx.tx_gtxpp_hi,\n\t\tpstats->pfc_frames_tx_lo, new->stats_tx.tx_gtxpp_lo);\n\tADD_64(pstats->pfc_frames_rx_hi, new->stats_rx.rx_grxpp_hi,\n\t\tpstats->pfc_frames_rx_lo, new->stats_rx.rx_grxpp_lo);\n\n\tADD_STAT64(stats_tx.tx_gt64, tx_stat_etherstatspkts64octets);\n\tADD_STAT64(stats_tx.tx_gt127,\n\t\t\ttx_stat_etherstatspkts65octetsto127octets);\n\tADD_STAT64(stats_tx.tx_gt255,\n\t\t\ttx_stat_etherstatspkts128octetsto255octets);\n\tADD_STAT64(stats_tx.tx_gt511,\n\t\t\ttx_stat_etherstatspkts256octetsto511octets);\n\tADD_STAT64(stats_tx.tx_gt1023,\n\t\t\ttx_stat_etherstatspkts512octetsto1023octets);\n\tADD_STAT64(stats_tx.tx_gt1518,\n\t\t\ttx_stat_etherstatspkts1024octetsto1522octets);\n\tADD_STAT64(stats_tx.tx_gt2047, tx_stat_mac_2047);\n\n\tADD_STAT64(stats_tx.tx_gt4095, tx_stat_mac_4095);\n\tADD_STAT64(stats_tx.tx_gt9216, tx_stat_mac_9216);\n\tADD_STAT64(stats_tx.tx_gt16383, tx_stat_mac_16383);\n\n\tADD_STAT64(stats_tx.tx_gterr,\n\t\t\ttx_stat_dot3statsinternalmactransmiterrors);\n\tADD_STAT64(stats_tx.tx_gtufl, tx_stat_mac_ufl);\n\n\testats->etherstatspkts1024octetsto1522octets_hi =\n\t    pstats->mac_stx[1].tx_stat_etherstatspkts1024octetsto1522octets_hi;\n\testats->etherstatspkts1024octetsto1522octets_lo =\n\t    pstats->mac_stx[1].tx_stat_etherstatspkts1024octetsto1522octets_lo;\n\n\testats->etherstatspktsover1522octets_hi =\n\t    pstats->mac_stx[1].tx_stat_mac_2047_hi;\n\testats->etherstatspktsover1522octets_lo =\n\t    pstats->mac_stx[1].tx_stat_mac_2047_lo;\n\n\tADD_64(estats->etherstatspktsover1522octets_hi,\n\t       pstats->mac_stx[1].tx_stat_mac_4095_hi,\n\t       estats->etherstatspktsover1522octets_lo,\n\t       pstats->mac_stx[1].tx_stat_mac_4095_lo);\n\n\tADD_64(estats->etherstatspktsover1522octets_hi,\n\t       pstats->mac_stx[1].tx_stat_mac_9216_hi,\n\t       estats->etherstatspktsover1522octets_lo,\n\t       pstats->mac_stx[1].tx_stat_mac_9216_lo);\n\n\tADD_64(estats->etherstatspktsover1522octets_hi,\n\t       pstats->mac_stx[1].tx_stat_mac_16383_hi,\n\t       estats->etherstatspktsover1522octets_lo,\n\t       pstats->mac_stx[1].tx_stat_mac_16383_lo);\n\n\testats->pause_frames_received_hi =\n\t\t\t\tpstats->mac_stx[1].rx_stat_mac_xpf_hi;\n\testats->pause_frames_received_lo =\n\t\t\t\tpstats->mac_stx[1].rx_stat_mac_xpf_lo;\n\n\testats->pause_frames_sent_hi =\n\t\t\t\tpstats->mac_stx[1].tx_stat_outxoffsent_hi;\n\testats->pause_frames_sent_lo =\n\t\t\t\tpstats->mac_stx[1].tx_stat_outxoffsent_lo;\n\n\testats->pfc_frames_received_hi =\n\t\t\t\tpstats->pfc_frames_rx_hi;\n\testats->pfc_frames_received_lo =\n\t\t\t\tpstats->pfc_frames_rx_lo;\n\testats->pfc_frames_sent_hi =\n\t\t\t\tpstats->pfc_frames_tx_hi;\n\testats->pfc_frames_sent_lo =\n\t\t\t\tpstats->pfc_frames_tx_lo;\n}\n\nstatic void bnx2x_emac_stats_update(struct bnx2x *bp)\n{\n\tstruct emac_stats *new = bnx2x_sp(bp, mac_stats.emac_stats);\n\tstruct host_port_stats *pstats = bnx2x_sp(bp, port_stats);\n\tstruct bnx2x_eth_stats *estats = &bp->eth_stats;\n\n\tUPDATE_EXTEND_STAT(rx_stat_ifhcinbadoctets);\n\tUPDATE_EXTEND_STAT(tx_stat_ifhcoutbadoctets);\n\tUPDATE_EXTEND_STAT(rx_stat_dot3statsfcserrors);\n\tUPDATE_EXTEND_STAT(rx_stat_dot3statsalignmenterrors);\n\tUPDATE_EXTEND_STAT(rx_stat_dot3statscarriersenseerrors);\n\tUPDATE_EXTEND_STAT(rx_stat_falsecarriererrors);\n\tUPDATE_EXTEND_STAT(rx_stat_etherstatsundersizepkts);\n\tUPDATE_EXTEND_STAT(rx_stat_dot3statsframestoolong);\n\tUPDATE_EXTEND_STAT(rx_stat_etherstatsfragments);\n\tUPDATE_EXTEND_STAT(rx_stat_etherstatsjabbers);\n\tUPDATE_EXTEND_STAT(rx_stat_maccontrolframesreceived);\n\tUPDATE_EXTEND_STAT(rx_stat_xoffstateentered);\n\tUPDATE_EXTEND_STAT(rx_stat_xonpauseframesreceived);\n\tUPDATE_EXTEND_STAT(rx_stat_xoffpauseframesreceived);\n\tUPDATE_EXTEND_STAT(tx_stat_outxonsent);\n\tUPDATE_EXTEND_STAT(tx_stat_outxoffsent);\n\tUPDATE_EXTEND_STAT(tx_stat_flowcontroldone);\n\tUPDATE_EXTEND_STAT(tx_stat_etherstatscollisions);\n\tUPDATE_EXTEND_STAT(tx_stat_dot3statssinglecollisionframes);\n\tUPDATE_EXTEND_STAT(tx_stat_dot3statsmultiplecollisionframes);\n\tUPDATE_EXTEND_STAT(tx_stat_dot3statsdeferredtransmissions);\n\tUPDATE_EXTEND_STAT(tx_stat_dot3statsexcessivecollisions);\n\tUPDATE_EXTEND_STAT(tx_stat_dot3statslatecollisions);\n\tUPDATE_EXTEND_STAT(tx_stat_etherstatspkts64octets);\n\tUPDATE_EXTEND_STAT(tx_stat_etherstatspkts65octetsto127octets);\n\tUPDATE_EXTEND_STAT(tx_stat_etherstatspkts128octetsto255octets);\n\tUPDATE_EXTEND_STAT(tx_stat_etherstatspkts256octetsto511octets);\n\tUPDATE_EXTEND_STAT(tx_stat_etherstatspkts512octetsto1023octets);\n\tUPDATE_EXTEND_STAT(tx_stat_etherstatspkts1024octetsto1522octets);\n\tUPDATE_EXTEND_STAT(tx_stat_etherstatspktsover1522octets);\n\tUPDATE_EXTEND_STAT(tx_stat_dot3statsinternalmactransmiterrors);\n\n\testats->pause_frames_received_hi =\n\t\t\tpstats->mac_stx[1].rx_stat_xonpauseframesreceived_hi;\n\testats->pause_frames_received_lo =\n\t\t\tpstats->mac_stx[1].rx_stat_xonpauseframesreceived_lo;\n\tADD_64(estats->pause_frames_received_hi,\n\t       pstats->mac_stx[1].rx_stat_xoffpauseframesreceived_hi,\n\t       estats->pause_frames_received_lo,\n\t       pstats->mac_stx[1].rx_stat_xoffpauseframesreceived_lo);\n\n\testats->pause_frames_sent_hi =\n\t\t\tpstats->mac_stx[1].tx_stat_outxonsent_hi;\n\testats->pause_frames_sent_lo =\n\t\t\tpstats->mac_stx[1].tx_stat_outxonsent_lo;\n\tADD_64(estats->pause_frames_sent_hi,\n\t       pstats->mac_stx[1].tx_stat_outxoffsent_hi,\n\t       estats->pause_frames_sent_lo,\n\t       pstats->mac_stx[1].tx_stat_outxoffsent_lo);\n}\n\nstatic int bnx2x_hw_stats_update(struct bnx2x *bp)\n{\n\tstruct nig_stats *new = bnx2x_sp(bp, nig_stats);\n\tstruct nig_stats *old = &(bp->port.old_nig_stats);\n\tstruct host_port_stats *pstats = bnx2x_sp(bp, port_stats);\n\tstruct bnx2x_eth_stats *estats = &bp->eth_stats;\n\tstruct {\n\t\tu32 lo;\n\t\tu32 hi;\n\t} diff;\n\n\tswitch (bp->link_vars.mac_type) {\n\tcase MAC_TYPE_BMAC:\n\t\tbnx2x_bmac_stats_update(bp);\n\t\tbreak;\n\n\tcase MAC_TYPE_EMAC:\n\t\tbnx2x_emac_stats_update(bp);\n\t\tbreak;\n\n\tcase MAC_TYPE_UMAC:\n\tcase MAC_TYPE_XMAC:\n\t\tbnx2x_mstat_stats_update(bp);\n\t\tbreak;\n\n\tcase MAC_TYPE_NONE:  \n\t\tDP(BNX2X_MSG_STATS,\n\t\t   \"stats updated by DMAE but no MAC active\\n\");\n\t\treturn -1;\n\n\tdefault:  \n\t\tBNX2X_ERR(\"Unknown MAC type\\n\");\n\t}\n\n\tADD_EXTEND_64(pstats->brb_drop_hi, pstats->brb_drop_lo,\n\t\t      new->brb_discard - old->brb_discard);\n\tADD_EXTEND_64(estats->brb_truncate_hi, estats->brb_truncate_lo,\n\t\t      new->brb_truncate - old->brb_truncate);\n\n\tif (!CHIP_IS_E3(bp)) {\n\t\tUPDATE_STAT64_NIG(egress_mac_pkt0,\n\t\t\t\t\tetherstatspkts1024octetsto1522octets);\n\t\tUPDATE_STAT64_NIG(egress_mac_pkt1,\n\t\t\t\t\tetherstatspktsover1522octets);\n\t}\n\n\tmemcpy(old, new, sizeof(struct nig_stats));\n\n\tBUILD_BUG_ON(sizeof(estats->shared) != sizeof(pstats->mac_stx[1]));\n\tmemcpy(&(estats->shared), &(pstats->mac_stx[1]),\n\t       sizeof(struct mac_stx));\n\testats->brb_drop_hi = pstats->brb_drop_hi;\n\testats->brb_drop_lo = pstats->brb_drop_lo;\n\n\tpstats->host_port_stats_counter++;\n\n\tif (CHIP_IS_E3(bp)) {\n\t\tu32 lpi_reg = BP_PORT(bp) ? MISC_REG_CPMU_LP_SM_ENT_CNT_P1\n\t\t\t\t\t  : MISC_REG_CPMU_LP_SM_ENT_CNT_P0;\n\t\testats->eee_tx_lpi += REG_RD(bp, lpi_reg);\n\t}\n\n\tif (!BP_NOMCP(bp)) {\n\t\tu32 nig_timer_max =\n\t\t\tSHMEM_RD(bp, port_mb[BP_PORT(bp)].stat_nig_timer);\n\t\tif (nig_timer_max != estats->nig_timer_max) {\n\t\t\testats->nig_timer_max = nig_timer_max;\n\t\t\tBNX2X_ERR(\"NIG timer max (%u)\\n\",\n\t\t\t\t  estats->nig_timer_max);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int bnx2x_storm_stats_validate_counters(struct bnx2x *bp)\n{\n\tstruct stats_counter *counters = &bp->fw_stats_data->storm_counters;\n\tu16 cur_stats_counter;\n\t \n\tcur_stats_counter = bp->stats_counter - 1;\n\n\t \n\tif (le16_to_cpu(counters->xstats_counter) != cur_stats_counter) {\n\t\tDP(BNX2X_MSG_STATS,\n\t\t   \"stats not updated by xstorm  xstorm counter (0x%x) != stats_counter (0x%x)\\n\",\n\t\t   le16_to_cpu(counters->xstats_counter), bp->stats_counter);\n\t\treturn -EAGAIN;\n\t}\n\n\tif (le16_to_cpu(counters->ustats_counter) != cur_stats_counter) {\n\t\tDP(BNX2X_MSG_STATS,\n\t\t   \"stats not updated by ustorm  ustorm counter (0x%x) != stats_counter (0x%x)\\n\",\n\t\t   le16_to_cpu(counters->ustats_counter), bp->stats_counter);\n\t\treturn -EAGAIN;\n\t}\n\n\tif (le16_to_cpu(counters->cstats_counter) != cur_stats_counter) {\n\t\tDP(BNX2X_MSG_STATS,\n\t\t   \"stats not updated by cstorm  cstorm counter (0x%x) != stats_counter (0x%x)\\n\",\n\t\t   le16_to_cpu(counters->cstats_counter), bp->stats_counter);\n\t\treturn -EAGAIN;\n\t}\n\n\tif (le16_to_cpu(counters->tstats_counter) != cur_stats_counter) {\n\t\tDP(BNX2X_MSG_STATS,\n\t\t   \"stats not updated by tstorm  tstorm counter (0x%x) != stats_counter (0x%x)\\n\",\n\t\t   le16_to_cpu(counters->tstats_counter), bp->stats_counter);\n\t\treturn -EAGAIN;\n\t}\n\treturn 0;\n}\n\nstatic int bnx2x_storm_stats_update(struct bnx2x *bp)\n{\n\tstruct tstorm_per_port_stats *tport =\n\t\t\t\t&bp->fw_stats_data->port.tstorm_port_statistics;\n\tstruct tstorm_per_pf_stats *tfunc =\n\t\t\t\t&bp->fw_stats_data->pf.tstorm_pf_statistics;\n\tstruct host_func_stats *fstats = &bp->func_stats;\n\tstruct bnx2x_eth_stats *estats = &bp->eth_stats;\n\tstruct bnx2x_eth_stats_old *estats_old = &bp->eth_stats_old;\n\tint i;\n\n\t \n\tif (IS_PF(bp) && bnx2x_storm_stats_validate_counters(bp))\n\t\treturn -EAGAIN;\n\n\testats->error_bytes_received_hi = 0;\n\testats->error_bytes_received_lo = 0;\n\n\tfor_each_eth_queue(bp, i) {\n\t\tstruct bnx2x_fastpath *fp = &bp->fp[i];\n\t\tstruct tstorm_per_queue_stats *tclient =\n\t\t\t&bp->fw_stats_data->queue_stats[i].\n\t\t\ttstorm_queue_statistics;\n\t\tstruct tstorm_per_queue_stats *old_tclient =\n\t\t\t&bnx2x_fp_stats(bp, fp)->old_tclient;\n\t\tstruct ustorm_per_queue_stats *uclient =\n\t\t\t&bp->fw_stats_data->queue_stats[i].\n\t\t\tustorm_queue_statistics;\n\t\tstruct ustorm_per_queue_stats *old_uclient =\n\t\t\t&bnx2x_fp_stats(bp, fp)->old_uclient;\n\t\tstruct xstorm_per_queue_stats *xclient =\n\t\t\t&bp->fw_stats_data->queue_stats[i].\n\t\t\txstorm_queue_statistics;\n\t\tstruct xstorm_per_queue_stats *old_xclient =\n\t\t\t&bnx2x_fp_stats(bp, fp)->old_xclient;\n\t\tstruct bnx2x_eth_q_stats *qstats =\n\t\t\t&bnx2x_fp_stats(bp, fp)->eth_q_stats;\n\t\tstruct bnx2x_eth_q_stats_old *qstats_old =\n\t\t\t&bnx2x_fp_stats(bp, fp)->eth_q_stats_old;\n\n\t\tu32 diff;\n\n\t\tDP(BNX2X_MSG_STATS, \"queue[%d]: ucast_sent 0x%x, bcast_sent 0x%x mcast_sent 0x%x\\n\",\n\t\t   i, xclient->ucast_pkts_sent,\n\t\t   xclient->bcast_pkts_sent, xclient->mcast_pkts_sent);\n\n\t\tDP(BNX2X_MSG_STATS, \"---------------\\n\");\n\n\t\tUPDATE_QSTAT(tclient->rcv_bcast_bytes,\n\t\t\t     total_broadcast_bytes_received);\n\t\tUPDATE_QSTAT(tclient->rcv_mcast_bytes,\n\t\t\t     total_multicast_bytes_received);\n\t\tUPDATE_QSTAT(tclient->rcv_ucast_bytes,\n\t\t\t     total_unicast_bytes_received);\n\n\t\t \n\t\tqstats->total_bytes_received_hi =\n\t\t\tqstats->total_broadcast_bytes_received_hi;\n\t\tqstats->total_bytes_received_lo =\n\t\t\tqstats->total_broadcast_bytes_received_lo;\n\n\t\tADD_64(qstats->total_bytes_received_hi,\n\t\t       qstats->total_multicast_bytes_received_hi,\n\t\t       qstats->total_bytes_received_lo,\n\t\t       qstats->total_multicast_bytes_received_lo);\n\n\t\tADD_64(qstats->total_bytes_received_hi,\n\t\t       qstats->total_unicast_bytes_received_hi,\n\t\t       qstats->total_bytes_received_lo,\n\t\t       qstats->total_unicast_bytes_received_lo);\n\n\t\tqstats->valid_bytes_received_hi =\n\t\t\t\t\tqstats->total_bytes_received_hi;\n\t\tqstats->valid_bytes_received_lo =\n\t\t\t\t\tqstats->total_bytes_received_lo;\n\n\t\tUPDATE_EXTEND_TSTAT(rcv_ucast_pkts,\n\t\t\t\t\ttotal_unicast_packets_received);\n\t\tUPDATE_EXTEND_TSTAT(rcv_mcast_pkts,\n\t\t\t\t\ttotal_multicast_packets_received);\n\t\tUPDATE_EXTEND_TSTAT(rcv_bcast_pkts,\n\t\t\t\t\ttotal_broadcast_packets_received);\n\t\tUPDATE_EXTEND_E_TSTAT(pkts_too_big_discard,\n\t\t\t\t      etherstatsoverrsizepkts, 32);\n\t\tUPDATE_EXTEND_E_TSTAT(no_buff_discard, no_buff_discard, 16);\n\n\t\tSUB_EXTEND_USTAT(ucast_no_buff_pkts,\n\t\t\t\t\ttotal_unicast_packets_received);\n\t\tSUB_EXTEND_USTAT(mcast_no_buff_pkts,\n\t\t\t\t\ttotal_multicast_packets_received);\n\t\tSUB_EXTEND_USTAT(bcast_no_buff_pkts,\n\t\t\t\t\ttotal_broadcast_packets_received);\n\t\tUPDATE_EXTEND_E_USTAT(ucast_no_buff_pkts, no_buff_discard);\n\t\tUPDATE_EXTEND_E_USTAT(mcast_no_buff_pkts, no_buff_discard);\n\t\tUPDATE_EXTEND_E_USTAT(bcast_no_buff_pkts, no_buff_discard);\n\n\t\tUPDATE_QSTAT(xclient->bcast_bytes_sent,\n\t\t\t     total_broadcast_bytes_transmitted);\n\t\tUPDATE_QSTAT(xclient->mcast_bytes_sent,\n\t\t\t     total_multicast_bytes_transmitted);\n\t\tUPDATE_QSTAT(xclient->ucast_bytes_sent,\n\t\t\t     total_unicast_bytes_transmitted);\n\n\t\t \n\t\tqstats->total_bytes_transmitted_hi =\n\t\t\t\tqstats->total_unicast_bytes_transmitted_hi;\n\t\tqstats->total_bytes_transmitted_lo =\n\t\t\t\tqstats->total_unicast_bytes_transmitted_lo;\n\n\t\tADD_64(qstats->total_bytes_transmitted_hi,\n\t\t       qstats->total_broadcast_bytes_transmitted_hi,\n\t\t       qstats->total_bytes_transmitted_lo,\n\t\t       qstats->total_broadcast_bytes_transmitted_lo);\n\n\t\tADD_64(qstats->total_bytes_transmitted_hi,\n\t\t       qstats->total_multicast_bytes_transmitted_hi,\n\t\t       qstats->total_bytes_transmitted_lo,\n\t\t       qstats->total_multicast_bytes_transmitted_lo);\n\n\t\tUPDATE_EXTEND_XSTAT(ucast_pkts_sent,\n\t\t\t\t\ttotal_unicast_packets_transmitted);\n\t\tUPDATE_EXTEND_XSTAT(mcast_pkts_sent,\n\t\t\t\t\ttotal_multicast_packets_transmitted);\n\t\tUPDATE_EXTEND_XSTAT(bcast_pkts_sent,\n\t\t\t\t\ttotal_broadcast_packets_transmitted);\n\n\t\tUPDATE_EXTEND_TSTAT(checksum_discard,\n\t\t\t\t    total_packets_received_checksum_discarded);\n\t\tUPDATE_EXTEND_TSTAT(ttl0_discard,\n\t\t\t\t    total_packets_received_ttl0_discarded);\n\n\t\tUPDATE_EXTEND_XSTAT(error_drop_pkts,\n\t\t\t\t    total_transmitted_dropped_packets_error);\n\n\t\t \n\t\tUPDATE_EXTEND_E_USTAT(coalesced_events, total_tpa_aggregations);\n\t\t \n\t\tUPDATE_EXTEND_E_USTAT(coalesced_pkts,\n\t\t\t\t      total_tpa_aggregated_frames);\n\t\t \n\t\tUPDATE_QSTAT(uclient->coalesced_bytes, total_tpa_bytes);\n\n\t\tUPDATE_ESTAT_QSTAT_64(total_tpa_bytes);\n\n\t\tUPDATE_FSTAT_QSTAT(total_bytes_received);\n\t\tUPDATE_FSTAT_QSTAT(total_bytes_transmitted);\n\t\tUPDATE_FSTAT_QSTAT(total_unicast_packets_received);\n\t\tUPDATE_FSTAT_QSTAT(total_multicast_packets_received);\n\t\tUPDATE_FSTAT_QSTAT(total_broadcast_packets_received);\n\t\tUPDATE_FSTAT_QSTAT(total_unicast_packets_transmitted);\n\t\tUPDATE_FSTAT_QSTAT(total_multicast_packets_transmitted);\n\t\tUPDATE_FSTAT_QSTAT(total_broadcast_packets_transmitted);\n\t\tUPDATE_FSTAT_QSTAT(valid_bytes_received);\n\t}\n\n\tADD_64(estats->total_bytes_received_hi,\n\t       estats->rx_stat_ifhcinbadoctets_hi,\n\t       estats->total_bytes_received_lo,\n\t       estats->rx_stat_ifhcinbadoctets_lo);\n\n\tADD_64_LE(estats->total_bytes_received_hi,\n\t\t  tfunc->rcv_error_bytes.hi,\n\t\t  estats->total_bytes_received_lo,\n\t\t  tfunc->rcv_error_bytes.lo);\n\n\tADD_64_LE(estats->error_bytes_received_hi,\n\t\t  tfunc->rcv_error_bytes.hi,\n\t\t  estats->error_bytes_received_lo,\n\t\t  tfunc->rcv_error_bytes.lo);\n\n\tUPDATE_ESTAT(etherstatsoverrsizepkts, rx_stat_dot3statsframestoolong);\n\n\tADD_64(estats->error_bytes_received_hi,\n\t       estats->rx_stat_ifhcinbadoctets_hi,\n\t       estats->error_bytes_received_lo,\n\t       estats->rx_stat_ifhcinbadoctets_lo);\n\n\tif (bp->port.pmf) {\n\t\tstruct bnx2x_fw_port_stats_old *fwstats = &bp->fw_stats_old;\n\t\tUPDATE_FW_STAT(mac_filter_discard);\n\t\tUPDATE_FW_STAT(mf_tag_discard);\n\t\tUPDATE_FW_STAT(brb_truncate_discard);\n\t\tUPDATE_FW_STAT(mac_discard);\n\t}\n\n\tfstats->host_func_stats_start = ++fstats->host_func_stats_end;\n\n\tbp->stats_pending = 0;\n\n\treturn 0;\n}\n\nstatic void bnx2x_net_stats_update(struct bnx2x *bp)\n{\n\tstruct bnx2x_eth_stats *estats = &bp->eth_stats;\n\tstruct net_device_stats *nstats = &bp->dev->stats;\n\tunsigned long tmp;\n\tint i;\n\n\tnstats->rx_packets =\n\t\tbnx2x_hilo(&estats->total_unicast_packets_received_hi) +\n\t\tbnx2x_hilo(&estats->total_multicast_packets_received_hi) +\n\t\tbnx2x_hilo(&estats->total_broadcast_packets_received_hi);\n\n\tnstats->tx_packets =\n\t\tbnx2x_hilo(&estats->total_unicast_packets_transmitted_hi) +\n\t\tbnx2x_hilo(&estats->total_multicast_packets_transmitted_hi) +\n\t\tbnx2x_hilo(&estats->total_broadcast_packets_transmitted_hi);\n\n\tnstats->rx_bytes = bnx2x_hilo(&estats->total_bytes_received_hi);\n\n\tnstats->tx_bytes = bnx2x_hilo(&estats->total_bytes_transmitted_hi);\n\n\ttmp = estats->mac_discard;\n\tfor_each_rx_queue(bp, i) {\n\t\tstruct tstorm_per_queue_stats *old_tclient =\n\t\t\t&bp->fp_stats[i].old_tclient;\n\t\ttmp += le32_to_cpu(old_tclient->checksum_discard);\n\t}\n\tnstats->rx_dropped = tmp + bp->net_stats_old.rx_dropped;\n\n\tnstats->tx_dropped = 0;\n\n\tnstats->multicast =\n\t\tbnx2x_hilo(&estats->total_multicast_packets_received_hi);\n\n\tnstats->collisions =\n\t\tbnx2x_hilo(&estats->tx_stat_etherstatscollisions_hi);\n\n\tnstats->rx_length_errors =\n\t\tbnx2x_hilo(&estats->rx_stat_etherstatsundersizepkts_hi) +\n\t\tbnx2x_hilo(&estats->etherstatsoverrsizepkts_hi);\n\tnstats->rx_over_errors = bnx2x_hilo(&estats->brb_drop_hi) +\n\t\t\t\t bnx2x_hilo(&estats->brb_truncate_hi);\n\tnstats->rx_crc_errors =\n\t\tbnx2x_hilo(&estats->rx_stat_dot3statsfcserrors_hi);\n\tnstats->rx_frame_errors =\n\t\tbnx2x_hilo(&estats->rx_stat_dot3statsalignmenterrors_hi);\n\tnstats->rx_fifo_errors = bnx2x_hilo(&estats->no_buff_discard_hi);\n\tnstats->rx_missed_errors = 0;\n\n\tnstats->rx_errors = nstats->rx_length_errors +\n\t\t\t    nstats->rx_over_errors +\n\t\t\t    nstats->rx_crc_errors +\n\t\t\t    nstats->rx_frame_errors +\n\t\t\t    nstats->rx_fifo_errors +\n\t\t\t    nstats->rx_missed_errors;\n\n\tnstats->tx_aborted_errors =\n\t\tbnx2x_hilo(&estats->tx_stat_dot3statslatecollisions_hi) +\n\t\tbnx2x_hilo(&estats->tx_stat_dot3statsexcessivecollisions_hi);\n\tnstats->tx_carrier_errors =\n\t\tbnx2x_hilo(&estats->rx_stat_dot3statscarriersenseerrors_hi);\n\tnstats->tx_fifo_errors = 0;\n\tnstats->tx_heartbeat_errors = 0;\n\tnstats->tx_window_errors = 0;\n\n\tnstats->tx_errors = nstats->tx_aborted_errors +\n\t\t\t    nstats->tx_carrier_errors +\n\t    bnx2x_hilo(&estats->tx_stat_dot3statsinternalmactransmiterrors_hi);\n}\n\nstatic void bnx2x_drv_stats_update(struct bnx2x *bp)\n{\n\tstruct bnx2x_eth_stats *estats = &bp->eth_stats;\n\tint i;\n\n\tfor_each_queue(bp, i) {\n\t\tstruct bnx2x_eth_q_stats *qstats = &bp->fp_stats[i].eth_q_stats;\n\t\tstruct bnx2x_eth_q_stats_old *qstats_old =\n\t\t\t&bp->fp_stats[i].eth_q_stats_old;\n\n\t\tUPDATE_ESTAT_QSTAT(driver_xoff);\n\t\tUPDATE_ESTAT_QSTAT(rx_err_discard_pkt);\n\t\tUPDATE_ESTAT_QSTAT(rx_skb_alloc_failed);\n\t\tUPDATE_ESTAT_QSTAT(hw_csum_err);\n\t\tUPDATE_ESTAT_QSTAT(driver_filtered_tx_pkt);\n\t}\n}\n\nstatic bool bnx2x_edebug_stats_stopped(struct bnx2x *bp)\n{\n\tu32 val;\n\n\tif (SHMEM2_HAS(bp, edebug_driver_if[1])) {\n\t\tval = SHMEM2_RD(bp, edebug_driver_if[1]);\n\n\t\tif (val == EDEBUG_DRIVER_IF_OP_CODE_DISABLE_STAT)\n\t\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic void bnx2x_stats_update(struct bnx2x *bp)\n{\n\tu32 *stats_comp = bnx2x_sp(bp, stats_comp);\n\n\tif (bnx2x_edebug_stats_stopped(bp))\n\t\treturn;\n\n\tif (IS_PF(bp)) {\n\t\tif (*stats_comp != DMAE_COMP_VAL)\n\t\t\treturn;\n\n\t\tif (bp->port.pmf)\n\t\t\tbnx2x_hw_stats_update(bp);\n\n\t\tif (bnx2x_storm_stats_update(bp)) {\n\t\t\tif (bp->stats_pending++ == 3) {\n\t\t\t\tBNX2X_ERR(\"storm stats were not updated for 3 times\\n\");\n\t\t\t\tbnx2x_panic();\n\t\t\t}\n\t\t\treturn;\n\t\t}\n\t} else {\n\t\t \n\t\tbnx2x_storm_stats_update(bp);\n\t}\n\n\tbnx2x_net_stats_update(bp);\n\tbnx2x_drv_stats_update(bp);\n\n\t \n\tif (IS_VF(bp))\n\t\treturn;\n\n\tif (netif_msg_timer(bp)) {\n\t\tstruct bnx2x_eth_stats *estats = &bp->eth_stats;\n\n\t\tnetdev_dbg(bp->dev, \"brb drops %u  brb truncate %u\\n\",\n\t\t       estats->brb_drop_lo, estats->brb_truncate_lo);\n\t}\n\n\tbnx2x_hw_stats_post(bp);\n\tbnx2x_storm_stats_post(bp);\n}\n\nstatic void bnx2x_port_stats_stop(struct bnx2x *bp)\n{\n\tstruct dmae_command *dmae;\n\tu32 opcode;\n\tint loader_idx = PMF_DMAE_C(bp);\n\tu32 *stats_comp = bnx2x_sp(bp, stats_comp);\n\n\tbp->executer_idx = 0;\n\n\topcode = bnx2x_dmae_opcode(bp, DMAE_SRC_PCI, DMAE_DST_GRC, false, 0);\n\n\tif (bp->port.port_stx) {\n\n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tif (bp->func_stx)\n\t\t\tdmae->opcode = bnx2x_dmae_opcode_add_comp(\n\t\t\t\t\t\topcode, DMAE_COMP_GRC);\n\t\telse\n\t\t\tdmae->opcode = bnx2x_dmae_opcode_add_comp(\n\t\t\t\t\t\topcode, DMAE_COMP_PCI);\n\n\t\tdmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, port_stats));\n\t\tdmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, port_stats));\n\t\tdmae->dst_addr_lo = bp->port.port_stx >> 2;\n\t\tdmae->dst_addr_hi = 0;\n\t\tdmae->len = bnx2x_get_port_stats_dma_len(bp);\n\t\tif (bp->func_stx) {\n\t\t\tdmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\n\t\t\tdmae->comp_addr_hi = 0;\n\t\t\tdmae->comp_val = 1;\n\t\t} else {\n\t\t\tdmae->comp_addr_lo =\n\t\t\t\tU64_LO(bnx2x_sp_mapping(bp, stats_comp));\n\t\t\tdmae->comp_addr_hi =\n\t\t\t\tU64_HI(bnx2x_sp_mapping(bp, stats_comp));\n\t\t\tdmae->comp_val = DMAE_COMP_VAL;\n\n\t\t\t*stats_comp = 0;\n\t\t}\n\t}\n\n\tif (bp->func_stx) {\n\n\t\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\t\tdmae->opcode =\n\t\t\tbnx2x_dmae_opcode_add_comp(opcode, DMAE_COMP_PCI);\n\t\tdmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, func_stats));\n\t\tdmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, func_stats));\n\t\tdmae->dst_addr_lo = bp->func_stx >> 2;\n\t\tdmae->dst_addr_hi = 0;\n\t\tdmae->len = sizeof(struct host_func_stats) >> 2;\n\t\tdmae->comp_addr_lo = U64_LO(bnx2x_sp_mapping(bp, stats_comp));\n\t\tdmae->comp_addr_hi = U64_HI(bnx2x_sp_mapping(bp, stats_comp));\n\t\tdmae->comp_val = DMAE_COMP_VAL;\n\n\t\t*stats_comp = 0;\n\t}\n}\n\nstatic void bnx2x_stats_stop(struct bnx2x *bp)\n{\n\tbool update = false;\n\n\tbnx2x_stats_comp(bp);\n\n\tif (bp->port.pmf)\n\t\tupdate = (bnx2x_hw_stats_update(bp) == 0);\n\n\tupdate |= (bnx2x_storm_stats_update(bp) == 0);\n\n\tif (update) {\n\t\tbnx2x_net_stats_update(bp);\n\n\t\tif (bp->port.pmf)\n\t\t\tbnx2x_port_stats_stop(bp);\n\n\t\tbnx2x_hw_stats_post(bp);\n\t\tbnx2x_stats_comp(bp);\n\t}\n}\n\nstatic void bnx2x_stats_do_nothing(struct bnx2x *bp)\n{\n}\n\nstatic const struct {\n\tvoid (*action)(struct bnx2x *bp);\n\tenum bnx2x_stats_state next_state;\n} bnx2x_stats_stm[STATS_STATE_MAX][STATS_EVENT_MAX] = {\n \n{\n  {bnx2x_stats_pmf_update, STATS_STATE_DISABLED},\n  {bnx2x_stats_start,      STATS_STATE_ENABLED},\n  {bnx2x_stats_do_nothing, STATS_STATE_DISABLED},\n  {bnx2x_stats_do_nothing, STATS_STATE_DISABLED}\n},\n{\n  {bnx2x_stats_pmf_start,  STATS_STATE_ENABLED},\n  {bnx2x_stats_restart,    STATS_STATE_ENABLED},\n  {bnx2x_stats_update,     STATS_STATE_ENABLED},\n  {bnx2x_stats_stop,       STATS_STATE_DISABLED}\n}\n};\n\nvoid bnx2x_stats_handle(struct bnx2x *bp, enum bnx2x_stats_event event)\n{\n\tenum bnx2x_stats_state state = bp->stats_state;\n\n\tif (unlikely(bp->panic))\n\t\treturn;\n\n\t \n\tif (down_trylock(&bp->stats_lock)) {\n\t\tif (event == STATS_EVENT_UPDATE)\n\t\t\treturn;\n\n\t\tDP(BNX2X_MSG_STATS,\n\t\t   \"Unlikely stats' lock contention [event %d]\\n\", event);\n\t\tif (unlikely(down_timeout(&bp->stats_lock, HZ / 10))) {\n\t\t\tBNX2X_ERR(\"Failed to take stats lock [event %d]\\n\",\n\t\t\t\t  event);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tbnx2x_stats_stm[state][event].action(bp);\n\tbp->stats_state = bnx2x_stats_stm[state][event].next_state;\n\n\tup(&bp->stats_lock);\n\n\tif ((event != STATS_EVENT_UPDATE) || netif_msg_timer(bp))\n\t\tDP(BNX2X_MSG_STATS, \"state %d -> event %d -> state %d\\n\",\n\t\t   state, event, bp->stats_state);\n}\n\nstatic void bnx2x_port_stats_base_init(struct bnx2x *bp)\n{\n\tstruct dmae_command *dmae;\n\tu32 *stats_comp = bnx2x_sp(bp, stats_comp);\n\n\t \n\tif (!bp->port.pmf || !bp->port.port_stx) {\n\t\tBNX2X_ERR(\"BUG!\\n\");\n\t\treturn;\n\t}\n\n\tbp->executer_idx = 0;\n\n\tdmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\n\tdmae->opcode = bnx2x_dmae_opcode(bp, DMAE_SRC_PCI, DMAE_DST_GRC,\n\t\t\t\t\t true, DMAE_COMP_PCI);\n\tdmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, port_stats));\n\tdmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, port_stats));\n\tdmae->dst_addr_lo = bp->port.port_stx >> 2;\n\tdmae->dst_addr_hi = 0;\n\tdmae->len = bnx2x_get_port_stats_dma_len(bp);\n\tdmae->comp_addr_lo = U64_LO(bnx2x_sp_mapping(bp, stats_comp));\n\tdmae->comp_addr_hi = U64_HI(bnx2x_sp_mapping(bp, stats_comp));\n\tdmae->comp_val = DMAE_COMP_VAL;\n\n\t*stats_comp = 0;\n\tbnx2x_hw_stats_post(bp);\n\tbnx2x_stats_comp(bp);\n}\n\n \nstatic void bnx2x_prep_fw_stats_req(struct bnx2x *bp)\n{\n\tint i;\n\tint first_queue_query_index;\n\tstruct stats_query_header *stats_hdr = &bp->fw_stats_req->hdr;\n\n\tdma_addr_t cur_data_offset;\n\tstruct stats_query_entry *cur_query_entry;\n\n\tstats_hdr->cmd_num = bp->fw_stats_num;\n\tstats_hdr->drv_stats_counter = 0;\n\n\t \n\tcur_data_offset = bp->fw_stats_data_mapping +\n\t\toffsetof(struct bnx2x_fw_stats_data, storm_counters);\n\n\tstats_hdr->stats_counters_addrs.hi =\n\t\tcpu_to_le32(U64_HI(cur_data_offset));\n\tstats_hdr->stats_counters_addrs.lo =\n\t\tcpu_to_le32(U64_LO(cur_data_offset));\n\n\t \n\tmemset(&bp->fw_stats_data->storm_counters, 0xff,\n\t       sizeof(struct stats_counter));\n\n\t \n\tcur_data_offset = bp->fw_stats_data_mapping +\n\t\toffsetof(struct bnx2x_fw_stats_data, port);\n\n\tcur_query_entry = &bp->fw_stats_req->query[BNX2X_PORT_QUERY_IDX];\n\n\tcur_query_entry->kind = STATS_TYPE_PORT;\n\t \n\tcur_query_entry->index = BP_PORT(bp);\n\t \n\tcur_query_entry->funcID = cpu_to_le16(BP_FUNC(bp));\n\tcur_query_entry->address.hi = cpu_to_le32(U64_HI(cur_data_offset));\n\tcur_query_entry->address.lo = cpu_to_le32(U64_LO(cur_data_offset));\n\n\t \n\tcur_data_offset = bp->fw_stats_data_mapping +\n\t\toffsetof(struct bnx2x_fw_stats_data, pf);\n\n\tcur_query_entry = &bp->fw_stats_req->query[BNX2X_PF_QUERY_IDX];\n\n\tcur_query_entry->kind = STATS_TYPE_PF;\n\t \n\tcur_query_entry->index = BP_PORT(bp);\n\tcur_query_entry->funcID = cpu_to_le16(BP_FUNC(bp));\n\tcur_query_entry->address.hi = cpu_to_le32(U64_HI(cur_data_offset));\n\tcur_query_entry->address.lo = cpu_to_le32(U64_LO(cur_data_offset));\n\n\t \n\tif (!NO_FCOE(bp)) {\n\t\tcur_data_offset = bp->fw_stats_data_mapping +\n\t\t\toffsetof(struct bnx2x_fw_stats_data, fcoe);\n\n\t\tcur_query_entry =\n\t\t\t&bp->fw_stats_req->query[BNX2X_FCOE_QUERY_IDX];\n\n\t\tcur_query_entry->kind = STATS_TYPE_FCOE;\n\t\t \n\t\tcur_query_entry->index = BP_PORT(bp);\n\t\tcur_query_entry->funcID = cpu_to_le16(BP_FUNC(bp));\n\t\tcur_query_entry->address.hi =\n\t\t\tcpu_to_le32(U64_HI(cur_data_offset));\n\t\tcur_query_entry->address.lo =\n\t\t\tcpu_to_le32(U64_LO(cur_data_offset));\n\t}\n\n\t \n\tcur_data_offset = bp->fw_stats_data_mapping +\n\t\toffsetof(struct bnx2x_fw_stats_data, queue_stats);\n\n\t \n\tif (!NO_FCOE(bp))\n\t\tfirst_queue_query_index = BNX2X_FIRST_QUEUE_QUERY_IDX;\n\telse\n\t\tfirst_queue_query_index = BNX2X_FIRST_QUEUE_QUERY_IDX - 1;\n\n\tfor_each_eth_queue(bp, i) {\n\t\tcur_query_entry =\n\t\t\t&bp->fw_stats_req->\n\t\t\t\t\tquery[first_queue_query_index + i];\n\n\t\tcur_query_entry->kind = STATS_TYPE_QUEUE;\n\t\tcur_query_entry->index = bnx2x_stats_id(&bp->fp[i]);\n\t\tcur_query_entry->funcID = cpu_to_le16(BP_FUNC(bp));\n\t\tcur_query_entry->address.hi =\n\t\t\tcpu_to_le32(U64_HI(cur_data_offset));\n\t\tcur_query_entry->address.lo =\n\t\t\tcpu_to_le32(U64_LO(cur_data_offset));\n\n\t\tcur_data_offset += sizeof(struct per_queue_stats);\n\t}\n\n\t \n\tif (!NO_FCOE(bp)) {\n\t\tcur_query_entry =\n\t\t\t&bp->fw_stats_req->\n\t\t\t\t\tquery[first_queue_query_index + i];\n\n\t\tcur_query_entry->kind = STATS_TYPE_QUEUE;\n\t\tcur_query_entry->index = bnx2x_stats_id(&bp->fp[FCOE_IDX(bp)]);\n\t\tcur_query_entry->funcID = cpu_to_le16(BP_FUNC(bp));\n\t\tcur_query_entry->address.hi =\n\t\t\tcpu_to_le32(U64_HI(cur_data_offset));\n\t\tcur_query_entry->address.lo =\n\t\t\tcpu_to_le32(U64_LO(cur_data_offset));\n\t}\n}\n\nvoid bnx2x_memset_stats(struct bnx2x *bp)\n{\n\tint i;\n\n\t \n\tfor_each_queue(bp, i) {\n\t\tstruct bnx2x_fp_stats *fp_stats = &bp->fp_stats[i];\n\n\t\tmemset(&fp_stats->old_tclient, 0,\n\t\t       sizeof(fp_stats->old_tclient));\n\t\tmemset(&fp_stats->old_uclient, 0,\n\t\t       sizeof(fp_stats->old_uclient));\n\t\tmemset(&fp_stats->old_xclient, 0,\n\t\t       sizeof(fp_stats->old_xclient));\n\t\tif (bp->stats_init) {\n\t\t\tmemset(&fp_stats->eth_q_stats, 0,\n\t\t\t       sizeof(fp_stats->eth_q_stats));\n\t\t\tmemset(&fp_stats->eth_q_stats_old, 0,\n\t\t\t       sizeof(fp_stats->eth_q_stats_old));\n\t\t}\n\t}\n\n\tmemset(&bp->dev->stats, 0, sizeof(bp->dev->stats));\n\n\tif (bp->stats_init) {\n\t\tmemset(&bp->net_stats_old, 0, sizeof(bp->net_stats_old));\n\t\tmemset(&bp->fw_stats_old, 0, sizeof(bp->fw_stats_old));\n\t\tmemset(&bp->eth_stats_old, 0, sizeof(bp->eth_stats_old));\n\t\tmemset(&bp->eth_stats, 0, sizeof(bp->eth_stats));\n\t\tmemset(&bp->func_stats, 0, sizeof(bp->func_stats));\n\t}\n\n\tbp->stats_state = STATS_STATE_DISABLED;\n\n\tif (bp->port.pmf && bp->port.port_stx)\n\t\tbnx2x_port_stats_base_init(bp);\n\n\t \n\tbp->stats_init = false;\n}\n\nvoid bnx2x_stats_init(struct bnx2x *bp)\n{\n\tint  port = BP_PORT(bp);\n\tint mb_idx = BP_FW_MB_IDX(bp);\n\n\tif (IS_VF(bp)) {\n\t\tbnx2x_memset_stats(bp);\n\t\treturn;\n\t}\n\n\tbp->stats_pending = 0;\n\tbp->executer_idx = 0;\n\tbp->stats_counter = 0;\n\n\t \n\tif (!BP_NOMCP(bp)) {\n\t\tbp->port.port_stx = SHMEM_RD(bp, port_mb[port].port_stx);\n\t\tbp->func_stx = SHMEM_RD(bp, func_mb[mb_idx].fw_mb_param);\n\n\t} else {\n\t\tbp->port.port_stx = 0;\n\t\tbp->func_stx = 0;\n\t}\n\tDP(BNX2X_MSG_STATS, \"port_stx 0x%x  func_stx 0x%x\\n\",\n\t   bp->port.port_stx, bp->func_stx);\n\n\t \n\tif (!bp->stats_init && bp->port.pmf && bp->port.port_stx)\n\t\tbnx2x_stats_handle(bp, STATS_EVENT_PMF);\n\n\tport = BP_PORT(bp);\n\t \n\tmemset(&(bp->port.old_nig_stats), 0, sizeof(struct nig_stats));\n\tbp->port.old_nig_stats.brb_discard =\n\t\t\tREG_RD(bp, NIG_REG_STAT0_BRB_DISCARD + port*0x38);\n\tbp->port.old_nig_stats.brb_truncate =\n\t\t\tREG_RD(bp, NIG_REG_STAT0_BRB_TRUNCATE + port*0x38);\n\tif (!CHIP_IS_E3(bp)) {\n\t\tREG_RD_DMAE(bp, NIG_REG_STAT0_EGRESS_MAC_PKT0 + port*0x50,\n\t\t\t    &(bp->port.old_nig_stats.egress_mac_pkt0), 2);\n\t\tREG_RD_DMAE(bp, NIG_REG_STAT0_EGRESS_MAC_PKT1 + port*0x50,\n\t\t\t    &(bp->port.old_nig_stats.egress_mac_pkt1), 2);\n\t}\n\n\t \n\tbnx2x_prep_fw_stats_req(bp);\n\n\t \n\tif (bp->stats_init) {\n\t\tif (bp->func_stx) {\n\t\t\tmemset(bnx2x_sp(bp, func_stats), 0,\n\t\t\t       sizeof(struct host_func_stats));\n\t\t\tbnx2x_func_stats_init(bp);\n\t\t\tbnx2x_hw_stats_post(bp);\n\t\t\tbnx2x_stats_comp(bp);\n\t\t}\n\t}\n\n\tbnx2x_memset_stats(bp);\n}\n\nvoid bnx2x_save_statistics(struct bnx2x *bp)\n{\n\tint i;\n\tstruct net_device_stats *nstats = &bp->dev->stats;\n\n\t \n\tfor_each_eth_queue(bp, i) {\n\t\tstruct bnx2x_fastpath *fp = &bp->fp[i];\n\t\tstruct bnx2x_eth_q_stats *qstats =\n\t\t\t&bnx2x_fp_stats(bp, fp)->eth_q_stats;\n\t\tstruct bnx2x_eth_q_stats_old *qstats_old =\n\t\t\t&bnx2x_fp_stats(bp, fp)->eth_q_stats_old;\n\n\t\tUPDATE_QSTAT_OLD(total_unicast_bytes_received_hi);\n\t\tUPDATE_QSTAT_OLD(total_unicast_bytes_received_lo);\n\t\tUPDATE_QSTAT_OLD(total_broadcast_bytes_received_hi);\n\t\tUPDATE_QSTAT_OLD(total_broadcast_bytes_received_lo);\n\t\tUPDATE_QSTAT_OLD(total_multicast_bytes_received_hi);\n\t\tUPDATE_QSTAT_OLD(total_multicast_bytes_received_lo);\n\t\tUPDATE_QSTAT_OLD(total_unicast_bytes_transmitted_hi);\n\t\tUPDATE_QSTAT_OLD(total_unicast_bytes_transmitted_lo);\n\t\tUPDATE_QSTAT_OLD(total_broadcast_bytes_transmitted_hi);\n\t\tUPDATE_QSTAT_OLD(total_broadcast_bytes_transmitted_lo);\n\t\tUPDATE_QSTAT_OLD(total_multicast_bytes_transmitted_hi);\n\t\tUPDATE_QSTAT_OLD(total_multicast_bytes_transmitted_lo);\n\t\tUPDATE_QSTAT_OLD(total_tpa_bytes_hi);\n\t\tUPDATE_QSTAT_OLD(total_tpa_bytes_lo);\n\t}\n\n\t \n\tbp->net_stats_old.rx_dropped = nstats->rx_dropped;\n\n\t \n\tif (bp->port.pmf && IS_MF(bp)) {\n\t\tstruct bnx2x_eth_stats *estats = &bp->eth_stats;\n\t\tstruct bnx2x_fw_port_stats_old *fwstats = &bp->fw_stats_old;\n\t\tUPDATE_FW_STAT_OLD(mac_filter_discard);\n\t\tUPDATE_FW_STAT_OLD(mf_tag_discard);\n\t\tUPDATE_FW_STAT_OLD(brb_truncate_discard);\n\t\tUPDATE_FW_STAT_OLD(mac_discard);\n\t}\n}\n\nvoid bnx2x_afex_collect_stats(struct bnx2x *bp, void *void_afex_stats,\n\t\t\t      u32 stats_type)\n{\n\tint i;\n\tstruct afex_stats *afex_stats = (struct afex_stats *)void_afex_stats;\n\tstruct bnx2x_eth_stats *estats = &bp->eth_stats;\n\tstruct per_queue_stats *fcoe_q_stats =\n\t\t&bp->fw_stats_data->queue_stats[FCOE_IDX(bp)];\n\n\tstruct tstorm_per_queue_stats *fcoe_q_tstorm_stats =\n\t\t&fcoe_q_stats->tstorm_queue_statistics;\n\n\tstruct ustorm_per_queue_stats *fcoe_q_ustorm_stats =\n\t\t&fcoe_q_stats->ustorm_queue_statistics;\n\n\tstruct xstorm_per_queue_stats *fcoe_q_xstorm_stats =\n\t\t&fcoe_q_stats->xstorm_queue_statistics;\n\n\tstruct fcoe_statistics_params *fw_fcoe_stat =\n\t\t&bp->fw_stats_data->fcoe;\n\n\tmemset(afex_stats, 0, sizeof(struct afex_stats));\n\n\tfor_each_eth_queue(bp, i) {\n\t\tstruct bnx2x_eth_q_stats *qstats = &bp->fp_stats[i].eth_q_stats;\n\n\t\tADD_64(afex_stats->rx_unicast_bytes_hi,\n\t\t       qstats->total_unicast_bytes_received_hi,\n\t\t       afex_stats->rx_unicast_bytes_lo,\n\t\t       qstats->total_unicast_bytes_received_lo);\n\n\t\tADD_64(afex_stats->rx_broadcast_bytes_hi,\n\t\t       qstats->total_broadcast_bytes_received_hi,\n\t\t       afex_stats->rx_broadcast_bytes_lo,\n\t\t       qstats->total_broadcast_bytes_received_lo);\n\n\t\tADD_64(afex_stats->rx_multicast_bytes_hi,\n\t\t       qstats->total_multicast_bytes_received_hi,\n\t\t       afex_stats->rx_multicast_bytes_lo,\n\t\t       qstats->total_multicast_bytes_received_lo);\n\n\t\tADD_64(afex_stats->rx_unicast_frames_hi,\n\t\t       qstats->total_unicast_packets_received_hi,\n\t\t       afex_stats->rx_unicast_frames_lo,\n\t\t       qstats->total_unicast_packets_received_lo);\n\n\t\tADD_64(afex_stats->rx_broadcast_frames_hi,\n\t\t       qstats->total_broadcast_packets_received_hi,\n\t\t       afex_stats->rx_broadcast_frames_lo,\n\t\t       qstats->total_broadcast_packets_received_lo);\n\n\t\tADD_64(afex_stats->rx_multicast_frames_hi,\n\t\t       qstats->total_multicast_packets_received_hi,\n\t\t       afex_stats->rx_multicast_frames_lo,\n\t\t       qstats->total_multicast_packets_received_lo);\n\n\t\t \n\t\tADD_64(afex_stats->rx_frames_discarded_hi,\n\t\t       qstats->total_packets_received_checksum_discarded_hi,\n\t\t       afex_stats->rx_frames_discarded_lo,\n\t\t       qstats->total_packets_received_checksum_discarded_lo);\n\n\t\tADD_64(afex_stats->rx_frames_discarded_hi,\n\t\t       qstats->total_packets_received_ttl0_discarded_hi,\n\t\t       afex_stats->rx_frames_discarded_lo,\n\t\t       qstats->total_packets_received_ttl0_discarded_lo);\n\n\t\tADD_64(afex_stats->rx_frames_discarded_hi,\n\t\t       qstats->etherstatsoverrsizepkts_hi,\n\t\t       afex_stats->rx_frames_discarded_lo,\n\t\t       qstats->etherstatsoverrsizepkts_lo);\n\n\t\tADD_64(afex_stats->rx_frames_dropped_hi,\n\t\t       qstats->no_buff_discard_hi,\n\t\t       afex_stats->rx_frames_dropped_lo,\n\t\t       qstats->no_buff_discard_lo);\n\n\t\tADD_64(afex_stats->tx_unicast_bytes_hi,\n\t\t       qstats->total_unicast_bytes_transmitted_hi,\n\t\t       afex_stats->tx_unicast_bytes_lo,\n\t\t       qstats->total_unicast_bytes_transmitted_lo);\n\n\t\tADD_64(afex_stats->tx_broadcast_bytes_hi,\n\t\t       qstats->total_broadcast_bytes_transmitted_hi,\n\t\t       afex_stats->tx_broadcast_bytes_lo,\n\t\t       qstats->total_broadcast_bytes_transmitted_lo);\n\n\t\tADD_64(afex_stats->tx_multicast_bytes_hi,\n\t\t       qstats->total_multicast_bytes_transmitted_hi,\n\t\t       afex_stats->tx_multicast_bytes_lo,\n\t\t       qstats->total_multicast_bytes_transmitted_lo);\n\n\t\tADD_64(afex_stats->tx_unicast_frames_hi,\n\t\t       qstats->total_unicast_packets_transmitted_hi,\n\t\t       afex_stats->tx_unicast_frames_lo,\n\t\t       qstats->total_unicast_packets_transmitted_lo);\n\n\t\tADD_64(afex_stats->tx_broadcast_frames_hi,\n\t\t       qstats->total_broadcast_packets_transmitted_hi,\n\t\t       afex_stats->tx_broadcast_frames_lo,\n\t\t       qstats->total_broadcast_packets_transmitted_lo);\n\n\t\tADD_64(afex_stats->tx_multicast_frames_hi,\n\t\t       qstats->total_multicast_packets_transmitted_hi,\n\t\t       afex_stats->tx_multicast_frames_lo,\n\t\t       qstats->total_multicast_packets_transmitted_lo);\n\n\t\tADD_64(afex_stats->tx_frames_dropped_hi,\n\t\t       qstats->total_transmitted_dropped_packets_error_hi,\n\t\t       afex_stats->tx_frames_dropped_lo,\n\t\t       qstats->total_transmitted_dropped_packets_error_lo);\n\t}\n\n\t \n\tif (!NO_FCOE(bp)) {\n\t\tADD_64_LE(afex_stats->rx_unicast_bytes_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_unicast_bytes_lo,\n\t\t\t  fw_fcoe_stat->rx_stat0.fcoe_rx_byte_cnt);\n\n\t\tADD_64_LE(afex_stats->rx_unicast_bytes_hi,\n\t\t\t  fcoe_q_tstorm_stats->rcv_ucast_bytes.hi,\n\t\t\t  afex_stats->rx_unicast_bytes_lo,\n\t\t\t  fcoe_q_tstorm_stats->rcv_ucast_bytes.lo);\n\n\t\tADD_64_LE(afex_stats->rx_broadcast_bytes_hi,\n\t\t\t  fcoe_q_tstorm_stats->rcv_bcast_bytes.hi,\n\t\t\t  afex_stats->rx_broadcast_bytes_lo,\n\t\t\t  fcoe_q_tstorm_stats->rcv_bcast_bytes.lo);\n\n\t\tADD_64_LE(afex_stats->rx_multicast_bytes_hi,\n\t\t\t  fcoe_q_tstorm_stats->rcv_mcast_bytes.hi,\n\t\t\t  afex_stats->rx_multicast_bytes_lo,\n\t\t\t  fcoe_q_tstorm_stats->rcv_mcast_bytes.lo);\n\n\t\tADD_64_LE(afex_stats->rx_unicast_frames_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_unicast_frames_lo,\n\t\t\t  fw_fcoe_stat->rx_stat0.fcoe_rx_pkt_cnt);\n\n\t\tADD_64_LE(afex_stats->rx_unicast_frames_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_unicast_frames_lo,\n\t\t\t  fcoe_q_tstorm_stats->rcv_ucast_pkts);\n\n\t\tADD_64_LE(afex_stats->rx_broadcast_frames_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_broadcast_frames_lo,\n\t\t\t  fcoe_q_tstorm_stats->rcv_bcast_pkts);\n\n\t\tADD_64_LE(afex_stats->rx_multicast_frames_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_multicast_frames_lo,\n\t\t\t  fcoe_q_tstorm_stats->rcv_ucast_pkts);\n\n\t\tADD_64_LE(afex_stats->rx_frames_discarded_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_frames_discarded_lo,\n\t\t\t  fcoe_q_tstorm_stats->checksum_discard);\n\n\t\tADD_64_LE(afex_stats->rx_frames_discarded_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_frames_discarded_lo,\n\t\t\t  fcoe_q_tstorm_stats->pkts_too_big_discard);\n\n\t\tADD_64_LE(afex_stats->rx_frames_discarded_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_frames_discarded_lo,\n\t\t\t  fcoe_q_tstorm_stats->ttl0_discard);\n\n\t\tADD_64_LE16(afex_stats->rx_frames_dropped_hi,\n\t\t\t    LE16_0,\n\t\t\t    afex_stats->rx_frames_dropped_lo,\n\t\t\t    fcoe_q_tstorm_stats->no_buff_discard);\n\n\t\tADD_64_LE(afex_stats->rx_frames_dropped_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_frames_dropped_lo,\n\t\t\t  fcoe_q_ustorm_stats->ucast_no_buff_pkts);\n\n\t\tADD_64_LE(afex_stats->rx_frames_dropped_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_frames_dropped_lo,\n\t\t\t  fcoe_q_ustorm_stats->mcast_no_buff_pkts);\n\n\t\tADD_64_LE(afex_stats->rx_frames_dropped_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_frames_dropped_lo,\n\t\t\t  fcoe_q_ustorm_stats->bcast_no_buff_pkts);\n\n\t\tADD_64_LE(afex_stats->rx_frames_dropped_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_frames_dropped_lo,\n\t\t\t  fw_fcoe_stat->rx_stat1.fcoe_rx_drop_pkt_cnt);\n\n\t\tADD_64_LE(afex_stats->rx_frames_dropped_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->rx_frames_dropped_lo,\n\t\t\t  fw_fcoe_stat->rx_stat2.fcoe_rx_drop_pkt_cnt);\n\n\t\tADD_64_LE(afex_stats->tx_unicast_bytes_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->tx_unicast_bytes_lo,\n\t\t\t  fw_fcoe_stat->tx_stat.fcoe_tx_byte_cnt);\n\n\t\tADD_64_LE(afex_stats->tx_unicast_bytes_hi,\n\t\t\t  fcoe_q_xstorm_stats->ucast_bytes_sent.hi,\n\t\t\t  afex_stats->tx_unicast_bytes_lo,\n\t\t\t  fcoe_q_xstorm_stats->ucast_bytes_sent.lo);\n\n\t\tADD_64_LE(afex_stats->tx_broadcast_bytes_hi,\n\t\t\t  fcoe_q_xstorm_stats->bcast_bytes_sent.hi,\n\t\t\t  afex_stats->tx_broadcast_bytes_lo,\n\t\t\t  fcoe_q_xstorm_stats->bcast_bytes_sent.lo);\n\n\t\tADD_64_LE(afex_stats->tx_multicast_bytes_hi,\n\t\t\t  fcoe_q_xstorm_stats->mcast_bytes_sent.hi,\n\t\t\t  afex_stats->tx_multicast_bytes_lo,\n\t\t\t  fcoe_q_xstorm_stats->mcast_bytes_sent.lo);\n\n\t\tADD_64_LE(afex_stats->tx_unicast_frames_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->tx_unicast_frames_lo,\n\t\t\t  fw_fcoe_stat->tx_stat.fcoe_tx_pkt_cnt);\n\n\t\tADD_64_LE(afex_stats->tx_unicast_frames_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->tx_unicast_frames_lo,\n\t\t\t  fcoe_q_xstorm_stats->ucast_pkts_sent);\n\n\t\tADD_64_LE(afex_stats->tx_broadcast_frames_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->tx_broadcast_frames_lo,\n\t\t\t  fcoe_q_xstorm_stats->bcast_pkts_sent);\n\n\t\tADD_64_LE(afex_stats->tx_multicast_frames_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->tx_multicast_frames_lo,\n\t\t\t  fcoe_q_xstorm_stats->mcast_pkts_sent);\n\n\t\tADD_64_LE(afex_stats->tx_frames_dropped_hi,\n\t\t\t  LE32_0,\n\t\t\t  afex_stats->tx_frames_dropped_lo,\n\t\t\t  fcoe_q_xstorm_stats->error_drop_pkts);\n\t}\n\n\t \n\tif ((bp->port.pmf) && (stats_type == VICSTATST_UIF_INDEX)) {\n\t\tADD_64(afex_stats->rx_frames_dropped_hi,\n\t\t       0,\n\t\t       afex_stats->rx_frames_dropped_lo,\n\t\t       estats->mac_filter_discard);\n\t\tADD_64(afex_stats->rx_frames_dropped_hi,\n\t\t       0,\n\t\t       afex_stats->rx_frames_dropped_lo,\n\t\t       estats->brb_truncate_discard);\n\t\tADD_64(afex_stats->rx_frames_discarded_hi,\n\t\t       0,\n\t\t       afex_stats->rx_frames_discarded_lo,\n\t\t       estats->mac_discard);\n\t}\n}\n\nint bnx2x_stats_safe_exec(struct bnx2x *bp,\n\t\t\t  void (func_to_exec)(void *cookie),\n\t\t\t  void *cookie)\n{\n\tint cnt = 10, rc = 0;\n\n\t \n\trc = down_timeout(&bp->stats_lock, HZ / 10);\n\tif (unlikely(rc)) {\n\t\tBNX2X_ERR(\"Failed to take statistics lock for safe execution\\n\");\n\t\tgoto out_no_lock;\n\t}\n\n\tbnx2x_stats_comp(bp);\n\twhile (bp->stats_pending && cnt--)\n\t\tif (bnx2x_storm_stats_update(bp))\n\t\t\tusleep_range(1000, 2000);\n\tif (bp->stats_pending) {\n\t\tBNX2X_ERR(\"Failed to wait for stats pending to clear [possibly FW is stuck]\\n\");\n\t\trc = -EBUSY;\n\t\tgoto out;\n\t}\n\n\tfunc_to_exec(cookie);\n\nout:\n\t \n\tup(&bp->stats_lock);\nout_no_lock:\n\treturn rc;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}