{
  "module_name": "hinic_hw_io.c",
  "hash_id": "b898e4a390c22bb45652f42f1446b04b393f3716058001f1f25c433102dbabe5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/huawei/hinic/hinic_hw_io.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/pci.h>\n#include <linux/device.h>\n#include <linux/errno.h>\n#include <linux/slab.h>\n#include <linux/semaphore.h>\n#include <linux/dma-mapping.h>\n#include <linux/io.h>\n#include <linux/err.h>\n\n#include \"hinic_hw_dev.h\"\n#include \"hinic_hw_if.h\"\n#include \"hinic_hw_eqs.h\"\n#include \"hinic_hw_wqe.h\"\n#include \"hinic_hw_wq.h\"\n#include \"hinic_hw_cmdq.h\"\n#include \"hinic_hw_qp_ctxt.h\"\n#include \"hinic_hw_qp.h\"\n#include \"hinic_hw_io.h\"\n\n#define CI_Q_ADDR_SIZE                  sizeof(u32)\n\n#define CI_ADDR(base_addr, q_id)        ((base_addr) + \\\n\t\t\t\t\t (q_id) * CI_Q_ADDR_SIZE)\n\n#define CI_TABLE_SIZE(num_qps)          ((num_qps) * CI_Q_ADDR_SIZE)\n\n#define DB_IDX(db, db_base)             \\\n\t(((unsigned long)(db) - (unsigned long)(db_base)) / HINIC_DB_PAGE_SIZE)\n\n#define HINIC_PAGE_SIZE_HW(pg_size)\t((u8)ilog2((u32)((pg_size) >> 12)))\n\nenum io_cmd {\n\tIO_CMD_MODIFY_QUEUE_CTXT = 0,\n\tIO_CMD_CLEAN_QUEUE_CTXT,\n};\n\nstatic void init_db_area_idx(struct hinic_free_db_area *free_db_area)\n{\n\tint i;\n\n\tfor (i = 0; i < HINIC_DB_MAX_AREAS; i++)\n\t\tfree_db_area->db_idx[i] = i;\n\n\tfree_db_area->alloc_pos = 0;\n\tfree_db_area->return_pos = HINIC_DB_MAX_AREAS;\n\n\tfree_db_area->num_free = HINIC_DB_MAX_AREAS;\n\n\tsema_init(&free_db_area->idx_lock, 1);\n}\n\nstatic void __iomem *get_db_area(struct hinic_func_to_io *func_to_io)\n{\n\tstruct hinic_free_db_area *free_db_area = &func_to_io->free_db_area;\n\tint pos, idx;\n\n\tdown(&free_db_area->idx_lock);\n\n\tfree_db_area->num_free--;\n\n\tif (free_db_area->num_free < 0) {\n\t\tfree_db_area->num_free++;\n\t\tup(&free_db_area->idx_lock);\n\t\treturn ERR_PTR(-ENOMEM);\n\t}\n\n\tpos = free_db_area->alloc_pos++;\n\tpos &= HINIC_DB_MAX_AREAS - 1;\n\n\tidx = free_db_area->db_idx[pos];\n\n\tfree_db_area->db_idx[pos] = -1;\n\n\tup(&free_db_area->idx_lock);\n\n\treturn func_to_io->db_base + idx * HINIC_DB_PAGE_SIZE;\n}\n\nstatic void return_db_area(struct hinic_func_to_io *func_to_io,\n\t\t\t   void __iomem *db_base)\n{\n\tstruct hinic_free_db_area *free_db_area = &func_to_io->free_db_area;\n\tint pos, idx = DB_IDX(db_base, func_to_io->db_base);\n\n\tdown(&free_db_area->idx_lock);\n\n\tpos = free_db_area->return_pos++;\n\tpos &= HINIC_DB_MAX_AREAS - 1;\n\n\tfree_db_area->db_idx[pos] = idx;\n\n\tfree_db_area->num_free++;\n\n\tup(&free_db_area->idx_lock);\n}\n\nstatic int write_sq_ctxts(struct hinic_func_to_io *func_to_io, u16 base_qpn,\n\t\t\t  u16 num_sqs)\n{\n\tstruct hinic_hwif *hwif = func_to_io->hwif;\n\tstruct hinic_sq_ctxt_block *sq_ctxt_block;\n\tstruct pci_dev *pdev = hwif->pdev;\n\tstruct hinic_cmdq_buf cmdq_buf;\n\tstruct hinic_sq_ctxt *sq_ctxt;\n\tstruct hinic_qp *qp;\n\tu64 out_param;\n\tint err, i;\n\n\terr = hinic_alloc_cmdq_buf(&func_to_io->cmdqs, &cmdq_buf);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to allocate cmdq buf\\n\");\n\t\treturn err;\n\t}\n\n\tsq_ctxt_block = cmdq_buf.buf;\n\tsq_ctxt = sq_ctxt_block->sq_ctxt;\n\n\thinic_qp_prepare_header(&sq_ctxt_block->hdr, HINIC_QP_CTXT_TYPE_SQ,\n\t\t\t\tnum_sqs, func_to_io->max_qps);\n\tfor (i = 0; i < num_sqs; i++) {\n\t\tqp = &func_to_io->qps[i];\n\n\t\thinic_sq_prepare_ctxt(&sq_ctxt[i], &qp->sq,\n\t\t\t\t      base_qpn + qp->q_id);\n\t}\n\n\tcmdq_buf.size = HINIC_SQ_CTXT_SIZE(num_sqs);\n\n\terr = hinic_cmdq_direct_resp(&func_to_io->cmdqs, HINIC_MOD_L2NIC,\n\t\t\t\t     IO_CMD_MODIFY_QUEUE_CTXT, &cmdq_buf,\n\t\t\t\t     &out_param);\n\tif (err || out_param != 0) {\n\t\tdev_err(&pdev->dev, \"Failed to set SQ ctxts\\n\");\n\t\terr = -EFAULT;\n\t}\n\n\thinic_free_cmdq_buf(&func_to_io->cmdqs, &cmdq_buf);\n\treturn err;\n}\n\nstatic int write_rq_ctxts(struct hinic_func_to_io *func_to_io, u16 base_qpn,\n\t\t\t  u16 num_rqs)\n{\n\tstruct hinic_hwif *hwif = func_to_io->hwif;\n\tstruct hinic_rq_ctxt_block *rq_ctxt_block;\n\tstruct pci_dev *pdev = hwif->pdev;\n\tstruct hinic_cmdq_buf cmdq_buf;\n\tstruct hinic_rq_ctxt *rq_ctxt;\n\tstruct hinic_qp *qp;\n\tu64 out_param;\n\tint err, i;\n\n\terr = hinic_alloc_cmdq_buf(&func_to_io->cmdqs, &cmdq_buf);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to allocate cmdq buf\\n\");\n\t\treturn err;\n\t}\n\n\trq_ctxt_block = cmdq_buf.buf;\n\trq_ctxt = rq_ctxt_block->rq_ctxt;\n\n\thinic_qp_prepare_header(&rq_ctxt_block->hdr, HINIC_QP_CTXT_TYPE_RQ,\n\t\t\t\tnum_rqs, func_to_io->max_qps);\n\tfor (i = 0; i < num_rqs; i++) {\n\t\tqp = &func_to_io->qps[i];\n\n\t\thinic_rq_prepare_ctxt(&rq_ctxt[i], &qp->rq,\n\t\t\t\t      base_qpn + qp->q_id);\n\t}\n\n\tcmdq_buf.size = HINIC_RQ_CTXT_SIZE(num_rqs);\n\n\terr = hinic_cmdq_direct_resp(&func_to_io->cmdqs, HINIC_MOD_L2NIC,\n\t\t\t\t     IO_CMD_MODIFY_QUEUE_CTXT, &cmdq_buf,\n\t\t\t\t     &out_param);\n\tif (err || out_param != 0) {\n\t\tdev_err(&pdev->dev, \"Failed to set RQ ctxts\\n\");\n\t\terr = -EFAULT;\n\t}\n\n\thinic_free_cmdq_buf(&func_to_io->cmdqs, &cmdq_buf);\n\treturn err;\n}\n\n \nstatic int write_qp_ctxts(struct hinic_func_to_io *func_to_io, u16 base_qpn,\n\t\t\t  u16 num_qps)\n{\n\treturn (write_sq_ctxts(func_to_io, base_qpn, num_qps) ||\n\t\twrite_rq_ctxts(func_to_io, base_qpn, num_qps));\n}\n\nstatic int hinic_clean_queue_offload_ctxt(struct hinic_func_to_io *func_to_io,\n\t\t\t\t\t  enum hinic_qp_ctxt_type ctxt_type)\n{\n\tstruct hinic_hwif *hwif = func_to_io->hwif;\n\tstruct hinic_clean_queue_ctxt *ctxt_block;\n\tstruct pci_dev *pdev = hwif->pdev;\n\tstruct hinic_cmdq_buf cmdq_buf;\n\tu64 out_param = 0;\n\tint err;\n\n\terr = hinic_alloc_cmdq_buf(&func_to_io->cmdqs, &cmdq_buf);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to allocate cmdq buf\\n\");\n\t\treturn err;\n\t}\n\n\tctxt_block = cmdq_buf.buf;\n\tctxt_block->cmdq_hdr.num_queues = func_to_io->max_qps;\n\tctxt_block->cmdq_hdr.queue_type = ctxt_type;\n\tctxt_block->cmdq_hdr.addr_offset = 0;\n\n\t \n\tctxt_block->ctxt_size = 0x3;\n\n\thinic_cpu_to_be32(ctxt_block, sizeof(*ctxt_block));\n\n\tcmdq_buf.size = sizeof(*ctxt_block);\n\n\terr = hinic_cmdq_direct_resp(&func_to_io->cmdqs, HINIC_MOD_L2NIC,\n\t\t\t\t     IO_CMD_CLEAN_QUEUE_CTXT,\n\t\t\t\t     &cmdq_buf, &out_param);\n\n\tif (err || out_param) {\n\t\tdev_err(&pdev->dev, \"Failed to clean offload ctxts, err: %d, out_param: 0x%llx\\n\",\n\t\t\terr, out_param);\n\n\t\terr = -EFAULT;\n\t}\n\n\thinic_free_cmdq_buf(&func_to_io->cmdqs, &cmdq_buf);\n\n\treturn err;\n}\n\nstatic int hinic_clean_qp_offload_ctxt(struct hinic_func_to_io *func_to_io)\n{\n\t \n\treturn (hinic_clean_queue_offload_ctxt(func_to_io,\n\t\t\t\t\t       HINIC_QP_CTXT_TYPE_SQ) ||\n\t\thinic_clean_queue_offload_ctxt(func_to_io,\n\t\t\t\t\t       HINIC_QP_CTXT_TYPE_RQ));\n}\n\n \nstatic int init_qp(struct hinic_func_to_io *func_to_io,\n\t\t   struct hinic_qp *qp, int q_id,\n\t\t   struct msix_entry *sq_msix_entry,\n\t\t   struct msix_entry *rq_msix_entry)\n{\n\tstruct hinic_hwif *hwif = func_to_io->hwif;\n\tstruct pci_dev *pdev = hwif->pdev;\n\tvoid __iomem *db_base;\n\tint err;\n\n\tqp->q_id = q_id;\n\n\terr = hinic_wq_allocate(&func_to_io->wqs, &func_to_io->sq_wq[q_id],\n\t\t\t\tHINIC_SQ_WQEBB_SIZE, HINIC_SQ_PAGE_SIZE,\n\t\t\t\tfunc_to_io->sq_depth, HINIC_SQ_WQE_MAX_SIZE);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to allocate WQ for SQ\\n\");\n\t\treturn err;\n\t}\n\n\terr = hinic_wq_allocate(&func_to_io->wqs, &func_to_io->rq_wq[q_id],\n\t\t\t\tHINIC_RQ_WQEBB_SIZE, HINIC_RQ_PAGE_SIZE,\n\t\t\t\tfunc_to_io->rq_depth, HINIC_RQ_WQE_SIZE);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to allocate WQ for RQ\\n\");\n\t\tgoto err_rq_alloc;\n\t}\n\n\tdb_base = get_db_area(func_to_io);\n\tif (IS_ERR(db_base)) {\n\t\tdev_err(&pdev->dev, \"Failed to get DB area for SQ\\n\");\n\t\terr = PTR_ERR(db_base);\n\t\tgoto err_get_db;\n\t}\n\n\tfunc_to_io->sq_db[q_id] = db_base;\n\n\tqp->sq.qid = q_id;\n\terr = hinic_init_sq(&qp->sq, hwif, &func_to_io->sq_wq[q_id],\n\t\t\t    sq_msix_entry,\n\t\t\t    CI_ADDR(func_to_io->ci_addr_base, q_id),\n\t\t\t    CI_ADDR(func_to_io->ci_dma_base, q_id), db_base);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to init SQ\\n\");\n\t\tgoto err_sq_init;\n\t}\n\n\tqp->rq.qid = q_id;\n\terr = hinic_init_rq(&qp->rq, hwif, &func_to_io->rq_wq[q_id],\n\t\t\t    rq_msix_entry);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to init RQ\\n\");\n\t\tgoto err_rq_init;\n\t}\n\n\treturn 0;\n\nerr_rq_init:\n\thinic_clean_sq(&qp->sq);\n\nerr_sq_init:\n\treturn_db_area(func_to_io, db_base);\n\nerr_get_db:\n\thinic_wq_free(&func_to_io->wqs, &func_to_io->rq_wq[q_id]);\n\nerr_rq_alloc:\n\thinic_wq_free(&func_to_io->wqs, &func_to_io->sq_wq[q_id]);\n\treturn err;\n}\n\n \nstatic void destroy_qp(struct hinic_func_to_io *func_to_io,\n\t\t       struct hinic_qp *qp)\n{\n\tint q_id = qp->q_id;\n\n\thinic_clean_rq(&qp->rq);\n\thinic_clean_sq(&qp->sq);\n\n\treturn_db_area(func_to_io, func_to_io->sq_db[q_id]);\n\n\thinic_wq_free(&func_to_io->wqs, &func_to_io->rq_wq[q_id]);\n\thinic_wq_free(&func_to_io->wqs, &func_to_io->sq_wq[q_id]);\n}\n\n \nint hinic_io_create_qps(struct hinic_func_to_io *func_to_io,\n\t\t\tu16 base_qpn, int num_qps,\n\t\t\tstruct msix_entry *sq_msix_entries,\n\t\t\tstruct msix_entry *rq_msix_entries)\n{\n\tstruct hinic_hwif *hwif = func_to_io->hwif;\n\tstruct pci_dev *pdev = hwif->pdev;\n\tvoid *ci_addr_base;\n\tint i, j, err;\n\n\tfunc_to_io->qps = devm_kcalloc(&pdev->dev, num_qps,\n\t\t\t\t       sizeof(*func_to_io->qps), GFP_KERNEL);\n\tif (!func_to_io->qps)\n\t\treturn -ENOMEM;\n\n\tfunc_to_io->sq_wq = devm_kcalloc(&pdev->dev, num_qps,\n\t\t\t\t\t sizeof(*func_to_io->sq_wq), GFP_KERNEL);\n\tif (!func_to_io->sq_wq) {\n\t\terr = -ENOMEM;\n\t\tgoto err_sq_wq;\n\t}\n\n\tfunc_to_io->rq_wq = devm_kcalloc(&pdev->dev, num_qps,\n\t\t\t\t\t sizeof(*func_to_io->rq_wq), GFP_KERNEL);\n\tif (!func_to_io->rq_wq) {\n\t\terr = -ENOMEM;\n\t\tgoto err_rq_wq;\n\t}\n\n\tfunc_to_io->sq_db = devm_kcalloc(&pdev->dev, num_qps,\n\t\t\t\t\t sizeof(*func_to_io->sq_db), GFP_KERNEL);\n\tif (!func_to_io->sq_db) {\n\t\terr = -ENOMEM;\n\t\tgoto err_sq_db;\n\t}\n\n\tci_addr_base = dma_alloc_coherent(&pdev->dev, CI_TABLE_SIZE(num_qps),\n\t\t\t\t\t  &func_to_io->ci_dma_base,\n\t\t\t\t\t  GFP_KERNEL);\n\tif (!ci_addr_base) {\n\t\tdev_err(&pdev->dev, \"Failed to allocate CI area\\n\");\n\t\terr = -ENOMEM;\n\t\tgoto err_ci_base;\n\t}\n\n\tfunc_to_io->ci_addr_base = ci_addr_base;\n\n\tfor (i = 0; i < num_qps; i++) {\n\t\terr = init_qp(func_to_io, &func_to_io->qps[i], i,\n\t\t\t      &sq_msix_entries[i], &rq_msix_entries[i]);\n\t\tif (err) {\n\t\t\tdev_err(&pdev->dev, \"Failed to create QP %d\\n\", i);\n\t\t\tgoto err_init_qp;\n\t\t}\n\t}\n\n\terr = write_qp_ctxts(func_to_io, base_qpn, num_qps);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to init QP ctxts\\n\");\n\t\tgoto err_write_qp_ctxts;\n\t}\n\n\terr = hinic_clean_qp_offload_ctxt(func_to_io);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to clean QP contexts space\\n\");\n\t\tgoto err_write_qp_ctxts;\n\t}\n\n\treturn 0;\n\nerr_write_qp_ctxts:\nerr_init_qp:\n\tfor (j = 0; j < i; j++)\n\t\tdestroy_qp(func_to_io, &func_to_io->qps[j]);\n\n\tdma_free_coherent(&pdev->dev, CI_TABLE_SIZE(num_qps),\n\t\t\t  func_to_io->ci_addr_base, func_to_io->ci_dma_base);\n\nerr_ci_base:\n\tdevm_kfree(&pdev->dev, func_to_io->sq_db);\n\nerr_sq_db:\n\tdevm_kfree(&pdev->dev, func_to_io->rq_wq);\n\nerr_rq_wq:\n\tdevm_kfree(&pdev->dev, func_to_io->sq_wq);\n\nerr_sq_wq:\n\tdevm_kfree(&pdev->dev, func_to_io->qps);\n\treturn err;\n}\n\n \nvoid hinic_io_destroy_qps(struct hinic_func_to_io *func_to_io, int num_qps)\n{\n\tstruct hinic_hwif *hwif = func_to_io->hwif;\n\tstruct pci_dev *pdev = hwif->pdev;\n\tsize_t ci_table_size;\n\tint i;\n\n\tci_table_size = CI_TABLE_SIZE(num_qps);\n\n\tfor (i = 0; i < num_qps; i++)\n\t\tdestroy_qp(func_to_io, &func_to_io->qps[i]);\n\n\tdma_free_coherent(&pdev->dev, ci_table_size, func_to_io->ci_addr_base,\n\t\t\t  func_to_io->ci_dma_base);\n\n\tdevm_kfree(&pdev->dev, func_to_io->sq_db);\n\n\tdevm_kfree(&pdev->dev, func_to_io->rq_wq);\n\tdevm_kfree(&pdev->dev, func_to_io->sq_wq);\n\n\tdevm_kfree(&pdev->dev, func_to_io->qps);\n}\n\nint hinic_set_wq_page_size(struct hinic_hwdev *hwdev, u16 func_idx,\n\t\t\t   u32 page_size)\n{\n\tstruct hinic_wq_page_size page_size_info = {0};\n\tu16 out_size = sizeof(page_size_info);\n\tstruct hinic_pfhwdev *pfhwdev;\n\tint err;\n\n\tpfhwdev = container_of(hwdev, struct hinic_pfhwdev, hwdev);\n\n\tpage_size_info.func_idx = func_idx;\n\tpage_size_info.ppf_idx = HINIC_HWIF_PPF_IDX(hwdev->hwif);\n\tpage_size_info.page_size = HINIC_PAGE_SIZE_HW(page_size);\n\n\terr = hinic_msg_to_mgmt(&pfhwdev->pf_to_mgmt, HINIC_MOD_COMM,\n\t\t\t\tHINIC_COMM_CMD_PAGESIZE_SET, &page_size_info,\n\t\t\t\tsizeof(page_size_info), &page_size_info,\n\t\t\t\t&out_size, HINIC_MGMT_MSG_SYNC);\n\tif (err || !out_size || page_size_info.status) {\n\t\tdev_err(&hwdev->hwif->pdev->dev, \"Failed to set wq page size, err: %d, status: 0x%x, out_size: 0x%0x\\n\",\n\t\t\terr, page_size_info.status, out_size);\n\t\treturn -EFAULT;\n\t}\n\n\treturn 0;\n}\n\n \nint hinic_io_init(struct hinic_func_to_io *func_to_io,\n\t\t  struct hinic_hwif *hwif, u16 max_qps, int num_ceqs,\n\t\t  struct msix_entry *ceq_msix_entries)\n{\n\tstruct pci_dev *pdev = hwif->pdev;\n\tenum hinic_cmdq_type cmdq, type;\n\tvoid __iomem *db_area;\n\tint err;\n\n\tfunc_to_io->hwif = hwif;\n\tfunc_to_io->qps = NULL;\n\tfunc_to_io->max_qps = max_qps;\n\tfunc_to_io->ceqs.hwdev = func_to_io->hwdev;\n\n\terr = hinic_ceqs_init(&func_to_io->ceqs, hwif, num_ceqs,\n\t\t\t      HINIC_DEFAULT_CEQ_LEN, HINIC_EQ_PAGE_SIZE,\n\t\t\t      ceq_msix_entries);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to init CEQs\\n\");\n\t\treturn err;\n\t}\n\n\terr = hinic_wqs_alloc(&func_to_io->wqs, 2 * max_qps, hwif);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to allocate WQS for IO\\n\");\n\t\tgoto err_wqs_alloc;\n\t}\n\n\tfunc_to_io->db_base = pci_ioremap_bar(pdev, HINIC_PCI_DB_BAR);\n\tif (!func_to_io->db_base) {\n\t\tdev_err(&pdev->dev, \"Failed to remap IO DB area\\n\");\n\t\terr = -ENOMEM;\n\t\tgoto err_db_ioremap;\n\t}\n\n\tinit_db_area_idx(&func_to_io->free_db_area);\n\n\tfor (cmdq = HINIC_CMDQ_SYNC; cmdq < HINIC_MAX_CMDQ_TYPES; cmdq++) {\n\t\tdb_area = get_db_area(func_to_io);\n\t\tif (IS_ERR(db_area)) {\n\t\t\tdev_err(&pdev->dev, \"Failed to get cmdq db area\\n\");\n\t\t\terr = PTR_ERR(db_area);\n\t\t\tgoto err_db_area;\n\t\t}\n\n\t\tfunc_to_io->cmdq_db_area[cmdq] = db_area;\n\t}\n\n\terr = hinic_set_wq_page_size(func_to_io->hwdev,\n\t\t\t\t     HINIC_HWIF_FUNC_IDX(hwif),\n\t\t\t\t     HINIC_DEFAULT_WQ_PAGE_SIZE);\n\tif (err) {\n\t\tdev_err(&func_to_io->hwif->pdev->dev, \"Failed to set wq page size\\n\");\n\t\tgoto init_wq_pg_size_err;\n\t}\n\n\terr = hinic_init_cmdqs(&func_to_io->cmdqs, hwif,\n\t\t\t       func_to_io->cmdq_db_area);\n\tif (err) {\n\t\tdev_err(&pdev->dev, \"Failed to initialize cmdqs\\n\");\n\t\tgoto err_init_cmdqs;\n\t}\n\n\treturn 0;\n\nerr_init_cmdqs:\n\tif (!HINIC_IS_VF(func_to_io->hwif))\n\t\thinic_set_wq_page_size(func_to_io->hwdev,\n\t\t\t\t       HINIC_HWIF_FUNC_IDX(hwif),\n\t\t\t\t       HINIC_HW_WQ_PAGE_SIZE);\ninit_wq_pg_size_err:\nerr_db_area:\n\tfor (type = HINIC_CMDQ_SYNC; type < cmdq; type++)\n\t\treturn_db_area(func_to_io, func_to_io->cmdq_db_area[type]);\n\n\tiounmap(func_to_io->db_base);\n\nerr_db_ioremap:\n\thinic_wqs_free(&func_to_io->wqs);\n\nerr_wqs_alloc:\n\thinic_ceqs_free(&func_to_io->ceqs);\n\treturn err;\n}\n\n \nvoid hinic_io_free(struct hinic_func_to_io *func_to_io)\n{\n\tenum hinic_cmdq_type cmdq;\n\n\thinic_free_cmdqs(&func_to_io->cmdqs);\n\n\tif (!HINIC_IS_VF(func_to_io->hwif))\n\t\thinic_set_wq_page_size(func_to_io->hwdev,\n\t\t\t\t       HINIC_HWIF_FUNC_IDX(func_to_io->hwif),\n\t\t\t\t       HINIC_HW_WQ_PAGE_SIZE);\n\n\tfor (cmdq = HINIC_CMDQ_SYNC; cmdq < HINIC_MAX_CMDQ_TYPES; cmdq++)\n\t\treturn_db_area(func_to_io, func_to_io->cmdq_db_area[cmdq]);\n\n\tiounmap(func_to_io->db_base);\n\thinic_wqs_free(&func_to_io->wqs);\n\thinic_ceqs_free(&func_to_io->ceqs);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}