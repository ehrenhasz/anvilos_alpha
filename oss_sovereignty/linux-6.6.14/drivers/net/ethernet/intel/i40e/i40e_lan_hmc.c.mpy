{
  "module_name": "i40e_lan_hmc.c",
  "hash_id": "f0f3b703d585f047bedb5c8d54a7781e45ca95ffdba6432787f72261be81d114",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/intel/i40e/i40e_lan_hmc.c",
  "human_readable_source": "\n \n\n#include \"i40e.h\"\n#include \"i40e_osdep.h\"\n#include \"i40e_register.h\"\n#include \"i40e_type.h\"\n#include \"i40e_hmc.h\"\n#include \"i40e_lan_hmc.h\"\n#include \"i40e_prototype.h\"\n\n \n\n \nstatic u64 i40e_align_l2obj_base(u64 offset)\n{\n\tu64 aligned_offset = offset;\n\n\tif ((offset % I40E_HMC_L2OBJ_BASE_ALIGNMENT) > 0)\n\t\taligned_offset += (I40E_HMC_L2OBJ_BASE_ALIGNMENT -\n\t\t\t\t   (offset % I40E_HMC_L2OBJ_BASE_ALIGNMENT));\n\n\treturn aligned_offset;\n}\n\n \nstatic u64 i40e_calculate_l2fpm_size(u32 txq_num, u32 rxq_num,\n\t\t\t      u32 fcoe_cntx_num, u32 fcoe_filt_num)\n{\n\tu64 fpm_size = 0;\n\n\tfpm_size = txq_num * I40E_HMC_OBJ_SIZE_TXQ;\n\tfpm_size = i40e_align_l2obj_base(fpm_size);\n\n\tfpm_size += (rxq_num * I40E_HMC_OBJ_SIZE_RXQ);\n\tfpm_size = i40e_align_l2obj_base(fpm_size);\n\n\tfpm_size += (fcoe_cntx_num * I40E_HMC_OBJ_SIZE_FCOE_CNTX);\n\tfpm_size = i40e_align_l2obj_base(fpm_size);\n\n\tfpm_size += (fcoe_filt_num * I40E_HMC_OBJ_SIZE_FCOE_FILT);\n\tfpm_size = i40e_align_l2obj_base(fpm_size);\n\n\treturn fpm_size;\n}\n\n \nint i40e_init_lan_hmc(struct i40e_hw *hw, u32 txq_num,\n\t\t      u32 rxq_num, u32 fcoe_cntx_num,\n\t\t      u32 fcoe_filt_num)\n{\n\tstruct i40e_hmc_obj_info *obj, *full_obj;\n\tint ret_code = 0;\n\tu64 l2fpm_size;\n\tu32 size_exp;\n\n\thw->hmc.signature = I40E_HMC_INFO_SIGNATURE;\n\thw->hmc.hmc_fn_id = hw->pf_id;\n\n\t \n\tret_code = i40e_allocate_virt_mem(hw, &hw->hmc.hmc_obj_virt_mem,\n\t\t\tsizeof(struct i40e_hmc_obj_info) * I40E_HMC_LAN_MAX);\n\tif (ret_code)\n\t\tgoto init_lan_hmc_out;\n\thw->hmc.hmc_obj = (struct i40e_hmc_obj_info *)\n\t\t\t  hw->hmc.hmc_obj_virt_mem.va;\n\n\t \n\tfull_obj = &hw->hmc.hmc_obj[I40E_HMC_LAN_FULL];\n\tfull_obj->max_cnt = 0;\n\tfull_obj->cnt = 0;\n\tfull_obj->base = 0;\n\tfull_obj->size = 0;\n\n\t \n\tobj = &hw->hmc.hmc_obj[I40E_HMC_LAN_TX];\n\tobj->max_cnt = rd32(hw, I40E_GLHMC_LANQMAX);\n\tobj->cnt = txq_num;\n\tobj->base = 0;\n\tsize_exp = rd32(hw, I40E_GLHMC_LANTXOBJSZ);\n\tobj->size = BIT_ULL(size_exp);\n\n\t \n\tif (txq_num > obj->max_cnt) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_init_lan_hmc: Tx context: asks for 0x%x but max allowed is 0x%x, returns error %d\\n\",\n\t\t\t  txq_num, obj->max_cnt, ret_code);\n\t\tgoto init_lan_hmc_out;\n\t}\n\n\t \n\tfull_obj->max_cnt += obj->max_cnt;\n\tfull_obj->cnt += obj->cnt;\n\n\t \n\tobj = &hw->hmc.hmc_obj[I40E_HMC_LAN_RX];\n\tobj->max_cnt = rd32(hw, I40E_GLHMC_LANQMAX);\n\tobj->cnt = rxq_num;\n\tobj->base = hw->hmc.hmc_obj[I40E_HMC_LAN_TX].base +\n\t\t    (hw->hmc.hmc_obj[I40E_HMC_LAN_TX].cnt *\n\t\t     hw->hmc.hmc_obj[I40E_HMC_LAN_TX].size);\n\tobj->base = i40e_align_l2obj_base(obj->base);\n\tsize_exp = rd32(hw, I40E_GLHMC_LANRXOBJSZ);\n\tobj->size = BIT_ULL(size_exp);\n\n\t \n\tif (rxq_num > obj->max_cnt) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_init_lan_hmc: Rx context: asks for 0x%x but max allowed is 0x%x, returns error %d\\n\",\n\t\t\t  rxq_num, obj->max_cnt, ret_code);\n\t\tgoto init_lan_hmc_out;\n\t}\n\n\t \n\tfull_obj->max_cnt += obj->max_cnt;\n\tfull_obj->cnt += obj->cnt;\n\n\t \n\tobj = &hw->hmc.hmc_obj[I40E_HMC_FCOE_CTX];\n\tobj->max_cnt = rd32(hw, I40E_GLHMC_FCOEMAX);\n\tobj->cnt = fcoe_cntx_num;\n\tobj->base = hw->hmc.hmc_obj[I40E_HMC_LAN_RX].base +\n\t\t    (hw->hmc.hmc_obj[I40E_HMC_LAN_RX].cnt *\n\t\t     hw->hmc.hmc_obj[I40E_HMC_LAN_RX].size);\n\tobj->base = i40e_align_l2obj_base(obj->base);\n\tsize_exp = rd32(hw, I40E_GLHMC_FCOEDDPOBJSZ);\n\tobj->size = BIT_ULL(size_exp);\n\n\t \n\tif (fcoe_cntx_num > obj->max_cnt) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_init_lan_hmc: FCoE context: asks for 0x%x but max allowed is 0x%x, returns error %d\\n\",\n\t\t\t  fcoe_cntx_num, obj->max_cnt, ret_code);\n\t\tgoto init_lan_hmc_out;\n\t}\n\n\t \n\tfull_obj->max_cnt += obj->max_cnt;\n\tfull_obj->cnt += obj->cnt;\n\n\t \n\tobj = &hw->hmc.hmc_obj[I40E_HMC_FCOE_FILT];\n\tobj->max_cnt = rd32(hw, I40E_GLHMC_FCOEFMAX);\n\tobj->cnt = fcoe_filt_num;\n\tobj->base = hw->hmc.hmc_obj[I40E_HMC_FCOE_CTX].base +\n\t\t    (hw->hmc.hmc_obj[I40E_HMC_FCOE_CTX].cnt *\n\t\t     hw->hmc.hmc_obj[I40E_HMC_FCOE_CTX].size);\n\tobj->base = i40e_align_l2obj_base(obj->base);\n\tsize_exp = rd32(hw, I40E_GLHMC_FCOEFOBJSZ);\n\tobj->size = BIT_ULL(size_exp);\n\n\t \n\tif (fcoe_filt_num > obj->max_cnt) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_init_lan_hmc: FCoE filter: asks for 0x%x but max allowed is 0x%x, returns error %d\\n\",\n\t\t\t  fcoe_filt_num, obj->max_cnt, ret_code);\n\t\tgoto init_lan_hmc_out;\n\t}\n\n\t \n\tfull_obj->max_cnt += obj->max_cnt;\n\tfull_obj->cnt += obj->cnt;\n\n\thw->hmc.first_sd_index = 0;\n\thw->hmc.sd_table.ref_cnt = 0;\n\tl2fpm_size = i40e_calculate_l2fpm_size(txq_num, rxq_num, fcoe_cntx_num,\n\t\t\t\t\t       fcoe_filt_num);\n\tif (NULL == hw->hmc.sd_table.sd_entry) {\n\t\thw->hmc.sd_table.sd_cnt = (u32)\n\t\t\t\t   (l2fpm_size + I40E_HMC_DIRECT_BP_SIZE - 1) /\n\t\t\t\t   I40E_HMC_DIRECT_BP_SIZE;\n\n\t\t \n\t\tret_code = i40e_allocate_virt_mem(hw, &hw->hmc.sd_table.addr,\n\t\t\t\t\t  (sizeof(struct i40e_hmc_sd_entry) *\n\t\t\t\t\t  hw->hmc.sd_table.sd_cnt));\n\t\tif (ret_code)\n\t\t\tgoto init_lan_hmc_out;\n\t\thw->hmc.sd_table.sd_entry =\n\t\t\t(struct i40e_hmc_sd_entry *)hw->hmc.sd_table.addr.va;\n\t}\n\t \n\tfull_obj->size = l2fpm_size;\n\ninit_lan_hmc_out:\n\treturn ret_code;\n}\n\n \nstatic int i40e_remove_pd_page(struct i40e_hw *hw,\n\t\t\t       struct i40e_hmc_info *hmc_info,\n\t\t\t       u32 idx)\n{\n\tint ret_code = 0;\n\n\tif (!i40e_prep_remove_pd_page(hmc_info, idx))\n\t\tret_code = i40e_remove_pd_page_new(hw, hmc_info, idx, true);\n\n\treturn ret_code;\n}\n\n \nstatic int i40e_remove_sd_bp(struct i40e_hw *hw,\n\t\t\t     struct i40e_hmc_info *hmc_info,\n\t\t\t     u32 idx)\n{\n\tint ret_code = 0;\n\n\tif (!i40e_prep_remove_sd_bp(hmc_info, idx))\n\t\tret_code = i40e_remove_sd_bp_new(hw, hmc_info, idx, true);\n\n\treturn ret_code;\n}\n\n \nstatic int i40e_create_lan_hmc_object(struct i40e_hw *hw,\n\t\t\t\t      struct i40e_hmc_lan_create_obj_info *info)\n{\n\tstruct i40e_hmc_sd_entry *sd_entry;\n\tu32 pd_idx1 = 0, pd_lmt1 = 0;\n\tu32 pd_idx = 0, pd_lmt = 0;\n\tbool pd_error = false;\n\tu32 sd_idx, sd_lmt;\n\tint ret_code = 0;\n\tu64 sd_size;\n\tu32 i, j;\n\n\tif (NULL == info) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_create_lan_hmc_object: bad info ptr\\n\");\n\t\tgoto exit;\n\t}\n\tif (NULL == info->hmc_info) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_create_lan_hmc_object: bad hmc_info ptr\\n\");\n\t\tgoto exit;\n\t}\n\tif (I40E_HMC_INFO_SIGNATURE != info->hmc_info->signature) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_create_lan_hmc_object: bad signature\\n\");\n\t\tgoto exit;\n\t}\n\n\tif (info->start_idx >= info->hmc_info->hmc_obj[info->rsrc_type].cnt) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_create_lan_hmc_object: returns error %d\\n\",\n\t\t\t  ret_code);\n\t\tgoto exit;\n\t}\n\tif ((info->start_idx + info->count) >\n\t    info->hmc_info->hmc_obj[info->rsrc_type].cnt) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_create_lan_hmc_object: returns error %d\\n\",\n\t\t\t  ret_code);\n\t\tgoto exit;\n\t}\n\n\t \n\tI40E_FIND_SD_INDEX_LIMIT(info->hmc_info, info->rsrc_type,\n\t\t\t\t info->start_idx, info->count,\n\t\t\t\t &sd_idx, &sd_lmt);\n\tif (sd_idx >= info->hmc_info->sd_table.sd_cnt ||\n\t    sd_lmt > info->hmc_info->sd_table.sd_cnt) {\n\t\tret_code = -EINVAL;\n\t\tgoto exit;\n\t}\n\t \n\tI40E_FIND_PD_INDEX_LIMIT(info->hmc_info, info->rsrc_type,\n\t\t\t\t info->start_idx, info->count, &pd_idx,\n\t\t\t\t &pd_lmt);\n\n\t \n\tif (info->direct_mode_sz == 0)\n\t\tsd_size = I40E_HMC_DIRECT_BP_SIZE;\n\telse\n\t\tsd_size = info->direct_mode_sz;\n\n\t \n\tfor (j = sd_idx; j < sd_lmt; j++) {\n\t\t \n\t\tret_code = i40e_add_sd_table_entry(hw, info->hmc_info, j,\n\t\t\t\t\t\t   info->entry_type,\n\t\t\t\t\t\t   sd_size);\n\t\tif (ret_code)\n\t\t\tgoto exit_sd_error;\n\t\tsd_entry = &info->hmc_info->sd_table.sd_entry[j];\n\t\tif (I40E_SD_TYPE_PAGED == sd_entry->entry_type) {\n\t\t\t \n\n\t\t\t \n\t\t\tpd_idx1 = max(pd_idx, (j * I40E_HMC_MAX_BP_COUNT));\n\t\t\tpd_lmt1 = min(pd_lmt,\n\t\t\t\t      ((j + 1) * I40E_HMC_MAX_BP_COUNT));\n\t\t\tfor (i = pd_idx1; i < pd_lmt1; i++) {\n\t\t\t\t \n\t\t\t\tret_code = i40e_add_pd_table_entry(hw,\n\t\t\t\t\t\t\t\tinfo->hmc_info,\n\t\t\t\t\t\t\t\ti, NULL);\n\t\t\t\tif (ret_code) {\n\t\t\t\t\tpd_error = true;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (pd_error) {\n\t\t\t\t \n\t\t\t\twhile (i && (i > pd_idx1)) {\n\t\t\t\t\ti40e_remove_pd_bp(hw, info->hmc_info,\n\t\t\t\t\t\t\t  (i - 1));\n\t\t\t\t\ti--;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\tif (!sd_entry->valid) {\n\t\t\tsd_entry->valid = true;\n\t\t\tswitch (sd_entry->entry_type) {\n\t\t\tcase I40E_SD_TYPE_PAGED:\n\t\t\t\tI40E_SET_PF_SD_ENTRY(hw,\n\t\t\t\t\tsd_entry->u.pd_table.pd_page_addr.pa,\n\t\t\t\t\tj, sd_entry->entry_type);\n\t\t\t\tbreak;\n\t\t\tcase I40E_SD_TYPE_DIRECT:\n\t\t\t\tI40E_SET_PF_SD_ENTRY(hw, sd_entry->u.bp.addr.pa,\n\t\t\t\t\t\t     j, sd_entry->entry_type);\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tret_code = -EINVAL;\n\t\t\t\tgoto exit;\n\t\t\t}\n\t\t}\n\t}\n\tgoto exit;\n\nexit_sd_error:\n\t \n\twhile (j && (j > sd_idx)) {\n\t\tsd_entry = &info->hmc_info->sd_table.sd_entry[j - 1];\n\t\tswitch (sd_entry->entry_type) {\n\t\tcase I40E_SD_TYPE_PAGED:\n\t\t\tpd_idx1 = max(pd_idx,\n\t\t\t\t      ((j - 1) * I40E_HMC_MAX_BP_COUNT));\n\t\t\tpd_lmt1 = min(pd_lmt, (j * I40E_HMC_MAX_BP_COUNT));\n\t\t\tfor (i = pd_idx1; i < pd_lmt1; i++)\n\t\t\t\ti40e_remove_pd_bp(hw, info->hmc_info, i);\n\t\t\ti40e_remove_pd_page(hw, info->hmc_info, (j - 1));\n\t\t\tbreak;\n\t\tcase I40E_SD_TYPE_DIRECT:\n\t\t\ti40e_remove_sd_bp(hw, info->hmc_info, (j - 1));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tret_code = -EINVAL;\n\t\t\tbreak;\n\t\t}\n\t\tj--;\n\t}\nexit:\n\treturn ret_code;\n}\n\n \nint i40e_configure_lan_hmc(struct i40e_hw *hw,\n\t\t\t   enum i40e_hmc_model model)\n{\n\tstruct i40e_hmc_lan_create_obj_info info;\n\tu8 hmc_fn_id = hw->hmc.hmc_fn_id;\n\tstruct i40e_hmc_obj_info *obj;\n\tint ret_code = 0;\n\n\t \n\tinfo.hmc_info = &hw->hmc;\n\tinfo.rsrc_type = I40E_HMC_LAN_FULL;\n\tinfo.start_idx = 0;\n\tinfo.direct_mode_sz = hw->hmc.hmc_obj[I40E_HMC_LAN_FULL].size;\n\n\t \n\tswitch (model) {\n\tcase I40E_HMC_MODEL_DIRECT_PREFERRED:\n\tcase I40E_HMC_MODEL_DIRECT_ONLY:\n\t\tinfo.entry_type = I40E_SD_TYPE_DIRECT;\n\t\t \n\t\tinfo.count = 1;\n\t\tret_code = i40e_create_lan_hmc_object(hw, &info);\n\t\tif (ret_code && (model == I40E_HMC_MODEL_DIRECT_PREFERRED))\n\t\t\tgoto try_type_paged;\n\t\telse if (ret_code)\n\t\t\tgoto configure_lan_hmc_out;\n\t\t \n\t\tbreak;\n\tcase I40E_HMC_MODEL_PAGED_ONLY:\ntry_type_paged:\n\t\tinfo.entry_type = I40E_SD_TYPE_PAGED;\n\t\t \n\t\tinfo.count = 1;\n\t\tret_code = i40e_create_lan_hmc_object(hw, &info);\n\t\tif (ret_code)\n\t\t\tgoto configure_lan_hmc_out;\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_configure_lan_hmc: Unknown SD type: %d\\n\",\n\t\t\t  ret_code);\n\t\tgoto configure_lan_hmc_out;\n\t}\n\n\t \n\n\t \n\tobj = &hw->hmc.hmc_obj[I40E_HMC_LAN_TX];\n\twr32(hw, I40E_GLHMC_LANTXBASE(hmc_fn_id),\n\t     (u32)((obj->base & I40E_GLHMC_LANTXBASE_FPMLANTXBASE_MASK) / 512));\n\twr32(hw, I40E_GLHMC_LANTXCNT(hmc_fn_id), obj->cnt);\n\n\t \n\tobj = &hw->hmc.hmc_obj[I40E_HMC_LAN_RX];\n\twr32(hw, I40E_GLHMC_LANRXBASE(hmc_fn_id),\n\t     (u32)((obj->base & I40E_GLHMC_LANRXBASE_FPMLANRXBASE_MASK) / 512));\n\twr32(hw, I40E_GLHMC_LANRXCNT(hmc_fn_id), obj->cnt);\n\n\t \n\tobj = &hw->hmc.hmc_obj[I40E_HMC_FCOE_CTX];\n\twr32(hw, I40E_GLHMC_FCOEDDPBASE(hmc_fn_id),\n\t (u32)((obj->base & I40E_GLHMC_FCOEDDPBASE_FPMFCOEDDPBASE_MASK) / 512));\n\twr32(hw, I40E_GLHMC_FCOEDDPCNT(hmc_fn_id), obj->cnt);\n\n\t \n\tobj = &hw->hmc.hmc_obj[I40E_HMC_FCOE_FILT];\n\twr32(hw, I40E_GLHMC_FCOEFBASE(hmc_fn_id),\n\t     (u32)((obj->base & I40E_GLHMC_FCOEFBASE_FPMFCOEFBASE_MASK) / 512));\n\twr32(hw, I40E_GLHMC_FCOEFCNT(hmc_fn_id), obj->cnt);\n\nconfigure_lan_hmc_out:\n\treturn ret_code;\n}\n\n \nstatic int i40e_delete_lan_hmc_object(struct i40e_hw *hw,\n\t\t\t\t      struct i40e_hmc_lan_delete_obj_info *info)\n{\n\tstruct i40e_hmc_pd_table *pd_table;\n\tu32 pd_idx, pd_lmt, rel_pd_idx;\n\tu32 sd_idx, sd_lmt;\n\tint ret_code = 0;\n\tu32 i, j;\n\n\tif (NULL == info) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_delete_hmc_object: bad info ptr\\n\");\n\t\tgoto exit;\n\t}\n\tif (NULL == info->hmc_info) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_delete_hmc_object: bad info->hmc_info ptr\\n\");\n\t\tgoto exit;\n\t}\n\tif (I40E_HMC_INFO_SIGNATURE != info->hmc_info->signature) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_delete_hmc_object: bad hmc_info->signature\\n\");\n\t\tgoto exit;\n\t}\n\n\tif (NULL == info->hmc_info->sd_table.sd_entry) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_delete_hmc_object: bad sd_entry\\n\");\n\t\tgoto exit;\n\t}\n\n\tif (NULL == info->hmc_info->hmc_obj) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_delete_hmc_object: bad hmc_info->hmc_obj\\n\");\n\t\tgoto exit;\n\t}\n\tif (info->start_idx >= info->hmc_info->hmc_obj[info->rsrc_type].cnt) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_delete_hmc_object: returns error %d\\n\",\n\t\t\t  ret_code);\n\t\tgoto exit;\n\t}\n\n\tif ((info->start_idx + info->count) >\n\t    info->hmc_info->hmc_obj[info->rsrc_type].cnt) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_delete_hmc_object: returns error %d\\n\",\n\t\t\t  ret_code);\n\t\tgoto exit;\n\t}\n\n\tI40E_FIND_PD_INDEX_LIMIT(info->hmc_info, info->rsrc_type,\n\t\t\t\t info->start_idx, info->count, &pd_idx,\n\t\t\t\t &pd_lmt);\n\n\tfor (j = pd_idx; j < pd_lmt; j++) {\n\t\tsd_idx = j / I40E_HMC_PD_CNT_IN_SD;\n\n\t\tif (I40E_SD_TYPE_PAGED !=\n\t\t    info->hmc_info->sd_table.sd_entry[sd_idx].entry_type)\n\t\t\tcontinue;\n\n\t\trel_pd_idx = j % I40E_HMC_PD_CNT_IN_SD;\n\n\t\tpd_table =\n\t\t\t&info->hmc_info->sd_table.sd_entry[sd_idx].u.pd_table;\n\t\tif (pd_table->pd_entry[rel_pd_idx].valid) {\n\t\t\tret_code = i40e_remove_pd_bp(hw, info->hmc_info, j);\n\t\t\tif (ret_code)\n\t\t\t\tgoto exit;\n\t\t}\n\t}\n\n\t \n\tI40E_FIND_SD_INDEX_LIMIT(info->hmc_info, info->rsrc_type,\n\t\t\t\t info->start_idx, info->count,\n\t\t\t\t &sd_idx, &sd_lmt);\n\tif (sd_idx >= info->hmc_info->sd_table.sd_cnt ||\n\t    sd_lmt > info->hmc_info->sd_table.sd_cnt) {\n\t\tret_code = -EINVAL;\n\t\tgoto exit;\n\t}\n\n\tfor (i = sd_idx; i < sd_lmt; i++) {\n\t\tif (!info->hmc_info->sd_table.sd_entry[i].valid)\n\t\t\tcontinue;\n\t\tswitch (info->hmc_info->sd_table.sd_entry[i].entry_type) {\n\t\tcase I40E_SD_TYPE_DIRECT:\n\t\t\tret_code = i40e_remove_sd_bp(hw, info->hmc_info, i);\n\t\t\tif (ret_code)\n\t\t\t\tgoto exit;\n\t\t\tbreak;\n\t\tcase I40E_SD_TYPE_PAGED:\n\t\t\tret_code = i40e_remove_pd_page(hw, info->hmc_info, i);\n\t\t\tif (ret_code)\n\t\t\t\tgoto exit;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\nexit:\n\treturn ret_code;\n}\n\n \nint i40e_shutdown_lan_hmc(struct i40e_hw *hw)\n{\n\tstruct i40e_hmc_lan_delete_obj_info info;\n\tint ret_code;\n\n\tinfo.hmc_info = &hw->hmc;\n\tinfo.rsrc_type = I40E_HMC_LAN_FULL;\n\tinfo.start_idx = 0;\n\tinfo.count = 1;\n\n\t \n\tret_code = i40e_delete_lan_hmc_object(hw, &info);\n\n\t \n\ti40e_free_virt_mem(hw, &hw->hmc.sd_table.addr);\n\thw->hmc.sd_table.sd_cnt = 0;\n\thw->hmc.sd_table.sd_entry = NULL;\n\n\t \n\ti40e_free_virt_mem(hw, &hw->hmc.hmc_obj_virt_mem);\n\thw->hmc.hmc_obj = NULL;\n\n\treturn ret_code;\n}\n\n#define I40E_HMC_STORE(_struct, _ele)\t\t\\\n\toffsetof(struct _struct, _ele),\t\t\\\n\tsizeof_field(struct _struct, _ele)\n\nstruct i40e_context_ele {\n\tu16 offset;\n\tu16 size_of;\n\tu16 width;\n\tu16 lsb;\n};\n\n \nstatic struct i40e_context_ele i40e_hmc_txq_ce_info[] = {\n\t\t\t\t\t      \n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, head),           13,      0 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, new_context),     1,     30 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, base),           57,     32 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, fc_ena),          1,     89 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, timesync_ena),    1,     90 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, fd_ena),          1,     91 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, alt_vlan_ena),    1,     92 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, cpuid),           8,     96 },\n \n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, thead_wb),       13,  0 + 128 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, head_wb_ena),     1, 32 + 128 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, qlen),           13, 33 + 128 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, tphrdesc_ena),    1, 46 + 128 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, tphrpacket_ena),  1, 47 + 128 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, tphwdesc_ena),    1, 48 + 128 },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, head_wb_addr),   64, 64 + 128 },\n \n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, crc),            32,  0 + (7 * 128) },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, rdylist),        10, 84 + (7 * 128) },\n\t{I40E_HMC_STORE(i40e_hmc_obj_txq, rdylist_act),     1, 94 + (7 * 128) },\n\t{ 0 }\n};\n\n \nstatic struct i40e_context_ele i40e_hmc_rxq_ce_info[] = {\n\t\t\t\t\t  \n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, head),        13,\t0   },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, cpuid),        8,\t13  },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, base),        57,\t32  },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, qlen),        13,\t89  },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, dbuff),        7,\t102 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, hbuff),        5,\t109 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, dtype),        2,\t114 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, dsize),        1,\t116 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, crcstrip),     1,\t117 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, fc_ena),       1,\t118 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, l2tsel),       1,\t119 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, hsplit_0),     4,\t120 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, hsplit_1),     2,\t124 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, showiv),       1,\t127 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, rxmax),       14,\t174 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, tphrdesc_ena), 1,\t193 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, tphwdesc_ena), 1,\t194 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, tphdata_ena),  1,\t195 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, tphhead_ena),  1,\t196 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, lrxqthresh),   3,\t198 },\n\t{ I40E_HMC_STORE(i40e_hmc_obj_rxq, prefena),      1,\t201 },\n\t{ 0 }\n};\n\n \nstatic void i40e_write_byte(u8 *hmc_bits,\n\t\t\t    struct i40e_context_ele *ce_info,\n\t\t\t    u8 *src)\n{\n\tu8 src_byte, dest_byte, mask;\n\tu8 *from, *dest;\n\tu16 shift_width;\n\n\t \n\tfrom = src + ce_info->offset;\n\n\t \n\tshift_width = ce_info->lsb % 8;\n\tmask = (u8)(BIT(ce_info->width) - 1);\n\n\tsrc_byte = *from;\n\tsrc_byte &= mask;\n\n\t \n\tmask <<= shift_width;\n\tsrc_byte <<= shift_width;\n\n\t \n\tdest = hmc_bits + (ce_info->lsb / 8);\n\n\tmemcpy(&dest_byte, dest, sizeof(dest_byte));\n\n\tdest_byte &= ~mask;\t \n\tdest_byte |= src_byte;\t \n\n\t \n\tmemcpy(dest, &dest_byte, sizeof(dest_byte));\n}\n\n \nstatic void i40e_write_word(u8 *hmc_bits,\n\t\t\t    struct i40e_context_ele *ce_info,\n\t\t\t    u8 *src)\n{\n\tu16 src_word, mask;\n\tu8 *from, *dest;\n\tu16 shift_width;\n\t__le16 dest_word;\n\n\t \n\tfrom = src + ce_info->offset;\n\n\t \n\tshift_width = ce_info->lsb % 8;\n\tmask = BIT(ce_info->width) - 1;\n\n\t \n\tsrc_word = *(u16 *)from;\n\tsrc_word &= mask;\n\n\t \n\tmask <<= shift_width;\n\tsrc_word <<= shift_width;\n\n\t \n\tdest = hmc_bits + (ce_info->lsb / 8);\n\n\tmemcpy(&dest_word, dest, sizeof(dest_word));\n\n\tdest_word &= ~(cpu_to_le16(mask));\t \n\tdest_word |= cpu_to_le16(src_word);\t \n\n\t \n\tmemcpy(dest, &dest_word, sizeof(dest_word));\n}\n\n \nstatic void i40e_write_dword(u8 *hmc_bits,\n\t\t\t     struct i40e_context_ele *ce_info,\n\t\t\t     u8 *src)\n{\n\tu32 src_dword, mask;\n\tu8 *from, *dest;\n\tu16 shift_width;\n\t__le32 dest_dword;\n\n\t \n\tfrom = src + ce_info->offset;\n\n\t \n\tshift_width = ce_info->lsb % 8;\n\n\t \n\tif (ce_info->width < 32)\n\t\tmask = BIT(ce_info->width) - 1;\n\telse\n\t\tmask = ~(u32)0;\n\n\t \n\tsrc_dword = *(u32 *)from;\n\tsrc_dword &= mask;\n\n\t \n\tmask <<= shift_width;\n\tsrc_dword <<= shift_width;\n\n\t \n\tdest = hmc_bits + (ce_info->lsb / 8);\n\n\tmemcpy(&dest_dword, dest, sizeof(dest_dword));\n\n\tdest_dword &= ~(cpu_to_le32(mask));\t \n\tdest_dword |= cpu_to_le32(src_dword);\t \n\n\t \n\tmemcpy(dest, &dest_dword, sizeof(dest_dword));\n}\n\n \nstatic void i40e_write_qword(u8 *hmc_bits,\n\t\t\t     struct i40e_context_ele *ce_info,\n\t\t\t     u8 *src)\n{\n\tu64 src_qword, mask;\n\tu8 *from, *dest;\n\tu16 shift_width;\n\t__le64 dest_qword;\n\n\t \n\tfrom = src + ce_info->offset;\n\n\t \n\tshift_width = ce_info->lsb % 8;\n\n\t \n\tif (ce_info->width < 64)\n\t\tmask = BIT_ULL(ce_info->width) - 1;\n\telse\n\t\tmask = ~(u64)0;\n\n\t \n\tsrc_qword = *(u64 *)from;\n\tsrc_qword &= mask;\n\n\t \n\tmask <<= shift_width;\n\tsrc_qword <<= shift_width;\n\n\t \n\tdest = hmc_bits + (ce_info->lsb / 8);\n\n\tmemcpy(&dest_qword, dest, sizeof(dest_qword));\n\n\tdest_qword &= ~(cpu_to_le64(mask));\t \n\tdest_qword |= cpu_to_le64(src_qword);\t \n\n\t \n\tmemcpy(dest, &dest_qword, sizeof(dest_qword));\n}\n\n \nstatic int i40e_clear_hmc_context(struct i40e_hw *hw,\n\t\t\t\t  u8 *context_bytes,\n\t\t\t\t  enum i40e_hmc_lan_rsrc_type hmc_type)\n{\n\t \n\tmemset(context_bytes, 0, (u32)hw->hmc.hmc_obj[hmc_type].size);\n\n\treturn 0;\n}\n\n \nstatic int i40e_set_hmc_context(u8 *context_bytes,\n\t\t\t\tstruct i40e_context_ele *ce_info,\n\t\t\t\tu8 *dest)\n{\n\tint f;\n\n\tfor (f = 0; ce_info[f].width != 0; f++) {\n\n\t\t \n\t\tswitch (ce_info[f].size_of) {\n\t\tcase 1:\n\t\t\ti40e_write_byte(context_bytes, &ce_info[f], dest);\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\ti40e_write_word(context_bytes, &ce_info[f], dest);\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\ti40e_write_dword(context_bytes, &ce_info[f], dest);\n\t\t\tbreak;\n\t\tcase 8:\n\t\t\ti40e_write_qword(context_bytes, &ce_info[f], dest);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n \nstatic\nint i40e_hmc_get_object_va(struct i40e_hw *hw, u8 **object_base,\n\t\t\t   enum i40e_hmc_lan_rsrc_type rsrc_type,\n\t\t\t   u32 obj_idx)\n{\n\tstruct i40e_hmc_info *hmc_info = &hw->hmc;\n\tu32 obj_offset_in_sd, obj_offset_in_pd;\n\tstruct i40e_hmc_sd_entry *sd_entry;\n\tstruct i40e_hmc_pd_entry *pd_entry;\n\tu32 pd_idx, pd_lmt, rel_pd_idx;\n\tu64 obj_offset_in_fpm;\n\tu32 sd_idx, sd_lmt;\n\tint ret_code = 0;\n\n\tif (NULL == hmc_info) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_hmc_get_object_va: bad hmc_info ptr\\n\");\n\t\tgoto exit;\n\t}\n\tif (NULL == hmc_info->hmc_obj) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_hmc_get_object_va: bad hmc_info->hmc_obj ptr\\n\");\n\t\tgoto exit;\n\t}\n\tif (NULL == object_base) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_hmc_get_object_va: bad object_base ptr\\n\");\n\t\tgoto exit;\n\t}\n\tif (I40E_HMC_INFO_SIGNATURE != hmc_info->signature) {\n\t\tret_code = -EINVAL;\n\t\thw_dbg(hw, \"i40e_hmc_get_object_va: bad hmc_info->signature\\n\");\n\t\tgoto exit;\n\t}\n\tif (obj_idx >= hmc_info->hmc_obj[rsrc_type].cnt) {\n\t\thw_dbg(hw, \"i40e_hmc_get_object_va: returns error %d\\n\",\n\t\t\t  ret_code);\n\t\tret_code = -EINVAL;\n\t\tgoto exit;\n\t}\n\t \n\tI40E_FIND_SD_INDEX_LIMIT(hmc_info, rsrc_type, obj_idx, 1,\n\t\t\t\t &sd_idx, &sd_lmt);\n\n\tsd_entry = &hmc_info->sd_table.sd_entry[sd_idx];\n\tobj_offset_in_fpm = hmc_info->hmc_obj[rsrc_type].base +\n\t\t\t    hmc_info->hmc_obj[rsrc_type].size * obj_idx;\n\n\tif (I40E_SD_TYPE_PAGED == sd_entry->entry_type) {\n\t\tI40E_FIND_PD_INDEX_LIMIT(hmc_info, rsrc_type, obj_idx, 1,\n\t\t\t\t\t &pd_idx, &pd_lmt);\n\t\trel_pd_idx = pd_idx % I40E_HMC_PD_CNT_IN_SD;\n\t\tpd_entry = &sd_entry->u.pd_table.pd_entry[rel_pd_idx];\n\t\tobj_offset_in_pd = (u32)(obj_offset_in_fpm %\n\t\t\t\t\t I40E_HMC_PAGED_BP_SIZE);\n\t\t*object_base = (u8 *)pd_entry->bp.addr.va + obj_offset_in_pd;\n\t} else {\n\t\tobj_offset_in_sd = (u32)(obj_offset_in_fpm %\n\t\t\t\t\t I40E_HMC_DIRECT_BP_SIZE);\n\t\t*object_base = (u8 *)sd_entry->u.bp.addr.va + obj_offset_in_sd;\n\t}\nexit:\n\treturn ret_code;\n}\n\n \nint i40e_clear_lan_tx_queue_context(struct i40e_hw *hw,\n\t\t\t\t    u16 queue)\n{\n\tu8 *context_bytes;\n\tint err;\n\n\terr = i40e_hmc_get_object_va(hw, &context_bytes,\n\t\t\t\t     I40E_HMC_LAN_TX, queue);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn i40e_clear_hmc_context(hw, context_bytes, I40E_HMC_LAN_TX);\n}\n\n \nint i40e_set_lan_tx_queue_context(struct i40e_hw *hw,\n\t\t\t\t  u16 queue,\n\t\t\t\t  struct i40e_hmc_obj_txq *s)\n{\n\tu8 *context_bytes;\n\tint err;\n\n\terr = i40e_hmc_get_object_va(hw, &context_bytes,\n\t\t\t\t     I40E_HMC_LAN_TX, queue);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn i40e_set_hmc_context(context_bytes,\n\t\t\t\t    i40e_hmc_txq_ce_info, (u8 *)s);\n}\n\n \nint i40e_clear_lan_rx_queue_context(struct i40e_hw *hw,\n\t\t\t\t    u16 queue)\n{\n\tu8 *context_bytes;\n\tint err;\n\n\terr = i40e_hmc_get_object_va(hw, &context_bytes,\n\t\t\t\t     I40E_HMC_LAN_RX, queue);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn i40e_clear_hmc_context(hw, context_bytes, I40E_HMC_LAN_RX);\n}\n\n \nint i40e_set_lan_rx_queue_context(struct i40e_hw *hw,\n\t\t\t\t  u16 queue,\n\t\t\t\t  struct i40e_hmc_obj_rxq *s)\n{\n\tu8 *context_bytes;\n\tint err;\n\n\terr = i40e_hmc_get_object_va(hw, &context_bytes,\n\t\t\t\t     I40E_HMC_LAN_RX, queue);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn i40e_set_hmc_context(context_bytes,\n\t\t\t\t    i40e_hmc_rxq_ce_info, (u8 *)s);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}