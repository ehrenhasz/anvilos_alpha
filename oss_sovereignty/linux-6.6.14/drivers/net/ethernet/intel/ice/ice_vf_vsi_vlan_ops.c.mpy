{
  "module_name": "ice_vf_vsi_vlan_ops.c",
  "hash_id": "afbe4a58588b2b20d5141987e1cd92f4cc4dc837a2eb83d0c57d8174e078f34c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/intel/ice/ice_vf_vsi_vlan_ops.c",
  "human_readable_source": "\n \n\n#include \"ice_vsi_vlan_ops.h\"\n#include \"ice_vsi_vlan_lib.h\"\n#include \"ice_vlan_mode.h\"\n#include \"ice.h\"\n#include \"ice_vf_vsi_vlan_ops.h\"\n#include \"ice_sriov.h\"\n\nstatic int\nnoop_vlan_arg(struct ice_vsi __always_unused *vsi,\n\t      struct ice_vlan __always_unused *vlan)\n{\n\treturn 0;\n}\n\nstatic int\nnoop_vlan(struct ice_vsi __always_unused *vsi)\n{\n\treturn 0;\n}\n\nstatic void ice_port_vlan_on(struct ice_vsi *vsi)\n{\n\tstruct ice_vsi_vlan_ops *vlan_ops;\n\tstruct ice_pf *pf = vsi->back;\n\n\tif (ice_is_dvm_ena(&pf->hw)) {\n\t\tvlan_ops = &vsi->outer_vlan_ops;\n\n\t\t \n\t\tvlan_ops->set_port_vlan = ice_vsi_set_outer_port_vlan;\n\t\tvlan_ops->clear_port_vlan = ice_vsi_clear_outer_port_vlan;\n\n\t\t \n\t\tvlan_ops = &vsi->inner_vlan_ops;\n\t\tvlan_ops->add_vlan = noop_vlan_arg;\n\t\tvlan_ops->del_vlan = noop_vlan_arg;\n\t\tvlan_ops->ena_stripping = ice_vsi_ena_inner_stripping;\n\t\tvlan_ops->dis_stripping = ice_vsi_dis_inner_stripping;\n\t\tvlan_ops->ena_insertion = ice_vsi_ena_inner_insertion;\n\t\tvlan_ops->dis_insertion = ice_vsi_dis_inner_insertion;\n\t} else {\n\t\tvlan_ops = &vsi->inner_vlan_ops;\n\n\t\tvlan_ops->set_port_vlan = ice_vsi_set_inner_port_vlan;\n\t\tvlan_ops->clear_port_vlan = ice_vsi_clear_inner_port_vlan;\n\t}\n\n\t \n\tvlan_ops->dis_rx_filtering = noop_vlan;\n\n\tvlan_ops->ena_rx_filtering = ice_vsi_ena_rx_vlan_filtering;\n}\n\nstatic void ice_port_vlan_off(struct ice_vsi *vsi)\n{\n\tstruct ice_vsi_vlan_ops *vlan_ops;\n\tstruct ice_pf *pf = vsi->back;\n\n\t \n\tvlan_ops = &vsi->inner_vlan_ops;\n\n\tvlan_ops->ena_stripping = ice_vsi_ena_inner_stripping;\n\tvlan_ops->dis_stripping = ice_vsi_dis_inner_stripping;\n\tvlan_ops->ena_insertion = ice_vsi_ena_inner_insertion;\n\tvlan_ops->dis_insertion = ice_vsi_dis_inner_insertion;\n\n\tif (ice_is_dvm_ena(&pf->hw)) {\n\t\tvlan_ops = &vsi->outer_vlan_ops;\n\n\t\tvlan_ops->del_vlan = ice_vsi_del_vlan;\n\t\tvlan_ops->ena_stripping = ice_vsi_ena_outer_stripping;\n\t\tvlan_ops->dis_stripping = ice_vsi_dis_outer_stripping;\n\t\tvlan_ops->ena_insertion = ice_vsi_ena_outer_insertion;\n\t\tvlan_ops->dis_insertion = ice_vsi_dis_outer_insertion;\n\t} else {\n\t\tvlan_ops->del_vlan = ice_vsi_del_vlan;\n\t}\n\n\tvlan_ops->dis_rx_filtering = ice_vsi_dis_rx_vlan_filtering;\n\n\tif (!test_bit(ICE_FLAG_VF_VLAN_PRUNING, pf->flags))\n\t\tvlan_ops->ena_rx_filtering = noop_vlan;\n\telse\n\t\tvlan_ops->ena_rx_filtering =\n\t\t\tice_vsi_ena_rx_vlan_filtering;\n}\n\n \nvoid ice_vf_vsi_enable_port_vlan(struct ice_vsi *vsi)\n{\n\tif (WARN_ON_ONCE(!vsi->vf))\n\t\treturn;\n\n\tice_port_vlan_on(vsi);\n}\n\n \nvoid ice_vf_vsi_disable_port_vlan(struct ice_vsi *vsi)\n{\n\tif (WARN_ON_ONCE(!vsi->vf))\n\t\treturn;\n\n\tice_port_vlan_off(vsi);\n}\n\n \nvoid ice_vf_vsi_init_vlan_ops(struct ice_vsi *vsi)\n{\n\tstruct ice_vsi_vlan_ops *vlan_ops;\n\tstruct ice_pf *pf = vsi->back;\n\tstruct ice_vf *vf = vsi->vf;\n\n\tif (WARN_ON(!vf))\n\t\treturn;\n\n\tif (ice_vf_is_port_vlan_ena(vf))\n\t\tice_port_vlan_on(vsi);\n\telse\n\t\tice_port_vlan_off(vsi);\n\n\tvlan_ops = ice_is_dvm_ena(&pf->hw) ?\n\t\t&vsi->outer_vlan_ops : &vsi->inner_vlan_ops;\n\n\tvlan_ops->add_vlan = ice_vsi_add_vlan;\n\tvlan_ops->ena_tx_filtering = ice_vsi_ena_tx_vlan_filtering;\n\tvlan_ops->dis_tx_filtering = ice_vsi_dis_tx_vlan_filtering;\n}\n\n \nvoid ice_vf_vsi_cfg_dvm_legacy_vlan_mode(struct ice_vsi *vsi)\n{\n\tstruct ice_vsi_vlan_ops *vlan_ops;\n\tstruct ice_vf *vf = vsi->vf;\n\tstruct device *dev;\n\n\tif (WARN_ON(!vf))\n\t\treturn;\n\n\tdev = ice_pf_to_dev(vf->pf);\n\n\tif (!ice_is_dvm_ena(&vsi->back->hw) || ice_vf_is_port_vlan_ena(vf))\n\t\treturn;\n\n\tvlan_ops = &vsi->outer_vlan_ops;\n\n\t \n\tvlan_ops->dis_rx_filtering = ice_vsi_dis_rx_vlan_filtering;\n\t \n\tvlan_ops->ena_rx_filtering = noop_vlan;\n\n\t \n\tvlan_ops->dis_tx_filtering = ice_vsi_dis_tx_vlan_filtering;\n\t \n\tvlan_ops->ena_tx_filtering = noop_vlan;\n\n\tif (vlan_ops->dis_rx_filtering(vsi))\n\t\tdev_dbg(dev, \"Failed to disable Rx VLAN filtering for old VF without VIRTCHNL_VF_OFFLOAD_VLAN_V2 support\\n\");\n\tif (vlan_ops->dis_tx_filtering(vsi))\n\t\tdev_dbg(dev, \"Failed to disable Tx VLAN filtering for old VF without VIRTHCNL_VF_OFFLOAD_VLAN_V2 support\\n\");\n\n\t \n\tvlan_ops->dis_stripping = ice_vsi_dis_outer_stripping;\n\tvlan_ops->dis_insertion = ice_vsi_dis_outer_insertion;\n\n\tif (vlan_ops->dis_stripping(vsi))\n\t\tdev_dbg(dev, \"Failed to disable outer VLAN stripping for old VF without VIRTCHNL_VF_OFFLOAD_VLAN_V2 support\\n\");\n\n\tif (vlan_ops->dis_insertion(vsi))\n\t\tdev_dbg(dev, \"Failed to disable outer VLAN insertion for old VF without VIRTCHNL_VF_OFFLOAD_VLAN_V2 support\\n\");\n\n\t \n\tvlan_ops = &vsi->inner_vlan_ops;\n\n\tvlan_ops->dis_stripping = ice_vsi_dis_outer_stripping;\n\tvlan_ops->dis_insertion = ice_vsi_dis_outer_insertion;\n\n\tif (vlan_ops->dis_stripping(vsi))\n\t\tdev_dbg(dev, \"Failed to disable inner VLAN stripping for old VF without VIRTCHNL_VF_OFFLOAD_VLAN_V2 support\\n\");\n\n\tif (vlan_ops->dis_insertion(vsi))\n\t\tdev_dbg(dev, \"Failed to disable inner VLAN insertion for old VF without VIRTCHNL_VF_OFFLOAD_VLAN_V2 support\\n\");\n}\n\n \nvoid ice_vf_vsi_cfg_svm_legacy_vlan_mode(struct ice_vsi *vsi)\n{\n\tstruct ice_vf *vf = vsi->vf;\n\n\tif (WARN_ON(!vf))\n\t\treturn;\n\n\tif (ice_is_dvm_ena(&vsi->back->hw) || ice_vf_is_port_vlan_ena(vf))\n\t\treturn;\n\n\tif (vsi->inner_vlan_ops.dis_rx_filtering(vsi))\n\t\tdev_dbg(ice_pf_to_dev(vf->pf), \"Failed to disable Rx VLAN filtering for old VF with VIRTCHNL_VF_OFFLOAD_VLAN support\\n\");\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}