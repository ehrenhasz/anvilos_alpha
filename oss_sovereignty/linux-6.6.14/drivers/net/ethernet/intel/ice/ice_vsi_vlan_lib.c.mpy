{
  "module_name": "ice_vsi_vlan_lib.c",
  "hash_id": "6cd07b5eacccd304d18f6f6818559ea0ed8619f163e4d4469ed9e8408bd604ba",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/intel/ice/ice_vsi_vlan_lib.c",
  "human_readable_source": "\n \n\n#include \"ice_vsi_vlan_lib.h\"\n#include \"ice_lib.h\"\n#include \"ice_fltr.h\"\n#include \"ice.h\"\n\nstatic void print_invalid_tpid(struct ice_vsi *vsi, u16 tpid)\n{\n\tdev_err(ice_pf_to_dev(vsi->back), \"%s %d specified invalid VLAN tpid 0x%04x\\n\",\n\t\tice_vsi_type_str(vsi->type), vsi->idx, tpid);\n}\n\n \nstatic bool validate_vlan(struct ice_vsi *vsi, struct ice_vlan *vlan)\n{\n\tif (vlan->tpid != ETH_P_8021Q && vlan->tpid != ETH_P_8021AD &&\n\t    vlan->tpid != ETH_P_QINQ1 && (vlan->tpid || vlan->vid)) {\n\t\tprint_invalid_tpid(vsi, vlan->tpid);\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\n \nint ice_vsi_add_vlan(struct ice_vsi *vsi, struct ice_vlan *vlan)\n{\n\tint err;\n\n\tif (!validate_vlan(vsi, vlan))\n\t\treturn -EINVAL;\n\n\terr = ice_fltr_add_vlan(vsi, vlan);\n\tif (err && err != -EEXIST) {\n\t\tdev_err(ice_pf_to_dev(vsi->back), \"Failure Adding VLAN %d on VSI %i, status %d\\n\",\n\t\t\tvlan->vid, vsi->vsi_num, err);\n\t\treturn err;\n\t}\n\n\tvsi->num_vlan++;\n\treturn 0;\n}\n\n \nint ice_vsi_del_vlan(struct ice_vsi *vsi, struct ice_vlan *vlan)\n{\n\tstruct ice_pf *pf = vsi->back;\n\tstruct device *dev;\n\tint err;\n\n\tif (!validate_vlan(vsi, vlan))\n\t\treturn -EINVAL;\n\n\tdev = ice_pf_to_dev(pf);\n\n\terr = ice_fltr_remove_vlan(vsi, vlan);\n\tif (!err)\n\t\tvsi->num_vlan--;\n\telse if (err == -ENOENT || err == -EBUSY)\n\t\terr = 0;\n\telse\n\t\tdev_err(dev, \"Error removing VLAN %d on VSI %i error: %d\\n\",\n\t\t\tvlan->vid, vsi->vsi_num, err);\n\n\treturn err;\n}\n\n \nstatic int ice_vsi_manage_vlan_insertion(struct ice_vsi *vsi)\n{\n\tstruct ice_hw *hw = &vsi->back->hw;\n\tstruct ice_vsi_ctx *ctxt;\n\tint err;\n\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\t \n\tctxt->info.inner_vlan_flags = ICE_AQ_VSI_INNER_VLAN_TX_MODE_ALL;\n\n\t \n\tctxt->info.inner_vlan_flags |= (vsi->info.inner_vlan_flags &\n\t\t\t\t\tICE_AQ_VSI_INNER_VLAN_EMODE_M);\n\n\tctxt->info.valid_sections = cpu_to_le16(ICE_AQ_VSI_PROP_VLAN_VALID);\n\n\terr = ice_update_vsi(hw, vsi->idx, ctxt, NULL);\n\tif (err) {\n\t\tdev_err(ice_pf_to_dev(vsi->back), \"update VSI for VLAN insert failed, err %d aq_err %s\\n\",\n\t\t\terr, ice_aq_str(hw->adminq.sq_last_status));\n\t\tgoto out;\n\t}\n\n\tvsi->info.inner_vlan_flags = ctxt->info.inner_vlan_flags;\nout:\n\tkfree(ctxt);\n\treturn err;\n}\n\n \nstatic int ice_vsi_manage_vlan_stripping(struct ice_vsi *vsi, bool ena)\n{\n\tstruct ice_hw *hw = &vsi->back->hw;\n\tstruct ice_vsi_ctx *ctxt;\n\tint err;\n\n\t \n\tif (vsi->info.port_based_inner_vlan)\n\t\treturn 0;\n\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\t \n\tif (ena)\n\t\t \n\t\tctxt->info.inner_vlan_flags = ICE_AQ_VSI_INNER_VLAN_EMODE_STR_BOTH;\n\telse\n\t\t \n\t\tctxt->info.inner_vlan_flags = ICE_AQ_VSI_INNER_VLAN_EMODE_NOTHING;\n\n\t \n\tctxt->info.inner_vlan_flags |= ICE_AQ_VSI_INNER_VLAN_TX_MODE_ALL;\n\n\tctxt->info.valid_sections = cpu_to_le16(ICE_AQ_VSI_PROP_VLAN_VALID);\n\n\terr = ice_update_vsi(hw, vsi->idx, ctxt, NULL);\n\tif (err) {\n\t\tdev_err(ice_pf_to_dev(vsi->back), \"update VSI for VLAN strip failed, ena = %d err %d aq_err %s\\n\",\n\t\t\tena, err, ice_aq_str(hw->adminq.sq_last_status));\n\t\tgoto out;\n\t}\n\n\tvsi->info.inner_vlan_flags = ctxt->info.inner_vlan_flags;\nout:\n\tkfree(ctxt);\n\treturn err;\n}\n\nint ice_vsi_ena_inner_stripping(struct ice_vsi *vsi, const u16 tpid)\n{\n\tif (tpid != ETH_P_8021Q) {\n\t\tprint_invalid_tpid(vsi, tpid);\n\t\treturn -EINVAL;\n\t}\n\n\treturn ice_vsi_manage_vlan_stripping(vsi, true);\n}\n\nint ice_vsi_dis_inner_stripping(struct ice_vsi *vsi)\n{\n\treturn ice_vsi_manage_vlan_stripping(vsi, false);\n}\n\nint ice_vsi_ena_inner_insertion(struct ice_vsi *vsi, const u16 tpid)\n{\n\tif (tpid != ETH_P_8021Q) {\n\t\tprint_invalid_tpid(vsi, tpid);\n\t\treturn -EINVAL;\n\t}\n\n\treturn ice_vsi_manage_vlan_insertion(vsi);\n}\n\nint ice_vsi_dis_inner_insertion(struct ice_vsi *vsi)\n{\n\treturn ice_vsi_manage_vlan_insertion(vsi);\n}\n\nstatic void\nice_save_vlan_info(struct ice_aqc_vsi_props *info,\n\t\t   struct ice_vsi_vlan_info *vlan)\n{\n\tvlan->sw_flags2 = info->sw_flags2;\n\tvlan->inner_vlan_flags = info->inner_vlan_flags;\n\tvlan->outer_vlan_flags = info->outer_vlan_flags;\n}\n\nstatic void\nice_restore_vlan_info(struct ice_aqc_vsi_props *info,\n\t\t      struct ice_vsi_vlan_info *vlan)\n{\n\tinfo->sw_flags2 = vlan->sw_flags2;\n\tinfo->inner_vlan_flags = vlan->inner_vlan_flags;\n\tinfo->outer_vlan_flags = vlan->outer_vlan_flags;\n}\n\n \nstatic int __ice_vsi_set_inner_port_vlan(struct ice_vsi *vsi, u16 pvid_info)\n{\n\tstruct ice_hw *hw = &vsi->back->hw;\n\tstruct ice_aqc_vsi_props *info;\n\tstruct ice_vsi_ctx *ctxt;\n\tint ret;\n\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\tice_save_vlan_info(&vsi->info, &vsi->vlan_info);\n\tctxt->info = vsi->info;\n\tinfo = &ctxt->info;\n\tinfo->inner_vlan_flags = ICE_AQ_VSI_INNER_VLAN_TX_MODE_ACCEPTUNTAGGED |\n\t\tICE_AQ_VSI_INNER_VLAN_INSERT_PVID |\n\t\tICE_AQ_VSI_INNER_VLAN_EMODE_STR;\n\tinfo->sw_flags2 |= ICE_AQ_VSI_SW_FLAG_RX_VLAN_PRUNE_ENA;\n\n\tinfo->port_based_inner_vlan = cpu_to_le16(pvid_info);\n\tinfo->valid_sections = cpu_to_le16(ICE_AQ_VSI_PROP_VLAN_VALID |\n\t\t\t\t\t   ICE_AQ_VSI_PROP_SW_VALID);\n\n\tret = ice_update_vsi(hw, vsi->idx, ctxt, NULL);\n\tif (ret) {\n\t\tdev_info(ice_hw_to_dev(hw), \"update VSI for port VLAN failed, err %d aq_err %s\\n\",\n\t\t\t ret, ice_aq_str(hw->adminq.sq_last_status));\n\t\tgoto out;\n\t}\n\n\tvsi->info.inner_vlan_flags = info->inner_vlan_flags;\n\tvsi->info.sw_flags2 = info->sw_flags2;\n\tvsi->info.port_based_inner_vlan = info->port_based_inner_vlan;\nout:\n\tkfree(ctxt);\n\treturn ret;\n}\n\nint ice_vsi_set_inner_port_vlan(struct ice_vsi *vsi, struct ice_vlan *vlan)\n{\n\tu16 port_vlan_info;\n\n\tif (vlan->tpid != ETH_P_8021Q)\n\t\treturn -EINVAL;\n\n\tif (vlan->prio > 7)\n\t\treturn -EINVAL;\n\n\tport_vlan_info = vlan->vid | (vlan->prio << VLAN_PRIO_SHIFT);\n\n\treturn __ice_vsi_set_inner_port_vlan(vsi, port_vlan_info);\n}\n\nint ice_vsi_clear_inner_port_vlan(struct ice_vsi *vsi)\n{\n\tstruct ice_hw *hw = &vsi->back->hw;\n\tstruct ice_aqc_vsi_props *info;\n\tstruct ice_vsi_ctx *ctxt;\n\tint ret;\n\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\tice_restore_vlan_info(&vsi->info, &vsi->vlan_info);\n\tvsi->info.port_based_inner_vlan = 0;\n\tctxt->info = vsi->info;\n\tinfo = &ctxt->info;\n\tinfo->valid_sections = cpu_to_le16(ICE_AQ_VSI_PROP_VLAN_VALID |\n\t\t\t\t\t   ICE_AQ_VSI_PROP_SW_VALID);\n\n\tret = ice_update_vsi(hw, vsi->idx, ctxt, NULL);\n\tif (ret)\n\t\tdev_err(ice_hw_to_dev(hw), \"update VSI for port VLAN failed, err %d aq_err %s\\n\",\n\t\t\tret, ice_aq_str(hw->adminq.sq_last_status));\n\n\tkfree(ctxt);\n\treturn ret;\n}\n\n \nstatic int ice_cfg_vlan_pruning(struct ice_vsi *vsi, bool ena)\n{\n\tstruct ice_vsi_ctx *ctxt;\n\tstruct ice_pf *pf;\n\tint status;\n\n\tif (!vsi)\n\t\treturn -EINVAL;\n\n\t \n\tif (vsi->netdev && vsi->netdev->flags & IFF_PROMISC && ena)\n\t\treturn 0;\n\n\tpf = vsi->back;\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\tctxt->info = vsi->info;\n\n\tif (ena)\n\t\tctxt->info.sw_flags2 |= ICE_AQ_VSI_SW_FLAG_RX_VLAN_PRUNE_ENA;\n\telse\n\t\tctxt->info.sw_flags2 &= ~ICE_AQ_VSI_SW_FLAG_RX_VLAN_PRUNE_ENA;\n\n\tctxt->info.valid_sections = cpu_to_le16(ICE_AQ_VSI_PROP_SW_VALID);\n\n\tstatus = ice_update_vsi(&pf->hw, vsi->idx, ctxt, NULL);\n\tif (status) {\n\t\tnetdev_err(vsi->netdev, \"%sabling VLAN pruning on VSI handle: %d, VSI HW ID: %d failed, err = %d, aq_err = %s\\n\",\n\t\t\t   ena ? \"En\" : \"Dis\", vsi->idx, vsi->vsi_num, status,\n\t\t\t   ice_aq_str(pf->hw.adminq.sq_last_status));\n\t\tgoto err_out;\n\t}\n\n\tvsi->info.sw_flags2 = ctxt->info.sw_flags2;\n\n\tkfree(ctxt);\n\treturn 0;\n\nerr_out:\n\tkfree(ctxt);\n\treturn status;\n}\n\nint ice_vsi_ena_rx_vlan_filtering(struct ice_vsi *vsi)\n{\n\treturn ice_cfg_vlan_pruning(vsi, true);\n}\n\nint ice_vsi_dis_rx_vlan_filtering(struct ice_vsi *vsi)\n{\n\treturn ice_cfg_vlan_pruning(vsi, false);\n}\n\nstatic int ice_cfg_vlan_antispoof(struct ice_vsi *vsi, bool enable)\n{\n\tstruct ice_vsi_ctx *ctx;\n\tint err;\n\n\tctx = kzalloc(sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\tctx->info.sec_flags = vsi->info.sec_flags;\n\tctx->info.valid_sections = cpu_to_le16(ICE_AQ_VSI_PROP_SECURITY_VALID);\n\n\tif (enable)\n\t\tctx->info.sec_flags |= ICE_AQ_VSI_SEC_TX_VLAN_PRUNE_ENA <<\n\t\t\tICE_AQ_VSI_SEC_TX_PRUNE_ENA_S;\n\telse\n\t\tctx->info.sec_flags &= ~(ICE_AQ_VSI_SEC_TX_VLAN_PRUNE_ENA <<\n\t\t\t\t\t ICE_AQ_VSI_SEC_TX_PRUNE_ENA_S);\n\n\terr = ice_update_vsi(&vsi->back->hw, vsi->idx, ctx, NULL);\n\tif (err)\n\t\tdev_err(ice_pf_to_dev(vsi->back), \"Failed to configure Tx VLAN anti-spoof %s for VSI %d, error %d\\n\",\n\t\t\tenable ? \"ON\" : \"OFF\", vsi->vsi_num, err);\n\telse\n\t\tvsi->info.sec_flags = ctx->info.sec_flags;\n\n\tkfree(ctx);\n\n\treturn err;\n}\n\nint ice_vsi_ena_tx_vlan_filtering(struct ice_vsi *vsi)\n{\n\treturn ice_cfg_vlan_antispoof(vsi, true);\n}\n\nint ice_vsi_dis_tx_vlan_filtering(struct ice_vsi *vsi)\n{\n\treturn ice_cfg_vlan_antispoof(vsi, false);\n}\n\n \nstatic int tpid_to_vsi_outer_vlan_type(u16 tpid, u8 *tag_type)\n{\n\tswitch (tpid) {\n\tcase ETH_P_8021Q:\n\t\t*tag_type = ICE_AQ_VSI_OUTER_TAG_VLAN_8100;\n\t\tbreak;\n\tcase ETH_P_8021AD:\n\t\t*tag_type = ICE_AQ_VSI_OUTER_TAG_STAG;\n\t\tbreak;\n\tcase ETH_P_QINQ1:\n\t\t*tag_type = ICE_AQ_VSI_OUTER_TAG_VLAN_9100;\n\t\tbreak;\n\tdefault:\n\t\t*tag_type = 0;\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\n \nint ice_vsi_ena_outer_stripping(struct ice_vsi *vsi, u16 tpid)\n{\n\tstruct ice_hw *hw = &vsi->back->hw;\n\tstruct ice_vsi_ctx *ctxt;\n\tu8 tag_type;\n\tint err;\n\n\t \n\tif (vsi->info.port_based_outer_vlan)\n\t\treturn 0;\n\n\tif (tpid_to_vsi_outer_vlan_type(tpid, &tag_type))\n\t\treturn -EINVAL;\n\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\tctxt->info.valid_sections =\n\t\tcpu_to_le16(ICE_AQ_VSI_PROP_OUTER_TAG_VALID);\n\t \n\tctxt->info.outer_vlan_flags = vsi->info.outer_vlan_flags &\n\t\t~(ICE_AQ_VSI_OUTER_VLAN_EMODE_M | ICE_AQ_VSI_OUTER_TAG_TYPE_M);\n\tctxt->info.outer_vlan_flags |=\n\t\t((ICE_AQ_VSI_OUTER_VLAN_EMODE_SHOW_BOTH <<\n\t\t  ICE_AQ_VSI_OUTER_VLAN_EMODE_S) |\n\t\t ((tag_type << ICE_AQ_VSI_OUTER_TAG_TYPE_S) &\n\t\t  ICE_AQ_VSI_OUTER_TAG_TYPE_M));\n\n\terr = ice_update_vsi(hw, vsi->idx, ctxt, NULL);\n\tif (err)\n\t\tdev_err(ice_pf_to_dev(vsi->back), \"update VSI for enabling outer VLAN stripping failed, err %d aq_err %s\\n\",\n\t\t\terr, ice_aq_str(hw->adminq.sq_last_status));\n\telse\n\t\tvsi->info.outer_vlan_flags = ctxt->info.outer_vlan_flags;\n\n\tkfree(ctxt);\n\treturn err;\n}\n\n \nint ice_vsi_dis_outer_stripping(struct ice_vsi *vsi)\n{\n\tstruct ice_hw *hw = &vsi->back->hw;\n\tstruct ice_vsi_ctx *ctxt;\n\tint err;\n\n\tif (vsi->info.port_based_outer_vlan)\n\t\treturn 0;\n\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\tctxt->info.valid_sections =\n\t\tcpu_to_le16(ICE_AQ_VSI_PROP_OUTER_TAG_VALID);\n\t \n\tctxt->info.outer_vlan_flags = vsi->info.outer_vlan_flags &\n\t\t~ICE_AQ_VSI_OUTER_VLAN_EMODE_M;\n\tctxt->info.outer_vlan_flags |= ICE_AQ_VSI_OUTER_VLAN_EMODE_NOTHING <<\n\t\tICE_AQ_VSI_OUTER_VLAN_EMODE_S;\n\n\terr = ice_update_vsi(hw, vsi->idx, ctxt, NULL);\n\tif (err)\n\t\tdev_err(ice_pf_to_dev(vsi->back), \"update VSI for disabling outer VLAN stripping failed, err %d aq_err %s\\n\",\n\t\t\terr, ice_aq_str(hw->adminq.sq_last_status));\n\telse\n\t\tvsi->info.outer_vlan_flags = ctxt->info.outer_vlan_flags;\n\n\tkfree(ctxt);\n\treturn err;\n}\n\n \nint ice_vsi_ena_outer_insertion(struct ice_vsi *vsi, u16 tpid)\n{\n\tstruct ice_hw *hw = &vsi->back->hw;\n\tstruct ice_vsi_ctx *ctxt;\n\tu8 tag_type;\n\tint err;\n\n\tif (vsi->info.port_based_outer_vlan)\n\t\treturn 0;\n\n\tif (tpid_to_vsi_outer_vlan_type(tpid, &tag_type))\n\t\treturn -EINVAL;\n\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\tctxt->info.valid_sections =\n\t\tcpu_to_le16(ICE_AQ_VSI_PROP_OUTER_TAG_VALID);\n\t \n\tctxt->info.outer_vlan_flags = vsi->info.outer_vlan_flags &\n\t\t~(ICE_AQ_VSI_OUTER_VLAN_PORT_BASED_INSERT |\n\t\t  ICE_AQ_VSI_OUTER_VLAN_BLOCK_TX_DESC |\n\t\t  ICE_AQ_VSI_OUTER_VLAN_TX_MODE_M |\n\t\t  ICE_AQ_VSI_OUTER_TAG_TYPE_M);\n\tctxt->info.outer_vlan_flags |=\n\t\t((ICE_AQ_VSI_OUTER_VLAN_TX_MODE_ALL <<\n\t\t  ICE_AQ_VSI_OUTER_VLAN_TX_MODE_S) &\n\t\t ICE_AQ_VSI_OUTER_VLAN_TX_MODE_M) |\n\t\t((tag_type << ICE_AQ_VSI_OUTER_TAG_TYPE_S) &\n\t\t ICE_AQ_VSI_OUTER_TAG_TYPE_M);\n\n\terr = ice_update_vsi(hw, vsi->idx, ctxt, NULL);\n\tif (err)\n\t\tdev_err(ice_pf_to_dev(vsi->back), \"update VSI for enabling outer VLAN insertion failed, err %d aq_err %s\\n\",\n\t\t\terr, ice_aq_str(hw->adminq.sq_last_status));\n\telse\n\t\tvsi->info.outer_vlan_flags = ctxt->info.outer_vlan_flags;\n\n\tkfree(ctxt);\n\treturn err;\n}\n\n \nint ice_vsi_dis_outer_insertion(struct ice_vsi *vsi)\n{\n\tstruct ice_hw *hw = &vsi->back->hw;\n\tstruct ice_vsi_ctx *ctxt;\n\tint err;\n\n\tif (vsi->info.port_based_outer_vlan)\n\t\treturn 0;\n\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\tctxt->info.valid_sections =\n\t\tcpu_to_le16(ICE_AQ_VSI_PROP_OUTER_TAG_VALID);\n\t \n\tctxt->info.outer_vlan_flags = vsi->info.outer_vlan_flags &\n\t\t~(ICE_AQ_VSI_OUTER_VLAN_PORT_BASED_INSERT |\n\t\t  ICE_AQ_VSI_OUTER_VLAN_TX_MODE_M);\n\tctxt->info.outer_vlan_flags |=\n\t\tICE_AQ_VSI_OUTER_VLAN_BLOCK_TX_DESC |\n\t\t((ICE_AQ_VSI_OUTER_VLAN_TX_MODE_ALL <<\n\t\t  ICE_AQ_VSI_OUTER_VLAN_TX_MODE_S) &\n\t\t ICE_AQ_VSI_OUTER_VLAN_TX_MODE_M);\n\n\terr = ice_update_vsi(hw, vsi->idx, ctxt, NULL);\n\tif (err)\n\t\tdev_err(ice_pf_to_dev(vsi->back), \"update VSI for disabling outer VLAN insertion failed, err %d aq_err %s\\n\",\n\t\t\terr, ice_aq_str(hw->adminq.sq_last_status));\n\telse\n\t\tvsi->info.outer_vlan_flags = ctxt->info.outer_vlan_flags;\n\n\tkfree(ctxt);\n\treturn err;\n}\n\n \nstatic int\n__ice_vsi_set_outer_port_vlan(struct ice_vsi *vsi, u16 vlan_info, u16 tpid)\n{\n\tstruct ice_hw *hw = &vsi->back->hw;\n\tstruct ice_vsi_ctx *ctxt;\n\tu8 tag_type;\n\tint err;\n\n\tif (tpid_to_vsi_outer_vlan_type(tpid, &tag_type))\n\t\treturn -EINVAL;\n\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\tice_save_vlan_info(&vsi->info, &vsi->vlan_info);\n\tctxt->info = vsi->info;\n\n\tctxt->info.sw_flags2 |= ICE_AQ_VSI_SW_FLAG_RX_VLAN_PRUNE_ENA;\n\n\tctxt->info.port_based_outer_vlan = cpu_to_le16(vlan_info);\n\tctxt->info.outer_vlan_flags =\n\t\t(ICE_AQ_VSI_OUTER_VLAN_EMODE_SHOW <<\n\t\t ICE_AQ_VSI_OUTER_VLAN_EMODE_S) |\n\t\t((tag_type << ICE_AQ_VSI_OUTER_TAG_TYPE_S) &\n\t\t ICE_AQ_VSI_OUTER_TAG_TYPE_M) |\n\t\tICE_AQ_VSI_OUTER_VLAN_BLOCK_TX_DESC |\n\t\t(ICE_AQ_VSI_OUTER_VLAN_TX_MODE_ACCEPTUNTAGGED <<\n\t\t ICE_AQ_VSI_OUTER_VLAN_TX_MODE_S) |\n\t\tICE_AQ_VSI_OUTER_VLAN_PORT_BASED_INSERT;\n\n\tctxt->info.valid_sections =\n\t\tcpu_to_le16(ICE_AQ_VSI_PROP_OUTER_TAG_VALID |\n\t\t\t    ICE_AQ_VSI_PROP_SW_VALID);\n\n\terr = ice_update_vsi(hw, vsi->idx, ctxt, NULL);\n\tif (err) {\n\t\tdev_err(ice_pf_to_dev(vsi->back), \"update VSI for setting outer port based VLAN failed, err %d aq_err %s\\n\",\n\t\t\terr, ice_aq_str(hw->adminq.sq_last_status));\n\t} else {\n\t\tvsi->info.port_based_outer_vlan = ctxt->info.port_based_outer_vlan;\n\t\tvsi->info.outer_vlan_flags = ctxt->info.outer_vlan_flags;\n\t\tvsi->info.sw_flags2 = ctxt->info.sw_flags2;\n\t}\n\n\tkfree(ctxt);\n\treturn err;\n}\n\n \nint ice_vsi_set_outer_port_vlan(struct ice_vsi *vsi, struct ice_vlan *vlan)\n{\n\tu16 port_vlan_info;\n\n\tif (vlan->prio > (VLAN_PRIO_MASK >> VLAN_PRIO_SHIFT))\n\t\treturn -EINVAL;\n\n\tport_vlan_info = vlan->vid | (vlan->prio << VLAN_PRIO_SHIFT);\n\n\treturn __ice_vsi_set_outer_port_vlan(vsi, port_vlan_info, vlan->tpid);\n}\n\n \nint ice_vsi_clear_outer_port_vlan(struct ice_vsi *vsi)\n{\n\tstruct ice_hw *hw = &vsi->back->hw;\n\tstruct ice_vsi_ctx *ctxt;\n\tint err;\n\n\tctxt = kzalloc(sizeof(*ctxt), GFP_KERNEL);\n\tif (!ctxt)\n\t\treturn -ENOMEM;\n\n\tice_restore_vlan_info(&vsi->info, &vsi->vlan_info);\n\tvsi->info.port_based_outer_vlan = 0;\n\tctxt->info = vsi->info;\n\n\tctxt->info.valid_sections =\n\t\tcpu_to_le16(ICE_AQ_VSI_PROP_OUTER_TAG_VALID |\n\t\t\t    ICE_AQ_VSI_PROP_SW_VALID);\n\n\terr = ice_update_vsi(hw, vsi->idx, ctxt, NULL);\n\tif (err)\n\t\tdev_err(ice_pf_to_dev(vsi->back), \"update VSI for clearing outer port based VLAN failed, err %d aq_err %s\\n\",\n\t\t\terr, ice_aq_str(hw->adminq.sq_last_status));\n\n\tkfree(ctxt);\n\treturn err;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}