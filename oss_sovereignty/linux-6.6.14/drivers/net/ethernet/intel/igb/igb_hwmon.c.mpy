{
  "module_name": "igb_hwmon.c",
  "hash_id": "6d1a62f9f4fd455ae30541fb8ceb5e7c77f998c5665ce14312c97070b60917cd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/intel/igb/igb_hwmon.c",
  "human_readable_source": "\n \n\n#include \"igb.h\"\n#include \"e1000_82575.h\"\n#include \"e1000_hw.h\"\n\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/sysfs.h>\n#include <linux/kobject.h>\n#include <linux/device.h>\n#include <linux/netdevice.h>\n#include <linux/hwmon.h>\n#include <linux/pci.h>\n\n#ifdef CONFIG_IGB_HWMON\nstatic struct i2c_board_info i350_sensor_info = {\n\tI2C_BOARD_INFO(\"i350bb\", (0Xf8 >> 1)),\n};\n\n \nstatic ssize_t igb_hwmon_show_location(struct device *dev,\n\t\t\t\t       struct device_attribute *attr,\n\t\t\t\t       char *buf)\n{\n\tstruct hwmon_attr *igb_attr = container_of(attr, struct hwmon_attr,\n\t\t\t\t\t\t   dev_attr);\n\treturn sprintf(buf, \"loc%u\\n\",\n\t\t       igb_attr->sensor->location);\n}\n\nstatic ssize_t igb_hwmon_show_temp(struct device *dev,\n\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t   char *buf)\n{\n\tstruct hwmon_attr *igb_attr = container_of(attr, struct hwmon_attr,\n\t\t\t\t\t\t   dev_attr);\n\tunsigned int value;\n\n\t \n\tigb_attr->hw->mac.ops.get_thermal_sensor_data(igb_attr->hw);\n\n\tvalue = igb_attr->sensor->temp;\n\n\t \n\tvalue *= 1000;\n\n\treturn sprintf(buf, \"%u\\n\", value);\n}\n\nstatic ssize_t igb_hwmon_show_cautionthresh(struct device *dev,\n\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t    char *buf)\n{\n\tstruct hwmon_attr *igb_attr = container_of(attr, struct hwmon_attr,\n\t\t\t\t\t\t   dev_attr);\n\tunsigned int value = igb_attr->sensor->caution_thresh;\n\n\t \n\tvalue *= 1000;\n\n\treturn sprintf(buf, \"%u\\n\", value);\n}\n\nstatic ssize_t igb_hwmon_show_maxopthresh(struct device *dev,\n\t\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t\t  char *buf)\n{\n\tstruct hwmon_attr *igb_attr = container_of(attr, struct hwmon_attr,\n\t\t\t\t\t\t   dev_attr);\n\tunsigned int value = igb_attr->sensor->max_op_thresh;\n\n\t \n\tvalue *= 1000;\n\n\treturn sprintf(buf, \"%u\\n\", value);\n}\n\n \nstatic int igb_add_hwmon_attr(struct igb_adapter *adapter,\n\t\t\t      unsigned int offset, int type)\n{\n\tint rc;\n\tunsigned int n_attr;\n\tstruct hwmon_attr *igb_attr;\n\n\tn_attr = adapter->igb_hwmon_buff->n_hwmon;\n\tigb_attr = &adapter->igb_hwmon_buff->hwmon_list[n_attr];\n\n\tswitch (type) {\n\tcase IGB_HWMON_TYPE_LOC:\n\t\tigb_attr->dev_attr.show = igb_hwmon_show_location;\n\t\tsnprintf(igb_attr->name, sizeof(igb_attr->name),\n\t\t\t \"temp%u_label\", offset + 1);\n\t\tbreak;\n\tcase IGB_HWMON_TYPE_TEMP:\n\t\tigb_attr->dev_attr.show = igb_hwmon_show_temp;\n\t\tsnprintf(igb_attr->name, sizeof(igb_attr->name),\n\t\t\t \"temp%u_input\", offset + 1);\n\t\tbreak;\n\tcase IGB_HWMON_TYPE_CAUTION:\n\t\tigb_attr->dev_attr.show = igb_hwmon_show_cautionthresh;\n\t\tsnprintf(igb_attr->name, sizeof(igb_attr->name),\n\t\t\t \"temp%u_max\", offset + 1);\n\t\tbreak;\n\tcase IGB_HWMON_TYPE_MAX:\n\t\tigb_attr->dev_attr.show = igb_hwmon_show_maxopthresh;\n\t\tsnprintf(igb_attr->name, sizeof(igb_attr->name),\n\t\t\t \"temp%u_crit\", offset + 1);\n\t\tbreak;\n\tdefault:\n\t\trc = -EPERM;\n\t\treturn rc;\n\t}\n\n\t \n\tigb_attr->sensor =\n\t\t&adapter->hw.mac.thermal_sensor_data.sensor[offset];\n\tigb_attr->hw = &adapter->hw;\n\tigb_attr->dev_attr.store = NULL;\n\tigb_attr->dev_attr.attr.mode = 0444;\n\tigb_attr->dev_attr.attr.name = igb_attr->name;\n\tsysfs_attr_init(&igb_attr->dev_attr.attr);\n\n\tadapter->igb_hwmon_buff->attrs[n_attr] = &igb_attr->dev_attr.attr;\n\n\t++adapter->igb_hwmon_buff->n_hwmon;\n\n\treturn 0;\n}\n\nstatic void igb_sysfs_del_adapter(struct igb_adapter *adapter)\n{\n}\n\n \nvoid igb_sysfs_exit(struct igb_adapter *adapter)\n{\n\tigb_sysfs_del_adapter(adapter);\n}\n\n \nint igb_sysfs_init(struct igb_adapter *adapter)\n{\n\tstruct hwmon_buff *igb_hwmon;\n\tstruct i2c_client *client;\n\tstruct device *hwmon_dev;\n\tunsigned int i;\n\tint rc = 0;\n\n\t \n\tif (adapter->hw.mac.ops.init_thermal_sensor_thresh == NULL)\n\t\tgoto exit;\n\n\t \n\trc = (adapter->hw.mac.ops.init_thermal_sensor_thresh(&adapter->hw));\n\tif (rc)\n\t\tgoto exit;\n\n\tigb_hwmon = devm_kzalloc(&adapter->pdev->dev, sizeof(*igb_hwmon),\n\t\t\t\t GFP_KERNEL);\n\tif (!igb_hwmon) {\n\t\trc = -ENOMEM;\n\t\tgoto exit;\n\t}\n\tadapter->igb_hwmon_buff = igb_hwmon;\n\n\tfor (i = 0; i < E1000_MAX_SENSORS; i++) {\n\n\t\t \n\t\tif (adapter->hw.mac.thermal_sensor_data.sensor[i].location == 0)\n\t\t\tcontinue;\n\n\t\t \n\t\trc = igb_add_hwmon_attr(adapter, i, IGB_HWMON_TYPE_CAUTION);\n\t\tif (rc)\n\t\t\tgoto exit;\n\t\trc = igb_add_hwmon_attr(adapter, i, IGB_HWMON_TYPE_LOC);\n\t\tif (rc)\n\t\t\tgoto exit;\n\t\trc = igb_add_hwmon_attr(adapter, i, IGB_HWMON_TYPE_TEMP);\n\t\tif (rc)\n\t\t\tgoto exit;\n\t\trc = igb_add_hwmon_attr(adapter, i, IGB_HWMON_TYPE_MAX);\n\t\tif (rc)\n\t\t\tgoto exit;\n\t}\n\n\t \n\tclient = i2c_new_client_device(&adapter->i2c_adap, &i350_sensor_info);\n\tif (IS_ERR(client)) {\n\t\tdev_info(&adapter->pdev->dev,\n\t\t\t \"Failed to create new i2c device.\\n\");\n\t\trc = PTR_ERR(client);\n\t\tgoto exit;\n\t}\n\tadapter->i2c_client = client;\n\n\tigb_hwmon->groups[0] = &igb_hwmon->group;\n\tigb_hwmon->group.attrs = igb_hwmon->attrs;\n\n\thwmon_dev = devm_hwmon_device_register_with_groups(&adapter->pdev->dev,\n\t\t\t\t\t\t\t   client->name,\n\t\t\t\t\t\t\t   igb_hwmon,\n\t\t\t\t\t\t\t   igb_hwmon->groups);\n\tif (IS_ERR(hwmon_dev)) {\n\t\trc = PTR_ERR(hwmon_dev);\n\t\tgoto err;\n\t}\n\n\tgoto exit;\n\nerr:\n\tigb_sysfs_del_adapter(adapter);\nexit:\n\treturn rc;\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}