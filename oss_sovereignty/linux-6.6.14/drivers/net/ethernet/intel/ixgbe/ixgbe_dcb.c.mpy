{
  "module_name": "ixgbe_dcb.c",
  "hash_id": "f779e50fda7f0356f0602c1511ed74a6b8706e2e9ec6ebf31b73a764fde3c16d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/intel/ixgbe/ixgbe_dcb.c",
  "human_readable_source": "\n \n\n#include \"ixgbe.h\"\n#include \"ixgbe_type.h\"\n#include \"ixgbe_dcb.h\"\n#include \"ixgbe_dcb_82598.h\"\n#include \"ixgbe_dcb_82599.h\"\n\n \nstatic s32 ixgbe_ieee_credits(__u8 *bw, __u16 *refill,\n\t\t\t      __u16 *max, int max_frame)\n{\n\tint min_percent = 100;\n\tint min_credit, multiplier;\n\tint i;\n\n\tmin_credit = ((max_frame / 2) + DCB_CREDIT_QUANTUM - 1) /\n\t\t\tDCB_CREDIT_QUANTUM;\n\n\tfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\n\t\tif (bw[i] < min_percent && bw[i])\n\t\t\tmin_percent = bw[i];\n\t}\n\n\tmultiplier = (min_credit / min_percent) + 1;\n\n\t \n\tfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\n\t\tint val = min(bw[i] * multiplier, MAX_CREDIT_REFILL);\n\n\t\tif (val < min_credit)\n\t\t\tval = min_credit;\n\t\trefill[i] = val;\n\n\t\tmax[i] = bw[i] ? (bw[i] * MAX_CREDIT)/100 : min_credit;\n\t}\n\treturn 0;\n}\n\n \ns32 ixgbe_dcb_calculate_tc_credits(struct ixgbe_hw *hw,\n\t\t\t\t   struct ixgbe_dcb_config *dcb_config,\n\t\t\t\t   int max_frame, u8 direction)\n{\n\tstruct tc_bw_alloc *p;\n\tint min_credit;\n\tint min_multiplier;\n\tint min_percent = 100;\n\t \n\tu32 credit_refill       = 0;\n\tu32 credit_max          = 0;\n\tu16 link_percentage     = 0;\n\tu8  bw_percent          = 0;\n\tu8  i;\n\n\tif (!dcb_config)\n\t\treturn DCB_ERR_CONFIG;\n\n\tmin_credit = ((max_frame / 2) + DCB_CREDIT_QUANTUM - 1) /\n\t\t\tDCB_CREDIT_QUANTUM;\n\n\t \n\tfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\n\t\tp = &dcb_config->tc_config[i].path[direction];\n\t\tbw_percent = dcb_config->bw_percentage[direction][p->bwg_id];\n\t\tlink_percentage = p->bwg_percent;\n\n\t\tlink_percentage = (link_percentage * bw_percent) / 100;\n\n\t\tif (link_percentage && link_percentage < min_percent)\n\t\t\tmin_percent = link_percentage;\n\t}\n\n\t \n\tmin_multiplier = (min_credit / min_percent) + 1;\n\n\t \n\tfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\n\t\tp = &dcb_config->tc_config[i].path[direction];\n\t\tbw_percent = dcb_config->bw_percentage[direction][p->bwg_id];\n\n\t\tlink_percentage = p->bwg_percent;\n\t\t \n\t\tlink_percentage = (link_percentage * bw_percent) / 100;\n\t\tif (p->bwg_percent > 0 && link_percentage == 0)\n\t\t\tlink_percentage = 1;\n\n\t\t \n\t\tp->link_percent = (u8)link_percentage;\n\n\t\t \n\t\tcredit_refill = min(link_percentage * min_multiplier,\n\t\t\t\t    MAX_CREDIT_REFILL);\n\n\t\t \n\t\tif (credit_refill < min_credit)\n\t\t\tcredit_refill = min_credit;\n\n\t\tp->data_credits_refill = (u16)credit_refill;\n\n\t\t \n\t\tcredit_max = (link_percentage * MAX_CREDIT) / 100;\n\n\t\t \n\t\tif (credit_max < min_credit)\n\t\t\tcredit_max = min_credit;\n\n\t\tif (direction == DCB_TX_CONFIG) {\n\t\t\t \n\t\t\tif ((hw->mac.type == ixgbe_mac_82598EB) &&\n\t\t\t    credit_max &&\n\t\t\t    (credit_max < MINIMUM_CREDIT_FOR_TSO))\n\t\t\t\tcredit_max = MINIMUM_CREDIT_FOR_TSO;\n\n\t\t\tdcb_config->tc_config[i].desc_credits_max =\n\t\t\t\t(u16)credit_max;\n\t\t}\n\n\t\tp->data_credits_max = (u16)credit_max;\n\t}\n\n\treturn 0;\n}\n\nvoid ixgbe_dcb_unpack_pfc(struct ixgbe_dcb_config *cfg, u8 *pfc_en)\n{\n\tstruct tc_configuration *tc_config = &cfg->tc_config[0];\n\tint tc;\n\n\tfor (*pfc_en = 0, tc = 0; tc < MAX_TRAFFIC_CLASS; tc++) {\n\t\tif (tc_config[tc].dcb_pfc != pfc_disabled)\n\t\t\t*pfc_en |= BIT(tc);\n\t}\n}\n\nvoid ixgbe_dcb_unpack_refill(struct ixgbe_dcb_config *cfg, int direction,\n\t\t\t     u16 *refill)\n{\n\tstruct tc_configuration *tc_config = &cfg->tc_config[0];\n\tint tc;\n\n\tfor (tc = 0; tc < MAX_TRAFFIC_CLASS; tc++)\n\t\trefill[tc] = tc_config[tc].path[direction].data_credits_refill;\n}\n\nvoid ixgbe_dcb_unpack_max(struct ixgbe_dcb_config *cfg, u16 *max)\n{\n\tstruct tc_configuration *tc_config = &cfg->tc_config[0];\n\tint tc;\n\n\tfor (tc = 0; tc < MAX_TRAFFIC_CLASS; tc++)\n\t\tmax[tc] = tc_config[tc].desc_credits_max;\n}\n\nvoid ixgbe_dcb_unpack_bwgid(struct ixgbe_dcb_config *cfg, int direction,\n\t\t\t    u8 *bwgid)\n{\n\tstruct tc_configuration *tc_config = &cfg->tc_config[0];\n\tint tc;\n\n\tfor (tc = 0; tc < MAX_TRAFFIC_CLASS; tc++)\n\t\tbwgid[tc] = tc_config[tc].path[direction].bwg_id;\n}\n\nvoid ixgbe_dcb_unpack_prio(struct ixgbe_dcb_config *cfg, int direction,\n\t\t\t    u8 *ptype)\n{\n\tstruct tc_configuration *tc_config = &cfg->tc_config[0];\n\tint tc;\n\n\tfor (tc = 0; tc < MAX_TRAFFIC_CLASS; tc++)\n\t\tptype[tc] = tc_config[tc].path[direction].prio_type;\n}\n\nu8 ixgbe_dcb_get_tc_from_up(struct ixgbe_dcb_config *cfg, int direction, u8 up)\n{\n\tstruct tc_configuration *tc_config = &cfg->tc_config[0];\n\tu8 prio_mask = BIT(up);\n\tu8 tc = cfg->num_tcs.pg_tcs;\n\n\t \n\tif (!tc)\n\t\treturn 0;\n\n\t \n\tfor (tc--; tc; tc--) {\n\t\tif (prio_mask & tc_config[tc].path[direction].up_to_tc_bitmap)\n\t\t\tbreak;\n\t}\n\n\treturn tc;\n}\n\nvoid ixgbe_dcb_unpack_map(struct ixgbe_dcb_config *cfg, int direction, u8 *map)\n{\n\tu8 up;\n\n\tfor (up = 0; up < MAX_USER_PRIORITY; up++)\n\t\tmap[up] = ixgbe_dcb_get_tc_from_up(cfg, direction, up);\n}\n\n \ns32 ixgbe_dcb_hw_config(struct ixgbe_hw *hw,\n\t\t\tstruct ixgbe_dcb_config *dcb_config)\n{\n\tu8 pfc_en;\n\tu8 ptype[MAX_TRAFFIC_CLASS];\n\tu8 bwgid[MAX_TRAFFIC_CLASS];\n\tu8 prio_tc[MAX_TRAFFIC_CLASS];\n\tu16 refill[MAX_TRAFFIC_CLASS];\n\tu16 max[MAX_TRAFFIC_CLASS];\n\n\t \n\tixgbe_dcb_unpack_pfc(dcb_config, &pfc_en);\n\tixgbe_dcb_unpack_refill(dcb_config, DCB_TX_CONFIG, refill);\n\tixgbe_dcb_unpack_max(dcb_config, max);\n\tixgbe_dcb_unpack_bwgid(dcb_config, DCB_TX_CONFIG, bwgid);\n\tixgbe_dcb_unpack_prio(dcb_config, DCB_TX_CONFIG, ptype);\n\tixgbe_dcb_unpack_map(dcb_config, DCB_TX_CONFIG, prio_tc);\n\n\tswitch (hw->mac.type) {\n\tcase ixgbe_mac_82598EB:\n\t\treturn ixgbe_dcb_hw_config_82598(hw, pfc_en, refill, max,\n\t\t\t\t\t\t bwgid, ptype);\n\tcase ixgbe_mac_82599EB:\n\tcase ixgbe_mac_X540:\n\tcase ixgbe_mac_X550:\n\tcase ixgbe_mac_X550EM_x:\n\tcase ixgbe_mac_x550em_a:\n\t\treturn ixgbe_dcb_hw_config_82599(hw, pfc_en, refill, max,\n\t\t\t\t\t\t bwgid, ptype, prio_tc);\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\n \ns32 ixgbe_dcb_hw_pfc_config(struct ixgbe_hw *hw, u8 pfc_en, u8 *prio_tc)\n{\n\tswitch (hw->mac.type) {\n\tcase ixgbe_mac_82598EB:\n\t\treturn ixgbe_dcb_config_pfc_82598(hw, pfc_en);\n\tcase ixgbe_mac_82599EB:\n\tcase ixgbe_mac_X540:\n\tcase ixgbe_mac_X550:\n\tcase ixgbe_mac_X550EM_x:\n\tcase ixgbe_mac_x550em_a:\n\t\treturn ixgbe_dcb_config_pfc_82599(hw, pfc_en, prio_tc);\n\tdefault:\n\t\tbreak;\n\t}\n\treturn -EINVAL;\n}\n\ns32 ixgbe_dcb_hw_ets(struct ixgbe_hw *hw, struct ieee_ets *ets, int max_frame)\n{\n\t__u16 refill[IEEE_8021QAZ_MAX_TCS], max[IEEE_8021QAZ_MAX_TCS];\n\t__u8 prio_type[IEEE_8021QAZ_MAX_TCS];\n\tint i;\n\n\t \n\t__u8 bwg_id[IEEE_8021QAZ_MAX_TCS] = {0, 1, 2, 3, 4, 5, 6, 7};\n\n\t \n\tfor (i = 0; i < IEEE_8021QAZ_MAX_TCS; i++) {\n\t\tswitch (ets->tc_tsa[i]) {\n\t\tcase IEEE_8021QAZ_TSA_STRICT:\n\t\t\tprio_type[i] = 2;\n\t\t\tbreak;\n\t\tcase IEEE_8021QAZ_TSA_ETS:\n\t\t\tprio_type[i] = 0;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t \n\t\t\treturn -EINVAL;\n\t\t}\n\t}\n\n\tixgbe_ieee_credits(ets->tc_tx_bw, refill, max, max_frame);\n\treturn ixgbe_dcb_hw_ets_config(hw, refill, max,\n\t\t\t\t       bwg_id, prio_type, ets->prio_tc);\n}\n\ns32 ixgbe_dcb_hw_ets_config(struct ixgbe_hw *hw,\n\t\t\t    u16 *refill, u16 *max, u8 *bwg_id,\n\t\t\t    u8 *prio_type, u8 *prio_tc)\n{\n\tswitch (hw->mac.type) {\n\tcase ixgbe_mac_82598EB:\n\t\tixgbe_dcb_config_rx_arbiter_82598(hw, refill, max,\n\t\t\t\t\t\t\tprio_type);\n\t\tixgbe_dcb_config_tx_desc_arbiter_82598(hw, refill, max,\n\t\t\t\t\t\t\t     bwg_id, prio_type);\n\t\tixgbe_dcb_config_tx_data_arbiter_82598(hw, refill, max,\n\t\t\t\t\t\t\t     bwg_id, prio_type);\n\t\tbreak;\n\tcase ixgbe_mac_82599EB:\n\tcase ixgbe_mac_X540:\n\tcase ixgbe_mac_X550:\n\tcase ixgbe_mac_X550EM_x:\n\tcase ixgbe_mac_x550em_a:\n\t\tixgbe_dcb_config_rx_arbiter_82599(hw, refill, max,\n\t\t\t\t\t\t  bwg_id, prio_type, prio_tc);\n\t\tixgbe_dcb_config_tx_desc_arbiter_82599(hw, refill, max,\n\t\t\t\t\t\t       bwg_id, prio_type);\n\t\tixgbe_dcb_config_tx_data_arbiter_82599(hw, refill, max, bwg_id,\n\t\t\t\t\t\t       prio_type, prio_tc);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic void ixgbe_dcb_read_rtrup2tc_82599(struct ixgbe_hw *hw, u8 *map)\n{\n\tu32 reg, i;\n\n\treg = IXGBE_READ_REG(hw, IXGBE_RTRUP2TC);\n\tfor (i = 0; i < MAX_USER_PRIORITY; i++)\n\t\tmap[i] = IXGBE_RTRUP2TC_UP_MASK &\n\t\t\t(reg >> (i * IXGBE_RTRUP2TC_UP_SHIFT));\n}\n\nvoid ixgbe_dcb_read_rtrup2tc(struct ixgbe_hw *hw, u8 *map)\n{\n\tswitch (hw->mac.type) {\n\tcase ixgbe_mac_82599EB:\n\tcase ixgbe_mac_X540:\n\tcase ixgbe_mac_X550:\n\tcase ixgbe_mac_X550EM_x:\n\tcase ixgbe_mac_x550em_a:\n\t\tixgbe_dcb_read_rtrup2tc_82599(hw, map);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}