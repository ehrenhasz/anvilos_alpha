{
  "module_name": "tsnep_xdp.c",
  "hash_id": "8024295e48fb22c8391c1ddb250815cc4fc5174087ee18a1cd6f05bc515d2e1e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/engleder/tsnep_xdp.c",
  "human_readable_source": "\n \n\n#include <linux/if_vlan.h>\n#include <net/xdp_sock_drv.h>\n\n#include \"tsnep.h\"\n\nint tsnep_xdp_setup_prog(struct tsnep_adapter *adapter, struct bpf_prog *prog,\n\t\t\t struct netlink_ext_ack *extack)\n{\n\tstruct bpf_prog *old_prog;\n\n\told_prog = xchg(&adapter->xdp_prog, prog);\n\tif (old_prog)\n\t\tbpf_prog_put(old_prog);\n\n\treturn 0;\n}\n\nstatic int tsnep_xdp_enable_pool(struct tsnep_adapter *adapter,\n\t\t\t\t struct xsk_buff_pool *pool, u16 queue_id)\n{\n\tstruct tsnep_queue *queue;\n\tint retval;\n\n\tif (queue_id >= adapter->num_rx_queues ||\n\t    queue_id >= adapter->num_tx_queues)\n\t\treturn -EINVAL;\n\n\tqueue = &adapter->queue[queue_id];\n\tif (queue->rx->queue_index != queue_id ||\n\t    queue->tx->queue_index != queue_id) {\n\t\tnetdev_err(adapter->netdev,\n\t\t\t   \"XSK support only for TX/RX queue pairs\\n\");\n\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tretval = xsk_pool_dma_map(pool, adapter->dmadev,\n\t\t\t\t  DMA_ATTR_SKIP_CPU_SYNC);\n\tif (retval) {\n\t\tnetdev_err(adapter->netdev, \"failed to map XSK pool\\n\");\n\n\t\treturn retval;\n\t}\n\n\tretval = tsnep_enable_xsk(queue, pool);\n\tif (retval) {\n\t\txsk_pool_dma_unmap(pool, DMA_ATTR_SKIP_CPU_SYNC);\n\n\t\treturn retval;\n\t}\n\n\treturn 0;\n}\n\nstatic int tsnep_xdp_disable_pool(struct tsnep_adapter *adapter, u16 queue_id)\n{\n\tstruct xsk_buff_pool *pool;\n\tstruct tsnep_queue *queue;\n\n\tif (queue_id >= adapter->num_rx_queues ||\n\t    queue_id >= adapter->num_tx_queues)\n\t\treturn -EINVAL;\n\n\tpool = xsk_get_pool_from_qid(adapter->netdev, queue_id);\n\tif (!pool)\n\t\treturn -EINVAL;\n\n\tqueue = &adapter->queue[queue_id];\n\n\ttsnep_disable_xsk(queue);\n\n\txsk_pool_dma_unmap(pool, DMA_ATTR_SKIP_CPU_SYNC);\n\n\treturn 0;\n}\n\nint tsnep_xdp_setup_pool(struct tsnep_adapter *adapter,\n\t\t\t struct xsk_buff_pool *pool, u16 queue_id)\n{\n\treturn pool ? tsnep_xdp_enable_pool(adapter, pool, queue_id) :\n\t\t      tsnep_xdp_disable_pool(adapter, queue_id);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}