{
  "module_name": "tsnep_ethtool.c",
  "hash_id": "a37c97d936831966027a022cb9dd43cc3f4e9c759a3b09d6d026ddfe826004e3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/engleder/tsnep_ethtool.c",
  "human_readable_source": "\n \n\n#include \"tsnep.h\"\n\nstatic const char tsnep_stats_strings[][ETH_GSTRING_LEN] = {\n\t\"rx_packets\",\n\t\"rx_bytes\",\n\t\"rx_dropped\",\n\t\"rx_multicast\",\n\t\"rx_alloc_failed\",\n\t\"rx_phy_errors\",\n\t\"rx_forwarded_phy_errors\",\n\t\"rx_invalid_frame_errors\",\n\t\"tx_packets\",\n\t\"tx_bytes\",\n\t\"tx_dropped\",\n};\n\nstruct tsnep_stats {\n\tu64 rx_packets;\n\tu64 rx_bytes;\n\tu64 rx_dropped;\n\tu64 rx_multicast;\n\tu64 rx_alloc_failed;\n\tu64 rx_phy_errors;\n\tu64 rx_forwarded_phy_errors;\n\tu64 rx_invalid_frame_errors;\n\tu64 tx_packets;\n\tu64 tx_bytes;\n\tu64 tx_dropped;\n};\n\n#define TSNEP_STATS_COUNT (sizeof(struct tsnep_stats) / sizeof(u64))\n\nstatic const char tsnep_rx_queue_stats_strings[][ETH_GSTRING_LEN] = {\n\t\"rx_%d_packets\",\n\t\"rx_%d_bytes\",\n\t\"rx_%d_dropped\",\n\t\"rx_%d_multicast\",\n\t\"rx_%d_alloc_failed\",\n\t\"rx_%d_no_descriptor_errors\",\n\t\"rx_%d_buffer_too_small_errors\",\n\t\"rx_%d_fifo_overflow_errors\",\n\t\"rx_%d_invalid_frame_errors\",\n};\n\nstruct tsnep_rx_queue_stats {\n\tu64 rx_packets;\n\tu64 rx_bytes;\n\tu64 rx_dropped;\n\tu64 rx_multicast;\n\tu64 rx_alloc_failed;\n\tu64 rx_no_descriptor_errors;\n\tu64 rx_buffer_too_small_errors;\n\tu64 rx_fifo_overflow_errors;\n\tu64 rx_invalid_frame_errors;\n};\n\n#define TSNEP_RX_QUEUE_STATS_COUNT (sizeof(struct tsnep_rx_queue_stats) / \\\n\t\t\t\t    sizeof(u64))\n\nstatic const char tsnep_tx_queue_stats_strings[][ETH_GSTRING_LEN] = {\n\t\"tx_%d_packets\",\n\t\"tx_%d_bytes\",\n\t\"tx_%d_dropped\",\n};\n\nstruct tsnep_tx_queue_stats {\n\tu64 tx_packets;\n\tu64 tx_bytes;\n\tu64 tx_dropped;\n};\n\n#define TSNEP_TX_QUEUE_STATS_COUNT (sizeof(struct tsnep_tx_queue_stats) / \\\n\t\t\t\t    sizeof(u64))\n\nstatic void tsnep_ethtool_get_drvinfo(struct net_device *netdev,\n\t\t\t\t      struct ethtool_drvinfo *drvinfo)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\n\tstrscpy(drvinfo->driver, TSNEP, sizeof(drvinfo->driver));\n\tstrscpy(drvinfo->bus_info, dev_name(&adapter->pdev->dev),\n\t\tsizeof(drvinfo->bus_info));\n}\n\nstatic int tsnep_ethtool_get_regs_len(struct net_device *netdev)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\tint len;\n\tint num_additional_queues;\n\n\tlen = TSNEP_MAC_SIZE;\n\n\t \n\tnum_additional_queues =\n\t\tmax(adapter->num_tx_queues, adapter->num_rx_queues) - 1;\n\tlen += TSNEP_QUEUE_SIZE * num_additional_queues;\n\n\treturn len;\n}\n\nstatic void tsnep_ethtool_get_regs(struct net_device *netdev,\n\t\t\t\t   struct ethtool_regs *regs,\n\t\t\t\t   void *p)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\n\tregs->version = 1;\n\n\tmemcpy_fromio(p, adapter->addr, regs->len);\n}\n\nstatic u32 tsnep_ethtool_get_msglevel(struct net_device *netdev)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\n\treturn adapter->msg_enable;\n}\n\nstatic void tsnep_ethtool_set_msglevel(struct net_device *netdev, u32 data)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\n\tadapter->msg_enable = data;\n}\n\nstatic void tsnep_ethtool_get_strings(struct net_device *netdev, u32 stringset,\n\t\t\t\t      u8 *data)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\tint rx_count = adapter->num_rx_queues;\n\tint tx_count = adapter->num_tx_queues;\n\tint i, j;\n\n\tswitch (stringset) {\n\tcase ETH_SS_STATS:\n\t\tmemcpy(data, tsnep_stats_strings, sizeof(tsnep_stats_strings));\n\t\tdata += sizeof(tsnep_stats_strings);\n\n\t\tfor (i = 0; i < rx_count; i++) {\n\t\t\tfor (j = 0; j < TSNEP_RX_QUEUE_STATS_COUNT; j++) {\n\t\t\t\tsnprintf(data, ETH_GSTRING_LEN,\n\t\t\t\t\t tsnep_rx_queue_stats_strings[j], i);\n\t\t\t\tdata += ETH_GSTRING_LEN;\n\t\t\t}\n\t\t}\n\n\t\tfor (i = 0; i < tx_count; i++) {\n\t\t\tfor (j = 0; j < TSNEP_TX_QUEUE_STATS_COUNT; j++) {\n\t\t\t\tsnprintf(data, ETH_GSTRING_LEN,\n\t\t\t\t\t tsnep_tx_queue_stats_strings[j], i);\n\t\t\t\tdata += ETH_GSTRING_LEN;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\tcase ETH_SS_TEST:\n\t\ttsnep_ethtool_get_test_strings(data);\n\t\tbreak;\n\t}\n}\n\nstatic void tsnep_ethtool_get_ethtool_stats(struct net_device *netdev,\n\t\t\t\t\t    struct ethtool_stats *stats,\n\t\t\t\t\t    u64 *data)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\tint rx_count = adapter->num_rx_queues;\n\tint tx_count = adapter->num_tx_queues;\n\tstruct tsnep_stats tsnep_stats;\n\tstruct tsnep_rx_queue_stats tsnep_rx_queue_stats;\n\tstruct tsnep_tx_queue_stats tsnep_tx_queue_stats;\n\tu32 reg;\n\tint i;\n\n\tmemset(&tsnep_stats, 0, sizeof(tsnep_stats));\n\tfor (i = 0; i < adapter->num_rx_queues; i++) {\n\t\ttsnep_stats.rx_packets += adapter->rx[i].packets;\n\t\ttsnep_stats.rx_bytes += adapter->rx[i].bytes;\n\t\ttsnep_stats.rx_dropped += adapter->rx[i].dropped;\n\t\ttsnep_stats.rx_multicast += adapter->rx[i].multicast;\n\t\ttsnep_stats.rx_alloc_failed += adapter->rx[i].alloc_failed;\n\t}\n\treg = ioread32(adapter->addr + ECM_STAT);\n\ttsnep_stats.rx_phy_errors =\n\t\t(reg & ECM_STAT_RX_ERR_MASK) >> ECM_STAT_RX_ERR_SHIFT;\n\ttsnep_stats.rx_forwarded_phy_errors =\n\t\t(reg & ECM_STAT_FWD_RX_ERR_MASK) >> ECM_STAT_FWD_RX_ERR_SHIFT;\n\ttsnep_stats.rx_invalid_frame_errors =\n\t\t(reg & ECM_STAT_INV_FRM_MASK) >> ECM_STAT_INV_FRM_SHIFT;\n\tfor (i = 0; i < adapter->num_tx_queues; i++) {\n\t\ttsnep_stats.tx_packets += adapter->tx[i].packets;\n\t\ttsnep_stats.tx_bytes += adapter->tx[i].bytes;\n\t\ttsnep_stats.tx_dropped += adapter->tx[i].dropped;\n\t}\n\tmemcpy(data, &tsnep_stats, sizeof(tsnep_stats));\n\tdata += TSNEP_STATS_COUNT;\n\n\tfor (i = 0; i < rx_count; i++) {\n\t\tmemset(&tsnep_rx_queue_stats, 0, sizeof(tsnep_rx_queue_stats));\n\t\ttsnep_rx_queue_stats.rx_packets = adapter->rx[i].packets;\n\t\ttsnep_rx_queue_stats.rx_bytes = adapter->rx[i].bytes;\n\t\ttsnep_rx_queue_stats.rx_dropped = adapter->rx[i].dropped;\n\t\ttsnep_rx_queue_stats.rx_multicast = adapter->rx[i].multicast;\n\t\ttsnep_rx_queue_stats.rx_alloc_failed =\n\t\t\tadapter->rx[i].alloc_failed;\n\t\treg = ioread32(adapter->addr + TSNEP_QUEUE(i) +\n\t\t\t       TSNEP_RX_STATISTIC);\n\t\ttsnep_rx_queue_stats.rx_no_descriptor_errors =\n\t\t\t(reg & TSNEP_RX_STATISTIC_NO_DESC_MASK) >>\n\t\t\tTSNEP_RX_STATISTIC_NO_DESC_SHIFT;\n\t\ttsnep_rx_queue_stats.rx_buffer_too_small_errors =\n\t\t\t(reg & TSNEP_RX_STATISTIC_BUFFER_TOO_SMALL_MASK) >>\n\t\t\tTSNEP_RX_STATISTIC_BUFFER_TOO_SMALL_SHIFT;\n\t\ttsnep_rx_queue_stats.rx_fifo_overflow_errors =\n\t\t\t(reg & TSNEP_RX_STATISTIC_FIFO_OVERFLOW_MASK) >>\n\t\t\tTSNEP_RX_STATISTIC_FIFO_OVERFLOW_SHIFT;\n\t\ttsnep_rx_queue_stats.rx_invalid_frame_errors =\n\t\t\t(reg & TSNEP_RX_STATISTIC_INVALID_FRAME_MASK) >>\n\t\t\tTSNEP_RX_STATISTIC_INVALID_FRAME_SHIFT;\n\t\tmemcpy(data, &tsnep_rx_queue_stats,\n\t\t       sizeof(tsnep_rx_queue_stats));\n\t\tdata += TSNEP_RX_QUEUE_STATS_COUNT;\n\t}\n\n\tfor (i = 0; i < tx_count; i++) {\n\t\tmemset(&tsnep_tx_queue_stats, 0, sizeof(tsnep_tx_queue_stats));\n\t\ttsnep_tx_queue_stats.tx_packets += adapter->tx[i].packets;\n\t\ttsnep_tx_queue_stats.tx_bytes += adapter->tx[i].bytes;\n\t\ttsnep_tx_queue_stats.tx_dropped += adapter->tx[i].dropped;\n\t\tmemcpy(data, &tsnep_tx_queue_stats,\n\t\t       sizeof(tsnep_tx_queue_stats));\n\t\tdata += TSNEP_TX_QUEUE_STATS_COUNT;\n\t}\n}\n\nstatic int tsnep_ethtool_get_sset_count(struct net_device *netdev, int sset)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\tint rx_count;\n\tint tx_count;\n\n\tswitch (sset) {\n\tcase ETH_SS_STATS:\n\t\trx_count = adapter->num_rx_queues;\n\t\ttx_count = adapter->num_tx_queues;\n\t\treturn TSNEP_STATS_COUNT +\n\t\t       TSNEP_RX_QUEUE_STATS_COUNT * rx_count +\n\t\t       TSNEP_TX_QUEUE_STATS_COUNT * tx_count;\n\tcase ETH_SS_TEST:\n\t\treturn tsnep_ethtool_get_test_count();\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int tsnep_ethtool_get_rxnfc(struct net_device *netdev,\n\t\t\t\t   struct ethtool_rxnfc *cmd, u32 *rule_locs)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\n\tswitch (cmd->cmd) {\n\tcase ETHTOOL_GRXRINGS:\n\t\tcmd->data = adapter->num_rx_queues;\n\t\treturn 0;\n\tcase ETHTOOL_GRXCLSRLCNT:\n\t\tcmd->rule_cnt = adapter->rxnfc_count;\n\t\tcmd->data = adapter->rxnfc_max;\n\t\tcmd->data |= RX_CLS_LOC_SPECIAL;\n\t\treturn 0;\n\tcase ETHTOOL_GRXCLSRULE:\n\t\treturn tsnep_rxnfc_get_rule(adapter, cmd);\n\tcase ETHTOOL_GRXCLSRLALL:\n\t\treturn tsnep_rxnfc_get_all(adapter, cmd, rule_locs);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int tsnep_ethtool_set_rxnfc(struct net_device *netdev,\n\t\t\t\t   struct ethtool_rxnfc *cmd)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\n\tswitch (cmd->cmd) {\n\tcase ETHTOOL_SRXCLSRLINS:\n\t\treturn tsnep_rxnfc_add_rule(adapter, cmd);\n\tcase ETHTOOL_SRXCLSRLDEL:\n\t\treturn tsnep_rxnfc_del_rule(adapter, cmd);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic void tsnep_ethtool_get_channels(struct net_device *netdev,\n\t\t\t\t       struct ethtool_channels *ch)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\n\tch->max_combined = adapter->num_queues;\n\tch->combined_count = adapter->num_queues;\n}\n\nstatic int tsnep_ethtool_get_ts_info(struct net_device *netdev,\n\t\t\t\t     struct ethtool_ts_info *info)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\n\tinfo->so_timestamping = SOF_TIMESTAMPING_TX_SOFTWARE |\n\t\t\t\tSOF_TIMESTAMPING_RX_SOFTWARE |\n\t\t\t\tSOF_TIMESTAMPING_SOFTWARE |\n\t\t\t\tSOF_TIMESTAMPING_TX_HARDWARE |\n\t\t\t\tSOF_TIMESTAMPING_RX_HARDWARE |\n\t\t\t\tSOF_TIMESTAMPING_RAW_HARDWARE;\n\n\tif (adapter->ptp_clock)\n\t\tinfo->phc_index = ptp_clock_index(adapter->ptp_clock);\n\telse\n\t\tinfo->phc_index = -1;\n\n\tinfo->tx_types = BIT(HWTSTAMP_TX_OFF) |\n\t\t\t BIT(HWTSTAMP_TX_ON);\n\tinfo->rx_filters = BIT(HWTSTAMP_FILTER_NONE) |\n\t\t\t   BIT(HWTSTAMP_FILTER_ALL);\n\n\treturn 0;\n}\n\nstatic struct tsnep_queue *tsnep_get_queue_with_tx(struct tsnep_adapter *adapter,\n\t\t\t\t\t\t   int index)\n{\n\tint i;\n\n\tfor (i = 0; i < adapter->num_queues; i++) {\n\t\tif (adapter->queue[i].tx) {\n\t\t\tif (index == 0)\n\t\t\t\treturn &adapter->queue[i];\n\n\t\t\tindex--;\n\t\t}\n\t}\n\n\treturn NULL;\n}\n\nstatic struct tsnep_queue *tsnep_get_queue_with_rx(struct tsnep_adapter *adapter,\n\t\t\t\t\t\t   int index)\n{\n\tint i;\n\n\tfor (i = 0; i < adapter->num_queues; i++) {\n\t\tif (adapter->queue[i].rx) {\n\t\t\tif (index == 0)\n\t\t\t\treturn &adapter->queue[i];\n\n\t\t\tindex--;\n\t\t}\n\t}\n\n\treturn NULL;\n}\n\nstatic int tsnep_ethtool_get_coalesce(struct net_device *netdev,\n\t\t\t\t      struct ethtool_coalesce *ec,\n\t\t\t\t      struct kernel_ethtool_coalesce *kernel_coal,\n\t\t\t\t      struct netlink_ext_ack *extack)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\tstruct tsnep_queue *queue;\n\n\tqueue = tsnep_get_queue_with_rx(adapter, 0);\n\tif (queue)\n\t\tec->rx_coalesce_usecs = tsnep_get_irq_coalesce(queue);\n\n\tqueue = tsnep_get_queue_with_tx(adapter, 0);\n\tif (queue)\n\t\tec->tx_coalesce_usecs = tsnep_get_irq_coalesce(queue);\n\n\treturn 0;\n}\n\nstatic int tsnep_ethtool_set_coalesce(struct net_device *netdev,\n\t\t\t\t      struct ethtool_coalesce *ec,\n\t\t\t\t      struct kernel_ethtool_coalesce *kernel_coal,\n\t\t\t\t      struct netlink_ext_ack *extack)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\tint i;\n\tint retval;\n\n\tfor (i = 0; i < adapter->num_queues; i++) {\n\t\t \n\t\tif (adapter->queue[i].rx)\n\t\t\tretval = tsnep_set_irq_coalesce(&adapter->queue[i],\n\t\t\t\t\t\t\tec->rx_coalesce_usecs);\n\t\telse\n\t\t\tretval = tsnep_set_irq_coalesce(&adapter->queue[i],\n\t\t\t\t\t\t\tec->tx_coalesce_usecs);\n\t\tif (retval != 0)\n\t\t\treturn retval;\n\t}\n\n\treturn 0;\n}\n\nstatic int tsnep_ethtool_get_per_queue_coalesce(struct net_device *netdev,\n\t\t\t\t\t\tu32 queue,\n\t\t\t\t\t\tstruct ethtool_coalesce *ec)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\tstruct tsnep_queue *queue_with_rx;\n\tstruct tsnep_queue *queue_with_tx;\n\n\tif (queue >= max(adapter->num_tx_queues, adapter->num_rx_queues))\n\t\treturn -EINVAL;\n\n\tqueue_with_rx = tsnep_get_queue_with_rx(adapter, queue);\n\tif (queue_with_rx)\n\t\tec->rx_coalesce_usecs = tsnep_get_irq_coalesce(queue_with_rx);\n\n\tqueue_with_tx = tsnep_get_queue_with_tx(adapter, queue);\n\tif (queue_with_tx)\n\t\tec->tx_coalesce_usecs = tsnep_get_irq_coalesce(queue_with_tx);\n\n\treturn 0;\n}\n\nstatic int tsnep_ethtool_set_per_queue_coalesce(struct net_device *netdev,\n\t\t\t\t\t\tu32 queue,\n\t\t\t\t\t\tstruct ethtool_coalesce *ec)\n{\n\tstruct tsnep_adapter *adapter = netdev_priv(netdev);\n\tstruct tsnep_queue *queue_with_rx;\n\tstruct tsnep_queue *queue_with_tx;\n\tint retval;\n\n\tif (queue >= max(adapter->num_tx_queues, adapter->num_rx_queues))\n\t\treturn -EINVAL;\n\n\tqueue_with_rx = tsnep_get_queue_with_rx(adapter, queue);\n\tif (queue_with_rx) {\n\t\tretval = tsnep_set_irq_coalesce(queue_with_rx, ec->rx_coalesce_usecs);\n\t\tif (retval != 0)\n\t\t\treturn retval;\n\t}\n\n\t \n\tqueue_with_tx = tsnep_get_queue_with_tx(adapter, queue);\n\tif (queue_with_tx && !queue_with_tx->rx) {\n\t\tretval = tsnep_set_irq_coalesce(queue_with_tx, ec->tx_coalesce_usecs);\n\t\tif (retval != 0)\n\t\t\treturn retval;\n\t}\n\n\treturn 0;\n}\n\nconst struct ethtool_ops tsnep_ethtool_ops = {\n\t.supported_coalesce_params = ETHTOOL_COALESCE_USECS,\n\t.get_drvinfo = tsnep_ethtool_get_drvinfo,\n\t.get_regs_len = tsnep_ethtool_get_regs_len,\n\t.get_regs = tsnep_ethtool_get_regs,\n\t.get_msglevel = tsnep_ethtool_get_msglevel,\n\t.set_msglevel = tsnep_ethtool_set_msglevel,\n\t.nway_reset = phy_ethtool_nway_reset,\n\t.get_link = ethtool_op_get_link,\n\t.self_test = tsnep_ethtool_self_test,\n\t.get_strings = tsnep_ethtool_get_strings,\n\t.get_ethtool_stats = tsnep_ethtool_get_ethtool_stats,\n\t.get_sset_count = tsnep_ethtool_get_sset_count,\n\t.get_rxnfc = tsnep_ethtool_get_rxnfc,\n\t.set_rxnfc = tsnep_ethtool_set_rxnfc,\n\t.get_channels = tsnep_ethtool_get_channels,\n\t.get_ts_info = tsnep_ethtool_get_ts_info,\n\t.get_coalesce = tsnep_ethtool_get_coalesce,\n\t.set_coalesce = tsnep_ethtool_set_coalesce,\n\t.get_per_queue_coalesce = tsnep_ethtool_get_per_queue_coalesce,\n\t.set_per_queue_coalesce = tsnep_ethtool_set_per_queue_coalesce,\n\t.get_link_ksettings = phy_ethtool_get_link_ksettings,\n\t.set_link_ksettings = phy_ethtool_set_link_ksettings,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}