{
  "module_name": "dwmac-sunxi.c",
  "hash_id": "45e83de9b1b86224f75e43d22ae2449084225b51805f458d0819349de8310093",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/stmicro/stmmac/dwmac-sunxi.c",
  "human_readable_source": "\n \n\n#include <linux/stmmac.h>\n#include <linux/clk.h>\n#include <linux/module.h>\n#include <linux/phy.h>\n#include <linux/platform_device.h>\n#include <linux/of_net.h>\n#include <linux/regulator/consumer.h>\n\n#include \"stmmac_platform.h\"\n\nstruct sunxi_priv_data {\n\tphy_interface_t interface;\n\tint clk_enabled;\n\tstruct clk *tx_clk;\n\tstruct regulator *regulator;\n};\n\n#define SUN7I_GMAC_GMII_RGMII_RATE\t125000000\n#define SUN7I_GMAC_MII_RATE\t\t25000000\n\nstatic int sun7i_gmac_init(struct platform_device *pdev, void *priv)\n{\n\tstruct sunxi_priv_data *gmac = priv;\n\tint ret = 0;\n\n\tif (gmac->regulator) {\n\t\tret = regulator_enable(gmac->regulator);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (phy_interface_mode_is_rgmii(gmac->interface)) {\n\t\tclk_set_rate(gmac->tx_clk, SUN7I_GMAC_GMII_RGMII_RATE);\n\t\tclk_prepare_enable(gmac->tx_clk);\n\t\tgmac->clk_enabled = 1;\n\t} else {\n\t\tclk_set_rate(gmac->tx_clk, SUN7I_GMAC_MII_RATE);\n\t\tret = clk_prepare(gmac->tx_clk);\n\t\tif (ret && gmac->regulator)\n\t\t\tregulator_disable(gmac->regulator);\n\t}\n\n\treturn ret;\n}\n\nstatic void sun7i_gmac_exit(struct platform_device *pdev, void *priv)\n{\n\tstruct sunxi_priv_data *gmac = priv;\n\n\tif (gmac->clk_enabled) {\n\t\tclk_disable(gmac->tx_clk);\n\t\tgmac->clk_enabled = 0;\n\t}\n\tclk_unprepare(gmac->tx_clk);\n\n\tif (gmac->regulator)\n\t\tregulator_disable(gmac->regulator);\n}\n\nstatic void sun7i_fix_speed(void *priv, unsigned int speed, unsigned int mode)\n{\n\tstruct sunxi_priv_data *gmac = priv;\n\n\t \n\tif (gmac->interface != PHY_INTERFACE_MODE_GMII)\n\t\treturn;\n\n\tif (gmac->clk_enabled) {\n\t\tclk_disable(gmac->tx_clk);\n\t\tgmac->clk_enabled = 0;\n\t}\n\tclk_unprepare(gmac->tx_clk);\n\n\tif (speed == 1000) {\n\t\tclk_set_rate(gmac->tx_clk, SUN7I_GMAC_GMII_RGMII_RATE);\n\t\tclk_prepare_enable(gmac->tx_clk);\n\t\tgmac->clk_enabled = 1;\n\t} else {\n\t\tclk_set_rate(gmac->tx_clk, SUN7I_GMAC_MII_RATE);\n\t\tclk_prepare(gmac->tx_clk);\n\t}\n}\n\nstatic int sun7i_gmac_probe(struct platform_device *pdev)\n{\n\tstruct plat_stmmacenet_data *plat_dat;\n\tstruct stmmac_resources stmmac_res;\n\tstruct sunxi_priv_data *gmac;\n\tstruct device *dev = &pdev->dev;\n\tint ret;\n\n\tret = stmmac_get_platform_resources(pdev, &stmmac_res);\n\tif (ret)\n\t\treturn ret;\n\n\tplat_dat = stmmac_probe_config_dt(pdev, stmmac_res.mac);\n\tif (IS_ERR(plat_dat))\n\t\treturn PTR_ERR(plat_dat);\n\n\tgmac = devm_kzalloc(dev, sizeof(*gmac), GFP_KERNEL);\n\tif (!gmac) {\n\t\tret = -ENOMEM;\n\t\tgoto err_remove_config_dt;\n\t}\n\n\tret = of_get_phy_mode(dev->of_node, &gmac->interface);\n\tif (ret && ret != -ENODEV) {\n\t\tdev_err(dev, \"Can't get phy-mode\\n\");\n\t\tgoto err_remove_config_dt;\n\t}\n\n\tgmac->tx_clk = devm_clk_get(dev, \"allwinner_gmac_tx\");\n\tif (IS_ERR(gmac->tx_clk)) {\n\t\tdev_err(dev, \"could not get tx clock\\n\");\n\t\tret = PTR_ERR(gmac->tx_clk);\n\t\tgoto err_remove_config_dt;\n\t}\n\n\t \n\tgmac->regulator = devm_regulator_get_optional(dev, \"phy\");\n\tif (IS_ERR(gmac->regulator)) {\n\t\tif (PTR_ERR(gmac->regulator) == -EPROBE_DEFER) {\n\t\t\tret = -EPROBE_DEFER;\n\t\t\tgoto err_remove_config_dt;\n\t\t}\n\t\tdev_info(dev, \"no regulator found\\n\");\n\t\tgmac->regulator = NULL;\n\t}\n\n\t \n\tplat_dat->tx_coe = 1;\n\tplat_dat->has_gmac = true;\n\tplat_dat->bsp_priv = gmac;\n\tplat_dat->init = sun7i_gmac_init;\n\tplat_dat->exit = sun7i_gmac_exit;\n\tplat_dat->fix_mac_speed = sun7i_fix_speed;\n\tplat_dat->tx_fifo_size = 4096;\n\tplat_dat->rx_fifo_size = 16384;\n\n\tret = sun7i_gmac_init(pdev, plat_dat->bsp_priv);\n\tif (ret)\n\t\tgoto err_remove_config_dt;\n\n\tret = stmmac_dvr_probe(&pdev->dev, plat_dat, &stmmac_res);\n\tif (ret)\n\t\tgoto err_gmac_exit;\n\n\treturn 0;\n\nerr_gmac_exit:\n\tsun7i_gmac_exit(pdev, plat_dat->bsp_priv);\nerr_remove_config_dt:\n\tstmmac_remove_config_dt(pdev, plat_dat);\n\n\treturn ret;\n}\n\nstatic const struct of_device_id sun7i_dwmac_match[] = {\n\t{ .compatible = \"allwinner,sun7i-a20-gmac\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, sun7i_dwmac_match);\n\nstatic struct platform_driver sun7i_dwmac_driver = {\n\t.probe  = sun7i_gmac_probe,\n\t.remove_new = stmmac_pltfr_remove,\n\t.driver = {\n\t\t.name           = \"sun7i-dwmac\",\n\t\t.pm\t\t= &stmmac_pltfr_pm_ops,\n\t\t.of_match_table = sun7i_dwmac_match,\n\t},\n};\nmodule_platform_driver(sun7i_dwmac_driver);\n\nMODULE_AUTHOR(\"Chen-Yu Tsai <wens@csie.org>\");\nMODULE_DESCRIPTION(\"Allwinner sunxi DWMAC specific glue layer\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}