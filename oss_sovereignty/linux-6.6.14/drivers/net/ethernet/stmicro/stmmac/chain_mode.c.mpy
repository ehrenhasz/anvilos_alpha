{
  "module_name": "chain_mode.c",
  "hash_id": "d622701443e207c7279483ea89483f846642ad3446666df281c8071a145b0a17",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/stmicro/stmmac/chain_mode.c",
  "human_readable_source": "\n \n\n#include \"stmmac.h\"\n\nstatic int jumbo_frm(struct stmmac_tx_queue *tx_q, struct sk_buff *skb,\n\t\t     int csum)\n{\n\tunsigned int nopaged_len = skb_headlen(skb);\n\tstruct stmmac_priv *priv = tx_q->priv_data;\n\tunsigned int entry = tx_q->cur_tx;\n\tunsigned int bmax, des2;\n\tunsigned int i = 1, len;\n\tstruct dma_desc *desc;\n\n\tdesc = tx_q->dma_tx + entry;\n\n\tif (priv->plat->enh_desc)\n\t\tbmax = BUF_SIZE_8KiB;\n\telse\n\t\tbmax = BUF_SIZE_2KiB;\n\n\tlen = nopaged_len - bmax;\n\n\tdes2 = dma_map_single(priv->device, skb->data,\n\t\t\t      bmax, DMA_TO_DEVICE);\n\tdesc->des2 = cpu_to_le32(des2);\n\tif (dma_mapping_error(priv->device, des2))\n\t\treturn -1;\n\ttx_q->tx_skbuff_dma[entry].buf = des2;\n\ttx_q->tx_skbuff_dma[entry].len = bmax;\n\t \n\tstmmac_prepare_tx_desc(priv, desc, 1, bmax, csum, STMMAC_CHAIN_MODE,\n\t\t\t0, false, skb->len);\n\n\twhile (len != 0) {\n\t\ttx_q->tx_skbuff[entry] = NULL;\n\t\tentry = STMMAC_GET_ENTRY(entry, priv->dma_conf.dma_tx_size);\n\t\tdesc = tx_q->dma_tx + entry;\n\n\t\tif (len > bmax) {\n\t\t\tdes2 = dma_map_single(priv->device,\n\t\t\t\t\t      (skb->data + bmax * i),\n\t\t\t\t\t      bmax, DMA_TO_DEVICE);\n\t\t\tdesc->des2 = cpu_to_le32(des2);\n\t\t\tif (dma_mapping_error(priv->device, des2))\n\t\t\t\treturn -1;\n\t\t\ttx_q->tx_skbuff_dma[entry].buf = des2;\n\t\t\ttx_q->tx_skbuff_dma[entry].len = bmax;\n\t\t\tstmmac_prepare_tx_desc(priv, desc, 0, bmax, csum,\n\t\t\t\t\tSTMMAC_CHAIN_MODE, 1, false, skb->len);\n\t\t\tlen -= bmax;\n\t\t\ti++;\n\t\t} else {\n\t\t\tdes2 = dma_map_single(priv->device,\n\t\t\t\t\t      (skb->data + bmax * i), len,\n\t\t\t\t\t      DMA_TO_DEVICE);\n\t\t\tdesc->des2 = cpu_to_le32(des2);\n\t\t\tif (dma_mapping_error(priv->device, des2))\n\t\t\t\treturn -1;\n\t\t\ttx_q->tx_skbuff_dma[entry].buf = des2;\n\t\t\ttx_q->tx_skbuff_dma[entry].len = len;\n\t\t\t \n\t\t\tstmmac_prepare_tx_desc(priv, desc, 0, len, csum,\n\t\t\t\t\tSTMMAC_CHAIN_MODE, 1, true, skb->len);\n\t\t\tlen = 0;\n\t\t}\n\t}\n\n\ttx_q->cur_tx = entry;\n\n\treturn entry;\n}\n\nstatic unsigned int is_jumbo_frm(int len, int enh_desc)\n{\n\tunsigned int ret = 0;\n\n\tif ((enh_desc && (len > BUF_SIZE_8KiB)) ||\n\t    (!enh_desc && (len > BUF_SIZE_2KiB))) {\n\t\tret = 1;\n\t}\n\n\treturn ret;\n}\n\nstatic void init_dma_chain(void *des, dma_addr_t phy_addr,\n\t\t\t\t  unsigned int size, unsigned int extend_desc)\n{\n\t \n\tint i;\n\tdma_addr_t dma_phy = phy_addr;\n\n\tif (extend_desc) {\n\t\tstruct dma_extended_desc *p = (struct dma_extended_desc *)des;\n\t\tfor (i = 0; i < (size - 1); i++) {\n\t\t\tdma_phy += sizeof(struct dma_extended_desc);\n\t\t\tp->basic.des3 = cpu_to_le32((unsigned int)dma_phy);\n\t\t\tp++;\n\t\t}\n\t\tp->basic.des3 = cpu_to_le32((unsigned int)phy_addr);\n\n\t} else {\n\t\tstruct dma_desc *p = (struct dma_desc *)des;\n\t\tfor (i = 0; i < (size - 1); i++) {\n\t\t\tdma_phy += sizeof(struct dma_desc);\n\t\t\tp->des3 = cpu_to_le32((unsigned int)dma_phy);\n\t\t\tp++;\n\t\t}\n\t\tp->des3 = cpu_to_le32((unsigned int)phy_addr);\n\t}\n}\n\nstatic void refill_desc3(struct stmmac_rx_queue *rx_q, struct dma_desc *p)\n{\n\tstruct stmmac_priv *priv = rx_q->priv_data;\n\n\tif (priv->hwts_rx_en && !priv->extend_desc)\n\t\t \n\t\tp->des3 = cpu_to_le32((unsigned int)(rx_q->dma_rx_phy +\n\t\t\t\t      (((rx_q->dirty_rx) + 1) %\n\t\t\t\t       priv->dma_conf.dma_rx_size) *\n\t\t\t\t      sizeof(struct dma_desc)));\n}\n\nstatic void clean_desc3(struct stmmac_tx_queue *tx_q, struct dma_desc *p)\n{\n\tstruct stmmac_priv *priv = tx_q->priv_data;\n\tunsigned int entry = tx_q->dirty_tx;\n\n\tif (tx_q->tx_skbuff_dma[entry].last_segment && !priv->extend_desc &&\n\t    priv->hwts_tx_en)\n\t\t \n\t\tp->des3 = cpu_to_le32((unsigned int)((tx_q->dma_tx_phy +\n\t\t\t\t      ((tx_q->dirty_tx + 1) %\n\t\t\t\t       priv->dma_conf.dma_tx_size))\n\t\t\t\t      * sizeof(struct dma_desc)));\n}\n\nconst struct stmmac_mode_ops chain_mode_ops = {\n\t.init = init_dma_chain,\n\t.is_jumbo_frm = is_jumbo_frm,\n\t.jumbo_frm = jumbo_frm,\n\t.refill_desc3 = refill_desc3,\n\t.clean_desc3 = clean_desc3,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}