{
  "module_name": "dwmac4_dma.c",
  "hash_id": "c12423cde7336dd9299b5d9dc65b67531b8a29ae395381359d118a1fdf10de07",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/stmicro/stmmac/dwmac4_dma.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include \"dwmac4.h\"\n#include \"dwmac4_dma.h\"\n#include \"stmmac.h\"\n\nstatic void dwmac4_dma_axi(void __iomem *ioaddr, struct stmmac_axi *axi)\n{\n\tu32 value = readl(ioaddr + DMA_SYS_BUS_MODE);\n\tint i;\n\n\tpr_info(\"dwmac4: Master AXI performs %s burst length\\n\",\n\t\t(value & DMA_SYS_BUS_FB) ? \"fixed\" : \"any\");\n\n\tif (axi->axi_lpi_en)\n\t\tvalue |= DMA_AXI_EN_LPI;\n\tif (axi->axi_xit_frm)\n\t\tvalue |= DMA_AXI_LPI_XIT_FRM;\n\n\tvalue &= ~DMA_AXI_WR_OSR_LMT;\n\tvalue |= (axi->axi_wr_osr_lmt & DMA_AXI_OSR_MAX) <<\n\t\t DMA_AXI_WR_OSR_LMT_SHIFT;\n\n\tvalue &= ~DMA_AXI_RD_OSR_LMT;\n\tvalue |= (axi->axi_rd_osr_lmt & DMA_AXI_OSR_MAX) <<\n\t\t DMA_AXI_RD_OSR_LMT_SHIFT;\n\n\t \n\tfor (i = 0; i < AXI_BLEN; i++) {\n\t\tswitch (axi->axi_blen[i]) {\n\t\tcase 256:\n\t\t\tvalue |= DMA_AXI_BLEN256;\n\t\t\tbreak;\n\t\tcase 128:\n\t\t\tvalue |= DMA_AXI_BLEN128;\n\t\t\tbreak;\n\t\tcase 64:\n\t\t\tvalue |= DMA_AXI_BLEN64;\n\t\t\tbreak;\n\t\tcase 32:\n\t\t\tvalue |= DMA_AXI_BLEN32;\n\t\t\tbreak;\n\t\tcase 16:\n\t\t\tvalue |= DMA_AXI_BLEN16;\n\t\t\tbreak;\n\t\tcase 8:\n\t\t\tvalue |= DMA_AXI_BLEN8;\n\t\t\tbreak;\n\t\tcase 4:\n\t\t\tvalue |= DMA_AXI_BLEN4;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\twritel(value, ioaddr + DMA_SYS_BUS_MODE);\n}\n\nstatic void dwmac4_dma_init_rx_chan(struct stmmac_priv *priv,\n\t\t\t\t    void __iomem *ioaddr,\n\t\t\t\t    struct stmmac_dma_cfg *dma_cfg,\n\t\t\t\t    dma_addr_t dma_rx_phy, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value;\n\tu32 rxpbl = dma_cfg->rxpbl ?: dma_cfg->pbl;\n\n\tvalue = readl(ioaddr + DMA_CHAN_RX_CONTROL(dwmac4_addrs, chan));\n\tvalue = value | (rxpbl << DMA_BUS_MODE_RPBL_SHIFT);\n\twritel(value, ioaddr + DMA_CHAN_RX_CONTROL(dwmac4_addrs, chan));\n\n\tif (IS_ENABLED(CONFIG_ARCH_DMA_ADDR_T_64BIT) && likely(dma_cfg->eame))\n\t\twritel(upper_32_bits(dma_rx_phy),\n\t\t       ioaddr + DMA_CHAN_RX_BASE_ADDR_HI(dwmac4_addrs, chan));\n\n\twritel(lower_32_bits(dma_rx_phy),\n\t       ioaddr + DMA_CHAN_RX_BASE_ADDR(dwmac4_addrs, chan));\n}\n\nstatic void dwmac4_dma_init_tx_chan(struct stmmac_priv *priv,\n\t\t\t\t    void __iomem *ioaddr,\n\t\t\t\t    struct stmmac_dma_cfg *dma_cfg,\n\t\t\t\t    dma_addr_t dma_tx_phy, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value;\n\tu32 txpbl = dma_cfg->txpbl ?: dma_cfg->pbl;\n\n\tvalue = readl(ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\tvalue = value | (txpbl << DMA_BUS_MODE_PBL_SHIFT);\n\n\t \n\tvalue |= DMA_CONTROL_OSP;\n\n\twritel(value, ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\n\tif (IS_ENABLED(CONFIG_ARCH_DMA_ADDR_T_64BIT) && likely(dma_cfg->eame))\n\t\twritel(upper_32_bits(dma_tx_phy),\n\t\t       ioaddr + DMA_CHAN_TX_BASE_ADDR_HI(dwmac4_addrs, chan));\n\n\twritel(lower_32_bits(dma_tx_phy),\n\t       ioaddr + DMA_CHAN_TX_BASE_ADDR(dwmac4_addrs, chan));\n}\n\nstatic void dwmac4_dma_init_channel(struct stmmac_priv *priv,\n\t\t\t\t    void __iomem *ioaddr,\n\t\t\t\t    struct stmmac_dma_cfg *dma_cfg, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value;\n\n\t \n\tvalue = readl(ioaddr + DMA_CHAN_CONTROL(dwmac4_addrs, chan));\n\tif (dma_cfg->pblx8)\n\t\tvalue = value | DMA_BUS_MODE_PBL;\n\twritel(value, ioaddr + DMA_CHAN_CONTROL(dwmac4_addrs, chan));\n\n\t \n\twritel(DMA_CHAN_INTR_DEFAULT_MASK,\n\t       ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n}\n\nstatic void dwmac410_dma_init_channel(struct stmmac_priv *priv,\n\t\t\t\t      void __iomem *ioaddr,\n\t\t\t\t      struct stmmac_dma_cfg *dma_cfg, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value;\n\n\t \n\tvalue = readl(ioaddr + DMA_CHAN_CONTROL(dwmac4_addrs, chan));\n\tif (dma_cfg->pblx8)\n\t\tvalue = value | DMA_BUS_MODE_PBL;\n\n\twritel(value, ioaddr + DMA_CHAN_CONTROL(dwmac4_addrs, chan));\n\n\t \n\twritel(DMA_CHAN_INTR_DEFAULT_MASK_4_10,\n\t       ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n}\n\nstatic void dwmac4_dma_init(void __iomem *ioaddr,\n\t\t\t    struct stmmac_dma_cfg *dma_cfg, int atds)\n{\n\tu32 value = readl(ioaddr + DMA_SYS_BUS_MODE);\n\n\t \n\tif (dma_cfg->fixed_burst)\n\t\tvalue |= DMA_SYS_BUS_FB;\n\n\t \n\tif (dma_cfg->mixed_burst)\n\t\tvalue |= DMA_SYS_BUS_MB;\n\n\tif (dma_cfg->aal)\n\t\tvalue |= DMA_SYS_BUS_AAL;\n\n\tif (dma_cfg->eame)\n\t\tvalue |= DMA_SYS_BUS_EAME;\n\n\twritel(value, ioaddr + DMA_SYS_BUS_MODE);\n\n\tvalue = readl(ioaddr + DMA_BUS_MODE);\n\n\tif (dma_cfg->multi_msi_en) {\n\t\tvalue &= ~DMA_BUS_MODE_INTM_MASK;\n\t\tvalue |= (DMA_BUS_MODE_INTM_MODE1 << DMA_BUS_MODE_INTM_SHIFT);\n\t}\n\n\tif (dma_cfg->dche)\n\t\tvalue |= DMA_BUS_MODE_DCHE;\n\n\twritel(value, ioaddr + DMA_BUS_MODE);\n\n}\n\nstatic void _dwmac4_dump_dma_regs(struct stmmac_priv *priv,\n\t\t\t\t  void __iomem *ioaddr, u32 channel,\n\t\t\t\t  u32 *reg_space)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tconst struct dwmac4_addrs *default_addrs = NULL;\n\n\t \n\treg_space[DMA_CHAN_CONTROL(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_CONTROL(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_TX_CONTROL(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_RX_CONTROL(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_RX_CONTROL(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_TX_BASE_ADDR(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_TX_BASE_ADDR(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_RX_BASE_ADDR(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_RX_BASE_ADDR(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_TX_END_ADDR(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_TX_END_ADDR(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_RX_END_ADDR(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_RX_END_ADDR(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_TX_RING_LEN(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_TX_RING_LEN(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_RX_RING_LEN(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_RX_RING_LEN(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_INTR_ENA(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_RX_WATCHDOG(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_RX_WATCHDOG(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_SLOT_CTRL_STATUS(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_SLOT_CTRL_STATUS(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_CUR_TX_DESC(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_CUR_TX_DESC(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_CUR_RX_DESC(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_CUR_RX_DESC(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_CUR_TX_BUF_ADDR(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_CUR_TX_BUF_ADDR(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_CUR_RX_BUF_ADDR(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_CUR_RX_BUF_ADDR(dwmac4_addrs, channel));\n\treg_space[DMA_CHAN_STATUS(default_addrs, channel) / 4] =\n\t\treadl(ioaddr + DMA_CHAN_STATUS(dwmac4_addrs, channel));\n}\n\nstatic void dwmac4_dump_dma_regs(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t\t u32 *reg_space)\n{\n\tint i;\n\n\tfor (i = 0; i < DMA_CHANNEL_NB_MAX; i++)\n\t\t_dwmac4_dump_dma_regs(priv, ioaddr, i, reg_space);\n}\n\nstatic void dwmac4_rx_watchdog(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t       u32 riwt, u32 queue)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\n\twritel(riwt, ioaddr + DMA_CHAN_RX_WATCHDOG(dwmac4_addrs, queue));\n}\n\nstatic void dwmac4_dma_rx_chan_op_mode(struct stmmac_priv *priv,\n\t\t\t\t       void __iomem *ioaddr, int mode,\n\t\t\t\t       u32 channel, int fifosz, u8 qmode)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tunsigned int rqs = fifosz / 256 - 1;\n\tu32 mtl_rx_op;\n\n\tmtl_rx_op = readl(ioaddr + MTL_CHAN_RX_OP_MODE(dwmac4_addrs, channel));\n\n\tif (mode == SF_DMA_MODE) {\n\t\tpr_debug(\"GMAC: enable RX store and forward mode\\n\");\n\t\tmtl_rx_op |= MTL_OP_MODE_RSF;\n\t} else {\n\t\tpr_debug(\"GMAC: disable RX SF mode (threshold %d)\\n\", mode);\n\t\tmtl_rx_op &= ~MTL_OP_MODE_RSF;\n\t\tmtl_rx_op &= MTL_OP_MODE_RTC_MASK;\n\t\tif (mode <= 32)\n\t\t\tmtl_rx_op |= MTL_OP_MODE_RTC_32;\n\t\telse if (mode <= 64)\n\t\t\tmtl_rx_op |= MTL_OP_MODE_RTC_64;\n\t\telse if (mode <= 96)\n\t\t\tmtl_rx_op |= MTL_OP_MODE_RTC_96;\n\t\telse\n\t\t\tmtl_rx_op |= MTL_OP_MODE_RTC_128;\n\t}\n\n\tmtl_rx_op &= ~MTL_OP_MODE_RQS_MASK;\n\tmtl_rx_op |= rqs << MTL_OP_MODE_RQS_SHIFT;\n\n\t \n\tif ((fifosz >= 4096) && (qmode != MTL_QUEUE_AVB)) {\n\t\tunsigned int rfd, rfa;\n\n\t\tmtl_rx_op |= MTL_OP_MODE_EHFC;\n\n\t\t \n\t\tswitch (fifosz) {\n\t\tcase 4096:\n\t\t\t \n\t\t\trfd = 0x03;  \n\t\t\trfa = 0x01;  \n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\trfd = 0x07;  \n\t\t\trfa = 0x04;  \n\t\t\tbreak;\n\t\t}\n\n\t\tmtl_rx_op &= ~MTL_OP_MODE_RFD_MASK;\n\t\tmtl_rx_op |= rfd << MTL_OP_MODE_RFD_SHIFT;\n\n\t\tmtl_rx_op &= ~MTL_OP_MODE_RFA_MASK;\n\t\tmtl_rx_op |= rfa << MTL_OP_MODE_RFA_SHIFT;\n\t}\n\n\twritel(mtl_rx_op, ioaddr + MTL_CHAN_RX_OP_MODE(dwmac4_addrs, channel));\n}\n\nstatic void dwmac4_dma_tx_chan_op_mode(struct stmmac_priv *priv,\n\t\t\t\t       void __iomem *ioaddr, int mode,\n\t\t\t\t       u32 channel, int fifosz, u8 qmode)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 mtl_tx_op = readl(ioaddr + MTL_CHAN_TX_OP_MODE(dwmac4_addrs,\n\t\t\t\t\t\t\t   channel));\n\tunsigned int tqs = fifosz / 256 - 1;\n\n\tif (mode == SF_DMA_MODE) {\n\t\tpr_debug(\"GMAC: enable TX store and forward mode\\n\");\n\t\t \n\t\tmtl_tx_op |= MTL_OP_MODE_TSF;\n\t} else {\n\t\tpr_debug(\"GMAC: disabling TX SF (threshold %d)\\n\", mode);\n\t\tmtl_tx_op &= ~MTL_OP_MODE_TSF;\n\t\tmtl_tx_op &= MTL_OP_MODE_TTC_MASK;\n\t\t \n\t\tif (mode <= 32)\n\t\t\tmtl_tx_op |= MTL_OP_MODE_TTC_32;\n\t\telse if (mode <= 64)\n\t\t\tmtl_tx_op |= MTL_OP_MODE_TTC_64;\n\t\telse if (mode <= 96)\n\t\t\tmtl_tx_op |= MTL_OP_MODE_TTC_96;\n\t\telse if (mode <= 128)\n\t\t\tmtl_tx_op |= MTL_OP_MODE_TTC_128;\n\t\telse if (mode <= 192)\n\t\t\tmtl_tx_op |= MTL_OP_MODE_TTC_192;\n\t\telse if (mode <= 256)\n\t\t\tmtl_tx_op |= MTL_OP_MODE_TTC_256;\n\t\telse if (mode <= 384)\n\t\t\tmtl_tx_op |= MTL_OP_MODE_TTC_384;\n\t\telse\n\t\t\tmtl_tx_op |= MTL_OP_MODE_TTC_512;\n\t}\n\t \n\tmtl_tx_op &= ~MTL_OP_MODE_TXQEN_MASK;\n\tif (qmode != MTL_QUEUE_AVB)\n\t\tmtl_tx_op |= MTL_OP_MODE_TXQEN;\n\telse\n\t\tmtl_tx_op |= MTL_OP_MODE_TXQEN_AV;\n\tmtl_tx_op &= ~MTL_OP_MODE_TQS_MASK;\n\tmtl_tx_op |= tqs << MTL_OP_MODE_TQS_SHIFT;\n\n\twritel(mtl_tx_op, ioaddr +  MTL_CHAN_TX_OP_MODE(dwmac4_addrs, channel));\n}\n\nstatic int dwmac4_get_hw_feature(void __iomem *ioaddr,\n\t\t\t\t struct dma_features *dma_cap)\n{\n\tu32 hw_cap = readl(ioaddr + GMAC_HW_FEATURE0);\n\n\t \n\tdma_cap->mbps_10_100 = (hw_cap & GMAC_HW_FEAT_MIISEL);\n\tdma_cap->mbps_1000 = (hw_cap & GMAC_HW_FEAT_GMIISEL) >> 1;\n\tdma_cap->half_duplex = (hw_cap & GMAC_HW_FEAT_HDSEL) >> 2;\n\tdma_cap->vlhash = (hw_cap & GMAC_HW_FEAT_VLHASH) >> 4;\n\tdma_cap->multi_addr = (hw_cap & GMAC_HW_FEAT_ADDMAC) >> 18;\n\tdma_cap->pcs = (hw_cap & GMAC_HW_FEAT_PCSSEL) >> 3;\n\tdma_cap->sma_mdio = (hw_cap & GMAC_HW_FEAT_SMASEL) >> 5;\n\tdma_cap->pmt_remote_wake_up = (hw_cap & GMAC_HW_FEAT_RWKSEL) >> 6;\n\tdma_cap->pmt_magic_frame = (hw_cap & GMAC_HW_FEAT_MGKSEL) >> 7;\n\t \n\tdma_cap->rmon = (hw_cap & GMAC_HW_FEAT_MMCSEL) >> 8;\n\t \n\tdma_cap->atime_stamp = (hw_cap & GMAC_HW_FEAT_TSSEL) >> 12;\n\t \n\tdma_cap->eee = (hw_cap & GMAC_HW_FEAT_EEESEL) >> 13;\n\t \n\tdma_cap->tx_coe = (hw_cap & GMAC_HW_FEAT_TXCOSEL) >> 14;\n\tdma_cap->rx_coe =  (hw_cap & GMAC_HW_FEAT_RXCOESEL) >> 16;\n\tdma_cap->vlins = (hw_cap & GMAC_HW_FEAT_SAVLANINS) >> 27;\n\tdma_cap->arpoffsel = (hw_cap & GMAC_HW_FEAT_ARPOFFSEL) >> 9;\n\n\t \n\thw_cap = readl(ioaddr + GMAC_HW_FEATURE1);\n\tdma_cap->l3l4fnum = (hw_cap & GMAC_HW_FEAT_L3L4FNUM) >> 27;\n\tdma_cap->hash_tb_sz = (hw_cap & GMAC_HW_HASH_TB_SZ) >> 24;\n\tdma_cap->av = (hw_cap & GMAC_HW_FEAT_AVSEL) >> 20;\n\tdma_cap->tsoen = (hw_cap & GMAC_HW_TSOEN) >> 18;\n\tdma_cap->sphen = (hw_cap & GMAC_HW_FEAT_SPHEN) >> 17;\n\n\tdma_cap->addr64 = (hw_cap & GMAC_HW_ADDR64) >> 14;\n\tswitch (dma_cap->addr64) {\n\tcase 0:\n\t\tdma_cap->addr64 = 32;\n\t\tbreak;\n\tcase 1:\n\t\tdma_cap->addr64 = 40;\n\t\tbreak;\n\tcase 2:\n\t\tdma_cap->addr64 = 48;\n\t\tbreak;\n\tdefault:\n\t\tdma_cap->addr64 = 32;\n\t\tbreak;\n\t}\n\n\t \n\tdma_cap->tx_fifo_size = 128 << ((hw_cap & GMAC_HW_TXFIFOSIZE) >> 6);\n\tdma_cap->rx_fifo_size = 128 << ((hw_cap & GMAC_HW_RXFIFOSIZE) >> 0);\n\t \n\thw_cap = readl(ioaddr + GMAC_HW_FEATURE2);\n\t \n\tdma_cap->number_rx_channel =\n\t\t((hw_cap & GMAC_HW_FEAT_RXCHCNT) >> 12) + 1;\n\tdma_cap->number_tx_channel =\n\t\t((hw_cap & GMAC_HW_FEAT_TXCHCNT) >> 18) + 1;\n\t \n\tdma_cap->number_rx_queues =\n\t\t((hw_cap & GMAC_HW_FEAT_RXQCNT) >> 0) + 1;\n\tdma_cap->number_tx_queues =\n\t\t((hw_cap & GMAC_HW_FEAT_TXQCNT) >> 6) + 1;\n\t \n\tdma_cap->pps_out_num = (hw_cap & GMAC_HW_FEAT_PPSOUTNUM) >> 24;\n\n\t \n\tdma_cap->time_stamp = 0;\n\t \n\tdma_cap->aux_snapshot_n = (hw_cap & GMAC_HW_FEAT_AUXSNAPNUM) >> 28;\n\n\t \n\thw_cap = readl(ioaddr + GMAC_HW_FEATURE3);\n\n\t \n\tdma_cap->asp = (hw_cap & GMAC_HW_FEAT_ASP) >> 28;\n\tdma_cap->tbssel = (hw_cap & GMAC_HW_FEAT_TBSSEL) >> 27;\n\tdma_cap->fpesel = (hw_cap & GMAC_HW_FEAT_FPESEL) >> 26;\n\tdma_cap->estwid = (hw_cap & GMAC_HW_FEAT_ESTWID) >> 20;\n\tdma_cap->estdep = (hw_cap & GMAC_HW_FEAT_ESTDEP) >> 17;\n\tdma_cap->estsel = (hw_cap & GMAC_HW_FEAT_ESTSEL) >> 16;\n\tdma_cap->frpes = (hw_cap & GMAC_HW_FEAT_FRPES) >> 13;\n\tdma_cap->frpbs = (hw_cap & GMAC_HW_FEAT_FRPBS) >> 11;\n\tdma_cap->frpsel = (hw_cap & GMAC_HW_FEAT_FRPSEL) >> 10;\n\tdma_cap->dvlan = (hw_cap & GMAC_HW_FEAT_DVLAN) >> 5;\n\n\treturn 0;\n}\n\n \nstatic void dwmac4_enable_tso(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t      bool en, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value;\n\n\tif (en) {\n\t\t \n\t\tvalue = readl(ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\t\twritel(value | DMA_CONTROL_TSE,\n\t\t       ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\t} else {\n\t\t \n\t\tvalue = readl(ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\t\twritel(value & ~DMA_CONTROL_TSE,\n\t\t       ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\t}\n}\n\nstatic void dwmac4_qmode(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t u32 channel, u8 qmode)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 mtl_tx_op = readl(ioaddr + MTL_CHAN_TX_OP_MODE(dwmac4_addrs,\n\t\t\t\t\t\t\t   channel));\n\n\tmtl_tx_op &= ~MTL_OP_MODE_TXQEN_MASK;\n\tif (qmode != MTL_QUEUE_AVB)\n\t\tmtl_tx_op |= MTL_OP_MODE_TXQEN;\n\telse\n\t\tmtl_tx_op |= MTL_OP_MODE_TXQEN_AV;\n\n\twritel(mtl_tx_op, ioaddr +  MTL_CHAN_TX_OP_MODE(dwmac4_addrs, channel));\n}\n\nstatic void dwmac4_set_bfsize(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t      int bfsize, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value = readl(ioaddr + DMA_CHAN_RX_CONTROL(dwmac4_addrs, chan));\n\n\tvalue &= ~DMA_RBSZ_MASK;\n\tvalue |= (bfsize << DMA_RBSZ_SHIFT) & DMA_RBSZ_MASK;\n\n\twritel(value, ioaddr + DMA_CHAN_RX_CONTROL(dwmac4_addrs, chan));\n}\n\nstatic void dwmac4_enable_sph(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t      bool en, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value = readl(ioaddr + GMAC_EXT_CONFIG);\n\n\tvalue &= ~GMAC_CONFIG_HDSMS;\n\tvalue |= GMAC_CONFIG_HDSMS_256;  \n\twritel(value, ioaddr + GMAC_EXT_CONFIG);\n\n\tvalue = readl(ioaddr + DMA_CHAN_CONTROL(dwmac4_addrs, chan));\n\tif (en)\n\t\tvalue |= DMA_CONTROL_SPH;\n\telse\n\t\tvalue &= ~DMA_CONTROL_SPH;\n\twritel(value, ioaddr + DMA_CHAN_CONTROL(dwmac4_addrs, chan));\n}\n\nstatic int dwmac4_enable_tbs(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t     bool en, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value = readl(ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\n\tif (en)\n\t\tvalue |= DMA_CONTROL_EDSE;\n\telse\n\t\tvalue &= ~DMA_CONTROL_EDSE;\n\n\twritel(value, ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\n\tvalue = readl(ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs,\n\t\t\t\t\t\t   chan)) & DMA_CONTROL_EDSE;\n\tif (en && !value)\n\t\treturn -EIO;\n\n\twritel(DMA_TBS_DEF_FTOS, ioaddr + DMA_TBS_CTRL);\n\treturn 0;\n}\n\nconst struct stmmac_dma_ops dwmac4_dma_ops = {\n\t.reset = dwmac4_dma_reset,\n\t.init = dwmac4_dma_init,\n\t.init_chan = dwmac4_dma_init_channel,\n\t.init_rx_chan = dwmac4_dma_init_rx_chan,\n\t.init_tx_chan = dwmac4_dma_init_tx_chan,\n\t.axi = dwmac4_dma_axi,\n\t.dump_regs = dwmac4_dump_dma_regs,\n\t.dma_rx_mode = dwmac4_dma_rx_chan_op_mode,\n\t.dma_tx_mode = dwmac4_dma_tx_chan_op_mode,\n\t.enable_dma_irq = dwmac4_enable_dma_irq,\n\t.disable_dma_irq = dwmac4_disable_dma_irq,\n\t.start_tx = dwmac4_dma_start_tx,\n\t.stop_tx = dwmac4_dma_stop_tx,\n\t.start_rx = dwmac4_dma_start_rx,\n\t.stop_rx = dwmac4_dma_stop_rx,\n\t.dma_interrupt = dwmac4_dma_interrupt,\n\t.get_hw_feature = dwmac4_get_hw_feature,\n\t.rx_watchdog = dwmac4_rx_watchdog,\n\t.set_rx_ring_len = dwmac4_set_rx_ring_len,\n\t.set_tx_ring_len = dwmac4_set_tx_ring_len,\n\t.set_rx_tail_ptr = dwmac4_set_rx_tail_ptr,\n\t.set_tx_tail_ptr = dwmac4_set_tx_tail_ptr,\n\t.enable_tso = dwmac4_enable_tso,\n\t.qmode = dwmac4_qmode,\n\t.set_bfsize = dwmac4_set_bfsize,\n\t.enable_sph = dwmac4_enable_sph,\n};\n\nconst struct stmmac_dma_ops dwmac410_dma_ops = {\n\t.reset = dwmac4_dma_reset,\n\t.init = dwmac4_dma_init,\n\t.init_chan = dwmac410_dma_init_channel,\n\t.init_rx_chan = dwmac4_dma_init_rx_chan,\n\t.init_tx_chan = dwmac4_dma_init_tx_chan,\n\t.axi = dwmac4_dma_axi,\n\t.dump_regs = dwmac4_dump_dma_regs,\n\t.dma_rx_mode = dwmac4_dma_rx_chan_op_mode,\n\t.dma_tx_mode = dwmac4_dma_tx_chan_op_mode,\n\t.enable_dma_irq = dwmac410_enable_dma_irq,\n\t.disable_dma_irq = dwmac4_disable_dma_irq,\n\t.start_tx = dwmac4_dma_start_tx,\n\t.stop_tx = dwmac4_dma_stop_tx,\n\t.start_rx = dwmac4_dma_start_rx,\n\t.stop_rx = dwmac4_dma_stop_rx,\n\t.dma_interrupt = dwmac4_dma_interrupt,\n\t.get_hw_feature = dwmac4_get_hw_feature,\n\t.rx_watchdog = dwmac4_rx_watchdog,\n\t.set_rx_ring_len = dwmac4_set_rx_ring_len,\n\t.set_tx_ring_len = dwmac4_set_tx_ring_len,\n\t.set_rx_tail_ptr = dwmac4_set_rx_tail_ptr,\n\t.set_tx_tail_ptr = dwmac4_set_tx_tail_ptr,\n\t.enable_tso = dwmac4_enable_tso,\n\t.qmode = dwmac4_qmode,\n\t.set_bfsize = dwmac4_set_bfsize,\n\t.enable_sph = dwmac4_enable_sph,\n\t.enable_tbs = dwmac4_enable_tbs,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}