{
  "module_name": "dwxgmac2_descs.c",
  "hash_id": "47fb4458003481efaec205619affb63302a385ebd0d0b2a362b05d112c90eb9b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/stmicro/stmmac/dwxgmac2_descs.c",
  "human_readable_source": "\n \n\n#include <linux/stmmac.h>\n#include \"common.h\"\n#include \"dwxgmac2.h\"\n\nstatic int dwxgmac2_get_tx_status(struct stmmac_extra_stats *x,\n\t\t\t\t  struct dma_desc *p, void __iomem *ioaddr)\n{\n\tunsigned int tdes3 = le32_to_cpu(p->des3);\n\tint ret = tx_done;\n\n\tif (unlikely(tdes3 & XGMAC_TDES3_OWN))\n\t\treturn tx_dma_own;\n\tif (likely(!(tdes3 & XGMAC_TDES3_LD)))\n\t\treturn tx_not_ls;\n\n\treturn ret;\n}\n\nstatic int dwxgmac2_get_rx_status(struct stmmac_extra_stats *x,\n\t\t\t\t  struct dma_desc *p)\n{\n\tunsigned int rdes3 = le32_to_cpu(p->des3);\n\n\tif (unlikely(rdes3 & XGMAC_RDES3_OWN))\n\t\treturn dma_own;\n\tif (unlikely(rdes3 & XGMAC_RDES3_CTXT))\n\t\treturn discard_frame;\n\tif (likely(!(rdes3 & XGMAC_RDES3_LD)))\n\t\treturn rx_not_ls;\n\tif (unlikely((rdes3 & XGMAC_RDES3_ES) && (rdes3 & XGMAC_RDES3_LD)))\n\t\treturn discard_frame;\n\n\treturn good_frame;\n}\n\nstatic int dwxgmac2_get_tx_len(struct dma_desc *p)\n{\n\treturn (le32_to_cpu(p->des2) & XGMAC_TDES2_B1L);\n}\n\nstatic int dwxgmac2_get_tx_owner(struct dma_desc *p)\n{\n\treturn (le32_to_cpu(p->des3) & XGMAC_TDES3_OWN) > 0;\n}\n\nstatic void dwxgmac2_set_tx_owner(struct dma_desc *p)\n{\n\tp->des3 |= cpu_to_le32(XGMAC_TDES3_OWN);\n}\n\nstatic void dwxgmac2_set_rx_owner(struct dma_desc *p, int disable_rx_ic)\n{\n\tp->des3 |= cpu_to_le32(XGMAC_RDES3_OWN);\n\n\tif (!disable_rx_ic)\n\t\tp->des3 |= cpu_to_le32(XGMAC_RDES3_IOC);\n}\n\nstatic int dwxgmac2_get_tx_ls(struct dma_desc *p)\n{\n\treturn (le32_to_cpu(p->des3) & XGMAC_RDES3_LD) > 0;\n}\n\nstatic int dwxgmac2_get_rx_frame_len(struct dma_desc *p, int rx_coe)\n{\n\treturn (le32_to_cpu(p->des3) & XGMAC_RDES3_PL);\n}\n\nstatic void dwxgmac2_enable_tx_timestamp(struct dma_desc *p)\n{\n\tp->des2 |= cpu_to_le32(XGMAC_TDES2_TTSE);\n}\n\nstatic int dwxgmac2_get_tx_timestamp_status(struct dma_desc *p)\n{\n\treturn 0;  \n}\n\nstatic inline void dwxgmac2_get_timestamp(void *desc, u32 ats, u64 *ts)\n{\n\tstruct dma_desc *p = (struct dma_desc *)desc;\n\tu64 ns = 0;\n\n\tns += le32_to_cpu(p->des1) * 1000000000ULL;\n\tns += le32_to_cpu(p->des0);\n\n\t*ts = ns;\n}\n\nstatic int dwxgmac2_rx_check_timestamp(void *desc)\n{\n\tstruct dma_desc *p = (struct dma_desc *)desc;\n\tunsigned int rdes3 = le32_to_cpu(p->des3);\n\tbool desc_valid, ts_valid;\n\n\tdma_rmb();\n\n\tdesc_valid = !(rdes3 & XGMAC_RDES3_OWN) && (rdes3 & XGMAC_RDES3_CTXT);\n\tts_valid = !(rdes3 & XGMAC_RDES3_TSD) && (rdes3 & XGMAC_RDES3_TSA);\n\n\tif (likely(desc_valid && ts_valid)) {\n\t\tif ((p->des0 == 0xffffffff) && (p->des1 == 0xffffffff))\n\t\t\treturn -EINVAL;\n\t\treturn 0;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int dwxgmac2_get_rx_timestamp_status(void *desc, void *next_desc,\n\t\t\t\t\t    u32 ats)\n{\n\tstruct dma_desc *p = (struct dma_desc *)desc;\n\tunsigned int rdes3 = le32_to_cpu(p->des3);\n\tint ret = -EBUSY;\n\n\tif (likely(rdes3 & XGMAC_RDES3_CDA))\n\t\tret = dwxgmac2_rx_check_timestamp(next_desc);\n\n\treturn !ret;\n}\n\nstatic void dwxgmac2_init_rx_desc(struct dma_desc *p, int disable_rx_ic,\n\t\t\t\t  int mode, int end, int bfsize)\n{\n\tdwxgmac2_set_rx_owner(p, disable_rx_ic);\n}\n\nstatic void dwxgmac2_init_tx_desc(struct dma_desc *p, int mode, int end)\n{\n\tp->des0 = 0;\n\tp->des1 = 0;\n\tp->des2 = 0;\n\tp->des3 = 0;\n}\n\nstatic void dwxgmac2_prepare_tx_desc(struct dma_desc *p, int is_fs, int len,\n\t\t\t\t     bool csum_flag, int mode, bool tx_own,\n\t\t\t\t     bool ls, unsigned int tot_pkt_len)\n{\n\tunsigned int tdes3 = le32_to_cpu(p->des3);\n\n\tp->des2 |= cpu_to_le32(len & XGMAC_TDES2_B1L);\n\n\ttdes3 |= tot_pkt_len & XGMAC_TDES3_FL;\n\tif (is_fs)\n\t\ttdes3 |= XGMAC_TDES3_FD;\n\telse\n\t\ttdes3 &= ~XGMAC_TDES3_FD;\n\n\tif (csum_flag)\n\t\ttdes3 |= 0x3 << XGMAC_TDES3_CIC_SHIFT;\n\telse\n\t\ttdes3 &= ~XGMAC_TDES3_CIC;\n\n\tif (ls)\n\t\ttdes3 |= XGMAC_TDES3_LD;\n\telse\n\t\ttdes3 &= ~XGMAC_TDES3_LD;\n\n\t \n\tif (tx_own)\n\t\ttdes3 |= XGMAC_TDES3_OWN;\n\n\tif (is_fs && tx_own)\n\t\t \n\t\tdma_wmb();\n\n\tp->des3 = cpu_to_le32(tdes3);\n}\n\nstatic void dwxgmac2_prepare_tso_tx_desc(struct dma_desc *p, int is_fs,\n\t\t\t\t\t int len1, int len2, bool tx_own,\n\t\t\t\t\t bool ls, unsigned int tcphdrlen,\n\t\t\t\t\t unsigned int tcppayloadlen)\n{\n\tunsigned int tdes3 = le32_to_cpu(p->des3);\n\n\tif (len1)\n\t\tp->des2 |= cpu_to_le32(len1 & XGMAC_TDES2_B1L);\n\tif (len2)\n\t\tp->des2 |= cpu_to_le32((len2 << XGMAC_TDES2_B2L_SHIFT) &\n\t\t\t\tXGMAC_TDES2_B2L);\n\tif (is_fs) {\n\t\ttdes3 |= XGMAC_TDES3_FD | XGMAC_TDES3_TSE;\n\t\ttdes3 |= (tcphdrlen << XGMAC_TDES3_THL_SHIFT) &\n\t\t\tXGMAC_TDES3_THL;\n\t\ttdes3 |= tcppayloadlen & XGMAC_TDES3_TPL;\n\t} else {\n\t\ttdes3 &= ~XGMAC_TDES3_FD;\n\t}\n\n\tif (ls)\n\t\ttdes3 |= XGMAC_TDES3_LD;\n\telse\n\t\ttdes3 &= ~XGMAC_TDES3_LD;\n\n\t \n\tif (tx_own)\n\t\ttdes3 |= XGMAC_TDES3_OWN;\n\n\tif (is_fs && tx_own)\n\t\t \n\t\tdma_wmb();\n\n\tp->des3 = cpu_to_le32(tdes3);\n}\n\nstatic void dwxgmac2_release_tx_desc(struct dma_desc *p, int mode)\n{\n\tp->des0 = 0;\n\tp->des1 = 0;\n\tp->des2 = 0;\n\tp->des3 = 0;\n}\n\nstatic void dwxgmac2_set_tx_ic(struct dma_desc *p)\n{\n\tp->des2 |= cpu_to_le32(XGMAC_TDES2_IOC);\n}\n\nstatic void dwxgmac2_set_mss(struct dma_desc *p, unsigned int mss)\n{\n\tp->des0 = 0;\n\tp->des1 = 0;\n\tp->des2 = cpu_to_le32(mss);\n\tp->des3 = cpu_to_le32(XGMAC_TDES3_CTXT | XGMAC_TDES3_TCMSSV);\n}\n\nstatic void dwxgmac2_set_addr(struct dma_desc *p, dma_addr_t addr)\n{\n\tp->des0 = cpu_to_le32(lower_32_bits(addr));\n\tp->des1 = cpu_to_le32(upper_32_bits(addr));\n}\n\nstatic void dwxgmac2_clear(struct dma_desc *p)\n{\n\tp->des0 = 0;\n\tp->des1 = 0;\n\tp->des2 = 0;\n\tp->des3 = 0;\n}\n\nstatic int dwxgmac2_get_rx_hash(struct dma_desc *p, u32 *hash,\n\t\t\t\tenum pkt_hash_types *type)\n{\n\tunsigned int rdes3 = le32_to_cpu(p->des3);\n\tu32 ptype;\n\n\tif (rdes3 & XGMAC_RDES3_RSV) {\n\t\tptype = (rdes3 & XGMAC_RDES3_L34T) >> XGMAC_RDES3_L34T_SHIFT;\n\n\t\tswitch (ptype) {\n\t\tcase XGMAC_L34T_IP4TCP:\n\t\tcase XGMAC_L34T_IP4UDP:\n\t\tcase XGMAC_L34T_IP6TCP:\n\t\tcase XGMAC_L34T_IP6UDP:\n\t\t\t*type = PKT_HASH_TYPE_L4;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\t*type = PKT_HASH_TYPE_L3;\n\t\t\tbreak;\n\t\t}\n\n\t\t*hash = le32_to_cpu(p->des1);\n\t\treturn 0;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic void dwxgmac2_get_rx_header_len(struct dma_desc *p, unsigned int *len)\n{\n\tif (le32_to_cpu(p->des3) & XGMAC_RDES3_L34T)\n\t\t*len = le32_to_cpu(p->des2) & XGMAC_RDES2_HL;\n}\n\nstatic void dwxgmac2_set_sec_addr(struct dma_desc *p, dma_addr_t addr, bool is_valid)\n{\n\tp->des2 = cpu_to_le32(lower_32_bits(addr));\n\tp->des3 = cpu_to_le32(upper_32_bits(addr));\n}\n\nstatic void dwxgmac2_set_sarc(struct dma_desc *p, u32 sarc_type)\n{\n\tsarc_type <<= XGMAC_TDES3_SAIC_SHIFT;\n\n\tp->des3 |= cpu_to_le32(sarc_type & XGMAC_TDES3_SAIC);\n}\n\nstatic void dwxgmac2_set_vlan_tag(struct dma_desc *p, u16 tag, u16 inner_tag,\n\t\t\t\t  u32 inner_type)\n{\n\tp->des0 = 0;\n\tp->des1 = 0;\n\tp->des2 = 0;\n\tp->des3 = 0;\n\n\t \n\tif (inner_type) {\n\t\tu32 des = inner_tag << XGMAC_TDES2_IVT_SHIFT;\n\n\t\tdes &= XGMAC_TDES2_IVT;\n\t\tp->des2 = cpu_to_le32(des);\n\n\t\tdes = inner_type << XGMAC_TDES3_IVTIR_SHIFT;\n\t\tdes &= XGMAC_TDES3_IVTIR;\n\t\tp->des3 = cpu_to_le32(des | XGMAC_TDES3_IVLTV);\n\t}\n\n\t \n\tp->des3 |= cpu_to_le32(tag & XGMAC_TDES3_VT);\n\tp->des3 |= cpu_to_le32(XGMAC_TDES3_VLTV);\n\n\tp->des3 |= cpu_to_le32(XGMAC_TDES3_CTXT);\n}\n\nstatic void dwxgmac2_set_vlan(struct dma_desc *p, u32 type)\n{\n\ttype <<= XGMAC_TDES2_VTIR_SHIFT;\n\tp->des2 |= cpu_to_le32(type & XGMAC_TDES2_VTIR);\n}\n\nstatic void dwxgmac2_set_tbs(struct dma_edesc *p, u32 sec, u32 nsec)\n{\n\tp->des4 = cpu_to_le32((sec & XGMAC_TDES0_LT) | XGMAC_TDES0_LTV);\n\tp->des5 = cpu_to_le32(nsec & XGMAC_TDES1_LT);\n\tp->des6 = 0;\n\tp->des7 = 0;\n}\n\nconst struct stmmac_desc_ops dwxgmac210_desc_ops = {\n\t.tx_status = dwxgmac2_get_tx_status,\n\t.rx_status = dwxgmac2_get_rx_status,\n\t.get_tx_len = dwxgmac2_get_tx_len,\n\t.get_tx_owner = dwxgmac2_get_tx_owner,\n\t.set_tx_owner = dwxgmac2_set_tx_owner,\n\t.set_rx_owner = dwxgmac2_set_rx_owner,\n\t.get_tx_ls = dwxgmac2_get_tx_ls,\n\t.get_rx_frame_len = dwxgmac2_get_rx_frame_len,\n\t.enable_tx_timestamp = dwxgmac2_enable_tx_timestamp,\n\t.get_tx_timestamp_status = dwxgmac2_get_tx_timestamp_status,\n\t.get_rx_timestamp_status = dwxgmac2_get_rx_timestamp_status,\n\t.get_timestamp = dwxgmac2_get_timestamp,\n\t.set_tx_ic = dwxgmac2_set_tx_ic,\n\t.prepare_tx_desc = dwxgmac2_prepare_tx_desc,\n\t.prepare_tso_tx_desc = dwxgmac2_prepare_tso_tx_desc,\n\t.release_tx_desc = dwxgmac2_release_tx_desc,\n\t.init_rx_desc = dwxgmac2_init_rx_desc,\n\t.init_tx_desc = dwxgmac2_init_tx_desc,\n\t.set_mss = dwxgmac2_set_mss,\n\t.set_addr = dwxgmac2_set_addr,\n\t.clear = dwxgmac2_clear,\n\t.get_rx_hash = dwxgmac2_get_rx_hash,\n\t.get_rx_header_len = dwxgmac2_get_rx_header_len,\n\t.set_sec_addr = dwxgmac2_set_sec_addr,\n\t.set_sarc = dwxgmac2_set_sarc,\n\t.set_vlan_tag = dwxgmac2_set_vlan_tag,\n\t.set_vlan = dwxgmac2_set_vlan,\n\t.set_tbs = dwxgmac2_set_tbs,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}