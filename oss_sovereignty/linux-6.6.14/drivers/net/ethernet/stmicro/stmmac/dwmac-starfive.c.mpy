{
  "module_name": "dwmac-starfive.c",
  "hash_id": "b5c95fcecc1ef5de3f91f00c1499097c2db9866f209ea9919d12e125a6c04f8d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/stmicro/stmmac/dwmac-starfive.c",
  "human_readable_source": "\n \n\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/mfd/syscon.h>\n#include <linux/regmap.h>\n\n#include \"stmmac_platform.h\"\n\n#define STARFIVE_DWMAC_PHY_INFT_RGMII\t0x1\n#define STARFIVE_DWMAC_PHY_INFT_RMII\t0x4\n#define STARFIVE_DWMAC_PHY_INFT_FIELD\t0x7U\n\nstruct starfive_dwmac {\n\tstruct device *dev;\n\tstruct clk *clk_tx;\n};\n\nstatic void starfive_dwmac_fix_mac_speed(void *priv, unsigned int speed, unsigned int mode)\n{\n\tstruct starfive_dwmac *dwmac = priv;\n\tunsigned long rate;\n\tint err;\n\n\trate = clk_get_rate(dwmac->clk_tx);\n\n\tswitch (speed) {\n\tcase SPEED_1000:\n\t\trate = 125000000;\n\t\tbreak;\n\tcase SPEED_100:\n\t\trate = 25000000;\n\t\tbreak;\n\tcase SPEED_10:\n\t\trate = 2500000;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dwmac->dev, \"invalid speed %u\\n\", speed);\n\t\tbreak;\n\t}\n\n\terr = clk_set_rate(dwmac->clk_tx, rate);\n\tif (err)\n\t\tdev_err(dwmac->dev, \"failed to set tx rate %lu\\n\", rate);\n}\n\nstatic int starfive_dwmac_set_mode(struct plat_stmmacenet_data *plat_dat)\n{\n\tstruct starfive_dwmac *dwmac = plat_dat->bsp_priv;\n\tstruct regmap *regmap;\n\tunsigned int args[2];\n\tunsigned int mode;\n\tint err;\n\n\tswitch (plat_dat->mac_interface) {\n\tcase PHY_INTERFACE_MODE_RMII:\n\t\tmode = STARFIVE_DWMAC_PHY_INFT_RMII;\n\t\tbreak;\n\n\tcase PHY_INTERFACE_MODE_RGMII:\n\tcase PHY_INTERFACE_MODE_RGMII_ID:\n\t\tmode = STARFIVE_DWMAC_PHY_INFT_RGMII;\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(dwmac->dev, \"unsupported interface %d\\n\",\n\t\t\tplat_dat->mac_interface);\n\t\treturn -EINVAL;\n\t}\n\n\tregmap = syscon_regmap_lookup_by_phandle_args(dwmac->dev->of_node,\n\t\t\t\t\t\t      \"starfive,syscon\",\n\t\t\t\t\t\t      2, args);\n\tif (IS_ERR(regmap))\n\t\treturn dev_err_probe(dwmac->dev, PTR_ERR(regmap), \"getting the regmap failed\\n\");\n\n\t \n\terr = regmap_update_bits(regmap, args[0],\n\t\t\t\t STARFIVE_DWMAC_PHY_INFT_FIELD << args[1],\n\t\t\t\t mode << args[1]);\n\tif (err)\n\t\treturn dev_err_probe(dwmac->dev, err, \"error setting phy mode\\n\");\n\n\treturn 0;\n}\n\nstatic int starfive_dwmac_probe(struct platform_device *pdev)\n{\n\tstruct plat_stmmacenet_data *plat_dat;\n\tstruct stmmac_resources stmmac_res;\n\tstruct starfive_dwmac *dwmac;\n\tstruct clk *clk_gtx;\n\tint err;\n\n\terr = stmmac_get_platform_resources(pdev, &stmmac_res);\n\tif (err)\n\t\treturn dev_err_probe(&pdev->dev, err,\n\t\t\t\t     \"failed to get resources\\n\");\n\n\tplat_dat = stmmac_probe_config_dt(pdev, stmmac_res.mac);\n\tif (IS_ERR(plat_dat))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(plat_dat),\n\t\t\t\t     \"dt configuration failed\\n\");\n\n\tdwmac = devm_kzalloc(&pdev->dev, sizeof(*dwmac), GFP_KERNEL);\n\tif (!dwmac)\n\t\treturn -ENOMEM;\n\n\tdwmac->clk_tx = devm_clk_get_enabled(&pdev->dev, \"tx\");\n\tif (IS_ERR(dwmac->clk_tx))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(dwmac->clk_tx),\n\t\t\t\t     \"error getting tx clock\\n\");\n\n\tclk_gtx = devm_clk_get_enabled(&pdev->dev, \"gtx\");\n\tif (IS_ERR(clk_gtx))\n\t\treturn dev_err_probe(&pdev->dev, PTR_ERR(clk_gtx),\n\t\t\t\t     \"error getting gtx clock\\n\");\n\n\t \n\tif (!device_property_read_bool(&pdev->dev, \"starfive,tx-use-rgmii-clk\"))\n\t\tplat_dat->fix_mac_speed = starfive_dwmac_fix_mac_speed;\n\n\tdwmac->dev = &pdev->dev;\n\tplat_dat->bsp_priv = dwmac;\n\tplat_dat->dma_cfg->dche = true;\n\n\terr = starfive_dwmac_set_mode(plat_dat);\n\tif (err)\n\t\treturn err;\n\n\terr = stmmac_dvr_probe(&pdev->dev, plat_dat, &stmmac_res);\n\tif (err) {\n\t\tstmmac_remove_config_dt(pdev, plat_dat);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id starfive_dwmac_match[] = {\n\t{ .compatible = \"starfive,jh7110-dwmac\"\t},\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, starfive_dwmac_match);\n\nstatic struct platform_driver starfive_dwmac_driver = {\n\t.probe  = starfive_dwmac_probe,\n\t.remove_new = stmmac_pltfr_remove,\n\t.driver = {\n\t\t.name = \"starfive-dwmac\",\n\t\t.pm = &stmmac_pltfr_pm_ops,\n\t\t.of_match_table = starfive_dwmac_match,\n\t},\n};\nmodule_platform_driver(starfive_dwmac_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"StarFive DWMAC platform driver\");\nMODULE_AUTHOR(\"Emil Renner Berthing <kernel@esmil.dk>\");\nMODULE_AUTHOR(\"Samin Guo <samin.guo@starfivetech.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}