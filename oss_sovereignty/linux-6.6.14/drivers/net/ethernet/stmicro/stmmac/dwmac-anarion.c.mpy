{
  "module_name": "dwmac-anarion.c",
  "hash_id": "bbfbd18dbc31a02f26f240c29c8dd6d6c1c2a368846cea019eefdacba2aa32fd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/stmicro/stmmac/dwmac-anarion.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/of_net.h>\n#include <linux/stmmac.h>\n\n#include \"stmmac.h\"\n#include \"stmmac_platform.h\"\n\n#define GMAC_RESET_CONTROL_REG\t\t0\n#define GMAC_SW_CONFIG_REG\t\t4\n#define  GMAC_CONFIG_INTF_SEL_MASK\t(0x7 << 0)\n#define  GMAC_CONFIG_INTF_RGMII\t\t(0x1 << 0)\n\nstruct anarion_gmac {\n\tvoid __iomem *ctl_block;\n\tuint32_t phy_intf_sel;\n};\n\nstatic uint32_t gmac_read_reg(struct anarion_gmac *gmac, uint8_t reg)\n{\n\treturn readl(gmac->ctl_block + reg);\n};\n\nstatic void gmac_write_reg(struct anarion_gmac *gmac, uint8_t reg, uint32_t val)\n{\n\twritel(val, gmac->ctl_block + reg);\n}\n\nstatic int anarion_gmac_init(struct platform_device *pdev, void *priv)\n{\n\tuint32_t sw_config;\n\tstruct anarion_gmac *gmac = priv;\n\n\t \n\tgmac_write_reg(gmac, GMAC_RESET_CONTROL_REG, 1);\n\n\tsw_config = gmac_read_reg(gmac, GMAC_SW_CONFIG_REG);\n\tsw_config &= ~GMAC_CONFIG_INTF_SEL_MASK;\n\tsw_config |= (gmac->phy_intf_sel & GMAC_CONFIG_INTF_SEL_MASK);\n\tgmac_write_reg(gmac, GMAC_SW_CONFIG_REG, sw_config);\n\n\tgmac_write_reg(gmac, GMAC_RESET_CONTROL_REG, 0);\n\n\treturn 0;\n}\n\nstatic void anarion_gmac_exit(struct platform_device *pdev, void *priv)\n{\n\tstruct anarion_gmac *gmac = priv;\n\n\tgmac_write_reg(gmac, GMAC_RESET_CONTROL_REG, 1);\n}\n\nstatic struct anarion_gmac *anarion_config_dt(struct platform_device *pdev)\n{\n\tstruct anarion_gmac *gmac;\n\tphy_interface_t phy_mode;\n\tvoid __iomem *ctl_block;\n\tint err;\n\n\tctl_block = devm_platform_ioremap_resource(pdev, 1);\n\tif (IS_ERR(ctl_block)) {\n\t\terr = PTR_ERR(ctl_block);\n\t\tdev_err(&pdev->dev, \"Cannot get reset region (%d)!\\n\", err);\n\t\treturn ERR_PTR(err);\n\t}\n\n\tgmac = devm_kzalloc(&pdev->dev, sizeof(*gmac), GFP_KERNEL);\n\tif (!gmac)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tgmac->ctl_block = ctl_block;\n\n\terr = of_get_phy_mode(pdev->dev.of_node, &phy_mode);\n\tif (err)\n\t\treturn ERR_PTR(err);\n\n\tswitch (phy_mode) {\n\tcase PHY_INTERFACE_MODE_RGMII:\n\t\tfallthrough;\n\tcase PHY_INTERFACE_MODE_RGMII_ID:\n\tcase PHY_INTERFACE_MODE_RGMII_RXID:\n\tcase PHY_INTERFACE_MODE_RGMII_TXID:\n\t\tgmac->phy_intf_sel = GMAC_CONFIG_INTF_RGMII;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&pdev->dev, \"Unsupported phy-mode (%d)\\n\",\n\t\t\tphy_mode);\n\t\treturn ERR_PTR(-ENOTSUPP);\n\t}\n\n\treturn gmac;\n}\n\nstatic int anarion_dwmac_probe(struct platform_device *pdev)\n{\n\tint ret;\n\tstruct anarion_gmac *gmac;\n\tstruct plat_stmmacenet_data *plat_dat;\n\tstruct stmmac_resources stmmac_res;\n\n\tret = stmmac_get_platform_resources(pdev, &stmmac_res);\n\tif (ret)\n\t\treturn ret;\n\n\tgmac = anarion_config_dt(pdev);\n\tif (IS_ERR(gmac))\n\t\treturn PTR_ERR(gmac);\n\n\tplat_dat = stmmac_probe_config_dt(pdev, stmmac_res.mac);\n\tif (IS_ERR(plat_dat))\n\t\treturn PTR_ERR(plat_dat);\n\n\tplat_dat->init = anarion_gmac_init;\n\tplat_dat->exit = anarion_gmac_exit;\n\tanarion_gmac_init(pdev, gmac);\n\tplat_dat->bsp_priv = gmac;\n\n\tret = stmmac_dvr_probe(&pdev->dev, plat_dat, &stmmac_res);\n\tif (ret) {\n\t\tstmmac_remove_config_dt(pdev, plat_dat);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id anarion_dwmac_match[] = {\n\t{ .compatible = \"adaptrum,anarion-gmac\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, anarion_dwmac_match);\n\nstatic struct platform_driver anarion_dwmac_driver = {\n\t.probe  = anarion_dwmac_probe,\n\t.remove_new = stmmac_pltfr_remove,\n\t.driver = {\n\t\t.name           = \"anarion-dwmac\",\n\t\t.pm\t\t= &stmmac_pltfr_pm_ops,\n\t\t.of_match_table = anarion_dwmac_match,\n\t},\n};\nmodule_platform_driver(anarion_dwmac_driver);\n\nMODULE_DESCRIPTION(\"Adaptrum Anarion DWMAC specific glue layer\");\nMODULE_AUTHOR(\"Alexandru Gagniuc <mr.nuke.me@gmail.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}