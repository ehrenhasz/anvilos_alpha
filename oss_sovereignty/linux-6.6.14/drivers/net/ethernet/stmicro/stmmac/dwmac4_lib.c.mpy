{
  "module_name": "dwmac4_lib.c",
  "hash_id": "b311b3665ab263f2135f44e586f6936ecd106eec8ab81e2be227576ceeebb4ca",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/stmicro/stmmac/dwmac4_lib.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/iopoll.h>\n#include <linux/delay.h>\n#include \"common.h\"\n#include \"dwmac4_dma.h\"\n#include \"dwmac4.h\"\n#include \"stmmac.h\"\n\nint dwmac4_dma_reset(void __iomem *ioaddr)\n{\n\tu32 value = readl(ioaddr + DMA_BUS_MODE);\n\n\t \n\tvalue |= DMA_BUS_MODE_SFT_RESET;\n\twritel(value, ioaddr + DMA_BUS_MODE);\n\n\treturn readl_poll_timeout(ioaddr + DMA_BUS_MODE, value,\n\t\t\t\t !(value & DMA_BUS_MODE_SFT_RESET),\n\t\t\t\t 10000, 1000000);\n}\n\nvoid dwmac4_set_rx_tail_ptr(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t    u32 tail_ptr, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\n\twritel(tail_ptr, ioaddr + DMA_CHAN_RX_END_ADDR(dwmac4_addrs, chan));\n}\n\nvoid dwmac4_set_tx_tail_ptr(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t    u32 tail_ptr, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\n\twritel(tail_ptr, ioaddr + DMA_CHAN_TX_END_ADDR(dwmac4_addrs, chan));\n}\n\nvoid dwmac4_dma_start_tx(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value = readl(ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\n\tvalue |= DMA_CONTROL_ST;\n\twritel(value, ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\n\tvalue = readl(ioaddr + GMAC_CONFIG);\n\tvalue |= GMAC_CONFIG_TE;\n\twritel(value, ioaddr + GMAC_CONFIG);\n}\n\nvoid dwmac4_dma_stop_tx(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\tu32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\n\tu32 value = readl(ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n\n\tvalue &= ~DMA_CONTROL_ST;\n\twritel(value, ioaddr + DMA_CHAN_TX_CONTROL(dwmac4_addrs, chan));\n}\n\nvoid dwmac4_dma_start_rx(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\n\tu32 value = readl(ioaddr + DMA_CHAN_RX_CONTROL(dwmac4_addrs, chan));\n\n\tvalue |= DMA_CONTROL_SR;\n\n\twritel(value, ioaddr + DMA_CHAN_RX_CONTROL(dwmac4_addrs, chan));\n\n\tvalue = readl(ioaddr + GMAC_CONFIG);\n\tvalue |= GMAC_CONFIG_RE;\n\twritel(value, ioaddr + GMAC_CONFIG);\n}\n\nvoid dwmac4_dma_stop_rx(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\tu32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value = readl(ioaddr + DMA_CHAN_RX_CONTROL(dwmac4_addrs, chan));\n\n\tvalue &= ~DMA_CONTROL_SR;\n\twritel(value, ioaddr + DMA_CHAN_RX_CONTROL(dwmac4_addrs, chan));\n}\n\nvoid dwmac4_set_tx_ring_len(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t    u32 len, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\n\twritel(len, ioaddr + DMA_CHAN_TX_RING_LEN(dwmac4_addrs, chan));\n}\n\nvoid dwmac4_set_rx_ring_len(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t    u32 len, u32 chan)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\n\twritel(len, ioaddr + DMA_CHAN_RX_RING_LEN(dwmac4_addrs, chan));\n}\n\nvoid dwmac4_enable_dma_irq(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t   u32 chan, bool rx, bool tx)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value = readl(ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n\n\tif (rx)\n\t\tvalue |= DMA_CHAN_INTR_DEFAULT_RX;\n\tif (tx)\n\t\tvalue |= DMA_CHAN_INTR_DEFAULT_TX;\n\n\twritel(value, ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n}\n\nvoid dwmac410_enable_dma_irq(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t     u32 chan, bool rx, bool tx)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value = readl(ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n\n\tif (rx)\n\t\tvalue |= DMA_CHAN_INTR_DEFAULT_RX_4_10;\n\tif (tx)\n\t\tvalue |= DMA_CHAN_INTR_DEFAULT_TX_4_10;\n\n\twritel(value, ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n}\n\nvoid dwmac4_disable_dma_irq(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t    u32 chan, bool rx, bool tx)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value = readl(ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n\n\tif (rx)\n\t\tvalue &= ~DMA_CHAN_INTR_DEFAULT_RX;\n\tif (tx)\n\t\tvalue &= ~DMA_CHAN_INTR_DEFAULT_TX;\n\n\twritel(value, ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n}\n\nvoid dwmac410_disable_dma_irq(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t      u32 chan, bool rx, bool tx)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 value = readl(ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n\n\tif (rx)\n\t\tvalue &= ~DMA_CHAN_INTR_DEFAULT_RX_4_10;\n\tif (tx)\n\t\tvalue &= ~DMA_CHAN_INTR_DEFAULT_TX_4_10;\n\n\twritel(value, ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n}\n\nint dwmac4_dma_interrupt(struct stmmac_priv *priv, void __iomem *ioaddr,\n\t\t\t struct stmmac_extra_stats *x, u32 chan, u32 dir)\n{\n\tconst struct dwmac4_addrs *dwmac4_addrs = priv->plat->dwmac4_addrs;\n\tu32 intr_status = readl(ioaddr + DMA_CHAN_STATUS(dwmac4_addrs, chan));\n\tu32 intr_en = readl(ioaddr + DMA_CHAN_INTR_ENA(dwmac4_addrs, chan));\n\tstruct stmmac_rxq_stats *rxq_stats = &priv->xstats.rxq_stats[chan];\n\tstruct stmmac_txq_stats *txq_stats = &priv->xstats.txq_stats[chan];\n\tint ret = 0;\n\n\tif (dir == DMA_DIR_RX)\n\t\tintr_status &= DMA_CHAN_STATUS_MSK_RX;\n\telse if (dir == DMA_DIR_TX)\n\t\tintr_status &= DMA_CHAN_STATUS_MSK_TX;\n\n\t \n\tif (unlikely(intr_status & DMA_CHAN_STATUS_AIS)) {\n\t\tif (unlikely(intr_status & DMA_CHAN_STATUS_RBU))\n\t\t\tx->rx_buf_unav_irq++;\n\t\tif (unlikely(intr_status & DMA_CHAN_STATUS_RPS))\n\t\t\tx->rx_process_stopped_irq++;\n\t\tif (unlikely(intr_status & DMA_CHAN_STATUS_RWT))\n\t\t\tx->rx_watchdog_irq++;\n\t\tif (unlikely(intr_status & DMA_CHAN_STATUS_ETI))\n\t\t\tx->tx_early_irq++;\n\t\tif (unlikely(intr_status & DMA_CHAN_STATUS_TPS)) {\n\t\t\tx->tx_process_stopped_irq++;\n\t\t\tret = tx_hard_error;\n\t\t}\n\t\tif (unlikely(intr_status & DMA_CHAN_STATUS_FBE)) {\n\t\t\tx->fatal_bus_error_irq++;\n\t\t\tret = tx_hard_error;\n\t\t}\n\t}\n\t \n\tif (likely(intr_status & DMA_CHAN_STATUS_RI)) {\n\t\tu64_stats_update_begin(&rxq_stats->syncp);\n\t\trxq_stats->rx_normal_irq_n++;\n\t\tu64_stats_update_end(&rxq_stats->syncp);\n\t\tret |= handle_rx;\n\t}\n\tif (likely(intr_status & DMA_CHAN_STATUS_TI)) {\n\t\tu64_stats_update_begin(&txq_stats->syncp);\n\t\ttxq_stats->tx_normal_irq_n++;\n\t\tu64_stats_update_end(&txq_stats->syncp);\n\t\tret |= handle_tx;\n\t}\n\n\tif (unlikely(intr_status & DMA_CHAN_STATUS_TBU))\n\t\tret |= handle_tx;\n\tif (unlikely(intr_status & DMA_CHAN_STATUS_ERI))\n\t\tx->rx_early_irq++;\n\n\twritel(intr_status & intr_en,\n\t       ioaddr + DMA_CHAN_STATUS(dwmac4_addrs, chan));\n\treturn ret;\n}\n\nvoid stmmac_dwmac4_set_mac_addr(void __iomem *ioaddr, const u8 addr[6],\n\t\t\t\tunsigned int high, unsigned int low)\n{\n\tunsigned long data;\n\n\tdata = (addr[5] << 8) | addr[4];\n\t \n\tdata |= (STMMAC_CHAN0 << GMAC_HI_DCS_SHIFT);\n\twritel(data | GMAC_HI_REG_AE, ioaddr + high);\n\tdata = (addr[3] << 24) | (addr[2] << 16) | (addr[1] << 8) | addr[0];\n\twritel(data, ioaddr + low);\n}\n\n \nvoid stmmac_dwmac4_set_mac(void __iomem *ioaddr, bool enable)\n{\n\tu32 value = readl(ioaddr + GMAC_CONFIG);\n\tu32 old_val = value;\n\n\tif (enable)\n\t\tvalue |= GMAC_CONFIG_RE | GMAC_CONFIG_TE;\n\telse\n\t\tvalue &= ~(GMAC_CONFIG_TE | GMAC_CONFIG_RE);\n\n\tif (value != old_val)\n\t\twritel(value, ioaddr + GMAC_CONFIG);\n}\n\nvoid stmmac_dwmac4_get_mac_addr(void __iomem *ioaddr, unsigned char *addr,\n\t\t\t\tunsigned int high, unsigned int low)\n{\n\tunsigned int hi_addr, lo_addr;\n\n\t \n\thi_addr = readl(ioaddr + high);\n\tlo_addr = readl(ioaddr + low);\n\n\t \n\taddr[0] = lo_addr & 0xff;\n\taddr[1] = (lo_addr >> 8) & 0xff;\n\taddr[2] = (lo_addr >> 16) & 0xff;\n\taddr[3] = (lo_addr >> 24) & 0xff;\n\taddr[4] = hi_addr & 0xff;\n\taddr[5] = (hi_addr >> 8) & 0xff;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}