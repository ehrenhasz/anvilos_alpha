{
  "module_name": "k3-cppi-desc-pool.c",
  "hash_id": "2ff17960bc93febf8db0a105023ef67fea467dfa7f0b17b2b83b269c58468e08",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/ti/k3-cppi-desc-pool.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/device.h>\n#include <linux/dma-mapping.h>\n#include <linux/err.h>\n#include <linux/genalloc.h>\n#include <linux/kernel.h>\n\n#include \"k3-cppi-desc-pool.h\"\n\nstruct k3_cppi_desc_pool {\n\tstruct device\t\t*dev;\n\tdma_addr_t\t\tdma_addr;\n\tvoid\t\t\t*cpumem;\t \n\tsize_t\t\t\tdesc_size;\n\tsize_t\t\t\tmem_size;\n\tsize_t\t\t\tnum_desc;\n\tstruct gen_pool\t\t*gen_pool;\n};\n\nvoid k3_cppi_desc_pool_destroy(struct k3_cppi_desc_pool *pool)\n{\n\tif (!pool)\n\t\treturn;\n\n\tWARN(gen_pool_size(pool->gen_pool) != gen_pool_avail(pool->gen_pool),\n\t     \"k3_knav_desc_pool size %zu != avail %zu\",\n\t     gen_pool_size(pool->gen_pool),\n\t     gen_pool_avail(pool->gen_pool));\n\tif (pool->cpumem)\n\t\tdma_free_coherent(pool->dev, pool->mem_size, pool->cpumem,\n\t\t\t\t  pool->dma_addr);\n\n\tgen_pool_destroy(pool->gen_pool);\t \n}\nEXPORT_SYMBOL_GPL(k3_cppi_desc_pool_destroy);\n\nstruct k3_cppi_desc_pool *\nk3_cppi_desc_pool_create_name(struct device *dev, size_t size,\n\t\t\t      size_t desc_size,\n\t\t\t      const char *name)\n{\n\tstruct k3_cppi_desc_pool *pool;\n\tconst char *pool_name = NULL;\n\tint ret = -ENOMEM;\n\n\tpool = devm_kzalloc(dev, sizeof(*pool), GFP_KERNEL);\n\tif (!pool)\n\t\treturn ERR_PTR(ret);\n\n\tpool->dev = dev;\n\tpool->desc_size\t= roundup_pow_of_two(desc_size);\n\tpool->num_desc\t= size;\n\tpool->mem_size\t= pool->num_desc * pool->desc_size;\n\n\tpool_name = kstrdup_const(name ? name : dev_name(pool->dev),\n\t\t\t\t  GFP_KERNEL);\n\tif (!pool_name)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tpool->gen_pool = gen_pool_create(ilog2(pool->desc_size), -1);\n\tif (!pool->gen_pool) {\n\t\tret = -ENOMEM;\n\t\tdev_err(pool->dev, \"pool create failed %d\\n\", ret);\n\t\tkfree_const(pool_name);\n\t\tgoto gen_pool_create_fail;\n\t}\n\n\tpool->gen_pool->name = pool_name;\n\n\tpool->cpumem = dma_alloc_coherent(pool->dev, pool->mem_size,\n\t\t\t\t\t  &pool->dma_addr, GFP_KERNEL);\n\n\tif (!pool->cpumem)\n\t\tgoto dma_alloc_fail;\n\n\tret = gen_pool_add_virt(pool->gen_pool, (unsigned long)pool->cpumem,\n\t\t\t\t(phys_addr_t)pool->dma_addr, pool->mem_size,\n\t\t\t\t-1);\n\tif (ret < 0) {\n\t\tdev_err(pool->dev, \"pool add failed %d\\n\", ret);\n\t\tgoto gen_pool_add_virt_fail;\n\t}\n\n\treturn pool;\n\ngen_pool_add_virt_fail:\n\tdma_free_coherent(pool->dev, pool->mem_size, pool->cpumem,\n\t\t\t  pool->dma_addr);\ndma_alloc_fail:\n\tgen_pool_destroy(pool->gen_pool);\t \ngen_pool_create_fail:\n\tdevm_kfree(pool->dev, pool);\n\treturn ERR_PTR(ret);\n}\nEXPORT_SYMBOL_GPL(k3_cppi_desc_pool_create_name);\n\ndma_addr_t k3_cppi_desc_pool_virt2dma(struct k3_cppi_desc_pool *pool,\n\t\t\t\t      void *addr)\n{\n\treturn addr ? pool->dma_addr + (addr - pool->cpumem) : 0;\n}\nEXPORT_SYMBOL_GPL(k3_cppi_desc_pool_virt2dma);\n\nvoid *k3_cppi_desc_pool_dma2virt(struct k3_cppi_desc_pool *pool, dma_addr_t dma)\n{\n\treturn dma ? pool->cpumem + (dma - pool->dma_addr) : NULL;\n}\nEXPORT_SYMBOL_GPL(k3_cppi_desc_pool_dma2virt);\n\nvoid *k3_cppi_desc_pool_alloc(struct k3_cppi_desc_pool *pool)\n{\n\treturn (void *)gen_pool_alloc(pool->gen_pool, pool->desc_size);\n}\nEXPORT_SYMBOL_GPL(k3_cppi_desc_pool_alloc);\n\nvoid k3_cppi_desc_pool_free(struct k3_cppi_desc_pool *pool, void *addr)\n{\n\tgen_pool_free(pool->gen_pool, (unsigned long)addr, pool->desc_size);\n}\nEXPORT_SYMBOL_GPL(k3_cppi_desc_pool_free);\n\nsize_t k3_cppi_desc_pool_avail(struct k3_cppi_desc_pool *pool)\n{\n\treturn gen_pool_avail(pool->gen_pool) / pool->desc_size;\n}\nEXPORT_SYMBOL_GPL(k3_cppi_desc_pool_avail);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"TI K3 CPPI5 descriptors pool API\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}