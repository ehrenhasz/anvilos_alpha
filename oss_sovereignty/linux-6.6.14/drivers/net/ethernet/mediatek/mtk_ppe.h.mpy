{
  "module_name": "mtk_ppe.h",
  "hash_id": "d4a092f4728b2e04360a4dfc8b35ce4bf833bcaffacfb07da19d0b004f36b8ea",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/mediatek/mtk_ppe.h",
  "human_readable_source": "\n \n\n#ifndef __MTK_PPE_H\n#define __MTK_PPE_H\n\n#include <linux/kernel.h>\n#include <linux/bitfield.h>\n#include <linux/rhashtable.h>\n\n#define MTK_PPE_ENTRIES_SHIFT\t\t3\n#define MTK_PPE_ENTRIES\t\t\t(1024 << MTK_PPE_ENTRIES_SHIFT)\n#define MTK_PPE_HASH_MASK\t\t(MTK_PPE_ENTRIES - 1)\n#define MTK_PPE_WAIT_TIMEOUT_US\t\t1000000\n\n#define MTK_FOE_IB1_UNBIND_TIMESTAMP\tGENMASK(7, 0)\n#define MTK_FOE_IB1_UNBIND_PACKETS\tGENMASK(23, 8)\n#define MTK_FOE_IB1_UNBIND_PREBIND\tBIT(24)\n\n#define MTK_FOE_IB1_BIND_TIMESTAMP\tGENMASK(14, 0)\n#define MTK_FOE_IB1_BIND_KEEPALIVE\tBIT(15)\n#define MTK_FOE_IB1_BIND_VLAN_LAYER\tGENMASK(18, 16)\n#define MTK_FOE_IB1_BIND_PPPOE\t\tBIT(19)\n#define MTK_FOE_IB1_BIND_VLAN_TAG\tBIT(20)\n#define MTK_FOE_IB1_BIND_PKT_SAMPLE\tBIT(21)\n#define MTK_FOE_IB1_BIND_CACHE\t\tBIT(22)\n#define MTK_FOE_IB1_BIND_TUNNEL_DECAP\tBIT(23)\n#define MTK_FOE_IB1_BIND_TTL\t\tBIT(24)\n\n#define MTK_FOE_IB1_PACKET_TYPE\t\tGENMASK(27, 25)\n#define MTK_FOE_IB1_STATE\t\tGENMASK(29, 28)\n#define MTK_FOE_IB1_UDP\t\t\tBIT(30)\n#define MTK_FOE_IB1_STATIC\t\tBIT(31)\n\n \n#define MTK_FOE_IB1_BIND_TIMESTAMP_V2\tGENMASK(7, 0)\n#define MTK_FOE_IB1_BIND_VLAN_LAYER_V2\tGENMASK(16, 14)\n#define MTK_FOE_IB1_BIND_PPPOE_V2\tBIT(17)\n#define MTK_FOE_IB1_BIND_VLAN_TAG_V2\tBIT(18)\n#define MTK_FOE_IB1_BIND_CACHE_V2\tBIT(20)\n#define MTK_FOE_IB1_BIND_TTL_V2\t\tBIT(22)\n#define MTK_FOE_IB1_PACKET_TYPE_V2\tGENMASK(27, 23)\n\nenum {\n\tMTK_PPE_PKT_TYPE_IPV4_HNAPT = 0,\n\tMTK_PPE_PKT_TYPE_IPV4_ROUTE = 1,\n\tMTK_PPE_PKT_TYPE_BRIDGE = 2,\n\tMTK_PPE_PKT_TYPE_IPV4_DSLITE = 3,\n\tMTK_PPE_PKT_TYPE_IPV6_ROUTE_3T = 4,\n\tMTK_PPE_PKT_TYPE_IPV6_ROUTE_5T = 5,\n\tMTK_PPE_PKT_TYPE_IPV6_6RD = 7,\n};\n\n#define MTK_FOE_IB2_QID\t\t\tGENMASK(3, 0)\n#define MTK_FOE_IB2_PSE_QOS\t\tBIT(4)\n#define MTK_FOE_IB2_DEST_PORT\t\tGENMASK(7, 5)\n#define MTK_FOE_IB2_MULTICAST\t\tBIT(8)\n#define MTK_FOE_IB2_MIB_CNT\t\tBIT(10)\n\n#define MTK_FOE_IB2_WDMA_QID2\t\tGENMASK(13, 12)\n#define MTK_FOE_IB2_MIB_CNT_V2\t\tBIT(15)\n#define MTK_FOE_IB2_WDMA_DEVIDX\t\tBIT(16)\n#define MTK_FOE_IB2_WDMA_WINFO\t\tBIT(17)\n\n#define MTK_FOE_IB2_PORT_MG\t\tGENMASK(17, 12)\n\n#define MTK_FOE_IB2_RX_IDX\t\tGENMASK(18, 17)\n#define MTK_FOE_IB2_PORT_AG\t\tGENMASK(23, 18)\n\n#define MTK_FOE_IB2_DSCP\t\tGENMASK(31, 24)\n\n \n#define MTK_FOE_IB2_QID_V2\t\t\tGENMASK(6, 0)\n#define MTK_FOE_IB2_PORT_MG_V2\t\tBIT(7)\n#define MTK_FOE_IB2_PSE_QOS_V2\t\tBIT(8)\n#define MTK_FOE_IB2_DEST_PORT_V2\tGENMASK(12, 9)\n#define MTK_FOE_IB2_MULTICAST_V2\tBIT(13)\n#define MTK_FOE_IB2_WDMA_WINFO_V2\tBIT(19)\n#define MTK_FOE_IB2_PORT_AG_V2\t\tGENMASK(23, 20)\n\n#define MTK_FOE_VLAN2_WINFO_BSS\t\tGENMASK(5, 0)\n#define MTK_FOE_VLAN2_WINFO_WCID\tGENMASK(13, 6)\n#define MTK_FOE_VLAN2_WINFO_RING\tGENMASK(15, 14)\n\n#define MTK_FOE_WINFO_BSS\t\tGENMASK(5, 0)\n#define MTK_FOE_WINFO_WCID\t\tGENMASK(15, 6)\n\n#define MTK_FOE_WINFO_BSS_V3\t\tGENMASK(23, 16)\n#define MTK_FOE_WINFO_WCID_V3\t\tGENMASK(15, 0)\n\n#define MTK_FOE_WINFO_PAO_USR_INFO\tGENMASK(15, 0)\n#define MTK_FOE_WINFO_PAO_TID\t\tGENMASK(19, 16)\n#define MTK_FOE_WINFO_PAO_IS_FIXEDRATE\tBIT(20)\n#define MTK_FOE_WINFO_PAO_IS_PRIOR\tBIT(21)\n#define MTK_FOE_WINFO_PAO_IS_SP\t\tBIT(22)\n#define MTK_FOE_WINFO_PAO_HF\t\tBIT(23)\n#define MTK_FOE_WINFO_PAO_AMSDU_EN\tBIT(24)\n\nenum {\n\tMTK_FOE_STATE_INVALID,\n\tMTK_FOE_STATE_UNBIND,\n\tMTK_FOE_STATE_BIND,\n\tMTK_FOE_STATE_FIN\n};\n\nstruct mtk_foe_mac_info {\n\tu16 vlan1;\n\tu16 etype;\n\n\tu32 dest_mac_hi;\n\n\tu16 vlan2;\n\tu16 dest_mac_lo;\n\n\tu32 src_mac_hi;\n\n\tu16 pppoe_id;\n\tu16 src_mac_lo;\n\n\t \n\tu16 minfo;\n\tu16 winfo;\n\n\t \n\tu32 w3info;\n\tu32 wpao;\n};\n\n \nstruct mtk_foe_bridge {\n\tu8 dest_mac[ETH_ALEN];\n\tu8 src_mac[ETH_ALEN];\n\tu16 vlan;\n\n\tstruct {} key_end;\n\n\tu32 ib2;\n\n\tstruct mtk_foe_mac_info l2;\n};\n\nstruct mtk_ipv4_tuple {\n\tu32 src_ip;\n\tu32 dest_ip;\n\tunion {\n\t\tstruct {\n\t\t\tu16 dest_port;\n\t\t\tu16 src_port;\n\t\t};\n\t\tstruct {\n\t\t\tu8 protocol;\n\t\t\tu8 _pad[3];  \n\t\t};\n\t\tu32 ports;\n\t};\n};\n\nstruct mtk_foe_ipv4 {\n\tstruct mtk_ipv4_tuple orig;\n\n\tu32 ib2;\n\n\tstruct mtk_ipv4_tuple new;\n\n\tu16 timestamp;\n\tu16 _rsv0[3];\n\n\tu32 udf_tsid;\n\n\tstruct mtk_foe_mac_info l2;\n};\n\nstruct mtk_foe_ipv4_dslite {\n\tstruct mtk_ipv4_tuple ip4;\n\n\tu32 tunnel_src_ip[4];\n\tu32 tunnel_dest_ip[4];\n\n\tu8 flow_label[3];\n\tu8 priority;\n\n\tu32 udf_tsid;\n\n\tu32 ib2;\n\n\tstruct mtk_foe_mac_info l2;\n};\n\nstruct mtk_foe_ipv6 {\n\tu32 src_ip[4];\n\tu32 dest_ip[4];\n\n\tunion {\n\t\tstruct {\n\t\t\tu8 protocol;\n\t\t\tu8 _pad[3];  \n\t\t};  \n\t\tstruct {\n\t\t\tu16 dest_port;\n\t\t\tu16 src_port;\n\t\t};  \n\t\tu32 ports;\n\t};\n\n\tu32 _rsv[3];\n\n\tu32 udf;\n\n\tu32 ib2;\n\tstruct mtk_foe_mac_info l2;\n};\n\nstruct mtk_foe_ipv6_6rd {\n\tu32 src_ip[4];\n\tu32 dest_ip[4];\n\tu16 dest_port;\n\tu16 src_port;\n\n\tu32 tunnel_src_ip;\n\tu32 tunnel_dest_ip;\n\n\tu16 hdr_csum;\n\tu8 dscp;\n\tu8 ttl;\n\n\tu8 flag;\n\tu8 pad;\n\tu8 per_flow_6rd_id;\n\tu8 pad2;\n\n\tu32 ib2;\n\tstruct mtk_foe_mac_info l2;\n};\n\n#define MTK_FOE_ENTRY_V1_SIZE\t80\n#define MTK_FOE_ENTRY_V2_SIZE\t96\n#define MTK_FOE_ENTRY_V3_SIZE\t128\n\nstruct mtk_foe_entry {\n\tu32 ib1;\n\n\tunion {\n\t\tstruct mtk_foe_bridge bridge;\n\t\tstruct mtk_foe_ipv4 ipv4;\n\t\tstruct mtk_foe_ipv4_dslite dslite;\n\t\tstruct mtk_foe_ipv6 ipv6;\n\t\tstruct mtk_foe_ipv6_6rd ipv6_6rd;\n\t\tu32 data[31];\n\t};\n};\n\nenum {\n\tMTK_PPE_CPU_REASON_TTL_EXCEEDED\t\t\t= 0x02,\n\tMTK_PPE_CPU_REASON_OPTION_HEADER\t\t= 0x03,\n\tMTK_PPE_CPU_REASON_NO_FLOW\t\t\t= 0x07,\n\tMTK_PPE_CPU_REASON_IPV4_FRAG\t\t\t= 0x08,\n\tMTK_PPE_CPU_REASON_IPV4_DSLITE_FRAG\t\t= 0x09,\n\tMTK_PPE_CPU_REASON_IPV4_DSLITE_NO_TCP_UDP\t= 0x0a,\n\tMTK_PPE_CPU_REASON_IPV6_6RD_NO_TCP_UDP\t\t= 0x0b,\n\tMTK_PPE_CPU_REASON_TCP_FIN_SYN_RST\t\t= 0x0c,\n\tMTK_PPE_CPU_REASON_UN_HIT\t\t\t= 0x0d,\n\tMTK_PPE_CPU_REASON_HIT_UNBIND\t\t\t= 0x0e,\n\tMTK_PPE_CPU_REASON_HIT_UNBIND_RATE_REACHED\t= 0x0f,\n\tMTK_PPE_CPU_REASON_HIT_BIND_TCP_FIN\t\t= 0x10,\n\tMTK_PPE_CPU_REASON_HIT_TTL_1\t\t\t= 0x11,\n\tMTK_PPE_CPU_REASON_HIT_BIND_VLAN_VIOLATION\t= 0x12,\n\tMTK_PPE_CPU_REASON_KEEPALIVE_UC_OLD_HDR\t\t= 0x13,\n\tMTK_PPE_CPU_REASON_KEEPALIVE_MC_NEW_HDR\t\t= 0x14,\n\tMTK_PPE_CPU_REASON_KEEPALIVE_DUP_OLD_HDR\t= 0x15,\n\tMTK_PPE_CPU_REASON_HIT_BIND_FORCE_CPU\t\t= 0x16,\n\tMTK_PPE_CPU_REASON_TUNNEL_OPTION_HEADER\t\t= 0x17,\n\tMTK_PPE_CPU_REASON_MULTICAST_TO_CPU\t\t= 0x18,\n\tMTK_PPE_CPU_REASON_MULTICAST_TO_GMAC1_CPU\t= 0x19,\n\tMTK_PPE_CPU_REASON_HIT_PRE_BIND\t\t\t= 0x1a,\n\tMTK_PPE_CPU_REASON_PACKET_SAMPLING\t\t= 0x1b,\n\tMTK_PPE_CPU_REASON_EXCEED_MTU\t\t\t= 0x1c,\n\tMTK_PPE_CPU_REASON_PPE_BYPASS\t\t\t= 0x1e,\n\tMTK_PPE_CPU_REASON_INVALID\t\t\t= 0x1f,\n};\n\nenum {\n\tMTK_FLOW_TYPE_L4,\n\tMTK_FLOW_TYPE_L2,\n\tMTK_FLOW_TYPE_L2_SUBFLOW,\n};\n\nstruct mtk_flow_entry {\n\tunion {\n\t\tstruct hlist_node list;\n\t\tstruct {\n\t\t\tstruct rhash_head l2_node;\n\t\t\tstruct hlist_head l2_flows;\n\t\t};\n\t};\n\tu8 type;\n\ts8 wed_index;\n\tu8 ppe_index;\n\tu16 hash;\n\tunion {\n\t\tstruct mtk_foe_entry data;\n\t\tstruct {\n\t\t\tstruct mtk_flow_entry *base_flow;\n\t\t\tstruct hlist_node list;\n\t\t} l2_data;\n\t};\n\tstruct rhash_head node;\n\tunsigned long cookie;\n};\n\nstruct mtk_mib_entry {\n\tu32\tbyt_cnt_l;\n\tu16\tbyt_cnt_h;\n\tu32\tpkt_cnt_l;\n\tu8\tpkt_cnt_h;\n\tu8\t_rsv0;\n\tu32\t_rsv1;\n} __packed;\n\nstruct mtk_foe_accounting {\n\tu64\tbytes;\n\tu64\tpackets;\n};\n\nstruct mtk_ppe {\n\tstruct mtk_eth *eth;\n\tstruct device *dev;\n\tvoid __iomem *base;\n\tint version;\n\tchar dirname[5];\n\tbool accounting;\n\n\tvoid *foe_table;\n\tdma_addr_t foe_phys;\n\n\tstruct mtk_mib_entry *mib_table;\n\tdma_addr_t mib_phys;\n\n\tu16 foe_check_time[MTK_PPE_ENTRIES];\n\tstruct hlist_head *foe_flow;\n\n\tstruct rhashtable l2_flows;\n\n\tvoid *acct_table;\n};\n\nstruct mtk_ppe *mtk_ppe_init(struct mtk_eth *eth, void __iomem *base, int index);\n\nvoid mtk_ppe_deinit(struct mtk_eth *eth);\nvoid mtk_ppe_start(struct mtk_ppe *ppe);\nint mtk_ppe_stop(struct mtk_ppe *ppe);\nint mtk_ppe_prepare_reset(struct mtk_ppe *ppe);\n\nvoid __mtk_ppe_check_skb(struct mtk_ppe *ppe, struct sk_buff *skb, u16 hash);\n\nstatic inline void\nmtk_ppe_check_skb(struct mtk_ppe *ppe, struct sk_buff *skb, u16 hash)\n{\n\tu16 now, diff;\n\n\tif (!ppe)\n\t\treturn;\n\n\tif (hash > MTK_PPE_HASH_MASK)\n\t\treturn;\n\n\tnow = (u16)jiffies;\n\tdiff = now - ppe->foe_check_time[hash];\n\tif (diff < HZ / 10)\n\t\treturn;\n\n\tppe->foe_check_time[hash] = now;\n\t__mtk_ppe_check_skb(ppe, skb, hash);\n}\n\nint mtk_foe_entry_prepare(struct mtk_eth *eth, struct mtk_foe_entry *entry,\n\t\t\t  int type, int l4proto, u8 pse_port, u8 *src_mac,\n\t\t\t  u8 *dest_mac);\nint mtk_foe_entry_set_pse_port(struct mtk_eth *eth,\n\t\t\t       struct mtk_foe_entry *entry, u8 port);\nint mtk_foe_entry_set_ipv4_tuple(struct mtk_eth *eth,\n\t\t\t\t struct mtk_foe_entry *entry, bool orig,\n\t\t\t\t __be32 src_addr, __be16 src_port,\n\t\t\t\t __be32 dest_addr, __be16 dest_port);\nint mtk_foe_entry_set_ipv6_tuple(struct mtk_eth *eth,\n\t\t\t\t struct mtk_foe_entry *entry,\n\t\t\t\t __be32 *src_addr, __be16 src_port,\n\t\t\t\t __be32 *dest_addr, __be16 dest_port);\nint mtk_foe_entry_set_dsa(struct mtk_eth *eth, struct mtk_foe_entry *entry,\n\t\t\t  int port);\nint mtk_foe_entry_set_vlan(struct mtk_eth *eth, struct mtk_foe_entry *entry,\n\t\t\t   int vid);\nint mtk_foe_entry_set_pppoe(struct mtk_eth *eth, struct mtk_foe_entry *entry,\n\t\t\t    int sid);\nint mtk_foe_entry_set_wdma(struct mtk_eth *eth, struct mtk_foe_entry *entry,\n\t\t\t   int wdma_idx, int txq, int bss, int wcid);\nint mtk_foe_entry_set_queue(struct mtk_eth *eth, struct mtk_foe_entry *entry,\n\t\t\t    unsigned int queue);\nint mtk_foe_entry_commit(struct mtk_ppe *ppe, struct mtk_flow_entry *entry);\nvoid mtk_foe_entry_clear(struct mtk_ppe *ppe, struct mtk_flow_entry *entry);\nint mtk_foe_entry_idle_time(struct mtk_ppe *ppe, struct mtk_flow_entry *entry);\nint mtk_ppe_debugfs_init(struct mtk_ppe *ppe, int index);\nstruct mtk_foe_accounting *mtk_foe_entry_get_mib(struct mtk_ppe *ppe, u32 index,\n\t\t\t\t\t\t struct mtk_foe_accounting *diff);\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}