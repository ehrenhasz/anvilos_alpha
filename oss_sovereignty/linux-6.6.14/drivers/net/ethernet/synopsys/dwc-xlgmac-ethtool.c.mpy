{
  "module_name": "dwc-xlgmac-ethtool.c",
  "hash_id": "5d21981feb8f47ae7754d4d903212159cdf28155706eef774a267f2f847e9ae5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/synopsys/dwc-xlgmac-ethtool.c",
  "human_readable_source": " \n\n#include <linux/ethtool.h>\n#include <linux/kernel.h>\n#include <linux/netdevice.h>\n\n#include \"dwc-xlgmac.h\"\n#include \"dwc-xlgmac-reg.h\"\n\nstruct xlgmac_stats_desc {\n\tchar stat_string[ETH_GSTRING_LEN];\n\tint stat_offset;\n};\n\n#define XLGMAC_STAT(str, var)\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\\\n\t\tstr,\t\t\t\t\t\t\\\n\t\toffsetof(struct xlgmac_pdata, stats.var),\t\\\n\t}\n\nstatic const struct xlgmac_stats_desc xlgmac_gstring_stats[] = {\n\t \n\tXLGMAC_STAT(\"tx_bytes\", txoctetcount_gb),\n\tXLGMAC_STAT(\"tx_bytes_good\", txoctetcount_g),\n\tXLGMAC_STAT(\"tx_packets\", txframecount_gb),\n\tXLGMAC_STAT(\"tx_packets_good\", txframecount_g),\n\tXLGMAC_STAT(\"tx_unicast_packets\", txunicastframes_gb),\n\tXLGMAC_STAT(\"tx_broadcast_packets\", txbroadcastframes_gb),\n\tXLGMAC_STAT(\"tx_broadcast_packets_good\", txbroadcastframes_g),\n\tXLGMAC_STAT(\"tx_multicast_packets\", txmulticastframes_gb),\n\tXLGMAC_STAT(\"tx_multicast_packets_good\", txmulticastframes_g),\n\tXLGMAC_STAT(\"tx_vlan_packets_good\", txvlanframes_g),\n\tXLGMAC_STAT(\"tx_64_byte_packets\", tx64octets_gb),\n\tXLGMAC_STAT(\"tx_65_to_127_byte_packets\", tx65to127octets_gb),\n\tXLGMAC_STAT(\"tx_128_to_255_byte_packets\", tx128to255octets_gb),\n\tXLGMAC_STAT(\"tx_256_to_511_byte_packets\", tx256to511octets_gb),\n\tXLGMAC_STAT(\"tx_512_to_1023_byte_packets\", tx512to1023octets_gb),\n\tXLGMAC_STAT(\"tx_1024_to_max_byte_packets\", tx1024tomaxoctets_gb),\n\tXLGMAC_STAT(\"tx_underflow_errors\", txunderflowerror),\n\tXLGMAC_STAT(\"tx_pause_frames\", txpauseframes),\n\n\t \n\tXLGMAC_STAT(\"rx_bytes\", rxoctetcount_gb),\n\tXLGMAC_STAT(\"rx_bytes_good\", rxoctetcount_g),\n\tXLGMAC_STAT(\"rx_packets\", rxframecount_gb),\n\tXLGMAC_STAT(\"rx_unicast_packets_good\", rxunicastframes_g),\n\tXLGMAC_STAT(\"rx_broadcast_packets_good\", rxbroadcastframes_g),\n\tXLGMAC_STAT(\"rx_multicast_packets_good\", rxmulticastframes_g),\n\tXLGMAC_STAT(\"rx_vlan_packets\", rxvlanframes_gb),\n\tXLGMAC_STAT(\"rx_64_byte_packets\", rx64octets_gb),\n\tXLGMAC_STAT(\"rx_65_to_127_byte_packets\", rx65to127octets_gb),\n\tXLGMAC_STAT(\"rx_128_to_255_byte_packets\", rx128to255octets_gb),\n\tXLGMAC_STAT(\"rx_256_to_511_byte_packets\", rx256to511octets_gb),\n\tXLGMAC_STAT(\"rx_512_to_1023_byte_packets\", rx512to1023octets_gb),\n\tXLGMAC_STAT(\"rx_1024_to_max_byte_packets\", rx1024tomaxoctets_gb),\n\tXLGMAC_STAT(\"rx_undersize_packets_good\", rxundersize_g),\n\tXLGMAC_STAT(\"rx_oversize_packets_good\", rxoversize_g),\n\tXLGMAC_STAT(\"rx_crc_errors\", rxcrcerror),\n\tXLGMAC_STAT(\"rx_crc_errors_small_packets\", rxrunterror),\n\tXLGMAC_STAT(\"rx_crc_errors_giant_packets\", rxjabbererror),\n\tXLGMAC_STAT(\"rx_length_errors\", rxlengtherror),\n\tXLGMAC_STAT(\"rx_out_of_range_errors\", rxoutofrangetype),\n\tXLGMAC_STAT(\"rx_fifo_overflow_errors\", rxfifooverflow),\n\tXLGMAC_STAT(\"rx_watchdog_errors\", rxwatchdogerror),\n\tXLGMAC_STAT(\"rx_pause_frames\", rxpauseframes),\n\n\t \n\tXLGMAC_STAT(\"tx_tso_packets\", tx_tso_packets),\n\tXLGMAC_STAT(\"rx_split_header_packets\", rx_split_header_packets),\n\tXLGMAC_STAT(\"tx_process_stopped\", tx_process_stopped),\n\tXLGMAC_STAT(\"rx_process_stopped\", rx_process_stopped),\n\tXLGMAC_STAT(\"tx_buffer_unavailable\", tx_buffer_unavailable),\n\tXLGMAC_STAT(\"rx_buffer_unavailable\", rx_buffer_unavailable),\n\tXLGMAC_STAT(\"fatal_bus_error\", fatal_bus_error),\n\tXLGMAC_STAT(\"tx_vlan_packets\", tx_vlan_packets),\n\tXLGMAC_STAT(\"rx_vlan_packets\", rx_vlan_packets),\n\tXLGMAC_STAT(\"napi_poll_isr\", napi_poll_isr),\n\tXLGMAC_STAT(\"napi_poll_txtimer\", napi_poll_txtimer),\n};\n\n#define XLGMAC_STATS_COUNT\tARRAY_SIZE(xlgmac_gstring_stats)\n\nstatic void xlgmac_ethtool_get_drvinfo(struct net_device *netdev,\n\t\t\t\t       struct ethtool_drvinfo *drvinfo)\n{\n\tstruct xlgmac_pdata *pdata = netdev_priv(netdev);\n\tu32 ver = pdata->hw_feat.version;\n\tu32 snpsver, devid, userver;\n\n\tstrscpy(drvinfo->driver, pdata->drv_name, sizeof(drvinfo->driver));\n\tstrscpy(drvinfo->version, pdata->drv_ver, sizeof(drvinfo->version));\n\tstrscpy(drvinfo->bus_info, dev_name(pdata->dev),\n\t\tsizeof(drvinfo->bus_info));\n\t \n\tsnpsver = XLGMAC_GET_REG_BITS(ver, MAC_VR_SNPSVER_POS,\n\t\t\t\t      MAC_VR_SNPSVER_LEN);\n\tdevid = XLGMAC_GET_REG_BITS(ver, MAC_VR_DEVID_POS,\n\t\t\t\t    MAC_VR_DEVID_LEN);\n\tuserver = XLGMAC_GET_REG_BITS(ver, MAC_VR_USERVER_POS,\n\t\t\t\t      MAC_VR_USERVER_LEN);\n\tsnprintf(drvinfo->fw_version, sizeof(drvinfo->fw_version),\n\t\t \"S.D.U: %x.%x.%x\", snpsver, devid, userver);\n}\n\nstatic u32 xlgmac_ethtool_get_msglevel(struct net_device *netdev)\n{\n\tstruct xlgmac_pdata *pdata = netdev_priv(netdev);\n\n\treturn pdata->msg_enable;\n}\n\nstatic void xlgmac_ethtool_set_msglevel(struct net_device *netdev,\n\t\t\t\t\tu32 msglevel)\n{\n\tstruct xlgmac_pdata *pdata = netdev_priv(netdev);\n\n\tpdata->msg_enable = msglevel;\n}\n\nstatic void xlgmac_ethtool_get_channels(struct net_device *netdev,\n\t\t\t\t\tstruct ethtool_channels *channel)\n{\n\tstruct xlgmac_pdata *pdata = netdev_priv(netdev);\n\n\tchannel->max_rx = XLGMAC_MAX_DMA_CHANNELS;\n\tchannel->max_tx = XLGMAC_MAX_DMA_CHANNELS;\n\tchannel->rx_count = pdata->rx_q_count;\n\tchannel->tx_count = pdata->tx_q_count;\n}\n\nstatic int\nxlgmac_ethtool_get_coalesce(struct net_device *netdev,\n\t\t\t    struct ethtool_coalesce *ec,\n\t\t\t    struct kernel_ethtool_coalesce *kernel_coal,\n\t\t\t    struct netlink_ext_ack *extack)\n{\n\tstruct xlgmac_pdata *pdata = netdev_priv(netdev);\n\n\tec->rx_coalesce_usecs = pdata->rx_usecs;\n\tec->rx_max_coalesced_frames = pdata->rx_frames;\n\tec->tx_max_coalesced_frames = pdata->tx_frames;\n\n\treturn 0;\n}\n\nstatic int\nxlgmac_ethtool_set_coalesce(struct net_device *netdev,\n\t\t\t    struct ethtool_coalesce *ec,\n\t\t\t    struct kernel_ethtool_coalesce *kernel_coal,\n\t\t\t    struct netlink_ext_ack *extack)\n{\n\tstruct xlgmac_pdata *pdata = netdev_priv(netdev);\n\tstruct xlgmac_hw_ops *hw_ops = &pdata->hw_ops;\n\tunsigned int rx_frames, rx_riwt, rx_usecs;\n\tunsigned int tx_frames;\n\n\trx_usecs = ec->rx_coalesce_usecs;\n\trx_riwt = hw_ops->usec_to_riwt(pdata, rx_usecs);\n\trx_frames = ec->rx_max_coalesced_frames;\n\ttx_frames = ec->tx_max_coalesced_frames;\n\n\tif ((rx_riwt > XLGMAC_MAX_DMA_RIWT) ||\n\t    (rx_riwt < XLGMAC_MIN_DMA_RIWT) ||\n\t    (rx_frames > pdata->rx_desc_count))\n\t\treturn -EINVAL;\n\n\tif (tx_frames > pdata->tx_desc_count)\n\t\treturn -EINVAL;\n\n\tpdata->rx_riwt = rx_riwt;\n\tpdata->rx_usecs = rx_usecs;\n\tpdata->rx_frames = rx_frames;\n\thw_ops->config_rx_coalesce(pdata);\n\n\tpdata->tx_frames = tx_frames;\n\thw_ops->config_tx_coalesce(pdata);\n\n\treturn 0;\n}\n\nstatic void xlgmac_ethtool_get_strings(struct net_device *netdev,\n\t\t\t\t       u32 stringset, u8 *data)\n{\n\tint i;\n\n\tswitch (stringset) {\n\tcase ETH_SS_STATS:\n\t\tfor (i = 0; i < XLGMAC_STATS_COUNT; i++) {\n\t\t\tmemcpy(data, xlgmac_gstring_stats[i].stat_string,\n\t\t\t       ETH_GSTRING_LEN);\n\t\t\tdata += ETH_GSTRING_LEN;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON(1);\n\t\tbreak;\n\t}\n}\n\nstatic int xlgmac_ethtool_get_sset_count(struct net_device *netdev,\n\t\t\t\t\t int stringset)\n{\n\tint ret;\n\n\tswitch (stringset) {\n\tcase ETH_SS_STATS:\n\t\tret = XLGMAC_STATS_COUNT;\n\t\tbreak;\n\n\tdefault:\n\t\tret = -EOPNOTSUPP;\n\t}\n\n\treturn ret;\n}\n\nstatic void xlgmac_ethtool_get_ethtool_stats(struct net_device *netdev,\n\t\t\t\t\t     struct ethtool_stats *stats,\n\t\t\t\t\t     u64 *data)\n{\n\tstruct xlgmac_pdata *pdata = netdev_priv(netdev);\n\tu8 *stat;\n\tint i;\n\n\tpdata->hw_ops.read_mmc_stats(pdata);\n\tfor (i = 0; i < XLGMAC_STATS_COUNT; i++) {\n\t\tstat = (u8 *)pdata + xlgmac_gstring_stats[i].stat_offset;\n\t\t*data++ = *(u64 *)stat;\n\t}\n}\n\nstatic const struct ethtool_ops xlgmac_ethtool_ops = {\n\t.supported_coalesce_params = ETHTOOL_COALESCE_RX_USECS |\n\t\t\t\t     ETHTOOL_COALESCE_MAX_FRAMES,\n\t.get_drvinfo = xlgmac_ethtool_get_drvinfo,\n\t.get_link = ethtool_op_get_link,\n\t.get_msglevel = xlgmac_ethtool_get_msglevel,\n\t.set_msglevel = xlgmac_ethtool_set_msglevel,\n\t.get_channels = xlgmac_ethtool_get_channels,\n\t.get_coalesce = xlgmac_ethtool_get_coalesce,\n\t.set_coalesce = xlgmac_ethtool_set_coalesce,\n\t.get_strings = xlgmac_ethtool_get_strings,\n\t.get_sset_count = xlgmac_ethtool_get_sset_count,\n\t.get_ethtool_stats = xlgmac_ethtool_get_ethtool_stats,\n};\n\nconst struct ethtool_ops *xlgmac_get_ethtool_ops(void)\n{\n\treturn &xlgmac_ethtool_ops;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}