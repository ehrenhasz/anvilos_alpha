{
  "module_name": "dwc-xlgmac-hw.c",
  "hash_id": "092040ca896dd5ef437292b32784c5aa12ce500f656a3f49a7670d77a7196e7f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/synopsys/dwc-xlgmac-hw.c",
  "human_readable_source": " \n\n#include <linux/phy.h>\n#include <linux/mdio.h>\n#include <linux/clk.h>\n#include <linux/bitrev.h>\n#include <linux/crc32.h>\n#include <linux/crc32poly.h>\n#include <linux/dcbnl.h>\n\n#include \"dwc-xlgmac.h\"\n#include \"dwc-xlgmac-reg.h\"\n\nstatic int xlgmac_tx_complete(struct xlgmac_dma_desc *dma_desc)\n{\n\treturn !XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\tTX_NORMAL_DESC3_OWN_POS,\n\t\t\t\tTX_NORMAL_DESC3_OWN_LEN);\n}\n\nstatic int xlgmac_disable_rx_csum(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + MAC_RCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_IPC_POS,\n\t\t\t\t     MAC_RCR_IPC_LEN, 0);\n\twritel(regval, pdata->mac_regs + MAC_RCR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_enable_rx_csum(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + MAC_RCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_IPC_POS,\n\t\t\t\t     MAC_RCR_IPC_LEN, 1);\n\twritel(regval, pdata->mac_regs + MAC_RCR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_set_mac_address(struct xlgmac_pdata *pdata, const u8 *addr)\n{\n\tunsigned int mac_addr_hi, mac_addr_lo;\n\n\tmac_addr_hi = (addr[5] <<  8) | (addr[4] <<  0);\n\tmac_addr_lo = (addr[3] << 24) | (addr[2] << 16) |\n\t\t      (addr[1] <<  8) | (addr[0] <<  0);\n\n\twritel(mac_addr_hi, pdata->mac_regs + MAC_MACA0HR);\n\twritel(mac_addr_lo, pdata->mac_regs + MAC_MACA0LR);\n\n\treturn 0;\n}\n\nstatic void xlgmac_set_mac_reg(struct xlgmac_pdata *pdata,\n\t\t\t       struct netdev_hw_addr *ha,\n\t\t\t       unsigned int *mac_reg)\n{\n\tunsigned int mac_addr_hi, mac_addr_lo;\n\tu8 *mac_addr;\n\n\tmac_addr_lo = 0;\n\tmac_addr_hi = 0;\n\n\tif (ha) {\n\t\tmac_addr = (u8 *)&mac_addr_lo;\n\t\tmac_addr[0] = ha->addr[0];\n\t\tmac_addr[1] = ha->addr[1];\n\t\tmac_addr[2] = ha->addr[2];\n\t\tmac_addr[3] = ha->addr[3];\n\t\tmac_addr = (u8 *)&mac_addr_hi;\n\t\tmac_addr[0] = ha->addr[4];\n\t\tmac_addr[1] = ha->addr[5];\n\n\t\tnetif_dbg(pdata, drv, pdata->netdev,\n\t\t\t  \"adding mac address %pM at %#x\\n\",\n\t\t\t  ha->addr, *mac_reg);\n\n\t\tmac_addr_hi = XLGMAC_SET_REG_BITS(mac_addr_hi,\n\t\t\t\t\t\t  MAC_MACA1HR_AE_POS,\n\t\t\t\t\t\tMAC_MACA1HR_AE_LEN,\n\t\t\t\t\t\t1);\n\t}\n\n\twritel(mac_addr_hi, pdata->mac_regs + *mac_reg);\n\t*mac_reg += MAC_MACA_INC;\n\twritel(mac_addr_lo, pdata->mac_regs + *mac_reg);\n\t*mac_reg += MAC_MACA_INC;\n}\n\nstatic int xlgmac_enable_rx_vlan_stripping(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + MAC_VLANTR);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_EVLRXS_POS,\n\t\t\t\t     MAC_VLANTR_EVLRXS_LEN, 1);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_DOVLTC_POS,\n\t\t\t\t     MAC_VLANTR_DOVLTC_LEN, 1);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_ERSVLM_POS,\n\t\t\t\t     MAC_VLANTR_ERSVLM_LEN, 0);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_ESVL_POS,\n\t\t\t\t     MAC_VLANTR_ESVL_LEN, 0);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_EVLS_POS,\n\t\t\t\t     MAC_VLANTR_EVLS_LEN, 0x3);\n\twritel(regval, pdata->mac_regs + MAC_VLANTR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_disable_rx_vlan_stripping(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + MAC_VLANTR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_EVLS_POS,\n\t\t\t\t     MAC_VLANTR_EVLS_LEN, 0);\n\twritel(regval, pdata->mac_regs + MAC_VLANTR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_enable_rx_vlan_filtering(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + MAC_PFR);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_VTFE_POS,\n\t\t\t\t     MAC_PFR_VTFE_LEN, 1);\n\twritel(regval, pdata->mac_regs + MAC_PFR);\n\n\tregval = readl(pdata->mac_regs + MAC_VLANTR);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_VTHM_POS,\n\t\t\t\t     MAC_VLANTR_VTHM_LEN, 1);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_VTIM_POS,\n\t\t\t\t     MAC_VLANTR_VTIM_LEN, 0);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_ETV_POS,\n\t\t\t\t     MAC_VLANTR_ETV_LEN, 1);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANTR_VL_POS,\n\t\t\t\t     MAC_VLANTR_VL_LEN, 1);\n\twritel(regval, pdata->mac_regs + MAC_VLANTR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_disable_rx_vlan_filtering(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + MAC_PFR);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_VTFE_POS,\n\t\t\t\t     MAC_PFR_VTFE_LEN, 0);\n\twritel(regval, pdata->mac_regs + MAC_PFR);\n\n\treturn 0;\n}\n\nstatic u32 xlgmac_vid_crc32_le(__le16 vid_le)\n{\n\tunsigned char *data = (unsigned char *)&vid_le;\n\tunsigned char data_byte = 0;\n\tu32 crc = ~0;\n\tu32 temp = 0;\n\tint i, bits;\n\n\tbits = get_bitmask_order(VLAN_VID_MASK);\n\tfor (i = 0; i < bits; i++) {\n\t\tif ((i % 8) == 0)\n\t\t\tdata_byte = data[i / 8];\n\n\t\ttemp = ((crc & 1) ^ data_byte) & 1;\n\t\tcrc >>= 1;\n\t\tdata_byte >>= 1;\n\n\t\tif (temp)\n\t\t\tcrc ^= CRC32_POLY_LE;\n\t}\n\n\treturn crc;\n}\n\nstatic int xlgmac_update_vlan_hash_table(struct xlgmac_pdata *pdata)\n{\n\tu16 vlan_hash_table = 0;\n\t__le16 vid_le;\n\tu32 regval;\n\tu32 crc;\n\tu16 vid;\n\n\t \n\tfor_each_set_bit(vid, pdata->active_vlans, VLAN_N_VID) {\n\t\t \n\t\tvid_le = cpu_to_le16(vid);\n\t\tcrc = bitrev32(~xlgmac_vid_crc32_le(vid_le)) >> 28;\n\n\t\tvlan_hash_table |= (1 << crc);\n\t}\n\n\tregval = readl(pdata->mac_regs + MAC_VLANHTR);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANHTR_VLHT_POS,\n\t\t\t\t     MAC_VLANHTR_VLHT_LEN, vlan_hash_table);\n\twritel(regval, pdata->mac_regs + MAC_VLANHTR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_set_promiscuous_mode(struct xlgmac_pdata *pdata,\n\t\t\t\t       unsigned int enable)\n{\n\tunsigned int val = enable ? 1 : 0;\n\tu32 regval;\n\n\tregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_PFR),\n\t\t\t\t     MAC_PFR_PR_POS, MAC_PFR_PR_LEN);\n\tif (regval == val)\n\t\treturn 0;\n\n\tnetif_dbg(pdata, drv, pdata->netdev, \"%s promiscuous mode\\n\",\n\t\t  enable ? \"entering\" : \"leaving\");\n\n\tregval = readl(pdata->mac_regs + MAC_PFR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_PR_POS,\n\t\t\t\t     MAC_PFR_PR_LEN, val);\n\twritel(regval, pdata->mac_regs + MAC_PFR);\n\n\t \n\tif (enable) {\n\t\txlgmac_disable_rx_vlan_filtering(pdata);\n\t} else {\n\t\tif (pdata->netdev->features & NETIF_F_HW_VLAN_CTAG_FILTER)\n\t\t\txlgmac_enable_rx_vlan_filtering(pdata);\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_set_all_multicast_mode(struct xlgmac_pdata *pdata,\n\t\t\t\t\t unsigned int enable)\n{\n\tunsigned int val = enable ? 1 : 0;\n\tu32 regval;\n\n\tregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_PFR),\n\t\t\t\t     MAC_PFR_PM_POS, MAC_PFR_PM_LEN);\n\tif (regval == val)\n\t\treturn 0;\n\n\tnetif_dbg(pdata, drv, pdata->netdev, \"%s allmulti mode\\n\",\n\t\t  enable ? \"entering\" : \"leaving\");\n\n\tregval = readl(pdata->mac_regs + MAC_PFR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_PM_POS,\n\t\t\t\t     MAC_PFR_PM_LEN, val);\n\twritel(regval, pdata->mac_regs + MAC_PFR);\n\n\treturn 0;\n}\n\nstatic void xlgmac_set_mac_addn_addrs(struct xlgmac_pdata *pdata)\n{\n\tstruct net_device *netdev = pdata->netdev;\n\tstruct netdev_hw_addr *ha;\n\tunsigned int addn_macs;\n\tunsigned int mac_reg;\n\n\tmac_reg = MAC_MACA1HR;\n\taddn_macs = pdata->hw_feat.addn_mac;\n\n\tif (netdev_uc_count(netdev) > addn_macs) {\n\t\txlgmac_set_promiscuous_mode(pdata, 1);\n\t} else {\n\t\tnetdev_for_each_uc_addr(ha, netdev) {\n\t\t\txlgmac_set_mac_reg(pdata, ha, &mac_reg);\n\t\t\taddn_macs--;\n\t\t}\n\n\t\tif (netdev_mc_count(netdev) > addn_macs) {\n\t\t\txlgmac_set_all_multicast_mode(pdata, 1);\n\t\t} else {\n\t\t\tnetdev_for_each_mc_addr(ha, netdev) {\n\t\t\t\txlgmac_set_mac_reg(pdata, ha, &mac_reg);\n\t\t\t\taddn_macs--;\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\twhile (addn_macs--)\n\t\txlgmac_set_mac_reg(pdata, NULL, &mac_reg);\n}\n\nstatic void xlgmac_set_mac_hash_table(struct xlgmac_pdata *pdata)\n{\n\tunsigned int hash_table_shift, hash_table_count;\n\tu32 hash_table[XLGMAC_MAC_HASH_TABLE_SIZE];\n\tstruct net_device *netdev = pdata->netdev;\n\tstruct netdev_hw_addr *ha;\n\tunsigned int hash_reg;\n\tunsigned int i;\n\tu32 crc;\n\n\thash_table_shift = 26 - (pdata->hw_feat.hash_table_size >> 7);\n\thash_table_count = pdata->hw_feat.hash_table_size / 32;\n\tmemset(hash_table, 0, sizeof(hash_table));\n\n\t \n\tnetdev_for_each_uc_addr(ha, netdev) {\n\t\tcrc = bitrev32(~crc32_le(~0, ha->addr, ETH_ALEN));\n\t\tcrc >>= hash_table_shift;\n\t\thash_table[crc >> 5] |= (1 << (crc & 0x1f));\n\t}\n\n\tnetdev_for_each_mc_addr(ha, netdev) {\n\t\tcrc = bitrev32(~crc32_le(~0, ha->addr, ETH_ALEN));\n\t\tcrc >>= hash_table_shift;\n\t\thash_table[crc >> 5] |= (1 << (crc & 0x1f));\n\t}\n\n\t \n\thash_reg = MAC_HTR0;\n\tfor (i = 0; i < hash_table_count; i++) {\n\t\twritel(hash_table[i], pdata->mac_regs + hash_reg);\n\t\thash_reg += MAC_HTR_INC;\n\t}\n}\n\nstatic int xlgmac_add_mac_addresses(struct xlgmac_pdata *pdata)\n{\n\tif (pdata->hw_feat.hash_table_size)\n\t\txlgmac_set_mac_hash_table(pdata);\n\telse\n\t\txlgmac_set_mac_addn_addrs(pdata);\n\n\treturn 0;\n}\n\nstatic void xlgmac_config_mac_address(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\txlgmac_set_mac_address(pdata, pdata->netdev->dev_addr);\n\n\t \n\tif (pdata->hw_feat.hash_table_size) {\n\t\tregval = readl(pdata->mac_regs + MAC_PFR);\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_HPF_POS,\n\t\t\t\t\t     MAC_PFR_HPF_LEN, 1);\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_HUC_POS,\n\t\t\t\t\t     MAC_PFR_HUC_LEN, 1);\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MAC_PFR_HMC_POS,\n\t\t\t\t\t     MAC_PFR_HMC_LEN, 1);\n\t\twritel(regval, pdata->mac_regs + MAC_PFR);\n\t}\n}\n\nstatic void xlgmac_config_jumbo_enable(struct xlgmac_pdata *pdata)\n{\n\tunsigned int val;\n\tu32 regval;\n\n\tval = (pdata->netdev->mtu > XLGMAC_STD_PACKET_MTU) ? 1 : 0;\n\n\tregval = readl(pdata->mac_regs + MAC_RCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_JE_POS,\n\t\t\t\t     MAC_RCR_JE_LEN, val);\n\twritel(regval, pdata->mac_regs + MAC_RCR);\n}\n\nstatic void xlgmac_config_checksum_offload(struct xlgmac_pdata *pdata)\n{\n\tif (pdata->netdev->features & NETIF_F_RXCSUM)\n\t\txlgmac_enable_rx_csum(pdata);\n\telse\n\t\txlgmac_disable_rx_csum(pdata);\n}\n\nstatic void xlgmac_config_vlan_support(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + MAC_VLANIR);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANIR_CSVL_POS,\n\t\t\t\t     MAC_VLANIR_CSVL_LEN, 0);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_VLANIR_VLTI_POS,\n\t\t\t\t     MAC_VLANIR_VLTI_LEN, 1);\n\twritel(regval, pdata->mac_regs + MAC_VLANIR);\n\n\t \n\txlgmac_update_vlan_hash_table(pdata);\n\n\tif (pdata->netdev->features & NETIF_F_HW_VLAN_CTAG_FILTER)\n\t\txlgmac_enable_rx_vlan_filtering(pdata);\n\telse\n\t\txlgmac_disable_rx_vlan_filtering(pdata);\n\n\tif (pdata->netdev->features & NETIF_F_HW_VLAN_CTAG_RX)\n\t\txlgmac_enable_rx_vlan_stripping(pdata);\n\telse\n\t\txlgmac_disable_rx_vlan_stripping(pdata);\n}\n\nstatic int xlgmac_config_rx_mode(struct xlgmac_pdata *pdata)\n{\n\tstruct net_device *netdev = pdata->netdev;\n\tunsigned int pr_mode, am_mode;\n\n\tpr_mode = ((netdev->flags & IFF_PROMISC) != 0);\n\tam_mode = ((netdev->flags & IFF_ALLMULTI) != 0);\n\n\txlgmac_set_promiscuous_mode(pdata, pr_mode);\n\txlgmac_set_all_multicast_mode(pdata, am_mode);\n\n\txlgmac_add_mac_addresses(pdata);\n\n\treturn 0;\n}\n\nstatic void xlgmac_prepare_tx_stop(struct xlgmac_pdata *pdata,\n\t\t\t\t   struct xlgmac_channel *channel)\n{\n\tunsigned int tx_dsr, tx_pos, tx_qidx;\n\tunsigned long tx_timeout;\n\tunsigned int tx_status;\n\n\t \n\tif (channel->queue_index < DMA_DSRX_FIRST_QUEUE) {\n\t\ttx_dsr = DMA_DSR0;\n\t\ttx_pos = (channel->queue_index * DMA_DSR_Q_LEN) +\n\t\t\t DMA_DSR0_TPS_START;\n\t} else {\n\t\ttx_qidx = channel->queue_index - DMA_DSRX_FIRST_QUEUE;\n\n\t\ttx_dsr = DMA_DSR1 + ((tx_qidx / DMA_DSRX_QPR) * DMA_DSRX_INC);\n\t\ttx_pos = ((tx_qidx % DMA_DSRX_QPR) * DMA_DSR_Q_LEN) +\n\t\t\t DMA_DSRX_TPS_START;\n\t}\n\n\t \n\ttx_timeout = jiffies + (XLGMAC_DMA_STOP_TIMEOUT * HZ);\n\twhile (time_before(jiffies, tx_timeout)) {\n\t\ttx_status = readl(pdata->mac_regs + tx_dsr);\n\t\ttx_status = XLGMAC_GET_REG_BITS(tx_status, tx_pos,\n\t\t\t\t\t\tDMA_DSR_TPS_LEN);\n\t\tif ((tx_status == DMA_TPS_STOPPED) ||\n\t\t    (tx_status == DMA_TPS_SUSPENDED))\n\t\t\tbreak;\n\n\t\tusleep_range(500, 1000);\n\t}\n\n\tif (!time_before(jiffies, tx_timeout))\n\t\tnetdev_info(pdata->netdev,\n\t\t\t    \"timed out waiting for Tx DMA channel %u to stop\\n\",\n\t\t\t    channel->queue_index);\n}\n\nstatic void xlgmac_enable_tx(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\t \n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->tx_ring)\n\t\t\tbreak;\n\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_TCR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_TCR_ST_POS,\n\t\t\t\t\t     DMA_CH_TCR_ST_LEN, 1);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_TCR));\n\t}\n\n\t \n\tfor (i = 0; i < pdata->tx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_TXQEN_POS,\n\t\t\t\t\t     MTL_Q_TQOMR_TXQEN_LEN,\n\t\t\t\t\tMTL_Q_ENABLED);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t}\n\n\t \n\tregval = readl(pdata->mac_regs + MAC_TCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_TE_POS,\n\t\t\t\t     MAC_TCR_TE_LEN, 1);\n\twritel(regval, pdata->mac_regs + MAC_TCR);\n}\n\nstatic void xlgmac_disable_tx(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\t \n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->tx_ring)\n\t\t\tbreak;\n\n\t\txlgmac_prepare_tx_stop(pdata, channel);\n\t}\n\n\t \n\tregval = readl(pdata->mac_regs + MAC_TCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_TE_POS,\n\t\t\t\t     MAC_TCR_TE_LEN, 0);\n\twritel(regval, pdata->mac_regs + MAC_TCR);\n\n\t \n\tfor (i = 0; i < pdata->tx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_TXQEN_POS,\n\t\t\t\t\t     MTL_Q_TQOMR_TXQEN_LEN, 0);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t}\n\n\t \n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->tx_ring)\n\t\t\tbreak;\n\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_TCR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_TCR_ST_POS,\n\t\t\t\t\t     DMA_CH_TCR_ST_LEN, 0);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_TCR));\n\t}\n}\n\nstatic void xlgmac_prepare_rx_stop(struct xlgmac_pdata *pdata,\n\t\t\t\t   unsigned int queue)\n{\n\tunsigned int rx_status, prxq, rxqsts;\n\tunsigned long rx_timeout;\n\n\t \n\trx_timeout = jiffies + (XLGMAC_DMA_STOP_TIMEOUT * HZ);\n\twhile (time_before(jiffies, rx_timeout)) {\n\t\trx_status = readl(XLGMAC_MTL_REG(pdata, queue, MTL_Q_RQDR));\n\t\tprxq = XLGMAC_GET_REG_BITS(rx_status, MTL_Q_RQDR_PRXQ_POS,\n\t\t\t\t\t   MTL_Q_RQDR_PRXQ_LEN);\n\t\trxqsts = XLGMAC_GET_REG_BITS(rx_status, MTL_Q_RQDR_RXQSTS_POS,\n\t\t\t\t\t     MTL_Q_RQDR_RXQSTS_LEN);\n\t\tif ((prxq == 0) && (rxqsts == 0))\n\t\t\tbreak;\n\n\t\tusleep_range(500, 1000);\n\t}\n\n\tif (!time_before(jiffies, rx_timeout))\n\t\tnetdev_info(pdata->netdev,\n\t\t\t    \"timed out waiting for Rx queue %u to empty\\n\",\n\t\t\t    queue);\n}\n\nstatic void xlgmac_enable_rx(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int regval, i;\n\n\t \n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->rx_ring)\n\t\t\tbreak;\n\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_RCR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_RCR_SR_POS,\n\t\t\t\t\t     DMA_CH_RCR_SR_LEN, 1);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_RCR));\n\t}\n\n\t \n\tregval = 0;\n\tfor (i = 0; i < pdata->rx_q_count; i++)\n\t\tregval |= (0x02 << (i << 1));\n\twritel(regval, pdata->mac_regs + MAC_RQC0R);\n\n\t \n\tregval = readl(pdata->mac_regs + MAC_RCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_DCRCC_POS,\n\t\t\t\t     MAC_RCR_DCRCC_LEN, 1);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_CST_POS,\n\t\t\t\t     MAC_RCR_CST_LEN, 1);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_ACS_POS,\n\t\t\t\t     MAC_RCR_ACS_LEN, 1);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_RE_POS,\n\t\t\t\t     MAC_RCR_RE_LEN, 1);\n\twritel(regval, pdata->mac_regs + MAC_RCR);\n}\n\nstatic void xlgmac_disable_rx(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\t \n\tregval = readl(pdata->mac_regs + MAC_RCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_DCRCC_POS,\n\t\t\t\t     MAC_RCR_DCRCC_LEN, 0);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_CST_POS,\n\t\t\t\t     MAC_RCR_CST_LEN, 0);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_ACS_POS,\n\t\t\t\t     MAC_RCR_ACS_LEN, 0);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_RE_POS,\n\t\t\t\t     MAC_RCR_RE_LEN, 0);\n\twritel(regval, pdata->mac_regs + MAC_RCR);\n\n\t \n\tfor (i = 0; i < pdata->rx_q_count; i++)\n\t\txlgmac_prepare_rx_stop(pdata, i);\n\n\t \n\twritel(0, pdata->mac_regs + MAC_RQC0R);\n\n\t \n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->rx_ring)\n\t\t\tbreak;\n\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_RCR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_RCR_SR_POS,\n\t\t\t\t\t     DMA_CH_RCR_SR_LEN, 0);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_RCR));\n\t}\n}\n\nstatic void xlgmac_tx_start_xmit(struct xlgmac_channel *channel,\n\t\t\t\t struct xlgmac_ring *ring)\n{\n\tstruct xlgmac_pdata *pdata = channel->pdata;\n\tstruct xlgmac_desc_data *desc_data;\n\n\t \n\twmb();\n\n\t \n\tdesc_data = XLGMAC_GET_DESC_DATA(ring, ring->cur);\n\twritel(lower_32_bits(desc_data->dma_desc_addr),\n\t       XLGMAC_DMA_REG(channel, DMA_CH_TDTR_LO));\n\n\t \n\tif (pdata->tx_usecs && !channel->tx_timer_active) {\n\t\tchannel->tx_timer_active = 1;\n\t\tmod_timer(&channel->tx_timer,\n\t\t\t  jiffies + usecs_to_jiffies(pdata->tx_usecs));\n\t}\n\n\tring->tx.xmit_more = 0;\n}\n\nstatic void xlgmac_dev_xmit(struct xlgmac_channel *channel)\n{\n\tstruct xlgmac_pdata *pdata = channel->pdata;\n\tstruct xlgmac_ring *ring = channel->tx_ring;\n\tunsigned int tso_context, vlan_context;\n\tstruct xlgmac_desc_data *desc_data;\n\tstruct xlgmac_dma_desc *dma_desc;\n\tstruct xlgmac_pkt_info *pkt_info;\n\tunsigned int csum, tso, vlan;\n\tint start_index = ring->cur;\n\tint cur_index = ring->cur;\n\tunsigned int tx_set_ic;\n\tint i;\n\n\tpkt_info = &ring->pkt_info;\n\tcsum = XLGMAC_GET_REG_BITS(pkt_info->attributes,\n\t\t\t\t   TX_PACKET_ATTRIBUTES_CSUM_ENABLE_POS,\n\t\t\t\tTX_PACKET_ATTRIBUTES_CSUM_ENABLE_LEN);\n\ttso = XLGMAC_GET_REG_BITS(pkt_info->attributes,\n\t\t\t\t  TX_PACKET_ATTRIBUTES_TSO_ENABLE_POS,\n\t\t\t\tTX_PACKET_ATTRIBUTES_TSO_ENABLE_LEN);\n\tvlan = XLGMAC_GET_REG_BITS(pkt_info->attributes,\n\t\t\t\t   TX_PACKET_ATTRIBUTES_VLAN_CTAG_POS,\n\t\t\t\tTX_PACKET_ATTRIBUTES_VLAN_CTAG_LEN);\n\n\tif (tso && (pkt_info->mss != ring->tx.cur_mss))\n\t\ttso_context = 1;\n\telse\n\t\ttso_context = 0;\n\n\tif (vlan && (pkt_info->vlan_ctag != ring->tx.cur_vlan_ctag))\n\t\tvlan_context = 1;\n\telse\n\t\tvlan_context = 0;\n\n\t \n\tring->coalesce_count += pkt_info->tx_packets;\n\tif (!pdata->tx_frames)\n\t\ttx_set_ic = 0;\n\telse if (pkt_info->tx_packets > pdata->tx_frames)\n\t\ttx_set_ic = 1;\n\telse if ((ring->coalesce_count % pdata->tx_frames) <\n\t\t pkt_info->tx_packets)\n\t\ttx_set_ic = 1;\n\telse\n\t\ttx_set_ic = 0;\n\n\tdesc_data = XLGMAC_GET_DESC_DATA(ring, cur_index);\n\tdma_desc = desc_data->dma_desc;\n\n\t \n\tif (tso_context || vlan_context) {\n\t\tif (tso_context) {\n\t\t\tnetif_dbg(pdata, tx_queued, pdata->netdev,\n\t\t\t\t  \"TSO context descriptor, mss=%u\\n\",\n\t\t\t\t  pkt_info->mss);\n\n\t\t\t \n\t\t\tdma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\t\tdma_desc->desc2,\n\t\t\t\t\t\tTX_CONTEXT_DESC2_MSS_POS,\n\t\t\t\t\t\tTX_CONTEXT_DESC2_MSS_LEN,\n\t\t\t\t\t\tpkt_info->mss);\n\n\t\t\t \n\t\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\t\tTX_CONTEXT_DESC3_CTXT_POS,\n\t\t\t\t\t\tTX_CONTEXT_DESC3_CTXT_LEN,\n\t\t\t\t\t\t1);\n\n\t\t\t \n\t\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\t\tTX_CONTEXT_DESC3_TCMSSV_POS,\n\t\t\t\t\t\tTX_CONTEXT_DESC3_TCMSSV_LEN,\n\t\t\t\t\t\t1);\n\n\t\t\tring->tx.cur_mss = pkt_info->mss;\n\t\t}\n\n\t\tif (vlan_context) {\n\t\t\tnetif_dbg(pdata, tx_queued, pdata->netdev,\n\t\t\t\t  \"VLAN context descriptor, ctag=%u\\n\",\n\t\t\t\t  pkt_info->vlan_ctag);\n\n\t\t\t \n\t\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\t\tTX_CONTEXT_DESC3_CTXT_POS,\n\t\t\t\t\t\tTX_CONTEXT_DESC3_CTXT_LEN,\n\t\t\t\t\t\t1);\n\n\t\t\t \n\t\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\t\tTX_CONTEXT_DESC3_VT_POS,\n\t\t\t\t\t\tTX_CONTEXT_DESC3_VT_LEN,\n\t\t\t\t\t\tpkt_info->vlan_ctag);\n\n\t\t\t \n\t\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\t\tTX_CONTEXT_DESC3_VLTV_POS,\n\t\t\t\t\t\tTX_CONTEXT_DESC3_VLTV_LEN,\n\t\t\t\t\t\t1);\n\n\t\t\tring->tx.cur_vlan_ctag = pkt_info->vlan_ctag;\n\t\t}\n\n\t\tcur_index++;\n\t\tdesc_data = XLGMAC_GET_DESC_DATA(ring, cur_index);\n\t\tdma_desc = desc_data->dma_desc;\n\t}\n\n\t \n\tdma_desc->desc0 =  cpu_to_le32(lower_32_bits(desc_data->skb_dma));\n\tdma_desc->desc1 =  cpu_to_le32(upper_32_bits(desc_data->skb_dma));\n\n\t \n\tdma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\tdma_desc->desc2,\n\t\t\t\tTX_NORMAL_DESC2_HL_B1L_POS,\n\t\t\t\tTX_NORMAL_DESC2_HL_B1L_LEN,\n\t\t\t\tdesc_data->skb_dma_len);\n\n\t \n\tif (vlan) {\n\t\tdma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc2,\n\t\t\t\t\tTX_NORMAL_DESC2_VTIR_POS,\n\t\t\t\t\tTX_NORMAL_DESC2_VTIR_LEN,\n\t\t\t\t\tTX_NORMAL_DESC2_VLAN_INSERT);\n\t\tpdata->stats.tx_vlan_packets++;\n\t}\n\n\t \n\tif (XLGMAC_GET_REG_BITS(pkt_info->attributes,\n\t\t\t\tTX_PACKET_ATTRIBUTES_PTP_POS,\n\t\t\t\tTX_PACKET_ATTRIBUTES_PTP_LEN))\n\t\tdma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc2,\n\t\t\t\t\tTX_NORMAL_DESC2_TTSE_POS,\n\t\t\t\t\tTX_NORMAL_DESC2_TTSE_LEN,\n\t\t\t\t\t1);\n\n\t \n\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\tdma_desc->desc3,\n\t\t\t\tTX_NORMAL_DESC3_FD_POS,\n\t\t\t\tTX_NORMAL_DESC3_FD_LEN,\n\t\t\t\t1);\n\n\t \n\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\tdma_desc->desc3,\n\t\t\t\tTX_NORMAL_DESC3_CTXT_POS,\n\t\t\t\tTX_NORMAL_DESC3_CTXT_LEN,\n\t\t\t\t0);\n\n\t \n\tif (cur_index != start_index)\n\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\tTX_NORMAL_DESC3_OWN_POS,\n\t\t\t\t\tTX_NORMAL_DESC3_OWN_LEN,\n\t\t\t\t\t1);\n\n\tif (tso) {\n\t\t \n\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\tTX_NORMAL_DESC3_TSE_POS,\n\t\t\t\t\tTX_NORMAL_DESC3_TSE_LEN, 1);\n\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\tTX_NORMAL_DESC3_TCPPL_POS,\n\t\t\t\t\tTX_NORMAL_DESC3_TCPPL_LEN,\n\t\t\t\t\tpkt_info->tcp_payload_len);\n\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\tTX_NORMAL_DESC3_TCPHDRLEN_POS,\n\t\t\t\t\tTX_NORMAL_DESC3_TCPHDRLEN_LEN,\n\t\t\t\t\tpkt_info->tcp_header_len / 4);\n\n\t\tpdata->stats.tx_tso_packets++;\n\t} else {\n\t\t \n\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\tTX_NORMAL_DESC3_CPC_POS,\n\t\t\t\t\tTX_NORMAL_DESC3_CPC_LEN, 0);\n\n\t\t \n\t\tif (csum)\n\t\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\t\tTX_NORMAL_DESC3_CIC_POS,\n\t\t\t\t\t\tTX_NORMAL_DESC3_CIC_LEN,\n\t\t\t\t\t\t0x3);\n\n\t\t \n\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\tTX_NORMAL_DESC3_FL_POS,\n\t\t\t\t\tTX_NORMAL_DESC3_FL_LEN,\n\t\t\t\t\tpkt_info->length);\n\t}\n\n\tfor (i = cur_index - start_index + 1; i < pkt_info->desc_count; i++) {\n\t\tcur_index++;\n\t\tdesc_data = XLGMAC_GET_DESC_DATA(ring, cur_index);\n\t\tdma_desc = desc_data->dma_desc;\n\n\t\t \n\t\tdma_desc->desc0 =\n\t\t\tcpu_to_le32(lower_32_bits(desc_data->skb_dma));\n\t\tdma_desc->desc1 =\n\t\t\tcpu_to_le32(upper_32_bits(desc_data->skb_dma));\n\n\t\t \n\t\tdma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc2,\n\t\t\t\t\tTX_NORMAL_DESC2_HL_B1L_POS,\n\t\t\t\t\tTX_NORMAL_DESC2_HL_B1L_LEN,\n\t\t\t\t\tdesc_data->skb_dma_len);\n\n\t\t \n\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\tTX_NORMAL_DESC3_OWN_POS,\n\t\t\t\t\tTX_NORMAL_DESC3_OWN_LEN, 1);\n\n\t\t \n\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\tTX_NORMAL_DESC3_CTXT_POS,\n\t\t\t\t\tTX_NORMAL_DESC3_CTXT_LEN, 0);\n\n\t\t \n\t\tif (csum)\n\t\t\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\t\tdma_desc->desc3,\n\t\t\t\t\t\tTX_NORMAL_DESC3_CIC_POS,\n\t\t\t\t\t\tTX_NORMAL_DESC3_CIC_LEN,\n\t\t\t\t\t\t0x3);\n\t}\n\n\t \n\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\tdma_desc->desc3,\n\t\t\t\tTX_NORMAL_DESC3_LD_POS,\n\t\t\t\tTX_NORMAL_DESC3_LD_LEN, 1);\n\n\t \n\tif (tx_set_ic)\n\t\tdma_desc->desc2 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\t\tdma_desc->desc2,\n\t\t\t\t\tTX_NORMAL_DESC2_IC_POS,\n\t\t\t\t\tTX_NORMAL_DESC2_IC_LEN, 1);\n\n\t \n\tdesc_data->tx.packets = pkt_info->tx_packets;\n\tdesc_data->tx.bytes = pkt_info->tx_bytes;\n\n\t \n\tdma_wmb();\n\n\t \n\tdesc_data = XLGMAC_GET_DESC_DATA(ring, start_index);\n\tdma_desc = desc_data->dma_desc;\n\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\tdma_desc->desc3,\n\t\t\t\tTX_NORMAL_DESC3_OWN_POS,\n\t\t\t\tTX_NORMAL_DESC3_OWN_LEN, 1);\n\n\tif (netif_msg_tx_queued(pdata))\n\t\txlgmac_dump_tx_desc(pdata, ring, start_index,\n\t\t\t\t    pkt_info->desc_count, 1);\n\n\t \n\tsmp_wmb();\n\n\tring->cur = cur_index + 1;\n\tif (!netdev_xmit_more() ||\n\t    netif_xmit_stopped(netdev_get_tx_queue(pdata->netdev,\n\t\t\t\t\t\t   channel->queue_index)))\n\t\txlgmac_tx_start_xmit(channel, ring);\n\telse\n\t\tring->tx.xmit_more = 1;\n\n\tXLGMAC_PR(\"%s: descriptors %u to %u written\\n\",\n\t\t  channel->name, start_index & (ring->dma_desc_count - 1),\n\t\t  (ring->cur - 1) & (ring->dma_desc_count - 1));\n}\n\nstatic void xlgmac_get_rx_tstamp(struct xlgmac_pkt_info *pkt_info,\n\t\t\t\t struct xlgmac_dma_desc *dma_desc)\n{\n\tu32 tsa, tsd;\n\tu64 nsec;\n\n\ttsa = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t     RX_CONTEXT_DESC3_TSA_POS,\n\t\t\t\tRX_CONTEXT_DESC3_TSA_LEN);\n\ttsd = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t     RX_CONTEXT_DESC3_TSD_POS,\n\t\t\t\tRX_CONTEXT_DESC3_TSD_LEN);\n\tif (tsa && !tsd) {\n\t\tnsec = le32_to_cpu(dma_desc->desc1);\n\t\tnsec <<= 32;\n\t\tnsec |= le32_to_cpu(dma_desc->desc0);\n\t\tif (nsec != 0xffffffffffffffffULL) {\n\t\t\tpkt_info->rx_tstamp = nsec;\n\t\t\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\t\t\tpkt_info->attributes,\n\t\t\t\t\tRX_PACKET_ATTRIBUTES_RX_TSTAMP_POS,\n\t\t\t\t\tRX_PACKET_ATTRIBUTES_RX_TSTAMP_LEN,\n\t\t\t\t\t1);\n\t\t}\n\t}\n}\n\nstatic void xlgmac_tx_desc_reset(struct xlgmac_desc_data *desc_data)\n{\n\tstruct xlgmac_dma_desc *dma_desc = desc_data->dma_desc;\n\n\t \n\tdma_desc->desc0 = 0;\n\tdma_desc->desc1 = 0;\n\tdma_desc->desc2 = 0;\n\tdma_desc->desc3 = 0;\n\n\t \n\tdma_wmb();\n}\n\nstatic void xlgmac_tx_desc_init(struct xlgmac_channel *channel)\n{\n\tstruct xlgmac_ring *ring = channel->tx_ring;\n\tstruct xlgmac_desc_data *desc_data;\n\tint start_index = ring->cur;\n\tint i;\n\n\t \n\tfor (i = 0; i < ring->dma_desc_count; i++) {\n\t\tdesc_data = XLGMAC_GET_DESC_DATA(ring, i);\n\n\t\t \n\t\txlgmac_tx_desc_reset(desc_data);\n\t}\n\n\t \n\twritel(ring->dma_desc_count - 1, XLGMAC_DMA_REG(channel, DMA_CH_TDRLR));\n\n\t \n\tdesc_data = XLGMAC_GET_DESC_DATA(ring, start_index);\n\twritel(upper_32_bits(desc_data->dma_desc_addr),\n\t       XLGMAC_DMA_REG(channel, DMA_CH_TDLR_HI));\n\twritel(lower_32_bits(desc_data->dma_desc_addr),\n\t       XLGMAC_DMA_REG(channel, DMA_CH_TDLR_LO));\n}\n\nstatic void xlgmac_rx_desc_reset(struct xlgmac_pdata *pdata,\n\t\t\t\t struct xlgmac_desc_data *desc_data,\n\t\t\t\t unsigned int index)\n{\n\tstruct xlgmac_dma_desc *dma_desc = desc_data->dma_desc;\n\tunsigned int rx_frames = pdata->rx_frames;\n\tunsigned int rx_usecs = pdata->rx_usecs;\n\tdma_addr_t hdr_dma, buf_dma;\n\tunsigned int inte;\n\n\tif (!rx_usecs && !rx_frames) {\n\t\t \n\t\tinte = 1;\n\t} else {\n\t\t \n\t\tif (rx_frames && !((index + 1) % rx_frames))\n\t\t\tinte = 1;\n\t\telse\n\t\t\tinte = 0;\n\t}\n\n\t \n\thdr_dma = desc_data->rx.hdr.dma_base + desc_data->rx.hdr.dma_off;\n\tbuf_dma = desc_data->rx.buf.dma_base + desc_data->rx.buf.dma_off;\n\tdma_desc->desc0 = cpu_to_le32(lower_32_bits(hdr_dma));\n\tdma_desc->desc1 = cpu_to_le32(upper_32_bits(hdr_dma));\n\tdma_desc->desc2 = cpu_to_le32(lower_32_bits(buf_dma));\n\tdma_desc->desc3 = cpu_to_le32(upper_32_bits(buf_dma));\n\n\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\tdma_desc->desc3,\n\t\t\t\tRX_NORMAL_DESC3_INTE_POS,\n\t\t\t\tRX_NORMAL_DESC3_INTE_LEN,\n\t\t\t\tinte);\n\n\t \n\tdma_wmb();\n\n\tdma_desc->desc3 = XLGMAC_SET_REG_BITS_LE(\n\t\t\t\tdma_desc->desc3,\n\t\t\t\tRX_NORMAL_DESC3_OWN_POS,\n\t\t\t\tRX_NORMAL_DESC3_OWN_LEN,\n\t\t\t\t1);\n\n\t \n\tdma_wmb();\n}\n\nstatic void xlgmac_rx_desc_init(struct xlgmac_channel *channel)\n{\n\tstruct xlgmac_pdata *pdata = channel->pdata;\n\tstruct xlgmac_ring *ring = channel->rx_ring;\n\tunsigned int start_index = ring->cur;\n\tstruct xlgmac_desc_data *desc_data;\n\tunsigned int i;\n\n\t \n\tfor (i = 0; i < ring->dma_desc_count; i++) {\n\t\tdesc_data = XLGMAC_GET_DESC_DATA(ring, i);\n\n\t\t \n\t\txlgmac_rx_desc_reset(pdata, desc_data, i);\n\t}\n\n\t \n\twritel(ring->dma_desc_count - 1, XLGMAC_DMA_REG(channel, DMA_CH_RDRLR));\n\n\t \n\tdesc_data = XLGMAC_GET_DESC_DATA(ring, start_index);\n\twritel(upper_32_bits(desc_data->dma_desc_addr),\n\t       XLGMAC_DMA_REG(channel, DMA_CH_RDLR_HI));\n\twritel(lower_32_bits(desc_data->dma_desc_addr),\n\t       XLGMAC_DMA_REG(channel, DMA_CH_RDLR_LO));\n\n\t \n\tdesc_data = XLGMAC_GET_DESC_DATA(ring, start_index +\n\t\t\t\t\t  ring->dma_desc_count - 1);\n\twritel(lower_32_bits(desc_data->dma_desc_addr),\n\t       XLGMAC_DMA_REG(channel, DMA_CH_RDTR_LO));\n}\n\nstatic int xlgmac_is_context_desc(struct xlgmac_dma_desc *dma_desc)\n{\n\t \n\treturn XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\tTX_NORMAL_DESC3_CTXT_POS,\n\t\t\t\tTX_NORMAL_DESC3_CTXT_LEN);\n}\n\nstatic int xlgmac_is_last_desc(struct xlgmac_dma_desc *dma_desc)\n{\n\t \n\treturn XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\tTX_NORMAL_DESC3_LD_POS,\n\t\t\t\tTX_NORMAL_DESC3_LD_LEN);\n}\n\nstatic int xlgmac_disable_tx_flow_control(struct xlgmac_pdata *pdata)\n{\n\tunsigned int max_q_count, q_count;\n\tunsigned int reg, regval;\n\tunsigned int i;\n\n\t \n\tfor (i = 0; i < pdata->rx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_EHFC_POS,\n\t\t\t\t\t     MTL_Q_RQOMR_EHFC_LEN, 0);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t}\n\n\t \n\tmax_q_count = XLGMAC_MAX_FLOW_CONTROL_QUEUES;\n\tq_count = min_t(unsigned int, pdata->tx_q_count, max_q_count);\n\treg = MAC_Q0TFCR;\n\tfor (i = 0; i < q_count; i++) {\n\t\tregval = readl(pdata->mac_regs + reg);\n\t\tregval = XLGMAC_SET_REG_BITS(regval,\n\t\t\t\t\t     MAC_Q0TFCR_TFE_POS,\n\t\t\t\t\tMAC_Q0TFCR_TFE_LEN,\n\t\t\t\t\t0);\n\t\twritel(regval, pdata->mac_regs + reg);\n\n\t\treg += MAC_QTFCR_INC;\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_enable_tx_flow_control(struct xlgmac_pdata *pdata)\n{\n\tunsigned int max_q_count, q_count;\n\tunsigned int reg, regval;\n\tunsigned int i;\n\n\t \n\tfor (i = 0; i < pdata->rx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_EHFC_POS,\n\t\t\t\t\t     MTL_Q_RQOMR_EHFC_LEN, 1);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t}\n\n\t \n\tmax_q_count = XLGMAC_MAX_FLOW_CONTROL_QUEUES;\n\tq_count = min_t(unsigned int, pdata->tx_q_count, max_q_count);\n\treg = MAC_Q0TFCR;\n\tfor (i = 0; i < q_count; i++) {\n\t\tregval = readl(pdata->mac_regs + reg);\n\n\t\t \n\t\tregval = XLGMAC_SET_REG_BITS(regval, MAC_Q0TFCR_TFE_POS,\n\t\t\t\t\t     MAC_Q0TFCR_TFE_LEN, 1);\n\t\t \n\t\tregval = XLGMAC_SET_REG_BITS(regval, MAC_Q0TFCR_PT_POS,\n\t\t\t\t\t     MAC_Q0TFCR_PT_LEN, 0xffff);\n\n\t\twritel(regval, pdata->mac_regs + reg);\n\n\t\treg += MAC_QTFCR_INC;\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_disable_rx_flow_control(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + MAC_RFCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RFCR_RFE_POS,\n\t\t\t\t     MAC_RFCR_RFE_LEN, 0);\n\twritel(regval, pdata->mac_regs + MAC_RFCR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_enable_rx_flow_control(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + MAC_RFCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RFCR_RFE_POS,\n\t\t\t\t     MAC_RFCR_RFE_LEN, 1);\n\twritel(regval, pdata->mac_regs + MAC_RFCR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_config_tx_flow_control(struct xlgmac_pdata *pdata)\n{\n\tif (pdata->tx_pause)\n\t\txlgmac_enable_tx_flow_control(pdata);\n\telse\n\t\txlgmac_disable_tx_flow_control(pdata);\n\n\treturn 0;\n}\n\nstatic int xlgmac_config_rx_flow_control(struct xlgmac_pdata *pdata)\n{\n\tif (pdata->rx_pause)\n\t\txlgmac_enable_rx_flow_control(pdata);\n\telse\n\t\txlgmac_disable_rx_flow_control(pdata);\n\n\treturn 0;\n}\n\nstatic int xlgmac_config_rx_coalesce(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->rx_ring)\n\t\t\tbreak;\n\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_RIWT));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_RIWT_RWT_POS,\n\t\t\t\t\t     DMA_CH_RIWT_RWT_LEN,\n\t\t\t\t\t     pdata->rx_riwt);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_RIWT));\n\t}\n\n\treturn 0;\n}\n\nstatic void xlgmac_config_flow_control(struct xlgmac_pdata *pdata)\n{\n\txlgmac_config_tx_flow_control(pdata);\n\txlgmac_config_rx_flow_control(pdata);\n}\n\nstatic void xlgmac_config_rx_fep_enable(struct xlgmac_pdata *pdata)\n{\n\tunsigned int i;\n\tu32 regval;\n\n\tfor (i = 0; i < pdata->rx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_FEP_POS,\n\t\t\t\t\t     MTL_Q_RQOMR_FEP_LEN, 1);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t}\n}\n\nstatic void xlgmac_config_rx_fup_enable(struct xlgmac_pdata *pdata)\n{\n\tunsigned int i;\n\tu32 regval;\n\n\tfor (i = 0; i < pdata->rx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_FUP_POS,\n\t\t\t\t\t     MTL_Q_RQOMR_FUP_LEN, 1);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t}\n}\n\nstatic int xlgmac_config_tx_coalesce(struct xlgmac_pdata *pdata)\n{\n\treturn 0;\n}\n\nstatic void xlgmac_config_rx_buffer_size(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->rx_ring)\n\t\t\tbreak;\n\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_RCR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_RCR_RBSZ_POS,\n\t\t\t\t\t     DMA_CH_RCR_RBSZ_LEN,\n\t\t\t\t\tpdata->rx_buf_size);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_RCR));\n\t}\n}\n\nstatic void xlgmac_config_tso_mode(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->tx_ring)\n\t\t\tbreak;\n\n\t\tif (pdata->hw_feat.tso) {\n\t\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_TCR));\n\t\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_TCR_TSE_POS,\n\t\t\t\t\t\t     DMA_CH_TCR_TSE_LEN, 1);\n\t\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_TCR));\n\t\t}\n\t}\n}\n\nstatic void xlgmac_config_sph_mode(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->rx_ring)\n\t\t\tbreak;\n\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_CR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_CR_SPH_POS,\n\t\t\t\t\t     DMA_CH_CR_SPH_LEN, 1);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_CR));\n\t}\n\n\tregval = readl(pdata->mac_regs + MAC_RCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RCR_HDSMS_POS,\n\t\t\t\t     MAC_RCR_HDSMS_LEN,\n\t\t\t\tXLGMAC_SPH_HDSMS_SIZE);\n\twritel(regval, pdata->mac_regs + MAC_RCR);\n}\n\nstatic unsigned int xlgmac_usec_to_riwt(struct xlgmac_pdata *pdata,\n\t\t\t\t\tunsigned int usec)\n{\n\tunsigned long rate;\n\tunsigned int ret;\n\n\trate = pdata->sysclk_rate;\n\n\t \n\tret = (usec * (rate / 1000000)) / 256;\n\n\treturn ret;\n}\n\nstatic unsigned int xlgmac_riwt_to_usec(struct xlgmac_pdata *pdata,\n\t\t\t\t\tunsigned int riwt)\n{\n\tunsigned long rate;\n\tunsigned int ret;\n\n\trate = pdata->sysclk_rate;\n\n\t \n\tret = (riwt * 256) / (rate / 1000000);\n\n\treturn ret;\n}\n\nstatic int xlgmac_config_rx_threshold(struct xlgmac_pdata *pdata,\n\t\t\t\t      unsigned int val)\n{\n\tunsigned int i;\n\tu32 regval;\n\n\tfor (i = 0; i < pdata->rx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_RTC_POS,\n\t\t\t\t\t     MTL_Q_RQOMR_RTC_LEN, val);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t}\n\n\treturn 0;\n}\n\nstatic void xlgmac_config_mtl_mode(struct xlgmac_pdata *pdata)\n{\n\tunsigned int i;\n\tu32 regval;\n\n\t \n\tregval = readl(pdata->mac_regs + MTL_OMR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MTL_OMR_ETSALG_POS,\n\t\t\t\t     MTL_OMR_ETSALG_LEN, MTL_ETSALG_WRR);\n\twritel(regval, pdata->mac_regs + MTL_OMR);\n\n\t \n\tfor (i = 0; i < pdata->hw_feat.tc_cnt; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_TC_ETSCR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_TC_ETSCR_TSA_POS,\n\t\t\t\t\t     MTL_TC_ETSCR_TSA_LEN, MTL_TSA_ETS);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_TC_ETSCR));\n\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_TC_QWR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_TC_QWR_QW_POS,\n\t\t\t\t\t     MTL_TC_QWR_QW_LEN, 1);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_TC_QWR));\n\t}\n\n\t \n\tregval = readl(pdata->mac_regs + MTL_OMR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MTL_OMR_RAA_POS,\n\t\t\t\t     MTL_OMR_RAA_LEN, MTL_RAA_SP);\n\twritel(regval, pdata->mac_regs + MTL_OMR);\n}\n\nstatic void xlgmac_config_queue_mapping(struct xlgmac_pdata *pdata)\n{\n\tunsigned int ppq, ppq_extra, prio, prio_queues;\n\tunsigned int qptc, qptc_extra, queue;\n\tunsigned int reg, regval;\n\tunsigned int mask;\n\tunsigned int i, j;\n\n\t \n\tqptc = pdata->tx_q_count / pdata->hw_feat.tc_cnt;\n\tqptc_extra = pdata->tx_q_count % pdata->hw_feat.tc_cnt;\n\n\tfor (i = 0, queue = 0; i < pdata->hw_feat.tc_cnt; i++) {\n\t\tfor (j = 0; j < qptc; j++) {\n\t\t\tnetif_dbg(pdata, drv, pdata->netdev,\n\t\t\t\t  \"TXq%u mapped to TC%u\\n\", queue, i);\n\t\t\tregval = readl(XLGMAC_MTL_REG(pdata, queue,\n\t\t\t\t\t\t      MTL_Q_TQOMR));\n\t\t\tregval = XLGMAC_SET_REG_BITS(regval,\n\t\t\t\t\t\t     MTL_Q_TQOMR_Q2TCMAP_POS,\n\t\t\t\t\t\t     MTL_Q_TQOMR_Q2TCMAP_LEN,\n\t\t\t\t\t\t     i);\n\t\t\twritel(regval, XLGMAC_MTL_REG(pdata, queue,\n\t\t\t\t\t\t      MTL_Q_TQOMR));\n\t\t\tqueue++;\n\t\t}\n\n\t\tif (i < qptc_extra) {\n\t\t\tnetif_dbg(pdata, drv, pdata->netdev,\n\t\t\t\t  \"TXq%u mapped to TC%u\\n\", queue, i);\n\t\t\tregval = readl(XLGMAC_MTL_REG(pdata, queue,\n\t\t\t\t\t\t      MTL_Q_TQOMR));\n\t\t\tregval = XLGMAC_SET_REG_BITS(regval,\n\t\t\t\t\t\t     MTL_Q_TQOMR_Q2TCMAP_POS,\n\t\t\t\t\t\t     MTL_Q_TQOMR_Q2TCMAP_LEN,\n\t\t\t\t\t\t     i);\n\t\t\twritel(regval, XLGMAC_MTL_REG(pdata, queue,\n\t\t\t\t\t\t      MTL_Q_TQOMR));\n\t\t\tqueue++;\n\t\t}\n\t}\n\n\t \n\tprio_queues = min_t(unsigned int, IEEE_8021QAZ_MAX_TCS,\n\t\t\t    pdata->rx_q_count);\n\tppq = IEEE_8021QAZ_MAX_TCS / prio_queues;\n\tppq_extra = IEEE_8021QAZ_MAX_TCS % prio_queues;\n\n\treg = MAC_RQC2R;\n\tregval = 0;\n\tfor (i = 0, prio = 0; i < prio_queues;) {\n\t\tmask = 0;\n\t\tfor (j = 0; j < ppq; j++) {\n\t\t\tnetif_dbg(pdata, drv, pdata->netdev,\n\t\t\t\t  \"PRIO%u mapped to RXq%u\\n\", prio, i);\n\t\t\tmask |= (1 << prio);\n\t\t\tprio++;\n\t\t}\n\n\t\tif (i < ppq_extra) {\n\t\t\tnetif_dbg(pdata, drv, pdata->netdev,\n\t\t\t\t  \"PRIO%u mapped to RXq%u\\n\", prio, i);\n\t\t\tmask |= (1 << prio);\n\t\t\tprio++;\n\t\t}\n\n\t\tregval |= (mask << ((i++ % MAC_RQC2_Q_PER_REG) << 3));\n\n\t\tif ((i % MAC_RQC2_Q_PER_REG) && (i != prio_queues))\n\t\t\tcontinue;\n\n\t\twritel(regval, pdata->mac_regs + reg);\n\t\treg += MAC_RQC2_INC;\n\t\tregval = 0;\n\t}\n\n\t \n\treg = MTL_RQDCM0R;\n\tregval = readl(pdata->mac_regs + reg);\n\tregval |= (MTL_RQDCM0R_Q0MDMACH | MTL_RQDCM0R_Q1MDMACH |\n\t\t    MTL_RQDCM0R_Q2MDMACH | MTL_RQDCM0R_Q3MDMACH);\n\twritel(regval, pdata->mac_regs + reg);\n\n\treg += MTL_RQDCM_INC;\n\tregval = readl(pdata->mac_regs + reg);\n\tregval |= (MTL_RQDCM1R_Q4MDMACH | MTL_RQDCM1R_Q5MDMACH |\n\t\t    MTL_RQDCM1R_Q6MDMACH | MTL_RQDCM1R_Q7MDMACH);\n\twritel(regval, pdata->mac_regs + reg);\n\n\treg += MTL_RQDCM_INC;\n\tregval = readl(pdata->mac_regs + reg);\n\tregval |= (MTL_RQDCM2R_Q8MDMACH | MTL_RQDCM2R_Q9MDMACH |\n\t\t    MTL_RQDCM2R_Q10MDMACH | MTL_RQDCM2R_Q11MDMACH);\n\twritel(regval, pdata->mac_regs + reg);\n}\n\nstatic unsigned int xlgmac_calculate_per_queue_fifo(\n\t\t\t\t\tunsigned int fifo_size,\n\t\t\t\t\tunsigned int queue_count)\n{\n\tunsigned int q_fifo_size;\n\tunsigned int p_fifo;\n\n\t \n\tq_fifo_size = 1 << (fifo_size + 7);\n\n\t \n\tq_fifo_size = min_t(unsigned int, XLGMAC_MAX_FIFO, q_fifo_size);\n\n\tq_fifo_size = q_fifo_size / queue_count;\n\n\t \n\tp_fifo = q_fifo_size / 256;\n\tif (p_fifo)\n\t\tp_fifo--;\n\n\treturn p_fifo;\n}\n\nstatic void xlgmac_config_tx_fifo_size(struct xlgmac_pdata *pdata)\n{\n\tunsigned int fifo_size;\n\tunsigned int i;\n\tu32 regval;\n\n\tfifo_size = xlgmac_calculate_per_queue_fifo(\n\t\t\t\tpdata->hw_feat.tx_fifo_size,\n\t\t\t\tpdata->tx_q_count);\n\n\tfor (i = 0; i < pdata->tx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_TQS_POS,\n\t\t\t\t\t     MTL_Q_TQOMR_TQS_LEN, fifo_size);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t}\n\n\tnetif_info(pdata, drv, pdata->netdev,\n\t\t   \"%d Tx hardware queues, %d byte fifo per queue\\n\",\n\t\t   pdata->tx_q_count, ((fifo_size + 1) * 256));\n}\n\nstatic void xlgmac_config_rx_fifo_size(struct xlgmac_pdata *pdata)\n{\n\tunsigned int fifo_size;\n\tunsigned int i;\n\tu32 regval;\n\n\tfifo_size = xlgmac_calculate_per_queue_fifo(\n\t\t\t\t\tpdata->hw_feat.rx_fifo_size,\n\t\t\t\t\tpdata->rx_q_count);\n\n\tfor (i = 0; i < pdata->rx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_RQS_POS,\n\t\t\t\t\t     MTL_Q_RQOMR_RQS_LEN, fifo_size);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t}\n\n\tnetif_info(pdata, drv, pdata->netdev,\n\t\t   \"%d Rx hardware queues, %d byte fifo per queue\\n\",\n\t\t   pdata->rx_q_count, ((fifo_size + 1) * 256));\n}\n\nstatic void xlgmac_config_flow_control_threshold(struct xlgmac_pdata *pdata)\n{\n\tunsigned int i;\n\tu32 regval;\n\n\tfor (i = 0; i < pdata->rx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQFCR));\n\t\t \n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQFCR_RFA_POS,\n\t\t\t\t\t     MTL_Q_RQFCR_RFA_LEN, 2);\n\t\t \n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQFCR_RFD_POS,\n\t\t\t\t\t     MTL_Q_RQFCR_RFD_LEN, 4);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQFCR));\n\t}\n}\n\nstatic int xlgmac_config_tx_threshold(struct xlgmac_pdata *pdata,\n\t\t\t\t      unsigned int val)\n{\n\tunsigned int i;\n\tu32 regval;\n\n\tfor (i = 0; i < pdata->tx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_TTC_POS,\n\t\t\t\t\t     MTL_Q_TQOMR_TTC_LEN, val);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_config_rsf_mode(struct xlgmac_pdata *pdata,\n\t\t\t\t  unsigned int val)\n{\n\tunsigned int i;\n\tu32 regval;\n\n\tfor (i = 0; i < pdata->rx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_RQOMR_RSF_POS,\n\t\t\t\t\t     MTL_Q_RQOMR_RSF_LEN, val);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_RQOMR));\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_config_tsf_mode(struct xlgmac_pdata *pdata,\n\t\t\t\t  unsigned int val)\n{\n\tunsigned int i;\n\tu32 regval;\n\n\tfor (i = 0; i < pdata->tx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_TSF_POS,\n\t\t\t\t\t     MTL_Q_TQOMR_TSF_LEN, val);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_config_osp_mode(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->tx_ring)\n\t\t\tbreak;\n\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_TCR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_TCR_OSP_POS,\n\t\t\t\t\t     DMA_CH_TCR_OSP_LEN,\n\t\t\t\t\tpdata->tx_osp_mode);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_TCR));\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_config_pblx8(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_CR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_CR_PBLX8_POS,\n\t\t\t\t\t     DMA_CH_CR_PBLX8_LEN,\n\t\t\t\t\tpdata->pblx8);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_CR));\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_get_tx_pbl_val(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(XLGMAC_DMA_REG(pdata->channel_head, DMA_CH_TCR));\n\tregval = XLGMAC_GET_REG_BITS(regval, DMA_CH_TCR_PBL_POS,\n\t\t\t\t     DMA_CH_TCR_PBL_LEN);\n\treturn regval;\n}\n\nstatic int xlgmac_config_tx_pbl_val(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->tx_ring)\n\t\t\tbreak;\n\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_TCR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_TCR_PBL_POS,\n\t\t\t\t\t     DMA_CH_TCR_PBL_LEN,\n\t\t\t\t\tpdata->tx_pbl);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_TCR));\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_get_rx_pbl_val(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(XLGMAC_DMA_REG(pdata->channel_head, DMA_CH_RCR));\n\tregval = XLGMAC_GET_REG_BITS(regval, DMA_CH_RCR_PBL_POS,\n\t\t\t\t     DMA_CH_RCR_PBL_LEN);\n\treturn regval;\n}\n\nstatic int xlgmac_config_rx_pbl_val(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\tu32 regval;\n\n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\tif (!channel->rx_ring)\n\t\t\tbreak;\n\n\t\tregval = readl(XLGMAC_DMA_REG(channel, DMA_CH_RCR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, DMA_CH_RCR_PBL_POS,\n\t\t\t\t\t     DMA_CH_RCR_PBL_LEN,\n\t\t\t\t\tpdata->rx_pbl);\n\t\twritel(regval, XLGMAC_DMA_REG(channel, DMA_CH_RCR));\n\t}\n\n\treturn 0;\n}\n\nstatic u64 xlgmac_mmc_read(struct xlgmac_pdata *pdata, unsigned int reg_lo)\n{\n\tbool read_hi;\n\tu64 val;\n\n\tswitch (reg_lo) {\n\t \n\tcase MMC_TXOCTETCOUNT_GB_LO:\n\tcase MMC_TXOCTETCOUNT_G_LO:\n\tcase MMC_RXOCTETCOUNT_GB_LO:\n\tcase MMC_RXOCTETCOUNT_G_LO:\n\t\tread_hi = true;\n\t\tbreak;\n\n\tdefault:\n\t\tread_hi = false;\n\t}\n\n\tval = (u64)readl(pdata->mac_regs + reg_lo);\n\n\tif (read_hi)\n\t\tval |= ((u64)readl(pdata->mac_regs + reg_lo + 4) << 32);\n\n\treturn val;\n}\n\nstatic void xlgmac_tx_mmc_int(struct xlgmac_pdata *pdata)\n{\n\tunsigned int mmc_isr = readl(pdata->mac_regs + MMC_TISR);\n\tstruct xlgmac_stats *stats = &pdata->stats;\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXOCTETCOUNT_GB_POS,\n\t\t\t\tMMC_TISR_TXOCTETCOUNT_GB_LEN))\n\t\tstats->txoctetcount_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXOCTETCOUNT_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXFRAMECOUNT_GB_POS,\n\t\t\t\tMMC_TISR_TXFRAMECOUNT_GB_LEN))\n\t\tstats->txframecount_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXFRAMECOUNT_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXBROADCASTFRAMES_G_POS,\n\t\t\t\tMMC_TISR_TXBROADCASTFRAMES_G_LEN))\n\t\tstats->txbroadcastframes_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXBROADCASTFRAMES_G_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXMULTICASTFRAMES_G_POS,\n\t\t\t\tMMC_TISR_TXMULTICASTFRAMES_G_LEN))\n\t\tstats->txmulticastframes_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXMULTICASTFRAMES_G_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TX64OCTETS_GB_POS,\n\t\t\t\tMMC_TISR_TX64OCTETS_GB_LEN))\n\t\tstats->tx64octets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TX64OCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TX65TO127OCTETS_GB_POS,\n\t\t\t\tMMC_TISR_TX65TO127OCTETS_GB_LEN))\n\t\tstats->tx65to127octets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TX65TO127OCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TX128TO255OCTETS_GB_POS,\n\t\t\t\tMMC_TISR_TX128TO255OCTETS_GB_LEN))\n\t\tstats->tx128to255octets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TX128TO255OCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TX256TO511OCTETS_GB_POS,\n\t\t\t\tMMC_TISR_TX256TO511OCTETS_GB_LEN))\n\t\tstats->tx256to511octets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TX256TO511OCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TX512TO1023OCTETS_GB_POS,\n\t\t\t\tMMC_TISR_TX512TO1023OCTETS_GB_LEN))\n\t\tstats->tx512to1023octets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TX512TO1023OCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TX1024TOMAXOCTETS_GB_POS,\n\t\t\t\tMMC_TISR_TX1024TOMAXOCTETS_GB_LEN))\n\t\tstats->tx1024tomaxoctets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TX1024TOMAXOCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXUNICASTFRAMES_GB_POS,\n\t\t\t\tMMC_TISR_TXUNICASTFRAMES_GB_LEN))\n\t\tstats->txunicastframes_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXUNICASTFRAMES_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXMULTICASTFRAMES_GB_POS,\n\t\t\t\tMMC_TISR_TXMULTICASTFRAMES_GB_LEN))\n\t\tstats->txmulticastframes_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXMULTICASTFRAMES_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXBROADCASTFRAMES_GB_POS,\n\t\t\t\tMMC_TISR_TXBROADCASTFRAMES_GB_LEN))\n\t\tstats->txbroadcastframes_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXBROADCASTFRAMES_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXUNDERFLOWERROR_POS,\n\t\t\t\tMMC_TISR_TXUNDERFLOWERROR_LEN))\n\t\tstats->txunderflowerror +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXUNDERFLOWERROR_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXOCTETCOUNT_G_POS,\n\t\t\t\tMMC_TISR_TXOCTETCOUNT_G_LEN))\n\t\tstats->txoctetcount_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXOCTETCOUNT_G_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXFRAMECOUNT_G_POS,\n\t\t\t\tMMC_TISR_TXFRAMECOUNT_G_LEN))\n\t\tstats->txframecount_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXFRAMECOUNT_G_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXPAUSEFRAMES_POS,\n\t\t\t\tMMC_TISR_TXPAUSEFRAMES_LEN))\n\t\tstats->txpauseframes +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXPAUSEFRAMES_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_TISR_TXVLANFRAMES_G_POS,\n\t\t\t\tMMC_TISR_TXVLANFRAMES_G_LEN))\n\t\tstats->txvlanframes_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_TXVLANFRAMES_G_LO);\n}\n\nstatic void xlgmac_rx_mmc_int(struct xlgmac_pdata *pdata)\n{\n\tunsigned int mmc_isr = readl(pdata->mac_regs + MMC_RISR);\n\tstruct xlgmac_stats *stats = &pdata->stats;\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXFRAMECOUNT_GB_POS,\n\t\t\t\tMMC_RISR_RXFRAMECOUNT_GB_LEN))\n\t\tstats->rxframecount_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXFRAMECOUNT_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXOCTETCOUNT_GB_POS,\n\t\t\t\tMMC_RISR_RXOCTETCOUNT_GB_LEN))\n\t\tstats->rxoctetcount_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXOCTETCOUNT_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXOCTETCOUNT_G_POS,\n\t\t\t\tMMC_RISR_RXOCTETCOUNT_G_LEN))\n\t\tstats->rxoctetcount_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXOCTETCOUNT_G_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXBROADCASTFRAMES_G_POS,\n\t\t\t\tMMC_RISR_RXBROADCASTFRAMES_G_LEN))\n\t\tstats->rxbroadcastframes_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXBROADCASTFRAMES_G_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXMULTICASTFRAMES_G_POS,\n\t\t\t\tMMC_RISR_RXMULTICASTFRAMES_G_LEN))\n\t\tstats->rxmulticastframes_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXMULTICASTFRAMES_G_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXCRCERROR_POS,\n\t\t\t\tMMC_RISR_RXCRCERROR_LEN))\n\t\tstats->rxcrcerror +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXCRCERROR_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXRUNTERROR_POS,\n\t\t\t\tMMC_RISR_RXRUNTERROR_LEN))\n\t\tstats->rxrunterror +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXRUNTERROR);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXJABBERERROR_POS,\n\t\t\t\tMMC_RISR_RXJABBERERROR_LEN))\n\t\tstats->rxjabbererror +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXJABBERERROR);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXUNDERSIZE_G_POS,\n\t\t\t\tMMC_RISR_RXUNDERSIZE_G_LEN))\n\t\tstats->rxundersize_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXUNDERSIZE_G);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXOVERSIZE_G_POS,\n\t\t\t\tMMC_RISR_RXOVERSIZE_G_LEN))\n\t\tstats->rxoversize_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXOVERSIZE_G);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RX64OCTETS_GB_POS,\n\t\t\t\tMMC_RISR_RX64OCTETS_GB_LEN))\n\t\tstats->rx64octets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RX64OCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RX65TO127OCTETS_GB_POS,\n\t\t\t\tMMC_RISR_RX65TO127OCTETS_GB_LEN))\n\t\tstats->rx65to127octets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RX65TO127OCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RX128TO255OCTETS_GB_POS,\n\t\t\t\tMMC_RISR_RX128TO255OCTETS_GB_LEN))\n\t\tstats->rx128to255octets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RX128TO255OCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RX256TO511OCTETS_GB_POS,\n\t\t\t\tMMC_RISR_RX256TO511OCTETS_GB_LEN))\n\t\tstats->rx256to511octets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RX256TO511OCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RX512TO1023OCTETS_GB_POS,\n\t\t\t\tMMC_RISR_RX512TO1023OCTETS_GB_LEN))\n\t\tstats->rx512to1023octets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RX512TO1023OCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RX1024TOMAXOCTETS_GB_POS,\n\t\t\t\tMMC_RISR_RX1024TOMAXOCTETS_GB_LEN))\n\t\tstats->rx1024tomaxoctets_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RX1024TOMAXOCTETS_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXUNICASTFRAMES_G_POS,\n\t\t\t\tMMC_RISR_RXUNICASTFRAMES_G_LEN))\n\t\tstats->rxunicastframes_g +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXUNICASTFRAMES_G_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXLENGTHERROR_POS,\n\t\t\t\tMMC_RISR_RXLENGTHERROR_LEN))\n\t\tstats->rxlengtherror +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXLENGTHERROR_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXOUTOFRANGETYPE_POS,\n\t\t\t\tMMC_RISR_RXOUTOFRANGETYPE_LEN))\n\t\tstats->rxoutofrangetype +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXOUTOFRANGETYPE_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXPAUSEFRAMES_POS,\n\t\t\t\tMMC_RISR_RXPAUSEFRAMES_LEN))\n\t\tstats->rxpauseframes +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXPAUSEFRAMES_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXFIFOOVERFLOW_POS,\n\t\t\t\tMMC_RISR_RXFIFOOVERFLOW_LEN))\n\t\tstats->rxfifooverflow +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXFIFOOVERFLOW_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXVLANFRAMES_GB_POS,\n\t\t\t\tMMC_RISR_RXVLANFRAMES_GB_LEN))\n\t\tstats->rxvlanframes_gb +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXVLANFRAMES_GB_LO);\n\n\tif (XLGMAC_GET_REG_BITS(mmc_isr,\n\t\t\t\tMMC_RISR_RXWATCHDOGERROR_POS,\n\t\t\t\tMMC_RISR_RXWATCHDOGERROR_LEN))\n\t\tstats->rxwatchdogerror +=\n\t\t\txlgmac_mmc_read(pdata, MMC_RXWATCHDOGERROR);\n}\n\nstatic void xlgmac_read_mmc_stats(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_stats *stats = &pdata->stats;\n\tu32 regval;\n\n\t \n\tregval = readl(pdata->mac_regs + MMC_CR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MMC_CR_MCF_POS,\n\t\t\t\t     MMC_CR_MCF_LEN, 1);\n\twritel(regval, pdata->mac_regs + MMC_CR);\n\n\tstats->txoctetcount_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_TXOCTETCOUNT_GB_LO);\n\n\tstats->txframecount_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_TXFRAMECOUNT_GB_LO);\n\n\tstats->txbroadcastframes_g +=\n\t\txlgmac_mmc_read(pdata, MMC_TXBROADCASTFRAMES_G_LO);\n\n\tstats->txmulticastframes_g +=\n\t\txlgmac_mmc_read(pdata, MMC_TXMULTICASTFRAMES_G_LO);\n\n\tstats->tx64octets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_TX64OCTETS_GB_LO);\n\n\tstats->tx65to127octets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_TX65TO127OCTETS_GB_LO);\n\n\tstats->tx128to255octets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_TX128TO255OCTETS_GB_LO);\n\n\tstats->tx256to511octets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_TX256TO511OCTETS_GB_LO);\n\n\tstats->tx512to1023octets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_TX512TO1023OCTETS_GB_LO);\n\n\tstats->tx1024tomaxoctets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_TX1024TOMAXOCTETS_GB_LO);\n\n\tstats->txunicastframes_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_TXUNICASTFRAMES_GB_LO);\n\n\tstats->txmulticastframes_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_TXMULTICASTFRAMES_GB_LO);\n\n\tstats->txbroadcastframes_g +=\n\t\txlgmac_mmc_read(pdata, MMC_TXBROADCASTFRAMES_GB_LO);\n\n\tstats->txunderflowerror +=\n\t\txlgmac_mmc_read(pdata, MMC_TXUNDERFLOWERROR_LO);\n\n\tstats->txoctetcount_g +=\n\t\txlgmac_mmc_read(pdata, MMC_TXOCTETCOUNT_G_LO);\n\n\tstats->txframecount_g +=\n\t\txlgmac_mmc_read(pdata, MMC_TXFRAMECOUNT_G_LO);\n\n\tstats->txpauseframes +=\n\t\txlgmac_mmc_read(pdata, MMC_TXPAUSEFRAMES_LO);\n\n\tstats->txvlanframes_g +=\n\t\txlgmac_mmc_read(pdata, MMC_TXVLANFRAMES_G_LO);\n\n\tstats->rxframecount_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_RXFRAMECOUNT_GB_LO);\n\n\tstats->rxoctetcount_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_RXOCTETCOUNT_GB_LO);\n\n\tstats->rxoctetcount_g +=\n\t\txlgmac_mmc_read(pdata, MMC_RXOCTETCOUNT_G_LO);\n\n\tstats->rxbroadcastframes_g +=\n\t\txlgmac_mmc_read(pdata, MMC_RXBROADCASTFRAMES_G_LO);\n\n\tstats->rxmulticastframes_g +=\n\t\txlgmac_mmc_read(pdata, MMC_RXMULTICASTFRAMES_G_LO);\n\n\tstats->rxcrcerror +=\n\t\txlgmac_mmc_read(pdata, MMC_RXCRCERROR_LO);\n\n\tstats->rxrunterror +=\n\t\txlgmac_mmc_read(pdata, MMC_RXRUNTERROR);\n\n\tstats->rxjabbererror +=\n\t\txlgmac_mmc_read(pdata, MMC_RXJABBERERROR);\n\n\tstats->rxundersize_g +=\n\t\txlgmac_mmc_read(pdata, MMC_RXUNDERSIZE_G);\n\n\tstats->rxoversize_g +=\n\t\txlgmac_mmc_read(pdata, MMC_RXOVERSIZE_G);\n\n\tstats->rx64octets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_RX64OCTETS_GB_LO);\n\n\tstats->rx65to127octets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_RX65TO127OCTETS_GB_LO);\n\n\tstats->rx128to255octets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_RX128TO255OCTETS_GB_LO);\n\n\tstats->rx256to511octets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_RX256TO511OCTETS_GB_LO);\n\n\tstats->rx512to1023octets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_RX512TO1023OCTETS_GB_LO);\n\n\tstats->rx1024tomaxoctets_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_RX1024TOMAXOCTETS_GB_LO);\n\n\tstats->rxunicastframes_g +=\n\t\txlgmac_mmc_read(pdata, MMC_RXUNICASTFRAMES_G_LO);\n\n\tstats->rxlengtherror +=\n\t\txlgmac_mmc_read(pdata, MMC_RXLENGTHERROR_LO);\n\n\tstats->rxoutofrangetype +=\n\t\txlgmac_mmc_read(pdata, MMC_RXOUTOFRANGETYPE_LO);\n\n\tstats->rxpauseframes +=\n\t\txlgmac_mmc_read(pdata, MMC_RXPAUSEFRAMES_LO);\n\n\tstats->rxfifooverflow +=\n\t\txlgmac_mmc_read(pdata, MMC_RXFIFOOVERFLOW_LO);\n\n\tstats->rxvlanframes_gb +=\n\t\txlgmac_mmc_read(pdata, MMC_RXVLANFRAMES_GB_LO);\n\n\tstats->rxwatchdogerror +=\n\t\txlgmac_mmc_read(pdata, MMC_RXWATCHDOGERROR);\n\n\t \n\tregval = readl(pdata->mac_regs + MMC_CR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MMC_CR_MCF_POS,\n\t\t\t\t     MMC_CR_MCF_LEN, 0);\n\twritel(regval, pdata->mac_regs + MMC_CR);\n}\n\nstatic void xlgmac_config_mmc(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + MMC_CR);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MMC_CR_ROR_POS,\n\t\t\t\t     MMC_CR_ROR_LEN, 1);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, MMC_CR_CR_POS,\n\t\t\t\t     MMC_CR_CR_LEN, 1);\n\twritel(regval, pdata->mac_regs + MMC_CR);\n}\n\nstatic int xlgmac_write_rss_reg(struct xlgmac_pdata *pdata, unsigned int type,\n\t\t\t\tunsigned int index, unsigned int val)\n{\n\tunsigned int wait;\n\tint ret = 0;\n\tu32 regval;\n\n\tmutex_lock(&pdata->rss_mutex);\n\n\tregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_RSSAR),\n\t\t\t\t     MAC_RSSAR_OB_POS, MAC_RSSAR_OB_LEN);\n\tif (regval) {\n\t\tret = -EBUSY;\n\t\tgoto unlock;\n\t}\n\n\twritel(val, pdata->mac_regs + MAC_RSSDR);\n\n\tregval = readl(pdata->mac_regs + MAC_RSSAR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSAR_RSSIA_POS,\n\t\t\t\t     MAC_RSSAR_RSSIA_LEN, index);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSAR_ADDRT_POS,\n\t\t\t\t     MAC_RSSAR_ADDRT_LEN, type);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSAR_CT_POS,\n\t\t\t\t     MAC_RSSAR_CT_LEN, 0);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSAR_OB_POS,\n\t\t\t\t     MAC_RSSAR_OB_LEN, 1);\n\twritel(regval, pdata->mac_regs + MAC_RSSAR);\n\n\twait = 1000;\n\twhile (wait--) {\n\t\tregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_RSSAR),\n\t\t\t\t\t     MAC_RSSAR_OB_POS,\n\t\t\t\t\t     MAC_RSSAR_OB_LEN);\n\t\tif (!regval)\n\t\t\tgoto unlock;\n\n\t\tusleep_range(1000, 1500);\n\t}\n\n\tret = -EBUSY;\n\nunlock:\n\tmutex_unlock(&pdata->rss_mutex);\n\n\treturn ret;\n}\n\nstatic int xlgmac_write_rss_hash_key(struct xlgmac_pdata *pdata)\n{\n\tunsigned int key_regs = sizeof(pdata->rss_key) / sizeof(u32);\n\tunsigned int *key = (unsigned int *)&pdata->rss_key;\n\tint ret;\n\n\twhile (key_regs--) {\n\t\tret = xlgmac_write_rss_reg(pdata, XLGMAC_RSS_HASH_KEY_TYPE,\n\t\t\t\t\t   key_regs, *key++);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_write_rss_lookup_table(struct xlgmac_pdata *pdata)\n{\n\tunsigned int i;\n\tint ret;\n\n\tfor (i = 0; i < ARRAY_SIZE(pdata->rss_table); i++) {\n\t\tret = xlgmac_write_rss_reg(pdata,\n\t\t\t\t\t   XLGMAC_RSS_LOOKUP_TABLE_TYPE, i,\n\t\t\t\t\t   pdata->rss_table[i]);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int xlgmac_set_rss_hash_key(struct xlgmac_pdata *pdata, const u8 *key)\n{\n\tmemcpy(pdata->rss_key, key, sizeof(pdata->rss_key));\n\n\treturn xlgmac_write_rss_hash_key(pdata);\n}\n\nstatic int xlgmac_set_rss_lookup_table(struct xlgmac_pdata *pdata,\n\t\t\t\t       const u32 *table)\n{\n\tunsigned int i;\n\tu32 tval;\n\n\tfor (i = 0; i < ARRAY_SIZE(pdata->rss_table); i++) {\n\t\ttval = table[i];\n\t\tpdata->rss_table[i] = XLGMAC_SET_REG_BITS(\n\t\t\t\t\t\tpdata->rss_table[i],\n\t\t\t\t\t\tMAC_RSSDR_DMCH_POS,\n\t\t\t\t\t\tMAC_RSSDR_DMCH_LEN,\n\t\t\t\t\t\ttval);\n\t}\n\n\treturn xlgmac_write_rss_lookup_table(pdata);\n}\n\nstatic int xlgmac_enable_rss(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\tint ret;\n\n\tif (!pdata->hw_feat.rss)\n\t\treturn -EOPNOTSUPP;\n\n\t \n\tret = xlgmac_write_rss_hash_key(pdata);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = xlgmac_write_rss_lookup_table(pdata);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\twritel(pdata->rss_options, pdata->mac_regs + MAC_RSSCR);\n\n\t \n\tregval = readl(pdata->mac_regs + MAC_RSSCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSCR_RSSE_POS,\n\t\t\t\t     MAC_RSSCR_RSSE_LEN, 1);\n\twritel(regval, pdata->mac_regs + MAC_RSSCR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_disable_rss(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tif (!pdata->hw_feat.rss)\n\t\treturn -EOPNOTSUPP;\n\n\tregval = readl(pdata->mac_regs + MAC_RSSCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_RSSCR_RSSE_POS,\n\t\t\t\t     MAC_RSSCR_RSSE_LEN, 0);\n\twritel(regval, pdata->mac_regs + MAC_RSSCR);\n\n\treturn 0;\n}\n\nstatic void xlgmac_config_rss(struct xlgmac_pdata *pdata)\n{\n\tint ret;\n\n\tif (!pdata->hw_feat.rss)\n\t\treturn;\n\n\tif (pdata->netdev->features & NETIF_F_RXHASH)\n\t\tret = xlgmac_enable_rss(pdata);\n\telse\n\t\tret = xlgmac_disable_rss(pdata);\n\n\tif (ret)\n\t\tnetdev_err(pdata->netdev,\n\t\t\t   \"error configuring RSS, RSS disabled\\n\");\n}\n\nstatic void xlgmac_enable_dma_interrupts(struct xlgmac_pdata *pdata)\n{\n\tunsigned int dma_ch_isr, dma_ch_ier;\n\tstruct xlgmac_channel *channel;\n\tunsigned int i;\n\n\tchannel = pdata->channel_head;\n\tfor (i = 0; i < pdata->channel_count; i++, channel++) {\n\t\t \n\t\tdma_ch_isr = readl(XLGMAC_DMA_REG(channel, DMA_CH_SR));\n\t\twritel(dma_ch_isr, XLGMAC_DMA_REG(channel, DMA_CH_SR));\n\n\t\t \n\t\tdma_ch_ier = 0;\n\n\t\t \n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(dma_ch_ier,\n\t\t\t\t\t\t DMA_CH_IER_NIE_POS,\n\t\t\t\t\tDMA_CH_IER_NIE_LEN, 1);\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(dma_ch_ier,\n\t\t\t\t\t\t DMA_CH_IER_AIE_POS,\n\t\t\t\t\tDMA_CH_IER_AIE_LEN, 1);\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(dma_ch_ier,\n\t\t\t\t\t\t DMA_CH_IER_FBEE_POS,\n\t\t\t\t\tDMA_CH_IER_FBEE_LEN, 1);\n\n\t\tif (channel->tx_ring) {\n\t\t\t \n\t\t\tif (!pdata->per_channel_irq)\n\t\t\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\t\t\tdma_ch_ier,\n\t\t\t\t\t\tDMA_CH_IER_TIE_POS,\n\t\t\t\t\t\tDMA_CH_IER_TIE_LEN,\n\t\t\t\t\t\t1);\n\t\t}\n\t\tif (channel->rx_ring) {\n\t\t\t \n\t\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\t\tdma_ch_ier,\n\t\t\t\t\tDMA_CH_IER_RBUE_POS,\n\t\t\t\t\tDMA_CH_IER_RBUE_LEN,\n\t\t\t\t\t1);\n\t\t\tif (!pdata->per_channel_irq)\n\t\t\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\t\t\tdma_ch_ier,\n\t\t\t\t\t\tDMA_CH_IER_RIE_POS,\n\t\t\t\t\t\tDMA_CH_IER_RIE_LEN,\n\t\t\t\t\t\t1);\n\t\t}\n\n\t\twritel(dma_ch_isr, XLGMAC_DMA_REG(channel, DMA_CH_IER));\n\t}\n}\n\nstatic void xlgmac_enable_mtl_interrupts(struct xlgmac_pdata *pdata)\n{\n\tunsigned int q_count, i;\n\tunsigned int mtl_q_isr;\n\n\tq_count = max(pdata->hw_feat.tx_q_cnt, pdata->hw_feat.rx_q_cnt);\n\tfor (i = 0; i < q_count; i++) {\n\t\t \n\t\tmtl_q_isr = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_ISR));\n\t\twritel(mtl_q_isr, XLGMAC_MTL_REG(pdata, i, MTL_Q_ISR));\n\n\t\t \n\t\twritel(0, XLGMAC_MTL_REG(pdata, i, MTL_Q_IER));\n\t}\n}\n\nstatic void xlgmac_enable_mac_interrupts(struct xlgmac_pdata *pdata)\n{\n\tunsigned int mac_ier = 0;\n\tu32 regval;\n\n\t \n\tmac_ier = XLGMAC_SET_REG_BITS(mac_ier, MAC_IER_TSIE_POS,\n\t\t\t\t      MAC_IER_TSIE_LEN, 1);\n\n\twritel(mac_ier, pdata->mac_regs + MAC_IER);\n\n\t \n\tregval = readl(pdata->mac_regs + MMC_RIER);\n\tregval = XLGMAC_SET_REG_BITS(regval, MMC_RIER_ALL_INTERRUPTS_POS,\n\t\t\t\t     MMC_RIER_ALL_INTERRUPTS_LEN, 0xffffffff);\n\twritel(regval, pdata->mac_regs + MMC_RIER);\n\tregval = readl(pdata->mac_regs + MMC_TIER);\n\tregval = XLGMAC_SET_REG_BITS(regval, MMC_TIER_ALL_INTERRUPTS_POS,\n\t\t\t\t     MMC_TIER_ALL_INTERRUPTS_LEN, 0xffffffff);\n\twritel(regval, pdata->mac_regs + MMC_TIER);\n}\n\nstatic int xlgmac_set_xlgmii_25000_speed(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_TCR),\n\t\t\t\t     MAC_TCR_SS_POS, MAC_TCR_SS_LEN);\n\tif (regval == 0x1)\n\t\treturn 0;\n\n\tregval = readl(pdata->mac_regs + MAC_TCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_SS_POS,\n\t\t\t\t     MAC_TCR_SS_LEN, 0x1);\n\twritel(regval, pdata->mac_regs + MAC_TCR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_set_xlgmii_40000_speed(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_TCR),\n\t\t\t\t     MAC_TCR_SS_POS, MAC_TCR_SS_LEN);\n\tif (regval == 0)\n\t\treturn 0;\n\n\tregval = readl(pdata->mac_regs + MAC_TCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_SS_POS,\n\t\t\t\t     MAC_TCR_SS_LEN, 0);\n\twritel(regval, pdata->mac_regs + MAC_TCR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_set_xlgmii_50000_speed(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_TCR),\n\t\t\t\t     MAC_TCR_SS_POS, MAC_TCR_SS_LEN);\n\tif (regval == 0x2)\n\t\treturn 0;\n\n\tregval = readl(pdata->mac_regs + MAC_TCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_SS_POS,\n\t\t\t\t     MAC_TCR_SS_LEN, 0x2);\n\twritel(regval, pdata->mac_regs + MAC_TCR);\n\n\treturn 0;\n}\n\nstatic int xlgmac_set_xlgmii_100000_speed(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + MAC_TCR),\n\t\t\t\t     MAC_TCR_SS_POS, MAC_TCR_SS_LEN);\n\tif (regval == 0x3)\n\t\treturn 0;\n\n\tregval = readl(pdata->mac_regs + MAC_TCR);\n\tregval = XLGMAC_SET_REG_BITS(regval, MAC_TCR_SS_POS,\n\t\t\t\t     MAC_TCR_SS_LEN, 0x3);\n\twritel(regval, pdata->mac_regs + MAC_TCR);\n\n\treturn 0;\n}\n\nstatic void xlgmac_config_mac_speed(struct xlgmac_pdata *pdata)\n{\n\tswitch (pdata->phy_speed) {\n\tcase SPEED_100000:\n\t\txlgmac_set_xlgmii_100000_speed(pdata);\n\t\tbreak;\n\n\tcase SPEED_50000:\n\t\txlgmac_set_xlgmii_50000_speed(pdata);\n\t\tbreak;\n\n\tcase SPEED_40000:\n\t\txlgmac_set_xlgmii_40000_speed(pdata);\n\t\tbreak;\n\n\tcase SPEED_25000:\n\t\txlgmac_set_xlgmii_25000_speed(pdata);\n\t\tbreak;\n\t}\n}\n\nstatic int xlgmac_dev_read(struct xlgmac_channel *channel)\n{\n\tstruct xlgmac_pdata *pdata = channel->pdata;\n\tstruct xlgmac_ring *ring = channel->rx_ring;\n\tstruct net_device *netdev = pdata->netdev;\n\tstruct xlgmac_desc_data *desc_data;\n\tstruct xlgmac_dma_desc *dma_desc;\n\tstruct xlgmac_pkt_info *pkt_info;\n\tunsigned int err, etlt, l34t;\n\n\tdesc_data = XLGMAC_GET_DESC_DATA(ring, ring->cur);\n\tdma_desc = desc_data->dma_desc;\n\tpkt_info = &ring->pkt_info;\n\n\t \n\tif (XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t   RX_NORMAL_DESC3_OWN_POS,\n\t\t\t\t   RX_NORMAL_DESC3_OWN_LEN))\n\t\treturn 1;\n\n\t \n\tdma_rmb();\n\n\tif (netif_msg_rx_status(pdata))\n\t\txlgmac_dump_rx_desc(pdata, ring, ring->cur);\n\n\tif (XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t   RX_NORMAL_DESC3_CTXT_POS,\n\t\t\t\t   RX_NORMAL_DESC3_CTXT_LEN)) {\n\t\t \n\t\txlgmac_get_rx_tstamp(pkt_info, dma_desc);\n\n\t\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\t\t\tpkt_info->attributes,\n\t\t\t\t\tRX_PACKET_ATTRIBUTES_CONTEXT_POS,\n\t\t\t\t\tRX_PACKET_ATTRIBUTES_CONTEXT_LEN,\n\t\t\t\t\t1);\n\t\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\t\tpkt_info->attributes,\n\t\t\t\tRX_PACKET_ATTRIBUTES_CONTEXT_NEXT_POS,\n\t\t\t\tRX_PACKET_ATTRIBUTES_CONTEXT_NEXT_LEN,\n\t\t\t\t0);\n\t\treturn 0;\n\t}\n\n\t \n\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\t\tpkt_info->attributes,\n\t\t\t\tRX_PACKET_ATTRIBUTES_CONTEXT_POS,\n\t\t\t\tRX_PACKET_ATTRIBUTES_CONTEXT_LEN,\n\t\t\t\t0);\n\n\t \n\tif (XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t   RX_NORMAL_DESC3_CDA_POS,\n\t\t\t\t   RX_NORMAL_DESC3_CDA_LEN))\n\t\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\t\tpkt_info->attributes,\n\t\t\t\tRX_PACKET_ATTRIBUTES_CONTEXT_NEXT_POS,\n\t\t\t\tRX_PACKET_ATTRIBUTES_CONTEXT_NEXT_LEN,\n\t\t\t\t1);\n\n\t \n\tif (XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t   RX_NORMAL_DESC3_FD_POS,\n\t\t\t\t   RX_NORMAL_DESC3_FD_LEN)) {\n\t\tdesc_data->rx.hdr_len = XLGMAC_GET_REG_BITS_LE(dma_desc->desc2,\n\t\t\t\t\t\t\tRX_NORMAL_DESC2_HL_POS,\n\t\t\t\t\t\t\tRX_NORMAL_DESC2_HL_LEN);\n\t\tif (desc_data->rx.hdr_len)\n\t\t\tpdata->stats.rx_split_header_packets++;\n\t}\n\n\t \n\tif (XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t   RX_NORMAL_DESC3_RSV_POS,\n\t\t\t\t   RX_NORMAL_DESC3_RSV_LEN)) {\n\t\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\t\tpkt_info->attributes,\n\t\t\t\tRX_PACKET_ATTRIBUTES_RSS_HASH_POS,\n\t\t\t\tRX_PACKET_ATTRIBUTES_RSS_HASH_LEN,\n\t\t\t\t1);\n\n\t\tpkt_info->rss_hash = le32_to_cpu(dma_desc->desc1);\n\n\t\tl34t = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t\t      RX_NORMAL_DESC3_L34T_POS,\n\t\t\t\t\t  RX_NORMAL_DESC3_L34T_LEN);\n\t\tswitch (l34t) {\n\t\tcase RX_DESC3_L34T_IPV4_TCP:\n\t\tcase RX_DESC3_L34T_IPV4_UDP:\n\t\tcase RX_DESC3_L34T_IPV6_TCP:\n\t\tcase RX_DESC3_L34T_IPV6_UDP:\n\t\t\tpkt_info->rss_hash_type = PKT_HASH_TYPE_L4;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tpkt_info->rss_hash_type = PKT_HASH_TYPE_L3;\n\t\t}\n\t}\n\n\t \n\tdesc_data->rx.len = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t\tRX_NORMAL_DESC3_PL_POS,\n\t\t\t\t\tRX_NORMAL_DESC3_PL_LEN);\n\n\tif (!XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t    RX_NORMAL_DESC3_LD_POS,\n\t\t\t\t    RX_NORMAL_DESC3_LD_LEN)) {\n\t\t \n\t\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\t\tpkt_info->attributes,\n\t\t\t\tRX_PACKET_ATTRIBUTES_INCOMPLETE_POS,\n\t\t\t\tRX_PACKET_ATTRIBUTES_INCOMPLETE_LEN,\n\t\t\t\t1);\n\t\treturn 0;\n\t}\n\n\t \n\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\tpkt_info->attributes,\n\t\t\tRX_PACKET_ATTRIBUTES_INCOMPLETE_POS,\n\t\t\tRX_PACKET_ATTRIBUTES_INCOMPLETE_LEN,\n\t\t\t0);\n\n\t \n\tif (netdev->features & NETIF_F_RXCSUM)\n\t\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\t\tpkt_info->attributes,\n\t\t\t\tRX_PACKET_ATTRIBUTES_CSUM_DONE_POS,\n\t\t\t\tRX_PACKET_ATTRIBUTES_CSUM_DONE_LEN,\n\t\t\t\t1);\n\n\t \n\terr = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t     RX_NORMAL_DESC3_ES_POS,\n\t\t\t\t     RX_NORMAL_DESC3_ES_LEN);\n\tetlt = XLGMAC_GET_REG_BITS_LE(dma_desc->desc3,\n\t\t\t\t      RX_NORMAL_DESC3_ETLT_POS,\n\t\t\t\t      RX_NORMAL_DESC3_ETLT_LEN);\n\tnetif_dbg(pdata, rx_status, netdev, \"err=%u, etlt=%#x\\n\", err, etlt);\n\n\tif (!err || !etlt) {\n\t\t \n\t\tif ((etlt == 0x09) &&\n\t\t    (netdev->features & NETIF_F_HW_VLAN_CTAG_RX)) {\n\t\t\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\t\t\tpkt_info->attributes,\n\t\t\t\t\tRX_PACKET_ATTRIBUTES_VLAN_CTAG_POS,\n\t\t\t\t\tRX_PACKET_ATTRIBUTES_VLAN_CTAG_LEN,\n\t\t\t\t\t1);\n\t\t\tpkt_info->vlan_ctag =\n\t\t\t\tXLGMAC_GET_REG_BITS_LE(dma_desc->desc0,\n\t\t\t\t\t\t       RX_NORMAL_DESC0_OVT_POS,\n\t\t\t\t\t\t   RX_NORMAL_DESC0_OVT_LEN);\n\t\t\tnetif_dbg(pdata, rx_status, netdev, \"vlan-ctag=%#06x\\n\",\n\t\t\t\t  pkt_info->vlan_ctag);\n\t\t}\n\t} else {\n\t\tif ((etlt == 0x05) || (etlt == 0x06))\n\t\t\tpkt_info->attributes = XLGMAC_SET_REG_BITS(\n\t\t\t\t\tpkt_info->attributes,\n\t\t\t\t\tRX_PACKET_ATTRIBUTES_CSUM_DONE_POS,\n\t\t\t\t\tRX_PACKET_ATTRIBUTES_CSUM_DONE_LEN,\n\t\t\t\t\t0);\n\t\telse\n\t\t\tpkt_info->errors = XLGMAC_SET_REG_BITS(\n\t\t\t\t\tpkt_info->errors,\n\t\t\t\t\tRX_PACKET_ERRORS_FRAME_POS,\n\t\t\t\t\tRX_PACKET_ERRORS_FRAME_LEN,\n\t\t\t\t\t1);\n\t}\n\n\tXLGMAC_PR(\"%s - descriptor=%u (cur=%d)\\n\", channel->name,\n\t\t  ring->cur & (ring->dma_desc_count - 1), ring->cur);\n\n\treturn 0;\n}\n\nstatic int xlgmac_enable_int(struct xlgmac_channel *channel,\n\t\t\t     enum xlgmac_int int_id)\n{\n\tunsigned int dma_ch_ier;\n\n\tdma_ch_ier = readl(XLGMAC_DMA_REG(channel, DMA_CH_IER));\n\n\tswitch (int_id) {\n\tcase XLGMAC_INT_DMA_CH_SR_TI:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_TIE_POS,\n\t\t\t\tDMA_CH_IER_TIE_LEN, 1);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_TPS:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_TXSE_POS,\n\t\t\t\tDMA_CH_IER_TXSE_LEN, 1);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_TBU:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_TBUE_POS,\n\t\t\t\tDMA_CH_IER_TBUE_LEN, 1);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_RI:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_RIE_POS,\n\t\t\t\tDMA_CH_IER_RIE_LEN, 1);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_RBU:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_RBUE_POS,\n\t\t\t\tDMA_CH_IER_RBUE_LEN, 1);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_RPS:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_RSE_POS,\n\t\t\t\tDMA_CH_IER_RSE_LEN, 1);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_TI_RI:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_TIE_POS,\n\t\t\t\tDMA_CH_IER_TIE_LEN, 1);\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_RIE_POS,\n\t\t\t\tDMA_CH_IER_RIE_LEN, 1);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_FBE:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_FBEE_POS,\n\t\t\t\tDMA_CH_IER_FBEE_LEN, 1);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_ALL:\n\t\tdma_ch_ier |= channel->saved_ier;\n\t\tbreak;\n\tdefault:\n\t\treturn -1;\n\t}\n\n\twritel(dma_ch_ier, XLGMAC_DMA_REG(channel, DMA_CH_IER));\n\n\treturn 0;\n}\n\nstatic int xlgmac_disable_int(struct xlgmac_channel *channel,\n\t\t\t      enum xlgmac_int int_id)\n{\n\tunsigned int dma_ch_ier;\n\n\tdma_ch_ier = readl(XLGMAC_DMA_REG(channel, DMA_CH_IER));\n\n\tswitch (int_id) {\n\tcase XLGMAC_INT_DMA_CH_SR_TI:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_TIE_POS,\n\t\t\t\tDMA_CH_IER_TIE_LEN, 0);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_TPS:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_TXSE_POS,\n\t\t\t\tDMA_CH_IER_TXSE_LEN, 0);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_TBU:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_TBUE_POS,\n\t\t\t\tDMA_CH_IER_TBUE_LEN, 0);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_RI:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_RIE_POS,\n\t\t\t\tDMA_CH_IER_RIE_LEN, 0);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_RBU:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_RBUE_POS,\n\t\t\t\tDMA_CH_IER_RBUE_LEN, 0);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_RPS:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_RSE_POS,\n\t\t\t\tDMA_CH_IER_RSE_LEN, 0);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_TI_RI:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_TIE_POS,\n\t\t\t\tDMA_CH_IER_TIE_LEN, 0);\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_RIE_POS,\n\t\t\t\tDMA_CH_IER_RIE_LEN, 0);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_CH_SR_FBE:\n\t\tdma_ch_ier = XLGMAC_SET_REG_BITS(\n\t\t\t\tdma_ch_ier, DMA_CH_IER_FBEE_POS,\n\t\t\t\tDMA_CH_IER_FBEE_LEN, 0);\n\t\tbreak;\n\tcase XLGMAC_INT_DMA_ALL:\n\t\tchannel->saved_ier = dma_ch_ier & XLGMAC_DMA_INTERRUPT_MASK;\n\t\tdma_ch_ier &= ~XLGMAC_DMA_INTERRUPT_MASK;\n\t\tbreak;\n\tdefault:\n\t\treturn -1;\n\t}\n\n\twritel(dma_ch_ier, XLGMAC_DMA_REG(channel, DMA_CH_IER));\n\n\treturn 0;\n}\n\nstatic int xlgmac_flush_tx_queues(struct xlgmac_pdata *pdata)\n{\n\tunsigned int i, count;\n\tu32 regval;\n\n\tfor (i = 0; i < pdata->tx_q_count; i++) {\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t\tregval = XLGMAC_SET_REG_BITS(regval, MTL_Q_TQOMR_FTQ_POS,\n\t\t\t\t\t     MTL_Q_TQOMR_FTQ_LEN, 1);\n\t\twritel(regval, XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t}\n\n\t \n\tfor (i = 0; i < pdata->tx_q_count; i++) {\n\t\tcount = 2000;\n\t\tregval = readl(XLGMAC_MTL_REG(pdata, i, MTL_Q_TQOMR));\n\t\tregval = XLGMAC_GET_REG_BITS(regval, MTL_Q_TQOMR_FTQ_POS,\n\t\t\t\t\t     MTL_Q_TQOMR_FTQ_LEN);\n\t\twhile (--count && regval)\n\t\t\tusleep_range(500, 600);\n\n\t\tif (!count)\n\t\t\treturn -EBUSY;\n\t}\n\n\treturn 0;\n}\n\nstatic void xlgmac_config_dma_bus(struct xlgmac_pdata *pdata)\n{\n\tu32 regval;\n\n\tregval = readl(pdata->mac_regs + DMA_SBMR);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, DMA_SBMR_EAME_POS,\n\t\t\t\t     DMA_SBMR_EAME_LEN, 1);\n\t \n\tregval = XLGMAC_SET_REG_BITS(regval, DMA_SBMR_UNDEF_POS,\n\t\t\t\t     DMA_SBMR_UNDEF_LEN, 1);\n\tregval = XLGMAC_SET_REG_BITS(regval, DMA_SBMR_BLEN_256_POS,\n\t\t\t\t     DMA_SBMR_BLEN_256_LEN, 1);\n\twritel(regval, pdata->mac_regs + DMA_SBMR);\n}\n\nstatic int xlgmac_hw_init(struct xlgmac_pdata *pdata)\n{\n\tstruct xlgmac_desc_ops *desc_ops = &pdata->desc_ops;\n\tint ret;\n\n\t \n\tret = xlgmac_flush_tx_queues(pdata);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\txlgmac_config_dma_bus(pdata);\n\txlgmac_config_osp_mode(pdata);\n\txlgmac_config_pblx8(pdata);\n\txlgmac_config_tx_pbl_val(pdata);\n\txlgmac_config_rx_pbl_val(pdata);\n\txlgmac_config_rx_coalesce(pdata);\n\txlgmac_config_tx_coalesce(pdata);\n\txlgmac_config_rx_buffer_size(pdata);\n\txlgmac_config_tso_mode(pdata);\n\txlgmac_config_sph_mode(pdata);\n\txlgmac_config_rss(pdata);\n\tdesc_ops->tx_desc_init(pdata);\n\tdesc_ops->rx_desc_init(pdata);\n\txlgmac_enable_dma_interrupts(pdata);\n\n\t \n\txlgmac_config_mtl_mode(pdata);\n\txlgmac_config_queue_mapping(pdata);\n\txlgmac_config_tsf_mode(pdata, pdata->tx_sf_mode);\n\txlgmac_config_rsf_mode(pdata, pdata->rx_sf_mode);\n\txlgmac_config_tx_threshold(pdata, pdata->tx_threshold);\n\txlgmac_config_rx_threshold(pdata, pdata->rx_threshold);\n\txlgmac_config_tx_fifo_size(pdata);\n\txlgmac_config_rx_fifo_size(pdata);\n\txlgmac_config_flow_control_threshold(pdata);\n\txlgmac_config_rx_fep_enable(pdata);\n\txlgmac_config_rx_fup_enable(pdata);\n\txlgmac_enable_mtl_interrupts(pdata);\n\n\t \n\txlgmac_config_mac_address(pdata);\n\txlgmac_config_rx_mode(pdata);\n\txlgmac_config_jumbo_enable(pdata);\n\txlgmac_config_flow_control(pdata);\n\txlgmac_config_mac_speed(pdata);\n\txlgmac_config_checksum_offload(pdata);\n\txlgmac_config_vlan_support(pdata);\n\txlgmac_config_mmc(pdata);\n\txlgmac_enable_mac_interrupts(pdata);\n\n\treturn 0;\n}\n\nstatic int xlgmac_hw_exit(struct xlgmac_pdata *pdata)\n{\n\tunsigned int count = 2000;\n\tu32 regval;\n\n\t \n\tregval = readl(pdata->mac_regs + DMA_MR);\n\tregval = XLGMAC_SET_REG_BITS(regval, DMA_MR_SWR_POS,\n\t\t\t\t     DMA_MR_SWR_LEN, 1);\n\twritel(regval, pdata->mac_regs + DMA_MR);\n\tusleep_range(10, 15);\n\n\t \n\twhile (--count &&\n\t       XLGMAC_GET_REG_BITS(readl(pdata->mac_regs + DMA_MR),\n\t\t\t\t   DMA_MR_SWR_POS, DMA_MR_SWR_LEN))\n\t\tusleep_range(500, 600);\n\n\tif (!count)\n\t\treturn -EBUSY;\n\n\treturn 0;\n}\n\nvoid xlgmac_init_hw_ops(struct xlgmac_hw_ops *hw_ops)\n{\n\thw_ops->init = xlgmac_hw_init;\n\thw_ops->exit = xlgmac_hw_exit;\n\n\thw_ops->tx_complete = xlgmac_tx_complete;\n\n\thw_ops->enable_tx = xlgmac_enable_tx;\n\thw_ops->disable_tx = xlgmac_disable_tx;\n\thw_ops->enable_rx = xlgmac_enable_rx;\n\thw_ops->disable_rx = xlgmac_disable_rx;\n\n\thw_ops->dev_xmit = xlgmac_dev_xmit;\n\thw_ops->dev_read = xlgmac_dev_read;\n\thw_ops->enable_int = xlgmac_enable_int;\n\thw_ops->disable_int = xlgmac_disable_int;\n\n\thw_ops->set_mac_address = xlgmac_set_mac_address;\n\thw_ops->config_rx_mode = xlgmac_config_rx_mode;\n\thw_ops->enable_rx_csum = xlgmac_enable_rx_csum;\n\thw_ops->disable_rx_csum = xlgmac_disable_rx_csum;\n\n\t \n\thw_ops->set_xlgmii_25000_speed = xlgmac_set_xlgmii_25000_speed;\n\thw_ops->set_xlgmii_40000_speed = xlgmac_set_xlgmii_40000_speed;\n\thw_ops->set_xlgmii_50000_speed = xlgmac_set_xlgmii_50000_speed;\n\thw_ops->set_xlgmii_100000_speed = xlgmac_set_xlgmii_100000_speed;\n\n\t \n\thw_ops->tx_desc_init = xlgmac_tx_desc_init;\n\thw_ops->rx_desc_init = xlgmac_rx_desc_init;\n\thw_ops->tx_desc_reset = xlgmac_tx_desc_reset;\n\thw_ops->rx_desc_reset = xlgmac_rx_desc_reset;\n\thw_ops->is_last_desc = xlgmac_is_last_desc;\n\thw_ops->is_context_desc = xlgmac_is_context_desc;\n\thw_ops->tx_start_xmit = xlgmac_tx_start_xmit;\n\n\t \n\thw_ops->config_tx_flow_control = xlgmac_config_tx_flow_control;\n\thw_ops->config_rx_flow_control = xlgmac_config_rx_flow_control;\n\n\t \n\thw_ops->enable_rx_vlan_stripping = xlgmac_enable_rx_vlan_stripping;\n\thw_ops->disable_rx_vlan_stripping = xlgmac_disable_rx_vlan_stripping;\n\thw_ops->enable_rx_vlan_filtering = xlgmac_enable_rx_vlan_filtering;\n\thw_ops->disable_rx_vlan_filtering = xlgmac_disable_rx_vlan_filtering;\n\thw_ops->update_vlan_hash_table = xlgmac_update_vlan_hash_table;\n\n\t \n\thw_ops->config_rx_coalesce = xlgmac_config_rx_coalesce;\n\thw_ops->config_tx_coalesce = xlgmac_config_tx_coalesce;\n\thw_ops->usec_to_riwt = xlgmac_usec_to_riwt;\n\thw_ops->riwt_to_usec = xlgmac_riwt_to_usec;\n\n\t \n\thw_ops->config_rx_threshold = xlgmac_config_rx_threshold;\n\thw_ops->config_tx_threshold = xlgmac_config_tx_threshold;\n\n\t \n\thw_ops->config_rsf_mode = xlgmac_config_rsf_mode;\n\thw_ops->config_tsf_mode = xlgmac_config_tsf_mode;\n\n\t \n\thw_ops->config_osp_mode = xlgmac_config_osp_mode;\n\n\t \n\thw_ops->config_rx_pbl_val = xlgmac_config_rx_pbl_val;\n\thw_ops->get_rx_pbl_val = xlgmac_get_rx_pbl_val;\n\thw_ops->config_tx_pbl_val = xlgmac_config_tx_pbl_val;\n\thw_ops->get_tx_pbl_val = xlgmac_get_tx_pbl_val;\n\thw_ops->config_pblx8 = xlgmac_config_pblx8;\n\n\t \n\thw_ops->tx_mmc_int = xlgmac_tx_mmc_int;\n\thw_ops->rx_mmc_int = xlgmac_rx_mmc_int;\n\thw_ops->read_mmc_stats = xlgmac_read_mmc_stats;\n\n\t \n\thw_ops->enable_rss = xlgmac_enable_rss;\n\thw_ops->disable_rss = xlgmac_disable_rss;\n\thw_ops->set_rss_hash_key = xlgmac_set_rss_hash_key;\n\thw_ops->set_rss_lookup_table = xlgmac_set_rss_lookup_table;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}