{
  "module_name": "xgene_enet_ethtool.c",
  "hash_id": "626a22adc62928cabd0b07a65707766c70443c661aa2c4e3b549431d4a0095e0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/apm/xgene/xgene_enet_ethtool.c",
  "human_readable_source": "\n \n\n#include <linux/ethtool.h>\n#include \"xgene_enet_main.h\"\n\nstruct xgene_gstrings_stats {\n\tchar name[ETH_GSTRING_LEN];\n\tint offset;\n\tu32 addr;\n\tu32 mask;\n};\n\n#define XGENE_STAT(m) { #m, offsetof(struct rtnl_link_stats64, m) }\n#define XGENE_EXTD_STAT(s, a, m)\t\t\\\n\t\t{\t\t\t\\\n\t\t.name = #s,\t\t\\\n\t\t.addr = a ## _ADDR,\t\\\n\t\t.mask = m\t\t\\\n\t\t}\n\nstatic const struct xgene_gstrings_stats gstrings_stats[] = {\n\tXGENE_STAT(rx_packets),\n\tXGENE_STAT(tx_packets),\n\tXGENE_STAT(rx_bytes),\n\tXGENE_STAT(tx_bytes),\n\tXGENE_STAT(rx_errors),\n\tXGENE_STAT(tx_errors),\n\tXGENE_STAT(rx_length_errors),\n\tXGENE_STAT(rx_crc_errors),\n\tXGENE_STAT(rx_frame_errors),\n\tXGENE_STAT(rx_fifo_errors)\n};\n\nstatic const struct xgene_gstrings_stats gstrings_extd_stats[] = {\n\tXGENE_EXTD_STAT(tx_rx_64b_frame_cntr, TR64, 31),\n\tXGENE_EXTD_STAT(tx_rx_127b_frame_cntr, TR127, 31),\n\tXGENE_EXTD_STAT(tx_rx_255b_frame_cntr, TR255, 31),\n\tXGENE_EXTD_STAT(tx_rx_511b_frame_cntr, TR511, 31),\n\tXGENE_EXTD_STAT(tx_rx_1023b_frame_cntr, TR1K, 31),\n\tXGENE_EXTD_STAT(tx_rx_1518b_frame_cntr, TRMAX, 31),\n\tXGENE_EXTD_STAT(tx_rx_1522b_frame_cntr, TRMGV, 31),\n\tXGENE_EXTD_STAT(rx_fcs_error_cntr, RFCS, 16),\n\tXGENE_EXTD_STAT(rx_multicast_pkt_cntr, RMCA, 31),\n\tXGENE_EXTD_STAT(rx_broadcast_pkt_cntr, RBCA, 31),\n\tXGENE_EXTD_STAT(rx_ctrl_frame_pkt_cntr, RXCF, 16),\n\tXGENE_EXTD_STAT(rx_pause_frame_pkt_cntr, RXPF, 16),\n\tXGENE_EXTD_STAT(rx_unk_opcode_cntr, RXUO, 16),\n\tXGENE_EXTD_STAT(rx_align_err_cntr, RALN, 16),\n\tXGENE_EXTD_STAT(rx_frame_len_err_cntr, RFLR, 16),\n\tXGENE_EXTD_STAT(rx_frame_len_err_recov_cntr, DUMP, 0),\n\tXGENE_EXTD_STAT(rx_code_err_cntr, RCDE, 16),\n\tXGENE_EXTD_STAT(rx_carrier_sense_err_cntr, RCSE, 16),\n\tXGENE_EXTD_STAT(rx_undersize_pkt_cntr, RUND, 16),\n\tXGENE_EXTD_STAT(rx_oversize_pkt_cntr, ROVR, 16),\n\tXGENE_EXTD_STAT(rx_fragments_cntr, RFRG, 16),\n\tXGENE_EXTD_STAT(rx_jabber_cntr, RJBR, 16),\n\tXGENE_EXTD_STAT(rx_jabber_recov_cntr, DUMP, 0),\n\tXGENE_EXTD_STAT(rx_dropped_pkt_cntr, RDRP, 16),\n\tXGENE_EXTD_STAT(rx_overrun_cntr, DUMP, 0),\n\tXGENE_EXTD_STAT(tx_multicast_pkt_cntr, TMCA, 31),\n\tXGENE_EXTD_STAT(tx_broadcast_pkt_cntr, TBCA, 31),\n\tXGENE_EXTD_STAT(tx_pause_ctrl_frame_cntr, TXPF, 16),\n\tXGENE_EXTD_STAT(tx_defer_pkt_cntr, TDFR, 31),\n\tXGENE_EXTD_STAT(tx_excv_defer_pkt_cntr, TEDF, 31),\n\tXGENE_EXTD_STAT(tx_single_col_pkt_cntr, TSCL, 31),\n\tXGENE_EXTD_STAT(tx_multi_col_pkt_cntr, TMCL, 31),\n\tXGENE_EXTD_STAT(tx_late_col_pkt_cntr, TLCL, 31),\n\tXGENE_EXTD_STAT(tx_excv_col_pkt_cntr, TXCL, 31),\n\tXGENE_EXTD_STAT(tx_total_col_cntr, TNCL, 31),\n\tXGENE_EXTD_STAT(tx_pause_frames_hnrd_cntr, TPFH, 16),\n\tXGENE_EXTD_STAT(tx_drop_frame_cntr, TDRP, 16),\n\tXGENE_EXTD_STAT(tx_jabber_frame_cntr, TJBR, 12),\n\tXGENE_EXTD_STAT(tx_fcs_error_cntr, TFCS, 12),\n\tXGENE_EXTD_STAT(tx_ctrl_frame_cntr, TXCF, 12),\n\tXGENE_EXTD_STAT(tx_oversize_frame_cntr, TOVR, 12),\n\tXGENE_EXTD_STAT(tx_undersize_frame_cntr, TUND, 12),\n\tXGENE_EXTD_STAT(tx_fragments_cntr, TFRG, 12),\n\tXGENE_EXTD_STAT(tx_underrun_cntr, DUMP, 0)\n};\n\n#define XGENE_STATS_LEN\t\tARRAY_SIZE(gstrings_stats)\n#define XGENE_EXTD_STATS_LEN\tARRAY_SIZE(gstrings_extd_stats)\n#define RFCS_IDX\t\t7\n#define RALN_IDX\t\t13\n#define RFLR_IDX\t\t14\n#define FALSE_RFLR_IDX\t\t15\n#define RUND_IDX\t\t18\n#define FALSE_RJBR_IDX\t\t22\n#define RX_OVERRUN_IDX\t\t24\n#define TFCS_IDX\t\t38\n#define TFRG_IDX\t\t42\n#define TX_UNDERRUN_IDX\t\t43\n\nstatic void xgene_get_drvinfo(struct net_device *ndev,\n\t\t\t      struct ethtool_drvinfo *info)\n{\n\tstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\n\tstruct platform_device *pdev = pdata->pdev;\n\n\tstrcpy(info->driver, \"xgene_enet\");\n\tsprintf(info->bus_info, \"%s\", pdev->name);\n}\n\nstatic int xgene_get_link_ksettings(struct net_device *ndev,\n\t\t\t\t    struct ethtool_link_ksettings *cmd)\n{\n\tstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\n\tstruct phy_device *phydev = ndev->phydev;\n\tu32 supported;\n\n\tif (phy_interface_mode_is_rgmii(pdata->phy_mode)) {\n\t\tif (phydev == NULL)\n\t\t\treturn -ENODEV;\n\n\t\tphy_ethtool_ksettings_get(phydev, cmd);\n\n\t\treturn 0;\n\t} else if (pdata->phy_mode == PHY_INTERFACE_MODE_SGMII) {\n\t\tif (pdata->mdio_driver) {\n\t\t\tif (!phydev)\n\t\t\t\treturn -ENODEV;\n\n\t\t\tphy_ethtool_ksettings_get(phydev, cmd);\n\n\t\t\treturn 0;\n\t\t}\n\n\t\tsupported = SUPPORTED_1000baseT_Full | SUPPORTED_Autoneg |\n\t\t\tSUPPORTED_MII;\n\t\tethtool_convert_legacy_u32_to_link_mode(\n\t\t\tcmd->link_modes.supported,\n\t\t\tsupported);\n\t\tethtool_convert_legacy_u32_to_link_mode(\n\t\t\tcmd->link_modes.advertising,\n\t\t\tsupported);\n\n\t\tcmd->base.speed = SPEED_1000;\n\t\tcmd->base.duplex = DUPLEX_FULL;\n\t\tcmd->base.port = PORT_MII;\n\t\tcmd->base.autoneg = AUTONEG_ENABLE;\n\t} else {\n\t\tsupported = SUPPORTED_10000baseT_Full | SUPPORTED_FIBRE;\n\t\tethtool_convert_legacy_u32_to_link_mode(\n\t\t\tcmd->link_modes.supported,\n\t\t\tsupported);\n\t\tethtool_convert_legacy_u32_to_link_mode(\n\t\t\tcmd->link_modes.advertising,\n\t\t\tsupported);\n\n\t\tcmd->base.speed = SPEED_10000;\n\t\tcmd->base.duplex = DUPLEX_FULL;\n\t\tcmd->base.port = PORT_FIBRE;\n\t\tcmd->base.autoneg = AUTONEG_DISABLE;\n\t}\n\n\treturn 0;\n}\n\nstatic int xgene_set_link_ksettings(struct net_device *ndev,\n\t\t\t\t    const struct ethtool_link_ksettings *cmd)\n{\n\tstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\n\tstruct phy_device *phydev = ndev->phydev;\n\n\tif (phy_interface_mode_is_rgmii(pdata->phy_mode)) {\n\t\tif (!phydev)\n\t\t\treturn -ENODEV;\n\n\t\treturn phy_ethtool_ksettings_set(phydev, cmd);\n\t}\n\n\tif (pdata->phy_mode == PHY_INTERFACE_MODE_SGMII) {\n\t\tif (pdata->mdio_driver) {\n\t\t\tif (!phydev)\n\t\t\t\treturn -ENODEV;\n\n\t\t\treturn phy_ethtool_ksettings_set(phydev, cmd);\n\t\t}\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic void xgene_get_strings(struct net_device *ndev, u32 stringset, u8 *data)\n{\n\tint i;\n\tu8 *p = data;\n\n\tif (stringset != ETH_SS_STATS)\n\t\treturn;\n\n\tfor (i = 0; i < XGENE_STATS_LEN; i++) {\n\t\tmemcpy(p, gstrings_stats[i].name, ETH_GSTRING_LEN);\n\t\tp += ETH_GSTRING_LEN;\n\t}\n\n\tfor (i = 0; i < XGENE_EXTD_STATS_LEN; i++) {\n\t\tmemcpy(p, gstrings_extd_stats[i].name, ETH_GSTRING_LEN);\n\t\tp += ETH_GSTRING_LEN;\n\t}\n}\n\nstatic int xgene_get_sset_count(struct net_device *ndev, int sset)\n{\n\tif (sset != ETH_SS_STATS)\n\t\treturn -EINVAL;\n\n\treturn XGENE_STATS_LEN + XGENE_EXTD_STATS_LEN;\n}\n\nstatic void xgene_get_extd_stats(struct xgene_enet_pdata *pdata)\n{\n\tu32 rx_drop, tx_drop;\n\tu32 mask, tmp;\n\tint i;\n\n\tfor (i = 0; i < XGENE_EXTD_STATS_LEN; i++) {\n\t\ttmp = xgene_enet_rd_stat(pdata, gstrings_extd_stats[i].addr);\n\t\tif (gstrings_extd_stats[i].mask) {\n\t\t\tmask = GENMASK(gstrings_extd_stats[i].mask - 1, 0);\n\t\t\tpdata->extd_stats[i] += (tmp & mask);\n\t\t}\n\t}\n\n\tif (pdata->phy_mode == PHY_INTERFACE_MODE_XGMII) {\n\t\t \n\t\tpdata->extd_stats[RALN_IDX] = 0;\n\t} else {\n\t\t \n\t\tpdata->extd_stats[RFCS_IDX] -= pdata->extd_stats[RALN_IDX];\n\t\tpdata->extd_stats[RFLR_IDX] -= pdata->extd_stats[RUND_IDX];\n\t\tpdata->extd_stats[TFCS_IDX] -= pdata->extd_stats[TFRG_IDX];\n\t}\n\n\tpdata->mac_ops->get_drop_cnt(pdata, &rx_drop, &tx_drop);\n\tpdata->extd_stats[RX_OVERRUN_IDX] += rx_drop;\n\tpdata->extd_stats[TX_UNDERRUN_IDX] += tx_drop;\n\n\t \n\tpdata->extd_stats[FALSE_RFLR_IDX] = pdata->false_rflr;\n\t \n\tpdata->extd_stats[FALSE_RJBR_IDX] = pdata->vlan_rjbr;\n}\n\nint xgene_extd_stats_init(struct xgene_enet_pdata *pdata)\n{\n\tpdata->extd_stats = devm_kmalloc_array(&pdata->pdev->dev,\n\t\t\tXGENE_EXTD_STATS_LEN, sizeof(u64), GFP_KERNEL);\n\tif (!pdata->extd_stats)\n\t\treturn -ENOMEM;\n\n\txgene_get_extd_stats(pdata);\n\tmemset(pdata->extd_stats, 0, XGENE_EXTD_STATS_LEN * sizeof(u64));\n\n\treturn 0;\n}\n\nstatic void xgene_get_ethtool_stats(struct net_device *ndev,\n\t\t\t\t    struct ethtool_stats *dummy,\n\t\t\t\t    u64 *data)\n{\n\tstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\n\tstruct rtnl_link_stats64 stats;\n\tint i;\n\n\tdev_get_stats(ndev, &stats);\n\tfor (i = 0; i < XGENE_STATS_LEN; i++)\n\t\tdata[i] = *(u64 *)((char *)&stats + gstrings_stats[i].offset);\n\n\txgene_get_extd_stats(pdata);\n\tfor (i = 0; i < XGENE_EXTD_STATS_LEN; i++)\n\t\tdata[i + XGENE_STATS_LEN] = pdata->extd_stats[i];\n}\n\nstatic void xgene_get_pauseparam(struct net_device *ndev,\n\t\t\t\t struct ethtool_pauseparam *pp)\n{\n\tstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\n\n\tpp->autoneg = pdata->pause_autoneg;\n\tpp->tx_pause = pdata->tx_pause;\n\tpp->rx_pause = pdata->rx_pause;\n}\n\nstatic int xgene_set_pauseparam(struct net_device *ndev,\n\t\t\t\tstruct ethtool_pauseparam *pp)\n{\n\tstruct xgene_enet_pdata *pdata = netdev_priv(ndev);\n\tstruct phy_device *phydev = ndev->phydev;\n\n\tif (phy_interface_mode_is_rgmii(pdata->phy_mode) ||\n\t    pdata->phy_mode == PHY_INTERFACE_MODE_SGMII) {\n\t\tif (!phydev)\n\t\t\treturn -EINVAL;\n\n\t\tif (!phy_validate_pause(phydev, pp))\n\t\t\treturn -EINVAL;\n\n\t\tpdata->pause_autoneg = pp->autoneg;\n\t\tpdata->tx_pause = pp->tx_pause;\n\t\tpdata->rx_pause = pp->rx_pause;\n\n\t\tphy_set_asym_pause(phydev, pp->rx_pause,  pp->tx_pause);\n\n\t\tif (!pp->autoneg) {\n\t\t\tpdata->mac_ops->flowctl_tx(pdata, pdata->tx_pause);\n\t\t\tpdata->mac_ops->flowctl_rx(pdata, pdata->rx_pause);\n\t\t}\n\t} else {\n\t\tif (pp->autoneg)\n\t\t\treturn -EINVAL;\n\n\t\tpdata->tx_pause = pp->tx_pause;\n\t\tpdata->rx_pause = pp->rx_pause;\n\n\t\tpdata->mac_ops->flowctl_tx(pdata, pdata->tx_pause);\n\t\tpdata->mac_ops->flowctl_rx(pdata, pdata->rx_pause);\n\t}\n\n\treturn 0;\n}\n\nstatic const struct ethtool_ops xgene_ethtool_ops = {\n\t.get_drvinfo = xgene_get_drvinfo,\n\t.get_link = ethtool_op_get_link,\n\t.get_strings = xgene_get_strings,\n\t.get_sset_count = xgene_get_sset_count,\n\t.get_ethtool_stats = xgene_get_ethtool_stats,\n\t.get_link_ksettings = xgene_get_link_ksettings,\n\t.set_link_ksettings = xgene_set_link_ksettings,\n\t.get_pauseparam = xgene_get_pauseparam,\n\t.set_pauseparam = xgene_set_pauseparam\n};\n\nvoid xgene_enet_set_ethtool_ops(struct net_device *ndev)\n{\n\tndev->ethtool_ops = &xgene_ethtool_ops;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}