{
  "module_name": "mdio.c",
  "hash_id": "f7b7e288d6b95e7918c6940215dfa0b3a14a8a25705a393d08413e4709583abd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/ethernet/apm/xgene-v2/mdio.c",
  "human_readable_source": "\n \n\n#include \"main.h\"\n\nstatic int xge_mdio_write(struct mii_bus *bus, int phy_id, int reg, u16 data)\n{\n\tstruct xge_pdata *pdata = bus->priv;\n\tu32 done, val = 0;\n\tu8 wait = 10;\n\n\tSET_REG_BITS(&val, PHY_ADDR, phy_id);\n\tSET_REG_BITS(&val, REG_ADDR, reg);\n\txge_wr_csr(pdata, MII_MGMT_ADDRESS, val);\n\n\txge_wr_csr(pdata, MII_MGMT_CONTROL, data);\n\tdo {\n\t\tusleep_range(5, 10);\n\t\tdone = xge_rd_csr(pdata, MII_MGMT_INDICATORS);\n\t} while ((done & MII_MGMT_BUSY) && wait--);\n\n\tif (done & MII_MGMT_BUSY) {\n\t\tdev_err(&bus->dev, \"MII_MGMT write failed\\n\");\n\t\treturn -ETIMEDOUT;\n\t}\n\n\treturn 0;\n}\n\nstatic int xge_mdio_read(struct mii_bus *bus, int phy_id, int reg)\n{\n\tstruct xge_pdata *pdata = bus->priv;\n\tu32 data, done, val = 0;\n\tu8 wait = 10;\n\n\tSET_REG_BITS(&val, PHY_ADDR, phy_id);\n\tSET_REG_BITS(&val, REG_ADDR, reg);\n\txge_wr_csr(pdata, MII_MGMT_ADDRESS, val);\n\n\txge_wr_csr(pdata, MII_MGMT_COMMAND, MII_READ_CYCLE);\n\tdo {\n\t\tusleep_range(5, 10);\n\t\tdone = xge_rd_csr(pdata, MII_MGMT_INDICATORS);\n\t} while ((done & MII_MGMT_BUSY) && wait--);\n\n\tif (done & MII_MGMT_BUSY) {\n\t\tdev_err(&bus->dev, \"MII_MGMT read failed\\n\");\n\t\treturn -ETIMEDOUT;\n\t}\n\n\tdata = xge_rd_csr(pdata, MII_MGMT_STATUS);\n\txge_wr_csr(pdata, MII_MGMT_COMMAND, 0);\n\n\treturn data;\n}\n\nstatic void xge_adjust_link(struct net_device *ndev)\n{\n\tstruct xge_pdata *pdata = netdev_priv(ndev);\n\tstruct phy_device *phydev = ndev->phydev;\n\n\tif (phydev->link) {\n\t\tif (pdata->phy_speed != phydev->speed) {\n\t\t\tpdata->phy_speed = phydev->speed;\n\t\t\txge_mac_set_speed(pdata);\n\t\t\txge_mac_enable(pdata);\n\t\t\tphy_print_status(phydev);\n\t\t}\n\t} else {\n\t\tif (pdata->phy_speed != SPEED_UNKNOWN) {\n\t\t\tpdata->phy_speed = SPEED_UNKNOWN;\n\t\t\txge_mac_disable(pdata);\n\t\t\tphy_print_status(phydev);\n\t\t}\n\t}\n}\n\nvoid xge_mdio_remove(struct net_device *ndev)\n{\n\tstruct xge_pdata *pdata = netdev_priv(ndev);\n\tstruct mii_bus *mdio_bus = pdata->mdio_bus;\n\n\tif (ndev->phydev)\n\t\tphy_disconnect(ndev->phydev);\n\n\tif (mdio_bus->state == MDIOBUS_REGISTERED)\n\t\tmdiobus_unregister(mdio_bus);\n\n\tmdiobus_free(mdio_bus);\n}\n\nint xge_mdio_config(struct net_device *ndev)\n{\n\t__ETHTOOL_DECLARE_LINK_MODE_MASK(mask) = { 0, };\n\tstruct xge_pdata *pdata = netdev_priv(ndev);\n\tstruct device *dev = &pdata->pdev->dev;\n\tstruct mii_bus *mdio_bus;\n\tstruct phy_device *phydev;\n\tint ret;\n\n\tmdio_bus = mdiobus_alloc();\n\tif (!mdio_bus)\n\t\treturn -ENOMEM;\n\n\tmdio_bus->name = \"APM X-Gene Ethernet (v2) MDIO Bus\";\n\tmdio_bus->read = xge_mdio_read;\n\tmdio_bus->write = xge_mdio_write;\n\tmdio_bus->priv = pdata;\n\tmdio_bus->parent = dev;\n\tsnprintf(mdio_bus->id, MII_BUS_ID_SIZE, \"%s-mii\", dev_name(dev));\n\tpdata->mdio_bus = mdio_bus;\n\n\tmdio_bus->phy_mask = 0x1;\n\tret = mdiobus_register(mdio_bus);\n\tif (ret)\n\t\tgoto err;\n\n\tphydev = phy_find_first(mdio_bus);\n\tif (!phydev) {\n\t\tdev_err(dev, \"no PHY found\\n\");\n\t\tret = -ENODEV;\n\t\tgoto err;\n\t}\n\tphydev = phy_connect(ndev, phydev_name(phydev),\n\t\t\t     &xge_adjust_link,\n\t\t\t     pdata->resources.phy_mode);\n\n\tif (IS_ERR(phydev)) {\n\t\tnetdev_err(ndev, \"Could not attach to PHY\\n\");\n\t\tret = PTR_ERR(phydev);\n\t\tgoto err;\n\t}\n\n\tlinkmode_set_bit_array(phy_10_100_features_array,\n\t\t\t       ARRAY_SIZE(phy_10_100_features_array),\n\t\t\t       mask);\n\tlinkmode_set_bit(ETHTOOL_LINK_MODE_1000baseT_Half_BIT, mask);\n\tlinkmode_set_bit(ETHTOOL_LINK_MODE_AUI_BIT, mask);\n\tlinkmode_set_bit(ETHTOOL_LINK_MODE_MII_BIT, mask);\n\tlinkmode_set_bit(ETHTOOL_LINK_MODE_FIBRE_BIT, mask);\n\tlinkmode_set_bit(ETHTOOL_LINK_MODE_BNC_BIT, mask);\n\n\tlinkmode_andnot(phydev->supported, phydev->supported, mask);\n\tlinkmode_copy(phydev->advertising, phydev->supported);\n\tpdata->phy_speed = SPEED_UNKNOWN;\n\n\treturn 0;\nerr:\n\txge_mdio_remove(ndev);\n\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}