{
  "module_name": "arc-rimi.c",
  "hash_id": "450ac1eee3868817ba2f2178071f99c14f6f219ce071de152d69f32c46434258",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/arcnet/arc-rimi.c",
  "human_readable_source": " \n\n#define pr_fmt(fmt) \"arcnet:\" KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/moduleparam.h>\n#include <linux/ioport.h>\n#include <linux/delay.h>\n#include <linux/netdevice.h>\n#include <linux/memblock.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n\n#include \"arcdevice.h\"\n#include \"com9026.h\"\n\n \n\nstatic int arcrimi_probe(struct net_device *dev);\nstatic int arcrimi_found(struct net_device *dev);\nstatic void arcrimi_command(struct net_device *dev, int command);\nstatic int arcrimi_status(struct net_device *dev);\nstatic void arcrimi_setmask(struct net_device *dev, int mask);\nstatic int arcrimi_reset(struct net_device *dev, int really_reset);\nstatic void arcrimi_copy_to_card(struct net_device *dev, int bufnum, int offset,\n\t\t\t\t void *buf, int count);\nstatic void arcrimi_copy_from_card(struct net_device *dev, int bufnum,\n\t\t\t\t   int offset, void *buf, int count);\n\n \n\n \n#define BUFFER_SIZE\t(512)\n#define MIRROR_SIZE\t(BUFFER_SIZE * 4)\n\n \nstatic int __init arcrimi_probe(struct net_device *dev)\n{\n\tif (BUGLVL(D_NORMAL)) {\n\t\tpr_info(\"%s\\n\", \"RIM I (entirely mem-mapped) support\");\n\t\tpr_info(\"E-mail me if you actually test the RIM I driver, please!\\n\");\n\t\tpr_info(\"Given: node %02Xh, shmem %lXh, irq %d\\n\",\n\t\t\tdev->dev_addr[0], dev->mem_start, dev->irq);\n\t}\n\n\tif (dev->mem_start <= 0 || dev->irq <= 0) {\n\t\tif (BUGLVL(D_NORMAL))\n\t\t\tpr_err(\"No autoprobe for RIM I; you must specify the shmem and irq!\\n\");\n\t\treturn -ENODEV;\n\t}\n\tif (dev->dev_addr[0] == 0) {\n\t\tif (BUGLVL(D_NORMAL))\n\t\t\tpr_err(\"You need to specify your card's station ID!\\n\");\n\t\treturn -ENODEV;\n\t}\n\t \n\tif (!request_mem_region(dev->mem_start, MIRROR_SIZE, \"arcnet (90xx)\")) {\n\t\tif (BUGLVL(D_NORMAL))\n\t\t\tpr_notice(\"Card memory already allocated\\n\");\n\t\treturn -ENODEV;\n\t}\n\treturn arcrimi_found(dev);\n}\n\nstatic int check_mirror(unsigned long addr, size_t size)\n{\n\tvoid __iomem *p;\n\tint res = -1;\n\n\tif (!request_mem_region(addr, size, \"arcnet (90xx)\"))\n\t\treturn -1;\n\n\tp = ioremap(addr, size);\n\tif (p) {\n\t\tif (arcnet_readb(p, COM9026_REG_R_STATUS) == TESTvalue)\n\t\t\tres = 1;\n\t\telse\n\t\t\tres = 0;\n\t\tiounmap(p);\n\t}\n\n\trelease_mem_region(addr, size);\n\treturn res;\n}\n\n \nstatic int __init arcrimi_found(struct net_device *dev)\n{\n\tstruct arcnet_local *lp;\n\tunsigned long first_mirror, last_mirror, shmem;\n\tvoid __iomem *p;\n\tint mirror_size;\n\tint err;\n\n\tp = ioremap(dev->mem_start, MIRROR_SIZE);\n\tif (!p) {\n\t\trelease_mem_region(dev->mem_start, MIRROR_SIZE);\n\t\tarc_printk(D_NORMAL, dev, \"Can't ioremap\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tif (request_irq(dev->irq, arcnet_interrupt, 0, \"arcnet (RIM I)\", dev)) {\n\t\tiounmap(p);\n\t\trelease_mem_region(dev->mem_start, MIRROR_SIZE);\n\t\tarc_printk(D_NORMAL, dev, \"Can't get IRQ %d!\\n\", dev->irq);\n\t\treturn -ENODEV;\n\t}\n\n\tshmem = dev->mem_start;\n\tarcnet_writeb(TESTvalue, p, COM9026_REG_W_INTMASK);\n\tarcnet_writeb(TESTvalue, p, COM9026_REG_W_COMMAND);\n\t\t\t\t\t \n\n\t \n\n\t \n\tmirror_size = MIRROR_SIZE;\n\tif (arcnet_readb(p, COM9026_REG_R_STATUS) == TESTvalue &&\n\t    check_mirror(shmem - MIRROR_SIZE, MIRROR_SIZE) == 0 &&\n\t    check_mirror(shmem - 2 * MIRROR_SIZE, MIRROR_SIZE) == 1)\n\t\tmirror_size = 2 * MIRROR_SIZE;\n\n\tfirst_mirror = shmem - mirror_size;\n\twhile (check_mirror(first_mirror, mirror_size) == 1)\n\t\tfirst_mirror -= mirror_size;\n\tfirst_mirror += mirror_size;\n\n\tlast_mirror = shmem + mirror_size;\n\twhile (check_mirror(last_mirror, mirror_size) == 1)\n\t\tlast_mirror += mirror_size;\n\tlast_mirror -= mirror_size;\n\n\tdev->mem_start = first_mirror;\n\tdev->mem_end = last_mirror + MIRROR_SIZE - 1;\n\n\t \n\n\tlp = netdev_priv(dev);\n\tlp->card_name = \"RIM I\";\n\tlp->hw.command = arcrimi_command;\n\tlp->hw.status = arcrimi_status;\n\tlp->hw.intmask = arcrimi_setmask;\n\tlp->hw.reset = arcrimi_reset;\n\tlp->hw.owner = THIS_MODULE;\n\tlp->hw.copy_to_card = arcrimi_copy_to_card;\n\tlp->hw.copy_from_card = arcrimi_copy_from_card;\n\n\t \n\tiounmap(p);\n\trelease_mem_region(shmem, MIRROR_SIZE);\n\tif (!request_mem_region(dev->mem_start,\n\t\t\t\tdev->mem_end - dev->mem_start + 1,\n\t\t\t\t\"arcnet (90xx)\")) {\n\t\tarc_printk(D_NORMAL, dev, \"Card memory already allocated\\n\");\n\t\tgoto err_free_irq;\n\t}\n\n\tlp->mem_start = ioremap(dev->mem_start,\n\t\t\t\tdev->mem_end - dev->mem_start + 1);\n\tif (!lp->mem_start) {\n\t\tarc_printk(D_NORMAL, dev, \"Can't remap device memory!\\n\");\n\t\tgoto err_release_mem;\n\t}\n\n\t \n\tarcnet_set_addr(dev, arcnet_readb(lp->mem_start,\n\t\t\t\t\t  COM9026_REG_R_STATION));\n\n\tarc_printk(D_NORMAL, dev, \"ARCnet RIM I: station %02Xh found at IRQ %d, ShMem %lXh (%ld*%d bytes)\\n\",\n\t\t   dev->dev_addr[0],\n\t\t   dev->irq, dev->mem_start,\n\t\t   (dev->mem_end - dev->mem_start + 1) / mirror_size,\n\t\t   mirror_size);\n\n\terr = register_netdev(dev);\n\tif (err)\n\t\tgoto err_unmap;\n\n\treturn 0;\n\nerr_unmap:\n\tiounmap(lp->mem_start);\nerr_release_mem:\n\trelease_mem_region(dev->mem_start, dev->mem_end - dev->mem_start + 1);\nerr_free_irq:\n\tfree_irq(dev->irq, dev);\n\treturn -EIO;\n}\n\n \nstatic int arcrimi_reset(struct net_device *dev, int really_reset)\n{\n\tstruct arcnet_local *lp = netdev_priv(dev);\n\tvoid __iomem *ioaddr = lp->mem_start + 0x800;\n\n\tarc_printk(D_INIT, dev, \"Resetting %s (status=%02Xh)\\n\",\n\t\t   dev->name, arcnet_readb(ioaddr, COM9026_REG_R_STATUS));\n\n\tif (really_reset) {\n\t\tarcnet_writeb(TESTvalue, ioaddr, -0x800);\t \n\t\treturn 0;\n\t}\n\t \n\tarcnet_writeb(CFLAGScmd | RESETclear, ioaddr, COM9026_REG_W_COMMAND);\n\tarcnet_writeb(CFLAGScmd | CONFIGclear, ioaddr, COM9026_REG_W_COMMAND);\n\n\t \n\tarcnet_writeb(CONFIGcmd | EXTconf, ioaddr, COM9026_REG_W_COMMAND);\n\n\t \n\treturn 0;\n}\n\nstatic void arcrimi_setmask(struct net_device *dev, int mask)\n{\n\tstruct arcnet_local *lp = netdev_priv(dev);\n\tvoid __iomem *ioaddr = lp->mem_start + 0x800;\n\n\tarcnet_writeb(mask, ioaddr, COM9026_REG_W_INTMASK);\n}\n\nstatic int arcrimi_status(struct net_device *dev)\n{\n\tstruct arcnet_local *lp = netdev_priv(dev);\n\tvoid __iomem *ioaddr = lp->mem_start + 0x800;\n\n\treturn arcnet_readb(ioaddr, COM9026_REG_R_STATUS);\n}\n\nstatic void arcrimi_command(struct net_device *dev, int cmd)\n{\n\tstruct arcnet_local *lp = netdev_priv(dev);\n\tvoid __iomem *ioaddr = lp->mem_start + 0x800;\n\n\tarcnet_writeb(cmd, ioaddr, COM9026_REG_W_COMMAND);\n}\n\nstatic void arcrimi_copy_to_card(struct net_device *dev, int bufnum, int offset,\n\t\t\t\t void *buf, int count)\n{\n\tstruct arcnet_local *lp = netdev_priv(dev);\n\tvoid __iomem *memaddr = lp->mem_start + 0x800 + bufnum * 512 + offset;\n\n\tTIME(dev, \"memcpy_toio\", count, memcpy_toio(memaddr, buf, count));\n}\n\nstatic void arcrimi_copy_from_card(struct net_device *dev, int bufnum,\n\t\t\t\t   int offset, void *buf, int count)\n{\n\tstruct arcnet_local *lp = netdev_priv(dev);\n\tvoid __iomem *memaddr = lp->mem_start + 0x800 + bufnum * 512 + offset;\n\n\tTIME(dev, \"memcpy_fromio\", count, memcpy_fromio(buf, memaddr, count));\n}\n\nstatic int node;\nstatic int io;\t\t\t \nstatic int irq;\nstatic char device[9];\t\t \n\nmodule_param(node, int, 0);\nmodule_param(io, int, 0);\nmodule_param(irq, int, 0);\nmodule_param_string(device, device, sizeof(device), 0);\nMODULE_LICENSE(\"GPL\");\n\nstatic struct net_device *my_dev;\n\nstatic int __init arc_rimi_init(void)\n{\n\tstruct net_device *dev;\n\n\tdev = alloc_arcdev(device);\n\tif (!dev)\n\t\treturn -ENOMEM;\n\n\tif (node && node != 0xff)\n\t\tarcnet_set_addr(dev, node);\n\n\tdev->mem_start = io;\n\tdev->irq = irq;\n\tif (dev->irq == 2)\n\t\tdev->irq = 9;\n\n\tif (arcrimi_probe(dev)) {\n\t\tfree_arcdev(dev);\n\t\treturn -EIO;\n\t}\n\n\tmy_dev = dev;\n\treturn 0;\n}\n\nstatic void __exit arc_rimi_exit(void)\n{\n\tstruct net_device *dev = my_dev;\n\tstruct arcnet_local *lp = netdev_priv(dev);\n\n\tunregister_netdev(dev);\n\tiounmap(lp->mem_start);\n\trelease_mem_region(dev->mem_start, dev->mem_end - dev->mem_start + 1);\n\tfree_irq(dev->irq, dev);\n\tfree_arcdev(dev);\n}\n\n#ifndef MODULE\nstatic int __init arcrimi_setup(char *s)\n{\n\tint ints[8];\n\n\ts = get_options(s, 8, ints);\n\tif (!ints[0])\n\t\treturn 1;\n\tswitch (ints[0]) {\n\tdefault:\t\t \n\t\tpr_err(\"Too many arguments\\n\");\n\t\tfallthrough;\n\tcase 3:\t\t \n\t\tnode = ints[3];\n\t\tfallthrough;\n\tcase 2:\t\t \n\t\tirq = ints[2];\n\t\tfallthrough;\n\tcase 1:\t\t \n\t\tio = ints[1];\n\t}\n\tif (*s)\n\t\tsnprintf(device, sizeof(device), \"%s\", s);\n\treturn 1;\n}\n__setup(\"arcrimi=\", arcrimi_setup);\n#endif\t\t\t\t \n\nmodule_init(arc_rimi_init)\nmodule_exit(arc_rimi_exit)\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}