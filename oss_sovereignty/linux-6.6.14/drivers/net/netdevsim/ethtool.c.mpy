{
  "module_name": "ethtool.c",
  "hash_id": "c5a164a7cc371d090314d43708cbf82cf63257be1ea4f5bfd02b4f3a9730b615",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/netdevsim/ethtool.c",
  "human_readable_source": "\n\n\n#include <linux/debugfs.h>\n#include <linux/ethtool.h>\n#include <linux/random.h>\n\n#include \"netdevsim.h\"\n\nstatic void\nnsim_get_pause_stats(struct net_device *dev,\n\t\t     struct ethtool_pause_stats *pause_stats)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\n\tif (ns->ethtool.pauseparam.report_stats_rx)\n\t\tpause_stats->rx_pause_frames = 1;\n\tif (ns->ethtool.pauseparam.report_stats_tx)\n\t\tpause_stats->tx_pause_frames = 2;\n}\n\nstatic void\nnsim_get_pauseparam(struct net_device *dev, struct ethtool_pauseparam *pause)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\n\tpause->autoneg = 0;  \n\tpause->rx_pause = ns->ethtool.pauseparam.rx;\n\tpause->tx_pause = ns->ethtool.pauseparam.tx;\n}\n\nstatic int\nnsim_set_pauseparam(struct net_device *dev, struct ethtool_pauseparam *pause)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\n\tif (pause->autoneg)\n\t\treturn -EINVAL;\n\n\tns->ethtool.pauseparam.rx = pause->rx_pause;\n\tns->ethtool.pauseparam.tx = pause->tx_pause;\n\treturn 0;\n}\n\nstatic int nsim_get_coalesce(struct net_device *dev,\n\t\t\t     struct ethtool_coalesce *coal,\n\t\t\t     struct kernel_ethtool_coalesce *kernel_coal,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\n\tmemcpy(coal, &ns->ethtool.coalesce, sizeof(ns->ethtool.coalesce));\n\treturn 0;\n}\n\nstatic int nsim_set_coalesce(struct net_device *dev,\n\t\t\t     struct ethtool_coalesce *coal,\n\t\t\t     struct kernel_ethtool_coalesce *kernel_coal,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\n\tmemcpy(&ns->ethtool.coalesce, coal, sizeof(ns->ethtool.coalesce));\n\treturn 0;\n}\n\nstatic void nsim_get_ringparam(struct net_device *dev,\n\t\t\t       struct ethtool_ringparam *ring,\n\t\t\t       struct kernel_ethtool_ringparam *kernel_ring,\n\t\t\t       struct netlink_ext_ack *extack)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\n\tmemcpy(ring, &ns->ethtool.ring, sizeof(ns->ethtool.ring));\n}\n\nstatic int nsim_set_ringparam(struct net_device *dev,\n\t\t\t      struct ethtool_ringparam *ring,\n\t\t\t      struct kernel_ethtool_ringparam *kernel_ring,\n\t\t\t      struct netlink_ext_ack *extack)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\n\tns->ethtool.ring.rx_pending = ring->rx_pending;\n\tns->ethtool.ring.rx_jumbo_pending = ring->rx_jumbo_pending;\n\tns->ethtool.ring.rx_mini_pending = ring->rx_mini_pending;\n\tns->ethtool.ring.tx_pending = ring->tx_pending;\n\treturn 0;\n}\n\nstatic void\nnsim_get_channels(struct net_device *dev, struct ethtool_channels *ch)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\n\tch->max_combined = ns->nsim_bus_dev->num_queues;\n\tch->combined_count = ns->ethtool.channels;\n}\n\nstatic int\nnsim_set_channels(struct net_device *dev, struct ethtool_channels *ch)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\tint err;\n\n\terr = netif_set_real_num_queues(dev, ch->combined_count,\n\t\t\t\t\tch->combined_count);\n\tif (err)\n\t\treturn err;\n\n\tns->ethtool.channels = ch->combined_count;\n\treturn 0;\n}\n\nstatic int\nnsim_get_fecparam(struct net_device *dev, struct ethtool_fecparam *fecparam)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\n\tif (ns->ethtool.get_err)\n\t\treturn -ns->ethtool.get_err;\n\tmemcpy(fecparam, &ns->ethtool.fec, sizeof(ns->ethtool.fec));\n\treturn 0;\n}\n\nstatic int\nnsim_set_fecparam(struct net_device *dev, struct ethtool_fecparam *fecparam)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\tu32 fec;\n\n\tif (ns->ethtool.set_err)\n\t\treturn -ns->ethtool.set_err;\n\tmemcpy(&ns->ethtool.fec, fecparam, sizeof(ns->ethtool.fec));\n\tfec = fecparam->fec;\n\tif (fec == ETHTOOL_FEC_AUTO)\n\t\tfec |= ETHTOOL_FEC_OFF;\n\tfec |= ETHTOOL_FEC_NONE;\n\tns->ethtool.fec.active_fec = 1 << (fls(fec) - 1);\n\treturn 0;\n}\n\nstatic int nsim_get_ts_info(struct net_device *dev,\n\t\t\t    struct ethtool_ts_info *info)\n{\n\tstruct netdevsim *ns = netdev_priv(dev);\n\n\tinfo->phc_index = mock_phc_index(ns->phc);\n\n\treturn 0;\n}\n\nstatic const struct ethtool_ops nsim_ethtool_ops = {\n\t.supported_coalesce_params\t= ETHTOOL_COALESCE_ALL_PARAMS,\n\t.get_pause_stats\t        = nsim_get_pause_stats,\n\t.get_pauseparam\t\t        = nsim_get_pauseparam,\n\t.set_pauseparam\t\t        = nsim_set_pauseparam,\n\t.set_coalesce\t\t\t= nsim_set_coalesce,\n\t.get_coalesce\t\t\t= nsim_get_coalesce,\n\t.get_ringparam\t\t\t= nsim_get_ringparam,\n\t.set_ringparam\t\t\t= nsim_set_ringparam,\n\t.get_channels\t\t\t= nsim_get_channels,\n\t.set_channels\t\t\t= nsim_set_channels,\n\t.get_fecparam\t\t\t= nsim_get_fecparam,\n\t.set_fecparam\t\t\t= nsim_set_fecparam,\n\t.get_ts_info\t\t\t= nsim_get_ts_info,\n};\n\nstatic void nsim_ethtool_ring_init(struct netdevsim *ns)\n{\n\tns->ethtool.ring.rx_max_pending = 4096;\n\tns->ethtool.ring.rx_jumbo_max_pending = 4096;\n\tns->ethtool.ring.rx_mini_max_pending = 4096;\n\tns->ethtool.ring.tx_max_pending = 4096;\n}\n\nvoid nsim_ethtool_init(struct netdevsim *ns)\n{\n\tstruct dentry *ethtool, *dir;\n\n\tns->netdev->ethtool_ops = &nsim_ethtool_ops;\n\n\tnsim_ethtool_ring_init(ns);\n\n\tns->ethtool.fec.fec = ETHTOOL_FEC_NONE;\n\tns->ethtool.fec.active_fec = ETHTOOL_FEC_NONE;\n\n\tns->ethtool.channels = ns->nsim_bus_dev->num_queues;\n\n\tethtool = debugfs_create_dir(\"ethtool\", ns->nsim_dev_port->ddir);\n\n\tdebugfs_create_u32(\"get_err\", 0600, ethtool, &ns->ethtool.get_err);\n\tdebugfs_create_u32(\"set_err\", 0600, ethtool, &ns->ethtool.set_err);\n\n\tdir = debugfs_create_dir(\"pause\", ethtool);\n\tdebugfs_create_bool(\"report_stats_rx\", 0600, dir,\n\t\t\t    &ns->ethtool.pauseparam.report_stats_rx);\n\tdebugfs_create_bool(\"report_stats_tx\", 0600, dir,\n\t\t\t    &ns->ethtool.pauseparam.report_stats_tx);\n\n\tdir = debugfs_create_dir(\"ring\", ethtool);\n\tdebugfs_create_u32(\"rx_max_pending\", 0600, dir,\n\t\t\t   &ns->ethtool.ring.rx_max_pending);\n\tdebugfs_create_u32(\"rx_jumbo_max_pending\", 0600, dir,\n\t\t\t   &ns->ethtool.ring.rx_jumbo_max_pending);\n\tdebugfs_create_u32(\"rx_mini_max_pending\", 0600, dir,\n\t\t\t   &ns->ethtool.ring.rx_mini_max_pending);\n\tdebugfs_create_u32(\"tx_max_pending\", 0600, dir,\n\t\t\t   &ns->ethtool.ring.tx_max_pending);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}