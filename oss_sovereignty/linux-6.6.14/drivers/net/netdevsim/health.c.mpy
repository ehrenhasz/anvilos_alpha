{
  "module_name": "health.c",
  "hash_id": "ad4cc870d8832e3f51bd52783d4a6aaf05bf7013e6e4d907179c9a570267fe77",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/netdevsim/health.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n\n#include \"netdevsim.h\"\n\nstatic int\nnsim_dev_empty_reporter_dump(struct devlink_health_reporter *reporter,\n\t\t\t     struct devlink_fmsg *fmsg, void *priv_ctx,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\treturn 0;\n}\n\nstatic int\nnsim_dev_empty_reporter_diagnose(struct devlink_health_reporter *reporter,\n\t\t\t\t struct devlink_fmsg *fmsg,\n\t\t\t\t struct netlink_ext_ack *extack)\n{\n\treturn 0;\n}\n\nstatic const\nstruct devlink_health_reporter_ops nsim_dev_empty_reporter_ops = {\n\t.name = \"empty\",\n\t.dump = nsim_dev_empty_reporter_dump,\n\t.diagnose = nsim_dev_empty_reporter_diagnose,\n};\n\nstruct nsim_dev_dummy_reporter_ctx {\n\tchar *break_msg;\n};\n\nstatic int\nnsim_dev_dummy_reporter_recover(struct devlink_health_reporter *reporter,\n\t\t\t\tvoid *priv_ctx,\n\t\t\t\tstruct netlink_ext_ack *extack)\n{\n\tstruct nsim_dev_health *health = devlink_health_reporter_priv(reporter);\n\tstruct nsim_dev_dummy_reporter_ctx *ctx = priv_ctx;\n\n\tif (health->fail_recover) {\n\t\t \n\t\tNL_SET_ERR_MSG_MOD(extack, \"User setup the recover to fail for testing purposes\");\n\t\treturn -EINVAL;\n\t}\n\tif (ctx) {\n\t\tkfree(health->recovered_break_msg);\n\t\thealth->recovered_break_msg = kstrdup(ctx->break_msg,\n\t\t\t\t\t\t      GFP_KERNEL);\n\t\tif (!health->recovered_break_msg)\n\t\t\treturn -ENOMEM;\n\t}\n\treturn 0;\n}\n\nstatic int nsim_dev_dummy_fmsg_put(struct devlink_fmsg *fmsg, u32 binary_len)\n{\n\tchar *binary;\n\tint err;\n\tint i;\n\n\terr = devlink_fmsg_bool_pair_put(fmsg, \"test_bool\", true);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_u8_pair_put(fmsg, \"test_u8\", 1);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_u32_pair_put(fmsg, \"test_u32\", 3);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_u64_pair_put(fmsg, \"test_u64\", 4);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_string_pair_put(fmsg, \"test_string\", \"somestring\");\n\tif (err)\n\t\treturn err;\n\n\tbinary = kmalloc(binary_len, GFP_KERNEL | __GFP_NOWARN);\n\tif (!binary)\n\t\treturn -ENOMEM;\n\tget_random_bytes(binary, binary_len);\n\terr = devlink_fmsg_binary_pair_put(fmsg, \"test_binary\", binary, binary_len);\n\tkfree(binary);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_pair_nest_start(fmsg, \"test_nest\");\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_obj_nest_start(fmsg);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_bool_pair_put(fmsg, \"nested_test_bool\", false);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_u8_pair_put(fmsg, \"nested_test_u8\", false);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_obj_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\terr = devlink_fmsg_pair_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_arr_pair_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_arr_pair_nest_start(fmsg, \"test_u32_array\");\n\tif (err)\n\t\treturn err;\n\tfor (i = 0; i < 10; i++) {\n\t\terr = devlink_fmsg_u32_put(fmsg, i);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\terr = devlink_fmsg_arr_pair_nest_end(fmsg);\n\tif (err)\n\t\treturn err;\n\n\terr = devlink_fmsg_arr_pair_nest_start(fmsg, \"test_array_of_objects\");\n\tif (err)\n\t\treturn err;\n\tfor (i = 0; i < 10; i++) {\n\t\terr = devlink_fmsg_obj_nest_start(fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_bool_pair_put(fmsg,\n\t\t\t\t\t\t \"in_array_nested_test_bool\",\n\t\t\t\t\t\t false);\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_u8_pair_put(fmsg,\n\t\t\t\t\t       \"in_array_nested_test_u8\",\n\t\t\t\t\t       i);\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = devlink_fmsg_obj_nest_end(fmsg);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\treturn devlink_fmsg_arr_pair_nest_end(fmsg);\n}\n\nstatic int\nnsim_dev_dummy_reporter_dump(struct devlink_health_reporter *reporter,\n\t\t\t     struct devlink_fmsg *fmsg, void *priv_ctx,\n\t\t\t     struct netlink_ext_ack *extack)\n{\n\tstruct nsim_dev_health *health = devlink_health_reporter_priv(reporter);\n\tstruct nsim_dev_dummy_reporter_ctx *ctx = priv_ctx;\n\tint err;\n\n\tif (ctx) {\n\t\terr = devlink_fmsg_string_pair_put(fmsg, \"break_message\",\n\t\t\t\t\t\t   ctx->break_msg);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\treturn nsim_dev_dummy_fmsg_put(fmsg, health->binary_len);\n}\n\nstatic int\nnsim_dev_dummy_reporter_diagnose(struct devlink_health_reporter *reporter,\n\t\t\t\t struct devlink_fmsg *fmsg,\n\t\t\t\t struct netlink_ext_ack *extack)\n{\n\tstruct nsim_dev_health *health = devlink_health_reporter_priv(reporter);\n\tint err;\n\n\tif (health->recovered_break_msg) {\n\t\terr = devlink_fmsg_string_pair_put(fmsg,\n\t\t\t\t\t\t   \"recovered_break_message\",\n\t\t\t\t\t\t   health->recovered_break_msg);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\treturn nsim_dev_dummy_fmsg_put(fmsg, health->binary_len);\n}\n\nstatic const\nstruct devlink_health_reporter_ops nsim_dev_dummy_reporter_ops = {\n\t.name = \"dummy\",\n\t.recover = nsim_dev_dummy_reporter_recover,\n\t.dump = nsim_dev_dummy_reporter_dump,\n\t.diagnose = nsim_dev_dummy_reporter_diagnose,\n};\n\nstatic ssize_t nsim_dev_health_break_write(struct file *file,\n\t\t\t\t\t   const char __user *data,\n\t\t\t\t\t   size_t count, loff_t *ppos)\n{\n\tstruct nsim_dev_health *health = file->private_data;\n\tstruct nsim_dev_dummy_reporter_ctx ctx;\n\tchar *break_msg;\n\tint err;\n\n\tbreak_msg = memdup_user_nul(data, count);\n\tif (IS_ERR(break_msg))\n\t\treturn PTR_ERR(break_msg);\n\n\tif (break_msg[count - 1] == '\\n')\n\t\tbreak_msg[count - 1] = '\\0';\n\n\tctx.break_msg = break_msg;\n\terr = devlink_health_report(health->dummy_reporter, break_msg, &ctx);\n\tif (err)\n\t\tgoto out;\n\nout:\n\tkfree(break_msg);\n\treturn err ?: count;\n}\n\nstatic const struct file_operations nsim_dev_health_break_fops = {\n\t.open = simple_open,\n\t.write = nsim_dev_health_break_write,\n\t.llseek = generic_file_llseek,\n\t.owner = THIS_MODULE,\n};\n\nint nsim_dev_health_init(struct nsim_dev *nsim_dev, struct devlink *devlink)\n{\n\tstruct nsim_dev_health *health = &nsim_dev->health;\n\tint err;\n\n\thealth->empty_reporter =\n\t\tdevl_health_reporter_create(devlink,\n\t\t\t\t\t    &nsim_dev_empty_reporter_ops,\n\t\t\t\t\t    0, health);\n\tif (IS_ERR(health->empty_reporter))\n\t\treturn PTR_ERR(health->empty_reporter);\n\n\thealth->dummy_reporter =\n\t\tdevl_health_reporter_create(devlink,\n\t\t\t\t\t    &nsim_dev_dummy_reporter_ops,\n\t\t\t\t\t    0, health);\n\tif (IS_ERR(health->dummy_reporter)) {\n\t\terr = PTR_ERR(health->dummy_reporter);\n\t\tgoto err_empty_reporter_destroy;\n\t}\n\n\thealth->ddir = debugfs_create_dir(\"health\", nsim_dev->ddir);\n\tif (IS_ERR(health->ddir)) {\n\t\terr = PTR_ERR(health->ddir);\n\t\tgoto err_dummy_reporter_destroy;\n\t}\n\n\thealth->recovered_break_msg = NULL;\n\tdebugfs_create_file(\"break_health\", 0200, health->ddir, health,\n\t\t\t    &nsim_dev_health_break_fops);\n\thealth->binary_len = 16;\n\tdebugfs_create_u32(\"binary_len\", 0600, health->ddir,\n\t\t\t   &health->binary_len);\n\thealth->fail_recover = false;\n\tdebugfs_create_bool(\"fail_recover\", 0600, health->ddir,\n\t\t\t    &health->fail_recover);\n\treturn 0;\n\nerr_dummy_reporter_destroy:\n\tdevl_health_reporter_destroy(health->dummy_reporter);\nerr_empty_reporter_destroy:\n\tdevl_health_reporter_destroy(health->empty_reporter);\n\treturn err;\n}\n\nvoid nsim_dev_health_exit(struct nsim_dev *nsim_dev)\n{\n\tstruct nsim_dev_health *health = &nsim_dev->health;\n\n\tdebugfs_remove_recursive(health->ddir);\n\tkfree(health->recovered_break_msg);\n\tdevl_health_reporter_destroy(health->dummy_reporter);\n\tdevl_health_reporter_destroy(health->empty_reporter);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}