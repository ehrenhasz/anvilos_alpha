{
  "module_name": "macsec.c",
  "hash_id": "eee5f359cda8afe9ab02962e6a61e029177a03f71840dda4e2973e482d475292",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/netdevsim/macsec.c",
  "human_readable_source": "\n\n#include <net/macsec.h>\n#include \"netdevsim.h\"\n\nstatic inline u64 sci_to_cpu(sci_t sci)\n{\n\treturn be64_to_cpu((__force __be64)sci);\n}\n\nstatic int nsim_macsec_find_secy(struct netdevsim *ns, sci_t sci)\n{\n\tint i;\n\n\tfor (i = 0; i < NSIM_MACSEC_MAX_SECY_COUNT; i++) {\n\t\tif (ns->macsec.nsim_secy[i].sci == sci)\n\t\t\treturn i;\n\t}\n\n\treturn -1;\n}\n\nstatic int nsim_macsec_find_rxsc(struct nsim_secy *ns_secy, sci_t sci)\n{\n\tint i;\n\n\tfor (i = 0; i < NSIM_MACSEC_MAX_RXSC_COUNT; i++) {\n\t\tif (ns_secy->nsim_rxsc[i].sci == sci)\n\t\t\treturn i;\n\t}\n\n\treturn -1;\n}\n\nstatic int nsim_macsec_add_secy(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tint idx;\n\n\tif (ns->macsec.nsim_secy_count == NSIM_MACSEC_MAX_SECY_COUNT)\n\t\treturn -ENOSPC;\n\n\tfor (idx = 0; idx < NSIM_MACSEC_MAX_SECY_COUNT; idx++) {\n\t\tif (!ns->macsec.nsim_secy[idx].used)\n\t\t\tbreak;\n\t}\n\n\tif (idx == NSIM_MACSEC_MAX_SECY_COUNT) {\n\t\tnetdev_err(ctx->netdev, \"%s: nsim_secy_count not full but all SecYs used\\n\",\n\t\t\t   __func__);\n\t\treturn -ENOSPC;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: adding new secy with sci %08llx at index %d\\n\",\n\t\t   __func__, sci_to_cpu(ctx->secy->sci), idx);\n\tns->macsec.nsim_secy[idx].used = true;\n\tns->macsec.nsim_secy[idx].nsim_rxsc_count = 0;\n\tns->macsec.nsim_secy[idx].sci = ctx->secy->sci;\n\tns->macsec.nsim_secy_count++;\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_upd_secy(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: updating secy with sci %08llx at index %d\\n\",\n\t\t   __func__, sci_to_cpu(ctx->secy->sci), idx);\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_del_secy(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: removing SecY with SCI %08llx at index %d\\n\",\n\t\t   __func__, sci_to_cpu(ctx->secy->sci), idx);\n\n\tns->macsec.nsim_secy[idx].used = false;\n\tmemset(&ns->macsec.nsim_secy[idx], 0, sizeof(ns->macsec.nsim_secy[idx]));\n\tns->macsec.nsim_secy_count--;\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_add_rxsc(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tstruct nsim_secy *secy;\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\tsecy = &ns->macsec.nsim_secy[idx];\n\n\tif (secy->nsim_rxsc_count == NSIM_MACSEC_MAX_RXSC_COUNT)\n\t\treturn -ENOSPC;\n\n\tfor (idx = 0; idx < NSIM_MACSEC_MAX_RXSC_COUNT; idx++) {\n\t\tif (!secy->nsim_rxsc[idx].used)\n\t\t\tbreak;\n\t}\n\n\tif (idx == NSIM_MACSEC_MAX_RXSC_COUNT)\n\t\tnetdev_err(ctx->netdev, \"%s: nsim_rxsc_count not full but all RXSCs used\\n\",\n\t\t\t   __func__);\n\n\tnetdev_dbg(ctx->netdev, \"%s: adding new rxsc with sci %08llx at index %d\\n\",\n\t\t   __func__, sci_to_cpu(ctx->rx_sc->sci), idx);\n\tsecy->nsim_rxsc[idx].used = true;\n\tsecy->nsim_rxsc[idx].sci = ctx->rx_sc->sci;\n\tsecy->nsim_rxsc_count++;\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_upd_rxsc(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tstruct nsim_secy *secy;\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\tsecy = &ns->macsec.nsim_secy[idx];\n\n\tidx = nsim_macsec_find_rxsc(secy, ctx->rx_sc->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in RXSC table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->rx_sc->sci));\n\t\treturn -ENOENT;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: updating RXSC with sci %08llx at index %d\\n\",\n\t\t   __func__, sci_to_cpu(ctx->rx_sc->sci), idx);\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_del_rxsc(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tstruct nsim_secy *secy;\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\tsecy = &ns->macsec.nsim_secy[idx];\n\n\tidx = nsim_macsec_find_rxsc(secy, ctx->rx_sc->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in RXSC table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->rx_sc->sci));\n\t\treturn -ENOENT;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: removing RXSC with sci %08llx at index %d\\n\",\n\t\t   __func__, sci_to_cpu(ctx->rx_sc->sci), idx);\n\n\tsecy->nsim_rxsc[idx].used = false;\n\tmemset(&secy->nsim_rxsc[idx], 0, sizeof(secy->nsim_rxsc[idx]));\n\tsecy->nsim_rxsc_count--;\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_add_rxsa(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tstruct nsim_secy *secy;\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\tsecy = &ns->macsec.nsim_secy[idx];\n\n\tidx = nsim_macsec_find_rxsc(secy, ctx->sa.rx_sa->sc->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in RXSC table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->sa.rx_sa->sc->sci));\n\t\treturn -ENOENT;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: RXSC with sci %08llx, AN %u\\n\",\n\t\t   __func__, sci_to_cpu(ctx->sa.rx_sa->sc->sci), ctx->sa.assoc_num);\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_upd_rxsa(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tstruct nsim_secy *secy;\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\tsecy = &ns->macsec.nsim_secy[idx];\n\n\tidx = nsim_macsec_find_rxsc(secy, ctx->sa.rx_sa->sc->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in RXSC table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->sa.rx_sa->sc->sci));\n\t\treturn -ENOENT;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: RXSC with sci %08llx, AN %u\\n\",\n\t\t   __func__, sci_to_cpu(ctx->sa.rx_sa->sc->sci), ctx->sa.assoc_num);\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_del_rxsa(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tstruct nsim_secy *secy;\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\tsecy = &ns->macsec.nsim_secy[idx];\n\n\tidx = nsim_macsec_find_rxsc(secy, ctx->sa.rx_sa->sc->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in RXSC table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->sa.rx_sa->sc->sci));\n\t\treturn -ENOENT;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: RXSC with sci %08llx, AN %u\\n\",\n\t\t   __func__, sci_to_cpu(ctx->sa.rx_sa->sc->sci), ctx->sa.assoc_num);\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_add_txsa(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: SECY with sci %08llx, AN %u\\n\",\n\t\t   __func__, sci_to_cpu(ctx->secy->sci), ctx->sa.assoc_num);\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_upd_txsa(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: SECY with sci %08llx, AN %u\\n\",\n\t\t   __func__, sci_to_cpu(ctx->secy->sci), ctx->sa.assoc_num);\n\n\treturn 0;\n}\n\nstatic int nsim_macsec_del_txsa(struct macsec_context *ctx)\n{\n\tstruct netdevsim *ns = netdev_priv(ctx->netdev);\n\tint idx;\n\n\tidx = nsim_macsec_find_secy(ns, ctx->secy->sci);\n\tif (idx < 0) {\n\t\tnetdev_err(ctx->netdev, \"%s: sci %08llx not found in secy table\\n\",\n\t\t\t   __func__, sci_to_cpu(ctx->secy->sci));\n\t\treturn -ENOENT;\n\t}\n\n\tnetdev_dbg(ctx->netdev, \"%s: SECY with sci %08llx, AN %u\\n\",\n\t\t   __func__, sci_to_cpu(ctx->secy->sci), ctx->sa.assoc_num);\n\n\treturn 0;\n}\n\nstatic const struct macsec_ops nsim_macsec_ops = {\n\t.mdo_add_secy = nsim_macsec_add_secy,\n\t.mdo_upd_secy = nsim_macsec_upd_secy,\n\t.mdo_del_secy = nsim_macsec_del_secy,\n\t.mdo_add_rxsc = nsim_macsec_add_rxsc,\n\t.mdo_upd_rxsc = nsim_macsec_upd_rxsc,\n\t.mdo_del_rxsc = nsim_macsec_del_rxsc,\n\t.mdo_add_rxsa = nsim_macsec_add_rxsa,\n\t.mdo_upd_rxsa = nsim_macsec_upd_rxsa,\n\t.mdo_del_rxsa = nsim_macsec_del_rxsa,\n\t.mdo_add_txsa = nsim_macsec_add_txsa,\n\t.mdo_upd_txsa = nsim_macsec_upd_txsa,\n\t.mdo_del_txsa = nsim_macsec_del_txsa,\n};\n\nvoid nsim_macsec_init(struct netdevsim *ns)\n{\n\tns->netdev->macsec_ops = &nsim_macsec_ops;\n\tns->netdev->features |= NETIF_F_HW_MACSEC;\n\tmemset(&ns->macsec, 0, sizeof(ns->macsec));\n}\n\nvoid nsim_macsec_teardown(struct netdevsim *ns)\n{\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}