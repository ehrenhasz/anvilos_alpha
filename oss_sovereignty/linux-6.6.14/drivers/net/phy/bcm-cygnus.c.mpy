{
  "module_name": "bcm-cygnus.c",
  "hash_id": "2e042ea8eb9c24e3e2c9411d31610dbba83555fb2a38e50c8869490c1a5b5d95",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/bcm-cygnus.c",
  "human_readable_source": "\n \n\n \n#include \"bcm-phy-lib.h\"\n#include <linux/brcmphy.h>\n#include <linux/module.h>\n#include <linux/netdevice.h>\n#include <linux/phy.h>\n\nstruct bcm_omega_phy_priv {\n\tu64\t*stats;\n};\n\n \n#define MII_BCM_CYGNUS_AFE_VDAC_ICTRL_0  0x91E5  \n\nstatic int bcm_cygnus_afe_config(struct phy_device *phydev)\n{\n\tint rc;\n\n\t \n\trc = phy_write(phydev, MII_BCM54XX_AUX_CTL, 0x0c30);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = bcm_phy_write_misc(phydev, 0x39, 0x01, 0xA7C8);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = bcm_phy_write_misc(phydev, 0x3A, 0x00, 0x0803);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = bcm_phy_write_misc(phydev, 0x3A, 0x01, 0xA740);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = bcm_phy_write_misc(phydev, 0x3A, 0x03, 0x8400);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = bcm_phy_write_misc(phydev, 0x3B, 0x00, 0x0004);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = phy_write(phydev, MII_BRCM_CORE_BASE1E, 0x02);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = bcm_phy_write_exp_sel(phydev, MII_BRCM_CORE_EXPB1, 0x10);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = bcm_phy_write_exp_sel(phydev, MII_BRCM_CORE_EXPB0, 0x10);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = bcm_phy_write_exp_sel(phydev, MII_BRCM_CORE_EXPB0, 0x00);\n\n\treturn 0;\n}\n\nstatic int bcm_cygnus_config_init(struct phy_device *phydev)\n{\n\tint reg, rc;\n\n\treg = phy_read(phydev, MII_BCM54XX_ECR);\n\tif (reg < 0)\n\t\treturn reg;\n\n\t \n\treg |= MII_BCM54XX_ECR_IM;\n\trc = phy_write(phydev, MII_BCM54XX_ECR, reg);\n\tif (rc)\n\t\treturn rc;\n\n\t \n\treg = ~(MII_BCM54XX_INT_DUPLEX |\n\t\tMII_BCM54XX_INT_SPEED |\n\t\tMII_BCM54XX_INT_LINK);\n\trc = phy_write(phydev, MII_BCM54XX_IMR, reg);\n\tif (rc)\n\t\treturn rc;\n\n\t \n\trc = bcm_cygnus_afe_config(phydev);\n\tif (rc)\n\t\treturn rc;\n\n\t \n\trc = bcm_phy_set_eee(phydev, true);\n\tif (rc)\n\t\treturn rc;\n\n\t \n\treturn bcm_phy_enable_apd(phydev, false);\n}\n\nstatic int bcm_cygnus_resume(struct phy_device *phydev)\n{\n\tint rc;\n\n\tgenphy_resume(phydev);\n\n\t \n\trc = bcm_cygnus_config_init(phydev);\n\tif (rc)\n\t\treturn rc;\n\n\t \n\treturn genphy_config_aneg(phydev);\n}\n\nstatic int bcm_omega_config_init(struct phy_device *phydev)\n{\n\tu8 count, rev;\n\tint ret = 0;\n\n\trev = phydev->phy_id & ~phydev->drv->phy_id_mask;\n\n\tpr_info_once(\"%s: %s PHY revision: 0x%02x\\n\",\n\t\t     phydev_name(phydev), phydev->drv->name, rev);\n\n\t \n\tphy_read(phydev, MII_BMSR);\n\n\tswitch (rev) {\n\tcase 0x00:\n\t\tret = bcm_phy_28nm_a0b0_afe_config_init(phydev);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (ret)\n\t\treturn ret;\n\n\tret = bcm_phy_downshift_get(phydev, &count);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = bcm_phy_set_eee(phydev, count == DOWNSHIFT_DEV_DISABLE);\n\tif (ret)\n\t\treturn ret;\n\n\treturn bcm_phy_enable_apd(phydev, true);\n}\n\nstatic int bcm_omega_resume(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tret = bcm_omega_config_init(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\treturn genphy_config_aneg(phydev);\n}\n\nstatic int bcm_omega_get_tunable(struct phy_device *phydev,\n\t\t\t\t struct ethtool_tunable *tuna, void *data)\n{\n\tswitch (tuna->id) {\n\tcase ETHTOOL_PHY_DOWNSHIFT:\n\t\treturn bcm_phy_downshift_get(phydev, (u8 *)data);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int bcm_omega_set_tunable(struct phy_device *phydev,\n\t\t\t\t struct ethtool_tunable *tuna,\n\t\t\t\t const void *data)\n{\n\tu8 count = *(u8 *)data;\n\tint ret;\n\n\tswitch (tuna->id) {\n\tcase ETHTOOL_PHY_DOWNSHIFT:\n\t\tret = bcm_phy_downshift_set(phydev, count);\n\t\tbreak;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = bcm_phy_set_eee(phydev, count == DOWNSHIFT_DEV_DISABLE);\n\tif (ret)\n\t\treturn ret;\n\n\treturn genphy_restart_aneg(phydev);\n}\n\nstatic void bcm_omega_get_phy_stats(struct phy_device *phydev,\n\t\t\t\t    struct ethtool_stats *stats, u64 *data)\n{\n\tstruct bcm_omega_phy_priv *priv = phydev->priv;\n\n\tbcm_phy_get_stats(phydev, priv->stats, stats, data);\n}\n\nstatic int bcm_omega_probe(struct phy_device *phydev)\n{\n\tstruct bcm_omega_phy_priv *priv;\n\n\tpriv = devm_kzalloc(&phydev->mdio.dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tphydev->priv = priv;\n\n\tpriv->stats = devm_kcalloc(&phydev->mdio.dev,\n\t\t\t\t   bcm_phy_get_sset_count(phydev), sizeof(u64),\n\t\t\t\t   GFP_KERNEL);\n\tif (!priv->stats)\n\t\treturn -ENOMEM;\n\n\treturn 0;\n}\n\nstatic struct phy_driver bcm_cygnus_phy_driver[] = {\n{\n\t.phy_id        = PHY_ID_BCM_CYGNUS,\n\t.phy_id_mask   = 0xfffffff0,\n\t.name          = \"Broadcom Cygnus PHY\",\n\t \n\t.config_init   = bcm_cygnus_config_init,\n\t.config_intr   = bcm_phy_config_intr,\n\t.handle_interrupt = bcm_phy_handle_interrupt,\n\t.suspend       = genphy_suspend,\n\t.resume        = bcm_cygnus_resume,\n}, {\n\t.phy_id\t\t= PHY_ID_BCM_OMEGA,\n\t.phy_id_mask\t= 0xfffffff0,\n\t.name\t\t= \"Broadcom Omega Combo GPHY\",\n\t \n\t.flags\t\t= PHY_IS_INTERNAL,\n\t.config_init\t= bcm_omega_config_init,\n\t.suspend\t= genphy_suspend,\n\t.resume\t\t= bcm_omega_resume,\n\t.get_tunable\t= bcm_omega_get_tunable,\n\t.set_tunable\t= bcm_omega_set_tunable,\n\t.get_sset_count\t= bcm_phy_get_sset_count,\n\t.get_strings\t= bcm_phy_get_strings,\n\t.get_stats\t= bcm_omega_get_phy_stats,\n\t.probe\t\t= bcm_omega_probe,\n}\n};\n\nstatic struct mdio_device_id __maybe_unused bcm_cygnus_phy_tbl[] = {\n\t{ PHY_ID_BCM_CYGNUS, 0xfffffff0, },\n\t{ PHY_ID_BCM_OMEGA, 0xfffffff0, },\n\t{ }\n};\nMODULE_DEVICE_TABLE(mdio, bcm_cygnus_phy_tbl);\n\nmodule_phy_driver(bcm_cygnus_phy_driver);\n\nMODULE_DESCRIPTION(\"Broadcom Cygnus internal PHY driver\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Broadcom Corporation\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}