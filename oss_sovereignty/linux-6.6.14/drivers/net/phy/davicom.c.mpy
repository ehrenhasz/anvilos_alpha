{
  "module_name": "davicom.c",
  "hash_id": "4f07e09c1b293167748c3d5ac64017426115001f1e8bdf2ab87d431ec57ae347",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/davicom.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/errno.h>\n#include <linux/unistd.h>\n#include <linux/interrupt.h>\n#include <linux/init.h>\n#include <linux/delay.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n#include <linux/skbuff.h>\n#include <linux/spinlock.h>\n#include <linux/mm.h>\n#include <linux/module.h>\n#include <linux/mii.h>\n#include <linux/ethtool.h>\n#include <linux/phy.h>\n\n#include <asm/io.h>\n#include <asm/irq.h>\n#include <linux/uaccess.h>\n\n#define MII_DM9161_SCR\t\t0x10\n#define MII_DM9161_SCR_INIT\t0x0610\n#define MII_DM9161_SCR_RMII\t0x0100\n\n \n#define MII_DM9161_INTR\t0x15\n#define MII_DM9161_INTR_PEND\t\t0x8000\n#define MII_DM9161_INTR_DPLX_MASK\t0x0800\n#define MII_DM9161_INTR_SPD_MASK\t0x0400\n#define MII_DM9161_INTR_LINK_MASK\t0x0200\n#define MII_DM9161_INTR_MASK\t\t0x0100\n#define MII_DM9161_INTR_DPLX_CHANGE\t0x0010\n#define MII_DM9161_INTR_SPD_CHANGE\t0x0008\n#define MII_DM9161_INTR_LINK_CHANGE\t0x0004\n#define MII_DM9161_INTR_INIT\t\t0x0000\n#define MII_DM9161_INTR_STOP\t\\\n\t(MII_DM9161_INTR_DPLX_MASK | MII_DM9161_INTR_SPD_MASK |\t\\\n\t MII_DM9161_INTR_LINK_MASK | MII_DM9161_INTR_MASK)\n#define MII_DM9161_INTR_CHANGE\t\\\n\t(MII_DM9161_INTR_DPLX_CHANGE | \\\n\t MII_DM9161_INTR_SPD_CHANGE | \\\n\t MII_DM9161_INTR_LINK_CHANGE)\n\n \n#define MII_DM9161_10BTCSR\t0x12\n#define MII_DM9161_10BTCSR_INIT\t0x7800\n\nMODULE_DESCRIPTION(\"Davicom PHY driver\");\nMODULE_AUTHOR(\"Andy Fleming\");\nMODULE_LICENSE(\"GPL\");\n\n\nstatic int dm9161_ack_interrupt(struct phy_device *phydev)\n{\n\tint err = phy_read(phydev, MII_DM9161_INTR);\n\n\treturn (err < 0) ? err : 0;\n}\n\n#define DM9161_DELAY 1\nstatic int dm9161_config_intr(struct phy_device *phydev)\n{\n\tint temp, err;\n\n\ttemp = phy_read(phydev, MII_DM9161_INTR);\n\n\tif (temp < 0)\n\t\treturn temp;\n\n\tif (phydev->interrupts == PHY_INTERRUPT_ENABLED) {\n\t\terr = dm9161_ack_interrupt(phydev);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\ttemp &= ~(MII_DM9161_INTR_STOP);\n\t\terr = phy_write(phydev, MII_DM9161_INTR, temp);\n\t} else {\n\t\ttemp |= MII_DM9161_INTR_STOP;\n\t\terr = phy_write(phydev, MII_DM9161_INTR, temp);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = dm9161_ack_interrupt(phydev);\n\t}\n\n\treturn err;\n}\n\nstatic irqreturn_t dm9161_handle_interrupt(struct phy_device *phydev)\n{\n\tint irq_status;\n\n\tirq_status = phy_read(phydev, MII_DM9161_INTR);\n\tif (irq_status < 0) {\n\t\tphy_error(phydev);\n\t\treturn IRQ_NONE;\n\t}\n\n\tif (!(irq_status & MII_DM9161_INTR_CHANGE))\n\t\treturn IRQ_NONE;\n\n\tphy_trigger_machine(phydev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int dm9161_config_aneg(struct phy_device *phydev)\n{\n\tint err;\n\n\t \n\terr = phy_write(phydev, MII_BMCR, BMCR_ISOLATE);\n\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\terr = genphy_config_aneg(phydev);\n\n\tif (err < 0)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic int dm9161_config_init(struct phy_device *phydev)\n{\n\tint err, temp;\n\n\t \n\terr = phy_write(phydev, MII_BMCR, BMCR_ISOLATE);\n\n\tif (err < 0)\n\t\treturn err;\n\n\tswitch (phydev->interface) {\n\tcase PHY_INTERFACE_MODE_MII:\n\t\ttemp = MII_DM9161_SCR_INIT;\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_RMII:\n\t\ttemp =  MII_DM9161_SCR_INIT | MII_DM9161_SCR_RMII;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\t \n\terr = phy_write(phydev, MII_DM9161_SCR, temp);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\terr = phy_write(phydev, MII_DM9161_10BTCSR, MII_DM9161_10BTCSR_INIT);\n\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\treturn phy_write(phydev, MII_BMCR, BMCR_ANENABLE);\n}\n\nstatic struct phy_driver dm91xx_driver[] = {\n{\n\t.phy_id\t\t= 0x0181b880,\n\t.name\t\t= \"Davicom DM9161E\",\n\t.phy_id_mask\t= 0x0ffffff0,\n\t \n\t.config_init\t= dm9161_config_init,\n\t.config_aneg\t= dm9161_config_aneg,\n\t.config_intr\t= dm9161_config_intr,\n\t.handle_interrupt = dm9161_handle_interrupt,\n}, {\n\t.phy_id\t\t= 0x0181b8b0,\n\t.name\t\t= \"Davicom DM9161B/C\",\n\t.phy_id_mask\t= 0x0ffffff0,\n\t \n\t.config_init\t= dm9161_config_init,\n\t.config_aneg\t= dm9161_config_aneg,\n\t.config_intr\t= dm9161_config_intr,\n\t.handle_interrupt = dm9161_handle_interrupt,\n}, {\n\t.phy_id\t\t= 0x0181b8a0,\n\t.name\t\t= \"Davicom DM9161A\",\n\t.phy_id_mask\t= 0x0ffffff0,\n\t \n\t.config_init\t= dm9161_config_init,\n\t.config_aneg\t= dm9161_config_aneg,\n\t.config_intr\t= dm9161_config_intr,\n\t.handle_interrupt = dm9161_handle_interrupt,\n}, {\n\t.phy_id\t\t= 0x00181b80,\n\t.name\t\t= \"Davicom DM9131\",\n\t.phy_id_mask\t= 0x0ffffff0,\n\t \n\t.config_intr\t= dm9161_config_intr,\n\t.handle_interrupt = dm9161_handle_interrupt,\n} };\n\nmodule_phy_driver(dm91xx_driver);\n\nstatic struct mdio_device_id __maybe_unused davicom_tbl[] = {\n\t{ 0x0181b880, 0x0ffffff0 },\n\t{ 0x0181b8b0, 0x0ffffff0 },\n\t{ 0x0181b8a0, 0x0ffffff0 },\n\t{ 0x00181b80, 0x0ffffff0 },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(mdio, davicom_tbl);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}