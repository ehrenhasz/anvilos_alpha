{
  "module_name": "lxt.c",
  "hash_id": "b739bf9c8bb26310685c2791b8c1b3c9d4362ddd209e367649ec8f9d4c605d82",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/lxt.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/errno.h>\n#include <linux/unistd.h>\n#include <linux/interrupt.h>\n#include <linux/init.h>\n#include <linux/delay.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n#include <linux/skbuff.h>\n#include <linux/spinlock.h>\n#include <linux/mm.h>\n#include <linux/module.h>\n#include <linux/mii.h>\n#include <linux/ethtool.h>\n#include <linux/phy.h>\n\n#include <asm/io.h>\n#include <asm/irq.h>\n#include <linux/uaccess.h>\n\n \n\n#define MII_LXT970_IER       17   \n\n#define MII_LXT970_IER_IEN\t0x0002\n\n#define MII_LXT970_ISR       18   \n\n#define MII_LXT970_IRS_MINT  BIT(15)\n\n#define MII_LXT970_CONFIG    19   \n\n \n \n\n \n#define MII_LXT971_IER\t\t18   \n#define MII_LXT971_IER_IEN\t0x00f2\n\n#define MII_LXT971_ISR\t\t19   \n#define MII_LXT971_ISR_MASK\t0x00f0\n\n \n#define MII_LXT973_PCR 16  \n#define PCR_FIBER_SELECT 1\n\nMODULE_DESCRIPTION(\"Intel LXT PHY driver\");\nMODULE_AUTHOR(\"Andy Fleming\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int lxt970_ack_interrupt(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = phy_read(phydev, MII_BMSR);\n\n\tif (err < 0)\n\t\treturn err;\n\n\terr = phy_read(phydev, MII_LXT970_ISR);\n\n\tif (err < 0)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic int lxt970_config_intr(struct phy_device *phydev)\n{\n\tint err;\n\n\tif (phydev->interrupts == PHY_INTERRUPT_ENABLED) {\n\t\terr = lxt970_ack_interrupt(phydev);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = phy_write(phydev, MII_LXT970_IER, MII_LXT970_IER_IEN);\n\t} else {\n\t\terr = phy_write(phydev, MII_LXT970_IER, 0);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = lxt970_ack_interrupt(phydev);\n\t}\n\n\treturn err;\n}\n\nstatic irqreturn_t lxt970_handle_interrupt(struct phy_device *phydev)\n{\n\tint irq_status;\n\n\t \n\tirq_status = phy_read(phydev, MII_BMSR);\n\tif (irq_status < 0) {\n\t\tphy_error(phydev);\n\t\treturn IRQ_NONE;\n\t}\n\n\tirq_status = phy_read(phydev, MII_LXT970_ISR);\n\tif (irq_status < 0) {\n\t\tphy_error(phydev);\n\t\treturn IRQ_NONE;\n\t}\n\n\tif (!(irq_status & MII_LXT970_IRS_MINT))\n\t\treturn IRQ_NONE;\n\n\tphy_trigger_machine(phydev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int lxt970_config_init(struct phy_device *phydev)\n{\n\treturn phy_write(phydev, MII_LXT970_CONFIG, 0);\n}\n\n\nstatic int lxt971_ack_interrupt(struct phy_device *phydev)\n{\n\tint err = phy_read(phydev, MII_LXT971_ISR);\n\n\tif (err < 0)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic int lxt971_config_intr(struct phy_device *phydev)\n{\n\tint err;\n\n\tif (phydev->interrupts == PHY_INTERRUPT_ENABLED) {\n\t\terr = lxt971_ack_interrupt(phydev);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = phy_write(phydev, MII_LXT971_IER, MII_LXT971_IER_IEN);\n\t} else {\n\t\terr = phy_write(phydev, MII_LXT971_IER, 0);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = lxt971_ack_interrupt(phydev);\n\t}\n\n\treturn err;\n}\n\nstatic irqreturn_t lxt971_handle_interrupt(struct phy_device *phydev)\n{\n\tint irq_status;\n\n\tirq_status = phy_read(phydev, MII_LXT971_ISR);\n\tif (irq_status < 0) {\n\t\tphy_error(phydev);\n\t\treturn IRQ_NONE;\n\t}\n\n\tif (!(irq_status & MII_LXT971_ISR_MASK))\n\t\treturn IRQ_NONE;\n\n\tphy_trigger_machine(phydev);\n\n\treturn IRQ_HANDLED;\n}\n\n \n\nstatic int lxt973a2_update_link(struct phy_device *phydev)\n{\n\tint status;\n\tint control;\n\tint retry = 8;  \n\n\t \n\tstatus = phy_read(phydev, MII_BMSR);\n\n\tif (status < 0)\n\t\treturn status;\n\n\tcontrol = phy_read(phydev, MII_BMCR);\n\tif (control < 0)\n\t\treturn control;\n\n\tdo {\n\t\t \n\t\tstatus = phy_read(phydev, MII_BMSR);\n\t} while (status >= 0 && retry-- && status == control);\n\n\tif (status < 0)\n\t\treturn status;\n\n\tif ((status & BMSR_LSTATUS) == 0)\n\t\tphydev->link = 0;\n\telse\n\t\tphydev->link = 1;\n\n\treturn 0;\n}\n\nstatic int lxt973a2_read_status(struct phy_device *phydev)\n{\n\tint adv;\n\tint err;\n\tint lpa;\n\n\t \n\terr = lxt973a2_update_link(phydev);\n\tif (err)\n\t\treturn err;\n\n\tif (AUTONEG_ENABLE == phydev->autoneg) {\n\t\tint retry = 1;\n\n\t\tadv = phy_read(phydev, MII_ADVERTISE);\n\n\t\tif (adv < 0)\n\t\t\treturn adv;\n\n\t\tdo {\n\t\t\tlpa = phy_read(phydev, MII_LPA);\n\n\t\t\tif (lpa < 0)\n\t\t\t\treturn lpa;\n\n\t\t\t \n\t\t} while (lpa == adv && retry--);\n\n\t\tmii_lpa_to_linkmode_lpa_t(phydev->lp_advertising, lpa);\n\n\t\tlpa &= adv;\n\n\t\tphydev->speed = SPEED_10;\n\t\tphydev->duplex = DUPLEX_HALF;\n\t\tphydev->pause = phydev->asym_pause = 0;\n\n\t\tif (lpa & (LPA_100FULL | LPA_100HALF)) {\n\t\t\tphydev->speed = SPEED_100;\n\n\t\t\tif (lpa & LPA_100FULL)\n\t\t\t\tphydev->duplex = DUPLEX_FULL;\n\t\t} else {\n\t\t\tif (lpa & LPA_10FULL)\n\t\t\t\tphydev->duplex = DUPLEX_FULL;\n\t\t}\n\n\t\tphy_resolve_aneg_pause(phydev);\n\t} else {\n\t\terr = genphy_read_status_fixed(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\tphydev->pause = phydev->asym_pause = 0;\n\t\tlinkmode_zero(phydev->lp_advertising);\n\t}\n\n\treturn 0;\n}\n\nstatic int lxt973_probe(struct phy_device *phydev)\n{\n\tint val = phy_read(phydev, MII_LXT973_PCR);\n\n\tif (val & PCR_FIBER_SELECT) {\n\t\t \n\t\tval = phy_read(phydev, MII_BMCR);\n\t\tval |= (BMCR_SPEED100 | BMCR_FULLDPLX);\n\t\tval &= ~BMCR_ANENABLE;\n\t\tphy_write(phydev, MII_BMCR, val);\n\t\t \n\t\tphydev->priv = lxt973_probe;\n\t\tphydev->port = PORT_FIBRE;\n\t} else {\n\t\tphydev->priv = NULL;\n\t}\n\treturn 0;\n}\n\nstatic int lxt973_config_aneg(struct phy_device *phydev)\n{\n\t \n\treturn phydev->priv ? 0 : genphy_config_aneg(phydev);\n}\n\nstatic struct phy_driver lxt97x_driver[] = {\n{\n\t.phy_id\t\t= 0x78100000,\n\t.name\t\t= \"LXT970\",\n\t.phy_id_mask\t= 0xfffffff0,\n\t \n\t.config_init\t= lxt970_config_init,\n\t.config_intr\t= lxt970_config_intr,\n\t.handle_interrupt = lxt970_handle_interrupt,\n}, {\n\t.phy_id\t\t= 0x001378e0,\n\t.name\t\t= \"LXT971\",\n\t.phy_id_mask\t= 0xfffffff0,\n\t \n\t.config_intr\t= lxt971_config_intr,\n\t.handle_interrupt = lxt971_handle_interrupt,\n\t.suspend\t= genphy_suspend,\n\t.resume\t\t= genphy_resume,\n}, {\n\t.phy_id\t\t= 0x00137a10,\n\t.name\t\t= \"LXT973-A2\",\n\t.phy_id_mask\t= 0xffffffff,\n\t \n\t.flags\t\t= 0,\n\t.probe\t\t= lxt973_probe,\n\t.config_aneg\t= lxt973_config_aneg,\n\t.read_status\t= lxt973a2_read_status,\n\t.suspend\t= genphy_suspend,\n\t.resume\t\t= genphy_resume,\n}, {\n\t.phy_id\t\t= 0x00137a10,\n\t.name\t\t= \"LXT973\",\n\t.phy_id_mask\t= 0xfffffff0,\n\t \n\t.flags\t\t= 0,\n\t.probe\t\t= lxt973_probe,\n\t.config_aneg\t= lxt973_config_aneg,\n\t.suspend\t= genphy_suspend,\n\t.resume\t\t= genphy_resume,\n} };\n\nmodule_phy_driver(lxt97x_driver);\n\nstatic struct mdio_device_id __maybe_unused lxt_tbl[] = {\n\t{ 0x78100000, 0xfffffff0 },\n\t{ 0x001378e0, 0xfffffff0 },\n\t{ 0x00137a10, 0xfffffff0 },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(mdio, lxt_tbl);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}