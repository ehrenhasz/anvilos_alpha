{
  "module_name": "mediatek-ge-soc.c",
  "hash_id": "b64022cbaed46d64b0dead6bc047494609de7ddd95d99fadc5ce4bd73106f193",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/mediatek-ge-soc.c",
  "human_readable_source": "\n#include <linux/bitfield.h>\n#include <linux/bitmap.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/nvmem-consumer.h>\n#include <linux/pinctrl/consumer.h>\n#include <linux/phy.h>\n#include <linux/regmap.h>\n\n#define MTK_GPHY_ID_MT7981\t\t\t0x03a29461\n#define MTK_GPHY_ID_MT7988\t\t\t0x03a29481\n\n#define MTK_EXT_PAGE_ACCESS\t\t\t0x1f\n#define MTK_PHY_PAGE_STANDARD\t\t\t0x0000\n#define MTK_PHY_PAGE_EXTENDED_3\t\t\t0x0003\n\n#define MTK_PHY_LPI_REG_14\t\t\t0x14\n#define MTK_PHY_LPI_WAKE_TIMER_1000_MASK\tGENMASK(8, 0)\n\n#define MTK_PHY_LPI_REG_1c\t\t\t0x1c\n#define MTK_PHY_SMI_DET_ON_THRESH_MASK\t\tGENMASK(13, 8)\n\n#define MTK_PHY_PAGE_EXTENDED_2A30\t\t0x2a30\n#define MTK_PHY_PAGE_EXTENDED_52B5\t\t0x52b5\n\n#define ANALOG_INTERNAL_OPERATION_MAX_US\t20\n#define TXRESERVE_MIN\t\t\t\t0\n#define TXRESERVE_MAX\t\t\t\t7\n\n#define MTK_PHY_ANARG_RG\t\t\t0x10\n#define   MTK_PHY_TCLKOFFSET_MASK\t\tGENMASK(12, 8)\n\n \n#define MTK_PHY_TXVLD_DA_RG\t\t\t0x12\n#define   MTK_PHY_DA_TX_I2MPB_A_GBE_MASK\tGENMASK(15, 10)\n#define   MTK_PHY_DA_TX_I2MPB_A_TBT_MASK\tGENMASK(5, 0)\n\n#define MTK_PHY_TX_I2MPB_TEST_MODE_A2\t\t0x16\n#define   MTK_PHY_DA_TX_I2MPB_A_HBT_MASK\tGENMASK(15, 10)\n#define   MTK_PHY_DA_TX_I2MPB_A_TST_MASK\tGENMASK(5, 0)\n\n#define MTK_PHY_TX_I2MPB_TEST_MODE_B1\t\t0x17\n#define   MTK_PHY_DA_TX_I2MPB_B_GBE_MASK\tGENMASK(13, 8)\n#define   MTK_PHY_DA_TX_I2MPB_B_TBT_MASK\tGENMASK(5, 0)\n\n#define MTK_PHY_TX_I2MPB_TEST_MODE_B2\t\t0x18\n#define   MTK_PHY_DA_TX_I2MPB_B_HBT_MASK\tGENMASK(13, 8)\n#define   MTK_PHY_DA_TX_I2MPB_B_TST_MASK\tGENMASK(5, 0)\n\n#define MTK_PHY_TX_I2MPB_TEST_MODE_C1\t\t0x19\n#define   MTK_PHY_DA_TX_I2MPB_C_GBE_MASK\tGENMASK(13, 8)\n#define   MTK_PHY_DA_TX_I2MPB_C_TBT_MASK\tGENMASK(5, 0)\n\n#define MTK_PHY_TX_I2MPB_TEST_MODE_C2\t\t0x20\n#define   MTK_PHY_DA_TX_I2MPB_C_HBT_MASK\tGENMASK(13, 8)\n#define   MTK_PHY_DA_TX_I2MPB_C_TST_MASK\tGENMASK(5, 0)\n\n#define MTK_PHY_TX_I2MPB_TEST_MODE_D1\t\t0x21\n#define   MTK_PHY_DA_TX_I2MPB_D_GBE_MASK\tGENMASK(13, 8)\n#define   MTK_PHY_DA_TX_I2MPB_D_TBT_MASK\tGENMASK(5, 0)\n\n#define MTK_PHY_TX_I2MPB_TEST_MODE_D2\t\t0x22\n#define   MTK_PHY_DA_TX_I2MPB_D_HBT_MASK\tGENMASK(13, 8)\n#define   MTK_PHY_DA_TX_I2MPB_D_TST_MASK\tGENMASK(5, 0)\n\n#define MTK_PHY_RXADC_CTRL_RG7\t\t\t0xc6\n#define   MTK_PHY_DA_AD_BUF_BIAS_LP_MASK\tGENMASK(9, 8)\n\n#define MTK_PHY_RXADC_CTRL_RG9\t\t\t0xc8\n#define   MTK_PHY_DA_RX_PSBN_TBT_MASK\t\tGENMASK(14, 12)\n#define   MTK_PHY_DA_RX_PSBN_HBT_MASK\t\tGENMASK(10, 8)\n#define   MTK_PHY_DA_RX_PSBN_GBE_MASK\t\tGENMASK(6, 4)\n#define   MTK_PHY_DA_RX_PSBN_LP_MASK\t\tGENMASK(2, 0)\n\n#define MTK_PHY_LDO_OUTPUT_V\t\t\t0xd7\n\n#define MTK_PHY_RG_ANA_CAL_RG0\t\t\t0xdb\n#define   MTK_PHY_RG_CAL_CKINV\t\t\tBIT(12)\n#define   MTK_PHY_RG_ANA_CALEN\t\t\tBIT(8)\n#define   MTK_PHY_RG_ZCALEN_A\t\t\tBIT(0)\n\n#define MTK_PHY_RG_ANA_CAL_RG1\t\t\t0xdc\n#define   MTK_PHY_RG_ZCALEN_B\t\t\tBIT(12)\n#define   MTK_PHY_RG_ZCALEN_C\t\t\tBIT(8)\n#define   MTK_PHY_RG_ZCALEN_D\t\t\tBIT(4)\n#define   MTK_PHY_RG_TXVOS_CALEN\t\tBIT(0)\n\n#define MTK_PHY_RG_ANA_CAL_RG5\t\t\t0xe0\n#define   MTK_PHY_RG_REXT_TRIM_MASK\t\tGENMASK(13, 8)\n\n#define MTK_PHY_RG_TX_FILTER\t\t\t0xfe\n\n#define MTK_PHY_RG_LPI_PCS_DSP_CTRL_REG120\t0x120\n#define   MTK_PHY_LPI_SIG_EN_LO_THRESH1000_MASK\tGENMASK(12, 8)\n#define   MTK_PHY_LPI_SIG_EN_HI_THRESH1000_MASK\tGENMASK(4, 0)\n\n#define MTK_PHY_RG_LPI_PCS_DSP_CTRL_REG122\t0x122\n#define   MTK_PHY_LPI_NORM_MSE_HI_THRESH1000_MASK\tGENMASK(7, 0)\n\n#define MTK_PHY_RG_TESTMUX_ADC_CTRL\t\t0x144\n#define   MTK_PHY_RG_TXEN_DIG_MASK\t\tGENMASK(5, 5)\n\n#define MTK_PHY_RG_CR_TX_AMP_OFFSET_A_B\t\t0x172\n#define   MTK_PHY_CR_TX_AMP_OFFSET_A_MASK\tGENMASK(13, 8)\n#define   MTK_PHY_CR_TX_AMP_OFFSET_B_MASK\tGENMASK(6, 0)\n\n#define MTK_PHY_RG_CR_TX_AMP_OFFSET_C_D\t\t0x173\n#define   MTK_PHY_CR_TX_AMP_OFFSET_C_MASK\tGENMASK(13, 8)\n#define   MTK_PHY_CR_TX_AMP_OFFSET_D_MASK\tGENMASK(6, 0)\n\n#define MTK_PHY_RG_AD_CAL_COMP\t\t\t0x17a\n#define   MTK_PHY_AD_CAL_COMP_OUT_SHIFT\t\t(8)\n\n#define MTK_PHY_RG_AD_CAL_CLK\t\t\t0x17b\n#define   MTK_PHY_DA_CAL_CLK\t\t\tBIT(0)\n\n#define MTK_PHY_RG_AD_CALIN\t\t\t0x17c\n#define   MTK_PHY_DA_CALIN_FLAG\t\t\tBIT(0)\n\n#define MTK_PHY_RG_DASN_DAC_IN0_A\t\t0x17d\n#define   MTK_PHY_DASN_DAC_IN0_A_MASK\t\tGENMASK(9, 0)\n\n#define MTK_PHY_RG_DASN_DAC_IN0_B\t\t0x17e\n#define   MTK_PHY_DASN_DAC_IN0_B_MASK\t\tGENMASK(9, 0)\n\n#define MTK_PHY_RG_DASN_DAC_IN0_C\t\t0x17f\n#define   MTK_PHY_DASN_DAC_IN0_C_MASK\t\tGENMASK(9, 0)\n\n#define MTK_PHY_RG_DASN_DAC_IN0_D\t\t0x180\n#define   MTK_PHY_DASN_DAC_IN0_D_MASK\t\tGENMASK(9, 0)\n\n#define MTK_PHY_RG_DASN_DAC_IN1_A\t\t0x181\n#define   MTK_PHY_DASN_DAC_IN1_A_MASK\t\tGENMASK(9, 0)\n\n#define MTK_PHY_RG_DASN_DAC_IN1_B\t\t0x182\n#define   MTK_PHY_DASN_DAC_IN1_B_MASK\t\tGENMASK(9, 0)\n\n#define MTK_PHY_RG_DASN_DAC_IN1_C\t\t0x183\n#define   MTK_PHY_DASN_DAC_IN1_C_MASK\t\tGENMASK(9, 0)\n\n#define MTK_PHY_RG_DASN_DAC_IN1_D\t\t0x184\n#define   MTK_PHY_DASN_DAC_IN1_D_MASK\t\tGENMASK(9, 0)\n\n#define MTK_PHY_RG_DEV1E_REG19b\t\t\t0x19b\n#define   MTK_PHY_BYPASS_DSP_LPI_READY\t\tBIT(8)\n\n#define MTK_PHY_RG_LP_IIR2_K1_L\t\t\t0x22a\n#define MTK_PHY_RG_LP_IIR2_K1_U\t\t\t0x22b\n#define MTK_PHY_RG_LP_IIR2_K2_L\t\t\t0x22c\n#define MTK_PHY_RG_LP_IIR2_K2_U\t\t\t0x22d\n#define MTK_PHY_RG_LP_IIR2_K3_L\t\t\t0x22e\n#define MTK_PHY_RG_LP_IIR2_K3_U\t\t\t0x22f\n#define MTK_PHY_RG_LP_IIR2_K4_L\t\t\t0x230\n#define MTK_PHY_RG_LP_IIR2_K4_U\t\t\t0x231\n#define MTK_PHY_RG_LP_IIR2_K5_L\t\t\t0x232\n#define MTK_PHY_RG_LP_IIR2_K5_U\t\t\t0x233\n\n#define MTK_PHY_RG_DEV1E_REG234\t\t\t0x234\n#define   MTK_PHY_TR_OPEN_LOOP_EN_MASK\t\tGENMASK(0, 0)\n#define   MTK_PHY_LPF_X_AVERAGE_MASK\t\tGENMASK(7, 4)\n#define   MTK_PHY_TR_LP_IIR_EEE_EN\t\tBIT(12)\n\n#define MTK_PHY_RG_LPF_CNT_VAL\t\t\t0x235\n\n#define MTK_PHY_RG_DEV1E_REG238\t\t\t0x238\n#define   MTK_PHY_LPI_SLV_SEND_TX_TIMER_MASK\tGENMASK(8, 0)\n#define   MTK_PHY_LPI_SLV_SEND_TX_EN\t\tBIT(12)\n\n#define MTK_PHY_RG_DEV1E_REG239\t\t\t0x239\n#define   MTK_PHY_LPI_SEND_LOC_TIMER_MASK\tGENMASK(8, 0)\n#define   MTK_PHY_LPI_TXPCS_LOC_RCV\t\tBIT(12)\n\n#define MTK_PHY_RG_DEV1E_REG27C\t\t\t0x27c\n#define   MTK_PHY_VGASTATE_FFE_THR_ST1_MASK\tGENMASK(12, 8)\n#define MTK_PHY_RG_DEV1E_REG27D\t\t\t0x27d\n#define   MTK_PHY_VGASTATE_FFE_THR_ST2_MASK\tGENMASK(4, 0)\n\n#define MTK_PHY_RG_DEV1E_REG2C7\t\t\t0x2c7\n#define   MTK_PHY_MAX_GAIN_MASK\t\t\tGENMASK(4, 0)\n#define   MTK_PHY_MIN_GAIN_MASK\t\t\tGENMASK(12, 8)\n\n#define MTK_PHY_RG_DEV1E_REG2D1\t\t\t0x2d1\n#define   MTK_PHY_VCO_SLICER_THRESH_BITS_HIGH_EEE_MASK\tGENMASK(7, 0)\n#define   MTK_PHY_LPI_SKIP_SD_SLV_TR\t\tBIT(8)\n#define   MTK_PHY_LPI_TR_READY\t\t\tBIT(9)\n#define   MTK_PHY_LPI_VCO_EEE_STG0_EN\t\tBIT(10)\n\n#define MTK_PHY_RG_DEV1E_REG323\t\t\t0x323\n#define   MTK_PHY_EEE_WAKE_MAS_INT_DC\t\tBIT(0)\n#define   MTK_PHY_EEE_WAKE_SLV_INT_DC\t\tBIT(4)\n\n#define MTK_PHY_RG_DEV1E_REG324\t\t\t0x324\n#define   MTK_PHY_SMI_DETCNT_MAX_MASK\t\tGENMASK(5, 0)\n#define   MTK_PHY_SMI_DET_MAX_EN\t\tBIT(8)\n\n#define MTK_PHY_RG_DEV1E_REG326\t\t\t0x326\n#define   MTK_PHY_LPI_MODE_SD_ON\t\tBIT(0)\n#define   MTK_PHY_RESET_RANDUPD_CNT\t\tBIT(1)\n#define   MTK_PHY_TREC_UPDATE_ENAB_CLR\t\tBIT(2)\n#define   MTK_PHY_LPI_QUIT_WAIT_DFE_SIG_DET_OFF\tBIT(4)\n#define   MTK_PHY_TR_READY_SKIP_AFE_WAKEUP\tBIT(5)\n\n#define MTK_PHY_LDO_PUMP_EN_PAIRAB\t\t0x502\n#define MTK_PHY_LDO_PUMP_EN_PAIRCD\t\t0x503\n\n#define MTK_PHY_DA_TX_R50_PAIR_A\t\t0x53d\n#define MTK_PHY_DA_TX_R50_PAIR_B\t\t0x53e\n#define MTK_PHY_DA_TX_R50_PAIR_C\t\t0x53f\n#define MTK_PHY_DA_TX_R50_PAIR_D\t\t0x540\n\n \n#define MTK_PHY_LED0_ON_CTRL\t\t\t0x24\n#define MTK_PHY_LED1_ON_CTRL\t\t\t0x26\n#define   MTK_PHY_LED_ON_MASK\t\t\tGENMASK(6, 0)\n#define   MTK_PHY_LED_ON_LINK1000\t\tBIT(0)\n#define   MTK_PHY_LED_ON_LINK100\t\tBIT(1)\n#define   MTK_PHY_LED_ON_LINK10\t\t\tBIT(2)\n#define   MTK_PHY_LED_ON_LINKDOWN\t\tBIT(3)\n#define   MTK_PHY_LED_ON_FDX\t\t\tBIT(4)  \n#define   MTK_PHY_LED_ON_HDX\t\t\tBIT(5)  \n#define   MTK_PHY_LED_ON_FORCE_ON\t\tBIT(6)\n#define   MTK_PHY_LED_ON_POLARITY\t\tBIT(14)\n#define   MTK_PHY_LED_ON_ENABLE\t\t\tBIT(15)\n\n#define MTK_PHY_LED0_BLINK_CTRL\t\t\t0x25\n#define MTK_PHY_LED1_BLINK_CTRL\t\t\t0x27\n#define   MTK_PHY_LED_BLINK_1000TX\t\tBIT(0)\n#define   MTK_PHY_LED_BLINK_1000RX\t\tBIT(1)\n#define   MTK_PHY_LED_BLINK_100TX\t\tBIT(2)\n#define   MTK_PHY_LED_BLINK_100RX\t\tBIT(3)\n#define   MTK_PHY_LED_BLINK_10TX\t\tBIT(4)\n#define   MTK_PHY_LED_BLINK_10RX\t\tBIT(5)\n#define   MTK_PHY_LED_BLINK_COLLISION\t\tBIT(6)\n#define   MTK_PHY_LED_BLINK_RX_CRC_ERR\t\tBIT(7)\n#define   MTK_PHY_LED_BLINK_RX_IDLE_ERR\t\tBIT(8)\n#define   MTK_PHY_LED_BLINK_FORCE_BLINK\t\tBIT(9)\n\n#define MTK_PHY_LED1_DEFAULT_POLARITIES\t\tBIT(1)\n\n#define MTK_PHY_RG_BG_RASEL\t\t\t0x115\n#define   MTK_PHY_RG_BG_RASEL_MASK\t\tGENMASK(2, 0)\n\n \n#define RG_GPIO_MISC_TPBANK0\t\t\t0x6f0\n#define   RG_GPIO_MISC_TPBANK0_BOOTMODE\t\tGENMASK(11, 8)\n\n \n#define EFS_DA_TX_I2MPB_A(x)\t\t\t(((x) >> 0) & GENMASK(5, 0))\n#define EFS_DA_TX_I2MPB_B(x)\t\t\t(((x) >> 6) & GENMASK(5, 0))\n#define EFS_DA_TX_I2MPB_C(x)\t\t\t(((x) >> 12) & GENMASK(5, 0))\n#define EFS_DA_TX_I2MPB_D(x)\t\t\t(((x) >> 18) & GENMASK(5, 0))\n#define EFS_DA_TX_AMP_OFFSET_A(x)\t\t(((x) >> 24) & GENMASK(5, 0))\n\n#define EFS_DA_TX_AMP_OFFSET_B(x)\t\t(((x) >> 0) & GENMASK(5, 0))\n#define EFS_DA_TX_AMP_OFFSET_C(x)\t\t(((x) >> 6) & GENMASK(5, 0))\n#define EFS_DA_TX_AMP_OFFSET_D(x)\t\t(((x) >> 12) & GENMASK(5, 0))\n#define EFS_DA_TX_R50_A(x)\t\t\t(((x) >> 18) & GENMASK(5, 0))\n#define EFS_DA_TX_R50_B(x)\t\t\t(((x) >> 24) & GENMASK(5, 0))\n\n#define EFS_DA_TX_R50_C(x)\t\t\t(((x) >> 0) & GENMASK(5, 0))\n#define EFS_DA_TX_R50_D(x)\t\t\t(((x) >> 6) & GENMASK(5, 0))\n\n#define EFS_RG_BG_RASEL(x)\t\t\t(((x) >> 4) & GENMASK(2, 0))\n#define EFS_RG_REXT_TRIM(x)\t\t\t(((x) >> 7) & GENMASK(5, 0))\n\nenum {\n\tNO_PAIR,\n\tPAIR_A,\n\tPAIR_B,\n\tPAIR_C,\n\tPAIR_D,\n};\n\nenum calibration_mode {\n\tEFUSE_K,\n\tSW_K\n};\n\nenum CAL_ITEM {\n\tREXT,\n\tTX_OFFSET,\n\tTX_AMP,\n\tTX_R50,\n\tTX_VCM\n};\n\nenum CAL_MODE {\n\tEFUSE_M,\n\tSW_M\n};\n\n#define MTK_PHY_LED_STATE_FORCE_ON\t0\n#define MTK_PHY_LED_STATE_FORCE_BLINK\t1\n#define MTK_PHY_LED_STATE_NETDEV\t2\n\nstruct mtk_socphy_priv {\n\tunsigned long\t\tled_state;\n};\n\nstruct mtk_socphy_shared {\n\tu32\t\t\tboottrap;\n\tstruct mtk_socphy_priv\tpriv[4];\n};\n\nstatic int mtk_socphy_read_page(struct phy_device *phydev)\n{\n\treturn __phy_read(phydev, MTK_EXT_PAGE_ACCESS);\n}\n\nstatic int mtk_socphy_write_page(struct phy_device *phydev, int page)\n{\n\treturn __phy_write(phydev, MTK_EXT_PAGE_ACCESS, page);\n}\n\n \nstatic int cal_cycle(struct phy_device *phydev, int devad,\n\t\t     u32 regnum, u16 mask, u16 cal_val)\n{\n\tint reg_val;\n\tint ret;\n\n\tphy_modify_mmd(phydev, devad, regnum,\n\t\t       mask, cal_val);\n\tphy_set_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_AD_CALIN,\n\t\t\t MTK_PHY_DA_CALIN_FLAG);\n\n\tret = phy_read_mmd_poll_timeout(phydev, MDIO_MMD_VEND1,\n\t\t\t\t\tMTK_PHY_RG_AD_CAL_CLK, reg_val,\n\t\t\t\t\treg_val & MTK_PHY_DA_CAL_CLK, 500,\n\t\t\t\t\tANALOG_INTERNAL_OPERATION_MAX_US, false);\n\tif (ret) {\n\t\tphydev_err(phydev, \"Calibration cycle timeout\\n\");\n\t\treturn ret;\n\t}\n\n\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_AD_CALIN,\n\t\t\t   MTK_PHY_DA_CALIN_FLAG);\n\tret = phy_read_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_AD_CAL_COMP) >>\n\t\t\t   MTK_PHY_AD_CAL_COMP_OUT_SHIFT;\n\tphydev_dbg(phydev, \"cal_val: 0x%x, ret: %d\\n\", cal_val, ret);\n\n\treturn ret;\n}\n\nstatic int rext_fill_result(struct phy_device *phydev, u16 *buf)\n{\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_ANA_CAL_RG5,\n\t\t       MTK_PHY_RG_REXT_TRIM_MASK, buf[0] << 8);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND2, MTK_PHY_RG_BG_RASEL,\n\t\t       MTK_PHY_RG_BG_RASEL_MASK, buf[1]);\n\n\treturn 0;\n}\n\nstatic int rext_cal_efuse(struct phy_device *phydev, u32 *buf)\n{\n\tu16 rext_cal_val[2];\n\n\trext_cal_val[0] = EFS_RG_REXT_TRIM(buf[3]);\n\trext_cal_val[1] = EFS_RG_BG_RASEL(buf[3]);\n\trext_fill_result(phydev, rext_cal_val);\n\n\treturn 0;\n}\n\nstatic int tx_offset_fill_result(struct phy_device *phydev, u16 *buf)\n{\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_CR_TX_AMP_OFFSET_A_B,\n\t\t       MTK_PHY_CR_TX_AMP_OFFSET_A_MASK, buf[0] << 8);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_CR_TX_AMP_OFFSET_A_B,\n\t\t       MTK_PHY_CR_TX_AMP_OFFSET_B_MASK, buf[1]);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_CR_TX_AMP_OFFSET_C_D,\n\t\t       MTK_PHY_CR_TX_AMP_OFFSET_C_MASK, buf[2] << 8);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_CR_TX_AMP_OFFSET_C_D,\n\t\t       MTK_PHY_CR_TX_AMP_OFFSET_D_MASK, buf[3]);\n\n\treturn 0;\n}\n\nstatic int tx_offset_cal_efuse(struct phy_device *phydev, u32 *buf)\n{\n\tu16 tx_offset_cal_val[4];\n\n\ttx_offset_cal_val[0] = EFS_DA_TX_AMP_OFFSET_A(buf[0]);\n\ttx_offset_cal_val[1] = EFS_DA_TX_AMP_OFFSET_B(buf[1]);\n\ttx_offset_cal_val[2] = EFS_DA_TX_AMP_OFFSET_C(buf[1]);\n\ttx_offset_cal_val[3] = EFS_DA_TX_AMP_OFFSET_D(buf[1]);\n\n\ttx_offset_fill_result(phydev, tx_offset_cal_val);\n\n\treturn 0;\n}\n\nstatic int tx_amp_fill_result(struct phy_device *phydev, u16 *buf)\n{\n\tint i;\n\tint bias[16] = {};\n\tconst int vals_9461[16] = { 7, 1, 4, 7,\n\t\t\t\t    7, 1, 4, 7,\n\t\t\t\t    7, 1, 4, 7,\n\t\t\t\t    7, 1, 4, 7 };\n\tconst int vals_9481[16] = { 10, 6, 6, 10,\n\t\t\t\t    10, 6, 6, 10,\n\t\t\t\t    10, 6, 6, 10,\n\t\t\t\t    10, 6, 6, 10 };\n\tswitch (phydev->drv->phy_id) {\n\tcase MTK_GPHY_ID_MT7981:\n\t\t \n\t\tmemcpy(bias, (const void *)vals_9461, sizeof(bias));\n\t\tbreak;\n\tcase MTK_GPHY_ID_MT7988:\n\t\tmemcpy(bias, (const void *)vals_9481, sizeof(bias));\n\t\tbreak;\n\t}\n\n\t \n\tfor (i = 0; i < 12; i++) {\n\t\tif (buf[i >> 2] + bias[i] > 63) {\n\t\t\tbuf[i >> 2] = 63;\n\t\t\tbias[i] = 0;\n\t\t}\n\t}\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TXVLD_DA_RG,\n\t\t       MTK_PHY_DA_TX_I2MPB_A_GBE_MASK, (buf[0] + bias[0]) << 10);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TXVLD_DA_RG,\n\t\t       MTK_PHY_DA_TX_I2MPB_A_TBT_MASK, buf[0] + bias[1]);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_A2,\n\t\t       MTK_PHY_DA_TX_I2MPB_A_HBT_MASK, (buf[0] + bias[2]) << 10);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_A2,\n\t\t       MTK_PHY_DA_TX_I2MPB_A_TST_MASK, buf[0] + bias[3]);\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_B1,\n\t\t       MTK_PHY_DA_TX_I2MPB_B_GBE_MASK, (buf[1] + bias[4]) << 8);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_B1,\n\t\t       MTK_PHY_DA_TX_I2MPB_B_TBT_MASK, buf[1] + bias[5]);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_B2,\n\t\t       MTK_PHY_DA_TX_I2MPB_B_HBT_MASK, (buf[1] + bias[6]) << 8);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_B2,\n\t\t       MTK_PHY_DA_TX_I2MPB_B_TST_MASK, buf[1] + bias[7]);\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_C1,\n\t\t       MTK_PHY_DA_TX_I2MPB_C_GBE_MASK, (buf[2] + bias[8]) << 8);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_C1,\n\t\t       MTK_PHY_DA_TX_I2MPB_C_TBT_MASK, buf[2] + bias[9]);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_C2,\n\t\t       MTK_PHY_DA_TX_I2MPB_C_HBT_MASK, (buf[2] + bias[10]) << 8);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_C2,\n\t\t       MTK_PHY_DA_TX_I2MPB_C_TST_MASK, buf[2] + bias[11]);\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_D1,\n\t\t       MTK_PHY_DA_TX_I2MPB_D_GBE_MASK, (buf[3] + bias[12]) << 8);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_D1,\n\t\t       MTK_PHY_DA_TX_I2MPB_D_TBT_MASK, buf[3] + bias[13]);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_D2,\n\t\t       MTK_PHY_DA_TX_I2MPB_D_HBT_MASK, (buf[3] + bias[14]) << 8);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_TX_I2MPB_TEST_MODE_D2,\n\t\t       MTK_PHY_DA_TX_I2MPB_D_TST_MASK, buf[3] + bias[15]);\n\n\treturn 0;\n}\n\nstatic int tx_amp_cal_efuse(struct phy_device *phydev, u32 *buf)\n{\n\tu16 tx_amp_cal_val[4];\n\n\ttx_amp_cal_val[0] = EFS_DA_TX_I2MPB_A(buf[0]);\n\ttx_amp_cal_val[1] = EFS_DA_TX_I2MPB_B(buf[0]);\n\ttx_amp_cal_val[2] = EFS_DA_TX_I2MPB_C(buf[0]);\n\ttx_amp_cal_val[3] = EFS_DA_TX_I2MPB_D(buf[0]);\n\ttx_amp_fill_result(phydev, tx_amp_cal_val);\n\n\treturn 0;\n}\n\nstatic int tx_r50_fill_result(struct phy_device *phydev, u16 tx_r50_cal_val,\n\t\t\t      u8 txg_calen_x)\n{\n\tint bias = 0;\n\tu16 reg, val;\n\n\tif (phydev->drv->phy_id == MTK_GPHY_ID_MT7988)\n\t\tbias = -2;\n\n\tval = clamp_val(bias + tx_r50_cal_val, 0, 63);\n\n\tswitch (txg_calen_x) {\n\tcase PAIR_A:\n\t\treg = MTK_PHY_DA_TX_R50_PAIR_A;\n\t\tbreak;\n\tcase PAIR_B:\n\t\treg = MTK_PHY_DA_TX_R50_PAIR_B;\n\t\tbreak;\n\tcase PAIR_C:\n\t\treg = MTK_PHY_DA_TX_R50_PAIR_C;\n\t\tbreak;\n\tcase PAIR_D:\n\t\treg = MTK_PHY_DA_TX_R50_PAIR_D;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, reg, val | val << 8);\n\n\treturn 0;\n}\n\nstatic int tx_r50_cal_efuse(struct phy_device *phydev, u32 *buf,\n\t\t\t    u8 txg_calen_x)\n{\n\tu16 tx_r50_cal_val;\n\n\tswitch (txg_calen_x) {\n\tcase PAIR_A:\n\t\ttx_r50_cal_val = EFS_DA_TX_R50_A(buf[1]);\n\t\tbreak;\n\tcase PAIR_B:\n\t\ttx_r50_cal_val = EFS_DA_TX_R50_B(buf[1]);\n\t\tbreak;\n\tcase PAIR_C:\n\t\ttx_r50_cal_val = EFS_DA_TX_R50_C(buf[2]);\n\t\tbreak;\n\tcase PAIR_D:\n\t\ttx_r50_cal_val = EFS_DA_TX_R50_D(buf[2]);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\ttx_r50_fill_result(phydev, tx_r50_cal_val, txg_calen_x);\n\n\treturn 0;\n}\n\nstatic int tx_vcm_cal_sw(struct phy_device *phydev, u8 rg_txreserve_x)\n{\n\tu8 lower_idx, upper_idx, txreserve_val;\n\tu8 lower_ret, upper_ret;\n\tint ret;\n\n\tphy_set_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_ANA_CAL_RG0,\n\t\t\t MTK_PHY_RG_ANA_CALEN);\n\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_ANA_CAL_RG0,\n\t\t\t   MTK_PHY_RG_CAL_CKINV);\n\tphy_set_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_ANA_CAL_RG1,\n\t\t\t MTK_PHY_RG_TXVOS_CALEN);\n\n\tswitch (rg_txreserve_x) {\n\tcase PAIR_A:\n\t\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t   MTK_PHY_RG_DASN_DAC_IN0_A,\n\t\t\t\t   MTK_PHY_DASN_DAC_IN0_A_MASK);\n\t\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t   MTK_PHY_RG_DASN_DAC_IN1_A,\n\t\t\t\t   MTK_PHY_DASN_DAC_IN1_A_MASK);\n\t\tphy_set_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t MTK_PHY_RG_ANA_CAL_RG0,\n\t\t\t\t MTK_PHY_RG_ZCALEN_A);\n\t\tbreak;\n\tcase PAIR_B:\n\t\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t   MTK_PHY_RG_DASN_DAC_IN0_B,\n\t\t\t\t   MTK_PHY_DASN_DAC_IN0_B_MASK);\n\t\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t   MTK_PHY_RG_DASN_DAC_IN1_B,\n\t\t\t\t   MTK_PHY_DASN_DAC_IN1_B_MASK);\n\t\tphy_set_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t MTK_PHY_RG_ANA_CAL_RG1,\n\t\t\t\t MTK_PHY_RG_ZCALEN_B);\n\t\tbreak;\n\tcase PAIR_C:\n\t\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t   MTK_PHY_RG_DASN_DAC_IN0_C,\n\t\t\t\t   MTK_PHY_DASN_DAC_IN0_C_MASK);\n\t\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t   MTK_PHY_RG_DASN_DAC_IN1_C,\n\t\t\t\t   MTK_PHY_DASN_DAC_IN1_C_MASK);\n\t\tphy_set_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t MTK_PHY_RG_ANA_CAL_RG1,\n\t\t\t\t MTK_PHY_RG_ZCALEN_C);\n\t\tbreak;\n\tcase PAIR_D:\n\t\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t   MTK_PHY_RG_DASN_DAC_IN0_D,\n\t\t\t\t   MTK_PHY_DASN_DAC_IN0_D_MASK);\n\t\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t   MTK_PHY_RG_DASN_DAC_IN1_D,\n\t\t\t\t   MTK_PHY_DASN_DAC_IN1_D_MASK);\n\t\tphy_set_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t\t MTK_PHY_RG_ANA_CAL_RG1,\n\t\t\t\t MTK_PHY_RG_ZCALEN_D);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tgoto restore;\n\t}\n\n\tlower_idx = TXRESERVE_MIN;\n\tupper_idx = TXRESERVE_MAX;\n\n\tphydev_dbg(phydev, \"Start TX-VCM SW cal.\\n\");\n\twhile ((upper_idx - lower_idx) > 1) {\n\t\ttxreserve_val = DIV_ROUND_CLOSEST(lower_idx + upper_idx, 2);\n\t\tret = cal_cycle(phydev, MDIO_MMD_VEND1, MTK_PHY_RXADC_CTRL_RG9,\n\t\t\t\tMTK_PHY_DA_RX_PSBN_TBT_MASK |\n\t\t\t\tMTK_PHY_DA_RX_PSBN_HBT_MASK |\n\t\t\t\tMTK_PHY_DA_RX_PSBN_GBE_MASK |\n\t\t\t\tMTK_PHY_DA_RX_PSBN_LP_MASK,\n\t\t\t\ttxreserve_val << 12 | txreserve_val << 8 |\n\t\t\t\ttxreserve_val << 4 | txreserve_val);\n\t\tif (ret == 1) {\n\t\t\tupper_idx = txreserve_val;\n\t\t\tupper_ret = ret;\n\t\t} else if (ret == 0) {\n\t\t\tlower_idx = txreserve_val;\n\t\t\tlower_ret = ret;\n\t\t} else {\n\t\t\tgoto restore;\n\t\t}\n\t}\n\n\tif (lower_idx == TXRESERVE_MIN) {\n\t\tlower_ret = cal_cycle(phydev, MDIO_MMD_VEND1,\n\t\t\t\t      MTK_PHY_RXADC_CTRL_RG9,\n\t\t\t\t      MTK_PHY_DA_RX_PSBN_TBT_MASK |\n\t\t\t\t      MTK_PHY_DA_RX_PSBN_HBT_MASK |\n\t\t\t\t      MTK_PHY_DA_RX_PSBN_GBE_MASK |\n\t\t\t\t      MTK_PHY_DA_RX_PSBN_LP_MASK,\n\t\t\t\t      lower_idx << 12 | lower_idx << 8 |\n\t\t\t\t      lower_idx << 4 | lower_idx);\n\t\tret = lower_ret;\n\t} else if (upper_idx == TXRESERVE_MAX) {\n\t\tupper_ret = cal_cycle(phydev, MDIO_MMD_VEND1,\n\t\t\t\t      MTK_PHY_RXADC_CTRL_RG9,\n\t\t\t\t      MTK_PHY_DA_RX_PSBN_TBT_MASK |\n\t\t\t\t      MTK_PHY_DA_RX_PSBN_HBT_MASK |\n\t\t\t\t      MTK_PHY_DA_RX_PSBN_GBE_MASK |\n\t\t\t\t      MTK_PHY_DA_RX_PSBN_LP_MASK,\n\t\t\t\t      upper_idx << 12 | upper_idx << 8 |\n\t\t\t\t      upper_idx << 4 | upper_idx);\n\t\tret = upper_ret;\n\t}\n\tif (ret < 0)\n\t\tgoto restore;\n\n\t \n\tret = upper_ret - lower_ret;\n\tif (ret == 1) {\n\t\tret = 0;\n\t\t \n\t\tcal_cycle(phydev, MDIO_MMD_VEND1, MTK_PHY_RXADC_CTRL_RG9,\n\t\t\t  MTK_PHY_DA_RX_PSBN_TBT_MASK |\n\t\t\t  MTK_PHY_DA_RX_PSBN_HBT_MASK |\n\t\t\t  MTK_PHY_DA_RX_PSBN_GBE_MASK |\n\t\t\t  MTK_PHY_DA_RX_PSBN_LP_MASK,\n\t\t\t  upper_idx << 12 | upper_idx << 8 |\n\t\t\t  upper_idx << 4 | upper_idx);\n\t\tphydev_dbg(phydev, \"TX-VCM SW cal result: 0x%x\\n\", upper_idx);\n\t} else if (lower_idx == TXRESERVE_MIN && upper_ret == 1 &&\n\t\t   lower_ret == 1) {\n\t\tret = 0;\n\t\tcal_cycle(phydev, MDIO_MMD_VEND1, MTK_PHY_RXADC_CTRL_RG9,\n\t\t\t  MTK_PHY_DA_RX_PSBN_TBT_MASK |\n\t\t\t  MTK_PHY_DA_RX_PSBN_HBT_MASK |\n\t\t\t  MTK_PHY_DA_RX_PSBN_GBE_MASK |\n\t\t\t  MTK_PHY_DA_RX_PSBN_LP_MASK,\n\t\t\t  lower_idx << 12 | lower_idx << 8 |\n\t\t\t  lower_idx << 4 | lower_idx);\n\t\tphydev_warn(phydev, \"TX-VCM SW cal result at low margin 0x%x\\n\",\n\t\t\t    lower_idx);\n\t} else if (upper_idx == TXRESERVE_MAX && upper_ret == 0 &&\n\t\t   lower_ret == 0) {\n\t\tret = 0;\n\t\tphydev_warn(phydev, \"TX-VCM SW cal result at high margin 0x%x\\n\",\n\t\t\t    upper_idx);\n\t} else {\n\t\tret = -EINVAL;\n\t}\n\nrestore:\n\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_ANA_CAL_RG0,\n\t\t\t   MTK_PHY_RG_ANA_CALEN);\n\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_ANA_CAL_RG1,\n\t\t\t   MTK_PHY_RG_TXVOS_CALEN);\n\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_ANA_CAL_RG0,\n\t\t\t   MTK_PHY_RG_ZCALEN_A);\n\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_ANA_CAL_RG1,\n\t\t\t   MTK_PHY_RG_ZCALEN_B | MTK_PHY_RG_ZCALEN_C |\n\t\t\t   MTK_PHY_RG_ZCALEN_D);\n\n\treturn ret;\n}\n\nstatic void mt798x_phy_common_finetune(struct phy_device *phydev)\n{\n\tphy_select_page(phydev, MTK_PHY_PAGE_EXTENDED_52B5);\n\t \n\t__phy_write(phydev, 0x11, 0x2f00);\n\t__phy_write(phydev, 0x12, 0xe);\n\t__phy_write(phydev, 0x10, 0x8fb0);\n\n\t \n\t__phy_write(phydev, 0x11, 0x55a0);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x83aa);\n\n\t \n\t__phy_write(phydev, 0x11, 0x0);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x9686);\n\n\t \n\t__phy_write(phydev, 0x11, 0xbaef);\n\t__phy_write(phydev, 0x12, 0x2e);\n\t__phy_write(phydev, 0x10, 0x968c);\n\n\t \n\t__phy_write(phydev, 0x11, 0xd10a);\n\t__phy_write(phydev, 0x12, 0x34);\n\t__phy_write(phydev, 0x10, 0x8f82);\n\n\t \n\t__phy_write(phydev, 0x11, 0x5555);\n\t__phy_write(phydev, 0x12, 0x55);\n\t__phy_write(phydev, 0x10, 0x8ec0);\n\tphy_restore_page(phydev, MTK_PHY_PAGE_STANDARD, 0);\n\n\t \n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_DEV1E_REG234,\n\t\t       MTK_PHY_TR_OPEN_LOOP_EN_MASK | MTK_PHY_LPF_X_AVERAGE_MASK,\n\t\t       BIT(0) | FIELD_PREP(MTK_PHY_LPF_X_AVERAGE_MASK, 0x9));\n\n\t \n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LPF_CNT_VAL, 0x200);\n\n\t \n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LP_IIR2_K1_L, 0x82);\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LP_IIR2_K1_U, 0x0);\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LP_IIR2_K2_L, 0x103);\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LP_IIR2_K2_U, 0x0);\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LP_IIR2_K3_L, 0x82);\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LP_IIR2_K3_U, 0x0);\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LP_IIR2_K4_L, 0xd177);\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LP_IIR2_K4_U, 0x3);\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LP_IIR2_K5_L, 0x2c82);\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_LP_IIR2_K5_U, 0xe);\n\n\t \n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_DEV1E_REG27C,\n\t\t       MTK_PHY_VGASTATE_FFE_THR_ST1_MASK, 0x1b << 8);\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_DEV1E_REG27D,\n\t\t       MTK_PHY_VGASTATE_FFE_THR_ST2_MASK, 0x1e);\n\n\t \n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_LDO_PUMP_EN_PAIRAB, 0x0);\n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_LDO_PUMP_EN_PAIRCD, 0x0);\n\t \n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_LDO_OUTPUT_V, 0x2222);\n}\n\nstatic void mt7981_phy_finetune(struct phy_device *phydev)\n{\n\tu16 val[8] = { 0x01ce, 0x01c1,\n\t\t       0x020f, 0x0202,\n\t\t       0x03d0, 0x03c0,\n\t\t       0x0013, 0x0005 };\n\tint i, k;\n\n\t \n\tfor (k = 0, i = 1; i < 12; i++) {\n\t\tif (i % 3 == 0)\n\t\t\tcontinue;\n\t\tphy_write_mmd(phydev, MDIO_MMD_VEND1, i, val[k++]);\n\t}\n\n\tphy_select_page(phydev, MTK_PHY_PAGE_EXTENDED_52B5);\n\t \n\t__phy_write(phydev, 0x11, 0xc71);\n\t__phy_write(phydev, 0x12, 0xc);\n\t__phy_write(phydev, 0x10, 0x8fae);\n\n\t \n\t__phy_write(phydev, 0x11, 0x600);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x8fc0);\n\n\t \n\t__phy_write(phydev, 0x11, 0x4c2a);\n\t__phy_write(phydev, 0x12, 0x3e);\n\t__phy_write(phydev, 0x10, 0x8fa4);\n\n\t \n\t__phy_write(phydev, 0x11, 0x240);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x9680);\n\n\tphy_restore_page(phydev, MTK_PHY_PAGE_STANDARD, 0);\n}\n\nstatic void mt7988_phy_finetune(struct phy_device *phydev)\n{\n\tu16 val[12] = { 0x0187, 0x01cd, 0x01c8, 0x0182,\n\t\t\t0x020d, 0x0206, 0x0384, 0x03d0,\n\t\t\t0x03c6, 0x030a, 0x0011, 0x0005 };\n\tint i;\n\n\t \n\tfor (i = 0; i < 12; i++)\n\t\tphy_write_mmd(phydev, MDIO_MMD_VEND1, i, val[i]);\n\n\t \n\tphy_write_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_TX_FILTER, 0x5);\n\n\t \n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RXADC_CTRL_RG7,\n\t\t       MTK_PHY_DA_AD_BUF_BIAS_LP_MASK, 0x3 << 8);\n\n\tphy_select_page(phydev, MTK_PHY_PAGE_EXTENDED_52B5);\n\n\t \n\t__phy_write(phydev, 0x11, 0x671);\n\t__phy_write(phydev, 0x12, 0xc);\n\t__phy_write(phydev, 0x10, 0x8fae);\n\n\t \n\t__phy_write(phydev, 0x11, 0x500);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x8fc0);\n\n\t \n\n\tphy_restore_page(phydev, MTK_PHY_PAGE_STANDARD, 0);\n\n\tphy_select_page(phydev, MTK_PHY_PAGE_EXTENDED_2A30);\n\t \n\t__phy_modify(phydev, MTK_PHY_ANARG_RG, MTK_PHY_TCLKOFFSET_MASK,\n\t\t     FIELD_PREP(MTK_PHY_TCLKOFFSET_MASK, 0x2));\n\tphy_restore_page(phydev, MTK_PHY_PAGE_STANDARD, 0);\n}\n\nstatic void mt798x_phy_eee(struct phy_device *phydev)\n{\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1,\n\t\t       MTK_PHY_RG_LPI_PCS_DSP_CTRL_REG120,\n\t\t       MTK_PHY_LPI_SIG_EN_LO_THRESH1000_MASK |\n\t\t       MTK_PHY_LPI_SIG_EN_HI_THRESH1000_MASK,\n\t\t       FIELD_PREP(MTK_PHY_LPI_SIG_EN_LO_THRESH1000_MASK, 0x0) |\n\t\t       FIELD_PREP(MTK_PHY_LPI_SIG_EN_HI_THRESH1000_MASK, 0x14));\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1,\n\t\t       MTK_PHY_RG_LPI_PCS_DSP_CTRL_REG122,\n\t\t       MTK_PHY_LPI_NORM_MSE_HI_THRESH1000_MASK,\n\t\t       FIELD_PREP(MTK_PHY_LPI_NORM_MSE_HI_THRESH1000_MASK,\n\t\t\t\t  0xff));\n\n\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t   MTK_PHY_RG_TESTMUX_ADC_CTRL,\n\t\t\t   MTK_PHY_RG_TXEN_DIG_MASK);\n\n\tphy_set_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t MTK_PHY_RG_DEV1E_REG19b, MTK_PHY_BYPASS_DSP_LPI_READY);\n\n\tphy_clear_bits_mmd(phydev, MDIO_MMD_VEND1,\n\t\t\t   MTK_PHY_RG_DEV1E_REG234, MTK_PHY_TR_LP_IIR_EEE_EN);\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_DEV1E_REG238,\n\t\t       MTK_PHY_LPI_SLV_SEND_TX_TIMER_MASK |\n\t\t       MTK_PHY_LPI_SLV_SEND_TX_EN,\n\t\t       FIELD_PREP(MTK_PHY_LPI_SLV_SEND_TX_TIMER_MASK, 0x120));\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_DEV1E_REG239,\n\t\t       MTK_PHY_LPI_SEND_LOC_TIMER_MASK |\n\t\t       MTK_PHY_LPI_TXPCS_LOC_RCV,\n\t\t       FIELD_PREP(MTK_PHY_LPI_SEND_LOC_TIMER_MASK, 0x117));\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_DEV1E_REG2C7,\n\t\t       MTK_PHY_MAX_GAIN_MASK | MTK_PHY_MIN_GAIN_MASK,\n\t\t       FIELD_PREP(MTK_PHY_MAX_GAIN_MASK, 0x8) |\n\t\t       FIELD_PREP(MTK_PHY_MIN_GAIN_MASK, 0x13));\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_DEV1E_REG2D1,\n\t\t       MTK_PHY_VCO_SLICER_THRESH_BITS_HIGH_EEE_MASK,\n\t\t       FIELD_PREP(MTK_PHY_VCO_SLICER_THRESH_BITS_HIGH_EEE_MASK,\n\t\t\t\t  0x33) |\n\t\t       MTK_PHY_LPI_SKIP_SD_SLV_TR | MTK_PHY_LPI_TR_READY |\n\t\t       MTK_PHY_LPI_VCO_EEE_STG0_EN);\n\n\tphy_set_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_DEV1E_REG323,\n\t\t\t MTK_PHY_EEE_WAKE_MAS_INT_DC |\n\t\t\t MTK_PHY_EEE_WAKE_SLV_INT_DC);\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_DEV1E_REG324,\n\t\t       MTK_PHY_SMI_DETCNT_MAX_MASK,\n\t\t       FIELD_PREP(MTK_PHY_SMI_DETCNT_MAX_MASK, 0x3f) |\n\t\t       MTK_PHY_SMI_DET_MAX_EN);\n\n\tphy_set_bits_mmd(phydev, MDIO_MMD_VEND1, MTK_PHY_RG_DEV1E_REG326,\n\t\t\t MTK_PHY_LPI_MODE_SD_ON | MTK_PHY_RESET_RANDUPD_CNT |\n\t\t\t MTK_PHY_TREC_UPDATE_ENAB_CLR |\n\t\t\t MTK_PHY_LPI_QUIT_WAIT_DFE_SIG_DET_OFF |\n\t\t\t MTK_PHY_TR_READY_SKIP_AFE_WAKEUP);\n\n\tphy_select_page(phydev, MTK_PHY_PAGE_EXTENDED_52B5);\n\t \n\t__phy_write(phydev, 0x11, 0xb);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x9690);\n\n\t \n\t__phy_write(phydev, 0x11, 0x114f);\n\t__phy_write(phydev, 0x12, 0x2);\n\t__phy_write(phydev, 0x10, 0x969a);\n\n\t \n\t__phy_write(phydev, 0x11, 0x3028);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x969e);\n\n\t \n\t__phy_write(phydev, 0x11, 0x5010);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x96a0);\n\n\t \n\t__phy_write(phydev, 0x11, 0x24a);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x96a8);\n\n\t \n\t__phy_write(phydev, 0x11, 0x3210);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x96b8);\n\n\t \n\t__phy_write(phydev, 0x11, 0x1463);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x96ca);\n\n\t \n\t__phy_write(phydev, 0x11, 0x36);\n\t__phy_write(phydev, 0x12, 0x0);\n\t__phy_write(phydev, 0x10, 0x8f80);\n\tphy_restore_page(phydev, MTK_PHY_PAGE_STANDARD, 0);\n\n\tphy_select_page(phydev, MTK_PHY_PAGE_EXTENDED_3);\n\t__phy_modify(phydev, MTK_PHY_LPI_REG_14, MTK_PHY_LPI_WAKE_TIMER_1000_MASK,\n\t\t     FIELD_PREP(MTK_PHY_LPI_WAKE_TIMER_1000_MASK, 0x19c));\n\n\t__phy_modify(phydev, MTK_PHY_LPI_REG_1c, MTK_PHY_SMI_DET_ON_THRESH_MASK,\n\t\t     FIELD_PREP(MTK_PHY_SMI_DET_ON_THRESH_MASK, 0xc));\n\tphy_restore_page(phydev, MTK_PHY_PAGE_STANDARD, 0);\n\n\tphy_modify_mmd(phydev, MDIO_MMD_VEND1,\n\t\t       MTK_PHY_RG_LPI_PCS_DSP_CTRL_REG122,\n\t\t       MTK_PHY_LPI_NORM_MSE_HI_THRESH1000_MASK,\n\t\t       FIELD_PREP(MTK_PHY_LPI_NORM_MSE_HI_THRESH1000_MASK, 0xff));\n}\n\nstatic int cal_sw(struct phy_device *phydev, enum CAL_ITEM cal_item,\n\t\t  u8 start_pair, u8 end_pair)\n{\n\tu8 pair_n;\n\tint ret;\n\n\tfor (pair_n = start_pair; pair_n <= end_pair; pair_n++) {\n\t\t \n\t\tswitch (cal_item) {\n\t\tcase TX_VCM:\n\t\t\tret = tx_vcm_cal_sw(phydev, pair_n);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic int cal_efuse(struct phy_device *phydev, enum CAL_ITEM cal_item,\n\t\t     u8 start_pair, u8 end_pair, u32 *buf)\n{\n\tu8 pair_n;\n\tint ret;\n\n\tfor (pair_n = start_pair; pair_n <= end_pair; pair_n++) {\n\t\t \n\t\tswitch (cal_item) {\n\t\tcase REXT:\n\t\t\tret = rext_cal_efuse(phydev, buf);\n\t\t\tbreak;\n\t\tcase TX_OFFSET:\n\t\t\tret = tx_offset_cal_efuse(phydev, buf);\n\t\t\tbreak;\n\t\tcase TX_AMP:\n\t\t\tret = tx_amp_cal_efuse(phydev, buf);\n\t\t\tbreak;\n\t\tcase TX_R50:\n\t\t\tret = tx_r50_cal_efuse(phydev, buf, pair_n);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int start_cal(struct phy_device *phydev, enum CAL_ITEM cal_item,\n\t\t     enum CAL_MODE cal_mode, u8 start_pair,\n\t\t     u8 end_pair, u32 *buf)\n{\n\tint ret;\n\n\tswitch (cal_mode) {\n\tcase EFUSE_M:\n\t\tret = cal_efuse(phydev, cal_item, start_pair,\n\t\t\t\tend_pair, buf);\n\t\tbreak;\n\tcase SW_M:\n\t\tret = cal_sw(phydev, cal_item, start_pair, end_pair);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (ret) {\n\t\tphydev_err(phydev, \"cal %d failed\\n\", cal_item);\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nstatic int mt798x_phy_calibration(struct phy_device *phydev)\n{\n\tint ret = 0;\n\tu32 *buf;\n\tsize_t len;\n\tstruct nvmem_cell *cell;\n\n\tcell = nvmem_cell_get(&phydev->mdio.dev, \"phy-cal-data\");\n\tif (IS_ERR(cell)) {\n\t\tif (PTR_ERR(cell) == -EPROBE_DEFER)\n\t\t\treturn PTR_ERR(cell);\n\t\treturn 0;\n\t}\n\n\tbuf = (u32 *)nvmem_cell_read(cell, &len);\n\tif (IS_ERR(buf))\n\t\treturn PTR_ERR(buf);\n\tnvmem_cell_put(cell);\n\n\tif (!buf[0] || !buf[1] || !buf[2] || !buf[3] || len < 4 * sizeof(u32)) {\n\t\tphydev_err(phydev, \"invalid efuse data\\n\");\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tret = start_cal(phydev, REXT, EFUSE_M, NO_PAIR, NO_PAIR, buf);\n\tif (ret)\n\t\tgoto out;\n\tret = start_cal(phydev, TX_OFFSET, EFUSE_M, NO_PAIR, NO_PAIR, buf);\n\tif (ret)\n\t\tgoto out;\n\tret = start_cal(phydev, TX_AMP, EFUSE_M, NO_PAIR, NO_PAIR, buf);\n\tif (ret)\n\t\tgoto out;\n\tret = start_cal(phydev, TX_R50, EFUSE_M, PAIR_A, PAIR_D, buf);\n\tif (ret)\n\t\tgoto out;\n\tret = start_cal(phydev, TX_VCM, SW_M, PAIR_A, PAIR_A, buf);\n\tif (ret)\n\t\tgoto out;\n\nout:\n\tkfree(buf);\n\treturn ret;\n}\n\nstatic int mt798x_phy_config_init(struct phy_device *phydev)\n{\n\tswitch (phydev->drv->phy_id) {\n\tcase MTK_GPHY_ID_MT7981:\n\t\tmt7981_phy_finetune(phydev);\n\t\tbreak;\n\tcase MTK_GPHY_ID_MT7988:\n\t\tmt7988_phy_finetune(phydev);\n\t\tbreak;\n\t}\n\n\tmt798x_phy_common_finetune(phydev);\n\tmt798x_phy_eee(phydev);\n\n\treturn mt798x_phy_calibration(phydev);\n}\n\nstatic int mt798x_phy_hw_led_on_set(struct phy_device *phydev, u8 index,\n\t\t\t\t    bool on)\n{\n\tunsigned int bit_on = MTK_PHY_LED_STATE_FORCE_ON + (index ? 16 : 0);\n\tstruct mtk_socphy_priv *priv = phydev->priv;\n\tbool changed;\n\n\tif (on)\n\t\tchanged = !test_and_set_bit(bit_on, &priv->led_state);\n\telse\n\t\tchanged = !!test_and_clear_bit(bit_on, &priv->led_state);\n\n\tchanged |= !!test_and_clear_bit(MTK_PHY_LED_STATE_NETDEV +\n\t\t\t\t\t(index ? 16 : 0), &priv->led_state);\n\tif (changed)\n\t\treturn phy_modify_mmd(phydev, MDIO_MMD_VEND2, index ?\n\t\t\t\t      MTK_PHY_LED1_ON_CTRL : MTK_PHY_LED0_ON_CTRL,\n\t\t\t\t      MTK_PHY_LED_ON_MASK,\n\t\t\t\t      on ? MTK_PHY_LED_ON_FORCE_ON : 0);\n\telse\n\t\treturn 0;\n}\n\nstatic int mt798x_phy_hw_led_blink_set(struct phy_device *phydev, u8 index,\n\t\t\t\t       bool blinking)\n{\n\tunsigned int bit_blink = MTK_PHY_LED_STATE_FORCE_BLINK + (index ? 16 : 0);\n\tstruct mtk_socphy_priv *priv = phydev->priv;\n\tbool changed;\n\n\tif (blinking)\n\t\tchanged = !test_and_set_bit(bit_blink, &priv->led_state);\n\telse\n\t\tchanged = !!test_and_clear_bit(bit_blink, &priv->led_state);\n\n\tchanged |= !!test_bit(MTK_PHY_LED_STATE_NETDEV +\n\t\t\t      (index ? 16 : 0), &priv->led_state);\n\tif (changed)\n\t\treturn phy_write_mmd(phydev, MDIO_MMD_VEND2, index ?\n\t\t\t\t     MTK_PHY_LED1_BLINK_CTRL : MTK_PHY_LED0_BLINK_CTRL,\n\t\t\t\t     blinking ? MTK_PHY_LED_BLINK_FORCE_BLINK : 0);\n\telse\n\t\treturn 0;\n}\n\nstatic int mt798x_phy_led_blink_set(struct phy_device *phydev, u8 index,\n\t\t\t\t    unsigned long *delay_on,\n\t\t\t\t    unsigned long *delay_off)\n{\n\tbool blinking = false;\n\tint err = 0;\n\n\tif (index > 1)\n\t\treturn -EINVAL;\n\n\tif (delay_on && delay_off && (*delay_on > 0) && (*delay_off > 0)) {\n\t\tblinking = true;\n\t\t*delay_on = 50;\n\t\t*delay_off = 50;\n\t}\n\n\terr = mt798x_phy_hw_led_blink_set(phydev, index, blinking);\n\tif (err)\n\t\treturn err;\n\n\treturn mt798x_phy_hw_led_on_set(phydev, index, false);\n}\n\nstatic int mt798x_phy_led_brightness_set(struct phy_device *phydev,\n\t\t\t\t\t u8 index, enum led_brightness value)\n{\n\tint err;\n\n\terr = mt798x_phy_hw_led_blink_set(phydev, index, false);\n\tif (err)\n\t\treturn err;\n\n\treturn mt798x_phy_hw_led_on_set(phydev, index, (value != LED_OFF));\n}\n\nstatic const unsigned long supported_triggers = (BIT(TRIGGER_NETDEV_FULL_DUPLEX) |\n\t\t\t\t\t\t BIT(TRIGGER_NETDEV_HALF_DUPLEX) |\n\t\t\t\t\t\t BIT(TRIGGER_NETDEV_LINK)        |\n\t\t\t\t\t\t BIT(TRIGGER_NETDEV_LINK_10)     |\n\t\t\t\t\t\t BIT(TRIGGER_NETDEV_LINK_100)    |\n\t\t\t\t\t\t BIT(TRIGGER_NETDEV_LINK_1000)   |\n\t\t\t\t\t\t BIT(TRIGGER_NETDEV_RX)          |\n\t\t\t\t\t\t BIT(TRIGGER_NETDEV_TX));\n\nstatic int mt798x_phy_led_hw_is_supported(struct phy_device *phydev, u8 index,\n\t\t\t\t\t  unsigned long rules)\n{\n\tif (index > 1)\n\t\treturn -EINVAL;\n\n\t \n\tif (rules & ~supported_triggers)\n\t\treturn -EOPNOTSUPP;\n\n\treturn 0;\n};\n\nstatic int mt798x_phy_led_hw_control_get(struct phy_device *phydev, u8 index,\n\t\t\t\t\t unsigned long *rules)\n{\n\tunsigned int bit_blink = MTK_PHY_LED_STATE_FORCE_BLINK + (index ? 16 : 0);\n\tunsigned int bit_netdev = MTK_PHY_LED_STATE_NETDEV + (index ? 16 : 0);\n\tunsigned int bit_on = MTK_PHY_LED_STATE_FORCE_ON + (index ? 16 : 0);\n\tstruct mtk_socphy_priv *priv = phydev->priv;\n\tint on, blink;\n\n\tif (index > 1)\n\t\treturn -EINVAL;\n\n\ton = phy_read_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t  index ? MTK_PHY_LED1_ON_CTRL : MTK_PHY_LED0_ON_CTRL);\n\n\tif (on < 0)\n\t\treturn -EIO;\n\n\tblink = phy_read_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t     index ? MTK_PHY_LED1_BLINK_CTRL :\n\t\t\t\t     MTK_PHY_LED0_BLINK_CTRL);\n\tif (blink < 0)\n\t\treturn -EIO;\n\n\tif ((on & (MTK_PHY_LED_ON_LINK1000 | MTK_PHY_LED_ON_LINK100 |\n\t\t   MTK_PHY_LED_ON_LINK10)) ||\n\t    (blink & (MTK_PHY_LED_BLINK_1000RX | MTK_PHY_LED_BLINK_100RX |\n\t\t      MTK_PHY_LED_BLINK_10RX | MTK_PHY_LED_BLINK_1000TX |\n\t\t      MTK_PHY_LED_BLINK_100TX | MTK_PHY_LED_BLINK_10TX)))\n\t\tset_bit(bit_netdev, &priv->led_state);\n\telse\n\t\tclear_bit(bit_netdev, &priv->led_state);\n\n\tif (on & MTK_PHY_LED_ON_FORCE_ON)\n\t\tset_bit(bit_on, &priv->led_state);\n\telse\n\t\tclear_bit(bit_on, &priv->led_state);\n\n\tif (blink & MTK_PHY_LED_BLINK_FORCE_BLINK)\n\t\tset_bit(bit_blink, &priv->led_state);\n\telse\n\t\tclear_bit(bit_blink, &priv->led_state);\n\n\tif (!rules)\n\t\treturn 0;\n\n\tif (on & (MTK_PHY_LED_ON_LINK1000 | MTK_PHY_LED_ON_LINK100 | MTK_PHY_LED_ON_LINK10))\n\t\t*rules |= BIT(TRIGGER_NETDEV_LINK);\n\n\tif (on & MTK_PHY_LED_ON_LINK10)\n\t\t*rules |= BIT(TRIGGER_NETDEV_LINK_10);\n\n\tif (on & MTK_PHY_LED_ON_LINK100)\n\t\t*rules |= BIT(TRIGGER_NETDEV_LINK_100);\n\n\tif (on & MTK_PHY_LED_ON_LINK1000)\n\t\t*rules |= BIT(TRIGGER_NETDEV_LINK_1000);\n\n\tif (on & MTK_PHY_LED_ON_FDX)\n\t\t*rules |= BIT(TRIGGER_NETDEV_FULL_DUPLEX);\n\n\tif (on & MTK_PHY_LED_ON_HDX)\n\t\t*rules |= BIT(TRIGGER_NETDEV_HALF_DUPLEX);\n\n\tif (blink & (MTK_PHY_LED_BLINK_1000RX | MTK_PHY_LED_BLINK_100RX | MTK_PHY_LED_BLINK_10RX))\n\t\t*rules |= BIT(TRIGGER_NETDEV_RX);\n\n\tif (blink & (MTK_PHY_LED_BLINK_1000TX | MTK_PHY_LED_BLINK_100TX | MTK_PHY_LED_BLINK_10TX))\n\t\t*rules |= BIT(TRIGGER_NETDEV_TX);\n\n\treturn 0;\n};\n\nstatic int mt798x_phy_led_hw_control_set(struct phy_device *phydev, u8 index,\n\t\t\t\t\t unsigned long rules)\n{\n\tunsigned int bit_netdev = MTK_PHY_LED_STATE_NETDEV + (index ? 16 : 0);\n\tstruct mtk_socphy_priv *priv = phydev->priv;\n\tu16 on = 0, blink = 0;\n\tint ret;\n\n\tif (index > 1)\n\t\treturn -EINVAL;\n\n\tif (rules & BIT(TRIGGER_NETDEV_FULL_DUPLEX))\n\t\ton |= MTK_PHY_LED_ON_FDX;\n\n\tif (rules & BIT(TRIGGER_NETDEV_HALF_DUPLEX))\n\t\ton |= MTK_PHY_LED_ON_HDX;\n\n\tif (rules & (BIT(TRIGGER_NETDEV_LINK_10) | BIT(TRIGGER_NETDEV_LINK)))\n\t\ton |= MTK_PHY_LED_ON_LINK10;\n\n\tif (rules & (BIT(TRIGGER_NETDEV_LINK_100) | BIT(TRIGGER_NETDEV_LINK)))\n\t\ton |= MTK_PHY_LED_ON_LINK100;\n\n\tif (rules & (BIT(TRIGGER_NETDEV_LINK_1000) | BIT(TRIGGER_NETDEV_LINK)))\n\t\ton |= MTK_PHY_LED_ON_LINK1000;\n\n\tif (rules & BIT(TRIGGER_NETDEV_RX)) {\n\t\tblink |= MTK_PHY_LED_BLINK_10RX  |\n\t\t\t MTK_PHY_LED_BLINK_100RX |\n\t\t\t MTK_PHY_LED_BLINK_1000RX;\n\t}\n\n\tif (rules & BIT(TRIGGER_NETDEV_TX)) {\n\t\tblink |= MTK_PHY_LED_BLINK_10TX  |\n\t\t\t MTK_PHY_LED_BLINK_100TX |\n\t\t\t MTK_PHY_LED_BLINK_1000TX;\n\t}\n\n\tif (blink || on)\n\t\tset_bit(bit_netdev, &priv->led_state);\n\telse\n\t\tclear_bit(bit_netdev, &priv->led_state);\n\n\tret = phy_modify_mmd(phydev, MDIO_MMD_VEND2, index ?\n\t\t\t\tMTK_PHY_LED1_ON_CTRL :\n\t\t\t\tMTK_PHY_LED0_ON_CTRL,\n\t\t\t     MTK_PHY_LED_ON_FDX     |\n\t\t\t     MTK_PHY_LED_ON_HDX     |\n\t\t\t     MTK_PHY_LED_ON_LINK10  |\n\t\t\t     MTK_PHY_LED_ON_LINK100 |\n\t\t\t     MTK_PHY_LED_ON_LINK1000,\n\t\t\t     on);\n\n\tif (ret)\n\t\treturn ret;\n\n\treturn phy_write_mmd(phydev, MDIO_MMD_VEND2, index ?\n\t\t\t\tMTK_PHY_LED1_BLINK_CTRL :\n\t\t\t\tMTK_PHY_LED0_BLINK_CTRL, blink);\n};\n\nstatic bool mt7988_phy_led_get_polarity(struct phy_device *phydev, int led_num)\n{\n\tstruct mtk_socphy_shared *priv = phydev->shared->priv;\n\tu32 polarities;\n\n\tif (led_num == 0)\n\t\tpolarities = ~(priv->boottrap);\n\telse\n\t\tpolarities = MTK_PHY_LED1_DEFAULT_POLARITIES;\n\n\tif (polarities & BIT(phydev->mdio.addr))\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic int mt7988_phy_fix_leds_polarities(struct phy_device *phydev)\n{\n\tstruct pinctrl *pinctrl;\n\tint index;\n\n\t \n\tfor (index = 0; index < 2; ++index)\n\t\tphy_modify_mmd(phydev, MDIO_MMD_VEND2, index ?\n\t\t\t\tMTK_PHY_LED1_ON_CTRL : MTK_PHY_LED0_ON_CTRL,\n\t\t\t       MTK_PHY_LED_ON_POLARITY,\n\t\t\t       mt7988_phy_led_get_polarity(phydev, index) ?\n\t\t\t\tMTK_PHY_LED_ON_POLARITY : 0);\n\n\t \n\tpinctrl = devm_pinctrl_get_select(&phydev->mdio.dev, \"gbe-led\");\n\tif (IS_ERR(pinctrl))\n\t\tdev_err(&phydev->mdio.bus->dev, \"Failed to setup PHY LED pinctrl\\n\");\n\n\treturn 0;\n}\n\nstatic int mt7988_phy_probe_shared(struct phy_device *phydev)\n{\n\tstruct device_node *np = dev_of_node(&phydev->mdio.bus->dev);\n\tstruct mtk_socphy_shared *shared = phydev->shared->priv;\n\tstruct regmap *regmap;\n\tu32 reg;\n\tint ret;\n\n\t \n\tregmap = syscon_regmap_lookup_by_phandle(np, \"mediatek,pio\");\n\tif (IS_ERR(regmap))\n\t\treturn PTR_ERR(regmap);\n\n\tret = regmap_read(regmap, RG_GPIO_MISC_TPBANK0, &reg);\n\tif (ret)\n\t\treturn ret;\n\n\tshared->boottrap = FIELD_GET(RG_GPIO_MISC_TPBANK0_BOOTMODE, reg);\n\n\treturn 0;\n}\n\nstatic void mt798x_phy_leds_state_init(struct phy_device *phydev)\n{\n\tint i;\n\n\tfor (i = 0; i < 2; ++i)\n\t\tmt798x_phy_led_hw_control_get(phydev, i, NULL);\n}\n\nstatic int mt7988_phy_probe(struct phy_device *phydev)\n{\n\tstruct mtk_socphy_shared *shared;\n\tstruct mtk_socphy_priv *priv;\n\tint err;\n\n\tif (phydev->mdio.addr > 3)\n\t\treturn -EINVAL;\n\n\terr = devm_phy_package_join(&phydev->mdio.dev, phydev, 0,\n\t\t\t\t    sizeof(struct mtk_socphy_shared));\n\tif (err)\n\t\treturn err;\n\n\tif (phy_package_probe_once(phydev)) {\n\t\terr = mt7988_phy_probe_shared(phydev);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tshared = phydev->shared->priv;\n\tpriv = &shared->priv[phydev->mdio.addr];\n\n\tphydev->priv = priv;\n\n\tmt798x_phy_leds_state_init(phydev);\n\n\terr = mt7988_phy_fix_leds_polarities(phydev);\n\tif (err)\n\t\treturn err;\n\n\treturn mt798x_phy_calibration(phydev);\n}\n\nstatic int mt7981_phy_probe(struct phy_device *phydev)\n{\n\tstruct mtk_socphy_priv *priv;\n\n\tpriv = devm_kzalloc(&phydev->mdio.dev, sizeof(struct mtk_socphy_priv),\n\t\t\t    GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tphydev->priv = priv;\n\n\tmt798x_phy_leds_state_init(phydev);\n\n\treturn mt798x_phy_calibration(phydev);\n}\n\nstatic struct phy_driver mtk_socphy_driver[] = {\n\t{\n\t\tPHY_ID_MATCH_EXACT(MTK_GPHY_ID_MT7981),\n\t\t.name\t\t= \"MediaTek MT7981 PHY\",\n\t\t.config_init\t= mt798x_phy_config_init,\n\t\t.config_intr\t= genphy_no_config_intr,\n\t\t.handle_interrupt = genphy_handle_interrupt_no_ack,\n\t\t.probe\t\t= mt7981_phy_probe,\n\t\t.suspend\t= genphy_suspend,\n\t\t.resume\t\t= genphy_resume,\n\t\t.read_page\t= mtk_socphy_read_page,\n\t\t.write_page\t= mtk_socphy_write_page,\n\t\t.led_blink_set\t= mt798x_phy_led_blink_set,\n\t\t.led_brightness_set = mt798x_phy_led_brightness_set,\n\t\t.led_hw_is_supported = mt798x_phy_led_hw_is_supported,\n\t\t.led_hw_control_set = mt798x_phy_led_hw_control_set,\n\t\t.led_hw_control_get = mt798x_phy_led_hw_control_get,\n\t},\n\t{\n\t\tPHY_ID_MATCH_EXACT(MTK_GPHY_ID_MT7988),\n\t\t.name\t\t= \"MediaTek MT7988 PHY\",\n\t\t.config_init\t= mt798x_phy_config_init,\n\t\t.config_intr\t= genphy_no_config_intr,\n\t\t.handle_interrupt = genphy_handle_interrupt_no_ack,\n\t\t.probe\t\t= mt7988_phy_probe,\n\t\t.suspend\t= genphy_suspend,\n\t\t.resume\t\t= genphy_resume,\n\t\t.read_page\t= mtk_socphy_read_page,\n\t\t.write_page\t= mtk_socphy_write_page,\n\t\t.led_blink_set\t= mt798x_phy_led_blink_set,\n\t\t.led_brightness_set = mt798x_phy_led_brightness_set,\n\t\t.led_hw_is_supported = mt798x_phy_led_hw_is_supported,\n\t\t.led_hw_control_set = mt798x_phy_led_hw_control_set,\n\t\t.led_hw_control_get = mt798x_phy_led_hw_control_get,\n\t},\n};\n\nmodule_phy_driver(mtk_socphy_driver);\n\nstatic struct mdio_device_id __maybe_unused mtk_socphy_tbl[] = {\n\t{ PHY_ID_MATCH_EXACT(MTK_GPHY_ID_MT7981) },\n\t{ PHY_ID_MATCH_EXACT(MTK_GPHY_ID_MT7988) },\n\t{ }\n};\n\nMODULE_DESCRIPTION(\"MediaTek SoC Gigabit Ethernet PHY driver\");\nMODULE_AUTHOR(\"Daniel Golle <daniel@makrotopia.org>\");\nMODULE_AUTHOR(\"SkyLake Huang <SkyLake.Huang@mediatek.com>\");\nMODULE_LICENSE(\"GPL\");\n\nMODULE_DEVICE_TABLE(mdio, mtk_socphy_tbl);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}