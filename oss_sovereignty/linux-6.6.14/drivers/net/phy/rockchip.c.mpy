{
  "module_name": "rockchip.c",
  "hash_id": "783aa80a0b1b726789c7096d618b1bbb841fbf59e8ef4103b5c76540ac680474",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/rockchip.c",
  "human_readable_source": "\n \n\n#include <linux/ethtool.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mii.h>\n#include <linux/netdevice.h>\n#include <linux/phy.h>\n\n#define INTERNAL_EPHY_ID\t\t\t0x1234d400\n\n#define MII_INTERNAL_CTRL_STATUS\t\t17\n#define SMI_ADDR_TSTCNTL\t\t\t20\n#define SMI_ADDR_TSTREAD1\t\t\t21\n#define SMI_ADDR_TSTREAD2\t\t\t22\n#define SMI_ADDR_TSTWRITE\t\t\t23\n#define MII_SPECIAL_CONTROL_STATUS\t\t31\n\n#define MII_AUTO_MDIX_EN\t\t\tBIT(7)\n#define MII_MDIX_EN\t\t\t\tBIT(6)\n\n#define MII_SPEED_10\t\t\t\tBIT(2)\n#define MII_SPEED_100\t\t\t\tBIT(3)\n\n#define TSTCNTL_RD\t\t\t\t(BIT(15) | BIT(10))\n#define TSTCNTL_WR\t\t\t\t(BIT(14) | BIT(10))\n\n#define TSTMODE_ENABLE\t\t\t\t0x400\n#define TSTMODE_DISABLE\t\t\t\t0x0\n\n#define WR_ADDR_A7CFG\t\t\t\t0x18\n\nstatic int rockchip_init_tstmode(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tret = phy_write(phydev, SMI_ADDR_TSTCNTL, TSTMODE_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = phy_write(phydev, SMI_ADDR_TSTCNTL, TSTMODE_DISABLE);\n\tif (ret)\n\t\treturn ret;\n\n\treturn phy_write(phydev, SMI_ADDR_TSTCNTL, TSTMODE_ENABLE);\n}\n\nstatic int rockchip_close_tstmode(struct phy_device *phydev)\n{\n\t \n\treturn phy_write(phydev, SMI_ADDR_TSTCNTL, TSTMODE_DISABLE);\n}\n\nstatic int rockchip_integrated_phy_analog_init(struct phy_device *phydev)\n{\n\tint ret;\n\n\tret = rockchip_init_tstmode(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = phy_write(phydev, SMI_ADDR_TSTWRITE, 0xB);\n\tif (ret)\n\t\treturn ret;\n\tret = phy_write(phydev, SMI_ADDR_TSTCNTL, TSTCNTL_WR | WR_ADDR_A7CFG);\n\tif (ret)\n\t\treturn ret;\n\n\treturn rockchip_close_tstmode(phydev);\n}\n\nstatic int rockchip_integrated_phy_config_init(struct phy_device *phydev)\n{\n\tint val, ret;\n\n\t \n\tval = phy_read(phydev, MII_INTERNAL_CTRL_STATUS);\n\tif (val < 0)\n\t\treturn val;\n\tval &= ~MII_AUTO_MDIX_EN;\n\tret = phy_write(phydev, MII_INTERNAL_CTRL_STATUS, val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn rockchip_integrated_phy_analog_init(phydev);\n}\n\nstatic void rockchip_link_change_notify(struct phy_device *phydev)\n{\n\t \n\tif (phydev->state == PHY_RUNNING && phydev->speed == SPEED_100) {\n\t\tint ret = rockchip_integrated_phy_analog_init(phydev);\n\n\t\tif (ret)\n\t\t\tphydev_err(phydev, \"rockchip_integrated_phy_analog_init err: %d.\\n\",\n\t\t\t\t   ret);\n\t}\n}\n\nstatic int rockchip_set_polarity(struct phy_device *phydev, int polarity)\n{\n\tint reg, err, val;\n\n\t \n\treg = phy_read(phydev, MII_INTERNAL_CTRL_STATUS);\n\tif (reg < 0)\n\t\treturn reg;\n\n\treg &= ~MII_AUTO_MDIX_EN;\n\tval = reg;\n\tswitch (polarity) {\n\tcase ETH_TP_MDI:\n\t\tval &= ~MII_MDIX_EN;\n\t\tbreak;\n\tcase ETH_TP_MDI_X:\n\t\tval |= MII_MDIX_EN;\n\t\tbreak;\n\tcase ETH_TP_MDI_AUTO:\n\tcase ETH_TP_MDI_INVALID:\n\tdefault:\n\t\treturn 0;\n\t}\n\n\tif (val != reg) {\n\t\t \n\t\terr = phy_write(phydev, MII_INTERNAL_CTRL_STATUS, val);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int rockchip_config_aneg(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = rockchip_set_polarity(phydev, phydev->mdix);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn genphy_config_aneg(phydev);\n}\n\nstatic int rockchip_phy_resume(struct phy_device *phydev)\n{\n\tgenphy_resume(phydev);\n\n\treturn rockchip_integrated_phy_config_init(phydev);\n}\n\nstatic struct phy_driver rockchip_phy_driver[] = {\n{\n\t.phy_id\t\t\t= INTERNAL_EPHY_ID,\n\t.phy_id_mask\t\t= 0xfffffff0,\n\t.name\t\t\t= \"Rockchip integrated EPHY\",\n\t \n\t.flags\t\t\t= 0,\n\t.link_change_notify\t= rockchip_link_change_notify,\n\t.soft_reset\t\t= genphy_soft_reset,\n\t.config_init\t\t= rockchip_integrated_phy_config_init,\n\t.config_aneg\t\t= rockchip_config_aneg,\n\t.suspend\t\t= genphy_suspend,\n\t.resume\t\t\t= rockchip_phy_resume,\n},\n};\n\nmodule_phy_driver(rockchip_phy_driver);\n\nstatic struct mdio_device_id __maybe_unused rockchip_phy_tbl[] = {\n\t{ INTERNAL_EPHY_ID, 0xfffffff0 },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(mdio, rockchip_phy_tbl);\n\nMODULE_AUTHOR(\"David Wu <david.wu@rock-chips.com>\");\nMODULE_DESCRIPTION(\"Rockchip Ethernet PHY driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}