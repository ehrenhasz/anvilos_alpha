{
  "module_name": "marvell.c",
  "hash_id": "170f1aa037873e24596934385d9866c3d9d770248feb419edca272be245ae118",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/marvell.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/ctype.h>\n#include <linux/errno.h>\n#include <linux/unistd.h>\n#include <linux/hwmon.h>\n#include <linux/interrupt.h>\n#include <linux/init.h>\n#include <linux/delay.h>\n#include <linux/netdevice.h>\n#include <linux/etherdevice.h>\n#include <linux/skbuff.h>\n#include <linux/spinlock.h>\n#include <linux/mm.h>\n#include <linux/module.h>\n#include <linux/mii.h>\n#include <linux/ethtool.h>\n#include <linux/ethtool_netlink.h>\n#include <linux/phy.h>\n#include <linux/marvell_phy.h>\n#include <linux/bitfield.h>\n#include <linux/of.h>\n#include <linux/sfp.h>\n\n#include <linux/io.h>\n#include <asm/irq.h>\n#include <linux/uaccess.h>\n\n#define MII_MARVELL_PHY_PAGE\t\t22\n#define MII_MARVELL_COPPER_PAGE\t\t0x00\n#define MII_MARVELL_FIBER_PAGE\t\t0x01\n#define MII_MARVELL_MSCR_PAGE\t\t0x02\n#define MII_MARVELL_LED_PAGE\t\t0x03\n#define MII_MARVELL_VCT5_PAGE\t\t0x05\n#define MII_MARVELL_MISC_TEST_PAGE\t0x06\n#define MII_MARVELL_VCT7_PAGE\t\t0x07\n#define MII_MARVELL_WOL_PAGE\t\t0x11\n#define MII_MARVELL_MODE_PAGE\t\t0x12\n\n#define MII_M1011_IEVENT\t\t0x13\n#define MII_M1011_IEVENT_CLEAR\t\t0x0000\n\n#define MII_M1011_IMASK\t\t\t0x12\n#define MII_M1011_IMASK_INIT\t\t0x6400\n#define MII_M1011_IMASK_CLEAR\t\t0x0000\n\n#define MII_M1011_PHY_SCR\t\t\t0x10\n#define MII_M1011_PHY_SCR_DOWNSHIFT_EN\t\tBIT(11)\n#define MII_M1011_PHY_SCR_DOWNSHIFT_MASK\tGENMASK(14, 12)\n#define MII_M1011_PHY_SCR_DOWNSHIFT_MAX\t\t8\n#define MII_M1011_PHY_SCR_MDI\t\t\t(0x0 << 5)\n#define MII_M1011_PHY_SCR_MDI_X\t\t\t(0x1 << 5)\n#define MII_M1011_PHY_SCR_AUTO_CROSS\t\t(0x3 << 5)\n\n#define MII_M1011_PHY_SSR\t\t\t0x11\n#define MII_M1011_PHY_SSR_DOWNSHIFT\t\tBIT(5)\n\n#define MII_M1111_PHY_LED_CONTROL\t0x18\n#define MII_M1111_PHY_LED_DIRECT\t0x4100\n#define MII_M1111_PHY_LED_COMBINE\t0x411c\n#define MII_M1111_PHY_EXT_CR\t\t0x14\n#define MII_M1111_PHY_EXT_CR_DOWNSHIFT_MASK\tGENMASK(11, 9)\n#define MII_M1111_PHY_EXT_CR_DOWNSHIFT_MAX\t8\n#define MII_M1111_PHY_EXT_CR_DOWNSHIFT_EN\tBIT(8)\n#define MII_M1111_RGMII_RX_DELAY\tBIT(7)\n#define MII_M1111_RGMII_TX_DELAY\tBIT(1)\n#define MII_M1111_PHY_EXT_SR\t\t0x1b\n\n#define MII_M1111_HWCFG_MODE_MASK\t\t0xf\n#define MII_M1111_HWCFG_MODE_FIBER_RGMII\t0x3\n#define MII_M1111_HWCFG_MODE_SGMII_NO_CLK\t0x4\n#define MII_M1111_HWCFG_MODE_RTBI\t\t0x7\n#define MII_M1111_HWCFG_MODE_COPPER_1000X_AN\t0x8\n#define MII_M1111_HWCFG_MODE_COPPER_RTBI\t0x9\n#define MII_M1111_HWCFG_MODE_COPPER_RGMII\t0xb\n#define MII_M1111_HWCFG_MODE_COPPER_1000X_NOAN\t0xc\n#define MII_M1111_HWCFG_SERIAL_AN_BYPASS\tBIT(12)\n#define MII_M1111_HWCFG_FIBER_COPPER_RES\tBIT(13)\n#define MII_M1111_HWCFG_FIBER_COPPER_AUTO\tBIT(15)\n\n#define MII_88E1121_PHY_MSCR_REG\t21\n#define MII_88E1121_PHY_MSCR_RX_DELAY\tBIT(5)\n#define MII_88E1121_PHY_MSCR_TX_DELAY\tBIT(4)\n#define MII_88E1121_PHY_MSCR_DELAY_MASK\t(BIT(5) | BIT(4))\n\n#define MII_88E1121_MISC_TEST\t\t\t\t0x1a\n#define MII_88E1510_MISC_TEST_TEMP_THRESHOLD_MASK\t0x1f00\n#define MII_88E1510_MISC_TEST_TEMP_THRESHOLD_SHIFT\t8\n#define MII_88E1510_MISC_TEST_TEMP_IRQ_EN\t\tBIT(7)\n#define MII_88E1510_MISC_TEST_TEMP_IRQ\t\t\tBIT(6)\n#define MII_88E1121_MISC_TEST_TEMP_SENSOR_EN\t\tBIT(5)\n#define MII_88E1121_MISC_TEST_TEMP_MASK\t\t\t0x1f\n\n#define MII_88E1510_TEMP_SENSOR\t\t0x1b\n#define MII_88E1510_TEMP_SENSOR_MASK\t0xff\n\n#define MII_88E1540_COPPER_CTRL3\t0x1a\n#define MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_MASK\tGENMASK(11, 10)\n#define MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_00MS\t0\n#define MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_10MS\t1\n#define MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_20MS\t2\n#define MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_40MS\t3\n#define MII_88E1540_COPPER_CTRL3_FAST_LINK_DOWN\t\tBIT(9)\n\n#define MII_88E6390_MISC_TEST\t\t0x1b\n#define MII_88E6390_MISC_TEST_TEMP_SENSOR_ENABLE_SAMPLE_1S\t(0x0 << 14)\n#define MII_88E6390_MISC_TEST_TEMP_SENSOR_ENABLE\t\t(0x1 << 14)\n#define MII_88E6390_MISC_TEST_TEMP_SENSOR_ENABLE_ONESHOT\t(0x2 << 14)\n#define MII_88E6390_MISC_TEST_TEMP_SENSOR_DISABLE\t\t(0x3 << 14)\n#define MII_88E6390_MISC_TEST_TEMP_SENSOR_MASK\t\t\t(0x3 << 14)\n#define MII_88E6393_MISC_TEST_SAMPLES_2048\t(0x0 << 11)\n#define MII_88E6393_MISC_TEST_SAMPLES_4096\t(0x1 << 11)\n#define MII_88E6393_MISC_TEST_SAMPLES_8192\t(0x2 << 11)\n#define MII_88E6393_MISC_TEST_SAMPLES_16384\t(0x3 << 11)\n#define MII_88E6393_MISC_TEST_SAMPLES_MASK\t(0x3 << 11)\n#define MII_88E6393_MISC_TEST_RATE_2_3MS\t(0x5 << 8)\n#define MII_88E6393_MISC_TEST_RATE_6_4MS\t(0x6 << 8)\n#define MII_88E6393_MISC_TEST_RATE_11_9MS\t(0x7 << 8)\n#define MII_88E6393_MISC_TEST_RATE_MASK\t\t(0x7 << 8)\n\n#define MII_88E6390_TEMP_SENSOR\t\t0x1c\n#define MII_88E6393_TEMP_SENSOR_THRESHOLD_MASK\t0xff00\n#define MII_88E6393_TEMP_SENSOR_THRESHOLD_SHIFT\t8\n#define MII_88E6390_TEMP_SENSOR_MASK\t\t0xff\n#define MII_88E6390_TEMP_SENSOR_SAMPLES\t\t10\n\n#define MII_88E1318S_PHY_MSCR1_REG\t16\n#define MII_88E1318S_PHY_MSCR1_PAD_ODD\tBIT(6)\n\n \n#define MII_88E1318S_PHY_CSIER\t\t\t\t0x12\n \n#define MII_88E1318S_PHY_CSIER_WOL_EIE\t\t\tBIT(7)\n\n#define MII_88E1318S_PHY_LED_FUNC\t\t0x10\n#define MII_88E1318S_PHY_LED_FUNC_OFF\t\t(0x8)\n#define MII_88E1318S_PHY_LED_FUNC_ON\t\t(0x9)\n#define MII_88E1318S_PHY_LED_FUNC_HI_Z\t\t(0xa)\n#define MII_88E1318S_PHY_LED_FUNC_BLINK\t\t(0xb)\n#define MII_88E1318S_PHY_LED_TCR\t\t0x12\n#define MII_88E1318S_PHY_LED_TCR_FORCE_INT\tBIT(15)\n#define MII_88E1318S_PHY_LED_TCR_INTn_ENABLE\tBIT(7)\n#define MII_88E1318S_PHY_LED_TCR_INT_ACTIVE_LOW\tBIT(11)\n\n \n#define MII_88E1318S_PHY_MAGIC_PACKET_WORD2\t\t0x17\n#define MII_88E1318S_PHY_MAGIC_PACKET_WORD1\t\t0x18\n#define MII_88E1318S_PHY_MAGIC_PACKET_WORD0\t\t0x19\n\n#define MII_88E1318S_PHY_WOL_CTRL\t\t\t\t0x10\n#define MII_88E1318S_PHY_WOL_CTRL_CLEAR_WOL_STATUS\t\tBIT(12)\n#define MII_88E1318S_PHY_WOL_CTRL_LINK_UP_ENABLE\t\tBIT(13)\n#define MII_88E1318S_PHY_WOL_CTRL_MAGIC_PACKET_MATCH_ENABLE\tBIT(14)\n\n#define MII_PHY_LED_CTRL\t        16\n#define MII_88E1121_PHY_LED_DEF\t\t0x0030\n#define MII_88E1510_PHY_LED_DEF\t\t0x1177\n#define MII_88E1510_PHY_LED0_LINK_LED1_ACTIVE\t0x1040\n\n#define MII_M1011_PHY_STATUS\t\t0x11\n#define MII_M1011_PHY_STATUS_1000\t0x8000\n#define MII_M1011_PHY_STATUS_100\t0x4000\n#define MII_M1011_PHY_STATUS_SPD_MASK\t0xc000\n#define MII_M1011_PHY_STATUS_FULLDUPLEX\t0x2000\n#define MII_M1011_PHY_STATUS_RESOLVED\t0x0800\n#define MII_M1011_PHY_STATUS_LINK\t0x0400\n\n#define MII_88E3016_PHY_SPEC_CTRL\t0x10\n#define MII_88E3016_DISABLE_SCRAMBLER\t0x0200\n#define MII_88E3016_AUTO_MDIX_CROSSOVER\t0x0030\n\n#define MII_88E1510_GEN_CTRL_REG_1\t\t0x14\n#define MII_88E1510_GEN_CTRL_REG_1_MODE_MASK\t0x7\n#define MII_88E1510_GEN_CTRL_REG_1_MODE_RGMII\t0x0\t \n#define MII_88E1510_GEN_CTRL_REG_1_MODE_SGMII\t0x1\t \n \n#define MII_88E1510_GEN_CTRL_REG_1_MODE_RGMII_1000X\t0x2\n \n#define MII_88E1510_GEN_CTRL_REG_1_MODE_RGMII_100FX\t0x3\n \n#define MII_88E1510_GEN_CTRL_REG_1_MODE_RGMII_SGMII\t0x4\n#define MII_88E1510_GEN_CTRL_REG_1_RESET\t0x8000\t \n\n#define MII_88E1510_MSCR_2\t\t0x15\n\n#define MII_VCT5_TX_RX_MDI0_COUPLING\t0x10\n#define MII_VCT5_TX_RX_MDI1_COUPLING\t0x11\n#define MII_VCT5_TX_RX_MDI2_COUPLING\t0x12\n#define MII_VCT5_TX_RX_MDI3_COUPLING\t0x13\n#define MII_VCT5_TX_RX_AMPLITUDE_MASK\t0x7f00\n#define MII_VCT5_TX_RX_AMPLITUDE_SHIFT\t8\n#define MII_VCT5_TX_RX_COUPLING_POSITIVE_REFLECTION\tBIT(15)\n\n#define MII_VCT5_CTRL\t\t\t\t0x17\n#define MII_VCT5_CTRL_ENABLE\t\t\t\tBIT(15)\n#define MII_VCT5_CTRL_COMPLETE\t\t\t\tBIT(14)\n#define MII_VCT5_CTRL_TX_SAME_CHANNEL\t\t\t(0x0 << 11)\n#define MII_VCT5_CTRL_TX0_CHANNEL\t\t\t(0x4 << 11)\n#define MII_VCT5_CTRL_TX1_CHANNEL\t\t\t(0x5 << 11)\n#define MII_VCT5_CTRL_TX2_CHANNEL\t\t\t(0x6 << 11)\n#define MII_VCT5_CTRL_TX3_CHANNEL\t\t\t(0x7 << 11)\n#define MII_VCT5_CTRL_SAMPLES_2\t\t\t\t(0x0 << 8)\n#define MII_VCT5_CTRL_SAMPLES_4\t\t\t\t(0x1 << 8)\n#define MII_VCT5_CTRL_SAMPLES_8\t\t\t\t(0x2 << 8)\n#define MII_VCT5_CTRL_SAMPLES_16\t\t\t(0x3 << 8)\n#define MII_VCT5_CTRL_SAMPLES_32\t\t\t(0x4 << 8)\n#define MII_VCT5_CTRL_SAMPLES_64\t\t\t(0x5 << 8)\n#define MII_VCT5_CTRL_SAMPLES_128\t\t\t(0x6 << 8)\n#define MII_VCT5_CTRL_SAMPLES_DEFAULT\t\t\t(0x6 << 8)\n#define MII_VCT5_CTRL_SAMPLES_256\t\t\t(0x7 << 8)\n#define MII_VCT5_CTRL_SAMPLES_SHIFT\t\t\t8\n#define MII_VCT5_CTRL_MODE_MAXIMUM_PEEK\t\t\t(0x0 << 6)\n#define MII_VCT5_CTRL_MODE_FIRST_LAST_PEEK\t\t(0x1 << 6)\n#define MII_VCT5_CTRL_MODE_OFFSET\t\t\t(0x2 << 6)\n#define MII_VCT5_CTRL_SAMPLE_POINT\t\t\t(0x3 << 6)\n#define MII_VCT5_CTRL_PEEK_HYST_DEFAULT\t\t\t3\n\n#define MII_VCT5_SAMPLE_POINT_DISTANCE\t\t0x18\n#define MII_VCT5_SAMPLE_POINT_DISTANCE_MAX\t511\n#define MII_VCT5_TX_PULSE_CTRL\t\t\t0x1c\n#define MII_VCT5_TX_PULSE_CTRL_DONT_WAIT_LINK_DOWN\tBIT(12)\n#define MII_VCT5_TX_PULSE_CTRL_PULSE_WIDTH_128nS\t(0x0 << 10)\n#define MII_VCT5_TX_PULSE_CTRL_PULSE_WIDTH_96nS\t\t(0x1 << 10)\n#define MII_VCT5_TX_PULSE_CTRL_PULSE_WIDTH_64nS\t\t(0x2 << 10)\n#define MII_VCT5_TX_PULSE_CTRL_PULSE_WIDTH_32nS\t\t(0x3 << 10)\n#define MII_VCT5_TX_PULSE_CTRL_PULSE_WIDTH_SHIFT\t10\n#define MII_VCT5_TX_PULSE_CTRL_PULSE_AMPLITUDE_1000mV\t(0x0 << 8)\n#define MII_VCT5_TX_PULSE_CTRL_PULSE_AMPLITUDE_750mV\t(0x1 << 8)\n#define MII_VCT5_TX_PULSE_CTRL_PULSE_AMPLITUDE_500mV\t(0x2 << 8)\n#define MII_VCT5_TX_PULSE_CTRL_PULSE_AMPLITUDE_250mV\t(0x3 << 8)\n#define MII_VCT5_TX_PULSE_CTRL_PULSE_AMPLITUDE_SHIFT\t8\n#define MII_VCT5_TX_PULSE_CTRL_MAX_AMP\t\t\tBIT(7)\n#define MII_VCT5_TX_PULSE_CTRL_GT_140m_46_86mV\t\t(0x6 << 0)\n\n \n#define TDR_SHORT_CABLE_LENGTH\t11\n\n#define MII_VCT7_PAIR_0_DISTANCE\t0x10\n#define MII_VCT7_PAIR_1_DISTANCE\t0x11\n#define MII_VCT7_PAIR_2_DISTANCE\t0x12\n#define MII_VCT7_PAIR_3_DISTANCE\t0x13\n\n#define MII_VCT7_RESULTS\t0x14\n#define MII_VCT7_RESULTS_PAIR3_MASK\t0xf000\n#define MII_VCT7_RESULTS_PAIR2_MASK\t0x0f00\n#define MII_VCT7_RESULTS_PAIR1_MASK\t0x00f0\n#define MII_VCT7_RESULTS_PAIR0_MASK\t0x000f\n#define MII_VCT7_RESULTS_PAIR3_SHIFT\t12\n#define MII_VCT7_RESULTS_PAIR2_SHIFT\t8\n#define MII_VCT7_RESULTS_PAIR1_SHIFT\t4\n#define MII_VCT7_RESULTS_PAIR0_SHIFT\t0\n#define MII_VCT7_RESULTS_INVALID\t0\n#define MII_VCT7_RESULTS_OK\t\t1\n#define MII_VCT7_RESULTS_OPEN\t\t2\n#define MII_VCT7_RESULTS_SAME_SHORT\t3\n#define MII_VCT7_RESULTS_CROSS_SHORT\t4\n#define MII_VCT7_RESULTS_BUSY\t\t9\n\n#define MII_VCT7_CTRL\t\t0x15\n#define MII_VCT7_CTRL_RUN_NOW\t\t\tBIT(15)\n#define MII_VCT7_CTRL_RUN_ANEG\t\t\tBIT(14)\n#define MII_VCT7_CTRL_DISABLE_CROSS\t\tBIT(13)\n#define MII_VCT7_CTRL_RUN_AFTER_BREAK_LINK\tBIT(12)\n#define MII_VCT7_CTRL_IN_PROGRESS\t\tBIT(11)\n#define MII_VCT7_CTRL_METERS\t\t\tBIT(10)\n#define MII_VCT7_CTRL_CENTIMETERS\t\t0\n\n#define LPA_PAUSE_FIBER\t\t0x180\n#define LPA_PAUSE_ASYM_FIBER\t0x100\n\n#define NB_FIBER_STATS\t1\n\nMODULE_DESCRIPTION(\"Marvell PHY driver\");\nMODULE_AUTHOR(\"Andy Fleming\");\nMODULE_LICENSE(\"GPL\");\n\nstruct marvell_hw_stat {\n\tconst char *string;\n\tu8 page;\n\tu8 reg;\n\tu8 bits;\n};\n\nstatic struct marvell_hw_stat marvell_hw_stats[] = {\n\t{ \"phy_receive_errors_copper\", 0, 21, 16},\n\t{ \"phy_idle_errors\", 0, 10, 8 },\n\t{ \"phy_receive_errors_fiber\", 1, 21, 16},\n};\n\nstruct marvell_priv {\n\tu64 stats[ARRAY_SIZE(marvell_hw_stats)];\n\tchar *hwmon_name;\n\tstruct device *hwmon_dev;\n\tbool cable_test_tdr;\n\tu32 first;\n\tu32 last;\n\tu32 step;\n\ts8 pair;\n};\n\nstatic int marvell_read_page(struct phy_device *phydev)\n{\n\treturn __phy_read(phydev, MII_MARVELL_PHY_PAGE);\n}\n\nstatic int marvell_write_page(struct phy_device *phydev, int page)\n{\n\treturn __phy_write(phydev, MII_MARVELL_PHY_PAGE, page);\n}\n\nstatic int marvell_set_page(struct phy_device *phydev, int page)\n{\n\treturn phy_write(phydev, MII_MARVELL_PHY_PAGE, page);\n}\n\nstatic int marvell_ack_interrupt(struct phy_device *phydev)\n{\n\tint err;\n\n\t \n\terr = phy_read(phydev, MII_M1011_IEVENT);\n\n\tif (err < 0)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic int marvell_config_intr(struct phy_device *phydev)\n{\n\tint err;\n\n\tif (phydev->interrupts == PHY_INTERRUPT_ENABLED) {\n\t\terr = marvell_ack_interrupt(phydev);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = phy_write(phydev, MII_M1011_IMASK,\n\t\t\t\tMII_M1011_IMASK_INIT);\n\t} else {\n\t\terr = phy_write(phydev, MII_M1011_IMASK,\n\t\t\t\tMII_M1011_IMASK_CLEAR);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = marvell_ack_interrupt(phydev);\n\t}\n\n\treturn err;\n}\n\nstatic irqreturn_t marvell_handle_interrupt(struct phy_device *phydev)\n{\n\tint irq_status;\n\n\tirq_status = phy_read(phydev, MII_M1011_IEVENT);\n\tif (irq_status < 0) {\n\t\tphy_error(phydev);\n\t\treturn IRQ_NONE;\n\t}\n\n\tif (!(irq_status & MII_M1011_IMASK_INIT))\n\t\treturn IRQ_NONE;\n\n\tphy_trigger_machine(phydev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int marvell_set_polarity(struct phy_device *phydev, int polarity)\n{\n\tu16 val;\n\n\tswitch (polarity) {\n\tcase ETH_TP_MDI:\n\t\tval = MII_M1011_PHY_SCR_MDI;\n\t\tbreak;\n\tcase ETH_TP_MDI_X:\n\t\tval = MII_M1011_PHY_SCR_MDI_X;\n\t\tbreak;\n\tcase ETH_TP_MDI_AUTO:\n\tcase ETH_TP_MDI_INVALID:\n\tdefault:\n\t\tval = MII_M1011_PHY_SCR_AUTO_CROSS;\n\t\tbreak;\n\t}\n\n\treturn phy_modify_changed(phydev, MII_M1011_PHY_SCR,\n\t\t\t\t  MII_M1011_PHY_SCR_AUTO_CROSS, val);\n}\n\nstatic int marvell_config_aneg(struct phy_device *phydev)\n{\n\tint changed = 0;\n\tint err;\n\n\terr = marvell_set_polarity(phydev, phydev->mdix_ctrl);\n\tif (err < 0)\n\t\treturn err;\n\n\tchanged = err;\n\n\terr = phy_write(phydev, MII_M1111_PHY_LED_CONTROL,\n\t\t\tMII_M1111_PHY_LED_DIRECT);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = genphy_config_aneg(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (phydev->autoneg != AUTONEG_ENABLE || changed) {\n\t\t \n\t\terr = genphy_soft_reset(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int m88e1101_config_aneg(struct phy_device *phydev)\n{\n\tint err;\n\n\t \n\terr = genphy_soft_reset(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = phy_write(phydev, 0x1d, 0x1f);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = phy_write(phydev, 0x1e, 0x200c);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = phy_write(phydev, 0x1d, 0x5);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = phy_write(phydev, 0x1e, 0);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = phy_write(phydev, 0x1e, 0x100);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn marvell_config_aneg(phydev);\n}\n\n#if IS_ENABLED(CONFIG_OF_MDIO)\n \nstatic int marvell_of_reg_init(struct phy_device *phydev)\n{\n\tconst __be32 *paddr;\n\tint len, i, saved_page, current_page, ret = 0;\n\n\tif (!phydev->mdio.dev.of_node)\n\t\treturn 0;\n\n\tpaddr = of_get_property(phydev->mdio.dev.of_node,\n\t\t\t\t\"marvell,reg-init\", &len);\n\tif (!paddr || len < (4 * sizeof(*paddr)))\n\t\treturn 0;\n\n\tsaved_page = phy_save_page(phydev);\n\tif (saved_page < 0)\n\t\tgoto err;\n\tcurrent_page = saved_page;\n\n\tlen /= sizeof(*paddr);\n\tfor (i = 0; i < len - 3; i += 4) {\n\t\tu16 page = be32_to_cpup(paddr + i);\n\t\tu16 reg = be32_to_cpup(paddr + i + 1);\n\t\tu16 mask = be32_to_cpup(paddr + i + 2);\n\t\tu16 val_bits = be32_to_cpup(paddr + i + 3);\n\t\tint val;\n\n\t\tif (page != current_page) {\n\t\t\tcurrent_page = page;\n\t\t\tret = marvell_write_page(phydev, page);\n\t\t\tif (ret < 0)\n\t\t\t\tgoto err;\n\t\t}\n\n\t\tval = 0;\n\t\tif (mask) {\n\t\t\tval = __phy_read(phydev, reg);\n\t\t\tif (val < 0) {\n\t\t\t\tret = val;\n\t\t\t\tgoto err;\n\t\t\t}\n\t\t\tval &= mask;\n\t\t}\n\t\tval |= val_bits;\n\n\t\tret = __phy_write(phydev, reg, val);\n\t\tif (ret < 0)\n\t\t\tgoto err;\n\t}\nerr:\n\treturn phy_restore_page(phydev, saved_page, ret);\n}\n#else\nstatic int marvell_of_reg_init(struct phy_device *phydev)\n{\n\treturn 0;\n}\n#endif  \n\nstatic int m88e1121_config_aneg_rgmii_delays(struct phy_device *phydev)\n{\n\tint mscr;\n\n\tif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID)\n\t\tmscr = MII_88E1121_PHY_MSCR_RX_DELAY |\n\t\t       MII_88E1121_PHY_MSCR_TX_DELAY;\n\telse if (phydev->interface == PHY_INTERFACE_MODE_RGMII_RXID)\n\t\tmscr = MII_88E1121_PHY_MSCR_RX_DELAY;\n\telse if (phydev->interface == PHY_INTERFACE_MODE_RGMII_TXID)\n\t\tmscr = MII_88E1121_PHY_MSCR_TX_DELAY;\n\telse\n\t\tmscr = 0;\n\n\treturn phy_modify_paged_changed(phydev, MII_MARVELL_MSCR_PAGE,\n\t\t\t\t\tMII_88E1121_PHY_MSCR_REG,\n\t\t\t\t\tMII_88E1121_PHY_MSCR_DELAY_MASK, mscr);\n}\n\nstatic int m88e1121_config_aneg(struct phy_device *phydev)\n{\n\tint changed = 0;\n\tint err = 0;\n\n\tif (phy_interface_is_rgmii(phydev)) {\n\t\terr = m88e1121_config_aneg_rgmii_delays(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\tchanged = err;\n\n\terr = marvell_set_polarity(phydev, phydev->mdix_ctrl);\n\tif (err < 0)\n\t\treturn err;\n\n\tchanged |= err;\n\n\terr = genphy_config_aneg(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (phydev->autoneg != AUTONEG_ENABLE || changed) {\n\t\t \n\t\terr = genphy_soft_reset(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int m88e1318_config_aneg(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = phy_modify_paged(phydev, MII_MARVELL_MSCR_PAGE,\n\t\t\t       MII_88E1318S_PHY_MSCR1_REG,\n\t\t\t       0, MII_88E1318S_PHY_MSCR1_PAD_ODD);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn m88e1121_config_aneg(phydev);\n}\n\n \nstatic inline u32 linkmode_adv_to_fiber_adv_t(unsigned long *advertise)\n{\n\tu32 result = 0;\n\n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_1000baseT_Half_BIT, advertise))\n\t\tresult |= ADVERTISE_1000XHALF;\n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_1000baseT_Full_BIT, advertise))\n\t\tresult |= ADVERTISE_1000XFULL;\n\n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_Asym_Pause_BIT, advertise) &&\n\t    linkmode_test_bit(ETHTOOL_LINK_MODE_Pause_BIT, advertise))\n\t\tresult |= ADVERTISE_1000XPSE_ASYM;\n\telse if (linkmode_test_bit(ETHTOOL_LINK_MODE_Pause_BIT, advertise))\n\t\tresult |= ADVERTISE_1000XPAUSE;\n\n\treturn result;\n}\n\n \nstatic int marvell_config_aneg_fiber(struct phy_device *phydev)\n{\n\tint changed = 0;\n\tint err;\n\tu16 adv;\n\n\tif (phydev->autoneg != AUTONEG_ENABLE)\n\t\treturn genphy_setup_forced(phydev);\n\n\t \n\tlinkmode_and(phydev->advertising, phydev->advertising,\n\t\t     phydev->supported);\n\n\tadv = linkmode_adv_to_fiber_adv_t(phydev->advertising);\n\n\t \n\terr = phy_modify_changed(phydev, MII_ADVERTISE,\n\t\t\t\t ADVERTISE_1000XHALF | ADVERTISE_1000XFULL |\n\t\t\t\t ADVERTISE_1000XPAUSE | ADVERTISE_1000XPSE_ASYM,\n\t\t\t\t adv);\n\tif (err < 0)\n\t\treturn err;\n\tif (err > 0)\n\t\tchanged = 1;\n\n\treturn genphy_check_and_restart_aneg(phydev, changed);\n}\n\nstatic int m88e1111_config_aneg(struct phy_device *phydev)\n{\n\tint extsr = phy_read(phydev, MII_M1111_PHY_EXT_SR);\n\tint err;\n\n\tif (extsr < 0)\n\t\treturn extsr;\n\n\t \n\tif (phydev->interface != PHY_INTERFACE_MODE_SGMII &&\n\t    (extsr & MII_M1111_HWCFG_MODE_MASK) !=\n\t    MII_M1111_HWCFG_MODE_COPPER_1000X_AN)\n\t\treturn marvell_config_aneg(phydev);\n\n\terr = marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\tif (err < 0)\n\t\tgoto error;\n\n\t \n\terr = marvell_config_aneg(phydev);\n\tif (err < 0)\n\t\tgoto error;\n\n\t \n\terr = marvell_set_page(phydev, MII_MARVELL_FIBER_PAGE);\n\tif (err < 0)\n\t\tgoto error;\n\n\tif (phydev->interface == PHY_INTERFACE_MODE_SGMII)\n\t\t \n\t\terr = genphy_check_and_restart_aneg(phydev, false);\n\telse\n\t\terr = marvell_config_aneg_fiber(phydev);\n\tif (err < 0)\n\t\tgoto error;\n\n\treturn marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\nerror:\n\tmarvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\treturn err;\n}\n\nstatic int m88e1510_config_aneg(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\tif (err < 0)\n\t\tgoto error;\n\n\t \n\terr = m88e1318_config_aneg(phydev);\n\tif (err < 0)\n\t\tgoto error;\n\n\t \n\tif (phydev->interface == PHY_INTERFACE_MODE_SGMII)\n\t\treturn 0;\n\n\t \n\terr = marvell_set_page(phydev, MII_MARVELL_FIBER_PAGE);\n\tif (err < 0)\n\t\tgoto error;\n\n\terr = marvell_config_aneg_fiber(phydev);\n\tif (err < 0)\n\t\tgoto error;\n\n\treturn marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\nerror:\n\tmarvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\treturn err;\n}\n\nstatic void marvell_config_led(struct phy_device *phydev)\n{\n\tu16 def_config;\n\tint err;\n\n\tswitch (MARVELL_PHY_FAMILY_ID(phydev->phy_id)) {\n\t \n\tcase MARVELL_PHY_FAMILY_ID(MARVELL_PHY_ID_88E1121R):\n\tcase MARVELL_PHY_FAMILY_ID(MARVELL_PHY_ID_88E1318S):\n\t\tdef_config = MII_88E1121_PHY_LED_DEF;\n\t\tbreak;\n\t \n\tcase MARVELL_PHY_FAMILY_ID(MARVELL_PHY_ID_88E1510):\n\t\tif (phydev->dev_flags & MARVELL_PHY_LED0_LINK_LED1_ACTIVE)\n\t\t\tdef_config = MII_88E1510_PHY_LED0_LINK_LED1_ACTIVE;\n\t\telse\n\t\t\tdef_config = MII_88E1510_PHY_LED_DEF;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\terr = phy_write_paged(phydev, MII_MARVELL_LED_PAGE, MII_PHY_LED_CTRL,\n\t\t\t      def_config);\n\tif (err < 0)\n\t\tphydev_warn(phydev, \"Fail to config marvell phy LED.\\n\");\n}\n\nstatic int marvell_config_init(struct phy_device *phydev)\n{\n\t \n\tmarvell_config_led(phydev);\n\n\t \n\treturn marvell_of_reg_init(phydev);\n}\n\nstatic int m88e3016_config_init(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tret = phy_modify(phydev, MII_88E3016_PHY_SPEC_CTRL,\n\t\t\t MII_88E3016_DISABLE_SCRAMBLER,\n\t\t\t MII_88E3016_AUTO_MDIX_CROSSOVER);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn marvell_config_init(phydev);\n}\n\nstatic int m88e1111_config_init_hwcfg_mode(struct phy_device *phydev,\n\t\t\t\t\t   u16 mode,\n\t\t\t\t\t   int fibre_copper_auto)\n{\n\tif (fibre_copper_auto)\n\t\tmode |= MII_M1111_HWCFG_FIBER_COPPER_AUTO;\n\n\treturn phy_modify(phydev, MII_M1111_PHY_EXT_SR,\n\t\t\t  MII_M1111_HWCFG_MODE_MASK |\n\t\t\t  MII_M1111_HWCFG_FIBER_COPPER_AUTO |\n\t\t\t  MII_M1111_HWCFG_FIBER_COPPER_RES,\n\t\t\t  mode);\n}\n\nstatic int m88e1111_config_init_rgmii_delays(struct phy_device *phydev)\n{\n\tint delay;\n\n\tswitch (phydev->interface) {\n\tcase PHY_INTERFACE_MODE_RGMII_ID:\n\t\tdelay = MII_M1111_RGMII_RX_DELAY | MII_M1111_RGMII_TX_DELAY;\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_RGMII_RXID:\n\t\tdelay = MII_M1111_RGMII_RX_DELAY;\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_RGMII_TXID:\n\t\tdelay = MII_M1111_RGMII_TX_DELAY;\n\t\tbreak;\n\tdefault:\n\t\tdelay = 0;\n\t\tbreak;\n\t}\n\n\treturn phy_modify(phydev, MII_M1111_PHY_EXT_CR,\n\t\t\t  MII_M1111_RGMII_RX_DELAY | MII_M1111_RGMII_TX_DELAY,\n\t\t\t  delay);\n}\n\nstatic int m88e1111_config_init_rgmii(struct phy_device *phydev)\n{\n\tint temp;\n\tint err;\n\n\terr = m88e1111_config_init_rgmii_delays(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\ttemp = phy_read(phydev, MII_M1111_PHY_EXT_SR);\n\tif (temp < 0)\n\t\treturn temp;\n\n\ttemp &= ~(MII_M1111_HWCFG_MODE_MASK);\n\n\tif (temp & MII_M1111_HWCFG_FIBER_COPPER_RES)\n\t\ttemp |= MII_M1111_HWCFG_MODE_FIBER_RGMII;\n\telse\n\t\ttemp |= MII_M1111_HWCFG_MODE_COPPER_RGMII;\n\n\treturn phy_write(phydev, MII_M1111_PHY_EXT_SR, temp);\n}\n\nstatic int m88e1111_config_init_sgmii(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = m88e1111_config_init_hwcfg_mode(\n\t\tphydev,\n\t\tMII_M1111_HWCFG_MODE_SGMII_NO_CLK,\n\t\tMII_M1111_HWCFG_FIBER_COPPER_AUTO);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\treturn marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n}\n\nstatic int m88e1111_config_init_rtbi(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = m88e1111_config_init_rgmii_delays(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = m88e1111_config_init_hwcfg_mode(\n\t\tphydev,\n\t\tMII_M1111_HWCFG_MODE_RTBI,\n\t\tMII_M1111_HWCFG_FIBER_COPPER_AUTO);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\terr = genphy_soft_reset(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn m88e1111_config_init_hwcfg_mode(\n\t\tphydev,\n\t\tMII_M1111_HWCFG_MODE_RTBI,\n\t\tMII_M1111_HWCFG_FIBER_COPPER_AUTO);\n}\n\nstatic int m88e1111_config_init_1000basex(struct phy_device *phydev)\n{\n\tint extsr = phy_read(phydev, MII_M1111_PHY_EXT_SR);\n\tint err, mode;\n\n\tif (extsr < 0)\n\t\treturn extsr;\n\n\t \n\tmode = extsr & MII_M1111_HWCFG_MODE_MASK;\n\tif (mode == MII_M1111_HWCFG_MODE_COPPER_1000X_NOAN) {\n\t\terr = phy_modify(phydev, MII_M1111_PHY_EXT_SR,\n\t\t\t\t MII_M1111_HWCFG_MODE_MASK |\n\t\t\t\t MII_M1111_HWCFG_SERIAL_AN_BYPASS,\n\t\t\t\t MII_M1111_HWCFG_MODE_COPPER_1000X_AN |\n\t\t\t\t MII_M1111_HWCFG_SERIAL_AN_BYPASS);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\treturn 0;\n}\n\nstatic int m88e1111_config_init(struct phy_device *phydev)\n{\n\tint err;\n\n\tif (phy_interface_is_rgmii(phydev)) {\n\t\terr = m88e1111_config_init_rgmii(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\tif (phydev->interface == PHY_INTERFACE_MODE_SGMII) {\n\t\terr = m88e1111_config_init_sgmii(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\tif (phydev->interface == PHY_INTERFACE_MODE_RTBI) {\n\t\terr = m88e1111_config_init_rtbi(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\tif (phydev->interface == PHY_INTERFACE_MODE_1000BASEX) {\n\t\terr = m88e1111_config_init_1000basex(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\terr = marvell_of_reg_init(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = genphy_soft_reset(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (phydev->interface == PHY_INTERFACE_MODE_SGMII) {\n\t\t \n\t\terr = genphy_read_abilities(phydev);\n\t\tlinkmode_or(phydev->advertising, phydev->advertising,\n\t\t\t    phydev->supported);\n\t}\n\treturn err;\n}\n\nstatic int m88e1111_get_downshift(struct phy_device *phydev, u8 *data)\n{\n\tint val, cnt, enable;\n\n\tval = phy_read(phydev, MII_M1111_PHY_EXT_CR);\n\tif (val < 0)\n\t\treturn val;\n\n\tenable = FIELD_GET(MII_M1111_PHY_EXT_CR_DOWNSHIFT_EN, val);\n\tcnt = FIELD_GET(MII_M1111_PHY_EXT_CR_DOWNSHIFT_MASK, val) + 1;\n\n\t*data = enable ? cnt : DOWNSHIFT_DEV_DISABLE;\n\n\treturn 0;\n}\n\nstatic int m88e1111_set_downshift(struct phy_device *phydev, u8 cnt)\n{\n\tint val, err;\n\n\tif (cnt > MII_M1111_PHY_EXT_CR_DOWNSHIFT_MAX)\n\t\treturn -E2BIG;\n\n\tif (!cnt) {\n\t\terr = phy_clear_bits(phydev, MII_M1111_PHY_EXT_CR,\n\t\t\t\t     MII_M1111_PHY_EXT_CR_DOWNSHIFT_EN);\n\t} else {\n\t\tval = MII_M1111_PHY_EXT_CR_DOWNSHIFT_EN;\n\t\tval |= FIELD_PREP(MII_M1111_PHY_EXT_CR_DOWNSHIFT_MASK, cnt - 1);\n\n\t\terr = phy_modify(phydev, MII_M1111_PHY_EXT_CR,\n\t\t\t\t MII_M1111_PHY_EXT_CR_DOWNSHIFT_EN |\n\t\t\t\t MII_M1111_PHY_EXT_CR_DOWNSHIFT_MASK,\n\t\t\t\t val);\n\t}\n\n\tif (err < 0)\n\t\treturn err;\n\n\treturn genphy_soft_reset(phydev);\n}\n\nstatic int m88e1111_get_tunable(struct phy_device *phydev,\n\t\t\t\tstruct ethtool_tunable *tuna, void *data)\n{\n\tswitch (tuna->id) {\n\tcase ETHTOOL_PHY_DOWNSHIFT:\n\t\treturn m88e1111_get_downshift(phydev, data);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int m88e1111_set_tunable(struct phy_device *phydev,\n\t\t\t\tstruct ethtool_tunable *tuna, const void *data)\n{\n\tswitch (tuna->id) {\n\tcase ETHTOOL_PHY_DOWNSHIFT:\n\t\treturn m88e1111_set_downshift(phydev, *(const u8 *)data);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int m88e1011_get_downshift(struct phy_device *phydev, u8 *data)\n{\n\tint val, cnt, enable;\n\n\tval = phy_read(phydev, MII_M1011_PHY_SCR);\n\tif (val < 0)\n\t\treturn val;\n\n\tenable = FIELD_GET(MII_M1011_PHY_SCR_DOWNSHIFT_EN, val);\n\tcnt = FIELD_GET(MII_M1011_PHY_SCR_DOWNSHIFT_MASK, val) + 1;\n\n\t*data = enable ? cnt : DOWNSHIFT_DEV_DISABLE;\n\n\treturn 0;\n}\n\nstatic int m88e1011_set_downshift(struct phy_device *phydev, u8 cnt)\n{\n\tint val, err;\n\n\tif (cnt > MII_M1011_PHY_SCR_DOWNSHIFT_MAX)\n\t\treturn -E2BIG;\n\n\tif (!cnt) {\n\t\terr = phy_clear_bits(phydev, MII_M1011_PHY_SCR,\n\t\t\t\t     MII_M1011_PHY_SCR_DOWNSHIFT_EN);\n\t} else {\n\t\tval = MII_M1011_PHY_SCR_DOWNSHIFT_EN;\n\t\tval |= FIELD_PREP(MII_M1011_PHY_SCR_DOWNSHIFT_MASK, cnt - 1);\n\n\t\terr = phy_modify(phydev, MII_M1011_PHY_SCR,\n\t\t\t\t MII_M1011_PHY_SCR_DOWNSHIFT_EN |\n\t\t\t\t MII_M1011_PHY_SCR_DOWNSHIFT_MASK,\n\t\t\t\t val);\n\t}\n\n\tif (err < 0)\n\t\treturn err;\n\n\treturn genphy_soft_reset(phydev);\n}\n\nstatic int m88e1011_get_tunable(struct phy_device *phydev,\n\t\t\t\tstruct ethtool_tunable *tuna, void *data)\n{\n\tswitch (tuna->id) {\n\tcase ETHTOOL_PHY_DOWNSHIFT:\n\t\treturn m88e1011_get_downshift(phydev, data);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int m88e1011_set_tunable(struct phy_device *phydev,\n\t\t\t\tstruct ethtool_tunable *tuna, const void *data)\n{\n\tswitch (tuna->id) {\n\tcase ETHTOOL_PHY_DOWNSHIFT:\n\t\treturn m88e1011_set_downshift(phydev, *(const u8 *)data);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int m88e1112_config_init(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = m88e1011_set_downshift(phydev, 3);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn m88e1111_config_init(phydev);\n}\n\nstatic int m88e1111gbe_config_init(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = m88e1111_set_downshift(phydev, 3);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn m88e1111_config_init(phydev);\n}\n\nstatic int marvell_1011gbe_config_init(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = m88e1011_set_downshift(phydev, 3);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn marvell_config_init(phydev);\n}\nstatic int m88e1116r_config_init(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = genphy_soft_reset(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\tmsleep(500);\n\n\terr = marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = marvell_set_polarity(phydev, phydev->mdix_ctrl);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = m88e1011_set_downshift(phydev, 8);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (phy_interface_is_rgmii(phydev)) {\n\t\terr = m88e1121_config_aneg_rgmii_delays(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\terr = genphy_soft_reset(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn marvell_config_init(phydev);\n}\n\nstatic int m88e1318_config_init(struct phy_device *phydev)\n{\n\tif (phy_interrupt_is_valid(phydev)) {\n\t\tint err = phy_modify_paged(\n\t\t\tphydev, MII_MARVELL_LED_PAGE,\n\t\t\tMII_88E1318S_PHY_LED_TCR,\n\t\t\tMII_88E1318S_PHY_LED_TCR_FORCE_INT,\n\t\t\tMII_88E1318S_PHY_LED_TCR_INTn_ENABLE |\n\t\t\tMII_88E1318S_PHY_LED_TCR_INT_ACTIVE_LOW);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\treturn marvell_config_init(phydev);\n}\n\nstatic int m88e1510_config_init(struct phy_device *phydev)\n{\n\tstatic const struct {\n\t\tu16 reg17, reg16;\n\t} errata_vals[] = {\n\t\t{ 0x214b, 0x2144 },\n\t\t{ 0x0c28, 0x2146 },\n\t\t{ 0xb233, 0x214d },\n\t\t{ 0xcc0c, 0x2159 },\n\t};\n\tint err;\n\tint i;\n\n\t \n\terr = marvell_set_page(phydev, 0x00FF);\n\tif (err < 0)\n\t\treturn err;\n\n\tfor (i = 0; i < ARRAY_SIZE(errata_vals); ++i) {\n\t\terr = phy_write(phydev, 17, errata_vals[i].reg17);\n\t\tif (err)\n\t\t\treturn err;\n\t\terr = phy_write(phydev, 16, errata_vals[i].reg16);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\terr = marvell_set_page(phydev, 0x00FB);\n\tif (err < 0)\n\t\treturn err;\n\terr = phy_write(phydev, 07, 0xC00D);\n\tif (err < 0)\n\t\treturn err;\n\terr = marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\tif (phydev->interface == PHY_INTERFACE_MODE_SGMII) {\n\t\t \n\t\terr = marvell_set_page(phydev, 18);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\t \n\t\terr = phy_modify(phydev, MII_88E1510_GEN_CTRL_REG_1,\n\t\t\t\t MII_88E1510_GEN_CTRL_REG_1_MODE_MASK,\n\t\t\t\t MII_88E1510_GEN_CTRL_REG_1_MODE_SGMII);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\t \n\t\terr = phy_set_bits(phydev, MII_88E1510_GEN_CTRL_REG_1,\n\t\t\t\t   MII_88E1510_GEN_CTRL_REG_1_RESET);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\t \n\t\terr = marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\terr = m88e1011_set_downshift(phydev, 3);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn m88e1318_config_init(phydev);\n}\n\nstatic int m88e1118_config_aneg(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = marvell_set_polarity(phydev, phydev->mdix_ctrl);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = genphy_config_aneg(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn genphy_soft_reset(phydev);\n}\n\nstatic int m88e1118_config_init(struct phy_device *phydev)\n{\n\tu16 leds;\n\tint err;\n\n\t \n\terr = phy_write_paged(phydev, MII_MARVELL_MSCR_PAGE,\n\t\t\t      MII_88E1121_PHY_MSCR_REG, 0x1070);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (phy_interface_is_rgmii(phydev)) {\n\t\terr = m88e1121_config_aneg_rgmii_delays(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\t \n\tif (phydev->dev_flags & MARVELL_PHY_M1118_DNS323_LEDS)\n\t\tleds = 0x1100;\n\telse\n\t\tleds = 0x021e;\n\n\terr = phy_write_paged(phydev, MII_MARVELL_LED_PAGE, 0x10, leds);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = marvell_of_reg_init(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\terr = marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn genphy_soft_reset(phydev);\n}\n\nstatic int m88e1149_config_init(struct phy_device *phydev)\n{\n\tint err;\n\n\t \n\terr = marvell_set_page(phydev, MII_MARVELL_MSCR_PAGE);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\terr = phy_write(phydev, 0x15, 0x1048);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = marvell_of_reg_init(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\t \n\terr = marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn genphy_soft_reset(phydev);\n}\n\nstatic int m88e1145_config_init_rgmii(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = m88e1111_config_init_rgmii_delays(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (phydev->dev_flags & MARVELL_PHY_M1145_FLAGS_RESISTANCE) {\n\t\terr = phy_write(phydev, 0x1d, 0x0012);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\terr = phy_modify(phydev, 0x1e, 0x0fc0,\n\t\t\t\t 2 << 9 |  \n\t\t\t\t 2 << 6);  \n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\terr = phy_write(phydev, 0x1d, 0x3);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\terr = phy_write(phydev, 0x1e, 0x8000);\n\t}\n\treturn err;\n}\n\nstatic int m88e1145_config_init_sgmii(struct phy_device *phydev)\n{\n\treturn m88e1111_config_init_hwcfg_mode(\n\t\tphydev, MII_M1111_HWCFG_MODE_SGMII_NO_CLK,\n\t\tMII_M1111_HWCFG_FIBER_COPPER_AUTO);\n}\n\nstatic int m88e1145_config_init(struct phy_device *phydev)\n{\n\tint err;\n\n\t \n\terr = phy_write(phydev, 0x1d, 0x001b);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = phy_write(phydev, 0x1e, 0x418f);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = phy_write(phydev, 0x1d, 0x0016);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = phy_write(phydev, 0x1e, 0xa2da);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID) {\n\t\terr = m88e1145_config_init_rgmii(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\n\tif (phydev->interface == PHY_INTERFACE_MODE_SGMII) {\n\t\terr = m88e1145_config_init_sgmii(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t}\n\terr = m88e1111_set_downshift(phydev, 3);\n\tif (err < 0)\n\t\treturn err;\n\n\terr = marvell_of_reg_init(phydev);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic int m88e1540_get_fld(struct phy_device *phydev, u8 *msecs)\n{\n\tint val;\n\n\tval = phy_read(phydev, MII_88E1540_COPPER_CTRL3);\n\tif (val < 0)\n\t\treturn val;\n\n\tif (!(val & MII_88E1540_COPPER_CTRL3_FAST_LINK_DOWN)) {\n\t\t*msecs = ETHTOOL_PHY_FAST_LINK_DOWN_OFF;\n\t\treturn 0;\n\t}\n\n\tval = FIELD_GET(MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_MASK, val);\n\n\tswitch (val) {\n\tcase MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_00MS:\n\t\t*msecs = 0;\n\t\tbreak;\n\tcase MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_10MS:\n\t\t*msecs = 10;\n\t\tbreak;\n\tcase MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_20MS:\n\t\t*msecs = 20;\n\t\tbreak;\n\tcase MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_40MS:\n\t\t*msecs = 40;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int m88e1540_set_fld(struct phy_device *phydev, const u8 *msecs)\n{\n\tstruct ethtool_eee eee;\n\tint val, ret;\n\n\tif (*msecs == ETHTOOL_PHY_FAST_LINK_DOWN_OFF)\n\t\treturn phy_clear_bits(phydev, MII_88E1540_COPPER_CTRL3,\n\t\t\t\t      MII_88E1540_COPPER_CTRL3_FAST_LINK_DOWN);\n\n\t \n\tret = genphy_c45_ethtool_get_eee(phydev, &eee);\n\tif (!ret && eee.eee_enabled) {\n\t\tphydev_warn(phydev, \"Fast Link Down detection requires EEE to be disabled!\\n\");\n\t\treturn -EBUSY;\n\t}\n\n\tif (*msecs <= 5)\n\t\tval = MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_00MS;\n\telse if (*msecs <= 15)\n\t\tval = MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_10MS;\n\telse if (*msecs <= 30)\n\t\tval = MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_20MS;\n\telse\n\t\tval = MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_40MS;\n\n\tval = FIELD_PREP(MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_MASK, val);\n\n\tret = phy_modify(phydev, MII_88E1540_COPPER_CTRL3,\n\t\t\t MII_88E1540_COPPER_CTRL3_LINK_DOWN_DELAY_MASK, val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn phy_set_bits(phydev, MII_88E1540_COPPER_CTRL3,\n\t\t\t    MII_88E1540_COPPER_CTRL3_FAST_LINK_DOWN);\n}\n\nstatic int m88e1540_get_tunable(struct phy_device *phydev,\n\t\t\t\tstruct ethtool_tunable *tuna, void *data)\n{\n\tswitch (tuna->id) {\n\tcase ETHTOOL_PHY_FAST_LINK_DOWN:\n\t\treturn m88e1540_get_fld(phydev, data);\n\tcase ETHTOOL_PHY_DOWNSHIFT:\n\t\treturn m88e1011_get_downshift(phydev, data);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int m88e1540_set_tunable(struct phy_device *phydev,\n\t\t\t\tstruct ethtool_tunable *tuna, const void *data)\n{\n\tswitch (tuna->id) {\n\tcase ETHTOOL_PHY_FAST_LINK_DOWN:\n\t\treturn m88e1540_set_fld(phydev, data);\n\tcase ETHTOOL_PHY_DOWNSHIFT:\n\t\treturn m88e1011_set_downshift(phydev, *(const u8 *)data);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\n \nstatic int m88e6390_errata(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = phy_write(phydev, MII_BMCR,\n\t\t\tBMCR_ANENABLE | BMCR_SPEED1000 | BMCR_FULLDPLX);\n\tif (err)\n\t\treturn err;\n\n\tusleep_range(300, 400);\n\n\terr = phy_write_paged(phydev, 0xf8, 0x08, 0x36);\n\tif (err)\n\t\treturn err;\n\n\treturn genphy_soft_reset(phydev);\n}\n\nstatic int m88e6390_config_aneg(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = m88e6390_errata(phydev);\n\tif (err)\n\t\treturn err;\n\n\treturn m88e1510_config_aneg(phydev);\n}\n\n \nstatic void fiber_lpa_mod_linkmode_lpa_t(unsigned long *advertising, u32 lpa)\n{\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_1000baseT_Half_BIT,\n\t\t\t advertising, lpa & LPA_1000XHALF);\n\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_1000baseT_Full_BIT,\n\t\t\t advertising, lpa & LPA_1000XFULL);\n}\n\nstatic int marvell_read_status_page_an(struct phy_device *phydev,\n\t\t\t\t       int fiber, int status)\n{\n\tint lpa;\n\tint err;\n\n\tif (!(status & MII_M1011_PHY_STATUS_RESOLVED)) {\n\t\tphydev->link = 0;\n\t\treturn 0;\n\t}\n\n\tif (status & MII_M1011_PHY_STATUS_FULLDUPLEX)\n\t\tphydev->duplex = DUPLEX_FULL;\n\telse\n\t\tphydev->duplex = DUPLEX_HALF;\n\n\tswitch (status & MII_M1011_PHY_STATUS_SPD_MASK) {\n\tcase MII_M1011_PHY_STATUS_1000:\n\t\tphydev->speed = SPEED_1000;\n\t\tbreak;\n\n\tcase MII_M1011_PHY_STATUS_100:\n\t\tphydev->speed = SPEED_100;\n\t\tbreak;\n\n\tdefault:\n\t\tphydev->speed = SPEED_10;\n\t\tbreak;\n\t}\n\n\tif (!fiber) {\n\t\terr = genphy_read_lpa(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\tphy_resolve_aneg_pause(phydev);\n\t} else {\n\t\tlpa = phy_read(phydev, MII_LPA);\n\t\tif (lpa < 0)\n\t\t\treturn lpa;\n\n\t\t \n\t\tfiber_lpa_mod_linkmode_lpa_t(phydev->lp_advertising, lpa);\n\n\t\tif (phydev->duplex == DUPLEX_FULL) {\n\t\t\tif (!(lpa & LPA_PAUSE_FIBER)) {\n\t\t\t\tphydev->pause = 0;\n\t\t\t\tphydev->asym_pause = 0;\n\t\t\t} else if ((lpa & LPA_PAUSE_ASYM_FIBER)) {\n\t\t\t\tphydev->pause = 1;\n\t\t\t\tphydev->asym_pause = 1;\n\t\t\t} else {\n\t\t\t\tphydev->pause = 1;\n\t\t\t\tphydev->asym_pause = 0;\n\t\t\t}\n\t\t}\n\t}\n\n\treturn 0;\n}\n\n \nstatic int marvell_read_status_page(struct phy_device *phydev, int page)\n{\n\tint status;\n\tint fiber;\n\tint err;\n\n\tstatus = phy_read(phydev, MII_M1011_PHY_STATUS);\n\tif (status < 0)\n\t\treturn status;\n\n\t \n\tif (page == MII_MARVELL_FIBER_PAGE) {\n\t\tphydev->link = !!(status & MII_M1011_PHY_STATUS_LINK);\n\t} else {\n\t\terr = genphy_update_link(phydev);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\tif (page == MII_MARVELL_FIBER_PAGE)\n\t\tfiber = 1;\n\telse\n\t\tfiber = 0;\n\n\tlinkmode_zero(phydev->lp_advertising);\n\tphydev->pause = 0;\n\tphydev->asym_pause = 0;\n\tphydev->speed = SPEED_UNKNOWN;\n\tphydev->duplex = DUPLEX_UNKNOWN;\n\tphydev->port = fiber ? PORT_FIBRE : PORT_TP;\n\n\tif (phydev->autoneg == AUTONEG_ENABLE)\n\t\terr = marvell_read_status_page_an(phydev, fiber, status);\n\telse\n\t\terr = genphy_read_status_fixed(phydev);\n\n\treturn err;\n}\n\n \nstatic int marvell_read_status(struct phy_device *phydev)\n{\n\tint err;\n\n\t \n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_FIBRE_BIT,\n\t\t\t      phydev->supported) &&\n\t    phydev->interface != PHY_INTERFACE_MODE_SGMII) {\n\t\terr = marvell_set_page(phydev, MII_MARVELL_FIBER_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\terr = marvell_read_status_page(phydev, MII_MARVELL_FIBER_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\tif (phydev->link)\n\t\t\treturn 0;\n\n\t\t \n\t\terr = marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t}\n\n\treturn marvell_read_status_page(phydev, MII_MARVELL_COPPER_PAGE);\n\nerror:\n\tmarvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\treturn err;\n}\n\n \nstatic int marvell_suspend(struct phy_device *phydev)\n{\n\tint err;\n\n\t \n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_FIBRE_BIT,\n\t\t\t      phydev->supported)) {\n\t\terr = marvell_set_page(phydev, MII_MARVELL_FIBER_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\terr = genphy_suspend(phydev);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\terr = marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t}\n\n\t \n\treturn genphy_suspend(phydev);\n\nerror:\n\tmarvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\treturn err;\n}\n\n \nstatic int marvell_resume(struct phy_device *phydev)\n{\n\tint err;\n\n\t \n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_FIBRE_BIT,\n\t\t\t      phydev->supported)) {\n\t\terr = marvell_set_page(phydev, MII_MARVELL_FIBER_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\terr = genphy_resume(phydev);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\terr = marvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t}\n\n\t \n\treturn genphy_resume(phydev);\n\nerror:\n\tmarvell_set_page(phydev, MII_MARVELL_COPPER_PAGE);\n\treturn err;\n}\n\nstatic int marvell_aneg_done(struct phy_device *phydev)\n{\n\tint retval = phy_read(phydev, MII_M1011_PHY_STATUS);\n\n\treturn (retval < 0) ? retval : (retval & MII_M1011_PHY_STATUS_RESOLVED);\n}\n\nstatic void m88e1318_get_wol(struct phy_device *phydev,\n\t\t\t     struct ethtool_wolinfo *wol)\n{\n\tint ret;\n\n\twol->supported = WAKE_MAGIC | WAKE_PHY;\n\twol->wolopts = 0;\n\n\tret = phy_read_paged(phydev, MII_MARVELL_WOL_PAGE,\n\t\t\t     MII_88E1318S_PHY_WOL_CTRL);\n\tif (ret < 0)\n\t\treturn;\n\n\tif (ret & MII_88E1318S_PHY_WOL_CTRL_MAGIC_PACKET_MATCH_ENABLE)\n\t\twol->wolopts |= WAKE_MAGIC;\n\n\tif (ret & MII_88E1318S_PHY_WOL_CTRL_LINK_UP_ENABLE)\n\t\twol->wolopts |= WAKE_PHY;\n}\n\nstatic int m88e1318_set_wol(struct phy_device *phydev,\n\t\t\t    struct ethtool_wolinfo *wol)\n{\n\tint err = 0, oldpage;\n\n\toldpage = phy_save_page(phydev);\n\tif (oldpage < 0)\n\t\tgoto error;\n\n\tif (wol->wolopts & (WAKE_MAGIC | WAKE_PHY)) {\n\t\t \n\t\terr = marvell_write_page(phydev, MII_MARVELL_COPPER_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\tif (!phy_interrupt_is_valid(phydev))\n\t\t\t__phy_read(phydev, MII_M1011_IEVENT);\n\n\t\t \n\t\terr = __phy_set_bits(phydev, MII_88E1318S_PHY_CSIER,\n\t\t\t\t     MII_88E1318S_PHY_CSIER_WOL_EIE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\terr = marvell_write_page(phydev, MII_MARVELL_LED_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\terr = __phy_modify(phydev, MII_88E1318S_PHY_LED_TCR,\n\t\t\t\t   MII_88E1318S_PHY_LED_TCR_FORCE_INT,\n\t\t\t\t   MII_88E1318S_PHY_LED_TCR_INTn_ENABLE |\n\t\t\t\t   MII_88E1318S_PHY_LED_TCR_INT_ACTIVE_LOW);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t}\n\n\tif (wol->wolopts & WAKE_MAGIC) {\n\t\terr = marvell_write_page(phydev, MII_MARVELL_WOL_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\terr = __phy_write(phydev, MII_88E1318S_PHY_MAGIC_PACKET_WORD2,\n\t\t\t\t((phydev->attached_dev->dev_addr[5] << 8) |\n\t\t\t\t phydev->attached_dev->dev_addr[4]));\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t\terr = __phy_write(phydev, MII_88E1318S_PHY_MAGIC_PACKET_WORD1,\n\t\t\t\t((phydev->attached_dev->dev_addr[3] << 8) |\n\t\t\t\t phydev->attached_dev->dev_addr[2]));\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t\terr = __phy_write(phydev, MII_88E1318S_PHY_MAGIC_PACKET_WORD0,\n\t\t\t\t((phydev->attached_dev->dev_addr[1] << 8) |\n\t\t\t\t phydev->attached_dev->dev_addr[0]));\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\terr = __phy_set_bits(phydev, MII_88E1318S_PHY_WOL_CTRL,\n\t\t\t\t     MII_88E1318S_PHY_WOL_CTRL_CLEAR_WOL_STATUS |\n\t\t\t\t     MII_88E1318S_PHY_WOL_CTRL_MAGIC_PACKET_MATCH_ENABLE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t} else {\n\t\terr = marvell_write_page(phydev, MII_MARVELL_WOL_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\terr = __phy_modify(phydev, MII_88E1318S_PHY_WOL_CTRL,\n\t\t\t\t   MII_88E1318S_PHY_WOL_CTRL_MAGIC_PACKET_MATCH_ENABLE,\n\t\t\t\t   MII_88E1318S_PHY_WOL_CTRL_CLEAR_WOL_STATUS);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t}\n\n\tif (wol->wolopts & WAKE_PHY) {\n\t\terr = marvell_write_page(phydev, MII_MARVELL_WOL_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\terr = __phy_modify(phydev, MII_88E1318S_PHY_WOL_CTRL, 0,\n\t\t\t\t   MII_88E1318S_PHY_WOL_CTRL_CLEAR_WOL_STATUS |\n\t\t\t\t   MII_88E1318S_PHY_WOL_CTRL_LINK_UP_ENABLE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t} else {\n\t\terr = marvell_write_page(phydev, MII_MARVELL_WOL_PAGE);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\n\t\t \n\t\terr = __phy_modify(phydev, MII_88E1318S_PHY_WOL_CTRL,\n\t\t\t\t   MII_88E1318S_PHY_WOL_CTRL_LINK_UP_ENABLE,\n\t\t\t\t   MII_88E1318S_PHY_WOL_CTRL_CLEAR_WOL_STATUS);\n\t\tif (err < 0)\n\t\t\tgoto error;\n\t}\n\nerror:\n\treturn phy_restore_page(phydev, oldpage, err);\n}\n\nstatic int marvell_get_sset_count(struct phy_device *phydev)\n{\n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_FIBRE_BIT,\n\t\t\t      phydev->supported))\n\t\treturn ARRAY_SIZE(marvell_hw_stats);\n\telse\n\t\treturn ARRAY_SIZE(marvell_hw_stats) - NB_FIBER_STATS;\n}\n\nstatic void marvell_get_strings(struct phy_device *phydev, u8 *data)\n{\n\tint count = marvell_get_sset_count(phydev);\n\tint i;\n\n\tfor (i = 0; i < count; i++) {\n\t\tstrscpy(data + i * ETH_GSTRING_LEN,\n\t\t\tmarvell_hw_stats[i].string, ETH_GSTRING_LEN);\n\t}\n}\n\nstatic u64 marvell_get_stat(struct phy_device *phydev, int i)\n{\n\tstruct marvell_hw_stat stat = marvell_hw_stats[i];\n\tstruct marvell_priv *priv = phydev->priv;\n\tint val;\n\tu64 ret;\n\n\tval = phy_read_paged(phydev, stat.page, stat.reg);\n\tif (val < 0) {\n\t\tret = U64_MAX;\n\t} else {\n\t\tval = val & ((1 << stat.bits) - 1);\n\t\tpriv->stats[i] += val;\n\t\tret = priv->stats[i];\n\t}\n\n\treturn ret;\n}\n\nstatic void marvell_get_stats(struct phy_device *phydev,\n\t\t\t      struct ethtool_stats *stats, u64 *data)\n{\n\tint count = marvell_get_sset_count(phydev);\n\tint i;\n\n\tfor (i = 0; i < count; i++)\n\t\tdata[i] = marvell_get_stat(phydev, i);\n}\n\nstatic int m88e1510_loopback(struct phy_device *phydev, bool enable)\n{\n\tint err;\n\n\tif (enable) {\n\t\tu16 bmcr_ctl, mscr2_ctl = 0;\n\n\t\tbmcr_ctl = mii_bmcr_encode_fixed(phydev->speed, phydev->duplex);\n\n\t\terr = phy_write(phydev, MII_BMCR, bmcr_ctl);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\tif (phydev->speed == SPEED_1000)\n\t\t\tmscr2_ctl = BMCR_SPEED1000;\n\t\telse if (phydev->speed == SPEED_100)\n\t\t\tmscr2_ctl = BMCR_SPEED100;\n\n\t\terr = phy_modify_paged(phydev, MII_MARVELL_MSCR_PAGE,\n\t\t\t\t       MII_88E1510_MSCR_2, BMCR_SPEED1000 |\n\t\t\t\t       BMCR_SPEED100, mscr2_ctl);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\t \n\t\terr = genphy_soft_reset(phydev);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\terr = phy_modify(phydev, MII_BMCR, BMCR_LOOPBACK,\n\t\t\t\t BMCR_LOOPBACK);\n\n\t\tif (!err) {\n\t\t\t \n\t\t\tmsleep(1000);\n\t\t}\n\t\treturn err;\n\t} else {\n\t\terr = phy_modify(phydev, MII_BMCR, BMCR_LOOPBACK, 0);\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\treturn phy_config_aneg(phydev);\n\t}\n}\n\nstatic int marvell_vct5_wait_complete(struct phy_device *phydev)\n{\n\tint i;\n\tint val;\n\n\tfor (i = 0; i < 32; i++) {\n\t\tval = __phy_read(phydev, MII_VCT5_CTRL);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\tif (val & MII_VCT5_CTRL_COMPLETE)\n\t\t\treturn 0;\n\t}\n\n\tphydev_err(phydev, \"Timeout while waiting for cable test to finish\\n\");\n\treturn -ETIMEDOUT;\n}\n\nstatic int marvell_vct5_amplitude(struct phy_device *phydev, int pair)\n{\n\tint amplitude;\n\tint val;\n\tint reg;\n\n\treg = MII_VCT5_TX_RX_MDI0_COUPLING + pair;\n\tval = __phy_read(phydev, reg);\n\n\tif (val < 0)\n\t\treturn 0;\n\n\tamplitude = (val & MII_VCT5_TX_RX_AMPLITUDE_MASK) >>\n\t\tMII_VCT5_TX_RX_AMPLITUDE_SHIFT;\n\n\tif (!(val & MII_VCT5_TX_RX_COUPLING_POSITIVE_REFLECTION))\n\t\tamplitude = -amplitude;\n\n\treturn 1000 * amplitude / 128;\n}\n\nstatic u32 marvell_vct5_distance2cm(int distance)\n{\n\treturn distance * 805 / 10;\n}\n\nstatic u32 marvell_vct5_cm2distance(int cm)\n{\n\treturn cm * 10 / 805;\n}\n\nstatic int marvell_vct5_amplitude_distance(struct phy_device *phydev,\n\t\t\t\t\t   int distance, int pair)\n{\n\tu16 reg;\n\tint err;\n\tint mV;\n\tint i;\n\n\terr = __phy_write(phydev, MII_VCT5_SAMPLE_POINT_DISTANCE,\n\t\t\t  distance);\n\tif (err)\n\t\treturn err;\n\n\treg = MII_VCT5_CTRL_ENABLE |\n\t\tMII_VCT5_CTRL_TX_SAME_CHANNEL |\n\t\tMII_VCT5_CTRL_SAMPLES_DEFAULT |\n\t\tMII_VCT5_CTRL_SAMPLE_POINT |\n\t\tMII_VCT5_CTRL_PEEK_HYST_DEFAULT;\n\terr = __phy_write(phydev, MII_VCT5_CTRL, reg);\n\tif (err)\n\t\treturn err;\n\n\terr = marvell_vct5_wait_complete(phydev);\n\tif (err)\n\t\treturn err;\n\n\tfor (i = 0; i < 4; i++) {\n\t\tif (pair != PHY_PAIR_ALL && i != pair)\n\t\t\tcontinue;\n\n\t\tmV = marvell_vct5_amplitude(phydev, i);\n\t\tethnl_cable_test_amplitude(phydev, i, mV);\n\t}\n\n\treturn 0;\n}\n\nstatic int marvell_vct5_amplitude_graph(struct phy_device *phydev)\n{\n\tstruct marvell_priv *priv = phydev->priv;\n\tint distance;\n\tu16 width;\n\tint page;\n\tint err;\n\tu16 reg;\n\n\tif (priv->first <= TDR_SHORT_CABLE_LENGTH)\n\t\twidth = MII_VCT5_TX_PULSE_CTRL_PULSE_WIDTH_32nS;\n\telse\n\t\twidth = MII_VCT5_TX_PULSE_CTRL_PULSE_WIDTH_128nS;\n\n\treg = MII_VCT5_TX_PULSE_CTRL_GT_140m_46_86mV |\n\t\tMII_VCT5_TX_PULSE_CTRL_DONT_WAIT_LINK_DOWN |\n\t\tMII_VCT5_TX_PULSE_CTRL_MAX_AMP | width;\n\n\terr = phy_write_paged(phydev, MII_MARVELL_VCT5_PAGE,\n\t\t\t      MII_VCT5_TX_PULSE_CTRL, reg);\n\tif (err)\n\t\treturn err;\n\n\t \n\tpage = phy_select_page(phydev, MII_MARVELL_VCT5_PAGE);\n\tif (page < 0)\n\t\tgoto restore_page;\n\n\tfor (distance = priv->first;\n\t     distance <= priv->last;\n\t     distance += priv->step) {\n\t\terr = marvell_vct5_amplitude_distance(phydev, distance,\n\t\t\t\t\t\t      priv->pair);\n\t\tif (err)\n\t\t\tgoto restore_page;\n\n\t\tif (distance > TDR_SHORT_CABLE_LENGTH &&\n\t\t    width == MII_VCT5_TX_PULSE_CTRL_PULSE_WIDTH_32nS) {\n\t\t\twidth = MII_VCT5_TX_PULSE_CTRL_PULSE_WIDTH_128nS;\n\t\t\treg = MII_VCT5_TX_PULSE_CTRL_GT_140m_46_86mV |\n\t\t\t\tMII_VCT5_TX_PULSE_CTRL_DONT_WAIT_LINK_DOWN |\n\t\t\t\tMII_VCT5_TX_PULSE_CTRL_MAX_AMP | width;\n\t\t\terr = __phy_write(phydev, MII_VCT5_TX_PULSE_CTRL, reg);\n\t\t\tif (err)\n\t\t\t\tgoto restore_page;\n\t\t}\n\t}\n\nrestore_page:\n\treturn phy_restore_page(phydev, page, err);\n}\n\nstatic int marvell_cable_test_start_common(struct phy_device *phydev)\n{\n\tint bmcr, bmsr, ret;\n\n\t \n\tbmcr = phy_read(phydev, MII_BMCR);\n\tif (bmcr < 0)\n\t\treturn bmcr;\n\n\tbmsr = phy_read(phydev, MII_BMSR);\n\n\tif (bmsr < 0)\n\t\treturn bmsr;\n\n\tif (bmcr & BMCR_ANENABLE) {\n\t\tret =  phy_clear_bits(phydev, MII_BMCR, BMCR_ANENABLE);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tret = genphy_soft_reset(phydev);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (bmsr & BMSR_LSTATUS)\n\t\tmsleep(1500);\n\n\treturn 0;\n}\n\nstatic int marvell_vct7_cable_test_start(struct phy_device *phydev)\n{\n\tstruct marvell_priv *priv = phydev->priv;\n\tint ret;\n\n\tret = marvell_cable_test_start_common(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\tpriv->cable_test_tdr = false;\n\n\t \n\tret = phy_write_paged(phydev, MII_MARVELL_VCT5_PAGE,\n\t\t\t      MII_VCT5_CTRL,\n\t\t\t      MII_VCT5_CTRL_TX_SAME_CHANNEL |\n\t\t\t      MII_VCT5_CTRL_SAMPLES_DEFAULT |\n\t\t\t      MII_VCT5_CTRL_MODE_MAXIMUM_PEEK |\n\t\t\t      MII_VCT5_CTRL_PEEK_HYST_DEFAULT);\n\tif (ret)\n\t\treturn ret;\n\n\tret = phy_write_paged(phydev, MII_MARVELL_VCT5_PAGE,\n\t\t\t      MII_VCT5_SAMPLE_POINT_DISTANCE, 0);\n\tif (ret)\n\t\treturn ret;\n\n\treturn phy_write_paged(phydev, MII_MARVELL_VCT7_PAGE,\n\t\t\t       MII_VCT7_CTRL,\n\t\t\t       MII_VCT7_CTRL_RUN_NOW |\n\t\t\t       MII_VCT7_CTRL_CENTIMETERS);\n}\n\nstatic int marvell_vct5_cable_test_tdr_start(struct phy_device *phydev,\n\t\t\t\t\t     const struct phy_tdr_config *cfg)\n{\n\tstruct marvell_priv *priv = phydev->priv;\n\tint ret;\n\n\tpriv->cable_test_tdr = true;\n\tpriv->first = marvell_vct5_cm2distance(cfg->first);\n\tpriv->last = marvell_vct5_cm2distance(cfg->last);\n\tpriv->step = marvell_vct5_cm2distance(cfg->step);\n\tpriv->pair = cfg->pair;\n\n\tif (priv->first > MII_VCT5_SAMPLE_POINT_DISTANCE_MAX)\n\t\treturn -EINVAL;\n\n\tif (priv->last > MII_VCT5_SAMPLE_POINT_DISTANCE_MAX)\n\t\treturn -EINVAL;\n\n\t \n\tret = phy_write_paged(phydev, MII_MARVELL_VCT7_PAGE,\n\t\t\t      MII_VCT7_CTRL, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tret = marvell_cable_test_start_common(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\tret = ethnl_cable_test_pulse(phydev, 1000);\n\tif (ret)\n\t\treturn ret;\n\n\treturn ethnl_cable_test_step(phydev,\n\t\t\t\t     marvell_vct5_distance2cm(priv->first),\n\t\t\t\t     marvell_vct5_distance2cm(priv->last),\n\t\t\t\t     marvell_vct5_distance2cm(priv->step));\n}\n\nstatic int marvell_vct7_distance_to_length(int distance, bool meter)\n{\n\tif (meter)\n\t\tdistance *= 100;\n\n\treturn distance;\n}\n\nstatic bool marvell_vct7_distance_valid(int result)\n{\n\tswitch (result) {\n\tcase MII_VCT7_RESULTS_OPEN:\n\tcase MII_VCT7_RESULTS_SAME_SHORT:\n\tcase MII_VCT7_RESULTS_CROSS_SHORT:\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic int marvell_vct7_report_length(struct phy_device *phydev,\n\t\t\t\t      int pair, bool meter)\n{\n\tint length;\n\tint ret;\n\n\tret = phy_read_paged(phydev, MII_MARVELL_VCT7_PAGE,\n\t\t\t     MII_VCT7_PAIR_0_DISTANCE + pair);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tlength = marvell_vct7_distance_to_length(ret, meter);\n\n\tethnl_cable_test_fault_length(phydev, pair, length);\n\n\treturn 0;\n}\n\nstatic int marvell_vct7_cable_test_report_trans(int result)\n{\n\tswitch (result) {\n\tcase MII_VCT7_RESULTS_OK:\n\t\treturn ETHTOOL_A_CABLE_RESULT_CODE_OK;\n\tcase MII_VCT7_RESULTS_OPEN:\n\t\treturn ETHTOOL_A_CABLE_RESULT_CODE_OPEN;\n\tcase MII_VCT7_RESULTS_SAME_SHORT:\n\t\treturn ETHTOOL_A_CABLE_RESULT_CODE_SAME_SHORT;\n\tcase MII_VCT7_RESULTS_CROSS_SHORT:\n\t\treturn ETHTOOL_A_CABLE_RESULT_CODE_CROSS_SHORT;\n\tdefault:\n\t\treturn ETHTOOL_A_CABLE_RESULT_CODE_UNSPEC;\n\t}\n}\n\nstatic int marvell_vct7_cable_test_report(struct phy_device *phydev)\n{\n\tint pair0, pair1, pair2, pair3;\n\tbool meter;\n\tint ret;\n\n\tret = phy_read_paged(phydev, MII_MARVELL_VCT7_PAGE,\n\t\t\t     MII_VCT7_RESULTS);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tpair3 = (ret & MII_VCT7_RESULTS_PAIR3_MASK) >>\n\t\tMII_VCT7_RESULTS_PAIR3_SHIFT;\n\tpair2 = (ret & MII_VCT7_RESULTS_PAIR2_MASK) >>\n\t\tMII_VCT7_RESULTS_PAIR2_SHIFT;\n\tpair1 = (ret & MII_VCT7_RESULTS_PAIR1_MASK) >>\n\t\tMII_VCT7_RESULTS_PAIR1_SHIFT;\n\tpair0 = (ret & MII_VCT7_RESULTS_PAIR0_MASK) >>\n\t\tMII_VCT7_RESULTS_PAIR0_SHIFT;\n\n\tethnl_cable_test_result(phydev, ETHTOOL_A_CABLE_PAIR_A,\n\t\t\t\tmarvell_vct7_cable_test_report_trans(pair0));\n\tethnl_cable_test_result(phydev, ETHTOOL_A_CABLE_PAIR_B,\n\t\t\t\tmarvell_vct7_cable_test_report_trans(pair1));\n\tethnl_cable_test_result(phydev, ETHTOOL_A_CABLE_PAIR_C,\n\t\t\t\tmarvell_vct7_cable_test_report_trans(pair2));\n\tethnl_cable_test_result(phydev, ETHTOOL_A_CABLE_PAIR_D,\n\t\t\t\tmarvell_vct7_cable_test_report_trans(pair3));\n\n\tret = phy_read_paged(phydev, MII_MARVELL_VCT7_PAGE, MII_VCT7_CTRL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tmeter = ret & MII_VCT7_CTRL_METERS;\n\n\tif (marvell_vct7_distance_valid(pair0))\n\t\tmarvell_vct7_report_length(phydev, 0, meter);\n\tif (marvell_vct7_distance_valid(pair1))\n\t\tmarvell_vct7_report_length(phydev, 1, meter);\n\tif (marvell_vct7_distance_valid(pair2))\n\t\tmarvell_vct7_report_length(phydev, 2, meter);\n\tif (marvell_vct7_distance_valid(pair3))\n\t\tmarvell_vct7_report_length(phydev, 3, meter);\n\n\treturn 0;\n}\n\nstatic int marvell_vct7_cable_test_get_status(struct phy_device *phydev,\n\t\t\t\t\t      bool *finished)\n{\n\tstruct marvell_priv *priv = phydev->priv;\n\tint ret;\n\n\tif (priv->cable_test_tdr) {\n\t\tret = marvell_vct5_amplitude_graph(phydev);\n\t\t*finished = true;\n\t\treturn ret;\n\t}\n\n\t*finished = false;\n\n\tret = phy_read_paged(phydev, MII_MARVELL_VCT7_PAGE,\n\t\t\t     MII_VCT7_CTRL);\n\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (!(ret & MII_VCT7_CTRL_IN_PROGRESS)) {\n\t\t*finished = true;\n\n\t\treturn marvell_vct7_cable_test_report(phydev);\n\t}\n\n\treturn 0;\n}\n\n#ifdef CONFIG_HWMON\nstruct marvell_hwmon_ops {\n\tint (*config)(struct phy_device *phydev);\n\tint (*get_temp)(struct phy_device *phydev, long *temp);\n\tint (*get_temp_critical)(struct phy_device *phydev, long *temp);\n\tint (*set_temp_critical)(struct phy_device *phydev, long temp);\n\tint (*get_temp_alarm)(struct phy_device *phydev, long *alarm);\n};\n\nstatic const struct marvell_hwmon_ops *\nto_marvell_hwmon_ops(const struct phy_device *phydev)\n{\n\treturn phydev->drv->driver_data;\n}\n\nstatic int m88e1121_get_temp(struct phy_device *phydev, long *temp)\n{\n\tint oldpage;\n\tint ret = 0;\n\tint val;\n\n\t*temp = 0;\n\n\toldpage = phy_select_page(phydev, MII_MARVELL_MISC_TEST_PAGE);\n\tif (oldpage < 0)\n\t\tgoto error;\n\n\t \n\tret = __phy_read(phydev, MII_88E1121_MISC_TEST);\n\tif (ret < 0)\n\t\tgoto error;\n\n\tret = __phy_write(phydev, MII_88E1121_MISC_TEST,\n\t\t\t  ret | MII_88E1121_MISC_TEST_TEMP_SENSOR_EN);\n\tif (ret < 0)\n\t\tgoto error;\n\n\t \n\tusleep_range(10000, 12000);\n\n\tval = __phy_read(phydev, MII_88E1121_MISC_TEST);\n\tif (val < 0) {\n\t\tret = val;\n\t\tgoto error;\n\t}\n\n\t \n\tret = __phy_write(phydev, MII_88E1121_MISC_TEST,\n\t\t\t  ret & ~MII_88E1121_MISC_TEST_TEMP_SENSOR_EN);\n\tif (ret < 0)\n\t\tgoto error;\n\n\t*temp = ((val & MII_88E1121_MISC_TEST_TEMP_MASK) - 5) * 5000;\n\nerror:\n\treturn phy_restore_page(phydev, oldpage, ret);\n}\n\nstatic int m88e1510_get_temp(struct phy_device *phydev, long *temp)\n{\n\tint ret;\n\n\t*temp = 0;\n\n\tret = phy_read_paged(phydev, MII_MARVELL_MISC_TEST_PAGE,\n\t\t\t     MII_88E1510_TEMP_SENSOR);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*temp = ((ret & MII_88E1510_TEMP_SENSOR_MASK) - 25) * 1000;\n\n\treturn 0;\n}\n\nstatic int m88e1510_get_temp_critical(struct phy_device *phydev, long *temp)\n{\n\tint ret;\n\n\t*temp = 0;\n\n\tret = phy_read_paged(phydev, MII_MARVELL_MISC_TEST_PAGE,\n\t\t\t     MII_88E1121_MISC_TEST);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*temp = (((ret & MII_88E1510_MISC_TEST_TEMP_THRESHOLD_MASK) >>\n\t\t  MII_88E1510_MISC_TEST_TEMP_THRESHOLD_SHIFT) * 5) - 25;\n\t \n\t*temp *= 1000;\n\n\treturn 0;\n}\n\nstatic int m88e1510_set_temp_critical(struct phy_device *phydev, long temp)\n{\n\ttemp = temp / 1000;\n\ttemp = clamp_val(DIV_ROUND_CLOSEST(temp, 5) + 5, 0, 0x1f);\n\n\treturn phy_modify_paged(phydev, MII_MARVELL_MISC_TEST_PAGE,\n\t\t\t\tMII_88E1121_MISC_TEST,\n\t\t\t\tMII_88E1510_MISC_TEST_TEMP_THRESHOLD_MASK,\n\t\t\t\ttemp << MII_88E1510_MISC_TEST_TEMP_THRESHOLD_SHIFT);\n}\n\nstatic int m88e1510_get_temp_alarm(struct phy_device *phydev, long *alarm)\n{\n\tint ret;\n\n\t*alarm = false;\n\n\tret = phy_read_paged(phydev, MII_MARVELL_MISC_TEST_PAGE,\n\t\t\t     MII_88E1121_MISC_TEST);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*alarm = !!(ret & MII_88E1510_MISC_TEST_TEMP_IRQ);\n\n\treturn 0;\n}\n\nstatic int m88e6390_get_temp(struct phy_device *phydev, long *temp)\n{\n\tint sum = 0;\n\tint oldpage;\n\tint ret = 0;\n\tint i;\n\n\t*temp = 0;\n\n\toldpage = phy_select_page(phydev, MII_MARVELL_MISC_TEST_PAGE);\n\tif (oldpage < 0)\n\t\tgoto error;\n\n\t \n\tret = __phy_read(phydev, MII_88E6390_MISC_TEST);\n\tif (ret < 0)\n\t\tgoto error;\n\n\tret &= ~MII_88E6390_MISC_TEST_TEMP_SENSOR_MASK;\n\tret |= MII_88E6390_MISC_TEST_TEMP_SENSOR_ENABLE_SAMPLE_1S;\n\n\tret = __phy_write(phydev, MII_88E6390_MISC_TEST, ret);\n\tif (ret < 0)\n\t\tgoto error;\n\n\t \n\tusleep_range(10000, 12000);\n\n\t \n\tfor (i = 0; i < MII_88E6390_TEMP_SENSOR_SAMPLES; i++) {\n\t\tret = __phy_read(phydev, MII_88E6390_TEMP_SENSOR);\n\t\tif (ret < 0)\n\t\t\tgoto error;\n\t\tsum += ret & MII_88E6390_TEMP_SENSOR_MASK;\n\t}\n\n\tsum /= MII_88E6390_TEMP_SENSOR_SAMPLES;\n\t*temp = (sum  - 75) * 1000;\n\n\t \n\tret = __phy_read(phydev, MII_88E6390_MISC_TEST);\n\tif (ret < 0)\n\t\tgoto error;\n\n\tret = ret & ~MII_88E6390_MISC_TEST_TEMP_SENSOR_MASK;\n\tret |= MII_88E6390_MISC_TEST_TEMP_SENSOR_DISABLE;\n\n\tret = __phy_write(phydev, MII_88E6390_MISC_TEST, ret);\n\nerror:\n\tphy_restore_page(phydev, oldpage, ret);\n\n\treturn ret;\n}\n\nstatic int m88e6393_get_temp(struct phy_device *phydev, long *temp)\n{\n\tint err;\n\n\terr = m88e1510_get_temp(phydev, temp);\n\n\t \n\t*temp -= 50000;\n\n\treturn err;\n}\n\nstatic int m88e6393_get_temp_critical(struct phy_device *phydev, long *temp)\n{\n\tint ret;\n\n\t*temp = 0;\n\n\tret = phy_read_paged(phydev, MII_MARVELL_MISC_TEST_PAGE,\n\t\t\t     MII_88E6390_TEMP_SENSOR);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*temp = (((ret & MII_88E6393_TEMP_SENSOR_THRESHOLD_MASK) >>\n\t\t  MII_88E6393_TEMP_SENSOR_THRESHOLD_SHIFT) - 75) * 1000;\n\n\treturn 0;\n}\n\nstatic int m88e6393_set_temp_critical(struct phy_device *phydev, long temp)\n{\n\ttemp = (temp / 1000) + 75;\n\n\treturn phy_modify_paged(phydev, MII_MARVELL_MISC_TEST_PAGE,\n\t\t\t\tMII_88E6390_TEMP_SENSOR,\n\t\t\t\tMII_88E6393_TEMP_SENSOR_THRESHOLD_MASK,\n\t\t\t\ttemp << MII_88E6393_TEMP_SENSOR_THRESHOLD_SHIFT);\n}\n\nstatic int m88e6393_hwmon_config(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = m88e6393_set_temp_critical(phydev, 100000);\n\tif (err)\n\t\treturn err;\n\n\treturn phy_modify_paged(phydev, MII_MARVELL_MISC_TEST_PAGE,\n\t\t\t\tMII_88E6390_MISC_TEST,\n\t\t\t\tMII_88E6390_MISC_TEST_TEMP_SENSOR_MASK |\n\t\t\t\tMII_88E6393_MISC_TEST_SAMPLES_MASK |\n\t\t\t\tMII_88E6393_MISC_TEST_RATE_MASK,\n\t\t\t\tMII_88E6390_MISC_TEST_TEMP_SENSOR_ENABLE |\n\t\t\t\tMII_88E6393_MISC_TEST_SAMPLES_2048 |\n\t\t\t\tMII_88E6393_MISC_TEST_RATE_2_3MS);\n}\n\nstatic int marvell_hwmon_read(struct device *dev, enum hwmon_sensor_types type,\n\t\t\t      u32 attr, int channel, long *temp)\n{\n\tstruct phy_device *phydev = dev_get_drvdata(dev);\n\tconst struct marvell_hwmon_ops *ops = to_marvell_hwmon_ops(phydev);\n\tint err = -EOPNOTSUPP;\n\n\tswitch (attr) {\n\tcase hwmon_temp_input:\n\t\tif (ops->get_temp)\n\t\t\terr = ops->get_temp(phydev, temp);\n\t\tbreak;\n\tcase hwmon_temp_crit:\n\t\tif (ops->get_temp_critical)\n\t\t\terr = ops->get_temp_critical(phydev, temp);\n\t\tbreak;\n\tcase hwmon_temp_max_alarm:\n\t\tif (ops->get_temp_alarm)\n\t\t\terr = ops->get_temp_alarm(phydev, temp);\n\t\tbreak;\n\t}\n\n\treturn err;\n}\n\nstatic int marvell_hwmon_write(struct device *dev, enum hwmon_sensor_types type,\n\t\t\t       u32 attr, int channel, long temp)\n{\n\tstruct phy_device *phydev = dev_get_drvdata(dev);\n\tconst struct marvell_hwmon_ops *ops = to_marvell_hwmon_ops(phydev);\n\tint err = -EOPNOTSUPP;\n\n\tswitch (attr) {\n\tcase hwmon_temp_crit:\n\t\tif (ops->set_temp_critical)\n\t\t\terr = ops->set_temp_critical(phydev, temp);\n\t\tbreak;\n\t}\n\n\treturn err;\n}\n\nstatic umode_t marvell_hwmon_is_visible(const void *data,\n\t\t\t\t\tenum hwmon_sensor_types type,\n\t\t\t\t\tu32 attr, int channel)\n{\n\tconst struct phy_device *phydev = data;\n\tconst struct marvell_hwmon_ops *ops = to_marvell_hwmon_ops(phydev);\n\n\tif (type != hwmon_temp)\n\t\treturn 0;\n\n\tswitch (attr) {\n\tcase hwmon_temp_input:\n\t\treturn ops->get_temp ? 0444 : 0;\n\tcase hwmon_temp_max_alarm:\n\t\treturn ops->get_temp_alarm ? 0444 : 0;\n\tcase hwmon_temp_crit:\n\t\treturn (ops->get_temp_critical ? 0444 : 0) |\n\t\t       (ops->set_temp_critical ? 0200 : 0);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic u32 marvell_hwmon_chip_config[] = {\n\tHWMON_C_REGISTER_TZ,\n\t0\n};\n\nstatic const struct hwmon_channel_info marvell_hwmon_chip = {\n\t.type = hwmon_chip,\n\t.config = marvell_hwmon_chip_config,\n};\n\n \nstatic u32 marvell_hwmon_temp_config[] = {\n\tHWMON_T_INPUT | HWMON_T_CRIT | HWMON_T_MAX_ALARM,\n\t0\n};\n\nstatic const struct hwmon_channel_info marvell_hwmon_temp = {\n\t.type = hwmon_temp,\n\t.config = marvell_hwmon_temp_config,\n};\n\nstatic const struct hwmon_channel_info * const marvell_hwmon_info[] = {\n\t&marvell_hwmon_chip,\n\t&marvell_hwmon_temp,\n\tNULL\n};\n\nstatic const struct hwmon_ops marvell_hwmon_hwmon_ops = {\n\t.is_visible = marvell_hwmon_is_visible,\n\t.read = marvell_hwmon_read,\n\t.write = marvell_hwmon_write,\n};\n\nstatic const struct hwmon_chip_info marvell_hwmon_chip_info = {\n\t.ops = &marvell_hwmon_hwmon_ops,\n\t.info = marvell_hwmon_info,\n};\n\nstatic int marvell_hwmon_name(struct phy_device *phydev)\n{\n\tstruct marvell_priv *priv = phydev->priv;\n\tstruct device *dev = &phydev->mdio.dev;\n\tconst char *devname = dev_name(dev);\n\tsize_t len = strlen(devname);\n\tint i, j;\n\n\tpriv->hwmon_name = devm_kzalloc(dev, len, GFP_KERNEL);\n\tif (!priv->hwmon_name)\n\t\treturn -ENOMEM;\n\n\tfor (i = j = 0; i < len && devname[i]; i++) {\n\t\tif (isalnum(devname[i]))\n\t\t\tpriv->hwmon_name[j++] = devname[i];\n\t}\n\n\treturn 0;\n}\n\nstatic int marvell_hwmon_probe(struct phy_device *phydev)\n{\n\tconst struct marvell_hwmon_ops *ops = to_marvell_hwmon_ops(phydev);\n\tstruct marvell_priv *priv = phydev->priv;\n\tstruct device *dev = &phydev->mdio.dev;\n\tint err;\n\n\tif (!ops)\n\t\treturn 0;\n\n\terr = marvell_hwmon_name(phydev);\n\tif (err)\n\t\treturn err;\n\n\tpriv->hwmon_dev = devm_hwmon_device_register_with_info(\n\t\tdev, priv->hwmon_name, phydev, &marvell_hwmon_chip_info, NULL);\n\tif (IS_ERR(priv->hwmon_dev))\n\t\treturn PTR_ERR(priv->hwmon_dev);\n\n\tif (ops->config)\n\t\terr = ops->config(phydev);\n\n\treturn err;\n}\n\nstatic const struct marvell_hwmon_ops m88e1121_hwmon_ops = {\n\t.get_temp = m88e1121_get_temp,\n};\n\nstatic const struct marvell_hwmon_ops m88e1510_hwmon_ops = {\n\t.get_temp = m88e1510_get_temp,\n\t.get_temp_critical = m88e1510_get_temp_critical,\n\t.set_temp_critical = m88e1510_set_temp_critical,\n\t.get_temp_alarm = m88e1510_get_temp_alarm,\n};\n\nstatic const struct marvell_hwmon_ops m88e6390_hwmon_ops = {\n\t.get_temp = m88e6390_get_temp,\n};\n\nstatic const struct marvell_hwmon_ops m88e6393_hwmon_ops = {\n\t.config = m88e6393_hwmon_config,\n\t.get_temp = m88e6393_get_temp,\n\t.get_temp_critical = m88e6393_get_temp_critical,\n\t.set_temp_critical = m88e6393_set_temp_critical,\n\t.get_temp_alarm = m88e1510_get_temp_alarm,\n};\n\n#define DEF_MARVELL_HWMON_OPS(s) (&(s))\n\n#else\n\n#define DEF_MARVELL_HWMON_OPS(s) NULL\n\nstatic int marvell_hwmon_probe(struct phy_device *phydev)\n{\n\treturn 0;\n}\n#endif\n\nstatic int m88e1318_led_brightness_set(struct phy_device *phydev,\n\t\t\t\t       u8 index, enum led_brightness value)\n{\n\tint reg;\n\n\treg = phy_read_paged(phydev, MII_MARVELL_LED_PAGE,\n\t\t\t     MII_88E1318S_PHY_LED_FUNC);\n\tif (reg < 0)\n\t\treturn reg;\n\n\tswitch (index) {\n\tcase 0:\n\tcase 1:\n\tcase 2:\n\t\treg &= ~(0xf << (4 * index));\n\t\tif (value == LED_OFF)\n\t\t\treg |= MII_88E1318S_PHY_LED_FUNC_OFF << (4 * index);\n\t\telse\n\t\t\treg |= MII_88E1318S_PHY_LED_FUNC_ON << (4 * index);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn phy_write_paged(phydev, MII_MARVELL_LED_PAGE,\n\t\t\t       MII_88E1318S_PHY_LED_FUNC, reg);\n}\n\nstatic int m88e1318_led_blink_set(struct phy_device *phydev, u8 index,\n\t\t\t\t  unsigned long *delay_on,\n\t\t\t\t  unsigned long *delay_off)\n{\n\tint reg;\n\n\treg = phy_read_paged(phydev, MII_MARVELL_LED_PAGE,\n\t\t\t     MII_88E1318S_PHY_LED_FUNC);\n\tif (reg < 0)\n\t\treturn reg;\n\n\tswitch (index) {\n\tcase 0:\n\tcase 1:\n\tcase 2:\n\t\treg &= ~(0xf << (4 * index));\n\t\treg |= MII_88E1318S_PHY_LED_FUNC_BLINK << (4 * index);\n\t\t \n\t\t*delay_on = 84 / 2;\n\t\t*delay_off = 84 / 2;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn phy_write_paged(phydev, MII_MARVELL_LED_PAGE,\n\t\t\t       MII_88E1318S_PHY_LED_FUNC, reg);\n}\n\nstruct marvell_led_rules {\n\tint mode;\n\tunsigned long rules;\n};\n\nstatic const struct marvell_led_rules marvell_led0[] = {\n\t{\n\t\t.mode = 0,\n\t\t.rules = BIT(TRIGGER_NETDEV_LINK),\n\t},\n\t{\n\t\t.mode = 1,\n\t\t.rules = (BIT(TRIGGER_NETDEV_LINK) |\n\t\t\t  BIT(TRIGGER_NETDEV_RX) |\n\t\t\t  BIT(TRIGGER_NETDEV_TX)),\n\t},\n\t{\n\t\t.mode = 3,\n\t\t.rules = (BIT(TRIGGER_NETDEV_RX) |\n\t\t\t  BIT(TRIGGER_NETDEV_TX)),\n\t},\n\t{\n\t\t.mode = 4,\n\t\t.rules = (BIT(TRIGGER_NETDEV_RX) |\n\t\t\t  BIT(TRIGGER_NETDEV_TX)),\n\t},\n\t{\n\t\t.mode = 5,\n\t\t.rules = BIT(TRIGGER_NETDEV_TX),\n\t},\n\t{\n\t\t.mode = 6,\n\t\t.rules = BIT(TRIGGER_NETDEV_LINK),\n\t},\n\t{\n\t\t.mode = 7,\n\t\t.rules = BIT(TRIGGER_NETDEV_LINK_1000),\n\t},\n\t{\n\t\t.mode = 8,\n\t\t.rules = 0,\n\t},\n};\n\nstatic const struct marvell_led_rules marvell_led1[] = {\n\t{\n\t\t.mode = 1,\n\t\t.rules = (BIT(TRIGGER_NETDEV_LINK) |\n\t\t\t  BIT(TRIGGER_NETDEV_RX) |\n\t\t\t  BIT(TRIGGER_NETDEV_TX)),\n\t},\n\t{\n\t\t.mode = 2,\n\t\t.rules = (BIT(TRIGGER_NETDEV_LINK) |\n\t\t\t  BIT(TRIGGER_NETDEV_RX)),\n\t},\n\t{\n\t\t.mode = 3,\n\t\t.rules = (BIT(TRIGGER_NETDEV_RX) |\n\t\t\t  BIT(TRIGGER_NETDEV_TX)),\n\t},\n\t{\n\t\t.mode = 4,\n\t\t.rules = (BIT(TRIGGER_NETDEV_RX) |\n\t\t\t  BIT(TRIGGER_NETDEV_TX)),\n\t},\n\t{\n\t\t.mode = 6,\n\t\t.rules = (BIT(TRIGGER_NETDEV_LINK_100) |\n\t\t\t  BIT(TRIGGER_NETDEV_LINK_1000)),\n\t},\n\t{\n\t\t.mode = 7,\n\t\t.rules = BIT(TRIGGER_NETDEV_LINK_100),\n\t},\n\t{\n\t\t.mode = 8,\n\t\t.rules = 0,\n\t},\n};\n\nstatic const struct marvell_led_rules marvell_led2[] = {\n\t{\n\t\t.mode = 0,\n\t\t.rules = BIT(TRIGGER_NETDEV_LINK),\n\t},\n\t{\n\t\t.mode = 1,\n\t\t.rules = (BIT(TRIGGER_NETDEV_LINK) |\n\t\t\t  BIT(TRIGGER_NETDEV_RX) |\n\t\t\t  BIT(TRIGGER_NETDEV_TX)),\n\t},\n\t{\n\t\t.mode = 3,\n\t\t.rules = (BIT(TRIGGER_NETDEV_RX) |\n\t\t\t  BIT(TRIGGER_NETDEV_TX)),\n\t},\n\t{\n\t\t.mode = 4,\n\t\t.rules = (BIT(TRIGGER_NETDEV_RX) |\n\t\t\t  BIT(TRIGGER_NETDEV_TX)),\n\t},\n\t{\n\t\t.mode = 5,\n\t\t.rules = BIT(TRIGGER_NETDEV_TX),\n\t},\n\t{\n\t\t.mode = 6,\n\t\t.rules = (BIT(TRIGGER_NETDEV_LINK_10) |\n\t\t\t  BIT(TRIGGER_NETDEV_LINK_1000)),\n\t},\n\t{\n\t\t.mode = 7,\n\t\t.rules = BIT(TRIGGER_NETDEV_LINK_10),\n\t},\n\t{\n\t\t.mode = 8,\n\t\t.rules = 0,\n\t},\n};\n\nstatic int marvell_find_led_mode(unsigned long rules,\n\t\t\t\t const struct marvell_led_rules *marvell_rules,\n\t\t\t\t int count,\n\t\t\t\t int *mode)\n{\n\tint i;\n\n\tfor (i = 0; i < count; i++) {\n\t\tif (marvell_rules[i].rules == rules) {\n\t\t\t*mode = marvell_rules[i].mode;\n\t\t\treturn 0;\n\t\t}\n\t}\n\treturn -EOPNOTSUPP;\n}\n\nstatic int marvell_get_led_mode(u8 index, unsigned long rules, int *mode)\n{\n\tint ret;\n\n\tswitch (index) {\n\tcase 0:\n\t\tret = marvell_find_led_mode(rules, marvell_led0,\n\t\t\t\t\t    ARRAY_SIZE(marvell_led0), mode);\n\t\tbreak;\n\tcase 1:\n\t\tret = marvell_find_led_mode(rules, marvell_led1,\n\t\t\t\t\t    ARRAY_SIZE(marvell_led1), mode);\n\t\tbreak;\n\tcase 2:\n\t\tret = marvell_find_led_mode(rules, marvell_led2,\n\t\t\t\t\t    ARRAY_SIZE(marvell_led2), mode);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic int marvell_find_led_rules(unsigned long *rules,\n\t\t\t\t  const struct marvell_led_rules *marvell_rules,\n\t\t\t\t  int count,\n\t\t\t\t  int mode)\n{\n\tint i;\n\n\tfor (i = 0; i < count; i++) {\n\t\tif (marvell_rules[i].mode == mode) {\n\t\t\t*rules = marvell_rules[i].rules;\n\t\t\treturn 0;\n\t\t}\n\t}\n\treturn -EOPNOTSUPP;\n}\n\nstatic int marvell_get_led_rules(u8 index, unsigned long *rules, int mode)\n{\n\tint ret;\n\n\tswitch (index) {\n\tcase 0:\n\t\tret = marvell_find_led_rules(rules, marvell_led0,\n\t\t\t\t\t     ARRAY_SIZE(marvell_led0), mode);\n\t\tbreak;\n\tcase 1:\n\t\tret = marvell_find_led_rules(rules, marvell_led1,\n\t\t\t\t\t     ARRAY_SIZE(marvell_led1), mode);\n\t\tbreak;\n\tcase 2:\n\t\tret = marvell_find_led_rules(rules, marvell_led2,\n\t\t\t\t\t     ARRAY_SIZE(marvell_led2), mode);\n\t\tbreak;\n\tdefault:\n\t\tret = -EOPNOTSUPP;\n\t}\n\n\treturn ret;\n}\n\nstatic int m88e1318_led_hw_is_supported(struct phy_device *phydev, u8 index,\n\t\t\t\t\tunsigned long rules)\n{\n\tint mode, ret;\n\n\tswitch (index) {\n\tcase 0:\n\tcase 1:\n\tcase 2:\n\t\tret = marvell_get_led_mode(index, rules, &mode);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic int m88e1318_led_hw_control_set(struct phy_device *phydev, u8 index,\n\t\t\t\t       unsigned long rules)\n{\n\tint mode, ret, reg;\n\n\tswitch (index) {\n\tcase 0:\n\tcase 1:\n\tcase 2:\n\t\tret = marvell_get_led_mode(index, rules, &mode);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\n\tif (ret < 0)\n\t\treturn ret;\n\n\treg = phy_read_paged(phydev, MII_MARVELL_LED_PAGE,\n\t\t\t     MII_88E1318S_PHY_LED_FUNC);\n\tif (reg < 0)\n\t\treturn reg;\n\n\treg &= ~(0xf << (4 * index));\n\treg |= mode << (4 * index);\n\treturn phy_write_paged(phydev, MII_MARVELL_LED_PAGE,\n\t\t\t       MII_88E1318S_PHY_LED_FUNC, reg);\n}\n\nstatic int m88e1318_led_hw_control_get(struct phy_device *phydev, u8 index,\n\t\t\t\t       unsigned long *rules)\n{\n\tint mode, reg;\n\n\tif (index > 2)\n\t\treturn -EINVAL;\n\n\treg = phy_read_paged(phydev, MII_MARVELL_LED_PAGE,\n\t\t\t     MII_88E1318S_PHY_LED_FUNC);\n\tif (reg < 0)\n\t\treturn reg;\n\n\tmode = (reg >> (4 * index)) & 0xf;\n\n\treturn marvell_get_led_rules(index, rules, mode);\n}\n\nstatic int marvell_probe(struct phy_device *phydev)\n{\n\tstruct marvell_priv *priv;\n\n\tpriv = devm_kzalloc(&phydev->mdio.dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tphydev->priv = priv;\n\n\treturn marvell_hwmon_probe(phydev);\n}\n\nstatic int m88e1510_sfp_insert(void *upstream, const struct sfp_eeprom_id *id)\n{\n\tDECLARE_PHY_INTERFACE_MASK(interfaces);\n\tstruct phy_device *phydev = upstream;\n\tphy_interface_t interface;\n\tstruct device *dev;\n\tint oldpage;\n\tint ret = 0;\n\tu16 mode;\n\n\t__ETHTOOL_DECLARE_LINK_MODE_MASK(supported) = { 0, };\n\n\tdev = &phydev->mdio.dev;\n\n\tsfp_parse_support(phydev->sfp_bus, id, supported, interfaces);\n\tinterface = sfp_select_interface(phydev->sfp_bus, supported);\n\n\tdev_info(dev, \"%s SFP module inserted\\n\", phy_modes(interface));\n\n\tswitch (interface) {\n\tcase PHY_INTERFACE_MODE_1000BASEX:\n\t\tmode = MII_88E1510_GEN_CTRL_REG_1_MODE_RGMII_1000X;\n\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_100BASEX:\n\t\tmode = MII_88E1510_GEN_CTRL_REG_1_MODE_RGMII_100FX;\n\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_SGMII:\n\t\tmode = MII_88E1510_GEN_CTRL_REG_1_MODE_RGMII_SGMII;\n\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dev, \"Incompatible SFP module inserted\\n\");\n\n\t\treturn -EINVAL;\n\t}\n\n\toldpage = phy_select_page(phydev, MII_MARVELL_MODE_PAGE);\n\tif (oldpage < 0)\n\t\tgoto error;\n\n\tret = __phy_modify(phydev, MII_88E1510_GEN_CTRL_REG_1,\n\t\t\t   MII_88E1510_GEN_CTRL_REG_1_MODE_MASK, mode);\n\tif (ret < 0)\n\t\tgoto error;\n\n\tret = __phy_set_bits(phydev, MII_88E1510_GEN_CTRL_REG_1,\n\t\t\t     MII_88E1510_GEN_CTRL_REG_1_RESET);\n\nerror:\n\treturn phy_restore_page(phydev, oldpage, ret);\n}\n\nstatic void m88e1510_sfp_remove(void *upstream)\n{\n\tstruct phy_device *phydev = upstream;\n\tint oldpage;\n\tint ret = 0;\n\n\toldpage = phy_select_page(phydev, MII_MARVELL_MODE_PAGE);\n\tif (oldpage < 0)\n\t\tgoto error;\n\n\tret = __phy_modify(phydev, MII_88E1510_GEN_CTRL_REG_1,\n\t\t\t   MII_88E1510_GEN_CTRL_REG_1_MODE_MASK,\n\t\t\t   MII_88E1510_GEN_CTRL_REG_1_MODE_RGMII);\n\tif (ret < 0)\n\t\tgoto error;\n\n\tret = __phy_set_bits(phydev, MII_88E1510_GEN_CTRL_REG_1,\n\t\t\t     MII_88E1510_GEN_CTRL_REG_1_RESET);\n\nerror:\n\tphy_restore_page(phydev, oldpage, ret);\n}\n\nstatic const struct sfp_upstream_ops m88e1510_sfp_ops = {\n\t.module_insert = m88e1510_sfp_insert,\n\t.module_remove = m88e1510_sfp_remove,\n\t.attach = phy_sfp_attach,\n\t.detach = phy_sfp_detach,\n};\n\nstatic int m88e1510_probe(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = marvell_probe(phydev);\n\tif (err)\n\t\treturn err;\n\n\treturn phy_sfp_probe(phydev, &m88e1510_sfp_ops);\n}\n\nstatic struct phy_driver marvell_drivers[] = {\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1101,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1101\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = marvell_config_init,\n\t\t.config_aneg = m88e1101_config_aneg,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1112,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1112\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = m88e1112_config_init,\n\t\t.config_aneg = marvell_config_aneg,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1011_get_tunable,\n\t\t.set_tunable = m88e1011_set_tunable,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1111,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1111\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = m88e1111gbe_config_init,\n\t\t.config_aneg = m88e1111_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1111_get_tunable,\n\t\t.set_tunable = m88e1111_set_tunable,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1111_FINISAR,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1111 (Finisar)\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = m88e1111gbe_config_init,\n\t\t.config_aneg = m88e1111_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1111_get_tunable,\n\t\t.set_tunable = m88e1111_set_tunable,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1118,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1118\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = m88e1118_config_init,\n\t\t.config_aneg = m88e1118_config_aneg,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1121R,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1121R\",\n\t\t.driver_data = DEF_MARVELL_HWMON_OPS(m88e1121_hwmon_ops),\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = marvell_1011gbe_config_init,\n\t\t.config_aneg = m88e1121_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1011_get_tunable,\n\t\t.set_tunable = m88e1011_set_tunable,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1318S,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1318S\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = m88e1318_config_init,\n\t\t.config_aneg = m88e1318_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.get_wol = m88e1318_get_wol,\n\t\t.set_wol = m88e1318_set_wol,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.led_brightness_set = m88e1318_led_brightness_set,\n\t\t.led_blink_set = m88e1318_led_blink_set,\n\t\t.led_hw_is_supported = m88e1318_led_hw_is_supported,\n\t\t.led_hw_control_set = m88e1318_led_hw_control_set,\n\t\t.led_hw_control_get = m88e1318_led_hw_control_get,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1145,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1145\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = m88e1145_config_init,\n\t\t.config_aneg = m88e1101_config_aneg,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1111_get_tunable,\n\t\t.set_tunable = m88e1111_set_tunable,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1149R,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1149R\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = m88e1149_config_init,\n\t\t.config_aneg = m88e1118_config_aneg,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1240,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1240\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = m88e1112_config_init,\n\t\t.config_aneg = marvell_config_aneg,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1011_get_tunable,\n\t\t.set_tunable = m88e1011_set_tunable,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1116R,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1116R\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = m88e1116r_config_init,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1011_get_tunable,\n\t\t.set_tunable = m88e1011_set_tunable,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1510,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1510\",\n\t\t.driver_data = DEF_MARVELL_HWMON_OPS(m88e1510_hwmon_ops),\n\t\t.features = PHY_GBIT_FIBRE_FEATURES,\n\t\t.flags = PHY_POLL_CABLE_TEST,\n\t\t.probe = m88e1510_probe,\n\t\t.config_init = m88e1510_config_init,\n\t\t.config_aneg = m88e1510_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.get_wol = m88e1318_get_wol,\n\t\t.set_wol = m88e1318_set_wol,\n\t\t.resume = marvell_resume,\n\t\t.suspend = marvell_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.set_loopback = m88e1510_loopback,\n\t\t.get_tunable = m88e1011_get_tunable,\n\t\t.set_tunable = m88e1011_set_tunable,\n\t\t.cable_test_start = marvell_vct7_cable_test_start,\n\t\t.cable_test_tdr_start = marvell_vct5_cable_test_tdr_start,\n\t\t.cable_test_get_status = marvell_vct7_cable_test_get_status,\n\t\t.led_brightness_set = m88e1318_led_brightness_set,\n\t\t.led_blink_set = m88e1318_led_blink_set,\n\t\t.led_hw_is_supported = m88e1318_led_hw_is_supported,\n\t\t.led_hw_control_set = m88e1318_led_hw_control_set,\n\t\t.led_hw_control_get = m88e1318_led_hw_control_get,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1540,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1540\",\n\t\t.driver_data = DEF_MARVELL_HWMON_OPS(m88e1510_hwmon_ops),\n\t\t \n\t\t.flags = PHY_POLL_CABLE_TEST,\n\t\t.probe = marvell_probe,\n\t\t.config_init = marvell_1011gbe_config_init,\n\t\t.config_aneg = m88e1510_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1540_get_tunable,\n\t\t.set_tunable = m88e1540_set_tunable,\n\t\t.cable_test_start = marvell_vct7_cable_test_start,\n\t\t.cable_test_tdr_start = marvell_vct5_cable_test_tdr_start,\n\t\t.cable_test_get_status = marvell_vct7_cable_test_get_status,\n\t\t.led_brightness_set = m88e1318_led_brightness_set,\n\t\t.led_blink_set = m88e1318_led_blink_set,\n\t\t.led_hw_is_supported = m88e1318_led_hw_is_supported,\n\t\t.led_hw_control_set = m88e1318_led_hw_control_set,\n\t\t.led_hw_control_get = m88e1318_led_hw_control_get,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1545,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1545\",\n\t\t.driver_data = DEF_MARVELL_HWMON_OPS(m88e1510_hwmon_ops),\n\t\t.probe = marvell_probe,\n\t\t \n\t\t.flags = PHY_POLL_CABLE_TEST,\n\t\t.config_init = marvell_1011gbe_config_init,\n\t\t.config_aneg = m88e1510_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1540_get_tunable,\n\t\t.set_tunable = m88e1540_set_tunable,\n\t\t.cable_test_start = marvell_vct7_cable_test_start,\n\t\t.cable_test_tdr_start = marvell_vct5_cable_test_tdr_start,\n\t\t.cable_test_get_status = marvell_vct7_cable_test_get_status,\n\t\t.led_brightness_set = m88e1318_led_brightness_set,\n\t\t.led_blink_set = m88e1318_led_blink_set,\n\t\t.led_hw_is_supported = m88e1318_led_hw_is_supported,\n\t\t.led_hw_control_set = m88e1318_led_hw_control_set,\n\t\t.led_hw_control_get = m88e1318_led_hw_control_get,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E3016,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E3016\",\n\t\t \n\t\t.probe = marvell_probe,\n\t\t.config_init = m88e3016_config_init,\n\t\t.aneg_done = marvell_aneg_done,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E6341_FAMILY,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E6341 Family\",\n\t\t.driver_data = DEF_MARVELL_HWMON_OPS(m88e1510_hwmon_ops),\n\t\t \n\t\t.flags = PHY_POLL_CABLE_TEST,\n\t\t.probe = marvell_probe,\n\t\t.config_init = marvell_1011gbe_config_init,\n\t\t.config_aneg = m88e6390_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1540_get_tunable,\n\t\t.set_tunable = m88e1540_set_tunable,\n\t\t.cable_test_start = marvell_vct7_cable_test_start,\n\t\t.cable_test_tdr_start = marvell_vct5_cable_test_tdr_start,\n\t\t.cable_test_get_status = marvell_vct7_cable_test_get_status,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E6390_FAMILY,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E6390 Family\",\n\t\t.driver_data = DEF_MARVELL_HWMON_OPS(m88e6390_hwmon_ops),\n\t\t \n\t\t.flags = PHY_POLL_CABLE_TEST,\n\t\t.probe = marvell_probe,\n\t\t.config_init = marvell_1011gbe_config_init,\n\t\t.config_aneg = m88e6390_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1540_get_tunable,\n\t\t.set_tunable = m88e1540_set_tunable,\n\t\t.cable_test_start = marvell_vct7_cable_test_start,\n\t\t.cable_test_tdr_start = marvell_vct5_cable_test_tdr_start,\n\t\t.cable_test_get_status = marvell_vct7_cable_test_get_status,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E6393_FAMILY,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E6393 Family\",\n\t\t.driver_data = DEF_MARVELL_HWMON_OPS(m88e6393_hwmon_ops),\n\t\t \n\t\t.flags = PHY_POLL_CABLE_TEST,\n\t\t.probe = marvell_probe,\n\t\t.config_init = marvell_1011gbe_config_init,\n\t\t.config_aneg = m88e1510_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1540_get_tunable,\n\t\t.set_tunable = m88e1540_set_tunable,\n\t\t.cable_test_start = marvell_vct7_cable_test_start,\n\t\t.cable_test_tdr_start = marvell_vct5_cable_test_tdr_start,\n\t\t.cable_test_get_status = marvell_vct7_cable_test_get_status,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1340S,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1340S\",\n\t\t.driver_data = DEF_MARVELL_HWMON_OPS(m88e1510_hwmon_ops),\n\t\t.probe = marvell_probe,\n\t\t \n\t\t.config_init = marvell_1011gbe_config_init,\n\t\t.config_aneg = m88e1510_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1540_get_tunable,\n\t\t.set_tunable = m88e1540_set_tunable,\n\t},\n\t{\n\t\t.phy_id = MARVELL_PHY_ID_88E1548P,\n\t\t.phy_id_mask = MARVELL_PHY_ID_MASK,\n\t\t.name = \"Marvell 88E1548P\",\n\t\t.driver_data = DEF_MARVELL_HWMON_OPS(m88e1510_hwmon_ops),\n\t\t.probe = marvell_probe,\n\t\t.features = PHY_GBIT_FIBRE_FEATURES,\n\t\t.config_init = marvell_1011gbe_config_init,\n\t\t.config_aneg = m88e1510_config_aneg,\n\t\t.read_status = marvell_read_status,\n\t\t.config_intr = marvell_config_intr,\n\t\t.handle_interrupt = marvell_handle_interrupt,\n\t\t.resume = genphy_resume,\n\t\t.suspend = genphy_suspend,\n\t\t.read_page = marvell_read_page,\n\t\t.write_page = marvell_write_page,\n\t\t.get_sset_count = marvell_get_sset_count,\n\t\t.get_strings = marvell_get_strings,\n\t\t.get_stats = marvell_get_stats,\n\t\t.get_tunable = m88e1540_get_tunable,\n\t\t.set_tunable = m88e1540_set_tunable,\n\t\t.led_brightness_set = m88e1318_led_brightness_set,\n\t\t.led_blink_set = m88e1318_led_blink_set,\n\t\t.led_hw_is_supported = m88e1318_led_hw_is_supported,\n\t\t.led_hw_control_set = m88e1318_led_hw_control_set,\n\t\t.led_hw_control_get = m88e1318_led_hw_control_get,\n\t},\n};\n\nmodule_phy_driver(marvell_drivers);\n\nstatic struct mdio_device_id __maybe_unused marvell_tbl[] = {\n\t{ MARVELL_PHY_ID_88E1101, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1112, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1111, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1111_FINISAR, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1118, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1121R, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1145, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1149R, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1240, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1318S, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1116R, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1510, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1540, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1545, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E3016, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E6341_FAMILY, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E6390_FAMILY, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E6393_FAMILY, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1340S, MARVELL_PHY_ID_MASK },\n\t{ MARVELL_PHY_ID_88E1548P, MARVELL_PHY_ID_MASK },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(mdio, marvell_tbl);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}