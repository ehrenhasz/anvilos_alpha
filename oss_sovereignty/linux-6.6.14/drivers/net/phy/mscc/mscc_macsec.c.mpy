{
  "module_name": "mscc_macsec.c",
  "hash_id": "19f254d5e3b24b3fbd760a6c96c537ea2f060053651c21edead254e403d99030",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/mscc/mscc_macsec.c",
  "human_readable_source": "\n \n\n#include <linux/phy.h>\n#include <dt-bindings/net/mscc-phy-vsc8531.h>\n\n#include <crypto/aes.h>\n\n#include <net/macsec.h>\n\n#include \"mscc.h\"\n#include \"mscc_mac.h\"\n#include \"mscc_macsec.h\"\n#include \"mscc_fc_buffer.h\"\n\nstatic u32 vsc8584_macsec_phy_read(struct phy_device *phydev,\n\t\t\t\t   enum macsec_bank bank, u32 reg)\n{\n\tu32 val, val_l = 0, val_h = 0;\n\tunsigned long deadline;\n\tint rc;\n\n\trc = phy_select_page(phydev, MSCC_PHY_PAGE_MACSEC);\n\tif (rc < 0)\n\t\tgoto failed;\n\n\t__phy_write(phydev, MSCC_EXT_PAGE_MACSEC_20,\n\t\t    MSCC_PHY_MACSEC_20_TARGET(bank >> 2));\n\n\tif (bank >> 2 == 0x1)\n\t\t \n\t\tbank &= 0x3;\n\telse\n\t\tbank = 0;\n\n\t__phy_write(phydev, MSCC_EXT_PAGE_MACSEC_19,\n\t\t    MSCC_PHY_MACSEC_19_CMD | MSCC_PHY_MACSEC_19_READ |\n\t\t    MSCC_PHY_MACSEC_19_REG_ADDR(reg) |\n\t\t    MSCC_PHY_MACSEC_19_TARGET(bank));\n\n\tdeadline = jiffies + msecs_to_jiffies(PROC_CMD_NCOMPLETED_TIMEOUT_MS);\n\tdo {\n\t\tval = __phy_read(phydev, MSCC_EXT_PAGE_MACSEC_19);\n\t} while (time_before(jiffies, deadline) && !(val & MSCC_PHY_MACSEC_19_CMD));\n\n\tval_l = __phy_read(phydev, MSCC_EXT_PAGE_MACSEC_17);\n\tval_h = __phy_read(phydev, MSCC_EXT_PAGE_MACSEC_18);\n\nfailed:\n\tphy_restore_page(phydev, rc, rc);\n\n\treturn (val_h << 16) | val_l;\n}\n\nstatic void vsc8584_macsec_phy_write(struct phy_device *phydev,\n\t\t\t\t     enum macsec_bank bank, u32 reg, u32 val)\n{\n\tunsigned long deadline;\n\tint rc;\n\n\trc = phy_select_page(phydev, MSCC_PHY_PAGE_MACSEC);\n\tif (rc < 0)\n\t\tgoto failed;\n\n\t__phy_write(phydev, MSCC_EXT_PAGE_MACSEC_20,\n\t\t    MSCC_PHY_MACSEC_20_TARGET(bank >> 2));\n\n\tif ((bank >> 2 == 0x1) || (bank >> 2 == 0x3))\n\t\tbank &= 0x3;\n\telse\n\t\t \n\t\tbank = 0;\n\n\t__phy_write(phydev, MSCC_EXT_PAGE_MACSEC_17, (u16)val);\n\t__phy_write(phydev, MSCC_EXT_PAGE_MACSEC_18, (u16)(val >> 16));\n\n\t__phy_write(phydev, MSCC_EXT_PAGE_MACSEC_19,\n\t\t    MSCC_PHY_MACSEC_19_CMD | MSCC_PHY_MACSEC_19_REG_ADDR(reg) |\n\t\t    MSCC_PHY_MACSEC_19_TARGET(bank));\n\n\tdeadline = jiffies + msecs_to_jiffies(PROC_CMD_NCOMPLETED_TIMEOUT_MS);\n\tdo {\n\t\tval = __phy_read(phydev, MSCC_EXT_PAGE_MACSEC_19);\n\t} while (time_before(jiffies, deadline) && !(val & MSCC_PHY_MACSEC_19_CMD));\n\nfailed:\n\tphy_restore_page(phydev, rc, rc);\n}\n\nstatic void vsc8584_macsec_classification(struct phy_device *phydev,\n\t\t\t\t\t  enum macsec_bank bank)\n{\n\t \n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_CP_TAG,\n\t\t\t\t MSCC_MS_SAM_CP_TAG_PARSE_STAG |\n\t\t\t\t MSCC_MS_SAM_CP_TAG_PARSE_QTAG |\n\t\t\t\t MSCC_MS_SAM_CP_TAG_PARSE_QINQ);\n}\n\nstatic void vsc8584_macsec_flow_default_action(struct phy_device *phydev,\n\t\t\t\t\t       enum macsec_bank bank,\n\t\t\t\t\t       bool block)\n{\n\tu32 port = (bank == MACSEC_INGR) ?\n\t\t    MSCC_MS_PORT_UNCONTROLLED : MSCC_MS_PORT_COMMON;\n\tu32 action = MSCC_MS_FLOW_BYPASS;\n\n\tif (block)\n\t\taction = MSCC_MS_FLOW_DROP;\n\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_NM_FLOW_NCP,\n\t\t\t\t  \n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_UNTAGGED_FLOW_TYPE(action) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_UNTAGGED_DROP_ACTION(MSCC_MS_ACTION_DROP) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_UNTAGGED_DEST_PORT(port) |\n\t\t\t\t  \n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_TAGGED_FLOW_TYPE(action) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_TAGGED_DROP_ACTION(MSCC_MS_ACTION_DROP) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_TAGGED_DEST_PORT(port) |\n\t\t\t\t  \n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_BADTAG_FLOW_TYPE(action) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_BADTAG_DROP_ACTION(MSCC_MS_ACTION_DROP) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_BADTAG_DEST_PORT(port) |\n\t\t\t\t  \n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_KAY_FLOW_TYPE(action) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_KAY_DROP_ACTION(MSCC_MS_ACTION_DROP) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_KAY_DEST_PORT(port));\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_NM_FLOW_CP,\n\t\t\t\t  \n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_UNTAGGED_FLOW_TYPE(action) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_CP_UNTAGGED_DROP_ACTION(MSCC_MS_ACTION_DROP) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_CP_UNTAGGED_DEST_PORT(port) |\n\t\t\t\t  \n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_TAGGED_FLOW_TYPE(action) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_CP_TAGGED_DROP_ACTION(MSCC_MS_ACTION_DROP) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_CP_TAGGED_DEST_PORT(port) |\n\t\t\t\t  \n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_BADTAG_FLOW_TYPE(action) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_CP_BADTAG_DROP_ACTION(MSCC_MS_ACTION_DROP) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_CP_BADTAG_DEST_PORT(port) |\n\t\t\t\t  \n\t\t\t\t MSCC_MS_SAM_NM_FLOW_NCP_KAY_FLOW_TYPE(action) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_CP_KAY_DROP_ACTION(MSCC_MS_ACTION_DROP) |\n\t\t\t\t MSCC_MS_SAM_NM_FLOW_CP_KAY_DEST_PORT(port));\n}\n\nstatic void vsc8584_macsec_integrity_checks(struct phy_device *phydev,\n\t\t\t\t\t    enum macsec_bank bank)\n{\n\tu32 val;\n\n\tif (bank != MACSEC_INGR)\n\t\treturn;\n\n\t \n\tval = vsc8584_macsec_phy_read(phydev, bank,\n\t\t\t\t      MSCC_MS_PARAMS2_IG_CC_CONTROL);\n\tval |= MSCC_MS_PARAMS2_IG_CC_CONTROL_NON_MATCH_CTRL_ACT |\n\t       MSCC_MS_PARAMS2_IG_CC_CONTROL_NON_MATCH_ACT;\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_PARAMS2_IG_CC_CONTROL,\n\t\t\t\t val);\n\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_PARAMS2_IG_CP_TAG,\n\t\t\t\t MSCC_MS_PARAMS2_IG_CP_TAG_PARSE_STAG |\n\t\t\t\t MSCC_MS_PARAMS2_IG_CP_TAG_PARSE_QTAG |\n\t\t\t\t MSCC_MS_PARAMS2_IG_CP_TAG_PARSE_QINQ);\n}\n\nstatic void vsc8584_macsec_block_init(struct phy_device *phydev,\n\t\t\t\t      enum macsec_bank bank)\n{\n\tu32 val;\n\tint i;\n\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_ENA_CFG,\n\t\t\t\t MSCC_MS_ENA_CFG_SW_RST |\n\t\t\t\t MSCC_MS_ENA_CFG_MACSEC_BYPASS_ENA);\n\n\t \n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_ENA_CFG,\n\t\t\t\t MSCC_MS_ENA_CFG_CLK_ENA);\n\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_STATUS_CONTEXT_CTRL,\n\t\t\t\t bank == MACSEC_INGR ? 0xe5880214 : 0xe5880218);\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_MISC_CONTROL,\n\t\t\t\t MSCC_MS_MISC_CONTROL_MC_LATENCY_FIX(bank == MACSEC_INGR ? 57 : 40) |\n\t\t\t\t MSCC_MS_MISC_CONTROL_XFORM_REC_SIZE(bank == MACSEC_INGR ? 1 : 2));\n\n\t \n\tval = vsc8584_macsec_phy_read(phydev, bank, MSCC_MS_COUNT_CONTROL);\n\tval |= MSCC_MS_COUNT_CONTROL_AUTO_CNTR_RESET;\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_COUNT_CONTROL, val);\n\n\t \n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_PP_CTRL,\n\t\t\t\t MSCC_MS_PP_CTRL_MACSEC_OCTET_INCR_MODE);\n\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_BLOCK_CTX_UPDATE, 0x3);\n\n\tval = vsc8584_macsec_phy_read(phydev, bank, MSCC_MS_COUNT_CONTROL);\n\tval |= MSCC_MS_COUNT_CONTROL_RESET_ALL;\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_COUNT_CONTROL, val);\n\n\t \n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_NON_VLAN_MTU_CHECK,\n\t\t\t\t MSCC_MS_NON_VLAN_MTU_CHECK_NV_MTU_COMPARE(32761) |\n\t\t\t\t MSCC_MS_NON_VLAN_MTU_CHECK_NV_MTU_COMP_DROP);\n\n\tfor (i = 0; i < 8; i++)\n\t\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_VLAN_MTU_CHECK(i),\n\t\t\t\t\t MSCC_MS_VLAN_MTU_CHECK_MTU_COMPARE(32761) |\n\t\t\t\t\t MSCC_MS_VLAN_MTU_CHECK_MTU_COMP_DROP);\n\n\tif (bank == MACSEC_EGR) {\n\t\tval = vsc8584_macsec_phy_read(phydev, bank, MSCC_MS_INTR_CTRL_STATUS);\n\t\tval &= ~MSCC_MS_INTR_CTRL_STATUS_INTR_ENABLE_M;\n\t\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_INTR_CTRL_STATUS, val);\n\n\t\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_FC_CFG,\n\t\t\t\t\t MSCC_MS_FC_CFG_FCBUF_ENA |\n\t\t\t\t\t MSCC_MS_FC_CFG_LOW_THRESH(0x1) |\n\t\t\t\t\t MSCC_MS_FC_CFG_HIGH_THRESH(0x4) |\n\t\t\t\t\t MSCC_MS_FC_CFG_LOW_BYTES_VAL(0x4) |\n\t\t\t\t\t MSCC_MS_FC_CFG_HIGH_BYTES_VAL(0x6));\n\t}\n\n\tvsc8584_macsec_classification(phydev, bank);\n\tvsc8584_macsec_flow_default_action(phydev, bank, false);\n\tvsc8584_macsec_integrity_checks(phydev, bank);\n\n\t \n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_ENA_CFG,\n\t\t\t\t MSCC_MS_ENA_CFG_CLK_ENA |\n\t\t\t\t MSCC_MS_ENA_CFG_MACSEC_ENA |\n\t\t\t\t MSCC_MS_ENA_CFG_MACSEC_SPEED_MODE(0x5));\n}\n\nstatic void vsc8584_macsec_mac_init(struct phy_device *phydev,\n\t\t\t\t    enum macsec_bank bank)\n{\n\tu32 val;\n\tint i;\n\n\t \n\tfor (i = 0; i < 36; i++)\n\t\tvsc8584_macsec_phy_write(phydev, bank, 0x1c + i, 0);\n\n\tval = vsc8584_macsec_phy_read(phydev, bank,\n\t\t\t\t      MSCC_MAC_PAUSE_CFG_TX_FRAME_CTRL);\n\tval &= ~MSCC_MAC_PAUSE_CFG_TX_FRAME_CTRL_PAUSE_MODE_M;\n\tval |= MSCC_MAC_PAUSE_CFG_TX_FRAME_CTRL_PAUSE_MODE(2) |\n\t       MSCC_MAC_PAUSE_CFG_TX_FRAME_CTRL_PAUSE_VALUE(0xffff);\n\tvsc8584_macsec_phy_write(phydev, bank,\n\t\t\t\t MSCC_MAC_PAUSE_CFG_TX_FRAME_CTRL, val);\n\n\tval = vsc8584_macsec_phy_read(phydev, bank,\n\t\t\t\t      MSCC_MAC_PAUSE_CFG_TX_FRAME_CTRL_2);\n\tval |= 0xffff;\n\tvsc8584_macsec_phy_write(phydev, bank,\n\t\t\t\t MSCC_MAC_PAUSE_CFG_TX_FRAME_CTRL_2, val);\n\n\tval = vsc8584_macsec_phy_read(phydev, bank,\n\t\t\t\t      MSCC_MAC_PAUSE_CFG_RX_FRAME_CTRL);\n\tif (bank == HOST_MAC)\n\t\tval |= MSCC_MAC_PAUSE_CFG_RX_FRAME_CTRL_PAUSE_TIMER_ENA |\n\t\t       MSCC_MAC_PAUSE_CFG_RX_FRAME_CTRL_PAUSE_FRAME_DROP_ENA;\n\telse\n\t\tval |= MSCC_MAC_PAUSE_CFG_RX_FRAME_CTRL_PAUSE_REACT_ENA |\n\t\t       MSCC_MAC_PAUSE_CFG_RX_FRAME_CTRL_PAUSE_FRAME_DROP_ENA |\n\t\t       MSCC_MAC_PAUSE_CFG_RX_FRAME_CTRL_PAUSE_MODE |\n\t\t       MSCC_MAC_PAUSE_CFG_RX_FRAME_CTRL_EARLY_PAUSE_DETECT_ENA;\n\tvsc8584_macsec_phy_write(phydev, bank,\n\t\t\t\t MSCC_MAC_PAUSE_CFG_RX_FRAME_CTRL, val);\n\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MAC_CFG_PKTINF_CFG,\n\t\t\t\t MSCC_MAC_CFG_PKTINF_CFG_STRIP_FCS_ENA |\n\t\t\t\t MSCC_MAC_CFG_PKTINF_CFG_INSERT_FCS_ENA |\n\t\t\t\t MSCC_MAC_CFG_PKTINF_CFG_LPI_RELAY_ENA |\n\t\t\t\t MSCC_MAC_CFG_PKTINF_CFG_STRIP_PREAMBLE_ENA |\n\t\t\t\t MSCC_MAC_CFG_PKTINF_CFG_INSERT_PREAMBLE_ENA |\n\t\t\t\t (bank == HOST_MAC ?\n\t\t\t\t  MSCC_MAC_CFG_PKTINF_CFG_ENABLE_TX_PADDING : 0) |\n\t\t\t\t (IS_ENABLED(CONFIG_NETWORK_PHY_TIMESTAMPING) ?\n\t\t\t\t  MSCC_MAC_CFG_PKTINF_CFG_MACSEC_BYPASS_NUM_PTP_STALL_CLKS(0x8) : 0));\n\n\tval = vsc8584_macsec_phy_read(phydev, bank, MSCC_MAC_CFG_MODE_CFG);\n\tval &= ~MSCC_MAC_CFG_MODE_CFG_DISABLE_DIC;\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MAC_CFG_MODE_CFG, val);\n\n\tval = vsc8584_macsec_phy_read(phydev, bank, MSCC_MAC_CFG_MAXLEN_CFG);\n\tval &= ~MSCC_MAC_CFG_MAXLEN_CFG_MAX_LEN_M;\n\tval |= MSCC_MAC_CFG_MAXLEN_CFG_MAX_LEN(10240);\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MAC_CFG_MAXLEN_CFG, val);\n\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MAC_CFG_ADV_CHK_CFG,\n\t\t\t\t MSCC_MAC_CFG_ADV_CHK_CFG_SFD_CHK_ENA |\n\t\t\t\t MSCC_MAC_CFG_ADV_CHK_CFG_PRM_CHK_ENA |\n\t\t\t\t MSCC_MAC_CFG_ADV_CHK_CFG_OOR_ERR_ENA |\n\t\t\t\t MSCC_MAC_CFG_ADV_CHK_CFG_INR_ERR_ENA);\n\n\tval = vsc8584_macsec_phy_read(phydev, bank, MSCC_MAC_CFG_LFS_CFG);\n\tval &= ~MSCC_MAC_CFG_LFS_CFG_LFS_MODE_ENA;\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MAC_CFG_LFS_CFG, val);\n\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MAC_CFG_ENA_CFG,\n\t\t\t\t MSCC_MAC_CFG_ENA_CFG_RX_CLK_ENA |\n\t\t\t\t MSCC_MAC_CFG_ENA_CFG_TX_CLK_ENA |\n\t\t\t\t MSCC_MAC_CFG_ENA_CFG_RX_ENA |\n\t\t\t\t MSCC_MAC_CFG_ENA_CFG_TX_ENA);\n}\n\n \nstatic int __vsc8584_macsec_init(struct phy_device *phydev)\n{\n\tstruct vsc8531_private *priv = phydev->priv;\n\tenum macsec_bank proc_bank;\n\tu32 val;\n\n\tvsc8584_macsec_block_init(phydev, MACSEC_INGR);\n\tvsc8584_macsec_block_init(phydev, MACSEC_EGR);\n\tvsc8584_macsec_mac_init(phydev, HOST_MAC);\n\tvsc8584_macsec_mac_init(phydev, LINE_MAC);\n\n\tvsc8584_macsec_phy_write(phydev, FC_BUFFER,\n\t\t\t\t MSCC_FCBUF_FC_READ_THRESH_CFG,\n\t\t\t\t MSCC_FCBUF_FC_READ_THRESH_CFG_TX_THRESH(4) |\n\t\t\t\t MSCC_FCBUF_FC_READ_THRESH_CFG_RX_THRESH(5));\n\n\tval = vsc8584_macsec_phy_read(phydev, FC_BUFFER, MSCC_FCBUF_MODE_CFG);\n\tval |= MSCC_FCBUF_MODE_CFG_PAUSE_GEN_ENA |\n\t       MSCC_FCBUF_MODE_CFG_RX_PPM_RATE_ADAPT_ENA |\n\t       MSCC_FCBUF_MODE_CFG_TX_PPM_RATE_ADAPT_ENA;\n\tvsc8584_macsec_phy_write(phydev, FC_BUFFER, MSCC_FCBUF_MODE_CFG, val);\n\n\tvsc8584_macsec_phy_write(phydev, FC_BUFFER, MSCC_FCBUF_PPM_RATE_ADAPT_THRESH_CFG,\n\t\t\t\t MSCC_FCBUF_PPM_RATE_ADAPT_THRESH_CFG_TX_THRESH(8) |\n\t\t\t\t MSCC_FCBUF_PPM_RATE_ADAPT_THRESH_CFG_TX_OFFSET(9));\n\n\tval = vsc8584_macsec_phy_read(phydev, FC_BUFFER,\n\t\t\t\t      MSCC_FCBUF_TX_DATA_QUEUE_CFG);\n\tval &= ~(MSCC_FCBUF_TX_DATA_QUEUE_CFG_START_M |\n\t\t MSCC_FCBUF_TX_DATA_QUEUE_CFG_END_M);\n\tval |= MSCC_FCBUF_TX_DATA_QUEUE_CFG_START(0) |\n\t\tMSCC_FCBUF_TX_DATA_QUEUE_CFG_END(5119);\n\tvsc8584_macsec_phy_write(phydev, FC_BUFFER,\n\t\t\t\t MSCC_FCBUF_TX_DATA_QUEUE_CFG, val);\n\n\tval = vsc8584_macsec_phy_read(phydev, FC_BUFFER, MSCC_FCBUF_ENA_CFG);\n\tval |= MSCC_FCBUF_ENA_CFG_TX_ENA | MSCC_FCBUF_ENA_CFG_RX_ENA;\n\tvsc8584_macsec_phy_write(phydev, FC_BUFFER, MSCC_FCBUF_ENA_CFG, val);\n\n\tproc_bank = (priv->addr < 2) ? PROC_0 : PROC_2;\n\n\tval = vsc8584_macsec_phy_read(phydev, proc_bank,\n\t\t\t\t      MSCC_PROC_IP_1588_TOP_CFG_STAT_MODE_CTL);\n\tval &= ~MSCC_PROC_IP_1588_TOP_CFG_STAT_MODE_CTL_PROTOCOL_MODE_M;\n\tval |= MSCC_PROC_IP_1588_TOP_CFG_STAT_MODE_CTL_PROTOCOL_MODE(4);\n\tvsc8584_macsec_phy_write(phydev, proc_bank,\n\t\t\t\t MSCC_PROC_IP_1588_TOP_CFG_STAT_MODE_CTL, val);\n\n\treturn 0;\n}\n\nstatic void vsc8584_macsec_flow(struct phy_device *phydev,\n\t\t\t\tstruct macsec_flow *flow)\n{\n\tstruct vsc8531_private *priv = phydev->priv;\n\tenum macsec_bank bank = flow->bank;\n\tu32 val, match = 0, mask = 0, action = 0, idx = flow->index;\n\n\tif (flow->match.tagged)\n\t\tmatch |= MSCC_MS_SAM_MISC_MATCH_TAGGED;\n\tif (flow->match.untagged)\n\t\tmatch |= MSCC_MS_SAM_MISC_MATCH_UNTAGGED;\n\n\tif (bank == MACSEC_INGR && flow->assoc_num >= 0) {\n\t\tmatch |= MSCC_MS_SAM_MISC_MATCH_AN(flow->assoc_num);\n\t\tmask |= MSCC_MS_SAM_MASK_AN_MASK(0x3);\n\t}\n\n\tif (bank == MACSEC_INGR && flow->match.sci && flow->rx_sa->sc->sci) {\n\t\tu64 sci = (__force u64)flow->rx_sa->sc->sci;\n\n\t\tmatch |= MSCC_MS_SAM_MISC_MATCH_TCI(BIT(3));\n\t\tmask |= MSCC_MS_SAM_MASK_TCI_MASK(BIT(3)) |\n\t\t\tMSCC_MS_SAM_MASK_SCI_MASK;\n\n\t\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_MATCH_SCI_LO(idx),\n\t\t\t\t\t lower_32_bits(sci));\n\t\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_MATCH_SCI_HI(idx),\n\t\t\t\t\t upper_32_bits(sci));\n\t}\n\n\tif (flow->match.etype) {\n\t\tmask |= MSCC_MS_SAM_MASK_MAC_ETYPE_MASK;\n\n\t\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_MAC_SA_MATCH_HI(idx),\n\t\t\t\t\t MSCC_MS_SAM_MAC_SA_MATCH_HI_ETYPE((__force u32)htons(flow->etype)));\n\t}\n\n\tmatch |= MSCC_MS_SAM_MISC_MATCH_PRIORITY(flow->priority);\n\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_MISC_MATCH(idx), match);\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_MASK(idx), mask);\n\n\t \n\tif (flow->action.drop)\n\t\taction = MSCC_MS_FLOW_DROP;\n\telse if (flow->action.bypass || flow->port == MSCC_MS_PORT_UNCONTROLLED)\n\t\taction = MSCC_MS_FLOW_BYPASS;\n\telse\n\t\taction = (bank == MACSEC_INGR) ?\n\t\t\t MSCC_MS_FLOW_INGRESS : MSCC_MS_FLOW_EGRESS;\n\n\tval = MSCC_MS_SAM_FLOW_CTRL_FLOW_TYPE(action) |\n\t      MSCC_MS_SAM_FLOW_CTRL_DROP_ACTION(MSCC_MS_ACTION_DROP) |\n\t      MSCC_MS_SAM_FLOW_CTRL_DEST_PORT(flow->port);\n\n\tif (action == MSCC_MS_FLOW_BYPASS)\n\t\tgoto write_ctrl;\n\n\tif (bank == MACSEC_INGR) {\n\t\tif (priv->secy->replay_protect)\n\t\t\tval |= MSCC_MS_SAM_FLOW_CTRL_REPLAY_PROTECT;\n\t\tif (priv->secy->validate_frames == MACSEC_VALIDATE_STRICT)\n\t\t\tval |= MSCC_MS_SAM_FLOW_CTRL_VALIDATE_FRAMES(MSCC_MS_VALIDATE_STRICT);\n\t\telse if (priv->secy->validate_frames == MACSEC_VALIDATE_CHECK)\n\t\t\tval |= MSCC_MS_SAM_FLOW_CTRL_VALIDATE_FRAMES(MSCC_MS_VALIDATE_CHECK);\n\t} else if (bank == MACSEC_EGR) {\n\t\tif (priv->secy->protect_frames)\n\t\t\tval |= MSCC_MS_SAM_FLOW_CTRL_PROTECT_FRAME;\n\t\tif (priv->secy->tx_sc.encrypt)\n\t\t\tval |= MSCC_MS_SAM_FLOW_CTRL_CONF_PROTECT;\n\t\tif (priv->secy->tx_sc.send_sci)\n\t\t\tval |= MSCC_MS_SAM_FLOW_CTRL_INCLUDE_SCI;\n\t}\n\nwrite_ctrl:\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_FLOW_CTRL(idx), val);\n}\n\nstatic struct macsec_flow *vsc8584_macsec_find_flow(struct macsec_context *ctx,\n\t\t\t\t\t\t    enum macsec_bank bank)\n{\n\tstruct vsc8531_private *priv = ctx->phydev->priv;\n\tstruct macsec_flow *pos, *tmp;\n\n\tlist_for_each_entry_safe(pos, tmp, &priv->macsec_flows, list)\n\t\tif (pos->assoc_num == ctx->sa.assoc_num && pos->bank == bank)\n\t\t\treturn pos;\n\n\treturn ERR_PTR(-ENOENT);\n}\n\nstatic void vsc8584_macsec_flow_enable(struct phy_device *phydev,\n\t\t\t\t       struct macsec_flow *flow)\n{\n\tenum macsec_bank bank = flow->bank;\n\tu32 val, idx = flow->index;\n\n\tif ((flow->bank == MACSEC_INGR && flow->rx_sa && !flow->rx_sa->active) ||\n\t    (flow->bank == MACSEC_EGR && flow->tx_sa && !flow->tx_sa->active))\n\t\treturn;\n\n\t \n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_ENTRY_SET1, BIT(idx));\n\n\t \n\tval = vsc8584_macsec_phy_read(phydev, bank, MSCC_MS_SAM_FLOW_CTRL(idx));\n\tval |= MSCC_MS_SAM_FLOW_CTRL_SA_IN_USE;\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_FLOW_CTRL(idx), val);\n}\n\nstatic void vsc8584_macsec_flow_disable(struct phy_device *phydev,\n\t\t\t\t\tstruct macsec_flow *flow)\n{\n\tenum macsec_bank bank = flow->bank;\n\tu32 val, idx = flow->index;\n\n\t \n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_ENTRY_CLEAR1, BIT(idx));\n\n\t \n\tval = vsc8584_macsec_phy_read(phydev, bank, MSCC_MS_SAM_FLOW_CTRL(idx));\n\tval &= ~MSCC_MS_SAM_FLOW_CTRL_SA_IN_USE;\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_SAM_FLOW_CTRL(idx), val);\n}\n\nstatic u32 vsc8584_macsec_flow_context_id(struct macsec_flow *flow)\n{\n\tif (flow->bank == MACSEC_INGR)\n\t\treturn flow->index + MSCC_MS_MAX_FLOWS;\n\n\treturn flow->index;\n}\n\n \nstatic int vsc8584_macsec_derive_key(const u8 *key, u16 key_len, u8 hkey[16])\n{\n\tconst u8 input[AES_BLOCK_SIZE] = {0};\n\tstruct crypto_aes_ctx ctx;\n\tint ret;\n\n\tret = aes_expandkey(&ctx, key, key_len);\n\tif (ret)\n\t\treturn ret;\n\n\taes_encrypt(&ctx, hkey, input);\n\tmemzero_explicit(&ctx, sizeof(ctx));\n\treturn 0;\n}\n\nstatic int vsc8584_macsec_transformation(struct phy_device *phydev,\n\t\t\t\t\t struct macsec_flow *flow,\n\t\t\t\t\t const u8 *key)\n{\n\tstruct vsc8531_private *priv = phydev->priv;\n\tenum macsec_bank bank = flow->bank;\n\tint i, ret, index = flow->index;\n\tu32 rec = 0, control = 0;\n\tu8 hkey[16];\n\tu64 sci;\n\n\tret = vsc8584_macsec_derive_key(key, priv->secy->key_len, hkey);\n\tif (ret)\n\t\treturn ret;\n\n\tswitch (priv->secy->key_len) {\n\tcase 16:\n\t\tcontrol |= CONTROL_CRYPTO_ALG(CTRYPTO_ALG_AES_CTR_128);\n\t\tbreak;\n\tcase 32:\n\t\tcontrol |= CONTROL_CRYPTO_ALG(CTRYPTO_ALG_AES_CTR_256);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tcontrol |= (bank == MACSEC_EGR) ?\n\t\t   (CONTROL_TYPE_EGRESS | CONTROL_AN(priv->secy->tx_sc.encoding_sa)) :\n\t\t   (CONTROL_TYPE_INGRESS | CONTROL_SEQ_MASK);\n\n\tcontrol |= CONTROL_UPDATE_SEQ | CONTROL_ENCRYPT_AUTH | CONTROL_KEY_IN_CTX |\n\t\t   CONTROL_IV0 | CONTROL_IV1 | CONTROL_IV_IN_SEQ |\n\t\t   CONTROL_DIGEST_TYPE(0x2) | CONTROL_SEQ_TYPE(0x1) |\n\t\t   CONTROL_AUTH_ALG(AUTH_ALG_AES_GHAS) | CONTROL_CONTEXT_ID;\n\n\t \n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_XFORM_REC(index, rec++),\n\t\t\t\t control);\n\n\t \n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_XFORM_REC(index, rec++),\n\t\t\t\t vsc8584_macsec_flow_context_id(flow));\n\n\t \n\tfor (i = 0; i < priv->secy->key_len / sizeof(u32); i++)\n\t\tvsc8584_macsec_phy_write(phydev, bank,\n\t\t\t\t\t MSCC_MS_XFORM_REC(index, rec++),\n\t\t\t\t\t ((u32 *)key)[i]);\n\n\t \n\tfor (i = 0; i < 4; i++)\n\t\tvsc8584_macsec_phy_write(phydev, bank,\n\t\t\t\t\t MSCC_MS_XFORM_REC(index, rec++),\n\t\t\t\t\t ((u32 *)hkey)[i]);\n\n\t \n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_XFORM_REC(index, rec++),\n\t\t\t\t bank == MACSEC_INGR ?\n\t\t\t\t flow->rx_sa->next_pn : flow->tx_sa->next_pn);\n\n\tif (bank == MACSEC_INGR)\n\t\t \n\t\tvsc8584_macsec_phy_write(phydev, bank,\n\t\t\t\t\t MSCC_MS_XFORM_REC(index, rec++),\n\t\t\t\t\t priv->secy->replay_window);\n\n\t \n\tsci = (__force u64)(bank == MACSEC_INGR ? flow->rx_sa->sc->sci : priv->secy->sci);\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_XFORM_REC(index, rec++),\n\t\t\t\t lower_32_bits(sci));\n\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_XFORM_REC(index, rec++),\n\t\t\t\t upper_32_bits(sci));\n\n\twhile (rec < 20)\n\t\tvsc8584_macsec_phy_write(phydev, bank, MSCC_MS_XFORM_REC(index, rec++),\n\t\t\t\t\t 0);\n\n\tflow->has_transformation = true;\n\treturn 0;\n}\n\nstatic struct macsec_flow *vsc8584_macsec_alloc_flow(struct vsc8531_private *priv,\n\t\t\t\t\t\t     enum macsec_bank bank)\n{\n\tunsigned long *bitmap = bank == MACSEC_INGR ?\n\t\t\t\t&priv->ingr_flows : &priv->egr_flows;\n\tstruct macsec_flow *flow;\n\tint index;\n\n\tindex = find_first_zero_bit(bitmap, MSCC_MS_MAX_FLOWS);\n\n\tif (index == MSCC_MS_MAX_FLOWS)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tflow = kzalloc(sizeof(*flow), GFP_KERNEL);\n\tif (!flow)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tset_bit(index, bitmap);\n\tflow->index = index;\n\tflow->bank = bank;\n\tflow->priority = 8;\n\tflow->assoc_num = -1;\n\n\tlist_add_tail(&flow->list, &priv->macsec_flows);\n\treturn flow;\n}\n\nstatic void vsc8584_macsec_free_flow(struct vsc8531_private *priv,\n\t\t\t\t     struct macsec_flow *flow)\n{\n\tunsigned long *bitmap = flow->bank == MACSEC_INGR ?\n\t\t\t\t&priv->ingr_flows : &priv->egr_flows;\n\n\tlist_del(&flow->list);\n\tclear_bit(flow->index, bitmap);\n\tkfree(flow);\n}\n\nstatic void vsc8584_macsec_add_flow(struct phy_device *phydev,\n\t\t\t\t    struct macsec_flow *flow)\n{\n\tflow->port = MSCC_MS_PORT_CONTROLLED;\n\tvsc8584_macsec_flow(phydev, flow);\n}\n\nstatic int vsc8584_macsec_default_flows(struct phy_device *phydev)\n{\n\tstruct macsec_flow *flow;\n\n\t \n\tflow = vsc8584_macsec_alloc_flow(phydev->priv, MACSEC_INGR);\n\tif (IS_ERR(flow))\n\t\treturn PTR_ERR(flow);\n\n\tflow->priority = 15;\n\tflow->port = MSCC_MS_PORT_UNCONTROLLED;\n\tflow->match.tagged = 1;\n\tflow->match.untagged = 1;\n\tflow->match.etype = 1;\n\tflow->etype = ETH_P_PAE;\n\tflow->action.bypass = 1;\n\n\tvsc8584_macsec_flow(phydev, flow);\n\tvsc8584_macsec_flow_enable(phydev, flow);\n\n\t \n\tflow = vsc8584_macsec_alloc_flow(phydev->priv, MACSEC_EGR);\n\tif (IS_ERR(flow))\n\t\treturn PTR_ERR(flow);\n\n\tflow->priority = 15;\n\tflow->port = MSCC_MS_PORT_COMMON;\n\tflow->match.untagged = 1;\n\tflow->match.etype = 1;\n\tflow->etype = ETH_P_PAE;\n\tflow->action.bypass = 1;\n\n\tvsc8584_macsec_flow(phydev, flow);\n\tvsc8584_macsec_flow_enable(phydev, flow);\n\n\treturn 0;\n}\n\nstatic void vsc8584_macsec_del_flow(struct phy_device *phydev,\n\t\t\t\t    struct macsec_flow *flow)\n{\n\tvsc8584_macsec_flow_disable(phydev, flow);\n\tvsc8584_macsec_free_flow(phydev->priv, flow);\n}\n\nstatic int __vsc8584_macsec_add_rxsa(struct macsec_context *ctx,\n\t\t\t\t     struct macsec_flow *flow, bool update)\n{\n\tstruct phy_device *phydev = ctx->phydev;\n\tstruct vsc8531_private *priv = phydev->priv;\n\tint ret;\n\n\tflow->assoc_num = ctx->sa.assoc_num;\n\tflow->rx_sa = ctx->sa.rx_sa;\n\n\t \n\tflow->match.tagged = 1;\n\tflow->match.sci = 1;\n\n\tif (priv->secy->validate_frames != MACSEC_VALIDATE_DISABLED)\n\t\tflow->match.untagged = 1;\n\n\tvsc8584_macsec_add_flow(phydev, flow);\n\n\tif (update)\n\t\treturn 0;\n\n\tret = vsc8584_macsec_transformation(phydev, flow, ctx->sa.key);\n\tif (ret)\n\t\tvsc8584_macsec_free_flow(phydev->priv, flow);\n\n\treturn ret;\n}\n\nstatic int __vsc8584_macsec_add_txsa(struct macsec_context *ctx,\n\t\t\t\t     struct macsec_flow *flow, bool update)\n{\n\tint ret;\n\n\tflow->assoc_num = ctx->sa.assoc_num;\n\tflow->tx_sa = ctx->sa.tx_sa;\n\n\t \n\tflow->match.untagged = 1;\n\n\tvsc8584_macsec_add_flow(ctx->phydev, flow);\n\n\tif (update)\n\t\treturn 0;\n\n\tret = vsc8584_macsec_transformation(ctx->phydev, flow, ctx->sa.key);\n\tif (ret)\n\t\tvsc8584_macsec_free_flow(ctx->phydev->priv, flow);\n\n\treturn ret;\n}\n\nstatic int vsc8584_macsec_dev_open(struct macsec_context *ctx)\n{\n\tstruct vsc8531_private *priv = ctx->phydev->priv;\n\tstruct macsec_flow *flow, *tmp;\n\n\tlist_for_each_entry_safe(flow, tmp, &priv->macsec_flows, list)\n\t\tvsc8584_macsec_flow_enable(ctx->phydev, flow);\n\n\treturn 0;\n}\n\nstatic int vsc8584_macsec_dev_stop(struct macsec_context *ctx)\n{\n\tstruct vsc8531_private *priv = ctx->phydev->priv;\n\tstruct macsec_flow *flow, *tmp;\n\n\tlist_for_each_entry_safe(flow, tmp, &priv->macsec_flows, list)\n\t\tvsc8584_macsec_flow_disable(ctx->phydev, flow);\n\n\treturn 0;\n}\n\nstatic int vsc8584_macsec_add_secy(struct macsec_context *ctx)\n{\n\tstruct vsc8531_private *priv = ctx->phydev->priv;\n\tstruct macsec_secy *secy = ctx->secy;\n\n\tif (priv->secy)\n\t\treturn -EEXIST;\n\n\tpriv->secy = secy;\n\n\tvsc8584_macsec_flow_default_action(ctx->phydev, MACSEC_EGR,\n\t\t\t\t\t   secy->validate_frames != MACSEC_VALIDATE_DISABLED);\n\tvsc8584_macsec_flow_default_action(ctx->phydev, MACSEC_INGR,\n\t\t\t\t\t   secy->validate_frames != MACSEC_VALIDATE_DISABLED);\n\n\treturn vsc8584_macsec_default_flows(ctx->phydev);\n}\n\nstatic int vsc8584_macsec_del_secy(struct macsec_context *ctx)\n{\n\tstruct vsc8531_private *priv = ctx->phydev->priv;\n\tstruct macsec_flow *flow, *tmp;\n\n\tlist_for_each_entry_safe(flow, tmp, &priv->macsec_flows, list)\n\t\tvsc8584_macsec_del_flow(ctx->phydev, flow);\n\n\tvsc8584_macsec_flow_default_action(ctx->phydev, MACSEC_EGR, false);\n\tvsc8584_macsec_flow_default_action(ctx->phydev, MACSEC_INGR, false);\n\n\tpriv->secy = NULL;\n\treturn 0;\n}\n\nstatic int vsc8584_macsec_upd_secy(struct macsec_context *ctx)\n{\n\tvsc8584_macsec_del_secy(ctx);\n\treturn vsc8584_macsec_add_secy(ctx);\n}\n\nstatic int vsc8584_macsec_add_rxsc(struct macsec_context *ctx)\n{\n\t \n\treturn 0;\n}\n\nstatic int vsc8584_macsec_upd_rxsc(struct macsec_context *ctx)\n{\n\treturn -EOPNOTSUPP;\n}\n\nstatic int vsc8584_macsec_del_rxsc(struct macsec_context *ctx)\n{\n\tstruct vsc8531_private *priv = ctx->phydev->priv;\n\tstruct macsec_flow *flow, *tmp;\n\n\tlist_for_each_entry_safe(flow, tmp, &priv->macsec_flows, list) {\n\t\tif (flow->bank == MACSEC_INGR && flow->rx_sa &&\n\t\t    flow->rx_sa->sc->sci == ctx->rx_sc->sci)\n\t\t\tvsc8584_macsec_del_flow(ctx->phydev, flow);\n\t}\n\n\treturn 0;\n}\n\nstatic int vsc8584_macsec_add_rxsa(struct macsec_context *ctx)\n{\n\tstruct phy_device *phydev = ctx->phydev;\n\tstruct vsc8531_private *priv = phydev->priv;\n\tstruct macsec_flow *flow;\n\tint ret;\n\n\tflow = vsc8584_macsec_alloc_flow(priv, MACSEC_INGR);\n\tif (IS_ERR(flow))\n\t\treturn PTR_ERR(flow);\n\n\tret = __vsc8584_macsec_add_rxsa(ctx, flow, false);\n\tif (ret)\n\t\treturn ret;\n\n\tvsc8584_macsec_flow_enable(phydev, flow);\n\treturn 0;\n}\n\nstatic int vsc8584_macsec_upd_rxsa(struct macsec_context *ctx)\n{\n\tstruct macsec_flow *flow;\n\tint ret;\n\n\tif (ctx->sa.update_pn)\n\t\treturn -EINVAL;\n\n\tflow = vsc8584_macsec_find_flow(ctx, MACSEC_INGR);\n\tif (IS_ERR(flow))\n\t\treturn PTR_ERR(flow);\n\n\t \n\tvsc8584_macsec_flow_disable(ctx->phydev, flow);\n\n\tret = __vsc8584_macsec_add_rxsa(ctx, flow, true);\n\tif (ret)\n\t\treturn ret;\n\n\tvsc8584_macsec_flow_enable(ctx->phydev, flow);\n\treturn 0;\n}\n\nstatic int vsc8584_macsec_del_rxsa(struct macsec_context *ctx)\n{\n\tstruct macsec_flow *flow;\n\n\tflow = vsc8584_macsec_find_flow(ctx, MACSEC_INGR);\n\tif (IS_ERR(flow))\n\t\treturn PTR_ERR(flow);\n\n\tvsc8584_macsec_del_flow(ctx->phydev, flow);\n\treturn 0;\n}\n\nstatic int vsc8584_macsec_add_txsa(struct macsec_context *ctx)\n{\n\tstruct phy_device *phydev = ctx->phydev;\n\tstruct vsc8531_private *priv = phydev->priv;\n\tstruct macsec_flow *flow;\n\tint ret;\n\n\tflow = vsc8584_macsec_alloc_flow(priv, MACSEC_EGR);\n\tif (IS_ERR(flow))\n\t\treturn PTR_ERR(flow);\n\n\tret = __vsc8584_macsec_add_txsa(ctx, flow, false);\n\tif (ret)\n\t\treturn ret;\n\n\tvsc8584_macsec_flow_enable(phydev, flow);\n\treturn 0;\n}\n\nstatic int vsc8584_macsec_upd_txsa(struct macsec_context *ctx)\n{\n\tstruct macsec_flow *flow;\n\tint ret;\n\n\tif (ctx->sa.update_pn)\n\t\treturn -EINVAL;\n\n\tflow = vsc8584_macsec_find_flow(ctx, MACSEC_EGR);\n\tif (IS_ERR(flow))\n\t\treturn PTR_ERR(flow);\n\n\t \n\tvsc8584_macsec_flow_disable(ctx->phydev, flow);\n\n\tret = __vsc8584_macsec_add_txsa(ctx, flow, true);\n\tif (ret)\n\t\treturn ret;\n\n\tvsc8584_macsec_flow_enable(ctx->phydev, flow);\n\treturn 0;\n}\n\nstatic int vsc8584_macsec_del_txsa(struct macsec_context *ctx)\n{\n\tstruct macsec_flow *flow;\n\n\tflow = vsc8584_macsec_find_flow(ctx, MACSEC_EGR);\n\tif (IS_ERR(flow))\n\t\treturn PTR_ERR(flow);\n\n\tvsc8584_macsec_del_flow(ctx->phydev, flow);\n\treturn 0;\n}\n\nstatic const struct macsec_ops vsc8584_macsec_ops = {\n\t.mdo_dev_open = vsc8584_macsec_dev_open,\n\t.mdo_dev_stop = vsc8584_macsec_dev_stop,\n\t.mdo_add_secy = vsc8584_macsec_add_secy,\n\t.mdo_upd_secy = vsc8584_macsec_upd_secy,\n\t.mdo_del_secy = vsc8584_macsec_del_secy,\n\t.mdo_add_rxsc = vsc8584_macsec_add_rxsc,\n\t.mdo_upd_rxsc = vsc8584_macsec_upd_rxsc,\n\t.mdo_del_rxsc = vsc8584_macsec_del_rxsc,\n\t.mdo_add_rxsa = vsc8584_macsec_add_rxsa,\n\t.mdo_upd_rxsa = vsc8584_macsec_upd_rxsa,\n\t.mdo_del_rxsa = vsc8584_macsec_del_rxsa,\n\t.mdo_add_txsa = vsc8584_macsec_add_txsa,\n\t.mdo_upd_txsa = vsc8584_macsec_upd_txsa,\n\t.mdo_del_txsa = vsc8584_macsec_del_txsa,\n};\n\nint vsc8584_macsec_init(struct phy_device *phydev)\n{\n\tstruct vsc8531_private *vsc8531 = phydev->priv;\n\n\tswitch (phydev->phy_id & phydev->drv->phy_id_mask) {\n\tcase PHY_ID_VSC856X:\n\tcase PHY_ID_VSC8582:\n\tcase PHY_ID_VSC8584:\n\t\tINIT_LIST_HEAD(&vsc8531->macsec_flows);\n\t\tvsc8531->secy = NULL;\n\n\t\tphydev->macsec_ops = &vsc8584_macsec_ops;\n\n\t\treturn __vsc8584_macsec_init(phydev);\n\t}\n\n\treturn 0;\n}\n\nvoid vsc8584_handle_macsec_interrupt(struct phy_device *phydev)\n{\n\tstruct vsc8531_private *priv = phydev->priv;\n\tstruct macsec_flow *flow, *tmp;\n\tu32 cause, rec;\n\n\t \n\tcause = vsc8584_macsec_phy_read(phydev, MACSEC_EGR,\n\t\t\t\t\tMSCC_MS_INTR_CTRL_STATUS);\n\tcause &= MSCC_MS_INTR_CTRL_STATUS_INTR_CLR_STATUS_M;\n\tif (!(cause & MACSEC_INTR_CTRL_STATUS_ROLLOVER))\n\t\treturn;\n\n\trec = 6 + priv->secy->key_len / sizeof(u32);\n\tlist_for_each_entry_safe(flow, tmp, &priv->macsec_flows, list) {\n\t\tu32 val;\n\n\t\tif (flow->bank != MACSEC_EGR || !flow->has_transformation)\n\t\t\tcontinue;\n\n\t\tval = vsc8584_macsec_phy_read(phydev, MACSEC_EGR,\n\t\t\t\t\t      MSCC_MS_XFORM_REC(flow->index, rec));\n\t\tif (val == 0xffffffff) {\n\t\t\tvsc8584_macsec_flow_disable(phydev, flow);\n\t\t\tmacsec_pn_wrapped(priv->secy, flow->tx_sa);\n\t\t\treturn;\n\t\t}\n\t}\n}\n\nvoid vsc8584_config_macsec_intr(struct phy_device *phydev)\n{\n\tphy_write(phydev, MSCC_EXT_PAGE_ACCESS, MSCC_PHY_PAGE_EXTENDED_2);\n\tphy_write(phydev, MSCC_PHY_EXTENDED_INT, MSCC_PHY_EXTENDED_INT_MS_EGR);\n\tphy_write(phydev, MSCC_EXT_PAGE_ACCESS, MSCC_PHY_PAGE_STANDARD);\n\n\tvsc8584_macsec_phy_write(phydev, MACSEC_EGR, MSCC_MS_AIC_CTRL, 0xf);\n\tvsc8584_macsec_phy_write(phydev, MACSEC_EGR, MSCC_MS_INTR_CTRL_STATUS,\n\t\t\t\t MSCC_MS_INTR_CTRL_STATUS_INTR_ENABLE(MACSEC_INTR_CTRL_STATUS_ROLLOVER));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}