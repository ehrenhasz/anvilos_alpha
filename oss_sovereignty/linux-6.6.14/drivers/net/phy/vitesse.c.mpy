{
  "module_name": "vitesse.c",
  "hash_id": "5ce45d470263e6a066ea51d0ccc0b030f4c3f55608dada0d331dc879943dca74",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/vitesse.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mii.h>\n#include <linux/ethtool.h>\n#include <linux/phy.h>\n\n \n#define MII_VSC82X4_EXT_PAGE_16E\t0x10\n#define MII_VSC82X4_EXT_PAGE_17E\t0x11\n#define MII_VSC82X4_EXT_PAGE_18E\t0x12\n\n \n#define MII_VSC8244_EXT_CON1           0x17\n#define MII_VSC8244_EXTCON1_INIT       0x0000\n#define MII_VSC8244_EXTCON1_TX_SKEW_MASK\t0x0c00\n#define MII_VSC8244_EXTCON1_RX_SKEW_MASK\t0x0300\n#define MII_VSC8244_EXTCON1_TX_SKEW\t0x0800\n#define MII_VSC8244_EXTCON1_RX_SKEW\t0x0200\n\n \n#define MII_VSC8244_IMASK\t\t0x19\n#define MII_VSC8244_IMASK_IEN\t\t0x8000\n#define MII_VSC8244_IMASK_SPEED\t\t0x4000\n#define MII_VSC8244_IMASK_LINK\t\t0x2000\n#define MII_VSC8244_IMASK_DUPLEX\t0x1000\n#define MII_VSC8244_IMASK_MASK\t\t0xf000\n\n#define MII_VSC8221_IMASK_MASK\t\t0xa000\n\n \n#define MII_VSC8244_ISTAT\t\t0x1a\n#define MII_VSC8244_ISTAT_STATUS\t0x8000\n#define MII_VSC8244_ISTAT_SPEED\t\t0x4000\n#define MII_VSC8244_ISTAT_LINK\t\t0x2000\n#define MII_VSC8244_ISTAT_DUPLEX\t0x1000\n#define MII_VSC8244_ISTAT_MASK\t\t(MII_VSC8244_ISTAT_SPEED | \\\n\t\t\t\t\t MII_VSC8244_ISTAT_LINK | \\\n\t\t\t\t\t MII_VSC8244_ISTAT_DUPLEX)\n\n#define MII_VSC8221_ISTAT_MASK\t\tMII_VSC8244_ISTAT_LINK\n\n \n#define MII_VSC8244_AUX_CONSTAT\t\t0x1c\n#define MII_VSC8244_AUXCONSTAT_INIT\t0x0000\n#define MII_VSC8244_AUXCONSTAT_DUPLEX\t0x0020\n#define MII_VSC8244_AUXCONSTAT_SPEED\t0x0018\n#define MII_VSC8244_AUXCONSTAT_GBIT\t0x0010\n#define MII_VSC8244_AUXCONSTAT_100\t0x0008\n\n#define MII_VSC8221_AUXCONSTAT_INIT\t0x0004  \n#define MII_VSC8221_AUXCONSTAT_RESERVED\t0x0004\n\n \n#define MII_VSC82X4_EXT_PAGE_ACCESS\t0x1f\n\n \n#define MII_VSC8601_EPHY_CTL\t\t0x17\n#define MII_VSC8601_EPHY_CTL_RGMII_SKEW\t(1 << 8)\n\n#define PHY_ID_VSC8234\t\t\t0x000fc620\n#define PHY_ID_VSC8244\t\t\t0x000fc6c0\n#define PHY_ID_VSC8572\t\t\t0x000704d0\n#define PHY_ID_VSC8601\t\t\t0x00070420\n#define PHY_ID_VSC7385\t\t\t0x00070450\n#define PHY_ID_VSC7388\t\t\t0x00070480\n#define PHY_ID_VSC7395\t\t\t0x00070550\n#define PHY_ID_VSC7398\t\t\t0x00070580\n#define PHY_ID_VSC8662\t\t\t0x00070660\n#define PHY_ID_VSC8221\t\t\t0x000fc550\n#define PHY_ID_VSC8211\t\t\t0x000fc4b0\n\nMODULE_DESCRIPTION(\"Vitesse PHY driver\");\nMODULE_AUTHOR(\"Kriston Carson\");\nMODULE_LICENSE(\"GPL\");\n\nstatic int vsc824x_add_skew(struct phy_device *phydev)\n{\n\tint err;\n\tint extcon;\n\n\textcon = phy_read(phydev, MII_VSC8244_EXT_CON1);\n\n\tif (extcon < 0)\n\t\treturn extcon;\n\n\textcon &= ~(MII_VSC8244_EXTCON1_TX_SKEW_MASK |\n\t\t\tMII_VSC8244_EXTCON1_RX_SKEW_MASK);\n\n\textcon |= (MII_VSC8244_EXTCON1_TX_SKEW |\n\t\t\tMII_VSC8244_EXTCON1_RX_SKEW);\n\n\terr = phy_write(phydev, MII_VSC8244_EXT_CON1, extcon);\n\n\treturn err;\n}\n\nstatic int vsc824x_config_init(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = phy_write(phydev, MII_VSC8244_AUX_CONSTAT,\n\t\t\tMII_VSC8244_AUXCONSTAT_INIT);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID)\n\t\terr = vsc824x_add_skew(phydev);\n\n\treturn err;\n}\n\n#define VSC73XX_EXT_PAGE_ACCESS 0x1f\n\nstatic int vsc73xx_read_page(struct phy_device *phydev)\n{\n\treturn __phy_read(phydev, VSC73XX_EXT_PAGE_ACCESS);\n}\n\nstatic int vsc73xx_write_page(struct phy_device *phydev, int page)\n{\n\treturn __phy_write(phydev, VSC73XX_EXT_PAGE_ACCESS, page);\n}\n\nstatic void vsc73xx_config_init(struct phy_device *phydev)\n{\n\t \n\tphy_write(phydev, 0x1f, 0x2a30);\n\tphy_modify(phydev, 0x0c, 0x0300, 0x0200);\n\tphy_write(phydev, 0x1f, 0x0000);\n\n\t \n\tphy_modify(phydev, MII_TPISTATUS, 0xff00, 0x0061);\n}\n\nstatic int vsc738x_config_init(struct phy_device *phydev)\n{\n\tu16 rev;\n\t \n\tphy_write(phydev, 0x1f, 0x2a30);\n\tphy_modify(phydev, 0x08, 0x0200, 0x0200);\n\tphy_write(phydev, 0x1f, 0x52b5);\n\tphy_write(phydev, 0x10, 0xb68a);\n\tphy_modify(phydev, 0x12, 0xff07, 0x0003);\n\tphy_modify(phydev, 0x11, 0x00ff, 0x00a2);\n\tphy_write(phydev, 0x10, 0x968a);\n\tphy_write(phydev, 0x1f, 0x2a30);\n\tphy_modify(phydev, 0x08, 0x0200, 0x0000);\n\tphy_write(phydev, 0x1f, 0x0000);\n\n\t \n\trev = phy_read(phydev, MII_PHYSID2);\n\trev &= 0x0f;\n\n\t \n\tif (rev == 0) {\n\t\tphy_write(phydev, 0x1f, 0x2a30);\n\t\tphy_modify(phydev, 0x08, 0x0200, 0x0200);\n\t\tphy_write(phydev, 0x1f, 0x52b5);\n\t\tphy_write(phydev, 0x12, 0x0000);\n\t\tphy_write(phydev, 0x11, 0x0689);\n\t\tphy_write(phydev, 0x10, 0x8f92);\n\t\tphy_write(phydev, 0x1f, 0x52b5);\n\t\tphy_write(phydev, 0x12, 0x0000);\n\t\tphy_write(phydev, 0x11, 0x0e35);\n\t\tphy_write(phydev, 0x10, 0x9786);\n\t\tphy_write(phydev, 0x1f, 0x2a30);\n\t\tphy_modify(phydev, 0x08, 0x0200, 0x0000);\n\t\tphy_write(phydev, 0x17, 0xff80);\n\t\tphy_write(phydev, 0x17, 0x0000);\n\t}\n\n\tphy_write(phydev, 0x1f, 0x0000);\n\tphy_write(phydev, 0x12, 0x0048);\n\n\tif (rev == 0) {\n\t\tphy_write(phydev, 0x1f, 0x2a30);\n\t\tphy_write(phydev, 0x14, 0x6600);\n\t\tphy_write(phydev, 0x1f, 0x0000);\n\t\tphy_write(phydev, 0x18, 0xa24e);\n\t} else {\n\t\tphy_write(phydev, 0x1f, 0x2a30);\n\t\tphy_modify(phydev, 0x16, 0x0fc0, 0x0240);\n\t\tphy_modify(phydev, 0x14, 0x6000, 0x4000);\n\t\t \n\t\tphy_write(phydev, 0x1f, 0x0001);\n\t\tphy_modify(phydev, 0x14, 0xe000, 0x6000);\n\t\tphy_write(phydev, 0x1f, 0x0000);\n\t}\n\n\tvsc73xx_config_init(phydev);\n\n\treturn 0;\n}\n\nstatic int vsc739x_config_init(struct phy_device *phydev)\n{\n\t \n\tphy_write(phydev, 0x1f, 0x2a30);\n\tphy_modify(phydev, 0x08, 0x0200, 0x0200);\n\tphy_write(phydev, 0x1f, 0x52b5);\n\tphy_write(phydev, 0x10, 0xb68a);\n\tphy_modify(phydev, 0x12, 0xff07, 0x0003);\n\tphy_modify(phydev, 0x11, 0x00ff, 0x00a2);\n\tphy_write(phydev, 0x10, 0x968a);\n\tphy_write(phydev, 0x1f, 0x2a30);\n\tphy_modify(phydev, 0x08, 0x0200, 0x0000);\n\tphy_write(phydev, 0x1f, 0x0000);\n\n\tphy_write(phydev, 0x1f, 0x0000);\n\tphy_write(phydev, 0x12, 0x0048);\n\tphy_write(phydev, 0x1f, 0x2a30);\n\tphy_modify(phydev, 0x16, 0x0fc0, 0x0240);\n\tphy_modify(phydev, 0x14, 0x6000, 0x4000);\n\tphy_write(phydev, 0x1f, 0x0001);\n\tphy_modify(phydev, 0x14, 0xe000, 0x6000);\n\tphy_write(phydev, 0x1f, 0x0000);\n\n\tvsc73xx_config_init(phydev);\n\n\treturn 0;\n}\n\nstatic int vsc73xx_config_aneg(struct phy_device *phydev)\n{\n\t \n\treturn 0;\n}\n\n \nstatic int vsc8601_add_skew(struct phy_device *phydev)\n{\n\tint ret;\n\n\tret = phy_read(phydev, MII_VSC8601_EPHY_CTL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret |= MII_VSC8601_EPHY_CTL_RGMII_SKEW;\n\treturn phy_write(phydev, MII_VSC8601_EPHY_CTL, ret);\n}\n\nstatic int vsc8601_config_init(struct phy_device *phydev)\n{\n\tint ret = 0;\n\n\tif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID)\n\t\tret = vsc8601_add_skew(phydev);\n\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int vsc82xx_config_intr(struct phy_device *phydev)\n{\n\tint err;\n\n\tif (phydev->interrupts == PHY_INTERRUPT_ENABLED)\n\t\t \n\t\terr = phy_write(phydev, MII_VSC8244_IMASK,\n\t\t\t(phydev->drv->phy_id == PHY_ID_VSC8234 ||\n\t\t\t phydev->drv->phy_id == PHY_ID_VSC8244 ||\n\t\t\t phydev->drv->phy_id == PHY_ID_VSC8572 ||\n\t\t\t phydev->drv->phy_id == PHY_ID_VSC8601) ?\n\t\t\t\tMII_VSC8244_IMASK_MASK :\n\t\t\t\tMII_VSC8221_IMASK_MASK);\n\telse {\n\t\t \n\t\terr = phy_read(phydev, MII_VSC8244_ISTAT);\n\n\t\tif (err < 0)\n\t\t\treturn err;\n\n\t\terr = phy_write(phydev, MII_VSC8244_IMASK, 0);\n\t}\n\n\treturn err;\n}\n\nstatic irqreturn_t vsc82xx_handle_interrupt(struct phy_device *phydev)\n{\n\tint irq_status, irq_mask;\n\n\tif (phydev->drv->phy_id == PHY_ID_VSC8244 ||\n\t    phydev->drv->phy_id == PHY_ID_VSC8572 ||\n\t    phydev->drv->phy_id == PHY_ID_VSC8601)\n\t\tirq_mask = MII_VSC8244_ISTAT_MASK;\n\telse\n\t\tirq_mask = MII_VSC8221_ISTAT_MASK;\n\n\tirq_status = phy_read(phydev, MII_VSC8244_ISTAT);\n\tif (irq_status < 0) {\n\t\tphy_error(phydev);\n\t\treturn IRQ_NONE;\n\t}\n\n\tif (!(irq_status & irq_mask))\n\t\treturn IRQ_NONE;\n\n\tphy_trigger_machine(phydev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int vsc8221_config_init(struct phy_device *phydev)\n{\n\tint err;\n\n\terr = phy_write(phydev, MII_VSC8244_AUX_CONSTAT,\n\t\t\tMII_VSC8221_AUXCONSTAT_INIT);\n\treturn err;\n\n\t \n}\n\n \nstatic int vsc82x4_config_autocross_enable(struct phy_device *phydev)\n{\n\tint ret;\n\n\tif (phydev->autoneg == AUTONEG_ENABLE || phydev->speed > SPEED_100)\n\t\treturn 0;\n\n\t \n\tret = phy_write(phydev, MII_VSC82X4_EXT_PAGE_ACCESS, 0x52b5);\n\tif (ret >= 0)\n\t\tret = phy_write(phydev, MII_VSC82X4_EXT_PAGE_18E, 0x0012);\n\tif (ret >= 0)\n\t\tret = phy_write(phydev, MII_VSC82X4_EXT_PAGE_17E, 0x2803);\n\tif (ret >= 0)\n\t\tret = phy_write(phydev, MII_VSC82X4_EXT_PAGE_16E, 0x87fa);\n\t \n\tif (ret >= 0)\n\t\tret = phy_write(phydev, MII_VSC82X4_EXT_PAGE_ACCESS, 0x0000);\n\telse\n\t\tphy_write(phydev, MII_VSC82X4_EXT_PAGE_ACCESS, 0x0000);\n\n\treturn ret;\n}\n\n \nstatic int vsc82x4_config_aneg(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tif (phydev->autoneg != AUTONEG_ENABLE && phydev->speed <= SPEED_100) {\n\t\tret = genphy_setup_forced(phydev);\n\n\t\tif (ret < 0)  \n\t\t\treturn ret;\n\n\t\treturn vsc82x4_config_autocross_enable(phydev);\n\t}\n\n\treturn genphy_config_aneg(phydev);\n}\n\n \nstatic struct phy_driver vsc82xx_driver[] = {\n{\n\t.phy_id         = PHY_ID_VSC8234,\n\t.name           = \"Vitesse VSC8234\",\n\t.phy_id_mask    = 0x000ffff0,\n\t \n\t.config_init    = &vsc824x_config_init,\n\t.config_aneg    = &vsc82x4_config_aneg,\n\t.config_intr    = &vsc82xx_config_intr,\n\t.handle_interrupt = &vsc82xx_handle_interrupt,\n}, {\n\t.phy_id\t\t= PHY_ID_VSC8244,\n\t.name\t\t= \"Vitesse VSC8244\",\n\t.phy_id_mask\t= 0x000fffc0,\n\t \n\t.config_init\t= &vsc824x_config_init,\n\t.config_aneg\t= &vsc82x4_config_aneg,\n\t.config_intr\t= &vsc82xx_config_intr,\n\t.handle_interrupt = &vsc82xx_handle_interrupt,\n}, {\n\t.phy_id         = PHY_ID_VSC8572,\n\t.name           = \"Vitesse VSC8572\",\n\t.phy_id_mask    = 0x000ffff0,\n\t \n\t.config_init    = &vsc824x_config_init,\n\t.config_aneg    = &vsc82x4_config_aneg,\n\t.config_intr    = &vsc82xx_config_intr,\n\t.handle_interrupt = &vsc82xx_handle_interrupt,\n}, {\n\t.phy_id         = PHY_ID_VSC8601,\n\t.name           = \"Vitesse VSC8601\",\n\t.phy_id_mask    = 0x000ffff0,\n\t \n\t.config_init    = &vsc8601_config_init,\n\t.config_intr    = &vsc82xx_config_intr,\n\t.handle_interrupt = &vsc82xx_handle_interrupt,\n}, {\n\t.phy_id         = PHY_ID_VSC7385,\n\t.name           = \"Vitesse VSC7385\",\n\t.phy_id_mask    = 0x000ffff0,\n\t \n\t.config_init    = vsc738x_config_init,\n\t.config_aneg    = vsc73xx_config_aneg,\n\t.read_page      = vsc73xx_read_page,\n\t.write_page     = vsc73xx_write_page,\n}, {\n\t.phy_id         = PHY_ID_VSC7388,\n\t.name           = \"Vitesse VSC7388\",\n\t.phy_id_mask    = 0x000ffff0,\n\t \n\t.config_init    = vsc738x_config_init,\n\t.config_aneg    = vsc73xx_config_aneg,\n\t.read_page      = vsc73xx_read_page,\n\t.write_page     = vsc73xx_write_page,\n}, {\n\t.phy_id         = PHY_ID_VSC7395,\n\t.name           = \"Vitesse VSC7395\",\n\t.phy_id_mask    = 0x000ffff0,\n\t \n\t.config_init    = vsc739x_config_init,\n\t.config_aneg    = vsc73xx_config_aneg,\n\t.read_page      = vsc73xx_read_page,\n\t.write_page     = vsc73xx_write_page,\n}, {\n\t.phy_id         = PHY_ID_VSC7398,\n\t.name           = \"Vitesse VSC7398\",\n\t.phy_id_mask    = 0x000ffff0,\n\t \n\t.config_init    = vsc739x_config_init,\n\t.config_aneg    = vsc73xx_config_aneg,\n\t.read_page      = vsc73xx_read_page,\n\t.write_page     = vsc73xx_write_page,\n}, {\n\t.phy_id         = PHY_ID_VSC8662,\n\t.name           = \"Vitesse VSC8662\",\n\t.phy_id_mask    = 0x000ffff0,\n\t \n\t.config_init    = &vsc824x_config_init,\n\t.config_aneg    = &vsc82x4_config_aneg,\n\t.config_intr    = &vsc82xx_config_intr,\n\t.handle_interrupt = &vsc82xx_handle_interrupt,\n}, {\n\t \n\t.phy_id\t\t= PHY_ID_VSC8221,\n\t.phy_id_mask\t= 0x000ffff0,\n\t.name\t\t= \"Vitesse VSC8221\",\n\t \n\t.config_init\t= &vsc8221_config_init,\n\t.config_intr\t= &vsc82xx_config_intr,\n\t.handle_interrupt = &vsc82xx_handle_interrupt,\n}, {\n\t \n\t.phy_id\t\t= PHY_ID_VSC8211,\n\t.phy_id_mask\t= 0x000ffff0,\n\t.name\t\t= \"Vitesse VSC8211\",\n\t \n\t.config_init\t= &vsc8221_config_init,\n\t.config_intr\t= &vsc82xx_config_intr,\n\t.handle_interrupt = &vsc82xx_handle_interrupt,\n} };\n\nmodule_phy_driver(vsc82xx_driver);\n\nstatic struct mdio_device_id __maybe_unused vitesse_tbl[] = {\n\t{ PHY_ID_VSC8234, 0x000ffff0 },\n\t{ PHY_ID_VSC8244, 0x000fffc0 },\n\t{ PHY_ID_VSC8572, 0x000ffff0 },\n\t{ PHY_ID_VSC7385, 0x000ffff0 },\n\t{ PHY_ID_VSC7388, 0x000ffff0 },\n\t{ PHY_ID_VSC7395, 0x000ffff0 },\n\t{ PHY_ID_VSC7398, 0x000ffff0 },\n\t{ PHY_ID_VSC8662, 0x000ffff0 },\n\t{ PHY_ID_VSC8221, 0x000ffff0 },\n\t{ PHY_ID_VSC8211, 0x000ffff0 },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(mdio, vitesse_tbl);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}