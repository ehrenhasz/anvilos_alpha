{
  "module_name": "dp83td510.c",
  "hash_id": "7788e101c1e6c6456f0fb9c92d2439c6542cf370e504f561000fb6df20bf71da",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/dp83td510.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/phy.h>\n\n#define DP83TD510E_PHY_ID\t\t\t0x20000181\n\n \n#define DP83TD510E_PHY_STS\t\t\t0x10\n \n#define DP83TD510E_STS_MII_INT\t\t\tBIT(7)\n#define DP83TD510E_LINK_STATUS\t\t\tBIT(0)\n\n#define DP83TD510E_GEN_CFG\t\t\t0x11\n#define DP83TD510E_GENCFG_INT_POLARITY\t\tBIT(3)\n#define DP83TD510E_GENCFG_INT_EN\t\tBIT(1)\n#define DP83TD510E_GENCFG_INT_OE\t\tBIT(0)\n\n#define DP83TD510E_INTERRUPT_REG_1\t\t0x12\n#define DP83TD510E_INT1_LINK\t\t\tBIT(13)\n#define DP83TD510E_INT1_LINK_EN\t\t\tBIT(5)\n\n#define DP83TD510E_AN_STAT_1\t\t\t0x60c\n#define DP83TD510E_MASTER_SLAVE_RESOL_FAIL\tBIT(15)\n\n#define DP83TD510E_MSE_DETECT\t\t\t0xa85\n\n#define DP83TD510_SQI_MAX\t7\n\n \nstatic const u16 dp83td510_mse_sqi_map[] = {\n\t0x0569,  \n\t0x044c,  \n\t0x0369,  \n\t0x02b6,  \n\t0x0227,  \n\t0x01b6,  \n\t0x015b,  \n\t0x0000   \n};\n\nstatic int dp83td510_config_intr(struct phy_device *phydev)\n{\n\tint ret;\n\n\tif (phydev->interrupts == PHY_INTERRUPT_ENABLED) {\n\t\tret = phy_write_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t    DP83TD510E_INTERRUPT_REG_1,\n\t\t\t\t    DP83TD510E_INT1_LINK_EN);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = phy_set_bits_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t       DP83TD510E_GEN_CFG,\n\t\t\t\t       DP83TD510E_GENCFG_INT_POLARITY |\n\t\t\t\t       DP83TD510E_GENCFG_INT_EN |\n\t\t\t\t       DP83TD510E_GENCFG_INT_OE);\n\t} else {\n\t\tret = phy_write_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t    DP83TD510E_INTERRUPT_REG_1, 0x0);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = phy_clear_bits_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t\t DP83TD510E_GEN_CFG,\n\t\t\t\t\t DP83TD510E_GENCFG_INT_EN);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic irqreturn_t dp83td510_handle_interrupt(struct phy_device *phydev)\n{\n\tint  ret;\n\n\t \n\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2, DP83TD510E_INTERRUPT_REG_1);\n\tif (ret < 0) {\n\t\tphy_error(phydev);\n\t\treturn IRQ_NONE;\n\t} else if (!(ret & DP83TD510E_INT1_LINK_EN) ||\n\t\t   !(ret & DP83TD510E_INT1_LINK)) {\n\t\treturn IRQ_NONE;\n\t}\n\n\tphy_trigger_machine(phydev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int dp83td510_read_status(struct phy_device *phydev)\n{\n\tu16 phy_sts;\n\tint ret;\n\n\tphydev->speed = SPEED_UNKNOWN;\n\tphydev->duplex = DUPLEX_UNKNOWN;\n\tphydev->pause = 0;\n\tphydev->asym_pause = 0;\n\tlinkmode_zero(phydev->lp_advertising);\n\n\tphy_sts = phy_read(phydev, DP83TD510E_PHY_STS);\n\n\tphydev->link = !!(phy_sts & DP83TD510E_LINK_STATUS);\n\tif (phydev->link) {\n\t\t \n\t\tphydev->duplex = DUPLEX_FULL;\n\t\tphydev->speed = SPEED_10;\n\n\t\tif (phydev->autoneg == AUTONEG_ENABLE) {\n\t\t\tret = genphy_c45_read_lpa(phydev);\n\t\t\tif (ret)\n\t\t\t\treturn ret;\n\n\t\t\tphy_resolve_aneg_linkmode(phydev);\n\t\t}\n\t}\n\n\tif (phydev->autoneg == AUTONEG_ENABLE) {\n\t\tret = genphy_c45_baset1_read_status(phydev);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t   DP83TD510E_AN_STAT_1);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tif (ret & DP83TD510E_MASTER_SLAVE_RESOL_FAIL)\n\t\t\tphydev->master_slave_state = MASTER_SLAVE_STATE_ERR;\n\t} else {\n\t\treturn genphy_c45_pma_baset1_read_master_slave(phydev);\n\t}\n\n\treturn 0;\n}\n\nstatic int dp83td510_config_aneg(struct phy_device *phydev)\n{\n\tbool changed = false;\n\tint ret;\n\n\tret = genphy_c45_pma_baset1_setup_master_slave(phydev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (phydev->autoneg == AUTONEG_DISABLE)\n\t\treturn genphy_c45_an_disable_aneg(phydev);\n\n\tret = genphy_c45_an_config_aneg(phydev);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret > 0)\n\t\tchanged = true;\n\n\treturn genphy_c45_check_and_restart_aneg(phydev, changed);\n}\n\nstatic int dp83td510_get_sqi(struct phy_device *phydev)\n{\n\tint sqi, ret;\n\tu16 mse_val;\n\n\tif (!phydev->link)\n\t\treturn 0;\n\n\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2, DP83TD510E_MSE_DETECT);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tmse_val = 0xFFFF & ret;\n\tfor (sqi = 0; sqi < ARRAY_SIZE(dp83td510_mse_sqi_map); sqi++) {\n\t\tif (mse_val >= dp83td510_mse_sqi_map[sqi])\n\t\t\treturn sqi;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int dp83td510_get_sqi_max(struct phy_device *phydev)\n{\n\treturn DP83TD510_SQI_MAX;\n}\n\nstatic int dp83td510_get_features(struct phy_device *phydev)\n{\n\t \n\n\tlinkmode_set_bit(ETHTOOL_LINK_MODE_Autoneg_BIT, phydev->supported);\n\tlinkmode_set_bit(ETHTOOL_LINK_MODE_Asym_Pause_BIT, phydev->supported);\n\tlinkmode_set_bit(ETHTOOL_LINK_MODE_Pause_BIT, phydev->supported);\n\tlinkmode_set_bit(ETHTOOL_LINK_MODE_10baseT1L_Full_BIT,\n\t\t\t phydev->supported);\n\n\treturn 0;\n}\n\nstatic struct phy_driver dp83td510_driver[] = {\n{\n\tPHY_ID_MATCH_MODEL(DP83TD510E_PHY_ID),\n\t.name\t\t= \"TI DP83TD510E\",\n\n\t.config_aneg\t= dp83td510_config_aneg,\n\t.read_status\t= dp83td510_read_status,\n\t.get_features\t= dp83td510_get_features,\n\t.config_intr\t= dp83td510_config_intr,\n\t.handle_interrupt = dp83td510_handle_interrupt,\n\t.get_sqi\t= dp83td510_get_sqi,\n\t.get_sqi_max\t= dp83td510_get_sqi_max,\n\n\t.suspend\t= genphy_suspend,\n\t.resume\t\t= genphy_resume,\n} };\nmodule_phy_driver(dp83td510_driver);\n\nstatic struct mdio_device_id __maybe_unused dp83td510_tbl[] = {\n\t{ PHY_ID_MATCH_MODEL(DP83TD510E_PHY_ID) },\n\t{ }\n};\nMODULE_DEVICE_TABLE(mdio, dp83td510_tbl);\n\nMODULE_DESCRIPTION(\"Texas Instruments DP83TD510E PHY driver\");\nMODULE_AUTHOR(\"Oleksij Rempel <kernel@pengutronix.de>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}