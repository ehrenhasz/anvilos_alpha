{
  "module_name": "microchip_t1s.c",
  "hash_id": "98e93d403a19574e712ee262b8944df5480557323f40ad1ec4141fa449cc1b15",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/microchip_t1s.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/phy.h>\n\n#define PHY_ID_LAN867X_REVB1 0x0007C162\n#define PHY_ID_LAN865X_REVB0 0x0007C1B3\n\n#define LAN867X_REG_STS2 0x0019\n\n#define LAN867x_RESET_COMPLETE_STS BIT(11)\n\n#define LAN865X_REG_CFGPARAM_ADDR 0x00D8\n#define LAN865X_REG_CFGPARAM_DATA 0x00D9\n#define LAN865X_REG_CFGPARAM_CTRL 0x00DA\n#define LAN865X_REG_STS2 0x0019\n\n#define LAN865X_CFGPARAM_READ_ENABLE BIT(1)\n\n \n\nstatic const u32 lan867x_revb1_fixup_registers[12] = {\n\t0x00D0, 0x00D1, 0x0084, 0x0085,\n\t0x008A, 0x0087, 0x0088, 0x008B,\n\t0x0080, 0x00F1, 0x0096, 0x0099,\n};\n\nstatic const u16 lan867x_revb1_fixup_values[12] = {\n\t0x0002, 0x0000, 0x3380, 0x0006,\n\t0xC000, 0x801C, 0x033F, 0x0404,\n\t0x0600, 0x2400, 0x2000, 0x7F80,\n};\n\nstatic const u16 lan867x_revb1_fixup_masks[12] = {\n\t0x0E03, 0x0300, 0xFFC0, 0x000F,\n\t0xF800, 0x801C, 0x1FFF, 0xFFFF,\n\t0x0600, 0x7F00, 0x2000, 0xFFFF,\n};\n\n \nstatic const u32 lan865x_revb0_fixup_registers[28] = {\n\t0x0091, 0x0081, 0x0043, 0x0044,\n\t0x0045, 0x0053, 0x0054, 0x0055,\n\t0x0040, 0x0050, 0x00D0, 0x00E9,\n\t0x00F5, 0x00F4, 0x00F8, 0x00F9,\n\t0x00B0, 0x00B1, 0x00B2, 0x00B3,\n\t0x00B4, 0x00B5, 0x00B6, 0x00B7,\n\t0x00B8, 0x00B9, 0x00BA, 0x00BB,\n};\n\nstatic const u16 lan865x_revb0_fixup_values[28] = {\n\t0x9660, 0x00C0, 0x00FF, 0xFFFF,\n\t0x0000, 0x00FF, 0xFFFF, 0x0000,\n\t0x0002, 0x0002, 0x5F21, 0x9E50,\n\t0x1CF8, 0xC020, 0x9B00, 0x4E53,\n\t0x0103, 0x0910, 0x1D26, 0x002A,\n\t0x0103, 0x070D, 0x1720, 0x0027,\n\t0x0509, 0x0E13, 0x1C25, 0x002B,\n};\n\nstatic const u16 lan865x_revb0_fixup_cfg_regs[5] = {\n\t0x0084, 0x008A, 0x00AD, 0x00AE, 0x00AF\n};\n\n \nstatic int lan865x_revb0_indirect_read(struct phy_device *phydev, u16 addr)\n{\n\tint ret;\n\n\tret = phy_write_mmd(phydev, MDIO_MMD_VEND2, LAN865X_REG_CFGPARAM_ADDR,\n\t\t\t    addr);\n\tif (ret)\n\t\treturn ret;\n\n\tret = phy_write_mmd(phydev, MDIO_MMD_VEND2, LAN865X_REG_CFGPARAM_CTRL,\n\t\t\t    LAN865X_CFGPARAM_READ_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\treturn phy_read_mmd(phydev, MDIO_MMD_VEND2, LAN865X_REG_CFGPARAM_DATA);\n}\n\n \nstatic int lan865x_generate_cfg_offsets(struct phy_device *phydev, s8 offsets[2])\n{\n\tconst u16 fixup_regs[2] = {0x0004, 0x0008};\n\tint ret;\n\n\tfor (int i = 0; i < ARRAY_SIZE(fixup_regs); i++) {\n\t\tret = lan865x_revb0_indirect_read(phydev, fixup_regs[i]);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tif (ret & BIT(4))\n\t\t\toffsets[i] = ret | 0xE0;\n\t\telse\n\t\t\toffsets[i] = ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int lan865x_read_cfg_params(struct phy_device *phydev, u16 cfg_params[])\n{\n\tint ret;\n\n\tfor (int i = 0; i < ARRAY_SIZE(lan865x_revb0_fixup_cfg_regs); i++) {\n\t\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t   lan865x_revb0_fixup_cfg_regs[i]);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tcfg_params[i] = (u16)ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int lan865x_write_cfg_params(struct phy_device *phydev, u16 cfg_params[])\n{\n\tint ret;\n\n\tfor (int i = 0; i < ARRAY_SIZE(lan865x_revb0_fixup_cfg_regs); i++) {\n\t\tret = phy_write_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t    lan865x_revb0_fixup_cfg_regs[i],\n\t\t\t\t    cfg_params[i]);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int lan865x_setup_cfgparam(struct phy_device *phydev)\n{\n\tu16 cfg_params[ARRAY_SIZE(lan865x_revb0_fixup_cfg_regs)];\n\tu16 cfg_results[5];\n\ts8 offsets[2];\n\tint ret;\n\n\tret = lan865x_generate_cfg_offsets(phydev, offsets);\n\tif (ret)\n\t\treturn ret;\n\n\tret = lan865x_read_cfg_params(phydev, cfg_params);\n\tif (ret)\n\t\treturn ret;\n\n\tcfg_results[0] = (cfg_params[0] & 0x000F) |\n\t\t\t  FIELD_PREP(GENMASK(15, 10), 9 + offsets[0]) |\n\t\t\t  FIELD_PREP(GENMASK(15, 4), 14 + offsets[0]);\n\tcfg_results[1] = (cfg_params[1] & 0x03FF) |\n\t\t\t  FIELD_PREP(GENMASK(15, 10), 40 + offsets[1]);\n\tcfg_results[2] = (cfg_params[2] & 0xC0C0) |\n\t\t\t  FIELD_PREP(GENMASK(15, 8), 5 + offsets[0]) |\n\t\t\t  (9 + offsets[0]);\n\tcfg_results[3] = (cfg_params[3] & 0xC0C0) |\n\t\t\t  FIELD_PREP(GENMASK(15, 8), 9 + offsets[0]) |\n\t\t\t  (14 + offsets[0]);\n\tcfg_results[4] = (cfg_params[4] & 0xC0C0) |\n\t\t\t  FIELD_PREP(GENMASK(15, 8), 17 + offsets[0]) |\n\t\t\t  (22 + offsets[0]);\n\n\treturn lan865x_write_cfg_params(phydev, cfg_results);\n}\n\nstatic int lan865x_revb0_config_init(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tfor (int i = 0; i < ARRAY_SIZE(lan865x_revb0_fixup_registers); i++) {\n\t\tret = phy_write_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t    lan865x_revb0_fixup_registers[i],\n\t\t\t\t    lan865x_revb0_fixup_values[i]);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\t \n\treturn lan865x_setup_cfgparam(phydev);\n}\n\nstatic int lan867x_revb1_config_init(struct phy_device *phydev)\n{\n\tint err;\n\n\t \n\terr = phy_read_mmd(phydev, MDIO_MMD_VEND2, LAN867X_REG_STS2);\n\tif (err < 0)\n\t\treturn err;\n\n\tif (!(err & LAN867x_RESET_COMPLETE_STS)) {\n\t\tudelay(5);\n\t\terr = phy_read_mmd(phydev, MDIO_MMD_VEND2, LAN867X_REG_STS2);\n\t\tif (err < 0)\n\t\t\treturn err;\n\t\tif (!(err & LAN867x_RESET_COMPLETE_STS)) {\n\t\t\tphydev_err(phydev, \"PHY reset failed\\n\");\n\t\t\treturn -ENODEV;\n\t\t}\n\t}\n\n\t \n\tfor (int i = 0; i < ARRAY_SIZE(lan867x_revb1_fixup_registers); i++) {\n\t\terr = phy_modify_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t     lan867x_revb1_fixup_registers[i],\n\t\t\t\t     lan867x_revb1_fixup_masks[i],\n\t\t\t\t     lan867x_revb1_fixup_values[i]);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int lan86xx_read_status(struct phy_device *phydev)\n{\n\t \n\tphydev->link = 1;\n\tphydev->duplex = DUPLEX_HALF;\n\tphydev->speed = SPEED_10;\n\tphydev->autoneg = AUTONEG_DISABLE;\n\n\treturn 0;\n}\n\nstatic struct phy_driver microchip_t1s_driver[] = {\n\t{\n\t\tPHY_ID_MATCH_EXACT(PHY_ID_LAN867X_REVB1),\n\t\t.name               = \"LAN867X Rev.B1\",\n\t\t.features           = PHY_BASIC_T1S_P2MP_FEATURES,\n\t\t.config_init        = lan867x_revb1_config_init,\n\t\t.read_status        = lan86xx_read_status,\n\t\t.get_plca_cfg\t    = genphy_c45_plca_get_cfg,\n\t\t.set_plca_cfg\t    = genphy_c45_plca_set_cfg,\n\t\t.get_plca_status    = genphy_c45_plca_get_status,\n\t},\n\t{\n\t\tPHY_ID_MATCH_EXACT(PHY_ID_LAN865X_REVB0),\n\t\t.name               = \"LAN865X Rev.B0 Internal Phy\",\n\t\t.features           = PHY_BASIC_T1S_P2MP_FEATURES,\n\t\t.config_init        = lan865x_revb0_config_init,\n\t\t.read_status        = lan86xx_read_status,\n\t\t.get_plca_cfg\t    = genphy_c45_plca_get_cfg,\n\t\t.set_plca_cfg\t    = genphy_c45_plca_set_cfg,\n\t\t.get_plca_status    = genphy_c45_plca_get_status,\n\t},\n};\n\nmodule_phy_driver(microchip_t1s_driver);\n\nstatic struct mdio_device_id __maybe_unused tbl[] = {\n\t{ PHY_ID_MATCH_EXACT(PHY_ID_LAN867X_REVB1) },\n\t{ PHY_ID_MATCH_EXACT(PHY_ID_LAN865X_REVB0) },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(mdio, tbl);\n\nMODULE_DESCRIPTION(\"Microchip 10BASE-T1S PHYs driver\");\nMODULE_AUTHOR(\"Ram\u00f3n Nordin Rodriguez\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}