{
  "module_name": "microchip_t1.c",
  "hash_id": "5bf76f19aa8b181380bd43e8243a6e35bcc2de3b5f880576f2ff9e6425d5fdf0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/microchip_t1.c",
  "human_readable_source": "\n\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/mii.h>\n#include <linux/phy.h>\n#include <linux/ethtool.h>\n#include <linux/ethtool_netlink.h>\n#include <linux/bitfield.h>\n\n#define PHY_ID_LAN87XX\t\t\t\t0x0007c150\n#define PHY_ID_LAN937X\t\t\t\t0x0007c180\n\n \n#define LAN87XX_EXT_REG_CTL                     (0x14)\n#define LAN87XX_EXT_REG_CTL_RD_CTL              (0x1000)\n#define LAN87XX_EXT_REG_CTL_WR_CTL              (0x0800)\n#define LAN87XX_REG_BANK_SEL_MASK\t\tGENMASK(10, 8)\n#define LAN87XX_REG_ADDR_MASK\t\t\tGENMASK(7, 0)\n\n \n#define LAN87XX_EXT_REG_RD_DATA                 (0x15)\n\n \n#define LAN87XX_EXT_REG_WR_DATA                 (0x16)\n\n \n#define LAN87XX_INTERRUPT_SOURCE                (0x18)\n#define LAN87XX_INTERRUPT_SOURCE_2              (0x08)\n\n \n#define LAN87XX_INTERRUPT_MASK                  (0x19)\n#define LAN87XX_MASK_LINK_UP                    (0x0004)\n#define LAN87XX_MASK_LINK_DOWN                  (0x0002)\n\n#define LAN87XX_INTERRUPT_MASK_2                (0x09)\n#define LAN87XX_MASK_COMM_RDY\t\t\tBIT(10)\n\n \n#define LAN87XX_CTRL_1                          (0x11)\n#define LAN87XX_MASK_RGMII_TXC_DLY_EN           (0x4000)\n#define LAN87XX_MASK_RGMII_RXC_DLY_EN           (0x2000)\n\n \n#define\tPHYACC_ATTR_MODE_READ\t\t0\n#define\tPHYACC_ATTR_MODE_WRITE\t\t1\n#define\tPHYACC_ATTR_MODE_MODIFY\t\t2\n#define\tPHYACC_ATTR_MODE_POLL\t\t3\n\n#define\tPHYACC_ATTR_BANK_SMI\t\t0\n#define\tPHYACC_ATTR_BANK_MISC\t\t1\n#define\tPHYACC_ATTR_BANK_PCS\t\t2\n#define\tPHYACC_ATTR_BANK_AFE\t\t3\n#define\tPHYACC_ATTR_BANK_DSP\t\t4\n#define\tPHYACC_ATTR_BANK_MAX\t\t7\n\n \n#define\tLAN87XX_CABLE_TEST_OK\t\t0\n#define\tLAN87XX_CABLE_TEST_OPEN\t1\n#define\tLAN87XX_CABLE_TEST_SAME_SHORT\t2\n\n \n#define T1_AFE_PORT_CFG1_REG\t\t0x0B\n#define T1_POWER_DOWN_CONTROL_REG\t0x1A\n#define T1_SLV_FD_MULT_CFG_REG\t\t0x18\n#define T1_CDR_CFG_PRE_LOCK_REG\t\t0x05\n#define T1_CDR_CFG_POST_LOCK_REG\t0x06\n#define T1_LCK_STG2_MUFACT_CFG_REG\t0x1A\n#define T1_LCK_STG3_MUFACT_CFG_REG\t0x1B\n#define T1_POST_LCK_MUFACT_CFG_REG\t0x1C\n#define T1_TX_RX_FIFO_CFG_REG\t\t0x02\n#define T1_TX_LPF_FIR_CFG_REG\t\t0x55\n#define T1_COEF_CLK_PWR_DN_CFG\t\t0x04\n#define T1_COEF_RW_CTL_CFG\t\t0x0D\n#define T1_SQI_CONFIG_REG\t\t0x2E\n#define T1_SQI_CONFIG2_REG\t\t0x4A\n#define T1_DCQ_SQI_REG\t\t\t0xC3\n#define T1_DCQ_SQI_MSK\t\t\tGENMASK(3, 1)\n#define T1_MDIO_CONTROL2_REG\t\t0x10\n#define T1_INTERRUPT_SOURCE_REG\t\t0x18\n#define T1_INTERRUPT2_SOURCE_REG\t0x08\n#define T1_EQ_FD_STG1_FRZ_CFG\t\t0x69\n#define T1_EQ_FD_STG2_FRZ_CFG\t\t0x6A\n#define T1_EQ_FD_STG3_FRZ_CFG\t\t0x6B\n#define T1_EQ_FD_STG4_FRZ_CFG\t\t0x6C\n#define T1_EQ_WT_FD_LCK_FRZ_CFG\t\t0x6D\n#define T1_PST_EQ_LCK_STG1_FRZ_CFG\t0x6E\n\n#define T1_MODE_STAT_REG\t\t0x11\n#define T1_LINK_UP_MSK\t\t\tBIT(0)\n\n \n#define LAN87XX_MAX_SQI\t\t\t0x07\n\n#define DRIVER_AUTHOR\t\"Nisar Sayed <nisar.sayed@microchip.com>\"\n#define DRIVER_DESC\t\"Microchip LAN87XX/LAN937x T1 PHY driver\"\n\nstruct access_ereg_val {\n\tu8  mode;\n\tu8  bank;\n\tu8  offset;\n\tu16 val;\n\tu16 mask;\n};\n\nstatic int lan937x_dsp_workaround(struct phy_device *phydev, u16 ereg, u8 bank)\n{\n\tu8 prev_bank;\n\tint rc = 0;\n\tu16 val;\n\n\tmutex_lock(&phydev->lock);\n\t \n\trc = phy_read(phydev, LAN87XX_EXT_REG_CTL);\n\tif (rc < 0)\n\t\tgoto out_unlock;\n\n\t \n\tprev_bank = FIELD_GET(LAN87XX_REG_BANK_SEL_MASK, rc);\n\n\tif (bank != prev_bank && bank == PHYACC_ATTR_BANK_DSP) {\n\t\tval = ereg & ~LAN87XX_REG_ADDR_MASK;\n\n\t\tval &= ~LAN87XX_EXT_REG_CTL_WR_CTL;\n\t\tval |= LAN87XX_EXT_REG_CTL_RD_CTL;\n\n\t\t \n\t\trc = phy_write(phydev, LAN87XX_EXT_REG_CTL, val);\n\t}\n\nout_unlock:\n\tmutex_unlock(&phydev->lock);\n\n\treturn rc;\n}\n\nstatic int access_ereg(struct phy_device *phydev, u8 mode, u8 bank,\n\t\t       u8 offset, u16 val)\n{\n\tu16 ereg = 0;\n\tint rc = 0;\n\n\tif (mode > PHYACC_ATTR_MODE_WRITE || bank > PHYACC_ATTR_BANK_MAX)\n\t\treturn -EINVAL;\n\n\tif (bank == PHYACC_ATTR_BANK_SMI) {\n\t\tif (mode == PHYACC_ATTR_MODE_WRITE)\n\t\t\trc = phy_write(phydev, offset, val);\n\t\telse\n\t\t\trc = phy_read(phydev, offset);\n\t\treturn rc;\n\t}\n\n\tif (mode == PHYACC_ATTR_MODE_WRITE) {\n\t\tereg = LAN87XX_EXT_REG_CTL_WR_CTL;\n\t\trc = phy_write(phydev, LAN87XX_EXT_REG_WR_DATA, val);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t} else {\n\t\tereg = LAN87XX_EXT_REG_CTL_RD_CTL;\n\t}\n\n\tereg |= (bank << 8) | offset;\n\n\t \n\tif (phydev->phy_id == PHY_ID_LAN937X) {\n\t\trc = lan937x_dsp_workaround(phydev, ereg, bank);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t}\n\n\trc = phy_write(phydev, LAN87XX_EXT_REG_CTL, ereg);\n\tif (rc < 0)\n\t\treturn rc;\n\n\tif (mode == PHYACC_ATTR_MODE_READ)\n\t\trc = phy_read(phydev, LAN87XX_EXT_REG_RD_DATA);\n\n\treturn rc;\n}\n\nstatic int access_ereg_modify_changed(struct phy_device *phydev,\n\t\t\t\t      u8 bank, u8 offset, u16 val, u16 mask)\n{\n\tint new = 0, rc = 0;\n\n\tif (bank > PHYACC_ATTR_BANK_MAX)\n\t\treturn -EINVAL;\n\n\trc = access_ereg(phydev, PHYACC_ATTR_MODE_READ, bank, offset, val);\n\tif (rc < 0)\n\t\treturn rc;\n\n\tnew = val | (rc & (mask ^ 0xFFFF));\n\trc = access_ereg(phydev, PHYACC_ATTR_MODE_WRITE, bank, offset, new);\n\n\treturn rc;\n}\n\nstatic int access_smi_poll_timeout(struct phy_device *phydev,\n\t\t\t\t   u8 offset, u16 mask, u16 clr)\n{\n\tint val;\n\n\treturn phy_read_poll_timeout(phydev, offset, val, (val & mask) == clr,\n\t\t\t\t     150, 30000, true);\n}\n\nstatic int lan87xx_config_rgmii_delay(struct phy_device *phydev)\n{\n\tint rc;\n\n\tif (!phy_interface_is_rgmii(phydev))\n\t\treturn 0;\n\n\trc = access_ereg(phydev, PHYACC_ATTR_MODE_READ,\n\t\t\t PHYACC_ATTR_BANK_MISC, LAN87XX_CTRL_1, 0);\n\tif (rc < 0)\n\t\treturn rc;\n\n\tswitch (phydev->interface) {\n\tcase PHY_INTERFACE_MODE_RGMII:\n\t\trc &= ~LAN87XX_MASK_RGMII_TXC_DLY_EN;\n\t\trc &= ~LAN87XX_MASK_RGMII_RXC_DLY_EN;\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_RGMII_ID:\n\t\trc |= LAN87XX_MASK_RGMII_TXC_DLY_EN;\n\t\trc |= LAN87XX_MASK_RGMII_RXC_DLY_EN;\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_RGMII_RXID:\n\t\trc &= ~LAN87XX_MASK_RGMII_TXC_DLY_EN;\n\t\trc |= LAN87XX_MASK_RGMII_RXC_DLY_EN;\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_RGMII_TXID:\n\t\trc |= LAN87XX_MASK_RGMII_TXC_DLY_EN;\n\t\trc &= ~LAN87XX_MASK_RGMII_RXC_DLY_EN;\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\treturn access_ereg(phydev, PHYACC_ATTR_MODE_WRITE,\n\t\t\t   PHYACC_ATTR_BANK_MISC, LAN87XX_CTRL_1, rc);\n}\n\nstatic int lan87xx_phy_init_cmd(struct phy_device *phydev,\n\t\t\t\tconst struct access_ereg_val *cmd_seq, int cnt)\n{\n\tint ret, i;\n\n\tfor (i = 0; i < cnt; i++) {\n\t\tif (cmd_seq[i].mode == PHYACC_ATTR_MODE_POLL &&\n\t\t    cmd_seq[i].bank == PHYACC_ATTR_BANK_SMI) {\n\t\t\tret = access_smi_poll_timeout(phydev,\n\t\t\t\t\t\t      cmd_seq[i].offset,\n\t\t\t\t\t\t      cmd_seq[i].val,\n\t\t\t\t\t\t      cmd_seq[i].mask);\n\t\t} else {\n\t\t\tret = access_ereg(phydev, cmd_seq[i].mode,\n\t\t\t\t\t  cmd_seq[i].bank, cmd_seq[i].offset,\n\t\t\t\t\t  cmd_seq[i].val);\n\t\t}\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic int lan87xx_phy_init(struct phy_device *phydev)\n{\n\tstatic const struct access_ereg_val hw_init[] = {\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_AFE,\n\t\t  T1_AFE_PORT_CFG1_REG,       0x002D,  0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_SMI,\n\t\t  T1_POWER_DOWN_CONTROL_REG,  0x0308,  0 },\n\t};\n\n\tstatic const struct access_ereg_val slave_init[] = {\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_EQ_FD_STG1_FRZ_CFG,     0x0002,  0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_EQ_FD_STG2_FRZ_CFG,     0x0002,  0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_EQ_FD_STG3_FRZ_CFG,     0x0002,  0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_EQ_FD_STG4_FRZ_CFG,     0x0002,  0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_EQ_WT_FD_LCK_FRZ_CFG,    0x0002,  0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_PST_EQ_LCK_STG1_FRZ_CFG, 0x0002,  0 },\n\t};\n\n\tstatic const struct access_ereg_val phy_init[] = {\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_SLV_FD_MULT_CFG_REG,     0x0D53,  0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_CDR_CFG_PRE_LOCK_REG,    0x0AB2,  0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_CDR_CFG_POST_LOCK_REG,   0x0AB3,  0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_LCK_STG2_MUFACT_CFG_REG, 0x0AEA,  0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_LCK_STG3_MUFACT_CFG_REG, 0x0AEB,  0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_POST_LCK_MUFACT_CFG_REG, 0x0AEB,  0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_RX_FIFO_CFG_REG, 0x1C00, 0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1000, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1861, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1061, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1922, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1122, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1983, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1183, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1944, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1144, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x18c5, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x10c5, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1846, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1046, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1807, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1007, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1808, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1008, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1809, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1009, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x180A, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x100A, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x180B, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x100B, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x180C, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x100C, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x180D, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x100D, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x180E, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x100E, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x180F, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x100F, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1810, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1010, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1811, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1011, 0 },\n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_TX_LPF_FIR_CFG_REG, 0x1000, 0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_COEF_CLK_PWR_DN_CFG,\t0x16d6, 0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_SQI_CONFIG_REG,\t\t0x9572, 0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_SQI_CONFIG2_REG,\t\t0x0001, 0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_COEF_RW_CTL_CFG,\t\t0x0301,\t0 },\n\t\t{ PHYACC_ATTR_MODE_READ, PHYACC_ATTR_BANK_DSP,\n\t\t  T1_DCQ_SQI_REG,\t\t0,\t0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_SMI,\n\t\t  T1_MDIO_CONTROL2_REG,\t\t0x0014, 0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_SMI,\n\t\t  T1_POWER_DOWN_CONTROL_REG,\t0x0200, 0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_SMI,\n\t\t  T1_MDIO_CONTROL2_REG,\t\t0x0094, 0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_POLL, PHYACC_ATTR_BANK_SMI,\n\t\t  T1_MDIO_CONTROL2_REG,\t\t0x0080, 0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_AFE,\n\t\t  T1_AFE_PORT_CFG1_REG,\t\t0x000C, 0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_READ, PHYACC_ATTR_BANK_SMI,\n\t\t  T1_INTERRUPT_SOURCE_REG,\t0,\t0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_READ, PHYACC_ATTR_BANK_MISC,\n\t\t  T1_INTERRUPT2_SOURCE_REG,\t0,\t0 },\n\t\t \n\t\t{ PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_SMI,\n\t\t  T1_POWER_DOWN_CONTROL_REG,\t0x0300, 0 },\n\t};\n\tint rc;\n\n\t \n\trc = genphy_soft_reset(phydev);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = lan87xx_phy_init_cmd(phydev, hw_init, ARRAY_SIZE(hw_init));\n\tif (rc < 0)\n\t\treturn rc;\n\n\trc = genphy_read_master_slave(phydev);\n\tif (rc)\n\t\treturn rc;\n\n\t \n\tif (phydev->master_slave_state == MASTER_SLAVE_STATE_SLAVE) {\n\t\trc = lan87xx_phy_init_cmd(phydev, slave_init,\n\t\t\t\t\t  ARRAY_SIZE(slave_init));\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t}\n\n\trc = lan87xx_phy_init_cmd(phydev, phy_init, ARRAY_SIZE(phy_init));\n\tif (rc < 0)\n\t\treturn rc;\n\n\treturn lan87xx_config_rgmii_delay(phydev);\n}\n\nstatic int lan87xx_phy_config_intr(struct phy_device *phydev)\n{\n\tint rc, val = 0;\n\n\tif (phydev->interrupts == PHY_INTERRUPT_ENABLED) {\n\t\t \n\t\trc = phy_write(phydev, LAN87XX_INTERRUPT_MASK, val);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = phy_read(phydev, LAN87XX_INTERRUPT_SOURCE);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = access_ereg(phydev, PHYACC_ATTR_MODE_WRITE,\n\t\t\t\t PHYACC_ATTR_BANK_MISC,\n\t\t\t\t LAN87XX_INTERRUPT_MASK_2, val);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = access_ereg(phydev, PHYACC_ATTR_MODE_READ,\n\t\t\t\t PHYACC_ATTR_BANK_MISC,\n\t\t\t\t LAN87XX_INTERRUPT_SOURCE_2, 0);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\t \n\t\tval = LAN87XX_MASK_LINK_DOWN;\n\t\trc = phy_write(phydev, LAN87XX_INTERRUPT_MASK, val);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\tval = LAN87XX_MASK_COMM_RDY;\n\t\trc = access_ereg(phydev, PHYACC_ATTR_MODE_WRITE,\n\t\t\t\t PHYACC_ATTR_BANK_MISC,\n\t\t\t\t LAN87XX_INTERRUPT_MASK_2, val);\n\t} else {\n\t\trc = phy_write(phydev, LAN87XX_INTERRUPT_MASK, val);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = phy_read(phydev, LAN87XX_INTERRUPT_SOURCE);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = access_ereg(phydev, PHYACC_ATTR_MODE_WRITE,\n\t\t\t\t PHYACC_ATTR_BANK_MISC,\n\t\t\t\t LAN87XX_INTERRUPT_MASK_2, val);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = access_ereg(phydev, PHYACC_ATTR_MODE_READ,\n\t\t\t\t PHYACC_ATTR_BANK_MISC,\n\t\t\t\t LAN87XX_INTERRUPT_SOURCE_2, 0);\n\t}\n\n\treturn rc < 0 ? rc : 0;\n}\n\nstatic irqreturn_t lan87xx_handle_interrupt(struct phy_device *phydev)\n{\n\tint irq_status;\n\n\tirq_status  = access_ereg(phydev, PHYACC_ATTR_MODE_READ,\n\t\t\t\t  PHYACC_ATTR_BANK_MISC,\n\t\t\t\t  LAN87XX_INTERRUPT_SOURCE_2, 0);\n\tif (irq_status < 0) {\n\t\tphy_error(phydev);\n\t\treturn IRQ_NONE;\n\t}\n\n\tirq_status = phy_read(phydev, LAN87XX_INTERRUPT_SOURCE);\n\tif (irq_status < 0) {\n\t\tphy_error(phydev);\n\t\treturn IRQ_NONE;\n\t}\n\n\tif (irq_status == 0)\n\t\treturn IRQ_NONE;\n\n\tphy_trigger_machine(phydev);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int lan87xx_config_init(struct phy_device *phydev)\n{\n\tint rc = lan87xx_phy_init(phydev);\n\n\treturn rc < 0 ? rc : 0;\n}\n\nstatic int microchip_cable_test_start_common(struct phy_device *phydev)\n{\n\tint bmcr, bmsr, ret;\n\n\t \n\tbmcr = phy_read(phydev, MII_BMCR);\n\tif (bmcr < 0)\n\t\treturn bmcr;\n\n\tbmsr = phy_read(phydev, MII_BMSR);\n\n\tif (bmsr < 0)\n\t\treturn bmsr;\n\n\tif (bmcr & BMCR_ANENABLE) {\n\t\tret =  phy_modify(phydev, MII_BMCR, BMCR_ANENABLE, 0);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tret = genphy_soft_reset(phydev);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\t \n\tif (bmsr & BMSR_LSTATUS)\n\t\tmsleep(1500);\n\n\treturn 0;\n}\n\nstatic int lan87xx_cable_test_start(struct phy_device *phydev)\n{\n\tstatic const struct access_ereg_val cable_test[] = {\n\t\t \n\t\t{PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP, 93,\n\t\t 0, 0},\n\t\t \n\t\t{PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP, 94,\n\t\t 10, 0},\n\t\t \n\t\t{PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP, 95,\n\t\t 90, 0},\n\t\t \n\t\t{PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP, 92,\n\t\t 60, 0},\n\t\t \n\t\t{PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP, 79,\n\t\t 31, 0},\n\t\t \n\t\t{PHYACC_ATTR_MODE_MODIFY, PHYACC_ATTR_BANK_DSP, 55,\n\t\t 0, 0x0038},\n\t\t \n\t\t{PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP, 94,\n\t\t 70, 0},\n\t\t \n\t\t{PHYACC_ATTR_MODE_WRITE, PHYACC_ATTR_BANK_DSP, 90,\n\t\t 1, 0},\n\t};\n\tint rc, i;\n\n\trc = microchip_cable_test_start_common(phydev);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\t \n\trc = access_ereg(phydev, PHYACC_ATTR_MODE_READ, PHYACC_ATTR_BANK_SMI,\n\t\t\t 0x00, 0);\n\tif (rc < 0)\n\t\treturn rc;\n\n\t \n\trc = access_ereg(phydev, PHYACC_ATTR_MODE_READ, PHYACC_ATTR_BANK_SMI,\n\t\t\t 0x0A, 0);\n\tif (rc < 0)\n\t\treturn rc;\n\n\tif ((rc & 0x4000) != 0x4000) {\n\t\t \n\t\trc = access_ereg_modify_changed(phydev, PHYACC_ATTR_BANK_AFE,\n\t\t\t\t\t\t0x0E, 0x5, 0x7);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t\trc = access_ereg_modify_changed(phydev, PHYACC_ATTR_BANK_SMI,\n\t\t\t\t\t\t0x1A, 0x8, 0x8);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t} else {\n\t\t \n\t\trc = access_ereg_modify_changed(phydev, PHYACC_ATTR_BANK_SMI,\n\t\t\t\t\t\t0x10, 0x8, 0x40);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(cable_test); i++) {\n\t\tif (cable_test[i].mode == PHYACC_ATTR_MODE_MODIFY) {\n\t\t\trc = access_ereg_modify_changed(phydev,\n\t\t\t\t\t\t\tcable_test[i].bank,\n\t\t\t\t\t\t\tcable_test[i].offset,\n\t\t\t\t\t\t\tcable_test[i].val,\n\t\t\t\t\t\t\tcable_test[i].mask);\n\t\t\t \n\t\t\tmsleep(50);\n\t\t} else {\n\t\t\trc = access_ereg(phydev, cable_test[i].mode,\n\t\t\t\t\t cable_test[i].bank,\n\t\t\t\t\t cable_test[i].offset,\n\t\t\t\t\t cable_test[i].val);\n\t\t}\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t}\n\t \n\n\treturn 0;\n}\n\nstatic int lan87xx_cable_test_report_trans(u32 result)\n{\n\tswitch (result) {\n\tcase LAN87XX_CABLE_TEST_OK:\n\t\treturn ETHTOOL_A_CABLE_RESULT_CODE_OK;\n\tcase LAN87XX_CABLE_TEST_OPEN:\n\t\treturn ETHTOOL_A_CABLE_RESULT_CODE_OPEN;\n\tcase LAN87XX_CABLE_TEST_SAME_SHORT:\n\t\treturn ETHTOOL_A_CABLE_RESULT_CODE_SAME_SHORT;\n\tdefault:\n\t\t \n\t\treturn ETHTOOL_A_CABLE_RESULT_CODE_UNSPEC;\n\t}\n}\n\nstatic int lan87xx_cable_test_report(struct phy_device *phydev)\n{\n\tint pos_peak_cycle = 0, pos_peak_in_phases = 0, pos_peak_phase = 0;\n\tint neg_peak_cycle = 0, neg_peak_in_phases = 0, neg_peak_phase = 0;\n\tint noise_margin = 20, time_margin = 89, jitter_var = 30;\n\tint min_time_diff = 96, max_time_diff = 96 + time_margin;\n\tbool fault = false, check_a = false, check_b = false;\n\tint gain_idx = 0, pos_peak = 0, neg_peak = 0;\n\tint pos_peak_time = 0, neg_peak_time = 0;\n\tint pos_peak_in_phases_hybrid = 0;\n\tint detect = -1;\n\n\tgain_idx = access_ereg(phydev, PHYACC_ATTR_MODE_READ,\n\t\t\t       PHYACC_ATTR_BANK_DSP, 151, 0);\n\t \n\tpos_peak = access_ereg(phydev, PHYACC_ATTR_MODE_READ,\n\t\t\t       PHYACC_ATTR_BANK_DSP, 153, 0);\n\tneg_peak = access_ereg(phydev, PHYACC_ATTR_MODE_READ,\n\t\t\t       PHYACC_ATTR_BANK_DSP, 154, 0);\n\tpos_peak_time = access_ereg(phydev, PHYACC_ATTR_MODE_READ,\n\t\t\t\t    PHYACC_ATTR_BANK_DSP, 156, 0);\n\tneg_peak_time = access_ereg(phydev, PHYACC_ATTR_MODE_READ,\n\t\t\t\t    PHYACC_ATTR_BANK_DSP, 157, 0);\n\n\tpos_peak_cycle = (pos_peak_time >> 7) & 0x7F;\n\t \n\tpos_peak_phase = pos_peak_time & 0x7F;\n\tpos_peak_in_phases = (pos_peak_cycle * 96) + pos_peak_phase;\n\tneg_peak_cycle = (neg_peak_time >> 7) & 0x7F;\n\tneg_peak_phase = neg_peak_time & 0x7F;\n\tneg_peak_in_phases = (neg_peak_cycle * 96) + neg_peak_phase;\n\n\t \n\tcheck_a =\n\t\t((pos_peak_in_phases - neg_peak_in_phases) >= min_time_diff) &&\n\t\t((pos_peak_in_phases - neg_peak_in_phases) < max_time_diff) &&\n\t\tpos_peak_in_phases_hybrid < pos_peak_in_phases &&\n\t\t(pos_peak_in_phases_hybrid < (neg_peak_in_phases + jitter_var));\n\tcheck_b =\n\t\t((neg_peak_in_phases - pos_peak_in_phases) >= min_time_diff) &&\n\t\t((neg_peak_in_phases - pos_peak_in_phases) < max_time_diff) &&\n\t\tpos_peak_in_phases_hybrid < neg_peak_in_phases &&\n\t\t(pos_peak_in_phases_hybrid < (pos_peak_in_phases + jitter_var));\n\n\tif (pos_peak_in_phases > neg_peak_in_phases && check_a)\n\t\tdetect = 2;\n\telse if ((neg_peak_in_phases > pos_peak_in_phases) && check_b)\n\t\tdetect = 1;\n\n\tif (pos_peak > noise_margin && neg_peak > noise_margin &&\n\t    gain_idx >= 0) {\n\t\tif (detect == 1 || detect == 2)\n\t\t\tfault = true;\n\t}\n\n\tif (!fault)\n\t\tdetect = 0;\n\n\tethnl_cable_test_result(phydev, ETHTOOL_A_CABLE_PAIR_A,\n\t\t\t\tlan87xx_cable_test_report_trans(detect));\n\n\treturn 0;\n}\n\nstatic int lan87xx_cable_test_get_status(struct phy_device *phydev,\n\t\t\t\t\t bool *finished)\n{\n\tint rc = 0;\n\n\t*finished = false;\n\n\t \n\trc = access_ereg(phydev, PHYACC_ATTR_MODE_READ, PHYACC_ATTR_BANK_DSP,\n\t\t\t 90, 0);\n\tif (rc < 0)\n\t\treturn rc;\n\n\tif ((rc & 2) == 2) {\n\t\t \n\t\trc = access_ereg(phydev, PHYACC_ATTR_MODE_WRITE,\n\t\t\t\t PHYACC_ATTR_BANK_DSP,\n\t\t\t\t 90, 0);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\t*finished = true;\n\n\t\treturn lan87xx_cable_test_report(phydev);\n\t}\n\n\treturn 0;\n}\n\nstatic int lan87xx_read_status(struct phy_device *phydev)\n{\n\tint rc = 0;\n\n\trc = phy_read(phydev, T1_MODE_STAT_REG);\n\tif (rc < 0)\n\t\treturn rc;\n\n\tif (rc & T1_LINK_UP_MSK)\n\t\tphydev->link = 1;\n\telse\n\t\tphydev->link = 0;\n\n\tphydev->speed = SPEED_UNKNOWN;\n\tphydev->duplex = DUPLEX_UNKNOWN;\n\tphydev->pause = 0;\n\tphydev->asym_pause = 0;\n\n\trc = genphy_read_master_slave(phydev);\n\tif (rc < 0)\n\t\treturn rc;\n\n\trc = genphy_read_status_fixed(phydev);\n\tif (rc < 0)\n\t\treturn rc;\n\n\treturn rc;\n}\n\nstatic int lan87xx_config_aneg(struct phy_device *phydev)\n{\n\tu16 ctl = 0;\n\tint ret;\n\n\tswitch (phydev->master_slave_set) {\n\tcase MASTER_SLAVE_CFG_MASTER_FORCE:\n\t\tctl |= CTL1000_AS_MASTER;\n\t\tbreak;\n\tcase MASTER_SLAVE_CFG_SLAVE_FORCE:\n\t\tbreak;\n\tcase MASTER_SLAVE_CFG_UNKNOWN:\n\tcase MASTER_SLAVE_CFG_UNSUPPORTED:\n\t\treturn 0;\n\tdefault:\n\t\tphydev_warn(phydev, \"Unsupported Master/Slave mode\\n\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tret = phy_modify_changed(phydev, MII_CTRL1000, CTL1000_AS_MASTER, ctl);\n\tif (ret == 1)\n\t\treturn phy_init_hw(phydev);\n\n\treturn ret;\n}\n\nstatic int lan87xx_get_sqi(struct phy_device *phydev)\n{\n\tu8 sqi_value = 0;\n\tint rc;\n\n\trc = access_ereg(phydev, PHYACC_ATTR_MODE_WRITE,\n\t\t\t PHYACC_ATTR_BANK_DSP, T1_COEF_RW_CTL_CFG, 0x0301);\n\tif (rc < 0)\n\t\treturn rc;\n\n\trc = access_ereg(phydev, PHYACC_ATTR_MODE_READ,\n\t\t\t PHYACC_ATTR_BANK_DSP, T1_DCQ_SQI_REG, 0x0);\n\tif (rc < 0)\n\t\treturn rc;\n\n\tsqi_value = FIELD_GET(T1_DCQ_SQI_MSK, rc);\n\n\treturn sqi_value;\n}\n\nstatic int lan87xx_get_sqi_max(struct phy_device *phydev)\n{\n\treturn LAN87XX_MAX_SQI;\n}\n\nstatic struct phy_driver microchip_t1_phy_driver[] = {\n\t{\n\t\tPHY_ID_MATCH_MODEL(PHY_ID_LAN87XX),\n\t\t.name           = \"Microchip LAN87xx T1\",\n\t\t.flags          = PHY_POLL_CABLE_TEST,\n\t\t.features       = PHY_BASIC_T1_FEATURES,\n\t\t.config_init\t= lan87xx_config_init,\n\t\t.config_intr    = lan87xx_phy_config_intr,\n\t\t.handle_interrupt = lan87xx_handle_interrupt,\n\t\t.suspend        = genphy_suspend,\n\t\t.resume         = genphy_resume,\n\t\t.config_aneg    = lan87xx_config_aneg,\n\t\t.read_status\t= lan87xx_read_status,\n\t\t.get_sqi\t= lan87xx_get_sqi,\n\t\t.get_sqi_max\t= lan87xx_get_sqi_max,\n\t\t.cable_test_start = lan87xx_cable_test_start,\n\t\t.cable_test_get_status = lan87xx_cable_test_get_status,\n\t},\n\t{\n\t\tPHY_ID_MATCH_MODEL(PHY_ID_LAN937X),\n\t\t.name\t\t= \"Microchip LAN937x T1\",\n\t\t.flags          = PHY_POLL_CABLE_TEST,\n\t\t.features\t= PHY_BASIC_T1_FEATURES,\n\t\t.config_init\t= lan87xx_config_init,\n\t\t.config_intr    = lan87xx_phy_config_intr,\n\t\t.handle_interrupt = lan87xx_handle_interrupt,\n\t\t.suspend\t= genphy_suspend,\n\t\t.resume\t\t= genphy_resume,\n\t\t.config_aneg    = lan87xx_config_aneg,\n\t\t.read_status\t= lan87xx_read_status,\n\t\t.get_sqi\t= lan87xx_get_sqi,\n\t\t.get_sqi_max\t= lan87xx_get_sqi_max,\n\t\t.cable_test_start = lan87xx_cable_test_start,\n\t\t.cable_test_get_status = lan87xx_cable_test_get_status,\n\t}\n};\n\nmodule_phy_driver(microchip_t1_phy_driver);\n\nstatic struct mdio_device_id __maybe_unused microchip_t1_tbl[] = {\n\t{ PHY_ID_MATCH_MODEL(PHY_ID_LAN87XX) },\n\t{ PHY_ID_MATCH_MODEL(PHY_ID_LAN937X) },\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(mdio, microchip_t1_tbl);\n\nMODULE_AUTHOR(DRIVER_AUTHOR);\nMODULE_DESCRIPTION(DRIVER_DESC);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}