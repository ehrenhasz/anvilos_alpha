{
  "module_name": "phy-c45.c",
  "hash_id": "6bc2a5d792647605f07d67ed550a41712ea92c810615a8060297586431a49d4c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/phy-c45.c",
  "human_readable_source": "\n \n#include <linux/ethtool.h>\n#include <linux/export.h>\n#include <linux/mdio.h>\n#include <linux/mii.h>\n#include <linux/phy.h>\n\n#include \"mdio-open-alliance.h\"\n\n \nstatic bool genphy_c45_baset1_able(struct phy_device *phydev)\n{\n\tint val;\n\n\tif (phydev->pma_extable == -ENODATA) {\n\t\tval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_PMA_EXTABLE);\n\t\tif (val < 0)\n\t\t\treturn false;\n\n\t\tphydev->pma_extable = val;\n\t}\n\n\treturn !!(phydev->pma_extable & MDIO_PMA_EXTABLE_BT1);\n}\n\n \nstatic bool genphy_c45_pma_can_sleep(struct phy_device *phydev)\n{\n\tint stat1;\n\n\tstat1 = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_STAT1);\n\tif (stat1 < 0)\n\t\treturn false;\n\n\treturn !!(stat1 & MDIO_STAT1_LPOWERABLE);\n}\n\n \nint genphy_c45_pma_resume(struct phy_device *phydev)\n{\n\tif (!genphy_c45_pma_can_sleep(phydev))\n\t\treturn -EOPNOTSUPP;\n\n\treturn phy_clear_bits_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL1,\n\t\t\t\t  MDIO_CTRL1_LPOWER);\n}\nEXPORT_SYMBOL_GPL(genphy_c45_pma_resume);\n\n \nint genphy_c45_pma_suspend(struct phy_device *phydev)\n{\n\tif (!genphy_c45_pma_can_sleep(phydev))\n\t\treturn -EOPNOTSUPP;\n\n\treturn phy_set_bits_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL1,\n\t\t\t\tMDIO_CTRL1_LPOWER);\n}\nEXPORT_SYMBOL_GPL(genphy_c45_pma_suspend);\n\n \nint genphy_c45_pma_baset1_setup_master_slave(struct phy_device *phydev)\n{\n\tint ctl = 0;\n\n\tswitch (phydev->master_slave_set) {\n\tcase MASTER_SLAVE_CFG_MASTER_PREFERRED:\n\tcase MASTER_SLAVE_CFG_MASTER_FORCE:\n\t\tctl = MDIO_PMA_PMD_BT1_CTRL_CFG_MST;\n\t\tbreak;\n\tcase MASTER_SLAVE_CFG_SLAVE_FORCE:\n\tcase MASTER_SLAVE_CFG_SLAVE_PREFERRED:\n\t\tbreak;\n\tcase MASTER_SLAVE_CFG_UNKNOWN:\n\tcase MASTER_SLAVE_CFG_UNSUPPORTED:\n\t\treturn 0;\n\tdefault:\n\t\tphydev_warn(phydev, \"Unsupported Master/Slave mode\\n\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\treturn phy_modify_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_PMA_PMD_BT1_CTRL,\n\t\t\t     MDIO_PMA_PMD_BT1_CTRL_CFG_MST, ctl);\n}\nEXPORT_SYMBOL_GPL(genphy_c45_pma_baset1_setup_master_slave);\n\n \nint genphy_c45_pma_setup_forced(struct phy_device *phydev)\n{\n\tint bt1_ctrl, ctrl1, ctrl2, ret;\n\n\t \n\tif (phydev->duplex != DUPLEX_FULL)\n\t\treturn -EINVAL;\n\n\tctrl1 = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL1);\n\tif (ctrl1 < 0)\n\t\treturn ctrl1;\n\n\tctrl2 = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL2);\n\tif (ctrl2 < 0)\n\t\treturn ctrl2;\n\n\tctrl1 &= ~MDIO_CTRL1_SPEEDSEL;\n\t \n\tctrl2 &= ~(MDIO_PMA_CTRL2_TYPE | 0x30);\n\n\tswitch (phydev->speed) {\n\tcase SPEED_10:\n\t\tif (genphy_c45_baset1_able(phydev))\n\t\t\tctrl2 |= MDIO_PMA_CTRL2_BASET1;\n\t\telse\n\t\t\tctrl2 |= MDIO_PMA_CTRL2_10BT;\n\t\tbreak;\n\tcase SPEED_100:\n\t\tctrl1 |= MDIO_PMA_CTRL1_SPEED100;\n\t\tctrl2 |= MDIO_PMA_CTRL2_100BTX;\n\t\tbreak;\n\tcase SPEED_1000:\n\t\tctrl1 |= MDIO_PMA_CTRL1_SPEED1000;\n\t\t \n\t\tctrl2 |= MDIO_PMA_CTRL2_1000BT;\n\t\tbreak;\n\tcase SPEED_2500:\n\t\tctrl1 |= MDIO_CTRL1_SPEED2_5G;\n\t\t \n\t\tctrl2 |= MDIO_PMA_CTRL2_2_5GBT;\n\t\tbreak;\n\tcase SPEED_5000:\n\t\tctrl1 |= MDIO_CTRL1_SPEED5G;\n\t\t \n\t\tctrl2 |= MDIO_PMA_CTRL2_5GBT;\n\t\tbreak;\n\tcase SPEED_10000:\n\t\tctrl1 |= MDIO_CTRL1_SPEED10G;\n\t\t \n\t\tctrl2 |= MDIO_PMA_CTRL2_10GBT;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = phy_write_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL1, ctrl1);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = phy_write_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL2, ctrl2);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (genphy_c45_baset1_able(phydev)) {\n\t\tret = genphy_c45_pma_baset1_setup_master_slave(phydev);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tbt1_ctrl = 0;\n\t\tif (phydev->speed == SPEED_1000)\n\t\t\tbt1_ctrl = MDIO_PMA_PMD_BT1_CTRL_STRAP_B1000;\n\n\t\tret = phy_modify_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_PMA_PMD_BT1_CTRL,\n\t\t\t\t     MDIO_PMA_PMD_BT1_CTRL_STRAP, bt1_ctrl);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn genphy_c45_an_disable_aneg(phydev);\n}\nEXPORT_SYMBOL_GPL(genphy_c45_pma_setup_forced);\n\n \nstatic int genphy_c45_baset1_an_config_aneg(struct phy_device *phydev)\n{\n\tu16 adv_l_mask, adv_l = 0;\n\tu16 adv_m_mask, adv_m = 0;\n\tint changed = 0;\n\tint ret;\n\n\tadv_l_mask = MDIO_AN_T1_ADV_L_FORCE_MS | MDIO_AN_T1_ADV_L_PAUSE_CAP |\n\t\tMDIO_AN_T1_ADV_L_PAUSE_ASYM;\n\tadv_m_mask = MDIO_AN_T1_ADV_M_MST | MDIO_AN_T1_ADV_M_B10L;\n\n\tswitch (phydev->master_slave_set) {\n\tcase MASTER_SLAVE_CFG_MASTER_FORCE:\n\t\tadv_m |= MDIO_AN_T1_ADV_M_MST;\n\t\tfallthrough;\n\tcase MASTER_SLAVE_CFG_SLAVE_FORCE:\n\t\tadv_l |= MDIO_AN_T1_ADV_L_FORCE_MS;\n\t\tbreak;\n\tcase MASTER_SLAVE_CFG_MASTER_PREFERRED:\n\t\tadv_m |= MDIO_AN_T1_ADV_M_MST;\n\t\tfallthrough;\n\tcase MASTER_SLAVE_CFG_SLAVE_PREFERRED:\n\t\tbreak;\n\tcase MASTER_SLAVE_CFG_UNKNOWN:\n\tcase MASTER_SLAVE_CFG_UNSUPPORTED:\n\t\t \n\t\tadv_l_mask &= ~MDIO_AN_T1_ADV_L_FORCE_MS;\n\t\tadv_m_mask &= ~MDIO_AN_T1_ADV_M_MST;\n\t\tbreak;\n\tdefault:\n\t\tphydev_warn(phydev, \"Unsupported Master/Slave mode\\n\");\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tadv_l |= linkmode_adv_to_mii_t1_adv_l_t(phydev->advertising);\n\n\tret = phy_modify_mmd_changed(phydev, MDIO_MMD_AN, MDIO_AN_T1_ADV_L,\n\t\t\t\t     adv_l_mask, adv_l);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret > 0)\n\t\tchanged = 1;\n\n\tadv_m |= linkmode_adv_to_mii_t1_adv_m_t(phydev->advertising);\n\n\tret = phy_modify_mmd_changed(phydev, MDIO_MMD_AN, MDIO_AN_T1_ADV_M,\n\t\t\t\t     adv_m_mask, adv_m);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret > 0)\n\t\tchanged = 1;\n\n\treturn changed;\n}\n\n \nint genphy_c45_an_config_aneg(struct phy_device *phydev)\n{\n\tint changed = 0, ret;\n\tu32 adv;\n\n\tlinkmode_and(phydev->advertising, phydev->advertising,\n\t\t     phydev->supported);\n\n\tret = genphy_c45_an_config_eee_aneg(phydev);\n\tif (ret < 0)\n\t\treturn ret;\n\telse if (ret)\n\t\tchanged = true;\n\n\tif (genphy_c45_baset1_able(phydev))\n\t\treturn genphy_c45_baset1_an_config_aneg(phydev);\n\n\tadv = linkmode_adv_to_mii_adv_t(phydev->advertising);\n\n\tret = phy_modify_mmd_changed(phydev, MDIO_MMD_AN, MDIO_AN_ADVERTISE,\n\t\t\t\t     ADVERTISE_ALL | ADVERTISE_100BASE4 |\n\t\t\t\t     ADVERTISE_PAUSE_CAP | ADVERTISE_PAUSE_ASYM,\n\t\t\t\t     adv);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret > 0)\n\t\tchanged = 1;\n\n\tadv = linkmode_adv_to_mii_10gbt_adv_t(phydev->advertising);\n\n\tret = phy_modify_mmd_changed(phydev, MDIO_MMD_AN, MDIO_AN_10GBT_CTRL,\n\t\t\t\t     MDIO_AN_10GBT_CTRL_ADV10G |\n\t\t\t\t     MDIO_AN_10GBT_CTRL_ADV5G |\n\t\t\t\t     MDIO_AN_10GBT_CTRL_ADV2_5G, adv);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret > 0)\n\t\tchanged = 1;\n\n\treturn changed;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_an_config_aneg);\n\n \nint genphy_c45_an_disable_aneg(struct phy_device *phydev)\n{\n\tu16 reg = MDIO_CTRL1;\n\n\tif (genphy_c45_baset1_able(phydev))\n\t\treg = MDIO_AN_T1_CTRL;\n\n\treturn phy_clear_bits_mmd(phydev, MDIO_MMD_AN, reg,\n\t\t\t\t  MDIO_AN_CTRL1_ENABLE | MDIO_AN_CTRL1_RESTART);\n}\nEXPORT_SYMBOL_GPL(genphy_c45_an_disable_aneg);\n\n \nint genphy_c45_restart_aneg(struct phy_device *phydev)\n{\n\tu16 reg = MDIO_CTRL1;\n\n\tif (genphy_c45_baset1_able(phydev))\n\t\treg = MDIO_AN_T1_CTRL;\n\n\treturn phy_set_bits_mmd(phydev, MDIO_MMD_AN, reg,\n\t\t\t\tMDIO_AN_CTRL1_ENABLE | MDIO_AN_CTRL1_RESTART);\n}\nEXPORT_SYMBOL_GPL(genphy_c45_restart_aneg);\n\n \nint genphy_c45_check_and_restart_aneg(struct phy_device *phydev, bool restart)\n{\n\tu16 reg = MDIO_CTRL1;\n\tint ret;\n\n\tif (genphy_c45_baset1_able(phydev))\n\t\treg = MDIO_AN_T1_CTRL;\n\n\tif (!restart) {\n\t\t \n\t\tret = phy_read_mmd(phydev, MDIO_MMD_AN, reg);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tif (!(ret & MDIO_AN_CTRL1_ENABLE))\n\t\t\trestart = true;\n\t}\n\n\tif (restart)\n\t\treturn genphy_c45_restart_aneg(phydev);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_check_and_restart_aneg);\n\n \nint genphy_c45_aneg_done(struct phy_device *phydev)\n{\n\tint reg = MDIO_STAT1;\n\tint val;\n\n\tif (genphy_c45_baset1_able(phydev))\n\t\treg = MDIO_AN_T1_STAT;\n\n\tval = phy_read_mmd(phydev, MDIO_MMD_AN, reg);\n\n\treturn val < 0 ? val : val & MDIO_AN_STAT1_COMPLETE ? 1 : 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_aneg_done);\n\n \nint genphy_c45_read_link(struct phy_device *phydev)\n{\n\tu32 mmd_mask = MDIO_DEVS_PMAPMD;\n\tint val, devad;\n\tbool link = true;\n\n\tif (phydev->c45_ids.mmds_present & MDIO_DEVS_AN) {\n\t\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_CTRL1);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\t \n\t\tif (val & MDIO_AN_CTRL1_RESTART) {\n\t\t\tphydev->link = 0;\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\twhile (mmd_mask && link) {\n\t\tdevad = __ffs(mmd_mask);\n\t\tmmd_mask &= ~BIT(devad);\n\n\t\t \n\t\tif (!phy_polling_mode(phydev) || !phydev->link) {\n\t\t\tval = phy_read_mmd(phydev, devad, MDIO_STAT1);\n\t\t\tif (val < 0)\n\t\t\t\treturn val;\n\t\t\telse if (val & MDIO_STAT1_LSTATUS)\n\t\t\t\tcontinue;\n\t\t}\n\n\t\tval = phy_read_mmd(phydev, devad, MDIO_STAT1);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\tif (!(val & MDIO_STAT1_LSTATUS))\n\t\t\tlink = false;\n\t}\n\n\tphydev->link = link;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_read_link);\n\n \nstatic int genphy_c45_baset1_read_lpa(struct phy_device *phydev)\n{\n\tint val;\n\n\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_T1_STAT);\n\tif (val < 0)\n\t\treturn val;\n\n\tif (!(val & MDIO_AN_STAT1_COMPLETE)) {\n\t\tlinkmode_clear_bit(ETHTOOL_LINK_MODE_Autoneg_BIT, phydev->lp_advertising);\n\t\tmii_t1_adv_l_mod_linkmode_t(phydev->lp_advertising, 0);\n\t\tmii_t1_adv_m_mod_linkmode_t(phydev->lp_advertising, 0);\n\n\t\tphydev->pause = 0;\n\t\tphydev->asym_pause = 0;\n\n\t\treturn 0;\n\t}\n\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_Autoneg_BIT, phydev->lp_advertising, 1);\n\n\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_T1_LP_L);\n\tif (val < 0)\n\t\treturn val;\n\n\tmii_t1_adv_l_mod_linkmode_t(phydev->lp_advertising, val);\n\tphydev->pause = val & MDIO_AN_T1_ADV_L_PAUSE_CAP ? 1 : 0;\n\tphydev->asym_pause = val & MDIO_AN_T1_ADV_L_PAUSE_ASYM ? 1 : 0;\n\n\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_T1_LP_M);\n\tif (val < 0)\n\t\treturn val;\n\n\tmii_t1_adv_m_mod_linkmode_t(phydev->lp_advertising, val);\n\n\treturn 0;\n}\n\n \nint genphy_c45_read_lpa(struct phy_device *phydev)\n{\n\tint val;\n\n\tif (genphy_c45_baset1_able(phydev))\n\t\treturn genphy_c45_baset1_read_lpa(phydev);\n\n\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_STAT1);\n\tif (val < 0)\n\t\treturn val;\n\n\tif (!(val & MDIO_AN_STAT1_COMPLETE)) {\n\t\tlinkmode_clear_bit(ETHTOOL_LINK_MODE_Autoneg_BIT,\n\t\t\t\t   phydev->lp_advertising);\n\t\tmii_10gbt_stat_mod_linkmode_lpa_t(phydev->lp_advertising, 0);\n\t\tmii_adv_mod_linkmode_adv_t(phydev->lp_advertising, 0);\n\t\tphydev->pause = 0;\n\t\tphydev->asym_pause = 0;\n\n\t\treturn 0;\n\t}\n\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_Autoneg_BIT, phydev->lp_advertising,\n\t\t\t val & MDIO_AN_STAT1_LPABLE);\n\n\t \n\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_LPA);\n\tif (val < 0)\n\t\treturn val;\n\n\tmii_adv_mod_linkmode_adv_t(phydev->lp_advertising, val);\n\tphydev->pause = val & LPA_PAUSE_CAP ? 1 : 0;\n\tphydev->asym_pause = val & LPA_PAUSE_ASYM ? 1 : 0;\n\n\t \n\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_10GBT_STAT);\n\tif (val < 0)\n\t\treturn val;\n\n\tmii_10gbt_stat_mod_linkmode_lpa_t(phydev->lp_advertising, val);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_read_lpa);\n\n \nint genphy_c45_pma_baset1_read_master_slave(struct phy_device *phydev)\n{\n\tint val;\n\n\tphydev->master_slave_state = MASTER_SLAVE_STATE_UNKNOWN;\n\tphydev->master_slave_get = MASTER_SLAVE_CFG_UNKNOWN;\n\n\tval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_PMA_PMD_BT1_CTRL);\n\tif (val < 0)\n\t\treturn val;\n\n\tif (val & MDIO_PMA_PMD_BT1_CTRL_CFG_MST) {\n\t\tphydev->master_slave_get = MASTER_SLAVE_CFG_MASTER_FORCE;\n\t\tphydev->master_slave_state = MASTER_SLAVE_STATE_MASTER;\n\t} else {\n\t\tphydev->master_slave_get = MASTER_SLAVE_CFG_SLAVE_FORCE;\n\t\tphydev->master_slave_state = MASTER_SLAVE_STATE_SLAVE;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_pma_baset1_read_master_slave);\n\n \nint genphy_c45_read_pma(struct phy_device *phydev)\n{\n\tint val;\n\n\tlinkmode_zero(phydev->lp_advertising);\n\n\tval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_CTRL1);\n\tif (val < 0)\n\t\treturn val;\n\n\tswitch (val & MDIO_CTRL1_SPEEDSEL) {\n\tcase 0:\n\t\tphydev->speed = SPEED_10;\n\t\tbreak;\n\tcase MDIO_PMA_CTRL1_SPEED100:\n\t\tphydev->speed = SPEED_100;\n\t\tbreak;\n\tcase MDIO_PMA_CTRL1_SPEED1000:\n\t\tphydev->speed = SPEED_1000;\n\t\tbreak;\n\tcase MDIO_CTRL1_SPEED2_5G:\n\t\tphydev->speed = SPEED_2500;\n\t\tbreak;\n\tcase MDIO_CTRL1_SPEED5G:\n\t\tphydev->speed = SPEED_5000;\n\t\tbreak;\n\tcase MDIO_CTRL1_SPEED10G:\n\t\tphydev->speed = SPEED_10000;\n\t\tbreak;\n\tdefault:\n\t\tphydev->speed = SPEED_UNKNOWN;\n\t\tbreak;\n\t}\n\n\tphydev->duplex = DUPLEX_FULL;\n\n\tif (genphy_c45_baset1_able(phydev)) {\n\t\tval = genphy_c45_pma_baset1_read_master_slave(phydev);\n\t\tif (val < 0)\n\t\t\treturn val;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_read_pma);\n\n \nint genphy_c45_read_mdix(struct phy_device *phydev)\n{\n\tint val;\n\n\tif (phydev->speed == SPEED_10000) {\n\t\tval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD,\n\t\t\t\t   MDIO_PMA_10GBT_SWAPPOL);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\tswitch (val) {\n\t\tcase MDIO_PMA_10GBT_SWAPPOL_ABNX | MDIO_PMA_10GBT_SWAPPOL_CDNX:\n\t\t\tphydev->mdix = ETH_TP_MDI;\n\t\t\tbreak;\n\n\t\tcase 0:\n\t\t\tphydev->mdix = ETH_TP_MDI_X;\n\t\t\tbreak;\n\n\t\tdefault:\n\t\t\tphydev->mdix = ETH_TP_MDI_INVALID;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_read_mdix);\n\n \nint genphy_c45_write_eee_adv(struct phy_device *phydev, unsigned long *adv)\n{\n\tint val, changed = 0;\n\n\tif (linkmode_intersects(phydev->supported_eee, PHY_EEE_CAP1_FEATURES)) {\n\t\tval = linkmode_to_mii_eee_cap1_t(adv);\n\n\t\t \n\t\tval &= ~phydev->eee_broken_modes;\n\n\t\t \n\t\tval = phy_modify_mmd_changed(phydev, MDIO_MMD_AN,\n\t\t\t\t\t     MDIO_AN_EEE_ADV,\n\t\t\t\t\t     MDIO_EEE_100TX | MDIO_EEE_1000T |\n\t\t\t\t\t     MDIO_EEE_10GT | MDIO_EEE_1000KX |\n\t\t\t\t\t     MDIO_EEE_10GKX4 | MDIO_EEE_10GKR,\n\t\t\t\t\t     val);\n\t\tif (val < 0)\n\t\t\treturn val;\n\t\tif (val > 0)\n\t\t\tchanged = 1;\n\t}\n\n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_10baseT1L_Full_BIT,\n\t\t\t      phydev->supported_eee)) {\n\t\tval = linkmode_adv_to_mii_10base_t1_t(adv);\n\t\t \n\t\tval = phy_modify_mmd_changed(phydev, MDIO_MMD_AN,\n\t\t\t\t\t     MDIO_AN_10BT1_AN_CTRL,\n\t\t\t\t\t     MDIO_AN_10BT1_AN_CTRL_ADV_EEE_T1L,\n\t\t\t\t\t     val);\n\t\tif (val < 0)\n\t\t\treturn val;\n\t\tif (val > 0)\n\t\t\tchanged = 1;\n\t}\n\n\treturn changed;\n}\n\n \nint genphy_c45_read_eee_adv(struct phy_device *phydev, unsigned long *adv)\n{\n\tint val;\n\n\tif (linkmode_intersects(phydev->supported_eee, PHY_EEE_CAP1_FEATURES)) {\n\t\t \n\t\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_EEE_ADV);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\tmii_eee_cap1_mod_linkmode_t(adv, val);\n\t}\n\n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_10baseT1L_Full_BIT,\n\t\t\t      phydev->supported_eee)) {\n\t\t \n\t\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_10BT1_AN_CTRL);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\tmii_10base_t1_adv_mod_linkmode_t(adv, val);\n\t}\n\n\treturn 0;\n}\n\n \nstatic int genphy_c45_read_eee_lpa(struct phy_device *phydev,\n\t\t\t\t   unsigned long *lpa)\n{\n\tint val;\n\n\tif (linkmode_intersects(phydev->supported_eee, PHY_EEE_CAP1_FEATURES)) {\n\t\t \n\t\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_EEE_LPABLE);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\tmii_eee_cap1_mod_linkmode_t(lpa, val);\n\t}\n\n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_10baseT1L_Full_BIT,\n\t\t\t      phydev->supported_eee)) {\n\t\t \n\t\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_10BT1_AN_STAT);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\tmii_10base_t1_adv_mod_linkmode_t(lpa, val);\n\t}\n\n\treturn 0;\n}\n\n \nstatic int genphy_c45_read_eee_cap1(struct phy_device *phydev)\n{\n\tint val;\n\n\t \n\tval = phy_read_mmd(phydev, MDIO_MMD_PCS, MDIO_PCS_EEE_ABLE);\n\tif (val < 0)\n\t\treturn val;\n\n\t \n\tif (val == 0xffff)\n\t\treturn 0;\n\n\tmii_eee_cap1_mod_linkmode_t(phydev->supported_eee, val);\n\n\t \n\tlinkmode_and(phydev->supported_eee, phydev->supported_eee,\n\t\t     phydev->supported);\n\n\treturn 0;\n}\n\n \nint genphy_c45_read_eee_abilities(struct phy_device *phydev)\n{\n\tint val;\n\n\t \n\tif (linkmode_intersects(phydev->supported, PHY_EEE_CAP1_FEATURES)) {\n\t\tval = genphy_c45_read_eee_cap1(phydev);\n\t\tif (val)\n\t\t\treturn val;\n\t}\n\n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_10baseT1L_Full_BIT,\n\t\t\t      phydev->supported)) {\n\t\t \n\t\tval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_PMA_10T1L_STAT);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10baseT1L_Full_BIT,\n\t\t\t\t phydev->supported_eee,\n\t\t\t\t val & MDIO_PMA_10T1L_STAT_EEE);\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_read_eee_abilities);\n\n \nint genphy_c45_an_config_eee_aneg(struct phy_device *phydev)\n{\n\tif (!phydev->eee_enabled) {\n\t\t__ETHTOOL_DECLARE_LINK_MODE_MASK(adv) = {};\n\n\t\treturn genphy_c45_write_eee_adv(phydev, adv);\n\t}\n\n\treturn genphy_c45_write_eee_adv(phydev, phydev->advertising_eee);\n}\n\n \nint genphy_c45_pma_baset1_read_abilities(struct phy_device *phydev)\n{\n\tint val;\n\n\tval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_PMA_PMD_BT1);\n\tif (val < 0)\n\t\treturn val;\n\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10baseT1L_Full_BIT,\n\t\t\t phydev->supported,\n\t\t\t val & MDIO_PMA_PMD_BT1_B10L_ABLE);\n\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_100baseT1_Full_BIT,\n\t\t\t phydev->supported,\n\t\t\t val & MDIO_PMA_PMD_BT1_B100_ABLE);\n\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_1000baseT1_Full_BIT,\n\t\t\t phydev->supported,\n\t\t\t val & MDIO_PMA_PMD_BT1_B1000_ABLE);\n\n\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_T1_STAT);\n\tif (val < 0)\n\t\treturn val;\n\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_Autoneg_BIT,\n\t\t\t phydev->supported,\n\t\t\t val & MDIO_AN_STAT1_ABLE);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_pma_baset1_read_abilities);\n\n \nint genphy_c45_pma_read_abilities(struct phy_device *phydev)\n{\n\tint val;\n\n\tlinkmode_clear_bit(ETHTOOL_LINK_MODE_Autoneg_BIT, phydev->supported);\n\tif (phydev->c45_ids.mmds_present & MDIO_DEVS_AN) {\n\t\tval = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_STAT1);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\tif (val & MDIO_AN_STAT1_ABLE)\n\t\t\tlinkmode_set_bit(ETHTOOL_LINK_MODE_Autoneg_BIT,\n\t\t\t\t\t phydev->supported);\n\t}\n\n\tval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_STAT2);\n\tif (val < 0)\n\t\treturn val;\n\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10000baseSR_Full_BIT,\n\t\t\t phydev->supported,\n\t\t\t val & MDIO_PMA_STAT2_10GBSR);\n\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10000baseLR_Full_BIT,\n\t\t\t phydev->supported,\n\t\t\t val & MDIO_PMA_STAT2_10GBLR);\n\n\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10000baseER_Full_BIT,\n\t\t\t phydev->supported,\n\t\t\t val & MDIO_PMA_STAT2_10GBER);\n\n\tif (val & MDIO_PMA_STAT2_EXTABLE) {\n\t\tval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_PMA_EXTABLE);\n\t\tif (val < 0)\n\t\t\treturn val;\n\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10000baseLRM_Full_BIT,\n\t\t\t\t phydev->supported,\n\t\t\t\t val & MDIO_PMA_EXTABLE_10GBLRM);\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10000baseT_Full_BIT,\n\t\t\t\t phydev->supported,\n\t\t\t\t val & MDIO_PMA_EXTABLE_10GBT);\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10000baseKX4_Full_BIT,\n\t\t\t\t phydev->supported,\n\t\t\t\t val & MDIO_PMA_EXTABLE_10GBKX4);\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10000baseKR_Full_BIT,\n\t\t\t\t phydev->supported,\n\t\t\t\t val & MDIO_PMA_EXTABLE_10GBKR);\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_1000baseT_Full_BIT,\n\t\t\t\t phydev->supported,\n\t\t\t\t val & MDIO_PMA_EXTABLE_1000BT);\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_1000baseKX_Full_BIT,\n\t\t\t\t phydev->supported,\n\t\t\t\t val & MDIO_PMA_EXTABLE_1000BKX);\n\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_100baseT_Full_BIT,\n\t\t\t\t phydev->supported,\n\t\t\t\t val & MDIO_PMA_EXTABLE_100BTX);\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_100baseT_Half_BIT,\n\t\t\t\t phydev->supported,\n\t\t\t\t val & MDIO_PMA_EXTABLE_100BTX);\n\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10baseT_Full_BIT,\n\t\t\t\t phydev->supported,\n\t\t\t\t val & MDIO_PMA_EXTABLE_10BT);\n\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_10baseT_Half_BIT,\n\t\t\t\t phydev->supported,\n\t\t\t\t val & MDIO_PMA_EXTABLE_10BT);\n\n\t\tif (val & MDIO_PMA_EXTABLE_NBT) {\n\t\t\tval = phy_read_mmd(phydev, MDIO_MMD_PMAPMD,\n\t\t\t\t\t   MDIO_PMA_NG_EXTABLE);\n\t\t\tif (val < 0)\n\t\t\t\treturn val;\n\n\t\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_2500baseT_Full_BIT,\n\t\t\t\t\t phydev->supported,\n\t\t\t\t\t val & MDIO_PMA_NG_EXTABLE_2_5GBT);\n\n\t\t\tlinkmode_mod_bit(ETHTOOL_LINK_MODE_5000baseT_Full_BIT,\n\t\t\t\t\t phydev->supported,\n\t\t\t\t\t val & MDIO_PMA_NG_EXTABLE_5GBT);\n\t\t}\n\n\t\tif (val & MDIO_PMA_EXTABLE_BT1) {\n\t\t\tval = genphy_c45_pma_baset1_read_abilities(phydev);\n\t\t\tif (val < 0)\n\t\t\t\treturn val;\n\t\t}\n\t}\n\n\t \n\tgenphy_c45_read_eee_abilities(phydev);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_pma_read_abilities);\n\n \nint genphy_c45_baset1_read_status(struct phy_device *phydev)\n{\n\tint ret;\n\tint cfg;\n\n\tphydev->master_slave_get = MASTER_SLAVE_CFG_UNKNOWN;\n\tphydev->master_slave_state = MASTER_SLAVE_STATE_UNKNOWN;\n\n\tret = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_T1_ADV_L);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tcfg = phy_read_mmd(phydev, MDIO_MMD_AN, MDIO_AN_T1_ADV_M);\n\tif (cfg < 0)\n\t\treturn cfg;\n\n\tif (ret & MDIO_AN_T1_ADV_L_FORCE_MS) {\n\t\tif (cfg & MDIO_AN_T1_ADV_M_MST)\n\t\t\tphydev->master_slave_get = MASTER_SLAVE_CFG_MASTER_FORCE;\n\t\telse\n\t\t\tphydev->master_slave_get = MASTER_SLAVE_CFG_SLAVE_FORCE;\n\t} else {\n\t\tif (cfg & MDIO_AN_T1_ADV_M_MST)\n\t\t\tphydev->master_slave_get = MASTER_SLAVE_CFG_MASTER_PREFERRED;\n\t\telse\n\t\t\tphydev->master_slave_get = MASTER_SLAVE_CFG_SLAVE_PREFERRED;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_baset1_read_status);\n\n \nint genphy_c45_read_status(struct phy_device *phydev)\n{\n\tint ret;\n\n\tret = genphy_c45_read_link(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\tphydev->speed = SPEED_UNKNOWN;\n\tphydev->duplex = DUPLEX_UNKNOWN;\n\tphydev->pause = 0;\n\tphydev->asym_pause = 0;\n\n\tif (phydev->autoneg == AUTONEG_ENABLE) {\n\t\tret = genphy_c45_read_lpa(phydev);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (genphy_c45_baset1_able(phydev)) {\n\t\t\tret = genphy_c45_baset1_read_status(phydev);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\t\t}\n\n\t\tphy_resolve_aneg_linkmode(phydev);\n\t} else {\n\t\tret = genphy_c45_read_pma(phydev);\n\t}\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_read_status);\n\n \nint genphy_c45_config_aneg(struct phy_device *phydev)\n{\n\tbool changed = false;\n\tint ret;\n\n\tif (phydev->autoneg == AUTONEG_DISABLE)\n\t\treturn genphy_c45_pma_setup_forced(phydev);\n\n\tret = genphy_c45_an_config_aneg(phydev);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret > 0)\n\t\tchanged = true;\n\n\treturn genphy_c45_check_and_restart_aneg(phydev, changed);\n}\nEXPORT_SYMBOL_GPL(genphy_c45_config_aneg);\n\n \n\nint gen10g_config_aneg(struct phy_device *phydev)\n{\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(gen10g_config_aneg);\n\nint genphy_c45_loopback(struct phy_device *phydev, bool enable)\n{\n\treturn phy_modify_mmd(phydev, MDIO_MMD_PCS, MDIO_CTRL1,\n\t\t\t      MDIO_PCS_CTRL1_LOOPBACK,\n\t\t\t      enable ? MDIO_PCS_CTRL1_LOOPBACK : 0);\n}\nEXPORT_SYMBOL_GPL(genphy_c45_loopback);\n\n \nint genphy_c45_fast_retrain(struct phy_device *phydev, bool enable)\n{\n\tint ret;\n\n\tif (!enable)\n\t\treturn phy_clear_bits_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_FSRT_CSR,\n\t\t\t\tMDIO_PMA_10GBR_FSRT_ENABLE);\n\n\tif (linkmode_test_bit(ETHTOOL_LINK_MODE_2500baseT_Full_BIT, phydev->supported)) {\n\t\tret = phy_set_bits_mmd(phydev, MDIO_MMD_AN, MDIO_AN_10GBT_CTRL,\n\t\t\t\tMDIO_AN_10GBT_CTRL_ADVFSRT2_5G);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tret = phy_set_bits_mmd(phydev, MDIO_MMD_AN, MDIO_AN_CTRL2,\n\t\t\t\tMDIO_AN_THP_BP2_5GT);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn phy_set_bits_mmd(phydev, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_FSRT_CSR,\n\t\t\tMDIO_PMA_10GBR_FSRT_ENABLE);\n}\nEXPORT_SYMBOL_GPL(genphy_c45_fast_retrain);\n\n \nint genphy_c45_plca_get_cfg(struct phy_device *phydev,\n\t\t\t    struct phy_plca_cfg *plca_cfg)\n{\n\tint ret;\n\n\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2, MDIO_OATC14_PLCA_IDVER);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif ((ret & MDIO_OATC14_PLCA_IDM) != OATC14_IDM)\n\t\treturn -ENODEV;\n\n\tplca_cfg->version = ret & ~MDIO_OATC14_PLCA_IDM;\n\n\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2, MDIO_OATC14_PLCA_CTRL0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tplca_cfg->enabled = !!(ret & MDIO_OATC14_PLCA_EN);\n\n\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2, MDIO_OATC14_PLCA_CTRL1);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tplca_cfg->node_cnt = (ret & MDIO_OATC14_PLCA_NCNT) >> 8;\n\tplca_cfg->node_id = (ret & MDIO_OATC14_PLCA_ID);\n\n\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2, MDIO_OATC14_PLCA_TOTMR);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tplca_cfg->to_tmr = ret & MDIO_OATC14_PLCA_TOT;\n\n\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2, MDIO_OATC14_PLCA_BURST);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tplca_cfg->burst_cnt = (ret & MDIO_OATC14_PLCA_MAXBC) >> 8;\n\tplca_cfg->burst_tmr = (ret & MDIO_OATC14_PLCA_BTMR);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_plca_get_cfg);\n\n \nint genphy_c45_plca_set_cfg(struct phy_device *phydev,\n\t\t\t    const struct phy_plca_cfg *plca_cfg)\n{\n\tu16 val = 0;\n\tint ret;\n\n\t\n\tif (plca_cfg->version >= 0)\n\t\treturn -EINVAL;\n\n\t\n\tif (plca_cfg->enabled == 0) {\n\t\tret = phy_clear_bits_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t\t MDIO_OATC14_PLCA_CTRL0,\n\t\t\t\t\t MDIO_OATC14_PLCA_EN);\n\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\t\n\tif (plca_cfg->node_cnt >= 0 || plca_cfg->node_id >= 0) {\n\t\t \n\t\tif (plca_cfg->node_cnt < 0 || plca_cfg->node_id < 0) {\n\t\t\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t\t   MDIO_OATC14_PLCA_CTRL1);\n\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\n\t\t\tval = ret;\n\t\t}\n\n\t\tif (plca_cfg->node_cnt >= 0)\n\t\t\tval = (val & ~MDIO_OATC14_PLCA_NCNT) |\n\t\t\t      (plca_cfg->node_cnt << 8);\n\n\t\tif (plca_cfg->node_id >= 0)\n\t\t\tval = (val & ~MDIO_OATC14_PLCA_ID) |\n\t\t\t      (plca_cfg->node_id);\n\n\t\tret = phy_write_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t    MDIO_OATC14_PLCA_CTRL1, val);\n\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tif (plca_cfg->to_tmr >= 0) {\n\t\tret = phy_write_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t    MDIO_OATC14_PLCA_TOTMR,\n\t\t\t\t    plca_cfg->to_tmr);\n\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\t\n\tif (plca_cfg->burst_cnt >= 0 || plca_cfg->burst_tmr >= 0) {\n\t\t \n\t\tif (plca_cfg->burst_cnt < 0 || plca_cfg->burst_tmr < 0) {\n\t\t\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t\t   MDIO_OATC14_PLCA_BURST);\n\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\n\t\t\tval = ret;\n\t\t}\n\n\t\tif (plca_cfg->burst_cnt >= 0)\n\t\t\tval = (val & ~MDIO_OATC14_PLCA_MAXBC) |\n\t\t\t      (plca_cfg->burst_cnt << 8);\n\n\t\tif (plca_cfg->burst_tmr >= 0)\n\t\t\tval = (val & ~MDIO_OATC14_PLCA_BTMR) |\n\t\t\t      (plca_cfg->burst_tmr);\n\n\t\tret = phy_write_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t    MDIO_OATC14_PLCA_BURST, val);\n\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\t\n\tif (plca_cfg->enabled > 0) {\n\t\tret = phy_set_bits_mmd(phydev, MDIO_MMD_VEND2,\n\t\t\t\t       MDIO_OATC14_PLCA_CTRL0,\n\t\t\t\t       MDIO_OATC14_PLCA_EN);\n\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_plca_set_cfg);\n\n \nint genphy_c45_plca_get_status(struct phy_device *phydev,\n\t\t\t       struct phy_plca_status *plca_st)\n{\n\tint ret;\n\n\tret = phy_read_mmd(phydev, MDIO_MMD_VEND2, MDIO_OATC14_PLCA_STATUS);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tplca_st->pst = !!(ret & MDIO_OATC14_PLCA_PST);\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(genphy_c45_plca_get_status);\n\n \nint genphy_c45_eee_is_active(struct phy_device *phydev, unsigned long *adv,\n\t\t\t     unsigned long *lp, bool *is_enabled)\n{\n\t__ETHTOOL_DECLARE_LINK_MODE_MASK(tmp_adv) = {};\n\t__ETHTOOL_DECLARE_LINK_MODE_MASK(tmp_lp) = {};\n\t__ETHTOOL_DECLARE_LINK_MODE_MASK(common);\n\tbool eee_enabled, eee_active;\n\tint ret;\n\n\tret = genphy_c45_read_eee_adv(phydev, tmp_adv);\n\tif (ret)\n\t\treturn ret;\n\n\tret = genphy_c45_read_eee_lpa(phydev, tmp_lp);\n\tif (ret)\n\t\treturn ret;\n\n\teee_enabled = !linkmode_empty(tmp_adv);\n\tlinkmode_and(common, tmp_adv, tmp_lp);\n\tif (eee_enabled && !linkmode_empty(common))\n\t\teee_active = phy_check_valid(phydev->speed, phydev->duplex,\n\t\t\t\t\t     common);\n\telse\n\t\teee_active = false;\n\n\tif (adv)\n\t\tlinkmode_copy(adv, tmp_adv);\n\tif (lp)\n\t\tlinkmode_copy(lp, tmp_lp);\n\tif (is_enabled)\n\t\t*is_enabled = eee_enabled;\n\n\treturn eee_active;\n}\nEXPORT_SYMBOL(genphy_c45_eee_is_active);\n\n \nint genphy_c45_ethtool_get_eee(struct phy_device *phydev,\n\t\t\t       struct ethtool_eee *data)\n{\n\t__ETHTOOL_DECLARE_LINK_MODE_MASK(adv) = {};\n\t__ETHTOOL_DECLARE_LINK_MODE_MASK(lp) = {};\n\tbool overflow = false, is_enabled;\n\tint ret;\n\n\tret = genphy_c45_eee_is_active(phydev, adv, lp, &is_enabled);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata->eee_enabled = is_enabled;\n\tdata->eee_active = ret;\n\n\tif (!ethtool_convert_link_mode_to_legacy_u32(&data->supported,\n\t\t\t\t\t\t     phydev->supported_eee))\n\t\toverflow = true;\n\tif (!ethtool_convert_link_mode_to_legacy_u32(&data->advertised, adv))\n\t\toverflow = true;\n\tif (!ethtool_convert_link_mode_to_legacy_u32(&data->lp_advertised, lp))\n\t\toverflow = true;\n\n\tif (overflow)\n\t\tphydev_warn(phydev, \"Not all supported or advertised EEE link modes were passed to the user space\\n\");\n\n\treturn 0;\n}\nEXPORT_SYMBOL(genphy_c45_ethtool_get_eee);\n\n \nint genphy_c45_ethtool_set_eee(struct phy_device *phydev,\n\t\t\t       struct ethtool_eee *data)\n{\n\tint ret;\n\n\tif (data->eee_enabled) {\n\t\tif (data->advertised) {\n\t\t\t__ETHTOOL_DECLARE_LINK_MODE_MASK(adv);\n\n\t\t\tethtool_convert_legacy_u32_to_link_mode(adv,\n\t\t\t\t\t\t\t\tdata->advertised);\n\t\t\tlinkmode_andnot(adv, adv, phydev->supported_eee);\n\t\t\tif (!linkmode_empty(adv)) {\n\t\t\t\tphydev_warn(phydev, \"At least some EEE link modes are not supported.\\n\");\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\n\t\t\tethtool_convert_legacy_u32_to_link_mode(phydev->advertising_eee,\n\t\t\t\t\t\t\t\tdata->advertised);\n\t\t} else {\n\t\t\tlinkmode_copy(phydev->advertising_eee,\n\t\t\t\t      phydev->supported_eee);\n\t\t}\n\n\t\tphydev->eee_enabled = true;\n\t} else {\n\t\tphydev->eee_enabled = false;\n\t}\n\n\tret = genphy_c45_an_config_eee_aneg(phydev);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (ret > 0)\n\t\treturn phy_restart_aneg(phydev);\n\n\treturn 0;\n}\nEXPORT_SYMBOL(genphy_c45_ethtool_set_eee);\n\nstruct phy_driver genphy_c45_driver = {\n\t.phy_id         = 0xffffffff,\n\t.phy_id_mask    = 0xffffffff,\n\t.name           = \"Generic Clause 45 PHY\",\n\t.read_status    = genphy_c45_read_status,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}