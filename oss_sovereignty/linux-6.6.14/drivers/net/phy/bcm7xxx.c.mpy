{
  "module_name": "bcm7xxx.c",
  "hash_id": "d01cec230a52812ab90200cab2d51fbc7093d12834d732ac8a1b11dd6a88a721",
  "original_prompt": "Ingested from linux-6.6.14/drivers/net/phy/bcm7xxx.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/phy.h>\n#include <linux/delay.h>\n#include \"bcm-phy-lib.h\"\n#include <linux/bitops.h>\n#include <linux/brcmphy.h>\n#include <linux/clk.h>\n#include <linux/mdio.h>\n\n \n\n \n#define MII_BCM7XXX_100TX_AUX_CTL\t0x10\n#define MII_BCM7XXX_100TX_FALSE_CAR\t0x13\n#define MII_BCM7XXX_100TX_DISC\t\t0x14\n#define MII_BCM7XXX_AUX_MODE\t\t0x1d\n#define  MII_BCM7XXX_64CLK_MDIO\t\tBIT(12)\n#define MII_BCM7XXX_TEST\t\t0x1f\n#define  MII_BCM7XXX_SHD_MODE_2\t\tBIT(2)\n#define MII_BCM7XXX_SHD_2_ADDR_CTRL\t0xe\n#define MII_BCM7XXX_SHD_2_CTRL_STAT\t0xf\n#define MII_BCM7XXX_SHD_2_BIAS_TRIM\t0x1a\n#define MII_BCM7XXX_SHD_3_PCS_CTRL\t0x0\n#define MII_BCM7XXX_SHD_3_PCS_STATUS\t0x1\n#define MII_BCM7XXX_SHD_3_EEE_CAP\t0x2\n#define MII_BCM7XXX_SHD_3_AN_EEE_ADV\t0x3\n#define MII_BCM7XXX_SHD_3_EEE_LP\t0x4\n#define MII_BCM7XXX_SHD_3_EEE_WK_ERR\t0x5\n#define MII_BCM7XXX_SHD_3_PCS_CTRL_2\t0x6\n#define  MII_BCM7XXX_PCS_CTRL_2_DEF\t0x4400\n#define MII_BCM7XXX_SHD_3_AN_STAT\t0xb\n#define  MII_BCM7XXX_AN_NULL_MSG_EN\tBIT(0)\n#define  MII_BCM7XXX_AN_EEE_EN\t\tBIT(1)\n#define MII_BCM7XXX_SHD_3_EEE_THRESH\t0xe\n#define  MII_BCM7XXX_EEE_THRESH_DEF\t0x50\n#define MII_BCM7XXX_SHD_3_TL4\t\t0x23\n#define  MII_BCM7XXX_TL4_RST_MSK\t(BIT(2) | BIT(1))\n\nstruct bcm7xxx_phy_priv {\n\tu64\t*stats;\n};\n\nstatic int bcm7xxx_28nm_d0_afe_config_init(struct phy_device *phydev)\n{\n\t \n\tbcm_phy_write_misc(phydev, AFE_RXCONFIG_0, 0xeb15);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_RXCONFIG_1, 0x9b2f);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_RXCONFIG_2, 0x2003);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_RX_LP_COUNTER, 0x7fc0);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_TX_CONFIG, 0x431);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_VDCA_ICTRL_0, 0xa7da);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_VDAC_OTHERS_0, 0xa020);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_HPF_TRIM_OTHERS, 0x00e3);\n\n\t \n\tphy_write(phydev, MII_BRCM_CORE_BASE1E, 0x0010);\n\n\t \n\tbcm_phy_write_misc(phydev, DSP_TAP10, 0x011b);\n\n\t \n\tbcm_phy_r_rc_cal_reset(phydev);\n\n\treturn 0;\n}\n\nstatic int bcm7xxx_28nm_e0_plus_afe_config_init(struct phy_device *phydev)\n{\n\t \n\tbcm_phy_write_misc(phydev, AFE_RXCONFIG_1, 0x9b2f);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_TX_CONFIG, 0x431);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_VDCA_ICTRL_0, 0xa7da);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_HPF_TRIM_OTHERS, 0x00e3);\n\n\t \n\tphy_write(phydev, MII_BRCM_CORE_BASE1E, 0x0010);\n\n\t \n\tbcm_phy_write_misc(phydev, DSP_TAP10, 0x011b);\n\n\t \n\tbcm_phy_r_rc_cal_reset(phydev);\n\n\treturn 0;\n}\n\nstatic int bcm7xxx_28nm_a0_patch_afe_config_init(struct phy_device *phydev)\n{\n\t \n\tbcm_phy_write_misc(phydev, AFE_RXCONFIG_2, 0xd003);\n\n\t \n\tbcm_phy_write_misc(phydev, DSP_TAP10, 0x791b);\n\n\t \n\tbcm_phy_write_misc(phydev, AFE_HPF_TRIM_OTHERS, 0x10e3);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x21, 0x2, 0x87f6);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x22, 0x2, 0x017d);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x26, 0x2, 0x0015);\n\n\tbcm_phy_r_rc_cal_reset(phydev);\n\n\treturn 0;\n}\n\nstatic int bcm7xxx_28nm_config_init(struct phy_device *phydev)\n{\n\tu8 rev = PHY_BRCM_7XXX_REV(phydev->dev_flags);\n\tu8 patch = PHY_BRCM_7XXX_PATCH(phydev->dev_flags);\n\tu8 count;\n\tint ret = 0;\n\n\t \n\tif (rev == 0)\n\t\trev = phydev->phy_id & ~phydev->drv->phy_id_mask;\n\n\tpr_info_once(\"%s: %s PHY revision: 0x%02x, patch: %d\\n\",\n\t\t     phydev_name(phydev), phydev->drv->name, rev, patch);\n\n\t \n\tphy_read(phydev, MII_BMSR);\n\n\tswitch (rev) {\n\tcase 0xa0:\n\tcase 0xb0:\n\t\tret = bcm_phy_28nm_a0b0_afe_config_init(phydev);\n\t\tbreak;\n\tcase 0xd0:\n\t\tret = bcm7xxx_28nm_d0_afe_config_init(phydev);\n\t\tbreak;\n\tcase 0xe0:\n\tcase 0xf0:\n\t \n\tcase 0x10:\n\t\tret = bcm7xxx_28nm_e0_plus_afe_config_init(phydev);\n\t\tbreak;\n\tcase 0x01:\n\t\tret = bcm7xxx_28nm_a0_patch_afe_config_init(phydev);\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\tif (ret)\n\t\treturn ret;\n\n\tret =  bcm_phy_enable_jumbo(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\tret = bcm_phy_downshift_get(phydev, &count);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = bcm_phy_set_eee(phydev, count == DOWNSHIFT_DEV_DISABLE);\n\tif (ret)\n\t\treturn ret;\n\n\treturn bcm_phy_enable_apd(phydev, true);\n}\n\nstatic int bcm7xxx_28nm_resume(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tret = bcm7xxx_28nm_config_init(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\treturn genphy_config_aneg(phydev);\n}\n\nstatic int __phy_set_clr_bits(struct phy_device *dev, int location,\n\t\t\t      int set_mask, int clr_mask)\n{\n\tint v, ret;\n\n\tv = __phy_read(dev, location);\n\tif (v < 0)\n\t\treturn v;\n\n\tv &= ~clr_mask;\n\tv |= set_mask;\n\n\tret = __phy_write(dev, location, v);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn v;\n}\n\nstatic int phy_set_clr_bits(struct phy_device *dev, int location,\n\t\t\t    int set_mask, int clr_mask)\n{\n\tint ret;\n\n\tmutex_lock(&dev->mdio.bus->mdio_lock);\n\tret = __phy_set_clr_bits(dev, location, set_mask, clr_mask);\n\tmutex_unlock(&dev->mdio.bus->mdio_lock);\n\n\treturn ret;\n}\n\nstatic int bcm7xxx_28nm_ephy_01_afe_config_init(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tret = phy_set_clr_bits(phydev, MII_BCM7XXX_TEST,\n\t\t\t       MII_BCM7XXX_SHD_MODE_2, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_BIAS_TRIM, 0x3BE0);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\n\t \n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_ADDR_CTRL,\n\t\t\tMII_BCM7XXX_SHD_3_TL4);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\tret = phy_set_clr_bits(phydev, MII_BCM7XXX_SHD_2_CTRL_STAT,\n\t\t\t       MII_BCM7XXX_TL4_RST_MSK, 0);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\n\t \n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_ADDR_CTRL,\n\t\t\tMII_BCM7XXX_SHD_3_TL4);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\tret = phy_set_clr_bits(phydev, MII_BCM7XXX_SHD_2_CTRL_STAT,\n\t\t\t       0, MII_BCM7XXX_TL4_RST_MSK);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\nreset_shadow_mode:\n\t \n\tret = phy_set_clr_bits(phydev, MII_BCM7XXX_TEST, 0,\n\t\t\t       MII_BCM7XXX_SHD_MODE_2);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\n \nstatic int bcm7xxx_28nm_ephy_apd_enable(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tret = phy_set_clr_bits(phydev, MII_BRCM_FET_BRCMTEST,\n\t\t\t       MII_BRCM_FET_BT_SRE, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = phy_set_clr_bits(phydev, MII_BRCM_FET_SHDW_AUXSTAT2,\n\t\t\t       MII_BRCM_FET_SHDW_AS2_APDE, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = phy_set_clr_bits(phydev, MII_BRCM_FET_BRCMTEST, 0,\n\t\t\t       MII_BRCM_FET_BT_SRE);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int bcm7xxx_28nm_ephy_eee_enable(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tret = phy_set_clr_bits(phydev, MII_BCM7XXX_TEST,\n\t\t\t       MII_BCM7XXX_SHD_MODE_2, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_ADDR_CTRL,\n\t\t\tMII_BCM7XXX_SHD_3_AN_EEE_ADV);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_CTRL_STAT,\n\t\t\tMDIO_EEE_100TX);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\n\t \n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_ADDR_CTRL,\n\t\t\tMII_BCM7XXX_SHD_3_PCS_CTRL_2);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_CTRL_STAT,\n\t\t\tMII_BCM7XXX_PCS_CTRL_2_DEF);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_ADDR_CTRL,\n\t\t\tMII_BCM7XXX_SHD_3_EEE_THRESH);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_CTRL_STAT,\n\t\t\tMII_BCM7XXX_EEE_THRESH_DEF);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\n\t \n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_ADDR_CTRL,\n\t\t\tMII_BCM7XXX_SHD_3_AN_STAT);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\tret = phy_write(phydev, MII_BCM7XXX_SHD_2_CTRL_STAT,\n\t\t\t(MII_BCM7XXX_AN_NULL_MSG_EN | MII_BCM7XXX_AN_EEE_EN));\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\nreset_shadow_mode:\n\t \n\tret = phy_set_clr_bits(phydev, MII_BCM7XXX_TEST, 0,\n\t\t\t       MII_BCM7XXX_SHD_MODE_2);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tphy_write(phydev, MII_BMCR,\n\t\t  (BMCR_SPEED100 | BMCR_ANENABLE | BMCR_ANRESTART));\n\n\treturn 0;\n}\n\nstatic int bcm7xxx_28nm_ephy_config_init(struct phy_device *phydev)\n{\n\tu8 rev = phydev->phy_id & ~phydev->drv->phy_id_mask;\n\tint ret = 0;\n\n\tpr_info_once(\"%s: %s PHY revision: 0x%02x\\n\",\n\t\t     phydev_name(phydev), phydev->drv->name, rev);\n\n\t \n\tphy_read(phydev, MII_BMSR);\n\n\t \n\tif (rev == 0x01) {\n\t\tret = bcm7xxx_28nm_ephy_01_afe_config_init(phydev);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = bcm7xxx_28nm_ephy_eee_enable(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\treturn bcm7xxx_28nm_ephy_apd_enable(phydev);\n}\n\nstatic int bcm7xxx_16nm_ephy_afe_config(struct phy_device *phydev)\n{\n\tint tmp, rcalcode, rcalnewcodelp, rcalnewcode11, rcalnewcode11d2;\n\n\t \n\ttmp = genphy_soft_reset(phydev);\n\tif (tmp)\n\t\treturn tmp;\n\n\t \n\tbcm_phy_write_exp_sel(phydev, 0x0003, 0x0006);\n\t \n\tbcm_phy_write_exp_sel(phydev, 0x0003, 0x0000);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x0030, 0x0001, 0x0000);\n\tbcm_phy_write_misc(phydev, 0x0031, 0x0000, 0x044a);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x0033, 0x0002, 0x71a1);\n\t \n\tbcm_phy_write_misc(phydev, 0x0033, 0x0001, 0x8000);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x0031, 0x0001, 0x2f68);\n\tbcm_phy_write_misc(phydev, 0x0031, 0x0002, 0x0000);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x0030, 0x0003, 0xc036);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x0032, 0x0003, 0x0000);\n\t \n\tbcm_phy_write_misc(phydev, 0x0033, 0x0000, 0x0002);\n\t \n\tbcm_phy_write_misc(phydev, 0x0030, 0x0002, 0x01c0);\n\t \n\tbcm_phy_write_misc(phydev, 0x0030, 0x0001, 0x0001);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x0038, 0x0000, 0x0010);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x0039, 0x0003, 0x0038);\n\tbcm_phy_write_misc(phydev, 0x0039, 0x0003, 0x003b);\n\tudelay(2);\n\tbcm_phy_write_misc(phydev, 0x0039, 0x0003, 0x003f);\n\tmdelay(5);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x0039, 0x0001, 0x1c82);\n\t \n\tbcm_phy_write_misc(phydev, 0x0039, 0x0001, 0x9e82);\n\tudelay(2);\n\t \n\tbcm_phy_write_misc(phydev, 0x0039, 0x0001, 0x9f82);\n\tudelay(100);\n\t \n\tbcm_phy_write_misc(phydev, 0x0039, 0x0001, 0x9e86);\n\tudelay(2);\n\t \n\tbcm_phy_write_misc(phydev, 0x0039, 0x0001, 0x9f86);\n\tudelay(100);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x0038, 0x0001, 0xe7ea);\n\t \n\tbcm_phy_write_misc(phydev, 0x0038, 0x0002, 0xede0);\n\n\t \n\ttmp = bcm_phy_read_exp_sel(phydev, 0x00a9);\n\t \n\trcalcode = (tmp & 0x7e) / 2;\n\t \n\trcalnewcodelp = rcalcode + 16;\n\t \n\trcalnewcode11 = rcalcode + 10;\n\t \n\tif (rcalnewcodelp > 0x3f)\n\t\trcalnewcodelp = 0x3f;\n\tif (rcalnewcode11 > 0x3f)\n\t\trcalnewcode11 = 0x3f;\n\t \n\ttmp = 0x00f8 + rcalnewcodelp * 256;\n\t \n\tbcm_phy_write_misc(phydev, 0x0039, 0x0003, tmp);\n\t \n\tbcm_phy_write_misc(phydev, 0x0038, 0x0001, 0xe7e4);\n\t \n\tbcm_phy_write_misc(phydev, 0x003b, 0x0000, 0x8002);\n\t \n\tbcm_phy_write_misc(phydev, 0x003c, 0x0003, 0xf882);\n\t \n\tbcm_phy_write_misc(phydev, 0x003d, 0x0000, 0x3201);\n\t \n\tbcm_phy_write_misc(phydev, 0x003a, 0x0002, 0x0c00);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x003a, 0x0001, 0x0020);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x003b, 0x0002, 0x0000);\n\tbcm_phy_write_misc(phydev, 0x003b, 0x0003, 0x0000);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x003a, 0x0003, 0x0800);\n\tudelay(2);\n\n\t \n\tbcm_phy_write_misc(phydev, 0x003a, 0x0001, 0x0000);\n\n\t \n\trcalnewcode11d2 = (rcalnewcode11 & 0xfffe) / 2;\n\ttmp = bcm_phy_read_misc(phydev, 0x003d, 0x0001);\n\t \n\ttmp &= ~0xfe0;\n\t \n\ttmp |= 0x0020 | (rcalnewcode11d2 * 64);\n\tbcm_phy_write_misc(phydev, 0x003d, 0x0001, tmp);\n\tbcm_phy_write_misc(phydev, 0x003d, 0x0002, tmp);\n\n\ttmp = bcm_phy_read_misc(phydev, 0x003d, 0x0000);\n\t \n\ttmp &= ~0x3000;\n\ttmp |= 0x3000;\n\tbcm_phy_write_misc(phydev, 0x003d, 0x0000, tmp);\n\n\treturn 0;\n}\n\nstatic int bcm7xxx_16nm_ephy_config_init(struct phy_device *phydev)\n{\n\tint ret, val;\n\n\tret = bcm7xxx_16nm_ephy_afe_config(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\tret = bcm_phy_set_eee(phydev, true);\n\tif (ret)\n\t\treturn ret;\n\n\tret = bcm_phy_read_shadow(phydev, BCM54XX_SHD_SCR3);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tval = ret;\n\n\t \n\tval &= ~BCM54XX_SHD_SCR3_DLLAPD_DIS;\n\tval |= BIT(8);\n\n\tret = bcm_phy_write_shadow(phydev, BCM54XX_SHD_SCR3, val);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn bcm_phy_enable_apd(phydev, true);\n}\n\nstatic int bcm7xxx_16nm_ephy_resume(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tret = bcm7xxx_16nm_ephy_config_init(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\treturn genphy_config_aneg(phydev);\n}\n\n#define MII_BCM7XXX_REG_INVALID\t0xff\n\nstatic u8 bcm7xxx_28nm_ephy_regnum_to_shd(u16 regnum)\n{\n\tswitch (regnum) {\n\tcase MDIO_CTRL1:\n\t\treturn MII_BCM7XXX_SHD_3_PCS_CTRL;\n\tcase MDIO_STAT1:\n\t\treturn MII_BCM7XXX_SHD_3_PCS_STATUS;\n\tcase MDIO_PCS_EEE_ABLE:\n\t\treturn MII_BCM7XXX_SHD_3_EEE_CAP;\n\tcase MDIO_AN_EEE_ADV:\n\t\treturn MII_BCM7XXX_SHD_3_AN_EEE_ADV;\n\tcase MDIO_AN_EEE_LPABLE:\n\t\treturn MII_BCM7XXX_SHD_3_EEE_LP;\n\tcase MDIO_PCS_EEE_WK_ERR:\n\t\treturn MII_BCM7XXX_SHD_3_EEE_WK_ERR;\n\tdefault:\n\t\treturn MII_BCM7XXX_REG_INVALID;\n\t}\n}\n\nstatic bool bcm7xxx_28nm_ephy_dev_valid(int devnum)\n{\n\treturn devnum == MDIO_MMD_AN || devnum == MDIO_MMD_PCS;\n}\n\nstatic int bcm7xxx_28nm_ephy_read_mmd(struct phy_device *phydev,\n\t\t\t\t      int devnum, u16 regnum)\n{\n\tu8 shd = bcm7xxx_28nm_ephy_regnum_to_shd(regnum);\n\tint ret;\n\n\tif (!bcm7xxx_28nm_ephy_dev_valid(devnum) ||\n\t    shd == MII_BCM7XXX_REG_INVALID)\n\t\treturn -EOPNOTSUPP;\n\n\t \n\tret = __phy_set_clr_bits(phydev, MII_BCM7XXX_TEST,\n\t\t\t\t MII_BCM7XXX_SHD_MODE_2, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = __phy_write(phydev, MII_BCM7XXX_SHD_2_ADDR_CTRL, shd);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\n\tret = __phy_read(phydev, MII_BCM7XXX_SHD_2_CTRL_STAT);\n\nreset_shadow_mode:\n\t \n\t__phy_set_clr_bits(phydev, MII_BCM7XXX_TEST, 0,\n\t\t\t   MII_BCM7XXX_SHD_MODE_2);\n\treturn ret;\n}\n\nstatic int bcm7xxx_28nm_ephy_write_mmd(struct phy_device *phydev,\n\t\t\t\t       int devnum, u16 regnum, u16 val)\n{\n\tu8 shd = bcm7xxx_28nm_ephy_regnum_to_shd(regnum);\n\tint ret;\n\n\tif (!bcm7xxx_28nm_ephy_dev_valid(devnum) ||\n\t    shd == MII_BCM7XXX_REG_INVALID)\n\t\treturn -EOPNOTSUPP;\n\n\t \n\tret = __phy_set_clr_bits(phydev, MII_BCM7XXX_TEST,\n\t\t\t\t MII_BCM7XXX_SHD_MODE_2, 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = __phy_write(phydev, MII_BCM7XXX_SHD_2_ADDR_CTRL, shd);\n\tif (ret < 0)\n\t\tgoto reset_shadow_mode;\n\n\t \n\t__phy_write(phydev, MII_BCM7XXX_SHD_2_CTRL_STAT, val);\n\nreset_shadow_mode:\n\t \n\treturn __phy_set_clr_bits(phydev, MII_BCM7XXX_TEST, 0,\n\t\t\t\t  MII_BCM7XXX_SHD_MODE_2);\n}\n\nstatic int bcm7xxx_28nm_ephy_resume(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tret = bcm7xxx_28nm_ephy_config_init(phydev);\n\tif (ret)\n\t\treturn ret;\n\n\treturn genphy_config_aneg(phydev);\n}\n\nstatic int bcm7xxx_config_init(struct phy_device *phydev)\n{\n\tint ret;\n\n\t \n\tphy_write(phydev, MII_BCM7XXX_AUX_MODE, MII_BCM7XXX_64CLK_MDIO);\n\tphy_read(phydev, MII_BCM7XXX_AUX_MODE);\n\n\t \n\tret = phy_set_clr_bits(phydev, MII_BCM7XXX_TEST,\n\t\t\tMII_BCM7XXX_SHD_MODE_2, MII_BCM7XXX_SHD_MODE_2);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tphy_write(phydev, MII_BCM7XXX_100TX_DISC, 0x0F00);\n\tudelay(10);\n\n\t \n\tphy_write(phydev, MII_BCM7XXX_100TX_DISC, 0x0C00);\n\n\tphy_write(phydev, MII_BCM7XXX_100TX_FALSE_CAR, 0x7555);\n\n\t \n\tret = phy_set_clr_bits(phydev, MII_BCM7XXX_TEST, 0, MII_BCM7XXX_SHD_MODE_2);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\n \nstatic int bcm7xxx_suspend(struct phy_device *phydev)\n{\n\tint ret;\n\tstatic const struct bcm7xxx_regs {\n\t\tint reg;\n\t\tu16 value;\n\t} bcm7xxx_suspend_cfg[] = {\n\t\t{ MII_BCM7XXX_TEST, 0x008b },\n\t\t{ MII_BCM7XXX_100TX_AUX_CTL, 0x01c0 },\n\t\t{ MII_BCM7XXX_100TX_DISC, 0x7000 },\n\t\t{ MII_BCM7XXX_TEST, 0x000f },\n\t\t{ MII_BCM7XXX_100TX_AUX_CTL, 0x20d0 },\n\t\t{ MII_BCM7XXX_TEST, 0x000b },\n\t};\n\tunsigned int i;\n\n\tfor (i = 0; i < ARRAY_SIZE(bcm7xxx_suspend_cfg); i++) {\n\t\tret = phy_write(phydev,\n\t\t\t\tbcm7xxx_suspend_cfg[i].reg,\n\t\t\t\tbcm7xxx_suspend_cfg[i].value);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int bcm7xxx_28nm_get_tunable(struct phy_device *phydev,\n\t\t\t\t    struct ethtool_tunable *tuna,\n\t\t\t\t    void *data)\n{\n\tswitch (tuna->id) {\n\tcase ETHTOOL_PHY_DOWNSHIFT:\n\t\treturn bcm_phy_downshift_get(phydev, (u8 *)data);\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int bcm7xxx_28nm_set_tunable(struct phy_device *phydev,\n\t\t\t\t    struct ethtool_tunable *tuna,\n\t\t\t\t    const void *data)\n{\n\tu8 count = *(u8 *)data;\n\tint ret;\n\n\tswitch (tuna->id) {\n\tcase ETHTOOL_PHY_DOWNSHIFT:\n\t\tret = bcm_phy_downshift_set(phydev, count);\n\t\tbreak;\n\tdefault:\n\t\treturn -EOPNOTSUPP;\n\t}\n\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = bcm_phy_set_eee(phydev, count == DOWNSHIFT_DEV_DISABLE);\n\tif (ret)\n\t\treturn ret;\n\n\treturn genphy_restart_aneg(phydev);\n}\n\nstatic void bcm7xxx_28nm_get_phy_stats(struct phy_device *phydev,\n\t\t\t\t       struct ethtool_stats *stats, u64 *data)\n{\n\tstruct bcm7xxx_phy_priv *priv = phydev->priv;\n\n\tbcm_phy_get_stats(phydev, priv->stats, stats, data);\n}\n\nstatic int bcm7xxx_28nm_probe(struct phy_device *phydev)\n{\n\tstruct bcm7xxx_phy_priv *priv;\n\tstruct clk *clk;\n\tint ret = 0;\n\n\tpriv = devm_kzalloc(&phydev->mdio.dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tphydev->priv = priv;\n\n\tpriv->stats = devm_kcalloc(&phydev->mdio.dev,\n\t\t\t\t   bcm_phy_get_sset_count(phydev), sizeof(u64),\n\t\t\t\t   GFP_KERNEL);\n\tif (!priv->stats)\n\t\treturn -ENOMEM;\n\n\tclk = devm_clk_get_optional_enabled(&phydev->mdio.dev, NULL);\n\tif (IS_ERR(clk))\n\t\treturn PTR_ERR(clk);\n\n\t \n\tphy_read(phydev, MII_BMSR);\n\n\treturn ret;\n}\n\n#define BCM7XXX_28NM_GPHY(_oui, _name)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\t.phy_id\t\t= (_oui),\t\t\t\t\t\\\n\t.phy_id_mask\t= 0xfffffff0,\t\t\t\t\t\\\n\t.name\t\t= _name,\t\t\t\t\t\\\n\t \t\t\t\t\t\t\\\n\t.flags\t\t= PHY_IS_INTERNAL,\t\t\t\t\\\n\t.config_init\t= bcm7xxx_28nm_config_init,\t\t\t\\\n\t.resume\t\t= bcm7xxx_28nm_resume,\t\t\t\t\\\n\t.get_tunable\t= bcm7xxx_28nm_get_tunable,\t\t\t\\\n\t.set_tunable\t= bcm7xxx_28nm_set_tunable,\t\t\t\\\n\t.get_sset_count\t= bcm_phy_get_sset_count,\t\t\t\\\n\t.get_strings\t= bcm_phy_get_strings,\t\t\t\t\\\n\t.get_stats\t= bcm7xxx_28nm_get_phy_stats,\t\t\t\\\n\t.probe\t\t= bcm7xxx_28nm_probe,\t\t\t\t\\\n}\n\n#define BCM7XXX_28NM_EPHY(_oui, _name)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\t.phy_id\t\t= (_oui),\t\t\t\t\t\\\n\t.phy_id_mask\t= 0xfffffff0,\t\t\t\t\t\\\n\t.name\t\t= _name,\t\t\t\t\t\\\n\t \t\t\t\t\t\\\n\t.flags\t\t= PHY_IS_INTERNAL,\t\t\t\t\\\n\t.config_init\t= bcm7xxx_28nm_ephy_config_init,\t\t\\\n\t.resume\t\t= bcm7xxx_28nm_ephy_resume,\t\t\t\\\n\t.get_sset_count\t= bcm_phy_get_sset_count,\t\t\t\\\n\t.get_strings\t= bcm_phy_get_strings,\t\t\t\t\\\n\t.get_stats\t= bcm7xxx_28nm_get_phy_stats,\t\t\t\\\n\t.probe\t\t= bcm7xxx_28nm_probe,\t\t\t\t\\\n\t.read_mmd\t= bcm7xxx_28nm_ephy_read_mmd,\t\t\t\\\n\t.write_mmd\t= bcm7xxx_28nm_ephy_write_mmd,\t\t\t\\\n}\n\n#define BCM7XXX_40NM_EPHY(_oui, _name)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\t.phy_id         = (_oui),\t\t\t\t\t\\\n\t.phy_id_mask    = 0xfffffff0,\t\t\t\t\t\\\n\t.name           = _name,\t\t\t\t\t\\\n\t \t\t\t\t\t\\\n\t.flags          = PHY_IS_INTERNAL,\t\t\t\t\\\n\t.soft_reset\t= genphy_soft_reset,\t\t\t\t\\\n\t.config_init    = bcm7xxx_config_init,\t\t\t\t\\\n\t.suspend        = bcm7xxx_suspend,\t\t\t\t\\\n\t.resume         = bcm7xxx_config_init,\t\t\t\t\\\n}\n\n#define BCM7XXX_16NM_EPHY(_oui, _name)\t\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\t.phy_id\t\t= (_oui),\t\t\t\t\t\\\n\t.phy_id_mask\t= 0xfffffff0,\t\t\t\t\t\\\n\t.name\t\t= _name,\t\t\t\t\t\\\n\t \t\t\t\t\t\\\n\t.flags\t\t= PHY_IS_INTERNAL,\t\t\t\t\\\n\t.get_sset_count\t= bcm_phy_get_sset_count,\t\t\t\\\n\t.get_strings\t= bcm_phy_get_strings,\t\t\t\t\\\n\t.get_stats\t= bcm7xxx_28nm_get_phy_stats,\t\t\t\\\n\t.probe\t\t= bcm7xxx_28nm_probe,\t\t\t\t\\\n\t.config_init\t= bcm7xxx_16nm_ephy_config_init,\t\t\\\n\t.config_aneg\t= genphy_config_aneg,\t\t\t\t\\\n\t.read_status\t= genphy_read_status,\t\t\t\t\\\n\t.resume\t\t= bcm7xxx_16nm_ephy_resume,\t\t\t\\\n}\n\nstatic struct phy_driver bcm7xxx_driver[] = {\n\tBCM7XXX_28NM_EPHY(PHY_ID_BCM72113, \"Broadcom BCM72113\"),\n\tBCM7XXX_28NM_EPHY(PHY_ID_BCM72116, \"Broadcom BCM72116\"),\n\tBCM7XXX_16NM_EPHY(PHY_ID_BCM72165, \"Broadcom BCM72165\"),\n\tBCM7XXX_28NM_GPHY(PHY_ID_BCM7250, \"Broadcom BCM7250\"),\n\tBCM7XXX_28NM_EPHY(PHY_ID_BCM7255, \"Broadcom BCM7255\"),\n\tBCM7XXX_28NM_EPHY(PHY_ID_BCM7260, \"Broadcom BCM7260\"),\n\tBCM7XXX_28NM_EPHY(PHY_ID_BCM7268, \"Broadcom BCM7268\"),\n\tBCM7XXX_28NM_EPHY(PHY_ID_BCM7271, \"Broadcom BCM7271\"),\n\tBCM7XXX_28NM_GPHY(PHY_ID_BCM7278, \"Broadcom BCM7278\"),\n\tBCM7XXX_28NM_GPHY(PHY_ID_BCM7364, \"Broadcom BCM7364\"),\n\tBCM7XXX_28NM_GPHY(PHY_ID_BCM7366, \"Broadcom BCM7366\"),\n\tBCM7XXX_16NM_EPHY(PHY_ID_BCM74165, \"Broadcom BCM74165\"),\n\tBCM7XXX_28NM_GPHY(PHY_ID_BCM74371, \"Broadcom BCM74371\"),\n\tBCM7XXX_28NM_GPHY(PHY_ID_BCM7439, \"Broadcom BCM7439\"),\n\tBCM7XXX_28NM_GPHY(PHY_ID_BCM7439_2, \"Broadcom BCM7439 (2)\"),\n\tBCM7XXX_28NM_GPHY(PHY_ID_BCM7445, \"Broadcom BCM7445\"),\n\tBCM7XXX_40NM_EPHY(PHY_ID_BCM7346, \"Broadcom BCM7346\"),\n\tBCM7XXX_40NM_EPHY(PHY_ID_BCM7362, \"Broadcom BCM7362\"),\n\tBCM7XXX_40NM_EPHY(PHY_ID_BCM7425, \"Broadcom BCM7425\"),\n\tBCM7XXX_40NM_EPHY(PHY_ID_BCM7429, \"Broadcom BCM7429\"),\n\tBCM7XXX_40NM_EPHY(PHY_ID_BCM7435, \"Broadcom BCM7435\"),\n\tBCM7XXX_16NM_EPHY(PHY_ID_BCM7712, \"Broadcom BCM7712\"),\n};\n\nstatic struct mdio_device_id __maybe_unused bcm7xxx_tbl[] = {\n\t{ PHY_ID_BCM72113, 0xfffffff0 },\n\t{ PHY_ID_BCM72116, 0xfffffff0, },\n\t{ PHY_ID_BCM72165, 0xfffffff0, },\n\t{ PHY_ID_BCM7250, 0xfffffff0, },\n\t{ PHY_ID_BCM7255, 0xfffffff0, },\n\t{ PHY_ID_BCM7260, 0xfffffff0, },\n\t{ PHY_ID_BCM7268, 0xfffffff0, },\n\t{ PHY_ID_BCM7271, 0xfffffff0, },\n\t{ PHY_ID_BCM7278, 0xfffffff0, },\n\t{ PHY_ID_BCM7364, 0xfffffff0, },\n\t{ PHY_ID_BCM7366, 0xfffffff0, },\n\t{ PHY_ID_BCM7346, 0xfffffff0, },\n\t{ PHY_ID_BCM7362, 0xfffffff0, },\n\t{ PHY_ID_BCM7425, 0xfffffff0, },\n\t{ PHY_ID_BCM7429, 0xfffffff0, },\n\t{ PHY_ID_BCM74371, 0xfffffff0, },\n\t{ PHY_ID_BCM7439, 0xfffffff0, },\n\t{ PHY_ID_BCM7435, 0xfffffff0, },\n\t{ PHY_ID_BCM7445, 0xfffffff0, },\n\t{ PHY_ID_BCM7712, 0xfffffff0, },\n\t{ }\n};\n\nmodule_phy_driver(bcm7xxx_driver);\n\nMODULE_DEVICE_TABLE(mdio, bcm7xxx_tbl);\n\nMODULE_DESCRIPTION(\"Broadcom BCM7xxx internal PHY driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Broadcom Corporation\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}