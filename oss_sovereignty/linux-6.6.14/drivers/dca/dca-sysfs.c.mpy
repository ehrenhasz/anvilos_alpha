{
  "module_name": "dca-sysfs.c",
  "hash_id": "18091a862b0bd2db01b5fdc7e0099898f900dbbd198a74773789336c5beba79d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/dca/dca-sysfs.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/spinlock.h>\n#include <linux/device.h>\n#include <linux/idr.h>\n#include <linux/kdev_t.h>\n#include <linux/err.h>\n#include <linux/dca.h>\n#include <linux/gfp.h>\n#include <linux/export.h>\n\nstatic struct class *dca_class;\nstatic struct idr dca_idr;\nstatic spinlock_t dca_idr_lock;\n\nint dca_sysfs_add_req(struct dca_provider *dca, struct device *dev, int slot)\n{\n\tstruct device *cd;\n\tstatic int req_count;\n\n\tcd = device_create(dca_class, dca->cd, MKDEV(0, slot + 1), NULL,\n\t\t\t   \"requester%d\", req_count++);\n\treturn PTR_ERR_OR_ZERO(cd);\n}\n\nvoid dca_sysfs_remove_req(struct dca_provider *dca, int slot)\n{\n\tdevice_destroy(dca_class, MKDEV(0, slot + 1));\n}\n\nint dca_sysfs_add_provider(struct dca_provider *dca, struct device *dev)\n{\n\tstruct device *cd;\n\tint ret;\n\n\tidr_preload(GFP_KERNEL);\n\tspin_lock(&dca_idr_lock);\n\n\tret = idr_alloc(&dca_idr, dca, 0, 0, GFP_NOWAIT);\n\tif (ret >= 0)\n\t\tdca->id = ret;\n\n\tspin_unlock(&dca_idr_lock);\n\tidr_preload_end();\n\tif (ret < 0)\n\t\treturn ret;\n\n\tcd = device_create(dca_class, dev, MKDEV(0, 0), NULL, \"dca%d\", dca->id);\n\tif (IS_ERR(cd)) {\n\t\tspin_lock(&dca_idr_lock);\n\t\tidr_remove(&dca_idr, dca->id);\n\t\tspin_unlock(&dca_idr_lock);\n\t\treturn PTR_ERR(cd);\n\t}\n\tdca->cd = cd;\n\treturn 0;\n}\n\nvoid dca_sysfs_remove_provider(struct dca_provider *dca)\n{\n\tdevice_unregister(dca->cd);\n\tdca->cd = NULL;\n\tspin_lock(&dca_idr_lock);\n\tidr_remove(&dca_idr, dca->id);\n\tspin_unlock(&dca_idr_lock);\n}\n\nint __init dca_sysfs_init(void)\n{\n\tidr_init(&dca_idr);\n\tspin_lock_init(&dca_idr_lock);\n\n\tdca_class = class_create(\"dca\");\n\tif (IS_ERR(dca_class)) {\n\t\tidr_destroy(&dca_idr);\n\t\treturn PTR_ERR(dca_class);\n\t}\n\treturn 0;\n}\n\nvoid __exit dca_sysfs_exit(void)\n{\n\tclass_destroy(dca_class);\n\tidr_destroy(&dca_idr);\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}