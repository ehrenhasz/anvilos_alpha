{
  "module_name": "sprd_hwspinlock.c",
  "hash_id": "8f7481387f8fd9219b4dcb871fe5d3aa44f3c48aa6ff1f37e1d98c35ea0eaaeb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwspinlock/sprd_hwspinlock.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/hwspinlock.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n\n#include \"hwspinlock_internal.h\"\n\n \n#define HWSPINLOCK_RECCTRL\t\t0x4\n#define HWSPINLOCK_MASTERID(_X_)\t(0x80 + 0x4 * (_X_))\n#define HWSPINLOCK_TOKEN(_X_)\t\t(0x800 + 0x4 * (_X_))\n\n \n#define HWSPINLOCK_NOTTAKEN\t\t0x55aa10c5\n \n#define HWSPINLOCK_USER_BITS\t\t0x1\n\n \n#define SPRD_HWLOCKS_NUM\t\t32\n\nstruct sprd_hwspinlock_dev {\n\tvoid __iomem *base;\n\tstruct clk *clk;\n\tstruct hwspinlock_device bank;\n};\n\n \nstatic int sprd_hwspinlock_trylock(struct hwspinlock *lock)\n{\n\tstruct sprd_hwspinlock_dev *sprd_hwlock =\n\t\tdev_get_drvdata(lock->bank->dev);\n\tvoid __iomem *addr = lock->priv;\n\tint user_id, lock_id;\n\n\tif (!readl(addr))\n\t\treturn 1;\n\n\tlock_id = hwlock_to_id(lock);\n\t \n\tuser_id = readl(sprd_hwlock->base + HWSPINLOCK_MASTERID(lock_id));\n\tdev_warn(sprd_hwlock->bank.dev,\n\t\t \"hwspinlock [%d] lock failed and master/user id = %d!\\n\",\n\t\t lock_id, user_id);\n\treturn 0;\n}\n\n \nstatic void sprd_hwspinlock_unlock(struct hwspinlock *lock)\n{\n\tvoid __iomem *lock_addr = lock->priv;\n\n\twritel(HWSPINLOCK_NOTTAKEN, lock_addr);\n}\n\n \nstatic void sprd_hwspinlock_relax(struct hwspinlock *lock)\n{\n\tndelay(10);\n}\n\nstatic const struct hwspinlock_ops sprd_hwspinlock_ops = {\n\t.trylock = sprd_hwspinlock_trylock,\n\t.unlock = sprd_hwspinlock_unlock,\n\t.relax = sprd_hwspinlock_relax,\n};\n\nstatic void sprd_hwspinlock_disable(void *data)\n{\n\tstruct sprd_hwspinlock_dev *sprd_hwlock = data;\n\n\tclk_disable_unprepare(sprd_hwlock->clk);\n}\n\nstatic int sprd_hwspinlock_probe(struct platform_device *pdev)\n{\n\tstruct sprd_hwspinlock_dev *sprd_hwlock;\n\tstruct hwspinlock *lock;\n\tint i, ret;\n\n\tif (!pdev->dev.of_node)\n\t\treturn -ENODEV;\n\n\tsprd_hwlock = devm_kzalloc(&pdev->dev,\n\t\t\t\t   struct_size(sprd_hwlock, bank.lock, SPRD_HWLOCKS_NUM),\n\t\t\t\t   GFP_KERNEL);\n\tif (!sprd_hwlock)\n\t\treturn -ENOMEM;\n\n\tsprd_hwlock->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(sprd_hwlock->base))\n\t\treturn PTR_ERR(sprd_hwlock->base);\n\n\tsprd_hwlock->clk = devm_clk_get(&pdev->dev, \"enable\");\n\tif (IS_ERR(sprd_hwlock->clk)) {\n\t\tdev_err(&pdev->dev, \"get hwspinlock clock failed!\\n\");\n\t\treturn PTR_ERR(sprd_hwlock->clk);\n\t}\n\n\tret = clk_prepare_enable(sprd_hwlock->clk);\n\tif (ret)\n\t\treturn ret;\n\n\tret = devm_add_action_or_reset(&pdev->dev, sprd_hwspinlock_disable,\n\t\t\t\t       sprd_hwlock);\n\tif (ret) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"Failed to add hwspinlock disable action\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\twritel(HWSPINLOCK_USER_BITS, sprd_hwlock->base + HWSPINLOCK_RECCTRL);\n\n\tfor (i = 0; i < SPRD_HWLOCKS_NUM; i++) {\n\t\tlock = &sprd_hwlock->bank.lock[i];\n\t\tlock->priv = sprd_hwlock->base + HWSPINLOCK_TOKEN(i);\n\t}\n\n\tplatform_set_drvdata(pdev, sprd_hwlock);\n\n\treturn devm_hwspin_lock_register(&pdev->dev, &sprd_hwlock->bank,\n\t\t\t\t\t &sprd_hwspinlock_ops, 0,\n\t\t\t\t\t SPRD_HWLOCKS_NUM);\n}\n\nstatic const struct of_device_id sprd_hwspinlock_of_match[] = {\n\t{ .compatible = \"sprd,hwspinlock-r3p0\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, sprd_hwspinlock_of_match);\n\nstatic struct platform_driver sprd_hwspinlock_driver = {\n\t.probe = sprd_hwspinlock_probe,\n\t.driver = {\n\t\t.name = \"sprd_hwspinlock\",\n\t\t.of_match_table = sprd_hwspinlock_of_match,\n\t},\n};\nmodule_platform_driver(sprd_hwspinlock_driver);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Hardware spinlock driver for Spreadtrum\");\nMODULE_AUTHOR(\"Baolin Wang <baolin.wang@spreadtrum.com>\");\nMODULE_AUTHOR(\"Lanqing Liu <lanqing.liu@spreadtrum.com>\");\nMODULE_AUTHOR(\"Long Cheng <aiden.cheng@spreadtrum.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}