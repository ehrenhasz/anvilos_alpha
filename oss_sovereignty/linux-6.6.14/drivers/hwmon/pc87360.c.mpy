{
  "module_name": "pc87360.c",
  "hash_id": "88879668e35d667084f9b23b2790b872370518f1ce498dd070c5f0f271b66439",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/pc87360.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/jiffies.h>\n#include <linux/platform_device.h>\n#include <linux/hwmon.h>\n#include <linux/hwmon-sysfs.h>\n#include <linux/hwmon-vid.h>\n#include <linux/err.h>\n#include <linux/mutex.h>\n#include <linux/acpi.h>\n#include <linux/io.h>\n\n#define DRIVER_NAME \"pc87360\"\n\n \n#define CHAN_CNVRTD\t0x80\t \n#define CHAN_ENA\t0x01\t \n#define CHAN_ALM_ENA\t0x10\t \n#define CHAN_READY\t(CHAN_ENA|CHAN_CNVRTD)  \n\n#define TEMP_OTS_OE\t0x20\t \n#define VIN_RW1C_MASK\t(CHAN_READY|CHAN_ALM_MAX|CHAN_ALM_MIN)    \n#define TEMP_RW1C_MASK\t(VIN_RW1C_MASK|TEMP_ALM_CRIT|TEMP_FAULT)  \n\nstatic u8 devid;\nstatic struct platform_device *pdev;\nstatic unsigned short extra_isa[3];\nstatic u8 confreg[4];\n\nstatic int init = 1;\nmodule_param(init, int, 0);\nMODULE_PARM_DESC(init,\n\"Chip initialization level:\\n\"\n\" 0: None\\n\"\n\"*1: Forcibly enable internal voltage and temperature channels, except in9\\n\"\n\" 2: Forcibly enable all voltage and temperature channels, except in9\\n\"\n\" 3: Forcibly enable all voltage and temperature channels, including in9\");\n\nstatic unsigned short force_id;\nmodule_param(force_id, ushort, 0);\nMODULE_PARM_DESC(force_id, \"Override the detected device ID\");\n\n \n\n#define DEV\t0x07\t \n#define DEVID\t0x20\t \n#define ACT\t0x30\t \n#define BASE\t0x60\t \n\n#define FSCM\t0x09\t \n#define VLM\t0x0d\t \n#define TMS\t0x0e\t \n#define LDNI_MAX 3\nstatic const u8 logdev[LDNI_MAX] = { FSCM, VLM, TMS };\n\n#define LD_FAN\t\t0\n#define LD_IN\t\t1\n#define LD_TEMP\t\t2\n\nstatic inline void superio_outb(int sioaddr, int reg, int val)\n{\n\toutb(reg, sioaddr);\n\toutb(val, sioaddr + 1);\n}\n\nstatic inline int superio_inb(int sioaddr, int reg)\n{\n\toutb(reg, sioaddr);\n\treturn inb(sioaddr + 1);\n}\n\nstatic inline void superio_exit(int sioaddr)\n{\n\toutb(0x02, sioaddr);\n\toutb(0x02, sioaddr + 1);\n}\n\n \n\n#define PC87360_EXTENT\t\t0x10\n#define PC87365_REG_BANK\t0x09\n#define NO_BANK\t\t\t0xff\n\n \n\n \n#define PC87360_REG_PRESCALE(nr)\t(0x00 + 2 * (nr))\n#define PC87360_REG_PWM(nr)\t\t(0x01 + 2 * (nr))\n#define PC87360_REG_FAN_MIN(nr)\t\t(0x06 + 3 * (nr))\n#define PC87360_REG_FAN(nr)\t\t(0x07 + 3 * (nr))\n#define PC87360_REG_FAN_STATUS(nr)\t(0x08 + 3 * (nr))\n\n#define FAN_FROM_REG(val, div)\t\t((val) == 0 ? 0 : \\\n\t\t\t\t\t 480000 / ((val) * (div)))\n#define FAN_TO_REG(val, div)\t\t((val) <= 100 ? 0 : \\\n\t\t\t\t\t 480000 / ((val) * (div)))\n#define FAN_DIV_FROM_REG(val)\t\t(1 << (((val) >> 5) & 0x03))\n#define FAN_STATUS_FROM_REG(val)\t((val) & 0x07)\n\n#define FAN_CONFIG_MONITOR(val, nr)\t(((val) >> (2 + (nr) * 3)) & 1)\n#define FAN_CONFIG_CONTROL(val, nr)\t(((val) >> (3 + (nr) * 3)) & 1)\n#define FAN_CONFIG_INVERT(val, nr)\t(((val) >> (4 + (nr) * 3)) & 1)\n\n#define PWM_FROM_REG(val, inv)\t\t((inv) ? 255 - (val) : (val))\nstatic inline u8 PWM_TO_REG(int val, int inv)\n{\n\tif (inv)\n\t\tval = 255 - val;\n\tif (val < 0)\n\t\treturn 0;\n\tif (val > 255)\n\t\treturn 255;\n\treturn val;\n}\n\n \n\n#define PC87365_REG_IN_CONVRATE\t\t0x07\n#define PC87365_REG_IN_CONFIG\t\t0x08\n#define PC87365_REG_IN\t\t\t0x0B\n#define PC87365_REG_IN_MIN\t\t0x0D\n#define PC87365_REG_IN_MAX\t\t0x0C\n#define PC87365_REG_IN_STATUS\t\t0x0A\n#define PC87365_REG_IN_ALARMS1\t\t0x00\n#define PC87365_REG_IN_ALARMS2\t\t0x01\n#define PC87365_REG_VID\t\t\t0x06\n\n#define IN_FROM_REG(val, ref)\t\t(((val) * (ref) + 128) / 256)\n#define IN_TO_REG(val, ref)\t\t((val) < 0 ? 0 : \\\n\t\t\t\t\t (val) * 256 >= (ref) * 255 ? 255 : \\\n\t\t\t\t\t ((val) * 256 + (ref) / 2) / (ref))\n\n \n\n#define PC87365_REG_TEMP_CONFIG\t\t0x08\n#define PC87365_REG_TEMP\t\t0x0B\n#define PC87365_REG_TEMP_MIN\t\t0x0D\n#define PC87365_REG_TEMP_MAX\t\t0x0C\n#define PC87365_REG_TEMP_CRIT\t\t0x0E\n#define PC87365_REG_TEMP_STATUS\t\t0x0A\n#define PC87365_REG_TEMP_ALARMS\t\t0x00\n\n#define TEMP_FROM_REG(val)\t\t((val) * 1000)\n#define TEMP_TO_REG(val)\t\t((val) < -55000 ? -55 : \\\n\t\t\t\t\t (val) > 127000 ? 127 : \\\n\t\t\t\t\t (val) < 0 ? ((val) - 500) / 1000 : \\\n\t\t\t\t\t ((val) + 500) / 1000)\n\n \n\nstruct pc87360_data {\n\tconst char *name;\n\tstruct device *hwmon_dev;\n\tstruct mutex lock;\n\tstruct mutex update_lock;\n\tbool valid;\t\t \n\tunsigned long last_updated;\t \n\n\tint address[3];\n\n\tu8 fannr, innr, tempnr;\n\n\tu8 fan[3];\t\t \n\tu8 fan_min[3];\t\t \n\tu8 fan_status[3];\t \n\tu8 pwm[3];\t\t \n\tu16 fan_conf;\t\t \n\n\tu16 in_vref;\t\t \n\tu8 in[14];\t\t \n\tu8 in_min[14];\t\t \n\tu8 in_max[14];\t\t \n\tu8 in_crit[3];\t\t \n\tu8 in_status[14];\t \n\tu16 in_alarms;\t\t \n\tu8 vid_conf;\t\t \n\tu8 vrm;\n\tu8 vid;\t\t\t \n\n\ts8 temp[3];\t\t \n\ts8 temp_min[3];\t\t \n\ts8 temp_max[3];\t\t \n\ts8 temp_crit[3];\t \n\tu8 temp_status[3];\t \n\tu8 temp_alarms;\t\t \n};\n\n \nstatic int pc87360_read_value(struct pc87360_data *data, u8 ldi, u8 bank,\n\t\t\t      u8 reg)\n{\n\tint res;\n\n\tmutex_lock(&(data->lock));\n\tif (bank != NO_BANK)\n\t\toutb_p(bank, data->address[ldi] + PC87365_REG_BANK);\n\tres = inb_p(data->address[ldi] + reg);\n\tmutex_unlock(&(data->lock));\n\n\treturn res;\n}\n\nstatic void pc87360_write_value(struct pc87360_data *data, u8 ldi, u8 bank,\n\t\t\t\tu8 reg, u8 value)\n{\n\tmutex_lock(&(data->lock));\n\tif (bank != NO_BANK)\n\t\toutb_p(bank, data->address[ldi] + PC87365_REG_BANK);\n\toutb_p(value, data->address[ldi] + reg);\n\tmutex_unlock(&(data->lock));\n}\n\nstatic void pc87360_autodiv(struct device *dev, int nr)\n{\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tu8 old_min = data->fan_min[nr];\n\n\t \n\tif ((data->fan_status[nr] & 0x04)  \n\t || (data->fan[nr] >= 224)) {  \n\t\tif ((data->fan_status[nr] & 0x60) != 0x60) {\n\t\t\tdata->fan_status[nr] += 0x20;\n\t\t\tdata->fan_min[nr] >>= 1;\n\t\t\tdata->fan[nr] >>= 1;\n\t\t\tdev_dbg(dev,\n\t\t\t\t\"Increasing clock divider to %d for fan %d\\n\",\n\t\t\t\tFAN_DIV_FROM_REG(data->fan_status[nr]), nr + 1);\n\t\t}\n\t} else {\n\t\t \n\t\twhile (!(data->fan_min[nr] & 0x80)  \n\t\t && data->fan[nr] < 85  \n\t\t && (data->fan_status[nr] & 0x60) != 0x00) {\n\t\t\tdata->fan_status[nr] -= 0x20;\n\t\t\tdata->fan_min[nr] <<= 1;\n\t\t\tdata->fan[nr] <<= 1;\n\t\t\tdev_dbg(dev,\n\t\t\t\t\"Decreasing clock divider to %d for fan %d\\n\",\n\t\t\t\tFAN_DIV_FROM_REG(data->fan_status[nr]),\n\t\t\t\tnr + 1);\n\t\t}\n\t}\n\n\t \n\tif (old_min != data->fan_min[nr]) {\n\t\tpc87360_write_value(data, LD_FAN, NO_BANK,\n\t\t\t\t    PC87360_REG_FAN_MIN(nr),\n\t\t\t\t    data->fan_min[nr]);\n\t}\n}\n\nstatic struct pc87360_data *pc87360_update_device(struct device *dev)\n{\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tu8 i;\n\n\tmutex_lock(&data->update_lock);\n\n\tif (time_after(jiffies, data->last_updated + HZ * 2) || !data->valid) {\n\t\tdev_dbg(dev, \"Data update\\n\");\n\n\t\t \n\t\tfor (i = 0; i < data->fannr; i++) {\n\t\t\tif (FAN_CONFIG_MONITOR(data->fan_conf, i)) {\n\t\t\t\tdata->fan_status[i] =\n\t\t\t\t\tpc87360_read_value(data, LD_FAN,\n\t\t\t\t\tNO_BANK, PC87360_REG_FAN_STATUS(i));\n\t\t\t\tdata->fan[i] = pc87360_read_value(data, LD_FAN,\n\t\t\t\t\t       NO_BANK, PC87360_REG_FAN(i));\n\t\t\t\tdata->fan_min[i] = pc87360_read_value(data,\n\t\t\t\t\t\t   LD_FAN, NO_BANK,\n\t\t\t\t\t\t   PC87360_REG_FAN_MIN(i));\n\t\t\t\t \n\t\t\t\tpc87360_autodiv(dev, i);\n\t\t\t\t \n\t\t\t\tpc87360_write_value(data, LD_FAN, NO_BANK,\n\t\t\t\t\t\t    PC87360_REG_FAN_STATUS(i),\n\t\t\t\t\t\t    data->fan_status[i]);\n\t\t\t}\n\t\t\tif (FAN_CONFIG_CONTROL(data->fan_conf, i))\n\t\t\t\tdata->pwm[i] = pc87360_read_value(data, LD_FAN,\n\t\t\t\t\t       NO_BANK, PC87360_REG_PWM(i));\n\t\t}\n\n\t\t \n\t\tfor (i = 0; i < data->innr; i++) {\n\t\t\tdata->in_status[i] = pc87360_read_value(data, LD_IN, i,\n\t\t\t\t\t     PC87365_REG_IN_STATUS);\n\t\t\t \n\t\t\tpc87360_write_value(data, LD_IN, i,\n\t\t\t\t\t    PC87365_REG_IN_STATUS,\n\t\t\t\t\t    data->in_status[i]);\n\t\t\tif ((data->in_status[i] & CHAN_READY) == CHAN_READY) {\n\t\t\t\tdata->in[i] = pc87360_read_value(data, LD_IN,\n\t\t\t\t\t      i, PC87365_REG_IN);\n\t\t\t}\n\t\t\tif (data->in_status[i] & CHAN_ENA) {\n\t\t\t\tdata->in_min[i] = pc87360_read_value(data,\n\t\t\t\t\t\t  LD_IN, i,\n\t\t\t\t\t\t  PC87365_REG_IN_MIN);\n\t\t\t\tdata->in_max[i] = pc87360_read_value(data,\n\t\t\t\t\t\t  LD_IN, i,\n\t\t\t\t\t\t  PC87365_REG_IN_MAX);\n\t\t\t\tif (i >= 11)\n\t\t\t\t\tdata->in_crit[i-11] =\n\t\t\t\t\t\tpc87360_read_value(data, LD_IN,\n\t\t\t\t\t\ti, PC87365_REG_TEMP_CRIT);\n\t\t\t}\n\t\t}\n\t\tif (data->innr) {\n\t\t\tdata->in_alarms = pc87360_read_value(data, LD_IN,\n\t\t\t\t\t  NO_BANK, PC87365_REG_IN_ALARMS1)\n\t\t\t\t\t| ((pc87360_read_value(data, LD_IN,\n\t\t\t\t\t    NO_BANK, PC87365_REG_IN_ALARMS2)\n\t\t\t\t\t    & 0x07) << 8);\n\t\t\tdata->vid = (data->vid_conf & 0xE0) ?\n\t\t\t\t    pc87360_read_value(data, LD_IN,\n\t\t\t\t    NO_BANK, PC87365_REG_VID) : 0x1F;\n\t\t}\n\n\t\t \n\t\tfor (i = 0; i < data->tempnr; i++) {\n\t\t\tdata->temp_status[i] = pc87360_read_value(data,\n\t\t\t\t\t       LD_TEMP, i,\n\t\t\t\t\t       PC87365_REG_TEMP_STATUS);\n\t\t\t \n\t\t\tpc87360_write_value(data, LD_TEMP, i,\n\t\t\t\t\t    PC87365_REG_TEMP_STATUS,\n\t\t\t\t\t    data->temp_status[i]);\n\t\t\tif ((data->temp_status[i] & CHAN_READY) == CHAN_READY) {\n\t\t\t\tdata->temp[i] = pc87360_read_value(data,\n\t\t\t\t\t\tLD_TEMP, i,\n\t\t\t\t\t\tPC87365_REG_TEMP);\n\t\t\t}\n\t\t\tif (data->temp_status[i] & CHAN_ENA) {\n\t\t\t\tdata->temp_min[i] = pc87360_read_value(data,\n\t\t\t\t\t\t    LD_TEMP, i,\n\t\t\t\t\t\t    PC87365_REG_TEMP_MIN);\n\t\t\t\tdata->temp_max[i] = pc87360_read_value(data,\n\t\t\t\t\t\t    LD_TEMP, i,\n\t\t\t\t\t\t    PC87365_REG_TEMP_MAX);\n\t\t\t\tdata->temp_crit[i] = pc87360_read_value(data,\n\t\t\t\t\t\t     LD_TEMP, i,\n\t\t\t\t\t\t     PC87365_REG_TEMP_CRIT);\n\t\t\t}\n\t\t}\n\t\tif (data->tempnr) {\n\t\t\tdata->temp_alarms = pc87360_read_value(data, LD_TEMP,\n\t\t\t\t\t    NO_BANK, PC87365_REG_TEMP_ALARMS)\n\t\t\t\t\t    & 0x3F;\n\t\t}\n\n\t\tdata->last_updated = jiffies;\n\t\tdata->valid = true;\n\t}\n\n\tmutex_unlock(&data->update_lock);\n\n\treturn data;\n}\n\nstatic ssize_t in_input_show(struct device *dev,\n\t\t\t     struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", IN_FROM_REG(data->in[attr->index],\n\t\t       data->in_vref));\n}\n\nstatic struct sensor_device_attribute in_input[] = {\n\tSENSOR_ATTR_RO(in0_input, in_input, 0),\n\tSENSOR_ATTR_RO(in1_input, in_input, 1),\n\tSENSOR_ATTR_RO(in2_input, in_input, 2),\n\tSENSOR_ATTR_RO(in3_input, in_input, 3),\n\tSENSOR_ATTR_RO(in4_input, in_input, 4),\n\tSENSOR_ATTR_RO(in5_input, in_input, 5),\n\tSENSOR_ATTR_RO(in6_input, in_input, 6),\n\tSENSOR_ATTR_RO(in7_input, in_input, 7),\n\tSENSOR_ATTR_RO(in8_input, in_input, 8),\n\tSENSOR_ATTR_RO(in9_input, in_input, 9),\n\tSENSOR_ATTR_RO(in10_input, in_input, 10),\n};\n\nstatic ssize_t in_status_show(struct device *dev,\n\t\t\t      struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", data->in_status[attr->index]);\n}\n\nstatic struct sensor_device_attribute in_status[] = {\n\tSENSOR_ATTR_RO(in0_status, in_status, 0),\n\tSENSOR_ATTR_RO(in1_status, in_status, 1),\n\tSENSOR_ATTR_RO(in2_status, in_status, 2),\n\tSENSOR_ATTR_RO(in3_status, in_status, 3),\n\tSENSOR_ATTR_RO(in4_status, in_status, 4),\n\tSENSOR_ATTR_RO(in5_status, in_status, 5),\n\tSENSOR_ATTR_RO(in6_status, in_status, 6),\n\tSENSOR_ATTR_RO(in7_status, in_status, 7),\n\tSENSOR_ATTR_RO(in8_status, in_status, 8),\n\tSENSOR_ATTR_RO(in9_status, in_status, 9),\n\tSENSOR_ATTR_RO(in10_status, in_status, 10),\n};\n\nstatic ssize_t in_min_show(struct device *dev,\n\t\t\t   struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", IN_FROM_REG(data->in_min[attr->index],\n\t\t       data->in_vref));\n}\n\nstatic ssize_t in_min_store(struct device *dev,\n\t\t\t    struct device_attribute *devattr, const char *buf,\n\t\t\t    size_t count)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tlong val;\n\tint err;\n\n\terr = kstrtol(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\n\tmutex_lock(&data->update_lock);\n\tdata->in_min[attr->index] = IN_TO_REG(val, data->in_vref);\n\tpc87360_write_value(data, LD_IN, attr->index, PC87365_REG_IN_MIN,\n\t\t\t    data->in_min[attr->index]);\n\tmutex_unlock(&data->update_lock);\n\treturn count;\n}\n\nstatic struct sensor_device_attribute in_min[] = {\n\tSENSOR_ATTR_RW(in0_min, in_min, 0),\n\tSENSOR_ATTR_RW(in1_min, in_min, 1),\n\tSENSOR_ATTR_RW(in2_min, in_min, 2),\n\tSENSOR_ATTR_RW(in3_min, in_min, 3),\n\tSENSOR_ATTR_RW(in4_min, in_min, 4),\n\tSENSOR_ATTR_RW(in5_min, in_min, 5),\n\tSENSOR_ATTR_RW(in6_min, in_min, 6),\n\tSENSOR_ATTR_RW(in7_min, in_min, 7),\n\tSENSOR_ATTR_RW(in8_min, in_min, 8),\n\tSENSOR_ATTR_RW(in9_min, in_min, 9),\n\tSENSOR_ATTR_RW(in10_min, in_min, 10),\n};\n\nstatic ssize_t in_max_show(struct device *dev,\n\t\t\t   struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", IN_FROM_REG(data->in_max[attr->index],\n\t\t       data->in_vref));\n}\n\nstatic ssize_t in_max_store(struct device *dev,\n\t\t\t    struct device_attribute *devattr, const char *buf,\n\t\t\t    size_t count)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tlong val;\n\tint err;\n\n\terr = kstrtol(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\n\tmutex_lock(&data->update_lock);\n\tdata->in_max[attr->index] = IN_TO_REG(val,\n\t\t\t       data->in_vref);\n\tpc87360_write_value(data, LD_IN, attr->index, PC87365_REG_IN_MAX,\n\t\t\t    data->in_max[attr->index]);\n\tmutex_unlock(&data->update_lock);\n\treturn count;\n}\n\nstatic struct sensor_device_attribute in_max[] = {\n\tSENSOR_ATTR_RW(in0_max, in_max, 0),\n\tSENSOR_ATTR_RW(in1_max, in_max, 1),\n\tSENSOR_ATTR_RW(in2_max, in_max, 2),\n\tSENSOR_ATTR_RW(in3_max, in_max, 3),\n\tSENSOR_ATTR_RW(in4_max, in_max, 4),\n\tSENSOR_ATTR_RW(in5_max, in_max, 5),\n\tSENSOR_ATTR_RW(in6_max, in_max, 6),\n\tSENSOR_ATTR_RW(in7_max, in_max, 7),\n\tSENSOR_ATTR_RW(in8_max, in_max, 8),\n\tSENSOR_ATTR_RW(in9_max, in_max, 9),\n\tSENSOR_ATTR_RW(in10_max, in_max, 10),\n};\n\n \n#define CHAN_ALM_MIN\t0x02\t \n#define CHAN_ALM_MAX\t0x04\t \n#define TEMP_ALM_CRIT\t0x08\t \n\n \n\nstatic ssize_t in_min_alarm_show(struct device *dev,\n\t\t\t\t struct device_attribute *devattr, char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\tunsigned nr = to_sensor_dev_attr(devattr)->index;\n\n\treturn sprintf(buf, \"%u\\n\", !!(data->in_status[nr] & CHAN_ALM_MIN));\n}\n\nstatic struct sensor_device_attribute in_min_alarm[] = {\n\tSENSOR_ATTR_RO(in0_min_alarm, in_min_alarm, 0),\n\tSENSOR_ATTR_RO(in1_min_alarm, in_min_alarm, 1),\n\tSENSOR_ATTR_RO(in2_min_alarm, in_min_alarm, 2),\n\tSENSOR_ATTR_RO(in3_min_alarm, in_min_alarm, 3),\n\tSENSOR_ATTR_RO(in4_min_alarm, in_min_alarm, 4),\n\tSENSOR_ATTR_RO(in5_min_alarm, in_min_alarm, 5),\n\tSENSOR_ATTR_RO(in6_min_alarm, in_min_alarm, 6),\n\tSENSOR_ATTR_RO(in7_min_alarm, in_min_alarm, 7),\n\tSENSOR_ATTR_RO(in8_min_alarm, in_min_alarm, 8),\n\tSENSOR_ATTR_RO(in9_min_alarm, in_min_alarm, 9),\n\tSENSOR_ATTR_RO(in10_min_alarm, in_min_alarm, 10),\n};\n\nstatic ssize_t in_max_alarm_show(struct device *dev,\n\t\t\t\t struct device_attribute *devattr, char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\tunsigned nr = to_sensor_dev_attr(devattr)->index;\n\n\treturn sprintf(buf, \"%u\\n\", !!(data->in_status[nr] & CHAN_ALM_MAX));\n}\n\nstatic struct sensor_device_attribute in_max_alarm[] = {\n\tSENSOR_ATTR_RO(in0_max_alarm, in_max_alarm, 0),\n\tSENSOR_ATTR_RO(in1_max_alarm, in_max_alarm, 1),\n\tSENSOR_ATTR_RO(in2_max_alarm, in_max_alarm, 2),\n\tSENSOR_ATTR_RO(in3_max_alarm, in_max_alarm, 3),\n\tSENSOR_ATTR_RO(in4_max_alarm, in_max_alarm, 4),\n\tSENSOR_ATTR_RO(in5_max_alarm, in_max_alarm, 5),\n\tSENSOR_ATTR_RO(in6_max_alarm, in_max_alarm, 6),\n\tSENSOR_ATTR_RO(in7_max_alarm, in_max_alarm, 7),\n\tSENSOR_ATTR_RO(in8_max_alarm, in_max_alarm, 8),\n\tSENSOR_ATTR_RO(in9_max_alarm, in_max_alarm, 9),\n\tSENSOR_ATTR_RO(in10_max_alarm, in_max_alarm, 10),\n};\n\n#define VIN_UNIT_ATTRS(X) \\\n\t&in_input[X].dev_attr.attr,\t\\\n\t&in_status[X].dev_attr.attr,\t\\\n\t&in_min[X].dev_attr.attr,\t\\\n\t&in_max[X].dev_attr.attr,\t\\\n\t&in_min_alarm[X].dev_attr.attr,\t\\\n\t&in_max_alarm[X].dev_attr.attr\n\nstatic ssize_t cpu0_vid_show(struct device *dev,\n\t\t\t     struct device_attribute *attr, char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", vid_from_reg(data->vid, data->vrm));\n}\nstatic DEVICE_ATTR_RO(cpu0_vid);\n\nstatic ssize_t vrm_show(struct device *dev, struct device_attribute *attr,\n\t\t\tchar *buf)\n{\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\treturn sprintf(buf, \"%u\\n\", data->vrm);\n}\n\nstatic ssize_t vrm_store(struct device *dev, struct device_attribute *attr,\n\t\t\t const char *buf, size_t count)\n{\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tunsigned long val;\n\tint err;\n\n\terr = kstrtoul(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\n\tif (val > 255)\n\t\treturn -EINVAL;\n\n\tdata->vrm = val;\n\treturn count;\n}\nstatic DEVICE_ATTR_RW(vrm);\n\nstatic ssize_t alarms_in_show(struct device *dev,\n\t\t\t      struct device_attribute *attr, char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", data->in_alarms);\n}\nstatic DEVICE_ATTR_RO(alarms_in);\n\nstatic struct attribute *pc8736x_vin_attr_array[] = {\n\tVIN_UNIT_ATTRS(0),\n\tVIN_UNIT_ATTRS(1),\n\tVIN_UNIT_ATTRS(2),\n\tVIN_UNIT_ATTRS(3),\n\tVIN_UNIT_ATTRS(4),\n\tVIN_UNIT_ATTRS(5),\n\tVIN_UNIT_ATTRS(6),\n\tVIN_UNIT_ATTRS(7),\n\tVIN_UNIT_ATTRS(8),\n\tVIN_UNIT_ATTRS(9),\n\tVIN_UNIT_ATTRS(10),\n\t&dev_attr_cpu0_vid.attr,\n\t&dev_attr_vrm.attr,\n\t&dev_attr_alarms_in.attr,\n\tNULL\n};\nstatic const struct attribute_group pc8736x_vin_group = {\n\t.attrs = pc8736x_vin_attr_array,\n};\n\nstatic ssize_t therm_input_show(struct device *dev,\n\t\t\t\tstruct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", IN_FROM_REG(data->in[attr->index],\n\t\t       data->in_vref));\n}\n\n \nstatic struct sensor_device_attribute therm_input[] = {\n\tSENSOR_ATTR_RO(temp4_input, therm_input, 0 + 11),\n\tSENSOR_ATTR_RO(temp5_input, therm_input, 1 + 11),\n\tSENSOR_ATTR_RO(temp6_input, therm_input, 2 + 11),\n};\n\nstatic ssize_t therm_status_show(struct device *dev,\n\t\t\t\t struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", data->in_status[attr->index]);\n}\n\nstatic struct sensor_device_attribute therm_status[] = {\n\tSENSOR_ATTR_RO(temp4_status, therm_status, 0 + 11),\n\tSENSOR_ATTR_RO(temp5_status, therm_status, 1 + 11),\n\tSENSOR_ATTR_RO(temp6_status, therm_status, 2 + 11),\n};\n\nstatic ssize_t therm_min_show(struct device *dev,\n\t\t\t      struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", IN_FROM_REG(data->in_min[attr->index],\n\t\t       data->in_vref));\n}\n\nstatic ssize_t therm_min_store(struct device *dev,\n\t\t\t       struct device_attribute *devattr,\n\t\t\t       const char *buf, size_t count)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tlong val;\n\tint err;\n\n\terr = kstrtol(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\n\tmutex_lock(&data->update_lock);\n\tdata->in_min[attr->index] = IN_TO_REG(val, data->in_vref);\n\tpc87360_write_value(data, LD_IN, attr->index, PC87365_REG_TEMP_MIN,\n\t\t\t    data->in_min[attr->index]);\n\tmutex_unlock(&data->update_lock);\n\treturn count;\n}\n\nstatic struct sensor_device_attribute therm_min[] = {\n\tSENSOR_ATTR_RW(temp4_min, therm_min, 0 + 11),\n\tSENSOR_ATTR_RW(temp5_min, therm_min, 1 + 11),\n\tSENSOR_ATTR_RW(temp6_min, therm_min, 2 + 11),\n};\n\nstatic ssize_t therm_max_show(struct device *dev,\n\t\t\t      struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", IN_FROM_REG(data->in_max[attr->index],\n\t\t       data->in_vref));\n}\n\nstatic ssize_t therm_max_store(struct device *dev,\n\t\t\t       struct device_attribute *devattr,\n\t\t\t       const char *buf, size_t count)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tlong val;\n\tint err;\n\n\terr = kstrtol(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\n\tmutex_lock(&data->update_lock);\n\tdata->in_max[attr->index] = IN_TO_REG(val, data->in_vref);\n\tpc87360_write_value(data, LD_IN, attr->index, PC87365_REG_TEMP_MAX,\n\t\t\t    data->in_max[attr->index]);\n\tmutex_unlock(&data->update_lock);\n\treturn count;\n}\n\nstatic struct sensor_device_attribute therm_max[] = {\n\tSENSOR_ATTR_RW(temp4_max, therm_max, 0 + 11),\n\tSENSOR_ATTR_RW(temp5_max, therm_max, 1 + 11),\n\tSENSOR_ATTR_RW(temp6_max, therm_max, 2 + 11),\n};\n\nstatic ssize_t therm_crit_show(struct device *dev,\n\t\t\t       struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", IN_FROM_REG(data->in_crit[attr->index-11],\n\t\t       data->in_vref));\n}\n\nstatic ssize_t therm_crit_store(struct device *dev,\n\t\t\t\tstruct device_attribute *devattr,\n\t\t\t\tconst char *buf, size_t count)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tlong val;\n\tint err;\n\n\terr = kstrtol(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\n\tmutex_lock(&data->update_lock);\n\tdata->in_crit[attr->index-11] = IN_TO_REG(val, data->in_vref);\n\tpc87360_write_value(data, LD_IN, attr->index, PC87365_REG_TEMP_CRIT,\n\t\t\t    data->in_crit[attr->index-11]);\n\tmutex_unlock(&data->update_lock);\n\treturn count;\n}\n\nstatic struct sensor_device_attribute therm_crit[] = {\n\tSENSOR_ATTR_RW(temp4_crit, therm_crit, 0 + 11),\n\tSENSOR_ATTR_RW(temp5_crit, therm_crit, 1 + 11),\n\tSENSOR_ATTR_RW(temp6_crit, therm_crit, 2 + 11),\n};\n\n \nstatic ssize_t therm_min_alarm_show(struct device *dev,\n\t\t\t\t    struct device_attribute *devattr,\n\t\t\t\t    char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\tunsigned nr = to_sensor_dev_attr(devattr)->index;\n\n\treturn sprintf(buf, \"%u\\n\", !!(data->in_status[nr] & CHAN_ALM_MIN));\n}\n\nstatic struct sensor_device_attribute therm_min_alarm[] = {\n\tSENSOR_ATTR_RO(temp4_min_alarm, therm_min_alarm, 0 + 11),\n\tSENSOR_ATTR_RO(temp5_min_alarm, therm_min_alarm, 1 + 11),\n\tSENSOR_ATTR_RO(temp6_min_alarm, therm_min_alarm, 2 + 11),\n};\n\nstatic ssize_t therm_max_alarm_show(struct device *dev,\n\t\t\t\t    struct device_attribute *devattr,\n\t\t\t\t    char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\tunsigned nr = to_sensor_dev_attr(devattr)->index;\n\n\treturn sprintf(buf, \"%u\\n\", !!(data->in_status[nr] & CHAN_ALM_MAX));\n}\n\nstatic struct sensor_device_attribute therm_max_alarm[] = {\n\tSENSOR_ATTR_RO(temp4_max_alarm, therm_max_alarm, 0 + 11),\n\tSENSOR_ATTR_RO(temp5_max_alarm, therm_max_alarm, 1 + 11),\n\tSENSOR_ATTR_RO(temp6_max_alarm, therm_max_alarm, 2 + 11),\n};\n\nstatic ssize_t therm_crit_alarm_show(struct device *dev,\n\t\t\t\t     struct device_attribute *devattr,\n\t\t\t\t     char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\tunsigned nr = to_sensor_dev_attr(devattr)->index;\n\n\treturn sprintf(buf, \"%u\\n\", !!(data->in_status[nr] & TEMP_ALM_CRIT));\n}\n\nstatic struct sensor_device_attribute therm_crit_alarm[] = {\n\tSENSOR_ATTR_RO(temp4_crit_alarm, therm_crit_alarm, 0 + 11),\n\tSENSOR_ATTR_RO(temp5_crit_alarm, therm_crit_alarm, 1 + 11),\n\tSENSOR_ATTR_RO(temp6_crit_alarm, therm_crit_alarm, 2 + 11),\n};\n\n#define THERM_UNIT_ATTRS(X) \\\n\t&therm_input[X].dev_attr.attr,\t\\\n\t&therm_status[X].dev_attr.attr,\t\\\n\t&therm_min[X].dev_attr.attr,\t\\\n\t&therm_max[X].dev_attr.attr,\t\\\n\t&therm_crit[X].dev_attr.attr,\t\\\n\t&therm_min_alarm[X].dev_attr.attr, \\\n\t&therm_max_alarm[X].dev_attr.attr, \\\n\t&therm_crit_alarm[X].dev_attr.attr\n\nstatic struct attribute *pc8736x_therm_attr_array[] = {\n\tTHERM_UNIT_ATTRS(0),\n\tTHERM_UNIT_ATTRS(1),\n\tTHERM_UNIT_ATTRS(2),\n\tNULL\n};\nstatic const struct attribute_group pc8736x_therm_group = {\n\t.attrs = pc8736x_therm_attr_array,\n};\n\nstatic ssize_t temp_input_show(struct device *dev,\n\t\t\t       struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%d\\n\", TEMP_FROM_REG(data->temp[attr->index]));\n}\n\nstatic struct sensor_device_attribute temp_input[] = {\n\tSENSOR_ATTR_RO(temp1_input, temp_input, 0),\n\tSENSOR_ATTR_RO(temp2_input, temp_input, 1),\n\tSENSOR_ATTR_RO(temp3_input, temp_input, 2),\n};\n\nstatic ssize_t temp_status_show(struct device *dev,\n\t\t\t\tstruct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%d\\n\", data->temp_status[attr->index]);\n}\n\nstatic struct sensor_device_attribute temp_status[] = {\n\tSENSOR_ATTR_RO(temp1_status, temp_status, 0),\n\tSENSOR_ATTR_RO(temp2_status, temp_status, 1),\n\tSENSOR_ATTR_RO(temp3_status, temp_status, 2),\n};\n\nstatic ssize_t temp_min_show(struct device *dev,\n\t\t\t     struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%d\\n\", TEMP_FROM_REG(data->temp_min[attr->index]));\n}\n\nstatic ssize_t temp_min_store(struct device *dev,\n\t\t\t      struct device_attribute *devattr,\n\t\t\t      const char *buf, size_t count)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tlong val;\n\tint err;\n\n\terr = kstrtol(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\n\tmutex_lock(&data->update_lock);\n\tdata->temp_min[attr->index] = TEMP_TO_REG(val);\n\tpc87360_write_value(data, LD_TEMP, attr->index, PC87365_REG_TEMP_MIN,\n\t\t\t    data->temp_min[attr->index]);\n\tmutex_unlock(&data->update_lock);\n\treturn count;\n}\n\nstatic struct sensor_device_attribute temp_min[] = {\n\tSENSOR_ATTR_RW(temp1_min, temp_min, 0),\n\tSENSOR_ATTR_RW(temp2_min, temp_min, 1),\n\tSENSOR_ATTR_RW(temp3_min, temp_min, 2),\n};\n\nstatic ssize_t temp_max_show(struct device *dev,\n\t\t\t     struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%d\\n\", TEMP_FROM_REG(data->temp_max[attr->index]));\n}\n\nstatic ssize_t temp_max_store(struct device *dev,\n\t\t\t      struct device_attribute *devattr,\n\t\t\t      const char *buf, size_t count)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tlong val;\n\tint err;\n\n\terr = kstrtol(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\n\tmutex_lock(&data->update_lock);\n\tdata->temp_max[attr->index] = TEMP_TO_REG(val);\n\tpc87360_write_value(data, LD_TEMP, attr->index, PC87365_REG_TEMP_MAX,\n\t\t\t    data->temp_max[attr->index]);\n\tmutex_unlock(&data->update_lock);\n\treturn count;\n}\n\nstatic struct sensor_device_attribute temp_max[] = {\n\tSENSOR_ATTR_RW(temp1_max, temp_max, 0),\n\tSENSOR_ATTR_RW(temp2_max, temp_max, 1),\n\tSENSOR_ATTR_RW(temp3_max, temp_max, 2),\n};\n\nstatic ssize_t temp_crit_show(struct device *dev,\n\t\t\t      struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%d\\n\",\n\t\t       TEMP_FROM_REG(data->temp_crit[attr->index]));\n}\n\nstatic ssize_t temp_crit_store(struct device *dev,\n\t\t\t       struct device_attribute *devattr,\n\t\t\t       const char *buf, size_t count)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tlong val;\n\tint err;\n\n\terr = kstrtol(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\n\tmutex_lock(&data->update_lock);\n\tdata->temp_crit[attr->index] = TEMP_TO_REG(val);\n\tpc87360_write_value(data, LD_TEMP, attr->index, PC87365_REG_TEMP_CRIT,\n\t\t\t    data->temp_crit[attr->index]);\n\tmutex_unlock(&data->update_lock);\n\treturn count;\n}\n\nstatic struct sensor_device_attribute temp_crit[] = {\n\tSENSOR_ATTR_RW(temp1_crit, temp_crit, 0),\n\tSENSOR_ATTR_RW(temp2_crit, temp_crit, 1),\n\tSENSOR_ATTR_RW(temp3_crit, temp_crit, 2),\n};\n\n \nstatic ssize_t temp_min_alarm_show(struct device *dev,\n\t\t\t\t   struct device_attribute *devattr,\n\t\t\t\t   char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\tunsigned nr = to_sensor_dev_attr(devattr)->index;\n\n\treturn sprintf(buf, \"%u\\n\", !!(data->temp_status[nr] & CHAN_ALM_MIN));\n}\n\nstatic struct sensor_device_attribute temp_min_alarm[] = {\n\tSENSOR_ATTR_RO(temp1_min_alarm, temp_min_alarm, 0),\n\tSENSOR_ATTR_RO(temp2_min_alarm, temp_min_alarm, 1),\n\tSENSOR_ATTR_RO(temp3_min_alarm, temp_min_alarm, 2),\n};\n\nstatic ssize_t temp_max_alarm_show(struct device *dev,\n\t\t\t\t   struct device_attribute *devattr,\n\t\t\t\t   char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\tunsigned nr = to_sensor_dev_attr(devattr)->index;\n\n\treturn sprintf(buf, \"%u\\n\", !!(data->temp_status[nr] & CHAN_ALM_MAX));\n}\n\nstatic struct sensor_device_attribute temp_max_alarm[] = {\n\tSENSOR_ATTR_RO(temp1_max_alarm, temp_max_alarm, 0),\n\tSENSOR_ATTR_RO(temp2_max_alarm, temp_max_alarm, 1),\n\tSENSOR_ATTR_RO(temp3_max_alarm, temp_max_alarm, 2),\n};\n\nstatic ssize_t temp_crit_alarm_show(struct device *dev,\n\t\t\t\t    struct device_attribute *devattr,\n\t\t\t\t    char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\tunsigned nr = to_sensor_dev_attr(devattr)->index;\n\n\treturn sprintf(buf, \"%u\\n\", !!(data->temp_status[nr] & TEMP_ALM_CRIT));\n}\n\nstatic struct sensor_device_attribute temp_crit_alarm[] = {\n\tSENSOR_ATTR_RO(temp1_crit_alarm, temp_crit_alarm, 0),\n\tSENSOR_ATTR_RO(temp2_crit_alarm, temp_crit_alarm, 1),\n\tSENSOR_ATTR_RO(temp3_crit_alarm, temp_crit_alarm, 2),\n};\n\n#define TEMP_FAULT\t0x40\t \nstatic ssize_t temp_fault_show(struct device *dev,\n\t\t\t       struct device_attribute *devattr, char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\tunsigned nr = to_sensor_dev_attr(devattr)->index;\n\n\treturn sprintf(buf, \"%u\\n\", !!(data->temp_status[nr] & TEMP_FAULT));\n}\n\nstatic struct sensor_device_attribute temp_fault[] = {\n\tSENSOR_ATTR_RO(temp1_fault, temp_fault, 0),\n\tSENSOR_ATTR_RO(temp2_fault, temp_fault, 1),\n\tSENSOR_ATTR_RO(temp3_fault, temp_fault, 2),\n};\n\n#define TEMP_UNIT_ATTRS(X)\t\t\t\\\n{\t&temp_input[X].dev_attr.attr,\t\t\\\n\t&temp_status[X].dev_attr.attr,\t\t\\\n\t&temp_min[X].dev_attr.attr,\t\t\\\n\t&temp_max[X].dev_attr.attr,\t\t\\\n\t&temp_crit[X].dev_attr.attr,\t\t\\\n\t&temp_min_alarm[X].dev_attr.attr,\t\\\n\t&temp_max_alarm[X].dev_attr.attr,\t\\\n\t&temp_crit_alarm[X].dev_attr.attr,\t\\\n\t&temp_fault[X].dev_attr.attr,\t\t\\\n\tNULL\t\t\t\t\t\\\n}\n\nstatic struct attribute *pc8736x_temp_attr[][10] = {\n\tTEMP_UNIT_ATTRS(0),\n\tTEMP_UNIT_ATTRS(1),\n\tTEMP_UNIT_ATTRS(2)\n};\n\nstatic const struct attribute_group pc8736x_temp_attr_group[] = {\n\t{ .attrs = pc8736x_temp_attr[0] },\n\t{ .attrs = pc8736x_temp_attr[1] },\n\t{ .attrs = pc8736x_temp_attr[2] }\n};\n\nstatic ssize_t alarms_temp_show(struct device *dev,\n\t\t\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", data->temp_alarms);\n}\n\nstatic DEVICE_ATTR_RO(alarms_temp);\n\nstatic ssize_t fan_input_show(struct device *dev,\n\t\t\t      struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", FAN_FROM_REG(data->fan[attr->index],\n\t\t       FAN_DIV_FROM_REG(data->fan_status[attr->index])));\n}\n\nstatic struct sensor_device_attribute fan_input[] = {\n\tSENSOR_ATTR_RO(fan1_input, fan_input, 0),\n\tSENSOR_ATTR_RO(fan2_input, fan_input, 1),\n\tSENSOR_ATTR_RO(fan3_input, fan_input, 2),\n};\n\nstatic ssize_t fan_status_show(struct device *dev,\n\t\t\t       struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\",\n\t\t       FAN_STATUS_FROM_REG(data->fan_status[attr->index]));\n}\n\nstatic struct sensor_device_attribute fan_status[] = {\n\tSENSOR_ATTR_RO(fan1_status, fan_status, 0),\n\tSENSOR_ATTR_RO(fan2_status, fan_status, 1),\n\tSENSOR_ATTR_RO(fan3_status, fan_status, 2),\n};\n\nstatic ssize_t fan_div_show(struct device *dev,\n\t\t\t    struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\",\n\t\t       FAN_DIV_FROM_REG(data->fan_status[attr->index]));\n}\n\nstatic struct sensor_device_attribute fan_div[] = {\n\tSENSOR_ATTR_RO(fan1_div, fan_div, 0),\n\tSENSOR_ATTR_RO(fan2_div, fan_div, 1),\n\tSENSOR_ATTR_RO(fan3_div, fan_div, 2),\n};\n\nstatic ssize_t fan_min_show(struct device *dev,\n\t\t\t    struct device_attribute *devattr, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\", FAN_FROM_REG(data->fan_min[attr->index],\n\t\t       FAN_DIV_FROM_REG(data->fan_status[attr->index])));\n}\n\nstatic ssize_t fan_min_store(struct device *dev,\n\t\t\t     struct device_attribute *devattr,\n\t\t\t     const char *buf, size_t count)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tlong fan_min;\n\tint err;\n\n\terr = kstrtol(buf, 10, &fan_min);\n\tif (err)\n\t\treturn err;\n\n\tmutex_lock(&data->update_lock);\n\tfan_min = FAN_TO_REG(fan_min,\n\t\t\t     FAN_DIV_FROM_REG(data->fan_status[attr->index]));\n\n\t \n\twhile (fan_min > 255\n\t    && (data->fan_status[attr->index] & 0x60) != 0x60) {\n\t\tfan_min >>= 1;\n\t\tdata->fan[attr->index] >>= 1;\n\t\tdata->fan_status[attr->index] += 0x20;\n\t}\n\tdata->fan_min[attr->index] = fan_min > 255 ? 255 : fan_min;\n\tpc87360_write_value(data, LD_FAN, NO_BANK,\n\t\t\t    PC87360_REG_FAN_MIN(attr->index),\n\t\t\t    data->fan_min[attr->index]);\n\n\t \n\tpc87360_write_value(data, LD_FAN, NO_BANK,\n\t\t\t    PC87360_REG_FAN_STATUS(attr->index),\n\t\t\t    data->fan_status[attr->index] & 0xF9);\n\tmutex_unlock(&data->update_lock);\n\n\treturn count;\n}\n\nstatic struct sensor_device_attribute fan_min[] = {\n\tSENSOR_ATTR_RW(fan1_min, fan_min, 0),\n\tSENSOR_ATTR_RW(fan2_min, fan_min, 1),\n\tSENSOR_ATTR_RW(fan3_min, fan_min, 2),\n};\n\n#define FAN_UNIT_ATTRS(X)\t\t\\\n{\t&fan_input[X].dev_attr.attr,\t\\\n\t&fan_status[X].dev_attr.attr,\t\\\n\t&fan_div[X].dev_attr.attr,\t\\\n\t&fan_min[X].dev_attr.attr,\t\\\n\tNULL\t\t\t\t\\\n}\n\nstatic struct attribute *pc8736x_fan_attr[][5] = {\n\tFAN_UNIT_ATTRS(0),\n\tFAN_UNIT_ATTRS(1),\n\tFAN_UNIT_ATTRS(2)\n};\n\nstatic const struct attribute_group pc8736x_fan_attr_group[] = {\n\t{ .attrs = pc8736x_fan_attr[0], },\n\t{ .attrs = pc8736x_fan_attr[1], },\n\t{ .attrs = pc8736x_fan_attr[2], },\n};\n\nstatic ssize_t pwm_show(struct device *dev, struct device_attribute *devattr,\n\t\t\tchar *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = pc87360_update_device(dev);\n\treturn sprintf(buf, \"%u\\n\",\n\t\t       PWM_FROM_REG(data->pwm[attr->index],\n\t\t\t\t    FAN_CONFIG_INVERT(data->fan_conf,\n\t\t\t\t\t\t      attr->index)));\n}\n\nstatic ssize_t pwm_store(struct device *dev, struct device_attribute *devattr,\n\t\t\t const char *buf, size_t count)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\tlong val;\n\tint err;\n\n\terr = kstrtol(buf, 10, &val);\n\tif (err)\n\t\treturn err;\n\n\tmutex_lock(&data->update_lock);\n\tdata->pwm[attr->index] = PWM_TO_REG(val,\n\t\t\t      FAN_CONFIG_INVERT(data->fan_conf, attr->index));\n\tpc87360_write_value(data, LD_FAN, NO_BANK, PC87360_REG_PWM(attr->index),\n\t\t\t    data->pwm[attr->index]);\n\tmutex_unlock(&data->update_lock);\n\treturn count;\n}\n\nstatic struct sensor_device_attribute pwm[] = {\n\tSENSOR_ATTR_RW(pwm1, pwm, 0),\n\tSENSOR_ATTR_RW(pwm2, pwm, 1),\n\tSENSOR_ATTR_RW(pwm3, pwm, 2),\n};\n\nstatic ssize_t name_show(struct device *dev,\n\t\t\tstruct device_attribute *devattr, char *buf)\n{\n\tstruct pc87360_data *data = dev_get_drvdata(dev);\n\treturn sprintf(buf, \"%s\\n\", data->name);\n}\n\nstatic DEVICE_ATTR_RO(name);\n\nstatic void pc87360_remove_files(struct device *dev)\n{\n\tint i;\n\n\tdevice_remove_file(dev, &dev_attr_name);\n\tdevice_remove_file(dev, &dev_attr_alarms_temp);\n\tfor (i = 0; i < ARRAY_SIZE(pc8736x_temp_attr_group); i++)\n\t\tsysfs_remove_group(&dev->kobj, &pc8736x_temp_attr_group[i]);\n\tfor (i = 0; i < ARRAY_SIZE(pc8736x_fan_attr_group); i++) {\n\t\tsysfs_remove_group(&pdev->dev.kobj, &pc8736x_fan_attr_group[i]);\n\t\tdevice_remove_file(dev, &pwm[i].dev_attr);\n\t}\n\tsysfs_remove_group(&dev->kobj, &pc8736x_therm_group);\n\tsysfs_remove_group(&dev->kobj, &pc8736x_vin_group);\n}\n\nstatic void pc87360_init_device(struct platform_device *pdev,\n\t\t\t\tint use_thermistors)\n{\n\tstruct pc87360_data *data = platform_get_drvdata(pdev);\n\tint i, nr;\n\tconst u8 init_in[14] = { 2, 2, 2, 2, 2, 2, 2, 1, 1, 3, 1, 2, 2, 2 };\n\tconst u8 init_temp[3] = { 2, 2, 1 };\n\tu8 reg;\n\n\tif (init >= 2 && data->innr) {\n\t\treg = pc87360_read_value(data, LD_IN, NO_BANK,\n\t\t\t\t\t PC87365_REG_IN_CONVRATE);\n\t\tdev_info(&pdev->dev,\n\t\t\t \"VLM conversion set to 1s period, 160us delay\\n\");\n\t\tpc87360_write_value(data, LD_IN, NO_BANK,\n\t\t\t\t    PC87365_REG_IN_CONVRATE,\n\t\t\t\t    (reg & 0xC0) | 0x11);\n\t}\n\n\tnr = data->innr < 11 ? data->innr : 11;\n\tfor (i = 0; i < nr; i++) {\n\t\treg = pc87360_read_value(data, LD_IN, i,\n\t\t\t\t\t PC87365_REG_IN_STATUS);\n\t\tdev_dbg(&pdev->dev, \"bios in%d status:0x%02x\\n\", i, reg);\n\t\tif (init >= init_in[i]) {\n\t\t\t \n\t\t\tif (!(reg & CHAN_ENA)) {\n\t\t\t\tdev_dbg(&pdev->dev, \"Forcibly enabling in%d\\n\",\n\t\t\t\t\ti);\n\t\t\t\tpc87360_write_value(data, LD_IN, i,\n\t\t\t\t\t\t    PC87365_REG_IN_STATUS,\n\t\t\t\t\t\t    (reg & 0x68) | 0x87);\n\t\t\t}\n\t\t}\n\t}\n\n\t \n\tdev_dbg(&pdev->dev, \"bios thermistors:%d\\n\", use_thermistors);\n\tfor (i = 11; i < data->innr; i++) {\n\t\treg = pc87360_read_value(data, LD_IN, i,\n\t\t\t\t\t PC87365_REG_TEMP_STATUS);\n\t\tuse_thermistors = use_thermistors || (reg & CHAN_ENA);\n\t\t \n\t\tdev_dbg(&pdev->dev, \"bios temp%d_status:0x%02x\\n\", i-7, reg);\n\t}\n\tdev_dbg(&pdev->dev, \"using thermistors:%d\\n\", use_thermistors);\n\n\ti = use_thermistors ? 2 : 0;\n\tfor (; i < data->tempnr; i++) {\n\t\treg = pc87360_read_value(data, LD_TEMP, i,\n\t\t\t\t\t PC87365_REG_TEMP_STATUS);\n\t\tdev_dbg(&pdev->dev, \"bios temp%d_status:0x%02x\\n\", i + 1, reg);\n\t\tif (init >= init_temp[i]) {\n\t\t\t \n\t\t\tif (!(reg & CHAN_ENA)) {\n\t\t\t\tdev_dbg(&pdev->dev,\n\t\t\t\t\t\"Forcibly enabling temp%d\\n\", i + 1);\n\t\t\t\tpc87360_write_value(data, LD_TEMP, i,\n\t\t\t\t\t\t    PC87365_REG_TEMP_STATUS,\n\t\t\t\t\t\t    0xCF);\n\t\t\t}\n\t\t}\n\t}\n\n\tif (use_thermistors) {\n\t\tfor (i = 11; i < data->innr; i++) {\n\t\t\tif (init >= init_in[i]) {\n\t\t\t\t \n\t\t\t\treg = pc87360_read_value(data, LD_TEMP,\n\t\t\t\t      (i - 11) / 2, PC87365_REG_TEMP_STATUS);\n\t\t\t\tif (reg & CHAN_ENA) {\n\t\t\t\t\tdev_dbg(&pdev->dev,\n\t\t\t\"Skipping temp%d, pin already in use by temp%d\\n\",\n\t\t\t\t\t\ti - 7, (i - 11) / 2);\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\t \n\t\t\t\treg = pc87360_read_value(data, LD_IN, i,\n\t\t\t\t\t\t\t PC87365_REG_IN_STATUS);\n\t\t\t\tif (!(reg & CHAN_ENA)) {\n\t\t\t\t\tdev_dbg(&pdev->dev,\n\t\t\t\t\t\t\"Forcibly enabling temp%d\\n\",\n\t\t\t\t\t\ti - 7);\n\t\t\t\t\tpc87360_write_value(data, LD_IN, i,\n\t\t\t\t\t\tPC87365_REG_TEMP_STATUS,\n\t\t\t\t\t\t(reg & 0x60) | 0x8F);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tif (data->innr) {\n\t\treg = pc87360_read_value(data, LD_IN, NO_BANK,\n\t\t\t\t\t PC87365_REG_IN_CONFIG);\n\t\tdev_dbg(&pdev->dev, \"bios vin-cfg:0x%02x\\n\", reg);\n\t\tif (reg & CHAN_ENA) {\n\t\t\tdev_dbg(&pdev->dev,\n\t\t\t\t\"Forcibly enabling monitoring (VLM)\\n\");\n\t\t\tpc87360_write_value(data, LD_IN, NO_BANK,\n\t\t\t\t\t    PC87365_REG_IN_CONFIG,\n\t\t\t\t\t    reg & 0xFE);\n\t\t}\n\t}\n\n\tif (data->tempnr) {\n\t\treg = pc87360_read_value(data, LD_TEMP, NO_BANK,\n\t\t\t\t\t PC87365_REG_TEMP_CONFIG);\n\t\tdev_dbg(&pdev->dev, \"bios temp-cfg:0x%02x\\n\", reg);\n\t\tif (reg & CHAN_ENA) {\n\t\t\tdev_dbg(&pdev->dev,\n\t\t\t\t\"Forcibly enabling monitoring (TMS)\\n\");\n\t\t\tpc87360_write_value(data, LD_TEMP, NO_BANK,\n\t\t\t\t\t    PC87365_REG_TEMP_CONFIG,\n\t\t\t\t\t    reg & 0xFE);\n\t\t}\n\n\t\tif (init >= 2) {\n\t\t\t \n\t\t\tpc87360_write_value(data, LD_TEMP, 0xF, 0xA, 0x08);\n\t\t\t \n\t\t\tpc87360_write_value(data, LD_TEMP, NO_BANK, 0xB, 0x04);\n\t\t\tpc87360_write_value(data, LD_TEMP, NO_BANK, 0xC, 0x35);\n\t\t\tpc87360_write_value(data, LD_TEMP, NO_BANK, 0xD, 0x05);\n\t\t\tpc87360_write_value(data, LD_TEMP, NO_BANK, 0xE, 0x05);\n\t\t}\n\t}\n}\n\nstatic int pc87360_probe(struct platform_device *pdev)\n{\n\tint i;\n\tstruct pc87360_data *data;\n\tint err = 0;\n\tconst char *name;\n\tint use_thermistors = 0;\n\tstruct device *dev = &pdev->dev;\n\n\tdata = devm_kzalloc(dev, sizeof(struct pc87360_data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tswitch (devid) {\n\tdefault:\n\t\tname = \"pc87360\";\n\t\tdata->fannr = 2;\n\t\tbreak;\n\tcase 0xe8:\n\t\tname = \"pc87363\";\n\t\tdata->fannr = 2;\n\t\tbreak;\n\tcase 0xe4:\n\t\tname = \"pc87364\";\n\t\tdata->fannr = 3;\n\t\tbreak;\n\tcase 0xe5:\n\t\tname = \"pc87365\";\n\t\tdata->fannr = extra_isa[0] ? 3 : 0;\n\t\tdata->innr = extra_isa[1] ? 11 : 0;\n\t\tdata->tempnr = extra_isa[2] ? 2 : 0;\n\t\tbreak;\n\tcase 0xe9:\n\t\tname = \"pc87366\";\n\t\tdata->fannr = extra_isa[0] ? 3 : 0;\n\t\tdata->innr = extra_isa[1] ? 14 : 0;\n\t\tdata->tempnr = extra_isa[2] ? 3 : 0;\n\t\tbreak;\n\t}\n\n\tdata->name = name;\n\tmutex_init(&data->lock);\n\tmutex_init(&data->update_lock);\n\tplatform_set_drvdata(pdev, data);\n\n\tfor (i = 0; i < LDNI_MAX; i++) {\n\t\tdata->address[i] = extra_isa[i];\n\t\tif (data->address[i]\n\t\t && !devm_request_region(dev, extra_isa[i], PC87360_EXTENT,\n\t\t\t\t\t DRIVER_NAME)) {\n\t\t\tdev_err(dev,\n\t\t\t\t\"Region 0x%x-0x%x already in use!\\n\",\n\t\t\t\textra_isa[i], extra_isa[i]+PC87360_EXTENT-1);\n\t\t\treturn -EBUSY;\n\t\t}\n\t}\n\n\t \n\tif (data->fannr)\n\t\tdata->fan_conf = confreg[0] | (confreg[1] << 8);\n\n\t \n\tif (data->innr) {\n\t\ti = pc87360_read_value(data, LD_IN, NO_BANK,\n\t\t\t\t       PC87365_REG_IN_CONFIG);\n\t\tif (data->tempnr) {\n\t\t\ti &= pc87360_read_value(data, LD_TEMP, NO_BANK,\n\t\t\t\t\t\tPC87365_REG_TEMP_CONFIG);\n\t\t}\n\t\tdata->in_vref = (i&0x02) ? 3025 : 2966;\n\t\tdev_dbg(dev, \"Using %s reference voltage\\n\",\n\t\t\t(i&0x02) ? \"external\" : \"internal\");\n\n\t\tdata->vid_conf = confreg[3];\n\t\tdata->vrm = vid_which_vrm();\n\t}\n\n\t \n\tfor (i = 0; i < data->fannr; i++) {\n\t\tif (FAN_CONFIG_MONITOR(data->fan_conf, i))\n\t\t\tdata->fan_status[i] = pc87360_read_value(data,\n\t\t\t\t\t      LD_FAN, NO_BANK,\n\t\t\t\t\t      PC87360_REG_FAN_STATUS(i));\n\t}\n\n\tif (init > 0) {\n\t\tif (devid == 0xe9 && data->address[1])  \n\t\t\tuse_thermistors = confreg[2] & 0x40;\n\n\t\tpc87360_init_device(pdev, use_thermistors);\n\t}\n\n\t \n\n\tif (data->innr) {\n\t\terr = sysfs_create_group(&dev->kobj, &pc8736x_vin_group);\n\t\tif (err)\n\t\t\tgoto error;\n\t}\n\n\tif (data->innr == 14) {\n\t\terr = sysfs_create_group(&dev->kobj, &pc8736x_therm_group);\n\t\tif (err)\n\t\t\tgoto error;\n\t}\n\n\t \n\n\tif (data->tempnr) {\n\t\tfor (i = 0; i < data->tempnr; i++) {\n\t\t\terr = sysfs_create_group(&dev->kobj,\n\t\t\t\t\t\t &pc8736x_temp_attr_group[i]);\n\t\t\tif (err)\n\t\t\t\tgoto error;\n\t\t}\n\t\terr = device_create_file(dev, &dev_attr_alarms_temp);\n\t\tif (err)\n\t\t\tgoto error;\n\t}\n\n\tfor (i = 0; i < data->fannr; i++) {\n\t\tif (FAN_CONFIG_MONITOR(data->fan_conf, i)) {\n\t\t\terr = sysfs_create_group(&dev->kobj,\n\t\t\t\t\t\t &pc8736x_fan_attr_group[i]);\n\t\t\tif (err)\n\t\t\t\tgoto error;\n\t\t}\n\t\tif (FAN_CONFIG_CONTROL(data->fan_conf, i)) {\n\t\t\terr = device_create_file(dev, &pwm[i].dev_attr);\n\t\t\tif (err)\n\t\t\t\tgoto error;\n\t\t}\n\t}\n\n\terr = device_create_file(dev, &dev_attr_name);\n\tif (err)\n\t\tgoto error;\n\n\tdata->hwmon_dev = hwmon_device_register(dev);\n\tif (IS_ERR(data->hwmon_dev)) {\n\t\terr = PTR_ERR(data->hwmon_dev);\n\t\tgoto error;\n\t}\n\treturn 0;\n\nerror:\n\tpc87360_remove_files(dev);\n\treturn err;\n}\n\nstatic int pc87360_remove(struct platform_device *pdev)\n{\n\tstruct pc87360_data *data = platform_get_drvdata(pdev);\n\n\thwmon_device_unregister(data->hwmon_dev);\n\tpc87360_remove_files(&pdev->dev);\n\n\treturn 0;\n}\n\n \nstatic struct platform_driver pc87360_driver = {\n\t.driver = {\n\t\t.name\t= DRIVER_NAME,\n\t},\n\t.probe\t\t= pc87360_probe,\n\t.remove\t\t= pc87360_remove,\n};\n\n \n\nstatic int __init pc87360_find(int sioaddr, u8 *devid,\n\t\t\t       unsigned short *addresses)\n{\n\tu16 val;\n\tint i;\n\tint nrdev;  \n\n\t \n\n\t \n\tval = force_id ? force_id : superio_inb(sioaddr, DEVID);\n\tswitch (val) {\n\tcase 0xE1:  \n\tcase 0xE8:  \n\tcase 0xE4:  \n\t\tnrdev = 1;\n\t\tbreak;\n\tcase 0xE5:  \n\tcase 0xE9:  \n\t\tnrdev = 3;\n\t\tbreak;\n\tdefault:\n\t\tsuperio_exit(sioaddr);\n\t\treturn -ENODEV;\n\t}\n\t \n\t*devid = val;\n\n\tfor (i = 0; i < nrdev; i++) {\n\t\t \n\t\tsuperio_outb(sioaddr, DEV, logdev[i]);\n\n\t\tval = superio_inb(sioaddr, ACT);\n\t\tif (!(val & 0x01)) {\n\t\t\tpr_info(\"Device 0x%02x not activated\\n\", logdev[i]);\n\t\t\tcontinue;\n\t\t}\n\n\t\tval = (superio_inb(sioaddr, BASE) << 8)\n\t\t    | superio_inb(sioaddr, BASE + 1);\n\t\tif (!val) {\n\t\t\tpr_info(\"Base address not set for device 0x%02x\\n\",\n\t\t\t\tlogdev[i]);\n\t\t\tcontinue;\n\t\t}\n\n\t\taddresses[i] = val;\n\n\t\tif (i == 0) {  \n\t\t\tconfreg[0] = superio_inb(sioaddr, 0xF0);\n\t\t\tconfreg[1] = superio_inb(sioaddr, 0xF1);\n\n\t\t\tpr_debug(\"Fan %d: mon=%d ctrl=%d inv=%d\\n\", 1,\n\t\t\t\t (confreg[0] >> 2) & 1, (confreg[0] >> 3) & 1,\n\t\t\t\t (confreg[0] >> 4) & 1);\n\t\t\tpr_debug(\"Fan %d: mon=%d ctrl=%d inv=%d\\n\", 2,\n\t\t\t\t (confreg[0] >> 5) & 1, (confreg[0] >> 6) & 1,\n\t\t\t\t (confreg[0] >> 7) & 1);\n\t\t\tpr_debug(\"Fan %d: mon=%d ctrl=%d inv=%d\\n\", 3,\n\t\t\t\t confreg[1] & 1, (confreg[1] >> 1) & 1,\n\t\t\t\t (confreg[1] >> 2) & 1);\n\t\t} else if (i == 1) {  \n\t\t\t \n\t\t\tif (*devid == 0xE9) {  \n\t\t\t\t \n\t\t\t\tconfreg[2] = superio_inb(sioaddr, 0x2B);\n\t\t\t\tconfreg[3] = superio_inb(sioaddr, 0x25);\n\n\t\t\t\tif (confreg[2] & 0x40) {\n\t\t\t\t\tpr_info(\"Using thermistors for temperature monitoring\\n\");\n\t\t\t\t}\n\t\t\t\tif (confreg[3] & 0xE0) {\n\t\t\t\t\tpr_info(\"VID inputs routed (mode %u)\\n\",\n\t\t\t\t\t\tconfreg[3] >> 5);\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t}\n\n\tsuperio_exit(sioaddr);\n\treturn 0;\n}\n\nstatic int __init pc87360_device_add(unsigned short address)\n{\n\tstruct resource res[3];\n\tint err, i, res_count;\n\n\tpdev = platform_device_alloc(\"pc87360\", address);\n\tif (!pdev) {\n\t\terr = -ENOMEM;\n\t\tpr_err(\"Device allocation failed\\n\");\n\t\tgoto exit;\n\t}\n\n\tmemset(res, 0, 3 * sizeof(struct resource));\n\tres_count = 0;\n\tfor (i = 0; i < 3; i++) {\n\t\tif (!extra_isa[i])\n\t\t\tcontinue;\n\t\tres[res_count].start = extra_isa[i];\n\t\tres[res_count].end = extra_isa[i] + PC87360_EXTENT - 1;\n\t\tres[res_count].name = \"pc87360\";\n\t\tres[res_count].flags = IORESOURCE_IO;\n\n\t\terr = acpi_check_resource_conflict(&res[res_count]);\n\t\tif (err)\n\t\t\tgoto exit_device_put;\n\n\t\tres_count++;\n\t}\n\n\terr = platform_device_add_resources(pdev, res, res_count);\n\tif (err) {\n\t\tpr_err(\"Device resources addition failed (%d)\\n\", err);\n\t\tgoto exit_device_put;\n\t}\n\n\terr = platform_device_add(pdev);\n\tif (err) {\n\t\tpr_err(\"Device addition failed (%d)\\n\", err);\n\t\tgoto exit_device_put;\n\t}\n\n\treturn 0;\n\nexit_device_put:\n\tplatform_device_put(pdev);\nexit:\n\treturn err;\n}\n\nstatic int __init pc87360_init(void)\n{\n\tint err, i;\n\tunsigned short address = 0;\n\n\tif (pc87360_find(0x2e, &devid, extra_isa)\n\t && pc87360_find(0x4e, &devid, extra_isa)) {\n\t\tpr_warn(\"PC8736x not detected, module not inserted\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tfor (i = 0; i < 3; i++) {\n\t\tif (extra_isa[i] != 0x0000) {\n\t\t\taddress = extra_isa[i];\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (address == 0x0000) {\n\t\tpr_warn(\"No active logical device, module not inserted\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\terr = platform_driver_register(&pc87360_driver);\n\tif (err)\n\t\tgoto exit;\n\n\t \n\terr = pc87360_device_add(address);\n\tif (err)\n\t\tgoto exit_driver;\n\n\treturn 0;\n\n exit_driver:\n\tplatform_driver_unregister(&pc87360_driver);\n exit:\n\treturn err;\n}\n\nstatic void __exit pc87360_exit(void)\n{\n\tplatform_device_unregister(pdev);\n\tplatform_driver_unregister(&pc87360_driver);\n}\n\nMODULE_AUTHOR(\"Jean Delvare <jdelvare@suse.de>\");\nMODULE_DESCRIPTION(\"PC8736x hardware monitor\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:\" DRIVER_NAME);\n\nmodule_init(pc87360_init);\nmodule_exit(pc87360_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}