{
  "module_name": "max1111.c",
  "hash_id": "6581683c3adbf77b5baaff80d4b5b17dfa747367e9d675db14f37cff0ded0e99",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/max1111.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/err.h>\n#include <linux/hwmon.h>\n#include <linux/hwmon-sysfs.h>\n#include <linux/spi/spi.h>\n#include <linux/slab.h>\n\nenum chips { max1110, max1111, max1112, max1113 };\n\n#define MAX1111_TX_BUF_SIZE\t1\n#define MAX1111_RX_BUF_SIZE\t2\n\n \n#define MAX1111_CTRL_PD0      (1u << 0)\n#define MAX1111_CTRL_PD1      (1u << 1)\n#define MAX1111_CTRL_SGL      (1u << 2)\n#define MAX1111_CTRL_UNI      (1u << 3)\n#define MAX1110_CTRL_SEL_SH   (4)\n#define MAX1111_CTRL_SEL_SH   (5)\t \n#define MAX1111_CTRL_STR      (1u << 7)\n\nstruct max1111_data {\n\tstruct spi_device\t*spi;\n\tstruct device\t\t*hwmon_dev;\n\tstruct spi_message\tmsg;\n\tstruct spi_transfer\txfer[2];\n\tuint8_t tx_buf[MAX1111_TX_BUF_SIZE];\n\tuint8_t rx_buf[MAX1111_RX_BUF_SIZE];\n\tstruct mutex\t\tdrvdata_lock;\n\t \n\tint\t\t\tsel_sh;\n\tint\t\t\tlsb;\n};\n\nstatic int max1111_read(struct device *dev, int channel)\n{\n\tstruct max1111_data *data = dev_get_drvdata(dev);\n\tuint8_t v1, v2;\n\tint err;\n\n\t \n\tmutex_lock(&data->drvdata_lock);\n\n\tdata->tx_buf[0] = (channel << data->sel_sh) |\n\t\tMAX1111_CTRL_PD0 | MAX1111_CTRL_PD1 |\n\t\tMAX1111_CTRL_SGL | MAX1111_CTRL_UNI | MAX1111_CTRL_STR;\n\n\terr = spi_sync(data->spi, &data->msg);\n\tif (err < 0) {\n\t\tdev_err(dev, \"spi_sync failed with %d\\n\", err);\n\t\tmutex_unlock(&data->drvdata_lock);\n\t\treturn err;\n\t}\n\n\tv1 = data->rx_buf[0];\n\tv2 = data->rx_buf[1];\n\n\tmutex_unlock(&data->drvdata_lock);\n\n\tif ((v1 & 0xc0) || (v2 & 0x3f))\n\t\treturn -EINVAL;\n\n\treturn (v1 << 2) | (v2 >> 6);\n}\n\n#ifdef CONFIG_SHARPSL_PM\nstatic struct max1111_data *the_max1111;\n\nint max1111_read_channel(int channel);\nint max1111_read_channel(int channel)\n{\n\tif (!the_max1111 || !the_max1111->spi)\n\t\treturn -ENODEV;\n\n\treturn max1111_read(&the_max1111->spi->dev, channel);\n}\nEXPORT_SYMBOL(max1111_read_channel);\n#endif\n\n \nstatic ssize_t name_show(struct device *dev,\n\t\t\t struct device_attribute *attr, char *buf)\n{\n\treturn sprintf(buf, \"%s\\n\", to_spi_device(dev)->modalias);\n}\n\nstatic ssize_t show_adc(struct device *dev,\n\t\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct max1111_data *data = dev_get_drvdata(dev);\n\tint channel = to_sensor_dev_attr(attr)->index;\n\tint ret;\n\n\tret = max1111_read(dev, channel);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\treturn sprintf(buf, \"%d\\n\", ret * data->lsb);\n}\n\n#define MAX1111_ADC_ATTR(_id)\t\t\\\n\tSENSOR_DEVICE_ATTR(in##_id##_input, S_IRUGO, show_adc, NULL, _id)\n\nstatic DEVICE_ATTR_RO(name);\nstatic MAX1111_ADC_ATTR(0);\nstatic MAX1111_ADC_ATTR(1);\nstatic MAX1111_ADC_ATTR(2);\nstatic MAX1111_ADC_ATTR(3);\nstatic MAX1111_ADC_ATTR(4);\nstatic MAX1111_ADC_ATTR(5);\nstatic MAX1111_ADC_ATTR(6);\nstatic MAX1111_ADC_ATTR(7);\n\nstatic struct attribute *max1111_attributes[] = {\n\t&dev_attr_name.attr,\n\t&sensor_dev_attr_in0_input.dev_attr.attr,\n\t&sensor_dev_attr_in1_input.dev_attr.attr,\n\t&sensor_dev_attr_in2_input.dev_attr.attr,\n\t&sensor_dev_attr_in3_input.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group max1111_attr_group = {\n\t.attrs\t= max1111_attributes,\n};\n\nstatic struct attribute *max1110_attributes[] = {\n\t&sensor_dev_attr_in4_input.dev_attr.attr,\n\t&sensor_dev_attr_in5_input.dev_attr.attr,\n\t&sensor_dev_attr_in6_input.dev_attr.attr,\n\t&sensor_dev_attr_in7_input.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group max1110_attr_group = {\n\t.attrs\t= max1110_attributes,\n};\n\nstatic int setup_transfer(struct max1111_data *data)\n{\n\tstruct spi_message *m;\n\tstruct spi_transfer *x;\n\n\tm = &data->msg;\n\tx = &data->xfer[0];\n\n\tspi_message_init(m);\n\n\tx->tx_buf = &data->tx_buf[0];\n\tx->len = MAX1111_TX_BUF_SIZE;\n\tspi_message_add_tail(x, m);\n\n\tx++;\n\tx->rx_buf = &data->rx_buf[0];\n\tx->len = MAX1111_RX_BUF_SIZE;\n\tspi_message_add_tail(x, m);\n\n\treturn 0;\n}\n\nstatic int max1111_probe(struct spi_device *spi)\n{\n\tenum chips chip = spi_get_device_id(spi)->driver_data;\n\tstruct max1111_data *data;\n\tint err;\n\n\tspi->bits_per_word = 8;\n\tspi->mode = SPI_MODE_0;\n\terr = spi_setup(spi);\n\tif (err < 0)\n\t\treturn err;\n\n\tdata = devm_kzalloc(&spi->dev, sizeof(struct max1111_data), GFP_KERNEL);\n\tif (data == NULL)\n\t\treturn -ENOMEM;\n\n\tswitch (chip) {\n\tcase max1110:\n\t\tdata->lsb = 8;\n\t\tdata->sel_sh = MAX1110_CTRL_SEL_SH;\n\t\tbreak;\n\tcase max1111:\n\t\tdata->lsb = 8;\n\t\tdata->sel_sh = MAX1111_CTRL_SEL_SH;\n\t\tbreak;\n\tcase max1112:\n\t\tdata->lsb = 16;\n\t\tdata->sel_sh = MAX1110_CTRL_SEL_SH;\n\t\tbreak;\n\tcase max1113:\n\t\tdata->lsb = 16;\n\t\tdata->sel_sh = MAX1111_CTRL_SEL_SH;\n\t\tbreak;\n\t}\n\terr = setup_transfer(data);\n\tif (err)\n\t\treturn err;\n\n\tmutex_init(&data->drvdata_lock);\n\n\tdata->spi = spi;\n\tspi_set_drvdata(spi, data);\n\n\terr = sysfs_create_group(&spi->dev.kobj, &max1111_attr_group);\n\tif (err) {\n\t\tdev_err(&spi->dev, \"failed to create attribute group\\n\");\n\t\treturn err;\n\t}\n\tif (chip == max1110 || chip == max1112) {\n\t\terr = sysfs_create_group(&spi->dev.kobj, &max1110_attr_group);\n\t\tif (err) {\n\t\t\tdev_err(&spi->dev,\n\t\t\t\t\"failed to create extended attribute group\\n\");\n\t\t\tgoto err_remove;\n\t\t}\n\t}\n\n\tdata->hwmon_dev = hwmon_device_register(&spi->dev);\n\tif (IS_ERR(data->hwmon_dev)) {\n\t\tdev_err(&spi->dev, \"failed to create hwmon device\\n\");\n\t\terr = PTR_ERR(data->hwmon_dev);\n\t\tgoto err_remove;\n\t}\n\n#ifdef CONFIG_SHARPSL_PM\n\tthe_max1111 = data;\n#endif\n\treturn 0;\n\nerr_remove:\n\tsysfs_remove_group(&spi->dev.kobj, &max1110_attr_group);\n\tsysfs_remove_group(&spi->dev.kobj, &max1111_attr_group);\n\treturn err;\n}\n\nstatic void max1111_remove(struct spi_device *spi)\n{\n\tstruct max1111_data *data = spi_get_drvdata(spi);\n\n#ifdef CONFIG_SHARPSL_PM\n\tthe_max1111 = NULL;\n#endif\n\thwmon_device_unregister(data->hwmon_dev);\n\tsysfs_remove_group(&spi->dev.kobj, &max1110_attr_group);\n\tsysfs_remove_group(&spi->dev.kobj, &max1111_attr_group);\n\tmutex_destroy(&data->drvdata_lock);\n}\n\nstatic const struct spi_device_id max1111_ids[] = {\n\t{ \"max1110\", max1110 },\n\t{ \"max1111\", max1111 },\n\t{ \"max1112\", max1112 },\n\t{ \"max1113\", max1113 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(spi, max1111_ids);\n\nstatic struct spi_driver max1111_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"max1111\",\n\t},\n\t.id_table\t= max1111_ids,\n\t.probe\t\t= max1111_probe,\n\t.remove\t\t= max1111_remove,\n};\n\nmodule_spi_driver(max1111_driver);\n\nMODULE_AUTHOR(\"Eric Miao <eric.miao@marvell.com>\");\nMODULE_DESCRIPTION(\"MAX1110/MAX1111/MAX1112/MAX1113 ADC Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}