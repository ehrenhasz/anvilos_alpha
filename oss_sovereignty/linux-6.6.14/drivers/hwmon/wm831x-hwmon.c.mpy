{
  "module_name": "wm831x-hwmon.c",
  "hash_id": "dbccfbc761dcb344c9fb0795075b7d5e31aff59d615a74fcadc6f00a787e7e06",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/wm831x-hwmon.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/err.h>\n#include <linux/hwmon.h>\n#include <linux/hwmon-sysfs.h>\n#include <linux/slab.h>\n\n#include <linux/mfd/wm831x/core.h>\n#include <linux/mfd/wm831x/auxadc.h>\n\nstatic const char * const input_names[] = {\n\t[WM831X_AUX_SYSVDD]    = \"SYSVDD\",\n\t[WM831X_AUX_USB]       = \"USB\",\n\t[WM831X_AUX_BKUP_BATT] = \"Backup battery\",\n\t[WM831X_AUX_BATT]      = \"Battery\",\n\t[WM831X_AUX_WALL]      = \"WALL\",\n\t[WM831X_AUX_CHIP_TEMP] = \"PMIC\",\n\t[WM831X_AUX_BATT_TEMP] = \"Battery\",\n};\n\nstatic ssize_t show_voltage(struct device *dev,\n\t\t\t    struct device_attribute *attr, char *buf)\n{\n\tstruct wm831x *wm831x = dev_get_drvdata(dev);\n\tint channel = to_sensor_dev_attr(attr)->index;\n\tint ret;\n\n\tret = wm831x_auxadc_read_uv(wm831x, channel);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn sprintf(buf, \"%d\\n\", DIV_ROUND_CLOSEST(ret, 1000));\n}\n\nstatic ssize_t show_chip_temp(struct device *dev,\n\t\t\t      struct device_attribute *attr, char *buf)\n{\n\tstruct wm831x *wm831x = dev_get_drvdata(dev);\n\tint channel = to_sensor_dev_attr(attr)->index;\n\tint ret;\n\n\tret = wm831x_auxadc_read(wm831x, channel);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = 512180 - (ret * 1000);\n\tret = DIV_ROUND_CLOSEST(ret * 10000, 10983);\n\n\treturn sprintf(buf, \"%d\\n\", ret);\n}\n\nstatic ssize_t show_label(struct device *dev,\n\t\t\t  struct device_attribute *attr, char *buf)\n{\n\tint channel = to_sensor_dev_attr(attr)->index;\n\n\treturn sprintf(buf, \"%s\\n\", input_names[channel]);\n}\n\n#define WM831X_VOLTAGE(id, name) \\\n\tstatic SENSOR_DEVICE_ATTR(in##id##_input, S_IRUGO, show_voltage, \\\n\t\t\t\t  NULL, name)\n\n#define WM831X_NAMED_VOLTAGE(id, name) \\\n\tWM831X_VOLTAGE(id, name); \\\n\tstatic SENSOR_DEVICE_ATTR(in##id##_label, S_IRUGO, show_label,\t\\\n\t\t\t\t  NULL, name)\n\nWM831X_VOLTAGE(0, WM831X_AUX_AUX1);\nWM831X_VOLTAGE(1, WM831X_AUX_AUX2);\nWM831X_VOLTAGE(2, WM831X_AUX_AUX3);\nWM831X_VOLTAGE(3, WM831X_AUX_AUX4);\n\nWM831X_NAMED_VOLTAGE(4, WM831X_AUX_SYSVDD);\nWM831X_NAMED_VOLTAGE(5, WM831X_AUX_USB);\nWM831X_NAMED_VOLTAGE(6, WM831X_AUX_BATT);\nWM831X_NAMED_VOLTAGE(7, WM831X_AUX_WALL);\nWM831X_NAMED_VOLTAGE(8, WM831X_AUX_BKUP_BATT);\n\nstatic SENSOR_DEVICE_ATTR(temp1_input, S_IRUGO, show_chip_temp, NULL,\n\t\t\t  WM831X_AUX_CHIP_TEMP);\nstatic SENSOR_DEVICE_ATTR(temp1_label, S_IRUGO, show_label, NULL,\n\t\t\t  WM831X_AUX_CHIP_TEMP);\n \nstatic SENSOR_DEVICE_ATTR(temp2_input, S_IRUGO, show_voltage, NULL,\n\t\t\t  WM831X_AUX_BATT_TEMP);\nstatic SENSOR_DEVICE_ATTR(temp2_label, S_IRUGO, show_label, NULL,\n\t\t\t  WM831X_AUX_BATT_TEMP);\n\nstatic struct attribute *wm831x_attrs[] = {\n\t&sensor_dev_attr_in0_input.dev_attr.attr,\n\t&sensor_dev_attr_in1_input.dev_attr.attr,\n\t&sensor_dev_attr_in2_input.dev_attr.attr,\n\t&sensor_dev_attr_in3_input.dev_attr.attr,\n\n\t&sensor_dev_attr_in4_input.dev_attr.attr,\n\t&sensor_dev_attr_in4_label.dev_attr.attr,\n\t&sensor_dev_attr_in5_input.dev_attr.attr,\n\t&sensor_dev_attr_in5_label.dev_attr.attr,\n\t&sensor_dev_attr_in6_input.dev_attr.attr,\n\t&sensor_dev_attr_in6_label.dev_attr.attr,\n\t&sensor_dev_attr_in7_input.dev_attr.attr,\n\t&sensor_dev_attr_in7_label.dev_attr.attr,\n\t&sensor_dev_attr_in8_input.dev_attr.attr,\n\t&sensor_dev_attr_in8_label.dev_attr.attr,\n\n\t&sensor_dev_attr_temp1_input.dev_attr.attr,\n\t&sensor_dev_attr_temp1_label.dev_attr.attr,\n\t&sensor_dev_attr_temp2_input.dev_attr.attr,\n\t&sensor_dev_attr_temp2_label.dev_attr.attr,\n\n\tNULL\n};\n\nATTRIBUTE_GROUPS(wm831x);\n\nstatic int wm831x_hwmon_probe(struct platform_device *pdev)\n{\n\tstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\n\tstruct device *hwmon_dev;\n\n\thwmon_dev = devm_hwmon_device_register_with_groups(&pdev->dev, \"wm831x\",\n\t\t\t\t\t\t\t   wm831x,\n\t\t\t\t\t\t\t   wm831x_groups);\n\treturn PTR_ERR_OR_ZERO(hwmon_dev);\n}\n\nstatic struct platform_driver wm831x_hwmon_driver = {\n\t.probe = wm831x_hwmon_probe,\n\t.driver = {\n\t\t.name = \"wm831x-hwmon\",\n\t},\n};\n\nmodule_platform_driver(wm831x_hwmon_driver);\n\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\nMODULE_DESCRIPTION(\"WM831x Hardware Monitoring\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:wm831x-hwmon\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}