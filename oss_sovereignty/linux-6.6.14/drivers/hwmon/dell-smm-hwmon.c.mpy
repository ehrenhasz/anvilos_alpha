{
  "module_name": "dell-smm-hwmon.c",
  "hash_id": "0cd1a649cb43b9cacca52aceb49dcc9a77384a11c407cc12dbf61f7387e53144",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/dell-smm-hwmon.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/capability.h>\n#include <linux/cpu.h>\n#include <linux/ctype.h>\n#include <linux/delay.h>\n#include <linux/dmi.h>\n#include <linux/err.h>\n#include <linux/errno.h>\n#include <linux/hwmon.h>\n#include <linux/init.h>\n#include <linux/kconfig.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/platform_device.h>\n#include <linux/proc_fs.h>\n#include <linux/seq_file.h>\n#include <linux/slab.h>\n#include <linux/smp.h>\n#include <linux/string.h>\n#include <linux/thermal.h>\n#include <linux/types.h>\n#include <linux/uaccess.h>\n\n#include <linux/i8k.h>\n\n#define I8K_SMM_FN_STATUS\t0x0025\n#define I8K_SMM_POWER_STATUS\t0x0069\n#define I8K_SMM_SET_FAN\t\t0x01a3\n#define I8K_SMM_GET_FAN\t\t0x00a3\n#define I8K_SMM_GET_SPEED\t0x02a3\n#define I8K_SMM_GET_FAN_TYPE\t0x03a3\n#define I8K_SMM_GET_NOM_SPEED\t0x04a3\n#define I8K_SMM_GET_TEMP\t0x10a3\n#define I8K_SMM_GET_TEMP_TYPE\t0x11a3\n#define I8K_SMM_GET_DELL_SIG1\t0xfea3\n#define I8K_SMM_GET_DELL_SIG2\t0xffa3\n\n \n#define DELL_SMM_MAX_DURATION  250000\n\n#define I8K_FAN_MULT\t\t30\n#define I8K_FAN_RPM_THRESHOLD\t1000\n#define I8K_MAX_TEMP\t\t127\n\n#define I8K_FN_NONE\t\t0x00\n#define I8K_FN_UP\t\t0x01\n#define I8K_FN_DOWN\t\t0x02\n#define I8K_FN_MUTE\t\t0x04\n#define I8K_FN_MASK\t\t0x07\n#define I8K_FN_SHIFT\t\t8\n\n#define I8K_POWER_AC\t\t0x05\n#define I8K_POWER_BATTERY\t0x01\n\n#define DELL_SMM_NO_TEMP\t10\n#define DELL_SMM_NO_FANS\t3\n\nstruct dell_smm_data {\n\tstruct mutex i8k_mutex;  \n\tchar bios_version[4];\n\tchar bios_machineid[16];\n\tuint i8k_fan_mult;\n\tuint i8k_pwm_mult;\n\tuint i8k_fan_max;\n\tbool disallow_fan_type_call;\n\tbool disallow_fan_support;\n\tunsigned int manual_fan;\n\tunsigned int auto_fan;\n\tint temp_type[DELL_SMM_NO_TEMP];\n\tbool fan[DELL_SMM_NO_FANS];\n\tint fan_type[DELL_SMM_NO_FANS];\n\tint *fan_nominal_speed[DELL_SMM_NO_FANS];\n};\n\nstruct dell_smm_cooling_data {\n\tu8 fan_num;\n\tstruct dell_smm_data *data;\n};\n\nMODULE_AUTHOR(\"Massimo Dal Zotto (dz@debian.org)\");\nMODULE_AUTHOR(\"Pali Roh\u00e1r <pali@kernel.org>\");\nMODULE_DESCRIPTION(\"Dell laptop SMM BIOS hwmon driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"i8k\");\n\nstatic bool force;\nmodule_param_unsafe(force, bool, 0);\nMODULE_PARM_DESC(force, \"Force loading without checking for supported models and features\");\n\nstatic bool ignore_dmi;\nmodule_param(ignore_dmi, bool, 0);\nMODULE_PARM_DESC(ignore_dmi, \"Continue probing hardware even if DMI data does not match\");\n\n#if IS_ENABLED(CONFIG_I8K)\nstatic bool restricted = true;\nmodule_param(restricted, bool, 0);\nMODULE_PARM_DESC(restricted, \"Restrict fan control and serial number to CAP_SYS_ADMIN (default: 1)\");\n\nstatic bool power_status;\nmodule_param(power_status, bool, 0600);\nMODULE_PARM_DESC(power_status, \"Report power status in /proc/i8k (default: 0)\");\n#endif\n\nstatic uint fan_mult;\nmodule_param(fan_mult, uint, 0);\nMODULE_PARM_DESC(fan_mult, \"Factor to multiply fan speed with (default: autodetect)\");\n\nstatic uint fan_max;\nmodule_param(fan_max, uint, 0);\nMODULE_PARM_DESC(fan_max, \"Maximum configurable fan speed (default: autodetect)\");\n\nstruct smm_regs {\n\tunsigned int eax;\n\tunsigned int ebx;\n\tunsigned int ecx;\n\tunsigned int edx;\n\tunsigned int esi;\n\tunsigned int edi;\n};\n\nstatic const char * const temp_labels[] = {\n\t\"CPU\",\n\t\"GPU\",\n\t\"SODIMM\",\n\t\"Other\",\n\t\"Ambient\",\n\t\"Other\",\n};\n\nstatic const char * const fan_labels[] = {\n\t\"Processor Fan\",\n\t\"Motherboard Fan\",\n\t\"Video Fan\",\n\t\"Power Supply Fan\",\n\t\"Chipset Fan\",\n\t\"Other Fan\",\n};\n\nstatic const char * const docking_labels[] = {\n\t\"Docking Processor Fan\",\n\t\"Docking Motherboard Fan\",\n\t\"Docking Video Fan\",\n\t\"Docking Power Supply Fan\",\n\t\"Docking Chipset Fan\",\n\t\"Docking Other Fan\",\n};\n\nstatic inline const char __init *i8k_get_dmi_data(int field)\n{\n\tconst char *dmi_data = dmi_get_system_info(field);\n\n\treturn dmi_data && *dmi_data ? dmi_data : \"?\";\n}\n\n \nstatic int i8k_smm_func(void *par)\n{\n\tktime_t calltime = ktime_get();\n\tstruct smm_regs *regs = par;\n\tint eax = regs->eax;\n\tint ebx = regs->ebx;\n\tunsigned char carry;\n\tlong long duration;\n\n\t \n\tif (smp_processor_id() != 0)\n\t\treturn -EBUSY;\n\n\tasm volatile(\"out %%al,$0xb2\\n\\t\"\n\t\t     \"out %%al,$0x84\\n\\t\"\n\t\t     \"setc %0\\n\"\n\t\t     : \"=mr\" (carry),\n\t\t       \"+a\" (regs->eax),\n\t\t       \"+b\" (regs->ebx),\n\t\t       \"+c\" (regs->ecx),\n\t\t       \"+d\" (regs->edx),\n\t\t       \"+S\" (regs->esi),\n\t\t       \"+D\" (regs->edi));\n\n\tduration = ktime_us_delta(ktime_get(), calltime);\n\tpr_debug(\"smm(0x%.4x 0x%.4x) = 0x%.4x carry: %d (took %7lld usecs)\\n\",\n\t\t eax, ebx, regs->eax & 0xffff, carry, duration);\n\n\tif (duration > DELL_SMM_MAX_DURATION)\n\t\tpr_warn_once(\"SMM call took %lld usecs!\\n\", duration);\n\n\tif (carry || (regs->eax & 0xffff) == 0xffff || regs->eax == eax)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\n \nstatic int i8k_smm(struct smm_regs *regs)\n{\n\tint ret;\n\n\tcpus_read_lock();\n\tret = smp_call_on_cpu(0, i8k_smm_func, regs, true);\n\tcpus_read_unlock();\n\n\treturn ret;\n}\n\n \nstatic int i8k_get_fan_status(const struct dell_smm_data *data, u8 fan)\n{\n\tstruct smm_regs regs = {\n\t\t.eax = I8K_SMM_GET_FAN,\n\t\t.ebx = fan,\n\t};\n\n\tif (data->disallow_fan_support)\n\t\treturn -EINVAL;\n\n\treturn i8k_smm(&regs) ? : regs.eax & 0xff;\n}\n\n \nstatic int i8k_get_fan_speed(const struct dell_smm_data *data, u8 fan)\n{\n\tstruct smm_regs regs = {\n\t\t.eax = I8K_SMM_GET_SPEED,\n\t\t.ebx = fan,\n\t};\n\n\tif (data->disallow_fan_support)\n\t\treturn -EINVAL;\n\n\treturn i8k_smm(&regs) ? : (regs.eax & 0xffff) * data->i8k_fan_mult;\n}\n\n \nstatic int _i8k_get_fan_type(const struct dell_smm_data *data, u8 fan)\n{\n\tstruct smm_regs regs = {\n\t\t.eax = I8K_SMM_GET_FAN_TYPE,\n\t\t.ebx = fan,\n\t};\n\n\tif (data->disallow_fan_support || data->disallow_fan_type_call)\n\t\treturn -EINVAL;\n\n\treturn i8k_smm(&regs) ? : regs.eax & 0xff;\n}\n\nstatic int i8k_get_fan_type(struct dell_smm_data *data, u8 fan)\n{\n\t \n\tif (data->fan_type[fan] == INT_MIN)\n\t\tdata->fan_type[fan] = _i8k_get_fan_type(data, fan);\n\n\treturn data->fan_type[fan];\n}\n\n \nstatic int __init i8k_get_fan_nominal_speed(const struct dell_smm_data *data, u8 fan, int speed)\n{\n\tstruct smm_regs regs = {\n\t\t.eax = I8K_SMM_GET_NOM_SPEED,\n\t\t.ebx = fan | (speed << 8),\n\t};\n\n\tif (data->disallow_fan_support)\n\t\treturn -EINVAL;\n\n\treturn i8k_smm(&regs) ? : (regs.eax & 0xffff);\n}\n\n \nstatic int i8k_enable_fan_auto_mode(const struct dell_smm_data *data, bool enable)\n{\n\tstruct smm_regs regs = { };\n\n\tif (data->disallow_fan_support)\n\t\treturn -EINVAL;\n\n\tregs.eax = enable ? data->auto_fan : data->manual_fan;\n\treturn i8k_smm(&regs);\n}\n\n \nstatic int i8k_set_fan(const struct dell_smm_data *data, u8 fan, int speed)\n{\n\tstruct smm_regs regs = { .eax = I8K_SMM_SET_FAN, };\n\n\tif (data->disallow_fan_support)\n\t\treturn -EINVAL;\n\n\tspeed = (speed < 0) ? 0 : ((speed > data->i8k_fan_max) ? data->i8k_fan_max : speed);\n\tregs.ebx = fan | (speed << 8);\n\n\treturn i8k_smm(&regs);\n}\n\nstatic int __init i8k_get_temp_type(u8 sensor)\n{\n\tstruct smm_regs regs = {\n\t\t.eax = I8K_SMM_GET_TEMP_TYPE,\n\t\t.ebx = sensor,\n\t};\n\n\treturn i8k_smm(&regs) ? : regs.eax & 0xff;\n}\n\n \nstatic int _i8k_get_temp(u8 sensor)\n{\n\tstruct smm_regs regs = {\n\t\t.eax = I8K_SMM_GET_TEMP,\n\t\t.ebx = sensor,\n\t};\n\n\treturn i8k_smm(&regs) ? : regs.eax & 0xff;\n}\n\nstatic int i8k_get_temp(u8 sensor)\n{\n\tint temp = _i8k_get_temp(sensor);\n\n\t \n\tif (temp == 0x99) {\n\t\tmsleep(100);\n\t\ttemp = _i8k_get_temp(sensor);\n\t}\n\t \n\tif (temp > I8K_MAX_TEMP)\n\t\treturn -ENODATA;\n\n\treturn temp;\n}\n\nstatic int __init i8k_get_dell_signature(int req_fn)\n{\n\tstruct smm_regs regs = { .eax = req_fn, };\n\tint rc;\n\n\trc = i8k_smm(&regs);\n\tif (rc < 0)\n\t\treturn rc;\n\n\treturn regs.eax == 1145651527 && regs.edx == 1145392204 ? 0 : -1;\n}\n\n#if IS_ENABLED(CONFIG_I8K)\n\n \nstatic int i8k_get_fn_status(void)\n{\n\tstruct smm_regs regs = { .eax = I8K_SMM_FN_STATUS, };\n\tint rc;\n\n\trc = i8k_smm(&regs);\n\tif (rc < 0)\n\t\treturn rc;\n\n\tswitch ((regs.eax >> I8K_FN_SHIFT) & I8K_FN_MASK) {\n\tcase I8K_FN_UP:\n\t\treturn I8K_VOL_UP;\n\tcase I8K_FN_DOWN:\n\t\treturn I8K_VOL_DOWN;\n\tcase I8K_FN_MUTE:\n\t\treturn I8K_VOL_MUTE;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\n \nstatic int i8k_get_power_status(void)\n{\n\tstruct smm_regs regs = { .eax = I8K_SMM_POWER_STATUS, };\n\tint rc;\n\n\trc = i8k_smm(&regs);\n\tif (rc < 0)\n\t\treturn rc;\n\n\treturn (regs.eax & 0xff) == I8K_POWER_AC ? I8K_AC : I8K_BATTERY;\n}\n\n \n\nstatic long i8k_ioctl(struct file *fp, unsigned int cmd, unsigned long arg)\n{\n\tstruct dell_smm_data *data = pde_data(file_inode(fp));\n\tint __user *argp = (int __user *)arg;\n\tint speed, err;\n\tint val = 0;\n\n\tif (!argp)\n\t\treturn -EINVAL;\n\n\tswitch (cmd) {\n\tcase I8K_BIOS_VERSION:\n\t\tif (!isdigit(data->bios_version[0]) || !isdigit(data->bios_version[1]) ||\n\t\t    !isdigit(data->bios_version[2]))\n\t\t\treturn -EINVAL;\n\n\t\tval = (data->bios_version[0] << 16) |\n\t\t\t\t(data->bios_version[1] << 8) | data->bios_version[2];\n\n\t\tif (copy_to_user(argp, &val, sizeof(val)))\n\t\t\treturn -EFAULT;\n\n\t\treturn 0;\n\tcase I8K_MACHINE_ID:\n\t\tif (restricted && !capable(CAP_SYS_ADMIN))\n\t\t\treturn -EPERM;\n\n\t\tif (copy_to_user(argp, data->bios_machineid, sizeof(data->bios_machineid)))\n\t\t\treturn -EFAULT;\n\n\t\treturn 0;\n\tcase I8K_FN_STATUS:\n\t\tval = i8k_get_fn_status();\n\t\tbreak;\n\n\tcase I8K_POWER_STATUS:\n\t\tval = i8k_get_power_status();\n\t\tbreak;\n\n\tcase I8K_GET_TEMP:\n\t\tval = i8k_get_temp(0);\n\t\tbreak;\n\n\tcase I8K_GET_SPEED:\n\t\tif (copy_from_user(&val, argp, sizeof(int)))\n\t\t\treturn -EFAULT;\n\n\t\tif (val > U8_MAX || val < 0)\n\t\t\treturn -EINVAL;\n\n\t\tval = i8k_get_fan_speed(data, val);\n\t\tbreak;\n\n\tcase I8K_GET_FAN:\n\t\tif (copy_from_user(&val, argp, sizeof(int)))\n\t\t\treturn -EFAULT;\n\n\t\tif (val > U8_MAX || val < 0)\n\t\t\treturn -EINVAL;\n\n\t\tval = i8k_get_fan_status(data, val);\n\t\tbreak;\n\n\tcase I8K_SET_FAN:\n\t\tif (restricted && !capable(CAP_SYS_ADMIN))\n\t\t\treturn -EPERM;\n\n\t\tif (copy_from_user(&val, argp, sizeof(int)))\n\t\t\treturn -EFAULT;\n\n\t\tif (val > U8_MAX || val < 0)\n\t\t\treturn -EINVAL;\n\n\t\tif (copy_from_user(&speed, argp + 1, sizeof(int)))\n\t\t\treturn -EFAULT;\n\n\t\tmutex_lock(&data->i8k_mutex);\n\t\terr = i8k_set_fan(data, val, speed);\n\t\tif (err < 0)\n\t\t\tval = err;\n\t\telse\n\t\t\tval = i8k_get_fan_status(data, val);\n\t\tmutex_unlock(&data->i8k_mutex);\n\t\tbreak;\n\n\tdefault:\n\t\treturn -ENOIOCTLCMD;\n\t}\n\n\tif (val < 0)\n\t\treturn val;\n\n\tif (copy_to_user(argp, &val, sizeof(int)))\n\t\treturn -EFAULT;\n\n\treturn 0;\n}\n\n \nstatic int i8k_proc_show(struct seq_file *seq, void *offset)\n{\n\tstruct dell_smm_data *data = seq->private;\n\tint fn_key, cpu_temp, ac_power;\n\tint left_fan, right_fan, left_speed, right_speed;\n\n\tcpu_temp\t= i8k_get_temp(0);\t\t\t\t \n\tleft_fan\t= i8k_get_fan_status(data, I8K_FAN_LEFT);\t \n\tright_fan\t= i8k_get_fan_status(data, I8K_FAN_RIGHT);\t \n\tleft_speed\t= i8k_get_fan_speed(data, I8K_FAN_LEFT);\t \n\tright_speed\t= i8k_get_fan_speed(data, I8K_FAN_RIGHT);\t \n\tfn_key\t\t= i8k_get_fn_status();\t\t\t\t \n\tif (power_status)\n\t\tac_power = i8k_get_power_status();\t\t\t \n\telse\n\t\tac_power = -1;\n\n\t \n\tseq_printf(seq, \"%s %s %s %d %d %d %d %d %d %d\\n\",\n\t\t   I8K_PROC_FMT,\n\t\t   data->bios_version,\n\t\t   (restricted && !capable(CAP_SYS_ADMIN)) ? \"-1\" : data->bios_machineid,\n\t\t   cpu_temp,\n\t\t   left_fan, right_fan, left_speed, right_speed,\n\t\t   ac_power, fn_key);\n\n\treturn 0;\n}\n\nstatic int i8k_open_fs(struct inode *inode, struct file *file)\n{\n\treturn single_open(file, i8k_proc_show, pde_data(inode));\n}\n\nstatic const struct proc_ops i8k_proc_ops = {\n\t.proc_open\t= i8k_open_fs,\n\t.proc_read\t= seq_read,\n\t.proc_lseek\t= seq_lseek,\n\t.proc_release\t= single_release,\n\t.proc_ioctl\t= i8k_ioctl,\n};\n\nstatic void i8k_exit_procfs(void *param)\n{\n\tremove_proc_entry(\"i8k\", NULL);\n}\n\nstatic void __init i8k_init_procfs(struct device *dev)\n{\n\tstruct dell_smm_data *data = dev_get_drvdata(dev);\n\n\t \n\tif (proc_create_data(\"i8k\", 0, NULL, &i8k_proc_ops, data))\n\t\tdevm_add_action_or_reset(dev, i8k_exit_procfs, NULL);\n}\n\n#else\n\nstatic void __init i8k_init_procfs(struct device *dev)\n{\n}\n\n#endif\n\nstatic int dell_smm_get_max_state(struct thermal_cooling_device *dev, unsigned long *state)\n{\n\tstruct dell_smm_cooling_data *cdata = dev->devdata;\n\n\t*state = cdata->data->i8k_fan_max;\n\n\treturn 0;\n}\n\nstatic int dell_smm_get_cur_state(struct thermal_cooling_device *dev, unsigned long *state)\n{\n\tstruct dell_smm_cooling_data *cdata = dev->devdata;\n\tint ret;\n\n\tret = i8k_get_fan_status(cdata->data, cdata->fan_num);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*state = ret;\n\n\treturn 0;\n}\n\nstatic int dell_smm_set_cur_state(struct thermal_cooling_device *dev, unsigned long state)\n{\n\tstruct dell_smm_cooling_data *cdata = dev->devdata;\n\tstruct dell_smm_data *data = cdata->data;\n\tint ret;\n\n\tif (state > data->i8k_fan_max)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&data->i8k_mutex);\n\tret = i8k_set_fan(data, cdata->fan_num, (int)state);\n\tmutex_unlock(&data->i8k_mutex);\n\n\treturn ret;\n}\n\nstatic const struct thermal_cooling_device_ops dell_smm_cooling_ops = {\n\t.get_max_state = dell_smm_get_max_state,\n\t.get_cur_state = dell_smm_get_cur_state,\n\t.set_cur_state = dell_smm_set_cur_state,\n};\n\nstatic umode_t dell_smm_is_visible(const void *drvdata, enum hwmon_sensor_types type, u32 attr,\n\t\t\t\t   int channel)\n{\n\tconst struct dell_smm_data *data = drvdata;\n\n\tswitch (type) {\n\tcase hwmon_temp:\n\t\tswitch (attr) {\n\t\tcase hwmon_temp_input:\n\t\t\t \n\t\t\tif (data->temp_type[channel] >= 0 || _i8k_get_temp(channel) >= 0)\n\t\t\t\treturn 0444;\n\n\t\t\tbreak;\n\t\tcase hwmon_temp_label:\n\t\t\tif (data->temp_type[channel] >= 0)\n\t\t\t\treturn 0444;\n\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase hwmon_fan:\n\t\tif (data->disallow_fan_support)\n\t\t\tbreak;\n\n\t\tswitch (attr) {\n\t\tcase hwmon_fan_input:\n\t\t\tif (data->fan[channel])\n\t\t\t\treturn 0444;\n\n\t\t\tbreak;\n\t\tcase hwmon_fan_label:\n\t\t\tif (data->fan[channel] && !data->disallow_fan_type_call)\n\t\t\t\treturn 0444;\n\n\t\t\tbreak;\n\t\tcase hwmon_fan_min:\n\t\tcase hwmon_fan_max:\n\t\tcase hwmon_fan_target:\n\t\t\tif (data->fan_nominal_speed[channel])\n\t\t\t\treturn 0444;\n\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase hwmon_pwm:\n\t\tif (data->disallow_fan_support)\n\t\t\tbreak;\n\n\t\tswitch (attr) {\n\t\tcase hwmon_pwm_input:\n\t\t\tif (data->fan[channel])\n\t\t\t\treturn 0644;\n\n\t\t\tbreak;\n\t\tcase hwmon_pwm_enable:\n\t\t\tif (data->auto_fan)\n\t\t\t\t \n\t\t\t\treturn 0200;\n\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int dell_smm_read(struct device *dev, enum hwmon_sensor_types type, u32 attr, int channel,\n\t\t\t long *val)\n{\n\tstruct dell_smm_data *data = dev_get_drvdata(dev);\n\tint mult = data->i8k_fan_mult;\n\tint ret;\n\n\tswitch (type) {\n\tcase hwmon_temp:\n\t\tswitch (attr) {\n\t\tcase hwmon_temp_input:\n\t\t\tret = i8k_get_temp(channel);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\n\t\t\t*val = ret * 1000;\n\n\t\t\treturn 0;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase hwmon_fan:\n\t\tswitch (attr) {\n\t\tcase hwmon_fan_input:\n\t\t\tret = i8k_get_fan_speed(data, channel);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\n\t\t\t*val = ret;\n\n\t\t\treturn 0;\n\t\tcase hwmon_fan_min:\n\t\t\t*val = data->fan_nominal_speed[channel][0] * mult;\n\n\t\t\treturn 0;\n\t\tcase hwmon_fan_max:\n\t\t\t*val = data->fan_nominal_speed[channel][data->i8k_fan_max] * mult;\n\n\t\t\treturn 0;\n\t\tcase hwmon_fan_target:\n\t\t\tret = i8k_get_fan_status(data, channel);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\n\t\t\tif (ret > data->i8k_fan_max)\n\t\t\t\tret = data->i8k_fan_max;\n\n\t\t\t*val = data->fan_nominal_speed[channel][ret] * mult;\n\n\t\t\treturn 0;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase hwmon_pwm:\n\t\tswitch (attr) {\n\t\tcase hwmon_pwm_input:\n\t\t\tret = i8k_get_fan_status(data, channel);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\n\t\t\t*val = clamp_val(ret * data->i8k_pwm_mult, 0, 255);\n\n\t\t\treturn 0;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn -EOPNOTSUPP;\n}\n\nstatic const char *dell_smm_fan_label(struct dell_smm_data *data, int channel)\n{\n\tbool dock = false;\n\tint type = i8k_get_fan_type(data, channel);\n\n\tif (type < 0)\n\t\treturn ERR_PTR(type);\n\n\tif (type & 0x10) {\n\t\tdock = true;\n\t\ttype &= 0x0F;\n\t}\n\n\tif (type >= ARRAY_SIZE(fan_labels))\n\t\ttype = ARRAY_SIZE(fan_labels) - 1;\n\n\treturn dock ? docking_labels[type] : fan_labels[type];\n}\n\nstatic int dell_smm_read_string(struct device *dev, enum hwmon_sensor_types type, u32 attr,\n\t\t\t\tint channel, const char **str)\n{\n\tstruct dell_smm_data *data = dev_get_drvdata(dev);\n\n\tswitch (type) {\n\tcase hwmon_temp:\n\t\tswitch (attr) {\n\t\tcase hwmon_temp_label:\n\t\t\t*str = temp_labels[data->temp_type[channel]];\n\t\t\treturn 0;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase hwmon_fan:\n\t\tswitch (attr) {\n\t\tcase hwmon_fan_label:\n\t\t\t*str = dell_smm_fan_label(data, channel);\n\t\t\treturn PTR_ERR_OR_ZERO(*str);\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn -EOPNOTSUPP;\n}\n\nstatic int dell_smm_write(struct device *dev, enum hwmon_sensor_types type, u32 attr, int channel,\n\t\t\t  long val)\n{\n\tstruct dell_smm_data *data = dev_get_drvdata(dev);\n\tunsigned long pwm;\n\tbool enable;\n\tint err;\n\n\tswitch (type) {\n\tcase hwmon_pwm:\n\t\tswitch (attr) {\n\t\tcase hwmon_pwm_input:\n\t\t\tpwm = clamp_val(DIV_ROUND_CLOSEST(val, data->i8k_pwm_mult), 0,\n\t\t\t\t\tdata->i8k_fan_max);\n\n\t\t\tmutex_lock(&data->i8k_mutex);\n\t\t\terr = i8k_set_fan(data, channel, pwm);\n\t\t\tmutex_unlock(&data->i8k_mutex);\n\n\t\t\tif (err < 0)\n\t\t\t\treturn err;\n\n\t\t\treturn 0;\n\t\tcase hwmon_pwm_enable:\n\t\t\tif (!val)\n\t\t\t\treturn -EINVAL;\n\n\t\t\tif (val == 1)\n\t\t\t\tenable = false;\n\t\t\telse\n\t\t\t\tenable = true;\n\n\t\t\tmutex_lock(&data->i8k_mutex);\n\t\t\terr = i8k_enable_fan_auto_mode(data, enable);\n\t\t\tmutex_unlock(&data->i8k_mutex);\n\n\t\t\tif (err < 0)\n\t\t\t\treturn err;\n\n\t\t\treturn 0;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn -EOPNOTSUPP;\n}\n\nstatic const struct hwmon_ops dell_smm_ops = {\n\t.is_visible = dell_smm_is_visible,\n\t.read = dell_smm_read,\n\t.read_string = dell_smm_read_string,\n\t.write = dell_smm_write,\n};\n\nstatic const struct hwmon_channel_info * const dell_smm_info[] = {\n\tHWMON_CHANNEL_INFO(chip, HWMON_C_REGISTER_TZ),\n\tHWMON_CHANNEL_INFO(temp,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LABEL,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LABEL,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LABEL,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LABEL,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LABEL,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LABEL,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LABEL,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LABEL,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LABEL,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LABEL\n\t\t\t   ),\n\tHWMON_CHANNEL_INFO(fan,\n\t\t\t   HWMON_F_INPUT | HWMON_F_LABEL | HWMON_F_MIN | HWMON_F_MAX |\n\t\t\t   HWMON_F_TARGET,\n\t\t\t   HWMON_F_INPUT | HWMON_F_LABEL | HWMON_F_MIN | HWMON_F_MAX |\n\t\t\t   HWMON_F_TARGET,\n\t\t\t   HWMON_F_INPUT | HWMON_F_LABEL | HWMON_F_MIN | HWMON_F_MAX |\n\t\t\t   HWMON_F_TARGET\n\t\t\t   ),\n\tHWMON_CHANNEL_INFO(pwm,\n\t\t\t   HWMON_PWM_INPUT | HWMON_PWM_ENABLE,\n\t\t\t   HWMON_PWM_INPUT,\n\t\t\t   HWMON_PWM_INPUT\n\t\t\t   ),\n\tNULL\n};\n\nstatic const struct hwmon_chip_info dell_smm_chip_info = {\n\t.ops = &dell_smm_ops,\n\t.info = dell_smm_info,\n};\n\nstatic int __init dell_smm_init_cdev(struct device *dev, u8 fan_num)\n{\n\tstruct dell_smm_data *data = dev_get_drvdata(dev);\n\tstruct thermal_cooling_device *cdev;\n\tstruct dell_smm_cooling_data *cdata;\n\tint ret = 0;\n\tchar *name;\n\n\tname = kasprintf(GFP_KERNEL, \"dell-smm-fan%u\", fan_num + 1);\n\tif (!name)\n\t\treturn -ENOMEM;\n\n\tcdata = devm_kmalloc(dev, sizeof(*cdata), GFP_KERNEL);\n\tif (cdata) {\n\t\tcdata->fan_num = fan_num;\n\t\tcdata->data = data;\n\t\tcdev = devm_thermal_of_cooling_device_register(dev, NULL, name, cdata,\n\t\t\t\t\t\t\t       &dell_smm_cooling_ops);\n\t\tif (IS_ERR(cdev)) {\n\t\t\tdevm_kfree(dev, cdata);\n\t\t\tret = PTR_ERR(cdev);\n\t\t}\n\t} else {\n\t\tret = -ENOMEM;\n\t}\n\n\tkfree(name);\n\n\treturn ret;\n}\n\nstatic int __init dell_smm_init_hwmon(struct device *dev)\n{\n\tstruct dell_smm_data *data = dev_get_drvdata(dev);\n\tstruct device *dell_smm_hwmon_dev;\n\tint state, err;\n\tu8 i;\n\n\tfor (i = 0; i < DELL_SMM_NO_TEMP; i++) {\n\t\tdata->temp_type[i] = i8k_get_temp_type(i);\n\t\tif (data->temp_type[i] < 0)\n\t\t\tcontinue;\n\n\t\tif (data->temp_type[i] >= ARRAY_SIZE(temp_labels))\n\t\t\tdata->temp_type[i] = ARRAY_SIZE(temp_labels) - 1;\n\t}\n\n\tfor (i = 0; i < DELL_SMM_NO_FANS; i++) {\n\t\tdata->fan_type[i] = INT_MIN;\n\t\terr = i8k_get_fan_status(data, i);\n\t\tif (err < 0)\n\t\t\terr = i8k_get_fan_type(data, i);\n\n\t\tif (err < 0)\n\t\t\tcontinue;\n\n\t\tdata->fan[i] = true;\n\n\t\t \n\t\tif (IS_REACHABLE(CONFIG_THERMAL)) {\n\t\t\terr = dell_smm_init_cdev(dev, i);\n\t\t\tif (err < 0)\n\t\t\t\tdev_warn(dev, \"Failed to register cooling device for fan %u\\n\",\n\t\t\t\t\t i + 1);\n\t\t}\n\n\t\tdata->fan_nominal_speed[i] = devm_kmalloc_array(dev, data->i8k_fan_max + 1,\n\t\t\t\t\t\t\t\tsizeof(*data->fan_nominal_speed[i]),\n\t\t\t\t\t\t\t\tGFP_KERNEL);\n\t\tif (!data->fan_nominal_speed[i])\n\t\t\tcontinue;\n\n\t\tfor (state = 0; state <= data->i8k_fan_max; state++) {\n\t\t\terr = i8k_get_fan_nominal_speed(data, i, state);\n\t\t\tif (err < 0) {\n\t\t\t\t \n\t\t\t\tdevm_kfree(dev, data->fan_nominal_speed[i]);\n\t\t\t\tdata->fan_nominal_speed[i] = NULL;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdata->fan_nominal_speed[i][state] = err;\n\t\t\t \n\t\t\tif (!fan_mult && err > I8K_FAN_RPM_THRESHOLD)\n\t\t\t\tdata->i8k_fan_mult = 1;\n\t\t}\n\t}\n\n\tdell_smm_hwmon_dev = devm_hwmon_device_register_with_info(dev, \"dell_smm\", data,\n\t\t\t\t\t\t\t\t  &dell_smm_chip_info, NULL);\n\n\treturn PTR_ERR_OR_ZERO(dell_smm_hwmon_dev);\n}\n\nstruct i8k_config_data {\n\tuint fan_mult;\n\tuint fan_max;\n};\n\nenum i8k_configs {\n\tDELL_LATITUDE_D520,\n\tDELL_PRECISION_490,\n\tDELL_STUDIO,\n\tDELL_XPS,\n};\n\n \n\nstatic const struct i8k_config_data i8k_config_data[] __initconst = {\n\t[DELL_LATITUDE_D520] = {\n\t\t.fan_mult = 1,\n\t\t.fan_max = I8K_FAN_TURBO,\n\t},\n\t[DELL_PRECISION_490] = {\n\t\t.fan_mult = 1,\n\t\t.fan_max = I8K_FAN_TURBO,\n\t},\n\t[DELL_STUDIO] = {\n\t\t.fan_mult = 1,\n\t\t.fan_max = I8K_FAN_HIGH,\n\t},\n\t[DELL_XPS] = {\n\t\t.fan_mult = 1,\n\t\t.fan_max = I8K_FAN_HIGH,\n\t},\n};\n\nstatic const struct dmi_system_id i8k_dmi_table[] __initconst = {\n\t{\n\t\t.ident = \"Dell G5 5590\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"G5 5590\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Inspiron\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Computer\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Inspiron\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Latitude\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Computer\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Latitude\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Inspiron 2\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Inspiron\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Latitude D520\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Latitude D520\"),\n\t\t},\n\t\t.driver_data = (void *)&i8k_config_data[DELL_LATITUDE_D520],\n\t},\n\t{\n\t\t.ident = \"Dell Latitude 2\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Latitude\"),\n\t\t},\n\t},\n\t{\t \n\t\t.ident = \"Dell Inspiron 3\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"MM061\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Inspiron 3\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"MP061\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Precision 490\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME,\n\t\t\t\t  \"Precision WorkStation 490\"),\n\t\t},\n\t\t.driver_data = (void *)&i8k_config_data[DELL_PRECISION_490],\n\t},\n\t{\n\t\t.ident = \"Dell Precision\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Precision\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Vostro\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Vostro\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Studio\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Studio\"),\n\t\t},\n\t\t.driver_data = (void *)&i8k_config_data[DELL_STUDIO],\n\t},\n\t{\n\t\t.ident = \"Dell XPS M140\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"MXC051\"),\n\t\t},\n\t\t.driver_data = (void *)&i8k_config_data[DELL_XPS],\n\t},\n\t{\n\t\t.ident = \"Dell XPS\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"XPS\"),\n\t\t},\n\t},\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(dmi, i8k_dmi_table);\n\n \nstatic const struct dmi_system_id i8k_blacklist_fan_type_dmi_table[] __initconst = {\n\t{\n\t\t.ident = \"Dell Studio XPS 8000\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Studio XPS 8000\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Studio XPS 8100\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Studio XPS 8100\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Inspiron 580\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Inspiron 580 \"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Inspiron 3505\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Inspiron 3505\"),\n\t\t},\n\t},\n\t{ }\n};\n\n \nstatic const struct dmi_system_id i8k_blacklist_fan_support_dmi_table[] __initconst = {\n\t{\n\t\t.ident = \"Dell Inspiron 7720\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Inspiron 7720\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell Vostro 3360\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Vostro 3360\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell XPS13 9333\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"XPS13 9333\"),\n\t\t},\n\t},\n\t{\n\t\t.ident = \"Dell XPS 15 L502X\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Dell System XPS L502X\"),\n\t\t},\n\t},\n\t{ }\n};\n\nstruct i8k_fan_control_data {\n\tunsigned int manual_fan;\n\tunsigned int auto_fan;\n};\n\nenum i8k_fan_controls {\n\tI8K_FAN_34A3_35A3,\n};\n\nstatic const struct i8k_fan_control_data i8k_fan_control_data[] __initconst = {\n\t[I8K_FAN_34A3_35A3] = {\n\t\t.manual_fan = 0x34a3,\n\t\t.auto_fan = 0x35a3,\n\t},\n};\n\nstatic const struct dmi_system_id i8k_whitelist_fan_control[] __initconst = {\n\t{\n\t\t.ident = \"Dell Latitude 5480\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Latitude 5480\"),\n\t\t},\n\t\t.driver_data = (void *)&i8k_fan_control_data[I8K_FAN_34A3_35A3],\n\t},\n\t{\n\t\t.ident = \"Dell Latitude E6440\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Latitude E6440\"),\n\t\t},\n\t\t.driver_data = (void *)&i8k_fan_control_data[I8K_FAN_34A3_35A3],\n\t},\n\t{\n\t\t.ident = \"Dell Latitude E7440\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Latitude E7440\"),\n\t\t},\n\t\t.driver_data = (void *)&i8k_fan_control_data[I8K_FAN_34A3_35A3],\n\t},\n\t{\n\t\t.ident = \"Dell Precision 5530\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Precision 5530\"),\n\t\t},\n\t\t.driver_data = (void *)&i8k_fan_control_data[I8K_FAN_34A3_35A3],\n\t},\n\t{\n\t\t.ident = \"Dell Precision 7510\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Precision 7510\"),\n\t\t},\n\t\t.driver_data = (void *)&i8k_fan_control_data[I8K_FAN_34A3_35A3],\n\t},\n\t{\n\t\t.ident = \"Dell XPS 13 7390\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Dell Inc.\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"XPS 13 7390\"),\n\t\t},\n\t\t.driver_data = (void *)&i8k_fan_control_data[I8K_FAN_34A3_35A3],\n\t},\n\t{ }\n};\n\nstatic int __init dell_smm_probe(struct platform_device *pdev)\n{\n\tstruct dell_smm_data *data;\n\tconst struct dmi_system_id *id, *fan_control;\n\tint ret;\n\n\tdata = devm_kzalloc(&pdev->dev, sizeof(struct dell_smm_data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tmutex_init(&data->i8k_mutex);\n\tplatform_set_drvdata(pdev, data);\n\n\tif (dmi_check_system(i8k_blacklist_fan_support_dmi_table)) {\n\t\tif (!force) {\n\t\t\tdev_notice(&pdev->dev, \"Disabling fan support due to BIOS bugs\\n\");\n\t\t\tdata->disallow_fan_support = true;\n\t\t} else {\n\t\t\tdev_warn(&pdev->dev, \"Enabling fan support despite BIOS bugs\\n\");\n\t\t}\n\t}\n\n\tif (dmi_check_system(i8k_blacklist_fan_type_dmi_table)) {\n\t\tif (!force) {\n\t\t\tdev_notice(&pdev->dev, \"Disabling fan type call due to BIOS bugs\\n\");\n\t\t\tdata->disallow_fan_type_call = true;\n\t\t} else {\n\t\t\tdev_warn(&pdev->dev, \"Enabling fan type call despite BIOS bugs\\n\");\n\t\t}\n\t}\n\n\tstrscpy(data->bios_version, i8k_get_dmi_data(DMI_BIOS_VERSION),\n\t\tsizeof(data->bios_version));\n\tstrscpy(data->bios_machineid, i8k_get_dmi_data(DMI_PRODUCT_SERIAL),\n\t\tsizeof(data->bios_machineid));\n\n\t \n\tid = dmi_first_match(i8k_dmi_table);\n\tif (id && id->driver_data) {\n\t\tconst struct i8k_config_data *conf = id->driver_data;\n\n\t\tif (!fan_mult && conf->fan_mult)\n\t\t\tfan_mult = conf->fan_mult;\n\n\t\tif (!fan_max && conf->fan_max)\n\t\t\tfan_max = conf->fan_max;\n\t}\n\n\t \n\tdata->i8k_fan_mult = fan_mult ? : I8K_FAN_MULT;\n\tdata->i8k_fan_max = fan_max ? : I8K_FAN_HIGH;\n\tdata->i8k_pwm_mult = DIV_ROUND_UP(255, data->i8k_fan_max);\n\n\tfan_control = dmi_first_match(i8k_whitelist_fan_control);\n\tif (fan_control && fan_control->driver_data) {\n\t\tconst struct i8k_fan_control_data *control = fan_control->driver_data;\n\n\t\tdata->manual_fan = control->manual_fan;\n\t\tdata->auto_fan = control->auto_fan;\n\t\tdev_info(&pdev->dev, \"enabling support for setting automatic/manual fan control\\n\");\n\t}\n\n\tret = dell_smm_init_hwmon(&pdev->dev);\n\tif (ret)\n\t\treturn ret;\n\n\ti8k_init_procfs(&pdev->dev);\n\n\treturn 0;\n}\n\nstatic struct platform_driver dell_smm_driver = {\n\t.driver\t\t= {\n\t\t.name\t= KBUILD_MODNAME,\n\t},\n};\n\nstatic struct platform_device *dell_smm_device;\n\n \nstatic int __init i8k_init(void)\n{\n\t \n\tif (!dmi_check_system(i8k_dmi_table)) {\n\t\tif (!ignore_dmi && !force)\n\t\t\treturn -ENODEV;\n\n\t\tpr_info(\"not running on a supported Dell system.\\n\");\n\t\tpr_info(\"vendor=%s, model=%s, version=%s\\n\",\n\t\t\ti8k_get_dmi_data(DMI_SYS_VENDOR),\n\t\t\ti8k_get_dmi_data(DMI_PRODUCT_NAME),\n\t\t\ti8k_get_dmi_data(DMI_BIOS_VERSION));\n\t}\n\n\t \n\tif (i8k_get_dell_signature(I8K_SMM_GET_DELL_SIG1) &&\n\t    i8k_get_dell_signature(I8K_SMM_GET_DELL_SIG2)) {\n\t\tif (!force)\n\t\t\treturn -ENODEV;\n\n\t\tpr_err(\"Unable to get Dell SMM signature\\n\");\n\t}\n\n\tdell_smm_device = platform_create_bundle(&dell_smm_driver, dell_smm_probe, NULL, 0, NULL,\n\t\t\t\t\t\t 0);\n\n\treturn PTR_ERR_OR_ZERO(dell_smm_device);\n}\n\nstatic void __exit i8k_exit(void)\n{\n\tplatform_device_unregister(dell_smm_device);\n\tplatform_driver_unregister(&dell_smm_driver);\n}\n\nmodule_init(i8k_init);\nmodule_exit(i8k_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}