{
  "module_name": "max127.c",
  "hash_id": "4affe4e2f0d1501cc3b51d50f2f4aefa8d6c1167d71f7f11d1f302f8c9353dd3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/max127.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/hwmon.h>\n#include <linux/i2c.h>\n#include <linux/init.h>\n#include <linux/module.h>\n\n \n#define MAX127_CTRL_START\tBIT(7)\n#define MAX127_CTRL_SEL_SHIFT\t4\n#define MAX127_CTRL_RNG\t\tBIT(3)\n#define MAX127_CTRL_BIP\t\tBIT(2)\n#define MAX127_CTRL_PD1\t\tBIT(1)\n#define MAX127_CTRL_PD0\t\tBIT(0)\n\n#define MAX127_NUM_CHANNELS\t8\n#define MAX127_SET_CHANNEL(ch)\t(((ch) & 7) << MAX127_CTRL_SEL_SHIFT)\n\n \n#define MAX127_FULL_RANGE\t10000\t \n#define MAX127_HALF_RANGE\t5000\t \n\n \n#define MAX127_DATA_LEN\t\t2\n#define MAX127_DATA_SHIFT\t4\n\n#define MAX127_SIGN_BIT\t\tBIT(11)\n\nstruct max127_data {\n\tstruct mutex lock;\n\tstruct i2c_client *client;\n\tu8 ctrl_byte[MAX127_NUM_CHANNELS];\n};\n\nstatic int max127_select_channel(struct i2c_client *client, u8 ctrl_byte)\n{\n\tint status;\n\tstruct i2c_msg msg = {\n\t\t.addr = client->addr,\n\t\t.flags = 0,\n\t\t.len = sizeof(ctrl_byte),\n\t\t.buf = &ctrl_byte,\n\t};\n\n\tstatus = i2c_transfer(client->adapter, &msg, 1);\n\tif (status < 0)\n\t\treturn status;\n\tif (status != 1)\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\nstatic int max127_read_channel(struct i2c_client *client, long *val)\n{\n\tint status;\n\tu8 i2c_data[MAX127_DATA_LEN];\n\tstruct i2c_msg msg = {\n\t\t.addr = client->addr,\n\t\t.flags = I2C_M_RD,\n\t\t.len = sizeof(i2c_data),\n\t\t.buf = i2c_data,\n\t};\n\n\tstatus = i2c_transfer(client->adapter, &msg, 1);\n\tif (status < 0)\n\t\treturn status;\n\tif (status != 1)\n\t\treturn -EIO;\n\n\t*val = (i2c_data[1] >> MAX127_DATA_SHIFT) |\n\t\t((u16)i2c_data[0] << MAX127_DATA_SHIFT);\n\treturn 0;\n}\n\nstatic long max127_process_raw(u8 ctrl_byte, long raw)\n{\n\tlong scale, weight;\n\n\t \n\tscale = (ctrl_byte & MAX127_CTRL_RNG) ? MAX127_FULL_RANGE :\n\t\t\t\t\t\tMAX127_HALF_RANGE;\n\tif (ctrl_byte & MAX127_CTRL_BIP) {\n\t\tweight = (raw & MAX127_SIGN_BIT);\n\t\traw &= ~MAX127_SIGN_BIT;\n\t\traw -= weight;\n\t\traw *= 2;\n\t}\n\n\treturn raw * scale / 4096;\n}\n\nstatic int max127_read_input(struct max127_data *data, int channel, long *val)\n{\n\tlong raw;\n\tint status;\n\tstruct i2c_client *client = data->client;\n\tu8 ctrl_byte = data->ctrl_byte[channel];\n\n\tmutex_lock(&data->lock);\n\n\tstatus = max127_select_channel(client, ctrl_byte);\n\tif (status)\n\t\tgoto exit;\n\n\tstatus = max127_read_channel(client, &raw);\n\tif (status)\n\t\tgoto exit;\n\n\t*val = max127_process_raw(ctrl_byte, raw);\n\nexit:\n\tmutex_unlock(&data->lock);\n\treturn status;\n}\n\nstatic int max127_read_min(struct max127_data *data, int channel, long *val)\n{\n\tu8 rng_bip = (data->ctrl_byte[channel] >> 2) & 3;\n\tstatic const int min_input_map[4] = {\n\t\t0,\t\t\t \n\t\t-MAX127_HALF_RANGE,\t \n\t\t0,\t\t\t \n\t\t-MAX127_FULL_RANGE,\t \n\t};\n\n\t*val = min_input_map[rng_bip];\n\treturn 0;\n}\n\nstatic int max127_read_max(struct max127_data *data, int channel, long *val)\n{\n\tu8 rng_bip = (data->ctrl_byte[channel] >> 2) & 3;\n\tstatic const int max_input_map[4] = {\n\t\tMAX127_HALF_RANGE,\t \n\t\tMAX127_HALF_RANGE,\t \n\t\tMAX127_FULL_RANGE,\t \n\t\tMAX127_FULL_RANGE,\t \n\t};\n\n\t*val = max_input_map[rng_bip];\n\treturn 0;\n}\n\nstatic int max127_write_min(struct max127_data *data, int channel, long val)\n{\n\tu8 ctrl;\n\n\tmutex_lock(&data->lock);\n\n\tctrl = data->ctrl_byte[channel];\n\tif (val <= -MAX127_FULL_RANGE) {\n\t\tctrl |= (MAX127_CTRL_RNG | MAX127_CTRL_BIP);\n\t} else if (val < 0) {\n\t\tctrl |= MAX127_CTRL_BIP;\n\t\tctrl &= ~MAX127_CTRL_RNG;\n\t} else {\n\t\tctrl &= ~MAX127_CTRL_BIP;\n\t}\n\tdata->ctrl_byte[channel] = ctrl;\n\n\tmutex_unlock(&data->lock);\n\n\treturn 0;\n}\n\nstatic int max127_write_max(struct max127_data *data, int channel, long val)\n{\n\tmutex_lock(&data->lock);\n\n\tif (val >= MAX127_FULL_RANGE)\n\t\tdata->ctrl_byte[channel] |= MAX127_CTRL_RNG;\n\telse\n\t\tdata->ctrl_byte[channel] &= ~MAX127_CTRL_RNG;\n\n\tmutex_unlock(&data->lock);\n\n\treturn 0;\n}\n\nstatic umode_t max127_is_visible(const void *_data,\n\t\t\t\t enum hwmon_sensor_types type,\n\t\t\t\t u32 attr, int channel)\n{\n\tif (type == hwmon_in) {\n\t\tswitch (attr) {\n\t\tcase hwmon_in_input:\n\t\t\treturn 0444;\n\n\t\tcase hwmon_in_min:\n\t\tcase hwmon_in_max:\n\t\t\treturn 0644;\n\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int max127_read(struct device *dev, enum hwmon_sensor_types type,\n\t\t\tu32 attr, int channel, long *val)\n{\n\tint status;\n\tstruct max127_data *data = dev_get_drvdata(dev);\n\n\tif (type != hwmon_in)\n\t\treturn -EOPNOTSUPP;\n\n\tswitch (attr) {\n\tcase hwmon_in_input:\n\t\tstatus = max127_read_input(data, channel, val);\n\t\tbreak;\n\n\tcase hwmon_in_min:\n\t\tstatus = max127_read_min(data, channel, val);\n\t\tbreak;\n\n\tcase hwmon_in_max:\n\t\tstatus = max127_read_max(data, channel, val);\n\t\tbreak;\n\n\tdefault:\n\t\tstatus = -EOPNOTSUPP;\n\t\tbreak;\n\t}\n\n\treturn status;\n}\n\nstatic int max127_write(struct device *dev, enum hwmon_sensor_types type,\n\t\t\tu32 attr, int channel, long val)\n{\n\tint status;\n\tstruct max127_data *data = dev_get_drvdata(dev);\n\n\tif (type != hwmon_in)\n\t\treturn -EOPNOTSUPP;\n\n\tswitch (attr) {\n\tcase hwmon_in_min:\n\t\tstatus = max127_write_min(data, channel, val);\n\t\tbreak;\n\n\tcase hwmon_in_max:\n\t\tstatus = max127_write_max(data, channel, val);\n\t\tbreak;\n\n\tdefault:\n\t\tstatus = -EOPNOTSUPP;\n\t\tbreak;\n\t}\n\n\treturn status;\n}\n\nstatic const struct hwmon_ops max127_hwmon_ops = {\n\t.is_visible = max127_is_visible,\n\t.read = max127_read,\n\t.write = max127_write,\n};\n\nstatic const struct hwmon_channel_info * const max127_info[] = {\n\tHWMON_CHANNEL_INFO(in,\n\t\t\t   HWMON_I_INPUT | HWMON_I_MIN | HWMON_I_MAX,\n\t\t\t   HWMON_I_INPUT | HWMON_I_MIN | HWMON_I_MAX,\n\t\t\t   HWMON_I_INPUT | HWMON_I_MIN | HWMON_I_MAX,\n\t\t\t   HWMON_I_INPUT | HWMON_I_MIN | HWMON_I_MAX,\n\t\t\t   HWMON_I_INPUT | HWMON_I_MIN | HWMON_I_MAX,\n\t\t\t   HWMON_I_INPUT | HWMON_I_MIN | HWMON_I_MAX,\n\t\t\t   HWMON_I_INPUT | HWMON_I_MIN | HWMON_I_MAX,\n\t\t\t   HWMON_I_INPUT | HWMON_I_MIN | HWMON_I_MAX),\n\tNULL,\n};\n\nstatic const struct hwmon_chip_info max127_chip_info = {\n\t.ops = &max127_hwmon_ops,\n\t.info = max127_info,\n};\n\nstatic int max127_probe(struct i2c_client *client)\n{\n\tint i;\n\tstruct device *hwmon_dev;\n\tstruct max127_data *data;\n\tstruct device *dev = &client->dev;\n\n\tdata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tdata->client = client;\n\tmutex_init(&data->lock);\n\tfor (i = 0; i < ARRAY_SIZE(data->ctrl_byte); i++)\n\t\tdata->ctrl_byte[i] = (MAX127_CTRL_START |\n\t\t\t\t      MAX127_SET_CHANNEL(i));\n\n\thwmon_dev = devm_hwmon_device_register_with_info(dev, client->name,\n\t\t\t\t\t\t\t data,\n\t\t\t\t\t\t\t &max127_chip_info,\n\t\t\t\t\t\t\t NULL);\n\n\treturn PTR_ERR_OR_ZERO(hwmon_dev);\n}\n\nstatic const struct i2c_device_id max127_id[] = {\n\t{ \"max127\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, max127_id);\n\nstatic struct i2c_driver max127_driver = {\n\t.class\t\t= I2C_CLASS_HWMON,\n\t.driver = {\n\t\t.name\t= \"max127\",\n\t},\n\t.probe\t\t= max127_probe,\n\t.id_table\t= max127_id,\n};\n\nmodule_i2c_driver(max127_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Mike Choi <mikechoi@fb.com>\");\nMODULE_AUTHOR(\"Tao Ren <rentao.bupt@gmail.com>\");\nMODULE_DESCRIPTION(\"MAX127 Hardware Monitoring driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}