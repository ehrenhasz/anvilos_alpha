{
  "module_name": "adt7310.c",
  "hash_id": "49127e520c54cdcda1b6cefd6e21e97a324cb9c341c05bcb0217880075802772",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/adt7310.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/regmap.h>\n#include <linux/spi/spi.h>\n#include <asm/unaligned.h>\n\n#include \"adt7x10.h\"\n\n#define ADT7310_STATUS\t\t\t0\n#define ADT7310_CONFIG\t\t\t1\n#define ADT7310_TEMPERATURE\t\t2\n#define ADT7310_ID\t\t\t3\n#define ADT7310_T_CRIT\t\t\t4\n#define ADT7310_T_HYST\t\t\t5\n#define ADT7310_T_ALARM_HIGH\t\t6\n#define ADT7310_T_ALARM_LOW\t\t7\n\nstatic const u8 adt7310_reg_table[] = {\n\t[ADT7X10_TEMPERATURE]   = ADT7310_TEMPERATURE,\n\t[ADT7X10_STATUS]\t= ADT7310_STATUS,\n\t[ADT7X10_CONFIG]\t= ADT7310_CONFIG,\n\t[ADT7X10_T_ALARM_HIGH]\t= ADT7310_T_ALARM_HIGH,\n\t[ADT7X10_T_ALARM_LOW]\t= ADT7310_T_ALARM_LOW,\n\t[ADT7X10_T_CRIT]\t= ADT7310_T_CRIT,\n\t[ADT7X10_T_HYST]\t= ADT7310_T_HYST,\n\t[ADT7X10_ID]\t\t= ADT7310_ID,\n};\n\n#define ADT7310_CMD_REG_OFFSET\t3\n#define ADT7310_CMD_READ\t0x40\n\n#define AD7310_COMMAND(reg) (adt7310_reg_table[(reg)] << ADT7310_CMD_REG_OFFSET)\n\nstatic int adt7310_spi_read_word(struct spi_device *spi, u8 reg)\n{\n\treturn spi_w8r16be(spi, AD7310_COMMAND(reg) | ADT7310_CMD_READ);\n}\n\nstatic int adt7310_spi_write_word(struct spi_device *spi, u8 reg, u16 data)\n{\n\tu8 buf[3];\n\n\tbuf[0] = AD7310_COMMAND(reg);\n\tput_unaligned_be16(data, &buf[1]);\n\n\treturn spi_write(spi, buf, sizeof(buf));\n}\n\nstatic int adt7310_spi_read_byte(struct spi_device *spi, u8 reg)\n{\n\treturn spi_w8r8(spi, AD7310_COMMAND(reg) | ADT7310_CMD_READ);\n}\n\nstatic int adt7310_spi_write_byte(struct spi_device *spi, u8 reg, u8 data)\n{\n\tu8 buf[2];\n\n\tbuf[0] = AD7310_COMMAND(reg);\n\tbuf[1] = data;\n\n\treturn spi_write(spi, buf, sizeof(buf));\n}\n\nstatic bool adt7310_regmap_is_volatile(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase ADT7X10_TEMPERATURE:\n\tcase ADT7X10_STATUS:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic int adt7310_reg_read(void *context, unsigned int reg, unsigned int *val)\n{\n\tstruct spi_device *spi = context;\n\tint regval;\n\n\tswitch (reg) {\n\tcase ADT7X10_TEMPERATURE:\n\tcase ADT7X10_T_ALARM_HIGH:\n\tcase ADT7X10_T_ALARM_LOW:\n\tcase ADT7X10_T_CRIT:\n\t\tregval = adt7310_spi_read_word(spi, reg);\n\t\tbreak;\n\tdefault:\n\t\tregval = adt7310_spi_read_byte(spi, reg);\n\t\tbreak;\n\t}\n\tif (regval < 0)\n\t\treturn regval;\n\t*val = regval;\n\treturn 0;\n}\n\nstatic int adt7310_reg_write(void *context, unsigned int reg, unsigned int val)\n{\n\tstruct spi_device *spi = context;\n\tint ret;\n\n\tswitch (reg) {\n\tcase ADT7X10_TEMPERATURE:\n\tcase ADT7X10_T_ALARM_HIGH:\n\tcase ADT7X10_T_ALARM_LOW:\n\tcase ADT7X10_T_CRIT:\n\t\tret = adt7310_spi_write_word(spi, reg, val);\n\t\tbreak;\n\tdefault:\n\t\tret = adt7310_spi_write_byte(spi, reg, val);\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic const struct regmap_config adt7310_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 16,\n\t.cache_type = REGCACHE_RBTREE,\n\t.volatile_reg = adt7310_regmap_is_volatile,\n\t.reg_read = adt7310_reg_read,\n\t.reg_write = adt7310_reg_write,\n};\n\nstatic int adt7310_spi_probe(struct spi_device *spi)\n{\n\tstruct regmap *regmap;\n\n\tregmap = devm_regmap_init(&spi->dev, NULL, spi, &adt7310_regmap_config);\n\tif (IS_ERR(regmap))\n\t\treturn PTR_ERR(regmap);\n\n\treturn adt7x10_probe(&spi->dev, spi_get_device_id(spi)->name, spi->irq,\n\t\t\t     regmap);\n}\n\nstatic const struct spi_device_id adt7310_id[] = {\n\t{ \"adt7310\", 0 },\n\t{ \"adt7320\", 0 },\n\t{}\n};\nMODULE_DEVICE_TABLE(spi, adt7310_id);\n\nstatic struct spi_driver adt7310_driver = {\n\t.driver = {\n\t\t.name\t= \"adt7310\",\n\t\t.pm\t= pm_sleep_ptr(&adt7x10_dev_pm_ops),\n\t},\n\t.probe\t\t= adt7310_spi_probe,\n\t.id_table\t= adt7310_id,\n};\nmodule_spi_driver(adt7310_driver);\n\nMODULE_AUTHOR(\"Lars-Peter Clausen <lars@metafoo.de>\");\nMODULE_DESCRIPTION(\"ADT7310/ADT7320 driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}