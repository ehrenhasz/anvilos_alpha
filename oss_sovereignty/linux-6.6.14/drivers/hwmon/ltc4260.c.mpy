{
  "module_name": "ltc4260.c",
  "hash_id": "ec62bcc892e9a13ec74323a9f04dd88ece7ec6773386ea39b70b056cd2068a1a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/ltc4260.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/err.h>\n#include <linux/slab.h>\n#include <linux/i2c.h>\n#include <linux/hwmon.h>\n#include <linux/hwmon-sysfs.h>\n#include <linux/jiffies.h>\n#include <linux/regmap.h>\n\n \n#define LTC4260_CONTROL\t0x00\n#define LTC4260_ALERT\t0x01\n#define LTC4260_STATUS\t0x02\n#define LTC4260_FAULT\t0x03\n#define LTC4260_SENSE\t0x04\n#define LTC4260_SOURCE\t0x05\n#define LTC4260_ADIN\t0x06\n\n \n#define FAULT_OV\t(1 << 0)\n#define FAULT_UV\t(1 << 1)\n#define FAULT_OC\t(1 << 2)\n#define FAULT_POWER_BAD\t(1 << 3)\n#define FAULT_FET_SHORT\t(1 << 5)\n\n \nstatic int ltc4260_get_value(struct device *dev, u8 reg)\n{\n\tstruct regmap *regmap = dev_get_drvdata(dev);\n\tunsigned int val;\n\tint ret;\n\n\tret = regmap_read(regmap, reg, &val);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tswitch (reg) {\n\tcase LTC4260_ADIN:\n\t\t \n\t\tval = val * 10;\n\t\tbreak;\n\tcase LTC4260_SOURCE:\n\t\t \n\t\tval = val * 400;\n\t\tbreak;\n\tcase LTC4260_SENSE:\n\t\t \n\t\tval = val * 300;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn val;\n}\n\nstatic ssize_t ltc4260_value_show(struct device *dev,\n\t\t\t\t  struct device_attribute *da, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\n\tint value;\n\n\tvalue = ltc4260_get_value(dev, attr->index);\n\tif (value < 0)\n\t\treturn value;\n\treturn sysfs_emit(buf, \"%d\\n\", value);\n}\n\nstatic ssize_t ltc4260_bool_show(struct device *dev,\n\t\t\t\t struct device_attribute *da, char *buf)\n{\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\n\tstruct regmap *regmap = dev_get_drvdata(dev);\n\tunsigned int fault;\n\tint ret;\n\n\tret = regmap_read(regmap, LTC4260_FAULT, &fault);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfault &= attr->index;\n\tif (fault)\t\t \n\t\tregmap_update_bits(regmap, LTC4260_FAULT, attr->index, 0);\n\n\treturn sysfs_emit(buf, \"%d\\n\", !!fault);\n}\n\n \nstatic SENSOR_DEVICE_ATTR_RO(in1_input, ltc4260_value, LTC4260_SOURCE);\nstatic SENSOR_DEVICE_ATTR_RO(in2_input, ltc4260_value, LTC4260_ADIN);\n\n \nstatic SENSOR_DEVICE_ATTR_RO(in1_min_alarm, ltc4260_bool, FAULT_UV);\nstatic SENSOR_DEVICE_ATTR_RO(in1_max_alarm, ltc4260_bool, FAULT_OV);\nstatic SENSOR_DEVICE_ATTR_RO(in2_alarm, ltc4260_bool,\n\t\t\t     FAULT_POWER_BAD | FAULT_FET_SHORT);\n\n \nstatic SENSOR_DEVICE_ATTR_RO(curr1_input, ltc4260_value, LTC4260_SENSE);\n\n \nstatic SENSOR_DEVICE_ATTR_RO(curr1_max_alarm, ltc4260_bool, FAULT_OC);\n\nstatic struct attribute *ltc4260_attrs[] = {\n\t&sensor_dev_attr_in1_input.dev_attr.attr,\n\t&sensor_dev_attr_in1_min_alarm.dev_attr.attr,\n\t&sensor_dev_attr_in1_max_alarm.dev_attr.attr,\n\t&sensor_dev_attr_in2_input.dev_attr.attr,\n\t&sensor_dev_attr_in2_alarm.dev_attr.attr,\n\n\t&sensor_dev_attr_curr1_input.dev_attr.attr,\n\t&sensor_dev_attr_curr1_max_alarm.dev_attr.attr,\n\n\tNULL,\n};\nATTRIBUTE_GROUPS(ltc4260);\n\nstatic const struct regmap_config ltc4260_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.max_register = LTC4260_ADIN,\n};\n\nstatic int ltc4260_probe(struct i2c_client *client)\n{\n\tstruct device *dev = &client->dev;\n\tstruct device *hwmon_dev;\n\tstruct regmap *regmap;\n\n\tregmap = devm_regmap_init_i2c(client, &ltc4260_regmap_config);\n\tif (IS_ERR(regmap)) {\n\t\tdev_err(dev, \"failed to allocate register map\\n\");\n\t\treturn PTR_ERR(regmap);\n\t}\n\n\t \n\tregmap_write(regmap, LTC4260_FAULT, 0x00);\n\n\thwmon_dev = devm_hwmon_device_register_with_groups(dev, client->name,\n\t\t\t\t\t\t\t   regmap,\n\t\t\t\t\t\t\t   ltc4260_groups);\n\treturn PTR_ERR_OR_ZERO(hwmon_dev);\n}\n\nstatic const struct i2c_device_id ltc4260_id[] = {\n\t{\"ltc4260\", 0},\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(i2c, ltc4260_id);\n\nstatic struct i2c_driver ltc4260_driver = {\n\t.driver = {\n\t\t   .name = \"ltc4260\",\n\t\t   },\n\t.probe = ltc4260_probe,\n\t.id_table = ltc4260_id,\n};\n\nmodule_i2c_driver(ltc4260_driver);\n\nMODULE_AUTHOR(\"Guenter Roeck <linux@roeck-us.net>\");\nMODULE_DESCRIPTION(\"LTC4260 driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}