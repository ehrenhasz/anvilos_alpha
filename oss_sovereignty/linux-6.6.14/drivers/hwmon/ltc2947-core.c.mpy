{
  "module_name": "ltc2947-core.c",
  "hash_id": "1fe9dcc2904531c30b8a7d097add18b61bc838bd8a22f846b5afc1a45ac9c317",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/ltc2947-core.c",
  "human_readable_source": "\n \n#include <linux/bitfield.h>\n#include <linux/bits.h>\n#include <linux/clk.h>\n#include <linux/device.h>\n#include <linux/hwmon.h>\n#include <linux/hwmon-sysfs.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/regmap.h>\n\n#include \"ltc2947.h\"\n\n \n#define LTC2947_REG_PAGE_CTRL\t\t0xFF\n#define LTC2947_REG_CTRL\t\t0xF0\n#define LTC2947_REG_TBCTL\t\t0xE9\n#define LTC2947_CONT_MODE_MASK\t\tBIT(3)\n#define LTC2947_CONT_MODE(x)\t\tFIELD_PREP(LTC2947_CONT_MODE_MASK, x)\n#define LTC2947_PRE_MASK\t\tGENMASK(2, 0)\n#define LTC2947_PRE(x)\t\t\tFIELD_PREP(LTC2947_PRE_MASK, x)\n#define LTC2947_DIV_MASK\t\tGENMASK(7, 3)\n#define LTC2947_DIV(x)\t\t\tFIELD_PREP(LTC2947_DIV_MASK, x)\n#define LTC2947_SHUTDOWN_MASK\t\tBIT(0)\n#define LTC2947_REG_ACCUM_POL\t\t0xE1\n#define LTC2947_ACCUM_POL_1_MASK\tGENMASK(1, 0)\n#define LTC2947_ACCUM_POL_1(x)\t\tFIELD_PREP(LTC2947_ACCUM_POL_1_MASK, x)\n#define LTC2947_ACCUM_POL_2_MASK\tGENMASK(3, 2)\n#define LTC2947_ACCUM_POL_2(x)\t\tFIELD_PREP(LTC2947_ACCUM_POL_2_MASK, x)\n#define LTC2947_REG_ACCUM_DEADBAND\t0xE4\n#define LTC2947_REG_GPIOSTATCTL\t\t0x67\n#define LTC2947_GPIO_EN_MASK\t\tBIT(0)\n#define LTC2947_GPIO_EN(x)\t\tFIELD_PREP(LTC2947_GPIO_EN_MASK, x)\n#define LTC2947_GPIO_FAN_EN_MASK\tBIT(6)\n#define LTC2947_GPIO_FAN_EN(x)\t\tFIELD_PREP(LTC2947_GPIO_FAN_EN_MASK, x)\n#define LTC2947_GPIO_FAN_POL_MASK\tBIT(7)\n#define LTC2947_GPIO_FAN_POL(x)\t\tFIELD_PREP(LTC2947_GPIO_FAN_POL_MASK, x)\n#define LTC2947_REG_GPIO_ACCUM\t\t0xE3\n \n#define LTC2947_CLK_MIN\t\t\t200000\n \n#define LTC2947_CLK_MAX\t\t\t25000000\n#define LTC2947_PAGE0\t\t\t0\n#define LTC2947_PAGE1\t\t\t1\n \n#define LTC2947_REG_VOLTAGE\t\t0xA0\n#define LTC2947_REG_VOLTAGE_MAX\t\t0x50\n#define LTC2947_REG_VOLTAGE_MIN\t\t0x52\n#define LTC2947_REG_VOLTAGE_THRE_H\t0x90\n#define LTC2947_REG_VOLTAGE_THRE_L\t0x92\n#define LTC2947_REG_DVCC\t\t0xA4\n#define LTC2947_REG_DVCC_MAX\t\t0x58\n#define LTC2947_REG_DVCC_MIN\t\t0x5A\n#define LTC2947_REG_DVCC_THRE_H\t\t0x98\n#define LTC2947_REG_DVCC_THRE_L\t\t0x9A\n#define LTC2947_VOLTAGE_GEN_CHAN\t0\n#define LTC2947_VOLTAGE_DVCC_CHAN\t1\n \n#define VOLTAGE_MAX\t\t\t15500\n#define VOLTAGE_MIN\t\t\t-300\n#define VDVCC_MAX\t\t\t15000\n#define VDVCC_MIN\t\t\t4750\n \n#define LTC2947_REG_CURRENT\t\t0x90\n#define LTC2947_REG_CURRENT_MAX\t\t0x40\n#define LTC2947_REG_CURRENT_MIN\t\t0x42\n#define LTC2947_REG_CURRENT_THRE_H\t0x80\n#define LTC2947_REG_CURRENT_THRE_L\t0x82\n \n#define CURRENT_MAX\t\t\t30000\n#define CURRENT_MIN\t\t\t-30000\n \n#define LTC2947_REG_POWER\t\t0x93\n#define LTC2947_REG_POWER_MAX\t\t0x44\n#define LTC2947_REG_POWER_MIN\t\t0x46\n#define LTC2947_REG_POWER_THRE_H\t0x84\n#define LTC2947_REG_POWER_THRE_L\t0x86\n \n#define POWER_MAX\t\t\t450000000\n#define POWER_MIN\t\t\t-450000000\n \n#define LTC2947_REG_TEMP\t\t0xA2\n#define LTC2947_REG_TEMP_MAX\t\t0x54\n#define LTC2947_REG_TEMP_MIN\t\t0x56\n#define LTC2947_REG_TEMP_THRE_H\t\t0x94\n#define LTC2947_REG_TEMP_THRE_L\t\t0x96\n#define LTC2947_REG_TEMP_FAN_THRE_H\t0x9C\n#define LTC2947_REG_TEMP_FAN_THRE_L\t0x9E\n#define LTC2947_TEMP_FAN_CHAN\t\t1\n \n#define TEMP_MAX\t\t\t85000\n#define TEMP_MIN\t\t\t-40000\n \n#define LTC2947_REG_ENERGY1\t\t0x06\n#define LTC2947_REG_ENERGY2\t\t0x16\n \n#define LTC2947_REG_STATUS\t\t0x80\n#define LTC2947_REG_STATVT\t\t0x81\n#define LTC2947_REG_STATIP\t\t0x82\n#define LTC2947_REG_STATVDVCC\t\t0x87\n\n#define LTC2947_ALERTS_SIZE\t(LTC2947_REG_STATVDVCC - LTC2947_REG_STATUS)\n#define LTC2947_MAX_VOLTAGE_MASK\tBIT(0)\n#define LTC2947_MIN_VOLTAGE_MASK\tBIT(1)\n#define LTC2947_MAX_CURRENT_MASK\tBIT(0)\n#define LTC2947_MIN_CURRENT_MASK\tBIT(1)\n#define LTC2947_MAX_POWER_MASK\t\tBIT(2)\n#define LTC2947_MIN_POWER_MASK\t\tBIT(3)\n#define LTC2947_MAX_TEMP_MASK\t\tBIT(2)\n#define LTC2947_MIN_TEMP_MASK\t\tBIT(3)\n#define LTC2947_MAX_TEMP_FAN_MASK\tBIT(4)\n#define LTC2947_MIN_TEMP_FAN_MASK\tBIT(5)\n\nstruct ltc2947_data {\n\tstruct regmap *map;\n\tstruct device *dev;\n\t \n\tstruct mutex lock;\n\tu32 lsb_energy;\n\tbool gpio_out;\n};\n\nstatic int __ltc2947_val_read16(const struct ltc2947_data *st, const u8 reg,\n\t\t\t\tu64 *val)\n{\n\t__be16 __val = 0;\n\tint ret;\n\n\tret = regmap_bulk_read(st->map, reg, &__val, 2);\n\tif (ret)\n\t\treturn ret;\n\n\t*val = be16_to_cpu(__val);\n\n\treturn 0;\n}\n\nstatic int __ltc2947_val_read24(const struct ltc2947_data *st, const u8 reg,\n\t\t\t\tu64 *val)\n{\n\t__be32 __val = 0;\n\tint ret;\n\n\tret = regmap_bulk_read(st->map, reg, &__val, 3);\n\tif (ret)\n\t\treturn ret;\n\n\t*val = be32_to_cpu(__val) >> 8;\n\n\treturn 0;\n}\n\nstatic int __ltc2947_val_read64(const struct ltc2947_data *st, const u8 reg,\n\t\t\t\tu64 *val)\n{\n\t__be64 __val = 0;\n\tint ret;\n\n\tret = regmap_bulk_read(st->map, reg, &__val, 6);\n\tif (ret)\n\t\treturn ret;\n\n\t*val = be64_to_cpu(__val) >> 16;\n\n\treturn 0;\n}\n\nstatic int ltc2947_val_read(struct ltc2947_data *st, const u8 reg,\n\t\t\t    const u8 page, const size_t size, s64 *val)\n{\n\tint ret;\n\tu64 __val = 0;\n\n\tmutex_lock(&st->lock);\n\n\tret = regmap_write(st->map, LTC2947_REG_PAGE_CTRL, page);\n\tif (ret) {\n\t\tmutex_unlock(&st->lock);\n\t\treturn ret;\n\t}\n\n\tdev_dbg(st->dev, \"Read val, reg:%02X, p:%d sz:%zu\\n\", reg, page,\n\t\tsize);\n\n\tswitch (size) {\n\tcase 2:\n\t\tret = __ltc2947_val_read16(st, reg, &__val);\n\t\tbreak;\n\tcase 3:\n\t\tret = __ltc2947_val_read24(st, reg, &__val);\n\t\tbreak;\n\tcase 6:\n\t\tret = __ltc2947_val_read64(st, reg, &__val);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\n\tmutex_unlock(&st->lock);\n\n\tif (ret)\n\t\treturn ret;\n\n\t*val = sign_extend64(__val, (8 * size) - 1);\n\n\tdev_dbg(st->dev, \"Got s:%lld, u:%016llX\\n\", *val, __val);\n\n\treturn 0;\n}\n\nstatic int __ltc2947_val_write64(const struct ltc2947_data *st, const u8 reg,\n\t\t\t\t const u64 val)\n{\n\t__be64 __val;\n\n\t__val = cpu_to_be64(val << 16);\n\treturn regmap_bulk_write(st->map, reg, &__val, 6);\n}\n\nstatic int __ltc2947_val_write16(const struct ltc2947_data *st, const u8 reg,\n\t\t\t\t const u16 val)\n{\n\t__be16 __val;\n\n\t__val = cpu_to_be16(val);\n\treturn regmap_bulk_write(st->map, reg, &__val, 2);\n}\n\nstatic int ltc2947_val_write(struct ltc2947_data *st, const u8 reg,\n\t\t\t     const u8 page, const size_t size, const u64 val)\n{\n\tint ret;\n\n\tmutex_lock(&st->lock);\n\t \n\tret = regmap_write(st->map, LTC2947_REG_PAGE_CTRL, page);\n\tif (ret) {\n\t\tmutex_unlock(&st->lock);\n\t\treturn ret;\n\t}\n\n\tdev_dbg(st->dev, \"Write val, r:%02X, p:%d, sz:%zu, val:%016llX\\n\",\n\t\treg, page, size, val);\n\n\tswitch (size) {\n\tcase 2:\n\t\tret = __ltc2947_val_write16(st, reg, val);\n\t\tbreak;\n\tcase 6:\n\t\tret = __ltc2947_val_write64(st, reg, val);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\n\tmutex_unlock(&st->lock);\n\n\treturn ret;\n}\n\nstatic int ltc2947_reset_history(struct ltc2947_data *st, const u8 reg_h,\n\t\t\t\t const u8 reg_l)\n{\n\tint ret;\n\t \n\tret = ltc2947_val_write(st, reg_h, LTC2947_PAGE0, 2, 0x8000U);\n\tif (ret)\n\t\treturn ret;\n\n\treturn ltc2947_val_write(st, reg_l, LTC2947_PAGE0, 2, 0x7FFFU);\n}\n\nstatic int ltc2947_alarm_read(struct ltc2947_data *st, const u8 reg,\n\t\t\t      const u32 mask, long *val)\n{\n\tu8 offset = reg - LTC2947_REG_STATUS;\n\t \n\tchar alarms[LTC2947_ALERTS_SIZE + 1];\n\tint ret = 0;\n\n\tmemset(alarms, 0, sizeof(alarms));\n\n\tmutex_lock(&st->lock);\n\n\tret = regmap_write(st->map, LTC2947_REG_PAGE_CTRL, LTC2947_PAGE0);\n\tif (ret)\n\t\tgoto unlock;\n\n\tdev_dbg(st->dev, \"Read alarm, reg:%02X, mask:%02X\\n\", reg, mask);\n\t \n\tret = regmap_bulk_read(st->map, LTC2947_REG_STATUS, alarms,\n\t\t\t       sizeof(alarms));\n\tif (ret)\n\t\tgoto unlock;\n\n\t \n\t*val = !!(alarms[offset] & mask);\nunlock:\n\tmutex_unlock(&st->lock);\n\treturn ret;\n}\n\nstatic ssize_t ltc2947_show_value(struct device *dev,\n\t\t\t\t  struct device_attribute *da, char *buf)\n{\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\n\tint ret;\n\ts64 val = 0;\n\n\tret = ltc2947_val_read(st, attr->index, LTC2947_PAGE0, 6, &val);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tval = div_s64(val * st->lsb_energy, 1000);\n\n\treturn sprintf(buf, \"%lld\\n\", val);\n}\n\nstatic int ltc2947_read_temp(struct device *dev, const u32 attr, long *val,\n\t\t\t     const int channel)\n{\n\tint ret;\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\ts64 __val = 0;\n\n\tswitch (attr) {\n\tcase hwmon_temp_input:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_TEMP, LTC2947_PAGE0,\n\t\t\t\t       2, &__val);\n\t\tbreak;\n\tcase hwmon_temp_highest:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_TEMP_MAX, LTC2947_PAGE0,\n\t\t\t\t       2, &__val);\n\t\tbreak;\n\tcase hwmon_temp_lowest:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_TEMP_MIN, LTC2947_PAGE0,\n\t\t\t\t       2, &__val);\n\t\tbreak;\n\tcase hwmon_temp_max_alarm:\n\t\tif (channel == LTC2947_TEMP_FAN_CHAN)\n\t\t\treturn ltc2947_alarm_read(st, LTC2947_REG_STATVT,\n\t\t\t\t\t\t  LTC2947_MAX_TEMP_FAN_MASK,\n\t\t\t\t\t\t  val);\n\n\t\treturn ltc2947_alarm_read(st, LTC2947_REG_STATVT,\n\t\t\t\t\t  LTC2947_MAX_TEMP_MASK, val);\n\tcase hwmon_temp_min_alarm:\n\t\tif (channel == LTC2947_TEMP_FAN_CHAN)\n\t\t\treturn\tltc2947_alarm_read(st, LTC2947_REG_STATVT,\n\t\t\t\t\t\t   LTC2947_MIN_TEMP_FAN_MASK,\n\t\t\t\t\t\t   val);\n\n\t\treturn\tltc2947_alarm_read(st, LTC2947_REG_STATVT,\n\t\t\t\t\t   LTC2947_MIN_TEMP_MASK, val);\n\tcase hwmon_temp_max:\n\t\tif (channel == LTC2947_TEMP_FAN_CHAN)\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_TEMP_FAN_THRE_H,\n\t\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\telse\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_TEMP_THRE_H,\n\t\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\tbreak;\n\tcase hwmon_temp_min:\n\t\tif (channel == LTC2947_TEMP_FAN_CHAN)\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_TEMP_FAN_THRE_L,\n\t\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\telse\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_TEMP_THRE_L,\n\t\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\tbreak;\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n\n\tif (ret)\n\t\treturn ret;\n\n\t \n\t*val = (__val * 204) + 5500;\n\n\treturn 0;\n}\n\nstatic int ltc2947_read_power(struct device *dev, const u32 attr, long *val)\n{\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\tint ret;\n\tu32 lsb = 200000;  \n\ts64 __val = 0;\n\n\tswitch (attr) {\n\tcase hwmon_power_input:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_POWER, LTC2947_PAGE0,\n\t\t\t\t       3, &__val);\n\t\tlsb = 50000;\n\t\tbreak;\n\tcase hwmon_power_input_highest:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_POWER_MAX, LTC2947_PAGE0,\n\t\t\t\t       2, &__val);\n\t\tbreak;\n\tcase hwmon_power_input_lowest:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_POWER_MIN, LTC2947_PAGE0,\n\t\t\t\t       2, &__val);\n\t\tbreak;\n\tcase hwmon_power_max_alarm:\n\t\treturn ltc2947_alarm_read(st, LTC2947_REG_STATIP,\n\t\t\t\t\t  LTC2947_MAX_POWER_MASK, val);\n\tcase hwmon_power_min_alarm:\n\t\treturn ltc2947_alarm_read(st, LTC2947_REG_STATIP,\n\t\t\t\t\t  LTC2947_MIN_POWER_MASK, val);\n\tcase hwmon_power_max:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_POWER_THRE_H,\n\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\tbreak;\n\tcase hwmon_power_min:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_POWER_THRE_L,\n\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\tbreak;\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n\n\tif (ret)\n\t\treturn ret;\n\n\t*val = __val * lsb;\n\n\treturn 0;\n}\n\nstatic int ltc2947_read_curr(struct device *dev, const u32 attr, long *val)\n{\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\tint ret;\n\tu8 lsb = 12;  \n\ts64 __val = 0;\n\n\tswitch (attr) {\n\tcase hwmon_curr_input:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_CURRENT,\n\t\t\t\t       LTC2947_PAGE0, 3, &__val);\n\t\tlsb = 3;\n\t\tbreak;\n\tcase hwmon_curr_highest:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_CURRENT_MAX,\n\t\t\t\t       LTC2947_PAGE0, 2, &__val);\n\t\tbreak;\n\tcase hwmon_curr_lowest:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_CURRENT_MIN,\n\t\t\t\t       LTC2947_PAGE0, 2, &__val);\n\t\tbreak;\n\tcase hwmon_curr_max_alarm:\n\t\treturn ltc2947_alarm_read(st, LTC2947_REG_STATIP,\n\t\t\t\t\t  LTC2947_MAX_CURRENT_MASK, val);\n\tcase hwmon_curr_min_alarm:\n\t\treturn ltc2947_alarm_read(st, LTC2947_REG_STATIP,\n\t\t\t\t\t  LTC2947_MIN_CURRENT_MASK, val);\n\tcase hwmon_curr_max:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_CURRENT_THRE_H,\n\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\tbreak;\n\tcase hwmon_curr_min:\n\t\tret = ltc2947_val_read(st, LTC2947_REG_CURRENT_THRE_L,\n\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\tbreak;\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n\n\tif (ret)\n\t\treturn ret;\n\n\t*val = __val * lsb;\n\n\treturn 0;\n}\n\nstatic int ltc2947_read_in(struct device *dev, const u32 attr, long *val,\n\t\t\t   const int channel)\n{\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\tint ret;\n\tu8 lsb = 2;  \n\ts64 __val = 0;\n\n\tif (channel < 0 || channel > LTC2947_VOLTAGE_DVCC_CHAN) {\n\t\tdev_err(st->dev, \"Invalid chan%d for voltage\", channel);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (attr) {\n\tcase hwmon_in_input:\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN) {\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_DVCC,\n\t\t\t\t\t       LTC2947_PAGE0, 2, &__val);\n\t\t\tlsb = 145;\n\t\t} else {\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_VOLTAGE,\n\t\t\t\t\t       LTC2947_PAGE0, 2, &__val);\n\t\t}\n\t\tbreak;\n\tcase hwmon_in_highest:\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN) {\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_DVCC_MAX,\n\t\t\t\t\t       LTC2947_PAGE0, 2, &__val);\n\t\t\tlsb = 145;\n\t\t} else {\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_VOLTAGE_MAX,\n\t\t\t\t\t       LTC2947_PAGE0, 2, &__val);\n\t\t}\n\t\tbreak;\n\tcase hwmon_in_lowest:\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN) {\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_DVCC_MIN,\n\t\t\t\t\t       LTC2947_PAGE0, 2, &__val);\n\t\t\tlsb = 145;\n\t\t} else {\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_VOLTAGE_MIN,\n\t\t\t\t\t       LTC2947_PAGE0, 2, &__val);\n\t\t}\n\t\tbreak;\n\tcase hwmon_in_max_alarm:\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN)\n\t\t\treturn ltc2947_alarm_read(st, LTC2947_REG_STATVDVCC,\n\t\t\t\t\t\t  LTC2947_MAX_VOLTAGE_MASK,\n\t\t\t\t\t\t  val);\n\n\t\treturn ltc2947_alarm_read(st, LTC2947_REG_STATVT,\n\t\t\t\t\t  LTC2947_MAX_VOLTAGE_MASK, val);\n\tcase hwmon_in_min_alarm:\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN)\n\t\t\treturn ltc2947_alarm_read(st, LTC2947_REG_STATVDVCC,\n\t\t\t\t\t\t  LTC2947_MIN_VOLTAGE_MASK,\n\t\t\t\t\t\t  val);\n\n\t\treturn ltc2947_alarm_read(st, LTC2947_REG_STATVT,\n\t\t\t\t\t  LTC2947_MIN_VOLTAGE_MASK, val);\n\tcase hwmon_in_max:\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN) {\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_DVCC_THRE_H,\n\t\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\t\tlsb = 145;\n\t\t} else {\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_VOLTAGE_THRE_H,\n\t\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\t}\n\t\tbreak;\n\tcase hwmon_in_min:\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN) {\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_DVCC_THRE_L,\n\t\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\t\tlsb = 145;\n\t\t} else {\n\t\t\tret = ltc2947_val_read(st, LTC2947_REG_VOLTAGE_THRE_L,\n\t\t\t\t\t       LTC2947_PAGE1, 2, &__val);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n\n\tif (ret)\n\t\treturn ret;\n\n\t*val = __val * lsb;\n\n\treturn 0;\n}\n\nstatic int ltc2947_read(struct device *dev, enum hwmon_sensor_types type,\n\t\t\tu32 attr, int channel, long *val)\n{\n\tswitch (type) {\n\tcase hwmon_in:\n\t\treturn ltc2947_read_in(dev, attr, val, channel);\n\tcase hwmon_curr:\n\t\treturn ltc2947_read_curr(dev, attr, val);\n\tcase hwmon_power:\n\t\treturn ltc2947_read_power(dev, attr, val);\n\tcase hwmon_temp:\n\t\treturn ltc2947_read_temp(dev, attr, val, channel);\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n}\n\nstatic int ltc2947_write_temp(struct device *dev, const u32 attr,\n\t\t\t      long val, const int channel)\n{\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\n\tif (channel < 0 || channel > LTC2947_TEMP_FAN_CHAN) {\n\t\tdev_err(st->dev, \"Invalid chan%d for temperature\", channel);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (attr) {\n\tcase hwmon_temp_reset_history:\n\t\tif (val != 1)\n\t\t\treturn -EINVAL;\n\t\treturn ltc2947_reset_history(st, LTC2947_REG_TEMP_MAX,\n\t\t\t\t\t     LTC2947_REG_TEMP_MIN);\n\tcase hwmon_temp_max:\n\t\tval = clamp_val(val, TEMP_MIN, TEMP_MAX);\n\t\tif (channel == LTC2947_TEMP_FAN_CHAN) {\n\t\t\tif (!st->gpio_out)\n\t\t\t\treturn -ENOTSUPP;\n\n\t\t\treturn ltc2947_val_write(st,\n\t\t\t\t\tLTC2947_REG_TEMP_FAN_THRE_H,\n\t\t\t\t\tLTC2947_PAGE1, 2,\n\t\t\t\t\tDIV_ROUND_CLOSEST(val - 550, 204));\n\t\t}\n\n\t\treturn ltc2947_val_write(st, LTC2947_REG_TEMP_THRE_H,\n\t\t\t\t\t LTC2947_PAGE1, 2,\n\t\t\t\t\t DIV_ROUND_CLOSEST(val - 550, 204));\n\tcase hwmon_temp_min:\n\t\tval = clamp_val(val, TEMP_MIN, TEMP_MAX);\n\t\tif (channel == LTC2947_TEMP_FAN_CHAN) {\n\t\t\tif (!st->gpio_out)\n\t\t\t\treturn -ENOTSUPP;\n\n\t\t\treturn ltc2947_val_write(st,\n\t\t\t\t\tLTC2947_REG_TEMP_FAN_THRE_L,\n\t\t\t\t\tLTC2947_PAGE1, 2,\n\t\t\t\t\tDIV_ROUND_CLOSEST(val - 550, 204));\n\t\t}\n\n\t\treturn ltc2947_val_write(st, LTC2947_REG_TEMP_THRE_L,\n\t\t\t\t\t LTC2947_PAGE1, 2,\n\t\t\t\t\t DIV_ROUND_CLOSEST(val - 550, 204));\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n}\n\nstatic int ltc2947_write_power(struct device *dev, const u32 attr,\n\t\t\t       long val)\n{\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\n\tswitch (attr) {\n\tcase hwmon_power_reset_history:\n\t\tif (val != 1)\n\t\t\treturn -EINVAL;\n\t\treturn ltc2947_reset_history(st, LTC2947_REG_POWER_MAX,\n\t\t\t\t\t     LTC2947_REG_POWER_MIN);\n\tcase hwmon_power_max:\n\t\tval = clamp_val(val, POWER_MIN, POWER_MAX);\n\t\treturn ltc2947_val_write(st, LTC2947_REG_POWER_THRE_H,\n\t\t\t\t\t LTC2947_PAGE1, 2,\n\t\t\t\t\t DIV_ROUND_CLOSEST(val, 200000));\n\tcase hwmon_power_min:\n\t\tval = clamp_val(val, POWER_MIN, POWER_MAX);\n\t\treturn ltc2947_val_write(st, LTC2947_REG_POWER_THRE_L,\n\t\t\t\t\t LTC2947_PAGE1, 2,\n\t\t\t\t\t DIV_ROUND_CLOSEST(val, 200000));\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n}\n\nstatic int ltc2947_write_curr(struct device *dev, const u32 attr,\n\t\t\t      long val)\n{\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\n\tswitch (attr) {\n\tcase hwmon_curr_reset_history:\n\t\tif (val != 1)\n\t\t\treturn -EINVAL;\n\t\treturn ltc2947_reset_history(st, LTC2947_REG_CURRENT_MAX,\n\t\t\t\t\t     LTC2947_REG_CURRENT_MIN);\n\tcase hwmon_curr_max:\n\t\tval = clamp_val(val, CURRENT_MIN, CURRENT_MAX);\n\t\treturn ltc2947_val_write(st, LTC2947_REG_CURRENT_THRE_H,\n\t\t\t\t\t LTC2947_PAGE1, 2,\n\t\t\t\t\t DIV_ROUND_CLOSEST(val, 12));\n\tcase hwmon_curr_min:\n\t\tval = clamp_val(val, CURRENT_MIN, CURRENT_MAX);\n\t\treturn ltc2947_val_write(st, LTC2947_REG_CURRENT_THRE_L,\n\t\t\t\t\t LTC2947_PAGE1, 2,\n\t\t\t\t\t DIV_ROUND_CLOSEST(val, 12));\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n}\n\nstatic int ltc2947_write_in(struct device *dev, const u32 attr, long val,\n\t\t\t    const int channel)\n{\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\n\tif (channel > LTC2947_VOLTAGE_DVCC_CHAN) {\n\t\tdev_err(st->dev, \"Invalid chan%d for voltage\", channel);\n\t\treturn -EINVAL;\n\t}\n\n\tswitch (attr) {\n\tcase hwmon_in_reset_history:\n\t\tif (val != 1)\n\t\t\treturn -EINVAL;\n\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN)\n\t\t\treturn ltc2947_reset_history(st, LTC2947_REG_DVCC_MAX,\n\t\t\t\t\t\t     LTC2947_REG_DVCC_MIN);\n\n\t\treturn ltc2947_reset_history(st, LTC2947_REG_VOLTAGE_MAX,\n\t\t\t\t\t     LTC2947_REG_VOLTAGE_MIN);\n\tcase hwmon_in_max:\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN) {\n\t\t\tval = clamp_val(val, VDVCC_MIN, VDVCC_MAX);\n\t\t\treturn ltc2947_val_write(st, LTC2947_REG_DVCC_THRE_H,\n\t\t\t\t\t\t LTC2947_PAGE1, 2,\n\t\t\t\t\t\t DIV_ROUND_CLOSEST(val, 145));\n\t\t}\n\n\t\tval = clamp_val(val, VOLTAGE_MIN, VOLTAGE_MAX);\n\t\treturn ltc2947_val_write(st, LTC2947_REG_VOLTAGE_THRE_H,\n\t\t\t\t\t LTC2947_PAGE1, 2,\n\t\t\t\t\t DIV_ROUND_CLOSEST(val, 2));\n\tcase hwmon_in_min:\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN) {\n\t\t\tval = clamp_val(val, VDVCC_MIN, VDVCC_MAX);\n\t\t\treturn ltc2947_val_write(st, LTC2947_REG_DVCC_THRE_L,\n\t\t\t\t\t\t LTC2947_PAGE1, 2,\n\t\t\t\t\t\t DIV_ROUND_CLOSEST(val, 145));\n\t\t}\n\n\t\tval = clamp_val(val, VOLTAGE_MIN, VOLTAGE_MAX);\n\t\treturn ltc2947_val_write(st, LTC2947_REG_VOLTAGE_THRE_L,\n\t\t\t\t\t LTC2947_PAGE1, 2,\n\t\t\t\t\t DIV_ROUND_CLOSEST(val, 2));\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n}\n\nstatic int ltc2947_write(struct device *dev,\n\t\t\t enum hwmon_sensor_types type,\n\t\t\t u32 attr, int channel, long val)\n{\n\tswitch (type) {\n\tcase hwmon_in:\n\t\treturn ltc2947_write_in(dev, attr, val, channel);\n\tcase hwmon_curr:\n\t\treturn ltc2947_write_curr(dev, attr, val);\n\tcase hwmon_power:\n\t\treturn ltc2947_write_power(dev, attr, val);\n\tcase hwmon_temp:\n\t\treturn ltc2947_write_temp(dev, attr, val, channel);\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n}\n\nstatic int ltc2947_read_labels(struct device *dev,\n\t\t\t       enum hwmon_sensor_types type,\n\t\t\t       u32 attr, int channel, const char **str)\n{\n\tswitch (type) {\n\tcase hwmon_in:\n\t\tif (channel == LTC2947_VOLTAGE_DVCC_CHAN)\n\t\t\t*str = \"DVCC\";\n\t\telse\n\t\t\t*str = \"VP-VM\";\n\t\treturn 0;\n\tcase hwmon_curr:\n\t\t*str = \"IP-IM\";\n\t\treturn 0;\n\tcase hwmon_temp:\n\t\tif (channel == LTC2947_TEMP_FAN_CHAN)\n\t\t\t*str = \"TEMPFAN\";\n\t\telse\n\t\t\t*str = \"Ambient\";\n\t\treturn 0;\n\tcase hwmon_power:\n\t\t*str = \"Power\";\n\t\treturn 0;\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n}\n\nstatic int ltc2947_in_is_visible(const u32 attr)\n{\n\tswitch (attr) {\n\tcase hwmon_in_input:\n\tcase hwmon_in_highest:\n\tcase hwmon_in_lowest:\n\tcase hwmon_in_max_alarm:\n\tcase hwmon_in_min_alarm:\n\tcase hwmon_in_label:\n\t\treturn 0444;\n\tcase hwmon_in_reset_history:\n\t\treturn 0200;\n\tcase hwmon_in_max:\n\tcase hwmon_in_min:\n\t\treturn 0644;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic int ltc2947_curr_is_visible(const u32 attr)\n{\n\tswitch (attr) {\n\tcase hwmon_curr_input:\n\tcase hwmon_curr_highest:\n\tcase hwmon_curr_lowest:\n\tcase hwmon_curr_max_alarm:\n\tcase hwmon_curr_min_alarm:\n\tcase hwmon_curr_label:\n\t\treturn 0444;\n\tcase hwmon_curr_reset_history:\n\t\treturn 0200;\n\tcase hwmon_curr_max:\n\tcase hwmon_curr_min:\n\t\treturn 0644;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic int ltc2947_power_is_visible(const u32 attr)\n{\n\tswitch (attr) {\n\tcase hwmon_power_input:\n\tcase hwmon_power_input_highest:\n\tcase hwmon_power_input_lowest:\n\tcase hwmon_power_label:\n\tcase hwmon_power_max_alarm:\n\tcase hwmon_power_min_alarm:\n\t\treturn 0444;\n\tcase hwmon_power_reset_history:\n\t\treturn 0200;\n\tcase hwmon_power_max:\n\tcase hwmon_power_min:\n\t\treturn 0644;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic int ltc2947_temp_is_visible(const u32 attr)\n{\n\tswitch (attr) {\n\tcase hwmon_temp_input:\n\tcase hwmon_temp_highest:\n\tcase hwmon_temp_lowest:\n\tcase hwmon_temp_max_alarm:\n\tcase hwmon_temp_min_alarm:\n\tcase hwmon_temp_label:\n\t\treturn 0444;\n\tcase hwmon_temp_reset_history:\n\t\treturn 0200;\n\tcase hwmon_temp_max:\n\tcase hwmon_temp_min:\n\t\treturn 0644;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic umode_t ltc2947_is_visible(const void *data,\n\t\t\t\t  enum hwmon_sensor_types type,\n\t\t\t\t  u32 attr, int channel)\n{\n\tswitch (type) {\n\tcase hwmon_in:\n\t\treturn ltc2947_in_is_visible(attr);\n\tcase hwmon_curr:\n\t\treturn ltc2947_curr_is_visible(attr);\n\tcase hwmon_power:\n\t\treturn ltc2947_power_is_visible(attr);\n\tcase hwmon_temp:\n\t\treturn ltc2947_temp_is_visible(attr);\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\nstatic const struct hwmon_channel_info * const ltc2947_info[] = {\n\tHWMON_CHANNEL_INFO(in,\n\t\t\t   HWMON_I_INPUT | HWMON_I_LOWEST | HWMON_I_HIGHEST |\n\t\t\t   HWMON_I_MAX | HWMON_I_MIN | HWMON_I_RESET_HISTORY |\n\t\t\t   HWMON_I_MIN_ALARM | HWMON_I_MAX_ALARM |\n\t\t\t   HWMON_I_LABEL,\n\t\t\t   HWMON_I_INPUT | HWMON_I_LOWEST | HWMON_I_HIGHEST |\n\t\t\t   HWMON_I_MAX | HWMON_I_MIN | HWMON_I_RESET_HISTORY |\n\t\t\t   HWMON_I_MIN_ALARM | HWMON_I_MAX_ALARM |\n\t\t\t   HWMON_I_LABEL),\n\tHWMON_CHANNEL_INFO(curr,\n\t\t\t   HWMON_C_INPUT | HWMON_C_LOWEST | HWMON_C_HIGHEST |\n\t\t\t   HWMON_C_MAX | HWMON_C_MIN | HWMON_C_RESET_HISTORY |\n\t\t\t   HWMON_C_MIN_ALARM | HWMON_C_MAX_ALARM |\n\t\t\t   HWMON_C_LABEL),\n\tHWMON_CHANNEL_INFO(power,\n\t\t\t   HWMON_P_INPUT | HWMON_P_INPUT_LOWEST |\n\t\t\t   HWMON_P_INPUT_HIGHEST | HWMON_P_MAX | HWMON_P_MIN |\n\t\t\t   HWMON_P_RESET_HISTORY | HWMON_P_MAX_ALARM |\n\t\t\t   HWMON_P_MIN_ALARM | HWMON_P_LABEL),\n\tHWMON_CHANNEL_INFO(temp,\n\t\t\t   HWMON_T_INPUT | HWMON_T_LOWEST | HWMON_T_HIGHEST |\n\t\t\t   HWMON_T_MAX | HWMON_T_MIN | HWMON_T_RESET_HISTORY |\n\t\t\t   HWMON_T_MIN_ALARM | HWMON_T_MAX_ALARM |\n\t\t\t   HWMON_T_LABEL,\n\t\t\t   HWMON_T_MAX_ALARM | HWMON_T_MIN_ALARM | HWMON_T_MAX |\n\t\t\t   HWMON_T_MIN | HWMON_T_LABEL),\n\tNULL\n};\n\nstatic const struct hwmon_ops ltc2947_hwmon_ops = {\n\t.is_visible = ltc2947_is_visible,\n\t.read = ltc2947_read,\n\t.write = ltc2947_write,\n\t.read_string = ltc2947_read_labels,\n};\n\nstatic const struct hwmon_chip_info ltc2947_chip_info = {\n\t.ops = &ltc2947_hwmon_ops,\n\t.info = ltc2947_info,\n};\n\n \nstatic SENSOR_DEVICE_ATTR(energy1_input, 0444, ltc2947_show_value, NULL,\n\t\t\t  LTC2947_REG_ENERGY1);\nstatic SENSOR_DEVICE_ATTR(energy2_input, 0444, ltc2947_show_value, NULL,\n\t\t\t  LTC2947_REG_ENERGY2);\n\nstatic struct attribute *ltc2947_attrs[] = {\n\t&sensor_dev_attr_energy1_input.dev_attr.attr,\n\t&sensor_dev_attr_energy2_input.dev_attr.attr,\n\tNULL,\n};\nATTRIBUTE_GROUPS(ltc2947);\n\nstatic int ltc2947_setup(struct ltc2947_data *st)\n{\n\tint ret;\n\tstruct clk *extclk;\n\tu32 dummy, deadband, pol;\n\tu32 accum[2];\n\n\t \n\tret = regmap_read(st->map, LTC2947_REG_STATUS, &dummy);\n\tif (ret)\n\t\treturn ret;\n\t \n\tret = ltc2947_val_write(st, LTC2947_REG_POWER_THRE_H, LTC2947_PAGE1, 2,\n\t\t\t\tPOWER_MAX / 200000);\n\tif (ret)\n\t\treturn ret;\n\n\tret = ltc2947_val_write(st, LTC2947_REG_POWER_THRE_L, LTC2947_PAGE1, 2,\n\t\t\t\tPOWER_MIN / 200000);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\textclk = devm_clk_get_optional_enabled(st->dev, NULL);\n\tif (IS_ERR(extclk))\n\t\treturn dev_err_probe(st->dev, PTR_ERR(extclk),\n\t\t\t\t     \"Failed to get external clock\\n\");\n\n\tif (extclk) {\n\t\tunsigned long rate_hz;\n\t\tu8 pre = 0, div, tbctl;\n\t\tu64 aux;\n\n\t\t \n\t\trate_hz = clk_get_rate(extclk);\n\t\tif (rate_hz < LTC2947_CLK_MIN || rate_hz > LTC2947_CLK_MAX) {\n\t\t\tdev_err(st->dev, \"Invalid rate:%lu for external clock\",\n\t\t\t\trate_hz);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\t \n\t\tif (rate_hz >= LTC2947_CLK_MIN && rate_hz <= 1000000)\n\t\t\tpre = 0;\n\t\telse if (rate_hz > 1000000 && rate_hz <= 2000000)\n\t\t\tpre = 1;\n\t\telse if (rate_hz > 2000000 && rate_hz <= 4000000)\n\t\t\tpre = 2;\n\t\telse if (rate_hz > 4000000 && rate_hz <= 8000000)\n\t\t\tpre = 3;\n\t\telse if (rate_hz > 8000000 && rate_hz <= 16000000)\n\t\t\tpre = 4;\n\t\telse if (rate_hz > 16000000 && rate_hz <= LTC2947_CLK_MAX)\n\t\t\tpre = 5;\n\t\t \n\t\tdiv = rate_hz / ((1 << pre) * 32768);\n\t\ttbctl = LTC2947_PRE(pre) | LTC2947_DIV(div);\n\n\t\tret = regmap_write(st->map, LTC2947_REG_TBCTL, tbctl);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\t \n\t\taux = (div + 1) * ((1 << pre) * 641600000ULL);\n\t\tst->lsb_energy = DIV_ROUND_CLOSEST_ULL(aux, rate_hz);\n\t} else {\n\t\t \n\t\tst->lsb_energy = 19890;\n\t}\n\tret = of_property_read_u32_array(st->dev->of_node,\n\t\t\t\t\t \"adi,accumulator-ctl-pol\", accum,\n\t\t\t\t\t  ARRAY_SIZE(accum));\n\tif (!ret) {\n\t\tu32 accum_reg = LTC2947_ACCUM_POL_1(accum[0]) |\n\t\t\t\tLTC2947_ACCUM_POL_2(accum[1]);\n\n\t\tret = regmap_write(st->map, LTC2947_REG_ACCUM_POL, accum_reg);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\tret = of_property_read_u32(st->dev->of_node,\n\t\t\t\t   \"adi,accumulation-deadband-microamp\",\n\t\t\t\t   &deadband);\n\tif (!ret) {\n\t\t \n\t\tret = regmap_write(st->map, LTC2947_REG_ACCUM_DEADBAND,\n\t\t\t\t   deadband / (1000 * 3));\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\t \n\tret = of_property_read_u32(st->dev->of_node, \"adi,gpio-out-pol\", &pol);\n\tif (!ret) {\n\t\t \n\t\tu32 gpio_ctl = LTC2947_GPIO_EN(1) | LTC2947_GPIO_FAN_EN(1) |\n\t\t\tLTC2947_GPIO_FAN_POL(pol);\n\n\t\tst->gpio_out = true;\n\t\tret = regmap_write(st->map, LTC2947_REG_GPIOSTATCTL, gpio_ctl);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\tret = of_property_read_u32_array(st->dev->of_node, \"adi,gpio-in-accum\",\n\t\t\t\t\t accum, ARRAY_SIZE(accum));\n\tif (!ret) {\n\t\t \n\t\tu32 accum_val = LTC2947_ACCUM_POL_1(accum[0]) |\n\t\t\t\tLTC2947_ACCUM_POL_2(accum[1]);\n\n\t\tif (st->gpio_out) {\n\t\t\tdev_err(st->dev,\n\t\t\t\t\"Cannot have input gpio config if already configured as output\");\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tret = regmap_write(st->map, LTC2947_REG_GPIO_ACCUM, accum_val);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\t \n\treturn regmap_update_bits(st->map, LTC2947_REG_CTRL,\n\t\t\t\t  LTC2947_CONT_MODE_MASK, LTC2947_CONT_MODE(1));\n}\n\nint ltc2947_core_probe(struct regmap *map, const char *name)\n{\n\tstruct ltc2947_data *st;\n\tstruct device *dev = regmap_get_device(map);\n\tstruct device *hwmon;\n\tint ret;\n\n\tst = devm_kzalloc(dev, sizeof(*st), GFP_KERNEL);\n\tif (!st)\n\t\treturn -ENOMEM;\n\n\tst->map = map;\n\tst->dev = dev;\n\tdev_set_drvdata(dev, st);\n\tmutex_init(&st->lock);\n\n\tret = ltc2947_setup(st);\n\tif (ret)\n\t\treturn ret;\n\n\thwmon = devm_hwmon_device_register_with_info(dev, name, st,\n\t\t\t\t\t\t     &ltc2947_chip_info,\n\t\t\t\t\t\t     ltc2947_groups);\n\treturn PTR_ERR_OR_ZERO(hwmon);\n}\nEXPORT_SYMBOL_GPL(ltc2947_core_probe);\n\nstatic int ltc2947_resume(struct device *dev)\n{\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\tu32 ctrl = 0;\n\tint ret;\n\n\t \n\tret = regmap_read(st->map, LTC2947_REG_CTRL, &ctrl);\n\tif (ret)\n\t\treturn ret;\n\t \n\tmsleep(110);\n\tret = regmap_read(st->map, LTC2947_REG_CTRL, &ctrl);\n\tif (ret)\n\t\treturn ret;\n\t \n\tif (ctrl != 0) {\n\t\tdev_err(st->dev, \"Device failed to wake up, ctl:%02X\\n\", ctrl);\n\t\treturn -ETIMEDOUT;\n\t}\n\n\t \n\treturn regmap_update_bits(st->map, LTC2947_REG_CTRL,\n\t\t\t\t  LTC2947_CONT_MODE_MASK, LTC2947_CONT_MODE(1));\n}\n\nstatic int ltc2947_suspend(struct device *dev)\n{\n\tstruct ltc2947_data *st = dev_get_drvdata(dev);\n\n\treturn regmap_update_bits(st->map, LTC2947_REG_CTRL,\n\t\t\t\t  LTC2947_SHUTDOWN_MASK, 1);\n}\n\nEXPORT_SIMPLE_DEV_PM_OPS(ltc2947_pm_ops, ltc2947_suspend, ltc2947_resume);\n\nconst struct of_device_id ltc2947_of_match[] = {\n\t{ .compatible = \"adi,ltc2947\" },\n\t{}\n};\nEXPORT_SYMBOL_GPL(ltc2947_of_match);\nMODULE_DEVICE_TABLE(of, ltc2947_of_match);\n\nMODULE_AUTHOR(\"Nuno Sa <nuno.sa@analog.com>\");\nMODULE_DESCRIPTION(\"LTC2947 power and energy monitor core driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}