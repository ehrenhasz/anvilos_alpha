{
  "module_name": "isl68137.c",
  "hash_id": "d1740331d5d69de5162c197e27dc622f07fe832a896361c9554f0ce512fd113b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/pmbus/isl68137.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/hwmon-sysfs.h>\n#include <linux/i2c.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/string.h>\n#include <linux/sysfs.h>\n\n#include \"pmbus.h\"\n\n#define ISL68137_VOUT_AVS\t0x30\n#define RAA_DMPVR2_READ_VMON\t0xc8\n\nenum chips {\n\tisl68137,\n\tisl68220,\n\tisl68221,\n\tisl68222,\n\tisl68223,\n\tisl68224,\n\tisl68225,\n\tisl68226,\n\tisl68227,\n\tisl68229,\n\tisl68233,\n\tisl68239,\n\tisl69222,\n\tisl69223,\n\tisl69224,\n\tisl69225,\n\tisl69227,\n\tisl69228,\n\tisl69234,\n\tisl69236,\n\tisl69239,\n\tisl69242,\n\tisl69243,\n\tisl69247,\n\tisl69248,\n\tisl69254,\n\tisl69255,\n\tisl69256,\n\tisl69259,\n\tisl69260,\n\tisl69268,\n\tisl69269,\n\tisl69298,\n\traa228000,\n\traa228004,\n\traa228006,\n\traa228228,\n\traa229001,\n\traa229004,\n};\n\nenum variants {\n\traa_dmpvr1_2rail,\n\traa_dmpvr2_1rail,\n\traa_dmpvr2_2rail,\n\traa_dmpvr2_2rail_nontc,\n\traa_dmpvr2_3rail,\n\traa_dmpvr2_hv,\n};\n\nstatic const struct i2c_device_id raa_dmpvr_id[];\n\nstatic ssize_t isl68137_avs_enable_show_page(struct i2c_client *client,\n\t\t\t\t\t     int page,\n\t\t\t\t\t     char *buf)\n{\n\tint val = pmbus_read_byte_data(client, page, PMBUS_OPERATION);\n\n\treturn sprintf(buf, \"%d\\n\",\n\t\t       (val & ISL68137_VOUT_AVS) == ISL68137_VOUT_AVS ? 1 : 0);\n}\n\nstatic ssize_t isl68137_avs_enable_store_page(struct i2c_client *client,\n\t\t\t\t\t      int page,\n\t\t\t\t\t      const char *buf, size_t count)\n{\n\tint rc, op_val;\n\tbool result;\n\n\trc = kstrtobool(buf, &result);\n\tif (rc)\n\t\treturn rc;\n\n\top_val = result ? ISL68137_VOUT_AVS : 0;\n\n\t \n\tif (op_val == ISL68137_VOUT_AVS) {\n\t\trc = pmbus_read_word_data(client, page, 0xff,\n\t\t\t\t\t  PMBUS_VOUT_COMMAND);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = pmbus_write_word_data(client, page, PMBUS_VOUT_COMMAND,\n\t\t\t\t\t   rc);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t}\n\n\trc = pmbus_update_byte_data(client, page, PMBUS_OPERATION,\n\t\t\t\t    ISL68137_VOUT_AVS, op_val);\n\n\treturn (rc < 0) ? rc : count;\n}\n\nstatic ssize_t isl68137_avs_enable_show(struct device *dev,\n\t\t\t\t\tstruct device_attribute *devattr,\n\t\t\t\t\tchar *buf)\n{\n\tstruct i2c_client *client = to_i2c_client(dev->parent);\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\n\treturn isl68137_avs_enable_show_page(client, attr->index, buf);\n}\n\nstatic ssize_t isl68137_avs_enable_store(struct device *dev,\n\t\t\t\tstruct device_attribute *devattr,\n\t\t\t\tconst char *buf, size_t count)\n{\n\tstruct i2c_client *client = to_i2c_client(dev->parent);\n\tstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\n\n\treturn isl68137_avs_enable_store_page(client, attr->index, buf, count);\n}\n\nstatic SENSOR_DEVICE_ATTR_RW(avs0_enable, isl68137_avs_enable, 0);\nstatic SENSOR_DEVICE_ATTR_RW(avs1_enable, isl68137_avs_enable, 1);\n\nstatic struct attribute *enable_attrs[] = {\n\t&sensor_dev_attr_avs0_enable.dev_attr.attr,\n\t&sensor_dev_attr_avs1_enable.dev_attr.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group enable_group = {\n\t.attrs = enable_attrs,\n};\n\nstatic const struct attribute_group *isl68137_attribute_groups[] = {\n\t&enable_group,\n\tNULL,\n};\n\nstatic int raa_dmpvr2_read_word_data(struct i2c_client *client, int page,\n\t\t\t\t     int phase, int reg)\n{\n\tint ret;\n\n\tswitch (reg) {\n\tcase PMBUS_VIRT_READ_VMON:\n\t\tret = pmbus_read_word_data(client, page, phase,\n\t\t\t\t\t   RAA_DMPVR2_READ_VMON);\n\t\tbreak;\n\tdefault:\n\t\tret = -ENODATA;\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic struct pmbus_driver_info raa_dmpvr_info = {\n\t.pages = 3,\n\t.format[PSC_VOLTAGE_IN] = direct,\n\t.format[PSC_VOLTAGE_OUT] = direct,\n\t.format[PSC_CURRENT_IN] = direct,\n\t.format[PSC_CURRENT_OUT] = direct,\n\t.format[PSC_POWER] = direct,\n\t.format[PSC_TEMPERATURE] = direct,\n\t.m[PSC_VOLTAGE_IN] = 1,\n\t.b[PSC_VOLTAGE_IN] = 0,\n\t.R[PSC_VOLTAGE_IN] = 2,\n\t.m[PSC_VOLTAGE_OUT] = 1,\n\t.b[PSC_VOLTAGE_OUT] = 0,\n\t.R[PSC_VOLTAGE_OUT] = 3,\n\t.m[PSC_CURRENT_IN] = 1,\n\t.b[PSC_CURRENT_IN] = 0,\n\t.R[PSC_CURRENT_IN] = 2,\n\t.m[PSC_CURRENT_OUT] = 1,\n\t.b[PSC_CURRENT_OUT] = 0,\n\t.R[PSC_CURRENT_OUT] = 1,\n\t.m[PSC_POWER] = 1,\n\t.b[PSC_POWER] = 0,\n\t.R[PSC_POWER] = 0,\n\t.m[PSC_TEMPERATURE] = 1,\n\t.b[PSC_TEMPERATURE] = 0,\n\t.R[PSC_TEMPERATURE] = 0,\n\t.func[0] = PMBUS_HAVE_VIN | PMBUS_HAVE_IIN | PMBUS_HAVE_PIN\n\t    | PMBUS_HAVE_STATUS_INPUT | PMBUS_HAVE_TEMP | PMBUS_HAVE_TEMP2\n\t    | PMBUS_HAVE_TEMP3 | PMBUS_HAVE_STATUS_TEMP\n\t    | PMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT\n\t    | PMBUS_HAVE_IOUT | PMBUS_HAVE_STATUS_IOUT | PMBUS_HAVE_POUT\n\t\t| PMBUS_HAVE_VMON,\n\t.func[1] = PMBUS_HAVE_IIN | PMBUS_HAVE_PIN | PMBUS_HAVE_STATUS_INPUT\n\t    | PMBUS_HAVE_TEMP | PMBUS_HAVE_TEMP3 | PMBUS_HAVE_STATUS_TEMP\n\t    | PMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT | PMBUS_HAVE_IOUT\n\t    | PMBUS_HAVE_STATUS_IOUT | PMBUS_HAVE_POUT,\n\t.func[2] = PMBUS_HAVE_IIN | PMBUS_HAVE_PIN | PMBUS_HAVE_STATUS_INPUT\n\t    | PMBUS_HAVE_TEMP | PMBUS_HAVE_TEMP3 | PMBUS_HAVE_STATUS_TEMP\n\t    | PMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT | PMBUS_HAVE_IOUT\n\t    | PMBUS_HAVE_STATUS_IOUT | PMBUS_HAVE_POUT,\n};\n\nstatic int isl68137_probe(struct i2c_client *client)\n{\n\tstruct pmbus_driver_info *info;\n\n\tinfo = devm_kzalloc(&client->dev, sizeof(*info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\tmemcpy(info, &raa_dmpvr_info, sizeof(*info));\n\n\tswitch (i2c_match_id(raa_dmpvr_id, client)->driver_data) {\n\tcase raa_dmpvr1_2rail:\n\t\tinfo->pages = 2;\n\t\tinfo->R[PSC_VOLTAGE_IN] = 3;\n\t\tinfo->func[0] &= ~PMBUS_HAVE_VMON;\n\t\tinfo->func[1] = PMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT\n\t\t    | PMBUS_HAVE_IOUT | PMBUS_HAVE_STATUS_IOUT\n\t\t    | PMBUS_HAVE_POUT;\n\t\tinfo->groups = isl68137_attribute_groups;\n\t\tbreak;\n\tcase raa_dmpvr2_1rail:\n\t\tinfo->pages = 1;\n\t\tinfo->read_word_data = raa_dmpvr2_read_word_data;\n\t\tbreak;\n\tcase raa_dmpvr2_2rail_nontc:\n\t\tinfo->func[0] &= ~PMBUS_HAVE_TEMP3;\n\t\tinfo->func[1] &= ~PMBUS_HAVE_TEMP3;\n\t\tfallthrough;\n\tcase raa_dmpvr2_2rail:\n\t\tinfo->pages = 2;\n\t\tinfo->read_word_data = raa_dmpvr2_read_word_data;\n\t\tbreak;\n\tcase raa_dmpvr2_3rail:\n\t\tinfo->read_word_data = raa_dmpvr2_read_word_data;\n\t\tbreak;\n\tcase raa_dmpvr2_hv:\n\t\tinfo->pages = 1;\n\t\tinfo->R[PSC_VOLTAGE_IN] = 1;\n\t\tinfo->m[PSC_VOLTAGE_OUT] = 2;\n\t\tinfo->R[PSC_VOLTAGE_OUT] = 2;\n\t\tinfo->m[PSC_CURRENT_IN] = 2;\n\t\tinfo->m[PSC_POWER] = 2;\n\t\tinfo->R[PSC_POWER] = -1;\n\t\tinfo->read_word_data = raa_dmpvr2_read_word_data;\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n\n\treturn pmbus_do_probe(client, info);\n}\n\nstatic const struct i2c_device_id raa_dmpvr_id[] = {\n\t{\"isl68137\", raa_dmpvr1_2rail},\n\t{\"isl68220\", raa_dmpvr2_2rail},\n\t{\"isl68221\", raa_dmpvr2_3rail},\n\t{\"isl68222\", raa_dmpvr2_2rail},\n\t{\"isl68223\", raa_dmpvr2_2rail},\n\t{\"isl68224\", raa_dmpvr2_3rail},\n\t{\"isl68225\", raa_dmpvr2_2rail},\n\t{\"isl68226\", raa_dmpvr2_3rail},\n\t{\"isl68227\", raa_dmpvr2_1rail},\n\t{\"isl68229\", raa_dmpvr2_3rail},\n\t{\"isl68233\", raa_dmpvr2_2rail},\n\t{\"isl68239\", raa_dmpvr2_3rail},\n\n\t{\"isl69222\", raa_dmpvr2_2rail},\n\t{\"isl69223\", raa_dmpvr2_3rail},\n\t{\"isl69224\", raa_dmpvr2_2rail},\n\t{\"isl69225\", raa_dmpvr2_2rail},\n\t{\"isl69227\", raa_dmpvr2_3rail},\n\t{\"isl69228\", raa_dmpvr2_3rail},\n\t{\"isl69234\", raa_dmpvr2_2rail},\n\t{\"isl69236\", raa_dmpvr2_2rail},\n\t{\"isl69239\", raa_dmpvr2_3rail},\n\t{\"isl69242\", raa_dmpvr2_2rail},\n\t{\"isl69243\", raa_dmpvr2_1rail},\n\t{\"isl69247\", raa_dmpvr2_2rail},\n\t{\"isl69248\", raa_dmpvr2_2rail},\n\t{\"isl69254\", raa_dmpvr2_2rail},\n\t{\"isl69255\", raa_dmpvr2_2rail},\n\t{\"isl69256\", raa_dmpvr2_2rail},\n\t{\"isl69259\", raa_dmpvr2_2rail},\n\t{\"isl69260\", raa_dmpvr2_2rail},\n\t{\"isl69268\", raa_dmpvr2_2rail},\n\t{\"isl69269\", raa_dmpvr2_3rail},\n\t{\"isl69298\", raa_dmpvr2_2rail},\n\n\t{\"raa228000\", raa_dmpvr2_hv},\n\t{\"raa228004\", raa_dmpvr2_hv},\n\t{\"raa228006\", raa_dmpvr2_hv},\n\t{\"raa228228\", raa_dmpvr2_2rail_nontc},\n\t{\"raa229001\", raa_dmpvr2_2rail},\n\t{\"raa229004\", raa_dmpvr2_2rail},\n\t{}\n};\n\nMODULE_DEVICE_TABLE(i2c, raa_dmpvr_id);\n\n \nstatic struct i2c_driver isl68137_driver = {\n\t.driver = {\n\t\t   .name = \"isl68137\",\n\t\t   },\n\t.probe = isl68137_probe,\n\t.id_table = raa_dmpvr_id,\n};\n\nmodule_i2c_driver(isl68137_driver);\n\nMODULE_AUTHOR(\"Maxim Sloyko <maxims@google.com>\");\nMODULE_DESCRIPTION(\"PMBus driver for Renesas digital multiphase voltage regulators\");\nMODULE_LICENSE(\"GPL\");\nMODULE_IMPORT_NS(PMBUS);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}