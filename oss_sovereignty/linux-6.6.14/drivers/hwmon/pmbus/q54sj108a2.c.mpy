{
  "module_name": "q54sj108a2.c",
  "hash_id": "20dd29799cf6eb69d53082d6587c245ce5128147fbf49e1264c91d8ae7194913",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/pmbus/q54sj108a2.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/i2c.h>\n#include <linux/kstrtox.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include \"pmbus.h\"\n\n#define STORE_DEFAULT_ALL\t\t0x11\n#define ERASE_BLACKBOX_DATA\t\t0xD1\n#define READ_HISTORY_EVENT_NUMBER\t0xD2\n#define READ_HISTORY_EVENTS\t\t0xE0\n#define SET_HISTORY_EVENT_OFFSET\t0xE1\n#define PMBUS_FLASH_KEY_WRITE\t\t0xEC\n\nenum chips {\n\tq54sj108a2\n};\n\nenum {\n\tQ54SJ108A2_DEBUGFS_OPERATION = 0,\n\tQ54SJ108A2_DEBUGFS_CLEARFAULT,\n\tQ54SJ108A2_DEBUGFS_WRITEPROTECT,\n\tQ54SJ108A2_DEBUGFS_STOREDEFAULT,\n\tQ54SJ108A2_DEBUGFS_VOOV_RESPONSE,\n\tQ54SJ108A2_DEBUGFS_IOOC_RESPONSE,\n\tQ54SJ108A2_DEBUGFS_PMBUS_VERSION,\n\tQ54SJ108A2_DEBUGFS_MFR_ID,\n\tQ54SJ108A2_DEBUGFS_MFR_MODEL,\n\tQ54SJ108A2_DEBUGFS_MFR_REVISION,\n\tQ54SJ108A2_DEBUGFS_MFR_LOCATION,\n\tQ54SJ108A2_DEBUGFS_BLACKBOX_ERASE,\n\tQ54SJ108A2_DEBUGFS_BLACKBOX_READ_OFFSET,\n\tQ54SJ108A2_DEBUGFS_BLACKBOX_SET_OFFSET,\n\tQ54SJ108A2_DEBUGFS_BLACKBOX_READ,\n\tQ54SJ108A2_DEBUGFS_FLASH_KEY,\n\tQ54SJ108A2_DEBUGFS_NUM_ENTRIES\n};\n\nstruct q54sj108a2_data {\n\tenum chips chip;\n\tstruct i2c_client *client;\n\n\tint debugfs_entries[Q54SJ108A2_DEBUGFS_NUM_ENTRIES];\n};\n\n#define to_psu(x, y) container_of((x), struct q54sj108a2_data, debugfs_entries[(y)])\n\nstatic struct pmbus_driver_info q54sj108a2_info[] = {\n\t[q54sj108a2] = {\n\t\t.pages = 1,\n\n\t\t \n\t\t.format[PSC_TEMPERATURE] = linear,\n\t\t.format[PSC_VOLTAGE_IN] = linear,\n\t\t.format[PSC_CURRENT_OUT] = linear,\n\n\t\t.func[0] = PMBUS_HAVE_VIN |\n\t\tPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT |\n\t\tPMBUS_HAVE_IOUT | PMBUS_HAVE_STATUS_IOUT |\n\t\tPMBUS_HAVE_TEMP | PMBUS_HAVE_STATUS_TEMP |\n\t\tPMBUS_HAVE_STATUS_INPUT,\n\t},\n};\n\nstatic ssize_t q54sj108a2_debugfs_read(struct file *file, char __user *buf,\n\t\t\t\t       size_t count, loff_t *ppos)\n{\n\tint rc;\n\tint *idxp = file->private_data;\n\tint idx = *idxp;\n\tstruct q54sj108a2_data *psu = to_psu(idxp, idx);\n\tchar data[I2C_SMBUS_BLOCK_MAX + 2] = { 0 };\n\tchar data_char[I2C_SMBUS_BLOCK_MAX + 2] = { 0 };\n\tchar *res;\n\n\tswitch (idx) {\n\tcase Q54SJ108A2_DEBUGFS_OPERATION:\n\t\trc = i2c_smbus_read_byte_data(psu->client, PMBUS_OPERATION);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = snprintf(data, 3, \"%02x\", rc);\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_WRITEPROTECT:\n\t\trc = i2c_smbus_read_byte_data(psu->client, PMBUS_WRITE_PROTECT);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = snprintf(data, 3, \"%02x\", rc);\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_VOOV_RESPONSE:\n\t\trc = i2c_smbus_read_byte_data(psu->client, PMBUS_VOUT_OV_FAULT_RESPONSE);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = snprintf(data, 3, \"%02x\", rc);\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_IOOC_RESPONSE:\n\t\trc = i2c_smbus_read_byte_data(psu->client, PMBUS_IOUT_OC_FAULT_RESPONSE);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = snprintf(data, 3, \"%02x\", rc);\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_PMBUS_VERSION:\n\t\trc = i2c_smbus_read_byte_data(psu->client, PMBUS_REVISION);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = snprintf(data, 3, \"%02x\", rc);\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_MFR_ID:\n\t\trc = i2c_smbus_read_block_data(psu->client, PMBUS_MFR_ID, data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_MFR_MODEL:\n\t\trc = i2c_smbus_read_block_data(psu->client, PMBUS_MFR_MODEL, data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_MFR_REVISION:\n\t\trc = i2c_smbus_read_block_data(psu->client, PMBUS_MFR_REVISION, data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_MFR_LOCATION:\n\t\trc = i2c_smbus_read_block_data(psu->client, PMBUS_MFR_LOCATION, data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_BLACKBOX_READ_OFFSET:\n\t\trc = i2c_smbus_read_byte_data(psu->client, READ_HISTORY_EVENT_NUMBER);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = snprintf(data, 3, \"%02x\", rc);\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_BLACKBOX_READ:\n\t\trc = i2c_smbus_read_block_data(psu->client, READ_HISTORY_EVENTS, data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\tres = bin2hex(data, data_char, 32);\n\t\trc = res - data;\n\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_FLASH_KEY:\n\t\trc = i2c_smbus_read_block_data(psu->client, PMBUS_FLASH_KEY_WRITE, data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\tres = bin2hex(data, data_char, 4);\n\t\trc = res - data;\n\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tdata[rc] = '\\n';\n\trc += 2;\n\n\treturn simple_read_from_buffer(buf, count, ppos, data, rc);\n}\n\nstatic ssize_t q54sj108a2_debugfs_write(struct file *file, const char __user *buf,\n\t\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tu8 flash_key[4];\n\tu8 dst_data;\n\tssize_t rc;\n\tint *idxp = file->private_data;\n\tint idx = *idxp;\n\tstruct q54sj108a2_data *psu = to_psu(idxp, idx);\n\n\trc = i2c_smbus_write_byte_data(psu->client, PMBUS_WRITE_PROTECT, 0);\n\tif (rc)\n\t\treturn rc;\n\n\tswitch (idx) {\n\tcase Q54SJ108A2_DEBUGFS_OPERATION:\n\t\trc = kstrtou8_from_user(buf, count, 0, &dst_data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = i2c_smbus_write_byte_data(psu->client, PMBUS_OPERATION, dst_data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_CLEARFAULT:\n\t\trc = i2c_smbus_write_byte(psu->client, PMBUS_CLEAR_FAULTS);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_STOREDEFAULT:\n\t\tflash_key[0] = 0x7E;\n\t\tflash_key[1] = 0x15;\n\t\tflash_key[2] = 0xDC;\n\t\tflash_key[3] = 0x42;\n\t\trc = i2c_smbus_write_block_data(psu->client, PMBUS_FLASH_KEY_WRITE, 4, flash_key);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = i2c_smbus_write_byte(psu->client, STORE_DEFAULT_ALL);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_VOOV_RESPONSE:\n\t\trc = kstrtou8_from_user(buf, count, 0, &dst_data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = i2c_smbus_write_byte_data(psu->client, PMBUS_VOUT_OV_FAULT_RESPONSE, dst_data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_IOOC_RESPONSE:\n\t\trc = kstrtou8_from_user(buf, count, 0, &dst_data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = i2c_smbus_write_byte_data(psu->client, PMBUS_IOUT_OC_FAULT_RESPONSE, dst_data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_BLACKBOX_ERASE:\n\t\trc = i2c_smbus_write_byte(psu->client, ERASE_BLACKBOX_DATA);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\tbreak;\n\tcase Q54SJ108A2_DEBUGFS_BLACKBOX_SET_OFFSET:\n\t\trc = kstrtou8_from_user(buf, count, 0, &dst_data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\trc = i2c_smbus_write_byte_data(psu->client, SET_HISTORY_EVENT_OFFSET, dst_data);\n\t\tif (rc < 0)\n\t\t\treturn rc;\n\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn count;\n}\n\nstatic const struct file_operations q54sj108a2_fops = {\n\t.llseek = noop_llseek,\n\t.read = q54sj108a2_debugfs_read,\n\t.write = q54sj108a2_debugfs_write,\n\t.open = simple_open,\n};\n\nstatic const struct i2c_device_id q54sj108a2_id[] = {\n\t{ \"q54sj108a2\", q54sj108a2 },\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(i2c, q54sj108a2_id);\n\nstatic int q54sj108a2_probe(struct i2c_client *client)\n{\n\tstruct device *dev = &client->dev;\n\tu8 buf[I2C_SMBUS_BLOCK_MAX + 1];\n\tenum chips chip_id;\n\tint ret, i;\n\tstruct dentry *debugfs;\n\tstruct dentry *q54sj108a2_dir;\n\tstruct q54sj108a2_data *psu;\n\n\tif (!i2c_check_functionality(client->adapter,\n\t\t\t\t     I2C_FUNC_SMBUS_BYTE_DATA |\n\t\t\t\t     I2C_FUNC_SMBUS_WORD_DATA |\n\t\t\t\t     I2C_FUNC_SMBUS_BLOCK_DATA))\n\t\treturn -ENODEV;\n\n\tif (client->dev.of_node)\n\t\tchip_id = (enum chips)(unsigned long)of_device_get_match_data(dev);\n\telse\n\t\tchip_id = i2c_match_id(q54sj108a2_id, client)->driver_data;\n\n\tret = i2c_smbus_read_block_data(client, PMBUS_MFR_ID, buf);\n\tif (ret < 0) {\n\t\tdev_err(&client->dev, \"Failed to read Manufacturer ID\\n\");\n\t\treturn ret;\n\t}\n\tif (ret != 6 || strncmp(buf, \"DELTA\", 5)) {\n\t\tbuf[ret] = '\\0';\n\t\tdev_err(dev, \"Unsupported Manufacturer ID '%s'\\n\", buf);\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tret = i2c_smbus_read_block_data(client, PMBUS_MFR_MODEL, buf);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Failed to read Manufacturer Model\\n\");\n\t\treturn ret;\n\t}\n\tif (ret != 14 || strncmp(buf, \"Q54SJ108A2\", 10)) {\n\t\tbuf[ret] = '\\0';\n\t\tdev_err(dev, \"Unsupported Manufacturer Model '%s'\\n\", buf);\n\t\treturn -ENODEV;\n\t}\n\n\tret = i2c_smbus_read_block_data(client, PMBUS_MFR_REVISION, buf);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Failed to read Manufacturer Revision\\n\");\n\t\treturn ret;\n\t}\n\tif (ret != 4 || buf[0] != 'S') {\n\t\tbuf[ret] = '\\0';\n\t\tdev_err(dev, \"Unsupported Manufacturer Revision '%s'\\n\", buf);\n\t\treturn -ENODEV;\n\t}\n\n\tret = pmbus_do_probe(client, &q54sj108a2_info[chip_id]);\n\tif (ret)\n\t\treturn ret;\n\n\tpsu = devm_kzalloc(&client->dev, sizeof(*psu), GFP_KERNEL);\n\tif (!psu)\n\t\treturn 0;\n\n\tpsu->client = client;\n\n\tdebugfs = pmbus_get_debugfs_dir(client);\n\n\tq54sj108a2_dir = debugfs_create_dir(client->name, debugfs);\n\n\tfor (i = 0; i < Q54SJ108A2_DEBUGFS_NUM_ENTRIES; ++i)\n\t\tpsu->debugfs_entries[i] = i;\n\n\tdebugfs_create_file(\"operation\", 0644, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_OPERATION],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"clear_fault\", 0200, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_CLEARFAULT],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"write_protect\", 0444, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_WRITEPROTECT],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"store_default\", 0200, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_STOREDEFAULT],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"vo_ov_response\", 0644, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_VOOV_RESPONSE],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"io_oc_response\", 0644, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_IOOC_RESPONSE],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"pmbus_revision\", 0444, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_PMBUS_VERSION],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"mfr_id\", 0444, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_MFR_ID],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"mfr_model\", 0444, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_MFR_MODEL],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"mfr_revision\", 0444, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_MFR_REVISION],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"mfr_location\", 0444, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_MFR_LOCATION],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"blackbox_erase\", 0200, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_BLACKBOX_ERASE],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"blackbox_read_offset\", 0444, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_BLACKBOX_READ_OFFSET],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"blackbox_set_offset\", 0200, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_BLACKBOX_SET_OFFSET],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"blackbox_read\", 0444, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_BLACKBOX_READ],\n\t\t\t    &q54sj108a2_fops);\n\tdebugfs_create_file(\"flash_key\", 0444, q54sj108a2_dir,\n\t\t\t    &psu->debugfs_entries[Q54SJ108A2_DEBUGFS_FLASH_KEY],\n\t\t\t    &q54sj108a2_fops);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id q54sj108a2_of_match[] = {\n\t{ .compatible = \"delta,q54sj108a2\", .data = (void *)q54sj108a2 },\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(of, q54sj108a2_of_match);\n\nstatic struct i2c_driver q54sj108a2_driver = {\n\t.driver = {\n\t\t.name = \"q54sj108a2\",\n\t\t.of_match_table = q54sj108a2_of_match,\n\t},\n\t.probe = q54sj108a2_probe,\n\t.id_table = q54sj108a2_id,\n};\n\nmodule_i2c_driver(q54sj108a2_driver);\n\nMODULE_AUTHOR(\"Xiao.Ma <xiao.mx.ma@deltaww.com>\");\nMODULE_DESCRIPTION(\"PMBus driver for Delta Q54SJ108A2 series modules\");\nMODULE_LICENSE(\"GPL\");\nMODULE_IMPORT_NS(PMBUS);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}