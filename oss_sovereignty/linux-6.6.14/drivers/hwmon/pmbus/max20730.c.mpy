{
  "module_name": "max20730.c",
  "hash_id": "73e32ca5313ef1e008be1752f84804c05756224c1e44323ee56348033fcbb704",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hwmon/pmbus/max20730.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/debugfs.h>\n#include <linux/err.h>\n#include <linux/i2c.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/of.h>\n#include <linux/pmbus.h>\n#include <linux/util_macros.h>\n#include \"pmbus.h\"\n\nenum chips {\n\tmax20710,\n\tmax20730,\n\tmax20734,\n\tmax20743\n};\n\nenum {\n\tMAX20730_DEBUGFS_VOUT_MIN = 0,\n\tMAX20730_DEBUGFS_FREQUENCY,\n\tMAX20730_DEBUGFS_PG_DELAY,\n\tMAX20730_DEBUGFS_INTERNAL_GAIN,\n\tMAX20730_DEBUGFS_BOOT_VOLTAGE,\n\tMAX20730_DEBUGFS_OUT_V_RAMP_RATE,\n\tMAX20730_DEBUGFS_OC_PROTECT_MODE,\n\tMAX20730_DEBUGFS_SS_TIMING,\n\tMAX20730_DEBUGFS_IMAX,\n\tMAX20730_DEBUGFS_OPERATION,\n\tMAX20730_DEBUGFS_ON_OFF_CONFIG,\n\tMAX20730_DEBUGFS_SMBALERT_MASK,\n\tMAX20730_DEBUGFS_VOUT_MODE,\n\tMAX20730_DEBUGFS_VOUT_COMMAND,\n\tMAX20730_DEBUGFS_VOUT_MAX,\n\tMAX20730_DEBUGFS_NUM_ENTRIES\n};\n\nstruct max20730_data {\n\tenum chips id;\n\tstruct pmbus_driver_info info;\n\tstruct mutex lock;\t \n\tu16 mfr_devset1;\n\tu16 mfr_devset2;\n\tu16 mfr_voutmin;\n\tu32 vout_voltage_divider[2];\n};\n\n#define to_max20730_data(x)  container_of(x, struct max20730_data, info)\n\n#define VOLT_FROM_REG(val)\tDIV_ROUND_CLOSEST((val), 1 << 9)\n\n#define PMBUS_SMB_ALERT_MASK\t0x1B\n\n#define MAX20730_MFR_VOUT_MIN\t0xd1\n#define MAX20730_MFR_DEVSET1\t0xd2\n#define MAX20730_MFR_DEVSET2\t0xd3\n\n#define MAX20730_MFR_VOUT_MIN_MASK\t\tGENMASK(9, 0)\n#define MAX20730_MFR_VOUT_MIN_BIT_POS\t\t0\n\n#define MAX20730_MFR_DEVSET1_RGAIN_MASK\t\t(BIT(13) | BIT(14))\n#define MAX20730_MFR_DEVSET1_OTP_MASK\t\t(BIT(11) | BIT(12))\n#define MAX20730_MFR_DEVSET1_VBOOT_MASK\t\t(BIT(8) | BIT(9))\n#define MAX20730_MFR_DEVSET1_OCP_MASK\t\t(BIT(5) | BIT(6))\n#define MAX20730_MFR_DEVSET1_FSW_MASK\t\tGENMASK(4, 2)\n#define MAX20730_MFR_DEVSET1_TSTAT_MASK\t\t(BIT(0) | BIT(1))\n\n#define MAX20730_MFR_DEVSET1_RGAIN_BIT_POS\t13\n#define MAX20730_MFR_DEVSET1_OTP_BIT_POS\t11\n#define MAX20730_MFR_DEVSET1_VBOOT_BIT_POS\t8\n#define MAX20730_MFR_DEVSET1_OCP_BIT_POS\t5\n#define MAX20730_MFR_DEVSET1_FSW_BIT_POS\t2\n#define MAX20730_MFR_DEVSET1_TSTAT_BIT_POS\t0\n\n#define MAX20730_MFR_DEVSET2_IMAX_MASK\t\tGENMASK(10, 8)\n#define MAX20730_MFR_DEVSET2_VRATE\t\t(BIT(6) | BIT(7))\n#define MAX20730_MFR_DEVSET2_OCPM_MASK\t\tBIT(5)\n#define MAX20730_MFR_DEVSET2_SS_MASK\t\t(BIT(0) | BIT(1))\n\n#define MAX20730_MFR_DEVSET2_IMAX_BIT_POS\t8\n#define MAX20730_MFR_DEVSET2_VRATE_BIT_POS\t6\n#define MAX20730_MFR_DEVSET2_OCPM_BIT_POS\t5\n#define MAX20730_MFR_DEVSET2_SS_BIT_POS\t\t0\n\n#define DEBUG_FS_DATA_MAX\t\t\t16\n\nstruct max20730_debugfs_data {\n\tstruct i2c_client *client;\n\tint debugfs_entries[MAX20730_DEBUGFS_NUM_ENTRIES];\n};\n\n#define to_psu(x, y) container_of((x), \\\n\t\t\tstruct max20730_debugfs_data, debugfs_entries[(y)])\n\n#ifdef CONFIG_DEBUG_FS\nstatic ssize_t max20730_debugfs_read(struct file *file, char __user *buf,\n\t\t\t\t     size_t count, loff_t *ppos)\n{\n\tint ret, len;\n\tint *idxp = file->private_data;\n\tint idx = *idxp;\n\tstruct max20730_debugfs_data *psu = to_psu(idxp, idx);\n\tconst struct pmbus_driver_info *info;\n\tconst struct max20730_data *data;\n\tchar tbuf[DEBUG_FS_DATA_MAX] = { 0 };\n\tchar *result = tbuf;\n\tu16 val;\n\n\tinfo = pmbus_get_driver_info(psu->client);\n\tdata = to_max20730_data(info);\n\n\tswitch (idx) {\n\tcase MAX20730_DEBUGFS_VOUT_MIN:\n\t\tret = VOLT_FROM_REG(data->mfr_voutmin * 10000);\n\t\tlen = scnprintf(tbuf, DEBUG_FS_DATA_MAX, \"%d.%d\\n\",\n\t\t\t\tret / 10000, ret % 10000);\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_FREQUENCY:\n\t\tval = (data->mfr_devset1 & MAX20730_MFR_DEVSET1_FSW_MASK)\n\t\t\t>> MAX20730_MFR_DEVSET1_FSW_BIT_POS;\n\n\t\tif (val == 0)\n\t\t\tret = 400;\n\t\telse if (val == 1)\n\t\t\tret = 500;\n\t\telse if (val == 2 || val == 3)\n\t\t\tret = 600;\n\t\telse if (val == 4)\n\t\t\tret = 700;\n\t\telse if (val == 5)\n\t\t\tret = 800;\n\t\telse\n\t\t\tret = 900;\n\t\tlen = scnprintf(tbuf, DEBUG_FS_DATA_MAX, \"%d\\n\", ret);\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_PG_DELAY:\n\t\tval = (data->mfr_devset1 & MAX20730_MFR_DEVSET1_TSTAT_MASK)\n\t\t\t>> MAX20730_MFR_DEVSET1_TSTAT_BIT_POS;\n\n\t\tif (val == 0)\n\t\t\tresult = \"2000\\n\";\n\t\telse if (val == 1)\n\t\t\tresult = \"125\\n\";\n\t\telse if (val == 2)\n\t\t\tresult = \"62.5\\n\";\n\t\telse\n\t\t\tresult = \"32\\n\";\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_INTERNAL_GAIN:\n\t\tval = (data->mfr_devset1 & MAX20730_MFR_DEVSET1_RGAIN_MASK)\n\t\t\t>> MAX20730_MFR_DEVSET1_RGAIN_BIT_POS;\n\n\t\tif (data->id == max20734) {\n\t\t\t \n\t\t\tif (val == 0)\n\t\t\t\tresult = \"0.8\\n\";\n\t\t\telse if (val == 1)\n\t\t\t\tresult = \"3.2\\n\";\n\t\t\telse if (val == 2)\n\t\t\t\tresult = \"1.6\\n\";\n\t\t\telse\n\t\t\t\tresult = \"6.4\\n\";\n\t\t} else if (data->id == max20730 || data->id == max20710) {\n\t\t\t \n\t\t\tif (val == 0)\n\t\t\t\tresult = \"0.9\\n\";\n\t\t\telse if (val == 1)\n\t\t\t\tresult = \"3.6\\n\";\n\t\t\telse if (val == 2)\n\t\t\t\tresult = \"1.8\\n\";\n\t\t\telse\n\t\t\t\tresult = \"7.2\\n\";\n\t\t} else if (data->id == max20743) {\n\t\t\t \n\t\t\tif (val == 0)\n\t\t\t\tresult = \"0.45\\n\";\n\t\t\telse if (val == 1)\n\t\t\t\tresult = \"1.8\\n\";\n\t\t\telse if (val == 2)\n\t\t\t\tresult = \"0.9\\n\";\n\t\t\telse\n\t\t\t\tresult = \"3.6\\n\";\n\t\t} else {\n\t\t\tresult = \"Not supported\\n\";\n\t\t}\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_BOOT_VOLTAGE:\n\t\tval = (data->mfr_devset1 & MAX20730_MFR_DEVSET1_VBOOT_MASK)\n\t\t\t>> MAX20730_MFR_DEVSET1_VBOOT_BIT_POS;\n\n\t\tif (val == 0)\n\t\t\tresult = \"0.6484\\n\";\n\t\telse if (val == 1)\n\t\t\tresult = \"0.8984\\n\";\n\t\telse if (val == 2)\n\t\t\tresult = \"1.0\\n\";\n\t\telse\n\t\t\tresult = \"Invalid\\n\";\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_OUT_V_RAMP_RATE:\n\t\tval = (data->mfr_devset2 & MAX20730_MFR_DEVSET2_VRATE)\n\t\t\t>> MAX20730_MFR_DEVSET2_VRATE_BIT_POS;\n\n\t\tif (val == 0)\n\t\t\tresult = \"4\\n\";\n\t\telse if (val == 1)\n\t\t\tresult = \"2\\n\";\n\t\telse if (val == 2)\n\t\t\tresult = \"1\\n\";\n\t\telse\n\t\t\tresult = \"Invalid\\n\";\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_OC_PROTECT_MODE:\n\t\tret = (data->mfr_devset2 & MAX20730_MFR_DEVSET2_OCPM_MASK)\n\t\t\t>> MAX20730_MFR_DEVSET2_OCPM_BIT_POS;\n\t\tlen = scnprintf(tbuf, DEBUG_FS_DATA_MAX, \"%d\\n\", ret);\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_SS_TIMING:\n\t\tval = (data->mfr_devset2 & MAX20730_MFR_DEVSET2_SS_MASK)\n\t\t\t>> MAX20730_MFR_DEVSET2_SS_BIT_POS;\n\n\t\tif (val == 0)\n\t\t\tresult = \"0.75\\n\";\n\t\telse if (val == 1)\n\t\t\tresult = \"1.5\\n\";\n\t\telse if (val == 2)\n\t\t\tresult = \"3\\n\";\n\t\telse\n\t\t\tresult = \"6\\n\";\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_IMAX:\n\t\tret = (data->mfr_devset2 & MAX20730_MFR_DEVSET2_IMAX_MASK)\n\t\t\t>> MAX20730_MFR_DEVSET2_IMAX_BIT_POS;\n\t\tlen = scnprintf(tbuf, DEBUG_FS_DATA_MAX, \"%d\\n\", ret);\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_OPERATION:\n\t\tret = i2c_smbus_read_byte_data(psu->client, PMBUS_OPERATION);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tlen = scnprintf(tbuf, DEBUG_FS_DATA_MAX, \"%d\\n\", ret);\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_ON_OFF_CONFIG:\n\t\tret = i2c_smbus_read_byte_data(psu->client, PMBUS_ON_OFF_CONFIG);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tlen = scnprintf(tbuf, DEBUG_FS_DATA_MAX, \"%d\\n\", ret);\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_SMBALERT_MASK:\n\t\tret = i2c_smbus_read_word_data(psu->client,\n\t\t\t\t\t       PMBUS_SMB_ALERT_MASK);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tlen = scnprintf(tbuf, DEBUG_FS_DATA_MAX, \"%d\\n\", ret);\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_VOUT_MODE:\n\t\tret = i2c_smbus_read_byte_data(psu->client, PMBUS_VOUT_MODE);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tlen = scnprintf(tbuf, DEBUG_FS_DATA_MAX, \"%d\\n\", ret);\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_VOUT_COMMAND:\n\t\tret = i2c_smbus_read_word_data(psu->client, PMBUS_VOUT_COMMAND);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tret = VOLT_FROM_REG(ret * 10000);\n\t\tlen = scnprintf(tbuf, DEBUG_FS_DATA_MAX,\n\t\t\t\t\"%d.%d\\n\", ret / 10000, ret % 10000);\n\t\tbreak;\n\tcase MAX20730_DEBUGFS_VOUT_MAX:\n\t\tret = i2c_smbus_read_word_data(psu->client, PMBUS_VOUT_MAX);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tret = VOLT_FROM_REG(ret * 10000);\n\t\tlen = scnprintf(tbuf, DEBUG_FS_DATA_MAX,\n\t\t\t\t\"%d.%d\\n\", ret / 10000, ret % 10000);\n\t\tbreak;\n\tdefault:\n\t\tresult = \"Invalid\\n\";\n\t}\n\n\tlen = strlen(result);\n\treturn simple_read_from_buffer(buf, count, ppos, result, len);\n}\n\nstatic const struct file_operations max20730_fops = {\n\t.llseek = noop_llseek,\n\t.read = max20730_debugfs_read,\n\t.write = NULL,\n\t.open = simple_open,\n};\n\nstatic int max20730_init_debugfs(struct i2c_client *client,\n\t\t\t\t struct max20730_data *data)\n{\n\tint ret, i;\n\tstruct dentry *debugfs;\n\tstruct dentry *max20730_dir;\n\tstruct max20730_debugfs_data *psu;\n\n\tret = i2c_smbus_read_word_data(client, MAX20730_MFR_DEVSET2);\n\tif (ret < 0)\n\t\treturn ret;\n\tdata->mfr_devset2 = ret;\n\n\tret = i2c_smbus_read_word_data(client, MAX20730_MFR_VOUT_MIN);\n\tif (ret < 0)\n\t\treturn ret;\n\tdata->mfr_voutmin = ret;\n\n\tpsu = devm_kzalloc(&client->dev, sizeof(*psu), GFP_KERNEL);\n\tif (!psu)\n\t\treturn -ENOMEM;\n\tpsu->client = client;\n\n\tdebugfs = pmbus_get_debugfs_dir(client);\n\tif (!debugfs)\n\t\treturn -ENOENT;\n\n\tmax20730_dir = debugfs_create_dir(client->name, debugfs);\n\n\tfor (i = 0; i < MAX20730_DEBUGFS_NUM_ENTRIES; ++i)\n\t\tpsu->debugfs_entries[i] = i;\n\n\tdebugfs_create_file(\"vout_min\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_VOUT_MIN],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"frequency\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_FREQUENCY],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"power_good_delay\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_PG_DELAY],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"internal_gain\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_INTERNAL_GAIN],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"boot_voltage\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_BOOT_VOLTAGE],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"out_voltage_ramp_rate\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_OUT_V_RAMP_RATE],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"oc_protection_mode\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_OC_PROTECT_MODE],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"soft_start_timing\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_SS_TIMING],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"imax\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_IMAX],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"operation\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_OPERATION],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"on_off_config\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_ON_OFF_CONFIG],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"smbalert_mask\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_SMBALERT_MASK],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"vout_mode\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_VOUT_MODE],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"vout_command\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_VOUT_COMMAND],\n\t\t\t    &max20730_fops);\n\tdebugfs_create_file(\"vout_max\", 0444, max20730_dir,\n\t\t\t    &psu->debugfs_entries[MAX20730_DEBUGFS_VOUT_MAX],\n\t\t\t    &max20730_fops);\n\n\treturn 0;\n}\n#else\nstatic int max20730_init_debugfs(struct i2c_client *client,\n\t\t\t\t struct max20730_data *data)\n{\n\treturn 0;\n}\n#endif  \n\nstatic const struct i2c_device_id max20730_id[];\n\n \nstatic u16 val_to_direct(int v, enum pmbus_sensor_classes class,\n\t\t\t const struct pmbus_driver_info *info)\n{\n\tint R = info->R[class] - 3;\t \n\tint b = info->b[class] * 1000;\n\tlong d;\n\n\td = v * info->m[class] + b;\n\t \n\twhile (R < 0) {\n\t\td = DIV_ROUND_CLOSEST(d, 10);\n\t\tR++;\n\t}\n\treturn (u16)d;\n}\n\nstatic long direct_to_val(u16 w, enum pmbus_sensor_classes class,\n\t\t\t  const struct pmbus_driver_info *info)\n{\n\tint R = info->R[class] - 3;\n\tint b = info->b[class] * 1000;\n\tint m = info->m[class];\n\tlong d = (s16)w;\n\n\tif (m == 0)\n\t\treturn 0;\n\n\twhile (R < 0) {\n\t\td *= 10;\n\t\tR++;\n\t}\n\td = (d - b) / m;\n\treturn d;\n}\n\nstatic u32 max_current[][5] = {\n\t[max20710] = { 6200, 8000, 9700, 11600 },\n\t[max20730] = { 13000, 16600, 20100, 23600 },\n\t[max20734] = { 21000, 27000, 32000, 38000 },\n\t[max20743] = { 18900, 24100, 29200, 34100 },\n};\n\nstatic int max20730_read_word_data(struct i2c_client *client, int page,\n\t\t\t\t   int phase, int reg)\n{\n\tconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\n\tconst struct max20730_data *data = to_max20730_data(info);\n\tint ret = 0;\n\tu32 max_c;\n\n\tswitch (reg) {\n\tcase PMBUS_OT_FAULT_LIMIT:\n\t\tswitch ((data->mfr_devset1 >> 11) & 0x3) {\n\t\tcase 0x0:\n\t\t\tret = val_to_direct(150000, PSC_TEMPERATURE, info);\n\t\t\tbreak;\n\t\tcase 0x1:\n\t\t\tret = val_to_direct(130000, PSC_TEMPERATURE, info);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tret = -ENODATA;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase PMBUS_IOUT_OC_FAULT_LIMIT:\n\t\tmax_c = max_current[data->id][(data->mfr_devset1 >> 5) & 0x3];\n\t\tret = val_to_direct(max_c, PSC_CURRENT_OUT, info);\n\t\tbreak;\n\tcase PMBUS_READ_VOUT:\n\t\tret = pmbus_read_word_data(client, page, phase, reg);\n\t\tif (ret > 0 && data->vout_voltage_divider[0] && data->vout_voltage_divider[1]) {\n\t\t\tu64 temp = DIV_ROUND_CLOSEST_ULL((u64)ret * data->vout_voltage_divider[1],\n\t\t\t\t\t\t\t data->vout_voltage_divider[0]);\n\t\t\tret = clamp_val(temp, 0, 0xffff);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tret = -ENODATA;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic int max20730_write_word_data(struct i2c_client *client, int page,\n\t\t\t\t    int reg, u16 word)\n{\n\tstruct pmbus_driver_info *info;\n\tstruct max20730_data *data;\n\tu16 devset1;\n\tint ret = 0;\n\tint idx;\n\n\tinfo = (struct pmbus_driver_info *)pmbus_get_driver_info(client);\n\tdata = to_max20730_data(info);\n\n\tmutex_lock(&data->lock);\n\tdevset1 = data->mfr_devset1;\n\n\tswitch (reg) {\n\tcase PMBUS_OT_FAULT_LIMIT:\n\t\tdevset1 &= ~(BIT(11) | BIT(12));\n\t\tif (direct_to_val(word, PSC_TEMPERATURE, info) < 140000)\n\t\t\tdevset1 |= BIT(11);\n\t\tbreak;\n\tcase PMBUS_IOUT_OC_FAULT_LIMIT:\n\t\tdevset1 &= ~(BIT(5) | BIT(6));\n\n\t\tidx = find_closest(direct_to_val(word, PSC_CURRENT_OUT, info),\n\t\t\t\t   max_current[data->id], 4);\n\t\tdevset1 |= (idx << 5);\n\t\tbreak;\n\tdefault:\n\t\tret = -ENODATA;\n\t\tbreak;\n\t}\n\n\tif (!ret && devset1 != data->mfr_devset1) {\n\t\tret = i2c_smbus_write_word_data(client, MAX20730_MFR_DEVSET1,\n\t\t\t\t\t\tdevset1);\n\t\tif (!ret) {\n\t\t\tdata->mfr_devset1 = devset1;\n\t\t\tpmbus_clear_cache(client);\n\t\t}\n\t}\n\tmutex_unlock(&data->lock);\n\treturn ret;\n}\n\nstatic const struct pmbus_driver_info max20730_info[] = {\n\t[max20710] = {\n\t\t.pages = 1,\n\t\t.read_word_data = max20730_read_word_data,\n\t\t.write_word_data = max20730_write_word_data,\n\n\t\t \n\t\t.format[PSC_TEMPERATURE] = direct,\n\t\t.m[PSC_TEMPERATURE] = 21,\n\t\t.b[PSC_TEMPERATURE] = 5887,\n\t\t.R[PSC_TEMPERATURE] = -1,\n\n\t\t.format[PSC_VOLTAGE_IN] = direct,\n\t\t.m[PSC_VOLTAGE_IN] = 3609,\n\t\t.b[PSC_VOLTAGE_IN] = 0,\n\t\t.R[PSC_VOLTAGE_IN] = -2,\n\n\t\t.format[PSC_CURRENT_OUT] = direct,\n\t\t.m[PSC_CURRENT_OUT] = 153,\n\t\t.b[PSC_CURRENT_OUT] = 4976,\n\t\t.R[PSC_CURRENT_OUT] = -1,\n\n\t\t.format[PSC_VOLTAGE_OUT] = linear,\n\n\t\t.func[0] = PMBUS_HAVE_VIN |\n\t\t\tPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT |\n\t\t\tPMBUS_HAVE_IOUT | PMBUS_HAVE_STATUS_IOUT |\n\t\t\tPMBUS_HAVE_TEMP | PMBUS_HAVE_STATUS_TEMP |\n\t\t\tPMBUS_HAVE_STATUS_INPUT,\n\t},\n\t[max20730] = {\n\t\t.pages = 1,\n\t\t.read_word_data = max20730_read_word_data,\n\t\t.write_word_data = max20730_write_word_data,\n\n\t\t \n\t\t.format[PSC_TEMPERATURE] = direct,\n\t\t.m[PSC_TEMPERATURE] = 21,\n\t\t.b[PSC_TEMPERATURE] = 5887,\n\t\t.R[PSC_TEMPERATURE] = -1,\n\n\t\t.format[PSC_VOLTAGE_IN] = direct,\n\t\t.m[PSC_VOLTAGE_IN] = 3609,\n\t\t.b[PSC_VOLTAGE_IN] = 0,\n\t\t.R[PSC_VOLTAGE_IN] = -2,\n\n\t\t \n\t\t.format[PSC_CURRENT_OUT] = direct,\n\t\t.m[PSC_CURRENT_OUT] = 153,\n\t\t.b[PSC_CURRENT_OUT] = 4976,\n\t\t.R[PSC_CURRENT_OUT] = -1,\n\n\t\t.format[PSC_VOLTAGE_OUT] = linear,\n\n\t\t.func[0] = PMBUS_HAVE_VIN |\n\t\t\tPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT |\n\t\t\tPMBUS_HAVE_IOUT | PMBUS_HAVE_STATUS_IOUT |\n\t\t\tPMBUS_HAVE_TEMP | PMBUS_HAVE_STATUS_TEMP |\n\t\t\tPMBUS_HAVE_STATUS_INPUT,\n\t},\n\t[max20734] = {\n\t\t.pages = 1,\n\t\t.read_word_data = max20730_read_word_data,\n\t\t.write_word_data = max20730_write_word_data,\n\n\t\t \n\t\t.format[PSC_TEMPERATURE] = direct,\n\t\t.m[PSC_TEMPERATURE] = 21,\n\t\t.b[PSC_TEMPERATURE] = 5887,\n\t\t.R[PSC_TEMPERATURE] = -1,\n\n\t\t.format[PSC_VOLTAGE_IN] = direct,\n\t\t.m[PSC_VOLTAGE_IN] = 3592,\n\t\t.b[PSC_VOLTAGE_IN] = 0,\n\t\t.R[PSC_VOLTAGE_IN] = -2,\n\n\t\t.format[PSC_CURRENT_OUT] = direct,\n\t\t.m[PSC_CURRENT_OUT] = 111,\n\t\t.b[PSC_CURRENT_OUT] = 3461,\n\t\t.R[PSC_CURRENT_OUT] = -1,\n\n\t\t.format[PSC_VOLTAGE_OUT] = linear,\n\n\t\t.func[0] = PMBUS_HAVE_VIN |\n\t\t\tPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT |\n\t\t\tPMBUS_HAVE_IOUT | PMBUS_HAVE_STATUS_IOUT |\n\t\t\tPMBUS_HAVE_TEMP | PMBUS_HAVE_STATUS_TEMP |\n\t\t\tPMBUS_HAVE_STATUS_INPUT,\n\t},\n\t[max20743] = {\n\t\t.pages = 1,\n\t\t.read_word_data = max20730_read_word_data,\n\t\t.write_word_data = max20730_write_word_data,\n\n\t\t \n\t\t.format[PSC_TEMPERATURE] = direct,\n\t\t.m[PSC_TEMPERATURE] = 21,\n\t\t.b[PSC_TEMPERATURE] = 5887,\n\t\t.R[PSC_TEMPERATURE] = -1,\n\n\t\t.format[PSC_VOLTAGE_IN] = direct,\n\t\t.m[PSC_VOLTAGE_IN] = 3597,\n\t\t.b[PSC_VOLTAGE_IN] = 0,\n\t\t.R[PSC_VOLTAGE_IN] = -2,\n\n\t\t.format[PSC_CURRENT_OUT] = direct,\n\t\t.m[PSC_CURRENT_OUT] = 95,\n\t\t.b[PSC_CURRENT_OUT] = 5014,\n\t\t.R[PSC_CURRENT_OUT] = -1,\n\n\t\t.format[PSC_VOLTAGE_OUT] = linear,\n\n\t\t.func[0] = PMBUS_HAVE_VIN |\n\t\t\tPMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT |\n\t\t\tPMBUS_HAVE_IOUT | PMBUS_HAVE_STATUS_IOUT |\n\t\t\tPMBUS_HAVE_TEMP | PMBUS_HAVE_STATUS_TEMP |\n\t\t\tPMBUS_HAVE_STATUS_INPUT,\n\t},\n};\n\nstatic int max20730_probe(struct i2c_client *client)\n{\n\tstruct device *dev = &client->dev;\n\tu8 buf[I2C_SMBUS_BLOCK_MAX + 1];\n\tstruct max20730_data *data;\n\tenum chips chip_id;\n\tint ret;\n\n\tif (!i2c_check_functionality(client->adapter,\n\t\t\t\t     I2C_FUNC_SMBUS_READ_BYTE_DATA |\n\t\t\t\t     I2C_FUNC_SMBUS_READ_WORD_DATA |\n\t\t\t\t     I2C_FUNC_SMBUS_BLOCK_DATA))\n\t\treturn -ENODEV;\n\n\tret = i2c_smbus_read_block_data(client, PMBUS_MFR_ID, buf);\n\tif (ret < 0) {\n\t\tdev_err(&client->dev, \"Failed to read Manufacturer ID\\n\");\n\t\treturn ret;\n\t}\n\tif (ret != 5 || strncmp(buf, \"MAXIM\", 5)) {\n\t\tbuf[ret] = '\\0';\n\t\tdev_err(dev, \"Unsupported Manufacturer ID '%s'\\n\", buf);\n\t\treturn -ENODEV;\n\t}\n\n\t \n\tret = i2c_smbus_read_block_data(client, PMBUS_MFR_MODEL, buf);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Failed to read Manufacturer Model\\n\");\n\t\treturn ret;\n\t}\n\tif (ret != 6 || strncmp(buf, \"M20743\", 6)) {\n\t\tbuf[ret] = '\\0';\n\t\tdev_err(dev, \"Unsupported Manufacturer Model '%s'\\n\", buf);\n\t\treturn -ENODEV;\n\t}\n\n\tret = i2c_smbus_read_block_data(client, PMBUS_MFR_REVISION, buf);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Failed to read Manufacturer Revision\\n\");\n\t\treturn ret;\n\t}\n\tif (ret != 1 || buf[0] != 'F') {\n\t\tbuf[ret] = '\\0';\n\t\tdev_err(dev, \"Unsupported Manufacturer Revision '%s'\\n\", buf);\n\t\treturn -ENODEV;\n\t}\n\n\tif (client->dev.of_node)\n\t\tchip_id = (uintptr_t)of_device_get_match_data(dev);\n\telse\n\t\tchip_id = i2c_match_id(max20730_id, client)->driver_data;\n\n\tdata = devm_kzalloc(dev, sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\tdata->id = chip_id;\n\tmutex_init(&data->lock);\n\tmemcpy(&data->info, &max20730_info[chip_id], sizeof(data->info));\n\tif (of_property_read_u32_array(client->dev.of_node, \"vout-voltage-divider\",\n\t\t\t\t       data->vout_voltage_divider,\n\t\t\t\t       ARRAY_SIZE(data->vout_voltage_divider)) != 0)\n\t\tmemset(data->vout_voltage_divider, 0, sizeof(data->vout_voltage_divider));\n\tif (data->vout_voltage_divider[1] < data->vout_voltage_divider[0]) {\n\t\tdev_err(dev,\n\t\t\t\"The total resistance of voltage divider is less than output resistance\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = i2c_smbus_read_word_data(client, MAX20730_MFR_DEVSET1);\n\tif (ret < 0)\n\t\treturn ret;\n\tdata->mfr_devset1 = ret;\n\n\tret = pmbus_do_probe(client, &data->info);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = max20730_init_debugfs(client, data);\n\tif (ret)\n\t\tdev_warn(dev, \"Failed to register debugfs: %d\\n\",\n\t\t\t ret);\n\n\treturn 0;\n}\n\nstatic const struct i2c_device_id max20730_id[] = {\n\t{ \"max20710\", max20710 },\n\t{ \"max20730\", max20730 },\n\t{ \"max20734\", max20734 },\n\t{ \"max20743\", max20743 },\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(i2c, max20730_id);\n\nstatic const struct of_device_id max20730_of_match[] = {\n\t{ .compatible = \"maxim,max20710\", .data = (void *)max20710 },\n\t{ .compatible = \"maxim,max20730\", .data = (void *)max20730 },\n\t{ .compatible = \"maxim,max20734\", .data = (void *)max20734 },\n\t{ .compatible = \"maxim,max20743\", .data = (void *)max20743 },\n\t{ },\n};\n\nMODULE_DEVICE_TABLE(of, max20730_of_match);\n\nstatic struct i2c_driver max20730_driver = {\n\t.driver = {\n\t\t.name = \"max20730\",\n\t\t.of_match_table = max20730_of_match,\n\t},\n\t.probe = max20730_probe,\n\t.id_table = max20730_id,\n};\n\nmodule_i2c_driver(max20730_driver);\n\nMODULE_AUTHOR(\"Guenter Roeck <linux@roeck-us.net>\");\nMODULE_DESCRIPTION(\"PMBus driver for Maxim MAX20710 / MAX20730 / MAX20734 / MAX20743\");\nMODULE_LICENSE(\"GPL\");\nMODULE_IMPORT_NS(PMBUS);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}