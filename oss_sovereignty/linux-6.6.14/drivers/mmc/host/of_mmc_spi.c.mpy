{
  "module_name": "of_mmc_spi.c",
  "hash_id": "4fe9a917d4efab33c9a32624538ad948ccf71e0fe7c9a849b310520f6f3c9f4d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mmc/host/of_mmc_spi.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/slab.h>\n#include <linux/irq.h>\n#include <linux/of.h>\n#include <linux/of_irq.h>\n#include <linux/spi/spi.h>\n#include <linux/spi/mmc_spi.h>\n#include <linux/mmc/core.h>\n#include <linux/mmc/host.h>\n\nMODULE_LICENSE(\"GPL\");\n\nstruct of_mmc_spi {\n\tstruct mmc_spi_platform_data pdata;\n\tint detect_irq;\n};\n\nstatic struct of_mmc_spi *to_of_mmc_spi(struct device *dev)\n{\n\treturn container_of(dev->platform_data, struct of_mmc_spi, pdata);\n}\n\nstatic int of_mmc_spi_init(struct device *dev,\n\t\t\t   irqreturn_t (*irqhandler)(int, void *), void *mmc)\n{\n\tstruct of_mmc_spi *oms = to_of_mmc_spi(dev);\n\n\treturn request_threaded_irq(oms->detect_irq, NULL, irqhandler,\n\t\t\t\t\tIRQF_ONESHOT, dev_name(dev), mmc);\n}\n\nstatic void of_mmc_spi_exit(struct device *dev, void *mmc)\n{\n\tstruct of_mmc_spi *oms = to_of_mmc_spi(dev);\n\n\tfree_irq(oms->detect_irq, mmc);\n}\n\nstruct mmc_spi_platform_data *mmc_spi_get_pdata(struct spi_device *spi)\n{\n\tstruct mmc_host *mmc = dev_get_drvdata(&spi->dev);\n\tstruct device *dev = &spi->dev;\n\tstruct of_mmc_spi *oms;\n\n\tif (dev->platform_data || !dev_fwnode(dev))\n\t\treturn dev->platform_data;\n\n\toms = kzalloc(sizeof(*oms), GFP_KERNEL);\n\tif (!oms)\n\t\treturn NULL;\n\n\tif (mmc_of_parse_voltage(mmc, &oms->pdata.ocr_mask) < 0)\n\t\tgoto err_ocr;\n\n\toms->detect_irq = spi->irq;\n\tif (oms->detect_irq > 0) {\n\t\toms->pdata.init = of_mmc_spi_init;\n\t\toms->pdata.exit = of_mmc_spi_exit;\n\t} else {\n\t\toms->pdata.caps |= MMC_CAP_NEEDS_POLL;\n\t}\n\tif (device_property_read_bool(dev, \"cap-sd-highspeed\"))\n\t\toms->pdata.caps |= MMC_CAP_SD_HIGHSPEED;\n\tif (device_property_read_bool(dev, \"cap-mmc-highspeed\"))\n\t\toms->pdata.caps |= MMC_CAP_MMC_HIGHSPEED;\n\n\tdev->platform_data = &oms->pdata;\n\treturn dev->platform_data;\nerr_ocr:\n\tkfree(oms);\n\treturn NULL;\n}\nEXPORT_SYMBOL(mmc_spi_get_pdata);\n\nvoid mmc_spi_put_pdata(struct spi_device *spi)\n{\n\tstruct device *dev = &spi->dev;\n\tstruct of_mmc_spi *oms = to_of_mmc_spi(dev);\n\n\tif (!dev->platform_data || !dev_fwnode(dev))\n\t\treturn;\n\n\tkfree(oms);\n\tdev->platform_data = NULL;\n}\nEXPORT_SYMBOL(mmc_spi_put_pdata);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}