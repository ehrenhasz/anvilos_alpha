{
  "module_name": "sdhci-milbeaut.c",
  "hash_id": "eaf203e91da793b6f2b64fa9e619753ffefbdc79a4d83e4b1e9fda0fdd8a348d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mmc/host/sdhci-milbeaut.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/gpio/consumer.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/property.h>\n\n#include \"sdhci-pltfm.h\"\n#include \"sdhci_f_sdh30.h\"\n\n \n#define MLB_SOFT_RESET\t\t0x0200\n#define  MLB_SOFT_RESET_RSTX\t\tBIT(0)\n\n#define MLB_WP_CD_LED_SET\t0x0210\n#define  MLB_WP_CD_LED_SET_LED_INV  BIT(2)\n\n#define MLB_CR_SET\t\t\t0x0220\n#define  MLB_CR_SET_CR_TOCLKUNIT       BIT(24)\n#define  MLB_CR_SET_CR_TOCLKFREQ_SFT   (16)\n#define  MLB_CR_SET_CR_TOCLKFREQ_MASK  (0x3F << MLB_CR_SET_CR_TOCLKFREQ_SFT)\n#define  MLB_CR_SET_CR_BCLKFREQ_SFT    (8)\n#define  MLB_CR_SET_CR_BCLKFREQ_MASK   (0xFF << MLB_CR_SET_CR_BCLKFREQ_SFT)\n#define  MLB_CR_SET_CR_RTUNTIMER_SFT   (4)\n#define  MLB_CR_SET_CR_RTUNTIMER_MASK  (0xF << MLB_CR_SET_CR_RTUNTIMER_SFT)\n\n#define MLB_SD_TOCLK_I_DIV  16\n#define MLB_TOCLKFREQ_UNIT_THRES    16000000\n#define MLB_CAL_TOCLKFREQ_MHZ(rate) (rate / MLB_SD_TOCLK_I_DIV / 1000000)\n#define MLB_CAL_TOCLKFREQ_KHZ(rate) (rate / MLB_SD_TOCLK_I_DIV / 1000)\n#define MLB_TOCLKFREQ_MAX   63\n#define MLB_TOCLKFREQ_MIN    1\n\n#define MLB_SD_BCLK_I_DIV   4\n#define MLB_CAL_BCLKFREQ(rate)  (rate / MLB_SD_BCLK_I_DIV / 1000000)\n#define MLB_BCLKFREQ_MAX        255\n#define MLB_BCLKFREQ_MIN          1\n\n#define MLB_CDR_SET\t\t\t0x0230\n#define MLB_CDR_SET_CLK2POW16\t3\n\nstruct f_sdhost_priv {\n\tstruct clk *clk_iface;\n\tstruct clk *clk;\n\tstruct device *dev;\n\tbool enable_cmd_dat_delay;\n};\n\nstatic void sdhci_milbeaut_soft_voltage_switch(struct sdhci_host *host)\n{\n\tu32 ctrl = 0;\n\n\tusleep_range(2500, 3000);\n\tctrl = sdhci_readl(host, F_SDH30_IO_CONTROL2);\n\tctrl |= F_SDH30_CRES_O_DN;\n\tsdhci_writel(host, ctrl, F_SDH30_IO_CONTROL2);\n\tctrl |= F_SDH30_MSEL_O_1_8;\n\tsdhci_writel(host, ctrl, F_SDH30_IO_CONTROL2);\n\n\tctrl &= ~F_SDH30_CRES_O_DN;\n\tsdhci_writel(host, ctrl, F_SDH30_IO_CONTROL2);\n\tusleep_range(2500, 3000);\n\n\tctrl = sdhci_readl(host, F_SDH30_TUNING_SETTING);\n\tctrl |= F_SDH30_CMD_CHK_DIS;\n\tsdhci_writel(host, ctrl, F_SDH30_TUNING_SETTING);\n}\n\nstatic unsigned int sdhci_milbeaut_get_min_clock(struct sdhci_host *host)\n{\n\treturn F_SDH30_MIN_CLOCK;\n}\n\nstatic void sdhci_milbeaut_reset(struct sdhci_host *host, u8 mask)\n{\n\tstruct f_sdhost_priv *priv = sdhci_priv(host);\n\tu16 clk;\n\tu32 ctl;\n\tktime_t timeout;\n\n\tclk = sdhci_readw(host, SDHCI_CLOCK_CONTROL);\n\tclk = (clk & ~SDHCI_CLOCK_CARD_EN) | SDHCI_CLOCK_INT_EN;\n\tsdhci_writew(host, clk, SDHCI_CLOCK_CONTROL);\n\n\tsdhci_reset(host, mask);\n\n\tclk |= SDHCI_CLOCK_CARD_EN;\n\tsdhci_writew(host, clk, SDHCI_CLOCK_CONTROL);\n\n\ttimeout = ktime_add_ms(ktime_get(), 10);\n\twhile (1) {\n\t\tbool timedout = ktime_after(ktime_get(), timeout);\n\n\t\tclk = sdhci_readw(host, SDHCI_CLOCK_CONTROL);\n\t\tif (clk & SDHCI_CLOCK_INT_STABLE)\n\t\t\tbreak;\n\t\tif (timedout) {\n\t\t\tpr_err(\"%s: Internal clock never stabilised.\\n\",\n\t\t\t\tmmc_hostname(host->mmc));\n\t\t\tsdhci_dumpregs(host);\n\t\t\treturn;\n\t\t}\n\t\tudelay(10);\n\t}\n\n\tif (priv->enable_cmd_dat_delay) {\n\t\tctl = sdhci_readl(host, F_SDH30_ESD_CONTROL);\n\t\tctl |= F_SDH30_CMD_DAT_DELAY;\n\t\tsdhci_writel(host, ctl, F_SDH30_ESD_CONTROL);\n\t}\n}\n\nstatic const struct sdhci_ops sdhci_milbeaut_ops = {\n\t.voltage_switch = sdhci_milbeaut_soft_voltage_switch,\n\t.get_min_clock = sdhci_milbeaut_get_min_clock,\n\t.reset = sdhci_milbeaut_reset,\n\t.set_clock = sdhci_set_clock,\n\t.set_bus_width = sdhci_set_bus_width,\n\t.set_uhs_signaling = sdhci_set_uhs_signaling,\n\t.set_power = sdhci_set_power_and_bus_voltage,\n};\n\nstatic void sdhci_milbeaut_bridge_reset(struct sdhci_host *host,\n\t\t\t\t\t\tint reset_flag)\n{\n\tif (reset_flag)\n\t\tsdhci_writel(host, 0, MLB_SOFT_RESET);\n\telse\n\t\tsdhci_writel(host, MLB_SOFT_RESET_RSTX, MLB_SOFT_RESET);\n}\n\nstatic void sdhci_milbeaut_bridge_init(struct sdhci_host *host,\n\t\t\t\t\t\tint rate)\n{\n\tu32 val, clk;\n\n\t \n\tval = sdhci_readl(host, MLB_CR_SET);\n\tval &= ~(MLB_CR_SET_CR_TOCLKFREQ_MASK | MLB_CR_SET_CR_TOCLKUNIT |\n\t\t\tMLB_CR_SET_CR_BCLKFREQ_MASK);\n\tif (rate >= MLB_TOCLKFREQ_UNIT_THRES) {\n\t\tclk = MLB_CAL_TOCLKFREQ_MHZ(rate);\n\t\tclk = min_t(u32, MLB_TOCLKFREQ_MAX, clk);\n\t\tval |= MLB_CR_SET_CR_TOCLKUNIT |\n\t\t\t(clk << MLB_CR_SET_CR_TOCLKFREQ_SFT);\n\t} else {\n\t\tclk = MLB_CAL_TOCLKFREQ_KHZ(rate);\n\t\tclk = min_t(u32, MLB_TOCLKFREQ_MAX, clk);\n\t\tclk = max_t(u32, MLB_TOCLKFREQ_MIN, clk);\n\t\tval |= clk << MLB_CR_SET_CR_TOCLKFREQ_SFT;\n\t}\n\n\tclk = MLB_CAL_BCLKFREQ(rate);\n\tclk = min_t(u32, MLB_BCLKFREQ_MAX, clk);\n\tclk = max_t(u32, MLB_BCLKFREQ_MIN, clk);\n\tval |=  clk << MLB_CR_SET_CR_BCLKFREQ_SFT;\n\tval &= ~MLB_CR_SET_CR_RTUNTIMER_MASK;\n\tsdhci_writel(host, val, MLB_CR_SET);\n\n\tsdhci_writel(host, MLB_CDR_SET_CLK2POW16, MLB_CDR_SET);\n\n\tsdhci_writel(host, MLB_WP_CD_LED_SET_LED_INV, MLB_WP_CD_LED_SET);\n}\n\nstatic void sdhci_milbeaut_vendor_init(struct sdhci_host *host)\n{\n\tstruct f_sdhost_priv *priv = sdhci_priv(host);\n\tu32 ctl;\n\n\tctl = sdhci_readl(host, F_SDH30_IO_CONTROL2);\n\tctl |= F_SDH30_CRES_O_DN;\n\tsdhci_writel(host, ctl, F_SDH30_IO_CONTROL2);\n\tctl &= ~F_SDH30_MSEL_O_1_8;\n\tsdhci_writel(host, ctl, F_SDH30_IO_CONTROL2);\n\tctl &= ~F_SDH30_CRES_O_DN;\n\tsdhci_writel(host, ctl, F_SDH30_IO_CONTROL2);\n\n\tctl = sdhci_readw(host, F_SDH30_AHB_CONFIG);\n\tctl |= F_SDH30_SIN | F_SDH30_AHB_INCR_16 | F_SDH30_AHB_INCR_8 |\n\t       F_SDH30_AHB_INCR_4;\n\tctl &= ~(F_SDH30_AHB_BIGED | F_SDH30_BUSLOCK_EN);\n\tsdhci_writew(host, ctl, F_SDH30_AHB_CONFIG);\n\n\tif (priv->enable_cmd_dat_delay) {\n\t\tctl = sdhci_readl(host, F_SDH30_ESD_CONTROL);\n\t\tctl |= F_SDH30_CMD_DAT_DELAY;\n\t\tsdhci_writel(host, ctl, F_SDH30_ESD_CONTROL);\n\t}\n}\n\nstatic const struct of_device_id mlb_dt_ids[] = {\n\t{\n\t\t.compatible = \"socionext,milbeaut-m10v-sdhci-3.0\",\n\t},\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, mlb_dt_ids);\n\nstatic void sdhci_milbeaut_init(struct sdhci_host *host)\n{\n\tstruct f_sdhost_priv *priv = sdhci_priv(host);\n\tint rate = clk_get_rate(priv->clk);\n\tu16 ctl;\n\n\tsdhci_milbeaut_bridge_reset(host, 0);\n\n\tctl = sdhci_readw(host, SDHCI_CLOCK_CONTROL);\n\tctl &= ~(SDHCI_CLOCK_CARD_EN | SDHCI_CLOCK_INT_EN);\n\tsdhci_writew(host, ctl, SDHCI_CLOCK_CONTROL);\n\n\tsdhci_milbeaut_bridge_reset(host, 1);\n\n\tsdhci_milbeaut_bridge_init(host, rate);\n\tsdhci_milbeaut_bridge_reset(host, 0);\n\n\tsdhci_milbeaut_vendor_init(host);\n}\n\nstatic int sdhci_milbeaut_probe(struct platform_device *pdev)\n{\n\tstruct sdhci_host *host;\n\tstruct device *dev = &pdev->dev;\n\tint irq, ret = 0;\n\tstruct f_sdhost_priv *priv;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\thost = sdhci_alloc_host(dev, sizeof(struct f_sdhost_priv));\n\tif (IS_ERR(host))\n\t\treturn PTR_ERR(host);\n\n\tpriv = sdhci_priv(host);\n\tpriv->dev = dev;\n\n\thost->quirks = SDHCI_QUIRK_NO_ENDATTR_IN_NOPDESC |\n\t\t\t   SDHCI_QUIRK_INVERTED_WRITE_PROTECT |\n\t\t\t   SDHCI_QUIRK_CLOCK_BEFORE_RESET |\n\t\t\t   SDHCI_QUIRK_DELAY_AFTER_POWER;\n\thost->quirks2 = SDHCI_QUIRK2_SUPPORT_SINGLE |\n\t\t\tSDHCI_QUIRK2_TUNING_WORK_AROUND |\n\t\t\tSDHCI_QUIRK2_PRESET_VALUE_BROKEN;\n\n\tpriv->enable_cmd_dat_delay = device_property_read_bool(dev,\n\t\t\t\t\t\t\"fujitsu,cmd-dat-delay-select\");\n\n\tret = mmc_of_parse(host->mmc);\n\tif (ret)\n\t\tgoto err;\n\n\tplatform_set_drvdata(pdev, host);\n\n\thost->hw_name = \"f_sdh30\";\n\thost->ops = &sdhci_milbeaut_ops;\n\thost->irq = irq;\n\n\thost->ioaddr = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(host->ioaddr)) {\n\t\tret = PTR_ERR(host->ioaddr);\n\t\tgoto err;\n\t}\n\n\tif (dev_of_node(dev)) {\n\t\tsdhci_get_of_property(pdev);\n\n\t\tpriv->clk_iface = devm_clk_get(&pdev->dev, \"iface\");\n\t\tif (IS_ERR(priv->clk_iface)) {\n\t\t\tret = PTR_ERR(priv->clk_iface);\n\t\t\tgoto err;\n\t\t}\n\n\t\tret = clk_prepare_enable(priv->clk_iface);\n\t\tif (ret)\n\t\t\tgoto err;\n\n\t\tpriv->clk = devm_clk_get(&pdev->dev, \"core\");\n\t\tif (IS_ERR(priv->clk)) {\n\t\t\tret = PTR_ERR(priv->clk);\n\t\t\tgoto err_clk;\n\t\t}\n\n\t\tret = clk_prepare_enable(priv->clk);\n\t\tif (ret)\n\t\t\tgoto err_clk;\n\t}\n\n\tsdhci_milbeaut_init(host);\n\n\tret = sdhci_add_host(host);\n\tif (ret)\n\t\tgoto err_add_host;\n\n\treturn 0;\n\nerr_add_host:\n\tclk_disable_unprepare(priv->clk);\nerr_clk:\n\tclk_disable_unprepare(priv->clk_iface);\nerr:\n\tsdhci_free_host(host);\n\treturn ret;\n}\n\nstatic void sdhci_milbeaut_remove(struct platform_device *pdev)\n{\n\tstruct sdhci_host *host = platform_get_drvdata(pdev);\n\tstruct f_sdhost_priv *priv = sdhci_priv(host);\n\n\tsdhci_remove_host(host, readl(host->ioaddr + SDHCI_INT_STATUS) ==\n\t\t\t  0xffffffff);\n\n\tclk_disable_unprepare(priv->clk_iface);\n\tclk_disable_unprepare(priv->clk);\n\n\tsdhci_free_host(host);\n\tplatform_set_drvdata(pdev, NULL);\n}\n\nstatic struct platform_driver sdhci_milbeaut_driver = {\n\t.driver = {\n\t\t.name = \"sdhci-milbeaut\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t\t.of_match_table = mlb_dt_ids,\n\t},\n\t.probe\t= sdhci_milbeaut_probe,\n\t.remove_new = sdhci_milbeaut_remove,\n};\n\nmodule_platform_driver(sdhci_milbeaut_driver);\n\nMODULE_DESCRIPTION(\"MILBEAUT SD Card Controller driver\");\nMODULE_AUTHOR(\"Takao Orito <orito.takao@socionext.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:sdhci-milbeaut\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}