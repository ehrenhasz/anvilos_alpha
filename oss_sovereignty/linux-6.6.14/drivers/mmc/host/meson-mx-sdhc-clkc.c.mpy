{
  "module_name": "meson-mx-sdhc-clkc.c",
  "hash_id": "0ffaa8221cff36daca46d631e41839f5239800bbf107de0f3f5065c9cda1a972",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mmc/host/meson-mx-sdhc-clkc.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/clk-provider.h>\n#include <linux/device.h>\n#include <linux/platform_device.h>\n\n#include \"meson-mx-sdhc.h\"\n\nstruct meson_mx_sdhc_clkc {\n\tstruct clk_mux\t\t\tsrc_sel;\n\tstruct clk_divider\t\tdiv;\n\tstruct clk_gate\t\t\tmod_clk_en;\n\tstruct clk_gate\t\t\ttx_clk_en;\n\tstruct clk_gate\t\t\trx_clk_en;\n\tstruct clk_gate\t\t\tsd_clk_en;\n};\n\nstatic const struct clk_parent_data meson_mx_sdhc_src_sel_parents[4] = {\n\t{ .fw_name = \"clkin0\" },\n\t{ .fw_name = \"clkin1\" },\n\t{ .fw_name = \"clkin2\" },\n\t{ .fw_name = \"clkin3\" },\n};\n\nstatic const struct clk_div_table meson_mx_sdhc_div_table[] = {\n\t{ .div = 6, .val = 5, },\n\t{ .div = 8, .val = 7, },\n\t{ .div = 9, .val = 8, },\n\t{ .div = 10, .val = 9, },\n\t{ .div = 12, .val = 11, },\n\t{ .div = 16, .val = 15, },\n\t{ .div = 18, .val = 17, },\n\t{ .div = 34, .val = 33, },\n\t{ .div = 142, .val = 141, },\n\t{ .div = 850, .val = 849, },\n\t{ .div = 2126, .val = 2125, },\n\t{ .div = 4096, .val = 4095, },\n\t{   }\n};\n\nstatic int meson_mx_sdhc_clk_hw_register(struct device *dev,\n\t\t\t\t\t const char *name_suffix,\n\t\t\t\t\t const struct clk_parent_data *parents,\n\t\t\t\t\t unsigned int num_parents,\n\t\t\t\t\t const struct clk_ops *ops,\n\t\t\t\t\t struct clk_hw *hw)\n{\n\tstruct clk_init_data init = { };\n\tchar clk_name[32];\n\n\tsnprintf(clk_name, sizeof(clk_name), \"%s#%s\", dev_name(dev),\n\t\t name_suffix);\n\n\tinit.name = clk_name;\n\tinit.ops = ops;\n\tinit.flags = CLK_SET_RATE_PARENT;\n\tinit.parent_data = parents;\n\tinit.num_parents = num_parents;\n\n\thw->init = &init;\n\n\treturn devm_clk_hw_register(dev, hw);\n}\n\nstatic int meson_mx_sdhc_gate_clk_hw_register(struct device *dev,\n\t\t\t\t\t      const char *name_suffix,\n\t\t\t\t\t      struct clk_hw *parent,\n\t\t\t\t\t      struct clk_hw *hw)\n{\n\tstruct clk_parent_data parent_data = { .hw = parent };\n\n\treturn meson_mx_sdhc_clk_hw_register(dev, name_suffix, &parent_data, 1,\n\t\t\t\t\t     &clk_gate_ops, hw);\n}\n\nint meson_mx_sdhc_register_clkc(struct device *dev, void __iomem *base,\n\t\t\t\tstruct clk_bulk_data *clk_bulk_data)\n{\n\tstruct clk_parent_data div_parent = { };\n\tstruct meson_mx_sdhc_clkc *clkc_data;\n\tint ret;\n\n\tclkc_data = devm_kzalloc(dev, sizeof(*clkc_data), GFP_KERNEL);\n\tif (!clkc_data)\n\t\treturn -ENOMEM;\n\n\tclkc_data->src_sel.reg = base + MESON_SDHC_CLKC;\n\tclkc_data->src_sel.mask = 0x3;\n\tclkc_data->src_sel.shift = 16;\n\tret = meson_mx_sdhc_clk_hw_register(dev, \"src_sel\",\n\t\t\t\t\t    meson_mx_sdhc_src_sel_parents, 4,\n\t\t\t\t\t    &clk_mux_ops,\n\t\t\t\t\t    &clkc_data->src_sel.hw);\n\tif (ret)\n\t\treturn ret;\n\n\tclkc_data->div.reg = base + MESON_SDHC_CLKC;\n\tclkc_data->div.shift = 0;\n\tclkc_data->div.width = 12;\n\tclkc_data->div.table = meson_mx_sdhc_div_table;\n\tdiv_parent.hw = &clkc_data->src_sel.hw;\n\tret = meson_mx_sdhc_clk_hw_register(dev, \"div\", &div_parent, 1,\n\t\t\t\t\t    &clk_divider_ops,\n\t\t\t\t\t    &clkc_data->div.hw);\n\tif (ret)\n\t\treturn ret;\n\n\tclkc_data->mod_clk_en.reg = base + MESON_SDHC_CLKC;\n\tclkc_data->mod_clk_en.bit_idx = 15;\n\tret = meson_mx_sdhc_gate_clk_hw_register(dev, \"mod_clk_on\",\n\t\t\t\t\t\t &clkc_data->div.hw,\n\t\t\t\t\t\t &clkc_data->mod_clk_en.hw);\n\tif (ret)\n\t\treturn ret;\n\n\tclkc_data->tx_clk_en.reg = base + MESON_SDHC_CLKC;\n\tclkc_data->tx_clk_en.bit_idx = 14;\n\tret = meson_mx_sdhc_gate_clk_hw_register(dev, \"tx_clk_on\",\n\t\t\t\t\t\t &clkc_data->div.hw,\n\t\t\t\t\t\t &clkc_data->tx_clk_en.hw);\n\tif (ret)\n\t\treturn ret;\n\n\tclkc_data->rx_clk_en.reg = base + MESON_SDHC_CLKC;\n\tclkc_data->rx_clk_en.bit_idx = 13;\n\tret = meson_mx_sdhc_gate_clk_hw_register(dev, \"rx_clk_on\",\n\t\t\t\t\t\t &clkc_data->div.hw,\n\t\t\t\t\t\t &clkc_data->rx_clk_en.hw);\n\tif (ret)\n\t\treturn ret;\n\n\tclkc_data->sd_clk_en.reg = base + MESON_SDHC_CLKC;\n\tclkc_data->sd_clk_en.bit_idx = 12;\n\tret = meson_mx_sdhc_gate_clk_hw_register(dev, \"sd_clk_on\",\n\t\t\t\t\t\t &clkc_data->div.hw,\n\t\t\t\t\t\t &clkc_data->sd_clk_en.hw);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tclk_bulk_data[0].clk = clkc_data->mod_clk_en.hw.clk;\n\tclk_bulk_data[1].clk = clkc_data->sd_clk_en.hw.clk;\n\tclk_bulk_data[2].clk = clkc_data->tx_clk_en.hw.clk;\n\tclk_bulk_data[3].clk = clkc_data->rx_clk_en.hw.clk;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}