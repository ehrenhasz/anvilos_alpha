{
  "module_name": "dw_mmc-pltfm.c",
  "hash_id": "5cce9fb536b2745cd6acc727187466c43c27f391fd49f0dc4b574845112bbed6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mmc/host/dw_mmc-pltfm.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/io.h>\n#include <linux/irq.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include <linux/slab.h>\n#include <linux/mmc/host.h>\n#include <linux/mmc/mmc.h>\n#include <linux/of.h>\n#include <linux/mfd/altera-sysmgr.h>\n#include <linux/regmap.h>\n\n#include \"dw_mmc.h\"\n#include \"dw_mmc-pltfm.h\"\n\n#define SOCFPGA_DW_MMC_CLK_PHASE_STEP\t45\n#define SYSMGR_SDMMC_CTRL_SET(smplsel, drvsel, reg_shift) \\\n\t((((smplsel) & 0x7) << reg_shift) | (((drvsel) & 0x7) << 0))\n\nint dw_mci_pltfm_register(struct platform_device *pdev,\n\t\t\t  const struct dw_mci_drv_data *drv_data)\n{\n\tstruct dw_mci *host;\n\tstruct resource\t*regs;\n\n\thost = devm_kzalloc(&pdev->dev, sizeof(struct dw_mci), GFP_KERNEL);\n\tif (!host)\n\t\treturn -ENOMEM;\n\n\thost->irq = platform_get_irq(pdev, 0);\n\tif (host->irq < 0)\n\t\treturn host->irq;\n\n\thost->drv_data = drv_data;\n\thost->dev = &pdev->dev;\n\thost->irq_flags = 0;\n\thost->pdata = pdev->dev.platform_data;\n\n\thost->regs = devm_platform_get_and_ioremap_resource(pdev, 0, &regs);\n\tif (IS_ERR(host->regs))\n\t\treturn PTR_ERR(host->regs);\n\n\t \n\thost->phy_regs = regs->start;\n\n\tplatform_set_drvdata(pdev, host);\n\treturn dw_mci_probe(host);\n}\nEXPORT_SYMBOL_GPL(dw_mci_pltfm_register);\n\nconst struct dev_pm_ops dw_mci_pltfm_pmops = {\n\tSET_SYSTEM_SLEEP_PM_OPS(pm_runtime_force_suspend,\n\t\t\t\tpm_runtime_force_resume)\n\tSET_RUNTIME_PM_OPS(dw_mci_runtime_suspend,\n\t\t\t   dw_mci_runtime_resume,\n\t\t\t   NULL)\n};\nEXPORT_SYMBOL_GPL(dw_mci_pltfm_pmops);\n\nstatic int dw_mci_socfpga_priv_init(struct dw_mci *host)\n{\n\tstruct device_node *np = host->dev->of_node;\n\tstruct regmap *sys_mgr_base_addr;\n\tu32 clk_phase[2] = {0}, reg_offset, reg_shift;\n\tint i, rc, hs_timing;\n\n\trc = of_property_read_variable_u32_array(np, \"clk-phase-sd-hs\", &clk_phase[0], 2, 0);\n\tif (rc < 0)\n\t\treturn 0;\n\n\tsys_mgr_base_addr = altr_sysmgr_regmap_lookup_by_phandle(np, \"altr,sysmgr-syscon\");\n\tif (IS_ERR(sys_mgr_base_addr)) {\n\t\tdev_warn(host->dev, \"clk-phase-sd-hs was specified, but failed to find altr,sys-mgr regmap!\\n\");\n\t\treturn 0;\n\t}\n\n\tof_property_read_u32_index(np, \"altr,sysmgr-syscon\", 1, &reg_offset);\n\tof_property_read_u32_index(np, \"altr,sysmgr-syscon\", 2, &reg_shift);\n\n\tfor (i = 0; i < ARRAY_SIZE(clk_phase); i++)\n\t\tclk_phase[i] /= SOCFPGA_DW_MMC_CLK_PHASE_STEP;\n\n\ths_timing = SYSMGR_SDMMC_CTRL_SET(clk_phase[0], clk_phase[1], reg_shift);\n\tregmap_write(sys_mgr_base_addr, reg_offset, hs_timing);\n\n\treturn 0;\n}\n\nstatic const struct dw_mci_drv_data socfpga_drv_data = {\n\t.init\t\t= dw_mci_socfpga_priv_init,\n};\n\nstatic const struct of_device_id dw_mci_pltfm_match[] = {\n\t{ .compatible = \"snps,dw-mshc\", },\n\t{ .compatible = \"altr,socfpga-dw-mshc\", .data = &socfpga_drv_data, },\n\t{ .compatible = \"img,pistachio-dw-mshc\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, dw_mci_pltfm_match);\n\nstatic int dw_mci_pltfm_probe(struct platform_device *pdev)\n{\n\tconst struct dw_mci_drv_data *drv_data = NULL;\n\tconst struct of_device_id *match;\n\n\tif (pdev->dev.of_node) {\n\t\tmatch = of_match_node(dw_mci_pltfm_match, pdev->dev.of_node);\n\t\tdrv_data = match->data;\n\t}\n\n\treturn dw_mci_pltfm_register(pdev, drv_data);\n}\n\nvoid dw_mci_pltfm_remove(struct platform_device *pdev)\n{\n\tstruct dw_mci *host = platform_get_drvdata(pdev);\n\n\tdw_mci_remove(host);\n}\nEXPORT_SYMBOL_GPL(dw_mci_pltfm_remove);\n\nstatic struct platform_driver dw_mci_pltfm_driver = {\n\t.probe\t\t= dw_mci_pltfm_probe,\n\t.remove_new\t= dw_mci_pltfm_remove,\n\t.driver\t\t= {\n\t\t.name\t\t= \"dw_mmc\",\n\t\t.probe_type\t= PROBE_PREFER_ASYNCHRONOUS,\n\t\t.of_match_table\t= dw_mci_pltfm_match,\n\t\t.pm\t\t= &dw_mci_pltfm_pmops,\n\t},\n};\n\nmodule_platform_driver(dw_mci_pltfm_driver);\n\nMODULE_DESCRIPTION(\"DW Multimedia Card Interface driver\");\nMODULE_AUTHOR(\"NXP Semiconductor VietNam\");\nMODULE_AUTHOR(\"Imagination Technologies Ltd\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}