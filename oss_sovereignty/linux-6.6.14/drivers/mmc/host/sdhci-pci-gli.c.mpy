{
  "module_name": "sdhci-pci-gli.c",
  "hash_id": "aba7e11886797c8250d93756fe96dc8e3daf205c4c1386780d74902a8d90b027",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mmc/host/sdhci-pci-gli.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/bits.h>\n#include <linux/pci.h>\n#include <linux/mmc/mmc.h>\n#include <linux/delay.h>\n#include <linux/of.h>\n#include <linux/iopoll.h>\n#include \"sdhci.h\"\n#include \"sdhci-cqhci.h\"\n#include \"sdhci-pci.h\"\n#include \"cqhci.h\"\n\n \n#define SDHCI_GLI_9750_WT         0x800\n#define   SDHCI_GLI_9750_WT_EN      BIT(0)\n#define   GLI_9750_WT_EN_ON\t    0x1\n#define   GLI_9750_WT_EN_OFF\t    0x0\n\n#define PCI_GLI_9750_PM_CTRL\t0xFC\n#define   PCI_GLI_9750_PM_STATE\t  GENMASK(1, 0)\n\n#define PCI_GLI_9750_CORRERR_MASK\t\t\t\t0x214\n#define   PCI_GLI_9750_CORRERR_MASK_REPLAY_TIMER_TIMEOUT\t  BIT(12)\n\n#define SDHCI_GLI_9750_CFG2          0x848\n#define   SDHCI_GLI_9750_CFG2_L1DLY    GENMASK(28, 24)\n#define   GLI_9750_CFG2_L1DLY_VALUE    0x1F\n\n#define SDHCI_GLI_9750_DRIVING      0x860\n#define   SDHCI_GLI_9750_DRIVING_1    GENMASK(11, 0)\n#define   SDHCI_GLI_9750_DRIVING_2    GENMASK(27, 26)\n#define   GLI_9750_DRIVING_1_VALUE    0xFFF\n#define   GLI_9750_DRIVING_2_VALUE    0x3\n#define   SDHCI_GLI_9750_SEL_1        BIT(29)\n#define   SDHCI_GLI_9750_SEL_2        BIT(31)\n#define   SDHCI_GLI_9750_ALL_RST      (BIT(24)|BIT(25)|BIT(28)|BIT(30))\n\n#define SDHCI_GLI_9750_PLL\t      0x864\n#define   SDHCI_GLI_9750_PLL_LDIV       GENMASK(9, 0)\n#define   SDHCI_GLI_9750_PLL_PDIV       GENMASK(14, 12)\n#define   SDHCI_GLI_9750_PLL_DIR        BIT(15)\n#define   SDHCI_GLI_9750_PLL_TX2_INV    BIT(23)\n#define   SDHCI_GLI_9750_PLL_TX2_DLY    GENMASK(22, 20)\n#define   GLI_9750_PLL_TX2_INV_VALUE    0x1\n#define   GLI_9750_PLL_TX2_DLY_VALUE    0x0\n#define   SDHCI_GLI_9750_PLLSSC_STEP    GENMASK(28, 24)\n#define   SDHCI_GLI_9750_PLLSSC_EN      BIT(31)\n\n#define SDHCI_GLI_9750_PLLSSC        0x86C\n#define   SDHCI_GLI_9750_PLLSSC_PPM    GENMASK(31, 16)\n\n#define SDHCI_GLI_9750_SW_CTRL      0x874\n#define   SDHCI_GLI_9750_SW_CTRL_4    GENMASK(7, 6)\n#define   GLI_9750_SW_CTRL_4_VALUE    0x3\n\n#define SDHCI_GLI_9750_MISC            0x878\n#define   SDHCI_GLI_9750_MISC_TX1_INV    BIT(2)\n#define   SDHCI_GLI_9750_MISC_RX_INV     BIT(3)\n#define   SDHCI_GLI_9750_MISC_TX1_DLY    GENMASK(6, 4)\n#define   GLI_9750_MISC_TX1_INV_VALUE    0x0\n#define   GLI_9750_MISC_RX_INV_ON        0x1\n#define   GLI_9750_MISC_RX_INV_OFF       0x0\n#define   GLI_9750_MISC_RX_INV_VALUE     GLI_9750_MISC_RX_INV_OFF\n#define   GLI_9750_MISC_TX1_DLY_VALUE    0x5\n#define   SDHCI_GLI_9750_MISC_SSC_OFF    BIT(26)\n\n#define SDHCI_GLI_9750_TUNING_CONTROL\t          0x540\n#define   SDHCI_GLI_9750_TUNING_CONTROL_EN          BIT(4)\n#define   GLI_9750_TUNING_CONTROL_EN_ON             0x1\n#define   GLI_9750_TUNING_CONTROL_EN_OFF            0x0\n#define   SDHCI_GLI_9750_TUNING_CONTROL_GLITCH_1    BIT(16)\n#define   SDHCI_GLI_9750_TUNING_CONTROL_GLITCH_2    GENMASK(20, 19)\n#define   GLI_9750_TUNING_CONTROL_GLITCH_1_VALUE    0x1\n#define   GLI_9750_TUNING_CONTROL_GLITCH_2_VALUE    0x2\n\n#define SDHCI_GLI_9750_TUNING_PARAMETERS           0x544\n#define   SDHCI_GLI_9750_TUNING_PARAMETERS_RX_DLY    GENMASK(2, 0)\n#define   GLI_9750_TUNING_PARAMETERS_RX_DLY_VALUE    0x1\n\n#define SDHCI_GLI_9763E_CTRL_HS400  0x7\n\n#define SDHCI_GLI_9763E_HS400_ES_REG      0x52C\n#define   SDHCI_GLI_9763E_HS400_ES_BIT      BIT(8)\n\n#define PCIE_GLI_9763E_VHS\t 0x884\n#define   GLI_9763E_VHS_REV\t   GENMASK(19, 16)\n#define   GLI_9763E_VHS_REV_R      0x0\n#define   GLI_9763E_VHS_REV_M      0x1\n#define   GLI_9763E_VHS_REV_W      0x2\n#define PCIE_GLI_9763E_MB\t 0x888\n#define   GLI_9763E_MB_CMDQ_OFF\t   BIT(19)\n#define   GLI_9763E_MB_ERP_ON      BIT(7)\n#define PCIE_GLI_9763E_SCR\t 0x8E0\n#define   GLI_9763E_SCR_AXI_REQ\t   BIT(9)\n\n#define PCIE_GLI_9763E_CFG       0x8A0\n#define   GLI_9763E_CFG_LPSN_DIS   BIT(12)\n\n#define PCIE_GLI_9763E_CFG2      0x8A4\n#define   GLI_9763E_CFG2_L1DLY     GENMASK(28, 19)\n#define   GLI_9763E_CFG2_L1DLY_MID 0x54\n\n#define PCIE_GLI_9763E_MMC_CTRL  0x960\n#define   GLI_9763E_HS400_SLOW     BIT(3)\n\n#define PCIE_GLI_9763E_CLKRXDLY  0x934\n#define   GLI_9763E_HS400_RXDLY    GENMASK(31, 28)\n#define   GLI_9763E_HS400_RXDLY_5  0x5\n\n#define SDHCI_GLI_9763E_CQE_BASE_ADDR\t 0x200\n#define GLI_9763E_CQE_TRNS_MODE\t   (SDHCI_TRNS_MULTI | \\\n\t\t\t\t    SDHCI_TRNS_BLK_CNT_EN | \\\n\t\t\t\t    SDHCI_TRNS_DMA)\n\n#define PCI_GLI_9755_WT       0x800\n#define   PCI_GLI_9755_WT_EN    BIT(0)\n#define   GLI_9755_WT_EN_ON     0x1\n#define   GLI_9755_WT_EN_OFF    0x0\n\n#define PCI_GLI_9755_PECONF   0x44\n#define   PCI_GLI_9755_LFCLK    GENMASK(14, 12)\n#define   PCI_GLI_9755_DMACLK   BIT(29)\n#define   PCI_GLI_9755_INVERT_CD  BIT(30)\n#define   PCI_GLI_9755_INVERT_WP  BIT(31)\n\n#define PCI_GLI_9755_CFG2          0x48\n#define   PCI_GLI_9755_CFG2_L1DLY    GENMASK(28, 24)\n#define   GLI_9755_CFG2_L1DLY_VALUE  0x1F\n\n#define PCI_GLI_9755_PLL            0x64\n#define   PCI_GLI_9755_PLL_LDIV       GENMASK(9, 0)\n#define   PCI_GLI_9755_PLL_PDIV       GENMASK(14, 12)\n#define   PCI_GLI_9755_PLL_DIR        BIT(15)\n#define   PCI_GLI_9755_PLLSSC_STEP    GENMASK(28, 24)\n#define   PCI_GLI_9755_PLLSSC_EN      BIT(31)\n\n#define PCI_GLI_9755_PLLSSC        0x68\n#define   PCI_GLI_9755_PLLSSC_PPM    GENMASK(15, 0)\n\n#define PCI_GLI_9755_SerDes  0x70\n#define PCI_GLI_9755_SCP_DIS   BIT(19)\n\n#define PCI_GLI_9755_MISC\t    0x78\n#define   PCI_GLI_9755_MISC_SSC_OFF    BIT(26)\n\n#define PCI_GLI_9755_PM_CTRL     0xFC\n#define   PCI_GLI_9755_PM_STATE    GENMASK(1, 0)\n\n#define PCI_GLI_9755_CORRERR_MASK\t\t\t\t0x214\n#define   PCI_GLI_9755_CORRERR_MASK_REPLAY_TIMER_TIMEOUT\t  BIT(12)\n\n#define SDHCI_GLI_9767_GM_BURST_SIZE\t\t\t0x510\n#define   SDHCI_GLI_9767_GM_BURST_SIZE_AXI_ALWAYS_SET\t  BIT(8)\n\n#define PCIE_GLI_9767_VHS\t0x884\n#define   GLI_9767_VHS_REV\t  GENMASK(19, 16)\n#define   GLI_9767_VHS_REV_R\t  0x0\n#define   GLI_9767_VHS_REV_M\t  0x1\n#define   GLI_9767_VHS_REV_W\t  0x2\n\n#define PCIE_GLI_9767_COM_MAILBOX\t\t0x888\n#define   PCIE_GLI_9767_COM_MAILBOX_SSC_EN\t  BIT(1)\n\n#define PCIE_GLI_9767_CFG\t\t0x8A0\n#define   PCIE_GLI_9767_CFG_LOW_PWR_OFF\t  BIT(12)\n\n#define PCIE_GLI_9767_COMBO_MUX_CTL\t\t\t0x8C8\n#define   PCIE_GLI_9767_COMBO_MUX_CTL_RST_EN\t\t  BIT(6)\n#define   PCIE_GLI_9767_COMBO_MUX_CTL_WAIT_PERST_EN\t  BIT(10)\n\n#define PCIE_GLI_9767_PWR_MACRO_CTL\t\t\t\t\t0x8D0\n#define   PCIE_GLI_9767_PWR_MACRO_CTL_LOW_VOLTAGE\t\t\t  GENMASK(3, 0)\n#define   PCIE_GLI_9767_PWR_MACRO_CTL_LD0_LOW_OUTPUT_VOLTAGE\t\t  GENMASK(15, 12)\n#define   PCIE_GLI_9767_PWR_MACRO_CTL_LD0_LOW_OUTPUT_VOLTAGE_VALUE\t  0x7\n#define   PCIE_GLI_9767_PWR_MACRO_CTL_RCLK_AMPLITUDE_CTL\t\t  GENMASK(29, 28)\n#define   PCIE_GLI_9767_PWR_MACRO_CTL_RCLK_AMPLITUDE_CTL_VALUE\t\t  0x3\n\n#define PCIE_GLI_9767_SCR\t\t\t\t0x8E0\n#define   PCIE_GLI_9767_SCR_AUTO_AXI_W_BURST\t\t  BIT(6)\n#define   PCIE_GLI_9767_SCR_AUTO_AXI_R_BURST\t\t  BIT(7)\n#define   PCIE_GLI_9767_SCR_AXI_REQ\t\t\t  BIT(9)\n#define   PCIE_GLI_9767_SCR_CARD_DET_PWR_SAVING_EN\t  BIT(10)\n#define   PCIE_GLI_9767_SCR_SYSTEM_CLK_SELECT_MODE0\t  BIT(16)\n#define   PCIE_GLI_9767_SCR_SYSTEM_CLK_SELECT_MODE1\t  BIT(17)\n#define   PCIE_GLI_9767_SCR_CORE_PWR_D3_OFF\t\t  BIT(21)\n#define   PCIE_GLI_9767_SCR_CFG_RST_DATA_LINK_DOWN\t  BIT(30)\n\n#define PCIE_GLI_9767_SDHC_CAP\t\t\t0x91C\n#define   PCIE_GLI_9767_SDHC_CAP_SDEI_RESULT\t  BIT(5)\n\n#define PCIE_GLI_9767_SD_PLL_CTL\t\t\t0x938\n#define   PCIE_GLI_9767_SD_PLL_CTL_PLL_LDIV\t\t  GENMASK(9, 0)\n#define   PCIE_GLI_9767_SD_PLL_CTL_PLL_PDIV\t\t  GENMASK(15, 12)\n#define   PCIE_GLI_9767_SD_PLL_CTL_PLL_DIR_EN\t\t  BIT(16)\n#define   PCIE_GLI_9767_SD_PLL_CTL_SSC_EN\t\t  BIT(19)\n#define   PCIE_GLI_9767_SD_PLL_CTL_SSC_STEP_SETTING\t  GENMASK(28, 24)\n\n#define PCIE_GLI_9767_SD_PLL_CTL2\t\t0x93C\n#define   PCIE_GLI_9767_SD_PLL_CTL2_PLLSSC_PPM\t  GENMASK(31, 16)\n\n#define PCIE_GLI_9767_SD_EXPRESS_CTL\t\t\t0x940\n#define   PCIE_GLI_9767_SD_EXPRESS_CTL_SDEI_EXE\t\t  BIT(0)\n#define   PCIE_GLI_9767_SD_EXPRESS_CTL_SD_EXPRESS_MODE\t  BIT(1)\n\n#define PCIE_GLI_9767_SD_DATA_MULTI_CTL\t\t\t\t0x944\n#define   PCIE_GLI_9767_SD_DATA_MULTI_CTL_DISCONNECT_TIME\t  GENMASK(23, 16)\n#define   PCIE_GLI_9767_SD_DATA_MULTI_CTL_DISCONNECT_TIME_VALUE\t  0x64\n\n#define PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_REG2\t\t\t0x950\n#define   PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_REG2_SDEI_COMPLETE\t  BIT(0)\n\n#define PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_EN_REG2\t\t\t\t0x954\n#define   PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_EN_REG2_SDEI_COMPLETE_STATUS_EN\t  BIT(0)\n\n#define PCIE_GLI_9767_NORMAL_ERR_INT_SIGNAL_EN_REG2\t\t\t\t0x958\n#define   PCIE_GLI_9767_NORMAL_ERR_INT_SIGNAL_EN_REG2_SDEI_COMPLETE_SIGNAL_EN\t  BIT(0)\n\n#define GLI_MAX_TUNING_LOOP 40\n\n \nstatic inline void gl9750_wt_on(struct sdhci_host *host)\n{\n\tu32 wt_value;\n\tu32 wt_enable;\n\n\twt_value = sdhci_readl(host, SDHCI_GLI_9750_WT);\n\twt_enable = FIELD_GET(SDHCI_GLI_9750_WT_EN, wt_value);\n\n\tif (wt_enable == GLI_9750_WT_EN_ON)\n\t\treturn;\n\n\twt_value &= ~SDHCI_GLI_9750_WT_EN;\n\twt_value |= FIELD_PREP(SDHCI_GLI_9750_WT_EN, GLI_9750_WT_EN_ON);\n\n\tsdhci_writel(host, wt_value, SDHCI_GLI_9750_WT);\n}\n\nstatic inline void gl9750_wt_off(struct sdhci_host *host)\n{\n\tu32 wt_value;\n\tu32 wt_enable;\n\n\twt_value = sdhci_readl(host, SDHCI_GLI_9750_WT);\n\twt_enable = FIELD_GET(SDHCI_GLI_9750_WT_EN, wt_value);\n\n\tif (wt_enable == GLI_9750_WT_EN_OFF)\n\t\treturn;\n\n\twt_value &= ~SDHCI_GLI_9750_WT_EN;\n\twt_value |= FIELD_PREP(SDHCI_GLI_9750_WT_EN, GLI_9750_WT_EN_OFF);\n\n\tsdhci_writel(host, wt_value, SDHCI_GLI_9750_WT);\n}\n\nstatic void gli_set_9750(struct sdhci_host *host)\n{\n\tu32 driving_value;\n\tu32 pll_value;\n\tu32 sw_ctrl_value;\n\tu32 misc_value;\n\tu32 parameter_value;\n\tu32 control_value;\n\tu16 ctrl2;\n\n\tgl9750_wt_on(host);\n\n\tdriving_value = sdhci_readl(host, SDHCI_GLI_9750_DRIVING);\n\tpll_value = sdhci_readl(host, SDHCI_GLI_9750_PLL);\n\tsw_ctrl_value = sdhci_readl(host, SDHCI_GLI_9750_SW_CTRL);\n\tmisc_value = sdhci_readl(host, SDHCI_GLI_9750_MISC);\n\tparameter_value = sdhci_readl(host, SDHCI_GLI_9750_TUNING_PARAMETERS);\n\tcontrol_value = sdhci_readl(host, SDHCI_GLI_9750_TUNING_CONTROL);\n\n\tdriving_value &= ~(SDHCI_GLI_9750_DRIVING_1);\n\tdriving_value &= ~(SDHCI_GLI_9750_DRIVING_2);\n\tdriving_value |= FIELD_PREP(SDHCI_GLI_9750_DRIVING_1,\n\t\t\t\t    GLI_9750_DRIVING_1_VALUE);\n\tdriving_value |= FIELD_PREP(SDHCI_GLI_9750_DRIVING_2,\n\t\t\t\t    GLI_9750_DRIVING_2_VALUE);\n\tdriving_value &= ~(SDHCI_GLI_9750_SEL_1|SDHCI_GLI_9750_SEL_2|SDHCI_GLI_9750_ALL_RST);\n\tdriving_value |= SDHCI_GLI_9750_SEL_2;\n\tsdhci_writel(host, driving_value, SDHCI_GLI_9750_DRIVING);\n\n\tsw_ctrl_value &= ~SDHCI_GLI_9750_SW_CTRL_4;\n\tsw_ctrl_value |= FIELD_PREP(SDHCI_GLI_9750_SW_CTRL_4,\n\t\t\t\t    GLI_9750_SW_CTRL_4_VALUE);\n\tsdhci_writel(host, sw_ctrl_value, SDHCI_GLI_9750_SW_CTRL);\n\n\t \n\tpll_value &= ~SDHCI_GLI_9750_PLL_TX2_INV;\n\tpll_value &= ~SDHCI_GLI_9750_PLL_TX2_DLY;\n\tpll_value |= FIELD_PREP(SDHCI_GLI_9750_PLL_TX2_INV,\n\t\t\t\tGLI_9750_PLL_TX2_INV_VALUE);\n\tpll_value |= FIELD_PREP(SDHCI_GLI_9750_PLL_TX2_DLY,\n\t\t\t\tGLI_9750_PLL_TX2_DLY_VALUE);\n\n\tmisc_value &= ~SDHCI_GLI_9750_MISC_TX1_INV;\n\tmisc_value &= ~SDHCI_GLI_9750_MISC_RX_INV;\n\tmisc_value &= ~SDHCI_GLI_9750_MISC_TX1_DLY;\n\tmisc_value |= FIELD_PREP(SDHCI_GLI_9750_MISC_TX1_INV,\n\t\t\t\t GLI_9750_MISC_TX1_INV_VALUE);\n\tmisc_value |= FIELD_PREP(SDHCI_GLI_9750_MISC_RX_INV,\n\t\t\t\t GLI_9750_MISC_RX_INV_VALUE);\n\tmisc_value |= FIELD_PREP(SDHCI_GLI_9750_MISC_TX1_DLY,\n\t\t\t\t GLI_9750_MISC_TX1_DLY_VALUE);\n\n\tparameter_value &= ~SDHCI_GLI_9750_TUNING_PARAMETERS_RX_DLY;\n\tparameter_value |= FIELD_PREP(SDHCI_GLI_9750_TUNING_PARAMETERS_RX_DLY,\n\t\t\t\t      GLI_9750_TUNING_PARAMETERS_RX_DLY_VALUE);\n\n\tcontrol_value &= ~SDHCI_GLI_9750_TUNING_CONTROL_GLITCH_1;\n\tcontrol_value &= ~SDHCI_GLI_9750_TUNING_CONTROL_GLITCH_2;\n\tcontrol_value |= FIELD_PREP(SDHCI_GLI_9750_TUNING_CONTROL_GLITCH_1,\n\t\t\t\t    GLI_9750_TUNING_CONTROL_GLITCH_1_VALUE);\n\tcontrol_value |= FIELD_PREP(SDHCI_GLI_9750_TUNING_CONTROL_GLITCH_2,\n\t\t\t\t    GLI_9750_TUNING_CONTROL_GLITCH_2_VALUE);\n\n\tsdhci_writel(host, pll_value, SDHCI_GLI_9750_PLL);\n\tsdhci_writel(host, misc_value, SDHCI_GLI_9750_MISC);\n\n\t \n\tctrl2 = sdhci_readw(host, SDHCI_HOST_CONTROL2);\n\tctrl2 &= ~SDHCI_CTRL_TUNED_CLK;\n\tsdhci_writew(host, ctrl2, SDHCI_HOST_CONTROL2);\n\n\t \n\tcontrol_value &= ~SDHCI_GLI_9750_TUNING_CONTROL_EN;\n\tcontrol_value |= FIELD_PREP(SDHCI_GLI_9750_TUNING_CONTROL_EN,\n\t\t\t\t    GLI_9750_TUNING_CONTROL_EN_ON);\n\tsdhci_writel(host, control_value, SDHCI_GLI_9750_TUNING_CONTROL);\n\n\t \n\tsdhci_writel(host, parameter_value, SDHCI_GLI_9750_TUNING_PARAMETERS);\n\n\t \n\tcontrol_value &= ~SDHCI_GLI_9750_TUNING_CONTROL_EN;\n\tcontrol_value |= FIELD_PREP(SDHCI_GLI_9750_TUNING_CONTROL_EN,\n\t\t\t\t    GLI_9750_TUNING_CONTROL_EN_OFF);\n\tsdhci_writel(host, control_value, SDHCI_GLI_9750_TUNING_CONTROL);\n\n\t \n\tctrl2 = sdhci_readw(host, SDHCI_HOST_CONTROL2);\n\tctrl2 &= ~SDHCI_CTRL_TUNED_CLK;\n\tsdhci_writew(host, ctrl2, SDHCI_HOST_CONTROL2);\n\n\tgl9750_wt_off(host);\n}\n\nstatic void gli_set_9750_rx_inv(struct sdhci_host *host, bool b)\n{\n\tu32 misc_value;\n\n\tgl9750_wt_on(host);\n\n\tmisc_value = sdhci_readl(host, SDHCI_GLI_9750_MISC);\n\tmisc_value &= ~SDHCI_GLI_9750_MISC_RX_INV;\n\tif (b) {\n\t\tmisc_value |= FIELD_PREP(SDHCI_GLI_9750_MISC_RX_INV,\n\t\t\t\t\t GLI_9750_MISC_RX_INV_ON);\n\t} else {\n\t\tmisc_value |= FIELD_PREP(SDHCI_GLI_9750_MISC_RX_INV,\n\t\t\t\t\t GLI_9750_MISC_RX_INV_OFF);\n\t}\n\tsdhci_writel(host, misc_value, SDHCI_GLI_9750_MISC);\n\n\tgl9750_wt_off(host);\n}\n\nstatic int __sdhci_execute_tuning_9750(struct sdhci_host *host, u32 opcode)\n{\n\tint i;\n\tint rx_inv;\n\n\tfor (rx_inv = 0; rx_inv < 2; rx_inv++) {\n\t\tgli_set_9750_rx_inv(host, !!rx_inv);\n\t\tsdhci_start_tuning(host);\n\n\t\tfor (i = 0; i < GLI_MAX_TUNING_LOOP; i++) {\n\t\t\tu16 ctrl;\n\n\t\t\tsdhci_send_tuning(host, opcode);\n\n\t\t\tif (!host->tuning_done) {\n\t\t\t\tsdhci_abort_tuning(host, opcode);\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tctrl = sdhci_readw(host, SDHCI_HOST_CONTROL2);\n\t\t\tif (!(ctrl & SDHCI_CTRL_EXEC_TUNING)) {\n\t\t\t\tif (ctrl & SDHCI_CTRL_TUNED_CLK)\n\t\t\t\t\treturn 0;  \n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tif (!host->tuning_done) {\n\t\tpr_info(\"%s: Tuning timeout, falling back to fixed sampling clock\\n\",\n\t\t\tmmc_hostname(host->mmc));\n\t\treturn -ETIMEDOUT;\n\t}\n\n\tpr_info(\"%s: Tuning failed, falling back to fixed sampling clock\\n\",\n\t\tmmc_hostname(host->mmc));\n\tsdhci_reset_tuning(host);\n\n\treturn -EAGAIN;\n}\n\nstatic int gl9750_execute_tuning(struct sdhci_host *host, u32 opcode)\n{\n\thost->mmc->retune_period = 0;\n\tif (host->tuning_mode == SDHCI_TUNING_MODE_1)\n\t\thost->mmc->retune_period = host->tuning_count;\n\n\tgli_set_9750(host);\n\thost->tuning_err = __sdhci_execute_tuning_9750(host, opcode);\n\tsdhci_end_tuning(host);\n\n\treturn 0;\n}\n\nstatic void gl9750_disable_ssc_pll(struct sdhci_host *host)\n{\n\tu32 pll;\n\n\tgl9750_wt_on(host);\n\tpll = sdhci_readl(host, SDHCI_GLI_9750_PLL);\n\tpll &= ~(SDHCI_GLI_9750_PLL_DIR | SDHCI_GLI_9750_PLLSSC_EN);\n\tsdhci_writel(host, pll, SDHCI_GLI_9750_PLL);\n\tgl9750_wt_off(host);\n}\n\nstatic void gl9750_set_pll(struct sdhci_host *host, u8 dir, u16 ldiv, u8 pdiv)\n{\n\tu32 pll;\n\n\tgl9750_wt_on(host);\n\tpll = sdhci_readl(host, SDHCI_GLI_9750_PLL);\n\tpll &= ~(SDHCI_GLI_9750_PLL_LDIV |\n\t\t SDHCI_GLI_9750_PLL_PDIV |\n\t\t SDHCI_GLI_9750_PLL_DIR);\n\tpll |= FIELD_PREP(SDHCI_GLI_9750_PLL_LDIV, ldiv) |\n\t       FIELD_PREP(SDHCI_GLI_9750_PLL_PDIV, pdiv) |\n\t       FIELD_PREP(SDHCI_GLI_9750_PLL_DIR, dir);\n\tsdhci_writel(host, pll, SDHCI_GLI_9750_PLL);\n\tgl9750_wt_off(host);\n\n\t \n\tmdelay(1);\n}\n\nstatic bool gl9750_ssc_enable(struct sdhci_host *host)\n{\n\tu32 misc;\n\tu8 off;\n\n\tgl9750_wt_on(host);\n\tmisc = sdhci_readl(host, SDHCI_GLI_9750_MISC);\n\toff = FIELD_GET(SDHCI_GLI_9750_MISC_SSC_OFF, misc);\n\tgl9750_wt_off(host);\n\n\treturn !off;\n}\n\nstatic void gl9750_set_ssc(struct sdhci_host *host, u8 enable, u8 step, u16 ppm)\n{\n\tu32 pll;\n\tu32 ssc;\n\n\tgl9750_wt_on(host);\n\tpll = sdhci_readl(host, SDHCI_GLI_9750_PLL);\n\tssc = sdhci_readl(host, SDHCI_GLI_9750_PLLSSC);\n\tpll &= ~(SDHCI_GLI_9750_PLLSSC_STEP |\n\t\t SDHCI_GLI_9750_PLLSSC_EN);\n\tssc &= ~SDHCI_GLI_9750_PLLSSC_PPM;\n\tpll |= FIELD_PREP(SDHCI_GLI_9750_PLLSSC_STEP, step) |\n\t       FIELD_PREP(SDHCI_GLI_9750_PLLSSC_EN, enable);\n\tssc |= FIELD_PREP(SDHCI_GLI_9750_PLLSSC_PPM, ppm);\n\tsdhci_writel(host, ssc, SDHCI_GLI_9750_PLLSSC);\n\tsdhci_writel(host, pll, SDHCI_GLI_9750_PLL);\n\tgl9750_wt_off(host);\n}\n\nstatic void gl9750_set_ssc_pll_205mhz(struct sdhci_host *host)\n{\n\tbool enable = gl9750_ssc_enable(host);\n\n\t \n\tgl9750_set_ssc(host, enable, 0xF, 0x5A1D);\n\tgl9750_set_pll(host, 0x1, 0x246, 0x0);\n}\n\nstatic void gl9750_set_ssc_pll_100mhz(struct sdhci_host *host)\n{\n\tbool enable = gl9750_ssc_enable(host);\n\n\t \n\tgl9750_set_ssc(host, enable, 0xE, 0x51EC);\n\tgl9750_set_pll(host, 0x1, 0x244, 0x1);\n}\n\nstatic void gl9750_set_ssc_pll_50mhz(struct sdhci_host *host)\n{\n\tbool enable = gl9750_ssc_enable(host);\n\n\t \n\tgl9750_set_ssc(host, enable, 0xE, 0x51EC);\n\tgl9750_set_pll(host, 0x1, 0x244, 0x3);\n}\n\nstatic void sdhci_gl9750_set_clock(struct sdhci_host *host, unsigned int clock)\n{\n\tstruct mmc_ios *ios = &host->mmc->ios;\n\tu16 clk;\n\n\thost->mmc->actual_clock = 0;\n\n\tgl9750_disable_ssc_pll(host);\n\tsdhci_writew(host, 0, SDHCI_CLOCK_CONTROL);\n\n\tif (clock == 0)\n\t\treturn;\n\n\tclk = sdhci_calc_clk(host, clock, &host->mmc->actual_clock);\n\tif (clock == 200000000 && ios->timing == MMC_TIMING_UHS_SDR104) {\n\t\thost->mmc->actual_clock = 205000000;\n\t\tgl9750_set_ssc_pll_205mhz(host);\n\t} else if (clock == 100000000) {\n\t\tgl9750_set_ssc_pll_100mhz(host);\n\t} else if (clock == 50000000) {\n\t\tgl9750_set_ssc_pll_50mhz(host);\n\t}\n\n\tsdhci_enable_clk(host, clk);\n}\n\nstatic void gl9750_hw_setting(struct sdhci_host *host)\n{\n\tstruct sdhci_pci_slot *slot = sdhci_priv(host);\n\tstruct pci_dev *pdev;\n\tu32 value;\n\n\tpdev = slot->chip->pdev;\n\n\tgl9750_wt_on(host);\n\n\tvalue = sdhci_readl(host, SDHCI_GLI_9750_CFG2);\n\tvalue &= ~SDHCI_GLI_9750_CFG2_L1DLY;\n\t \n\tvalue |= FIELD_PREP(SDHCI_GLI_9750_CFG2_L1DLY,\n\t\t\t    GLI_9750_CFG2_L1DLY_VALUE);\n\tsdhci_writel(host, value, SDHCI_GLI_9750_CFG2);\n\n\t \n\tpci_read_config_dword(pdev, PCI_GLI_9750_PM_CTRL, &value);\n\tvalue |= PCI_GLI_9750_PM_STATE;\n\tpci_write_config_dword(pdev, PCI_GLI_9750_PM_CTRL, value);\n\tvalue &= ~PCI_GLI_9750_PM_STATE;\n\tpci_write_config_dword(pdev, PCI_GLI_9750_PM_CTRL, value);\n\n\t \n\tpci_read_config_dword(pdev, PCI_GLI_9750_CORRERR_MASK, &value);\n\tvalue |= PCI_GLI_9750_CORRERR_MASK_REPLAY_TIMER_TIMEOUT;\n\tpci_write_config_dword(pdev, PCI_GLI_9750_CORRERR_MASK, value);\n\n\tgl9750_wt_off(host);\n}\n\nstatic void gli_pcie_enable_msi(struct sdhci_pci_slot *slot)\n{\n\tint ret;\n\n\tret = pci_alloc_irq_vectors(slot->chip->pdev, 1, 1,\n\t\t\t\t    PCI_IRQ_MSI | PCI_IRQ_MSIX);\n\tif (ret < 0) {\n\t\tpr_warn(\"%s: enable PCI MSI failed, error=%d\\n\",\n\t\t       mmc_hostname(slot->host->mmc), ret);\n\t\treturn;\n\t}\n\n\tslot->host->irq = pci_irq_vector(slot->chip->pdev, 0);\n}\n\nstatic inline void gl9755_wt_on(struct pci_dev *pdev)\n{\n\tu32 wt_value;\n\tu32 wt_enable;\n\n\tpci_read_config_dword(pdev, PCI_GLI_9755_WT, &wt_value);\n\twt_enable = FIELD_GET(PCI_GLI_9755_WT_EN, wt_value);\n\n\tif (wt_enable == GLI_9755_WT_EN_ON)\n\t\treturn;\n\n\twt_value &= ~PCI_GLI_9755_WT_EN;\n\twt_value |= FIELD_PREP(PCI_GLI_9755_WT_EN, GLI_9755_WT_EN_ON);\n\n\tpci_write_config_dword(pdev, PCI_GLI_9755_WT, wt_value);\n}\n\nstatic inline void gl9755_wt_off(struct pci_dev *pdev)\n{\n\tu32 wt_value;\n\tu32 wt_enable;\n\n\tpci_read_config_dword(pdev, PCI_GLI_9755_WT, &wt_value);\n\twt_enable = FIELD_GET(PCI_GLI_9755_WT_EN, wt_value);\n\n\tif (wt_enable == GLI_9755_WT_EN_OFF)\n\t\treturn;\n\n\twt_value &= ~PCI_GLI_9755_WT_EN;\n\twt_value |= FIELD_PREP(PCI_GLI_9755_WT_EN, GLI_9755_WT_EN_OFF);\n\n\tpci_write_config_dword(pdev, PCI_GLI_9755_WT, wt_value);\n}\n\nstatic void gl9755_disable_ssc_pll(struct pci_dev *pdev)\n{\n\tu32 pll;\n\n\tgl9755_wt_on(pdev);\n\tpci_read_config_dword(pdev, PCI_GLI_9755_PLL, &pll);\n\tpll &= ~(PCI_GLI_9755_PLL_DIR | PCI_GLI_9755_PLLSSC_EN);\n\tpci_write_config_dword(pdev, PCI_GLI_9755_PLL, pll);\n\tgl9755_wt_off(pdev);\n}\n\nstatic void gl9755_set_pll(struct pci_dev *pdev, u8 dir, u16 ldiv, u8 pdiv)\n{\n\tu32 pll;\n\n\tgl9755_wt_on(pdev);\n\tpci_read_config_dword(pdev, PCI_GLI_9755_PLL, &pll);\n\tpll &= ~(PCI_GLI_9755_PLL_LDIV |\n\t\t PCI_GLI_9755_PLL_PDIV |\n\t\t PCI_GLI_9755_PLL_DIR);\n\tpll |= FIELD_PREP(PCI_GLI_9755_PLL_LDIV, ldiv) |\n\t       FIELD_PREP(PCI_GLI_9755_PLL_PDIV, pdiv) |\n\t       FIELD_PREP(PCI_GLI_9755_PLL_DIR, dir);\n\tpci_write_config_dword(pdev, PCI_GLI_9755_PLL, pll);\n\tgl9755_wt_off(pdev);\n\n\t \n\tmdelay(1);\n}\n\nstatic bool gl9755_ssc_enable(struct pci_dev *pdev)\n{\n\tu32 misc;\n\tu8 off;\n\n\tgl9755_wt_on(pdev);\n\tpci_read_config_dword(pdev, PCI_GLI_9755_MISC, &misc);\n\toff = FIELD_GET(PCI_GLI_9755_MISC_SSC_OFF, misc);\n\tgl9755_wt_off(pdev);\n\n\treturn !off;\n}\n\nstatic void gl9755_set_ssc(struct pci_dev *pdev, u8 enable, u8 step, u16 ppm)\n{\n\tu32 pll;\n\tu32 ssc;\n\n\tgl9755_wt_on(pdev);\n\tpci_read_config_dword(pdev, PCI_GLI_9755_PLL, &pll);\n\tpci_read_config_dword(pdev, PCI_GLI_9755_PLLSSC, &ssc);\n\tpll &= ~(PCI_GLI_9755_PLLSSC_STEP |\n\t\t PCI_GLI_9755_PLLSSC_EN);\n\tssc &= ~PCI_GLI_9755_PLLSSC_PPM;\n\tpll |= FIELD_PREP(PCI_GLI_9755_PLLSSC_STEP, step) |\n\t       FIELD_PREP(PCI_GLI_9755_PLLSSC_EN, enable);\n\tssc |= FIELD_PREP(PCI_GLI_9755_PLLSSC_PPM, ppm);\n\tpci_write_config_dword(pdev, PCI_GLI_9755_PLLSSC, ssc);\n\tpci_write_config_dword(pdev, PCI_GLI_9755_PLL, pll);\n\tgl9755_wt_off(pdev);\n}\n\nstatic void gl9755_set_ssc_pll_205mhz(struct pci_dev *pdev)\n{\n\tbool enable = gl9755_ssc_enable(pdev);\n\n\t \n\tgl9755_set_ssc(pdev, enable, 0xF, 0x5A1D);\n\tgl9755_set_pll(pdev, 0x1, 0x246, 0x0);\n}\n\nstatic void gl9755_set_ssc_pll_100mhz(struct pci_dev *pdev)\n{\n\tbool enable = gl9755_ssc_enable(pdev);\n\n\t \n\tgl9755_set_ssc(pdev, enable, 0xE, 0x51EC);\n\tgl9755_set_pll(pdev, 0x1, 0x244, 0x1);\n}\n\nstatic void gl9755_set_ssc_pll_50mhz(struct pci_dev *pdev)\n{\n\tbool enable = gl9755_ssc_enable(pdev);\n\n\t \n\tgl9755_set_ssc(pdev, enable, 0xE, 0x51EC);\n\tgl9755_set_pll(pdev, 0x1, 0x244, 0x3);\n}\n\nstatic void sdhci_gl9755_set_clock(struct sdhci_host *host, unsigned int clock)\n{\n\tstruct sdhci_pci_slot *slot = sdhci_priv(host);\n\tstruct mmc_ios *ios = &host->mmc->ios;\n\tstruct pci_dev *pdev;\n\tu16 clk;\n\n\tpdev = slot->chip->pdev;\n\thost->mmc->actual_clock = 0;\n\n\tgl9755_disable_ssc_pll(pdev);\n\tsdhci_writew(host, 0, SDHCI_CLOCK_CONTROL);\n\n\tif (clock == 0)\n\t\treturn;\n\n\tclk = sdhci_calc_clk(host, clock, &host->mmc->actual_clock);\n\tif (clock == 200000000 && ios->timing == MMC_TIMING_UHS_SDR104) {\n\t\thost->mmc->actual_clock = 205000000;\n\t\tgl9755_set_ssc_pll_205mhz(pdev);\n\t} else if (clock == 100000000) {\n\t\tgl9755_set_ssc_pll_100mhz(pdev);\n\t} else if (clock == 50000000) {\n\t\tgl9755_set_ssc_pll_50mhz(pdev);\n\t}\n\n\tsdhci_enable_clk(host, clk);\n}\n\nstatic void gl9755_hw_setting(struct sdhci_pci_slot *slot)\n{\n\tstruct pci_dev *pdev = slot->chip->pdev;\n\tu32 value;\n\n\tgl9755_wt_on(pdev);\n\n\tpci_read_config_dword(pdev, PCI_GLI_9755_PECONF, &value);\n\t \n\tif (of_property_read_bool(pdev->dev.of_node, \"cd-inverted\"))\n\t\tvalue |= PCI_GLI_9755_INVERT_CD;\n\tif (of_property_read_bool(pdev->dev.of_node, \"wp-inverted\"))\n\t\tvalue |= PCI_GLI_9755_INVERT_WP;\n\tvalue &= ~PCI_GLI_9755_LFCLK;\n\tvalue &= ~PCI_GLI_9755_DMACLK;\n\tpci_write_config_dword(pdev, PCI_GLI_9755_PECONF, value);\n\n\t \n\tpci_read_config_dword(pdev, PCI_GLI_9755_SerDes, &value);\n\tvalue &= ~PCI_GLI_9755_SCP_DIS;\n\tpci_write_config_dword(pdev, PCI_GLI_9755_SerDes, value);\n\n\tpci_read_config_dword(pdev, PCI_GLI_9755_CFG2, &value);\n\tvalue &= ~PCI_GLI_9755_CFG2_L1DLY;\n\t \n\tvalue |= FIELD_PREP(PCI_GLI_9755_CFG2_L1DLY,\n\t\t\t    GLI_9755_CFG2_L1DLY_VALUE);\n\tpci_write_config_dword(pdev, PCI_GLI_9755_CFG2, value);\n\n\t \n\tpci_read_config_dword(pdev, PCI_GLI_9755_PM_CTRL, &value);\n\tvalue |= PCI_GLI_9755_PM_STATE;\n\tpci_write_config_dword(pdev, PCI_GLI_9755_PM_CTRL, value);\n\tvalue &= ~PCI_GLI_9755_PM_STATE;\n\tpci_write_config_dword(pdev, PCI_GLI_9755_PM_CTRL, value);\n\n\t \n\tpci_read_config_dword(pdev, PCI_GLI_9755_CORRERR_MASK, &value);\n\tvalue |= PCI_GLI_9755_CORRERR_MASK_REPLAY_TIMER_TIMEOUT;\n\tpci_write_config_dword(pdev, PCI_GLI_9755_CORRERR_MASK, value);\n\n\tgl9755_wt_off(pdev);\n}\n\nstatic inline void gl9767_vhs_read(struct pci_dev *pdev)\n{\n\tu32 vhs_enable;\n\tu32 vhs_value;\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_VHS, &vhs_value);\n\tvhs_enable = FIELD_GET(GLI_9767_VHS_REV, vhs_value);\n\n\tif (vhs_enable == GLI_9767_VHS_REV_R)\n\t\treturn;\n\n\tvhs_value &= ~GLI_9767_VHS_REV;\n\tvhs_value |= FIELD_PREP(GLI_9767_VHS_REV, GLI_9767_VHS_REV_R);\n\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_VHS, vhs_value);\n}\n\nstatic inline void gl9767_vhs_write(struct pci_dev *pdev)\n{\n\tu32 vhs_enable;\n\tu32 vhs_value;\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_VHS, &vhs_value);\n\tvhs_enable = FIELD_GET(GLI_9767_VHS_REV, vhs_value);\n\n\tif (vhs_enable == GLI_9767_VHS_REV_W)\n\t\treturn;\n\n\tvhs_value &= ~GLI_9767_VHS_REV;\n\tvhs_value |= FIELD_PREP(GLI_9767_VHS_REV, GLI_9767_VHS_REV_W);\n\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_VHS, vhs_value);\n}\n\nstatic bool gl9767_ssc_enable(struct pci_dev *pdev)\n{\n\tu32 value;\n\tu8 enable;\n\n\tgl9767_vhs_write(pdev);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_COM_MAILBOX, &value);\n\tenable = FIELD_GET(PCIE_GLI_9767_COM_MAILBOX_SSC_EN, value);\n\n\tgl9767_vhs_read(pdev);\n\n\treturn enable;\n}\n\nstatic void gl9767_set_ssc(struct pci_dev *pdev, u8 enable, u8 step, u16 ppm)\n{\n\tu32 pll;\n\tu32 ssc;\n\n\tgl9767_vhs_write(pdev);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_SD_PLL_CTL, &pll);\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_SD_PLL_CTL2, &ssc);\n\tpll &= ~(PCIE_GLI_9767_SD_PLL_CTL_SSC_STEP_SETTING |\n\t\t PCIE_GLI_9767_SD_PLL_CTL_SSC_EN);\n\tssc &= ~PCIE_GLI_9767_SD_PLL_CTL2_PLLSSC_PPM;\n\tpll |= FIELD_PREP(PCIE_GLI_9767_SD_PLL_CTL_SSC_STEP_SETTING, step) |\n\t       FIELD_PREP(PCIE_GLI_9767_SD_PLL_CTL_SSC_EN, enable);\n\tssc |= FIELD_PREP(PCIE_GLI_9767_SD_PLL_CTL2_PLLSSC_PPM, ppm);\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_SD_PLL_CTL2, ssc);\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_SD_PLL_CTL, pll);\n\n\tgl9767_vhs_read(pdev);\n}\n\nstatic void gl9767_set_pll(struct pci_dev *pdev, u8 dir, u16 ldiv, u8 pdiv)\n{\n\tu32 pll;\n\n\tgl9767_vhs_write(pdev);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_SD_PLL_CTL, &pll);\n\tpll &= ~(PCIE_GLI_9767_SD_PLL_CTL_PLL_LDIV |\n\t\t PCIE_GLI_9767_SD_PLL_CTL_PLL_PDIV |\n\t\t PCIE_GLI_9767_SD_PLL_CTL_PLL_DIR_EN);\n\tpll |= FIELD_PREP(PCIE_GLI_9767_SD_PLL_CTL_PLL_LDIV, ldiv) |\n\t       FIELD_PREP(PCIE_GLI_9767_SD_PLL_CTL_PLL_PDIV, pdiv) |\n\t       FIELD_PREP(PCIE_GLI_9767_SD_PLL_CTL_PLL_DIR_EN, dir);\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_SD_PLL_CTL, pll);\n\n\tgl9767_vhs_read(pdev);\n\n\t \n\tusleep_range(1000, 1100);\n}\n\nstatic void gl9767_set_ssc_pll_205mhz(struct pci_dev *pdev)\n{\n\tbool enable = gl9767_ssc_enable(pdev);\n\n\t \n\tgl9767_set_ssc(pdev, enable, 0x1F, 0xF5C3);\n\tgl9767_set_pll(pdev, 0x1, 0x246, 0x0);\n}\n\nstatic void gl9767_disable_ssc_pll(struct pci_dev *pdev)\n{\n\tu32 pll;\n\n\tgl9767_vhs_write(pdev);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_SD_PLL_CTL, &pll);\n\tpll &= ~(PCIE_GLI_9767_SD_PLL_CTL_PLL_DIR_EN | PCIE_GLI_9767_SD_PLL_CTL_SSC_EN);\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_SD_PLL_CTL, pll);\n\n\tgl9767_vhs_read(pdev);\n}\n\nstatic void sdhci_gl9767_set_clock(struct sdhci_host *host, unsigned int clock)\n{\n\tstruct sdhci_pci_slot *slot = sdhci_priv(host);\n\tstruct mmc_ios *ios = &host->mmc->ios;\n\tstruct pci_dev *pdev;\n\tu32 value;\n\tu16 clk;\n\n\tpdev = slot->chip->pdev;\n\thost->mmc->actual_clock = 0;\n\n\tgl9767_vhs_write(pdev);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_CFG, &value);\n\tvalue |= PCIE_GLI_9767_CFG_LOW_PWR_OFF;\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_CFG, value);\n\n\tgl9767_disable_ssc_pll(pdev);\n\tsdhci_writew(host, 0, SDHCI_CLOCK_CONTROL);\n\n\tif (clock == 0)\n\t\treturn;\n\n\tclk = sdhci_calc_clk(host, clock, &host->mmc->actual_clock);\n\tif (clock == 200000000 && ios->timing == MMC_TIMING_UHS_SDR104) {\n\t\thost->mmc->actual_clock = 205000000;\n\t\tgl9767_set_ssc_pll_205mhz(pdev);\n\t}\n\n\tsdhci_enable_clk(host, clk);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_CFG, &value);\n\tvalue &= ~PCIE_GLI_9767_CFG_LOW_PWR_OFF;\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_CFG, value);\n\n\tgl9767_vhs_read(pdev);\n}\n\nstatic void gli_set_9767(struct sdhci_host *host)\n{\n\tu32 value;\n\n\tvalue = sdhci_readl(host, SDHCI_GLI_9767_GM_BURST_SIZE);\n\tvalue &= ~SDHCI_GLI_9767_GM_BURST_SIZE_AXI_ALWAYS_SET;\n\tsdhci_writel(host, value, SDHCI_GLI_9767_GM_BURST_SIZE);\n}\n\nstatic void gl9767_hw_setting(struct sdhci_pci_slot *slot)\n{\n\tstruct pci_dev *pdev = slot->chip->pdev;\n\tu32 value;\n\n\tgl9767_vhs_write(pdev);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_PWR_MACRO_CTL, &value);\n\tvalue &= ~(PCIE_GLI_9767_PWR_MACRO_CTL_LOW_VOLTAGE |\n\t\t   PCIE_GLI_9767_PWR_MACRO_CTL_LD0_LOW_OUTPUT_VOLTAGE |\n\t\t   PCIE_GLI_9767_PWR_MACRO_CTL_RCLK_AMPLITUDE_CTL);\n\n\tvalue |= PCIE_GLI_9767_PWR_MACRO_CTL_LOW_VOLTAGE |\n\t\t FIELD_PREP(PCIE_GLI_9767_PWR_MACRO_CTL_LD0_LOW_OUTPUT_VOLTAGE,\n\t\t\t    PCIE_GLI_9767_PWR_MACRO_CTL_LD0_LOW_OUTPUT_VOLTAGE_VALUE) |\n\t\t FIELD_PREP(PCIE_GLI_9767_PWR_MACRO_CTL_RCLK_AMPLITUDE_CTL,\n\t\t\t    PCIE_GLI_9767_PWR_MACRO_CTL_RCLK_AMPLITUDE_CTL_VALUE);\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_PWR_MACRO_CTL, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_SCR, &value);\n\tvalue &= ~(PCIE_GLI_9767_SCR_SYSTEM_CLK_SELECT_MODE0 |\n\t\t   PCIE_GLI_9767_SCR_SYSTEM_CLK_SELECT_MODE1 |\n\t\t   PCIE_GLI_9767_SCR_CFG_RST_DATA_LINK_DOWN);\n\n\tvalue |= PCIE_GLI_9767_SCR_AUTO_AXI_W_BURST |\n\t\t PCIE_GLI_9767_SCR_AUTO_AXI_R_BURST |\n\t\t PCIE_GLI_9767_SCR_AXI_REQ |\n\t\t PCIE_GLI_9767_SCR_CARD_DET_PWR_SAVING_EN |\n\t\t PCIE_GLI_9767_SCR_CORE_PWR_D3_OFF;\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_SCR, value);\n\n\tgl9767_vhs_read(pdev);\n}\n\nstatic void sdhci_gl9767_reset(struct sdhci_host *host, u8 mask)\n{\n\tsdhci_reset(host, mask);\n\tgli_set_9767(host);\n}\n\nstatic int gl9767_init_sd_express(struct mmc_host *mmc, struct mmc_ios *ios)\n{\n\tstruct sdhci_host *host = mmc_priv(mmc);\n\tstruct sdhci_pci_slot *slot = sdhci_priv(host);\n\tstruct pci_dev *pdev;\n\tu32 value;\n\tint i;\n\n\tpdev = slot->chip->pdev;\n\n\tif (mmc->ops->get_ro(mmc)) {\n\t\tmmc->ios.timing &= ~(MMC_TIMING_SD_EXP | MMC_TIMING_SD_EXP_1_2V);\n\t\treturn 0;\n\t}\n\n\tgl9767_vhs_write(pdev);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_COMBO_MUX_CTL, &value);\n\tvalue &= ~(PCIE_GLI_9767_COMBO_MUX_CTL_RST_EN | PCIE_GLI_9767_COMBO_MUX_CTL_WAIT_PERST_EN);\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_COMBO_MUX_CTL, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_SD_DATA_MULTI_CTL, &value);\n\tvalue &= ~PCIE_GLI_9767_SD_DATA_MULTI_CTL_DISCONNECT_TIME;\n\tvalue |= FIELD_PREP(PCIE_GLI_9767_SD_DATA_MULTI_CTL_DISCONNECT_TIME,\n\t\t\t    PCIE_GLI_9767_SD_DATA_MULTI_CTL_DISCONNECT_TIME_VALUE);\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_SD_DATA_MULTI_CTL, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_REG2, &value);\n\tvalue |= PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_REG2_SDEI_COMPLETE;\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_REG2, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_EN_REG2, &value);\n\tvalue |= PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_EN_REG2_SDEI_COMPLETE_STATUS_EN;\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_EN_REG2, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_NORMAL_ERR_INT_SIGNAL_EN_REG2, &value);\n\tvalue |= PCIE_GLI_9767_NORMAL_ERR_INT_SIGNAL_EN_REG2_SDEI_COMPLETE_SIGNAL_EN;\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_NORMAL_ERR_INT_SIGNAL_EN_REG2, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_CFG, &value);\n\tvalue |= PCIE_GLI_9767_CFG_LOW_PWR_OFF;\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_CFG, value);\n\n\tvalue = sdhci_readw(host, SDHCI_CLOCK_CONTROL);\n\tvalue &= ~(SDHCI_CLOCK_CARD_EN | SDHCI_CLOCK_PLL_EN);\n\tsdhci_writew(host, value, SDHCI_CLOCK_CONTROL);\n\n\tvalue = sdhci_readb(host, SDHCI_POWER_CONTROL);\n\tvalue |= (SDHCI_VDD2_POWER_180 | SDHCI_VDD2_POWER_ON);\n\tsdhci_writeb(host, value, SDHCI_POWER_CONTROL);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_SD_EXPRESS_CTL, &value);\n\tvalue |= PCIE_GLI_9767_SD_EXPRESS_CTL_SDEI_EXE;\n\tpci_write_config_dword(pdev, PCIE_GLI_9767_SD_EXPRESS_CTL, value);\n\n\tfor (i = 0; i < 2; i++) {\n\t\tusleep_range(10000, 10100);\n\t\tpci_read_config_dword(pdev, PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_REG2, &value);\n\t\tif (value & PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_REG2_SDEI_COMPLETE) {\n\t\t\tpci_write_config_dword(pdev, PCIE_GLI_9767_NORMAL_ERR_INT_STATUS_REG2,\n\t\t\t\t\t       value);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9767_SDHC_CAP, &value);\n\tif (value & PCIE_GLI_9767_SDHC_CAP_SDEI_RESULT) {\n\t\tpci_read_config_dword(pdev, PCIE_GLI_9767_SD_EXPRESS_CTL, &value);\n\t\tvalue |= PCIE_GLI_9767_SD_EXPRESS_CTL_SD_EXPRESS_MODE;\n\t\tpci_write_config_dword(pdev, PCIE_GLI_9767_SD_EXPRESS_CTL, value);\n\t} else {\n\t\tmmc->ios.timing &= ~(MMC_TIMING_SD_EXP | MMC_TIMING_SD_EXP_1_2V);\n\n\t\tvalue = sdhci_readb(host, SDHCI_POWER_CONTROL);\n\t\tvalue &= ~(SDHCI_VDD2_POWER_180 | SDHCI_VDD2_POWER_ON);\n\t\tsdhci_writeb(host, value, SDHCI_POWER_CONTROL);\n\n\t\tvalue = sdhci_readw(host, SDHCI_CLOCK_CONTROL);\n\t\tvalue |= (SDHCI_CLOCK_CARD_EN | SDHCI_CLOCK_PLL_EN);\n\t\tsdhci_writew(host, value, SDHCI_CLOCK_CONTROL);\n\t}\n\n\tgl9767_vhs_read(pdev);\n\n\treturn 0;\n}\n\nstatic int gli_probe_slot_gl9750(struct sdhci_pci_slot *slot)\n{\n\tstruct sdhci_host *host = slot->host;\n\n\tgl9750_hw_setting(host);\n\tgli_pcie_enable_msi(slot);\n\tslot->host->mmc->caps2 |= MMC_CAP2_NO_SDIO;\n\tsdhci_enable_v4_mode(host);\n\n\treturn 0;\n}\n\nstatic int gli_probe_slot_gl9755(struct sdhci_pci_slot *slot)\n{\n\tstruct sdhci_host *host = slot->host;\n\n\tgl9755_hw_setting(slot);\n\tgli_pcie_enable_msi(slot);\n\tslot->host->mmc->caps2 |= MMC_CAP2_NO_SDIO;\n\tsdhci_enable_v4_mode(host);\n\n\treturn 0;\n}\n\nstatic int gli_probe_slot_gl9767(struct sdhci_pci_slot *slot)\n{\n\tstruct sdhci_host *host = slot->host;\n\n\tgli_set_9767(host);\n\tgl9767_hw_setting(slot);\n\tgli_pcie_enable_msi(slot);\n\tslot->host->mmc->caps2 |= MMC_CAP2_NO_SDIO;\n\thost->mmc->caps2 |= MMC_CAP2_SD_EXP;\n\thost->mmc_host_ops.init_sd_express = gl9767_init_sd_express;\n\tsdhci_enable_v4_mode(host);\n\n\treturn 0;\n}\n\nstatic void sdhci_gli_voltage_switch(struct sdhci_host *host)\n{\n\t \n\tusleep_range(100000, 110000);\n}\n\nstatic void sdhci_gl9767_voltage_switch(struct sdhci_host *host)\n{\n\t \n\tusleep_range(5000, 5500);\n}\n\nstatic void sdhci_gl9750_reset(struct sdhci_host *host, u8 mask)\n{\n\tsdhci_reset(host, mask);\n\tgli_set_9750(host);\n}\n\nstatic u32 sdhci_gl9750_readl(struct sdhci_host *host, int reg)\n{\n\tu32 value;\n\n\tvalue = readl(host->ioaddr + reg);\n\tif (unlikely(reg == SDHCI_MAX_CURRENT && !(value & 0xff)))\n\t\tvalue |= 0xc8;\n\n\treturn value;\n}\n\nstatic void gl9763e_hs400_enhanced_strobe(struct mmc_host *mmc,\n\t\t\t\t\t  struct mmc_ios *ios)\n{\n\tstruct sdhci_host *host = mmc_priv(mmc);\n\tu32 val;\n\n\tval = sdhci_readl(host, SDHCI_GLI_9763E_HS400_ES_REG);\n\tif (ios->enhanced_strobe)\n\t\tval |= SDHCI_GLI_9763E_HS400_ES_BIT;\n\telse\n\t\tval &= ~SDHCI_GLI_9763E_HS400_ES_BIT;\n\n\tsdhci_writel(host, val, SDHCI_GLI_9763E_HS400_ES_REG);\n}\n\nstatic void gl9763e_set_low_power_negotiation(struct sdhci_pci_slot *slot,\n\t\t\t\t\t      bool enable)\n{\n\tstruct pci_dev *pdev = slot->chip->pdev;\n\tu32 value;\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9763E_VHS, &value);\n\tvalue &= ~GLI_9763E_VHS_REV;\n\tvalue |= FIELD_PREP(GLI_9763E_VHS_REV, GLI_9763E_VHS_REV_W);\n\tpci_write_config_dword(pdev, PCIE_GLI_9763E_VHS, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9763E_CFG, &value);\n\n\tif (enable)\n\t\tvalue &= ~GLI_9763E_CFG_LPSN_DIS;\n\telse\n\t\tvalue |= GLI_9763E_CFG_LPSN_DIS;\n\n\tpci_write_config_dword(pdev, PCIE_GLI_9763E_CFG, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9763E_VHS, &value);\n\tvalue &= ~GLI_9763E_VHS_REV;\n\tvalue |= FIELD_PREP(GLI_9763E_VHS_REV, GLI_9763E_VHS_REV_R);\n\tpci_write_config_dword(pdev, PCIE_GLI_9763E_VHS, value);\n}\n\nstatic void sdhci_set_gl9763e_signaling(struct sdhci_host *host,\n\t\t\t\t\tunsigned int timing)\n{\n\tu16 ctrl_2;\n\n\tctrl_2 = sdhci_readw(host, SDHCI_HOST_CONTROL2);\n\tctrl_2 &= ~SDHCI_CTRL_UHS_MASK;\n\tif (timing == MMC_TIMING_MMC_HS200)\n\t\tctrl_2 |= SDHCI_CTRL_UHS_SDR104;\n\telse if (timing == MMC_TIMING_MMC_HS)\n\t\tctrl_2 |= SDHCI_CTRL_UHS_SDR25;\n\telse if (timing == MMC_TIMING_MMC_DDR52)\n\t\tctrl_2 |= SDHCI_CTRL_UHS_DDR50;\n\telse if (timing == MMC_TIMING_MMC_HS400)\n\t\tctrl_2 |= SDHCI_GLI_9763E_CTRL_HS400;\n\n\tsdhci_writew(host, ctrl_2, SDHCI_HOST_CONTROL2);\n}\n\nstatic void sdhci_gl9763e_dumpregs(struct mmc_host *mmc)\n{\n\tsdhci_dumpregs(mmc_priv(mmc));\n}\n\nstatic void sdhci_gl9763e_cqe_pre_enable(struct mmc_host *mmc)\n{\n\tstruct cqhci_host *cq_host = mmc->cqe_private;\n\tu32 value;\n\n\tvalue = cqhci_readl(cq_host, CQHCI_CFG);\n\tvalue |= CQHCI_ENABLE;\n\tcqhci_writel(cq_host, value, CQHCI_CFG);\n}\n\nstatic void sdhci_gl9763e_cqe_enable(struct mmc_host *mmc)\n{\n\tstruct sdhci_host *host = mmc_priv(mmc);\n\n\tsdhci_writew(host, GLI_9763E_CQE_TRNS_MODE, SDHCI_TRANSFER_MODE);\n\tsdhci_cqe_enable(mmc);\n}\n\nstatic u32 sdhci_gl9763e_cqhci_irq(struct sdhci_host *host, u32 intmask)\n{\n\tint cmd_error = 0;\n\tint data_error = 0;\n\n\tif (!sdhci_cqe_irq(host, intmask, &cmd_error, &data_error))\n\t\treturn intmask;\n\n\tcqhci_irq(host->mmc, intmask, cmd_error, data_error);\n\n\treturn 0;\n}\n\nstatic void sdhci_gl9763e_cqe_post_disable(struct mmc_host *mmc)\n{\n\tstruct sdhci_host *host = mmc_priv(mmc);\n\tstruct cqhci_host *cq_host = mmc->cqe_private;\n\tu32 value;\n\n\tvalue = cqhci_readl(cq_host, CQHCI_CFG);\n\tvalue &= ~CQHCI_ENABLE;\n\tcqhci_writel(cq_host, value, CQHCI_CFG);\n\tsdhci_writew(host, 0x0, SDHCI_TRANSFER_MODE);\n}\n\nstatic const struct cqhci_host_ops sdhci_gl9763e_cqhci_ops = {\n\t.enable         = sdhci_gl9763e_cqe_enable,\n\t.disable        = sdhci_cqe_disable,\n\t.dumpregs       = sdhci_gl9763e_dumpregs,\n\t.pre_enable     = sdhci_gl9763e_cqe_pre_enable,\n\t.post_disable   = sdhci_gl9763e_cqe_post_disable,\n};\n\nstatic int gl9763e_add_host(struct sdhci_pci_slot *slot)\n{\n\tstruct device *dev = &slot->chip->pdev->dev;\n\tstruct sdhci_host *host = slot->host;\n\tstruct cqhci_host *cq_host;\n\tbool dma64;\n\tint ret;\n\n\tret = sdhci_setup_host(host);\n\tif (ret)\n\t\treturn ret;\n\n\tcq_host = devm_kzalloc(dev, sizeof(*cq_host), GFP_KERNEL);\n\tif (!cq_host) {\n\t\tret = -ENOMEM;\n\t\tgoto cleanup;\n\t}\n\n\tcq_host->mmio = host->ioaddr + SDHCI_GLI_9763E_CQE_BASE_ADDR;\n\tcq_host->ops = &sdhci_gl9763e_cqhci_ops;\n\n\tdma64 = host->flags & SDHCI_USE_64_BIT_DMA;\n\tif (dma64)\n\t\tcq_host->caps |= CQHCI_TASK_DESC_SZ_128;\n\n\tret = cqhci_init(cq_host, host->mmc, dma64);\n\tif (ret)\n\t\tgoto cleanup;\n\n\tret = __sdhci_add_host(host);\n\tif (ret)\n\t\tgoto cleanup;\n\n\t \n\tgl9763e_set_low_power_negotiation(slot, false);\n\n\treturn 0;\n\ncleanup:\n\tsdhci_cleanup_host(host);\n\treturn ret;\n}\n\nstatic void gli_set_gl9763e(struct sdhci_pci_slot *slot)\n{\n\tstruct pci_dev *pdev = slot->chip->pdev;\n\tu32 value;\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9763E_VHS, &value);\n\tvalue &= ~GLI_9763E_VHS_REV;\n\tvalue |= FIELD_PREP(GLI_9763E_VHS_REV, GLI_9763E_VHS_REV_W);\n\tpci_write_config_dword(pdev, PCIE_GLI_9763E_VHS, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9763E_SCR, &value);\n\tvalue |= GLI_9763E_SCR_AXI_REQ;\n\tpci_write_config_dword(pdev, PCIE_GLI_9763E_SCR, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9763E_MMC_CTRL, &value);\n\tvalue &= ~GLI_9763E_HS400_SLOW;\n\tpci_write_config_dword(pdev, PCIE_GLI_9763E_MMC_CTRL, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9763E_CFG2, &value);\n\tvalue &= ~GLI_9763E_CFG2_L1DLY;\n\t \n\tvalue |= FIELD_PREP(GLI_9763E_CFG2_L1DLY, GLI_9763E_CFG2_L1DLY_MID);\n\tpci_write_config_dword(pdev, PCIE_GLI_9763E_CFG2, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9763E_CLKRXDLY, &value);\n\tvalue &= ~GLI_9763E_HS400_RXDLY;\n\tvalue |= FIELD_PREP(GLI_9763E_HS400_RXDLY, GLI_9763E_HS400_RXDLY_5);\n\tpci_write_config_dword(pdev, PCIE_GLI_9763E_CLKRXDLY, value);\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9763E_VHS, &value);\n\tvalue &= ~GLI_9763E_VHS_REV;\n\tvalue |= FIELD_PREP(GLI_9763E_VHS_REV, GLI_9763E_VHS_REV_R);\n\tpci_write_config_dword(pdev, PCIE_GLI_9763E_VHS, value);\n}\n\n#ifdef CONFIG_PM\nstatic int gl9763e_runtime_suspend(struct sdhci_pci_chip *chip)\n{\n\tstruct sdhci_pci_slot *slot = chip->slots[0];\n\tstruct sdhci_host *host = slot->host;\n\tu16 clock;\n\n\t \n\tgl9763e_set_low_power_negotiation(slot, true);\n\n\tclock = sdhci_readw(host, SDHCI_CLOCK_CONTROL);\n\tclock &= ~(SDHCI_CLOCK_PLL_EN | SDHCI_CLOCK_CARD_EN);\n\tsdhci_writew(host, clock, SDHCI_CLOCK_CONTROL);\n\n\treturn 0;\n}\n\nstatic int gl9763e_runtime_resume(struct sdhci_pci_chip *chip)\n{\n\tstruct sdhci_pci_slot *slot = chip->slots[0];\n\tstruct sdhci_host *host = slot->host;\n\tu16 clock;\n\n\tif (host->mmc->ios.power_mode != MMC_POWER_ON)\n\t\treturn 0;\n\n\tclock = sdhci_readw(host, SDHCI_CLOCK_CONTROL);\n\n\tclock |= SDHCI_CLOCK_PLL_EN;\n\tclock &= ~SDHCI_CLOCK_INT_STABLE;\n\tsdhci_writew(host, clock, SDHCI_CLOCK_CONTROL);\n\n\t \n\tif (read_poll_timeout(sdhci_readw, clock, (clock & SDHCI_CLOCK_INT_STABLE),\n\t\t\t      1000, 150000, false, host, SDHCI_CLOCK_CONTROL)) {\n\t\tpr_err(\"%s: PLL clock never stabilised.\\n\",\n\t\t       mmc_hostname(host->mmc));\n\t\tsdhci_dumpregs(host);\n\t}\n\n\tclock |= SDHCI_CLOCK_CARD_EN;\n\tsdhci_writew(host, clock, SDHCI_CLOCK_CONTROL);\n\n\t \n\tgl9763e_set_low_power_negotiation(slot, false);\n\n\treturn 0;\n}\n#endif\n\n#ifdef CONFIG_PM_SLEEP\nstatic int sdhci_pci_gli_resume(struct sdhci_pci_chip *chip)\n{\n\tstruct sdhci_pci_slot *slot = chip->slots[0];\n\n\tpci_free_irq_vectors(slot->chip->pdev);\n\tgli_pcie_enable_msi(slot);\n\n\treturn sdhci_pci_resume_host(chip);\n}\n\nstatic int gl9763e_resume(struct sdhci_pci_chip *chip)\n{\n\tstruct sdhci_pci_slot *slot = chip->slots[0];\n\tint ret;\n\n\tret = sdhci_pci_gli_resume(chip);\n\tif (ret)\n\t\treturn ret;\n\n\tret = cqhci_resume(slot->host->mmc);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tgl9763e_set_low_power_negotiation(slot, false);\n\n\treturn 0;\n}\n\nstatic int gl9763e_suspend(struct sdhci_pci_chip *chip)\n{\n\tstruct sdhci_pci_slot *slot = chip->slots[0];\n\tint ret;\n\n\t \n\tgl9763e_set_low_power_negotiation(slot, true);\n\n\tret = cqhci_suspend(slot->host->mmc);\n\tif (ret)\n\t\tgoto err_suspend;\n\n\tret = sdhci_suspend_host(slot->host);\n\tif (ret)\n\t\tgoto err_suspend_host;\n\n\treturn 0;\n\nerr_suspend_host:\n\tcqhci_resume(slot->host->mmc);\nerr_suspend:\n\tgl9763e_set_low_power_negotiation(slot, false);\n\treturn ret;\n}\n#endif\n\nstatic int gli_probe_slot_gl9763e(struct sdhci_pci_slot *slot)\n{\n\tstruct pci_dev *pdev = slot->chip->pdev;\n\tstruct sdhci_host *host = slot->host;\n\tu32 value;\n\n\thost->mmc->caps |= MMC_CAP_8_BIT_DATA |\n\t\t\t   MMC_CAP_1_8V_DDR |\n\t\t\t   MMC_CAP_NONREMOVABLE;\n\thost->mmc->caps2 |= MMC_CAP2_HS200_1_8V_SDR |\n\t\t\t    MMC_CAP2_HS400_1_8V |\n\t\t\t    MMC_CAP2_HS400_ES |\n\t\t\t    MMC_CAP2_NO_SDIO |\n\t\t\t    MMC_CAP2_NO_SD;\n\n\tpci_read_config_dword(pdev, PCIE_GLI_9763E_MB, &value);\n\tif (!(value & GLI_9763E_MB_CMDQ_OFF))\n\t\tif (value & GLI_9763E_MB_ERP_ON)\n\t\t\thost->mmc->caps2 |= MMC_CAP2_CQE | MMC_CAP2_CQE_DCMD;\n\n\tgli_pcie_enable_msi(slot);\n\thost->mmc_host_ops.hs400_enhanced_strobe =\n\t\t\t\t\tgl9763e_hs400_enhanced_strobe;\n\tgli_set_gl9763e(slot);\n\tsdhci_enable_v4_mode(host);\n\n\treturn 0;\n}\n\n#define REG_OFFSET_IN_BITS(reg) ((reg) << 3 & 0x18)\n\nstatic u16 sdhci_gli_readw(struct sdhci_host *host, int reg)\n{\n\tu32 val = readl(host->ioaddr + (reg & ~3));\n\tu16 word;\n\n\tword = (val >> REG_OFFSET_IN_BITS(reg)) & 0xffff;\n\treturn word;\n}\n\nstatic u8 sdhci_gli_readb(struct sdhci_host *host, int reg)\n{\n\tu32 val = readl(host->ioaddr + (reg & ~3));\n\tu8 byte = (val >> REG_OFFSET_IN_BITS(reg)) & 0xff;\n\n\treturn byte;\n}\n\nstatic const struct sdhci_ops sdhci_gl9755_ops = {\n\t.read_w\t\t\t= sdhci_gli_readw,\n\t.read_b\t\t\t= sdhci_gli_readb,\n\t.set_clock\t\t= sdhci_gl9755_set_clock,\n\t.enable_dma\t\t= sdhci_pci_enable_dma,\n\t.set_bus_width\t\t= sdhci_set_bus_width,\n\t.reset\t\t\t= sdhci_reset,\n\t.set_uhs_signaling\t= sdhci_set_uhs_signaling,\n\t.voltage_switch\t\t= sdhci_gli_voltage_switch,\n};\n\nconst struct sdhci_pci_fixes sdhci_gl9755 = {\n\t.quirks\t\t= SDHCI_QUIRK_NO_ENDATTR_IN_NOPDESC,\n\t.quirks2\t= SDHCI_QUIRK2_BROKEN_DDR50,\n\t.probe_slot\t= gli_probe_slot_gl9755,\n\t.ops            = &sdhci_gl9755_ops,\n#ifdef CONFIG_PM_SLEEP\n\t.resume         = sdhci_pci_gli_resume,\n#endif\n};\n\nstatic const struct sdhci_ops sdhci_gl9750_ops = {\n\t.read_w\t\t\t= sdhci_gli_readw,\n\t.read_b\t\t\t= sdhci_gli_readb,\n\t.read_l                 = sdhci_gl9750_readl,\n\t.set_clock\t\t= sdhci_gl9750_set_clock,\n\t.enable_dma\t\t= sdhci_pci_enable_dma,\n\t.set_bus_width\t\t= sdhci_set_bus_width,\n\t.reset\t\t\t= sdhci_gl9750_reset,\n\t.set_uhs_signaling\t= sdhci_set_uhs_signaling,\n\t.voltage_switch\t\t= sdhci_gli_voltage_switch,\n\t.platform_execute_tuning = gl9750_execute_tuning,\n};\n\nconst struct sdhci_pci_fixes sdhci_gl9750 = {\n\t.quirks\t\t= SDHCI_QUIRK_NO_ENDATTR_IN_NOPDESC,\n\t.quirks2\t= SDHCI_QUIRK2_BROKEN_DDR50,\n\t.probe_slot\t= gli_probe_slot_gl9750,\n\t.ops            = &sdhci_gl9750_ops,\n#ifdef CONFIG_PM_SLEEP\n\t.resume         = sdhci_pci_gli_resume,\n#endif\n};\n\nstatic const struct sdhci_ops sdhci_gl9763e_ops = {\n\t.set_clock\t\t= sdhci_set_clock,\n\t.enable_dma\t\t= sdhci_pci_enable_dma,\n\t.set_bus_width\t\t= sdhci_set_bus_width,\n\t.reset\t\t\t= sdhci_and_cqhci_reset,\n\t.set_uhs_signaling\t= sdhci_set_gl9763e_signaling,\n\t.voltage_switch\t\t= sdhci_gli_voltage_switch,\n\t.irq                    = sdhci_gl9763e_cqhci_irq,\n};\n\nconst struct sdhci_pci_fixes sdhci_gl9763e = {\n\t.quirks\t\t= SDHCI_QUIRK_NO_ENDATTR_IN_NOPDESC,\n\t.probe_slot\t= gli_probe_slot_gl9763e,\n\t.ops            = &sdhci_gl9763e_ops,\n#ifdef CONFIG_PM_SLEEP\n\t.resume\t\t= gl9763e_resume,\n\t.suspend\t= gl9763e_suspend,\n#endif\n#ifdef CONFIG_PM\n\t.runtime_suspend = gl9763e_runtime_suspend,\n\t.runtime_resume  = gl9763e_runtime_resume,\n\t.allow_runtime_pm = true,\n#endif\n\t.add_host       = gl9763e_add_host,\n};\n\nstatic const struct sdhci_ops sdhci_gl9767_ops = {\n\t.set_clock\t\t = sdhci_gl9767_set_clock,\n\t.enable_dma\t\t = sdhci_pci_enable_dma,\n\t.set_bus_width\t\t = sdhci_set_bus_width,\n\t.reset\t\t\t = sdhci_gl9767_reset,\n\t.set_uhs_signaling\t = sdhci_set_uhs_signaling,\n\t.voltage_switch\t\t = sdhci_gl9767_voltage_switch,\n};\n\nconst struct sdhci_pci_fixes sdhci_gl9767 = {\n\t.quirks\t\t= SDHCI_QUIRK_NO_ENDATTR_IN_NOPDESC,\n\t.quirks2\t= SDHCI_QUIRK2_BROKEN_DDR50,\n\t.probe_slot\t= gli_probe_slot_gl9767,\n\t.ops\t\t= &sdhci_gl9767_ops,\n#ifdef CONFIG_PM_SLEEP\n\t.resume\t\t= sdhci_pci_gli_resume,\n#endif\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}