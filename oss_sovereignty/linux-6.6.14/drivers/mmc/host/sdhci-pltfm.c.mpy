{
  "module_name": "sdhci-pltfm.c",
  "hash_id": "f294a03c323d05c1bf4dd4fe4367fd96843795caeaf5c211d0254b73dde97448",
  "original_prompt": "Ingested from linux-6.6.14/drivers/mmc/host/sdhci-pltfm.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/err.h>\n#include <linux/module.h>\n#include <linux/property.h>\n#include <linux/of.h>\n#ifdef CONFIG_PPC\n#include <asm/machdep.h>\n#endif\n#include \"sdhci-pltfm.h\"\n\nunsigned int sdhci_pltfm_clk_get_max_clock(struct sdhci_host *host)\n{\n\tstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\n\n\treturn clk_get_rate(pltfm_host->clk);\n}\nEXPORT_SYMBOL_GPL(sdhci_pltfm_clk_get_max_clock);\n\nstatic const struct sdhci_ops sdhci_pltfm_ops = {\n\t.set_clock = sdhci_set_clock,\n\t.set_bus_width = sdhci_set_bus_width,\n\t.reset = sdhci_reset,\n\t.set_uhs_signaling = sdhci_set_uhs_signaling,\n};\n\nstatic bool sdhci_wp_inverted(struct device *dev)\n{\n\tif (device_property_present(dev, \"sdhci,wp-inverted\") ||\n\t    device_property_present(dev, \"wp-inverted\"))\n\t\treturn true;\n\n\t \n#ifdef CONFIG_PPC\n\treturn machine_is(mpc837x_rdb) || machine_is(mpc837x_mds);\n#else\n\treturn false;\n#endif  \n}\n\nstatic void sdhci_get_compatibility(struct platform_device *pdev)\n{\n\tstruct sdhci_host *host = platform_get_drvdata(pdev);\n\tstruct device_node *np = pdev->dev.of_node;\n\n\tif (!np)\n\t\treturn;\n\n\tif (of_device_is_compatible(np, \"fsl,p2020-rev1-esdhc\"))\n\t\thost->quirks |= SDHCI_QUIRK_BROKEN_DMA;\n\n\tif (of_device_is_compatible(np, \"fsl,p2020-esdhc\") ||\n\t    of_device_is_compatible(np, \"fsl,p1010-esdhc\") ||\n\t    of_device_is_compatible(np, \"fsl,t4240-esdhc\") ||\n\t    of_device_is_compatible(np, \"fsl,mpc8536-esdhc\"))\n\t\thost->quirks |= SDHCI_QUIRK_BROKEN_TIMEOUT_VAL;\n}\n\nvoid sdhci_get_property(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct sdhci_host *host = platform_get_drvdata(pdev);\n\tstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\n\tu32 bus_width;\n\n\tif (device_property_present(dev, \"sdhci,auto-cmd12\"))\n\t\thost->quirks |= SDHCI_QUIRK_MULTIBLOCK_READ_ACMD12;\n\n\tif (device_property_present(dev, \"sdhci,1-bit-only\") ||\n\t    (device_property_read_u32(dev, \"bus-width\", &bus_width) == 0 &&\n\t    bus_width == 1))\n\t\thost->quirks |= SDHCI_QUIRK_FORCE_1_BIT_DATA;\n\n\tif (sdhci_wp_inverted(dev))\n\t\thost->quirks |= SDHCI_QUIRK_INVERTED_WRITE_PROTECT;\n\n\tif (device_property_present(dev, \"broken-cd\"))\n\t\thost->quirks |= SDHCI_QUIRK_BROKEN_CARD_DETECTION;\n\n\tif (device_property_present(dev, \"no-1-8-v\"))\n\t\thost->quirks2 |= SDHCI_QUIRK2_NO_1_8_V;\n\n\tsdhci_get_compatibility(pdev);\n\n\tdevice_property_read_u32(dev, \"clock-frequency\", &pltfm_host->clock);\n\n\tif (device_property_present(dev, \"keep-power-in-suspend\"))\n\t\thost->mmc->pm_caps |= MMC_PM_KEEP_POWER;\n\n\tif (device_property_read_bool(dev, \"wakeup-source\") ||\n\t    device_property_read_bool(dev, \"enable-sdio-wakeup\"))  \n\t\thost->mmc->pm_caps |= MMC_PM_WAKE_SDIO_IRQ;\n}\nEXPORT_SYMBOL_GPL(sdhci_get_property);\n\nstruct sdhci_host *sdhci_pltfm_init(struct platform_device *pdev,\n\t\t\t\t    const struct sdhci_pltfm_data *pdata,\n\t\t\t\t    size_t priv_size)\n{\n\tstruct sdhci_host *host;\n\tvoid __iomem *ioaddr;\n\tint irq, ret;\n\n\tioaddr = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(ioaddr)) {\n\t\tret = PTR_ERR(ioaddr);\n\t\tgoto err;\n\t}\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0) {\n\t\tret = irq;\n\t\tgoto err;\n\t}\n\n\thost = sdhci_alloc_host(&pdev->dev,\n\t\tsizeof(struct sdhci_pltfm_host) + priv_size);\n\n\tif (IS_ERR(host)) {\n\t\tret = PTR_ERR(host);\n\t\tgoto err;\n\t}\n\n\thost->ioaddr = ioaddr;\n\thost->irq = irq;\n\thost->hw_name = dev_name(&pdev->dev);\n\tif (pdata && pdata->ops)\n\t\thost->ops = pdata->ops;\n\telse\n\t\thost->ops = &sdhci_pltfm_ops;\n\tif (pdata) {\n\t\thost->quirks = pdata->quirks;\n\t\thost->quirks2 = pdata->quirks2;\n\t}\n\n\tplatform_set_drvdata(pdev, host);\n\n\treturn host;\nerr:\n\tdev_err(&pdev->dev, \"%s failed %d\\n\", __func__, ret);\n\treturn ERR_PTR(ret);\n}\nEXPORT_SYMBOL_GPL(sdhci_pltfm_init);\n\nvoid sdhci_pltfm_free(struct platform_device *pdev)\n{\n\tstruct sdhci_host *host = platform_get_drvdata(pdev);\n\n\tsdhci_free_host(host);\n}\nEXPORT_SYMBOL_GPL(sdhci_pltfm_free);\n\nint sdhci_pltfm_init_and_add_host(struct platform_device *pdev,\n\t\t\t\t  const struct sdhci_pltfm_data *pdata,\n\t\t\t\t  size_t priv_size)\n{\n\tstruct sdhci_host *host;\n\tint ret = 0;\n\n\thost = sdhci_pltfm_init(pdev, pdata, priv_size);\n\tif (IS_ERR(host))\n\t\treturn PTR_ERR(host);\n\n\tsdhci_get_property(pdev);\n\n\tret = sdhci_add_host(host);\n\tif (ret)\n\t\tsdhci_pltfm_free(pdev);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(sdhci_pltfm_init_and_add_host);\n\nvoid sdhci_pltfm_remove(struct platform_device *pdev)\n{\n\tstruct sdhci_host *host = platform_get_drvdata(pdev);\n\tint dead = (readl(host->ioaddr + SDHCI_INT_STATUS) == 0xffffffff);\n\n\tsdhci_remove_host(host, dead);\n\tsdhci_pltfm_free(pdev);\n}\nEXPORT_SYMBOL_GPL(sdhci_pltfm_remove);\n\n#ifdef CONFIG_PM_SLEEP\nint sdhci_pltfm_suspend(struct device *dev)\n{\n\tstruct sdhci_host *host = dev_get_drvdata(dev);\n\tstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\n\tint ret;\n\n\tif (host->tuning_mode != SDHCI_TUNING_MODE_3)\n\t\tmmc_retune_needed(host->mmc);\n\n\tret = sdhci_suspend_host(host);\n\tif (ret)\n\t\treturn ret;\n\n\tclk_disable_unprepare(pltfm_host->clk);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(sdhci_pltfm_suspend);\n\nint sdhci_pltfm_resume(struct device *dev)\n{\n\tstruct sdhci_host *host = dev_get_drvdata(dev);\n\tstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\n\tint ret;\n\n\tret = clk_prepare_enable(pltfm_host->clk);\n\tif (ret)\n\t\treturn ret;\n\n\tret = sdhci_resume_host(host);\n\tif (ret)\n\t\tclk_disable_unprepare(pltfm_host->clk);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(sdhci_pltfm_resume);\n#endif\n\nconst struct dev_pm_ops sdhci_pltfm_pmops = {\n\tSET_SYSTEM_SLEEP_PM_OPS(sdhci_pltfm_suspend, sdhci_pltfm_resume)\n};\nEXPORT_SYMBOL_GPL(sdhci_pltfm_pmops);\n\nstatic int __init sdhci_pltfm_drv_init(void)\n{\n\tpr_info(\"sdhci-pltfm: SDHCI platform and OF driver helper\\n\");\n\n\treturn 0;\n}\nmodule_init(sdhci_pltfm_drv_init);\n\nstatic void __exit sdhci_pltfm_drv_exit(void)\n{\n}\nmodule_exit(sdhci_pltfm_drv_exit);\n\nMODULE_DESCRIPTION(\"SDHCI platform and OF driver helper\");\nMODULE_AUTHOR(\"Intel Corporation\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}