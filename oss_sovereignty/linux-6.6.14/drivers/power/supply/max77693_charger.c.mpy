{
  "module_name": "max77693_charger.c",
  "hash_id": "a83d8576c38336098b37be5fcf246b6590478008b8843a64273af6f6348d3eee",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/max77693_charger.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/regmap.h>\n#include <linux/mfd/max77693.h>\n#include <linux/mfd/max77693-common.h>\n#include <linux/mfd/max77693-private.h>\n\n#define MAX77693_CHARGER_NAME\t\t\t\t\"max77693-charger\"\nstatic const char *max77693_charger_model\t\t= \"MAX77693\";\nstatic const char *max77693_charger_manufacturer\t= \"Maxim Integrated\";\n\nstruct max77693_charger {\n\tstruct device\t\t*dev;\n\tstruct max77693_dev\t*max77693;\n\tstruct power_supply\t*charger;\n\n\tu32 constant_volt;\n\tu32 min_system_volt;\n\tu32 thermal_regulation_temp;\n\tu32 batttery_overcurrent;\n\tu32 charge_input_threshold_volt;\n};\n\nstatic int max77693_get_charger_state(struct regmap *regmap, int *val)\n{\n\tint ret;\n\tunsigned int data;\n\n\tret = regmap_read(regmap, MAX77693_CHG_REG_CHG_DETAILS_01, &data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata &= CHG_DETAILS_01_CHG_MASK;\n\tdata >>= CHG_DETAILS_01_CHG_SHIFT;\n\n\tswitch (data) {\n\tcase MAX77693_CHARGING_PREQUALIFICATION:\n\tcase MAX77693_CHARGING_FAST_CONST_CURRENT:\n\tcase MAX77693_CHARGING_FAST_CONST_VOLTAGE:\n\tcase MAX77693_CHARGING_TOP_OFF:\n\t \n\tcase MAX77693_CHARGING_HIGH_TEMP:\n\t\t*val = POWER_SUPPLY_STATUS_CHARGING;\n\t\tbreak;\n\tcase MAX77693_CHARGING_DONE:\n\t\t*val = POWER_SUPPLY_STATUS_FULL;\n\t\tbreak;\n\tcase MAX77693_CHARGING_TIMER_EXPIRED:\n\tcase MAX77693_CHARGING_THERMISTOR_SUSPEND:\n\t\t*val = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\tbreak;\n\tcase MAX77693_CHARGING_OFF:\n\tcase MAX77693_CHARGING_OVER_TEMP:\n\tcase MAX77693_CHARGING_WATCHDOG_EXPIRED:\n\t\t*val = POWER_SUPPLY_STATUS_DISCHARGING;\n\t\tbreak;\n\tcase MAX77693_CHARGING_RESERVED:\n\tdefault:\n\t\t*val = POWER_SUPPLY_STATUS_UNKNOWN;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77693_get_charge_type(struct regmap *regmap, int *val)\n{\n\tint ret;\n\tunsigned int data;\n\n\tret = regmap_read(regmap, MAX77693_CHG_REG_CHG_DETAILS_01, &data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata &= CHG_DETAILS_01_CHG_MASK;\n\tdata >>= CHG_DETAILS_01_CHG_SHIFT;\n\n\tswitch (data) {\n\tcase MAX77693_CHARGING_PREQUALIFICATION:\n\t \n\tcase MAX77693_CHARGING_TOP_OFF:\n\t\t*val = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\n\t\tbreak;\n\tcase MAX77693_CHARGING_FAST_CONST_CURRENT:\n\tcase MAX77693_CHARGING_FAST_CONST_VOLTAGE:\n\t \n\tcase MAX77693_CHARGING_HIGH_TEMP:\n\t\t*val = POWER_SUPPLY_CHARGE_TYPE_FAST;\n\t\tbreak;\n\tcase MAX77693_CHARGING_DONE:\n\tcase MAX77693_CHARGING_TIMER_EXPIRED:\n\tcase MAX77693_CHARGING_THERMISTOR_SUSPEND:\n\tcase MAX77693_CHARGING_OFF:\n\tcase MAX77693_CHARGING_OVER_TEMP:\n\tcase MAX77693_CHARGING_WATCHDOG_EXPIRED:\n\t\t*val = POWER_SUPPLY_CHARGE_TYPE_NONE;\n\t\tbreak;\n\tcase MAX77693_CHARGING_RESERVED:\n\tdefault:\n\t\t*val = POWER_SUPPLY_CHARGE_TYPE_UNKNOWN;\n\t}\n\n\treturn 0;\n}\n\n \nstatic int max77693_get_battery_health(struct regmap *regmap, int *val)\n{\n\tint ret;\n\tunsigned int data;\n\n\tret = regmap_read(regmap, MAX77693_CHG_REG_CHG_DETAILS_01, &data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata &= CHG_DETAILS_01_BAT_MASK;\n\tdata >>= CHG_DETAILS_01_BAT_SHIFT;\n\n\tswitch (data) {\n\tcase MAX77693_BATTERY_NOBAT:\n\t\t*val = POWER_SUPPLY_HEALTH_DEAD;\n\t\tbreak;\n\tcase MAX77693_BATTERY_PREQUALIFICATION:\n\tcase MAX77693_BATTERY_GOOD:\n\tcase MAX77693_BATTERY_LOWVOLTAGE:\n\t\t*val = POWER_SUPPLY_HEALTH_GOOD;\n\t\tbreak;\n\tcase MAX77693_BATTERY_TIMER_EXPIRED:\n\t\t \n\t\t*val = POWER_SUPPLY_HEALTH_SAFETY_TIMER_EXPIRE;\n\t\tbreak;\n\tcase MAX77693_BATTERY_OVERVOLTAGE:\n\t\t*val = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\n\t\tbreak;\n\tcase MAX77693_BATTERY_OVERCURRENT:\n\t\t*val = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\t\tbreak;\n\tcase MAX77693_BATTERY_RESERVED:\n\tdefault:\n\t\t*val = POWER_SUPPLY_HEALTH_UNKNOWN;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int max77693_get_present(struct regmap *regmap, int *val)\n{\n\tunsigned int data;\n\tint ret;\n\n\t \n\tret = regmap_read(regmap, MAX77693_CHG_REG_CHG_INT_OK, &data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*val = (data & CHG_INT_OK_DETBAT_MASK) ? 0 : 1;\n\n\treturn 0;\n}\n\nstatic int max77693_get_online(struct regmap *regmap, int *val)\n{\n\tunsigned int data;\n\tint ret;\n\n\tret = regmap_read(regmap, MAX77693_CHG_REG_CHG_INT_OK, &data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*val = (data & CHG_INT_OK_CHGIN_MASK) ? 1 : 0;\n\n\treturn 0;\n}\n\nstatic enum power_supply_property max77693_charger_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_CHARGE_TYPE,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_MODEL_NAME,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstatic int max77693_charger_get_property(struct power_supply *psy,\n\t\t\t    enum power_supply_property psp,\n\t\t\t    union power_supply_propval *val)\n{\n\tstruct max77693_charger *chg = power_supply_get_drvdata(psy);\n\tstruct regmap *regmap = chg->max77693->regmap;\n\tint ret = 0;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tret = max77693_get_charger_state(regmap, &val->intval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tret = max77693_get_charge_type(regmap, &val->intval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tret = max77693_get_battery_health(regmap, &val->intval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tret = max77693_get_present(regmap, &val->intval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tret = max77693_get_online(regmap, &val->intval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_MODEL_NAME:\n\t\tval->strval = max77693_charger_model;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_MANUFACTURER:\n\t\tval->strval = max77693_charger_manufacturer;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic const struct power_supply_desc max77693_charger_desc = {\n\t.name\t\t= MAX77693_CHARGER_NAME,\n\t.type\t\t= POWER_SUPPLY_TYPE_BATTERY,\n\t.properties\t= max77693_charger_props,\n\t.num_properties\t= ARRAY_SIZE(max77693_charger_props),\n\t.get_property\t= max77693_charger_get_property,\n};\n\nstatic ssize_t device_attr_store(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t count,\n\t\tint (*fn)(struct max77693_charger *, unsigned long))\n{\n\tstruct max77693_charger *chg = dev_get_drvdata(dev);\n\tunsigned long val;\n\tint ret;\n\n\tret = kstrtoul(buf, 10, &val);\n\tif (ret)\n\t\treturn ret;\n\n\tret = fn(chg, val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn count;\n}\n\nstatic ssize_t fast_charge_timer_show(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct max77693_charger *chg = dev_get_drvdata(dev);\n\tunsigned int data, val;\n\tint ret;\n\n\tret = regmap_read(chg->max77693->regmap, MAX77693_CHG_REG_CHG_CNFG_01,\n\t\t\t&data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata &= CHG_CNFG_01_FCHGTIME_MASK;\n\tdata >>= CHG_CNFG_01_FCHGTIME_SHIFT;\n\tswitch (data) {\n\tcase 0x1 ... 0x7:\n\t\t \n\t\tval = 4 + (data - 1) * 2;\n\t\tbreak;\n\tcase 0x0:\n\tdefault:\n\t\tval = 0;\n\t\tbreak;\n\t}\n\n\treturn sysfs_emit(buf, \"%u\\n\", val);\n}\n\nstatic int max77693_set_fast_charge_timer(struct max77693_charger *chg,\n\t\tunsigned long hours)\n{\n\tunsigned int data;\n\n\t \n\tswitch (hours) {\n\tcase 4 ... 16:\n\t\tdata = (hours - 4) / 2 + 1;\n\t\tbreak;\n\tcase 0:\n\t\t \n\t\tdata = 0;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\tdata <<= CHG_CNFG_01_FCHGTIME_SHIFT;\n\n\treturn regmap_update_bits(chg->max77693->regmap,\n\t\t\tMAX77693_CHG_REG_CHG_CNFG_01,\n\t\t\tCHG_CNFG_01_FCHGTIME_MASK, data);\n}\n\nstatic ssize_t fast_charge_timer_store(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t count)\n{\n\treturn device_attr_store(dev, attr, buf, count,\n\t\t\tmax77693_set_fast_charge_timer);\n}\n\nstatic ssize_t top_off_threshold_current_show(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct max77693_charger *chg = dev_get_drvdata(dev);\n\tunsigned int data, val;\n\tint ret;\n\n\tret = regmap_read(chg->max77693->regmap, MAX77693_CHG_REG_CHG_CNFG_03,\n\t\t\t&data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata &= CHG_CNFG_03_TOITH_MASK;\n\tdata >>= CHG_CNFG_03_TOITH_SHIFT;\n\n\tif (data <= 0x04)\n\t\tval = 100000 + data * 25000;\n\telse\n\t\tval = data * 50000;\n\n\treturn sysfs_emit(buf, \"%u\\n\", val);\n}\n\nstatic int max77693_set_top_off_threshold_current(struct max77693_charger *chg,\n\t\tunsigned long uamp)\n{\n\tunsigned int data;\n\n\tif (uamp < 100000 || uamp > 350000)\n\t\treturn -EINVAL;\n\n\tif (uamp <= 200000)\n\t\tdata = (uamp - 100000) / 25000;\n\telse\n\t\t \n\t\tdata = uamp / 50000;\n\n\tdata <<= CHG_CNFG_03_TOITH_SHIFT;\n\n\treturn regmap_update_bits(chg->max77693->regmap,\n\t\t\tMAX77693_CHG_REG_CHG_CNFG_03,\n\t\t\tCHG_CNFG_03_TOITH_MASK, data);\n}\n\nstatic ssize_t top_off_threshold_current_store(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t count)\n{\n\treturn device_attr_store(dev, attr, buf, count,\n\t\t\tmax77693_set_top_off_threshold_current);\n}\n\nstatic ssize_t top_off_timer_show(struct device *dev,\n\t\tstruct device_attribute *attr, char *buf)\n{\n\tstruct max77693_charger *chg = dev_get_drvdata(dev);\n\tunsigned int data, val;\n\tint ret;\n\n\tret = regmap_read(chg->max77693->regmap, MAX77693_CHG_REG_CHG_CNFG_03,\n\t\t\t&data);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdata &= CHG_CNFG_03_TOTIME_MASK;\n\tdata >>= CHG_CNFG_03_TOTIME_SHIFT;\n\n\tval = data * 10;\n\n\treturn sysfs_emit(buf, \"%u\\n\", val);\n}\n\nstatic int max77693_set_top_off_timer(struct max77693_charger *chg,\n\t\tunsigned long minutes)\n{\n\tunsigned int data;\n\n\tif (minutes > 70)\n\t\treturn -EINVAL;\n\n\tdata = minutes / 10;\n\tdata <<= CHG_CNFG_03_TOTIME_SHIFT;\n\n\treturn regmap_update_bits(chg->max77693->regmap,\n\t\t\tMAX77693_CHG_REG_CHG_CNFG_03,\n\t\t\tCHG_CNFG_03_TOTIME_MASK, data);\n}\n\nstatic ssize_t top_off_timer_store(struct device *dev,\n\t\tstruct device_attribute *attr, const char *buf, size_t count)\n{\n\treturn device_attr_store(dev, attr, buf, count,\n\t\t\tmax77693_set_top_off_timer);\n}\n\nstatic DEVICE_ATTR_RW(fast_charge_timer);\nstatic DEVICE_ATTR_RW(top_off_threshold_current);\nstatic DEVICE_ATTR_RW(top_off_timer);\n\nstatic int max77693_set_constant_volt(struct max77693_charger *chg,\n\t\tunsigned int uvolt)\n{\n\tunsigned int data;\n\n\t \n\tif (uvolt >= 3650000 && uvolt < 4340000)\n\t\tdata = (uvolt - 3650000) / 25000;\n\telse if (uvolt >= 4340000 && uvolt < 4350000)\n\t\tdata = 0x1c;\n\telse if (uvolt >= 4350000 && uvolt <= 4400000)\n\t\tdata = 0x1d + (uvolt - 4350000) / 25000;\n\telse {\n\t\tdev_err(chg->dev, \"Wrong value for charging constant voltage\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tdata <<= CHG_CNFG_04_CHGCVPRM_SHIFT;\n\n\tdev_dbg(chg->dev, \"Charging constant voltage: %u (0x%x)\\n\", uvolt,\n\t\t\tdata);\n\n\treturn regmap_update_bits(chg->max77693->regmap,\n\t\t\tMAX77693_CHG_REG_CHG_CNFG_04,\n\t\t\tCHG_CNFG_04_CHGCVPRM_MASK, data);\n}\n\nstatic int max77693_set_min_system_volt(struct max77693_charger *chg,\n\t\tunsigned int uvolt)\n{\n\tunsigned int data;\n\n\tif (uvolt < 3000000 || uvolt > 3700000) {\n\t\tdev_err(chg->dev, \"Wrong value for minimum system regulation voltage\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tdata = (uvolt - 3000000) / 100000;\n\n\tdata <<= CHG_CNFG_04_MINVSYS_SHIFT;\n\n\tdev_dbg(chg->dev, \"Minimum system regulation voltage: %u (0x%x)\\n\",\n\t\t\tuvolt, data);\n\n\treturn regmap_update_bits(chg->max77693->regmap,\n\t\t\tMAX77693_CHG_REG_CHG_CNFG_04,\n\t\t\tCHG_CNFG_04_MINVSYS_MASK, data);\n}\n\nstatic int max77693_set_thermal_regulation_temp(struct max77693_charger *chg,\n\t\tunsigned int cels)\n{\n\tunsigned int data;\n\n\tswitch (cels) {\n\tcase 70:\n\tcase 85:\n\tcase 100:\n\tcase 115:\n\t\tdata = (cels - 70) / 15;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(chg->dev, \"Wrong value for thermal regulation loop temperature\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tdata <<= CHG_CNFG_07_REGTEMP_SHIFT;\n\n\tdev_dbg(chg->dev, \"Thermal regulation loop temperature: %u (0x%x)\\n\",\n\t\t\tcels, data);\n\n\treturn regmap_update_bits(chg->max77693->regmap,\n\t\t\tMAX77693_CHG_REG_CHG_CNFG_07,\n\t\t\tCHG_CNFG_07_REGTEMP_MASK, data);\n}\n\nstatic int max77693_set_batttery_overcurrent(struct max77693_charger *chg,\n\t\tunsigned int uamp)\n{\n\tunsigned int data;\n\n\tif (uamp && (uamp < 2000000 || uamp > 3500000)) {\n\t\tdev_err(chg->dev, \"Wrong value for battery overcurrent\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (uamp)\n\t\tdata = ((uamp - 2000000) / 250000) + 1;\n\telse\n\t\tdata = 0;  \n\n\tdata <<= CHG_CNFG_12_B2SOVRC_SHIFT;\n\n\tdev_dbg(chg->dev, \"Battery overcurrent: %u (0x%x)\\n\", uamp, data);\n\n\treturn regmap_update_bits(chg->max77693->regmap,\n\t\t\tMAX77693_CHG_REG_CHG_CNFG_12,\n\t\t\tCHG_CNFG_12_B2SOVRC_MASK, data);\n}\n\nstatic int max77693_set_charge_input_threshold_volt(struct max77693_charger *chg,\n\t\tunsigned int uvolt)\n{\n\tunsigned int data;\n\n\tswitch (uvolt) {\n\tcase 4300000:\n\t\tdata = 0x0;\n\t\tbreak;\n\tcase 4700000:\n\tcase 4800000:\n\tcase 4900000:\n\t\tdata = (uvolt - 4700000) / 100000;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(chg->dev, \"Wrong value for charge input voltage regulation threshold\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tdata <<= CHG_CNFG_12_VCHGINREG_SHIFT;\n\n\tdev_dbg(chg->dev, \"Charge input voltage regulation threshold: %u (0x%x)\\n\",\n\t\t\tuvolt, data);\n\n\treturn regmap_update_bits(chg->max77693->regmap,\n\t\t\tMAX77693_CHG_REG_CHG_CNFG_12,\n\t\t\tCHG_CNFG_12_VCHGINREG_MASK, data);\n}\n\n \nstatic int max77693_reg_init(struct max77693_charger *chg)\n{\n\tint ret;\n\tunsigned int data;\n\n\t \n\tdata = (0x3 << CHG_CNFG_06_CHGPROT_SHIFT);\n\tret = regmap_update_bits(chg->max77693->regmap,\n\t\t\t\tMAX77693_CHG_REG_CHG_CNFG_06,\n\t\t\t\tCHG_CNFG_06_CHGPROT_MASK, data);\n\tif (ret) {\n\t\tdev_err(chg->dev, \"Error unlocking registers: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = max77693_set_fast_charge_timer(chg, DEFAULT_FAST_CHARGE_TIMER);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max77693_set_top_off_threshold_current(chg,\n\t\t\tDEFAULT_TOP_OFF_THRESHOLD_CURRENT);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max77693_set_top_off_timer(chg, DEFAULT_TOP_OFF_TIMER);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max77693_set_constant_volt(chg, chg->constant_volt);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max77693_set_min_system_volt(chg, chg->min_system_volt);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max77693_set_thermal_regulation_temp(chg,\n\t\t\tchg->thermal_regulation_temp);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max77693_set_batttery_overcurrent(chg, chg->batttery_overcurrent);\n\tif (ret)\n\t\treturn ret;\n\n\treturn max77693_set_charge_input_threshold_volt(chg,\n\t\t\tchg->charge_input_threshold_volt);\n}\n\n#ifdef CONFIG_OF\nstatic int max77693_dt_init(struct device *dev, struct max77693_charger *chg)\n{\n\tstruct device_node *np = dev->of_node;\n\n\tif (!np) {\n\t\tdev_err(dev, \"no charger OF node\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (of_property_read_u32(np, \"maxim,constant-microvolt\",\n\t\t\t&chg->constant_volt))\n\t\tchg->constant_volt = DEFAULT_CONSTANT_VOLT;\n\n\tif (of_property_read_u32(np, \"maxim,min-system-microvolt\",\n\t\t\t&chg->min_system_volt))\n\t\tchg->min_system_volt = DEFAULT_MIN_SYSTEM_VOLT;\n\n\tif (of_property_read_u32(np, \"maxim,thermal-regulation-celsius\",\n\t\t\t&chg->thermal_regulation_temp))\n\t\tchg->thermal_regulation_temp = DEFAULT_THERMAL_REGULATION_TEMP;\n\n\tif (of_property_read_u32(np, \"maxim,battery-overcurrent-microamp\",\n\t\t\t&chg->batttery_overcurrent))\n\t\tchg->batttery_overcurrent = DEFAULT_BATTERY_OVERCURRENT;\n\n\tif (of_property_read_u32(np, \"maxim,charge-input-threshold-microvolt\",\n\t\t\t&chg->charge_input_threshold_volt))\n\t\tchg->charge_input_threshold_volt =\n\t\t\tDEFAULT_CHARGER_INPUT_THRESHOLD_VOLT;\n\n\treturn 0;\n}\n#else  \nstatic int max77693_dt_init(struct device *dev, struct max77693_charger *chg)\n{\n\treturn 0;\n}\n#endif  \n\nstatic int max77693_charger_probe(struct platform_device *pdev)\n{\n\tstruct max77693_charger *chg;\n\tstruct power_supply_config psy_cfg = {};\n\tstruct max77693_dev *max77693 = dev_get_drvdata(pdev->dev.parent);\n\tint ret;\n\n\tchg = devm_kzalloc(&pdev->dev, sizeof(*chg), GFP_KERNEL);\n\tif (!chg)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, chg);\n\tchg->dev = &pdev->dev;\n\tchg->max77693 = max77693;\n\n\tret = max77693_dt_init(&pdev->dev, chg);\n\tif (ret)\n\t\treturn ret;\n\n\tret = max77693_reg_init(chg);\n\tif (ret)\n\t\treturn ret;\n\n\tpsy_cfg.drv_data = chg;\n\n\tret = device_create_file(&pdev->dev, &dev_attr_fast_charge_timer);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed: create fast charge timer sysfs entry\\n\");\n\t\tgoto err;\n\t}\n\n\tret = device_create_file(&pdev->dev,\n\t\t\t&dev_attr_top_off_threshold_current);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed: create top off current sysfs entry\\n\");\n\t\tgoto err;\n\t}\n\n\tret = device_create_file(&pdev->dev, &dev_attr_top_off_timer);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed: create top off timer sysfs entry\\n\");\n\t\tgoto err;\n\t}\n\n\tchg->charger = power_supply_register(&pdev->dev,\n\t\t\t\t\t\t&max77693_charger_desc,\n\t\t\t\t\t\t&psy_cfg);\n\tif (IS_ERR(chg->charger)) {\n\t\tdev_err(&pdev->dev, \"failed: power supply register\\n\");\n\t\tret = PTR_ERR(chg->charger);\n\t\tgoto err;\n\t}\n\n\treturn 0;\n\nerr:\n\tdevice_remove_file(&pdev->dev, &dev_attr_top_off_timer);\n\tdevice_remove_file(&pdev->dev, &dev_attr_top_off_threshold_current);\n\tdevice_remove_file(&pdev->dev, &dev_attr_fast_charge_timer);\n\n\treturn ret;\n}\n\nstatic int max77693_charger_remove(struct platform_device *pdev)\n{\n\tstruct max77693_charger *chg = platform_get_drvdata(pdev);\n\n\tdevice_remove_file(&pdev->dev, &dev_attr_top_off_timer);\n\tdevice_remove_file(&pdev->dev, &dev_attr_top_off_threshold_current);\n\tdevice_remove_file(&pdev->dev, &dev_attr_fast_charge_timer);\n\n\tpower_supply_unregister(chg->charger);\n\n\treturn 0;\n}\n\nstatic const struct platform_device_id max77693_charger_id[] = {\n\t{ \"max77693-charger\", 0, },\n\t{ }\n};\nMODULE_DEVICE_TABLE(platform, max77693_charger_id);\n\nstatic struct platform_driver max77693_charger_driver = {\n\t.driver = {\n\t\t.name\t= \"max77693-charger\",\n\t},\n\t.probe\t\t= max77693_charger_probe,\n\t.remove\t\t= max77693_charger_remove,\n\t.id_table\t= max77693_charger_id,\n};\nmodule_platform_driver(max77693_charger_driver);\n\nMODULE_AUTHOR(\"Krzysztof Kozlowski <krzk@kernel.org>\");\nMODULE_DESCRIPTION(\"Maxim 77693 charger driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}