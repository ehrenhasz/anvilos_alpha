{
  "module_name": "max77650-charger.c",
  "hash_id": "5ab6d75b4f3842565decb50b0a63c4509090169e6b3786b09470569a677857b9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/max77650-charger.c",
  "human_readable_source": "\n\n\n\n\n\n\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/mfd/max77650.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/regmap.h>\n\n#define MAX77650_CHARGER_ENABLED\t\tBIT(0)\n#define MAX77650_CHARGER_DISABLED\t\t0x00\n#define MAX77650_CHARGER_CHG_EN_MASK\t\tBIT(0)\n\n#define MAX77650_CHG_DETAILS_MASK\t\tGENMASK(7, 4)\n#define MAX77650_CHG_DETAILS_BITS(_reg) \\\n\t\t(((_reg) & MAX77650_CHG_DETAILS_MASK) >> 4)\n\n \n#define MAX77650_CHG_OFF\t\t\t0x00\n \n#define MAX77650_CHG_PREQ\t\t\t0x01\n \n#define MAX77650_CHG_ON_CURR\t\t\t0x02\n \n#define MAX77650_CHG_ON_CURR_JEITA\t\t0x03\n \n#define MAX77650_CHG_ON_VOLT\t\t\t0x04\n \n#define MAX77650_CHG_ON_VOLT_JEITA\t\t0x05\n \n#define MAX77650_CHG_ON_TOPOFF\t\t\t0x06\n \n#define MAX77650_CHG_ON_TOPOFF_JEITA\t\t0x07\n \n#define MAX77650_CHG_DONE\t\t\t0x08\n \n#define MAX77650_CHG_DONE_JEITA\t\t\t0x09\n \n#define MAX77650_CHG_SUSP_PREQ_TIM_FAULT\t0x0a\n \n#define MAX77650_CHG_SUSP_FAST_CHG_TIM_FAULT\t0x0b\n \n#define MAX77650_CHG_SUSP_BATT_TEMP_FAULT\t0x0c\n\n#define MAX77650_CHGIN_DETAILS_MASK\t\tGENMASK(3, 2)\n#define MAX77650_CHGIN_DETAILS_BITS(_reg) \\\n\t\t(((_reg) & MAX77650_CHGIN_DETAILS_MASK) >> 2)\n\n#define MAX77650_CHGIN_UNDERVOLTAGE_LOCKOUT\t0x00\n#define MAX77650_CHGIN_OVERVOLTAGE_LOCKOUT\t0x01\n#define MAX77650_CHGIN_OKAY\t\t\t0x11\n\n#define MAX77650_CHARGER_CHG_MASK\tBIT(1)\n#define MAX77650_CHARGER_CHG_CHARGING(_reg) \\\n\t\t(((_reg) & MAX77650_CHARGER_CHG_MASK) > 1)\n\n#define MAX77650_CHARGER_VCHGIN_MIN_MASK\t0xc0\n#define MAX77650_CHARGER_VCHGIN_MIN_SHIFT(_val)\t((_val) << 5)\n\n#define MAX77650_CHARGER_ICHGIN_LIM_MASK\t0x1c\n#define MAX77650_CHARGER_ICHGIN_LIM_SHIFT(_val)\t((_val) << 2)\n\nstruct max77650_charger_data {\n\tstruct regmap *map;\n\tstruct device *dev;\n};\n\nstatic enum power_supply_property max77650_charger_properties[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_CHARGE_TYPE\n};\n\nstatic const unsigned int max77650_charger_vchgin_min_table[] = {\n\t4000000, 4100000, 4200000, 4300000, 4400000, 4500000, 4600000, 4700000\n};\n\nstatic const unsigned int max77650_charger_ichgin_lim_table[] = {\n\t95000, 190000, 285000, 380000, 475000\n};\n\nstatic int max77650_charger_set_vchgin_min(struct max77650_charger_data *chg,\n\t\t\t\t\t   unsigned int val)\n{\n\tint i, rv;\n\n\tfor (i = 0; i < ARRAY_SIZE(max77650_charger_vchgin_min_table); i++) {\n\t\tif (val == max77650_charger_vchgin_min_table[i]) {\n\t\t\trv = regmap_update_bits(chg->map,\n\t\t\t\t\tMAX77650_REG_CNFG_CHG_B,\n\t\t\t\t\tMAX77650_CHARGER_VCHGIN_MIN_MASK,\n\t\t\t\t\tMAX77650_CHARGER_VCHGIN_MIN_SHIFT(i));\n\t\t\tif (rv)\n\t\t\t\treturn rv;\n\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int max77650_charger_set_ichgin_lim(struct max77650_charger_data *chg,\n\t\t\t\t\t   unsigned int val)\n{\n\tint i, rv;\n\n\tfor (i = 0; i < ARRAY_SIZE(max77650_charger_ichgin_lim_table); i++) {\n\t\tif (val == max77650_charger_ichgin_lim_table[i]) {\n\t\t\trv = regmap_update_bits(chg->map,\n\t\t\t\t\tMAX77650_REG_CNFG_CHG_B,\n\t\t\t\t\tMAX77650_CHARGER_ICHGIN_LIM_MASK,\n\t\t\t\t\tMAX77650_CHARGER_ICHGIN_LIM_SHIFT(i));\n\t\t\tif (rv)\n\t\t\t\treturn rv;\n\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic int max77650_charger_enable(struct max77650_charger_data *chg)\n{\n\tint rv;\n\n\trv = regmap_update_bits(chg->map,\n\t\t\t\tMAX77650_REG_CNFG_CHG_B,\n\t\t\t\tMAX77650_CHARGER_CHG_EN_MASK,\n\t\t\t\tMAX77650_CHARGER_ENABLED);\n\tif (rv)\n\t\tdev_err(chg->dev, \"unable to enable the charger: %d\\n\", rv);\n\n\treturn rv;\n}\n\nstatic void max77650_charger_disable(struct max77650_charger_data *chg)\n{\n\tint rv;\n\n\trv = regmap_update_bits(chg->map,\n\t\t\t\tMAX77650_REG_CNFG_CHG_B,\n\t\t\t\tMAX77650_CHARGER_CHG_EN_MASK,\n\t\t\t\tMAX77650_CHARGER_DISABLED);\n\tif (rv)\n\t\tdev_err(chg->dev, \"unable to disable the charger: %d\\n\", rv);\n}\n\nstatic irqreturn_t max77650_charger_check_status(int irq, void *data)\n{\n\tstruct max77650_charger_data *chg = data;\n\tint rv, reg;\n\n\trv = regmap_read(chg->map, MAX77650_REG_STAT_CHG_B, &reg);\n\tif (rv) {\n\t\tdev_err(chg->dev,\n\t\t\t\"unable to read the charger status: %d\\n\", rv);\n\t\treturn IRQ_HANDLED;\n\t}\n\n\tswitch (MAX77650_CHGIN_DETAILS_BITS(reg)) {\n\tcase MAX77650_CHGIN_UNDERVOLTAGE_LOCKOUT:\n\t\tdev_err(chg->dev, \"undervoltage lockout detected, disabling charger\\n\");\n\t\tmax77650_charger_disable(chg);\n\t\tbreak;\n\tcase MAX77650_CHGIN_OVERVOLTAGE_LOCKOUT:\n\t\tdev_err(chg->dev, \"overvoltage lockout detected, disabling charger\\n\");\n\t\tmax77650_charger_disable(chg);\n\t\tbreak;\n\tcase MAX77650_CHGIN_OKAY:\n\t\tmax77650_charger_enable(chg);\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tbreak;\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int max77650_charger_get_property(struct power_supply *psy,\n\t\t\t\t\t enum power_supply_property psp,\n\t\t\t\t\t union power_supply_propval *val)\n{\n\tstruct max77650_charger_data *chg = power_supply_get_drvdata(psy);\n\tint rv, reg;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\trv = regmap_read(chg->map, MAX77650_REG_STAT_CHG_B, &reg);\n\t\tif (rv)\n\t\t\treturn rv;\n\n\t\tif (MAX77650_CHARGER_CHG_CHARGING(reg)) {\n\t\t\tval->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\t\tbreak;\n\t\t}\n\n\t\tswitch (MAX77650_CHG_DETAILS_BITS(reg)) {\n\t\tcase MAX77650_CHG_OFF:\n\t\tcase MAX77650_CHG_SUSP_PREQ_TIM_FAULT:\n\t\tcase MAX77650_CHG_SUSP_FAST_CHG_TIM_FAULT:\n\t\tcase MAX77650_CHG_SUSP_BATT_TEMP_FAULT:\n\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\t\tbreak;\n\t\tcase MAX77650_CHG_PREQ:\n\t\tcase MAX77650_CHG_ON_CURR:\n\t\tcase MAX77650_CHG_ON_CURR_JEITA:\n\t\tcase MAX77650_CHG_ON_VOLT:\n\t\tcase MAX77650_CHG_ON_VOLT_JEITA:\n\t\tcase MAX77650_CHG_ON_TOPOFF:\n\t\tcase MAX77650_CHG_ON_TOPOFF_JEITA:\n\t\t\tval->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\t\tbreak;\n\t\tcase MAX77650_CHG_DONE:\n\t\t\tval->intval = POWER_SUPPLY_STATUS_FULL;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tval->intval = POWER_SUPPLY_STATUS_UNKNOWN;\n\t\t}\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\trv = regmap_read(chg->map, MAX77650_REG_STAT_CHG_B, &reg);\n\t\tif (rv)\n\t\t\treturn rv;\n\n\t\tval->intval = MAX77650_CHARGER_CHG_CHARGING(reg);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\trv = regmap_read(chg->map, MAX77650_REG_STAT_CHG_B, &reg);\n\t\tif (rv)\n\t\t\treturn rv;\n\n\t\tif (!MAX77650_CHARGER_CHG_CHARGING(reg)) {\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_NONE;\n\t\t\tbreak;\n\t\t}\n\n\t\tswitch (MAX77650_CHG_DETAILS_BITS(reg)) {\n\t\tcase MAX77650_CHG_PREQ:\n\t\tcase MAX77650_CHG_ON_CURR:\n\t\tcase MAX77650_CHG_ON_CURR_JEITA:\n\t\tcase MAX77650_CHG_ON_VOLT:\n\t\tcase MAX77650_CHG_ON_VOLT_JEITA:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_FAST;\n\t\t\tbreak;\n\t\tcase MAX77650_CHG_ON_TOPOFF:\n\t\tcase MAX77650_CHG_ON_TOPOFF_JEITA:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_UNKNOWN;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct power_supply_desc max77650_battery_desc = {\n\t.name\t\t= \"max77650\",\n\t.type\t\t= POWER_SUPPLY_TYPE_USB,\n\t.get_property\t= max77650_charger_get_property,\n\t.properties\t= max77650_charger_properties,\n\t.num_properties\t= ARRAY_SIZE(max77650_charger_properties),\n};\n\nstatic int max77650_charger_probe(struct platform_device *pdev)\n{\n\tstruct power_supply_config pscfg = {};\n\tstruct max77650_charger_data *chg;\n\tstruct power_supply *battery;\n\tstruct device *dev, *parent;\n\tint rv, chg_irq, chgin_irq;\n\tunsigned int prop;\n\n\tdev = &pdev->dev;\n\tparent = dev->parent;\n\n\tchg = devm_kzalloc(dev, sizeof(*chg), GFP_KERNEL);\n\tif (!chg)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, chg);\n\n\tchg->map = dev_get_regmap(parent, NULL);\n\tif (!chg->map)\n\t\treturn -ENODEV;\n\n\tchg->dev = dev;\n\n\tpscfg.of_node = dev->of_node;\n\tpscfg.drv_data = chg;\n\n\tchg_irq = platform_get_irq_byname(pdev, \"CHG\");\n\tif (chg_irq < 0)\n\t\treturn chg_irq;\n\n\tchgin_irq = platform_get_irq_byname(pdev, \"CHGIN\");\n\tif (chgin_irq < 0)\n\t\treturn chgin_irq;\n\n\trv = devm_request_any_context_irq(dev, chg_irq,\n\t\t\t\t\t  max77650_charger_check_status,\n\t\t\t\t\t  IRQF_ONESHOT, \"chg\", chg);\n\tif (rv < 0)\n\t\treturn rv;\n\n\trv = devm_request_any_context_irq(dev, chgin_irq,\n\t\t\t\t\t  max77650_charger_check_status,\n\t\t\t\t\t  IRQF_ONESHOT, \"chgin\", chg);\n\tif (rv < 0)\n\t\treturn rv;\n\n\tbattery = devm_power_supply_register(dev,\n\t\t\t\t\t     &max77650_battery_desc, &pscfg);\n\tif (IS_ERR(battery))\n\t\treturn PTR_ERR(battery);\n\n\trv = of_property_read_u32(dev->of_node,\n\t\t\t\t  \"input-voltage-min-microvolt\", &prop);\n\tif (rv == 0) {\n\t\trv = max77650_charger_set_vchgin_min(chg, prop);\n\t\tif (rv)\n\t\t\treturn rv;\n\t}\n\n\trv = of_property_read_u32(dev->of_node,\n\t\t\t\t  \"input-current-limit-microamp\", &prop);\n\tif (rv == 0) {\n\t\trv = max77650_charger_set_ichgin_lim(chg, prop);\n\t\tif (rv)\n\t\t\treturn rv;\n\t}\n\n\treturn max77650_charger_enable(chg);\n}\n\nstatic int max77650_charger_remove(struct platform_device *pdev)\n{\n\tstruct max77650_charger_data *chg = platform_get_drvdata(pdev);\n\n\tmax77650_charger_disable(chg);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id max77650_charger_of_match[] = {\n\t{ .compatible = \"maxim,max77650-charger\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, max77650_charger_of_match);\n\nstatic struct platform_driver max77650_charger_driver = {\n\t.driver = {\n\t\t.name = \"max77650-charger\",\n\t\t.of_match_table = max77650_charger_of_match,\n\t},\n\t.probe = max77650_charger_probe,\n\t.remove = max77650_charger_remove,\n};\nmodule_platform_driver(max77650_charger_driver);\n\nMODULE_DESCRIPTION(\"MAXIM 77650/77651 charger driver\");\nMODULE_AUTHOR(\"Bartosz Golaszewski <bgolaszewski@baylibre.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_ALIAS(\"platform:max77650-charger\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}