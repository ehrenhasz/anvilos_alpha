{
  "module_name": "wilco-charger.c",
  "hash_id": "74561957507e4a1d209c0dafa192170f6d861247da6c97bd587f386b8e4d4837",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/wilco-charger.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/platform_data/wilco-ec.h>\n#include <linux/power_supply.h>\n\n#define DRV_NAME \"wilco-charger\"\n\n \n#define PID_CHARGE_MODE\t\t0x0710\n#define PID_CHARGE_LOWER_LIMIT\t0x0711\n#define PID_CHARGE_UPPER_LIMIT\t0x0712\n\nenum charge_mode {\n\tCHARGE_MODE_STD = 1,\t \n\tCHARGE_MODE_EXP = 2,\t \n\tCHARGE_MODE_AC = 3,\t \n\tCHARGE_MODE_AUTO = 4,\t \n\tCHARGE_MODE_CUSTOM = 5,\t \n\tCHARGE_MODE_LONGLIFE = 6,  \n};\n\n#define CHARGE_LOWER_LIMIT_MIN\t50\n#define CHARGE_LOWER_LIMIT_MAX\t95\n#define CHARGE_UPPER_LIMIT_MIN\t55\n#define CHARGE_UPPER_LIMIT_MAX\t100\n\n \nstatic int psp_val_to_charge_mode(int psp_val)\n{\n\tswitch (psp_val) {\n\tcase POWER_SUPPLY_CHARGE_TYPE_TRICKLE:\n\t\treturn CHARGE_MODE_AC;\n\tcase POWER_SUPPLY_CHARGE_TYPE_FAST:\n\t\treturn CHARGE_MODE_EXP;\n\tcase POWER_SUPPLY_CHARGE_TYPE_STANDARD:\n\t\treturn CHARGE_MODE_STD;\n\tcase POWER_SUPPLY_CHARGE_TYPE_ADAPTIVE:\n\t\treturn CHARGE_MODE_AUTO;\n\tcase POWER_SUPPLY_CHARGE_TYPE_CUSTOM:\n\t\treturn CHARGE_MODE_CUSTOM;\n\tcase POWER_SUPPLY_CHARGE_TYPE_LONGLIFE:\n\t\treturn CHARGE_MODE_LONGLIFE;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\n \nstatic int charge_mode_to_psp_val(enum charge_mode mode)\n{\n\tswitch (mode) {\n\tcase CHARGE_MODE_AC:\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\n\tcase CHARGE_MODE_EXP:\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_FAST;\n\tcase CHARGE_MODE_STD:\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_STANDARD;\n\tcase CHARGE_MODE_AUTO:\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_ADAPTIVE;\n\tcase CHARGE_MODE_CUSTOM:\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_CUSTOM;\n\tcase CHARGE_MODE_LONGLIFE:\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_LONGLIFE;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic enum power_supply_property wilco_charge_props[] = {\n\tPOWER_SUPPLY_PROP_CHARGE_TYPE,\n\tPOWER_SUPPLY_PROP_CHARGE_CONTROL_START_THRESHOLD,\n\tPOWER_SUPPLY_PROP_CHARGE_CONTROL_END_THRESHOLD,\n};\n\nstatic int wilco_charge_get_property(struct power_supply *psy,\n\t\t\t\t     enum power_supply_property psp,\n\t\t\t\t     union power_supply_propval *val)\n{\n\tstruct wilco_ec_device *ec = power_supply_get_drvdata(psy);\n\tu32 property_id;\n\tint ret;\n\tu8 raw;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tproperty_id = PID_CHARGE_MODE;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_CONTROL_START_THRESHOLD:\n\t\tproperty_id = PID_CHARGE_LOWER_LIMIT;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_CONTROL_END_THRESHOLD:\n\t\tproperty_id = PID_CHARGE_UPPER_LIMIT;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tret = wilco_ec_get_byte_property(ec, property_id, &raw);\n\tif (ret < 0)\n\t\treturn ret;\n\tif (property_id == PID_CHARGE_MODE) {\n\t\tret = charge_mode_to_psp_val(raw);\n\t\tif (ret < 0)\n\t\t\treturn -EBADMSG;\n\t\traw = ret;\n\t}\n\tval->intval = raw;\n\n\treturn 0;\n}\n\nstatic int wilco_charge_set_property(struct power_supply *psy,\n\t\t\t\t     enum power_supply_property psp,\n\t\t\t\t     const union power_supply_propval *val)\n{\n\tstruct wilco_ec_device *ec = power_supply_get_drvdata(psy);\n\tint mode;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tmode = psp_val_to_charge_mode(val->intval);\n\t\tif (mode < 0)\n\t\t\treturn -EINVAL;\n\t\treturn wilco_ec_set_byte_property(ec, PID_CHARGE_MODE, mode);\n\tcase POWER_SUPPLY_PROP_CHARGE_CONTROL_START_THRESHOLD:\n\t\tif (val->intval < CHARGE_LOWER_LIMIT_MIN ||\n\t\t    val->intval > CHARGE_LOWER_LIMIT_MAX)\n\t\t\treturn -EINVAL;\n\t\treturn wilco_ec_set_byte_property(ec, PID_CHARGE_LOWER_LIMIT,\n\t\t\t\t\t\t  val->intval);\n\tcase POWER_SUPPLY_PROP_CHARGE_CONTROL_END_THRESHOLD:\n\t\tif (val->intval < CHARGE_UPPER_LIMIT_MIN ||\n\t\t    val->intval > CHARGE_UPPER_LIMIT_MAX)\n\t\t\treturn -EINVAL;\n\t\treturn wilco_ec_set_byte_property(ec, PID_CHARGE_UPPER_LIMIT,\n\t\t\t\t\t\t  val->intval);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int wilco_charge_property_is_writeable(struct power_supply *psy,\n\t\t\t\t\t      enum power_supply_property psp)\n{\n\treturn 1;\n}\n\nstatic const struct power_supply_desc wilco_ps_desc = {\n\t.properties\t\t= wilco_charge_props,\n\t.num_properties\t\t= ARRAY_SIZE(wilco_charge_props),\n\t.get_property\t\t= wilco_charge_get_property,\n\t.set_property\t\t= wilco_charge_set_property,\n\t.property_is_writeable\t= wilco_charge_property_is_writeable,\n\t.name\t\t\t= DRV_NAME,\n\t.type\t\t\t= POWER_SUPPLY_TYPE_MAINS,\n};\n\nstatic int wilco_charge_probe(struct platform_device *pdev)\n{\n\tstruct wilco_ec_device *ec = dev_get_drvdata(pdev->dev.parent);\n\tstruct power_supply_config psy_cfg = {};\n\tstruct power_supply *psy;\n\n\tpsy_cfg.drv_data = ec;\n\tpsy = devm_power_supply_register(&pdev->dev, &wilco_ps_desc, &psy_cfg);\n\n\treturn PTR_ERR_OR_ZERO(psy);\n}\n\nstatic struct platform_driver wilco_charge_driver = {\n\t.probe\t= wilco_charge_probe,\n\t.driver = {\n\t\t.name = DRV_NAME,\n\t}\n};\nmodule_platform_driver(wilco_charge_driver);\n\nMODULE_ALIAS(\"platform:\" DRV_NAME);\nMODULE_AUTHOR(\"Nick Crews <ncrews@chromium.org>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Wilco EC charge control driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}