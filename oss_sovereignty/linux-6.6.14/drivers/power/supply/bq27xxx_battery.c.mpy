{
  "module_name": "bq27xxx_battery.c",
  "hash_id": "ebbe95d493e8ad15171e08f1b177097f161e5e62866c2da38adc3b6fc168308d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/bq27xxx_battery.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/param.h>\n#include <linux/jiffies.h>\n#include <linux/workqueue.h>\n#include <linux/delay.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/slab.h>\n#include <linux/of.h>\n\n#include <linux/power/bq27xxx_battery.h>\n\n#define BQ27XXX_MANUFACTURER\t\"Texas Instruments\"\n\n \n#define BQ27XXX_FLAG_DSC\tBIT(0)\n#define BQ27XXX_FLAG_SOCF\tBIT(1)  \n#define BQ27XXX_FLAG_SOC1\tBIT(2)  \n#define BQ27XXX_FLAG_CFGUP\tBIT(4)\n#define BQ27XXX_FLAG_FC\t\tBIT(9)\n#define BQ27XXX_FLAG_OTD\tBIT(14)\n#define BQ27XXX_FLAG_OTC\tBIT(15)\n#define BQ27XXX_FLAG_UT\t\tBIT(14)\n#define BQ27XXX_FLAG_OT\t\tBIT(15)\n\n \n#define BQ27000_FLAG_EDVF\tBIT(0)  \n#define BQ27000_FLAG_EDV1\tBIT(1)  \n#define BQ27000_FLAG_CI\t\tBIT(4)  \n#define BQ27000_FLAG_FC\t\tBIT(5)\n#define BQ27000_FLAG_CHGS\tBIT(7)  \n\n \n#define BQ27Z561_FLAG_FDC\tBIT(4)  \n#define BQ27Z561_FLAG_FC\tBIT(5)  \n#define BQ27Z561_FLAG_DIS_CH\tBIT(6)  \n\n \n#define BQ27XXX_SEALED\t\t\t0x20\n#define BQ27XXX_SET_CFGUPDATE\t\t0x13\n#define BQ27XXX_SOFT_RESET\t\t0x42\n#define BQ27XXX_RESET\t\t\t0x41\n\n#define BQ27XXX_RS\t\t\t(20)  \n#define BQ27XXX_POWER_CONSTANT\t\t(29200)  \n#define BQ27XXX_CURRENT_CONSTANT\t(3570)  \n\n#define INVALID_REG_ADDR\t0xff\n\n \n\nenum bq27xxx_reg_index {\n\tBQ27XXX_REG_CTRL = 0,\t \n\tBQ27XXX_REG_TEMP,\t \n\tBQ27XXX_REG_INT_TEMP,\t \n\tBQ27XXX_REG_VOLT,\t \n\tBQ27XXX_REG_AI,\t\t \n\tBQ27XXX_REG_FLAGS,\t \n\tBQ27XXX_REG_TTE,\t \n\tBQ27XXX_REG_TTF,\t \n\tBQ27XXX_REG_TTES,\t \n\tBQ27XXX_REG_TTECP,\t \n\tBQ27XXX_REG_NAC,\t \n\tBQ27XXX_REG_RC,\t\t \n\tBQ27XXX_REG_FCC,\t \n\tBQ27XXX_REG_CYCT,\t \n\tBQ27XXX_REG_AE,\t\t \n\tBQ27XXX_REG_SOC,\t \n\tBQ27XXX_REG_DCAP,\t \n\tBQ27XXX_REG_AP,\t\t \n\tBQ27XXX_DM_CTRL,\t \n\tBQ27XXX_DM_CLASS,\t \n\tBQ27XXX_DM_BLOCK,\t \n\tBQ27XXX_DM_DATA,\t \n\tBQ27XXX_DM_CKSUM,\t \n\tBQ27XXX_REG_MAX,\t \n};\n\n#define BQ27XXX_DM_REG_ROWS \\\n\t[BQ27XXX_DM_CTRL] = 0x61,  \\\n\t[BQ27XXX_DM_CLASS] = 0x3e, \\\n\t[BQ27XXX_DM_BLOCK] = 0x3f, \\\n\t[BQ27XXX_DM_DATA] = 0x40,  \\\n\t[BQ27XXX_DM_CKSUM] = 0x60\n\n \nstatic u8\n\tbq27000_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = 0x18,\n\t\t[BQ27XXX_REG_TTES] = 0x1c,\n\t\t[BQ27XXX_REG_TTECP] = 0x26,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = 0x22,\n\t\t[BQ27XXX_REG_SOC] = 0x0b,\n\t\t[BQ27XXX_REG_DCAP] = 0x76,\n\t\t[BQ27XXX_REG_AP] = 0x24,\n\t\t[BQ27XXX_DM_CTRL] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_CLASS] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_BLOCK] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_DATA] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_CKSUM] = INVALID_REG_ADDR,\n\t},\n\tbq27010_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = 0x18,\n\t\t[BQ27XXX_REG_TTES] = 0x1c,\n\t\t[BQ27XXX_REG_TTECP] = 0x26,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_SOC] = 0x0b,\n\t\t[BQ27XXX_REG_DCAP] = 0x76,\n\t\t[BQ27XXX_REG_AP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_CTRL] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_CLASS] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_BLOCK] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_DATA] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_CKSUM] = INVALID_REG_ADDR,\n\t},\n\tbq2750x_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x28,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTES] = 0x1a,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = INVALID_REG_ADDR,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n#define bq2751x_regs bq27510g3_regs\n#define bq2752x_regs bq27510g3_regs\n\tbq27500_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = 0x18,\n\t\t[BQ27XXX_REG_TTES] = 0x1c,\n\t\t[BQ27XXX_REG_TTECP] = 0x26,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = 0x22,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = 0x24,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n#define bq27510g1_regs bq27500_regs\n#define bq27510g2_regs bq27500_regs\n\tbq27510g3_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x28,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTES] = 0x1a,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x1e,\n\t\t[BQ27XXX_REG_AE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_SOC] = 0x20,\n\t\t[BQ27XXX_REG_DCAP] = 0x2e,\n\t\t[BQ27XXX_REG_AP] = INVALID_REG_ADDR,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n\tbq27520g1_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = 0x18,\n\t\t[BQ27XXX_REG_TTES] = 0x1c,\n\t\t[BQ27XXX_REG_TTECP] = 0x26,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_AE] = 0x22,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = 0x24,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n\tbq27520g2_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x36,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = 0x18,\n\t\t[BQ27XXX_REG_TTES] = 0x1c,\n\t\t[BQ27XXX_REG_TTECP] = 0x26,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = 0x22,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = 0x24,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n\tbq27520g3_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x36,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTES] = 0x1c,\n\t\t[BQ27XXX_REG_TTECP] = 0x26,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = 0x22,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = 0x24,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n\tbq27520g4_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x28,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTES] = 0x1c,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x1e,\n\t\t[BQ27XXX_REG_AE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_SOC] = 0x20,\n\t\t[BQ27XXX_REG_DCAP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_AP] = INVALID_REG_ADDR,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n\tbq27521_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x02,\n\t\t[BQ27XXX_REG_TEMP] = 0x0a,\n\t\t[BQ27XXX_REG_INT_TEMP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_VOLT] = 0x0c,\n\t\t[BQ27XXX_REG_AI] = 0x0e,\n\t\t[BQ27XXX_REG_FLAGS] = 0x08,\n\t\t[BQ27XXX_REG_TTE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTF] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTES] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_RC] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_FCC] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_CYCT] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_AE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_SOC] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_DCAP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_AP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_CTRL] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_CLASS] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_BLOCK] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_DATA] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_DM_CKSUM] = INVALID_REG_ADDR,\n\t},\n\tbq27530_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x32,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTES] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_AP] = 0x24,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n#define bq27531_regs bq27530_regs\n\tbq27541_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x28,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTES] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = 0x24,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n#define bq27542_regs bq27541_regs\n#define bq27546_regs bq27541_regs\n#define bq27742_regs bq27541_regs\n\tbq27545_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x28,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTES] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = 0x0c,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_AP] = 0x24,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n\tbq27421_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x02,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x1e,\n\t\t[BQ27XXX_REG_VOLT] = 0x04,\n\t\t[BQ27XXX_REG_AI] = 0x10,\n\t\t[BQ27XXX_REG_FLAGS] = 0x06,\n\t\t[BQ27XXX_REG_TTE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTF] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTES] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = 0x08,\n\t\t[BQ27XXX_REG_RC] = 0x0c,\n\t\t[BQ27XXX_REG_FCC] = 0x0e,\n\t\t[BQ27XXX_REG_CYCT] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_AE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_SOC] = 0x1c,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = 0x18,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n#define bq27411_regs bq27421_regs\n#define bq27425_regs bq27421_regs\n#define bq27426_regs bq27421_regs\n#define bq27441_regs bq27421_regs\n#define bq27621_regs bq27421_regs\n\tbq27z561_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = 0x18,\n\t\t[BQ27XXX_REG_TTES] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = 0x22,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = 0x22,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n\tbq28z610_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = 0x18,\n\t\t[BQ27XXX_REG_TTES] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = 0x22,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = 0x22,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n\tbq34z100_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x0c,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x2a,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x0a,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0e,\n\t\t[BQ27XXX_REG_TTE] = 0x18,\n\t\t[BQ27XXX_REG_TTF] = 0x1a,\n\t\t[BQ27XXX_REG_TTES] = 0x1e,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_RC] = 0x04,\n\t\t[BQ27XXX_REG_FCC] = 0x06,\n\t\t[BQ27XXX_REG_CYCT] = 0x2c,\n\t\t[BQ27XXX_REG_AE] = 0x24,\n\t\t[BQ27XXX_REG_SOC] = 0x02,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = 0x22,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t},\n\tbq78z100_regs[BQ27XXX_REG_MAX] = {\n\t\t[BQ27XXX_REG_CTRL] = 0x00,\n\t\t[BQ27XXX_REG_TEMP] = 0x06,\n\t\t[BQ27XXX_REG_INT_TEMP] = 0x28,\n\t\t[BQ27XXX_REG_VOLT] = 0x08,\n\t\t[BQ27XXX_REG_AI] = 0x14,\n\t\t[BQ27XXX_REG_FLAGS] = 0x0a,\n\t\t[BQ27XXX_REG_TTE] = 0x16,\n\t\t[BQ27XXX_REG_TTF] = 0x18,\n\t\t[BQ27XXX_REG_TTES] = 0x1c,\n\t\t[BQ27XXX_REG_TTECP] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_NAC] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_RC] = 0x10,\n\t\t[BQ27XXX_REG_FCC] = 0x12,\n\t\t[BQ27XXX_REG_CYCT] = 0x2a,\n\t\t[BQ27XXX_REG_AE] = INVALID_REG_ADDR,\n\t\t[BQ27XXX_REG_SOC] = 0x2c,\n\t\t[BQ27XXX_REG_DCAP] = 0x3c,\n\t\t[BQ27XXX_REG_AP] = 0x22,\n\t\tBQ27XXX_DM_REG_ROWS,\n\t};\n\nstatic enum power_supply_property bq27000_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_AVG,\n\tPOWER_SUPPLY_PROP_TIME_TO_FULL_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_ENERGY_NOW,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstatic enum power_supply_property bq27010_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_AVG,\n\tPOWER_SUPPLY_PROP_TIME_TO_FULL_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\n#define bq2750x_props bq27510g3_props\n#define bq2751x_props bq27510g3_props\n#define bq2752x_props bq27510g3_props\n\nstatic enum power_supply_property bq27500_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TIME_TO_FULL_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_ENERGY_NOW,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n#define bq27510g1_props bq27500_props\n#define bq27510g2_props bq27500_props\n\nstatic enum power_supply_property bq27510g3_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstatic enum power_supply_property bq27520g1_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TIME_TO_FULL_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_ENERGY_NOW,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\n#define bq27520g2_props bq27500_props\n\nstatic enum power_supply_property bq27520g3_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_ENERGY_NOW,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstatic enum power_supply_property bq27520g4_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstatic enum power_supply_property bq27521_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n};\n\nstatic enum power_supply_property bq27530_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n#define bq27531_props bq27530_props\n\nstatic enum power_supply_property bq27541_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n#define bq27542_props bq27541_props\n#define bq27546_props bq27541_props\n#define bq27742_props bq27541_props\n\nstatic enum power_supply_property bq27545_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstatic enum power_supply_property bq27421_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n#define bq27411_props bq27421_props\n#define bq27425_props bq27421_props\n#define bq27426_props bq27421_props\n#define bq27441_props bq27421_props\n#define bq27621_props bq27421_props\n\nstatic enum power_supply_property bq27z561_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TIME_TO_FULL_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstatic enum power_supply_property bq28z610_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TIME_TO_FULL_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstatic enum power_supply_property bq34z100_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_AVG,\n\tPOWER_SUPPLY_PROP_TIME_TO_FULL_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_ENERGY_NOW,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstatic enum power_supply_property bq78z100_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TIME_TO_FULL_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n\tPOWER_SUPPLY_PROP_POWER_AVG,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstruct bq27xxx_dm_reg {\n\tu8 subclass_id;\n\tu8 offset;\n\tu8 bytes;\n\tu16 min, max;\n};\n\nenum bq27xxx_dm_reg_id {\n\tBQ27XXX_DM_DESIGN_CAPACITY = 0,\n\tBQ27XXX_DM_DESIGN_ENERGY,\n\tBQ27XXX_DM_TERMINATE_VOLTAGE,\n};\n\n#define bq27000_dm_regs NULL\n#define bq27010_dm_regs NULL\n#define bq2750x_dm_regs NULL\n#define bq2751x_dm_regs NULL\n#define bq2752x_dm_regs NULL\n\n#if 0  \nstatic struct bq27xxx_dm_reg bq27500_dm_regs[] = {\n\t[BQ27XXX_DM_DESIGN_CAPACITY]   = { 48, 10, 2,    0, 65535 },\n\t[BQ27XXX_DM_DESIGN_ENERGY]     = { },  \n\t[BQ27XXX_DM_TERMINATE_VOLTAGE] = { 80, 48, 2, 1000, 32767 },\n};\n#else\n#define bq27500_dm_regs NULL\n#endif\n\n \n#define bq27510g1_dm_regs NULL\n#define bq27510g2_dm_regs NULL\n#define bq27510g3_dm_regs NULL\n#define bq27520g1_dm_regs NULL\n#define bq27520g2_dm_regs NULL\n#define bq27520g3_dm_regs NULL\n#define bq27520g4_dm_regs NULL\n#define bq27521_dm_regs NULL\n#define bq27530_dm_regs NULL\n#define bq27531_dm_regs NULL\n#define bq27541_dm_regs NULL\n#define bq27542_dm_regs NULL\n#define bq27546_dm_regs NULL\n#define bq27742_dm_regs NULL\n\n#if 0  \nstatic struct bq27xxx_dm_reg bq27545_dm_regs[] = {\n\t[BQ27XXX_DM_DESIGN_CAPACITY]   = { 48, 23, 2,    0, 32767 },\n\t[BQ27XXX_DM_DESIGN_ENERGY]     = { 48, 25, 2,    0, 32767 },\n\t[BQ27XXX_DM_TERMINATE_VOLTAGE] = { 80, 67, 2, 2800,  3700 },\n};\n#else\n#define bq27545_dm_regs NULL\n#endif\n\nstatic struct bq27xxx_dm_reg bq27411_dm_regs[] = {\n\t[BQ27XXX_DM_DESIGN_CAPACITY]   = { 82, 10, 2,    0, 32767 },\n\t[BQ27XXX_DM_DESIGN_ENERGY]     = { 82, 12, 2,    0, 32767 },\n\t[BQ27XXX_DM_TERMINATE_VOLTAGE] = { 82, 16, 2, 2800,  3700 },\n};\n\nstatic struct bq27xxx_dm_reg bq27421_dm_regs[] = {\n\t[BQ27XXX_DM_DESIGN_CAPACITY]   = { 82, 10, 2,    0,  8000 },\n\t[BQ27XXX_DM_DESIGN_ENERGY]     = { 82, 12, 2,    0, 32767 },\n\t[BQ27XXX_DM_TERMINATE_VOLTAGE] = { 82, 16, 2, 2500,  3700 },\n};\n\nstatic struct bq27xxx_dm_reg bq27425_dm_regs[] = {\n\t[BQ27XXX_DM_DESIGN_CAPACITY]   = { 82, 12, 2,    0, 32767 },\n\t[BQ27XXX_DM_DESIGN_ENERGY]     = { 82, 14, 2,    0, 32767 },\n\t[BQ27XXX_DM_TERMINATE_VOLTAGE] = { 82, 18, 2, 2800,  3700 },\n};\n\nstatic struct bq27xxx_dm_reg bq27426_dm_regs[] = {\n\t[BQ27XXX_DM_DESIGN_CAPACITY]   = { 82,  6, 2,    0,  8000 },\n\t[BQ27XXX_DM_DESIGN_ENERGY]     = { 82,  8, 2,    0, 32767 },\n\t[BQ27XXX_DM_TERMINATE_VOLTAGE] = { 82, 10, 2, 2500,  3700 },\n};\n\n#if 0  \n#define bq27441_dm_regs bq27421_dm_regs\n#else\n#define bq27441_dm_regs NULL\n#endif\n\n#if 0  \nstatic struct bq27xxx_dm_reg bq27621_dm_regs[] = {\n\t[BQ27XXX_DM_DESIGN_CAPACITY]   = { 82, 3, 2,    0,  8000 },\n\t[BQ27XXX_DM_DESIGN_ENERGY]     = { 82, 5, 2,    0, 32767 },\n\t[BQ27XXX_DM_TERMINATE_VOLTAGE] = { 82, 9, 2, 2500,  3700 },\n};\n#else\n#define bq27621_dm_regs NULL\n#endif\n\n#define bq27z561_dm_regs NULL\n#define bq28z610_dm_regs NULL\n#define bq34z100_dm_regs NULL\n#define bq78z100_dm_regs NULL\n\n#define BQ27XXX_O_ZERO\t\tBIT(0)\n#define BQ27XXX_O_OTDC\t\tBIT(1)  \n#define BQ27XXX_O_UTOT\t\tBIT(2)  \n#define BQ27XXX_O_CFGUP\t\tBIT(3)\n#define BQ27XXX_O_RAM\t\tBIT(4)\n#define BQ27Z561_O_BITS\t\tBIT(5)\n#define BQ27XXX_O_SOC_SI\tBIT(6)  \n#define BQ27XXX_O_HAS_CI\tBIT(7)  \n#define BQ27XXX_O_MUL_CHEM\tBIT(8)  \n\n#define BQ27XXX_DATA(ref, key, opt) {\t\t\\\n\t.opts = (opt),\t\t\t\t\\\n\t.unseal_key = key,\t\t\t\\\n\t.regs  = ref##_regs,\t\t\t\\\n\t.dm_regs = ref##_dm_regs,\t\t\\\n\t.props = ref##_props,\t\t\t\\\n\t.props_size = ARRAY_SIZE(ref##_props) }\n\nstatic struct {\n\tu32 opts;\n\tu32 unseal_key;\n\tu8 *regs;\n\tstruct bq27xxx_dm_reg *dm_regs;\n\tenum power_supply_property *props;\n\tsize_t props_size;\n} bq27xxx_chip_data[] = {\n\t[BQ27000]   = BQ27XXX_DATA(bq27000,   0         , BQ27XXX_O_ZERO | BQ27XXX_O_SOC_SI | BQ27XXX_O_HAS_CI),\n\t[BQ27010]   = BQ27XXX_DATA(bq27010,   0         , BQ27XXX_O_ZERO | BQ27XXX_O_SOC_SI | BQ27XXX_O_HAS_CI),\n\t[BQ2750X]   = BQ27XXX_DATA(bq2750x,   0         , BQ27XXX_O_OTDC),\n\t[BQ2751X]   = BQ27XXX_DATA(bq2751x,   0         , BQ27XXX_O_OTDC),\n\t[BQ2752X]   = BQ27XXX_DATA(bq2752x,   0         , BQ27XXX_O_OTDC),\n\t[BQ27500]   = BQ27XXX_DATA(bq27500,   0x04143672, BQ27XXX_O_OTDC),\n\t[BQ27510G1] = BQ27XXX_DATA(bq27510g1, 0         , BQ27XXX_O_OTDC),\n\t[BQ27510G2] = BQ27XXX_DATA(bq27510g2, 0         , BQ27XXX_O_OTDC),\n\t[BQ27510G3] = BQ27XXX_DATA(bq27510g3, 0         , BQ27XXX_O_OTDC),\n\t[BQ27520G1] = BQ27XXX_DATA(bq27520g1, 0         , BQ27XXX_O_OTDC),\n\t[BQ27520G2] = BQ27XXX_DATA(bq27520g2, 0         , BQ27XXX_O_OTDC),\n\t[BQ27520G3] = BQ27XXX_DATA(bq27520g3, 0         , BQ27XXX_O_OTDC),\n\t[BQ27520G4] = BQ27XXX_DATA(bq27520g4, 0         , BQ27XXX_O_OTDC),\n\t[BQ27521]   = BQ27XXX_DATA(bq27521,   0         , 0),\n\t[BQ27530]   = BQ27XXX_DATA(bq27530,   0         , BQ27XXX_O_UTOT),\n\t[BQ27531]   = BQ27XXX_DATA(bq27531,   0         , BQ27XXX_O_UTOT),\n\t[BQ27541]   = BQ27XXX_DATA(bq27541,   0         , BQ27XXX_O_OTDC),\n\t[BQ27542]   = BQ27XXX_DATA(bq27542,   0         , BQ27XXX_O_OTDC),\n\t[BQ27546]   = BQ27XXX_DATA(bq27546,   0         , BQ27XXX_O_OTDC),\n\t[BQ27742]   = BQ27XXX_DATA(bq27742,   0         , BQ27XXX_O_OTDC),\n\t[BQ27545]   = BQ27XXX_DATA(bq27545,   0x04143672, BQ27XXX_O_OTDC),\n\t[BQ27411]   = BQ27XXX_DATA(bq27411,   0x80008000, BQ27XXX_O_UTOT | BQ27XXX_O_CFGUP | BQ27XXX_O_RAM),\n\t[BQ27421]   = BQ27XXX_DATA(bq27421,   0x80008000, BQ27XXX_O_UTOT | BQ27XXX_O_CFGUP | BQ27XXX_O_RAM),\n\t[BQ27425]   = BQ27XXX_DATA(bq27425,   0x04143672, BQ27XXX_O_UTOT | BQ27XXX_O_CFGUP),\n\t[BQ27426]   = BQ27XXX_DATA(bq27426,   0x80008000, BQ27XXX_O_UTOT | BQ27XXX_O_CFGUP | BQ27XXX_O_RAM),\n\t[BQ27441]   = BQ27XXX_DATA(bq27441,   0x80008000, BQ27XXX_O_UTOT | BQ27XXX_O_CFGUP | BQ27XXX_O_RAM),\n\t[BQ27621]   = BQ27XXX_DATA(bq27621,   0x80008000, BQ27XXX_O_UTOT | BQ27XXX_O_CFGUP | BQ27XXX_O_RAM),\n\t[BQ27Z561]  = BQ27XXX_DATA(bq27z561,  0         , BQ27Z561_O_BITS),\n\t[BQ28Z610]  = BQ27XXX_DATA(bq28z610,  0         , BQ27Z561_O_BITS),\n\t[BQ34Z100]  = BQ27XXX_DATA(bq34z100,  0         , BQ27XXX_O_OTDC | BQ27XXX_O_SOC_SI | \\\n\t\t\t\t\t\t\t  BQ27XXX_O_HAS_CI | BQ27XXX_O_MUL_CHEM),\n\t[BQ78Z100]  = BQ27XXX_DATA(bq78z100,  0         , BQ27Z561_O_BITS),\n};\n\nstatic DEFINE_MUTEX(bq27xxx_list_lock);\nstatic LIST_HEAD(bq27xxx_battery_devices);\n\n#define BQ27XXX_MSLEEP(i) usleep_range((i)*1000, (i)*1000+500)\n\n#define BQ27XXX_DM_SZ\t32\n\n \nstruct bq27xxx_dm_buf {\n\tu8 class;\n\tu8 block;\n\tu8 data[BQ27XXX_DM_SZ];\n\tbool has_data, dirty;\n};\n\n#define BQ27XXX_DM_BUF(di, i) { \\\n\t.class = (di)->dm_regs[i].subclass_id, \\\n\t.block = (di)->dm_regs[i].offset / BQ27XXX_DM_SZ, \\\n}\n\nstatic inline __be16 *bq27xxx_dm_reg_ptr(struct bq27xxx_dm_buf *buf,\n\t\t\t\t      struct bq27xxx_dm_reg *reg)\n{\n\tif (buf->class == reg->subclass_id &&\n\t    buf->block == reg->offset / BQ27XXX_DM_SZ)\n\t\treturn (__be16 *) (buf->data + reg->offset % BQ27XXX_DM_SZ);\n\n\treturn NULL;\n}\n\nstatic const char * const bq27xxx_dm_reg_name[] = {\n\t[BQ27XXX_DM_DESIGN_CAPACITY] = \"design-capacity\",\n\t[BQ27XXX_DM_DESIGN_ENERGY] = \"design-energy\",\n\t[BQ27XXX_DM_TERMINATE_VOLTAGE] = \"terminate-voltage\",\n};\n\n\nstatic bool bq27xxx_dt_to_nvm = true;\nmodule_param_named(dt_monitored_battery_updates_nvm, bq27xxx_dt_to_nvm, bool, 0444);\nMODULE_PARM_DESC(dt_monitored_battery_updates_nvm,\n\t\"Devicetree monitored-battery config updates data memory on NVM/flash chips.\\n\"\n\t\"Users must set this =0 when installing a different type of battery!\\n\"\n\t\"Default is =1.\"\n#ifndef CONFIG_BATTERY_BQ27XXX_DT_UPDATES_NVM\n\t\"\\nSetting this affects future kernel updates, not the current configuration.\"\n#endif\n);\n\nstatic int poll_interval_param_set(const char *val, const struct kernel_param *kp)\n{\n\tstruct bq27xxx_device_info *di;\n\tunsigned int prev_val = *(unsigned int *) kp->arg;\n\tint ret;\n\n\tret = param_set_uint(val, kp);\n\tif (ret < 0 || prev_val == *(unsigned int *) kp->arg)\n\t\treturn ret;\n\n\tmutex_lock(&bq27xxx_list_lock);\n\tlist_for_each_entry(di, &bq27xxx_battery_devices, list)\n\t\tmod_delayed_work(system_wq, &di->work, 0);\n\tmutex_unlock(&bq27xxx_list_lock);\n\n\treturn ret;\n}\n\nstatic const struct kernel_param_ops param_ops_poll_interval = {\n\t.get = param_get_uint,\n\t.set = poll_interval_param_set,\n};\n\nstatic unsigned int poll_interval = 360;\nmodule_param_cb(poll_interval, &param_ops_poll_interval, &poll_interval, 0644);\nMODULE_PARM_DESC(poll_interval,\n\t\t \"battery poll interval in seconds - 0 disables polling\");\n\n \n\nstatic inline int bq27xxx_read(struct bq27xxx_device_info *di, int reg_index,\n\t\t\t       bool single)\n{\n\tint ret;\n\n\tif (!di || di->regs[reg_index] == INVALID_REG_ADDR)\n\t\treturn -EINVAL;\n\n\tret = di->bus.read(di, di->regs[reg_index], single);\n\tif (ret < 0)\n\t\tdev_dbg(di->dev, \"failed to read register 0x%02x (index %d)\\n\",\n\t\t\tdi->regs[reg_index], reg_index);\n\n\treturn ret;\n}\n\nstatic inline int bq27xxx_write(struct bq27xxx_device_info *di, int reg_index,\n\t\t\t\tu16 value, bool single)\n{\n\tint ret;\n\n\tif (!di || di->regs[reg_index] == INVALID_REG_ADDR)\n\t\treturn -EINVAL;\n\n\tif (!di->bus.write)\n\t\treturn -EPERM;\n\n\tret = di->bus.write(di, di->regs[reg_index], value, single);\n\tif (ret < 0)\n\t\tdev_dbg(di->dev, \"failed to write register 0x%02x (index %d)\\n\",\n\t\t\tdi->regs[reg_index], reg_index);\n\n\treturn ret;\n}\n\nstatic inline int bq27xxx_read_block(struct bq27xxx_device_info *di, int reg_index,\n\t\t\t\t     u8 *data, int len)\n{\n\tint ret;\n\n\tif (!di || di->regs[reg_index] == INVALID_REG_ADDR)\n\t\treturn -EINVAL;\n\n\tif (!di->bus.read_bulk)\n\t\treturn -EPERM;\n\n\tret = di->bus.read_bulk(di, di->regs[reg_index], data, len);\n\tif (ret < 0)\n\t\tdev_dbg(di->dev, \"failed to read_bulk register 0x%02x (index %d)\\n\",\n\t\t\tdi->regs[reg_index], reg_index);\n\n\treturn ret;\n}\n\nstatic inline int bq27xxx_write_block(struct bq27xxx_device_info *di, int reg_index,\n\t\t\t\t      u8 *data, int len)\n{\n\tint ret;\n\n\tif (!di || di->regs[reg_index] == INVALID_REG_ADDR)\n\t\treturn -EINVAL;\n\n\tif (!di->bus.write_bulk)\n\t\treturn -EPERM;\n\n\tret = di->bus.write_bulk(di, di->regs[reg_index], data, len);\n\tif (ret < 0)\n\t\tdev_dbg(di->dev, \"failed to write_bulk register 0x%02x (index %d)\\n\",\n\t\t\tdi->regs[reg_index], reg_index);\n\n\treturn ret;\n}\n\nstatic int bq27xxx_battery_seal(struct bq27xxx_device_info *di)\n{\n\tint ret;\n\n\tret = bq27xxx_write(di, BQ27XXX_REG_CTRL, BQ27XXX_SEALED, false);\n\tif (ret < 0) {\n\t\tdev_err(di->dev, \"bus error on seal: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int bq27xxx_battery_unseal(struct bq27xxx_device_info *di)\n{\n\tint ret;\n\n\tif (di->unseal_key == 0) {\n\t\tdev_err(di->dev, \"unseal failed due to missing key\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = bq27xxx_write(di, BQ27XXX_REG_CTRL, (u16)(di->unseal_key >> 16), false);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = bq27xxx_write(di, BQ27XXX_REG_CTRL, (u16)di->unseal_key, false);\n\tif (ret < 0)\n\t\tgoto out;\n\n\treturn 0;\n\nout:\n\tdev_err(di->dev, \"bus error on unseal: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic u8 bq27xxx_battery_checksum_dm_block(struct bq27xxx_dm_buf *buf)\n{\n\tu16 sum = 0;\n\tint i;\n\n\tfor (i = 0; i < BQ27XXX_DM_SZ; i++)\n\t\tsum += buf->data[i];\n\tsum &= 0xff;\n\n\treturn 0xff - sum;\n}\n\nstatic int bq27xxx_battery_read_dm_block(struct bq27xxx_device_info *di,\n\t\t\t\t\t struct bq27xxx_dm_buf *buf)\n{\n\tint ret;\n\n\tbuf->has_data = false;\n\n\tret = bq27xxx_write(di, BQ27XXX_DM_CLASS, buf->class, true);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = bq27xxx_write(di, BQ27XXX_DM_BLOCK, buf->block, true);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tBQ27XXX_MSLEEP(1);\n\n\tret = bq27xxx_read_block(di, BQ27XXX_DM_DATA, buf->data, BQ27XXX_DM_SZ);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = bq27xxx_read(di, BQ27XXX_DM_CKSUM, true);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tif ((u8)ret != bq27xxx_battery_checksum_dm_block(buf)) {\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\tbuf->has_data = true;\n\tbuf->dirty = false;\n\n\treturn 0;\n\nout:\n\tdev_err(di->dev, \"bus error reading chip memory: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic void bq27xxx_battery_update_dm_block(struct bq27xxx_device_info *di,\n\t\t\t\t\t    struct bq27xxx_dm_buf *buf,\n\t\t\t\t\t    enum bq27xxx_dm_reg_id reg_id,\n\t\t\t\t\t    unsigned int val)\n{\n\tstruct bq27xxx_dm_reg *reg = &di->dm_regs[reg_id];\n\tconst char *str = bq27xxx_dm_reg_name[reg_id];\n\t__be16 *prev = bq27xxx_dm_reg_ptr(buf, reg);\n\n\tif (prev == NULL) {\n\t\tdev_warn(di->dev, \"buffer does not match %s dm spec\\n\", str);\n\t\treturn;\n\t}\n\n\tif (reg->bytes != 2) {\n\t\tdev_warn(di->dev, \"%s dm spec has unsupported byte size\\n\", str);\n\t\treturn;\n\t}\n\n\tif (!buf->has_data)\n\t\treturn;\n\n\tif (be16_to_cpup(prev) == val) {\n\t\tdev_info(di->dev, \"%s has %u\\n\", str, val);\n\t\treturn;\n\t}\n\n#ifdef CONFIG_BATTERY_BQ27XXX_DT_UPDATES_NVM\n\tif (!(di->opts & BQ27XXX_O_RAM) && !bq27xxx_dt_to_nvm) {\n#else\n\tif (!(di->opts & BQ27XXX_O_RAM)) {\n#endif\n\t\t \n\t\tdev_warn(di->dev, \"%s has %u; update to %u disallowed \"\n#ifdef CONFIG_BATTERY_BQ27XXX_DT_UPDATES_NVM\n\t\t\t \"by dt_monitored_battery_updates_nvm=0\"\n#else\n\t\t\t \"for flash/NVM data memory\"\n#endif\n\t\t\t \"\\n\", str, be16_to_cpup(prev), val);\n\t\treturn;\n\t}\n\n\tdev_info(di->dev, \"update %s to %u\\n\", str, val);\n\n\t*prev = cpu_to_be16(val);\n\tbuf->dirty = true;\n}\n\nstatic int bq27xxx_battery_cfgupdate_priv(struct bq27xxx_device_info *di, bool active)\n{\n\tconst int limit = 100;\n\tu16 cmd = active ? BQ27XXX_SET_CFGUPDATE : BQ27XXX_SOFT_RESET;\n\tint ret, try = limit;\n\n\tret = bq27xxx_write(di, BQ27XXX_REG_CTRL, cmd, false);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdo {\n\t\tBQ27XXX_MSLEEP(25);\n\t\tret = bq27xxx_read(di, BQ27XXX_REG_FLAGS, false);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t} while (!!(ret & BQ27XXX_FLAG_CFGUP) != active && --try);\n\n\tif (!try && di->chip != BQ27425) { \n\t\tdev_err(di->dev, \"timed out waiting for cfgupdate flag %d\\n\", active);\n\t\treturn -EINVAL;\n\t}\n\n\tif (limit - try > 3)\n\t\tdev_warn(di->dev, \"cfgupdate %d, retries %d\\n\", active, limit - try);\n\n\treturn 0;\n}\n\nstatic inline int bq27xxx_battery_set_cfgupdate(struct bq27xxx_device_info *di)\n{\n\tint ret = bq27xxx_battery_cfgupdate_priv(di, true);\n\tif (ret < 0 && ret != -EINVAL)\n\t\tdev_err(di->dev, \"bus error on set_cfgupdate: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic inline int bq27xxx_battery_soft_reset(struct bq27xxx_device_info *di)\n{\n\tint ret = bq27xxx_battery_cfgupdate_priv(di, false);\n\tif (ret < 0 && ret != -EINVAL)\n\t\tdev_err(di->dev, \"bus error on soft_reset: %d\\n\", ret);\n\n\treturn ret;\n}\n\nstatic int bq27xxx_battery_write_dm_block(struct bq27xxx_device_info *di,\n\t\t\t\t\t  struct bq27xxx_dm_buf *buf)\n{\n\tbool cfgup = di->opts & BQ27XXX_O_CFGUP;\n\tint ret;\n\n\tif (!buf->dirty)\n\t\treturn 0;\n\n\tif (cfgup) {\n\t\tret = bq27xxx_battery_set_cfgupdate(di);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t}\n\n\tret = bq27xxx_write(di, BQ27XXX_DM_CTRL, 0, true);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = bq27xxx_write(di, BQ27XXX_DM_CLASS, buf->class, true);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = bq27xxx_write(di, BQ27XXX_DM_BLOCK, buf->block, true);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tBQ27XXX_MSLEEP(1);\n\n\tret = bq27xxx_write_block(di, BQ27XXX_DM_DATA, buf->data, BQ27XXX_DM_SZ);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tret = bq27xxx_write(di, BQ27XXX_DM_CKSUM,\n\t\t\t    bq27xxx_battery_checksum_dm_block(buf), true);\n\tif (ret < 0)\n\t\tgoto out;\n\n\t \n\n\tif (cfgup) {\n\t\tBQ27XXX_MSLEEP(1);\n\t\tret = bq27xxx_battery_soft_reset(di);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t} else {\n\t\tBQ27XXX_MSLEEP(100);  \n\t}\n\n\tbuf->dirty = false;\n\n\treturn 0;\n\nout:\n\tif (cfgup)\n\t\tbq27xxx_battery_soft_reset(di);\n\n\tdev_err(di->dev, \"bus error writing chip memory: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic void bq27xxx_battery_set_config(struct bq27xxx_device_info *di,\n\t\t\t\t       struct power_supply_battery_info *info)\n{\n\tstruct bq27xxx_dm_buf bd = BQ27XXX_DM_BUF(di, BQ27XXX_DM_DESIGN_CAPACITY);\n\tstruct bq27xxx_dm_buf bt = BQ27XXX_DM_BUF(di, BQ27XXX_DM_TERMINATE_VOLTAGE);\n\tbool updated;\n\n\tif (bq27xxx_battery_unseal(di) < 0)\n\t\treturn;\n\n\tif (info->charge_full_design_uah != -EINVAL &&\n\t    info->energy_full_design_uwh != -EINVAL) {\n\t\tbq27xxx_battery_read_dm_block(di, &bd);\n\t\t \n\t\tbq27xxx_battery_update_dm_block(di, &bd,\n\t\t\t\t\tBQ27XXX_DM_DESIGN_CAPACITY,\n\t\t\t\t\tinfo->charge_full_design_uah / 1000);\n\t\tbq27xxx_battery_update_dm_block(di, &bd,\n\t\t\t\t\tBQ27XXX_DM_DESIGN_ENERGY,\n\t\t\t\t\tinfo->energy_full_design_uwh / 1000);\n\t}\n\n\tif (info->voltage_min_design_uv != -EINVAL) {\n\t\tbool same = bd.class == bt.class && bd.block == bt.block;\n\t\tif (!same)\n\t\t\tbq27xxx_battery_read_dm_block(di, &bt);\n\t\tbq27xxx_battery_update_dm_block(di, same ? &bd : &bt,\n\t\t\t\t\tBQ27XXX_DM_TERMINATE_VOLTAGE,\n\t\t\t\t\tinfo->voltage_min_design_uv / 1000);\n\t}\n\n\tupdated = bd.dirty || bt.dirty;\n\n\tbq27xxx_battery_write_dm_block(di, &bd);\n\tbq27xxx_battery_write_dm_block(di, &bt);\n\n\tbq27xxx_battery_seal(di);\n\n\tif (updated && !(di->opts & BQ27XXX_O_CFGUP)) {\n\t\tbq27xxx_write(di, BQ27XXX_REG_CTRL, BQ27XXX_RESET, false);\n\t\tBQ27XXX_MSLEEP(300);  \n\t}\n\t \n}\n\nstatic void bq27xxx_battery_settings(struct bq27xxx_device_info *di)\n{\n\tstruct power_supply_battery_info *info;\n\tunsigned int min, max;\n\n\tif (power_supply_get_battery_info(di->bat, &info) < 0)\n\t\treturn;\n\n\tif (!di->dm_regs) {\n\t\tdev_warn(di->dev, \"data memory update not supported for chip\\n\");\n\t\treturn;\n\t}\n\n\tif (info->energy_full_design_uwh != info->charge_full_design_uah) {\n\t\tif (info->energy_full_design_uwh == -EINVAL)\n\t\t\tdev_warn(di->dev, \"missing battery:energy-full-design-microwatt-hours\\n\");\n\t\telse if (info->charge_full_design_uah == -EINVAL)\n\t\t\tdev_warn(di->dev, \"missing battery:charge-full-design-microamp-hours\\n\");\n\t}\n\n\t \n\tmax = di->dm_regs[BQ27XXX_DM_DESIGN_ENERGY].max;\n\tif (info->energy_full_design_uwh > max * 1000) {\n\t\tdev_err(di->dev, \"invalid battery:energy-full-design-microwatt-hours %d\\n\",\n\t\t\tinfo->energy_full_design_uwh);\n\t\tinfo->energy_full_design_uwh = -EINVAL;\n\t}\n\n\t \n\tmax = di->dm_regs[BQ27XXX_DM_DESIGN_CAPACITY].max;\n\tif (info->charge_full_design_uah > max * 1000) {\n\t\tdev_err(di->dev, \"invalid battery:charge-full-design-microamp-hours %d\\n\",\n\t\t\tinfo->charge_full_design_uah);\n\t\tinfo->charge_full_design_uah = -EINVAL;\n\t}\n\n\tmin = di->dm_regs[BQ27XXX_DM_TERMINATE_VOLTAGE].min;\n\tmax = di->dm_regs[BQ27XXX_DM_TERMINATE_VOLTAGE].max;\n\tif ((info->voltage_min_design_uv < min * 1000 ||\n\t     info->voltage_min_design_uv > max * 1000) &&\n\t     info->voltage_min_design_uv != -EINVAL) {\n\t\tdev_err(di->dev, \"invalid battery:voltage-min-design-microvolt %d\\n\",\n\t\t\tinfo->voltage_min_design_uv);\n\t\tinfo->voltage_min_design_uv = -EINVAL;\n\t}\n\n\tif ((info->energy_full_design_uwh != -EINVAL &&\n\t     info->charge_full_design_uah != -EINVAL) ||\n\t     info->voltage_min_design_uv  != -EINVAL)\n\t\tbq27xxx_battery_set_config(di, info);\n}\n\n \nstatic int bq27xxx_battery_read_soc(struct bq27xxx_device_info *di)\n{\n\tint soc;\n\n\tif (di->opts & BQ27XXX_O_SOC_SI)\n\t\tsoc = bq27xxx_read(di, BQ27XXX_REG_SOC, true);\n\telse\n\t\tsoc = bq27xxx_read(di, BQ27XXX_REG_SOC, false);\n\n\tif (soc < 0)\n\t\tdev_dbg(di->dev, \"error reading State-of-Charge\\n\");\n\n\treturn soc;\n}\n\n \nstatic int bq27xxx_battery_read_charge(struct bq27xxx_device_info *di, u8 reg)\n{\n\tint charge;\n\n\tcharge = bq27xxx_read(di, reg, false);\n\tif (charge < 0) {\n\t\tdev_dbg(di->dev, \"error reading charge register %02x: %d\\n\",\n\t\t\treg, charge);\n\t\treturn charge;\n\t}\n\n\tif (di->opts & BQ27XXX_O_ZERO)\n\t\tcharge *= BQ27XXX_CURRENT_CONSTANT / BQ27XXX_RS;\n\telse\n\t\tcharge *= 1000;\n\n\treturn charge;\n}\n\n \nstatic inline int bq27xxx_battery_read_nac(struct bq27xxx_device_info *di)\n{\n\treturn bq27xxx_battery_read_charge(di, BQ27XXX_REG_NAC);\n}\n\n \nstatic inline int bq27xxx_battery_read_rc(struct bq27xxx_device_info *di)\n{\n\treturn bq27xxx_battery_read_charge(di, BQ27XXX_REG_RC);\n}\n\n \nstatic inline int bq27xxx_battery_read_fcc(struct bq27xxx_device_info *di)\n{\n\treturn bq27xxx_battery_read_charge(di, BQ27XXX_REG_FCC);\n}\n\n \nstatic int bq27xxx_battery_read_dcap(struct bq27xxx_device_info *di)\n{\n\tint dcap;\n\n\tif (di->opts & BQ27XXX_O_ZERO)\n\t\tdcap = bq27xxx_read(di, BQ27XXX_REG_DCAP, true);\n\telse\n\t\tdcap = bq27xxx_read(di, BQ27XXX_REG_DCAP, false);\n\n\tif (dcap < 0) {\n\t\tdev_dbg(di->dev, \"error reading initial last measured discharge\\n\");\n\t\treturn dcap;\n\t}\n\n\tif (di->opts & BQ27XXX_O_ZERO)\n\t\tdcap = (dcap << 8) * BQ27XXX_CURRENT_CONSTANT / BQ27XXX_RS;\n\telse\n\t\tdcap *= 1000;\n\n\treturn dcap;\n}\n\n \nstatic int bq27xxx_battery_read_energy(struct bq27xxx_device_info *di)\n{\n\tint ae;\n\n\tae = bq27xxx_read(di, BQ27XXX_REG_AE, false);\n\tif (ae < 0) {\n\t\tdev_dbg(di->dev, \"error reading available energy\\n\");\n\t\treturn ae;\n\t}\n\n\tif (di->opts & BQ27XXX_O_ZERO)\n\t\tae *= BQ27XXX_POWER_CONSTANT / BQ27XXX_RS;\n\telse\n\t\tae *= 1000;\n\n\treturn ae;\n}\n\n \nstatic int bq27xxx_battery_read_temperature(struct bq27xxx_device_info *di)\n{\n\tint temp;\n\n\ttemp = bq27xxx_read(di, BQ27XXX_REG_TEMP, false);\n\tif (temp < 0) {\n\t\tdev_err(di->dev, \"error reading temperature\\n\");\n\t\treturn temp;\n\t}\n\n\tif (di->opts & BQ27XXX_O_ZERO)\n\t\ttemp = 5 * temp / 2;\n\n\treturn temp;\n}\n\n \nstatic int bq27xxx_battery_read_cyct(struct bq27xxx_device_info *di)\n{\n\tint cyct;\n\n\tcyct = bq27xxx_read(di, BQ27XXX_REG_CYCT, false);\n\tif (cyct < 0)\n\t\tdev_err(di->dev, \"error reading cycle count total\\n\");\n\n\treturn cyct;\n}\n\n \nstatic int bq27xxx_battery_read_time(struct bq27xxx_device_info *di, u8 reg)\n{\n\tint tval;\n\n\ttval = bq27xxx_read(di, reg, false);\n\tif (tval < 0) {\n\t\tdev_dbg(di->dev, \"error reading time register %02x: %d\\n\",\n\t\t\treg, tval);\n\t\treturn tval;\n\t}\n\n\tif (tval == 65535)\n\t\treturn -ENODATA;\n\n\treturn tval * 60;\n}\n\n \nstatic bool bq27xxx_battery_overtemp(struct bq27xxx_device_info *di, u16 flags)\n{\n\tif (di->opts & BQ27XXX_O_OTDC)\n\t\treturn flags & (BQ27XXX_FLAG_OTC | BQ27XXX_FLAG_OTD);\n        if (di->opts & BQ27XXX_O_UTOT)\n\t\treturn flags & BQ27XXX_FLAG_OT;\n\n\treturn false;\n}\n\n \nstatic bool bq27xxx_battery_undertemp(struct bq27xxx_device_info *di, u16 flags)\n{\n\tif (di->opts & BQ27XXX_O_UTOT)\n\t\treturn flags & BQ27XXX_FLAG_UT;\n\n\treturn false;\n}\n\n \nstatic bool bq27xxx_battery_dead(struct bq27xxx_device_info *di, u16 flags)\n{\n\tif (di->opts & BQ27XXX_O_ZERO)\n\t\treturn flags & (BQ27000_FLAG_EDV1 | BQ27000_FLAG_EDVF);\n\telse if (di->opts & BQ27Z561_O_BITS)\n\t\treturn flags & BQ27Z561_FLAG_FDC;\n\telse\n\t\treturn flags & (BQ27XXX_FLAG_SOC1 | BQ27XXX_FLAG_SOCF);\n}\n\n \nstatic bool bq27xxx_battery_capacity_inaccurate(struct bq27xxx_device_info *di,\n\t\t\t\t\t\t u16 flags)\n{\n\tif (di->opts & BQ27XXX_O_HAS_CI)\n\t\treturn (flags & BQ27000_FLAG_CI);\n\telse\n\t\treturn false;\n}\n\nstatic int bq27xxx_battery_read_health(struct bq27xxx_device_info *di)\n{\n\t \n\tif (unlikely(bq27xxx_battery_overtemp(di, di->cache.flags)))\n\t\treturn POWER_SUPPLY_HEALTH_OVERHEAT;\n\tif (unlikely(bq27xxx_battery_undertemp(di, di->cache.flags)))\n\t\treturn POWER_SUPPLY_HEALTH_COLD;\n\tif (unlikely(bq27xxx_battery_dead(di, di->cache.flags)))\n\t\treturn POWER_SUPPLY_HEALTH_DEAD;\n\tif (unlikely(bq27xxx_battery_capacity_inaccurate(di, di->cache.flags)))\n\t\treturn POWER_SUPPLY_HEALTH_CALIBRATION_REQUIRED;\n\n\treturn POWER_SUPPLY_HEALTH_GOOD;\n}\n\nstatic bool bq27xxx_battery_is_full(struct bq27xxx_device_info *di, int flags)\n{\n\tif (di->opts & BQ27XXX_O_ZERO)\n\t\treturn (flags & BQ27000_FLAG_FC);\n\telse if (di->opts & BQ27Z561_O_BITS)\n\t\treturn (flags & BQ27Z561_FLAG_FC);\n\telse\n\t\treturn (flags & BQ27XXX_FLAG_FC);\n}\n\n \nstatic int bq27xxx_battery_current_and_status(\n\tstruct bq27xxx_device_info *di,\n\tunion power_supply_propval *val_curr,\n\tunion power_supply_propval *val_status,\n\tstruct bq27xxx_reg_cache *cache)\n{\n\tbool single_flags = (di->opts & BQ27XXX_O_ZERO);\n\tint curr;\n\tint flags;\n\n\tcurr = bq27xxx_read(di, BQ27XXX_REG_AI, false);\n\tif (curr < 0) {\n\t\tdev_err(di->dev, \"error reading current\\n\");\n\t\treturn curr;\n\t}\n\n\tif (cache) {\n\t\tflags = cache->flags;\n\t} else {\n\t\tflags = bq27xxx_read(di, BQ27XXX_REG_FLAGS, single_flags);\n\t\tif (flags < 0) {\n\t\t\tdev_err(di->dev, \"error reading flags\\n\");\n\t\t\treturn flags;\n\t\t}\n\t}\n\n\tif (di->opts & BQ27XXX_O_ZERO) {\n\t\tif (!(flags & BQ27000_FLAG_CHGS)) {\n\t\t\tdev_dbg(di->dev, \"negative current!\\n\");\n\t\t\tcurr = -curr;\n\t\t}\n\n\t\tcurr = curr * BQ27XXX_CURRENT_CONSTANT / BQ27XXX_RS;\n\t} else {\n\t\t \n\t\tcurr = (int)((s16)curr) * 1000;\n\t}\n\n\tif (val_curr)\n\t\tval_curr->intval = curr;\n\n\tif (val_status) {\n\t\tif (curr > 0) {\n\t\t\tval_status->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\t} else if (curr < 0) {\n\t\t\tval_status->intval = POWER_SUPPLY_STATUS_DISCHARGING;\n\t\t} else {\n\t\t\tif (bq27xxx_battery_is_full(di, flags))\n\t\t\t\tval_status->intval = POWER_SUPPLY_STATUS_FULL;\n\t\t\telse\n\t\t\t\tval_status->intval =\n\t\t\t\t\tPOWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic void bq27xxx_battery_update_unlocked(struct bq27xxx_device_info *di)\n{\n\tunion power_supply_propval status = di->last_status;\n\tstruct bq27xxx_reg_cache cache = {0, };\n\tbool has_singe_flag = di->opts & BQ27XXX_O_ZERO;\n\n\tcache.flags = bq27xxx_read(di, BQ27XXX_REG_FLAGS, has_singe_flag);\n\tif ((cache.flags & 0xff) == 0xff)\n\t\tcache.flags = -1;  \n\tif (cache.flags >= 0) {\n\t\tcache.temperature = bq27xxx_battery_read_temperature(di);\n\t\tif (di->regs[BQ27XXX_REG_TTE] != INVALID_REG_ADDR)\n\t\t\tcache.time_to_empty = bq27xxx_battery_read_time(di, BQ27XXX_REG_TTE);\n\t\tif (di->regs[BQ27XXX_REG_TTECP] != INVALID_REG_ADDR)\n\t\t\tcache.time_to_empty_avg = bq27xxx_battery_read_time(di, BQ27XXX_REG_TTECP);\n\t\tif (di->regs[BQ27XXX_REG_TTF] != INVALID_REG_ADDR)\n\t\t\tcache.time_to_full = bq27xxx_battery_read_time(di, BQ27XXX_REG_TTF);\n\n\t\tcache.charge_full = bq27xxx_battery_read_fcc(di);\n\t\tcache.capacity = bq27xxx_battery_read_soc(di);\n\t\tif (di->regs[BQ27XXX_REG_AE] != INVALID_REG_ADDR)\n\t\t\tcache.energy = bq27xxx_battery_read_energy(di);\n\t\tdi->cache.flags = cache.flags;\n\t\tcache.health = bq27xxx_battery_read_health(di);\n\t\tif (di->regs[BQ27XXX_REG_CYCT] != INVALID_REG_ADDR)\n\t\t\tcache.cycle_count = bq27xxx_battery_read_cyct(di);\n\n\t\t \n\t\tif (!(di->opts & BQ27XXX_O_ZERO))\n\t\t\tbq27xxx_battery_current_and_status(di, NULL, &status, &cache);\n\n\t\t \n\t\tif (di->charge_design_full <= 0)\n\t\t\tdi->charge_design_full = bq27xxx_battery_read_dcap(di);\n\t}\n\n\tif ((di->cache.capacity != cache.capacity) ||\n\t    (di->cache.flags != cache.flags) ||\n\t    (di->last_status.intval != status.intval)) {\n\t\tdi->last_status.intval = status.intval;\n\t\tpower_supply_changed(di->bat);\n\t}\n\n\tif (memcmp(&di->cache, &cache, sizeof(cache)) != 0)\n\t\tdi->cache = cache;\n\n\tdi->last_update = jiffies;\n\n\tif (!di->removed && poll_interval > 0)\n\t\tmod_delayed_work(system_wq, &di->work, poll_interval * HZ);\n}\n\nvoid bq27xxx_battery_update(struct bq27xxx_device_info *di)\n{\n\tmutex_lock(&di->lock);\n\tbq27xxx_battery_update_unlocked(di);\n\tmutex_unlock(&di->lock);\n}\nEXPORT_SYMBOL_GPL(bq27xxx_battery_update);\n\nstatic void bq27xxx_battery_poll(struct work_struct *work)\n{\n\tstruct bq27xxx_device_info *di =\n\t\t\tcontainer_of(work, struct bq27xxx_device_info,\n\t\t\t\t     work.work);\n\n\tbq27xxx_battery_update(di);\n}\n\n \nstatic int bq27xxx_battery_pwr_avg(struct bq27xxx_device_info *di,\n\t\t\t\t   union power_supply_propval *val)\n{\n\tint power;\n\n\tpower = bq27xxx_read(di, BQ27XXX_REG_AP, false);\n\tif (power < 0) {\n\t\tdev_err(di->dev,\n\t\t\t\"error reading average power register %02x: %d\\n\",\n\t\t\tBQ27XXX_REG_AP, power);\n\t\treturn power;\n\t}\n\n\tif (di->opts & BQ27XXX_O_ZERO)\n\t\tval->intval = (power * BQ27XXX_POWER_CONSTANT) / BQ27XXX_RS;\n\telse\n\t\t \n\t\tval->intval = (int)((s16)power) * 10000;\n\n\treturn 0;\n}\n\nstatic int bq27xxx_battery_capacity_level(struct bq27xxx_device_info *di,\n\t\t\t\t\t  union power_supply_propval *val)\n{\n\tint level;\n\n\tif (di->opts & BQ27XXX_O_ZERO) {\n\t\tif (di->cache.flags & BQ27000_FLAG_FC)\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_FULL;\n\t\telse if (di->cache.flags & BQ27000_FLAG_EDVF)\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_CRITICAL;\n\t\telse if (di->cache.flags & BQ27000_FLAG_EDV1)\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_LOW;\n\t\telse\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\n\t} else if (di->opts & BQ27Z561_O_BITS) {\n\t\tif (di->cache.flags & BQ27Z561_FLAG_FC)\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_FULL;\n\t\telse if (di->cache.flags & BQ27Z561_FLAG_FDC)\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_CRITICAL;\n\t\telse\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\n\t} else {\n\t\tif (di->cache.flags & BQ27XXX_FLAG_FC)\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_FULL;\n\t\telse if (di->cache.flags & BQ27XXX_FLAG_SOCF)\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_CRITICAL;\n\t\telse if (di->cache.flags & BQ27XXX_FLAG_SOC1)\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_LOW;\n\t\telse\n\t\t\tlevel = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\n\t}\n\n\tval->intval = level;\n\n\treturn 0;\n}\n\n \nstatic int bq27xxx_battery_voltage(struct bq27xxx_device_info *di,\n\t\t\t\t   union power_supply_propval *val)\n{\n\tint volt;\n\n\tvolt = bq27xxx_read(di, BQ27XXX_REG_VOLT, false);\n\tif (volt < 0) {\n\t\tdev_err(di->dev, \"error reading voltage\\n\");\n\t\treturn volt;\n\t}\n\n\tval->intval = volt * 1000;\n\n\treturn 0;\n}\n\nstatic int bq27xxx_simple_value(int value,\n\t\t\t\tunion power_supply_propval *val)\n{\n\tif (value < 0)\n\t\treturn value;\n\n\tval->intval = value;\n\n\treturn 0;\n}\n\nstatic int bq27xxx_battery_get_property(struct power_supply *psy,\n\t\t\t\t\tenum power_supply_property psp,\n\t\t\t\t\tunion power_supply_propval *val)\n{\n\tint ret = 0;\n\tstruct bq27xxx_device_info *di = power_supply_get_drvdata(psy);\n\n\tmutex_lock(&di->lock);\n\tif (time_is_before_jiffies(di->last_update + 5 * HZ))\n\t\tbq27xxx_battery_update_unlocked(di);\n\tmutex_unlock(&di->lock);\n\n\tif (psp != POWER_SUPPLY_PROP_PRESENT && di->cache.flags < 0)\n\t\treturn -ENODEV;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tret = bq27xxx_battery_current_and_status(di, NULL, val, NULL);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tret = bq27xxx_battery_voltage(di, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tval->intval = di->cache.flags < 0 ? 0 : 1;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_NOW:\n\t\tret = bq27xxx_battery_current_and_status(di, val, NULL, NULL);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CAPACITY:\n\t\tret = bq27xxx_simple_value(di->cache.capacity, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CAPACITY_LEVEL:\n\t\tret = bq27xxx_battery_capacity_level(di, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TEMP:\n\t\tret = bq27xxx_simple_value(di->cache.temperature, val);\n\t\tif (ret == 0)\n\t\t\tval->intval -= 2731;  \n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW:\n\t\tret = bq27xxx_simple_value(di->cache.time_to_empty, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TIME_TO_EMPTY_AVG:\n\t\tret = bq27xxx_simple_value(di->cache.time_to_empty_avg, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TIME_TO_FULL_NOW:\n\t\tret = bq27xxx_simple_value(di->cache.time_to_full, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tif (di->opts & BQ27XXX_O_MUL_CHEM)\n\t\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_UNKNOWN;\n\t\telse\n\t\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_NOW:\n\t\tif (di->regs[BQ27XXX_REG_NAC] != INVALID_REG_ADDR)\n\t\t\tret = bq27xxx_simple_value(bq27xxx_battery_read_nac(di), val);\n\t\telse\n\t\t\tret = bq27xxx_simple_value(bq27xxx_battery_read_rc(di), val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_FULL:\n\t\tret = bq27xxx_simple_value(di->cache.charge_full, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN:\n\t\tret = bq27xxx_simple_value(di->charge_design_full, val);\n\t\tbreak;\n\t \n\tcase POWER_SUPPLY_PROP_ENERGY_FULL_DESIGN:\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\n\t\treturn -EINVAL;\n\tcase POWER_SUPPLY_PROP_CYCLE_COUNT:\n\t\tret = bq27xxx_simple_value(di->cache.cycle_count, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_ENERGY_NOW:\n\t\tret = bq27xxx_simple_value(di->cache.energy, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_POWER_AVG:\n\t\tret = bq27xxx_battery_pwr_avg(di, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tret = bq27xxx_simple_value(di->cache.health, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_MANUFACTURER:\n\t\tval->strval = BQ27XXX_MANUFACTURER;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic void bq27xxx_external_power_changed(struct power_supply *psy)\n{\n\tstruct bq27xxx_device_info *di = power_supply_get_drvdata(psy);\n\n\t \n\tmod_delayed_work(system_wq, &di->work, HZ / 2);\n}\n\nint bq27xxx_battery_setup(struct bq27xxx_device_info *di)\n{\n\tstruct power_supply_desc *psy_desc;\n\tstruct power_supply_config psy_cfg = {\n\t\t.of_node = di->dev->of_node,\n\t\t.drv_data = di,\n\t};\n\n\tINIT_DELAYED_WORK(&di->work, bq27xxx_battery_poll);\n\tmutex_init(&di->lock);\n\n\tdi->regs       = bq27xxx_chip_data[di->chip].regs;\n\tdi->unseal_key = bq27xxx_chip_data[di->chip].unseal_key;\n\tdi->dm_regs    = bq27xxx_chip_data[di->chip].dm_regs;\n\tdi->opts       = bq27xxx_chip_data[di->chip].opts;\n\n\tpsy_desc = devm_kzalloc(di->dev, sizeof(*psy_desc), GFP_KERNEL);\n\tif (!psy_desc)\n\t\treturn -ENOMEM;\n\n\tpsy_desc->name = di->name;\n\tpsy_desc->type = POWER_SUPPLY_TYPE_BATTERY;\n\tpsy_desc->properties = bq27xxx_chip_data[di->chip].props;\n\tpsy_desc->num_properties = bq27xxx_chip_data[di->chip].props_size;\n\tpsy_desc->get_property = bq27xxx_battery_get_property;\n\tpsy_desc->external_power_changed = bq27xxx_external_power_changed;\n\n\tdi->bat = power_supply_register_no_ws(di->dev, psy_desc, &psy_cfg);\n\tif (IS_ERR(di->bat))\n\t\treturn dev_err_probe(di->dev, PTR_ERR(di->bat),\n\t\t\t\t     \"failed to register battery\\n\");\n\n\tbq27xxx_battery_settings(di);\n\tbq27xxx_battery_update(di);\n\n\tmutex_lock(&bq27xxx_list_lock);\n\tlist_add(&di->list, &bq27xxx_battery_devices);\n\tmutex_unlock(&bq27xxx_list_lock);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(bq27xxx_battery_setup);\n\nvoid bq27xxx_battery_teardown(struct bq27xxx_device_info *di)\n{\n\tmutex_lock(&bq27xxx_list_lock);\n\tlist_del(&di->list);\n\tmutex_unlock(&bq27xxx_list_lock);\n\n\t \n\tmutex_lock(&di->lock);\n\tdi->removed = true;\n\tmutex_unlock(&di->lock);\n\n\tcancel_delayed_work_sync(&di->work);\n\n\tpower_supply_unregister(di->bat);\n\tmutex_destroy(&di->lock);\n}\nEXPORT_SYMBOL_GPL(bq27xxx_battery_teardown);\n\nMODULE_AUTHOR(\"Rodolfo Giometti <giometti@linux.it>\");\nMODULE_DESCRIPTION(\"BQ27xxx battery monitor driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}