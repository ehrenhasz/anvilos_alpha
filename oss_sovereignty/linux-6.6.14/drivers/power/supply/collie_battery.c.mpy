{
  "module_name": "collie_battery.c",
  "hash_id": "511f1136550617031f9f985cf17f7e0c86f50bf6f6e0fa47b033810c020abb7e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/collie_battery.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/power_supply.h>\n#include <linux/delay.h>\n#include <linux/spinlock.h>\n#include <linux/interrupt.h>\n#include <linux/gpio/driver.h>\n#include <linux/gpio/machine.h>\n#include <linux/gpio/consumer.h>\n#include <linux/mfd/ucb1x00.h>\n\n#include <asm/mach/sharpsl_param.h>\n#include <asm/mach-types.h>\n#include <mach/collie.h>\n\nstatic DEFINE_MUTEX(bat_lock);  \nstatic struct work_struct bat_work;\nstatic struct ucb1x00 *ucb;\n\nstruct collie_bat {\n\tint status;\n\tstruct power_supply *psy;\n\tint full_chrg;\n\n\tstruct mutex work_lock;  \n\n\tbool (*is_present)(struct collie_bat *bat);\n\tstruct gpio_desc *gpio_full;\n\tstruct gpio_desc *gpio_charge_on;\n\n\tint technology;\n\n\tstruct gpio_desc *gpio_bat;\n\tint adc_bat;\n\tint adc_bat_divider;\n\tint bat_max;\n\tint bat_min;\n\n\tstruct gpio_desc *gpio_temp;\n\tint adc_temp;\n\tint adc_temp_divider;\n};\n\nstatic struct collie_bat collie_bat_main;\n\nstatic unsigned long collie_read_bat(struct collie_bat *bat)\n{\n\tunsigned long value = 0;\n\n\tif (!bat->gpio_bat || bat->adc_bat < 0)\n\t\treturn 0;\n\tmutex_lock(&bat_lock);\n\tgpiod_set_value(bat->gpio_bat, 1);\n\tmsleep(5);\n\tucb1x00_adc_enable(ucb);\n\tvalue = ucb1x00_adc_read(ucb, bat->adc_bat, UCB_SYNC);\n\tucb1x00_adc_disable(ucb);\n\tgpiod_set_value(bat->gpio_bat, 0);\n\tmutex_unlock(&bat_lock);\n\tvalue = value * 1000000 / bat->adc_bat_divider;\n\n\treturn value;\n}\n\nstatic unsigned long collie_read_temp(struct collie_bat *bat)\n{\n\tunsigned long value = 0;\n\tif (!bat->gpio_temp || bat->adc_temp < 0)\n\t\treturn 0;\n\n\tmutex_lock(&bat_lock);\n\tgpiod_set_value(bat->gpio_temp, 1);\n\tmsleep(5);\n\tucb1x00_adc_enable(ucb);\n\tvalue = ucb1x00_adc_read(ucb, bat->adc_temp, UCB_SYNC);\n\tucb1x00_adc_disable(ucb);\n\tgpiod_set_value(bat->gpio_temp, 0);\n\tmutex_unlock(&bat_lock);\n\n\tvalue = value * 10000 / bat->adc_temp_divider;\n\n\treturn value;\n}\n\nstatic int collie_bat_get_property(struct power_supply *psy,\n\t\t\t    enum power_supply_property psp,\n\t\t\t    union power_supply_propval *val)\n{\n\tint ret = 0;\n\tstruct collie_bat *bat = power_supply_get_drvdata(psy);\n\n\tif (bat->is_present && !bat->is_present(bat)\n\t\t\t&& psp != POWER_SUPPLY_PROP_PRESENT) {\n\t\treturn -ENODEV;\n\t}\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tval->intval = bat->status;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tval->intval = bat->technology;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tval->intval = collie_read_bat(bat);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MAX:\n\t\tif (bat->full_chrg == -1)\n\t\t\tval->intval = bat->bat_max;\n\t\telse\n\t\t\tval->intval = bat->full_chrg;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\n\t\tval->intval = bat->bat_max;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\n\t\tval->intval = bat->bat_min;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TEMP:\n\t\tval->intval = collie_read_temp(bat);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tval->intval = bat->is_present ? bat->is_present(bat) : 1;\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic void collie_bat_external_power_changed(struct power_supply *psy)\n{\n\tschedule_work(&bat_work);\n}\n\nstatic irqreturn_t collie_bat_gpio_isr(int irq, void *data)\n{\n\tpr_info(\"collie_bat_gpio irq\\n\");\n\tschedule_work(&bat_work);\n\treturn IRQ_HANDLED;\n}\n\nstatic void collie_bat_update(struct collie_bat *bat)\n{\n\tint old;\n\tstruct power_supply *psy = bat->psy;\n\n\tmutex_lock(&bat->work_lock);\n\n\told = bat->status;\n\n\tif (bat->is_present && !bat->is_present(bat)) {\n\t\tprintk(KERN_NOTICE \"%s not present\\n\", psy->desc->name);\n\t\tbat->status = POWER_SUPPLY_STATUS_UNKNOWN;\n\t\tbat->full_chrg = -1;\n\t} else if (power_supply_am_i_supplied(psy)) {\n\t\tif (bat->status == POWER_SUPPLY_STATUS_DISCHARGING) {\n\t\t\tgpiod_set_value(bat->gpio_charge_on, 1);\n\t\t\tmdelay(15);\n\t\t}\n\n\t\tif (gpiod_get_value(bat->gpio_full)) {\n\t\t\tif (old == POWER_SUPPLY_STATUS_CHARGING ||\n\t\t\t\t\tbat->full_chrg == -1)\n\t\t\t\tbat->full_chrg = collie_read_bat(bat);\n\n\t\t\tgpiod_set_value(bat->gpio_charge_on, 0);\n\t\t\tbat->status = POWER_SUPPLY_STATUS_FULL;\n\t\t} else {\n\t\t\tgpiod_set_value(bat->gpio_charge_on, 1);\n\t\t\tbat->status = POWER_SUPPLY_STATUS_CHARGING;\n\t\t}\n\t} else {\n\t\tgpiod_set_value(bat->gpio_charge_on, 0);\n\t\tbat->status = POWER_SUPPLY_STATUS_DISCHARGING;\n\t}\n\n\tif (old != bat->status)\n\t\tpower_supply_changed(psy);\n\n\tmutex_unlock(&bat->work_lock);\n}\n\nstatic void collie_bat_work(struct work_struct *work)\n{\n\tcollie_bat_update(&collie_bat_main);\n}\n\n\nstatic enum power_supply_property collie_bat_main_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_TEMP,\n};\n\nstatic enum power_supply_property collie_bat_bu_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX,\n\tPOWER_SUPPLY_PROP_PRESENT,\n};\n\nstatic const struct power_supply_desc collie_bat_main_desc = {\n\t.name\t\t= \"main-battery\",\n\t.type\t\t= POWER_SUPPLY_TYPE_BATTERY,\n\t.properties\t= collie_bat_main_props,\n\t.num_properties\t= ARRAY_SIZE(collie_bat_main_props),\n\t.get_property\t= collie_bat_get_property,\n\t.external_power_changed = collie_bat_external_power_changed,\n\t.use_for_apm\t= 1,\n};\n\nstatic struct collie_bat collie_bat_main = {\n\t.status = POWER_SUPPLY_STATUS_DISCHARGING,\n\t.full_chrg = -1,\n\t.psy = NULL,\n\n\t.gpio_full = NULL,\n\t.gpio_charge_on = NULL,\n\n\t.technology = POWER_SUPPLY_TECHNOLOGY_LIPO,\n\n\t.gpio_bat = NULL,\n\t.adc_bat = UCB_ADC_INP_AD1,\n\t.adc_bat_divider = 155,\n\t.bat_max = 4310000,\n\t.bat_min = 1551 * 1000000 / 414,\n\n\t.gpio_temp = NULL,\n\t.adc_temp = UCB_ADC_INP_AD0,\n\t.adc_temp_divider = 10000,\n};\n\nstatic const struct power_supply_desc collie_bat_bu_desc = {\n\t.name\t\t= \"backup-battery\",\n\t.type\t\t= POWER_SUPPLY_TYPE_BATTERY,\n\t.properties\t= collie_bat_bu_props,\n\t.num_properties\t= ARRAY_SIZE(collie_bat_bu_props),\n\t.get_property\t= collie_bat_get_property,\n\t.external_power_changed = collie_bat_external_power_changed,\n};\n\nstatic struct collie_bat collie_bat_bu = {\n\t.status = POWER_SUPPLY_STATUS_UNKNOWN,\n\t.full_chrg = -1,\n\t.psy = NULL,\n\n\t.gpio_full = NULL,\n\t.gpio_charge_on = NULL,\n\n\t.technology = POWER_SUPPLY_TECHNOLOGY_LiMn,\n\n\t.gpio_bat = NULL,\n\t.adc_bat = UCB_ADC_INP_AD1,\n\t.adc_bat_divider = 155,\n\t.bat_max = 3000000,\n\t.bat_min = 1900000,\n\n\t.gpio_temp = NULL,\n\t.adc_temp = -1,\n\t.adc_temp_divider = -1,\n};\n\n \nstatic struct gpio_desc *collie_mbat_low;\n\n#ifdef CONFIG_PM\nstatic int wakeup_enabled;\n\nstatic int collie_bat_suspend(struct ucb1x00_dev *dev)\n{\n\t \n\tflush_work(&bat_work);\n\n\tif (device_may_wakeup(&dev->ucb->dev) &&\n\t    collie_bat_main.status == POWER_SUPPLY_STATUS_CHARGING)\n\t\twakeup_enabled = !enable_irq_wake(gpiod_to_irq(collie_bat_main.gpio_full));\n\telse\n\t\twakeup_enabled = 0;\n\n\treturn 0;\n}\n\nstatic int collie_bat_resume(struct ucb1x00_dev *dev)\n{\n\tif (wakeup_enabled)\n\t\tdisable_irq_wake(gpiod_to_irq(collie_bat_main.gpio_full));\n\n\t \n\tschedule_work(&bat_work);\n\treturn 0;\n}\n#else\n#define collie_bat_suspend NULL\n#define collie_bat_resume NULL\n#endif\n\nstatic int collie_bat_probe(struct ucb1x00_dev *dev)\n{\n\tint ret;\n\tstruct power_supply_config psy_main_cfg = {}, psy_bu_cfg = {};\n\tstruct gpio_chip *gc = &dev->ucb->gpio;\n\n\tif (!machine_is_collie())\n\t\treturn -ENODEV;\n\n\tucb = dev->ucb;\n\n\t \n\tcollie_bat_main.gpio_full = gpiod_get(&dev->ucb->dev,\n\t\t\t\t\t      \"main battery full\",\n\t\t\t\t\t      GPIOD_IN);\n\tif (IS_ERR(collie_bat_main.gpio_full))\n\t\treturn PTR_ERR(collie_bat_main.gpio_full);\n\n\tcollie_mbat_low = gpiod_get(&dev->ucb->dev,\n\t\t\t\t    \"main battery low\",\n\t\t\t\t    GPIOD_IN);\n\tif (IS_ERR(collie_mbat_low)) {\n\t\tret = PTR_ERR(collie_mbat_low);\n\t\tgoto err_put_gpio_full;\n\t}\n\n\tcollie_bat_main.gpio_charge_on = gpiod_get(&dev->ucb->dev,\n\t\t\t\t\t\t   \"main charge on\",\n\t\t\t\t\t\t   GPIOD_OUT_LOW);\n\tif (IS_ERR(collie_bat_main.gpio_charge_on)) {\n\t\tret = PTR_ERR(collie_bat_main.gpio_charge_on);\n\t\tgoto err_put_mbat_low;\n\t}\n\n\t \n\tcollie_bat_main.gpio_bat = gpiochip_request_own_desc(gc,\n\t\t\t\t\t\t7,\n\t\t\t\t\t\t\"main battery\",\n\t\t\t\t\t\tGPIO_ACTIVE_HIGH,\n\t\t\t\t\t\tGPIOD_OUT_LOW);\n\tif (IS_ERR(collie_bat_main.gpio_bat)) {\n\t\tret = PTR_ERR(collie_bat_main.gpio_bat);\n\t\tgoto err_put_gpio_charge_on;\n\t}\n\n\t \n\tcollie_bat_main.gpio_temp = gpiochip_request_own_desc(gc,\n\t\t\t\t\t\t9,\n\t\t\t\t\t\t\"main battery temp\",\n\t\t\t\t\t\tGPIO_ACTIVE_HIGH,\n\t\t\t\t\t\tGPIOD_OUT_LOW);\n\tif (IS_ERR(collie_bat_main.gpio_temp)) {\n\t\tret = PTR_ERR(collie_bat_main.gpio_temp);\n\t\tgoto err_free_gpio_bat;\n\t}\n\n\t \n\tcollie_bat_bu.gpio_bat = gpiochip_request_own_desc(gc,\n\t\t\t\t\t\t8,\n\t\t\t\t\t\t\"backup battery\",\n\t\t\t\t\t\tGPIO_ACTIVE_HIGH,\n\t\t\t\t\t\tGPIOD_OUT_LOW);\n\tif (IS_ERR(collie_bat_bu.gpio_bat)) {\n\t\tret = PTR_ERR(collie_bat_bu.gpio_bat);\n\t\tgoto err_free_gpio_temp;\n\t}\n\n\tmutex_init(&collie_bat_main.work_lock);\n\n\tINIT_WORK(&bat_work, collie_bat_work);\n\n\tpsy_main_cfg.drv_data = &collie_bat_main;\n\tcollie_bat_main.psy = power_supply_register(&dev->ucb->dev,\n\t\t\t\t\t\t    &collie_bat_main_desc,\n\t\t\t\t\t\t    &psy_main_cfg);\n\tif (IS_ERR(collie_bat_main.psy)) {\n\t\tret = PTR_ERR(collie_bat_main.psy);\n\t\tgoto err_psy_reg_main;\n\t}\n\n\tpsy_bu_cfg.drv_data = &collie_bat_bu;\n\tcollie_bat_bu.psy = power_supply_register(&dev->ucb->dev,\n\t\t\t\t\t\t  &collie_bat_bu_desc,\n\t\t\t\t\t\t  &psy_bu_cfg);\n\tif (IS_ERR(collie_bat_bu.psy)) {\n\t\tret = PTR_ERR(collie_bat_bu.psy);\n\t\tgoto err_psy_reg_bu;\n\t}\n\n\tret = request_irq(gpiod_to_irq(collie_bat_main.gpio_full),\n\t\t\t\tcollie_bat_gpio_isr,\n\t\t\t\tIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\n\t\t\t\t\"main full\", &collie_bat_main);\n\tif (ret)\n\t\tgoto err_irq;\n\n\tdevice_init_wakeup(&ucb->dev, 1);\n\tschedule_work(&bat_work);\n\n\treturn 0;\n\nerr_irq:\n\tpower_supply_unregister(collie_bat_bu.psy);\nerr_psy_reg_bu:\n\tpower_supply_unregister(collie_bat_main.psy);\nerr_psy_reg_main:\n\t \n\tcancel_work_sync(&bat_work);\n\tgpiochip_free_own_desc(collie_bat_bu.gpio_bat);\nerr_free_gpio_temp:\n\tgpiochip_free_own_desc(collie_bat_main.gpio_temp);\nerr_free_gpio_bat:\n\tgpiochip_free_own_desc(collie_bat_main.gpio_bat);\nerr_put_gpio_charge_on:\n\tgpiod_put(collie_bat_main.gpio_charge_on);\nerr_put_mbat_low:\n\tgpiod_put(collie_mbat_low);\nerr_put_gpio_full:\n\tgpiod_put(collie_bat_main.gpio_full);\n\n\treturn ret;\n}\n\nstatic void collie_bat_remove(struct ucb1x00_dev *dev)\n{\n\tfree_irq(gpiod_to_irq(collie_bat_main.gpio_full), &collie_bat_main);\n\tpower_supply_unregister(collie_bat_bu.psy);\n\tpower_supply_unregister(collie_bat_main.psy);\n\n\t \n\tgpiod_put(collie_bat_main.gpio_full);\n\tgpiod_put(collie_mbat_low);\n\tgpiod_put(collie_bat_main.gpio_charge_on);\n\t \n\tgpiochip_free_own_desc(collie_bat_main.gpio_bat);\n\tgpiochip_free_own_desc(collie_bat_main.gpio_temp);\n\tgpiochip_free_own_desc(collie_bat_bu.gpio_bat);\n\t \n\tcancel_work_sync(&bat_work);\n}\n\nstatic struct ucb1x00_driver collie_bat_driver = {\n\t.add\t\t= collie_bat_probe,\n\t.remove\t\t= collie_bat_remove,\n\t.suspend\t= collie_bat_suspend,\n\t.resume\t\t= collie_bat_resume,\n};\n\nstatic int __init collie_bat_init(void)\n{\n\treturn ucb1x00_register_driver(&collie_bat_driver);\n}\n\nstatic void __exit collie_bat_exit(void)\n{\n\tucb1x00_unregister_driver(&collie_bat_driver);\n}\n\nmodule_init(collie_bat_init);\nmodule_exit(collie_bat_exit);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Thomas Kunze\");\nMODULE_DESCRIPTION(\"Collie battery driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}