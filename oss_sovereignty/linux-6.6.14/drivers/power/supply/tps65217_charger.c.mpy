{
  "module_name": "tps65217_charger.c",
  "hash_id": "be3ae2b7f8d2dde191b6cb2df750563d4243899696e470db98569d4c3fad9c41",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/tps65217_charger.c",
  "human_readable_source": "\n\n\n\n\n\n \n#include <linux/kernel.h>\n#include <linux/kthread.h>\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/slab.h>\n#include <linux/err.h>\n#include <linux/of.h>\n#include <linux/power_supply.h>\n\n#include <linux/mfd/core.h>\n#include <linux/mfd/tps65217.h>\n\n#define CHARGER_STATUS_PRESENT\t(TPS65217_STATUS_ACPWR | TPS65217_STATUS_USBPWR)\n#define NUM_CHARGER_IRQS\t2\n#define POLL_INTERVAL\t\t(HZ * 2)\n\nstruct tps65217_charger {\n\tstruct tps65217 *tps;\n\tstruct device *dev;\n\tstruct power_supply *psy;\n\n\tint\tonline;\n\tint\tprev_online;\n\n\tstruct task_struct\t*poll_task;\n};\n\nstatic enum power_supply_property tps65217_charger_props[] = {\n\tPOWER_SUPPLY_PROP_ONLINE,\n};\n\nstatic int tps65217_config_charger(struct tps65217_charger *charger)\n{\n\tint ret;\n\n\t \n\tret = tps65217_clear_bits(charger->tps, TPS65217_REG_CHGCONFIG1,\n\t\t\t\t  TPS65217_CHGCONFIG1_NTC_TYPE,\n\t\t\t\t  TPS65217_PROTECT_NONE);\n\tif (ret) {\n\t\tdev_err(charger->dev,\n\t\t\t\"failed to set 100k NTC setting: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int tps65217_enable_charging(struct tps65217_charger *charger)\n{\n\tint ret;\n\n\t \n\tif (charger->online)\n\t\treturn 0;\n\n\tdev_dbg(charger->dev, \"%s: enable charging\\n\", __func__);\n\tret = tps65217_set_bits(charger->tps, TPS65217_REG_CHGCONFIG1,\n\t\t\t\tTPS65217_CHGCONFIG1_CHG_EN,\n\t\t\t\tTPS65217_CHGCONFIG1_CHG_EN,\n\t\t\t\tTPS65217_PROTECT_NONE);\n\tif (ret) {\n\t\tdev_err(charger->dev,\n\t\t\t\"%s: Error in writing CHG_EN in reg 0x%x: %d\\n\",\n\t\t\t__func__, TPS65217_REG_CHGCONFIG1, ret);\n\t\treturn ret;\n\t}\n\n\tcharger->online = 1;\n\n\treturn 0;\n}\n\nstatic int tps65217_charger_get_property(struct power_supply *psy,\n\t\t\t\t\t enum power_supply_property psp,\n\t\t\t\t\t union power_supply_propval *val)\n{\n\tstruct tps65217_charger *charger = power_supply_get_drvdata(psy);\n\n\tif (psp == POWER_SUPPLY_PROP_ONLINE) {\n\t\tval->intval = charger->online;\n\t\treturn 0;\n\t}\n\treturn -EINVAL;\n}\n\nstatic irqreturn_t tps65217_charger_irq(int irq, void *dev)\n{\n\tint ret, val;\n\tstruct tps65217_charger *charger = dev;\n\n\tcharger->prev_online = charger->online;\n\n\tret = tps65217_reg_read(charger->tps, TPS65217_REG_STATUS, &val);\n\tif (ret < 0) {\n\t\tdev_err(charger->dev, \"%s: Error in reading reg 0x%x\\n\",\n\t\t\t__func__, TPS65217_REG_STATUS);\n\t\treturn IRQ_HANDLED;\n\t}\n\n\tdev_dbg(charger->dev, \"%s: 0x%x\\n\", __func__, val);\n\n\t \n\tif (val & CHARGER_STATUS_PRESENT) {\n\t\tret = tps65217_enable_charging(charger);\n\t\tif (ret) {\n\t\t\tdev_err(charger->dev,\n\t\t\t\t\"failed to enable charger: %d\\n\", ret);\n\t\t\treturn IRQ_HANDLED;\n\t\t}\n\t} else {\n\t\tcharger->online = 0;\n\t}\n\n\tif (charger->prev_online != charger->online)\n\t\tpower_supply_changed(charger->psy);\n\n\tret = tps65217_reg_read(charger->tps, TPS65217_REG_CHGCONFIG0, &val);\n\tif (ret < 0) {\n\t\tdev_err(charger->dev, \"%s: Error in reading reg 0x%x\\n\",\n\t\t\t__func__, TPS65217_REG_CHGCONFIG0);\n\t\treturn IRQ_HANDLED;\n\t}\n\n\tif (val & TPS65217_CHGCONFIG0_ACTIVE)\n\t\tdev_dbg(charger->dev, \"%s: charger is charging\\n\", __func__);\n\telse\n\t\tdev_dbg(charger->dev,\n\t\t\t\"%s: charger is NOT charging\\n\", __func__);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int tps65217_charger_poll_task(void *data)\n{\n\tset_freezable();\n\n\twhile (!kthread_should_stop()) {\n\t\tschedule_timeout_interruptible(POLL_INTERVAL);\n\t\ttry_to_freeze();\n\t\ttps65217_charger_irq(-1, data);\n\t}\n\treturn 0;\n}\n\nstatic const struct power_supply_desc tps65217_charger_desc = {\n\t.name\t\t\t= \"tps65217-charger\",\n\t.type\t\t\t= POWER_SUPPLY_TYPE_MAINS,\n\t.get_property\t\t= tps65217_charger_get_property,\n\t.properties\t\t= tps65217_charger_props,\n\t.num_properties\t\t= ARRAY_SIZE(tps65217_charger_props),\n};\n\nstatic int tps65217_charger_probe(struct platform_device *pdev)\n{\n\tstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\n\tstruct tps65217_charger *charger;\n\tstruct power_supply_config cfg = {};\n\tstruct task_struct *poll_task;\n\tint irq[NUM_CHARGER_IRQS];\n\tint ret;\n\tint i;\n\n\tcharger = devm_kzalloc(&pdev->dev, sizeof(*charger), GFP_KERNEL);\n\tif (!charger)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, charger);\n\tcharger->tps = tps;\n\tcharger->dev = &pdev->dev;\n\n\tcfg.of_node = pdev->dev.of_node;\n\tcfg.drv_data = charger;\n\n\tcharger->psy = devm_power_supply_register(&pdev->dev,\n\t\t\t\t\t\t  &tps65217_charger_desc,\n\t\t\t\t\t\t  &cfg);\n\tif (IS_ERR(charger->psy)) {\n\t\tdev_err(&pdev->dev, \"failed: power supply register\\n\");\n\t\treturn PTR_ERR(charger->psy);\n\t}\n\n\tirq[0] = platform_get_irq_byname(pdev, \"USB\");\n\tirq[1] = platform_get_irq_byname(pdev, \"AC\");\n\n\tret = tps65217_config_charger(charger);\n\tif (ret < 0) {\n\t\tdev_err(charger->dev, \"charger config failed, err %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tif (irq[0] < 0 || irq[1] < 0) {\n\t\tpoll_task = kthread_run(tps65217_charger_poll_task,\n\t\t\t\t\tcharger, \"ktps65217charger\");\n\t\tif (IS_ERR(poll_task)) {\n\t\t\tret = PTR_ERR(poll_task);\n\t\t\tdev_err(charger->dev,\n\t\t\t\t\"Unable to run kthread err %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tcharger->poll_task = poll_task;\n\t\treturn 0;\n\t}\n\n\t \n\tfor (i = 0; i < NUM_CHARGER_IRQS; i++) {\n\t\tret = devm_request_threaded_irq(&pdev->dev, irq[i], NULL,\n\t\t\t\t\t\ttps65217_charger_irq,\n\t\t\t\t\t\tIRQF_ONESHOT, \"tps65217-charger\",\n\t\t\t\t\t\tcharger);\n\t\tif (ret) {\n\t\t\tdev_err(charger->dev,\n\t\t\t\t\"Unable to register irq %d err %d\\n\", irq[i],\n\t\t\t\tret);\n\t\t\treturn ret;\n\t\t}\n\n\t\t \n\t\ttps65217_charger_irq(-1, charger);\n\t}\n\n\treturn 0;\n}\n\nstatic int tps65217_charger_remove(struct platform_device *pdev)\n{\n\tstruct tps65217_charger *charger = platform_get_drvdata(pdev);\n\n\tif (charger->poll_task)\n\t\tkthread_stop(charger->poll_task);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id tps65217_charger_match_table[] = {\n\t{ .compatible = \"ti,tps65217-charger\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, tps65217_charger_match_table);\n\nstatic struct platform_driver tps65217_charger_driver = {\n\t.probe\t= tps65217_charger_probe,\n\t.remove = tps65217_charger_remove,\n\t.driver\t= {\n\t\t.name\t= \"tps65217-charger\",\n\t\t.of_match_table = of_match_ptr(tps65217_charger_match_table),\n\t},\n\n};\nmodule_platform_driver(tps65217_charger_driver);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Enric Balletbo Serra <enric.balletbo@collabora.com>\");\nMODULE_DESCRIPTION(\"TPS65217 battery charger driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}