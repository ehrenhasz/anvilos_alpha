{
  "module_name": "rn5t618_power.c",
  "hash_id": "96ab5d0c4f8b69f5ed51eb554e5caeb0e6cadabf69fce48973ea8c10456f5345",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/rn5t618_power.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/device.h>\n#include <linux/bitops.h>\n#include <linux/errno.h>\n#include <linux/iio/consumer.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/mfd/rn5t618.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/regmap.h>\n#include <linux/slab.h>\n\n#define CHG_STATE_ADP_INPUT 0x40\n#define CHG_STATE_USB_INPUT 0x80\n#define CHG_STATE_MASK\t0x1f\n#define CHG_STATE_CHG_OFF\t0\n#define CHG_STATE_CHG_READY_VADP\t1\n#define CHG_STATE_CHG_TRICKLE\t2\n#define CHG_STATE_CHG_RAPID\t3\n#define CHG_STATE_CHG_COMPLETE\t4\n#define CHG_STATE_SUSPEND\t5\n#define CHG_STATE_VCHG_OVER_VOL\t6\n#define CHG_STATE_BAT_ERROR\t7\n#define CHG_STATE_NO_BAT\t8\n#define CHG_STATE_BAT_OVER_VOL\t9\n#define CHG_STATE_BAT_TEMP_ERR\t10\n#define CHG_STATE_DIE_ERR\t11\n#define CHG_STATE_DIE_SHUTDOWN\t12\n#define CHG_STATE_NO_BAT2\t13\n#define CHG_STATE_CHG_READY_VUSB\t14\n\n#define GCHGDET_TYPE_MASK 0x30\n#define GCHGDET_TYPE_SDP 0x00\n#define GCHGDET_TYPE_CDP 0x10\n#define GCHGDET_TYPE_DCP 0x20\n\n#define FG_ENABLE 1\n\n \n#define TO_CUR_REG(x) ((x) / 100000 - 1)\n#define FROM_CUR_REG(x) ((((x) & 0x1f) + 1) * 100000)\n#define CHG_MIN_CUR 100000\n#define CHG_MAX_CUR 1800000\n#define ADP_MAX_CUR 2500000\n#define USB_MAX_CUR 1400000\n\n\nstruct rn5t618_power_info {\n\tstruct rn5t618 *rn5t618;\n\tstruct platform_device *pdev;\n\tstruct power_supply *battery;\n\tstruct power_supply *usb;\n\tstruct power_supply *adp;\n\tstruct iio_channel *channel_vusb;\n\tstruct iio_channel *channel_vadp;\n\tint irq;\n};\n\nstatic enum power_supply_usb_type rn5t618_usb_types[] = {\n\tPOWER_SUPPLY_USB_TYPE_SDP,\n\tPOWER_SUPPLY_USB_TYPE_DCP,\n\tPOWER_SUPPLY_USB_TYPE_CDP,\n\tPOWER_SUPPLY_USB_TYPE_UNKNOWN\n};\n\nstatic enum power_supply_property rn5t618_usb_props[] = {\n\t \n\tPOWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_USB_TYPE,\n\tPOWER_SUPPLY_PROP_ONLINE,\n};\n\nstatic enum power_supply_property rn5t618_adp_props[] = {\n\t \n\tPOWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_ONLINE,\n};\n\n\nstatic enum power_supply_property rn5t618_battery_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n\tPOWER_SUPPLY_PROP_TIME_TO_FULL_NOW,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_CONTROL_LIMIT,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n};\n\nstatic int rn5t618_battery_read_doublereg(struct rn5t618_power_info *info,\n\t\t\t\t\t  u8 reg, u16 *result)\n{\n\tint ret, i;\n\tu8 data[2];\n\tu16 old, new;\n\n\told = 0;\n\t \n\tfor (i = 0; i < 3; i++) {\n\t\tret = regmap_bulk_read(info->rn5t618->regmap,\n\t\t\t\t       reg, data, sizeof(data));\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tnew = data[0] << 8;\n\t\tnew |= data[1];\n\t\tif (new == old)\n\t\t\tbreak;\n\n\t\told = new;\n\t}\n\n\t*result = new;\n\n\treturn 0;\n}\n\nstatic int rn5t618_decode_status(unsigned int status)\n{\n\tswitch (status & CHG_STATE_MASK) {\n\tcase CHG_STATE_CHG_OFF:\n\tcase CHG_STATE_SUSPEND:\n\tcase CHG_STATE_VCHG_OVER_VOL:\n\tcase CHG_STATE_DIE_SHUTDOWN:\n\t\treturn POWER_SUPPLY_STATUS_DISCHARGING;\n\n\tcase CHG_STATE_CHG_TRICKLE:\n\tcase CHG_STATE_CHG_RAPID:\n\t\treturn POWER_SUPPLY_STATUS_CHARGING;\n\n\tcase CHG_STATE_CHG_COMPLETE:\n\t\treturn POWER_SUPPLY_STATUS_FULL;\n\n\tdefault:\n\t\treturn POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t}\n}\n\nstatic int rn5t618_battery_status(struct rn5t618_power_info *info,\n\t\t\t\t  union power_supply_propval *val)\n{\n\tunsigned int v;\n\tint ret;\n\n\tret = regmap_read(info->rn5t618->regmap, RN5T618_CHGSTATE, &v);\n\tif (ret)\n\t\treturn ret;\n\n\tval->intval = POWER_SUPPLY_STATUS_UNKNOWN;\n\n\tif (v & 0xc0) {  \n\t\tval->intval = rn5t618_decode_status(v);\n\t} else\n\t\tval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\n\n\treturn ret;\n}\n\nstatic int rn5t618_battery_present(struct rn5t618_power_info *info,\n\t\t\t\t   union power_supply_propval *val)\n{\n\tunsigned int v;\n\tint ret;\n\n\tret = regmap_read(info->rn5t618->regmap, RN5T618_CHGSTATE, &v);\n\tif (ret)\n\t\treturn ret;\n\n\tv &= CHG_STATE_MASK;\n\tif ((v == CHG_STATE_NO_BAT) || (v == CHG_STATE_NO_BAT2))\n\t\tval->intval = 0;\n\telse\n\t\tval->intval = 1;\n\n\treturn ret;\n}\n\nstatic int rn5t618_battery_voltage_now(struct rn5t618_power_info *info,\n\t\t\t\t       union power_supply_propval *val)\n{\n\tu16 res;\n\tint ret;\n\n\tret = rn5t618_battery_read_doublereg(info, RN5T618_VOLTAGE_1, &res);\n\tif (ret)\n\t\treturn ret;\n\n\tval->intval = res * 2 * 2500 / 4095 * 1000;\n\n\treturn 0;\n}\n\nstatic int rn5t618_battery_current_now(struct rn5t618_power_info *info,\n\t\t\t\t       union power_supply_propval *val)\n{\n\tu16 res;\n\tint ret;\n\n\tret = rn5t618_battery_read_doublereg(info, RN5T618_CC_AVEREG1, &res);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tval->intval = sign_extend32(res, 13) * 1000;\n\n\treturn 0;\n}\n\nstatic int rn5t618_battery_capacity(struct rn5t618_power_info *info,\n\t\t\t\t    union power_supply_propval *val)\n{\n\tunsigned int v;\n\tint ret;\n\n\tret = regmap_read(info->rn5t618->regmap, RN5T618_SOC, &v);\n\tif (ret)\n\t\treturn ret;\n\n\tval->intval = v;\n\n\treturn 0;\n}\n\nstatic int rn5t618_battery_temp(struct rn5t618_power_info *info,\n\t\t\t\tunion power_supply_propval *val)\n{\n\tu16 res;\n\tint ret;\n\n\tret = rn5t618_battery_read_doublereg(info, RN5T618_TEMP_1, &res);\n\tif (ret)\n\t\treturn ret;\n\n\tval->intval = sign_extend32(res, 11) * 10 / 16;\n\n\treturn 0;\n}\n\nstatic int rn5t618_battery_tte(struct rn5t618_power_info *info,\n\t\t\t       union power_supply_propval *val)\n{\n\tu16 res;\n\tint ret;\n\n\tret = rn5t618_battery_read_doublereg(info, RN5T618_TT_EMPTY_H, &res);\n\tif (ret)\n\t\treturn ret;\n\n\tif (res == 65535)\n\t\treturn -ENODATA;\n\n\tval->intval = res * 60;\n\n\treturn 0;\n}\n\nstatic int rn5t618_battery_ttf(struct rn5t618_power_info *info,\n\t\t\t       union power_supply_propval *val)\n{\n\tu16 res;\n\tint ret;\n\n\tret = rn5t618_battery_read_doublereg(info, RN5T618_TT_FULL_H, &res);\n\tif (ret)\n\t\treturn ret;\n\n\tif (res == 65535)\n\t\treturn -ENODATA;\n\n\tval->intval = res * 60;\n\n\treturn 0;\n}\n\nstatic int rn5t618_battery_set_current_limit(struct rn5t618_power_info *info,\n\t\t\t\tconst union power_supply_propval *val)\n{\n\tif (val->intval < CHG_MIN_CUR)\n\t\treturn -EINVAL;\n\n\tif (val->intval >= CHG_MAX_CUR)\n\t\treturn -EINVAL;\n\n\treturn regmap_update_bits(info->rn5t618->regmap,\n\t\t\t\t  RN5T618_CHGISET,\n\t\t\t\t  0x1F, TO_CUR_REG(val->intval));\n}\n\nstatic int rn5t618_battery_get_current_limit(struct rn5t618_power_info *info,\n\t\t\t\t\t     union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->rn5t618->regmap, RN5T618_CHGISET,\n\t\t\t  &regval);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tval->intval = FROM_CUR_REG(regval);\n\n\treturn 0;\n}\n\nstatic int rn5t618_battery_charge_full(struct rn5t618_power_info *info,\n\t\t\t\t       union power_supply_propval *val)\n{\n\tu16 res;\n\tint ret;\n\n\tret = rn5t618_battery_read_doublereg(info, RN5T618_FA_CAP_H, &res);\n\tif (ret)\n\t\treturn ret;\n\n\tval->intval = res * 1000;\n\n\treturn 0;\n}\n\nstatic int rn5t618_battery_charge_now(struct rn5t618_power_info *info,\n\t\t\t\t      union power_supply_propval *val)\n{\n\tu16 res;\n\tint ret;\n\n\tret = rn5t618_battery_read_doublereg(info, RN5T618_RE_CAP_H, &res);\n\tif (ret)\n\t\treturn ret;\n\n\tval->intval = res * 1000;\n\n\treturn 0;\n}\n\nstatic int rn5t618_battery_get_property(struct power_supply *psy,\n\t\t\t\t\tenum power_supply_property psp,\n\t\t\t\t\tunion power_supply_propval *val)\n{\n\tint ret = 0;\n\tstruct rn5t618_power_info *info = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tret = rn5t618_battery_status(info, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tret = rn5t618_battery_present(info, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tret = rn5t618_battery_voltage_now(info, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_NOW:\n\t\tret = rn5t618_battery_current_now(info, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CAPACITY:\n\t\tret = rn5t618_battery_capacity(info, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TEMP:\n\t\tret = rn5t618_battery_temp(info, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW:\n\t\tret = rn5t618_battery_tte(info, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TIME_TO_FULL_NOW:\n\t\tret = rn5t618_battery_ttf(info, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_CONTROL_LIMIT:\n\t\tret = rn5t618_battery_get_current_limit(info, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_FULL:\n\t\tret = rn5t618_battery_charge_full(info, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_NOW:\n\t\tret = rn5t618_battery_charge_now(info, val);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic int rn5t618_battery_set_property(struct power_supply *psy,\n\t\t\t\t\tenum power_supply_property psp,\n\t\t\t\t\tconst union power_supply_propval *val)\n{\n\tstruct rn5t618_power_info *info = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_CHARGE_CONTROL_LIMIT:\n\t\treturn rn5t618_battery_set_current_limit(info, val);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int rn5t618_battery_property_is_writeable(struct power_supply *psy,\n\t\t\t\t\t\tenum power_supply_property psp)\n{\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_CHARGE_CONTROL_LIMIT:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic int rn5t618_adp_get_property(struct power_supply *psy,\n\t\t\t\t    enum power_supply_property psp,\n\t\t\t\t    union power_supply_propval *val)\n{\n\tstruct rn5t618_power_info *info = power_supply_get_drvdata(psy);\n\tunsigned int chgstate;\n\tunsigned int regval;\n\tbool online;\n\tint ret;\n\n\tret = regmap_read(info->rn5t618->regmap, RN5T618_CHGSTATE, &chgstate);\n\tif (ret)\n\t\treturn ret;\n\n\tonline = !!(chgstate & CHG_STATE_ADP_INPUT);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = online;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tif (!online) {\n\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\t\tbreak;\n\t\t}\n\t\tval->intval = rn5t618_decode_status(chgstate);\n\t\tif (val->intval != POWER_SUPPLY_STATUS_CHARGING)\n\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\t\tret = regmap_read(info->rn5t618->regmap,\n\t\t\t\t  RN5T618_REGISET1, &regval);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tval->intval = FROM_CUR_REG(regval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tif (!info->channel_vadp)\n\t\t\treturn -ENODATA;\n\n\t\tret = iio_read_channel_processed_scale(info->channel_vadp, &val->intval, 1000);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int rn5t618_adp_set_property(struct power_supply *psy,\n\t\t\t\t    enum power_supply_property psp,\n\t\t\t\t    const union power_supply_propval *val)\n{\n\tstruct rn5t618_power_info *info = power_supply_get_drvdata(psy);\n\tint ret;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\t\tif (val->intval > ADP_MAX_CUR)\n\t\t\treturn -EINVAL;\n\n\t\tif (val->intval < CHG_MIN_CUR)\n\t\t\treturn -EINVAL;\n\n\t\tret = regmap_write(info->rn5t618->regmap, RN5T618_REGISET1,\n\t\t\t\t   TO_CUR_REG(val->intval));\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int rn5t618_adp_property_is_writeable(struct power_supply *psy,\n\t\t\t\t\t     enum power_supply_property psp)\n{\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic int rc5t619_usb_get_type(struct rn5t618_power_info *info,\n\t\t\t\tunion power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->rn5t618->regmap, RN5T618_GCHGDET, &regval);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tswitch (regval & GCHGDET_TYPE_MASK) {\n\tcase GCHGDET_TYPE_SDP:\n\t\tval->intval = POWER_SUPPLY_USB_TYPE_SDP;\n\t\tbreak;\n\tcase GCHGDET_TYPE_CDP:\n\t\tval->intval = POWER_SUPPLY_USB_TYPE_CDP;\n\t\tbreak;\n\tcase GCHGDET_TYPE_DCP:\n\t\tval->intval = POWER_SUPPLY_USB_TYPE_DCP;\n\t\tbreak;\n\tdefault:\n\t\tval->intval = POWER_SUPPLY_USB_TYPE_UNKNOWN;\n\t}\n\n\treturn 0;\n}\n\nstatic int rn5t618_usb_get_property(struct power_supply *psy,\n\t\t\t\t    enum power_supply_property psp,\n\t\t\t\t    union power_supply_propval *val)\n{\n\tstruct rn5t618_power_info *info = power_supply_get_drvdata(psy);\n\tunsigned int chgstate;\n\tunsigned int regval;\n\tbool online;\n\tint ret;\n\n\tret = regmap_read(info->rn5t618->regmap, RN5T618_CHGSTATE, &chgstate);\n\tif (ret)\n\t\treturn ret;\n\n\tonline = !!(chgstate & CHG_STATE_USB_INPUT);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = online;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tif (!online) {\n\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\t\tbreak;\n\t\t}\n\t\tval->intval = rn5t618_decode_status(chgstate);\n\t\tif (val->intval != POWER_SUPPLY_STATUS_CHARGING)\n\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_USB_TYPE:\n\t\tif (!online || (info->rn5t618->variant != RC5T619))\n\t\t\treturn -ENODATA;\n\n\t\treturn rc5t619_usb_get_type(info, val);\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\t\tret = regmap_read(info->rn5t618->regmap, RN5T618_CHGCTL1,\n\t\t\t\t  &regval);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tval->intval = 0;\n\t\tif (regval & 2) {\n\t\t\tret = regmap_read(info->rn5t618->regmap,\n\t\t\t\t\t  RN5T618_REGISET2,\n\t\t\t\t\t  &regval);\n\t\t\tif (ret < 0)\n\t\t\t\treturn ret;\n\n\t\t\tval->intval = FROM_CUR_REG(regval);\n\t\t}\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tif (!info->channel_vusb)\n\t\t\treturn -ENODATA;\n\n\t\tret = iio_read_channel_processed_scale(info->channel_vusb, &val->intval, 1000);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int rn5t618_usb_set_property(struct power_supply *psy,\n\t\t\t\t    enum power_supply_property psp,\n\t\t\t\t    const union power_supply_propval *val)\n{\n\tstruct rn5t618_power_info *info = power_supply_get_drvdata(psy);\n\tint ret;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\t\tif (val->intval > USB_MAX_CUR)\n\t\t\treturn -EINVAL;\n\n\t\tif (val->intval < CHG_MIN_CUR)\n\t\t\treturn -EINVAL;\n\n\t\tret = regmap_write(info->rn5t618->regmap, RN5T618_REGISET2,\n\t\t\t\t   0xE0 | TO_CUR_REG(val->intval));\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int rn5t618_usb_property_is_writeable(struct power_supply *psy,\n\t\t\t\t\t     enum power_supply_property psp)\n{\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic const struct power_supply_desc rn5t618_battery_desc = {\n\t.name                   = \"rn5t618-battery\",\n\t.type                   = POWER_SUPPLY_TYPE_BATTERY,\n\t.properties             = rn5t618_battery_props,\n\t.num_properties         = ARRAY_SIZE(rn5t618_battery_props),\n\t.get_property           = rn5t618_battery_get_property,\n\t.set_property           = rn5t618_battery_set_property,\n\t.property_is_writeable  = rn5t618_battery_property_is_writeable,\n};\n\nstatic const struct power_supply_desc rn5t618_adp_desc = {\n\t.name                   = \"rn5t618-adp\",\n\t.type                   = POWER_SUPPLY_TYPE_MAINS,\n\t.properties             = rn5t618_adp_props,\n\t.num_properties         = ARRAY_SIZE(rn5t618_adp_props),\n\t.get_property           = rn5t618_adp_get_property,\n\t.set_property           = rn5t618_adp_set_property,\n\t.property_is_writeable  = rn5t618_adp_property_is_writeable,\n};\n\nstatic const struct power_supply_desc rn5t618_usb_desc = {\n\t.name                   = \"rn5t618-usb\",\n\t.type                   = POWER_SUPPLY_TYPE_USB,\n\t.usb_types\t\t= rn5t618_usb_types,\n\t.num_usb_types\t\t= ARRAY_SIZE(rn5t618_usb_types),\n\t.properties             = rn5t618_usb_props,\n\t.num_properties         = ARRAY_SIZE(rn5t618_usb_props),\n\t.get_property           = rn5t618_usb_get_property,\n\t.set_property           = rn5t618_usb_set_property,\n\t.property_is_writeable  = rn5t618_usb_property_is_writeable,\n};\n\nstatic irqreturn_t rn5t618_charger_irq(int irq, void *data)\n{\n\tstruct device *dev = data;\n\tstruct rn5t618_power_info *info = dev_get_drvdata(dev);\n\n\tunsigned int ctrl, stat1, stat2, err;\n\n\tregmap_read(info->rn5t618->regmap, RN5T618_CHGERR_IRR, &err);\n\tregmap_read(info->rn5t618->regmap, RN5T618_CHGCTRL_IRR, &ctrl);\n\tregmap_read(info->rn5t618->regmap, RN5T618_CHGSTAT_IRR1, &stat1);\n\tregmap_read(info->rn5t618->regmap, RN5T618_CHGSTAT_IRR2, &stat2);\n\n\tregmap_write(info->rn5t618->regmap, RN5T618_CHGERR_IRR, 0);\n\tregmap_write(info->rn5t618->regmap, RN5T618_CHGCTRL_IRR, 0);\n\tregmap_write(info->rn5t618->regmap, RN5T618_CHGSTAT_IRR1, 0);\n\tregmap_write(info->rn5t618->regmap, RN5T618_CHGSTAT_IRR2, 0);\n\n\tdev_dbg(dev, \"chgerr: %x chgctrl: %x chgstat: %x chgstat2: %x\\n\",\n\t\terr, ctrl, stat1, stat2);\n\n\tpower_supply_changed(info->usb);\n\tpower_supply_changed(info->adp);\n\tpower_supply_changed(info->battery);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int rn5t618_power_probe(struct platform_device *pdev)\n{\n\tint ret = 0;\n\tunsigned int v;\n\tstruct power_supply_config psy_cfg = {};\n\tstruct rn5t618_power_info *info;\n\n\tinfo = devm_kzalloc(&pdev->dev, sizeof(*info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tinfo->pdev = pdev;\n\tinfo->rn5t618 = dev_get_drvdata(pdev->dev.parent);\n\tinfo->irq = -1;\n\n\tplatform_set_drvdata(pdev, info);\n\n\tinfo->channel_vusb = devm_iio_channel_get(&pdev->dev, \"vusb\");\n\tif (IS_ERR(info->channel_vusb)) {\n\t\tif (PTR_ERR(info->channel_vusb) == -ENODEV)\n\t\t\treturn -EPROBE_DEFER;\n\t\treturn PTR_ERR(info->channel_vusb);\n\t}\n\n\tinfo->channel_vadp = devm_iio_channel_get(&pdev->dev, \"vadp\");\n\tif (IS_ERR(info->channel_vadp)) {\n\t\tif (PTR_ERR(info->channel_vadp) == -ENODEV)\n\t\t\treturn -EPROBE_DEFER;\n\t\treturn PTR_ERR(info->channel_vadp);\n\t}\n\n\tret = regmap_read(info->rn5t618->regmap, RN5T618_CONTROL, &v);\n\tif (ret)\n\t\treturn ret;\n\n\tif (!(v & FG_ENABLE)) {\n\t\t \n\t\tdev_info(&pdev->dev, \"Fuel gauge not enabled, enabling now\\n\");\n\t\tdev_info(&pdev->dev, \"Expect imprecise results\\n\");\n\t\tregmap_update_bits(info->rn5t618->regmap, RN5T618_CONTROL,\n\t\t\t\t   FG_ENABLE, FG_ENABLE);\n\t}\n\n\tpsy_cfg.drv_data = info;\n\tinfo->battery = devm_power_supply_register(&pdev->dev,\n\t\t\t\t\t\t   &rn5t618_battery_desc,\n\t\t\t\t\t\t   &psy_cfg);\n\tif (IS_ERR(info->battery)) {\n\t\tret = PTR_ERR(info->battery);\n\t\tdev_err(&pdev->dev, \"failed to register battery: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tinfo->adp = devm_power_supply_register(&pdev->dev,\n\t\t\t\t\t       &rn5t618_adp_desc,\n\t\t\t\t\t       &psy_cfg);\n\tif (IS_ERR(info->adp)) {\n\t\tret = PTR_ERR(info->adp);\n\t\tdev_err(&pdev->dev, \"failed to register adp: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tinfo->usb = devm_power_supply_register(&pdev->dev,\n\t\t\t\t\t       &rn5t618_usb_desc,\n\t\t\t\t\t       &psy_cfg);\n\tif (IS_ERR(info->usb)) {\n\t\tret = PTR_ERR(info->usb);\n\t\tdev_err(&pdev->dev, \"failed to register usb: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tif (info->rn5t618->irq_data)\n\t\tinfo->irq = regmap_irq_get_virq(info->rn5t618->irq_data,\n\t\t\t\t\t\tRN5T618_IRQ_CHG);\n\n\tif (info->irq < 0)\n\t\tinfo->irq = -1;\n\telse {\n\t\tret = devm_request_threaded_irq(&pdev->dev, info->irq, NULL,\n\t\t\t\t\t\trn5t618_charger_irq,\n\t\t\t\t\t\tIRQF_ONESHOT,\n\t\t\t\t\t\t\"rn5t618_power\",\n\t\t\t\t\t\t&pdev->dev);\n\n\t\tif (ret < 0) {\n\t\t\tdev_err(&pdev->dev, \"request IRQ:%d fail\\n\",\n\t\t\t\tinfo->irq);\n\t\t\tinfo->irq = -1;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver rn5t618_power_driver = {\n\t.driver = {\n\t\t.name   = \"rn5t618-power\",\n\t},\n\t.probe = rn5t618_power_probe,\n};\n\nmodule_platform_driver(rn5t618_power_driver);\nMODULE_ALIAS(\"platform:rn5t618-power\");\nMODULE_DESCRIPTION(\"Power supply driver for RICOH RN5T618\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}