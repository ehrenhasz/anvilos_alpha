{
  "module_name": "rt9455_charger.c",
  "hash_id": "9d93e1e915413892303cd918e0be2fd4cd593244d8626e03478e370921c89034",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/rt9455_charger.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/interrupt.h>\n#include <linux/delay.h>\n#include <linux/of.h>\n#include <linux/pm_runtime.h>\n#include <linux/power_supply.h>\n#include <linux/i2c.h>\n#include <linux/acpi.h>\n#include <linux/usb/phy.h>\n#include <linux/regmap.h>\n\n#define RT9455_MANUFACTURER\t\t\t\"Richtek\"\n#define RT9455_MODEL_NAME\t\t\t\"RT9455\"\n#define RT9455_DRIVER_NAME\t\t\t\"rt9455-charger\"\n\n#define RT9455_IRQ_NAME\t\t\t\t\"interrupt\"\n\n#define RT9455_PWR_RDY_DELAY\t\t\t1  \n#define RT9455_MAX_CHARGING_TIME\t\t21600  \n#define RT9455_BATT_PRESENCE_DELAY\t\t60  \n\n#define RT9455_CHARGE_MODE\t\t\t0x00\n#define RT9455_BOOST_MODE\t\t\t0x01\n\n#define RT9455_FAULT\t\t\t\t0x03\n\n#define RT9455_IAICR_100MA\t\t\t0x00\n#define RT9455_IAICR_500MA\t\t\t0x01\n#define RT9455_IAICR_NO_LIMIT\t\t\t0x03\n\n#define RT9455_CHARGE_DISABLE\t\t\t0x00\n#define RT9455_CHARGE_ENABLE\t\t\t0x01\n\n#define RT9455_PWR_FAULT\t\t\t0x00\n#define RT9455_PWR_GOOD\t\t\t\t0x01\n\n#define RT9455_REG_CTRL1\t\t\t0x00  \n#define RT9455_REG_CTRL2\t\t\t0x01  \n#define RT9455_REG_CTRL3\t\t\t0x02  \n#define RT9455_REG_DEV_ID\t\t\t0x03  \n#define RT9455_REG_CTRL4\t\t\t0x04  \n#define RT9455_REG_CTRL5\t\t\t0x05  \n#define RT9455_REG_CTRL6\t\t\t0x06  \n#define RT9455_REG_CTRL7\t\t\t0x07  \n#define RT9455_REG_IRQ1\t\t\t\t0x08  \n#define RT9455_REG_IRQ2\t\t\t\t0x09  \n#define RT9455_REG_IRQ3\t\t\t\t0x0A  \n#define RT9455_REG_MASK1\t\t\t0x0B  \n#define RT9455_REG_MASK2\t\t\t0x0C  \n#define RT9455_REG_MASK3\t\t\t0x0D  \n\nenum rt9455_fields {\n\tF_STAT, F_BOOST, F_PWR_RDY, F_OTG_PIN_POLARITY,  \n\n\tF_IAICR, F_TE_SHDN_EN, F_HIGHER_OCP, F_TE, F_IAICR_INT, F_HIZ,\n\tF_OPA_MODE,  \n\n\tF_VOREG, F_OTG_PL, F_OTG_EN,  \n\n\tF_VENDOR_ID, F_CHIP_REV,  \n\n\tF_RST,  \n\n\tF_TMR_EN, F_MIVR, F_IPREC, F_IEOC_PERCENTAGE,  \n\n\tF_IAICR_SEL, F_ICHRG, F_VPREC,  \n\n\tF_BATD_EN, F_CHG_EN, F_VMREG,  \n\n\tF_TSDI, F_VINOVPI, F_BATAB,  \n\n\tF_CHRVPI, F_CHBATOVI, F_CHTERMI, F_CHRCHGI, F_CH32MI, F_CHTREGI,\n\tF_CHMIVRI,  \n\n\tF_BSTBUSOVI, F_BSTOLI, F_BSTLOWVI, F_BST32SI,  \n\n\tF_TSDM, F_VINOVPIM, F_BATABM,  \n\n\tF_CHRVPIM, F_CHBATOVIM, F_CHTERMIM, F_CHRCHGIM, F_CH32MIM, F_CHTREGIM,\n\tF_CHMIVRIM,  \n\n\tF_BSTVINOVIM, F_BSTOLIM, F_BSTLOWVIM, F_BST32SIM,  \n\n\tF_MAX_FIELDS\n};\n\nstatic const struct reg_field rt9455_reg_fields[] = {\n\t[F_STAT]\t\t= REG_FIELD(RT9455_REG_CTRL1, 4, 5),\n\t[F_BOOST]\t\t= REG_FIELD(RT9455_REG_CTRL1, 3, 3),\n\t[F_PWR_RDY]\t\t= REG_FIELD(RT9455_REG_CTRL1, 2, 2),\n\t[F_OTG_PIN_POLARITY]\t= REG_FIELD(RT9455_REG_CTRL1, 1, 1),\n\n\t[F_IAICR]\t\t= REG_FIELD(RT9455_REG_CTRL2, 6, 7),\n\t[F_TE_SHDN_EN]\t\t= REG_FIELD(RT9455_REG_CTRL2, 5, 5),\n\t[F_HIGHER_OCP]\t\t= REG_FIELD(RT9455_REG_CTRL2, 4, 4),\n\t[F_TE]\t\t\t= REG_FIELD(RT9455_REG_CTRL2, 3, 3),\n\t[F_IAICR_INT]\t\t= REG_FIELD(RT9455_REG_CTRL2, 2, 2),\n\t[F_HIZ]\t\t\t= REG_FIELD(RT9455_REG_CTRL2, 1, 1),\n\t[F_OPA_MODE]\t\t= REG_FIELD(RT9455_REG_CTRL2, 0, 0),\n\n\t[F_VOREG]\t\t= REG_FIELD(RT9455_REG_CTRL3, 2, 7),\n\t[F_OTG_PL]\t\t= REG_FIELD(RT9455_REG_CTRL3, 1, 1),\n\t[F_OTG_EN]\t\t= REG_FIELD(RT9455_REG_CTRL3, 0, 0),\n\n\t[F_VENDOR_ID]\t\t= REG_FIELD(RT9455_REG_DEV_ID, 4, 7),\n\t[F_CHIP_REV]\t\t= REG_FIELD(RT9455_REG_DEV_ID, 0, 3),\n\n\t[F_RST]\t\t\t= REG_FIELD(RT9455_REG_CTRL4, 7, 7),\n\n\t[F_TMR_EN]\t\t= REG_FIELD(RT9455_REG_CTRL5, 7, 7),\n\t[F_MIVR]\t\t= REG_FIELD(RT9455_REG_CTRL5, 4, 5),\n\t[F_IPREC]\t\t= REG_FIELD(RT9455_REG_CTRL5, 2, 3),\n\t[F_IEOC_PERCENTAGE]\t= REG_FIELD(RT9455_REG_CTRL5, 0, 1),\n\n\t[F_IAICR_SEL]\t\t= REG_FIELD(RT9455_REG_CTRL6, 7, 7),\n\t[F_ICHRG]\t\t= REG_FIELD(RT9455_REG_CTRL6, 4, 6),\n\t[F_VPREC]\t\t= REG_FIELD(RT9455_REG_CTRL6, 0, 2),\n\n\t[F_BATD_EN]\t\t= REG_FIELD(RT9455_REG_CTRL7, 6, 6),\n\t[F_CHG_EN]\t\t= REG_FIELD(RT9455_REG_CTRL7, 4, 4),\n\t[F_VMREG]\t\t= REG_FIELD(RT9455_REG_CTRL7, 0, 3),\n\n\t[F_TSDI]\t\t= REG_FIELD(RT9455_REG_IRQ1, 7, 7),\n\t[F_VINOVPI]\t\t= REG_FIELD(RT9455_REG_IRQ1, 6, 6),\n\t[F_BATAB]\t\t= REG_FIELD(RT9455_REG_IRQ1, 0, 0),\n\n\t[F_CHRVPI]\t\t= REG_FIELD(RT9455_REG_IRQ2, 7, 7),\n\t[F_CHBATOVI]\t\t= REG_FIELD(RT9455_REG_IRQ2, 5, 5),\n\t[F_CHTERMI]\t\t= REG_FIELD(RT9455_REG_IRQ2, 4, 4),\n\t[F_CHRCHGI]\t\t= REG_FIELD(RT9455_REG_IRQ2, 3, 3),\n\t[F_CH32MI]\t\t= REG_FIELD(RT9455_REG_IRQ2, 2, 2),\n\t[F_CHTREGI]\t\t= REG_FIELD(RT9455_REG_IRQ2, 1, 1),\n\t[F_CHMIVRI]\t\t= REG_FIELD(RT9455_REG_IRQ2, 0, 0),\n\n\t[F_BSTBUSOVI]\t\t= REG_FIELD(RT9455_REG_IRQ3, 7, 7),\n\t[F_BSTOLI]\t\t= REG_FIELD(RT9455_REG_IRQ3, 6, 6),\n\t[F_BSTLOWVI]\t\t= REG_FIELD(RT9455_REG_IRQ3, 5, 5),\n\t[F_BST32SI]\t\t= REG_FIELD(RT9455_REG_IRQ3, 3, 3),\n\n\t[F_TSDM]\t\t= REG_FIELD(RT9455_REG_MASK1, 7, 7),\n\t[F_VINOVPIM]\t\t= REG_FIELD(RT9455_REG_MASK1, 6, 6),\n\t[F_BATABM]\t\t= REG_FIELD(RT9455_REG_MASK1, 0, 0),\n\n\t[F_CHRVPIM]\t\t= REG_FIELD(RT9455_REG_MASK2, 7, 7),\n\t[F_CHBATOVIM]\t\t= REG_FIELD(RT9455_REG_MASK2, 5, 5),\n\t[F_CHTERMIM]\t\t= REG_FIELD(RT9455_REG_MASK2, 4, 4),\n\t[F_CHRCHGIM]\t\t= REG_FIELD(RT9455_REG_MASK2, 3, 3),\n\t[F_CH32MIM]\t\t= REG_FIELD(RT9455_REG_MASK2, 2, 2),\n\t[F_CHTREGIM]\t\t= REG_FIELD(RT9455_REG_MASK2, 1, 1),\n\t[F_CHMIVRIM]\t\t= REG_FIELD(RT9455_REG_MASK2, 0, 0),\n\n\t[F_BSTVINOVIM]\t\t= REG_FIELD(RT9455_REG_MASK3, 7, 7),\n\t[F_BSTOLIM]\t\t= REG_FIELD(RT9455_REG_MASK3, 6, 6),\n\t[F_BSTLOWVIM]\t\t= REG_FIELD(RT9455_REG_MASK3, 5, 5),\n\t[F_BST32SIM]\t\t= REG_FIELD(RT9455_REG_MASK3, 3, 3),\n};\n\n#define GET_MASK(fid)\t(BIT(rt9455_reg_fields[fid].msb + 1) - \\\n\t\t\t BIT(rt9455_reg_fields[fid].lsb))\n\n \n \nstatic const int rt9455_ichrg_values[] = {\n\t 500000,  650000,  800000,  950000, 1100000, 1250000, 1400000, 1550000\n};\n\n \n \nstatic const int rt9455_voreg_values[] = {\n\t3500000, 3520000, 3540000, 3560000, 3580000, 3600000, 3620000, 3640000,\n\t3660000, 3680000, 3700000, 3720000, 3740000, 3760000, 3780000, 3800000,\n\t3820000, 3840000, 3860000, 3880000, 3900000, 3920000, 3940000, 3960000,\n\t3980000, 4000000, 4020000, 4040000, 4060000, 4080000, 4100000, 4120000,\n\t4140000, 4160000, 4180000, 4200000, 4220000, 4240000, 4260000, 4280000,\n\t4300000, 4330000, 4350000, 4370000, 4390000, 4410000, 4430000, 4450000,\n\t4450000, 4450000, 4450000, 4450000, 4450000, 4450000, 4450000, 4450000,\n\t4450000, 4450000, 4450000, 4450000, 4450000, 4450000, 4450000, 4450000\n};\n\n \n \nstatic const int rt9455_boost_voltage_values[] = {\n\t4425000, 4450000, 4475000, 4500000, 4525000, 4550000, 4575000, 4600000,\n\t4625000, 4650000, 4675000, 4700000, 4725000, 4750000, 4775000, 4800000,\n\t4825000, 4850000, 4875000, 4900000, 4925000, 4950000, 4975000, 5000000,\n\t5025000, 5050000, 5075000, 5100000, 5125000, 5150000, 5175000, 5200000,\n\t5225000, 5250000, 5275000, 5300000, 5325000, 5350000, 5375000, 5400000,\n\t5425000, 5450000, 5475000, 5500000, 5525000, 5550000, 5575000, 5600000,\n\t5600000, 5600000, 5600000, 5600000, 5600000, 5600000, 5600000, 5600000,\n\t5600000, 5600000, 5600000, 5600000, 5600000, 5600000, 5600000, 5600000,\n};\n\n \nstatic const int rt9455_vmreg_values[] = {\n\t4200000, 4220000, 4240000, 4260000, 4280000, 4300000, 4320000, 4340000,\n\t4360000, 4380000, 4400000, 4430000, 4450000, 4450000, 4450000, 4450000\n};\n\n \nstatic const int rt9455_ieoc_percentage_values[] = {\n\t10, 30, 20, 30\n};\n\n \nstatic const int rt9455_mivr_values[] = {\n\t4000000, 4250000, 4500000, 5000000\n};\n\n \nstatic const int rt9455_iaicr_values[] = {\n\t100000, 500000, 1000000, 2000000\n};\n\nstruct rt9455_info {\n\tstruct i2c_client\t\t*client;\n\tstruct regmap\t\t\t*regmap;\n\tstruct regmap_field\t\t*regmap_fields[F_MAX_FIELDS];\n\tstruct power_supply\t\t*charger;\n#if IS_ENABLED(CONFIG_USB_PHY)\n\tstruct usb_phy\t\t\t*usb_phy;\n\tstruct notifier_block\t\tnb;\n#endif\n\tstruct delayed_work\t\tpwr_rdy_work;\n\tstruct delayed_work\t\tmax_charging_time_work;\n\tstruct delayed_work\t\tbatt_presence_work;\n\tu32\t\t\t\tvoreg;\n\tu32\t\t\t\tboost_voltage;\n};\n\n \nstatic unsigned int rt9455_find_idx(const int tbl[], int tbl_size, int v)\n{\n\tint i;\n\n\t \n\tfor (i = 0; i < tbl_size - 1; i++)\n\t\tif (v <= tbl[i])\n\t\t\treturn i;\n\n\treturn (tbl_size - 1);\n}\n\nstatic int rt9455_get_field_val(struct rt9455_info *info,\n\t\t\t\tenum rt9455_fields field,\n\t\t\t\tconst int tbl[], int tbl_size, int *val)\n{\n\tunsigned int v;\n\tint ret;\n\n\tret = regmap_field_read(info->regmap_fields[field], &v);\n\tif (ret)\n\t\treturn ret;\n\n\tv = (v >= tbl_size) ? (tbl_size - 1) : v;\n\t*val = tbl[v];\n\n\treturn 0;\n}\n\nstatic int rt9455_set_field_val(struct rt9455_info *info,\n\t\t\t\tenum rt9455_fields field,\n\t\t\t\tconst int tbl[], int tbl_size, int val)\n{\n\tunsigned int idx = rt9455_find_idx(tbl, tbl_size, val);\n\n\treturn regmap_field_write(info->regmap_fields[field], idx);\n}\n\nstatic int rt9455_register_reset(struct rt9455_info *info)\n{\n\tstruct device *dev = &info->client->dev;\n\tunsigned int v;\n\tint ret, limit = 100;\n\n\tret = regmap_field_write(info->regmap_fields[F_RST], 0x01);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set RST bit\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tdo {\n\t\tret = regmap_field_read(info->regmap_fields[F_RST], &v);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to read RST bit\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (!v)\n\t\t\tbreak;\n\n\t\tusleep_range(10, 100);\n\t} while (--limit);\n\n\tif (!limit)\n\t\treturn -EIO;\n\n\treturn 0;\n}\n\n \nstatic enum power_supply_property rt9455_charger_properties[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX,\n\tPOWER_SUPPLY_PROP_SCOPE,\n\tPOWER_SUPPLY_PROP_CHARGE_TERM_CURRENT,\n\tPOWER_SUPPLY_PROP_MODEL_NAME,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n};\n\nstatic char *rt9455_charger_supplied_to[] = {\n\t\"main-battery\",\n};\n\nstatic int rt9455_charger_get_status(struct rt9455_info *info,\n\t\t\t\t     union power_supply_propval *val)\n{\n\tunsigned int v, pwr_rdy;\n\tint ret;\n\n\tret = regmap_field_read(info->regmap_fields[F_PWR_RDY],\n\t\t\t\t&pwr_rdy);\n\tif (ret) {\n\t\tdev_err(&info->client->dev, \"Failed to read PWR_RDY bit\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tif (!pwr_rdy) {\n\t\tval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\n\t\treturn 0;\n\t}\n\n\tret = regmap_field_read(info->regmap_fields[F_STAT], &v);\n\tif (ret) {\n\t\tdev_err(&info->client->dev, \"Failed to read STAT bits\\n\");\n\t\treturn ret;\n\t}\n\n\tswitch (v) {\n\tcase 0:\n\t\t \n\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\treturn 0;\n\tcase 1:\n\t\tval->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\treturn 0;\n\tcase 2:\n\t\tval->intval = POWER_SUPPLY_STATUS_FULL;\n\t\treturn 0;\n\tdefault:\n\t\tval->intval = POWER_SUPPLY_STATUS_UNKNOWN;\n\t\treturn 0;\n\t}\n}\n\nstatic int rt9455_charger_get_health(struct rt9455_info *info,\n\t\t\t\t     union power_supply_propval *val)\n{\n\tstruct device *dev = &info->client->dev;\n\tunsigned int v;\n\tint ret;\n\n\tval->intval = POWER_SUPPLY_HEALTH_GOOD;\n\n\tret = regmap_read(info->regmap, RT9455_REG_IRQ1, &v);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read IRQ1 register\\n\");\n\t\treturn ret;\n\t}\n\n\tif (v & GET_MASK(F_TSDI)) {\n\t\tval->intval = POWER_SUPPLY_HEALTH_OVERHEAT;\n\t\treturn 0;\n\t}\n\tif (v & GET_MASK(F_VINOVPI)) {\n\t\tval->intval = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\n\t\treturn 0;\n\t}\n\tif (v & GET_MASK(F_BATAB)) {\n\t\tval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\t\treturn 0;\n\t}\n\n\tret = regmap_read(info->regmap, RT9455_REG_IRQ2, &v);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read IRQ2 register\\n\");\n\t\treturn ret;\n\t}\n\n\tif (v & GET_MASK(F_CHBATOVI)) {\n\t\tval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\t\treturn 0;\n\t}\n\tif (v & GET_MASK(F_CH32MI)) {\n\t\tval->intval = POWER_SUPPLY_HEALTH_SAFETY_TIMER_EXPIRE;\n\t\treturn 0;\n\t}\n\n\tret = regmap_read(info->regmap, RT9455_REG_IRQ3, &v);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read IRQ3 register\\n\");\n\t\treturn ret;\n\t}\n\n\tif (v & GET_MASK(F_BSTBUSOVI)) {\n\t\tval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\t\treturn 0;\n\t}\n\tif (v & GET_MASK(F_BSTOLI)) {\n\t\tval->intval = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\n\t\treturn 0;\n\t}\n\tif (v & GET_MASK(F_BSTLOWVI)) {\n\t\tval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\t\treturn 0;\n\t}\n\tif (v & GET_MASK(F_BST32SI)) {\n\t\tval->intval = POWER_SUPPLY_HEALTH_SAFETY_TIMER_EXPIRE;\n\t\treturn 0;\n\t}\n\n\tret = regmap_field_read(info->regmap_fields[F_STAT], &v);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read STAT bits\\n\");\n\t\treturn ret;\n\t}\n\n\tif (v == RT9455_FAULT) {\n\t\tval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\t\treturn 0;\n\t}\n\n\treturn 0;\n}\n\nstatic int rt9455_charger_get_battery_presence(struct rt9455_info *info,\n\t\t\t\t\t       union power_supply_propval *val)\n{\n\tunsigned int v;\n\tint ret;\n\n\tret = regmap_field_read(info->regmap_fields[F_BATAB], &v);\n\tif (ret) {\n\t\tdev_err(&info->client->dev, \"Failed to read BATAB bit\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tval->intval = !v;\n\n\treturn 0;\n}\n\nstatic int rt9455_charger_get_online(struct rt9455_info *info,\n\t\t\t\t     union power_supply_propval *val)\n{\n\tunsigned int v;\n\tint ret;\n\n\tret = regmap_field_read(info->regmap_fields[F_PWR_RDY], &v);\n\tif (ret) {\n\t\tdev_err(&info->client->dev, \"Failed to read PWR_RDY bit\\n\");\n\t\treturn ret;\n\t}\n\n\tval->intval = (int)v;\n\n\treturn 0;\n}\n\nstatic int rt9455_charger_get_current(struct rt9455_info *info,\n\t\t\t\t      union power_supply_propval *val)\n{\n\tint curr;\n\tint ret;\n\n\tret = rt9455_get_field_val(info, F_ICHRG,\n\t\t\t\t   rt9455_ichrg_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_ichrg_values),\n\t\t\t\t   &curr);\n\tif (ret) {\n\t\tdev_err(&info->client->dev, \"Failed to read ICHRG value\\n\");\n\t\treturn ret;\n\t}\n\n\tval->intval = curr;\n\n\treturn 0;\n}\n\nstatic int rt9455_charger_get_current_max(struct rt9455_info *info,\n\t\t\t\t\t  union power_supply_propval *val)\n{\n\tint idx = ARRAY_SIZE(rt9455_ichrg_values) - 1;\n\n\tval->intval = rt9455_ichrg_values[idx];\n\n\treturn 0;\n}\n\nstatic int rt9455_charger_get_voltage(struct rt9455_info *info,\n\t\t\t\t      union power_supply_propval *val)\n{\n\tint voltage;\n\tint ret;\n\n\tret = rt9455_get_field_val(info, F_VOREG,\n\t\t\t\t   rt9455_voreg_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_voreg_values),\n\t\t\t\t   &voltage);\n\tif (ret) {\n\t\tdev_err(&info->client->dev, \"Failed to read VOREG value\\n\");\n\t\treturn ret;\n\t}\n\n\tval->intval = voltage;\n\n\treturn 0;\n}\n\nstatic int rt9455_charger_get_voltage_max(struct rt9455_info *info,\n\t\t\t\t\t  union power_supply_propval *val)\n{\n\tint idx = ARRAY_SIZE(rt9455_vmreg_values) - 1;\n\n\tval->intval = rt9455_vmreg_values[idx];\n\n\treturn 0;\n}\n\nstatic int rt9455_charger_get_term_current(struct rt9455_info *info,\n\t\t\t\t\t   union power_supply_propval *val)\n{\n\tstruct device *dev = &info->client->dev;\n\tint ichrg, ieoc_percentage, ret;\n\n\tret = rt9455_get_field_val(info, F_ICHRG,\n\t\t\t\t   rt9455_ichrg_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_ichrg_values),\n\t\t\t\t   &ichrg);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read ICHRG value\\n\");\n\t\treturn ret;\n\t}\n\n\tret = rt9455_get_field_val(info, F_IEOC_PERCENTAGE,\n\t\t\t\t   rt9455_ieoc_percentage_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_ieoc_percentage_values),\n\t\t\t\t   &ieoc_percentage);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read IEOC value\\n\");\n\t\treturn ret;\n\t}\n\n\tval->intval = ichrg * ieoc_percentage / 100;\n\n\treturn 0;\n}\n\nstatic int rt9455_charger_get_property(struct power_supply *psy,\n\t\t\t\t       enum power_supply_property psp,\n\t\t\t\t       union power_supply_propval *val)\n{\n\tstruct rt9455_info *info = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\treturn rt9455_charger_get_status(info, val);\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\treturn rt9455_charger_get_health(info, val);\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\treturn rt9455_charger_get_battery_presence(info, val);\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\treturn rt9455_charger_get_online(info, val);\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT:\n\t\treturn rt9455_charger_get_current(info, val);\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:\n\t\treturn rt9455_charger_get_current_max(info, val);\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE:\n\t\treturn rt9455_charger_get_voltage(info, val);\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX:\n\t\treturn rt9455_charger_get_voltage_max(info, val);\n\tcase POWER_SUPPLY_PROP_SCOPE:\n\t\tval->intval = POWER_SUPPLY_SCOPE_SYSTEM;\n\t\treturn 0;\n\tcase POWER_SUPPLY_PROP_CHARGE_TERM_CURRENT:\n\t\treturn rt9455_charger_get_term_current(info, val);\n\tcase POWER_SUPPLY_PROP_MODEL_NAME:\n\t\tval->strval = RT9455_MODEL_NAME;\n\t\treturn 0;\n\tcase POWER_SUPPLY_PROP_MANUFACTURER:\n\t\tval->strval = RT9455_MANUFACTURER;\n\t\treturn 0;\n\tdefault:\n\t\treturn -ENODATA;\n\t}\n}\n\nstatic int rt9455_hw_init(struct rt9455_info *info, u32 ichrg,\n\t\t\t  u32 ieoc_percentage,\n\t\t\t  u32 mivr, u32 iaicr)\n{\n\tstruct device *dev = &info->client->dev;\n\tint idx, ret;\n\n\tret = rt9455_register_reset(info);\n\tif (ret) {\n\t\tdev_err(dev, \"Power On Reset failed\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_field_write(info->regmap_fields[F_TE], 1);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set TE bit\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_field_write(info->regmap_fields[F_TE_SHDN_EN], 1);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set TE_SHDN_EN bit\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_field_write(info->regmap_fields[F_BATD_EN], 1);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set BATD_EN bit\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_field_write(info->regmap_fields[F_TMR_EN], 0x00);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to disable Safety Timer\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = rt9455_set_field_val(info, F_ICHRG,\n\t\t\t\t   rt9455_ichrg_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_ichrg_values), ichrg);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set ICHRG value\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = rt9455_set_field_val(info, F_IEOC_PERCENTAGE,\n\t\t\t\t   rt9455_ieoc_percentage_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_ieoc_percentage_values),\n\t\t\t\t   ieoc_percentage);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set IEOC Percentage value\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = rt9455_set_field_val(info, F_VOREG,\n\t\t\t\t   rt9455_voreg_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_voreg_values),\n\t\t\t\t   info->voreg);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set VOREG value\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tidx = ARRAY_SIZE(rt9455_vmreg_values) - 1;\n\tret = rt9455_set_field_val(info, F_VMREG,\n\t\t\t\t   rt9455_vmreg_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_vmreg_values),\n\t\t\t\t   rt9455_vmreg_values[idx]);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set VMREG value\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tif (mivr == -1)\n\t\tmivr = 4500000;\n\n\tret = rt9455_set_field_val(info, F_MIVR,\n\t\t\t\t   rt9455_mivr_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_mivr_values), mivr);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set MIVR value\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tif (iaicr == -1)\n\t\tiaicr = 500000;\n\n\tret = rt9455_set_field_val(info, F_IAICR,\n\t\t\t\t   rt9455_iaicr_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_iaicr_values), iaicr);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set IAICR value\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_field_write(info->regmap_fields[F_IAICR_INT], 0x01);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set IAICR_INT bit\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = regmap_field_write(info->regmap_fields[F_CHMIVRIM], 0x01);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to mask CHMIVRI interrupt\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\n#if IS_ENABLED(CONFIG_USB_PHY)\n \nstatic int rt9455_set_boost_voltage_before_boost_mode(struct rt9455_info *info)\n{\n\tstruct device *dev = &info->client->dev;\n\tint ret;\n\n\tret = rt9455_set_field_val(info, F_VOREG,\n\t\t\t\t   rt9455_boost_voltage_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_boost_voltage_values),\n\t\t\t\t   info->boost_voltage);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set boost output voltage value\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n#endif\n\n \nstatic int rt9455_set_voreg_before_charge_mode(struct rt9455_info *info)\n{\n\tstruct device *dev = &info->client->dev;\n\tint ret;\n\n\tret = rt9455_set_field_val(info, F_VOREG,\n\t\t\t\t   rt9455_voreg_values,\n\t\t\t\t   ARRAY_SIZE(rt9455_voreg_values),\n\t\t\t\t   info->voreg);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set VOREG value\\n\");\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int rt9455_irq_handler_check_irq1_register(struct rt9455_info *info,\n\t\t\t\t\t\t  bool *_is_battery_absent,\n\t\t\t\t\t\t  bool *_alert_userspace)\n{\n\tunsigned int irq1, mask1, mask2;\n\tstruct device *dev = &info->client->dev;\n\tbool is_battery_absent = false;\n\tbool alert_userspace = false;\n\tint ret;\n\n\tret = regmap_read(info->regmap, RT9455_REG_IRQ1, &irq1);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read IRQ1 register\\n\");\n\t\treturn ret;\n\t}\n\n\tret = regmap_read(info->regmap, RT9455_REG_MASK1, &mask1);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read MASK1 register\\n\");\n\t\treturn ret;\n\t}\n\n\tif (irq1 & GET_MASK(F_TSDI)) {\n\t\tdev_err(dev, \"Thermal shutdown fault occurred\\n\");\n\t\talert_userspace = true;\n\t}\n\n\tif (irq1 & GET_MASK(F_VINOVPI)) {\n\t\tdev_err(dev, \"Overvoltage input occurred\\n\");\n\t\talert_userspace = true;\n\t}\n\n\tif (irq1 & GET_MASK(F_BATAB)) {\n\t\tdev_err(dev, \"Battery absence occurred\\n\");\n\t\tis_battery_absent = true;\n\t\talert_userspace = true;\n\n\t\tif ((mask1 & GET_MASK(F_BATABM)) == 0) {\n\t\t\tret = regmap_field_write(info->regmap_fields[F_BATABM],\n\t\t\t\t\t\t 0x01);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(dev, \"Failed to mask BATAB interrupt\\n\");\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\n\t\tret = regmap_read(info->regmap, RT9455_REG_MASK2, &mask2);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to read MASK2 register\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (mask2 & GET_MASK(F_CHTERMIM)) {\n\t\t\tret = regmap_field_write(\n\t\t\t\tinfo->regmap_fields[F_CHTERMIM], 0x00);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(dev, \"Failed to unmask CHTERMI interrupt\\n\");\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\n\t\tif (mask2 & GET_MASK(F_CHRCHGIM)) {\n\t\t\tret = regmap_field_write(\n\t\t\t\tinfo->regmap_fields[F_CHRCHGIM], 0x00);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(dev, \"Failed to unmask CHRCHGI interrupt\\n\");\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t}\n\n\t\t \n\t\tcancel_delayed_work_sync(&info->max_charging_time_work);\n\t\t \n\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t   &info->batt_presence_work,\n\t\t\t\t   RT9455_BATT_PRESENCE_DELAY * HZ);\n\t}\n\n\t*_is_battery_absent = is_battery_absent;\n\n\tif (alert_userspace)\n\t\t*_alert_userspace = alert_userspace;\n\n\treturn 0;\n}\n\nstatic int rt9455_irq_handler_check_irq2_register(struct rt9455_info *info,\n\t\t\t\t\t\t  bool is_battery_absent,\n\t\t\t\t\t\t  bool *_alert_userspace)\n{\n\tunsigned int irq2, mask2;\n\tstruct device *dev = &info->client->dev;\n\tbool alert_userspace = false;\n\tint ret;\n\n\tret = regmap_read(info->regmap, RT9455_REG_IRQ2, &irq2);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read IRQ2 register\\n\");\n\t\treturn ret;\n\t}\n\n\tret = regmap_read(info->regmap, RT9455_REG_MASK2, &mask2);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read MASK2 register\\n\");\n\t\treturn ret;\n\t}\n\n\tif (irq2 & GET_MASK(F_CHRVPI)) {\n\t\tdev_dbg(dev, \"Charger fault occurred\\n\");\n\t\t \n\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t   &info->pwr_rdy_work,\n\t\t\t\t   RT9455_PWR_RDY_DELAY * HZ);\n\t}\n\tif (irq2 & GET_MASK(F_CHBATOVI)) {\n\t\tdev_err(dev, \"Battery OVP occurred\\n\");\n\t\talert_userspace = true;\n\t}\n\tif (irq2 & GET_MASK(F_CHTERMI)) {\n\t\tdev_dbg(dev, \"Charge terminated\\n\");\n\t\tif (!is_battery_absent) {\n\t\t\tif ((mask2 & GET_MASK(F_CHTERMIM)) == 0) {\n\t\t\t\tret = regmap_field_write(\n\t\t\t\t\tinfo->regmap_fields[F_CHTERMIM], 0x01);\n\t\t\t\tif (ret) {\n\t\t\t\t\tdev_err(dev, \"Failed to mask CHTERMI interrupt\\n\");\n\t\t\t\t\treturn ret;\n\t\t\t\t}\n\t\t\t\t \n\t\t\t\tmask2 = mask2 | GET_MASK(F_CHTERMIM);\n\t\t\t}\n\t\t\tcancel_delayed_work_sync(&info->max_charging_time_work);\n\t\t\talert_userspace = true;\n\t\t}\n\t}\n\tif (irq2 & GET_MASK(F_CHRCHGI)) {\n\t\tdev_dbg(dev, \"Recharge request\\n\");\n\t\tret = regmap_field_write(info->regmap_fields[F_CHG_EN],\n\t\t\t\t\t RT9455_CHARGE_ENABLE);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to enable charging\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\tif (mask2 & GET_MASK(F_CHTERMIM)) {\n\t\t\tret = regmap_field_write(\n\t\t\t\tinfo->regmap_fields[F_CHTERMIM], 0x00);\n\t\t\tif (ret) {\n\t\t\t\tdev_err(dev, \"Failed to unmask CHTERMI interrupt\\n\");\n\t\t\t\treturn ret;\n\t\t\t}\n\t\t\t \n\t\t\tmask2 = mask2 & ~GET_MASK(F_CHTERMIM);\n\t\t}\n\t\tif (!is_battery_absent) {\n\t\t\t \n\t\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t\t   &info->max_charging_time_work,\n\t\t\t\t\t   RT9455_MAX_CHARGING_TIME * HZ);\n\t\t\talert_userspace = true;\n\t\t}\n\t}\n\tif (irq2 & GET_MASK(F_CH32MI)) {\n\t\tdev_err(dev, \"Charger fault. 32 mins timeout occurred\\n\");\n\t\talert_userspace = true;\n\t}\n\tif (irq2 & GET_MASK(F_CHTREGI)) {\n\t\tdev_warn(dev,\n\t\t\t \"Charger warning. Thermal regulation loop active\\n\");\n\t\talert_userspace = true;\n\t}\n\tif (irq2 & GET_MASK(F_CHMIVRI)) {\n\t\tdev_dbg(dev,\n\t\t\t\"Charger warning. Input voltage MIVR loop active\\n\");\n\t}\n\n\tif (alert_userspace)\n\t\t*_alert_userspace = alert_userspace;\n\n\treturn 0;\n}\n\nstatic int rt9455_irq_handler_check_irq3_register(struct rt9455_info *info,\n\t\t\t\t\t\t  bool *_alert_userspace)\n{\n\tunsigned int irq3, mask3;\n\tstruct device *dev = &info->client->dev;\n\tbool alert_userspace = false;\n\tint ret;\n\n\tret = regmap_read(info->regmap, RT9455_REG_IRQ3, &irq3);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read IRQ3 register\\n\");\n\t\treturn ret;\n\t}\n\n\tret = regmap_read(info->regmap, RT9455_REG_MASK3, &mask3);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read MASK3 register\\n\");\n\t\treturn ret;\n\t}\n\n\tif (irq3 & GET_MASK(F_BSTBUSOVI)) {\n\t\tdev_err(dev, \"Boost fault. Overvoltage input occurred\\n\");\n\t\talert_userspace = true;\n\t}\n\tif (irq3 & GET_MASK(F_BSTOLI)) {\n\t\tdev_err(dev, \"Boost fault. Overload\\n\");\n\t\talert_userspace = true;\n\t}\n\tif (irq3 & GET_MASK(F_BSTLOWVI)) {\n\t\tdev_err(dev, \"Boost fault. Battery voltage too low\\n\");\n\t\talert_userspace = true;\n\t}\n\tif (irq3 & GET_MASK(F_BST32SI)) {\n\t\tdev_err(dev, \"Boost fault. 32 seconds timeout occurred.\\n\");\n\t\talert_userspace = true;\n\t}\n\n\tif (alert_userspace) {\n\t\tdev_info(dev, \"Boost fault occurred, therefore the charger goes into charge mode\\n\");\n\t\tret = rt9455_set_voreg_before_charge_mode(info);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set VOREG before entering charge mode\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\tret = regmap_field_write(info->regmap_fields[F_OPA_MODE],\n\t\t\t\t\t RT9455_CHARGE_MODE);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set charger in charge mode\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\t*_alert_userspace = alert_userspace;\n\t}\n\n\treturn 0;\n}\n\nstatic irqreturn_t rt9455_irq_handler_thread(int irq, void *data)\n{\n\tstruct rt9455_info *info = data;\n\tstruct device *dev;\n\tbool alert_userspace = false;\n\tbool is_battery_absent = false;\n\tunsigned int status;\n\tint ret;\n\n\tif (!info)\n\t\treturn IRQ_NONE;\n\n\tdev = &info->client->dev;\n\n\tif (irq != info->client->irq) {\n\t\tdev_err(dev, \"Interrupt is not for RT9455 charger\\n\");\n\t\treturn IRQ_NONE;\n\t}\n\n\tret = regmap_field_read(info->regmap_fields[F_STAT], &status);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read STAT bits\\n\");\n\t\treturn IRQ_HANDLED;\n\t}\n\tdev_dbg(dev, \"Charger status is %d\\n\", status);\n\n\t \n\tret = rt9455_irq_handler_check_irq1_register(info, &is_battery_absent,\n\t\t\t\t\t\t     &alert_userspace);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to handle IRQ1 register\\n\");\n\t\treturn IRQ_HANDLED;\n\t}\n\n\tret = rt9455_irq_handler_check_irq2_register(info, is_battery_absent,\n\t\t\t\t\t\t     &alert_userspace);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to handle IRQ2 register\\n\");\n\t\treturn IRQ_HANDLED;\n\t}\n\n\tret = rt9455_irq_handler_check_irq3_register(info, &alert_userspace);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to handle IRQ3 register\\n\");\n\t\treturn IRQ_HANDLED;\n\t}\n\n\tif (alert_userspace) {\n\t\t \n\t\tif (info->charger)\n\t\t\tpower_supply_changed(info->charger);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int rt9455_discover_charger(struct rt9455_info *info, u32 *ichrg,\n\t\t\t\t   u32 *ieoc_percentage,\n\t\t\t\t   u32 *mivr, u32 *iaicr)\n{\n\tstruct device *dev = &info->client->dev;\n\tint ret;\n\n\tif (!dev->of_node && !ACPI_HANDLE(dev)) {\n\t\tdev_err(dev, \"No support for either device tree or ACPI\\n\");\n\t\treturn -EINVAL;\n\t}\n\t \n\tret = device_property_read_u32(dev, \"richtek,output-charge-current\",\n\t\t\t\t       ichrg);\n\tif (ret) {\n\t\tdev_err(dev, \"Error: missing \\\"output-charge-current\\\" property\\n\");\n\t\treturn ret;\n\t}\n\n\tret = device_property_read_u32(dev, \"richtek,end-of-charge-percentage\",\n\t\t\t\t       ieoc_percentage);\n\tif (ret) {\n\t\tdev_err(dev, \"Error: missing \\\"end-of-charge-percentage\\\" property\\n\");\n\t\treturn ret;\n\t}\n\n\tret = device_property_read_u32(dev,\n\t\t\t\t       \"richtek,battery-regulation-voltage\",\n\t\t\t\t       &info->voreg);\n\tif (ret) {\n\t\tdev_err(dev, \"Error: missing \\\"battery-regulation-voltage\\\" property\\n\");\n\t\treturn ret;\n\t}\n\n\tret = device_property_read_u32(dev, \"richtek,boost-output-voltage\",\n\t\t\t\t       &info->boost_voltage);\n\tif (ret) {\n\t\tdev_err(dev, \"Error: missing \\\"boost-output-voltage\\\" property\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tdevice_property_read_u32(dev, \"richtek,min-input-voltage-regulation\",\n\t\t\t\t mivr);\n\tdevice_property_read_u32(dev, \"richtek,avg-input-current-regulation\",\n\t\t\t\t iaicr);\n\n\treturn 0;\n}\n\n#if IS_ENABLED(CONFIG_USB_PHY)\nstatic int rt9455_usb_event_none(struct rt9455_info *info,\n\t\t\t\t u8 opa_mode, u8 iaicr)\n{\n\tstruct device *dev = &info->client->dev;\n\tint ret;\n\n\tif (opa_mode == RT9455_BOOST_MODE) {\n\t\tret = rt9455_set_voreg_before_charge_mode(info);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set VOREG before entering charge mode\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\t \n\t\tdev_dbg(dev, \"USB_EVENT_NONE received, therefore the charger goes into charge mode\\n\");\n\t\tret = regmap_field_write(info->regmap_fields[F_OPA_MODE],\n\t\t\t\t\t RT9455_CHARGE_MODE);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set charger in charge mode\\n\");\n\t\t\treturn NOTIFY_DONE;\n\t\t}\n\t}\n\n\tdev_dbg(dev, \"USB_EVENT_NONE received, therefore IAICR is set to its minimum value\\n\");\n\tif (iaicr != RT9455_IAICR_100MA) {\n\t\tret = regmap_field_write(info->regmap_fields[F_IAICR],\n\t\t\t\t\t RT9455_IAICR_100MA);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set IAICR value\\n\");\n\t\t\treturn NOTIFY_DONE;\n\t\t}\n\t}\n\n\treturn NOTIFY_OK;\n}\n\nstatic int rt9455_usb_event_vbus(struct rt9455_info *info,\n\t\t\t\t u8 opa_mode, u8 iaicr)\n{\n\tstruct device *dev = &info->client->dev;\n\tint ret;\n\n\tif (opa_mode == RT9455_BOOST_MODE) {\n\t\tret = rt9455_set_voreg_before_charge_mode(info);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set VOREG before entering charge mode\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\t \n\t\tdev_dbg(dev, \"USB_EVENT_VBUS received, therefore the charger goes into charge mode\\n\");\n\t\tret = regmap_field_write(info->regmap_fields[F_OPA_MODE],\n\t\t\t\t\t RT9455_CHARGE_MODE);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set charger in charge mode\\n\");\n\t\t\treturn NOTIFY_DONE;\n\t\t}\n\t}\n\n\tdev_dbg(dev, \"USB_EVENT_VBUS received, therefore IAICR is set to 500 mA\\n\");\n\tif (iaicr != RT9455_IAICR_500MA) {\n\t\tret = regmap_field_write(info->regmap_fields[F_IAICR],\n\t\t\t\t\t RT9455_IAICR_500MA);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set IAICR value\\n\");\n\t\t\treturn NOTIFY_DONE;\n\t\t}\n\t}\n\n\treturn NOTIFY_OK;\n}\n\nstatic int rt9455_usb_event_id(struct rt9455_info *info,\n\t\t\t       u8 opa_mode, u8 iaicr)\n{\n\tstruct device *dev = &info->client->dev;\n\tint ret;\n\n\tif (opa_mode == RT9455_CHARGE_MODE) {\n\t\tret = rt9455_set_boost_voltage_before_boost_mode(info);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set boost output voltage before entering boost mode\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\t \n\t\tdev_dbg(dev, \"USB_EVENT_ID received, therefore the charger goes into boost mode\\n\");\n\t\tret = regmap_field_write(info->regmap_fields[F_OPA_MODE],\n\t\t\t\t\t RT9455_BOOST_MODE);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set charger in boost mode\\n\");\n\t\t\treturn NOTIFY_DONE;\n\t\t}\n\t}\n\n\tdev_dbg(dev, \"USB_EVENT_ID received, therefore IAICR is set to its minimum value\\n\");\n\tif (iaicr != RT9455_IAICR_100MA) {\n\t\tret = regmap_field_write(info->regmap_fields[F_IAICR],\n\t\t\t\t\t RT9455_IAICR_100MA);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set IAICR value\\n\");\n\t\t\treturn NOTIFY_DONE;\n\t\t}\n\t}\n\n\treturn NOTIFY_OK;\n}\n\nstatic int rt9455_usb_event_charger(struct rt9455_info *info,\n\t\t\t\t    u8 opa_mode, u8 iaicr)\n{\n\tstruct device *dev = &info->client->dev;\n\tint ret;\n\n\tif (opa_mode == RT9455_BOOST_MODE) {\n\t\tret = rt9455_set_voreg_before_charge_mode(info);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set VOREG before entering charge mode\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\t \n\t\tdev_dbg(dev, \"USB_EVENT_CHARGER received, therefore the charger goes into charge mode\\n\");\n\t\tret = regmap_field_write(info->regmap_fields[F_OPA_MODE],\n\t\t\t\t\t RT9455_CHARGE_MODE);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set charger in charge mode\\n\");\n\t\t\treturn NOTIFY_DONE;\n\t\t}\n\t}\n\n\tdev_dbg(dev, \"USB_EVENT_CHARGER received, therefore IAICR is set to no current limit\\n\");\n\tif (iaicr != RT9455_IAICR_NO_LIMIT) {\n\t\tret = regmap_field_write(info->regmap_fields[F_IAICR],\n\t\t\t\t\t RT9455_IAICR_NO_LIMIT);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to set IAICR value\\n\");\n\t\t\treturn NOTIFY_DONE;\n\t\t}\n\t}\n\n\treturn NOTIFY_OK;\n}\n\nstatic int rt9455_usb_event(struct notifier_block *nb,\n\t\t\t    unsigned long event, void *power)\n{\n\tstruct rt9455_info *info = container_of(nb, struct rt9455_info, nb);\n\tstruct device *dev = &info->client->dev;\n\tunsigned int opa_mode, iaicr;\n\tint ret;\n\n\t \n\tret = regmap_field_read(info->regmap_fields[F_OPA_MODE],\n\t\t\t\t&opa_mode);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read OPA_MODE value\\n\");\n\t\treturn NOTIFY_DONE;\n\t}\n\n\tret = regmap_field_read(info->regmap_fields[F_IAICR],\n\t\t\t\t&iaicr);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read IAICR value\\n\");\n\t\treturn NOTIFY_DONE;\n\t}\n\n\tdev_dbg(dev, \"Received USB event %lu\\n\", event);\n\tswitch (event) {\n\tcase USB_EVENT_NONE:\n\t\treturn rt9455_usb_event_none(info, opa_mode, iaicr);\n\tcase USB_EVENT_VBUS:\n\t\treturn rt9455_usb_event_vbus(info, opa_mode, iaicr);\n\tcase USB_EVENT_ID:\n\t\treturn rt9455_usb_event_id(info, opa_mode, iaicr);\n\tcase USB_EVENT_CHARGER:\n\t\treturn rt9455_usb_event_charger(info, opa_mode, iaicr);\n\tdefault:\n\t\tdev_err(dev, \"Unknown USB event\\n\");\n\t}\n\treturn NOTIFY_DONE;\n}\n#endif\n\nstatic void rt9455_pwr_rdy_work_callback(struct work_struct *work)\n{\n\tstruct rt9455_info *info = container_of(work, struct rt9455_info,\n\t\t\t\t\t\tpwr_rdy_work.work);\n\tstruct device *dev = &info->client->dev;\n\tunsigned int pwr_rdy;\n\tint ret;\n\n\tret = regmap_field_read(info->regmap_fields[F_PWR_RDY], &pwr_rdy);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read PWR_RDY bit\\n\");\n\t\treturn;\n\t}\n\tswitch (pwr_rdy) {\n\tcase RT9455_PWR_FAULT:\n\t\tdev_dbg(dev, \"Charger disconnected from power source\\n\");\n\t\tcancel_delayed_work_sync(&info->max_charging_time_work);\n\t\tbreak;\n\tcase RT9455_PWR_GOOD:\n\t\tdev_dbg(dev, \"Charger connected to power source\\n\");\n\t\tret = regmap_field_write(info->regmap_fields[F_CHG_EN],\n\t\t\t\t\t RT9455_CHARGE_ENABLE);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to enable charging\\n\");\n\t\t\treturn;\n\t\t}\n\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t   &info->max_charging_time_work,\n\t\t\t\t   RT9455_MAX_CHARGING_TIME * HZ);\n\t\tbreak;\n\t}\n\t \n\tpower_supply_changed(info->charger);\n}\n\nstatic void rt9455_max_charging_time_work_callback(struct work_struct *work)\n{\n\tstruct rt9455_info *info = container_of(work, struct rt9455_info,\n\t\t\t\t\t\tmax_charging_time_work.work);\n\tstruct device *dev = &info->client->dev;\n\tint ret;\n\n\tdev_err(dev, \"Battery has been charging for at least 6 hours and is not yet fully charged. Battery is dead, therefore charging is disabled.\\n\");\n\tret = regmap_field_write(info->regmap_fields[F_CHG_EN],\n\t\t\t\t RT9455_CHARGE_DISABLE);\n\tif (ret)\n\t\tdev_err(dev, \"Failed to disable charging\\n\");\n}\n\nstatic void rt9455_batt_presence_work_callback(struct work_struct *work)\n{\n\tstruct rt9455_info *info = container_of(work, struct rt9455_info,\n\t\t\t\t\t\tbatt_presence_work.work);\n\tstruct device *dev = &info->client->dev;\n\tunsigned int irq1, mask1;\n\tint ret;\n\n\tret = regmap_read(info->regmap, RT9455_REG_IRQ1, &irq1);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read IRQ1 register\\n\");\n\t\treturn;\n\t}\n\n\t \n\tif (irq1 & GET_MASK(F_BATAB)) {\n\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t   &info->batt_presence_work,\n\t\t\t\t   RT9455_BATT_PRESENCE_DELAY * HZ);\n\t} else {\n\t\tqueue_delayed_work(system_power_efficient_wq,\n\t\t\t\t   &info->max_charging_time_work,\n\t\t\t\t   RT9455_MAX_CHARGING_TIME * HZ);\n\n\t\tret = regmap_read(info->regmap, RT9455_REG_MASK1, &mask1);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to read MASK1 register\\n\");\n\t\t\treturn;\n\t\t}\n\n\t\tif (mask1 & GET_MASK(F_BATABM)) {\n\t\t\tret = regmap_field_write(info->regmap_fields[F_BATABM],\n\t\t\t\t\t\t 0x00);\n\t\t\tif (ret)\n\t\t\t\tdev_err(dev, \"Failed to unmask BATAB interrupt\\n\");\n\t\t}\n\t\t \n\t\tpower_supply_changed(info->charger);\n\t}\n}\n\nstatic const struct power_supply_desc rt9455_charger_desc = {\n\t.name\t\t\t= RT9455_DRIVER_NAME,\n\t.type\t\t\t= POWER_SUPPLY_TYPE_USB,\n\t.properties\t\t= rt9455_charger_properties,\n\t.num_properties\t\t= ARRAY_SIZE(rt9455_charger_properties),\n\t.get_property\t\t= rt9455_charger_get_property,\n};\n\nstatic bool rt9455_is_writeable_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase RT9455_REG_DEV_ID:\n\tcase RT9455_REG_IRQ1:\n\tcase RT9455_REG_IRQ2:\n\tcase RT9455_REG_IRQ3:\n\t\treturn false;\n\tdefault:\n\t\treturn true;\n\t}\n}\n\nstatic bool rt9455_is_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase RT9455_REG_DEV_ID:\n\tcase RT9455_REG_CTRL5:\n\tcase RT9455_REG_CTRL6:\n\t\treturn false;\n\tdefault:\n\t\treturn true;\n\t}\n}\n\nstatic const struct regmap_config rt9455_regmap_config = {\n\t.reg_bits\t= 8,\n\t.val_bits\t= 8,\n\t.writeable_reg\t= rt9455_is_writeable_reg,\n\t.volatile_reg\t= rt9455_is_volatile_reg,\n\t.max_register\t= RT9455_REG_MASK3,\n\t.cache_type\t= REGCACHE_RBTREE,\n};\n\nstatic int rt9455_probe(struct i2c_client *client)\n{\n\tstruct i2c_adapter *adapter = client->adapter;\n\tstruct device *dev = &client->dev;\n\tstruct rt9455_info *info;\n\tstruct power_supply_config rt9455_charger_config = {};\n\t \n\tu32 ichrg, ieoc_percentage;\n\t \n\tu32 mivr = -1, iaicr = -1;\n\tint i, ret;\n\n\tif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA)) {\n\t\tdev_err(dev, \"No support for SMBUS_BYTE_DATA\\n\");\n\t\treturn -ENODEV;\n\t}\n\tinfo = devm_kzalloc(dev, sizeof(*info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tinfo->client = client;\n\ti2c_set_clientdata(client, info);\n\n\tinfo->regmap = devm_regmap_init_i2c(client,\n\t\t\t\t\t    &rt9455_regmap_config);\n\tif (IS_ERR(info->regmap)) {\n\t\tdev_err(dev, \"Failed to initialize register map\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tfor (i = 0; i < F_MAX_FIELDS; i++) {\n\t\tinfo->regmap_fields[i] =\n\t\t\tdevm_regmap_field_alloc(dev, info->regmap,\n\t\t\t\t\t\trt9455_reg_fields[i]);\n\t\tif (IS_ERR(info->regmap_fields[i])) {\n\t\t\tdev_err(dev,\n\t\t\t\t\"Failed to allocate regmap field = %d\\n\", i);\n\t\t\treturn PTR_ERR(info->regmap_fields[i]);\n\t\t}\n\t}\n\n\tret = rt9455_discover_charger(info, &ichrg, &ieoc_percentage,\n\t\t\t\t      &mivr, &iaicr);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to discover charger\\n\");\n\t\treturn ret;\n\t}\n\n#if IS_ENABLED(CONFIG_USB_PHY)\n\tinfo->usb_phy = devm_usb_get_phy(dev, USB_PHY_TYPE_USB2);\n\tif (IS_ERR(info->usb_phy)) {\n\t\tdev_err(dev, \"Failed to get USB transceiver\\n\");\n\t} else {\n\t\tinfo->nb.notifier_call = rt9455_usb_event;\n\t\tret = usb_register_notifier(info->usb_phy, &info->nb);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Failed to register USB notifier\\n\");\n\t\t\t \n\t\t\tinfo->nb.notifier_call = NULL;\n\t\t}\n\t}\n#endif\n\n\tINIT_DEFERRABLE_WORK(&info->pwr_rdy_work, rt9455_pwr_rdy_work_callback);\n\tINIT_DEFERRABLE_WORK(&info->max_charging_time_work,\n\t\t\t     rt9455_max_charging_time_work_callback);\n\tINIT_DEFERRABLE_WORK(&info->batt_presence_work,\n\t\t\t     rt9455_batt_presence_work_callback);\n\n\trt9455_charger_config.of_node\t\t= dev->of_node;\n\trt9455_charger_config.drv_data\t\t= info;\n\trt9455_charger_config.supplied_to\t= rt9455_charger_supplied_to;\n\trt9455_charger_config.num_supplicants\t=\n\t\t\t\t\tARRAY_SIZE(rt9455_charger_supplied_to);\n\tret = devm_request_threaded_irq(dev, client->irq, NULL,\n\t\t\t\t\trt9455_irq_handler_thread,\n\t\t\t\t\tIRQF_TRIGGER_LOW | IRQF_ONESHOT,\n\t\t\t\t\tRT9455_DRIVER_NAME, info);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to register IRQ handler\\n\");\n\t\tgoto put_usb_notifier;\n\t}\n\n\tret = rt9455_hw_init(info, ichrg, ieoc_percentage, mivr, iaicr);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to set charger to its default values\\n\");\n\t\tgoto put_usb_notifier;\n\t}\n\n\tinfo->charger = devm_power_supply_register(dev, &rt9455_charger_desc,\n\t\t\t\t\t\t   &rt9455_charger_config);\n\tif (IS_ERR(info->charger)) {\n\t\tdev_err(dev, \"Failed to register charger\\n\");\n\t\tret = PTR_ERR(info->charger);\n\t\tgoto put_usb_notifier;\n\t}\n\n\treturn 0;\n\nput_usb_notifier:\n#if IS_ENABLED(CONFIG_USB_PHY)\n\tif (info->nb.notifier_call)  {\n\t\tusb_unregister_notifier(info->usb_phy, &info->nb);\n\t\tinfo->nb.notifier_call = NULL;\n\t}\n#endif\n\treturn ret;\n}\n\nstatic void rt9455_remove(struct i2c_client *client)\n{\n\tint ret;\n\tstruct rt9455_info *info = i2c_get_clientdata(client);\n\n\tret = rt9455_register_reset(info);\n\tif (ret)\n\t\tdev_err(&info->client->dev, \"Failed to set charger to its default values\\n\");\n\n#if IS_ENABLED(CONFIG_USB_PHY)\n\tif (info->nb.notifier_call)\n\t\tusb_unregister_notifier(info->usb_phy, &info->nb);\n#endif\n\n\tcancel_delayed_work_sync(&info->pwr_rdy_work);\n\tcancel_delayed_work_sync(&info->max_charging_time_work);\n\tcancel_delayed_work_sync(&info->batt_presence_work);\n}\n\nstatic const struct i2c_device_id rt9455_i2c_id_table[] = {\n\t{ RT9455_DRIVER_NAME, 0 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(i2c, rt9455_i2c_id_table);\n\nstatic const struct of_device_id rt9455_of_match[] __maybe_unused = {\n\t{ .compatible = \"richtek,rt9455\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, rt9455_of_match);\n\n#ifdef CONFIG_ACPI\nstatic const struct acpi_device_id rt9455_i2c_acpi_match[] = {\n\t{ \"RT945500\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(acpi, rt9455_i2c_acpi_match);\n#endif\n\nstatic struct i2c_driver rt9455_driver = {\n\t.probe\t\t= rt9455_probe,\n\t.remove\t\t= rt9455_remove,\n\t.id_table\t= rt9455_i2c_id_table,\n\t.driver = {\n\t\t.name\t\t= RT9455_DRIVER_NAME,\n\t\t.of_match_table\t= of_match_ptr(rt9455_of_match),\n\t\t.acpi_match_table = ACPI_PTR(rt9455_i2c_acpi_match),\n\t},\n};\nmodule_i2c_driver(rt9455_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Anda-Maria Nicolae <anda-maria.nicolae@intel.com>\");\nMODULE_DESCRIPTION(\"Richtek RT9455 Charger Driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}