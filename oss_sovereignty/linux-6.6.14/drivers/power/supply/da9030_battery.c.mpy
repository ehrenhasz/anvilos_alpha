{
  "module_name": "da9030_battery.c",
  "hash_id": "d6d7ed28ec89a9da8da9df6e48b84d230af24101c7da98f0a8bf8f25d0b42871",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/da9030_battery.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/types.h>\n#include <linux/device.h>\n#include <linux/workqueue.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/mfd/da903x.h>\n\n#include <linux/debugfs.h>\n#include <linux/seq_file.h>\n#include <linux/notifier.h>\n\n#define DA9030_FAULT_LOG\t\t0x0a\n#define DA9030_FAULT_LOG_OVER_TEMP\t(1 << 7)\n#define DA9030_FAULT_LOG_VBAT_OVER\t(1 << 4)\n\n#define DA9030_CHARGE_CONTROL\t\t0x28\n#define DA9030_CHRG_CHARGER_ENABLE\t(1 << 7)\n\n#define DA9030_ADC_MAN_CONTROL\t\t0x30\n#define DA9030_ADC_TBATREF_ENABLE\t(1 << 5)\n#define DA9030_ADC_LDO_INT_ENABLE\t(1 << 4)\n\n#define DA9030_ADC_AUTO_CONTROL\t\t0x31\n#define DA9030_ADC_TBAT_ENABLE\t\t(1 << 5)\n#define DA9030_ADC_VBAT_IN_TXON\t\t(1 << 4)\n#define DA9030_ADC_VCH_ENABLE\t\t(1 << 3)\n#define DA9030_ADC_ICH_ENABLE\t\t(1 << 2)\n#define DA9030_ADC_VBAT_ENABLE\t\t(1 << 1)\n#define DA9030_ADC_AUTO_SLEEP_ENABLE\t(1 << 0)\n\n#define DA9030_VBATMON\t\t0x32\n#define DA9030_VBATMONTXON\t0x33\n#define DA9030_TBATHIGHP\t0x34\n#define DA9030_TBATHIGHN\t0x35\n#define DA9030_TBATLOW\t\t0x36\n\n#define DA9030_VBAT_RES\t\t0x41\n#define DA9030_VBATMIN_RES\t0x42\n#define DA9030_VBATMINTXON_RES\t0x43\n#define DA9030_ICHMAX_RES\t0x44\n#define DA9030_ICHMIN_RES\t0x45\n#define DA9030_ICHAVERAGE_RES\t0x46\n#define DA9030_VCHMAX_RES\t0x47\n#define DA9030_VCHMIN_RES\t0x48\n#define DA9030_TBAT_RES\t\t0x49\n\nstruct da9030_adc_res {\n\tuint8_t vbat_res;\n\tuint8_t vbatmin_res;\n\tuint8_t vbatmintxon;\n\tuint8_t ichmax_res;\n\tuint8_t ichmin_res;\n\tuint8_t ichaverage_res;\n\tuint8_t vchmax_res;\n\tuint8_t vchmin_res;\n\tuint8_t tbat_res;\n\tuint8_t adc_in4_res;\n\tuint8_t adc_in5_res;\n};\n\nstruct da9030_battery_thresholds {\n\tint tbat_low;\n\tint tbat_high;\n\tint tbat_restart;\n\n\tint vbat_low;\n\tint vbat_crit;\n\tint vbat_charge_start;\n\tint vbat_charge_stop;\n\tint vbat_charge_restart;\n\n\tint vcharge_min;\n\tint vcharge_max;\n};\n\nstruct da9030_charger {\n\tstruct power_supply *psy;\n\tstruct power_supply_desc psy_desc;\n\n\tstruct device *master;\n\n\tstruct da9030_adc_res adc;\n\tstruct delayed_work work;\n\tunsigned int interval;\n\n\tstruct power_supply_info *battery_info;\n\n\tstruct da9030_battery_thresholds thresholds;\n\n\tunsigned int charge_milliamp;\n\tunsigned int charge_millivolt;\n\n\t \n\tbool chdet;\n\tuint8_t fault;\n\tint mA;\n\tint mV;\n\tbool is_on;\n\n\tstruct notifier_block nb;\n\n\t \n\tvoid (*battery_low)(void);\n\tvoid (*battery_critical)(void);\n\n\tstruct dentry *debug_file;\n};\n\nstatic inline int da9030_reg_to_mV(int reg)\n{\n\treturn ((reg * 2650) >> 8) + 2650;\n}\n\nstatic inline int da9030_millivolt_to_reg(int mV)\n{\n\treturn ((mV - 2650) << 8) / 2650;\n}\n\nstatic inline int da9030_reg_to_mA(int reg)\n{\n\treturn ((reg * 24000) >> 8) / 15;\n}\n\n#ifdef CONFIG_DEBUG_FS\nstatic int bat_debug_show(struct seq_file *s, void *data)\n{\n\tstruct da9030_charger *charger = s->private;\n\n\tseq_printf(s, \"charger is %s\\n\", charger->is_on ? \"on\" : \"off\");\n\tif (charger->chdet) {\n\t\tseq_printf(s, \"iset = %dmA, vset = %dmV\\n\",\n\t\t\t   charger->mA, charger->mV);\n\t}\n\n\tseq_printf(s, \"vbat_res = %d (%dmV)\\n\",\n\t\t   charger->adc.vbat_res,\n\t\t   da9030_reg_to_mV(charger->adc.vbat_res));\n\tseq_printf(s, \"vbatmin_res = %d (%dmV)\\n\",\n\t\t   charger->adc.vbatmin_res,\n\t\t   da9030_reg_to_mV(charger->adc.vbatmin_res));\n\tseq_printf(s, \"vbatmintxon = %d (%dmV)\\n\",\n\t\t   charger->adc.vbatmintxon,\n\t\t   da9030_reg_to_mV(charger->adc.vbatmintxon));\n\tseq_printf(s, \"ichmax_res = %d (%dmA)\\n\",\n\t\t   charger->adc.ichmax_res,\n\t\t   da9030_reg_to_mV(charger->adc.ichmax_res));\n\tseq_printf(s, \"ichmin_res = %d (%dmA)\\n\",\n\t\t   charger->adc.ichmin_res,\n\t\t   da9030_reg_to_mA(charger->adc.ichmin_res));\n\tseq_printf(s, \"ichaverage_res = %d (%dmA)\\n\",\n\t\t   charger->adc.ichaverage_res,\n\t\t   da9030_reg_to_mA(charger->adc.ichaverage_res));\n\tseq_printf(s, \"vchmax_res = %d (%dmV)\\n\",\n\t\t   charger->adc.vchmax_res,\n\t\t   da9030_reg_to_mA(charger->adc.vchmax_res));\n\tseq_printf(s, \"vchmin_res = %d (%dmV)\\n\",\n\t\t   charger->adc.vchmin_res,\n\t\t   da9030_reg_to_mV(charger->adc.vchmin_res));\n\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(bat_debug);\n\nstatic struct dentry *da9030_bat_create_debugfs(struct da9030_charger *charger)\n{\n\tcharger->debug_file = debugfs_create_file(\"charger\", 0666, NULL,\n\t\t\t\t\t\t  charger, &bat_debug_fops);\n\treturn charger->debug_file;\n}\n\nstatic void da9030_bat_remove_debugfs(struct da9030_charger *charger)\n{\n\tdebugfs_remove(charger->debug_file);\n}\n#else\nstatic inline struct dentry *da9030_bat_create_debugfs(struct da9030_charger *charger)\n{\n\treturn NULL;\n}\nstatic inline void da9030_bat_remove_debugfs(struct da9030_charger *charger)\n{\n}\n#endif\n\nstatic inline void da9030_read_adc(struct da9030_charger *charger,\n\t\t\t\t   struct da9030_adc_res *adc)\n{\n\tda903x_reads(charger->master, DA9030_VBAT_RES,\n\t\t     sizeof(*adc), (uint8_t *)adc);\n}\n\nstatic void da9030_charger_update_state(struct da9030_charger *charger)\n{\n\tuint8_t val;\n\n\tda903x_read(charger->master, DA9030_CHARGE_CONTROL, &val);\n\tcharger->is_on = (val & DA9030_CHRG_CHARGER_ENABLE) ? 1 : 0;\n\tcharger->mA = ((val >> 3) & 0xf) * 100;\n\tcharger->mV = (val & 0x7) * 50 + 4000;\n\n\tda9030_read_adc(charger, &charger->adc);\n\tda903x_read(charger->master, DA9030_FAULT_LOG, &charger->fault);\n\tcharger->chdet = da903x_query_status(charger->master,\n\t\t\t\t\t\t     DA9030_STATUS_CHDET);\n}\n\nstatic void da9030_set_charge(struct da9030_charger *charger, int on)\n{\n\tuint8_t val;\n\n\tif (on) {\n\t\tval = DA9030_CHRG_CHARGER_ENABLE;\n\t\tval |= (charger->charge_milliamp / 100) << 3;\n\t\tval |= (charger->charge_millivolt - 4000) / 50;\n\t\tcharger->is_on = 1;\n\t} else {\n\t\tval = 0;\n\t\tcharger->is_on = 0;\n\t}\n\n\tda903x_write(charger->master, DA9030_CHARGE_CONTROL, val);\n\n\tpower_supply_changed(charger->psy);\n}\n\nstatic void da9030_charger_check_state(struct da9030_charger *charger)\n{\n\tda9030_charger_update_state(charger);\n\n\t \n\tif (!charger->is_on) {\n\t\tif ((charger->chdet) &&\n\t\t    (charger->adc.vbat_res <\n\t\t     charger->thresholds.vbat_charge_start)) {\n\t\t\tda9030_set_charge(charger, 1);\n\t\t}\n\t} else {\n\t\t \n\t\tif (!charger->chdet) {\n\t\t\tda9030_set_charge(charger, 0);\n\t\t\treturn;\n\t\t}\n\n\t\tif (charger->adc.vbat_res >=\n\t\t    charger->thresholds.vbat_charge_stop) {\n\t\t\tda9030_set_charge(charger, 0);\n\t\t\tda903x_write(charger->master, DA9030_VBATMON,\n\t\t\t\t       charger->thresholds.vbat_charge_restart);\n\t\t} else if (charger->adc.vbat_res >\n\t\t\t   charger->thresholds.vbat_low) {\n\t\t\t \n\t\t\tda903x_write(charger->master, DA9030_VBATMON,\n\t\t\t\t     charger->thresholds.vbat_low);\n\t\t}\n\t\tif (charger->adc.vchmax_res > charger->thresholds.vcharge_max ||\n\t\t    charger->adc.vchmin_res < charger->thresholds.vcharge_min ||\n\t\t     \n\t\t    charger->adc.tbat_res < charger->thresholds.tbat_high ||\n\t\t    charger->adc.tbat_res > charger->thresholds.tbat_low) {\n\t\t\t \n\t\t\tda9030_set_charge(charger, 0);\n\t\t}\n\t}\n}\n\nstatic void da9030_charging_monitor(struct work_struct *work)\n{\n\tstruct da9030_charger *charger;\n\n\tcharger = container_of(work, struct da9030_charger, work.work);\n\n\tda9030_charger_check_state(charger);\n\n\t \n\tschedule_delayed_work(&charger->work, charger->interval);\n}\n\nstatic enum power_supply_property da9030_battery_props[] = {\n\tPOWER_SUPPLY_PROP_MODEL_NAME,\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_AVG,\n};\n\nstatic void da9030_battery_check_status(struct da9030_charger *charger,\n\t\t\t\t    union power_supply_propval *val)\n{\n\tif (charger->chdet) {\n\t\tif (charger->is_on)\n\t\t\tval->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\telse\n\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t} else {\n\t\tval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\n\t}\n}\n\nstatic void da9030_battery_check_health(struct da9030_charger *charger,\n\t\t\t\t    union power_supply_propval *val)\n{\n\tif (charger->fault & DA9030_FAULT_LOG_OVER_TEMP)\n\t\tval->intval = POWER_SUPPLY_HEALTH_OVERHEAT;\n\telse if (charger->fault & DA9030_FAULT_LOG_VBAT_OVER)\n\t\tval->intval = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\n\telse\n\t\tval->intval = POWER_SUPPLY_HEALTH_GOOD;\n}\n\nstatic int da9030_battery_get_property(struct power_supply *psy,\n\t\t\t\t   enum power_supply_property psp,\n\t\t\t\t   union power_supply_propval *val)\n{\n\tstruct da9030_charger *charger = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tda9030_battery_check_status(charger, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tda9030_battery_check_health(charger, val);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tval->intval = charger->battery_info->technology;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\n\t\tval->intval = charger->battery_info->voltage_max_design;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\n\t\tval->intval = charger->battery_info->voltage_min_design;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tval->intval = da9030_reg_to_mV(charger->adc.vbat_res) * 1000;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_AVG:\n\t\tval->intval =\n\t\t\tda9030_reg_to_mA(charger->adc.ichaverage_res) * 1000;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_MODEL_NAME:\n\t\tval->strval = charger->battery_info->name;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic void da9030_battery_vbat_event(struct da9030_charger *charger)\n{\n\tda9030_read_adc(charger, &charger->adc);\n\n\tif (charger->is_on)\n\t\treturn;\n\n\tif (charger->adc.vbat_res < charger->thresholds.vbat_low) {\n\t\t \n\t\tda903x_write(charger->master, DA9030_VBATMON,\n\t\t\t     charger->thresholds.vbat_crit);\n\t\tif (charger->battery_low)\n\t\t\tcharger->battery_low();\n\t} else if (charger->adc.vbat_res <\n\t\t   charger->thresholds.vbat_crit) {\n\t\t \n\t\tif (charger->battery_critical)\n\t\t\tcharger->battery_critical();\n\t}\n}\n\nstatic int da9030_battery_event(struct notifier_block *nb, unsigned long event,\n\t\t\t\tvoid *data)\n{\n\tstruct da9030_charger *charger =\n\t\tcontainer_of(nb, struct da9030_charger, nb);\n\n\tswitch (event) {\n\tcase DA9030_EVENT_CHDET:\n\t\tcancel_delayed_work_sync(&charger->work);\n\t\tschedule_work(&charger->work.work);\n\t\tbreak;\n\tcase DA9030_EVENT_VBATMON:\n\t\tda9030_battery_vbat_event(charger);\n\t\tbreak;\n\tcase DA9030_EVENT_CHIOVER:\n\tcase DA9030_EVENT_TBAT:\n\t\tda9030_set_charge(charger, 0);\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic void da9030_battery_convert_thresholds(struct da9030_charger *charger,\n\t\t\t\t\t      struct da9030_battery_info *pdata)\n{\n\tcharger->thresholds.tbat_low = pdata->tbat_low;\n\tcharger->thresholds.tbat_high = pdata->tbat_high;\n\tcharger->thresholds.tbat_restart  = pdata->tbat_restart;\n\n\tcharger->thresholds.vbat_low =\n\t\tda9030_millivolt_to_reg(pdata->vbat_low);\n\tcharger->thresholds.vbat_crit =\n\t\tda9030_millivolt_to_reg(pdata->vbat_crit);\n\tcharger->thresholds.vbat_charge_start =\n\t\tda9030_millivolt_to_reg(pdata->vbat_charge_start);\n\tcharger->thresholds.vbat_charge_stop =\n\t\tda9030_millivolt_to_reg(pdata->vbat_charge_stop);\n\tcharger->thresholds.vbat_charge_restart =\n\t\tda9030_millivolt_to_reg(pdata->vbat_charge_restart);\n\n\tcharger->thresholds.vcharge_min =\n\t\tda9030_millivolt_to_reg(pdata->vcharge_min);\n\tcharger->thresholds.vcharge_max =\n\t\tda9030_millivolt_to_reg(pdata->vcharge_max);\n}\n\nstatic void da9030_battery_setup_psy(struct da9030_charger *charger)\n{\n\tstruct power_supply_desc *psy_desc = &charger->psy_desc;\n\tstruct power_supply_info *info = charger->battery_info;\n\n\tpsy_desc->name = info->name;\n\tpsy_desc->use_for_apm = info->use_for_apm;\n\tpsy_desc->type = POWER_SUPPLY_TYPE_BATTERY;\n\tpsy_desc->get_property = da9030_battery_get_property;\n\n\tpsy_desc->properties = da9030_battery_props;\n\tpsy_desc->num_properties = ARRAY_SIZE(da9030_battery_props);\n};\n\nstatic int da9030_battery_charger_init(struct da9030_charger *charger)\n{\n\tchar v[5];\n\tint ret;\n\n\tv[0] = v[1] = charger->thresholds.vbat_low;\n\tv[2] = charger->thresholds.tbat_high;\n\tv[3] = charger->thresholds.tbat_restart;\n\tv[4] = charger->thresholds.tbat_low;\n\n\tret = da903x_writes(charger->master, DA9030_VBATMON, 5, v);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = da903x_write(charger->master, DA9030_ADC_MAN_CONTROL,\n\t\t\t   DA9030_ADC_LDO_INT_ENABLE |\n\t\t\t   DA9030_ADC_TBATREF_ENABLE);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\treturn da903x_write(charger->master, DA9030_ADC_AUTO_CONTROL,\n\t\t\t    DA9030_ADC_TBAT_ENABLE | DA9030_ADC_VBAT_IN_TXON |\n\t\t\t    DA9030_ADC_VCH_ENABLE | DA9030_ADC_ICH_ENABLE |\n\t\t\t    DA9030_ADC_VBAT_ENABLE |\n\t\t\t    DA9030_ADC_AUTO_SLEEP_ENABLE);\n}\n\nstatic int da9030_battery_probe(struct platform_device *pdev)\n{\n\tstruct da9030_charger *charger;\n\tstruct power_supply_config psy_cfg = {};\n\tstruct da9030_battery_info *pdata = pdev->dev.platform_data;\n\tint ret;\n\n\tif (pdata == NULL)\n\t\treturn -EINVAL;\n\n\tif (pdata->charge_milliamp >= 1500 ||\n\t    pdata->charge_millivolt < 4000 ||\n\t    pdata->charge_millivolt > 4350)\n\t\treturn -EINVAL;\n\n\tcharger = devm_kzalloc(&pdev->dev, sizeof(*charger), GFP_KERNEL);\n\tif (charger == NULL)\n\t\treturn -ENOMEM;\n\n\tcharger->master = pdev->dev.parent;\n\n\t \n\tcharger->interval = msecs_to_jiffies(\n\t\t(pdata->batmon_interval ? : 10) * 1000);\n\n\tcharger->charge_milliamp = pdata->charge_milliamp;\n\tcharger->charge_millivolt = pdata->charge_millivolt;\n\tcharger->battery_info = pdata->battery_info;\n\tcharger->battery_low = pdata->battery_low;\n\tcharger->battery_critical = pdata->battery_critical;\n\n\tda9030_battery_convert_thresholds(charger, pdata);\n\n\tret = da9030_battery_charger_init(charger);\n\tif (ret)\n\t\tgoto err_charger_init;\n\n\tINIT_DELAYED_WORK(&charger->work, da9030_charging_monitor);\n\tschedule_delayed_work(&charger->work, charger->interval);\n\n\tcharger->nb.notifier_call = da9030_battery_event;\n\tret = da903x_register_notifier(charger->master, &charger->nb,\n\t\t\t\t       DA9030_EVENT_CHDET |\n\t\t\t\t       DA9030_EVENT_VBATMON |\n\t\t\t\t       DA9030_EVENT_CHIOVER |\n\t\t\t\t       DA9030_EVENT_TBAT);\n\tif (ret)\n\t\tgoto err_notifier;\n\n\tda9030_battery_setup_psy(charger);\n\tpsy_cfg.drv_data = charger;\n\tcharger->psy = power_supply_register(&pdev->dev, &charger->psy_desc,\n\t\t\t\t\t     &psy_cfg);\n\tif (IS_ERR(charger->psy)) {\n\t\tret = PTR_ERR(charger->psy);\n\t\tgoto err_ps_register;\n\t}\n\n\tcharger->debug_file = da9030_bat_create_debugfs(charger);\n\tplatform_set_drvdata(pdev, charger);\n\treturn 0;\n\nerr_ps_register:\n\tda903x_unregister_notifier(charger->master, &charger->nb,\n\t\t\t\t   DA9030_EVENT_CHDET | DA9030_EVENT_VBATMON |\n\t\t\t\t   DA9030_EVENT_CHIOVER | DA9030_EVENT_TBAT);\nerr_notifier:\n\tcancel_delayed_work(&charger->work);\n\nerr_charger_init:\n\treturn ret;\n}\n\nstatic int da9030_battery_remove(struct platform_device *dev)\n{\n\tstruct da9030_charger *charger = platform_get_drvdata(dev);\n\n\tda9030_bat_remove_debugfs(charger);\n\n\tda903x_unregister_notifier(charger->master, &charger->nb,\n\t\t\t\t   DA9030_EVENT_CHDET | DA9030_EVENT_VBATMON |\n\t\t\t\t   DA9030_EVENT_CHIOVER | DA9030_EVENT_TBAT);\n\tcancel_delayed_work_sync(&charger->work);\n\tda9030_set_charge(charger, 0);\n\tpower_supply_unregister(charger->psy);\n\n\treturn 0;\n}\n\nstatic struct platform_driver da903x_battery_driver = {\n\t.driver\t= {\n\t\t.name\t= \"da903x-battery\",\n\t},\n\t.probe = da9030_battery_probe,\n\t.remove = da9030_battery_remove,\n};\n\nmodule_platform_driver(da903x_battery_driver);\n\nMODULE_DESCRIPTION(\"DA9030 battery charger driver\");\nMODULE_AUTHOR(\"Mike Rapoport, CompuLab\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}