{
  "module_name": "lp8727_charger.c",
  "hash_id": "82c05f79ce34b9333fc48ed28c95dc1785acd2644ff8896f51fb7a0af0774d6f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/lp8727_charger.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/interrupt.h>\n#include <linux/i2c.h>\n#include <linux/power_supply.h>\n#include <linux/platform_data/lp8727.h>\n#include <linux/of.h>\n\n#define LP8788_NUM_INTREGS\t2\n#define DEFAULT_DEBOUNCE_MSEC\t270\n\n \n#define LP8727_CTRL1\t\t0x1\n#define LP8727_CTRL2\t\t0x2\n#define LP8727_SWCTRL\t\t0x3\n#define LP8727_INT1\t\t0x4\n#define LP8727_INT2\t\t0x5\n#define LP8727_STATUS1\t\t0x6\n#define LP8727_STATUS2\t\t0x7\n#define LP8727_CHGCTRL2\t\t0x9\n\n \n#define LP8727_CP_EN\t\tBIT(0)\n#define LP8727_ADC_EN\t\tBIT(1)\n#define LP8727_ID200_EN\t\tBIT(4)\n\n \n#define LP8727_CHGDET_EN\tBIT(1)\n#define LP8727_INT_EN\t\tBIT(6)\n\n \n#define LP8727_SW_DM1_DM\t(0x0 << 0)\n#define LP8727_SW_DM1_HiZ\t(0x7 << 0)\n#define LP8727_SW_DP2_DP\t(0x0 << 3)\n#define LP8727_SW_DP2_HiZ\t(0x7 << 3)\n\n \n#define LP8727_IDNO\t\t(0xF << 0)\n#define LP8727_VBUS\t\tBIT(4)\n\n \n#define LP8727_CHGSTAT\t\t(3 << 4)\n#define LP8727_CHPORT\t\tBIT(6)\n#define LP8727_DCPORT\t\tBIT(7)\n#define LP8727_STAT_EOC\t\t0x30\n\n \n#define LP8727_TEMP_STAT\t(3 << 5)\n#define LP8727_TEMP_SHIFT\t5\n\n \n#define LP8727_ICHG_SHIFT\t4\n\nenum lp8727_dev_id {\n\tLP8727_ID_NONE,\n\tLP8727_ID_TA,\n\tLP8727_ID_DEDICATED_CHG,\n\tLP8727_ID_USB_CHG,\n\tLP8727_ID_USB_DS,\n\tLP8727_ID_MAX,\n};\n\nenum lp8727_die_temp {\n\tLP8788_TEMP_75C,\n\tLP8788_TEMP_95C,\n\tLP8788_TEMP_115C,\n\tLP8788_TEMP_135C,\n};\n\nstruct lp8727_psy {\n\tstruct power_supply *ac;\n\tstruct power_supply *usb;\n\tstruct power_supply *batt;\n};\n\nstruct lp8727_chg {\n\tstruct device *dev;\n\tstruct i2c_client *client;\n\tstruct mutex xfer_lock;\n\tstruct lp8727_psy *psy;\n\tstruct lp8727_platform_data *pdata;\n\n\t \n\tenum lp8727_dev_id devid;\n\tstruct lp8727_chg_param *chg_param;\n\n\t \n\tint irq;\n\tstruct delayed_work work;\n\tunsigned long debounce_jiffies;\n};\n\nstatic int lp8727_read_bytes(struct lp8727_chg *pchg, u8 reg, u8 *data, u8 len)\n{\n\ts32 ret;\n\n\tmutex_lock(&pchg->xfer_lock);\n\tret = i2c_smbus_read_i2c_block_data(pchg->client, reg, len, data);\n\tmutex_unlock(&pchg->xfer_lock);\n\n\treturn (ret != len) ? -EIO : 0;\n}\n\nstatic inline int lp8727_read_byte(struct lp8727_chg *pchg, u8 reg, u8 *data)\n{\n\treturn lp8727_read_bytes(pchg, reg, data, 1);\n}\n\nstatic int lp8727_write_byte(struct lp8727_chg *pchg, u8 reg, u8 data)\n{\n\tint ret;\n\n\tmutex_lock(&pchg->xfer_lock);\n\tret = i2c_smbus_write_byte_data(pchg->client, reg, data);\n\tmutex_unlock(&pchg->xfer_lock);\n\n\treturn ret;\n}\n\nstatic bool lp8727_is_charger_attached(const char *name, int id)\n{\n\tif (!strcmp(name, \"ac\"))\n\t\treturn id == LP8727_ID_TA || id == LP8727_ID_DEDICATED_CHG;\n\telse if (!strcmp(name, \"usb\"))\n\t\treturn id == LP8727_ID_USB_CHG;\n\n\treturn id >= LP8727_ID_TA && id <= LP8727_ID_USB_CHG;\n}\n\nstatic int lp8727_init_device(struct lp8727_chg *pchg)\n{\n\tu8 val;\n\tint ret;\n\tu8 intstat[LP8788_NUM_INTREGS];\n\n\t \n\tret = lp8727_read_bytes(pchg, LP8727_INT1, intstat, LP8788_NUM_INTREGS);\n\tif (ret)\n\t\treturn ret;\n\n\tval = LP8727_ID200_EN | LP8727_ADC_EN | LP8727_CP_EN;\n\tret = lp8727_write_byte(pchg, LP8727_CTRL1, val);\n\tif (ret)\n\t\treturn ret;\n\n\tval = LP8727_INT_EN | LP8727_CHGDET_EN;\n\treturn lp8727_write_byte(pchg, LP8727_CTRL2, val);\n}\n\nstatic int lp8727_is_dedicated_charger(struct lp8727_chg *pchg)\n{\n\tu8 val;\n\n\tlp8727_read_byte(pchg, LP8727_STATUS1, &val);\n\treturn val & LP8727_DCPORT;\n}\n\nstatic int lp8727_is_usb_charger(struct lp8727_chg *pchg)\n{\n\tu8 val;\n\n\tlp8727_read_byte(pchg, LP8727_STATUS1, &val);\n\treturn val & LP8727_CHPORT;\n}\n\nstatic inline void lp8727_ctrl_switch(struct lp8727_chg *pchg, u8 sw)\n{\n\tlp8727_write_byte(pchg, LP8727_SWCTRL, sw);\n}\n\nstatic void lp8727_id_detection(struct lp8727_chg *pchg, u8 id, int vbusin)\n{\n\tstruct lp8727_platform_data *pdata = pchg->pdata;\n\tu8 devid = LP8727_ID_NONE;\n\tu8 swctrl = LP8727_SW_DM1_HiZ | LP8727_SW_DP2_HiZ;\n\n\tswitch (id) {\n\tcase 0x5:\n\t\tdevid = LP8727_ID_TA;\n\t\tpchg->chg_param = pdata ? pdata->ac : NULL;\n\t\tbreak;\n\tcase 0xB:\n\t\tif (lp8727_is_dedicated_charger(pchg)) {\n\t\t\tpchg->chg_param = pdata ? pdata->ac : NULL;\n\t\t\tdevid = LP8727_ID_DEDICATED_CHG;\n\t\t} else if (lp8727_is_usb_charger(pchg)) {\n\t\t\tpchg->chg_param = pdata ? pdata->usb : NULL;\n\t\t\tdevid = LP8727_ID_USB_CHG;\n\t\t\tswctrl = LP8727_SW_DM1_DM | LP8727_SW_DP2_DP;\n\t\t} else if (vbusin) {\n\t\t\tdevid = LP8727_ID_USB_DS;\n\t\t\tswctrl = LP8727_SW_DM1_DM | LP8727_SW_DP2_DP;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tdevid = LP8727_ID_NONE;\n\t\tpchg->chg_param = NULL;\n\t\tbreak;\n\t}\n\n\tpchg->devid = devid;\n\tlp8727_ctrl_switch(pchg, swctrl);\n}\n\nstatic void lp8727_enable_chgdet(struct lp8727_chg *pchg)\n{\n\tu8 val;\n\n\tlp8727_read_byte(pchg, LP8727_CTRL2, &val);\n\tval |= LP8727_CHGDET_EN;\n\tlp8727_write_byte(pchg, LP8727_CTRL2, val);\n}\n\nstatic void lp8727_delayed_func(struct work_struct *_work)\n{\n\tstruct lp8727_chg *pchg = container_of(_work, struct lp8727_chg,\n\t\t\t\t\t\twork.work);\n\tu8 intstat[LP8788_NUM_INTREGS];\n\tu8 idno;\n\tu8 vbus;\n\n\tif (lp8727_read_bytes(pchg, LP8727_INT1, intstat, LP8788_NUM_INTREGS)) {\n\t\tdev_err(pchg->dev, \"can not read INT registers\\n\");\n\t\treturn;\n\t}\n\n\tidno = intstat[0] & LP8727_IDNO;\n\tvbus = intstat[0] & LP8727_VBUS;\n\n\tlp8727_id_detection(pchg, idno, vbus);\n\tlp8727_enable_chgdet(pchg);\n\n\tpower_supply_changed(pchg->psy->ac);\n\tpower_supply_changed(pchg->psy->usb);\n\tpower_supply_changed(pchg->psy->batt);\n}\n\nstatic irqreturn_t lp8727_isr_func(int irq, void *ptr)\n{\n\tstruct lp8727_chg *pchg = ptr;\n\n\tschedule_delayed_work(&pchg->work, pchg->debounce_jiffies);\n\treturn IRQ_HANDLED;\n}\n\nstatic int lp8727_setup_irq(struct lp8727_chg *pchg)\n{\n\tint ret;\n\tint irq = pchg->client->irq;\n\tunsigned delay_msec = pchg->pdata ? pchg->pdata->debounce_msec :\n\t\t\t\t\t\tDEFAULT_DEBOUNCE_MSEC;\n\n\tINIT_DELAYED_WORK(&pchg->work, lp8727_delayed_func);\n\n\tif (irq <= 0) {\n\t\tdev_warn(pchg->dev, \"invalid irq number: %d\\n\", irq);\n\t\treturn 0;\n\t}\n\n\tret = request_threaded_irq(irq,\tNULL, lp8727_isr_func,\n\t\t\t\tIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\n\t\t\t\t\"lp8727_irq\", pchg);\n\n\tif (ret)\n\t\treturn ret;\n\n\tpchg->irq = irq;\n\tpchg->debounce_jiffies = msecs_to_jiffies(delay_msec);\n\n\treturn 0;\n}\n\nstatic void lp8727_release_irq(struct lp8727_chg *pchg)\n{\n\tcancel_delayed_work_sync(&pchg->work);\n\n\tif (pchg->irq)\n\t\tfree_irq(pchg->irq, pchg);\n}\n\nstatic enum power_supply_property lp8727_charger_prop[] = {\n\tPOWER_SUPPLY_PROP_ONLINE,\n};\n\nstatic enum power_supply_property lp8727_battery_prop[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_TEMP,\n};\n\nstatic char *battery_supplied_to[] = {\n\t\"main_batt\",\n};\n\nstatic int lp8727_charger_get_property(struct power_supply *psy,\n\t\t\t\t       enum power_supply_property psp,\n\t\t\t\t       union power_supply_propval *val)\n{\n\tstruct lp8727_chg *pchg = dev_get_drvdata(psy->dev.parent);\n\n\tif (psp != POWER_SUPPLY_PROP_ONLINE)\n\t\treturn -EINVAL;\n\n\tval->intval = lp8727_is_charger_attached(psy->desc->name, pchg->devid);\n\n\treturn 0;\n}\n\nstatic bool lp8727_is_high_temperature(enum lp8727_die_temp temp)\n{\n\tswitch (temp) {\n\tcase LP8788_TEMP_95C:\n\tcase LP8788_TEMP_115C:\n\tcase LP8788_TEMP_135C:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic int lp8727_battery_get_property(struct power_supply *psy,\n\t\t\t\t       enum power_supply_property psp,\n\t\t\t\t       union power_supply_propval *val)\n{\n\tstruct lp8727_chg *pchg = dev_get_drvdata(psy->dev.parent);\n\tstruct lp8727_platform_data *pdata = pchg->pdata;\n\tenum lp8727_die_temp temp;\n\tu8 read;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tif (!lp8727_is_charger_attached(psy->desc->name, pchg->devid)) {\n\t\t\tval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\n\t\t\treturn 0;\n\t\t}\n\n\t\tlp8727_read_byte(pchg, LP8727_STATUS1, &read);\n\n\t\tval->intval = (read & LP8727_CHGSTAT) == LP8727_STAT_EOC ?\n\t\t\t\tPOWER_SUPPLY_STATUS_FULL :\n\t\t\t\tPOWER_SUPPLY_STATUS_CHARGING;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tlp8727_read_byte(pchg, LP8727_STATUS2, &read);\n\t\ttemp = (read & LP8727_TEMP_STAT) >> LP8727_TEMP_SHIFT;\n\n\t\tval->intval = lp8727_is_high_temperature(temp) ?\n\t\t\tPOWER_SUPPLY_HEALTH_OVERHEAT :\n\t\t\tPOWER_SUPPLY_HEALTH_GOOD;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tif (!pdata)\n\t\t\treturn -EINVAL;\n\n\t\tif (pdata->get_batt_present)\n\t\t\tval->intval = pdata->get_batt_present();\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tif (!pdata)\n\t\t\treturn -EINVAL;\n\n\t\tif (pdata->get_batt_level)\n\t\t\tval->intval = pdata->get_batt_level();\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CAPACITY:\n\t\tif (!pdata)\n\t\t\treturn -EINVAL;\n\n\t\tif (pdata->get_batt_capacity)\n\t\t\tval->intval = pdata->get_batt_capacity();\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TEMP:\n\t\tif (!pdata)\n\t\t\treturn -EINVAL;\n\n\t\tif (pdata->get_batt_temp)\n\t\t\tval->intval = pdata->get_batt_temp();\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic void lp8727_charger_changed(struct power_supply *psy)\n{\n\tstruct lp8727_chg *pchg = dev_get_drvdata(psy->dev.parent);\n\tu8 eoc_level;\n\tu8 ichg;\n\tu8 val;\n\n\t \n\tif (!lp8727_is_charger_attached(psy->desc->name, pchg->devid))\n\t\treturn;\n\n\t \n\tif (pchg->chg_param) {\n\t\teoc_level = pchg->chg_param->eoc_level;\n\t\tichg = pchg->chg_param->ichg;\n\t\tval = (ichg << LP8727_ICHG_SHIFT) | eoc_level;\n\t\tlp8727_write_byte(pchg, LP8727_CHGCTRL2, val);\n\t}\n}\n\nstatic const struct power_supply_desc lp8727_ac_desc = {\n\t.name\t\t\t= \"ac\",\n\t.type\t\t\t= POWER_SUPPLY_TYPE_MAINS,\n\t.properties\t\t= lp8727_charger_prop,\n\t.num_properties\t\t= ARRAY_SIZE(lp8727_charger_prop),\n\t.get_property\t\t= lp8727_charger_get_property,\n};\n\nstatic const struct power_supply_desc lp8727_usb_desc = {\n\t.name\t\t\t= \"usb\",\n\t.type\t\t\t= POWER_SUPPLY_TYPE_USB,\n\t.properties\t\t= lp8727_charger_prop,\n\t.num_properties\t\t= ARRAY_SIZE(lp8727_charger_prop),\n\t.get_property\t\t= lp8727_charger_get_property,\n};\n\nstatic const struct power_supply_desc lp8727_batt_desc = {\n\t.name\t\t\t= \"main_batt\",\n\t.type\t\t\t= POWER_SUPPLY_TYPE_BATTERY,\n\t.properties\t\t= lp8727_battery_prop,\n\t.num_properties\t\t= ARRAY_SIZE(lp8727_battery_prop),\n\t.get_property\t\t= lp8727_battery_get_property,\n\t.external_power_changed\t= lp8727_charger_changed,\n};\n\nstatic int lp8727_register_psy(struct lp8727_chg *pchg)\n{\n\tstruct power_supply_config psy_cfg = {};  \n\tstruct lp8727_psy *psy;\n\n\tpsy = devm_kzalloc(pchg->dev, sizeof(*psy), GFP_KERNEL);\n\tif (!psy)\n\t\treturn -ENOMEM;\n\n\tpchg->psy = psy;\n\n\tpsy_cfg.supplied_to = battery_supplied_to;\n\tpsy_cfg.num_supplicants = ARRAY_SIZE(battery_supplied_to);\n\n\tpsy->ac = power_supply_register(pchg->dev, &lp8727_ac_desc, &psy_cfg);\n\tif (IS_ERR(psy->ac))\n\t\tgoto err_psy_ac;\n\n\tpsy->usb = power_supply_register(pchg->dev, &lp8727_usb_desc,\n\t\t\t\t\t &psy_cfg);\n\tif (IS_ERR(psy->usb))\n\t\tgoto err_psy_usb;\n\n\tpsy->batt = power_supply_register(pchg->dev, &lp8727_batt_desc, NULL);\n\tif (IS_ERR(psy->batt))\n\t\tgoto err_psy_batt;\n\n\treturn 0;\n\nerr_psy_batt:\n\tpower_supply_unregister(psy->usb);\nerr_psy_usb:\n\tpower_supply_unregister(psy->ac);\nerr_psy_ac:\n\treturn -EPERM;\n}\n\nstatic void lp8727_unregister_psy(struct lp8727_chg *pchg)\n{\n\tstruct lp8727_psy *psy = pchg->psy;\n\n\tif (!psy)\n\t\treturn;\n\n\tpower_supply_unregister(psy->ac);\n\tpower_supply_unregister(psy->usb);\n\tpower_supply_unregister(psy->batt);\n}\n\n#ifdef CONFIG_OF\nstatic struct lp8727_chg_param\n*lp8727_parse_charge_pdata(struct device *dev, struct device_node *np)\n{\n\tstruct lp8727_chg_param *param;\n\n\tparam = devm_kzalloc(dev, sizeof(*param), GFP_KERNEL);\n\tif (!param)\n\t\tgoto out;\n\n\tof_property_read_u8(np, \"eoc-level\", (u8 *)&param->eoc_level);\n\tof_property_read_u8(np, \"charging-current\", (u8 *)&param->ichg);\nout:\n\treturn param;\n}\n\nstatic struct lp8727_platform_data *lp8727_parse_dt(struct device *dev)\n{\n\tstruct device_node *np = dev->of_node;\n\tstruct device_node *child;\n\tstruct lp8727_platform_data *pdata;\n\tconst char *type;\n\n\tpdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\n\tif (!pdata)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tof_property_read_u32(np, \"debounce-ms\", &pdata->debounce_msec);\n\n\t \n\tif (of_get_child_count(np) == 0)\n\t\treturn pdata;\n\n\tfor_each_child_of_node(np, child) {\n\t\tof_property_read_string(child, \"charger-type\", &type);\n\n\t\tif (!strcmp(type, \"ac\"))\n\t\t\tpdata->ac = lp8727_parse_charge_pdata(dev, child);\n\n\t\tif (!strcmp(type, \"usb\"))\n\t\t\tpdata->usb = lp8727_parse_charge_pdata(dev, child);\n\t}\n\n\treturn pdata;\n}\n#else\nstatic struct lp8727_platform_data *lp8727_parse_dt(struct device *dev)\n{\n\treturn NULL;\n}\n#endif\n\nstatic int lp8727_probe(struct i2c_client *cl)\n{\n\tstruct lp8727_chg *pchg;\n\tstruct lp8727_platform_data *pdata;\n\tint ret;\n\n\tif (!i2c_check_functionality(cl->adapter, I2C_FUNC_SMBUS_I2C_BLOCK))\n\t\treturn -EIO;\n\n\tif (cl->dev.of_node) {\n\t\tpdata = lp8727_parse_dt(&cl->dev);\n\t\tif (IS_ERR(pdata))\n\t\t\treturn PTR_ERR(pdata);\n\t} else {\n\t\tpdata = dev_get_platdata(&cl->dev);\n\t}\n\n\tpchg = devm_kzalloc(&cl->dev, sizeof(*pchg), GFP_KERNEL);\n\tif (!pchg)\n\t\treturn -ENOMEM;\n\n\tpchg->client = cl;\n\tpchg->dev = &cl->dev;\n\tpchg->pdata = pdata;\n\ti2c_set_clientdata(cl, pchg);\n\n\tmutex_init(&pchg->xfer_lock);\n\n\tret = lp8727_init_device(pchg);\n\tif (ret) {\n\t\tdev_err(pchg->dev, \"i2c communication err: %d\", ret);\n\t\treturn ret;\n\t}\n\n\tret = lp8727_register_psy(pchg);\n\tif (ret) {\n\t\tdev_err(pchg->dev, \"power supplies register err: %d\", ret);\n\t\treturn ret;\n\t}\n\n\tret = lp8727_setup_irq(pchg);\n\tif (ret) {\n\t\tdev_err(pchg->dev, \"irq handler err: %d\", ret);\n\t\tlp8727_unregister_psy(pchg);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic void lp8727_remove(struct i2c_client *cl)\n{\n\tstruct lp8727_chg *pchg = i2c_get_clientdata(cl);\n\n\tlp8727_release_irq(pchg);\n\tlp8727_unregister_psy(pchg);\n}\n\nstatic const struct of_device_id lp8727_dt_ids[] __maybe_unused = {\n\t{ .compatible = \"ti,lp8727\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, lp8727_dt_ids);\n\nstatic const struct i2c_device_id lp8727_ids[] = {\n\t{\"lp8727\", 0},\n\t{ }\n};\nMODULE_DEVICE_TABLE(i2c, lp8727_ids);\n\nstatic struct i2c_driver lp8727_driver = {\n\t.driver = {\n\t\t   .name = \"lp8727\",\n\t\t   .of_match_table = of_match_ptr(lp8727_dt_ids),\n\t\t   },\n\t.probe = lp8727_probe,\n\t.remove = lp8727_remove,\n\t.id_table = lp8727_ids,\n};\nmodule_i2c_driver(lp8727_driver);\n\nMODULE_DESCRIPTION(\"TI/National Semiconductor LP8727 charger driver\");\nMODULE_AUTHOR(\"Milo Kim <milo.kim@ti.com>, Daniel Jeong <daniel.jeong@ti.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}