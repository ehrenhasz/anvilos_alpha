{
  "module_name": "rx51_battery.c",
  "hash_id": "e84997c8589ef7aa9d90988ca8153ab9c5f455dd91e85d6be2eebebf3bfc0e8f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/rx51_battery.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/param.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/slab.h>\n#include <linux/iio/consumer.h>\n#include <linux/of.h>\n\nstruct rx51_device_info {\n\tstruct device *dev;\n\tstruct power_supply *bat;\n\tstruct power_supply_desc bat_desc;\n\tstruct iio_channel *channel_temp;\n\tstruct iio_channel *channel_bsi;\n\tstruct iio_channel *channel_vbat;\n};\n\n \nstatic int rx51_battery_read_adc(struct iio_channel *channel)\n{\n\tint val, err;\n\terr = iio_read_channel_average_raw(channel, &val);\n\tif (err < 0)\n\t\treturn err;\n\treturn val;\n}\n\n \nstatic int rx51_battery_read_voltage(struct rx51_device_info *di)\n{\n\tint voltage = rx51_battery_read_adc(di->channel_vbat);\n\n\tif (voltage < 0) {\n\t\tdev_err(di->dev, \"Could not read ADC: %d\\n\", voltage);\n\t\treturn voltage;\n\t}\n\n\treturn 1000 * (10000 * voltage / 1705);\n}\n\n \n\n \nstatic u8 rx51_temp_table1[] = {\n\t255, 201, 159, 138, 124, 114, 106,  99,  94,  89,  85,  82,  78,  75,\n\t 73,  70,  68,  66,  64,  62,  61,  59,  57,  56,  55\n};\n\n \n#define rx51_temp_table2_first 53\nstatic u16 rx51_temp_table2[] = {\n\t 25,  26,  27,  28,  29,  30,  31,  32,  33,  34,  35,  36,  37,  39,\n\t 40,  41,  43,  44,  46,  48,  49,  51,  53,  55,  57,  59,  61,  64,\n\t 66,  69,  71,  74,  77,  80,  83,  86,  90,  94,  97, 101, 106, 110,\n\t115, 119, 125, 130, 136, 141, 148, 154, 161, 168, 176, 184, 202, 211,\n\t221, 231, 242, 254, 266, 279, 293, 308, 323, 340, 357, 375, 395, 415,\n\t437, 460, 485, 511, 539, 568, 600, 633, 669, 706, 747, 790, 836, 885,\n\t937, 993, 1024\n};\n\n \nstatic int rx51_battery_read_temperature(struct rx51_device_info *di)\n{\n\tint min = 0;\n\tint max = ARRAY_SIZE(rx51_temp_table2) - 1;\n\tint raw = rx51_battery_read_adc(di->channel_temp);\n\n\tif (raw < 0)\n\t\tdev_err(di->dev, \"Could not read ADC: %d\\n\", raw);\n\n\t \n\tif (raw <= 0)\n\t\treturn INT_MAX;\n\n\t \n\tif (raw >= (1 << 10))\n\t\treturn INT_MIN;\n\n\t \n\tif (raw < ARRAY_SIZE(rx51_temp_table1))\n\t\treturn rx51_temp_table1[raw] * 10;\n\n\t \n\twhile (max - min > 1) {\n\t\tint mid = (max + min) / 2;\n\t\tif (rx51_temp_table2[mid] <= raw)\n\t\t\tmin = mid;\n\t\telse if (rx51_temp_table2[mid] > raw)\n\t\t\tmax = mid;\n\t\tif (rx51_temp_table2[mid] == raw)\n\t\t\tbreak;\n\t}\n\n\treturn (rx51_temp_table2_first - min) * 10;\n}\n\n \nstatic int rx51_battery_read_capacity(struct rx51_device_info *di)\n{\n\tint capacity = rx51_battery_read_adc(di->channel_bsi);\n\n\tif (capacity < 0) {\n\t\tdev_err(di->dev, \"Could not read ADC: %d\\n\", capacity);\n\t\treturn capacity;\n\t}\n\n\treturn 1280 * (1200 * capacity)/(1024 - capacity);\n}\n\n \nstatic int rx51_battery_get_property(struct power_supply *psy,\n\t\t\t\t\tenum power_supply_property psp,\n\t\t\t\t\tunion power_supply_propval *val)\n{\n\tstruct rx51_device_info *di = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\n\t\tval->intval = 4200000;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tval->intval = rx51_battery_read_voltage(di) ? 1 : 0;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tval->intval = rx51_battery_read_voltage(di);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TEMP:\n\t\tval->intval = rx51_battery_read_temperature(di);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN:\n\t\tval->intval = rx51_battery_read_capacity(di);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (val->intval == INT_MAX || val->intval == INT_MIN)\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic enum power_supply_property rx51_battery_props[] = {\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n};\n\nstatic int rx51_battery_probe(struct platform_device *pdev)\n{\n\tstruct power_supply_config psy_cfg = {};\n\tstruct rx51_device_info *di;\n\tint ret;\n\n\tdi = devm_kzalloc(&pdev->dev, sizeof(*di), GFP_KERNEL);\n\tif (!di)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, di);\n\n\tdi->dev = &pdev->dev;\n\tdi->bat_desc.name = \"rx51-battery\";\n\tdi->bat_desc.type = POWER_SUPPLY_TYPE_BATTERY;\n\tdi->bat_desc.properties = rx51_battery_props;\n\tdi->bat_desc.num_properties = ARRAY_SIZE(rx51_battery_props);\n\tdi->bat_desc.get_property = rx51_battery_get_property;\n\n\tpsy_cfg.drv_data = di;\n\n\tdi->channel_temp = iio_channel_get(di->dev, \"temp\");\n\tif (IS_ERR(di->channel_temp)) {\n\t\tret = PTR_ERR(di->channel_temp);\n\t\tgoto error;\n\t}\n\n\tdi->channel_bsi  = iio_channel_get(di->dev, \"bsi\");\n\tif (IS_ERR(di->channel_bsi)) {\n\t\tret = PTR_ERR(di->channel_bsi);\n\t\tgoto error_channel_temp;\n\t}\n\n\tdi->channel_vbat = iio_channel_get(di->dev, \"vbat\");\n\tif (IS_ERR(di->channel_vbat)) {\n\t\tret = PTR_ERR(di->channel_vbat);\n\t\tgoto error_channel_bsi;\n\t}\n\n\tdi->bat = power_supply_register(di->dev, &di->bat_desc, &psy_cfg);\n\tif (IS_ERR(di->bat)) {\n\t\tret = PTR_ERR(di->bat);\n\t\tgoto error_channel_vbat;\n\t}\n\n\treturn 0;\n\nerror_channel_vbat:\n\tiio_channel_release(di->channel_vbat);\nerror_channel_bsi:\n\tiio_channel_release(di->channel_bsi);\nerror_channel_temp:\n\tiio_channel_release(di->channel_temp);\nerror:\n\n\treturn ret;\n}\n\nstatic int rx51_battery_remove(struct platform_device *pdev)\n{\n\tstruct rx51_device_info *di = platform_get_drvdata(pdev);\n\n\tpower_supply_unregister(di->bat);\n\n\tiio_channel_release(di->channel_vbat);\n\tiio_channel_release(di->channel_bsi);\n\tiio_channel_release(di->channel_temp);\n\n\treturn 0;\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id n900_battery_of_match[] = {\n\t{.compatible = \"nokia,n900-battery\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, n900_battery_of_match);\n#endif\n\nstatic struct platform_driver rx51_battery_driver = {\n\t.probe = rx51_battery_probe,\n\t.remove = rx51_battery_remove,\n\t.driver = {\n\t\t.name = \"rx51-battery\",\n\t\t.of_match_table = of_match_ptr(n900_battery_of_match),\n\t},\n};\nmodule_platform_driver(rx51_battery_driver);\n\nMODULE_ALIAS(\"platform:rx51-battery\");\nMODULE_AUTHOR(\"Pali Roh\u00e1r <pali@kernel.org>\");\nMODULE_DESCRIPTION(\"Nokia RX-51 battery driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}