{
  "module_name": "lego_ev3_battery.c",
  "hash_id": "a59a866e509ce2484a6365d07932d5abf2c6dc65eb7f5f9ecce88ae8763e89e4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/lego_ev3_battery.c",
  "human_readable_source": " \n\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/gpio/consumer.h>\n#include <linux/iio/consumer.h>\n#include <linux/iio/types.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n\nstruct lego_ev3_battery {\n\tstruct iio_channel *iio_v;\n\tstruct iio_channel *iio_i;\n\tstruct gpio_desc *rechargeable_gpio;\n\tstruct power_supply *psy;\n\tint technology;\n\tint v_max;\n\tint v_min;\n};\n\nstatic int lego_ev3_battery_get_property(struct power_supply *psy,\n\t\t\t\t\t enum power_supply_property psp,\n\t\t\t\t\t union power_supply_propval *val)\n{\n\tstruct lego_ev3_battery *batt = power_supply_get_drvdata(psy);\n\tint ret, val2;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tval->intval = batt->technology;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\t \n\t\tret = iio_read_channel_processed(batt->iio_v, &val->intval);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tval->intval *= 2000;\n\t\tval->intval += 50000;\n\n\t\t \n\t\tret = iio_read_channel_processed(batt->iio_i, &val2);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tval2 *= 1000;\n\t\tval2 /= 15;\n\t\tval->intval += val2;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\n\t\tval->intval = batt->v_max;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\n\t\tval->intval = batt->v_min;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_NOW:\n\t\t \n\t\tret = iio_read_channel_processed(batt->iio_i, &val->intval);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tval->intval *= 20000;\n\t\tval->intval /= 15;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_SCOPE:\n\t\tval->intval = POWER_SUPPLY_SCOPE_SYSTEM;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int lego_ev3_battery_set_property(struct power_supply *psy,\n\t\t\t\t\t enum power_supply_property psp,\n\t\t\t\t\t const union power_supply_propval *val)\n{\n\tstruct lego_ev3_battery *batt = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\t \n\t\tif (batt->technology != POWER_SUPPLY_TECHNOLOGY_UNKNOWN)\n\t\t\treturn -EINVAL;\n\t\tswitch (val->intval) {\n\t\tcase POWER_SUPPLY_TECHNOLOGY_NiMH:\n\t\t\tbatt->technology = POWER_SUPPLY_TECHNOLOGY_NiMH;\n\t\t\tbatt->v_max = 7800000;\n\t\t\tbatt->v_min = 5400000;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int lego_ev3_battery_property_is_writeable(struct power_supply *psy,\n\t\t\t\t\t\t  enum power_supply_property psp)\n{\n\tstruct lego_ev3_battery *batt = power_supply_get_drvdata(psy);\n\n\treturn psp == POWER_SUPPLY_PROP_TECHNOLOGY &&\n\t\tbatt->technology == POWER_SUPPLY_TECHNOLOGY_UNKNOWN;\n}\n\nstatic enum power_supply_property lego_ev3_battery_props[] = {\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_SCOPE,\n};\n\nstatic const struct power_supply_desc lego_ev3_battery_desc = {\n\t.name\t\t\t= \"lego-ev3-battery\",\n\t.type\t\t\t= POWER_SUPPLY_TYPE_BATTERY,\n\t.properties\t\t= lego_ev3_battery_props,\n\t.num_properties\t\t= ARRAY_SIZE(lego_ev3_battery_props),\n\t.get_property\t\t= lego_ev3_battery_get_property,\n\t.set_property\t\t= lego_ev3_battery_set_property,\n\t.property_is_writeable\t= lego_ev3_battery_property_is_writeable,\n};\n\nstatic int lego_ev3_battery_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct lego_ev3_battery *batt;\n\tstruct power_supply_config psy_cfg = {};\n\tint err;\n\n\tbatt = devm_kzalloc(dev, sizeof(*batt), GFP_KERNEL);\n\tif (!batt)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, batt);\n\n\tbatt->iio_v = devm_iio_channel_get(dev, \"voltage\");\n\terr = PTR_ERR_OR_ZERO(batt->iio_v);\n\tif (err)\n\t\treturn dev_err_probe(dev, err,\n\t\t\t\t     \"Failed to get voltage iio channel\\n\");\n\n\tbatt->iio_i = devm_iio_channel_get(dev, \"current\");\n\terr = PTR_ERR_OR_ZERO(batt->iio_i);\n\tif (err)\n\t\treturn dev_err_probe(dev, err,\n\t\t\t\t     \"Failed to get current iio channel\\n\");\n\n\tbatt->rechargeable_gpio = devm_gpiod_get(dev, \"rechargeable\", GPIOD_IN);\n\terr = PTR_ERR_OR_ZERO(batt->rechargeable_gpio);\n\tif (err)\n\t\treturn dev_err_probe(dev, err,\n\t\t\t\t     \"Failed to get rechargeable gpio\\n\");\n\n\t \n\tif (gpiod_get_value(batt->rechargeable_gpio)) {\n\t\t \n\t\tbatt->technology = POWER_SUPPLY_TECHNOLOGY_LION;\n\t\tbatt->v_max = 84000000;\n\t\tbatt->v_min = 60000000;\n\t} else {\n\t\t \n\t\tbatt->technology = POWER_SUPPLY_TECHNOLOGY_UNKNOWN;\n\t\tbatt->v_max = 90000000;\n\t\tbatt->v_min = 48000000;\n\t}\n\n\tpsy_cfg.of_node = pdev->dev.of_node;\n\tpsy_cfg.drv_data = batt;\n\n\tbatt->psy = devm_power_supply_register(dev, &lego_ev3_battery_desc,\n\t\t\t\t\t       &psy_cfg);\n\terr = PTR_ERR_OR_ZERO(batt->psy);\n\tif (err) {\n\t\tdev_err(dev, \"failed to register power supply\\n\");\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id of_lego_ev3_battery_match[] = {\n\t{ .compatible = \"lego,ev3-battery\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, of_lego_ev3_battery_match);\n\nstatic struct platform_driver lego_ev3_battery_driver = {\n\t.driver\t= {\n\t\t.name\t\t= \"lego-ev3-battery\",\n\t\t.of_match_table = of_lego_ev3_battery_match,\n\t},\n\t.probe\t= lego_ev3_battery_probe,\n};\nmodule_platform_driver(lego_ev3_battery_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"David Lechner <david@lechnology.com>\");\nMODULE_DESCRIPTION(\"LEGO MINDSTORMS EV3 Battery Driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}