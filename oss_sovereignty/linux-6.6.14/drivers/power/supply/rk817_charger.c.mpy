{
  "module_name": "rk817_charger.c",
  "hash_id": "df9d8e61c25501b1fbd2a396f3f109d8bb5a4cf91dbe09480090342380fa012b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/rk817_charger.c",
  "human_readable_source": "\n \n\n#include <asm/unaligned.h>\n#include <linux/devm-helpers.h>\n#include <linux/mfd/rk808.h>\n#include <linux/irq.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/regmap.h>\n\n \nenum rk817_charge_status {\n\tCHRG_OFF,\n\tDEAD_CHRG,\n\tTRICKLE_CHRG,\n\tCC_OR_CV_CHRG,\n\tCHARGE_FINISH,\n\tUSB_OVER_VOL,\n\tBAT_TMP_ERR,\n\tBAT_TIM_ERR,\n};\n\n \nenum rk817_chg_cur {\n\tCHG_1A,\n\tCHG_1_5A,\n\tCHG_2A,\n\tCHG_2_5A,\n\tCHG_2_75A,\n\tCHG_3A,\n\tCHG_3_5A,\n\tCHG_0_5A,\n};\n\nstruct rk817_charger {\n\tstruct device *dev;\n\tstruct rk808 *rk808;\n\n\tstruct power_supply *bat_ps;\n\tstruct power_supply *chg_ps;\n\tbool plugged_in;\n\tbool battery_present;\n\n\t \n\n\tuint32_t voltage_k;\n\tuint32_t voltage_b;\n\n\t \n\tint soc;\n\n\t \n\tint fcc_mah;\n\n\t \n\tbool soc_cal;\n\n\t \n\tint res_div;\n\tint sleep_enter_current_ua;\n\tint sleep_filter_current_ua;\n\tint bat_charge_full_design_uah;\n\tint bat_voltage_min_design_uv;\n\tint bat_voltage_max_design_uv;\n\n\t \n\tint charge_now_uah;\n\tint volt_avg_uv;\n\tint cur_avg_ua;\n\tint max_chg_cur_ua;\n\tint max_chg_volt_uv;\n\tint charge_status;\n\tint charger_input_volt_avg_uv;\n\n\t \n\tstruct delayed_work work;\n};\n\n \n#define ADC_TO_CURRENT(adc_value, res_div)\t\\\n\t(adc_value * 172 / res_div)\n\n#define CURRENT_TO_ADC(current, samp_res)\t\\\n\t(current * samp_res / 172)\n\n#define CHARGE_TO_ADC(capacity, res_div)\t\\\n\t(capacity * res_div * 3600 / 172 * 1000)\n\n#define ADC_TO_CHARGE_UAH(adc_value, res_div)\t\\\n\t(adc_value / 3600 * 172 / res_div)\n\nstatic int rk817_chg_cur_to_reg(u32 chg_cur_ma)\n{\n\tif (chg_cur_ma >= 3500)\n\t\treturn CHG_3_5A;\n\telse if (chg_cur_ma >= 3000)\n\t\treturn CHG_3A;\n\telse if (chg_cur_ma >= 2750)\n\t\treturn CHG_2_75A;\n\telse if (chg_cur_ma >= 2500)\n\t\treturn CHG_2_5A;\n\telse if (chg_cur_ma >= 2000)\n\t\treturn CHG_2A;\n\telse if (chg_cur_ma >= 1500)\n\t\treturn CHG_1_5A;\n\telse if (chg_cur_ma >= 1000)\n\t\treturn CHG_1A;\n\telse if (chg_cur_ma >= 500)\n\t\treturn CHG_0_5A;\n\telse\n\t\treturn -EINVAL;\n}\n\nstatic int rk817_chg_cur_from_reg(u8 reg)\n{\n\tswitch (reg) {\n\tcase CHG_0_5A:\n\t\treturn 500000;\n\tcase CHG_1A:\n\t\treturn 1000000;\n\tcase CHG_1_5A:\n\t\treturn 1500000;\n\tcase CHG_2A:\n\t\treturn 2000000;\n\tcase CHG_2_5A:\n\t\treturn 2500000;\n\tcase CHG_2_75A:\n\t\treturn 2750000;\n\tcase CHG_3A:\n\t\treturn 3000000;\n\tcase CHG_3_5A:\n\t\treturn 3500000;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic void rk817_bat_calib_vol(struct rk817_charger *charger)\n{\n\tuint32_t vcalib0 = 0;\n\tuint32_t vcalib1 = 0;\n\tu8 bulk_reg[2];\n\n\t \n\tregmap_bulk_read(charger->rk808->regmap, RK817_GAS_GAUGE_VCALIB0_H,\n\t\t\t bulk_reg, 2);\n\tvcalib0 = get_unaligned_be16(bulk_reg);\n\n\tregmap_bulk_read(charger->rk808->regmap, RK817_GAS_GAUGE_VCALIB1_H,\n\t\t\t bulk_reg, 2);\n\tvcalib1 = get_unaligned_be16(bulk_reg);\n\n\t \n\tcharger->voltage_k = (4025 - 2300) * 1000 /\n\t\t\t     ((vcalib1 - vcalib0) ? (vcalib1 - vcalib0) : 1);\n\tcharger->voltage_b = 4025 - (charger->voltage_k * vcalib1) / 1000;\n}\n\nstatic void rk817_bat_calib_cur(struct rk817_charger *charger)\n{\n\tu8 bulk_reg[2];\n\n\t \n\tregmap_bulk_read(charger->rk808->regmap, RK817_GAS_GAUGE_IOFFSET_H,\n\t\t\t bulk_reg, 2);\n\tregmap_bulk_write(charger->rk808->regmap, RK817_GAS_GAUGE_CAL_OFFSET_H,\n\t\t\t  bulk_reg, 2);\n}\n\n \nstatic int rk817_record_battery_nvram_values(struct rk817_charger *charger)\n{\n\tu8 bulk_reg[3];\n\tint ret, rsoc;\n\n\t \n\tput_unaligned_le24(charger->soc, bulk_reg);\n\tret = regmap_bulk_write(charger->rk808->regmap, RK817_GAS_GAUGE_BAT_R1,\n\t\t\t\tbulk_reg, 3);\n\tif (ret < 0)\n\t\treturn ret;\n\t \n\trsoc = (charger->soc * charger->fcc_mah) / 100000;\n\tput_unaligned_le24(rsoc, bulk_reg);\n\tret = regmap_bulk_write(charger->rk808->regmap, RK817_GAS_GAUGE_DATA0,\n\t\t\t\tbulk_reg, 3);\n\tif (ret < 0)\n\t\treturn ret;\n\t \n\tput_unaligned_le24(charger->fcc_mah, bulk_reg);\n\tret = regmap_bulk_write(charger->rk808->regmap, RK817_GAS_GAUGE_DATA3,\n\t\t\t\tbulk_reg, 3);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int rk817_bat_calib_cap(struct rk817_charger *charger)\n{\n\tstruct rk808 *rk808 = charger->rk808;\n\tint tmp, charge_now, charge_now_adc, volt_avg;\n\tu8 bulk_reg[4];\n\n\t \n\n\tif (charger->charge_status == CHARGE_FINISH && (!charger->soc_cal)) {\n\t\t \n\n\t\tcharger->soc = 100000;\n\t\tcharge_now_adc = CHARGE_TO_ADC(charger->fcc_mah,\n\t\t\t\t\t       charger->res_div);\n\t\tput_unaligned_be32(charge_now_adc, bulk_reg);\n\t\tregmap_bulk_write(rk808->regmap, RK817_GAS_GAUGE_Q_INIT_H3,\n\t\t\t\t  bulk_reg, 4);\n\n\t\tcharger->soc_cal = 1;\n\t\tdev_dbg(charger->dev,\n\t\t\t\"Fully charged. SOC is %d, full capacity is %d\\n\",\n\t\t\tcharger->soc, charger->fcc_mah * 1000);\n\t}\n\n\t \n\tif (charger->charge_status == CHARGE_FINISH && charger->soc_cal) {\n\t\tregmap_bulk_read(rk808->regmap, RK817_GAS_GAUGE_Q_PRES_H3,\n\t\t\t\t bulk_reg, 4);\n\t\tcharge_now_adc = get_unaligned_be32(bulk_reg);\n\t\tif (charge_now_adc < 0)\n\t\t\treturn charge_now_adc;\n\t\tcharge_now = ADC_TO_CHARGE_UAH(charge_now_adc,\n\t\t\t\t\t       charger->res_div);\n\n\t\t \n\t\tif (charge_now / 1000 > charger->fcc_mah) {\n\t\t\tdev_dbg(charger->dev,\n\t\t\t\t\"Recalibrating columb counter to %d uah\\n\",\n\t\t\t\tcharge_now);\n\t\t\t \n\t\t\tcharge_now_adc = CHARGE_TO_ADC(charger->fcc_mah,\n\t\t\t\t\t charger->res_div);\n\t\t\tput_unaligned_be32(charge_now_adc, bulk_reg);\n\t\t\tregmap_bulk_write(rk808->regmap,\n\t\t\t\t\t  RK817_GAS_GAUGE_Q_INIT_H3,\n\t\t\t\t\t  bulk_reg, 4);\n\t\t}\n\t}\n\n\t \n\tregmap_bulk_read(charger->rk808->regmap, RK817_GAS_GAUGE_BAT_VOL_H,\n\t\t\t bulk_reg, 2);\n\ttmp = get_unaligned_be16(bulk_reg);\n\tvolt_avg = (charger->voltage_k * tmp) + 1000 * charger->voltage_b;\n\tif (volt_avg <= charger->bat_voltage_min_design_uv &&\n\t    charger->soc_cal) {\n\t\tregmap_bulk_read(rk808->regmap, RK817_GAS_GAUGE_Q_PRES_H3,\n\t\t\t\t bulk_reg, 4);\n\t\tcharge_now_adc = get_unaligned_be32(bulk_reg);\n\t\tcharge_now = ADC_TO_CHARGE_UAH(charge_now_adc,\n\t\t\t\t\t       charger->res_div);\n\t\t \n\t\tcharger->fcc_mah = charger->fcc_mah - (charge_now / 1000);\n\n\t\tdev_dbg(charger->dev,\n\t\t\t\"Recalibrating full charge capacity to %d uah\\n\",\n\t\t\tcharger->fcc_mah * 1000);\n\t}\n\n\t \n\tif (volt_avg <= charger->bat_voltage_min_design_uv) {\n\t\tcharger->soc = 0;\n\t\tcharge_now_adc = CHARGE_TO_ADC(0, charger->res_div);\n\t\tput_unaligned_be32(charge_now_adc, bulk_reg);\n\t\tregmap_bulk_write(rk808->regmap,\n\t\t\t\t  RK817_GAS_GAUGE_Q_INIT_H3, bulk_reg, 4);\n\t\tdev_warn(charger->dev,\n\t\t\t \"Battery voltage %d below minimum voltage %d\\n\",\n\t\t\t volt_avg, charger->bat_voltage_min_design_uv);\n\t\t}\n\n\trk817_record_battery_nvram_values(charger);\n\n\treturn 0;\n}\n\nstatic void rk817_read_props(struct rk817_charger *charger)\n{\n\tint tmp, reg;\n\tu8 bulk_reg[4];\n\n\t \n\tregmap_read(charger->rk808->regmap, RK817_GAS_GAUGE_ADC_CONFIG1, &reg);\n\tif (reg & RK817_VOL_CUR_CALIB_UPD) {\n\t\trk817_bat_calib_cur(charger);\n\t\trk817_bat_calib_vol(charger);\n\t\tregmap_write_bits(charger->rk808->regmap,\n\t\t\t\t  RK817_GAS_GAUGE_ADC_CONFIG1,\n\t\t\t\t  RK817_VOL_CUR_CALIB_UPD,\n\t\t\t\t  RK817_VOL_CUR_CALIB_UPD);\n\t}\n\n\t \n\tregmap_bulk_read(charger->rk808->regmap, RK817_GAS_GAUGE_Q_PRES_H3,\n\t\t\t bulk_reg, 4);\n\ttmp = get_unaligned_be32(bulk_reg);\n\tcharger->charge_now_uah = ADC_TO_CHARGE_UAH(tmp, charger->res_div);\n\tif (charger->charge_now_uah < 0)\n\t\tcharger->charge_now_uah = 0;\n\tif (charger->charge_now_uah > charger->fcc_mah * 1000)\n\t\tcharger->charge_now_uah = charger->fcc_mah * 1000;\n\n\t \n\tcharger->soc = charger->charge_now_uah * 100 / charger->fcc_mah;\n\n\t \n\tregmap_bulk_read(charger->rk808->regmap, RK817_GAS_GAUGE_BAT_VOL_H,\n\t\t\t bulk_reg, 2);\n\ttmp = get_unaligned_be16(bulk_reg);\n\tcharger->volt_avg_uv = (charger->voltage_k * tmp) + 1000 *\n\t\t\t\tcharger->voltage_b;\n\n\t \n\tregmap_bulk_read(charger->rk808->regmap, RK817_GAS_GAUGE_BAT_CUR_H,\n\t\t\t bulk_reg, 2);\n\ttmp = (short int)get_unaligned_be16(bulk_reg);\n\tcharger->cur_avg_ua = ADC_TO_CURRENT(tmp, charger->res_div);\n\n\t \n\tregmap_read(charger->rk808->regmap, RK817_PMIC_CHRG_OUT, &reg);\n\tcharger->max_chg_cur_ua =\n\t\trk817_chg_cur_from_reg(reg & RK817_CHRG_CUR_SEL);\n\n\t \n\tregmap_read(charger->rk808->regmap, RK817_PMIC_CHRG_OUT, &reg);\n\tcharger->max_chg_volt_uv = ((((reg & RK817_CHRG_VOL_SEL) >> 4) *\n\t\t\t\t    50000) + 4100000);\n\n\t \n\tregmap_read(charger->rk808->regmap, RK817_PMIC_CHRG_STS, &reg);\n\tcharger->battery_present = (reg & RK817_BAT_EXS);\n\n\t \n\tregmap_read(charger->rk808->regmap, RK817_PMIC_CHRG_STS, &reg);\n\tcharger->charge_status = (reg >> 4) & 0x07;\n\n\t \n\tregmap_bulk_read(charger->rk808->regmap, RK817_GAS_GAUGE_USB_VOL_H,\n\t\t\t bulk_reg, 2);\n\treg = get_unaligned_be16(bulk_reg);\n\tif (reg > 1) {\n\t\ttmp = ((charger->voltage_k * reg / 1000 + charger->voltage_b) *\n\t\t       60 / 46);\n\t\tcharger->charger_input_volt_avg_uv = tmp * 1000;\n\t} else {\n\t\tcharger->charger_input_volt_avg_uv = 0;\n\t}\n\n\t \n\trk817_bat_calib_cap(charger);\n}\n\nstatic int rk817_bat_get_prop(struct power_supply *ps,\n\t\tenum power_supply_property prop,\n\t\tunion power_supply_propval *val)\n{\n\tstruct rk817_charger *charger = power_supply_get_drvdata(ps);\n\n\tswitch (prop) {\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tval->intval = charger->battery_present;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tif (charger->cur_avg_ua < 0) {\n\t\t\tval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\n\t\t\tbreak;\n\t\t}\n\t\tswitch (charger->charge_status) {\n\t\tcase CHRG_OFF:\n\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\t\tbreak;\n\t\t \n\t\tcase DEAD_CHRG:\n\t\tcase TRICKLE_CHRG:\n\t\tcase CC_OR_CV_CHRG:\n\t\t\tval->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\t\tbreak;\n\t\tcase CHARGE_FINISH:\n\t\t\tval->intval = POWER_SUPPLY_STATUS_FULL;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tval->intval = POWER_SUPPLY_STATUS_UNKNOWN;\n\t\t\treturn -EINVAL;\n\n\t\t}\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tswitch (charger->charge_status) {\n\t\tcase CHRG_OFF:\n\t\tcase CHARGE_FINISH:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_NONE;\n\t\t\tbreak;\n\t\tcase TRICKLE_CHRG:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\n\t\t\tbreak;\n\t\tcase DEAD_CHRG:\n\t\tcase CC_OR_CV_CHRG:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_STANDARD;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_UNKNOWN;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_FULL:\n\t\tval->intval = charger->fcc_mah * 1000;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN:\n\t\tval->intval = charger->bat_charge_full_design_uah;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_EMPTY_DESIGN:\n\t\tval->intval = 0;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_NOW:\n\t\tval->intval = charger->charge_now_uah;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\n\t\tval->intval = charger->bat_voltage_min_design_uv;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CAPACITY:\n\t\t \n\t\tval->intval = (charger->soc + 500) / 1000;\n\t\tif (val->intval > 100)\n\t\t\tval->intval = 100;\n\t\tif (val->intval < 0)\n\t\t\tval->intval = 0;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_AVG:\n\t\tval->intval = charger->volt_avg_uv;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_AVG:\n\t\tval->intval = charger->cur_avg_ua;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:\n\t\tval->intval = charger->max_chg_cur_ua;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX:\n\t\tval->intval = charger->max_chg_volt_uv;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\n\t\tval->intval = charger->bat_voltage_max_design_uv;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic int rk817_chg_get_prop(struct power_supply *ps,\n\t\t\t      enum power_supply_property prop,\n\t\t\t      union power_supply_propval *val)\n{\n\tstruct rk817_charger *charger = power_supply_get_drvdata(ps);\n\n\tswitch (prop) {\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = charger->plugged_in;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\n\t\t \n\t\tval->intval = 5500000;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\n\t\t \n\t\tval->intval = 3800000;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_AVG:\n\t\tval->intval = charger->charger_input_volt_avg_uv;\n\t\tbreak;\n\t \n\tcase POWER_SUPPLY_PROP_USB_TYPE:\n\t\tval->intval = POWER_SUPPLY_USB_TYPE_DCP;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n\n}\n\nstatic irqreturn_t rk817_plug_in_isr(int irq, void *cg)\n{\n\tstruct rk817_charger *charger;\n\n\tcharger = (struct rk817_charger *)cg;\n\tcharger->plugged_in = 1;\n\tpower_supply_changed(charger->chg_ps);\n\tpower_supply_changed(charger->bat_ps);\n\t \n\tcharger->soc_cal = 0;\n\n\trk817_read_props(charger);\n\n\tdev_dbg(charger->dev, \"Power Cord Inserted\\n\");\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t rk817_plug_out_isr(int irq, void *cg)\n{\n\tstruct rk817_charger *charger;\n\tstruct rk808 *rk808;\n\n\tcharger = (struct rk817_charger *)cg;\n\trk808 = charger->rk808;\n\tcharger->plugged_in = 0;\n\tpower_supply_changed(charger->bat_ps);\n\tpower_supply_changed(charger->chg_ps);\n\n\t \n\tregmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_IN,\n\t\t\t  RK817_USB_VLIM_SEL, (0x05 << 4));\n\tregmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_IN, RK817_USB_VLIM_EN,\n\t\t\t  (0x01 << 7));\n\n\t \n\tregmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_IN,\n\t\t\t  RK817_USB_ILIM_SEL, 0x03);\n\tregmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_IN, RK817_USB_ILIM_EN,\n\t\t\t  (0x01 << 3));\n\n\trk817_read_props(charger);\n\n\tdev_dbg(charger->dev, \"Power Cord Removed\\n\");\n\n\treturn IRQ_HANDLED;\n}\n\nstatic enum power_supply_property rk817_bat_props[] = {\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_CHARGE_TYPE,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CHARGE_EMPTY_DESIGN,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX,\n\tPOWER_SUPPLY_PROP_VOLTAGE_AVG,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX,\n\tPOWER_SUPPLY_PROP_CURRENT_AVG,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN,\n};\n\nstatic enum power_supply_property rk817_chg_props[] = {\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_USB_TYPE,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN,\n\tPOWER_SUPPLY_PROP_VOLTAGE_AVG,\n};\n\nstatic enum power_supply_usb_type rk817_usb_type[] = {\n\tPOWER_SUPPLY_USB_TYPE_DCP,\n\tPOWER_SUPPLY_USB_TYPE_UNKNOWN,\n};\n\nstatic const struct power_supply_desc rk817_bat_desc = {\n\t.name = \"rk817-battery\",\n\t.type = POWER_SUPPLY_TYPE_BATTERY,\n\t.properties = rk817_bat_props,\n\t.num_properties = ARRAY_SIZE(rk817_bat_props),\n\t.get_property = rk817_bat_get_prop,\n};\n\nstatic const struct power_supply_desc rk817_chg_desc = {\n\t.name = \"rk817-charger\",\n\t.type = POWER_SUPPLY_TYPE_USB,\n\t.usb_types = rk817_usb_type,\n\t.num_usb_types = ARRAY_SIZE(rk817_usb_type),\n\t.properties = rk817_chg_props,\n\t.num_properties = ARRAY_SIZE(rk817_chg_props),\n\t.get_property = rk817_chg_get_prop,\n};\n\nstatic int rk817_read_battery_nvram_values(struct rk817_charger *charger)\n{\n\tu8 bulk_reg[3];\n\tint ret;\n\n\t \n\tret = regmap_bulk_read(charger->rk808->regmap,\n\t\t\t       RK817_GAS_GAUGE_DATA3, bulk_reg, 3);\n\tif (ret < 0)\n\t\treturn ret;\n\tcharger->fcc_mah = get_unaligned_le24(bulk_reg);\n\n\t \n\tif ((charger->fcc_mah < 500) ||\n\t   ((charger->fcc_mah * 1000) > charger->bat_charge_full_design_uah)) {\n\t\tdev_info(charger->dev,\n\t\t\t \"Invalid NVRAM max charge, setting to %u uAH\\n\",\n\t\t\t charger->bat_charge_full_design_uah);\n\t\tcharger->fcc_mah = charger->bat_charge_full_design_uah / 1000;\n\t}\n\n\t \n\tret = regmap_bulk_read(charger->rk808->regmap,\n\t\t\t       RK817_GAS_GAUGE_BAT_R1, bulk_reg, 3);\n\tif (ret < 0)\n\t\treturn ret;\n\tcharger->soc = get_unaligned_le24(bulk_reg);\n\tif (charger->soc > 10000)\n\t\tcharger->soc = 10000;\n\tif (charger->soc < 0)\n\t\tcharger->soc = 0;\n\n\treturn 0;\n}\n\nstatic int\nrk817_read_or_set_full_charge_on_boot(struct rk817_charger *charger,\n\t\t\t\tstruct power_supply_battery_info *bat_info)\n{\n\tstruct rk808 *rk808 = charger->rk808;\n\tu8 bulk_reg[4];\n\tu32 boot_voltage, boot_charge_mah;\n\tint ret, reg, off_time, tmp;\n\tbool first_boot;\n\n\t \n\tret = regmap_read(rk808->regmap, RK817_GAS_GAUGE_GG_STS, &reg);\n\tif (ret < 0)\n\t\treturn ret;\n\tfirst_boot = reg & RK817_BAT_CON;\n\t \n\tif (first_boot) {\n\t\tregmap_bulk_read(rk808->regmap, RK817_GAS_GAUGE_PWRON_VOL_H,\n\t\t\t\t bulk_reg, 2);\n\t\ttmp = get_unaligned_be16(bulk_reg);\n\t\tboot_voltage = (charger->voltage_k * tmp) +\n\t\t\t\t1000 * charger->voltage_b;\n\t\t \n\t\tcharger->soc = power_supply_batinfo_ocv2cap(bat_info,\n\t\t\t\t\t\t\t    boot_voltage,\n\t\t\t\t\t\t\t    20) * 1000;\n\t\tif (charger->soc < 0)\n\t\t\tcharger->soc = 0;\n\n\t\t \n\t\tcharger->fcc_mah = charger->bat_charge_full_design_uah / 1000;\n\t\t \n\t\tregmap_write_bits(rk808->regmap, RK817_GAS_GAUGE_GG_STS,\n\t\t\t\t  RK817_BAT_CON, 0);\n\t\t \n\t\tret = rk817_record_battery_nvram_values(charger);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t} else {\n\t\tret = rk817_read_battery_nvram_values(charger);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tregmap_bulk_read(rk808->regmap, RK817_GAS_GAUGE_Q_PRES_H3,\n\t\t\t\t bulk_reg, 4);\n\t\ttmp = get_unaligned_be32(bulk_reg);\n\t\tif (tmp < 0)\n\t\t\ttmp = 0;\n\t\tboot_charge_mah = ADC_TO_CHARGE_UAH(tmp,\n\t\t\t\t\t\t    charger->res_div) / 1000;\n\t\t \n\t\tregmap_read(rk808->regmap, RK817_GAS_GAUGE_OFF_CNT, &off_time);\n\t\tif (off_time >= 3) {\n\t\t\tregmap_bulk_read(rk808->regmap,\n\t\t\t\t\t RK817_GAS_GAUGE_PWRON_VOL_H,\n\t\t\t\t\t bulk_reg, 2);\n\t\t\ttmp = get_unaligned_be16(bulk_reg);\n\t\t\tboot_voltage = (charger->voltage_k * tmp) +\n\t\t\t\t\t1000 * charger->voltage_b;\n\t\t\tcharger->soc =\n\t\t\t\tpower_supply_batinfo_ocv2cap(bat_info,\n\t\t\t\t\t\t\t     boot_voltage,\n\t\t\t\t\t\t\t     20) * 1000;\n\t\t} else {\n\t\t\tcharger->soc = (boot_charge_mah * 1000 * 100 /\n\t\t\t\t\tcharger->fcc_mah);\n\t\t}\n\t}\n\n\t \n\tboot_charge_mah = charger->soc * charger->fcc_mah / 100 / 1000;\n\tif (boot_charge_mah > charger->fcc_mah)\n\t\tboot_charge_mah = charger->fcc_mah;\n\ttmp = CHARGE_TO_ADC(boot_charge_mah, charger->res_div);\n\tput_unaligned_be32(tmp, bulk_reg);\n\tret = regmap_bulk_write(rk808->regmap, RK817_GAS_GAUGE_Q_INIT_H3,\n\t\t\t  bulk_reg, 4);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\ttmp = CHARGE_TO_ADC((charger->bat_charge_full_design_uah / 1000),\n\t\t\t    charger->res_div);\n\tput_unaligned_be32(tmp, bulk_reg);\n\tret = regmap_bulk_write(rk808->regmap, RK817_GAS_GAUGE_Q_MAX_H3,\n\t\t\t\tbulk_reg, 4);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int rk817_battery_init(struct rk817_charger *charger,\n\t\t\t      struct power_supply_battery_info *bat_info)\n{\n\tstruct rk808 *rk808 = charger->rk808;\n\tu32 tmp, max_chg_vol_mv, max_chg_cur_ma;\n\tu8 max_chg_vol_reg, chg_term_i_reg;\n\tint ret, chg_term_ma, max_chg_cur_reg;\n\tu8 bulk_reg[2];\n\n\t \n\tregmap_read(rk808->regmap, RK817_SYS_STS, &tmp);\n\tcharger->plugged_in = (tmp & RK817_PLUG_IN_STS);\n\n\t \n\tregmap_write(rk808->regmap, RK817_GAS_GAUGE_ADC_CONFIG0, 0xfc);\n\n\t \n\tregmap_write(rk808->regmap, RK817_GAS_GAUGE_GG_CON, 0x04);\n\n\t \n\trk817_bat_calib_vol(charger);\n\n\t \n\ttmp = CURRENT_TO_ADC(charger->sleep_enter_current_ua,\n\t\t\t     charger->res_div);\n\tput_unaligned_be16(tmp, bulk_reg);\n\tregmap_bulk_write(rk808->regmap, RK817_GAS_GAUGE_RELAX_THRE_H,\n\t\t\t  bulk_reg, 2);\n\n\t \n\ttmp = CURRENT_TO_ADC(charger->sleep_filter_current_ua,\n\t\t\t     charger->res_div);\n\tput_unaligned_be16(tmp, bulk_reg);\n\tregmap_bulk_write(rk808->regmap, RK817_GAS_GAUGE_SLEEP_CON_SAMP_CUR_H,\n\t\t\t  bulk_reg, 2);\n\n\t \n\tregmap_write_bits(rk808->regmap, RK817_GAS_GAUGE_GG_STS,\n\t\t\t  RK817_RELAX_VOL_UPD, (0x0 << 2));\n\n\t \n\tregmap_write(rk808->regmap, RK817_GAS_GAUGE_OCV_THRE_VOL, 0xff);\n\n\t \n\tmax_chg_vol_mv = bat_info->constant_charge_voltage_max_uv / 1000;\n\tmax_chg_cur_ma = bat_info->constant_charge_current_max_ua / 1000;\n\n\tif (max_chg_vol_mv < 4100) {\n\t\treturn dev_err_probe(charger->dev, -EINVAL,\n\t\t       \"invalid max charger voltage, value %u unsupported\\n\",\n\t\t\tmax_chg_vol_mv * 1000);\n\t}\n\tif (max_chg_vol_mv > 4450) {\n\t\tdev_info(charger->dev,\n\t\t\t \"Setting max charge voltage to 4450000uv\\n\");\n\t\tmax_chg_vol_mv = 4450;\n\t}\n\n\tif (max_chg_cur_ma < 500) {\n\t\treturn dev_err_probe(charger->dev, -EINVAL,\n\t\t       \"invalid max charger current, value %u unsupported\\n\",\n\t\t       max_chg_cur_ma * 1000);\n\t}\n\tif (max_chg_cur_ma > 3500)\n\t\tdev_info(charger->dev,\n\t\t\t \"Setting max charge current to 3500000ua\\n\");\n\n\t \n\tmax_chg_vol_reg = (max_chg_vol_mv - 4100) / 50;\n\n\tmax_chg_cur_reg = rk817_chg_cur_to_reg(max_chg_cur_ma);\n\n\tif (max_chg_vol_reg < 0 || max_chg_vol_reg > 7) {\n\t\treturn dev_err_probe(charger->dev, -EINVAL,\n\t\t       \"invalid max charger voltage, value %u unsupported\\n\",\n\t\t       max_chg_vol_mv * 1000);\n\t}\n\tif (max_chg_cur_reg < 0 || max_chg_cur_reg > 7) {\n\t\treturn dev_err_probe(charger->dev, -EINVAL,\n\t\t       \"invalid max charger current, value %u unsupported\\n\",\n\t\t       max_chg_cur_ma * 1000);\n\t}\n\n\t \n\tret = regmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_OUT,\n\t\t\t\tRK817_CHRG_VOL_SEL, (max_chg_vol_reg << 4));\n\tif (ret) {\n\t\tdev_emerg(charger->dev,\n\t\t\t  \"Danger, unable to set max charger voltage: %u\\n\",\n\t\t\t  ret);\n\t}\n\n\tret = regmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_OUT,\n\t\t\t\tRK817_CHRG_CUR_SEL, max_chg_cur_reg);\n\tif (ret) {\n\t\tdev_emerg(charger->dev,\n\t\t\t  \"Danger, unable to set max charger current: %u\\n\",\n\t\t\t  ret);\n\t}\n\n\t \n\tregmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_TERM,\n\t\t\t  RK817_CHRG_TERM_ANA_DIG, (0x0 << 2));\n\n\t \n\tchg_term_ma = bat_info->charge_term_current_ua / 1000;\n\tif (chg_term_ma < 150 || chg_term_ma > 400) {\n\t\tdev_warn(charger->dev,\n\t\t\t \"Invalid charge termination %u, keeping default\\n\",\n\t\t\t chg_term_ma * 1000);\n\t\tchg_term_ma = 200;\n\t}\n\n\t \n\tchg_term_i_reg = (chg_term_ma - 100) / 100;\n\tregmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_TERM,\n\t\t\t  RK817_CHRG_TERM_ANA_SEL, chg_term_i_reg);\n\n\tret = rk817_read_or_set_full_charge_on_boot(charger, bat_info);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tregmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_IN,\n\t\t\t  RK817_USB_VLIM_SEL, (0x05 << 4));\n\tregmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_IN, RK817_USB_VLIM_EN,\n\t\t\t  (0x01 << 7));\n\n\t \n\tregmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_IN,\n\t\t\t  RK817_USB_ILIM_SEL, 0x03);\n\tregmap_write_bits(rk808->regmap, RK817_PMIC_CHRG_IN, RK817_USB_ILIM_EN,\n\t\t\t  (0x01 << 3));\n\n\treturn 0;\n}\n\nstatic void rk817_charging_monitor(struct work_struct *work)\n{\n\tstruct rk817_charger *charger;\n\n\tcharger = container_of(work, struct rk817_charger, work.work);\n\n\trk817_read_props(charger);\n\n\t \n\tqueue_delayed_work(system_wq, &charger->work, msecs_to_jiffies(8000));\n}\n\nstatic void rk817_cleanup_node(void *data)\n{\n\tstruct device_node *node = data;\n\n\tof_node_put(node);\n}\n\nstatic int rk817_charger_probe(struct platform_device *pdev)\n{\n\tstruct rk808 *rk808 = dev_get_drvdata(pdev->dev.parent);\n\tstruct rk817_charger *charger;\n\tstruct device_node *node;\n\tstruct power_supply_battery_info *bat_info;\n\tstruct device *dev = &pdev->dev;\n\tstruct power_supply_config pscfg = {};\n\tint plugin_irq, plugout_irq;\n\tint of_value;\n\tint ret;\n\n\tnode = of_get_child_by_name(dev->parent->of_node, \"charger\");\n\tif (!node)\n\t\treturn -ENODEV;\n\n\tret = devm_add_action_or_reset(&pdev->dev, rk817_cleanup_node, node);\n\tif (ret)\n\t\treturn ret;\n\n\tcharger = devm_kzalloc(&pdev->dev, sizeof(*charger), GFP_KERNEL);\n\tif (!charger)\n\t\treturn -ENOMEM;\n\n\tcharger->rk808 = rk808;\n\n\tcharger->dev = &pdev->dev;\n\tplatform_set_drvdata(pdev, charger);\n\n\trk817_bat_calib_vol(charger);\n\n\tpscfg.drv_data = charger;\n\tpscfg.of_node = node;\n\n\t \n\tret = of_property_read_u32(node, \"rockchip,resistor-sense-micro-ohms\",\n\t\t\t\t   &of_value);\n\tif (ret < 0) {\n\t\treturn dev_err_probe(dev, ret,\n\t\t\t\t     \"Error reading sample resistor value\\n\");\n\t}\n\t \n\tcharger->res_div = (of_value == 20000) ? 2 : 1;\n\n\t \n\tret = of_property_read_u32(node,\n\t\t\t\t   \"rockchip,sleep-enter-current-microamp\",\n\t\t\t\t   &of_value);\n\tif (ret < 0) {\n\t\treturn dev_err_probe(dev, ret,\n\t\t\t\t     \"Error reading sleep enter cur value\\n\");\n\t}\n\tcharger->sleep_enter_current_ua = of_value;\n\n\t \n\tret = of_property_read_u32(node,\n\t\t\t\t   \"rockchip,sleep-filter-current-microamp\",\n\t\t\t\t   &of_value);\n\tif (ret < 0) {\n\t\treturn dev_err_probe(dev, ret,\n\t\t\t\t     \"Error reading sleep filter cur value\\n\");\n\t}\n\n\tcharger->sleep_filter_current_ua = of_value;\n\n\tcharger->bat_ps = devm_power_supply_register(&pdev->dev,\n\t\t\t\t\t\t     &rk817_bat_desc, &pscfg);\n\tif (IS_ERR(charger->bat_ps))\n\t\treturn dev_err_probe(dev, -EINVAL,\n\t\t\t\t     \"Battery failed to probe\\n\");\n\n\tcharger->chg_ps = devm_power_supply_register(&pdev->dev,\n\t\t\t\t\t\t     &rk817_chg_desc, &pscfg);\n\tif (IS_ERR(charger->chg_ps))\n\t\treturn dev_err_probe(dev, -EINVAL,\n\t\t\t\t     \"Charger failed to probe\\n\");\n\n\tret = power_supply_get_battery_info(charger->bat_ps,\n\t\t\t\t\t    &bat_info);\n\tif (ret) {\n\t\treturn dev_err_probe(dev, ret,\n\t\t\t\t     \"Unable to get battery info\\n\");\n\t}\n\n\tif ((bat_info->charge_full_design_uah <= 0) ||\n\t    (bat_info->voltage_min_design_uv <= 0) ||\n\t    (bat_info->voltage_max_design_uv <= 0) ||\n\t    (bat_info->constant_charge_voltage_max_uv <= 0) ||\n\t    (bat_info->constant_charge_current_max_ua <= 0) ||\n\t    (bat_info->charge_term_current_ua <= 0)) {\n\t\treturn dev_err_probe(dev, -EINVAL,\n\t\t\t\t     \"Required bat info missing or invalid\\n\");\n\t}\n\n\tcharger->bat_charge_full_design_uah = bat_info->charge_full_design_uah;\n\tcharger->bat_voltage_min_design_uv = bat_info->voltage_min_design_uv;\n\tcharger->bat_voltage_max_design_uv = bat_info->voltage_max_design_uv;\n\n\t \n\tret = rk817_battery_init(charger, bat_info);\n\tif (ret)\n\t\treturn ret;\n\n\tpower_supply_put_battery_info(charger->bat_ps, bat_info);\n\n\tplugin_irq = platform_get_irq(pdev, 0);\n\tif (plugin_irq < 0)\n\t\treturn plugin_irq;\n\n\tplugout_irq = platform_get_irq(pdev, 1);\n\tif (plugout_irq < 0)\n\t\treturn plugout_irq;\n\n\tret = devm_request_threaded_irq(charger->dev, plugin_irq, NULL,\n\t\t\t\t\trk817_plug_in_isr,\n\t\t\t\t\tIRQF_TRIGGER_RISING | IRQF_ONESHOT,\n\t\t\t\t\t\"rk817_plug_in\", charger);\n\tif (ret) {\n\t\treturn dev_err_probe(&pdev->dev, ret,\n\t\t\t\t      \"plug_in_irq request failed!\\n\");\n\t}\n\n\tret = devm_request_threaded_irq(charger->dev, plugout_irq, NULL,\n\t\t\t\t\trk817_plug_out_isr,\n\t\t\t\t\tIRQF_TRIGGER_RISING | IRQF_ONESHOT,\n\t\t\t\t\t\"rk817_plug_out\", charger);\n\tif (ret) {\n\t\treturn dev_err_probe(&pdev->dev, ret,\n\t\t\t\t     \"plug_out_irq request failed!\\n\");\n\t}\n\n\tret = devm_delayed_work_autocancel(&pdev->dev, &charger->work,\n\t\t\t\t\t   rk817_charging_monitor);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tmod_delayed_work(system_wq, &charger->work, 0);\n\n\treturn 0;\n}\n\n\nstatic struct platform_driver rk817_charger_driver = {\n\t.probe    = rk817_charger_probe,\n\t.driver   = {\n\t\t.name  = \"rk817-charger\",\n\t},\n};\nmodule_platform_driver(rk817_charger_driver);\n\nMODULE_DESCRIPTION(\"Battery power supply driver for RK817 PMIC\");\nMODULE_AUTHOR(\"Maya Matuszczyk <maccraft123mc@gmail.com>\");\nMODULE_AUTHOR(\"Chris Morgan <macromorgan@hotmail.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:rk817-charger\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}