{
  "module_name": "act8945a_charger.c",
  "hash_id": "6ad54d85fd560d738f7a4f56a2870eb8ad6995a4b0a546d42c00f5f7911bdfc2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/act8945a_charger.c",
  "human_readable_source": "\n \n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_irq.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/regmap.h>\n#include <linux/gpio/consumer.h>\n\nstatic const char *act8945a_charger_model = \"ACT8945A\";\nstatic const char *act8945a_charger_manufacturer = \"Active-semi\";\n\n \n\n \n#define ACT8945A_APCH_CFG\t\t0x71\n#define ACT8945A_APCH_STATUS\t\t0x78\n#define ACT8945A_APCH_CTRL\t\t0x79\n#define ACT8945A_APCH_STATE\t\t0x7A\n\n \n#define APCH_CFG_OVPSET\t\t\t(0x3 << 0)\n#define APCH_CFG_OVPSET_6V6\t\t(0x0 << 0)\n#define APCH_CFG_OVPSET_7V\t\t(0x1 << 0)\n#define APCH_CFG_OVPSET_7V5\t\t(0x2 << 0)\n#define APCH_CFG_OVPSET_8V\t\t(0x3 << 0)\n#define APCH_CFG_PRETIMO\t\t(0x3 << 2)\n#define APCH_CFG_PRETIMO_40_MIN\t\t(0x0 << 2)\n#define APCH_CFG_PRETIMO_60_MIN\t\t(0x1 << 2)\n#define APCH_CFG_PRETIMO_80_MIN\t\t(0x2 << 2)\n#define APCH_CFG_PRETIMO_DISABLED\t(0x3 << 2)\n#define APCH_CFG_TOTTIMO\t\t(0x3 << 4)\n#define APCH_CFG_TOTTIMO_3_HOUR\t\t(0x0 << 4)\n#define APCH_CFG_TOTTIMO_4_HOUR\t\t(0x1 << 4)\n#define APCH_CFG_TOTTIMO_5_HOUR\t\t(0x2 << 4)\n#define APCH_CFG_TOTTIMO_DISABLED\t(0x3 << 4)\n#define APCH_CFG_SUSCHG\t\t\t(0x1 << 7)\n\n#define APCH_STATUS_CHGDAT\t\tBIT(0)\n#define APCH_STATUS_INDAT\t\tBIT(1)\n#define APCH_STATUS_TEMPDAT\t\tBIT(2)\n#define APCH_STATUS_TIMRDAT\t\tBIT(3)\n#define APCH_STATUS_CHGSTAT\t\tBIT(4)\n#define APCH_STATUS_INSTAT\t\tBIT(5)\n#define APCH_STATUS_TEMPSTAT\t\tBIT(6)\n#define APCH_STATUS_TIMRSTAT\t\tBIT(7)\n\n#define APCH_CTRL_CHGEOCOUT\t\tBIT(0)\n#define APCH_CTRL_INDIS\t\t\tBIT(1)\n#define APCH_CTRL_TEMPOUT\t\tBIT(2)\n#define APCH_CTRL_TIMRPRE\t\tBIT(3)\n#define APCH_CTRL_CHGEOCIN\t\tBIT(4)\n#define APCH_CTRL_INCON\t\t\tBIT(5)\n#define APCH_CTRL_TEMPIN\t\tBIT(6)\n#define APCH_CTRL_TIMRTOT\t\tBIT(7)\n\n#define APCH_STATE_ACINSTAT\t\t(0x1 << 1)\n#define APCH_STATE_CSTATE\t\t(0x3 << 4)\n#define APCH_STATE_CSTATE_SHIFT\t\t4\n#define APCH_STATE_CSTATE_DISABLED\t0x00\n#define APCH_STATE_CSTATE_EOC\t\t0x01\n#define APCH_STATE_CSTATE_FAST\t\t0x02\n#define APCH_STATE_CSTATE_PRE\t\t0x03\n\nstruct act8945a_charger {\n\tstruct power_supply *psy;\n\tstruct power_supply_desc desc;\n\tstruct regmap *regmap;\n\tstruct work_struct work;\n\n\tbool init_done;\n\tstruct gpio_desc *lbo_gpio;\n\tstruct gpio_desc *chglev_gpio;\n};\n\nstatic int act8945a_get_charger_state(struct regmap *regmap, int *val)\n{\n\tint ret;\n\tunsigned int status, state;\n\n\tret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tstate &= APCH_STATE_CSTATE;\n\tstate >>= APCH_STATE_CSTATE_SHIFT;\n\n\tswitch (state) {\n\tcase APCH_STATE_CSTATE_PRE:\n\tcase APCH_STATE_CSTATE_FAST:\n\t\t*val = POWER_SUPPLY_STATUS_CHARGING;\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_EOC:\n\t\tif (status & APCH_STATUS_CHGDAT)\n\t\t\t*val = POWER_SUPPLY_STATUS_FULL;\n\t\telse\n\t\t\t*val = POWER_SUPPLY_STATUS_CHARGING;\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_DISABLED:\n\tdefault:\n\t\tif (!(status & APCH_STATUS_INDAT))\n\t\t\t*val = POWER_SUPPLY_STATUS_DISCHARGING;\n\t\telse\n\t\t\t*val = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int act8945a_get_charge_type(struct regmap *regmap, int *val)\n{\n\tint ret;\n\tunsigned int status, state;\n\n\tret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tstate &= APCH_STATE_CSTATE;\n\tstate >>= APCH_STATE_CSTATE_SHIFT;\n\n\tswitch (state) {\n\tcase APCH_STATE_CSTATE_PRE:\n\t\t*val = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_FAST:\n\t\t*val = POWER_SUPPLY_CHARGE_TYPE_FAST;\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_EOC:\n\t\t*val = POWER_SUPPLY_CHARGE_TYPE_NONE;\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_DISABLED:\n\tdefault:\n\t\tif (!(status & APCH_STATUS_INDAT))\n\t\t\t*val = POWER_SUPPLY_CHARGE_TYPE_NONE;\n\t\telse\n\t\t\t*val = POWER_SUPPLY_CHARGE_TYPE_UNKNOWN;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int act8945a_get_battery_health(struct regmap *regmap, int *val)\n{\n\tint ret;\n\tunsigned int status, state, config;\n\n\tret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_read(regmap, ACT8945A_APCH_CFG, &config);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tstate &= APCH_STATE_CSTATE;\n\tstate >>= APCH_STATE_CSTATE_SHIFT;\n\n\tswitch (state) {\n\tcase APCH_STATE_CSTATE_DISABLED:\n\t\tif (config & APCH_CFG_SUSCHG) {\n\t\t\t*val = POWER_SUPPLY_HEALTH_UNKNOWN;\n\t\t} else if (status & APCH_STATUS_INDAT) {\n\t\t\tif (!(status & APCH_STATUS_TEMPDAT))\n\t\t\t\t*val = POWER_SUPPLY_HEALTH_OVERHEAT;\n\t\t\telse if (status & APCH_STATUS_TIMRDAT)\n\t\t\t\t*val = POWER_SUPPLY_HEALTH_SAFETY_TIMER_EXPIRE;\n\t\t\telse\n\t\t\t\t*val = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\n\t\t} else {\n\t\t\t*val = POWER_SUPPLY_HEALTH_GOOD;\n\t\t}\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_PRE:\n\tcase APCH_STATE_CSTATE_FAST:\n\tcase APCH_STATE_CSTATE_EOC:\n\tdefault:\n\t\t*val = POWER_SUPPLY_HEALTH_GOOD;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic int act8945a_get_capacity_level(struct act8945a_charger *charger,\n\t\t\t\t       struct regmap *regmap, int *val)\n{\n\tint ret;\n\tunsigned int status, state, config;\n\tint lbo_level = gpiod_get_value(charger->lbo_gpio);\n\n\tret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_read(regmap, ACT8945A_APCH_CFG, &config);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tstate &= APCH_STATE_CSTATE;\n\tstate >>= APCH_STATE_CSTATE_SHIFT;\n\n\tswitch (state) {\n\tcase APCH_STATE_CSTATE_PRE:\n\t\t*val = POWER_SUPPLY_CAPACITY_LEVEL_LOW;\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_FAST:\n\t\tif (lbo_level)\n\t\t\t*val = POWER_SUPPLY_CAPACITY_LEVEL_HIGH;\n\t\telse\n\t\t\t*val = POWER_SUPPLY_CAPACITY_LEVEL_LOW;\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_EOC:\n\t\tif (status & APCH_STATUS_CHGDAT)\n\t\t\t*val = POWER_SUPPLY_CAPACITY_LEVEL_FULL;\n\t\telse\n\t\t\t*val = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_DISABLED:\n\tdefault:\n\t\tif (config & APCH_CFG_SUSCHG) {\n\t\t\t*val = POWER_SUPPLY_CAPACITY_LEVEL_UNKNOWN;\n\t\t} else {\n\t\t\t*val = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\n\t\t\tif (!(status & APCH_STATUS_INDAT)) {\n\t\t\t\tif (!lbo_level)\n\t\t\t\t\t*val = POWER_SUPPLY_CAPACITY_LEVEL_CRITICAL;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\n#define MAX_CURRENT_USB_HIGH\t450000\n#define MAX_CURRENT_USB_LOW\t90000\n#define MAX_CURRENT_USB_PRE\t45000\n \n#define MAX_CURRENT_AC_HIGH\t\t886527\n#define MAX_CURRENT_AC_LOW\t\t117305\n#define MAX_CURRENT_AC_HIGH_PRE\t\t88653\n#define MAX_CURRENT_AC_LOW_PRE\t\t11731\n\nstatic int act8945a_get_current_max(struct act8945a_charger *charger,\n\t\t\t\t    struct regmap *regmap, int *val)\n{\n\tint ret;\n\tunsigned int status, state;\n\tunsigned int acin_state;\n\tint chgin_level = gpiod_get_value(charger->chglev_gpio);\n\n\tret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tacin_state = (state & APCH_STATE_ACINSTAT) >> 1;\n\n\tstate &= APCH_STATE_CSTATE;\n\tstate >>= APCH_STATE_CSTATE_SHIFT;\n\n\tswitch (state) {\n\tcase APCH_STATE_CSTATE_PRE:\n\t\tif (acin_state) {\n\t\t\tif (chgin_level)\n\t\t\t\t*val = MAX_CURRENT_AC_HIGH_PRE;\n\t\t\telse\n\t\t\t\t*val = MAX_CURRENT_AC_LOW_PRE;\n\t\t} else {\n\t\t\t*val = MAX_CURRENT_USB_PRE;\n\t\t}\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_FAST:\n\t\tif (acin_state) {\n\t\t\tif (chgin_level)\n\t\t\t\t*val = MAX_CURRENT_AC_HIGH;\n\t\t\telse\n\t\t\t\t*val = MAX_CURRENT_AC_LOW;\n\t\t} else {\n\t\t\tif (chgin_level)\n\t\t\t\t*val = MAX_CURRENT_USB_HIGH;\n\t\t\telse\n\t\t\t\t*val = MAX_CURRENT_USB_LOW;\n\t\t}\n\t\tbreak;\n\tcase APCH_STATE_CSTATE_EOC:\n\tcase APCH_STATE_CSTATE_DISABLED:\n\tdefault:\n\t\t*val = 0;\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic enum power_supply_property act8945a_charger_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_CHARGE_TYPE,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_CURRENT_MAX,\n\tPOWER_SUPPLY_PROP_MODEL_NAME,\n\tPOWER_SUPPLY_PROP_MANUFACTURER\n};\n\nstatic int act8945a_charger_get_property(struct power_supply *psy,\n\t\t\t\t\t enum power_supply_property prop,\n\t\t\t\t\t union power_supply_propval *val)\n{\n\tstruct act8945a_charger *charger = power_supply_get_drvdata(psy);\n\tstruct regmap *regmap = charger->regmap;\n\tint ret = 0;\n\n\tswitch (prop) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tret = act8945a_get_charger_state(regmap, &val->intval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tret = act8945a_get_charge_type(regmap, &val->intval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tret = act8945a_get_battery_health(regmap, &val->intval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CAPACITY_LEVEL:\n\t\tret = act8945a_get_capacity_level(charger,\n\t\t\t\t\t\t  regmap, &val->intval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_MAX:\n\t\tret = act8945a_get_current_max(charger,\n\t\t\t\t\t       regmap, &val->intval);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_MODEL_NAME:\n\t\tval->strval = act8945a_charger_model;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_MANUFACTURER:\n\t\tval->strval = act8945a_charger_manufacturer;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic int act8945a_enable_interrupt(struct act8945a_charger *charger)\n{\n\tstruct regmap *regmap = charger->regmap;\n\tunsigned char ctrl;\n\tint ret;\n\n\tctrl = APCH_CTRL_CHGEOCOUT | APCH_CTRL_CHGEOCIN |\n\t       APCH_CTRL_INDIS | APCH_CTRL_INCON |\n\t       APCH_CTRL_TEMPOUT | APCH_CTRL_TEMPIN |\n\t       APCH_CTRL_TIMRPRE | APCH_CTRL_TIMRTOT;\n\tret = regmap_write(regmap, ACT8945A_APCH_CTRL, ctrl);\n\tif (ret)\n\t\treturn ret;\n\n\tctrl = APCH_STATUS_CHGSTAT | APCH_STATUS_INSTAT |\n\t       APCH_STATUS_TEMPSTAT | APCH_STATUS_TIMRSTAT;\n\tret = regmap_write(regmap, ACT8945A_APCH_STATUS, ctrl);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic unsigned int act8945a_set_supply_type(struct act8945a_charger *charger,\n\t\t\t\t\t     unsigned int *type)\n{\n\tunsigned int status, state;\n\tint ret;\n\n\tret = regmap_read(charger->regmap, ACT8945A_APCH_STATUS, &status);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_read(charger->regmap, ACT8945A_APCH_STATE, &state);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (status & APCH_STATUS_INDAT) {\n\t\tif (state & APCH_STATE_ACINSTAT)\n\t\t\t*type = POWER_SUPPLY_TYPE_MAINS;\n\t\telse\n\t\t\t*type = POWER_SUPPLY_TYPE_USB;\n\t} else {\n\t\t*type = POWER_SUPPLY_TYPE_BATTERY;\n\t}\n\n\treturn 0;\n}\n\nstatic void act8945a_work(struct work_struct *work)\n{\n\tstruct act8945a_charger *charger =\n\t\t\tcontainer_of(work, struct act8945a_charger, work);\n\n\tact8945a_set_supply_type(charger, &charger->desc.type);\n\n\tpower_supply_changed(charger->psy);\n}\n\nstatic irqreturn_t act8945a_status_changed(int irq, void *dev_id)\n{\n\tstruct act8945a_charger *charger = dev_id;\n\n\tif (charger->init_done)\n\t\tschedule_work(&charger->work);\n\n\treturn IRQ_HANDLED;\n}\n\n#define DEFAULT_TOTAL_TIME_OUT\t\t3\n#define DEFAULT_PRE_TIME_OUT\t\t40\n#define DEFAULT_INPUT_OVP_THRESHOLD\t6600\n\nstatic int act8945a_charger_config(struct device *dev,\n\t\t\t\t   struct act8945a_charger *charger)\n{\n\tstruct device_node *np = dev->of_node;\n\tstruct regmap *regmap = charger->regmap;\n\n\tu32 total_time_out;\n\tu32 pre_time_out;\n\tu32 input_voltage_threshold;\n\tint err, ret;\n\n\tunsigned int tmp;\n\tunsigned int value = 0;\n\n\tif (!np) {\n\t\tdev_err(dev, \"no charger of node\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = regmap_read(regmap, ACT8945A_APCH_CFG, &tmp);\n\tif (ret)\n\t\treturn ret;\n\n\tif (tmp & APCH_CFG_SUSCHG) {\n\t\tvalue |= APCH_CFG_SUSCHG;\n\t\tdev_info(dev, \"have been suspended\\n\");\n\t}\n\n\tcharger->lbo_gpio = devm_gpiod_get_optional(dev, \"active-semi,lbo\",\n\t\t\t\t\t\t    GPIOD_IN);\n\tif (IS_ERR(charger->lbo_gpio)) {\n\t\terr = PTR_ERR(charger->lbo_gpio);\n\t\tdev_err(dev, \"unable to claim gpio \\\"lbo\\\": %d\\n\", err);\n\t\treturn err;\n\t}\n\n\tret = devm_request_irq(dev, gpiod_to_irq(charger->lbo_gpio),\n\t\t\t       act8945a_status_changed,\n\t\t\t       (IRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING),\n\t\t\t       \"act8945a_lbo_detect\", charger);\n\tif (ret)\n\t\tdev_info(dev, \"failed to request gpio \\\"lbo\\\" IRQ\\n\");\n\n\tcharger->chglev_gpio = devm_gpiod_get_optional(dev,\n\t\t\t\t\t\t       \"active-semi,chglev\",\n\t\t\t\t\t\t       GPIOD_IN);\n\tif (IS_ERR(charger->chglev_gpio)) {\n\t\terr = PTR_ERR(charger->chglev_gpio);\n\t\tdev_err(dev, \"unable to claim gpio \\\"chglev\\\": %d\\n\", err);\n\t\treturn err;\n\t}\n\n\tif (of_property_read_u32(np,\n\t\t\t\t \"active-semi,input-voltage-threshold-microvolt\",\n\t\t\t\t &input_voltage_threshold))\n\t\tinput_voltage_threshold = DEFAULT_INPUT_OVP_THRESHOLD;\n\n\tif (of_property_read_u32(np,\n\t\t\t\t \"active-semi,precondition-timeout\",\n\t\t\t\t &pre_time_out))\n\t\tpre_time_out = DEFAULT_PRE_TIME_OUT;\n\n\tif (of_property_read_u32(np, \"active-semi,total-timeout\",\n\t\t\t\t &total_time_out))\n\t\ttotal_time_out = DEFAULT_TOTAL_TIME_OUT;\n\n\tswitch (input_voltage_threshold) {\n\tcase 8000:\n\t\tvalue |= APCH_CFG_OVPSET_8V;\n\t\tbreak;\n\tcase 7500:\n\t\tvalue |= APCH_CFG_OVPSET_7V5;\n\t\tbreak;\n\tcase 7000:\n\t\tvalue |= APCH_CFG_OVPSET_7V;\n\t\tbreak;\n\tcase 6600:\n\tdefault:\n\t\tvalue |= APCH_CFG_OVPSET_6V6;\n\t\tbreak;\n\t}\n\n\tswitch (pre_time_out) {\n\tcase 60:\n\t\tvalue |= APCH_CFG_PRETIMO_60_MIN;\n\t\tbreak;\n\tcase 80:\n\t\tvalue |= APCH_CFG_PRETIMO_80_MIN;\n\t\tbreak;\n\tcase 0:\n\t\tvalue |= APCH_CFG_PRETIMO_DISABLED;\n\t\tbreak;\n\tcase 40:\n\tdefault:\n\t\tvalue |= APCH_CFG_PRETIMO_40_MIN;\n\t\tbreak;\n\t}\n\n\tswitch (total_time_out) {\n\tcase 4:\n\t\tvalue |= APCH_CFG_TOTTIMO_4_HOUR;\n\t\tbreak;\n\tcase 5:\n\t\tvalue |= APCH_CFG_TOTTIMO_5_HOUR;\n\t\tbreak;\n\tcase 0:\n\t\tvalue |= APCH_CFG_TOTTIMO_DISABLED;\n\t\tbreak;\n\tcase 3:\n\tdefault:\n\t\tvalue |= APCH_CFG_TOTTIMO_3_HOUR;\n\t\tbreak;\n\t}\n\n\treturn regmap_write(regmap, ACT8945A_APCH_CFG, value);\n}\n\nstatic int act8945a_charger_probe(struct platform_device *pdev)\n{\n\tstruct act8945a_charger *charger;\n\tstruct power_supply_config psy_cfg = {};\n\tint irq, ret;\n\n\tcharger = devm_kzalloc(&pdev->dev, sizeof(*charger), GFP_KERNEL);\n\tif (!charger)\n\t\treturn -ENOMEM;\n\n\tcharger->regmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!charger->regmap) {\n\t\tdev_err(&pdev->dev, \"Parent did not provide regmap\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = act8945a_charger_config(&pdev->dev, charger);\n\tif (ret)\n\t\treturn ret;\n\n\tirq = of_irq_get(pdev->dev.of_node, 0);\n\tif (irq <= 0) {\n\t\tdev_err(&pdev->dev, \"failed to find IRQ number\\n\");\n\t\treturn irq ?: -ENXIO;\n\t}\n\n\tret = devm_request_irq(&pdev->dev, irq, act8945a_status_changed,\n\t\t\t       IRQF_TRIGGER_FALLING, \"act8945a_interrupt\",\n\t\t\t       charger);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to request nIRQ pin IRQ\\n\");\n\t\treturn ret;\n\t}\n\n\tcharger->desc.name = \"act8945a-charger\";\n\tcharger->desc.get_property = act8945a_charger_get_property;\n\tcharger->desc.properties = act8945a_charger_props;\n\tcharger->desc.num_properties = ARRAY_SIZE(act8945a_charger_props);\n\n\tret = act8945a_set_supply_type(charger, &charger->desc.type);\n\tif (ret)\n\t\treturn -EINVAL;\n\n\tpsy_cfg.of_node\t= pdev->dev.of_node;\n\tpsy_cfg.drv_data = charger;\n\n\tcharger->psy = devm_power_supply_register(&pdev->dev,\n\t\t\t\t\t\t  &charger->desc,\n\t\t\t\t\t\t  &psy_cfg);\n\tif (IS_ERR(charger->psy)) {\n\t\tdev_err(&pdev->dev, \"failed to register power supply\\n\");\n\t\treturn PTR_ERR(charger->psy);\n\t}\n\n\tplatform_set_drvdata(pdev, charger);\n\n\tINIT_WORK(&charger->work, act8945a_work);\n\n\tret = act8945a_enable_interrupt(charger);\n\tif (ret)\n\t\treturn -EIO;\n\n\tcharger->init_done = true;\n\n\treturn 0;\n}\n\nstatic int act8945a_charger_remove(struct platform_device *pdev)\n{\n\tstruct act8945a_charger *charger = platform_get_drvdata(pdev);\n\n\tcharger->init_done = false;\n\tcancel_work_sync(&charger->work);\n\n\treturn 0;\n}\n\nstatic struct platform_driver act8945a_charger_driver = {\n\t.driver\t= {\n\t\t.name = \"act8945a-charger\",\n\t},\n\t.probe\t= act8945a_charger_probe,\n\t.remove = act8945a_charger_remove,\n};\nmodule_platform_driver(act8945a_charger_driver);\n\nMODULE_DESCRIPTION(\"Active-semi ACT8945A ActivePath charger driver\");\nMODULE_AUTHOR(\"Wenyou Yang <wenyou.yang@atmel.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}