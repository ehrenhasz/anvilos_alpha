{
  "module_name": "max8903_charger.c",
  "hash_id": "b5cc43cac91fb1657443dae5e38e04b3f882b356ea8e86b37662a31117281357",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/max8903_charger.c",
  "human_readable_source": "\n \n\n#include <linux/gpio/consumer.h>\n#include <linux/interrupt.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/slab.h>\n#include <linux/power_supply.h>\n#include <linux/platform_device.h>\n\nstruct max8903_data {\n\tstruct device *dev;\n\tstruct power_supply *psy;\n\tstruct power_supply_desc psy_desc;\n\t \n\tstruct gpio_desc *cen;  \n\tstruct gpio_desc *dok;  \n\tstruct gpio_desc *uok;  \n\tstruct gpio_desc *chg;  \n\tstruct gpio_desc *flt;  \n\tstruct gpio_desc *dcm;  \n\tstruct gpio_desc *usus;  \n\tbool fault;\n\tbool usb_in;\n\tbool ta_in;\n};\n\nstatic enum power_supply_property max8903_charger_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,  \n\tPOWER_SUPPLY_PROP_ONLINE,  \n\tPOWER_SUPPLY_PROP_HEALTH,  \n};\n\nstatic int max8903_get_property(struct power_supply *psy,\n\t\tenum power_supply_property psp,\n\t\tunion power_supply_propval *val)\n{\n\tstruct max8903_data *data = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tval->intval = POWER_SUPPLY_STATUS_UNKNOWN;\n\t\tif (data->chg) {\n\t\t\tif (gpiod_get_value(data->chg))\n\t\t\t\t \n\t\t\t\tval->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\t\telse if (data->usb_in || data->ta_in)\n\t\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\t\telse\n\t\t\t\tval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\n\t\t}\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = 0;\n\t\tif (data->usb_in || data->ta_in)\n\t\t\tval->intval = 1;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tval->intval = POWER_SUPPLY_HEALTH_GOOD;\n\t\tif (data->fault)\n\t\t\tval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic irqreturn_t max8903_dcin(int irq, void *_data)\n{\n\tstruct max8903_data *data = _data;\n\tbool ta_in;\n\tenum power_supply_type old_type;\n\n\t \n\tta_in = gpiod_get_value(data->dok);\n\n\tif (ta_in == data->ta_in)\n\t\treturn IRQ_HANDLED;\n\n\tdata->ta_in = ta_in;\n\n\t \n\tif (data->dcm)\n\t\tgpiod_set_value(data->dcm, ta_in);\n\n\t \n\tif (data->cen) {\n\t\tint val;\n\n\t\tif (ta_in)\n\t\t\t \n\t\t\tval = 1;\n\t\telse if (data->usb_in)\n\t\t\t \n\t\t\tval = 1;\n\t\telse\n\t\t\t \n\t\t\tval = 0;\n\n\t\tgpiod_set_value(data->cen, val);\n\t}\n\n\tdev_dbg(data->dev, \"TA(DC-IN) Charger %s.\\n\", ta_in ?\n\t\t\t\"Connected\" : \"Disconnected\");\n\n\told_type = data->psy_desc.type;\n\n\tif (data->ta_in)\n\t\tdata->psy_desc.type = POWER_SUPPLY_TYPE_MAINS;\n\telse if (data->usb_in)\n\t\tdata->psy_desc.type = POWER_SUPPLY_TYPE_USB;\n\telse\n\t\tdata->psy_desc.type = POWER_SUPPLY_TYPE_BATTERY;\n\n\tif (old_type != data->psy_desc.type)\n\t\tpower_supply_changed(data->psy);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t max8903_usbin(int irq, void *_data)\n{\n\tstruct max8903_data *data = _data;\n\tbool usb_in;\n\tenum power_supply_type old_type;\n\n\t \n\tusb_in = gpiod_get_value(data->uok);\n\n\tif (usb_in == data->usb_in)\n\t\treturn IRQ_HANDLED;\n\n\tdata->usb_in = usb_in;\n\n\t \n\n\t \n\tif (data->cen) {\n\t\tint val;\n\n\t\tif (usb_in)\n\t\t\t \n\t\t\tval = 1;\n\t\telse if (data->ta_in)\n\t\t\t \n\t\t\tval = 1;\n\t\telse\n\t\t\t \n\t\t\tval = 0;\n\n\t\tgpiod_set_value(data->cen, val);\n\t}\n\n\tdev_dbg(data->dev, \"USB Charger %s.\\n\", usb_in ?\n\t\t\t\"Connected\" : \"Disconnected\");\n\n\told_type = data->psy_desc.type;\n\n\tif (data->ta_in)\n\t\tdata->psy_desc.type = POWER_SUPPLY_TYPE_MAINS;\n\telse if (data->usb_in)\n\t\tdata->psy_desc.type = POWER_SUPPLY_TYPE_USB;\n\telse\n\t\tdata->psy_desc.type = POWER_SUPPLY_TYPE_BATTERY;\n\n\tif (old_type != data->psy_desc.type)\n\t\tpower_supply_changed(data->psy);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic irqreturn_t max8903_fault(int irq, void *_data)\n{\n\tstruct max8903_data *data = _data;\n\tbool fault;\n\n\t \n\tfault = gpiod_get_value(data->flt);\n\n\tif (fault == data->fault)\n\t\treturn IRQ_HANDLED;\n\n\tdata->fault = fault;\n\n\tif (fault)\n\t\tdev_err(data->dev, \"Charger suffers a fault and stops.\\n\");\n\telse\n\t\tdev_err(data->dev, \"Charger recovered from a fault.\\n\");\n\n\treturn IRQ_HANDLED;\n}\n\nstatic int max8903_setup_gpios(struct platform_device *pdev)\n{\n\tstruct max8903_data *data = platform_get_drvdata(pdev);\n\tstruct device *dev = &pdev->dev;\n\tbool ta_in = false;\n\tbool usb_in = false;\n\tenum gpiod_flags flags;\n\n\tdata->dok = devm_gpiod_get_optional(dev, \"dok\", GPIOD_IN);\n\tif (IS_ERR(data->dok))\n\t\treturn dev_err_probe(dev, PTR_ERR(data->dok),\n\t\t\t\t     \"failed to get DOK GPIO\");\n\tif (data->dok) {\n\t\tgpiod_set_consumer_name(data->dok, data->psy_desc.name);\n\t\t \n\t\tta_in = gpiod_get_value(data->dok);\n\t}\n\n\tdata->uok = devm_gpiod_get_optional(dev, \"uok\", GPIOD_IN);\n\tif (IS_ERR(data->uok))\n\t\treturn dev_err_probe(dev, PTR_ERR(data->uok),\n\t\t\t\t     \"failed to get UOK GPIO\");\n\tif (data->uok) {\n\t\tgpiod_set_consumer_name(data->uok, data->psy_desc.name);\n\t\t \n\t\tusb_in = gpiod_get_value(data->uok);\n\t}\n\n\t \n\tif (!data->dok && !data->uok) {\n\t\tdev_err(dev, \"no valid power source\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tflags = (ta_in || usb_in) ? GPIOD_OUT_HIGH : GPIOD_OUT_LOW;\n\t \n\tdata->cen = devm_gpiod_get(dev, \"cen\", flags);\n\tif (IS_ERR(data->cen))\n\t\treturn dev_err_probe(dev, PTR_ERR(data->cen),\n\t\t\t\t     \"failed to get CEN GPIO\");\n\tgpiod_set_consumer_name(data->cen, data->psy_desc.name);\n\n\t \n\tflags = ta_in ? GPIOD_OUT_HIGH : GPIOD_OUT_LOW;\n\tdata->dcm = devm_gpiod_get_optional(dev, \"dcm\", flags);\n\tif (IS_ERR(data->dcm))\n\t\treturn dev_err_probe(dev, PTR_ERR(data->dcm),\n\t\t\t\t     \"failed to get DCM GPIO\");\n\tgpiod_set_consumer_name(data->dcm, data->psy_desc.name);\n\n\tdata->chg = devm_gpiod_get_optional(dev, \"chg\", GPIOD_IN);\n\tif (IS_ERR(data->chg))\n\t\treturn dev_err_probe(dev, PTR_ERR(data->chg),\n\t\t\t\t     \"failed to get CHG GPIO\");\n\tgpiod_set_consumer_name(data->chg, data->psy_desc.name);\n\n\tdata->flt = devm_gpiod_get_optional(dev, \"flt\", GPIOD_IN);\n\tif (IS_ERR(data->flt))\n\t\treturn dev_err_probe(dev, PTR_ERR(data->flt),\n\t\t\t\t     \"failed to get FLT GPIO\");\n\tgpiod_set_consumer_name(data->flt, data->psy_desc.name);\n\n\tdata->usus = devm_gpiod_get_optional(dev, \"usus\", GPIOD_IN);\n\tif (IS_ERR(data->usus))\n\t\treturn dev_err_probe(dev, PTR_ERR(data->usus),\n\t\t\t\t     \"failed to get USUS GPIO\");\n\tgpiod_set_consumer_name(data->usus, data->psy_desc.name);\n\n\tdata->fault = false;\n\tdata->ta_in = ta_in;\n\tdata->usb_in = usb_in;\n\n\treturn 0;\n}\n\nstatic int max8903_probe(struct platform_device *pdev)\n{\n\tstruct max8903_data *data;\n\tstruct device *dev = &pdev->dev;\n\tstruct power_supply_config psy_cfg = {};\n\tint ret = 0;\n\n\tdata = devm_kzalloc(dev, sizeof(struct max8903_data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tdata->dev = dev;\n\tplatform_set_drvdata(pdev, data);\n\n\tret = max8903_setup_gpios(pdev);\n\tif (ret)\n\t\treturn ret;\n\n\tdata->psy_desc.name = \"max8903_charger\";\n\tdata->psy_desc.type = (data->ta_in) ? POWER_SUPPLY_TYPE_MAINS :\n\t\t\t((data->usb_in) ? POWER_SUPPLY_TYPE_USB :\n\t\t\t POWER_SUPPLY_TYPE_BATTERY);\n\tdata->psy_desc.get_property = max8903_get_property;\n\tdata->psy_desc.properties = max8903_charger_props;\n\tdata->psy_desc.num_properties = ARRAY_SIZE(max8903_charger_props);\n\n\tpsy_cfg.of_node = dev->of_node;\n\tpsy_cfg.drv_data = data;\n\n\tdata->psy = devm_power_supply_register(dev, &data->psy_desc, &psy_cfg);\n\tif (IS_ERR(data->psy)) {\n\t\tdev_err(dev, \"failed: power supply register.\\n\");\n\t\treturn PTR_ERR(data->psy);\n\t}\n\n\tif (data->dok) {\n\t\tret = devm_request_threaded_irq(dev, gpiod_to_irq(data->dok),\n\t\t\t\t\tNULL, max8903_dcin,\n\t\t\t\t\tIRQF_TRIGGER_FALLING |\n\t\t\t\t\tIRQF_TRIGGER_RISING | IRQF_ONESHOT,\n\t\t\t\t\t\"MAX8903 DC IN\", data);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Cannot request irq %d for DC (%d)\\n\",\n\t\t\t\t\tgpiod_to_irq(data->dok), ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tif (data->uok) {\n\t\tret = devm_request_threaded_irq(dev, gpiod_to_irq(data->uok),\n\t\t\t\t\tNULL, max8903_usbin,\n\t\t\t\t\tIRQF_TRIGGER_FALLING |\n\t\t\t\t\tIRQF_TRIGGER_RISING | IRQF_ONESHOT,\n\t\t\t\t\t\"MAX8903 USB IN\", data);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Cannot request irq %d for USB (%d)\\n\",\n\t\t\t\t\tgpiod_to_irq(data->uok), ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tif (data->flt) {\n\t\tret = devm_request_threaded_irq(dev, gpiod_to_irq(data->flt),\n\t\t\t\t\tNULL, max8903_fault,\n\t\t\t\t\tIRQF_TRIGGER_FALLING |\n\t\t\t\t\tIRQF_TRIGGER_RISING | IRQF_ONESHOT,\n\t\t\t\t\t\"MAX8903 Fault\", data);\n\t\tif (ret) {\n\t\t\tdev_err(dev, \"Cannot request irq %d for Fault (%d)\\n\",\n\t\t\t\t\tgpiod_to_irq(data->flt), ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct of_device_id max8903_match_ids[] = {\n\t{ .compatible = \"maxim,max8903\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, max8903_match_ids);\n\nstatic struct platform_driver max8903_driver = {\n\t.probe\t= max8903_probe,\n\t.driver = {\n\t\t.name\t= \"max8903-charger\",\n\t\t.of_match_table = max8903_match_ids\n\t},\n};\n\nmodule_platform_driver(max8903_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"MAX8903 Charger Driver\");\nMODULE_AUTHOR(\"MyungJoo Ham <myungjoo.ham@samsung.com>\");\nMODULE_ALIAS(\"platform:max8903-charger\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}