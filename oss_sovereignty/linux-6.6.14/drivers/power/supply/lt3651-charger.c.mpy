{
  "module_name": "lt3651-charger.c",
  "hash_id": "7f5307d519c057a7ec39d9c4622f2443ab41c742b201d059c353b16b28f5378d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/lt3651-charger.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/gpio/consumer.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/slab.h>\n#include <linux/of.h>\n\nstruct lt3651_charger {\n\tstruct power_supply *charger;\n\tstruct power_supply_desc charger_desc;\n\tstruct gpio_desc *acpr_gpio;\n\tstruct gpio_desc *fault_gpio;\n\tstruct gpio_desc *chrg_gpio;\n};\n\nstatic irqreturn_t lt3651_charger_irq(int irq, void *devid)\n{\n\tstruct power_supply *charger = devid;\n\n\tpower_supply_changed(charger);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic inline struct lt3651_charger *psy_to_lt3651_charger(\n\tstruct power_supply *psy)\n{\n\treturn power_supply_get_drvdata(psy);\n}\n\nstatic int lt3651_charger_get_property(struct power_supply *psy,\n\t\tenum power_supply_property psp, union power_supply_propval *val)\n{\n\tstruct lt3651_charger *lt3651_charger = psy_to_lt3651_charger(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tif (!lt3651_charger->chrg_gpio) {\n\t\t\tval->intval = POWER_SUPPLY_STATUS_UNKNOWN;\n\t\t\tbreak;\n\t\t}\n\t\tif (gpiod_get_value(lt3651_charger->chrg_gpio))\n\t\t\tval->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\telse\n\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = gpiod_get_value(lt3651_charger->acpr_gpio);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tif (!lt3651_charger->fault_gpio) {\n\t\t\tval->intval = POWER_SUPPLY_HEALTH_UNKNOWN;\n\t\t\tbreak;\n\t\t}\n\t\tif (!gpiod_get_value(lt3651_charger->fault_gpio)) {\n\t\t\tval->intval = POWER_SUPPLY_HEALTH_GOOD;\n\t\t\tbreak;\n\t\t}\n\t\t \n\t\tif (!lt3651_charger->chrg_gpio) {\n\t\t\tval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\t\t\tbreak;\n\t\t}\n\t\tval->intval = gpiod_get_value(lt3651_charger->chrg_gpio) ?\n\t\t\t\tPOWER_SUPPLY_HEALTH_OVERHEAT :\n\t\t\t\tPOWER_SUPPLY_HEALTH_DEAD;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic enum power_supply_property lt3651_charger_properties[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_HEALTH,\n};\n\nstatic int lt3651_charger_probe(struct platform_device *pdev)\n{\n\tstruct power_supply_config psy_cfg = {};\n\tstruct lt3651_charger *lt3651_charger;\n\tstruct power_supply_desc *charger_desc;\n\tint ret;\n\n\tlt3651_charger = devm_kzalloc(&pdev->dev, sizeof(*lt3651_charger),\n\t\t\t\t\tGFP_KERNEL);\n\tif (!lt3651_charger)\n\t\treturn -ENOMEM;\n\n\tlt3651_charger->acpr_gpio = devm_gpiod_get(&pdev->dev,\n\t\t\t\t\t\"lltc,acpr\", GPIOD_IN);\n\tif (IS_ERR(lt3651_charger->acpr_gpio)) {\n\t\tret = PTR_ERR(lt3651_charger->acpr_gpio);\n\t\tdev_err(&pdev->dev, \"Failed to acquire acpr GPIO: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tlt3651_charger->fault_gpio = devm_gpiod_get_optional(&pdev->dev,\n\t\t\t\t\t\"lltc,fault\", GPIOD_IN);\n\tif (IS_ERR(lt3651_charger->fault_gpio)) {\n\t\tret = PTR_ERR(lt3651_charger->fault_gpio);\n\t\tdev_err(&pdev->dev, \"Failed to acquire fault GPIO: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tlt3651_charger->chrg_gpio = devm_gpiod_get_optional(&pdev->dev,\n\t\t\t\t\t\"lltc,chrg\", GPIOD_IN);\n\tif (IS_ERR(lt3651_charger->chrg_gpio)) {\n\t\tret = PTR_ERR(lt3651_charger->chrg_gpio);\n\t\tdev_err(&pdev->dev, \"Failed to acquire chrg GPIO: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tcharger_desc = &lt3651_charger->charger_desc;\n\tcharger_desc->name = pdev->dev.of_node->name;\n\tcharger_desc->type = POWER_SUPPLY_TYPE_MAINS;\n\tcharger_desc->properties = lt3651_charger_properties;\n\tcharger_desc->num_properties = ARRAY_SIZE(lt3651_charger_properties);\n\tcharger_desc->get_property = lt3651_charger_get_property;\n\tpsy_cfg.of_node = pdev->dev.of_node;\n\tpsy_cfg.drv_data = lt3651_charger;\n\n\tlt3651_charger->charger = devm_power_supply_register(&pdev->dev,\n\t\t\t\t\t\t      charger_desc, &psy_cfg);\n\tif (IS_ERR(lt3651_charger->charger)) {\n\t\tret = PTR_ERR(lt3651_charger->charger);\n\t\tdev_err(&pdev->dev, \"Failed to register power supply: %d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\t \n\tif (lt3651_charger->acpr_gpio) {\n\t\tret = gpiod_to_irq(lt3651_charger->acpr_gpio);\n\t\tif (ret >= 0)\n\t\t\tret = devm_request_any_context_irq(&pdev->dev, ret,\n\t\t\t\tlt3651_charger_irq,\n\t\t\t\tIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\n\t\t\t\tdev_name(&pdev->dev), lt3651_charger->charger);\n\t\tif (ret < 0)\n\t\t\tdev_warn(&pdev->dev, \"Failed to request acpr irq\\n\");\n\t}\n\tif (lt3651_charger->fault_gpio) {\n\t\tret = gpiod_to_irq(lt3651_charger->fault_gpio);\n\t\tif (ret >= 0)\n\t\t\tret = devm_request_any_context_irq(&pdev->dev, ret,\n\t\t\t\tlt3651_charger_irq,\n\t\t\t\tIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\n\t\t\t\tdev_name(&pdev->dev), lt3651_charger->charger);\n\t\tif (ret < 0)\n\t\t\tdev_warn(&pdev->dev, \"Failed to request fault irq\\n\");\n\t}\n\tif (lt3651_charger->chrg_gpio) {\n\t\tret = gpiod_to_irq(lt3651_charger->chrg_gpio);\n\t\tif (ret >= 0)\n\t\t\tret = devm_request_any_context_irq(&pdev->dev, ret,\n\t\t\t\tlt3651_charger_irq,\n\t\t\t\tIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\n\t\t\t\tdev_name(&pdev->dev), lt3651_charger->charger);\n\t\tif (ret < 0)\n\t\t\tdev_warn(&pdev->dev, \"Failed to request chrg irq\\n\");\n\t}\n\n\tplatform_set_drvdata(pdev, lt3651_charger);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id lt3651_charger_match[] = {\n\t{ .compatible = \"lltc,ltc3651-charger\" },  \n\t{ .compatible = \"lltc,lt3651-charger\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, lt3651_charger_match);\n\nstatic struct platform_driver lt3651_charger_driver = {\n\t.probe = lt3651_charger_probe,\n\t.driver = {\n\t\t.name = \"lt3651-charger\",\n\t\t.of_match_table = lt3651_charger_match,\n\t},\n};\n\nmodule_platform_driver(lt3651_charger_driver);\n\nMODULE_AUTHOR(\"Mike Looijmans <mike.looijmans@topic.nl>\");\nMODULE_DESCRIPTION(\"Driver for LT3651 charger\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:lt3651-charger\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}