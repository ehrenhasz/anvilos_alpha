{
  "module_name": "bq27xxx_battery_hdq.c",
  "hash_id": "c5a5fd67d5237f00c37d0160f60329fda7970d3b45d58172eb1033bbbd022247",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/bq27xxx_battery_hdq.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/types.h>\n#include <linux/platform_device.h>\n#include <linux/mutex.h>\n#include <linux/power/bq27xxx_battery.h>\n\n#include <linux/w1.h>\n\n#define W1_FAMILY_BQ27000\t0x01\n\n#define HDQ_CMD_READ\t(0 << 7)\n#define HDQ_CMD_WRITE\t(1 << 7)\n\nstatic int F_ID;\nmodule_param(F_ID, int, S_IRUSR);\nMODULE_PARM_DESC(F_ID, \"1-wire slave FID for BQ27xxx device\");\n\nstatic int w1_bq27000_read(struct w1_slave *sl, unsigned int reg)\n{\n\tu8 val;\n\n\tmutex_lock(&sl->master->bus_mutex);\n\tw1_write_8(sl->master, HDQ_CMD_READ | reg);\n\tval = w1_read_8(sl->master);\n\tmutex_unlock(&sl->master->bus_mutex);\n\n\treturn val;\n}\n\nstatic int bq27xxx_battery_hdq_read(struct bq27xxx_device_info *di, u8 reg,\n\t\t\t\t    bool single)\n{\n\tstruct w1_slave *sl = dev_to_w1_slave(di->dev);\n\tunsigned int timeout = 3;\n\tint upper, lower;\n\tint temp;\n\n\tif (!single) {\n\t\t \n\t\tupper = w1_bq27000_read(sl, reg + 1);\n\t\tdo {\n\t\t\ttemp = upper;\n\t\t\tif (upper < 0)\n\t\t\t\treturn upper;\n\n\t\t\tlower = w1_bq27000_read(sl, reg);\n\t\t\tif (lower < 0)\n\t\t\t\treturn lower;\n\n\t\t\tupper = w1_bq27000_read(sl, reg + 1);\n\t\t} while (temp != upper && --timeout);\n\n\t\tif (timeout == 0)\n\t\t\treturn -EIO;\n\n\t\treturn (upper << 8) | lower;\n\t}\n\n\treturn w1_bq27000_read(sl, reg);\n}\n\nstatic int bq27xxx_battery_hdq_add_slave(struct w1_slave *sl)\n{\n\tstruct bq27xxx_device_info *di;\n\n\tdi = devm_kzalloc(&sl->dev, sizeof(*di), GFP_KERNEL);\n\tif (!di)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(&sl->dev, di);\n\n\tdi->dev = &sl->dev;\n\tdi->chip = BQ27000;\n\tdi->name = \"bq27000-battery\";\n\tdi->bus.read = bq27xxx_battery_hdq_read;\n\n\treturn bq27xxx_battery_setup(di);\n}\n\nstatic void bq27xxx_battery_hdq_remove_slave(struct w1_slave *sl)\n{\n\tstruct bq27xxx_device_info *di = dev_get_drvdata(&sl->dev);\n\n\tbq27xxx_battery_teardown(di);\n}\n\nstatic const struct w1_family_ops bq27xxx_battery_hdq_fops = {\n\t.add_slave\t= bq27xxx_battery_hdq_add_slave,\n\t.remove_slave\t= bq27xxx_battery_hdq_remove_slave,\n};\n\nstatic struct w1_family bq27xxx_battery_hdq_family = {\n\t.fid = W1_FAMILY_BQ27000,\n\t.fops = &bq27xxx_battery_hdq_fops,\n};\n\nstatic int __init bq27xxx_battery_hdq_init(void)\n{\n\tif (F_ID)\n\t\tbq27xxx_battery_hdq_family.fid = F_ID;\n\n\treturn w1_register_family(&bq27xxx_battery_hdq_family);\n}\nmodule_init(bq27xxx_battery_hdq_init);\n\nstatic void __exit bq27xxx_battery_hdq_exit(void)\n{\n\tw1_unregister_family(&bq27xxx_battery_hdq_family);\n}\nmodule_exit(bq27xxx_battery_hdq_exit);\n\nMODULE_AUTHOR(\"Texas Instruments Ltd\");\nMODULE_DESCRIPTION(\"BQ27xxx battery monitor HDQ/1-wire driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"w1-family-\" __stringify(W1_FAMILY_BQ27000));\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}