{
  "module_name": "tps65090-charger.c",
  "hash_id": "4591ebca564e337bdc12c3791176cea4e4b7ff5f60011cc9de76479f4479f3e0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/tps65090-charger.c",
  "human_readable_source": "\n \n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/freezer.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/kthread.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/slab.h>\n\n#include <linux/mfd/tps65090.h>\n\n#define TPS65090_CHARGER_ENABLE\tBIT(0)\n#define TPS65090_VACG\t\tBIT(1)\n#define TPS65090_NOITERM\tBIT(5)\n\n#define POLL_INTERVAL\t\t(HZ * 2)\t \n\nstruct tps65090_charger {\n\tstruct\tdevice\t*dev;\n\tint\tac_online;\n\tint\tprev_ac_online;\n\tint\tirq;\n\tstruct task_struct\t*poll_task;\n\tbool\t\t\tpassive_mode;\n\tstruct power_supply\t*ac;\n\tstruct tps65090_platform_data *pdata;\n};\n\nstatic enum power_supply_property tps65090_ac_props[] = {\n\tPOWER_SUPPLY_PROP_ONLINE,\n};\n\nstatic int tps65090_low_chrg_current(struct tps65090_charger *charger)\n{\n\tint ret;\n\n\tif (charger->passive_mode)\n\t\treturn 0;\n\n\tret = tps65090_write(charger->dev->parent, TPS65090_REG_CG_CTRL5,\n\t\t\tTPS65090_NOITERM);\n\tif (ret < 0) {\n\t\tdev_err(charger->dev, \"%s(): error reading in register 0x%x\\n\",\n\t\t\t__func__, TPS65090_REG_CG_CTRL5);\n\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic int tps65090_enable_charging(struct tps65090_charger *charger)\n{\n\tint ret;\n\tuint8_t ctrl0 = 0;\n\n\tif (charger->passive_mode)\n\t\treturn 0;\n\n\tret = tps65090_read(charger->dev->parent, TPS65090_REG_CG_CTRL0,\n\t\t\t    &ctrl0);\n\tif (ret < 0) {\n\t\tdev_err(charger->dev, \"%s(): error reading in register 0x%x\\n\",\n\t\t\t\t__func__, TPS65090_REG_CG_CTRL0);\n\t\treturn ret;\n\t}\n\n\tret = tps65090_write(charger->dev->parent, TPS65090_REG_CG_CTRL0,\n\t\t\t\t(ctrl0 | TPS65090_CHARGER_ENABLE));\n\tif (ret < 0) {\n\t\tdev_err(charger->dev, \"%s(): error writing in register 0x%x\\n\",\n\t\t\t\t__func__, TPS65090_REG_CG_CTRL0);\n\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic int tps65090_config_charger(struct tps65090_charger *charger)\n{\n\tuint8_t intrmask = 0;\n\tint ret;\n\n\tif (charger->passive_mode)\n\t\treturn 0;\n\n\tif (charger->pdata->enable_low_current_chrg) {\n\t\tret = tps65090_low_chrg_current(charger);\n\t\tif (ret < 0) {\n\t\t\tdev_err(charger->dev,\n\t\t\t\t\"error configuring low charge current\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\t \n\tret = tps65090_read(charger->dev->parent, TPS65090_REG_INTR_MASK,\n\t\t\t    &intrmask);\n\tif (ret < 0) {\n\t\tdev_err(charger->dev, \"%s(): error reading in register 0x%x\\n\",\n\t\t\t__func__, TPS65090_REG_INTR_MASK);\n\t\treturn ret;\n\t}\n\n\tret = tps65090_write(charger->dev->parent, TPS65090_REG_INTR_MASK,\n\t\t\t     (intrmask | TPS65090_VACG));\n\tif (ret < 0) {\n\t\tdev_err(charger->dev, \"%s(): error writing in register 0x%x\\n\",\n\t\t\t__func__, TPS65090_REG_CG_CTRL0);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int tps65090_ac_get_property(struct power_supply *psy,\n\t\t\tenum power_supply_property psp,\n\t\t\tunion power_supply_propval *val)\n{\n\tstruct tps65090_charger *charger = power_supply_get_drvdata(psy);\n\n\tif (psp == POWER_SUPPLY_PROP_ONLINE) {\n\t\tval->intval = charger->ac_online;\n\t\tcharger->prev_ac_online = charger->ac_online;\n\t\treturn 0;\n\t}\n\treturn -EINVAL;\n}\n\nstatic irqreturn_t tps65090_charger_isr(int irq, void *dev_id)\n{\n\tstruct tps65090_charger *charger = dev_id;\n\tint ret;\n\tuint8_t status1 = 0;\n\tuint8_t intrsts = 0;\n\n\tret = tps65090_read(charger->dev->parent, TPS65090_REG_CG_STATUS1,\n\t\t\t    &status1);\n\tif (ret < 0) {\n\t\tdev_err(charger->dev, \"%s(): Error in reading reg 0x%x\\n\",\n\t\t\t\t__func__, TPS65090_REG_CG_STATUS1);\n\t\treturn IRQ_HANDLED;\n\t}\n\tmsleep(75);\n\tret = tps65090_read(charger->dev->parent, TPS65090_REG_INTR_STS,\n\t\t\t    &intrsts);\n\tif (ret < 0) {\n\t\tdev_err(charger->dev, \"%s(): Error in reading reg 0x%x\\n\",\n\t\t\t\t__func__, TPS65090_REG_INTR_STS);\n\t\treturn IRQ_HANDLED;\n\t}\n\n\tif (intrsts & TPS65090_VACG) {\n\t\tret = tps65090_enable_charging(charger);\n\t\tif (ret < 0)\n\t\t\treturn IRQ_HANDLED;\n\t\tcharger->ac_online = 1;\n\t} else {\n\t\tcharger->ac_online = 0;\n\t}\n\n\t \n\tif (!charger->passive_mode) {\n\t\tret = tps65090_write(charger->dev->parent,\n\t\t\t\t     TPS65090_REG_INTR_STS, 0x00);\n\t\tif (ret < 0) {\n\t\t\tdev_err(charger->dev,\n\t\t\t\t\"%s(): Error in writing reg 0x%x\\n\",\n\t\t\t\t__func__, TPS65090_REG_INTR_STS);\n\t\t}\n\t}\n\n\tif (charger->prev_ac_online != charger->ac_online)\n\t\tpower_supply_changed(charger->ac);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic struct tps65090_platform_data *\n\t\ttps65090_parse_dt_charger_data(struct platform_device *pdev)\n{\n\tstruct tps65090_platform_data *pdata;\n\tstruct device_node *np = pdev->dev.of_node;\n\tunsigned int prop;\n\n\tpdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\n\tif (!pdata) {\n\t\tdev_err(&pdev->dev, \"Memory alloc for tps65090_pdata failed\\n\");\n\t\treturn NULL;\n\t}\n\n\tprop = of_property_read_bool(np, \"ti,enable-low-current-chrg\");\n\tpdata->enable_low_current_chrg = prop;\n\n\tpdata->irq_base = -1;\n\n\treturn pdata;\n\n}\n\nstatic int tps65090_charger_poll_task(void *data)\n{\n\tset_freezable();\n\n\twhile (!kthread_should_stop()) {\n\t\tschedule_timeout_interruptible(POLL_INTERVAL);\n\t\ttry_to_freeze();\n\t\ttps65090_charger_isr(-1, data);\n\t}\n\treturn 0;\n}\n\nstatic const struct power_supply_desc tps65090_charger_desc = {\n\t.name\t\t\t= \"tps65090-ac\",\n\t.type\t\t\t= POWER_SUPPLY_TYPE_MAINS,\n\t.get_property\t\t= tps65090_ac_get_property,\n\t.properties\t\t= tps65090_ac_props,\n\t.num_properties\t\t= ARRAY_SIZE(tps65090_ac_props),\n};\n\nstatic int tps65090_charger_probe(struct platform_device *pdev)\n{\n\tstruct tps65090_charger *cdata;\n\tstruct tps65090_platform_data *pdata;\n\tstruct power_supply_config psy_cfg = {};\n\tuint8_t status1 = 0;\n\tint ret;\n\tint irq;\n\n\tpdata = dev_get_platdata(pdev->dev.parent);\n\n\tif (IS_ENABLED(CONFIG_OF) && !pdata && pdev->dev.of_node)\n\t\tpdata = tps65090_parse_dt_charger_data(pdev);\n\n\tif (!pdata) {\n\t\tdev_err(&pdev->dev, \"%s():no platform data available\\n\",\n\t\t\t\t__func__);\n\t\treturn -ENODEV;\n\t}\n\n\tcdata = devm_kzalloc(&pdev->dev, sizeof(*cdata), GFP_KERNEL);\n\tif (!cdata) {\n\t\tdev_err(&pdev->dev, \"failed to allocate memory status\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tplatform_set_drvdata(pdev, cdata);\n\n\tcdata->dev\t\t\t= &pdev->dev;\n\tcdata->pdata\t\t\t= pdata;\n\n\tpsy_cfg.supplied_to\t\t= pdata->supplied_to;\n\tpsy_cfg.num_supplicants\t\t= pdata->num_supplicants;\n\tpsy_cfg.of_node\t\t\t= pdev->dev.of_node;\n\tpsy_cfg.drv_data\t\t= cdata;\n\n\tcdata->ac = power_supply_register(&pdev->dev, &tps65090_charger_desc,\n\t\t\t&psy_cfg);\n\tif (IS_ERR(cdata->ac)) {\n\t\tdev_err(&pdev->dev, \"failed: power supply register\\n\");\n\t\treturn PTR_ERR(cdata->ac);\n\t}\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\tirq = -ENXIO;\n\tcdata->irq = irq;\n\n\tret = tps65090_config_charger(cdata);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"charger config failed, err %d\\n\", ret);\n\t\tgoto fail_unregister_supply;\n\t}\n\n\t \n\tret = tps65090_read(cdata->dev->parent, TPS65090_REG_CG_STATUS1,\n\t\t\t&status1);\n\tif (ret < 0) {\n\t\tdev_err(cdata->dev, \"%s(): Error in reading reg 0x%x\", __func__,\n\t\t\tTPS65090_REG_CG_STATUS1);\n\t\tgoto fail_unregister_supply;\n\t}\n\n\tif (status1 != 0) {\n\t\tret = tps65090_enable_charging(cdata);\n\t\tif (ret < 0) {\n\t\t\tdev_err(cdata->dev, \"error enabling charger\\n\");\n\t\t\tgoto fail_unregister_supply;\n\t\t}\n\t\tcdata->ac_online = 1;\n\t\tpower_supply_changed(cdata->ac);\n\t}\n\n\tif (irq != -ENXIO) {\n\t\tret = devm_request_threaded_irq(&pdev->dev, irq, NULL,\n\t\t\ttps65090_charger_isr, IRQF_ONESHOT, \"tps65090-charger\", cdata);\n\t\tif (ret) {\n\t\t\tdev_err(cdata->dev,\n\t\t\t\t\"Unable to register irq %d err %d\\n\", irq,\n\t\t\t\tret);\n\t\t\tgoto fail_unregister_supply;\n\t\t}\n\t} else {\n\t\tcdata->poll_task = kthread_run(tps65090_charger_poll_task,\n\t\t\t\t\t      cdata, \"ktps65090charger\");\n\t\tcdata->passive_mode = true;\n\t\tif (IS_ERR(cdata->poll_task)) {\n\t\t\tret = PTR_ERR(cdata->poll_task);\n\t\t\tdev_err(cdata->dev,\n\t\t\t\t\"Unable to run kthread err %d\\n\", ret);\n\t\t\tgoto fail_unregister_supply;\n\t\t}\n\t}\n\n\treturn 0;\n\nfail_unregister_supply:\n\tpower_supply_unregister(cdata->ac);\n\n\treturn ret;\n}\n\nstatic int tps65090_charger_remove(struct platform_device *pdev)\n{\n\tstruct tps65090_charger *cdata = platform_get_drvdata(pdev);\n\n\tif (cdata->irq == -ENXIO)\n\t\tkthread_stop(cdata->poll_task);\n\tpower_supply_unregister(cdata->ac);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id of_tps65090_charger_match[] = {\n\t{ .compatible = \"ti,tps65090-charger\", },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, of_tps65090_charger_match);\n\nstatic struct platform_driver tps65090_charger_driver = {\n\t.driver\t= {\n\t\t.name\t= \"tps65090-charger\",\n\t\t.of_match_table = of_tps65090_charger_match,\n\t},\n\t.probe\t= tps65090_charger_probe,\n\t.remove = tps65090_charger_remove,\n};\nmodule_platform_driver(tps65090_charger_driver);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Syed Rafiuddin <srafiuddin@nvidia.com>\");\nMODULE_DESCRIPTION(\"tps65090 battery charger driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}