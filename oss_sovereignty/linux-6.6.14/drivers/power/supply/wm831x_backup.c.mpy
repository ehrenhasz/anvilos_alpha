{
  "module_name": "wm831x_backup.c",
  "hash_id": "f302766510a7f9d5fd5bf5454cec6ac7a0cfad039a3fd7c9f5b21ef0146a1773",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/wm831x_backup.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/slab.h>\n\n#include <linux/mfd/wm831x/core.h>\n#include <linux/mfd/wm831x/auxadc.h>\n#include <linux/mfd/wm831x/pmu.h>\n#include <linux/mfd/wm831x/pdata.h>\n\nstruct wm831x_backup {\n\tstruct wm831x *wm831x;\n\tstruct power_supply *backup;\n\tstruct power_supply_desc backup_desc;\n\tchar name[20];\n};\n\nstatic int wm831x_backup_read_voltage(struct wm831x *wm831x,\n\t\t\t\t     enum wm831x_auxadc src,\n\t\t\t\t     union power_supply_propval *val)\n{\n\tint ret;\n\n\tret = wm831x_auxadc_read_uv(wm831x, src);\n\tif (ret >= 0)\n\t\tval->intval = ret;\n\n\treturn ret;\n}\n\n \n\nstatic void wm831x_config_backup(struct wm831x *wm831x)\n{\n\tstruct wm831x_pdata *wm831x_pdata = wm831x->dev->platform_data;\n\tstruct wm831x_backup_pdata *pdata;\n\tint ret, reg;\n\n\tif (!wm831x_pdata || !wm831x_pdata->backup) {\n\t\tdev_warn(wm831x->dev,\n\t\t\t \"No backup battery charger configuration\\n\");\n\t\treturn;\n\t}\n\n\tpdata = wm831x_pdata->backup;\n\n\treg = 0;\n\n\tif (pdata->charger_enable)\n\t\treg |= WM831X_BKUP_CHG_ENA | WM831X_BKUP_BATT_DET_ENA;\n\tif (pdata->no_constant_voltage)\n\t\treg |= WM831X_BKUP_CHG_MODE;\n\n\tswitch (pdata->vlim) {\n\tcase 2500:\n\t\tbreak;\n\tcase 3100:\n\t\treg |= WM831X_BKUP_CHG_VLIM;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(wm831x->dev, \"Invalid backup voltage limit %dmV\\n\",\n\t\t\tpdata->vlim);\n\t}\n\n\tswitch (pdata->ilim) {\n\tcase 100:\n\t\tbreak;\n\tcase 200:\n\t\treg |= 1;\n\t\tbreak;\n\tcase 300:\n\t\treg |= 2;\n\t\tbreak;\n\tcase 400:\n\t\treg |= 3;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(wm831x->dev, \"Invalid backup current limit %duA\\n\",\n\t\t\tpdata->ilim);\n\t}\n\n\tret = wm831x_reg_unlock(wm831x);\n\tif (ret != 0) {\n\t\tdev_err(wm831x->dev, \"Failed to unlock registers: %d\\n\", ret);\n\t\treturn;\n\t}\n\n\tret = wm831x_set_bits(wm831x, WM831X_BACKUP_CHARGER_CONTROL,\n\t\t\t      WM831X_BKUP_CHG_ENA_MASK |\n\t\t\t      WM831X_BKUP_CHG_MODE_MASK |\n\t\t\t      WM831X_BKUP_BATT_DET_ENA_MASK |\n\t\t\t      WM831X_BKUP_CHG_VLIM_MASK |\n\t\t\t      WM831X_BKUP_CHG_ILIM_MASK,\n\t\t\t      reg);\n\tif (ret != 0)\n\t\tdev_err(wm831x->dev,\n\t\t\t\"Failed to set backup charger config: %d\\n\", ret);\n\n\twm831x_reg_lock(wm831x);\n}\n\nstatic int wm831x_backup_get_prop(struct power_supply *psy,\n\t\t\t\t  enum power_supply_property psp,\n\t\t\t\t  union power_supply_propval *val)\n{\n\tstruct wm831x_backup *devdata = dev_get_drvdata(psy->dev.parent);\n\tstruct wm831x *wm831x = devdata->wm831x;\n\tint ret = 0;\n\n\tret = wm831x_reg_read(wm831x, WM831X_BACKUP_CHARGER_CONTROL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tif (ret & WM831X_BKUP_CHG_STS)\n\t\t\tval->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\telse\n\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tret = wm831x_backup_read_voltage(wm831x, WM831X_AUX_BKUP_BATT,\n\t\t\t\t\t\tval);\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tif (ret & WM831X_BKUP_CHG_STS)\n\t\t\tval->intval = 1;\n\t\telse\n\t\t\tval->intval = 0;\n\t\tbreak;\n\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic enum power_supply_property wm831x_backup_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_PRESENT,\n};\n\n \n\nstatic int wm831x_backup_probe(struct platform_device *pdev)\n{\n\tstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\n\tstruct wm831x_pdata *wm831x_pdata = wm831x->dev->platform_data;\n\tstruct wm831x_backup *devdata;\n\n\tdevdata = devm_kzalloc(&pdev->dev, sizeof(struct wm831x_backup),\n\t\t\t\tGFP_KERNEL);\n\tif (devdata == NULL)\n\t\treturn -ENOMEM;\n\n\tdevdata->wm831x = wm831x;\n\tplatform_set_drvdata(pdev, devdata);\n\n\t \n\twm831x_config_backup(wm831x);\n\n\tif (wm831x_pdata && wm831x_pdata->wm831x_num)\n\t\tsnprintf(devdata->name, sizeof(devdata->name),\n\t\t\t \"wm831x-backup.%d\", wm831x_pdata->wm831x_num);\n\telse\n\t\tsnprintf(devdata->name, sizeof(devdata->name),\n\t\t\t \"wm831x-backup\");\n\n\tdevdata->backup_desc.name = devdata->name;\n\tdevdata->backup_desc.type = POWER_SUPPLY_TYPE_BATTERY;\n\tdevdata->backup_desc.properties = wm831x_backup_props;\n\tdevdata->backup_desc.num_properties = ARRAY_SIZE(wm831x_backup_props);\n\tdevdata->backup_desc.get_property = wm831x_backup_get_prop;\n\tdevdata->backup = power_supply_register(&pdev->dev,\n\t\t\t\t\t\t&devdata->backup_desc, NULL);\n\n\treturn PTR_ERR_OR_ZERO(devdata->backup);\n}\n\nstatic int wm831x_backup_remove(struct platform_device *pdev)\n{\n\tstruct wm831x_backup *devdata = platform_get_drvdata(pdev);\n\n\tpower_supply_unregister(devdata->backup);\n\n\treturn 0;\n}\n\nstatic struct platform_driver wm831x_backup_driver = {\n\t.probe = wm831x_backup_probe,\n\t.remove = wm831x_backup_remove,\n\t.driver = {\n\t\t.name = \"wm831x-backup\",\n\t},\n};\n\nmodule_platform_driver(wm831x_backup_driver);\n\nMODULE_DESCRIPTION(\"Backup battery charger driver for WM831x PMICs\");\nMODULE_AUTHOR(\"Mark Brown <broonie@opensource.wolfsonmicro.com>\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:wm831x-backup\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}