{
  "module_name": "test_power.c",
  "hash_id": "44fceda9954097e1c8bef2cad19542338573570136ab449a9e2fcaf976bf8aa2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/test_power.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/power_supply.h>\n#include <linux/errno.h>\n#include <linux/delay.h>\n#include <generated/utsrelease.h>\n\nenum test_power_id {\n\tTEST_AC,\n\tTEST_BATTERY,\n\tTEST_USB,\n\tTEST_POWER_NUM,\n};\n\nstatic int ac_online\t\t\t= 1;\nstatic int usb_online\t\t\t= 1;\nstatic int battery_status\t\t= POWER_SUPPLY_STATUS_DISCHARGING;\nstatic int battery_health\t\t= POWER_SUPPLY_HEALTH_GOOD;\nstatic int battery_present\t\t= 1;  \nstatic int battery_technology\t\t= POWER_SUPPLY_TECHNOLOGY_LION;\nstatic int battery_capacity\t\t= 50;\nstatic int battery_voltage\t\t= 3300;\nstatic int battery_charge_counter\t= -1000;\nstatic int battery_current\t\t= -1600;\n\nstatic bool module_initialized;\n\nstatic int test_power_get_ac_property(struct power_supply *psy,\n\t\t\t\t      enum power_supply_property psp,\n\t\t\t\t      union power_supply_propval *val)\n{\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = ac_online;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic int test_power_get_usb_property(struct power_supply *psy,\n\t\t\t\t      enum power_supply_property psp,\n\t\t\t\t      union power_supply_propval *val)\n{\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = usb_online;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic int test_power_get_battery_property(struct power_supply *psy,\n\t\t\t\t\t   enum power_supply_property psp,\n\t\t\t\t\t   union power_supply_propval *val)\n{\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_MODEL_NAME:\n\t\tval->strval = \"Test battery\";\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_MANUFACTURER:\n\t\tval->strval = \"Linux\";\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_SERIAL_NUMBER:\n\t\tval->strval = UTS_RELEASE;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tval->intval = battery_status;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_FAST;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tval->intval = battery_health;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tval->intval = battery_present;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tval->intval = battery_technology;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CAPACITY_LEVEL:\n\t\tval->intval = POWER_SUPPLY_CAPACITY_LEVEL_NORMAL;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CAPACITY:\n\tcase POWER_SUPPLY_PROP_CHARGE_NOW:\n\t\tval->intval = battery_capacity;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_COUNTER:\n\t\tval->intval = battery_charge_counter;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN:\n\tcase POWER_SUPPLY_PROP_CHARGE_FULL:\n\t\tval->intval = 100;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TIME_TO_EMPTY_AVG:\n\tcase POWER_SUPPLY_PROP_TIME_TO_FULL_NOW:\n\t\tval->intval = 3600;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TEMP:\n\t\tval->intval = 26;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tval->intval = battery_voltage;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_AVG:\n\tcase POWER_SUPPLY_PROP_CURRENT_NOW:\n\t\tval->intval = battery_current;\n\t\tbreak;\n\tdefault:\n\t\tpr_info(\"%s: some properties deliberately report errors.\\n\",\n\t\t\t__func__);\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic enum power_supply_property test_power_ac_props[] = {\n\tPOWER_SUPPLY_PROP_ONLINE,\n};\n\nstatic enum power_supply_property test_power_battery_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_CHARGE_TYPE,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL_DESIGN,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_CHARGE_COUNTER,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CAPACITY_LEVEL,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_AVG,\n\tPOWER_SUPPLY_PROP_TIME_TO_FULL_NOW,\n\tPOWER_SUPPLY_PROP_MODEL_NAME,\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n\tPOWER_SUPPLY_PROP_SERIAL_NUMBER,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_AVG,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n};\n\nstatic char *test_power_ac_supplied_to[] = {\n\t\"test_battery\",\n};\n\nstatic struct power_supply *test_power_supplies[TEST_POWER_NUM];\n\nstatic const struct power_supply_desc test_power_desc[] = {\n\t[TEST_AC] = {\n\t\t.name = \"test_ac\",\n\t\t.type = POWER_SUPPLY_TYPE_MAINS,\n\t\t.properties = test_power_ac_props,\n\t\t.num_properties = ARRAY_SIZE(test_power_ac_props),\n\t\t.get_property = test_power_get_ac_property,\n\t},\n\t[TEST_BATTERY] = {\n\t\t.name = \"test_battery\",\n\t\t.type = POWER_SUPPLY_TYPE_BATTERY,\n\t\t.properties = test_power_battery_props,\n\t\t.num_properties = ARRAY_SIZE(test_power_battery_props),\n\t\t.get_property = test_power_get_battery_property,\n\t},\n\t[TEST_USB] = {\n\t\t.name = \"test_usb\",\n\t\t.type = POWER_SUPPLY_TYPE_USB,\n\t\t.properties = test_power_ac_props,\n\t\t.num_properties = ARRAY_SIZE(test_power_ac_props),\n\t\t.get_property = test_power_get_usb_property,\n\t},\n};\n\nstatic const struct power_supply_config test_power_configs[] = {\n\t{\n\t\t \n\t\t.supplied_to = test_power_ac_supplied_to,\n\t\t.num_supplicants = ARRAY_SIZE(test_power_ac_supplied_to),\n\t}, {\n\t\t \n\t}, {\n\t\t \n\t\t.supplied_to = test_power_ac_supplied_to,\n\t\t.num_supplicants = ARRAY_SIZE(test_power_ac_supplied_to),\n\t},\n};\n\nstatic int __init test_power_init(void)\n{\n\tint i;\n\tint ret;\n\n\tBUILD_BUG_ON(TEST_POWER_NUM != ARRAY_SIZE(test_power_supplies));\n\tBUILD_BUG_ON(TEST_POWER_NUM != ARRAY_SIZE(test_power_configs));\n\n\tfor (i = 0; i < ARRAY_SIZE(test_power_supplies); i++) {\n\t\ttest_power_supplies[i] = power_supply_register(NULL,\n\t\t\t\t\t\t&test_power_desc[i],\n\t\t\t\t\t\t&test_power_configs[i]);\n\t\tif (IS_ERR(test_power_supplies[i])) {\n\t\t\tpr_err(\"%s: failed to register %s\\n\", __func__,\n\t\t\t\ttest_power_desc[i].name);\n\t\t\tret = PTR_ERR(test_power_supplies[i]);\n\t\t\tgoto failed;\n\t\t}\n\t}\n\n\tmodule_initialized = true;\n\treturn 0;\nfailed:\n\twhile (--i >= 0)\n\t\tpower_supply_unregister(test_power_supplies[i]);\n\treturn ret;\n}\nmodule_init(test_power_init);\n\nstatic void __exit test_power_exit(void)\n{\n\tint i;\n\n\t \n\tac_online = 0;\n\tusb_online = 0;\n\tbattery_status = POWER_SUPPLY_STATUS_DISCHARGING;\n\tfor (i = 0; i < ARRAY_SIZE(test_power_supplies); i++)\n\t\tpower_supply_changed(test_power_supplies[i]);\n\tpr_info(\"%s: 'changed' event sent, sleeping for 10 seconds...\\n\",\n\t\t__func__);\n\tssleep(10);\n\n\tfor (i = 0; i < ARRAY_SIZE(test_power_supplies); i++)\n\t\tpower_supply_unregister(test_power_supplies[i]);\n\n\tmodule_initialized = false;\n}\nmodule_exit(test_power_exit);\n\n\n\n#define MAX_KEYLENGTH 256\nstruct battery_property_map {\n\tint value;\n\tchar const *key;\n};\n\nstatic struct battery_property_map map_ac_online[] = {\n\t{ 0,  \"off\"  },\n\t{ 1,  \"on\" },\n\t{ -1, NULL  },\n};\n\nstatic struct battery_property_map map_status[] = {\n\t{ POWER_SUPPLY_STATUS_CHARGING,     \"charging\"     },\n\t{ POWER_SUPPLY_STATUS_DISCHARGING,  \"discharging\"  },\n\t{ POWER_SUPPLY_STATUS_NOT_CHARGING, \"not-charging\" },\n\t{ POWER_SUPPLY_STATUS_FULL,         \"full\"         },\n\t{ -1,                               NULL           },\n};\n\nstatic struct battery_property_map map_health[] = {\n\t{ POWER_SUPPLY_HEALTH_GOOD,           \"good\"        },\n\t{ POWER_SUPPLY_HEALTH_OVERHEAT,       \"overheat\"    },\n\t{ POWER_SUPPLY_HEALTH_DEAD,           \"dead\"        },\n\t{ POWER_SUPPLY_HEALTH_OVERVOLTAGE,    \"overvoltage\" },\n\t{ POWER_SUPPLY_HEALTH_UNSPEC_FAILURE, \"failure\"     },\n\t{ -1,                                 NULL          },\n};\n\nstatic struct battery_property_map map_present[] = {\n\t{ 0,  \"false\" },\n\t{ 1,  \"true\"  },\n\t{ -1, NULL    },\n};\n\nstatic struct battery_property_map map_technology[] = {\n\t{ POWER_SUPPLY_TECHNOLOGY_NiMH, \"NiMH\" },\n\t{ POWER_SUPPLY_TECHNOLOGY_LION, \"LION\" },\n\t{ POWER_SUPPLY_TECHNOLOGY_LIPO, \"LIPO\" },\n\t{ POWER_SUPPLY_TECHNOLOGY_LiFe, \"LiFe\" },\n\t{ POWER_SUPPLY_TECHNOLOGY_NiCd, \"NiCd\" },\n\t{ POWER_SUPPLY_TECHNOLOGY_LiMn, \"LiMn\" },\n\t{ -1,\t\t\t\tNULL   },\n};\n\n\nstatic int map_get_value(struct battery_property_map *map, const char *key,\n\t\t\t\tint def_val)\n{\n\tchar buf[MAX_KEYLENGTH];\n\tint cr;\n\n\tstrscpy(buf, key, MAX_KEYLENGTH);\n\n\tcr = strnlen(buf, MAX_KEYLENGTH) - 1;\n\tif (cr < 0)\n\t\treturn def_val;\n\tif (buf[cr] == '\\n')\n\t\tbuf[cr] = '\\0';\n\n\twhile (map->key) {\n\t\tif (strncasecmp(map->key, buf, MAX_KEYLENGTH) == 0)\n\t\t\treturn map->value;\n\t\tmap++;\n\t}\n\n\treturn def_val;\n}\n\n\nstatic const char *map_get_key(struct battery_property_map *map, int value,\n\t\t\t\tconst char *def_key)\n{\n\twhile (map->key) {\n\t\tif (map->value == value)\n\t\t\treturn map->key;\n\t\tmap++;\n\t}\n\n\treturn def_key;\n}\n\nstatic inline void signal_power_supply_changed(struct power_supply *psy)\n{\n\tif (module_initialized)\n\t\tpower_supply_changed(psy);\n}\n\nstatic int param_set_ac_online(const char *key, const struct kernel_param *kp)\n{\n\tac_online = map_get_value(map_ac_online, key, ac_online);\n\tsignal_power_supply_changed(test_power_supplies[TEST_AC]);\n\treturn 0;\n}\n\nstatic int param_get_ac_online(char *buffer, const struct kernel_param *kp)\n{\n\treturn sprintf(buffer, \"%s\\n\",\n\t\t\tmap_get_key(map_ac_online, ac_online, \"unknown\"));\n}\n\nstatic int param_set_usb_online(const char *key, const struct kernel_param *kp)\n{\n\tusb_online = map_get_value(map_ac_online, key, usb_online);\n\tsignal_power_supply_changed(test_power_supplies[TEST_USB]);\n\treturn 0;\n}\n\nstatic int param_get_usb_online(char *buffer, const struct kernel_param *kp)\n{\n\treturn sprintf(buffer, \"%s\\n\",\n\t\t\tmap_get_key(map_ac_online, usb_online, \"unknown\"));\n}\n\nstatic int param_set_battery_status(const char *key,\n\t\t\t\t\tconst struct kernel_param *kp)\n{\n\tbattery_status = map_get_value(map_status, key, battery_status);\n\tsignal_power_supply_changed(test_power_supplies[TEST_BATTERY]);\n\treturn 0;\n}\n\nstatic int param_get_battery_status(char *buffer, const struct kernel_param *kp)\n{\n\treturn sprintf(buffer, \"%s\\n\",\n\t\t\tmap_get_key(map_ac_online, battery_status, \"unknown\"));\n}\n\nstatic int param_set_battery_health(const char *key,\n\t\t\t\t\tconst struct kernel_param *kp)\n{\n\tbattery_health = map_get_value(map_health, key, battery_health);\n\tsignal_power_supply_changed(test_power_supplies[TEST_BATTERY]);\n\treturn 0;\n}\n\nstatic int param_get_battery_health(char *buffer, const struct kernel_param *kp)\n{\n\treturn sprintf(buffer, \"%s\\n\",\n\t\t\tmap_get_key(map_ac_online, battery_health, \"unknown\"));\n}\n\nstatic int param_set_battery_present(const char *key,\n\t\t\t\t\tconst struct kernel_param *kp)\n{\n\tbattery_present = map_get_value(map_present, key, battery_present);\n\tsignal_power_supply_changed(test_power_supplies[TEST_AC]);\n\treturn 0;\n}\n\nstatic int param_get_battery_present(char *buffer,\n\t\t\t\t\tconst struct kernel_param *kp)\n{\n\treturn sprintf(buffer, \"%s\\n\",\n\t\t\tmap_get_key(map_ac_online, battery_present, \"unknown\"));\n}\n\nstatic int param_set_battery_technology(const char *key,\n\t\t\t\t\tconst struct kernel_param *kp)\n{\n\tbattery_technology = map_get_value(map_technology, key,\n\t\t\t\t\t\tbattery_technology);\n\tsignal_power_supply_changed(test_power_supplies[TEST_BATTERY]);\n\treturn 0;\n}\n\nstatic int param_get_battery_technology(char *buffer,\n\t\t\t\t\tconst struct kernel_param *kp)\n{\n\treturn sprintf(buffer, \"%s\\n\",\n\t\t\tmap_get_key(map_ac_online, battery_technology,\n\t\t\t\t\t\"unknown\"));\n}\n\nstatic int param_set_battery_capacity(const char *key,\n\t\t\t\t\tconst struct kernel_param *kp)\n{\n\tint tmp;\n\n\tif (1 != sscanf(key, \"%d\", &tmp))\n\t\treturn -EINVAL;\n\n\tbattery_capacity = tmp;\n\tsignal_power_supply_changed(test_power_supplies[TEST_BATTERY]);\n\treturn 0;\n}\n\n#define param_get_battery_capacity param_get_int\n\nstatic int param_set_battery_voltage(const char *key,\n\t\t\t\t\tconst struct kernel_param *kp)\n{\n\tint tmp;\n\n\tif (1 != sscanf(key, \"%d\", &tmp))\n\t\treturn -EINVAL;\n\n\tbattery_voltage = tmp;\n\tsignal_power_supply_changed(test_power_supplies[TEST_BATTERY]);\n\treturn 0;\n}\n\n#define param_get_battery_voltage param_get_int\n\nstatic int param_set_battery_charge_counter(const char *key,\n\t\t\t\t\tconst struct kernel_param *kp)\n{\n\tint tmp;\n\n\tif (1 != sscanf(key, \"%d\", &tmp))\n\t\treturn -EINVAL;\n\n\tbattery_charge_counter = tmp;\n\tsignal_power_supply_changed(test_power_supplies[TEST_BATTERY]);\n\treturn 0;\n}\n\n#define param_get_battery_charge_counter param_get_int\n\nstatic int param_set_battery_current(const char *key,\n\t\t\t\t\tconst struct kernel_param *kp)\n{\n\tint tmp;\n\n\tif (1 != sscanf(key, \"%d\", &tmp))\n\t\treturn -EINVAL;\n\n\tbattery_current = tmp;\n\tsignal_power_supply_changed(test_power_supplies[TEST_BATTERY]);\n\treturn 0;\n}\n\n#define param_get_battery_current param_get_int\n\nstatic const struct kernel_param_ops param_ops_ac_online = {\n\t.set = param_set_ac_online,\n\t.get = param_get_ac_online,\n};\n\nstatic const struct kernel_param_ops param_ops_usb_online = {\n\t.set = param_set_usb_online,\n\t.get = param_get_usb_online,\n};\n\nstatic const struct kernel_param_ops param_ops_battery_status = {\n\t.set = param_set_battery_status,\n\t.get = param_get_battery_status,\n};\n\nstatic const struct kernel_param_ops param_ops_battery_present = {\n\t.set = param_set_battery_present,\n\t.get = param_get_battery_present,\n};\n\nstatic const struct kernel_param_ops param_ops_battery_technology = {\n\t.set = param_set_battery_technology,\n\t.get = param_get_battery_technology,\n};\n\nstatic const struct kernel_param_ops param_ops_battery_health = {\n\t.set = param_set_battery_health,\n\t.get = param_get_battery_health,\n};\n\nstatic const struct kernel_param_ops param_ops_battery_capacity = {\n\t.set = param_set_battery_capacity,\n\t.get = param_get_battery_capacity,\n};\n\nstatic const struct kernel_param_ops param_ops_battery_voltage = {\n\t.set = param_set_battery_voltage,\n\t.get = param_get_battery_voltage,\n};\n\nstatic const struct kernel_param_ops param_ops_battery_charge_counter = {\n\t.set = param_set_battery_charge_counter,\n\t.get = param_get_battery_charge_counter,\n};\n\nstatic const struct kernel_param_ops param_ops_battery_current = {\n\t.set = param_set_battery_current,\n\t.get = param_get_battery_current,\n};\n\n#define param_check_ac_online(name, p) __param_check(name, p, void);\n#define param_check_usb_online(name, p) __param_check(name, p, void);\n#define param_check_battery_status(name, p) __param_check(name, p, void);\n#define param_check_battery_present(name, p) __param_check(name, p, void);\n#define param_check_battery_technology(name, p) __param_check(name, p, void);\n#define param_check_battery_health(name, p) __param_check(name, p, void);\n#define param_check_battery_capacity(name, p) __param_check(name, p, void);\n#define param_check_battery_voltage(name, p) __param_check(name, p, void);\n#define param_check_battery_charge_counter(name, p) __param_check(name, p, void);\n#define param_check_battery_current(name, p) __param_check(name, p, void);\n\n\nmodule_param(ac_online, ac_online, 0644);\nMODULE_PARM_DESC(ac_online, \"AC charging state <on|off>\");\n\nmodule_param(usb_online, usb_online, 0644);\nMODULE_PARM_DESC(usb_online, \"USB charging state <on|off>\");\n\nmodule_param(battery_status, battery_status, 0644);\nMODULE_PARM_DESC(battery_status,\n\t\"battery status <charging|discharging|not-charging|full>\");\n\nmodule_param(battery_present, battery_present, 0644);\nMODULE_PARM_DESC(battery_present,\n\t\"battery presence state <good|overheat|dead|overvoltage|failure>\");\n\nmodule_param(battery_technology, battery_technology, 0644);\nMODULE_PARM_DESC(battery_technology,\n\t\"battery technology <NiMH|LION|LIPO|LiFe|NiCd|LiMn>\");\n\nmodule_param(battery_health, battery_health, 0644);\nMODULE_PARM_DESC(battery_health,\n\t\"battery health state <good|overheat|dead|overvoltage|failure>\");\n\nmodule_param(battery_capacity, battery_capacity, 0644);\nMODULE_PARM_DESC(battery_capacity, \"battery capacity (percentage)\");\n\nmodule_param(battery_voltage, battery_voltage, 0644);\nMODULE_PARM_DESC(battery_voltage, \"battery voltage (millivolts)\");\n\nmodule_param(battery_charge_counter, battery_charge_counter, 0644);\nMODULE_PARM_DESC(battery_charge_counter,\n\t\"battery charge counter (microampere-hours)\");\n\nmodule_param(battery_current, battery_current, 0644);\nMODULE_PARM_DESC(battery_current, \"battery current (milliampere)\");\n\nMODULE_DESCRIPTION(\"Power supply driver for testing\");\nMODULE_AUTHOR(\"Anton Vorontsov <cbouatmailru@gmail.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}