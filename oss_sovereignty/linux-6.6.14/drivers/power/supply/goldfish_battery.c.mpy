{
  "module_name": "goldfish_battery.c",
  "hash_id": "2bdbfcbf6491ffd19473c1b76d8677cf26d29c163a3fbe17b1cf47393d95ab62",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/goldfish_battery.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/types.h>\n#include <linux/pci.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/acpi.h>\n\nstruct goldfish_battery_data {\n\tvoid __iomem *reg_base;\n\tint irq;\n\tspinlock_t lock;\n\n\tstruct power_supply *battery;\n\tstruct power_supply *ac;\n};\n\n#define GOLDFISH_BATTERY_READ(data, addr) \\\n\t(readl(data->reg_base + addr))\n#define GOLDFISH_BATTERY_WRITE(data, addr, x) \\\n\t(writel(x, data->reg_base + addr))\n\nenum {\n\t \n\tBATTERY_INT_STATUS\t= 0x00,\n\t \n\tBATTERY_INT_ENABLE\t= 0x04,\n\n\tBATTERY_AC_ONLINE\t= 0x08,\n\tBATTERY_STATUS\t\t= 0x0C,\n\tBATTERY_HEALTH\t\t= 0x10,\n\tBATTERY_PRESENT\t\t= 0x14,\n\tBATTERY_CAPACITY\t= 0x18,\n\tBATTERY_VOLTAGE\t\t= 0x1C,\n\tBATTERY_TEMP\t\t= 0x20,\n\tBATTERY_CHARGE_COUNTER\t= 0x24,\n\tBATTERY_VOLTAGE_MAX\t= 0x28,\n\tBATTERY_CURRENT_MAX\t= 0x2C,\n\tBATTERY_CURRENT_NOW\t= 0x30,\n\tBATTERY_CURRENT_AVG\t= 0x34,\n\tBATTERY_CHARGE_FULL_UAH\t= 0x38,\n\tBATTERY_CYCLE_COUNT\t= 0x40,\n\n\tBATTERY_STATUS_CHANGED\t= 1U << 0,\n\tAC_STATUS_CHANGED\t= 1U << 1,\n\tBATTERY_INT_MASK\t= BATTERY_STATUS_CHANGED | AC_STATUS_CHANGED,\n};\n\n\nstatic int goldfish_ac_get_property(struct power_supply *psy,\n\t\t\tenum power_supply_property psp,\n\t\t\tunion power_supply_propval *val)\n{\n\tstruct goldfish_battery_data *data = power_supply_get_drvdata(psy);\n\tint ret = 0;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_AC_ONLINE);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MAX:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_VOLTAGE_MAX);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_MAX:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_CURRENT_MAX);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic int goldfish_battery_get_property(struct power_supply *psy,\n\t\t\t\t enum power_supply_property psp,\n\t\t\t\t union power_supply_propval *val)\n{\n\tstruct goldfish_battery_data *data = power_supply_get_drvdata(psy);\n\tint ret = 0;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_STATUS);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_HEALTH);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_PRESENT);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CAPACITY:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_CAPACITY);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_VOLTAGE);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TEMP:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_TEMP);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_COUNTER:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data,\n\t\t\t\t\t\t    BATTERY_CHARGE_COUNTER);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_NOW:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_CURRENT_NOW);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_AVG:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_CURRENT_AVG);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_FULL:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data,\n\t\t\t\t\t\t    BATTERY_CHARGE_FULL_UAH);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CYCLE_COUNT:\n\t\tval->intval = GOLDFISH_BATTERY_READ(data, BATTERY_CYCLE_COUNT);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic enum power_supply_property goldfish_battery_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_CHARGE_COUNTER,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_AVG,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CYCLE_COUNT,\n};\n\nstatic enum power_supply_property goldfish_ac_props[] = {\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX,\n\tPOWER_SUPPLY_PROP_CURRENT_MAX,\n};\n\nstatic irqreturn_t goldfish_battery_interrupt(int irq, void *dev_id)\n{\n\tunsigned long irq_flags;\n\tstruct goldfish_battery_data *data = dev_id;\n\tuint32_t status;\n\n\tspin_lock_irqsave(&data->lock, irq_flags);\n\n\t \n\tstatus = GOLDFISH_BATTERY_READ(data, BATTERY_INT_STATUS);\n\tstatus &= BATTERY_INT_MASK;\n\n\tif (status & BATTERY_STATUS_CHANGED)\n\t\tpower_supply_changed(data->battery);\n\tif (status & AC_STATUS_CHANGED)\n\t\tpower_supply_changed(data->ac);\n\n\tspin_unlock_irqrestore(&data->lock, irq_flags);\n\treturn status ? IRQ_HANDLED : IRQ_NONE;\n}\n\nstatic const struct power_supply_desc battery_desc = {\n\t.properties\t= goldfish_battery_props,\n\t.num_properties\t= ARRAY_SIZE(goldfish_battery_props),\n\t.get_property\t= goldfish_battery_get_property,\n\t.name\t\t= \"battery\",\n\t.type\t\t= POWER_SUPPLY_TYPE_BATTERY,\n};\n\nstatic const struct power_supply_desc ac_desc = {\n\t.properties\t= goldfish_ac_props,\n\t.num_properties\t= ARRAY_SIZE(goldfish_ac_props),\n\t.get_property\t= goldfish_ac_get_property,\n\t.name\t\t= \"ac\",\n\t.type\t\t= POWER_SUPPLY_TYPE_MAINS,\n};\n\nstatic int goldfish_battery_probe(struct platform_device *pdev)\n{\n\tint ret;\n\tstruct resource *r;\n\tstruct goldfish_battery_data *data;\n\tstruct power_supply_config psy_cfg = {};\n\n\tdata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\n\tif (data == NULL)\n\t\treturn -ENOMEM;\n\n\tspin_lock_init(&data->lock);\n\n\tr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (r == NULL) {\n\t\tdev_err(&pdev->dev, \"platform_get_resource failed\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tdata->reg_base = devm_ioremap(&pdev->dev, r->start, resource_size(r));\n\tif (data->reg_base == NULL) {\n\t\tdev_err(&pdev->dev, \"unable to remap MMIO\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tdata->irq = platform_get_irq(pdev, 0);\n\tif (data->irq < 0)\n\t\treturn -ENODEV;\n\n\tret = devm_request_irq(&pdev->dev, data->irq,\n\t\t\t       goldfish_battery_interrupt,\n\t\t\t       IRQF_SHARED, pdev->name, data);\n\tif (ret)\n\t\treturn ret;\n\n\tpsy_cfg.drv_data = data;\n\n\tdata->ac = power_supply_register(&pdev->dev, &ac_desc, &psy_cfg);\n\tif (IS_ERR(data->ac))\n\t\treturn PTR_ERR(data->ac);\n\n\tdata->battery = power_supply_register(&pdev->dev, &battery_desc,\n\t\t\t\t\t\t&psy_cfg);\n\tif (IS_ERR(data->battery)) {\n\t\tpower_supply_unregister(data->ac);\n\t\treturn PTR_ERR(data->battery);\n\t}\n\n\tplatform_set_drvdata(pdev, data);\n\n\tGOLDFISH_BATTERY_WRITE(data, BATTERY_INT_ENABLE, BATTERY_INT_MASK);\n\treturn 0;\n}\n\nstatic int goldfish_battery_remove(struct platform_device *pdev)\n{\n\tstruct goldfish_battery_data *data = platform_get_drvdata(pdev);\n\n\tpower_supply_unregister(data->battery);\n\tpower_supply_unregister(data->ac);\n\treturn 0;\n}\n\nstatic const struct of_device_id goldfish_battery_of_match[] = {\n\t{ .compatible = \"google,goldfish-battery\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, goldfish_battery_of_match);\n\n#ifdef CONFIG_ACPI\nstatic const struct acpi_device_id goldfish_battery_acpi_match[] = {\n\t{ \"GFSH0001\", 0 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(acpi, goldfish_battery_acpi_match);\n#endif\n\nstatic struct platform_driver goldfish_battery_device = {\n\t.probe\t\t= goldfish_battery_probe,\n\t.remove\t\t= goldfish_battery_remove,\n\t.driver = {\n\t\t.name = \"goldfish-battery\",\n\t\t.of_match_table = goldfish_battery_of_match,\n\t\t.acpi_match_table = ACPI_PTR(goldfish_battery_acpi_match),\n\t}\n};\nmodule_platform_driver(goldfish_battery_device);\n\nMODULE_AUTHOR(\"Mike Lockwood lockwood@android.com\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"Battery driver for the Goldfish emulator\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}