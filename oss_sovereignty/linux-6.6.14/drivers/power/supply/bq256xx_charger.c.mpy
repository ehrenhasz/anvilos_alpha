{
  "module_name": "bq256xx_charger.c",
  "hash_id": "cd3875de494d4251c6d42448d975a71ab1a4cc0dd1465b1c9d81395723c39485",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/bq256xx_charger.c",
  "human_readable_source": "\n\n\n\n#include <linux/err.h>\n#include <linux/i2c.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/gpio/consumer.h>\n#include <linux/power_supply.h>\n#include <linux/regmap.h>\n#include <linux/types.h>\n#include <linux/usb/phy.h>\n#include <linux/device.h>\n#include <linux/moduleparam.h>\n#include <linux/slab.h>\n#include <linux/acpi.h>\n\n#define BQ256XX_MANUFACTURER \"Texas Instruments\"\n\n#define BQ256XX_INPUT_CURRENT_LIMIT\t\t0x00\n#define BQ256XX_CHARGER_CONTROL_0\t\t0x01\n#define BQ256XX_CHARGE_CURRENT_LIMIT\t\t0x02\n#define BQ256XX_PRECHG_AND_TERM_CURR_LIM\t0x03\n#define BQ256XX_BATTERY_VOLTAGE_LIMIT\t\t0x04\n#define BQ256XX_CHARGER_CONTROL_1\t\t0x05\n#define BQ256XX_CHARGER_CONTROL_2\t\t0x06\n#define BQ256XX_CHARGER_CONTROL_3\t\t0x07\n#define BQ256XX_CHARGER_STATUS_0\t\t0x08\n#define BQ256XX_CHARGER_STATUS_1\t\t0x09\n#define BQ256XX_CHARGER_STATUS_2\t\t0x0a\n#define BQ256XX_PART_INFORMATION\t\t0x0b\n#define BQ256XX_CHARGER_CONTROL_4\t\t0x0c\n\n#define BQ256XX_IINDPM_MASK\t\tGENMASK(4, 0)\n#define BQ256XX_IINDPM_STEP_uA\t\t100000\n#define BQ256XX_IINDPM_OFFSET_uA\t100000\n#define BQ256XX_IINDPM_MIN_uA\t\t100000\n#define BQ256XX_IINDPM_MAX_uA\t\t3200000\n#define BQ256XX_IINDPM_DEF_uA\t\t2400000\n\n#define BQ256XX_TS_IGNORE\t\tBIT(6)\n#define BQ256XX_TS_IGNORE_SHIFT\t\t6\n\n#define BQ256XX_VINDPM_MASK\t\tGENMASK(3, 0)\n#define BQ256XX_VINDPM_STEP_uV\t\t100000\n#define BQ256XX_VINDPM_OFFSET_uV\t3900000\n#define BQ256XX_VINDPM_MIN_uV\t\t3900000\n#define BQ256XX_VINDPM_MAX_uV\t\t5400000\n#define BQ256XX_VINDPM_DEF_uV\t\t4500000\n\n#define BQ256XX_VBATREG_MASK\t\tGENMASK(7, 3)\n#define BQ2560X_VBATREG_STEP_uV\t\t32000\n#define BQ2560X_VBATREG_OFFSET_uV\t3856000\n#define BQ2560X_VBATREG_MIN_uV\t\t3856000\n#define BQ2560X_VBATREG_MAX_uV\t\t4624000\n#define BQ2560X_VBATREG_DEF_uV\t\t4208000\n#define BQ25601D_VBATREG_OFFSET_uV\t3847000\n#define BQ25601D_VBATREG_MIN_uV\t\t3847000\n#define BQ25601D_VBATREG_MAX_uV\t\t4615000\n#define BQ25601D_VBATREG_DEF_uV\t\t4199000\n#define BQ2561X_VBATREG_STEP_uV\t\t10000\n#define BQ25611D_VBATREG_MIN_uV\t\t3494000\n#define BQ25611D_VBATREG_MAX_uV\t\t4510000\n#define BQ25611D_VBATREG_DEF_uV\t\t4190000\n#define BQ25618_VBATREG_MIN_uV\t\t3504000\n#define BQ25618_VBATREG_MAX_uV\t\t4500000\n#define BQ25618_VBATREG_DEF_uV\t\t4200000\n#define BQ256XX_VBATREG_BIT_SHIFT\t3\n#define BQ2561X_VBATREG_THRESH\t\t0x8\n#define BQ25611D_VBATREG_THRESH_uV\t4290000\n#define BQ25618_VBATREG_THRESH_uV\t4300000\n\n#define BQ256XX_CHG_CONFIG_MASK\t\tBIT(4)\n#define BQ256XX_CHG_CONFIG_BIT_SHIFT\t4\n\n#define BQ256XX_ITERM_MASK\t\tGENMASK(3, 0)\n#define BQ256XX_ITERM_STEP_uA\t\t60000\n#define BQ256XX_ITERM_OFFSET_uA\t\t60000\n#define BQ256XX_ITERM_MIN_uA\t\t60000\n#define BQ256XX_ITERM_MAX_uA\t\t780000\n#define BQ256XX_ITERM_DEF_uA\t\t180000\n#define BQ25618_ITERM_STEP_uA\t\t20000\n#define BQ25618_ITERM_OFFSET_uA\t\t20000\n#define BQ25618_ITERM_MIN_uA\t\t20000\n#define BQ25618_ITERM_MAX_uA\t\t260000\n#define BQ25618_ITERM_DEF_uA\t\t60000\n\n#define BQ256XX_IPRECHG_MASK\t\tGENMASK(7, 4)\n#define BQ256XX_IPRECHG_STEP_uA\t\t60000\n#define BQ256XX_IPRECHG_OFFSET_uA\t60000\n#define BQ256XX_IPRECHG_MIN_uA\t\t60000\n#define BQ256XX_IPRECHG_MAX_uA\t\t780000\n#define BQ256XX_IPRECHG_DEF_uA\t\t180000\n#define BQ25618_IPRECHG_STEP_uA\t\t20000\n#define BQ25618_IPRECHG_OFFSET_uA\t20000\n#define BQ25618_IPRECHG_MIN_uA\t\t20000\n#define BQ25618_IPRECHG_MAX_uA\t\t260000\n#define BQ25618_IPRECHG_DEF_uA\t\t40000\n#define BQ256XX_IPRECHG_BIT_SHIFT\t4\n\n#define BQ256XX_ICHG_MASK\t\tGENMASK(5, 0)\n#define BQ256XX_ICHG_STEP_uA\t\t60000\n#define BQ256XX_ICHG_MIN_uA\t\t0\n#define BQ256XX_ICHG_MAX_uA\t\t3000000\n#define BQ2560X_ICHG_DEF_uA\t\t2040000\n#define BQ25611D_ICHG_DEF_uA\t\t1020000\n#define BQ25618_ICHG_STEP_uA\t\t20000\n#define BQ25618_ICHG_MIN_uA\t\t0\n#define BQ25618_ICHG_MAX_uA\t\t1500000\n#define BQ25618_ICHG_DEF_uA\t\t340000\n#define BQ25618_ICHG_THRESH\t\t0x3c\n#define BQ25618_ICHG_THRESH_uA\t\t1180000\n\n#define BQ256XX_VBUS_STAT_MASK\t\tGENMASK(7, 5)\n#define BQ256XX_VBUS_STAT_NO_INPUT\t0\n#define BQ256XX_VBUS_STAT_USB_SDP\tBIT(5)\n#define BQ256XX_VBUS_STAT_USB_CDP\tBIT(6)\n#define BQ256XX_VBUS_STAT_USB_DCP\t(BIT(6) | BIT(5))\n#define BQ256XX_VBUS_STAT_USB_OTG\t(BIT(7) | BIT(6) | BIT(5))\n\n#define BQ256XX_CHRG_STAT_MASK\t\tGENMASK(4, 3)\n#define BQ256XX_CHRG_STAT_NOT_CHRGING\t0\n#define BQ256XX_CHRG_STAT_PRECHRGING\tBIT(3)\n#define BQ256XX_CHRG_STAT_FAST_CHRGING\tBIT(4)\n#define BQ256XX_CHRG_STAT_CHRG_TERM\t(BIT(4) | BIT(3))\n\n#define BQ256XX_PG_STAT_MASK\t\tBIT(2)\n#define BQ256XX_WDT_FAULT_MASK\t\tBIT(7)\n#define BQ256XX_CHRG_FAULT_MASK\t\tGENMASK(5, 4)\n#define BQ256XX_CHRG_FAULT_NORMAL\t0\n#define BQ256XX_CHRG_FAULT_INPUT\tBIT(4)\n#define BQ256XX_CHRG_FAULT_THERM\tBIT(5)\n#define BQ256XX_CHRG_FAULT_CST_EXPIRE\t(BIT(5) | BIT(4))\n#define BQ256XX_BAT_FAULT_MASK\t\tBIT(3)\n#define BQ256XX_NTC_FAULT_MASK\t\tGENMASK(2, 0)\n#define BQ256XX_NTC_FAULT_WARM\t\tBIT(1)\n#define BQ256XX_NTC_FAULT_COOL\t\t(BIT(1) | BIT(0))\n#define BQ256XX_NTC_FAULT_COLD\t\t(BIT(2) | BIT(0))\n#define BQ256XX_NTC_FAULT_HOT\t\t(BIT(2) | BIT(1))\n\n#define BQ256XX_NUM_WD_VAL\t4\n#define BQ256XX_WATCHDOG_MASK\tGENMASK(5, 4)\n#define BQ256XX_WATCHDOG_MAX\t1600000\n#define BQ256XX_WATCHDOG_DIS\t0\n#define BQ256XX_WDT_BIT_SHIFT\t4\n\n#define BQ256XX_REG_RST\t\tBIT(7)\n\n \nstruct bq256xx_init_data {\n\tu32 ichg;\n\tu32 iindpm;\n\tu32 vbatreg;\n\tu32 iterm;\n\tu32 iprechg;\n\tu32 vindpm;\n\tu32 ichg_max;\n\tu32 vbatreg_max;\n\tbool ts_ignore;\n};\n\n \nstruct bq256xx_state {\n\tu8 vbus_stat;\n\tu8 chrg_stat;\n\tbool online;\n\n\tu8 wdt_fault;\n\tu8 bat_fault;\n\tu8 chrg_fault;\n\tu8 ntc_fault;\n};\n\nenum bq256xx_id {\n\tBQ25600,\n\tBQ25600D,\n\tBQ25601,\n\tBQ25601D,\n\tBQ25618,\n\tBQ25619,\n\tBQ25611D,\n};\n\n \nstruct bq256xx_device {\n\tstruct i2c_client *client;\n\tstruct device *dev;\n\tstruct power_supply *charger;\n\tstruct power_supply *battery;\n\tstruct mutex lock;\n\tstruct regmap *regmap;\n\n\tstruct usb_phy *usb2_phy;\n\tstruct usb_phy *usb3_phy;\n\tstruct notifier_block usb_nb;\n\tstruct work_struct usb_work;\n\tunsigned long usb_event;\n\n\tchar model_name[I2C_NAME_SIZE];\n\n\tstruct bq256xx_init_data init_data;\n\tconst struct bq256xx_chip_info *chip_info;\n\tstruct bq256xx_state state;\n\tint watchdog_timer;\n};\n\n \nstruct bq256xx_chip_info {\n\tint model_id;\n\n\tconst struct regmap_config *bq256xx_regmap_config;\n\n\tint (*bq256xx_get_ichg)(struct bq256xx_device *bq);\n\tint (*bq256xx_get_iindpm)(struct bq256xx_device *bq);\n\tint (*bq256xx_get_vbatreg)(struct bq256xx_device *bq);\n\tint (*bq256xx_get_iterm)(struct bq256xx_device *bq);\n\tint (*bq256xx_get_iprechg)(struct bq256xx_device *bq);\n\tint (*bq256xx_get_vindpm)(struct bq256xx_device *bq);\n\n\tint (*bq256xx_set_ichg)(struct bq256xx_device *bq, int ichg);\n\tint (*bq256xx_set_iindpm)(struct bq256xx_device *bq, int iindpm);\n\tint (*bq256xx_set_vbatreg)(struct bq256xx_device *bq, int vbatreg);\n\tint (*bq256xx_set_iterm)(struct bq256xx_device *bq, int iterm);\n\tint (*bq256xx_set_iprechg)(struct bq256xx_device *bq, int iprechg);\n\tint (*bq256xx_set_vindpm)(struct bq256xx_device *bq, int vindpm);\n\tint (*bq256xx_set_charge_type)(struct bq256xx_device *bq, int type);\n\tint (*bq256xx_set_ts_ignore)(struct bq256xx_device *bq, bool ts_ignore);\n\n\tint bq256xx_def_ichg;\n\tint bq256xx_def_iindpm;\n\tint bq256xx_def_vbatreg;\n\tint bq256xx_def_iterm;\n\tint bq256xx_def_iprechg;\n\tint bq256xx_def_vindpm;\n\n\tint bq256xx_max_ichg;\n\tint bq256xx_max_vbatreg;\n\n\tbool has_usb_detect;\n};\n\nstatic int bq256xx_watchdog_time[BQ256XX_NUM_WD_VAL] = {\n\t0, 40000, 80000, 1600000\n};\n\nstatic const int bq25611d_vbatreg_values[] = {\n\t3494000, 3590000, 3686000, 3790000, 3894000, 3990000, 4090000, 4140000,\n\t4190000\n};\n\nstatic const int bq25618_619_vbatreg_values[] = {\n\t3504000, 3600000, 3696000, 3800000, 3904000, 4000000, 4100000, 4150000,\n\t4200000\n};\n\nstatic const int bq25618_619_ichg_values[] = {\n\t1290000, 1360000, 1430000, 1500000\n};\n\nstatic enum power_supply_usb_type bq256xx_usb_type[] = {\n\tPOWER_SUPPLY_USB_TYPE_SDP,\n\tPOWER_SUPPLY_USB_TYPE_CDP,\n\tPOWER_SUPPLY_USB_TYPE_DCP,\n\tPOWER_SUPPLY_USB_TYPE_UNKNOWN,\n\tPOWER_SUPPLY_USB_TYPE_ACA,\n};\n\nstatic int bq256xx_array_parse(int array_size, int val, const int array[])\n{\n\tint i = 0;\n\n\tif (val < array[i])\n\t\treturn i - 1;\n\n\tif (val >= array[array_size - 1])\n\t\treturn array_size - 1;\n\n\tfor (i = 1; i < array_size; i++) {\n\t\tif (val == array[i])\n\t\t\treturn i;\n\n\t\tif (val > array[i - 1] && val < array[i]) {\n\t\t\tif (val < array[i])\n\t\t\t\treturn i - 1;\n\t\t\telse\n\t\t\t\treturn i;\n\t\t}\n\t}\n\treturn -EINVAL;\n}\n\nstatic int bq256xx_usb_notifier(struct notifier_block *nb, unsigned long val,\n\t\t\t\tvoid *priv)\n{\n\tstruct bq256xx_device *bq =\n\t\t\tcontainer_of(nb, struct bq256xx_device, usb_nb);\n\n\tbq->usb_event = val;\n\tqueue_work(system_power_efficient_wq, &bq->usb_work);\n\n\treturn NOTIFY_OK;\n}\n\nstatic void bq256xx_usb_work(struct work_struct *data)\n{\n\tstruct bq256xx_device *bq =\n\t\t\tcontainer_of(data, struct bq256xx_device, usb_work);\n\n\tswitch (bq->usb_event) {\n\tcase USB_EVENT_ID:\n\t\tbreak;\n\tcase USB_EVENT_NONE:\n\t\tpower_supply_changed(bq->charger);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(bq->dev, \"Error switching to charger mode.\\n\");\n\t\tbreak;\n\t}\n}\n\nstatic struct reg_default bq2560x_reg_defs[] = {\n\t{BQ256XX_INPUT_CURRENT_LIMIT, 0x17},\n\t{BQ256XX_CHARGER_CONTROL_0, 0x1a},\n\t{BQ256XX_CHARGE_CURRENT_LIMIT, 0xa2},\n\t{BQ256XX_PRECHG_AND_TERM_CURR_LIM, 0x22},\n\t{BQ256XX_BATTERY_VOLTAGE_LIMIT, 0x58},\n\t{BQ256XX_CHARGER_CONTROL_1, 0x9f},\n\t{BQ256XX_CHARGER_CONTROL_2, 0x66},\n\t{BQ256XX_CHARGER_CONTROL_3, 0x4c},\n};\n\nstatic struct reg_default bq25611d_reg_defs[] = {\n\t{BQ256XX_INPUT_CURRENT_LIMIT, 0x17},\n\t{BQ256XX_CHARGER_CONTROL_0, 0x1a},\n\t{BQ256XX_CHARGE_CURRENT_LIMIT, 0x91},\n\t{BQ256XX_PRECHG_AND_TERM_CURR_LIM, 0x12},\n\t{BQ256XX_BATTERY_VOLTAGE_LIMIT, 0x40},\n\t{BQ256XX_CHARGER_CONTROL_1, 0x9e},\n\t{BQ256XX_CHARGER_CONTROL_2, 0xe6},\n\t{BQ256XX_CHARGER_CONTROL_3, 0x4c},\n\t{BQ256XX_PART_INFORMATION, 0x54},\n\t{BQ256XX_CHARGER_CONTROL_4, 0x75},\n};\n\nstatic struct reg_default bq25618_619_reg_defs[] = {\n\t{BQ256XX_INPUT_CURRENT_LIMIT, 0x17},\n\t{BQ256XX_CHARGER_CONTROL_0, 0x1a},\n\t{BQ256XX_CHARGE_CURRENT_LIMIT, 0x91},\n\t{BQ256XX_PRECHG_AND_TERM_CURR_LIM, 0x12},\n\t{BQ256XX_BATTERY_VOLTAGE_LIMIT, 0x40},\n\t{BQ256XX_CHARGER_CONTROL_1, 0x9e},\n\t{BQ256XX_CHARGER_CONTROL_2, 0xe6},\n\t{BQ256XX_CHARGER_CONTROL_3, 0x4c},\n\t{BQ256XX_PART_INFORMATION, 0x2c},\n\t{BQ256XX_CHARGER_CONTROL_4, 0x75},\n};\n\nstatic int bq256xx_get_state(struct bq256xx_device *bq,\n\t\t\t\tstruct bq256xx_state *state)\n{\n\tunsigned int charger_status_0;\n\tunsigned int charger_status_1;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_CHARGER_STATUS_0,\n\t\t\t\t\t\t&charger_status_0);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_CHARGER_STATUS_1,\n\t\t\t\t\t\t&charger_status_1);\n\tif (ret)\n\t\treturn ret;\n\n\tstate->vbus_stat = charger_status_0 & BQ256XX_VBUS_STAT_MASK;\n\tstate->chrg_stat = charger_status_0 & BQ256XX_CHRG_STAT_MASK;\n\tstate->online = charger_status_0 & BQ256XX_PG_STAT_MASK;\n\n\tstate->wdt_fault = charger_status_1 & BQ256XX_WDT_FAULT_MASK;\n\tstate->bat_fault = charger_status_1 & BQ256XX_BAT_FAULT_MASK;\n\tstate->chrg_fault = charger_status_1 & BQ256XX_CHRG_FAULT_MASK;\n\tstate->ntc_fault = charger_status_1 & BQ256XX_NTC_FAULT_MASK;\n\n\treturn 0;\n}\n\nstatic int bq256xx_set_charge_type(struct bq256xx_device *bq, int type)\n{\n\tint chg_config = 0;\n\n\tswitch (type) {\n\tcase POWER_SUPPLY_CHARGE_TYPE_NONE:\n\t\tchg_config = 0x0;\n\t\tbreak;\n\tcase POWER_SUPPLY_CHARGE_TYPE_TRICKLE:\n\tcase POWER_SUPPLY_CHARGE_TYPE_FAST:\n\t\tchg_config = 0x1;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_CHARGER_CONTROL_0,\n\t\t\t\tBQ256XX_CHG_CONFIG_MASK,\n\t\t\t\t(chg_config ? 1 : 0) << BQ256XX_CHG_CONFIG_BIT_SHIFT);\n}\n\nstatic int bq256xx_get_ichg_curr(struct bq256xx_device *bq)\n{\n\tunsigned int charge_current_limit;\n\tunsigned int ichg_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_CHARGE_CURRENT_LIMIT,\n\t\t\t\t\t\t&charge_current_limit);\n\tif (ret)\n\t\treturn ret;\n\n\tichg_reg_code = charge_current_limit & BQ256XX_ICHG_MASK;\n\n\treturn ichg_reg_code * BQ256XX_ICHG_STEP_uA;\n}\n\nstatic int bq25618_619_get_ichg_curr(struct bq256xx_device *bq)\n{\n\tunsigned int charge_current_limit;\n\tunsigned int ichg_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_CHARGE_CURRENT_LIMIT,\n\t\t\t\t\t\t&charge_current_limit);\n\tif (ret)\n\t\treturn ret;\n\n\tichg_reg_code = charge_current_limit & BQ256XX_ICHG_MASK;\n\n\tif (ichg_reg_code < BQ25618_ICHG_THRESH)\n\t\treturn ichg_reg_code * BQ25618_ICHG_STEP_uA;\n\n\treturn bq25618_619_ichg_values[ichg_reg_code - BQ25618_ICHG_THRESH];\n}\n\nstatic int bq256xx_set_ichg_curr(struct bq256xx_device *bq, int ichg)\n{\n\tunsigned int ichg_reg_code;\n\tint ichg_max = bq->init_data.ichg_max;\n\n\tichg = clamp(ichg, BQ256XX_ICHG_MIN_uA, ichg_max);\n\tichg_reg_code = ichg / BQ256XX_ICHG_STEP_uA;\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_CHARGE_CURRENT_LIMIT,\n\t\t\t\t\tBQ256XX_ICHG_MASK, ichg_reg_code);\n}\n\nstatic int bq25618_619_set_ichg_curr(struct bq256xx_device *bq, int ichg)\n{\n\tint array_size = ARRAY_SIZE(bq25618_619_ichg_values);\n\tunsigned int ichg_reg_code;\n\tint ichg_max = bq->init_data.ichg_max;\n\n\tichg = clamp(ichg, BQ25618_ICHG_MIN_uA, ichg_max);\n\n\tif (ichg <= BQ25618_ICHG_THRESH_uA) {\n\t\tichg_reg_code = ichg / BQ25618_ICHG_STEP_uA;\n\t} else {\n\t\tichg_reg_code = bq256xx_array_parse(array_size, ichg,\n\t\t\tbq25618_619_ichg_values) + BQ25618_ICHG_THRESH;\n\t}\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_CHARGE_CURRENT_LIMIT,\n\t\t\t\t\tBQ256XX_ICHG_MASK, ichg_reg_code);\n}\n\nstatic int bq25618_619_get_chrg_volt(struct bq256xx_device *bq)\n{\n\tunsigned int battery_volt_lim;\n\tunsigned int vbatreg_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_BATTERY_VOLTAGE_LIMIT,\n\t\t\t\t\t\t\t&battery_volt_lim);\n\n\tif (ret)\n\t\treturn ret;\n\n\tvbatreg_reg_code = (battery_volt_lim & BQ256XX_VBATREG_MASK) >>\n\t\t\t\t\t\tBQ256XX_VBATREG_BIT_SHIFT;\n\n\tif (vbatreg_reg_code > BQ2561X_VBATREG_THRESH)\n\t\treturn ((vbatreg_reg_code - BQ2561X_VBATREG_THRESH) *\n\t\t\t\t\tBQ2561X_VBATREG_STEP_uV) +\n\t\t\t\t\tBQ25618_VBATREG_THRESH_uV;\n\n\treturn bq25618_619_vbatreg_values[vbatreg_reg_code];\n}\n\nstatic int bq25611d_get_chrg_volt(struct bq256xx_device *bq)\n{\n\tunsigned int battery_volt_lim;\n\tunsigned int vbatreg_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_BATTERY_VOLTAGE_LIMIT,\n\t\t\t\t\t\t\t&battery_volt_lim);\n\tif (ret)\n\t\treturn ret;\n\n\tvbatreg_reg_code = (battery_volt_lim & BQ256XX_VBATREG_MASK) >>\n\t\t\t\t\t\tBQ256XX_VBATREG_BIT_SHIFT;\n\n\tif (vbatreg_reg_code > BQ2561X_VBATREG_THRESH)\n\t\treturn ((vbatreg_reg_code - BQ2561X_VBATREG_THRESH) *\n\t\t\t\t\tBQ2561X_VBATREG_STEP_uV) +\n\t\t\t\t\tBQ25611D_VBATREG_THRESH_uV;\n\n\treturn bq25611d_vbatreg_values[vbatreg_reg_code];\n}\n\nstatic int bq2560x_get_chrg_volt(struct bq256xx_device *bq)\n{\n\tunsigned int battery_volt_lim;\n\tunsigned int vbatreg_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_BATTERY_VOLTAGE_LIMIT,\n\t\t\t\t\t\t\t&battery_volt_lim);\n\tif (ret)\n\t\treturn ret;\n\n\tvbatreg_reg_code = (battery_volt_lim & BQ256XX_VBATREG_MASK) >>\n\t\t\t\t\t\tBQ256XX_VBATREG_BIT_SHIFT;\n\n\treturn (vbatreg_reg_code * BQ2560X_VBATREG_STEP_uV)\n\t\t\t\t\t+ BQ2560X_VBATREG_OFFSET_uV;\n}\n\nstatic int bq25601d_get_chrg_volt(struct bq256xx_device *bq)\n{\n\tunsigned int battery_volt_lim;\n\tunsigned int vbatreg_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_BATTERY_VOLTAGE_LIMIT,\n\t\t\t\t\t\t\t&battery_volt_lim);\n\tif (ret)\n\t\treturn ret;\n\n\tvbatreg_reg_code = (battery_volt_lim & BQ256XX_VBATREG_MASK) >>\n\t\t\t\t\t\tBQ256XX_VBATREG_BIT_SHIFT;\n\n\treturn (vbatreg_reg_code * BQ2560X_VBATREG_STEP_uV)\n\t\t\t\t\t+ BQ25601D_VBATREG_OFFSET_uV;\n}\n\nstatic int bq25618_619_set_chrg_volt(struct bq256xx_device *bq, int vbatreg)\n{\n\tint array_size = ARRAY_SIZE(bq25618_619_vbatreg_values);\n\tunsigned int vbatreg_reg_code;\n\tint vbatreg_max = bq->init_data.vbatreg_max;\n\n\tvbatreg = clamp(vbatreg, BQ25618_VBATREG_MIN_uV, vbatreg_max);\n\n\tif (vbatreg > BQ25618_VBATREG_THRESH_uV)\n\t\tvbatreg_reg_code = ((vbatreg -\n\t\tBQ25618_VBATREG_THRESH_uV) /\n\t\t(BQ2561X_VBATREG_STEP_uV)) + BQ2561X_VBATREG_THRESH;\n\telse {\n\t\tvbatreg_reg_code = bq256xx_array_parse(array_size, vbatreg,\n\t\t\t\t\t\tbq25618_619_vbatreg_values);\n\t}\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_BATTERY_VOLTAGE_LIMIT,\n\t\t\t\tBQ256XX_VBATREG_MASK, vbatreg_reg_code <<\n\t\t\t\t\t\tBQ256XX_VBATREG_BIT_SHIFT);\n}\n\nstatic int bq25611d_set_chrg_volt(struct bq256xx_device *bq, int vbatreg)\n{\n\tint array_size = ARRAY_SIZE(bq25611d_vbatreg_values);\n\tunsigned int vbatreg_reg_code;\n\tint vbatreg_max = bq->init_data.vbatreg_max;\n\n\tvbatreg = clamp(vbatreg, BQ25611D_VBATREG_MIN_uV, vbatreg_max);\n\n\tif (vbatreg > BQ25611D_VBATREG_THRESH_uV)\n\t\tvbatreg_reg_code = ((vbatreg -\n\t\tBQ25611D_VBATREG_THRESH_uV) /\n\t\t(BQ2561X_VBATREG_STEP_uV)) + BQ2561X_VBATREG_THRESH;\n\telse {\n\t\tvbatreg_reg_code = bq256xx_array_parse(array_size, vbatreg,\n\t\t\t\t\t\tbq25611d_vbatreg_values);\n\t}\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_BATTERY_VOLTAGE_LIMIT,\n\t\t\t\tBQ256XX_VBATREG_MASK, vbatreg_reg_code <<\n\t\t\t\t\t\tBQ256XX_VBATREG_BIT_SHIFT);\n}\n\nstatic int bq2560x_set_chrg_volt(struct bq256xx_device *bq, int vbatreg)\n{\n\tunsigned int vbatreg_reg_code;\n\tint vbatreg_max = bq->init_data.vbatreg_max;\n\n\tvbatreg = clamp(vbatreg, BQ2560X_VBATREG_MIN_uV, vbatreg_max);\n\n\tvbatreg_reg_code = (vbatreg - BQ2560X_VBATREG_OFFSET_uV) /\n\t\t\t\t\t\tBQ2560X_VBATREG_STEP_uV;\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_BATTERY_VOLTAGE_LIMIT,\n\t\t\t\tBQ256XX_VBATREG_MASK, vbatreg_reg_code <<\n\t\t\t\t\t\tBQ256XX_VBATREG_BIT_SHIFT);\n}\n\nstatic int bq25601d_set_chrg_volt(struct bq256xx_device *bq, int vbatreg)\n{\n\tunsigned int vbatreg_reg_code;\n\tint vbatreg_max = bq->init_data.vbatreg_max;\n\n\tvbatreg = clamp(vbatreg, BQ25601D_VBATREG_MIN_uV, vbatreg_max);\n\n\tvbatreg_reg_code = (vbatreg - BQ25601D_VBATREG_OFFSET_uV) /\n\t\t\t\t\t\tBQ2560X_VBATREG_STEP_uV;\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_BATTERY_VOLTAGE_LIMIT,\n\t\t\t\tBQ256XX_VBATREG_MASK, vbatreg_reg_code <<\n\t\t\t\t\t\tBQ256XX_VBATREG_BIT_SHIFT);\n}\n\nstatic int bq256xx_set_ts_ignore(struct bq256xx_device *bq, bool ts_ignore)\n{\n\treturn regmap_update_bits(bq->regmap, BQ256XX_INPUT_CURRENT_LIMIT,\n\t\t\t\tBQ256XX_TS_IGNORE, (ts_ignore ? 1 : 0) << BQ256XX_TS_IGNORE_SHIFT);\n}\n\nstatic int bq256xx_get_prechrg_curr(struct bq256xx_device *bq)\n{\n\tunsigned int prechg_and_term_curr_lim;\n\tunsigned int iprechg_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_PRECHG_AND_TERM_CURR_LIM,\n\t\t\t\t\t\t&prechg_and_term_curr_lim);\n\tif (ret)\n\t\treturn ret;\n\n\tiprechg_reg_code = (prechg_and_term_curr_lim & BQ256XX_IPRECHG_MASK)\n\t\t\t\t\t\t>> BQ256XX_IPRECHG_BIT_SHIFT;\n\n\treturn (iprechg_reg_code * BQ256XX_IPRECHG_STEP_uA) +\n\t\t\t\t\t\tBQ256XX_IPRECHG_OFFSET_uA;\n}\n\nstatic int bq256xx_set_prechrg_curr(struct bq256xx_device *bq, int iprechg)\n{\n\tunsigned int iprechg_reg_code;\n\n\tiprechg = clamp(iprechg, BQ256XX_IPRECHG_MIN_uA,\n\t\t\t\t\t\tBQ256XX_IPRECHG_MAX_uA);\n\n\tiprechg_reg_code = ((iprechg - BQ256XX_IPRECHG_OFFSET_uA) /\n\t\t\tBQ256XX_IPRECHG_STEP_uA) << BQ256XX_IPRECHG_BIT_SHIFT;\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_PRECHG_AND_TERM_CURR_LIM,\n\t\t\t\tBQ256XX_IPRECHG_MASK, iprechg_reg_code);\n}\n\nstatic int bq25618_619_get_prechrg_curr(struct bq256xx_device *bq)\n{\n\tunsigned int prechg_and_term_curr_lim;\n\tunsigned int iprechg_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_PRECHG_AND_TERM_CURR_LIM,\n\t\t\t\t\t\t&prechg_and_term_curr_lim);\n\tif (ret)\n\t\treturn ret;\n\n\tiprechg_reg_code = (prechg_and_term_curr_lim & BQ256XX_IPRECHG_MASK)\n\t\t\t\t\t\t>> BQ256XX_IPRECHG_BIT_SHIFT;\n\n\treturn (iprechg_reg_code * BQ25618_IPRECHG_STEP_uA) +\n\t\t\t\t\t\tBQ25618_IPRECHG_OFFSET_uA;\n}\n\nstatic int bq25618_619_set_prechrg_curr(struct bq256xx_device *bq, int iprechg)\n{\n\tunsigned int iprechg_reg_code;\n\n\tiprechg = clamp(iprechg, BQ25618_IPRECHG_MIN_uA,\n\t\t\t\t\t\tBQ25618_IPRECHG_MAX_uA);\n\n\tiprechg_reg_code = ((iprechg - BQ25618_IPRECHG_OFFSET_uA) /\n\t\t\tBQ25618_IPRECHG_STEP_uA) << BQ256XX_IPRECHG_BIT_SHIFT;\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_PRECHG_AND_TERM_CURR_LIM,\n\t\t\t\tBQ256XX_IPRECHG_MASK, iprechg_reg_code);\n}\n\nstatic int bq256xx_get_term_curr(struct bq256xx_device *bq)\n{\n\tunsigned int prechg_and_term_curr_lim;\n\tunsigned int iterm_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_PRECHG_AND_TERM_CURR_LIM,\n\t\t\t\t\t\t&prechg_and_term_curr_lim);\n\tif (ret)\n\t\treturn ret;\n\n\titerm_reg_code = prechg_and_term_curr_lim & BQ256XX_ITERM_MASK;\n\n\treturn (iterm_reg_code * BQ256XX_ITERM_STEP_uA) +\n\t\t\t\t\t\tBQ256XX_ITERM_OFFSET_uA;\n}\n\nstatic int bq256xx_set_term_curr(struct bq256xx_device *bq, int iterm)\n{\n\tunsigned int iterm_reg_code;\n\n\titerm = clamp(iterm, BQ256XX_ITERM_MIN_uA, BQ256XX_ITERM_MAX_uA);\n\n\titerm_reg_code = (iterm - BQ256XX_ITERM_OFFSET_uA) /\n\t\t\t\t\t\t\tBQ256XX_ITERM_STEP_uA;\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_PRECHG_AND_TERM_CURR_LIM,\n\t\t\t\tBQ256XX_ITERM_MASK, iterm_reg_code);\n}\n\nstatic int bq25618_619_get_term_curr(struct bq256xx_device *bq)\n{\n\tunsigned int prechg_and_term_curr_lim;\n\tunsigned int iterm_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_PRECHG_AND_TERM_CURR_LIM,\n\t\t\t\t\t\t&prechg_and_term_curr_lim);\n\tif (ret)\n\t\treturn ret;\n\n\titerm_reg_code = prechg_and_term_curr_lim & BQ256XX_ITERM_MASK;\n\n\treturn (iterm_reg_code * BQ25618_ITERM_STEP_uA) +\n\t\t\t\t\t\tBQ25618_ITERM_OFFSET_uA;\n}\n\nstatic int bq25618_619_set_term_curr(struct bq256xx_device *bq, int iterm)\n{\n\tunsigned int iterm_reg_code;\n\n\titerm = clamp(iterm, BQ25618_ITERM_MIN_uA, BQ25618_ITERM_MAX_uA);\n\n\titerm_reg_code = (iterm - BQ25618_ITERM_OFFSET_uA) /\n\t\t\t\t\t\t\tBQ25618_ITERM_STEP_uA;\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_PRECHG_AND_TERM_CURR_LIM,\n\t\t\t\tBQ256XX_ITERM_MASK, iterm_reg_code);\n}\n\nstatic int bq256xx_get_input_volt_lim(struct bq256xx_device *bq)\n{\n\tunsigned int charger_control_2;\n\tunsigned int vindpm_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_CHARGER_CONTROL_2,\n\t\t\t\t\t\t&charger_control_2);\n\tif (ret)\n\t\treturn ret;\n\n\tvindpm_reg_code = charger_control_2 & BQ256XX_VINDPM_MASK;\n\n\treturn (vindpm_reg_code * BQ256XX_VINDPM_STEP_uV) +\n\t\t\t\t\t\tBQ256XX_VINDPM_OFFSET_uV;\n}\n\nstatic int bq256xx_set_input_volt_lim(struct bq256xx_device *bq, int vindpm)\n{\n\tunsigned int vindpm_reg_code;\n\n\tvindpm = clamp(vindpm, BQ256XX_VINDPM_MIN_uV, BQ256XX_VINDPM_MAX_uV);\n\n\tvindpm_reg_code = (vindpm - BQ256XX_VINDPM_OFFSET_uV) /\n\t\t\t\t\t\tBQ256XX_VINDPM_STEP_uV;\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_CHARGER_CONTROL_2,\n\t\t\t\t\tBQ256XX_VINDPM_MASK, vindpm_reg_code);\n}\n\nstatic int bq256xx_get_input_curr_lim(struct bq256xx_device *bq)\n{\n\tunsigned int input_current_limit;\n\tunsigned int iindpm_reg_code;\n\tint ret;\n\n\tret = regmap_read(bq->regmap, BQ256XX_INPUT_CURRENT_LIMIT,\n\t\t\t\t\t\t&input_current_limit);\n\tif (ret)\n\t\treturn ret;\n\n\tiindpm_reg_code = input_current_limit & BQ256XX_IINDPM_MASK;\n\n\treturn (iindpm_reg_code * BQ256XX_IINDPM_STEP_uA) +\n\t\t\t\t\t\tBQ256XX_IINDPM_OFFSET_uA;\n}\n\nstatic int bq256xx_set_input_curr_lim(struct bq256xx_device *bq, int iindpm)\n{\n\tunsigned int iindpm_reg_code;\n\n\tiindpm = clamp(iindpm, BQ256XX_IINDPM_MIN_uA, BQ256XX_IINDPM_MAX_uA);\n\n\tiindpm_reg_code = (iindpm - BQ256XX_IINDPM_OFFSET_uA) /\n\t\t\t\t\t\t\tBQ256XX_IINDPM_STEP_uA;\n\n\treturn regmap_update_bits(bq->regmap, BQ256XX_INPUT_CURRENT_LIMIT,\n\t\t\t\t\tBQ256XX_IINDPM_MASK, iindpm_reg_code);\n}\n\nstatic void bq256xx_charger_reset(void *data)\n{\n\tstruct bq256xx_device *bq = data;\n\n\tregmap_update_bits(bq->regmap, BQ256XX_PART_INFORMATION,\n\t\t\t\t\tBQ256XX_REG_RST, BQ256XX_REG_RST);\n\n\tif (!IS_ERR_OR_NULL(bq->usb2_phy))\n\t\tusb_unregister_notifier(bq->usb2_phy, &bq->usb_nb);\n\n\tif (!IS_ERR_OR_NULL(bq->usb3_phy))\n\t\tusb_unregister_notifier(bq->usb3_phy, &bq->usb_nb);\n}\n\nstatic int bq256xx_set_charger_property(struct power_supply *psy,\n\t\tenum power_supply_property prop,\n\t\tconst union power_supply_propval *val)\n{\n\tstruct bq256xx_device *bq = power_supply_get_drvdata(psy);\n\tint ret = -EINVAL;\n\n\tswitch (prop) {\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\t\tret = bq->chip_info->bq256xx_set_iindpm(bq, val->intval);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE:\n\t\tret = bq->chip_info->bq256xx_set_vbatreg(bq, val->intval);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT:\n\t\tret = bq->chip_info->bq256xx_set_ichg(bq, val->intval);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_PRECHARGE_CURRENT:\n\t\tret = bq->chip_info->bq256xx_set_iprechg(bq, val->intval);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_CHARGE_TERM_CURRENT:\n\t\tret = bq->chip_info->bq256xx_set_iterm(bq, val->intval);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_INPUT_VOLTAGE_LIMIT:\n\t\tret = bq->chip_info->bq256xx_set_vindpm(bq, val->intval);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tret = bq->chip_info->bq256xx_set_charge_type(bq, val->intval);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\n\nstatic int bq256xx_get_battery_property(struct power_supply *psy,\n\t\t\t\tenum power_supply_property psp,\n\t\t\t\tunion power_supply_propval *val)\n{\n\tstruct bq256xx_device *bq = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:\n\t\tval->intval = bq->init_data.ichg_max;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX:\n\t\tval->intval = bq->init_data.vbatreg_max;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int bq256xx_get_charger_property(struct power_supply *psy,\n\t\t\t\tenum power_supply_property psp,\n\t\t\t\tunion power_supply_propval *val)\n{\n\tstruct bq256xx_device *bq = power_supply_get_drvdata(psy);\n\tstruct bq256xx_state state;\n\tint ret = 0;\n\n\tmutex_lock(&bq->lock);\n\tret = bq256xx_get_state(bq, &state);\n\tmutex_unlock(&bq->lock);\n\tif (ret)\n\t\treturn ret;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tif (state.vbus_stat == BQ256XX_VBUS_STAT_NO_INPUT ||\n\t\t    state.vbus_stat == BQ256XX_VBUS_STAT_USB_OTG)\n\t\t\tval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\n\t\telse if (state.chrg_stat == BQ256XX_CHRG_STAT_NOT_CHRGING)\n\t\t\tval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t\telse if (state.chrg_stat == BQ256XX_CHRG_STAT_CHRG_TERM)\n\t\t\tval->intval = POWER_SUPPLY_STATUS_FULL;\n\t\telse\n\t\t\tval->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tval->intval = POWER_SUPPLY_HEALTH_UNKNOWN;\n\t\tif (state.wdt_fault) {\n\t\t\tval->intval =\n\t\t\t\tPOWER_SUPPLY_HEALTH_WATCHDOG_TIMER_EXPIRE;\n\t\t} else if (state.bat_fault) {\n\t\t\tval->intval = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\n\t\t} else {\n\t\t\tswitch (state.chrg_stat) {\n\t\t\tcase BQ256XX_CHRG_FAULT_INPUT:\n\t\t\t\tval->intval =\n\t\t\t\t\tPOWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\t\t\t\tbreak;\n\t\t\tcase BQ256XX_CHRG_FAULT_THERM:\n\t\t\t\tval->intval = POWER_SUPPLY_HEALTH_OVERHEAT;\n\t\t\t\tbreak;\n\t\t\tcase BQ256XX_CHRG_FAULT_CST_EXPIRE:\n\t\t\t\tval->intval =\n\t\t\t\tPOWER_SUPPLY_HEALTH_SAFETY_TIMER_EXPIRE;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tswitch (state.ntc_fault) {\n\t\t\tcase BQ256XX_NTC_FAULT_WARM:\n\t\t\t\tval->intval = POWER_SUPPLY_HEALTH_WARM;\n\t\t\t\tbreak;\n\t\t\tcase BQ256XX_NTC_FAULT_COOL:\n\t\t\t\tval->intval = POWER_SUPPLY_HEALTH_COOL;\n\t\t\t\tbreak;\n\t\t\tcase BQ256XX_NTC_FAULT_COLD:\n\t\t\t\tval->intval = POWER_SUPPLY_HEALTH_COLD;\n\t\t\t\tbreak;\n\t\t\tcase BQ256XX_NTC_FAULT_HOT:\n\t\t\t\tval->intval = POWER_SUPPLY_HEALTH_HOT;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tval->intval = POWER_SUPPLY_HEALTH_GOOD;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_USB_TYPE:\n\t\tif (bq->chip_info->has_usb_detect) {\n\t\t\tswitch (state.vbus_stat) {\n\t\t\tcase BQ256XX_VBUS_STAT_USB_SDP:\n\t\t\t\tval->intval = POWER_SUPPLY_USB_TYPE_SDP;\n\t\t\t\tbreak;\n\t\t\tcase BQ256XX_VBUS_STAT_USB_CDP:\n\t\t\t\tval->intval = POWER_SUPPLY_USB_TYPE_CDP;\n\t\t\t\tbreak;\n\t\t\tcase BQ256XX_VBUS_STAT_USB_DCP:\n\t\t\t\tval->intval = POWER_SUPPLY_USB_TYPE_DCP;\n\t\t\t\tbreak;\n\t\t\tcase BQ256XX_VBUS_STAT_USB_OTG:\n\t\t\t\tval->intval = POWER_SUPPLY_USB_TYPE_ACA;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tval->intval = POWER_SUPPLY_USB_TYPE_UNKNOWN;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t} else {\n\t\t\tswitch (state.vbus_stat) {\n\t\t\tcase BQ256XX_VBUS_STAT_USB_SDP:\n\t\t\t\tval->intval = POWER_SUPPLY_USB_TYPE_SDP;\n\t\t\t\tbreak;\n\t\t\tcase BQ256XX_VBUS_STAT_USB_OTG:\n\t\t\t\tval->intval = POWER_SUPPLY_USB_TYPE_ACA;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tval->intval = POWER_SUPPLY_USB_TYPE_UNKNOWN;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tswitch (state.chrg_stat) {\n\t\tcase BQ256XX_CHRG_STAT_NOT_CHRGING:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_NONE;\n\t\t\tbreak;\n\t\tcase BQ256XX_CHRG_STAT_PRECHRGING:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\n\t\t\tbreak;\n\t\tcase BQ256XX_CHRG_STAT_FAST_CHRGING:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_FAST;\n\t\t\tbreak;\n\t\tcase BQ256XX_CHRG_STAT_CHRG_TERM:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tval->intval = POWER_SUPPLY_CHARGE_TYPE_UNKNOWN;\n\t\t}\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_MANUFACTURER:\n\t\tval->strval = BQ256XX_MANUFACTURER;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_MODEL_NAME:\n\t\tval->strval = bq->model_name;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = state.online;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_INPUT_VOLTAGE_LIMIT:\n\t\tret = bq->chip_info->bq256xx_get_vindpm(bq);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tval->intval = ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\t\tret = bq->chip_info->bq256xx_get_iindpm(bq);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tval->intval = ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE:\n\t\tret = bq->chip_info->bq256xx_get_vbatreg(bq);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tval->intval = ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT:\n\t\tret = bq->chip_info->bq256xx_get_ichg(bq);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tval->intval = ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_PRECHARGE_CURRENT:\n\t\tret = bq->chip_info->bq256xx_get_iprechg(bq);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tval->intval = ret;\n\t\tbreak;\n\n\tcase POWER_SUPPLY_PROP_CHARGE_TERM_CURRENT:\n\t\tret = bq->chip_info->bq256xx_get_iterm(bq);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\t\tval->intval = ret;\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn ret;\n}\n\nstatic bool bq256xx_state_changed(struct bq256xx_device *bq,\n\t\t\t\t  struct bq256xx_state *new_state)\n{\n\tstruct bq256xx_state old_state;\n\n\tmutex_lock(&bq->lock);\n\told_state = bq->state;\n\tmutex_unlock(&bq->lock);\n\n\treturn memcmp(&old_state, new_state, sizeof(struct bq256xx_state)) != 0;\n}\n\nstatic irqreturn_t bq256xx_irq_handler_thread(int irq, void *private)\n{\n\tstruct bq256xx_device *bq = private;\n\tstruct bq256xx_state state;\n\tint ret;\n\n\tret = bq256xx_get_state(bq, &state);\n\tif (ret < 0)\n\t\tgoto irq_out;\n\n\tif (!bq256xx_state_changed(bq, &state))\n\t\tgoto irq_out;\n\n\tmutex_lock(&bq->lock);\n\tbq->state = state;\n\tmutex_unlock(&bq->lock);\n\n\tpower_supply_changed(bq->charger);\n\nirq_out:\n\treturn IRQ_HANDLED;\n}\n\nstatic enum power_supply_property bq256xx_power_supply_props[] = {\n\tPOWER_SUPPLY_PROP_MANUFACTURER,\n\tPOWER_SUPPLY_PROP_MODEL_NAME,\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_INPUT_VOLTAGE_LIMIT,\n\tPOWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT,\n\tPOWER_SUPPLY_PROP_CHARGE_TYPE,\n\tPOWER_SUPPLY_PROP_USB_TYPE,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE,\n\tPOWER_SUPPLY_PROP_PRECHARGE_CURRENT,\n\tPOWER_SUPPLY_PROP_CHARGE_TERM_CURRENT,\n};\n\nstatic enum power_supply_property bq256xx_battery_props[] = {\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX,\n};\n\nstatic int bq256xx_property_is_writeable(struct power_supply *psy,\n\t\t\t\t\t enum power_supply_property prop)\n{\n\tswitch (prop) {\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE:\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT:\n\tcase POWER_SUPPLY_PROP_PRECHARGE_CURRENT:\n\tcase POWER_SUPPLY_PROP_CHARGE_TERM_CURRENT:\n\tcase POWER_SUPPLY_PROP_STATUS:\n\tcase POWER_SUPPLY_PROP_INPUT_VOLTAGE_LIMIT:\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic const struct power_supply_desc bq256xx_power_supply_desc = {\n\t.name = \"bq256xx-charger\",\n\t.type = POWER_SUPPLY_TYPE_USB,\n\t.usb_types = bq256xx_usb_type,\n\t.num_usb_types = ARRAY_SIZE(bq256xx_usb_type),\n\t.properties = bq256xx_power_supply_props,\n\t.num_properties = ARRAY_SIZE(bq256xx_power_supply_props),\n\t.get_property = bq256xx_get_charger_property,\n\t.set_property = bq256xx_set_charger_property,\n\t.property_is_writeable = bq256xx_property_is_writeable,\n};\n\nstatic struct power_supply_desc bq256xx_battery_desc = {\n\t.name\t\t\t= \"bq256xx-battery\",\n\t.type\t\t\t= POWER_SUPPLY_TYPE_BATTERY,\n\t.get_property\t\t= bq256xx_get_battery_property,\n\t.properties\t\t= bq256xx_battery_props,\n\t.num_properties\t\t= ARRAY_SIZE(bq256xx_battery_props),\n\t.property_is_writeable\t= bq256xx_property_is_writeable,\n};\n\n\nstatic bool bq256xx_is_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase BQ256XX_INPUT_CURRENT_LIMIT:\n\tcase BQ256XX_CHARGER_STATUS_0...BQ256XX_CHARGER_STATUS_2:\n\t\treturn true;\n\tdefault:\n\t\treturn false;\n\t}\n}\n\nstatic const struct regmap_config bq25600_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\n\t.max_register = BQ256XX_PART_INFORMATION,\n\t.reg_defaults\t= bq2560x_reg_defs,\n\t.num_reg_defaults = ARRAY_SIZE(bq2560x_reg_defs),\n\t.cache_type = REGCACHE_FLAT,\n\t.volatile_reg = bq256xx_is_volatile_reg,\n};\n\nstatic const struct regmap_config bq25611d_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\n\t.max_register = BQ256XX_CHARGER_CONTROL_4,\n\t.reg_defaults\t= bq25611d_reg_defs,\n\t.num_reg_defaults = ARRAY_SIZE(bq25611d_reg_defs),\n\t.cache_type = REGCACHE_FLAT,\n\t.volatile_reg = bq256xx_is_volatile_reg,\n};\n\nstatic const struct regmap_config bq25618_619_regmap_config = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\n\t.max_register = BQ256XX_CHARGER_CONTROL_4,\n\t.reg_defaults\t= bq25618_619_reg_defs,\n\t.num_reg_defaults = ARRAY_SIZE(bq25618_619_reg_defs),\n\t.cache_type = REGCACHE_FLAT,\n\t.volatile_reg = bq256xx_is_volatile_reg,\n};\n\nstatic const struct bq256xx_chip_info bq256xx_chip_info_tbl[] = {\n\t[BQ25600] = {\n\t\t.model_id = BQ25600,\n\t\t.bq256xx_regmap_config = &bq25600_regmap_config,\n\t\t.bq256xx_get_ichg = bq256xx_get_ichg_curr,\n\t\t.bq256xx_get_iindpm = bq256xx_get_input_curr_lim,\n\t\t.bq256xx_get_vbatreg = bq2560x_get_chrg_volt,\n\t\t.bq256xx_get_iterm = bq256xx_get_term_curr,\n\t\t.bq256xx_get_iprechg = bq256xx_get_prechrg_curr,\n\t\t.bq256xx_get_vindpm = bq256xx_get_input_volt_lim,\n\t\t.bq256xx_set_ts_ignore = NULL,\n\n\t\t.bq256xx_set_ichg = bq256xx_set_ichg_curr,\n\t\t.bq256xx_set_iindpm = bq256xx_set_input_curr_lim,\n\t\t.bq256xx_set_vbatreg = bq2560x_set_chrg_volt,\n\t\t.bq256xx_set_iterm = bq256xx_set_term_curr,\n\t\t.bq256xx_set_iprechg = bq256xx_set_prechrg_curr,\n\t\t.bq256xx_set_vindpm = bq256xx_set_input_volt_lim,\n\t\t.bq256xx_set_charge_type = bq256xx_set_charge_type,\n\n\t\t.bq256xx_def_ichg = BQ2560X_ICHG_DEF_uA,\n\t\t.bq256xx_def_iindpm = BQ256XX_IINDPM_DEF_uA,\n\t\t.bq256xx_def_vbatreg = BQ2560X_VBATREG_DEF_uV,\n\t\t.bq256xx_def_iterm = BQ256XX_ITERM_DEF_uA,\n\t\t.bq256xx_def_iprechg = BQ256XX_IPRECHG_DEF_uA,\n\t\t.bq256xx_def_vindpm = BQ256XX_VINDPM_DEF_uV,\n\n\t\t.bq256xx_max_ichg = BQ256XX_ICHG_MAX_uA,\n\t\t.bq256xx_max_vbatreg = BQ2560X_VBATREG_MAX_uV,\n\n\t\t.has_usb_detect = false,\n\t},\n\n\t[BQ25600D] = {\n\t\t.model_id = BQ25600D,\n\t\t.bq256xx_regmap_config = &bq25600_regmap_config,\n\t\t.bq256xx_get_ichg = bq256xx_get_ichg_curr,\n\t\t.bq256xx_get_iindpm = bq256xx_get_input_curr_lim,\n\t\t.bq256xx_get_vbatreg = bq2560x_get_chrg_volt,\n\t\t.bq256xx_get_iterm = bq256xx_get_term_curr,\n\t\t.bq256xx_get_iprechg = bq256xx_get_prechrg_curr,\n\t\t.bq256xx_get_vindpm = bq256xx_get_input_volt_lim,\n\n\t\t.bq256xx_set_ichg = bq256xx_set_ichg_curr,\n\t\t.bq256xx_set_iindpm = bq256xx_set_input_curr_lim,\n\t\t.bq256xx_set_vbatreg = bq2560x_set_chrg_volt,\n\t\t.bq256xx_set_iterm = bq256xx_set_term_curr,\n\t\t.bq256xx_set_iprechg = bq256xx_set_prechrg_curr,\n\t\t.bq256xx_set_vindpm = bq256xx_set_input_volt_lim,\n\t\t.bq256xx_set_charge_type = bq256xx_set_charge_type,\n\t\t.bq256xx_set_ts_ignore = NULL,\n\n\t\t.bq256xx_def_ichg = BQ2560X_ICHG_DEF_uA,\n\t\t.bq256xx_def_iindpm = BQ256XX_IINDPM_DEF_uA,\n\t\t.bq256xx_def_vbatreg = BQ2560X_VBATREG_DEF_uV,\n\t\t.bq256xx_def_iterm = BQ256XX_ITERM_DEF_uA,\n\t\t.bq256xx_def_iprechg = BQ256XX_IPRECHG_DEF_uA,\n\t\t.bq256xx_def_vindpm = BQ256XX_VINDPM_DEF_uV,\n\n\t\t.bq256xx_max_ichg = BQ256XX_ICHG_MAX_uA,\n\t\t.bq256xx_max_vbatreg = BQ2560X_VBATREG_MAX_uV,\n\n\t\t.has_usb_detect = true,\n\t},\n\n\t[BQ25601] = {\n\t\t.model_id = BQ25601,\n\t\t.bq256xx_regmap_config = &bq25600_regmap_config,\n\t\t.bq256xx_get_ichg = bq256xx_get_ichg_curr,\n\t\t.bq256xx_get_iindpm = bq256xx_get_input_curr_lim,\n\t\t.bq256xx_get_vbatreg = bq2560x_get_chrg_volt,\n\t\t.bq256xx_get_iterm = bq256xx_get_term_curr,\n\t\t.bq256xx_get_iprechg = bq256xx_get_prechrg_curr,\n\t\t.bq256xx_get_vindpm = bq256xx_get_input_volt_lim,\n\n\t\t.bq256xx_set_ichg = bq256xx_set_ichg_curr,\n\t\t.bq256xx_set_iindpm = bq256xx_set_input_curr_lim,\n\t\t.bq256xx_set_vbatreg = bq2560x_set_chrg_volt,\n\t\t.bq256xx_set_iterm = bq256xx_set_term_curr,\n\t\t.bq256xx_set_iprechg = bq256xx_set_prechrg_curr,\n\t\t.bq256xx_set_vindpm = bq256xx_set_input_volt_lim,\n\t\t.bq256xx_set_charge_type = bq256xx_set_charge_type,\n\t\t.bq256xx_set_ts_ignore = NULL,\n\n\t\t.bq256xx_def_ichg = BQ2560X_ICHG_DEF_uA,\n\t\t.bq256xx_def_iindpm = BQ256XX_IINDPM_DEF_uA,\n\t\t.bq256xx_def_vbatreg = BQ2560X_VBATREG_DEF_uV,\n\t\t.bq256xx_def_iterm = BQ256XX_ITERM_DEF_uA,\n\t\t.bq256xx_def_iprechg = BQ256XX_IPRECHG_DEF_uA,\n\t\t.bq256xx_def_vindpm = BQ256XX_VINDPM_DEF_uV,\n\n\t\t.bq256xx_max_ichg = BQ256XX_ICHG_MAX_uA,\n\t\t.bq256xx_max_vbatreg = BQ2560X_VBATREG_MAX_uV,\n\n\t\t.has_usb_detect = false,\n\t},\n\n\t[BQ25601D] = {\n\t\t.model_id = BQ25601D,\n\t\t.bq256xx_regmap_config = &bq25600_regmap_config,\n\t\t.bq256xx_get_ichg = bq256xx_get_ichg_curr,\n\t\t.bq256xx_get_iindpm = bq256xx_get_input_curr_lim,\n\t\t.bq256xx_get_vbatreg = bq25601d_get_chrg_volt,\n\t\t.bq256xx_get_iterm = bq256xx_get_term_curr,\n\t\t.bq256xx_get_iprechg = bq256xx_get_prechrg_curr,\n\t\t.bq256xx_get_vindpm = bq256xx_get_input_volt_lim,\n\n\t\t.bq256xx_set_ichg = bq256xx_set_ichg_curr,\n\t\t.bq256xx_set_iindpm = bq256xx_set_input_curr_lim,\n\t\t.bq256xx_set_vbatreg = bq25601d_set_chrg_volt,\n\t\t.bq256xx_set_iterm = bq256xx_set_term_curr,\n\t\t.bq256xx_set_iprechg = bq256xx_set_prechrg_curr,\n\t\t.bq256xx_set_vindpm = bq256xx_set_input_volt_lim,\n\t\t.bq256xx_set_charge_type = bq256xx_set_charge_type,\n\t\t.bq256xx_set_ts_ignore = NULL,\n\n\t\t.bq256xx_def_ichg = BQ2560X_ICHG_DEF_uA,\n\t\t.bq256xx_def_iindpm = BQ256XX_IINDPM_DEF_uA,\n\t\t.bq256xx_def_vbatreg = BQ2560X_VBATREG_DEF_uV,\n\t\t.bq256xx_def_iterm = BQ256XX_ITERM_DEF_uA,\n\t\t.bq256xx_def_iprechg = BQ256XX_IPRECHG_DEF_uA,\n\t\t.bq256xx_def_vindpm = BQ256XX_VINDPM_DEF_uV,\n\n\t\t.bq256xx_max_ichg = BQ256XX_ICHG_MAX_uA,\n\t\t.bq256xx_max_vbatreg = BQ2560X_VBATREG_MAX_uV,\n\n\t\t.has_usb_detect = true,\n\t},\n\n\t[BQ25611D] = {\n\t\t.model_id = BQ25611D,\n\t\t.bq256xx_regmap_config = &bq25611d_regmap_config,\n\t\t.bq256xx_get_ichg = bq256xx_get_ichg_curr,\n\t\t.bq256xx_get_iindpm = bq256xx_get_input_curr_lim,\n\t\t.bq256xx_get_vbatreg = bq25611d_get_chrg_volt,\n\t\t.bq256xx_get_iterm = bq256xx_get_term_curr,\n\t\t.bq256xx_get_iprechg = bq256xx_get_prechrg_curr,\n\t\t.bq256xx_get_vindpm = bq256xx_get_input_volt_lim,\n\n\t\t.bq256xx_set_ichg = bq256xx_set_ichg_curr,\n\t\t.bq256xx_set_iindpm = bq256xx_set_input_curr_lim,\n\t\t.bq256xx_set_vbatreg = bq25611d_set_chrg_volt,\n\t\t.bq256xx_set_iterm = bq256xx_set_term_curr,\n\t\t.bq256xx_set_iprechg = bq256xx_set_prechrg_curr,\n\t\t.bq256xx_set_vindpm = bq256xx_set_input_volt_lim,\n\t\t.bq256xx_set_charge_type = bq256xx_set_charge_type,\n\t\t.bq256xx_set_ts_ignore = bq256xx_set_ts_ignore,\n\n\t\t.bq256xx_def_ichg = BQ25611D_ICHG_DEF_uA,\n\t\t.bq256xx_def_iindpm = BQ256XX_IINDPM_DEF_uA,\n\t\t.bq256xx_def_vbatreg = BQ25611D_VBATREG_DEF_uV,\n\t\t.bq256xx_def_iterm = BQ256XX_ITERM_DEF_uA,\n\t\t.bq256xx_def_iprechg = BQ256XX_IPRECHG_DEF_uA,\n\t\t.bq256xx_def_vindpm = BQ256XX_VINDPM_DEF_uV,\n\n\t\t.bq256xx_max_ichg = BQ256XX_ICHG_MAX_uA,\n\t\t.bq256xx_max_vbatreg = BQ25611D_VBATREG_MAX_uV,\n\n\t\t.has_usb_detect = true,\n\t},\n\n\t[BQ25618] = {\n\t\t.model_id = BQ25618,\n\t\t.bq256xx_regmap_config = &bq25618_619_regmap_config,\n\t\t.bq256xx_get_ichg = bq25618_619_get_ichg_curr,\n\t\t.bq256xx_get_iindpm = bq256xx_get_input_curr_lim,\n\t\t.bq256xx_get_vbatreg = bq25618_619_get_chrg_volt,\n\t\t.bq256xx_get_iterm = bq25618_619_get_term_curr,\n\t\t.bq256xx_get_iprechg = bq25618_619_get_prechrg_curr,\n\t\t.bq256xx_get_vindpm = bq256xx_get_input_volt_lim,\n\n\t\t.bq256xx_set_ichg = bq25618_619_set_ichg_curr,\n\t\t.bq256xx_set_iindpm = bq256xx_set_input_curr_lim,\n\t\t.bq256xx_set_vbatreg = bq25618_619_set_chrg_volt,\n\t\t.bq256xx_set_iterm = bq25618_619_set_term_curr,\n\t\t.bq256xx_set_iprechg = bq25618_619_set_prechrg_curr,\n\t\t.bq256xx_set_vindpm = bq256xx_set_input_volt_lim,\n\t\t.bq256xx_set_charge_type = bq256xx_set_charge_type,\n\t\t.bq256xx_set_ts_ignore = bq256xx_set_ts_ignore,\n\n\t\t.bq256xx_def_ichg = BQ25618_ICHG_DEF_uA,\n\t\t.bq256xx_def_iindpm = BQ256XX_IINDPM_DEF_uA,\n\t\t.bq256xx_def_vbatreg = BQ25618_VBATREG_DEF_uV,\n\t\t.bq256xx_def_iterm = BQ25618_ITERM_DEF_uA,\n\t\t.bq256xx_def_iprechg = BQ25618_IPRECHG_DEF_uA,\n\t\t.bq256xx_def_vindpm = BQ256XX_VINDPM_DEF_uV,\n\n\t\t.bq256xx_max_ichg = BQ25618_ICHG_MAX_uA,\n\t\t.bq256xx_max_vbatreg = BQ25618_VBATREG_MAX_uV,\n\n\t\t.has_usb_detect = false,\n\t},\n\n\t[BQ25619] = {\n\t\t.model_id = BQ25619,\n\t\t.bq256xx_regmap_config = &bq25618_619_regmap_config,\n\t\t.bq256xx_get_ichg = bq25618_619_get_ichg_curr,\n\t\t.bq256xx_get_iindpm = bq256xx_get_input_curr_lim,\n\t\t.bq256xx_get_vbatreg = bq25618_619_get_chrg_volt,\n\t\t.bq256xx_get_iterm = bq25618_619_get_term_curr,\n\t\t.bq256xx_get_iprechg = bq25618_619_get_prechrg_curr,\n\t\t.bq256xx_get_vindpm = bq256xx_get_input_volt_lim,\n\n\t\t.bq256xx_set_ichg = bq25618_619_set_ichg_curr,\n\t\t.bq256xx_set_iindpm = bq256xx_set_input_curr_lim,\n\t\t.bq256xx_set_vbatreg = bq25618_619_set_chrg_volt,\n\t\t.bq256xx_set_iterm = bq25618_619_set_term_curr,\n\t\t.bq256xx_set_iprechg = bq25618_619_set_prechrg_curr,\n\t\t.bq256xx_set_vindpm = bq256xx_set_input_volt_lim,\n\t\t.bq256xx_set_charge_type = bq256xx_set_charge_type,\n\t\t.bq256xx_set_ts_ignore = bq256xx_set_ts_ignore,\n\n\t\t.bq256xx_def_ichg = BQ25618_ICHG_DEF_uA,\n\t\t.bq256xx_def_iindpm = BQ256XX_IINDPM_DEF_uA,\n\t\t.bq256xx_def_vbatreg = BQ25618_VBATREG_DEF_uV,\n\t\t.bq256xx_def_iterm = BQ25618_ITERM_DEF_uA,\n\t\t.bq256xx_def_iprechg = BQ25618_IPRECHG_DEF_uA,\n\t\t.bq256xx_def_vindpm = BQ256XX_VINDPM_DEF_uV,\n\n\t\t.bq256xx_max_ichg = BQ25618_ICHG_MAX_uA,\n\t\t.bq256xx_max_vbatreg = BQ25618_VBATREG_MAX_uV,\n\n\t\t.has_usb_detect = false,\n\t},\n};\n\nstatic int bq256xx_power_supply_init(struct bq256xx_device *bq,\n\t\tstruct power_supply_config *psy_cfg, struct device *dev)\n{\n\tbq->charger = devm_power_supply_register(bq->dev,\n\t\t\t\t\t\t &bq256xx_power_supply_desc,\n\t\t\t\t\t\t psy_cfg);\n\tif (IS_ERR(bq->charger)) {\n\t\tdev_err(dev, \"power supply register charger failed\\n\");\n\t\treturn PTR_ERR(bq->charger);\n\t}\n\n\tbq->battery = devm_power_supply_register(bq->dev,\n\t\t\t\t\t\t      &bq256xx_battery_desc,\n\t\t\t\t\t\t      psy_cfg);\n\tif (IS_ERR(bq->battery)) {\n\t\tdev_err(dev, \"power supply register battery failed\\n\");\n\t\treturn PTR_ERR(bq->battery);\n\t}\n\treturn 0;\n}\n\nstatic int bq256xx_hw_init(struct bq256xx_device *bq)\n{\n\tstruct power_supply_battery_info *bat_info;\n\tint wd_reg_val = BQ256XX_WATCHDOG_DIS;\n\tint ret = 0;\n\tint i;\n\n\tfor (i = 0; i < BQ256XX_NUM_WD_VAL; i++) {\n\t\tif (bq->watchdog_timer == bq256xx_watchdog_time[i]) {\n\t\t\twd_reg_val = i;\n\t\t\tbreak;\n\t\t}\n\t\tif (i + 1 < BQ256XX_NUM_WD_VAL &&\n\t\t    bq->watchdog_timer > bq256xx_watchdog_time[i] &&\n\t\t    bq->watchdog_timer < bq256xx_watchdog_time[i + 1])\n\t\t\twd_reg_val = i;\n\t}\n\tret = regmap_update_bits(bq->regmap, BQ256XX_CHARGER_CONTROL_1,\n\t\t\t\t BQ256XX_WATCHDOG_MASK, wd_reg_val <<\n\t\t\t\t\t\tBQ256XX_WDT_BIT_SHIFT);\n\tif (ret)\n\t\treturn ret;\n\n\tret = power_supply_get_battery_info(bq->charger, &bat_info);\n\tif (ret == -ENOMEM)\n\t\treturn ret;\n\n\tif (ret) {\n\t\tdev_warn(bq->dev, \"battery info missing, default values will be applied\\n\");\n\n\t\tbat_info->constant_charge_current_max_ua =\n\t\t\t\tbq->chip_info->bq256xx_def_ichg;\n\n\t\tbat_info->constant_charge_voltage_max_uv =\n\t\t\t\tbq->chip_info->bq256xx_def_vbatreg;\n\n\t\tbat_info->precharge_current_ua =\n\t\t\t\tbq->chip_info->bq256xx_def_iprechg;\n\n\t\tbat_info->charge_term_current_ua =\n\t\t\t\tbq->chip_info->bq256xx_def_iterm;\n\n\t\tbq->init_data.ichg_max =\n\t\t\t\tbq->chip_info->bq256xx_max_ichg;\n\n\t\tbq->init_data.vbatreg_max =\n\t\t\t\tbq->chip_info->bq256xx_max_vbatreg;\n\t} else {\n\t\tbq->init_data.ichg_max =\n\t\t\tbat_info->constant_charge_current_max_ua;\n\n\t\tbq->init_data.vbatreg_max =\n\t\t\tbat_info->constant_charge_voltage_max_uv;\n\t}\n\n\tret = bq->chip_info->bq256xx_set_vindpm(bq, bq->init_data.vindpm);\n\tif (ret)\n\t\treturn ret;\n\n\tret = bq->chip_info->bq256xx_set_iindpm(bq, bq->init_data.iindpm);\n\tif (ret)\n\t\treturn ret;\n\n\tret = bq->chip_info->bq256xx_set_ichg(bq,\n\t\t\t\tbq->chip_info->bq256xx_def_ichg);\n\tif (ret)\n\t\treturn ret;\n\n\tret = bq->chip_info->bq256xx_set_iprechg(bq,\n\t\t\t\tbat_info->precharge_current_ua);\n\tif (ret)\n\t\treturn ret;\n\n\tret = bq->chip_info->bq256xx_set_vbatreg(bq,\n\t\t\t\tbq->chip_info->bq256xx_def_vbatreg);\n\tif (ret)\n\t\treturn ret;\n\n\tret = bq->chip_info->bq256xx_set_iterm(bq,\n\t\t\t\tbat_info->charge_term_current_ua);\n\tif (ret)\n\t\treturn ret;\n\n\tif (bq->chip_info->bq256xx_set_ts_ignore) {\n\t\tret = bq->chip_info->bq256xx_set_ts_ignore(bq, bq->init_data.ts_ignore);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tpower_supply_put_battery_info(bq->charger, bat_info);\n\n\treturn 0;\n}\n\nstatic int bq256xx_parse_dt(struct bq256xx_device *bq,\n\t\tstruct power_supply_config *psy_cfg, struct device *dev)\n{\n\tint ret = 0;\n\n\tpsy_cfg->drv_data = bq;\n\tpsy_cfg->of_node = dev->of_node;\n\n\tret = device_property_read_u32(bq->dev, \"ti,watchdog-timeout-ms\",\n\t\t\t\t       &bq->watchdog_timer);\n\tif (ret)\n\t\tbq->watchdog_timer = BQ256XX_WATCHDOG_DIS;\n\n\tif (bq->watchdog_timer > BQ256XX_WATCHDOG_MAX ||\n\t    bq->watchdog_timer < BQ256XX_WATCHDOG_DIS)\n\t\treturn -EINVAL;\n\n\tret = device_property_read_u32(bq->dev,\n\t\t\t\t       \"input-voltage-limit-microvolt\",\n\t\t\t\t       &bq->init_data.vindpm);\n\tif (ret)\n\t\tbq->init_data.vindpm = bq->chip_info->bq256xx_def_vindpm;\n\n\tret = device_property_read_u32(bq->dev,\n\t\t\t\t       \"input-current-limit-microamp\",\n\t\t\t\t       &bq->init_data.iindpm);\n\tif (ret)\n\t\tbq->init_data.iindpm = bq->chip_info->bq256xx_def_iindpm;\n\n\tbq->init_data.ts_ignore = device_property_read_bool(bq->dev, \"ti,no-thermistor\");\n\n\treturn 0;\n}\n\nstatic int bq256xx_probe(struct i2c_client *client)\n{\n\tconst struct i2c_device_id *id = i2c_client_get_device_id(client);\n\tstruct device *dev = &client->dev;\n\tstruct bq256xx_device *bq;\n\tstruct power_supply_config psy_cfg = { };\n\n\tint ret;\n\n\tbq = devm_kzalloc(dev, sizeof(*bq), GFP_KERNEL);\n\tif (!bq)\n\t\treturn -ENOMEM;\n\n\tbq->client = client;\n\tbq->dev = dev;\n\tbq->chip_info = &bq256xx_chip_info_tbl[id->driver_data];\n\n\tmutex_init(&bq->lock);\n\n\tstrncpy(bq->model_name, id->name, I2C_NAME_SIZE);\n\n\tbq->regmap = devm_regmap_init_i2c(client,\n\t\t\t\t\tbq->chip_info->bq256xx_regmap_config);\n\n\tif (IS_ERR(bq->regmap)) {\n\t\tdev_err(dev, \"Failed to allocate register map\\n\");\n\t\treturn PTR_ERR(bq->regmap);\n\t}\n\n\ti2c_set_clientdata(client, bq);\n\n\tret = bq256xx_parse_dt(bq, &psy_cfg, dev);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to read device tree properties%d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = devm_add_action_or_reset(dev, bq256xx_charger_reset, bq);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tbq->usb2_phy = devm_usb_get_phy(dev, USB_PHY_TYPE_USB2);\n\tif (!IS_ERR_OR_NULL(bq->usb2_phy)) {\n\t\tINIT_WORK(&bq->usb_work, bq256xx_usb_work);\n\t\tbq->usb_nb.notifier_call = bq256xx_usb_notifier;\n\t\tusb_register_notifier(bq->usb2_phy, &bq->usb_nb);\n\t}\n\n\tbq->usb3_phy = devm_usb_get_phy(dev, USB_PHY_TYPE_USB3);\n\tif (!IS_ERR_OR_NULL(bq->usb3_phy)) {\n\t\tINIT_WORK(&bq->usb_work, bq256xx_usb_work);\n\t\tbq->usb_nb.notifier_call = bq256xx_usb_notifier;\n\t\tusb_register_notifier(bq->usb3_phy, &bq->usb_nb);\n\t}\n\n\tif (client->irq) {\n\t\tret = devm_request_threaded_irq(dev, client->irq, NULL,\n\t\t\t\t\t\tbq256xx_irq_handler_thread,\n\t\t\t\t\t\tIRQF_TRIGGER_FALLING |\n\t\t\t\t\t\tIRQF_ONESHOT,\n\t\t\t\t\t\tdev_name(&client->dev), bq);\n\t\tif (ret < 0) {\n\t\t\tdev_err(dev, \"get irq fail: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tret = bq256xx_power_supply_init(bq, &psy_cfg, dev);\n\tif (ret) {\n\t\tdev_err(dev, \"Failed to register power supply\\n\");\n\t\treturn ret;\n\t}\n\n\tret = bq256xx_hw_init(bq);\n\tif (ret) {\n\t\tdev_err(dev, \"Cannot initialize the chip.\\n\");\n\t\treturn ret;\n\t}\n\n\treturn ret;\n}\n\nstatic const struct i2c_device_id bq256xx_i2c_ids[] = {\n\t{ \"bq25600\", BQ25600 },\n\t{ \"bq25600d\", BQ25600D },\n\t{ \"bq25601\", BQ25601 },\n\t{ \"bq25601d\", BQ25601D },\n\t{ \"bq25611d\", BQ25611D },\n\t{ \"bq25618\", BQ25618 },\n\t{ \"bq25619\", BQ25619 },\n\t{},\n};\nMODULE_DEVICE_TABLE(i2c, bq256xx_i2c_ids);\n\nstatic const struct of_device_id bq256xx_of_match[] = {\n\t{ .compatible = \"ti,bq25600\", .data = (void *)BQ25600 },\n\t{ .compatible = \"ti,bq25600d\", .data = (void *)BQ25600D },\n\t{ .compatible = \"ti,bq25601\", .data = (void *)BQ25601 },\n\t{ .compatible = \"ti,bq25601d\", .data = (void *)BQ25601D },\n\t{ .compatible = \"ti,bq25611d\", .data = (void *)BQ25611D },\n\t{ .compatible = \"ti,bq25618\", .data = (void *)BQ25618 },\n\t{ .compatible = \"ti,bq25619\", .data = (void *)BQ25619 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, bq256xx_of_match);\n\nstatic const struct acpi_device_id bq256xx_acpi_match[] = {\n\t{ \"bq25600\", BQ25600 },\n\t{ \"bq25600d\", BQ25600D },\n\t{ \"bq25601\", BQ25601 },\n\t{ \"bq25601d\", BQ25601D },\n\t{ \"bq25611d\", BQ25611D },\n\t{ \"bq25618\", BQ25618 },\n\t{ \"bq25619\", BQ25619 },\n\t{},\n};\nMODULE_DEVICE_TABLE(acpi, bq256xx_acpi_match);\n\nstatic struct i2c_driver bq256xx_driver = {\n\t.driver = {\n\t\t.name = \"bq256xx-charger\",\n\t\t.of_match_table = bq256xx_of_match,\n\t\t.acpi_match_table = bq256xx_acpi_match,\n\t},\n\t.probe = bq256xx_probe,\n\t.id_table = bq256xx_i2c_ids,\n};\nmodule_i2c_driver(bq256xx_driver);\n\nMODULE_AUTHOR(\"Ricardo Rivera-Matos <r-rivera-matos@ti.com>\");\nMODULE_DESCRIPTION(\"bq256xx charger driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}