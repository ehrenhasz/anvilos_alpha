{
  "module_name": "wm8350_power.c",
  "hash_id": "226e21ef1bed7eda24163d3de4efe5491b33ac08ff8c00bcb5cd0e6ea90b1152",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/wm8350_power.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/err.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/mfd/wm8350/supply.h>\n#include <linux/mfd/wm8350/core.h>\n#include <linux/mfd/wm8350/comparator.h>\n\nstatic int wm8350_read_battery_uvolts(struct wm8350 *wm8350)\n{\n\treturn wm8350_read_auxadc(wm8350, WM8350_AUXADC_BATT, 0, 0)\n\t\t* WM8350_AUX_COEFF;\n}\n\nstatic int wm8350_read_line_uvolts(struct wm8350 *wm8350)\n{\n\treturn wm8350_read_auxadc(wm8350, WM8350_AUXADC_LINE, 0, 0)\n\t\t* WM8350_AUX_COEFF;\n}\n\nstatic int wm8350_read_usb_uvolts(struct wm8350 *wm8350)\n{\n\treturn wm8350_read_auxadc(wm8350, WM8350_AUXADC_USB, 0, 0)\n\t\t* WM8350_AUX_COEFF;\n}\n\n#define WM8350_BATT_SUPPLY\t1\n#define WM8350_USB_SUPPLY\t2\n#define WM8350_LINE_SUPPLY\t4\n\nstatic inline int wm8350_charge_time_min(struct wm8350 *wm8350, int min)\n{\n\tif (!wm8350->power.rev_g_coeff)\n\t\treturn (((min - 30) / 15) & 0xf) << 8;\n\telse\n\t\treturn (((min - 30) / 30) & 0xf) << 8;\n}\n\nstatic int wm8350_get_supplies(struct wm8350 *wm8350)\n{\n\tu16 sm, ov, co, chrg;\n\tint supplies = 0;\n\n\tsm = wm8350_reg_read(wm8350, WM8350_STATE_MACHINE_STATUS);\n\tov = wm8350_reg_read(wm8350, WM8350_MISC_OVERRIDES);\n\tco = wm8350_reg_read(wm8350, WM8350_COMPARATOR_OVERRIDES);\n\tchrg = wm8350_reg_read(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2);\n\n\t \n\tsm = (sm & WM8350_USB_SM_MASK) >> WM8350_USB_SM_SHIFT;\n\n\t \n\tchrg &= WM8350_CHG_ISEL_MASK;\n\n\t \n\tif (((sm == WM8350_USB_SM_100_SLV) ||\n\t     (sm == WM8350_USB_SM_500_SLV) ||\n\t     (sm == WM8350_USB_SM_STDBY_SLV))\n\t    && !(ov & WM8350_USB_LIMIT_OVRDE))\n\t\tsupplies = WM8350_USB_SUPPLY;\n\telse if (((sm == WM8350_USB_SM_100_SLV) ||\n\t\t  (sm == WM8350_USB_SM_500_SLV) ||\n\t\t  (sm == WM8350_USB_SM_STDBY_SLV))\n\t\t && (ov & WM8350_USB_LIMIT_OVRDE) && (chrg == 0))\n\t\tsupplies = WM8350_USB_SUPPLY | WM8350_BATT_SUPPLY;\n\telse if (co & WM8350_WALL_FB_OVRDE)\n\t\tsupplies = WM8350_LINE_SUPPLY;\n\telse\n\t\tsupplies = WM8350_BATT_SUPPLY;\n\n\treturn supplies;\n}\n\nstatic int wm8350_charger_config(struct wm8350 *wm8350,\n\t\t\t\t struct wm8350_charger_policy *policy)\n{\n\tu16 reg, eoc_mA, fast_limit_mA;\n\n\tif (!policy) {\n\t\tdev_warn(wm8350->dev,\n\t\t\t \"No charger policy, charger not configured.\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\t \n\tif (policy->fast_limit_USB_mA > 500) {\n\t\tdev_err(wm8350->dev, \"USB fast charge > 500mA\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\teoc_mA = WM8350_CHG_EOC_mA(policy->eoc_mA);\n\n\twm8350_reg_unlock(wm8350);\n\n\treg = wm8350_reg_read(wm8350, WM8350_BATTERY_CHARGER_CONTROL_1)\n\t\t& WM8350_CHG_ENA_R168;\n\twm8350_reg_write(wm8350, WM8350_BATTERY_CHARGER_CONTROL_1,\n\t\t\t reg | eoc_mA | policy->trickle_start_mV |\n\t\t\t WM8350_CHG_TRICKLE_TEMP_CHOKE |\n\t\t\t WM8350_CHG_TRICKLE_USB_CHOKE |\n\t\t\t WM8350_CHG_FAST_USB_THROTTLE);\n\n\tif (wm8350_get_supplies(wm8350) & WM8350_USB_SUPPLY) {\n\t\tfast_limit_mA =\n\t\t\tWM8350_CHG_FAST_LIMIT_mA(policy->fast_limit_USB_mA);\n\t\twm8350_reg_write(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2,\n\t\t\t    policy->charge_mV | policy->trickle_charge_USB_mA |\n\t\t\t    fast_limit_mA | wm8350_charge_time_min(wm8350,\n\t\t\t\t\t\tpolicy->charge_timeout));\n\n\t} else {\n\t\tfast_limit_mA =\n\t\t\tWM8350_CHG_FAST_LIMIT_mA(policy->fast_limit_mA);\n\t\twm8350_reg_write(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2,\n\t\t\t    policy->charge_mV | policy->trickle_charge_mA |\n\t\t\t    fast_limit_mA | wm8350_charge_time_min(wm8350,\n\t\t\t\t\t\tpolicy->charge_timeout));\n\t}\n\n\twm8350_reg_lock(wm8350);\n\treturn 0;\n}\n\nstatic int wm8350_batt_status(struct wm8350 *wm8350)\n{\n\tu16 state;\n\n\tstate = wm8350_reg_read(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2);\n\tstate &= WM8350_CHG_STS_MASK;\n\n\tswitch (state) {\n\tcase WM8350_CHG_STS_OFF:\n\t\treturn POWER_SUPPLY_STATUS_DISCHARGING;\n\n\tcase WM8350_CHG_STS_TRICKLE:\n\tcase WM8350_CHG_STS_FAST:\n\t\treturn POWER_SUPPLY_STATUS_CHARGING;\n\n\tdefault:\n\t\treturn POWER_SUPPLY_STATUS_UNKNOWN;\n\t}\n}\n\nstatic ssize_t charger_state_show(struct device *dev,\n\t\t\t\t struct device_attribute *attr, char *buf)\n{\n\tstruct wm8350 *wm8350 = dev_get_drvdata(dev);\n\tchar *charge;\n\tint state;\n\n\tstate = wm8350_reg_read(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2) &\n\t    WM8350_CHG_STS_MASK;\n\tswitch (state) {\n\tcase WM8350_CHG_STS_OFF:\n\t\tcharge = \"Charger Off\";\n\t\tbreak;\n\tcase WM8350_CHG_STS_TRICKLE:\n\t\tcharge = \"Trickle Charging\";\n\t\tbreak;\n\tcase WM8350_CHG_STS_FAST:\n\t\tcharge = \"Fast Charging\";\n\t\tbreak;\n\tdefault:\n\t\treturn 0;\n\t}\n\n\treturn sysfs_emit(buf, \"%s\\n\", charge);\n}\n\nstatic DEVICE_ATTR_RO(charger_state);\n\nstatic irqreturn_t wm8350_charger_handler(int irq, void *data)\n{\n\tstruct wm8350 *wm8350 = data;\n\tstruct wm8350_power *power = &wm8350->power;\n\tstruct wm8350_charger_policy *policy = power->policy;\n\n\tswitch (irq - wm8350->irq_base) {\n\tcase WM8350_IRQ_CHG_BAT_FAIL:\n\t\tdev_err(wm8350->dev, \"battery failed\\n\");\n\t\tbreak;\n\tcase WM8350_IRQ_CHG_TO:\n\t\tdev_err(wm8350->dev, \"charger timeout\\n\");\n\t\tpower_supply_changed(power->battery);\n\t\tbreak;\n\n\tcase WM8350_IRQ_CHG_BAT_HOT:\n\tcase WM8350_IRQ_CHG_BAT_COLD:\n\tcase WM8350_IRQ_CHG_START:\n\tcase WM8350_IRQ_CHG_END:\n\t\tpower_supply_changed(power->battery);\n\t\tbreak;\n\n\tcase WM8350_IRQ_CHG_FAST_RDY:\n\t\tdev_dbg(wm8350->dev, \"fast charger ready\\n\");\n\t\twm8350_charger_config(wm8350, policy);\n\t\twm8350_reg_unlock(wm8350);\n\t\twm8350_set_bits(wm8350, WM8350_BATTERY_CHARGER_CONTROL_1,\n\t\t\t\tWM8350_CHG_FAST);\n\t\twm8350_reg_lock(wm8350);\n\t\tbreak;\n\n\tcase WM8350_IRQ_CHG_VBATT_LT_3P9:\n\t\tdev_warn(wm8350->dev, \"battery < 3.9V\\n\");\n\t\tbreak;\n\tcase WM8350_IRQ_CHG_VBATT_LT_3P1:\n\t\tdev_warn(wm8350->dev, \"battery < 3.1V\\n\");\n\t\tbreak;\n\tcase WM8350_IRQ_CHG_VBATT_LT_2P85:\n\t\tdev_warn(wm8350->dev, \"battery < 2.85V\\n\");\n\t\tbreak;\n\n\t\t \n\tcase WM8350_IRQ_EXT_USB_FB:\n\tcase WM8350_IRQ_EXT_WALL_FB:\n\t\twm8350_charger_config(wm8350, policy);\n\t\tfallthrough;\n\tcase WM8350_IRQ_EXT_BAT_FB:\n\t\tpower_supply_changed(power->battery);\n\t\tpower_supply_changed(power->usb);\n\t\tpower_supply_changed(power->ac);\n\t\tbreak;\n\n\tdefault:\n\t\tdev_err(wm8350->dev, \"Unknown interrupt %d\\n\", irq);\n\t}\n\n\treturn IRQ_HANDLED;\n}\n\n \nstatic int wm8350_ac_get_prop(struct power_supply *psy,\n\t\t\t      enum power_supply_property psp,\n\t\t\t      union power_supply_propval *val)\n{\n\tstruct wm8350 *wm8350 = dev_get_drvdata(psy->dev.parent);\n\tint ret = 0;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = !!(wm8350_get_supplies(wm8350) &\n\t\t\t\t WM8350_LINE_SUPPLY);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tval->intval = wm8350_read_line_uvolts(wm8350);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic enum power_supply_property wm8350_ac_props[] = {\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n};\n\n \nstatic int wm8350_usb_get_prop(struct power_supply *psy,\n\t\t\t       enum power_supply_property psp,\n\t\t\t       union power_supply_propval *val)\n{\n\tstruct wm8350 *wm8350 = dev_get_drvdata(psy->dev.parent);\n\tint ret = 0;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = !!(wm8350_get_supplies(wm8350) &\n\t\t\t\t WM8350_USB_SUPPLY);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tval->intval = wm8350_read_usb_uvolts(wm8350);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic enum power_supply_property wm8350_usb_props[] = {\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n};\n\n \n\nstatic int wm8350_bat_check_health(struct wm8350 *wm8350)\n{\n\tu16 reg;\n\n\tif (wm8350_read_battery_uvolts(wm8350) < 2850000)\n\t\treturn POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\n\treg = wm8350_reg_read(wm8350, WM8350_CHARGER_OVERRIDES);\n\tif (reg & WM8350_CHG_BATT_HOT_OVRDE)\n\t\treturn POWER_SUPPLY_HEALTH_OVERHEAT;\n\n\tif (reg & WM8350_CHG_BATT_COLD_OVRDE)\n\t\treturn POWER_SUPPLY_HEALTH_COLD;\n\n\treturn POWER_SUPPLY_HEALTH_GOOD;\n}\n\nstatic int wm8350_bat_get_charge_type(struct wm8350 *wm8350)\n{\n\tint state;\n\n\tstate = wm8350_reg_read(wm8350, WM8350_BATTERY_CHARGER_CONTROL_2) &\n\t    WM8350_CHG_STS_MASK;\n\tswitch (state) {\n\tcase WM8350_CHG_STS_OFF:\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_NONE;\n\tcase WM8350_CHG_STS_TRICKLE:\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\n\tcase WM8350_CHG_STS_FAST:\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_FAST;\n\tdefault:\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_UNKNOWN;\n\t}\n}\n\nstatic int wm8350_bat_get_property(struct power_supply *psy,\n\t\t\t\t   enum power_supply_property psp,\n\t\t\t\t   union power_supply_propval *val)\n{\n\tstruct wm8350 *wm8350 = dev_get_drvdata(psy->dev.parent);\n\tint ret = 0;\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tval->intval = wm8350_batt_status(wm8350);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = !!(wm8350_get_supplies(wm8350) &\n\t\t\t\t WM8350_BATT_SUPPLY);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tval->intval = wm8350_read_battery_uvolts(wm8350);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tval->intval = wm8350_bat_check_health(wm8350);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\tval->intval = wm8350_bat_get_charge_type(wm8350);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\n\treturn ret;\n}\n\nstatic enum power_supply_property wm8350_bat_props[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_CHARGE_TYPE,\n};\n\nstatic const struct power_supply_desc wm8350_ac_desc = {\n\t.name\t\t= \"wm8350-ac\",\n\t.type\t\t= POWER_SUPPLY_TYPE_MAINS,\n\t.properties\t= wm8350_ac_props,\n\t.num_properties\t= ARRAY_SIZE(wm8350_ac_props),\n\t.get_property\t= wm8350_ac_get_prop,\n};\n\nstatic const struct power_supply_desc wm8350_battery_desc = {\n\t.name\t\t= \"wm8350-battery\",\n\t.properties\t= wm8350_bat_props,\n\t.num_properties\t= ARRAY_SIZE(wm8350_bat_props),\n\t.get_property\t= wm8350_bat_get_property,\n\t.use_for_apm\t= 1,\n};\n\nstatic const struct power_supply_desc wm8350_usb_desc = {\n\t.name\t\t= \"wm8350-usb\",\n\t.type\t\t= POWER_SUPPLY_TYPE_USB,\n\t.properties\t= wm8350_usb_props,\n\t.num_properties\t= ARRAY_SIZE(wm8350_usb_props),\n\t.get_property\t= wm8350_usb_get_prop,\n};\n\n \n\nstatic int wm8350_init_charger(struct wm8350 *wm8350)\n{\n\tint ret;\n\n\t \n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_CHG_BAT_HOT,\n\t\t\t    wm8350_charger_handler, 0, \"Battery hot\", wm8350);\n\tif (ret)\n\t\tgoto err;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_CHG_BAT_COLD,\n\t\t\t    wm8350_charger_handler, 0, \"Battery cold\", wm8350);\n\tif (ret)\n\t\tgoto free_chg_bat_hot;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_CHG_BAT_FAIL,\n\t\t\t    wm8350_charger_handler, 0, \"Battery fail\", wm8350);\n\tif (ret)\n\t\tgoto free_chg_bat_cold;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_CHG_TO,\n\t\t\t    wm8350_charger_handler, 0,\n\t\t\t    \"Charger timeout\", wm8350);\n\tif (ret)\n\t\tgoto free_chg_bat_fail;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_CHG_END,\n\t\t\t    wm8350_charger_handler, 0,\n\t\t\t    \"Charge end\", wm8350);\n\tif (ret)\n\t\tgoto free_chg_to;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_CHG_START,\n\t\t\t    wm8350_charger_handler, 0,\n\t\t\t    \"Charge start\", wm8350);\n\tif (ret)\n\t\tgoto free_chg_end;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_CHG_FAST_RDY,\n\t\t\t    wm8350_charger_handler, 0,\n\t\t\t    \"Fast charge ready\", wm8350);\n\tif (ret)\n\t\tgoto free_chg_start;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_3P9,\n\t\t\t    wm8350_charger_handler, 0,\n\t\t\t    \"Battery <3.9V\", wm8350);\n\tif (ret)\n\t\tgoto free_chg_fast_rdy;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_3P1,\n\t\t\t    wm8350_charger_handler, 0,\n\t\t\t    \"Battery <3.1V\", wm8350);\n\tif (ret)\n\t\tgoto free_chg_vbatt_lt_3p9;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_2P85,\n\t\t\t    wm8350_charger_handler, 0,\n\t\t\t    \"Battery <2.85V\", wm8350);\n\tif (ret)\n\t\tgoto free_chg_vbatt_lt_3p1;\n\n\t \n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_EXT_USB_FB,\n\t\t\t    wm8350_charger_handler, 0, \"USB\", wm8350);\n\tif (ret)\n\t\tgoto free_chg_vbatt_lt_2p85;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_EXT_WALL_FB,\n\t\t\t    wm8350_charger_handler, 0, \"Wall\", wm8350);\n\tif (ret)\n\t\tgoto free_ext_usb_fb;\n\n\tret = wm8350_register_irq(wm8350, WM8350_IRQ_EXT_BAT_FB,\n\t\t\t    wm8350_charger_handler, 0, \"Battery\", wm8350);\n\tif (ret)\n\t\tgoto free_ext_wall_fb;\n\n\treturn 0;\n\nfree_ext_wall_fb:\n\twm8350_free_irq(wm8350, WM8350_IRQ_EXT_WALL_FB, wm8350);\nfree_ext_usb_fb:\n\twm8350_free_irq(wm8350, WM8350_IRQ_EXT_USB_FB, wm8350);\nfree_chg_vbatt_lt_2p85:\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_2P85, wm8350);\nfree_chg_vbatt_lt_3p1:\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_3P1, wm8350);\nfree_chg_vbatt_lt_3p9:\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_3P9, wm8350);\nfree_chg_fast_rdy:\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_FAST_RDY, wm8350);\nfree_chg_start:\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_START, wm8350);\nfree_chg_end:\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_END, wm8350);\nfree_chg_to:\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_TO, wm8350);\nfree_chg_bat_fail:\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_BAT_FAIL, wm8350);\nfree_chg_bat_cold:\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_BAT_COLD, wm8350);\nfree_chg_bat_hot:\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_BAT_HOT, wm8350);\nerr:\n\treturn ret;\n}\n\nstatic void free_charger_irq(struct wm8350 *wm8350)\n{\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_BAT_HOT, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_BAT_COLD, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_BAT_FAIL, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_TO, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_END, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_START, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_FAST_RDY, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_3P9, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_3P1, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_CHG_VBATT_LT_2P85, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_EXT_USB_FB, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_EXT_WALL_FB, wm8350);\n\twm8350_free_irq(wm8350, WM8350_IRQ_EXT_BAT_FB, wm8350);\n}\n\nstatic int wm8350_power_probe(struct platform_device *pdev)\n{\n\tstruct wm8350 *wm8350 = platform_get_drvdata(pdev);\n\tstruct wm8350_power *power = &wm8350->power;\n\tstruct wm8350_charger_policy *policy = power->policy;\n\tint ret;\n\n\tpower->ac = power_supply_register(&pdev->dev, &wm8350_ac_desc, NULL);\n\tif (IS_ERR(power->ac))\n\t\treturn PTR_ERR(power->ac);\n\n\tpower->battery = power_supply_register(&pdev->dev, &wm8350_battery_desc,\n\t\t\t\t\t       NULL);\n\tif (IS_ERR(power->battery)) {\n\t\tret = PTR_ERR(power->battery);\n\t\tgoto battery_failed;\n\t}\n\n\tpower->usb = power_supply_register(&pdev->dev, &wm8350_usb_desc, NULL);\n\tif (IS_ERR(power->usb)) {\n\t\tret = PTR_ERR(power->usb);\n\t\tgoto usb_failed;\n\t}\n\n\tret = device_create_file(&pdev->dev, &dev_attr_charger_state);\n\tif (ret < 0)\n\t\tdev_warn(wm8350->dev, \"failed to add charge sysfs: %d\\n\", ret);\n\tret = 0;\n\n\twm8350_init_charger(wm8350);\n\tif (wm8350_charger_config(wm8350, policy) == 0) {\n\t\twm8350_reg_unlock(wm8350);\n\t\twm8350_set_bits(wm8350, WM8350_POWER_MGMT_5, WM8350_CHG_ENA);\n\t\twm8350_reg_lock(wm8350);\n\t}\n\n\treturn ret;\n\nusb_failed:\n\tpower_supply_unregister(power->battery);\nbattery_failed:\n\tpower_supply_unregister(power->ac);\n\n\treturn ret;\n}\n\nstatic int wm8350_power_remove(struct platform_device *pdev)\n{\n\tstruct wm8350 *wm8350 = platform_get_drvdata(pdev);\n\tstruct wm8350_power *power = &wm8350->power;\n\n\tfree_charger_irq(wm8350);\n\tdevice_remove_file(&pdev->dev, &dev_attr_charger_state);\n\tpower_supply_unregister(power->battery);\n\tpower_supply_unregister(power->ac);\n\tpower_supply_unregister(power->usb);\n\treturn 0;\n}\n\nstatic struct platform_driver wm8350_power_driver = {\n\t.probe = wm8350_power_probe,\n\t.remove = wm8350_power_remove,\n\t.driver = {\n\t\t.name = \"wm8350-power\",\n\t},\n};\n\nmodule_platform_driver(wm8350_power_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"Power supply driver for WM8350\");\nMODULE_ALIAS(\"platform:wm8350-power\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}