{
  "module_name": "twl4030_madc_battery.c",
  "hash_id": "be159d8805873e89b84adf474149fdd9a7e7a6765e714c4a2f8f72b7922f64f1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/twl4030_madc_battery.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/param.h>\n#include <linux/delay.h>\n#include <linux/workqueue.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n#include <linux/slab.h>\n#include <linux/sort.h>\n#include <linux/power/twl4030_madc_battery.h>\n#include <linux/iio/consumer.h>\n\nstruct twl4030_madc_battery {\n\tstruct power_supply *psy;\n\tstruct twl4030_madc_bat_platform_data *pdata;\n\tstruct iio_channel *channel_temp;\n\tstruct iio_channel *channel_ichg;\n\tstruct iio_channel *channel_vbat;\n};\n\nstatic enum power_supply_property twl4030_madc_bat_props[] = {\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_CHARGE_FULL,\n\tPOWER_SUPPLY_PROP_CHARGE_NOW,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW,\n};\n\nstatic int madc_read(struct iio_channel *channel)\n{\n\tint val, err;\n\terr = iio_read_channel_processed(channel, &val);\n\tif (err < 0)\n\t\treturn err;\n\n\treturn val;\n}\n\nstatic int twl4030_madc_bat_get_charging_status(struct twl4030_madc_battery *bt)\n{\n\treturn (madc_read(bt->channel_ichg) > 0) ? 1 : 0;\n}\n\nstatic int twl4030_madc_bat_get_voltage(struct twl4030_madc_battery *bt)\n{\n\treturn madc_read(bt->channel_vbat);\n}\n\nstatic int twl4030_madc_bat_get_current(struct twl4030_madc_battery *bt)\n{\n\treturn madc_read(bt->channel_ichg) * 1000;\n}\n\nstatic int twl4030_madc_bat_get_temp(struct twl4030_madc_battery *bt)\n{\n\treturn madc_read(bt->channel_temp) * 10;\n}\n\nstatic int twl4030_madc_bat_voltscale(struct twl4030_madc_battery *bat,\n\t\t\t\t\tint volt)\n{\n\tstruct twl4030_madc_bat_calibration *calibration;\n\tint i, res = 0;\n\n\t \n\tif (twl4030_madc_bat_get_charging_status(bat))\n\t\tcalibration = bat->pdata->charging;\n\telse\n\t\tcalibration = bat->pdata->discharging;\n\n\tif (volt > calibration[0].voltage) {\n\t\tres = calibration[0].level;\n\t} else {\n\t\tfor (i = 0; calibration[i+1].voltage >= 0; i++) {\n\t\t\tif (volt <= calibration[i].voltage &&\n\t\t\t\t\tvolt >= calibration[i+1].voltage) {\n\t\t\t\t \n\t\t\t\tres = calibration[i].level -\n\t\t\t\t\t((calibration[i].voltage - volt) *\n\t\t\t\t\t(calibration[i].level -\n\t\t\t\t\tcalibration[i+1].level)) /\n\t\t\t\t\t(calibration[i].voltage -\n\t\t\t\t\tcalibration[i+1].voltage);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\treturn res;\n}\n\nstatic int twl4030_madc_bat_get_property(struct power_supply *psy,\n\t\t\t\t\tenum power_supply_property psp,\n\t\t\t\t\tunion power_supply_propval *val)\n{\n\tstruct twl4030_madc_battery *bat = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tif (twl4030_madc_bat_voltscale(bat,\n\t\t\t\ttwl4030_madc_bat_get_voltage(bat)) > 95)\n\t\t\tval->intval = POWER_SUPPLY_STATUS_FULL;\n\t\telse {\n\t\t\tif (twl4030_madc_bat_get_charging_status(bat))\n\t\t\t\tval->intval = POWER_SUPPLY_STATUS_CHARGING;\n\t\t\telse\n\t\t\t\tval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\n\t\t}\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tval->intval = twl4030_madc_bat_get_voltage(bat) * 1000;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CURRENT_NOW:\n\t\tval->intval = twl4030_madc_bat_get_current(bat);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\t \n\t\tval->intval = 1;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_NOW: {\n\t\t\tint percent = twl4030_madc_bat_voltscale(bat,\n\t\t\t\t\ttwl4030_madc_bat_get_voltage(bat));\n\t\t\tval->intval = (percent * bat->pdata->capacity) / 100;\n\t\t\tbreak;\n\t\t}\n\tcase POWER_SUPPLY_PROP_CAPACITY:\n\t\tval->intval = twl4030_madc_bat_voltscale(bat,\n\t\t\t\t\ttwl4030_madc_bat_get_voltage(bat));\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CHARGE_FULL:\n\t\tval->intval = bat->pdata->capacity;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TEMP:\n\t\tval->intval = twl4030_madc_bat_get_temp(bat);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TIME_TO_EMPTY_NOW: {\n\t\t\tint percent = twl4030_madc_bat_voltscale(bat,\n\t\t\t\t\ttwl4030_madc_bat_get_voltage(bat));\n\t\t\t \n\t\t\tint chg = (percent * (bat->pdata->capacity/1000))/100;\n\n\t\t\t \n\t\t\tval->intval = (3600l * chg) / 400;\n\t\t\tbreak;\n\t\t}\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct power_supply_desc twl4030_madc_bat_desc = {\n\t.name\t\t\t= \"twl4030_battery\",\n\t.type\t\t\t= POWER_SUPPLY_TYPE_BATTERY,\n\t.properties\t\t= twl4030_madc_bat_props,\n\t.num_properties\t\t= ARRAY_SIZE(twl4030_madc_bat_props),\n\t.get_property\t\t= twl4030_madc_bat_get_property,\n\t.external_power_changed\t= power_supply_changed,\n};\n\nstatic int twl4030_cmp(const void *a, const void *b)\n{\n\treturn ((struct twl4030_madc_bat_calibration *)b)->voltage -\n\t\t((struct twl4030_madc_bat_calibration *)a)->voltage;\n}\n\nstatic int twl4030_madc_battery_probe(struct platform_device *pdev)\n{\n\tstruct twl4030_madc_battery *twl4030_madc_bat;\n\tstruct twl4030_madc_bat_platform_data *pdata = pdev->dev.platform_data;\n\tstruct power_supply_config psy_cfg = {};\n\tint ret = 0;\n\n\ttwl4030_madc_bat = devm_kzalloc(&pdev->dev, sizeof(*twl4030_madc_bat),\n\t\t\t\tGFP_KERNEL);\n\tif (!twl4030_madc_bat)\n\t\treturn -ENOMEM;\n\n\ttwl4030_madc_bat->channel_temp = iio_channel_get(&pdev->dev, \"temp\");\n\tif (IS_ERR(twl4030_madc_bat->channel_temp)) {\n\t\tret = PTR_ERR(twl4030_madc_bat->channel_temp);\n\t\tgoto err;\n\t}\n\n\ttwl4030_madc_bat->channel_ichg = iio_channel_get(&pdev->dev, \"ichg\");\n\tif (IS_ERR(twl4030_madc_bat->channel_ichg)) {\n\t\tret = PTR_ERR(twl4030_madc_bat->channel_ichg);\n\t\tgoto err_temp;\n\t}\n\n\ttwl4030_madc_bat->channel_vbat = iio_channel_get(&pdev->dev, \"vbat\");\n\tif (IS_ERR(twl4030_madc_bat->channel_vbat)) {\n\t\tret = PTR_ERR(twl4030_madc_bat->channel_vbat);\n\t\tgoto err_ichg;\n\t}\n\n\t \n\tsort(pdata->charging, pdata->charging_size,\n\t\tsizeof(struct twl4030_madc_bat_calibration),\n\t\ttwl4030_cmp, NULL);\n\tsort(pdata->discharging, pdata->discharging_size,\n\t\tsizeof(struct twl4030_madc_bat_calibration),\n\t\ttwl4030_cmp, NULL);\n\n\ttwl4030_madc_bat->pdata = pdata;\n\tplatform_set_drvdata(pdev, twl4030_madc_bat);\n\tpsy_cfg.drv_data = twl4030_madc_bat;\n\ttwl4030_madc_bat->psy = power_supply_register(&pdev->dev,\n\t\t\t\t\t\t      &twl4030_madc_bat_desc,\n\t\t\t\t\t\t      &psy_cfg);\n\tif (IS_ERR(twl4030_madc_bat->psy)) {\n\t\tret = PTR_ERR(twl4030_madc_bat->psy);\n\t\tgoto err_vbat;\n\t}\n\n\treturn 0;\n\nerr_vbat:\n\tiio_channel_release(twl4030_madc_bat->channel_vbat);\nerr_ichg:\n\tiio_channel_release(twl4030_madc_bat->channel_ichg);\nerr_temp:\n\tiio_channel_release(twl4030_madc_bat->channel_temp);\nerr:\n\treturn ret;\n}\n\nstatic int twl4030_madc_battery_remove(struct platform_device *pdev)\n{\n\tstruct twl4030_madc_battery *bat = platform_get_drvdata(pdev);\n\n\tpower_supply_unregister(bat->psy);\n\n\tiio_channel_release(bat->channel_vbat);\n\tiio_channel_release(bat->channel_ichg);\n\tiio_channel_release(bat->channel_temp);\n\n\treturn 0;\n}\n\nstatic struct platform_driver twl4030_madc_battery_driver = {\n\t.driver = {\n\t\t.name = \"twl4030_madc_battery\",\n\t},\n\t.probe  = twl4030_madc_battery_probe,\n\t.remove = twl4030_madc_battery_remove,\n};\nmodule_platform_driver(twl4030_madc_battery_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Lukas M\u00e4rdian <lukas@goldelico.com>\");\nMODULE_DESCRIPTION(\"twl4030_madc battery driver\");\nMODULE_ALIAS(\"platform:twl4030_madc_battery\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}