{
  "module_name": "ltc4162-l-charger.c",
  "hash_id": "6108108e83da622fa8be6d1596afb812018a3b08c8dcd5387a9f4f8dad64d4e9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/ltc4162-l-charger.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/delay.h>\n#include <linux/of.h>\n#include <linux/pm_runtime.h>\n#include <linux/power_supply.h>\n#include <linux/i2c.h>\n#include <linux/regmap.h>\n\n \n#define LTC4162L_EN_LIMIT_ALERTS_REG\t\t0x0D\n#define LTC4162L_EN_CHARGER_STATE_ALERTS_REG\t0x0E\n#define LTC4162L_EN_CHARGE_STATUS_ALERTS_REG\t0x0F\n#define LTC4162L_CONFIG_BITS_REG\t\t0x14\n#define LTC4162L_IIN_LIMIT_TARGET\t\t0x15\n#define LTC4162L_ARM_SHIP_MODE\t\t\t0x19\n#define LTC4162L_CHARGE_CURRENT_SETTING\t\t0X1A\n#define LTC4162L_VCHARGE_SETTING\t\t0X1B\n#define LTC4162L_C_OVER_X_THRESHOLD\t\t0x1C\n#define LTC4162L_MAX_CV_TIME\t\t\t0X1D\n#define LTC4162L_MAX_CHARGE_TIME\t\t0X1E\n#define LTC4162L_CHARGER_CONFIG_BITS\t\t0x29\n#define LTC4162L_CHARGER_STATE\t\t\t0x34\n#define LTC4162L_CHARGE_STATUS\t\t\t0x35\n#define LTC4162L_LIMIT_ALERTS_REG\t\t0x36\n#define LTC4162L_CHARGER_STATE_ALERTS_REG\t0x37\n#define LTC4162L_CHARGE_STATUS_ALERTS_REG\t0x38\n#define LTC4162L_SYSTEM_STATUS_REG\t\t0x39\n#define LTC4162L_VBAT\t\t\t\t0x3A\n#define LTC4162L_VIN\t\t\t\t0x3B\n#define LTC4162L_VOUT\t\t\t\t0x3C\n#define LTC4162L_IBAT\t\t\t\t0x3D\n#define LTC4162L_IIN\t\t\t\t0x3E\n#define LTC4162L_DIE_TEMPERATURE\t\t0x3F\n#define LTC4162L_THERMISTOR_VOLTAGE\t\t0x40\n#define LTC4162L_BSR\t\t\t\t0x41\n#define LTC4162L_JEITA_REGION\t\t\t0x42\n#define LTC4162L_CHEM_CELLS_REG\t\t\t0x43\n#define LTC4162L_ICHARGE_DAC\t\t\t0x44\n#define LTC4162L_VCHARGE_DAC\t\t\t0x45\n#define LTC4162L_IIN_LIMIT_DAC\t\t\t0x46\n#define LTC4162L_VBAT_FILT\t\t\t0x47\n#define LTC4162L_INPUT_UNDERVOLTAGE_DAC\t\t0x4B\n\n \nenum ltc4162l_state {\n\tbattery_detection = 2048,\n\tcharger_suspended = 256,\n\tprecharge = 128,    \n\tcc_cv_charge = 64,  \n\tntc_pause = 32,\n\ttimer_term = 16,\n\tc_over_x_term = 8,  \n\tmax_charge_time_fault = 4,\n\tbat_missing_fault = 2,\n\tbat_short_fault = 1\n};\n\n \nenum ltc4162l_charge_status {\n\tilim_reg_active = 32,\n\tthermal_reg_active = 16,\n\tvin_uvcl_active = 8,\n\tiin_limit_active = 4,\n\tconstant_current = 2,\n\tconstant_voltage = 1,\n\tcharger_off = 0\n};\n\n \n#define LTC4162L_ARM_SHIP_MODE_MAGIC 21325\n\nstruct ltc4162l_info {\n\tstruct i2c_client\t*client;\n\tstruct regmap\t\t*regmap;\n\tstruct power_supply\t*charger;\n\tu32 rsnsb;\t \n\tu32 rsnsi;\t \n\tu8 cell_count;\t \n};\n\nstatic u8 ltc4162l_get_cell_count(struct ltc4162l_info *info)\n{\n\tint ret;\n\tunsigned int val;\n\n\t \n\tif (info->cell_count)\n\t\treturn info->cell_count;\n\n\tret = regmap_read(info->regmap, LTC4162L_CHEM_CELLS_REG, &val);\n\tif (ret)\n\t\treturn 0;\n\n\t \n\tval &= 0x0f;\n\tif (!val)\n\t\treturn 0;\n\n\t \n\tinfo->cell_count = val;\n\n\treturn val;\n};\n\n \nstatic int ltc4162l_state_decode(enum ltc4162l_state value)\n{\n\tswitch (value) {\n\tcase precharge:\n\tcase cc_cv_charge:\n\t\treturn POWER_SUPPLY_STATUS_CHARGING;\n\tcase c_over_x_term:\n\t\treturn POWER_SUPPLY_STATUS_FULL;\n\tcase bat_missing_fault:\n\tcase bat_short_fault:\n\t\treturn POWER_SUPPLY_STATUS_UNKNOWN;\n\tdefault:\n\t\treturn POWER_SUPPLY_STATUS_NOT_CHARGING;\n\t}\n};\n\nstatic int ltc4162l_get_status(struct ltc4162l_info *info,\n\t\t\t       union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_CHARGER_STATE, &regval);\n\tif (ret) {\n\t\tdev_err(&info->client->dev, \"Failed to read CHARGER_STATE\\n\");\n\t\treturn ret;\n\t}\n\n\tval->intval = ltc4162l_state_decode(regval);\n\n\treturn 0;\n}\n\nstatic int ltc4162l_charge_status_decode(enum ltc4162l_charge_status value)\n{\n\tif (!value)\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_NONE;\n\n\t \n\tif (value <= iin_limit_active)\n\t\treturn POWER_SUPPLY_CHARGE_TYPE_FAST;\n\n\t \n\treturn POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\n}\n\nstatic int ltc4162l_get_charge_type(struct ltc4162l_info *info,\n\t\t\t\t    union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_CHARGE_STATUS, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\tval->intval = ltc4162l_charge_status_decode(regval);\n\n\treturn 0;\n}\n\nstatic int ltc4162l_state_to_health(enum ltc4162l_state value)\n{\n\tswitch (value) {\n\tcase ntc_pause:\n\t\treturn POWER_SUPPLY_HEALTH_OVERHEAT;\n\tcase timer_term:\n\t\treturn POWER_SUPPLY_HEALTH_SAFETY_TIMER_EXPIRE;\n\tcase max_charge_time_fault:\n\t\treturn POWER_SUPPLY_HEALTH_WATCHDOG_TIMER_EXPIRE;\n\tcase bat_missing_fault:\n\t\treturn POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\tcase bat_short_fault:\n\t\treturn POWER_SUPPLY_HEALTH_DEAD;\n\tdefault:\n\t\treturn POWER_SUPPLY_HEALTH_GOOD;\n\t}\n}\n\nstatic int ltc4162l_get_health(struct ltc4162l_info *info,\n\t\t\t       union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_CHARGER_STATE, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\tval->intval = ltc4162l_state_to_health(regval);\n\n\treturn 0;\n}\n\nstatic int ltc4162l_get_online(struct ltc4162l_info *info,\n\t\t\t       union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_SYSTEM_STATUS_REG, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tval->intval = !!(regval & BIT(2));\n\n\treturn 0;\n}\n\nstatic int ltc4162l_get_vbat(struct ltc4162l_info *info,\n\t\t\t\t  unsigned int reg,\n\t\t\t\t  union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, reg, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tregval *= 1924;\n\tregval *= ltc4162l_get_cell_count(info);\n\tregval /= 10;\n\tval->intval = regval;\n\n\treturn 0;\n}\n\nstatic int ltc4162l_get_ibat(struct ltc4162l_info *info,\n\t\t\t     union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_IBAT, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = (s16)(regval & 0xFFFF);\n\tval->intval = 100 * mult_frac(ret, 14660, (int)info->rsnsb);\n\n\treturn 0;\n}\n\n\nstatic int ltc4162l_get_input_voltage(struct ltc4162l_info *info,\n\t\t\t\t      union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_VIN, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tval->intval =  regval * 1694;\n\n\treturn 0;\n}\n\nstatic int ltc4162l_get_input_current(struct ltc4162l_info *info,\n\t\t\t\t      union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_IIN, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = (s16)(regval & 0xFFFF);\n\tret *= 14660;\n\tret /= info->rsnsi;\n\tret *= 100;\n\n\tval->intval = ret;\n\n\treturn 0;\n}\n\nstatic int ltc4162l_get_icharge(struct ltc4162l_info *info,\n\t\t\t\tunsigned int reg,\n\t\t\t\tunion power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, reg, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\tregval &= BIT(6) - 1;  \n\n\t \n\t++regval;\n\tval->intval = 10000u * mult_frac(regval, 100000u, info->rsnsb);\n\n\treturn 0;\n}\n\nstatic int ltc4162l_set_icharge(struct ltc4162l_info *info,\n\t\t\t\tunsigned int reg,\n\t\t\t\tunsigned int value)\n{\n\tvalue = mult_frac(value, info->rsnsb, 100000u);\n\tvalue /= 10000u;\n\n\t \n\tif (value)\n\t\t--value;\n\n\tif (value > 31)\n\t\treturn -EINVAL;\n\n\treturn regmap_write(info->regmap, reg, value);\n}\n\n\nstatic int ltc4162l_get_vcharge(struct ltc4162l_info *info,\n\t\t\t\tunsigned int reg,\n\t\t\t\tunion power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\tu32 voltage;\n\n\tret = regmap_read(info->regmap, reg, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\tregval &= BIT(6) - 1;  \n\n\t \n\tvoltage = 3812500 + (regval * 12500);\n\tvoltage *= ltc4162l_get_cell_count(info);\n\tval->intval = voltage;\n\n\treturn 0;\n}\n\nstatic int ltc4162l_set_vcharge(struct ltc4162l_info *info,\n\t\t\t\tunsigned int reg,\n\t\t\t\tunsigned int value)\n{\n\tu8 cell_count = ltc4162l_get_cell_count(info);\n\n\tif (!cell_count)\n\t\treturn -EBUSY;  \n\n\tvalue /= cell_count;\n\n\tif (value < 3812500)\n\t\treturn -EINVAL;\n\n\tvalue -= 3812500;\n\tvalue /= 12500;\n\n\tif (value > 31)\n\t\treturn -EINVAL;\n\n\treturn regmap_write(info->regmap, reg, value);\n}\n\nstatic int ltc4162l_get_iin_limit_dac(struct ltc4162l_info *info,\n\t\t\t\t     union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_IIN_LIMIT_DAC, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\tregval &= BIT(6) - 1;  \n\n\t \n\t++regval;\n\tregval *= 5000000u;\n\tregval /= info->rsnsi;\n\tval->intval = 100u * regval;\n\n\treturn 0;\n}\n\nstatic int ltc4162l_set_iin_limit(struct ltc4162l_info *info,\n\t\t\t\t  unsigned int value)\n{\n\tunsigned int regval;\n\n\tregval = mult_frac(value, info->rsnsi, 50000u);\n\tregval /= 10000u;\n\tif (regval)\n\t\t--regval;\n\tif (regval > 63)\n\t\tregval = 63;\n\n\treturn regmap_write(info->regmap, LTC4162L_IIN_LIMIT_TARGET, regval);\n}\n\nstatic int ltc4162l_get_die_temp(struct ltc4162l_info *info,\n\t\t\t\t union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_DIE_TEMPERATURE, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = (s16)(regval & 0xFFFF);\n\tret *= 215;\n\tret /= 100;  \n\tret -= 26440;\n\tval->intval = ret;\n\n\treturn 0;\n}\n\nstatic int ltc4162l_get_term_current(struct ltc4162l_info *info,\n\t\t\t\t     union power_supply_propval *val)\n{\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_CHARGER_CONFIG_BITS, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (!(regval & BIT(2))) {\n\t\tval->intval = 0;\n\t\treturn 0;\n\t}\n\n\tret = regmap_read(info->regmap, LTC4162L_C_OVER_X_THRESHOLD, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tregval *= 14660u;\n\tregval /= info->rsnsb;\n\tval->intval = 100 * regval;\n\n\treturn 0;\n}\n\nstatic int ltc4162l_set_term_current(struct ltc4162l_info *info,\n\t\t\t\t     unsigned int value)\n{\n\tint ret;\n\tunsigned int regval;\n\n\tif (!value) {\n\t\t \n\t\treturn regmap_update_bits(info->regmap,\n\t\t\t\t\t  LTC4162L_CHARGER_CONFIG_BITS,\n\t\t\t\t\t  BIT(2), 0);\n\t}\n\n\tregval = mult_frac(value, info->rsnsb, 14660u);\n\tregval /= 100u;\n\n\tret =  regmap_write(info->regmap, LTC4162L_C_OVER_X_THRESHOLD, regval);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\treturn regmap_update_bits(info->regmap, LTC4162L_CHARGER_CONFIG_BITS,\n\t\t\t\t  BIT(2), BIT(2));\n}\n\n \nstatic const char * const ltc4162l_charge_status_name[] = {\n\t\"ilim_reg_active\",  \n\t\"thermal_reg_active\",\n\t\"vin_uvcl_active\",\n\t\"iin_limit_active\",\n\t\"constant_current\",\n\t\"constant_voltage\",\n\t\"charger_off\"  \n};\n\nstatic ssize_t charge_status_show(struct device *dev,\n\t\t\t\t  struct device_attribute *attr, char *buf)\n{\n\tstruct power_supply *psy = to_power_supply(dev);\n\tstruct ltc4162l_info *info = power_supply_get_drvdata(psy);\n\tconst char *result = ltc4162l_charge_status_name[\n\t\t\t\tARRAY_SIZE(ltc4162l_charge_status_name) - 1];\n\tunsigned int regval;\n\tunsigned int mask;\n\tunsigned int index;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_CHARGE_STATUS, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tfor (mask = 32, index = 0; mask != 0; mask >>= 1, ++index) {\n\t\tif (regval & mask) {\n\t\t\tresult = ltc4162l_charge_status_name[index];\n\t\t\tbreak;\n\t\t}\n\t}\n\n\treturn sysfs_emit(buf, \"%s\\n\", result);\n}\nstatic DEVICE_ATTR_RO(charge_status);\n\nstatic ssize_t vbat_show(struct device *dev,\n\t\t\t\t  struct device_attribute *attr, char *buf)\n{\n\tstruct power_supply *psy = to_power_supply(dev);\n\tstruct ltc4162l_info *info = power_supply_get_drvdata(psy);\n\tunion power_supply_propval val;\n\tint ret;\n\n\tret = ltc4162l_get_vbat(info, LTC4162L_VBAT, &val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn sysfs_emit(buf, \"%d\\n\", val.intval);\n}\nstatic DEVICE_ATTR_RO(vbat);\n\nstatic ssize_t vbat_avg_show(struct device *dev,\n\t\t\t\t  struct device_attribute *attr, char *buf)\n{\n\tstruct power_supply *psy = to_power_supply(dev);\n\tstruct ltc4162l_info *info = power_supply_get_drvdata(psy);\n\tunion power_supply_propval val;\n\tint ret;\n\n\tret = ltc4162l_get_vbat(info, LTC4162L_VBAT_FILT, &val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn sysfs_emit(buf, \"%d\\n\", val.intval);\n}\nstatic DEVICE_ATTR_RO(vbat_avg);\n\nstatic ssize_t ibat_show(struct device *dev,\n\t\t\t\t  struct device_attribute *attr, char *buf)\n{\n\tstruct power_supply *psy = to_power_supply(dev);\n\tstruct ltc4162l_info *info = power_supply_get_drvdata(psy);\n\tunion power_supply_propval val;\n\tint ret;\n\n\tret = ltc4162l_get_ibat(info, &val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn sysfs_emit(buf, \"%d\\n\", val.intval);\n}\nstatic DEVICE_ATTR_RO(ibat);\n\nstatic ssize_t force_telemetry_show(struct device *dev,\n\t\t\t\t    struct device_attribute *attr, char *buf)\n{\n\tstruct power_supply *psy = to_power_supply(dev);\n\tstruct ltc4162l_info *info = power_supply_get_drvdata(psy);\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_CONFIG_BITS_REG, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\treturn sysfs_emit(buf, \"%u\\n\", regval & BIT(2) ? 1 : 0);\n}\n\nstatic ssize_t force_telemetry_store(struct device *dev,\n\tstruct device_attribute *attr,\n\tconst char *buf,\n\tsize_t count)\n{\n\tstruct power_supply *psy = to_power_supply(dev);\n\tstruct ltc4162l_info *info = power_supply_get_drvdata(psy);\n\tint ret;\n\tunsigned int value;\n\n\tret = kstrtouint(buf, 0, &value);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_update_bits(info->regmap, LTC4162L_CONFIG_BITS_REG,\n\t\t\t\t BIT(2), value ? BIT(2) : 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn count;\n}\n\nstatic DEVICE_ATTR_RW(force_telemetry);\n\nstatic ssize_t arm_ship_mode_show(struct device *dev,\n\t\t\t\t    struct device_attribute *attr, char *buf)\n{\n\tstruct power_supply *psy = to_power_supply(dev);\n\tstruct ltc4162l_info *info = power_supply_get_drvdata(psy);\n\tunsigned int regval;\n\tint ret;\n\n\tret = regmap_read(info->regmap, LTC4162L_ARM_SHIP_MODE, &regval);\n\tif (ret)\n\t\treturn ret;\n\n\treturn sysfs_emit(buf, \"%u\\n\",\n\t\tregval == LTC4162L_ARM_SHIP_MODE_MAGIC ? 1 : 0);\n}\n\nstatic ssize_t arm_ship_mode_store(struct device *dev,\n\tstruct device_attribute *attr,\n\tconst char *buf,\n\tsize_t count)\n{\n\tstruct power_supply *psy = to_power_supply(dev);\n\tstruct ltc4162l_info *info = power_supply_get_drvdata(psy);\n\tint ret;\n\tunsigned int value;\n\n\tret = kstrtouint(buf, 0, &value);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regmap_write(info->regmap, LTC4162L_ARM_SHIP_MODE,\n\t\t\t\tvalue ? LTC4162L_ARM_SHIP_MODE_MAGIC : 0);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn count;\n}\n\nstatic DEVICE_ATTR_RW(arm_ship_mode);\n\nstatic struct attribute *ltc4162l_sysfs_entries[] = {\n\t&dev_attr_charge_status.attr,\n\t&dev_attr_ibat.attr,\n\t&dev_attr_vbat.attr,\n\t&dev_attr_vbat_avg.attr,\n\t&dev_attr_force_telemetry.attr,\n\t&dev_attr_arm_ship_mode.attr,\n\tNULL,\n};\n\nstatic const struct attribute_group ltc4162l_attr_group = {\n\t.name\t= NULL,\t \n\t.attrs\t= ltc4162l_sysfs_entries,\n};\n\nstatic const struct attribute_group *ltc4162l_attr_groups[] = {\n\t&ltc4162l_attr_group,\n\tNULL,\n};\n\nstatic int ltc4162l_get_property(struct power_supply *psy,\n\t\t\t\t enum power_supply_property psp,\n\t\t\t\t union power_supply_propval *val)\n{\n\tstruct ltc4162l_info *info = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\treturn ltc4162l_get_status(info, val);\n\tcase POWER_SUPPLY_PROP_CHARGE_TYPE:\n\t\treturn ltc4162l_get_charge_type(info, val);\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\treturn ltc4162l_get_health(info, val);\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\treturn ltc4162l_get_online(info, val);\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\treturn ltc4162l_get_input_voltage(info, val);\n\tcase POWER_SUPPLY_PROP_CURRENT_NOW:\n\t\treturn ltc4162l_get_input_current(info, val);\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT:\n\t\treturn ltc4162l_get_icharge(info,\n\t\t\t\tLTC4162L_ICHARGE_DAC, val);\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:\n\t\treturn ltc4162l_get_icharge(info,\n\t\t\t\tLTC4162L_CHARGE_CURRENT_SETTING, val);\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE:\n\t\treturn ltc4162l_get_vcharge(info,\n\t\t\t\tLTC4162L_VCHARGE_DAC, val);\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX:\n\t\treturn ltc4162l_get_vcharge(info,\n\t\t\t\tLTC4162L_VCHARGE_SETTING, val);\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\t\treturn ltc4162l_get_iin_limit_dac(info, val);\n\tcase POWER_SUPPLY_PROP_TEMP:\n\t\treturn ltc4162l_get_die_temp(info, val);\n\tcase POWER_SUPPLY_PROP_CHARGE_TERM_CURRENT:\n\t\treturn ltc4162l_get_term_current(info, val);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int ltc4162l_set_property(struct power_supply *psy,\n\t\t\t\t\t enum power_supply_property psp,\n\t\t\t\t\t const union power_supply_propval *val)\n{\n\tstruct ltc4162l_info *info = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:\n\t\treturn ltc4162l_set_icharge(info,\n\t\t\t\tLTC4162L_CHARGE_CURRENT_SETTING, val->intval);\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX:\n\t\treturn ltc4162l_set_vcharge(info,\n\t\t\t\tLTC4162L_VCHARGE_SETTING, val->intval);\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\t\treturn ltc4162l_set_iin_limit(info, val->intval);\n\tcase POWER_SUPPLY_PROP_CHARGE_TERM_CURRENT:\n\t\treturn ltc4162l_set_term_current(info, val->intval);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int ltc4162l_property_is_writeable(struct power_supply *psy,\n\t\t\t\t\t\tenum power_supply_property psp)\n{\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX:\n\tcase POWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX:\n\tcase POWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT:\n\tcase POWER_SUPPLY_PROP_CHARGE_TERM_CURRENT:\n\t\treturn 1;\n\tdefault:\n\t\treturn 0;\n\t}\n}\n\n \nstatic enum power_supply_property ltc4162l_properties[] = {\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_CHARGE_TYPE,\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_ONLINE,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n\tPOWER_SUPPLY_PROP_CURRENT_NOW,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_CURRENT_MAX,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE,\n\tPOWER_SUPPLY_PROP_CONSTANT_CHARGE_VOLTAGE_MAX,\n\tPOWER_SUPPLY_PROP_INPUT_CURRENT_LIMIT,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_CHARGE_TERM_CURRENT,\n};\n\nstatic const struct power_supply_desc ltc4162l_desc = {\n\t.name\t\t= \"ltc4162-l\",\n\t.type\t\t= POWER_SUPPLY_TYPE_MAINS,\n\t.properties\t= ltc4162l_properties,\n\t.num_properties\t= ARRAY_SIZE(ltc4162l_properties),\n\t.get_property\t= ltc4162l_get_property,\n\t.set_property\t= ltc4162l_set_property,\n\t.property_is_writeable = ltc4162l_property_is_writeable,\n};\n\nstatic bool ltc4162l_is_writeable_reg(struct device *dev, unsigned int reg)\n{\n\t \n\tif (reg <= LTC4162L_CHARGER_CONFIG_BITS)\n\t\treturn true;\n\n\t \n\tif (reg >= LTC4162L_LIMIT_ALERTS_REG &&\n\t    reg <= LTC4162L_CHARGE_STATUS_ALERTS_REG)\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic bool ltc4162l_is_volatile_reg(struct device *dev, unsigned int reg)\n{\n\t \n\treturn reg > LTC4162L_CHARGER_CONFIG_BITS;\n}\n\nstatic const struct regmap_config ltc4162l_regmap_config = {\n\t.reg_bits\t= 8,\n\t.val_bits\t= 16,\n\t.val_format_endian = REGMAP_ENDIAN_LITTLE,\n\t.writeable_reg\t= ltc4162l_is_writeable_reg,\n\t.volatile_reg\t= ltc4162l_is_volatile_reg,\n\t.max_register\t= LTC4162L_INPUT_UNDERVOLTAGE_DAC,\n\t.cache_type\t= REGCACHE_RBTREE,\n};\n\nstatic void ltc4162l_clear_interrupts(struct ltc4162l_info *info)\n{\n\t \n\tregmap_write(info->regmap, LTC4162L_LIMIT_ALERTS_REG, 0);\n\tregmap_write(info->regmap, LTC4162L_CHARGER_STATE_ALERTS_REG, 0);\n\tregmap_write(info->regmap, LTC4162L_CHARGE_STATUS_ALERTS_REG, 0);\n}\n\nstatic int ltc4162l_probe(struct i2c_client *client)\n{\n\tstruct i2c_adapter *adapter = client->adapter;\n\tstruct device *dev = &client->dev;\n\tstruct ltc4162l_info *info;\n\tstruct power_supply_config ltc4162l_config = {};\n\tu32 value;\n\tint ret;\n\n\tif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_WORD_DATA)) {\n\t\tdev_err(dev, \"No support for SMBUS_WORD_DATA\\n\");\n\t\treturn -ENODEV;\n\t}\n\tinfo = devm_kzalloc(dev, sizeof(*info), GFP_KERNEL);\n\tif (!info)\n\t\treturn -ENOMEM;\n\n\tinfo->client = client;\n\ti2c_set_clientdata(client, info);\n\n\tinfo->regmap = devm_regmap_init_i2c(client, &ltc4162l_regmap_config);\n\tif (IS_ERR(info->regmap)) {\n\t\tdev_err(dev, \"Failed to initialize register map\\n\");\n\t\treturn PTR_ERR(info->regmap);\n\t}\n\n\tret = device_property_read_u32(dev, \"lltc,rsnsb-micro-ohms\",\n\t\t\t\t       &info->rsnsb);\n\tif (ret) {\n\t\tdev_err(dev, \"Missing lltc,rsnsb-micro-ohms property\\n\");\n\t\treturn ret;\n\t}\n\tif (!info->rsnsb)\n\t\treturn -EINVAL;\n\n\tret = device_property_read_u32(dev, \"lltc,rsnsi-micro-ohms\",\n\t\t\t\t       &info->rsnsi);\n\tif (ret) {\n\t\tdev_err(dev, \"Missing lltc,rsnsi-micro-ohms property\\n\");\n\t\treturn ret;\n\t}\n\tif (!info->rsnsi)\n\t\treturn -EINVAL;\n\n\tif (!device_property_read_u32(dev, \"lltc,cell-count\", &value))\n\t\tinfo->cell_count = value;\n\n\tltc4162l_config.of_node = dev->of_node;\n\tltc4162l_config.drv_data = info;\n\tltc4162l_config.attr_grp = ltc4162l_attr_groups;\n\n\tinfo->charger = devm_power_supply_register(dev, &ltc4162l_desc,\n\t\t\t\t\t\t   &ltc4162l_config);\n\tif (IS_ERR(info->charger)) {\n\t\tdev_err(dev, \"Failed to register charger\\n\");\n\t\treturn PTR_ERR(info->charger);\n\t}\n\n\t \n\tregmap_write(info->regmap, LTC4162L_EN_LIMIT_ALERTS_REG, 0);\n\n\t \n\tregmap_write(info->regmap, LTC4162L_EN_CHARGER_STATE_ALERTS_REG,\n\t\t     0x1fff);\n\tregmap_write(info->regmap, LTC4162L_EN_CHARGE_STATUS_ALERTS_REG, 0x1f);\n\n\tltc4162l_clear_interrupts(info);\n\n\treturn 0;\n}\n\nstatic void ltc4162l_alert(struct i2c_client *client,\n\t\t\t   enum i2c_alert_protocol type, unsigned int flag)\n{\n\tstruct ltc4162l_info *info = i2c_get_clientdata(client);\n\n\tif (type != I2C_PROTOCOL_SMBUS_ALERT)\n\t\treturn;\n\n\tltc4162l_clear_interrupts(info);\n\tpower_supply_changed(info->charger);\n}\n\nstatic const struct i2c_device_id ltc4162l_i2c_id_table[] = {\n\t{ \"ltc4162-l\", 0 },\n\t{ },\n};\nMODULE_DEVICE_TABLE(i2c, ltc4162l_i2c_id_table);\n\nstatic const struct of_device_id ltc4162l_of_match[] __maybe_unused = {\n\t{ .compatible = \"lltc,ltc4162-l\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, ltc4162l_of_match);\n\nstatic struct i2c_driver ltc4162l_driver = {\n\t.probe\t\t= ltc4162l_probe,\n\t.alert\t\t= ltc4162l_alert,\n\t.id_table\t= ltc4162l_i2c_id_table,\n\t.driver = {\n\t\t.name\t\t= \"ltc4162-l-charger\",\n\t\t.of_match_table\t= of_match_ptr(ltc4162l_of_match),\n\t},\n};\nmodule_i2c_driver(ltc4162l_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Mike Looijmans <mike.looijmans@topic.nl>\");\nMODULE_DESCRIPTION(\"LTC4162-L charger driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}