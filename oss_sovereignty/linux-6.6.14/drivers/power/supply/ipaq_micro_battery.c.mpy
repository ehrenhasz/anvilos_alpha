{
  "module_name": "ipaq_micro_battery.c",
  "hash_id": "5ac57462de43afd19ad650ecf964827975193db038b8adc46d4e86a9d00ba6fe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/supply/ipaq_micro_battery.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/platform_device.h>\n#include <linux/mfd/ipaq-micro.h>\n#include <linux/power_supply.h>\n#include <linux/workqueue.h>\n\n#define BATT_PERIOD 100000  \n\n#define MICRO_BATT_CHEM_ALKALINE\t0x01\n#define MICRO_BATT_CHEM_NICD\t\t0x02\n#define MICRO_BATT_CHEM_NIMH\t\t0x03\n#define MICRO_BATT_CHEM_LION\t\t0x04\n#define MICRO_BATT_CHEM_LIPOLY\t\t0x05\n#define MICRO_BATT_CHEM_NOT_INSTALLED\t0x06\n#define MICRO_BATT_CHEM_UNKNOWN\t\t0xff\n\n#define MICRO_BATT_STATUS_HIGH\t\t0x01\n#define MICRO_BATT_STATUS_LOW\t\t0x02\n#define MICRO_BATT_STATUS_CRITICAL\t0x04\n#define MICRO_BATT_STATUS_CHARGING\t0x08\n#define MICRO_BATT_STATUS_CHARGEMAIN\t0x10\n#define MICRO_BATT_STATUS_DEAD\t\t0x20  \n#define MICRO_BATT_STATUS_NOTINSTALLED\t0x20  \n#define MICRO_BATT_STATUS_FULL\t\t0x40  \n#define MICRO_BATT_STATUS_NOBATTERY\t0x80\n#define MICRO_BATT_STATUS_UNKNOWN\t0xff\n\nstruct micro_battery {\n\tstruct ipaq_micro *micro;\n\tstruct workqueue_struct *wq;\n\tstruct delayed_work update;\n\tu8 ac;\n\tu8 chemistry;\n\tunsigned int voltage;\n\tu16 temperature;\n\tu8 flag;\n};\n\nstatic void micro_battery_work(struct work_struct *work)\n{\n\tstruct micro_battery *mb = container_of(work,\n\t\t\t\tstruct micro_battery, update.work);\n\tstruct ipaq_micro_msg msg_battery = {\n\t\t.id = MSG_BATTERY,\n\t};\n\tstruct ipaq_micro_msg msg_sensor = {\n\t\t.id = MSG_THERMAL_SENSOR,\n\t};\n\n\t \n\tipaq_micro_tx_msg_sync(mb->micro, &msg_battery);\n\tif (msg_battery.rx_len < 4)\n\t\tpr_info(\"ERROR\");\n\n\t \n\tmb->ac = msg_battery.rx_data[0];\n\tmb->chemistry = msg_battery.rx_data[1];\n\tmb->voltage = ((((unsigned short)msg_battery.rx_data[3] << 8) +\n\t\t\tmsg_battery.rx_data[2]) * 5000L) * 1000 / 1024;\n\tmb->flag = msg_battery.rx_data[4];\n\n\tif (msg_battery.rx_len == 9)\n\t\tpr_debug(\"second battery ignored\\n\");\n\n\t \n\tipaq_micro_tx_msg_sync(mb->micro, &msg_sensor);\n\tmb->temperature = msg_sensor.rx_data[1] << 8 | msg_sensor.rx_data[0];\n\n\tqueue_delayed_work(mb->wq, &mb->update, msecs_to_jiffies(BATT_PERIOD));\n}\n\nstatic int get_capacity(struct power_supply *b)\n{\n\tstruct micro_battery *mb = dev_get_drvdata(b->dev.parent);\n\n\tswitch (mb->flag & 0x07) {\n\tcase MICRO_BATT_STATUS_HIGH:\n\t\treturn 100;\n\t\tbreak;\n\tcase MICRO_BATT_STATUS_LOW:\n\t\treturn 50;\n\t\tbreak;\n\tcase MICRO_BATT_STATUS_CRITICAL:\n\t\treturn 5;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int get_status(struct power_supply *b)\n{\n\tstruct micro_battery *mb = dev_get_drvdata(b->dev.parent);\n\n\tif (mb->flag == MICRO_BATT_STATUS_UNKNOWN)\n\t\treturn POWER_SUPPLY_STATUS_UNKNOWN;\n\n\tif (mb->flag & MICRO_BATT_STATUS_FULL)\n\t\treturn POWER_SUPPLY_STATUS_FULL;\n\n\tif ((mb->flag & MICRO_BATT_STATUS_CHARGING) ||\n\t\t(mb->flag & MICRO_BATT_STATUS_CHARGEMAIN))\n\t\treturn POWER_SUPPLY_STATUS_CHARGING;\n\n\treturn POWER_SUPPLY_STATUS_DISCHARGING;\n}\n\nstatic int micro_batt_get_property(struct power_supply *b,\n\t\t\t\t\tenum power_supply_property psp,\n\t\t\t\t\tunion power_supply_propval *val)\n{\n\tstruct micro_battery *mb = dev_get_drvdata(b->dev.parent);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_TECHNOLOGY:\n\t\tswitch (mb->chemistry) {\n\t\tcase MICRO_BATT_CHEM_NICD:\n\t\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_NiCd;\n\t\t\tbreak;\n\t\tcase MICRO_BATT_CHEM_NIMH:\n\t\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_NiMH;\n\t\t\tbreak;\n\t\tcase MICRO_BATT_CHEM_LION:\n\t\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\n\t\t\tbreak;\n\t\tcase MICRO_BATT_CHEM_LIPOLY:\n\t\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_LIPO;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tval->intval = POWER_SUPPLY_TECHNOLOGY_UNKNOWN;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_STATUS:\n\t\tval->intval = get_status(b);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\n\t\tval->intval = 4700000;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_CAPACITY:\n\t\tval->intval = get_capacity(b);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_TEMP:\n\t\tval->intval = mb->temperature;\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_VOLTAGE_NOW:\n\t\tval->intval = mb->voltage;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int micro_ac_get_property(struct power_supply *b,\n\t\t\t\t enum power_supply_property psp,\n\t\t\t\t union power_supply_propval *val)\n{\n\tstruct micro_battery *mb = dev_get_drvdata(b->dev.parent);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = mb->ac;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic enum power_supply_property micro_batt_power_props[] = {\n\tPOWER_SUPPLY_PROP_TECHNOLOGY,\n\tPOWER_SUPPLY_PROP_STATUS,\n\tPOWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN,\n\tPOWER_SUPPLY_PROP_CAPACITY,\n\tPOWER_SUPPLY_PROP_TEMP,\n\tPOWER_SUPPLY_PROP_VOLTAGE_NOW,\n};\n\nstatic const struct power_supply_desc micro_batt_power_desc = {\n\t.name\t\t\t= \"main-battery\",\n\t.type\t\t\t= POWER_SUPPLY_TYPE_BATTERY,\n\t.properties\t\t= micro_batt_power_props,\n\t.num_properties\t\t= ARRAY_SIZE(micro_batt_power_props),\n\t.get_property\t\t= micro_batt_get_property,\n\t.use_for_apm\t\t= 1,\n};\n\nstatic enum power_supply_property micro_ac_power_props[] = {\n\tPOWER_SUPPLY_PROP_ONLINE,\n};\n\nstatic const struct power_supply_desc micro_ac_power_desc = {\n\t.name\t\t\t= \"ac\",\n\t.type\t\t\t= POWER_SUPPLY_TYPE_MAINS,\n\t.properties\t\t= micro_ac_power_props,\n\t.num_properties\t\t= ARRAY_SIZE(micro_ac_power_props),\n\t.get_property\t\t= micro_ac_get_property,\n};\n\nstatic struct power_supply *micro_batt_power, *micro_ac_power;\n\nstatic int micro_batt_probe(struct platform_device *pdev)\n{\n\tstruct micro_battery *mb;\n\tint ret;\n\n\tmb = devm_kzalloc(&pdev->dev, sizeof(*mb), GFP_KERNEL);\n\tif (!mb)\n\t\treturn -ENOMEM;\n\n\tmb->micro = dev_get_drvdata(pdev->dev.parent);\n\tmb->wq = alloc_workqueue(\"ipaq-battery-wq\", WQ_MEM_RECLAIM, 0);\n\tif (!mb->wq)\n\t\treturn -ENOMEM;\n\n\tINIT_DELAYED_WORK(&mb->update, micro_battery_work);\n\tplatform_set_drvdata(pdev, mb);\n\tqueue_delayed_work(mb->wq, &mb->update, 1);\n\n\tmicro_batt_power = power_supply_register(&pdev->dev,\n\t\t\t\t\t\t &micro_batt_power_desc, NULL);\n\tif (IS_ERR(micro_batt_power)) {\n\t\tret = PTR_ERR(micro_batt_power);\n\t\tgoto batt_err;\n\t}\n\n\tmicro_ac_power = power_supply_register(&pdev->dev,\n\t\t\t\t\t       &micro_ac_power_desc, NULL);\n\tif (IS_ERR(micro_ac_power)) {\n\t\tret = PTR_ERR(micro_ac_power);\n\t\tgoto ac_err;\n\t}\n\n\tdev_info(&pdev->dev, \"iPAQ micro battery driver\\n\");\n\treturn 0;\n\nac_err:\n\tpower_supply_unregister(micro_batt_power);\nbatt_err:\n\tcancel_delayed_work_sync(&mb->update);\n\tdestroy_workqueue(mb->wq);\n\treturn ret;\n}\n\nstatic int micro_batt_remove(struct platform_device *pdev)\n\n{\n\tstruct micro_battery *mb = platform_get_drvdata(pdev);\n\n\tpower_supply_unregister(micro_ac_power);\n\tpower_supply_unregister(micro_batt_power);\n\tcancel_delayed_work_sync(&mb->update);\n\tdestroy_workqueue(mb->wq);\n\n\treturn 0;\n}\n\nstatic int __maybe_unused micro_batt_suspend(struct device *dev)\n{\n\tstruct micro_battery *mb = dev_get_drvdata(dev);\n\n\tcancel_delayed_work_sync(&mb->update);\n\treturn 0;\n}\n\nstatic int __maybe_unused micro_batt_resume(struct device *dev)\n{\n\tstruct micro_battery *mb = dev_get_drvdata(dev);\n\n\tqueue_delayed_work(mb->wq, &mb->update, msecs_to_jiffies(BATT_PERIOD));\n\treturn 0;\n}\n\nstatic const struct dev_pm_ops micro_batt_dev_pm_ops = {\n\tSET_SYSTEM_SLEEP_PM_OPS(micro_batt_suspend, micro_batt_resume)\n};\n\nstatic struct platform_driver micro_batt_device_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"ipaq-micro-battery\",\n\t\t.pm\t= &micro_batt_dev_pm_ops,\n\t},\n\t.probe\t\t= micro_batt_probe,\n\t.remove\t\t= micro_batt_remove,\n};\nmodule_platform_driver(micro_batt_device_driver);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"driver for iPAQ Atmel micro battery\");\nMODULE_ALIAS(\"platform:ipaq-micro-battery\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}