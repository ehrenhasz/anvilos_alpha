{
  "module_name": "qcom-pon.c",
  "hash_id": "7f7d982be4a5796ad1b96c1cfb563eb36235fdec722f889319b6c0efe8927a23",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/reset/qcom-pon.c",
  "human_readable_source": "\n\n\n#include <linux/delay.h>\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/platform_device.h>\n#include <linux/reboot.h>\n#include <linux/reboot-mode.h>\n#include <linux/regmap.h>\n\n#define PON_SOFT_RB_SPARE\t\t0x8f\n\n#define GEN1_REASON_SHIFT\t\t2\n#define GEN2_REASON_SHIFT\t\t1\n\n#define NO_REASON_SHIFT\t\t\t0\n\nstruct pm8916_pon {\n\tstruct device *dev;\n\tstruct regmap *regmap;\n\tu32 baseaddr;\n\tstruct reboot_mode_driver reboot_mode;\n\tlong reason_shift;\n};\n\nstatic int pm8916_reboot_mode_write(struct reboot_mode_driver *reboot,\n\t\t\t\t    unsigned int magic)\n{\n\tstruct pm8916_pon *pon = container_of\n\t\t\t(reboot, struct pm8916_pon, reboot_mode);\n\tint ret;\n\n\tret = regmap_update_bits(pon->regmap,\n\t\t\t\t pon->baseaddr + PON_SOFT_RB_SPARE,\n\t\t\t\t GENMASK(7, pon->reason_shift),\n\t\t\t\t magic << pon->reason_shift);\n\tif (ret < 0)\n\t\tdev_err(pon->dev, \"update reboot mode bits failed\\n\");\n\n\treturn ret;\n}\n\nstatic int pm8916_pon_probe(struct platform_device *pdev)\n{\n\tstruct pm8916_pon *pon;\n\tlong reason_shift;\n\tint error;\n\n\tpon = devm_kzalloc(&pdev->dev, sizeof(*pon), GFP_KERNEL);\n\tif (!pon)\n\t\treturn -ENOMEM;\n\n\tpon->dev = &pdev->dev;\n\n\tpon->regmap = dev_get_regmap(pdev->dev.parent, NULL);\n\tif (!pon->regmap) {\n\t\tdev_err(&pdev->dev, \"failed to locate regmap\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\terror = of_property_read_u32(pdev->dev.of_node, \"reg\",\n\t\t\t\t     &pon->baseaddr);\n\tif (error)\n\t\treturn error;\n\n\treason_shift = (long)of_device_get_match_data(&pdev->dev);\n\n\tif (reason_shift != NO_REASON_SHIFT) {\n\t\tpon->reboot_mode.dev = &pdev->dev;\n\t\tpon->reason_shift = reason_shift;\n\t\tpon->reboot_mode.write = pm8916_reboot_mode_write;\n\t\terror = devm_reboot_mode_register(&pdev->dev, &pon->reboot_mode);\n\t\tif (error) {\n\t\t\tdev_err(&pdev->dev, \"can't register reboot mode\\n\");\n\t\t\treturn error;\n\t\t}\n\t}\n\n\tplatform_set_drvdata(pdev, pon);\n\n\treturn devm_of_platform_populate(&pdev->dev);\n}\n\nstatic const struct of_device_id pm8916_pon_id_table[] = {\n\t{ .compatible = \"qcom,pm8916-pon\", .data = (void *)GEN1_REASON_SHIFT },\n\t{ .compatible = \"qcom,pm8941-pon\", .data = (void *)NO_REASON_SHIFT },\n\t{ .compatible = \"qcom,pms405-pon\", .data = (void *)GEN1_REASON_SHIFT },\n\t{ .compatible = \"qcom,pm8998-pon\", .data = (void *)GEN2_REASON_SHIFT },\n\t{ .compatible = \"qcom,pmk8350-pon\", .data = (void *)GEN2_REASON_SHIFT },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, pm8916_pon_id_table);\n\nstatic struct platform_driver pm8916_pon_driver = {\n\t.probe = pm8916_pon_probe,\n\t.driver = {\n\t\t.name = \"pm8916-pon\",\n\t\t.of_match_table = pm8916_pon_id_table,\n\t},\n};\nmodule_platform_driver(pm8916_pon_driver);\n\nMODULE_DESCRIPTION(\"pm8916 Power On driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}