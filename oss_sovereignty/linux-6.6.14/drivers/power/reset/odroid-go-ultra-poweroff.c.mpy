{
  "module_name": "odroid-go-ultra-poweroff.c",
  "hash_id": "4096d8f6473d1753d1a21bcfe9534c0d79b51360bb0f236c275b0f4bdbad82cb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/reset/odroid-go-ultra-poweroff.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/mfd/rk808.h>\n#include <linux/regmap.h>\n#include <linux/module.h>\n#include <linux/reboot.h>\n#include <linux/i2c.h>\n\n \n\nstruct odroid_go_ultra_poweroff_data {\n\tstruct device *dev;\n\tstruct device *rk817;\n\tstruct device *rk818;\n};\n\nstatic int odroid_go_ultra_poweroff_prepare(struct sys_off_data *data)\n{\n\tstruct odroid_go_ultra_poweroff_data *poweroff_data = data->cb_data;\n\tstruct regmap *rk817, *rk818;\n\tint ret;\n\n\t \n\trk817 = dev_get_regmap(poweroff_data->rk817, NULL);\n\tif (!rk817) {\n\t\tdev_err(poweroff_data->dev, \"failed to get rk817 regmap\\n\");\n\t\treturn notifier_from_errno(-EINVAL);\n\t}\n\n\t \n\trk818 = dev_get_regmap(poweroff_data->rk818, NULL);\n\tif (!rk818) {\n\t\tdev_err(poweroff_data->dev, \"failed to get rk818 regmap\\n\");\n\t\treturn notifier_from_errno(-EINVAL);\n\t}\n\n\tdev_info(poweroff_data->dev, \"Setting PMICs for power off\");\n\n\t \n\tret = regmap_update_bits(rk817, RK817_SYS_CFG(3), DEV_OFF, DEV_OFF);\n\tif (ret) {\n\t\tdev_err(poweroff_data->dev, \"failed to poweroff rk817\\n\");\n\t\treturn notifier_from_errno(ret);\n\t}\n\n\t \n\tret = regmap_update_bits(rk818, RK818_DEVCTRL_REG, DEV_OFF, DEV_OFF);\n\tif (ret) {\n\t\tdev_err(poweroff_data->dev, \"failed to poweroff rk818\\n\");\n\t\treturn notifier_from_errno(ret);\n\t}\n\n\treturn NOTIFY_OK;\n}\n\nstatic void odroid_go_ultra_poweroff_put_pmic_device(void *data)\n{\n\tstruct device *dev = data;\n\n\tput_device(dev);\n}\n\nstatic int odroid_go_ultra_poweroff_get_pmic_device(struct device *dev, const char *compatible,\n\t\t\t\t\t\t    struct device **pmic)\n{\n\tstruct device_node *pmic_node;\n\tstruct i2c_client *pmic_client;\n\n\tpmic_node = of_find_compatible_node(NULL, NULL, compatible);\n\tif (!pmic_node)\n\t\treturn -ENODEV;\n\n\tpmic_client = of_find_i2c_device_by_node(pmic_node);\n\tof_node_put(pmic_node);\n\tif (!pmic_client)\n\t\treturn -EPROBE_DEFER;\n\n\t*pmic = &pmic_client->dev;\n\n\treturn devm_add_action_or_reset(dev, odroid_go_ultra_poweroff_put_pmic_device, *pmic);\n}\n\nstatic int odroid_go_ultra_poweroff_probe(struct platform_device *pdev)\n{\n\tstruct odroid_go_ultra_poweroff_data *poweroff_data;\n\tint ret;\n\n\tpoweroff_data = devm_kzalloc(&pdev->dev, sizeof(*poweroff_data), GFP_KERNEL);\n\tif (!poweroff_data)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(&pdev->dev, poweroff_data);\n\n\t \n\tret = odroid_go_ultra_poweroff_get_pmic_device(&pdev->dev, \"rockchip,rk818\",\n\t\t\t\t\t\t       &poweroff_data->rk818);\n\tif (ret)\n\t\treturn dev_err_probe(&pdev->dev, ret, \"failed to get rk818 mfd data\\n\");\n\n\t \n\tret = odroid_go_ultra_poweroff_get_pmic_device(&pdev->dev, \"rockchip,rk817\",\n\t\t\t\t\t\t       &poweroff_data->rk817);\n\tif (ret)\n\t\treturn dev_err_probe(&pdev->dev, ret, \"failed to get rk817 mfd data\\n\");\n\n\t \n\tret = devm_register_sys_off_handler(&pdev->dev,\n\t\t\t\t\t    SYS_OFF_MODE_POWER_OFF_PREPARE,\n\t\t\t\t\t    SYS_OFF_PRIO_DEFAULT,\n\t\t\t\t\t    odroid_go_ultra_poweroff_prepare,\n\t\t\t\t\t    poweroff_data);\n\tif (ret)\n\t\treturn dev_err_probe(&pdev->dev, ret, \"failed to register sys-off handler\\n\");\n\n\tdev_info(&pdev->dev, \"Registered Power-Off handler\\n\");\n\n\treturn 0;\n}\nstatic struct platform_device *pdev;\n\nstatic struct platform_driver odroid_go_ultra_poweroff_driver = {\n\t.driver = {\n\t\t.name\t= \"odroid-go-ultra-poweroff\",\n\t},\n\t.probe = odroid_go_ultra_poweroff_probe,\n};\n\nstatic int __init odroid_go_ultra_poweroff_init(void)\n{\n\tint ret;\n\n\t \n\tif (!of_device_is_compatible(of_root, \"hardkernel,odroid-go-ultra\"))\n\t\treturn -ENODEV;\n\n\tret = platform_driver_register(&odroid_go_ultra_poweroff_driver);\n\tif (ret)\n\t\treturn ret;\n\n\tpdev = platform_device_register_resndata(NULL, \"odroid-go-ultra-poweroff\", -1,\n\t\t\t\t\t\t NULL, 0, NULL, 0);\n\n\tif (IS_ERR(pdev)) {\n\t\tplatform_driver_unregister(&odroid_go_ultra_poweroff_driver);\n\t\treturn PTR_ERR(pdev);\n\t}\n\n\treturn 0;\n}\n\nstatic void __exit odroid_go_ultra_poweroff_exit(void)\n{\n\t \n\tif (!of_device_is_compatible(of_root, \"hardkernel,odroid-go-ultra\"))\n\t\treturn;\n\n\tplatform_device_unregister(pdev);\n\tplatform_driver_unregister(&odroid_go_ultra_poweroff_driver);\n}\n\nmodule_init(odroid_go_ultra_poweroff_init);\nmodule_exit(odroid_go_ultra_poweroff_exit);\n\nMODULE_AUTHOR(\"Neil Armstrong <neil.armstrong@linaro.org>\");\nMODULE_DESCRIPTION(\"Odroid Go Ultra poweroff driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}