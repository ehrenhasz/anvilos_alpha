{
  "module_name": "syscon-reboot.c",
  "hash_id": "516e1d538bf4800daeb35d496781a70a5bbf3fadb2c339e7764db59fafcba955",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/reset/syscon-reboot.c",
  "human_readable_source": "\n \n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/notifier.h>\n#include <linux/mfd/syscon.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/reboot.h>\n#include <linux/regmap.h>\n\nstruct syscon_reboot_context {\n\tstruct regmap *map;\n\tu32 offset;\n\tu32 value;\n\tu32 mask;\n\tstruct notifier_block restart_handler;\n};\n\nstatic int syscon_restart_handle(struct notifier_block *this,\n\t\t\t\t\tunsigned long mode, void *cmd)\n{\n\tstruct syscon_reboot_context *ctx =\n\t\t\tcontainer_of(this, struct syscon_reboot_context,\n\t\t\t\t\trestart_handler);\n\n\t \n\tregmap_update_bits(ctx->map, ctx->offset, ctx->mask, ctx->value);\n\n\tmdelay(1000);\n\n\tpr_emerg(\"Unable to restart system\\n\");\n\treturn NOTIFY_DONE;\n}\n\nstatic int syscon_reboot_probe(struct platform_device *pdev)\n{\n\tstruct syscon_reboot_context *ctx;\n\tstruct device *dev = &pdev->dev;\n\tint mask_err, value_err;\n\tint priority;\n\tint err;\n\n\tctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\n\tif (!ctx)\n\t\treturn -ENOMEM;\n\n\tctx->map = syscon_regmap_lookup_by_phandle(dev->of_node, \"regmap\");\n\tif (IS_ERR(ctx->map)) {\n\t\tctx->map = syscon_node_to_regmap(dev->parent->of_node);\n\t\tif (IS_ERR(ctx->map))\n\t\t\treturn PTR_ERR(ctx->map);\n\t}\n\n\tif (of_property_read_s32(pdev->dev.of_node, \"priority\", &priority))\n\t\tpriority = 192;\n\n\tif (of_property_read_u32(pdev->dev.of_node, \"offset\", &ctx->offset))\n\t\treturn -EINVAL;\n\n\tvalue_err = of_property_read_u32(pdev->dev.of_node, \"value\", &ctx->value);\n\tmask_err = of_property_read_u32(pdev->dev.of_node, \"mask\", &ctx->mask);\n\tif (value_err && mask_err) {\n\t\tdev_err(dev, \"unable to read 'value' and 'mask'\");\n\t\treturn -EINVAL;\n\t}\n\n\tif (value_err) {\n\t\t \n\t\tctx->value = ctx->mask;\n\t\tctx->mask = 0xFFFFFFFF;\n\t} else if (mask_err) {\n\t\t \n\t\tctx->mask = 0xFFFFFFFF;\n\t}\n\n\tctx->restart_handler.notifier_call = syscon_restart_handle;\n\tctx->restart_handler.priority = priority;\n\terr = register_restart_handler(&ctx->restart_handler);\n\tif (err)\n\t\tdev_err(dev, \"can't register restart notifier (err=%d)\\n\", err);\n\n\treturn err;\n}\n\nstatic const struct of_device_id syscon_reboot_of_match[] = {\n\t{ .compatible = \"syscon-reboot\" },\n\t{}\n};\n\nstatic struct platform_driver syscon_reboot_driver = {\n\t.probe = syscon_reboot_probe,\n\t.driver = {\n\t\t.name = \"syscon-reboot\",\n\t\t.of_match_table = syscon_reboot_of_match,\n\t},\n};\nbuiltin_platform_driver(syscon_reboot_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}