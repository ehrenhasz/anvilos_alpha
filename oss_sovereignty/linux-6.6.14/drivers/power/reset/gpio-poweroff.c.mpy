{
  "module_name": "gpio-poweroff.c",
  "hash_id": "77b8047463dc666a0226a279fd03c6d1ce7272e5c2b0ee5f6f6df970e636776a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/reset/gpio-poweroff.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/delay.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/gpio/consumer.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n\n#define DEFAULT_TIMEOUT_MS 3000\n \nstatic struct gpio_desc *reset_gpio;\nstatic u32 timeout = DEFAULT_TIMEOUT_MS;\nstatic u32 active_delay = 100;\nstatic u32 inactive_delay = 100;\n\nstatic void gpio_poweroff_do_poweroff(void)\n{\n\tBUG_ON(!reset_gpio);\n\n\t \n\tgpiod_direction_output(reset_gpio, 1);\n\tmdelay(active_delay);\n\n\t \n\tgpiod_set_value_cansleep(reset_gpio, 0);\n\tmdelay(inactive_delay);\n\n\t \n\tgpiod_set_value_cansleep(reset_gpio, 1);\n\n\t \n\tmdelay(timeout);\n\n\tWARN_ON(1);\n}\n\nstatic int gpio_poweroff_probe(struct platform_device *pdev)\n{\n\tbool input = false;\n\tenum gpiod_flags flags;\n\n\t \n\tif (pm_power_off != NULL) {\n\t\tdev_err(&pdev->dev,\n\t\t\t\"%s: pm_power_off function already registered\\n\",\n\t\t       __func__);\n\t\treturn -EBUSY;\n\t}\n\n\tinput = device_property_read_bool(&pdev->dev, \"input\");\n\tif (input)\n\t\tflags = GPIOD_IN;\n\telse\n\t\tflags = GPIOD_OUT_LOW;\n\n\tdevice_property_read_u32(&pdev->dev, \"active-delay-ms\", &active_delay);\n\tdevice_property_read_u32(&pdev->dev, \"inactive-delay-ms\",\n\t\t\t\t &inactive_delay);\n\tdevice_property_read_u32(&pdev->dev, \"timeout-ms\", &timeout);\n\n\treset_gpio = devm_gpiod_get(&pdev->dev, NULL, flags);\n\tif (IS_ERR(reset_gpio))\n\t\treturn PTR_ERR(reset_gpio);\n\n\tpm_power_off = &gpio_poweroff_do_poweroff;\n\treturn 0;\n}\n\nstatic int gpio_poweroff_remove(struct platform_device *pdev)\n{\n\tif (pm_power_off == &gpio_poweroff_do_poweroff)\n\t\tpm_power_off = NULL;\n\n\treturn 0;\n}\n\nstatic const struct of_device_id of_gpio_poweroff_match[] = {\n\t{ .compatible = \"gpio-poweroff\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, of_gpio_poweroff_match);\n\nstatic struct platform_driver gpio_poweroff_driver = {\n\t.probe = gpio_poweroff_probe,\n\t.remove = gpio_poweroff_remove,\n\t.driver = {\n\t\t.name = \"poweroff-gpio\",\n\t\t.of_match_table = of_gpio_poweroff_match,\n\t},\n};\n\nmodule_platform_driver(gpio_poweroff_driver);\n\nMODULE_AUTHOR(\"Jamie Lentin <jm@lentin.co.uk>\");\nMODULE_DESCRIPTION(\"GPIO poweroff driver\");\nMODULE_ALIAS(\"platform:poweroff-gpio\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}