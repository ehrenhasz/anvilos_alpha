{
  "module_name": "at91-sama5d2_shdwc.c",
  "hash_id": "74e4c463fba360f0cbdb65eefaa267c9791fad5fe73b5843bb77ba09363efe1e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/reset/at91-sama5d2_shdwc.c",
  "human_readable_source": " \n\n#include <linux/clk.h>\n#include <linux/clk/at91_pmc.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_address.h>\n#include <linux/platform_device.h>\n#include <linux/printk.h>\n\n#include <soc/at91/at91sam9_ddrsdr.h>\n\n#define SLOW_CLOCK_FREQ\t32768\n\n#define AT91_SHDW_CR\t0x00\t\t \n#define AT91_SHDW_SHDW\t\tBIT(0)\t\t\t \n#define AT91_SHDW_KEY\t\t(0xa5UL << 24)\t\t \n\n#define AT91_SHDW_MR\t0x04\t\t \n#define AT91_SHDW_WKUPDBC_SHIFT\t24\n#define AT91_SHDW_WKUPDBC_MASK\tGENMASK(26, 24)\n#define AT91_SHDW_WKUPDBC(x)\t(((x) << AT91_SHDW_WKUPDBC_SHIFT) \\\n\t\t\t\t\t\t& AT91_SHDW_WKUPDBC_MASK)\n\n#define AT91_SHDW_SR\t0x08\t\t \n#define AT91_SHDW_WKUPIS_SHIFT\t16\n#define AT91_SHDW_WKUPIS_MASK\tGENMASK(31, 16)\n#define AT91_SHDW_WKUPIS(x)\t((1 << (x)) << AT91_SHDW_WKUPIS_SHIFT \\\n\t\t\t\t\t\t& AT91_SHDW_WKUPIS_MASK)\n\n#define AT91_SHDW_WUIR\t0x0c\t\t \n#define AT91_SHDW_WKUPEN_MASK\tGENMASK(15, 0)\n#define AT91_SHDW_WKUPEN(x)\t((1 << (x)) & AT91_SHDW_WKUPEN_MASK)\n#define AT91_SHDW_WKUPT_SHIFT\t16\n#define AT91_SHDW_WKUPT_MASK\tGENMASK(31, 16)\n#define AT91_SHDW_WKUPT(x)\t((1 << (x)) << AT91_SHDW_WKUPT_SHIFT \\\n\t\t\t\t\t\t& AT91_SHDW_WKUPT_MASK)\n\n#define SHDW_WK_PIN(reg, cfg)\t((reg) & AT91_SHDW_WKUPIS((cfg)->wkup_pin_input))\n#define SHDW_RTCWK(reg, cfg)\t(((reg) >> ((cfg)->sr_rtcwk_shift)) & 0x1)\n#define SHDW_RTTWK(reg, cfg)\t(((reg) >> ((cfg)->sr_rttwk_shift)) & 0x1)\n#define SHDW_RTCWKEN(cfg)\t(1 << ((cfg)->mr_rtcwk_shift))\n#define SHDW_RTTWKEN(cfg)\t(1 << ((cfg)->mr_rttwk_shift))\n\n#define DBC_PERIOD_US(x)\tDIV_ROUND_UP_ULL((1000000 * (x)), \\\n\t\t\t\t\t\t\tSLOW_CLOCK_FREQ)\n\n#define SHDW_CFG_NOT_USED\t(32)\n\nstruct shdwc_reg_config {\n\tu8 wkup_pin_input;\n\tu8 mr_rtcwk_shift;\n\tu8 mr_rttwk_shift;\n\tu8 sr_rtcwk_shift;\n\tu8 sr_rttwk_shift;\n};\n\nstruct pmc_reg_config {\n\tu8 mckr;\n};\n\nstruct ddrc_reg_config {\n\tu32 type_offset;\n\tu32 type_mask;\n};\n\nstruct reg_config {\n\tstruct shdwc_reg_config shdwc;\n\tstruct pmc_reg_config pmc;\n\tstruct ddrc_reg_config ddrc;\n};\n\nstruct shdwc {\n\tconst struct reg_config *rcfg;\n\tstruct clk *sclk;\n\tvoid __iomem *shdwc_base;\n\tvoid __iomem *mpddrc_base;\n\tvoid __iomem *pmc_base;\n};\n\n \nstatic struct shdwc *at91_shdwc;\n\nstatic const unsigned long long sdwc_dbc_period[] = {\n\t0, 3, 32, 512, 4096, 32768,\n};\n\nstatic void __init at91_wakeup_status(struct platform_device *pdev)\n{\n\tstruct shdwc *shdw = platform_get_drvdata(pdev);\n\tconst struct reg_config *rcfg = shdw->rcfg;\n\tu32 reg;\n\tchar *reason = \"unknown\";\n\n\treg = readl(shdw->shdwc_base + AT91_SHDW_SR);\n\n\tdev_dbg(&pdev->dev, \"%s: status = %#x\\n\", __func__, reg);\n\n\t \n\tif (!reg)\n\t\treturn;\n\n\tif (SHDW_WK_PIN(reg, &rcfg->shdwc))\n\t\treason = \"WKUP pin\";\n\telse if (SHDW_RTCWK(reg, &rcfg->shdwc))\n\t\treason = \"RTC\";\n\telse if (SHDW_RTTWK(reg, &rcfg->shdwc))\n\t\treason = \"RTT\";\n\n\tpr_info(\"AT91: Wake-Up source: %s\\n\", reason);\n}\n\nstatic void at91_poweroff(void)\n{\n\tasm volatile(\n\t\t \n\t\t\".balign 32\\n\\t\"\n\n\t\t \n\t\t\"\tldr\tr6, [%2, #\" __stringify(AT91_SHDW_CR) \"]\\n\\t\"\n\n\t\t \n\t\t\"\ttst\t%0, #0\\n\\t\"\n\t\t\"\tbeq\t1f\\n\\t\"\n\t\t\"\tstr\t%1, [%0, #\" __stringify(AT91_DDRSDRC_LPR) \"]\\n\\t\"\n\n\t\t \n\t\t\"1:\tldr\tr6, [%4, %5]\\n\\t\"\n\t\t\"\tbic\tr6, r6,  #\" __stringify(AT91_PMC_CSS) \"\\n\\t\"\n\t\t\"\tstr\tr6, [%4, %5]\\n\\t\"\n\t\t \n\t\t\"2:\tldr\tr6, [%4, #\" __stringify(AT91_PMC_SR) \"]\\n\\t\"\n\t\t\"\ttst\tr6, #\"\t    __stringify(AT91_PMC_MCKRDY) \"\\n\\t\"\n\t\t\"\tbeq\t2b\\n\\t\"\n\n\t\t \n\t\t\"\tstr\t%3, [%2, #\" __stringify(AT91_SHDW_CR) \"]\\n\\t\"\n\n\t\t\"\tb\t.\\n\\t\"\n\t\t:\n\t\t: \"r\" (at91_shdwc->mpddrc_base),\n\t\t  \"r\" cpu_to_le32(AT91_DDRSDRC_LPDDR2_PWOFF),\n\t\t  \"r\" (at91_shdwc->shdwc_base),\n\t\t  \"r\" cpu_to_le32(AT91_SHDW_KEY | AT91_SHDW_SHDW),\n\t\t  \"r\" (at91_shdwc->pmc_base),\n\t\t  \"r\" (at91_shdwc->rcfg->pmc.mckr)\n\t\t: \"r6\");\n}\n\nstatic u32 at91_shdwc_debouncer_value(struct platform_device *pdev,\n\t\t\t\t      u32 in_period_us)\n{\n\tint i;\n\tint max_idx = ARRAY_SIZE(sdwc_dbc_period) - 1;\n\tunsigned long long period_us;\n\tunsigned long long max_period_us = DBC_PERIOD_US(sdwc_dbc_period[max_idx]);\n\n\tif (in_period_us > max_period_us) {\n\t\tdev_warn(&pdev->dev,\n\t\t\t \"debouncer period %u too big, reduced to %llu us\\n\",\n\t\t\t in_period_us, max_period_us);\n\t\treturn max_idx;\n\t}\n\n\tfor (i = max_idx - 1; i > 0; i--) {\n\t\tperiod_us = DBC_PERIOD_US(sdwc_dbc_period[i]);\n\t\tdev_dbg(&pdev->dev, \"%s: ref[%d] = %llu\\n\",\n\t\t\t\t\t\t__func__, i, period_us);\n\t\tif (in_period_us > period_us)\n\t\t\tbreak;\n\t}\n\n\treturn i + 1;\n}\n\nstatic u32 at91_shdwc_get_wakeup_input(struct platform_device *pdev,\n\t\t\t\t       struct device_node *np)\n{\n\tstruct device_node *cnp;\n\tu32 wk_input_mask;\n\tu32 wuir = 0;\n\tu32 wk_input;\n\n\tfor_each_child_of_node(np, cnp) {\n\t\tif (of_property_read_u32(cnp, \"reg\", &wk_input)) {\n\t\t\tdev_warn(&pdev->dev, \"reg property is missing for %pOF\\n\",\n\t\t\t\t cnp);\n\t\t\tcontinue;\n\t\t}\n\n\t\twk_input_mask = 1 << wk_input;\n\t\tif (!(wk_input_mask & AT91_SHDW_WKUPEN_MASK)) {\n\t\t\tdev_warn(&pdev->dev,\n\t\t\t\t \"wake-up input %d out of bounds ignore\\n\",\n\t\t\t\t wk_input);\n\t\t\tcontinue;\n\t\t}\n\t\twuir |= wk_input_mask;\n\n\t\tif (of_property_read_bool(cnp, \"atmel,wakeup-active-high\"))\n\t\t\twuir |= AT91_SHDW_WKUPT(wk_input);\n\n\t\tdev_dbg(&pdev->dev, \"%s: (child %d) wuir = %#x\\n\",\n\t\t\t\t\t\t__func__, wk_input, wuir);\n\t}\n\n\treturn wuir;\n}\n\nstatic void at91_shdwc_dt_configure(struct platform_device *pdev)\n{\n\tstruct shdwc *shdw = platform_get_drvdata(pdev);\n\tconst struct reg_config *rcfg = shdw->rcfg;\n\tstruct device_node *np = pdev->dev.of_node;\n\tu32 mode = 0, tmp, input;\n\n\tif (!np) {\n\t\tdev_err(&pdev->dev, \"device node not found\\n\");\n\t\treturn;\n\t}\n\n\tif (!of_property_read_u32(np, \"debounce-delay-us\", &tmp))\n\t\tmode |= AT91_SHDW_WKUPDBC(at91_shdwc_debouncer_value(pdev, tmp));\n\n\tif (of_property_read_bool(np, \"atmel,wakeup-rtc-timer\"))\n\t\tmode |= SHDW_RTCWKEN(&rcfg->shdwc);\n\n\tif (of_property_read_bool(np, \"atmel,wakeup-rtt-timer\"))\n\t\tmode |= SHDW_RTTWKEN(&rcfg->shdwc);\n\n\tdev_dbg(&pdev->dev, \"%s: mode = %#x\\n\", __func__, mode);\n\twritel(mode, shdw->shdwc_base + AT91_SHDW_MR);\n\n\tinput = at91_shdwc_get_wakeup_input(pdev, np);\n\twritel(input, shdw->shdwc_base + AT91_SHDW_WUIR);\n}\n\nstatic const struct reg_config sama5d2_reg_config = {\n\t.shdwc = {\n\t\t.wkup_pin_input = 0,\n\t\t.mr_rtcwk_shift = 17,\n\t\t.mr_rttwk_shift\t= SHDW_CFG_NOT_USED,\n\t\t.sr_rtcwk_shift = 5,\n\t\t.sr_rttwk_shift = SHDW_CFG_NOT_USED,\n\t},\n\t.pmc = {\n\t\t.mckr\t\t= 0x30,\n\t},\n\t.ddrc = {\n\t\t.type_offset\t= AT91_DDRSDRC_MDR,\n\t\t.type_mask\t= AT91_DDRSDRC_MD\n\t},\n};\n\nstatic const struct reg_config sam9x60_reg_config = {\n\t.shdwc = {\n\t\t.wkup_pin_input = 0,\n\t\t.mr_rtcwk_shift = 17,\n\t\t.mr_rttwk_shift = 16,\n\t\t.sr_rtcwk_shift = 5,\n\t\t.sr_rttwk_shift = 4,\n\t},\n\t.pmc = {\n\t\t.mckr\t\t= 0x28,\n\t},\n\t.ddrc = {\n\t\t.type_offset\t= AT91_DDRSDRC_MDR,\n\t\t.type_mask\t= AT91_DDRSDRC_MD\n\t},\n};\n\nstatic const struct reg_config sama7g5_reg_config = {\n\t.shdwc = {\n\t\t.wkup_pin_input = 0,\n\t\t.mr_rtcwk_shift = 17,\n\t\t.mr_rttwk_shift = 16,\n\t\t.sr_rtcwk_shift = 5,\n\t\t.sr_rttwk_shift = 4,\n\t},\n\t.pmc = {\n\t\t.mckr\t\t= 0x28,\n\t},\n};\n\nstatic const struct of_device_id at91_shdwc_of_match[] = {\n\t{\n\t\t.compatible = \"atmel,sama5d2-shdwc\",\n\t\t.data = &sama5d2_reg_config,\n\t},\n\t{\n\t\t.compatible = \"microchip,sam9x60-shdwc\",\n\t\t.data = &sam9x60_reg_config,\n\t},\n\t{\n\t\t.compatible = \"microchip,sama7g5-shdwc\",\n\t\t.data = &sama7g5_reg_config,\n\t}, {\n\t\t \n\t}\n};\nMODULE_DEVICE_TABLE(of, at91_shdwc_of_match);\n\nstatic const struct of_device_id at91_pmc_ids[] = {\n\t{ .compatible = \"atmel,sama5d2-pmc\" },\n\t{ .compatible = \"microchip,sam9x60-pmc\" },\n\t{ .compatible = \"microchip,sama7g5-pmc\" },\n\t{   }\n};\n\nstatic int __init at91_shdwc_probe(struct platform_device *pdev)\n{\n\tconst struct of_device_id *match;\n\tstruct device_node *np;\n\tu32 ddr_type;\n\tint ret;\n\n\tif (!pdev->dev.of_node)\n\t\treturn -ENODEV;\n\n\tif (at91_shdwc)\n\t\treturn -EBUSY;\n\n\tat91_shdwc = devm_kzalloc(&pdev->dev, sizeof(*at91_shdwc), GFP_KERNEL);\n\tif (!at91_shdwc)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, at91_shdwc);\n\n\tat91_shdwc->shdwc_base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(at91_shdwc->shdwc_base))\n\t\treturn PTR_ERR(at91_shdwc->shdwc_base);\n\n\tmatch = of_match_node(at91_shdwc_of_match, pdev->dev.of_node);\n\tat91_shdwc->rcfg = match->data;\n\n\tat91_shdwc->sclk = devm_clk_get(&pdev->dev, NULL);\n\tif (IS_ERR(at91_shdwc->sclk))\n\t\treturn PTR_ERR(at91_shdwc->sclk);\n\n\tret = clk_prepare_enable(at91_shdwc->sclk);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"Could not enable slow clock\\n\");\n\t\treturn ret;\n\t}\n\n\tat91_wakeup_status(pdev);\n\n\tat91_shdwc_dt_configure(pdev);\n\n\tnp = of_find_matching_node(NULL, at91_pmc_ids);\n\tif (!np) {\n\t\tret = -ENODEV;\n\t\tgoto clk_disable;\n\t}\n\n\tat91_shdwc->pmc_base = of_iomap(np, 0);\n\tof_node_put(np);\n\n\tif (!at91_shdwc->pmc_base) {\n\t\tret = -ENOMEM;\n\t\tgoto clk_disable;\n\t}\n\n\tif (at91_shdwc->rcfg->ddrc.type_mask) {\n\t\tnp = of_find_compatible_node(NULL, NULL,\n\t\t\t\t\t     \"atmel,sama5d3-ddramc\");\n\t\tif (!np) {\n\t\t\tret = -ENODEV;\n\t\t\tgoto unmap;\n\t\t}\n\n\t\tat91_shdwc->mpddrc_base = of_iomap(np, 0);\n\t\tof_node_put(np);\n\n\t\tif (!at91_shdwc->mpddrc_base) {\n\t\t\tret = -ENOMEM;\n\t\t\tgoto unmap;\n\t\t}\n\n\t\tddr_type = readl(at91_shdwc->mpddrc_base +\n\t\t\t\t at91_shdwc->rcfg->ddrc.type_offset) &\n\t\t\t\t at91_shdwc->rcfg->ddrc.type_mask;\n\t\tif (ddr_type != AT91_DDRSDRC_MD_LPDDR2 &&\n\t\t    ddr_type != AT91_DDRSDRC_MD_LPDDR3) {\n\t\t\tiounmap(at91_shdwc->mpddrc_base);\n\t\t\tat91_shdwc->mpddrc_base = NULL;\n\t\t}\n\t}\n\n\tpm_power_off = at91_poweroff;\n\n\treturn 0;\n\nunmap:\n\tiounmap(at91_shdwc->pmc_base);\nclk_disable:\n\tclk_disable_unprepare(at91_shdwc->sclk);\n\n\treturn ret;\n}\n\nstatic int __exit at91_shdwc_remove(struct platform_device *pdev)\n{\n\tstruct shdwc *shdw = platform_get_drvdata(pdev);\n\n\tif (pm_power_off == at91_poweroff)\n\t\tpm_power_off = NULL;\n\n\t \n\twritel(0, shdw->shdwc_base + AT91_SHDW_MR);\n\twritel(0, shdw->shdwc_base + AT91_SHDW_WUIR);\n\n\tif (shdw->mpddrc_base)\n\t\tiounmap(shdw->mpddrc_base);\n\tiounmap(shdw->pmc_base);\n\n\tclk_disable_unprepare(shdw->sclk);\n\n\treturn 0;\n}\n\nstatic struct platform_driver at91_shdwc_driver = {\n\t.remove = __exit_p(at91_shdwc_remove),\n\t.driver = {\n\t\t.name = \"at91-shdwc\",\n\t\t.of_match_table = at91_shdwc_of_match,\n\t},\n};\nmodule_platform_driver_probe(at91_shdwc_driver, at91_shdwc_probe);\n\nMODULE_AUTHOR(\"Nicolas Ferre <nicolas.ferre@atmel.com>\");\nMODULE_DESCRIPTION(\"Atmel shutdown controller driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}