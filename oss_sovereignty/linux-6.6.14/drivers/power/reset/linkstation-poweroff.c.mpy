{
  "module_name": "linkstation-poweroff.c",
  "hash_id": "345add9d2c841b939dfa88e663da38fd5544098894738dad7c89826592655958",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/reset/linkstation-poweroff.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/notifier.h>\n#include <linux/of.h>\n#include <linux/of_mdio.h>\n#include <linux/of_platform.h>\n#include <linux/reboot.h>\n#include <linux/phy.h>\n\n \n#define MII_MARVELL_COPPER_PAGE\t\t0\n#define MII_MARVELL_LED_PAGE\t\t3\n#define MII_MARVELL_WOL_PAGE\t\t17\n#define MII_MARVELL_PHY_PAGE\t\t22\n\n#define MII_PHY_LED_CTRL\t\t16\n#define MII_PHY_LED_POL_CTRL\t\t17\n#define MII_88E1318S_PHY_LED_TCR\t18\n#define MII_88E1318S_PHY_WOL_CTRL\t16\n#define MII_M1011_IEVENT\t\t19\n\n#define MII_88E1318S_PHY_LED_TCR_INTn_ENABLE\t\tBIT(7)\n#define MII_88E1318S_PHY_LED_TCR_FORCE_INT\t\tBIT(15)\n#define MII_88E1318S_PHY_WOL_CTRL_CLEAR_WOL_STATUS\tBIT(12)\n#define LED2_FORCE_ON\t\t\t\t\t(0x8 << 8)\n#define LEDMASK\t\t\t\t\t\tGENMASK(11,8)\n\n#define MII_88E1318S_PHY_LED_POL_LED2\t\tBIT(4)\n\nstruct power_off_cfg {\n\tchar *mdio_node_name;\n\tvoid (*phy_set_reg)(bool restart);\n};\n\nstatic struct phy_device *phydev;\nstatic const struct power_off_cfg *cfg;\n\nstatic void linkstation_mvphy_reg_intn(bool restart)\n{\n\tint rc = 0, saved_page;\n\tu16 data = 0;\n\n\tif (restart)\n\t\tdata = MII_88E1318S_PHY_LED_TCR_FORCE_INT;\n\n\tsaved_page = phy_select_page(phydev, MII_MARVELL_LED_PAGE);\n\tif (saved_page < 0)\n\t\tgoto err;\n\n\t \n\t__phy_modify(phydev, MII_PHY_LED_CTRL, LEDMASK, LED2_FORCE_ON);\n\n\t \n\t__phy_modify(phydev, MII_88E1318S_PHY_LED_TCR,\n\t\t     MII_88E1318S_PHY_LED_TCR_FORCE_INT,\n\t\t     MII_88E1318S_PHY_LED_TCR_INTn_ENABLE | data);\n\n\tif (!data) {\n\t\t \n\t\t__phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_MARVELL_COPPER_PAGE);\n\t\t__phy_read(phydev, MII_M1011_IEVENT);\n\n\t\t \n\t\t__phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_MARVELL_WOL_PAGE);\n\t\t__phy_set_bits(phydev, MII_88E1318S_PHY_WOL_CTRL,\n\t\t\t       MII_88E1318S_PHY_WOL_CTRL_CLEAR_WOL_STATUS);\n\t}\nerr:\n\trc = phy_restore_page(phydev, saved_page, rc);\n\tif (rc < 0)\n\t\tdev_err(&phydev->mdio.dev, \"Write register failed, %d\\n\", rc);\n}\n\nstatic void readynas_mvphy_set_reg(bool restart)\n{\n\tint rc = 0, saved_page;\n\tu16 data = 0;\n\n\tif (restart)\n\t\tdata = MII_88E1318S_PHY_LED_POL_LED2;\n\n\tsaved_page = phy_select_page(phydev, MII_MARVELL_LED_PAGE);\n\tif (saved_page < 0)\n\t\tgoto err;\n\n\t \n\t__phy_modify(phydev, MII_PHY_LED_POL_CTRL,\n\t\t     MII_88E1318S_PHY_LED_POL_LED2, data);\n\n\tif (!data) {\n\t\t \n\t\t__phy_write(phydev, MII_MARVELL_PHY_PAGE, MII_MARVELL_WOL_PAGE);\n\t\t__phy_set_bits(phydev, MII_88E1318S_PHY_WOL_CTRL,\n\t\t\t       MII_88E1318S_PHY_WOL_CTRL_CLEAR_WOL_STATUS);\n\t}\nerr:\n\trc = phy_restore_page(phydev, saved_page, rc);\n\tif (rc < 0)\n\t\tdev_err(&phydev->mdio.dev, \"Write register failed, %d\\n\", rc);\n}\n\nstatic const struct power_off_cfg linkstation_power_off_cfg = {\n\t.mdio_node_name = \"mdio\",\n\t.phy_set_reg = linkstation_mvphy_reg_intn,\n};\n\nstatic const struct power_off_cfg readynas_power_off_cfg = {\n\t.mdio_node_name = \"mdio-bus\",\n\t.phy_set_reg = readynas_mvphy_set_reg,\n};\n\nstatic int linkstation_reboot_notifier(struct notifier_block *nb,\n\t\t\t\t       unsigned long action, void *unused)\n{\n\tif (action == SYS_RESTART)\n\t\tcfg->phy_set_reg(true);\n\n\treturn NOTIFY_DONE;\n}\n\nstatic struct notifier_block linkstation_reboot_nb = {\n\t.notifier_call = linkstation_reboot_notifier,\n};\n\nstatic void linkstation_poweroff(void)\n{\n\tunregister_reboot_notifier(&linkstation_reboot_nb);\n\tcfg->phy_set_reg(false);\n\n\tkernel_restart(\"Power off\");\n}\n\nstatic const struct of_device_id ls_poweroff_of_match[] = {\n\t{ .compatible = \"buffalo,ls421d\",\n\t  .data = &linkstation_power_off_cfg,\n\t},\n\t{ .compatible = \"buffalo,ls421de\",\n\t  .data = &linkstation_power_off_cfg,\n\t},\n\t{ .compatible = \"netgear,readynas-duo-v2\",\n\t  .data = &readynas_power_off_cfg,\n\t},\n\t{ },\n};\n\nstatic int __init linkstation_poweroff_init(void)\n{\n\tstruct mii_bus *bus;\n\tstruct device_node *dn;\n\tconst struct of_device_id *match;\n\n\tdn = of_find_matching_node(NULL, ls_poweroff_of_match);\n\tif (!dn)\n\t\treturn -ENODEV;\n\tof_node_put(dn);\n\n\tmatch = of_match_node(ls_poweroff_of_match, dn);\n\tcfg = match->data;\n\n\tdn = of_find_node_by_name(NULL, cfg->mdio_node_name);\n\tif (!dn)\n\t\treturn -ENODEV;\n\n\tbus = of_mdio_find_bus(dn);\n\tof_node_put(dn);\n\tif (!bus)\n\t\treturn -EPROBE_DEFER;\n\n\tphydev = phy_find_first(bus);\n\tput_device(&bus->dev);\n\tif (!phydev)\n\t\treturn -EPROBE_DEFER;\n\n\tregister_reboot_notifier(&linkstation_reboot_nb);\n\tpm_power_off = linkstation_poweroff;\n\n\treturn 0;\n}\n\nstatic void __exit linkstation_poweroff_exit(void)\n{\n\tpm_power_off = NULL;\n\tunregister_reboot_notifier(&linkstation_reboot_nb);\n}\n\nmodule_init(linkstation_poweroff_init);\nmodule_exit(linkstation_poweroff_exit);\n\nMODULE_AUTHOR(\"Daniel Gonz\u00e1lez Cabanelas <dgcbueu@gmail.com>\");\nMODULE_DESCRIPTION(\"LinkStation power off driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}