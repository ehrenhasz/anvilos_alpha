{
  "module_name": "piix4-poweroff.c",
  "hash_id": "61fdaa21a0539bba1ac0ec75ad4aba773cd0d0300946a2dedcea7b885b65b1d4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/reset/piix4-poweroff.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/pm.h>\n\nstatic struct pci_dev *pm_dev;\nstatic resource_size_t io_offset;\n\nenum piix4_pm_io_reg {\n\tPIIX4_FUNC3IO_PMSTS\t\t\t= 0x00,\n#define PIIX4_FUNC3IO_PMSTS_PWRBTN_STS\t\tBIT(8)\n\tPIIX4_FUNC3IO_PMCNTRL\t\t\t= 0x04,\n#define PIIX4_FUNC3IO_PMCNTRL_SUS_EN\t\tBIT(13)\n#define PIIX4_FUNC3IO_PMCNTRL_SUS_TYP_SOFF\t(0x0 << 10)\n};\n\n#define PIIX4_SUSPEND_MAGIC\t\t\t0x00120002\n\nstatic const int piix4_pm_io_region = PCI_BRIDGE_RESOURCES;\n\nstatic void piix4_poweroff(void)\n{\n\tint spec_devid;\n\tu16 sts;\n\n\t \n\twhile (1) {\n\t\tsts = inw(io_offset + PIIX4_FUNC3IO_PMSTS);\n\t\tif (!(sts & PIIX4_FUNC3IO_PMSTS_PWRBTN_STS))\n\t\t\tbreak;\n\t\toutw(sts, io_offset + PIIX4_FUNC3IO_PMSTS);\n\t}\n\n\t \n\toutw(PIIX4_FUNC3IO_PMCNTRL_SUS_TYP_SOFF | PIIX4_FUNC3IO_PMCNTRL_SUS_EN,\n\t     io_offset + PIIX4_FUNC3IO_PMCNTRL);\n\n\t \n\tmdelay(10);\n\n\t \n\tspec_devid = PCI_DEVID(0, PCI_DEVFN(0x1f, 0x7));\n\tpci_bus_write_config_dword(pm_dev->bus, spec_devid, 0,\n\t\t\t\t   PIIX4_SUSPEND_MAGIC);\n\n\t \n\tmdelay(1000);\n\tpr_emerg(\"Unable to poweroff system\\n\");\n}\n\nstatic int piix4_poweroff_probe(struct pci_dev *dev,\n\t\t\t\tconst struct pci_device_id *id)\n{\n\tint res;\n\n\tif (pm_dev)\n\t\treturn -EINVAL;\n\n\t \n\tres = pci_request_region(dev, piix4_pm_io_region,\n\t\t\t\t \"PIIX4 PM IO registers\");\n\tif (res) {\n\t\tdev_err(&dev->dev, \"failed to request PM IO registers: %d\\n\",\n\t\t\tres);\n\t\treturn res;\n\t}\n\n\tpm_dev = dev;\n\tio_offset = pci_resource_start(dev, piix4_pm_io_region);\n\tpm_power_off = piix4_poweroff;\n\n\treturn 0;\n}\n\nstatic void piix4_poweroff_remove(struct pci_dev *dev)\n{\n\tif (pm_power_off == piix4_poweroff)\n\t\tpm_power_off = NULL;\n\n\tpci_release_region(dev, piix4_pm_io_region);\n\tpm_dev = NULL;\n}\n\nstatic const struct pci_device_id piix4_poweroff_ids[] = {\n\t{ PCI_DEVICE(PCI_VENDOR_ID_INTEL, PCI_DEVICE_ID_INTEL_82371AB_3) },\n\t{ 0 },\n};\n\nstatic struct pci_driver piix4_poweroff_driver = {\n\t.name\t\t= \"piix4-poweroff\",\n\t.id_table\t= piix4_poweroff_ids,\n\t.probe\t\t= piix4_poweroff_probe,\n\t.remove\t\t= piix4_poweroff_remove,\n};\n\nmodule_pci_driver(piix4_poweroff_driver);\nMODULE_AUTHOR(\"Paul Burton <paul.burton@mips.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}