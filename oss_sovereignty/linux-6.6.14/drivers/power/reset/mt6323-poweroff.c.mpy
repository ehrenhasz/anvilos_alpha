{
  "module_name": "mt6323-poweroff.c",
  "hash_id": "89fe11f6a1f903f77c91d9901b762a2836b9c8c95cba35db7408e24bdc374172",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/reset/mt6323-poweroff.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/mfd/mt6397/core.h>\n#include <linux/mfd/mt6397/rtc.h>\n\nstruct mt6323_pwrc {\n\tstruct device *dev;\n\tstruct regmap *regmap;\n\tu32 base;\n};\n\nstatic struct mt6323_pwrc *mt_pwrc;\n\nstatic void mt6323_do_pwroff(void)\n{\n\tstruct mt6323_pwrc *pwrc = mt_pwrc;\n\tunsigned int val;\n\tint ret;\n\n\tregmap_write(pwrc->regmap, pwrc->base + RTC_BBPU, RTC_BBPU_KEY);\n\tregmap_write(pwrc->regmap, pwrc->base + RTC_WRTGR_MT6323, 1);\n\n\tret = regmap_read_poll_timeout(pwrc->regmap,\n\t\t\t\t\tpwrc->base + RTC_BBPU, val,\n\t\t\t\t\t!(val & RTC_BBPU_CBUSY),\n\t\t\t\t\tMTK_RTC_POLL_DELAY_US,\n\t\t\t\t\tMTK_RTC_POLL_TIMEOUT);\n\tif (ret)\n\t\tdev_err(pwrc->dev, \"failed to write BBPU: %d\\n\", ret);\n\n\t \n\tmdelay(1000);\n\n\tWARN_ONCE(1, \"Unable to power off system\\n\");\n}\n\nstatic int mt6323_pwrc_probe(struct platform_device *pdev)\n{\n\tstruct mt6397_chip *mt6397_chip = dev_get_drvdata(pdev->dev.parent);\n\tstruct mt6323_pwrc *pwrc;\n\tstruct resource *res;\n\n\tpwrc = devm_kzalloc(&pdev->dev, sizeof(*pwrc), GFP_KERNEL);\n\tif (!pwrc)\n\t\treturn -ENOMEM;\n\n\tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!res)\n\t\treturn -EINVAL;\n\n\tpwrc->base = res->start;\n\tpwrc->regmap = mt6397_chip->regmap;\n\tpwrc->dev = &pdev->dev;\n\tmt_pwrc = pwrc;\n\n\tpm_power_off = &mt6323_do_pwroff;\n\n\treturn 0;\n}\n\nstatic int mt6323_pwrc_remove(struct platform_device *pdev)\n{\n\tif (pm_power_off == &mt6323_do_pwroff)\n\t\tpm_power_off = NULL;\n\n\treturn 0;\n}\n\nstatic const struct of_device_id mt6323_pwrc_dt_match[] = {\n\t{ .compatible = \"mediatek,mt6323-pwrc\" },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, mt6323_pwrc_dt_match);\n\nstatic struct platform_driver mt6323_pwrc_driver = {\n\t.probe          = mt6323_pwrc_probe,\n\t.remove         = mt6323_pwrc_remove,\n\t.driver         = {\n\t\t.name   = \"mt6323-pwrc\",\n\t\t.of_match_table = mt6323_pwrc_dt_match,\n\t},\n};\n\nmodule_platform_driver(mt6323_pwrc_driver);\n\nMODULE_DESCRIPTION(\"Poweroff driver for MT6323 PMIC\");\nMODULE_AUTHOR(\"Sean Wang <sean.wang@mediatek.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}