{
  "module_name": "st-poweroff.c",
  "hash_id": "e0abf368376ca074ff211093ac22852d2ddce4cddc9ff22b26bf7bc77c975364",
  "original_prompt": "Ingested from linux-6.6.14/drivers/power/reset/st-poweroff.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_device.h>\n#include <linux/platform_device.h>\n#include <linux/mfd/syscon.h>\n#include <linux/reboot.h>\n#include <linux/regmap.h>\n\nstruct reset_syscfg {\n\tstruct regmap *regmap;\n\t \n\tunsigned int offset_rst;\n\tunsigned int mask_rst;\n\t \n\tunsigned int offset_rst_msk;\n\tunsigned int mask_rst_msk;\n};\n\n \n#define STIH407_SYSCFG_4000\t0x0\n#define STIH407_SYSCFG_4008\t0x20\n\nstatic struct reset_syscfg stih407_reset = {\n\t.offset_rst = STIH407_SYSCFG_4000,\n\t.mask_rst = BIT(0),\n\t.offset_rst_msk = STIH407_SYSCFG_4008,\n\t.mask_rst_msk = BIT(0)\n};\n\n\nstatic struct reset_syscfg *st_restart_syscfg;\n\nstatic int st_restart(struct notifier_block *this, unsigned long mode,\n\t\t      void *cmd)\n{\n\t \n\tregmap_update_bits(st_restart_syscfg->regmap,\n\t\t\t   st_restart_syscfg->offset_rst,\n\t\t\t   st_restart_syscfg->mask_rst,\n\t\t\t   0);\n\n\t \n\tregmap_update_bits(st_restart_syscfg->regmap,\n\t\t\t   st_restart_syscfg->offset_rst_msk,\n\t\t\t   st_restart_syscfg->mask_rst_msk,\n\t\t\t   0);\n\n\treturn NOTIFY_DONE;\n}\n\nstatic struct notifier_block st_restart_nb = {\n\t.notifier_call = st_restart,\n\t.priority = 192,\n};\n\nstatic const struct of_device_id st_reset_of_match[] = {\n\t{\n\t\t.compatible = \"st,stih407-restart\",\n\t\t.data = (void *)&stih407_reset,\n\t},\n\t{}\n};\n\nstatic int st_reset_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tconst struct of_device_id *match;\n\tstruct device *dev = &pdev->dev;\n\n\tmatch = of_match_device(st_reset_of_match, dev);\n\tif (!match)\n\t\treturn -ENODEV;\n\n\tst_restart_syscfg = (struct reset_syscfg *)match->data;\n\n\tst_restart_syscfg->regmap =\n\t\tsyscon_regmap_lookup_by_phandle(np, \"st,syscfg\");\n\tif (IS_ERR(st_restart_syscfg->regmap)) {\n\t\tdev_err(dev, \"No syscfg phandle specified\\n\");\n\t\treturn PTR_ERR(st_restart_syscfg->regmap);\n\t}\n\n\treturn register_restart_handler(&st_restart_nb);\n}\n\nstatic struct platform_driver st_reset_driver = {\n\t.probe = st_reset_probe,\n\t.driver = {\n\t\t.name = \"st_reset\",\n\t\t.of_match_table = st_reset_of_match,\n\t},\n};\n\nstatic int __init st_reset_init(void)\n{\n\treturn platform_driver_register(&st_reset_driver);\n}\n\ndevice_initcall(st_reset_init);\n\nMODULE_AUTHOR(\"Christophe Kerello <christophe.kerello@st.com>\");\nMODULE_DESCRIPTION(\"STMicroelectronics Power off Restart driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}