{
  "module_name": "topology.c",
  "hash_id": "f62df9136899727d013f81b9d00501582eef716b7ded67341b27de336cbbaac4",
  "original_prompt": "Ingested from linux-6.6.14/drivers/base/topology.c",
  "human_readable_source": "\n \n#include <linux/mm.h>\n#include <linux/cpu.h>\n#include <linux/module.h>\n#include <linux/hardirq.h>\n#include <linux/topology.h>\n\n#define define_id_show_func(name, fmt)\t\t\t\t\t\\\nstatic ssize_t name##_show(struct device *dev,\t\t\t\t\\\n\t\t\t   struct device_attribute *attr, char *buf)\t\\\n{\t\t\t\t\t\t\t\t\t\\\n\treturn sysfs_emit(buf, fmt \"\\n\", topology_##name(dev->id));\t\\\n}\n\n#define define_siblings_read_func(name, mask)\t\t\t\t\t\\\nstatic ssize_t name##_read(struct file *file, struct kobject *kobj,\t\t\\\n\t\t\t   struct bin_attribute *attr, char *buf,\t\t\\\n\t\t\t   loff_t off, size_t count)\t\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\t\\\n\tstruct device *dev = kobj_to_dev(kobj);                                 \\\n\t\t\t\t\t\t\t\t\t\t\\\n\treturn cpumap_print_bitmask_to_buf(buf, topology_##mask(dev->id),\t\\\n\t\t\t\t\t   off, count);                         \\\n}\t\t\t\t\t\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\t\\\nstatic ssize_t name##_list_read(struct file *file, struct kobject *kobj,\t\\\n\t\t\t\tstruct bin_attribute *attr, char *buf,\t\t\\\n\t\t\t\tloff_t off, size_t count)\t\t\t\\\n{\t\t\t\t\t\t\t\t\t\t\\\n\tstruct device *dev = kobj_to_dev(kobj);\t\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\t\\\n\treturn cpumap_print_list_to_buf(buf, topology_##mask(dev->id),\t\t\\\n\t\t\t\t\toff, count);\t\t\t\t\\\n}\n\ndefine_id_show_func(physical_package_id, \"%d\");\nstatic DEVICE_ATTR_RO(physical_package_id);\n\n#ifdef TOPOLOGY_DIE_SYSFS\ndefine_id_show_func(die_id, \"%d\");\nstatic DEVICE_ATTR_RO(die_id);\n#endif\n\n#ifdef TOPOLOGY_CLUSTER_SYSFS\ndefine_id_show_func(cluster_id, \"%d\");\nstatic DEVICE_ATTR_RO(cluster_id);\n#endif\n\ndefine_id_show_func(core_id, \"%d\");\nstatic DEVICE_ATTR_RO(core_id);\n\ndefine_id_show_func(ppin, \"0x%llx\");\nstatic DEVICE_ATTR_ADMIN_RO(ppin);\n\ndefine_siblings_read_func(thread_siblings, sibling_cpumask);\nstatic BIN_ATTR_RO(thread_siblings, CPUMAP_FILE_MAX_BYTES);\nstatic BIN_ATTR_RO(thread_siblings_list, CPULIST_FILE_MAX_BYTES);\n\ndefine_siblings_read_func(core_cpus, sibling_cpumask);\nstatic BIN_ATTR_RO(core_cpus, CPUMAP_FILE_MAX_BYTES);\nstatic BIN_ATTR_RO(core_cpus_list, CPULIST_FILE_MAX_BYTES);\n\ndefine_siblings_read_func(core_siblings, core_cpumask);\nstatic BIN_ATTR_RO(core_siblings, CPUMAP_FILE_MAX_BYTES);\nstatic BIN_ATTR_RO(core_siblings_list, CPULIST_FILE_MAX_BYTES);\n\n#ifdef TOPOLOGY_CLUSTER_SYSFS\ndefine_siblings_read_func(cluster_cpus, cluster_cpumask);\nstatic BIN_ATTR_RO(cluster_cpus, CPUMAP_FILE_MAX_BYTES);\nstatic BIN_ATTR_RO(cluster_cpus_list, CPULIST_FILE_MAX_BYTES);\n#endif\n\n#ifdef TOPOLOGY_DIE_SYSFS\ndefine_siblings_read_func(die_cpus, die_cpumask);\nstatic BIN_ATTR_RO(die_cpus, CPUMAP_FILE_MAX_BYTES);\nstatic BIN_ATTR_RO(die_cpus_list, CPULIST_FILE_MAX_BYTES);\n#endif\n\ndefine_siblings_read_func(package_cpus, core_cpumask);\nstatic BIN_ATTR_RO(package_cpus, CPUMAP_FILE_MAX_BYTES);\nstatic BIN_ATTR_RO(package_cpus_list, CPULIST_FILE_MAX_BYTES);\n\n#ifdef TOPOLOGY_BOOK_SYSFS\ndefine_id_show_func(book_id, \"%d\");\nstatic DEVICE_ATTR_RO(book_id);\ndefine_siblings_read_func(book_siblings, book_cpumask);\nstatic BIN_ATTR_RO(book_siblings, CPUMAP_FILE_MAX_BYTES);\nstatic BIN_ATTR_RO(book_siblings_list, CPULIST_FILE_MAX_BYTES);\n#endif\n\n#ifdef TOPOLOGY_DRAWER_SYSFS\ndefine_id_show_func(drawer_id, \"%d\");\nstatic DEVICE_ATTR_RO(drawer_id);\ndefine_siblings_read_func(drawer_siblings, drawer_cpumask);\nstatic BIN_ATTR_RO(drawer_siblings, CPUMAP_FILE_MAX_BYTES);\nstatic BIN_ATTR_RO(drawer_siblings_list, CPULIST_FILE_MAX_BYTES);\n#endif\n\nstatic struct bin_attribute *bin_attrs[] = {\n\t&bin_attr_core_cpus,\n\t&bin_attr_core_cpus_list,\n\t&bin_attr_thread_siblings,\n\t&bin_attr_thread_siblings_list,\n\t&bin_attr_core_siblings,\n\t&bin_attr_core_siblings_list,\n#ifdef TOPOLOGY_CLUSTER_SYSFS\n\t&bin_attr_cluster_cpus,\n\t&bin_attr_cluster_cpus_list,\n#endif\n#ifdef TOPOLOGY_DIE_SYSFS\n\t&bin_attr_die_cpus,\n\t&bin_attr_die_cpus_list,\n#endif\n\t&bin_attr_package_cpus,\n\t&bin_attr_package_cpus_list,\n#ifdef TOPOLOGY_BOOK_SYSFS\n\t&bin_attr_book_siblings,\n\t&bin_attr_book_siblings_list,\n#endif\n#ifdef TOPOLOGY_DRAWER_SYSFS\n\t&bin_attr_drawer_siblings,\n\t&bin_attr_drawer_siblings_list,\n#endif\n\tNULL\n};\n\nstatic struct attribute *default_attrs[] = {\n\t&dev_attr_physical_package_id.attr,\n#ifdef TOPOLOGY_DIE_SYSFS\n\t&dev_attr_die_id.attr,\n#endif\n#ifdef TOPOLOGY_CLUSTER_SYSFS\n\t&dev_attr_cluster_id.attr,\n#endif\n\t&dev_attr_core_id.attr,\n#ifdef TOPOLOGY_BOOK_SYSFS\n\t&dev_attr_book_id.attr,\n#endif\n#ifdef TOPOLOGY_DRAWER_SYSFS\n\t&dev_attr_drawer_id.attr,\n#endif\n\t&dev_attr_ppin.attr,\n\tNULL\n};\n\nstatic umode_t topology_is_visible(struct kobject *kobj,\n\t\t\t\t   struct attribute *attr, int unused)\n{\n\tif (attr == &dev_attr_ppin.attr && !topology_ppin(kobj_to_dev(kobj)->id))\n\t\treturn 0;\n\n\treturn attr->mode;\n}\n\nstatic const struct attribute_group topology_attr_group = {\n\t.attrs = default_attrs,\n\t.bin_attrs = bin_attrs,\n\t.is_visible = topology_is_visible,\n\t.name = \"topology\"\n};\n\n \nstatic int topology_add_dev(unsigned int cpu)\n{\n\tstruct device *dev = get_cpu_device(cpu);\n\n\treturn sysfs_create_group(&dev->kobj, &topology_attr_group);\n}\n\nstatic int topology_remove_dev(unsigned int cpu)\n{\n\tstruct device *dev = get_cpu_device(cpu);\n\n\tsysfs_remove_group(&dev->kobj, &topology_attr_group);\n\treturn 0;\n}\n\nstatic int __init topology_sysfs_init(void)\n{\n\treturn cpuhp_setup_state(CPUHP_TOPOLOGY_PREPARE,\n\t\t\t\t \"base/topology:prepare\", topology_add_dev,\n\t\t\t\t topology_remove_dev);\n}\n\ndevice_initcall(topology_sysfs_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}