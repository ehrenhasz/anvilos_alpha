{
  "module_name": "nokia-modem.c",
  "hash_id": "56cdc7bec5f28b3a7132c3685527f732d720e1b5defd4ed10c58e0677e569c61",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hsi/clients/nokia-modem.c",
  "human_readable_source": "\n \n\n#include <linux/gpio/consumer.h>\n#include <linux/hsi/hsi.h>\n#include <linux/init.h>\n#include <linux/interrupt.h>\n#include <linux/of.h>\n#include <linux/of_irq.h>\n#include <linux/hsi/ssi_protocol.h>\n\nstatic unsigned int pm = 1;\nmodule_param(pm, int, 0400);\nMODULE_PARM_DESC(pm,\n\t\"Enable power management (0=disabled, 1=userland based [default])\");\n\nstruct nokia_modem_gpio {\n\tstruct gpio_desc\t*gpio;\n\tconst char\t\t*name;\n};\n\nstruct nokia_modem_device {\n\tstruct tasklet_struct\tnokia_modem_rst_ind_tasklet;\n\tint\t\t\tnokia_modem_rst_ind_irq;\n\tstruct device\t\t*device;\n\tstruct nokia_modem_gpio\t*gpios;\n\tint\t\t\tgpio_amount;\n\tstruct hsi_client\t*ssi_protocol;\n\tstruct hsi_client\t*cmt_speech;\n};\n\nstatic void do_nokia_modem_rst_ind_tasklet(unsigned long data)\n{\n\tstruct nokia_modem_device *modem = (struct nokia_modem_device *)data;\n\n\tif (!modem)\n\t\treturn;\n\n\tdev_info(modem->device, \"CMT rst line change detected\\n\");\n\n\tif (modem->ssi_protocol)\n\t\tssip_reset_event(modem->ssi_protocol);\n}\n\nstatic irqreturn_t nokia_modem_rst_ind_isr(int irq, void *data)\n{\n\tstruct nokia_modem_device *modem = (struct nokia_modem_device *)data;\n\n\ttasklet_schedule(&modem->nokia_modem_rst_ind_tasklet);\n\n\treturn IRQ_HANDLED;\n}\n\nstatic void nokia_modem_gpio_unexport(struct device *dev)\n{\n\tstruct nokia_modem_device *modem = dev_get_drvdata(dev);\n\tint i;\n\n\tfor (i = 0; i < modem->gpio_amount; i++) {\n\t\tsysfs_remove_link(&dev->kobj, modem->gpios[i].name);\n\t\tgpiod_unexport(modem->gpios[i].gpio);\n\t}\n}\n\nstatic int nokia_modem_gpio_probe(struct device *dev)\n{\n\tstruct device_node *np = dev->of_node;\n\tstruct nokia_modem_device *modem = dev_get_drvdata(dev);\n\tint gpio_count, gpio_name_count, i, err;\n\n\tgpio_count = gpiod_count(dev, NULL);\n\tif (gpio_count < 0) {\n\t\tdev_err(dev, \"missing gpios: %d\\n\", gpio_count);\n\t\treturn gpio_count;\n\t}\n\n\tgpio_name_count = of_property_count_strings(np, \"gpio-names\");\n\n\tif (gpio_count != gpio_name_count) {\n\t\tdev_err(dev, \"number of gpios does not equal number of gpio names\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tmodem->gpios = devm_kcalloc(dev, gpio_count, sizeof(*modem->gpios),\n\t\t\t\t    GFP_KERNEL);\n\tif (!modem->gpios)\n\t\treturn -ENOMEM;\n\n\tmodem->gpio_amount = gpio_count;\n\n\tfor (i = 0; i < gpio_count; i++) {\n\t\tmodem->gpios[i].gpio = devm_gpiod_get_index(dev, NULL, i,\n\t\t\t\t\t\t\t    GPIOD_OUT_LOW);\n\t\tif (IS_ERR(modem->gpios[i].gpio)) {\n\t\t\tdev_err(dev, \"Could not get gpio %d\\n\", i);\n\t\t\treturn PTR_ERR(modem->gpios[i].gpio);\n\t\t}\n\n\t\terr = of_property_read_string_index(np, \"gpio-names\", i,\n\t\t\t\t\t\t&(modem->gpios[i].name));\n\t\tif (err) {\n\t\t\tdev_err(dev, \"Could not get gpio name %d\\n\", i);\n\t\t\treturn err;\n\t\t}\n\n\t\terr = gpiod_export(modem->gpios[i].gpio, 0);\n\t\tif (err)\n\t\t\treturn err;\n\n\t\terr = gpiod_export_link(dev, modem->gpios[i].name,\n\t\t\t\t\t\t\tmodem->gpios[i].gpio);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic int nokia_modem_probe(struct device *dev)\n{\n\tstruct device_node *np;\n\tstruct nokia_modem_device *modem;\n\tstruct hsi_client *cl = to_hsi_client(dev);\n\tstruct hsi_port *port = hsi_get_port(cl);\n\tint irq, pflags, err;\n\tstruct hsi_board_info ssip;\n\tstruct hsi_board_info cmtspeech;\n\n\tnp = dev->of_node;\n\tif (!np) {\n\t\tdev_err(dev, \"device tree node not found\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\tmodem = devm_kzalloc(dev, sizeof(*modem), GFP_KERNEL);\n\tif (!modem)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(dev, modem);\n\tmodem->device = dev;\n\n\tirq = irq_of_parse_and_map(np, 0);\n\tif (!irq) {\n\t\tdev_err(dev, \"Invalid rst_ind interrupt (%d)\\n\", irq);\n\t\treturn -EINVAL;\n\t}\n\tmodem->nokia_modem_rst_ind_irq = irq;\n\tpflags = irq_get_trigger_type(irq);\n\n\ttasklet_init(&modem->nokia_modem_rst_ind_tasklet,\n\t\t\tdo_nokia_modem_rst_ind_tasklet, (unsigned long)modem);\n\terr = devm_request_irq(dev, irq, nokia_modem_rst_ind_isr,\n\t\t\t\tpflags, \"modem_rst_ind\", modem);\n\tif (err < 0) {\n\t\tdev_err(dev, \"Request rst_ind irq(%d) failed (flags %d)\\n\",\n\t\t\t\t\t\t\t\tirq, pflags);\n\t\treturn err;\n\t}\n\tenable_irq_wake(irq);\n\n\tif (pm) {\n\t\terr = nokia_modem_gpio_probe(dev);\n\t\tif (err < 0) {\n\t\t\tdev_err(dev, \"Could not probe GPIOs\\n\");\n\t\t\tgoto error1;\n\t\t}\n\t}\n\n\tssip.name = \"ssi-protocol\";\n\tssip.tx_cfg = cl->tx_cfg;\n\tssip.rx_cfg = cl->rx_cfg;\n\tssip.platform_data = NULL;\n\tssip.archdata = NULL;\n\n\tmodem->ssi_protocol = hsi_new_client(port, &ssip);\n\tif (!modem->ssi_protocol) {\n\t\tdev_err(dev, \"Could not register ssi-protocol device\\n\");\n\t\terr = -ENOMEM;\n\t\tgoto error2;\n\t}\n\n\terr = device_attach(&modem->ssi_protocol->device);\n\tif (err == 0) {\n\t\tdev_dbg(dev, \"Missing ssi-protocol driver\\n\");\n\t\terr = -EPROBE_DEFER;\n\t\tgoto error3;\n\t} else if (err < 0) {\n\t\tdev_err(dev, \"Could not load ssi-protocol driver (%d)\\n\", err);\n\t\tgoto error3;\n\t}\n\n\tcmtspeech.name = \"cmt-speech\";\n\tcmtspeech.tx_cfg = cl->tx_cfg;\n\tcmtspeech.rx_cfg = cl->rx_cfg;\n\tcmtspeech.platform_data = NULL;\n\tcmtspeech.archdata = NULL;\n\n\tmodem->cmt_speech = hsi_new_client(port, &cmtspeech);\n\tif (!modem->cmt_speech) {\n\t\tdev_err(dev, \"Could not register cmt-speech device\\n\");\n\t\terr = -ENOMEM;\n\t\tgoto error3;\n\t}\n\n\terr = device_attach(&modem->cmt_speech->device);\n\tif (err == 0) {\n\t\tdev_dbg(dev, \"Missing cmt-speech driver\\n\");\n\t\terr = -EPROBE_DEFER;\n\t\tgoto error4;\n\t} else if (err < 0) {\n\t\tdev_err(dev, \"Could not load cmt-speech driver (%d)\\n\", err);\n\t\tgoto error4;\n\t}\n\n\tdev_info(dev, \"Registered Nokia HSI modem\\n\");\n\n\treturn 0;\n\nerror4:\n\thsi_remove_client(&modem->cmt_speech->device, NULL);\nerror3:\n\thsi_remove_client(&modem->ssi_protocol->device, NULL);\nerror2:\n\tnokia_modem_gpio_unexport(dev);\nerror1:\n\tdisable_irq_wake(modem->nokia_modem_rst_ind_irq);\n\ttasklet_kill(&modem->nokia_modem_rst_ind_tasklet);\n\n\treturn err;\n}\n\nstatic int nokia_modem_remove(struct device *dev)\n{\n\tstruct nokia_modem_device *modem = dev_get_drvdata(dev);\n\n\tif (!modem)\n\t\treturn 0;\n\n\tif (modem->cmt_speech) {\n\t\thsi_remove_client(&modem->cmt_speech->device, NULL);\n\t\tmodem->cmt_speech = NULL;\n\t}\n\n\tif (modem->ssi_protocol) {\n\t\thsi_remove_client(&modem->ssi_protocol->device, NULL);\n\t\tmodem->ssi_protocol = NULL;\n\t}\n\n\tnokia_modem_gpio_unexport(dev);\n\tdev_set_drvdata(dev, NULL);\n\tdisable_irq_wake(modem->nokia_modem_rst_ind_irq);\n\ttasklet_kill(&modem->nokia_modem_rst_ind_tasklet);\n\n\treturn 0;\n}\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id nokia_modem_of_match[] = {\n\t{ .compatible = \"nokia,n900-modem\", },\n\t{ .compatible = \"nokia,n950-modem\", },\n\t{ .compatible = \"nokia,n9-modem\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, nokia_modem_of_match);\n#endif\n\nstatic struct hsi_client_driver nokia_modem_driver = {\n\t.driver = {\n\t\t.name\t= \"nokia-modem\",\n\t\t.owner\t= THIS_MODULE,\n\t\t.probe\t= nokia_modem_probe,\n\t\t.remove\t= nokia_modem_remove,\n\t\t.of_match_table = of_match_ptr(nokia_modem_of_match),\n\t},\n};\n\nstatic int __init nokia_modem_init(void)\n{\n\treturn hsi_register_client_driver(&nokia_modem_driver);\n}\nmodule_init(nokia_modem_init);\n\nstatic void __exit nokia_modem_exit(void)\n{\n\thsi_unregister_client_driver(&nokia_modem_driver);\n}\nmodule_exit(nokia_modem_exit);\n\nMODULE_ALIAS(\"hsi:nokia-modem\");\nMODULE_AUTHOR(\"Sebastian Reichel <sre@kernel.org>\");\nMODULE_DESCRIPTION(\"HSI driver module for Nokia N900 Modem\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}