{
  "module_name": "reset-brcmstb-rescal.c",
  "hash_id": "c084ceabe269de6e162506787aae8f9f57d0622af744277cccda3443bad46979",
  "original_prompt": "Ingested from linux-6.6.14/drivers/reset/reset-brcmstb-rescal.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/iopoll.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/reset-controller.h>\n\n#define BRCM_RESCAL_START\t0x0\n#define  BRCM_RESCAL_START_BIT\tBIT(0)\n#define BRCM_RESCAL_CTRL\t0x4\n#define BRCM_RESCAL_STATUS\t0x8\n#define  BRCM_RESCAL_STATUS_BIT\tBIT(0)\n\nstruct brcm_rescal_reset {\n\tvoid __iomem *base;\n\tstruct device *dev;\n\tstruct reset_controller_dev rcdev;\n};\n\nstatic int brcm_rescal_reset_set(struct reset_controller_dev *rcdev,\n\t\t\t\t unsigned long id)\n{\n\tstruct brcm_rescal_reset *data =\n\t\tcontainer_of(rcdev, struct brcm_rescal_reset, rcdev);\n\tvoid __iomem *base = data->base;\n\tu32 reg;\n\tint ret;\n\n\treg = readl(base + BRCM_RESCAL_START);\n\twritel(reg | BRCM_RESCAL_START_BIT, base + BRCM_RESCAL_START);\n\treg = readl(base + BRCM_RESCAL_START);\n\tif (!(reg & BRCM_RESCAL_START_BIT)) {\n\t\tdev_err(data->dev, \"failed to start SATA/PCIe rescal\\n\");\n\t\treturn -EIO;\n\t}\n\n\tret = readl_poll_timeout(base + BRCM_RESCAL_STATUS, reg,\n\t\t\t\t (reg & BRCM_RESCAL_STATUS_BIT), 100, 1000);\n\tif (ret) {\n\t\tdev_err(data->dev, \"time out on SATA/PCIe rescal\\n\");\n\t\treturn ret;\n\t}\n\n\treg = readl(base + BRCM_RESCAL_START);\n\twritel(reg & ~BRCM_RESCAL_START_BIT, base + BRCM_RESCAL_START);\n\n\tdev_dbg(data->dev, \"SATA/PCIe rescal success\\n\");\n\n\treturn 0;\n}\n\nstatic int brcm_rescal_reset_xlate(struct reset_controller_dev *rcdev,\n\t\t\t\t   const struct of_phandle_args *reset_spec)\n{\n\t \n\treturn 0;\n}\n\nstatic const struct reset_control_ops brcm_rescal_reset_ops = {\n\t.reset = brcm_rescal_reset_set,\n};\n\nstatic int brcm_rescal_reset_probe(struct platform_device *pdev)\n{\n\tstruct brcm_rescal_reset *data;\n\n\tdata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tdata->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(data->base))\n\t\treturn PTR_ERR(data->base);\n\n\tdata->rcdev.owner = THIS_MODULE;\n\tdata->rcdev.nr_resets = 1;\n\tdata->rcdev.ops = &brcm_rescal_reset_ops;\n\tdata->rcdev.of_node = pdev->dev.of_node;\n\tdata->rcdev.of_xlate = brcm_rescal_reset_xlate;\n\tdata->dev = &pdev->dev;\n\n\treturn devm_reset_controller_register(&pdev->dev, &data->rcdev);\n}\n\nstatic const struct of_device_id brcm_rescal_reset_of_match[] = {\n\t{ .compatible = \"brcm,bcm7216-pcie-sata-rescal\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, brcm_rescal_reset_of_match);\n\nstatic struct platform_driver brcm_rescal_reset_driver = {\n\t.probe = brcm_rescal_reset_probe,\n\t.driver = {\n\t\t.name\t= \"brcm-rescal-reset\",\n\t\t.of_match_table\t= brcm_rescal_reset_of_match,\n\t}\n};\nmodule_platform_driver(brcm_rescal_reset_driver);\n\nMODULE_AUTHOR(\"Broadcom\");\nMODULE_DESCRIPTION(\"Broadcom SATA/PCIe rescal reset controller\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}