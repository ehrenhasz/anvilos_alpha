{
  "module_name": "reset-hi3660.c",
  "hash_id": "172dc0f69e2a36d2b14d4f20ef093cb914d051adb5245d5c5455b480e2de46d8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/reset/hisilicon/reset-hi3660.c",
  "human_readable_source": "\n \n#include <linux/kernel.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/reset-controller.h>\n\nstruct hi3660_reset_controller {\n\tstruct reset_controller_dev rst;\n\tstruct regmap *map;\n};\n\n#define to_hi3660_reset_controller(_rst) \\\n\tcontainer_of(_rst, struct hi3660_reset_controller, rst)\n\nstatic int hi3660_reset_program_hw(struct reset_controller_dev *rcdev,\n\t\t\t\t   unsigned long idx, bool assert)\n{\n\tstruct hi3660_reset_controller *rc = to_hi3660_reset_controller(rcdev);\n\tunsigned int offset = idx >> 8;\n\tunsigned int mask = BIT(idx & 0x1f);\n\n\tif (assert)\n\t\treturn regmap_write(rc->map, offset, mask);\n\telse\n\t\treturn regmap_write(rc->map, offset + 4, mask);\n}\n\nstatic int hi3660_reset_assert(struct reset_controller_dev *rcdev,\n\t\t\t       unsigned long idx)\n{\n\treturn hi3660_reset_program_hw(rcdev, idx, true);\n}\n\nstatic int hi3660_reset_deassert(struct reset_controller_dev *rcdev,\n\t\t\t\t unsigned long idx)\n{\n\treturn hi3660_reset_program_hw(rcdev, idx, false);\n}\n\nstatic int hi3660_reset_dev(struct reset_controller_dev *rcdev,\n\t\t\t    unsigned long idx)\n{\n\tint err;\n\n\terr = hi3660_reset_assert(rcdev, idx);\n\tif (err)\n\t\treturn err;\n\n\treturn hi3660_reset_deassert(rcdev, idx);\n}\n\nstatic const struct reset_control_ops hi3660_reset_ops = {\n\t.reset    = hi3660_reset_dev,\n\t.assert   = hi3660_reset_assert,\n\t.deassert = hi3660_reset_deassert,\n};\n\nstatic int hi3660_reset_xlate(struct reset_controller_dev *rcdev,\n\t\t\t      const struct of_phandle_args *reset_spec)\n{\n\tunsigned int offset, bit;\n\n\toffset = reset_spec->args[0];\n\tbit = reset_spec->args[1];\n\n\treturn (offset << 8) | bit;\n}\n\nstatic int hi3660_reset_probe(struct platform_device *pdev)\n{\n\tstruct hi3660_reset_controller *rc;\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct device *dev = &pdev->dev;\n\n\trc = devm_kzalloc(dev, sizeof(*rc), GFP_KERNEL);\n\tif (!rc)\n\t\treturn -ENOMEM;\n\n\trc->map = syscon_regmap_lookup_by_phandle(np, \"hisilicon,rst-syscon\");\n\tif (rc->map == ERR_PTR(-ENODEV)) {\n\t\t \n\t\trc->map = syscon_regmap_lookup_by_phandle(np,\n\t\t\t\t\t\t\t  \"hisi,rst-syscon\");\n\t}\n\tif (IS_ERR(rc->map)) {\n\t\treturn dev_err_probe(dev, PTR_ERR(rc->map),\n\t\t\t\"failed to get hisilicon,rst-syscon\\n\");\n\t}\n\n\trc->rst.ops = &hi3660_reset_ops,\n\trc->rst.of_node = np;\n\trc->rst.of_reset_n_cells = 2;\n\trc->rst.of_xlate = hi3660_reset_xlate;\n\n\treturn reset_controller_register(&rc->rst);\n}\n\nstatic const struct of_device_id hi3660_reset_match[] = {\n\t{ .compatible = \"hisilicon,hi3660-reset\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, hi3660_reset_match);\n\nstatic struct platform_driver hi3660_reset_driver = {\n\t.probe = hi3660_reset_probe,\n\t.driver = {\n\t\t.name = \"hi3660-reset\",\n\t\t.of_match_table = hi3660_reset_match,\n\t},\n};\n\nstatic int __init hi3660_reset_init(void)\n{\n\treturn platform_driver_register(&hi3660_reset_driver);\n}\narch_initcall(hi3660_reset_init);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:hi3660-reset\");\nMODULE_DESCRIPTION(\"HiSilicon Hi3660 Reset Driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}