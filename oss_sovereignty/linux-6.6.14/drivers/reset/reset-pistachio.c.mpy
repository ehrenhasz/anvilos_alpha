{
  "module_name": "reset-pistachio.c",
  "hash_id": "223212d58b582e4d70d81b6fc11c3a7217a65c18aea7fbe7e8fd0c841a90328b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/reset/reset-pistachio.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/reset-controller.h>\n#include <linux/slab.h>\n#include <linux/mfd/syscon.h>\n\n#include <dt-bindings/reset/pistachio-resets.h>\n\n#define\tPISTACHIO_SOFT_RESET\t\t0\n\nstruct pistachio_reset_data {\n\tstruct reset_controller_dev\trcdev;\n\tstruct regmap\t\t\t*periph_regs;\n};\n\nstatic inline int pistachio_reset_shift(unsigned long id)\n{\n\tswitch (id) {\n\tcase PISTACHIO_RESET_I2C0:\n\tcase PISTACHIO_RESET_I2C1:\n\tcase PISTACHIO_RESET_I2C2:\n\tcase PISTACHIO_RESET_I2C3:\n\tcase PISTACHIO_RESET_I2S_IN:\n\tcase PISTACHIO_RESET_PRL_OUT:\n\tcase PISTACHIO_RESET_SPDIF_OUT:\n\tcase PISTACHIO_RESET_SPI:\n\tcase PISTACHIO_RESET_PWM_PDM:\n\tcase PISTACHIO_RESET_UART0:\n\tcase PISTACHIO_RESET_UART1:\n\tcase PISTACHIO_RESET_QSPI:\n\tcase PISTACHIO_RESET_MDC:\n\tcase PISTACHIO_RESET_SDHOST:\n\tcase PISTACHIO_RESET_ETHERNET:\n\tcase PISTACHIO_RESET_IR:\n\tcase PISTACHIO_RESET_HASH:\n\tcase PISTACHIO_RESET_TIMER:\n\t\treturn id;\n\tcase PISTACHIO_RESET_I2S_OUT:\n\tcase PISTACHIO_RESET_SPDIF_IN:\n\tcase PISTACHIO_RESET_EVT:\n\t\treturn id + 6;\n\tcase PISTACHIO_RESET_USB_H:\n\tcase PISTACHIO_RESET_USB_PR:\n\tcase PISTACHIO_RESET_USB_PHY_PR:\n\tcase PISTACHIO_RESET_USB_PHY_PON:\n\t\treturn id + 7;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int pistachio_reset_assert(struct reset_controller_dev *rcdev,\n\t\t\t\t  unsigned long id)\n{\n\tstruct pistachio_reset_data *rd;\n\tu32 mask;\n\tint shift;\n\n\trd = container_of(rcdev, struct pistachio_reset_data, rcdev);\n\tshift = pistachio_reset_shift(id);\n\tif (shift < 0)\n\t\treturn shift;\n\tmask = BIT(shift);\n\n\treturn regmap_update_bits(rd->periph_regs, PISTACHIO_SOFT_RESET,\n\t\t\t\t  mask, mask);\n}\n\nstatic int pistachio_reset_deassert(struct reset_controller_dev *rcdev,\n\t\t\t\t    unsigned long id)\n{\n\tstruct pistachio_reset_data *rd;\n\tu32 mask;\n\tint shift;\n\n\trd = container_of(rcdev, struct pistachio_reset_data, rcdev);\n\tshift = pistachio_reset_shift(id);\n\tif (shift < 0)\n\t\treturn shift;\n\tmask = BIT(shift);\n\n\treturn regmap_update_bits(rd->periph_regs, PISTACHIO_SOFT_RESET,\n\t\t\t\t  mask, 0);\n}\n\nstatic const struct reset_control_ops pistachio_reset_ops = {\n\t.assert\t\t= pistachio_reset_assert,\n\t.deassert\t= pistachio_reset_deassert,\n};\n\nstatic int pistachio_reset_probe(struct platform_device *pdev)\n{\n\tstruct pistachio_reset_data *rd;\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *np = pdev->dev.of_node;\n\n\trd = devm_kzalloc(dev, sizeof(*rd), GFP_KERNEL);\n\tif (!rd)\n\t\treturn -ENOMEM;\n\n\trd->periph_regs = syscon_node_to_regmap(np->parent);\n\tif (IS_ERR(rd->periph_regs))\n\t\treturn PTR_ERR(rd->periph_regs);\n\n\trd->rcdev.owner = THIS_MODULE;\n\trd->rcdev.nr_resets = PISTACHIO_RESET_MAX + 1;\n\trd->rcdev.ops = &pistachio_reset_ops;\n\trd->rcdev.of_node = np;\n\n\treturn devm_reset_controller_register(dev, &rd->rcdev);\n}\n\nstatic const struct of_device_id pistachio_reset_dt_ids[] = {\n\t { .compatible = \"img,pistachio-reset\", },\n\t {   },\n};\n\nstatic struct platform_driver pistachio_reset_driver = {\n\t.probe\t= pistachio_reset_probe,\n\t.driver = {\n\t\t.name\t\t= \"pistachio-reset\",\n\t\t.of_match_table\t= pistachio_reset_dt_ids,\n\t},\n};\nbuiltin_platform_driver(pistachio_reset_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}