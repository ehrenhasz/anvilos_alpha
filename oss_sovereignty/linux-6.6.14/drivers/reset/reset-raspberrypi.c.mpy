{
  "module_name": "reset-raspberrypi.c",
  "hash_id": "8d3e3405642d4f2027fe4bece5501c0411a1a57cc2d31538e8017764281c84b8",
  "original_prompt": "Ingested from linux-6.6.14/drivers/reset/reset-raspberrypi.c",
  "human_readable_source": "\n \n#include <linux/delay.h>\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/reset-controller.h>\n#include <soc/bcm2835/raspberrypi-firmware.h>\n#include <dt-bindings/reset/raspberrypi,firmware-reset.h>\n\nstruct rpi_reset {\n\tstruct reset_controller_dev rcdev;\n\tstruct rpi_firmware *fw;\n};\n\nstatic inline struct rpi_reset *to_rpi(struct reset_controller_dev *rcdev)\n{\n\treturn container_of(rcdev, struct rpi_reset, rcdev);\n}\n\nstatic int rpi_reset_reset(struct reset_controller_dev *rcdev, unsigned long id)\n{\n\tstruct rpi_reset *priv = to_rpi(rcdev);\n\tu32 dev_addr;\n\tint ret;\n\n\tswitch (id) {\n\tcase RASPBERRYPI_FIRMWARE_RESET_ID_USB:\n\t\t \n\t\tdev_addr = 0x100000;\n\t\tret = rpi_firmware_property(priv->fw, RPI_FIRMWARE_NOTIFY_XHCI_RESET,\n\t\t\t\t\t    &dev_addr, sizeof(dev_addr));\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\t \n\t\tusleep_range(200, 1000);\n\t\tbreak;\n\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct reset_control_ops rpi_reset_ops = {\n\t.reset\t= rpi_reset_reset,\n};\n\nstatic int rpi_reset_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct rpi_firmware *fw;\n\tstruct device_node *np;\n\tstruct rpi_reset *priv;\n\n\tnp = of_get_parent(dev->of_node);\n\tif (!np) {\n\t\tdev_err(dev, \"Missing firmware node\\n\");\n\t\treturn -ENOENT;\n\t}\n\n\tfw = devm_rpi_firmware_get(&pdev->dev, np);\n\tof_node_put(np);\n\tif (!fw)\n\t\treturn -EPROBE_DEFER;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(dev, priv);\n\n\tpriv->fw = fw;\n\tpriv->rcdev.owner = THIS_MODULE;\n\tpriv->rcdev.nr_resets = RASPBERRYPI_FIRMWARE_RESET_NUM_IDS;\n\tpriv->rcdev.ops = &rpi_reset_ops;\n\tpriv->rcdev.of_node = dev->of_node;\n\n\treturn devm_reset_controller_register(dev, &priv->rcdev);\n}\n\nstatic const struct of_device_id rpi_reset_of_match[] = {\n\t{ .compatible = \"raspberrypi,firmware-reset\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, rpi_reset_of_match);\n\nstatic struct platform_driver rpi_reset_driver = {\n\t.probe\t= rpi_reset_probe,\n\t.driver\t= {\n\t\t.name = \"raspberrypi-reset\",\n\t\t.of_match_table = rpi_reset_of_match,\n\t},\n};\nmodule_platform_driver(rpi_reset_driver);\n\nMODULE_AUTHOR(\"Nicolas Saenz Julienne <nsaenzjulienne@suse.de>\");\nMODULE_DESCRIPTION(\"Raspberry Pi 4 firmware reset driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}