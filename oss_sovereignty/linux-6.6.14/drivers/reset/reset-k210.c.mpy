{
  "module_name": "reset-k210.c",
  "hash_id": "8f75b1d298af103dbce129cef597682fcf8055b998e39ceb99c4613fdd0b870f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/reset/reset-k210.c",
  "human_readable_source": "\n \n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/reset-controller.h>\n#include <linux/delay.h>\n#include <linux/mfd/syscon.h>\n#include <linux/regmap.h>\n#include <soc/canaan/k210-sysctl.h>\n\n#include <dt-bindings/reset/k210-rst.h>\n\n#define K210_RST_MASK\t0x27FFFFFF\n\nstruct k210_rst {\n\tstruct regmap *map;\n\tstruct reset_controller_dev rcdev;\n};\n\nstatic inline struct k210_rst *\nto_k210_rst(struct reset_controller_dev *rcdev)\n{\n\treturn container_of(rcdev, struct k210_rst, rcdev);\n}\n\nstatic inline int k210_rst_assert(struct reset_controller_dev *rcdev,\n\t\t\t\t  unsigned long id)\n{\n\tstruct k210_rst *ksr = to_k210_rst(rcdev);\n\n\treturn regmap_update_bits(ksr->map, K210_SYSCTL_PERI_RESET, BIT(id), 1);\n}\n\nstatic inline int k210_rst_deassert(struct reset_controller_dev *rcdev,\n\t\t\t\t    unsigned long id)\n{\n\tstruct k210_rst *ksr = to_k210_rst(rcdev);\n\n\treturn regmap_update_bits(ksr->map, K210_SYSCTL_PERI_RESET, BIT(id), 0);\n}\n\nstatic int k210_rst_reset(struct reset_controller_dev *rcdev,\n\t\t\t  unsigned long id)\n{\n\tint ret;\n\n\tret = k210_rst_assert(rcdev, id);\n\tif (ret == 0) {\n\t\tudelay(10);\n\t\tret = k210_rst_deassert(rcdev, id);\n\t}\n\n\treturn ret;\n}\n\nstatic int k210_rst_status(struct reset_controller_dev *rcdev,\n\t\t\t   unsigned long id)\n{\n\tstruct k210_rst *ksr = to_k210_rst(rcdev);\n\tu32 reg, bit = BIT(id);\n\tint ret;\n\n\tret = regmap_read(ksr->map, K210_SYSCTL_PERI_RESET, &reg);\n\tif (ret)\n\t\treturn ret;\n\n\treturn reg & bit;\n}\n\nstatic int k210_rst_xlate(struct reset_controller_dev *rcdev,\n\t\t\t  const struct of_phandle_args *reset_spec)\n{\n\tunsigned long id = reset_spec->args[0];\n\n\tif (!(BIT(id) & K210_RST_MASK))\n\t\treturn -EINVAL;\n\n\treturn id;\n}\n\nstatic const struct reset_control_ops k210_rst_ops = {\n\t.assert\t\t= k210_rst_assert,\n\t.deassert\t= k210_rst_deassert,\n\t.reset\t\t= k210_rst_reset,\n\t.status\t\t= k210_rst_status,\n};\n\nstatic int k210_rst_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *parent_np = of_get_parent(dev->of_node);\n\tstruct k210_rst *ksr;\n\n\tdev_info(dev, \"K210 reset controller\\n\");\n\n\tksr = devm_kzalloc(dev, sizeof(*ksr), GFP_KERNEL);\n\tif (!ksr)\n\t\treturn -ENOMEM;\n\n\tksr->map = syscon_node_to_regmap(parent_np);\n\tof_node_put(parent_np);\n\tif (IS_ERR(ksr->map))\n\t\treturn PTR_ERR(ksr->map);\n\n\tksr->rcdev.owner = THIS_MODULE;\n\tksr->rcdev.dev = dev;\n\tksr->rcdev.of_node = dev->of_node;\n\tksr->rcdev.ops = &k210_rst_ops;\n\tksr->rcdev.nr_resets = fls(K210_RST_MASK);\n\tksr->rcdev.of_reset_n_cells = 1;\n\tksr->rcdev.of_xlate = k210_rst_xlate;\n\n\treturn devm_reset_controller_register(dev, &ksr->rcdev);\n}\n\nstatic const struct of_device_id k210_rst_dt_ids[] = {\n\t{ .compatible = \"canaan,k210-rst\" },\n\t{   },\n};\n\nstatic struct platform_driver k210_rst_driver = {\n\t.probe\t= k210_rst_probe,\n\t.driver = {\n\t\t.name\t\t= \"k210-rst\",\n\t\t.of_match_table\t= k210_rst_dt_ids,\n\t},\n};\nbuiltin_platform_driver(k210_rst_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}