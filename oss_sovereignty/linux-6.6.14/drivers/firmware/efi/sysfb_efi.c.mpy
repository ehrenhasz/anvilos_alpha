{
  "module_name": "sysfb_efi.c",
  "hash_id": "a8dc75835e8b8ebc416d4cf50689da917564766e52fbb1bb2eef216ed1cb1c8a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/efi/sysfb_efi.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/dmi.h>\n#include <linux/err.h>\n#include <linux/efi.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/mm.h>\n#include <linux/of_address.h>\n#include <linux/pci.h>\n#include <linux/platform_device.h>\n#include <linux/screen_info.h>\n#include <linux/sysfb.h>\n#include <video/vga.h>\n\nenum {\n\tOVERRIDE_NONE = 0x0,\n\tOVERRIDE_BASE = 0x1,\n\tOVERRIDE_STRIDE = 0x2,\n\tOVERRIDE_HEIGHT = 0x4,\n\tOVERRIDE_WIDTH = 0x8,\n};\n\nstruct efifb_dmi_info efifb_dmi_list[] = {\n\t[M_I17] = { \"i17\", 0x80010000, 1472 * 4, 1440, 900, OVERRIDE_NONE },\n\t[M_I20] = { \"i20\", 0x80010000, 1728 * 4, 1680, 1050, OVERRIDE_NONE },  \n\t[M_I20_SR] = { \"imac7\", 0x40010000, 1728 * 4, 1680, 1050, OVERRIDE_NONE },\n\t[M_I24] = { \"i24\", 0x80010000, 2048 * 4, 1920, 1200, OVERRIDE_NONE },  \n\t[M_I24_8_1] = { \"imac8\", 0xc0060000, 2048 * 4, 1920, 1200, OVERRIDE_NONE },\n\t[M_I24_10_1] = { \"imac10\", 0xc0010000, 2048 * 4, 1920, 1080, OVERRIDE_NONE },\n\t[M_I27_11_1] = { \"imac11\", 0xc0010000, 2560 * 4, 2560, 1440, OVERRIDE_NONE },\n\t[M_MINI]= { \"mini\", 0x80000000, 2048 * 4, 1024, 768, OVERRIDE_NONE },\n\t[M_MINI_3_1] = { \"mini31\", 0x40010000, 1024 * 4, 1024, 768, OVERRIDE_NONE },\n\t[M_MINI_4_1] = { \"mini41\", 0xc0010000, 2048 * 4, 1920, 1200, OVERRIDE_NONE },\n\t[M_MB] = { \"macbook\", 0x80000000, 2048 * 4, 1280, 800, OVERRIDE_NONE },\n\t[M_MB_5_1] = { \"macbook51\", 0x80010000, 2048 * 4, 1280, 800, OVERRIDE_NONE },\n\t[M_MB_6_1] = { \"macbook61\", 0x80010000, 2048 * 4, 1280, 800, OVERRIDE_NONE },\n\t[M_MB_7_1] = { \"macbook71\", 0x80010000, 2048 * 4, 1280, 800, OVERRIDE_NONE },\n\t[M_MBA] = { \"mba\", 0x80000000, 2048 * 4, 1280, 800, OVERRIDE_NONE },\n\t \n\t[M_MBA_3] = { \"mba3\", 0, 2048 * 4, 0, 0, OVERRIDE_STRIDE },\n\t[M_MBP] = { \"mbp\", 0x80010000, 1472 * 4, 1440, 900, OVERRIDE_NONE },\n\t[M_MBP_2] = { \"mbp2\", 0, 0, 0, 0, OVERRIDE_NONE },  \n\t[M_MBP_2_2] = { \"mbp22\", 0x80010000, 1472 * 4, 1440, 900, OVERRIDE_NONE },\n\t[M_MBP_SR] = { \"mbp3\", 0x80030000, 2048 * 4, 1440, 900, OVERRIDE_NONE },\n\t[M_MBP_4] = { \"mbp4\", 0xc0060000, 2048 * 4, 1920, 1200, OVERRIDE_NONE },\n\t[M_MBP_5_1] = { \"mbp51\", 0xc0010000, 2048 * 4, 1440, 900, OVERRIDE_NONE },\n\t[M_MBP_5_2] = { \"mbp52\", 0xc0010000, 2048 * 4, 1920, 1200, OVERRIDE_NONE },\n\t[M_MBP_5_3] = { \"mbp53\", 0xd0010000, 2048 * 4, 1440, 900, OVERRIDE_NONE },\n\t[M_MBP_6_1] = { \"mbp61\", 0x90030000, 2048 * 4, 1920, 1200, OVERRIDE_NONE },\n\t[M_MBP_6_2] = { \"mbp62\", 0x90030000, 2048 * 4, 1680, 1050, OVERRIDE_NONE },\n\t[M_MBP_7_1] = { \"mbp71\", 0xc0010000, 2048 * 4, 1280, 800, OVERRIDE_NONE },\n\t[M_MBP_8_2] = { \"mbp82\", 0x90010000, 1472 * 4, 1440, 900, OVERRIDE_NONE },\n\t[M_UNKNOWN] = { NULL, 0, 0, 0, 0, OVERRIDE_NONE }\n};\n\nvoid efifb_setup_from_dmi(struct screen_info *si, const char *opt)\n{\n\tint i;\n\n\tfor (i = 0; i < M_UNKNOWN; i++) {\n\t\tif (efifb_dmi_list[i].base != 0 &&\n\t\t    !strcmp(opt, efifb_dmi_list[i].optname)) {\n\t\t\tsi->lfb_base = efifb_dmi_list[i].base;\n\t\t\tsi->lfb_linelength = efifb_dmi_list[i].stride;\n\t\t\tsi->lfb_width = efifb_dmi_list[i].width;\n\t\t\tsi->lfb_height = efifb_dmi_list[i].height;\n\t\t}\n\t}\n}\n\n#define choose_value(dmivalue, fwvalue, field, flags) ({\t\\\n\t\ttypeof(fwvalue) _ret_ = fwvalue;\t\t\\\n\t\tif ((flags) & (field))\t\t\t\t\\\n\t\t\t_ret_ = dmivalue;\t\t\t\\\n\t\telse if ((fwvalue) == 0)\t\t\t\\\n\t\t\t_ret_ = dmivalue;\t\t\t\\\n\t\t_ret_;\t\t\t\t\t\t\\\n\t})\n\nstatic int __init efifb_set_system(const struct dmi_system_id *id)\n{\n\tstruct efifb_dmi_info *info = id->driver_data;\n\n\tif (info->base == 0 && info->height == 0 && info->width == 0 &&\n\t    info->stride == 0)\n\t\treturn 0;\n\n\t \n\tif (screen_info.lfb_base == 0) {\n#if defined(CONFIG_PCI)\n\t\tstruct pci_dev *dev = NULL;\n\t\tint found_bar = 0;\n#endif\n\t\tif (info->base) {\n\t\t\tscreen_info.lfb_base = choose_value(info->base,\n\t\t\t\tscreen_info.lfb_base, OVERRIDE_BASE,\n\t\t\t\tinfo->flags);\n\n#if defined(CONFIG_PCI)\n\t\t\t \n\n\t\t\tfor_each_pci_dev(dev) {\n\t\t\t\tint i;\n\t\t\t\tif ((dev->class >> 8) != PCI_CLASS_DISPLAY_VGA)\n\t\t\t\t\tcontinue;\n\t\t\t\tfor (i = 0; i < DEVICE_COUNT_RESOURCE; i++) {\n\t\t\t\t\tresource_size_t start, end;\n\t\t\t\t\tunsigned long flags;\n\n\t\t\t\t\tflags = pci_resource_flags(dev, i);\n\t\t\t\t\tif (!(flags & IORESOURCE_MEM))\n\t\t\t\t\t\tcontinue;\n\n\t\t\t\t\tif (flags & IORESOURCE_UNSET)\n\t\t\t\t\t\tcontinue;\n\n\t\t\t\t\tif (pci_resource_len(dev, i) == 0)\n\t\t\t\t\t\tcontinue;\n\n\t\t\t\t\tstart = pci_resource_start(dev, i);\n\t\t\t\t\tend = pci_resource_end(dev, i);\n\t\t\t\t\tif (screen_info.lfb_base >= start &&\n\t\t\t\t\t    screen_info.lfb_base < end) {\n\t\t\t\t\t\tfound_bar = 1;\n\t\t\t\t\t\tbreak;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (!found_bar)\n\t\t\t\tscreen_info.lfb_base = 0;\n#endif\n\t\t}\n\t}\n\tif (screen_info.lfb_base) {\n\t\tscreen_info.lfb_linelength = choose_value(info->stride,\n\t\t\tscreen_info.lfb_linelength, OVERRIDE_STRIDE,\n\t\t\tinfo->flags);\n\t\tscreen_info.lfb_width = choose_value(info->width,\n\t\t\tscreen_info.lfb_width, OVERRIDE_WIDTH,\n\t\t\tinfo->flags);\n\t\tscreen_info.lfb_height = choose_value(info->height,\n\t\t\tscreen_info.lfb_height, OVERRIDE_HEIGHT,\n\t\t\tinfo->flags);\n\t\tif (screen_info.orig_video_isVGA == 0)\n\t\t\tscreen_info.orig_video_isVGA = VIDEO_TYPE_EFI;\n\t} else {\n\t\tscreen_info.lfb_linelength = 0;\n\t\tscreen_info.lfb_width = 0;\n\t\tscreen_info.lfb_height = 0;\n\t\tscreen_info.orig_video_isVGA = 0;\n\t\treturn 0;\n\t}\n\n\tprintk(KERN_INFO \"efifb: dmi detected %s - framebuffer at 0x%08x \"\n\t\t\t \"(%dx%d, stride %d)\\n\", id->ident,\n\t\t\t screen_info.lfb_base, screen_info.lfb_width,\n\t\t\t screen_info.lfb_height, screen_info.lfb_linelength);\n\n\treturn 1;\n}\n\n#define EFIFB_DMI_SYSTEM_ID(vendor, name, enumid)\t\t\\\n\t{\t\t\t\t\t\t\t\\\n\t\tefifb_set_system,\t\t\t\t\\\n\t\tname,\t\t\t\t\t\t\\\n\t\t{\t\t\t\t\t\t\\\n\t\t\tDMI_MATCH(DMI_BIOS_VENDOR, vendor),\t\\\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, name)\t\\\n\t\t},\t\t\t\t\t\t\\\n\t\t&efifb_dmi_list[enumid]\t\t\t\t\\\n\t}\n\nstatic const struct dmi_system_id efifb_dmi_system_table[] __initconst = {\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"iMac4,1\", M_I17),\n\t \n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"iMac5,1\", M_I20),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"iMac5,1\", M_I20),\n\t \n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"iMac6,1\", M_I24),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"iMac6,1\", M_I24),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"iMac7,1\", M_I20_SR),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"iMac8,1\", M_I24_8_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"iMac10,1\", M_I24_10_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"iMac11,1\", M_I27_11_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"Macmini1,1\", M_MINI),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"Macmini3,1\", M_MINI_3_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"Macmini4,1\", M_MINI_4_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"MacBook1,1\", M_MB),\n\t \n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"MacBook2,1\", M_MB),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBook2,1\", M_MB),\n\t \n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"MacBook3,1\", M_MB),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBook3,1\", M_MB),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBook4,1\", M_MB),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBook5,1\", M_MB_5_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBook6,1\", M_MB_6_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBook7,1\", M_MB_7_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookAir1,1\", M_MBA),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookAir3,1\", M_MBA_3),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"MacBookPro1,1\", M_MBP),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"MacBookPro2,1\", M_MBP_2),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"MacBookPro2,2\", M_MBP_2_2),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookPro2,1\", M_MBP_2),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Computer, Inc.\", \"MacBookPro3,1\", M_MBP_SR),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookPro3,1\", M_MBP_SR),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookPro4,1\", M_MBP_4),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookPro5,1\", M_MBP_5_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookPro5,2\", M_MBP_5_2),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookPro5,3\", M_MBP_5_3),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookPro6,1\", M_MBP_6_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookPro6,2\", M_MBP_6_2),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookPro7,1\", M_MBP_7_1),\n\tEFIFB_DMI_SYSTEM_ID(\"Apple Inc.\", \"MacBookPro8,2\", M_MBP_8_2),\n\t{},\n};\n\n \nstatic const struct dmi_system_id efifb_dmi_swap_width_height[] __initconst = {\n\t{\n\t\t \n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"LENOVO\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_VERSION, \"MIIX 310-10ICR\"),\n\t\t\tDMI_EXACT_MATCH(DMI_BIOS_VERSION, \"1HCN44WW\"),\n\t\t},\n\t},\n\t{\n\t\t \n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"LENOVO\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_VERSION,\n\t\t\t\t\t\"Lenovo MIIX 320-10ICR\"),\n\t\t},\n\t},\n\t{\n\t\t \n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"LENOVO\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_VERSION,\n\t\t\t\t\t\"Lenovo ideapad D330-10IGM\"),\n\t\t},\n\t},\n\t{\n\t\t \n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"LENOVO\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_VERSION,\n\t\t\t\t\t\"IdeaPad Duet 3 10IGL5\"),\n\t\t},\n\t},\n\t{\n\t\t \n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"LENOVO\"),\n\t\t\t \n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Lenovo YB1-X91\"),\n\t\t},\n\t},\n\t{},\n};\n\nstatic bool efifb_overlaps_pci_range(const struct of_pci_range *range)\n{\n\tu64 fb_base = screen_info.lfb_base;\n\n\tif (screen_info.capabilities & VIDEO_CAPABILITY_64BIT_BASE)\n\t\tfb_base |= (u64)(unsigned long)screen_info.ext_lfb_base << 32;\n\n\treturn fb_base >= range->cpu_addr &&\n\t       fb_base < (range->cpu_addr + range->size);\n}\n\nstatic struct device_node *find_pci_overlap_node(void)\n{\n\tstruct device_node *np;\n\n\tfor_each_node_by_type(np, \"pci\") {\n\t\tstruct of_pci_range_parser parser;\n\t\tstruct of_pci_range range;\n\t\tint err;\n\n\t\terr = of_pci_range_parser_init(&parser, np);\n\t\tif (err) {\n\t\t\tpr_warn(\"of_pci_range_parser_init() failed: %d\\n\", err);\n\t\t\tcontinue;\n\t\t}\n\n\t\tfor_each_of_pci_range(&parser, &range)\n\t\t\tif (efifb_overlaps_pci_range(&range))\n\t\t\t\treturn np;\n\t}\n\treturn NULL;\n}\n\n \nstatic int efifb_add_links(struct fwnode_handle *fwnode)\n{\n\tstruct device_node *sup_np;\n\n\tsup_np = find_pci_overlap_node();\n\n\t \n\tif (!sup_np)\n\t\treturn 0;\n\n\tfwnode_link_add(fwnode, of_fwnode_handle(sup_np));\n\tof_node_put(sup_np);\n\n\treturn 0;\n}\n\nstatic const struct fwnode_operations efifb_fwnode_ops = {\n\t.add_links = efifb_add_links,\n};\n\n#ifdef CONFIG_EFI\nstatic struct fwnode_handle efifb_fwnode;\n\n__init void sysfb_apply_efi_quirks(void)\n{\n\tif (screen_info.orig_video_isVGA != VIDEO_TYPE_EFI ||\n\t    !(screen_info.capabilities & VIDEO_CAPABILITY_SKIP_QUIRKS))\n\t\tdmi_check_system(efifb_dmi_system_table);\n\n\tif (screen_info.orig_video_isVGA == VIDEO_TYPE_EFI &&\n\t    dmi_check_system(efifb_dmi_swap_width_height)) {\n\t\tu16 temp = screen_info.lfb_width;\n\n\t\tscreen_info.lfb_width = screen_info.lfb_height;\n\t\tscreen_info.lfb_height = temp;\n\t\tscreen_info.lfb_linelength = 4 * screen_info.lfb_width;\n\t}\n}\n\n__init void sysfb_set_efifb_fwnode(struct platform_device *pd)\n{\n\tif (screen_info.orig_video_isVGA == VIDEO_TYPE_EFI && IS_ENABLED(CONFIG_PCI)) {\n\t\tfwnode_init(&efifb_fwnode, &efifb_fwnode_ops);\n\t\tpd->dev.fwnode = &efifb_fwnode;\n\t}\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}