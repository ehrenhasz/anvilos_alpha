{
  "module_name": "memmap.c",
  "hash_id": "828235bd4262d6ad60cb279c91dd48cc27b2a1aa3445b4a30bbcdb4fb918242a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/efi/memmap.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) \"efi: \" fmt\n\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/efi.h>\n#include <linux/io.h>\n#include <linux/memblock.h>\n#include <linux/slab.h>\n\n#include <asm/early_ioremap.h>\n#include <asm/efi.h>\n\n#ifndef __efi_memmap_free\n#define __efi_memmap_free(phys, size, flags) do { } while (0)\n#endif\n\n \nint __init __efi_memmap_init(struct efi_memory_map_data *data)\n{\n\tstruct efi_memory_map map;\n\tphys_addr_t phys_map;\n\n\tphys_map = data->phys_map;\n\n\tif (data->flags & EFI_MEMMAP_LATE)\n\t\tmap.map = memremap(phys_map, data->size, MEMREMAP_WB);\n\telse\n\t\tmap.map = early_memremap(phys_map, data->size);\n\n\tif (!map.map) {\n\t\tpr_err(\"Could not map the memory map!\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tif (efi.memmap.flags & (EFI_MEMMAP_MEMBLOCK | EFI_MEMMAP_SLAB))\n\t\t__efi_memmap_free(efi.memmap.phys_map,\n\t\t\t\t  efi.memmap.desc_size * efi.memmap.nr_map,\n\t\t\t\t  efi.memmap.flags);\n\n\tmap.phys_map = data->phys_map;\n\tmap.nr_map = data->size / data->desc_size;\n\tmap.map_end = map.map + data->size;\n\n\tmap.desc_version = data->desc_version;\n\tmap.desc_size = data->desc_size;\n\tmap.flags = data->flags;\n\n\tset_bit(EFI_MEMMAP, &efi.flags);\n\n\tefi.memmap = map;\n\n\treturn 0;\n}\n\n \nint __init efi_memmap_init_early(struct efi_memory_map_data *data)\n{\n\t \n\tWARN_ON(efi.memmap.flags & EFI_MEMMAP_LATE);\n\n\tdata->flags = 0;\n\treturn __efi_memmap_init(data);\n}\n\nvoid __init efi_memmap_unmap(void)\n{\n\tif (!efi_enabled(EFI_MEMMAP))\n\t\treturn;\n\n\tif (!(efi.memmap.flags & EFI_MEMMAP_LATE)) {\n\t\tunsigned long size;\n\n\t\tsize = efi.memmap.desc_size * efi.memmap.nr_map;\n\t\tearly_memunmap(efi.memmap.map, size);\n\t} else {\n\t\tmemunmap(efi.memmap.map);\n\t}\n\n\tefi.memmap.map = NULL;\n\tclear_bit(EFI_MEMMAP, &efi.flags);\n}\n\n \nint __init efi_memmap_init_late(phys_addr_t addr, unsigned long size)\n{\n\tstruct efi_memory_map_data data = {\n\t\t.phys_map = addr,\n\t\t.size = size,\n\t\t.flags = EFI_MEMMAP_LATE,\n\t};\n\n\t \n\tWARN_ON(efi.memmap.map);\n\n\t \n\tWARN_ON(efi.memmap.flags & EFI_MEMMAP_LATE);\n\n\t \n\tdata.desc_version = efi.memmap.desc_version;\n\tdata.desc_size = efi.memmap.desc_size;\n\n\treturn __efi_memmap_init(&data);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}