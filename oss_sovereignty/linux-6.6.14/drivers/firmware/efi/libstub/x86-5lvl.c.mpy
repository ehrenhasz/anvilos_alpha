{
  "module_name": "x86-5lvl.c",
  "hash_id": "75a47b6b5a3e59f94a1c205337ba9a465d3a5ad7332f6545c2304bdf299f03ad",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/efi/libstub/x86-5lvl.c",
  "human_readable_source": "\n#include <linux/efi.h>\n\n#include <asm/boot.h>\n#include <asm/desc.h>\n#include <asm/efi.h>\n\n#include \"efistub.h\"\n#include \"x86-stub.h\"\n\nbool efi_no5lvl;\n\nstatic void (*la57_toggle)(void *cr3);\n\nstatic const struct desc_struct gdt[] = {\n\t[GDT_ENTRY_KERNEL32_CS] = GDT_ENTRY_INIT(0xc09b, 0, 0xfffff),\n\t[GDT_ENTRY_KERNEL_CS]   = GDT_ENTRY_INIT(0xa09b, 0, 0xfffff),\n};\n\n \nefi_status_t efi_setup_5level_paging(void)\n{\n\tu8 tmpl_size = (u8 *)&trampoline_ljmp_imm_offset - (u8 *)&trampoline_32bit_src;\n\tefi_status_t status;\n\tu8 *la57_code;\n\n\tif (!efi_is_64bit())\n\t\treturn EFI_SUCCESS;\n\n\t \n\tif (native_cpuid_eax(0) < 7 ||\n\t    !(native_cpuid_ecx(7) & (1 << (X86_FEATURE_LA57 & 31))))\n\t\treturn EFI_SUCCESS;\n\n\t \n\tstatus = efi_allocate_pages(2 * PAGE_SIZE, (unsigned long *)&la57_code,\n\t\t\t\t    U32_MAX);\n\tif (status != EFI_SUCCESS)\n\t\treturn status;\n\n\tla57_toggle = memcpy(la57_code, trampoline_32bit_src, tmpl_size);\n\tmemset(la57_code + tmpl_size, 0x90, PAGE_SIZE - tmpl_size);\n\n\t \n\t*(u32 *)&la57_code[trampoline_ljmp_imm_offset] += (unsigned long)la57_code;\n\n\tefi_adjust_memory_range_protection((unsigned long)la57_toggle, PAGE_SIZE);\n\n\treturn EFI_SUCCESS;\n}\n\nvoid efi_5level_switch(void)\n{\n\tbool want_la57 = IS_ENABLED(CONFIG_X86_5LEVEL) && !efi_no5lvl;\n\tbool have_la57 = native_read_cr4() & X86_CR4_LA57;\n\tbool need_toggle = want_la57 ^ have_la57;\n\tu64 *pgt = (void *)la57_toggle + PAGE_SIZE;\n\tu64 *cr3 = (u64 *)__native_read_cr3();\n\tu64 *new_cr3;\n\n\tif (!la57_toggle || !need_toggle)\n\t\treturn;\n\n\tif (!have_la57) {\n\t\t \n\t\tnew_cr3 = memset(pgt, 0, PAGE_SIZE);\n\t\tnew_cr3[0] = (u64)cr3 | _PAGE_TABLE_NOENC;\n\t} else {\n\t\t \n\t\tnew_cr3 = (u64 *)(cr3[0] & PAGE_MASK);\n\n\t\t \n\t\tif ((u64)new_cr3 > U32_MAX)\n\t\t\tnew_cr3 = memcpy(pgt, new_cr3, PAGE_SIZE);\n\t}\n\n\tnative_load_gdt(&(struct desc_ptr){ sizeof(gdt) - 1, (u64)gdt });\n\n\tla57_toggle(new_cr3);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}