{
  "module_name": "printk.c",
  "hash_id": "c02312628af73038509ecd42156d67ed3d4052978b06c70bc01a8bb784b01bfe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/efi/libstub/printk.c",
  "human_readable_source": "\n\n#include <linux/stdarg.h>\n\n#include <linux/ctype.h>\n#include <linux/efi.h>\n#include <linux/kernel.h>\n#include <linux/printk.h>  \n#include <asm/efi.h>\n#include <asm/setup.h>\n\n#include \"efistub.h\"\n\nint efi_loglevel = CONSOLE_LOGLEVEL_DEFAULT;\n\n \nvoid efi_char16_puts(efi_char16_t *str)\n{\n\tefi_call_proto(efi_table_attr(efi_system_table, con_out),\n\t\t       output_string, str);\n}\n\nstatic\nu32 utf8_to_utf32(const u8 **s8)\n{\n\tu32 c32;\n\tu8 c0, cx;\n\tsize_t clen, i;\n\n\tc0 = cx = *(*s8)++;\n\t \n\tfor (clen = 0; cx & 0x80; ++clen)\n\t\tcx <<= 1;\n\t \n\tif (clen < 2 || clen > 4)\n\t\treturn c0;\n\t \n\tc32 = cx >> clen--;\n\tfor (i = 0; i < clen; ++i) {\n\t\t \n\t\tcx = (*s8)[i] ^ 0x80;\n\t\tif (cx & 0xc0)\n\t\t\treturn c0;\n\t\tc32 = (c32 << 6) | cx;\n\t}\n\t \n\tif (c32 > 0x10ffff ||\n\t    (c32 & 0xf800) == 0xd800 ||\n\t    clen != (c32 >= 0x80) + (c32 >= 0x800) + (c32 >= 0x10000))\n\t\treturn c0;\n\t*s8 += clen;\n\treturn c32;\n}\n\n \nvoid efi_puts(const char *str)\n{\n\tefi_char16_t buf[128];\n\tsize_t pos = 0, lim = ARRAY_SIZE(buf);\n\tconst u8 *s8 = (const u8 *)str;\n\tu32 c32;\n\n\twhile (*s8) {\n\t\tif (*s8 == '\\n')\n\t\t\tbuf[pos++] = L'\\r';\n\t\tc32 = utf8_to_utf32(&s8);\n\t\tif (c32 < 0x10000) {\n\t\t\t \n\t\t\tbuf[pos++] = c32;\n\t\t} else {\n\t\t\t \n\t\t\tbuf[pos++] = (0xd800 - (0x10000 >> 10)) + (c32 >> 10);\n\t\t\tbuf[pos++] = 0xdc00 + (c32 & 0x3ff);\n\t\t}\n\t\tif (*s8 == '\\0' || pos >= lim - 2) {\n\t\t\tbuf[pos] = L'\\0';\n\t\t\tefi_char16_puts(buf);\n\t\t\tpos = 0;\n\t\t}\n\t}\n}\n\n \nint efi_printk(const char *fmt, ...)\n{\n\tchar printf_buf[256];\n\tva_list args;\n\tint printed;\n\tint loglevel = printk_get_level(fmt);\n\n\tswitch (loglevel) {\n\tcase '0' ... '9':\n\t\tloglevel -= '0';\n\t\tbreak;\n\tdefault:\n\t\t \n\t\tloglevel = -1;\n\t\tbreak;\n\t}\n\n\tif (loglevel >= efi_loglevel)\n\t\treturn 0;\n\n\tif (loglevel >= 0)\n\t\tefi_puts(\"EFI stub: \");\n\n\tfmt = printk_skip_level(fmt);\n\n\tva_start(args, fmt);\n\tprinted = vsnprintf(printf_buf, sizeof(printf_buf), fmt, args);\n\tva_end(args);\n\n\tefi_puts(printf_buf);\n\tif (printed >= sizeof(printf_buf)) {\n\t\tefi_puts(\"[Message truncated]\\n\");\n\t\treturn -1;\n\t}\n\n\treturn printed;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}