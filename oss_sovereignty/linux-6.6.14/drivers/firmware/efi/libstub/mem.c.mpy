{
  "module_name": "mem.c",
  "hash_id": "1168ace0424761f7b619739612723804e328afe236fba2b1160b445fb6fb0277",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/efi/libstub/mem.c",
  "human_readable_source": "\n\n#include <linux/efi.h>\n#include <asm/efi.h>\n\n#include \"efistub.h\"\n\n \nefi_status_t efi_get_memory_map(struct efi_boot_memmap **map,\n\t\t\t\tbool install_cfg_tbl)\n{\n\tint memtype = install_cfg_tbl ? EFI_ACPI_RECLAIM_MEMORY\n\t\t\t\t      : EFI_LOADER_DATA;\n\tefi_guid_t tbl_guid = LINUX_EFI_BOOT_MEMMAP_GUID;\n\tstruct efi_boot_memmap *m, tmp;\n\tefi_status_t status;\n\tunsigned long size;\n\n\ttmp.map_size = 0;\n\tstatus = efi_bs_call(get_memory_map, &tmp.map_size, NULL, &tmp.map_key,\n\t\t\t     &tmp.desc_size, &tmp.desc_ver);\n\tif (status != EFI_BUFFER_TOO_SMALL)\n\t\treturn EFI_LOAD_ERROR;\n\n\tsize = tmp.map_size + tmp.desc_size * EFI_MMAP_NR_SLACK_SLOTS;\n\tstatus = efi_bs_call(allocate_pool, memtype, sizeof(*m) + size,\n\t\t\t     (void **)&m);\n\tif (status != EFI_SUCCESS)\n\t\treturn status;\n\n\tif (install_cfg_tbl) {\n\t\t \n\t\tstatus = efi_bs_call(install_configuration_table, &tbl_guid, m);\n\t\tif (status != EFI_SUCCESS)\n\t\t\tgoto free_map;\n\t}\n\n\tm->buff_size = m->map_size = size;\n\tstatus = efi_bs_call(get_memory_map, &m->map_size, m->map, &m->map_key,\n\t\t\t     &m->desc_size, &m->desc_ver);\n\tif (status != EFI_SUCCESS)\n\t\tgoto uninstall_table;\n\n\t*map = m;\n\treturn EFI_SUCCESS;\n\nuninstall_table:\n\tif (install_cfg_tbl)\n\t\tefi_bs_call(install_configuration_table, &tbl_guid, NULL);\nfree_map:\n\tefi_bs_call(free_pool, m);\n\treturn status;\n}\n\n \nefi_status_t efi_allocate_pages(unsigned long size, unsigned long *addr,\n\t\t\t\tunsigned long max)\n{\n\tefi_physical_addr_t alloc_addr;\n\tefi_status_t status;\n\n\tmax = min(max, EFI_ALLOC_LIMIT);\n\n\tif (EFI_ALLOC_ALIGN > EFI_PAGE_SIZE)\n\t\treturn efi_allocate_pages_aligned(size, addr, max,\n\t\t\t\t\t\t  EFI_ALLOC_ALIGN,\n\t\t\t\t\t\t  EFI_LOADER_DATA);\n\n\talloc_addr = ALIGN_DOWN(max + 1, EFI_ALLOC_ALIGN) - 1;\n\tstatus = efi_bs_call(allocate_pages, EFI_ALLOCATE_MAX_ADDRESS,\n\t\t\t     EFI_LOADER_DATA, DIV_ROUND_UP(size, EFI_PAGE_SIZE),\n\t\t\t     &alloc_addr);\n\tif (status != EFI_SUCCESS)\n\t\treturn status;\n\n\t*addr = alloc_addr;\n\treturn EFI_SUCCESS;\n}\n\n \nvoid efi_free(unsigned long size, unsigned long addr)\n{\n\tunsigned long nr_pages;\n\n\tif (!size)\n\t\treturn;\n\n\tnr_pages = round_up(size, EFI_ALLOC_ALIGN) / EFI_PAGE_SIZE;\n\tefi_bs_call(free_pages, addr, nr_pages);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}