{
  "module_name": "relocate.c",
  "hash_id": "e924c16d2668d9d5f2d8dc66485b638ac37c2599a2e69e1041d6d3d77e612116",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/efi/libstub/relocate.c",
  "human_readable_source": "\n\n#include <linux/efi.h>\n#include <asm/efi.h>\n\n#include \"efistub.h\"\n\n \nefi_status_t efi_low_alloc_above(unsigned long size, unsigned long align,\n\t\t\t\t unsigned long *addr, unsigned long min)\n{\n\tstruct efi_boot_memmap *map;\n\tefi_status_t status;\n\tunsigned long nr_pages;\n\tint i;\n\n\tstatus = efi_get_memory_map(&map, false);\n\tif (status != EFI_SUCCESS)\n\t\tgoto fail;\n\n\t \n\tif (align < EFI_ALLOC_ALIGN)\n\t\talign = EFI_ALLOC_ALIGN;\n\n\tsize = round_up(size, EFI_ALLOC_ALIGN);\n\tnr_pages = size / EFI_PAGE_SIZE;\n\tfor (i = 0; i < map->map_size / map->desc_size; i++) {\n\t\tefi_memory_desc_t *desc;\n\t\tunsigned long m = (unsigned long)map->map;\n\t\tu64 start, end;\n\n\t\tdesc = efi_early_memdesc_ptr(m, map->desc_size, i);\n\n\t\tif (desc->type != EFI_CONVENTIONAL_MEMORY)\n\t\t\tcontinue;\n\n\t\tif (efi_soft_reserve_enabled() &&\n\t\t    (desc->attribute & EFI_MEMORY_SP))\n\t\t\tcontinue;\n\n\t\tif (desc->num_pages < nr_pages)\n\t\t\tcontinue;\n\n\t\tstart = desc->phys_addr;\n\t\tend = start + desc->num_pages * EFI_PAGE_SIZE;\n\n\t\tif (start < min)\n\t\t\tstart = min;\n\n\t\tstart = round_up(start, align);\n\t\tif ((start + size) > end)\n\t\t\tcontinue;\n\n\t\tstatus = efi_bs_call(allocate_pages, EFI_ALLOCATE_ADDRESS,\n\t\t\t\t     EFI_LOADER_DATA, nr_pages, &start);\n\t\tif (status == EFI_SUCCESS) {\n\t\t\t*addr = start;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (i == map->map_size / map->desc_size)\n\t\tstatus = EFI_NOT_FOUND;\n\n\tefi_bs_call(free_pool, map);\nfail:\n\treturn status;\n}\n\n \nefi_status_t efi_relocate_kernel(unsigned long *image_addr,\n\t\t\t\t unsigned long image_size,\n\t\t\t\t unsigned long alloc_size,\n\t\t\t\t unsigned long preferred_addr,\n\t\t\t\t unsigned long alignment,\n\t\t\t\t unsigned long min_addr)\n{\n\tunsigned long cur_image_addr;\n\tunsigned long new_addr = 0;\n\tefi_status_t status;\n\tunsigned long nr_pages;\n\tefi_physical_addr_t efi_addr = preferred_addr;\n\n\tif (!image_addr || !image_size || !alloc_size)\n\t\treturn EFI_INVALID_PARAMETER;\n\tif (alloc_size < image_size)\n\t\treturn EFI_INVALID_PARAMETER;\n\n\tcur_image_addr = *image_addr;\n\n\t \n\tnr_pages = round_up(alloc_size, EFI_ALLOC_ALIGN) / EFI_PAGE_SIZE;\n\tstatus = efi_bs_call(allocate_pages, EFI_ALLOCATE_ADDRESS,\n\t\t\t     EFI_LOADER_DATA, nr_pages, &efi_addr);\n\tnew_addr = efi_addr;\n\t \n\tif (status != EFI_SUCCESS) {\n\t\tstatus = efi_low_alloc_above(alloc_size, alignment, &new_addr,\n\t\t\t\t\t     min_addr);\n\t}\n\tif (status != EFI_SUCCESS) {\n\t\tefi_err(\"Failed to allocate usable memory for kernel.\\n\");\n\t\treturn status;\n\t}\n\n\t \n\tmemcpy((void *)new_addr, (void *)cur_image_addr, image_size);\n\n\t \n\t*image_addr = new_addr;\n\n\treturn status;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}