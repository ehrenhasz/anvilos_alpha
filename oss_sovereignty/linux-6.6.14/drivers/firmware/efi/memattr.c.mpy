{
  "module_name": "memattr.c",
  "hash_id": "2607e9cf19987447a3770bce8d6a8d7ab313c190f725b721450cbd06ca8bdd12",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/efi/memattr.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt)\t\"efi: memattr: \" fmt\n\n#include <linux/efi.h>\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/memblock.h>\n\n#include <asm/early_ioremap.h>\n\nstatic int __initdata tbl_size;\nunsigned long __ro_after_init efi_mem_attr_table = EFI_INVALID_TABLE_ADDR;\n\n \nint __init efi_memattr_init(void)\n{\n\tefi_memory_attributes_table_t *tbl;\n\n\tif (efi_mem_attr_table == EFI_INVALID_TABLE_ADDR)\n\t\treturn 0;\n\n\ttbl = early_memremap(efi_mem_attr_table, sizeof(*tbl));\n\tif (!tbl) {\n\t\tpr_err(\"Failed to map EFI Memory Attributes table @ 0x%lx\\n\",\n\t\t       efi_mem_attr_table);\n\t\treturn -ENOMEM;\n\t}\n\n\tif (tbl->version > 2) {\n\t\tpr_warn(\"Unexpected EFI Memory Attributes table version %d\\n\",\n\t\t\ttbl->version);\n\t\tgoto unmap;\n\t}\n\n\ttbl_size = sizeof(*tbl) + tbl->num_entries * tbl->desc_size;\n\tmemblock_reserve(efi_mem_attr_table, tbl_size);\n\tset_bit(EFI_MEM_ATTR, &efi.flags);\n\nunmap:\n\tearly_memunmap(tbl, sizeof(*tbl));\n\treturn 0;\n}\n\n \nstatic bool entry_is_valid(const efi_memory_desc_t *in, efi_memory_desc_t *out)\n{\n\tu64 in_paddr = in->phys_addr;\n\tu64 in_size = in->num_pages << EFI_PAGE_SHIFT;\n\tefi_memory_desc_t *md;\n\n\t*out = *in;\n\n\tif (in->type != EFI_RUNTIME_SERVICES_CODE &&\n\t    in->type != EFI_RUNTIME_SERVICES_DATA) {\n\t\tpr_warn(\"Entry type should be RuntimeServiceCode/Data\\n\");\n\t\treturn false;\n\t}\n\n\tif (PAGE_SIZE > EFI_PAGE_SIZE &&\n\t    (!PAGE_ALIGNED(in->phys_addr) ||\n\t     !PAGE_ALIGNED(in->num_pages << EFI_PAGE_SHIFT))) {\n\t\t \n\t\tpr_warn(\"Entry address region misaligned\\n\");\n\t\treturn false;\n\t}\n\n\tfor_each_efi_memory_desc(md) {\n\t\tu64 md_paddr = md->phys_addr;\n\t\tu64 md_size = md->num_pages << EFI_PAGE_SHIFT;\n\n\t\tif (!(md->attribute & EFI_MEMORY_RUNTIME))\n\t\t\tcontinue;\n\t\tif (md->virt_addr == 0 && md->phys_addr != 0) {\n\t\t\t \n\t\t\tbreak;\n\t\t}\n\n\t\tif (md_paddr > in_paddr || (in_paddr - md_paddr) >= md_size)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (md_paddr + md_size < in_paddr + in_size) {\n\t\t\tpr_warn(\"Entry covers multiple EFI memory map regions\\n\");\n\t\t\treturn false;\n\t\t}\n\n\t\tif (md->type != in->type) {\n\t\t\tpr_warn(\"Entry type deviates from EFI memory map region type\\n\");\n\t\t\treturn false;\n\t\t}\n\n\t\tout->virt_addr = in_paddr + (md->virt_addr - md_paddr);\n\n\t\treturn true;\n\t}\n\n\tpr_warn(\"No matching entry found in the EFI memory map\\n\");\n\treturn false;\n}\n\n \nint __init efi_memattr_apply_permissions(struct mm_struct *mm,\n\t\t\t\t\t efi_memattr_perm_setter fn)\n{\n\tefi_memory_attributes_table_t *tbl;\n\tbool has_bti = false;\n\tint i, ret;\n\n\tif (tbl_size <= sizeof(*tbl))\n\t\treturn 0;\n\n\t \n\tif (WARN_ON(!efi_enabled(EFI_MEMMAP)))\n\t\treturn 0;\n\n\ttbl = memremap(efi_mem_attr_table, tbl_size, MEMREMAP_WB);\n\tif (!tbl) {\n\t\tpr_err(\"Failed to map EFI Memory Attributes table @ 0x%lx\\n\",\n\t\t       efi_mem_attr_table);\n\t\treturn -ENOMEM;\n\t}\n\n\tif (tbl->version > 1 &&\n\t    (tbl->flags & EFI_MEMORY_ATTRIBUTES_FLAGS_RT_FORWARD_CONTROL_FLOW_GUARD))\n\t\thas_bti = true;\n\n\tif (efi_enabled(EFI_DBG))\n\t\tpr_info(\"Processing EFI Memory Attributes table:\\n\");\n\n\tfor (i = ret = 0; ret == 0 && i < tbl->num_entries; i++) {\n\t\tefi_memory_desc_t md;\n\t\tunsigned long size;\n\t\tbool valid;\n\t\tchar buf[64];\n\n\t\tvalid = entry_is_valid((void *)tbl->entry + i * tbl->desc_size,\n\t\t\t\t       &md);\n\t\tsize = md.num_pages << EFI_PAGE_SHIFT;\n\t\tif (efi_enabled(EFI_DBG) || !valid)\n\t\t\tpr_info(\"%s 0x%012llx-0x%012llx %s\\n\",\n\t\t\t\tvalid ? \"\" : \"!\", md.phys_addr,\n\t\t\t\tmd.phys_addr + size - 1,\n\t\t\t\tefi_md_typeattr_format(buf, sizeof(buf), &md));\n\n\t\tif (valid) {\n\t\t\tret = fn(mm, &md, has_bti);\n\t\t\tif (ret)\n\t\t\t\tpr_err(\"Error updating mappings, skipping subsequent md's\\n\");\n\t\t}\n\t}\n\tmemunmap(tbl);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}