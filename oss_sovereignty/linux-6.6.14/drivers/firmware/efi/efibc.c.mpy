{
  "module_name": "efibc.c",
  "hash_id": "0c0e04719e3c910f5811e9617c66c05e78186966d131f99d99763e9c4f8073be",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/efi/efibc.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) \"efibc: \" fmt\n\n#include <linux/efi.h>\n#include <linux/module.h>\n#include <linux/reboot.h>\n#include <linux/slab.h>\n#include <linux/ucs2_string.h>\n\n#define MAX_DATA_LEN\t512\n\nstatic int efibc_set_variable(efi_char16_t *name, efi_char16_t *value,\n\t\t\t      unsigned long len)\n{\n\tefi_status_t status;\n\n\tstatus = efi.set_variable(name, &LINUX_EFI_LOADER_ENTRY_GUID,\n\t\t\t\t  EFI_VARIABLE_NON_VOLATILE\n\t\t\t\t  | EFI_VARIABLE_BOOTSERVICE_ACCESS\n\t\t\t\t  | EFI_VARIABLE_RUNTIME_ACCESS,\n\t\t\t\t  len * sizeof(efi_char16_t), value);\n\n\tif (status != EFI_SUCCESS) {\n\t\tpr_err(\"failed to set EFI variable: 0x%lx\\n\", status);\n\t\treturn -EIO;\n\t}\n\treturn 0;\n}\n\nstatic int efibc_reboot_notifier_call(struct notifier_block *notifier,\n\t\t\t\t      unsigned long event, void *data)\n{\n\tefi_char16_t *reason = event == SYS_RESTART ? L\"reboot\"\n\t\t\t\t\t\t    : L\"shutdown\";\n\tconst u8 *str = data;\n\tefi_char16_t *wdata;\n\tunsigned long l;\n\tint ret;\n\n\tret = efibc_set_variable(L\"LoaderEntryRebootReason\", reason,\n\t\t\t\t ucs2_strlen(reason));\n\tif (ret || !data)\n\t\treturn NOTIFY_DONE;\n\n\twdata = kmalloc(MAX_DATA_LEN * sizeof(efi_char16_t), GFP_KERNEL);\n\tif (!wdata)\n\t\treturn NOTIFY_DONE;\n\n\tfor (l = 0; l < MAX_DATA_LEN - 1 && str[l] != '\\0'; l++)\n\t\twdata[l] = str[l];\n\twdata[l] = L'\\0';\n\n\tefibc_set_variable(L\"LoaderEntryOneShot\", wdata, l);\n\n\tkfree(wdata);\n\treturn NOTIFY_DONE;\n}\n\nstatic struct notifier_block efibc_reboot_notifier = {\n\t.notifier_call = efibc_reboot_notifier_call,\n};\n\nstatic int __init efibc_init(void)\n{\n\tint ret;\n\n\tif (!efi_rt_services_supported(EFI_RT_SUPPORTED_SET_VARIABLE))\n\t\treturn -ENODEV;\n\n\tret = register_reboot_notifier(&efibc_reboot_notifier);\n\tif (ret)\n\t\tpr_err(\"unable to register reboot notifier\\n\");\n\n\treturn ret;\n}\nmodule_init(efibc_init);\n\nstatic void __exit efibc_exit(void)\n{\n\tunregister_reboot_notifier(&efibc_reboot_notifier);\n}\nmodule_exit(efibc_exit);\n\nMODULE_AUTHOR(\"Jeremy Compostella <jeremy.compostella@intel.com>\");\nMODULE_AUTHOR(\"Matt Gumbel <matthew.k.gumbel@intel.com\");\nMODULE_DESCRIPTION(\"EFI Bootloader Control\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}