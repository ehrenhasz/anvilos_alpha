{
  "module_name": "rci2-table.c",
  "hash_id": "24a63fb3bd97852efb5bc33e4a4f58776147f8cd05e02b9298a4f623f776d3ef",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/efi/rci2-table.c",
  "human_readable_source": "\n \n\n#include <linux/kobject.h>\n#include <linux/device.h>\n#include <linux/sysfs.h>\n#include <linux/efi.h>\n#include <linux/types.h>\n#include <linux/io.h>\n\n#define RCI_SIGNATURE\t\"_RC_\"\n\nstruct rci2_table_global_hdr {\n\tu16 type;\n\tu16 resvd0;\n\tu16 hdr_len;\n\tu8 rci2_sig[4];\n\tu16 resvd1;\n\tu32 resvd2;\n\tu32 resvd3;\n\tu8 major_rev;\n\tu8 minor_rev;\n\tu16 num_of_structs;\n\tu32 rci2_len;\n\tu16 rci2_chksum;\n} __packed;\n\nstatic u8 *rci2_base;\nstatic u32 rci2_table_len;\nunsigned long rci2_table_phys __ro_after_init = EFI_INVALID_TABLE_ADDR;\n\nstatic ssize_t raw_table_read(struct file *file, struct kobject *kobj,\n\t\t\t      struct bin_attribute *attr, char *buf,\n\t\t\t      loff_t pos, size_t count)\n{\n\tmemcpy(buf, attr->private + pos, count);\n\treturn count;\n}\n\nstatic BIN_ATTR(rci2, S_IRUSR, raw_table_read, NULL, 0);\n\nstatic u16 checksum(void)\n{\n\tu8 len_is_odd = rci2_table_len % 2;\n\tu32 chksum_len = rci2_table_len;\n\tu16 *base = (u16 *)rci2_base;\n\tu8 buf[2] = {0};\n\tu32 offset = 0;\n\tu16 chksum = 0;\n\n\tif (len_is_odd)\n\t\tchksum_len -= 1;\n\n\twhile (offset < chksum_len) {\n\t\tchksum += *base;\n\t\toffset += 2;\n\t\tbase++;\n\t}\n\n\tif (len_is_odd) {\n\t\tbuf[0] = *(u8 *)base;\n\t\tchksum += *(u16 *)(buf);\n\t}\n\n\treturn chksum;\n}\n\nstatic int __init efi_rci2_sysfs_init(void)\n{\n\tstruct kobject *tables_kobj;\n\tint ret = -ENOMEM;\n\n\tif (rci2_table_phys == EFI_INVALID_TABLE_ADDR)\n\t\treturn 0;\n\n\trci2_base = memremap(rci2_table_phys,\n\t\t\t     sizeof(struct rci2_table_global_hdr),\n\t\t\t     MEMREMAP_WB);\n\tif (!rci2_base) {\n\t\tpr_debug(\"RCI2 table init failed - could not map RCI2 table\\n\");\n\t\tgoto err;\n\t}\n\n\tif (strncmp(rci2_base +\n\t\t    offsetof(struct rci2_table_global_hdr, rci2_sig),\n\t\t    RCI_SIGNATURE, 4)) {\n\t\tpr_debug(\"RCI2 table init failed - incorrect signature\\n\");\n\t\tret = -ENODEV;\n\t\tgoto err_unmap;\n\t}\n\n\trci2_table_len = *(u32 *)(rci2_base +\n\t\t\t\t  offsetof(struct rci2_table_global_hdr,\n\t\t\t\t  rci2_len));\n\n\tmemunmap(rci2_base);\n\n\tif (!rci2_table_len) {\n\t\tpr_debug(\"RCI2 table init failed - incorrect table length\\n\");\n\t\tgoto err;\n\t}\n\n\trci2_base = memremap(rci2_table_phys, rci2_table_len, MEMREMAP_WB);\n\tif (!rci2_base) {\n\t\tpr_debug(\"RCI2 table - could not map RCI2 table\\n\");\n\t\tgoto err;\n\t}\n\n\tif (checksum() != 0) {\n\t\tpr_debug(\"RCI2 table - incorrect checksum\\n\");\n\t\tret = -ENODEV;\n\t\tgoto err_unmap;\n\t}\n\n\ttables_kobj = kobject_create_and_add(\"tables\", efi_kobj);\n\tif (!tables_kobj) {\n\t\tpr_debug(\"RCI2 table - tables_kobj creation failed\\n\");\n\t\tgoto err_unmap;\n\t}\n\n\tbin_attr_rci2.size = rci2_table_len;\n\tbin_attr_rci2.private = rci2_base;\n\tret = sysfs_create_bin_file(tables_kobj, &bin_attr_rci2);\n\tif (ret != 0) {\n\t\tpr_debug(\"RCI2 table - rci2 sysfs bin file creation failed\\n\");\n\t\tkobject_del(tables_kobj);\n\t\tkobject_put(tables_kobj);\n\t\tgoto err_unmap;\n\t}\n\n\treturn 0;\n\n err_unmap:\n\tmemunmap(rci2_base);\n err:\n\tpr_debug(\"RCI2 table - sysfs initialization failed\\n\");\n\treturn ret;\n}\nlate_initcall(efi_rci2_sysfs_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}