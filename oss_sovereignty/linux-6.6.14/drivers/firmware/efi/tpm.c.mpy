{
  "module_name": "tpm.c",
  "hash_id": "b69f61c0c7114d3ffc03d6d62a41bc3a29f08ee658d5baad913cce1b82bfe6d7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/efi/tpm.c",
  "human_readable_source": "\n \n\n#define TPM_MEMREMAP(start, size) early_memremap(start, size)\n#define TPM_MEMUNMAP(start, size) early_memunmap(start, size)\n\n#include <asm/early_ioremap.h>\n#include <linux/efi.h>\n#include <linux/init.h>\n#include <linux/memblock.h>\n#include <linux/tpm_eventlog.h>\n\nint efi_tpm_final_log_size;\nEXPORT_SYMBOL(efi_tpm_final_log_size);\n\nstatic int __init tpm2_calc_event_log_size(void *data, int count, void *size_info)\n{\n\tstruct tcg_pcr_event2_head *header;\n\tint event_size, size = 0;\n\n\twhile (count > 0) {\n\t\theader = data + size;\n\t\tevent_size = __calc_tpm2_event_size(header, size_info, true);\n\t\tif (event_size == 0)\n\t\t\treturn -1;\n\t\tsize += event_size;\n\t\tcount--;\n\t}\n\n\treturn size;\n}\n\n \nint __init efi_tpm_eventlog_init(void)\n{\n\tstruct linux_efi_tpm_eventlog *log_tbl;\n\tstruct efi_tcg2_final_events_table *final_tbl;\n\tint tbl_size;\n\tint ret = 0;\n\n\tif (efi.tpm_log == EFI_INVALID_TABLE_ADDR) {\n\t\t \n\t\treturn 0;\n\t}\n\n\tlog_tbl = early_memremap(efi.tpm_log, sizeof(*log_tbl));\n\tif (!log_tbl) {\n\t\tpr_err(\"Failed to map TPM Event Log table @ 0x%lx\\n\",\n\t\t       efi.tpm_log);\n\t\tefi.tpm_log = EFI_INVALID_TABLE_ADDR;\n\t\treturn -ENOMEM;\n\t}\n\n\ttbl_size = sizeof(*log_tbl) + log_tbl->size;\n\tmemblock_reserve(efi.tpm_log, tbl_size);\n\n\tif (efi.tpm_final_log == EFI_INVALID_TABLE_ADDR) {\n\t\tpr_info(\"TPM Final Events table not present\\n\");\n\t\tgoto out;\n\t} else if (log_tbl->version != EFI_TCG2_EVENT_LOG_FORMAT_TCG_2) {\n\t\tpr_warn(FW_BUG \"TPM Final Events table invalid\\n\");\n\t\tgoto out;\n\t}\n\n\tfinal_tbl = early_memremap(efi.tpm_final_log, sizeof(*final_tbl));\n\n\tif (!final_tbl) {\n\t\tpr_err(\"Failed to map TPM Final Event Log table @ 0x%lx\\n\",\n\t\t       efi.tpm_final_log);\n\t\tefi.tpm_final_log = EFI_INVALID_TABLE_ADDR;\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\ttbl_size = 0;\n\tif (final_tbl->nr_events != 0) {\n\t\tvoid *events = (void *)efi.tpm_final_log\n\t\t\t\t+ sizeof(final_tbl->version)\n\t\t\t\t+ sizeof(final_tbl->nr_events);\n\n\t\ttbl_size = tpm2_calc_event_log_size(events,\n\t\t\t\t\t\t    final_tbl->nr_events,\n\t\t\t\t\t\t    log_tbl->log);\n\t}\n\n\tif (tbl_size < 0) {\n\t\tpr_err(FW_BUG \"Failed to parse event in TPM Final Events Log\\n\");\n\t\tret = -EINVAL;\n\t\tgoto out_calc;\n\t}\n\n\tmemblock_reserve(efi.tpm_final_log,\n\t\t\t tbl_size + sizeof(*final_tbl));\n\tefi_tpm_final_log_size = tbl_size;\n\nout_calc:\n\tearly_memunmap(final_tbl, sizeof(*final_tbl));\nout:\n\tearly_memunmap(log_tbl, sizeof(*log_tbl));\n\treturn ret;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}