{
  "module_name": "imx-dsp.c",
  "hash_id": "5a3353303ab7cc187fa0ff28fc0d42f10976a1d6fe70e6b12e6aef5348588dcf",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/imx/imx-dsp.c",
  "human_readable_source": "\n \n\n#include <linux/firmware/imx/dsp.h>\n#include <linux/kernel.h>\n#include <linux/mailbox_client.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\n \nint imx_dsp_ring_doorbell(struct imx_dsp_ipc *ipc, unsigned int idx)\n{\n\tint ret;\n\tstruct imx_dsp_chan *dsp_chan;\n\n\tif (idx >= DSP_MU_CHAN_NUM)\n\t\treturn -EINVAL;\n\n\tdsp_chan = &ipc->chans[idx];\n\tret = mbox_send_message(dsp_chan->ch, NULL);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\nEXPORT_SYMBOL(imx_dsp_ring_doorbell);\n\n \nstatic void imx_dsp_handle_rx(struct mbox_client *c, void *msg)\n{\n\tstruct imx_dsp_chan *chan = container_of(c, struct imx_dsp_chan, cl);\n\n\tif (chan->idx == 0) {\n\t\tchan->ipc->ops->handle_reply(chan->ipc);\n\t} else {\n\t\tchan->ipc->ops->handle_request(chan->ipc);\n\t\timx_dsp_ring_doorbell(chan->ipc, 1);\n\t}\n}\n\nstruct mbox_chan *imx_dsp_request_channel(struct imx_dsp_ipc *dsp_ipc, int idx)\n{\n\tstruct imx_dsp_chan *dsp_chan;\n\n\tif (idx >= DSP_MU_CHAN_NUM)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tdsp_chan = &dsp_ipc->chans[idx];\n\tdsp_chan->ch = mbox_request_channel_byname(&dsp_chan->cl, dsp_chan->name);\n\treturn dsp_chan->ch;\n}\nEXPORT_SYMBOL(imx_dsp_request_channel);\n\nvoid imx_dsp_free_channel(struct imx_dsp_ipc *dsp_ipc, int idx)\n{\n\tstruct imx_dsp_chan *dsp_chan;\n\n\tif (idx >= DSP_MU_CHAN_NUM)\n\t\treturn;\n\n\tdsp_chan = &dsp_ipc->chans[idx];\n\tmbox_free_channel(dsp_chan->ch);\n}\nEXPORT_SYMBOL(imx_dsp_free_channel);\n\nstatic int imx_dsp_setup_channels(struct imx_dsp_ipc *dsp_ipc)\n{\n\tstruct device *dev = dsp_ipc->dev;\n\tstruct imx_dsp_chan *dsp_chan;\n\tstruct mbox_client *cl;\n\tchar *chan_name;\n\tint ret;\n\tint i, j;\n\n\tfor (i = 0; i < DSP_MU_CHAN_NUM; i++) {\n\t\tif (i < 2)\n\t\t\tchan_name = kasprintf(GFP_KERNEL, \"txdb%d\", i);\n\t\telse\n\t\t\tchan_name = kasprintf(GFP_KERNEL, \"rxdb%d\", i - 2);\n\n\t\tif (!chan_name)\n\t\t\treturn -ENOMEM;\n\n\t\tdsp_chan = &dsp_ipc->chans[i];\n\t\tdsp_chan->name = chan_name;\n\t\tcl = &dsp_chan->cl;\n\t\tcl->dev = dev;\n\t\tcl->tx_block = false;\n\t\tcl->knows_txdone = true;\n\t\tcl->rx_callback = imx_dsp_handle_rx;\n\n\t\tdsp_chan->ipc = dsp_ipc;\n\t\tdsp_chan->idx = i % 2;\n\t\tdsp_chan->ch = mbox_request_channel_byname(cl, chan_name);\n\t\tif (IS_ERR(dsp_chan->ch)) {\n\t\t\tret = PTR_ERR(dsp_chan->ch);\n\t\t\tif (ret != -EPROBE_DEFER)\n\t\t\t\tdev_err(dev, \"Failed to request mbox chan %s ret %d\\n\",\n\t\t\t\t\tchan_name, ret);\n\t\t\tkfree(dsp_chan->name);\n\t\t\tgoto out;\n\t\t}\n\n\t\tdev_dbg(dev, \"request mbox chan %s\\n\", chan_name);\n\t}\n\n\treturn 0;\nout:\n\tfor (j = 0; j < i; j++) {\n\t\tdsp_chan = &dsp_ipc->chans[j];\n\t\tmbox_free_channel(dsp_chan->ch);\n\t\tkfree(dsp_chan->name);\n\t}\n\n\treturn ret;\n}\n\nstatic int imx_dsp_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct imx_dsp_ipc *dsp_ipc;\n\tint ret;\n\n\tdevice_set_of_node_from_dev(&pdev->dev, pdev->dev.parent);\n\n\tdsp_ipc = devm_kzalloc(dev, sizeof(*dsp_ipc), GFP_KERNEL);\n\tif (!dsp_ipc)\n\t\treturn -ENOMEM;\n\n\tdsp_ipc->dev = dev;\n\tdev_set_drvdata(dev, dsp_ipc);\n\n\tret = imx_dsp_setup_channels(dsp_ipc);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tdev_info(dev, \"NXP i.MX DSP IPC initialized\\n\");\n\n\treturn 0;\n}\n\nstatic int imx_dsp_remove(struct platform_device *pdev)\n{\n\tstruct imx_dsp_chan *dsp_chan;\n\tstruct imx_dsp_ipc *dsp_ipc;\n\tint i;\n\n\tdsp_ipc = dev_get_drvdata(&pdev->dev);\n\n\tfor (i = 0; i < DSP_MU_CHAN_NUM; i++) {\n\t\tdsp_chan = &dsp_ipc->chans[i];\n\t\tmbox_free_channel(dsp_chan->ch);\n\t\tkfree(dsp_chan->name);\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver imx_dsp_driver = {\n\t.driver = {\n\t\t.name = \"imx-dsp\",\n\t},\n\t.probe = imx_dsp_probe,\n\t.remove = imx_dsp_remove,\n};\nbuiltin_platform_driver(imx_dsp_driver);\n\nMODULE_AUTHOR(\"Daniel Baluta <daniel.baluta@nxp.com>\");\nMODULE_DESCRIPTION(\"IMX DSP IPC protocol driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}