{
  "module_name": "zynqmp-debug.c",
  "hash_id": "ad0e4d1b564be6c52328f080886cc9735b1a0313f538ae5f1737c13488d48e29",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/xilinx/zynqmp-debug.c",
  "human_readable_source": "\n \n\n#include <linux/compiler.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/debugfs.h>\n#include <linux/uaccess.h>\n\n#include <linux/firmware/xlnx-zynqmp.h>\n#include \"zynqmp-debug.h\"\n\n#define PM_API_NAME_LEN\t\t\t50\n\nstruct pm_api_info {\n\tu32 api_id;\n\tchar api_name[PM_API_NAME_LEN];\n\tchar api_name_len;\n};\n\nstatic char debugfs_buf[PAGE_SIZE];\n\n#define PM_API(id)\t\t {id, #id, strlen(#id)}\nstatic struct pm_api_info pm_api_list[] = {\n\tPM_API(PM_GET_API_VERSION),\n\tPM_API(PM_QUERY_DATA),\n};\n\nstatic struct dentry *firmware_debugfs_root;\n\n \nstatic u64 zynqmp_pm_argument_value(char *arg)\n{\n\tu64 value;\n\n\tif (!arg)\n\t\treturn 0;\n\n\tif (!kstrtou64(arg, 0, &value))\n\t\treturn value;\n\n\treturn 0;\n}\n\n \nstatic int get_pm_api_id(char *pm_api_req, u32 *pm_id)\n{\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(pm_api_list) ; i++) {\n\t\tif (!strncasecmp(pm_api_req, pm_api_list[i].api_name,\n\t\t\t\t pm_api_list[i].api_name_len)) {\n\t\t\t*pm_id = pm_api_list[i].api_id;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\tif (i == ARRAY_SIZE(pm_api_list) && kstrtouint(pm_api_req, 10, pm_id))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic int process_api_request(u32 pm_id, u64 *pm_api_arg, u32 *pm_api_ret)\n{\n\tu32 pm_api_version;\n\tint ret;\n\tstruct zynqmp_pm_query_data qdata = {0};\n\n\tswitch (pm_id) {\n\tcase PM_GET_API_VERSION:\n\t\tret = zynqmp_pm_get_api_version(&pm_api_version);\n\t\tsprintf(debugfs_buf, \"PM-API Version = %d.%d\\n\",\n\t\t\tpm_api_version >> 16, pm_api_version & 0xffff);\n\t\tbreak;\n\tcase PM_QUERY_DATA:\n\t\tqdata.qid = pm_api_arg[0];\n\t\tqdata.arg1 = pm_api_arg[1];\n\t\tqdata.arg2 = pm_api_arg[2];\n\t\tqdata.arg3 = pm_api_arg[3];\n\n\t\tret = zynqmp_pm_query_data(qdata, pm_api_ret);\n\t\tif (ret)\n\t\t\tbreak;\n\n\t\tswitch (qdata.qid) {\n\t\tcase PM_QID_CLOCK_GET_NAME:\n\t\t\tsprintf(debugfs_buf, \"Clock name = %s\\n\",\n\t\t\t\t(char *)pm_api_ret);\n\t\t\tbreak;\n\t\tcase PM_QID_CLOCK_GET_FIXEDFACTOR_PARAMS:\n\t\t\tsprintf(debugfs_buf, \"Multiplier = %d, Divider = %d\\n\",\n\t\t\t\tpm_api_ret[1], pm_api_ret[2]);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tsprintf(debugfs_buf,\n\t\t\t\t\"data[0] = 0x%08x\\ndata[1] = 0x%08x\\n data[2] = 0x%08x\\ndata[3] = 0x%08x\\n\",\n\t\t\t\tpm_api_ret[0], pm_api_ret[1],\n\t\t\t\tpm_api_ret[2], pm_api_ret[3]);\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tsprintf(debugfs_buf, \"Unsupported PM-API request\\n\");\n\t\tret = -EINVAL;\n\t}\n\n\treturn ret;\n}\n\n \nstatic ssize_t zynqmp_pm_debugfs_api_write(struct file *file,\n\t\t\t\t\t   const char __user *ptr, size_t len,\n\t\t\t\t\t   loff_t *off)\n{\n\tchar *kern_buff, *tmp_buff;\n\tchar *pm_api_req;\n\tu32 pm_id = 0;\n\tu64 pm_api_arg[4] = {0, 0, 0, 0};\n\t \n\tu32 pm_api_ret[4] = {0, 0, 0, 0};\n\n\tint ret;\n\tint i = 0;\n\n\tstrcpy(debugfs_buf, \"\");\n\n\tif (*off != 0 || len <= 1 || len > PAGE_SIZE - 1)\n\t\treturn -EINVAL;\n\n\tkern_buff = memdup_user_nul(ptr, len);\n\tif (IS_ERR(kern_buff))\n\t\treturn PTR_ERR(kern_buff);\n\ttmp_buff = kern_buff;\n\n\t \n\tpm_api_req = strsep(&kern_buff, \" \");\n\n\tret = get_pm_api_id(pm_api_req, &pm_id);\n\tif (ret < 0)\n\t\tgoto err;\n\n\t \n\tpm_api_req = strsep(&kern_buff, \" \");\n\twhile ((i < ARRAY_SIZE(pm_api_arg)) && pm_api_req) {\n\t\tpm_api_arg[i++] = zynqmp_pm_argument_value(pm_api_req);\n\t\tpm_api_req = strsep(&kern_buff, \" \");\n\t}\n\n\tret = process_api_request(pm_id, pm_api_arg, pm_api_ret);\n\nerr:\n\tkfree(tmp_buff);\n\tif (ret)\n\t\treturn ret;\n\n\treturn len;\n}\n\n \nstatic ssize_t zynqmp_pm_debugfs_api_read(struct file *file, char __user *ptr,\n\t\t\t\t\t  size_t len, loff_t *off)\n{\n\treturn simple_read_from_buffer(ptr, len, off, debugfs_buf,\n\t\t\t\t       strlen(debugfs_buf));\n}\n\n \nstatic const struct file_operations fops_zynqmp_pm_dbgfs = {\n\t.owner = THIS_MODULE,\n\t.write = zynqmp_pm_debugfs_api_write,\n\t.read = zynqmp_pm_debugfs_api_read,\n};\n\n \nvoid zynqmp_pm_api_debugfs_init(void)\n{\n\t \n\tfirmware_debugfs_root = debugfs_create_dir(\"zynqmp-firmware\", NULL);\n\tdebugfs_create_file(\"pm\", 0660, firmware_debugfs_root, NULL,\n\t\t\t    &fops_zynqmp_pm_dbgfs);\n}\n\n \nvoid zynqmp_pm_api_debugfs_exit(void)\n{\n\tdebugfs_remove_recursive(firmware_debugfs_root);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}