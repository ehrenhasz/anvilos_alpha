{
  "module_name": "sysfb_simplefb.c",
  "hash_id": "9694590a81b0a896e3e8ef20bb20c4e678ae503d3c9d18c3f2207d1e8cea33a1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/sysfb_simplefb.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/mm.h>\n#include <linux/platform_data/simplefb.h>\n#include <linux/platform_device.h>\n#include <linux/screen_info.h>\n#include <linux/sysfb.h>\n\nstatic const char simplefb_resname[] = \"BOOTFB\";\nstatic const struct simplefb_format formats[] = SIMPLEFB_FORMATS;\n\n \n__init bool sysfb_parse_mode(const struct screen_info *si,\n\t\t\t     struct simplefb_platform_data *mode)\n{\n\t__u8 type;\n\tu32 bits_per_pixel;\n\tunsigned int i;\n\n\ttype = si->orig_video_isVGA;\n\tif (type != VIDEO_TYPE_VLFB && type != VIDEO_TYPE_EFI)\n\t\treturn false;\n\n\t \n\tif (si->lfb_depth > 8) {\n\t\tbits_per_pixel = max(max3(si->red_size + si->red_pos,\n\t\t\t\t\t  si->green_size + si->green_pos,\n\t\t\t\t\t  si->blue_size + si->blue_pos),\n\t\t\t\t     si->rsvd_size + si->rsvd_pos);\n\t\tbits_per_pixel = max_t(u32, bits_per_pixel, si->lfb_depth);\n\t} else {\n\t\tbits_per_pixel = si->lfb_depth;\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(formats); ++i) {\n\t\tconst struct simplefb_format *f = &formats[i];\n\n\t\tif (f->transp.length)\n\t\t\tcontinue;  \n\n\t\tif (bits_per_pixel == f->bits_per_pixel &&\n\t\t    si->red_size == f->red.length &&\n\t\t    si->red_pos == f->red.offset &&\n\t\t    si->green_size == f->green.length &&\n\t\t    si->green_pos == f->green.offset &&\n\t\t    si->blue_size == f->blue.length &&\n\t\t    si->blue_pos == f->blue.offset) {\n\t\t\tmode->format = f->name;\n\t\t\tmode->width = si->lfb_width;\n\t\t\tmode->height = si->lfb_height;\n\t\t\tmode->stride = si->lfb_linelength;\n\t\t\treturn true;\n\t\t}\n\t}\n\n\treturn false;\n}\n\n__init struct platform_device *sysfb_create_simplefb(const struct screen_info *si,\n\t\t\t\t\t\t     const struct simplefb_platform_data *mode)\n{\n\tstruct platform_device *pd;\n\tstruct resource res;\n\tu64 base, size;\n\tu32 length;\n\tint ret;\n\n\t \n\tbase = si->lfb_base;\n\tif (si->capabilities & VIDEO_CAPABILITY_64BIT_BASE)\n\t\tbase |= (u64)si->ext_lfb_base << 32;\n\tif (!base || (u64)(resource_size_t)base != base) {\n\t\tprintk(KERN_DEBUG \"sysfb: inaccessible VRAM base\\n\");\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\n\t \n\tsize = si->lfb_size;\n\tif (si->orig_video_isVGA == VIDEO_TYPE_VLFB)\n\t\tsize <<= 16;\n\tlength = mode->height * mode->stride;\n\tif (length > size) {\n\t\tprintk(KERN_WARNING \"sysfb: VRAM smaller than advertised\\n\");\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n\tlength = PAGE_ALIGN(length);\n\n\t \n\tmemset(&res, 0, sizeof(res));\n\tres.flags = IORESOURCE_MEM;\n\tres.name = simplefb_resname;\n\tres.start = base;\n\tres.end = res.start + length - 1;\n\tif (res.end <= res.start)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tpd = platform_device_alloc(\"simple-framebuffer\", 0);\n\tif (!pd)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tsysfb_set_efifb_fwnode(pd);\n\n\tret = platform_device_add_resources(pd, &res, 1);\n\tif (ret)\n\t\tgoto err_put_device;\n\n\tret = platform_device_add_data(pd, mode, sizeof(*mode));\n\tif (ret)\n\t\tgoto err_put_device;\n\n\tret = platform_device_add(pd);\n\tif (ret)\n\t\tgoto err_put_device;\n\n\treturn pd;\n\nerr_put_device:\n\tplatform_device_put(pd);\n\n\treturn ERR_PTR(ret);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}