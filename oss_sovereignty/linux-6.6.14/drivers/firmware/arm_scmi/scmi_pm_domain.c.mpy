{
  "module_name": "scmi_pm_domain.c",
  "hash_id": "a223fccb36834e252133ebf15ee98dea3ed13acd54bdc9805401000f6f298dba",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/arm_scmi/scmi_pm_domain.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/pm_domain.h>\n#include <linux/scmi_protocol.h>\n\nstatic const struct scmi_power_proto_ops *power_ops;\n\nstruct scmi_pm_domain {\n\tstruct generic_pm_domain genpd;\n\tconst struct scmi_protocol_handle *ph;\n\tconst char *name;\n\tu32 domain;\n};\n\n#define to_scmi_pd(gpd) container_of(gpd, struct scmi_pm_domain, genpd)\n\nstatic int scmi_pd_power(struct generic_pm_domain *domain, bool power_on)\n{\n\tint ret;\n\tu32 state, ret_state;\n\tstruct scmi_pm_domain *pd = to_scmi_pd(domain);\n\n\tif (power_on)\n\t\tstate = SCMI_POWER_STATE_GENERIC_ON;\n\telse\n\t\tstate = SCMI_POWER_STATE_GENERIC_OFF;\n\n\tret = power_ops->state_set(pd->ph, pd->domain, state);\n\tif (!ret)\n\t\tret = power_ops->state_get(pd->ph, pd->domain, &ret_state);\n\tif (!ret && state != ret_state)\n\t\treturn -EIO;\n\n\treturn ret;\n}\n\nstatic int scmi_pd_power_on(struct generic_pm_domain *domain)\n{\n\treturn scmi_pd_power(domain, true);\n}\n\nstatic int scmi_pd_power_off(struct generic_pm_domain *domain)\n{\n\treturn scmi_pd_power(domain, false);\n}\n\nstatic int scmi_pm_domain_probe(struct scmi_device *sdev)\n{\n\tint num_domains, i;\n\tstruct device *dev = &sdev->dev;\n\tstruct device_node *np = dev->of_node;\n\tstruct scmi_pm_domain *scmi_pd;\n\tstruct genpd_onecell_data *scmi_pd_data;\n\tstruct generic_pm_domain **domains;\n\tconst struct scmi_handle *handle = sdev->handle;\n\tstruct scmi_protocol_handle *ph;\n\n\tif (!handle)\n\t\treturn -ENODEV;\n\n\tpower_ops = handle->devm_protocol_get(sdev, SCMI_PROTOCOL_POWER, &ph);\n\tif (IS_ERR(power_ops))\n\t\treturn PTR_ERR(power_ops);\n\n\tnum_domains = power_ops->num_domains_get(ph);\n\tif (num_domains < 0) {\n\t\tdev_err(dev, \"number of domains not found\\n\");\n\t\treturn num_domains;\n\t}\n\n\tscmi_pd = devm_kcalloc(dev, num_domains, sizeof(*scmi_pd), GFP_KERNEL);\n\tif (!scmi_pd)\n\t\treturn -ENOMEM;\n\n\tscmi_pd_data = devm_kzalloc(dev, sizeof(*scmi_pd_data), GFP_KERNEL);\n\tif (!scmi_pd_data)\n\t\treturn -ENOMEM;\n\n\tdomains = devm_kcalloc(dev, num_domains, sizeof(*domains), GFP_KERNEL);\n\tif (!domains)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < num_domains; i++, scmi_pd++) {\n\t\tu32 state;\n\n\t\tif (power_ops->state_get(ph, i, &state)) {\n\t\t\tdev_warn(dev, \"failed to get state for domain %d\\n\", i);\n\t\t\tcontinue;\n\t\t}\n\n\t\tscmi_pd->domain = i;\n\t\tscmi_pd->ph = ph;\n\t\tscmi_pd->name = power_ops->name_get(ph, i);\n\t\tscmi_pd->genpd.name = scmi_pd->name;\n\t\tscmi_pd->genpd.power_off = scmi_pd_power_off;\n\t\tscmi_pd->genpd.power_on = scmi_pd_power_on;\n\n\t\tpm_genpd_init(&scmi_pd->genpd, NULL,\n\t\t\t      state == SCMI_POWER_STATE_GENERIC_OFF);\n\n\t\tdomains[i] = &scmi_pd->genpd;\n\t}\n\n\tscmi_pd_data->domains = domains;\n\tscmi_pd_data->num_domains = num_domains;\n\n\tdev_set_drvdata(dev, scmi_pd_data);\n\n\treturn of_genpd_add_provider_onecell(np, scmi_pd_data);\n}\n\nstatic void scmi_pm_domain_remove(struct scmi_device *sdev)\n{\n\tint i;\n\tstruct genpd_onecell_data *scmi_pd_data;\n\tstruct device *dev = &sdev->dev;\n\tstruct device_node *np = dev->of_node;\n\n\tof_genpd_del_provider(np);\n\n\tscmi_pd_data = dev_get_drvdata(dev);\n\tfor (i = 0; i < scmi_pd_data->num_domains; i++) {\n\t\tif (!scmi_pd_data->domains[i])\n\t\t\tcontinue;\n\t\tpm_genpd_remove(scmi_pd_data->domains[i]);\n\t}\n}\n\nstatic const struct scmi_device_id scmi_id_table[] = {\n\t{ SCMI_PROTOCOL_POWER, \"genpd\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(scmi, scmi_id_table);\n\nstatic struct scmi_driver scmi_power_domain_driver = {\n\t.name = \"scmi-power-domain\",\n\t.probe = scmi_pm_domain_probe,\n\t.remove = scmi_pm_domain_remove,\n\t.id_table = scmi_id_table,\n};\nmodule_scmi_driver(scmi_power_domain_driver);\n\nMODULE_AUTHOR(\"Sudeep Holla <sudeep.holla@arm.com>\");\nMODULE_DESCRIPTION(\"ARM SCMI power domain driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}