{
  "module_name": "tee_bnxt_fw.c",
  "hash_id": "2344704bfba089875890a213261f66592288e71164f6062a099ef58274929e83",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/broadcom/tee_bnxt_fw.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/sizes.h>\n#include <linux/slab.h>\n#include <linux/tee_drv.h>\n#include <linux/uuid.h>\n\n#include <linux/firmware/broadcom/tee_bnxt_fw.h>\n\n#define MAX_SHM_MEM_SZ\tSZ_4M\n\n#define MAX_TEE_PARAM_ARRY_MEMB\t\t4\n\nenum ta_cmd {\n\t \n\tTA_CMD_BNXT_FASTBOOT = 0,\n\n\t \n\tTA_CMD_BNXT_COPY_COREDUMP = 3,\n};\n\n \nstruct tee_bnxt_fw_private {\n\tstruct device *dev;\n\tstruct tee_context *ctx;\n\tu32 session_id;\n\tstruct tee_shm *fw_shm_pool;\n};\n\nstatic struct tee_bnxt_fw_private pvt_data;\n\nstatic void prepare_args(int cmd,\n\t\t\t struct tee_ioctl_invoke_arg *arg,\n\t\t\t struct tee_param *param)\n{\n\tmemset(arg, 0, sizeof(*arg));\n\tmemset(param, 0, MAX_TEE_PARAM_ARRY_MEMB * sizeof(*param));\n\n\targ->func = cmd;\n\targ->session = pvt_data.session_id;\n\targ->num_params = MAX_TEE_PARAM_ARRY_MEMB;\n\n\t \n\tswitch (cmd) {\n\tcase TA_CMD_BNXT_COPY_COREDUMP:\n\t\tparam[0].attr = TEE_IOCTL_PARAM_ATTR_TYPE_MEMREF_INOUT;\n\t\tparam[0].u.memref.shm = pvt_data.fw_shm_pool;\n\t\tparam[0].u.memref.size = MAX_SHM_MEM_SZ;\n\t\tparam[0].u.memref.shm_offs = 0;\n\t\tparam[1].attr = TEE_IOCTL_PARAM_ATTR_TYPE_VALUE_INPUT;\n\t\tbreak;\n\tcase TA_CMD_BNXT_FASTBOOT:\n\tdefault:\n\t\t \n\t\tbreak;\n\t}\n}\n\n \nint tee_bnxt_fw_load(void)\n{\n\tint ret = 0;\n\tstruct tee_ioctl_invoke_arg arg;\n\tstruct tee_param param[MAX_TEE_PARAM_ARRY_MEMB];\n\n\tif (!pvt_data.ctx)\n\t\treturn -ENODEV;\n\n\tprepare_args(TA_CMD_BNXT_FASTBOOT, &arg, param);\n\n\tret = tee_client_invoke_func(pvt_data.ctx, &arg, param);\n\tif (ret < 0 || arg.ret != 0) {\n\t\tdev_err(pvt_data.dev,\n\t\t\t\"TA_CMD_BNXT_FASTBOOT invoke failed TEE err: %x, ret:%x\\n\",\n\t\t\targ.ret, ret);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL(tee_bnxt_fw_load);\n\n \nint tee_bnxt_copy_coredump(void *buf, u32 offset, u32 size)\n{\n\tstruct tee_ioctl_invoke_arg arg;\n\tstruct tee_param param[MAX_TEE_PARAM_ARRY_MEMB];\n\tvoid *core_data;\n\tu32 rbytes = size;\n\tu32 nbytes = 0;\n\tint ret = 0;\n\n\tif (!pvt_data.ctx)\n\t\treturn -ENODEV;\n\n\tprepare_args(TA_CMD_BNXT_COPY_COREDUMP, &arg, param);\n\n\twhile (rbytes)  {\n\t\tnbytes = rbytes;\n\n\t\tnbytes = min_t(u32, rbytes, param[0].u.memref.size);\n\n\t\t \n\t\tparam[1].u.value.a = offset;\n\t\tparam[1].u.value.b = nbytes;\n\n\t\tret = tee_client_invoke_func(pvt_data.ctx, &arg, param);\n\t\tif (ret < 0 || arg.ret != 0) {\n\t\t\tdev_err(pvt_data.dev,\n\t\t\t\t\"TA_CMD_BNXT_COPY_COREDUMP invoke failed TEE err: %x, ret:%x\\n\",\n\t\t\t\targ.ret, ret);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tcore_data = tee_shm_get_va(pvt_data.fw_shm_pool, 0);\n\t\tif (IS_ERR(core_data)) {\n\t\t\tdev_err(pvt_data.dev, \"tee_shm_get_va failed\\n\");\n\t\t\treturn PTR_ERR(core_data);\n\t\t}\n\n\t\tmemcpy(buf, core_data, nbytes);\n\n\t\trbytes -= nbytes;\n\t\tbuf += nbytes;\n\t\toffset += nbytes;\n\t}\n\n\treturn 0;\n}\nEXPORT_SYMBOL(tee_bnxt_copy_coredump);\n\nstatic int optee_ctx_match(struct tee_ioctl_version_data *ver, const void *data)\n{\n\treturn (ver->impl_id == TEE_IMPL_ID_OPTEE);\n}\n\nstatic int tee_bnxt_fw_probe(struct device *dev)\n{\n\tstruct tee_client_device *bnxt_device = to_tee_client_device(dev);\n\tint ret, err = -ENODEV;\n\tstruct tee_ioctl_open_session_arg sess_arg;\n\tstruct tee_shm *fw_shm_pool;\n\n\tmemset(&sess_arg, 0, sizeof(sess_arg));\n\n\t \n\tpvt_data.ctx = tee_client_open_context(NULL, optee_ctx_match, NULL,\n\t\t\t\t\t       NULL);\n\tif (IS_ERR(pvt_data.ctx))\n\t\treturn -ENODEV;\n\n\t \n\texport_uuid(sess_arg.uuid, &bnxt_device->id.uuid);\n\tsess_arg.clnt_login = TEE_IOCTL_LOGIN_PUBLIC;\n\tsess_arg.num_params = 0;\n\n\tret = tee_client_open_session(pvt_data.ctx, &sess_arg, NULL);\n\tif (ret < 0 || sess_arg.ret != 0) {\n\t\tdev_err(dev, \"tee_client_open_session failed, err: %x\\n\",\n\t\t\tsess_arg.ret);\n\t\terr = -EINVAL;\n\t\tgoto out_ctx;\n\t}\n\tpvt_data.session_id = sess_arg.session;\n\n\tpvt_data.dev = dev;\n\n\tfw_shm_pool = tee_shm_alloc_kernel_buf(pvt_data.ctx, MAX_SHM_MEM_SZ);\n\tif (IS_ERR(fw_shm_pool)) {\n\t\tdev_err(pvt_data.dev, \"tee_shm_alloc_kernel_buf failed\\n\");\n\t\terr = PTR_ERR(fw_shm_pool);\n\t\tgoto out_sess;\n\t}\n\n\tpvt_data.fw_shm_pool = fw_shm_pool;\n\n\treturn 0;\n\nout_sess:\n\ttee_client_close_session(pvt_data.ctx, pvt_data.session_id);\nout_ctx:\n\ttee_client_close_context(pvt_data.ctx);\n\n\treturn err;\n}\n\nstatic int tee_bnxt_fw_remove(struct device *dev)\n{\n\ttee_shm_free(pvt_data.fw_shm_pool);\n\ttee_client_close_session(pvt_data.ctx, pvt_data.session_id);\n\ttee_client_close_context(pvt_data.ctx);\n\tpvt_data.ctx = NULL;\n\n\treturn 0;\n}\n\nstatic void tee_bnxt_fw_shutdown(struct device *dev)\n{\n\ttee_shm_free(pvt_data.fw_shm_pool);\n\ttee_client_close_session(pvt_data.ctx, pvt_data.session_id);\n\ttee_client_close_context(pvt_data.ctx);\n\tpvt_data.ctx = NULL;\n}\n\nstatic const struct tee_client_device_id tee_bnxt_fw_id_table[] = {\n\t{UUID_INIT(0x6272636D, 0x2019, 0x0716,\n\t\t    0x42, 0x43, 0x4D, 0x5F, 0x53, 0x43, 0x48, 0x49)},\n\t{}\n};\n\nMODULE_DEVICE_TABLE(tee, tee_bnxt_fw_id_table);\n\nstatic struct tee_client_driver tee_bnxt_fw_driver = {\n\t.id_table\t= tee_bnxt_fw_id_table,\n\t.driver\t\t= {\n\t\t.name\t\t= KBUILD_MODNAME,\n\t\t.bus\t\t= &tee_bus_type,\n\t\t.probe\t\t= tee_bnxt_fw_probe,\n\t\t.remove\t\t= tee_bnxt_fw_remove,\n\t\t.shutdown\t= tee_bnxt_fw_shutdown,\n\t},\n};\n\nstatic int __init tee_bnxt_fw_mod_init(void)\n{\n\treturn driver_register(&tee_bnxt_fw_driver.driver);\n}\n\nstatic void __exit tee_bnxt_fw_mod_exit(void)\n{\n\tdriver_unregister(&tee_bnxt_fw_driver.driver);\n}\n\nmodule_init(tee_bnxt_fw_mod_init);\nmodule_exit(tee_bnxt_fw_mod_exit);\n\nMODULE_AUTHOR(\"Vikas Gupta <vikas.gupta@broadcom.com>\");\nMODULE_DESCRIPTION(\"Broadcom bnxt firmware manager\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}