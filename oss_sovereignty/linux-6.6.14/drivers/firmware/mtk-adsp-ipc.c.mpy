{
  "module_name": "mtk-adsp-ipc.c",
  "hash_id": "4bce21cb89dba39166cd6e78293d62677e086b06a46b9b355b06fc1e02b4ea7e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/mtk-adsp-ipc.c",
  "human_readable_source": "\n \n\n#include <linux/firmware/mediatek/mtk-adsp-ipc.h>\n#include <linux/kernel.h>\n#include <linux/mailbox_client.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\nstatic const char * const adsp_mbox_ch_names[MTK_ADSP_MBOX_NUM] = { \"rx\", \"tx\" };\n\n \nint mtk_adsp_ipc_send(struct mtk_adsp_ipc *ipc, unsigned int idx, uint32_t msg)\n{\n\tstruct mtk_adsp_chan *adsp_chan;\n\tint ret;\n\n\tif (idx >= MTK_ADSP_MBOX_NUM)\n\t\treturn -EINVAL;\n\n\tadsp_chan = &ipc->chans[idx];\n\tret = mbox_send_message(adsp_chan->ch, &msg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(mtk_adsp_ipc_send);\n\n \nstatic void mtk_adsp_ipc_recv(struct mbox_client *c, void *msg)\n{\n\tstruct mtk_adsp_chan *chan = container_of(c, struct mtk_adsp_chan, cl);\n\tstruct device *dev = c->dev;\n\n\tswitch (chan->idx) {\n\tcase MTK_ADSP_MBOX_REPLY:\n\t\tchan->ipc->ops->handle_reply(chan->ipc);\n\t\tbreak;\n\tcase MTK_ADSP_MBOX_REQUEST:\n\t\tchan->ipc->ops->handle_request(chan->ipc);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(dev, \"wrong mbox chan %d\\n\", chan->idx);\n\t\tbreak;\n\t}\n}\n\nstatic int mtk_adsp_ipc_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct mtk_adsp_ipc *adsp_ipc;\n\tstruct mtk_adsp_chan *adsp_chan;\n\tstruct mbox_client *cl;\n\tint ret;\n\tint i, j;\n\n\tdevice_set_of_node_from_dev(&pdev->dev, pdev->dev.parent);\n\n\tadsp_ipc = devm_kzalloc(dev, sizeof(*adsp_ipc), GFP_KERNEL);\n\tif (!adsp_ipc)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < MTK_ADSP_MBOX_NUM; i++) {\n\t\tadsp_chan = &adsp_ipc->chans[i];\n\t\tcl = &adsp_chan->cl;\n\t\tcl->dev = dev->parent;\n\t\tcl->tx_block = false;\n\t\tcl->knows_txdone = false;\n\t\tcl->tx_prepare = NULL;\n\t\tcl->rx_callback = mtk_adsp_ipc_recv;\n\n\t\tadsp_chan->ipc = adsp_ipc;\n\t\tadsp_chan->idx = i;\n\t\tadsp_chan->ch = mbox_request_channel_byname(cl, adsp_mbox_ch_names[i]);\n\t\tif (IS_ERR(adsp_chan->ch)) {\n\t\t\tret = PTR_ERR(adsp_chan->ch);\n\t\t\tif (ret != -EPROBE_DEFER)\n\t\t\t\tdev_err(dev, \"Failed to request mbox chan %s ret %d\\n\",\n\t\t\t\t\tadsp_mbox_ch_names[i], ret);\n\n\t\t\tfor (j = 0; j < i; j++) {\n\t\t\t\tadsp_chan = &adsp_ipc->chans[j];\n\t\t\t\tmbox_free_channel(adsp_chan->ch);\n\t\t\t}\n\n\t\t\treturn ret;\n\t\t}\n\t}\n\n\tadsp_ipc->dev = dev;\n\tdev_set_drvdata(dev, adsp_ipc);\n\tdev_dbg(dev, \"MTK ADSP IPC initialized\\n\");\n\n\treturn 0;\n}\n\nstatic int mtk_adsp_ipc_remove(struct platform_device *pdev)\n{\n\tstruct mtk_adsp_ipc *adsp_ipc = dev_get_drvdata(&pdev->dev);\n\tstruct mtk_adsp_chan *adsp_chan;\n\tint i;\n\n\tfor (i = 0; i < MTK_ADSP_MBOX_NUM; i++) {\n\t\tadsp_chan = &adsp_ipc->chans[i];\n\t\tmbox_free_channel(adsp_chan->ch);\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver mtk_adsp_ipc_driver = {\n\t.driver = {\n\t\t.name = \"mtk-adsp-ipc\",\n\t},\n\t.probe = mtk_adsp_ipc_probe,\n\t.remove = mtk_adsp_ipc_remove,\n};\nbuiltin_platform_driver(mtk_adsp_ipc_driver);\n\nMODULE_AUTHOR(\"Allen-KH Cheng <allen-kh.cheng@mediatek.com>\");\nMODULE_DESCRIPTION(\"MTK ADSP IPC Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}