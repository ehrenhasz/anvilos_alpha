{
  "module_name": "pcdp.c",
  "hash_id": "22220b4e7743b21508c0e7f7d9cabb0a17e076a4c1366de04000e16b9519b0af",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/pcdp.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/console.h>\n#include <linux/efi.h>\n#include <linux/serial.h>\n#include <linux/serial_core.h>\n#include <asm/vga.h>\n#include \"pcdp.h\"\n\nstatic int __init\nsetup_serial_console(struct pcdp_uart *uart)\n{\n#ifdef CONFIG_SERIAL_8250_CONSOLE\n\tint mmio;\n\tstatic char options[64], *p = options;\n\tchar parity;\n\n\tmmio = (uart->addr.space_id == ACPI_ADR_SPACE_SYSTEM_MEMORY);\n\tp += sprintf(p, \"uart8250,%s,0x%llx\",\n\t\tmmio ? \"mmio\" : \"io\", uart->addr.address);\n\tif (uart->baud) {\n\t\tp += sprintf(p, \",%llu\", uart->baud);\n\t\tif (uart->bits) {\n\t\t\tswitch (uart->parity) {\n\t\t\t    case 0x2: parity = 'e'; break;\n\t\t\t    case 0x3: parity = 'o'; break;\n\t\t\t    default:  parity = 'n';\n\t\t\t}\n\t\t\tp += sprintf(p, \"%c%d\", parity, uart->bits);\n\t\t}\n\t}\n\n\tadd_preferred_console(\"uart\", 8250, &options[9]);\n\treturn setup_earlycon(options);\n#else\n\treturn -ENODEV;\n#endif\n}\n\nstatic int __init\nsetup_vga_console(struct pcdp_device *dev)\n{\n#if defined(CONFIG_VT) && defined(CONFIG_VGA_CONSOLE)\n\tu8 *if_ptr;\n\n\tif_ptr = ((u8 *)dev + sizeof(struct pcdp_device));\n\tif (if_ptr[0] == PCDP_IF_PCI) {\n\t\tstruct pcdp_if_pci if_pci;\n\n\t\t \n\n\t\tmemcpy(&if_pci, if_ptr, sizeof(if_pci));\n\n\t\tif (if_pci.trans & PCDP_PCI_TRANS_IOPORT)\n\t\t\tvga_console_iobase = if_pci.ioport_tra;\n\n\t\tif (if_pci.trans & PCDP_PCI_TRANS_MMIO)\n\t\t\tvga_console_membase = if_pci.mmio_tra;\n\t}\n\n\tif (efi_mem_type(vga_console_membase + 0xA0000) == EFI_CONVENTIONAL_MEMORY) {\n\t\tprintk(KERN_ERR \"PCDP: VGA selected, but frame buffer is not MMIO!\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tconswitchp = &vga_con;\n\tprintk(KERN_INFO \"PCDP: VGA console\\n\");\n\treturn 0;\n#else\n\treturn -ENODEV;\n#endif\n}\n\nextern unsigned long hcdp_phys;\n\nint __init\nefi_setup_pcdp_console(char *cmdline)\n{\n\tstruct pcdp *pcdp;\n\tstruct pcdp_uart *uart;\n\tstruct pcdp_device *dev, *end;\n\tint i, serial = 0;\n\tint rc = -ENODEV;\n\n\tif (hcdp_phys == EFI_INVALID_TABLE_ADDR)\n\t\treturn -ENODEV;\n\n\tpcdp = early_memremap(hcdp_phys, 4096);\n\tprintk(KERN_INFO \"PCDP: v%d at 0x%lx\\n\", pcdp->rev, hcdp_phys);\n\n\tif (strstr(cmdline, \"console=hcdp\")) {\n\t\tif (pcdp->rev < 3)\n\t\t\tserial = 1;\n\t} else if (strstr(cmdline, \"console=\")) {\n\t\tprintk(KERN_INFO \"Explicit \\\"console=\\\"; ignoring PCDP\\n\");\n\t\tgoto out;\n\t}\n\n\tif (pcdp->rev < 3 && efi_uart_console_only())\n\t\tserial = 1;\n\n\tfor (i = 0, uart = pcdp->uart; i < pcdp->num_uarts; i++, uart++) {\n\t\tif (uart->flags & PCDP_UART_PRIMARY_CONSOLE || serial) {\n\t\t\tif (uart->type == PCDP_CONSOLE_UART) {\n\t\t\t\trc = setup_serial_console(uart);\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t}\n\t}\n\n\tend = (struct pcdp_device *) ((u8 *) pcdp + pcdp->length);\n\tfor (dev = (struct pcdp_device *) (pcdp->uart + pcdp->num_uarts);\n\t     dev < end;\n\t     dev = (struct pcdp_device *) ((u8 *) dev + dev->length)) {\n\t\tif (dev->flags & PCDP_PRIMARY_CONSOLE) {\n\t\t\tif (dev->type == PCDP_CONSOLE_VGA) {\n\t\t\t\trc = setup_vga_console(dev);\n\t\t\t\tgoto out;\n\t\t\t}\n\t\t}\n\t}\n\nout:\n\tearly_memunmap(pcdp, 4096);\n\treturn rc;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}