{
  "module_name": "memconsole-coreboot.c",
  "hash_id": "44acdc9ddfb46aeb3fd10fbb0901a8be9616e0312f1adb73399381516f937773",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/google/memconsole-coreboot.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n\n#include \"memconsole.h\"\n#include \"coreboot_table.h\"\n\n#define CB_TAG_CBMEM_CONSOLE\t0x17\n\n \nstruct cbmem_cons {\n\tu32 size_dont_access_after_boot;\n\tu32 cursor;\n\tu8  body[];\n} __packed;\n\n#define CURSOR_MASK ((1 << 28) - 1)\n#define OVERFLOW (1 << 31)\n\nstatic struct cbmem_cons *cbmem_console;\nstatic u32 cbmem_console_size;\n\n \nstatic ssize_t memconsole_coreboot_read(char *buf, loff_t pos, size_t count)\n{\n\tu32 cursor = cbmem_console->cursor & CURSOR_MASK;\n\tu32 flags = cbmem_console->cursor & ~CURSOR_MASK;\n\tu32 size = cbmem_console_size;\n\tstruct seg {\t \n\t\tu32 phys;\t \n\t\tu32 len;\t \n\t} seg[2] = { {0}, {0} };\n\tsize_t done = 0;\n\tint i;\n\n\tif (flags & OVERFLOW) {\n\t\tif (cursor > size)\t \n\t\t\tcursor = 0;\n\t\tseg[0] = (struct seg){.phys = cursor, .len = size - cursor};\n\t\tseg[1] = (struct seg){.phys = 0, .len = cursor};\n\t} else {\n\t\tseg[0] = (struct seg){.phys = 0, .len = min(cursor, size)};\n\t}\n\n\tfor (i = 0; i < ARRAY_SIZE(seg) && count > done; i++) {\n\t\tdone += memory_read_from_buffer(buf + done, count - done, &pos,\n\t\t\tcbmem_console->body + seg[i].phys, seg[i].len);\n\t\tpos -= seg[i].len;\n\t}\n\treturn done;\n}\n\nstatic int memconsole_probe(struct coreboot_device *dev)\n{\n\tstruct cbmem_cons *tmp_cbmc;\n\n\ttmp_cbmc = memremap(dev->cbmem_ref.cbmem_addr,\n\t\t\t    sizeof(*tmp_cbmc), MEMREMAP_WB);\n\n\tif (!tmp_cbmc)\n\t\treturn -ENOMEM;\n\n\t \n\tcbmem_console_size = tmp_cbmc->size_dont_access_after_boot;\n\tcbmem_console = devm_memremap(&dev->dev, dev->cbmem_ref.cbmem_addr,\n\t\t\t\t cbmem_console_size + sizeof(*cbmem_console),\n\t\t\t\t MEMREMAP_WB);\n\tmemunmap(tmp_cbmc);\n\n\tif (IS_ERR(cbmem_console))\n\t\treturn PTR_ERR(cbmem_console);\n\n\tmemconsole_setup(memconsole_coreboot_read);\n\n\treturn memconsole_sysfs_init();\n}\n\nstatic void memconsole_remove(struct coreboot_device *dev)\n{\n\tmemconsole_exit();\n}\n\nstatic struct coreboot_driver memconsole_driver = {\n\t.probe = memconsole_probe,\n\t.remove = memconsole_remove,\n\t.drv = {\n\t\t.name = \"memconsole\",\n\t},\n\t.tag = CB_TAG_CBMEM_CONSOLE,\n};\nmodule_coreboot_driver(memconsole_driver);\n\nMODULE_AUTHOR(\"Google, Inc.\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}