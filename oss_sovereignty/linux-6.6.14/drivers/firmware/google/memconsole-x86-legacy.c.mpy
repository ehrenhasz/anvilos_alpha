{
  "module_name": "memconsole-x86-legacy.c",
  "hash_id": "f526b06699b54756bce5f8f081204f580efd53e0352da7b1892f9fd356d4a110",
  "original_prompt": "Ingested from linux-6.6.14/drivers/firmware/google/memconsole-x86-legacy.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/dmi.h>\n#include <linux/mm.h>\n#include <asm/bios_ebda.h>\n#include <linux/acpi.h>\n\n#include \"memconsole.h\"\n\n#define BIOS_MEMCONSOLE_V1_MAGIC\t0xDEADBABE\n#define BIOS_MEMCONSOLE_V2_MAGIC\t(('M')|('C'<<8)|('O'<<16)|('N'<<24))\n\nstruct biosmemcon_ebda {\n\tu32 signature;\n\tunion {\n\t\tstruct {\n\t\t\tu8  enabled;\n\t\t\tu32 buffer_addr;\n\t\t\tu16 start;\n\t\t\tu16 end;\n\t\t\tu16 num_chars;\n\t\t\tu8  wrapped;\n\t\t} __packed v1;\n\t\tstruct {\n\t\t\tu32 buffer_addr;\n\t\t\t \n\t\t\tu16 num_bytes;\n\t\t\tu16 start;\n\t\t\tu16 end;\n\t\t} __packed v2;\n\t};\n} __packed;\n\nstatic char *memconsole_baseaddr;\nstatic size_t memconsole_length;\n\nstatic ssize_t memconsole_read(char *buf, loff_t pos, size_t count)\n{\n\treturn memory_read_from_buffer(buf, count, &pos, memconsole_baseaddr,\n\t\t\t\t       memconsole_length);\n}\n\nstatic void found_v1_header(struct biosmemcon_ebda *hdr)\n{\n\tpr_info(\"memconsole: BIOS console v1 EBDA structure found at %p\\n\",\n\t\thdr);\n\tpr_info(\"memconsole: BIOS console buffer at 0x%.8x, start = %d, end = %d, num = %d\\n\",\n\t\thdr->v1.buffer_addr, hdr->v1.start,\n\t\thdr->v1.end, hdr->v1.num_chars);\n\n\tmemconsole_baseaddr = phys_to_virt(hdr->v1.buffer_addr);\n\tmemconsole_length = hdr->v1.num_chars;\n\tmemconsole_setup(memconsole_read);\n}\n\nstatic void found_v2_header(struct biosmemcon_ebda *hdr)\n{\n\tpr_info(\"memconsole: BIOS console v2 EBDA structure found at %p\\n\",\n\t\thdr);\n\tpr_info(\"memconsole: BIOS console buffer at 0x%.8x, start = %d, end = %d, num_bytes = %d\\n\",\n\t\thdr->v2.buffer_addr, hdr->v2.start,\n\t\thdr->v2.end, hdr->v2.num_bytes);\n\n\tmemconsole_baseaddr = phys_to_virt(hdr->v2.buffer_addr + hdr->v2.start);\n\tmemconsole_length = hdr->v2.end - hdr->v2.start;\n\tmemconsole_setup(memconsole_read);\n}\n\n \nstatic bool memconsole_ebda_init(void)\n{\n\tunsigned int address;\n\tsize_t length, cur;\n\n\taddress = get_bios_ebda();\n\tif (!address) {\n\t\tpr_info(\"memconsole: BIOS EBDA non-existent.\\n\");\n\t\treturn false;\n\t}\n\n\t \n\tlength = *(u8 *)phys_to_virt(address);\n\tlength <<= 10;  \n\n\t \n\tfor (cur = 0; cur < length; cur++) {\n\t\tstruct biosmemcon_ebda *hdr = phys_to_virt(address + cur);\n\n\t\t \n\t\tif (hdr->signature == BIOS_MEMCONSOLE_V1_MAGIC) {\n\t\t\tfound_v1_header(hdr);\n\t\t\treturn true;\n\t\t}\n\n\t\t \n\t\tif (hdr->signature == BIOS_MEMCONSOLE_V2_MAGIC) {\n\t\t\tfound_v2_header(hdr);\n\t\t\treturn true;\n\t\t}\n\t}\n\n\tpr_info(\"memconsole: BIOS console EBDA structure not found!\\n\");\n\treturn false;\n}\n\nstatic const struct dmi_system_id memconsole_dmi_table[] __initconst = {\n\t{\n\t\t.ident = \"Google Board\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"Google, Inc.\"),\n\t\t},\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(dmi, memconsole_dmi_table);\n\nstatic bool __init memconsole_find(void)\n{\n\tif (!dmi_check_system(memconsole_dmi_table))\n\t\treturn false;\n\n\treturn memconsole_ebda_init();\n}\n\nstatic int __init memconsole_x86_init(void)\n{\n\tif (!memconsole_find())\n\t\treturn -ENODEV;\n\n\treturn memconsole_sysfs_init();\n}\n\nstatic void __exit memconsole_x86_exit(void)\n{\n\tmemconsole_exit();\n}\n\nmodule_init(memconsole_x86_init);\nmodule_exit(memconsole_x86_exit);\n\nMODULE_AUTHOR(\"Google, Inc.\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}