{
  "module_name": "phy-hi3670-usb3.c",
  "hash_id": "1f55c65255f27bd057826acb939a7f91a9c8dd5fa1d478696fced6127b4abdcc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/hisilicon/phy-hi3670-usb3.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/clk.h>\n#include <linux/kernel.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define SCTRL_SCDEEPSLEEPED\t\t(0x0)\n#define USB_CLK_SELECTED\t\tBIT(20)\n\n#define PERI_CRG_PEREN0\t\t\t(0x00)\n#define PERI_CRG_PERDIS0\t\t(0x04)\n#define PERI_CRG_PEREN4\t\t\t(0x40)\n#define PERI_CRG_PERDIS4\t\t(0x44)\n#define PERI_CRG_PERRSTEN4\t\t(0x90)\n#define PERI_CRG_PERRSTDIS4\t\t(0x94)\n#define PERI_CRG_ISODIS\t\t\t(0x148)\n#define PERI_CRG_PEREN6\t\t\t(0x410)\n#define PERI_CRG_PERDIS6\t\t(0x414)\n\n#define USB_REFCLK_ISO_EN\t\tBIT(25)\n\n#define GT_CLK_USB2PHY_REF\t\tBIT(19)\n\n#define PCTRL_PERI_CTRL3\t\t(0x10)\n#define PCTRL_PERI_CTRL3_MSK_START\t(16)\n#define USB_TCXO_EN\t\t\tBIT(1)\n\n#define PCTRL_PERI_CTRL24\t\t(0x64)\n#define SC_CLK_USB3PHY_3MUX1_SEL\tBIT(25)\n\n#define USB3OTG_CTRL0\t\t\t(0x00)\n#define USB3OTG_CTRL3\t\t\t(0x0c)\n#define USB3OTG_CTRL4\t\t\t(0x10)\n#define USB3OTG_CTRL5\t\t\t(0x14)\n#define USB3OTG_CTRL7\t\t\t(0x1c)\n#define USB_MISC_CFG50\t\t\t(0x50)\n#define USB_MISC_CFG54\t\t\t(0x54)\n#define USB_MISC_CFG58\t\t\t(0x58)\n#define USB_MISC_CFG5C\t\t\t(0x5c)\n#define USB_MISC_CFGA0\t\t\t(0xa0)\n#define TCA_CLK_RST\t\t\t(0x200)\n#define TCA_INTR_EN\t\t\t(0x204)\n#define TCA_INTR_STS\t\t\t(0x208)\n#define TCA_GCFG\t\t\t(0x210)\n#define TCA_TCPC\t\t\t(0x214)\n#define TCA_SYSMODE_CFG\t\t\t(0x218)\n#define TCA_VBUS_CTRL\t\t\t(0x240)\n\n#define CTRL0_USB3_VBUSVLD\t\tBIT(7)\n#define CTRL0_USB3_VBUSVLD_SEL\t\tBIT(6)\n\n#define CTRL3_USB2_VBUSVLDEXT0\t\tBIT(6)\n#define CTRL3_USB2_VBUSVLDEXTSEL0\tBIT(5)\n\n#define CTRL5_USB2_SIDDQ\t\tBIT(0)\n\n#define CTRL7_USB2_REFCLKSEL_MASK\tGENMASK(4, 3)\n#define CTRL7_USB2_REFCLKSEL_ABB\t(BIT(4) | BIT(3))\n#define CTRL7_USB2_REFCLKSEL_PAD\tBIT(4)\n\n#define CFG50_USB3_PHY_TEST_POWERDOWN\tBIT(23)\n\n#define CFG54_USB31PHY_CR_ADDR_MASK\tGENMASK(31, 16)\n\n#define CFG54_USB3PHY_REF_USE_PAD\tBIT(12)\n#define CFG54_PHY0_PMA_PWR_STABLE\tBIT(11)\n#define CFG54_PHY0_PCS_PWR_STABLE\tBIT(9)\n#define CFG54_USB31PHY_CR_ACK\t\tBIT(7)\n#define CFG54_USB31PHY_CR_WR_EN\t\tBIT(5)\n#define CFG54_USB31PHY_CR_SEL\t\tBIT(4)\n#define CFG54_USB31PHY_CR_RD_EN\t\tBIT(3)\n#define CFG54_USB31PHY_CR_CLK\t\tBIT(2)\n#define CFG54_USB3_PHY0_ANA_PWR_EN\tBIT(1)\n\n#define CFG58_USB31PHY_CR_DATA_MASK     GENMASK(31, 16)\n\n#define CFG5C_USB3_PHY0_SS_MPLLA_SSC_EN\tBIT(1)\n\n#define CFGA0_VAUX_RESET\t\tBIT(9)\n#define CFGA0_USB31C_RESET\t\tBIT(8)\n#define CFGA0_USB2PHY_REFCLK_SELECT\tBIT(4)\n#define CFGA0_USB3PHY_RESET\t\tBIT(1)\n#define CFGA0_USB2PHY_POR\t\tBIT(0)\n\n#define INTR_EN_XA_TIMEOUT_EVT_EN\tBIT(1)\n#define INTR_EN_XA_ACK_EVT_EN\t\tBIT(0)\n\n#define CLK_RST_TCA_REF_CLK_EN\t\tBIT(1)\n#define CLK_RST_SUSPEND_CLK_EN\t\tBIT(0)\n\n#define GCFG_ROLE_HSTDEV\t\tBIT(4)\n#define GCFG_OP_MODE\t\t\tGENMASK(1, 0)\n#define GCFG_OP_MODE_CTRL_SYNC_MODE\tBIT(0)\n\n#define TCPC_VALID\t\t\tBIT(4)\n#define TCPC_LOW_POWER_EN\t\tBIT(3)\n#define TCPC_MUX_CONTROL_MASK\t\tGENMASK(1, 0)\n#define TCPC_MUX_CONTROL_USB31\t\tBIT(0)\n\n#define SYSMODE_CFG_TYPEC_DISABLE\tBIT(3)\n\n#define VBUS_CTRL_POWERPRESENT_OVERRD\tGENMASK(3, 2)\n#define VBUS_CTRL_VBUSVALID_OVERRD\tGENMASK(1, 0)\n\n#define KIRIN970_USB_DEFAULT_PHY_PARAM\t(0xfdfee4)\n#define KIRIN970_USB_DEFAULT_PHY_VBOOST\t(0x5)\n\n#define TX_VBOOST_LVL_REG\t\t(0xf)\n#define TX_VBOOST_LVL_START\t\t(6)\n#define TX_VBOOST_LVL_ENABLE\t\tBIT(9)\n\nstruct hi3670_priv {\n\tstruct device *dev;\n\tstruct regmap *peri_crg;\n\tstruct regmap *pctrl;\n\tstruct regmap *sctrl;\n\tstruct regmap *usb31misc;\n\n\tu32 eye_diagram_param;\n\tu32 tx_vboost_lvl;\n\n\tu32 peri_crg_offset;\n\tu32 pctrl_offset;\n\tu32 usb31misc_offset;\n};\n\nstatic int hi3670_phy_cr_clk(struct regmap *usb31misc)\n{\n\tint ret;\n\n\t \n\tret = regmap_update_bits(usb31misc, USB_MISC_CFG54,\n\t\t\t\t CFG54_USB31PHY_CR_CLK, CFG54_USB31PHY_CR_CLK);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\treturn regmap_update_bits(usb31misc, USB_MISC_CFG54,\n\t\t\t\t  CFG54_USB31PHY_CR_CLK, 0);\n}\n\nstatic int hi3670_phy_cr_set_sel(struct regmap *usb31misc)\n{\n\treturn regmap_update_bits(usb31misc, USB_MISC_CFG54,\n\t\t\t\t  CFG54_USB31PHY_CR_SEL, CFG54_USB31PHY_CR_SEL);\n}\n\nstatic int hi3670_phy_cr_start(struct regmap *usb31misc, int direction)\n{\n\tint ret, reg;\n\n\tif (direction)\n\t\treg = CFG54_USB31PHY_CR_WR_EN;\n\telse\n\t\treg = CFG54_USB31PHY_CR_RD_EN;\n\n\tret = regmap_update_bits(usb31misc, USB_MISC_CFG54, reg, reg);\n\n\tif (ret)\n\t\treturn ret;\n\n\tret = hi3670_phy_cr_clk(usb31misc);\n\tif (ret)\n\t\treturn ret;\n\n\treturn regmap_update_bits(usb31misc, USB_MISC_CFG54,\n\t\t\t\t  CFG54_USB31PHY_CR_RD_EN | CFG54_USB31PHY_CR_WR_EN, 0);\n}\n\nstatic int hi3670_phy_cr_wait_ack(struct regmap *usb31misc)\n{\n\tu32 reg;\n\tint retry = 10;\n\tint ret;\n\n\twhile (retry-- > 0) {\n\t\tret = regmap_read(usb31misc, USB_MISC_CFG54, &reg);\n\t\tif (ret)\n\t\t\treturn ret;\n\t\tif ((reg & CFG54_USB31PHY_CR_ACK) == CFG54_USB31PHY_CR_ACK)\n\t\t\treturn 0;\n\n\t\tret = hi3670_phy_cr_clk(usb31misc);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tusleep_range(10, 20);\n\t}\n\n\treturn -ETIMEDOUT;\n}\n\nstatic int hi3670_phy_cr_set_addr(struct regmap *usb31misc, u32 addr)\n{\n\tu32 reg;\n\tint ret;\n\n\tret = regmap_read(usb31misc, USB_MISC_CFG54, &reg);\n\tif (ret)\n\t\treturn ret;\n\n\treg = FIELD_PREP(CFG54_USB31PHY_CR_ADDR_MASK, addr);\n\n\treturn regmap_update_bits(usb31misc, USB_MISC_CFG54,\n\t\t\t\t  CFG54_USB31PHY_CR_ADDR_MASK, reg);\n}\n\nstatic int hi3670_phy_cr_read(struct regmap *usb31misc, u32 addr, u32 *val)\n{\n\tint reg, i, ret;\n\n\tfor (i = 0; i < 100; i++) {\n\t\tret = hi3670_phy_cr_clk(usb31misc);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = hi3670_phy_cr_set_sel(usb31misc);\n\tif (ret)\n\t\treturn ret;\n\n\tret = hi3670_phy_cr_set_addr(usb31misc, addr);\n\tif (ret)\n\t\treturn ret;\n\n\tret = hi3670_phy_cr_start(usb31misc, 0);\n\tif (ret)\n\t\treturn ret;\n\n\tret = hi3670_phy_cr_wait_ack(usb31misc);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_read(usb31misc, USB_MISC_CFG58, &reg);\n\tif (ret)\n\t\treturn ret;\n\n\t*val = FIELD_GET(CFG58_USB31PHY_CR_DATA_MASK, reg);\n\n\treturn 0;\n}\n\nstatic int hi3670_phy_cr_write(struct regmap *usb31misc, u32 addr, u32 val)\n{\n\tint i;\n\tint ret;\n\n\tfor (i = 0; i < 100; i++) {\n\t\tret = hi3670_phy_cr_clk(usb31misc);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tret = hi3670_phy_cr_set_sel(usb31misc);\n\tif (ret)\n\t\treturn ret;\n\n\tret = hi3670_phy_cr_set_addr(usb31misc, addr);\n\tif (ret)\n\t\treturn ret;\n\n\tret = regmap_write(usb31misc, USB_MISC_CFG58,\n\t\t\t   FIELD_PREP(CFG58_USB31PHY_CR_DATA_MASK, val));\n\tif (ret)\n\t\treturn ret;\n\n\tret = hi3670_phy_cr_start(usb31misc, 1);\n\tif (ret)\n\t\treturn ret;\n\n\treturn hi3670_phy_cr_wait_ack(usb31misc);\n}\n\nstatic int hi3670_phy_set_params(struct hi3670_priv *priv)\n{\n\tu32 reg;\n\tint ret;\n\tint retry = 3;\n\n\tret = regmap_write(priv->usb31misc, USB3OTG_CTRL4,\n\t\t\t   priv->eye_diagram_param);\n\tif (ret) {\n\t\tdev_err(priv->dev, \"set USB3OTG_CTRL4 failed\\n\");\n\t\treturn ret;\n\t}\n\n\twhile (retry-- > 0) {\n\t\tret = hi3670_phy_cr_read(priv->usb31misc,\n\t\t\t\t\t TX_VBOOST_LVL_REG, &reg);\n\t\tif (!ret)\n\t\t\tbreak;\n\n\t\tif (ret != -ETIMEDOUT) {\n\t\t\tdev_err(priv->dev, \"read TX_VBOOST_LVL_REG failed\\n\");\n\t\t\treturn ret;\n\t\t}\n\t}\n\tif (ret)\n\t\treturn ret;\n\n\treg |= (TX_VBOOST_LVL_ENABLE | (priv->tx_vboost_lvl << TX_VBOOST_LVL_START));\n\tret = hi3670_phy_cr_write(priv->usb31misc, TX_VBOOST_LVL_REG, reg);\n\tif (ret)\n\t\tdev_err(priv->dev, \"write TX_VBOOST_LVL_REG failed\\n\");\n\n\treturn ret;\n}\n\nstatic bool hi3670_is_abbclk_selected(struct hi3670_priv *priv)\n{\n\tu32 reg;\n\n\tif (!priv->sctrl) {\n\t\tdev_err(priv->dev, \"priv->sctrl is null!\\n\");\n\t\treturn false;\n\t}\n\n\tif (regmap_read(priv->sctrl, SCTRL_SCDEEPSLEEPED, &reg)) {\n\t\tdev_err(priv->dev, \"SCTRL_SCDEEPSLEEPED read failed!\\n\");\n\t\treturn false;\n\t}\n\n\tif ((reg & USB_CLK_SELECTED) == 0)\n\t\treturn false;\n\n\treturn true;\n}\n\nstatic int hi3670_config_phy_clock(struct hi3670_priv *priv)\n{\n\tu32 val, mask;\n\tint ret;\n\n\tif (!hi3670_is_abbclk_selected(priv)) {\n\t\t \n\t\tret = regmap_write(priv->peri_crg, PERI_CRG_ISODIS,\n\t\t\t\t   USB_REFCLK_ISO_EN);\n\t\tif (ret)\n\t\t\tgoto out;\n\n\t\t \n\t\tret = regmap_write(priv->pctrl, PCTRL_PERI_CTRL3,\n\t\t\t\t   USB_TCXO_EN |\n\t\t\t\t   (USB_TCXO_EN << PCTRL_PERI_CTRL3_MSK_START));\n\n\t\t \n\t\tmask = SC_CLK_USB3PHY_3MUX1_SEL;\n\t\tret = regmap_update_bits(priv->pctrl,\n\t\t\t\t\t PCTRL_PERI_CTRL24, mask, 0);\n\t\tif (ret)\n\t\t\tgoto out;\n\n\t\tret = regmap_update_bits(priv->usb31misc, USB_MISC_CFGA0,\n\t\t\t\t\t CFGA0_USB2PHY_REFCLK_SELECT, 0);\n\t\tif (ret)\n\t\t\tgoto out;\n\n\t\tret = regmap_read(priv->usb31misc, USB3OTG_CTRL7, &val);\n\t\tif (ret)\n\t\t\tgoto out;\n\t\tval &= ~CTRL7_USB2_REFCLKSEL_MASK;\n\t\tval |= CTRL7_USB2_REFCLKSEL_ABB;\n\t\tret = regmap_write(priv->usb31misc, USB3OTG_CTRL7, val);\n\t\tif (ret)\n\t\t\tgoto out;\n\n\t\treturn 0;\n\t}\n\n\tret = regmap_update_bits(priv->usb31misc, USB_MISC_CFG54,\n\t\t\t\t CFG54_USB3PHY_REF_USE_PAD,\n\t\t\t\t CFG54_USB3PHY_REF_USE_PAD);\n\tif (ret)\n\t\tgoto out;\n\n\tret = regmap_update_bits(priv->usb31misc, USB_MISC_CFGA0,\n\t\t\t\t CFGA0_USB2PHY_REFCLK_SELECT,\n\t\t\t\t CFGA0_USB2PHY_REFCLK_SELECT);\n\tif (ret)\n\t\tgoto out;\n\n\tret = regmap_read(priv->usb31misc, USB3OTG_CTRL7, &val);\n\tif (ret)\n\t\tgoto out;\n\tval &= ~CTRL7_USB2_REFCLKSEL_MASK;\n\tval |= CTRL7_USB2_REFCLKSEL_PAD;\n\tret = regmap_write(priv->usb31misc, USB3OTG_CTRL7, val);\n\tif (ret)\n\t\tgoto out;\n\n\tret = regmap_write(priv->peri_crg,\n\t\t\t   PERI_CRG_PEREN6, GT_CLK_USB2PHY_REF);\n\tif (ret)\n\t\tgoto out;\n\n\treturn 0;\nout:\n\tdev_err(priv->dev, \"failed to config phy clock ret: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic int hi3670_config_tca(struct hi3670_priv *priv)\n{\n\tu32 val, mask;\n\tint ret;\n\n\tret = regmap_write(priv->usb31misc, TCA_INTR_STS, 0xffff);\n\tif (ret)\n\t\tgoto out;\n\n\tret = regmap_write(priv->usb31misc, TCA_INTR_EN,\n\t\t\t   INTR_EN_XA_TIMEOUT_EVT_EN | INTR_EN_XA_ACK_EVT_EN);\n\tif (ret)\n\t\tgoto out;\n\n\tmask = CLK_RST_TCA_REF_CLK_EN | CLK_RST_SUSPEND_CLK_EN;\n\tret = regmap_update_bits(priv->usb31misc, TCA_CLK_RST, mask, 0);\n\tif (ret)\n\t\tgoto out;\n\n\tret = regmap_update_bits(priv->usb31misc, TCA_GCFG,\n\t\t\t\t GCFG_ROLE_HSTDEV | GCFG_OP_MODE,\n\t\t\t\t GCFG_ROLE_HSTDEV | GCFG_OP_MODE_CTRL_SYNC_MODE);\n\tif (ret)\n\t\tgoto out;\n\n\tret = regmap_update_bits(priv->usb31misc, TCA_SYSMODE_CFG,\n\t\t\t\t SYSMODE_CFG_TYPEC_DISABLE, 0);\n\tif (ret)\n\t\tgoto out;\n\n\tret = regmap_read(priv->usb31misc, TCA_TCPC, &val);\n\tif (ret)\n\t\tgoto out;\n\tval &= ~(TCPC_VALID | TCPC_LOW_POWER_EN | TCPC_MUX_CONTROL_MASK);\n\tval |= (TCPC_VALID | TCPC_MUX_CONTROL_USB31);\n\tret = regmap_write(priv->usb31misc, TCA_TCPC, val);\n\tif (ret)\n\t\tgoto out;\n\n\tret = regmap_write(priv->usb31misc, TCA_VBUS_CTRL,\n\t\t\t   VBUS_CTRL_POWERPRESENT_OVERRD | VBUS_CTRL_VBUSVALID_OVERRD);\n\tif (ret)\n\t\tgoto out;\n\n\treturn 0;\nout:\n\tdev_err(priv->dev, \"failed to config phy clock ret: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic int hi3670_phy_init(struct phy *phy)\n{\n\tstruct hi3670_priv *priv = phy_get_drvdata(phy);\n\tu32 val;\n\tint ret;\n\n\t \n\tval = CFGA0_VAUX_RESET | CFGA0_USB31C_RESET |\n\t      CFGA0_USB3PHY_RESET | CFGA0_USB2PHY_POR;\n\tret = regmap_update_bits(priv->usb31misc, USB_MISC_CFGA0, val, 0);\n\tif (ret)\n\t\tgoto out;\n\n\tret = hi3670_config_phy_clock(priv);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = regmap_update_bits(priv->usb31misc, USB3OTG_CTRL5,\n\t\t\t\t CTRL5_USB2_SIDDQ, 0);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = regmap_update_bits(priv->usb31misc, USB_MISC_CFG50,\n\t\t\t\t CFG50_USB3_PHY_TEST_POWERDOWN, 0);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tval = CFGA0_USB3PHY_RESET | CFGA0_USB2PHY_POR;\n\tret = regmap_update_bits(priv->usb31misc, USB_MISC_CFGA0, val, val);\n\tif (ret)\n\t\tgoto out;\n\n\tusleep_range(100, 120);\n\n\t \n\tval = CFG54_USB3_PHY0_ANA_PWR_EN | CFG54_PHY0_PCS_PWR_STABLE |\n\t      CFG54_PHY0_PMA_PWR_STABLE;\n\tret = regmap_update_bits(priv->usb31misc, USB_MISC_CFG54,\n\t\t\t\t val, val);\n\tif (ret)\n\t\tgoto out;\n\n\tret = hi3670_config_tca(priv);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = regmap_update_bits(priv->usb31misc, USB_MISC_CFG5C,\n\t\t\t\t CFG5C_USB3_PHY0_SS_MPLLA_SSC_EN,\n\t\t\t\t CFG5C_USB3_PHY0_SS_MPLLA_SSC_EN);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tval = CFGA0_VAUX_RESET | CFGA0_USB31C_RESET;\n\tret = regmap_update_bits(priv->usb31misc, USB_MISC_CFGA0, val, val);\n\tif (ret)\n\t\tgoto out;\n\n\tusleep_range(100, 120);\n\n\t \n\tval = CTRL0_USB3_VBUSVLD | CTRL0_USB3_VBUSVLD_SEL;\n\tret = regmap_update_bits(priv->usb31misc, USB3OTG_CTRL0, val, val);\n\tif (ret)\n\t\tgoto out;\n\n\tval = CTRL3_USB2_VBUSVLDEXT0 | CTRL3_USB2_VBUSVLDEXTSEL0;\n\tret = regmap_update_bits(priv->usb31misc, USB3OTG_CTRL3, val, val);\n\tif (ret)\n\t\tgoto out;\n\n\tusleep_range(100, 120);\n\n\tret = hi3670_phy_set_params(priv);\n\tif (ret)\n\t\tgoto out;\n\n\treturn 0;\nout:\n\tdev_err(priv->dev, \"failed to init phy ret: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic int hi3670_phy_exit(struct phy *phy)\n{\n\tstruct hi3670_priv *priv = phy_get_drvdata(phy);\n\tu32 mask;\n\tint ret;\n\n\t \n\tmask = CFGA0_USB3PHY_RESET | CFGA0_USB2PHY_POR;\n\tret = regmap_update_bits(priv->usb31misc, USB_MISC_CFGA0, mask, 0);\n\tif (ret)\n\t\tgoto out;\n\n\tif (!hi3670_is_abbclk_selected(priv)) {\n\t\t \n\t\tret = regmap_write(priv->pctrl, PCTRL_PERI_CTRL3,\n\t\t\t\t   USB_TCXO_EN << PCTRL_PERI_CTRL3_MSK_START);\n\t} else {\n\t\tret = regmap_write(priv->peri_crg, PERI_CRG_PERDIS6,\n\t\t\t\t   GT_CLK_USB2PHY_REF);\n\t\tif (ret)\n\t\t\tgoto out;\n\t}\n\n\treturn 0;\nout:\n\tdev_err(priv->dev, \"failed to exit phy ret: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic const struct phy_ops hi3670_phy_ops = {\n\t.init\t\t= hi3670_phy_init,\n\t.exit\t\t= hi3670_phy_exit,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int hi3670_phy_probe(struct platform_device *pdev)\n{\n\tstruct phy_provider *phy_provider;\n\tstruct device *dev = &pdev->dev;\n\tstruct phy *phy;\n\tstruct hi3670_priv *priv;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = dev;\n\tpriv->peri_crg = syscon_regmap_lookup_by_phandle(dev->of_node,\n\t\t\t\t\t\t\t \"hisilicon,pericrg-syscon\");\n\tif (IS_ERR(priv->peri_crg)) {\n\t\tdev_err(dev, \"no hisilicon,pericrg-syscon\\n\");\n\t\treturn PTR_ERR(priv->peri_crg);\n\t}\n\n\tpriv->pctrl = syscon_regmap_lookup_by_phandle(dev->of_node,\n\t\t\t\t\t\t      \"hisilicon,pctrl-syscon\");\n\tif (IS_ERR(priv->pctrl)) {\n\t\tdev_err(dev, \"no hisilicon,pctrl-syscon\\n\");\n\t\treturn PTR_ERR(priv->pctrl);\n\t}\n\n\tpriv->sctrl = syscon_regmap_lookup_by_phandle(dev->of_node,\n\t\t\t\t\t\t      \"hisilicon,sctrl-syscon\");\n\tif (IS_ERR(priv->sctrl)) {\n\t\tdev_err(dev, \"no hisilicon,sctrl-syscon\\n\");\n\t\treturn PTR_ERR(priv->sctrl);\n\t}\n\n\t \n\tpriv->usb31misc = syscon_node_to_regmap(dev->parent->of_node);\n\tif (IS_ERR(priv->usb31misc)) {\n\t\tdev_err(dev, \"no hisilicon,usb3-otg-bc-syscon\\n\");\n\t\treturn PTR_ERR(priv->usb31misc);\n\t}\n\n\tif (of_property_read_u32(dev->of_node, \"hisilicon,eye-diagram-param\",\n\t\t\t\t &priv->eye_diagram_param))\n\t\tpriv->eye_diagram_param = KIRIN970_USB_DEFAULT_PHY_PARAM;\n\n\tif (of_property_read_u32(dev->of_node, \"hisilicon,tx-vboost-lvl\",\n\t\t\t\t &priv->tx_vboost_lvl))\n\t\tpriv->tx_vboost_lvl = KIRIN970_USB_DEFAULT_PHY_VBOOST;\n\n\tphy = devm_phy_create(dev, NULL, &hi3670_phy_ops);\n\tif (IS_ERR(phy))\n\t\treturn PTR_ERR(phy);\n\n\tphy_set_drvdata(phy, priv);\n\tphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct of_device_id hi3670_phy_of_match[] = {\n\t{ .compatible = \"hisilicon,hi3670-usb-phy\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, hi3670_phy_of_match);\n\nstatic struct platform_driver hi3670_phy_driver = {\n\t.probe\t= hi3670_phy_probe,\n\t.driver = {\n\t\t.name\t= \"hi3670-usb-phy\",\n\t\t.of_match_table\t= hi3670_phy_of_match,\n\t}\n};\nmodule_platform_driver(hi3670_phy_driver);\n\nMODULE_AUTHOR(\"Yu Chen <chenyu56@huawei.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Hilisicon Kirin970 USB31 PHY Driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}