{
  "module_name": "phy-hi3660-usb3.c",
  "hash_id": "b99f1be52351c0afd4165477cb99d00088a2f12cae30bb750e3fe09481a90b9a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/hisilicon/phy-hi3660-usb3.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define PERI_CRG_CLK_EN4\t\t\t0x40\n#define PERI_CRG_CLK_DIS4\t\t\t0x44\n#define GT_CLK_USB3OTG_REF\t\t\tBIT(0)\n#define GT_ACLK_USB3OTG\t\t\t\tBIT(1)\n\n#define PERI_CRG_RSTEN4\t\t\t\t0x90\n#define PERI_CRG_RSTDIS4\t\t\t0x94\n#define IP_RST_USB3OTGPHY_POR\t\t\tBIT(3)\n#define IP_RST_USB3OTG\t\t\t\tBIT(5)\n\n#define PERI_CRG_ISODIS\t\t\t\t0x148\n#define USB_REFCLK_ISO_EN\t\t\tBIT(25)\n\n#define PCTRL_PERI_CTRL3\t\t\t0x10\n#define PCTRL_PERI_CTRL3_MSK_START\t\t16\n#define USB_TCXO_EN\t\t\t\tBIT(1)\n\n#define PCTRL_PERI_CTRL24\t\t\t0x64\n#define SC_CLK_USB3PHY_3MUX1_SEL\t\tBIT(25)\n\n#define USBOTG3_CTRL0\t\t\t\t0x00\n#define SC_USB3PHY_ABB_GT_EN\t\t\tBIT(15)\n\n#define USBOTG3_CTRL2\t\t\t\t0x08\n#define USBOTG3CTRL2_POWERDOWN_HSP\t\tBIT(0)\n#define USBOTG3CTRL2_POWERDOWN_SSP\t\tBIT(1)\n\n#define USBOTG3_CTRL3\t\t\t\t0x0C\n#define USBOTG3_CTRL3_VBUSVLDEXT\t\tBIT(6)\n#define USBOTG3_CTRL3_VBUSVLDEXTSEL\t\tBIT(5)\n\n#define USBOTG3_CTRL4\t\t\t\t0x10\n\n#define USBOTG3_CTRL7\t\t\t\t0x1c\n#define REF_SSP_EN\t\t\t\tBIT(16)\n\n \n#define HI3660_USB_DEFAULT_PHY_PARAM\t\t0x1c466e3\n\nstruct hi3660_priv {\n\tstruct device *dev;\n\tstruct regmap *peri_crg;\n\tstruct regmap *pctrl;\n\tstruct regmap *otg_bc;\n\tu32 eye_diagram_param;\n};\n\nstatic int hi3660_phy_init(struct phy *phy)\n{\n\tstruct hi3660_priv *priv = phy_get_drvdata(phy);\n\tu32 val, mask;\n\tint ret;\n\n\t \n\tret = regmap_write(priv->peri_crg, PERI_CRG_ISODIS, USB_REFCLK_ISO_EN);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tval = USB_TCXO_EN | (USB_TCXO_EN << PCTRL_PERI_CTRL3_MSK_START);\n\tret = regmap_write(priv->pctrl, PCTRL_PERI_CTRL3, val);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tval = IP_RST_USB3OTGPHY_POR | IP_RST_USB3OTG;\n\tret = regmap_write(priv->peri_crg, PERI_CRG_RSTEN4, val);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tval = SC_USB3PHY_ABB_GT_EN;\n\tmask = val;\n\tret = regmap_update_bits(priv->otg_bc, USBOTG3_CTRL0, mask, val);\n\tif (ret)\n\t\tgoto out;\n\n\tval = REF_SSP_EN;\n\tmask = val;\n\tret = regmap_update_bits(priv->otg_bc, USBOTG3_CTRL7, mask, val);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tmask = USBOTG3CTRL2_POWERDOWN_HSP | USBOTG3CTRL2_POWERDOWN_SSP;\n\tret = regmap_update_bits(priv->otg_bc, USBOTG3_CTRL2, mask, 0);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tusleep_range(100, 120);\n\n\t \n\tval = IP_RST_USB3OTGPHY_POR | IP_RST_USB3OTG;\n\tret = regmap_write(priv->peri_crg, PERI_CRG_RSTDIS4, val);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tusleep_range(10000, 15000);\n\n\t \n\tval = USBOTG3_CTRL3_VBUSVLDEXT | USBOTG3_CTRL3_VBUSVLDEXTSEL;\n\tmask = val;\n\tret = regmap_update_bits(priv->otg_bc, USBOTG3_CTRL3, mask, val);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tusleep_range(100, 120);\n\n\tret = regmap_write(priv->otg_bc, USBOTG3_CTRL4,\n\t\t\tpriv->eye_diagram_param);\n\tif (ret)\n\t\tgoto out;\n\n\treturn 0;\nout:\n\tdev_err(priv->dev, \"failed to init phy ret: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic int hi3660_phy_exit(struct phy *phy)\n{\n\tstruct hi3660_priv *priv = phy_get_drvdata(phy);\n\tu32 val;\n\tint ret;\n\n\t \n\tval = IP_RST_USB3OTGPHY_POR;\n\tret = regmap_write(priv->peri_crg, PERI_CRG_RSTEN4, val);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tval = USB_TCXO_EN << PCTRL_PERI_CTRL3_MSK_START;\n\tret = regmap_write(priv->pctrl, PCTRL_PERI_CTRL3, val);\n\tif (ret)\n\t\tgoto out;\n\n\treturn 0;\nout:\n\tdev_err(priv->dev, \"failed to exit phy ret: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic const struct phy_ops hi3660_phy_ops = {\n\t.init\t\t= hi3660_phy_init,\n\t.exit\t\t= hi3660_phy_exit,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int hi3660_phy_probe(struct platform_device *pdev)\n{\n\tstruct phy_provider *phy_provider;\n\tstruct device *dev = &pdev->dev;\n\tstruct phy *phy;\n\tstruct hi3660_priv *priv;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = dev;\n\tpriv->peri_crg = syscon_regmap_lookup_by_phandle(dev->of_node,\n\t\t\t\t\t\"hisilicon,pericrg-syscon\");\n\tif (IS_ERR(priv->peri_crg)) {\n\t\tdev_err(dev, \"no hisilicon,pericrg-syscon\\n\");\n\t\treturn PTR_ERR(priv->peri_crg);\n\t}\n\n\tpriv->pctrl = syscon_regmap_lookup_by_phandle(dev->of_node,\n\t\t\t\t\t\"hisilicon,pctrl-syscon\");\n\tif (IS_ERR(priv->pctrl)) {\n\t\tdev_err(dev, \"no hisilicon,pctrl-syscon\\n\");\n\t\treturn PTR_ERR(priv->pctrl);\n\t}\n\n\t \n\tpriv->otg_bc = syscon_node_to_regmap(dev->parent->of_node);\n\tif (IS_ERR(priv->otg_bc)) {\n\t\tdev_err(dev, \"no hisilicon,usb3-otg-bc-syscon\\n\");\n\t\treturn PTR_ERR(priv->otg_bc);\n\t}\n\n\tif (of_property_read_u32(dev->of_node, \"hisilicon,eye-diagram-param\",\n\t\t&(priv->eye_diagram_param)))\n\t\tpriv->eye_diagram_param = HI3660_USB_DEFAULT_PHY_PARAM;\n\n\tphy = devm_phy_create(dev, NULL, &hi3660_phy_ops);\n\tif (IS_ERR(phy))\n\t\treturn PTR_ERR(phy);\n\n\tphy_set_drvdata(phy, priv);\n\tphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct of_device_id hi3660_phy_of_match[] = {\n\t{.compatible = \"hisilicon,hi3660-usb-phy\",},\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, hi3660_phy_of_match);\n\nstatic struct platform_driver hi3660_phy_driver = {\n\t.probe\t= hi3660_phy_probe,\n\t.driver = {\n\t\t.name\t= \"hi3660-usb-phy\",\n\t\t.of_match_table\t= hi3660_phy_of_match,\n\t}\n};\nmodule_platform_driver(hi3660_phy_driver);\n\nMODULE_AUTHOR(\"Yu Chen <chenyu56@huawei.com>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Hilisicon Hi3660 USB3 PHY Driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}