{
  "module_name": "phy-hix5hd2-sata.c",
  "hash_id": "ef06a7e86b1eec25afbba5d3056143bf6945292cf44d4d08e5a14e47d09f327f",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/hisilicon/phy-hix5hd2-sata.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define SATA_PHY0_CTLL\t\t0xa0\n#define MPLL_MULTIPLIER_SHIFT\t1\n#define MPLL_MULTIPLIER_MASK\t0xfe\n#define MPLL_MULTIPLIER_50M\t0x3c\n#define MPLL_MULTIPLIER_100M\t0x1e\n#define PHY_RESET\t\tBIT(0)\n#define REF_SSP_EN\t\tBIT(9)\n#define SSC_EN\t\t\tBIT(10)\n#define REF_USE_PAD\t\tBIT(23)\n\n#define SATA_PORT_PHYCTL\t0x174\n#define SPEED_MODE_MASK\t\t0x6f0000\n#define HALF_RATE_SHIFT\t\t16\n#define PHY_CONFIG_SHIFT\t18\n#define GEN2_EN_SHIFT\t\t21\n#define SPEED_CTRL\t\tBIT(20)\n\n#define SATA_PORT_PHYCTL1\t0x148\n#define AMPLITUDE_MASK\t\t0x3ffffe\n#define AMPLITUDE_GEN3\t\t0x68\n#define AMPLITUDE_GEN3_SHIFT\t15\n#define AMPLITUDE_GEN2\t\t0x56\n#define AMPLITUDE_GEN2_SHIFT\t8\n#define AMPLITUDE_GEN1\t\t0x56\n#define AMPLITUDE_GEN1_SHIFT\t1\n\n#define SATA_PORT_PHYCTL2\t0x14c\n#define PREEMPH_MASK\t\t0x3ffff\n#define PREEMPH_GEN3\t\t0x20\n#define PREEMPH_GEN3_SHIFT\t12\n#define PREEMPH_GEN2\t\t0x15\n#define PREEMPH_GEN2_SHIFT\t6\n#define PREEMPH_GEN1\t\t0x5\n#define PREEMPH_GEN1_SHIFT\t0\n\nstruct hix5hd2_priv {\n\tvoid __iomem\t*base;\n\tstruct regmap\t*peri_ctrl;\n};\n\nenum phy_speed_mode {\n\tSPEED_MODE_GEN1 = 0,\n\tSPEED_MODE_GEN2 = 1,\n\tSPEED_MODE_GEN3 = 2,\n};\n\nstatic int hix5hd2_sata_phy_init(struct phy *phy)\n{\n\tstruct hix5hd2_priv *priv = phy_get_drvdata(phy);\n\tu32 val, data[2];\n\tint ret;\n\n\tif (priv->peri_ctrl) {\n\t\tret = of_property_read_u32_array(phy->dev.of_node,\n\t\t\t\t\t\t \"hisilicon,power-reg\",\n\t\t\t\t\t\t &data[0], 2);\n\t\tif (ret) {\n\t\t\tdev_err(&phy->dev, \"Fail read hisilicon,power-reg\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tregmap_update_bits(priv->peri_ctrl, data[0],\n\t\t\t\t   BIT(data[1]), BIT(data[1]));\n\t}\n\n\t \n\tval = readl_relaxed(priv->base + SATA_PHY0_CTLL);\n\tval &= ~(MPLL_MULTIPLIER_MASK | REF_USE_PAD);\n\tval |= MPLL_MULTIPLIER_50M << MPLL_MULTIPLIER_SHIFT |\n\t       REF_SSP_EN | PHY_RESET;\n\twritel_relaxed(val, priv->base + SATA_PHY0_CTLL);\n\tmsleep(20);\n\tval &= ~PHY_RESET;\n\twritel_relaxed(val, priv->base + SATA_PHY0_CTLL);\n\n\tval = readl_relaxed(priv->base + SATA_PORT_PHYCTL1);\n\tval &= ~AMPLITUDE_MASK;\n\tval |= AMPLITUDE_GEN3 << AMPLITUDE_GEN3_SHIFT |\n\t       AMPLITUDE_GEN2 << AMPLITUDE_GEN2_SHIFT |\n\t       AMPLITUDE_GEN1 << AMPLITUDE_GEN1_SHIFT;\n\twritel_relaxed(val, priv->base + SATA_PORT_PHYCTL1);\n\n\tval = readl_relaxed(priv->base + SATA_PORT_PHYCTL2);\n\tval &= ~PREEMPH_MASK;\n\tval |= PREEMPH_GEN3 << PREEMPH_GEN3_SHIFT |\n\t       PREEMPH_GEN2 << PREEMPH_GEN2_SHIFT |\n\t       PREEMPH_GEN1 << PREEMPH_GEN1_SHIFT;\n\twritel_relaxed(val, priv->base + SATA_PORT_PHYCTL2);\n\n\t \n\tval = readl_relaxed(priv->base + SATA_PORT_PHYCTL);\n\tval &= ~SPEED_MODE_MASK;\n\tval |= SPEED_MODE_GEN1 << HALF_RATE_SHIFT |\n\t       SPEED_MODE_GEN1 << PHY_CONFIG_SHIFT |\n\t       SPEED_MODE_GEN1 << GEN2_EN_SHIFT | SPEED_CTRL;\n\twritel_relaxed(val, priv->base + SATA_PORT_PHYCTL);\n\n\tmsleep(20);\n\tval &= ~SPEED_MODE_MASK;\n\tval |= SPEED_MODE_GEN3 << HALF_RATE_SHIFT |\n\t       SPEED_MODE_GEN3 << PHY_CONFIG_SHIFT |\n\t       SPEED_MODE_GEN3 << GEN2_EN_SHIFT | SPEED_CTRL;\n\twritel_relaxed(val, priv->base + SATA_PORT_PHYCTL);\n\n\tval &= ~(SPEED_MODE_MASK | SPEED_CTRL);\n\tval |= SPEED_MODE_GEN2 << HALF_RATE_SHIFT |\n\t       SPEED_MODE_GEN2 << PHY_CONFIG_SHIFT |\n\t       SPEED_MODE_GEN2 << GEN2_EN_SHIFT;\n\twritel_relaxed(val, priv->base + SATA_PORT_PHYCTL);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops hix5hd2_sata_phy_ops = {\n\t.init\t\t= hix5hd2_sata_phy_init,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int hix5hd2_sata_phy_probe(struct platform_device *pdev)\n{\n\tstruct phy_provider *phy_provider;\n\tstruct device *dev = &pdev->dev;\n\tstruct resource *res;\n\tstruct phy *phy;\n\tstruct hix5hd2_priv *priv;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!res)\n\t\treturn -EINVAL;\n\n\tpriv->base = devm_ioremap(dev, res->start, resource_size(res));\n\tif (!priv->base)\n\t\treturn -ENOMEM;\n\n\tpriv->peri_ctrl = syscon_regmap_lookup_by_phandle(dev->of_node,\n\t\t\t\t\t\"hisilicon,peripheral-syscon\");\n\tif (IS_ERR(priv->peri_ctrl))\n\t\tpriv->peri_ctrl = NULL;\n\n\tphy = devm_phy_create(dev, NULL, &hix5hd2_sata_phy_ops);\n\tif (IS_ERR(phy)) {\n\t\tdev_err(dev, \"failed to create PHY\\n\");\n\t\treturn PTR_ERR(phy);\n\t}\n\n\tphy_set_drvdata(phy, priv);\n\tphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct of_device_id hix5hd2_sata_phy_of_match[] = {\n\t{.compatible = \"hisilicon,hix5hd2-sata-phy\",},\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, hix5hd2_sata_phy_of_match);\n\nstatic struct platform_driver hix5hd2_sata_phy_driver = {\n\t.probe\t= hix5hd2_sata_phy_probe,\n\t.driver = {\n\t\t.name\t= \"hix5hd2-sata-phy\",\n\t\t.of_match_table\t= hix5hd2_sata_phy_of_match,\n\t}\n};\nmodule_platform_driver(hix5hd2_sata_phy_driver);\n\nMODULE_AUTHOR(\"Jiancheng Xue <xuejiancheng@huawei.com>\");\nMODULE_DESCRIPTION(\"HISILICON HIX5HD2 SATA PHY driver\");\nMODULE_ALIAS(\"platform:hix5hd2-sata-phy\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}