{
  "module_name": "phy-hi6220-usb.c",
  "hash_id": "b49b851eac2493b362573e7e555586ec68b6504e2d5779daa8ecf7251be81ae3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/hisilicon/phy-hi6220-usb.c",
  "human_readable_source": "\n \n\n#include <linux/mfd/syscon.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/phy/phy.h>\n#include <linux/regmap.h>\n\n#define SC_PERIPH_CTRL4\t\t\t0x00c\n\n#define CTRL4_PICO_SIDDQ\t\tBIT(6)\n#define CTRL4_PICO_OGDISABLE\t\tBIT(8)\n#define CTRL4_PICO_VBUSVLDEXT\t\tBIT(10)\n#define CTRL4_PICO_VBUSVLDEXTSEL\tBIT(11)\n#define CTRL4_OTG_PHY_SEL\t\tBIT(21)\n\n#define SC_PERIPH_CTRL5\t\t\t0x010\n\n#define CTRL5_USBOTG_RES_SEL\t\tBIT(3)\n#define CTRL5_PICOPHY_ACAENB\t\tBIT(4)\n#define CTRL5_PICOPHY_BC_MODE\t\tBIT(5)\n#define CTRL5_PICOPHY_CHRGSEL\t\tBIT(6)\n#define CTRL5_PICOPHY_VDATSRCEND\tBIT(7)\n#define CTRL5_PICOPHY_VDATDETENB\tBIT(8)\n#define CTRL5_PICOPHY_DCDENB\t\tBIT(9)\n#define CTRL5_PICOPHY_IDDIG\t\tBIT(10)\n\n#define SC_PERIPH_CTRL8\t\t\t0x018\n#define SC_PERIPH_RSTEN0\t\t0x300\n#define SC_PERIPH_RSTDIS0\t\t0x304\n\n#define RST0_USBOTG_BUS\t\t\tBIT(4)\n#define RST0_POR_PICOPHY\t\tBIT(5)\n#define RST0_USBOTG\t\t\tBIT(6)\n#define RST0_USBOTG_32K\t\t\tBIT(7)\n\n#define EYE_PATTERN_PARA\t\t0x7053348c\n\nstruct hi6220_priv {\n\tstruct regmap *reg;\n\tstruct device *dev;\n};\n\nstatic void hi6220_phy_init(struct hi6220_priv *priv)\n{\n\tstruct regmap *reg = priv->reg;\n\tu32 val, mask;\n\n\tval = RST0_USBOTG_BUS | RST0_POR_PICOPHY |\n\t      RST0_USBOTG | RST0_USBOTG_32K;\n\tmask = val;\n\tregmap_update_bits(reg, SC_PERIPH_RSTEN0, mask, val);\n\tregmap_update_bits(reg, SC_PERIPH_RSTDIS0, mask, val);\n}\n\nstatic int hi6220_phy_setup(struct hi6220_priv *priv, bool on)\n{\n\tstruct regmap *reg = priv->reg;\n\tu32 val, mask;\n\tint ret;\n\n\tif (on) {\n\t\tval = CTRL5_USBOTG_RES_SEL | CTRL5_PICOPHY_ACAENB;\n\t\tmask = val | CTRL5_PICOPHY_BC_MODE;\n\t\tret = regmap_update_bits(reg, SC_PERIPH_CTRL5, mask, val);\n\t\tif (ret)\n\t\t\tgoto out;\n\n\t\tval =  CTRL4_PICO_VBUSVLDEXT | CTRL4_PICO_VBUSVLDEXTSEL |\n\t\t       CTRL4_OTG_PHY_SEL;\n\t\tmask = val | CTRL4_PICO_SIDDQ | CTRL4_PICO_OGDISABLE;\n\t\tret = regmap_update_bits(reg, SC_PERIPH_CTRL4, mask, val);\n\t\tif (ret)\n\t\t\tgoto out;\n\n\t\tret = regmap_write(reg, SC_PERIPH_CTRL8, EYE_PATTERN_PARA);\n\t\tif (ret)\n\t\t\tgoto out;\n\t} else {\n\t\tval = CTRL4_PICO_SIDDQ;\n\t\tmask = val;\n\t\tret = regmap_update_bits(reg, SC_PERIPH_CTRL4, mask, val);\n\t\tif (ret)\n\t\t\tgoto out;\n\t}\n\n\treturn 0;\nout:\n\tdev_err(priv->dev, \"failed to setup phy ret: %d\\n\", ret);\n\treturn ret;\n}\n\nstatic int hi6220_phy_start(struct phy *phy)\n{\n\tstruct hi6220_priv *priv = phy_get_drvdata(phy);\n\n\treturn hi6220_phy_setup(priv, true);\n}\n\nstatic int hi6220_phy_exit(struct phy *phy)\n{\n\tstruct hi6220_priv *priv = phy_get_drvdata(phy);\n\n\treturn hi6220_phy_setup(priv, false);\n}\n\nstatic const struct phy_ops hi6220_phy_ops = {\n\t.init\t\t= hi6220_phy_start,\n\t.exit\t\t= hi6220_phy_exit,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int hi6220_phy_probe(struct platform_device *pdev)\n{\n\tstruct phy_provider *phy_provider;\n\tstruct device *dev = &pdev->dev;\n\tstruct phy *phy;\n\tstruct hi6220_priv *priv;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = dev;\n\tpriv->reg = syscon_regmap_lookup_by_phandle(dev->of_node,\n\t\t\t\t\t\"hisilicon,peripheral-syscon\");\n\tif (IS_ERR(priv->reg)) {\n\t\tdev_err(dev, \"no hisilicon,peripheral-syscon\\n\");\n\t\treturn PTR_ERR(priv->reg);\n\t}\n\n\thi6220_phy_init(priv);\n\n\tphy = devm_phy_create(dev, NULL, &hi6220_phy_ops);\n\tif (IS_ERR(phy))\n\t\treturn PTR_ERR(phy);\n\n\tphy_set_drvdata(phy, priv);\n\tphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct of_device_id hi6220_phy_of_match[] = {\n\t{.compatible = \"hisilicon,hi6220-usb-phy\",},\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, hi6220_phy_of_match);\n\nstatic struct platform_driver hi6220_phy_driver = {\n\t.probe\t= hi6220_phy_probe,\n\t.driver = {\n\t\t.name\t= \"hi6220-usb-phy\",\n\t\t.of_match_table\t= hi6220_phy_of_match,\n\t}\n};\nmodule_platform_driver(hi6220_phy_driver);\n\nMODULE_DESCRIPTION(\"HISILICON HI6220 USB PHY driver\");\nMODULE_ALIAS(\"platform:hi6220-usb-phy\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}