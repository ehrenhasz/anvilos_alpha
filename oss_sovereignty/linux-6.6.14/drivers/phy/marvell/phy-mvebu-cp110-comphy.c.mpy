{
  "module_name": "phy-mvebu-cp110-comphy.c",
  "hash_id": "e93c2477f8d716110106094b3bd30d122cfd52e6c921532cb713fe1de2b11e67",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/marvell/phy-mvebu-cp110-comphy.c",
  "human_readable_source": "\n \n\n#include <linux/arm-smccc.h>\n#include <linux/clk.h>\n#include <linux/io.h>\n#include <linux/iopoll.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n \n#define MVEBU_COMPHY_SERDES_CFG0(n)\t\t(0x0 + (n) * 0x1000)\n#define     MVEBU_COMPHY_SERDES_CFG0_PU_PLL\tBIT(1)\n#define     MVEBU_COMPHY_SERDES_CFG0_GEN_RX(n)\t((n) << 3)\n#define     MVEBU_COMPHY_SERDES_CFG0_GEN_TX(n)\t((n) << 7)\n#define     MVEBU_COMPHY_SERDES_CFG0_PU_RX\tBIT(11)\n#define     MVEBU_COMPHY_SERDES_CFG0_PU_TX\tBIT(12)\n#define     MVEBU_COMPHY_SERDES_CFG0_HALF_BUS\tBIT(14)\n#define     MVEBU_COMPHY_SERDES_CFG0_RXAUI_MODE\tBIT(15)\n#define MVEBU_COMPHY_SERDES_CFG1(n)\t\t(0x4 + (n) * 0x1000)\n#define     MVEBU_COMPHY_SERDES_CFG1_RESET\tBIT(3)\n#define     MVEBU_COMPHY_SERDES_CFG1_RX_INIT\tBIT(4)\n#define     MVEBU_COMPHY_SERDES_CFG1_CORE_RESET\tBIT(5)\n#define     MVEBU_COMPHY_SERDES_CFG1_RF_RESET\tBIT(6)\n#define MVEBU_COMPHY_SERDES_CFG2(n)\t\t(0x8 + (n) * 0x1000)\n#define     MVEBU_COMPHY_SERDES_CFG2_DFE_EN\tBIT(4)\n#define MVEBU_COMPHY_SERDES_STATUS0(n)\t\t(0x18 + (n) * 0x1000)\n#define     MVEBU_COMPHY_SERDES_STATUS0_TX_PLL_RDY\tBIT(2)\n#define     MVEBU_COMPHY_SERDES_STATUS0_RX_PLL_RDY\tBIT(3)\n#define     MVEBU_COMPHY_SERDES_STATUS0_RX_INIT\t\tBIT(4)\n#define MVEBU_COMPHY_PWRPLL_CTRL(n)\t\t(0x804 + (n) * 0x1000)\n#define     MVEBU_COMPHY_PWRPLL_CTRL_RFREQ(n)\t((n) << 0)\n#define     MVEBU_COMPHY_PWRPLL_PHY_MODE(n)\t((n) << 5)\n#define MVEBU_COMPHY_IMP_CAL(n)\t\t\t(0x80c + (n) * 0x1000)\n#define     MVEBU_COMPHY_IMP_CAL_TX_EXT(n)\t((n) << 10)\n#define     MVEBU_COMPHY_IMP_CAL_TX_EXT_EN\tBIT(15)\n#define MVEBU_COMPHY_DFE_RES(n)\t\t\t(0x81c + (n) * 0x1000)\n#define     MVEBU_COMPHY_DFE_RES_FORCE_GEN_TBL\tBIT(15)\n#define MVEBU_COMPHY_COEF(n)\t\t\t(0x828 + (n) * 0x1000)\n#define     MVEBU_COMPHY_COEF_DFE_EN\t\tBIT(14)\n#define     MVEBU_COMPHY_COEF_DFE_CTRL\t\tBIT(15)\n#define MVEBU_COMPHY_GEN1_S0(n)\t\t\t(0x834 + (n) * 0x1000)\n#define     MVEBU_COMPHY_GEN1_S0_TX_AMP(n)\t((n) << 1)\n#define     MVEBU_COMPHY_GEN1_S0_TX_EMPH(n)\t((n) << 7)\n#define MVEBU_COMPHY_GEN1_S1(n)\t\t\t(0x838 + (n) * 0x1000)\n#define     MVEBU_COMPHY_GEN1_S1_RX_MUL_PI(n)\t((n) << 0)\n#define     MVEBU_COMPHY_GEN1_S1_RX_MUL_PF(n)\t((n) << 3)\n#define     MVEBU_COMPHY_GEN1_S1_RX_MUL_FI(n)\t((n) << 6)\n#define     MVEBU_COMPHY_GEN1_S1_RX_MUL_FF(n)\t((n) << 8)\n#define     MVEBU_COMPHY_GEN1_S1_RX_DFE_EN\tBIT(10)\n#define     MVEBU_COMPHY_GEN1_S1_RX_DIV(n)\t((n) << 11)\n#define MVEBU_COMPHY_GEN1_S2(n)\t\t\t(0x8f4 + (n) * 0x1000)\n#define     MVEBU_COMPHY_GEN1_S2_TX_EMPH(n)\t((n) << 0)\n#define     MVEBU_COMPHY_GEN1_S2_TX_EMPH_EN\tBIT(4)\n#define MVEBU_COMPHY_LOOPBACK(n)\t\t(0x88c + (n) * 0x1000)\n#define     MVEBU_COMPHY_LOOPBACK_DBUS_WIDTH(n)\t((n) << 1)\n#define MVEBU_COMPHY_VDD_CAL0(n)\t\t(0x908 + (n) * 0x1000)\n#define     MVEBU_COMPHY_VDD_CAL0_CONT_MODE\tBIT(15)\n#define MVEBU_COMPHY_EXT_SELV(n)\t\t(0x914 + (n) * 0x1000)\n#define     MVEBU_COMPHY_EXT_SELV_RX_SAMPL(n)\t((n) << 5)\n#define MVEBU_COMPHY_MISC_CTRL0(n)\t\t(0x93c + (n) * 0x1000)\n#define     MVEBU_COMPHY_MISC_CTRL0_ICP_FORCE\tBIT(5)\n#define     MVEBU_COMPHY_MISC_CTRL0_REFCLK_SEL\tBIT(10)\n#define MVEBU_COMPHY_RX_CTRL1(n)\t\t(0x940 + (n) * 0x1000)\n#define     MVEBU_COMPHY_RX_CTRL1_RXCLK2X_SEL\tBIT(11)\n#define     MVEBU_COMPHY_RX_CTRL1_CLK8T_EN\tBIT(12)\n#define MVEBU_COMPHY_SPEED_DIV(n)\t\t(0x954 + (n) * 0x1000)\n#define     MVEBU_COMPHY_SPEED_DIV_TX_FORCE\tBIT(7)\n#define MVEBU_SP_CALIB(n)\t\t\t(0x96c + (n) * 0x1000)\n#define     MVEBU_SP_CALIB_SAMPLER(n)\t\t((n) << 8)\n#define     MVEBU_SP_CALIB_SAMPLER_EN\t\tBIT(12)\n#define MVEBU_COMPHY_TX_SLEW_RATE(n)\t\t(0x974 + (n) * 0x1000)\n#define     MVEBU_COMPHY_TX_SLEW_RATE_EMPH(n)\t((n) << 5)\n#define     MVEBU_COMPHY_TX_SLEW_RATE_SLC(n)\t((n) << 10)\n#define MVEBU_COMPHY_DTL_CTRL(n)\t\t(0x984 + (n) * 0x1000)\n#define     MVEBU_COMPHY_DTL_CTRL_DTL_FLOOP_EN\tBIT(2)\n#define MVEBU_COMPHY_FRAME_DETECT0(n)\t\t(0xa14 + (n) * 0x1000)\n#define     MVEBU_COMPHY_FRAME_DETECT0_PATN(n)\t((n) << 7)\n#define MVEBU_COMPHY_FRAME_DETECT3(n)\t\t(0xa20 + (n) * 0x1000)\n#define     MVEBU_COMPHY_FRAME_DETECT3_LOST_TIMEOUT_EN\tBIT(12)\n#define MVEBU_COMPHY_DME(n)\t\t\t(0xa28 + (n) * 0x1000)\n#define     MVEBU_COMPHY_DME_ETH_MODE\t\tBIT(7)\n#define MVEBU_COMPHY_TRAINING0(n)\t\t(0xa68 + (n) * 0x1000)\n#define     MVEBU_COMPHY_TRAINING0_P2P_HOLD\tBIT(15)\n#define MVEBU_COMPHY_TRAINING5(n)\t\t(0xaa4 + (n) * 0x1000)\n#define\t    MVEBU_COMPHY_TRAINING5_RX_TIMER(n)\t((n) << 0)\n#define MVEBU_COMPHY_TX_TRAIN_PRESET(n)\t\t(0xb1c + (n) * 0x1000)\n#define     MVEBU_COMPHY_TX_TRAIN_PRESET_16B_AUTO_EN\tBIT(8)\n#define     MVEBU_COMPHY_TX_TRAIN_PRESET_PRBS11\t\tBIT(9)\n#define MVEBU_COMPHY_GEN1_S3(n)\t\t\t(0xc40 + (n) * 0x1000)\n#define     MVEBU_COMPHY_GEN1_S3_FBCK_SEL\tBIT(9)\n#define MVEBU_COMPHY_GEN1_S4(n)\t\t\t(0xc44 + (n) * 0x1000)\n#define\t    MVEBU_COMPHY_GEN1_S4_DFE_RES(n)\t((n) << 8)\n#define MVEBU_COMPHY_TX_PRESET(n)\t\t(0xc68 + (n) * 0x1000)\n#define     MVEBU_COMPHY_TX_PRESET_INDEX(n)\t((n) << 0)\n#define MVEBU_COMPHY_GEN1_S5(n)\t\t\t(0xd38 + (n) * 0x1000)\n#define     MVEBU_COMPHY_GEN1_S5_ICP(n)\t\t((n) << 0)\n\n \n#define MVEBU_COMPHY_CONF1(n)\t\t\t(0x1000 + (n) * 0x28)\n#define     MVEBU_COMPHY_CONF1_PWRUP\t\tBIT(1)\n#define     MVEBU_COMPHY_CONF1_USB_PCIE\t\tBIT(2)\t \n#define MVEBU_COMPHY_CONF6(n)\t\t\t(0x1014 + (n) * 0x28)\n#define     MVEBU_COMPHY_CONF6_40B\t\tBIT(18)\n#define MVEBU_COMPHY_SELECTOR\t\t\t0x1140\n#define     MVEBU_COMPHY_SELECTOR_PHY(n)\t((n) * 0x4)\n#define MVEBU_COMPHY_PIPE_SELECTOR\t\t0x1144\n#define     MVEBU_COMPHY_PIPE_SELECTOR_PIPE(n)\t((n) * 0x4)\n#define MVEBU_COMPHY_SD1_CTRL1\t\t\t0x1148\n#define     MVEBU_COMPHY_SD1_CTRL1_RXAUI1_EN\tBIT(26)\n#define     MVEBU_COMPHY_SD1_CTRL1_RXAUI0_EN\tBIT(27)\n\n#define MVEBU_COMPHY_LANES\t6\n#define MVEBU_COMPHY_PORTS\t3\n\n#define COMPHY_SIP_POWER_ON\t0x82000001\n#define COMPHY_SIP_POWER_OFF\t0x82000002\n\n \n#define COMPHY_FW_POL_OFFSET\t0\n#define COMPHY_FW_POL_MASK\tGENMASK(1, 0)\n#define COMPHY_FW_SPEED_OFFSET\t2\n#define COMPHY_FW_SPEED_MASK\tGENMASK(7, 2)\n#define COMPHY_FW_SPEED_MAX\tCOMPHY_FW_SPEED_MASK\n#define COMPHY_FW_SPEED_1250\t0\n#define COMPHY_FW_SPEED_3125\t2\n#define COMPHY_FW_SPEED_5000\t3\n#define COMPHY_FW_SPEED_515625\t4\n#define COMPHY_FW_SPEED_103125\t6\n#define COMPHY_FW_PORT_OFFSET\t8\n#define COMPHY_FW_PORT_MASK\tGENMASK(11, 8)\n#define COMPHY_FW_MODE_OFFSET\t12\n#define COMPHY_FW_MODE_MASK\tGENMASK(16, 12)\n#define COMPHY_FW_WIDTH_OFFSET\t18\n#define COMPHY_FW_WIDTH_MASK\tGENMASK(20, 18)\n\n#define COMPHY_FW_PARAM_FULL(mode, port, speed, pol, width)\t\t\\\n\t((((pol) << COMPHY_FW_POL_OFFSET) & COMPHY_FW_POL_MASK) |\t\\\n\t (((mode) << COMPHY_FW_MODE_OFFSET) & COMPHY_FW_MODE_MASK) |\t\\\n\t (((port) << COMPHY_FW_PORT_OFFSET) & COMPHY_FW_PORT_MASK) |\t\\\n\t (((speed) << COMPHY_FW_SPEED_OFFSET) & COMPHY_FW_SPEED_MASK) |\t\\\n\t (((width) << COMPHY_FW_WIDTH_OFFSET) & COMPHY_FW_WIDTH_MASK))\n\n#define COMPHY_FW_PARAM(mode, port)\t\t\t\t\t\\\n\tCOMPHY_FW_PARAM_FULL(mode, port, COMPHY_FW_SPEED_MAX, 0, 0)\n\n#define COMPHY_FW_PARAM_ETH(mode, port, speed)\t\t\t\t\\\n\tCOMPHY_FW_PARAM_FULL(mode, port, speed, 0, 0)\n\n#define COMPHY_FW_PARAM_PCIE(mode, port, width)\t\t\t\t\\\n\tCOMPHY_FW_PARAM_FULL(mode, port, COMPHY_FW_SPEED_5000, 0, width)\n\n#define COMPHY_FW_MODE_SATA\t\t0x1\n#define COMPHY_FW_MODE_SGMII\t\t0x2  \n#define COMPHY_FW_MODE_2500BASEX\t0x3  \n#define COMPHY_FW_MODE_USB3H\t\t0x4\n#define COMPHY_FW_MODE_USB3D\t\t0x5\n#define COMPHY_FW_MODE_PCIE\t\t0x6\n#define COMPHY_FW_MODE_RXAUI\t\t0x7\n#define COMPHY_FW_MODE_XFI\t\t0x8  \n\nstruct mvebu_comphy_conf {\n\tenum phy_mode mode;\n\tint submode;\n\tunsigned lane;\n\tunsigned port;\n\tu32 mux;\n\tu32 fw_mode;\n};\n\n#define ETH_CONF(_lane, _port, _submode, _mux, _fw)\t\\\n\t{\t\t\t\t\t\t\\\n\t\t.lane = _lane,\t\t\t\t\\\n\t\t.port = _port,\t\t\t\t\\\n\t\t.mode = PHY_MODE_ETHERNET,\t\t\\\n\t\t.submode = _submode,\t\t\t\\\n\t\t.mux = _mux,\t\t\t\t\\\n\t\t.fw_mode = _fw,\t\t\t\t\\\n\t}\n\n#define GEN_CONF(_lane, _port, _mode, _fw)\t\t\\\n\t{\t\t\t\t\t\t\\\n\t\t.lane = _lane,\t\t\t\t\\\n\t\t.port = _port,\t\t\t\t\\\n\t\t.mode = _mode,\t\t\t\t\\\n\t\t.submode = PHY_INTERFACE_MODE_NA,\t\\\n\t\t.mux = -1,\t\t\t\t\\\n\t\t.fw_mode = _fw,\t\t\t\t\\\n\t}\n\nstatic const struct mvebu_comphy_conf mvebu_comphy_cp110_modes[] = {\n\t \n\tGEN_CONF(0, 0, PHY_MODE_PCIE, COMPHY_FW_MODE_PCIE),\n\tETH_CONF(0, 1, PHY_INTERFACE_MODE_SGMII, 0x1, COMPHY_FW_MODE_SGMII),\n\tETH_CONF(0, 1, PHY_INTERFACE_MODE_2500BASEX, 0x1, COMPHY_FW_MODE_2500BASEX),\n\tGEN_CONF(0, 1, PHY_MODE_SATA, COMPHY_FW_MODE_SATA),\n\t \n\tGEN_CONF(1, 0, PHY_MODE_USB_HOST_SS, COMPHY_FW_MODE_USB3H),\n\tGEN_CONF(1, 0, PHY_MODE_USB_DEVICE_SS, COMPHY_FW_MODE_USB3D),\n\tGEN_CONF(1, 0, PHY_MODE_SATA, COMPHY_FW_MODE_SATA),\n\tGEN_CONF(1, 0, PHY_MODE_PCIE, COMPHY_FW_MODE_PCIE),\n\tETH_CONF(1, 2, PHY_INTERFACE_MODE_SGMII, 0x1, COMPHY_FW_MODE_SGMII),\n\tETH_CONF(1, 2, PHY_INTERFACE_MODE_2500BASEX, 0x1, COMPHY_FW_MODE_2500BASEX),\n\t \n\tETH_CONF(2, 0, PHY_INTERFACE_MODE_SGMII, 0x1, COMPHY_FW_MODE_SGMII),\n\tETH_CONF(2, 0, PHY_INTERFACE_MODE_2500BASEX, 0x1, COMPHY_FW_MODE_2500BASEX),\n\tETH_CONF(2, 0, PHY_INTERFACE_MODE_RXAUI, 0x1, COMPHY_FW_MODE_RXAUI),\n\tETH_CONF(2, 0, PHY_INTERFACE_MODE_5GBASER, 0x1, COMPHY_FW_MODE_XFI),\n\tETH_CONF(2, 0, PHY_INTERFACE_MODE_10GBASER, 0x1, COMPHY_FW_MODE_XFI),\n\tGEN_CONF(2, 0, PHY_MODE_USB_HOST_SS, COMPHY_FW_MODE_USB3H),\n\tGEN_CONF(2, 0, PHY_MODE_SATA, COMPHY_FW_MODE_SATA),\n\tGEN_CONF(2, 0, PHY_MODE_PCIE, COMPHY_FW_MODE_PCIE),\n\t \n\tGEN_CONF(3, 0, PHY_MODE_PCIE, COMPHY_FW_MODE_PCIE),\n\tETH_CONF(3, 1, PHY_INTERFACE_MODE_SGMII, 0x2, COMPHY_FW_MODE_SGMII),\n\tETH_CONF(3, 1, PHY_INTERFACE_MODE_2500BASEX, 0x2, COMPHY_FW_MODE_2500BASEX),\n\tETH_CONF(3, 1, PHY_INTERFACE_MODE_RXAUI, 0x1, COMPHY_FW_MODE_RXAUI),\n\tGEN_CONF(3, 1, PHY_MODE_USB_HOST_SS, COMPHY_FW_MODE_USB3H),\n\tGEN_CONF(3, 1, PHY_MODE_SATA, COMPHY_FW_MODE_SATA),\n\t \n\tETH_CONF(4, 0, PHY_INTERFACE_MODE_SGMII, 0x2, COMPHY_FW_MODE_SGMII),\n\tETH_CONF(4, 0, PHY_INTERFACE_MODE_2500BASEX, 0x2, COMPHY_FW_MODE_2500BASEX),\n\tETH_CONF(4, 0, PHY_INTERFACE_MODE_5GBASER, 0x2, COMPHY_FW_MODE_XFI),\n\tETH_CONF(4, 0, PHY_INTERFACE_MODE_10GBASER, 0x2, COMPHY_FW_MODE_XFI),\n\tETH_CONF(4, 0, PHY_INTERFACE_MODE_RXAUI, 0x2, COMPHY_FW_MODE_RXAUI),\n\tGEN_CONF(4, 0, PHY_MODE_USB_DEVICE_SS, COMPHY_FW_MODE_USB3D),\n\tGEN_CONF(4, 1, PHY_MODE_USB_HOST_SS, COMPHY_FW_MODE_USB3H),\n\tGEN_CONF(4, 1, PHY_MODE_PCIE, COMPHY_FW_MODE_PCIE),\n\tETH_CONF(4, 1, PHY_INTERFACE_MODE_SGMII, 0x1, COMPHY_FW_MODE_SGMII),\n\tETH_CONF(4, 1, PHY_INTERFACE_MODE_2500BASEX, -1, COMPHY_FW_MODE_2500BASEX),\n\tETH_CONF(4, 1, PHY_INTERFACE_MODE_5GBASER, -1, COMPHY_FW_MODE_XFI),\n\tETH_CONF(4, 1, PHY_INTERFACE_MODE_10GBASER, -1, COMPHY_FW_MODE_XFI),\n\t \n\tETH_CONF(5, 1, PHY_INTERFACE_MODE_RXAUI, 0x2, COMPHY_FW_MODE_RXAUI),\n\tGEN_CONF(5, 1, PHY_MODE_SATA, COMPHY_FW_MODE_SATA),\n\tETH_CONF(5, 2, PHY_INTERFACE_MODE_SGMII, 0x1, COMPHY_FW_MODE_SGMII),\n\tETH_CONF(5, 2, PHY_INTERFACE_MODE_2500BASEX, 0x1, COMPHY_FW_MODE_2500BASEX),\n\tGEN_CONF(5, 2, PHY_MODE_PCIE, COMPHY_FW_MODE_PCIE),\n};\n\nstruct mvebu_comphy_priv {\n\tvoid __iomem *base;\n\tstruct regmap *regmap;\n\tstruct device *dev;\n\tstruct clk *mg_domain_clk;\n\tstruct clk *mg_core_clk;\n\tstruct clk *axi_clk;\n\tunsigned long cp_phys;\n};\n\nstruct mvebu_comphy_lane {\n\tstruct mvebu_comphy_priv *priv;\n\tunsigned id;\n\tenum phy_mode mode;\n\tint submode;\n\tint port;\n};\n\nstatic int mvebu_comphy_smc(unsigned long function, unsigned long phys,\n\t\t\t    unsigned long lane, unsigned long mode)\n{\n\tstruct arm_smccc_res res;\n\ts32 ret;\n\n\tarm_smccc_smc(function, phys, lane, mode, 0, 0, 0, 0, &res);\n\tret = res.a0;\n\n\tswitch (ret) {\n\tcase SMCCC_RET_SUCCESS:\n\t\treturn 0;\n\tcase SMCCC_RET_NOT_SUPPORTED:\n\t\treturn -EOPNOTSUPP;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int mvebu_comphy_get_mode(bool fw_mode, int lane, int port,\n\t\t\t\t enum phy_mode mode, int submode)\n{\n\tint i, n = ARRAY_SIZE(mvebu_comphy_cp110_modes);\n\t \n\tbool ignore_submode = (mode == PHY_MODE_PCIE);\n\tconst struct mvebu_comphy_conf *conf;\n\n\t \n\tif (mode == PHY_MODE_INVALID)\n\t\treturn 0;\n\n\tfor (i = 0; i < n; i++) {\n\t\tconf = &mvebu_comphy_cp110_modes[i];\n\t\tif (conf->lane == lane &&\n\t\t    conf->port == port &&\n\t\t    conf->mode == mode &&\n\t\t    (conf->submode == submode || ignore_submode))\n\t\t\tbreak;\n\t}\n\n\tif (i == n)\n\t\treturn -EINVAL;\n\n\tif (fw_mode)\n\t\treturn conf->fw_mode;\n\telse\n\t\treturn conf->mux;\n}\n\nstatic inline int mvebu_comphy_get_mux(int lane, int port,\n\t\t\t\t       enum phy_mode mode, int submode)\n{\n\treturn mvebu_comphy_get_mode(false, lane, port, mode, submode);\n}\n\nstatic inline int mvebu_comphy_get_fw_mode(int lane, int port,\n\t\t\t\t\t   enum phy_mode mode, int submode)\n{\n\treturn mvebu_comphy_get_mode(true, lane, port, mode, submode);\n}\n\nstatic int mvebu_comphy_ethernet_init_reset(struct mvebu_comphy_lane *lane)\n{\n\tstruct mvebu_comphy_priv *priv = lane->priv;\n\tu32 val;\n\n\tregmap_read(priv->regmap, MVEBU_COMPHY_CONF1(lane->id), &val);\n\tval &= ~MVEBU_COMPHY_CONF1_USB_PCIE;\n\tval |= MVEBU_COMPHY_CONF1_PWRUP;\n\tregmap_write(priv->regmap, MVEBU_COMPHY_CONF1(lane->id), val);\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_SERDES_CFG0(lane->id));\n\tval &= ~(MVEBU_COMPHY_SERDES_CFG0_PU_PLL |\n\t\t MVEBU_COMPHY_SERDES_CFG0_PU_RX |\n\t\t MVEBU_COMPHY_SERDES_CFG0_PU_TX |\n\t\t MVEBU_COMPHY_SERDES_CFG0_HALF_BUS |\n\t\t MVEBU_COMPHY_SERDES_CFG0_GEN_RX(0xf) |\n\t\t MVEBU_COMPHY_SERDES_CFG0_GEN_TX(0xf) |\n\t\t MVEBU_COMPHY_SERDES_CFG0_RXAUI_MODE);\n\n\tswitch (lane->submode) {\n\tcase PHY_INTERFACE_MODE_10GBASER:\n\t\tval |= MVEBU_COMPHY_SERDES_CFG0_GEN_RX(0xe) |\n\t\t       MVEBU_COMPHY_SERDES_CFG0_GEN_TX(0xe);\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_RXAUI:\n\t\tval |= MVEBU_COMPHY_SERDES_CFG0_GEN_RX(0xb) |\n\t\t       MVEBU_COMPHY_SERDES_CFG0_GEN_TX(0xb) |\n\t\t       MVEBU_COMPHY_SERDES_CFG0_RXAUI_MODE;\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_2500BASEX:\n\t\tval |= MVEBU_COMPHY_SERDES_CFG0_GEN_RX(0x8) |\n\t\t       MVEBU_COMPHY_SERDES_CFG0_GEN_TX(0x8) |\n\t\t       MVEBU_COMPHY_SERDES_CFG0_HALF_BUS;\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_SGMII:\n\t\tval |= MVEBU_COMPHY_SERDES_CFG0_GEN_RX(0x6) |\n\t\t       MVEBU_COMPHY_SERDES_CFG0_GEN_TX(0x6) |\n\t\t       MVEBU_COMPHY_SERDES_CFG0_HALF_BUS;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(priv->dev,\n\t\t\t\"unsupported comphy submode (%d) on lane %d\\n\",\n\t\t\tlane->submode,\n\t\t\tlane->id);\n\t\treturn -ENOTSUPP;\n\t}\n\n\twritel(val, priv->base + MVEBU_COMPHY_SERDES_CFG0(lane->id));\n\n\tif (lane->submode == PHY_INTERFACE_MODE_RXAUI) {\n\t\tregmap_read(priv->regmap, MVEBU_COMPHY_SD1_CTRL1, &val);\n\n\t\tswitch (lane->id) {\n\t\tcase 2:\n\t\tcase 3:\n\t\t\tval |= MVEBU_COMPHY_SD1_CTRL1_RXAUI0_EN;\n\t\t\tbreak;\n\t\tcase 4:\n\t\tcase 5:\n\t\t\tval |= MVEBU_COMPHY_SD1_CTRL1_RXAUI1_EN;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(priv->dev,\n\t\t\t\t\"RXAUI is not supported on comphy lane %d\\n\",\n\t\t\t\tlane->id);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tregmap_write(priv->regmap, MVEBU_COMPHY_SD1_CTRL1, val);\n\t}\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\tval &= ~(MVEBU_COMPHY_SERDES_CFG1_RESET |\n\t\t MVEBU_COMPHY_SERDES_CFG1_CORE_RESET |\n\t\t MVEBU_COMPHY_SERDES_CFG1_RF_RESET);\n\twritel(val, priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\tval |= MVEBU_COMPHY_SERDES_CFG1_RESET |\n\t       MVEBU_COMPHY_SERDES_CFG1_CORE_RESET;\n\twritel(val, priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\n\t \n\tmdelay(1);\n\n\t \n\tregmap_read(priv->regmap, MVEBU_COMPHY_CONF6(lane->id), &val);\n\tval &= ~MVEBU_COMPHY_CONF6_40B;\n\tregmap_write(priv->regmap, MVEBU_COMPHY_CONF6(lane->id), val);\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_MISC_CTRL0(lane->id));\n\tval &= ~MVEBU_COMPHY_MISC_CTRL0_REFCLK_SEL;\n\tif (lane->submode == PHY_INTERFACE_MODE_10GBASER)\n\t\tval |= MVEBU_COMPHY_MISC_CTRL0_ICP_FORCE;\n\twritel(val, priv->base + MVEBU_COMPHY_MISC_CTRL0(lane->id));\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_PWRPLL_CTRL(lane->id));\n\tval &= ~(MVEBU_COMPHY_PWRPLL_CTRL_RFREQ(0x1f) |\n\t\t MVEBU_COMPHY_PWRPLL_PHY_MODE(0x7));\n\tval |= MVEBU_COMPHY_PWRPLL_CTRL_RFREQ(0x1) |\n\t       MVEBU_COMPHY_PWRPLL_PHY_MODE(0x4);\n\twritel(val, priv->base + MVEBU_COMPHY_PWRPLL_CTRL(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_LOOPBACK(lane->id));\n\tval &= ~MVEBU_COMPHY_LOOPBACK_DBUS_WIDTH(0x7);\n\tval |= MVEBU_COMPHY_LOOPBACK_DBUS_WIDTH(0x1);\n\twritel(val, priv->base + MVEBU_COMPHY_LOOPBACK(lane->id));\n\n\treturn 0;\n}\n\nstatic int mvebu_comphy_init_plls(struct mvebu_comphy_lane *lane)\n{\n\tstruct mvebu_comphy_priv *priv = lane->priv;\n\tu32 val;\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_SERDES_CFG0(lane->id));\n\tval |= MVEBU_COMPHY_SERDES_CFG0_PU_PLL |\n\t       MVEBU_COMPHY_SERDES_CFG0_PU_RX |\n\t       MVEBU_COMPHY_SERDES_CFG0_PU_TX;\n\twritel(val, priv->base + MVEBU_COMPHY_SERDES_CFG0(lane->id));\n\n\t \n\treadl_poll_timeout(priv->base + MVEBU_COMPHY_SERDES_STATUS0(lane->id),\n\t\t\t   val,\n\t\t\t   val & (MVEBU_COMPHY_SERDES_STATUS0_RX_PLL_RDY |\n\t\t\t\t  MVEBU_COMPHY_SERDES_STATUS0_TX_PLL_RDY),\n\t\t\t   1000, 150000);\n\tif (!(val & (MVEBU_COMPHY_SERDES_STATUS0_RX_PLL_RDY |\n\t\t     MVEBU_COMPHY_SERDES_STATUS0_TX_PLL_RDY)))\n\t\treturn -ETIMEDOUT;\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\tval |= MVEBU_COMPHY_SERDES_CFG1_RX_INIT;\n\twritel(val, priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\n\t \n\treadl_poll_timeout(priv->base + MVEBU_COMPHY_SERDES_STATUS0(lane->id),\n\t\t\t   val, val & MVEBU_COMPHY_SERDES_STATUS0_RX_INIT,\n\t\t\t   1000, 10000);\n\tif (!(val & MVEBU_COMPHY_SERDES_STATUS0_RX_INIT))\n\t\treturn -ETIMEDOUT;\n\n\tval = readl(priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\tval &= ~MVEBU_COMPHY_SERDES_CFG1_RX_INIT;\n\twritel(val, priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\n\treturn 0;\n}\n\nstatic int mvebu_comphy_set_mode_sgmii(struct phy *phy)\n{\n\tstruct mvebu_comphy_lane *lane = phy_get_drvdata(phy);\n\tstruct mvebu_comphy_priv *priv = lane->priv;\n\tu32 val;\n\tint err;\n\n\terr = mvebu_comphy_ethernet_init_reset(lane);\n\tif (err)\n\t\treturn err;\n\n\tval = readl(priv->base + MVEBU_COMPHY_RX_CTRL1(lane->id));\n\tval &= ~MVEBU_COMPHY_RX_CTRL1_CLK8T_EN;\n\tval |= MVEBU_COMPHY_RX_CTRL1_RXCLK2X_SEL;\n\twritel(val, priv->base + MVEBU_COMPHY_RX_CTRL1(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_DTL_CTRL(lane->id));\n\tval &= ~MVEBU_COMPHY_DTL_CTRL_DTL_FLOOP_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_DTL_CTRL(lane->id));\n\n\tregmap_read(priv->regmap, MVEBU_COMPHY_CONF1(lane->id), &val);\n\tval &= ~MVEBU_COMPHY_CONF1_USB_PCIE;\n\tval |= MVEBU_COMPHY_CONF1_PWRUP;\n\tregmap_write(priv->regmap, MVEBU_COMPHY_CONF1(lane->id), val);\n\n\tval = readl(priv->base + MVEBU_COMPHY_GEN1_S0(lane->id));\n\tval &= ~MVEBU_COMPHY_GEN1_S0_TX_EMPH(0xf);\n\tval |= MVEBU_COMPHY_GEN1_S0_TX_EMPH(0x1);\n\twritel(val, priv->base + MVEBU_COMPHY_GEN1_S0(lane->id));\n\n\treturn mvebu_comphy_init_plls(lane);\n}\n\nstatic int mvebu_comphy_set_mode_rxaui(struct phy *phy)\n{\n\tstruct mvebu_comphy_lane *lane = phy_get_drvdata(phy);\n\tstruct mvebu_comphy_priv *priv = lane->priv;\n\tu32 val;\n\tint err;\n\n\terr = mvebu_comphy_ethernet_init_reset(lane);\n\tif (err)\n\t\treturn err;\n\n\tval = readl(priv->base + MVEBU_COMPHY_RX_CTRL1(lane->id));\n\tval |= MVEBU_COMPHY_RX_CTRL1_RXCLK2X_SEL |\n\t       MVEBU_COMPHY_RX_CTRL1_CLK8T_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_RX_CTRL1(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_DTL_CTRL(lane->id));\n\tval |= MVEBU_COMPHY_DTL_CTRL_DTL_FLOOP_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_DTL_CTRL(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_SERDES_CFG2(lane->id));\n\tval |= MVEBU_COMPHY_SERDES_CFG2_DFE_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_SERDES_CFG2(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_DFE_RES(lane->id));\n\tval |= MVEBU_COMPHY_DFE_RES_FORCE_GEN_TBL;\n\twritel(val, priv->base + MVEBU_COMPHY_DFE_RES(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_GEN1_S0(lane->id));\n\tval &= ~MVEBU_COMPHY_GEN1_S0_TX_EMPH(0xf);\n\tval |= MVEBU_COMPHY_GEN1_S0_TX_EMPH(0xd);\n\twritel(val, priv->base + MVEBU_COMPHY_GEN1_S0(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_GEN1_S1(lane->id));\n\tval &= ~(MVEBU_COMPHY_GEN1_S1_RX_MUL_PI(0x7) |\n\t\t MVEBU_COMPHY_GEN1_S1_RX_MUL_PF(0x7));\n\tval |= MVEBU_COMPHY_GEN1_S1_RX_MUL_PI(0x1) |\n\t       MVEBU_COMPHY_GEN1_S1_RX_MUL_PF(0x1) |\n\t       MVEBU_COMPHY_GEN1_S1_RX_DFE_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_GEN1_S1(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_COEF(lane->id));\n\tval &= ~(MVEBU_COMPHY_COEF_DFE_EN | MVEBU_COMPHY_COEF_DFE_CTRL);\n\twritel(val, priv->base + MVEBU_COMPHY_COEF(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_GEN1_S4(lane->id));\n\tval &= ~MVEBU_COMPHY_GEN1_S4_DFE_RES(0x3);\n\tval |= MVEBU_COMPHY_GEN1_S4_DFE_RES(0x1);\n\twritel(val, priv->base + MVEBU_COMPHY_GEN1_S4(lane->id));\n\n\treturn mvebu_comphy_init_plls(lane);\n}\n\nstatic int mvebu_comphy_set_mode_10gbaser(struct phy *phy)\n{\n\tstruct mvebu_comphy_lane *lane = phy_get_drvdata(phy);\n\tstruct mvebu_comphy_priv *priv = lane->priv;\n\tu32 val;\n\tint err;\n\n\terr = mvebu_comphy_ethernet_init_reset(lane);\n\tif (err)\n\t\treturn err;\n\n\tval = readl(priv->base + MVEBU_COMPHY_RX_CTRL1(lane->id));\n\tval |= MVEBU_COMPHY_RX_CTRL1_RXCLK2X_SEL |\n\t       MVEBU_COMPHY_RX_CTRL1_CLK8T_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_RX_CTRL1(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_DTL_CTRL(lane->id));\n\tval |= MVEBU_COMPHY_DTL_CTRL_DTL_FLOOP_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_DTL_CTRL(lane->id));\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_SPEED_DIV(lane->id));\n\tval |= MVEBU_COMPHY_SPEED_DIV_TX_FORCE;\n\twritel(val, priv->base + MVEBU_COMPHY_SPEED_DIV(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_SERDES_CFG2(lane->id));\n\tval |= MVEBU_COMPHY_SERDES_CFG2_DFE_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_SERDES_CFG2(lane->id));\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_DFE_RES(lane->id));\n\tval |= MVEBU_COMPHY_DFE_RES_FORCE_GEN_TBL;\n\twritel(val, priv->base + MVEBU_COMPHY_DFE_RES(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_GEN1_S0(lane->id));\n\tval &= ~(MVEBU_COMPHY_GEN1_S0_TX_AMP(0x1f) |\n\t\t MVEBU_COMPHY_GEN1_S0_TX_EMPH(0xf));\n\tval |= MVEBU_COMPHY_GEN1_S0_TX_AMP(0x1c) |\n\t       MVEBU_COMPHY_GEN1_S0_TX_EMPH(0xe);\n\twritel(val, priv->base + MVEBU_COMPHY_GEN1_S0(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_GEN1_S2(lane->id));\n\tval &= ~MVEBU_COMPHY_GEN1_S2_TX_EMPH(0xf);\n\tval |= MVEBU_COMPHY_GEN1_S2_TX_EMPH_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_GEN1_S2(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_TX_SLEW_RATE(lane->id));\n\tval |= MVEBU_COMPHY_TX_SLEW_RATE_EMPH(0x3) |\n\t       MVEBU_COMPHY_TX_SLEW_RATE_SLC(0x3f);\n\twritel(val, priv->base + MVEBU_COMPHY_TX_SLEW_RATE(lane->id));\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_IMP_CAL(lane->id));\n\tval &= ~MVEBU_COMPHY_IMP_CAL_TX_EXT(0x1f);\n\tval |= MVEBU_COMPHY_IMP_CAL_TX_EXT(0xe) |\n\t       MVEBU_COMPHY_IMP_CAL_TX_EXT_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_IMP_CAL(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_GEN1_S5(lane->id));\n\tval &= ~MVEBU_COMPHY_GEN1_S5_ICP(0xf);\n\twritel(val, priv->base + MVEBU_COMPHY_GEN1_S5(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_GEN1_S1(lane->id));\n\tval &= ~(MVEBU_COMPHY_GEN1_S1_RX_MUL_PI(0x7) |\n\t\t MVEBU_COMPHY_GEN1_S1_RX_MUL_PF(0x7) |\n\t\t MVEBU_COMPHY_GEN1_S1_RX_MUL_FI(0x3) |\n\t\t MVEBU_COMPHY_GEN1_S1_RX_MUL_FF(0x3));\n\tval |= MVEBU_COMPHY_GEN1_S1_RX_DFE_EN |\n\t       MVEBU_COMPHY_GEN1_S1_RX_MUL_PI(0x2) |\n\t       MVEBU_COMPHY_GEN1_S1_RX_MUL_PF(0x2) |\n\t       MVEBU_COMPHY_GEN1_S1_RX_MUL_FF(0x1) |\n\t       MVEBU_COMPHY_GEN1_S1_RX_DIV(0x3);\n\twritel(val, priv->base + MVEBU_COMPHY_GEN1_S1(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_COEF(lane->id));\n\tval &= ~(MVEBU_COMPHY_COEF_DFE_EN | MVEBU_COMPHY_COEF_DFE_CTRL);\n\twritel(val, priv->base + MVEBU_COMPHY_COEF(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_GEN1_S4(lane->id));\n\tval &= ~MVEBU_COMPHY_GEN1_S4_DFE_RES(0x3);\n\tval |= MVEBU_COMPHY_GEN1_S4_DFE_RES(0x1);\n\twritel(val, priv->base + MVEBU_COMPHY_GEN1_S4(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_GEN1_S3(lane->id));\n\tval |= MVEBU_COMPHY_GEN1_S3_FBCK_SEL;\n\twritel(val, priv->base + MVEBU_COMPHY_GEN1_S3(lane->id));\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_TRAINING5(lane->id));\n\tval &= ~MVEBU_COMPHY_TRAINING5_RX_TIMER(0x3ff);\n\tval |= MVEBU_COMPHY_TRAINING5_RX_TIMER(0x13);\n\twritel(val, priv->base + MVEBU_COMPHY_TRAINING5(lane->id));\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_TRAINING0(lane->id));\n\tval |= MVEBU_COMPHY_TRAINING0_P2P_HOLD;\n\twritel(val, priv->base + MVEBU_COMPHY_TRAINING0(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_TX_PRESET(lane->id));\n\tval &= ~MVEBU_COMPHY_TX_PRESET_INDEX(0xf);\n\tval |= MVEBU_COMPHY_TX_PRESET_INDEX(0x2);\t \n\twritel(val, priv->base + MVEBU_COMPHY_TX_PRESET(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_FRAME_DETECT3(lane->id));\n\tval &= ~MVEBU_COMPHY_FRAME_DETECT3_LOST_TIMEOUT_EN;\n\twritel(val, priv->base + MVEBU_COMPHY_FRAME_DETECT3(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_TX_TRAIN_PRESET(lane->id));\n\tval |= MVEBU_COMPHY_TX_TRAIN_PRESET_16B_AUTO_EN |\n\t       MVEBU_COMPHY_TX_TRAIN_PRESET_PRBS11;\n\twritel(val, priv->base + MVEBU_COMPHY_TX_TRAIN_PRESET(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_FRAME_DETECT0(lane->id));\n\tval &= ~MVEBU_COMPHY_FRAME_DETECT0_PATN(0x1ff);\n\tval |= MVEBU_COMPHY_FRAME_DETECT0_PATN(0x88);\n\twritel(val, priv->base + MVEBU_COMPHY_FRAME_DETECT0(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_DME(lane->id));\n\tval |= MVEBU_COMPHY_DME_ETH_MODE;\n\twritel(val, priv->base + MVEBU_COMPHY_DME(lane->id));\n\n\tval = readl(priv->base + MVEBU_COMPHY_VDD_CAL0(lane->id));\n\tval |= MVEBU_COMPHY_VDD_CAL0_CONT_MODE;\n\twritel(val, priv->base + MVEBU_COMPHY_VDD_CAL0(lane->id));\n\n\tval = readl(priv->base + MVEBU_SP_CALIB(lane->id));\n\tval &= ~MVEBU_SP_CALIB_SAMPLER(0x3);\n\tval |= MVEBU_SP_CALIB_SAMPLER(0x3) |\n\t       MVEBU_SP_CALIB_SAMPLER_EN;\n\twritel(val, priv->base + MVEBU_SP_CALIB(lane->id));\n\tval &= ~MVEBU_SP_CALIB_SAMPLER_EN;\n\twritel(val, priv->base + MVEBU_SP_CALIB(lane->id));\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_EXT_SELV(lane->id));\n\tval &= ~MVEBU_COMPHY_EXT_SELV_RX_SAMPL(0x1f);\n\tval |= MVEBU_COMPHY_EXT_SELV_RX_SAMPL(0x1a);\n\twritel(val, priv->base + MVEBU_COMPHY_EXT_SELV(lane->id));\n\n\treturn mvebu_comphy_init_plls(lane);\n}\n\nstatic int mvebu_comphy_power_on_legacy(struct phy *phy)\n{\n\tstruct mvebu_comphy_lane *lane = phy_get_drvdata(phy);\n\tstruct mvebu_comphy_priv *priv = lane->priv;\n\tint ret, mux;\n\tu32 val;\n\n\tmux = mvebu_comphy_get_mux(lane->id, lane->port,\n\t\t\t\t   lane->mode, lane->submode);\n\tif (mux < 0)\n\t\treturn -ENOTSUPP;\n\n\tregmap_read(priv->regmap, MVEBU_COMPHY_PIPE_SELECTOR, &val);\n\tval &= ~(0xf << MVEBU_COMPHY_PIPE_SELECTOR_PIPE(lane->id));\n\tregmap_write(priv->regmap, MVEBU_COMPHY_PIPE_SELECTOR, val);\n\n\tregmap_read(priv->regmap, MVEBU_COMPHY_SELECTOR, &val);\n\tval &= ~(0xf << MVEBU_COMPHY_SELECTOR_PHY(lane->id));\n\tval |= mux << MVEBU_COMPHY_SELECTOR_PHY(lane->id);\n\tregmap_write(priv->regmap, MVEBU_COMPHY_SELECTOR, val);\n\n\tswitch (lane->submode) {\n\tcase PHY_INTERFACE_MODE_SGMII:\n\tcase PHY_INTERFACE_MODE_2500BASEX:\n\t\tret = mvebu_comphy_set_mode_sgmii(phy);\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_RXAUI:\n\t\tret = mvebu_comphy_set_mode_rxaui(phy);\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_10GBASER:\n\t\tret = mvebu_comphy_set_mode_10gbaser(phy);\n\t\tbreak;\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n\n\t \n\tval = readl(priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\tval |= MVEBU_COMPHY_SERDES_CFG1_RF_RESET;\n\twritel(val, priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\n\treturn ret;\n}\n\nstatic int mvebu_comphy_power_on(struct phy *phy)\n{\n\tstruct mvebu_comphy_lane *lane = phy_get_drvdata(phy);\n\tstruct mvebu_comphy_priv *priv = lane->priv;\n\tint fw_mode, fw_speed;\n\tu32 fw_param = 0;\n\tint ret;\n\n\tfw_mode = mvebu_comphy_get_fw_mode(lane->id, lane->port,\n\t\t\t\t\t   lane->mode, lane->submode);\n\tif (fw_mode < 0)\n\t\tgoto try_legacy;\n\n\t \n\tswitch (lane->mode) {\n\tcase PHY_MODE_ETHERNET:\n\t\tswitch (lane->submode) {\n\t\tcase PHY_INTERFACE_MODE_RXAUI:\n\t\t\tdev_dbg(priv->dev, \"set lane %d to RXAUI mode\\n\",\n\t\t\t\tlane->id);\n\t\t\tfw_speed = 0;\n\t\t\tbreak;\n\t\tcase PHY_INTERFACE_MODE_SGMII:\n\t\t\tdev_dbg(priv->dev, \"set lane %d to 1000BASE-X mode\\n\",\n\t\t\t\tlane->id);\n\t\t\tfw_speed = COMPHY_FW_SPEED_1250;\n\t\t\tbreak;\n\t\tcase PHY_INTERFACE_MODE_2500BASEX:\n\t\t\tdev_dbg(priv->dev, \"set lane %d to 2500BASE-X mode\\n\",\n\t\t\t\tlane->id);\n\t\t\tfw_speed = COMPHY_FW_SPEED_3125;\n\t\t\tbreak;\n\t\tcase PHY_INTERFACE_MODE_5GBASER:\n\t\t\tdev_dbg(priv->dev, \"set lane %d to 5GBASE-R mode\\n\",\n\t\t\t\tlane->id);\n\t\t\tfw_speed = COMPHY_FW_SPEED_515625;\n\t\t\tbreak;\n\t\tcase PHY_INTERFACE_MODE_10GBASER:\n\t\t\tdev_dbg(priv->dev, \"set lane %d to 10GBASE-R mode\\n\",\n\t\t\t\tlane->id);\n\t\t\tfw_speed = COMPHY_FW_SPEED_103125;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(priv->dev, \"unsupported Ethernet mode (%d)\\n\",\n\t\t\t\tlane->submode);\n\t\t\treturn -ENOTSUPP;\n\t\t}\n\t\tfw_param = COMPHY_FW_PARAM_ETH(fw_mode, lane->port, fw_speed);\n\t\tbreak;\n\tcase PHY_MODE_USB_HOST_SS:\n\tcase PHY_MODE_USB_DEVICE_SS:\n\t\tdev_dbg(priv->dev, \"set lane %d to USB3 mode\\n\", lane->id);\n\t\tfw_param = COMPHY_FW_PARAM(fw_mode, lane->port);\n\t\tbreak;\n\tcase PHY_MODE_SATA:\n\t\tdev_dbg(priv->dev, \"set lane %d to SATA mode\\n\", lane->id);\n\t\tfw_param = COMPHY_FW_PARAM(fw_mode, lane->port);\n\t\tbreak;\n\tcase PHY_MODE_PCIE:\n\t\tdev_dbg(priv->dev, \"set lane %d to PCIe mode (x%d)\\n\", lane->id,\n\t\t\tlane->submode);\n\t\tfw_param = COMPHY_FW_PARAM_PCIE(fw_mode, lane->port,\n\t\t\t\t\t\tlane->submode);\n\t\tbreak;\n\tdefault:\n\t\tdev_err(priv->dev, \"unsupported PHY mode (%d)\\n\", lane->mode);\n\t\treturn -ENOTSUPP;\n\t}\n\n\tret = mvebu_comphy_smc(COMPHY_SIP_POWER_ON, priv->cp_phys, lane->id,\n\t\t\t       fw_param);\n\tif (!ret)\n\t\treturn ret;\n\n\tif (ret == -EOPNOTSUPP)\n\t\tdev_err(priv->dev,\n\t\t\t\"unsupported SMC call, try updating your firmware\\n\");\n\n\tdev_warn(priv->dev,\n\t\t \"Firmware could not configure PHY %d with mode %d (ret: %d), trying legacy method\\n\",\n\t\t lane->id, lane->mode, ret);\n\ntry_legacy:\n\t \n\treturn mvebu_comphy_power_on_legacy(phy);\n}\n\nstatic int mvebu_comphy_set_mode(struct phy *phy,\n\t\t\t\t enum phy_mode mode, int submode)\n{\n\tstruct mvebu_comphy_lane *lane = phy_get_drvdata(phy);\n\n\tif (submode == PHY_INTERFACE_MODE_1000BASEX)\n\t\tsubmode = PHY_INTERFACE_MODE_SGMII;\n\n\tif (mvebu_comphy_get_fw_mode(lane->id, lane->port, mode, submode) < 0)\n\t\treturn -EINVAL;\n\n\tlane->mode = mode;\n\tlane->submode = submode;\n\n\t \n\tif (mode == PHY_MODE_PCIE && !lane->submode)\n\t\tlane->submode = 1;\n\n\treturn 0;\n}\n\nstatic int mvebu_comphy_power_off_legacy(struct phy *phy)\n{\n\tstruct mvebu_comphy_lane *lane = phy_get_drvdata(phy);\n\tstruct mvebu_comphy_priv *priv = lane->priv;\n\tu32 val;\n\n\tval = readl(priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\tval &= ~(MVEBU_COMPHY_SERDES_CFG1_RESET |\n\t\t MVEBU_COMPHY_SERDES_CFG1_CORE_RESET |\n\t\t MVEBU_COMPHY_SERDES_CFG1_RF_RESET);\n\twritel(val, priv->base + MVEBU_COMPHY_SERDES_CFG1(lane->id));\n\n\tregmap_read(priv->regmap, MVEBU_COMPHY_SELECTOR, &val);\n\tval &= ~(0xf << MVEBU_COMPHY_SELECTOR_PHY(lane->id));\n\tregmap_write(priv->regmap, MVEBU_COMPHY_SELECTOR, val);\n\n\tregmap_read(priv->regmap, MVEBU_COMPHY_PIPE_SELECTOR, &val);\n\tval &= ~(0xf << MVEBU_COMPHY_PIPE_SELECTOR_PIPE(lane->id));\n\tregmap_write(priv->regmap, MVEBU_COMPHY_PIPE_SELECTOR, val);\n\n\treturn 0;\n}\n\nstatic int mvebu_comphy_power_off(struct phy *phy)\n{\n\tstruct mvebu_comphy_lane *lane = phy_get_drvdata(phy);\n\tstruct mvebu_comphy_priv *priv = lane->priv;\n\tint ret;\n\n\tret = mvebu_comphy_smc(COMPHY_SIP_POWER_OFF, priv->cp_phys,\n\t\t\t       lane->id, 0);\n\tif (!ret)\n\t\treturn ret;\n\n\t \n\treturn mvebu_comphy_power_off_legacy(phy);\n}\n\nstatic const struct phy_ops mvebu_comphy_ops = {\n\t.power_on\t= mvebu_comphy_power_on,\n\t.power_off\t= mvebu_comphy_power_off,\n\t.set_mode\t= mvebu_comphy_set_mode,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic struct phy *mvebu_comphy_xlate(struct device *dev,\n\t\t\t\t      struct of_phandle_args *args)\n{\n\tstruct mvebu_comphy_lane *lane;\n\tstruct phy *phy;\n\n\tif (WARN_ON(args->args[0] >= MVEBU_COMPHY_PORTS))\n\t\treturn ERR_PTR(-EINVAL);\n\n\tphy = of_phy_simple_xlate(dev, args);\n\tif (IS_ERR(phy))\n\t\treturn phy;\n\n\tlane = phy_get_drvdata(phy);\n\tlane->port = args->args[0];\n\n\treturn phy;\n}\n\nstatic int mvebu_comphy_init_clks(struct mvebu_comphy_priv *priv)\n{\n\tint ret;\n\n\tpriv->mg_domain_clk = devm_clk_get(priv->dev, \"mg_clk\");\n\tif (IS_ERR(priv->mg_domain_clk))\n\t\treturn PTR_ERR(priv->mg_domain_clk);\n\n\tret = clk_prepare_enable(priv->mg_domain_clk);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tpriv->mg_core_clk = devm_clk_get(priv->dev, \"mg_core_clk\");\n\tif (IS_ERR(priv->mg_core_clk)) {\n\t\tret = PTR_ERR(priv->mg_core_clk);\n\t\tgoto dis_mg_domain_clk;\n\t}\n\n\tret = clk_prepare_enable(priv->mg_core_clk);\n\tif (ret < 0)\n\t\tgoto dis_mg_domain_clk;\n\n\tpriv->axi_clk = devm_clk_get(priv->dev, \"axi_clk\");\n\tif (IS_ERR(priv->axi_clk)) {\n\t\tret = PTR_ERR(priv->axi_clk);\n\t\tgoto dis_mg_core_clk;\n\t}\n\n\tret = clk_prepare_enable(priv->axi_clk);\n\tif (ret < 0)\n\t\tgoto dis_mg_core_clk;\n\n\treturn 0;\n\ndis_mg_core_clk:\n\tclk_disable_unprepare(priv->mg_core_clk);\n\ndis_mg_domain_clk:\n\tclk_disable_unprepare(priv->mg_domain_clk);\n\n\tpriv->mg_domain_clk = NULL;\n\tpriv->mg_core_clk = NULL;\n\tpriv->axi_clk = NULL;\n\n\treturn ret;\n};\n\nstatic void mvebu_comphy_disable_unprepare_clks(struct mvebu_comphy_priv *priv)\n{\n\tif (priv->axi_clk)\n\t\tclk_disable_unprepare(priv->axi_clk);\n\n\tif (priv->mg_core_clk)\n\t\tclk_disable_unprepare(priv->mg_core_clk);\n\n\tif (priv->mg_domain_clk)\n\t\tclk_disable_unprepare(priv->mg_domain_clk);\n}\n\nstatic int mvebu_comphy_probe(struct platform_device *pdev)\n{\n\tstruct mvebu_comphy_priv *priv;\n\tstruct phy_provider *provider;\n\tstruct device_node *child;\n\tstruct resource *res;\n\tint ret;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = &pdev->dev;\n\tpriv->regmap =\n\t\tsyscon_regmap_lookup_by_phandle(pdev->dev.of_node,\n\t\t\t\t\t\t\"marvell,system-controller\");\n\tif (IS_ERR(priv->regmap))\n\t\treturn PTR_ERR(priv->regmap);\n\tpriv->base = devm_platform_get_and_ioremap_resource(pdev, 0, &res);\n\tif (IS_ERR(priv->base))\n\t\treturn PTR_ERR(priv->base);\n\n\t \n\tret = mvebu_comphy_init_clks(priv);\n\tif (ret) {\n\t\tif (ret == -EPROBE_DEFER)\n\t\t\treturn ret;\n\t\tdev_warn(&pdev->dev, \"cannot initialize clocks\\n\");\n\t}\n\n\t \n\tpriv->cp_phys = res->start;\n\n\tfor_each_available_child_of_node(pdev->dev.of_node, child) {\n\t\tstruct mvebu_comphy_lane *lane;\n\t\tstruct phy *phy;\n\t\tu32 val;\n\n\t\tret = of_property_read_u32(child, \"reg\", &val);\n\t\tif (ret < 0) {\n\t\t\tdev_err(&pdev->dev, \"missing 'reg' property (%d)\\n\",\n\t\t\t\tret);\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (val >= MVEBU_COMPHY_LANES) {\n\t\t\tdev_err(&pdev->dev, \"invalid 'reg' property\\n\");\n\t\t\tcontinue;\n\t\t}\n\n\t\tlane = devm_kzalloc(&pdev->dev, sizeof(*lane), GFP_KERNEL);\n\t\tif (!lane) {\n\t\t\tof_node_put(child);\n\t\t\tret = -ENOMEM;\n\t\t\tgoto disable_clks;\n\t\t}\n\n\t\tphy = devm_phy_create(&pdev->dev, child, &mvebu_comphy_ops);\n\t\tif (IS_ERR(phy)) {\n\t\t\tof_node_put(child);\n\t\t\tret = PTR_ERR(phy);\n\t\t\tgoto disable_clks;\n\t\t}\n\n\t\tlane->priv = priv;\n\t\tlane->mode = PHY_MODE_INVALID;\n\t\tlane->submode = PHY_INTERFACE_MODE_NA;\n\t\tlane->id = val;\n\t\tlane->port = -1;\n\t\tphy_set_drvdata(phy, lane);\n\n\t\t \n\t}\n\n\tdev_set_drvdata(&pdev->dev, priv);\n\tprovider = devm_of_phy_provider_register(&pdev->dev,\n\t\t\t\t\t\t mvebu_comphy_xlate);\n\n\treturn PTR_ERR_OR_ZERO(provider);\n\ndisable_clks:\n\tmvebu_comphy_disable_unprepare_clks(priv);\n\n\treturn ret;\n}\n\nstatic const struct of_device_id mvebu_comphy_of_match_table[] = {\n\t{ .compatible = \"marvell,comphy-cp110\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, mvebu_comphy_of_match_table);\n\nstatic struct platform_driver mvebu_comphy_driver = {\n\t.probe\t= mvebu_comphy_probe,\n\t.driver\t= {\n\t\t.name = \"mvebu-comphy\",\n\t\t.of_match_table = mvebu_comphy_of_match_table,\n\t},\n};\nmodule_platform_driver(mvebu_comphy_driver);\n\nMODULE_AUTHOR(\"Antoine Tenart <antoine.tenart@free-electrons.com>\");\nMODULE_DESCRIPTION(\"Common PHY driver for mvebu SoCs\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}