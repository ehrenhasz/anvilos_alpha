{
  "module_name": "phy-mvebu-sata.c",
  "hash_id": "f3bdd5e7a68e1e94686aea682002c3eac498861467b7d8a4086829c814964708",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/marvell/phy-mvebu-sata.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/init.h>\n#include <linux/clk.h>\n#include <linux/phy/phy.h>\n#include <linux/io.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n\nstruct priv {\n\tstruct clk\t*clk;\n\tvoid __iomem\t*base;\n};\n\n#define SATA_PHY_MODE_2\t0x0330\n#define  MODE_2_FORCE_PU_TX\tBIT(0)\n#define  MODE_2_FORCE_PU_RX\tBIT(1)\n#define  MODE_2_PU_PLL\t\tBIT(2)\n#define  MODE_2_PU_IVREF\tBIT(3)\n#define SATA_IF_CTRL\t0x0050\n#define  CTRL_PHY_SHUTDOWN\tBIT(9)\n\nstatic int phy_mvebu_sata_power_on(struct phy *phy)\n{\n\tstruct priv *priv = phy_get_drvdata(phy);\n\tu32 reg;\n\n\tclk_prepare_enable(priv->clk);\n\n\t \n\treg = readl(priv->base + SATA_PHY_MODE_2);\n\treg |= (MODE_2_FORCE_PU_TX | MODE_2_FORCE_PU_RX |\n\t\tMODE_2_PU_PLL | MODE_2_PU_IVREF);\n\twritel(reg , priv->base + SATA_PHY_MODE_2);\n\n\t \n\treg = readl(priv->base + SATA_IF_CTRL);\n\treg &= ~CTRL_PHY_SHUTDOWN;\n\twritel(reg, priv->base + SATA_IF_CTRL);\n\n\tclk_disable_unprepare(priv->clk);\n\n\treturn 0;\n}\n\nstatic int phy_mvebu_sata_power_off(struct phy *phy)\n{\n\tstruct priv *priv = phy_get_drvdata(phy);\n\tu32 reg;\n\n\tclk_prepare_enable(priv->clk);\n\n\t \n\treg = readl(priv->base + SATA_PHY_MODE_2);\n\treg &= ~(MODE_2_FORCE_PU_TX | MODE_2_FORCE_PU_RX |\n\t\t MODE_2_PU_PLL | MODE_2_PU_IVREF);\n\twritel(reg, priv->base + SATA_PHY_MODE_2);\n\n\t \n\treg = readl(priv->base + SATA_IF_CTRL);\n\treg |= CTRL_PHY_SHUTDOWN;\n\twritel(reg, priv->base + SATA_IF_CTRL);\n\n\tclk_disable_unprepare(priv->clk);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops phy_mvebu_sata_ops = {\n\t.power_on\t= phy_mvebu_sata_power_on,\n\t.power_off\t= phy_mvebu_sata_power_off,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int phy_mvebu_sata_probe(struct platform_device *pdev)\n{\n\tstruct phy_provider *phy_provider;\n\tstruct priv *priv;\n\tstruct phy *phy;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(priv->base))\n\t\treturn PTR_ERR(priv->base);\n\n\tpriv->clk = devm_clk_get(&pdev->dev, \"sata\");\n\tif (IS_ERR(priv->clk))\n\t\treturn PTR_ERR(priv->clk);\n\n\tphy = devm_phy_create(&pdev->dev, NULL, &phy_mvebu_sata_ops);\n\tif (IS_ERR(phy))\n\t\treturn PTR_ERR(phy);\n\n\tphy_set_drvdata(phy, priv);\n\n\tphy_provider = devm_of_phy_provider_register(&pdev->dev,\n\t\t\t\t\t\t     of_phy_simple_xlate);\n\tif (IS_ERR(phy_provider))\n\t\treturn PTR_ERR(phy_provider);\n\n\t \n\tphy_mvebu_sata_power_off(phy);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id phy_mvebu_sata_of_match[] = {\n\t{ .compatible = \"marvell,mvebu-sata-phy\" },\n\t{ },\n};\n\nstatic struct platform_driver phy_mvebu_sata_driver = {\n\t.probe\t= phy_mvebu_sata_probe,\n\t.driver = {\n\t\t.name\t= \"phy-mvebu-sata\",\n\t\t.of_match_table\t= phy_mvebu_sata_of_match,\n\t}\n};\nbuiltin_platform_driver(phy_mvebu_sata_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}