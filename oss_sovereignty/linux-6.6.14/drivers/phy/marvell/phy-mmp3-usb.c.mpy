{
  "module_name": "phy-mmp3-usb.c",
  "hash_id": "3e2bff3c3346d43d12f2faf2d9318819616f68c7a4f03474f480c24f2b1bef54",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/marvell/phy-mmp3-usb.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/soc/mmp/cputype.h>\n\n#define USB2_PLL_REG0\t\t0x4\n#define USB2_PLL_REG1\t\t0x8\n#define USB2_TX_REG0\t\t0x10\n#define USB2_TX_REG1\t\t0x14\n#define USB2_TX_REG2\t\t0x18\n#define USB2_RX_REG0\t\t0x20\n#define USB2_RX_REG1\t\t0x24\n#define USB2_RX_REG2\t\t0x28\n#define USB2_ANA_REG0\t\t0x30\n#define USB2_ANA_REG1\t\t0x34\n#define USB2_ANA_REG2\t\t0x38\n#define USB2_DIG_REG0\t\t0x3C\n#define USB2_DIG_REG1\t\t0x40\n#define USB2_DIG_REG2\t\t0x44\n#define USB2_DIG_REG3\t\t0x48\n#define USB2_TEST_REG0\t\t0x4C\n#define USB2_TEST_REG1\t\t0x50\n#define USB2_TEST_REG2\t\t0x54\n#define USB2_CHARGER_REG0\t0x58\n#define USB2_OTG_REG0\t\t0x5C\n#define USB2_PHY_MON0\t\t0x60\n#define USB2_RESETVE_REG0\t0x64\n#define USB2_ICID_REG0\t\t0x78\n#define USB2_ICID_REG1\t\t0x7C\n\n \n\n \n#define USB2_PLL_FBDIV_SHIFT_MMP3\t\t0\n#define USB2_PLL_FBDIV_MASK_MMP3\t\t(0xFF << 0)\n\n#define USB2_PLL_REFDIV_SHIFT_MMP3\t\t8\n#define USB2_PLL_REFDIV_MASK_MMP3\t\t(0xF << 8)\n\n#define USB2_PLL_VDD12_SHIFT_MMP3\t\t12\n#define USB2_PLL_VDD18_SHIFT_MMP3\t\t14\n\n \n#define USB2_PLL_FBDIV_SHIFT_MMP3_B0\t\t0\n#define USB2_PLL_REFDIV_SHIFT_MMP3_B0\t\t9\n#define USB2_PLL_VDD18_SHIFT_MMP3_B0\t\t14\n#define USB2_PLL_FBDIV_MASK_MMP3_B0\t\t0x01FF\n#define USB2_PLL_REFDIV_MASK_MMP3_B0\t\t0x3E00\n\n#define USB2_PLL_CAL12_SHIFT_MMP3\t\t0\n#define USB2_PLL_CALI12_MASK_MMP3\t\t(0x3 << 0)\n\n#define USB2_PLL_VCOCAL_START_SHIFT_MMP3\t2\n\n#define USB2_PLL_KVCO_SHIFT_MMP3\t\t4\n#define USB2_PLL_KVCO_MASK_MMP3\t\t\t(0x7<<4)\n\n#define USB2_PLL_ICP_SHIFT_MMP3\t\t\t8\n#define USB2_PLL_ICP_MASK_MMP3\t\t\t(0x7<<8)\n\n#define USB2_PLL_LOCK_BYPASS_SHIFT_MMP3\t\t12\n\n#define USB2_PLL_PU_PLL_SHIFT_MMP3\t\t13\n#define USB2_PLL_PU_PLL_MASK\t\t\t(0x1 << 13)\n\n#define USB2_PLL_READY_MASK_MMP3\t\t(0x1 << 15)\n\n \n#define USB2_TX_IMPCAL_VTH_SHIFT_MMP3\t\t8\n#define USB2_TX_IMPCAL_VTH_MASK_MMP3\t\t(0x7 << 8)\n\n#define USB2_TX_RCAL_START_SHIFT_MMP3\t\t13\n\n \n#define USB2_TX_CK60_PHSEL_SHIFT_MMP3\t\t0\n#define USB2_TX_CK60_PHSEL_MASK_MMP3\t\t(0xf << 0)\n\n#define USB2_TX_AMP_SHIFT_MMP3\t\t\t4\n#define USB2_TX_AMP_MASK_MMP3\t\t\t(0x7 << 4)\n\n#define USB2_TX_VDD12_SHIFT_MMP3\t\t8\n#define USB2_TX_VDD12_MASK_MMP3\t\t\t(0x3 << 8)\n\n \n#define USB2_TX_DRV_SLEWRATE_SHIFT\t\t10\n\n \n#define USB2_RX_SQ_THRESH_SHIFT_MMP3\t\t4\n#define USB2_RX_SQ_THRESH_MASK_MMP3\t\t(0xf << 4)\n\n#define USB2_RX_SQ_LENGTH_SHIFT_MMP3\t\t10\n#define USB2_RX_SQ_LENGTH_MASK_MMP3\t\t(0x3 << 10)\n\n \n#define USB2_ANA_PU_ANA_SHIFT_MMP3\t\t14\n\n \n#define USB2_OTG_PU_OTG_SHIFT_MMP3\t\t3\n\nstruct mmp3_usb_phy {\n\tstruct phy *phy;\n\tvoid __iomem *base;\n};\n\nstatic unsigned int u2o_get(void __iomem *base, unsigned int offset)\n{\n\treturn readl_relaxed(base + offset);\n}\n\nstatic void u2o_set(void __iomem *base, unsigned int offset,\n\t\tunsigned int value)\n{\n\tu32 reg;\n\n\treg = readl_relaxed(base + offset);\n\treg |= value;\n\twritel_relaxed(reg, base + offset);\n\treadl_relaxed(base + offset);\n}\n\nstatic void u2o_clear(void __iomem *base, unsigned int offset,\n\t\tunsigned int value)\n{\n\tu32 reg;\n\n\treg = readl_relaxed(base + offset);\n\treg &= ~value;\n\twritel_relaxed(reg, base + offset);\n\treadl_relaxed(base + offset);\n}\n\nstatic int mmp3_usb_phy_init(struct phy *phy)\n{\n\tstruct mmp3_usb_phy *mmp3_usb_phy = phy_get_drvdata(phy);\n\tvoid __iomem *base = mmp3_usb_phy->base;\n\n\tif (cpu_is_mmp3_a0()) {\n\t\tu2o_clear(base, USB2_PLL_REG0, (USB2_PLL_FBDIV_MASK_MMP3\n\t\t\t| USB2_PLL_REFDIV_MASK_MMP3));\n\t\tu2o_set(base, USB2_PLL_REG0,\n\t\t\t0xd << USB2_PLL_REFDIV_SHIFT_MMP3\n\t\t\t| 0xf0 << USB2_PLL_FBDIV_SHIFT_MMP3);\n\t} else if (cpu_is_mmp3_b0()) {\n\t\tu2o_clear(base, USB2_PLL_REG0, USB2_PLL_REFDIV_MASK_MMP3_B0\n\t\t\t| USB2_PLL_FBDIV_MASK_MMP3_B0);\n\t\tu2o_set(base, USB2_PLL_REG0,\n\t\t\t0xd << USB2_PLL_REFDIV_SHIFT_MMP3_B0\n\t\t\t| 0xf0 << USB2_PLL_FBDIV_SHIFT_MMP3_B0);\n\t} else {\n\t\tdev_err(&phy->dev, \"unsupported silicon revision\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tu2o_clear(base, USB2_PLL_REG1, USB2_PLL_PU_PLL_MASK\n\t\t| USB2_PLL_ICP_MASK_MMP3\n\t\t| USB2_PLL_KVCO_MASK_MMP3\n\t\t| USB2_PLL_CALI12_MASK_MMP3);\n\tu2o_set(base, USB2_PLL_REG1, 1 << USB2_PLL_PU_PLL_SHIFT_MMP3\n\t\t| 1 << USB2_PLL_LOCK_BYPASS_SHIFT_MMP3\n\t\t| 3 << USB2_PLL_ICP_SHIFT_MMP3\n\t\t| 3 << USB2_PLL_KVCO_SHIFT_MMP3\n\t\t| 3 << USB2_PLL_CAL12_SHIFT_MMP3);\n\n\tu2o_clear(base, USB2_TX_REG0, USB2_TX_IMPCAL_VTH_MASK_MMP3);\n\tu2o_set(base, USB2_TX_REG0, 2 << USB2_TX_IMPCAL_VTH_SHIFT_MMP3);\n\n\tu2o_clear(base, USB2_TX_REG1, USB2_TX_VDD12_MASK_MMP3\n\t\t| USB2_TX_AMP_MASK_MMP3\n\t\t| USB2_TX_CK60_PHSEL_MASK_MMP3);\n\tu2o_set(base, USB2_TX_REG1, 3 << USB2_TX_VDD12_SHIFT_MMP3\n\t\t| 4 << USB2_TX_AMP_SHIFT_MMP3\n\t\t| 4 << USB2_TX_CK60_PHSEL_SHIFT_MMP3);\n\n\tu2o_clear(base, USB2_TX_REG2, 3 << USB2_TX_DRV_SLEWRATE_SHIFT);\n\tu2o_set(base, USB2_TX_REG2, 2 << USB2_TX_DRV_SLEWRATE_SHIFT);\n\n\tu2o_clear(base, USB2_RX_REG0, USB2_RX_SQ_THRESH_MASK_MMP3);\n\tu2o_set(base, USB2_RX_REG0, 0xa << USB2_RX_SQ_THRESH_SHIFT_MMP3);\n\n\tu2o_set(base, USB2_ANA_REG1, 0x1 << USB2_ANA_PU_ANA_SHIFT_MMP3);\n\n\tu2o_set(base, USB2_OTG_REG0, 0x1 << USB2_OTG_PU_OTG_SHIFT_MMP3);\n\n\treturn 0;\n}\n\nstatic int mmp3_usb_phy_calibrate(struct phy *phy)\n{\n\tstruct mmp3_usb_phy *mmp3_usb_phy = phy_get_drvdata(phy);\n\tvoid __iomem *base = mmp3_usb_phy->base;\n\tint loops;\n\n\t \n\n\tudelay(200);\n\tu2o_set(base, USB2_PLL_REG1, 1 << USB2_PLL_VCOCAL_START_SHIFT_MMP3);\n\tudelay(400);\n\tu2o_set(base, USB2_TX_REG0, 1 << USB2_TX_RCAL_START_SHIFT_MMP3);\n\tudelay(40);\n\tu2o_clear(base, USB2_TX_REG0, 1 << USB2_TX_RCAL_START_SHIFT_MMP3);\n\tudelay(400);\n\n\tloops = 0;\n\twhile ((u2o_get(base, USB2_PLL_REG1) & USB2_PLL_READY_MASK_MMP3) == 0) {\n\t\tmdelay(1);\n\t\tloops++;\n\t\tif (loops > 100) {\n\t\t\tdev_err(&phy->dev, \"PLL_READY not set after 100mS.\\n\");\n\t\t\treturn -ETIMEDOUT;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct phy_ops mmp3_usb_phy_ops = {\n\t.init\t\t= mmp3_usb_phy_init,\n\t.calibrate\t= mmp3_usb_phy_calibrate,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic const struct of_device_id mmp3_usb_phy_of_match[] = {\n\t{ .compatible = \"marvell,mmp3-usb-phy\", },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, mmp3_usb_phy_of_match);\n\nstatic int mmp3_usb_phy_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct mmp3_usb_phy *mmp3_usb_phy;\n\tstruct phy_provider *provider;\n\n\tmmp3_usb_phy = devm_kzalloc(dev, sizeof(*mmp3_usb_phy), GFP_KERNEL);\n\tif (!mmp3_usb_phy)\n\t\treturn -ENOMEM;\n\n\tmmp3_usb_phy->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(mmp3_usb_phy->base)) {\n\t\tdev_err(dev, \"failed to remap PHY regs\\n\");\n\t\treturn PTR_ERR(mmp3_usb_phy->base);\n\t}\n\n\tmmp3_usb_phy->phy = devm_phy_create(dev, NULL, &mmp3_usb_phy_ops);\n\tif (IS_ERR(mmp3_usb_phy->phy)) {\n\t\tdev_err(dev, \"failed to create PHY\\n\");\n\t\treturn PTR_ERR(mmp3_usb_phy->phy);\n\t}\n\n\tphy_set_drvdata(mmp3_usb_phy->phy, mmp3_usb_phy);\n\tprovider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\n\tif (IS_ERR(provider)) {\n\t\tdev_err(dev, \"failed to register PHY provider\\n\");\n\t\treturn PTR_ERR(provider);\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver mmp3_usb_phy_driver = {\n\t.probe\t\t= mmp3_usb_phy_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"mmp3-usb-phy\",\n\t\t.of_match_table = mmp3_usb_phy_of_match,\n\t},\n};\nmodule_platform_driver(mmp3_usb_phy_driver);\n\nMODULE_AUTHOR(\"Lubomir Rintel <lkundrak@v3.sk>\");\nMODULE_DESCRIPTION(\"Marvell MMP3 USB PHY Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}