{
  "module_name": "phy-mtk-hdmi-mt8173.c",
  "hash_id": "e8967b650d30628142672e0240cb8db0021ff9f281a79b728423e74fe659efe3",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/mediatek/phy-mtk-hdmi-mt8173.c",
  "human_readable_source": "\n \n\n#include \"phy-mtk-hdmi.h\"\n#include \"phy-mtk-io.h\"\n\n#define HDMI_CON0\t\t0x00\n#define RG_HDMITX_PLL_EN\t\tBIT(31)\n#define RG_HDMITX_PLL_FBKDIV\t\tGENMASK(30, 24)\n#define RG_HDMITX_PLL_FBKSEL\t\tGENMASK(23, 22)\n#define RG_HDMITX_PLL_PREDIV\t\tGENMASK(21, 20)\n#define RG_HDMITX_PLL_POSDIV\t\tGENMASK(19, 18)\n#define RG_HDMITX_PLL_RST_DLY\t\tGENMASK(17, 16)\n#define RG_HDMITX_PLL_IR\t\tGENMASK(15, 12)\n#define RG_HDMITX_PLL_IC\t\tGENMASK(11, 8)\n#define RG_HDMITX_PLL_BP\t\tGENMASK(7, 4)\n#define RG_HDMITX_PLL_BR\t\tGENMASK(3, 2)\n#define RG_HDMITX_PLL_BC\t\tGENMASK(1, 0)\n#define HDMI_CON1\t\t0x04\n#define RG_HDMITX_PLL_DIVEN\t\tGENMASK(31, 29)\n#define RG_HDMITX_PLL_AUTOK_EN\t\tBIT(28)\n#define RG_HDMITX_PLL_AUTOK_KF\t\tGENMASK(27, 26)\n#define RG_HDMITX_PLL_AUTOK_KS\t\tGENMASK(25, 24)\n#define RG_HDMITX_PLL_AUTOK_LOAD\tBIT(23)\n#define RG_HDMITX_PLL_BAND\t\tGENMASK(21, 16)\n#define RG_HDMITX_PLL_REF_SEL\t\tBIT(15)\n#define RG_HDMITX_PLL_BIAS_EN\t\tBIT(14)\n#define RG_HDMITX_PLL_BIAS_LPF_EN\tBIT(13)\n#define RG_HDMITX_PLL_TXDIV_EN\t\tBIT(12)\n#define RG_HDMITX_PLL_TXDIV\t\tGENMASK(11, 10)\n#define RG_HDMITX_PLL_LVROD_EN\t\tBIT(9)\n#define RG_HDMITX_PLL_MONVC_EN\t\tBIT(8)\n#define RG_HDMITX_PLL_MONCK_EN\t\tBIT(7)\n#define RG_HDMITX_PLL_MONREF_EN\t\tBIT(6)\n#define RG_HDMITX_PLL_TST_EN\t\tBIT(5)\n#define RG_HDMITX_PLL_TST_CK_EN\t\tBIT(4)\n#define RG_HDMITX_PLL_TST_SEL\t\tGENMASK(3, 0)\n#define HDMI_CON2\t\t0x08\n#define RGS_HDMITX_PLL_AUTOK_BAND\tGENMASK(14, 8)\n#define RGS_HDMITX_PLL_AUTOK_FAIL\tBIT(1)\n#define RG_HDMITX_EN_TX_CKLDO\t\tBIT(0)\n#define HDMI_CON3\t\t0x0c\n#define RG_HDMITX_SER_EN\t\tGENMASK(31, 28)\n#define RG_HDMITX_PRD_EN\t\tGENMASK(27, 24)\n#define RG_HDMITX_PRD_IMP_EN\t\tGENMASK(23, 20)\n#define RG_HDMITX_DRV_EN\t\tGENMASK(19, 16)\n#define RG_HDMITX_DRV_IMP_EN\t\tGENMASK(15, 12)\n#define RG_HDMITX_MHLCK_FORCE\t\tBIT(10)\n#define RG_HDMITX_MHLCK_PPIX_EN\t\tBIT(9)\n#define RG_HDMITX_MHLCK_EN\t\tBIT(8)\n#define RG_HDMITX_SER_DIN_SEL\t\tGENMASK(7, 4)\n#define RG_HDMITX_SER_5T1_BIST_EN\tBIT(3)\n#define RG_HDMITX_SER_BIST_TOG\t\tBIT(2)\n#define RG_HDMITX_SER_DIN_TOG\t\tBIT(1)\n#define RG_HDMITX_SER_CLKDIG_INV\tBIT(0)\n#define HDMI_CON4\t\t0x10\n#define RG_HDMITX_PRD_IBIAS_CLK\t\tGENMASK(27, 24)\n#define RG_HDMITX_PRD_IBIAS_D2\t\tGENMASK(19, 16)\n#define RG_HDMITX_PRD_IBIAS_D1\t\tGENMASK(11, 8)\n#define RG_HDMITX_PRD_IBIAS_D0\t\tGENMASK(3, 0)\n#define HDMI_CON5\t\t0x14\n#define RG_HDMITX_DRV_IBIAS_CLK\t\tGENMASK(29, 24)\n#define RG_HDMITX_DRV_IBIAS_D2\t\tGENMASK(21, 16)\n#define RG_HDMITX_DRV_IBIAS_D1\t\tGENMASK(13, 8)\n#define RG_HDMITX_DRV_IBIAS_D0\t\tGENMASK(5, 0)\n#define HDMI_CON6\t\t0x18\n#define RG_HDMITX_DRV_IMP_CLK\t\tGENMASK(29, 24)\n#define RG_HDMITX_DRV_IMP_D2\t\tGENMASK(21, 16)\n#define RG_HDMITX_DRV_IMP_D1\t\tGENMASK(13, 8)\n#define RG_HDMITX_DRV_IMP_D0\t\tGENMASK(5, 0)\n#define HDMI_CON7\t\t0x1c\n#define RG_HDMITX_MHLCK_DRV_IBIAS\tGENMASK(31, 27)\n#define RG_HDMITX_SER_DIN\t\tGENMASK(25, 16)\n#define RG_HDMITX_CHLDC_TST\t\tGENMASK(15, 12)\n#define RG_HDMITX_CHLCK_TST\t\tGENMASK(11, 8)\n#define RG_HDMITX_RESERVE\t\tGENMASK(7, 0)\n#define HDMI_CON8\t\t0x20\n#define RGS_HDMITX_2T1_LEV\t\tGENMASK(19, 16)\n#define RGS_HDMITX_2T1_EDG\t\tGENMASK(15, 12)\n#define RGS_HDMITX_5T1_LEV\t\tGENMASK(11, 8)\n#define RGS_HDMITX_5T1_EDG\t\tGENMASK(7, 4)\n#define RGS_HDMITX_PLUG_TST\t\tBIT(0)\n\nstatic int mtk_hdmi_pll_prepare(struct clk_hw *hw)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\n\tvoid __iomem *base = hdmi_phy->regs;\n\n\tmtk_phy_set_bits(base + HDMI_CON1, RG_HDMITX_PLL_AUTOK_EN);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_PLL_POSDIV);\n\tmtk_phy_clear_bits(base + HDMI_CON3, RG_HDMITX_MHLCK_EN);\n\tmtk_phy_set_bits(base + HDMI_CON1, RG_HDMITX_PLL_BIAS_EN);\n\tusleep_range(100, 150);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_PLL_EN);\n\tusleep_range(100, 150);\n\tmtk_phy_set_bits(base + HDMI_CON1, RG_HDMITX_PLL_BIAS_LPF_EN);\n\tmtk_phy_set_bits(base + HDMI_CON1, RG_HDMITX_PLL_TXDIV_EN);\n\n\treturn 0;\n}\n\nstatic void mtk_hdmi_pll_unprepare(struct clk_hw *hw)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\n\tvoid __iomem *base = hdmi_phy->regs;\n\n\tmtk_phy_clear_bits(base + HDMI_CON1, RG_HDMITX_PLL_TXDIV_EN);\n\tmtk_phy_clear_bits(base + HDMI_CON1, RG_HDMITX_PLL_BIAS_LPF_EN);\n\tusleep_range(100, 150);\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_PLL_EN);\n\tusleep_range(100, 150);\n\tmtk_phy_clear_bits(base + HDMI_CON1, RG_HDMITX_PLL_BIAS_EN);\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_PLL_POSDIV);\n\tmtk_phy_clear_bits(base + HDMI_CON1, RG_HDMITX_PLL_AUTOK_EN);\n\tusleep_range(100, 150);\n}\n\nstatic long mtk_hdmi_pll_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t    unsigned long *parent_rate)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\n\n\thdmi_phy->pll_rate = rate;\n\tif (rate <= 74250000)\n\t\t*parent_rate = rate;\n\telse\n\t\t*parent_rate = rate / 2;\n\n\treturn rate;\n}\n\nstatic int mtk_hdmi_pll_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t unsigned long parent_rate)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\n\tvoid __iomem *base = hdmi_phy->regs;\n\tunsigned int pre_div;\n\tunsigned int div;\n\tunsigned int pre_ibias;\n\tunsigned int hdmi_ibias;\n\tunsigned int imp_en;\n\n\tdev_dbg(hdmi_phy->dev, \"%s: %lu Hz, parent: %lu Hz\\n\", __func__,\n\t\trate, parent_rate);\n\n\tif (rate <= 27000000) {\n\t\tpre_div = 0;\n\t\tdiv = 3;\n\t} else if (rate <= 74250000) {\n\t\tpre_div = 1;\n\t\tdiv = 2;\n\t} else {\n\t\tpre_div = 1;\n\t\tdiv = 1;\n\t}\n\n\tmtk_phy_update_field(base + HDMI_CON0, RG_HDMITX_PLL_PREDIV, pre_div);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_PLL_POSDIV);\n\tmtk_phy_update_bits(base + HDMI_CON0,\n\t\t\t    RG_HDMITX_PLL_IC | RG_HDMITX_PLL_IR,\n\t\t\t    FIELD_PREP(RG_HDMITX_PLL_IC, 0x1) |\n\t\t\t    FIELD_PREP(RG_HDMITX_PLL_IR, 0x1));\n\tmtk_phy_update_field(base + HDMI_CON1, RG_HDMITX_PLL_TXDIV, div);\n\tmtk_phy_update_bits(base + HDMI_CON0,\n\t\t\t    RG_HDMITX_PLL_FBKSEL | RG_HDMITX_PLL_FBKDIV,\n\t\t\t    FIELD_PREP(RG_HDMITX_PLL_FBKSEL, 0x1) |\n\t\t\t    FIELD_PREP(RG_HDMITX_PLL_FBKDIV, 19));\n\tmtk_phy_update_field(base + HDMI_CON1, RG_HDMITX_PLL_DIVEN, 0x2);\n\tmtk_phy_update_bits(base + HDMI_CON0,\n\t\t\t    RG_HDMITX_PLL_BP | RG_HDMITX_PLL_BC |\n\t\t\t    RG_HDMITX_PLL_BR,\n\t\t\t    FIELD_PREP(RG_HDMITX_PLL_BP, 0xc) |\n\t\t\t    FIELD_PREP(RG_HDMITX_PLL_BC, 0x2) |\n\t\t\t    FIELD_PREP(RG_HDMITX_PLL_BR, 0x1));\n\tif (rate < 165000000) {\n\t\tmtk_phy_clear_bits(base + HDMI_CON3, RG_HDMITX_PRD_IMP_EN);\n\t\tpre_ibias = 0x3;\n\t\timp_en = 0x0;\n\t\thdmi_ibias = hdmi_phy->ibias;\n\t} else {\n\t\tmtk_phy_set_bits(base + HDMI_CON3, RG_HDMITX_PRD_IMP_EN);\n\t\tpre_ibias = 0x6;\n\t\timp_en = 0xf;\n\t\thdmi_ibias = hdmi_phy->ibias_up;\n\t}\n\tmtk_phy_update_bits(base + HDMI_CON4,\n\t\t\t    RG_HDMITX_PRD_IBIAS_CLK | RG_HDMITX_PRD_IBIAS_D2 |\n\t\t\t    RG_HDMITX_PRD_IBIAS_D1 | RG_HDMITX_PRD_IBIAS_D0,\n\t\t\t    FIELD_PREP(RG_HDMITX_PRD_IBIAS_CLK, pre_ibias) |\n\t\t\t    FIELD_PREP(RG_HDMITX_PRD_IBIAS_D2, pre_ibias) |\n\t\t\t    FIELD_PREP(RG_HDMITX_PRD_IBIAS_D1, pre_ibias) |\n\t\t\t    FIELD_PREP(RG_HDMITX_PRD_IBIAS_D0, pre_ibias));\n\tmtk_phy_update_field(base + HDMI_CON3, RG_HDMITX_DRV_IMP_EN, imp_en);\n\tmtk_phy_update_bits(base + HDMI_CON6,\n\t\t\t    RG_HDMITX_DRV_IMP_CLK | RG_HDMITX_DRV_IMP_D2 |\n\t\t\t    RG_HDMITX_DRV_IMP_D1 | RG_HDMITX_DRV_IMP_D0,\n\t\t\t    FIELD_PREP(RG_HDMITX_DRV_IMP_CLK, hdmi_phy->drv_imp_clk) |\n\t\t\t    FIELD_PREP(RG_HDMITX_DRV_IMP_D2, hdmi_phy->drv_imp_d2) |\n\t\t\t    FIELD_PREP(RG_HDMITX_DRV_IMP_D1, hdmi_phy->drv_imp_d1) |\n\t\t\t    FIELD_PREP(RG_HDMITX_DRV_IMP_D0, hdmi_phy->drv_imp_d0));\n\tmtk_phy_update_bits(base + HDMI_CON5,\n\t\t\t    RG_HDMITX_DRV_IBIAS_CLK | RG_HDMITX_DRV_IBIAS_D2 |\n\t\t\t    RG_HDMITX_DRV_IBIAS_D1 | RG_HDMITX_DRV_IBIAS_D0,\n\t\t\t    FIELD_PREP(RG_HDMITX_DRV_IBIAS_CLK, hdmi_ibias) |\n\t\t\t    FIELD_PREP(RG_HDMITX_DRV_IBIAS_D2, hdmi_ibias) |\n\t\t\t    FIELD_PREP(RG_HDMITX_DRV_IBIAS_D1, hdmi_ibias) |\n\t\t\t    FIELD_PREP(RG_HDMITX_DRV_IBIAS_D0, hdmi_ibias));\n\treturn 0;\n}\n\nstatic unsigned long mtk_hdmi_pll_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t      unsigned long parent_rate)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\n\n\treturn hdmi_phy->pll_rate;\n}\n\nstatic const struct clk_ops mtk_hdmi_phy_pll_ops = {\n\t.prepare = mtk_hdmi_pll_prepare,\n\t.unprepare = mtk_hdmi_pll_unprepare,\n\t.set_rate = mtk_hdmi_pll_set_rate,\n\t.round_rate = mtk_hdmi_pll_round_rate,\n\t.recalc_rate = mtk_hdmi_pll_recalc_rate,\n};\n\nstatic void mtk_hdmi_phy_enable_tmds(struct mtk_hdmi_phy *hdmi_phy)\n{\n\tmtk_phy_set_bits(hdmi_phy->regs + HDMI_CON3,\n\t\t\t RG_HDMITX_SER_EN | RG_HDMITX_PRD_EN |\n\t\t\t RG_HDMITX_DRV_EN);\n\tusleep_range(100, 150);\n}\n\nstatic void mtk_hdmi_phy_disable_tmds(struct mtk_hdmi_phy *hdmi_phy)\n{\n\tmtk_phy_clear_bits(hdmi_phy->regs + HDMI_CON3,\n\t\t\t   RG_HDMITX_DRV_EN | RG_HDMITX_PRD_EN |\n\t\t\t   RG_HDMITX_SER_EN);\n}\n\nstruct mtk_hdmi_phy_conf mtk_hdmi_phy_8173_conf = {\n\t.flags = CLK_SET_RATE_PARENT | CLK_SET_RATE_GATE,\n\t.hdmi_phy_clk_ops = &mtk_hdmi_phy_pll_ops,\n\t.hdmi_phy_enable_tmds = mtk_hdmi_phy_enable_tmds,\n\t.hdmi_phy_disable_tmds = mtk_hdmi_phy_disable_tmds,\n};\n\nMODULE_AUTHOR(\"Jie Qiu <jie.qiu@mediatek.com>\");\nMODULE_DESCRIPTION(\"MediaTek MT8173 HDMI PHY Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}