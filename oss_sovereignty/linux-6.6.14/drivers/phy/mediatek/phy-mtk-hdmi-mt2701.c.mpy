{
  "module_name": "phy-mtk-hdmi-mt2701.c",
  "hash_id": "00fd1b759d7776a604c4f6d5bbe589b3b2d98b22c1b458696bb5dc13805c282b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/mediatek/phy-mtk-hdmi-mt2701.c",
  "human_readable_source": "\n \n\n#include \"phy-mtk-hdmi.h\"\n#include \"phy-mtk-io.h\"\n\n#define HDMI_CON0\t0x00\n#define RG_HDMITX_DRV_IBIAS_MASK\tGENMASK(5, 0)\n#define RG_HDMITX_EN_SER_MASK\t\tGENMASK(15, 12)\n#define RG_HDMITX_EN_SLDO_MASK\t\tGENMASK(19, 16)\n#define RG_HDMITX_EN_PRED_MASK\t\tGENMASK(23, 20)\n#define RG_HDMITX_EN_IMP_MASK\t\tGENMASK(27, 24)\n#define RG_HDMITX_EN_DRV_MASK\t\tGENMASK(31, 28)\n\n#define HDMI_CON1\t0x04\n#define RG_HDMITX_PRED_IBIAS_MASK\tGENMASK(21, 18)\n#define RG_HDMITX_PRED_IMP\t\tBIT(22)\n#define RG_HDMITX_DRV_IMP_MASK\t\tGENMASK(31, 26)\n\n#define HDMI_CON2\t0x08\n#define RG_HDMITX_EN_TX_CKLDO\t\tBIT(0)\n#define RG_HDMITX_EN_TX_POSDIV\t\tBIT(1)\n#define RG_HDMITX_TX_POSDIV_MASK\tGENMASK(4, 3)\n#define RG_HDMITX_EN_MBIAS\t\tBIT(6)\n#define RG_HDMITX_MBIAS_LPF_EN\t\tBIT(7)\n\n#define HDMI_CON4\t0x10\n#define RG_HDMITX_RESERVE_MASK\t\tGENMASK(31, 0)\n\n#define HDMI_CON6\t0x18\n#define RG_HTPLL_BR_MASK\t\tGENMASK(1, 0)\n#define RG_HTPLL_BC_MASK\t\tGENMASK(3, 2)\n#define RG_HTPLL_BP_MASK\t\tGENMASK(7, 4)\n#define RG_HTPLL_IR_MASK\t\tGENMASK(11, 8)\n#define RG_HTPLL_IC_MASK\t\tGENMASK(15, 12)\n#define RG_HTPLL_POSDIV_MASK\t\tGENMASK(17, 16)\n#define RG_HTPLL_PREDIV_MASK\t\tGENMASK(19, 18)\n#define RG_HTPLL_FBKSEL_MASK\t\tGENMASK(21, 20)\n#define RG_HTPLL_RLH_EN\t\t\tBIT(22)\n#define RG_HTPLL_FBKDIV_MASK\t\tGENMASK(30, 24)\n#define RG_HTPLL_EN\t\t\tBIT(31)\n\n#define HDMI_CON7\t0x1c\n#define RG_HTPLL_AUTOK_EN\t\tBIT(23)\n#define RG_HTPLL_DIVEN_MASK\t\tGENMASK(30, 28)\n\nstatic int mtk_hdmi_pll_prepare(struct clk_hw *hw)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\n\tvoid __iomem *base = hdmi_phy->regs;\n\n\tmtk_phy_set_bits(base + HDMI_CON7, RG_HTPLL_AUTOK_EN);\n\tmtk_phy_clear_bits(base + HDMI_CON6, RG_HTPLL_RLH_EN);\n\tmtk_phy_set_bits(base + HDMI_CON6, RG_HTPLL_POSDIV_MASK);\n\tmtk_phy_set_bits(base + HDMI_CON2, RG_HDMITX_EN_MBIAS);\n\tusleep_range(80, 100);\n\tmtk_phy_set_bits(base + HDMI_CON6, RG_HTPLL_EN);\n\tmtk_phy_set_bits(base + HDMI_CON2, RG_HDMITX_EN_TX_CKLDO);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_EN_SLDO_MASK);\n\tusleep_range(80, 100);\n\tmtk_phy_set_bits(base + HDMI_CON2, RG_HDMITX_MBIAS_LPF_EN);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_EN_SER_MASK);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_EN_PRED_MASK);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_EN_DRV_MASK);\n\tusleep_range(80, 100);\n\treturn 0;\n}\n\nstatic void mtk_hdmi_pll_unprepare(struct clk_hw *hw)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\n\tvoid __iomem *base = hdmi_phy->regs;\n\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_EN_DRV_MASK);\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_EN_PRED_MASK);\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_EN_SER_MASK);\n\tmtk_phy_clear_bits(base + HDMI_CON2, RG_HDMITX_MBIAS_LPF_EN);\n\tusleep_range(80, 100);\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_EN_SLDO_MASK);\n\tmtk_phy_clear_bits(base + HDMI_CON2, RG_HDMITX_EN_TX_CKLDO);\n\tmtk_phy_clear_bits(base + HDMI_CON6, RG_HTPLL_EN);\n\tusleep_range(80, 100);\n\tmtk_phy_clear_bits(base + HDMI_CON2, RG_HDMITX_EN_MBIAS);\n\tmtk_phy_clear_bits(base + HDMI_CON6, RG_HTPLL_POSDIV_MASK);\n\tmtk_phy_clear_bits(base + HDMI_CON6, RG_HTPLL_RLH_EN);\n\tmtk_phy_clear_bits(base + HDMI_CON7, RG_HTPLL_AUTOK_EN);\n\tusleep_range(80, 100);\n}\n\nstatic long mtk_hdmi_pll_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t    unsigned long *parent_rate)\n{\n\treturn rate;\n}\n\nstatic int mtk_hdmi_pll_set_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t unsigned long parent_rate)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\n\tvoid __iomem *base = hdmi_phy->regs;\n\tu32 pos_div;\n\n\tif (rate <= 64000000)\n\t\tpos_div = 3;\n\telse if (rate <= 128000000)\n\t\tpos_div = 2;\n\telse\n\t\tpos_div = 1;\n\n\tmtk_phy_set_bits(base + HDMI_CON6, RG_HTPLL_PREDIV_MASK);\n\tmtk_phy_set_bits(base + HDMI_CON6, RG_HTPLL_POSDIV_MASK);\n\tmtk_phy_set_bits(base + HDMI_CON2, RG_HDMITX_EN_TX_POSDIV);\n\tmtk_phy_update_field(base + HDMI_CON6, RG_HTPLL_IC_MASK, 0x1);\n\tmtk_phy_update_field(base + HDMI_CON6, RG_HTPLL_IR_MASK, 0x1);\n\tmtk_phy_update_field(base + HDMI_CON2, RG_HDMITX_TX_POSDIV_MASK, pos_div);\n\tmtk_phy_update_field(base + HDMI_CON6, RG_HTPLL_FBKSEL_MASK, 1);\n\tmtk_phy_update_field(base + HDMI_CON6, RG_HTPLL_FBKDIV_MASK, 19);\n\tmtk_phy_update_field(base + HDMI_CON7, RG_HTPLL_DIVEN_MASK, 0x2);\n\tmtk_phy_update_field(base + HDMI_CON6, RG_HTPLL_BP_MASK, 0xc);\n\tmtk_phy_update_field(base + HDMI_CON6, RG_HTPLL_BC_MASK, 0x2);\n\tmtk_phy_update_field(base + HDMI_CON6, RG_HTPLL_BR_MASK, 0x1);\n\n\tmtk_phy_clear_bits(base + HDMI_CON1, RG_HDMITX_PRED_IMP);\n\tmtk_phy_update_field(base + HDMI_CON1, RG_HDMITX_PRED_IBIAS_MASK, 0x3);\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_EN_IMP_MASK);\n\tmtk_phy_update_field(base + HDMI_CON1, RG_HDMITX_DRV_IMP_MASK, 0x28);\n\tmtk_phy_update_field(base + HDMI_CON4, RG_HDMITX_RESERVE_MASK, 0x28);\n\tmtk_phy_update_field(base + HDMI_CON0, RG_HDMITX_DRV_IBIAS_MASK, 0xa);\n\treturn 0;\n}\n\nstatic unsigned long mtk_hdmi_pll_recalc_rate(struct clk_hw *hw,\n\t\t\t\t\t      unsigned long parent_rate)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = to_mtk_hdmi_phy(hw);\n\tunsigned long out_rate, val;\n\tu32 tmp;\n\n\ttmp = readl(hdmi_phy->regs + HDMI_CON6);\n\tval = FIELD_GET(RG_HTPLL_PREDIV_MASK, tmp);\n\tswitch (val) {\n\tcase 0x00:\n\t\tout_rate = parent_rate;\n\t\tbreak;\n\tcase 0x01:\n\t\tout_rate = parent_rate / 2;\n\t\tbreak;\n\tdefault:\n\t\tout_rate = parent_rate / 4;\n\t\tbreak;\n\t}\n\n\tval = FIELD_GET(RG_HTPLL_FBKDIV_MASK, tmp);\n\tout_rate *= (val + 1) * 2;\n\n\ttmp = readl(hdmi_phy->regs + HDMI_CON2);\n\tval = FIELD_GET(RG_HDMITX_TX_POSDIV_MASK, tmp);\n\tout_rate >>= val;\n\n\tif (tmp & RG_HDMITX_EN_TX_POSDIV)\n\t\tout_rate /= 5;\n\n\treturn out_rate;\n}\n\nstatic const struct clk_ops mtk_hdmi_phy_pll_ops = {\n\t.prepare = mtk_hdmi_pll_prepare,\n\t.unprepare = mtk_hdmi_pll_unprepare,\n\t.set_rate = mtk_hdmi_pll_set_rate,\n\t.round_rate = mtk_hdmi_pll_round_rate,\n\t.recalc_rate = mtk_hdmi_pll_recalc_rate,\n};\n\nstatic void mtk_hdmi_phy_enable_tmds(struct mtk_hdmi_phy *hdmi_phy)\n{\n\tvoid __iomem *base = hdmi_phy->regs;\n\n\tmtk_phy_set_bits(base + HDMI_CON7, RG_HTPLL_AUTOK_EN);\n\tmtk_phy_clear_bits(base + HDMI_CON6, RG_HTPLL_RLH_EN);\n\tmtk_phy_set_bits(base + HDMI_CON6, RG_HTPLL_POSDIV_MASK);\n\tmtk_phy_set_bits(base + HDMI_CON2, RG_HDMITX_EN_MBIAS);\n\tusleep_range(80, 100);\n\tmtk_phy_set_bits(base + HDMI_CON6, RG_HTPLL_EN);\n\tmtk_phy_set_bits(base + HDMI_CON2, RG_HDMITX_EN_TX_CKLDO);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_EN_SLDO_MASK);\n\tusleep_range(80, 100);\n\tmtk_phy_set_bits(base + HDMI_CON2, RG_HDMITX_MBIAS_LPF_EN);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_EN_SER_MASK);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_EN_PRED_MASK);\n\tmtk_phy_set_bits(base + HDMI_CON0, RG_HDMITX_EN_DRV_MASK);\n\tusleep_range(80, 100);\n}\n\nstatic void mtk_hdmi_phy_disable_tmds(struct mtk_hdmi_phy *hdmi_phy)\n{\n\tvoid __iomem *base = hdmi_phy->regs;\n\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_EN_DRV_MASK);\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_EN_PRED_MASK);\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_EN_SER_MASK);\n\tmtk_phy_clear_bits(base + HDMI_CON2, RG_HDMITX_MBIAS_LPF_EN);\n\tusleep_range(80, 100);\n\tmtk_phy_clear_bits(base + HDMI_CON0, RG_HDMITX_EN_SLDO_MASK);\n\tmtk_phy_clear_bits(base + HDMI_CON2, RG_HDMITX_EN_TX_CKLDO);\n\tmtk_phy_clear_bits(base + HDMI_CON6, RG_HTPLL_EN);\n\tusleep_range(80, 100);\n\tmtk_phy_clear_bits(base + HDMI_CON2, RG_HDMITX_EN_MBIAS);\n\tmtk_phy_clear_bits(base + HDMI_CON6, RG_HTPLL_POSDIV_MASK);\n\tmtk_phy_clear_bits(base + HDMI_CON6, RG_HTPLL_RLH_EN);\n\tmtk_phy_clear_bits(base + HDMI_CON7, RG_HTPLL_AUTOK_EN);\n\tusleep_range(80, 100);\n}\n\nstruct mtk_hdmi_phy_conf mtk_hdmi_phy_2701_conf = {\n\t.flags = CLK_SET_RATE_GATE,\n\t.pll_default_off = true,\n\t.hdmi_phy_clk_ops = &mtk_hdmi_phy_pll_ops,\n\t.hdmi_phy_enable_tmds = mtk_hdmi_phy_enable_tmds,\n\t.hdmi_phy_disable_tmds = mtk_hdmi_phy_disable_tmds,\n};\n\nMODULE_AUTHOR(\"Chunhui Dai <chunhui.dai@mediatek.com>\");\nMODULE_DESCRIPTION(\"MediaTek HDMI PHY Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}