{
  "module_name": "phy-mtk-dp.c",
  "hash_id": "75bf3dab944c04fd43fe5db7b55ecd645b823f52339d46c43c3a9dfe799a8d10",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/mediatek/phy-mtk-dp.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/mfd/syscon.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define PHY_OFFSET\t\t\t0x1000\n\n#define MTK_DP_PHY_DIG_PLL_CTL_1\t(PHY_OFFSET + 0x14)\n#define TPLL_SSC_EN\t\t\tBIT(3)\n\n#define MTK_DP_PHY_DIG_BIT_RATE\t\t(PHY_OFFSET + 0x3C)\n#define BIT_RATE_RBR\t\t\t0\n#define BIT_RATE_HBR\t\t\t1\n#define BIT_RATE_HBR2\t\t\t2\n#define BIT_RATE_HBR3\t\t\t3\n\n#define MTK_DP_PHY_DIG_SW_RST\t\t(PHY_OFFSET + 0x38)\n#define DP_GLB_SW_RST_PHYD\t\tBIT(0)\n\n#define MTK_DP_LANE0_DRIVING_PARAM_3\t\t(PHY_OFFSET + 0x138)\n#define MTK_DP_LANE1_DRIVING_PARAM_3\t\t(PHY_OFFSET + 0x238)\n#define MTK_DP_LANE2_DRIVING_PARAM_3\t\t(PHY_OFFSET + 0x338)\n#define MTK_DP_LANE3_DRIVING_PARAM_3\t\t(PHY_OFFSET + 0x438)\n#define XTP_LN_TX_LCTXC0_SW0_PRE0_DEFAULT\tBIT(4)\n#define XTP_LN_TX_LCTXC0_SW0_PRE1_DEFAULT\t(BIT(10) | BIT(12))\n#define XTP_LN_TX_LCTXC0_SW0_PRE2_DEFAULT\tGENMASK(20, 19)\n#define XTP_LN_TX_LCTXC0_SW0_PRE3_DEFAULT\tGENMASK(29, 29)\n#define DRIVING_PARAM_3_DEFAULT\t(XTP_LN_TX_LCTXC0_SW0_PRE0_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXC0_SW0_PRE1_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXC0_SW0_PRE2_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXC0_SW0_PRE3_DEFAULT)\n\n#define XTP_LN_TX_LCTXC0_SW1_PRE0_DEFAULT\tGENMASK(4, 3)\n#define XTP_LN_TX_LCTXC0_SW1_PRE1_DEFAULT\tGENMASK(12, 9)\n#define XTP_LN_TX_LCTXC0_SW1_PRE2_DEFAULT\t(BIT(18) | BIT(21))\n#define XTP_LN_TX_LCTXC0_SW2_PRE0_DEFAULT\tGENMASK(29, 29)\n#define DRIVING_PARAM_4_DEFAULT\t(XTP_LN_TX_LCTXC0_SW1_PRE0_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXC0_SW1_PRE1_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXC0_SW1_PRE2_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXC0_SW2_PRE0_DEFAULT)\n\n#define XTP_LN_TX_LCTXC0_SW2_PRE1_DEFAULT\t(BIT(3) | BIT(5))\n#define XTP_LN_TX_LCTXC0_SW3_PRE0_DEFAULT\tGENMASK(13, 12)\n#define DRIVING_PARAM_5_DEFAULT\t(XTP_LN_TX_LCTXC0_SW2_PRE1_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXC0_SW3_PRE0_DEFAULT)\n\n#define XTP_LN_TX_LCTXCP1_SW0_PRE0_DEFAULT\t0\n#define XTP_LN_TX_LCTXCP1_SW0_PRE1_DEFAULT\tGENMASK(10, 10)\n#define XTP_LN_TX_LCTXCP1_SW0_PRE2_DEFAULT\tGENMASK(19, 19)\n#define XTP_LN_TX_LCTXCP1_SW0_PRE3_DEFAULT\tGENMASK(28, 28)\n#define DRIVING_PARAM_6_DEFAULT\t(XTP_LN_TX_LCTXCP1_SW0_PRE0_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXCP1_SW0_PRE1_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXCP1_SW0_PRE2_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXCP1_SW0_PRE3_DEFAULT)\n\n#define XTP_LN_TX_LCTXCP1_SW1_PRE0_DEFAULT\t0\n#define XTP_LN_TX_LCTXCP1_SW1_PRE1_DEFAULT\tGENMASK(10, 9)\n#define XTP_LN_TX_LCTXCP1_SW1_PRE2_DEFAULT\tGENMASK(19, 18)\n#define XTP_LN_TX_LCTXCP1_SW2_PRE0_DEFAULT\t0\n#define DRIVING_PARAM_7_DEFAULT\t(XTP_LN_TX_LCTXCP1_SW1_PRE0_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXCP1_SW1_PRE1_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXCP1_SW1_PRE2_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXCP1_SW2_PRE0_DEFAULT)\n\n#define XTP_LN_TX_LCTXCP1_SW2_PRE1_DEFAULT\tGENMASK(3, 3)\n#define XTP_LN_TX_LCTXCP1_SW3_PRE0_DEFAULT\t0\n#define DRIVING_PARAM_8_DEFAULT\t(XTP_LN_TX_LCTXCP1_SW2_PRE1_DEFAULT | \\\n\t\t\t\t XTP_LN_TX_LCTXCP1_SW3_PRE0_DEFAULT)\n\nstruct mtk_dp_phy {\n\tstruct regmap *regs;\n};\n\nstatic int mtk_dp_phy_init(struct phy *phy)\n{\n\tstruct mtk_dp_phy *dp_phy = phy_get_drvdata(phy);\n\tstatic const u32 driving_params[] = {\n\t\tDRIVING_PARAM_3_DEFAULT,\n\t\tDRIVING_PARAM_4_DEFAULT,\n\t\tDRIVING_PARAM_5_DEFAULT,\n\t\tDRIVING_PARAM_6_DEFAULT,\n\t\tDRIVING_PARAM_7_DEFAULT,\n\t\tDRIVING_PARAM_8_DEFAULT\n\t};\n\n\tregmap_bulk_write(dp_phy->regs, MTK_DP_LANE0_DRIVING_PARAM_3,\n\t\t\t  driving_params, ARRAY_SIZE(driving_params));\n\tregmap_bulk_write(dp_phy->regs, MTK_DP_LANE1_DRIVING_PARAM_3,\n\t\t\t  driving_params, ARRAY_SIZE(driving_params));\n\tregmap_bulk_write(dp_phy->regs, MTK_DP_LANE2_DRIVING_PARAM_3,\n\t\t\t  driving_params, ARRAY_SIZE(driving_params));\n\tregmap_bulk_write(dp_phy->regs, MTK_DP_LANE3_DRIVING_PARAM_3,\n\t\t\t  driving_params, ARRAY_SIZE(driving_params));\n\n\treturn 0;\n}\n\nstatic int mtk_dp_phy_configure(struct phy *phy, union phy_configure_opts *opts)\n{\n\tstruct mtk_dp_phy *dp_phy = phy_get_drvdata(phy);\n\tu32 val;\n\n\tif (opts->dp.set_rate) {\n\t\tswitch (opts->dp.link_rate) {\n\t\tdefault:\n\t\t\tdev_err(&phy->dev,\n\t\t\t\t\"Implementation error, unknown linkrate %x\\n\",\n\t\t\t\topts->dp.link_rate);\n\t\t\treturn -EINVAL;\n\t\tcase 1620:\n\t\t\tval = BIT_RATE_RBR;\n\t\t\tbreak;\n\t\tcase 2700:\n\t\t\tval = BIT_RATE_HBR;\n\t\t\tbreak;\n\t\tcase 5400:\n\t\t\tval = BIT_RATE_HBR2;\n\t\t\tbreak;\n\t\tcase 8100:\n\t\t\tval = BIT_RATE_HBR3;\n\t\t\tbreak;\n\t\t}\n\t\tregmap_write(dp_phy->regs, MTK_DP_PHY_DIG_BIT_RATE, val);\n\t}\n\n\tregmap_update_bits(dp_phy->regs, MTK_DP_PHY_DIG_PLL_CTL_1,\n\t\t\t   TPLL_SSC_EN, opts->dp.ssc ? TPLL_SSC_EN : 0);\n\n\treturn 0;\n}\n\nstatic int mtk_dp_phy_reset(struct phy *phy)\n{\n\tstruct mtk_dp_phy *dp_phy = phy_get_drvdata(phy);\n\n\tregmap_update_bits(dp_phy->regs, MTK_DP_PHY_DIG_SW_RST,\n\t\t\t   DP_GLB_SW_RST_PHYD, 0);\n\tusleep_range(50, 200);\n\tregmap_update_bits(dp_phy->regs, MTK_DP_PHY_DIG_SW_RST,\n\t\t\t   DP_GLB_SW_RST_PHYD, 1);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops mtk_dp_phy_dev_ops = {\n\t.init = mtk_dp_phy_init,\n\t.configure = mtk_dp_phy_configure,\n\t.reset = mtk_dp_phy_reset,\n\t.owner = THIS_MODULE,\n};\n\nstatic int mtk_dp_phy_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct mtk_dp_phy *dp_phy;\n\tstruct phy *phy;\n\tstruct regmap *regs;\n\n\tregs = *(struct regmap **)dev->platform_data;\n\tif (!regs)\n\t\treturn dev_err_probe(dev, -EINVAL,\n\t\t\t\t     \"No data passed, requires struct regmap**\\n\");\n\n\tdp_phy = devm_kzalloc(dev, sizeof(*dp_phy), GFP_KERNEL);\n\tif (!dp_phy)\n\t\treturn -ENOMEM;\n\n\tdp_phy->regs = regs;\n\tphy = devm_phy_create(dev, NULL, &mtk_dp_phy_dev_ops);\n\tif (IS_ERR(phy))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy),\n\t\t\t\t     \"Failed to create DP PHY\\n\");\n\n\tphy_set_drvdata(phy, dp_phy);\n\tif (!dev->of_node)\n\t\tphy_create_lookup(phy, \"dp\", dev_name(dev));\n\n\treturn 0;\n}\n\nstatic struct platform_driver mtk_dp_phy_driver = {\n\t.probe = mtk_dp_phy_probe,\n\t.driver = {\n\t\t.name = \"mediatek-dp-phy\",\n\t},\n};\nmodule_platform_driver(mtk_dp_phy_driver);\n\nMODULE_AUTHOR(\"Markus Schneider-Pargmann <msp@baylibre.com>\");\nMODULE_DESCRIPTION(\"MediaTek DP PHY Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}