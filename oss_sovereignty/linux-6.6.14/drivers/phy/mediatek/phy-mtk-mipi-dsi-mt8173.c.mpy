{
  "module_name": "phy-mtk-mipi-dsi-mt8173.c",
  "hash_id": "360ba223d2b630fb1190e3480616cad94c17a7de8ec1f40d40f60a87dc0aa901",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/mediatek/phy-mtk-mipi-dsi-mt8173.c",
  "human_readable_source": "\n \n\n#include \"phy-mtk-io.h\"\n#include \"phy-mtk-mipi-dsi.h\"\n\n#define MIPITX_DSI_CON\t\t0x00\n#define RG_DSI_LDOCORE_EN\t\tBIT(0)\n#define RG_DSI_CKG_LDOOUT_EN\t\tBIT(1)\n#define RG_DSI_BCLK_SEL\t\t\tGENMASK(3, 2)\n#define RG_DSI_LD_IDX_SEL\t\tGENMASK(6, 4)\n#define RG_DSI_PHYCLK_SEL\t\tGENMASK(9, 8)\n#define RG_DSI_DSICLK_FREQ_SEL\t\tBIT(10)\n#define RG_DSI_LPTX_CLMP_EN\t\tBIT(11)\n\n#define MIPITX_DSI_CLOCK_LANE\t0x04\n#define MIPITX_DSI_DATA_LANE0\t0x08\n#define MIPITX_DSI_DATA_LANE1\t0x0c\n#define MIPITX_DSI_DATA_LANE2\t0x10\n#define MIPITX_DSI_DATA_LANE3\t0x14\n#define RG_DSI_LNTx_LDOOUT_EN\t\tBIT(0)\n#define RG_DSI_LNTx_CKLANE_EN\t\tBIT(1)\n#define RG_DSI_LNTx_LPTX_IPLUS1\t\tBIT(2)\n#define RG_DSI_LNTx_LPTX_IPLUS2\t\tBIT(3)\n#define RG_DSI_LNTx_LPTX_IMINUS\t\tBIT(4)\n#define RG_DSI_LNTx_LPCD_IPLUS\t\tBIT(5)\n#define RG_DSI_LNTx_LPCD_IMINUS\t\tBIT(6)\n#define RG_DSI_LNTx_RT_CODE\t\tGENMASK(11, 8)\n\n#define MIPITX_DSI_TOP_CON\t0x40\n#define RG_DSI_LNT_INTR_EN\t\tBIT(0)\n#define RG_DSI_LNT_HS_BIAS_EN\t\tBIT(1)\n#define RG_DSI_LNT_IMP_CAL_EN\t\tBIT(2)\n#define RG_DSI_LNT_TESTMODE_EN\t\tBIT(3)\n#define RG_DSI_LNT_IMP_CAL_CODE\t\tGENMASK(7, 4)\n#define RG_DSI_LNT_AIO_SEL\t\tGENMASK(10, 8)\n#define RG_DSI_PAD_TIE_LOW_EN\t\tBIT(11)\n#define RG_DSI_DEBUG_INPUT_EN\t\tBIT(12)\n#define RG_DSI_PRESERVE\t\t\tGENMASK(15, 13)\n\n#define MIPITX_DSI_BG_CON\t0x44\n#define RG_DSI_BG_CORE_EN\t\tBIT(0)\n#define RG_DSI_BG_CKEN\t\t\tBIT(1)\n#define RG_DSI_BG_DIV\t\t\tGENMASK(3, 2)\n#define RG_DSI_BG_FAST_CHARGE\t\tBIT(4)\n\n#define RG_DSI_V12_SEL\t\t\tGENMASK(7, 5)\n#define RG_DSI_V10_SEL\t\t\tGENMASK(10, 8)\n#define RG_DSI_V072_SEL\t\t\tGENMASK(13, 11)\n#define RG_DSI_V04_SEL\t\t\tGENMASK(16, 14)\n#define RG_DSI_V032_SEL\t\t\tGENMASK(19, 17)\n#define RG_DSI_V02_SEL\t\t\tGENMASK(22, 20)\n#define RG_DSI_VOUT_MSK\t\t\t\\\n\t\t(RG_DSI_V12_SEL | RG_DSI_V10_SEL | RG_DSI_V072_SEL | \\\n\t\t RG_DSI_V04_SEL | RG_DSI_V032_SEL | RG_DSI_V02_SEL)\n#define RG_DSI_BG_R1_TRIM\t\tGENMASK(27, 24)\n#define RG_DSI_BG_R2_TRIM\t\tGENMASK(31, 28)\n\n#define MIPITX_DSI_PLL_CON0\t0x50\n#define RG_DSI_MPPLL_PLL_EN\t\tBIT(0)\n#define RG_DSI_MPPLL_PREDIV\t\tGENMASK(2, 1)\n#define RG_DSI_MPPLL_TXDIV0\t\tGENMASK(4, 3)\n#define RG_DSI_MPPLL_TXDIV1\t\tGENMASK(6, 5)\n#define RG_DSI_MPPLL_POSDIV\t\tGENMASK(9, 7)\n#define RG_DSI_MPPLL_DIV_MSK\t\t\\\n\t\t(RG_DSI_MPPLL_PREDIV | RG_DSI_MPPLL_TXDIV0 | \\\n\t\t RG_DSI_MPPLL_TXDIV1 | RG_DSI_MPPLL_POSDIV)\n#define RG_DSI_MPPLL_MONVC_EN\t\tBIT(10)\n#define RG_DSI_MPPLL_MONREF_EN\t\tBIT(11)\n#define RG_DSI_MPPLL_VOD_EN\t\tBIT(12)\n\n#define MIPITX_DSI_PLL_CON1\t0x54\n#define RG_DSI_MPPLL_SDM_FRA_EN\t\tBIT(0)\n#define RG_DSI_MPPLL_SDM_SSC_PH_INIT\tBIT(1)\n#define RG_DSI_MPPLL_SDM_SSC_EN\t\tBIT(2)\n#define RG_DSI_MPPLL_SDM_SSC_PRD\tGENMASK(31, 16)\n\n#define MIPITX_DSI_PLL_CON2\t0x58\n\n#define MIPITX_DSI_PLL_TOP\t0x64\n#define RG_DSI_MPPLL_PRESERVE\t\tGENMASK(15, 8)\n\n#define MIPITX_DSI_PLL_PWR\t0x68\n#define RG_DSI_MPPLL_SDM_PWR_ON\t\tBIT(0)\n#define RG_DSI_MPPLL_SDM_ISO_EN\t\tBIT(1)\n#define RG_DSI_MPPLL_SDM_PWR_ACK\tBIT(8)\n\n#define MIPITX_DSI_SW_CTRL\t0x80\n#define SW_CTRL_EN\t\t\tBIT(0)\n\n#define MIPITX_DSI_SW_CTRL_CON0\t0x84\n#define SW_LNTC_LPTX_PRE_OE\t\tBIT(0)\n#define SW_LNTC_LPTX_OE\t\t\tBIT(1)\n#define SW_LNTC_LPTX_P\t\t\tBIT(2)\n#define SW_LNTC_LPTX_N\t\t\tBIT(3)\n#define SW_LNTC_HSTX_PRE_OE\t\tBIT(4)\n#define SW_LNTC_HSTX_OE\t\t\tBIT(5)\n#define SW_LNTC_HSTX_ZEROCLK\t\tBIT(6)\n#define SW_LNT0_LPTX_PRE_OE\t\tBIT(7)\n#define SW_LNT0_LPTX_OE\t\t\tBIT(8)\n#define SW_LNT0_LPTX_P\t\t\tBIT(9)\n#define SW_LNT0_LPTX_N\t\t\tBIT(10)\n#define SW_LNT0_HSTX_PRE_OE\t\tBIT(11)\n#define SW_LNT0_HSTX_OE\t\t\tBIT(12)\n#define SW_LNT0_LPRX_EN\t\t\tBIT(13)\n#define SW_LNT1_LPTX_PRE_OE\t\tBIT(14)\n#define SW_LNT1_LPTX_OE\t\t\tBIT(15)\n#define SW_LNT1_LPTX_P\t\t\tBIT(16)\n#define SW_LNT1_LPTX_N\t\t\tBIT(17)\n#define SW_LNT1_HSTX_PRE_OE\t\tBIT(18)\n#define SW_LNT1_HSTX_OE\t\t\tBIT(19)\n#define SW_LNT2_LPTX_PRE_OE\t\tBIT(20)\n#define SW_LNT2_LPTX_OE\t\t\tBIT(21)\n#define SW_LNT2_LPTX_P\t\t\tBIT(22)\n#define SW_LNT2_LPTX_N\t\t\tBIT(23)\n#define SW_LNT2_HSTX_PRE_OE\t\tBIT(24)\n#define SW_LNT2_HSTX_OE\t\t\tBIT(25)\n\nstatic int mtk_mipi_tx_pll_prepare(struct clk_hw *hw)\n{\n\tstruct mtk_mipi_tx *mipi_tx = mtk_mipi_tx_from_clk_hw(hw);\n\tvoid __iomem *base = mipi_tx->regs;\n\tu8 txdiv, txdiv0, txdiv1;\n\tu64 pcw;\n\n\tdev_dbg(mipi_tx->dev, \"prepare: %u Hz\\n\", mipi_tx->data_rate);\n\n\tif (mipi_tx->data_rate >= 500000000) {\n\t\ttxdiv = 1;\n\t\ttxdiv0 = 0;\n\t\ttxdiv1 = 0;\n\t} else if (mipi_tx->data_rate >= 250000000) {\n\t\ttxdiv = 2;\n\t\ttxdiv0 = 1;\n\t\ttxdiv1 = 0;\n\t} else if (mipi_tx->data_rate >= 125000000) {\n\t\ttxdiv = 4;\n\t\ttxdiv0 = 2;\n\t\ttxdiv1 = 0;\n\t} else if (mipi_tx->data_rate > 62000000) {\n\t\ttxdiv = 8;\n\t\ttxdiv0 = 2;\n\t\ttxdiv1 = 1;\n\t} else if (mipi_tx->data_rate >= 50000000) {\n\t\ttxdiv = 16;\n\t\ttxdiv0 = 2;\n\t\ttxdiv1 = 2;\n\t} else {\n\t\treturn -EINVAL;\n\t}\n\n\tmtk_phy_update_bits(base + MIPITX_DSI_BG_CON,\n\t\t\t    RG_DSI_VOUT_MSK | RG_DSI_BG_CKEN |\n\t\t\t    RG_DSI_BG_CORE_EN,\n\t\t\t    FIELD_PREP(RG_DSI_V02_SEL, 4) |\n\t\t\t    FIELD_PREP(RG_DSI_V032_SEL, 4) |\n\t\t\t    FIELD_PREP(RG_DSI_V04_SEL, 4) |\n\t\t\t    FIELD_PREP(RG_DSI_V072_SEL, 4) |\n\t\t\t    FIELD_PREP(RG_DSI_V10_SEL, 4) |\n\t\t\t    FIELD_PREP(RG_DSI_V12_SEL, 4) |\n\t\t\t    RG_DSI_BG_CKEN | RG_DSI_BG_CORE_EN);\n\n\tusleep_range(30, 100);\n\n\tmtk_phy_update_bits(base + MIPITX_DSI_TOP_CON,\n\t\t\t    RG_DSI_LNT_IMP_CAL_CODE | RG_DSI_LNT_HS_BIAS_EN,\n\t\t\t    FIELD_PREP(RG_DSI_LNT_IMP_CAL_CODE, 8) |\n\t\t\t    RG_DSI_LNT_HS_BIAS_EN);\n\n\tmtk_phy_set_bits(base + MIPITX_DSI_CON,\n\t\t\t RG_DSI_CKG_LDOOUT_EN | RG_DSI_LDOCORE_EN);\n\n\tmtk_phy_update_bits(base + MIPITX_DSI_PLL_PWR,\n\t\t\t    RG_DSI_MPPLL_SDM_PWR_ON | RG_DSI_MPPLL_SDM_ISO_EN,\n\t\t\t    RG_DSI_MPPLL_SDM_PWR_ON);\n\n\tmtk_phy_clear_bits(base + MIPITX_DSI_PLL_CON0, RG_DSI_MPPLL_PLL_EN);\n\n\tmtk_phy_update_bits(base + MIPITX_DSI_PLL_CON0,\n\t\t\t    RG_DSI_MPPLL_TXDIV0 | RG_DSI_MPPLL_TXDIV1 |\n\t\t\t    RG_DSI_MPPLL_PREDIV,\n\t\t\t    FIELD_PREP(RG_DSI_MPPLL_TXDIV0, txdiv0) |\n\t\t\t    FIELD_PREP(RG_DSI_MPPLL_TXDIV1, txdiv1));\n\n\t \n\tpcw = div_u64(((u64)mipi_tx->data_rate * 2 * txdiv) << 24, 26000000);\n\twritel(pcw, base + MIPITX_DSI_PLL_CON2);\n\n\tmtk_phy_set_bits(base + MIPITX_DSI_PLL_CON1, RG_DSI_MPPLL_SDM_FRA_EN);\n\n\tmtk_phy_set_bits(base + MIPITX_DSI_PLL_CON0, RG_DSI_MPPLL_PLL_EN);\n\n\tusleep_range(20, 100);\n\n\tmtk_phy_clear_bits(base + MIPITX_DSI_PLL_CON1, RG_DSI_MPPLL_SDM_SSC_EN);\n\n\tmtk_phy_update_field(base + MIPITX_DSI_PLL_TOP,\n\t\t\t     RG_DSI_MPPLL_PRESERVE,\n\t\t\t     mipi_tx->driver_data->mppll_preserve);\n\n\treturn 0;\n}\n\nstatic void mtk_mipi_tx_pll_unprepare(struct clk_hw *hw)\n{\n\tstruct mtk_mipi_tx *mipi_tx = mtk_mipi_tx_from_clk_hw(hw);\n\tvoid __iomem *base = mipi_tx->regs;\n\n\tdev_dbg(mipi_tx->dev, \"unprepare\\n\");\n\n\tmtk_phy_clear_bits(base + MIPITX_DSI_PLL_CON0, RG_DSI_MPPLL_PLL_EN);\n\n\tmtk_phy_clear_bits(base + MIPITX_DSI_PLL_TOP, RG_DSI_MPPLL_PRESERVE);\n\n\tmtk_phy_update_bits(base + MIPITX_DSI_PLL_PWR,\n\t\t\t    RG_DSI_MPPLL_SDM_ISO_EN | RG_DSI_MPPLL_SDM_PWR_ON,\n\t\t\t    RG_DSI_MPPLL_SDM_ISO_EN);\n\n\tmtk_phy_clear_bits(base + MIPITX_DSI_TOP_CON, RG_DSI_LNT_HS_BIAS_EN);\n\n\tmtk_phy_clear_bits(base + MIPITX_DSI_CON,\n\t\t\t   RG_DSI_CKG_LDOOUT_EN | RG_DSI_LDOCORE_EN);\n\n\tmtk_phy_clear_bits(base + MIPITX_DSI_BG_CON,\n\t\t\t   RG_DSI_BG_CKEN | RG_DSI_BG_CORE_EN);\n\n\tmtk_phy_clear_bits(base + MIPITX_DSI_PLL_CON0, RG_DSI_MPPLL_DIV_MSK);\n}\n\nstatic long mtk_mipi_tx_pll_round_rate(struct clk_hw *hw, unsigned long rate,\n\t\t\t\t       unsigned long *prate)\n{\n\treturn clamp_val(rate, 50000000, 1250000000);\n}\n\nstatic const struct clk_ops mtk_mipi_tx_pll_ops = {\n\t.prepare = mtk_mipi_tx_pll_prepare,\n\t.unprepare = mtk_mipi_tx_pll_unprepare,\n\t.round_rate = mtk_mipi_tx_pll_round_rate,\n\t.set_rate = mtk_mipi_tx_pll_set_rate,\n\t.recalc_rate = mtk_mipi_tx_pll_recalc_rate,\n};\n\nstatic void mtk_mipi_tx_power_on_signal(struct phy *phy)\n{\n\tstruct mtk_mipi_tx *mipi_tx = phy_get_drvdata(phy);\n\tu32 reg;\n\n\tfor (reg = MIPITX_DSI_CLOCK_LANE;\n\t     reg <= MIPITX_DSI_DATA_LANE3; reg += 4)\n\t\tmtk_phy_set_bits(mipi_tx->regs + reg, RG_DSI_LNTx_LDOOUT_EN);\n\n\tmtk_phy_clear_bits(mipi_tx->regs + MIPITX_DSI_TOP_CON,\n\t\t\t   RG_DSI_PAD_TIE_LOW_EN);\n}\n\nstatic void mtk_mipi_tx_power_off_signal(struct phy *phy)\n{\n\tstruct mtk_mipi_tx *mipi_tx = phy_get_drvdata(phy);\n\tu32 reg;\n\n\tmtk_phy_set_bits(mipi_tx->regs + MIPITX_DSI_TOP_CON,\n\t\t\t RG_DSI_PAD_TIE_LOW_EN);\n\n\tfor (reg = MIPITX_DSI_CLOCK_LANE;\n\t     reg <= MIPITX_DSI_DATA_LANE3; reg += 4)\n\t\tmtk_phy_clear_bits(mipi_tx->regs + reg, RG_DSI_LNTx_LDOOUT_EN);\n}\n\nconst struct mtk_mipitx_data mt2701_mipitx_data = {\n\t.mppll_preserve = 3,\n\t.mipi_tx_clk_ops = &mtk_mipi_tx_pll_ops,\n\t.mipi_tx_enable_signal = mtk_mipi_tx_power_on_signal,\n\t.mipi_tx_disable_signal = mtk_mipi_tx_power_off_signal,\n};\n\nconst struct mtk_mipitx_data mt8173_mipitx_data = {\n\t.mppll_preserve = 0,\n\t.mipi_tx_clk_ops = &mtk_mipi_tx_pll_ops,\n\t.mipi_tx_enable_signal = mtk_mipi_tx_power_on_signal,\n\t.mipi_tx_disable_signal = mtk_mipi_tx_power_off_signal,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}