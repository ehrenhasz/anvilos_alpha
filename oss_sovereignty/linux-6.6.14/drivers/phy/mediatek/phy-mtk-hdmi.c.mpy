{
  "module_name": "phy-mtk-hdmi.c",
  "hash_id": "568822441ccd12122b7dd3ccbed4e64254a7ff8178461bfced50e479c4cddff6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/mediatek/phy-mtk-hdmi.c",
  "human_readable_source": "\n \n\n#include \"phy-mtk-hdmi.h\"\n\nstatic int mtk_hdmi_phy_power_on(struct phy *phy);\nstatic int mtk_hdmi_phy_power_off(struct phy *phy);\nstatic int mtk_hdmi_phy_configure(struct phy *phy, union phy_configure_opts *opts);\n\nstatic const struct phy_ops mtk_hdmi_phy_dev_ops = {\n\t.power_on = mtk_hdmi_phy_power_on,\n\t.power_off = mtk_hdmi_phy_power_off,\n\t.configure = mtk_hdmi_phy_configure,\n\t.owner = THIS_MODULE,\n};\n\ninline struct mtk_hdmi_phy *to_mtk_hdmi_phy(struct clk_hw *hw)\n{\n\treturn container_of(hw, struct mtk_hdmi_phy, pll_hw);\n}\n\nstatic int mtk_hdmi_phy_power_on(struct phy *phy)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = phy_get_drvdata(phy);\n\tint ret;\n\n\tret = clk_prepare_enable(hdmi_phy->pll);\n\tif (ret < 0)\n\t\treturn ret;\n\n\thdmi_phy->conf->hdmi_phy_enable_tmds(hdmi_phy);\n\treturn 0;\n}\n\nstatic int mtk_hdmi_phy_power_off(struct phy *phy)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = phy_get_drvdata(phy);\n\n\thdmi_phy->conf->hdmi_phy_disable_tmds(hdmi_phy);\n\tclk_disable_unprepare(hdmi_phy->pll);\n\n\treturn 0;\n}\n\nstatic int mtk_hdmi_phy_configure(struct phy *phy, union phy_configure_opts *opts)\n{\n\tstruct mtk_hdmi_phy *hdmi_phy = phy_get_drvdata(phy);\n\n\tif (hdmi_phy->conf->hdmi_phy_configure)\n\t\treturn hdmi_phy->conf->hdmi_phy_configure(phy, opts);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops *\nmtk_hdmi_phy_dev_get_ops(const struct mtk_hdmi_phy *hdmi_phy)\n{\n\tif (hdmi_phy && hdmi_phy->conf &&\n\t    hdmi_phy->conf->hdmi_phy_enable_tmds &&\n\t    hdmi_phy->conf->hdmi_phy_disable_tmds)\n\t\treturn &mtk_hdmi_phy_dev_ops;\n\n\tif (hdmi_phy)\n\t\tdev_err(hdmi_phy->dev, \"Failed to get dev ops of phy\\n\");\n\treturn NULL;\n}\n\nstatic void mtk_hdmi_phy_clk_get_data(struct mtk_hdmi_phy *hdmi_phy,\n\t\t\t\t      struct clk_init_data *clk_init)\n{\n\tclk_init->flags = hdmi_phy->conf->flags;\n\tclk_init->ops = hdmi_phy->conf->hdmi_phy_clk_ops;\n}\n\nstatic int mtk_hdmi_phy_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct mtk_hdmi_phy *hdmi_phy;\n\tstruct clk *ref_clk;\n\tconst char *ref_clk_name;\n\tstruct clk_init_data clk_init = {\n\t\t.num_parents = 1,\n\t\t.parent_names = (const char * const *)&ref_clk_name,\n\t};\n\n\tstruct phy *phy;\n\tstruct phy_provider *phy_provider;\n\tint ret;\n\n\thdmi_phy = devm_kzalloc(dev, sizeof(*hdmi_phy), GFP_KERNEL);\n\tif (!hdmi_phy)\n\t\treturn -ENOMEM;\n\n\thdmi_phy->regs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(hdmi_phy->regs))\n\t\treturn PTR_ERR(hdmi_phy->regs);\n\n\tref_clk = devm_clk_get(dev, \"pll_ref\");\n\tif (IS_ERR(ref_clk))\n\t\treturn dev_err_probe(dev, PTR_ERR(ref_clk),\n\t\t\t\t     \"Failed to get PLL reference clock\\n\");\n\n\tref_clk_name = __clk_get_name(ref_clk);\n\n\tret = of_property_read_string(dev->of_node, \"clock-output-names\",\n\t\t\t\t      &clk_init.name);\n\tif (ret < 0)\n\t\treturn dev_err_probe(dev, ret, \"Failed to read clock-output-names\\n\");\n\n\thdmi_phy->dev = dev;\n\thdmi_phy->conf =\n\t\t(struct mtk_hdmi_phy_conf *)of_device_get_match_data(dev);\n\tmtk_hdmi_phy_clk_get_data(hdmi_phy, &clk_init);\n\thdmi_phy->pll_hw.init = &clk_init;\n\thdmi_phy->pll = devm_clk_register(dev, &hdmi_phy->pll_hw);\n\tif (IS_ERR(hdmi_phy->pll))\n\t\treturn dev_err_probe(dev, PTR_ERR(hdmi_phy->pll),\n\t\t\t\t    \"Failed to register PLL\\n\");\n\n\tret = of_property_read_u32(dev->of_node, \"mediatek,ibias\",\n\t\t\t\t   &hdmi_phy->ibias);\n\tif (ret < 0)\n\t\treturn dev_err_probe(dev, ret, \"Failed to get ibias\\n\");\n\n\tret = of_property_read_u32(dev->of_node, \"mediatek,ibias_up\",\n\t\t\t\t   &hdmi_phy->ibias_up);\n\tif (ret < 0)\n\t\treturn dev_err_probe(dev, ret, \"Failed to get ibias_up\\n\");\n\n\tdev_info(dev, \"Using default TX DRV impedance: 4.2k/36\\n\");\n\thdmi_phy->drv_imp_clk = 0x30;\n\thdmi_phy->drv_imp_d2 = 0x30;\n\thdmi_phy->drv_imp_d1 = 0x30;\n\thdmi_phy->drv_imp_d0 = 0x30;\n\n\tphy = devm_phy_create(dev, NULL, mtk_hdmi_phy_dev_get_ops(hdmi_phy));\n\tif (IS_ERR(phy))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy), \"Cannot create HDMI PHY\\n\");\n\n\tphy_set_drvdata(phy, hdmi_phy);\n\n\tphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\n\tif (IS_ERR(phy_provider))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy_provider),\n\t\t\t\t     \"Failed to register HDMI PHY\\n\");\n\n\tif (hdmi_phy->conf->pll_default_off)\n\t\thdmi_phy->conf->hdmi_phy_disable_tmds(hdmi_phy);\n\n\treturn of_clk_add_provider(dev->of_node, of_clk_src_simple_get,\n\t\t\t\t   hdmi_phy->pll);\n}\n\nstatic const struct of_device_id mtk_hdmi_phy_match[] = {\n\t{ .compatible = \"mediatek,mt2701-hdmi-phy\",\n\t  .data = &mtk_hdmi_phy_2701_conf,\n\t},\n\t{ .compatible = \"mediatek,mt8173-hdmi-phy\",\n\t  .data = &mtk_hdmi_phy_8173_conf,\n\t},\n\t{ .compatible = \"mediatek,mt8195-hdmi-phy\",\n\t  .data = &mtk_hdmi_phy_8195_conf,\n\t},\n\t{},\n};\nMODULE_DEVICE_TABLE(of, mtk_hdmi_phy_match);\n\nstatic struct platform_driver mtk_hdmi_phy_driver = {\n\t.probe = mtk_hdmi_phy_probe,\n\t.driver = {\n\t\t.name = \"mediatek-hdmi-phy\",\n\t\t.of_match_table = mtk_hdmi_phy_match,\n\t},\n};\nmodule_platform_driver(mtk_hdmi_phy_driver);\n\nMODULE_DESCRIPTION(\"MediaTek HDMI PHY Driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}