{
  "module_name": "phy-exynos4x12-usb2.c",
  "hash_id": "581e7f30f53a541f0dbcf3251ff8749eb838133572accbb3f2ad09fb36c21a38",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/samsung/phy-exynos4x12-usb2.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/phy/phy.h>\n#include <linux/regmap.h>\n#include \"phy-samsung-usb2.h\"\n\n \n\n \n#define EXYNOS_4x12_UPHYPWR\t\t\t0x0\n\n#define EXYNOS_4x12_UPHYPWR_PHY0_SUSPEND\tBIT(0)\n#define EXYNOS_4x12_UPHYPWR_PHY0_PWR\t\tBIT(3)\n#define EXYNOS_4x12_UPHYPWR_PHY0_OTG_PWR\tBIT(4)\n#define EXYNOS_4x12_UPHYPWR_PHY0_SLEEP\t\tBIT(5)\n#define EXYNOS_4x12_UPHYPWR_PHY0 ( \\\n\tEXYNOS_4x12_UPHYPWR_PHY0_SUSPEND | \\\n\tEXYNOS_4x12_UPHYPWR_PHY0_PWR | \\\n\tEXYNOS_4x12_UPHYPWR_PHY0_OTG_PWR | \\\n\tEXYNOS_4x12_UPHYPWR_PHY0_SLEEP)\n\n#define EXYNOS_4x12_UPHYPWR_PHY1_SUSPEND\tBIT(6)\n#define EXYNOS_4x12_UPHYPWR_PHY1_PWR\t\tBIT(7)\n#define EXYNOS_4x12_UPHYPWR_PHY1_SLEEP\t\tBIT(8)\n#define EXYNOS_4x12_UPHYPWR_PHY1 ( \\\n\tEXYNOS_4x12_UPHYPWR_PHY1_SUSPEND | \\\n\tEXYNOS_4x12_UPHYPWR_PHY1_PWR | \\\n\tEXYNOS_4x12_UPHYPWR_PHY1_SLEEP)\n\n#define EXYNOS_4x12_UPHYPWR_HSIC0_SUSPEND\tBIT(9)\n#define EXYNOS_4x12_UPHYPWR_HSIC0_PWR\t\tBIT(10)\n#define EXYNOS_4x12_UPHYPWR_HSIC0_SLEEP\t\tBIT(11)\n#define EXYNOS_4x12_UPHYPWR_HSIC0 ( \\\n\tEXYNOS_4x12_UPHYPWR_HSIC0_SUSPEND | \\\n\tEXYNOS_4x12_UPHYPWR_HSIC0_PWR | \\\n\tEXYNOS_4x12_UPHYPWR_HSIC0_SLEEP)\n\n#define EXYNOS_4x12_UPHYPWR_HSIC1_SUSPEND\tBIT(12)\n#define EXYNOS_4x12_UPHYPWR_HSIC1_PWR\t\tBIT(13)\n#define EXYNOS_4x12_UPHYPWR_HSIC1_SLEEP\t\tBIT(14)\n#define EXYNOS_4x12_UPHYPWR_HSIC1 ( \\\n\tEXYNOS_4x12_UPHYPWR_HSIC1_SUSPEND | \\\n\tEXYNOS_4x12_UPHYPWR_HSIC1_PWR | \\\n\tEXYNOS_4x12_UPHYPWR_HSIC1_SLEEP)\n\n \n#define EXYNOS_4x12_UPHYCLK\t\t\t0x4\n\n#define EXYNOS_4x12_UPHYCLK_PHYFSEL_MASK\t(0x7 << 0)\n#define EXYNOS_4x12_UPHYCLK_PHYFSEL_OFFSET\t0\n#define EXYNOS_4x12_UPHYCLK_PHYFSEL_9MHZ6\t(0x0 << 0)\n#define EXYNOS_4x12_UPHYCLK_PHYFSEL_10MHZ\t(0x1 << 0)\n#define EXYNOS_4x12_UPHYCLK_PHYFSEL_12MHZ\t(0x2 << 0)\n#define EXYNOS_4x12_UPHYCLK_PHYFSEL_19MHZ2\t(0x3 << 0)\n#define EXYNOS_4x12_UPHYCLK_PHYFSEL_20MHZ\t(0x4 << 0)\n#define EXYNOS_4x12_UPHYCLK_PHYFSEL_24MHZ\t(0x5 << 0)\n#define EXYNOS_4x12_UPHYCLK_PHYFSEL_50MHZ\t(0x7 << 0)\n\n#define EXYNOS_3250_UPHYCLK_REFCLKSEL\t\t(0x2 << 8)\n\n#define EXYNOS_4x12_UPHYCLK_PHY0_ID_PULLUP\tBIT(3)\n#define EXYNOS_4x12_UPHYCLK_PHY0_COMMON_ON\tBIT(4)\n#define EXYNOS_4x12_UPHYCLK_PHY1_COMMON_ON\tBIT(7)\n\n#define EXYNOS_4x12_UPHYCLK_HSIC_REFCLK_MASK\t(0x7f << 10)\n#define EXYNOS_4x12_UPHYCLK_HSIC_REFCLK_OFFSET  10\n#define EXYNOS_4x12_UPHYCLK_HSIC_REFCLK_12MHZ\t(0x24 << 10)\n#define EXYNOS_4x12_UPHYCLK_HSIC_REFCLK_15MHZ\t(0x1c << 10)\n#define EXYNOS_4x12_UPHYCLK_HSIC_REFCLK_16MHZ\t(0x1a << 10)\n#define EXYNOS_4x12_UPHYCLK_HSIC_REFCLK_19MHZ2\t(0x15 << 10)\n#define EXYNOS_4x12_UPHYCLK_HSIC_REFCLK_20MHZ\t(0x14 << 10)\n\n \n#define EXYNOS_4x12_UPHYRST\t\t\t0x8\n\n#define EXYNOS_4x12_URSTCON_PHY0\t\tBIT(0)\n#define EXYNOS_4x12_URSTCON_OTG_HLINK\t\tBIT(1)\n#define EXYNOS_4x12_URSTCON_OTG_PHYLINK\t\tBIT(2)\n#define EXYNOS_4x12_URSTCON_HOST_PHY\t\tBIT(3)\n \n#define EXYNOS_4x12_URSTCON_PHY1\t\tBIT(4)\n#define EXYNOS_4x12_URSTCON_HSIC0\t\tBIT(6)\n#define EXYNOS_4x12_URSTCON_HSIC1\t\tBIT(5)\n#define EXYNOS_4x12_URSTCON_HOST_LINK_ALL\tBIT(7)\n#define EXYNOS_4x12_URSTCON_HOST_LINK_P0\tBIT(10)\n#define EXYNOS_4x12_URSTCON_HOST_LINK_P1\tBIT(9)\n#define EXYNOS_4x12_URSTCON_HOST_LINK_P2\tBIT(8)\n\n \n#define EXYNOS_4x12_USB_ISOL_OFFSET\t\t0x704\n#define EXYNOS_4x12_USB_ISOL_OTG\t\tBIT(0)\n#define EXYNOS_4x12_USB_ISOL_HSIC0_OFFSET\t0x708\n#define EXYNOS_4x12_USB_ISOL_HSIC0\t\tBIT(0)\n#define EXYNOS_4x12_USB_ISOL_HSIC1_OFFSET\t0x70c\n#define EXYNOS_4x12_USB_ISOL_HSIC1\t\tBIT(0)\n\n \n#define EXYNOS_4x12_MODE_SWITCH_OFFSET\t\t0x21c\n#define EXYNOS_4x12_MODE_SWITCH_MASK\t\t1\n#define EXYNOS_4x12_MODE_SWITCH_DEVICE\t\t0\n#define EXYNOS_4x12_MODE_SWITCH_HOST\t\t1\n\nenum exynos4x12_phy_id {\n\tEXYNOS4x12_DEVICE,\n\tEXYNOS4x12_HOST,\n\tEXYNOS4x12_HSIC0,\n\tEXYNOS4x12_HSIC1,\n\tEXYNOS4x12_NUM_PHYS,\n};\n\n \nstatic int exynos4x12_rate_to_clk(unsigned long rate, u32 *reg)\n{\n\t \n\n\tswitch (rate) {\n\tcase 9600 * KHZ:\n\t\t*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_9MHZ6;\n\t\tbreak;\n\tcase 10 * MHZ:\n\t\t*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_10MHZ;\n\t\tbreak;\n\tcase 12 * MHZ:\n\t\t*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_12MHZ;\n\t\tbreak;\n\tcase 19200 * KHZ:\n\t\t*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_19MHZ2;\n\t\tbreak;\n\tcase 20 * MHZ:\n\t\t*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_20MHZ;\n\t\tbreak;\n\tcase 24 * MHZ:\n\t\t*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_24MHZ;\n\t\tbreak;\n\tcase 50 * MHZ:\n\t\t*reg = EXYNOS_4x12_UPHYCLK_PHYFSEL_50MHZ;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void exynos4x12_isol(struct samsung_usb2_phy_instance *inst, bool on)\n{\n\tstruct samsung_usb2_phy_driver *drv = inst->drv;\n\tu32 offset;\n\tu32 mask;\n\n\tswitch (inst->cfg->id) {\n\tcase EXYNOS4x12_DEVICE:\n\tcase EXYNOS4x12_HOST:\n\t\toffset = EXYNOS_4x12_USB_ISOL_OFFSET;\n\t\tmask = EXYNOS_4x12_USB_ISOL_OTG;\n\t\tbreak;\n\tcase EXYNOS4x12_HSIC0:\n\t\toffset = EXYNOS_4x12_USB_ISOL_HSIC0_OFFSET;\n\t\tmask = EXYNOS_4x12_USB_ISOL_HSIC0;\n\t\tbreak;\n\tcase EXYNOS4x12_HSIC1:\n\t\toffset = EXYNOS_4x12_USB_ISOL_HSIC1_OFFSET;\n\t\tmask = EXYNOS_4x12_USB_ISOL_HSIC1;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tregmap_update_bits(drv->reg_pmu, offset, mask, on ? 0 : mask);\n}\n\nstatic void exynos4x12_setup_clk(struct samsung_usb2_phy_instance *inst)\n{\n\tstruct samsung_usb2_phy_driver *drv = inst->drv;\n\tu32 clk;\n\n\tclk = readl(drv->reg_phy + EXYNOS_4x12_UPHYCLK);\n\tclk &= ~EXYNOS_4x12_UPHYCLK_PHYFSEL_MASK;\n\n\tif (drv->cfg->has_refclk_sel)\n\t\tclk = EXYNOS_3250_UPHYCLK_REFCLKSEL;\n\n\tclk |= drv->ref_reg_val << EXYNOS_4x12_UPHYCLK_PHYFSEL_OFFSET;\n\tclk |= EXYNOS_4x12_UPHYCLK_PHY1_COMMON_ON;\n\twritel(clk, drv->reg_phy + EXYNOS_4x12_UPHYCLK);\n}\n\nstatic void exynos4x12_phy_pwr(struct samsung_usb2_phy_instance *inst, bool on)\n{\n\tstruct samsung_usb2_phy_driver *drv = inst->drv;\n\tu32 rstbits = 0;\n\tu32 phypwr = 0;\n\tu32 rst;\n\tu32 pwr;\n\n\tswitch (inst->cfg->id) {\n\tcase EXYNOS4x12_DEVICE:\n\t\tphypwr =\tEXYNOS_4x12_UPHYPWR_PHY0;\n\t\trstbits =\tEXYNOS_4x12_URSTCON_PHY0;\n\t\tbreak;\n\tcase EXYNOS4x12_HOST:\n\t\tphypwr =\tEXYNOS_4x12_UPHYPWR_PHY1;\n\t\trstbits =\tEXYNOS_4x12_URSTCON_HOST_PHY |\n\t\t\t\tEXYNOS_4x12_URSTCON_PHY1 |\n\t\t\t\tEXYNOS_4x12_URSTCON_HOST_LINK_P0;\n\t\tbreak;\n\tcase EXYNOS4x12_HSIC0:\n\t\tphypwr =\tEXYNOS_4x12_UPHYPWR_HSIC0;\n\t\trstbits =\tEXYNOS_4x12_URSTCON_HSIC0 |\n\t\t\t\tEXYNOS_4x12_URSTCON_HOST_LINK_P1;\n\t\tbreak;\n\tcase EXYNOS4x12_HSIC1:\n\t\tphypwr =\tEXYNOS_4x12_UPHYPWR_HSIC1;\n\t\trstbits =\tEXYNOS_4x12_URSTCON_HSIC1 |\n\t\t\t\tEXYNOS_4x12_URSTCON_HOST_LINK_P1;\n\t\tbreak;\n\t}\n\n\tif (on) {\n\t\tpwr = readl(drv->reg_phy + EXYNOS_4x12_UPHYPWR);\n\t\tpwr &= ~phypwr;\n\t\twritel(pwr, drv->reg_phy + EXYNOS_4x12_UPHYPWR);\n\n\t\trst = readl(drv->reg_phy + EXYNOS_4x12_UPHYRST);\n\t\trst |= rstbits;\n\t\twritel(rst, drv->reg_phy + EXYNOS_4x12_UPHYRST);\n\t\tudelay(10);\n\t\trst &= ~rstbits;\n\t\twritel(rst, drv->reg_phy + EXYNOS_4x12_UPHYRST);\n\t\t \n\t\tudelay(80);\n\t} else {\n\t\tpwr = readl(drv->reg_phy + EXYNOS_4x12_UPHYPWR);\n\t\tpwr |= phypwr;\n\t\twritel(pwr, drv->reg_phy + EXYNOS_4x12_UPHYPWR);\n\t}\n}\n\nstatic void exynos4x12_power_on_int(struct samsung_usb2_phy_instance *inst)\n{\n\tif (inst->int_cnt++ > 0)\n\t\treturn;\n\n\texynos4x12_setup_clk(inst);\n\texynos4x12_isol(inst, 0);\n\texynos4x12_phy_pwr(inst, 1);\n}\n\nstatic int exynos4x12_power_on(struct samsung_usb2_phy_instance *inst)\n{\n\tstruct samsung_usb2_phy_driver *drv = inst->drv;\n\n\tif (inst->ext_cnt++ > 0)\n\t\treturn 0;\n\n\tif (inst->cfg->id == EXYNOS4x12_HOST) {\n\t\tregmap_update_bits(drv->reg_sys, EXYNOS_4x12_MODE_SWITCH_OFFSET,\n\t\t\t\t\t\tEXYNOS_4x12_MODE_SWITCH_MASK,\n\t\t\t\t\t\tEXYNOS_4x12_MODE_SWITCH_HOST);\n\t\texynos4x12_power_on_int(&drv->instances[EXYNOS4x12_DEVICE]);\n\t}\n\n\tif (inst->cfg->id == EXYNOS4x12_DEVICE && drv->cfg->has_mode_switch)\n\t\tregmap_update_bits(drv->reg_sys, EXYNOS_4x12_MODE_SWITCH_OFFSET,\n\t\t\t\t\t\tEXYNOS_4x12_MODE_SWITCH_MASK,\n\t\t\t\t\t\tEXYNOS_4x12_MODE_SWITCH_DEVICE);\n\n\tif (inst->cfg->id == EXYNOS4x12_HSIC0 ||\n\t\tinst->cfg->id == EXYNOS4x12_HSIC1) {\n\t\texynos4x12_power_on_int(&drv->instances[EXYNOS4x12_DEVICE]);\n\t\texynos4x12_power_on_int(&drv->instances[EXYNOS4x12_HOST]);\n\t}\n\n\texynos4x12_power_on_int(inst);\n\n\treturn 0;\n}\n\nstatic void exynos4x12_power_off_int(struct samsung_usb2_phy_instance *inst)\n{\n\tif (inst->int_cnt-- > 1)\n\t\treturn;\n\n\texynos4x12_isol(inst, 1);\n\texynos4x12_phy_pwr(inst, 0);\n}\n\nstatic int exynos4x12_power_off(struct samsung_usb2_phy_instance *inst)\n{\n\tstruct samsung_usb2_phy_driver *drv = inst->drv;\n\n\tif (inst->ext_cnt-- > 1)\n\t\treturn 0;\n\n\tif (inst->cfg->id == EXYNOS4x12_DEVICE && drv->cfg->has_mode_switch)\n\t\tregmap_update_bits(drv->reg_sys, EXYNOS_4x12_MODE_SWITCH_OFFSET,\n\t\t\t\t\t\tEXYNOS_4x12_MODE_SWITCH_MASK,\n\t\t\t\t\t\tEXYNOS_4x12_MODE_SWITCH_HOST);\n\n\tif (inst->cfg->id == EXYNOS4x12_HOST)\n\t\texynos4x12_power_off_int(&drv->instances[EXYNOS4x12_DEVICE]);\n\n\tif (inst->cfg->id == EXYNOS4x12_HSIC0 ||\n\t\tinst->cfg->id == EXYNOS4x12_HSIC1) {\n\t\texynos4x12_power_off_int(&drv->instances[EXYNOS4x12_DEVICE]);\n\t\texynos4x12_power_off_int(&drv->instances[EXYNOS4x12_HOST]);\n\t}\n\n\texynos4x12_power_off_int(inst);\n\n\treturn 0;\n}\n\n\nstatic const struct samsung_usb2_common_phy exynos4x12_phys[] = {\n\t{\n\t\t.label\t\t= \"device\",\n\t\t.id\t\t= EXYNOS4x12_DEVICE,\n\t\t.power_on\t= exynos4x12_power_on,\n\t\t.power_off\t= exynos4x12_power_off,\n\t},\n\t{\n\t\t.label\t\t= \"host\",\n\t\t.id\t\t= EXYNOS4x12_HOST,\n\t\t.power_on\t= exynos4x12_power_on,\n\t\t.power_off\t= exynos4x12_power_off,\n\t},\n\t{\n\t\t.label\t\t= \"hsic0\",\n\t\t.id\t\t= EXYNOS4x12_HSIC0,\n\t\t.power_on\t= exynos4x12_power_on,\n\t\t.power_off\t= exynos4x12_power_off,\n\t},\n\t{\n\t\t.label\t\t= \"hsic1\",\n\t\t.id\t\t= EXYNOS4x12_HSIC1,\n\t\t.power_on\t= exynos4x12_power_on,\n\t\t.power_off\t= exynos4x12_power_off,\n\t},\n};\n\nconst struct samsung_usb2_phy_config exynos3250_usb2_phy_config = {\n\t.has_refclk_sel\t\t= 1,\n\t.num_phys\t\t= 1,\n\t.phys\t\t\t= exynos4x12_phys,\n\t.rate_to_clk\t\t= exynos4x12_rate_to_clk,\n};\n\nconst struct samsung_usb2_phy_config exynos4x12_usb2_phy_config = {\n\t.has_mode_switch\t= 1,\n\t.num_phys\t\t= EXYNOS4x12_NUM_PHYS,\n\t.phys\t\t\t= exynos4x12_phys,\n\t.rate_to_clk\t\t= exynos4x12_rate_to_clk,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}