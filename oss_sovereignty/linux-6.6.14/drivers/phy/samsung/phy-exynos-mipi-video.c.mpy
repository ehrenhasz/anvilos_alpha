{
  "module_name": "phy-exynos-mipi-video.c",
  "hash_id": "c451511a1f0f345baf038909dc4d451086db60190338edde68521c18d2436d00",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/samsung/phy-exynos-mipi-video.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/spinlock.h>\n#include <linux/soc/samsung/exynos-regs-pmu.h>\n#include <linux/mfd/syscon.h>\n\nenum exynos_mipi_phy_id {\n\tEXYNOS_MIPI_PHY_ID_NONE = -1,\n\tEXYNOS_MIPI_PHY_ID_CSIS0,\n\tEXYNOS_MIPI_PHY_ID_DSIM0,\n\tEXYNOS_MIPI_PHY_ID_CSIS1,\n\tEXYNOS_MIPI_PHY_ID_DSIM1,\n\tEXYNOS_MIPI_PHY_ID_CSIS2,\n\tEXYNOS_MIPI_PHYS_NUM\n};\n\nenum exynos_mipi_phy_regmap_id {\n\tEXYNOS_MIPI_REGMAP_PMU,\n\tEXYNOS_MIPI_REGMAP_DISP,\n\tEXYNOS_MIPI_REGMAP_CAM0,\n\tEXYNOS_MIPI_REGMAP_CAM1,\n\tEXYNOS_MIPI_REGMAPS_NUM\n};\n\nstruct mipi_phy_device_desc {\n\tint num_phys;\n\tint num_regmaps;\n\tconst char *regmap_names[EXYNOS_MIPI_REGMAPS_NUM];\n\tstruct exynos_mipi_phy_desc {\n\t\tenum exynos_mipi_phy_id\tcoupled_phy_id;\n\t\tu32 enable_val;\n\t\tunsigned int enable_reg;\n\t\tenum exynos_mipi_phy_regmap_id enable_map;\n\t\tu32 resetn_val;\n\t\tunsigned int resetn_reg;\n\t\tenum exynos_mipi_phy_regmap_id resetn_map;\n\t} phys[EXYNOS_MIPI_PHYS_NUM];\n};\n\nstatic const struct mipi_phy_device_desc s5pv210_mipi_phy = {\n\t.num_regmaps = 1,\n\t.regmap_names = {\"syscon\"},\n\t.num_phys = 4,\n\t.phys = {\n\t\t{\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_DSIM0,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS4_MIPI_PHY_CONTROL(0),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = EXYNOS4_MIPI_PHY_SRESETN,\n\t\t\t.resetn_reg = EXYNOS4_MIPI_PHY_CONTROL(0),\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_CSIS0,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS4_MIPI_PHY_CONTROL(0),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = EXYNOS4_MIPI_PHY_MRESETN,\n\t\t\t.resetn_reg = EXYNOS4_MIPI_PHY_CONTROL(0),\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_DSIM1,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS4_MIPI_PHY_CONTROL(1),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = EXYNOS4_MIPI_PHY_SRESETN,\n\t\t\t.resetn_reg = EXYNOS4_MIPI_PHY_CONTROL(1),\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_CSIS1,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS4_MIPI_PHY_CONTROL(1),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = EXYNOS4_MIPI_PHY_MRESETN,\n\t\t\t.resetn_reg = EXYNOS4_MIPI_PHY_CONTROL(1),\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t},\n\t},\n};\n\nstatic const struct mipi_phy_device_desc exynos5420_mipi_phy = {\n\t.num_regmaps = 1,\n\t.regmap_names = {\"syscon\"},\n\t.num_phys = 5,\n\t.phys = {\n\t\t{\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_DSIM0,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS5420_MIPI_PHY_CONTROL(0),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = EXYNOS4_MIPI_PHY_SRESETN,\n\t\t\t.resetn_reg = EXYNOS5420_MIPI_PHY_CONTROL(0),\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_CSIS0,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS5420_MIPI_PHY_CONTROL(0),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = EXYNOS4_MIPI_PHY_MRESETN,\n\t\t\t.resetn_reg = EXYNOS5420_MIPI_PHY_CONTROL(0),\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_DSIM1,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS5420_MIPI_PHY_CONTROL(1),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = EXYNOS4_MIPI_PHY_SRESETN,\n\t\t\t.resetn_reg = EXYNOS5420_MIPI_PHY_CONTROL(1),\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_CSIS1,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS5420_MIPI_PHY_CONTROL(1),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = EXYNOS4_MIPI_PHY_MRESETN,\n\t\t\t.resetn_reg = EXYNOS5420_MIPI_PHY_CONTROL(1),\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_NONE,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS5420_MIPI_PHY_CONTROL(2),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = EXYNOS4_MIPI_PHY_SRESETN,\n\t\t\t.resetn_reg = EXYNOS5420_MIPI_PHY_CONTROL(2),\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t},\n\t},\n};\n\n#define EXYNOS5433_SYSREG_DISP_MIPI_PHY\t\t0x100C\n#define EXYNOS5433_SYSREG_CAM0_MIPI_DPHY_CON\t0x1014\n#define EXYNOS5433_SYSREG_CAM1_MIPI_DPHY_CON\t0x1020\n\nstatic const struct mipi_phy_device_desc exynos5433_mipi_phy = {\n\t.num_regmaps = 4,\n\t.regmap_names = {\n\t\t\"samsung,pmu-syscon\",\n\t\t\"samsung,disp-sysreg\",\n\t\t\"samsung,cam0-sysreg\",\n\t\t\"samsung,cam1-sysreg\"\n\t},\n\t.num_phys = 5,\n\t.phys = {\n\t\t{\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_DSIM0,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS4_MIPI_PHY_CONTROL(0),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = BIT(0),\n\t\t\t.resetn_reg = EXYNOS5433_SYSREG_CAM0_MIPI_DPHY_CON,\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_CAM0,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_CSIS0,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS4_MIPI_PHY_CONTROL(0),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = BIT(0),\n\t\t\t.resetn_reg = EXYNOS5433_SYSREG_DISP_MIPI_PHY,\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_DISP,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_NONE,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS4_MIPI_PHY_CONTROL(1),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = BIT(1),\n\t\t\t.resetn_reg = EXYNOS5433_SYSREG_CAM0_MIPI_DPHY_CON,\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_CAM0,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_NONE,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS4_MIPI_PHY_CONTROL(1),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = BIT(1),\n\t\t\t.resetn_reg = EXYNOS5433_SYSREG_DISP_MIPI_PHY,\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_DISP,\n\t\t}, {\n\t\t\t \n\t\t\t.coupled_phy_id = EXYNOS_MIPI_PHY_ID_NONE,\n\t\t\t.enable_val = EXYNOS4_PHY_ENABLE,\n\t\t\t.enable_reg = EXYNOS4_MIPI_PHY_CONTROL(2),\n\t\t\t.enable_map = EXYNOS_MIPI_REGMAP_PMU,\n\t\t\t.resetn_val = BIT(0),\n\t\t\t.resetn_reg = EXYNOS5433_SYSREG_CAM1_MIPI_DPHY_CON,\n\t\t\t.resetn_map = EXYNOS_MIPI_REGMAP_CAM1,\n\t\t},\n\t},\n};\n\nstruct exynos_mipi_video_phy {\n\tstruct regmap *regmaps[EXYNOS_MIPI_REGMAPS_NUM];\n\tint num_phys;\n\tstruct video_phy_desc {\n\t\tstruct phy *phy;\n\t\tunsigned int index;\n\t\tconst struct exynos_mipi_phy_desc *data;\n\t} phys[EXYNOS_MIPI_PHYS_NUM];\n\tspinlock_t slock;\n};\n\nstatic int __set_phy_state(const struct exynos_mipi_phy_desc *data,\n\t\t\t   struct exynos_mipi_video_phy *state, unsigned int on)\n{\n\tstruct regmap *enable_map = state->regmaps[data->enable_map];\n\tstruct regmap *resetn_map = state->regmaps[data->resetn_map];\n\n\tspin_lock(&state->slock);\n\n\t \n\tif (!on && data->coupled_phy_id >= 0 &&\n\t    state->phys[data->coupled_phy_id].phy->power_count == 0)\n\t\tregmap_update_bits(enable_map, data->enable_reg,\n\t\t\t\t   data->enable_val, 0);\n\t \n\tif (on)\n\t\tregmap_update_bits(resetn_map, data->resetn_reg,\n\t\t\t\t   data->resetn_val, data->resetn_val);\n\telse\n\t\tregmap_update_bits(resetn_map, data->resetn_reg,\n\t\t\t\t   data->resetn_val, 0);\n\t \n\tif (on)\n\t\tregmap_update_bits(enable_map, data->enable_reg,\n\t\t\t\t   data->enable_val, data->enable_val);\n\n\tspin_unlock(&state->slock);\n\n\treturn 0;\n}\n\n#define to_mipi_video_phy(desc) \\\n\tcontainer_of((desc), struct exynos_mipi_video_phy, phys[(desc)->index])\n\nstatic int exynos_mipi_video_phy_power_on(struct phy *phy)\n{\n\tstruct video_phy_desc *phy_desc = phy_get_drvdata(phy);\n\tstruct exynos_mipi_video_phy *state = to_mipi_video_phy(phy_desc);\n\n\treturn __set_phy_state(phy_desc->data, state, 1);\n}\n\nstatic int exynos_mipi_video_phy_power_off(struct phy *phy)\n{\n\tstruct video_phy_desc *phy_desc = phy_get_drvdata(phy);\n\tstruct exynos_mipi_video_phy *state = to_mipi_video_phy(phy_desc);\n\n\treturn __set_phy_state(phy_desc->data, state, 0);\n}\n\nstatic struct phy *exynos_mipi_video_phy_xlate(struct device *dev,\n\t\t\t\t\tstruct of_phandle_args *args)\n{\n\tstruct exynos_mipi_video_phy *state = dev_get_drvdata(dev);\n\n\tif (WARN_ON(args->args[0] >= state->num_phys))\n\t\treturn ERR_PTR(-ENODEV);\n\n\treturn state->phys[args->args[0]].phy;\n}\n\nstatic const struct phy_ops exynos_mipi_video_phy_ops = {\n\t.power_on\t= exynos_mipi_video_phy_power_on,\n\t.power_off\t= exynos_mipi_video_phy_power_off,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int exynos_mipi_video_phy_probe(struct platform_device *pdev)\n{\n\tconst struct mipi_phy_device_desc *phy_dev;\n\tstruct exynos_mipi_video_phy *state;\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *np = dev->of_node;\n\tstruct phy_provider *phy_provider;\n\tunsigned int i = 0;\n\n\tphy_dev = of_device_get_match_data(dev);\n\tif (!phy_dev)\n\t\treturn -ENODEV;\n\n\tstate = devm_kzalloc(dev, sizeof(*state), GFP_KERNEL);\n\tif (!state)\n\t\treturn -ENOMEM;\n\n\tstate->regmaps[i] = syscon_node_to_regmap(dev->parent->of_node);\n\tif (!IS_ERR(state->regmaps[i]))\n\t\ti++;\n\tfor (; i < phy_dev->num_regmaps; i++) {\n\t\tstate->regmaps[i] = syscon_regmap_lookup_by_phandle(np,\n\t\t\t\t\t\tphy_dev->regmap_names[i]);\n\t\tif (IS_ERR(state->regmaps[i]))\n\t\t\treturn PTR_ERR(state->regmaps[i]);\n\t}\n\tstate->num_phys = phy_dev->num_phys;\n\tspin_lock_init(&state->slock);\n\n\tdev_set_drvdata(dev, state);\n\n\tfor (i = 0; i < state->num_phys; i++) {\n\t\tstruct phy *phy = devm_phy_create(dev, NULL,\n\t\t\t\t\t\t  &exynos_mipi_video_phy_ops);\n\t\tif (IS_ERR(phy)) {\n\t\t\tdev_err(dev, \"failed to create PHY %d\\n\", i);\n\t\t\treturn PTR_ERR(phy);\n\t\t}\n\n\t\tstate->phys[i].phy = phy;\n\t\tstate->phys[i].index = i;\n\t\tstate->phys[i].data = &phy_dev->phys[i];\n\t\tphy_set_drvdata(phy, &state->phys[i]);\n\t}\n\n\tphy_provider = devm_of_phy_provider_register(dev,\n\t\t\t\t\texynos_mipi_video_phy_xlate);\n\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct of_device_id exynos_mipi_video_phy_of_match[] = {\n\t{\n\t\t.compatible = \"samsung,s5pv210-mipi-video-phy\",\n\t\t.data = &s5pv210_mipi_phy,\n\t}, {\n\t\t.compatible = \"samsung,exynos5420-mipi-video-phy\",\n\t\t.data = &exynos5420_mipi_phy,\n\t}, {\n\t\t.compatible = \"samsung,exynos5433-mipi-video-phy\",\n\t\t.data = &exynos5433_mipi_phy,\n\t},\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, exynos_mipi_video_phy_of_match);\n\nstatic struct platform_driver exynos_mipi_video_phy_driver = {\n\t.probe\t= exynos_mipi_video_phy_probe,\n\t.driver = {\n\t\t.of_match_table\t= exynos_mipi_video_phy_of_match,\n\t\t.name  = \"exynos-mipi-video-phy\",\n\t\t.suppress_bind_attrs = true,\n\t}\n};\nmodule_platform_driver(exynos_mipi_video_phy_driver);\n\nMODULE_DESCRIPTION(\"Samsung S5P/Exynos SoC MIPI CSI-2/DSI PHY driver\");\nMODULE_AUTHOR(\"Sylwester Nawrocki <s.nawrocki@samsung.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}