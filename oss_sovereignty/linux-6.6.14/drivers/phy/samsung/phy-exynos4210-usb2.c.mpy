{
  "module_name": "phy-exynos4210-usb2.c",
  "hash_id": "fe090868e025865ab13f54f7d5556cf3207777484e5e2df0b63a5aa6645b7130",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/samsung/phy-exynos4210-usb2.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/phy/phy.h>\n#include <linux/regmap.h>\n#include \"phy-samsung-usb2.h\"\n\n \n\n \n#define EXYNOS_4210_UPHYPWR\t\t\t0x0\n\n#define EXYNOS_4210_UPHYPWR_PHY0_SUSPEND\tBIT(0)\n#define EXYNOS_4210_UPHYPWR_PHY0_PWR\t\tBIT(3)\n#define EXYNOS_4210_UPHYPWR_PHY0_OTG_PWR\tBIT(4)\n#define EXYNOS_4210_UPHYPWR_PHY0_SLEEP\t\tBIT(5)\n#define EXYNOS_4210_UPHYPWR_PHY0\t( \\\n\tEXYNOS_4210_UPHYPWR_PHY0_SUSPEND | \\\n\tEXYNOS_4210_UPHYPWR_PHY0_PWR | \\\n\tEXYNOS_4210_UPHYPWR_PHY0_OTG_PWR | \\\n\tEXYNOS_4210_UPHYPWR_PHY0_SLEEP)\n\n#define EXYNOS_4210_UPHYPWR_PHY1_SUSPEND\tBIT(6)\n#define EXYNOS_4210_UPHYPWR_PHY1_PWR\t\tBIT(7)\n#define EXYNOS_4210_UPHYPWR_PHY1_SLEEP\t\tBIT(8)\n#define EXYNOS_4210_UPHYPWR_PHY1 ( \\\n\tEXYNOS_4210_UPHYPWR_PHY1_SUSPEND | \\\n\tEXYNOS_4210_UPHYPWR_PHY1_PWR | \\\n\tEXYNOS_4210_UPHYPWR_PHY1_SLEEP)\n\n#define EXYNOS_4210_UPHYPWR_HSIC0_SUSPEND\tBIT(9)\n#define EXYNOS_4210_UPHYPWR_HSIC0_SLEEP\t\tBIT(10)\n#define EXYNOS_4210_UPHYPWR_HSIC0 ( \\\n\tEXYNOS_4210_UPHYPWR_HSIC0_SUSPEND | \\\n\tEXYNOS_4210_UPHYPWR_HSIC0_SLEEP)\n\n#define EXYNOS_4210_UPHYPWR_HSIC1_SUSPEND\tBIT(11)\n#define EXYNOS_4210_UPHYPWR_HSIC1_SLEEP\t\tBIT(12)\n#define EXYNOS_4210_UPHYPWR_HSIC1 ( \\\n\tEXYNOS_4210_UPHYPWR_HSIC1_SUSPEND | \\\n\tEXYNOS_4210_UPHYPWR_HSIC1_SLEEP)\n\n \n#define EXYNOS_4210_UPHYCLK\t\t\t0x4\n\n#define EXYNOS_4210_UPHYCLK_PHYFSEL_MASK\t(0x3 << 0)\n#define EXYNOS_4210_UPHYCLK_PHYFSEL_OFFSET\t0\n#define EXYNOS_4210_UPHYCLK_PHYFSEL_48MHZ\t(0x0 << 0)\n#define EXYNOS_4210_UPHYCLK_PHYFSEL_24MHZ\t(0x3 << 0)\n#define EXYNOS_4210_UPHYCLK_PHYFSEL_12MHZ\t(0x2 << 0)\n\n#define EXYNOS_4210_UPHYCLK_PHY0_ID_PULLUP\tBIT(2)\n#define EXYNOS_4210_UPHYCLK_PHY0_COMMON_ON\tBIT(4)\n#define EXYNOS_4210_UPHYCLK_PHY1_COMMON_ON\tBIT(7)\n\n \n#define EXYNOS_4210_UPHYRST\t\t\t0x8\n\n#define EXYNOS_4210_URSTCON_PHY0\t\tBIT(0)\n#define EXYNOS_4210_URSTCON_OTG_HLINK\t\tBIT(1)\n#define EXYNOS_4210_URSTCON_OTG_PHYLINK\t\tBIT(2)\n#define EXYNOS_4210_URSTCON_PHY1_ALL\t\tBIT(3)\n#define EXYNOS_4210_URSTCON_PHY1_P0\t\tBIT(4)\n#define EXYNOS_4210_URSTCON_PHY1_P1P2\t\tBIT(5)\n#define EXYNOS_4210_URSTCON_HOST_LINK_ALL\tBIT(6)\n#define EXYNOS_4210_URSTCON_HOST_LINK_P0\tBIT(7)\n#define EXYNOS_4210_URSTCON_HOST_LINK_P1\tBIT(8)\n#define EXYNOS_4210_URSTCON_HOST_LINK_P2\tBIT(9)\n\n \n#define EXYNOS_4210_USB_ISOL_DEVICE_OFFSET\t0x704\n#define EXYNOS_4210_USB_ISOL_DEVICE\t\tBIT(0)\n#define EXYNOS_4210_USB_ISOL_HOST_OFFSET\t0x708\n#define EXYNOS_4210_USB_ISOL_HOST\t\tBIT(0)\n\n \n#define EXYNOS_4210_UPHY1CON\t\t\t0x34\n#define EXYNOS_4210_UPHY1CON_FLOAT_PREVENTION\t0x1\n\n \n#define EXYNOS_4210_MODE_SWITCH_OFFSET\t\t0x21c\n#define EXYNOS_4210_MODE_SWITCH_MASK\t\t1\n#define EXYNOS_4210_MODE_SWITCH_DEVICE\t\t0\n#define EXYNOS_4210_MODE_SWITCH_HOST\t\t1\n\nenum exynos4210_phy_id {\n\tEXYNOS4210_DEVICE,\n\tEXYNOS4210_HOST,\n\tEXYNOS4210_HSIC0,\n\tEXYNOS4210_HSIC1,\n\tEXYNOS4210_NUM_PHYS,\n};\n\n \nstatic int exynos4210_rate_to_clk(unsigned long rate, u32 *reg)\n{\n\tswitch (rate) {\n\tcase 12 * MHZ:\n\t\t*reg = EXYNOS_4210_UPHYCLK_PHYFSEL_12MHZ;\n\t\tbreak;\n\tcase 24 * MHZ:\n\t\t*reg = EXYNOS_4210_UPHYCLK_PHYFSEL_24MHZ;\n\t\tbreak;\n\tcase 48 * MHZ:\n\t\t*reg = EXYNOS_4210_UPHYCLK_PHYFSEL_48MHZ;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void exynos4210_isol(struct samsung_usb2_phy_instance *inst, bool on)\n{\n\tstruct samsung_usb2_phy_driver *drv = inst->drv;\n\tu32 offset;\n\tu32 mask;\n\n\tswitch (inst->cfg->id) {\n\tcase EXYNOS4210_DEVICE:\n\t\toffset = EXYNOS_4210_USB_ISOL_DEVICE_OFFSET;\n\t\tmask = EXYNOS_4210_USB_ISOL_DEVICE;\n\t\tbreak;\n\tcase EXYNOS4210_HOST:\n\t\toffset = EXYNOS_4210_USB_ISOL_HOST_OFFSET;\n\t\tmask = EXYNOS_4210_USB_ISOL_HOST;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tregmap_update_bits(drv->reg_pmu, offset, mask, on ? 0 : mask);\n}\n\nstatic void exynos4210_phy_pwr(struct samsung_usb2_phy_instance *inst, bool on)\n{\n\tstruct samsung_usb2_phy_driver *drv = inst->drv;\n\tu32 rstbits = 0;\n\tu32 phypwr = 0;\n\tu32 rst;\n\tu32 pwr;\n\tu32 clk;\n\n\tswitch (inst->cfg->id) {\n\tcase EXYNOS4210_DEVICE:\n\t\tphypwr =\tEXYNOS_4210_UPHYPWR_PHY0;\n\t\trstbits =\tEXYNOS_4210_URSTCON_PHY0;\n\t\tbreak;\n\tcase EXYNOS4210_HOST:\n\t\tphypwr =\tEXYNOS_4210_UPHYPWR_PHY1;\n\t\trstbits =\tEXYNOS_4210_URSTCON_PHY1_ALL |\n\t\t\t\tEXYNOS_4210_URSTCON_PHY1_P0 |\n\t\t\t\tEXYNOS_4210_URSTCON_PHY1_P1P2 |\n\t\t\t\tEXYNOS_4210_URSTCON_HOST_LINK_ALL |\n\t\t\t\tEXYNOS_4210_URSTCON_HOST_LINK_P0;\n\t\twritel(on, drv->reg_phy + EXYNOS_4210_UPHY1CON);\n\t\tbreak;\n\tcase EXYNOS4210_HSIC0:\n\t\tphypwr =\tEXYNOS_4210_UPHYPWR_HSIC0;\n\t\trstbits =\tEXYNOS_4210_URSTCON_PHY1_P1P2 |\n\t\t\t\tEXYNOS_4210_URSTCON_HOST_LINK_P1;\n\t\tbreak;\n\tcase EXYNOS4210_HSIC1:\n\t\tphypwr =\tEXYNOS_4210_UPHYPWR_HSIC1;\n\t\trstbits =\tEXYNOS_4210_URSTCON_PHY1_P1P2 |\n\t\t\t\tEXYNOS_4210_URSTCON_HOST_LINK_P2;\n\t\tbreak;\n\t}\n\n\tif (on) {\n\t\tclk = readl(drv->reg_phy + EXYNOS_4210_UPHYCLK);\n\t\tclk &= ~EXYNOS_4210_UPHYCLK_PHYFSEL_MASK;\n\t\tclk |= drv->ref_reg_val << EXYNOS_4210_UPHYCLK_PHYFSEL_OFFSET;\n\t\twritel(clk, drv->reg_phy + EXYNOS_4210_UPHYCLK);\n\n\t\tpwr = readl(drv->reg_phy + EXYNOS_4210_UPHYPWR);\n\t\tpwr &= ~phypwr;\n\t\twritel(pwr, drv->reg_phy + EXYNOS_4210_UPHYPWR);\n\n\t\trst = readl(drv->reg_phy + EXYNOS_4210_UPHYRST);\n\t\trst |= rstbits;\n\t\twritel(rst, drv->reg_phy + EXYNOS_4210_UPHYRST);\n\t\tudelay(10);\n\t\trst &= ~rstbits;\n\t\twritel(rst, drv->reg_phy + EXYNOS_4210_UPHYRST);\n\t\t \n\t\tudelay(80);\n\t} else {\n\t\tpwr = readl(drv->reg_phy + EXYNOS_4210_UPHYPWR);\n\t\tpwr |= phypwr;\n\t\twritel(pwr, drv->reg_phy + EXYNOS_4210_UPHYPWR);\n\t}\n}\n\nstatic int exynos4210_power_on(struct samsung_usb2_phy_instance *inst)\n{\n\t \n\texynos4210_phy_pwr(inst, 1);\n\texynos4210_isol(inst, 0);\n\n\treturn 0;\n}\n\nstatic int exynos4210_power_off(struct samsung_usb2_phy_instance *inst)\n{\n\texynos4210_isol(inst, 1);\n\texynos4210_phy_pwr(inst, 0);\n\n\treturn 0;\n}\n\n\nstatic const struct samsung_usb2_common_phy exynos4210_phys[] = {\n\t{\n\t\t.label\t\t= \"device\",\n\t\t.id\t\t= EXYNOS4210_DEVICE,\n\t\t.power_on\t= exynos4210_power_on,\n\t\t.power_off\t= exynos4210_power_off,\n\t},\n\t{\n\t\t.label\t\t= \"host\",\n\t\t.id\t\t= EXYNOS4210_HOST,\n\t\t.power_on\t= exynos4210_power_on,\n\t\t.power_off\t= exynos4210_power_off,\n\t},\n\t{\n\t\t.label\t\t= \"hsic0\",\n\t\t.id\t\t= EXYNOS4210_HSIC0,\n\t\t.power_on\t= exynos4210_power_on,\n\t\t.power_off\t= exynos4210_power_off,\n\t},\n\t{\n\t\t.label\t\t= \"hsic1\",\n\t\t.id\t\t= EXYNOS4210_HSIC1,\n\t\t.power_on\t= exynos4210_power_on,\n\t\t.power_off\t= exynos4210_power_off,\n\t},\n};\n\nconst struct samsung_usb2_phy_config exynos4210_usb2_phy_config = {\n\t.has_mode_switch\t= 0,\n\t.num_phys\t\t= EXYNOS4210_NUM_PHYS,\n\t.phys\t\t\t= exynos4210_phys,\n\t.rate_to_clk\t\t= exynos4210_rate_to_clk,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}