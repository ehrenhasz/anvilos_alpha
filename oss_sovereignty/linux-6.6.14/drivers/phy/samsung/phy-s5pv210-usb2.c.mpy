{
  "module_name": "phy-s5pv210-usb2.c",
  "hash_id": "36a4e73e6f374929be212ace375ba94d8d40ba66baf9ce0edf3b93c886bf1aa7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/samsung/phy-s5pv210-usb2.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/phy/phy.h>\n#include \"phy-samsung-usb2.h\"\n\n \n\n \n#define S5PV210_UPHYPWR\t\t\t0x0\n\n#define S5PV210_UPHYPWR_PHY0_SUSPEND\tBIT(0)\n#define S5PV210_UPHYPWR_PHY0_PWR\tBIT(3)\n#define S5PV210_UPHYPWR_PHY0_OTG_PWR\tBIT(4)\n#define S5PV210_UPHYPWR_PHY0\t( \\\n\tS5PV210_UPHYPWR_PHY0_SUSPEND | \\\n\tS5PV210_UPHYPWR_PHY0_PWR | \\\n\tS5PV210_UPHYPWR_PHY0_OTG_PWR)\n\n#define S5PV210_UPHYPWR_PHY1_SUSPEND\tBIT(6)\n#define S5PV210_UPHYPWR_PHY1_PWR\tBIT(7)\n#define S5PV210_UPHYPWR_PHY1 ( \\\n\tS5PV210_UPHYPWR_PHY1_SUSPEND | \\\n\tS5PV210_UPHYPWR_PHY1_PWR)\n\n \n#define S5PV210_UPHYCLK\t\t\t0x4\n\n#define S5PV210_UPHYCLK_PHYFSEL_MASK\t(0x3 << 0)\n#define S5PV210_UPHYCLK_PHYFSEL_48MHZ\t(0x0 << 0)\n#define S5PV210_UPHYCLK_PHYFSEL_24MHZ\t(0x3 << 0)\n#define S5PV210_UPHYCLK_PHYFSEL_12MHZ\t(0x2 << 0)\n\n#define S5PV210_UPHYCLK_PHY0_ID_PULLUP\tBIT(2)\n#define S5PV210_UPHYCLK_PHY0_COMMON_ON\tBIT(4)\n#define S5PV210_UPHYCLK_PHY1_COMMON_ON\tBIT(7)\n\n \n#define S5PV210_UPHYRST\t\t\t0x8\n\n#define S5PV210_URSTCON_PHY0\t\tBIT(0)\n#define S5PV210_URSTCON_OTG_HLINK\tBIT(1)\n#define S5PV210_URSTCON_OTG_PHYLINK\tBIT(2)\n#define S5PV210_URSTCON_PHY1_ALL\tBIT(3)\n#define S5PV210_URSTCON_HOST_LINK_ALL\tBIT(4)\n\n \n#define S5PV210_USB_ISOL_OFFSET\t\t0x680c\n#define S5PV210_USB_ISOL_DEVICE\t\tBIT(0)\n#define S5PV210_USB_ISOL_HOST\t\tBIT(1)\n\n\nenum s5pv210_phy_id {\n\tS5PV210_DEVICE,\n\tS5PV210_HOST,\n\tS5PV210_NUM_PHYS,\n};\n\n \nstatic int s5pv210_rate_to_clk(unsigned long rate, u32 *reg)\n{\n\tswitch (rate) {\n\tcase 12 * MHZ:\n\t\t*reg = S5PV210_UPHYCLK_PHYFSEL_12MHZ;\n\t\tbreak;\n\tcase 24 * MHZ:\n\t\t*reg = S5PV210_UPHYCLK_PHYFSEL_24MHZ;\n\t\tbreak;\n\tcase 48 * MHZ:\n\t\t*reg = S5PV210_UPHYCLK_PHYFSEL_48MHZ;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void s5pv210_isol(struct samsung_usb2_phy_instance *inst, bool on)\n{\n\tstruct samsung_usb2_phy_driver *drv = inst->drv;\n\tu32 mask;\n\n\tswitch (inst->cfg->id) {\n\tcase S5PV210_DEVICE:\n\t\tmask = S5PV210_USB_ISOL_DEVICE;\n\t\tbreak;\n\tcase S5PV210_HOST:\n\t\tmask = S5PV210_USB_ISOL_HOST;\n\t\tbreak;\n\tdefault:\n\t\treturn;\n\t}\n\n\tregmap_update_bits(drv->reg_pmu, S5PV210_USB_ISOL_OFFSET,\n\t\t\t\t\t\t\tmask, on ? 0 : mask);\n}\n\nstatic void s5pv210_phy_pwr(struct samsung_usb2_phy_instance *inst, bool on)\n{\n\tstruct samsung_usb2_phy_driver *drv = inst->drv;\n\tu32 rstbits = 0;\n\tu32 phypwr = 0;\n\tu32 rst;\n\tu32 pwr;\n\n\tswitch (inst->cfg->id) {\n\tcase S5PV210_DEVICE:\n\t\tphypwr =\tS5PV210_UPHYPWR_PHY0;\n\t\trstbits =\tS5PV210_URSTCON_PHY0;\n\t\tbreak;\n\tcase S5PV210_HOST:\n\t\tphypwr =\tS5PV210_UPHYPWR_PHY1;\n\t\trstbits =\tS5PV210_URSTCON_PHY1_ALL |\n\t\t\t\tS5PV210_URSTCON_HOST_LINK_ALL;\n\t\tbreak;\n\t}\n\n\tif (on) {\n\t\twritel(drv->ref_reg_val, drv->reg_phy + S5PV210_UPHYCLK);\n\n\t\tpwr = readl(drv->reg_phy + S5PV210_UPHYPWR);\n\t\tpwr &= ~phypwr;\n\t\twritel(pwr, drv->reg_phy + S5PV210_UPHYPWR);\n\n\t\trst = readl(drv->reg_phy + S5PV210_UPHYRST);\n\t\trst |= rstbits;\n\t\twritel(rst, drv->reg_phy + S5PV210_UPHYRST);\n\t\tudelay(10);\n\t\trst &= ~rstbits;\n\t\twritel(rst, drv->reg_phy + S5PV210_UPHYRST);\n\t\t \n\t\tudelay(80);\n\t} else {\n\t\tpwr = readl(drv->reg_phy + S5PV210_UPHYPWR);\n\t\tpwr |= phypwr;\n\t\twritel(pwr, drv->reg_phy + S5PV210_UPHYPWR);\n\t}\n}\n\nstatic int s5pv210_power_on(struct samsung_usb2_phy_instance *inst)\n{\n\ts5pv210_isol(inst, 0);\n\ts5pv210_phy_pwr(inst, 1);\n\n\treturn 0;\n}\n\nstatic int s5pv210_power_off(struct samsung_usb2_phy_instance *inst)\n{\n\ts5pv210_phy_pwr(inst, 0);\n\ts5pv210_isol(inst, 1);\n\n\treturn 0;\n}\n\nstatic const struct samsung_usb2_common_phy s5pv210_phys[S5PV210_NUM_PHYS] = {\n\t[S5PV210_DEVICE] = {\n\t\t.label\t\t= \"device\",\n\t\t.id\t\t= S5PV210_DEVICE,\n\t\t.power_on\t= s5pv210_power_on,\n\t\t.power_off\t= s5pv210_power_off,\n\t},\n\t[S5PV210_HOST] = {\n\t\t.label\t\t= \"host\",\n\t\t.id\t\t= S5PV210_HOST,\n\t\t.power_on\t= s5pv210_power_on,\n\t\t.power_off\t= s5pv210_power_off,\n\t},\n};\n\nconst struct samsung_usb2_phy_config s5pv210_usb2_phy_config = {\n\t.num_phys\t= ARRAY_SIZE(s5pv210_phys),\n\t.phys\t\t= s5pv210_phys,\n\t.rate_to_clk\t= s5pv210_rate_to_clk,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}