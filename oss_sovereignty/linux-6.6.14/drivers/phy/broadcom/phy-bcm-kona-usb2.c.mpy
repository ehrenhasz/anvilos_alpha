{
  "module_name": "phy-bcm-kona-usb2.c",
  "hash_id": "e447bfff2cc0660601fd41e0eb9b82ac8989a18c9a17744b23307c84da792d49",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/broadcom/phy-bcm-kona-usb2.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n\n#define OTGCTL\t\t\t(0)\n#define OTGCTL_OTGSTAT2\t\tBIT(31)\n#define OTGCTL_OTGSTAT1\t\tBIT(30)\n#define OTGCTL_PRST_N_SW\tBIT(11)\n#define OTGCTL_HRESET_N\t\tBIT(10)\n#define OTGCTL_UTMI_LINE_STATE1\tBIT(9)\n#define OTGCTL_UTMI_LINE_STATE0\tBIT(8)\n\n#define P1CTL\t\t\t(8)\n#define P1CTL_SOFT_RESET\tBIT(1)\n#define P1CTL_NON_DRIVING\tBIT(0)\n\nstruct bcm_kona_usb {\n\tvoid __iomem *regs;\n};\n\nstatic void bcm_kona_usb_phy_power(struct bcm_kona_usb *phy, int on)\n{\n\tu32 val;\n\n\tval = readl(phy->regs + OTGCTL);\n\tif (on) {\n\t\t \n\t\tval &= ~(OTGCTL_OTGSTAT2 | OTGCTL_OTGSTAT1 |\n\t\t\t OTGCTL_UTMI_LINE_STATE1 | OTGCTL_UTMI_LINE_STATE0);\n\t\tval |= OTGCTL_PRST_N_SW | OTGCTL_HRESET_N;\n\t} else {\n\t\tval &= ~(OTGCTL_PRST_N_SW | OTGCTL_HRESET_N);\n\t}\n\twritel(val, phy->regs + OTGCTL);\n}\n\nstatic int bcm_kona_usb_phy_init(struct phy *gphy)\n{\n\tstruct bcm_kona_usb *phy = phy_get_drvdata(gphy);\n\tu32 val;\n\n\t \n\tval = readl(phy->regs + P1CTL);\n\tval &= ~P1CTL_NON_DRIVING;\n\tval |= P1CTL_SOFT_RESET;\n\twritel(val, phy->regs + P1CTL);\n\twritel(val & ~P1CTL_SOFT_RESET, phy->regs + P1CTL);\n\t \n\tmdelay(2);\n\twritel(val | P1CTL_SOFT_RESET, phy->regs + P1CTL);\n\n\treturn 0;\n}\n\nstatic int bcm_kona_usb_phy_power_on(struct phy *gphy)\n{\n\tstruct bcm_kona_usb *phy = phy_get_drvdata(gphy);\n\n\tbcm_kona_usb_phy_power(phy, 1);\n\n\treturn 0;\n}\n\nstatic int bcm_kona_usb_phy_power_off(struct phy *gphy)\n{\n\tstruct bcm_kona_usb *phy = phy_get_drvdata(gphy);\n\n\tbcm_kona_usb_phy_power(phy, 0);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops ops = {\n\t.init\t\t= bcm_kona_usb_phy_init,\n\t.power_on\t= bcm_kona_usb_phy_power_on,\n\t.power_off\t= bcm_kona_usb_phy_power_off,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int bcm_kona_usb2_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct bcm_kona_usb *phy;\n\tstruct phy *gphy;\n\tstruct phy_provider *phy_provider;\n\n\tphy = devm_kzalloc(dev, sizeof(*phy), GFP_KERNEL);\n\tif (!phy)\n\t\treturn -ENOMEM;\n\n\tphy->regs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(phy->regs))\n\t\treturn PTR_ERR(phy->regs);\n\n\tplatform_set_drvdata(pdev, phy);\n\n\tgphy = devm_phy_create(dev, NULL, &ops);\n\tif (IS_ERR(gphy))\n\t\treturn PTR_ERR(gphy);\n\n\t \n\tphy_set_bus_width(gphy, 8);\n\n\tphy_set_drvdata(gphy, phy);\n\n\tphy_provider = devm_of_phy_provider_register(dev,\n\t\t\tof_phy_simple_xlate);\n\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct of_device_id bcm_kona_usb2_dt_ids[] = {\n\t{ .compatible = \"brcm,kona-usb2-phy\" },\n\t{   }\n};\n\nMODULE_DEVICE_TABLE(of, bcm_kona_usb2_dt_ids);\n\nstatic struct platform_driver bcm_kona_usb2_driver = {\n\t.probe\t\t= bcm_kona_usb2_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"bcm-kona-usb2\",\n\t\t.of_match_table = bcm_kona_usb2_dt_ids,\n\t},\n};\n\nmodule_platform_driver(bcm_kona_usb2_driver);\n\nMODULE_ALIAS(\"platform:bcm-kona-usb2\");\nMODULE_AUTHOR(\"Matt Porter <mporter@linaro.org>\");\nMODULE_DESCRIPTION(\"BCM Kona USB 2.0 PHY driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}