{
  "module_name": "phy-brcm-usb-init.c",
  "hash_id": "2f38af62473e65012fcc3a400a4afdd6ec720a303d65346287d006a88c64e68b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/broadcom/phy-brcm-usb-init.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n\n#include <linux/soc/brcmstb/brcmstb.h>\n#include \"phy-brcm-usb-init.h\"\n\n#define PHY_PORTS 2\n#define PHY_PORT_SELECT_0 0\n#define PHY_PORT_SELECT_1 0x1000\n\n \n#define USB_CTRL_SETUP\t\t\t0x00\n#define   USB_CTRL_SETUP_BABO_MASK\t\t\tBIT(0)\n#define   USB_CTRL_SETUP_FNHW_MASK\t\t\tBIT(1)\n#define   USB_CTRL_SETUP_FNBO_MASK\t\t\tBIT(2)\n#define   USB_CTRL_SETUP_WABO_MASK\t\t\tBIT(3)\n#define   USB_CTRL_SETUP_IOC_MASK\t\t\tBIT(4)\n#define   USB_CTRL_SETUP_IPP_MASK\t\t\tBIT(5)\n#define   USB_CTRL_SETUP_SCB_CLIENT_SWAP_MASK\t\tBIT(13)  \n#define   USB_CTRL_SETUP_SCB1_EN_MASK\t\t\tBIT(14)  \n#define   USB_CTRL_SETUP_SCB2_EN_MASK\t\t\tBIT(15)  \n#define   USB_CTRL_SETUP_SS_EHCI64BIT_EN_MASK\t\tBIT(17)  \n#define   USB_CTRL_SETUP_SS_EHCI64BIT_EN_VAR_MASK\tBIT(16)  \n#define   USB_CTRL_SETUP_STRAP_IPP_SEL_MASK\t\tBIT(25)  \n#define   USB_CTRL_SETUP_CC_DRD_MODE_ENABLE_MASK\tBIT(26)  \n#define   USB_CTRL_SETUP_STRAP_CC_DRD_MODE_ENABLE_SEL_MASK BIT(27)  \n#define   USB_CTRL_SETUP_OC_DISABLE_PORT0_MASK\t\tBIT(28)\n#define   USB_CTRL_SETUP_OC_DISABLE_PORT1_MASK\t\tBIT(29)\n#define   USB_CTRL_SETUP_OC_DISABLE_MASK\t\tGENMASK(29, 28)  \n#define   USB_CTRL_SETUP_OC3_DISABLE_PORT0_MASK\t\tBIT(30)\n#define   USB_CTRL_SETUP_OC3_DISABLE_PORT1_MASK\t\tBIT(31)\n#define   USB_CTRL_SETUP_OC3_DISABLE_MASK\t\tGENMASK(31, 30)  \n#define USB_CTRL_PLL_CTL\t\t0x04\n#define   USB_CTRL_PLL_CTL_PLL_SUSPEND_EN_MASK\t\tBIT(27)\n#define   USB_CTRL_PLL_CTL_PLL_RESETB_MASK\t\tBIT(30)\n#define   USB_CTRL_PLL_CTL_PLL_IDDQ_PWRDN_MASK\t\tBIT(31)  \n#define USB_CTRL_EBRIDGE\t\t0x0c\n#define   USB_CTRL_EBRIDGE_EBR_SCB_SIZE_MASK\t\tGENMASK(11, 7)  \n#define   USB_CTRL_EBRIDGE_ESTOP_SCB_REQ_MASK\t\tBIT(17)  \n#define USB_CTRL_OBRIDGE\t\t0x10\n#define   USB_CTRL_OBRIDGE_LS_KEEP_ALIVE_MASK\t\tBIT(27)\n#define USB_CTRL_MDIO\t\t\t0x14\n#define USB_CTRL_MDIO2\t\t\t0x18\n#define USB_CTRL_UTMI_CTL_1\t\t0x2c\n#define   USB_CTRL_UTMI_CTL_1_POWER_UP_FSM_EN_MASK\tBIT(11)\n#define   USB_CTRL_UTMI_CTL_1_POWER_UP_FSM_EN_P1_MASK\tBIT(27)\n#define USB_CTRL_USB_PM\t\t\t0x34\n#define   USB_CTRL_USB_PM_RMTWKUP_EN_MASK\t\tBIT(0)\n#define   USB_CTRL_USB_PM_USB20_HC_RESETB_VAR_MASK\tGENMASK(21, 20)  \n#define   USB_CTRL_USB_PM_XHC_SOFT_RESETB_MASK\t\tBIT(22)  \n#define   USB_CTRL_USB_PM_BDC_SOFT_RESETB_MASK\t\tBIT(23)  \n#define   USB_CTRL_USB_PM_USB20_HC_RESETB_MASK\t\tGENMASK(29, 28)  \n#define   USB_CTRL_USB_PM_XHC_SOFT_RESETB_VAR_MASK\tBIT(30)  \n#define   USB_CTRL_USB_PM_SOFT_RESET_MASK\t\tBIT(30)  \n#define   USB_CTRL_USB_PM_USB_PWRDN_MASK\t\tBIT(31)  \n#define USB_CTRL_USB_PM_STATUS\t\t0x38\n#define USB_CTRL_USB30_CTL1\t\t0x60\n#define   USB_CTRL_USB30_CTL1_PHY3_PLL_SEQ_START_MASK\tBIT(4)\n#define   USB_CTRL_USB30_CTL1_PHY3_RESETB_MASK\t\tBIT(16)\n#define   USB_CTRL_USB30_CTL1_XHC_SOFT_RESETB_MASK\tBIT(17)  \n#define   USB_CTRL_USB30_CTL1_USB3_IOC_MASK\t\tBIT(28)  \n#define   USB_CTRL_USB30_CTL1_USB3_IPP_MASK\t\tBIT(29)  \n#define USB_CTRL_USB30_PCTL\t\t0x70\n#define   USB_CTRL_USB30_PCTL_PHY3_SOFT_RESETB_MASK\tBIT(1)\n#define   USB_CTRL_USB30_PCTL_PHY3_IDDQ_OVERRIDE_MASK\tBIT(15)\n#define   USB_CTRL_USB30_PCTL_PHY3_SOFT_RESETB_P1_MASK\tBIT(17)\n#define USB_CTRL_USB_DEVICE_CTL1\t0x90\n#define   USB_CTRL_USB_DEVICE_CTL1_PORT_MODE_MASK\tGENMASK(1, 0)  \n\n \n#define USB_XHCI_EC_IRAADR 0x658\n#define USB_XHCI_EC_IRADAT 0x65c\n\nenum brcm_family_type {\n\tBRCM_FAMILY_3390A0,\n\tBRCM_FAMILY_4908,\n\tBRCM_FAMILY_7250B0,\n\tBRCM_FAMILY_7271A0,\n\tBRCM_FAMILY_7364A0,\n\tBRCM_FAMILY_7366C0,\n\tBRCM_FAMILY_74371A0,\n\tBRCM_FAMILY_7439B0,\n\tBRCM_FAMILY_7445D0,\n\tBRCM_FAMILY_7260A0,\n\tBRCM_FAMILY_7278A0,\n\tBRCM_FAMILY_COUNT,\n};\n\n#define USB_BRCM_FAMILY(chip) \\\n\t[BRCM_FAMILY_##chip] = __stringify(chip)\n\nstatic const char *family_names[BRCM_FAMILY_COUNT] = {\n\tUSB_BRCM_FAMILY(3390A0),\n\tUSB_BRCM_FAMILY(4908),\n\tUSB_BRCM_FAMILY(7250B0),\n\tUSB_BRCM_FAMILY(7271A0),\n\tUSB_BRCM_FAMILY(7364A0),\n\tUSB_BRCM_FAMILY(7366C0),\n\tUSB_BRCM_FAMILY(74371A0),\n\tUSB_BRCM_FAMILY(7439B0),\n\tUSB_BRCM_FAMILY(7445D0),\n\tUSB_BRCM_FAMILY(7260A0),\n\tUSB_BRCM_FAMILY(7278A0),\n};\n\nenum {\n\tUSB_CTRL_SETUP_SCB1_EN_SELECTOR,\n\tUSB_CTRL_SETUP_SCB2_EN_SELECTOR,\n\tUSB_CTRL_SETUP_SS_EHCI64BIT_EN_SELECTOR,\n\tUSB_CTRL_SETUP_STRAP_IPP_SEL_SELECTOR,\n\tUSB_CTRL_SETUP_OC3_DISABLE_PORT0_SELECTOR,\n\tUSB_CTRL_SETUP_OC3_DISABLE_PORT1_SELECTOR,\n\tUSB_CTRL_SETUP_OC3_DISABLE_SELECTOR,\n\tUSB_CTRL_PLL_CTL_PLL_IDDQ_PWRDN_SELECTOR,\n\tUSB_CTRL_USB_PM_BDC_SOFT_RESETB_SELECTOR,\n\tUSB_CTRL_USB_PM_XHC_SOFT_RESETB_SELECTOR,\n\tUSB_CTRL_USB_PM_USB_PWRDN_SELECTOR,\n\tUSB_CTRL_USB30_CTL1_XHC_SOFT_RESETB_SELECTOR,\n\tUSB_CTRL_USB30_CTL1_USB3_IOC_SELECTOR,\n\tUSB_CTRL_USB30_CTL1_USB3_IPP_SELECTOR,\n\tUSB_CTRL_USB_DEVICE_CTL1_PORT_MODE_SELECTOR,\n\tUSB_CTRL_USB_PM_SOFT_RESET_SELECTOR,\n\tUSB_CTRL_SETUP_CC_DRD_MODE_ENABLE_SELECTOR,\n\tUSB_CTRL_SETUP_STRAP_CC_DRD_MODE_ENABLE_SEL_SELECTOR,\n\tUSB_CTRL_USB_PM_USB20_HC_RESETB_SELECTOR,\n\tUSB_CTRL_SETUP_ENDIAN_SELECTOR,\n\tUSB_CTRL_SELECTOR_COUNT,\n};\n\n#define USB_CTRL_MASK_FAMILY(params, reg, field)\t\t\t\\\n\t(params->usb_reg_bits_map[USB_CTRL_##reg##_##field##_SELECTOR])\n\n#define USB_CTRL_SET_FAMILY(params, reg, field)\t\\\n\tusb_ctrl_set_family(params, USB_CTRL_##reg,\t\\\n\t\t\tUSB_CTRL_##reg##_##field##_SELECTOR)\n#define USB_CTRL_UNSET_FAMILY(params, reg, field)\t\\\n\tusb_ctrl_unset_family(params, USB_CTRL_##reg,\t\\\n\t\tUSB_CTRL_##reg##_##field##_SELECTOR)\n\n#define MDIO_USB2\t0\n#define MDIO_USB3\tBIT(31)\n\n#define USB_CTRL_SETUP_ENDIAN_BITS (\t\\\n\t\tUSB_CTRL_MASK(SETUP, BABO) |\t\\\n\t\tUSB_CTRL_MASK(SETUP, FNHW) |\t\\\n\t\tUSB_CTRL_MASK(SETUP, FNBO) |\t\\\n\t\tUSB_CTRL_MASK(SETUP, WABO))\n\n#ifdef __LITTLE_ENDIAN\n#define ENDIAN_SETTINGS (\t\t\t\\\n\t\tUSB_CTRL_MASK(SETUP, BABO) |\t\\\n\t\tUSB_CTRL_MASK(SETUP, FNHW))\n#else\n#define ENDIAN_SETTINGS (\t\t\t\\\n\t\tUSB_CTRL_MASK(SETUP, FNHW) |\t\\\n\t\tUSB_CTRL_MASK(SETUP, FNBO) |\t\\\n\t\tUSB_CTRL_MASK(SETUP, WABO))\n#endif\n\nstruct id_to_type {\n\tu32 id;\n\tint type;\n};\n\nstatic const struct id_to_type id_to_type_table[] = {\n\t{ 0x33900000, BRCM_FAMILY_3390A0 },\n\t{ 0x72500010, BRCM_FAMILY_7250B0 },\n\t{ 0x72600000, BRCM_FAMILY_7260A0 },\n\t{ 0x72550000, BRCM_FAMILY_7260A0 },\n\t{ 0x72680000, BRCM_FAMILY_7271A0 },\n\t{ 0x72710000, BRCM_FAMILY_7271A0 },\n\t{ 0x73640000, BRCM_FAMILY_7364A0 },\n\t{ 0x73660020, BRCM_FAMILY_7366C0 },\n\t{ 0x07437100, BRCM_FAMILY_74371A0 },\n\t{ 0x74390010, BRCM_FAMILY_7439B0 },\n\t{ 0x74450030, BRCM_FAMILY_7445D0 },\n\t{ 0x72780000, BRCM_FAMILY_7278A0 },\n\t{ 0, BRCM_FAMILY_7271A0 },  \n};\n\nstatic const u32\nusb_reg_bits_map_table[BRCM_FAMILY_COUNT][USB_CTRL_SELECTOR_COUNT] = {\n\t \n\t[BRCM_FAMILY_3390A0] = {\n\t\tUSB_CTRL_SETUP_SCB1_EN_MASK,\n\t\tUSB_CTRL_SETUP_SCB2_EN_MASK,\n\t\tUSB_CTRL_SETUP_SS_EHCI64BIT_EN_MASK,\n\t\tUSB_CTRL_SETUP_STRAP_IPP_SEL_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT0_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT1_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_MASK,\n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_PM_XHC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB_PM_USB_PWRDN_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_DEVICE_CTL1_PORT_MODE_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_PM_USB20_HC_RESETB_VAR_MASK,\n\t\tENDIAN_SETTINGS,  \n\t},\n\t \n\t[BRCM_FAMILY_4908] = {\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_PM_XHC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB_PM_USB_PWRDN_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t},\n\t \n\t[BRCM_FAMILY_7250B0] = {\n\t\tUSB_CTRL_SETUP_SCB1_EN_MASK,\n\t\tUSB_CTRL_SETUP_SCB2_EN_MASK,\n\t\tUSB_CTRL_SETUP_SS_EHCI64BIT_EN_MASK,\n\t\t0,  \n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT0_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT1_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_MASK,\n\t\tUSB_CTRL_PLL_CTL_PLL_IDDQ_PWRDN_MASK,\n\t\t0,  \n\t\tUSB_CTRL_USB_PM_XHC_SOFT_RESETB_VAR_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_PM_USB20_HC_RESETB_MASK,\n\t\tENDIAN_SETTINGS,  \n\t},\n\t \n\t[BRCM_FAMILY_7271A0] = {\n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_SETUP_SS_EHCI64BIT_EN_MASK,\n\t\tUSB_CTRL_SETUP_STRAP_IPP_SEL_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT0_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT1_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_MASK,\n\t\t0,  \n\t\tUSB_CTRL_USB_PM_BDC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB_PM_XHC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB_PM_USB_PWRDN_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_DEVICE_CTL1_PORT_MODE_MASK,\n\t\tUSB_CTRL_USB_PM_SOFT_RESET_MASK,\n\t\tUSB_CTRL_SETUP_CC_DRD_MODE_ENABLE_MASK,\n\t\tUSB_CTRL_SETUP_STRAP_CC_DRD_MODE_ENABLE_SEL_MASK,\n\t\tUSB_CTRL_USB_PM_USB20_HC_RESETB_VAR_MASK,\n\t\tENDIAN_SETTINGS,  \n\t},\n\t \n\t[BRCM_FAMILY_7364A0] = {\n\t\tUSB_CTRL_SETUP_SCB1_EN_MASK,\n\t\tUSB_CTRL_SETUP_SCB2_EN_MASK,\n\t\tUSB_CTRL_SETUP_SS_EHCI64BIT_EN_MASK,\n\t\t0,  \n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT0_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT1_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_MASK,\n\t\tUSB_CTRL_PLL_CTL_PLL_IDDQ_PWRDN_MASK,\n\t\t0,  \n\t\tUSB_CTRL_USB_PM_XHC_SOFT_RESETB_VAR_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_PM_USB20_HC_RESETB_MASK,\n\t\tENDIAN_SETTINGS,  \n\t},\n\t \n\t[BRCM_FAMILY_7366C0] = {\n\t\tUSB_CTRL_SETUP_SCB1_EN_MASK,\n\t\tUSB_CTRL_SETUP_SCB2_EN_MASK,\n\t\tUSB_CTRL_SETUP_SS_EHCI64BIT_EN_MASK,\n\t\t0,  \n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT0_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT1_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_MASK,\n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_PM_XHC_SOFT_RESETB_VAR_MASK,\n\t\tUSB_CTRL_USB_PM_USB_PWRDN_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_PM_USB20_HC_RESETB_MASK,\n\t\tENDIAN_SETTINGS,  \n\t},\n\t \n\t[BRCM_FAMILY_74371A0] = {\n\t\tUSB_CTRL_SETUP_SCB1_EN_MASK,\n\t\tUSB_CTRL_SETUP_SCB2_EN_MASK,\n\t\tUSB_CTRL_SETUP_SS_EHCI64BIT_EN_VAR_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_PLL_CTL_PLL_IDDQ_PWRDN_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB30_CTL1_XHC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB30_CTL1_USB3_IOC_MASK,\n\t\tUSB_CTRL_USB30_CTL1_USB3_IPP_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tENDIAN_SETTINGS,  \n\t},\n\t \n\t[BRCM_FAMILY_7439B0] = {\n\t\tUSB_CTRL_SETUP_SCB1_EN_MASK,\n\t\tUSB_CTRL_SETUP_SCB2_EN_MASK,\n\t\tUSB_CTRL_SETUP_SS_EHCI64BIT_EN_MASK,\n\t\tUSB_CTRL_SETUP_STRAP_IPP_SEL_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT0_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT1_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_MASK,\n\t\t0,  \n\t\tUSB_CTRL_USB_PM_BDC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB_PM_XHC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB_PM_USB_PWRDN_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_DEVICE_CTL1_PORT_MODE_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_PM_USB20_HC_RESETB_VAR_MASK,\n\t\tENDIAN_SETTINGS,  \n\t},\n\t \n\t[BRCM_FAMILY_7445D0] = {\n\t\tUSB_CTRL_SETUP_SCB1_EN_MASK,\n\t\tUSB_CTRL_SETUP_SCB2_EN_MASK,\n\t\tUSB_CTRL_SETUP_SS_EHCI64BIT_EN_VAR_MASK,\n\t\t0,  \n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT0_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT1_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_MASK,\n\t\tUSB_CTRL_PLL_CTL_PLL_IDDQ_PWRDN_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB30_CTL1_XHC_SOFT_RESETB_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_PM_USB20_HC_RESETB_VAR_MASK,\n\t\tENDIAN_SETTINGS,  \n\t},\n\t \n\t[BRCM_FAMILY_7260A0] = {\n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_SETUP_SS_EHCI64BIT_EN_MASK,\n\t\tUSB_CTRL_SETUP_STRAP_IPP_SEL_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT0_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT1_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_MASK,\n\t\t0,  \n\t\tUSB_CTRL_USB_PM_BDC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB_PM_XHC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB_PM_USB_PWRDN_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_DEVICE_CTL1_PORT_MODE_MASK,\n\t\tUSB_CTRL_USB_PM_SOFT_RESET_MASK,\n\t\tUSB_CTRL_SETUP_CC_DRD_MODE_ENABLE_MASK,\n\t\tUSB_CTRL_SETUP_STRAP_CC_DRD_MODE_ENABLE_SEL_MASK,\n\t\tUSB_CTRL_USB_PM_USB20_HC_RESETB_VAR_MASK,\n\t\tENDIAN_SETTINGS,  \n\t},\n\t \n\t[BRCM_FAMILY_7278A0] = {\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_SETUP_STRAP_IPP_SEL_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT0_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_PORT1_MASK,\n\t\tUSB_CTRL_SETUP_OC3_DISABLE_MASK,\n\t\t0,  \n\t\tUSB_CTRL_USB_PM_BDC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB_PM_XHC_SOFT_RESETB_MASK,\n\t\tUSB_CTRL_USB_PM_USB_PWRDN_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\tUSB_CTRL_USB_DEVICE_CTL1_PORT_MODE_MASK,\n\t\tUSB_CTRL_USB_PM_SOFT_RESET_MASK,\n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t\t0,  \n\t},\n};\n\nstatic inline\nvoid usb_ctrl_unset_family(struct brcm_usb_init_params *params,\n\t\t\t   u32 reg_offset, u32 field)\n{\n\tu32 mask;\n\n\tmask = params->usb_reg_bits_map[field];\n\tbrcm_usb_ctrl_unset(params->regs[BRCM_REGS_CTRL] + reg_offset, mask);\n};\n\nstatic inline\nvoid usb_ctrl_set_family(struct brcm_usb_init_params *params,\n\t\t\t u32 reg_offset, u32 field)\n{\n\tu32 mask;\n\n\tmask = params->usb_reg_bits_map[field];\n\tbrcm_usb_ctrl_set(params->regs[BRCM_REGS_CTRL] + reg_offset, mask);\n};\n\nstatic u32 brcmusb_usb_mdio_read(void __iomem *ctrl_base, u32 reg, int mode)\n{\n\tu32 data;\n\n\tdata = (reg << 16) | mode;\n\tbrcm_usb_writel(data, USB_CTRL_REG(ctrl_base, MDIO));\n\tdata |= (1 << 24);\n\tbrcm_usb_writel(data, USB_CTRL_REG(ctrl_base, MDIO));\n\tdata &= ~(1 << 24);\n\t \n\tusleep_range(10, 20);\n\tbrcm_usb_writel(data, USB_CTRL_REG(ctrl_base, MDIO));\n\t \n\tusleep_range(10, 20);\n\n\treturn brcm_usb_readl(USB_CTRL_REG(ctrl_base, MDIO2)) & 0xffff;\n}\n\nstatic void brcmusb_usb_mdio_write(void __iomem *ctrl_base, u32 reg,\n\t\t\t\t   u32 val, int mode)\n{\n\tu32 data;\n\n\tdata = (reg << 16) | val | mode;\n\tbrcm_usb_writel(data, USB_CTRL_REG(ctrl_base, MDIO));\n\tdata |= (1 << 25);\n\tbrcm_usb_writel(data, USB_CTRL_REG(ctrl_base, MDIO));\n\tdata &= ~(1 << 25);\n\n\t \n\tusleep_range(10, 20);\n\tbrcm_usb_writel(data, USB_CTRL_REG(ctrl_base, MDIO));\n\t \n\tusleep_range(10, 20);\n}\n\nstatic void brcmusb_usb_phy_ldo_fix(void __iomem *ctrl_base)\n{\n\t \n\t \n\tUSB_CTRL_UNSET(ctrl_base, UTMI_CTL_1, POWER_UP_FSM_EN);\n\tUSB_CTRL_UNSET(ctrl_base, UTMI_CTL_1, POWER_UP_FSM_EN_P1);\n\n\t \n\tUSB_CTRL_UNSET(ctrl_base, PLL_CTL, PLL_RESETB);\n\t \n\tudelay(1);\n\tUSB_CTRL_SET(ctrl_base, PLL_CTL, PLL_RESETB);\n\t \n\tusleep_range(1000, 2000);\n}\n\nstatic void brcmusb_usb2_eye_fix(void __iomem *ctrl_base)\n{\n\t \n\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, 0x80a0, MDIO_USB2);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x0a, 0xc6a0, MDIO_USB2);\n}\n\nstatic void brcmusb_usb3_pll_fix(void __iomem *ctrl_base)\n{\n\t \n\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, 0x8000, MDIO_USB3);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x07, 0x1503, MDIO_USB3);\n}\n\nstatic void brcmusb_usb3_enable_pipe_reset(void __iomem *ctrl_base)\n{\n\tu32 val;\n\n\t \n\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, 0x8000, MDIO_USB3);\n\tval = brcmusb_usb_mdio_read(ctrl_base, 0x0f, MDIO_USB3) | 0x200;\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x0f, val, MDIO_USB3);\n}\n\nstatic void brcmusb_usb3_enable_sigdet(void __iomem *ctrl_base)\n{\n\tu32 val, ofs;\n\tint ii;\n\n\tofs = 0;\n\tfor (ii = 0; ii < PHY_PORTS; ++ii) {\n\t\t \n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, (0x8080 + ofs),\n\t\t\t\t       MDIO_USB3);\n\t\tval = brcmusb_usb_mdio_read(ctrl_base, 0x05, MDIO_USB3);\n\t\tval = (val & ~0x800f) | 0x800d;\n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x05, val, MDIO_USB3);\n\t\tofs = PHY_PORT_SELECT_1;\n\t}\n}\n\nstatic void brcmusb_usb3_enable_skip_align(void __iomem *ctrl_base)\n{\n\tu32 val, ofs;\n\tint ii;\n\n\tofs = 0;\n\tfor (ii = 0; ii < PHY_PORTS; ++ii) {\n\t\t \n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, (0x8060 + ofs),\n\t\t\t\t       MDIO_USB3);\n\t\tval = brcmusb_usb_mdio_read(ctrl_base, 0x01, MDIO_USB3) | 0x200;\n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x01, val, MDIO_USB3);\n\t\tofs = PHY_PORT_SELECT_1;\n\t}\n}\n\nstatic void brcmusb_usb3_unfreeze_aeq(void __iomem *ctrl_base)\n{\n\tu32 val, ofs;\n\tint ii;\n\n\tofs = 0;\n\tfor (ii = 0; ii < PHY_PORTS; ++ii) {\n\t\t \n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, (0x80e0 + ofs),\n\t\t\t\t       MDIO_USB3);\n\t\tval = brcmusb_usb_mdio_read(ctrl_base, 0x01, MDIO_USB3);\n\t\tval &= ~0x0008;\n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x01, val, MDIO_USB3);\n\t\tofs = PHY_PORT_SELECT_1;\n\t}\n}\n\nstatic void brcmusb_usb3_pll_54mhz(struct brcm_usb_init_params *params)\n{\n\tu32 ofs;\n\tint ii;\n\tvoid __iomem *ctrl_base = params->regs[BRCM_REGS_CTRL];\n\n\t \n\tswitch (params->selected_family) {\n\tcase BRCM_FAMILY_3390A0:\n\tcase BRCM_FAMILY_4908:\n\tcase BRCM_FAMILY_7250B0:\n\tcase BRCM_FAMILY_7366C0:\n\tcase BRCM_FAMILY_74371A0:\n\tcase BRCM_FAMILY_7439B0:\n\tcase BRCM_FAMILY_7445D0:\n\tcase BRCM_FAMILY_7260A0:\n\t\treturn;\n\tcase BRCM_FAMILY_7364A0:\n\t\tif (BRCM_REV(params->family_id) < 0x20)\n\t\t\treturn;\n\t\tbreak;\n\t}\n\n\t \n\tUSB_CTRL_UNSET(ctrl_base, USB30_CTL1, PHY3_PLL_SEQ_START);\n\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, 0x8000, MDIO_USB3);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x10, 0x5784, MDIO_USB3);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x11, 0x01d0, MDIO_USB3);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x12, 0x1DE8, MDIO_USB3);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x13, 0xAA80, MDIO_USB3);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x14, 0x8826, MDIO_USB3);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x15, 0x0044, MDIO_USB3);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x16, 0x8000, MDIO_USB3);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x17, 0x0851, MDIO_USB3);\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x18, 0x0000, MDIO_USB3);\n\n\t \n\tofs = 0;\n\tfor (ii = 0; ii < PHY_PORTS; ++ii) {\n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, (0x8040 + ofs),\n\t\t\t\t       MDIO_USB3);\n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x03, 0x0090, MDIO_USB3);\n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x04, 0x0134, MDIO_USB3);\n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, (0x8020 + ofs),\n\t\t\t\t       MDIO_USB3);\n\t\tbrcmusb_usb_mdio_write(ctrl_base, 0x01, 0x00e2, MDIO_USB3);\n\t\tofs = PHY_PORT_SELECT_1;\n\t}\n\n\t \n\tUSB_CTRL_SET(ctrl_base, USB30_CTL1, PHY3_PLL_SEQ_START);\n\t \n\tusleep_range(1000, 2000);\n}\n\nstatic void brcmusb_usb3_ssc_enable(void __iomem *ctrl_base)\n{\n\tu32 val;\n\n\t \n\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, 0x8040, MDIO_USB3);\n\tval = brcmusb_usb_mdio_read(ctrl_base, 0x01, MDIO_USB3) | 0xf;\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x01, val, MDIO_USB3);\n\n\t \n\tbrcmusb_usb_mdio_write(ctrl_base, 0x1f, 0x9040, MDIO_USB3);\n\tval = brcmusb_usb_mdio_read(ctrl_base, 0x01, MDIO_USB3) | 0xf;\n\tbrcmusb_usb_mdio_write(ctrl_base, 0x01, val, MDIO_USB3);\n}\n\nstatic void brcmusb_usb3_phy_workarounds(struct brcm_usb_init_params *params)\n{\n\tvoid __iomem *ctrl_base = params->regs[BRCM_REGS_CTRL];\n\n\tbrcmusb_usb3_pll_fix(ctrl_base);\n\tbrcmusb_usb3_pll_54mhz(params);\n\tbrcmusb_usb3_ssc_enable(ctrl_base);\n\tbrcmusb_usb3_enable_pipe_reset(ctrl_base);\n\tbrcmusb_usb3_enable_sigdet(ctrl_base);\n\tbrcmusb_usb3_enable_skip_align(ctrl_base);\n\tbrcmusb_usb3_unfreeze_aeq(ctrl_base);\n}\n\nstatic void brcmusb_memc_fix(struct brcm_usb_init_params *params)\n{\n\tu32 prid;\n\n\tif (params->selected_family != BRCM_FAMILY_7445D0)\n\t\treturn;\n\t \n\n\tprid = params->product_id & 0xfffff000;\n\tswitch (prid) {\n\tcase 0x72520000:\n\tcase 0x74480000:\n\tcase 0x74490000:\n\tcase 0x07252000:\n\tcase 0x07448000:\n\tcase 0x07449000:\n\t\tUSB_CTRL_UNSET_FAMILY(params, SETUP, SCB2_EN);\n\t}\n}\n\nstatic void brcmusb_usb3_otp_fix(struct brcm_usb_init_params *params)\n{\n\tvoid __iomem *xhci_ec_base = params->regs[BRCM_REGS_XHCI_EC];\n\tu32 val;\n\n\tif (params->family_id != 0x74371000 || !xhci_ec_base)\n\t\treturn;\n\tbrcm_usb_writel(0xa20c, USB_XHCI_EC_REG(xhci_ec_base, IRAADR));\n\tval = brcm_usb_readl(USB_XHCI_EC_REG(xhci_ec_base, IRADAT));\n\n\t \n\tval |= (1 << 27);\n\tbrcm_usb_writel(val, USB_XHCI_EC_REG(xhci_ec_base, IRADAT));\n\n\t \n\tUSB_CTRL_UNSET(params->regs[BRCM_REGS_CTRL], USB30_CTL1, PHY3_RESETB);\n\tUSB_CTRL_SET(params->regs[BRCM_REGS_CTRL], USB30_CTL1, PHY3_RESETB);\n}\n\nstatic void brcmusb_xhci_soft_reset(struct brcm_usb_init_params *params,\n\t\t\t\t    int on_off)\n{\n\t \n\tif (on_off) {\n\t\tif (USB_CTRL_MASK_FAMILY(params, USB_PM, XHC_SOFT_RESETB))\n\t\t\tUSB_CTRL_UNSET_FAMILY(params, USB_PM, XHC_SOFT_RESETB);\n\t\telse\n\t\t\tUSB_CTRL_UNSET_FAMILY(params,\n\t\t\t\t\t      USB30_CTL1, XHC_SOFT_RESETB);\n\t} else {  \n\t\tif (USB_CTRL_MASK_FAMILY(params, USB_PM, XHC_SOFT_RESETB))\n\t\t\tUSB_CTRL_SET_FAMILY(params, USB_PM, XHC_SOFT_RESETB);\n\t\telse\n\t\t\tUSB_CTRL_SET_FAMILY(params, USB30_CTL1,\n\t\t\t\t\t    XHC_SOFT_RESETB);\n\t}\n}\n\n \nstatic enum brcm_family_type get_family_type(\n\tstruct brcm_usb_init_params *params)\n{\n\tint last_type = -1;\n\tu32 last_family = 0;\n\tu32 family_no_major;\n\tunsigned int x;\n\tu32 family;\n\n\tfamily = params->family_id & 0xfffffff0;\n\tfamily_no_major = params->family_id & 0xffffff00;\n\tfor (x = 0; id_to_type_table[x].id; x++) {\n\t\tif (family == id_to_type_table[x].id)\n\t\t\treturn id_to_type_table[x].type;\n\t\tif (family_no_major == (id_to_type_table[x].id & 0xffffff00))\n\t\t\tif (family > id_to_type_table[x].id &&\n\t\t\t    last_family < id_to_type_table[x].id) {\n\t\t\t\tlast_family = id_to_type_table[x].id;\n\t\t\t\tlast_type = id_to_type_table[x].type;\n\t\t\t}\n\t}\n\n\t \n\tif (last_type == -1)\n\t\treturn id_to_type_table[x].type;\n\treturn last_type;\n}\n\nstatic void usb_init_ipp(struct brcm_usb_init_params *params)\n{\n\tvoid __iomem *ctrl = params->regs[BRCM_REGS_CTRL];\n\tu32 reg;\n\tu32 orig_reg;\n\n\t \n\tif (USB_CTRL_MASK_FAMILY(params, USB30_CTL1, USB3_IOC)) {\n\t\tif (params->ioc)\n\t\t\tUSB_CTRL_SET_FAMILY(params, USB30_CTL1, USB3_IOC);\n\t\tif (params->ipp == 1)\n\t\t\tUSB_CTRL_SET_FAMILY(params, USB30_CTL1, USB3_IPP);\n\t}\n\n\treg = brcm_usb_readl(USB_CTRL_REG(ctrl, SETUP));\n\torig_reg = reg;\n\tif (USB_CTRL_MASK_FAMILY(params, SETUP, STRAP_CC_DRD_MODE_ENABLE_SEL))\n\t\t \n\t\treg &= ~(USB_CTRL_MASK_FAMILY(params,\n\t\t\t\t\t      SETUP,\n\t\t\t\t\t      STRAP_CC_DRD_MODE_ENABLE_SEL));\n\tif (USB_CTRL_MASK_FAMILY(params, SETUP, STRAP_IPP_SEL))\n\t\t \n\t\tif (params->ipp != 2)\n\t\t\treg &= ~(USB_CTRL_MASK_FAMILY(params, SETUP,\n\t\t\t\t\t\t      STRAP_IPP_SEL));\n\n\t \n\treg &= ~(USB_CTRL_MASK(SETUP, IPP) | USB_CTRL_MASK(SETUP, IOC));\n\tif (params->ioc)\n\t\treg |= USB_CTRL_MASK(SETUP, IOC);\n\tif (params->ipp == 1)\n\t\treg |= USB_CTRL_MASK(SETUP, IPP);\n\tbrcm_usb_writel(reg, USB_CTRL_REG(ctrl, SETUP));\n\n\t \n\tif ((reg ^ orig_reg) & USB_CTRL_MASK(SETUP, IPP))\n\t\tmsleep(50);\n}\n\nstatic void usb_wake_enable(struct brcm_usb_init_params *params,\n\t\t\t  bool enable)\n{\n\tvoid __iomem *ctrl = params->regs[BRCM_REGS_CTRL];\n\n\tif (enable)\n\t\tUSB_CTRL_SET(ctrl, USB_PM, RMTWKUP_EN);\n\telse\n\t\tUSB_CTRL_UNSET(ctrl, USB_PM, RMTWKUP_EN);\n}\n\nstatic void usb_init_common(struct brcm_usb_init_params *params)\n{\n\tu32 reg;\n\tvoid __iomem *ctrl = params->regs[BRCM_REGS_CTRL];\n\n\t \n\tusb_wake_enable(params, false);\n\treg = brcm_usb_readl(USB_CTRL_REG(ctrl, USB_PM_STATUS));\n\tbrcm_usb_writel(reg, USB_CTRL_REG(ctrl, USB_PM_STATUS));\n\n\t \n\tif (USB_CTRL_MASK_FAMILY(params, PLL_CTL, PLL_IDDQ_PWRDN)) {\n\t\tUSB_CTRL_UNSET_FAMILY(params, PLL_CTL, PLL_IDDQ_PWRDN);\n\t\t \n\t\tusleep_range(1000, 2000);\n\t}\n\n\tif (USB_CTRL_MASK_FAMILY(params, USB_PM, USB_PWRDN)) {\n\t\tUSB_CTRL_UNSET_FAMILY(params, USB_PM, USB_PWRDN);\n\t\t \n\t\tusleep_range(1000, 2000);\n\t}\n\n\tif (params->selected_family != BRCM_FAMILY_74371A0 &&\n\t    (BRCM_ID(params->family_id) != 0x7364))\n\t\t \n\t\tUSB_CTRL_SET_FAMILY(params, SETUP, SS_EHCI64BIT_EN);\n\n\t \n\tUSB_CTRL_SET(ctrl, PLL_CTL, PLL_SUSPEND_EN);\n\n\treg = brcm_usb_readl(USB_CTRL_REG(ctrl, SETUP));\n\tif (params->selected_family == BRCM_FAMILY_7364A0)\n\t\t \n\t\treg |= USB_CTRL_MASK_FAMILY(params, SETUP, OC3_DISABLE);\n\n\tbrcmusb_usb_phy_ldo_fix(ctrl);\n\tbrcmusb_usb2_eye_fix(ctrl);\n\n\t \n\tif (USB_CTRL_MASK_FAMILY(params, SETUP, SCB1_EN))\n\t\treg |= USB_CTRL_MASK_FAMILY(params, SETUP, SCB1_EN);\n\tif (USB_CTRL_MASK_FAMILY(params, SETUP, SCB2_EN))\n\t\treg |= USB_CTRL_MASK_FAMILY(params, SETUP, SCB2_EN);\n\tbrcm_usb_writel(reg, USB_CTRL_REG(ctrl, SETUP));\n\n\tbrcmusb_memc_fix(params);\n\n\t \n\tif ((params->family_id == 0x74390012) &&\n\t    (params->supported_port_modes != USB_CTLR_MODE_HOST)) {\n\t\tUSB_CTRL_SET(ctrl, SETUP, OC_DISABLE_PORT1);\n\t\tUSB_CTRL_SET_FAMILY(params, SETUP, OC3_DISABLE_PORT1);\n\t}\n\n\tif (USB_CTRL_MASK_FAMILY(params, USB_DEVICE_CTL1, PORT_MODE)) {\n\t\treg = brcm_usb_readl(USB_CTRL_REG(ctrl, USB_DEVICE_CTL1));\n\t\treg &= ~USB_CTRL_MASK_FAMILY(params, USB_DEVICE_CTL1,\n\t\t\t\t\tPORT_MODE);\n\t\treg |= params->port_mode;\n\t\tbrcm_usb_writel(reg, USB_CTRL_REG(ctrl, USB_DEVICE_CTL1));\n\t}\n\tif (USB_CTRL_MASK_FAMILY(params, USB_PM, BDC_SOFT_RESETB)) {\n\t\tswitch (params->supported_port_modes) {\n\t\tcase USB_CTLR_MODE_HOST:\n\t\t\tUSB_CTRL_UNSET_FAMILY(params, USB_PM, BDC_SOFT_RESETB);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tUSB_CTRL_UNSET_FAMILY(params, USB_PM, BDC_SOFT_RESETB);\n\t\t\tUSB_CTRL_SET_FAMILY(params, USB_PM, BDC_SOFT_RESETB);\n\t\tbreak;\n\t\t}\n\t}\n\tif (USB_CTRL_MASK_FAMILY(params, SETUP, CC_DRD_MODE_ENABLE)) {\n\t\tif (params->supported_port_modes == USB_CTLR_MODE_TYPEC_PD)\n\t\t\tUSB_CTRL_SET_FAMILY(params, SETUP, CC_DRD_MODE_ENABLE);\n\t\telse\n\t\t\tUSB_CTRL_UNSET_FAMILY(params, SETUP,\n\t\t\t\t\t      CC_DRD_MODE_ENABLE);\n\t}\n}\n\nstatic void usb_init_eohci(struct brcm_usb_init_params *params)\n{\n\tu32 reg;\n\tvoid __iomem *ctrl = params->regs[BRCM_REGS_CTRL];\n\n\tif (USB_CTRL_MASK_FAMILY(params, USB_PM, USB20_HC_RESETB))\n\t\tUSB_CTRL_SET_FAMILY(params, USB_PM, USB20_HC_RESETB);\n\n\tif (params->selected_family == BRCM_FAMILY_7366C0)\n\t\t \n\t\tUSB_CTRL_SET(ctrl, EBRIDGE, ESTOP_SCB_REQ);\n\n\t \n\treg = brcm_usb_readl(USB_CTRL_REG(ctrl, SETUP));\n\treg &= ~USB_CTRL_SETUP_ENDIAN_BITS;\n\treg |= USB_CTRL_MASK_FAMILY(params, SETUP, ENDIAN);\n\tbrcm_usb_writel(reg, USB_CTRL_REG(ctrl, SETUP));\n\n\tif (params->selected_family == BRCM_FAMILY_7271A0)\n\t\t \n\t\tUSB_CTRL_SET(ctrl, OBRIDGE, LS_KEEP_ALIVE);\n\n\tif (params->family_id == 0x72550000) {\n\t\t \n\t\treg = brcm_usb_readl(USB_CTRL_REG(ctrl, EBRIDGE));\n\t\treg &= ~USB_CTRL_MASK(EBRIDGE, EBR_SCB_SIZE);\n\t\treg |= 0x800;\n\t\tbrcm_usb_writel(reg, USB_CTRL_REG(ctrl, EBRIDGE));\n\t}\n}\n\nstatic void usb_init_xhci(struct brcm_usb_init_params *params)\n{\n\tvoid __iomem *ctrl = params->regs[BRCM_REGS_CTRL];\n\n\tUSB_CTRL_UNSET(ctrl, USB30_PCTL, PHY3_IDDQ_OVERRIDE);\n\t \n\tusleep_range(1000, 2000);\n\n\tif (BRCM_ID(params->family_id) == 0x7366) {\n\t\t \n\t\tUSB_CTRL_SET(ctrl, USB30_PCTL, PHY3_SOFT_RESETB);\n\t\tUSB_CTRL_SET(ctrl, USB30_PCTL, PHY3_SOFT_RESETB_P1);\n\t}\n\n\t \n\tUSB_CTRL_UNSET(ctrl, USB30_CTL1, PHY3_PLL_SEQ_START);\n\tUSB_CTRL_SET(ctrl, USB30_CTL1, PHY3_PLL_SEQ_START);\n\n\tbrcmusb_usb3_phy_workarounds(params);\n\tbrcmusb_xhci_soft_reset(params, 0);\n\tbrcmusb_usb3_otp_fix(params);\n}\n\nstatic void usb_uninit_common(struct brcm_usb_init_params *params)\n{\n\tif (USB_CTRL_MASK_FAMILY(params, USB_PM, USB_PWRDN))\n\t\tUSB_CTRL_SET_FAMILY(params, USB_PM, USB_PWRDN);\n\n\tif (USB_CTRL_MASK_FAMILY(params, PLL_CTL, PLL_IDDQ_PWRDN))\n\t\tUSB_CTRL_SET_FAMILY(params, PLL_CTL, PLL_IDDQ_PWRDN);\n\tif (params->wake_enabled)\n\t\tusb_wake_enable(params, true);\n}\n\nstatic void usb_uninit_eohci(struct brcm_usb_init_params *params)\n{\n}\n\nstatic void usb_uninit_xhci(struct brcm_usb_init_params *params)\n{\n\tbrcmusb_xhci_soft_reset(params, 1);\n\tUSB_CTRL_SET(params->regs[BRCM_REGS_CTRL], USB30_PCTL,\n\t\t     PHY3_IDDQ_OVERRIDE);\n}\n\nstatic int usb_get_dual_select(struct brcm_usb_init_params *params)\n{\n\tvoid __iomem *ctrl = params->regs[BRCM_REGS_CTRL];\n\tu32 reg = 0;\n\n\tpr_debug(\"%s\\n\", __func__);\n\tif (USB_CTRL_MASK_FAMILY(params, USB_DEVICE_CTL1, PORT_MODE)) {\n\t\treg = brcm_usb_readl(USB_CTRL_REG(ctrl, USB_DEVICE_CTL1));\n\t\treg &= USB_CTRL_MASK_FAMILY(params, USB_DEVICE_CTL1,\n\t\t\t\t\tPORT_MODE);\n\t}\n\treturn reg;\n}\n\nstatic void usb_set_dual_select(struct brcm_usb_init_params *params)\n{\n\tvoid __iomem *ctrl = params->regs[BRCM_REGS_CTRL];\n\tu32 reg;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tif (USB_CTRL_MASK_FAMILY(params, USB_DEVICE_CTL1, PORT_MODE)) {\n\t\treg = brcm_usb_readl(USB_CTRL_REG(ctrl, USB_DEVICE_CTL1));\n\t\treg &= ~USB_CTRL_MASK_FAMILY(params, USB_DEVICE_CTL1,\n\t\t\t\t\tPORT_MODE);\n\t\treg |= params->port_mode;\n\t\tbrcm_usb_writel(reg, USB_CTRL_REG(ctrl, USB_DEVICE_CTL1));\n\t}\n}\n\nstatic const struct brcm_usb_init_ops bcm7445_ops = {\n\t.init_ipp = usb_init_ipp,\n\t.init_common = usb_init_common,\n\t.init_eohci = usb_init_eohci,\n\t.init_xhci = usb_init_xhci,\n\t.uninit_common = usb_uninit_common,\n\t.uninit_eohci = usb_uninit_eohci,\n\t.uninit_xhci = usb_uninit_xhci,\n\t.get_dual_select = usb_get_dual_select,\n\t.set_dual_select = usb_set_dual_select,\n};\n\nvoid brcm_usb_dvr_init_4908(struct brcm_usb_init_params *params)\n{\n\tint fam;\n\n\tfam = BRCM_FAMILY_4908;\n\tparams->selected_family = fam;\n\tparams->usb_reg_bits_map =\n\t\t&usb_reg_bits_map_table[fam][0];\n\tparams->family_name = family_names[fam];\n\tparams->ops = &bcm7445_ops;\n}\n\nvoid brcm_usb_dvr_init_7445(struct brcm_usb_init_params *params)\n{\n\tint fam;\n\n\tpr_debug(\"%s\\n\", __func__);\n\n\tfam = get_family_type(params);\n\tparams->selected_family = fam;\n\tparams->usb_reg_bits_map =\n\t\t&usb_reg_bits_map_table[fam][0];\n\tparams->family_name = family_names[fam];\n\tparams->ops = &bcm7445_ops;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}