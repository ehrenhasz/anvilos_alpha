{
  "module_name": "phy-da8xx-usb.c",
  "hash_id": "f8a861f5d8f2f4ba95da838233f903eeed7bcbe9929b39d688ef11f8e63665df",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/ti/phy-da8xx-usb.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/io.h>\n#include <linux/of.h>\n#include <linux/mfd/da8xx-cfgchip.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_data/phy-da8xx-usb.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define PHY_INIT_BITS\t(CFGCHIP2_SESENDEN | CFGCHIP2_VBDTCTEN)\n\nstruct da8xx_usb_phy {\n\tstruct phy_provider\t*phy_provider;\n\tstruct phy\t\t*usb11_phy;\n\tstruct phy\t\t*usb20_phy;\n\tstruct clk\t\t*usb11_clk;\n\tstruct clk\t\t*usb20_clk;\n\tstruct regmap\t\t*regmap;\n};\n\nstatic int da8xx_usb11_phy_power_on(struct phy *phy)\n{\n\tstruct da8xx_usb_phy *d_phy = phy_get_drvdata(phy);\n\tint ret;\n\n\tret = clk_prepare_enable(d_phy->usb11_clk);\n\tif (ret)\n\t\treturn ret;\n\n\tregmap_write_bits(d_phy->regmap, CFGCHIP(2), CFGCHIP2_USB1SUSPENDM,\n\t\t\t  CFGCHIP2_USB1SUSPENDM);\n\n\treturn 0;\n}\n\nstatic int da8xx_usb11_phy_power_off(struct phy *phy)\n{\n\tstruct da8xx_usb_phy *d_phy = phy_get_drvdata(phy);\n\n\tregmap_write_bits(d_phy->regmap, CFGCHIP(2), CFGCHIP2_USB1SUSPENDM, 0);\n\n\tclk_disable_unprepare(d_phy->usb11_clk);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops da8xx_usb11_phy_ops = {\n\t.power_on\t= da8xx_usb11_phy_power_on,\n\t.power_off\t= da8xx_usb11_phy_power_off,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int da8xx_usb20_phy_power_on(struct phy *phy)\n{\n\tstruct da8xx_usb_phy *d_phy = phy_get_drvdata(phy);\n\tint ret;\n\n\tret = clk_prepare_enable(d_phy->usb20_clk);\n\tif (ret)\n\t\treturn ret;\n\n\tregmap_write_bits(d_phy->regmap, CFGCHIP(2), CFGCHIP2_OTGPWRDN, 0);\n\n\treturn 0;\n}\n\nstatic int da8xx_usb20_phy_power_off(struct phy *phy)\n{\n\tstruct da8xx_usb_phy *d_phy = phy_get_drvdata(phy);\n\n\tregmap_write_bits(d_phy->regmap, CFGCHIP(2), CFGCHIP2_OTGPWRDN,\n\t\t\t  CFGCHIP2_OTGPWRDN);\n\n\tclk_disable_unprepare(d_phy->usb20_clk);\n\n\treturn 0;\n}\n\nstatic int da8xx_usb20_phy_set_mode(struct phy *phy,\n\t\t\t\t    enum phy_mode mode, int submode)\n{\n\tstruct da8xx_usb_phy *d_phy = phy_get_drvdata(phy);\n\tu32 val;\n\n\tswitch (mode) {\n\tcase PHY_MODE_USB_HOST:\t\t \n\t\tval = CFGCHIP2_OTGMODE_FORCE_HOST;\n\t\tbreak;\n\tcase PHY_MODE_USB_DEVICE:\t \n\t\tval = CFGCHIP2_OTGMODE_FORCE_DEVICE;\n\t\tbreak;\n\tcase PHY_MODE_USB_OTG:\t \n\t\tval = CFGCHIP2_OTGMODE_NO_OVERRIDE;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_write_bits(d_phy->regmap, CFGCHIP(2), CFGCHIP2_OTGMODE_MASK,\n\t\t\t  val);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops da8xx_usb20_phy_ops = {\n\t.power_on\t= da8xx_usb20_phy_power_on,\n\t.power_off\t= da8xx_usb20_phy_power_off,\n\t.set_mode\t= da8xx_usb20_phy_set_mode,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic struct phy *da8xx_usb_phy_of_xlate(struct device *dev,\n\t\t\t\t\t struct of_phandle_args *args)\n{\n\tstruct da8xx_usb_phy *d_phy = dev_get_drvdata(dev);\n\n\tif (!d_phy)\n\t\treturn ERR_PTR(-ENODEV);\n\n\tswitch (args->args[0]) {\n\tcase 0:\n\t\treturn d_phy->usb20_phy;\n\tcase 1:\n\t\treturn d_phy->usb11_phy;\n\tdefault:\n\t\treturn ERR_PTR(-EINVAL);\n\t}\n}\n\nstatic int da8xx_usb_phy_probe(struct platform_device *pdev)\n{\n\tstruct device\t\t*dev = &pdev->dev;\n\tstruct da8xx_usb_phy_platform_data *pdata = dev->platform_data;\n\tstruct device_node\t*node = dev->of_node;\n\tstruct da8xx_usb_phy\t*d_phy;\n\n\td_phy = devm_kzalloc(dev, sizeof(*d_phy), GFP_KERNEL);\n\tif (!d_phy)\n\t\treturn -ENOMEM;\n\n\tif (pdata)\n\t\td_phy->regmap = pdata->cfgchip;\n\telse\n\t\td_phy->regmap = syscon_regmap_lookup_by_compatible(\n\t\t\t\t\t\t\t\"ti,da830-cfgchip\");\n\tif (IS_ERR(d_phy->regmap)) {\n\t\tdev_err(dev, \"Failed to get syscon\\n\");\n\t\treturn PTR_ERR(d_phy->regmap);\n\t}\n\n\td_phy->usb11_clk = devm_clk_get(dev, \"usb1_clk48\");\n\tif (IS_ERR(d_phy->usb11_clk)) {\n\t\tdev_err(dev, \"Failed to get usb1_clk48\\n\");\n\t\treturn PTR_ERR(d_phy->usb11_clk);\n\t}\n\n\td_phy->usb20_clk = devm_clk_get(dev, \"usb0_clk48\");\n\tif (IS_ERR(d_phy->usb20_clk)) {\n\t\tdev_err(dev, \"Failed to get usb0_clk48\\n\");\n\t\treturn PTR_ERR(d_phy->usb20_clk);\n\t}\n\n\td_phy->usb11_phy = devm_phy_create(dev, node, &da8xx_usb11_phy_ops);\n\tif (IS_ERR(d_phy->usb11_phy)) {\n\t\tdev_err(dev, \"Failed to create usb11 phy\\n\");\n\t\treturn PTR_ERR(d_phy->usb11_phy);\n\t}\n\n\td_phy->usb20_phy = devm_phy_create(dev, node, &da8xx_usb20_phy_ops);\n\tif (IS_ERR(d_phy->usb20_phy)) {\n\t\tdev_err(dev, \"Failed to create usb20 phy\\n\");\n\t\treturn PTR_ERR(d_phy->usb20_phy);\n\t}\n\n\tplatform_set_drvdata(pdev, d_phy);\n\tphy_set_drvdata(d_phy->usb11_phy, d_phy);\n\tphy_set_drvdata(d_phy->usb20_phy, d_phy);\n\n\tif (node) {\n\t\td_phy->phy_provider = devm_of_phy_provider_register(dev,\n\t\t\t\t\t\t\tda8xx_usb_phy_of_xlate);\n\t\tif (IS_ERR(d_phy->phy_provider)) {\n\t\t\tdev_err(dev, \"Failed to create phy provider\\n\");\n\t\t\treturn PTR_ERR(d_phy->phy_provider);\n\t\t}\n\t} else {\n\t\tint ret;\n\n\t\tret = phy_create_lookup(d_phy->usb11_phy, \"usb-phy\",\n\t\t\t\t\t\"ohci-da8xx\");\n\t\tif (ret)\n\t\t\tdev_warn(dev, \"Failed to create usb11 phy lookup\\n\");\n\t\tret = phy_create_lookup(d_phy->usb20_phy, \"usb-phy\",\n\t\t\t\t\t\"musb-da8xx\");\n\t\tif (ret)\n\t\t\tdev_warn(dev, \"Failed to create usb20 phy lookup\\n\");\n\t}\n\n\tregmap_write_bits(d_phy->regmap, CFGCHIP(2),\n\t\t\t  PHY_INIT_BITS, PHY_INIT_BITS);\n\n\treturn 0;\n}\n\nstatic void da8xx_usb_phy_remove(struct platform_device *pdev)\n{\n\tstruct da8xx_usb_phy *d_phy = platform_get_drvdata(pdev);\n\n\tif (!pdev->dev.of_node) {\n\t\tphy_remove_lookup(d_phy->usb20_phy, \"usb-phy\", \"musb-da8xx\");\n\t\tphy_remove_lookup(d_phy->usb11_phy, \"usb-phy\", \"ohci-da8xx\");\n\t}\n}\n\nstatic const struct of_device_id da8xx_usb_phy_ids[] = {\n\t{ .compatible = \"ti,da830-usb-phy\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, da8xx_usb_phy_ids);\n\nstatic struct platform_driver da8xx_usb_phy_driver = {\n\t.probe\t= da8xx_usb_phy_probe,\n\t.remove_new = da8xx_usb_phy_remove,\n\t.driver\t= {\n\t\t.name\t= \"da8xx-usb-phy\",\n\t\t.of_match_table = da8xx_usb_phy_ids,\n\t},\n};\n\nmodule_platform_driver(da8xx_usb_phy_driver);\n\nMODULE_ALIAS(\"platform:da8xx-usb-phy\");\nMODULE_AUTHOR(\"David Lechner <david@lechnology.com>\");\nMODULE_DESCRIPTION(\"TI DA8xx USB PHY driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}