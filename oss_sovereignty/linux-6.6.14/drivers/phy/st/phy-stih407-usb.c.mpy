{
  "module_name": "phy-stih407-usb.c",
  "hash_id": "eb8b0f739806d3f9ee3feafc1b19f7296987dd15da4f37fefde9d72ab284ad40",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/st/phy-stih407-usb.c",
  "human_readable_source": "\n \n#include <linux/platform_device.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/clk.h>\n#include <linux/regmap.h>\n#include <linux/reset.h>\n#include <linux/mfd/syscon.h>\n#include <linux/phy/phy.h>\n\n#define PHYPARAM_REG\t1\n#define PHYCTRL_REG\t2\n\n \n#define STIH407_USB_PICOPHY_CTRL_PORT_CONF\t0x6\n#define STIH407_USB_PICOPHY_CTRL_PORT_MASK\t0x1f\n\n \n#define STIH407_USB_PICOPHY_PARAM_DEF\t\t0x39a4dc\n#define STIH407_USB_PICOPHY_PARAM_MASK\t\t0xffffffff\n\nstruct stih407_usb2_picophy {\n\tstruct phy *phy;\n\tstruct regmap *regmap;\n\tstruct device *dev;\n\tstruct reset_control *rstc;\n\tstruct reset_control *rstport;\n\tint ctrl;\n\tint param;\n};\n\nstatic int stih407_usb2_pico_ctrl(struct stih407_usb2_picophy *phy_dev)\n{\n\treset_control_deassert(phy_dev->rstc);\n\n\treturn regmap_update_bits(phy_dev->regmap, phy_dev->ctrl,\n\t\t\t\t  STIH407_USB_PICOPHY_CTRL_PORT_MASK,\n\t\t\t\t  STIH407_USB_PICOPHY_CTRL_PORT_CONF);\n}\n\nstatic int stih407_usb2_init_port(struct phy *phy)\n{\n\tint ret;\n\tstruct stih407_usb2_picophy *phy_dev = phy_get_drvdata(phy);\n\n\tstih407_usb2_pico_ctrl(phy_dev);\n\n\tret = regmap_update_bits(phy_dev->regmap,\n\t\t\t\t phy_dev->param,\n\t\t\t\t STIH407_USB_PICOPHY_PARAM_MASK,\n\t\t\t\t STIH407_USB_PICOPHY_PARAM_DEF);\n\tif (ret)\n\t\treturn ret;\n\n\treturn reset_control_deassert(phy_dev->rstport);\n}\n\nstatic int stih407_usb2_exit_port(struct phy *phy)\n{\n\tstruct stih407_usb2_picophy *phy_dev = phy_get_drvdata(phy);\n\n\t \n\treturn reset_control_assert(phy_dev->rstport);\n}\n\nstatic const struct phy_ops stih407_usb2_picophy_data = {\n\t.init = stih407_usb2_init_port,\n\t.exit = stih407_usb2_exit_port,\n\t.owner = THIS_MODULE,\n};\n\nstatic int stih407_usb2_picophy_probe(struct platform_device *pdev)\n{\n\tstruct stih407_usb2_picophy *phy_dev;\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *np = dev->of_node;\n\tstruct phy_provider *phy_provider;\n\tstruct phy *phy;\n\tint ret;\n\n\tphy_dev = devm_kzalloc(dev, sizeof(*phy_dev), GFP_KERNEL);\n\tif (!phy_dev)\n\t\treturn -ENOMEM;\n\n\tphy_dev->dev = dev;\n\tdev_set_drvdata(dev, phy_dev);\n\n\tphy_dev->rstc = devm_reset_control_get_shared(dev, \"global\");\n\tif (IS_ERR(phy_dev->rstc)) {\n\t\tdev_err(dev, \"failed to ctrl picoPHY reset\\n\");\n\t\treturn PTR_ERR(phy_dev->rstc);\n\t}\n\n\tphy_dev->rstport = devm_reset_control_get_exclusive(dev, \"port\");\n\tif (IS_ERR(phy_dev->rstport)) {\n\t\tdev_err(dev, \"failed to ctrl picoPHY reset\\n\");\n\t\treturn PTR_ERR(phy_dev->rstport);\n\t}\n\n\t \n\treset_control_assert(phy_dev->rstport);\n\n\tphy_dev->regmap = syscon_regmap_lookup_by_phandle(np, \"st,syscfg\");\n\tif (IS_ERR(phy_dev->regmap)) {\n\t\tdev_err(dev, \"No syscfg phandle specified\\n\");\n\t\treturn PTR_ERR(phy_dev->regmap);\n\t}\n\n\tret = of_property_read_u32_index(np, \"st,syscfg\", PHYPARAM_REG,\n\t\t\t\t\t&phy_dev->param);\n\tif (ret) {\n\t\tdev_err(dev, \"can't get phyparam offset (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tret = of_property_read_u32_index(np, \"st,syscfg\", PHYCTRL_REG,\n\t\t\t\t\t&phy_dev->ctrl);\n\tif (ret) {\n\t\tdev_err(dev, \"can't get phyctrl offset (%d)\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tphy = devm_phy_create(dev, NULL, &stih407_usb2_picophy_data);\n\tif (IS_ERR(phy)) {\n\t\tdev_err(dev, \"failed to create Display Port PHY\\n\");\n\t\treturn PTR_ERR(phy);\n\t}\n\n\tphy_dev->phy = phy;\n\tphy_set_drvdata(phy, phy_dev);\n\n\tphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\n\tif (IS_ERR(phy_provider))\n\t\treturn PTR_ERR(phy_provider);\n\n\tdev_info(dev, \"STiH407 USB Generic picoPHY driver probed!\");\n\n\treturn 0;\n}\n\nstatic const struct of_device_id stih407_usb2_picophy_of_match[] = {\n\t{ .compatible = \"st,stih407-usb2-phy\" },\n\t{   },\n};\n\nMODULE_DEVICE_TABLE(of, stih407_usb2_picophy_of_match);\n\nstatic struct platform_driver stih407_usb2_picophy_driver = {\n\t.probe = stih407_usb2_picophy_probe,\n\t.driver = {\n\t\t   .name = \"stih407-usb-genphy\",\n\t\t   .of_match_table = stih407_usb2_picophy_of_match,\n\t\t   }\n};\n\nmodule_platform_driver(stih407_usb2_picophy_driver);\n\nMODULE_AUTHOR(\"Giuseppe Cavallaro <peppe.cavallaro@st.com>\");\nMODULE_DESCRIPTION(\"STMicroelectronics Generic picoPHY driver for STiH407\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}