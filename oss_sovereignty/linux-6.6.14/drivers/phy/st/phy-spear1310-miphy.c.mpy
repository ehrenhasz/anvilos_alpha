{
  "module_name": "phy-spear1310-miphy.c",
  "hash_id": "2892aa27f4cfe03e0247f4bc51c6ac485ff0d1708c547bdc62c99764b2a74963",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/st/phy-spear1310-miphy.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/delay.h>\n#include <linux/dma-mapping.h>\n#include <linux/kernel.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n \n#define SPEAR1310_PCIE_SATA_CFG\t\t\t0x3A4\n\t#define SPEAR1310_PCIE_SATA2_SEL_PCIE\t\t(0 << 31)\n\t#define SPEAR1310_PCIE_SATA1_SEL_PCIE\t\t(0 << 30)\n\t#define SPEAR1310_PCIE_SATA0_SEL_PCIE\t\t(0 << 29)\n\t#define SPEAR1310_PCIE_SATA2_SEL_SATA\t\tBIT(31)\n\t#define SPEAR1310_PCIE_SATA1_SEL_SATA\t\tBIT(30)\n\t#define SPEAR1310_PCIE_SATA0_SEL_SATA\t\tBIT(29)\n\t#define SPEAR1310_SATA2_CFG_TX_CLK_EN\t\tBIT(27)\n\t#define SPEAR1310_SATA2_CFG_RX_CLK_EN\t\tBIT(26)\n\t#define SPEAR1310_SATA2_CFG_POWERUP_RESET\tBIT(25)\n\t#define SPEAR1310_SATA2_CFG_PM_CLK_EN\t\tBIT(24)\n\t#define SPEAR1310_SATA1_CFG_TX_CLK_EN\t\tBIT(23)\n\t#define SPEAR1310_SATA1_CFG_RX_CLK_EN\t\tBIT(22)\n\t#define SPEAR1310_SATA1_CFG_POWERUP_RESET\tBIT(21)\n\t#define SPEAR1310_SATA1_CFG_PM_CLK_EN\t\tBIT(20)\n\t#define SPEAR1310_SATA0_CFG_TX_CLK_EN\t\tBIT(19)\n\t#define SPEAR1310_SATA0_CFG_RX_CLK_EN\t\tBIT(18)\n\t#define SPEAR1310_SATA0_CFG_POWERUP_RESET\tBIT(17)\n\t#define SPEAR1310_SATA0_CFG_PM_CLK_EN\t\tBIT(16)\n\t#define SPEAR1310_PCIE2_CFG_DEVICE_PRESENT\tBIT(11)\n\t#define SPEAR1310_PCIE2_CFG_POWERUP_RESET\tBIT(10)\n\t#define SPEAR1310_PCIE2_CFG_CORE_CLK_EN\t\tBIT(9)\n\t#define SPEAR1310_PCIE2_CFG_AUX_CLK_EN\t\tBIT(8)\n\t#define SPEAR1310_PCIE1_CFG_DEVICE_PRESENT\tBIT(7)\n\t#define SPEAR1310_PCIE1_CFG_POWERUP_RESET\tBIT(6)\n\t#define SPEAR1310_PCIE1_CFG_CORE_CLK_EN\t\tBIT(5)\n\t#define SPEAR1310_PCIE1_CFG_AUX_CLK_EN\t\tBIT(4)\n\t#define SPEAR1310_PCIE0_CFG_DEVICE_PRESENT\tBIT(3)\n\t#define SPEAR1310_PCIE0_CFG_POWERUP_RESET\tBIT(2)\n\t#define SPEAR1310_PCIE0_CFG_CORE_CLK_EN\t\tBIT(1)\n\t#define SPEAR1310_PCIE0_CFG_AUX_CLK_EN\t\tBIT(0)\n\n\t#define SPEAR1310_PCIE_CFG_MASK(x) ((0xF << (x * 4)) | BIT((x + 29)))\n\t#define SPEAR1310_SATA_CFG_MASK(x) ((0xF << (x * 4 + 16)) | \\\n\t\t\tBIT((x + 29)))\n\t#define SPEAR1310_PCIE_CFG_VAL(x) \\\n\t\t\t(SPEAR1310_PCIE_SATA##x##_SEL_PCIE | \\\n\t\t\tSPEAR1310_PCIE##x##_CFG_AUX_CLK_EN | \\\n\t\t\tSPEAR1310_PCIE##x##_CFG_CORE_CLK_EN | \\\n\t\t\tSPEAR1310_PCIE##x##_CFG_POWERUP_RESET | \\\n\t\t\tSPEAR1310_PCIE##x##_CFG_DEVICE_PRESENT)\n\t#define SPEAR1310_SATA_CFG_VAL(x) \\\n\t\t\t(SPEAR1310_PCIE_SATA##x##_SEL_SATA | \\\n\t\t\tSPEAR1310_SATA##x##_CFG_PM_CLK_EN | \\\n\t\t\tSPEAR1310_SATA##x##_CFG_POWERUP_RESET | \\\n\t\t\tSPEAR1310_SATA##x##_CFG_RX_CLK_EN | \\\n\t\t\tSPEAR1310_SATA##x##_CFG_TX_CLK_EN)\n\n#define SPEAR1310_PCIE_MIPHY_CFG_1\t\t0x3A8\n\t#define SPEAR1310_MIPHY_DUAL_OSC_BYPASS_EXT\tBIT(31)\n\t#define SPEAR1310_MIPHY_DUAL_CLK_REF_DIV2\tBIT(28)\n\t#define SPEAR1310_MIPHY_DUAL_PLL_RATIO_TOP(x)\t(x << 16)\n\t#define SPEAR1310_MIPHY_SINGLE_OSC_BYPASS_EXT\tBIT(15)\n\t#define SPEAR1310_MIPHY_SINGLE_CLK_REF_DIV2\tBIT(12)\n\t#define SPEAR1310_MIPHY_SINGLE_PLL_RATIO_TOP(x)\t(x << 0)\n\t#define SPEAR1310_PCIE_SATA_MIPHY_CFG_SATA_MASK (0xFFFF)\n\t#define SPEAR1310_PCIE_SATA_MIPHY_CFG_PCIE_MASK (0xFFFF << 16)\n\t#define SPEAR1310_PCIE_SATA_MIPHY_CFG_SATA \\\n\t\t\t(SPEAR1310_MIPHY_DUAL_OSC_BYPASS_EXT | \\\n\t\t\tSPEAR1310_MIPHY_DUAL_CLK_REF_DIV2 | \\\n\t\t\tSPEAR1310_MIPHY_DUAL_PLL_RATIO_TOP(60) | \\\n\t\t\tSPEAR1310_MIPHY_SINGLE_OSC_BYPASS_EXT | \\\n\t\t\tSPEAR1310_MIPHY_SINGLE_CLK_REF_DIV2 | \\\n\t\t\tSPEAR1310_MIPHY_SINGLE_PLL_RATIO_TOP(60))\n\t#define SPEAR1310_PCIE_SATA_MIPHY_CFG_SATA_25M_CRYSTAL_CLK \\\n\t\t\t(SPEAR1310_MIPHY_SINGLE_PLL_RATIO_TOP(120))\n\t#define SPEAR1310_PCIE_SATA_MIPHY_CFG_PCIE \\\n\t\t\t(SPEAR1310_MIPHY_DUAL_OSC_BYPASS_EXT | \\\n\t\t\tSPEAR1310_MIPHY_DUAL_PLL_RATIO_TOP(25) | \\\n\t\t\tSPEAR1310_MIPHY_SINGLE_OSC_BYPASS_EXT | \\\n\t\t\tSPEAR1310_MIPHY_SINGLE_PLL_RATIO_TOP(25))\n\n#define SPEAR1310_PCIE_MIPHY_CFG_2\t\t0x3AC\n\nenum spear1310_miphy_mode {\n\tSATA,\n\tPCIE,\n};\n\nstruct spear1310_miphy_priv {\n\t \n\tu32\t\t\t\tid;\n\t \n\tenum spear1310_miphy_mode\tmode;\n\t \n\tstruct regmap\t\t\t*misc;\n\t \n\tstruct phy\t\t\t*phy;\n};\n\nstatic int spear1310_miphy_pcie_init(struct spear1310_miphy_priv *priv)\n{\n\tu32 val;\n\n\tregmap_update_bits(priv->misc, SPEAR1310_PCIE_MIPHY_CFG_1,\n\t\t\t   SPEAR1310_PCIE_SATA_MIPHY_CFG_PCIE_MASK,\n\t\t\t   SPEAR1310_PCIE_SATA_MIPHY_CFG_PCIE);\n\n\tswitch (priv->id) {\n\tcase 0:\n\t\tval = SPEAR1310_PCIE_CFG_VAL(0);\n\t\tbreak;\n\tcase 1:\n\t\tval = SPEAR1310_PCIE_CFG_VAL(1);\n\t\tbreak;\n\tcase 2:\n\t\tval = SPEAR1310_PCIE_CFG_VAL(2);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tregmap_update_bits(priv->misc, SPEAR1310_PCIE_SATA_CFG,\n\t\t\t   SPEAR1310_PCIE_CFG_MASK(priv->id), val);\n\n\treturn 0;\n}\n\nstatic int spear1310_miphy_pcie_exit(struct spear1310_miphy_priv *priv)\n{\n\tregmap_update_bits(priv->misc, SPEAR1310_PCIE_SATA_CFG,\n\t\t\t   SPEAR1310_PCIE_CFG_MASK(priv->id), 0);\n\n\tregmap_update_bits(priv->misc, SPEAR1310_PCIE_MIPHY_CFG_1,\n\t\t\t   SPEAR1310_PCIE_SATA_MIPHY_CFG_PCIE_MASK, 0);\n\n\treturn 0;\n}\n\nstatic int spear1310_miphy_init(struct phy *phy)\n{\n\tstruct spear1310_miphy_priv *priv = phy_get_drvdata(phy);\n\tint ret = 0;\n\n\tif (priv->mode == PCIE)\n\t\tret = spear1310_miphy_pcie_init(priv);\n\n\treturn ret;\n}\n\nstatic int spear1310_miphy_exit(struct phy *phy)\n{\n\tstruct spear1310_miphy_priv *priv = phy_get_drvdata(phy);\n\tint ret = 0;\n\n\tif (priv->mode == PCIE)\n\t\tret = spear1310_miphy_pcie_exit(priv);\n\n\treturn ret;\n}\n\nstatic const struct of_device_id spear1310_miphy_of_match[] = {\n\t{ .compatible = \"st,spear1310-miphy\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, spear1310_miphy_of_match);\n\nstatic const struct phy_ops spear1310_miphy_ops = {\n\t.init = spear1310_miphy_init,\n\t.exit = spear1310_miphy_exit,\n\t.owner = THIS_MODULE,\n};\n\nstatic struct phy *spear1310_miphy_xlate(struct device *dev,\n\t\t\t\t\t struct of_phandle_args *args)\n{\n\tstruct spear1310_miphy_priv *priv = dev_get_drvdata(dev);\n\n\tif (args->args_count < 1) {\n\t\tdev_err(dev, \"DT did not pass correct no of args\\n\");\n\t\treturn ERR_PTR(-ENODEV);\n\t}\n\n\tpriv->mode = args->args[0];\n\n\tif (priv->mode != SATA && priv->mode != PCIE) {\n\t\tdev_err(dev, \"DT did not pass correct phy mode\\n\");\n\t\treturn ERR_PTR(-ENODEV);\n\t}\n\n\treturn priv->phy;\n}\n\nstatic int spear1310_miphy_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct spear1310_miphy_priv *priv;\n\tstruct phy_provider *phy_provider;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->misc =\n\t\tsyscon_regmap_lookup_by_phandle(dev->of_node, \"misc\");\n\tif (IS_ERR(priv->misc)) {\n\t\tdev_err(dev, \"failed to find misc regmap\\n\");\n\t\treturn PTR_ERR(priv->misc);\n\t}\n\n\tif (of_property_read_u32(dev->of_node, \"phy-id\", &priv->id)) {\n\t\tdev_err(dev, \"failed to find phy id\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tpriv->phy = devm_phy_create(dev, NULL, &spear1310_miphy_ops);\n\tif (IS_ERR(priv->phy)) {\n\t\tdev_err(dev, \"failed to create SATA PCIe PHY\\n\");\n\t\treturn PTR_ERR(priv->phy);\n\t}\n\n\tdev_set_drvdata(dev, priv);\n\tphy_set_drvdata(priv->phy, priv);\n\n\tphy_provider =\n\t\tdevm_of_phy_provider_register(dev, spear1310_miphy_xlate);\n\tif (IS_ERR(phy_provider)) {\n\t\tdev_err(dev, \"failed to register phy provider\\n\");\n\t\treturn PTR_ERR(phy_provider);\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver spear1310_miphy_driver = {\n\t.probe\t\t= spear1310_miphy_probe,\n\t.driver = {\n\t\t.name = \"spear1310-miphy\",\n\t\t.of_match_table = spear1310_miphy_of_match,\n\t},\n};\n\nmodule_platform_driver(spear1310_miphy_driver);\n\nMODULE_DESCRIPTION(\"ST SPEAR1310-MIPHY driver\");\nMODULE_AUTHOR(\"Pratyush Anand <pratyush.anand@gmail.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}