{
  "module_name": "phy-spear1340-miphy.c",
  "hash_id": "650d0f6a03479b6f3624ac198ef273367dc256cbfaab9da7175401b9abedb133",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/st/phy-spear1340-miphy.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/delay.h>\n#include <linux/dma-mapping.h>\n#include <linux/kernel.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n \n \n#define SPEAR1340_PCM_CFG\t\t\t0x100\n\t#define SPEAR1340_PCM_CFG_SATA_POWER_EN\t\tBIT(11)\n#define SPEAR1340_PCM_WKUP_CFG\t\t\t0x104\n#define SPEAR1340_SWITCH_CTR\t\t\t0x108\n\n#define SPEAR1340_PERIP1_SW_RST\t\t\t0x318\n\t#define SPEAR1340_PERIP1_SW_RSATA\t\tBIT(12)\n#define SPEAR1340_PERIP2_SW_RST\t\t\t0x31C\n#define SPEAR1340_PERIP3_SW_RST\t\t\t0x320\n\n \n#define SPEAR1340_PCIE_SATA_CFG\t\t\t0x424\n\t \n\t#define SPEAR1340_PCIE_CFG_DEVICE_PRESENT\tBIT(11)\n\t#define SPEAR1340_PCIE_CFG_POWERUP_RESET\tBIT(10)\n\t#define SPEAR1340_PCIE_CFG_CORE_CLK_EN\t\tBIT(9)\n\t#define SPEAR1340_PCIE_CFG_AUX_CLK_EN\t\tBIT(8)\n\t#define SPEAR1340_SATA_CFG_TX_CLK_EN\t\tBIT(4)\n\t#define SPEAR1340_SATA_CFG_RX_CLK_EN\t\tBIT(3)\n\t#define SPEAR1340_SATA_CFG_POWERUP_RESET\tBIT(2)\n\t#define SPEAR1340_SATA_CFG_PM_CLK_EN\t\tBIT(1)\n\t#define SPEAR1340_PCIE_SATA_SEL_PCIE\t\t(0)\n\t#define SPEAR1340_PCIE_SATA_SEL_SATA\t\t(1)\n\t#define SPEAR1340_PCIE_SATA_CFG_MASK\t\t0xF1F\n\t#define SPEAR1340_PCIE_CFG_VAL\t(SPEAR1340_PCIE_SATA_SEL_PCIE | \\\n\t\t\tSPEAR1340_PCIE_CFG_AUX_CLK_EN | \\\n\t\t\tSPEAR1340_PCIE_CFG_CORE_CLK_EN | \\\n\t\t\tSPEAR1340_PCIE_CFG_POWERUP_RESET | \\\n\t\t\tSPEAR1340_PCIE_CFG_DEVICE_PRESENT)\n\t#define SPEAR1340_SATA_CFG_VAL\t(SPEAR1340_PCIE_SATA_SEL_SATA | \\\n\t\t\tSPEAR1340_SATA_CFG_PM_CLK_EN | \\\n\t\t\tSPEAR1340_SATA_CFG_POWERUP_RESET | \\\n\t\t\tSPEAR1340_SATA_CFG_RX_CLK_EN | \\\n\t\t\tSPEAR1340_SATA_CFG_TX_CLK_EN)\n\n#define SPEAR1340_PCIE_MIPHY_CFG\t\t0x428\n\t#define SPEAR1340_MIPHY_OSC_BYPASS_EXT\t\tBIT(31)\n\t#define SPEAR1340_MIPHY_CLK_REF_DIV2\t\tBIT(27)\n\t#define SPEAR1340_MIPHY_CLK_REF_DIV4\t\t(2 << 27)\n\t#define SPEAR1340_MIPHY_CLK_REF_DIV8\t\t(3 << 27)\n\t#define SPEAR1340_MIPHY_PLL_RATIO_TOP(x)\t(x << 0)\n\t#define SPEAR1340_PCIE_MIPHY_CFG_MASK\t\t0xF80000FF\n\t#define SPEAR1340_PCIE_SATA_MIPHY_CFG_SATA \\\n\t\t\t(SPEAR1340_MIPHY_OSC_BYPASS_EXT | \\\n\t\t\tSPEAR1340_MIPHY_CLK_REF_DIV2 | \\\n\t\t\tSPEAR1340_MIPHY_PLL_RATIO_TOP(60))\n\t#define SPEAR1340_PCIE_SATA_MIPHY_CFG_SATA_25M_CRYSTAL_CLK \\\n\t\t\t(SPEAR1340_MIPHY_PLL_RATIO_TOP(120))\n\t#define SPEAR1340_PCIE_SATA_MIPHY_CFG_PCIE \\\n\t\t\t(SPEAR1340_MIPHY_OSC_BYPASS_EXT | \\\n\t\t\tSPEAR1340_MIPHY_PLL_RATIO_TOP(25))\n\nenum spear1340_miphy_mode {\n\tSATA,\n\tPCIE,\n};\n\nstruct spear1340_miphy_priv {\n\t \n\tenum spear1340_miphy_mode\tmode;\n\t \n\tstruct regmap\t\t\t*misc;\n\t \n\tstruct phy\t\t\t*phy;\n};\n\nstatic int spear1340_miphy_sata_init(struct spear1340_miphy_priv *priv)\n{\n\tregmap_update_bits(priv->misc, SPEAR1340_PCIE_SATA_CFG,\n\t\t\t   SPEAR1340_PCIE_SATA_CFG_MASK,\n\t\t\t   SPEAR1340_SATA_CFG_VAL);\n\tregmap_update_bits(priv->misc, SPEAR1340_PCIE_MIPHY_CFG,\n\t\t\t   SPEAR1340_PCIE_MIPHY_CFG_MASK,\n\t\t\t   SPEAR1340_PCIE_SATA_MIPHY_CFG_SATA_25M_CRYSTAL_CLK);\n\t \n\tregmap_update_bits(priv->misc, SPEAR1340_PCM_CFG,\n\t\t\t   SPEAR1340_PCM_CFG_SATA_POWER_EN,\n\t\t\t   SPEAR1340_PCM_CFG_SATA_POWER_EN);\n\t \n\tmsleep(20);\n\n\t \n\tregmap_update_bits(priv->misc, SPEAR1340_PERIP1_SW_RST,\n\t\t\t   SPEAR1340_PERIP1_SW_RSATA, 0);\n\t \n\tmsleep(20);\n\n\treturn 0;\n}\n\nstatic int spear1340_miphy_sata_exit(struct spear1340_miphy_priv *priv)\n{\n\tregmap_update_bits(priv->misc, SPEAR1340_PCIE_SATA_CFG,\n\t\t\t   SPEAR1340_PCIE_SATA_CFG_MASK, 0);\n\tregmap_update_bits(priv->misc, SPEAR1340_PCIE_MIPHY_CFG,\n\t\t\t   SPEAR1340_PCIE_MIPHY_CFG_MASK, 0);\n\n\t \n\tregmap_update_bits(priv->misc, SPEAR1340_PERIP1_SW_RST,\n\t\t\t   SPEAR1340_PERIP1_SW_RSATA,\n\t\t\t   SPEAR1340_PERIP1_SW_RSATA);\n\t \n\tmsleep(20);\n\t \n\tregmap_update_bits(priv->misc, SPEAR1340_PCM_CFG,\n\t\t\t   SPEAR1340_PCM_CFG_SATA_POWER_EN, 0);\n\t \n\tmsleep(20);\n\n\treturn 0;\n}\n\nstatic int spear1340_miphy_pcie_init(struct spear1340_miphy_priv *priv)\n{\n\tregmap_update_bits(priv->misc, SPEAR1340_PCIE_MIPHY_CFG,\n\t\t\t   SPEAR1340_PCIE_MIPHY_CFG_MASK,\n\t\t\t   SPEAR1340_PCIE_SATA_MIPHY_CFG_PCIE);\n\tregmap_update_bits(priv->misc, SPEAR1340_PCIE_SATA_CFG,\n\t\t\t   SPEAR1340_PCIE_SATA_CFG_MASK,\n\t\t\t   SPEAR1340_PCIE_CFG_VAL);\n\n\treturn 0;\n}\n\nstatic int spear1340_miphy_pcie_exit(struct spear1340_miphy_priv *priv)\n{\n\tregmap_update_bits(priv->misc, SPEAR1340_PCIE_MIPHY_CFG,\n\t\t\t   SPEAR1340_PCIE_MIPHY_CFG_MASK, 0);\n\tregmap_update_bits(priv->misc, SPEAR1340_PCIE_SATA_CFG,\n\t\t\t   SPEAR1340_PCIE_SATA_CFG_MASK, 0);\n\n\treturn 0;\n}\n\nstatic int spear1340_miphy_init(struct phy *phy)\n{\n\tstruct spear1340_miphy_priv *priv = phy_get_drvdata(phy);\n\tint ret = 0;\n\n\tif (priv->mode == SATA)\n\t\tret = spear1340_miphy_sata_init(priv);\n\telse if (priv->mode == PCIE)\n\t\tret = spear1340_miphy_pcie_init(priv);\n\n\treturn ret;\n}\n\nstatic int spear1340_miphy_exit(struct phy *phy)\n{\n\tstruct spear1340_miphy_priv *priv = phy_get_drvdata(phy);\n\tint ret = 0;\n\n\tif (priv->mode == SATA)\n\t\tret = spear1340_miphy_sata_exit(priv);\n\telse if (priv->mode == PCIE)\n\t\tret = spear1340_miphy_pcie_exit(priv);\n\n\treturn ret;\n}\n\nstatic const struct of_device_id spear1340_miphy_of_match[] = {\n\t{ .compatible = \"st,spear1340-miphy\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, spear1340_miphy_of_match);\n\nstatic const struct phy_ops spear1340_miphy_ops = {\n\t.init = spear1340_miphy_init,\n\t.exit = spear1340_miphy_exit,\n\t.owner = THIS_MODULE,\n};\n\n#ifdef CONFIG_PM_SLEEP\nstatic int spear1340_miphy_suspend(struct device *dev)\n{\n\tstruct spear1340_miphy_priv *priv = dev_get_drvdata(dev);\n\tint ret = 0;\n\n\tif (priv->mode == SATA)\n\t\tret = spear1340_miphy_sata_exit(priv);\n\n\treturn ret;\n}\n\nstatic int spear1340_miphy_resume(struct device *dev)\n{\n\tstruct spear1340_miphy_priv *priv = dev_get_drvdata(dev);\n\tint ret = 0;\n\n\tif (priv->mode == SATA)\n\t\tret = spear1340_miphy_sata_init(priv);\n\n\treturn ret;\n}\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(spear1340_miphy_pm_ops, spear1340_miphy_suspend,\n\t\t\t spear1340_miphy_resume);\n\nstatic struct phy *spear1340_miphy_xlate(struct device *dev,\n\t\t\t\t\t struct of_phandle_args *args)\n{\n\tstruct spear1340_miphy_priv *priv = dev_get_drvdata(dev);\n\n\tif (args->args_count < 1) {\n\t\tdev_err(dev, \"DT did not pass correct no of args\\n\");\n\t\treturn ERR_PTR(-ENODEV);\n\t}\n\n\tpriv->mode = args->args[0];\n\n\tif (priv->mode != SATA && priv->mode != PCIE) {\n\t\tdev_err(dev, \"DT did not pass correct phy mode\\n\");\n\t\treturn ERR_PTR(-ENODEV);\n\t}\n\n\treturn priv->phy;\n}\n\nstatic int spear1340_miphy_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct spear1340_miphy_priv *priv;\n\tstruct phy_provider *phy_provider;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->misc =\n\t\tsyscon_regmap_lookup_by_phandle(dev->of_node, \"misc\");\n\tif (IS_ERR(priv->misc)) {\n\t\tdev_err(dev, \"failed to find misc regmap\\n\");\n\t\treturn PTR_ERR(priv->misc);\n\t}\n\n\tpriv->phy = devm_phy_create(dev, NULL, &spear1340_miphy_ops);\n\tif (IS_ERR(priv->phy)) {\n\t\tdev_err(dev, \"failed to create SATA PCIe PHY\\n\");\n\t\treturn PTR_ERR(priv->phy);\n\t}\n\n\tdev_set_drvdata(dev, priv);\n\tphy_set_drvdata(priv->phy, priv);\n\n\tphy_provider =\n\t\tdevm_of_phy_provider_register(dev, spear1340_miphy_xlate);\n\tif (IS_ERR(phy_provider)) {\n\t\tdev_err(dev, \"failed to register phy provider\\n\");\n\t\treturn PTR_ERR(phy_provider);\n\t}\n\n\treturn 0;\n}\n\nstatic struct platform_driver spear1340_miphy_driver = {\n\t.probe\t\t= spear1340_miphy_probe,\n\t.driver = {\n\t\t.name = \"spear1340-miphy\",\n\t\t.pm = &spear1340_miphy_pm_ops,\n\t\t.of_match_table = spear1340_miphy_of_match,\n\t},\n};\n\nmodule_platform_driver(spear1340_miphy_driver);\n\nMODULE_DESCRIPTION(\"ST SPEAR1340-MIPHY driver\");\nMODULE_AUTHOR(\"Pratyush Anand <pratyush.anand@gmail.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}