{
  "module_name": "phy-ocelot-serdes.c",
  "hash_id": "6807071a008fc6fc8a3e85696543dd33598feb9ad86d54bc102f48638576023b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/mscc/phy-ocelot-serdes.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/of_platform.h>\n#include <linux/phy.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <soc/mscc/ocelot_hsio.h>\n#include <dt-bindings/phy/phy-ocelot-serdes.h>\n\nstruct serdes_ctrl {\n\tstruct regmap\t\t*regs;\n\tstruct device\t\t*dev;\n\tstruct phy\t\t*phys[SERDES_MAX];\n};\n\nstruct serdes_macro {\n\tu8\t\t\tidx;\n\t \n\tint\t\t\tport;\n\tstruct serdes_ctrl\t*ctrl;\n};\n\n#define MCB_S6G_CFG_TIMEOUT     50\n\nstatic int __serdes_write_mcb_s6g(struct regmap *regmap, u8 macro, u32 op)\n{\n\tunsigned int regval = 0;\n\n\tregmap_write(regmap, HSIO_MCB_S6G_ADDR_CFG, op |\n\t\t     HSIO_MCB_S6G_ADDR_CFG_SERDES6G_ADDR(BIT(macro)));\n\n\treturn regmap_read_poll_timeout(regmap, HSIO_MCB_S6G_ADDR_CFG, regval,\n\t\t\t\t\t(regval & op) != op, 100,\n\t\t\t\t\tMCB_S6G_CFG_TIMEOUT * 1000);\n}\n\nstatic int serdes_commit_mcb_s6g(struct regmap *regmap, u8 macro)\n{\n\treturn __serdes_write_mcb_s6g(regmap, macro,\n\t\tHSIO_MCB_S6G_ADDR_CFG_SERDES6G_WR_ONE_SHOT);\n}\n\nstatic int serdes_update_mcb_s6g(struct regmap *regmap, u8 macro)\n{\n\treturn __serdes_write_mcb_s6g(regmap, macro,\n\t\tHSIO_MCB_S6G_ADDR_CFG_SERDES6G_RD_ONE_SHOT);\n}\n\nstatic int serdes_init_s6g(struct regmap *regmap, u8 serdes, int mode)\n{\n\tu32 pll_fsm_ctrl_data;\n\tu32 ob_ena1v_mode;\n\tu32 des_bw_ana;\n\tu32 ob_ena_cas;\n\tu32 if_mode;\n\tu32 ob_lev;\n\tu32 qrate;\n\tint ret;\n\n\tif (mode == PHY_INTERFACE_MODE_QSGMII) {\n\t\tpll_fsm_ctrl_data = 120;\n\t\tob_ena1v_mode = 0;\n\t\tob_ena_cas = 0;\n\t\tdes_bw_ana = 5;\n\t\tob_lev = 24;\n\t\tif_mode = 3;\n\t\tqrate = 0;\n\t} else {\n\t\tpll_fsm_ctrl_data = 60;\n\t\tob_ena1v_mode = 1;\n\t\tob_ena_cas = 2;\n\t\tdes_bw_ana = 3;\n\t\tob_lev = 48;\n\t\tif_mode = 1;\n\t\tqrate = 1;\n\t}\n\n\tret = serdes_update_mcb_s6g(regmap, serdes);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\n\tregmap_update_bits(regmap, HSIO_S6G_COMMON_CFG,\n\t\t\t   HSIO_S6G_COMMON_CFG_SYS_RST, 0);\n\n\tregmap_update_bits(regmap, HSIO_S6G_PLL_CFG,\n\t\t\t   HSIO_S6G_PLL_CFG_PLL_FSM_ENA, 0);\n\n\tregmap_update_bits(regmap, HSIO_S6G_IB_CFG,\n\t\t\t   HSIO_S6G_IB_CFG_IB_SIG_DET_ENA |\n\t\t\t   HSIO_S6G_IB_CFG_IB_REG_ENA |\n\t\t\t   HSIO_S6G_IB_CFG_IB_SAM_ENA |\n\t\t\t   HSIO_S6G_IB_CFG_IB_EQZ_ENA |\n\t\t\t   HSIO_S6G_IB_CFG_IB_CONCUR |\n\t\t\t   HSIO_S6G_IB_CFG_IB_CAL_ENA,\n\t\t\t   HSIO_S6G_IB_CFG_IB_SIG_DET_ENA |\n\t\t\t   HSIO_S6G_IB_CFG_IB_REG_ENA |\n\t\t\t   HSIO_S6G_IB_CFG_IB_SAM_ENA |\n\t\t\t   HSIO_S6G_IB_CFG_IB_EQZ_ENA |\n\t\t\t   HSIO_S6G_IB_CFG_IB_CONCUR);\n\n\tregmap_update_bits(regmap, HSIO_S6G_IB_CFG1,\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FRC_OFFSET |\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FRC_LP |\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FRC_MID |\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FRC_HP |\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FILT_OFFSET |\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FILT_LP |\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FILT_MID |\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FILT_HP,\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FILT_OFFSET |\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FILT_HP |\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FILT_LP |\n\t\t\t   HSIO_S6G_IB_CFG1_IB_FILT_MID);\n\n\tregmap_update_bits(regmap, HSIO_S6G_IB_CFG2,\n\t\t\t   HSIO_S6G_IB_CFG2_IB_UREG_M,\n\t\t\t   HSIO_S6G_IB_CFG2_IB_UREG(4));\n\n\tregmap_update_bits(regmap, HSIO_S6G_IB_CFG3,\n\t\t\t   HSIO_S6G_IB_CFG3_IB_INI_OFFSET_M |\n\t\t\t   HSIO_S6G_IB_CFG3_IB_INI_LP_M |\n\t\t\t   HSIO_S6G_IB_CFG3_IB_INI_MID_M |\n\t\t\t   HSIO_S6G_IB_CFG3_IB_INI_HP_M,\n\t\t\t   HSIO_S6G_IB_CFG3_IB_INI_OFFSET(31) |\n\t\t\t   HSIO_S6G_IB_CFG3_IB_INI_LP(1) |\n\t\t\t   HSIO_S6G_IB_CFG3_IB_INI_MID(31) |\n\t\t\t   HSIO_S6G_IB_CFG3_IB_INI_HP(0));\n\n\tregmap_update_bits(regmap, HSIO_S6G_MISC_CFG,\n\t\t\t   HSIO_S6G_MISC_CFG_LANE_RST,\n\t\t\t   HSIO_S6G_MISC_CFG_LANE_RST);\n\n\tret = serdes_commit_mcb_s6g(regmap, serdes);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tregmap_update_bits(regmap, HSIO_S6G_OB_CFG,\n\t\t\t   HSIO_S6G_OB_CFG_OB_IDLE |\n\t\t\t   HSIO_S6G_OB_CFG_OB_ENA1V_MODE |\n\t\t\t   HSIO_S6G_OB_CFG_OB_POST0_M |\n\t\t\t   HSIO_S6G_OB_CFG_OB_PREC_M,\n\t\t\t   (ob_ena1v_mode ? HSIO_S6G_OB_CFG_OB_ENA1V_MODE : 0) |\n\t\t\t   HSIO_S6G_OB_CFG_OB_POST0(0) |\n\t\t\t   HSIO_S6G_OB_CFG_OB_PREC(0));\n\n\tregmap_update_bits(regmap, HSIO_S6G_OB_CFG1,\n\t\t\t   HSIO_S6G_OB_CFG1_OB_ENA_CAS_M |\n\t\t\t   HSIO_S6G_OB_CFG1_OB_LEV_M,\n\t\t\t   HSIO_S6G_OB_CFG1_OB_LEV(ob_lev) |\n\t\t\t   HSIO_S6G_OB_CFG1_OB_ENA_CAS(ob_ena_cas));\n\n\tregmap_update_bits(regmap, HSIO_S6G_DES_CFG,\n\t\t\t   HSIO_S6G_DES_CFG_DES_PHS_CTRL_M |\n\t\t\t   HSIO_S6G_DES_CFG_DES_CPMD_SEL_M |\n\t\t\t   HSIO_S6G_DES_CFG_DES_BW_ANA_M,\n\t\t\t   HSIO_S6G_DES_CFG_DES_PHS_CTRL(2) |\n\t\t\t   HSIO_S6G_DES_CFG_DES_CPMD_SEL(0) |\n\t\t\t   HSIO_S6G_DES_CFG_DES_BW_ANA(des_bw_ana));\n\n\tregmap_update_bits(regmap, HSIO_S6G_IB_CFG,\n\t\t\t   HSIO_S6G_IB_CFG_IB_SIG_DET_CLK_SEL_M |\n\t\t\t   HSIO_S6G_IB_CFG_IB_REG_PAT_SEL_OFFSET_M,\n\t\t\t   HSIO_S6G_IB_CFG_IB_REG_PAT_SEL_OFFSET(0) |\n\t\t\t   HSIO_S6G_IB_CFG_IB_SIG_DET_CLK_SEL(0));\n\n\tregmap_update_bits(regmap, HSIO_S6G_IB_CFG1,\n\t\t\t   HSIO_S6G_IB_CFG1_IB_TSDET_M,\n\t\t\t   HSIO_S6G_IB_CFG1_IB_TSDET(16));\n\n\tregmap_update_bits(regmap, HSIO_S6G_SER_CFG,\n\t\t\t   HSIO_S6G_SER_CFG_SER_ALISEL_M |\n\t\t\t   HSIO_S6G_SER_CFG_SER_ENALI,\n\t\t\t   HSIO_S6G_SER_CFG_SER_ALISEL(0));\n\n\tregmap_update_bits(regmap, HSIO_S6G_PLL_CFG,\n\t\t\t   HSIO_S6G_PLL_CFG_PLL_DIV4 |\n\t\t\t   HSIO_S6G_PLL_CFG_PLL_ENA_ROT |\n\t\t\t   HSIO_S6G_PLL_CFG_PLL_FSM_CTRL_DATA_M |\n\t\t\t   HSIO_S6G_PLL_CFG_PLL_ROT_DIR |\n\t\t\t   HSIO_S6G_PLL_CFG_PLL_ROT_FRQ,\n\t\t\t   HSIO_S6G_PLL_CFG_PLL_FSM_CTRL_DATA\n\t\t\t   (pll_fsm_ctrl_data));\n\n\tregmap_update_bits(regmap, HSIO_S6G_COMMON_CFG,\n\t\t\t   HSIO_S6G_COMMON_CFG_SYS_RST |\n\t\t\t   HSIO_S6G_COMMON_CFG_ENA_LANE |\n\t\t\t   HSIO_S6G_COMMON_CFG_PWD_RX |\n\t\t\t   HSIO_S6G_COMMON_CFG_PWD_TX |\n\t\t\t   HSIO_S6G_COMMON_CFG_HRATE |\n\t\t\t   HSIO_S6G_COMMON_CFG_QRATE |\n\t\t\t   HSIO_S6G_COMMON_CFG_ENA_ELOOP |\n\t\t\t   HSIO_S6G_COMMON_CFG_ENA_FLOOP |\n\t\t\t   HSIO_S6G_COMMON_CFG_IF_MODE_M,\n\t\t\t   HSIO_S6G_COMMON_CFG_SYS_RST |\n\t\t\t   HSIO_S6G_COMMON_CFG_ENA_LANE |\n\t\t\t   (qrate ? HSIO_S6G_COMMON_CFG_QRATE : 0) |\n\t\t\t   HSIO_S6G_COMMON_CFG_IF_MODE(if_mode));\n\n\tregmap_update_bits(regmap, HSIO_S6G_MISC_CFG,\n\t\t\t   HSIO_S6G_MISC_CFG_LANE_RST |\n\t\t\t   HSIO_S6G_MISC_CFG_DES_100FX_CPMD_ENA |\n\t\t\t   HSIO_S6G_MISC_CFG_RX_LPI_MODE_ENA |\n\t\t\t   HSIO_S6G_MISC_CFG_TX_LPI_MODE_ENA,\n\t\t\t   HSIO_S6G_MISC_CFG_LANE_RST |\n\t\t\t   HSIO_S6G_MISC_CFG_RX_LPI_MODE_ENA);\n\n\n\tret = serdes_commit_mcb_s6g(regmap, serdes);\n\tif (ret)\n\t\treturn ret;\n\n\tregmap_update_bits(regmap, HSIO_S6G_PLL_CFG,\n\t\t\t   HSIO_S6G_PLL_CFG_PLL_FSM_ENA,\n\t\t\t   HSIO_S6G_PLL_CFG_PLL_FSM_ENA);\n\n\tret = serdes_commit_mcb_s6g(regmap, serdes);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tmsleep(20);\n\n\tregmap_update_bits(regmap, HSIO_S6G_IB_CFG,\n\t\t\t   HSIO_S6G_IB_CFG_IB_CAL_ENA,\n\t\t\t   HSIO_S6G_IB_CFG_IB_CAL_ENA);\n\n\tregmap_update_bits(regmap, HSIO_S6G_MISC_CFG,\n\t\t\t   HSIO_S6G_MISC_CFG_LANE_RST, 0);\n\n\tret = serdes_commit_mcb_s6g(regmap, serdes);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tmsleep(60);\n\n\tregmap_update_bits(regmap, HSIO_S6G_IB_CFG,\n\t\t\t   HSIO_S6G_IB_CFG_IB_REG_PAT_SEL_OFFSET_M |\n\t\t\t   HSIO_S6G_IB_CFG_IB_SIG_DET_CLK_SEL_M,\n\t\t\t   HSIO_S6G_IB_CFG_IB_REG_PAT_SEL_OFFSET(0) |\n\t\t\t   HSIO_S6G_IB_CFG_IB_SIG_DET_CLK_SEL(7));\n\n\tregmap_update_bits(regmap, HSIO_S6G_IB_CFG1,\n\t\t\t   HSIO_S6G_IB_CFG1_IB_TSDET_M,\n\t\t\t   HSIO_S6G_IB_CFG1_IB_TSDET(3));\n\n\t \n\n\treturn 0;\n}\n\n#define MCB_S1G_CFG_TIMEOUT     50\n\nstatic int __serdes_write_mcb_s1g(struct regmap *regmap, u8 macro, u32 op)\n{\n\tunsigned int regval;\n\n\tregmap_write(regmap, HSIO_MCB_S1G_ADDR_CFG, op |\n\t\t     HSIO_MCB_S1G_ADDR_CFG_SERDES1G_ADDR(BIT(macro)));\n\n\treturn regmap_read_poll_timeout(regmap, HSIO_MCB_S1G_ADDR_CFG, regval,\n\t\t\t\t\t(regval & op) != op, 100,\n\t\t\t\t\tMCB_S1G_CFG_TIMEOUT * 1000);\n}\n\nstatic int serdes_commit_mcb_s1g(struct regmap *regmap, u8 macro)\n{\n\treturn __serdes_write_mcb_s1g(regmap, macro,\n\t\tHSIO_MCB_S1G_ADDR_CFG_SERDES1G_WR_ONE_SHOT);\n}\n\nstatic int serdes_update_mcb_s1g(struct regmap *regmap, u8 macro)\n{\n\treturn __serdes_write_mcb_s1g(regmap, macro,\n\t\tHSIO_MCB_S1G_ADDR_CFG_SERDES1G_RD_ONE_SHOT);\n}\n\nstatic int serdes_init_s1g(struct regmap *regmap, u8 serdes)\n{\n\tint ret;\n\n\tret = serdes_update_mcb_s1g(regmap, serdes);\n\tif (ret)\n\t\treturn ret;\n\n\tregmap_update_bits(regmap, HSIO_S1G_COMMON_CFG,\n\t\t\t   HSIO_S1G_COMMON_CFG_SYS_RST |\n\t\t\t   HSIO_S1G_COMMON_CFG_ENA_LANE |\n\t\t\t   HSIO_S1G_COMMON_CFG_ENA_ELOOP |\n\t\t\t   HSIO_S1G_COMMON_CFG_ENA_FLOOP,\n\t\t\t   HSIO_S1G_COMMON_CFG_ENA_LANE);\n\n\tregmap_update_bits(regmap, HSIO_S1G_PLL_CFG,\n\t\t\t   HSIO_S1G_PLL_CFG_PLL_FSM_ENA |\n\t\t\t   HSIO_S1G_PLL_CFG_PLL_FSM_CTRL_DATA_M,\n\t\t\t   HSIO_S1G_PLL_CFG_PLL_FSM_CTRL_DATA(200) |\n\t\t\t   HSIO_S1G_PLL_CFG_PLL_FSM_ENA);\n\n\tregmap_update_bits(regmap, HSIO_S1G_MISC_CFG,\n\t\t\t   HSIO_S1G_MISC_CFG_DES_100FX_CPMD_ENA |\n\t\t\t   HSIO_S1G_MISC_CFG_LANE_RST,\n\t\t\t   HSIO_S1G_MISC_CFG_LANE_RST);\n\n\tret = serdes_commit_mcb_s1g(regmap, serdes);\n\tif (ret)\n\t\treturn ret;\n\n\tregmap_update_bits(regmap, HSIO_S1G_COMMON_CFG,\n\t\t\t   HSIO_S1G_COMMON_CFG_SYS_RST,\n\t\t\t   HSIO_S1G_COMMON_CFG_SYS_RST);\n\n\tregmap_update_bits(regmap, HSIO_S1G_MISC_CFG,\n\t\t\t   HSIO_S1G_MISC_CFG_LANE_RST, 0);\n\n\tret = serdes_commit_mcb_s1g(regmap, serdes);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstruct serdes_mux {\n\tu8\t\t\tidx;\n\tu8\t\t\tport;\n\tenum phy_mode\t\tmode;\n\tint\t\t\tsubmode;\n\tu32\t\t\tmask;\n\tu32\t\t\tmux;\n};\n\n#define SERDES_MUX(_idx, _port, _mode, _submode, _mask, _mux) { \\\n\t.idx = _idx,\t\t\t\t\t\t\\\n\t.port = _port,\t\t\t\t\t\t\\\n\t.mode = _mode,\t\t\t\t\t\t\\\n\t.submode = _submode,\t\t\t\t\t\\\n\t.mask = _mask,\t\t\t\t\t\t\\\n\t.mux = _mux,\t\t\t\t\t\t\\\n}\n\n#define SERDES_MUX_SGMII(i, p, m, c) \\\n\tSERDES_MUX(i, p, PHY_MODE_ETHERNET, PHY_INTERFACE_MODE_SGMII, m, c)\n#define SERDES_MUX_QSGMII(i, p, m, c) \\\n\tSERDES_MUX(i, p, PHY_MODE_ETHERNET, PHY_INTERFACE_MODE_QSGMII, m, c)\n\nstatic const struct serdes_mux ocelot_serdes_muxes[] = {\n\tSERDES_MUX_SGMII(SERDES1G(0), 0, 0, 0),\n\tSERDES_MUX_SGMII(SERDES1G(1), 1, HSIO_HW_CFG_DEV1G_5_MODE, 0),\n\tSERDES_MUX_SGMII(SERDES1G(1), 5, HSIO_HW_CFG_QSGMII_ENA |\n\t\t\t HSIO_HW_CFG_DEV1G_5_MODE, HSIO_HW_CFG_DEV1G_5_MODE),\n\tSERDES_MUX_SGMII(SERDES1G(2), 2, HSIO_HW_CFG_DEV1G_4_MODE, 0),\n\tSERDES_MUX_SGMII(SERDES1G(2), 4, HSIO_HW_CFG_QSGMII_ENA |\n\t\t\t HSIO_HW_CFG_DEV1G_4_MODE, HSIO_HW_CFG_DEV1G_4_MODE),\n\tSERDES_MUX_SGMII(SERDES1G(3), 3, HSIO_HW_CFG_DEV1G_6_MODE, 0),\n\tSERDES_MUX_SGMII(SERDES1G(3), 6, HSIO_HW_CFG_QSGMII_ENA |\n\t\t\t HSIO_HW_CFG_DEV1G_6_MODE, HSIO_HW_CFG_DEV1G_6_MODE),\n\tSERDES_MUX_SGMII(SERDES1G(4), 4, HSIO_HW_CFG_QSGMII_ENA |\n\t\t\t HSIO_HW_CFG_DEV1G_4_MODE | HSIO_HW_CFG_DEV1G_9_MODE,\n\t\t\t 0),\n\tSERDES_MUX_SGMII(SERDES1G(4), 9, HSIO_HW_CFG_DEV1G_4_MODE |\n\t\t\t HSIO_HW_CFG_DEV1G_9_MODE, HSIO_HW_CFG_DEV1G_4_MODE |\n\t\t\t HSIO_HW_CFG_DEV1G_9_MODE),\n\tSERDES_MUX_SGMII(SERDES1G(5), 5, HSIO_HW_CFG_QSGMII_ENA |\n\t\t\t HSIO_HW_CFG_DEV1G_5_MODE | HSIO_HW_CFG_DEV2G5_10_MODE,\n\t\t\t 0),\n\tSERDES_MUX_SGMII(SERDES1G(5), 10, HSIO_HW_CFG_PCIE_ENA |\n\t\t\t HSIO_HW_CFG_DEV1G_5_MODE | HSIO_HW_CFG_DEV2G5_10_MODE,\n\t\t\t HSIO_HW_CFG_DEV1G_5_MODE | HSIO_HW_CFG_DEV2G5_10_MODE),\n\tSERDES_MUX_QSGMII(SERDES6G(0), 4, HSIO_HW_CFG_QSGMII_ENA,\n\t\t\t  HSIO_HW_CFG_QSGMII_ENA),\n\tSERDES_MUX_QSGMII(SERDES6G(0), 5, HSIO_HW_CFG_QSGMII_ENA,\n\t\t\t  HSIO_HW_CFG_QSGMII_ENA),\n\tSERDES_MUX_QSGMII(SERDES6G(0), 6, HSIO_HW_CFG_QSGMII_ENA,\n\t\t\t  HSIO_HW_CFG_QSGMII_ENA),\n\tSERDES_MUX_SGMII(SERDES6G(0), 7, HSIO_HW_CFG_QSGMII_ENA, 0),\n\tSERDES_MUX_QSGMII(SERDES6G(0), 7, HSIO_HW_CFG_QSGMII_ENA,\n\t\t\t  HSIO_HW_CFG_QSGMII_ENA),\n\tSERDES_MUX_SGMII(SERDES6G(1), 8, 0, 0),\n\tSERDES_MUX_SGMII(SERDES6G(2), 10, HSIO_HW_CFG_PCIE_ENA |\n\t\t\t HSIO_HW_CFG_DEV2G5_10_MODE, 0),\n\tSERDES_MUX(SERDES6G(2), 10, PHY_MODE_PCIE, 0, HSIO_HW_CFG_PCIE_ENA,\n\t\t   HSIO_HW_CFG_PCIE_ENA),\n};\n\nstatic int serdes_set_mode(struct phy *phy, enum phy_mode mode, int submode)\n{\n\tstruct serdes_macro *macro = phy_get_drvdata(phy);\n\tunsigned int i;\n\tint ret;\n\n\t \n\tif (mode != PHY_MODE_ETHERNET)\n\t\treturn -EOPNOTSUPP;\n\n\tfor (i = 0; i < ARRAY_SIZE(ocelot_serdes_muxes); i++) {\n\t\tif (macro->idx != ocelot_serdes_muxes[i].idx ||\n\t\t    mode != ocelot_serdes_muxes[i].mode ||\n\t\t    submode != ocelot_serdes_muxes[i].submode)\n\t\t\tcontinue;\n\n\t\tif (submode != PHY_INTERFACE_MODE_QSGMII &&\n\t\t    macro->port != ocelot_serdes_muxes[i].port)\n\t\t\tcontinue;\n\n\t\tret = regmap_update_bits(macro->ctrl->regs, HSIO_HW_CFG,\n\t\t\t\t\t ocelot_serdes_muxes[i].mask,\n\t\t\t\t\t ocelot_serdes_muxes[i].mux);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (macro->idx <= SERDES1G_MAX)\n\t\t\treturn serdes_init_s1g(macro->ctrl->regs, macro->idx);\n\t\telse if (macro->idx <= SERDES6G_MAX)\n\t\t\treturn serdes_init_s6g(macro->ctrl->regs,\n\t\t\t\t\t       macro->idx - (SERDES1G_MAX + 1),\n\t\t\t\t\t       ocelot_serdes_muxes[i].submode);\n\n\t\t \n\t\treturn -EOPNOTSUPP;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic const struct phy_ops serdes_ops = {\n\t.set_mode\t= serdes_set_mode,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic struct phy *serdes_simple_xlate(struct device *dev,\n\t\t\t\t       struct of_phandle_args *args)\n{\n\tstruct serdes_ctrl *ctrl = dev_get_drvdata(dev);\n\tunsigned int port, idx, i;\n\n\tif (args->args_count != 2)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tport = args->args[0];\n\tidx = args->args[1];\n\n\tfor (i = 0; i < SERDES_MAX; i++) {\n\t\tstruct serdes_macro *macro = phy_get_drvdata(ctrl->phys[i]);\n\n\t\tif (idx != macro->idx)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (idx != SERDES6G(0) && macro->port >= 0)\n\t\t\treturn ERR_PTR(-EBUSY);\n\n\t\tmacro->port = port;\n\t\treturn ctrl->phys[i];\n\t}\n\n\treturn ERR_PTR(-ENODEV);\n}\n\nstatic int serdes_phy_create(struct serdes_ctrl *ctrl, u8 idx, struct phy **phy)\n{\n\tstruct serdes_macro *macro;\n\n\t*phy = devm_phy_create(ctrl->dev, NULL, &serdes_ops);\n\tif (IS_ERR(*phy))\n\t\treturn PTR_ERR(*phy);\n\n\tmacro = devm_kzalloc(ctrl->dev, sizeof(*macro), GFP_KERNEL);\n\tif (!macro)\n\t\treturn -ENOMEM;\n\n\tmacro->idx = idx;\n\tmacro->ctrl = ctrl;\n\tmacro->port = -1;\n\n\tphy_set_drvdata(*phy, macro);\n\n\treturn 0;\n}\n\nstatic int serdes_probe(struct platform_device *pdev)\n{\n\tstruct phy_provider *provider;\n\tstruct serdes_ctrl *ctrl;\n\tstruct resource *res;\n\tunsigned int i;\n\tint ret;\n\n\tctrl = devm_kzalloc(&pdev->dev, sizeof(*ctrl), GFP_KERNEL);\n\tif (!ctrl)\n\t\treturn -ENOMEM;\n\n\tctrl->dev = &pdev->dev;\n\tctrl->regs = syscon_node_to_regmap(pdev->dev.parent->of_node);\n\tif (IS_ERR(ctrl->regs)) {\n\t\t \n\t\tres = platform_get_resource(pdev, IORESOURCE_REG, 0);\n\t\tif (res)\n\t\t\tctrl->regs = dev_get_regmap(ctrl->dev->parent,\n\t\t\t\t\t\t    res->name);\n\t}\n\n\tif (IS_ERR(ctrl->regs))\n\t\treturn PTR_ERR(ctrl->regs);\n\n\tfor (i = 0; i < SERDES_MAX; i++) {\n\t\tret = serdes_phy_create(ctrl, i, &ctrl->phys[i]);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\tdev_set_drvdata(&pdev->dev, ctrl);\n\n\tprovider = devm_of_phy_provider_register(ctrl->dev,\n\t\t\t\t\t\t serdes_simple_xlate);\n\n\treturn PTR_ERR_OR_ZERO(provider);\n}\n\nstatic const struct of_device_id serdes_ids[] = {\n\t{ .compatible = \"mscc,vsc7514-serdes\", },\n\t{},\n};\nMODULE_DEVICE_TABLE(of, serdes_ids);\n\nstatic struct platform_driver mscc_ocelot_serdes = {\n\t.probe\t\t= serdes_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"mscc,ocelot-serdes\",\n\t\t.of_match_table = of_match_ptr(serdes_ids),\n\t},\n};\n\nmodule_platform_driver(mscc_ocelot_serdes);\n\nMODULE_AUTHOR(\"Quentin Schulz <quentin.schulz@bootlin.com>\");\nMODULE_DESCRIPTION(\"SerDes driver for Microsemi Ocelot\");\nMODULE_LICENSE(\"Dual MIT/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}