{
  "module_name": "phy-meson8-hdmi-tx.c",
  "hash_id": "20a0ff5da876ec86f113f3960fb53c8a743830dcb63bf52b0a0ada165627cb6a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/amlogic/phy-meson8-hdmi-tx.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/bits.h>\n#include <linux/clk.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/regmap.h>\n\n \n#define HHI_HDMI_PHY_CNTL0\t\t\t\t0x3a0\n\t#define HHI_HDMI_PHY_CNTL0_HDMI_CTL1\t\tGENMASK(31, 16)\n\t#define HHI_HDMI_PHY_CNTL0_HDMI_CTL0\t\tGENMASK(15, 0)\n\n#define HHI_HDMI_PHY_CNTL1\t\t\t\t0x3a4\n\t#define HHI_HDMI_PHY_CNTL1_CLOCK_ENABLE\t\tBIT(1)\n\t#define HHI_HDMI_PHY_CNTL1_SOFT_RESET\t\tBIT(0)\n\n#define HHI_HDMI_PHY_CNTL2\t\t\t\t0x3a8\n\nstruct phy_meson8_hdmi_tx_priv {\n\tstruct regmap\t\t*hhi;\n\tstruct clk\t\t*tmds_clk;\n};\n\nstatic int phy_meson8_hdmi_tx_init(struct phy *phy)\n{\n\tstruct phy_meson8_hdmi_tx_priv *priv = phy_get_drvdata(phy);\n\n\treturn clk_prepare_enable(priv->tmds_clk);\n}\n\nstatic int phy_meson8_hdmi_tx_exit(struct phy *phy)\n{\n\tstruct phy_meson8_hdmi_tx_priv *priv = phy_get_drvdata(phy);\n\n\tclk_disable_unprepare(priv->tmds_clk);\n\n\treturn 0;\n}\n\nstatic int phy_meson8_hdmi_tx_power_on(struct phy *phy)\n{\n\tstruct phy_meson8_hdmi_tx_priv *priv = phy_get_drvdata(phy);\n\tunsigned int i;\n\tu16 hdmi_ctl0;\n\n\tif (clk_get_rate(priv->tmds_clk) >= 2970UL * 1000 * 1000)\n\t\thdmi_ctl0 = 0x1e8b;\n\telse\n\t\thdmi_ctl0 = 0x4d0b;\n\n\tregmap_write(priv->hhi, HHI_HDMI_PHY_CNTL0,\n\t\t     FIELD_PREP(HHI_HDMI_PHY_CNTL0_HDMI_CTL1, 0x08c3) |\n\t\t     FIELD_PREP(HHI_HDMI_PHY_CNTL0_HDMI_CTL0, hdmi_ctl0));\n\n\tregmap_write(priv->hhi, HHI_HDMI_PHY_CNTL1, 0x0);\n\n\t \n\tfor (i = 0; i < 3; i++) {\n\t\tregmap_write(priv->hhi, HHI_HDMI_PHY_CNTL1,\n\t\t\t     HHI_HDMI_PHY_CNTL1_CLOCK_ENABLE |\n\t\t\t     HHI_HDMI_PHY_CNTL1_SOFT_RESET);\n\t\tusleep_range(1000, 2000);\n\n\t\tregmap_write(priv->hhi, HHI_HDMI_PHY_CNTL1,\n\t\t\t     HHI_HDMI_PHY_CNTL1_CLOCK_ENABLE);\n\t\tusleep_range(1000, 2000);\n\t}\n\n\treturn 0;\n}\n\nstatic int phy_meson8_hdmi_tx_power_off(struct phy *phy)\n{\n\tstruct phy_meson8_hdmi_tx_priv *priv = phy_get_drvdata(phy);\n\n\tregmap_write(priv->hhi, HHI_HDMI_PHY_CNTL0,\n\t\t     FIELD_PREP(HHI_HDMI_PHY_CNTL0_HDMI_CTL1, 0x0841) |\n\t\t     FIELD_PREP(HHI_HDMI_PHY_CNTL0_HDMI_CTL0, 0x8d00));\n\n\treturn 0;\n}\n\nstatic const struct phy_ops phy_meson8_hdmi_tx_ops = {\n\t.init\t\t= phy_meson8_hdmi_tx_init,\n\t.exit\t\t= phy_meson8_hdmi_tx_exit,\n\t.power_on\t= phy_meson8_hdmi_tx_power_on,\n\t.power_off\t= phy_meson8_hdmi_tx_power_off,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int phy_meson8_hdmi_tx_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct phy_meson8_hdmi_tx_priv *priv;\n\tstruct phy_provider *phy_provider;\n\tstruct resource *res;\n\tstruct phy *phy;\n\n\tres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!res)\n\t\treturn -EINVAL;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->hhi = syscon_node_to_regmap(np->parent);\n\tif (IS_ERR(priv->hhi))\n\t\treturn PTR_ERR(priv->hhi);\n\n\tpriv->tmds_clk = devm_clk_get(&pdev->dev, NULL);\n\tif (IS_ERR(priv->tmds_clk))\n\t\treturn PTR_ERR(priv->tmds_clk);\n\n\tphy = devm_phy_create(&pdev->dev, np, &phy_meson8_hdmi_tx_ops);\n\tif (IS_ERR(phy))\n\t\treturn PTR_ERR(phy);\n\n\tphy_set_drvdata(phy, priv);\n\n\tphy_provider = devm_of_phy_provider_register(&pdev->dev,\n\t\t\t\t\t\t     of_phy_simple_xlate);\n\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct of_device_id phy_meson8_hdmi_tx_of_match[] = {\n\t{ .compatible = \"amlogic,meson8-hdmi-tx-phy\" },\n\t{   }\n};\nMODULE_DEVICE_TABLE(of, phy_meson8_hdmi_tx_of_match);\n\nstatic struct platform_driver phy_meson8_hdmi_tx_driver = {\n\t.probe\t= phy_meson8_hdmi_tx_probe,\n\t.driver\t= {\n\t\t.name\t\t= \"phy-meson8-hdmi-tx\",\n\t\t.of_match_table\t= phy_meson8_hdmi_tx_of_match,\n\t},\n};\nmodule_platform_driver(phy_meson8_hdmi_tx_driver);\n\nMODULE_AUTHOR(\"Martin Blumenstingl <martin.blumenstingl@googlemail.com>\");\nMODULE_DESCRIPTION(\"Meson8, Meson8b and Meson8m2 HDMI TX PHY driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}