{
  "module_name": "phy-lpc18xx-usb-otg.c",
  "hash_id": "68d6affaee35d64ff4670f1d2309d843505e50483626c45cfd8e3edef340fd16",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/phy-lpc18xx-usb-otg.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/err.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n \n#define LPC18XX_CREG_CREG0\t\t0x004\n#define LPC18XX_CREG_CREG0_USB0PHY\tBIT(5)\n\nstruct lpc18xx_usb_otg_phy {\n\tstruct phy *phy;\n\tstruct clk *clk;\n\tstruct regmap *reg;\n};\n\nstatic int lpc18xx_usb_otg_phy_init(struct phy *phy)\n{\n\tstruct lpc18xx_usb_otg_phy *lpc = phy_get_drvdata(phy);\n\tint ret;\n\n\t \n\tret = clk_set_rate(lpc->clk, 480000000);\n\tif (ret)\n\t\treturn ret;\n\n\treturn clk_prepare(lpc->clk);\n}\n\nstatic int lpc18xx_usb_otg_phy_exit(struct phy *phy)\n{\n\tstruct lpc18xx_usb_otg_phy *lpc = phy_get_drvdata(phy);\n\n\tclk_unprepare(lpc->clk);\n\n\treturn 0;\n}\n\nstatic int lpc18xx_usb_otg_phy_power_on(struct phy *phy)\n{\n\tstruct lpc18xx_usb_otg_phy *lpc = phy_get_drvdata(phy);\n\tint ret;\n\n\tret = clk_enable(lpc->clk);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = regmap_update_bits(lpc->reg, LPC18XX_CREG_CREG0,\n\t\t\t\t  LPC18XX_CREG_CREG0_USB0PHY, 0);\n\tif (ret) {\n\t\tclk_disable(lpc->clk);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int lpc18xx_usb_otg_phy_power_off(struct phy *phy)\n{\n\tstruct lpc18xx_usb_otg_phy *lpc = phy_get_drvdata(phy);\n\tint ret;\n\n\tret = regmap_update_bits(lpc->reg, LPC18XX_CREG_CREG0,\n\t\t\t\t LPC18XX_CREG_CREG0_USB0PHY,\n\t\t\t\t LPC18XX_CREG_CREG0_USB0PHY);\n\tif (ret)\n\t\treturn ret;\n\n\tclk_disable(lpc->clk);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops lpc18xx_usb_otg_phy_ops = {\n\t.init\t\t= lpc18xx_usb_otg_phy_init,\n\t.exit\t\t= lpc18xx_usb_otg_phy_exit,\n\t.power_on\t= lpc18xx_usb_otg_phy_power_on,\n\t.power_off\t= lpc18xx_usb_otg_phy_power_off,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int lpc18xx_usb_otg_phy_probe(struct platform_device *pdev)\n{\n\tstruct phy_provider *phy_provider;\n\tstruct lpc18xx_usb_otg_phy *lpc;\n\n\tlpc = devm_kzalloc(&pdev->dev, sizeof(*lpc), GFP_KERNEL);\n\tif (!lpc)\n\t\treturn -ENOMEM;\n\n\tlpc->reg = syscon_node_to_regmap(pdev->dev.of_node->parent);\n\tif (IS_ERR(lpc->reg)) {\n\t\tdev_err(&pdev->dev, \"failed to get syscon\\n\");\n\t\treturn PTR_ERR(lpc->reg);\n\t}\n\n\tlpc->clk = devm_clk_get(&pdev->dev, NULL);\n\tif (IS_ERR(lpc->clk)) {\n\t\tdev_err(&pdev->dev, \"failed to get clock\\n\");\n\t\treturn PTR_ERR(lpc->clk);\n\t}\n\n\tlpc->phy = devm_phy_create(&pdev->dev, NULL, &lpc18xx_usb_otg_phy_ops);\n\tif (IS_ERR(lpc->phy)) {\n\t\tdev_err(&pdev->dev, \"failed to create PHY\\n\");\n\t\treturn PTR_ERR(lpc->phy);\n\t}\n\n\tphy_set_drvdata(lpc->phy, lpc);\n\n\tphy_provider = devm_of_phy_provider_register(&pdev->dev,\n\t\t\t\t\t\t     of_phy_simple_xlate);\n\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct of_device_id lpc18xx_usb_otg_phy_match[] = {\n\t{ .compatible = \"nxp,lpc1850-usb-otg-phy\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, lpc18xx_usb_otg_phy_match);\n\nstatic struct platform_driver lpc18xx_usb_otg_phy_driver = {\n\t.probe\t\t= lpc18xx_usb_otg_phy_probe,\n\t.driver\t\t= {\n\t\t.name\t= \"lpc18xx-usb-otg-phy\",\n\t\t.of_match_table = lpc18xx_usb_otg_phy_match,\n\t},\n};\nmodule_platform_driver(lpc18xx_usb_otg_phy_driver);\n\nMODULE_AUTHOR(\"Joachim Eastwood <manabian@gmail.com>\");\nMODULE_DESCRIPTION(\"NXP LPC18xx/43xx USB OTG PHY driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}