{
  "module_name": "sparx5_serdes.c",
  "hash_id": "21c35717cc24fa0bc920e4c113c770a706de55dfb8ad26ef182c146aa5e4f4d6",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/microchip/sparx5_serdes.c",
  "human_readable_source": "\n \n#include <linux/printk.h>\n#include <linux/module.h>\n#include <linux/device.h>\n#include <linux/netdevice.h>\n#include <linux/platform_device.h>\n#include <linux/of.h>\n#include <linux/io.h>\n#include <linux/clk.h>\n#include <linux/phy.h>\n#include <linux/phy/phy.h>\n\n#include \"sparx5_serdes.h\"\n\n#define SPX5_CMU_MAX          14\n\n#define SPX5_SERDES_10G_START 13\n#define SPX5_SERDES_25G_START 25\n#define SPX5_SERDES_6G10G_CNT SPX5_SERDES_25G_START\n\n \n#define SPX5_SERDES_QUIET_MODE_VAL 0x01ef4e0c\n\nenum sparx5_10g28cmu_mode {\n\tSPX5_SD10G28_CMU_MAIN = 0,\n\tSPX5_SD10G28_CMU_AUX1 = 1,\n\tSPX5_SD10G28_CMU_AUX2 = 3,\n\tSPX5_SD10G28_CMU_NONE = 4,\n\tSPX5_SD10G28_CMU_MAX,\n};\n\nenum sparx5_sd25g28_mode_preset_type {\n\tSPX5_SD25G28_MODE_PRESET_25000,\n\tSPX5_SD25G28_MODE_PRESET_10000,\n\tSPX5_SD25G28_MODE_PRESET_5000,\n\tSPX5_SD25G28_MODE_PRESET_SD_2G5,\n\tSPX5_SD25G28_MODE_PRESET_1000BASEX,\n};\n\nenum sparx5_sd10g28_mode_preset_type {\n\tSPX5_SD10G28_MODE_PRESET_10000,\n\tSPX5_SD10G28_MODE_PRESET_SFI_5000_6G,\n\tSPX5_SD10G28_MODE_PRESET_SFI_5000_10G,\n\tSPX5_SD10G28_MODE_PRESET_QSGMII,\n\tSPX5_SD10G28_MODE_PRESET_SD_2G5,\n\tSPX5_SD10G28_MODE_PRESET_1000BASEX,\n};\n\nstruct sparx5_serdes_io_resource {\n\tenum sparx5_serdes_target id;\n\tphys_addr_t offset;\n};\n\nstruct sparx5_sd25g28_mode_preset {\n\tu8 bitwidth;\n\tu8 tx_pre_div;\n\tu8 fifo_ck_div;\n\tu8 pre_divsel;\n\tu8 vco_div_mode;\n\tu8 sel_div;\n\tu8 ck_bitwidth;\n\tu8 subrate;\n\tu8 com_txcal_en;\n\tu8 com_tx_reserve_msb;\n\tu8 com_tx_reserve_lsb;\n\tu8 cfg_itx_ipcml_base;\n\tu8 tx_reserve_lsb;\n\tu8 tx_reserve_msb;\n\tu8 bw;\n\tu8 rxterm;\n\tu8 dfe_tap;\n\tu8 dfe_enable;\n\tbool txmargin;\n\tu8 cfg_ctle_rstn;\n\tu8 r_dfe_rstn;\n\tu8 cfg_pi_bw_3_0;\n\tu8 tx_tap_dly;\n\tu8 tx_tap_adv;\n};\n\nstruct sparx5_sd25g28_media_preset {\n\tu8 cfg_eq_c_force_3_0;\n\tu8 cfg_vga_ctrl_byp_4_0;\n\tu8 cfg_eq_r_force_3_0;\n\tu8 cfg_en_adv;\n\tu8 cfg_en_main;\n\tu8 cfg_en_dly;\n\tu8 cfg_tap_adv_3_0;\n\tu8 cfg_tap_main;\n\tu8 cfg_tap_dly_4_0;\n\tu8 cfg_alos_thr_2_0;\n};\n\nstruct sparx5_sd25g28_args {\n\tu8 if_width;  \n\tbool skip_cmu_cfg:1;  \n\tenum sparx5_10g28cmu_mode cmu_sel;  \n\tbool no_pwrcycle:1;  \n\tbool txinvert:1;  \n\tbool rxinvert:1;  \n\tu16 txswing;  \n\tu8 rate;  \n\tu8 pi_bw_gen1;\n\tu8 duty_cycle;  \n\tbool mute:1;  \n\tbool reg_rst:1;\n\tu8 com_pll_reserve;\n};\n\nstruct sparx5_sd25g28_params {\n\tu8 reg_rst;\n\tu8 cfg_jc_byp;\n\tu8 cfg_common_reserve_7_0;\n\tu8 r_reg_manual;\n\tu8 r_d_width_ctrl_from_hwt;\n\tu8 r_d_width_ctrl_2_0;\n\tu8 r_txfifo_ck_div_pmad_2_0;\n\tu8 r_rxfifo_ck_div_pmad_2_0;\n\tu8 cfg_pll_lol_set;\n\tu8 cfg_vco_div_mode_1_0;\n\tu8 cfg_pre_divsel_1_0;\n\tu8 cfg_sel_div_3_0;\n\tu8 cfg_vco_start_code_3_0;\n\tu8 cfg_pma_tx_ck_bitwidth_2_0;\n\tu8 cfg_tx_prediv_1_0;\n\tu8 cfg_rxdiv_sel_2_0;\n\tu8 cfg_tx_subrate_2_0;\n\tu8 cfg_rx_subrate_2_0;\n\tu8 r_multi_lane_mode;\n\tu8 cfg_cdrck_en;\n\tu8 cfg_dfeck_en;\n\tu8 cfg_dfe_pd;\n\tu8 cfg_dfedmx_pd;\n\tu8 cfg_dfetap_en_5_1;\n\tu8 cfg_dmux_pd;\n\tu8 cfg_dmux_clk_pd;\n\tu8 cfg_erramp_pd;\n\tu8 cfg_pi_dfe_en;\n\tu8 cfg_pi_en;\n\tu8 cfg_pd_ctle;\n\tu8 cfg_summer_en;\n\tu8 cfg_pmad_ck_pd;\n\tu8 cfg_pd_clk;\n\tu8 cfg_pd_cml;\n\tu8 cfg_pd_driver;\n\tu8 cfg_rx_reg_pu;\n\tu8 cfg_pd_rms_det;\n\tu8 cfg_dcdr_pd;\n\tu8 cfg_ecdr_pd;\n\tu8 cfg_pd_sq;\n\tu8 cfg_itx_ipdriver_base_2_0;\n\tu8 cfg_tap_dly_4_0;\n\tu8 cfg_tap_main;\n\tu8 cfg_en_main;\n\tu8 cfg_tap_adv_3_0;\n\tu8 cfg_en_adv;\n\tu8 cfg_en_dly;\n\tu8 cfg_iscan_en;\n\tu8 l1_pcs_en_fast_iscan;\n\tu8 l0_cfg_bw_1_0;\n\tu8 l0_cfg_txcal_en;\n\tu8 cfg_en_dummy;\n\tu8 cfg_pll_reserve_3_0;\n\tu8 l0_cfg_tx_reserve_15_8;\n\tu8 l0_cfg_tx_reserve_7_0;\n\tu8 cfg_tx_reserve_15_8;\n\tu8 cfg_tx_reserve_7_0;\n\tu8 cfg_bw_1_0;\n\tu8 cfg_txcal_man_en;\n\tu8 cfg_phase_man_4_0;\n\tu8 cfg_quad_man_1_0;\n\tu8 cfg_txcal_shift_code_5_0;\n\tu8 cfg_txcal_valid_sel_3_0;\n\tu8 cfg_txcal_en;\n\tu8 cfg_cdr_kf_2_0;\n\tu8 cfg_cdr_m_7_0;\n\tu8 cfg_pi_bw_3_0;\n\tu8 cfg_pi_steps_1_0;\n\tu8 cfg_dis_2ndorder;\n\tu8 cfg_ctle_rstn;\n\tu8 r_dfe_rstn;\n\tu8 cfg_alos_thr_2_0;\n\tu8 cfg_itx_ipcml_base_1_0;\n\tu8 cfg_rx_reserve_7_0;\n\tu8 cfg_rx_reserve_15_8;\n\tu8 cfg_rxterm_2_0;\n\tu8 cfg_fom_selm;\n\tu8 cfg_rx_sp_ctle_1_0;\n\tu8 cfg_isel_ctle_1_0;\n\tu8 cfg_vga_ctrl_byp_4_0;\n\tu8 cfg_vga_byp;\n\tu8 cfg_agc_adpt_byp;\n\tu8 cfg_eqr_byp;\n\tu8 cfg_eqr_force_3_0;\n\tu8 cfg_eqc_force_3_0;\n\tu8 cfg_sum_setcm_en;\n\tu8 cfg_init_pos_iscan_6_0;\n\tu8 cfg_init_pos_ipi_6_0;\n\tu8 cfg_dfedig_m_2_0;\n\tu8 cfg_en_dfedig;\n\tu8 cfg_pi_DFE_en;\n\tu8 cfg_tx2rx_lp_en;\n\tu8 cfg_txlb_en;\n\tu8 cfg_rx2tx_lp_en;\n\tu8 cfg_rxlb_en;\n\tu8 r_tx_pol_inv;\n\tu8 r_rx_pol_inv;\n};\n\nstruct sparx5_sd10g28_media_preset {\n\tu8 cfg_en_adv;\n\tu8 cfg_en_main;\n\tu8 cfg_en_dly;\n\tu8 cfg_tap_adv_3_0;\n\tu8 cfg_tap_main;\n\tu8 cfg_tap_dly_4_0;\n\tu8 cfg_vga_ctrl_3_0;\n\tu8 cfg_vga_cp_2_0;\n\tu8 cfg_eq_res_3_0;\n\tu8 cfg_eq_r_byp;\n\tu8 cfg_eq_c_force_3_0;\n\tu8 cfg_alos_thr_3_0;\n};\n\nstruct sparx5_sd10g28_mode_preset {\n\tu8 bwidth;  \n\tenum sparx5_10g28cmu_mode cmu_sel;  \n\tu8 rate;  \n\tu8 dfe_tap;\n\tu8 dfe_enable;\n\tu8 pi_bw_gen1;\n\tu8 duty_cycle;  \n};\n\nstruct sparx5_sd10g28_args {\n\tbool skip_cmu_cfg:1;  \n\tbool no_pwrcycle:1;  \n\tbool txinvert:1;  \n\tbool rxinvert:1;  \n\tbool txmargin:1;  \n\tu16 txswing;  \n\tbool mute:1;  \n\tbool is_6g:1;\n\tbool reg_rst:1;\n};\n\nstruct sparx5_sd10g28_params {\n\tu8 cmu_sel;\n\tu8 is_6g;\n\tu8 skip_cmu_cfg;\n\tu8 cfg_lane_reserve_7_0;\n\tu8 cfg_ssc_rtl_clk_sel;\n\tu8 cfg_lane_reserve_15_8;\n\tu8 cfg_txrate_1_0;\n\tu8 cfg_rxrate_1_0;\n\tu8 r_d_width_ctrl_2_0;\n\tu8 cfg_pma_tx_ck_bitwidth_2_0;\n\tu8 cfg_rxdiv_sel_2_0;\n\tu8 r_pcs2pma_phymode_4_0;\n\tu8 cfg_lane_id_2_0;\n\tu8 cfg_cdrck_en;\n\tu8 cfg_dfeck_en;\n\tu8 cfg_dfe_pd;\n\tu8 cfg_dfetap_en_5_1;\n\tu8 cfg_erramp_pd;\n\tu8 cfg_pi_DFE_en;\n\tu8 cfg_pi_en;\n\tu8 cfg_pd_ctle;\n\tu8 cfg_summer_en;\n\tu8 cfg_pd_rx_cktree;\n\tu8 cfg_pd_clk;\n\tu8 cfg_pd_cml;\n\tu8 cfg_pd_driver;\n\tu8 cfg_rx_reg_pu;\n\tu8 cfg_d_cdr_pd;\n\tu8 cfg_pd_sq;\n\tu8 cfg_rxdet_en;\n\tu8 cfg_rxdet_str;\n\tu8 r_multi_lane_mode;\n\tu8 cfg_en_adv;\n\tu8 cfg_en_main;\n\tu8 cfg_en_dly;\n\tu8 cfg_tap_adv_3_0;\n\tu8 cfg_tap_main;\n\tu8 cfg_tap_dly_4_0;\n\tu8 cfg_vga_ctrl_3_0;\n\tu8 cfg_vga_cp_2_0;\n\tu8 cfg_eq_res_3_0;\n\tu8 cfg_eq_r_byp;\n\tu8 cfg_eq_c_force_3_0;\n\tu8 cfg_en_dfedig;\n\tu8 cfg_sum_setcm_en;\n\tu8 cfg_en_preemph;\n\tu8 cfg_itx_ippreemp_base_1_0;\n\tu8 cfg_itx_ipdriver_base_2_0;\n\tu8 cfg_ibias_tune_reserve_5_0;\n\tu8 cfg_txswing_half;\n\tu8 cfg_dis_2nd_order;\n\tu8 cfg_rx_ssc_lh;\n\tu8 cfg_pi_floop_steps_1_0;\n\tu8 cfg_pi_ext_dac_23_16;\n\tu8 cfg_pi_ext_dac_15_8;\n\tu8 cfg_iscan_ext_dac_7_0;\n\tu8 cfg_cdr_kf_gen1_2_0;\n\tu8 cfg_cdr_kf_gen2_2_0;\n\tu8 cfg_cdr_kf_gen3_2_0;\n\tu8 cfg_cdr_kf_gen4_2_0;\n\tu8 r_cdr_m_gen1_7_0;\n\tu8 cfg_pi_bw_gen1_3_0;\n\tu8 cfg_pi_bw_gen2;\n\tu8 cfg_pi_bw_gen3;\n\tu8 cfg_pi_bw_gen4;\n\tu8 cfg_pi_ext_dac_7_0;\n\tu8 cfg_pi_steps;\n\tu8 cfg_mp_max_3_0;\n\tu8 cfg_rstn_dfedig;\n\tu8 cfg_alos_thr_3_0;\n\tu8 cfg_predrv_slewrate_1_0;\n\tu8 cfg_itx_ipcml_base_1_0;\n\tu8 cfg_ip_pre_base_1_0;\n\tu8 r_cdr_m_gen2_7_0;\n\tu8 r_cdr_m_gen3_7_0;\n\tu8 r_cdr_m_gen4_7_0;\n\tu8 r_en_auto_cdr_rstn;\n\tu8 cfg_oscal_afe;\n\tu8 cfg_pd_osdac_afe;\n\tu8 cfg_resetb_oscal_afe[2];\n\tu8 cfg_center_spreading;\n\tu8 cfg_m_cnt_maxval_4_0;\n\tu8 cfg_ncnt_maxval_7_0;\n\tu8 cfg_ncnt_maxval_10_8;\n\tu8 cfg_ssc_en;\n\tu8 cfg_tx2rx_lp_en;\n\tu8 cfg_txlb_en;\n\tu8 cfg_rx2tx_lp_en;\n\tu8 cfg_rxlb_en;\n\tu8 r_tx_pol_inv;\n\tu8 r_rx_pol_inv;\n\tu8 fx_100;\n};\n\nstatic struct sparx5_sd25g28_media_preset media_presets_25g[] = {\n\t{  \n\t\t.cfg_en_adv               = 0,\n\t\t.cfg_en_main              = 1,\n\t\t.cfg_en_dly               = 0,\n\t\t.cfg_tap_adv_3_0          = 0,\n\t\t.cfg_tap_main             = 1,\n\t\t.cfg_tap_dly_4_0          = 0,\n\t\t.cfg_eq_c_force_3_0       = 0xf,\n\t\t.cfg_vga_ctrl_byp_4_0     = 4,\n\t\t.cfg_eq_r_force_3_0       = 12,\n\t\t.cfg_alos_thr_2_0         = 7,\n\t},\n\t{  \n\t\t.cfg_en_adv               = 1,\n\t\t.cfg_en_main              = 1,\n\t\t.cfg_en_dly               = 1,\n\t\t.cfg_tap_adv_3_0          = 0,\n\t\t.cfg_tap_main             = 1,\n\t\t.cfg_tap_dly_4_0          = 0x10,\n\t\t.cfg_eq_c_force_3_0       = 0xf,\n\t\t.cfg_vga_ctrl_byp_4_0     = 8,\n\t\t.cfg_eq_r_force_3_0       = 4,\n\t\t.cfg_alos_thr_2_0         = 0,\n\t},\n\t{  \n\t\t.cfg_en_adv               = 0,\n\t\t.cfg_en_main              = 1,\n\t\t.cfg_en_dly               = 0,\n\t\t.cfg_tap_adv_3_0          = 0,\n\t\t.cfg_tap_main             = 1,\n\t\t.cfg_tap_dly_4_0          = 0,\n\t\t.cfg_eq_c_force_3_0       = 0xf,\n\t\t.cfg_vga_ctrl_byp_4_0     = 8,\n\t\t.cfg_eq_r_force_3_0       = 0xc,\n\t\t.cfg_alos_thr_2_0         = 0,\n\t},\n};\n\nstatic struct sparx5_sd25g28_mode_preset mode_presets_25g[] = {\n\t{  \n\t\t.bitwidth           = 40,\n\t\t.tx_pre_div         = 0,\n\t\t.fifo_ck_div        = 0,\n\t\t.pre_divsel         = 1,\n\t\t.vco_div_mode       = 0,\n\t\t.sel_div            = 15,\n\t\t.ck_bitwidth        = 3,\n\t\t.subrate            = 0,\n\t\t.com_txcal_en       = 0,\n\t\t.com_tx_reserve_msb = (0x26 << 1),\n\t\t.com_tx_reserve_lsb = 0xf0,\n\t\t.cfg_itx_ipcml_base = 0,\n\t\t.tx_reserve_msb     = 0xcc,\n\t\t.tx_reserve_lsb     = 0xfe,\n\t\t.bw                 = 3,\n\t\t.rxterm             = 0,\n\t\t.dfe_enable         = 1,\n\t\t.dfe_tap            = 0x1f,\n\t\t.txmargin           = 1,\n\t\t.cfg_ctle_rstn      = 1,\n\t\t.r_dfe_rstn         = 1,\n\t\t.cfg_pi_bw_3_0      = 0,\n\t\t.tx_tap_dly         = 8,\n\t\t.tx_tap_adv         = 0xc,\n\t},\n\t{  \n\t\t.bitwidth           = 64,\n\t\t.tx_pre_div         = 0,\n\t\t.fifo_ck_div        = 2,\n\t\t.pre_divsel         = 0,\n\t\t.vco_div_mode       = 1,\n\t\t.sel_div            = 9,\n\t\t.ck_bitwidth        = 0,\n\t\t.subrate            = 0,\n\t\t.com_txcal_en       = 1,\n\t\t.com_tx_reserve_msb = (0x20 << 1),\n\t\t.com_tx_reserve_lsb = 0x40,\n\t\t.cfg_itx_ipcml_base = 0,\n\t\t.tx_reserve_msb     = 0x4c,\n\t\t.tx_reserve_lsb     = 0x44,\n\t\t.bw                 = 3,\n\t\t.cfg_pi_bw_3_0      = 0,\n\t\t.rxterm             = 3,\n\t\t.dfe_enable         = 1,\n\t\t.dfe_tap            = 0x1f,\n\t\t.txmargin           = 0,\n\t\t.cfg_ctle_rstn      = 1,\n\t\t.r_dfe_rstn         = 1,\n\t\t.tx_tap_dly         = 0,\n\t\t.tx_tap_adv         = 0,\n\t},\n\t{  \n\t\t.bitwidth           = 64,\n\t\t.tx_pre_div         = 0,\n\t\t.fifo_ck_div        = 2,\n\t\t.pre_divsel         = 0,\n\t\t.vco_div_mode       = 2,\n\t\t.sel_div            = 9,\n\t\t.ck_bitwidth        = 0,\n\t\t.subrate            = 0,\n\t\t.com_txcal_en       = 1,\n\t\t.com_tx_reserve_msb = (0x20 << 1),\n\t\t.com_tx_reserve_lsb = 0,\n\t\t.cfg_itx_ipcml_base = 0,\n\t\t.tx_reserve_msb     = 0xe,\n\t\t.tx_reserve_lsb     = 0x80,\n\t\t.bw                 = 0,\n\t\t.rxterm             = 0,\n\t\t.cfg_pi_bw_3_0      = 6,\n\t\t.dfe_enable         = 0,\n\t\t.dfe_tap            = 0,\n\t\t.tx_tap_dly         = 0,\n\t\t.tx_tap_adv         = 0,\n\t},\n\t{  \n\t\t.bitwidth           = 10,\n\t\t.tx_pre_div         = 0,\n\t\t.fifo_ck_div        = 0,\n\t\t.pre_divsel         = 0,\n\t\t.vco_div_mode       = 1,\n\t\t.sel_div            = 6,\n\t\t.ck_bitwidth        = 3,\n\t\t.subrate            = 2,\n\t\t.com_txcal_en       = 1,\n\t\t.com_tx_reserve_msb = (0x26 << 1),\n\t\t.com_tx_reserve_lsb = (0xf << 4),\n\t\t.cfg_itx_ipcml_base = 2,\n\t\t.tx_reserve_msb     = 0x8,\n\t\t.tx_reserve_lsb     = 0x8a,\n\t\t.bw                 = 0,\n\t\t.cfg_pi_bw_3_0      = 0,\n\t\t.rxterm             = (1 << 2),\n\t\t.dfe_enable         = 0,\n\t\t.dfe_tap            = 0,\n\t\t.tx_tap_dly         = 0,\n\t\t.tx_tap_adv         = 0,\n\t},\n\t{  \n\t\t.bitwidth           = 10,\n\t\t.tx_pre_div         = 0,\n\t\t.fifo_ck_div        = 1,\n\t\t.pre_divsel         = 0,\n\t\t.vco_div_mode       = 1,\n\t\t.sel_div            = 8,\n\t\t.ck_bitwidth        = 3,\n\t\t.subrate            = 3,\n\t\t.com_txcal_en       = 1,\n\t\t.com_tx_reserve_msb = (0x26 << 1),\n\t\t.com_tx_reserve_lsb = 0xf0,\n\t\t.cfg_itx_ipcml_base = 0,\n\t\t.tx_reserve_msb     = 0x8,\n\t\t.tx_reserve_lsb     = 0xce,\n\t\t.bw                 = 0,\n\t\t.rxterm             = 0,\n\t\t.cfg_pi_bw_3_0      = 0,\n\t\t.dfe_enable         = 0,\n\t\t.dfe_tap            = 0,\n\t\t.tx_tap_dly         = 0,\n\t\t.tx_tap_adv         = 0,\n\t},\n};\n\nstatic struct sparx5_sd10g28_media_preset media_presets_10g[] = {\n\t{  \n\t\t.cfg_en_adv               = 0,\n\t\t.cfg_en_main              = 1,\n\t\t.cfg_en_dly               = 0,\n\t\t.cfg_tap_adv_3_0          = 0,\n\t\t.cfg_tap_main             = 1,\n\t\t.cfg_tap_dly_4_0          = 0,\n\t\t.cfg_vga_ctrl_3_0         = 5,\n\t\t.cfg_vga_cp_2_0           = 0,\n\t\t.cfg_eq_res_3_0           = 0xa,\n\t\t.cfg_eq_r_byp             = 1,\n\t\t.cfg_eq_c_force_3_0       = 0x8,\n\t\t.cfg_alos_thr_3_0         = 0x3,\n\t},\n\t{  \n\t\t.cfg_en_adv               = 1,\n\t\t.cfg_en_main              = 1,\n\t\t.cfg_en_dly               = 1,\n\t\t.cfg_tap_adv_3_0          = 0,\n\t\t.cfg_tap_main             = 1,\n\t\t.cfg_tap_dly_4_0          = 0xc,\n\t\t.cfg_vga_ctrl_3_0         = 0xa,\n\t\t.cfg_vga_cp_2_0           = 0x4,\n\t\t.cfg_eq_res_3_0           = 0xa,\n\t\t.cfg_eq_r_byp             = 1,\n\t\t.cfg_eq_c_force_3_0       = 0xF,\n\t\t.cfg_alos_thr_3_0         = 0x3,\n\t},\n\t{  \n\t\t.cfg_en_adv               = 1,\n\t\t.cfg_en_main              = 1,\n\t\t.cfg_en_dly               = 1,\n\t\t.cfg_tap_adv_3_0          = 12,\n\t\t.cfg_tap_main             = 1,\n\t\t.cfg_tap_dly_4_0          = 8,\n\t\t.cfg_vga_ctrl_3_0         = 0xa,\n\t\t.cfg_vga_cp_2_0           = 4,\n\t\t.cfg_eq_res_3_0           = 0xa,\n\t\t.cfg_eq_r_byp             = 1,\n\t\t.cfg_eq_c_force_3_0       = 0xf,\n\t\t.cfg_alos_thr_3_0         = 0x0,\n\t}\n};\n\nstatic struct sparx5_sd10g28_mode_preset mode_presets_10g[] = {\n\t{  \n\t\t.bwidth           = 64,\n\t\t.cmu_sel          = SPX5_SD10G28_CMU_MAIN,\n\t\t.rate             = 0x0,\n\t\t.dfe_enable       = 1,\n\t\t.dfe_tap          = 0x1f,\n\t\t.pi_bw_gen1       = 0x0,\n\t\t.duty_cycle       = 0x2,\n\t},\n\t{  \n\t\t.bwidth           = 16,\n\t\t.cmu_sel          = SPX5_SD10G28_CMU_MAIN,\n\t\t.rate             = 0x1,\n\t\t.dfe_enable       = 0,\n\t\t.dfe_tap          = 0,\n\t\t.pi_bw_gen1       = 0x5,\n\t\t.duty_cycle       = 0x0,\n\t},\n\t{  \n\t\t.bwidth           = 64,\n\t\t.cmu_sel          = SPX5_SD10G28_CMU_MAIN,\n\t\t.rate             = 0x1,\n\t\t.dfe_enable       = 0,\n\t\t.dfe_tap          = 0,\n\t\t.pi_bw_gen1       = 0x5,\n\t\t.duty_cycle       = 0x0,\n\t},\n\t{  \n\t\t.bwidth           = 20,\n\t\t.cmu_sel          = SPX5_SD10G28_CMU_AUX1,\n\t\t.rate             = 0x1,\n\t\t.dfe_enable       = 0,\n\t\t.dfe_tap          = 0,\n\t\t.pi_bw_gen1       = 0x5,\n\t\t.duty_cycle       = 0x0,\n\t},\n\t{  \n\t\t.bwidth           = 10,\n\t\t.cmu_sel          = SPX5_SD10G28_CMU_AUX2,\n\t\t.rate             = 0x2,\n\t\t.dfe_enable       = 0,\n\t\t.dfe_tap          = 0,\n\t\t.pi_bw_gen1       = 0x7,\n\t\t.duty_cycle       = 0x0,\n\t},\n\t{  \n\t\t.bwidth           = 10,\n\t\t.cmu_sel          = SPX5_SD10G28_CMU_AUX1,\n\t\t.rate             = 0x3,\n\t\t.dfe_enable       = 0,\n\t\t.dfe_tap          = 0,\n\t\t.pi_bw_gen1       = 0x7,\n\t\t.duty_cycle       = 0x0,\n\t},\n};\n\n \nstatic u8 sd25g28_get_iw_setting(struct device *dev, const u8 interface_width)\n{\n\tswitch (interface_width) {\n\tcase 10: return 0;\n\tcase 16: return 1;\n\tcase 32: return 3;\n\tcase 40: return 4;\n\tcase 64: return 5;\n\tdefault:\n\t\tdev_err(dev, \"%s: Illegal value %d for interface width\\n\",\n\t\t       __func__, interface_width);\n\t}\n\treturn 0;\n}\n\n \nstatic u8 sd10g28_get_iw_setting(struct device *dev, const u8 interface_width)\n{\n\tswitch (interface_width) {\n\tcase 10: return 0;\n\tcase 16: return 1;\n\tcase 20: return 2;\n\tcase 32: return 3;\n\tcase 40: return 4;\n\tcase 64: return 7;\n\tdefault:\n\t\tdev_err(dev, \"%s: Illegal value %d for interface width\\n\", __func__,\n\t\t       interface_width);\n\t\treturn 0;\n\t}\n}\n\nstatic int sparx5_sd10g25_get_mode_preset(struct sparx5_serdes_macro *macro,\n\t\t\t\t\t  struct sparx5_sd25g28_mode_preset *mode)\n{\n\tswitch (macro->serdesmode) {\n\tcase SPX5_SD_MODE_SFI:\n\t\tif (macro->speed == SPEED_25000)\n\t\t\t*mode = mode_presets_25g[SPX5_SD25G28_MODE_PRESET_25000];\n\t\telse if (macro->speed == SPEED_10000)\n\t\t\t*mode = mode_presets_25g[SPX5_SD25G28_MODE_PRESET_10000];\n\t\telse if (macro->speed == SPEED_5000)\n\t\t\t*mode = mode_presets_25g[SPX5_SD25G28_MODE_PRESET_5000];\n\t\tbreak;\n\tcase SPX5_SD_MODE_2G5:\n\t\t*mode = mode_presets_25g[SPX5_SD25G28_MODE_PRESET_SD_2G5];\n\t\tbreak;\n\tcase SPX5_SD_MODE_1000BASEX:\n\t\t*mode = mode_presets_25g[SPX5_SD25G28_MODE_PRESET_1000BASEX];\n\t\tbreak;\n\tcase SPX5_SD_MODE_100FX:\n\t\t  \n\t\treturn -EINVAL;\n\tdefault:\n\t\t*mode = mode_presets_25g[SPX5_SD25G28_MODE_PRESET_25000];\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic int sparx5_sd10g28_get_mode_preset(struct sparx5_serdes_macro *macro,\n\t\t\t\t\t  struct sparx5_sd10g28_mode_preset *mode,\n\t\t\t\t\t  struct sparx5_sd10g28_args *args)\n{\n\tswitch (macro->serdesmode) {\n\tcase SPX5_SD_MODE_SFI:\n\t\tif (macro->speed == SPEED_10000) {\n\t\t\t*mode = mode_presets_10g[SPX5_SD10G28_MODE_PRESET_10000];\n\t\t} else if (macro->speed == SPEED_5000) {\n\t\t\tif (args->is_6g)\n\t\t\t\t*mode = mode_presets_10g[SPX5_SD10G28_MODE_PRESET_SFI_5000_6G];\n\t\t\telse\n\t\t\t\t*mode = mode_presets_10g[SPX5_SD10G28_MODE_PRESET_SFI_5000_10G];\n\t\t} else {\n\t\t\tdev_err(macro->priv->dev, \"%s: Illegal speed: %02u, sidx: %02u, mode (%u)\",\n\t\t\t       __func__, macro->speed, macro->sidx,\n\t\t\t       macro->serdesmode);\n\t\t\treturn -EINVAL;\n\t\t}\n\t\tbreak;\n\tcase SPX5_SD_MODE_QSGMII:\n\t\t*mode = mode_presets_10g[SPX5_SD10G28_MODE_PRESET_QSGMII];\n\t\tbreak;\n\tcase SPX5_SD_MODE_2G5:\n\t\t*mode = mode_presets_10g[SPX5_SD10G28_MODE_PRESET_SD_2G5];\n\t\tbreak;\n\tcase SPX5_SD_MODE_100FX:\n\tcase SPX5_SD_MODE_1000BASEX:\n\t\t*mode = mode_presets_10g[SPX5_SD10G28_MODE_PRESET_1000BASEX];\n\t\tbreak;\n\tdefault:\n\t\t*mode = mode_presets_10g[SPX5_SD10G28_MODE_PRESET_10000];\n\t\tbreak;\n\t}\n\treturn 0;\n}\n\nstatic void sparx5_sd25g28_get_params(struct sparx5_serdes_macro *macro,\n\t\t\t\t      struct sparx5_sd25g28_media_preset *media,\n\t\t\t\t      struct sparx5_sd25g28_mode_preset *mode,\n\t\t\t\t      struct sparx5_sd25g28_args *args,\n\t\t\t\t      struct sparx5_sd25g28_params *params)\n{\n\tu8 iw = sd25g28_get_iw_setting(macro->priv->dev, mode->bitwidth);\n\tstruct sparx5_sd25g28_params init = {\n\t\t.r_d_width_ctrl_2_0         = iw,\n\t\t.r_txfifo_ck_div_pmad_2_0   = mode->fifo_ck_div,\n\t\t.r_rxfifo_ck_div_pmad_2_0   = mode->fifo_ck_div,\n\t\t.cfg_vco_div_mode_1_0       = mode->vco_div_mode,\n\t\t.cfg_pre_divsel_1_0         = mode->pre_divsel,\n\t\t.cfg_sel_div_3_0            = mode->sel_div,\n\t\t.cfg_vco_start_code_3_0     = 0,\n\t\t.cfg_pma_tx_ck_bitwidth_2_0 = mode->ck_bitwidth,\n\t\t.cfg_tx_prediv_1_0          = mode->tx_pre_div,\n\t\t.cfg_rxdiv_sel_2_0          = mode->ck_bitwidth,\n\t\t.cfg_tx_subrate_2_0         = mode->subrate,\n\t\t.cfg_rx_subrate_2_0         = mode->subrate,\n\t\t.r_multi_lane_mode          = 0,\n\t\t.cfg_cdrck_en               = 1,\n\t\t.cfg_dfeck_en               = mode->dfe_enable,\n\t\t.cfg_dfe_pd                 = mode->dfe_enable == 1 ? 0 : 1,\n\t\t.cfg_dfedmx_pd              = 1,\n\t\t.cfg_dfetap_en_5_1          = mode->dfe_tap,\n\t\t.cfg_dmux_pd                = 0,\n\t\t.cfg_dmux_clk_pd            = 1,\n\t\t.cfg_erramp_pd              = mode->dfe_enable == 1 ? 0 : 1,\n\t\t.cfg_pi_DFE_en              = mode->dfe_enable,\n\t\t.cfg_pi_en                  = 1,\n\t\t.cfg_pd_ctle                = 0,\n\t\t.cfg_summer_en              = 1,\n\t\t.cfg_pmad_ck_pd             = 0,\n\t\t.cfg_pd_clk                 = 0,\n\t\t.cfg_pd_cml                 = 0,\n\t\t.cfg_pd_driver              = 0,\n\t\t.cfg_rx_reg_pu              = 1,\n\t\t.cfg_pd_rms_det             = 1,\n\t\t.cfg_dcdr_pd                = 0,\n\t\t.cfg_ecdr_pd                = 1,\n\t\t.cfg_pd_sq                  = 1,\n\t\t.cfg_itx_ipdriver_base_2_0  = mode->txmargin,\n\t\t.cfg_tap_dly_4_0            = media->cfg_tap_dly_4_0,\n\t\t.cfg_tap_main               = media->cfg_tap_main,\n\t\t.cfg_en_main                = media->cfg_en_main,\n\t\t.cfg_tap_adv_3_0            = media->cfg_tap_adv_3_0,\n\t\t.cfg_en_adv                 = media->cfg_en_adv,\n\t\t.cfg_en_dly                 = media->cfg_en_dly,\n\t\t.cfg_iscan_en               = 0,\n\t\t.l1_pcs_en_fast_iscan       = 0,\n\t\t.l0_cfg_bw_1_0              = 0,\n\t\t.cfg_en_dummy               = 0,\n\t\t.cfg_pll_reserve_3_0        = args->com_pll_reserve,\n\t\t.l0_cfg_txcal_en            = mode->com_txcal_en,\n\t\t.l0_cfg_tx_reserve_15_8     = mode->com_tx_reserve_msb,\n\t\t.l0_cfg_tx_reserve_7_0      = mode->com_tx_reserve_lsb,\n\t\t.cfg_tx_reserve_15_8        = mode->tx_reserve_msb,\n\t\t.cfg_tx_reserve_7_0         = mode->tx_reserve_lsb,\n\t\t.cfg_bw_1_0                 = mode->bw,\n\t\t.cfg_txcal_man_en           = 1,\n\t\t.cfg_phase_man_4_0          = 0,\n\t\t.cfg_quad_man_1_0           = 0,\n\t\t.cfg_txcal_shift_code_5_0   = 2,\n\t\t.cfg_txcal_valid_sel_3_0    = 4,\n\t\t.cfg_txcal_en               = 0,\n\t\t.cfg_cdr_kf_2_0             = 1,\n\t\t.cfg_cdr_m_7_0              = 6,\n\t\t.cfg_pi_bw_3_0              = mode->cfg_pi_bw_3_0,\n\t\t.cfg_pi_steps_1_0           = 0,\n\t\t.cfg_dis_2ndorder           = 1,\n\t\t.cfg_ctle_rstn              = mode->cfg_ctle_rstn,\n\t\t.r_dfe_rstn                 = mode->r_dfe_rstn,\n\t\t.cfg_alos_thr_2_0           = media->cfg_alos_thr_2_0,\n\t\t.cfg_itx_ipcml_base_1_0     = mode->cfg_itx_ipcml_base,\n\t\t.cfg_rx_reserve_7_0         = 0xbf,\n\t\t.cfg_rx_reserve_15_8        = 0x61,\n\t\t.cfg_rxterm_2_0             = mode->rxterm,\n\t\t.cfg_fom_selm               = 0,\n\t\t.cfg_rx_sp_ctle_1_0         = 0,\n\t\t.cfg_isel_ctle_1_0          = 0,\n\t\t.cfg_vga_ctrl_byp_4_0       = media->cfg_vga_ctrl_byp_4_0,\n\t\t.cfg_vga_byp                = 1,\n\t\t.cfg_agc_adpt_byp           = 1,\n\t\t.cfg_eqr_byp                = 1,\n\t\t.cfg_eqr_force_3_0          = media->cfg_eq_r_force_3_0,\n\t\t.cfg_eqc_force_3_0          = media->cfg_eq_c_force_3_0,\n\t\t.cfg_sum_setcm_en           = 1,\n\t\t.cfg_pi_dfe_en              = 1,\n\t\t.cfg_init_pos_iscan_6_0     = 6,\n\t\t.cfg_init_pos_ipi_6_0       = 9,\n\t\t.cfg_dfedig_m_2_0           = 6,\n\t\t.cfg_en_dfedig              = mode->dfe_enable,\n\t\t.r_d_width_ctrl_from_hwt    = 0,\n\t\t.r_reg_manual               = 1,\n\t\t.reg_rst                    = args->reg_rst,\n\t\t.cfg_jc_byp                 = 1,\n\t\t.cfg_common_reserve_7_0     = 1,\n\t\t.cfg_pll_lol_set            = 1,\n\t\t.cfg_tx2rx_lp_en            = 0,\n\t\t.cfg_txlb_en                = 0,\n\t\t.cfg_rx2tx_lp_en            = 0,\n\t\t.cfg_rxlb_en                = 0,\n\t\t.r_tx_pol_inv               = args->txinvert,\n\t\t.r_rx_pol_inv               = args->rxinvert,\n\t};\n\n\t*params = init;\n}\n\nstatic void sparx5_sd10g28_get_params(struct sparx5_serdes_macro *macro,\n\t\t\t\t      struct sparx5_sd10g28_media_preset *media,\n\t\t\t\t      struct sparx5_sd10g28_mode_preset *mode,\n\t\t\t\t      struct sparx5_sd10g28_args *args,\n\t\t\t\t      struct sparx5_sd10g28_params *params)\n{\n\tu8 iw = sd10g28_get_iw_setting(macro->priv->dev, mode->bwidth);\n\tstruct sparx5_sd10g28_params init = {\n\t\t.skip_cmu_cfg                = args->skip_cmu_cfg,\n\t\t.is_6g                       = args->is_6g,\n\t\t.cmu_sel                     = mode->cmu_sel,\n\t\t.cfg_lane_reserve_7_0        = (mode->cmu_sel % 2) << 6,\n\t\t.cfg_ssc_rtl_clk_sel         = (mode->cmu_sel / 2),\n\t\t.cfg_lane_reserve_15_8       = mode->duty_cycle,\n\t\t.cfg_txrate_1_0              = mode->rate,\n\t\t.cfg_rxrate_1_0              = mode->rate,\n\t\t.fx_100                      = macro->serdesmode == SPX5_SD_MODE_100FX,\n\t\t.r_d_width_ctrl_2_0          = iw,\n\t\t.cfg_pma_tx_ck_bitwidth_2_0  = iw,\n\t\t.cfg_rxdiv_sel_2_0           = iw,\n\t\t.r_pcs2pma_phymode_4_0       = 0,\n\t\t.cfg_lane_id_2_0             = 0,\n\t\t.cfg_cdrck_en                = 1,\n\t\t.cfg_dfeck_en                = mode->dfe_enable,\n\t\t.cfg_dfe_pd                  = (mode->dfe_enable == 1) ? 0 : 1,\n\t\t.cfg_dfetap_en_5_1           = mode->dfe_tap,\n\t\t.cfg_erramp_pd               = (mode->dfe_enable == 1) ? 0 : 1,\n\t\t.cfg_pi_DFE_en               = mode->dfe_enable,\n\t\t.cfg_pi_en                   = 1,\n\t\t.cfg_pd_ctle                 = 0,\n\t\t.cfg_summer_en               = 1,\n\t\t.cfg_pd_rx_cktree            = 0,\n\t\t.cfg_pd_clk                  = 0,\n\t\t.cfg_pd_cml                  = 0,\n\t\t.cfg_pd_driver               = 0,\n\t\t.cfg_rx_reg_pu               = 1,\n\t\t.cfg_d_cdr_pd                = 0,\n\t\t.cfg_pd_sq                   = mode->dfe_enable,\n\t\t.cfg_rxdet_en                = 0,\n\t\t.cfg_rxdet_str               = 0,\n\t\t.r_multi_lane_mode           = 0,\n\t\t.cfg_en_adv                  = media->cfg_en_adv,\n\t\t.cfg_en_main                 = 1,\n\t\t.cfg_en_dly                  = media->cfg_en_dly,\n\t\t.cfg_tap_adv_3_0             = media->cfg_tap_adv_3_0,\n\t\t.cfg_tap_main                = media->cfg_tap_main,\n\t\t.cfg_tap_dly_4_0             = media->cfg_tap_dly_4_0,\n\t\t.cfg_vga_ctrl_3_0            = media->cfg_vga_ctrl_3_0,\n\t\t.cfg_vga_cp_2_0              = media->cfg_vga_cp_2_0,\n\t\t.cfg_eq_res_3_0              = media->cfg_eq_res_3_0,\n\t\t.cfg_eq_r_byp                = media->cfg_eq_r_byp,\n\t\t.cfg_eq_c_force_3_0          = media->cfg_eq_c_force_3_0,\n\t\t.cfg_en_dfedig               = mode->dfe_enable,\n\t\t.cfg_sum_setcm_en            = 1,\n\t\t.cfg_en_preemph              = 0,\n\t\t.cfg_itx_ippreemp_base_1_0   = 0,\n\t\t.cfg_itx_ipdriver_base_2_0   = (args->txswing >> 6),\n\t\t.cfg_ibias_tune_reserve_5_0  = (args->txswing & 63),\n\t\t.cfg_txswing_half            = (args->txmargin),\n\t\t.cfg_dis_2nd_order           = 0x1,\n\t\t.cfg_rx_ssc_lh               = 0x0,\n\t\t.cfg_pi_floop_steps_1_0      = 0x0,\n\t\t.cfg_pi_ext_dac_23_16        = (1 << 5),\n\t\t.cfg_pi_ext_dac_15_8         = (0 << 6),\n\t\t.cfg_iscan_ext_dac_7_0       = (1 << 7) + 9,\n\t\t.cfg_cdr_kf_gen1_2_0         = 1,\n\t\t.cfg_cdr_kf_gen2_2_0         = 1,\n\t\t.cfg_cdr_kf_gen3_2_0         = 1,\n\t\t.cfg_cdr_kf_gen4_2_0         = 1,\n\t\t.r_cdr_m_gen1_7_0            = 4,\n\t\t.cfg_pi_bw_gen1_3_0          = mode->pi_bw_gen1,\n\t\t.cfg_pi_bw_gen2              = mode->pi_bw_gen1,\n\t\t.cfg_pi_bw_gen3              = mode->pi_bw_gen1,\n\t\t.cfg_pi_bw_gen4              = mode->pi_bw_gen1,\n\t\t.cfg_pi_ext_dac_7_0          = 3,\n\t\t.cfg_pi_steps                = 0,\n\t\t.cfg_mp_max_3_0              = 1,\n\t\t.cfg_rstn_dfedig             = mode->dfe_enable,\n\t\t.cfg_alos_thr_3_0            = media->cfg_alos_thr_3_0,\n\t\t.cfg_predrv_slewrate_1_0     = 3,\n\t\t.cfg_itx_ipcml_base_1_0      = 0,\n\t\t.cfg_ip_pre_base_1_0         = 0,\n\t\t.r_cdr_m_gen2_7_0            = 2,\n\t\t.r_cdr_m_gen3_7_0            = 2,\n\t\t.r_cdr_m_gen4_7_0            = 2,\n\t\t.r_en_auto_cdr_rstn          = 0,\n\t\t.cfg_oscal_afe               = 1,\n\t\t.cfg_pd_osdac_afe            = 0,\n\t\t.cfg_resetb_oscal_afe[0]     = 0,\n\t\t.cfg_resetb_oscal_afe[1]     = 1,\n\t\t.cfg_center_spreading        = 0,\n\t\t.cfg_m_cnt_maxval_4_0        = 15,\n\t\t.cfg_ncnt_maxval_7_0         = 32,\n\t\t.cfg_ncnt_maxval_10_8        = 6,\n\t\t.cfg_ssc_en                  = 1,\n\t\t.cfg_tx2rx_lp_en             = 0,\n\t\t.cfg_txlb_en                 = 0,\n\t\t.cfg_rx2tx_lp_en             = 0,\n\t\t.cfg_rxlb_en                 = 0,\n\t\t.r_tx_pol_inv                = args->txinvert,\n\t\t.r_rx_pol_inv                = args->rxinvert,\n\t};\n\n\t*params = init;\n}\n\nstatic int sparx5_cmu_apply_cfg(struct sparx5_serdes_private *priv,\n\t\t\t\tu32 cmu_idx,\n\t\t\t\tvoid __iomem *cmu_tgt,\n\t\t\t\tvoid __iomem *cmu_cfg_tgt,\n\t\t\t\tu32 spd10g)\n{\n\tvoid __iomem **regs = priv->regs;\n\tstruct device *dev = priv->dev;\n\tint value;\n\n\tcmu_tgt = sdx5_inst_get(priv, TARGET_SD_CMU, cmu_idx);\n\tcmu_cfg_tgt = sdx5_inst_get(priv, TARGET_SD_CMU_CFG, cmu_idx);\n\n\tif (cmu_idx == 1 || cmu_idx == 4 || cmu_idx == 7 ||\n\t    cmu_idx == 10 || cmu_idx == 13) {\n\t\tspd10g = 0;\n\t}\n\n\tsdx5_inst_rmw(SD_CMU_CFG_SD_CMU_CFG_EXT_CFG_RST_SET(1),\n\t\t      SD_CMU_CFG_SD_CMU_CFG_EXT_CFG_RST,\n\t\t      cmu_cfg_tgt,\n\t\t      SD_CMU_CFG_SD_CMU_CFG(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CFG_SD_CMU_CFG_EXT_CFG_RST_SET(0),\n\t\t      SD_CMU_CFG_SD_CMU_CFG_EXT_CFG_RST,\n\t\t      cmu_cfg_tgt,\n\t\t      SD_CMU_CFG_SD_CMU_CFG(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CFG_SD_CMU_CFG_CMU_RST_SET(1),\n\t\t      SD_CMU_CFG_SD_CMU_CFG_CMU_RST,\n\t\t      cmu_cfg_tgt,\n\t\t      SD_CMU_CFG_SD_CMU_CFG(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CMU_45_R_DWIDTHCTRL_FROM_HWT_SET(0x1) |\n\t\t      SD_CMU_CMU_45_R_REFCK_SSC_EN_FROM_HWT_SET(0x1) |\n\t\t      SD_CMU_CMU_45_R_LINK_BUF_EN_FROM_HWT_SET(0x1) |\n\t\t      SD_CMU_CMU_45_R_BIAS_EN_FROM_HWT_SET(0x1) |\n\t\t      SD_CMU_CMU_45_R_EN_RATECHG_CTRL_SET(0x0),\n\t\t      SD_CMU_CMU_45_R_DWIDTHCTRL_FROM_HWT |\n\t\t      SD_CMU_CMU_45_R_REFCK_SSC_EN_FROM_HWT |\n\t\t      SD_CMU_CMU_45_R_LINK_BUF_EN_FROM_HWT |\n\t\t      SD_CMU_CMU_45_R_BIAS_EN_FROM_HWT |\n\t\t      SD_CMU_CMU_45_R_EN_RATECHG_CTRL,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_45(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CMU_47_R_PCS2PMA_PHYMODE_4_0_SET(0),\n\t\t      SD_CMU_CMU_47_R_PCS2PMA_PHYMODE_4_0,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_47(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CMU_1B_CFG_RESERVE_7_0_SET(0),\n\t\t      SD_CMU_CMU_1B_CFG_RESERVE_7_0,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_1B(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CMU_0D_CFG_JC_BYP_SET(0x1),\n\t\t      SD_CMU_CMU_0D_CFG_JC_BYP,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_0D(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CMU_1F_CFG_VTUNE_SEL_SET(1),\n\t\t      SD_CMU_CMU_1F_CFG_VTUNE_SEL,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_1F(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CMU_00_CFG_PLL_TP_SEL_1_0_SET(3),\n\t\t      SD_CMU_CMU_00_CFG_PLL_TP_SEL_1_0,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_00(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CMU_05_CFG_BIAS_TP_SEL_1_0_SET(3),\n\t\t      SD_CMU_CMU_05_CFG_BIAS_TP_SEL_1_0,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_05(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CMU_30_R_PLL_DLOL_EN_SET(1),\n\t\t      SD_CMU_CMU_30_R_PLL_DLOL_EN,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_30(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CMU_09_CFG_SW_10G_SET(spd10g),\n\t\t      SD_CMU_CMU_09_CFG_SW_10G,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_09(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CFG_SD_CMU_CFG_CMU_RST_SET(0),\n\t\t      SD_CMU_CFG_SD_CMU_CFG_CMU_RST,\n\t\t      cmu_cfg_tgt,\n\t\t      SD_CMU_CFG_SD_CMU_CFG(cmu_idx));\n\n\tmsleep(20);\n\n\tsdx5_inst_rmw(SD_CMU_CMU_44_R_PLL_RSTN_SET(0),\n\t\t      SD_CMU_CMU_44_R_PLL_RSTN,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_44(cmu_idx));\n\n\tsdx5_inst_rmw(SD_CMU_CMU_44_R_PLL_RSTN_SET(1),\n\t\t      SD_CMU_CMU_44_R_PLL_RSTN,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_44(cmu_idx));\n\n\tmsleep(20);\n\n\tvalue = readl(sdx5_addr(regs, SD_CMU_CMU_E0(cmu_idx)));\n\tvalue = SD_CMU_CMU_E0_PLL_LOL_UDL_GET(value);\n\n\tif (value) {\n\t\tdev_err(dev, \"CMU PLL Loss of Lock: 0x%x\\n\", value);\n\t\treturn -EINVAL;\n\t}\n\tsdx5_inst_rmw(SD_CMU_CMU_0D_CFG_PMA_TX_CK_PD_SET(0),\n\t\t      SD_CMU_CMU_0D_CFG_PMA_TX_CK_PD,\n\t\t      cmu_tgt,\n\t\t      SD_CMU_CMU_0D(cmu_idx));\n\treturn 0;\n}\n\nstatic int sparx5_cmu_cfg(struct sparx5_serdes_private *priv, u32 cmu_idx)\n{\n\tvoid __iomem *cmu_tgt, *cmu_cfg_tgt;\n\tu32 spd10g = 1;\n\n\tif (cmu_idx == 1 || cmu_idx == 4 || cmu_idx == 7 ||\n\t    cmu_idx == 10 || cmu_idx == 13) {\n\t\tspd10g = 0;\n\t}\n\n\tcmu_tgt = sdx5_inst_get(priv, TARGET_SD_CMU, cmu_idx);\n\tcmu_cfg_tgt = sdx5_inst_get(priv, TARGET_SD_CMU_CFG, cmu_idx);\n\n\treturn sparx5_cmu_apply_cfg(priv, cmu_idx, cmu_tgt, cmu_cfg_tgt, spd10g);\n}\n\n \nstatic const int\nsparx5_serdes_cmu_map[SPX5_SD10G28_CMU_MAX][SPX5_SERDES_6G10G_CNT] = {\n\t[SPX5_SD10G28_CMU_MAIN] = {  2,  2,  2,  2,  2,\n\t\t\t\t     2,  2,  2,  5,  5,\n\t\t\t\t     5,  5,  5,  5,  5,\n\t\t\t\t     5,  8, 11, 11, 11,\n\t\t\t\t    11, 11, 11, 11, 11 },\n\t[SPX5_SD10G28_CMU_AUX1] = {  0,  0,  3,  3,  3,\n\t\t\t\t     3,  3,  3,  3,  3,\n\t\t\t\t     6,  6,  6,  6,  6,\n\t\t\t\t     6,  6,  9,  9, 12,\n\t\t\t\t    12, 12, 12, 12, 12 },\n\t[SPX5_SD10G28_CMU_AUX2] = {  1,  1,  1,  1,  4,\n\t\t\t\t     4,  4,  4,  4,  4,\n\t\t\t\t     4,  4,  7,  7,  7,\n\t\t\t\t     7,  7, 10, 10, 10,\n\t\t\t\t    10, 13, 13, 13, 13 },\n\t[SPX5_SD10G28_CMU_NONE] = {  1,  1,  1,  1,  4,\n\t\t\t\t     4,  4,  4,  4,  4,\n\t\t\t\t     4,  4,  7,  7,  7,\n\t\t\t\t     7,  7, 10, 10, 10,\n\t\t\t\t    10, 13, 13, 13, 13 },\n};\n\n \nstatic int sparx5_serdes_cmu_get(enum sparx5_10g28cmu_mode mode, int sd_index)\n{\n\treturn sparx5_serdes_cmu_map[mode][sd_index];\n}\n\nstatic void sparx5_serdes_cmu_power_off(struct sparx5_serdes_private *priv)\n{\n\tvoid __iomem *cmu_inst, *cmu_cfg_inst;\n\tint i;\n\n\t \n\tfor (i = 0; i < SPX5_CMU_MAX; i++) {\n\t\tcmu_inst = sdx5_inst_get(priv, TARGET_SD_CMU, i);\n\t\tcmu_cfg_inst = sdx5_inst_get(priv, TARGET_SD_CMU_CFG, i);\n\n\t\tsdx5_inst_rmw(SD_CMU_CFG_SD_CMU_CFG_EXT_CFG_RST_SET(0),\n\t\t\t      SD_CMU_CFG_SD_CMU_CFG_EXT_CFG_RST, cmu_cfg_inst,\n\t\t\t      SD_CMU_CFG_SD_CMU_CFG(0));\n\n\t\tsdx5_inst_rmw(SD_CMU_CMU_05_CFG_REFCK_TERM_EN_SET(0),\n\t\t\t      SD_CMU_CMU_05_CFG_REFCK_TERM_EN, cmu_inst,\n\t\t\t      SD_CMU_CMU_05(0));\n\n\t\tsdx5_inst_rmw(SD_CMU_CMU_09_CFG_EN_TX_CK_DN_SET(0),\n\t\t\t      SD_CMU_CMU_09_CFG_EN_TX_CK_DN, cmu_inst,\n\t\t\t      SD_CMU_CMU_09(0));\n\n\t\tsdx5_inst_rmw(SD_CMU_CMU_06_CFG_VCO_PD_SET(1),\n\t\t\t      SD_CMU_CMU_06_CFG_VCO_PD, cmu_inst,\n\t\t\t      SD_CMU_CMU_06(0));\n\n\t\tsdx5_inst_rmw(SD_CMU_CMU_09_CFG_EN_TX_CK_UP_SET(0),\n\t\t\t      SD_CMU_CMU_09_CFG_EN_TX_CK_UP, cmu_inst,\n\t\t\t      SD_CMU_CMU_09(0));\n\n\t\tsdx5_inst_rmw(SD_CMU_CMU_08_CFG_CK_TREE_PD_SET(1),\n\t\t\t      SD_CMU_CMU_08_CFG_CK_TREE_PD, cmu_inst,\n\t\t\t      SD_CMU_CMU_08(0));\n\n\t\tsdx5_inst_rmw(SD_CMU_CMU_0D_CFG_REFCK_PD_SET(1) |\n\t\t\t      SD_CMU_CMU_0D_CFG_PD_DIV64_SET(1) |\n\t\t\t      SD_CMU_CMU_0D_CFG_PD_DIV66_SET(1),\n\t\t\t      SD_CMU_CMU_0D_CFG_REFCK_PD |\n\t\t\t      SD_CMU_CMU_0D_CFG_PD_DIV64 |\n\t\t\t      SD_CMU_CMU_0D_CFG_PD_DIV66, cmu_inst,\n\t\t\t      SD_CMU_CMU_0D(0));\n\n\t\tsdx5_inst_rmw(SD_CMU_CMU_06_CFG_CTRL_LOGIC_PD_SET(1),\n\t\t\t      SD_CMU_CMU_06_CFG_CTRL_LOGIC_PD, cmu_inst,\n\t\t\t      SD_CMU_CMU_06(0));\n\t}\n}\n\nstatic void sparx5_sd25g28_reset(void __iomem *regs[],\n\t\t\t\t struct sparx5_sd25g28_params *params,\n\t\t\t\t u32 sd_index)\n{\n\tif (params->reg_rst == 1) {\n\t\tsdx5_rmw_addr(SD_LANE_25G_SD_LANE_CFG_EXT_CFG_RST_SET(1),\n\t\t\t SD_LANE_25G_SD_LANE_CFG_EXT_CFG_RST,\n\t\t\t sdx5_addr(regs, SD_LANE_25G_SD_LANE_CFG(sd_index)));\n\n\t\tusleep_range(1000, 2000);\n\n\t\tsdx5_rmw_addr(SD_LANE_25G_SD_LANE_CFG_EXT_CFG_RST_SET(0),\n\t\t\t SD_LANE_25G_SD_LANE_CFG_EXT_CFG_RST,\n\t\t\t sdx5_addr(regs, SD_LANE_25G_SD_LANE_CFG(sd_index)));\n\t}\n}\n\nstatic int sparx5_sd25g28_apply_params(struct sparx5_serdes_macro *macro,\n\t\t\t\t       struct sparx5_sd25g28_params *params)\n{\n\tstruct sparx5_serdes_private *priv = macro->priv;\n\tvoid __iomem **regs = priv->regs;\n\tstruct device *dev = priv->dev;\n\tu32 sd_index = macro->stpidx;\n\tu32 value;\n\n\tsdx5_rmw(SD_LANE_25G_SD_LANE_CFG_MACRO_RST_SET(1),\n\t\t SD_LANE_25G_SD_LANE_CFG_MACRO_RST,\n\t\t priv,\n\t\t SD_LANE_25G_SD_LANE_CFG(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_FF_REGISTER_TABLE_INDEX_SET(0xFF),\n\t\t SD25G_LANE_CMU_FF_REGISTER_TABLE_INDEX,\n\t\t priv,\n\t\t SD25G_LANE_CMU_FF(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_1A_R_DWIDTHCTRL_FROM_HWT_SET\n\t\t (params->r_d_width_ctrl_from_hwt) |\n\t\t SD25G_LANE_CMU_1A_R_REG_MANUAL_SET(params->r_reg_manual),\n\t\t SD25G_LANE_CMU_1A_R_DWIDTHCTRL_FROM_HWT |\n\t\t SD25G_LANE_CMU_1A_R_REG_MANUAL,\n\t\t priv,\n\t\t SD25G_LANE_CMU_1A(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_31_CFG_COMMON_RESERVE_7_0_SET\n\t\t (params->cfg_common_reserve_7_0),\n\t\t SD25G_LANE_CMU_31_CFG_COMMON_RESERVE_7_0,\n\t\t priv,\n\t\t SD25G_LANE_CMU_31(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_09_CFG_EN_DUMMY_SET(params->cfg_en_dummy),\n\t\t SD25G_LANE_CMU_09_CFG_EN_DUMMY,\n\t\t priv,\n\t\t SD25G_LANE_CMU_09(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_13_CFG_PLL_RESERVE_3_0_SET\n\t\t (params->cfg_pll_reserve_3_0),\n\t\t SD25G_LANE_CMU_13_CFG_PLL_RESERVE_3_0,\n\t\t priv,\n\t\t SD25G_LANE_CMU_13(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_40_L0_CFG_TXCAL_EN_SET(params->l0_cfg_txcal_en),\n\t\t SD25G_LANE_CMU_40_L0_CFG_TXCAL_EN,\n\t\t priv,\n\t\t SD25G_LANE_CMU_40(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_46_L0_CFG_TX_RESERVE_15_8_SET\n\t\t (params->l0_cfg_tx_reserve_15_8),\n\t\t SD25G_LANE_CMU_46_L0_CFG_TX_RESERVE_15_8,\n\t\t priv,\n\t\t SD25G_LANE_CMU_46(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_45_L0_CFG_TX_RESERVE_7_0_SET\n\t\t (params->l0_cfg_tx_reserve_7_0),\n\t\t SD25G_LANE_CMU_45_L0_CFG_TX_RESERVE_7_0,\n\t\t priv,\n\t\t SD25G_LANE_CMU_45(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_0B_CFG_VCO_CAL_RESETN_SET(0),\n\t\t SD25G_LANE_CMU_0B_CFG_VCO_CAL_RESETN,\n\t\t priv,\n\t\t SD25G_LANE_CMU_0B(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_0B_CFG_VCO_CAL_RESETN_SET(1),\n\t\t SD25G_LANE_CMU_0B_CFG_VCO_CAL_RESETN,\n\t\t priv,\n\t\t SD25G_LANE_CMU_0B(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_19_R_CK_RESETB_SET(0),\n\t\t SD25G_LANE_CMU_19_R_CK_RESETB,\n\t\t priv,\n\t\t SD25G_LANE_CMU_19(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_19_R_CK_RESETB_SET(1),\n\t\t SD25G_LANE_CMU_19_R_CK_RESETB,\n\t\t priv,\n\t\t SD25G_LANE_CMU_19(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_18_R_PLL_RSTN_SET(0),\n\t\t SD25G_LANE_CMU_18_R_PLL_RSTN,\n\t\t priv,\n\t\t SD25G_LANE_CMU_18(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_18_R_PLL_RSTN_SET(1),\n\t\t SD25G_LANE_CMU_18_R_PLL_RSTN,\n\t\t priv,\n\t\t SD25G_LANE_CMU_18(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_1A_R_DWIDTHCTRL_2_0_SET(params->r_d_width_ctrl_2_0),\n\t\t SD25G_LANE_CMU_1A_R_DWIDTHCTRL_2_0,\n\t\t priv,\n\t\t SD25G_LANE_CMU_1A(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_30_R_TXFIFO_CK_DIV_PMAD_2_0_SET\n\t\t (params->r_txfifo_ck_div_pmad_2_0) |\n\t\t SD25G_LANE_CMU_30_R_RXFIFO_CK_DIV_PMAD_2_0_SET\n\t\t (params->r_rxfifo_ck_div_pmad_2_0),\n\t\t SD25G_LANE_CMU_30_R_TXFIFO_CK_DIV_PMAD_2_0 |\n\t\t SD25G_LANE_CMU_30_R_RXFIFO_CK_DIV_PMAD_2_0,\n\t\t priv,\n\t\t SD25G_LANE_CMU_30(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_0C_CFG_PLL_LOL_SET_SET(params->cfg_pll_lol_set) |\n\t\t SD25G_LANE_CMU_0C_CFG_VCO_DIV_MODE_1_0_SET\n\t\t (params->cfg_vco_div_mode_1_0),\n\t\t SD25G_LANE_CMU_0C_CFG_PLL_LOL_SET |\n\t\t SD25G_LANE_CMU_0C_CFG_VCO_DIV_MODE_1_0,\n\t\t priv,\n\t\t SD25G_LANE_CMU_0C(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_0D_CFG_PRE_DIVSEL_1_0_SET\n\t\t (params->cfg_pre_divsel_1_0),\n\t\t SD25G_LANE_CMU_0D_CFG_PRE_DIVSEL_1_0,\n\t\t priv,\n\t\t SD25G_LANE_CMU_0D(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_0E_CFG_SEL_DIV_3_0_SET(params->cfg_sel_div_3_0),\n\t\t SD25G_LANE_CMU_0E_CFG_SEL_DIV_3_0,\n\t\t priv,\n\t\t SD25G_LANE_CMU_0E(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_FF_REGISTER_TABLE_INDEX_SET(0x00),\n\t\t SD25G_LANE_CMU_FF_REGISTER_TABLE_INDEX,\n\t\t priv,\n\t\t SD25G_LANE_CMU_FF(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_0C_LN_CFG_PMA_TX_CK_BITWIDTH_2_0_SET\n\t\t (params->cfg_pma_tx_ck_bitwidth_2_0),\n\t\t SD25G_LANE_LANE_0C_LN_CFG_PMA_TX_CK_BITWIDTH_2_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_0C(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_01_LN_CFG_TX_PREDIV_1_0_SET\n\t\t (params->cfg_tx_prediv_1_0),\n\t\t SD25G_LANE_LANE_01_LN_CFG_TX_PREDIV_1_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_01(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_18_LN_CFG_RXDIV_SEL_2_0_SET\n\t\t (params->cfg_rxdiv_sel_2_0),\n\t\t SD25G_LANE_LANE_18_LN_CFG_RXDIV_SEL_2_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_18(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_2C_LN_CFG_TX_SUBRATE_2_0_SET\n\t\t (params->cfg_tx_subrate_2_0),\n\t\t SD25G_LANE_LANE_2C_LN_CFG_TX_SUBRATE_2_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_2C(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_28_LN_CFG_RX_SUBRATE_2_0_SET\n\t\t (params->cfg_rx_subrate_2_0),\n\t\t SD25G_LANE_LANE_28_LN_CFG_RX_SUBRATE_2_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_28(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_18_LN_CFG_CDRCK_EN_SET(params->cfg_cdrck_en),\n\t\t SD25G_LANE_LANE_18_LN_CFG_CDRCK_EN,\n\t\t priv,\n\t\t SD25G_LANE_LANE_18(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_0F_LN_CFG_DFETAP_EN_5_1_SET\n\t\t (params->cfg_dfetap_en_5_1),\n\t\t SD25G_LANE_LANE_0F_LN_CFG_DFETAP_EN_5_1,\n\t\t priv,\n\t\t SD25G_LANE_LANE_0F(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_18_LN_CFG_ERRAMP_PD_SET(params->cfg_erramp_pd),\n\t\t SD25G_LANE_LANE_18_LN_CFG_ERRAMP_PD,\n\t\t priv,\n\t\t SD25G_LANE_LANE_18(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_1D_LN_CFG_PI_DFE_EN_SET(params->cfg_pi_dfe_en),\n\t\t SD25G_LANE_LANE_1D_LN_CFG_PI_DFE_EN,\n\t\t priv,\n\t\t SD25G_LANE_LANE_1D(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_19_LN_CFG_ECDR_PD_SET(params->cfg_ecdr_pd),\n\t\t SD25G_LANE_LANE_19_LN_CFG_ECDR_PD,\n\t\t priv,\n\t\t SD25G_LANE_LANE_19(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_01_LN_CFG_ITX_IPDRIVER_BASE_2_0_SET\n\t\t (params->cfg_itx_ipdriver_base_2_0),\n\t\t SD25G_LANE_LANE_01_LN_CFG_ITX_IPDRIVER_BASE_2_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_01(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_03_LN_CFG_TAP_DLY_4_0_SET(params->cfg_tap_dly_4_0),\n\t\t SD25G_LANE_LANE_03_LN_CFG_TAP_DLY_4_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_03(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_06_LN_CFG_TAP_ADV_3_0_SET(params->cfg_tap_adv_3_0),\n\t\t SD25G_LANE_LANE_06_LN_CFG_TAP_ADV_3_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_06(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_07_LN_CFG_EN_ADV_SET(params->cfg_en_adv) |\n\t\t SD25G_LANE_LANE_07_LN_CFG_EN_DLY_SET(params->cfg_en_dly),\n\t\t SD25G_LANE_LANE_07_LN_CFG_EN_ADV |\n\t\t SD25G_LANE_LANE_07_LN_CFG_EN_DLY,\n\t\t priv,\n\t\t SD25G_LANE_LANE_07(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_43_LN_CFG_TX_RESERVE_15_8_SET\n\t\t (params->cfg_tx_reserve_15_8),\n\t\t SD25G_LANE_LANE_43_LN_CFG_TX_RESERVE_15_8,\n\t\t priv,\n\t\t SD25G_LANE_LANE_43(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_42_LN_CFG_TX_RESERVE_7_0_SET\n\t\t (params->cfg_tx_reserve_7_0),\n\t\t SD25G_LANE_LANE_42_LN_CFG_TX_RESERVE_7_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_42(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_05_LN_CFG_BW_1_0_SET(params->cfg_bw_1_0),\n\t\t SD25G_LANE_LANE_05_LN_CFG_BW_1_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_05(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_0B_LN_CFG_TXCAL_MAN_EN_SET\n\t\t (params->cfg_txcal_man_en),\n\t\t SD25G_LANE_LANE_0B_LN_CFG_TXCAL_MAN_EN,\n\t\t priv,\n\t\t SD25G_LANE_LANE_0B(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_0A_LN_CFG_TXCAL_SHIFT_CODE_5_0_SET\n\t\t (params->cfg_txcal_shift_code_5_0),\n\t\t SD25G_LANE_LANE_0A_LN_CFG_TXCAL_SHIFT_CODE_5_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_0A(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_09_LN_CFG_TXCAL_VALID_SEL_3_0_SET\n\t\t (params->cfg_txcal_valid_sel_3_0),\n\t\t SD25G_LANE_LANE_09_LN_CFG_TXCAL_VALID_SEL_3_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_09(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_1A_LN_CFG_CDR_KF_2_0_SET(params->cfg_cdr_kf_2_0),\n\t\t SD25G_LANE_LANE_1A_LN_CFG_CDR_KF_2_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_1A(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_1B_LN_CFG_CDR_M_7_0_SET(params->cfg_cdr_m_7_0),\n\t\t SD25G_LANE_LANE_1B_LN_CFG_CDR_M_7_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_1B(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_2B_LN_CFG_PI_BW_3_0_SET(params->cfg_pi_bw_3_0),\n\t\t SD25G_LANE_LANE_2B_LN_CFG_PI_BW_3_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_2B(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_2C_LN_CFG_DIS_2NDORDER_SET\n\t\t (params->cfg_dis_2ndorder),\n\t\t SD25G_LANE_LANE_2C_LN_CFG_DIS_2NDORDER,\n\t\t priv,\n\t\t SD25G_LANE_LANE_2C(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_2E_LN_CFG_CTLE_RSTN_SET(params->cfg_ctle_rstn),\n\t\t SD25G_LANE_LANE_2E_LN_CFG_CTLE_RSTN,\n\t\t priv,\n\t\t SD25G_LANE_LANE_2E(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_00_LN_CFG_ITX_IPCML_BASE_1_0_SET\n\t\t (params->cfg_itx_ipcml_base_1_0),\n\t\t SD25G_LANE_LANE_00_LN_CFG_ITX_IPCML_BASE_1_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_00(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_44_LN_CFG_RX_RESERVE_7_0_SET\n\t\t (params->cfg_rx_reserve_7_0),\n\t\t SD25G_LANE_LANE_44_LN_CFG_RX_RESERVE_7_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_44(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_45_LN_CFG_RX_RESERVE_15_8_SET\n\t\t (params->cfg_rx_reserve_15_8),\n\t\t SD25G_LANE_LANE_45_LN_CFG_RX_RESERVE_15_8,\n\t\t priv,\n\t\t SD25G_LANE_LANE_45(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_0D_LN_CFG_DFECK_EN_SET(params->cfg_dfeck_en) |\n\t\t SD25G_LANE_LANE_0D_LN_CFG_RXTERM_2_0_SET(params->cfg_rxterm_2_0),\n\t\t SD25G_LANE_LANE_0D_LN_CFG_DFECK_EN |\n\t\t SD25G_LANE_LANE_0D_LN_CFG_RXTERM_2_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_0D(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_21_LN_CFG_VGA_CTRL_BYP_4_0_SET\n\t\t (params->cfg_vga_ctrl_byp_4_0),\n\t\t SD25G_LANE_LANE_21_LN_CFG_VGA_CTRL_BYP_4_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_21(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_22_LN_CFG_EQR_FORCE_3_0_SET\n\t\t (params->cfg_eqr_force_3_0),\n\t\t SD25G_LANE_LANE_22_LN_CFG_EQR_FORCE_3_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_22(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_1C_LN_CFG_EQC_FORCE_3_0_SET\n\t\t (params->cfg_eqc_force_3_0) |\n\t\t SD25G_LANE_LANE_1C_LN_CFG_DFE_PD_SET(params->cfg_dfe_pd),\n\t\t SD25G_LANE_LANE_1C_LN_CFG_EQC_FORCE_3_0 |\n\t\t SD25G_LANE_LANE_1C_LN_CFG_DFE_PD,\n\t\t priv,\n\t\t SD25G_LANE_LANE_1C(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_1E_LN_CFG_SUM_SETCM_EN_SET\n\t\t (params->cfg_sum_setcm_en),\n\t\t SD25G_LANE_LANE_1E_LN_CFG_SUM_SETCM_EN,\n\t\t priv,\n\t\t SD25G_LANE_LANE_1E(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_25_LN_CFG_INIT_POS_ISCAN_6_0_SET\n\t\t (params->cfg_init_pos_iscan_6_0),\n\t\t SD25G_LANE_LANE_25_LN_CFG_INIT_POS_ISCAN_6_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_25(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_26_LN_CFG_INIT_POS_IPI_6_0_SET\n\t\t (params->cfg_init_pos_ipi_6_0),\n\t\t SD25G_LANE_LANE_26_LN_CFG_INIT_POS_IPI_6_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_26(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_18_LN_CFG_ERRAMP_PD_SET(params->cfg_erramp_pd),\n\t\t SD25G_LANE_LANE_18_LN_CFG_ERRAMP_PD,\n\t\t priv,\n\t\t SD25G_LANE_LANE_18(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_0E_LN_CFG_DFEDIG_M_2_0_SET\n\t\t (params->cfg_dfedig_m_2_0),\n\t\t SD25G_LANE_LANE_0E_LN_CFG_DFEDIG_M_2_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_0E(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_0E_LN_CFG_EN_DFEDIG_SET(params->cfg_en_dfedig),\n\t\t SD25G_LANE_LANE_0E_LN_CFG_EN_DFEDIG,\n\t\t priv,\n\t\t SD25G_LANE_LANE_0E(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_40_LN_R_TX_POL_INV_SET(params->r_tx_pol_inv) |\n\t\t SD25G_LANE_LANE_40_LN_R_RX_POL_INV_SET(params->r_rx_pol_inv),\n\t\t SD25G_LANE_LANE_40_LN_R_TX_POL_INV |\n\t\t SD25G_LANE_LANE_40_LN_R_RX_POL_INV,\n\t\t priv,\n\t\t SD25G_LANE_LANE_40(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_04_LN_CFG_RX2TX_LP_EN_SET(params->cfg_rx2tx_lp_en) |\n\t\t SD25G_LANE_LANE_04_LN_CFG_TX2RX_LP_EN_SET(params->cfg_tx2rx_lp_en),\n\t\t SD25G_LANE_LANE_04_LN_CFG_RX2TX_LP_EN |\n\t\t SD25G_LANE_LANE_04_LN_CFG_TX2RX_LP_EN,\n\t\t priv,\n\t\t SD25G_LANE_LANE_04(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_1E_LN_CFG_RXLB_EN_SET(params->cfg_rxlb_en),\n\t\t SD25G_LANE_LANE_1E_LN_CFG_RXLB_EN,\n\t\t priv,\n\t\t SD25G_LANE_LANE_1E(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_19_LN_CFG_TXLB_EN_SET(params->cfg_txlb_en),\n\t\t SD25G_LANE_LANE_19_LN_CFG_TXLB_EN,\n\t\t priv,\n\t\t SD25G_LANE_LANE_19(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_2E_LN_CFG_RSTN_DFEDIG_SET(0),\n\t\t SD25G_LANE_LANE_2E_LN_CFG_RSTN_DFEDIG,\n\t\t priv,\n\t\t SD25G_LANE_LANE_2E(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_2E_LN_CFG_RSTN_DFEDIG_SET(1),\n\t\t SD25G_LANE_LANE_2E_LN_CFG_RSTN_DFEDIG,\n\t\t priv,\n\t\t SD25G_LANE_LANE_2E(sd_index));\n\n\tsdx5_rmw(SD_LANE_25G_SD_LANE_CFG_MACRO_RST_SET(0),\n\t\t SD_LANE_25G_SD_LANE_CFG_MACRO_RST,\n\t\t priv,\n\t\t SD_LANE_25G_SD_LANE_CFG(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_1C_LN_CFG_CDR_RSTN_SET(0),\n\t\t SD25G_LANE_LANE_1C_LN_CFG_CDR_RSTN,\n\t\t priv,\n\t\t SD25G_LANE_LANE_1C(sd_index));\n\n\tusleep_range(1000, 2000);\n\n\tsdx5_rmw(SD25G_LANE_LANE_1C_LN_CFG_CDR_RSTN_SET(1),\n\t\t SD25G_LANE_LANE_1C_LN_CFG_CDR_RSTN,\n\t\t priv,\n\t\t SD25G_LANE_LANE_1C(sd_index));\n\n\tusleep_range(10000, 20000);\n\n\tsdx5_rmw(SD25G_LANE_CMU_FF_REGISTER_TABLE_INDEX_SET(0xff),\n\t\t SD25G_LANE_CMU_FF_REGISTER_TABLE_INDEX,\n\t\t priv,\n\t\t SD25G_LANE_CMU_FF(sd_index));\n\n\tvalue = readl(sdx5_addr(regs, SD25G_LANE_CMU_C0(sd_index)));\n\tvalue = SD25G_LANE_CMU_C0_PLL_LOL_UDL_GET(value);\n\n\tif (value) {\n\t\tdev_err(dev, \"25G PLL Loss of Lock: 0x%x\\n\", value);\n\t\treturn -EINVAL;\n\t}\n\n\tvalue = readl(sdx5_addr(regs, SD_LANE_25G_SD_LANE_STAT(sd_index)));\n\tvalue = SD_LANE_25G_SD_LANE_STAT_PMA_RST_DONE_GET(value);\n\n\tif (value != 0x1) {\n\t\tdev_err(dev, \"25G PMA Reset failed: 0x%x\\n\", value);\n\t\treturn -EINVAL;\n\t}\n\tsdx5_rmw(SD25G_LANE_CMU_2A_R_DBG_LOL_STATUS_SET(0x1),\n\t\t SD25G_LANE_CMU_2A_R_DBG_LOL_STATUS,\n\t\t priv,\n\t\t SD25G_LANE_CMU_2A(sd_index));\n\n\tsdx5_rmw(SD_LANE_25G_SD_SER_RST_SER_RST_SET(0x0),\n\t\t SD_LANE_25G_SD_SER_RST_SER_RST,\n\t\t priv,\n\t\t SD_LANE_25G_SD_SER_RST(sd_index));\n\n\tsdx5_rmw(SD_LANE_25G_SD_DES_RST_DES_RST_SET(0x0),\n\t\t SD_LANE_25G_SD_DES_RST_DES_RST,\n\t\t priv,\n\t\t SD_LANE_25G_SD_DES_RST(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_CMU_FF_REGISTER_TABLE_INDEX_SET(0),\n\t\t SD25G_LANE_CMU_FF_REGISTER_TABLE_INDEX,\n\t\t priv,\n\t\t SD25G_LANE_CMU_FF(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_2D_LN_CFG_ALOS_THR_2_0_SET\n\t\t (params->cfg_alos_thr_2_0),\n\t\t SD25G_LANE_LANE_2D_LN_CFG_ALOS_THR_2_0,\n\t\t priv,\n\t\t SD25G_LANE_LANE_2D(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_2E_LN_CFG_DIS_SQ_SET(0),\n\t\t SD25G_LANE_LANE_2E_LN_CFG_DIS_SQ,\n\t\t priv,\n\t\t SD25G_LANE_LANE_2E(sd_index));\n\n\tsdx5_rmw(SD25G_LANE_LANE_2E_LN_CFG_PD_SQ_SET(0),\n\t\t SD25G_LANE_LANE_2E_LN_CFG_PD_SQ,\n\t\t priv,\n\t\t SD25G_LANE_LANE_2E(sd_index));\n\n\treturn 0;\n}\n\nstatic void sparx5_sd10g28_reset(void __iomem *regs[], u32 lane_index)\n{\n\t \n\tsdx5_rmw_addr(SD_LANE_SD_LANE_CFG_EXT_CFG_RST_SET(1),\n\t\t      SD_LANE_SD_LANE_CFG_EXT_CFG_RST,\n\t\t      sdx5_addr(regs, SD_LANE_SD_LANE_CFG(lane_index)));\n\n\tusleep_range(1000, 2000);\n\n\tsdx5_rmw_addr(SD_LANE_SD_LANE_CFG_EXT_CFG_RST_SET(0),\n\t\t      SD_LANE_SD_LANE_CFG_EXT_CFG_RST,\n\t\t      sdx5_addr(regs, SD_LANE_SD_LANE_CFG(lane_index)));\n}\n\nstatic int sparx5_sd10g28_apply_params(struct sparx5_serdes_macro *macro,\n\t\t\t\t       struct sparx5_sd10g28_params *params)\n{\n\tstruct sparx5_serdes_private *priv = macro->priv;\n\tvoid __iomem **regs = priv->regs;\n\tstruct device *dev = priv->dev;\n\tu32 lane_index = macro->sidx;\n\tu32 sd_index = macro->stpidx;\n\tvoid __iomem *sd_inst;\n\tu32 value, cmu_idx;\n\tint err;\n\n\t \n\tif (params->skip_cmu_cfg)\n\t\treturn 0;\n\n\tcmu_idx = sparx5_serdes_cmu_get(params->cmu_sel, lane_index);\n\terr = sparx5_cmu_cfg(priv, cmu_idx);\n\tif (err)\n\t\treturn err;\n\n\tif (params->is_6g)\n\t\tsd_inst = sdx5_inst_get(priv, TARGET_SD6G_LANE, sd_index);\n\telse\n\t\tsd_inst = sdx5_inst_get(priv, TARGET_SD10G_LANE, sd_index);\n\n\tsdx5_rmw(SD_LANE_SD_LANE_CFG_MACRO_RST_SET(1),\n\t\t SD_LANE_SD_LANE_CFG_MACRO_RST,\n\t\t priv,\n\t\t SD_LANE_SD_LANE_CFG(lane_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_93_R_DWIDTHCTRL_FROM_HWT_SET(0x0) |\n\t\t      SD10G_LANE_LANE_93_R_REG_MANUAL_SET(0x1) |\n\t\t      SD10G_LANE_LANE_93_R_AUXCKSEL_FROM_HWT_SET(0x1) |\n\t\t      SD10G_LANE_LANE_93_R_LANE_ID_FROM_HWT_SET(0x1) |\n\t\t      SD10G_LANE_LANE_93_R_EN_RATECHG_CTRL_SET(0x0),\n\t\t      SD10G_LANE_LANE_93_R_DWIDTHCTRL_FROM_HWT |\n\t\t      SD10G_LANE_LANE_93_R_REG_MANUAL |\n\t\t      SD10G_LANE_LANE_93_R_AUXCKSEL_FROM_HWT |\n\t\t      SD10G_LANE_LANE_93_R_LANE_ID_FROM_HWT |\n\t\t      SD10G_LANE_LANE_93_R_EN_RATECHG_CTRL,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_93(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_94_R_ISCAN_REG_SET(0x1) |\n\t\t      SD10G_LANE_LANE_94_R_TXEQ_REG_SET(0x1) |\n\t\t      SD10G_LANE_LANE_94_R_MISC_REG_SET(0x1) |\n\t\t      SD10G_LANE_LANE_94_R_SWING_REG_SET(0x1),\n\t\t      SD10G_LANE_LANE_94_R_ISCAN_REG |\n\t\t      SD10G_LANE_LANE_94_R_TXEQ_REG |\n\t\t      SD10G_LANE_LANE_94_R_MISC_REG |\n\t\t      SD10G_LANE_LANE_94_R_SWING_REG,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_94(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_9E_R_RXEQ_REG_SET(0x1),\n\t\t      SD10G_LANE_LANE_9E_R_RXEQ_REG,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_9E(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_A1_R_SSC_FROM_HWT_SET(0x0) |\n\t\t      SD10G_LANE_LANE_A1_R_CDR_FROM_HWT_SET(0x0) |\n\t\t      SD10G_LANE_LANE_A1_R_PCLK_GATING_FROM_HWT_SET(0x1),\n\t\t      SD10G_LANE_LANE_A1_R_SSC_FROM_HWT |\n\t\t      SD10G_LANE_LANE_A1_R_CDR_FROM_HWT |\n\t\t      SD10G_LANE_LANE_A1_R_PCLK_GATING_FROM_HWT,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_A1(sd_index));\n\n\tsdx5_rmw(SD_LANE_SD_LANE_CFG_RX_REF_SEL_SET(params->cmu_sel) |\n\t\t SD_LANE_SD_LANE_CFG_TX_REF_SEL_SET(params->cmu_sel),\n\t\t SD_LANE_SD_LANE_CFG_RX_REF_SEL |\n\t\t SD_LANE_SD_LANE_CFG_TX_REF_SEL,\n\t\t priv,\n\t\t SD_LANE_SD_LANE_CFG(lane_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_40_CFG_LANE_RESERVE_7_0_SET\n\t\t      (params->cfg_lane_reserve_7_0),\n\t\t      SD10G_LANE_LANE_40_CFG_LANE_RESERVE_7_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_40(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_50_CFG_SSC_RTL_CLK_SEL_SET\n\t\t      (params->cfg_ssc_rtl_clk_sel),\n\t\t      SD10G_LANE_LANE_50_CFG_SSC_RTL_CLK_SEL,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_50(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_35_CFG_TXRATE_1_0_SET\n\t\t      (params->cfg_txrate_1_0) |\n\t\t      SD10G_LANE_LANE_35_CFG_RXRATE_1_0_SET\n\t\t      (params->cfg_rxrate_1_0),\n\t\t      SD10G_LANE_LANE_35_CFG_TXRATE_1_0 |\n\t\t      SD10G_LANE_LANE_35_CFG_RXRATE_1_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_35(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_94_R_DWIDTHCTRL_2_0_SET\n\t\t      (params->r_d_width_ctrl_2_0),\n\t\t      SD10G_LANE_LANE_94_R_DWIDTHCTRL_2_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_94(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_01_CFG_PMA_TX_CK_BITWIDTH_2_0_SET\n\t\t      (params->cfg_pma_tx_ck_bitwidth_2_0),\n\t\t      SD10G_LANE_LANE_01_CFG_PMA_TX_CK_BITWIDTH_2_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_01(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_30_CFG_RXDIV_SEL_2_0_SET\n\t\t      (params->cfg_rxdiv_sel_2_0),\n\t\t      SD10G_LANE_LANE_30_CFG_RXDIV_SEL_2_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_30(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_A2_R_PCS2PMA_PHYMODE_4_0_SET\n\t\t      (params->r_pcs2pma_phymode_4_0),\n\t\t      SD10G_LANE_LANE_A2_R_PCS2PMA_PHYMODE_4_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_A2(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_13_CFG_CDRCK_EN_SET(params->cfg_cdrck_en),\n\t\t      SD10G_LANE_LANE_13_CFG_CDRCK_EN,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_13(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_23_CFG_DFECK_EN_SET\n\t\t      (params->cfg_dfeck_en) |\n\t\t      SD10G_LANE_LANE_23_CFG_DFE_PD_SET(params->cfg_dfe_pd) |\n\t\t      SD10G_LANE_LANE_23_CFG_ERRAMP_PD_SET\n\t\t      (params->cfg_erramp_pd),\n\t\t      SD10G_LANE_LANE_23_CFG_DFECK_EN |\n\t\t      SD10G_LANE_LANE_23_CFG_DFE_PD |\n\t\t      SD10G_LANE_LANE_23_CFG_ERRAMP_PD,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_23(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_22_CFG_DFETAP_EN_5_1_SET\n\t\t      (params->cfg_dfetap_en_5_1),\n\t\t      SD10G_LANE_LANE_22_CFG_DFETAP_EN_5_1,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_22(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_1A_CFG_PI_DFE_EN_SET\n\t\t      (params->cfg_pi_DFE_en),\n\t\t      SD10G_LANE_LANE_1A_CFG_PI_DFE_EN,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_1A(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_02_CFG_EN_ADV_SET(params->cfg_en_adv) |\n\t\t      SD10G_LANE_LANE_02_CFG_EN_MAIN_SET(params->cfg_en_main) |\n\t\t      SD10G_LANE_LANE_02_CFG_EN_DLY_SET(params->cfg_en_dly) |\n\t\t      SD10G_LANE_LANE_02_CFG_TAP_ADV_3_0_SET\n\t\t      (params->cfg_tap_adv_3_0),\n\t\t      SD10G_LANE_LANE_02_CFG_EN_ADV |\n\t\t      SD10G_LANE_LANE_02_CFG_EN_MAIN |\n\t\t      SD10G_LANE_LANE_02_CFG_EN_DLY |\n\t\t      SD10G_LANE_LANE_02_CFG_TAP_ADV_3_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_02(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_03_CFG_TAP_MAIN_SET(params->cfg_tap_main),\n\t\t      SD10G_LANE_LANE_03_CFG_TAP_MAIN,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_03(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_04_CFG_TAP_DLY_4_0_SET\n\t\t      (params->cfg_tap_dly_4_0),\n\t\t      SD10G_LANE_LANE_04_CFG_TAP_DLY_4_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_04(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_2F_CFG_VGA_CTRL_3_0_SET\n\t\t      (params->cfg_vga_ctrl_3_0),\n\t\t      SD10G_LANE_LANE_2F_CFG_VGA_CTRL_3_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_2F(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_2F_CFG_VGA_CP_2_0_SET\n\t\t      (params->cfg_vga_cp_2_0),\n\t\t      SD10G_LANE_LANE_2F_CFG_VGA_CP_2_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_2F(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_0B_CFG_EQ_RES_3_0_SET\n\t\t      (params->cfg_eq_res_3_0),\n\t\t      SD10G_LANE_LANE_0B_CFG_EQ_RES_3_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_0B(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_0D_CFG_EQR_BYP_SET(params->cfg_eq_r_byp),\n\t\t      SD10G_LANE_LANE_0D_CFG_EQR_BYP,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_0D(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_0E_CFG_EQC_FORCE_3_0_SET\n\t\t      (params->cfg_eq_c_force_3_0) |\n\t\t      SD10G_LANE_LANE_0E_CFG_SUM_SETCM_EN_SET\n\t\t      (params->cfg_sum_setcm_en),\n\t\t      SD10G_LANE_LANE_0E_CFG_EQC_FORCE_3_0 |\n\t\t      SD10G_LANE_LANE_0E_CFG_SUM_SETCM_EN,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_0E(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_23_CFG_EN_DFEDIG_SET\n\t\t      (params->cfg_en_dfedig),\n\t\t      SD10G_LANE_LANE_23_CFG_EN_DFEDIG,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_23(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_06_CFG_EN_PREEMPH_SET\n\t\t      (params->cfg_en_preemph),\n\t\t      SD10G_LANE_LANE_06_CFG_EN_PREEMPH,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_06(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_33_CFG_ITX_IPPREEMP_BASE_1_0_SET\n\t\t      (params->cfg_itx_ippreemp_base_1_0) |\n\t\t      SD10G_LANE_LANE_33_CFG_ITX_IPDRIVER_BASE_2_0_SET\n\t\t      (params->cfg_itx_ipdriver_base_2_0),\n\t\t      SD10G_LANE_LANE_33_CFG_ITX_IPPREEMP_BASE_1_0 |\n\t\t      SD10G_LANE_LANE_33_CFG_ITX_IPDRIVER_BASE_2_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_33(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_52_CFG_IBIAS_TUNE_RESERVE_5_0_SET\n\t\t      (params->cfg_ibias_tune_reserve_5_0),\n\t\t      SD10G_LANE_LANE_52_CFG_IBIAS_TUNE_RESERVE_5_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_52(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_37_CFG_TXSWING_HALF_SET\n\t\t      (params->cfg_txswing_half),\n\t\t      SD10G_LANE_LANE_37_CFG_TXSWING_HALF,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_37(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_3C_CFG_DIS_2NDORDER_SET\n\t\t      (params->cfg_dis_2nd_order),\n\t\t      SD10G_LANE_LANE_3C_CFG_DIS_2NDORDER,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_3C(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_39_CFG_RX_SSC_LH_SET\n\t\t      (params->cfg_rx_ssc_lh),\n\t\t      SD10G_LANE_LANE_39_CFG_RX_SSC_LH,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_39(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_1A_CFG_PI_FLOOP_STEPS_1_0_SET\n\t\t      (params->cfg_pi_floop_steps_1_0),\n\t\t      SD10G_LANE_LANE_1A_CFG_PI_FLOOP_STEPS_1_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_1A(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_16_CFG_PI_EXT_DAC_23_16_SET\n\t\t      (params->cfg_pi_ext_dac_23_16),\n\t\t      SD10G_LANE_LANE_16_CFG_PI_EXT_DAC_23_16,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_16(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_15_CFG_PI_EXT_DAC_15_8_SET\n\t\t      (params->cfg_pi_ext_dac_15_8),\n\t\t      SD10G_LANE_LANE_15_CFG_PI_EXT_DAC_15_8,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_15(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_26_CFG_ISCAN_EXT_DAC_7_0_SET\n\t\t      (params->cfg_iscan_ext_dac_7_0),\n\t\t      SD10G_LANE_LANE_26_CFG_ISCAN_EXT_DAC_7_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_26(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_42_CFG_CDR_KF_GEN1_2_0_SET\n\t\t      (params->cfg_cdr_kf_gen1_2_0),\n\t\t      SD10G_LANE_LANE_42_CFG_CDR_KF_GEN1_2_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_42(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_0F_R_CDR_M_GEN1_7_0_SET\n\t\t      (params->r_cdr_m_gen1_7_0),\n\t\t      SD10G_LANE_LANE_0F_R_CDR_M_GEN1_7_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_0F(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_24_CFG_PI_BW_GEN1_3_0_SET\n\t\t      (params->cfg_pi_bw_gen1_3_0),\n\t\t      SD10G_LANE_LANE_24_CFG_PI_BW_GEN1_3_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_24(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_14_CFG_PI_EXT_DAC_7_0_SET\n\t\t      (params->cfg_pi_ext_dac_7_0),\n\t\t      SD10G_LANE_LANE_14_CFG_PI_EXT_DAC_7_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_14(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_1A_CFG_PI_STEPS_SET(params->cfg_pi_steps),\n\t\t      SD10G_LANE_LANE_1A_CFG_PI_STEPS,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_1A(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_3A_CFG_MP_MAX_3_0_SET\n\t\t      (params->cfg_mp_max_3_0),\n\t\t      SD10G_LANE_LANE_3A_CFG_MP_MAX_3_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_3A(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_31_CFG_RSTN_DFEDIG_SET\n\t\t      (params->cfg_rstn_dfedig),\n\t\t      SD10G_LANE_LANE_31_CFG_RSTN_DFEDIG,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_31(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_48_CFG_ALOS_THR_3_0_SET\n\t\t      (params->cfg_alos_thr_3_0),\n\t\t      SD10G_LANE_LANE_48_CFG_ALOS_THR_3_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_48(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_36_CFG_PREDRV_SLEWRATE_1_0_SET\n\t\t      (params->cfg_predrv_slewrate_1_0),\n\t\t      SD10G_LANE_LANE_36_CFG_PREDRV_SLEWRATE_1_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_36(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_32_CFG_ITX_IPCML_BASE_1_0_SET\n\t\t      (params->cfg_itx_ipcml_base_1_0),\n\t\t      SD10G_LANE_LANE_32_CFG_ITX_IPCML_BASE_1_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_32(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_37_CFG_IP_PRE_BASE_1_0_SET\n\t\t      (params->cfg_ip_pre_base_1_0),\n\t\t      SD10G_LANE_LANE_37_CFG_IP_PRE_BASE_1_0,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_37(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_41_CFG_LANE_RESERVE_15_8_SET\n\t\t      (params->cfg_lane_reserve_15_8),\n\t\t      SD10G_LANE_LANE_41_CFG_LANE_RESERVE_15_8,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_41(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_9E_R_EN_AUTO_CDR_RSTN_SET\n\t\t      (params->r_en_auto_cdr_rstn),\n\t\t      SD10G_LANE_LANE_9E_R_EN_AUTO_CDR_RSTN,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_9E(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_0C_CFG_OSCAL_AFE_SET\n\t\t      (params->cfg_oscal_afe) |\n\t\t      SD10G_LANE_LANE_0C_CFG_PD_OSDAC_AFE_SET\n\t\t      (params->cfg_pd_osdac_afe),\n\t\t      SD10G_LANE_LANE_0C_CFG_OSCAL_AFE |\n\t\t      SD10G_LANE_LANE_0C_CFG_PD_OSDAC_AFE,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_0C(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_0B_CFG_RESETB_OSCAL_AFE_SET\n\t\t      (params->cfg_resetb_oscal_afe[0]),\n\t\t      SD10G_LANE_LANE_0B_CFG_RESETB_OSCAL_AFE,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_0B(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_0B_CFG_RESETB_OSCAL_AFE_SET\n\t\t      (params->cfg_resetb_oscal_afe[1]),\n\t\t      SD10G_LANE_LANE_0B_CFG_RESETB_OSCAL_AFE,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_0B(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_83_R_TX_POL_INV_SET\n\t\t      (params->r_tx_pol_inv) |\n\t\t      SD10G_LANE_LANE_83_R_RX_POL_INV_SET\n\t\t      (params->r_rx_pol_inv),\n\t\t      SD10G_LANE_LANE_83_R_TX_POL_INV |\n\t\t      SD10G_LANE_LANE_83_R_RX_POL_INV,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_83(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_06_CFG_RX2TX_LP_EN_SET\n\t\t      (params->cfg_rx2tx_lp_en) |\n\t\t      SD10G_LANE_LANE_06_CFG_TX2RX_LP_EN_SET\n\t\t      (params->cfg_tx2rx_lp_en),\n\t\t      SD10G_LANE_LANE_06_CFG_RX2TX_LP_EN |\n\t\t      SD10G_LANE_LANE_06_CFG_TX2RX_LP_EN,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_06(sd_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_0E_CFG_RXLB_EN_SET(params->cfg_rxlb_en) |\n\t\t      SD10G_LANE_LANE_0E_CFG_TXLB_EN_SET(params->cfg_txlb_en),\n\t\t      SD10G_LANE_LANE_0E_CFG_RXLB_EN |\n\t\t      SD10G_LANE_LANE_0E_CFG_TXLB_EN,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_0E(sd_index));\n\n\tsdx5_rmw(SD_LANE_SD_LANE_CFG_MACRO_RST_SET(0),\n\t\t SD_LANE_SD_LANE_CFG_MACRO_RST,\n\t\t priv,\n\t\t SD_LANE_SD_LANE_CFG(lane_index));\n\n\tsdx5_inst_rmw(SD10G_LANE_LANE_50_CFG_SSC_RESETB_SET(1),\n\t\t      SD10G_LANE_LANE_50_CFG_SSC_RESETB,\n\t\t      sd_inst,\n\t\t      SD10G_LANE_LANE_50(sd_index));\n\n\tsdx5_rmw(SD10G_LANE_LANE_50_CFG_SSC_RESETB_SET(1),\n\t\t SD10G_LANE_LANE_50_CFG_SSC_RESETB,\n\t\t priv,\n\t\t SD10G_LANE_LANE_50(sd_index));\n\n\tsdx5_rmw(SD_LANE_MISC_SD_125_RST_DIS_SET(params->fx_100),\n\t\t SD_LANE_MISC_SD_125_RST_DIS,\n\t\t priv,\n\t\t SD_LANE_MISC(lane_index));\n\n\tsdx5_rmw(SD_LANE_MISC_RX_ENA_SET(params->fx_100),\n\t\t SD_LANE_MISC_RX_ENA,\n\t\t priv,\n\t\t SD_LANE_MISC(lane_index));\n\n\tsdx5_rmw(SD_LANE_MISC_MUX_ENA_SET(params->fx_100),\n\t\t SD_LANE_MISC_MUX_ENA,\n\t\t priv,\n\t\t SD_LANE_MISC(lane_index));\n\n\tusleep_range(3000, 6000);\n\n\tvalue = readl(sdx5_addr(regs, SD_LANE_SD_LANE_STAT(lane_index)));\n\tvalue = SD_LANE_SD_LANE_STAT_PMA_RST_DONE_GET(value);\n\tif (value != 1) {\n\t\tdev_err(dev, \"10G PMA Reset failed: 0x%x\\n\", value);\n\t\treturn -EINVAL;\n\t}\n\n\tsdx5_rmw(SD_LANE_SD_SER_RST_SER_RST_SET(0x0),\n\t\t SD_LANE_SD_SER_RST_SER_RST,\n\t\t priv,\n\t\t SD_LANE_SD_SER_RST(lane_index));\n\n\tsdx5_rmw(SD_LANE_SD_DES_RST_DES_RST_SET(0x0),\n\t\t SD_LANE_SD_DES_RST_DES_RST,\n\t\t priv,\n\t\t SD_LANE_SD_DES_RST(lane_index));\n\n\treturn 0;\n}\n\nstatic int sparx5_sd25g28_config(struct sparx5_serdes_macro *macro, bool reset)\n{\n\tstruct sparx5_sd25g28_media_preset media = media_presets_25g[macro->media];\n\tstruct sparx5_sd25g28_mode_preset mode;\n\tstruct sparx5_sd25g28_args args = {\n\t\t.rxinvert = 1,\n\t\t.txinvert = 0,\n\t\t.txswing = 240,\n\t\t.com_pll_reserve = 0xf,\n\t\t.reg_rst = reset,\n\t};\n\tstruct sparx5_sd25g28_params params;\n\tint err;\n\n\terr = sparx5_sd10g25_get_mode_preset(macro, &mode);\n\tif (err)\n\t\treturn err;\n\tsparx5_sd25g28_get_params(macro, &media, &mode, &args, &params);\n\tsparx5_sd25g28_reset(macro->priv->regs, &params, macro->stpidx);\n\treturn sparx5_sd25g28_apply_params(macro, &params);\n}\n\nstatic int sparx5_sd10g28_config(struct sparx5_serdes_macro *macro, bool reset)\n{\n\tstruct sparx5_sd10g28_media_preset media = media_presets_10g[macro->media];\n\tstruct sparx5_sd10g28_mode_preset mode;\n\tstruct sparx5_sd10g28_params params;\n\tstruct sparx5_sd10g28_args args = {\n\t\t.is_6g = (macro->serdestype == SPX5_SDT_6G),\n\t\t.txinvert = 0,\n\t\t.rxinvert = 1,\n\t\t.txswing = 240,\n\t\t.reg_rst = reset,\n\t\t.skip_cmu_cfg = reset,\n\t};\n\tint err;\n\n\terr = sparx5_sd10g28_get_mode_preset(macro, &mode, &args);\n\tif (err)\n\t\treturn err;\n\tsparx5_sd10g28_get_params(macro, &media, &mode, &args, &params);\n\tsparx5_sd10g28_reset(macro->priv->regs, macro->sidx);\n\treturn sparx5_sd10g28_apply_params(macro, &params);\n}\n\n \nstatic int sparx5_serdes_power_save(struct sparx5_serdes_macro *macro, u32 pwdn)\n{\n\tstruct sparx5_serdes_private *priv = macro->priv;\n\tvoid __iomem *sd_inst, *sd_lane_inst;\n\n\tif (macro->serdestype == SPX5_SDT_6G)\n\t\tsd_inst = sdx5_inst_get(priv, TARGET_SD6G_LANE, macro->stpidx);\n\telse if (macro->serdestype == SPX5_SDT_10G)\n\t\tsd_inst = sdx5_inst_get(priv, TARGET_SD10G_LANE, macro->stpidx);\n\telse\n\t\tsd_inst = sdx5_inst_get(priv, TARGET_SD25G_LANE, macro->stpidx);\n\n\tif (macro->serdestype == SPX5_SDT_25G) {\n\t\tsd_lane_inst = sdx5_inst_get(priv, TARGET_SD_LANE_25G,\n\t\t\t\t\t     macro->stpidx);\n\t\t \n\t\tsdx5_inst_rmw(SD_LANE_25G_SD_LANE_CFG_EXT_CFG_RST_SET(0),\n\t\t\t      SD_LANE_25G_SD_LANE_CFG_EXT_CFG_RST, sd_lane_inst,\n\t\t\t      SD_LANE_25G_SD_LANE_CFG(0));\n\n\t\t \n\t\tsdx5_inst_rmw(SD_LANE_25G_QUIET_MODE_6G_QUIET_MODE_SET(SPX5_SERDES_QUIET_MODE_VAL),\n\t\t\t      SD_LANE_25G_QUIET_MODE_6G_QUIET_MODE,\n\t\t\t      sd_lane_inst, SD_LANE_25G_QUIET_MODE_6G(0));\n\n\t\tsdx5_inst_rmw(SD25G_LANE_LANE_04_LN_CFG_PD_DRIVER_SET(pwdn),\n\t\t\t      SD25G_LANE_LANE_04_LN_CFG_PD_DRIVER,\n\t\t\t      sd_inst,\n\t\t\t      SD25G_LANE_LANE_04(0));\n\t} else {\n\t\t \n\t\tsd_lane_inst = sdx5_inst_get(priv, TARGET_SD_LANE, macro->sidx);\n\n\t\t \n\t\tsdx5_inst_rmw(SD_LANE_SD_LANE_CFG_EXT_CFG_RST_SET(0),\n\t\t\t      SD_LANE_SD_LANE_CFG_EXT_CFG_RST, sd_lane_inst,\n\t\t\t      SD_LANE_SD_LANE_CFG(0));\n\n\t\t \n\t\tsdx5_inst_rmw(SD_LANE_QUIET_MODE_6G_QUIET_MODE_SET(SPX5_SERDES_QUIET_MODE_VAL),\n\t\t\t      SD_LANE_QUIET_MODE_6G_QUIET_MODE, sd_lane_inst,\n\t\t\t      SD_LANE_QUIET_MODE_6G(0));\n\n\t\tsdx5_inst_rmw(SD10G_LANE_LANE_06_CFG_PD_DRIVER_SET(pwdn),\n\t\t\t      SD10G_LANE_LANE_06_CFG_PD_DRIVER,\n\t\t\t      sd_inst,\n\t\t\t      SD10G_LANE_LANE_06(0));\n\t}\n\treturn 0;\n}\n\nstatic int sparx5_serdes_clock_config(struct sparx5_serdes_macro *macro)\n{\n\tstruct sparx5_serdes_private *priv = macro->priv;\n\n\tif (macro->serdesmode == SPX5_SD_MODE_100FX) {\n\t\tu32 freq = priv->coreclock == 250000000 ? 2 :\n\t\t\tpriv->coreclock == 500000000 ? 1 : 0;\n\n\t\tsdx5_rmw(SD_LANE_MISC_CORE_CLK_FREQ_SET(freq),\n\t\t\t SD_LANE_MISC_CORE_CLK_FREQ,\n\t\t\t priv,\n\t\t\t SD_LANE_MISC(macro->sidx));\n\t}\n\treturn 0;\n}\n\nstatic int sparx5_serdes_get_serdesmode(phy_interface_t portmode, int speed)\n{\n\tswitch (portmode) {\n\tcase PHY_INTERFACE_MODE_1000BASEX:\n\tcase PHY_INTERFACE_MODE_2500BASEX:\n\t\tif (speed == SPEED_2500)\n\t\t\treturn SPX5_SD_MODE_2G5;\n\t\tif (speed == SPEED_100)\n\t\t\treturn SPX5_SD_MODE_100FX;\n\t\treturn SPX5_SD_MODE_1000BASEX;\n\tcase PHY_INTERFACE_MODE_SGMII:\n\t\t \n\t\treturn SPX5_SD_MODE_1000BASEX;\n\tcase PHY_INTERFACE_MODE_QSGMII:\n\t\treturn SPX5_SD_MODE_QSGMII;\n\tcase PHY_INTERFACE_MODE_10GBASER:\n\t\treturn SPX5_SD_MODE_SFI;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int sparx5_serdes_config(struct sparx5_serdes_macro *macro)\n{\n\tstruct device *dev = macro->priv->dev;\n\tint serdesmode;\n\tint err;\n\n\tserdesmode = sparx5_serdes_get_serdesmode(macro->portmode, macro->speed);\n\tif (serdesmode < 0) {\n\t\tdev_err(dev, \"SerDes %u, interface not supported: %s\\n\",\n\t\t\tmacro->sidx,\n\t\t\tphy_modes(macro->portmode));\n\t\treturn serdesmode;\n\t}\n\tmacro->serdesmode = serdesmode;\n\n\tsparx5_serdes_clock_config(macro);\n\n\tif (macro->serdestype == SPX5_SDT_25G)\n\t\terr = sparx5_sd25g28_config(macro, false);\n\telse\n\t\terr = sparx5_sd10g28_config(macro, false);\n\tif (err) {\n\t\tdev_err(dev, \"SerDes %u, config error: %d\\n\",\n\t\t\tmacro->sidx, err);\n\t}\n\treturn err;\n}\n\nstatic int sparx5_serdes_power_on(struct phy *phy)\n{\n\tstruct sparx5_serdes_macro *macro = phy_get_drvdata(phy);\n\n\treturn sparx5_serdes_power_save(macro, false);\n}\n\nstatic int sparx5_serdes_power_off(struct phy *phy)\n{\n\tstruct sparx5_serdes_macro *macro = phy_get_drvdata(phy);\n\n\treturn sparx5_serdes_power_save(macro, true);\n}\n\nstatic int sparx5_serdes_set_mode(struct phy *phy, enum phy_mode mode, int submode)\n{\n\tstruct sparx5_serdes_macro *macro;\n\n\tif (mode != PHY_MODE_ETHERNET)\n\t\treturn -EINVAL;\n\n\tswitch (submode) {\n\tcase PHY_INTERFACE_MODE_1000BASEX:\n\tcase PHY_INTERFACE_MODE_2500BASEX:\n\tcase PHY_INTERFACE_MODE_SGMII:\n\tcase PHY_INTERFACE_MODE_QSGMII:\n\tcase PHY_INTERFACE_MODE_10GBASER:\n\t\tmacro = phy_get_drvdata(phy);\n\t\tmacro->portmode = submode;\n\t\tsparx5_serdes_config(macro);\n\t\treturn 0;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int sparx5_serdes_set_media(struct phy *phy, enum phy_media media)\n{\n\tstruct sparx5_serdes_macro *macro = phy_get_drvdata(phy);\n\n\tif (media != macro->media) {\n\t\tmacro->media = media;\n\t\tif (macro->serdesmode != SPX5_SD_MODE_NONE)\n\t\t\tsparx5_serdes_config(macro);\n\t}\n\treturn 0;\n}\n\nstatic int sparx5_serdes_set_speed(struct phy *phy, int speed)\n{\n\tstruct sparx5_serdes_macro *macro = phy_get_drvdata(phy);\n\n\tif (macro->sidx < SPX5_SERDES_10G_START && speed > SPEED_5000)\n\t\treturn -EINVAL;\n\tif (macro->sidx < SPX5_SERDES_25G_START && speed > SPEED_10000)\n\t\treturn -EINVAL;\n\tif (speed != macro->speed) {\n\t\tmacro->speed = speed;\n\t\tif (macro->serdesmode != SPX5_SD_MODE_NONE)\n\t\t\tsparx5_serdes_config(macro);\n\t}\n\treturn 0;\n}\n\nstatic int sparx5_serdes_reset(struct phy *phy)\n{\n\tstruct sparx5_serdes_macro *macro = phy_get_drvdata(phy);\n\tint err;\n\n\tif (macro->serdestype == SPX5_SDT_25G)\n\t\terr = sparx5_sd25g28_config(macro, true);\n\telse\n\t\terr = sparx5_sd10g28_config(macro, true);\n\tif (err) {\n\t\tdev_err(&phy->dev, \"SerDes %u, reset error: %d\\n\",\n\t\t\tmacro->sidx, err);\n\t}\n\treturn err;\n}\n\nstatic int sparx5_serdes_validate(struct phy *phy, enum phy_mode mode,\n\t\t\t\t\tint submode,\n\t\t\t\t\tunion phy_configure_opts *opts)\n{\n\tstruct sparx5_serdes_macro *macro = phy_get_drvdata(phy);\n\n\tif (mode != PHY_MODE_ETHERNET)\n\t\treturn -EINVAL;\n\n\tif (macro->speed == 0)\n\t\treturn -EINVAL;\n\n\tif (macro->sidx < SPX5_SERDES_10G_START && macro->speed > SPEED_5000)\n\t\treturn -EINVAL;\n\tif (macro->sidx < SPX5_SERDES_25G_START && macro->speed > SPEED_10000)\n\t\treturn -EINVAL;\n\n\tswitch (submode) {\n\tcase PHY_INTERFACE_MODE_1000BASEX:\n\t\tif (macro->speed != SPEED_100 &&  \n\t\t    macro->speed != SPEED_1000)\n\t\t\treturn -EINVAL;\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_SGMII:\n\tcase PHY_INTERFACE_MODE_2500BASEX:\n\tcase PHY_INTERFACE_MODE_QSGMII:\n\t\tif (macro->speed >= SPEED_5000)\n\t\t\treturn -EINVAL;\n\t\tbreak;\n\tcase PHY_INTERFACE_MODE_10GBASER:\n\t\tif (macro->speed < SPEED_5000)\n\t\t\treturn -EINVAL;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic const struct phy_ops sparx5_serdes_ops = {\n\t.power_on\t= sparx5_serdes_power_on,\n\t.power_off\t= sparx5_serdes_power_off,\n\t.set_mode\t= sparx5_serdes_set_mode,\n\t.set_media\t= sparx5_serdes_set_media,\n\t.set_speed\t= sparx5_serdes_set_speed,\n\t.reset\t\t= sparx5_serdes_reset,\n\t.validate\t= sparx5_serdes_validate,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int sparx5_phy_create(struct sparx5_serdes_private *priv,\n\t\t\t   int idx, struct phy **phy)\n{\n\tstruct sparx5_serdes_macro *macro;\n\n\t*phy = devm_phy_create(priv->dev, NULL, &sparx5_serdes_ops);\n\tif (IS_ERR(*phy))\n\t\treturn PTR_ERR(*phy);\n\n\tmacro = devm_kzalloc(priv->dev, sizeof(*macro), GFP_KERNEL);\n\tif (!macro)\n\t\treturn -ENOMEM;\n\n\tmacro->sidx = idx;\n\tmacro->priv = priv;\n\tmacro->speed = SPEED_UNKNOWN;\n\tif (idx < SPX5_SERDES_10G_START) {\n\t\tmacro->serdestype = SPX5_SDT_6G;\n\t\tmacro->stpidx = macro->sidx;\n\t} else if (idx < SPX5_SERDES_25G_START) {\n\t\tmacro->serdestype = SPX5_SDT_10G;\n\t\tmacro->stpidx = macro->sidx - SPX5_SERDES_10G_START;\n\t} else {\n\t\tmacro->serdestype = SPX5_SDT_25G;\n\t\tmacro->stpidx = macro->sidx - SPX5_SERDES_25G_START;\n\t}\n\n\tphy_set_drvdata(*phy, macro);\n\n\t \n\tsparx5_serdes_power_off(*phy);\n\n\treturn 0;\n}\n\nstatic struct sparx5_serdes_io_resource sparx5_serdes_iomap[] =  {\n\t{ TARGET_SD_CMU,          0x0 },       \n\t{ TARGET_SD_CMU + 1,      0x8000 },    \n\t{ TARGET_SD_CMU + 2,      0x10000 },   \n\t{ TARGET_SD_CMU + 3,      0x18000 },   \n\t{ TARGET_SD_CMU + 4,      0x20000 },   \n\t{ TARGET_SD_CMU + 5,      0x28000 },   \n\t{ TARGET_SD_CMU + 6,      0x30000 },   \n\t{ TARGET_SD_CMU + 7,      0x38000 },   \n\t{ TARGET_SD_CMU + 8,      0x40000 },   \n\t{ TARGET_SD_CMU_CFG,      0x48000 },   \n\t{ TARGET_SD_CMU_CFG + 1,  0x50000 },   \n\t{ TARGET_SD_CMU_CFG + 2,  0x58000 },   \n\t{ TARGET_SD_CMU_CFG + 3,  0x60000 },   \n\t{ TARGET_SD_CMU_CFG + 4,  0x68000 },   \n\t{ TARGET_SD_CMU_CFG + 5,  0x70000 },   \n\t{ TARGET_SD_CMU_CFG + 6,  0x78000 },   \n\t{ TARGET_SD_CMU_CFG + 7,  0x80000 },   \n\t{ TARGET_SD_CMU_CFG + 8,  0x88000 },   \n\t{ TARGET_SD6G_LANE,       0x90000 },   \n\t{ TARGET_SD6G_LANE + 1,   0x98000 },   \n\t{ TARGET_SD6G_LANE + 2,   0xa0000 },   \n\t{ TARGET_SD6G_LANE + 3,   0xa8000 },   \n\t{ TARGET_SD6G_LANE + 4,   0xb0000 },   \n\t{ TARGET_SD6G_LANE + 5,   0xb8000 },   \n\t{ TARGET_SD6G_LANE + 6,   0xc0000 },   \n\t{ TARGET_SD6G_LANE + 7,   0xc8000 },   \n\t{ TARGET_SD6G_LANE + 8,   0xd0000 },   \n\t{ TARGET_SD6G_LANE + 9,   0xd8000 },   \n\t{ TARGET_SD6G_LANE + 10,  0xe0000 },   \n\t{ TARGET_SD6G_LANE + 11,  0xe8000 },   \n\t{ TARGET_SD6G_LANE + 12,  0xf0000 },   \n\t{ TARGET_SD10G_LANE,      0xf8000 },   \n\t{ TARGET_SD10G_LANE + 1,  0x100000 },  \n\t{ TARGET_SD10G_LANE + 2,  0x108000 },  \n\t{ TARGET_SD10G_LANE + 3,  0x110000 },  \n\t{ TARGET_SD_LANE,         0x1a0000 },  \n\t{ TARGET_SD_LANE + 1,     0x1a8000 },  \n\t{ TARGET_SD_LANE + 2,     0x1b0000 },  \n\t{ TARGET_SD_LANE + 3,     0x1b8000 },  \n\t{ TARGET_SD_LANE + 4,     0x1c0000 },  \n\t{ TARGET_SD_LANE + 5,     0x1c8000 },  \n\t{ TARGET_SD_LANE + 6,     0x1d0000 },  \n\t{ TARGET_SD_LANE + 7,     0x1d8000 },  \n\t{ TARGET_SD_LANE + 8,     0x1e0000 },  \n\t{ TARGET_SD_LANE + 9,     0x1e8000 },  \n\t{ TARGET_SD_LANE + 10,    0x1f0000 },  \n\t{ TARGET_SD_LANE + 11,    0x1f8000 },  \n\t{ TARGET_SD_LANE + 12,    0x200000 },  \n\t{ TARGET_SD_LANE + 13,    0x208000 },  \n\t{ TARGET_SD_LANE + 14,    0x210000 },  \n\t{ TARGET_SD_LANE + 15,    0x218000 },  \n\t{ TARGET_SD_LANE + 16,    0x220000 },  \n\t{ TARGET_SD_CMU + 9,      0x400000 },  \n\t{ TARGET_SD_CMU + 10,     0x408000 },  \n\t{ TARGET_SD_CMU + 11,     0x410000 },  \n\t{ TARGET_SD_CMU + 12,     0x418000 },  \n\t{ TARGET_SD_CMU + 13,     0x420000 },  \n\t{ TARGET_SD_CMU_CFG + 9,  0x428000 },  \n\t{ TARGET_SD_CMU_CFG + 10, 0x430000 },  \n\t{ TARGET_SD_CMU_CFG + 11, 0x438000 },  \n\t{ TARGET_SD_CMU_CFG + 12, 0x440000 },  \n\t{ TARGET_SD_CMU_CFG + 13, 0x448000 },  \n\t{ TARGET_SD10G_LANE + 4,  0x450000 },  \n\t{ TARGET_SD10G_LANE + 5,  0x458000 },  \n\t{ TARGET_SD10G_LANE + 6,  0x460000 },  \n\t{ TARGET_SD10G_LANE + 7,  0x468000 },  \n\t{ TARGET_SD10G_LANE + 8,  0x470000 },  \n\t{ TARGET_SD10G_LANE + 9,  0x478000 },  \n\t{ TARGET_SD10G_LANE + 10, 0x480000 },  \n\t{ TARGET_SD10G_LANE + 11, 0x488000 },  \n\t{ TARGET_SD25G_LANE,      0x490000 },  \n\t{ TARGET_SD25G_LANE + 1,  0x498000 },  \n\t{ TARGET_SD25G_LANE + 2,  0x4a0000 },  \n\t{ TARGET_SD25G_LANE + 3,  0x4a8000 },  \n\t{ TARGET_SD25G_LANE + 4,  0x4b0000 },  \n\t{ TARGET_SD25G_LANE + 5,  0x4b8000 },  \n\t{ TARGET_SD25G_LANE + 6,  0x4c0000 },  \n\t{ TARGET_SD25G_LANE + 7,  0x4c8000 },  \n\t{ TARGET_SD_LANE + 17,    0x550000 },  \n\t{ TARGET_SD_LANE + 18,    0x558000 },  \n\t{ TARGET_SD_LANE + 19,    0x560000 },  \n\t{ TARGET_SD_LANE + 20,    0x568000 },  \n\t{ TARGET_SD_LANE + 21,    0x570000 },  \n\t{ TARGET_SD_LANE + 22,    0x578000 },  \n\t{ TARGET_SD_LANE + 23,    0x580000 },  \n\t{ TARGET_SD_LANE + 24,    0x588000 },  \n\t{ TARGET_SD_LANE_25G,     0x590000 },  \n\t{ TARGET_SD_LANE_25G + 1, 0x598000 },  \n\t{ TARGET_SD_LANE_25G + 2, 0x5a0000 },  \n\t{ TARGET_SD_LANE_25G + 3, 0x5a8000 },  \n\t{ TARGET_SD_LANE_25G + 4, 0x5b0000 },  \n\t{ TARGET_SD_LANE_25G + 5, 0x5b8000 },  \n\t{ TARGET_SD_LANE_25G + 6, 0x5c0000 },  \n\t{ TARGET_SD_LANE_25G + 7, 0x5c8000 },  \n};\n\n \nstatic struct phy *sparx5_serdes_xlate(struct device *dev,\n\t\t\t\t     struct of_phandle_args *args)\n{\n\tstruct sparx5_serdes_private *priv = dev_get_drvdata(dev);\n\tint idx;\n\tunsigned int sidx;\n\n\tif (args->args_count != 1)\n\t\treturn ERR_PTR(-EINVAL);\n\n\tsidx = args->args[0];\n\n\t \n\tfor (idx = 0; idx < SPX5_SERDES_MAX; idx++) {\n\t\tstruct sparx5_serdes_macro *macro =\n\t\t\tphy_get_drvdata(priv->phys[idx]);\n\n\t\tif (sidx != macro->sidx)\n\t\t\tcontinue;\n\n\t\treturn priv->phys[idx];\n\t}\n\treturn ERR_PTR(-ENODEV);\n}\n\nstatic int sparx5_serdes_probe(struct platform_device *pdev)\n{\n\tstruct device_node *np = pdev->dev.of_node;\n\tstruct sparx5_serdes_private *priv;\n\tstruct phy_provider *provider;\n\tstruct resource *iores;\n\tvoid __iomem *iomem;\n\tunsigned long clock;\n\tstruct clk *clk;\n\tint idx;\n\tint err;\n\n\tif (!np && !pdev->dev.platform_data)\n\t\treturn -ENODEV;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, priv);\n\tpriv->dev = &pdev->dev;\n\n\t \n\tclk = devm_clk_get(priv->dev, NULL);\n\tif (IS_ERR(clk)) {\n\t\tdev_err(priv->dev, \"Failed to get coreclock\\n\");\n\t\treturn PTR_ERR(clk);\n\t}\n\tclock = clk_get_rate(clk);\n\tif (clock == 0) {\n\t\tdev_err(priv->dev, \"Invalid coreclock %lu\\n\", clock);\n\t\treturn -EINVAL;\n\t}\n\tpriv->coreclock = clock;\n\n\tiores = platform_get_resource(pdev, IORESOURCE_MEM, 0);\n\tif (!iores) {\n\t\tdev_err(priv->dev, \"Invalid resource\\n\");\n\t\treturn -EINVAL;\n\t}\n\tiomem = devm_ioremap(priv->dev, iores->start, resource_size(iores));\n\tif (!iomem) {\n\t\tdev_err(priv->dev, \"Unable to get serdes registers: %s\\n\",\n\t\t\tiores->name);\n\t\treturn -ENOMEM;\n\t}\n\tfor (idx = 0; idx < ARRAY_SIZE(sparx5_serdes_iomap); idx++) {\n\t\tstruct sparx5_serdes_io_resource *iomap = &sparx5_serdes_iomap[idx];\n\n\t\tpriv->regs[iomap->id] = iomem + iomap->offset;\n\t}\n\tfor (idx = 0; idx < SPX5_SERDES_MAX; idx++) {\n\t\terr = sparx5_phy_create(priv, idx, &priv->phys[idx]);\n\t\tif (err)\n\t\t\treturn err;\n\t}\n\n\t \n\tsparx5_serdes_cmu_power_off(priv);\n\n\tprovider = devm_of_phy_provider_register(priv->dev, sparx5_serdes_xlate);\n\n\treturn PTR_ERR_OR_ZERO(provider);\n}\n\nstatic const struct of_device_id sparx5_serdes_match[] = {\n\t{ .compatible = \"microchip,sparx5-serdes\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, sparx5_serdes_match);\n\nstatic struct platform_driver sparx5_serdes_driver = {\n\t.probe = sparx5_serdes_probe,\n\t.driver = {\n\t\t.name = \"sparx5-serdes\",\n\t\t.of_match_table = sparx5_serdes_match,\n\t},\n};\n\nmodule_platform_driver(sparx5_serdes_driver);\n\nMODULE_DESCRIPTION(\"Microchip Sparx5 switch serdes driver\");\nMODULE_AUTHOR(\"Steen Hegelund <steen.hegelund@microchip.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}