{
  "module_name": "phy-qcom-apq8064-sata.c",
  "hash_id": "46eee89b7323a37bf4472b52031a20186900dca300e4dfc80173985a921e807e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/qualcomm/phy-qcom-apq8064-sata.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/iopoll.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/time.h>\n#include <linux/delay.h>\n#include <linux/clk.h>\n#include <linux/slab.h>\n#include <linux/platform_device.h>\n#include <linux/phy/phy.h>\n\n \n#define UNIPHY_PLL_REFCLK_CFG\t\t0x000\n#define UNIPHY_PLL_PWRGEN_CFG\t\t0x014\n#define UNIPHY_PLL_GLB_CFG\t\t0x020\n#define UNIPHY_PLL_SDM_CFG0\t\t0x038\n#define UNIPHY_PLL_SDM_CFG1\t\t0x03C\n#define UNIPHY_PLL_SDM_CFG2\t\t0x040\n#define UNIPHY_PLL_SDM_CFG3\t\t0x044\n#define UNIPHY_PLL_SDM_CFG4\t\t0x048\n#define UNIPHY_PLL_SSC_CFG0\t\t0x04C\n#define UNIPHY_PLL_SSC_CFG1\t\t0x050\n#define UNIPHY_PLL_SSC_CFG2\t\t0x054\n#define UNIPHY_PLL_SSC_CFG3\t\t0x058\n#define UNIPHY_PLL_LKDET_CFG0\t\t0x05C\n#define UNIPHY_PLL_LKDET_CFG1\t\t0x060\n#define UNIPHY_PLL_LKDET_CFG2\t\t0x064\n#define UNIPHY_PLL_CAL_CFG0\t\t0x06C\n#define UNIPHY_PLL_CAL_CFG8\t\t0x08C\n#define UNIPHY_PLL_CAL_CFG9\t\t0x090\n#define UNIPHY_PLL_CAL_CFG10\t\t0x094\n#define UNIPHY_PLL_CAL_CFG11\t\t0x098\n#define UNIPHY_PLL_STATUS\t\t0x0C0\n\n#define SATA_PHY_SER_CTRL\t\t0x100\n#define SATA_PHY_TX_DRIV_CTRL0\t\t0x104\n#define SATA_PHY_TX_DRIV_CTRL1\t\t0x108\n#define SATA_PHY_TX_IMCAL0\t\t0x11C\n#define SATA_PHY_TX_IMCAL2\t\t0x124\n#define SATA_PHY_RX_IMCAL0\t\t0x128\n#define SATA_PHY_EQUAL\t\t\t0x13C\n#define SATA_PHY_OOB_TERM\t\t0x144\n#define SATA_PHY_CDR_CTRL0\t\t0x148\n#define SATA_PHY_CDR_CTRL1\t\t0x14C\n#define SATA_PHY_CDR_CTRL2\t\t0x150\n#define SATA_PHY_CDR_CTRL3\t\t0x154\n#define SATA_PHY_PI_CTRL0\t\t0x168\n#define SATA_PHY_POW_DWN_CTRL0\t\t0x180\n#define SATA_PHY_POW_DWN_CTRL1\t\t0x184\n#define SATA_PHY_TX_DATA_CTRL\t\t0x188\n#define SATA_PHY_ALIGNP\t\t\t0x1A4\n#define SATA_PHY_TX_IMCAL_STAT\t\t0x1E4\n#define SATA_PHY_RX_IMCAL_STAT\t\t0x1E8\n\n#define UNIPHY_PLL_LOCK\t\tBIT(0)\n#define SATA_PHY_TX_CAL\t\tBIT(0)\n#define SATA_PHY_RX_CAL\t\tBIT(0)\n\n \n#define TIMEOUT_MS\t\t10000\n#define DELAY_INTERVAL_US\t100\n\nstruct qcom_apq8064_sata_phy {\n\tvoid __iomem *mmio;\n\tstruct clk *cfg_clk;\n\tstruct device *dev;\n};\n\n \nstatic int poll_timeout(void __iomem *addr, u32 mask)\n{\n\tu32 val;\n\n\treturn readl_relaxed_poll_timeout(addr, val, (val & mask),\n\t\t\t\t\tDELAY_INTERVAL_US, TIMEOUT_MS * 1000);\n}\n\nstatic int qcom_apq8064_sata_phy_init(struct phy *generic_phy)\n{\n\tstruct qcom_apq8064_sata_phy *phy = phy_get_drvdata(generic_phy);\n\tvoid __iomem *base = phy->mmio;\n\tint ret = 0;\n\n\t \n\twritel_relaxed(0x01, base + SATA_PHY_SER_CTRL);\n\twritel_relaxed(0xB1, base + SATA_PHY_POW_DWN_CTRL0);\n\t \n\tmb();\n\tusleep_range(10, 60);\n\n\twritel_relaxed(0x01, base + SATA_PHY_POW_DWN_CTRL0);\n\twritel_relaxed(0x3E, base + SATA_PHY_POW_DWN_CTRL1);\n\twritel_relaxed(0x01, base + SATA_PHY_RX_IMCAL0);\n\twritel_relaxed(0x01, base + SATA_PHY_TX_IMCAL0);\n\twritel_relaxed(0x02, base + SATA_PHY_TX_IMCAL2);\n\n\t \n\twritel_relaxed(0x04, base + UNIPHY_PLL_REFCLK_CFG);\n\twritel_relaxed(0x00, base + UNIPHY_PLL_PWRGEN_CFG);\n\n\twritel_relaxed(0x0A, base + UNIPHY_PLL_CAL_CFG0);\n\twritel_relaxed(0xF3, base + UNIPHY_PLL_CAL_CFG8);\n\twritel_relaxed(0x01, base + UNIPHY_PLL_CAL_CFG9);\n\twritel_relaxed(0xED, base + UNIPHY_PLL_CAL_CFG10);\n\twritel_relaxed(0x02, base + UNIPHY_PLL_CAL_CFG11);\n\n\twritel_relaxed(0x36, base + UNIPHY_PLL_SDM_CFG0);\n\twritel_relaxed(0x0D, base + UNIPHY_PLL_SDM_CFG1);\n\twritel_relaxed(0xA3, base + UNIPHY_PLL_SDM_CFG2);\n\twritel_relaxed(0xF0, base + UNIPHY_PLL_SDM_CFG3);\n\twritel_relaxed(0x00, base + UNIPHY_PLL_SDM_CFG4);\n\n\twritel_relaxed(0x19, base + UNIPHY_PLL_SSC_CFG0);\n\twritel_relaxed(0xE1, base + UNIPHY_PLL_SSC_CFG1);\n\twritel_relaxed(0x00, base + UNIPHY_PLL_SSC_CFG2);\n\twritel_relaxed(0x11, base + UNIPHY_PLL_SSC_CFG3);\n\n\twritel_relaxed(0x04, base + UNIPHY_PLL_LKDET_CFG0);\n\twritel_relaxed(0xFF, base + UNIPHY_PLL_LKDET_CFG1);\n\n\twritel_relaxed(0x02, base + UNIPHY_PLL_GLB_CFG);\n\t \n\tmb();\n\n\twritel_relaxed(0x03, base + UNIPHY_PLL_GLB_CFG);\n\twritel_relaxed(0x05, base + UNIPHY_PLL_LKDET_CFG2);\n\n\t \n\tret = poll_timeout(base + UNIPHY_PLL_STATUS, UNIPHY_PLL_LOCK);\n\tif (ret) {\n\t\tdev_err(phy->dev, \"poll timeout UNIPHY_PLL_STATUS\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = poll_timeout(base + SATA_PHY_TX_IMCAL_STAT, SATA_PHY_TX_CAL);\n\tif (ret) {\n\t\tdev_err(phy->dev, \"poll timeout SATA_PHY_TX_IMCAL_STAT\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tret = poll_timeout(base + SATA_PHY_RX_IMCAL_STAT, SATA_PHY_RX_CAL);\n\tif (ret) {\n\t\tdev_err(phy->dev, \"poll timeout SATA_PHY_RX_IMCAL_STAT\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\twritel_relaxed(0x3E, base + SATA_PHY_POW_DWN_CTRL1);\n\twritel_relaxed(0x01, base + SATA_PHY_RX_IMCAL0);\n\twritel_relaxed(0x01, base + SATA_PHY_TX_IMCAL0);\n\n\twritel_relaxed(0x00, base + SATA_PHY_POW_DWN_CTRL1);\n\twritel_relaxed(0x59, base + SATA_PHY_CDR_CTRL0);\n\twritel_relaxed(0x04, base + SATA_PHY_CDR_CTRL1);\n\twritel_relaxed(0x00, base + SATA_PHY_CDR_CTRL2);\n\twritel_relaxed(0x00, base + SATA_PHY_PI_CTRL0);\n\twritel_relaxed(0x00, base + SATA_PHY_CDR_CTRL3);\n\twritel_relaxed(0x01, base + SATA_PHY_POW_DWN_CTRL0);\n\n\twritel_relaxed(0x11, base + SATA_PHY_TX_DATA_CTRL);\n\twritel_relaxed(0x43, base + SATA_PHY_ALIGNP);\n\twritel_relaxed(0x04, base + SATA_PHY_OOB_TERM);\n\n\twritel_relaxed(0x01, base + SATA_PHY_EQUAL);\n\twritel_relaxed(0x09, base + SATA_PHY_TX_DRIV_CTRL0);\n\twritel_relaxed(0x09, base + SATA_PHY_TX_DRIV_CTRL1);\n\n\treturn 0;\n}\n\nstatic int qcom_apq8064_sata_phy_exit(struct phy *generic_phy)\n{\n\tstruct qcom_apq8064_sata_phy *phy = phy_get_drvdata(generic_phy);\n\tvoid __iomem *base = phy->mmio;\n\n\t \n\twritel_relaxed(0xF8, base + SATA_PHY_POW_DWN_CTRL0);\n\twritel_relaxed(0xFE, base + SATA_PHY_POW_DWN_CTRL1);\n\n\t \n\twritel_relaxed(0x00, base + UNIPHY_PLL_GLB_CFG);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops qcom_apq8064_sata_phy_ops = {\n\t.init\t\t= qcom_apq8064_sata_phy_init,\n\t.exit\t\t= qcom_apq8064_sata_phy_exit,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int qcom_apq8064_sata_phy_probe(struct platform_device *pdev)\n{\n\tstruct qcom_apq8064_sata_phy *phy;\n\tstruct device *dev = &pdev->dev;\n\tstruct phy_provider *phy_provider;\n\tstruct phy *generic_phy;\n\tint ret;\n\n\tphy = devm_kzalloc(dev, sizeof(*phy), GFP_KERNEL);\n\tif (!phy)\n\t\treturn -ENOMEM;\n\n\tphy->mmio = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(phy->mmio))\n\t\treturn PTR_ERR(phy->mmio);\n\n\tgeneric_phy = devm_phy_create(dev, NULL, &qcom_apq8064_sata_phy_ops);\n\tif (IS_ERR(generic_phy)) {\n\t\tdev_err(dev, \"%s: failed to create phy\\n\", __func__);\n\t\treturn PTR_ERR(generic_phy);\n\t}\n\n\tphy->dev = dev;\n\tphy_set_drvdata(generic_phy, phy);\n\tplatform_set_drvdata(pdev, phy);\n\n\tphy->cfg_clk = devm_clk_get(dev, \"cfg\");\n\tif (IS_ERR(phy->cfg_clk)) {\n\t\tdev_err(dev, \"Failed to get sata cfg clock\\n\");\n\t\treturn PTR_ERR(phy->cfg_clk);\n\t}\n\n\tret = clk_prepare_enable(phy->cfg_clk);\n\tif (ret)\n\t\treturn ret;\n\n\tphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\n\tif (IS_ERR(phy_provider)) {\n\t\tclk_disable_unprepare(phy->cfg_clk);\n\t\tdev_err(dev, \"%s: failed to register phy\\n\", __func__);\n\t\treturn PTR_ERR(phy_provider);\n\t}\n\n\treturn 0;\n}\n\nstatic void qcom_apq8064_sata_phy_remove(struct platform_device *pdev)\n{\n\tstruct qcom_apq8064_sata_phy *phy = platform_get_drvdata(pdev);\n\n\tclk_disable_unprepare(phy->cfg_clk);\n}\n\nstatic const struct of_device_id qcom_apq8064_sata_phy_of_match[] = {\n\t{ .compatible = \"qcom,apq8064-sata-phy\" },\n\t{ },\n};\nMODULE_DEVICE_TABLE(of, qcom_apq8064_sata_phy_of_match);\n\nstatic struct platform_driver qcom_apq8064_sata_phy_driver = {\n\t.probe\t= qcom_apq8064_sata_phy_probe,\n\t.remove_new = qcom_apq8064_sata_phy_remove,\n\t.driver = {\n\t\t.name\t= \"qcom-apq8064-sata-phy\",\n\t\t.of_match_table\t= qcom_apq8064_sata_phy_of_match,\n\t}\n};\nmodule_platform_driver(qcom_apq8064_sata_phy_driver);\n\nMODULE_DESCRIPTION(\"QCOM apq8064 SATA PHY driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}