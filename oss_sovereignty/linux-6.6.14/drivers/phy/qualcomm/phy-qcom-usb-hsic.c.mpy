{
  "module_name": "phy-qcom-usb-hsic.c",
  "hash_id": "42f6dd1174af3fa7add1dfc740762caa5c45000ee0587b9b06be4fdb3cf98ec0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/qualcomm/phy-qcom-usb-hsic.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/ulpi/driver.h>\n#include <linux/ulpi/regs.h>\n#include <linux/phy/phy.h>\n#include <linux/pinctrl/consumer.h>\n#include <linux/pinctrl/pinctrl-state.h>\n#include <linux/delay.h>\n#include <linux/clk.h>\n\n#define ULPI_HSIC_CFG\t\t0x30\n#define ULPI_HSIC_IO_CAL\t0x33\n\nstruct qcom_usb_hsic_phy {\n\tstruct ulpi *ulpi;\n\tstruct phy *phy;\n\tstruct pinctrl *pctl;\n\tstruct clk *phy_clk;\n\tstruct clk *cal_clk;\n\tstruct clk *cal_sleep_clk;\n};\n\nstatic int qcom_usb_hsic_phy_power_on(struct phy *phy)\n{\n\tstruct qcom_usb_hsic_phy *uphy = phy_get_drvdata(phy);\n\tstruct ulpi *ulpi = uphy->ulpi;\n\tstruct pinctrl_state *pins_default;\n\tint ret;\n\n\tret = clk_prepare_enable(uphy->phy_clk);\n\tif (ret)\n\t\treturn ret;\n\n\tret = clk_prepare_enable(uphy->cal_clk);\n\tif (ret)\n\t\tgoto err_cal;\n\n\tret = clk_prepare_enable(uphy->cal_sleep_clk);\n\tif (ret)\n\t\tgoto err_sleep;\n\n\t \n\tret = ulpi_write(ulpi, ULPI_HSIC_IO_CAL, 0xff);\n\tif (ret)\n\t\tgoto err_ulpi;\n\n\t \n\tret = ulpi_write(ulpi, ULPI_HSIC_CFG, 0xa8);\n\tif (ret)\n\t\tgoto err_ulpi;\n\n\t \n\tpins_default = pinctrl_lookup_state(uphy->pctl, PINCTRL_STATE_DEFAULT);\n\tif (IS_ERR(pins_default)) {\n\t\tret = PTR_ERR(pins_default);\n\t\tgoto err_ulpi;\n\t}\n\n\tret = pinctrl_select_state(uphy->pctl, pins_default);\n\tif (ret)\n\t\tgoto err_ulpi;\n\n\t  \n\tret = ulpi_write(ulpi, ULPI_SET(ULPI_HSIC_CFG), 0x01);\n\tif (ret)\n\t\tgoto err_ulpi;\n\n\t \n\tret = ulpi_write(ulpi, ULPI_CLR(ULPI_IFC_CTRL),\n\t\t\t ULPI_IFC_CTRL_AUTORESUME);\n\tif (ret)\n\t\tgoto err_ulpi;\n\n\treturn ret;\nerr_ulpi:\n\tclk_disable_unprepare(uphy->cal_sleep_clk);\nerr_sleep:\n\tclk_disable_unprepare(uphy->cal_clk);\nerr_cal:\n\tclk_disable_unprepare(uphy->phy_clk);\n\treturn ret;\n}\n\nstatic int qcom_usb_hsic_phy_power_off(struct phy *phy)\n{\n\tstruct qcom_usb_hsic_phy *uphy = phy_get_drvdata(phy);\n\n\tclk_disable_unprepare(uphy->cal_sleep_clk);\n\tclk_disable_unprepare(uphy->cal_clk);\n\tclk_disable_unprepare(uphy->phy_clk);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops qcom_usb_hsic_phy_ops = {\n\t.power_on = qcom_usb_hsic_phy_power_on,\n\t.power_off = qcom_usb_hsic_phy_power_off,\n\t.owner = THIS_MODULE,\n};\n\nstatic int qcom_usb_hsic_phy_probe(struct ulpi *ulpi)\n{\n\tstruct qcom_usb_hsic_phy *uphy;\n\tstruct phy_provider *p;\n\tstruct clk *clk;\n\n\tuphy = devm_kzalloc(&ulpi->dev, sizeof(*uphy), GFP_KERNEL);\n\tif (!uphy)\n\t\treturn -ENOMEM;\n\tulpi_set_drvdata(ulpi, uphy);\n\n\tuphy->ulpi = ulpi;\n\tuphy->pctl = devm_pinctrl_get(&ulpi->dev);\n\tif (IS_ERR(uphy->pctl))\n\t\treturn PTR_ERR(uphy->pctl);\n\n\tuphy->phy_clk = clk = devm_clk_get(&ulpi->dev, \"phy\");\n\tif (IS_ERR(clk))\n\t\treturn PTR_ERR(clk);\n\n\tuphy->cal_clk = clk = devm_clk_get(&ulpi->dev, \"cal\");\n\tif (IS_ERR(clk))\n\t\treturn PTR_ERR(clk);\n\n\tuphy->cal_sleep_clk = clk = devm_clk_get(&ulpi->dev, \"cal_sleep\");\n\tif (IS_ERR(clk))\n\t\treturn PTR_ERR(clk);\n\n\tuphy->phy = devm_phy_create(&ulpi->dev, ulpi->dev.of_node,\n\t\t\t\t    &qcom_usb_hsic_phy_ops);\n\tif (IS_ERR(uphy->phy))\n\t\treturn PTR_ERR(uphy->phy);\n\tphy_set_drvdata(uphy->phy, uphy);\n\n\tp = devm_of_phy_provider_register(&ulpi->dev, of_phy_simple_xlate);\n\treturn PTR_ERR_OR_ZERO(p);\n}\n\nstatic const struct of_device_id qcom_usb_hsic_phy_match[] = {\n\t{ .compatible = \"qcom,usb-hsic-phy\", },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, qcom_usb_hsic_phy_match);\n\nstatic struct ulpi_driver qcom_usb_hsic_phy_driver = {\n\t.probe = qcom_usb_hsic_phy_probe,\n\t.driver = {\n\t\t.name = \"qcom_usb_hsic_phy\",\n\t\t.of_match_table = qcom_usb_hsic_phy_match,\n\t},\n};\nmodule_ulpi_driver(qcom_usb_hsic_phy_driver);\n\nMODULE_DESCRIPTION(\"Qualcomm USB HSIC phy\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}