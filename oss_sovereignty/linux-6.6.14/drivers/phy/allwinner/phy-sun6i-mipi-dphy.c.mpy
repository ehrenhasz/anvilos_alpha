{
  "module_name": "phy-sun6i-mipi-dphy.c",
  "hash_id": "141283f2f77d57f5f480f75e466ea38b84a664d8984510767958308ba6327cff",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/allwinner/phy-sun6i-mipi-dphy.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/clk.h>\n#include <linux/module.h>\n#include <linux/of_address.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/reset.h>\n\n#include <linux/phy/phy.h>\n#include <linux/phy/phy-mipi-dphy.h>\n\n#define SUN6I_DPHY_GCTL_REG\t\t0x00\n#define SUN6I_DPHY_GCTL_LANE_NUM(n)\t\t((((n) - 1) & 3) << 4)\n#define SUN6I_DPHY_GCTL_EN\t\t\tBIT(0)\n\n#define SUN6I_DPHY_TX_CTL_REG\t\t0x04\n#define SUN6I_DPHY_TX_CTL_HS_TX_CLK_CONT\tBIT(28)\n\n#define SUN6I_DPHY_RX_CTL_REG\t\t0x08\n#define SUN6I_DPHY_RX_CTL_EN_DBC\tBIT(31)\n#define SUN6I_DPHY_RX_CTL_RX_CLK_FORCE\tBIT(24)\n#define SUN6I_DPHY_RX_CTL_RX_D3_FORCE\tBIT(23)\n#define SUN6I_DPHY_RX_CTL_RX_D2_FORCE\tBIT(22)\n#define SUN6I_DPHY_RX_CTL_RX_D1_FORCE\tBIT(21)\n#define SUN6I_DPHY_RX_CTL_RX_D0_FORCE\tBIT(20)\n\n#define SUN6I_DPHY_TX_TIME0_REG\t\t0x10\n#define SUN6I_DPHY_TX_TIME0_HS_TRAIL(n)\t\t(((n) & 0xff) << 24)\n#define SUN6I_DPHY_TX_TIME0_HS_PREPARE(n)\t(((n) & 0xff) << 16)\n#define SUN6I_DPHY_TX_TIME0_LP_CLK_DIV(n)\t((n) & 0xff)\n\n#define SUN6I_DPHY_TX_TIME1_REG\t\t0x14\n#define SUN6I_DPHY_TX_TIME1_CLK_POST(n)\t\t(((n) & 0xff) << 24)\n#define SUN6I_DPHY_TX_TIME1_CLK_PRE(n)\t\t(((n) & 0xff) << 16)\n#define SUN6I_DPHY_TX_TIME1_CLK_ZERO(n)\t\t(((n) & 0xff) << 8)\n#define SUN6I_DPHY_TX_TIME1_CLK_PREPARE(n)\t((n) & 0xff)\n\n#define SUN6I_DPHY_TX_TIME2_REG\t\t0x18\n#define SUN6I_DPHY_TX_TIME2_CLK_TRAIL(n)\t((n) & 0xff)\n\n#define SUN6I_DPHY_TX_TIME3_REG\t\t0x1c\n\n#define SUN6I_DPHY_TX_TIME4_REG\t\t0x20\n#define SUN6I_DPHY_TX_TIME4_HS_TX_ANA1(n)\t(((n) & 0xff) << 8)\n#define SUN6I_DPHY_TX_TIME4_HS_TX_ANA0(n)\t((n) & 0xff)\n\n#define SUN6I_DPHY_RX_TIME0_REG\t\t0x30\n#define SUN6I_DPHY_RX_TIME0_HS_RX_SYNC(n)\t(((n) & 0xff) << 24)\n#define SUN6I_DPHY_RX_TIME0_HS_RX_CLK_MISS(n)\t(((n) & 0xff) << 16)\n#define SUN6I_DPHY_RX_TIME0_LP_RX(n)\t\t(((n) & 0xff) << 8)\n\n#define SUN6I_DPHY_RX_TIME1_REG\t\t0x34\n#define SUN6I_DPHY_RX_TIME1_RX_DLY(n)\t\t(((n) & 0xfff) << 20)\n#define SUN6I_DPHY_RX_TIME1_LP_RX_ULPS_WP(n)\t((n) & 0xfffff)\n\n#define SUN6I_DPHY_RX_TIME2_REG\t\t0x38\n#define SUN6I_DPHY_RX_TIME2_HS_RX_ANA1(n)\t(((n) & 0xff) << 8)\n#define SUN6I_DPHY_RX_TIME2_HS_RX_ANA0(n)\t((n) & 0xff)\n\n#define SUN6I_DPHY_RX_TIME3_REG\t\t0x40\n#define SUN6I_DPHY_RX_TIME3_LPRST_DLY(n)\t(((n) & 0xffff) << 16)\n\n#define SUN6I_DPHY_ANA0_REG\t\t0x4c\n#define SUN6I_DPHY_ANA0_REG_PWS\t\t\tBIT(31)\n#define SUN6I_DPHY_ANA0_REG_PWEND\t\tBIT(30)\n#define SUN6I_DPHY_ANA0_REG_PWENC\t\tBIT(29)\n#define SUN6I_DPHY_ANA0_REG_DMPC\t\tBIT(28)\n#define SUN6I_DPHY_ANA0_REG_DMPD(n)\t\t(((n) & 0xf) << 24)\n#define SUN6I_DPHY_ANA0_REG_SRXDT(n)\t\t(((n) & 0xf) << 20)\n#define SUN6I_DPHY_ANA0_REG_SRXCK(n)\t\t(((n) & 0xf) << 16)\n#define SUN6I_DPHY_ANA0_REG_SDIV2\t\tBIT(15)\n#define SUN6I_DPHY_ANA0_REG_SLV(n)\t\t(((n) & 7) << 12)\n#define SUN6I_DPHY_ANA0_REG_DEN(n)\t\t(((n) & 0xf) << 8)\n#define SUN6I_DPHY_ANA0_REG_PLR(n)\t\t(((n) & 0xf) << 4)\n#define SUN6I_DPHY_ANA0_REG_SFB(n)\t\t(((n) & 3) << 2)\n#define SUN6I_DPHY_ANA0_REG_RSD\t\t\tBIT(1)\n#define SUN6I_DPHY_ANA0_REG_SELSCK\t\tBIT(0)\n\n#define SUN6I_DPHY_ANA1_REG\t\t0x50\n#define SUN6I_DPHY_ANA1_REG_VTTMODE\t\tBIT(31)\n#define SUN6I_DPHY_ANA1_REG_CSMPS(n)\t\t(((n) & 3) << 28)\n#define SUN6I_DPHY_ANA1_REG_SVTT(n)\t\t(((n) & 0xf) << 24)\n\n#define SUN6I_DPHY_ANA2_REG\t\t0x54\n#define SUN6I_DPHY_ANA2_EN_P2S_CPU(n)\t\t(((n) & 0xf) << 24)\n#define SUN6I_DPHY_ANA2_EN_P2S_CPU_MASK\t\tGENMASK(27, 24)\n#define SUN6I_DPHY_ANA2_EN_CK_CPU\t\tBIT(4)\n#define SUN6I_DPHY_ANA2_REG_ENIB\t\tBIT(1)\n\n#define SUN6I_DPHY_ANA3_REG\t\t0x58\n#define SUN6I_DPHY_ANA3_EN_VTTD(n)\t\t(((n) & 0xf) << 28)\n#define SUN6I_DPHY_ANA3_EN_VTTD_MASK\t\tGENMASK(31, 28)\n#define SUN6I_DPHY_ANA3_EN_VTTC\t\t\tBIT(27)\n#define SUN6I_DPHY_ANA3_EN_DIV\t\t\tBIT(26)\n#define SUN6I_DPHY_ANA3_EN_LDOC\t\t\tBIT(25)\n#define SUN6I_DPHY_ANA3_EN_LDOD\t\t\tBIT(24)\n#define SUN6I_DPHY_ANA3_EN_LDOR\t\t\tBIT(18)\n\n#define SUN6I_DPHY_ANA4_REG\t\t0x5c\n#define SUN6I_DPHY_ANA4_REG_EN_MIPI\t\tBIT(31)\n#define SUN6I_DPHY_ANA4_REG_EN_COMTEST\t\tBIT(30)\n#define SUN6I_DPHY_ANA4_REG_COMTEST(n)\t\t(((n) & 3) << 28)\n#define SUN6I_DPHY_ANA4_REG_IB(n)\t\t(((n) & 3) << 25)\n#define SUN6I_DPHY_ANA4_REG_DMPLVC\t\tBIT(24)\n#define SUN6I_DPHY_ANA4_REG_DMPLVD(n)\t\t(((n) & 0xf) << 20)\n#define SUN6I_DPHY_ANA4_REG_VTT_SET(n)\t\t(((n) & 0x7) << 17)\n#define SUN6I_DPHY_ANA4_REG_CKDV(n)\t\t(((n) & 0x1f) << 12)\n#define SUN6I_DPHY_ANA4_REG_TMSC(n)\t\t(((n) & 3) << 10)\n#define SUN6I_DPHY_ANA4_REG_TMSD(n)\t\t(((n) & 3) << 8)\n#define SUN6I_DPHY_ANA4_REG_TXDNSC(n)\t\t(((n) & 3) << 6)\n#define SUN6I_DPHY_ANA4_REG_TXDNSD(n)\t\t(((n) & 3) << 4)\n#define SUN6I_DPHY_ANA4_REG_TXPUSC(n)\t\t(((n) & 3) << 2)\n#define SUN6I_DPHY_ANA4_REG_TXPUSD(n)\t\t((n) & 3)\n\n#define SUN6I_DPHY_DBG5_REG\t\t0xf4\n\n#define SUN50I_DPHY_TX_SLEW_REG0\t0xf8\n#define SUN50I_DPHY_TX_SLEW_REG1\t0xfc\n#define SUN50I_DPHY_TX_SLEW_REG2\t0x100\n\n#define SUN50I_DPHY_PLL_REG0\t\t0x104\n#define SUN50I_DPHY_PLL_REG0_CP36_EN\t\tBIT(23)\n#define SUN50I_DPHY_PLL_REG0_LDO_EN\t\tBIT(22)\n#define SUN50I_DPHY_PLL_REG0_EN_LVS\t\tBIT(21)\n#define SUN50I_DPHY_PLL_REG0_PLL_EN\t\tBIT(20)\n#define SUN50I_DPHY_PLL_REG0_P(n)\t\t(((n) & 0xf) << 16)\n#define SUN50I_DPHY_PLL_REG0_N(n)\t\t(((n) & 0xff) << 8)\n#define SUN50I_DPHY_PLL_REG0_NDET\t\tBIT(7)\n#define SUN50I_DPHY_PLL_REG0_TDIV\t\tBIT(6)\n#define SUN50I_DPHY_PLL_REG0_M0(n)\t\t(((n) & 3) << 4)\n#define SUN50I_DPHY_PLL_REG0_M1(n)\t\t((n) & 0xf)\n\n#define SUN50I_DPHY_PLL_REG1\t\t0x108\n#define SUN50I_DPHY_PLL_REG1_UNLOCK_MDSEL(n)\t(((n) & 3) << 14)\n#define SUN50I_DPHY_PLL_REG1_LOCKMDSEL\t\tBIT(13)\n#define SUN50I_DPHY_PLL_REG1_LOCKDET_EN\t\tBIT(12)\n#define SUN50I_DPHY_PLL_REG1_VSETA(n)\t\t(((n) & 0x7) << 9)\n#define SUN50I_DPHY_PLL_REG1_VSETD(n)\t\t(((n) & 0x7) << 6)\n#define SUN50I_DPHY_PLL_REG1_LPF_SW\t\tBIT(5)\n#define SUN50I_DPHY_PLL_REG1_ICP_SEL(n)\t\t(((n) & 3) << 3)\n#define SUN50I_DPHY_PLL_REG1_ATEST_SEL(n)\t(((n) & 3) << 1)\n#define SUN50I_DPHY_PLL_REG1_TEST_EN\t\tBIT(0)\n\n#define SUN50I_DPHY_PLL_REG2\t\t0x10c\n#define SUN50I_DPHY_PLL_REG2_SDM_EN\t\tBIT(31)\n#define SUN50I_DPHY_PLL_REG2_FF_EN\t\tBIT(30)\n#define SUN50I_DPHY_PLL_REG2_SS_EN\t\tBIT(29)\n#define SUN50I_DPHY_PLL_REG2_SS_FRAC(n)\t\t(((n) & 0x1ff) << 20)\n#define SUN50I_DPHY_PLL_REG2_SS_INT(n)\t\t(((n) & 0xff) << 12)\n#define SUN50I_DPHY_PLL_REG2_FRAC(n)\t\t((n) & 0xfff)\n\n#define SUN50I_COMBO_PHY_REG0\t\t0x110\n#define SUN50I_COMBO_PHY_REG0_EN_TEST_COMBOLDO\tBIT(5)\n#define SUN50I_COMBO_PHY_REG0_EN_TEST_0P8\tBIT(4)\n#define SUN50I_COMBO_PHY_REG0_EN_MIPI\t\tBIT(3)\n#define SUN50I_COMBO_PHY_REG0_EN_LVDS\t\tBIT(2)\n#define SUN50I_COMBO_PHY_REG0_EN_COMBOLDO\tBIT(1)\n#define SUN50I_COMBO_PHY_REG0_EN_CP\t\tBIT(0)\n\n#define SUN50I_COMBO_PHY_REG1\t\t0x114\n#define SUN50I_COMBO_PHY_REG2_REG_VREF1P6(n)\t(((n) & 0x7) << 4)\n#define SUN50I_COMBO_PHY_REG2_REG_VREF0P8(n)\t((n) & 0x7)\n\n#define SUN50I_COMBO_PHY_REG2\t\t0x118\n#define SUN50I_COMBO_PHY_REG2_HS_STOP_DLY(n)\t((n) & 0xff)\n\nenum sun6i_dphy_direction {\n\tSUN6I_DPHY_DIRECTION_TX,\n\tSUN6I_DPHY_DIRECTION_RX,\n};\n\nstruct sun6i_dphy;\n\nstruct sun6i_dphy_variant {\n\tvoid\t(*tx_power_on)(struct sun6i_dphy *dphy);\n\tbool\trx_supported;\n};\n\nstruct sun6i_dphy {\n\tstruct clk\t\t\t\t*bus_clk;\n\tstruct clk\t\t\t\t*mod_clk;\n\tstruct regmap\t\t\t\t*regs;\n\tstruct reset_control\t\t\t*reset;\n\n\tstruct phy\t\t\t\t*phy;\n\tstruct phy_configure_opts_mipi_dphy\tconfig;\n\n\tconst struct sun6i_dphy_variant\t\t*variant;\n\tenum sun6i_dphy_direction\t\tdirection;\n};\n\nstatic int sun6i_dphy_init(struct phy *phy)\n{\n\tstruct sun6i_dphy *dphy = phy_get_drvdata(phy);\n\n\treset_control_deassert(dphy->reset);\n\tclk_prepare_enable(dphy->mod_clk);\n\tclk_set_rate_exclusive(dphy->mod_clk, 150000000);\n\n\treturn 0;\n}\n\nstatic int sun6i_dphy_configure(struct phy *phy, union phy_configure_opts *opts)\n{\n\tstruct sun6i_dphy *dphy = phy_get_drvdata(phy);\n\tint ret;\n\n\tret = phy_mipi_dphy_config_validate(&opts->mipi_dphy);\n\tif (ret)\n\t\treturn ret;\n\n\tmemcpy(&dphy->config, opts, sizeof(dphy->config));\n\n\treturn 0;\n}\n\nstatic void sun6i_a31_mipi_dphy_tx_power_on(struct sun6i_dphy *dphy)\n{\n\tu8 lanes_mask = GENMASK(dphy->config.lanes - 1, 0);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA0_REG,\n\t\t     SUN6I_DPHY_ANA0_REG_PWS |\n\t\t     SUN6I_DPHY_ANA0_REG_DMPC |\n\t\t     SUN6I_DPHY_ANA0_REG_SLV(7) |\n\t\t     SUN6I_DPHY_ANA0_REG_DMPD(lanes_mask) |\n\t\t     SUN6I_DPHY_ANA0_REG_DEN(lanes_mask));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA1_REG,\n\t\t     SUN6I_DPHY_ANA1_REG_CSMPS(1) |\n\t\t     SUN6I_DPHY_ANA1_REG_SVTT(7));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA4_REG,\n\t\t     SUN6I_DPHY_ANA4_REG_CKDV(1) |\n\t\t     SUN6I_DPHY_ANA4_REG_TMSC(1) |\n\t\t     SUN6I_DPHY_ANA4_REG_TMSD(1) |\n\t\t     SUN6I_DPHY_ANA4_REG_TXDNSC(1) |\n\t\t     SUN6I_DPHY_ANA4_REG_TXDNSD(1) |\n\t\t     SUN6I_DPHY_ANA4_REG_TXPUSC(1) |\n\t\t     SUN6I_DPHY_ANA4_REG_TXPUSD(1) |\n\t\t     SUN6I_DPHY_ANA4_REG_DMPLVC |\n\t\t     SUN6I_DPHY_ANA4_REG_DMPLVD(lanes_mask));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA2_REG,\n\t\t     SUN6I_DPHY_ANA2_REG_ENIB);\n\tudelay(5);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA3_REG,\n\t\t     SUN6I_DPHY_ANA3_EN_LDOR |\n\t\t     SUN6I_DPHY_ANA3_EN_LDOC |\n\t\t     SUN6I_DPHY_ANA3_EN_LDOD);\n\tudelay(1);\n}\n\nstatic void sun50i_a100_mipi_dphy_tx_power_on(struct sun6i_dphy *dphy)\n{\n\tunsigned long mipi_symbol_rate = dphy->config.hs_clk_rate;\n\tunsigned int div, n;\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA4_REG,\n\t\t     SUN6I_DPHY_ANA4_REG_IB(2) |\n\t\t     SUN6I_DPHY_ANA4_REG_DMPLVD(4) |\n\t\t     SUN6I_DPHY_ANA4_REG_VTT_SET(3) |\n\t\t     SUN6I_DPHY_ANA4_REG_CKDV(3) |\n\t\t     SUN6I_DPHY_ANA4_REG_TMSD(1) |\n\t\t     SUN6I_DPHY_ANA4_REG_TMSC(1) |\n\t\t     SUN6I_DPHY_ANA4_REG_TXPUSD(2) |\n\t\t     SUN6I_DPHY_ANA4_REG_TXPUSC(3) |\n\t\t     SUN6I_DPHY_ANA4_REG_TXDNSD(2) |\n\t\t     SUN6I_DPHY_ANA4_REG_TXDNSC(3));\n\n\tregmap_update_bits(dphy->regs, SUN6I_DPHY_ANA2_REG,\n\t\t\t   SUN6I_DPHY_ANA2_EN_CK_CPU,\n\t\t\t   SUN6I_DPHY_ANA2_EN_CK_CPU);\n\n\tregmap_update_bits(dphy->regs, SUN6I_DPHY_ANA2_REG,\n\t\t\t   SUN6I_DPHY_ANA2_REG_ENIB,\n\t\t\t   SUN6I_DPHY_ANA2_REG_ENIB);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA3_REG,\n\t\t     SUN6I_DPHY_ANA3_EN_LDOR |\n\t\t     SUN6I_DPHY_ANA3_EN_LDOC |\n\t\t     SUN6I_DPHY_ANA3_EN_LDOD);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA0_REG,\n\t\t     SUN6I_DPHY_ANA0_REG_PLR(4) |\n\t\t     SUN6I_DPHY_ANA0_REG_SFB(1));\n\n\tregmap_write(dphy->regs, SUN50I_COMBO_PHY_REG0,\n\t\t     SUN50I_COMBO_PHY_REG0_EN_CP);\n\n\t \n\tdiv = 16 >> order_base_2(DIV_ROUND_UP(mipi_symbol_rate, 264000000));\n\tn = mipi_symbol_rate * div / 24000000;\n\n\tregmap_write(dphy->regs, SUN50I_DPHY_PLL_REG0,\n\t\t     SUN50I_DPHY_PLL_REG0_CP36_EN |\n\t\t     SUN50I_DPHY_PLL_REG0_LDO_EN |\n\t\t     SUN50I_DPHY_PLL_REG0_EN_LVS |\n\t\t     SUN50I_DPHY_PLL_REG0_PLL_EN |\n\t\t     SUN50I_DPHY_PLL_REG0_NDET |\n\t\t     SUN50I_DPHY_PLL_REG0_P((div - 1) % 8) |\n\t\t     SUN50I_DPHY_PLL_REG0_N(n) |\n\t\t     SUN50I_DPHY_PLL_REG0_M0((div - 1) / 8) |\n\t\t     SUN50I_DPHY_PLL_REG0_M1(2));\n\n\t \n\tregmap_write(dphy->regs, SUN50I_DPHY_PLL_REG2, 0);\n\n\tregmap_update_bits(dphy->regs, SUN6I_DPHY_ANA4_REG,\n\t\t\t   SUN6I_DPHY_ANA4_REG_EN_MIPI,\n\t\t\t   SUN6I_DPHY_ANA4_REG_EN_MIPI);\n\n\tregmap_update_bits(dphy->regs, SUN50I_COMBO_PHY_REG0,\n\t\t\t   SUN50I_COMBO_PHY_REG0_EN_MIPI |\n\t\t\t   SUN50I_COMBO_PHY_REG0_EN_COMBOLDO,\n\t\t\t   SUN50I_COMBO_PHY_REG0_EN_MIPI |\n\t\t\t   SUN50I_COMBO_PHY_REG0_EN_COMBOLDO);\n\n\tregmap_write(dphy->regs, SUN50I_COMBO_PHY_REG2,\n\t\t     SUN50I_COMBO_PHY_REG2_HS_STOP_DLY(20));\n\tudelay(1);\n}\n\nstatic int sun6i_dphy_tx_power_on(struct sun6i_dphy *dphy)\n{\n\tu8 lanes_mask = GENMASK(dphy->config.lanes - 1, 0);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_TX_CTL_REG,\n\t\t     SUN6I_DPHY_TX_CTL_HS_TX_CLK_CONT);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_TX_TIME0_REG,\n\t\t     SUN6I_DPHY_TX_TIME0_LP_CLK_DIV(14) |\n\t\t     SUN6I_DPHY_TX_TIME0_HS_PREPARE(6) |\n\t\t     SUN6I_DPHY_TX_TIME0_HS_TRAIL(10));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_TX_TIME1_REG,\n\t\t     SUN6I_DPHY_TX_TIME1_CLK_PREPARE(7) |\n\t\t     SUN6I_DPHY_TX_TIME1_CLK_ZERO(50) |\n\t\t     SUN6I_DPHY_TX_TIME1_CLK_PRE(3) |\n\t\t     SUN6I_DPHY_TX_TIME1_CLK_POST(10));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_TX_TIME2_REG,\n\t\t     SUN6I_DPHY_TX_TIME2_CLK_TRAIL(30));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_TX_TIME3_REG, 0);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_TX_TIME4_REG,\n\t\t     SUN6I_DPHY_TX_TIME4_HS_TX_ANA0(3) |\n\t\t     SUN6I_DPHY_TX_TIME4_HS_TX_ANA1(3));\n\n\tdphy->variant->tx_power_on(dphy);\n\n\tregmap_update_bits(dphy->regs, SUN6I_DPHY_ANA3_REG,\n\t\t\t   SUN6I_DPHY_ANA3_EN_VTTC |\n\t\t\t   SUN6I_DPHY_ANA3_EN_VTTD_MASK,\n\t\t\t   SUN6I_DPHY_ANA3_EN_VTTC |\n\t\t\t   SUN6I_DPHY_ANA3_EN_VTTD(lanes_mask));\n\tudelay(1);\n\n\tregmap_update_bits(dphy->regs, SUN6I_DPHY_ANA3_REG,\n\t\t\t   SUN6I_DPHY_ANA3_EN_DIV,\n\t\t\t   SUN6I_DPHY_ANA3_EN_DIV);\n\tudelay(1);\n\n\tregmap_update_bits(dphy->regs, SUN6I_DPHY_ANA2_REG,\n\t\t\t   SUN6I_DPHY_ANA2_EN_CK_CPU,\n\t\t\t   SUN6I_DPHY_ANA2_EN_CK_CPU);\n\tudelay(1);\n\n\tregmap_update_bits(dphy->regs, SUN6I_DPHY_ANA1_REG,\n\t\t\t   SUN6I_DPHY_ANA1_REG_VTTMODE,\n\t\t\t   SUN6I_DPHY_ANA1_REG_VTTMODE);\n\n\tregmap_update_bits(dphy->regs, SUN6I_DPHY_ANA2_REG,\n\t\t\t   SUN6I_DPHY_ANA2_EN_P2S_CPU_MASK,\n\t\t\t   SUN6I_DPHY_ANA2_EN_P2S_CPU(lanes_mask));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_GCTL_REG,\n\t\t     SUN6I_DPHY_GCTL_LANE_NUM(dphy->config.lanes) |\n\t\t     SUN6I_DPHY_GCTL_EN);\n\n\treturn 0;\n}\n\nstatic int sun6i_dphy_rx_power_on(struct sun6i_dphy *dphy)\n{\n\t \n\tunsigned long mipi_symbol_rate = dphy->config.hs_clk_rate;\n\tunsigned long dphy_clk_rate;\n\tunsigned int rx_dly;\n\tunsigned int lprst_dly;\n\tu32 value;\n\n\tdphy_clk_rate = clk_get_rate(dphy->mod_clk);\n\tif (!dphy_clk_rate)\n\t\treturn -EINVAL;\n\n\t \n\tregmap_write(dphy->regs, SUN6I_DPHY_RX_TIME0_REG,\n\t\t     SUN6I_DPHY_RX_TIME0_HS_RX_SYNC(255) |\n\t\t     SUN6I_DPHY_RX_TIME0_HS_RX_CLK_MISS(255) |\n\t\t     SUN6I_DPHY_RX_TIME0_LP_RX(255));\n\n\t \n\trx_dly = 8 * (unsigned int)(dphy_clk_rate / (mipi_symbol_rate / 8));\n\n\t \n\tregmap_write(dphy->regs, SUN6I_DPHY_RX_TIME1_REG,\n\t\t     SUN6I_DPHY_RX_TIME1_RX_DLY(rx_dly) |\n\t\t     SUN6I_DPHY_RX_TIME1_LP_RX_ULPS_WP(255));\n\n\t \n\tregmap_write(dphy->regs, SUN6I_DPHY_RX_TIME2_REG,\n\t\t     SUN6I_DPHY_RX_TIME2_HS_RX_ANA0(4));\n\n\t \n\tlprst_dly = 4 * (unsigned int)(dphy_clk_rate / (mipi_symbol_rate / 2));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_RX_TIME3_REG,\n\t\t     SUN6I_DPHY_RX_TIME3_LPRST_DLY(lprst_dly));\n\n\t \n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA0_REG,\n\t\t     SUN6I_DPHY_ANA0_REG_PWS |\n\t\t     SUN6I_DPHY_ANA0_REG_SLV(7) |\n\t\t     SUN6I_DPHY_ANA0_REG_SFB(2));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA1_REG,\n\t\t     SUN6I_DPHY_ANA1_REG_SVTT(4));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA4_REG,\n\t\t     SUN6I_DPHY_ANA4_REG_DMPLVC |\n\t\t     SUN6I_DPHY_ANA4_REG_DMPLVD(1));\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA2_REG,\n\t\t     SUN6I_DPHY_ANA2_REG_ENIB);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA3_REG,\n\t\t     SUN6I_DPHY_ANA3_EN_LDOR |\n\t\t     SUN6I_DPHY_ANA3_EN_LDOC |\n\t\t     SUN6I_DPHY_ANA3_EN_LDOD);\n\n\t \n\tudelay(3);\n\n\tvalue = SUN6I_DPHY_RX_CTL_EN_DBC | SUN6I_DPHY_RX_CTL_RX_CLK_FORCE;\n\n\t \n\tif (dphy->config.lanes >= 1)\n\t\tvalue |= SUN6I_DPHY_RX_CTL_RX_D0_FORCE;\n\tif (dphy->config.lanes >= 2)\n\t\tvalue |= SUN6I_DPHY_RX_CTL_RX_D1_FORCE;\n\tif (dphy->config.lanes >= 3)\n\t\tvalue |= SUN6I_DPHY_RX_CTL_RX_D2_FORCE;\n\tif (dphy->config.lanes == 4)\n\t\tvalue |= SUN6I_DPHY_RX_CTL_RX_D3_FORCE;\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_RX_CTL_REG, value);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_GCTL_REG,\n\t\t     SUN6I_DPHY_GCTL_LANE_NUM(dphy->config.lanes) |\n\t\t     SUN6I_DPHY_GCTL_EN);\n\n\treturn 0;\n}\n\nstatic int sun6i_dphy_power_on(struct phy *phy)\n{\n\tstruct sun6i_dphy *dphy = phy_get_drvdata(phy);\n\n\tswitch (dphy->direction) {\n\tcase SUN6I_DPHY_DIRECTION_TX:\n\t\treturn sun6i_dphy_tx_power_on(dphy);\n\tcase SUN6I_DPHY_DIRECTION_RX:\n\t\treturn sun6i_dphy_rx_power_on(dphy);\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int sun6i_dphy_power_off(struct phy *phy)\n{\n\tstruct sun6i_dphy *dphy = phy_get_drvdata(phy);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_GCTL_REG, 0);\n\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA0_REG, 0);\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA1_REG, 0);\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA2_REG, 0);\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA3_REG, 0);\n\tregmap_write(dphy->regs, SUN6I_DPHY_ANA4_REG, 0);\n\n\treturn 0;\n}\n\nstatic int sun6i_dphy_exit(struct phy *phy)\n{\n\tstruct sun6i_dphy *dphy = phy_get_drvdata(phy);\n\n\tclk_rate_exclusive_put(dphy->mod_clk);\n\tclk_disable_unprepare(dphy->mod_clk);\n\treset_control_assert(dphy->reset);\n\n\treturn 0;\n}\n\n\nstatic const struct phy_ops sun6i_dphy_ops = {\n\t.configure\t= sun6i_dphy_configure,\n\t.power_on\t= sun6i_dphy_power_on,\n\t.power_off\t= sun6i_dphy_power_off,\n\t.init\t\t= sun6i_dphy_init,\n\t.exit\t\t= sun6i_dphy_exit,\n};\n\nstatic const struct regmap_config sun6i_dphy_regmap_config = {\n\t.reg_bits\t= 32,\n\t.val_bits\t= 32,\n\t.reg_stride\t= 4,\n\t.max_register\t= SUN50I_COMBO_PHY_REG2,\n\t.name\t\t= \"mipi-dphy\",\n};\n\nstatic int sun6i_dphy_probe(struct platform_device *pdev)\n{\n\tstruct phy_provider *phy_provider;\n\tstruct sun6i_dphy *dphy;\n\tconst char *direction;\n\tvoid __iomem *regs;\n\tint ret;\n\n\tdphy = devm_kzalloc(&pdev->dev, sizeof(*dphy), GFP_KERNEL);\n\tif (!dphy)\n\t\treturn -ENOMEM;\n\n\tdphy->variant = device_get_match_data(&pdev->dev);\n\tif (!dphy->variant)\n\t\treturn -EINVAL;\n\n\tregs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(regs)) {\n\t\tdev_err(&pdev->dev, \"Couldn't map the DPHY encoder registers\\n\");\n\t\treturn PTR_ERR(regs);\n\t}\n\n\tdphy->regs = devm_regmap_init_mmio_clk(&pdev->dev, \"bus\",\n\t\t\t\t\t       regs, &sun6i_dphy_regmap_config);\n\tif (IS_ERR(dphy->regs)) {\n\t\tdev_err(&pdev->dev, \"Couldn't create the DPHY encoder regmap\\n\");\n\t\treturn PTR_ERR(dphy->regs);\n\t}\n\n\tdphy->reset = devm_reset_control_get_shared(&pdev->dev, NULL);\n\tif (IS_ERR(dphy->reset)) {\n\t\tdev_err(&pdev->dev, \"Couldn't get our reset line\\n\");\n\t\treturn PTR_ERR(dphy->reset);\n\t}\n\n\tdphy->mod_clk = devm_clk_get(&pdev->dev, \"mod\");\n\tif (IS_ERR(dphy->mod_clk)) {\n\t\tdev_err(&pdev->dev, \"Couldn't get the DPHY mod clock\\n\");\n\t\treturn PTR_ERR(dphy->mod_clk);\n\t}\n\n\tdphy->phy = devm_phy_create(&pdev->dev, NULL, &sun6i_dphy_ops);\n\tif (IS_ERR(dphy->phy)) {\n\t\tdev_err(&pdev->dev, \"failed to create PHY\\n\");\n\t\treturn PTR_ERR(dphy->phy);\n\t}\n\n\tdphy->direction = SUN6I_DPHY_DIRECTION_TX;\n\n\tret = of_property_read_string(pdev->dev.of_node, \"allwinner,direction\",\n\t\t\t\t      &direction);\n\n\tif (!ret && !strncmp(direction, \"rx\", 2)) {\n\t\tif (!dphy->variant->rx_supported) {\n\t\t\tdev_err(&pdev->dev, \"RX not supported on this variant\\n\");\n\t\t\treturn -EOPNOTSUPP;\n\t\t}\n\n\t\tdphy->direction = SUN6I_DPHY_DIRECTION_RX;\n\t}\n\n\tphy_set_drvdata(dphy->phy, dphy);\n\tphy_provider = devm_of_phy_provider_register(&pdev->dev, of_phy_simple_xlate);\n\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct sun6i_dphy_variant sun6i_a31_mipi_dphy_variant = {\n\t.tx_power_on\t= sun6i_a31_mipi_dphy_tx_power_on,\n\t.rx_supported\t= true,\n};\n\nstatic const struct sun6i_dphy_variant sun50i_a100_mipi_dphy_variant = {\n\t.tx_power_on\t= sun50i_a100_mipi_dphy_tx_power_on,\n};\n\nstatic const struct of_device_id sun6i_dphy_of_table[] = {\n\t{\n\t\t.compatible\t= \"allwinner,sun6i-a31-mipi-dphy\",\n\t\t.data\t\t= &sun6i_a31_mipi_dphy_variant,\n\t},\n\t{\n\t\t.compatible\t= \"allwinner,sun50i-a100-mipi-dphy\",\n\t\t.data\t\t= &sun50i_a100_mipi_dphy_variant,\n\t},\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, sun6i_dphy_of_table);\n\nstatic struct platform_driver sun6i_dphy_platform_driver = {\n\t.probe\t\t= sun6i_dphy_probe,\n\t.driver\t\t= {\n\t\t.name\t\t= \"sun6i-mipi-dphy\",\n\t\t.of_match_table\t= sun6i_dphy_of_table,\n\t},\n};\nmodule_platform_driver(sun6i_dphy_platform_driver);\n\nMODULE_AUTHOR(\"Maxime Ripard <maxime.ripard@bootlin>\");\nMODULE_DESCRIPTION(\"Allwinner A31 MIPI D-PHY Driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}