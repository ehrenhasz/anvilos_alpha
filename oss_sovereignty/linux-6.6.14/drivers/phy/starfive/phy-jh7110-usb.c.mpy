{
  "module_name": "phy-jh7110-usb.c",
  "hash_id": "0265f9b9b32f341ee2790c52b38c1ff5d5068ee7d32adfcb7af1d3edb99d27fd",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/starfive/phy-jh7110-usb.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/clk.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/usb/of.h>\n\n#define USB_125M_CLK_RATE\t\t125000000\n#define USB_LS_KEEPALIVE_OFF\t\t0x4\n#define USB_LS_KEEPALIVE_ENABLE\t\tBIT(4)\n\nstruct jh7110_usb2_phy {\n\tstruct phy *phy;\n\tvoid __iomem *regs;\n\tstruct clk *usb_125m_clk;\n\tstruct clk *app_125m;\n\tenum phy_mode mode;\n};\n\nstatic void usb2_set_ls_keepalive(struct jh7110_usb2_phy *phy, bool set)\n{\n\tunsigned int val;\n\n\t \n\tval = readl(phy->regs + USB_LS_KEEPALIVE_OFF);\n\tif (set)\n\t\tval |= USB_LS_KEEPALIVE_ENABLE;\n\telse\n\t\tval &= ~USB_LS_KEEPALIVE_ENABLE;\n\n\twritel(val, phy->regs + USB_LS_KEEPALIVE_OFF);\n}\n\nstatic int usb2_phy_set_mode(struct phy *_phy,\n\t\t\t     enum phy_mode mode, int submode)\n{\n\tstruct jh7110_usb2_phy *phy = phy_get_drvdata(_phy);\n\n\tswitch (mode) {\n\tcase PHY_MODE_USB_HOST:\n\tcase PHY_MODE_USB_DEVICE:\n\tcase PHY_MODE_USB_OTG:\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (mode != phy->mode) {\n\t\tdev_dbg(&_phy->dev, \"Changing phy to %d\\n\", mode);\n\t\tphy->mode = mode;\n\t\tusb2_set_ls_keepalive(phy, (mode != PHY_MODE_USB_DEVICE));\n\t}\n\n\treturn 0;\n}\n\nstatic int jh7110_usb2_phy_init(struct phy *_phy)\n{\n\tstruct jh7110_usb2_phy *phy = phy_get_drvdata(_phy);\n\tint ret;\n\n\tret = clk_set_rate(phy->usb_125m_clk, USB_125M_CLK_RATE);\n\tif (ret)\n\t\treturn ret;\n\n\tret = clk_prepare_enable(phy->app_125m);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int jh7110_usb2_phy_exit(struct phy *_phy)\n{\n\tstruct jh7110_usb2_phy *phy = phy_get_drvdata(_phy);\n\n\tclk_disable_unprepare(phy->app_125m);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops jh7110_usb2_phy_ops = {\n\t.init\t\t= jh7110_usb2_phy_init,\n\t.exit\t\t= jh7110_usb2_phy_exit,\n\t.set_mode\t= usb2_phy_set_mode,\n\t.owner\t\t= THIS_MODULE,\n};\n\nstatic int jh7110_usb_phy_probe(struct platform_device *pdev)\n{\n\tstruct jh7110_usb2_phy *phy;\n\tstruct device *dev = &pdev->dev;\n\tstruct phy_provider *phy_provider;\n\n\tphy = devm_kzalloc(dev, sizeof(*phy), GFP_KERNEL);\n\tif (!phy)\n\t\treturn -ENOMEM;\n\n\tphy->usb_125m_clk = devm_clk_get(dev, \"125m\");\n\tif (IS_ERR(phy->usb_125m_clk))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy->usb_125m_clk),\n\t\t\t\"Failed to get 125m clock\\n\");\n\n\tphy->app_125m = devm_clk_get(dev, \"app_125m\");\n\tif (IS_ERR(phy->app_125m))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy->app_125m),\n\t\t\t\"Failed to get app 125m clock\\n\");\n\n\tphy->regs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(phy->regs))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy->regs),\n\t\t\t\"Failed to map phy base\\n\");\n\n\tphy->phy = devm_phy_create(dev, NULL, &jh7110_usb2_phy_ops);\n\tif (IS_ERR(phy->phy))\n\t\treturn dev_err_probe(dev, PTR_ERR(phy->phy),\n\t\t\t\"Failed to create phy\\n\");\n\n\tphy_set_drvdata(phy->phy, phy);\n\tphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\n\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct of_device_id jh7110_usb_phy_of_match[] = {\n\t{ .compatible = \"starfive,jh7110-usb-phy\" },\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, jh7110_usb_phy_of_match);\n\nstatic struct platform_driver jh7110_usb_phy_driver = {\n\t.probe\t= jh7110_usb_phy_probe,\n\t.driver = {\n\t\t.of_match_table\t= jh7110_usb_phy_of_match,\n\t\t.name  = \"jh7110-usb-phy\",\n\t}\n};\nmodule_platform_driver(jh7110_usb_phy_driver);\n\nMODULE_DESCRIPTION(\"StarFive JH7110 USB 2.0 PHY driver\");\nMODULE_AUTHOR(\"Minda Chen <minda.chen@starfivetech.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}