{
  "module_name": "phy-jh7110-dphy-rx.c",
  "hash_id": "f05066daa57ea922a24e8c81a96133d86a31be0ed2b71f61de2285ba4233efe2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/phy/starfive/phy-jh7110-dphy-rx.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/bitops.h>\n#include <linux/clk.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/phy/phy.h>\n#include <linux/platform_device.h>\n#include <linux/pm_runtime.h>\n#include <linux/reset.h>\n\n#define STF_DPHY_APBCFGSAIF_SYSCFG(x)\t\t(x)\n\n#define STF_DPHY_ENABLE_CLK\t\t\tBIT(6)\n#define STF_DPHY_ENABLE_CLK1\t\t\tBIT(7)\n#define STF_DPHY_ENABLE_LAN0\t\t\tBIT(8)\n#define STF_DPHY_ENABLE_LAN1\t\t\tBIT(9)\n#define STF_DPHY_ENABLE_LAN2\t\t\tBIT(10)\n#define STF_DPHY_ENABLE_LAN3\t\t\tBIT(11)\n#define STF_DPHY_LANE_SWAP_CLK\t\t\tGENMASK(22, 20)\n#define STF_DPHY_LANE_SWAP_CLK1\t\t\tGENMASK(25, 23)\n#define STF_DPHY_LANE_SWAP_LAN0\t\t\tGENMASK(28, 26)\n#define STF_DPHY_LANE_SWAP_LAN1\t\t\tGENMASK(31, 29)\n\n#define STF_DPHY_LANE_SWAP_LAN2\t\t\tGENMASK(2, 0)\n#define STF_DPHY_LANE_SWAP_LAN3\t\t\tGENMASK(5, 3)\n#define STF_DPHY_PLL_CLK_SEL\t\t\tGENMASK(21, 12)\n#define STF_DPHY_PRECOUNTER_IN_CLK\t\tGENMASK(29, 22)\n\n#define STF_DPHY_PRECOUNTER_IN_CLK1\t\tGENMASK(7, 0)\n#define STF_DPHY_PRECOUNTER_IN_LAN0\t\tGENMASK(15, 8)\n#define STF_DPHY_PRECOUNTER_IN_LAN1\t\tGENMASK(23, 16)\n#define STF_DPHY_PRECOUNTER_IN_LAN2\t\tGENMASK(31, 24)\n\n#define STF_DPHY_PRECOUNTER_IN_LAN3\t\tGENMASK(7, 0)\n#define STF_DPHY_RX_1C2C_SEL\t\t\tBIT(8)\n\n#define STF_MAP_LANES_NUM\t\t\t6\n\nstruct regval {\n\tu32 addr;\n\tu32 val;\n};\n\nstruct stf_dphy_info {\n\t \n\tu8 maps[STF_MAP_LANES_NUM];\n};\n\nstruct stf_dphy {\n\tstruct device *dev;\n\tvoid __iomem *regs;\n\tstruct clk *cfg_clk;\n\tstruct clk *ref_clk;\n\tstruct clk *tx_clk;\n\tstruct reset_control *rstc;\n\tstruct regulator *mipi_0p9;\n\tstruct phy *phy;\n\tconst struct stf_dphy_info *info;\n};\n\nstatic int stf_dphy_configure(struct phy *phy, union phy_configure_opts *opts)\n{\n\tstruct stf_dphy *dphy = phy_get_drvdata(phy);\n\tconst struct stf_dphy_info *info = dphy->info;\n\n\twritel(FIELD_PREP(STF_DPHY_ENABLE_CLK, 1) |\n\t       FIELD_PREP(STF_DPHY_ENABLE_CLK1, 1) |\n\t       FIELD_PREP(STF_DPHY_ENABLE_LAN0, 1) |\n\t       FIELD_PREP(STF_DPHY_ENABLE_LAN1, 1) |\n\t       FIELD_PREP(STF_DPHY_ENABLE_LAN2, 1) |\n\t       FIELD_PREP(STF_DPHY_ENABLE_LAN3, 1) |\n\t       FIELD_PREP(STF_DPHY_LANE_SWAP_CLK, info->maps[0]) |\n\t       FIELD_PREP(STF_DPHY_LANE_SWAP_CLK1, info->maps[5]) |\n\t       FIELD_PREP(STF_DPHY_LANE_SWAP_LAN0, info->maps[1]) |\n\t       FIELD_PREP(STF_DPHY_LANE_SWAP_LAN1, info->maps[2]),\n\t       dphy->regs + STF_DPHY_APBCFGSAIF_SYSCFG(188));\n\n\twritel(FIELD_PREP(STF_DPHY_LANE_SWAP_LAN2, info->maps[3]) |\n\t       FIELD_PREP(STF_DPHY_LANE_SWAP_LAN3, info->maps[4]) |\n\t       FIELD_PREP(STF_DPHY_PRECOUNTER_IN_CLK, 8),\n\t       dphy->regs + STF_DPHY_APBCFGSAIF_SYSCFG(192));\n\n\twritel(FIELD_PREP(STF_DPHY_PRECOUNTER_IN_CLK1, 8) |\n\t       FIELD_PREP(STF_DPHY_PRECOUNTER_IN_LAN0, 7) |\n\t       FIELD_PREP(STF_DPHY_PRECOUNTER_IN_LAN1, 7) |\n\t       FIELD_PREP(STF_DPHY_PRECOUNTER_IN_LAN2, 7),\n\t       dphy->regs + STF_DPHY_APBCFGSAIF_SYSCFG(196));\n\n\twritel(FIELD_PREP(STF_DPHY_PRECOUNTER_IN_LAN3, 7),\n\t       dphy->regs + STF_DPHY_APBCFGSAIF_SYSCFG(200));\n\n\treturn 0;\n}\n\nstatic int stf_dphy_power_on(struct phy *phy)\n{\n\tstruct stf_dphy *dphy = phy_get_drvdata(phy);\n\tint ret;\n\n\tret = pm_runtime_resume_and_get(dphy->dev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = regulator_enable(dphy->mipi_0p9);\n\tif (ret) {\n\t\tpm_runtime_put(dphy->dev);\n\t\treturn ret;\n\t}\n\n\tclk_set_rate(dphy->cfg_clk, 99000000);\n\tclk_set_rate(dphy->ref_clk, 49500000);\n\tclk_set_rate(dphy->tx_clk, 19800000);\n\treset_control_deassert(dphy->rstc);\n\n\treturn 0;\n}\n\nstatic int stf_dphy_power_off(struct phy *phy)\n{\n\tstruct stf_dphy *dphy = phy_get_drvdata(phy);\n\n\treset_control_assert(dphy->rstc);\n\n\tregulator_disable(dphy->mipi_0p9);\n\n\tpm_runtime_put_sync(dphy->dev);\n\n\treturn 0;\n}\n\nstatic const struct phy_ops stf_dphy_ops = {\n\t.configure = stf_dphy_configure,\n\t.power_on  = stf_dphy_power_on,\n\t.power_off = stf_dphy_power_off,\n};\n\nstatic int stf_dphy_probe(struct platform_device *pdev)\n{\n\tstruct phy_provider *phy_provider;\n\tstruct stf_dphy *dphy;\n\n\tdphy = devm_kzalloc(&pdev->dev, sizeof(*dphy), GFP_KERNEL);\n\tif (!dphy)\n\t\treturn -ENOMEM;\n\n\tdphy->info = of_device_get_match_data(&pdev->dev);\n\n\tdev_set_drvdata(&pdev->dev, dphy);\n\tdphy->dev = &pdev->dev;\n\n\tdphy->regs = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(dphy->regs))\n\t\treturn PTR_ERR(dphy->regs);\n\n\tdphy->cfg_clk = devm_clk_get(&pdev->dev, \"cfg\");\n\tif (IS_ERR(dphy->cfg_clk))\n\t\treturn PTR_ERR(dphy->cfg_clk);\n\n\tdphy->ref_clk = devm_clk_get(&pdev->dev, \"ref\");\n\tif (IS_ERR(dphy->ref_clk))\n\t\treturn PTR_ERR(dphy->ref_clk);\n\n\tdphy->tx_clk = devm_clk_get(&pdev->dev, \"tx\");\n\tif (IS_ERR(dphy->tx_clk))\n\t\treturn PTR_ERR(dphy->tx_clk);\n\n\tdphy->rstc = devm_reset_control_array_get_exclusive(&pdev->dev);\n\tif (IS_ERR(dphy->rstc))\n\t\treturn PTR_ERR(dphy->rstc);\n\n\tdphy->mipi_0p9 = devm_regulator_get(&pdev->dev, \"mipi_0p9\");\n\tif (IS_ERR(dphy->mipi_0p9))\n\t\treturn PTR_ERR(dphy->mipi_0p9);\n\n\tdphy->phy = devm_phy_create(&pdev->dev, NULL, &stf_dphy_ops);\n\tif (IS_ERR(dphy->phy)) {\n\t\tdev_err(&pdev->dev, \"Failed to create PHY\\n\");\n\t\treturn PTR_ERR(dphy->phy);\n\t}\n\n\tpm_runtime_enable(&pdev->dev);\n\n\tphy_set_drvdata(dphy->phy, dphy);\n\tphy_provider = devm_of_phy_provider_register(&pdev->dev,\n\t\t\t\t\t\t     of_phy_simple_xlate);\n\n\treturn PTR_ERR_OR_ZERO(phy_provider);\n}\n\nstatic const struct stf_dphy_info starfive_dphy_info = {\n\t.maps = {4, 0, 1, 2, 3, 5},\n};\n\nstatic const struct of_device_id stf_dphy_dt_ids[] = {\n\t{\n\t\t.compatible = \"starfive,jh7110-dphy-rx\",\n\t\t.data = &starfive_dphy_info,\n\t},\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, stf_dphy_dt_ids);\n\nstatic struct platform_driver stf_dphy_driver = {\n\t.probe = stf_dphy_probe,\n\t.driver = {\n\t\t.name\t= \"starfive-dphy-rx\",\n\t\t.of_match_table = stf_dphy_dt_ids,\n\t},\n};\nmodule_platform_driver(stf_dphy_driver);\n\nMODULE_AUTHOR(\"Jack Zhu <jack.zhu@starfivetech.com>\");\nMODULE_AUTHOR(\"Changhuang Liang <changhuang.liang@starfivetech.com>\");\nMODULE_DESCRIPTION(\"StarFive JH7110 DPHY RX driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}