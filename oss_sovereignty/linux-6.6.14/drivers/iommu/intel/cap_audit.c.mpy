{
  "module_name": "cap_audit.c",
  "hash_id": "22841274ce8872b4b0f0f23da9177d573886b833a7aeea466e4290baec205715",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iommu/intel/cap_audit.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt)\t\"DMAR: \" fmt\n\n#include \"iommu.h\"\n#include \"cap_audit.h\"\n\nstatic u64 intel_iommu_cap_sanity;\nstatic u64 intel_iommu_ecap_sanity;\n\nstatic inline void check_irq_capabilities(struct intel_iommu *a,\n\t\t\t\t\t  struct intel_iommu *b)\n{\n\tCHECK_FEATURE_MISMATCH(a, b, cap, pi_support, CAP_PI_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, eim_support, ECAP_EIM_MASK);\n}\n\nstatic inline void check_dmar_capabilities(struct intel_iommu *a,\n\t\t\t\t\t   struct intel_iommu *b)\n{\n\tMINIMAL_FEATURE_IOMMU(b, cap, CAP_MAMV_MASK);\n\tMINIMAL_FEATURE_IOMMU(b, cap, CAP_NFR_MASK);\n\tMINIMAL_FEATURE_IOMMU(b, cap, CAP_SLLPS_MASK);\n\tMINIMAL_FEATURE_IOMMU(b, cap, CAP_FRO_MASK);\n\tMINIMAL_FEATURE_IOMMU(b, cap, CAP_MGAW_MASK);\n\tMINIMAL_FEATURE_IOMMU(b, cap, CAP_SAGAW_MASK);\n\tMINIMAL_FEATURE_IOMMU(b, cap, CAP_NDOMS_MASK);\n\tMINIMAL_FEATURE_IOMMU(b, ecap, ECAP_PSS_MASK);\n\tMINIMAL_FEATURE_IOMMU(b, ecap, ECAP_MHMV_MASK);\n\tMINIMAL_FEATURE_IOMMU(b, ecap, ECAP_IRO_MASK);\n\n\tCHECK_FEATURE_MISMATCH(a, b, cap, fl5lp_support, CAP_FL5LP_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, cap, fl1gp_support, CAP_FL1GP_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, cap, read_drain, CAP_RD_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, cap, write_drain, CAP_WD_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, cap, pgsel_inv, CAP_PSI_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, cap, zlr, CAP_ZLR_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, cap, caching_mode, CAP_CM_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, cap, phmr, CAP_PHMR_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, cap, plmr, CAP_PLMR_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, cap, rwbf, CAP_RWBF_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, cap, afl, CAP_AFL_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, rps, ECAP_RPS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, smpwc, ECAP_SMPWC_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, flts, ECAP_FLTS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, slts, ECAP_SLTS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, nwfs, ECAP_NWFS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, slads, ECAP_SLADS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, smts, ECAP_SMTS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, pds, ECAP_PDS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, dit, ECAP_DIT_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, pasid, ECAP_PASID_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, eafs, ECAP_EAFS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, srs, ECAP_SRS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, ers, ECAP_ERS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, prs, ECAP_PRS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, nest, ECAP_NEST_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, mts, ECAP_MTS_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, sc_support, ECAP_SC_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, pass_through, ECAP_PT_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, dev_iotlb_support, ECAP_DT_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, qis, ECAP_QI_MASK);\n\tCHECK_FEATURE_MISMATCH(a, b, ecap, coherent, ECAP_C_MASK);\n}\n\nstatic int cap_audit_hotplug(struct intel_iommu *iommu, enum cap_audit_type type)\n{\n\tbool mismatch = false;\n\tu64 old_cap = intel_iommu_cap_sanity;\n\tu64 old_ecap = intel_iommu_ecap_sanity;\n\n\tif (type == CAP_AUDIT_HOTPLUG_IRQR) {\n\t\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, pi_support, CAP_PI_MASK);\n\t\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, eim_support, ECAP_EIM_MASK);\n\t\tgoto out;\n\t}\n\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, fl5lp_support, CAP_FL5LP_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, fl1gp_support, CAP_FL1GP_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, read_drain, CAP_RD_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, write_drain, CAP_WD_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, pgsel_inv, CAP_PSI_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, zlr, CAP_ZLR_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, caching_mode, CAP_CM_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, phmr, CAP_PHMR_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, plmr, CAP_PLMR_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, rwbf, CAP_RWBF_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, cap, afl, CAP_AFL_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, rps, ECAP_RPS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, smpwc, ECAP_SMPWC_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, flts, ECAP_FLTS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, slts, ECAP_SLTS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, nwfs, ECAP_NWFS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, slads, ECAP_SLADS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, smts, ECAP_SMTS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, pds, ECAP_PDS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, dit, ECAP_DIT_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, pasid, ECAP_PASID_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, eafs, ECAP_EAFS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, srs, ECAP_SRS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, ers, ECAP_ERS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, prs, ECAP_PRS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, nest, ECAP_NEST_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, mts, ECAP_MTS_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, sc_support, ECAP_SC_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, pass_through, ECAP_PT_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, dev_iotlb_support, ECAP_DT_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, qis, ECAP_QI_MASK);\n\tCHECK_FEATURE_MISMATCH_HOTPLUG(iommu, ecap, coherent, ECAP_C_MASK);\n\n\t \n\tMINIMAL_FEATURE_HOTPLUG(iommu, cap, max_amask_val, CAP_MAMV_MASK, mismatch);\n\tMINIMAL_FEATURE_HOTPLUG(iommu, cap, num_fault_regs, CAP_NFR_MASK, mismatch);\n\tMINIMAL_FEATURE_HOTPLUG(iommu, cap, super_page_val, CAP_SLLPS_MASK, mismatch);\n\tMINIMAL_FEATURE_HOTPLUG(iommu, cap, fault_reg_offset, CAP_FRO_MASK, mismatch);\n\tMINIMAL_FEATURE_HOTPLUG(iommu, cap, mgaw, CAP_MGAW_MASK, mismatch);\n\tMINIMAL_FEATURE_HOTPLUG(iommu, cap, sagaw, CAP_SAGAW_MASK, mismatch);\n\tMINIMAL_FEATURE_HOTPLUG(iommu, cap, ndoms, CAP_NDOMS_MASK, mismatch);\n\tMINIMAL_FEATURE_HOTPLUG(iommu, ecap, pss, ECAP_PSS_MASK, mismatch);\n\tMINIMAL_FEATURE_HOTPLUG(iommu, ecap, max_handle_mask, ECAP_MHMV_MASK, mismatch);\n\tMINIMAL_FEATURE_HOTPLUG(iommu, ecap, iotlb_offset, ECAP_IRO_MASK, mismatch);\n\nout:\n\tif (mismatch) {\n\t\tintel_iommu_cap_sanity = old_cap;\n\t\tintel_iommu_ecap_sanity = old_ecap;\n\t\treturn -EFAULT;\n\t}\n\n\treturn 0;\n}\n\nstatic int cap_audit_static(struct intel_iommu *iommu, enum cap_audit_type type)\n{\n\tstruct dmar_drhd_unit *d;\n\tstruct intel_iommu *i;\n\tint rc = 0;\n\n\trcu_read_lock();\n\tif (list_empty(&dmar_drhd_units))\n\t\tgoto out;\n\n\tfor_each_active_iommu(i, d) {\n\t\tif (!iommu) {\n\t\t\tintel_iommu_ecap_sanity = i->ecap;\n\t\t\tintel_iommu_cap_sanity = i->cap;\n\t\t\tiommu = i;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (type == CAP_AUDIT_STATIC_DMAR)\n\t\t\tcheck_dmar_capabilities(iommu, i);\n\t\telse\n\t\t\tcheck_irq_capabilities(iommu, i);\n\t}\n\n\t \n\tif (intel_cap_smts_sanity() &&\n\t    !intel_cap_flts_sanity() && !intel_cap_slts_sanity())\n\t\trc = -EOPNOTSUPP;\n\nout:\n\trcu_read_unlock();\n\treturn rc;\n}\n\nint intel_cap_audit(enum cap_audit_type type, struct intel_iommu *iommu)\n{\n\tswitch (type) {\n\tcase CAP_AUDIT_STATIC_DMAR:\n\tcase CAP_AUDIT_STATIC_IRQR:\n\t\treturn cap_audit_static(iommu, type);\n\tcase CAP_AUDIT_HOTPLUG_DMAR:\n\tcase CAP_AUDIT_HOTPLUG_IRQR:\n\t\treturn cap_audit_hotplug(iommu, type);\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn -EFAULT;\n}\n\nbool intel_cap_smts_sanity(void)\n{\n\treturn ecap_smts(intel_iommu_ecap_sanity);\n}\n\nbool intel_cap_pasid_sanity(void)\n{\n\treturn ecap_pasid(intel_iommu_ecap_sanity);\n}\n\nbool intel_cap_nest_sanity(void)\n{\n\treturn ecap_nest(intel_iommu_ecap_sanity);\n}\n\nbool intel_cap_flts_sanity(void)\n{\n\treturn ecap_flts(intel_iommu_ecap_sanity);\n}\n\nbool intel_cap_slts_sanity(void)\n{\n\treturn ecap_slts(intel_iommu_ecap_sanity);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}