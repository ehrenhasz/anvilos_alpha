{
  "module_name": "iommu-sysfs.c",
  "hash_id": "9f3ac88d5e80f37e357c3374a8b93a5175f430565e1f1e9727282d0ab32a8fab",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iommu/iommu-sysfs.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/iommu.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n\n \nstatic struct attribute *devices_attr[] = {\n\tNULL,\n};\n\nstatic const struct attribute_group devices_attr_group = {\n\t.name = \"devices\",\n\t.attrs = devices_attr,\n};\n\nstatic const struct attribute_group *dev_groups[] = {\n\t&devices_attr_group,\n\tNULL,\n};\n\nstatic void release_device(struct device *dev)\n{\n\tkfree(dev);\n}\n\nstatic struct class iommu_class = {\n\t.name = \"iommu\",\n\t.dev_release = release_device,\n\t.dev_groups = dev_groups,\n};\n\nstatic int __init iommu_dev_init(void)\n{\n\treturn class_register(&iommu_class);\n}\npostcore_initcall(iommu_dev_init);\n\n \nint iommu_device_sysfs_add(struct iommu_device *iommu,\n\t\t\t   struct device *parent,\n\t\t\t   const struct attribute_group **groups,\n\t\t\t   const char *fmt, ...)\n{\n\tva_list vargs;\n\tint ret;\n\n\tiommu->dev = kzalloc(sizeof(*iommu->dev), GFP_KERNEL);\n\tif (!iommu->dev)\n\t\treturn -ENOMEM;\n\n\tdevice_initialize(iommu->dev);\n\n\tiommu->dev->class = &iommu_class;\n\tiommu->dev->parent = parent;\n\tiommu->dev->groups = groups;\n\n\tva_start(vargs, fmt);\n\tret = kobject_set_name_vargs(&iommu->dev->kobj, fmt, vargs);\n\tva_end(vargs);\n\tif (ret)\n\t\tgoto error;\n\n\tret = device_add(iommu->dev);\n\tif (ret)\n\t\tgoto error;\n\n\tdev_set_drvdata(iommu->dev, iommu);\n\n\treturn 0;\n\nerror:\n\tput_device(iommu->dev);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(iommu_device_sysfs_add);\n\nvoid iommu_device_sysfs_remove(struct iommu_device *iommu)\n{\n\tdev_set_drvdata(iommu->dev, NULL);\n\tdevice_unregister(iommu->dev);\n\tiommu->dev = NULL;\n}\nEXPORT_SYMBOL_GPL(iommu_device_sysfs_remove);\n\n \nint iommu_device_link(struct iommu_device *iommu, struct device *link)\n{\n\tint ret;\n\n\tret = sysfs_add_link_to_group(&iommu->dev->kobj, \"devices\",\n\t\t\t\t      &link->kobj, dev_name(link));\n\tif (ret)\n\t\treturn ret;\n\n\tret = sysfs_create_link_nowarn(&link->kobj, &iommu->dev->kobj, \"iommu\");\n\tif (ret)\n\t\tsysfs_remove_link_from_group(&iommu->dev->kobj, \"devices\",\n\t\t\t\t\t     dev_name(link));\n\n\treturn ret;\n}\n\nvoid iommu_device_unlink(struct iommu_device *iommu, struct device *link)\n{\n\tsysfs_remove_link(&link->kobj, \"iommu\");\n\tsysfs_remove_link_from_group(&iommu->dev->kobj, \"devices\", dev_name(link));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}