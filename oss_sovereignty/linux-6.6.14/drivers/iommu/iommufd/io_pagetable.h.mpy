{
  "module_name": "io_pagetable.h",
  "hash_id": "742e970c4a175c374c47ee4b00359fb0b1426e9a7bf5cc8f6461ae164345414e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/iommu/iommufd/io_pagetable.h",
  "human_readable_source": " \n \n#ifndef __IO_PAGETABLE_H\n#define __IO_PAGETABLE_H\n\n#include <linux/interval_tree.h>\n#include <linux/mutex.h>\n#include <linux/kref.h>\n#include <linux/xarray.h>\n\n#include \"iommufd_private.h\"\n\nstruct iommu_domain;\n\n \nstruct iopt_area {\n\tstruct interval_tree_node node;\n\tstruct interval_tree_node pages_node;\n\tstruct io_pagetable *iopt;\n\tstruct iopt_pages *pages;\n\tstruct iommu_domain *storage_domain;\n\t \n\tunsigned int page_offset;\n\t \n\tint iommu_prot;\n\tbool prevent_access : 1;\n\tunsigned int num_accesses;\n};\n\nstruct iopt_allowed {\n\tstruct interval_tree_node node;\n};\n\nstruct iopt_reserved {\n\tstruct interval_tree_node node;\n\tvoid *owner;\n};\n\nint iopt_area_fill_domains(struct iopt_area *area, struct iopt_pages *pages);\nvoid iopt_area_unfill_domains(struct iopt_area *area, struct iopt_pages *pages);\n\nint iopt_area_fill_domain(struct iopt_area *area, struct iommu_domain *domain);\nvoid iopt_area_unfill_domain(struct iopt_area *area, struct iopt_pages *pages,\n\t\t\t     struct iommu_domain *domain);\nvoid iopt_area_unmap_domain(struct iopt_area *area,\n\t\t\t    struct iommu_domain *domain);\n\nstatic inline unsigned long iopt_area_index(struct iopt_area *area)\n{\n\treturn area->pages_node.start;\n}\n\nstatic inline unsigned long iopt_area_last_index(struct iopt_area *area)\n{\n\treturn area->pages_node.last;\n}\n\nstatic inline unsigned long iopt_area_iova(struct iopt_area *area)\n{\n\treturn area->node.start;\n}\n\nstatic inline unsigned long iopt_area_last_iova(struct iopt_area *area)\n{\n\treturn area->node.last;\n}\n\nstatic inline size_t iopt_area_length(struct iopt_area *area)\n{\n\treturn (area->node.last - area->node.start) + 1;\n}\n\n \nstatic inline unsigned long iopt_area_start_byte(struct iopt_area *area,\n\t\t\t\t\t\t unsigned long iova)\n{\n\tif (IS_ENABLED(CONFIG_IOMMUFD_TEST))\n\t\tWARN_ON(iova < iopt_area_iova(area) ||\n\t\t\tiova > iopt_area_last_iova(area));\n\treturn (iova - iopt_area_iova(area)) + area->page_offset +\n\t       iopt_area_index(area) * PAGE_SIZE;\n}\n\nstatic inline unsigned long iopt_area_iova_to_index(struct iopt_area *area,\n\t\t\t\t\t\t    unsigned long iova)\n{\n\treturn iopt_area_start_byte(area, iova) / PAGE_SIZE;\n}\n\n#define __make_iopt_iter(name)                                                 \\\n\tstatic inline struct iopt_##name *iopt_##name##_iter_first(            \\\n\t\tstruct io_pagetable *iopt, unsigned long start,                \\\n\t\tunsigned long last)                                            \\\n\t{                                                                      \\\n\t\tstruct interval_tree_node *node;                               \\\n\t\t\t\t\t\t\t\t\t       \\\n\t\tlockdep_assert_held(&iopt->iova_rwsem);                        \\\n\t\tnode = interval_tree_iter_first(&iopt->name##_itree, start,    \\\n\t\t\t\t\t\tlast);                         \\\n\t\tif (!node)                                                     \\\n\t\t\treturn NULL;                                           \\\n\t\treturn container_of(node, struct iopt_##name, node);           \\\n\t}                                                                      \\\n\tstatic inline struct iopt_##name *iopt_##name##_iter_next(             \\\n\t\tstruct iopt_##name *last_node, unsigned long start,            \\\n\t\tunsigned long last)                                            \\\n\t{                                                                      \\\n\t\tstruct interval_tree_node *node;                               \\\n\t\t\t\t\t\t\t\t\t       \\\n\t\tnode = interval_tree_iter_next(&last_node->node, start, last); \\\n\t\tif (!node)                                                     \\\n\t\t\treturn NULL;                                           \\\n\t\treturn container_of(node, struct iopt_##name, node);           \\\n\t}\n\n__make_iopt_iter(area)\n__make_iopt_iter(allowed)\n__make_iopt_iter(reserved)\n\nstruct iopt_area_contig_iter {\n\tunsigned long cur_iova;\n\tunsigned long last_iova;\n\tstruct iopt_area *area;\n};\nstruct iopt_area *iopt_area_contig_init(struct iopt_area_contig_iter *iter,\n\t\t\t\t\tstruct io_pagetable *iopt,\n\t\t\t\t\tunsigned long iova,\n\t\t\t\t\tunsigned long last_iova);\nstruct iopt_area *iopt_area_contig_next(struct iopt_area_contig_iter *iter);\n\nstatic inline bool iopt_area_contig_done(struct iopt_area_contig_iter *iter)\n{\n\treturn iter->area && iter->last_iova <= iopt_area_last_iova(iter->area);\n}\n\n \n#define iopt_for_each_contig_area(iter, area, iopt, iova, last_iova)          \\\n\tfor (area = iopt_area_contig_init(iter, iopt, iova, last_iova); area; \\\n\t     area = iopt_area_contig_next(iter))\n\nenum {\n\tIOPT_PAGES_ACCOUNT_NONE = 0,\n\tIOPT_PAGES_ACCOUNT_USER = 1,\n\tIOPT_PAGES_ACCOUNT_MM = 2,\n};\n\n \nstruct iopt_pages {\n\tstruct kref kref;\n\tstruct mutex mutex;\n\tsize_t npages;\n\tsize_t npinned;\n\tsize_t last_npinned;\n\tstruct task_struct *source_task;\n\tstruct mm_struct *source_mm;\n\tstruct user_struct *source_user;\n\tvoid __user *uptr;\n\tbool writable:1;\n\tu8 account_mode;\n\n\tstruct xarray pinned_pfns;\n\t \n\tstruct rb_root_cached access_itree;\n\t \n\tstruct rb_root_cached domains_itree;\n};\n\nstruct iopt_pages *iopt_alloc_pages(void __user *uptr, unsigned long length,\n\t\t\t\t    bool writable);\nvoid iopt_release_pages(struct kref *kref);\nstatic inline void iopt_put_pages(struct iopt_pages *pages)\n{\n\tkref_put(&pages->kref, iopt_release_pages);\n}\n\nvoid iopt_pages_fill_from_xarray(struct iopt_pages *pages, unsigned long start,\n\t\t\t\t unsigned long last, struct page **out_pages);\nint iopt_pages_fill_xarray(struct iopt_pages *pages, unsigned long start,\n\t\t\t   unsigned long last, struct page **out_pages);\nvoid iopt_pages_unfill_xarray(struct iopt_pages *pages, unsigned long start,\n\t\t\t      unsigned long last);\n\nint iopt_area_add_access(struct iopt_area *area, unsigned long start,\n\t\t\t unsigned long last, struct page **out_pages,\n\t\t\t unsigned int flags);\nvoid iopt_area_remove_access(struct iopt_area *area, unsigned long start,\n\t\t\t    unsigned long last);\nint iopt_pages_rw_access(struct iopt_pages *pages, unsigned long start_byte,\n\t\t\t void *data, unsigned long length, unsigned int flags);\n\n \nstruct iopt_pages_access {\n\tstruct interval_tree_node node;\n\tunsigned int users;\n};\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}