{
  "module_name": "scan.c",
  "hash_id": "c933aad7c774518177fa43c8c0379effe83331a34518d531fb547a0b3b5bfb73",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ssb/scan.c",
  "human_readable_source": " \n\n#include \"ssb_private.h\"\n\n#include <linux/ssb/ssb.h>\n#include <linux/ssb/ssb_regs.h>\n#include <linux/pci.h>\n#include <linux/io.h>\n\n#include <pcmcia/cistpl.h>\n#include <pcmcia/ds.h>\n\n\nconst char *ssb_core_name(u16 coreid)\n{\n\tswitch (coreid) {\n\tcase SSB_DEV_CHIPCOMMON:\n\t\treturn \"ChipCommon\";\n\tcase SSB_DEV_ILINE20:\n\t\treturn \"ILine 20\";\n\tcase SSB_DEV_SDRAM:\n\t\treturn \"SDRAM\";\n\tcase SSB_DEV_PCI:\n\t\treturn \"PCI\";\n\tcase SSB_DEV_MIPS:\n\t\treturn \"MIPS\";\n\tcase SSB_DEV_ETHERNET:\n\t\treturn \"Fast Ethernet\";\n\tcase SSB_DEV_V90:\n\t\treturn \"V90\";\n\tcase SSB_DEV_USB11_HOSTDEV:\n\t\treturn \"USB 1.1 Hostdev\";\n\tcase SSB_DEV_ADSL:\n\t\treturn \"ADSL\";\n\tcase SSB_DEV_ILINE100:\n\t\treturn \"ILine 100\";\n\tcase SSB_DEV_IPSEC:\n\t\treturn \"IPSEC\";\n\tcase SSB_DEV_PCMCIA:\n\t\treturn \"PCMCIA\";\n\tcase SSB_DEV_INTERNAL_MEM:\n\t\treturn \"Internal Memory\";\n\tcase SSB_DEV_MEMC_SDRAM:\n\t\treturn \"MEMC SDRAM\";\n\tcase SSB_DEV_EXTIF:\n\t\treturn \"EXTIF\";\n\tcase SSB_DEV_80211:\n\t\treturn \"IEEE 802.11\";\n\tcase SSB_DEV_MIPS_3302:\n\t\treturn \"MIPS 3302\";\n\tcase SSB_DEV_USB11_HOST:\n\t\treturn \"USB 1.1 Host\";\n\tcase SSB_DEV_USB11_DEV:\n\t\treturn \"USB 1.1 Device\";\n\tcase SSB_DEV_USB20_HOST:\n\t\treturn \"USB 2.0 Host\";\n\tcase SSB_DEV_USB20_DEV:\n\t\treturn \"USB 2.0 Device\";\n\tcase SSB_DEV_SDIO_HOST:\n\t\treturn \"SDIO Host\";\n\tcase SSB_DEV_ROBOSWITCH:\n\t\treturn \"Roboswitch\";\n\tcase SSB_DEV_PARA_ATA:\n\t\treturn \"PATA\";\n\tcase SSB_DEV_SATA_XORDMA:\n\t\treturn \"SATA XOR-DMA\";\n\tcase SSB_DEV_ETHERNET_GBIT:\n\t\treturn \"GBit Ethernet\";\n\tcase SSB_DEV_PCIE:\n\t\treturn \"PCI-E\";\n\tcase SSB_DEV_MIMO_PHY:\n\t\treturn \"MIMO PHY\";\n\tcase SSB_DEV_SRAM_CTRLR:\n\t\treturn \"SRAM Controller\";\n\tcase SSB_DEV_MINI_MACPHY:\n\t\treturn \"Mini MACPHY\";\n\tcase SSB_DEV_ARM_1176:\n\t\treturn \"ARM 1176\";\n\tcase SSB_DEV_ARM_7TDMI:\n\t\treturn \"ARM 7TDMI\";\n\tcase SSB_DEV_ARM_CM3:\n\t\treturn \"ARM Cortex M3\";\n\t}\n\treturn \"UNKNOWN\";\n}\n\nstatic u16 pcidev_to_chipid(struct pci_dev *pci_dev)\n{\n\tu16 chipid_fallback = 0;\n\n\tswitch (pci_dev->device) {\n\tcase 0x4301:\n\t\tchipid_fallback = 0x4301;\n\t\tbreak;\n\tcase 0x4305 ... 0x4307:\n\t\tchipid_fallback = 0x4307;\n\t\tbreak;\n\tcase 0x4403:\n\t\tchipid_fallback = 0x4402;\n\t\tbreak;\n\tcase 0x4610 ... 0x4615:\n\t\tchipid_fallback = 0x4610;\n\t\tbreak;\n\tcase 0x4710 ... 0x4715:\n\t\tchipid_fallback = 0x4710;\n\t\tbreak;\n\tcase 0x4320 ... 0x4325:\n\t\tchipid_fallback = 0x4309;\n\t\tbreak;\n\tcase PCI_DEVICE_ID_BCM4401:\n\tcase PCI_DEVICE_ID_BCM4401B0:\n\tcase PCI_DEVICE_ID_BCM4401B1:\n\t\tchipid_fallback = 0x4401;\n\t\tbreak;\n\tdefault:\n\t\tdev_err(&pci_dev->dev, \"PCI-ID not in fallback list\\n\");\n\t}\n\n\treturn chipid_fallback;\n}\n\nstatic u8 chipid_to_nrcores(u16 chipid)\n{\n\tswitch (chipid) {\n\tcase 0x5365:\n\t\treturn 7;\n\tcase 0x4306:\n\t\treturn 6;\n\tcase 0x4310:\n\t\treturn 8;\n\tcase 0x4307:\n\tcase 0x4301:\n\t\treturn 5;\n\tcase 0x4401:\n\tcase 0x4402:\n\t\treturn 3;\n\tcase 0x4710:\n\tcase 0x4610:\n\tcase 0x4704:\n\t\treturn 9;\n\tdefault:\n\t\tpr_err(\"CHIPID not in nrcores fallback list\\n\");\n\t}\n\n\treturn 1;\n}\n\nstatic u32 scan_read32(struct ssb_bus *bus, u8 current_coreidx,\n\t\t       u16 offset)\n{\n\tu32 lo, hi;\n\n\tswitch (bus->bustype) {\n\tcase SSB_BUSTYPE_SSB:\n\t\toffset += current_coreidx * SSB_CORE_SIZE;\n\t\tbreak;\n\tcase SSB_BUSTYPE_PCI:\n\t\tbreak;\n\tcase SSB_BUSTYPE_PCMCIA:\n\t\tif (offset >= 0x800) {\n\t\t\tssb_pcmcia_switch_segment(bus, 1);\n\t\t\toffset -= 0x800;\n\t\t} else\n\t\t\tssb_pcmcia_switch_segment(bus, 0);\n\t\tlo = readw(bus->mmio + offset);\n\t\thi = readw(bus->mmio + offset + 2);\n\t\treturn lo | (hi << 16);\n\tcase SSB_BUSTYPE_SDIO:\n\t\toffset += current_coreidx * SSB_CORE_SIZE;\n\t\treturn ssb_sdio_scan_read32(bus, offset);\n\t}\n\treturn readl(bus->mmio + offset);\n}\n\nstatic int scan_switchcore(struct ssb_bus *bus, u8 coreidx)\n{\n\tswitch (bus->bustype) {\n\tcase SSB_BUSTYPE_SSB:\n\t\tbreak;\n\tcase SSB_BUSTYPE_PCI:\n\t\treturn ssb_pci_switch_coreidx(bus, coreidx);\n\tcase SSB_BUSTYPE_PCMCIA:\n\t\treturn ssb_pcmcia_switch_coreidx(bus, coreidx);\n\tcase SSB_BUSTYPE_SDIO:\n\t\treturn ssb_sdio_scan_switch_coreidx(bus, coreidx);\n\t}\n\treturn 0;\n}\n\nvoid ssb_iounmap(struct ssb_bus *bus)\n{\n\tswitch (bus->bustype) {\n\tcase SSB_BUSTYPE_SSB:\n\tcase SSB_BUSTYPE_PCMCIA:\n\t\tiounmap(bus->mmio);\n\t\tbreak;\n\tcase SSB_BUSTYPE_PCI:\n#ifdef CONFIG_SSB_PCIHOST\n\t\tpci_iounmap(bus->host_pci, bus->mmio);\n#else\n\t\tWARN_ON(1);  \n#endif\n\t\tbreak;\n\tcase SSB_BUSTYPE_SDIO:\n\t\tbreak;\n\t}\n\tbus->mmio = NULL;\n\tbus->mapped_device = NULL;\n}\n\nstatic void __iomem *ssb_ioremap(struct ssb_bus *bus,\n\t\t\t\t unsigned long baseaddr)\n{\n\tvoid __iomem *mmio = NULL;\n\n\tswitch (bus->bustype) {\n\tcase SSB_BUSTYPE_SSB:\n\t\t \n\t\tfallthrough;\n\tcase SSB_BUSTYPE_PCMCIA:\n\t\tmmio = ioremap(baseaddr, SSB_CORE_SIZE);\n\t\tbreak;\n\tcase SSB_BUSTYPE_PCI:\n#ifdef CONFIG_SSB_PCIHOST\n\t\tmmio = pci_iomap(bus->host_pci, 0, ~0UL);\n#else\n\t\tWARN_ON(1);  \n#endif\n\t\tbreak;\n\tcase SSB_BUSTYPE_SDIO:\n\t\t \n\t\tmmio = (void __iomem *)baseaddr;\n\t\tbreak;\n\t}\n\n\treturn mmio;\n}\n\nstatic int we_support_multiple_80211_cores(struct ssb_bus *bus)\n{\n\t \n\n#ifdef CONFIG_SSB_PCIHOST\n\tif (bus->bustype == SSB_BUSTYPE_PCI) {\n\t\tif (bus->host_pci->vendor == PCI_VENDOR_ID_BROADCOM &&\n\t\t    ((bus->host_pci->device == 0x4313) ||\n\t\t     (bus->host_pci->device == 0x431A) ||\n\t\t     (bus->host_pci->device == 0x4321) ||\n\t\t     (bus->host_pci->device == 0x4324)))\n\t\t\treturn 1;\n\t}\n#endif  \n\treturn 0;\n}\n\nint ssb_bus_scan(struct ssb_bus *bus,\n\t\t unsigned long baseaddr)\n{\n\tint err = -ENOMEM;\n\tvoid __iomem *mmio;\n\tu32 idhi, cc, rev, tmp;\n\tint dev_i, i;\n\tstruct ssb_device *dev;\n\tint nr_80211_cores = 0;\n\n\tmmio = ssb_ioremap(bus, baseaddr);\n\tif (!mmio)\n\t\tgoto out;\n\tbus->mmio = mmio;\n\n\terr = scan_switchcore(bus, 0);  \n\tif (err)\n\t\tgoto err_unmap;\n\n\tidhi = scan_read32(bus, 0, SSB_IDHIGH);\n\tcc = (idhi & SSB_IDHIGH_CC) >> SSB_IDHIGH_CC_SHIFT;\n\trev = (idhi & SSB_IDHIGH_RCLO);\n\trev |= (idhi & SSB_IDHIGH_RCHI) >> SSB_IDHIGH_RCHI_SHIFT;\n\n\tbus->nr_devices = 0;\n\tif (cc == SSB_DEV_CHIPCOMMON) {\n\t\ttmp = scan_read32(bus, 0, SSB_CHIPCO_CHIPID);\n\n\t\tbus->chip_id = (tmp & SSB_CHIPCO_IDMASK);\n\t\tbus->chip_rev = (tmp & SSB_CHIPCO_REVMASK) >>\n\t\t\t\tSSB_CHIPCO_REVSHIFT;\n\t\tbus->chip_package = (tmp & SSB_CHIPCO_PACKMASK) >>\n\t\t\t\t    SSB_CHIPCO_PACKSHIFT;\n\t\tif (rev >= 4) {\n\t\t\tbus->nr_devices = (tmp & SSB_CHIPCO_NRCORESMASK) >>\n\t\t\t\t\t  SSB_CHIPCO_NRCORESSHIFT;\n\t\t}\n\t\ttmp = scan_read32(bus, 0, SSB_CHIPCO_CAP);\n\t\tbus->chipco.capabilities = tmp;\n\t} else {\n\t\tif (bus->bustype == SSB_BUSTYPE_PCI) {\n\t\t\tbus->chip_id = pcidev_to_chipid(bus->host_pci);\n\t\t\tbus->chip_rev = bus->host_pci->revision;\n\t\t\tbus->chip_package = 0;\n\t\t} else {\n\t\t\tbus->chip_id = 0x4710;\n\t\t\tbus->chip_rev = 0;\n\t\t\tbus->chip_package = 0;\n\t\t}\n\t}\n\tpr_info(\"Found chip with id 0x%04X, rev 0x%02X and package 0x%02X\\n\",\n\t\tbus->chip_id, bus->chip_rev, bus->chip_package);\n\tif (!bus->nr_devices)\n\t\tbus->nr_devices = chipid_to_nrcores(bus->chip_id);\n\tif (bus->nr_devices > ARRAY_SIZE(bus->devices)) {\n\t\tpr_err(\"More than %d ssb cores found (%d)\\n\",\n\t\t       SSB_MAX_NR_CORES, bus->nr_devices);\n\t\terr = -EINVAL;\n\t\tgoto err_unmap;\n\t}\n\tif (bus->bustype == SSB_BUSTYPE_SSB) {\n\t\t \n\t\terr = -ENOMEM;\n\t\tiounmap(mmio);\n\t\tmmio = ioremap(baseaddr, SSB_CORE_SIZE * bus->nr_devices);\n\t\tif (!mmio)\n\t\t\tgoto out;\n\t\tbus->mmio = mmio;\n\t}\n\n\t \n\tfor (i = 0, dev_i = 0; i < bus->nr_devices; i++) {\n\t\terr = scan_switchcore(bus, i);\n\t\tif (err)\n\t\t\tgoto err_unmap;\n\t\tdev = &(bus->devices[dev_i]);\n\n\t\tidhi = scan_read32(bus, i, SSB_IDHIGH);\n\t\tdev->id.coreid = (idhi & SSB_IDHIGH_CC) >> SSB_IDHIGH_CC_SHIFT;\n\t\tdev->id.revision = (idhi & SSB_IDHIGH_RCLO);\n\t\tdev->id.revision |= (idhi & SSB_IDHIGH_RCHI) >> SSB_IDHIGH_RCHI_SHIFT;\n\t\tdev->id.vendor = (idhi & SSB_IDHIGH_VC) >> SSB_IDHIGH_VC_SHIFT;\n\t\tdev->core_index = i;\n\t\tdev->bus = bus;\n\t\tdev->ops = bus->ops;\n\n\t\tpr_debug(\"Core %d found: %s (cc 0x%03X, rev 0x%02X, vendor 0x%04X)\\n\",\n\t\t\t i, ssb_core_name(dev->id.coreid),\n\t\t\t dev->id.coreid, dev->id.revision, dev->id.vendor);\n\n\t\tswitch (dev->id.coreid) {\n\t\tcase SSB_DEV_80211:\n\t\t\tnr_80211_cores++;\n\t\t\tif (nr_80211_cores > 1) {\n\t\t\t\tif (!we_support_multiple_80211_cores(bus)) {\n\t\t\t\t\tpr_debug(\"Ignoring additional 802.11 core\\n\");\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tcase SSB_DEV_EXTIF:\n#ifdef CONFIG_SSB_DRIVER_EXTIF\n\t\t\tif (bus->extif.dev) {\n\t\t\t\tpr_warn(\"WARNING: Multiple EXTIFs found\\n\");\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbus->extif.dev = dev;\n#endif  \n\t\t\tbreak;\n\t\tcase SSB_DEV_CHIPCOMMON:\n\t\t\tif (bus->chipco.dev) {\n\t\t\t\tpr_warn(\"WARNING: Multiple ChipCommon found\\n\");\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbus->chipco.dev = dev;\n\t\t\tbreak;\n\t\tcase SSB_DEV_MIPS:\n\t\tcase SSB_DEV_MIPS_3302:\n#ifdef CONFIG_SSB_DRIVER_MIPS\n\t\t\tif (bus->mipscore.dev) {\n\t\t\t\tpr_warn(\"WARNING: Multiple MIPS cores found\\n\");\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbus->mipscore.dev = dev;\n#endif  \n\t\t\tbreak;\n\t\tcase SSB_DEV_PCI:\n\t\tcase SSB_DEV_PCIE:\n#ifdef CONFIG_SSB_DRIVER_PCICORE\n\t\t\tif (bus->bustype == SSB_BUSTYPE_PCI) {\n\t\t\t\t \n\t\t\t\tif (dev->id.coreid == SSB_DEV_PCI) {\n\t\t\t\t\tif (pci_is_pcie(bus->host_pci))\n\t\t\t\t\t\tcontinue;\n\t\t\t\t} else {\n\t\t\t\t\tif (!pci_is_pcie(bus->host_pci))\n\t\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (bus->pcicore.dev) {\n\t\t\t\tpr_warn(\"WARNING: Multiple PCI(E) cores found\\n\");\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbus->pcicore.dev = dev;\n#endif  \n\t\t\tbreak;\n\t\tcase SSB_DEV_ETHERNET:\n\t\t\tif (bus->bustype == SSB_BUSTYPE_PCI) {\n\t\t\t\tif (bus->host_pci->vendor == PCI_VENDOR_ID_BROADCOM &&\n\t\t\t\t    (bus->host_pci->device & 0xFF00) == 0x4300) {\n\t\t\t\t\t \n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\t\t\t}\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tbreak;\n\t\t}\n\n\t\tdev_i++;\n\t}\n\tbus->nr_devices = dev_i;\n\n\terr = 0;\nout:\n\treturn err;\nerr_unmap:\n\tssb_iounmap(bus);\n\tgoto out;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}