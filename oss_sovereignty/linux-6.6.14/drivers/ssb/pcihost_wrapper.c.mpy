{
  "module_name": "pcihost_wrapper.c",
  "hash_id": "213d58e3589107cd76f59abf7be76a43f5c7c4d16d88935fe9ff3f40a5beaa39",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ssb/pcihost_wrapper.c",
  "human_readable_source": " \n\n#include <linux/pm.h>\n#include <linux/pci.h>\n#include <linux/export.h>\n#include <linux/slab.h>\n#include <linux/ssb/ssb.h>\n\n\n#ifdef CONFIG_PM_SLEEP\nstatic int ssb_pcihost_suspend(struct device *d)\n{\n\tstruct pci_dev *dev = to_pci_dev(d);\n\tstruct ssb_bus *ssb = pci_get_drvdata(dev);\n\tint err;\n\n\terr = ssb_bus_suspend(ssb);\n\tif (err)\n\t\treturn err;\n\tpci_save_state(dev);\n\tpci_disable_device(dev);\n\n\t \n\tdevice_set_wakeup_enable(d, d->power.wakeup_path);\n\n\tpci_prepare_to_sleep(dev);\n\n\treturn 0;\n}\n\nstatic int ssb_pcihost_resume(struct device *d)\n{\n\tstruct pci_dev *dev = to_pci_dev(d);\n\tstruct ssb_bus *ssb = pci_get_drvdata(dev);\n\tint err;\n\n\tpci_back_from_sleep(dev);\n\terr = pci_enable_device(dev);\n\tif (err)\n\t\treturn err;\n\tpci_restore_state(dev);\n\terr = ssb_bus_resume(ssb);\n\tif (err)\n\t\treturn err;\n\n\treturn 0;\n}\n\nstatic const struct dev_pm_ops ssb_pcihost_pm_ops = {\n\tSET_SYSTEM_SLEEP_PM_OPS(ssb_pcihost_suspend, ssb_pcihost_resume)\n};\n\n#endif  \n\nstatic int ssb_pcihost_probe(struct pci_dev *dev,\n\t\t\t     const struct pci_device_id *id)\n{\n\tstruct ssb_bus *ssb;\n\tint err = -ENOMEM;\n\tu32 val;\n\n\tssb = kzalloc(sizeof(*ssb), GFP_KERNEL);\n\tif (!ssb)\n\t\tgoto out;\n\terr = pci_enable_device(dev);\n\tif (err)\n\t\tgoto err_kfree_ssb;\n\terr = pci_request_regions(dev, dev_driver_string(&dev->dev));\n\tif (err)\n\t\tgoto err_pci_disable;\n\tpci_set_master(dev);\n\n\t \n\tpci_read_config_dword(dev, 0x40, &val);\n\tif ((val & 0x0000ff00) != 0)\n\t\tpci_write_config_dword(dev, 0x40, val & 0xffff00ff);\n\n\terr = ssb_bus_pcibus_register(ssb, dev);\n\tif (err)\n\t\tgoto err_pci_release_regions;\n\n\tpci_set_drvdata(dev, ssb);\n\nout:\n\treturn err;\n\nerr_pci_release_regions:\n\tpci_release_regions(dev);\nerr_pci_disable:\n\tpci_disable_device(dev);\nerr_kfree_ssb:\n\tkfree(ssb);\n\treturn err;\n}\n\nstatic void ssb_pcihost_remove(struct pci_dev *dev)\n{\n\tstruct ssb_bus *ssb = pci_get_drvdata(dev);\n\n\tssb_bus_unregister(ssb);\n\tpci_release_regions(dev);\n\tpci_disable_device(dev);\n\tkfree(ssb);\n\tpci_set_drvdata(dev, NULL);\n}\n\nint ssb_pcihost_register(struct pci_driver *driver)\n{\n\tdriver->probe = ssb_pcihost_probe;\n\tdriver->remove = ssb_pcihost_remove;\n#ifdef CONFIG_PM_SLEEP\n\tdriver->driver.pm = &ssb_pcihost_pm_ops;\n#endif\n\n\treturn pci_register_driver(driver);\n}\nEXPORT_SYMBOL(ssb_pcihost_register);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}