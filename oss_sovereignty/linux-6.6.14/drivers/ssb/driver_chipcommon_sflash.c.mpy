{
  "module_name": "driver_chipcommon_sflash.c",
  "hash_id": "81a82652efc9e91cc837fc30c4ccbca5d75d5afdb1f2aeb654f775cc5c3042a9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ssb/driver_chipcommon_sflash.c",
  "human_readable_source": " \n\n#include \"ssb_private.h\"\n\n#include <linux/ssb/ssb.h>\n\nstatic struct resource ssb_sflash_resource = {\n\t.name\t= \"ssb_sflash\",\n\t.start\t= SSB_FLASH2,\n\t.end\t= 0,\n\t.flags  = IORESOURCE_MEM | IORESOURCE_READONLY,\n};\n\nstruct platform_device ssb_sflash_dev = {\n\t.name\t\t= \"ssb_sflash\",\n\t.resource\t= &ssb_sflash_resource,\n\t.num_resources\t= 1,\n};\n\nstruct ssb_sflash_tbl_e {\n\tchar *name;\n\tu32 id;\n\tu32 blocksize;\n\tu16 numblocks;\n};\n\nstatic const struct ssb_sflash_tbl_e ssb_sflash_st_tbl[] = {\n\t{ \"M25P20\", 0x11, 0x10000, 4, },\n\t{ \"M25P40\", 0x12, 0x10000, 8, },\n\n\t{ \"M25P16\", 0x14, 0x10000, 32, },\n\t{ \"M25P32\", 0x15, 0x10000, 64, },\n\t{ \"M25P64\", 0x16, 0x10000, 128, },\n\t{ \"M25FL128\", 0x17, 0x10000, 256, },\n\t{ NULL },\n};\n\nstatic const struct ssb_sflash_tbl_e ssb_sflash_sst_tbl[] = {\n\t{ \"SST25WF512\", 1, 0x1000, 16, },\n\t{ \"SST25VF512\", 0x48, 0x1000, 16, },\n\t{ \"SST25WF010\", 2, 0x1000, 32, },\n\t{ \"SST25VF010\", 0x49, 0x1000, 32, },\n\t{ \"SST25WF020\", 3, 0x1000, 64, },\n\t{ \"SST25VF020\", 0x43, 0x1000, 64, },\n\t{ \"SST25WF040\", 4, 0x1000, 128, },\n\t{ \"SST25VF040\", 0x44, 0x1000, 128, },\n\t{ \"SST25VF040B\", 0x8d, 0x1000, 128, },\n\t{ \"SST25WF080\", 5, 0x1000, 256, },\n\t{ \"SST25VF080B\", 0x8e, 0x1000, 256, },\n\t{ \"SST25VF016\", 0x41, 0x1000, 512, },\n\t{ \"SST25VF032\", 0x4a, 0x1000, 1024, },\n\t{ \"SST25VF064\", 0x4b, 0x1000, 2048, },\n\t{ NULL },\n};\n\nstatic const struct ssb_sflash_tbl_e ssb_sflash_at_tbl[] = {\n\t{ \"AT45DB011\", 0xc, 256, 512, },\n\t{ \"AT45DB021\", 0x14, 256, 1024, },\n\t{ \"AT45DB041\", 0x1c, 256, 2048, },\n\t{ \"AT45DB081\", 0x24, 256, 4096, },\n\t{ \"AT45DB161\", 0x2c, 512, 4096, },\n\t{ \"AT45DB321\", 0x34, 512, 8192, },\n\t{ \"AT45DB642\", 0x3c, 1024, 8192, },\n\t{ NULL },\n};\n\nstatic void ssb_sflash_cmd(struct ssb_chipcommon *cc, u32 opcode)\n{\n\tint i;\n\tchipco_write32(cc, SSB_CHIPCO_FLASHCTL,\n\t\t       SSB_CHIPCO_FLASHCTL_START | opcode);\n\tfor (i = 0; i < 1000; i++) {\n\t\tif (!(chipco_read32(cc, SSB_CHIPCO_FLASHCTL) &\n\t\t      SSB_CHIPCO_FLASHCTL_BUSY))\n\t\t\treturn;\n\t\tcpu_relax();\n\t}\n\tdev_err(cc->dev->dev, \"SFLASH control command failed (timeout)!\\n\");\n}\n\n \nint ssb_sflash_init(struct ssb_chipcommon *cc)\n{\n\tstruct ssb_sflash *sflash = &cc->dev->bus->mipscore.sflash;\n\tconst struct ssb_sflash_tbl_e *e;\n\tu32 id, id2;\n\n\tswitch (cc->capabilities & SSB_CHIPCO_CAP_FLASHT) {\n\tcase SSB_CHIPCO_FLASHT_STSER:\n\t\tssb_sflash_cmd(cc, SSB_CHIPCO_FLASHCTL_ST_DP);\n\n\t\tchipco_write32(cc, SSB_CHIPCO_FLASHADDR, 0);\n\t\tssb_sflash_cmd(cc, SSB_CHIPCO_FLASHCTL_ST_RES);\n\t\tid = chipco_read32(cc, SSB_CHIPCO_FLASHDATA);\n\n\t\tchipco_write32(cc, SSB_CHIPCO_FLASHADDR, 1);\n\t\tssb_sflash_cmd(cc, SSB_CHIPCO_FLASHCTL_ST_RES);\n\t\tid2 = chipco_read32(cc, SSB_CHIPCO_FLASHDATA);\n\n\t\tswitch (id) {\n\t\tcase 0xbf:\n\t\t\tfor (e = ssb_sflash_sst_tbl; e->name; e++) {\n\t\t\t\tif (e->id == id2)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 0x13:\n\t\t\treturn -ENOTSUPP;\n\t\tdefault:\n\t\t\tfor (e = ssb_sflash_st_tbl; e->name; e++) {\n\t\t\t\tif (e->id == id)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tbreak;\n\t\t}\n\t\tif (!e->name) {\n\t\t\tpr_err(\"Unsupported ST serial flash (id: 0x%X, id2: 0x%X)\\n\",\n\t\t\t       id, id2);\n\t\t\treturn -ENOTSUPP;\n\t\t}\n\n\t\tbreak;\n\tcase SSB_CHIPCO_FLASHT_ATSER:\n\t\tssb_sflash_cmd(cc, SSB_CHIPCO_FLASHCTL_AT_STATUS);\n\t\tid = chipco_read32(cc, SSB_CHIPCO_FLASHDATA) & 0x3c;\n\n\t\tfor (e = ssb_sflash_at_tbl; e->name; e++) {\n\t\t\tif (e->id == id)\n\t\t\t\tbreak;\n\t\t}\n\t\tif (!e->name) {\n\t\t\tpr_err(\"Unsupported Atmel serial flash (id: 0x%X)\\n\",\n\t\t\t       id);\n\t\t\treturn -ENOTSUPP;\n\t\t}\n\n\t\tbreak;\n\tdefault:\n\t\tpr_err(\"Unsupported flash type\\n\");\n\t\treturn -ENOTSUPP;\n\t}\n\n\tsflash->window = SSB_FLASH2;\n\tsflash->blocksize = e->blocksize;\n\tsflash->numblocks = e->numblocks;\n\tsflash->size = sflash->blocksize * sflash->numblocks;\n\tsflash->present = true;\n\n\tpr_info(\"Found %s serial flash (size: %dKiB, blocksize: 0x%X, blocks: %d)\\n\",\n\t\te->name, sflash->size / 1024, e->blocksize, e->numblocks);\n\n\t \n\tssb_sflash_dev.resource[0].end = ssb_sflash_dev.resource[0].start +\n\t\t\t\t\t sflash->size;\n\tssb_sflash_dev.dev.platform_data = sflash;\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}