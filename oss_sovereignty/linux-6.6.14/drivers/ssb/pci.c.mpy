{
  "module_name": "pci.c",
  "hash_id": "8a94ef43e97a80fe37b5884c2af4258d0d38e47f4a3536c21e96cb3efd6652ce",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ssb/pci.c",
  "human_readable_source": " \n\n#include \"ssb_private.h\"\n\n#include <linux/ssb/ssb.h>\n#include <linux/ssb/ssb_regs.h>\n#include <linux/slab.h>\n#include <linux/pci.h>\n#include <linux/delay.h>\n\n\n \n#define SSB_VERBOSE_PCICORESWITCH_DEBUG\t\t0\n\n\n \nint ssb_pci_switch_coreidx(struct ssb_bus *bus, u8 coreidx)\n{\n\tint err;\n\tint attempts = 0;\n\tu32 cur_core;\n\n\twhile (1) {\n\t\terr = pci_write_config_dword(bus->host_pci, SSB_BAR0_WIN,\n\t\t\t\t\t     (coreidx * SSB_CORE_SIZE)\n\t\t\t\t\t     + SSB_ENUM_BASE);\n\t\tif (err)\n\t\t\tgoto error;\n\t\terr = pci_read_config_dword(bus->host_pci, SSB_BAR0_WIN,\n\t\t\t\t\t    &cur_core);\n\t\tif (err)\n\t\t\tgoto error;\n\t\tcur_core = (cur_core - SSB_ENUM_BASE)\n\t\t\t   / SSB_CORE_SIZE;\n\t\tif (cur_core == coreidx)\n\t\t\tbreak;\n\n\t\tif (attempts++ > SSB_BAR0_MAX_RETRIES)\n\t\t\tgoto error;\n\t\tudelay(10);\n\t}\n\treturn 0;\nerror:\n\tpr_err(\"Failed to switch to core %u\\n\", coreidx);\n\treturn -ENODEV;\n}\n\nint ssb_pci_switch_core(struct ssb_bus *bus,\n\t\t\tstruct ssb_device *dev)\n{\n\tint err;\n\tunsigned long flags;\n\n#if SSB_VERBOSE_PCICORESWITCH_DEBUG\n\tpr_info(\"Switching to %s core, index %d\\n\",\n\t\tssb_core_name(dev->id.coreid), dev->core_index);\n#endif\n\n\tspin_lock_irqsave(&bus->bar_lock, flags);\n\terr = ssb_pci_switch_coreidx(bus, dev->core_index);\n\tif (!err)\n\t\tbus->mapped_device = dev;\n\tspin_unlock_irqrestore(&bus->bar_lock, flags);\n\n\treturn err;\n}\n\n \nint ssb_pci_xtal(struct ssb_bus *bus, u32 what, int turn_on)\n{\n\tint err;\n\tu32 in, out, outenable;\n\tu16 pci_status;\n\n\tif (bus->bustype != SSB_BUSTYPE_PCI)\n\t\treturn 0;\n\n\terr = pci_read_config_dword(bus->host_pci, SSB_GPIO_IN, &in);\n\tif (err)\n\t\tgoto err_pci;\n\terr = pci_read_config_dword(bus->host_pci, SSB_GPIO_OUT, &out);\n\tif (err)\n\t\tgoto err_pci;\n\terr = pci_read_config_dword(bus->host_pci, SSB_GPIO_OUT_ENABLE, &outenable);\n\tif (err)\n\t\tgoto err_pci;\n\n\toutenable |= what;\n\n\tif (turn_on) {\n\t\t \n\t\tif (!(in & SSB_GPIO_XTAL)) {\n\t\t\tif (what & SSB_GPIO_XTAL) {\n\t\t\t\t \n\t\t\t\tout |= SSB_GPIO_XTAL;\n\t\t\t\tif (what & SSB_GPIO_PLL)\n\t\t\t\t\tout |= SSB_GPIO_PLL;\n\t\t\t\terr = pci_write_config_dword(bus->host_pci, SSB_GPIO_OUT, out);\n\t\t\t\tif (err)\n\t\t\t\t\tgoto err_pci;\n\t\t\t\terr = pci_write_config_dword(bus->host_pci, SSB_GPIO_OUT_ENABLE,\n\t\t\t\t\t\t\t     outenable);\n\t\t\t\tif (err)\n\t\t\t\t\tgoto err_pci;\n\t\t\t\tmsleep(1);\n\t\t\t}\n\t\t\tif (what & SSB_GPIO_PLL) {\n\t\t\t\t \n\t\t\t\tout &= ~SSB_GPIO_PLL;\n\t\t\t\terr = pci_write_config_dword(bus->host_pci, SSB_GPIO_OUT, out);\n\t\t\t\tif (err)\n\t\t\t\t\tgoto err_pci;\n\t\t\t\tmsleep(5);\n\t\t\t}\n\t\t}\n\n\t\terr = pci_read_config_word(bus->host_pci, PCI_STATUS, &pci_status);\n\t\tif (err)\n\t\t\tgoto err_pci;\n\t\tpci_status &= ~PCI_STATUS_SIG_TARGET_ABORT;\n\t\terr = pci_write_config_word(bus->host_pci, PCI_STATUS, pci_status);\n\t\tif (err)\n\t\t\tgoto err_pci;\n\t} else {\n\t\tif (what & SSB_GPIO_XTAL) {\n\t\t\t \n\t\t\tout &= ~SSB_GPIO_XTAL;\n\t\t}\n\t\tif (what & SSB_GPIO_PLL) {\n\t\t\t \n\t\t\tout |= SSB_GPIO_PLL;\n\t\t}\n\t\terr = pci_write_config_dword(bus->host_pci, SSB_GPIO_OUT, out);\n\t\tif (err)\n\t\t\tgoto err_pci;\n\t\terr = pci_write_config_dword(bus->host_pci, SSB_GPIO_OUT_ENABLE, outenable);\n\t\tif (err)\n\t\t\tgoto err_pci;\n\t}\n\nout:\n\treturn err;\n\nerr_pci:\n\tpr_err(\"Error: ssb_pci_xtal() could not access PCI config space!\\n\");\n\terr = -EBUSY;\n\tgoto out;\n}\n\n \n#define SPOFF(offset)\t((offset) / sizeof(u16))\n \n#define SPEX16(_outvar, _offset, _mask, _shift)\t\\\n\tout->_outvar = ((in[SPOFF(_offset)] & (_mask)) >> (_shift))\n#define SPEX32(_outvar, _offset, _mask, _shift)\t\\\n\tout->_outvar = ((((u32)in[SPOFF((_offset)+2)] << 16 | \\\n\t\t\t   in[SPOFF(_offset)]) & (_mask)) >> (_shift))\n#define SPEX(_outvar, _offset, _mask, _shift) \\\n\tSPEX16(_outvar, _offset, _mask, _shift)\n\n#define SPEX_ARRAY8(_field, _offset, _mask, _shift)\t\\\n\tdo {\t\\\n\t\tSPEX(_field[0], _offset +  0, _mask, _shift);\t\\\n\t\tSPEX(_field[1], _offset +  2, _mask, _shift);\t\\\n\t\tSPEX(_field[2], _offset +  4, _mask, _shift);\t\\\n\t\tSPEX(_field[3], _offset +  6, _mask, _shift);\t\\\n\t\tSPEX(_field[4], _offset +  8, _mask, _shift);\t\\\n\t\tSPEX(_field[5], _offset + 10, _mask, _shift);\t\\\n\t\tSPEX(_field[6], _offset + 12, _mask, _shift);\t\\\n\t\tSPEX(_field[7], _offset + 14, _mask, _shift);\t\\\n\t} while (0)\n\n\nstatic inline u8 ssb_crc8(u8 crc, u8 data)\n{\n\t \n\tstatic const u8 t[] = {\n\t\t0x00, 0xF7, 0xB9, 0x4E, 0x25, 0xD2, 0x9C, 0x6B,\n\t\t0x4A, 0xBD, 0xF3, 0x04, 0x6F, 0x98, 0xD6, 0x21,\n\t\t0x94, 0x63, 0x2D, 0xDA, 0xB1, 0x46, 0x08, 0xFF,\n\t\t0xDE, 0x29, 0x67, 0x90, 0xFB, 0x0C, 0x42, 0xB5,\n\t\t0x7F, 0x88, 0xC6, 0x31, 0x5A, 0xAD, 0xE3, 0x14,\n\t\t0x35, 0xC2, 0x8C, 0x7B, 0x10, 0xE7, 0xA9, 0x5E,\n\t\t0xEB, 0x1C, 0x52, 0xA5, 0xCE, 0x39, 0x77, 0x80,\n\t\t0xA1, 0x56, 0x18, 0xEF, 0x84, 0x73, 0x3D, 0xCA,\n\t\t0xFE, 0x09, 0x47, 0xB0, 0xDB, 0x2C, 0x62, 0x95,\n\t\t0xB4, 0x43, 0x0D, 0xFA, 0x91, 0x66, 0x28, 0xDF,\n\t\t0x6A, 0x9D, 0xD3, 0x24, 0x4F, 0xB8, 0xF6, 0x01,\n\t\t0x20, 0xD7, 0x99, 0x6E, 0x05, 0xF2, 0xBC, 0x4B,\n\t\t0x81, 0x76, 0x38, 0xCF, 0xA4, 0x53, 0x1D, 0xEA,\n\t\t0xCB, 0x3C, 0x72, 0x85, 0xEE, 0x19, 0x57, 0xA0,\n\t\t0x15, 0xE2, 0xAC, 0x5B, 0x30, 0xC7, 0x89, 0x7E,\n\t\t0x5F, 0xA8, 0xE6, 0x11, 0x7A, 0x8D, 0xC3, 0x34,\n\t\t0xAB, 0x5C, 0x12, 0xE5, 0x8E, 0x79, 0x37, 0xC0,\n\t\t0xE1, 0x16, 0x58, 0xAF, 0xC4, 0x33, 0x7D, 0x8A,\n\t\t0x3F, 0xC8, 0x86, 0x71, 0x1A, 0xED, 0xA3, 0x54,\n\t\t0x75, 0x82, 0xCC, 0x3B, 0x50, 0xA7, 0xE9, 0x1E,\n\t\t0xD4, 0x23, 0x6D, 0x9A, 0xF1, 0x06, 0x48, 0xBF,\n\t\t0x9E, 0x69, 0x27, 0xD0, 0xBB, 0x4C, 0x02, 0xF5,\n\t\t0x40, 0xB7, 0xF9, 0x0E, 0x65, 0x92, 0xDC, 0x2B,\n\t\t0x0A, 0xFD, 0xB3, 0x44, 0x2F, 0xD8, 0x96, 0x61,\n\t\t0x55, 0xA2, 0xEC, 0x1B, 0x70, 0x87, 0xC9, 0x3E,\n\t\t0x1F, 0xE8, 0xA6, 0x51, 0x3A, 0xCD, 0x83, 0x74,\n\t\t0xC1, 0x36, 0x78, 0x8F, 0xE4, 0x13, 0x5D, 0xAA,\n\t\t0x8B, 0x7C, 0x32, 0xC5, 0xAE, 0x59, 0x17, 0xE0,\n\t\t0x2A, 0xDD, 0x93, 0x64, 0x0F, 0xF8, 0xB6, 0x41,\n\t\t0x60, 0x97, 0xD9, 0x2E, 0x45, 0xB2, 0xFC, 0x0B,\n\t\t0xBE, 0x49, 0x07, 0xF0, 0x9B, 0x6C, 0x22, 0xD5,\n\t\t0xF4, 0x03, 0x4D, 0xBA, 0xD1, 0x26, 0x68, 0x9F,\n\t};\n\treturn t[crc ^ data];\n}\n\nstatic void sprom_get_mac(char *mac, const u16 *in)\n{\n\tint i;\n\tfor (i = 0; i < 3; i++) {\n\t\t*mac++ = in[i] >> 8;\n\t\t*mac++ = in[i];\n\t}\n}\n\nstatic u8 ssb_sprom_crc(const u16 *sprom, u16 size)\n{\n\tint word;\n\tu8 crc = 0xFF;\n\n\tfor (word = 0; word < size - 1; word++) {\n\t\tcrc = ssb_crc8(crc, sprom[word] & 0x00FF);\n\t\tcrc = ssb_crc8(crc, (sprom[word] & 0xFF00) >> 8);\n\t}\n\tcrc = ssb_crc8(crc, sprom[size - 1] & 0x00FF);\n\tcrc ^= 0xFF;\n\n\treturn crc;\n}\n\nstatic int sprom_check_crc(const u16 *sprom, size_t size)\n{\n\tu8 crc;\n\tu8 expected_crc;\n\tu16 tmp;\n\n\tcrc = ssb_sprom_crc(sprom, size);\n\ttmp = sprom[size - 1] & SSB_SPROM_REVISION_CRC;\n\texpected_crc = tmp >> SSB_SPROM_REVISION_CRC_SHIFT;\n\tif (crc != expected_crc)\n\t\treturn -EPROTO;\n\n\treturn 0;\n}\n\nstatic int sprom_do_read(struct ssb_bus *bus, u16 *sprom)\n{\n\tint i;\n\n\tfor (i = 0; i < bus->sprom_size; i++)\n\t\tsprom[i] = ioread16(bus->mmio + bus->sprom_offset + (i * 2));\n\n\treturn 0;\n}\n\nstatic int sprom_do_write(struct ssb_bus *bus, const u16 *sprom)\n{\n\tstruct pci_dev *pdev = bus->host_pci;\n\tint i, err;\n\tu32 spromctl;\n\tu16 size = bus->sprom_size;\n\n\tpr_notice(\"Writing SPROM. Do NOT turn off the power! Please stand by...\\n\");\n\terr = pci_read_config_dword(pdev, SSB_SPROMCTL, &spromctl);\n\tif (err)\n\t\tgoto err_ctlreg;\n\tspromctl |= SSB_SPROMCTL_WE;\n\terr = pci_write_config_dword(pdev, SSB_SPROMCTL, spromctl);\n\tif (err)\n\t\tgoto err_ctlreg;\n\tpr_notice(\"[ 0%%\");\n\tmsleep(500);\n\tfor (i = 0; i < size; i++) {\n\t\tif (i == size / 4)\n\t\t\tpr_cont(\"25%%\");\n\t\telse if (i == size / 2)\n\t\t\tpr_cont(\"50%%\");\n\t\telse if (i == (size * 3) / 4)\n\t\t\tpr_cont(\"75%%\");\n\t\telse if (i % 2)\n\t\t\tpr_cont(\".\");\n\t\twritew(sprom[i], bus->mmio + bus->sprom_offset + (i * 2));\n\t\tmsleep(20);\n\t}\n\terr = pci_read_config_dword(pdev, SSB_SPROMCTL, &spromctl);\n\tif (err)\n\t\tgoto err_ctlreg;\n\tspromctl &= ~SSB_SPROMCTL_WE;\n\terr = pci_write_config_dword(pdev, SSB_SPROMCTL, spromctl);\n\tif (err)\n\t\tgoto err_ctlreg;\n\tmsleep(500);\n\tpr_cont(\"100%% ]\\n\");\n\tpr_notice(\"SPROM written\\n\");\n\n\treturn 0;\nerr_ctlreg:\n\tpr_err(\"Could not access SPROM control register.\\n\");\n\treturn err;\n}\n\nstatic s8 sprom_extract_antgain(u8 sprom_revision, const u16 *in, u16 offset,\n\t\t\t\tu16 mask, u16 shift)\n{\n\tu16 v;\n\tu8 gain;\n\n\tv = in[SPOFF(offset)];\n\tgain = (v & mask) >> shift;\n\tif (gain == 0xFF)\n\t\tgain = 2;  \n\tif (sprom_revision == 1) {\n\t\t \n\t\tgain <<= 2;\n\t} else {\n\t\t \n\t\tgain = ((gain & 0xC0) >> 6) | ((gain & 0x3F) << 2);\n\t}\n\n\treturn (s8)gain;\n}\n\nstatic void sprom_extract_r23(struct ssb_sprom *out, const u16 *in)\n{\n\tSPEX(boardflags_hi, SSB_SPROM2_BFLHI, 0xFFFF, 0);\n\tSPEX(opo, SSB_SPROM2_OPO, SSB_SPROM2_OPO_VALUE, 0);\n\tSPEX(pa1lob0, SSB_SPROM2_PA1LOB0, 0xFFFF, 0);\n\tSPEX(pa1lob1, SSB_SPROM2_PA1LOB1, 0xFFFF, 0);\n\tSPEX(pa1lob2, SSB_SPROM2_PA1LOB2, 0xFFFF, 0);\n\tSPEX(pa1hib0, SSB_SPROM2_PA1HIB0, 0xFFFF, 0);\n\tSPEX(pa1hib1, SSB_SPROM2_PA1HIB1, 0xFFFF, 0);\n\tSPEX(pa1hib2, SSB_SPROM2_PA1HIB2, 0xFFFF, 0);\n\tSPEX(maxpwr_ah, SSB_SPROM2_MAXP_A, SSB_SPROM2_MAXP_A_HI, 0);\n\tSPEX(maxpwr_al, SSB_SPROM2_MAXP_A, SSB_SPROM2_MAXP_A_LO,\n\t     SSB_SPROM2_MAXP_A_LO_SHIFT);\n}\n\nstatic void sprom_extract_r123(struct ssb_sprom *out, const u16 *in)\n{\n\tu16 loc[3];\n\n\tif (out->revision == 3)\t\t\t \n\t\tloc[0] = SSB_SPROM3_IL0MAC;\n\telse {\n\t\tloc[0] = SSB_SPROM1_IL0MAC;\n\t\tloc[1] = SSB_SPROM1_ET0MAC;\n\t\tloc[2] = SSB_SPROM1_ET1MAC;\n\t}\n\tsprom_get_mac(out->il0mac, &in[SPOFF(loc[0])]);\n\tif (out->revision < 3) { \t \n\t\tsprom_get_mac(out->et0mac, &in[SPOFF(loc[1])]);\n\t\tsprom_get_mac(out->et1mac, &in[SPOFF(loc[2])]);\n\t}\n\tSPEX(et0phyaddr, SSB_SPROM1_ETHPHY, SSB_SPROM1_ETHPHY_ET0A, 0);\n\tSPEX(et1phyaddr, SSB_SPROM1_ETHPHY, SSB_SPROM1_ETHPHY_ET1A,\n\t     SSB_SPROM1_ETHPHY_ET1A_SHIFT);\n\tSPEX(et0mdcport, SSB_SPROM1_ETHPHY, SSB_SPROM1_ETHPHY_ET0M, 14);\n\tSPEX(et1mdcport, SSB_SPROM1_ETHPHY, SSB_SPROM1_ETHPHY_ET1M, 15);\n\tSPEX(board_rev, SSB_SPROM1_BINF, SSB_SPROM1_BINF_BREV, 0);\n\tSPEX(board_type, SSB_SPROM1_SPID, 0xFFFF, 0);\n\tif (out->revision == 1)\n\t\tSPEX(country_code, SSB_SPROM1_BINF, SSB_SPROM1_BINF_CCODE,\n\t\t     SSB_SPROM1_BINF_CCODE_SHIFT);\n\tSPEX(ant_available_a, SSB_SPROM1_BINF, SSB_SPROM1_BINF_ANTA,\n\t     SSB_SPROM1_BINF_ANTA_SHIFT);\n\tSPEX(ant_available_bg, SSB_SPROM1_BINF, SSB_SPROM1_BINF_ANTBG,\n\t     SSB_SPROM1_BINF_ANTBG_SHIFT);\n\tSPEX(pa0b0, SSB_SPROM1_PA0B0, 0xFFFF, 0);\n\tSPEX(pa0b1, SSB_SPROM1_PA0B1, 0xFFFF, 0);\n\tSPEX(pa0b2, SSB_SPROM1_PA0B2, 0xFFFF, 0);\n\tSPEX(pa1b0, SSB_SPROM1_PA1B0, 0xFFFF, 0);\n\tSPEX(pa1b1, SSB_SPROM1_PA1B1, 0xFFFF, 0);\n\tSPEX(pa1b2, SSB_SPROM1_PA1B2, 0xFFFF, 0);\n\tSPEX(gpio0, SSB_SPROM1_GPIOA, SSB_SPROM1_GPIOA_P0, 0);\n\tSPEX(gpio1, SSB_SPROM1_GPIOA, SSB_SPROM1_GPIOA_P1,\n\t     SSB_SPROM1_GPIOA_P1_SHIFT);\n\tSPEX(gpio2, SSB_SPROM1_GPIOB, SSB_SPROM1_GPIOB_P2, 0);\n\tSPEX(gpio3, SSB_SPROM1_GPIOB, SSB_SPROM1_GPIOB_P3,\n\t     SSB_SPROM1_GPIOB_P3_SHIFT);\n\tSPEX(maxpwr_a, SSB_SPROM1_MAXPWR, SSB_SPROM1_MAXPWR_A,\n\t     SSB_SPROM1_MAXPWR_A_SHIFT);\n\tSPEX(maxpwr_bg, SSB_SPROM1_MAXPWR, SSB_SPROM1_MAXPWR_BG, 0);\n\tSPEX(itssi_a, SSB_SPROM1_ITSSI, SSB_SPROM1_ITSSI_A,\n\t     SSB_SPROM1_ITSSI_A_SHIFT);\n\tSPEX(itssi_bg, SSB_SPROM1_ITSSI, SSB_SPROM1_ITSSI_BG, 0);\n\tSPEX(boardflags_lo, SSB_SPROM1_BFLLO, 0xFFFF, 0);\n\n\tSPEX(alpha2[0], SSB_SPROM1_CCODE, 0xff00, 8);\n\tSPEX(alpha2[1], SSB_SPROM1_CCODE, 0x00ff, 0);\n\n\t \n\tout->antenna_gain.a0 = sprom_extract_antgain(out->revision, in,\n\t\t\t\t\t\t     SSB_SPROM1_AGAIN,\n\t\t\t\t\t\t     SSB_SPROM1_AGAIN_BG,\n\t\t\t\t\t\t     SSB_SPROM1_AGAIN_BG_SHIFT);\n\tout->antenna_gain.a1 = sprom_extract_antgain(out->revision, in,\n\t\t\t\t\t\t     SSB_SPROM1_AGAIN,\n\t\t\t\t\t\t     SSB_SPROM1_AGAIN_A,\n\t\t\t\t\t\t     SSB_SPROM1_AGAIN_A_SHIFT);\n\tif (out->revision >= 2)\n\t\tsprom_extract_r23(out, in);\n}\n\n \nstatic void sprom_extract_r458(struct ssb_sprom *out, const u16 *in)\n{\n\tSPEX(txpid2g[0], SSB_SPROM4_TXPID2G01,\n\t     SSB_SPROM4_TXPID2G0, SSB_SPROM4_TXPID2G0_SHIFT);\n\tSPEX(txpid2g[1], SSB_SPROM4_TXPID2G01,\n\t     SSB_SPROM4_TXPID2G1, SSB_SPROM4_TXPID2G1_SHIFT);\n\tSPEX(txpid2g[2], SSB_SPROM4_TXPID2G23,\n\t     SSB_SPROM4_TXPID2G2, SSB_SPROM4_TXPID2G2_SHIFT);\n\tSPEX(txpid2g[3], SSB_SPROM4_TXPID2G23,\n\t     SSB_SPROM4_TXPID2G3, SSB_SPROM4_TXPID2G3_SHIFT);\n\n\tSPEX(txpid5gl[0], SSB_SPROM4_TXPID5GL01,\n\t     SSB_SPROM4_TXPID5GL0, SSB_SPROM4_TXPID5GL0_SHIFT);\n\tSPEX(txpid5gl[1], SSB_SPROM4_TXPID5GL01,\n\t     SSB_SPROM4_TXPID5GL1, SSB_SPROM4_TXPID5GL1_SHIFT);\n\tSPEX(txpid5gl[2], SSB_SPROM4_TXPID5GL23,\n\t     SSB_SPROM4_TXPID5GL2, SSB_SPROM4_TXPID5GL2_SHIFT);\n\tSPEX(txpid5gl[3], SSB_SPROM4_TXPID5GL23,\n\t     SSB_SPROM4_TXPID5GL3, SSB_SPROM4_TXPID5GL3_SHIFT);\n\n\tSPEX(txpid5g[0], SSB_SPROM4_TXPID5G01,\n\t     SSB_SPROM4_TXPID5G0, SSB_SPROM4_TXPID5G0_SHIFT);\n\tSPEX(txpid5g[1], SSB_SPROM4_TXPID5G01,\n\t     SSB_SPROM4_TXPID5G1, SSB_SPROM4_TXPID5G1_SHIFT);\n\tSPEX(txpid5g[2], SSB_SPROM4_TXPID5G23,\n\t     SSB_SPROM4_TXPID5G2, SSB_SPROM4_TXPID5G2_SHIFT);\n\tSPEX(txpid5g[3], SSB_SPROM4_TXPID5G23,\n\t     SSB_SPROM4_TXPID5G3, SSB_SPROM4_TXPID5G3_SHIFT);\n\n\tSPEX(txpid5gh[0], SSB_SPROM4_TXPID5GH01,\n\t     SSB_SPROM4_TXPID5GH0, SSB_SPROM4_TXPID5GH0_SHIFT);\n\tSPEX(txpid5gh[1], SSB_SPROM4_TXPID5GH01,\n\t     SSB_SPROM4_TXPID5GH1, SSB_SPROM4_TXPID5GH1_SHIFT);\n\tSPEX(txpid5gh[2], SSB_SPROM4_TXPID5GH23,\n\t     SSB_SPROM4_TXPID5GH2, SSB_SPROM4_TXPID5GH2_SHIFT);\n\tSPEX(txpid5gh[3], SSB_SPROM4_TXPID5GH23,\n\t     SSB_SPROM4_TXPID5GH3, SSB_SPROM4_TXPID5GH3_SHIFT);\n}\n\nstatic void sprom_extract_r45(struct ssb_sprom *out, const u16 *in)\n{\n\tstatic const u16 pwr_info_offset[] = {\n\t\tSSB_SPROM4_PWR_INFO_CORE0, SSB_SPROM4_PWR_INFO_CORE1,\n\t\tSSB_SPROM4_PWR_INFO_CORE2, SSB_SPROM4_PWR_INFO_CORE3\n\t};\n\tu16 il0mac_offset;\n\tint i;\n\n\tBUILD_BUG_ON(ARRAY_SIZE(pwr_info_offset) !=\n\t\t     ARRAY_SIZE(out->core_pwr_info));\n\n\tif (out->revision == 4)\n\t\til0mac_offset = SSB_SPROM4_IL0MAC;\n\telse\n\t\til0mac_offset = SSB_SPROM5_IL0MAC;\n\n\tsprom_get_mac(out->il0mac, &in[SPOFF(il0mac_offset)]);\n\n\tSPEX(et0phyaddr, SSB_SPROM4_ETHPHY, SSB_SPROM4_ETHPHY_ET0A, 0);\n\tSPEX(et1phyaddr, SSB_SPROM4_ETHPHY, SSB_SPROM4_ETHPHY_ET1A,\n\t     SSB_SPROM4_ETHPHY_ET1A_SHIFT);\n\tSPEX(board_rev, SSB_SPROM4_BOARDREV, 0xFFFF, 0);\n\tSPEX(board_type, SSB_SPROM1_SPID, 0xFFFF, 0);\n\tif (out->revision == 4) {\n\t\tSPEX(alpha2[0], SSB_SPROM4_CCODE, 0xff00, 8);\n\t\tSPEX(alpha2[1], SSB_SPROM4_CCODE, 0x00ff, 0);\n\t\tSPEX(boardflags_lo, SSB_SPROM4_BFLLO, 0xFFFF, 0);\n\t\tSPEX(boardflags_hi, SSB_SPROM4_BFLHI, 0xFFFF, 0);\n\t\tSPEX(boardflags2_lo, SSB_SPROM4_BFL2LO, 0xFFFF, 0);\n\t\tSPEX(boardflags2_hi, SSB_SPROM4_BFL2HI, 0xFFFF, 0);\n\t} else {\n\t\tSPEX(alpha2[0], SSB_SPROM5_CCODE, 0xff00, 8);\n\t\tSPEX(alpha2[1], SSB_SPROM5_CCODE, 0x00ff, 0);\n\t\tSPEX(boardflags_lo, SSB_SPROM5_BFLLO, 0xFFFF, 0);\n\t\tSPEX(boardflags_hi, SSB_SPROM5_BFLHI, 0xFFFF, 0);\n\t\tSPEX(boardflags2_lo, SSB_SPROM5_BFL2LO, 0xFFFF, 0);\n\t\tSPEX(boardflags2_hi, SSB_SPROM5_BFL2HI, 0xFFFF, 0);\n\t}\n\tSPEX(ant_available_a, SSB_SPROM4_ANTAVAIL, SSB_SPROM4_ANTAVAIL_A,\n\t     SSB_SPROM4_ANTAVAIL_A_SHIFT);\n\tSPEX(ant_available_bg, SSB_SPROM4_ANTAVAIL, SSB_SPROM4_ANTAVAIL_BG,\n\t     SSB_SPROM4_ANTAVAIL_BG_SHIFT);\n\tSPEX(maxpwr_bg, SSB_SPROM4_MAXP_BG, SSB_SPROM4_MAXP_BG_MASK, 0);\n\tSPEX(itssi_bg, SSB_SPROM4_MAXP_BG, SSB_SPROM4_ITSSI_BG,\n\t     SSB_SPROM4_ITSSI_BG_SHIFT);\n\tSPEX(maxpwr_a, SSB_SPROM4_MAXP_A, SSB_SPROM4_MAXP_A_MASK, 0);\n\tSPEX(itssi_a, SSB_SPROM4_MAXP_A, SSB_SPROM4_ITSSI_A,\n\t     SSB_SPROM4_ITSSI_A_SHIFT);\n\tif (out->revision == 4) {\n\t\tSPEX(gpio0, SSB_SPROM4_GPIOA, SSB_SPROM4_GPIOA_P0, 0);\n\t\tSPEX(gpio1, SSB_SPROM4_GPIOA, SSB_SPROM4_GPIOA_P1,\n\t\t     SSB_SPROM4_GPIOA_P1_SHIFT);\n\t\tSPEX(gpio2, SSB_SPROM4_GPIOB, SSB_SPROM4_GPIOB_P2, 0);\n\t\tSPEX(gpio3, SSB_SPROM4_GPIOB, SSB_SPROM4_GPIOB_P3,\n\t\t     SSB_SPROM4_GPIOB_P3_SHIFT);\n\t} else {\n\t\tSPEX(gpio0, SSB_SPROM5_GPIOA, SSB_SPROM5_GPIOA_P0, 0);\n\t\tSPEX(gpio1, SSB_SPROM5_GPIOA, SSB_SPROM5_GPIOA_P1,\n\t\t     SSB_SPROM5_GPIOA_P1_SHIFT);\n\t\tSPEX(gpio2, SSB_SPROM5_GPIOB, SSB_SPROM5_GPIOB_P2, 0);\n\t\tSPEX(gpio3, SSB_SPROM5_GPIOB, SSB_SPROM5_GPIOB_P3,\n\t\t     SSB_SPROM5_GPIOB_P3_SHIFT);\n\t}\n\n\t \n\tout->antenna_gain.a0 = sprom_extract_antgain(out->revision, in,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN01,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN0,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN0_SHIFT);\n\tout->antenna_gain.a1 = sprom_extract_antgain(out->revision, in,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN01,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN1,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN1_SHIFT);\n\tout->antenna_gain.a2 = sprom_extract_antgain(out->revision, in,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN23,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN2,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN2_SHIFT);\n\tout->antenna_gain.a3 = sprom_extract_antgain(out->revision, in,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN23,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN3,\n\t\t\t\t\t\t     SSB_SPROM4_AGAIN3_SHIFT);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(pwr_info_offset); i++) {\n\t\tu16 o = pwr_info_offset[i];\n\n\t\tSPEX(core_pwr_info[i].itssi_2g, o + SSB_SPROM4_2G_MAXP_ITSSI,\n\t\t\tSSB_SPROM4_2G_ITSSI, SSB_SPROM4_2G_ITSSI_SHIFT);\n\t\tSPEX(core_pwr_info[i].maxpwr_2g, o + SSB_SPROM4_2G_MAXP_ITSSI,\n\t\t\tSSB_SPROM4_2G_MAXP, 0);\n\n\t\tSPEX(core_pwr_info[i].pa_2g[0], o + SSB_SPROM4_2G_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_2g[1], o + SSB_SPROM4_2G_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_2g[2], o + SSB_SPROM4_2G_PA_2, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_2g[3], o + SSB_SPROM4_2G_PA_3, ~0, 0);\n\n\t\tSPEX(core_pwr_info[i].itssi_5g, o + SSB_SPROM4_5G_MAXP_ITSSI,\n\t\t\tSSB_SPROM4_5G_ITSSI, SSB_SPROM4_5G_ITSSI_SHIFT);\n\t\tSPEX(core_pwr_info[i].maxpwr_5g, o + SSB_SPROM4_5G_MAXP_ITSSI,\n\t\t\tSSB_SPROM4_5G_MAXP, 0);\n\t\tSPEX(core_pwr_info[i].maxpwr_5gh, o + SSB_SPROM4_5GHL_MAXP,\n\t\t\tSSB_SPROM4_5GH_MAXP, 0);\n\t\tSPEX(core_pwr_info[i].maxpwr_5gl, o + SSB_SPROM4_5GHL_MAXP,\n\t\t\tSSB_SPROM4_5GL_MAXP, SSB_SPROM4_5GL_MAXP_SHIFT);\n\n\t\tSPEX(core_pwr_info[i].pa_5gl[0], o + SSB_SPROM4_5GL_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gl[1], o + SSB_SPROM4_5GL_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gl[2], o + SSB_SPROM4_5GL_PA_2, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gl[3], o + SSB_SPROM4_5GL_PA_3, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5g[0], o + SSB_SPROM4_5G_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5g[1], o + SSB_SPROM4_5G_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5g[2], o + SSB_SPROM4_5G_PA_2, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5g[3], o + SSB_SPROM4_5G_PA_3, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gh[0], o + SSB_SPROM4_5GH_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gh[1], o + SSB_SPROM4_5GH_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gh[2], o + SSB_SPROM4_5GH_PA_2, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gh[3], o + SSB_SPROM4_5GH_PA_3, ~0, 0);\n\t}\n\n\tsprom_extract_r458(out, in);\n\n\t \n}\n\nstatic void sprom_extract_r8(struct ssb_sprom *out, const u16 *in)\n{\n\tint i;\n\tu16 o;\n\tstatic const u16 pwr_info_offset[] = {\n\t\tSSB_SROM8_PWR_INFO_CORE0, SSB_SROM8_PWR_INFO_CORE1,\n\t\tSSB_SROM8_PWR_INFO_CORE2, SSB_SROM8_PWR_INFO_CORE3\n\t};\n\tBUILD_BUG_ON(ARRAY_SIZE(pwr_info_offset) !=\n\t\t\tARRAY_SIZE(out->core_pwr_info));\n\n\t \n\tsprom_get_mac(out->il0mac, &in[SPOFF(SSB_SPROM8_IL0MAC)]);\n\n\tSPEX(board_rev, SSB_SPROM8_BOARDREV, 0xFFFF, 0);\n\tSPEX(board_type, SSB_SPROM1_SPID, 0xFFFF, 0);\n\tSPEX(alpha2[0], SSB_SPROM8_CCODE, 0xff00, 8);\n\tSPEX(alpha2[1], SSB_SPROM8_CCODE, 0x00ff, 0);\n\tSPEX(boardflags_lo, SSB_SPROM8_BFLLO, 0xFFFF, 0);\n\tSPEX(boardflags_hi, SSB_SPROM8_BFLHI, 0xFFFF, 0);\n\tSPEX(boardflags2_lo, SSB_SPROM8_BFL2LO, 0xFFFF, 0);\n\tSPEX(boardflags2_hi, SSB_SPROM8_BFL2HI, 0xFFFF, 0);\n\tSPEX(ant_available_a, SSB_SPROM8_ANTAVAIL, SSB_SPROM8_ANTAVAIL_A,\n\t     SSB_SPROM8_ANTAVAIL_A_SHIFT);\n\tSPEX(ant_available_bg, SSB_SPROM8_ANTAVAIL, SSB_SPROM8_ANTAVAIL_BG,\n\t     SSB_SPROM8_ANTAVAIL_BG_SHIFT);\n\tSPEX(maxpwr_bg, SSB_SPROM8_MAXP_BG, SSB_SPROM8_MAXP_BG_MASK, 0);\n\tSPEX(itssi_bg, SSB_SPROM8_MAXP_BG, SSB_SPROM8_ITSSI_BG,\n\t     SSB_SPROM8_ITSSI_BG_SHIFT);\n\tSPEX(maxpwr_a, SSB_SPROM8_MAXP_A, SSB_SPROM8_MAXP_A_MASK, 0);\n\tSPEX(itssi_a, SSB_SPROM8_MAXP_A, SSB_SPROM8_ITSSI_A,\n\t     SSB_SPROM8_ITSSI_A_SHIFT);\n\tSPEX(maxpwr_ah, SSB_SPROM8_MAXP_AHL, SSB_SPROM8_MAXP_AH_MASK, 0);\n\tSPEX(maxpwr_al, SSB_SPROM8_MAXP_AHL, SSB_SPROM8_MAXP_AL_MASK,\n\t     SSB_SPROM8_MAXP_AL_SHIFT);\n\tSPEX(gpio0, SSB_SPROM8_GPIOA, SSB_SPROM8_GPIOA_P0, 0);\n\tSPEX(gpio1, SSB_SPROM8_GPIOA, SSB_SPROM8_GPIOA_P1,\n\t     SSB_SPROM8_GPIOA_P1_SHIFT);\n\tSPEX(gpio2, SSB_SPROM8_GPIOB, SSB_SPROM8_GPIOB_P2, 0);\n\tSPEX(gpio3, SSB_SPROM8_GPIOB, SSB_SPROM8_GPIOB_P3,\n\t     SSB_SPROM8_GPIOB_P3_SHIFT);\n\tSPEX(tri2g, SSB_SPROM8_TRI25G, SSB_SPROM8_TRI2G, 0);\n\tSPEX(tri5g, SSB_SPROM8_TRI25G, SSB_SPROM8_TRI5G,\n\t     SSB_SPROM8_TRI5G_SHIFT);\n\tSPEX(tri5gl, SSB_SPROM8_TRI5GHL, SSB_SPROM8_TRI5GL, 0);\n\tSPEX(tri5gh, SSB_SPROM8_TRI5GHL, SSB_SPROM8_TRI5GH,\n\t     SSB_SPROM8_TRI5GH_SHIFT);\n\tSPEX(rxpo2g, SSB_SPROM8_RXPO, SSB_SPROM8_RXPO2G, 0);\n\tSPEX(rxpo5g, SSB_SPROM8_RXPO, SSB_SPROM8_RXPO5G,\n\t     SSB_SPROM8_RXPO5G_SHIFT);\n\tSPEX(rssismf2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_RSSISMF2G, 0);\n\tSPEX(rssismc2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_RSSISMC2G,\n\t     SSB_SPROM8_RSSISMC2G_SHIFT);\n\tSPEX(rssisav2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_RSSISAV2G,\n\t     SSB_SPROM8_RSSISAV2G_SHIFT);\n\tSPEX(bxa2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_BXA2G,\n\t     SSB_SPROM8_BXA2G_SHIFT);\n\tSPEX(rssismf5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_RSSISMF5G, 0);\n\tSPEX(rssismc5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_RSSISMC5G,\n\t     SSB_SPROM8_RSSISMC5G_SHIFT);\n\tSPEX(rssisav5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_RSSISAV5G,\n\t     SSB_SPROM8_RSSISAV5G_SHIFT);\n\tSPEX(bxa5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_BXA5G,\n\t     SSB_SPROM8_BXA5G_SHIFT);\n\tSPEX(pa0b0, SSB_SPROM8_PA0B0, 0xFFFF, 0);\n\tSPEX(pa0b1, SSB_SPROM8_PA0B1, 0xFFFF, 0);\n\tSPEX(pa0b2, SSB_SPROM8_PA0B2, 0xFFFF, 0);\n\tSPEX(pa1b0, SSB_SPROM8_PA1B0, 0xFFFF, 0);\n\tSPEX(pa1b1, SSB_SPROM8_PA1B1, 0xFFFF, 0);\n\tSPEX(pa1b2, SSB_SPROM8_PA1B2, 0xFFFF, 0);\n\tSPEX(pa1lob0, SSB_SPROM8_PA1LOB0, 0xFFFF, 0);\n\tSPEX(pa1lob1, SSB_SPROM8_PA1LOB1, 0xFFFF, 0);\n\tSPEX(pa1lob2, SSB_SPROM8_PA1LOB2, 0xFFFF, 0);\n\tSPEX(pa1hib0, SSB_SPROM8_PA1HIB0, 0xFFFF, 0);\n\tSPEX(pa1hib1, SSB_SPROM8_PA1HIB1, 0xFFFF, 0);\n\tSPEX(pa1hib2, SSB_SPROM8_PA1HIB2, 0xFFFF, 0);\n\tSPEX(cck2gpo, SSB_SPROM8_CCK2GPO, 0xFFFF, 0);\n\tSPEX32(ofdm2gpo, SSB_SPROM8_OFDM2GPO, 0xFFFFFFFF, 0);\n\tSPEX32(ofdm5glpo, SSB_SPROM8_OFDM5GLPO, 0xFFFFFFFF, 0);\n\tSPEX32(ofdm5gpo, SSB_SPROM8_OFDM5GPO, 0xFFFFFFFF, 0);\n\tSPEX32(ofdm5ghpo, SSB_SPROM8_OFDM5GHPO, 0xFFFFFFFF, 0);\n\n\t \n\tout->antenna_gain.a0 = sprom_extract_antgain(out->revision, in,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN01,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN0,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN0_SHIFT);\n\tout->antenna_gain.a1 = sprom_extract_antgain(out->revision, in,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN01,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN1,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN1_SHIFT);\n\tout->antenna_gain.a2 = sprom_extract_antgain(out->revision, in,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN23,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN2,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN2_SHIFT);\n\tout->antenna_gain.a3 = sprom_extract_antgain(out->revision, in,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN23,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN3,\n\t\t\t\t\t\t     SSB_SPROM8_AGAIN3_SHIFT);\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(pwr_info_offset); i++) {\n\t\to = pwr_info_offset[i];\n\t\tSPEX(core_pwr_info[i].itssi_2g, o + SSB_SROM8_2G_MAXP_ITSSI,\n\t\t\tSSB_SPROM8_2G_ITSSI, SSB_SPROM8_2G_ITSSI_SHIFT);\n\t\tSPEX(core_pwr_info[i].maxpwr_2g, o + SSB_SROM8_2G_MAXP_ITSSI,\n\t\t\tSSB_SPROM8_2G_MAXP, 0);\n\n\t\tSPEX(core_pwr_info[i].pa_2g[0], o + SSB_SROM8_2G_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_2g[1], o + SSB_SROM8_2G_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_2g[2], o + SSB_SROM8_2G_PA_2, ~0, 0);\n\n\t\tSPEX(core_pwr_info[i].itssi_5g, o + SSB_SROM8_5G_MAXP_ITSSI,\n\t\t\tSSB_SPROM8_5G_ITSSI, SSB_SPROM8_5G_ITSSI_SHIFT);\n\t\tSPEX(core_pwr_info[i].maxpwr_5g, o + SSB_SROM8_5G_MAXP_ITSSI,\n\t\t\tSSB_SPROM8_5G_MAXP, 0);\n\t\tSPEX(core_pwr_info[i].maxpwr_5gh, o + SSB_SPROM8_5GHL_MAXP,\n\t\t\tSSB_SPROM8_5GH_MAXP, 0);\n\t\tSPEX(core_pwr_info[i].maxpwr_5gl, o + SSB_SPROM8_5GHL_MAXP,\n\t\t\tSSB_SPROM8_5GL_MAXP, SSB_SPROM8_5GL_MAXP_SHIFT);\n\n\t\tSPEX(core_pwr_info[i].pa_5gl[0], o + SSB_SROM8_5GL_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gl[1], o + SSB_SROM8_5GL_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gl[2], o + SSB_SROM8_5GL_PA_2, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5g[0], o + SSB_SROM8_5G_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5g[1], o + SSB_SROM8_5G_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5g[2], o + SSB_SROM8_5G_PA_2, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gh[0], o + SSB_SROM8_5GH_PA_0, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gh[1], o + SSB_SROM8_5GH_PA_1, ~0, 0);\n\t\tSPEX(core_pwr_info[i].pa_5gh[2], o + SSB_SROM8_5GH_PA_2, ~0, 0);\n\t}\n\n\t \n\tSPEX(fem.ghz2.tssipos, SSB_SPROM8_FEM2G,\n\t\tSSB_SROM8_FEM_TSSIPOS, SSB_SROM8_FEM_TSSIPOS_SHIFT);\n\tSPEX(fem.ghz2.extpa_gain, SSB_SPROM8_FEM2G,\n\t\tSSB_SROM8_FEM_EXTPA_GAIN, SSB_SROM8_FEM_EXTPA_GAIN_SHIFT);\n\tSPEX(fem.ghz2.pdet_range, SSB_SPROM8_FEM2G,\n\t\tSSB_SROM8_FEM_PDET_RANGE, SSB_SROM8_FEM_PDET_RANGE_SHIFT);\n\tSPEX(fem.ghz2.tr_iso, SSB_SPROM8_FEM2G,\n\t\tSSB_SROM8_FEM_TR_ISO, SSB_SROM8_FEM_TR_ISO_SHIFT);\n\tSPEX(fem.ghz2.antswlut, SSB_SPROM8_FEM2G,\n\t\tSSB_SROM8_FEM_ANTSWLUT, SSB_SROM8_FEM_ANTSWLUT_SHIFT);\n\n\tSPEX(fem.ghz5.tssipos, SSB_SPROM8_FEM5G,\n\t\tSSB_SROM8_FEM_TSSIPOS, SSB_SROM8_FEM_TSSIPOS_SHIFT);\n\tSPEX(fem.ghz5.extpa_gain, SSB_SPROM8_FEM5G,\n\t\tSSB_SROM8_FEM_EXTPA_GAIN, SSB_SROM8_FEM_EXTPA_GAIN_SHIFT);\n\tSPEX(fem.ghz5.pdet_range, SSB_SPROM8_FEM5G,\n\t\tSSB_SROM8_FEM_PDET_RANGE, SSB_SROM8_FEM_PDET_RANGE_SHIFT);\n\tSPEX(fem.ghz5.tr_iso, SSB_SPROM8_FEM5G,\n\t\tSSB_SROM8_FEM_TR_ISO, SSB_SROM8_FEM_TR_ISO_SHIFT);\n\tSPEX(fem.ghz5.antswlut, SSB_SPROM8_FEM5G,\n\t\tSSB_SROM8_FEM_ANTSWLUT, SSB_SROM8_FEM_ANTSWLUT_SHIFT);\n\n\tSPEX(leddc_on_time, SSB_SPROM8_LEDDC, SSB_SPROM8_LEDDC_ON,\n\t     SSB_SPROM8_LEDDC_ON_SHIFT);\n\tSPEX(leddc_off_time, SSB_SPROM8_LEDDC, SSB_SPROM8_LEDDC_OFF,\n\t     SSB_SPROM8_LEDDC_OFF_SHIFT);\n\n\tSPEX(txchain, SSB_SPROM8_TXRXC, SSB_SPROM8_TXRXC_TXCHAIN,\n\t     SSB_SPROM8_TXRXC_TXCHAIN_SHIFT);\n\tSPEX(rxchain, SSB_SPROM8_TXRXC, SSB_SPROM8_TXRXC_RXCHAIN,\n\t     SSB_SPROM8_TXRXC_RXCHAIN_SHIFT);\n\tSPEX(antswitch, SSB_SPROM8_TXRXC, SSB_SPROM8_TXRXC_SWITCH,\n\t     SSB_SPROM8_TXRXC_SWITCH_SHIFT);\n\n\tSPEX(opo, SSB_SPROM8_OFDM2GPO, 0x00ff, 0);\n\n\tSPEX_ARRAY8(mcs2gpo, SSB_SPROM8_2G_MCSPO, ~0, 0);\n\tSPEX_ARRAY8(mcs5gpo, SSB_SPROM8_5G_MCSPO, ~0, 0);\n\tSPEX_ARRAY8(mcs5glpo, SSB_SPROM8_5GL_MCSPO, ~0, 0);\n\tSPEX_ARRAY8(mcs5ghpo, SSB_SPROM8_5GH_MCSPO, ~0, 0);\n\n\tSPEX(rawtempsense, SSB_SPROM8_RAWTS, SSB_SPROM8_RAWTS_RAWTEMP,\n\t     SSB_SPROM8_RAWTS_RAWTEMP_SHIFT);\n\tSPEX(measpower, SSB_SPROM8_RAWTS, SSB_SPROM8_RAWTS_MEASPOWER,\n\t     SSB_SPROM8_RAWTS_MEASPOWER_SHIFT);\n\tSPEX(tempsense_slope, SSB_SPROM8_OPT_CORRX,\n\t     SSB_SPROM8_OPT_CORRX_TEMP_SLOPE,\n\t     SSB_SPROM8_OPT_CORRX_TEMP_SLOPE_SHIFT);\n\tSPEX(tempcorrx, SSB_SPROM8_OPT_CORRX, SSB_SPROM8_OPT_CORRX_TEMPCORRX,\n\t     SSB_SPROM8_OPT_CORRX_TEMPCORRX_SHIFT);\n\tSPEX(tempsense_option, SSB_SPROM8_OPT_CORRX,\n\t     SSB_SPROM8_OPT_CORRX_TEMP_OPTION,\n\t     SSB_SPROM8_OPT_CORRX_TEMP_OPTION_SHIFT);\n\tSPEX(freqoffset_corr, SSB_SPROM8_HWIQ_IQSWP,\n\t     SSB_SPROM8_HWIQ_IQSWP_FREQ_CORR,\n\t     SSB_SPROM8_HWIQ_IQSWP_FREQ_CORR_SHIFT);\n\tSPEX(iqcal_swp_dis, SSB_SPROM8_HWIQ_IQSWP,\n\t     SSB_SPROM8_HWIQ_IQSWP_IQCAL_SWP,\n\t     SSB_SPROM8_HWIQ_IQSWP_IQCAL_SWP_SHIFT);\n\tSPEX(hw_iqcal_en, SSB_SPROM8_HWIQ_IQSWP, SSB_SPROM8_HWIQ_IQSWP_HW_IQCAL,\n\t     SSB_SPROM8_HWIQ_IQSWP_HW_IQCAL_SHIFT);\n\n\tSPEX(bw40po, SSB_SPROM8_BW40PO, ~0, 0);\n\tSPEX(cddpo, SSB_SPROM8_CDDPO, ~0, 0);\n\tSPEX(stbcpo, SSB_SPROM8_STBCPO, ~0, 0);\n\tSPEX(bwduppo, SSB_SPROM8_BWDUPPO, ~0, 0);\n\n\tSPEX(tempthresh, SSB_SPROM8_THERMAL, SSB_SPROM8_THERMAL_TRESH,\n\t     SSB_SPROM8_THERMAL_TRESH_SHIFT);\n\tSPEX(tempoffset, SSB_SPROM8_THERMAL, SSB_SPROM8_THERMAL_OFFSET,\n\t     SSB_SPROM8_THERMAL_OFFSET_SHIFT);\n\tSPEX(phycal_tempdelta, SSB_SPROM8_TEMPDELTA,\n\t     SSB_SPROM8_TEMPDELTA_PHYCAL,\n\t     SSB_SPROM8_TEMPDELTA_PHYCAL_SHIFT);\n\tSPEX(temps_period, SSB_SPROM8_TEMPDELTA, SSB_SPROM8_TEMPDELTA_PERIOD,\n\t     SSB_SPROM8_TEMPDELTA_PERIOD_SHIFT);\n\tSPEX(temps_hysteresis, SSB_SPROM8_TEMPDELTA,\n\t     SSB_SPROM8_TEMPDELTA_HYSTERESIS,\n\t     SSB_SPROM8_TEMPDELTA_HYSTERESIS_SHIFT);\n\tsprom_extract_r458(out, in);\n\n\t \n}\n\nstatic int sprom_extract(struct ssb_bus *bus, struct ssb_sprom *out,\n\t\t\t const u16 *in, u16 size)\n{\n\tmemset(out, 0, sizeof(*out));\n\n\tout->revision = in[size - 1] & 0x00FF;\n\tpr_debug(\"SPROM revision %d detected\\n\", out->revision);\n\tmemset(out->et0mac, 0xFF, 6);\t\t \n\tmemset(out->et1mac, 0xFF, 6);\n\n\tif ((bus->chip_id & 0xFF00) == 0x4400) {\n\t\t \n\t\tout->revision = 1;\n\t\tpr_debug(\"SPROM treated as revision %d\\n\", out->revision);\n\t}\n\n\tswitch (out->revision) {\n\tcase 1:\n\tcase 2:\n\tcase 3:\n\t\tsprom_extract_r123(out, in);\n\t\tbreak;\n\tcase 4:\n\tcase 5:\n\t\tsprom_extract_r45(out, in);\n\t\tbreak;\n\tcase 8:\n\t\tsprom_extract_r8(out, in);\n\t\tbreak;\n\tdefault:\n\t\tpr_warn(\"Unsupported SPROM revision %d detected. Will extract v1\\n\",\n\t\t\tout->revision);\n\t\tout->revision = 1;\n\t\tsprom_extract_r123(out, in);\n\t}\n\n\tif (out->boardflags_lo == 0xFFFF)\n\t\tout->boardflags_lo = 0;   \n\tif (out->boardflags_hi == 0xFFFF)\n\t\tout->boardflags_hi = 0;   \n\n\treturn 0;\n}\n\nstatic int ssb_pci_sprom_get(struct ssb_bus *bus,\n\t\t\t     struct ssb_sprom *sprom)\n{\n\tint err;\n\tu16 *buf;\n\n\tif (!ssb_is_sprom_available(bus)) {\n\t\tpr_err(\"No SPROM available!\\n\");\n\t\treturn -ENODEV;\n\t}\n\tif (bus->chipco.dev) {\t \n\t\t \n\t\tif (bus->chipco.dev->id.revision >= 31)\n\t\t\tbus->sprom_offset = SSB_SPROM_BASE31;\n\t\telse if (bus->chip_id == 0x4312 &&\n\t\t\t (bus->chipco.status & 0x03) == 2)\n\t\t\tbus->sprom_offset = SSB_SPROM_BASE31;\n\t\telse\n\t\t\tbus->sprom_offset = SSB_SPROM_BASE1;\n\t} else {\n\t\tbus->sprom_offset = SSB_SPROM_BASE1;\n\t}\n\tpr_debug(\"SPROM offset is 0x%x\\n\", bus->sprom_offset);\n\n\tbuf = kcalloc(SSB_SPROMSIZE_WORDS_R123, sizeof(u16), GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\tbus->sprom_size = SSB_SPROMSIZE_WORDS_R123;\n\tsprom_do_read(bus, buf);\n\terr = sprom_check_crc(buf, bus->sprom_size);\n\tif (err) {\n\t\t \n\t\tkfree(buf);\n\t\tbuf = kcalloc(SSB_SPROMSIZE_WORDS_R4, sizeof(u16),\n\t\t\t      GFP_KERNEL);\n\t\tif (!buf)\n\t\t\treturn -ENOMEM;\n\t\tbus->sprom_size = SSB_SPROMSIZE_WORDS_R4;\n\t\tsprom_do_read(bus, buf);\n\t\terr = sprom_check_crc(buf, bus->sprom_size);\n\t\tif (err) {\n\t\t\t \n\t\t\terr = ssb_fill_sprom_with_fallback(bus, sprom);\n\t\t\tif (err) {\n\t\t\t\tpr_warn(\"WARNING: Using fallback SPROM failed (err %d)\\n\",\n\t\t\t\t\terr);\n\t\t\t\tgoto out_free;\n\t\t\t} else {\n\t\t\t\tpr_debug(\"Using SPROM revision %d provided by platform\\n\",\n\t\t\t\t\t sprom->revision);\n\t\t\t\terr = 0;\n\t\t\t\tgoto out_free;\n\t\t\t}\n\t\t}\n\t}\n\terr = sprom_extract(bus, sprom, buf, bus->sprom_size);\n\nout_free:\n\tkfree(buf);\n\treturn err;\n}\n\nstatic void ssb_pci_get_boardinfo(struct ssb_bus *bus,\n\t\t\t\t  struct ssb_boardinfo *bi)\n{\n\tbi->vendor = bus->host_pci->subsystem_vendor;\n\tbi->type = bus->host_pci->subsystem_device;\n}\n\nint ssb_pci_get_invariants(struct ssb_bus *bus,\n\t\t\t   struct ssb_init_invariants *iv)\n{\n\tint err;\n\n\terr = ssb_pci_sprom_get(bus, &iv->sprom);\n\tif (err)\n\t\tgoto out;\n\tssb_pci_get_boardinfo(bus, &iv->boardinfo);\n\nout:\n\treturn err;\n}\n\nstatic int ssb_pci_assert_buspower(struct ssb_bus *bus)\n{\n\tif (likely(bus->powered_up))\n\t\treturn 0;\n\n\tpr_err(\"FATAL ERROR: Bus powered down while accessing PCI MMIO space\\n\");\n\tif (bus->power_warn_count <= 10) {\n\t\tbus->power_warn_count++;\n\t\tdump_stack();\n\t}\n\n\treturn -ENODEV;\n}\n\nstatic u8 ssb_pci_read8(struct ssb_device *dev, u16 offset)\n{\n\tstruct ssb_bus *bus = dev->bus;\n\n\tif (unlikely(ssb_pci_assert_buspower(bus)))\n\t\treturn 0xFF;\n\tif (unlikely(bus->mapped_device != dev)) {\n\t\tif (unlikely(ssb_pci_switch_core(bus, dev)))\n\t\t\treturn 0xFF;\n\t}\n\treturn ioread8(bus->mmio + offset);\n}\n\nstatic u16 ssb_pci_read16(struct ssb_device *dev, u16 offset)\n{\n\tstruct ssb_bus *bus = dev->bus;\n\n\tif (unlikely(ssb_pci_assert_buspower(bus)))\n\t\treturn 0xFFFF;\n\tif (unlikely(bus->mapped_device != dev)) {\n\t\tif (unlikely(ssb_pci_switch_core(bus, dev)))\n\t\t\treturn 0xFFFF;\n\t}\n\treturn ioread16(bus->mmio + offset);\n}\n\nstatic u32 ssb_pci_read32(struct ssb_device *dev, u16 offset)\n{\n\tstruct ssb_bus *bus = dev->bus;\n\n\tif (unlikely(ssb_pci_assert_buspower(bus)))\n\t\treturn 0xFFFFFFFF;\n\tif (unlikely(bus->mapped_device != dev)) {\n\t\tif (unlikely(ssb_pci_switch_core(bus, dev)))\n\t\t\treturn 0xFFFFFFFF;\n\t}\n\treturn ioread32(bus->mmio + offset);\n}\n\n#ifdef CONFIG_SSB_BLOCKIO\nstatic void ssb_pci_block_read(struct ssb_device *dev, void *buffer,\n\t\t\t       size_t count, u16 offset, u8 reg_width)\n{\n\tstruct ssb_bus *bus = dev->bus;\n\tvoid __iomem *addr = bus->mmio + offset;\n\n\tif (unlikely(ssb_pci_assert_buspower(bus)))\n\t\tgoto error;\n\tif (unlikely(bus->mapped_device != dev)) {\n\t\tif (unlikely(ssb_pci_switch_core(bus, dev)))\n\t\t\tgoto error;\n\t}\n\tswitch (reg_width) {\n\tcase sizeof(u8):\n\t\tioread8_rep(addr, buffer, count);\n\t\tbreak;\n\tcase sizeof(u16):\n\t\tWARN_ON(count & 1);\n\t\tioread16_rep(addr, buffer, count >> 1);\n\t\tbreak;\n\tcase sizeof(u32):\n\t\tWARN_ON(count & 3);\n\t\tioread32_rep(addr, buffer, count >> 2);\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON(1);\n\t}\n\n\treturn;\nerror:\n\tmemset(buffer, 0xFF, count);\n}\n#endif  \n\nstatic void ssb_pci_write8(struct ssb_device *dev, u16 offset, u8 value)\n{\n\tstruct ssb_bus *bus = dev->bus;\n\n\tif (unlikely(ssb_pci_assert_buspower(bus)))\n\t\treturn;\n\tif (unlikely(bus->mapped_device != dev)) {\n\t\tif (unlikely(ssb_pci_switch_core(bus, dev)))\n\t\t\treturn;\n\t}\n\tiowrite8(value, bus->mmio + offset);\n}\n\nstatic void ssb_pci_write16(struct ssb_device *dev, u16 offset, u16 value)\n{\n\tstruct ssb_bus *bus = dev->bus;\n\n\tif (unlikely(ssb_pci_assert_buspower(bus)))\n\t\treturn;\n\tif (unlikely(bus->mapped_device != dev)) {\n\t\tif (unlikely(ssb_pci_switch_core(bus, dev)))\n\t\t\treturn;\n\t}\n\tiowrite16(value, bus->mmio + offset);\n}\n\nstatic void ssb_pci_write32(struct ssb_device *dev, u16 offset, u32 value)\n{\n\tstruct ssb_bus *bus = dev->bus;\n\n\tif (unlikely(ssb_pci_assert_buspower(bus)))\n\t\treturn;\n\tif (unlikely(bus->mapped_device != dev)) {\n\t\tif (unlikely(ssb_pci_switch_core(bus, dev)))\n\t\t\treturn;\n\t}\n\tiowrite32(value, bus->mmio + offset);\n}\n\n#ifdef CONFIG_SSB_BLOCKIO\nstatic void ssb_pci_block_write(struct ssb_device *dev, const void *buffer,\n\t\t\t\tsize_t count, u16 offset, u8 reg_width)\n{\n\tstruct ssb_bus *bus = dev->bus;\n\tvoid __iomem *addr = bus->mmio + offset;\n\n\tif (unlikely(ssb_pci_assert_buspower(bus)))\n\t\treturn;\n\tif (unlikely(bus->mapped_device != dev)) {\n\t\tif (unlikely(ssb_pci_switch_core(bus, dev)))\n\t\t\treturn;\n\t}\n\tswitch (reg_width) {\n\tcase sizeof(u8):\n\t\tiowrite8_rep(addr, buffer, count);\n\t\tbreak;\n\tcase sizeof(u16):\n\t\tWARN_ON(count & 1);\n\t\tiowrite16_rep(addr, buffer, count >> 1);\n\t\tbreak;\n\tcase sizeof(u32):\n\t\tWARN_ON(count & 3);\n\t\tiowrite32_rep(addr, buffer, count >> 2);\n\t\tbreak;\n\tdefault:\n\t\tWARN_ON(1);\n\t}\n}\n#endif  \n\n \nconst struct ssb_bus_ops ssb_pci_ops = {\n\t.read8\t\t= ssb_pci_read8,\n\t.read16\t\t= ssb_pci_read16,\n\t.read32\t\t= ssb_pci_read32,\n\t.write8\t\t= ssb_pci_write8,\n\t.write16\t= ssb_pci_write16,\n\t.write32\t= ssb_pci_write32,\n#ifdef CONFIG_SSB_BLOCKIO\n\t.block_read\t= ssb_pci_block_read,\n\t.block_write\t= ssb_pci_block_write,\n#endif\n};\n\nstatic ssize_t ssb_sprom_show(struct device *pcidev,\n\t\t\t      struct device_attribute *attr,\n\t\t\t      char *buf)\n{\n\tstruct pci_dev *pdev = container_of(pcidev, struct pci_dev, dev);\n\tstruct ssb_bus *bus;\n\n\tbus = ssb_pci_dev_to_bus(pdev);\n\tif (!bus)\n\t\treturn -ENODEV;\n\n\treturn ssb_attr_sprom_show(bus, buf, sprom_do_read);\n}\n\nstatic ssize_t ssb_sprom_store(struct device *pcidev,\n\t\t\t       struct device_attribute *attr,\n\t\t\t       const char *buf, size_t count)\n{\n\tstruct pci_dev *pdev = container_of(pcidev, struct pci_dev, dev);\n\tstruct ssb_bus *bus;\n\n\tbus = ssb_pci_dev_to_bus(pdev);\n\tif (!bus)\n\t\treturn -ENODEV;\n\n\treturn ssb_attr_sprom_store(bus, buf, count,\n\t\t\t\t    sprom_check_crc, sprom_do_write);\n}\n\nstatic DEVICE_ATTR_ADMIN_RW(ssb_sprom);\n\nvoid ssb_pci_exit(struct ssb_bus *bus)\n{\n\tstruct pci_dev *pdev;\n\n\tif (bus->bustype != SSB_BUSTYPE_PCI)\n\t\treturn;\n\n\tpdev = bus->host_pci;\n\tdevice_remove_file(&pdev->dev, &dev_attr_ssb_sprom);\n}\n\nint ssb_pci_init(struct ssb_bus *bus)\n{\n\tstruct pci_dev *pdev;\n\n\tif (bus->bustype != SSB_BUSTYPE_PCI)\n\t\treturn 0;\n\n\tpdev = bus->host_pci;\n\tmutex_init(&bus->sprom_mutex);\n\n\treturn device_create_file(&pdev->dev, &dev_attr_ssb_sprom);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}