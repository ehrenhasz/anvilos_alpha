{
  "module_name": "pinctrl-bcm6358.c",
  "hash_id": "ae6a556696d4c9612025464b6c0cb532ee83ba773910652dcd7e2cc4ed256f31",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pinctrl/bcm/pinctrl-bcm6358.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/gpio/driver.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/pinctrl/pinmux.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#include \"../pinctrl-utils.h\"\n\n#include \"pinctrl-bcm63xx.h\"\n\n#define BCM6358_NUM_GPIOS\t\t40\n\n#define BCM6358_MODE_REG\t\t0x18\n#define  BCM6358_MODE_MUX_NONE\t\t0\n#define  BCM6358_MODE_MUX_EBI_CS\tBIT(5)\n#define  BCM6358_MODE_MUX_UART1\t\tBIT(6)\n#define  BCM6358_MODE_MUX_SPI_CS\tBIT(7)\n#define  BCM6358_MODE_MUX_ASYNC_MODEM\tBIT(8)\n#define  BCM6358_MODE_MUX_LEGACY_LED\tBIT(9)\n#define  BCM6358_MODE_MUX_SERIAL_LED\tBIT(10)\n#define  BCM6358_MODE_MUX_LED\t\tBIT(11)\n#define  BCM6358_MODE_MUX_UTOPIA\tBIT(12)\n#define  BCM6358_MODE_MUX_CLKRST\tBIT(13)\n#define  BCM6358_MODE_MUX_PWM_SYN_CLK\tBIT(14)\n#define  BCM6358_MODE_MUX_SYS_IRQ\tBIT(15)\n\nstruct bcm6358_pingroup {\n\tstruct pingroup grp;\n\n\tconst uint16_t mode_val;\n\n\t \n\tconst uint16_t direction;\n};\n\nstruct bcm6358_function {\n\tconst char *name;\n\tconst char * const *groups;\n\tconst unsigned num_groups;\n};\n\nstruct bcm6358_priv {\n\tstruct regmap_field *overlays;\n};\n\n#define BCM6358_GPIO_PIN(a, b, bit1, bit2, bit3)\t\t\\\n\t{\t\t\t\t\t\t\t\\\n\t\t.number = a,\t\t\t\t\t\\\n\t\t.name = b,\t\t\t\t\t\\\n\t\t.drv_data = (void *)(BCM6358_MODE_MUX_##bit1 |\t\\\n\t\t\t\t     BCM6358_MODE_MUX_##bit2 |\t\\\n\t\t\t\t     BCM6358_MODE_MUX_##bit3),\t\\\n\t}\n\nstatic const struct pinctrl_pin_desc bcm6358_pins[] = {\n\tBCM6358_GPIO_PIN(0, \"gpio0\", LED, NONE, NONE),\n\tBCM6358_GPIO_PIN(1, \"gpio1\", LED, NONE, NONE),\n\tBCM6358_GPIO_PIN(2, \"gpio2\", LED, NONE, NONE),\n\tBCM6358_GPIO_PIN(3, \"gpio3\", LED, NONE, NONE),\n\tPINCTRL_PIN(4, \"gpio4\"),\n\tBCM6358_GPIO_PIN(5, \"gpio5\", SYS_IRQ, NONE, NONE),\n\tBCM6358_GPIO_PIN(6, \"gpio6\", SERIAL_LED, NONE, NONE),\n\tBCM6358_GPIO_PIN(7, \"gpio7\", SERIAL_LED, NONE, NONE),\n\tBCM6358_GPIO_PIN(8, \"gpio8\", PWM_SYN_CLK, NONE, NONE),\n\tBCM6358_GPIO_PIN(9, \"gpio09\", LEGACY_LED, NONE, NONE),\n\tBCM6358_GPIO_PIN(10, \"gpio10\", LEGACY_LED, NONE, NONE),\n\tBCM6358_GPIO_PIN(11, \"gpio11\", LEGACY_LED, NONE, NONE),\n\tBCM6358_GPIO_PIN(12, \"gpio12\", LEGACY_LED, ASYNC_MODEM, UTOPIA),\n\tBCM6358_GPIO_PIN(13, \"gpio13\", LEGACY_LED, ASYNC_MODEM, UTOPIA),\n\tBCM6358_GPIO_PIN(14, \"gpio14\", LEGACY_LED, ASYNC_MODEM, UTOPIA),\n\tBCM6358_GPIO_PIN(15, \"gpio15\", LEGACY_LED, ASYNC_MODEM, UTOPIA),\n\tPINCTRL_PIN(16, \"gpio16\"),\n\tPINCTRL_PIN(17, \"gpio17\"),\n\tPINCTRL_PIN(18, \"gpio18\"),\n\tPINCTRL_PIN(19, \"gpio19\"),\n\tPINCTRL_PIN(20, \"gpio20\"),\n\tPINCTRL_PIN(21, \"gpio21\"),\n\tBCM6358_GPIO_PIN(22, \"gpio22\", UTOPIA, NONE, NONE),\n\tBCM6358_GPIO_PIN(23, \"gpio23\", UTOPIA, NONE, NONE),\n\tBCM6358_GPIO_PIN(24, \"gpio24\", UTOPIA, NONE, NONE),\n\tBCM6358_GPIO_PIN(25, \"gpio25\", UTOPIA, NONE, NONE),\n\tBCM6358_GPIO_PIN(26, \"gpio26\", UTOPIA, NONE, NONE),\n\tBCM6358_GPIO_PIN(27, \"gpio27\", UTOPIA, NONE, NONE),\n\tBCM6358_GPIO_PIN(28, \"gpio28\", UTOPIA, UART1, NONE),\n\tBCM6358_GPIO_PIN(29, \"gpio29\", UTOPIA, UART1, NONE),\n\tBCM6358_GPIO_PIN(30, \"gpio30\", UTOPIA, UART1, EBI_CS),\n\tBCM6358_GPIO_PIN(31, \"gpio31\", UTOPIA, UART1, EBI_CS),\n\tBCM6358_GPIO_PIN(32, \"gpio32\", SPI_CS, NONE, NONE),\n\tBCM6358_GPIO_PIN(33, \"gpio33\", SPI_CS, NONE, NONE),\n\tPINCTRL_PIN(34, \"gpio34\"),\n\tPINCTRL_PIN(35, \"gpio35\"),\n\tPINCTRL_PIN(36, \"gpio36\"),\n\tPINCTRL_PIN(37, \"gpio37\"),\n\tPINCTRL_PIN(38, \"gpio38\"),\n\tPINCTRL_PIN(39, \"gpio39\"),\n};\n\nstatic unsigned ebi_cs_grp_pins[] = { 30, 31 };\n\nstatic unsigned uart1_grp_pins[] = { 28, 29, 30, 31 };\n\nstatic unsigned spi_cs_grp_pins[] = { 32, 33 };\n\nstatic unsigned async_modem_grp_pins[] = { 12, 13, 14, 15 };\n\nstatic unsigned serial_led_grp_pins[] = { 6, 7 };\n\nstatic unsigned legacy_led_grp_pins[] = { 9, 10, 11, 12, 13, 14, 15 };\n\nstatic unsigned led_grp_pins[] = { 0, 1, 2, 3 };\n\nstatic unsigned utopia_grp_pins[] = {\n\t12, 13, 14, 15, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31,\n};\n\nstatic unsigned pwm_syn_clk_grp_pins[] = { 8 };\n\nstatic unsigned sys_irq_grp_pins[] = { 5 };\n\n#define BCM6358_GPIO_MUX_GROUP(n, bit, dir)\t\t\t\\\n\t{\t\t\t\t\t\t\t\\\n\t\t.grp = BCM_PIN_GROUP(n),\t\t\t\\\n\t\t.mode_val = BCM6358_MODE_MUX_##bit,\t\t\\\n\t\t.direction = dir,\t\t\t\t\\\n\t}\n\nstatic const struct bcm6358_pingroup bcm6358_groups[] = {\n\tBCM6358_GPIO_MUX_GROUP(ebi_cs_grp, EBI_CS, 0x3),\n\tBCM6358_GPIO_MUX_GROUP(uart1_grp, UART1, 0x2),\n\tBCM6358_GPIO_MUX_GROUP(spi_cs_grp, SPI_CS, 0x6),\n\tBCM6358_GPIO_MUX_GROUP(async_modem_grp, ASYNC_MODEM, 0x6),\n\tBCM6358_GPIO_MUX_GROUP(legacy_led_grp, LEGACY_LED, 0x7f),\n\tBCM6358_GPIO_MUX_GROUP(serial_led_grp, SERIAL_LED, 0x3),\n\tBCM6358_GPIO_MUX_GROUP(led_grp, LED, 0xf),\n\tBCM6358_GPIO_MUX_GROUP(utopia_grp, UTOPIA, 0x000f),\n\tBCM6358_GPIO_MUX_GROUP(pwm_syn_clk_grp, PWM_SYN_CLK, 0x1),\n\tBCM6358_GPIO_MUX_GROUP(sys_irq_grp, SYS_IRQ, 0x1),\n};\n\nstatic const char * const ebi_cs_groups[] = {\n\t\"ebi_cs_grp\"\n};\n\nstatic const char * const uart1_groups[] = {\n\t\"uart1_grp\"\n};\n\nstatic const char * const spi_cs_2_3_groups[] = {\n\t\"spi_cs_2_3_grp\"\n};\n\nstatic const char * const async_modem_groups[] = {\n\t\"async_modem_grp\"\n};\n\nstatic const char * const legacy_led_groups[] = {\n\t\"legacy_led_grp\",\n};\n\nstatic const char * const serial_led_groups[] = {\n\t\"serial_led_grp\",\n};\n\nstatic const char * const led_groups[] = {\n\t\"led_grp\",\n};\n\nstatic const char * const clkrst_groups[] = {\n\t\"clkrst_grp\",\n};\n\nstatic const char * const pwm_syn_clk_groups[] = {\n\t\"pwm_syn_clk_grp\",\n};\n\nstatic const char * const sys_irq_groups[] = {\n\t\"sys_irq_grp\",\n};\n\n#define BCM6358_FUN(n)\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\\\n\t\t.name = #n,\t\t\t\t\\\n\t\t.groups = n##_groups,\t\t\t\\\n\t\t.num_groups = ARRAY_SIZE(n##_groups),\t\\\n\t}\n\nstatic const struct bcm6358_function bcm6358_funcs[] = {\n\tBCM6358_FUN(ebi_cs),\n\tBCM6358_FUN(uart1),\n\tBCM6358_FUN(spi_cs_2_3),\n\tBCM6358_FUN(async_modem),\n\tBCM6358_FUN(legacy_led),\n\tBCM6358_FUN(serial_led),\n\tBCM6358_FUN(led),\n\tBCM6358_FUN(clkrst),\n\tBCM6358_FUN(pwm_syn_clk),\n\tBCM6358_FUN(sys_irq),\n};\n\nstatic int bcm6358_pinctrl_get_group_count(struct pinctrl_dev *pctldev)\n{\n\treturn ARRAY_SIZE(bcm6358_groups);\n}\n\nstatic const char *bcm6358_pinctrl_get_group_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t\t  unsigned group)\n{\n\treturn bcm6358_groups[group].grp.name;\n}\n\nstatic int bcm6358_pinctrl_get_group_pins(struct pinctrl_dev *pctldev,\n\t\t\t\t\t  unsigned group, const unsigned **pins,\n\t\t\t\t\t  unsigned *npins)\n{\n\t*pins = bcm6358_groups[group].grp.pins;\n\t*npins = bcm6358_groups[group].grp.npins;\n\n\treturn 0;\n}\n\nstatic int bcm6358_pinctrl_get_func_count(struct pinctrl_dev *pctldev)\n{\n\treturn ARRAY_SIZE(bcm6358_funcs);\n}\n\nstatic const char *bcm6358_pinctrl_get_func_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t\t unsigned selector)\n{\n\treturn bcm6358_funcs[selector].name;\n}\n\nstatic int bcm6358_pinctrl_get_groups(struct pinctrl_dev *pctldev,\n\t\t\t\t      unsigned selector,\n\t\t\t\t      const char * const **groups,\n\t\t\t\t      unsigned * const num_groups)\n{\n\t*groups = bcm6358_funcs[selector].groups;\n\t*num_groups = bcm6358_funcs[selector].num_groups;\n\n\treturn 0;\n}\n\nstatic int bcm6358_pinctrl_set_mux(struct pinctrl_dev *pctldev,\n\t\t\t\t   unsigned selector, unsigned group)\n{\n\tstruct bcm63xx_pinctrl *pc = pinctrl_dev_get_drvdata(pctldev);\n\tstruct bcm6358_priv *priv = pc->driver_data;\n\tconst struct bcm6358_pingroup *pg = &bcm6358_groups[group];\n\tunsigned int val = pg->mode_val;\n\tunsigned int mask = val;\n\tunsigned pin;\n\n\tfor (pin = 0; pin < pg->grp.npins; pin++)\n\t\tmask |= (unsigned long)bcm6358_pins[pin].drv_data;\n\n\tregmap_field_update_bits(priv->overlays, mask, val);\n\n\tfor (pin = 0; pin < pg->grp.npins; pin++) {\n\t\tstruct pinctrl_gpio_range *range;\n\t\tunsigned int hw_gpio = bcm6358_pins[pin].number;\n\n\t\trange = pinctrl_find_gpio_range_from_pin(pctldev, hw_gpio);\n\t\tif (range) {\n\t\t\tstruct gpio_chip *gc = range->gc;\n\n\t\t\tif (pg->direction & BIT(pin))\n\t\t\t\tgc->direction_output(gc, hw_gpio, 0);\n\t\t\telse\n\t\t\t\tgc->direction_input(gc, hw_gpio);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int bcm6358_gpio_request_enable(struct pinctrl_dev *pctldev,\n\t\t\t\t       struct pinctrl_gpio_range *range,\n\t\t\t\t       unsigned offset)\n{\n\tstruct bcm63xx_pinctrl *pc = pinctrl_dev_get_drvdata(pctldev);\n\tstruct bcm6358_priv *priv = pc->driver_data;\n\tunsigned int mask;\n\n\tmask = (unsigned long) bcm6358_pins[offset].drv_data;\n\tif (!mask)\n\t\treturn 0;\n\n\t \n\treturn regmap_field_update_bits(priv->overlays, mask, 0);\n}\n\nstatic const struct pinctrl_ops bcm6358_pctl_ops = {\n\t.dt_free_map = pinctrl_utils_free_map,\n\t.dt_node_to_map = pinconf_generic_dt_node_to_map_pin,\n\t.get_group_name = bcm6358_pinctrl_get_group_name,\n\t.get_group_pins = bcm6358_pinctrl_get_group_pins,\n\t.get_groups_count = bcm6358_pinctrl_get_group_count,\n};\n\nstatic const struct pinmux_ops bcm6358_pmx_ops = {\n\t.get_function_groups = bcm6358_pinctrl_get_groups,\n\t.get_function_name = bcm6358_pinctrl_get_func_name,\n\t.get_functions_count = bcm6358_pinctrl_get_func_count,\n\t.gpio_request_enable = bcm6358_gpio_request_enable,\n\t.set_mux = bcm6358_pinctrl_set_mux,\n\t.strict = true,\n};\n\nstatic const struct bcm63xx_pinctrl_soc bcm6358_soc = {\n\t.ngpios = BCM6358_NUM_GPIOS,\n\t.npins = ARRAY_SIZE(bcm6358_pins),\n\t.pctl_ops = &bcm6358_pctl_ops,\n\t.pins = bcm6358_pins,\n\t.pmx_ops = &bcm6358_pmx_ops,\n};\n\nstatic int bcm6358_pinctrl_probe(struct platform_device *pdev)\n{\n\tstruct reg_field overlays = REG_FIELD(BCM6358_MODE_REG, 0, 15);\n\tstruct device *dev = &pdev->dev;\n\tstruct bcm63xx_pinctrl *pc;\n\tstruct bcm6358_priv *priv;\n\tint err;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\terr = bcm63xx_pinctrl_probe(pdev, &bcm6358_soc, (void *) priv);\n\tif (err)\n\t\treturn err;\n\n\tpc = platform_get_drvdata(pdev);\n\n\tpriv->overlays = devm_regmap_field_alloc(dev, pc->regs, overlays);\n\tif (IS_ERR(priv->overlays))\n\t\treturn PTR_ERR(priv->overlays);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id bcm6358_pinctrl_match[] = {\n\t{ .compatible = \"brcm,bcm6358-pinctrl\", },\n\t{   }\n};\n\nstatic struct platform_driver bcm6358_pinctrl_driver = {\n\t.probe = bcm6358_pinctrl_probe,\n\t.driver = {\n\t\t.name = \"bcm6358-pinctrl\",\n\t\t.of_match_table = bcm6358_pinctrl_match,\n\t},\n};\n\nbuiltin_platform_driver(bcm6358_pinctrl_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}