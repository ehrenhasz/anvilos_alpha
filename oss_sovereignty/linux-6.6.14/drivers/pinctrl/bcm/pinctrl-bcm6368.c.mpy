{
  "module_name": "pinctrl-bcm6368.c",
  "hash_id": "86f4c72384f584707a6de9273d4b63685a2c14bf8a3569c4c7037fd74289a48a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pinctrl/bcm/pinctrl-bcm6368.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/gpio/driver.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/pinctrl/pinmux.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#include \"../pinctrl-utils.h\"\n\n#include \"pinctrl-bcm63xx.h\"\n\n#define BCM6368_NUM_GPIOS\t38\n\n#define BCM6368_MODE_REG\t0x18\n#define BCM6368_BASEMODE_REG\t0x38\n#define  BCM6368_BASEMODE_MASK\t0x7\n#define  BCM6368_BASEMODE_GPIO\t0x0\n#define  BCM6368_BASEMODE_UART1\t0x1\n\nstruct bcm6368_function {\n\tconst char *name;\n\tconst char * const *groups;\n\tconst unsigned num_groups;\n\n\tunsigned dir_out:16;\n\tunsigned basemode:3;\n};\n\nstruct bcm6368_priv {\n\tstruct regmap_field *overlays;\n};\n\n#define BCM6368_BASEMODE_PIN(a, b)\t\t\\\n\t{\t\t\t\t\t\\\n\t\t.number = a,\t\t\t\\\n\t\t.name = b,\t\t\t\\\n\t\t.drv_data = (void *)true\t\\\n\t}\n\nstatic const struct pinctrl_pin_desc bcm6368_pins[] = {\n\tPINCTRL_PIN(0, \"gpio0\"),\n\tPINCTRL_PIN(1, \"gpio1\"),\n\tPINCTRL_PIN(2, \"gpio2\"),\n\tPINCTRL_PIN(3, \"gpio3\"),\n\tPINCTRL_PIN(4, \"gpio4\"),\n\tPINCTRL_PIN(5, \"gpio5\"),\n\tPINCTRL_PIN(6, \"gpio6\"),\n\tPINCTRL_PIN(7, \"gpio7\"),\n\tPINCTRL_PIN(8, \"gpio8\"),\n\tPINCTRL_PIN(9, \"gpio9\"),\n\tPINCTRL_PIN(10, \"gpio10\"),\n\tPINCTRL_PIN(11, \"gpio11\"),\n\tPINCTRL_PIN(12, \"gpio12\"),\n\tPINCTRL_PIN(13, \"gpio13\"),\n\tPINCTRL_PIN(14, \"gpio14\"),\n\tPINCTRL_PIN(15, \"gpio15\"),\n\tPINCTRL_PIN(16, \"gpio16\"),\n\tPINCTRL_PIN(17, \"gpio17\"),\n\tPINCTRL_PIN(18, \"gpio18\"),\n\tPINCTRL_PIN(19, \"gpio19\"),\n\tPINCTRL_PIN(20, \"gpio20\"),\n\tPINCTRL_PIN(21, \"gpio21\"),\n\tPINCTRL_PIN(22, \"gpio22\"),\n\tPINCTRL_PIN(23, \"gpio23\"),\n\tPINCTRL_PIN(24, \"gpio24\"),\n\tPINCTRL_PIN(25, \"gpio25\"),\n\tPINCTRL_PIN(26, \"gpio26\"),\n\tPINCTRL_PIN(27, \"gpio27\"),\n\tPINCTRL_PIN(28, \"gpio28\"),\n\tPINCTRL_PIN(29, \"gpio29\"),\n\tBCM6368_BASEMODE_PIN(30, \"gpio30\"),\n\tBCM6368_BASEMODE_PIN(31, \"gpio31\"),\n\tBCM6368_BASEMODE_PIN(32, \"gpio32\"),\n\tBCM6368_BASEMODE_PIN(33, \"gpio33\"),\n\tPINCTRL_PIN(34, \"gpio34\"),\n\tPINCTRL_PIN(35, \"gpio35\"),\n\tPINCTRL_PIN(36, \"gpio36\"),\n\tPINCTRL_PIN(37, \"gpio37\"),\n};\n\nstatic unsigned gpio0_pins[] = { 0 };\nstatic unsigned gpio1_pins[] = { 1 };\nstatic unsigned gpio2_pins[] = { 2 };\nstatic unsigned gpio3_pins[] = { 3 };\nstatic unsigned gpio4_pins[] = { 4 };\nstatic unsigned gpio5_pins[] = { 5 };\nstatic unsigned gpio6_pins[] = { 6 };\nstatic unsigned gpio7_pins[] = { 7 };\nstatic unsigned gpio8_pins[] = { 8 };\nstatic unsigned gpio9_pins[] = { 9 };\nstatic unsigned gpio10_pins[] = { 10 };\nstatic unsigned gpio11_pins[] = { 11 };\nstatic unsigned gpio12_pins[] = { 12 };\nstatic unsigned gpio13_pins[] = { 13 };\nstatic unsigned gpio14_pins[] = { 14 };\nstatic unsigned gpio15_pins[] = { 15 };\nstatic unsigned gpio16_pins[] = { 16 };\nstatic unsigned gpio17_pins[] = { 17 };\nstatic unsigned gpio18_pins[] = { 18 };\nstatic unsigned gpio19_pins[] = { 19 };\nstatic unsigned gpio20_pins[] = { 20 };\nstatic unsigned gpio21_pins[] = { 21 };\nstatic unsigned gpio22_pins[] = { 22 };\nstatic unsigned gpio23_pins[] = { 23 };\nstatic unsigned gpio24_pins[] = { 24 };\nstatic unsigned gpio25_pins[] = { 25 };\nstatic unsigned gpio26_pins[] = { 26 };\nstatic unsigned gpio27_pins[] = { 27 };\nstatic unsigned gpio28_pins[] = { 28 };\nstatic unsigned gpio29_pins[] = { 29 };\nstatic unsigned gpio30_pins[] = { 30 };\nstatic unsigned gpio31_pins[] = { 31 };\nstatic unsigned uart1_grp_pins[] = { 30, 31, 32, 33 };\n\nstatic struct pingroup bcm6368_groups[] = {\n\tBCM_PIN_GROUP(gpio0),\n\tBCM_PIN_GROUP(gpio1),\n\tBCM_PIN_GROUP(gpio2),\n\tBCM_PIN_GROUP(gpio3),\n\tBCM_PIN_GROUP(gpio4),\n\tBCM_PIN_GROUP(gpio5),\n\tBCM_PIN_GROUP(gpio6),\n\tBCM_PIN_GROUP(gpio7),\n\tBCM_PIN_GROUP(gpio8),\n\tBCM_PIN_GROUP(gpio9),\n\tBCM_PIN_GROUP(gpio10),\n\tBCM_PIN_GROUP(gpio11),\n\tBCM_PIN_GROUP(gpio12),\n\tBCM_PIN_GROUP(gpio13),\n\tBCM_PIN_GROUP(gpio14),\n\tBCM_PIN_GROUP(gpio15),\n\tBCM_PIN_GROUP(gpio16),\n\tBCM_PIN_GROUP(gpio17),\n\tBCM_PIN_GROUP(gpio18),\n\tBCM_PIN_GROUP(gpio19),\n\tBCM_PIN_GROUP(gpio20),\n\tBCM_PIN_GROUP(gpio21),\n\tBCM_PIN_GROUP(gpio22),\n\tBCM_PIN_GROUP(gpio23),\n\tBCM_PIN_GROUP(gpio24),\n\tBCM_PIN_GROUP(gpio25),\n\tBCM_PIN_GROUP(gpio26),\n\tBCM_PIN_GROUP(gpio27),\n\tBCM_PIN_GROUP(gpio28),\n\tBCM_PIN_GROUP(gpio29),\n\tBCM_PIN_GROUP(gpio30),\n\tBCM_PIN_GROUP(gpio31),\n\tBCM_PIN_GROUP(uart1_grp),\n};\n\nstatic const char * const analog_afe_0_groups[] = {\n\t\"gpio0\",\n};\n\nstatic const char * const analog_afe_1_groups[] = {\n\t\"gpio1\",\n};\n\nstatic const char * const sys_irq_groups[] = {\n\t\"gpio2\",\n};\n\nstatic const char * const serial_led_data_groups[] = {\n\t\"gpio3\",\n};\n\nstatic const char * const serial_led_clk_groups[] = {\n\t\"gpio4\",\n};\n\nstatic const char * const inet_led_groups[] = {\n\t\"gpio5\",\n};\n\nstatic const char * const ephy0_led_groups[] = {\n\t\"gpio6\",\n};\n\nstatic const char * const ephy1_led_groups[] = {\n\t\"gpio7\",\n};\n\nstatic const char * const ephy2_led_groups[] = {\n\t\"gpio8\",\n};\n\nstatic const char * const ephy3_led_groups[] = {\n\t\"gpio9\",\n};\n\nstatic const char * const robosw_led_data_groups[] = {\n\t\"gpio10\",\n};\n\nstatic const char * const robosw_led_clk_groups[] = {\n\t\"gpio11\",\n};\n\nstatic const char * const robosw_led0_groups[] = {\n\t\"gpio12\",\n};\n\nstatic const char * const robosw_led1_groups[] = {\n\t\"gpio13\",\n};\n\nstatic const char * const usb_device_led_groups[] = {\n\t\"gpio14\",\n};\n\nstatic const char * const pci_req1_groups[] = {\n\t\"gpio16\",\n};\n\nstatic const char * const pci_gnt1_groups[] = {\n\t\"gpio17\",\n};\n\nstatic const char * const pci_intb_groups[] = {\n\t\"gpio18\",\n};\n\nstatic const char * const pci_req0_groups[] = {\n\t\"gpio19\",\n};\n\nstatic const char * const pci_gnt0_groups[] = {\n\t\"gpio20\",\n};\n\nstatic const char * const pcmcia_cd1_groups[] = {\n\t\"gpio22\",\n};\n\nstatic const char * const pcmcia_cd2_groups[] = {\n\t\"gpio23\",\n};\n\nstatic const char * const pcmcia_vs1_groups[] = {\n\t\"gpio24\",\n};\n\nstatic const char * const pcmcia_vs2_groups[] = {\n\t\"gpio25\",\n};\n\nstatic const char * const ebi_cs2_groups[] = {\n\t\"gpio26\",\n};\n\nstatic const char * const ebi_cs3_groups[] = {\n\t\"gpio27\",\n};\n\nstatic const char * const spi_cs2_groups[] = {\n\t\"gpio28\",\n};\n\nstatic const char * const spi_cs3_groups[] = {\n\t\"gpio29\",\n};\n\nstatic const char * const spi_cs4_groups[] = {\n\t\"gpio30\",\n};\n\nstatic const char * const spi_cs5_groups[] = {\n\t\"gpio31\",\n};\n\nstatic const char * const uart1_groups[] = {\n\t\"uart1_grp\",\n};\n\n#define BCM6368_FUN(n, out)\t\t\t\t\\\n\t{\t\t\t\t\t\t\\\n\t\t.name = #n,\t\t\t\t\\\n\t\t.groups = n##_groups,\t\t\t\\\n\t\t.num_groups = ARRAY_SIZE(n##_groups),\t\\\n\t\t.dir_out = out,\t\t\t\t\\\n\t}\n\n#define BCM6368_BASEMODE_FUN(n, val, out)\t\t\\\n\t{\t\t\t\t\t\t\\\n\t\t.name = #n,\t\t\t\t\\\n\t\t.groups = n##_groups,\t\t\t\\\n\t\t.num_groups = ARRAY_SIZE(n##_groups),\t\\\n\t\t.basemode = BCM6368_BASEMODE_##val,\t\\\n\t\t.dir_out = out,\t\t\t\t\\\n\t}\n\nstatic const struct bcm6368_function bcm6368_funcs[] = {\n\tBCM6368_FUN(analog_afe_0, 1),\n\tBCM6368_FUN(analog_afe_1, 1),\n\tBCM6368_FUN(sys_irq, 1),\n\tBCM6368_FUN(serial_led_data, 1),\n\tBCM6368_FUN(serial_led_clk, 1),\n\tBCM6368_FUN(inet_led, 1),\n\tBCM6368_FUN(ephy0_led, 1),\n\tBCM6368_FUN(ephy1_led, 1),\n\tBCM6368_FUN(ephy2_led, 1),\n\tBCM6368_FUN(ephy3_led, 1),\n\tBCM6368_FUN(robosw_led_data, 1),\n\tBCM6368_FUN(robosw_led_clk, 1),\n\tBCM6368_FUN(robosw_led0, 1),\n\tBCM6368_FUN(robosw_led1, 1),\n\tBCM6368_FUN(usb_device_led, 1),\n\tBCM6368_FUN(pci_req1, 0),\n\tBCM6368_FUN(pci_gnt1, 0),\n\tBCM6368_FUN(pci_intb, 0),\n\tBCM6368_FUN(pci_req0, 0),\n\tBCM6368_FUN(pci_gnt0, 0),\n\tBCM6368_FUN(pcmcia_cd1, 0),\n\tBCM6368_FUN(pcmcia_cd2, 0),\n\tBCM6368_FUN(pcmcia_vs1, 0),\n\tBCM6368_FUN(pcmcia_vs2, 0),\n\tBCM6368_FUN(ebi_cs2, 1),\n\tBCM6368_FUN(ebi_cs3, 1),\n\tBCM6368_FUN(spi_cs2, 1),\n\tBCM6368_FUN(spi_cs3, 1),\n\tBCM6368_FUN(spi_cs4, 1),\n\tBCM6368_FUN(spi_cs5, 1),\n\tBCM6368_BASEMODE_FUN(uart1, UART1, 0x6),\n};\n\nstatic int bcm6368_pinctrl_get_group_count(struct pinctrl_dev *pctldev)\n{\n\treturn ARRAY_SIZE(bcm6368_groups);\n}\n\nstatic const char *bcm6368_pinctrl_get_group_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t\t  unsigned group)\n{\n\treturn bcm6368_groups[group].name;\n}\n\nstatic int bcm6368_pinctrl_get_group_pins(struct pinctrl_dev *pctldev,\n\t\t\t\t\t  unsigned group, const unsigned **pins,\n\t\t\t\t\t  unsigned *npins)\n{\n\t*pins = bcm6368_groups[group].pins;\n\t*npins = bcm6368_groups[group].npins;\n\n\treturn 0;\n}\n\nstatic int bcm6368_pinctrl_get_func_count(struct pinctrl_dev *pctldev)\n{\n\treturn ARRAY_SIZE(bcm6368_funcs);\n}\n\nstatic const char *bcm6368_pinctrl_get_func_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t\t unsigned selector)\n{\n\treturn bcm6368_funcs[selector].name;\n}\n\nstatic int bcm6368_pinctrl_get_groups(struct pinctrl_dev *pctldev,\n\t\t\t\t      unsigned selector,\n\t\t\t\t      const char * const **groups,\n\t\t\t\t      unsigned * const num_groups)\n{\n\t*groups = bcm6368_funcs[selector].groups;\n\t*num_groups = bcm6368_funcs[selector].num_groups;\n\n\treturn 0;\n}\n\nstatic int bcm6368_pinctrl_set_mux(struct pinctrl_dev *pctldev,\n\t\t\t\t   unsigned selector, unsigned group)\n{\n\tstruct bcm63xx_pinctrl *pc = pinctrl_dev_get_drvdata(pctldev);\n\tstruct bcm6368_priv *priv = pc->driver_data;\n\tconst struct pingroup *pg = &bcm6368_groups[group];\n\tconst struct bcm6368_function *fun = &bcm6368_funcs[selector];\n\tint i, pin;\n\n\tif (fun->basemode) {\n\t\tunsigned int mask = 0;\n\n\t\tfor (i = 0; i < pg->npins; i++) {\n\t\t\tpin = pg->pins[i];\n\t\t\tif (pin < BCM63XX_BANK_GPIOS)\n\t\t\t\tmask |= BIT(pin);\n\t\t}\n\n\t\tregmap_update_bits(pc->regs, BCM6368_MODE_REG, mask, 0);\n\t\tregmap_field_write(priv->overlays, fun->basemode);\n\t} else {\n\t\tpin = pg->pins[0];\n\n\t\tif (bcm6368_pins[pin].drv_data)\n\t\t\tregmap_field_write(priv->overlays,\n\t\t\t\t\t   BCM6368_BASEMODE_GPIO);\n\n\t\tregmap_update_bits(pc->regs, BCM6368_MODE_REG, BIT(pin),\n\t\t\t\t   BIT(pin));\n\t}\n\n\tfor (pin = 0; pin < pg->npins; pin++) {\n\t\tstruct pinctrl_gpio_range *range;\n\t\tint hw_gpio = bcm6368_pins[pin].number;\n\n\t\trange = pinctrl_find_gpio_range_from_pin(pctldev, hw_gpio);\n\t\tif (range) {\n\t\t\tstruct gpio_chip *gc = range->gc;\n\n\t\t\tif (fun->dir_out & BIT(pin))\n\t\t\t\tgc->direction_output(gc, hw_gpio, 0);\n\t\t\telse\n\t\t\t\tgc->direction_input(gc, hw_gpio);\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int bcm6368_gpio_request_enable(struct pinctrl_dev *pctldev,\n\t\t\t\t       struct pinctrl_gpio_range *range,\n\t\t\t\t       unsigned offset)\n{\n\tstruct bcm63xx_pinctrl *pc = pinctrl_dev_get_drvdata(pctldev);\n\tstruct bcm6368_priv *priv = pc->driver_data;\n\n\tif (offset >= BCM63XX_BANK_GPIOS && !bcm6368_pins[offset].drv_data)\n\t\treturn 0;\n\n\t \n\tif (offset < BCM63XX_BANK_GPIOS)\n\t\tregmap_update_bits(pc->regs, BCM6368_MODE_REG, BIT(offset), 0);\n\n\tif (bcm6368_pins[offset].drv_data)\n\t\tregmap_field_write(priv->overlays, BCM6368_BASEMODE_GPIO);\n\n\treturn 0;\n}\n\nstatic const struct pinctrl_ops bcm6368_pctl_ops = {\n\t.dt_free_map = pinctrl_utils_free_map,\n\t.dt_node_to_map = pinconf_generic_dt_node_to_map_pin,\n\t.get_group_name = bcm6368_pinctrl_get_group_name,\n\t.get_group_pins = bcm6368_pinctrl_get_group_pins,\n\t.get_groups_count = bcm6368_pinctrl_get_group_count,\n};\n\nstatic const struct pinmux_ops bcm6368_pmx_ops = {\n\t.get_function_groups = bcm6368_pinctrl_get_groups,\n\t.get_function_name = bcm6368_pinctrl_get_func_name,\n\t.get_functions_count = bcm6368_pinctrl_get_func_count,\n\t.gpio_request_enable = bcm6368_gpio_request_enable,\n\t.set_mux = bcm6368_pinctrl_set_mux,\n\t.strict = true,\n};\n\nstatic const struct bcm63xx_pinctrl_soc bcm6368_soc = {\n\t.ngpios = BCM6368_NUM_GPIOS,\n\t.npins = ARRAY_SIZE(bcm6368_pins),\n\t.pctl_ops = &bcm6368_pctl_ops,\n\t.pins = bcm6368_pins,\n\t.pmx_ops = &bcm6368_pmx_ops,\n};\n\nstatic int bcm6368_pinctrl_probe(struct platform_device *pdev)\n{\n\tstruct reg_field overlays = REG_FIELD(BCM6368_BASEMODE_REG, 0, 15);\n\tstruct device *dev = &pdev->dev;\n\tstruct bcm63xx_pinctrl *pc;\n\tstruct bcm6368_priv *priv;\n\tint err;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\terr = bcm63xx_pinctrl_probe(pdev, &bcm6368_soc, (void *) priv);\n\tif (err)\n\t\treturn err;\n\n\tpc = platform_get_drvdata(pdev);\n\n\tpriv->overlays = devm_regmap_field_alloc(dev, pc->regs, overlays);\n\tif (IS_ERR(priv->overlays))\n\t\treturn PTR_ERR(priv->overlays);\n\n\treturn 0;\n}\n\nstatic const struct of_device_id bcm6368_pinctrl_match[] = {\n\t{ .compatible = \"brcm,bcm6368-pinctrl\", },\n\t{   }\n};\n\nstatic struct platform_driver bcm6368_pinctrl_driver = {\n\t.probe = bcm6368_pinctrl_probe,\n\t.driver = {\n\t\t.name = \"bcm6368-pinctrl\",\n\t\t.of_match_table = bcm6368_pinctrl_match,\n\t},\n};\n\nbuiltin_platform_driver(bcm6368_pinctrl_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}