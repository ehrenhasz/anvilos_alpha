{
  "module_name": "pinctrl-bcm6328.c",
  "hash_id": "ed50b204f673e39c8785f782fa633dd5a66c709a2af20712284df18755a21423",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pinctrl/bcm/pinctrl-bcm6328.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/gpio/driver.h>\n#include <linux/kernel.h>\n#include <linux/of.h>\n#include <linux/pinctrl/pinmux.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#include \"../pinctrl-utils.h\"\n\n#include \"pinctrl-bcm63xx.h\"\n\n#define BCM6328_NUM_GPIOS\t32\n\n#define BCM6328_MODE_REG\t0x18\n#define BCM6328_MUX_HI_REG\t0x1c\n#define BCM6328_MUX_LO_REG\t0x20\n#define BCM6328_MUX_OTHER_REG\t0x24\n#define  BCM6328_MUX_MASK\tGENMASK(1, 0)\n\nstruct bcm6328_function {\n\tconst char *name;\n\tconst char * const *groups;\n\tconst unsigned num_groups;\n\n\tunsigned mode_val:1;\n\tunsigned mux_val:2;\n};\n\nstatic const unsigned int bcm6328_mux[] = {\n\tBCM6328_MUX_LO_REG,\n\tBCM6328_MUX_HI_REG,\n\tBCM6328_MUX_OTHER_REG\n};\n\nstatic const struct pinctrl_pin_desc bcm6328_pins[] = {\n\tPINCTRL_PIN(0, \"gpio0\"),\n\tPINCTRL_PIN(1, \"gpio1\"),\n\tPINCTRL_PIN(2, \"gpio2\"),\n\tPINCTRL_PIN(3, \"gpio3\"),\n\tPINCTRL_PIN(4, \"gpio4\"),\n\tPINCTRL_PIN(5, \"gpio5\"),\n\tPINCTRL_PIN(6, \"gpio6\"),\n\tPINCTRL_PIN(7, \"gpio7\"),\n\tPINCTRL_PIN(8, \"gpio8\"),\n\tPINCTRL_PIN(9, \"gpio9\"),\n\tPINCTRL_PIN(10, \"gpio10\"),\n\tPINCTRL_PIN(11, \"gpio11\"),\n\tPINCTRL_PIN(12, \"gpio12\"),\n\tPINCTRL_PIN(13, \"gpio13\"),\n\tPINCTRL_PIN(14, \"gpio14\"),\n\tPINCTRL_PIN(15, \"gpio15\"),\n\tPINCTRL_PIN(16, \"gpio16\"),\n\tPINCTRL_PIN(17, \"gpio17\"),\n\tPINCTRL_PIN(18, \"gpio18\"),\n\tPINCTRL_PIN(19, \"gpio19\"),\n\tPINCTRL_PIN(20, \"gpio20\"),\n\tPINCTRL_PIN(21, \"gpio21\"),\n\tPINCTRL_PIN(22, \"gpio22\"),\n\tPINCTRL_PIN(23, \"gpio23\"),\n\tPINCTRL_PIN(24, \"gpio24\"),\n\tPINCTRL_PIN(25, \"gpio25\"),\n\tPINCTRL_PIN(26, \"gpio26\"),\n\tPINCTRL_PIN(27, \"gpio27\"),\n\tPINCTRL_PIN(28, \"gpio28\"),\n\tPINCTRL_PIN(29, \"gpio29\"),\n\tPINCTRL_PIN(30, \"gpio30\"),\n\tPINCTRL_PIN(31, \"gpio31\"),\n\n\t \n\tPINCTRL_PIN(36, \"hsspi_cs1\"),\n\tPINCTRL_PIN(38, \"usb_p2\"),\n};\n\nstatic unsigned gpio0_pins[] = { 0 };\nstatic unsigned gpio1_pins[] = { 1 };\nstatic unsigned gpio2_pins[] = { 2 };\nstatic unsigned gpio3_pins[] = { 3 };\nstatic unsigned gpio4_pins[] = { 4 };\nstatic unsigned gpio5_pins[] = { 5 };\nstatic unsigned gpio6_pins[] = { 6 };\nstatic unsigned gpio7_pins[] = { 7 };\nstatic unsigned gpio8_pins[] = { 8 };\nstatic unsigned gpio9_pins[] = { 9 };\nstatic unsigned gpio10_pins[] = { 10 };\nstatic unsigned gpio11_pins[] = { 11 };\nstatic unsigned gpio12_pins[] = { 12 };\nstatic unsigned gpio13_pins[] = { 13 };\nstatic unsigned gpio14_pins[] = { 14 };\nstatic unsigned gpio15_pins[] = { 15 };\nstatic unsigned gpio16_pins[] = { 16 };\nstatic unsigned gpio17_pins[] = { 17 };\nstatic unsigned gpio18_pins[] = { 18 };\nstatic unsigned gpio19_pins[] = { 19 };\nstatic unsigned gpio20_pins[] = { 20 };\nstatic unsigned gpio21_pins[] = { 21 };\nstatic unsigned gpio22_pins[] = { 22 };\nstatic unsigned gpio23_pins[] = { 23 };\nstatic unsigned gpio24_pins[] = { 24 };\nstatic unsigned gpio25_pins[] = { 25 };\nstatic unsigned gpio26_pins[] = { 26 };\nstatic unsigned gpio27_pins[] = { 27 };\nstatic unsigned gpio28_pins[] = { 28 };\nstatic unsigned gpio29_pins[] = { 29 };\nstatic unsigned gpio30_pins[] = { 30 };\nstatic unsigned gpio31_pins[] = { 31 };\n\nstatic unsigned hsspi_cs1_pins[] = { 36 };\nstatic unsigned usb_port1_pins[] = { 38 };\n\nstatic struct pingroup bcm6328_groups[] = {\n\tBCM_PIN_GROUP(gpio0),\n\tBCM_PIN_GROUP(gpio1),\n\tBCM_PIN_GROUP(gpio2),\n\tBCM_PIN_GROUP(gpio3),\n\tBCM_PIN_GROUP(gpio4),\n\tBCM_PIN_GROUP(gpio5),\n\tBCM_PIN_GROUP(gpio6),\n\tBCM_PIN_GROUP(gpio7),\n\tBCM_PIN_GROUP(gpio8),\n\tBCM_PIN_GROUP(gpio9),\n\tBCM_PIN_GROUP(gpio10),\n\tBCM_PIN_GROUP(gpio11),\n\tBCM_PIN_GROUP(gpio12),\n\tBCM_PIN_GROUP(gpio13),\n\tBCM_PIN_GROUP(gpio14),\n\tBCM_PIN_GROUP(gpio15),\n\tBCM_PIN_GROUP(gpio16),\n\tBCM_PIN_GROUP(gpio17),\n\tBCM_PIN_GROUP(gpio18),\n\tBCM_PIN_GROUP(gpio19),\n\tBCM_PIN_GROUP(gpio20),\n\tBCM_PIN_GROUP(gpio21),\n\tBCM_PIN_GROUP(gpio22),\n\tBCM_PIN_GROUP(gpio23),\n\tBCM_PIN_GROUP(gpio24),\n\tBCM_PIN_GROUP(gpio25),\n\tBCM_PIN_GROUP(gpio26),\n\tBCM_PIN_GROUP(gpio27),\n\tBCM_PIN_GROUP(gpio28),\n\tBCM_PIN_GROUP(gpio29),\n\tBCM_PIN_GROUP(gpio30),\n\tBCM_PIN_GROUP(gpio31),\n\n\tBCM_PIN_GROUP(hsspi_cs1),\n\tBCM_PIN_GROUP(usb_port1),\n};\n\n \nstatic const char * const led_groups[] = {\n\t\"gpio0\",\n\t\"gpio1\",\n\t\"gpio2\",\n\t\"gpio3\",\n\t\"gpio4\",\n\t\"gpio5\",\n\t\"gpio6\",\n\t\"gpio7\",\n\t\"gpio8\",\n\t\"gpio9\",\n\t\"gpio10\",\n\t\"gpio11\",\n\t\"gpio12\",\n\t\"gpio13\",\n\t\"gpio14\",\n\t\"gpio15\",\n\t\"gpio16\",\n\t\"gpio17\",\n\t\"gpio18\",\n\t\"gpio19\",\n\t\"gpio20\",\n\t\"gpio21\",\n\t\"gpio22\",\n\t\"gpio23\",\n};\n\n \nstatic const char * const serial_led_data_groups[] = {\n\t\"gpio6\",\n};\n\nstatic const char * const serial_led_clk_groups[] = {\n\t\"gpio7\",\n};\n\nstatic const char * const inet_act_led_groups[] = {\n\t\"gpio11\",\n};\n\nstatic const char * const pcie_clkreq_groups[] = {\n\t\"gpio16\",\n};\n\nstatic const char * const ephy0_act_led_groups[] = {\n\t\"gpio25\",\n};\n\nstatic const char * const ephy1_act_led_groups[] = {\n\t\"gpio26\",\n};\n\nstatic const char * const ephy2_act_led_groups[] = {\n\t\"gpio27\",\n};\n\nstatic const char * const ephy3_act_led_groups[] = {\n\t\"gpio28\",\n};\n\nstatic const char * const hsspi_cs1_groups[] = {\n\t\"hsspi_cs1\"\n};\n\nstatic const char * const usb_host_port_groups[] = {\n\t\"usb_port1\",\n};\n\nstatic const char * const usb_device_port_groups[] = {\n\t\"usb_port1\",\n};\n\n#define BCM6328_MODE_FUN(n)\t\t\t\t\\\n\t{\t\t\t\t\t\t\\\n\t\t.name = #n,\t\t\t\t\\\n\t\t.groups = n##_groups,\t\t\t\\\n\t\t.num_groups = ARRAY_SIZE(n##_groups),\t\\\n\t\t.mode_val = 1,\t\t\t\t\\\n\t}\n\n#define BCM6328_MUX_FUN(n, mux)\t\t\t\t\\\n\t{\t\t\t\t\t\t\\\n\t\t.name = #n,\t\t\t\t\\\n\t\t.groups = n##_groups,\t\t\t\\\n\t\t.num_groups = ARRAY_SIZE(n##_groups),\t\\\n\t\t.mux_val = mux,\t\t\t\t\\\n\t}\n\nstatic const struct bcm6328_function bcm6328_funcs[] = {\n\tBCM6328_MODE_FUN(led),\n\tBCM6328_MUX_FUN(serial_led_data, 2),\n\tBCM6328_MUX_FUN(serial_led_clk, 2),\n\tBCM6328_MUX_FUN(inet_act_led, 1),\n\tBCM6328_MUX_FUN(pcie_clkreq, 2),\n\tBCM6328_MUX_FUN(ephy0_act_led, 1),\n\tBCM6328_MUX_FUN(ephy1_act_led, 1),\n\tBCM6328_MUX_FUN(ephy2_act_led, 1),\n\tBCM6328_MUX_FUN(ephy3_act_led, 1),\n\tBCM6328_MUX_FUN(hsspi_cs1, 2),\n\tBCM6328_MUX_FUN(usb_host_port, 1),\n\tBCM6328_MUX_FUN(usb_device_port, 2),\n};\n\nstatic inline unsigned int bcm6328_mux_off(unsigned int pin)\n{\n\treturn bcm6328_mux[pin / 16];\n}\n\nstatic int bcm6328_pinctrl_get_group_count(struct pinctrl_dev *pctldev)\n{\n\treturn ARRAY_SIZE(bcm6328_groups);\n}\n\nstatic const char *bcm6328_pinctrl_get_group_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t\t  unsigned group)\n{\n\treturn bcm6328_groups[group].name;\n}\n\nstatic int bcm6328_pinctrl_get_group_pins(struct pinctrl_dev *pctldev,\n\t\t\t\t\t  unsigned group, const unsigned **pins,\n\t\t\t\t\t  unsigned *npins)\n{\n\t*pins = bcm6328_groups[group].pins;\n\t*npins = bcm6328_groups[group].npins;\n\n\treturn 0;\n}\n\nstatic int bcm6328_pinctrl_get_func_count(struct pinctrl_dev *pctldev)\n{\n\treturn ARRAY_SIZE(bcm6328_funcs);\n}\n\nstatic const char *bcm6328_pinctrl_get_func_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t\t unsigned selector)\n{\n\treturn bcm6328_funcs[selector].name;\n}\n\nstatic int bcm6328_pinctrl_get_groups(struct pinctrl_dev *pctldev,\n\t\t\t\t      unsigned selector,\n\t\t\t\t      const char * const **groups,\n\t\t\t\t      unsigned * const num_groups)\n{\n\t*groups = bcm6328_funcs[selector].groups;\n\t*num_groups = bcm6328_funcs[selector].num_groups;\n\n\treturn 0;\n}\n\nstatic void bcm6328_rmw_mux(struct bcm63xx_pinctrl *pc, unsigned pin,\n\t\t\t    unsigned int mode, unsigned int mux)\n{\n\tif (pin < BCM6328_NUM_GPIOS)\n\t\tregmap_update_bits(pc->regs, BCM6328_MODE_REG, BIT(pin),\n\t\t\t\t   mode ? BIT(pin) : 0);\n\n\tregmap_update_bits(pc->regs, bcm6328_mux_off(pin),\n\t\t\t   BCM6328_MUX_MASK << ((pin % 16) * 2),\n\t\t\t   mux << ((pin % 16) * 2));\n}\n\nstatic int bcm6328_pinctrl_set_mux(struct pinctrl_dev *pctldev,\n\t\t\t\t   unsigned selector, unsigned group)\n{\n\tstruct bcm63xx_pinctrl *pc = pinctrl_dev_get_drvdata(pctldev);\n\tconst struct pingroup *pg = &bcm6328_groups[group];\n\tconst struct bcm6328_function *f = &bcm6328_funcs[selector];\n\n\tbcm6328_rmw_mux(pc, pg->pins[0], f->mode_val, f->mux_val);\n\n\treturn 0;\n}\n\nstatic int bcm6328_gpio_request_enable(struct pinctrl_dev *pctldev,\n\t\t\t\t       struct pinctrl_gpio_range *range,\n\t\t\t\t       unsigned offset)\n{\n\tstruct bcm63xx_pinctrl *pc = pinctrl_dev_get_drvdata(pctldev);\n\n\t \n\tbcm6328_rmw_mux(pc, offset, 0, 0);\n\n\treturn 0;\n}\n\nstatic const struct pinctrl_ops bcm6328_pctl_ops = {\n\t.dt_free_map = pinctrl_utils_free_map,\n\t.dt_node_to_map = pinconf_generic_dt_node_to_map_pin,\n\t.get_group_name = bcm6328_pinctrl_get_group_name,\n\t.get_group_pins = bcm6328_pinctrl_get_group_pins,\n\t.get_groups_count = bcm6328_pinctrl_get_group_count,\n};\n\nstatic const struct pinmux_ops bcm6328_pmx_ops = {\n\t.get_function_groups = bcm6328_pinctrl_get_groups,\n\t.get_function_name = bcm6328_pinctrl_get_func_name,\n\t.get_functions_count = bcm6328_pinctrl_get_func_count,\n\t.gpio_request_enable = bcm6328_gpio_request_enable,\n\t.set_mux = bcm6328_pinctrl_set_mux,\n\t.strict = true,\n};\n\nstatic const struct bcm63xx_pinctrl_soc bcm6328_soc = {\n\t.ngpios = BCM6328_NUM_GPIOS,\n\t.npins = ARRAY_SIZE(bcm6328_pins),\n\t.pctl_ops = &bcm6328_pctl_ops,\n\t.pins = bcm6328_pins,\n\t.pmx_ops = &bcm6328_pmx_ops,\n};\n\nstatic int bcm6328_pinctrl_probe(struct platform_device *pdev)\n{\n\treturn bcm63xx_pinctrl_probe(pdev, &bcm6328_soc, NULL);\n}\n\nstatic const struct of_device_id bcm6328_pinctrl_match[] = {\n\t{ .compatible = \"brcm,bcm6328-pinctrl\", },\n\t{   }\n};\n\nstatic struct platform_driver bcm6328_pinctrl_driver = {\n\t.probe = bcm6328_pinctrl_probe,\n\t.driver = {\n\t\t.name = \"bcm6328-pinctrl\",\n\t\t.of_match_table = bcm6328_pinctrl_match,\n\t},\n};\n\nbuiltin_platform_driver(bcm6328_pinctrl_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}