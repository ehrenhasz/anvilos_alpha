{
  "module_name": "pinctrl-wpcm450.c",
  "hash_id": "e9e193b24b494e4e9840be6e0cf95211b298d0ccfbc7486af06bc0b1013bd1d7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pinctrl/nuvoton/pinctrl-wpcm450.c",
  "human_readable_source": "\n\n\n\n\n\n\n\n\n\n\n#include <linux/device.h>\n#include <linux/fwnode.h>\n#include <linux/gpio/driver.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/mfd/syscon.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#include <linux/pinctrl/pinconf.h>\n#include <linux/pinctrl/pinconf-generic.h>\n#include <linux/pinctrl/pinctrl.h>\n#include <linux/pinctrl/pinmux.h>\n\n#include \"../core.h\"\n\n \n#define WPCM450_GCR_MFSEL1\t0x0c\n#define WPCM450_GCR_MFSEL2\t0x10\n#define WPCM450_GCR_NONE\t0\n\n \n#define WPCM450_GPEVTYPE\t0x00\n#define WPCM450_GPEVPOL\t\t0x04\n#define WPCM450_GPEVDBNC\t0x08\n#define WPCM450_GPEVEN\t\t0x0c\n#define WPCM450_GPEVST\t\t0x10\n\n#define WPCM450_NUM_BANKS\t8\n#define WPCM450_NUM_GPIOS\t128\n#define WPCM450_NUM_GPIO_IRQS\t4\n\nstruct wpcm450_pinctrl;\nstruct wpcm450_bank;\n\nstruct wpcm450_gpio {\n\tstruct gpio_chip\tgc;\n\tstruct wpcm450_pinctrl\t*pctrl;\n\tconst struct wpcm450_bank *bank;\n};\n\nstruct wpcm450_pinctrl {\n\tstruct pinctrl_dev\t*pctldev;\n\tstruct device\t\t*dev;\n\tstruct irq_domain\t*domain;\n\tstruct regmap\t\t*gcr_regmap;\n\tvoid __iomem\t\t*gpio_base;\n\tstruct wpcm450_gpio\tgpio_bank[WPCM450_NUM_BANKS];\n\tunsigned long\t\tboth_edges;\n\n\t \n\traw_spinlock_t\t\tlock;\n};\n\nstruct wpcm450_bank {\n\t \n\tu8 base;\n\tu8 length;\n\n\t \n\tu8 cfg0, cfg1, cfg2;\n\tu8 blink;\n\tu8 dataout, datain;\n\n\t \n\tu8 first_irq_bit;    \n\tu8 num_irqs;         \n\tu8 first_irq_gpio;   \n};\n\nstatic const struct wpcm450_bank wpcm450_banks[WPCM450_NUM_BANKS] = {\n\t \n\t{   0, 16,  0x14, 0x18,    0,    0, 0x1c, 0x20,  0, 16, 0 },\n\t{  16, 16,  0x24, 0x28, 0x2c, 0x30, 0x34, 0x38, 16,  2, 8 },\n\t{  32, 16,  0x3c, 0x40, 0x44,    0, 0x48, 0x4c,  0,  0, 0 },\n\t{  48, 16,  0x50, 0x54, 0x58,    0, 0x5c, 0x60,  0,  0, 0 },\n\t{  64, 16,  0x64, 0x68, 0x6c,    0, 0x70, 0x74,  0,  0, 0 },\n\t{  80, 16,  0x78, 0x7c, 0x80,    0, 0x84, 0x88,  0,  0, 0 },\n\t{  96, 18,     0,    0,    0,    0,    0, 0x8c,  0,  0, 0 },\n\t{ 114, 14,  0x90, 0x94, 0x98,    0, 0x9c, 0xa0,  0,  0, 0 },\n};\n\nstatic int wpcm450_gpio_irq_bitnum(struct wpcm450_gpio *gpio, struct irq_data *d)\n{\n\tconst struct wpcm450_bank *bank = gpio->bank;\n\tint hwirq = irqd_to_hwirq(d);\n\n\tif (hwirq < bank->first_irq_gpio)\n\t\treturn -EINVAL;\n\n\tif (hwirq - bank->first_irq_gpio >= bank->num_irqs)\n\t\treturn -EINVAL;\n\n\treturn hwirq - bank->first_irq_gpio + bank->first_irq_bit;\n}\n\nstatic int wpcm450_irq_bitnum_to_gpio(struct wpcm450_gpio *gpio, int bitnum)\n{\n\tconst struct wpcm450_bank *bank = gpio->bank;\n\n\tif (bitnum < bank->first_irq_bit)\n\t\treturn -EINVAL;\n\n\tif (bitnum - bank->first_irq_bit > bank->num_irqs)\n\t\treturn -EINVAL;\n\n\treturn bitnum - bank->first_irq_bit + bank->first_irq_gpio;\n}\n\nstatic void wpcm450_gpio_irq_ack(struct irq_data *d)\n{\n\tstruct wpcm450_gpio *gpio = gpiochip_get_data(irq_data_get_irq_chip_data(d));\n\tstruct wpcm450_pinctrl *pctrl = gpio->pctrl;\n\tunsigned long flags;\n\tint bit;\n\n\tbit = wpcm450_gpio_irq_bitnum(gpio, d);\n\tif (bit < 0)\n\t\treturn;\n\n\traw_spin_lock_irqsave(&pctrl->lock, flags);\n\tiowrite32(BIT(bit), pctrl->gpio_base + WPCM450_GPEVST);\n\traw_spin_unlock_irqrestore(&pctrl->lock, flags);\n}\n\nstatic void wpcm450_gpio_irq_mask(struct irq_data *d)\n{\n\tstruct gpio_chip *gc = irq_data_get_irq_chip_data(d);\n\tstruct wpcm450_gpio *gpio = gpiochip_get_data(gc);\n\tstruct wpcm450_pinctrl *pctrl = gpio->pctrl;\n\tunsigned long flags;\n\tunsigned long even;\n\tint bit;\n\n\tbit = wpcm450_gpio_irq_bitnum(gpio, d);\n\tif (bit < 0)\n\t\treturn;\n\n\traw_spin_lock_irqsave(&pctrl->lock, flags);\n\teven = ioread32(pctrl->gpio_base + WPCM450_GPEVEN);\n\t__assign_bit(bit, &even, 0);\n\tiowrite32(even, pctrl->gpio_base + WPCM450_GPEVEN);\n\traw_spin_unlock_irqrestore(&pctrl->lock, flags);\n\n\tgpiochip_disable_irq(gc, irqd_to_hwirq(d));\n}\n\nstatic void wpcm450_gpio_irq_unmask(struct irq_data *d)\n{\n\tstruct gpio_chip *gc = irq_data_get_irq_chip_data(d);\n\tstruct wpcm450_gpio *gpio = gpiochip_get_data(gc);\n\tstruct wpcm450_pinctrl *pctrl = gpio->pctrl;\n\tunsigned long flags;\n\tunsigned long even;\n\tint bit;\n\n\tbit = wpcm450_gpio_irq_bitnum(gpio, d);\n\tif (bit < 0)\n\t\treturn;\n\n\tgpiochip_enable_irq(gc, irqd_to_hwirq(d));\n\n\traw_spin_lock_irqsave(&pctrl->lock, flags);\n\teven = ioread32(pctrl->gpio_base + WPCM450_GPEVEN);\n\t__assign_bit(bit, &even, 1);\n\tiowrite32(even, pctrl->gpio_base + WPCM450_GPEVEN);\n\traw_spin_unlock_irqrestore(&pctrl->lock, flags);\n}\n\n \nstatic int wpcm450_gpio_get(struct wpcm450_gpio *gpio, int offset)\n{\n\tvoid __iomem *reg = gpio->pctrl->gpio_base + gpio->bank->datain;\n\tunsigned long flags;\n\tu32 level;\n\n\traw_spin_lock_irqsave(&gpio->pctrl->lock, flags);\n\tlevel = !!(ioread32(reg) & BIT(offset));\n\traw_spin_unlock_irqrestore(&gpio->pctrl->lock, flags);\n\n\treturn level;\n}\n\n \nstatic void wpcm450_gpio_fix_evpol(struct wpcm450_gpio *gpio, unsigned long all)\n{\n\tstruct wpcm450_pinctrl *pctrl = gpio->pctrl;\n\tunsigned int bit;\n\n\tfor_each_set_bit(bit, &all, 32) {\n\t\tint offset = wpcm450_irq_bitnum_to_gpio(gpio, bit);\n\t\tunsigned long evpol;\n\t\tunsigned long flags;\n\t\tint level;\n\n\t\tdo {\n\t\t\tlevel = wpcm450_gpio_get(gpio, offset);\n\n\t\t\t \n\t\t\traw_spin_lock_irqsave(&pctrl->lock, flags);\n\t\t\tevpol = ioread32(pctrl->gpio_base + WPCM450_GPEVPOL);\n\t\t\t__assign_bit(bit, &evpol, !level);\n\t\t\tiowrite32(evpol, pctrl->gpio_base + WPCM450_GPEVPOL);\n\t\t\traw_spin_unlock_irqrestore(&pctrl->lock, flags);\n\n\t\t} while (wpcm450_gpio_get(gpio, offset) != level);\n\t}\n}\n\nstatic int wpcm450_gpio_set_irq_type(struct irq_data *d, unsigned int flow_type)\n{\n\tstruct wpcm450_gpio *gpio = gpiochip_get_data(irq_data_get_irq_chip_data(d));\n\tstruct wpcm450_pinctrl *pctrl = gpio->pctrl;\n\tunsigned long evtype, evpol;\n\tunsigned long flags;\n\tint ret = 0;\n\tint bit;\n\n\tbit = wpcm450_gpio_irq_bitnum(gpio, d);\n\tif (bit < 0)\n\t\treturn bit;\n\n\tirq_set_handler_locked(d, handle_level_irq);\n\n\traw_spin_lock_irqsave(&pctrl->lock, flags);\n\tevtype = ioread32(pctrl->gpio_base + WPCM450_GPEVTYPE);\n\tevpol = ioread32(pctrl->gpio_base + WPCM450_GPEVPOL);\n\t__assign_bit(bit, &pctrl->both_edges, 0);\n\tswitch (flow_type) {\n\tcase IRQ_TYPE_LEVEL_LOW:\n\t\t__assign_bit(bit, &evtype, 1);\n\t\t__assign_bit(bit, &evpol, 0);\n\t\tbreak;\n\tcase IRQ_TYPE_LEVEL_HIGH:\n\t\t__assign_bit(bit, &evtype, 1);\n\t\t__assign_bit(bit, &evpol, 1);\n\t\tbreak;\n\tcase IRQ_TYPE_EDGE_FALLING:\n\t\t__assign_bit(bit, &evtype, 0);\n\t\t__assign_bit(bit, &evpol, 0);\n\t\tbreak;\n\tcase IRQ_TYPE_EDGE_RISING:\n\t\t__assign_bit(bit, &evtype, 0);\n\t\t__assign_bit(bit, &evpol, 1);\n\t\tbreak;\n\tcase IRQ_TYPE_EDGE_BOTH:\n\t\t__assign_bit(bit, &evtype, 0);\n\t\t__assign_bit(bit, &pctrl->both_edges, 1);\n\t\tbreak;\n\tdefault:\n\t\tret = -EINVAL;\n\t}\n\tiowrite32(evtype, pctrl->gpio_base + WPCM450_GPEVTYPE);\n\tiowrite32(evpol, pctrl->gpio_base + WPCM450_GPEVPOL);\n\n\t \n\tiowrite32(BIT(bit), pctrl->gpio_base + WPCM450_GPEVST);\n\n\traw_spin_unlock_irqrestore(&pctrl->lock, flags);\n\n\t \n\twpcm450_gpio_fix_evpol(gpio, BIT(bit));\n\n\treturn ret;\n}\n\nstatic const struct irq_chip wpcm450_gpio_irqchip = {\n\t.name = \"WPCM450-GPIO-IRQ\",\n\t.irq_ack = wpcm450_gpio_irq_ack,\n\t.irq_unmask = wpcm450_gpio_irq_unmask,\n\t.irq_mask = wpcm450_gpio_irq_mask,\n\t.irq_set_type = wpcm450_gpio_set_irq_type,\n\t.flags = IRQCHIP_IMMUTABLE,\n\tGPIOCHIP_IRQ_RESOURCE_HELPERS,\n};\n\nstatic void wpcm450_gpio_irqhandler(struct irq_desc *desc)\n{\n\tstruct wpcm450_gpio *gpio = gpiochip_get_data(irq_desc_get_handler_data(desc));\n\tstruct wpcm450_pinctrl *pctrl = gpio->pctrl;\n\tstruct irq_chip *chip = irq_desc_get_chip(desc);\n\tunsigned long pending;\n\tunsigned long flags;\n\tunsigned long ours;\n\tunsigned int bit;\n\n\tours = GENMASK(gpio->bank->num_irqs - 1, 0) << gpio->bank->first_irq_bit;\n\n\traw_spin_lock_irqsave(&pctrl->lock, flags);\n\n\tpending = ioread32(pctrl->gpio_base + WPCM450_GPEVST);\n\tpending &= ioread32(pctrl->gpio_base + WPCM450_GPEVEN);\n\tpending &= ours;\n\n\traw_spin_unlock_irqrestore(&pctrl->lock, flags);\n\n\tif (pending & pctrl->both_edges)\n\t\twpcm450_gpio_fix_evpol(gpio, pending & pctrl->both_edges);\n\n\tchained_irq_enter(chip, desc);\n\tfor_each_set_bit(bit, &pending, 32) {\n\t\tint offset = wpcm450_irq_bitnum_to_gpio(gpio, bit);\n\n\t\tgeneric_handle_domain_irq(gpio->gc.irq.domain, offset);\n\t}\n\tchained_irq_exit(chip, desc);\n}\n\nstatic int smb0_pins[]  = { 115, 114 };\nstatic int smb1_pins[]  = { 117, 116 };\nstatic int smb2_pins[]  = { 119, 118 };\nstatic int smb3_pins[]  = { 30, 31 };\nstatic int smb4_pins[]  = { 28, 29 };\nstatic int smb5_pins[]  = { 26, 27 };\n\nstatic int scs1_pins[] = { 32 };\nstatic int scs2_pins[] = { 33 };\nstatic int scs3_pins[] = { 34 };\n\nstatic int bsp_pins[] = { 41, 42 };\nstatic int hsp1_pins[] = { 43, 44, 45, 46, 47, 61, 62, 63 };\nstatic int hsp2_pins[] = { 48, 49, 50, 51, 52, 53, 54, 55 };\n\nstatic int r1err_pins[] = { 56 };\nstatic int r1md_pins[] = { 57, 58 };\nstatic int rmii2_pins[] = { 84, 85, 86, 87, 88, 89 };\nstatic int r2err_pins[] = { 90 };\nstatic int r2md_pins[] = { 91, 92 };\n\nstatic int kbcc_pins[] = { 94, 93 };\nstatic int clko_pins[] = { 96 };\nstatic int smi_pins[] = { 97 };\nstatic int uinc_pins[] = { 19 };\nstatic int mben_pins[] = {};\n\nstatic int gspi_pins[] = { 12, 13, 14, 15 };\nstatic int sspi_pins[] = { 12, 13, 14, 15 };\n\nstatic int xcs1_pins[] = { 35 };\nstatic int xcs2_pins[] = { 36 };\n\nstatic int sdio_pins[] = { 7, 22, 43, 44, 45, 46, 47, 60 };\n\nstatic int fi0_pins[] = { 64 };\nstatic int fi1_pins[] = { 65 };\nstatic int fi2_pins[] = { 66 };\nstatic int fi3_pins[] = { 67 };\nstatic int fi4_pins[] = { 68 };\nstatic int fi5_pins[] = { 69 };\nstatic int fi6_pins[] = { 70 };\nstatic int fi7_pins[] = { 71 };\nstatic int fi8_pins[] = { 72 };\nstatic int fi9_pins[] = { 73 };\nstatic int fi10_pins[] = { 74 };\nstatic int fi11_pins[] = { 75 };\nstatic int fi12_pins[] = { 76 };\nstatic int fi13_pins[] = { 77 };\nstatic int fi14_pins[] = { 78 };\nstatic int fi15_pins[] = { 79 };\n\nstatic int pwm0_pins[] = { 80 };\nstatic int pwm1_pins[] = { 81 };\nstatic int pwm2_pins[] = { 82 };\nstatic int pwm3_pins[] = { 83 };\nstatic int pwm4_pins[] = { 20 };\nstatic int pwm5_pins[] = { 21 };\nstatic int pwm6_pins[] = { 16 };\nstatic int pwm7_pins[] = { 17 };\n\nstatic int hg0_pins[] = { 20 };\nstatic int hg1_pins[] = { 21 };\nstatic int hg2_pins[] = { 22 };\nstatic int hg3_pins[] = { 23 };\nstatic int hg4_pins[] = { 24 };\nstatic int hg5_pins[] = { 25 };\nstatic int hg6_pins[] = { 59 };\nstatic int hg7_pins[] = { 60 };\n\n#define WPCM450_GRPS \\\n\tWPCM450_GRP(smb3), \\\n\tWPCM450_GRP(smb4), \\\n\tWPCM450_GRP(smb5), \\\n\tWPCM450_GRP(scs1), \\\n\tWPCM450_GRP(scs2), \\\n\tWPCM450_GRP(scs3), \\\n\tWPCM450_GRP(smb0), \\\n\tWPCM450_GRP(smb1), \\\n\tWPCM450_GRP(smb2), \\\n\tWPCM450_GRP(bsp), \\\n\tWPCM450_GRP(hsp1), \\\n\tWPCM450_GRP(hsp2), \\\n\tWPCM450_GRP(r1err), \\\n\tWPCM450_GRP(r1md), \\\n\tWPCM450_GRP(rmii2), \\\n\tWPCM450_GRP(r2err), \\\n\tWPCM450_GRP(r2md), \\\n\tWPCM450_GRP(kbcc), \\\n\tWPCM450_GRP(clko), \\\n\tWPCM450_GRP(smi), \\\n\tWPCM450_GRP(uinc), \\\n\tWPCM450_GRP(gspi), \\\n\tWPCM450_GRP(mben), \\\n\tWPCM450_GRP(xcs2), \\\n\tWPCM450_GRP(xcs1), \\\n\tWPCM450_GRP(sdio), \\\n\tWPCM450_GRP(sspi), \\\n\tWPCM450_GRP(fi0), \\\n\tWPCM450_GRP(fi1), \\\n\tWPCM450_GRP(fi2), \\\n\tWPCM450_GRP(fi3), \\\n\tWPCM450_GRP(fi4), \\\n\tWPCM450_GRP(fi5), \\\n\tWPCM450_GRP(fi6), \\\n\tWPCM450_GRP(fi7), \\\n\tWPCM450_GRP(fi8), \\\n\tWPCM450_GRP(fi9), \\\n\tWPCM450_GRP(fi10), \\\n\tWPCM450_GRP(fi11), \\\n\tWPCM450_GRP(fi12), \\\n\tWPCM450_GRP(fi13), \\\n\tWPCM450_GRP(fi14), \\\n\tWPCM450_GRP(fi15), \\\n\tWPCM450_GRP(pwm0), \\\n\tWPCM450_GRP(pwm1), \\\n\tWPCM450_GRP(pwm2), \\\n\tWPCM450_GRP(pwm3), \\\n\tWPCM450_GRP(pwm4), \\\n\tWPCM450_GRP(pwm5), \\\n\tWPCM450_GRP(pwm6), \\\n\tWPCM450_GRP(pwm7), \\\n\tWPCM450_GRP(hg0), \\\n\tWPCM450_GRP(hg1), \\\n\tWPCM450_GRP(hg2), \\\n\tWPCM450_GRP(hg3), \\\n\tWPCM450_GRP(hg4), \\\n\tWPCM450_GRP(hg5), \\\n\tWPCM450_GRP(hg6), \\\n\tWPCM450_GRP(hg7), \\\n\nenum {\n#define WPCM450_GRP(x) fn_ ## x\n\tWPCM450_GRPS\n\t \n\tWPCM450_GRP(gpio),\n\tWPCM450_GRP(none),\n#undef WPCM450_GRP\n};\n\nstatic struct group_desc wpcm450_groups[] = {\n#define WPCM450_GRP(x) { .name = #x, .pins = x ## _pins, \\\n\t\t\t.num_pins = ARRAY_SIZE(x ## _pins) }\n\tWPCM450_GRPS\n#undef WPCM450_GRP\n};\n\n#define WPCM450_SFUNC(a) WPCM450_FUNC(a, #a)\n#define WPCM450_FUNC(a, b...) static const char *a ## _grp[] = { b }\n#define WPCM450_MKFUNC(nm) { .name = #nm, .ngroups = ARRAY_SIZE(nm ## _grp), \\\n\t\t\t.groups = nm ## _grp }\nstruct wpcm450_func {\n\tconst char *name;\n\tconst unsigned int ngroups;\n\tconst char *const *groups;\n};\n\nWPCM450_SFUNC(smb3);\nWPCM450_SFUNC(smb4);\nWPCM450_SFUNC(smb5);\nWPCM450_SFUNC(scs1);\nWPCM450_SFUNC(scs2);\nWPCM450_SFUNC(scs3);\nWPCM450_SFUNC(smb0);\nWPCM450_SFUNC(smb1);\nWPCM450_SFUNC(smb2);\nWPCM450_SFUNC(bsp);\nWPCM450_SFUNC(hsp1);\nWPCM450_SFUNC(hsp2);\nWPCM450_SFUNC(r1err);\nWPCM450_SFUNC(r1md);\nWPCM450_SFUNC(rmii2);\nWPCM450_SFUNC(r2err);\nWPCM450_SFUNC(r2md);\nWPCM450_SFUNC(kbcc);\nWPCM450_SFUNC(clko);\nWPCM450_SFUNC(smi);\nWPCM450_SFUNC(uinc);\nWPCM450_SFUNC(gspi);\nWPCM450_SFUNC(mben);\nWPCM450_SFUNC(xcs2);\nWPCM450_SFUNC(xcs1);\nWPCM450_SFUNC(sdio);\nWPCM450_SFUNC(sspi);\nWPCM450_SFUNC(fi0);\nWPCM450_SFUNC(fi1);\nWPCM450_SFUNC(fi2);\nWPCM450_SFUNC(fi3);\nWPCM450_SFUNC(fi4);\nWPCM450_SFUNC(fi5);\nWPCM450_SFUNC(fi6);\nWPCM450_SFUNC(fi7);\nWPCM450_SFUNC(fi8);\nWPCM450_SFUNC(fi9);\nWPCM450_SFUNC(fi10);\nWPCM450_SFUNC(fi11);\nWPCM450_SFUNC(fi12);\nWPCM450_SFUNC(fi13);\nWPCM450_SFUNC(fi14);\nWPCM450_SFUNC(fi15);\nWPCM450_SFUNC(pwm0);\nWPCM450_SFUNC(pwm1);\nWPCM450_SFUNC(pwm2);\nWPCM450_SFUNC(pwm3);\nWPCM450_SFUNC(pwm4);\nWPCM450_SFUNC(pwm5);\nWPCM450_SFUNC(pwm6);\nWPCM450_SFUNC(pwm7);\nWPCM450_SFUNC(hg0);\nWPCM450_SFUNC(hg1);\nWPCM450_SFUNC(hg2);\nWPCM450_SFUNC(hg3);\nWPCM450_SFUNC(hg4);\nWPCM450_SFUNC(hg5);\nWPCM450_SFUNC(hg6);\nWPCM450_SFUNC(hg7);\n\n#define WPCM450_GRP(x) #x\nWPCM450_FUNC(gpio, WPCM450_GRPS);\n#undef WPCM450_GRP\n\n \nstatic struct wpcm450_func wpcm450_funcs[] = {\n\tWPCM450_MKFUNC(smb3),\n\tWPCM450_MKFUNC(smb4),\n\tWPCM450_MKFUNC(smb5),\n\tWPCM450_MKFUNC(scs1),\n\tWPCM450_MKFUNC(scs2),\n\tWPCM450_MKFUNC(scs3),\n\tWPCM450_MKFUNC(smb0),\n\tWPCM450_MKFUNC(smb1),\n\tWPCM450_MKFUNC(smb2),\n\tWPCM450_MKFUNC(bsp),\n\tWPCM450_MKFUNC(hsp1),\n\tWPCM450_MKFUNC(hsp2),\n\tWPCM450_MKFUNC(r1err),\n\tWPCM450_MKFUNC(r1md),\n\tWPCM450_MKFUNC(rmii2),\n\tWPCM450_MKFUNC(r2err),\n\tWPCM450_MKFUNC(r2md),\n\tWPCM450_MKFUNC(kbcc),\n\tWPCM450_MKFUNC(clko),\n\tWPCM450_MKFUNC(smi),\n\tWPCM450_MKFUNC(uinc),\n\tWPCM450_MKFUNC(gspi),\n\tWPCM450_MKFUNC(mben),\n\tWPCM450_MKFUNC(xcs2),\n\tWPCM450_MKFUNC(xcs1),\n\tWPCM450_MKFUNC(sdio),\n\tWPCM450_MKFUNC(sspi),\n\tWPCM450_MKFUNC(fi0),\n\tWPCM450_MKFUNC(fi1),\n\tWPCM450_MKFUNC(fi2),\n\tWPCM450_MKFUNC(fi3),\n\tWPCM450_MKFUNC(fi4),\n\tWPCM450_MKFUNC(fi5),\n\tWPCM450_MKFUNC(fi6),\n\tWPCM450_MKFUNC(fi7),\n\tWPCM450_MKFUNC(fi8),\n\tWPCM450_MKFUNC(fi9),\n\tWPCM450_MKFUNC(fi10),\n\tWPCM450_MKFUNC(fi11),\n\tWPCM450_MKFUNC(fi12),\n\tWPCM450_MKFUNC(fi13),\n\tWPCM450_MKFUNC(fi14),\n\tWPCM450_MKFUNC(fi15),\n\tWPCM450_MKFUNC(pwm0),\n\tWPCM450_MKFUNC(pwm1),\n\tWPCM450_MKFUNC(pwm2),\n\tWPCM450_MKFUNC(pwm3),\n\tWPCM450_MKFUNC(pwm4),\n\tWPCM450_MKFUNC(pwm5),\n\tWPCM450_MKFUNC(pwm6),\n\tWPCM450_MKFUNC(pwm7),\n\tWPCM450_MKFUNC(hg0),\n\tWPCM450_MKFUNC(hg1),\n\tWPCM450_MKFUNC(hg2),\n\tWPCM450_MKFUNC(hg3),\n\tWPCM450_MKFUNC(hg4),\n\tWPCM450_MKFUNC(hg5),\n\tWPCM450_MKFUNC(hg6),\n\tWPCM450_MKFUNC(hg7),\n\tWPCM450_MKFUNC(gpio),\n};\n\n#define WPCM450_PINCFG(a, b, c, d, e, f, g) \\\n\t[a] = { .fn0 = fn_ ## b, .reg0 = WPCM450_GCR_ ## c, .bit0 = d, \\\n\t        .fn1 = fn_ ## e, .reg1 = WPCM450_GCR_ ## f, .bit1 = g }\n\nstruct wpcm450_pincfg {\n\tint fn0, reg0, bit0;\n\tint fn1, reg1, bit1;\n};\n\n \n#define INV\tBIT(5)\n\nstatic const struct wpcm450_pincfg pincfg[] = {\n\t \n\tWPCM450_PINCFG(0,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(1,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(2,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(3,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(4,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(5,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(6,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(7,\t none, NONE, 0,\t\t  sdio, MFSEL1, 30),\n\tWPCM450_PINCFG(8,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(9,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(10,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(11,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(12,\t gspi, MFSEL1, 24,\t  sspi, MFSEL1, 31),\n\tWPCM450_PINCFG(13,\t gspi, MFSEL1, 24,\t  sspi, MFSEL1, 31),\n\tWPCM450_PINCFG(14,\t gspi, MFSEL1, 24,\t  sspi, MFSEL1, 31),\n\tWPCM450_PINCFG(15,\t gspi, MFSEL1, 24,\t  sspi, MFSEL1, 31),\n\tWPCM450_PINCFG(16,\t none, NONE, 0,\t\t  pwm6, MFSEL2, 22),\n\tWPCM450_PINCFG(17,\t none, NONE, 0,\t\t  pwm7, MFSEL2, 23),\n\tWPCM450_PINCFG(18,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(19,\t uinc, MFSEL1, 23,\t  none, NONE, 0),\n\tWPCM450_PINCFG(20,\t  hg0, MFSEL2, 24,\t  pwm4, MFSEL2, 20),\n\tWPCM450_PINCFG(21,\t  hg1, MFSEL2, 25,\t  pwm5, MFSEL2, 21),\n\tWPCM450_PINCFG(22,\t  hg2, MFSEL2, 26,\t  none, NONE, 0),\n\tWPCM450_PINCFG(23,\t  hg3, MFSEL2, 27,\t  none, NONE, 0),\n\tWPCM450_PINCFG(24,\t  hg4, MFSEL2, 28,\t  none, NONE, 0),\n\tWPCM450_PINCFG(25,\t  hg5, MFSEL2, 29,\t  none, NONE, 0),\n\tWPCM450_PINCFG(26,\t smb5, MFSEL1, 2,\t  none, NONE, 0),\n\tWPCM450_PINCFG(27,\t smb5, MFSEL1, 2,\t  none, NONE, 0),\n\tWPCM450_PINCFG(28,\t smb4, MFSEL1, 1,\t  none, NONE, 0),\n\tWPCM450_PINCFG(29,\t smb4, MFSEL1, 1,\t  none, NONE, 0),\n\tWPCM450_PINCFG(30,\t smb3, MFSEL1, 0,\t  none, NONE, 0),\n\tWPCM450_PINCFG(31,\t smb3, MFSEL1, 0,\t  none, NONE, 0),\n\n\tWPCM450_PINCFG(32,\t scs1, MFSEL1, 3,\t  none, NONE, 0),\n\tWPCM450_PINCFG(33,\t scs2, MFSEL1, 4,\t  none, NONE, 0),\n\tWPCM450_PINCFG(34,\t scs3, MFSEL1, 5 | INV,\t  none, NONE, 0),\n\tWPCM450_PINCFG(35,\t xcs1, MFSEL1, 29,\t  none, NONE, 0),\n\tWPCM450_PINCFG(36,\t xcs2, MFSEL1, 28,\t  none, NONE, 0),\n\tWPCM450_PINCFG(37,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(38,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(39,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(40,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(41,\t  bsp, MFSEL1, 9,\t  none, NONE, 0),\n\tWPCM450_PINCFG(42,\t  bsp, MFSEL1, 9,\t  none, NONE, 0),\n\tWPCM450_PINCFG(43,\t hsp1, MFSEL1, 10,\t  sdio, MFSEL1, 30),\n\tWPCM450_PINCFG(44,\t hsp1, MFSEL1, 10,\t  sdio, MFSEL1, 30),\n\tWPCM450_PINCFG(45,\t hsp1, MFSEL1, 10,\t  sdio, MFSEL1, 30),\n\tWPCM450_PINCFG(46,\t hsp1, MFSEL1, 10,\t  sdio, MFSEL1, 30),\n\tWPCM450_PINCFG(47,\t hsp1, MFSEL1, 10,\t  sdio, MFSEL1, 30),\n\tWPCM450_PINCFG(48,\t hsp2, MFSEL1, 11,\t  none, NONE, 0),\n\tWPCM450_PINCFG(49,\t hsp2, MFSEL1, 11,\t  none, NONE, 0),\n\tWPCM450_PINCFG(50,\t hsp2, MFSEL1, 11,\t  none, NONE, 0),\n\tWPCM450_PINCFG(51,\t hsp2, MFSEL1, 11,\t  none, NONE, 0),\n\tWPCM450_PINCFG(52,\t hsp2, MFSEL1, 11,\t  none, NONE, 0),\n\tWPCM450_PINCFG(53,\t hsp2, MFSEL1, 11,\t  none, NONE, 0),\n\tWPCM450_PINCFG(54,\t hsp2, MFSEL1, 11,\t  none, NONE, 0),\n\tWPCM450_PINCFG(55,\t hsp2, MFSEL1, 11,\t  none, NONE, 0),\n\tWPCM450_PINCFG(56,\tr1err, MFSEL1, 12,\t  none, NONE, 0),\n\tWPCM450_PINCFG(57,\t r1md, MFSEL1, 13,\t  none, NONE, 0),\n\tWPCM450_PINCFG(58,\t r1md, MFSEL1, 13,\t  none, NONE, 0),\n\tWPCM450_PINCFG(59,\t  hg6, MFSEL2, 30,\t  none, NONE, 0),\n\tWPCM450_PINCFG(60,\t  hg7, MFSEL2, 31,\t  sdio, MFSEL1, 30),\n\tWPCM450_PINCFG(61,\t hsp1, MFSEL1, 10,\t  none, NONE, 0),\n\tWPCM450_PINCFG(62,\t hsp1, MFSEL1, 10,\t  none, NONE, 0),\n\tWPCM450_PINCFG(63,\t hsp1, MFSEL1, 10,\t  none, NONE, 0),\n\n\tWPCM450_PINCFG(64,\t  fi0, MFSEL2, 0,\t  none, NONE, 0),\n\tWPCM450_PINCFG(65,\t  fi1, MFSEL2, 1,\t  none, NONE, 0),\n\tWPCM450_PINCFG(66,\t  fi2, MFSEL2, 2,\t  none, NONE, 0),\n\tWPCM450_PINCFG(67,\t  fi3, MFSEL2, 3,\t  none, NONE, 0),\n\tWPCM450_PINCFG(68,\t  fi4, MFSEL2, 4,\t  none, NONE, 0),\n\tWPCM450_PINCFG(69,\t  fi5, MFSEL2, 5,\t  none, NONE, 0),\n\tWPCM450_PINCFG(70,\t  fi6, MFSEL2, 6,\t  none, NONE, 0),\n\tWPCM450_PINCFG(71,\t  fi7, MFSEL2, 7,\t  none, NONE, 0),\n\tWPCM450_PINCFG(72,\t  fi8, MFSEL2, 8,\t  none, NONE, 0),\n\tWPCM450_PINCFG(73,\t  fi9, MFSEL2, 9,\t  none, NONE, 0),\n\tWPCM450_PINCFG(74,\t fi10, MFSEL2, 10,\t  none, NONE, 0),\n\tWPCM450_PINCFG(75,\t fi11, MFSEL2, 11,\t  none, NONE, 0),\n\tWPCM450_PINCFG(76,\t fi12, MFSEL2, 12,\t  none, NONE, 0),\n\tWPCM450_PINCFG(77,\t fi13, MFSEL2, 13,\t  none, NONE, 0),\n\tWPCM450_PINCFG(78,\t fi14, MFSEL2, 14,\t  none, NONE, 0),\n\tWPCM450_PINCFG(79,\t fi15, MFSEL2, 15,\t  none, NONE, 0),\n\tWPCM450_PINCFG(80,\t pwm0, MFSEL2, 16,\t  none, NONE, 0),\n\tWPCM450_PINCFG(81,\t pwm1, MFSEL2, 17,\t  none, NONE, 0),\n\tWPCM450_PINCFG(82,\t pwm2, MFSEL2, 18,\t  none, NONE, 0),\n\tWPCM450_PINCFG(83,\t pwm3, MFSEL2, 19,\t  none, NONE, 0),\n\tWPCM450_PINCFG(84,\trmii2, MFSEL1, 14,\t  none, NONE, 0),\n\tWPCM450_PINCFG(85,\trmii2, MFSEL1, 14,\t  none, NONE, 0),\n\tWPCM450_PINCFG(86,\trmii2, MFSEL1, 14,\t  none, NONE, 0),\n\tWPCM450_PINCFG(87,\trmii2, MFSEL1, 14,\t  none, NONE, 0),\n\tWPCM450_PINCFG(88,\trmii2, MFSEL1, 14,\t  none, NONE, 0),\n\tWPCM450_PINCFG(89,\trmii2, MFSEL1, 14,\t  none, NONE, 0),\n\tWPCM450_PINCFG(90,\tr2err, MFSEL1, 15,\t  none, NONE, 0),\n\tWPCM450_PINCFG(91,\t r2md, MFSEL1, 16,\t  none, NONE, 0),\n\tWPCM450_PINCFG(92,\t r2md, MFSEL1, 16,\t  none, NONE, 0),\n\tWPCM450_PINCFG(93,\t kbcc, MFSEL1, 17 | INV,  none, NONE, 0),\n\tWPCM450_PINCFG(94,\t kbcc, MFSEL1, 17 | INV,  none, NONE, 0),\n\tWPCM450_PINCFG(95,\t none, NONE, 0,\t\t  none, NONE, 0),\n\n\tWPCM450_PINCFG(96,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(97,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(98,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(99,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(100,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(101,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(102,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(103,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(104,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(105,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(106,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(107,\t none, NONE, 0,\t\t  none, NONE, 0),\n\tWPCM450_PINCFG(108,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(109,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(110,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(111,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(112,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(113,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(114,\t smb0, MFSEL1, 6,\t  none, NONE, 0),\n\tWPCM450_PINCFG(115,\t smb0, MFSEL1, 6,\t  none, NONE, 0),\n\tWPCM450_PINCFG(116,\t smb1, MFSEL1, 7,\t  none, NONE, 0),\n\tWPCM450_PINCFG(117,\t smb1, MFSEL1, 7,\t  none, NONE, 0),\n\tWPCM450_PINCFG(118,\t smb2, MFSEL1, 8,\t  none, NONE, 0),\n\tWPCM450_PINCFG(119,\t smb2, MFSEL1, 8,\t  none, NONE, 0),\n\tWPCM450_PINCFG(120,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(121,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(122,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(123,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(124,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(125,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(126,\t none, NONE, 0,\t\t  none, NONE, 0),  \n\tWPCM450_PINCFG(127,\t none, NONE, 0,\t\t  none, NONE, 0),  \n};\n\n#define WPCM450_PIN(n)\t\tPINCTRL_PIN(n, \"gpio\" #n)\n\nstatic const struct pinctrl_pin_desc wpcm450_pins[] = {\n\tWPCM450_PIN(0),   WPCM450_PIN(1),   WPCM450_PIN(2),   WPCM450_PIN(3),\n\tWPCM450_PIN(4),   WPCM450_PIN(5),   WPCM450_PIN(6),   WPCM450_PIN(7),\n\tWPCM450_PIN(8),   WPCM450_PIN(9),   WPCM450_PIN(10),  WPCM450_PIN(11),\n\tWPCM450_PIN(12),  WPCM450_PIN(13),  WPCM450_PIN(14),  WPCM450_PIN(15),\n\tWPCM450_PIN(16),  WPCM450_PIN(17),  WPCM450_PIN(18),  WPCM450_PIN(19),\n\tWPCM450_PIN(20),  WPCM450_PIN(21),  WPCM450_PIN(22),  WPCM450_PIN(23),\n\tWPCM450_PIN(24),  WPCM450_PIN(25),  WPCM450_PIN(26),  WPCM450_PIN(27),\n\tWPCM450_PIN(28),  WPCM450_PIN(29),  WPCM450_PIN(30),  WPCM450_PIN(31),\n\tWPCM450_PIN(32),  WPCM450_PIN(33),  WPCM450_PIN(34),  WPCM450_PIN(35),\n\tWPCM450_PIN(36),  WPCM450_PIN(37),  WPCM450_PIN(38),  WPCM450_PIN(39),\n\tWPCM450_PIN(40),  WPCM450_PIN(41),  WPCM450_PIN(42),  WPCM450_PIN(43),\n\tWPCM450_PIN(44),  WPCM450_PIN(45),  WPCM450_PIN(46),  WPCM450_PIN(47),\n\tWPCM450_PIN(48),  WPCM450_PIN(49),  WPCM450_PIN(50),  WPCM450_PIN(51),\n\tWPCM450_PIN(52),  WPCM450_PIN(53),  WPCM450_PIN(54),  WPCM450_PIN(55),\n\tWPCM450_PIN(56),  WPCM450_PIN(57),  WPCM450_PIN(58),  WPCM450_PIN(59),\n\tWPCM450_PIN(60),  WPCM450_PIN(61),  WPCM450_PIN(62),  WPCM450_PIN(63),\n\tWPCM450_PIN(64),  WPCM450_PIN(65),  WPCM450_PIN(66),  WPCM450_PIN(67),\n\tWPCM450_PIN(68),  WPCM450_PIN(69),  WPCM450_PIN(70),  WPCM450_PIN(71),\n\tWPCM450_PIN(72),  WPCM450_PIN(73),  WPCM450_PIN(74),  WPCM450_PIN(75),\n\tWPCM450_PIN(76),  WPCM450_PIN(77),  WPCM450_PIN(78),  WPCM450_PIN(79),\n\tWPCM450_PIN(80),  WPCM450_PIN(81),  WPCM450_PIN(82),  WPCM450_PIN(83),\n\tWPCM450_PIN(84),  WPCM450_PIN(85),  WPCM450_PIN(86),  WPCM450_PIN(87),\n\tWPCM450_PIN(88),  WPCM450_PIN(89),  WPCM450_PIN(90),  WPCM450_PIN(91),\n\tWPCM450_PIN(92),  WPCM450_PIN(93),  WPCM450_PIN(94),  WPCM450_PIN(95),\n\tWPCM450_PIN(96),  WPCM450_PIN(97),  WPCM450_PIN(98),  WPCM450_PIN(99),\n\tWPCM450_PIN(100), WPCM450_PIN(101), WPCM450_PIN(102), WPCM450_PIN(103),\n\tWPCM450_PIN(104), WPCM450_PIN(105), WPCM450_PIN(106), WPCM450_PIN(107),\n\tWPCM450_PIN(108), WPCM450_PIN(109), WPCM450_PIN(110), WPCM450_PIN(111),\n\tWPCM450_PIN(112), WPCM450_PIN(113), WPCM450_PIN(114), WPCM450_PIN(115),\n\tWPCM450_PIN(116), WPCM450_PIN(117), WPCM450_PIN(118), WPCM450_PIN(119),\n\tWPCM450_PIN(120), WPCM450_PIN(121), WPCM450_PIN(122), WPCM450_PIN(123),\n\tWPCM450_PIN(124), WPCM450_PIN(125), WPCM450_PIN(126), WPCM450_PIN(127),\n};\n\n \nstatic void wpcm450_update_mfsel(struct regmap *gcr_regmap, int reg, int bit, int fn, int fn_selected)\n{\n\tbool value = (fn == fn_selected);\n\n\tif (bit & INV) {\n\t\tvalue = !value;\n\t\tbit &= ~INV;\n\t}\n\n\tregmap_update_bits(gcr_regmap, reg, BIT(bit), value ? BIT(bit) : 0);\n}\n\n \nstatic void wpcm450_setfunc(struct regmap *gcr_regmap, const unsigned int *pin,\n\t\t\t    int npins, int func)\n{\n\tconst struct wpcm450_pincfg *cfg;\n\tint i;\n\n\tfor (i = 0; i < npins; i++) {\n\t\tcfg = &pincfg[pin[i]];\n\t\tif (func == fn_gpio || cfg->fn0 == func || cfg->fn1 == func) {\n\t\t\tif (cfg->reg0)\n\t\t\t\twpcm450_update_mfsel(gcr_regmap, cfg->reg0,\n\t\t\t\t\t\t     cfg->bit0, cfg->fn0, func);\n\t\t\tif (cfg->reg1)\n\t\t\t\twpcm450_update_mfsel(gcr_regmap, cfg->reg1,\n\t\t\t\t\t\t     cfg->bit1, cfg->fn1, func);\n\t\t}\n\t}\n}\n\nstatic int wpcm450_get_groups_count(struct pinctrl_dev *pctldev)\n{\n\treturn ARRAY_SIZE(wpcm450_groups);\n}\n\nstatic const char *wpcm450_get_group_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t  unsigned int selector)\n{\n\treturn wpcm450_groups[selector].name;\n}\n\nstatic int wpcm450_get_group_pins(struct pinctrl_dev *pctldev,\n\t\t\t\t  unsigned int selector,\n\t\t\t\t  const unsigned int **pins,\n\t\t\t\t  unsigned int *npins)\n{\n\t*npins = wpcm450_groups[selector].num_pins;\n\t*pins  = wpcm450_groups[selector].pins;\n\n\treturn 0;\n}\n\nstatic int wpcm450_dt_node_to_map(struct pinctrl_dev *pctldev,\n\t\t\t\t  struct device_node *np_config,\n\t\t\t\t  struct pinctrl_map **map,\n\t\t\t\t  u32 *num_maps)\n{\n\treturn pinconf_generic_dt_node_to_map(pctldev, np_config,\n\t\t\t\t\t      map, num_maps,\n\t\t\t\t\t      PIN_MAP_TYPE_INVALID);\n}\n\nstatic void wpcm450_dt_free_map(struct pinctrl_dev *pctldev,\n\t\t\t\tstruct pinctrl_map *map, u32 num_maps)\n{\n\tkfree(map);\n}\n\nstatic const struct pinctrl_ops wpcm450_pinctrl_ops = {\n\t.get_groups_count = wpcm450_get_groups_count,\n\t.get_group_name = wpcm450_get_group_name,\n\t.get_group_pins = wpcm450_get_group_pins,\n\t.dt_node_to_map = wpcm450_dt_node_to_map,\n\t.dt_free_map = wpcm450_dt_free_map,\n};\n\nstatic int wpcm450_get_functions_count(struct pinctrl_dev *pctldev)\n{\n\treturn ARRAY_SIZE(wpcm450_funcs);\n}\n\nstatic const char *wpcm450_get_function_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t     unsigned int function)\n{\n\treturn wpcm450_funcs[function].name;\n}\n\nstatic int wpcm450_get_function_groups(struct pinctrl_dev *pctldev,\n\t\t\t\t       unsigned int function,\n\t\t\t\t       const char * const **groups,\n\t\t\t\t       unsigned int * const ngroups)\n{\n\t*ngroups = wpcm450_funcs[function].ngroups;\n\t*groups\t = wpcm450_funcs[function].groups;\n\n\treturn 0;\n}\n\nstatic int wpcm450_pinmux_set_mux(struct pinctrl_dev *pctldev,\n\t\t\t\t  unsigned int function,\n\t\t\t\t  unsigned int group)\n{\n\tstruct wpcm450_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\n\n\twpcm450_setfunc(pctrl->gcr_regmap, wpcm450_groups[group].pins,\n\t\t\twpcm450_groups[group].num_pins, function);\n\n\treturn 0;\n}\n\nstatic const struct pinmux_ops wpcm450_pinmux_ops = {\n\t.get_functions_count = wpcm450_get_functions_count,\n\t.get_function_name = wpcm450_get_function_name,\n\t.get_function_groups = wpcm450_get_function_groups,\n\t.set_mux = wpcm450_pinmux_set_mux,\n};\n\nstatic int debounce_bitnum(int gpio)\n{\n\tif (gpio >= 0 && gpio < 16)\n\t\treturn gpio;\n\treturn -EINVAL;\n}\n\nstatic int wpcm450_config_get(struct pinctrl_dev *pctldev, unsigned int pin,\n\t\t\t      unsigned long *config)\n{\n\tstruct wpcm450_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\n\tenum pin_config_param param = pinconf_to_config_param(*config);\n\tunsigned long flags;\n\tint bit;\n\tu32 reg;\n\n\tswitch (param) {\n\tcase PIN_CONFIG_INPUT_DEBOUNCE:\n\t\tbit = debounce_bitnum(pin);\n\t\tif (bit < 0)\n\t\t\treturn bit;\n\n\t\traw_spin_lock_irqsave(&pctrl->lock, flags);\n\t\treg = ioread32(pctrl->gpio_base + WPCM450_GPEVDBNC);\n\t\traw_spin_unlock_irqrestore(&pctrl->lock, flags);\n\n\t\t*config = pinconf_to_config_packed(param, !!(reg & BIT(bit)));\n\t\treturn 0;\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n}\n\nstatic int wpcm450_config_set_one(struct wpcm450_pinctrl *pctrl,\n\t\t\t\t  unsigned int pin, unsigned long config)\n{\n\tenum pin_config_param param = pinconf_to_config_param(config);\n\tunsigned long flags;\n\tunsigned long reg;\n\tint bit;\n\tint arg;\n\n\tswitch (param) {\n\tcase PIN_CONFIG_INPUT_DEBOUNCE:\n\t\tbit = debounce_bitnum(pin);\n\t\tif (bit < 0)\n\t\t\treturn bit;\n\n\t\targ = pinconf_to_config_argument(config);\n\n\t\traw_spin_lock_irqsave(&pctrl->lock, flags);\n\t\treg = ioread32(pctrl->gpio_base + WPCM450_GPEVDBNC);\n\t\t__assign_bit(bit, &reg, arg);\n\t\tiowrite32(reg, pctrl->gpio_base + WPCM450_GPEVDBNC);\n\t\traw_spin_unlock_irqrestore(&pctrl->lock, flags);\n\t\treturn 0;\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n}\n\nstatic int wpcm450_config_set(struct pinctrl_dev *pctldev, unsigned int pin,\n\t\t\t      unsigned long *configs, unsigned int num_configs)\n{\n\tstruct wpcm450_pinctrl *pctrl = pinctrl_dev_get_drvdata(pctldev);\n\tint ret;\n\n\twhile (num_configs--) {\n\t\tret = wpcm450_config_set_one(pctrl, pin, *configs++);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct pinconf_ops wpcm450_pinconf_ops = {\n\t.is_generic = true,\n\t.pin_config_get = wpcm450_config_get,\n\t.pin_config_set = wpcm450_config_set,\n};\n\nstatic struct pinctrl_desc wpcm450_pinctrl_desc = {\n\t.name = \"wpcm450-pinctrl\",\n\t.pins = wpcm450_pins,\n\t.npins = ARRAY_SIZE(wpcm450_pins),\n\t.pctlops = &wpcm450_pinctrl_ops,\n\t.pmxops = &wpcm450_pinmux_ops,\n\t.confops = &wpcm450_pinconf_ops,\n\t.owner = THIS_MODULE,\n};\n\nstatic int wpcm450_gpio_set_config(struct gpio_chip *chip,\n\t\t\t\t   unsigned int offset, unsigned long config)\n{\n\tstruct wpcm450_gpio *gpio = gpiochip_get_data(chip);\n\n\treturn wpcm450_config_set_one(gpio->pctrl, offset, config);\n}\n\nstatic int wpcm450_gpio_add_pin_ranges(struct gpio_chip *chip)\n{\n\tstruct wpcm450_gpio *gpio = gpiochip_get_data(chip);\n\tconst struct wpcm450_bank *bank = gpio->bank;\n\n\treturn gpiochip_add_pin_range(&gpio->gc, dev_name(gpio->pctrl->dev),\n\t\t\t\t      0, bank->base, bank->length);\n}\n\nstatic int wpcm450_gpio_register(struct platform_device *pdev,\n\t\t\t\t struct wpcm450_pinctrl *pctrl)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct fwnode_handle *child;\n\tint ret;\n\n\tpctrl->gpio_base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(pctrl->gpio_base))\n\t\treturn dev_err_probe(dev, PTR_ERR(pctrl->gpio_base),\n\t\t\t\t     \"Resource fail for GPIO controller\\n\");\n\n\tdevice_for_each_child_node(dev, child)  {\n\t\tvoid __iomem *dat = NULL;\n\t\tvoid __iomem *set = NULL;\n\t\tvoid __iomem *dirout = NULL;\n\t\tunsigned long flags = 0;\n\t\tconst struct wpcm450_bank *bank;\n\t\tstruct wpcm450_gpio *gpio;\n\t\tstruct gpio_irq_chip *girq;\n\t\tu32 reg;\n\t\tint i;\n\n\t\tif (!fwnode_property_read_bool(child, \"gpio-controller\"))\n\t\t\tcontinue;\n\n\t\tret = fwnode_property_read_u32(child, \"reg\", &reg);\n\t\tif (ret < 0)\n\t\t\treturn ret;\n\n\t\tif (reg >= WPCM450_NUM_BANKS)\n\t\t\treturn dev_err_probe(dev, -EINVAL,\n\t\t\t\t\t     \"GPIO index %d out of range!\\n\", reg);\n\n\t\tgpio = &pctrl->gpio_bank[reg];\n\t\tgpio->pctrl = pctrl;\n\n\t\tbank = &wpcm450_banks[reg];\n\t\tgpio->bank = bank;\n\n\t\tdat = pctrl->gpio_base + bank->datain;\n\t\tif (bank->dataout) {\n\t\t\tset = pctrl->gpio_base + bank->dataout;\n\t\t\tdirout = pctrl->gpio_base + bank->cfg0;\n\t\t} else {\n\t\t\tflags = BGPIOF_NO_OUTPUT;\n\t\t}\n\t\tret = bgpio_init(&gpio->gc, dev, 4,\n\t\t\t\t dat, set, NULL, dirout, NULL, flags);\n\t\tif (ret < 0)\n\t\t\treturn dev_err_probe(dev, ret, \"GPIO initialization failed\\n\");\n\n\t\tgpio->gc.ngpio = bank->length;\n\t\tgpio->gc.set_config = wpcm450_gpio_set_config;\n\t\tgpio->gc.fwnode = child;\n\t\tgpio->gc.add_pin_ranges = wpcm450_gpio_add_pin_ranges;\n\n\t\tgirq = &gpio->gc.irq;\n\t\tgpio_irq_chip_set_chip(girq, &wpcm450_gpio_irqchip);\n\t\tgirq->parent_handler = wpcm450_gpio_irqhandler;\n\t\tgirq->parents = devm_kcalloc(dev, WPCM450_NUM_GPIO_IRQS,\n\t\t\t\t\t     sizeof(*girq->parents), GFP_KERNEL);\n\t\tif (!girq->parents)\n\t\t\treturn -ENOMEM;\n\t\tgirq->default_type = IRQ_TYPE_NONE;\n\t\tgirq->handler = handle_bad_irq;\n\n\t\tgirq->num_parents = 0;\n\t\tfor (i = 0; i < WPCM450_NUM_GPIO_IRQS; i++) {\n\t\t\tint irq;\n\n\t\t\tirq = fwnode_irq_get(child, i);\n\t\t\tif (irq < 0)\n\t\t\t\tbreak;\n\t\t\tif (!irq)\n\t\t\t\tcontinue;\n\n\t\t\tgirq->parents[i] = irq;\n\t\t\tgirq->num_parents++;\n\t\t}\n\n\t\tret = devm_gpiochip_add_data(dev, &gpio->gc, gpio);\n\t\tif (ret)\n\t\t\treturn dev_err_probe(dev, ret, \"Failed to add GPIO chip\\n\");\n\t}\n\n\treturn 0;\n}\n\nstatic int wpcm450_pinctrl_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct wpcm450_pinctrl *pctrl;\n\tint ret;\n\n\tpctrl = devm_kzalloc(dev, sizeof(*pctrl), GFP_KERNEL);\n\tif (!pctrl)\n\t\treturn -ENOMEM;\n\n\tpctrl->dev = &pdev->dev;\n\traw_spin_lock_init(&pctrl->lock);\n\tdev_set_drvdata(dev, pctrl);\n\n\tpctrl->gcr_regmap =\n\t\tsyscon_regmap_lookup_by_compatible(\"nuvoton,wpcm450-gcr\");\n\tif (IS_ERR(pctrl->gcr_regmap))\n\t\treturn dev_err_probe(dev, PTR_ERR(pctrl->gcr_regmap),\n\t\t\t\t     \"Failed to find nuvoton,wpcm450-gcr\\n\");\n\n\tpctrl->pctldev = devm_pinctrl_register(dev,\n\t\t\t\t\t       &wpcm450_pinctrl_desc, pctrl);\n\tif (IS_ERR(pctrl->pctldev))\n\t\treturn dev_err_probe(dev, PTR_ERR(pctrl->pctldev),\n\t\t\t\t     \"Failed to register pinctrl device\\n\");\n\n\tret = wpcm450_gpio_register(pdev, pctrl);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic const struct of_device_id wpcm450_pinctrl_match[] = {\n\t{ .compatible = \"nuvoton,wpcm450-pinctrl\" },\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, wpcm450_pinctrl_match);\n\nstatic struct platform_driver wpcm450_pinctrl_driver = {\n\t.probe = wpcm450_pinctrl_probe,\n\t.driver = {\n\t\t.name = \"wpcm450-pinctrl\",\n\t\t.of_match_table = wpcm450_pinctrl_match,\n\t},\n};\nmodule_platform_driver(wpcm450_pinctrl_driver);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Jonathan Neusch\u00e4fer <j.neuschaefer@gmx.net>\");\nMODULE_DESCRIPTION(\"Nuvoton WPCM450 Pinctrl and GPIO driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}