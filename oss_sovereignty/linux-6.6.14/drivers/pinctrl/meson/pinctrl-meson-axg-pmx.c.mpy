{
  "module_name": "pinctrl-meson-axg-pmx.c",
  "hash_id": "c2ff6443a4739be127890aaf75d0396ceeb6d5eae7151314f0f9e2d7389a5085",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pinctrl/meson/pinctrl-meson-axg-pmx.c",
  "human_readable_source": "\n \n\n \n#include <linux/device.h>\n#include <linux/regmap.h>\n#include <linux/pinctrl/pinctrl.h>\n#include <linux/pinctrl/pinmux.h>\n\n#include \"pinctrl-meson.h\"\n#include \"pinctrl-meson-axg-pmx.h\"\n\nstatic int meson_axg_pmx_get_bank(struct meson_pinctrl *pc,\n\t\t\tunsigned int pin,\n\t\t\tstruct meson_pmx_bank **bank)\n{\n\tint i;\n\tstruct meson_axg_pmx_data *pmx = pc->data->pmx_data;\n\n\tfor (i = 0; i < pmx->num_pmx_banks; i++)\n\t\tif (pin >= pmx->pmx_banks[i].first &&\n\t\t\t\tpin <= pmx->pmx_banks[i].last) {\n\t\t\t*bank = &pmx->pmx_banks[i];\n\t\t\treturn 0;\n\t\t}\n\n\treturn -EINVAL;\n}\n\nstatic int meson_pmx_calc_reg_and_offset(struct meson_pmx_bank *bank,\n\t\t\tunsigned int pin, unsigned int *reg,\n\t\t\tunsigned int *offset)\n{\n\tint shift;\n\n\tshift = pin - bank->first;\n\n\t*reg = bank->reg + (bank->offset + (shift << 2)) / 32;\n\t*offset = (bank->offset + (shift << 2)) % 32;\n\n\treturn 0;\n}\n\nstatic int meson_axg_pmx_update_function(struct meson_pinctrl *pc,\n\t\t\tunsigned int pin, unsigned int func)\n{\n\tint ret;\n\tint reg;\n\tint offset;\n\tstruct meson_pmx_bank *bank;\n\n\tret = meson_axg_pmx_get_bank(pc, pin, &bank);\n\tif (ret)\n\t\treturn ret;\n\n\tmeson_pmx_calc_reg_and_offset(bank, pin, &reg, &offset);\n\n\tret = regmap_update_bits(pc->reg_mux, reg << 2,\n\t\t0xf << offset, (func & 0xf) << offset);\n\n\treturn ret;\n}\n\nstatic int meson_axg_pmx_set_mux(struct pinctrl_dev *pcdev,\n\t\t\tunsigned int func_num, unsigned int group_num)\n{\n\tint i;\n\tint ret;\n\tstruct meson_pinctrl *pc = pinctrl_dev_get_drvdata(pcdev);\n\tstruct meson_pmx_func *func = &pc->data->funcs[func_num];\n\tstruct meson_pmx_group *group = &pc->data->groups[group_num];\n\tstruct meson_pmx_axg_data *pmx_data =\n\t\t(struct meson_pmx_axg_data *)group->data;\n\n\tdev_dbg(pc->dev, \"enable function %s, group %s\\n\", func->name,\n\t\tgroup->name);\n\n\tfor (i = 0; i < group->num_pins; i++) {\n\t\tret = meson_axg_pmx_update_function(pc, group->pins[i],\n\t\t\tpmx_data->func);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int meson_axg_pmx_request_gpio(struct pinctrl_dev *pcdev,\n\t\t\tstruct pinctrl_gpio_range *range, unsigned int offset)\n{\n\tstruct meson_pinctrl *pc = pinctrl_dev_get_drvdata(pcdev);\n\n\treturn meson_axg_pmx_update_function(pc, offset, 0);\n}\n\nconst struct pinmux_ops meson_axg_pmx_ops = {\n\t.set_mux = meson_axg_pmx_set_mux,\n\t.get_functions_count = meson_pmx_get_funcs_count,\n\t.get_function_name = meson_pmx_get_func_name,\n\t.get_function_groups = meson_pmx_get_groups,\n\t.gpio_request_enable = meson_axg_pmx_request_gpio,\n};\nEXPORT_SYMBOL_GPL(meson_axg_pmx_ops);\n\nMODULE_LICENSE(\"Dual BSD/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}