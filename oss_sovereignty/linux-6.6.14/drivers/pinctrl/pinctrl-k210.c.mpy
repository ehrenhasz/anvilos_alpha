{
  "module_name": "pinctrl-k210.c",
  "hash_id": "4a0b2b80806d4afb7f3a29ad7eb923a571f7c8cb4f0b9b736f7517b74827c4b0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pinctrl/pinctrl-k210.c",
  "human_readable_source": "\n \n#include <linux/bitfield.h>\n#include <linux/clk.h>\n#include <linux/io.h>\n#include <linux/mfd/syscon.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n#include <linux/seq_file.h>\n#include <linux/slab.h>\n\n#include <linux/pinctrl/pinconf-generic.h>\n#include <linux/pinctrl/pinconf.h>\n#include <linux/pinctrl/pinctrl.h>\n#include <linux/pinctrl/pinmux.h>\n\n#include <dt-bindings/pinctrl/k210-fpioa.h>\n\n#include \"core.h\"\n#include \"pinconf.h\"\n#include \"pinctrl-utils.h\"\n\n \n#define K210_PC_DRIVE_MASK\tGENMASK(11, 8)\n#define K210_PC_DRIVE_SHIFT\t8\n#define K210_PC_DRIVE_0\t\t(0 << K210_PC_DRIVE_SHIFT)\n#define K210_PC_DRIVE_1\t\t(1 << K210_PC_DRIVE_SHIFT)\n#define K210_PC_DRIVE_2\t\t(2 << K210_PC_DRIVE_SHIFT)\n#define K210_PC_DRIVE_3\t\t(3 << K210_PC_DRIVE_SHIFT)\n#define K210_PC_DRIVE_4\t\t(4 << K210_PC_DRIVE_SHIFT)\n#define K210_PC_DRIVE_5\t\t(5 << K210_PC_DRIVE_SHIFT)\n#define K210_PC_DRIVE_6\t\t(6 << K210_PC_DRIVE_SHIFT)\n#define K210_PC_DRIVE_7\t\t(7 << K210_PC_DRIVE_SHIFT)\n#define K210_PC_DRIVE_MAX\t7\n#define K210_PC_MODE_MASK\tGENMASK(23, 12)\n\n \n#define K210_PC_OE\t\tBIT(12)  \n#define K210_PC_OE_INV\t\tBIT(13)  \n#define K210_PC_DO_OE\t\tBIT(14)  \n#define K210_PC_DO_INV\t\tBIT(15)  \n#define K210_PC_PU\t\tBIT(16)  \n#define K210_PC_PD\t\tBIT(17)  \n \n#define K210_PC_SL\t\tBIT(19)  \n \n#define K210_PC_IE\t\tBIT(20)  \n#define K210_PC_IE_INV\t\tBIT(21)  \n#define K210_PC_DI_INV\t\tBIT(22)  \n#define K210_PC_ST\t\tBIT(23)  \n#define K210_PC_DI\t\tBIT(31)  \n\n#define K210_PC_BIAS_MASK\t(K210_PC_PU & K210_PC_PD)\n\n#define K210_PC_MODE_IN\t\t(K210_PC_IE | K210_PC_ST)\n#define K210_PC_MODE_OUT\t(K210_PC_DRIVE_7 | K210_PC_OE)\n#define K210_PC_MODE_I2C\t(K210_PC_MODE_IN | K210_PC_SL | \\\n\t\t\t\t K210_PC_OE | K210_PC_PU)\n#define K210_PC_MODE_SCCB\t(K210_PC_MODE_I2C | \\\n\t\t\t\t K210_PC_OE_INV | K210_PC_IE_INV)\n#define K210_PC_MODE_SPI\t(K210_PC_MODE_IN | K210_PC_IE_INV | \\\n\t\t\t\t K210_PC_MODE_OUT | K210_PC_OE_INV)\n#define K210_PC_MODE_GPIO\t(K210_PC_MODE_IN | K210_PC_MODE_OUT)\n\n#define K210_PG_FUNC\t\tGENMASK(7, 0)\n#define K210_PG_DO\t\tBIT(8)\n#define K210_PG_PIN\t\tGENMASK(22, 16)\n\n \nstruct k210_fpioa {\n\tu32 pins[48];\n\tu32 tie_en[8];\n\tu32 tie_val[8];\n};\n\nstruct k210_fpioa_data {\n\n\tstruct device *dev;\n\tstruct pinctrl_dev *pctl;\n\n\tstruct k210_fpioa __iomem *fpioa;\n\tstruct regmap *sysctl_map;\n\tu32 power_offset;\n\tstruct clk *clk;\n\tstruct clk *pclk;\n};\n\n#define K210_PIN_NAME(i)\t(\"IO_\" #i)\n#define K210_PIN(i)\t\t[(i)] = PINCTRL_PIN((i), K210_PIN_NAME(i))\n\nstatic const struct pinctrl_pin_desc k210_pins[] = {\n\tK210_PIN(0),  K210_PIN(1),  K210_PIN(2),\n\tK210_PIN(3),  K210_PIN(4),  K210_PIN(5),\n\tK210_PIN(6),  K210_PIN(7),  K210_PIN(8),\n\tK210_PIN(9),  K210_PIN(10), K210_PIN(11),\n\tK210_PIN(12), K210_PIN(13), K210_PIN(14),\n\tK210_PIN(15), K210_PIN(16), K210_PIN(17),\n\tK210_PIN(18), K210_PIN(19), K210_PIN(20),\n\tK210_PIN(21), K210_PIN(22), K210_PIN(23),\n\tK210_PIN(24), K210_PIN(25), K210_PIN(26),\n\tK210_PIN(27), K210_PIN(28), K210_PIN(29),\n\tK210_PIN(30), K210_PIN(31), K210_PIN(32),\n\tK210_PIN(33), K210_PIN(34), K210_PIN(35),\n\tK210_PIN(36), K210_PIN(37), K210_PIN(38),\n\tK210_PIN(39), K210_PIN(40), K210_PIN(41),\n\tK210_PIN(42), K210_PIN(43), K210_PIN(44),\n\tK210_PIN(45), K210_PIN(46), K210_PIN(47)\n};\n\n#define K210_NPINS ARRAY_SIZE(k210_pins)\n\n \nstatic const char *const k210_group_names[] = {\n\t \n\tK210_PIN_NAME(0),  K210_PIN_NAME(1),  K210_PIN_NAME(2),\n\tK210_PIN_NAME(3),  K210_PIN_NAME(4),  K210_PIN_NAME(5),\n\tK210_PIN_NAME(6),  K210_PIN_NAME(7),  K210_PIN_NAME(8),\n\tK210_PIN_NAME(9),  K210_PIN_NAME(10), K210_PIN_NAME(11),\n\tK210_PIN_NAME(12), K210_PIN_NAME(13), K210_PIN_NAME(14),\n\tK210_PIN_NAME(15), K210_PIN_NAME(16), K210_PIN_NAME(17),\n\tK210_PIN_NAME(18), K210_PIN_NAME(19), K210_PIN_NAME(20),\n\tK210_PIN_NAME(21), K210_PIN_NAME(22), K210_PIN_NAME(23),\n\tK210_PIN_NAME(24), K210_PIN_NAME(25), K210_PIN_NAME(26),\n\tK210_PIN_NAME(27), K210_PIN_NAME(28), K210_PIN_NAME(29),\n\tK210_PIN_NAME(30), K210_PIN_NAME(31), K210_PIN_NAME(32),\n\tK210_PIN_NAME(33), K210_PIN_NAME(34), K210_PIN_NAME(35),\n\tK210_PIN_NAME(36), K210_PIN_NAME(37), K210_PIN_NAME(38),\n\tK210_PIN_NAME(39), K210_PIN_NAME(40), K210_PIN_NAME(41),\n\tK210_PIN_NAME(42), K210_PIN_NAME(43), K210_PIN_NAME(44),\n\tK210_PIN_NAME(45), K210_PIN_NAME(46), K210_PIN_NAME(47),\n\t[48] = \"A0\", [49] = \"A1\", [50] = \"A2\",\n\t[51] = \"B3\", [52] = \"B4\", [53] = \"B5\",\n\t[54] = \"C6\", [55] = \"C7\"\n};\n\n#define K210_NGROUPS\tARRAY_SIZE(k210_group_names)\n\nenum k210_pinctrl_mode_id {\n\tK210_PC_DEFAULT_DISABLED,\n\tK210_PC_DEFAULT_IN,\n\tK210_PC_DEFAULT_IN_TIE,\n\tK210_PC_DEFAULT_OUT,\n\tK210_PC_DEFAULT_I2C,\n\tK210_PC_DEFAULT_SCCB,\n\tK210_PC_DEFAULT_SPI,\n\tK210_PC_DEFAULT_GPIO,\n\tK210_PC_DEFAULT_INT13,\n};\n\n#define K210_PC_DEFAULT(mode) \\\n\t[K210_PC_DEFAULT_##mode] = K210_PC_MODE_##mode\n\nstatic const u32 k210_pinconf_mode_id_to_mode[] = {\n\t[K210_PC_DEFAULT_DISABLED] = 0,\n\tK210_PC_DEFAULT(IN),\n\t[K210_PC_DEFAULT_IN_TIE] = K210_PC_MODE_IN,\n\tK210_PC_DEFAULT(OUT),\n\tK210_PC_DEFAULT(I2C),\n\tK210_PC_DEFAULT(SCCB),\n\tK210_PC_DEFAULT(SPI),\n\tK210_PC_DEFAULT(GPIO),\n\t[K210_PC_DEFAULT_INT13] = K210_PC_MODE_IN | K210_PC_PU,\n};\n\n#undef DEFAULT\n\n \nstruct k210_pcf_info {\n\tchar name[15];\n\tu8 mode_id;\n};\n\n#define K210_FUNC(id, mode)\t\t\t\t\\\n\t[K210_PCF_##id] = {\t\t\t\t\\\n\t\t.name = #id,\t\t\t\t\\\n\t\t.mode_id = K210_PC_DEFAULT_##mode\t\\\n\t}\n\nstatic const struct k210_pcf_info k210_pcf_infos[] = {\n\tK210_FUNC(JTAG_TCLK,\t\tIN),\n\tK210_FUNC(JTAG_TDI,\t\tIN),\n\tK210_FUNC(JTAG_TMS,\t\tIN),\n\tK210_FUNC(JTAG_TDO,\t\tOUT),\n\tK210_FUNC(SPI0_D0,\t\tSPI),\n\tK210_FUNC(SPI0_D1,\t\tSPI),\n\tK210_FUNC(SPI0_D2,\t\tSPI),\n\tK210_FUNC(SPI0_D3,\t\tSPI),\n\tK210_FUNC(SPI0_D4,\t\tSPI),\n\tK210_FUNC(SPI0_D5,\t\tSPI),\n\tK210_FUNC(SPI0_D6,\t\tSPI),\n\tK210_FUNC(SPI0_D7,\t\tSPI),\n\tK210_FUNC(SPI0_SS0,\t\tOUT),\n\tK210_FUNC(SPI0_SS1,\t\tOUT),\n\tK210_FUNC(SPI0_SS2,\t\tOUT),\n\tK210_FUNC(SPI0_SS3,\t\tOUT),\n\tK210_FUNC(SPI0_ARB,\t\tIN_TIE),\n\tK210_FUNC(SPI0_SCLK,\t\tOUT),\n\tK210_FUNC(UARTHS_RX,\t\tIN),\n\tK210_FUNC(UARTHS_TX,\t\tOUT),\n\tK210_FUNC(RESV6,\t\tIN),\n\tK210_FUNC(RESV7,\t\tIN),\n\tK210_FUNC(CLK_SPI1,\t\tOUT),\n\tK210_FUNC(CLK_I2C1,\t\tOUT),\n\tK210_FUNC(GPIOHS0,\t\tGPIO),\n\tK210_FUNC(GPIOHS1,\t\tGPIO),\n\tK210_FUNC(GPIOHS2,\t\tGPIO),\n\tK210_FUNC(GPIOHS3,\t\tGPIO),\n\tK210_FUNC(GPIOHS4,\t\tGPIO),\n\tK210_FUNC(GPIOHS5,\t\tGPIO),\n\tK210_FUNC(GPIOHS6,\t\tGPIO),\n\tK210_FUNC(GPIOHS7,\t\tGPIO),\n\tK210_FUNC(GPIOHS8,\t\tGPIO),\n\tK210_FUNC(GPIOHS9,\t\tGPIO),\n\tK210_FUNC(GPIOHS10,\t\tGPIO),\n\tK210_FUNC(GPIOHS11,\t\tGPIO),\n\tK210_FUNC(GPIOHS12,\t\tGPIO),\n\tK210_FUNC(GPIOHS13,\t\tGPIO),\n\tK210_FUNC(GPIOHS14,\t\tGPIO),\n\tK210_FUNC(GPIOHS15,\t\tGPIO),\n\tK210_FUNC(GPIOHS16,\t\tGPIO),\n\tK210_FUNC(GPIOHS17,\t\tGPIO),\n\tK210_FUNC(GPIOHS18,\t\tGPIO),\n\tK210_FUNC(GPIOHS19,\t\tGPIO),\n\tK210_FUNC(GPIOHS20,\t\tGPIO),\n\tK210_FUNC(GPIOHS21,\t\tGPIO),\n\tK210_FUNC(GPIOHS22,\t\tGPIO),\n\tK210_FUNC(GPIOHS23,\t\tGPIO),\n\tK210_FUNC(GPIOHS24,\t\tGPIO),\n\tK210_FUNC(GPIOHS25,\t\tGPIO),\n\tK210_FUNC(GPIOHS26,\t\tGPIO),\n\tK210_FUNC(GPIOHS27,\t\tGPIO),\n\tK210_FUNC(GPIOHS28,\t\tGPIO),\n\tK210_FUNC(GPIOHS29,\t\tGPIO),\n\tK210_FUNC(GPIOHS30,\t\tGPIO),\n\tK210_FUNC(GPIOHS31,\t\tGPIO),\n\tK210_FUNC(GPIO0,\t\tGPIO),\n\tK210_FUNC(GPIO1,\t\tGPIO),\n\tK210_FUNC(GPIO2,\t\tGPIO),\n\tK210_FUNC(GPIO3,\t\tGPIO),\n\tK210_FUNC(GPIO4,\t\tGPIO),\n\tK210_FUNC(GPIO5,\t\tGPIO),\n\tK210_FUNC(GPIO6,\t\tGPIO),\n\tK210_FUNC(GPIO7,\t\tGPIO),\n\tK210_FUNC(UART1_RX,\t\tIN),\n\tK210_FUNC(UART1_TX,\t\tOUT),\n\tK210_FUNC(UART2_RX,\t\tIN),\n\tK210_FUNC(UART2_TX,\t\tOUT),\n\tK210_FUNC(UART3_RX,\t\tIN),\n\tK210_FUNC(UART3_TX,\t\tOUT),\n\tK210_FUNC(SPI1_D0,\t\tSPI),\n\tK210_FUNC(SPI1_D1,\t\tSPI),\n\tK210_FUNC(SPI1_D2,\t\tSPI),\n\tK210_FUNC(SPI1_D3,\t\tSPI),\n\tK210_FUNC(SPI1_D4,\t\tSPI),\n\tK210_FUNC(SPI1_D5,\t\tSPI),\n\tK210_FUNC(SPI1_D6,\t\tSPI),\n\tK210_FUNC(SPI1_D7,\t\tSPI),\n\tK210_FUNC(SPI1_SS0,\t\tOUT),\n\tK210_FUNC(SPI1_SS1,\t\tOUT),\n\tK210_FUNC(SPI1_SS2,\t\tOUT),\n\tK210_FUNC(SPI1_SS3,\t\tOUT),\n\tK210_FUNC(SPI1_ARB,\t\tIN_TIE),\n\tK210_FUNC(SPI1_SCLK,\t\tOUT),\n\tK210_FUNC(SPI2_D0,\t\tSPI),\n\tK210_FUNC(SPI2_SS,\t\tIN),\n\tK210_FUNC(SPI2_SCLK,\t\tIN),\n\tK210_FUNC(I2S0_MCLK,\t\tOUT),\n\tK210_FUNC(I2S0_SCLK,\t\tOUT),\n\tK210_FUNC(I2S0_WS,\t\tOUT),\n\tK210_FUNC(I2S0_IN_D0,\t\tIN),\n\tK210_FUNC(I2S0_IN_D1,\t\tIN),\n\tK210_FUNC(I2S0_IN_D2,\t\tIN),\n\tK210_FUNC(I2S0_IN_D3,\t\tIN),\n\tK210_FUNC(I2S0_OUT_D0,\t\tOUT),\n\tK210_FUNC(I2S0_OUT_D1,\t\tOUT),\n\tK210_FUNC(I2S0_OUT_D2,\t\tOUT),\n\tK210_FUNC(I2S0_OUT_D3,\t\tOUT),\n\tK210_FUNC(I2S1_MCLK,\t\tOUT),\n\tK210_FUNC(I2S1_SCLK,\t\tOUT),\n\tK210_FUNC(I2S1_WS,\t\tOUT),\n\tK210_FUNC(I2S1_IN_D0,\t\tIN),\n\tK210_FUNC(I2S1_IN_D1,\t\tIN),\n\tK210_FUNC(I2S1_IN_D2,\t\tIN),\n\tK210_FUNC(I2S1_IN_D3,\t\tIN),\n\tK210_FUNC(I2S1_OUT_D0,\t\tOUT),\n\tK210_FUNC(I2S1_OUT_D1,\t\tOUT),\n\tK210_FUNC(I2S1_OUT_D2,\t\tOUT),\n\tK210_FUNC(I2S1_OUT_D3,\t\tOUT),\n\tK210_FUNC(I2S2_MCLK,\t\tOUT),\n\tK210_FUNC(I2S2_SCLK,\t\tOUT),\n\tK210_FUNC(I2S2_WS,\t\tOUT),\n\tK210_FUNC(I2S2_IN_D0,\t\tIN),\n\tK210_FUNC(I2S2_IN_D1,\t\tIN),\n\tK210_FUNC(I2S2_IN_D2,\t\tIN),\n\tK210_FUNC(I2S2_IN_D3,\t\tIN),\n\tK210_FUNC(I2S2_OUT_D0,\t\tOUT),\n\tK210_FUNC(I2S2_OUT_D1,\t\tOUT),\n\tK210_FUNC(I2S2_OUT_D2,\t\tOUT),\n\tK210_FUNC(I2S2_OUT_D3,\t\tOUT),\n\tK210_FUNC(RESV0,\t\tDISABLED),\n\tK210_FUNC(RESV1,\t\tDISABLED),\n\tK210_FUNC(RESV2,\t\tDISABLED),\n\tK210_FUNC(RESV3,\t\tDISABLED),\n\tK210_FUNC(RESV4,\t\tDISABLED),\n\tK210_FUNC(RESV5,\t\tDISABLED),\n\tK210_FUNC(I2C0_SCLK,\t\tI2C),\n\tK210_FUNC(I2C0_SDA,\t\tI2C),\n\tK210_FUNC(I2C1_SCLK,\t\tI2C),\n\tK210_FUNC(I2C1_SDA,\t\tI2C),\n\tK210_FUNC(I2C2_SCLK,\t\tI2C),\n\tK210_FUNC(I2C2_SDA,\t\tI2C),\n\tK210_FUNC(DVP_XCLK,\t\tOUT),\n\tK210_FUNC(DVP_RST,\t\tOUT),\n\tK210_FUNC(DVP_PWDN,\t\tOUT),\n\tK210_FUNC(DVP_VSYNC,\t\tIN),\n\tK210_FUNC(DVP_HSYNC,\t\tIN),\n\tK210_FUNC(DVP_PCLK,\t\tIN),\n\tK210_FUNC(DVP_D0,\t\tIN),\n\tK210_FUNC(DVP_D1,\t\tIN),\n\tK210_FUNC(DVP_D2,\t\tIN),\n\tK210_FUNC(DVP_D3,\t\tIN),\n\tK210_FUNC(DVP_D4,\t\tIN),\n\tK210_FUNC(DVP_D5,\t\tIN),\n\tK210_FUNC(DVP_D6,\t\tIN),\n\tK210_FUNC(DVP_D7,\t\tIN),\n\tK210_FUNC(SCCB_SCLK,\t\tSCCB),\n\tK210_FUNC(SCCB_SDA,\t\tSCCB),\n\tK210_FUNC(UART1_CTS,\t\tIN),\n\tK210_FUNC(UART1_DSR,\t\tIN),\n\tK210_FUNC(UART1_DCD,\t\tIN),\n\tK210_FUNC(UART1_RI,\t\tIN),\n\tK210_FUNC(UART1_SIR_IN,\t\tIN),\n\tK210_FUNC(UART1_DTR,\t\tOUT),\n\tK210_FUNC(UART1_RTS,\t\tOUT),\n\tK210_FUNC(UART1_OUT2,\t\tOUT),\n\tK210_FUNC(UART1_OUT1,\t\tOUT),\n\tK210_FUNC(UART1_SIR_OUT,\tOUT),\n\tK210_FUNC(UART1_BAUD,\t\tOUT),\n\tK210_FUNC(UART1_RE,\t\tOUT),\n\tK210_FUNC(UART1_DE,\t\tOUT),\n\tK210_FUNC(UART1_RS485_EN,\tOUT),\n\tK210_FUNC(UART2_CTS,\t\tIN),\n\tK210_FUNC(UART2_DSR,\t\tIN),\n\tK210_FUNC(UART2_DCD,\t\tIN),\n\tK210_FUNC(UART2_RI,\t\tIN),\n\tK210_FUNC(UART2_SIR_IN,\t\tIN),\n\tK210_FUNC(UART2_DTR,\t\tOUT),\n\tK210_FUNC(UART2_RTS,\t\tOUT),\n\tK210_FUNC(UART2_OUT2,\t\tOUT),\n\tK210_FUNC(UART2_OUT1,\t\tOUT),\n\tK210_FUNC(UART2_SIR_OUT,\tOUT),\n\tK210_FUNC(UART2_BAUD,\t\tOUT),\n\tK210_FUNC(UART2_RE,\t\tOUT),\n\tK210_FUNC(UART2_DE,\t\tOUT),\n\tK210_FUNC(UART2_RS485_EN,\tOUT),\n\tK210_FUNC(UART3_CTS,\t\tIN),\n\tK210_FUNC(UART3_DSR,\t\tIN),\n\tK210_FUNC(UART3_DCD,\t\tIN),\n\tK210_FUNC(UART3_RI,\t\tIN),\n\tK210_FUNC(UART3_SIR_IN,\t\tIN),\n\tK210_FUNC(UART3_DTR,\t\tOUT),\n\tK210_FUNC(UART3_RTS,\t\tOUT),\n\tK210_FUNC(UART3_OUT2,\t\tOUT),\n\tK210_FUNC(UART3_OUT1,\t\tOUT),\n\tK210_FUNC(UART3_SIR_OUT,\tOUT),\n\tK210_FUNC(UART3_BAUD,\t\tOUT),\n\tK210_FUNC(UART3_RE,\t\tOUT),\n\tK210_FUNC(UART3_DE,\t\tOUT),\n\tK210_FUNC(UART3_RS485_EN,\tOUT),\n\tK210_FUNC(TIMER0_TOGGLE1,\tOUT),\n\tK210_FUNC(TIMER0_TOGGLE2,\tOUT),\n\tK210_FUNC(TIMER0_TOGGLE3,\tOUT),\n\tK210_FUNC(TIMER0_TOGGLE4,\tOUT),\n\tK210_FUNC(TIMER1_TOGGLE1,\tOUT),\n\tK210_FUNC(TIMER1_TOGGLE2,\tOUT),\n\tK210_FUNC(TIMER1_TOGGLE3,\tOUT),\n\tK210_FUNC(TIMER1_TOGGLE4,\tOUT),\n\tK210_FUNC(TIMER2_TOGGLE1,\tOUT),\n\tK210_FUNC(TIMER2_TOGGLE2,\tOUT),\n\tK210_FUNC(TIMER2_TOGGLE3,\tOUT),\n\tK210_FUNC(TIMER2_TOGGLE4,\tOUT),\n\tK210_FUNC(CLK_SPI2,\t\tOUT),\n\tK210_FUNC(CLK_I2C2,\t\tOUT),\n\tK210_FUNC(INTERNAL0,\t\tOUT),\n\tK210_FUNC(INTERNAL1,\t\tOUT),\n\tK210_FUNC(INTERNAL2,\t\tOUT),\n\tK210_FUNC(INTERNAL3,\t\tOUT),\n\tK210_FUNC(INTERNAL4,\t\tOUT),\n\tK210_FUNC(INTERNAL5,\t\tOUT),\n\tK210_FUNC(INTERNAL6,\t\tOUT),\n\tK210_FUNC(INTERNAL7,\t\tOUT),\n\tK210_FUNC(INTERNAL8,\t\tOUT),\n\tK210_FUNC(INTERNAL9,\t\tIN),\n\tK210_FUNC(INTERNAL10,\t\tIN),\n\tK210_FUNC(INTERNAL11,\t\tIN),\n\tK210_FUNC(INTERNAL12,\t\tIN),\n\tK210_FUNC(INTERNAL13,\t\tINT13),\n\tK210_FUNC(INTERNAL14,\t\tI2C),\n\tK210_FUNC(INTERNAL15,\t\tIN),\n\tK210_FUNC(INTERNAL16,\t\tIN),\n\tK210_FUNC(INTERNAL17,\t\tIN),\n\tK210_FUNC(CONSTANT,\t\tDISABLED),\n\tK210_FUNC(INTERNAL18,\t\tIN),\n\tK210_FUNC(DEBUG0,\t\tOUT),\n\tK210_FUNC(DEBUG1,\t\tOUT),\n\tK210_FUNC(DEBUG2,\t\tOUT),\n\tK210_FUNC(DEBUG3,\t\tOUT),\n\tK210_FUNC(DEBUG4,\t\tOUT),\n\tK210_FUNC(DEBUG5,\t\tOUT),\n\tK210_FUNC(DEBUG6,\t\tOUT),\n\tK210_FUNC(DEBUG7,\t\tOUT),\n\tK210_FUNC(DEBUG8,\t\tOUT),\n\tK210_FUNC(DEBUG9,\t\tOUT),\n\tK210_FUNC(DEBUG10,\t\tOUT),\n\tK210_FUNC(DEBUG11,\t\tOUT),\n\tK210_FUNC(DEBUG12,\t\tOUT),\n\tK210_FUNC(DEBUG13,\t\tOUT),\n\tK210_FUNC(DEBUG14,\t\tOUT),\n\tK210_FUNC(DEBUG15,\t\tOUT),\n\tK210_FUNC(DEBUG16,\t\tOUT),\n\tK210_FUNC(DEBUG17,\t\tOUT),\n\tK210_FUNC(DEBUG18,\t\tOUT),\n\tK210_FUNC(DEBUG19,\t\tOUT),\n\tK210_FUNC(DEBUG20,\t\tOUT),\n\tK210_FUNC(DEBUG21,\t\tOUT),\n\tK210_FUNC(DEBUG22,\t\tOUT),\n\tK210_FUNC(DEBUG23,\t\tOUT),\n\tK210_FUNC(DEBUG24,\t\tOUT),\n\tK210_FUNC(DEBUG25,\t\tOUT),\n\tK210_FUNC(DEBUG26,\t\tOUT),\n\tK210_FUNC(DEBUG27,\t\tOUT),\n\tK210_FUNC(DEBUG28,\t\tOUT),\n\tK210_FUNC(DEBUG29,\t\tOUT),\n\tK210_FUNC(DEBUG30,\t\tOUT),\n\tK210_FUNC(DEBUG31,\t\tOUT),\n};\n\n#define PIN_CONFIG_OUTPUT_INVERT\t(PIN_CONFIG_END + 1)\n#define PIN_CONFIG_INPUT_INVERT\t\t(PIN_CONFIG_END + 2)\n\nstatic const struct pinconf_generic_params k210_pinconf_custom_params[] = {\n\t{ \"output-polarity-invert\", PIN_CONFIG_OUTPUT_INVERT, 1 },\n\t{ \"input-polarity-invert\",  PIN_CONFIG_INPUT_INVERT, 1 },\n};\n\n \nstatic const int k210_pinconf_drive_strength[] = {\n\t[0] = 11200,\n\t[1] = 16800,\n\t[2] = 22300,\n\t[3] = 27800,\n\t[4] = 33300,\n\t[5] = 38700,\n\t[6] = 44100,\n\t[7] = 49500,\n};\n\nstatic int k210_pinconf_get_drive(unsigned int max_strength_ua)\n{\n\tint i;\n\n\tfor (i = K210_PC_DRIVE_MAX; i >= 0; i--) {\n\t\tif (k210_pinconf_drive_strength[i] <= max_strength_ua)\n\t\t\treturn i;\n\t}\n\n\treturn -EINVAL;\n}\n\nstatic void k210_pinmux_set_pin_function(struct pinctrl_dev *pctldev,\n\t\t\t\t\t u32 pin, u32 func)\n{\n\tstruct k210_fpioa_data *pdata = pinctrl_dev_get_drvdata(pctldev);\n\tconst struct k210_pcf_info *info = &k210_pcf_infos[func];\n\tu32 mode = k210_pinconf_mode_id_to_mode[info->mode_id];\n\tu32 val = func | mode;\n\n\tdev_dbg(pdata->dev, \"set pin %u function %s (%u) -> 0x%08x\\n\",\n\t\tpin, info->name, func, val);\n\n\twritel(val, &pdata->fpioa->pins[pin]);\n}\n\nstatic int k210_pinconf_set_param(struct pinctrl_dev *pctldev,\n\t\t\t\t  unsigned int pin,\n\t\t\t\t  unsigned int param, unsigned int arg)\n{\n\tstruct k210_fpioa_data *pdata = pinctrl_dev_get_drvdata(pctldev);\n\tu32 val = readl(&pdata->fpioa->pins[pin]);\n\tint drive;\n\n\tdev_dbg(pdata->dev, \"set pin %u param %u, arg 0x%x\\n\",\n\t\tpin, param, arg);\n\n\tswitch (param) {\n\tcase PIN_CONFIG_BIAS_DISABLE:\n\t\tval &= ~K210_PC_BIAS_MASK;\n\t\tbreak;\n\tcase PIN_CONFIG_BIAS_PULL_DOWN:\n\t\tif (!arg)\n\t\t\treturn -EINVAL;\n\t\tval |= K210_PC_PD;\n\t\tbreak;\n\tcase PIN_CONFIG_BIAS_PULL_UP:\n\t\tif (!arg)\n\t\t\treturn -EINVAL;\n\t\tval |= K210_PC_PU;\n\t\tbreak;\n\tcase PIN_CONFIG_DRIVE_STRENGTH:\n\t\targ *= 1000;\n\t\tfallthrough;\n\tcase PIN_CONFIG_DRIVE_STRENGTH_UA:\n\t\tdrive = k210_pinconf_get_drive(arg);\n\t\tif (drive < 0)\n\t\t\treturn drive;\n\t\tval &= ~K210_PC_DRIVE_MASK;\n\t\tval |= FIELD_PREP(K210_PC_DRIVE_MASK, drive);\n\t\tbreak;\n\tcase PIN_CONFIG_INPUT_ENABLE:\n\t\tif (arg)\n\t\t\tval |= K210_PC_IE;\n\t\telse\n\t\t\tval &= ~K210_PC_IE;\n\t\tbreak;\n\tcase PIN_CONFIG_INPUT_SCHMITT_ENABLE:\n\t\tif (arg)\n\t\t\tval |= K210_PC_ST;\n\t\telse\n\t\t\tval &= ~K210_PC_ST;\n\t\tbreak;\n\tcase PIN_CONFIG_OUTPUT:\n\t\tk210_pinmux_set_pin_function(pctldev, pin, K210_PCF_CONSTANT);\n\t\tval = readl(&pdata->fpioa->pins[pin]);\n\t\tval |= K210_PC_MODE_OUT;\n\t\tif (!arg)\n\t\t\tval |= K210_PC_DO_INV;\n\t\tbreak;\n\tcase PIN_CONFIG_OUTPUT_ENABLE:\n\t\tif (arg)\n\t\t\tval |= K210_PC_OE;\n\t\telse\n\t\t\tval &= ~K210_PC_OE;\n\t\tbreak;\n\tcase PIN_CONFIG_SLEW_RATE:\n\t\tif (arg)\n\t\t\tval |= K210_PC_SL;\n\t\telse\n\t\t\tval &= ~K210_PC_SL;\n\t\tbreak;\n\tcase PIN_CONFIG_OUTPUT_INVERT:\n\t\tif (arg)\n\t\t\tval |= K210_PC_DO_INV;\n\t\telse\n\t\t\tval &= ~K210_PC_DO_INV;\n\t\tbreak;\n\tcase PIN_CONFIG_INPUT_INVERT:\n\t\tif (arg)\n\t\t\tval |= K210_PC_DI_INV;\n\t\telse\n\t\t\tval &= ~K210_PC_DI_INV;\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\twritel(val, &pdata->fpioa->pins[pin]);\n\n\treturn 0;\n}\n\nstatic int k210_pinconf_set(struct pinctrl_dev *pctldev, unsigned int pin,\n\t\t\t    unsigned long *configs, unsigned int num_configs)\n{\n\tunsigned int param, arg;\n\tint i, ret;\n\n\tif (WARN_ON(pin >= K210_NPINS))\n\t\treturn -EINVAL;\n\n\tfor (i = 0; i < num_configs; i++) {\n\t\tparam = pinconf_to_config_param(configs[i]);\n\t\targ = pinconf_to_config_argument(configs[i]);\n\t\tret = k210_pinconf_set_param(pctldev, pin, param, arg);\n\t\tif (ret)\n\t\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic void k210_pinconf_dbg_show(struct pinctrl_dev *pctldev,\n\t\t\t\t  struct seq_file *s, unsigned int pin)\n{\n\tstruct k210_fpioa_data *pdata = pinctrl_dev_get_drvdata(pctldev);\n\n\tseq_printf(s, \"%#x\", readl(&pdata->fpioa->pins[pin]));\n}\n\nstatic int k210_pinconf_group_set(struct pinctrl_dev *pctldev,\n\t\t\t\t  unsigned int selector, unsigned long *configs,\n\t\t\t\t  unsigned int num_configs)\n{\n\tstruct k210_fpioa_data *pdata = pinctrl_dev_get_drvdata(pctldev);\n\tunsigned int param, arg;\n\tu32 bit;\n\tint i;\n\n\t \n\tif (selector < K210_NPINS)\n\t\treturn -EINVAL;\n\n\t \n\tfor (i = 0; i < num_configs; i++) {\n\t\tparam = pinconf_to_config_param(configs[i]);\n\t\tif (param != PIN_CONFIG_POWER_SOURCE)\n\t\t\treturn -EINVAL;\n\n\t\targ = pinconf_to_config_argument(configs[i]);\n\t\tbit = BIT(selector - K210_NPINS);\n\t\tregmap_update_bits(pdata->sysctl_map,\n\t\t\t\t   pdata->power_offset,\n\t\t\t\t   bit, arg ? bit : 0);\n\t}\n\n\treturn 0;\n}\n\nstatic void k210_pinconf_group_dbg_show(struct pinctrl_dev *pctldev,\n\t\t\t\t\tstruct seq_file *s,\n\t\t\t\t\tunsigned int selector)\n{\n\tstruct k210_fpioa_data *pdata = pinctrl_dev_get_drvdata(pctldev);\n\tint ret;\n\tu32 val;\n\n\tif (selector < K210_NPINS)\n\t\treturn k210_pinconf_dbg_show(pctldev, s, selector);\n\n\tret = regmap_read(pdata->sysctl_map, pdata->power_offset, &val);\n\tif (ret) {\n\t\tdev_err(pdata->dev, \"Failed to read power reg\\n\");\n\t\treturn;\n\t}\n\n\tseq_printf(s, \"%s: %s V\", k210_group_names[selector],\n\t\t   val & BIT(selector - K210_NPINS) ? \"1.8\" : \"3.3\");\n}\n\nstatic const struct pinconf_ops k210_pinconf_ops = {\n\t.is_generic = true,\n\t.pin_config_set = k210_pinconf_set,\n\t.pin_config_group_set = k210_pinconf_group_set,\n\t.pin_config_dbg_show = k210_pinconf_dbg_show,\n\t.pin_config_group_dbg_show = k210_pinconf_group_dbg_show,\n};\n\nstatic int k210_pinmux_get_function_count(struct pinctrl_dev *pctldev)\n{\n\treturn ARRAY_SIZE(k210_pcf_infos);\n}\n\nstatic const char *k210_pinmux_get_function_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t\t unsigned int selector)\n{\n\treturn k210_pcf_infos[selector].name;\n}\n\nstatic int k210_pinmux_get_function_groups(struct pinctrl_dev *pctldev,\n\t\t\t\t\t   unsigned int selector,\n\t\t\t\t\t   const char * const **groups,\n\t\t\t\t\t   unsigned int * const num_groups)\n{\n\t \n\t*groups = k210_group_names;\n\t*num_groups = K210_NPINS;\n\n\treturn 0;\n}\n\nstatic int k210_pinmux_set_mux(struct pinctrl_dev *pctldev,\n\t\t\t       unsigned int function,\n\t\t\t       unsigned int group)\n{\n\t \n\tif (group >= K210_NPINS)\n\t\treturn -EINVAL;\n\n\tk210_pinmux_set_pin_function(pctldev, group, function);\n\n\treturn 0;\n}\n\nstatic const struct pinmux_ops k210_pinmux_ops = {\n\t.get_functions_count = k210_pinmux_get_function_count,\n\t.get_function_name = k210_pinmux_get_function_name,\n\t.get_function_groups = k210_pinmux_get_function_groups,\n\t.set_mux = k210_pinmux_set_mux,\n\t.strict = true,\n};\n\nstatic int k210_pinctrl_get_groups_count(struct pinctrl_dev *pctldev)\n{\n\treturn K210_NGROUPS;\n}\n\nstatic const char *k210_pinctrl_get_group_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t       unsigned int group)\n{\n\treturn k210_group_names[group];\n}\n\nstatic int k210_pinctrl_get_group_pins(struct pinctrl_dev *pctldev,\n\t\t\t\t       unsigned int group,\n\t\t\t\t       const unsigned int **pins,\n\t\t\t\t       unsigned int *npins)\n{\n\tif (group >= K210_NPINS) {\n\t\t*pins = NULL;\n\t\t*npins = 0;\n\t\treturn 0;\n\t}\n\n\t*pins = &k210_pins[group].number;\n\t*npins = 1;\n\n\treturn 0;\n}\n\nstatic void k210_pinctrl_pin_dbg_show(struct pinctrl_dev *pctldev,\n\t\t\t\t      struct seq_file *s, unsigned int offset)\n{\n\tseq_printf(s, \"%s\", dev_name(pctldev->dev));\n}\n\nstatic int k210_pinctrl_dt_subnode_to_map(struct pinctrl_dev *pctldev,\n\t\t\t\t\t  struct device_node *np,\n\t\t\t\t\t  struct pinctrl_map **map,\n\t\t\t\t\t  unsigned int *reserved_maps,\n\t\t\t\t\t  unsigned int *num_maps)\n{\n\tstruct property *prop;\n\tconst __be32 *p;\n\tint ret, pinmux_groups;\n\tu32 pinmux_group;\n\tunsigned long *configs = NULL;\n\tunsigned int num_configs = 0;\n\tunsigned int reserve = 0;\n\n\tret = of_property_count_strings(np, \"groups\");\n\tif (!ret)\n\t\treturn pinconf_generic_dt_subnode_to_map(pctldev, np, map,\n\t\t\t\t\t\treserved_maps, num_maps,\n\t\t\t\t\t\tPIN_MAP_TYPE_CONFIGS_GROUP);\n\n\tpinmux_groups = of_property_count_u32_elems(np, \"pinmux\");\n\tif (pinmux_groups <= 0) {\n\t\t \n\t\treturn 0;\n\t}\n\n\tret = pinconf_generic_parse_dt_config(np, pctldev, &configs,\n\t\t\t\t\t      &num_configs);\n\tif (ret < 0) {\n\t\tdev_err(pctldev->dev, \"%pOF: could not parse node property\\n\",\n\t\t\tnp);\n\t\treturn ret;\n\t}\n\n\treserve = pinmux_groups * (1 + num_configs);\n\tret = pinctrl_utils_reserve_map(pctldev, map, reserved_maps, num_maps,\n\t\t\t\t\treserve);\n\tif (ret < 0)\n\t\tgoto exit;\n\n\tof_property_for_each_u32(np, \"pinmux\", prop, p, pinmux_group) {\n\t\tconst char *group_name, *func_name;\n\t\tu32 pin = FIELD_GET(K210_PG_PIN, pinmux_group);\n\t\tu32 func = FIELD_GET(K210_PG_FUNC, pinmux_group);\n\n\t\tif (pin >= K210_NPINS) {\n\t\t\tret = -EINVAL;\n\t\t\tgoto exit;\n\t\t}\n\n\t\tgroup_name = k210_group_names[pin];\n\t\tfunc_name = k210_pcf_infos[func].name;\n\n\t\tdev_dbg(pctldev->dev, \"Pinmux %s: pin %u func %s\\n\",\n\t\t\tnp->name, pin, func_name);\n\n\t\tret = pinctrl_utils_add_map_mux(pctldev, map, reserved_maps,\n\t\t\t\t\t\tnum_maps, group_name,\n\t\t\t\t\t\tfunc_name);\n\t\tif (ret < 0) {\n\t\t\tdev_err(pctldev->dev, \"%pOF add mux map failed %d\\n\",\n\t\t\t\tnp, ret);\n\t\t\tgoto exit;\n\t\t}\n\n\t\tif (num_configs) {\n\t\t\tret = pinctrl_utils_add_map_configs(pctldev, map,\n\t\t\t\t\treserved_maps, num_maps, group_name,\n\t\t\t\t\tconfigs, num_configs,\n\t\t\t\t\tPIN_MAP_TYPE_CONFIGS_PIN);\n\t\t\tif (ret < 0) {\n\t\t\t\tdev_err(pctldev->dev,\n\t\t\t\t\t\"%pOF add configs map failed %d\\n\",\n\t\t\t\t\tnp, ret);\n\t\t\t\tgoto exit;\n\t\t\t}\n\t\t}\n\t}\n\n\tret = 0;\n\nexit:\n\tkfree(configs);\n\treturn ret;\n}\n\nstatic int k210_pinctrl_dt_node_to_map(struct pinctrl_dev *pctldev,\n\t\t\t\t       struct device_node *np_config,\n\t\t\t\t       struct pinctrl_map **map,\n\t\t\t\t       unsigned int *num_maps)\n{\n\tunsigned int reserved_maps;\n\tstruct device_node *np;\n\tint ret;\n\n\treserved_maps = 0;\n\t*map = NULL;\n\t*num_maps = 0;\n\n\tret = k210_pinctrl_dt_subnode_to_map(pctldev, np_config, map,\n\t\t\t\t\t     &reserved_maps, num_maps);\n\tif (ret < 0)\n\t\tgoto err;\n\n\tfor_each_available_child_of_node(np_config, np) {\n\t\tret = k210_pinctrl_dt_subnode_to_map(pctldev, np, map,\n\t\t\t\t\t\t     &reserved_maps, num_maps);\n\t\tif (ret < 0) {\n\t\t\tof_node_put(np);\n\t\t\tgoto err;\n\t\t}\n\t}\n\treturn 0;\n\nerr:\n\tpinctrl_utils_free_map(pctldev, *map, *num_maps);\n\treturn ret;\n}\n\n\nstatic const struct pinctrl_ops k210_pinctrl_ops = {\n\t.get_groups_count = k210_pinctrl_get_groups_count,\n\t.get_group_name = k210_pinctrl_get_group_name,\n\t.get_group_pins = k210_pinctrl_get_group_pins,\n\t.pin_dbg_show = k210_pinctrl_pin_dbg_show,\n\t.dt_node_to_map = k210_pinctrl_dt_node_to_map,\n\t.dt_free_map = pinconf_generic_dt_free_map,\n};\n\nstatic struct pinctrl_desc k210_pinctrl_desc = {\n\t.name = \"k210-pinctrl\",\n\t.pins = k210_pins,\n\t.npins = K210_NPINS,\n\t.pctlops = &k210_pinctrl_ops,\n\t.pmxops = &k210_pinmux_ops,\n\t.confops = &k210_pinconf_ops,\n\t.custom_params = k210_pinconf_custom_params,\n\t.num_custom_params = ARRAY_SIZE(k210_pinconf_custom_params),\n};\n\nstatic void k210_fpioa_init_ties(struct k210_fpioa_data *pdata)\n{\n\tstruct k210_fpioa __iomem *fpioa = pdata->fpioa;\n\tu32 val;\n\tint i, j;\n\n\tdev_dbg(pdata->dev, \"Init pin ties\\n\");\n\n\t \n\tfor (i = 0; i < ARRAY_SIZE(fpioa->tie_en); i++) {\n\t\tval = 0;\n\t\tfor (j = 0; j < 32; j++) {\n\t\t\tif (k210_pcf_infos[i * 32 + j].mode_id ==\n\t\t\t    K210_PC_DEFAULT_IN_TIE) {\n\t\t\t\tdev_dbg(pdata->dev,\n\t\t\t\t\t\"tie_en function %d (%s)\\n\",\n\t\t\t\t\ti * 32 + j,\n\t\t\t\t\tk210_pcf_infos[i * 32 + j].name);\n\t\t\t\tval |= BIT(j);\n\t\t\t}\n\t\t}\n\n\t\t \n\t\twritel(val, &fpioa->tie_val[i]);\n\t\twritel(val, &fpioa->tie_en[i]);\n\t}\n}\n\nstatic int k210_fpioa_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct device_node *np = dev->of_node;\n\tstruct k210_fpioa_data *pdata;\n\tint ret;\n\n\tdev_info(dev, \"K210 FPIOA pin controller\\n\");\n\n\tpdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\n\tif (!pdata)\n\t\treturn -ENOMEM;\n\n\tpdata->dev = dev;\n\tplatform_set_drvdata(pdev, pdata);\n\n\tpdata->fpioa = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(pdata->fpioa))\n\t\treturn PTR_ERR(pdata->fpioa);\n\n\tpdata->clk = devm_clk_get(dev, \"ref\");\n\tif (IS_ERR(pdata->clk))\n\t\treturn PTR_ERR(pdata->clk);\n\n\tret = clk_prepare_enable(pdata->clk);\n\tif (ret)\n\t\treturn ret;\n\n\tpdata->pclk = devm_clk_get_optional(dev, \"pclk\");\n\tif (!IS_ERR(pdata->pclk)) {\n\t\tret = clk_prepare_enable(pdata->pclk);\n\t\tif (ret)\n\t\t\tgoto disable_clk;\n\t}\n\n\tpdata->sysctl_map =\n\t\tsyscon_regmap_lookup_by_phandle_args(np,\n\t\t\t\t\t\t\"canaan,k210-sysctl-power\",\n\t\t\t\t\t\t1, &pdata->power_offset);\n\tif (IS_ERR(pdata->sysctl_map)) {\n\t\tret = PTR_ERR(pdata->sysctl_map);\n\t\tgoto disable_pclk;\n\t}\n\n\tk210_fpioa_init_ties(pdata);\n\n\tpdata->pctl = pinctrl_register(&k210_pinctrl_desc, dev, (void *)pdata);\n\tif (IS_ERR(pdata->pctl)) {\n\t\tret = PTR_ERR(pdata->pctl);\n\t\tgoto disable_pclk;\n\t}\n\n\treturn 0;\n\ndisable_pclk:\n\tclk_disable_unprepare(pdata->pclk);\ndisable_clk:\n\tclk_disable_unprepare(pdata->clk);\n\n\treturn ret;\n}\n\nstatic const struct of_device_id k210_fpioa_dt_ids[] = {\n\t{ .compatible = \"canaan,k210-fpioa\" },\n\t{   },\n};\n\nstatic struct platform_driver k210_fpioa_driver = {\n\t.probe\t= k210_fpioa_probe,\n\t.driver = {\n\t\t.name\t\t= \"k210-fpioa\",\n\t\t.of_match_table\t= k210_fpioa_dt_ids,\n\t},\n};\nbuiltin_platform_driver(k210_fpioa_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}