{
  "module_name": "pinctrl-loongson2.c",
  "hash_id": "3328ddfe3be8ddc474b52a513657d0b24252f6e410f86d26c9eec58456db800e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pinctrl/pinctrl-loongson2.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/mod_devicetable.h>\n#include <linux/pinctrl/pinmux.h>\n#include <linux/pinctrl/pinconf-generic.h>\n#include <linux/pinctrl/pinctrl.h>\n#include <linux/bitops.h>\n#include <linux/io.h>\n#include <linux/seq_file.h>\n\n#include \"core.h\"\n#include \"pinctrl-utils.h\"\n\n#define PMX_GROUP(name, offset, bitv)\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.grp = PINCTRL_PINGROUP((#name), (name ## _pins),\t\\\n\t\t\t\tARRAY_SIZE((name ## _pins))),\t\t\\\n\t\t.reg = offset,\t\t\t\t\t\t\\\n\t\t.bit = bitv,\t\t\t\t\t\t\\\n\t}\n\n#define SPECIFIC_GROUP(group)\t\t\t\t\t\t\\\n\tstatic const char * const group##_groups[] = {\t\t\t\\\n\t\t#group\t\t\t\t\t\t\t\\\n\t}\n\n#define FUNCTION(fn)\t\t\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.name = #fn,\t\t\t\t\t\t\\\n\t\t.groups = fn ## _groups,\t\t\t\t\\\n\t\t.num_groups = ARRAY_SIZE(fn ## _groups),\t\t\\\n\t}\n\nstruct loongson2_pinctrl {\n\tstruct device *dev;\n\tstruct pinctrl_dev *pcdev;\n\tstruct pinctrl_desc desc;\n\tstruct device_node *of_node;\n\tspinlock_t lock;\n\tvoid __iomem *reg_base;\n};\n\nstruct loongson2_pmx_group {\n\tstruct pingroup grp;\n\tunsigned int reg;\n\tunsigned int bit;\n};\n\nstruct loongson2_pmx_func {\n\tconst char *name;\n\tconst char * const *groups;\n\tunsigned int num_groups;\n};\n\n#define LOONGSON2_PIN(x) PINCTRL_PIN(x, \"gpio\"#x)\nstatic const struct pinctrl_pin_desc loongson2_pctrl_pins[] = {\n\tLOONGSON2_PIN(0),  LOONGSON2_PIN(1),  LOONGSON2_PIN(2),  LOONGSON2_PIN(3),\n\tLOONGSON2_PIN(4),  LOONGSON2_PIN(5),  LOONGSON2_PIN(6),  LOONGSON2_PIN(7),\n\tLOONGSON2_PIN(8),  LOONGSON2_PIN(9),  LOONGSON2_PIN(10), LOONGSON2_PIN(11),\n\tLOONGSON2_PIN(12), LOONGSON2_PIN(13), LOONGSON2_PIN(14),\n\tLOONGSON2_PIN(16), LOONGSON2_PIN(17), LOONGSON2_PIN(18), LOONGSON2_PIN(19),\n\tLOONGSON2_PIN(20), LOONGSON2_PIN(21), LOONGSON2_PIN(22), LOONGSON2_PIN(23),\n\tLOONGSON2_PIN(24), LOONGSON2_PIN(25), LOONGSON2_PIN(26), LOONGSON2_PIN(27),\n\tLOONGSON2_PIN(28), LOONGSON2_PIN(29), LOONGSON2_PIN(30),\n\tLOONGSON2_PIN(32), LOONGSON2_PIN(33), LOONGSON2_PIN(34), LOONGSON2_PIN(35),\n\tLOONGSON2_PIN(36), LOONGSON2_PIN(37), LOONGSON2_PIN(38), LOONGSON2_PIN(39),\n\tLOONGSON2_PIN(40), LOONGSON2_PIN(41),\n\tLOONGSON2_PIN(44), LOONGSON2_PIN(45), LOONGSON2_PIN(46), LOONGSON2_PIN(47),\n\tLOONGSON2_PIN(48), LOONGSON2_PIN(49), LOONGSON2_PIN(50), LOONGSON2_PIN(51),\n\tLOONGSON2_PIN(52), LOONGSON2_PIN(53), LOONGSON2_PIN(54), LOONGSON2_PIN(55),\n\tLOONGSON2_PIN(56), LOONGSON2_PIN(57), LOONGSON2_PIN(58), LOONGSON2_PIN(59),\n\tLOONGSON2_PIN(60), LOONGSON2_PIN(61), LOONGSON2_PIN(62), LOONGSON2_PIN(63),\n};\n\nstatic const unsigned int gpio_pins[] = {0, 1, 2, 3, 4, 5, 6, 7,\n\t\t\t\t\t 8, 9, 10, 11, 12, 13, 14,\n\t\t\t\t\t 16, 17, 18, 19, 20, 21, 22, 23,\n\t\t\t\t\t 24, 25, 26, 27, 28, 29, 30,\n\t\t\t\t\t 32, 33, 34, 35, 36, 37, 38, 39,\n\t\t\t\t\t 40,         43, 44, 45, 46, 47,\n\t\t\t\t\t 48, 49, 50, 51, 52, 53, 46, 55,\n\t\t\t\t\t 56, 57, 58, 59, 60, 61, 62, 63};\nstatic const unsigned int sdio_pins[] = {36, 37, 38, 39, 40, 41};\nstatic const unsigned int can1_pins[] = {34, 35};\nstatic const unsigned int can0_pins[] = {32, 33};\nstatic const unsigned int pwm3_pins[] = {23};\nstatic const unsigned int pwm2_pins[] = {22};\nstatic const unsigned int pwm1_pins[] = {21};\nstatic const unsigned int pwm0_pins[] = {20};\nstatic const unsigned int i2c1_pins[] = {18, 19};\nstatic const unsigned int i2c0_pins[] = {16, 17};\nstatic const unsigned int nand_pins[] = {44, 45, 46, 47, 48, 49, 50, 51,\n\t\t\t\t\t 52, 53, 54, 55, 56, 57, 58, 59, 60,\n\t\t\t\t\t 61, 62, 63};\nstatic const unsigned int sata_led_pins[] = {14};\nstatic const unsigned int i2s_pins[]    = {24, 25, 26, 27, 28};\nstatic const unsigned int hda_pins[]    = {24, 25, 26, 27, 28, 29, 30};\n\nstatic struct loongson2_pmx_group loongson2_pmx_groups[] = {\n\tPMX_GROUP(gpio, 0x0, 64),\n\tPMX_GROUP(sdio, 0x0, 20),\n\tPMX_GROUP(can1, 0x0, 17),\n\tPMX_GROUP(can0, 0x0, 16),\n\tPMX_GROUP(pwm3, 0x0, 15),\n\tPMX_GROUP(pwm2, 0x0, 14),\n\tPMX_GROUP(pwm1, 0x0, 13),\n\tPMX_GROUP(pwm0, 0x0, 12),\n\tPMX_GROUP(i2c1, 0x0, 11),\n\tPMX_GROUP(i2c0, 0x0, 10),\n\tPMX_GROUP(nand, 0x0, 9),\n\tPMX_GROUP(sata_led, 0x0, 8),\n\tPMX_GROUP(i2s, 0x0, 6),\n\tPMX_GROUP(hda, 0x0, 4),\n};\n\nSPECIFIC_GROUP(sdio);\nSPECIFIC_GROUP(can1);\nSPECIFIC_GROUP(can0);\nSPECIFIC_GROUP(pwm3);\nSPECIFIC_GROUP(pwm2);\nSPECIFIC_GROUP(pwm1);\nSPECIFIC_GROUP(pwm0);\nSPECIFIC_GROUP(i2c1);\nSPECIFIC_GROUP(i2c0);\nSPECIFIC_GROUP(nand);\nSPECIFIC_GROUP(sata_led);\nSPECIFIC_GROUP(i2s);\nSPECIFIC_GROUP(hda);\n\nstatic const char * const gpio_groups[] = {\n\t\"sdio\",\n\t\"can1\", \"can0\",\n\t\"pwm3\", \"pwm2\", \"pwm1\", \"pwm0\",\n\t\"i2c1\", \"i2c0\",\n\t\"nand\",\n\t\"sata_led\",\n\t\"i2s\",\n\t\"hda\",\n};\n\nstatic const struct loongson2_pmx_func loongson2_pmx_functions[] = {\n\tFUNCTION(gpio),\n\tFUNCTION(sdio),\n\tFUNCTION(can1),\n\tFUNCTION(can0),\n\tFUNCTION(pwm3),\n\tFUNCTION(pwm2),\n\tFUNCTION(pwm1),\n\tFUNCTION(pwm0),\n\tFUNCTION(i2c1),\n\tFUNCTION(i2c0),\n\tFUNCTION(nand),\n\tFUNCTION(sata_led),\n\tFUNCTION(i2s),\n\tFUNCTION(hda),\n};\n\nstatic int loongson2_get_groups_count(struct pinctrl_dev *pcdev)\n{\n\treturn ARRAY_SIZE(loongson2_pmx_groups);\n}\n\nstatic const char *loongson2_get_group_name(struct pinctrl_dev *pcdev,\n\t\t\t\t\tunsigned int selector)\n{\n\treturn loongson2_pmx_groups[selector].grp.name;\n}\n\nstatic int loongson2_get_group_pins(struct pinctrl_dev *pcdev, unsigned int selector,\n\t\t\tconst unsigned int **pins, unsigned int *num_pins)\n{\n\t*pins = loongson2_pmx_groups[selector].grp.pins;\n\t*num_pins = loongson2_pmx_groups[selector].grp.npins;\n\n\treturn 0;\n}\n\nstatic void loongson2_pin_dbg_show(struct pinctrl_dev *pcdev, struct seq_file *s,\n\t\t\t       unsigned int offset)\n{\n\tseq_printf(s, \" %s\", dev_name(pcdev->dev));\n}\n\nstatic const struct pinctrl_ops loongson2_pctrl_ops = {\n\t.get_groups_count\t= loongson2_get_groups_count,\n\t.get_group_name\t\t= loongson2_get_group_name,\n\t.get_group_pins\t\t= loongson2_get_group_pins,\n\t.dt_node_to_map\t\t= pinconf_generic_dt_node_to_map_all,\n\t.dt_free_map\t\t= pinctrl_utils_free_map,\n\t.pin_dbg_show\t\t= loongson2_pin_dbg_show,\n};\n\nstatic int loongson2_pmx_set_mux(struct pinctrl_dev *pcdev, unsigned int func_num,\n\t\t\t      unsigned int group_num)\n{\n\tstruct loongson2_pinctrl *pctrl = pinctrl_dev_get_drvdata(pcdev);\n\tvoid __iomem *reg = pctrl->reg_base +\n\t\t\t\tloongson2_pmx_groups[group_num].reg;\n\tunsigned int mux_bit = loongson2_pmx_groups[group_num].bit;\n\tunsigned int val;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&pctrl->lock, flags);\n\tval = readl(reg);\n\tif (func_num == 0)\n\t\tval &= ~BIT(mux_bit);\n\telse\n\t\tval |= BIT(mux_bit);\n\twritel(val, reg);\n\tspin_unlock_irqrestore(&pctrl->lock, flags);\n\n\treturn 0;\n}\n\nstatic int loongson2_pmx_get_funcs_count(struct pinctrl_dev *pcdev)\n{\n\treturn ARRAY_SIZE(loongson2_pmx_functions);\n}\n\nstatic const char *loongson2_pmx_get_func_name(struct pinctrl_dev *pcdev,\n\t\t\t\t    unsigned int selector)\n{\n\treturn loongson2_pmx_functions[selector].name;\n}\n\nstatic int loongson2_pmx_get_groups(struct pinctrl_dev *pcdev,\n\t\t\t unsigned int selector,\n\t\t\t const char * const **groups,\n\t\t\t unsigned int * const num_groups)\n{\n\t*groups = loongson2_pmx_functions[selector].groups;\n\t*num_groups = loongson2_pmx_functions[selector].num_groups;\n\n\treturn 0;\n}\n\nstatic const struct pinmux_ops loongson2_pmx_ops = {\n\t.set_mux = loongson2_pmx_set_mux,\n\t.get_functions_count = loongson2_pmx_get_funcs_count,\n\t.get_function_name = loongson2_pmx_get_func_name,\n\t.get_function_groups = loongson2_pmx_get_groups,\n};\n\nstatic int loongson2_pinctrl_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct loongson2_pinctrl *pctrl;\n\n\tpctrl = devm_kzalloc(dev, sizeof(*pctrl), GFP_KERNEL);\n\tif (!pctrl)\n\t\treturn -ENOMEM;\n\n\tpctrl->reg_base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(pctrl->reg_base))\n\t\treturn PTR_ERR(pctrl->reg_base);\n\n\tspin_lock_init(&pctrl->lock);\n\n\tpctrl->dev = dev;\n\tpctrl->desc.name\t= \"pinctrl-loongson2\";\n\tpctrl->desc.owner\t= THIS_MODULE;\n\tpctrl->desc.pctlops\t= &loongson2_pctrl_ops;\n\tpctrl->desc.pmxops\t= &loongson2_pmx_ops;\n\tpctrl->desc.pins\t= loongson2_pctrl_pins;\n\tpctrl->desc.npins\t= ARRAY_SIZE(loongson2_pctrl_pins);\n\n\tpctrl->pcdev = devm_pinctrl_register(pctrl->dev, &pctrl->desc, pctrl);\n\tif (IS_ERR(pctrl->pcdev))\n\t\treturn dev_err_probe(pctrl->dev, PTR_ERR(pctrl->pcdev),\n\t\t\t\t     \"can't register pinctrl device\");\n\n\treturn 0;\n}\n\nstatic const struct of_device_id loongson2_pinctrl_dt_match[] = {\n\t{\n\t\t.compatible = \"loongson,ls2k-pinctrl\",\n\t},\n\t{ }\n};\n\nstatic struct platform_driver loongson2_pinctrl_driver = {\n\t.probe\t\t= loongson2_pinctrl_probe,\n\t.driver = {\n\t\t.name\t= \"loongson2-pinctrl\",\n\t\t.of_match_table = loongson2_pinctrl_dt_match,\n\t},\n};\n\nstatic int __init loongson2_pinctrl_init(void)\n{\n\treturn platform_driver_register(&loongson2_pinctrl_driver);\n}\narch_initcall(loongson2_pinctrl_init);\n\nstatic void __exit loongson2_pinctrl_exit(void)\n{\n\tplatform_driver_unregister(&loongson2_pinctrl_driver);\n}\nmodule_exit(loongson2_pinctrl_exit);\n\nMODULE_DESCRIPTION(\"Loongson2 Pinctrl driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}