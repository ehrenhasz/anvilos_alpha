{
  "module_name": "pinctrl-pistachio.c",
  "hash_id": "abb83ffd41b571be31f80b4d12b2eb20144a712d8bce7c90ea237398fb57bb66",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pinctrl/pinctrl-pistachio.c",
  "human_readable_source": "\n \n\n#include <linux/gpio/driver.h>\n#include <linux/interrupt.h>\n#include <linux/io.h>\n#include <linux/irq.h>\n#include <linux/mod_devicetable.h>\n#include <linux/pinctrl/pinconf.h>\n#include <linux/pinctrl/pinconf-generic.h>\n#include <linux/pinctrl/pinctrl.h>\n#include <linux/pinctrl/pinmux.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/seq_file.h>\n#include <linux/slab.h>\n#include <linux/spinlock.h>\n\n#include \"pinctrl-utils.h\"\n\n#define PADS_SCHMITT_EN0\t\t0x000\n#define PADS_SCHMITT_EN_REG(pin)\t(PADS_SCHMITT_EN0 + 0x4 * ((pin) / 32))\n#define PADS_SCHMITT_EN_BIT(pin)\tBIT((pin) % 32)\n\n#define PADS_PU_PD0\t\t\t0x040\n#define PADS_PU_PD_REG(pin)\t\t(PADS_PU_PD0 + 0x4 * ((pin) / 16))\n#define PADS_PU_PD_SHIFT(pin)\t\t(2 * ((pin) % 16))\n#define PADS_PU_PD_MASK\t\t\t0x3\n#define PADS_PU_PD_HIGHZ\t\t0x0\n#define PADS_PU_PD_UP\t\t\t0x1\n#define PADS_PU_PD_DOWN\t\t\t0x2\n#define PADS_PU_PD_BUS\t\t\t0x3\n\n#define PADS_FUNCTION_SELECT0\t\t0x0c0\n#define PADS_FUNCTION_SELECT1\t\t0x0c4\n#define PADS_FUNCTION_SELECT2\t\t0x0c8\n#define PADS_SCENARIO_SELECT\t\t0x0f8\n\n#define PADS_SLEW_RATE0\t\t\t0x100\n#define PADS_SLEW_RATE_REG(pin)\t\t(PADS_SLEW_RATE0 + 0x4 * ((pin) / 32))\n#define PADS_SLEW_RATE_BIT(pin)\t\tBIT((pin) % 32)\n\n#define PADS_DRIVE_STRENGTH0\t\t0x120\n#define PADS_DRIVE_STRENGTH_REG(pin)\t\t\t\t\t\\\n\t(PADS_DRIVE_STRENGTH0 + 0x4 * ((pin) / 16))\n#define PADS_DRIVE_STRENGTH_SHIFT(pin)\t(2 * ((pin) % 16))\n#define PADS_DRIVE_STRENGTH_MASK\t0x3\n#define PADS_DRIVE_STRENGTH_2MA\t\t0x0\n#define PADS_DRIVE_STRENGTH_4MA\t\t0x1\n#define PADS_DRIVE_STRENGTH_8MA\t\t0x2\n#define PADS_DRIVE_STRENGTH_12MA\t0x3\n\n#define GPIO_BANK_BASE(bank)\t\t(0x200 + 0x24 * (bank))\n\n#define GPIO_BIT_EN\t\t\t0x00\n#define GPIO_OUTPUT_EN\t\t\t0x04\n#define GPIO_OUTPUT\t\t\t0x08\n#define GPIO_INPUT\t\t\t0x0c\n#define GPIO_INPUT_POLARITY\t\t0x10\n#define GPIO_INTERRUPT_TYPE\t\t0x14\n#define GPIO_INTERRUPT_TYPE_LEVEL\t0x0\n#define GPIO_INTERRUPT_TYPE_EDGE\t0x1\n#define GPIO_INTERRUPT_EDGE\t\t0x18\n#define GPIO_INTERRUPT_EDGE_SINGLE\t0x0\n#define GPIO_INTERRUPT_EDGE_DUAL\t0x1\n#define GPIO_INTERRUPT_EN\t\t0x1c\n#define GPIO_INTERRUPT_STATUS\t\t0x20\n\nstruct pistachio_function {\n\tconst char *name;\n\tconst char * const *groups;\n\tunsigned int ngroups;\n\tconst int *scenarios;\n\tunsigned int nscenarios;\n\tunsigned int scenario_reg;\n\tunsigned int scenario_shift;\n\tunsigned int scenario_mask;\n};\n\nstruct pistachio_pin_group {\n\tconst char *name;\n\tunsigned int pin;\n\tint mux_option[3];\n\tint mux_reg;\n\tint mux_shift;\n\tint mux_mask;\n};\n\nstruct pistachio_gpio_bank {\n\tstruct pistachio_pinctrl *pctl;\n\tvoid __iomem *base;\n\tint instance;\n\tunsigned int pin_base;\n\tunsigned int npins;\n\tstruct gpio_chip gpio_chip;\n};\n\nstruct pistachio_pinctrl {\n\tstruct device *dev;\n\tvoid __iomem *base;\n\tstruct pinctrl_dev *pctldev;\n\tconst struct pinctrl_pin_desc *pins;\n\tunsigned int npins;\n\tconst struct pistachio_function *functions;\n\tunsigned int nfunctions;\n\tconst struct pistachio_pin_group *groups;\n\tunsigned int ngroups;\n\tstruct pistachio_gpio_bank *gpio_banks;\n\tunsigned int nbanks;\n};\n\n#define PISTACHIO_PIN_MFIO(p)\t\t(p)\n#define PISTACHIO_PIN_TCK\t\t90\n#define PISTACHIO_PIN_TRSTN\t\t91\n#define PISTACHIO_PIN_TDI\t\t92\n#define PISTACHIO_PIN_TMS\t\t93\n#define PISTACHIO_PIN_TDO\t\t94\n#define PISTACHIO_PIN_JTAG_COMPLY\t95\n#define PISTACHIO_PIN_SAFE_MODE\t\t96\n#define PISTACHIO_PIN_POR_DISABLE\t97\n#define PISTACHIO_PIN_RESETN\t\t98\n\n#define MFIO_PIN_DESC(p)\tPINCTRL_PIN(PISTACHIO_PIN_MFIO(p), \"mfio\" #p)\n\nstatic const struct pinctrl_pin_desc pistachio_pins[] = {\n\tMFIO_PIN_DESC(0),\n\tMFIO_PIN_DESC(1),\n\tMFIO_PIN_DESC(2),\n\tMFIO_PIN_DESC(3),\n\tMFIO_PIN_DESC(4),\n\tMFIO_PIN_DESC(5),\n\tMFIO_PIN_DESC(6),\n\tMFIO_PIN_DESC(7),\n\tMFIO_PIN_DESC(8),\n\tMFIO_PIN_DESC(9),\n\tMFIO_PIN_DESC(10),\n\tMFIO_PIN_DESC(11),\n\tMFIO_PIN_DESC(12),\n\tMFIO_PIN_DESC(13),\n\tMFIO_PIN_DESC(14),\n\tMFIO_PIN_DESC(15),\n\tMFIO_PIN_DESC(16),\n\tMFIO_PIN_DESC(17),\n\tMFIO_PIN_DESC(18),\n\tMFIO_PIN_DESC(19),\n\tMFIO_PIN_DESC(20),\n\tMFIO_PIN_DESC(21),\n\tMFIO_PIN_DESC(22),\n\tMFIO_PIN_DESC(23),\n\tMFIO_PIN_DESC(24),\n\tMFIO_PIN_DESC(25),\n\tMFIO_PIN_DESC(26),\n\tMFIO_PIN_DESC(27),\n\tMFIO_PIN_DESC(28),\n\tMFIO_PIN_DESC(29),\n\tMFIO_PIN_DESC(30),\n\tMFIO_PIN_DESC(31),\n\tMFIO_PIN_DESC(32),\n\tMFIO_PIN_DESC(33),\n\tMFIO_PIN_DESC(34),\n\tMFIO_PIN_DESC(35),\n\tMFIO_PIN_DESC(36),\n\tMFIO_PIN_DESC(37),\n\tMFIO_PIN_DESC(38),\n\tMFIO_PIN_DESC(39),\n\tMFIO_PIN_DESC(40),\n\tMFIO_PIN_DESC(41),\n\tMFIO_PIN_DESC(42),\n\tMFIO_PIN_DESC(43),\n\tMFIO_PIN_DESC(44),\n\tMFIO_PIN_DESC(45),\n\tMFIO_PIN_DESC(46),\n\tMFIO_PIN_DESC(47),\n\tMFIO_PIN_DESC(48),\n\tMFIO_PIN_DESC(49),\n\tMFIO_PIN_DESC(50),\n\tMFIO_PIN_DESC(51),\n\tMFIO_PIN_DESC(52),\n\tMFIO_PIN_DESC(53),\n\tMFIO_PIN_DESC(54),\n\tMFIO_PIN_DESC(55),\n\tMFIO_PIN_DESC(56),\n\tMFIO_PIN_DESC(57),\n\tMFIO_PIN_DESC(58),\n\tMFIO_PIN_DESC(59),\n\tMFIO_PIN_DESC(60),\n\tMFIO_PIN_DESC(61),\n\tMFIO_PIN_DESC(62),\n\tMFIO_PIN_DESC(63),\n\tMFIO_PIN_DESC(64),\n\tMFIO_PIN_DESC(65),\n\tMFIO_PIN_DESC(66),\n\tMFIO_PIN_DESC(67),\n\tMFIO_PIN_DESC(68),\n\tMFIO_PIN_DESC(69),\n\tMFIO_PIN_DESC(70),\n\tMFIO_PIN_DESC(71),\n\tMFIO_PIN_DESC(72),\n\tMFIO_PIN_DESC(73),\n\tMFIO_PIN_DESC(74),\n\tMFIO_PIN_DESC(75),\n\tMFIO_PIN_DESC(76),\n\tMFIO_PIN_DESC(77),\n\tMFIO_PIN_DESC(78),\n\tMFIO_PIN_DESC(79),\n\tMFIO_PIN_DESC(80),\n\tMFIO_PIN_DESC(81),\n\tMFIO_PIN_DESC(82),\n\tMFIO_PIN_DESC(83),\n\tMFIO_PIN_DESC(84),\n\tMFIO_PIN_DESC(85),\n\tMFIO_PIN_DESC(86),\n\tMFIO_PIN_DESC(87),\n\tMFIO_PIN_DESC(88),\n\tMFIO_PIN_DESC(89),\n\tPINCTRL_PIN(PISTACHIO_PIN_TCK, \"tck\"),\n\tPINCTRL_PIN(PISTACHIO_PIN_TRSTN, \"trstn\"),\n\tPINCTRL_PIN(PISTACHIO_PIN_TDI, \"tdi\"),\n\tPINCTRL_PIN(PISTACHIO_PIN_TMS, \"tms\"),\n\tPINCTRL_PIN(PISTACHIO_PIN_TDO, \"tdo\"),\n\tPINCTRL_PIN(PISTACHIO_PIN_JTAG_COMPLY, \"jtag_comply\"),\n\tPINCTRL_PIN(PISTACHIO_PIN_SAFE_MODE, \"safe_mode\"),\n\tPINCTRL_PIN(PISTACHIO_PIN_POR_DISABLE, \"por_disable\"),\n\tPINCTRL_PIN(PISTACHIO_PIN_RESETN, \"resetn\"),\n};\n\nstatic const char * const pistachio_spim0_groups[] = {\n\t\"mfio1\", \"mfio2\", \"mfio8\", \"mfio9\", \"mfio10\", \"mfio28\", \"mfio29\",\n\t\"mfio30\", \"mfio55\", \"mfio56\", \"mfio57\",\n};\n\nstatic const char * const pistachio_spim1_groups[] = {\n\t\"mfio0\", \"mfio1\", \"mfio2\", \"mfio3\", \"mfio4\", \"mfio5\", \"mfio6\",\n\t\"mfio7\", \"mfio31\", \"mfio55\", \"mfio56\", \"mfio57\", \"mfio58\",\n};\n\nstatic const char * const pistachio_spis_groups[] = {\n\t\"mfio11\", \"mfio12\", \"mfio13\", \"mfio14\",\n};\n\nstatic const char *const pistachio_sdhost_groups[] = {\n\t\"mfio15\", \"mfio16\", \"mfio17\", \"mfio18\", \"mfio19\", \"mfio20\",\n\t\"mfio21\", \"mfio22\", \"mfio23\", \"mfio24\", \"mfio25\", \"mfio26\",\n\t\"mfio27\",\n};\n\nstatic const char * const pistachio_i2c0_groups[] = {\n\t\"mfio28\", \"mfio29\",\n};\n\nstatic const char * const pistachio_i2c1_groups[] = {\n\t\"mfio30\", \"mfio31\",\n};\n\nstatic const char * const pistachio_i2c2_groups[] = {\n\t\"mfio32\", \"mfio33\",\n};\n\nstatic const char * const pistachio_i2c3_groups[] = {\n\t\"mfio34\", \"mfio35\",\n};\n\nstatic const char * const pistachio_audio_clk_in_groups[] = {\n\t\"mfio36\",\n};\n\nstatic const char * const pistachio_i2s_out_groups[] = {\n\t\"mfio36\", \"mfio37\", \"mfio38\", \"mfio39\", \"mfio40\", \"mfio41\",\n\t\"mfio42\", \"mfio43\", \"mfio44\",\n};\n\nstatic const char * const pistachio_debug_raw_cca_ind_groups[] = {\n\t\"mfio37\",\n};\n\nstatic const char * const pistachio_debug_ed_sec20_cca_ind_groups[] = {\n\t\"mfio38\",\n};\n\nstatic const char * const pistachio_debug_ed_sec40_cca_ind_groups[] = {\n\t\"mfio39\",\n};\n\nstatic const char * const pistachio_debug_agc_done_0_groups[] = {\n\t\"mfio40\",\n};\n\nstatic const char * const pistachio_debug_agc_done_1_groups[] = {\n\t\"mfio41\",\n};\n\nstatic const char * const pistachio_debug_ed_cca_ind_groups[] = {\n\t\"mfio42\",\n};\n\nstatic const char * const pistachio_debug_s2l_done_groups[] = {\n\t\"mfio43\",\n};\n\nstatic const char * const pistachio_i2s_dac_clk_groups[] = {\n\t\"mfio45\",\n};\n\nstatic const char * const pistachio_audio_sync_groups[] = {\n\t\"mfio45\",\n};\n\nstatic const char * const pistachio_audio_trigger_groups[] = {\n\t\"mfio46\",\n};\n\nstatic const char * const pistachio_i2s_in_groups[] = {\n\t\"mfio47\", \"mfio48\", \"mfio49\", \"mfio50\", \"mfio51\", \"mfio52\",\n\t\"mfio53\", \"mfio54\",\n};\n\nstatic const char * const pistachio_uart0_groups[] = {\n\t\"mfio55\", \"mfio56\", \"mfio57\", \"mfio58\",\n};\n\nstatic const char * const pistachio_uart1_groups[] = {\n\t\"mfio59\", \"mfio60\", \"mfio1\", \"mfio2\",\n};\n\nstatic const char * const pistachio_spdif_out_groups[] = {\n\t\"mfio61\",\n};\n\nstatic const char * const pistachio_spdif_in_groups[] = {\n\t\"mfio62\", \"mfio54\",\n};\nstatic const int pistachio_spdif_in_scenarios[] = {\n\tPISTACHIO_PIN_MFIO(62),\n\tPISTACHIO_PIN_MFIO(54),\n};\n\nstatic const char * const pistachio_eth_groups[] = {\n\t\"mfio63\", \"mfio64\", \"mfio65\", \"mfio66\", \"mfio67\", \"mfio68\",\n\t\"mfio69\", \"mfio70\", \"mfio71\",\n};\n\nstatic const char * const pistachio_ir_groups[] = {\n\t\"mfio72\",\n};\n\nstatic const char * const pistachio_pwmpdm_groups[] = {\n\t\"mfio73\", \"mfio74\", \"mfio75\", \"mfio76\",\n};\n\nstatic const char * const pistachio_mips_trace_clk_groups[] = {\n\t\"mfio15\", \"mfio63\", \"mfio73\",\n};\n\nstatic const char * const pistachio_mips_trace_dint_groups[] = {\n\t\"mfio16\", \"mfio64\", \"mfio74\",\n};\nstatic const int pistachio_mips_trace_dint_scenarios[] = {\n\tPISTACHIO_PIN_MFIO(16),\n\tPISTACHIO_PIN_MFIO(64),\n\tPISTACHIO_PIN_MFIO(74),\n};\n\nstatic const char * const pistachio_mips_trace_trigout_groups[] = {\n\t\"mfio17\", \"mfio65\", \"mfio75\",\n};\n\nstatic const char * const pistachio_mips_trace_trigin_groups[] = {\n\t\"mfio18\", \"mfio66\", \"mfio76\",\n};\nstatic const int pistachio_mips_trace_trigin_scenarios[] = {\n\tPISTACHIO_PIN_MFIO(18),\n\tPISTACHIO_PIN_MFIO(66),\n\tPISTACHIO_PIN_MFIO(76),\n};\n\nstatic const char * const pistachio_mips_trace_dm_groups[] = {\n\t\"mfio19\", \"mfio67\", \"mfio77\",\n};\n\nstatic const char * const pistachio_mips_probe_n_groups[] = {\n\t\"mfio20\", \"mfio68\", \"mfio78\",\n};\nstatic const int pistachio_mips_probe_n_scenarios[] = {\n\tPISTACHIO_PIN_MFIO(20),\n\tPISTACHIO_PIN_MFIO(68),\n\tPISTACHIO_PIN_MFIO(78),\n};\n\nstatic const char * const pistachio_mips_trace_data_groups[] = {\n\t\"mfio15\", \"mfio16\", \"mfio17\", \"mfio18\", \"mfio19\", \"mfio20\",\n\t\"mfio21\", \"mfio22\", \"mfio63\", \"mfio64\", \"mfio65\", \"mfio66\",\n\t\"mfio67\", \"mfio68\", \"mfio69\", \"mfio70\", \"mfio79\", \"mfio80\",\n\t\"mfio81\", \"mfio82\", \"mfio83\", \"mfio84\", \"mfio85\", \"mfio86\",\n};\n\nstatic const char * const pistachio_sram_debug_groups[] = {\n\t\"mfio73\", \"mfio74\",\n};\n\nstatic const char * const pistachio_rom_debug_groups[] = {\n\t\"mfio75\", \"mfio76\",\n};\n\nstatic const char * const pistachio_rpu_debug_groups[] = {\n\t\"mfio77\", \"mfio78\",\n};\n\nstatic const char * const pistachio_mips_debug_groups[] = {\n\t\"mfio79\", \"mfio80\",\n};\n\nstatic const char * const pistachio_eth_debug_groups[] = {\n\t\"mfio81\", \"mfio82\",\n};\n\nstatic const char * const pistachio_usb_debug_groups[] = {\n\t\"mfio83\", \"mfio84\",\n};\n\nstatic const char * const pistachio_sdhost_debug_groups[] = {\n\t\"mfio85\", \"mfio86\",\n};\n\nstatic const char * const pistachio_socif_debug_groups[] = {\n\t\"mfio87\", \"mfio88\",\n};\n\nstatic const char * const pistachio_mdc_debug_groups[] = {\n\t\"mfio77\", \"mfio78\",\n};\n\nstatic const char * const pistachio_ddr_debug_groups[] = {\n\t\"mfio79\", \"mfio80\",\n};\n\nstatic const char * const pistachio_dreq0_groups[] = {\n\t\"mfio81\",\n};\n\nstatic const char * const pistachio_dreq1_groups[] = {\n\t\"mfio82\",\n};\n\nstatic const char * const pistachio_dreq2_groups[] = {\n\t\"mfio87\",\n};\n\nstatic const char * const pistachio_dreq3_groups[] = {\n\t\"mfio88\",\n};\n\nstatic const char * const pistachio_dreq4_groups[] = {\n\t\"mfio89\",\n};\n\nstatic const char * const pistachio_dreq5_groups[] = {\n\t\"mfio89\",\n};\n\nstatic const char * const pistachio_mips_pll_lock_groups[] = {\n\t\"mfio83\",\n};\n\nstatic const char * const pistachio_audio_pll_lock_groups[] = {\n\t\"mfio84\",\n};\n\nstatic const char * const pistachio_rpu_v_pll_lock_groups[] = {\n\t\"mfio85\",\n};\n\nstatic const char * const pistachio_rpu_l_pll_lock_groups[] = {\n\t\"mfio86\",\n};\n\nstatic const char * const pistachio_sys_pll_lock_groups[] = {\n\t\"mfio87\",\n};\n\nstatic const char * const pistachio_wifi_pll_lock_groups[] = {\n\t\"mfio88\",\n};\n\nstatic const char * const pistachio_bt_pll_lock_groups[] = {\n\t\"mfio89\",\n};\n\n#define FUNCTION(_name)\t\t\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.name = #_name,\t\t\t\t\t\t\\\n\t\t.groups = pistachio_##_name##_groups,\t\t\t\\\n\t\t.ngroups = ARRAY_SIZE(pistachio_##_name##_groups),\t\\\n\t}\n\n#define FUNCTION_SCENARIO(_name, _reg, _shift, _mask)\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.name = #_name,\t\t\t\t\t\t\\\n\t\t.groups = pistachio_##_name##_groups,\t\t\t\\\n\t\t.ngroups = ARRAY_SIZE(pistachio_##_name##_groups),\t\\\n\t\t.scenarios = pistachio_##_name##_scenarios,\t\t\\\n\t\t.nscenarios = ARRAY_SIZE(pistachio_##_name##_scenarios),\\\n\t\t.scenario_reg = _reg,\t\t\t\t\t\\\n\t\t.scenario_shift = _shift,\t\t\t\t\\\n\t\t.scenario_mask = _mask,\t\t\t\t\t\\\n\t}\n\nenum pistachio_mux_option {\n\tPISTACHIO_FUNCTION_NONE = -1,\n\tPISTACHIO_FUNCTION_SPIM0,\n\tPISTACHIO_FUNCTION_SPIM1,\n\tPISTACHIO_FUNCTION_SPIS,\n\tPISTACHIO_FUNCTION_SDHOST,\n\tPISTACHIO_FUNCTION_I2C0,\n\tPISTACHIO_FUNCTION_I2C1,\n\tPISTACHIO_FUNCTION_I2C2,\n\tPISTACHIO_FUNCTION_I2C3,\n\tPISTACHIO_FUNCTION_AUDIO_CLK_IN,\n\tPISTACHIO_FUNCTION_I2S_OUT,\n\tPISTACHIO_FUNCTION_I2S_DAC_CLK,\n\tPISTACHIO_FUNCTION_AUDIO_SYNC,\n\tPISTACHIO_FUNCTION_AUDIO_TRIGGER,\n\tPISTACHIO_FUNCTION_I2S_IN,\n\tPISTACHIO_FUNCTION_UART0,\n\tPISTACHIO_FUNCTION_UART1,\n\tPISTACHIO_FUNCTION_SPDIF_OUT,\n\tPISTACHIO_FUNCTION_SPDIF_IN,\n\tPISTACHIO_FUNCTION_ETH,\n\tPISTACHIO_FUNCTION_IR,\n\tPISTACHIO_FUNCTION_PWMPDM,\n\tPISTACHIO_FUNCTION_MIPS_TRACE_CLK,\n\tPISTACHIO_FUNCTION_MIPS_TRACE_DINT,\n\tPISTACHIO_FUNCTION_MIPS_TRACE_TRIGOUT,\n\tPISTACHIO_FUNCTION_MIPS_TRACE_TRIGIN,\n\tPISTACHIO_FUNCTION_MIPS_TRACE_DM,\n\tPISTACHIO_FUNCTION_MIPS_TRACE_PROBE_N,\n\tPISTACHIO_FUNCTION_MIPS_TRACE_DATA,\n\tPISTACHIO_FUNCTION_SRAM_DEBUG,\n\tPISTACHIO_FUNCTION_ROM_DEBUG,\n\tPISTACHIO_FUNCTION_RPU_DEBUG,\n\tPISTACHIO_FUNCTION_MIPS_DEBUG,\n\tPISTACHIO_FUNCTION_ETH_DEBUG,\n\tPISTACHIO_FUNCTION_USB_DEBUG,\n\tPISTACHIO_FUNCTION_SDHOST_DEBUG,\n\tPISTACHIO_FUNCTION_SOCIF_DEBUG,\n\tPISTACHIO_FUNCTION_MDC_DEBUG,\n\tPISTACHIO_FUNCTION_DDR_DEBUG,\n\tPISTACHIO_FUNCTION_DREQ0,\n\tPISTACHIO_FUNCTION_DREQ1,\n\tPISTACHIO_FUNCTION_DREQ2,\n\tPISTACHIO_FUNCTION_DREQ3,\n\tPISTACHIO_FUNCTION_DREQ4,\n\tPISTACHIO_FUNCTION_DREQ5,\n\tPISTACHIO_FUNCTION_MIPS_PLL_LOCK,\n\tPISTACHIO_FUNCTION_AUDIO_PLL_LOCK,\n\tPISTACHIO_FUNCTION_RPU_V_PLL_LOCK,\n\tPISTACHIO_FUNCTION_RPU_L_PLL_LOCK,\n\tPISTACHIO_FUNCTION_SYS_PLL_LOCK,\n\tPISTACHIO_FUNCTION_WIFI_PLL_LOCK,\n\tPISTACHIO_FUNCTION_BT_PLL_LOCK,\n\tPISTACHIO_FUNCTION_DEBUG_RAW_CCA_IND,\n\tPISTACHIO_FUNCTION_DEBUG_ED_SEC20_CCA_IND,\n\tPISTACHIO_FUNCTION_DEBUG_ED_SEC40_CCA_IND,\n\tPISTACHIO_FUNCTION_DEBUG_AGC_DONE_0,\n\tPISTACHIO_FUNCTION_DEBUG_AGC_DONE_1,\n\tPISTACHIO_FUNCTION_DEBUG_ED_CCA_IND,\n\tPISTACHIO_FUNCTION_DEBUG_S2L_DONE,\n};\n\nstatic const struct pistachio_function pistachio_functions[] = {\n\tFUNCTION(spim0),\n\tFUNCTION(spim1),\n\tFUNCTION(spis),\n\tFUNCTION(sdhost),\n\tFUNCTION(i2c0),\n\tFUNCTION(i2c1),\n\tFUNCTION(i2c2),\n\tFUNCTION(i2c3),\n\tFUNCTION(audio_clk_in),\n\tFUNCTION(i2s_out),\n\tFUNCTION(i2s_dac_clk),\n\tFUNCTION(audio_sync),\n\tFUNCTION(audio_trigger),\n\tFUNCTION(i2s_in),\n\tFUNCTION(uart0),\n\tFUNCTION(uart1),\n\tFUNCTION(spdif_out),\n\tFUNCTION_SCENARIO(spdif_in, PADS_SCENARIO_SELECT, 0, 0x1),\n\tFUNCTION(eth),\n\tFUNCTION(ir),\n\tFUNCTION(pwmpdm),\n\tFUNCTION(mips_trace_clk),\n\tFUNCTION_SCENARIO(mips_trace_dint, PADS_SCENARIO_SELECT, 1, 0x3),\n\tFUNCTION(mips_trace_trigout),\n\tFUNCTION_SCENARIO(mips_trace_trigin, PADS_SCENARIO_SELECT, 3, 0x3),\n\tFUNCTION(mips_trace_dm),\n\tFUNCTION_SCENARIO(mips_probe_n, PADS_SCENARIO_SELECT, 5, 0x3),\n\tFUNCTION(mips_trace_data),\n\tFUNCTION(sram_debug),\n\tFUNCTION(rom_debug),\n\tFUNCTION(rpu_debug),\n\tFUNCTION(mips_debug),\n\tFUNCTION(eth_debug),\n\tFUNCTION(usb_debug),\n\tFUNCTION(sdhost_debug),\n\tFUNCTION(socif_debug),\n\tFUNCTION(mdc_debug),\n\tFUNCTION(ddr_debug),\n\tFUNCTION(dreq0),\n\tFUNCTION(dreq1),\n\tFUNCTION(dreq2),\n\tFUNCTION(dreq3),\n\tFUNCTION(dreq4),\n\tFUNCTION(dreq5),\n\tFUNCTION(mips_pll_lock),\n\tFUNCTION(audio_pll_lock),\n\tFUNCTION(rpu_v_pll_lock),\n\tFUNCTION(rpu_l_pll_lock),\n\tFUNCTION(sys_pll_lock),\n\tFUNCTION(wifi_pll_lock),\n\tFUNCTION(bt_pll_lock),\n\tFUNCTION(debug_raw_cca_ind),\n\tFUNCTION(debug_ed_sec20_cca_ind),\n\tFUNCTION(debug_ed_sec40_cca_ind),\n\tFUNCTION(debug_agc_done_0),\n\tFUNCTION(debug_agc_done_1),\n\tFUNCTION(debug_ed_cca_ind),\n\tFUNCTION(debug_s2l_done),\n};\n\n#define PIN_GROUP(_pin, _name)\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\\\n\t\t.name = #_name,\t\t\t\t\t\\\n\t\t.pin = PISTACHIO_PIN_##_pin,\t\t\t\\\n\t\t.mux_option = {\t\t\t\t\t\\\n\t\t\tPISTACHIO_FUNCTION_NONE,\t\t\\\n\t\t\tPISTACHIO_FUNCTION_NONE,\t\t\\\n\t\t\tPISTACHIO_FUNCTION_NONE,\t\t\\\n\t\t},\t\t\t\t\t\t\\\n\t\t.mux_reg = -1,\t\t\t\t\t\\\n\t\t.mux_shift = -1,\t\t\t\t\\\n\t\t.mux_mask = -1,\t\t\t\t\t\\\n\t}\n\n#define MFIO_PIN_GROUP(_pin, _func)\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\\\n\t\t.name = \"mfio\" #_pin,\t\t\t\t\\\n\t\t.pin = PISTACHIO_PIN_MFIO(_pin),\t\t\\\n\t\t.mux_option = {\t\t\t\t\t\\\n\t\t\tPISTACHIO_FUNCTION_##_func,\t\t\\\n\t\t\tPISTACHIO_FUNCTION_NONE,\t\t\\\n\t\t\tPISTACHIO_FUNCTION_NONE,\t\t\\\n\t\t},\t\t\t\t\t\t\\\n\t\t.mux_reg = -1,\t\t\t\t\t\\\n\t\t.mux_shift = -1,\t\t\t\t\\\n\t\t.mux_mask = -1,\t\t\t\t\t\\\n\t}\n\n#define MFIO_MUX_PIN_GROUP(_pin, _f0, _f1, _f2, _reg, _shift, _mask)\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.name = \"mfio\" #_pin,\t\t\t\t\t\\\n\t\t.pin = PISTACHIO_PIN_MFIO(_pin),\t\t\t\\\n\t\t.mux_option = {\t\t\t\t\t\t\\\n\t\t\tPISTACHIO_FUNCTION_##_f0,\t\t\t\\\n\t\t\tPISTACHIO_FUNCTION_##_f1,\t\t\t\\\n\t\t\tPISTACHIO_FUNCTION_##_f2,\t\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t\t.mux_reg = _reg,\t\t\t\t\t\\\n\t\t.mux_shift = _shift,\t\t\t\t\t\\\n\t\t.mux_mask = _mask,\t\t\t\t\t\\\n\t}\n\nstatic const struct pistachio_pin_group pistachio_groups[] = {\n\tMFIO_PIN_GROUP(0, SPIM1),\n\tMFIO_MUX_PIN_GROUP(1, SPIM1, SPIM0, UART1,\n\t\t\t   PADS_FUNCTION_SELECT0, 0, 0x3),\n\tMFIO_MUX_PIN_GROUP(2, SPIM1, SPIM0, UART1,\n\t\t\t   PADS_FUNCTION_SELECT0, 2, 0x3),\n\tMFIO_PIN_GROUP(3, SPIM1),\n\tMFIO_PIN_GROUP(4, SPIM1),\n\tMFIO_PIN_GROUP(5, SPIM1),\n\tMFIO_PIN_GROUP(6, SPIM1),\n\tMFIO_PIN_GROUP(7, SPIM1),\n\tMFIO_PIN_GROUP(8, SPIM0),\n\tMFIO_PIN_GROUP(9, SPIM0),\n\tMFIO_PIN_GROUP(10, SPIM0),\n\tMFIO_PIN_GROUP(11, SPIS),\n\tMFIO_PIN_GROUP(12, SPIS),\n\tMFIO_PIN_GROUP(13, SPIS),\n\tMFIO_PIN_GROUP(14, SPIS),\n\tMFIO_MUX_PIN_GROUP(15, SDHOST, MIPS_TRACE_CLK, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT0, 4, 0x3),\n\tMFIO_MUX_PIN_GROUP(16, SDHOST, MIPS_TRACE_DINT, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT0, 6, 0x3),\n\tMFIO_MUX_PIN_GROUP(17, SDHOST, MIPS_TRACE_TRIGOUT, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT0, 8, 0x3),\n\tMFIO_MUX_PIN_GROUP(18, SDHOST, MIPS_TRACE_TRIGIN, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT0, 10, 0x3),\n\tMFIO_MUX_PIN_GROUP(19, SDHOST, MIPS_TRACE_DM, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT0, 12, 0x3),\n\tMFIO_MUX_PIN_GROUP(20, SDHOST, MIPS_TRACE_PROBE_N, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT0, 14, 0x3),\n\tMFIO_MUX_PIN_GROUP(21, SDHOST, NONE, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT0, 16, 0x3),\n\tMFIO_MUX_PIN_GROUP(22, SDHOST, NONE, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT0, 18, 0x3),\n\tMFIO_PIN_GROUP(23, SDHOST),\n\tMFIO_PIN_GROUP(24, SDHOST),\n\tMFIO_PIN_GROUP(25, SDHOST),\n\tMFIO_PIN_GROUP(26, SDHOST),\n\tMFIO_PIN_GROUP(27, SDHOST),\n\tMFIO_MUX_PIN_GROUP(28, I2C0, SPIM0, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 20, 0x1),\n\tMFIO_MUX_PIN_GROUP(29, I2C0, SPIM0, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 21, 0x1),\n\tMFIO_MUX_PIN_GROUP(30, I2C1, SPIM0, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 22, 0x1),\n\tMFIO_MUX_PIN_GROUP(31, I2C1, SPIM1, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 23, 0x1),\n\tMFIO_PIN_GROUP(32, I2C2),\n\tMFIO_PIN_GROUP(33, I2C2),\n\tMFIO_PIN_GROUP(34, I2C3),\n\tMFIO_PIN_GROUP(35, I2C3),\n\tMFIO_MUX_PIN_GROUP(36, I2S_OUT, AUDIO_CLK_IN, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 24, 0x1),\n\tMFIO_MUX_PIN_GROUP(37, I2S_OUT, DEBUG_RAW_CCA_IND, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 25, 0x1),\n\tMFIO_MUX_PIN_GROUP(38, I2S_OUT, DEBUG_ED_SEC20_CCA_IND, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 26, 0x1),\n\tMFIO_MUX_PIN_GROUP(39, I2S_OUT, DEBUG_ED_SEC40_CCA_IND, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 27, 0x1),\n\tMFIO_MUX_PIN_GROUP(40, I2S_OUT, DEBUG_AGC_DONE_0, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 28, 0x1),\n\tMFIO_MUX_PIN_GROUP(41, I2S_OUT, DEBUG_AGC_DONE_1, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 29, 0x1),\n\tMFIO_MUX_PIN_GROUP(42, I2S_OUT, DEBUG_ED_CCA_IND, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 30, 0x1),\n\tMFIO_MUX_PIN_GROUP(43, I2S_OUT, DEBUG_S2L_DONE, NONE,\n\t\t\t   PADS_FUNCTION_SELECT0, 31, 0x1),\n\tMFIO_PIN_GROUP(44, I2S_OUT),\n\tMFIO_MUX_PIN_GROUP(45, I2S_DAC_CLK, AUDIO_SYNC, NONE,\n\t\t\t   PADS_FUNCTION_SELECT1, 0, 0x1),\n\tMFIO_PIN_GROUP(46, AUDIO_TRIGGER),\n\tMFIO_PIN_GROUP(47, I2S_IN),\n\tMFIO_PIN_GROUP(48, I2S_IN),\n\tMFIO_PIN_GROUP(49, I2S_IN),\n\tMFIO_PIN_GROUP(50, I2S_IN),\n\tMFIO_PIN_GROUP(51, I2S_IN),\n\tMFIO_PIN_GROUP(52, I2S_IN),\n\tMFIO_PIN_GROUP(53, I2S_IN),\n\tMFIO_MUX_PIN_GROUP(54, I2S_IN, NONE, SPDIF_IN,\n\t\t\t   PADS_FUNCTION_SELECT1, 1, 0x3),\n\tMFIO_MUX_PIN_GROUP(55, UART0, SPIM0, SPIM1,\n\t\t\t   PADS_FUNCTION_SELECT1, 3, 0x3),\n\tMFIO_MUX_PIN_GROUP(56, UART0, SPIM0, SPIM1,\n\t\t\t   PADS_FUNCTION_SELECT1, 5, 0x3),\n\tMFIO_MUX_PIN_GROUP(57, UART0, SPIM0, SPIM1,\n\t\t\t   PADS_FUNCTION_SELECT1, 7, 0x3),\n\tMFIO_MUX_PIN_GROUP(58, UART0, SPIM1, NONE,\n\t\t\t   PADS_FUNCTION_SELECT1, 9, 0x1),\n\tMFIO_PIN_GROUP(59, UART1),\n\tMFIO_PIN_GROUP(60, UART1),\n\tMFIO_PIN_GROUP(61, SPDIF_OUT),\n\tMFIO_PIN_GROUP(62, SPDIF_IN),\n\tMFIO_MUX_PIN_GROUP(63, ETH, MIPS_TRACE_CLK, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT1, 10, 0x3),\n\tMFIO_MUX_PIN_GROUP(64, ETH, MIPS_TRACE_DINT, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT1, 12, 0x3),\n\tMFIO_MUX_PIN_GROUP(65, ETH, MIPS_TRACE_TRIGOUT, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT1, 14, 0x3),\n\tMFIO_MUX_PIN_GROUP(66, ETH, MIPS_TRACE_TRIGIN, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT1, 16, 0x3),\n\tMFIO_MUX_PIN_GROUP(67, ETH, MIPS_TRACE_DM, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT1, 18, 0x3),\n\tMFIO_MUX_PIN_GROUP(68, ETH, MIPS_TRACE_PROBE_N, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT1, 20, 0x3),\n\tMFIO_MUX_PIN_GROUP(69, ETH, NONE, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT1, 22, 0x3),\n\tMFIO_MUX_PIN_GROUP(70, ETH, NONE, MIPS_TRACE_DATA,\n\t\t\t   PADS_FUNCTION_SELECT1, 24, 0x3),\n\tMFIO_PIN_GROUP(71, ETH),\n\tMFIO_PIN_GROUP(72, IR),\n\tMFIO_MUX_PIN_GROUP(73, PWMPDM, MIPS_TRACE_CLK, SRAM_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT1, 26, 0x3),\n\tMFIO_MUX_PIN_GROUP(74, PWMPDM, MIPS_TRACE_DINT, SRAM_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT1, 28, 0x3),\n\tMFIO_MUX_PIN_GROUP(75, PWMPDM, MIPS_TRACE_TRIGOUT, ROM_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT1, 30, 0x3),\n\tMFIO_MUX_PIN_GROUP(76, PWMPDM, MIPS_TRACE_TRIGIN, ROM_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 0, 0x3),\n\tMFIO_MUX_PIN_GROUP(77, MDC_DEBUG, MIPS_TRACE_DM, RPU_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 2, 0x3),\n\tMFIO_MUX_PIN_GROUP(78, MDC_DEBUG, MIPS_TRACE_PROBE_N, RPU_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 4, 0x3),\n\tMFIO_MUX_PIN_GROUP(79, DDR_DEBUG, MIPS_TRACE_DATA, MIPS_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 6, 0x3),\n\tMFIO_MUX_PIN_GROUP(80, DDR_DEBUG, MIPS_TRACE_DATA, MIPS_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 8, 0x3),\n\tMFIO_MUX_PIN_GROUP(81, DREQ0, MIPS_TRACE_DATA, ETH_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 10, 0x3),\n\tMFIO_MUX_PIN_GROUP(82, DREQ1, MIPS_TRACE_DATA, ETH_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 12, 0x3),\n\tMFIO_MUX_PIN_GROUP(83, MIPS_PLL_LOCK, MIPS_TRACE_DATA, USB_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 14, 0x3),\n\tMFIO_MUX_PIN_GROUP(84, AUDIO_PLL_LOCK, MIPS_TRACE_DATA, USB_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 16, 0x3),\n\tMFIO_MUX_PIN_GROUP(85, RPU_V_PLL_LOCK, MIPS_TRACE_DATA, SDHOST_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 18, 0x3),\n\tMFIO_MUX_PIN_GROUP(86, RPU_L_PLL_LOCK, MIPS_TRACE_DATA, SDHOST_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 20, 0x3),\n\tMFIO_MUX_PIN_GROUP(87, SYS_PLL_LOCK, DREQ2, SOCIF_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 22, 0x3),\n\tMFIO_MUX_PIN_GROUP(88, WIFI_PLL_LOCK, DREQ3, SOCIF_DEBUG,\n\t\t\t   PADS_FUNCTION_SELECT2, 24, 0x3),\n\tMFIO_MUX_PIN_GROUP(89, BT_PLL_LOCK, DREQ4, DREQ5,\n\t\t\t   PADS_FUNCTION_SELECT2, 26, 0x3),\n\tPIN_GROUP(TCK, \"tck\"),\n\tPIN_GROUP(TRSTN, \"trstn\"),\n\tPIN_GROUP(TDI, \"tdi\"),\n\tPIN_GROUP(TMS, \"tms\"),\n\tPIN_GROUP(TDO, \"tdo\"),\n\tPIN_GROUP(JTAG_COMPLY, \"jtag_comply\"),\n\tPIN_GROUP(SAFE_MODE, \"safe_mode\"),\n\tPIN_GROUP(POR_DISABLE, \"por_disable\"),\n\tPIN_GROUP(RESETN, \"resetn\"),\n};\n\nstatic inline u32 pctl_readl(struct pistachio_pinctrl *pctl, u32 reg)\n{\n\treturn readl(pctl->base + reg);\n}\n\nstatic inline void pctl_writel(struct pistachio_pinctrl *pctl, u32 val, u32 reg)\n{\n\twritel(val, pctl->base + reg);\n}\n\nstatic inline struct pistachio_gpio_bank *irqd_to_bank(struct irq_data *d)\n{\n\treturn gpiochip_get_data(irq_data_get_irq_chip_data(d));\n}\n\nstatic inline u32 gpio_readl(struct pistachio_gpio_bank *bank, u32 reg)\n{\n\treturn readl(bank->base + reg);\n}\n\nstatic inline void gpio_writel(struct pistachio_gpio_bank *bank, u32 val,\n\t\t\t       u32 reg)\n{\n\twritel(val, bank->base + reg);\n}\n\nstatic inline void gpio_mask_writel(struct pistachio_gpio_bank *bank,\n\t\t\t\t    u32 reg, unsigned int bit, u32 val)\n{\n\t \n\tgpio_writel(bank, (0x10000 | val) << bit, reg);\n}\n\nstatic inline void gpio_enable(struct pistachio_gpio_bank *bank,\n\t\t\t       unsigned offset)\n{\n\tgpio_mask_writel(bank, GPIO_BIT_EN, offset, 1);\n}\n\nstatic inline void gpio_disable(struct pistachio_gpio_bank *bank,\n\t\t\t\tunsigned offset)\n{\n\tgpio_mask_writel(bank, GPIO_BIT_EN, offset, 0);\n}\n\nstatic int pistachio_pinctrl_get_groups_count(struct pinctrl_dev *pctldev)\n{\n\tstruct pistachio_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\n\n\treturn pctl->ngroups;\n}\n\nstatic const char *pistachio_pinctrl_get_group_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t\t    unsigned group)\n{\n\tstruct pistachio_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\n\n\treturn pctl->groups[group].name;\n}\n\nstatic int pistachio_pinctrl_get_group_pins(struct pinctrl_dev *pctldev,\n\t\t\t\t\t    unsigned group,\n\t\t\t\t\t    const unsigned **pins,\n\t\t\t\t\t    unsigned *num_pins)\n{\n\tstruct pistachio_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\n\n\t*pins = &pctl->groups[group].pin;\n\t*num_pins = 1;\n\n\treturn 0;\n}\n\nstatic const struct pinctrl_ops pistachio_pinctrl_ops = {\n\t.get_groups_count = pistachio_pinctrl_get_groups_count,\n\t.get_group_name = pistachio_pinctrl_get_group_name,\n\t.get_group_pins = pistachio_pinctrl_get_group_pins,\n\t.dt_node_to_map = pinconf_generic_dt_node_to_map_pin,\n\t.dt_free_map = pinctrl_utils_free_map,\n};\n\nstatic int pistachio_pinmux_get_functions_count(struct pinctrl_dev *pctldev)\n{\n\tstruct pistachio_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\n\n\treturn pctl->nfunctions;\n}\n\nstatic const char *\npistachio_pinmux_get_function_name(struct pinctrl_dev *pctldev, unsigned func)\n{\n\tstruct pistachio_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\n\n\treturn pctl->functions[func].name;\n}\n\nstatic int pistachio_pinmux_get_function_groups(struct pinctrl_dev *pctldev,\n\t\t\t\t\t\tunsigned func,\n\t\t\t\t\t\tconst char * const **groups,\n\t\t\t\t\t\tunsigned * const num_groups)\n{\n\tstruct pistachio_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\n\n\t*groups = pctl->functions[func].groups;\n\t*num_groups = pctl->functions[func].ngroups;\n\n\treturn 0;\n}\n\nstatic int pistachio_pinmux_enable(struct pinctrl_dev *pctldev,\n\t\t\t\t   unsigned func, unsigned group)\n{\n\tstruct pistachio_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\n\tconst struct pistachio_pin_group *pg = &pctl->groups[group];\n\tconst struct pistachio_function *pf = &pctl->functions[func];\n\tstruct pinctrl_gpio_range *range;\n\tunsigned int i;\n\tu32 val;\n\n\tif (pg->mux_reg > 0) {\n\t\tfor (i = 0; i < ARRAY_SIZE(pg->mux_option); i++) {\n\t\t\tif (pg->mux_option[i] == func)\n\t\t\t\tbreak;\n\t\t}\n\t\tif (i == ARRAY_SIZE(pg->mux_option)) {\n\t\t\tdev_err(pctl->dev, \"Cannot mux pin %u to function %u\\n\",\n\t\t\t\tgroup, func);\n\t\t\treturn -EINVAL;\n\t\t}\n\n\t\tval = pctl_readl(pctl, pg->mux_reg);\n\t\tval &= ~(pg->mux_mask << pg->mux_shift);\n\t\tval |= i << pg->mux_shift;\n\t\tpctl_writel(pctl, val, pg->mux_reg);\n\n\t\tif (pf->scenarios) {\n\t\t\tfor (i = 0; i < pf->nscenarios; i++) {\n\t\t\t\tif (pf->scenarios[i] == group)\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (WARN_ON(i == pf->nscenarios))\n\t\t\t\treturn -EINVAL;\n\n\t\t\tval = pctl_readl(pctl, pf->scenario_reg);\n\t\t\tval &= ~(pf->scenario_mask << pf->scenario_shift);\n\t\t\tval |= i << pf->scenario_shift;\n\t\t\tpctl_writel(pctl, val, pf->scenario_reg);\n\t\t}\n\t}\n\n\trange = pinctrl_find_gpio_range_from_pin(pctl->pctldev, pg->pin);\n\tif (range)\n\t\tgpio_disable(gpiochip_get_data(range->gc), pg->pin - range->pin_base);\n\n\treturn 0;\n}\n\nstatic const struct pinmux_ops pistachio_pinmux_ops = {\n\t.get_functions_count = pistachio_pinmux_get_functions_count,\n\t.get_function_name = pistachio_pinmux_get_function_name,\n\t.get_function_groups = pistachio_pinmux_get_function_groups,\n\t.set_mux = pistachio_pinmux_enable,\n};\n\nstatic int pistachio_pinconf_get(struct pinctrl_dev *pctldev, unsigned pin,\n\t\t\t\t unsigned long *config)\n{\n\tstruct pistachio_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\n\tenum pin_config_param param = pinconf_to_config_param(*config);\n\tu32 val, arg;\n\n\tswitch (param) {\n\tcase PIN_CONFIG_INPUT_SCHMITT_ENABLE:\n\t\tval = pctl_readl(pctl, PADS_SCHMITT_EN_REG(pin));\n\t\targ = !!(val & PADS_SCHMITT_EN_BIT(pin));\n\t\tbreak;\n\tcase PIN_CONFIG_BIAS_HIGH_IMPEDANCE:\n\t\tval = pctl_readl(pctl, PADS_PU_PD_REG(pin)) >>\n\t\t\tPADS_PU_PD_SHIFT(pin);\n\t\targ = (val & PADS_PU_PD_MASK) == PADS_PU_PD_HIGHZ;\n\t\tbreak;\n\tcase PIN_CONFIG_BIAS_PULL_UP:\n\t\tval = pctl_readl(pctl, PADS_PU_PD_REG(pin)) >>\n\t\t\tPADS_PU_PD_SHIFT(pin);\n\t\targ = (val & PADS_PU_PD_MASK) == PADS_PU_PD_UP;\n\t\tbreak;\n\tcase PIN_CONFIG_BIAS_PULL_DOWN:\n\t\tval = pctl_readl(pctl, PADS_PU_PD_REG(pin)) >>\n\t\t\tPADS_PU_PD_SHIFT(pin);\n\t\targ = (val & PADS_PU_PD_MASK) == PADS_PU_PD_DOWN;\n\t\tbreak;\n\tcase PIN_CONFIG_BIAS_BUS_HOLD:\n\t\tval = pctl_readl(pctl, PADS_PU_PD_REG(pin)) >>\n\t\t\tPADS_PU_PD_SHIFT(pin);\n\t\targ = (val & PADS_PU_PD_MASK) == PADS_PU_PD_BUS;\n\t\tbreak;\n\tcase PIN_CONFIG_SLEW_RATE:\n\t\tval = pctl_readl(pctl, PADS_SLEW_RATE_REG(pin));\n\t\targ = !!(val & PADS_SLEW_RATE_BIT(pin));\n\t\tbreak;\n\tcase PIN_CONFIG_DRIVE_STRENGTH:\n\t\tval = pctl_readl(pctl, PADS_DRIVE_STRENGTH_REG(pin)) >>\n\t\t\tPADS_DRIVE_STRENGTH_SHIFT(pin);\n\t\tswitch (val & PADS_DRIVE_STRENGTH_MASK) {\n\t\tcase PADS_DRIVE_STRENGTH_2MA:\n\t\t\targ = 2;\n\t\t\tbreak;\n\t\tcase PADS_DRIVE_STRENGTH_4MA:\n\t\t\targ = 4;\n\t\t\tbreak;\n\t\tcase PADS_DRIVE_STRENGTH_8MA:\n\t\t\targ = 8;\n\t\t\tbreak;\n\t\tcase PADS_DRIVE_STRENGTH_12MA:\n\t\tdefault:\n\t\t\targ = 12;\n\t\t\tbreak;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tdev_dbg(pctl->dev, \"Property %u not supported\\n\", param);\n\t\treturn -ENOTSUPP;\n\t}\n\n\t*config = pinconf_to_config_packed(param, arg);\n\n\treturn 0;\n}\n\nstatic int pistachio_pinconf_set(struct pinctrl_dev *pctldev, unsigned pin,\n\t\t\t\t unsigned long *configs, unsigned num_configs)\n{\n\tstruct pistachio_pinctrl *pctl = pinctrl_dev_get_drvdata(pctldev);\n\tenum pin_config_param param;\n\tu32 drv, val, arg;\n\tunsigned int i;\n\n\tfor (i = 0; i < num_configs; i++) {\n\t\tparam = pinconf_to_config_param(configs[i]);\n\t\targ = pinconf_to_config_argument(configs[i]);\n\n\t\tswitch (param) {\n\t\tcase PIN_CONFIG_INPUT_SCHMITT_ENABLE:\n\t\t\tval = pctl_readl(pctl, PADS_SCHMITT_EN_REG(pin));\n\t\t\tif (arg)\n\t\t\t\tval |= PADS_SCHMITT_EN_BIT(pin);\n\t\t\telse\n\t\t\t\tval &= ~PADS_SCHMITT_EN_BIT(pin);\n\t\t\tpctl_writel(pctl, val, PADS_SCHMITT_EN_REG(pin));\n\t\t\tbreak;\n\t\tcase PIN_CONFIG_BIAS_HIGH_IMPEDANCE:\n\t\t\tval = pctl_readl(pctl, PADS_PU_PD_REG(pin));\n\t\t\tval &= ~(PADS_PU_PD_MASK << PADS_PU_PD_SHIFT(pin));\n\t\t\tval |= PADS_PU_PD_HIGHZ << PADS_PU_PD_SHIFT(pin);\n\t\t\tpctl_writel(pctl, val, PADS_PU_PD_REG(pin));\n\t\t\tbreak;\n\t\tcase PIN_CONFIG_BIAS_PULL_UP:\n\t\t\tval = pctl_readl(pctl, PADS_PU_PD_REG(pin));\n\t\t\tval &= ~(PADS_PU_PD_MASK << PADS_PU_PD_SHIFT(pin));\n\t\t\tval |= PADS_PU_PD_UP << PADS_PU_PD_SHIFT(pin);\n\t\t\tpctl_writel(pctl, val, PADS_PU_PD_REG(pin));\n\t\t\tbreak;\n\t\tcase PIN_CONFIG_BIAS_PULL_DOWN:\n\t\t\tval = pctl_readl(pctl, PADS_PU_PD_REG(pin));\n\t\t\tval &= ~(PADS_PU_PD_MASK << PADS_PU_PD_SHIFT(pin));\n\t\t\tval |= PADS_PU_PD_DOWN << PADS_PU_PD_SHIFT(pin);\n\t\t\tpctl_writel(pctl, val, PADS_PU_PD_REG(pin));\n\t\t\tbreak;\n\t\tcase PIN_CONFIG_BIAS_BUS_HOLD:\n\t\t\tval = pctl_readl(pctl, PADS_PU_PD_REG(pin));\n\t\t\tval &= ~(PADS_PU_PD_MASK << PADS_PU_PD_SHIFT(pin));\n\t\t\tval |= PADS_PU_PD_BUS << PADS_PU_PD_SHIFT(pin);\n\t\t\tpctl_writel(pctl, val, PADS_PU_PD_REG(pin));\n\t\t\tbreak;\n\t\tcase PIN_CONFIG_SLEW_RATE:\n\t\t\tval = pctl_readl(pctl, PADS_SLEW_RATE_REG(pin));\n\t\t\tif (arg)\n\t\t\t\tval |= PADS_SLEW_RATE_BIT(pin);\n\t\t\telse\n\t\t\t\tval &= ~PADS_SLEW_RATE_BIT(pin);\n\t\t\tpctl_writel(pctl, val, PADS_SLEW_RATE_REG(pin));\n\t\t\tbreak;\n\t\tcase PIN_CONFIG_DRIVE_STRENGTH:\n\t\t\tval = pctl_readl(pctl, PADS_DRIVE_STRENGTH_REG(pin));\n\t\t\tval &= ~(PADS_DRIVE_STRENGTH_MASK <<\n\t\t\t\t PADS_DRIVE_STRENGTH_SHIFT(pin));\n\t\t\tswitch (arg) {\n\t\t\tcase 2:\n\t\t\t\tdrv = PADS_DRIVE_STRENGTH_2MA;\n\t\t\t\tbreak;\n\t\t\tcase 4:\n\t\t\t\tdrv = PADS_DRIVE_STRENGTH_4MA;\n\t\t\t\tbreak;\n\t\t\tcase 8:\n\t\t\t\tdrv = PADS_DRIVE_STRENGTH_8MA;\n\t\t\t\tbreak;\n\t\t\tcase 12:\n\t\t\t\tdrv = PADS_DRIVE_STRENGTH_12MA;\n\t\t\t\tbreak;\n\t\t\tdefault:\n\t\t\t\tdev_err(pctl->dev,\n\t\t\t\t\t\"Drive strength %umA not supported\\n\",\n\t\t\t\t\targ);\n\t\t\t\treturn -EINVAL;\n\t\t\t}\n\t\t\tval |= drv << PADS_DRIVE_STRENGTH_SHIFT(pin);\n\t\t\tpctl_writel(pctl, val, PADS_DRIVE_STRENGTH_REG(pin));\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tdev_err(pctl->dev, \"Property %u not supported\\n\",\n\t\t\t\tparam);\n\t\t\treturn -ENOTSUPP;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic const struct pinconf_ops pistachio_pinconf_ops = {\n\t.pin_config_get = pistachio_pinconf_get,\n\t.pin_config_set = pistachio_pinconf_set,\n\t.is_generic = true,\n};\n\nstatic struct pinctrl_desc pistachio_pinctrl_desc = {\n\t.name = \"pistachio-pinctrl\",\n\t.pctlops = &pistachio_pinctrl_ops,\n\t.pmxops = &pistachio_pinmux_ops,\n\t.confops = &pistachio_pinconf_ops,\n};\n\nstatic int pistachio_gpio_get_direction(struct gpio_chip *chip, unsigned offset)\n{\n\tstruct pistachio_gpio_bank *bank = gpiochip_get_data(chip);\n\n\tif (gpio_readl(bank, GPIO_OUTPUT_EN) & BIT(offset))\n\t\treturn GPIO_LINE_DIRECTION_OUT;\n\n\treturn GPIO_LINE_DIRECTION_IN;\n}\n\nstatic int pistachio_gpio_get(struct gpio_chip *chip, unsigned offset)\n{\n\tstruct pistachio_gpio_bank *bank = gpiochip_get_data(chip);\n\tu32 reg;\n\n\tif (gpio_readl(bank, GPIO_OUTPUT_EN) & BIT(offset))\n\t\treg = GPIO_OUTPUT;\n\telse\n\t\treg = GPIO_INPUT;\n\n\treturn !!(gpio_readl(bank, reg) & BIT(offset));\n}\n\nstatic void pistachio_gpio_set(struct gpio_chip *chip, unsigned offset,\n\t\t\t       int value)\n{\n\tstruct pistachio_gpio_bank *bank = gpiochip_get_data(chip);\n\n\tgpio_mask_writel(bank, GPIO_OUTPUT, offset, !!value);\n}\n\nstatic int pistachio_gpio_direction_input(struct gpio_chip *chip,\n\t\t\t\t\t  unsigned offset)\n{\n\tstruct pistachio_gpio_bank *bank = gpiochip_get_data(chip);\n\n\tgpio_mask_writel(bank, GPIO_OUTPUT_EN, offset, 0);\n\tgpio_enable(bank, offset);\n\n\treturn 0;\n}\n\nstatic int pistachio_gpio_direction_output(struct gpio_chip *chip,\n\t\t\t\t\t   unsigned offset, int value)\n{\n\tstruct pistachio_gpio_bank *bank = gpiochip_get_data(chip);\n\n\tpistachio_gpio_set(chip, offset, value);\n\tgpio_mask_writel(bank, GPIO_OUTPUT_EN, offset, 1);\n\tgpio_enable(bank, offset);\n\n\treturn 0;\n}\n\nstatic void pistachio_gpio_irq_ack(struct irq_data *data)\n{\n\tstruct pistachio_gpio_bank *bank = irqd_to_bank(data);\n\n\tgpio_mask_writel(bank, GPIO_INTERRUPT_STATUS, data->hwirq, 0);\n}\n\nstatic void pistachio_gpio_irq_mask(struct irq_data *data)\n{\n\tstruct pistachio_gpio_bank *bank = irqd_to_bank(data);\n\n\tgpio_mask_writel(bank, GPIO_INTERRUPT_EN, data->hwirq, 0);\n\tgpiochip_disable_irq(&bank->gpio_chip, irqd_to_hwirq(data));\n}\n\nstatic void pistachio_gpio_irq_unmask(struct irq_data *data)\n{\n\tstruct pistachio_gpio_bank *bank = irqd_to_bank(data);\n\n\tgpiochip_enable_irq(&bank->gpio_chip, irqd_to_hwirq(data));\n\tgpio_mask_writel(bank, GPIO_INTERRUPT_EN, data->hwirq, 1);\n}\n\nstatic unsigned int pistachio_gpio_irq_startup(struct irq_data *data)\n{\n\tstruct gpio_chip *chip = irq_data_get_irq_chip_data(data);\n\n\tpistachio_gpio_direction_input(chip, data->hwirq);\n\tpistachio_gpio_irq_unmask(data);\n\n\treturn 0;\n}\n\nstatic int pistachio_gpio_irq_set_type(struct irq_data *data, unsigned int type)\n{\n\tstruct pistachio_gpio_bank *bank = irqd_to_bank(data);\n\n\tswitch (type & IRQ_TYPE_SENSE_MASK) {\n\tcase IRQ_TYPE_EDGE_RISING:\n\t\tgpio_mask_writel(bank, GPIO_INPUT_POLARITY, data->hwirq, 1);\n\t\tgpio_mask_writel(bank, GPIO_INTERRUPT_TYPE, data->hwirq,\n\t\t\t\t GPIO_INTERRUPT_TYPE_EDGE);\n\t\tgpio_mask_writel(bank, GPIO_INTERRUPT_EDGE, data->hwirq,\n\t\t\t\t GPIO_INTERRUPT_EDGE_SINGLE);\n\t\tbreak;\n\tcase IRQ_TYPE_EDGE_FALLING:\n\t\tgpio_mask_writel(bank, GPIO_INPUT_POLARITY, data->hwirq, 0);\n\t\tgpio_mask_writel(bank, GPIO_INTERRUPT_TYPE, data->hwirq,\n\t\t\t\t GPIO_INTERRUPT_TYPE_EDGE);\n\t\tgpio_mask_writel(bank, GPIO_INTERRUPT_EDGE, data->hwirq,\n\t\t\t\t GPIO_INTERRUPT_EDGE_SINGLE);\n\t\tbreak;\n\tcase IRQ_TYPE_EDGE_BOTH:\n\t\tgpio_mask_writel(bank, GPIO_INTERRUPT_TYPE, data->hwirq,\n\t\t\t\t GPIO_INTERRUPT_TYPE_EDGE);\n\t\tgpio_mask_writel(bank, GPIO_INTERRUPT_EDGE, data->hwirq,\n\t\t\t\t GPIO_INTERRUPT_EDGE_DUAL);\n\t\tbreak;\n\tcase IRQ_TYPE_LEVEL_HIGH:\n\t\tgpio_mask_writel(bank, GPIO_INPUT_POLARITY, data->hwirq, 1);\n\t\tgpio_mask_writel(bank, GPIO_INTERRUPT_TYPE, data->hwirq,\n\t\t\t\t GPIO_INTERRUPT_TYPE_LEVEL);\n\t\tbreak;\n\tcase IRQ_TYPE_LEVEL_LOW:\n\t\tgpio_mask_writel(bank, GPIO_INPUT_POLARITY, data->hwirq, 0);\n\t\tgpio_mask_writel(bank, GPIO_INTERRUPT_TYPE, data->hwirq,\n\t\t\t\t GPIO_INTERRUPT_TYPE_LEVEL);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\n\tif (type & IRQ_TYPE_LEVEL_MASK)\n\t\tirq_set_handler_locked(data, handle_level_irq);\n\telse\n\t\tirq_set_handler_locked(data, handle_edge_irq);\n\n\treturn 0;\n}\n\nstatic void pistachio_gpio_irq_handler(struct irq_desc *desc)\n{\n\tstruct gpio_chip *gc = irq_desc_get_handler_data(desc);\n\tstruct pistachio_gpio_bank *bank = gpiochip_get_data(gc);\n\tstruct irq_chip *chip = irq_desc_get_chip(desc);\n\tunsigned long pending;\n\tunsigned int pin;\n\n\tchained_irq_enter(chip, desc);\n\tpending = gpio_readl(bank, GPIO_INTERRUPT_STATUS) &\n\t\tgpio_readl(bank, GPIO_INTERRUPT_EN);\n\tfor_each_set_bit(pin, &pending, 16)\n\t\tgeneric_handle_domain_irq(gc->irq.domain, pin);\n\tchained_irq_exit(chip, desc);\n}\n\n#define GPIO_BANK(_bank, _pin_base, _npins)\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.instance = (_bank),\t\t\t\t\t\\\n\t\t.pin_base = _pin_base,\t\t\t\t\t\\\n\t\t.npins = _npins,\t\t\t\t\t\\\n\t\t.gpio_chip = {\t\t\t\t\t\t\\\n\t\t\t.label = \"GPIO\" #_bank,\t\t\t\t\\\n\t\t\t.request = gpiochip_generic_request,\t\t\\\n\t\t\t.free = gpiochip_generic_free,\t\t\t\\\n\t\t\t.get_direction = pistachio_gpio_get_direction,\t\\\n\t\t\t.direction_input = pistachio_gpio_direction_input, \\\n\t\t\t.direction_output = pistachio_gpio_direction_output, \\\n\t\t\t.get = pistachio_gpio_get,\t\t\t\\\n\t\t\t.set = pistachio_gpio_set,\t\t\t\\\n\t\t\t.base = _pin_base,\t\t\t\t\\\n\t\t\t.ngpio = _npins,\t\t\t\t\\\n\t\t},\t\t\t\t\t\t\t\\\n\t}\n\nstatic struct pistachio_gpio_bank pistachio_gpio_banks[] = {\n\tGPIO_BANK(0, PISTACHIO_PIN_MFIO(0), 16),\n\tGPIO_BANK(1, PISTACHIO_PIN_MFIO(16), 16),\n\tGPIO_BANK(2, PISTACHIO_PIN_MFIO(32), 16),\n\tGPIO_BANK(3, PISTACHIO_PIN_MFIO(48), 16),\n\tGPIO_BANK(4, PISTACHIO_PIN_MFIO(64), 16),\n\tGPIO_BANK(5, PISTACHIO_PIN_MFIO(80), 10),\n};\n\nstatic void pistachio_gpio_irq_print_chip(struct irq_data *data,\n\t\t\t\t\t  struct seq_file *p)\n{\n\tstruct pistachio_gpio_bank *bank = irqd_to_bank(data);\n\n\tseq_printf(p, \"GPIO%d\", bank->instance);\n}\n\nstatic const struct irq_chip pistachio_gpio_irq_chip = {\n\t.irq_startup = pistachio_gpio_irq_startup,\n\t.irq_ack = pistachio_gpio_irq_ack,\n\t.irq_mask = pistachio_gpio_irq_mask,\n\t.irq_unmask = pistachio_gpio_irq_unmask,\n\t.irq_set_type = pistachio_gpio_irq_set_type,\n\t.irq_print_chip = pistachio_gpio_irq_print_chip,\n\t.flags = IRQCHIP_IMMUTABLE,\n\tGPIOCHIP_IRQ_RESOURCE_HELPERS,\n};\n\nstatic int pistachio_gpio_register(struct pistachio_pinctrl *pctl)\n{\n\tstruct pistachio_gpio_bank *bank;\n\tunsigned int i;\n\tint irq, ret = 0;\n\n\tfor (i = 0; i < pctl->nbanks; i++) {\n\t\tchar child_name[sizeof(\"gpioXX\")];\n\t\tstruct fwnode_handle *child;\n\t\tstruct gpio_irq_chip *girq;\n\n\t\tsnprintf(child_name, sizeof(child_name), \"gpio%d\", i);\n\t\tchild = device_get_named_child_node(pctl->dev, child_name);\n\t\tif (!child) {\n\t\t\tdev_err(pctl->dev, \"No node for bank %u\\n\", i);\n\t\t\tret = -ENODEV;\n\t\t\tgoto err;\n\t\t}\n\n\t\tif (!fwnode_property_present(child, \"gpio-controller\")) {\n\t\t\tfwnode_handle_put(child);\n\t\t\tdev_err(pctl->dev,\n\t\t\t\t\"No gpio-controller property for bank %u\\n\", i);\n\t\t\tret = -ENODEV;\n\t\t\tgoto err;\n\t\t}\n\n\t\tret = fwnode_irq_get(child, 0);\n\t\tif (ret < 0) {\n\t\t\tfwnode_handle_put(child);\n\t\t\tdev_err(pctl->dev, \"Failed to retrieve IRQ for bank %u\\n\", i);\n\t\t\tgoto err;\n\t\t}\n\t\tif (!ret) {\n\t\t\tfwnode_handle_put(child);\n\t\t\tdev_err(pctl->dev, \"No IRQ for bank %u\\n\", i);\n\t\t\tret = -EINVAL;\n\t\t\tgoto err;\n\t\t}\n\t\tirq = ret;\n\n\t\tbank = &pctl->gpio_banks[i];\n\t\tbank->pctl = pctl;\n\t\tbank->base = pctl->base + GPIO_BANK_BASE(i);\n\n\t\tbank->gpio_chip.parent = pctl->dev;\n\t\tbank->gpio_chip.fwnode = child;\n\n\t\tgirq = &bank->gpio_chip.irq;\n\t\tgpio_irq_chip_set_chip(girq, &pistachio_gpio_irq_chip);\n\t\tgirq->parent_handler = pistachio_gpio_irq_handler;\n\t\tgirq->num_parents = 1;\n\t\tgirq->parents = devm_kcalloc(pctl->dev, 1,\n\t\t\t\t\t     sizeof(*girq->parents),\n\t\t\t\t\t     GFP_KERNEL);\n\t\tif (!girq->parents) {\n\t\t\tret = -ENOMEM;\n\t\t\tgoto err;\n\t\t}\n\t\tgirq->parents[0] = irq;\n\t\tgirq->default_type = IRQ_TYPE_NONE;\n\t\tgirq->handler = handle_level_irq;\n\n\t\tret = gpiochip_add_data(&bank->gpio_chip, bank);\n\t\tif (ret < 0) {\n\t\t\tdev_err(pctl->dev, \"Failed to add GPIO chip %u: %d\\n\",\n\t\t\t\ti, ret);\n\t\t\tgoto err;\n\t\t}\n\n\t\tret = gpiochip_add_pin_range(&bank->gpio_chip,\n\t\t\t\t\t     dev_name(pctl->dev), 0,\n\t\t\t\t\t     bank->pin_base, bank->npins);\n\t\tif (ret < 0) {\n\t\t\tdev_err(pctl->dev, \"Failed to add GPIO range %u: %d\\n\",\n\t\t\t\ti, ret);\n\t\t\tgpiochip_remove(&bank->gpio_chip);\n\t\t\tgoto err;\n\t\t}\n\t}\n\n\treturn 0;\nerr:\n\tfor (; i > 0; i--) {\n\t\tbank = &pctl->gpio_banks[i - 1];\n\t\tgpiochip_remove(&bank->gpio_chip);\n\t}\n\treturn ret;\n}\n\nstatic const struct of_device_id pistachio_pinctrl_of_match[] = {\n\t{ .compatible = \"img,pistachio-system-pinctrl\", },\n\t{ },\n};\n\nstatic int pistachio_pinctrl_probe(struct platform_device *pdev)\n{\n\tstruct pistachio_pinctrl *pctl;\n\n\tpctl = devm_kzalloc(&pdev->dev, sizeof(*pctl), GFP_KERNEL);\n\tif (!pctl)\n\t\treturn -ENOMEM;\n\tpctl->dev = &pdev->dev;\n\tdev_set_drvdata(&pdev->dev, pctl);\n\n\tpctl->base = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(pctl->base))\n\t\treturn PTR_ERR(pctl->base);\n\n\tpctl->pins = pistachio_pins;\n\tpctl->npins = ARRAY_SIZE(pistachio_pins);\n\tpctl->functions = pistachio_functions;\n\tpctl->nfunctions = ARRAY_SIZE(pistachio_functions);\n\tpctl->groups = pistachio_groups;\n\tpctl->ngroups = ARRAY_SIZE(pistachio_groups);\n\tpctl->gpio_banks = pistachio_gpio_banks;\n\tpctl->nbanks = ARRAY_SIZE(pistachio_gpio_banks);\n\n\tpistachio_pinctrl_desc.pins = pctl->pins;\n\tpistachio_pinctrl_desc.npins = pctl->npins;\n\n\tpctl->pctldev = devm_pinctrl_register(&pdev->dev, &pistachio_pinctrl_desc,\n\t\t\t\t\t      pctl);\n\tif (IS_ERR(pctl->pctldev)) {\n\t\tdev_err(&pdev->dev, \"Failed to register pinctrl device\\n\");\n\t\treturn PTR_ERR(pctl->pctldev);\n\t}\n\n\treturn pistachio_gpio_register(pctl);\n}\n\nstatic struct platform_driver pistachio_pinctrl_driver = {\n\t.driver = {\n\t\t.name = \"pistachio-pinctrl\",\n\t\t.of_match_table = pistachio_pinctrl_of_match,\n\t\t.suppress_bind_attrs = true,\n\t},\n\t.probe = pistachio_pinctrl_probe,\n};\n\nstatic int __init pistachio_pinctrl_register(void)\n{\n\treturn platform_driver_register(&pistachio_pinctrl_driver);\n}\narch_initcall(pistachio_pinctrl_register);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}