{
  "module_name": "pinctrl-scu.c",
  "hash_id": "dab7f2b85fb290eeb4cbb407d81dac275c09f8579a84943058cd821662863a4d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pinctrl/freescale/pinctrl-scu.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/firmware/imx/sci.h>\n#include <linux/module.h>\n#include <linux/of_address.h>\n#include <linux/pinctrl/pinctrl.h>\n#include <linux/platform_device.h>\n\n#include \"../core.h\"\n#include \"pinctrl-imx.h\"\n\n#define IMX_SC_PAD_FUNC_GET_WAKEUP\t9\n#define IMX_SC_PAD_FUNC_SET_WAKEUP\t4\n#define IMX_SC_IRQ_GROUP_WAKE           3    \n#define IMX_SC_IRQ_PAD\t\t\t2    \n\nenum pad_func_e {\n\tIMX_SC_PAD_FUNC_SET = 15,\n\tIMX_SC_PAD_FUNC_GET = 16,\n};\n\nstruct imx_sc_msg_req_pad_set {\n\tstruct imx_sc_rpc_msg hdr;\n\tu32 val;\n\tu16 pad;\n} __packed __aligned(4);\n\nstruct imx_sc_msg_req_pad_get {\n\tstruct imx_sc_rpc_msg hdr;\n\tu16 pad;\n} __packed __aligned(4);\n\nstruct imx_sc_msg_resp_pad_get {\n\tstruct imx_sc_rpc_msg hdr;\n\tu32 val;\n} __packed;\n\nstruct imx_sc_msg_gpio_set_pad_wakeup {\n\tstruct imx_sc_rpc_msg hdr;\n\tu16 pad;\n\tu8 wakeup;\n} __packed __aligned(4);\n\nstatic struct imx_sc_ipc *pinctrl_ipc_handle;\n\nint imx_pinctrl_sc_ipc_init(struct platform_device *pdev)\n{\n\timx_scu_irq_group_enable(IMX_SC_IRQ_GROUP_WAKE,\n\t\t\t\t\t IMX_SC_IRQ_PAD, true);\n\treturn imx_scu_get_handle(&pinctrl_ipc_handle);\n}\nEXPORT_SYMBOL_GPL(imx_pinctrl_sc_ipc_init);\n\nint imx_pinconf_get_scu(struct pinctrl_dev *pctldev, unsigned pin_id,\n\t\t\tunsigned long *config)\n{\n\tstruct imx_sc_msg_req_pad_get msg;\n\tstruct imx_sc_msg_resp_pad_get *resp;\n\tstruct imx_sc_rpc_msg *hdr = &msg.hdr;\n\tint ret;\n\n\thdr->ver = IMX_SC_RPC_VERSION;\n\thdr->svc = IMX_SC_RPC_SVC_PAD;\n\thdr->func = IMX_SC_PAD_FUNC_GET;\n\thdr->size = 2;\n\n\tmsg.pad = pin_id;\n\n\tret = imx_scu_call_rpc(pinctrl_ipc_handle, &msg, true);\n\tif (ret)\n\t\treturn ret;\n\n\tresp = (struct imx_sc_msg_resp_pad_get *)&msg;\n\t*config = resp->val;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(imx_pinconf_get_scu);\n\nint imx_pinconf_set_scu(struct pinctrl_dev *pctldev, unsigned pin_id,\n\t\t\tunsigned long *configs, unsigned num_configs)\n{\n\tstruct imx_pinctrl *ipctl = pinctrl_dev_get_drvdata(pctldev);\n\tstruct imx_sc_msg_req_pad_set msg;\n\tstruct imx_sc_rpc_msg *hdr = &msg.hdr;\n\tunsigned int mux = configs[0];\n\tunsigned int conf;\n\tunsigned int val;\n\tint ret;\n\n\tif (num_configs == 1) {\n\t\tstruct imx_sc_msg_gpio_set_pad_wakeup wmsg;\n\n\t\thdr = &wmsg.hdr;\n\t\thdr->ver = IMX_SC_RPC_VERSION;\n\t\thdr->svc = IMX_SC_RPC_SVC_PAD;\n\t\thdr->func = IMX_SC_PAD_FUNC_SET_WAKEUP;\n\t\thdr->size = 2;\n\t\twmsg.pad = pin_id;\n\t\twmsg.wakeup = *configs;\n\t\tret = imx_scu_call_rpc(pinctrl_ipc_handle, &wmsg, true);\n\n\t\tdev_dbg(ipctl->dev, \"wakeup pin_id: %d type: %ld\\n\",\n\t\t\t\tpin_id, *configs);\n\t\treturn ret;\n\t}\n\n\t \n\tWARN_ON(num_configs != 2);\n\tconf = configs[1];\n\n\tval = conf | BM_PAD_CTL_IFMUX_ENABLE | BM_PAD_CTL_GP_ENABLE;\n\tval |= mux << BP_PAD_CTL_IFMUX;\n\n\thdr->ver = IMX_SC_RPC_VERSION;\n\thdr->svc = IMX_SC_RPC_SVC_PAD;\n\thdr->func = IMX_SC_PAD_FUNC_SET;\n\thdr->size = 3;\n\n\tmsg.pad = pin_id;\n\tmsg.val = val;\n\n\tret = imx_scu_call_rpc(pinctrl_ipc_handle, &msg, true);\n\n\tdev_dbg(ipctl->dev, \"write: pin_id %u config 0x%x val 0x%x\\n\",\n\t\tpin_id, conf, val);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(imx_pinconf_set_scu);\n\nvoid imx_pinctrl_parse_pin_scu(struct imx_pinctrl *ipctl,\n\t\t\t       unsigned int *pin_id, struct imx_pin *pin,\n\t\t\t       const __be32 **list_p)\n{\n\tconst struct imx_pinctrl_soc_info *info = ipctl->info;\n\tstruct imx_pin_scu *pin_scu = &pin->conf.scu;\n\tconst __be32 *list = *list_p;\n\n\tpin->pin = be32_to_cpu(*list++);\n\t*pin_id = pin->pin;\n\tpin_scu->mux_mode = be32_to_cpu(*list++);\n\tpin_scu->config = be32_to_cpu(*list++);\n\t*list_p = list;\n\n\tdev_dbg(ipctl->dev, \"%s: 0x%x 0x%08lx\", info->pins[pin->pin].name,\n\t\tpin_scu->mux_mode, pin_scu->config);\n}\nEXPORT_SYMBOL_GPL(imx_pinctrl_parse_pin_scu);\n\nMODULE_AUTHOR(\"Dong Aisheng <aisheng.dong@nxp.com>\");\nMODULE_DESCRIPTION(\"NXP i.MX SCU common pinctrl driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}