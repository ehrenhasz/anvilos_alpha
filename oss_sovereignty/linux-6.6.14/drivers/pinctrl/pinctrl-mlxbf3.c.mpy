{
  "module_name": "pinctrl-mlxbf3.c",
  "hash_id": "fb326bb279074ad03553748adec0858ac0b42200685d842c81bae1addfe32ab0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pinctrl/pinctrl-mlxbf3.c",
  "human_readable_source": "\n \n\n#include <linux/bitfield.h>\n#include <linux/bitops.h>\n#include <linux/err.h>\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/mod_devicetable.h>\n#include <linux/platform_device.h>\n#include <linux/types.h>\n\n#include <linux/pinctrl/pinctrl.h>\n#include <linux/pinctrl/pinmux.h>\n\n#define MLXBF3_NGPIOS_GPIO0    32\n#define MLXBF3_MAX_GPIO_PINS   56\n\nenum {\n\tMLXBF3_GPIO_HW_MODE,\n\tMLXBF3_GPIO_SW_MODE,\n};\n\nstruct mlxbf3_pinctrl {\n\tvoid __iomem *fw_ctrl_set0;\n\tvoid __iomem *fw_ctrl_clr0;\n\tvoid __iomem *fw_ctrl_set1;\n\tvoid __iomem *fw_ctrl_clr1;\n\tstruct device *dev;\n\tstruct pinctrl_dev *pctl;\n\tstruct pinctrl_gpio_range gpio_range;\n};\n\n#define MLXBF3_GPIO_RANGE(_id, _pinbase, _gpiobase, _npins)\t\\\n\t{\t\t\t\t\t\t\t\\\n\t\t.name = \"mlxbf3_gpio_range\",\t\t\t\\\n\t\t.id = _id,\t\t\t\t\t\\\n\t\t.base = _gpiobase,\t\t\t\t\\\n\t\t.pin_base = _pinbase,\t\t\t\t\\\n\t\t.npins = _npins,\t\t\t\t\\\n\t}\n\nstatic struct pinctrl_gpio_range mlxbf3_pinctrl_gpio_ranges[] = {\n\tMLXBF3_GPIO_RANGE(0, 0,  480, 32),\n\tMLXBF3_GPIO_RANGE(1,  32, 456, 24),\n};\n\nstatic const struct pinctrl_pin_desc mlxbf3_pins[] = {\n\tPINCTRL_PIN(0, \"gpio0\"),\n\tPINCTRL_PIN(1, \"gpio1\"),\n\tPINCTRL_PIN(2, \"gpio2\"),\n\tPINCTRL_PIN(3, \"gpio3\"),\n\tPINCTRL_PIN(4, \"gpio4\"),\n\tPINCTRL_PIN(5, \"gpio5\"),\n\tPINCTRL_PIN(6, \"gpio6\"),\n\tPINCTRL_PIN(7, \"gpio7\"),\n\tPINCTRL_PIN(8, \"gpio8\"),\n\tPINCTRL_PIN(9, \"gpio9\"),\n\tPINCTRL_PIN(10, \"gpio10\"),\n\tPINCTRL_PIN(11, \"gpio11\"),\n\tPINCTRL_PIN(12, \"gpio12\"),\n\tPINCTRL_PIN(13, \"gpio13\"),\n\tPINCTRL_PIN(14, \"gpio14\"),\n\tPINCTRL_PIN(15, \"gpio15\"),\n\tPINCTRL_PIN(16, \"gpio16\"),\n\tPINCTRL_PIN(17, \"gpio17\"),\n\tPINCTRL_PIN(18, \"gpio18\"),\n\tPINCTRL_PIN(19, \"gpio19\"),\n\tPINCTRL_PIN(20, \"gpio20\"),\n\tPINCTRL_PIN(21, \"gpio21\"),\n\tPINCTRL_PIN(22, \"gpio22\"),\n\tPINCTRL_PIN(23, \"gpio23\"),\n\tPINCTRL_PIN(24, \"gpio24\"),\n\tPINCTRL_PIN(25, \"gpio25\"),\n\tPINCTRL_PIN(26, \"gpio26\"),\n\tPINCTRL_PIN(27, \"gpio27\"),\n\tPINCTRL_PIN(28, \"gpio28\"),\n\tPINCTRL_PIN(29, \"gpio29\"),\n\tPINCTRL_PIN(30, \"gpio30\"),\n\tPINCTRL_PIN(31, \"gpio31\"),\n\tPINCTRL_PIN(32, \"gpio32\"),\n\tPINCTRL_PIN(33, \"gpio33\"),\n\tPINCTRL_PIN(34, \"gpio34\"),\n\tPINCTRL_PIN(35, \"gpio35\"),\n\tPINCTRL_PIN(36, \"gpio36\"),\n\tPINCTRL_PIN(37, \"gpio37\"),\n\tPINCTRL_PIN(38, \"gpio38\"),\n\tPINCTRL_PIN(39, \"gpio39\"),\n\tPINCTRL_PIN(40, \"gpio40\"),\n\tPINCTRL_PIN(41, \"gpio41\"),\n\tPINCTRL_PIN(42, \"gpio42\"),\n\tPINCTRL_PIN(43, \"gpio43\"),\n\tPINCTRL_PIN(44, \"gpio44\"),\n\tPINCTRL_PIN(45, \"gpio45\"),\n\tPINCTRL_PIN(46, \"gpio46\"),\n\tPINCTRL_PIN(47, \"gpio47\"),\n\tPINCTRL_PIN(48, \"gpio48\"),\n\tPINCTRL_PIN(49, \"gpio49\"),\n\tPINCTRL_PIN(50, \"gpio50\"),\n\tPINCTRL_PIN(51, \"gpio51\"),\n\tPINCTRL_PIN(52, \"gpio52\"),\n\tPINCTRL_PIN(53, \"gpio53\"),\n\tPINCTRL_PIN(54, \"gpio54\"),\n\tPINCTRL_PIN(55, \"gpio55\"),\n};\n\n \nstatic const char * const mlxbf3_pinctrl_single_group_names[] = {\n\t\"gpio0\", \"gpio1\",  \"gpio2\",  \"gpio3\",  \"gpio4\",  \"gpio5\",  \"gpio6\", \"gpio7\",\n\t\"gpio8\",  \"gpio9\",  \"gpio10\", \"gpio11\", \"gpio12\", \"gpio13\", \"gpio14\", \"gpio15\",\n\t\"gpio16\", \"gpio17\", \"gpio18\", \"gpio19\", \"gpio20\", \"gpio21\", \"gpio22\", \"gpio23\",\n\t\"gpio24\", \"gpio25\", \"gpio26\", \"gpio27\", \"gpio28\", \"gpio29\", \"gpio30\", \"gpio31\",\n\t\"gpio32\", \"gpio33\", \"gpio34\", \"gpio35\", \"gpio36\", \"gpio37\", \"gpio38\", \"gpio39\",\n\t\"gpio40\", \"gpio41\", \"gpio42\", \"gpio43\", \"gpio44\", \"gpio45\", \"gpio46\", \"gpio47\",\n\t\"gpio48\", \"gpio49\", \"gpio50\", \"gpio51\", \"gpio52\", \"gpio53\", \"gpio54\", \"gpio55\",\n};\n\nstatic int mlxbf3_get_groups_count(struct pinctrl_dev *pctldev)\n{\n\t \n\treturn MLXBF3_MAX_GPIO_PINS;\n}\n\nstatic const char *mlxbf3_get_group_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t unsigned int selector)\n{\n\treturn mlxbf3_pinctrl_single_group_names[selector];\n}\n\nstatic int mlxbf3_get_group_pins(struct pinctrl_dev *pctldev,\n\t\t\t\t unsigned int selector,\n\t\t\t\t const unsigned int **pins,\n\t\t\t\t unsigned int *num_pins)\n{\n\t \n\t*pins = &selector;\n\t*num_pins = 1;\n\n\treturn 0;\n}\n\nstatic const struct pinctrl_ops mlxbf3_pinctrl_group_ops = {\n\t.get_groups_count = mlxbf3_get_groups_count,\n\t.get_group_name = mlxbf3_get_group_name,\n\t.get_group_pins = mlxbf3_get_group_pins,\n};\n\n \nstatic const char * const mlxbf3_gpiofunc_group_names[] = { \"swctrl\" };\nstatic const char * const mlxbf3_hwfunc_group_names[]   = { \"hwctrl\" };\n\nstatic struct pinfunction mlxbf3_pmx_funcs[] = {\n\tPINCTRL_PINFUNCTION(\"hwfunc\", mlxbf3_hwfunc_group_names, 1),\n\tPINCTRL_PINFUNCTION(\"gpiofunc\", mlxbf3_gpiofunc_group_names, 1),\n};\n\nstatic int mlxbf3_pmx_get_funcs_count(struct pinctrl_dev *pctldev)\n{\n\treturn ARRAY_SIZE(mlxbf3_pmx_funcs);\n}\n\nstatic const char *mlxbf3_pmx_get_func_name(struct pinctrl_dev *pctldev,\n\t\t\t\t\t   unsigned int selector)\n{\n\treturn mlxbf3_pmx_funcs[selector].name;\n}\n\nstatic int mlxbf3_pmx_get_groups(struct pinctrl_dev *pctldev,\n\t\t\t\t unsigned int selector,\n\t\t\t\t const char * const **groups,\n\t\t\t\t unsigned int * const num_groups)\n{\n\t*groups = mlxbf3_pmx_funcs[selector].groups;\n\t*num_groups = MLXBF3_MAX_GPIO_PINS;\n\n\treturn 0;\n}\n\nstatic int mlxbf3_pmx_set(struct pinctrl_dev *pctldev,\n\t\t\t      unsigned int selector,\n\t\t\t      unsigned int group)\n{\n\tstruct mlxbf3_pinctrl *priv = pinctrl_dev_get_drvdata(pctldev);\n\n\tif (selector == MLXBF3_GPIO_HW_MODE) {\n\t\tif (group < MLXBF3_NGPIOS_GPIO0)\n\t\t\twritel(BIT(group), priv->fw_ctrl_clr0);\n\t\telse\n\t\t\twritel(BIT(group % MLXBF3_NGPIOS_GPIO0), priv->fw_ctrl_clr1);\n\t}\n\n\tif (selector == MLXBF3_GPIO_SW_MODE) {\n\t\tif (group < MLXBF3_NGPIOS_GPIO0)\n\t\t\twritel(BIT(group), priv->fw_ctrl_set0);\n\t\telse\n\t\t\twritel(BIT(group % MLXBF3_NGPIOS_GPIO0), priv->fw_ctrl_set1);\n\t}\n\n\treturn 0;\n}\n\nstatic int mlxbf3_gpio_request_enable(struct pinctrl_dev *pctldev,\n\t\t\t\t     struct pinctrl_gpio_range *range,\n\t\t\t\t     unsigned int offset)\n{\n\tstruct mlxbf3_pinctrl *priv = pinctrl_dev_get_drvdata(pctldev);\n\n\tif (offset < MLXBF3_NGPIOS_GPIO0)\n\t\twritel(BIT(offset), priv->fw_ctrl_set0);\n\telse\n\t\twritel(BIT(offset % MLXBF3_NGPIOS_GPIO0), priv->fw_ctrl_set1);\n\n\treturn 0;\n}\n\nstatic const struct pinmux_ops mlxbf3_pmx_ops = {\n\t.get_functions_count = mlxbf3_pmx_get_funcs_count,\n\t.get_function_name = mlxbf3_pmx_get_func_name,\n\t.get_function_groups = mlxbf3_pmx_get_groups,\n\t.set_mux = mlxbf3_pmx_set,\n\t.gpio_request_enable = mlxbf3_gpio_request_enable,\n};\n\nstatic struct pinctrl_desc mlxbf3_pin_desc = {\n\t.name = \"pinctrl-mlxbf3\",\n\t.pins = mlxbf3_pins,\n\t.npins = ARRAY_SIZE(mlxbf3_pins),\n\t.pctlops = &mlxbf3_pinctrl_group_ops,\n\t.pmxops = &mlxbf3_pmx_ops,\n\t.owner = THIS_MODULE,\n};\n\nstatic_assert(ARRAY_SIZE(mlxbf3_pinctrl_single_group_names) == MLXBF3_MAX_GPIO_PINS);\n\nstatic int mlxbf3_pinctrl_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct mlxbf3_pinctrl *priv;\n\tint ret;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tpriv->dev = &pdev->dev;\n\n\tpriv->fw_ctrl_set0 = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(priv->fw_ctrl_set0))\n\t\treturn PTR_ERR(priv->fw_ctrl_set0);\n\n\tpriv->fw_ctrl_clr0 = devm_platform_ioremap_resource(pdev, 1);\n\tif (IS_ERR(priv->fw_ctrl_set0))\n\t\treturn PTR_ERR(priv->fw_ctrl_set0);\n\n\tpriv->fw_ctrl_set1 = devm_platform_ioremap_resource(pdev, 2);\n\tif (IS_ERR(priv->fw_ctrl_set0))\n\t\treturn PTR_ERR(priv->fw_ctrl_set0);\n\n\tpriv->fw_ctrl_clr1 = devm_platform_ioremap_resource(pdev, 3);\n\tif (IS_ERR(priv->fw_ctrl_set0))\n\t\treturn PTR_ERR(priv->fw_ctrl_set0);\n\n\tret = devm_pinctrl_register_and_init(dev,\n\t\t\t\t\t     &mlxbf3_pin_desc,\n\t\t\t\t\t     priv,\n\t\t\t\t\t     &priv->pctl);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to register pinctrl\\n\");\n\n\tret = pinctrl_enable(priv->pctl);\n\tif (ret)\n\t\treturn dev_err_probe(dev, ret, \"Failed to enable pinctrl\\n\");\n\n\tpinctrl_add_gpio_ranges(priv->pctl, mlxbf3_pinctrl_gpio_ranges, 2);\n\n\treturn 0;\n}\n\nstatic const struct acpi_device_id mlxbf3_pinctrl_acpi_ids[] = {\n\t{ \"MLNXBF34\", 0 },\n\t{}\n};\nMODULE_DEVICE_TABLE(acpi, mlxbf3_pinctrl_acpi_ids);\n\nstatic struct platform_driver mlxbf3_pinctrl_driver = {\n\t.driver = {\n\t\t.name = \"pinctrl-mlxbf3\",\n\t\t.acpi_match_table = mlxbf3_pinctrl_acpi_ids,\n\t},\n\t.probe = mlxbf3_pinctrl_probe,\n};\nmodule_platform_driver(mlxbf3_pinctrl_driver);\n\nMODULE_DESCRIPTION(\"NVIDIA pinctrl driver\");\nMODULE_AUTHOR(\"Asmaa Mnebhi <asmaa@nvidia.com>\");\nMODULE_LICENSE(\"Dual BSD/GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}