{
  "module_name": "mvebu-cpufreq.c",
  "hash_id": "ffa3b5a26055107d0c7a83c3706f98cc1295935098da88dc0421a4b7d1309714",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/mvebu-cpufreq.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) \"mvebu-pmsu: \" fmt\n\n#include <linux/clk.h>\n#include <linux/cpu.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/of_address.h>\n#include <linux/platform_device.h>\n#include <linux/pm_opp.h>\n#include <linux/resource.h>\n\nstatic int __init armada_xp_pmsu_cpufreq_init(void)\n{\n\tstruct device_node *np;\n\tstruct resource res;\n\tint ret, cpu;\n\n\tif (!of_machine_is_compatible(\"marvell,armadaxp\"))\n\t\treturn 0;\n\n\t \n\tnp = of_find_compatible_node(NULL, NULL, \"marvell,armada-xp-cpu-clock\");\n\tif (!np)\n\t\treturn 0;\n\n\tret = of_address_to_resource(np, 1, &res);\n\tif (ret) {\n\t\tpr_warn(FW_WARN \"not enabling cpufreq, deprecated armada-xp-cpu-clock binding\\n\");\n\t\tof_node_put(np);\n\t\treturn 0;\n\t}\n\n\tof_node_put(np);\n\n\t \n\tfor_each_possible_cpu(cpu) {\n\t\tstruct device *cpu_dev;\n\t\tstruct clk *clk;\n\t\tint ret;\n\n\t\tcpu_dev = get_cpu_device(cpu);\n\t\tif (!cpu_dev) {\n\t\t\tpr_err(\"Cannot get CPU %d\\n\", cpu);\n\t\t\tcontinue;\n\t\t}\n\n\t\tclk = clk_get(cpu_dev, NULL);\n\t\tif (IS_ERR(clk)) {\n\t\t\tpr_err(\"Cannot get clock for CPU %d\\n\", cpu);\n\t\t\treturn PTR_ERR(clk);\n\t\t}\n\n\t\tret = dev_pm_opp_add(cpu_dev, clk_get_rate(clk), 0);\n\t\tif (ret) {\n\t\t\tclk_put(clk);\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = dev_pm_opp_add(cpu_dev, clk_get_rate(clk) / 2, 0);\n\t\tif (ret) {\n\t\t\tdev_pm_opp_remove(cpu_dev, clk_get_rate(clk));\n\t\t\tclk_put(clk);\n\t\t\tdev_err(cpu_dev, \"Failed to register OPPs\\n\");\n\t\t\treturn ret;\n\t\t}\n\n\t\tret = dev_pm_opp_set_sharing_cpus(cpu_dev,\n\t\t\t\t\t\t  cpumask_of(cpu_dev->id));\n\t\tif (ret)\n\t\t\tdev_err(cpu_dev, \"%s: failed to mark OPPs as shared: %d\\n\",\n\t\t\t\t__func__, ret);\n\t\tclk_put(clk);\n\t}\n\n\tplatform_device_register_simple(\"cpufreq-dt\", -1, NULL, 0);\n\treturn 0;\n}\ndevice_initcall(armada_xp_pmsu_cpufreq_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}