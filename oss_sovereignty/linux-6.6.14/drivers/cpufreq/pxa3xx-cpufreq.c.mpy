{
  "module_name": "pxa3xx-cpufreq.c",
  "hash_id": "0fd7fe8807177487f21771fa0f8e15f58952e3bff7aa8fb2e24693d48c242ca7",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/pxa3xx-cpufreq.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/sched.h>\n#include <linux/init.h>\n#include <linux/cpufreq.h>\n#include <linux/soc/pxa/cpu.h>\n#include <linux/clk/pxa.h>\n#include <linux/slab.h>\n#include <linux/io.h>\n\n#define HSS_104M\t(0)\n#define HSS_156M\t(1)\n#define HSS_208M\t(2)\n#define HSS_312M\t(3)\n\n#define SMCFS_78M\t(0)\n#define SMCFS_104M\t(2)\n#define SMCFS_208M\t(5)\n\n#define SFLFS_104M\t(0)\n#define SFLFS_156M\t(1)\n#define SFLFS_208M\t(2)\n#define SFLFS_312M\t(3)\n\n#define XSPCLK_156M\t(0)\n#define XSPCLK_NONE\t(3)\n\n#define DMCFS_26M\t(0)\n#define DMCFS_260M\t(3)\n\n#define ACCR_XPDIS\t\t(1 << 31)\t \n#define ACCR_SPDIS\t\t(1 << 30)\t \n#define ACCR_D0CS\t\t(1 << 26)\t \n#define ACCR_PCCE\t\t(1 << 11)\t \n#define ACCR_DDR_D0CS\t\t(1 << 7)\t \n\n#define ACCR_SMCFS_MASK\t\t(0x7 << 23)\t \n#define ACCR_SFLFS_MASK\t\t(0x3 << 18)\t \n#define ACCR_XSPCLK_MASK\t(0x3 << 16)\t \n#define ACCR_HSS_MASK\t\t(0x3 << 14)\t \n#define ACCR_DMCFS_MASK\t\t(0x3 << 12)\t \n#define ACCR_XN_MASK\t\t(0x7 << 8)\t \n#define ACCR_XL_MASK\t\t(0x1f)\t\t \n\n#define ACCR_SMCFS(x)\t\t(((x) & 0x7) << 23)\n#define ACCR_SFLFS(x)\t\t(((x) & 0x3) << 18)\n#define ACCR_XSPCLK(x)\t\t(((x) & 0x3) << 16)\n#define ACCR_HSS(x)\t\t(((x) & 0x3) << 14)\n#define ACCR_DMCFS(x)\t\t(((x) & 0x3) << 12)\n#define ACCR_XN(x)\t\t(((x) & 0x7) << 8)\n#define ACCR_XL(x)\t\t((x) & 0x1f)\n\nstruct pxa3xx_freq_info {\n\tunsigned int cpufreq_mhz;\n\tunsigned int core_xl : 5;\n\tunsigned int core_xn : 3;\n\tunsigned int hss : 2;\n\tunsigned int dmcfs : 2;\n\tunsigned int smcfs : 3;\n\tunsigned int sflfs : 2;\n\tunsigned int df_clkdiv : 3;\n\n\tint\tvcc_core;\t \n\tint\tvcc_sram;\t \n};\n\n#define OP(cpufreq, _xl, _xn, _hss, _dmc, _smc, _sfl, _dfi, vcore, vsram) \\\n{\t\t\t\t\t\t\t\t\t\\\n\t.cpufreq_mhz\t= cpufreq,\t\t\t\t\t\\\n\t.core_xl\t= _xl,\t\t\t\t\t\t\\\n\t.core_xn\t= _xn,\t\t\t\t\t\t\\\n\t.hss\t\t= HSS_##_hss##M,\t\t\t\t\\\n\t.dmcfs\t\t= DMCFS_##_dmc##M,\t\t\t\t\\\n\t.smcfs\t\t= SMCFS_##_smc##M,\t\t\t\t\\\n\t.sflfs\t\t= SFLFS_##_sfl##M,\t\t\t\t\\\n\t.df_clkdiv\t= _dfi,\t\t\t\t\t\t\\\n\t.vcc_core\t= vcore,\t\t\t\t\t\\\n\t.vcc_sram\t= vsram,\t\t\t\t\t\\\n}\n\nstatic struct pxa3xx_freq_info pxa300_freqs[] = {\n\t \n\tOP(104,  8, 1, 104, 260,  78, 104, 3, 1000, 1100),  \n\tOP(208, 16, 1, 104, 260, 104, 156, 2, 1000, 1100),  \n\tOP(416, 16, 2, 156, 260, 104, 208, 2, 1100, 1200),  \n\tOP(624, 24, 2, 208, 260, 208, 312, 3, 1375, 1400),  \n};\n\nstatic struct pxa3xx_freq_info pxa320_freqs[] = {\n\t \n\tOP(104,  8, 1, 104, 260,  78, 104, 3, 1000, 1100),  \n\tOP(208, 16, 1, 104, 260, 104, 156, 2, 1000, 1100),  \n\tOP(416, 16, 2, 156, 260, 104, 208, 2, 1100, 1200),  \n\tOP(624, 24, 2, 208, 260, 208, 312, 3, 1375, 1400),  \n\tOP(806, 31, 2, 208, 260, 208, 312, 3, 1400, 1400),  \n};\n\nstatic unsigned int pxa3xx_freqs_num;\nstatic struct pxa3xx_freq_info *pxa3xx_freqs;\nstatic struct cpufreq_frequency_table *pxa3xx_freqs_table;\n\nstatic int setup_freqs_table(struct cpufreq_policy *policy,\n\t\t\t     struct pxa3xx_freq_info *freqs, int num)\n{\n\tstruct cpufreq_frequency_table *table;\n\tint i;\n\n\ttable = kcalloc(num + 1, sizeof(*table), GFP_KERNEL);\n\tif (table == NULL)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < num; i++) {\n\t\ttable[i].driver_data = i;\n\t\ttable[i].frequency = freqs[i].cpufreq_mhz * 1000;\n\t}\n\ttable[num].driver_data = i;\n\ttable[num].frequency = CPUFREQ_TABLE_END;\n\n\tpxa3xx_freqs = freqs;\n\tpxa3xx_freqs_num = num;\n\tpxa3xx_freqs_table = table;\n\n\tpolicy->freq_table = table;\n\n\treturn 0;\n}\n\nstatic void __update_core_freq(struct pxa3xx_freq_info *info)\n{\n\tu32 mask, disable, enable, xclkcfg;\n\n\tmask\t= ACCR_XN_MASK | ACCR_XL_MASK;\n\tdisable = mask | ACCR_XSPCLK_MASK;\n\tenable  = ACCR_XN(info->core_xn) | ACCR_XL(info->core_xl);\n\t \n\tenable |= ACCR_XSPCLK(XSPCLK_NONE);\n\txclkcfg = (info->core_xn == 2) ? 0x3 : 0x2;\t \n\n\tpxa3xx_clk_update_accr(disable, enable, xclkcfg, mask);\n}\n\nstatic void __update_bus_freq(struct pxa3xx_freq_info *info)\n{\n\tu32 mask, disable, enable;\n\n\tmask\t= ACCR_SMCFS_MASK | ACCR_SFLFS_MASK | ACCR_HSS_MASK |\n\t\t  ACCR_DMCFS_MASK;\n\tdisable = mask;\n\tenable\t= ACCR_SMCFS(info->smcfs) | ACCR_SFLFS(info->sflfs) |\n\t\t  ACCR_HSS(info->hss) | ACCR_DMCFS(info->dmcfs);\n\n\tpxa3xx_clk_update_accr(disable, enable, 0, mask);\n}\n\nstatic unsigned int pxa3xx_cpufreq_get(unsigned int cpu)\n{\n\treturn pxa3xx_get_clk_frequency_khz(0);\n}\n\nstatic int pxa3xx_cpufreq_set(struct cpufreq_policy *policy, unsigned int index)\n{\n\tstruct pxa3xx_freq_info *next;\n\tunsigned long flags;\n\n\tif (policy->cpu != 0)\n\t\treturn -EINVAL;\n\n\tnext = &pxa3xx_freqs[index];\n\n\tlocal_irq_save(flags);\n\t__update_core_freq(next);\n\t__update_bus_freq(next);\n\tlocal_irq_restore(flags);\n\n\treturn 0;\n}\n\nstatic int pxa3xx_cpufreq_init(struct cpufreq_policy *policy)\n{\n\tint ret = -EINVAL;\n\n\t \n\tpolicy->min = policy->cpuinfo.min_freq = 104000;\n\tpolicy->max = policy->cpuinfo.max_freq =\n\t\t(cpu_is_pxa320()) ? 806000 : 624000;\n\tpolicy->cpuinfo.transition_latency = 1000;  \n\n\tif (cpu_is_pxa300() || cpu_is_pxa310())\n\t\tret = setup_freqs_table(policy, pxa300_freqs,\n\t\t\t\t\tARRAY_SIZE(pxa300_freqs));\n\n\tif (cpu_is_pxa320())\n\t\tret = setup_freqs_table(policy, pxa320_freqs,\n\t\t\t\t\tARRAY_SIZE(pxa320_freqs));\n\n\tif (ret) {\n\t\tpr_err(\"failed to setup frequency table\\n\");\n\t\treturn ret;\n\t}\n\n\tpr_info(\"CPUFREQ support for PXA3xx initialized\\n\");\n\treturn 0;\n}\n\nstatic struct cpufreq_driver pxa3xx_cpufreq_driver = {\n\t.flags\t\t= CPUFREQ_NEED_INITIAL_FREQ_CHECK,\n\t.verify\t\t= cpufreq_generic_frequency_table_verify,\n\t.target_index\t= pxa3xx_cpufreq_set,\n\t.init\t\t= pxa3xx_cpufreq_init,\n\t.get\t\t= pxa3xx_cpufreq_get,\n\t.name\t\t= \"pxa3xx-cpufreq\",\n};\n\nstatic int __init cpufreq_init(void)\n{\n\tif (cpu_is_pxa3xx())\n\t\treturn cpufreq_register_driver(&pxa3xx_cpufreq_driver);\n\n\treturn 0;\n}\nmodule_init(cpufreq_init);\n\nstatic void __exit cpufreq_exit(void)\n{\n\tcpufreq_unregister_driver(&pxa3xx_cpufreq_driver);\n}\nmodule_exit(cpufreq_exit);\n\nMODULE_DESCRIPTION(\"CPU frequency scaling driver for PXA3xx\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}