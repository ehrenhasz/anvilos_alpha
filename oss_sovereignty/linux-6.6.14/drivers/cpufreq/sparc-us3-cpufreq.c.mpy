{
  "module_name": "sparc-us3-cpufreq.c",
  "hash_id": "3886abcb151a52872d3653925dbd5b9477bfe73afad6de219b46df6276c09bbe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/sparc-us3-cpufreq.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/sched.h>\n#include <linux/smp.h>\n#include <linux/cpufreq.h>\n#include <linux/threads.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n\n#include <asm/head.h>\n#include <asm/timer.h>\n\nstruct us3_freq_percpu_info {\n\tstruct cpufreq_frequency_table table[4];\n};\n\n \nstatic struct us3_freq_percpu_info *us3_freq_table;\n\n \n#define SAFARI_CFG_DIV_1\t0x0000000000000000UL\n#define SAFARI_CFG_DIV_2\t0x0000000040000000UL\n#define SAFARI_CFG_DIV_32\t0x0000000080000000UL\n#define SAFARI_CFG_DIV_MASK\t0x00000000C0000000UL\n\nstatic void read_safari_cfg(void *arg)\n{\n\tunsigned long ret, *val = arg;\n\n\t__asm__ __volatile__(\"ldxa\t[%%g0] %1, %0\"\n\t\t\t     : \"=&r\" (ret)\n\t\t\t     : \"i\" (ASI_SAFARI_CONFIG));\n\t*val = ret;\n}\n\nstatic void update_safari_cfg(void *arg)\n{\n\tunsigned long reg, *new_bits = arg;\n\n\tread_safari_cfg(&reg);\n\treg &= ~SAFARI_CFG_DIV_MASK;\n\treg |= *new_bits;\n\n\t__asm__ __volatile__(\"stxa\t%0, [%%g0] %1\\n\\t\"\n\t\t\t     \"membar\t#Sync\"\n\t\t\t     :  \n\t\t\t     : \"r\" (reg), \"i\" (ASI_SAFARI_CONFIG)\n\t\t\t     : \"memory\");\n}\n\nstatic unsigned long get_current_freq(unsigned int cpu, unsigned long safari_cfg)\n{\n\tunsigned long clock_tick = sparc64_get_clock_tick(cpu) / 1000;\n\tunsigned long ret;\n\n\tswitch (safari_cfg & SAFARI_CFG_DIV_MASK) {\n\tcase SAFARI_CFG_DIV_1:\n\t\tret = clock_tick / 1;\n\t\tbreak;\n\tcase SAFARI_CFG_DIV_2:\n\t\tret = clock_tick / 2;\n\t\tbreak;\n\tcase SAFARI_CFG_DIV_32:\n\t\tret = clock_tick / 32;\n\t\tbreak;\n\tdefault:\n\t\tBUG();\n\t}\n\n\treturn ret;\n}\n\nstatic unsigned int us3_freq_get(unsigned int cpu)\n{\n\tunsigned long reg;\n\n\tif (smp_call_function_single(cpu, read_safari_cfg, &reg, 1))\n\t\treturn 0;\n\treturn get_current_freq(cpu, reg);\n}\n\nstatic int us3_freq_target(struct cpufreq_policy *policy, unsigned int index)\n{\n\tunsigned int cpu = policy->cpu;\n\tunsigned long new_bits, new_freq;\n\n\tnew_freq = sparc64_get_clock_tick(cpu) / 1000;\n\tswitch (index) {\n\tcase 0:\n\t\tnew_bits = SAFARI_CFG_DIV_1;\n\t\tnew_freq /= 1;\n\t\tbreak;\n\tcase 1:\n\t\tnew_bits = SAFARI_CFG_DIV_2;\n\t\tnew_freq /= 2;\n\t\tbreak;\n\tcase 2:\n\t\tnew_bits = SAFARI_CFG_DIV_32;\n\t\tnew_freq /= 32;\n\t\tbreak;\n\n\tdefault:\n\t\tBUG();\n\t}\n\n\treturn smp_call_function_single(cpu, update_safari_cfg, &new_bits, 1);\n}\n\nstatic int us3_freq_cpu_init(struct cpufreq_policy *policy)\n{\n\tunsigned int cpu = policy->cpu;\n\tunsigned long clock_tick = sparc64_get_clock_tick(cpu) / 1000;\n\tstruct cpufreq_frequency_table *table =\n\t\t&us3_freq_table[cpu].table[0];\n\n\ttable[0].driver_data = 0;\n\ttable[0].frequency = clock_tick / 1;\n\ttable[1].driver_data = 1;\n\ttable[1].frequency = clock_tick / 2;\n\ttable[2].driver_data = 2;\n\ttable[2].frequency = clock_tick / 32;\n\ttable[3].driver_data = 0;\n\ttable[3].frequency = CPUFREQ_TABLE_END;\n\n\tpolicy->cpuinfo.transition_latency = 0;\n\tpolicy->cur = clock_tick;\n\tpolicy->freq_table = table;\n\n\treturn 0;\n}\n\nstatic int us3_freq_cpu_exit(struct cpufreq_policy *policy)\n{\n\tus3_freq_target(policy, 0);\n\treturn 0;\n}\n\nstatic struct cpufreq_driver cpufreq_us3_driver = {\n\t.name = \"UltraSPARC-III\",\n\t.init = us3_freq_cpu_init,\n\t.verify = cpufreq_generic_frequency_table_verify,\n\t.target_index = us3_freq_target,\n\t.get = us3_freq_get,\n\t.exit = us3_freq_cpu_exit,\n};\n\nstatic int __init us3_freq_init(void)\n{\n\tunsigned long manuf, impl, ver;\n\tint ret;\n\n\tif (tlb_type != cheetah && tlb_type != cheetah_plus)\n\t\treturn -ENODEV;\n\n\t__asm__(\"rdpr %%ver, %0\" : \"=r\" (ver));\n\tmanuf = ((ver >> 48) & 0xffff);\n\timpl  = ((ver >> 32) & 0xffff);\n\n\tif (manuf == CHEETAH_MANUF &&\n\t    (impl == CHEETAH_IMPL ||\n\t     impl == CHEETAH_PLUS_IMPL ||\n\t     impl == JAGUAR_IMPL ||\n\t     impl == PANTHER_IMPL)) {\n\t\tus3_freq_table = kzalloc(NR_CPUS * sizeof(*us3_freq_table),\n\t\t\t\t\t GFP_KERNEL);\n\t\tif (!us3_freq_table)\n\t\t\treturn -ENOMEM;\n\n\t\tret = cpufreq_register_driver(&cpufreq_us3_driver);\n\t\tif (ret)\n\t\t\tkfree(us3_freq_table);\n\n\t\treturn ret;\n\t}\n\n\treturn -ENODEV;\n}\n\nstatic void __exit us3_freq_exit(void)\n{\n\tcpufreq_unregister_driver(&cpufreq_us3_driver);\n\tkfree(us3_freq_table);\n}\n\nMODULE_AUTHOR(\"David S. Miller <davem@redhat.com>\");\nMODULE_DESCRIPTION(\"cpufreq driver for UltraSPARC-III\");\nMODULE_LICENSE(\"GPL\");\n\nmodule_init(us3_freq_init);\nmodule_exit(us3_freq_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}