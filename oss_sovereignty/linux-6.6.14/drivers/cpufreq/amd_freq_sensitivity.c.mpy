{
  "module_name": "amd_freq_sensitivity.c",
  "hash_id": "9cebe4fbbee8517e63a766f77d5e8ae7b3b763c175d0699d19980bb52b82a3ea",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/amd_freq_sensitivity.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/types.h>\n#include <linux/pci.h>\n#include <linux/percpu-defs.h>\n#include <linux/init.h>\n#include <linux/mod_devicetable.h>\n\n#include <asm/msr.h>\n#include <asm/cpufeature.h>\n#include <asm/cpu_device_id.h>\n\n#include \"cpufreq_ondemand.h\"\n\n#define MSR_AMD64_FREQ_SENSITIVITY_ACTUAL\t0xc0010080\n#define MSR_AMD64_FREQ_SENSITIVITY_REFERENCE\t0xc0010081\n#define CLASS_CODE_SHIFT\t\t\t56\n#define POWERSAVE_BIAS_MAX\t\t\t1000\n#define POWERSAVE_BIAS_DEF\t\t\t400\n\nstruct cpu_data_t {\n\tu64 actual;\n\tu64 reference;\n\tunsigned int freq_prev;\n};\n\nstatic DEFINE_PER_CPU(struct cpu_data_t, cpu_data);\n\nstatic unsigned int amd_powersave_bias_target(struct cpufreq_policy *policy,\n\t\t\t\t\t      unsigned int freq_next,\n\t\t\t\t\t      unsigned int relation)\n{\n\tint sensitivity;\n\tlong d_actual, d_reference;\n\tstruct msr actual, reference;\n\tstruct cpu_data_t *data = &per_cpu(cpu_data, policy->cpu);\n\tstruct policy_dbs_info *policy_dbs = policy->governor_data;\n\tstruct dbs_data *od_data = policy_dbs->dbs_data;\n\tstruct od_dbs_tuners *od_tuners = od_data->tuners;\n\n\tif (!policy->freq_table)\n\t\treturn freq_next;\n\n\trdmsr_on_cpu(policy->cpu, MSR_AMD64_FREQ_SENSITIVITY_ACTUAL,\n\t\t&actual.l, &actual.h);\n\trdmsr_on_cpu(policy->cpu, MSR_AMD64_FREQ_SENSITIVITY_REFERENCE,\n\t\t&reference.l, &reference.h);\n\tactual.h &= 0x00ffffff;\n\treference.h &= 0x00ffffff;\n\n\t \n\tif (actual.q < data->actual || reference.q < data->reference) {\n\t\tfreq_next = policy->cur;\n\t\tgoto out;\n\t}\n\n\td_actual = actual.q - data->actual;\n\td_reference = reference.q - data->reference;\n\n\t \n\tif (d_reference == 0) {\n\t\tfreq_next = policy->cur;\n\t\tgoto out;\n\t}\n\n\tsensitivity = POWERSAVE_BIAS_MAX -\n\t\t(POWERSAVE_BIAS_MAX * (d_reference - d_actual) / d_reference);\n\n\tclamp(sensitivity, 0, POWERSAVE_BIAS_MAX);\n\n\t \n\tif (sensitivity < od_tuners->powersave_bias) {\n\t\tif (data->freq_prev == policy->cur)\n\t\t\tfreq_next = policy->cur;\n\n\t\tif (freq_next > policy->cur)\n\t\t\tfreq_next = policy->cur;\n\t\telse if (freq_next < policy->cur)\n\t\t\tfreq_next = policy->min;\n\t\telse {\n\t\t\tunsigned int index;\n\n\t\t\tindex = cpufreq_table_find_index_h(policy,\n\t\t\t\t\t\t\t   policy->cur - 1,\n\t\t\t\t\t\t\t   relation & CPUFREQ_RELATION_E);\n\t\t\tfreq_next = policy->freq_table[index].frequency;\n\t\t}\n\n\t\tdata->freq_prev = freq_next;\n\t} else\n\t\tdata->freq_prev = 0;\n\nout:\n\tdata->actual = actual.q;\n\tdata->reference = reference.q;\n\treturn freq_next;\n}\n\nstatic int __init amd_freq_sensitivity_init(void)\n{\n\tu64 val;\n\tstruct pci_dev *pcidev;\n\tunsigned int pci_vendor;\n\n\tif (boot_cpu_data.x86_vendor == X86_VENDOR_AMD)\n\t\tpci_vendor = PCI_VENDOR_ID_AMD;\n\telse if (boot_cpu_data.x86_vendor == X86_VENDOR_HYGON)\n\t\tpci_vendor = PCI_VENDOR_ID_HYGON;\n\telse\n\t\treturn -ENODEV;\n\n\tpcidev = pci_get_device(pci_vendor,\n\t\t\tPCI_DEVICE_ID_AMD_KERNCZ_SMBUS, NULL);\n\n\tif (!pcidev) {\n\t\tif (!boot_cpu_has(X86_FEATURE_PROC_FEEDBACK))\n\t\t\treturn -ENODEV;\n\t} else {\n\t\tpci_dev_put(pcidev);\n\t}\n\n\tif (rdmsrl_safe(MSR_AMD64_FREQ_SENSITIVITY_ACTUAL, &val))\n\t\treturn -ENODEV;\n\n\tif (!(val >> CLASS_CODE_SHIFT))\n\t\treturn -ENODEV;\n\n\tod_register_powersave_bias_handler(amd_powersave_bias_target,\n\t\t\tPOWERSAVE_BIAS_DEF);\n\treturn 0;\n}\nlate_initcall(amd_freq_sensitivity_init);\n\nstatic void __exit amd_freq_sensitivity_exit(void)\n{\n\tod_unregister_powersave_bias_handler();\n}\nmodule_exit(amd_freq_sensitivity_exit);\n\nstatic const struct x86_cpu_id __maybe_unused amd_freq_sensitivity_ids[] = {\n\tX86_MATCH_FEATURE(X86_FEATURE_PROC_FEEDBACK, NULL),\n\t{}\n};\nMODULE_DEVICE_TABLE(x86cpu, amd_freq_sensitivity_ids);\n\nMODULE_AUTHOR(\"Jacob Shin <jacob.shin@amd.com>\");\nMODULE_DESCRIPTION(\"AMD frequency sensitivity feedback powersave bias for \"\n\t\t\"the ondemand governor.\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}