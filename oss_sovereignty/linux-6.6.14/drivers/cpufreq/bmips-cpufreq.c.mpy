{
  "module_name": "bmips-cpufreq.c",
  "hash_id": "d27af5bad6240470cb92ed1e689f29ab53cbf9ce6ce4c5ee1dff14dd81fa87f1",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/bmips-cpufreq.c",
  "human_readable_source": " \n\n#include <linux/cpufreq.h>\n#include <linux/module.h>\n#include <linux/of_address.h>\n#include <linux/slab.h>\n\n \n#include <asm/time.h>\n\n#define BMIPS_CPUFREQ_PREFIX\t\"bmips\"\n#define BMIPS_CPUFREQ_NAME\tBMIPS_CPUFREQ_PREFIX \"-cpufreq\"\n\n#define TRANSITION_LATENCY\t(25 * 1000)\t \n\n#define BMIPS5_CLK_DIV_SET_SHIFT\t0x7\n#define BMIPS5_CLK_DIV_SHIFT\t\t0x4\n#define BMIPS5_CLK_DIV_MASK\t\t0xf\n\nenum bmips_type {\n\tBMIPS5000,\n\tBMIPS5200,\n};\n\nstruct cpufreq_compat {\n\tconst char *compatible;\n\tunsigned int bmips_type;\n\tunsigned int clk_mult;\n\tunsigned int max_freqs;\n};\n\n#define BMIPS(c, t, m, f) { \\\n\t.compatible = c, \\\n\t.bmips_type = (t), \\\n\t.clk_mult = (m), \\\n\t.max_freqs = (f), \\\n}\n\nstatic struct cpufreq_compat bmips_cpufreq_compat[] = {\n\tBMIPS(\"brcm,bmips5000\", BMIPS5000, 8, 4),\n\tBMIPS(\"brcm,bmips5200\", BMIPS5200, 8, 4),\n\t{ }\n};\n\nstatic struct cpufreq_compat *priv;\n\nstatic int htp_freq_to_cpu_freq(unsigned int clk_mult)\n{\n\treturn mips_hpt_frequency * clk_mult / 1000;\n}\n\nstatic struct cpufreq_frequency_table *\nbmips_cpufreq_get_freq_table(const struct cpufreq_policy *policy)\n{\n\tstruct cpufreq_frequency_table *table;\n\tunsigned long cpu_freq;\n\tint i;\n\n\tcpu_freq = htp_freq_to_cpu_freq(priv->clk_mult);\n\n\ttable = kmalloc_array(priv->max_freqs + 1, sizeof(*table), GFP_KERNEL);\n\tif (!table)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tfor (i = 0; i < priv->max_freqs; i++) {\n\t\ttable[i].frequency = cpu_freq / (1 << i);\n\t\ttable[i].driver_data = i;\n\t}\n\ttable[i].frequency = CPUFREQ_TABLE_END;\n\n\treturn table;\n}\n\nstatic unsigned int bmips_cpufreq_get(unsigned int cpu)\n{\n\tunsigned int div;\n\tuint32_t mode;\n\n\tswitch (priv->bmips_type) {\n\tcase BMIPS5200:\n\tcase BMIPS5000:\n\t\tmode = read_c0_brcm_mode();\n\t\tdiv = ((mode >> BMIPS5_CLK_DIV_SHIFT) & BMIPS5_CLK_DIV_MASK);\n\t\tbreak;\n\tdefault:\n\t\tdiv = 0;\n\t}\n\n\treturn htp_freq_to_cpu_freq(priv->clk_mult) / (1 << div);\n}\n\nstatic int bmips_cpufreq_target_index(struct cpufreq_policy *policy,\n\t\t\t\t      unsigned int index)\n{\n\tunsigned int div = policy->freq_table[index].driver_data;\n\n\tswitch (priv->bmips_type) {\n\tcase BMIPS5200:\n\tcase BMIPS5000:\n\t\tchange_c0_brcm_mode(BMIPS5_CLK_DIV_MASK << BMIPS5_CLK_DIV_SHIFT,\n\t\t\t\t    (1 << BMIPS5_CLK_DIV_SET_SHIFT) |\n\t\t\t\t    (div << BMIPS5_CLK_DIV_SHIFT));\n\t\tbreak;\n\tdefault:\n\t\treturn -ENOTSUPP;\n\t}\n\n\treturn 0;\n}\n\nstatic int bmips_cpufreq_exit(struct cpufreq_policy *policy)\n{\n\tkfree(policy->freq_table);\n\n\treturn 0;\n}\n\nstatic int bmips_cpufreq_init(struct cpufreq_policy *policy)\n{\n\tstruct cpufreq_frequency_table *freq_table;\n\n\tfreq_table = bmips_cpufreq_get_freq_table(policy);\n\tif (IS_ERR(freq_table)) {\n\t\tpr_err(\"%s: couldn't determine frequency table (%ld).\\n\",\n\t\t\tBMIPS_CPUFREQ_NAME, PTR_ERR(freq_table));\n\t\treturn PTR_ERR(freq_table);\n\t}\n\n\tcpufreq_generic_init(policy, freq_table, TRANSITION_LATENCY);\n\tpr_info(\"%s: registered\\n\", BMIPS_CPUFREQ_NAME);\n\n\treturn 0;\n}\n\nstatic struct cpufreq_driver bmips_cpufreq_driver = {\n\t.flags\t\t= CPUFREQ_NEED_INITIAL_FREQ_CHECK,\n\t.verify\t\t= cpufreq_generic_frequency_table_verify,\n\t.target_index\t= bmips_cpufreq_target_index,\n\t.get\t\t= bmips_cpufreq_get,\n\t.init\t\t= bmips_cpufreq_init,\n\t.exit\t\t= bmips_cpufreq_exit,\n\t.attr\t\t= cpufreq_generic_attr,\n\t.name\t\t= BMIPS_CPUFREQ_PREFIX,\n};\n\nstatic int __init bmips_cpufreq_driver_init(void)\n{\n\tstruct cpufreq_compat *cc;\n\tstruct device_node *np;\n\n\tfor (cc = bmips_cpufreq_compat; cc->compatible; cc++) {\n\t\tnp = of_find_compatible_node(NULL, \"cpu\", cc->compatible);\n\t\tif (np) {\n\t\t\tof_node_put(np);\n\t\t\tpriv = cc;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\tif (!cc->compatible)\n\t\treturn -ENODEV;\n\n\treturn cpufreq_register_driver(&bmips_cpufreq_driver);\n}\nmodule_init(bmips_cpufreq_driver_init);\n\nstatic void __exit bmips_cpufreq_driver_exit(void)\n{\n\tcpufreq_unregister_driver(&bmips_cpufreq_driver);\n}\nmodule_exit(bmips_cpufreq_driver_exit);\n\nMODULE_AUTHOR(\"Markus Mayer <mmayer@broadcom.com>\");\nMODULE_DESCRIPTION(\"CPUfreq driver for Broadcom BMIPS SoCs\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}