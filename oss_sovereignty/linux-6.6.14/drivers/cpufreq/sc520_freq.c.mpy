{
  "module_name": "sc520_freq.c",
  "hash_id": "1ce3927cd0593543056dcf5ba2f4f8634d06e00c28966754fb907ff090281ef9",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/sc520_freq.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n\n#include <linux/delay.h>\n#include <linux/cpufreq.h>\n#include <linux/timex.h>\n#include <linux/io.h>\n\n#include <asm/cpu_device_id.h>\n#include <asm/msr.h>\n\n#define MMCR_BASE\t0xfffef000\t \n#define OFFS_CPUCTL\t0x2    \n\nstatic __u8 __iomem *cpuctl;\n\nstatic struct cpufreq_frequency_table sc520_freq_table[] = {\n\t{0, 0x01,\t100000},\n\t{0, 0x02,\t133000},\n\t{0, 0,\tCPUFREQ_TABLE_END},\n};\n\nstatic unsigned int sc520_freq_get_cpu_frequency(unsigned int cpu)\n{\n\tu8 clockspeed_reg = *cpuctl;\n\n\tswitch (clockspeed_reg & 0x03) {\n\tdefault:\n\t\tpr_err(\"error: cpuctl register has unexpected value %02x\\n\",\n\t\t       clockspeed_reg);\n\t\tfallthrough;\n\tcase 0x01:\n\t\treturn 100000;\n\tcase 0x02:\n\t\treturn 133000;\n\t}\n}\n\nstatic int sc520_freq_target(struct cpufreq_policy *policy, unsigned int state)\n{\n\n\tu8 clockspeed_reg;\n\n\tlocal_irq_disable();\n\n\tclockspeed_reg = *cpuctl & ~0x03;\n\t*cpuctl = clockspeed_reg | sc520_freq_table[state].driver_data;\n\n\tlocal_irq_enable();\n\n\treturn 0;\n}\n\n \n\nstatic int sc520_freq_cpu_init(struct cpufreq_policy *policy)\n{\n\tstruct cpuinfo_x86 *c = &cpu_data(0);\n\n\t \n\tif (c->x86_vendor != X86_VENDOR_AMD ||\n\t    c->x86 != 4 || c->x86_model != 9)\n\t\treturn -ENODEV;\n\n\t \n\tpolicy->cpuinfo.transition_latency = 1000000;  \n\tpolicy->freq_table = sc520_freq_table;\n\n\treturn 0;\n}\n\n\nstatic struct cpufreq_driver sc520_freq_driver = {\n\t.get\t= sc520_freq_get_cpu_frequency,\n\t.verify\t= cpufreq_generic_frequency_table_verify,\n\t.target_index = sc520_freq_target,\n\t.init\t= sc520_freq_cpu_init,\n\t.name\t= \"sc520_freq\",\n\t.attr\t= cpufreq_generic_attr,\n};\n\nstatic const struct x86_cpu_id sc520_ids[] = {\n\tX86_MATCH_VENDOR_FAM_MODEL(AMD, 4, 9, NULL),\n\t{}\n};\nMODULE_DEVICE_TABLE(x86cpu, sc520_ids);\n\nstatic int __init sc520_freq_init(void)\n{\n\tint err;\n\n\tif (!x86_match_cpu(sc520_ids))\n\t\treturn -ENODEV;\n\n\tcpuctl = ioremap((unsigned long)(MMCR_BASE + OFFS_CPUCTL), 1);\n\tif (!cpuctl) {\n\t\tpr_err(\"sc520_freq: error: failed to remap memory\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\terr = cpufreq_register_driver(&sc520_freq_driver);\n\tif (err)\n\t\tiounmap(cpuctl);\n\n\treturn err;\n}\n\n\nstatic void __exit sc520_freq_exit(void)\n{\n\tcpufreq_unregister_driver(&sc520_freq_driver);\n\tiounmap(cpuctl);\n}\n\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Sean Young <sean@mess.org>\");\nMODULE_DESCRIPTION(\"cpufreq driver for AMD's Elan sc520 CPU\");\n\nmodule_init(sc520_freq_init);\nmodule_exit(sc520_freq_exit);\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}