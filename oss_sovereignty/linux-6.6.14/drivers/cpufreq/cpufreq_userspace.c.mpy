{
  "module_name": "cpufreq_userspace.c",
  "hash_id": "c78baf866410eb70add89fa9e91af69a89cf09b33807b524fc60a0c3c8b8acfa",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/cpufreq_userspace.c",
  "human_readable_source": "\n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/cpufreq.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/mutex.h>\n#include <linux/slab.h>\n\nstatic DEFINE_PER_CPU(unsigned int, cpu_is_managed);\nstatic DEFINE_MUTEX(userspace_mutex);\n\n \nstatic int cpufreq_set(struct cpufreq_policy *policy, unsigned int freq)\n{\n\tint ret = -EINVAL;\n\tunsigned int *setspeed = policy->governor_data;\n\n\tpr_debug(\"cpufreq_set for cpu %u, freq %u kHz\\n\", policy->cpu, freq);\n\n\tmutex_lock(&userspace_mutex);\n\tif (!per_cpu(cpu_is_managed, policy->cpu))\n\t\tgoto err;\n\n\t*setspeed = freq;\n\n\tret = __cpufreq_driver_target(policy, freq, CPUFREQ_RELATION_L);\n err:\n\tmutex_unlock(&userspace_mutex);\n\treturn ret;\n}\n\nstatic ssize_t show_speed(struct cpufreq_policy *policy, char *buf)\n{\n\treturn sprintf(buf, \"%u\\n\", policy->cur);\n}\n\nstatic int cpufreq_userspace_policy_init(struct cpufreq_policy *policy)\n{\n\tunsigned int *setspeed;\n\n\tsetspeed = kzalloc(sizeof(*setspeed), GFP_KERNEL);\n\tif (!setspeed)\n\t\treturn -ENOMEM;\n\n\tpolicy->governor_data = setspeed;\n\treturn 0;\n}\n\nstatic void cpufreq_userspace_policy_exit(struct cpufreq_policy *policy)\n{\n\tmutex_lock(&userspace_mutex);\n\tkfree(policy->governor_data);\n\tpolicy->governor_data = NULL;\n\tmutex_unlock(&userspace_mutex);\n}\n\nstatic int cpufreq_userspace_policy_start(struct cpufreq_policy *policy)\n{\n\tunsigned int *setspeed = policy->governor_data;\n\n\tBUG_ON(!policy->cur);\n\tpr_debug(\"started managing cpu %u\\n\", policy->cpu);\n\n\tmutex_lock(&userspace_mutex);\n\tper_cpu(cpu_is_managed, policy->cpu) = 1;\n\t*setspeed = policy->cur;\n\tmutex_unlock(&userspace_mutex);\n\treturn 0;\n}\n\nstatic void cpufreq_userspace_policy_stop(struct cpufreq_policy *policy)\n{\n\tunsigned int *setspeed = policy->governor_data;\n\n\tpr_debug(\"managing cpu %u stopped\\n\", policy->cpu);\n\n\tmutex_lock(&userspace_mutex);\n\tper_cpu(cpu_is_managed, policy->cpu) = 0;\n\t*setspeed = 0;\n\tmutex_unlock(&userspace_mutex);\n}\n\nstatic void cpufreq_userspace_policy_limits(struct cpufreq_policy *policy)\n{\n\tunsigned int *setspeed = policy->governor_data;\n\n\tmutex_lock(&userspace_mutex);\n\n\tpr_debug(\"limit event for cpu %u: %u - %u kHz, currently %u kHz, last set to %u kHz\\n\",\n\t\t policy->cpu, policy->min, policy->max, policy->cur, *setspeed);\n\n\tif (policy->max < *setspeed)\n\t\t__cpufreq_driver_target(policy, policy->max, CPUFREQ_RELATION_H);\n\telse if (policy->min > *setspeed)\n\t\t__cpufreq_driver_target(policy, policy->min, CPUFREQ_RELATION_L);\n\telse\n\t\t__cpufreq_driver_target(policy, *setspeed, CPUFREQ_RELATION_L);\n\n\tmutex_unlock(&userspace_mutex);\n}\n\nstatic struct cpufreq_governor cpufreq_gov_userspace = {\n\t.name\t\t= \"userspace\",\n\t.init\t\t= cpufreq_userspace_policy_init,\n\t.exit\t\t= cpufreq_userspace_policy_exit,\n\t.start\t\t= cpufreq_userspace_policy_start,\n\t.stop\t\t= cpufreq_userspace_policy_stop,\n\t.limits\t\t= cpufreq_userspace_policy_limits,\n\t.store_setspeed\t= cpufreq_set,\n\t.show_setspeed\t= show_speed,\n\t.owner\t\t= THIS_MODULE,\n};\n\nMODULE_AUTHOR(\"Dominik Brodowski <linux@brodo.de>, \"\n\t\t\"Russell King <rmk@arm.linux.org.uk>\");\nMODULE_DESCRIPTION(\"CPUfreq policy governor 'userspace'\");\nMODULE_LICENSE(\"GPL\");\n\n#ifdef CONFIG_CPU_FREQ_DEFAULT_GOV_USERSPACE\nstruct cpufreq_governor *cpufreq_default_governor(void)\n{\n\treturn &cpufreq_gov_userspace;\n}\n#endif\n\ncpufreq_governor_init(cpufreq_gov_userspace);\ncpufreq_governor_exit(cpufreq_gov_userspace);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}