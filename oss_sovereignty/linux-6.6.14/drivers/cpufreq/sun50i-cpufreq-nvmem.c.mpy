{
  "module_name": "sun50i-cpufreq-nvmem.c",
  "hash_id": "927f4bd76c6837e765dc9254b5853bafd70ddf32465892051ec8137b3d035ece",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/sun50i-cpufreq-nvmem.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/cpu.h>\n#include <linux/module.h>\n#include <linux/nvmem-consumer.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/pm_opp.h>\n#include <linux/slab.h>\n\n#define MAX_NAME_LEN\t7\n\n#define NVMEM_MASK\t0x7\n#define NVMEM_SHIFT\t5\n\nstatic struct platform_device *cpufreq_dt_pdev, *sun50i_cpufreq_pdev;\n\n \nstatic int sun50i_cpufreq_get_efuse(u32 *versions)\n{\n\tstruct nvmem_cell *speedbin_nvmem;\n\tstruct device_node *np;\n\tstruct device *cpu_dev;\n\tu32 *speedbin, efuse_value;\n\tsize_t len;\n\tint ret;\n\n\tcpu_dev = get_cpu_device(0);\n\tif (!cpu_dev)\n\t\treturn -ENODEV;\n\n\tnp = dev_pm_opp_of_get_opp_desc_node(cpu_dev);\n\tif (!np)\n\t\treturn -ENOENT;\n\n\tret = of_device_is_compatible(np,\n\t\t\t\t      \"allwinner,sun50i-h6-operating-points\");\n\tif (!ret) {\n\t\tof_node_put(np);\n\t\treturn -ENOENT;\n\t}\n\n\tspeedbin_nvmem = of_nvmem_cell_get(np, NULL);\n\tof_node_put(np);\n\tif (IS_ERR(speedbin_nvmem))\n\t\treturn dev_err_probe(cpu_dev, PTR_ERR(speedbin_nvmem),\n\t\t\t\t     \"Could not get nvmem cell\\n\");\n\n\tspeedbin = nvmem_cell_read(speedbin_nvmem, &len);\n\tnvmem_cell_put(speedbin_nvmem);\n\tif (IS_ERR(speedbin))\n\t\treturn PTR_ERR(speedbin);\n\n\tefuse_value = (*speedbin >> NVMEM_SHIFT) & NVMEM_MASK;\n\n\t \n\tif (efuse_value >= 1 && efuse_value <= 3)\n\t\t*versions = efuse_value - 1;\n\telse\n\t\t*versions = 0;\n\n\tkfree(speedbin);\n\treturn 0;\n};\n\nstatic int sun50i_cpufreq_nvmem_probe(struct platform_device *pdev)\n{\n\tint *opp_tokens;\n\tchar name[MAX_NAME_LEN];\n\tunsigned int cpu;\n\tu32 speed = 0;\n\tint ret;\n\n\topp_tokens = kcalloc(num_possible_cpus(), sizeof(*opp_tokens),\n\t\t\t     GFP_KERNEL);\n\tif (!opp_tokens)\n\t\treturn -ENOMEM;\n\n\tret = sun50i_cpufreq_get_efuse(&speed);\n\tif (ret) {\n\t\tkfree(opp_tokens);\n\t\treturn ret;\n\t}\n\n\tsnprintf(name, MAX_NAME_LEN, \"speed%d\", speed);\n\n\tfor_each_possible_cpu(cpu) {\n\t\tstruct device *cpu_dev = get_cpu_device(cpu);\n\n\t\tif (!cpu_dev) {\n\t\t\tret = -ENODEV;\n\t\t\tgoto free_opp;\n\t\t}\n\n\t\topp_tokens[cpu] = dev_pm_opp_set_prop_name(cpu_dev, name);\n\t\tif (opp_tokens[cpu] < 0) {\n\t\t\tret = opp_tokens[cpu];\n\t\t\tpr_err(\"Failed to set prop name\\n\");\n\t\t\tgoto free_opp;\n\t\t}\n\t}\n\n\tcpufreq_dt_pdev = platform_device_register_simple(\"cpufreq-dt\", -1,\n\t\t\t\t\t\t\t  NULL, 0);\n\tif (!IS_ERR(cpufreq_dt_pdev)) {\n\t\tplatform_set_drvdata(pdev, opp_tokens);\n\t\treturn 0;\n\t}\n\n\tret = PTR_ERR(cpufreq_dt_pdev);\n\tpr_err(\"Failed to register platform device\\n\");\n\nfree_opp:\n\tfor_each_possible_cpu(cpu)\n\t\tdev_pm_opp_put_prop_name(opp_tokens[cpu]);\n\tkfree(opp_tokens);\n\n\treturn ret;\n}\n\nstatic void sun50i_cpufreq_nvmem_remove(struct platform_device *pdev)\n{\n\tint *opp_tokens = platform_get_drvdata(pdev);\n\tunsigned int cpu;\n\n\tplatform_device_unregister(cpufreq_dt_pdev);\n\n\tfor_each_possible_cpu(cpu)\n\t\tdev_pm_opp_put_prop_name(opp_tokens[cpu]);\n\n\tkfree(opp_tokens);\n}\n\nstatic struct platform_driver sun50i_cpufreq_driver = {\n\t.probe = sun50i_cpufreq_nvmem_probe,\n\t.remove_new = sun50i_cpufreq_nvmem_remove,\n\t.driver = {\n\t\t.name = \"sun50i-cpufreq-nvmem\",\n\t},\n};\n\nstatic const struct of_device_id sun50i_cpufreq_match_list[] = {\n\t{ .compatible = \"allwinner,sun50i-h6\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(of, sun50i_cpufreq_match_list);\n\nstatic const struct of_device_id *sun50i_cpufreq_match_node(void)\n{\n\tconst struct of_device_id *match;\n\tstruct device_node *np;\n\n\tnp = of_find_node_by_path(\"/\");\n\tmatch = of_match_node(sun50i_cpufreq_match_list, np);\n\tof_node_put(np);\n\n\treturn match;\n}\n\n \nstatic int __init sun50i_cpufreq_init(void)\n{\n\tconst struct of_device_id *match;\n\tint ret;\n\n\tmatch = sun50i_cpufreq_match_node();\n\tif (!match)\n\t\treturn -ENODEV;\n\n\tret = platform_driver_register(&sun50i_cpufreq_driver);\n\tif (unlikely(ret < 0))\n\t\treturn ret;\n\n\tsun50i_cpufreq_pdev =\n\t\tplatform_device_register_simple(\"sun50i-cpufreq-nvmem\",\n\t\t\t\t\t\t-1, NULL, 0);\n\tret = PTR_ERR_OR_ZERO(sun50i_cpufreq_pdev);\n\tif (ret == 0)\n\t\treturn 0;\n\n\tplatform_driver_unregister(&sun50i_cpufreq_driver);\n\treturn ret;\n}\nmodule_init(sun50i_cpufreq_init);\n\nstatic void __exit sun50i_cpufreq_exit(void)\n{\n\tplatform_device_unregister(sun50i_cpufreq_pdev);\n\tplatform_driver_unregister(&sun50i_cpufreq_driver);\n}\nmodule_exit(sun50i_cpufreq_exit);\n\nMODULE_DESCRIPTION(\"Sun50i-h6 cpufreq driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}