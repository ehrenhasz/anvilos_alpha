{
  "module_name": "loongson2_cpufreq.c",
  "hash_id": "0de2a25cd44abb8c87da436f913a2b7eccae95212d697902e5b0df2dc85c6152",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/loongson2_cpufreq.c",
  "human_readable_source": " \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/cpufreq.h>\n#include <linux/module.h>\n#include <linux/err.h>\n#include <linux/delay.h>\n#include <linux/platform_device.h>\n\n#include <asm/idle.h>\n\n#include <asm/mach-loongson2ef/loongson.h>\n\nstatic uint nowait;\n\nstatic void (*saved_cpu_wait) (void);\n\nstatic int loongson2_cpu_freq_notifier(struct notifier_block *nb,\n\t\t\t\t\tunsigned long val, void *data);\n\nstatic struct notifier_block loongson2_cpufreq_notifier_block = {\n\t.notifier_call = loongson2_cpu_freq_notifier\n};\n\nstatic int loongson2_cpu_freq_notifier(struct notifier_block *nb,\n\t\t\t\t\tunsigned long val, void *data)\n{\n\tif (val == CPUFREQ_POSTCHANGE)\n\t\tcurrent_cpu_data.udelay_val = loops_per_jiffy;\n\n\treturn 0;\n}\n\n \nstatic int loongson2_cpufreq_target(struct cpufreq_policy *policy,\n\t\t\t\t     unsigned int index)\n{\n\tunsigned int freq;\n\n\tfreq =\n\t    ((cpu_clock_freq / 1000) *\n\t     loongson2_clockmod_table[index].driver_data) / 8;\n\n\t \n\tloongson2_cpu_set_rate(freq);\n\n\treturn 0;\n}\n\nstatic int loongson2_cpufreq_cpu_init(struct cpufreq_policy *policy)\n{\n\tint i;\n\tunsigned long rate;\n\tint ret;\n\n\trate = cpu_clock_freq / 1000;\n\tif (!rate)\n\t\treturn -EINVAL;\n\n\t \n\tfor (i = 2;\n\t     (loongson2_clockmod_table[i].frequency != CPUFREQ_TABLE_END);\n\t     i++)\n\t\tloongson2_clockmod_table[i].frequency = (rate * i) / 8;\n\n\tret = loongson2_cpu_set_rate(rate);\n\tif (ret)\n\t\treturn ret;\n\n\tcpufreq_generic_init(policy, &loongson2_clockmod_table[0], 0);\n\treturn 0;\n}\n\nstatic int loongson2_cpufreq_exit(struct cpufreq_policy *policy)\n{\n\treturn 0;\n}\n\nstatic struct cpufreq_driver loongson2_cpufreq_driver = {\n\t.name = \"loongson2\",\n\t.init = loongson2_cpufreq_cpu_init,\n\t.verify = cpufreq_generic_frequency_table_verify,\n\t.target_index = loongson2_cpufreq_target,\n\t.get = cpufreq_generic_get,\n\t.exit = loongson2_cpufreq_exit,\n\t.attr = cpufreq_generic_attr,\n};\n\nstatic const struct platform_device_id platform_device_ids[] = {\n\t{\n\t\t.name = \"loongson2_cpufreq\",\n\t},\n\t{}\n};\n\nMODULE_DEVICE_TABLE(platform, platform_device_ids);\n\nstatic struct platform_driver platform_driver = {\n\t.driver = {\n\t\t.name = \"loongson2_cpufreq\",\n\t},\n\t.id_table = platform_device_ids,\n};\n\n \n\nstatic DEFINE_SPINLOCK(loongson2_wait_lock);\n\nstatic void loongson2_cpu_wait(void)\n{\n\tunsigned long flags;\n\tu32 cpu_freq;\n\n\tspin_lock_irqsave(&loongson2_wait_lock, flags);\n\tcpu_freq = readl(LOONGSON_CHIPCFG);\n\t \n\twritel(readl(LOONGSON_CHIPCFG) & ~0x7, LOONGSON_CHIPCFG);\n\t \n\twritel(cpu_freq, LOONGSON_CHIPCFG);\n\tspin_unlock_irqrestore(&loongson2_wait_lock, flags);\n\tlocal_irq_enable();\n}\n\nstatic int __init cpufreq_init(void)\n{\n\tint ret;\n\n\t \n\tret = platform_driver_register(&platform_driver);\n\tif (ret)\n\t\treturn ret;\n\n\tpr_info(\"Loongson-2F CPU frequency driver\\n\");\n\n\tcpufreq_register_notifier(&loongson2_cpufreq_notifier_block,\n\t\t\t\t  CPUFREQ_TRANSITION_NOTIFIER);\n\n\tret = cpufreq_register_driver(&loongson2_cpufreq_driver);\n\n\tif (!ret && !nowait) {\n\t\tsaved_cpu_wait = cpu_wait;\n\t\tcpu_wait = loongson2_cpu_wait;\n\t}\n\n\treturn ret;\n}\n\nstatic void __exit cpufreq_exit(void)\n{\n\tif (!nowait && saved_cpu_wait)\n\t\tcpu_wait = saved_cpu_wait;\n\tcpufreq_unregister_driver(&loongson2_cpufreq_driver);\n\tcpufreq_unregister_notifier(&loongson2_cpufreq_notifier_block,\n\t\t\t\t    CPUFREQ_TRANSITION_NOTIFIER);\n\n\tplatform_driver_unregister(&platform_driver);\n}\n\nmodule_init(cpufreq_init);\nmodule_exit(cpufreq_exit);\n\nmodule_param(nowait, uint, 0644);\nMODULE_PARM_DESC(nowait, \"Disable Loongson-2F specific wait\");\n\nMODULE_AUTHOR(\"Yanhua <yanh@lemote.com>\");\nMODULE_DESCRIPTION(\"cpufreq driver for Loongson2F\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}