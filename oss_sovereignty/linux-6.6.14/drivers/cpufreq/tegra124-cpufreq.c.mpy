{
  "module_name": "tegra124-cpufreq.c",
  "hash_id": "82535bffc451d98526616fdd447b0905741444f9babf1f4ae577eae7a94d0e2a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/tegra124-cpufreq.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt)\tKBUILD_MODNAME \": \" fmt\n\n#include <linux/clk.h>\n#include <linux/cpufreq.h>\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_device.h>\n#include <linux/pm_opp.h>\n#include <linux/types.h>\n\nstruct tegra124_cpufreq_priv {\n\tstruct clk *cpu_clk;\n\tstruct clk *pllp_clk;\n\tstruct clk *pllx_clk;\n\tstruct clk *dfll_clk;\n\tstruct platform_device *cpufreq_dt_pdev;\n};\n\nstatic int tegra124_cpu_switch_to_dfll(struct tegra124_cpufreq_priv *priv)\n{\n\tstruct clk *orig_parent;\n\tint ret;\n\n\tret = clk_set_rate(priv->dfll_clk, clk_get_rate(priv->cpu_clk));\n\tif (ret)\n\t\treturn ret;\n\n\torig_parent = clk_get_parent(priv->cpu_clk);\n\tclk_set_parent(priv->cpu_clk, priv->pllp_clk);\n\n\tret = clk_prepare_enable(priv->dfll_clk);\n\tif (ret)\n\t\tgoto out;\n\n\tclk_set_parent(priv->cpu_clk, priv->dfll_clk);\n\n\treturn 0;\n\nout:\n\tclk_set_parent(priv->cpu_clk, orig_parent);\n\n\treturn ret;\n}\n\nstatic int tegra124_cpufreq_probe(struct platform_device *pdev)\n{\n\tstruct tegra124_cpufreq_priv *priv;\n\tstruct device_node *np;\n\tstruct device *cpu_dev;\n\tstruct platform_device_info cpufreq_dt_devinfo = {};\n\tint ret;\n\n\tpriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tcpu_dev = get_cpu_device(0);\n\tif (!cpu_dev)\n\t\treturn -ENODEV;\n\n\tnp = of_cpu_device_node_get(0);\n\tif (!np)\n\t\treturn -ENODEV;\n\n\tpriv->cpu_clk = of_clk_get_by_name(np, \"cpu_g\");\n\tif (IS_ERR(priv->cpu_clk)) {\n\t\tret = PTR_ERR(priv->cpu_clk);\n\t\tgoto out_put_np;\n\t}\n\n\tpriv->dfll_clk = of_clk_get_by_name(np, \"dfll\");\n\tif (IS_ERR(priv->dfll_clk)) {\n\t\tret = PTR_ERR(priv->dfll_clk);\n\t\tgoto out_put_cpu_clk;\n\t}\n\n\tpriv->pllx_clk = of_clk_get_by_name(np, \"pll_x\");\n\tif (IS_ERR(priv->pllx_clk)) {\n\t\tret = PTR_ERR(priv->pllx_clk);\n\t\tgoto out_put_dfll_clk;\n\t}\n\n\tpriv->pllp_clk = of_clk_get_by_name(np, \"pll_p\");\n\tif (IS_ERR(priv->pllp_clk)) {\n\t\tret = PTR_ERR(priv->pllp_clk);\n\t\tgoto out_put_pllx_clk;\n\t}\n\n\tret = tegra124_cpu_switch_to_dfll(priv);\n\tif (ret)\n\t\tgoto out_put_pllp_clk;\n\n\tcpufreq_dt_devinfo.name = \"cpufreq-dt\";\n\tcpufreq_dt_devinfo.parent = &pdev->dev;\n\n\tpriv->cpufreq_dt_pdev =\n\t\tplatform_device_register_full(&cpufreq_dt_devinfo);\n\tif (IS_ERR(priv->cpufreq_dt_pdev)) {\n\t\tret = PTR_ERR(priv->cpufreq_dt_pdev);\n\t\tgoto out_put_pllp_clk;\n\t}\n\n\tplatform_set_drvdata(pdev, priv);\n\n\tof_node_put(np);\n\n\treturn 0;\n\nout_put_pllp_clk:\n\tclk_put(priv->pllp_clk);\nout_put_pllx_clk:\n\tclk_put(priv->pllx_clk);\nout_put_dfll_clk:\n\tclk_put(priv->dfll_clk);\nout_put_cpu_clk:\n\tclk_put(priv->cpu_clk);\nout_put_np:\n\tof_node_put(np);\n\n\treturn ret;\n}\n\nstatic int __maybe_unused tegra124_cpufreq_suspend(struct device *dev)\n{\n\tstruct tegra124_cpufreq_priv *priv = dev_get_drvdata(dev);\n\tint err;\n\n\t \n\terr = clk_set_parent(priv->cpu_clk, priv->pllp_clk);\n\tif (err < 0) {\n\t\tdev_err(dev, \"failed to reparent to PLLP: %d\\n\", err);\n\t\treturn err;\n\t}\n\n\tclk_disable_unprepare(priv->dfll_clk);\n\n\treturn 0;\n}\n\nstatic int __maybe_unused tegra124_cpufreq_resume(struct device *dev)\n{\n\tstruct tegra124_cpufreq_priv *priv = dev_get_drvdata(dev);\n\tint err;\n\n\t \n\terr = clk_prepare_enable(priv->dfll_clk);\n\tif (err < 0) {\n\t\tdev_err(dev, \"failed to enable DFLL clock for CPU: %d\\n\", err);\n\t\tgoto disable_cpufreq;\n\t}\n\n\terr = clk_set_parent(priv->cpu_clk, priv->dfll_clk);\n\tif (err < 0) {\n\t\tdev_err(dev, \"failed to reparent to DFLL clock: %d\\n\", err);\n\t\tgoto disable_dfll;\n\t}\n\n\treturn 0;\n\ndisable_dfll:\n\tclk_disable_unprepare(priv->dfll_clk);\ndisable_cpufreq:\n\tdisable_cpufreq();\n\n\treturn err;\n}\n\nstatic const struct dev_pm_ops tegra124_cpufreq_pm_ops = {\n\tSET_SYSTEM_SLEEP_PM_OPS(tegra124_cpufreq_suspend,\n\t\t\t\ttegra124_cpufreq_resume)\n};\n\nstatic struct platform_driver tegra124_cpufreq_platdrv = {\n\t.driver.name\t= \"cpufreq-tegra124\",\n\t.driver.pm\t= &tegra124_cpufreq_pm_ops,\n\t.probe\t\t= tegra124_cpufreq_probe,\n};\n\nstatic int __init tegra_cpufreq_init(void)\n{\n\tint ret;\n\tstruct platform_device *pdev;\n\n\tif (!(of_machine_is_compatible(\"nvidia,tegra124\") ||\n\t\tof_machine_is_compatible(\"nvidia,tegra210\")))\n\t\treturn -ENODEV;\n\n\t \n\tret = platform_driver_register(&tegra124_cpufreq_platdrv);\n\tif (ret)\n\t\treturn ret;\n\n\tpdev = platform_device_register_simple(\"cpufreq-tegra124\", -1, NULL, 0);\n\tif (IS_ERR(pdev)) {\n\t\tplatform_driver_unregister(&tegra124_cpufreq_platdrv);\n\t\treturn PTR_ERR(pdev);\n\t}\n\n\treturn 0;\n}\nmodule_init(tegra_cpufreq_init);\n\nMODULE_AUTHOR(\"Tuomas Tynkkynen <ttynkkynen@nvidia.com>\");\nMODULE_DESCRIPTION(\"cpufreq driver for NVIDIA Tegra124\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}