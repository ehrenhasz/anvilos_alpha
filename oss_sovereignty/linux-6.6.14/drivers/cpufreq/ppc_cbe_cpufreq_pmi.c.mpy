{
  "module_name": "ppc_cbe_cpufreq_pmi.c",
  "hash_id": "f4da6fedde248d850493be8e30b92dddf66d0bf389a2ca739cb104a910f37c39",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/ppc_cbe_cpufreq_pmi.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/types.h>\n#include <linux/timer.h>\n#include <linux/init.h>\n#include <linux/pm_qos.h>\n#include <linux/slab.h>\n\n#include <asm/processor.h>\n#include <asm/pmi.h>\n#include <asm/cell-regs.h>\n\n#ifdef DEBUG\n#include <asm/time.h>\n#endif\n\n#include \"ppc_cbe_cpufreq.h\"\n\nbool cbe_cpufreq_has_pmi = false;\nEXPORT_SYMBOL_GPL(cbe_cpufreq_has_pmi);\n\n \n\nint cbe_cpufreq_set_pmode_pmi(int cpu, unsigned int pmode)\n{\n\tint ret;\n\tpmi_message_t pmi_msg;\n#ifdef DEBUG\n\tlong time;\n#endif\n\tpmi_msg.type = PMI_TYPE_FREQ_CHANGE;\n\tpmi_msg.data1 =\tcbe_cpu_to_node(cpu);\n\tpmi_msg.data2 = pmode;\n\n#ifdef DEBUG\n\ttime = jiffies;\n#endif\n\tpmi_send_message(pmi_msg);\n\n#ifdef DEBUG\n\ttime = jiffies  - time;\n\ttime = jiffies_to_msecs(time);\n\tpr_debug(\"had to wait %lu ms for a transition using \" \\\n\t\t \"PMI\\n\", time);\n#endif\n\tret = pmi_msg.data2;\n\tpr_debug(\"PMI returned slow mode %d\\n\", ret);\n\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(cbe_cpufreq_set_pmode_pmi);\n\n\nstatic void cbe_cpufreq_handle_pmi(pmi_message_t pmi_msg)\n{\n\tstruct cpufreq_policy *policy;\n\tstruct freq_qos_request *req;\n\tu8 node, slow_mode;\n\tint cpu, ret;\n\n\tBUG_ON(pmi_msg.type != PMI_TYPE_FREQ_CHANGE);\n\n\tnode = pmi_msg.data1;\n\tslow_mode = pmi_msg.data2;\n\n\tcpu = cbe_node_to_cpu(node);\n\n\tpr_debug(\"cbe_handle_pmi: node: %d max_freq: %d\\n\", node, slow_mode);\n\n\tpolicy = cpufreq_cpu_get(cpu);\n\tif (!policy) {\n\t\tpr_warn(\"cpufreq policy not found cpu%d\\n\", cpu);\n\t\treturn;\n\t}\n\n\treq = policy->driver_data;\n\n\tret = freq_qos_update_request(req,\n\t\t\tpolicy->freq_table[slow_mode].frequency);\n\tif (ret < 0)\n\t\tpr_warn(\"Failed to update freq constraint: %d\\n\", ret);\n\telse\n\t\tpr_debug(\"limiting node %d to slow mode %d\\n\", node, slow_mode);\n\n\tcpufreq_cpu_put(policy);\n}\n\nstatic struct pmi_handler cbe_pmi_handler = {\n\t.type\t\t\t= PMI_TYPE_FREQ_CHANGE,\n\t.handle_pmi_message\t= cbe_cpufreq_handle_pmi,\n};\n\nvoid cbe_cpufreq_pmi_policy_init(struct cpufreq_policy *policy)\n{\n\tstruct freq_qos_request *req;\n\tint ret;\n\n\tif (!cbe_cpufreq_has_pmi)\n\t\treturn;\n\n\treq = kzalloc(sizeof(*req), GFP_KERNEL);\n\tif (!req)\n\t\treturn;\n\n\tret = freq_qos_add_request(&policy->constraints, req, FREQ_QOS_MAX,\n\t\t\t\t   policy->freq_table[0].frequency);\n\tif (ret < 0) {\n\t\tpr_err(\"Failed to add freq constraint (%d)\\n\", ret);\n\t\tkfree(req);\n\t\treturn;\n\t}\n\n\tpolicy->driver_data = req;\n}\nEXPORT_SYMBOL_GPL(cbe_cpufreq_pmi_policy_init);\n\nvoid cbe_cpufreq_pmi_policy_exit(struct cpufreq_policy *policy)\n{\n\tstruct freq_qos_request *req = policy->driver_data;\n\n\tif (cbe_cpufreq_has_pmi) {\n\t\tfreq_qos_remove_request(req);\n\t\tkfree(req);\n\t}\n}\nEXPORT_SYMBOL_GPL(cbe_cpufreq_pmi_policy_exit);\n\nvoid cbe_cpufreq_pmi_init(void)\n{\n\tif (!pmi_register_handler(&cbe_pmi_handler))\n\t\tcbe_cpufreq_has_pmi = true;\n}\nEXPORT_SYMBOL_GPL(cbe_cpufreq_pmi_init);\n\nvoid cbe_cpufreq_pmi_exit(void)\n{\n\tpmi_unregister_handler(&cbe_pmi_handler);\n\tcbe_cpufreq_has_pmi = false;\n}\nEXPORT_SYMBOL_GPL(cbe_cpufreq_pmi_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}