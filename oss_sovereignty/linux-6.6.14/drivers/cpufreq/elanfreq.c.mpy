{
  "module_name": "elanfreq.c",
  "hash_id": "e134be8956c69367cdf92ecb4d2a7cf3ad0f2c935ac01f7a848a36871eed51fe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/cpufreq/elanfreq.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n\n#include <linux/delay.h>\n#include <linux/cpufreq.h>\n\n#include <asm/cpu_device_id.h>\n#include <asm/msr.h>\n#include <linux/timex.h>\n#include <linux/io.h>\n\n#define REG_CSCIR 0x22\t\t \n#define REG_CSCDR 0x23\t\t \n\n \nstatic int max_freq;\n\nstruct s_elan_multiplier {\n\tint clock;\t\t \n\tint val40h;\t\t \n\tint val80h;\t\t \n};\n\n \nstatic struct s_elan_multiplier elan_multiplier[] = {\n\t{1000,\t0x02,\t0x18},\n\t{2000,\t0x02,\t0x10},\n\t{4000,\t0x02,\t0x08},\n\t{8000,\t0x00,\t0x00},\n\t{16000,\t0x00,\t0x02},\n\t{33000,\t0x00,\t0x04},\n\t{66000,\t0x01,\t0x04},\n\t{99000,\t0x01,\t0x05}\n};\n\nstatic struct cpufreq_frequency_table elanfreq_table[] = {\n\t{0, 0,\t1000},\n\t{0, 1,\t2000},\n\t{0, 2,\t4000},\n\t{0, 3,\t8000},\n\t{0, 4,\t16000},\n\t{0, 5,\t33000},\n\t{0, 6,\t66000},\n\t{0, 7,\t99000},\n\t{0, 0,\tCPUFREQ_TABLE_END},\n};\n\n\n \n\nstatic unsigned int elanfreq_get_cpu_frequency(unsigned int cpu)\n{\n\tu8 clockspeed_reg;     \n\n\tlocal_irq_disable();\n\toutb_p(0x80, REG_CSCIR);\n\tclockspeed_reg = inb_p(REG_CSCDR);\n\tlocal_irq_enable();\n\n\tif ((clockspeed_reg & 0xE0) == 0xE0)\n\t\treturn 0;\n\n\t \n\tif ((clockspeed_reg & 0xE0) == 0xC0) {\n\t\tif ((clockspeed_reg & 0x01) == 0)\n\t\t\treturn 66000;\n\t\telse\n\t\t\treturn 99000;\n\t}\n\n\t \n\tif ((clockspeed_reg & 0xE0) == 0xA0)\n\t\treturn 33000;\n\n\treturn (1<<((clockspeed_reg & 0xE0) >> 5)) * 1000;\n}\n\n\nstatic int elanfreq_target(struct cpufreq_policy *policy,\n\t\t\t    unsigned int state)\n{\n\t \n\n\t \n\n\tlocal_irq_disable();\n\toutb_p(0x40, REG_CSCIR);\t\t \n\toutb_p(0x00, REG_CSCDR);\n\tlocal_irq_enable();\t\t \n\tudelay(1000);\t\t\t \n\n\tlocal_irq_disable();\n\n\t \n\toutb_p(0x80, REG_CSCIR);\n\toutb_p(elan_multiplier[state].val80h, REG_CSCDR);\n\n\t \n\toutb_p(0x40, REG_CSCIR);\n\toutb_p(elan_multiplier[state].val40h, REG_CSCDR);\n\tudelay(10000);\n\tlocal_irq_enable();\n\n\treturn 0;\n}\n \n\nstatic int elanfreq_cpu_init(struct cpufreq_policy *policy)\n{\n\tstruct cpuinfo_x86 *c = &cpu_data(0);\n\tstruct cpufreq_frequency_table *pos;\n\n\t \n\tif ((c->x86_vendor != X86_VENDOR_AMD) ||\n\t    (c->x86 != 4) || (c->x86_model != 10))\n\t\treturn -ENODEV;\n\n\t \n\tif (!max_freq)\n\t\tmax_freq = elanfreq_get_cpu_frequency(0);\n\n\t \n\tcpufreq_for_each_entry(pos, elanfreq_table)\n\t\tif (pos->frequency > max_freq)\n\t\t\tpos->frequency = CPUFREQ_ENTRY_INVALID;\n\n\tpolicy->freq_table = elanfreq_table;\n\treturn 0;\n}\n\n\n#ifndef MODULE\n \nstatic int __init elanfreq_setup(char *str)\n{\n\tmax_freq = simple_strtoul(str, &str, 0);\n\tpr_warn(\"You're using the deprecated elanfreq command line option. Use elanfreq.max_freq instead, please!\\n\");\n\treturn 1;\n}\n__setup(\"elanfreq=\", elanfreq_setup);\n#endif\n\n\nstatic struct cpufreq_driver elanfreq_driver = {\n\t.get\t\t= elanfreq_get_cpu_frequency,\n\t.flags\t\t= CPUFREQ_NO_AUTO_DYNAMIC_SWITCHING,\n\t.verify\t\t= cpufreq_generic_frequency_table_verify,\n\t.target_index\t= elanfreq_target,\n\t.init\t\t= elanfreq_cpu_init,\n\t.name\t\t= \"elanfreq\",\n\t.attr\t\t= cpufreq_generic_attr,\n};\n\nstatic const struct x86_cpu_id elan_id[] = {\n\tX86_MATCH_VENDOR_FAM_MODEL(AMD, 4, 10, NULL),\n\t{}\n};\nMODULE_DEVICE_TABLE(x86cpu, elan_id);\n\nstatic int __init elanfreq_init(void)\n{\n\tif (!x86_match_cpu(elan_id))\n\t\treturn -ENODEV;\n\treturn cpufreq_register_driver(&elanfreq_driver);\n}\n\n\nstatic void __exit elanfreq_exit(void)\n{\n\tcpufreq_unregister_driver(&elanfreq_driver);\n}\n\n\nmodule_param(max_freq, int, 0444);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Robert Schwebel <r.schwebel@pengutronix.de>, \"\n\t\t\"Sven Geggus <sven@geggus.net>\");\nMODULE_DESCRIPTION(\"cpufreq driver for AMD's Elan CPUs\");\n\nmodule_init(elanfreq_init);\nmodule_exit(elanfreq_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}