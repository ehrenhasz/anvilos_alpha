{
  "module_name": "surface3-wmi.c",
  "hash_id": "f17618148aab3d40d503ec94f1e63b1e0e01aa6612b855d95eab03ee385a2c03",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/surface/surface3-wmi.c",
  "human_readable_source": "\n \n\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n\n#include <linux/acpi.h>\n#include <linux/dmi.h>\n#include <linux/input.h>\n#include <linux/mutex.h>\n#include <linux/platform_device.h>\n#include <linux/spi/spi.h>\n\nMODULE_AUTHOR(\"Benjamin Tissoires <benjamin.tissoires@redhat.com>\");\nMODULE_DESCRIPTION(\"Surface 3 platform driver\");\nMODULE_LICENSE(\"GPL\");\n\n#define ACPI_BUTTON_HID_LID\t\t\"PNP0C0D\"\n#define SPI_CTL_OBJ_NAME\t\t\"SPI\"\n#define SPI_TS_OBJ_NAME\t\t\t\"NTRG\"\n\n#define SURFACE3_LID_GUID \"F7CC25EC-D20B-404C-8903-0ED4359C18AE\"\n\nMODULE_ALIAS(\"wmi:\" SURFACE3_LID_GUID);\n\nstatic const struct dmi_system_id surface3_dmi_table[] = {\n#if defined(CONFIG_X86)\n\t{\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"Surface 3\"),\n\t\t},\n\t},\n#endif\n\t{ }\n};\n\nstruct surface3_wmi {\n\tstruct acpi_device *touchscreen_adev;\n\tstruct acpi_device *pnp0c0d_adev;\n\tstruct acpi_hotplug_context hp;\n\tstruct input_dev *input;\n};\n\nstatic struct platform_device *s3_wmi_pdev;\n\nstatic struct surface3_wmi s3_wmi;\n\nstatic DEFINE_MUTEX(s3_wmi_lock);\n\nstatic int s3_wmi_query_block(const char *guid, int instance, int *ret)\n{\n\tstruct acpi_buffer output = { ACPI_ALLOCATE_BUFFER, NULL };\n\tunion acpi_object *obj = NULL;\n\tacpi_status status;\n\tint error = 0;\n\n\tmutex_lock(&s3_wmi_lock);\n\tstatus = wmi_query_block(guid, instance, &output);\n\tif (ACPI_FAILURE(status)) {\n\t\terror = -EIO;\n\t\tgoto out_free_unlock;\n\t}\n\n\tobj = output.pointer;\n\n\tif (!obj || obj->type != ACPI_TYPE_INTEGER) {\n\t\tif (obj) {\n\t\t\tpr_err(\"query block returned object type: %d - buffer length:%d\\n\",\n\t\t\t       obj->type,\n\t\t\t       obj->type == ACPI_TYPE_BUFFER ?\n\t\t\t\t\t\tobj->buffer.length : 0);\n\t\t}\n\t\terror = -EINVAL;\n\t\tgoto out_free_unlock;\n\t}\n\t*ret = obj->integer.value;\n out_free_unlock:\n\tkfree(obj);\n\tmutex_unlock(&s3_wmi_lock);\n\treturn error;\n}\n\nstatic inline int s3_wmi_query_lid(int *ret)\n{\n\treturn s3_wmi_query_block(SURFACE3_LID_GUID, 0, ret);\n}\n\nstatic int s3_wmi_send_lid_state(void)\n{\n\tint ret, lid_sw;\n\n\tret = s3_wmi_query_lid(&lid_sw);\n\tif (ret)\n\t\treturn ret;\n\n\tinput_report_switch(s3_wmi.input, SW_LID, lid_sw);\n\tinput_sync(s3_wmi.input);\n\n\treturn 0;\n}\n\nstatic int s3_wmi_hp_notify(struct acpi_device *adev, u32 value)\n{\n\treturn s3_wmi_send_lid_state();\n}\n\nstatic acpi_status s3_wmi_attach_spi_device(acpi_handle handle,\n\t\t\t\t\t    u32 level,\n\t\t\t\t\t    void *data,\n\t\t\t\t\t    void **return_value)\n{\n\tstruct acpi_device *adev = acpi_fetch_acpi_dev(handle);\n\tstruct acpi_device **ts_adev = data;\n\n\tif (!adev || strncmp(acpi_device_bid(adev), SPI_TS_OBJ_NAME,\n\t\t\t     strlen(SPI_TS_OBJ_NAME)))\n\t\treturn AE_OK;\n\n\tif (*ts_adev) {\n\t\tpr_err(\"duplicate entry %s\\n\", SPI_TS_OBJ_NAME);\n\t\treturn AE_OK;\n\t}\n\n\t*ts_adev = adev;\n\n\treturn AE_OK;\n}\n\nstatic int s3_wmi_check_platform_device(struct device *dev, void *data)\n{\n\tstruct acpi_device *adev = ACPI_COMPANION(dev);\n\tstruct acpi_device *ts_adev = NULL;\n\tacpi_status status;\n\n\t \n\tif (!adev)\n\t\treturn 0;\n\n\t \n\tif (!strcmp(ACPI_BUTTON_HID_LID, acpi_device_hid(adev))) {\n\t\ts3_wmi.pnp0c0d_adev = adev;\n\t\treturn 0;\n\t}\n\n\t \n\tif (strncmp(acpi_device_bid(adev), SPI_CTL_OBJ_NAME,\n\t    strlen(SPI_CTL_OBJ_NAME)))\n\t\treturn 0;\n\n\tstatus = acpi_walk_namespace(ACPI_TYPE_DEVICE, adev->handle, 1,\n\t\t\t\t     s3_wmi_attach_spi_device, NULL,\n\t\t\t\t     &ts_adev, NULL);\n\tif (ACPI_FAILURE(status))\n\t\tdev_warn(dev, \"failed to enumerate SPI slaves\\n\");\n\n\tif (!ts_adev)\n\t\treturn 0;\n\n\ts3_wmi.touchscreen_adev = ts_adev;\n\n\treturn 0;\n}\n\nstatic int s3_wmi_create_and_register_input(struct platform_device *pdev)\n{\n\tstruct input_dev *input;\n\tint error;\n\n\tinput = devm_input_allocate_device(&pdev->dev);\n\tif (!input)\n\t\treturn -ENOMEM;\n\n\tinput->name = \"Lid Switch\";\n\tinput->phys = \"button/input0\";\n\tinput->id.bustype = BUS_HOST;\n\tinput->id.product = 0x0005;\n\n\tinput_set_capability(input, EV_SW, SW_LID);\n\n\terror = input_register_device(input);\n\tif (error)\n\t\treturn error;\n\n\ts3_wmi.input = input;\n\n\treturn 0;\n}\n\nstatic int __init s3_wmi_probe(struct platform_device *pdev)\n{\n\tint error;\n\n\tif (!dmi_check_system(surface3_dmi_table))\n\t\treturn -ENODEV;\n\n\tmemset(&s3_wmi, 0, sizeof(s3_wmi));\n\n\tbus_for_each_dev(&platform_bus_type, NULL, NULL,\n\t\t\t s3_wmi_check_platform_device);\n\n\tif (!s3_wmi.touchscreen_adev)\n\t\treturn -ENODEV;\n\n\tacpi_bus_trim(s3_wmi.pnp0c0d_adev);\n\n\terror = s3_wmi_create_and_register_input(pdev);\n\tif (error)\n\t\tgoto restore_acpi_lid;\n\n\tacpi_initialize_hp_context(s3_wmi.touchscreen_adev, &s3_wmi.hp,\n\t\t\t\t   s3_wmi_hp_notify, NULL);\n\n\ts3_wmi_send_lid_state();\n\n\treturn 0;\n\n restore_acpi_lid:\n\tacpi_bus_scan(s3_wmi.pnp0c0d_adev->handle);\n\treturn error;\n}\n\nstatic int s3_wmi_remove(struct platform_device *device)\n{\n\t \n\ts3_wmi.touchscreen_adev->hp = NULL;\n\n\t \n\tacpi_bus_scan(s3_wmi.pnp0c0d_adev->handle);\n\treturn 0;\n}\n\nstatic int __maybe_unused s3_wmi_resume(struct device *dev)\n{\n\ts3_wmi_send_lid_state();\n\treturn 0;\n}\nstatic SIMPLE_DEV_PM_OPS(s3_wmi_pm, NULL, s3_wmi_resume);\n\nstatic struct platform_driver s3_wmi_driver = {\n\t.driver = {\n\t\t.name = \"surface3-wmi\",\n\t\t.pm = &s3_wmi_pm,\n\t},\n\t.remove = s3_wmi_remove,\n};\n\nstatic int __init s3_wmi_init(void)\n{\n\tint error;\n\n\ts3_wmi_pdev = platform_device_alloc(\"surface3-wmi\", -1);\n\tif (!s3_wmi_pdev)\n\t\treturn -ENOMEM;\n\n\terror = platform_device_add(s3_wmi_pdev);\n\tif (error)\n\t\tgoto err_device_put;\n\n\terror = platform_driver_probe(&s3_wmi_driver, s3_wmi_probe);\n\tif (error)\n\t\tgoto err_device_del;\n\n\tpr_info(\"Surface 3 WMI Extras loaded\\n\");\n\treturn 0;\n\n err_device_del:\n\tplatform_device_del(s3_wmi_pdev);\n err_device_put:\n\tplatform_device_put(s3_wmi_pdev);\n\treturn error;\n}\n\nstatic void __exit s3_wmi_exit(void)\n{\n\tplatform_device_unregister(s3_wmi_pdev);\n\tplatform_driver_unregister(&s3_wmi_driver);\n}\n\nmodule_init(s3_wmi_init);\nmodule_exit(s3_wmi_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}