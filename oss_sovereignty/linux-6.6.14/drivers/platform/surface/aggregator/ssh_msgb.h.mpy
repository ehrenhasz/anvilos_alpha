{
  "module_name": "ssh_msgb.h",
  "hash_id": "082d379159d1cba56ce43af61ed9f108cd6365454586295563209dcf8df38757",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/surface/aggregator/ssh_msgb.h",
  "human_readable_source": " \n \n\n#ifndef _SURFACE_AGGREGATOR_SSH_MSGB_H\n#define _SURFACE_AGGREGATOR_SSH_MSGB_H\n\n#include <asm/unaligned.h>\n#include <linux/types.h>\n\n#include <linux/surface_aggregator/controller.h>\n#include <linux/surface_aggregator/serial_hub.h>\n\n \nstruct msgbuf {\n\tu8 *begin;\n\tu8 *end;\n\tu8 *ptr;\n};\n\n \nstatic inline void msgb_init(struct msgbuf *msgb, u8 *ptr, size_t cap)\n{\n\tmsgb->begin = ptr;\n\tmsgb->end = ptr + cap;\n\tmsgb->ptr = ptr;\n}\n\n \nstatic inline size_t msgb_bytes_used(const struct msgbuf *msgb)\n{\n\treturn msgb->ptr - msgb->begin;\n}\n\nstatic inline void __msgb_push_u8(struct msgbuf *msgb, u8 value)\n{\n\t*msgb->ptr = value;\n\tmsgb->ptr += sizeof(u8);\n}\n\nstatic inline void __msgb_push_u16(struct msgbuf *msgb, u16 value)\n{\n\tput_unaligned_le16(value, msgb->ptr);\n\tmsgb->ptr += sizeof(u16);\n}\n\n \nstatic inline void msgb_push_u16(struct msgbuf *msgb, u16 value)\n{\n\tif (WARN_ON(msgb->ptr + sizeof(u16) > msgb->end))\n\t\treturn;\n\n\t__msgb_push_u16(msgb, value);\n}\n\n \nstatic inline void msgb_push_syn(struct msgbuf *msgb)\n{\n\tmsgb_push_u16(msgb, SSH_MSG_SYN);\n}\n\n \nstatic inline void msgb_push_buf(struct msgbuf *msgb, const u8 *buf, size_t len)\n{\n\tmsgb->ptr = memcpy(msgb->ptr, buf, len) + len;\n}\n\n \nstatic inline void msgb_push_crc(struct msgbuf *msgb, const u8 *buf, size_t len)\n{\n\tmsgb_push_u16(msgb, ssh_crc(buf, len));\n}\n\n \nstatic inline void msgb_push_frame(struct msgbuf *msgb, u8 ty, u16 len, u8 seq)\n{\n\tu8 *const begin = msgb->ptr;\n\n\tif (WARN_ON(msgb->ptr + sizeof(struct ssh_frame) > msgb->end))\n\t\treturn;\n\n\t__msgb_push_u8(msgb, ty);\t \n\t__msgb_push_u16(msgb, len);\t \n\t__msgb_push_u8(msgb, seq);\t \n\n\tmsgb_push_crc(msgb, begin, msgb->ptr - begin);\n}\n\n \nstatic inline void msgb_push_ack(struct msgbuf *msgb, u8 seq)\n{\n\t \n\tmsgb_push_syn(msgb);\n\n\t \n\tmsgb_push_frame(msgb, SSH_FRAME_TYPE_ACK, 0x00, seq);\n\n\t \n\tmsgb_push_crc(msgb, msgb->ptr, 0);\n}\n\n \nstatic inline void msgb_push_nak(struct msgbuf *msgb)\n{\n\t \n\tmsgb_push_syn(msgb);\n\n\t \n\tmsgb_push_frame(msgb, SSH_FRAME_TYPE_NAK, 0x00, 0x00);\n\n\t \n\tmsgb_push_crc(msgb, msgb->ptr, 0);\n}\n\n \nstatic inline void msgb_push_cmd(struct msgbuf *msgb, u8 seq, u16 rqid,\n\t\t\t\t const struct ssam_request *rqst)\n{\n\tconst u8 type = SSH_FRAME_TYPE_DATA_SEQ;\n\tu8 *cmd;\n\n\t \n\tmsgb_push_syn(msgb);\n\n\t \n\tmsgb_push_frame(msgb, type, sizeof(struct ssh_command) + rqst->length, seq);\n\n\t \n\tif (WARN_ON(msgb->ptr + sizeof(struct ssh_command) > msgb->end))\n\t\treturn;\n\n\tcmd = msgb->ptr;\n\n\t__msgb_push_u8(msgb, SSH_PLD_TYPE_CMD);\t\t \n\t__msgb_push_u8(msgb, rqst->target_category);\t \n\t__msgb_push_u8(msgb, rqst->target_id);\t\t \n\t__msgb_push_u8(msgb, SSAM_SSH_TID_HOST);\t \n\t__msgb_push_u8(msgb, rqst->instance_id);\t \n\t__msgb_push_u16(msgb, rqid);\t\t\t \n\t__msgb_push_u8(msgb, rqst->command_id);\t\t \n\n\t \n\tmsgb_push_buf(msgb, rqst->payload, rqst->length);\n\n\t \n\tmsgb_push_crc(msgb, cmd, msgb->ptr - cmd);\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}