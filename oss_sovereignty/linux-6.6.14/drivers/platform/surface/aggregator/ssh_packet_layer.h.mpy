{
  "module_name": "ssh_packet_layer.h",
  "hash_id": "5cbf1ac446fafd3307854cd561a9b2cac360ff51c23da2835aecf08d75dd1b30",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/surface/aggregator/ssh_packet_layer.h",
  "human_readable_source": " \n \n\n#ifndef _SURFACE_AGGREGATOR_SSH_PACKET_LAYER_H\n#define _SURFACE_AGGREGATOR_SSH_PACKET_LAYER_H\n\n#include <linux/atomic.h>\n#include <linux/kfifo.h>\n#include <linux/ktime.h>\n#include <linux/list.h>\n#include <linux/serdev.h>\n#include <linux/spinlock.h>\n#include <linux/types.h>\n#include <linux/wait.h>\n#include <linux/workqueue.h>\n\n#include <linux/surface_aggregator/serial_hub.h>\n#include \"ssh_parser.h\"\n\n \nenum ssh_ptl_state_flags {\n\tSSH_PTL_SF_SHUTDOWN_BIT,\n};\n\n \nstruct ssh_ptl_ops {\n\tvoid (*data_received)(struct ssh_ptl *p, const struct ssam_span *data);\n};\n\n \nstruct ssh_ptl {\n\tstruct serdev_device *serdev;\n\tunsigned long state;\n\n\tstruct {\n\t\tspinlock_t lock;\n\t\tstruct list_head head;\n\t} queue;\n\n\tstruct {\n\t\tspinlock_t lock;\n\t\tstruct list_head head;\n\t\tatomic_t count;\n\t} pending;\n\n\tstruct {\n\t\tatomic_t running;\n\t\tstruct task_struct *thread;\n\t\tstruct completion thread_cplt_tx;\n\t\tstruct completion thread_cplt_pkt;\n\t\tstruct wait_queue_head packet_wq;\n\t} tx;\n\n\tstruct {\n\t\tstruct task_struct *thread;\n\t\tstruct wait_queue_head wq;\n\t\tstruct kfifo fifo;\n\t\tstruct sshp_buf buf;\n\n\t\tstruct {\n\t\t\tu16 seqs[8];\n\t\t\tu16 offset;\n\t\t} blocked;\n\t} rx;\n\n\tstruct {\n\t\tspinlock_t lock;\n\t\tktime_t timeout;\n\t\tktime_t expires;\n\t\tstruct delayed_work reaper;\n\t} rtx_timeout;\n\n\tstruct ssh_ptl_ops ops;\n};\n\n#define __ssam_prcond(func, p, fmt, ...)\t\t\\\n\tdo {\t\t\t\t\t\t\\\n\t\ttypeof(p) __p = (p);\t\t\t\\\n\t\t\t\t\t\t\t\\\n\t\tif (__p)\t\t\t\t\\\n\t\t\tfunc(__p, fmt, ##__VA_ARGS__);\t\\\n\t} while (0)\n\n#define ptl_dbg(p, fmt, ...)  dev_dbg(&(p)->serdev->dev, fmt, ##__VA_ARGS__)\n#define ptl_info(p, fmt, ...) dev_info(&(p)->serdev->dev, fmt, ##__VA_ARGS__)\n#define ptl_warn(p, fmt, ...) dev_warn(&(p)->serdev->dev, fmt, ##__VA_ARGS__)\n#define ptl_err(p, fmt, ...)  dev_err(&(p)->serdev->dev, fmt, ##__VA_ARGS__)\n#define ptl_dbg_cond(p, fmt, ...) __ssam_prcond(ptl_dbg, p, fmt, ##__VA_ARGS__)\n\n#define to_ssh_ptl(ptr, member) \\\n\tcontainer_of(ptr, struct ssh_ptl, member)\n\nint ssh_ptl_init(struct ssh_ptl *ptl, struct serdev_device *serdev,\n\t\t struct ssh_ptl_ops *ops);\n\nvoid ssh_ptl_destroy(struct ssh_ptl *ptl);\n\n \nstatic inline struct device *ssh_ptl_get_device(struct ssh_ptl *ptl)\n{\n\treturn ptl->serdev ? &ptl->serdev->dev : NULL;\n}\n\nint ssh_ptl_tx_start(struct ssh_ptl *ptl);\nint ssh_ptl_tx_stop(struct ssh_ptl *ptl);\nint ssh_ptl_rx_start(struct ssh_ptl *ptl);\nint ssh_ptl_rx_stop(struct ssh_ptl *ptl);\nvoid ssh_ptl_shutdown(struct ssh_ptl *ptl);\n\nint ssh_ptl_submit(struct ssh_ptl *ptl, struct ssh_packet *p);\nvoid ssh_ptl_cancel(struct ssh_packet *p);\n\nint ssh_ptl_rx_rcvbuf(struct ssh_ptl *ptl, const u8 *buf, size_t n);\n\n \nstatic inline void ssh_ptl_tx_wakeup_transfer(struct ssh_ptl *ptl)\n{\n\tif (test_bit(SSH_PTL_SF_SHUTDOWN_BIT, &ptl->state))\n\t\treturn;\n\n\tcomplete(&ptl->tx.thread_cplt_tx);\n}\n\nvoid ssh_packet_init(struct ssh_packet *packet, unsigned long type,\n\t\t     u8 priority, const struct ssh_packet_ops *ops);\n\nint ssh_ctrl_packet_cache_init(void);\nvoid ssh_ctrl_packet_cache_destroy(void);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}