{
  "module_name": "surface_platform_profile.c",
  "hash_id": "57eb8de240f0f0deea9d4e8b296db3dca8564a31c5bcd6ab37ebd4901ed4c6ec",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/surface/surface_platform_profile.c",
  "human_readable_source": "\n \n\n#include <asm/unaligned.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_profile.h>\n#include <linux/types.h>\n\n#include <linux/surface_aggregator/device.h>\n\nenum ssam_tmp_profile {\n\tSSAM_TMP_PROFILE_NORMAL             = 1,\n\tSSAM_TMP_PROFILE_BATTERY_SAVER      = 2,\n\tSSAM_TMP_PROFILE_BETTER_PERFORMANCE = 3,\n\tSSAM_TMP_PROFILE_BEST_PERFORMANCE   = 4,\n};\n\nstruct ssam_tmp_profile_info {\n\t__le32 profile;\n\t__le16 unknown1;\n\t__le16 unknown2;\n} __packed;\n\nstruct ssam_tmp_profile_device {\n\tstruct ssam_device *sdev;\n\tstruct platform_profile_handler handler;\n};\n\nSSAM_DEFINE_SYNC_REQUEST_CL_R(__ssam_tmp_profile_get, struct ssam_tmp_profile_info, {\n\t.target_category = SSAM_SSH_TC_TMP,\n\t.command_id      = 0x02,\n});\n\nSSAM_DEFINE_SYNC_REQUEST_CL_W(__ssam_tmp_profile_set, __le32, {\n\t.target_category = SSAM_SSH_TC_TMP,\n\t.command_id      = 0x03,\n});\n\nstatic int ssam_tmp_profile_get(struct ssam_device *sdev, enum ssam_tmp_profile *p)\n{\n\tstruct ssam_tmp_profile_info info;\n\tint status;\n\n\tstatus = ssam_retry(__ssam_tmp_profile_get, sdev, &info);\n\tif (status < 0)\n\t\treturn status;\n\n\t*p = le32_to_cpu(info.profile);\n\treturn 0;\n}\n\nstatic int ssam_tmp_profile_set(struct ssam_device *sdev, enum ssam_tmp_profile p)\n{\n\t__le32 profile_le = cpu_to_le32(p);\n\n\treturn ssam_retry(__ssam_tmp_profile_set, sdev, &profile_le);\n}\n\nstatic int convert_ssam_to_profile(struct ssam_device *sdev, enum ssam_tmp_profile p)\n{\n\tswitch (p) {\n\tcase SSAM_TMP_PROFILE_NORMAL:\n\t\treturn PLATFORM_PROFILE_BALANCED;\n\n\tcase SSAM_TMP_PROFILE_BATTERY_SAVER:\n\t\treturn PLATFORM_PROFILE_LOW_POWER;\n\n\tcase SSAM_TMP_PROFILE_BETTER_PERFORMANCE:\n\t\treturn PLATFORM_PROFILE_BALANCED_PERFORMANCE;\n\n\tcase SSAM_TMP_PROFILE_BEST_PERFORMANCE:\n\t\treturn PLATFORM_PROFILE_PERFORMANCE;\n\n\tdefault:\n\t\tdev_err(&sdev->dev, \"invalid performance profile: %d\", p);\n\t\treturn -EINVAL;\n\t}\n}\n\nstatic int convert_profile_to_ssam(struct ssam_device *sdev, enum platform_profile_option p)\n{\n\tswitch (p) {\n\tcase PLATFORM_PROFILE_LOW_POWER:\n\t\treturn SSAM_TMP_PROFILE_BATTERY_SAVER;\n\n\tcase PLATFORM_PROFILE_BALANCED:\n\t\treturn SSAM_TMP_PROFILE_NORMAL;\n\n\tcase PLATFORM_PROFILE_BALANCED_PERFORMANCE:\n\t\treturn SSAM_TMP_PROFILE_BETTER_PERFORMANCE;\n\n\tcase PLATFORM_PROFILE_PERFORMANCE:\n\t\treturn SSAM_TMP_PROFILE_BEST_PERFORMANCE;\n\n\tdefault:\n\t\t \n\t\tWARN(true, \"unsupported platform profile\");\n\t\treturn -EOPNOTSUPP;\n\t}\n}\n\nstatic int ssam_platform_profile_get(struct platform_profile_handler *pprof,\n\t\t\t\t     enum platform_profile_option *profile)\n{\n\tstruct ssam_tmp_profile_device *tpd;\n\tenum ssam_tmp_profile tp;\n\tint status;\n\n\ttpd = container_of(pprof, struct ssam_tmp_profile_device, handler);\n\n\tstatus = ssam_tmp_profile_get(tpd->sdev, &tp);\n\tif (status)\n\t\treturn status;\n\n\tstatus = convert_ssam_to_profile(tpd->sdev, tp);\n\tif (status < 0)\n\t\treturn status;\n\n\t*profile = status;\n\treturn 0;\n}\n\nstatic int ssam_platform_profile_set(struct platform_profile_handler *pprof,\n\t\t\t\t     enum platform_profile_option profile)\n{\n\tstruct ssam_tmp_profile_device *tpd;\n\tint tp;\n\n\ttpd = container_of(pprof, struct ssam_tmp_profile_device, handler);\n\n\ttp = convert_profile_to_ssam(tpd->sdev, profile);\n\tif (tp < 0)\n\t\treturn tp;\n\n\treturn ssam_tmp_profile_set(tpd->sdev, tp);\n}\n\nstatic int surface_platform_profile_probe(struct ssam_device *sdev)\n{\n\tstruct ssam_tmp_profile_device *tpd;\n\n\ttpd = devm_kzalloc(&sdev->dev, sizeof(*tpd), GFP_KERNEL);\n\tif (!tpd)\n\t\treturn -ENOMEM;\n\n\ttpd->sdev = sdev;\n\n\ttpd->handler.profile_get = ssam_platform_profile_get;\n\ttpd->handler.profile_set = ssam_platform_profile_set;\n\n\tset_bit(PLATFORM_PROFILE_LOW_POWER, tpd->handler.choices);\n\tset_bit(PLATFORM_PROFILE_BALANCED, tpd->handler.choices);\n\tset_bit(PLATFORM_PROFILE_BALANCED_PERFORMANCE, tpd->handler.choices);\n\tset_bit(PLATFORM_PROFILE_PERFORMANCE, tpd->handler.choices);\n\n\treturn platform_profile_register(&tpd->handler);\n}\n\nstatic void surface_platform_profile_remove(struct ssam_device *sdev)\n{\n\tplatform_profile_remove();\n}\n\nstatic const struct ssam_device_id ssam_platform_profile_match[] = {\n\t{ SSAM_SDEV(TMP, SAM, 0x00, 0x01) },\n\t{ },\n};\nMODULE_DEVICE_TABLE(ssam, ssam_platform_profile_match);\n\nstatic struct ssam_device_driver surface_platform_profile = {\n\t.probe = surface_platform_profile_probe,\n\t.remove = surface_platform_profile_remove,\n\t.match_table = ssam_platform_profile_match,\n\t.driver = {\n\t\t.name = \"surface_platform_profile\",\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n};\nmodule_ssam_device_driver(surface_platform_profile);\n\nMODULE_AUTHOR(\"Maximilian Luz <luzmaximilian@gmail.com>\");\nMODULE_DESCRIPTION(\"Platform Profile Support for Surface System Aggregator Module\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}