{
  "module_name": "surface_gpe.c",
  "hash_id": "b429ac3b5deae303b45ffc0c5fb7d84d6d913f5ac92cf839183c3c080a064419",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/surface/surface_gpe.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/acpi.h>\n#include <linux/dmi.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n\n \n\nstatic const struct property_entry lid_device_props_l17[] = {\n\tPROPERTY_ENTRY_U32(\"gpe\", 0x17),\n\t{},\n};\n\nstatic const struct property_entry lid_device_props_l4B[] = {\n\tPROPERTY_ENTRY_U32(\"gpe\", 0x4B),\n\t{},\n};\n\nstatic const struct property_entry lid_device_props_l4D[] = {\n\tPROPERTY_ENTRY_U32(\"gpe\", 0x4D),\n\t{},\n};\n\nstatic const struct property_entry lid_device_props_l4F[] = {\n\tPROPERTY_ENTRY_U32(\"gpe\", 0x4F),\n\t{},\n};\n\nstatic const struct property_entry lid_device_props_l57[] = {\n\tPROPERTY_ENTRY_U32(\"gpe\", 0x57),\n\t{},\n};\n\n \nstatic const struct dmi_system_id dmi_lid_device_table[] = {\n\t{\n\t\t.ident = \"Surface Pro 4\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Surface Pro 4\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l17,\n\t},\n\t{\n\t\t.ident = \"Surface Pro 5\",\n\t\t.matches = {\n\t\t\t \n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_SKU, \"Surface_Pro_1796\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l4F,\n\t},\n\t{\n\t\t.ident = \"Surface Pro 5 (LTE)\",\n\t\t.matches = {\n\t\t\t \n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_SKU, \"Surface_Pro_1807\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l4F,\n\t},\n\t{\n\t\t.ident = \"Surface Pro 6\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Surface Pro 6\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l4F,\n\t},\n\t{\n\t\t.ident = \"Surface Pro 7\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Surface Pro 7\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l4D,\n\t},\n\t{\n\t\t.ident = \"Surface Pro 8\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Surface Pro 8\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l4B,\n\t},\n\t{\n\t\t.ident = \"Surface Book 1\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Surface Book\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l17,\n\t},\n\t{\n\t\t.ident = \"Surface Book 2\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Surface Book 2\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l17,\n\t},\n\t{\n\t\t.ident = \"Surface Book 3\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Surface Book 3\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l4D,\n\t},\n\t{\n\t\t.ident = \"Surface Laptop 1\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Surface Laptop\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l57,\n\t},\n\t{\n\t\t.ident = \"Surface Laptop 2\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Surface Laptop 2\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l57,\n\t},\n\t{\n\t\t.ident = \"Surface Laptop 3 (Intel 13\\\")\",\n\t\t.matches = {\n\t\t\t \n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_SKU, \"Surface_Laptop_3_1867:1868\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l4D,\n\t},\n\t{\n\t\t.ident = \"Surface Laptop 3 (Intel 15\\\")\",\n\t\t.matches = {\n\t\t\t \n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_SKU, \"Surface_Laptop_3_1872\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l4D,\n\t},\n\t{\n\t\t.ident = \"Surface Laptop 4 (Intel 13\\\")\",\n\t\t.matches = {\n\t\t\t \n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_SKU, \"Surface_Laptop_4_1950:1951\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l4B,\n\t},\n\t{\n\t\t.ident = \"Surface Laptop Studio\",\n\t\t.matches = {\n\t\t\tDMI_EXACT_MATCH(DMI_SYS_VENDOR, \"Microsoft Corporation\"),\n\t\t\tDMI_EXACT_MATCH(DMI_PRODUCT_NAME, \"Surface Laptop Studio\"),\n\t\t},\n\t\t.driver_data = (void *)lid_device_props_l4B,\n\t},\n\t{ }\n};\n\nstruct surface_lid_device {\n\tu32 gpe_number;\n};\n\nstatic int surface_lid_enable_wakeup(struct device *dev, bool enable)\n{\n\tconst struct surface_lid_device *lid = dev_get_drvdata(dev);\n\tint action = enable ? ACPI_GPE_ENABLE : ACPI_GPE_DISABLE;\n\tacpi_status status;\n\n\tstatus = acpi_set_gpe_wake_mask(NULL, lid->gpe_number, action);\n\tif (ACPI_FAILURE(status)) {\n\t\tdev_err(dev, \"failed to set GPE wake mask: %s\\n\",\n\t\t\tacpi_format_exception(status));\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic int __maybe_unused surface_gpe_suspend(struct device *dev)\n{\n\treturn surface_lid_enable_wakeup(dev, true);\n}\n\nstatic int __maybe_unused surface_gpe_resume(struct device *dev)\n{\n\treturn surface_lid_enable_wakeup(dev, false);\n}\n\nstatic SIMPLE_DEV_PM_OPS(surface_gpe_pm, surface_gpe_suspend, surface_gpe_resume);\n\nstatic int surface_gpe_probe(struct platform_device *pdev)\n{\n\tstruct surface_lid_device *lid;\n\tu32 gpe_number;\n\tacpi_status status;\n\tint ret;\n\n\tret = device_property_read_u32(&pdev->dev, \"gpe\", &gpe_number);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to read 'gpe' property: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tlid = devm_kzalloc(&pdev->dev, sizeof(*lid), GFP_KERNEL);\n\tif (!lid)\n\t\treturn -ENOMEM;\n\n\tlid->gpe_number = gpe_number;\n\tplatform_set_drvdata(pdev, lid);\n\n\tstatus = acpi_mark_gpe_for_wake(NULL, gpe_number);\n\tif (ACPI_FAILURE(status)) {\n\t\tdev_err(&pdev->dev, \"failed to mark GPE for wake: %s\\n\",\n\t\t\tacpi_format_exception(status));\n\t\treturn -EINVAL;\n\t}\n\n\tstatus = acpi_enable_gpe(NULL, gpe_number);\n\tif (ACPI_FAILURE(status)) {\n\t\tdev_err(&pdev->dev, \"failed to enable GPE: %s\\n\",\n\t\t\tacpi_format_exception(status));\n\t\treturn -EINVAL;\n\t}\n\n\tret = surface_lid_enable_wakeup(&pdev->dev, false);\n\tif (ret)\n\t\tacpi_disable_gpe(NULL, gpe_number);\n\n\treturn ret;\n}\n\nstatic int surface_gpe_remove(struct platform_device *pdev)\n{\n\tstruct surface_lid_device *lid = dev_get_drvdata(&pdev->dev);\n\n\t \n\tsurface_lid_enable_wakeup(&pdev->dev, false);\n\tacpi_disable_gpe(NULL, lid->gpe_number);\n\n\treturn 0;\n}\n\nstatic struct platform_driver surface_gpe_driver = {\n\t.probe = surface_gpe_probe,\n\t.remove = surface_gpe_remove,\n\t.driver = {\n\t\t.name = \"surface_gpe\",\n\t\t.pm = &surface_gpe_pm,\n\t\t.probe_type = PROBE_PREFER_ASYNCHRONOUS,\n\t},\n};\n\nstatic struct platform_device *surface_gpe_device;\n\nstatic int __init surface_gpe_init(void)\n{\n\tconst struct dmi_system_id *match;\n\tstruct platform_device *pdev;\n\tstruct fwnode_handle *fwnode;\n\tint status;\n\n\tmatch = dmi_first_match(dmi_lid_device_table);\n\tif (!match) {\n\t\tpr_info(\"no compatible Microsoft Surface device found, exiting\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tstatus = platform_driver_register(&surface_gpe_driver);\n\tif (status)\n\t\treturn status;\n\n\tfwnode = fwnode_create_software_node(match->driver_data, NULL);\n\tif (IS_ERR(fwnode)) {\n\t\tstatus = PTR_ERR(fwnode);\n\t\tgoto err_node;\n\t}\n\n\tpdev = platform_device_alloc(\"surface_gpe\", PLATFORM_DEVID_NONE);\n\tif (!pdev) {\n\t\tstatus = -ENOMEM;\n\t\tgoto err_alloc;\n\t}\n\n\tpdev->dev.fwnode = fwnode;\n\n\tstatus = platform_device_add(pdev);\n\tif (status)\n\t\tgoto err_add;\n\n\tsurface_gpe_device = pdev;\n\treturn 0;\n\nerr_add:\n\tplatform_device_put(pdev);\nerr_alloc:\n\tfwnode_remove_software_node(fwnode);\nerr_node:\n\tplatform_driver_unregister(&surface_gpe_driver);\n\treturn status;\n}\nmodule_init(surface_gpe_init);\n\nstatic void __exit surface_gpe_exit(void)\n{\n\tstruct fwnode_handle *fwnode = surface_gpe_device->dev.fwnode;\n\n\tplatform_device_unregister(surface_gpe_device);\n\tplatform_driver_unregister(&surface_gpe_driver);\n\tfwnode_remove_software_node(fwnode);\n}\nmodule_exit(surface_gpe_exit);\n\nMODULE_AUTHOR(\"Maximilian Luz <luzmaximilian@gmail.com>\");\nMODULE_DESCRIPTION(\"Surface GPE/Lid Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"dmi:*:svnMicrosoftCorporation:pnSurface*:*\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}