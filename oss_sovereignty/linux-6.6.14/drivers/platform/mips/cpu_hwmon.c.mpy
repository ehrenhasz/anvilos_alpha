{
  "module_name": "cpu_hwmon.c",
  "hash_id": "1c215e3cf018b28e3f5bfb7cf18a9aa1f97c56424fc39fb8aaaf3cc7ad4abf78",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/mips/cpu_hwmon.c",
  "human_readable_source": "\n#include <linux/err.h>\n#include <linux/module.h>\n#include <linux/reboot.h>\n#include <linux/jiffies.h>\n#include <linux/hwmon.h>\n#include <linux/hwmon-sysfs.h>\n\n#include <loongson.h>\n#include <boot_param.h>\n#include <loongson_hwmon.h>\n#include <loongson_regs.h>\n\nstatic int csr_temp_enable;\n\n \nint loongson3_cpu_temp(int cpu)\n{\n\tu32 reg, prid_rev;\n\n\tif (csr_temp_enable) {\n\t\treg = (csr_readl(LOONGSON_CSR_CPUTEMP) & 0xff);\n\t\tgoto out;\n\t}\n\n\treg = LOONGSON_CHIPTEMP(cpu);\n\tprid_rev = read_c0_prid() & PRID_REV_MASK;\n\n\tswitch (prid_rev) {\n\tcase PRID_REV_LOONGSON3A_R1:\n\t\treg = (reg >> 8) & 0xff;\n\t\tbreak;\n\tcase PRID_REV_LOONGSON3B_R1:\n\tcase PRID_REV_LOONGSON3B_R2:\n\tcase PRID_REV_LOONGSON3A_R2_0:\n\tcase PRID_REV_LOONGSON3A_R2_1:\n\t\treg = ((reg >> 8) & 0xff) - 100;\n\t\tbreak;\n\tcase PRID_REV_LOONGSON3A_R3_0:\n\tcase PRID_REV_LOONGSON3A_R3_1:\n\tdefault:\n\t\treg = (reg & 0xffff) * 731 / 0x4000 - 273;\n\t\tbreak;\n\t}\n\nout:\n\treturn (int)reg * 1000;\n}\n\nstatic int nr_packages;\nstatic struct device *cpu_hwmon_dev;\n\nstatic ssize_t cpu_temp_label(struct device *dev,\n\t\t\tstruct device_attribute *attr, char *buf)\n{\n\tint id = (to_sensor_dev_attr(attr))->index - 1;\n\n\treturn sprintf(buf, \"CPU %d Temperature\\n\", id);\n}\n\nstatic ssize_t get_cpu_temp(struct device *dev,\n\t\t\tstruct device_attribute *attr, char *buf)\n{\n\tint id = (to_sensor_dev_attr(attr))->index - 1;\n\tint value = loongson3_cpu_temp(id);\n\n\treturn sprintf(buf, \"%d\\n\", value);\n}\n\nstatic SENSOR_DEVICE_ATTR(temp1_input, 0444, get_cpu_temp, NULL, 1);\nstatic SENSOR_DEVICE_ATTR(temp1_label, 0444, cpu_temp_label, NULL, 1);\nstatic SENSOR_DEVICE_ATTR(temp2_input, 0444, get_cpu_temp, NULL, 2);\nstatic SENSOR_DEVICE_ATTR(temp2_label, 0444, cpu_temp_label, NULL, 2);\nstatic SENSOR_DEVICE_ATTR(temp3_input, 0444, get_cpu_temp, NULL, 3);\nstatic SENSOR_DEVICE_ATTR(temp3_label, 0444, cpu_temp_label, NULL, 3);\nstatic SENSOR_DEVICE_ATTR(temp4_input, 0444, get_cpu_temp, NULL, 4);\nstatic SENSOR_DEVICE_ATTR(temp4_label, 0444, cpu_temp_label, NULL, 4);\n\nstatic struct attribute *cpu_hwmon_attributes[] = {\n\t&sensor_dev_attr_temp1_input.dev_attr.attr,\n\t&sensor_dev_attr_temp1_label.dev_attr.attr,\n\t&sensor_dev_attr_temp2_input.dev_attr.attr,\n\t&sensor_dev_attr_temp2_label.dev_attr.attr,\n\t&sensor_dev_attr_temp3_input.dev_attr.attr,\n\t&sensor_dev_attr_temp3_label.dev_attr.attr,\n\t&sensor_dev_attr_temp4_input.dev_attr.attr,\n\t&sensor_dev_attr_temp4_label.dev_attr.attr,\n\tNULL\n};\n\nstatic umode_t cpu_hwmon_is_visible(struct kobject *kobj,\n\t\t\t\t    struct attribute *attr, int i)\n{\n\tint id = i / 2;\n\n\tif (id < nr_packages)\n\t\treturn attr->mode;\n\treturn 0;\n}\n\nstatic struct attribute_group cpu_hwmon_group = {\n\t.attrs = cpu_hwmon_attributes,\n\t.is_visible = cpu_hwmon_is_visible,\n};\n\nstatic const struct attribute_group *cpu_hwmon_groups[] = {\n\t&cpu_hwmon_group,\n\tNULL\n};\n\n#define CPU_THERMAL_THRESHOLD 90000\nstatic struct delayed_work thermal_work;\n\nstatic void do_thermal_timer(struct work_struct *work)\n{\n\tint i, value;\n\n\tfor (i = 0; i < nr_packages; i++) {\n\t\tvalue = loongson3_cpu_temp(i);\n\t\tif (value > CPU_THERMAL_THRESHOLD) {\n\t\t\tpr_emerg(\"Power off due to high temp: %d\\n\", value);\n\t\t\torderly_poweroff(true);\n\t\t}\n\t}\n\n\tschedule_delayed_work(&thermal_work, msecs_to_jiffies(5000));\n}\n\nstatic int __init loongson_hwmon_init(void)\n{\n\tpr_info(\"Loongson Hwmon Enter...\\n\");\n\n\tif (cpu_has_csr())\n\t\tcsr_temp_enable = csr_readl(LOONGSON_CSR_FEATURES) &\n\t\t\t\t  LOONGSON_CSRF_TEMP;\n\n\tnr_packages = loongson_sysconf.nr_cpus /\n\t\tloongson_sysconf.cores_per_package;\n\n\tcpu_hwmon_dev = hwmon_device_register_with_groups(NULL, \"cpu_hwmon\",\n\t\t\t\t\t\t\t  NULL, cpu_hwmon_groups);\n\tif (IS_ERR(cpu_hwmon_dev)) {\n\t\tpr_err(\"hwmon_device_register fail!\\n\");\n\t\treturn PTR_ERR(cpu_hwmon_dev);\n\t}\n\n\tINIT_DEFERRABLE_WORK(&thermal_work, do_thermal_timer);\n\tschedule_delayed_work(&thermal_work, msecs_to_jiffies(20000));\n\n\treturn 0;\n}\n\nstatic void __exit loongson_hwmon_exit(void)\n{\n\tcancel_delayed_work_sync(&thermal_work);\n\thwmon_device_unregister(cpu_hwmon_dev);\n}\n\nmodule_init(loongson_hwmon_init);\nmodule_exit(loongson_hwmon_exit);\n\nMODULE_AUTHOR(\"Yu Xiang <xiangy@lemote.com>\");\nMODULE_AUTHOR(\"Huacai Chen <chenhc@lemote.com>\");\nMODULE_DESCRIPTION(\"Loongson CPU Hwmon driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}