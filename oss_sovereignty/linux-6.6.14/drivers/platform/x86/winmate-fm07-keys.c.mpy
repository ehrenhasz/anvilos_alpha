{
  "module_name": "winmate-fm07-keys.c",
  "hash_id": "36bab813cc77de1d456a58bc35c66e695f71c3986a1af83d02a0631280f23234",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/winmate-fm07-keys.c",
  "human_readable_source": "\n\n\n\n\n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/input.h>\n#include <linux/ioport.h>\n#include <linux/platform_device.h>\n#include <linux/dmi.h>\n#include <linux/io.h>\n\n#define DRV_NAME\t\"winmate-fm07keys\"\n\n#define PORT_CMD\t0x6c\n#define PORT_DATA\t0x68\n\n#define EC_ADDR_KEYS\t0x3b\n#define EC_CMD_READ\t0x80\n\n#define BASE_KEY\tKEY_F13\n#define NUM_KEYS\t5\n\n \n#define LOOP_TIMEOUT\t1000\n\nstatic void fm07keys_poll(struct input_dev *input)\n{\n\tuint8_t k;\n\tint i;\n\n\t \n\ti = 0;\n\twhile (inb(PORT_CMD) & 0x01) {\n\t\tif (++i >= LOOP_TIMEOUT)\n\t\t\tgoto timeout;\n\t\tinb(PORT_DATA);\n\t}\n\n\t \n\toutb(EC_CMD_READ, PORT_CMD);\n\ti = 0;\n\twhile (inb(PORT_CMD) & 0x02)\n\t\tif (++i >= LOOP_TIMEOUT)\n\t\t\tgoto timeout;\n\n\toutb(EC_ADDR_KEYS, PORT_DATA);\n\ti = 0;\n\twhile (inb(PORT_CMD) & 0x02)\n\t\tif (++i >= LOOP_TIMEOUT)\n\t\t\tgoto timeout;\n\n\t \n\ti = 0;\n\twhile (!(inb(PORT_CMD) & 0x01))\n\t\tif (++i >= LOOP_TIMEOUT)\n\t\t\tgoto timeout;\n\tk = inb(PORT_DATA);\n\n\t \n\tfor (i = 0; i < NUM_KEYS; i++) {\n\t\tinput_report_key(input, BASE_KEY + i, (~k) & 1);\n\t\tk >>= 1;\n\t}\n\n\tinput_sync(input);\n\treturn;\n\ntimeout:\n\tdev_warn_ratelimited(&input->dev, \"timeout polling IO memory\\n\");\n}\n\nstatic int fm07keys_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct input_dev *input;\n\tint ret;\n\tint i;\n\n\tinput = devm_input_allocate_device(dev);\n\tif (!input) {\n\t\tdev_err(dev, \"no memory for input device\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tif (!devm_request_region(dev, PORT_CMD, 1, \"Winmate FM07 EC\"))\n\t\treturn -EBUSY;\n\tif (!devm_request_region(dev, PORT_DATA, 1, \"Winmate FM07 EC\"))\n\t\treturn -EBUSY;\n\n\tinput->name = \"Winmate FM07 front-panel keys\";\n\tinput->phys = DRV_NAME \"/input0\";\n\n\tinput->id.bustype = BUS_HOST;\n\tinput->id.vendor = 0x0001;\n\tinput->id.product = 0x0001;\n\tinput->id.version = 0x0100;\n\n\t__set_bit(EV_KEY, input->evbit);\n\n\tfor (i = 0; i < NUM_KEYS; i++)\n\t\t__set_bit(BASE_KEY + i, input->keybit);\n\n\tret = input_setup_polling(input, fm07keys_poll);\n\tif (ret) {\n\t\tdev_err(dev, \"unable to set up polling, err=%d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\t \n\tinput_set_poll_interval(input, 20);\n\n\tret = input_register_device(input);\n\tif (ret) {\n\t\tdev_err(dev, \"unable to register polled device, err=%d\\n\",\n\t\t\tret);\n\t\treturn ret;\n\t}\n\n\tinput_sync(input);\n\treturn 0;\n}\n\nstatic struct platform_driver fm07keys_driver = {\n\t.probe\t\t= fm07keys_probe,\n\t.driver\t\t= {\n\t\t.name\t= DRV_NAME\n\t},\n};\n\nstatic struct platform_device *dev;\n\nstatic const struct dmi_system_id fm07keys_dmi_table[] __initconst = {\n\t{\n\t\t \n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Winmate Inc.\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"IP30\"),\n\t\t},\n\t},\n\t{ }\n};\n\nMODULE_DEVICE_TABLE(dmi, fm07keys_dmi_table);\n\nstatic int __init fm07keys_init(void)\n{\n\tint ret;\n\n\tif (!dmi_check_system(fm07keys_dmi_table))\n\t\treturn -ENODEV;\n\n\tret = platform_driver_register(&fm07keys_driver);\n\tif (ret) {\n\t\tpr_err(\"fm07keys: failed to register driver, err=%d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\tdev = platform_device_register_simple(DRV_NAME, PLATFORM_DEVID_NONE, NULL, 0);\n\tif (IS_ERR(dev)) {\n\t\tret = PTR_ERR(dev);\n\t\tpr_err(\"fm07keys: failed to allocate device, err = %d\\n\", ret);\n\t\tgoto fail_register;\n\t}\n\n\treturn 0;\n\nfail_register:\n\tplatform_driver_unregister(&fm07keys_driver);\n\treturn ret;\n}\n\nstatic void __exit fm07keys_exit(void)\n{\n\tplatform_driver_unregister(&fm07keys_driver);\n\tplatform_device_unregister(dev);\n}\n\nmodule_init(fm07keys_init);\nmodule_exit(fm07keys_exit);\n\nMODULE_AUTHOR(\"Daniel Beer <daniel.beer@tirotech.co.nz>\");\nMODULE_DESCRIPTION(\"Winmate FM07 front-panel keys driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}