{
  "module_name": "pmc-quirks.c",
  "hash_id": "07addaff35627adc0328ccc5262a4604999f94419b0f035ff41b0c7279270e64",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/amd/pmc/pmc-quirks.c",
  "human_readable_source": "\n \n\n#include <linux/dmi.h>\n#include <linux/io.h>\n#include <linux/ioport.h>\n\n#include \"pmc.h\"\n\nstruct quirk_entry {\n\tu32 s2idle_bug_mmio;\n\tbool spurious_8042;\n};\n\nstatic struct quirk_entry quirk_s2idle_bug = {\n\t.s2idle_bug_mmio = 0xfed80380,\n};\n\nstatic struct quirk_entry quirk_spurious_8042 = {\n\t.spurious_8042 = true,\n};\n\nstatic const struct dmi_system_id fwbug_list[] = {\n\t{\n\t\t.ident = \"L14 Gen2 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"20X5\"),\n\t\t}\n\t},\n\t{\n\t\t.ident = \"T14s Gen2 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"20XF\"),\n\t\t}\n\t},\n\t{\n\t\t.ident = \"X13 Gen2 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"20XH\"),\n\t\t}\n\t},\n\t{\n\t\t.ident = \"T14 Gen2 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"20XK\"),\n\t\t}\n\t},\n\t{\n\t\t.ident = \"T14 Gen1 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"20UD\"),\n\t\t}\n\t},\n\t{\n\t\t.ident = \"T14 Gen1 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"20UE\"),\n\t\t}\n\t},\n\t{\n\t\t.ident = \"T14s Gen1 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"20UH\"),\n\t\t}\n\t},\n\t{\n\t\t.ident = \"T14s Gen1 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"20UJ\"),\n\t\t}\n\t},\n\t{\n\t\t.ident = \"P14s Gen1 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"20Y1\"),\n\t\t}\n\t},\n\t{\n\t\t.ident = \"P14s Gen2 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"21A0\"),\n\t\t}\n\t},\n\t{\n\t\t.ident = \"P14s Gen2 AMD\",\n\t\t.driver_data = &quirk_s2idle_bug,\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_VENDOR, \"LENOVO\"),\n\t\t\tDMI_MATCH(DMI_PRODUCT_NAME, \"21A1\"),\n\t\t}\n\t},\n\t \nstatic void amd_pmc_skip_nvme_smi_handler(u32 s2idle_bug_mmio)\n{\n\tvoid __iomem *addr;\n\tu8 val;\n\n\tif (!request_mem_region_muxed(s2idle_bug_mmio, 1, \"amd_pmc_pm80\"))\n\t\treturn;\n\n\taddr = ioremap(s2idle_bug_mmio, 1);\n\tif (!addr)\n\t\tgoto cleanup_resource;\n\n\tval = ioread8(addr);\n\tiowrite8(val & ~BIT(0), addr);\n\n\tiounmap(addr);\ncleanup_resource:\n\trelease_mem_region(s2idle_bug_mmio, 1);\n}\n\nvoid amd_pmc_process_restore_quirks(struct amd_pmc_dev *dev)\n{\n\tif (dev->quirks && dev->quirks->s2idle_bug_mmio)\n\t\tamd_pmc_skip_nvme_smi_handler(dev->quirks->s2idle_bug_mmio);\n}\n\nvoid amd_pmc_quirks_init(struct amd_pmc_dev *dev)\n{\n\tconst struct dmi_system_id *dmi_id;\n\n\tif (dev->cpu_id == AMD_CPU_ID_CZN)\n\t\tdev->disable_8042_wakeup = true;\n\n\tdmi_id = dmi_first_match(fwbug_list);\n\tif (!dmi_id)\n\t\treturn;\n\tdev->quirks = dmi_id->driver_data;\n\tif (dev->quirks->s2idle_bug_mmio)\n\t\tpr_info(\"Using s2idle quirk to avoid %s platform firmware bug\\n\",\n\t\t\tdmi_id->ident);\n\tif (dev->quirks->spurious_8042)\n\t\tdev->disable_8042_wakeup = true;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}