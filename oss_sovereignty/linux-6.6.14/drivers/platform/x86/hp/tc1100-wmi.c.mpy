{
  "module_name": "tc1100-wmi.c",
  "hash_id": "1415ce9cca61b06211ec56242d1f9776619e70c47825c47370708562742cca34",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/hp/tc1100-wmi.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/init.h>\n#include <linux/types.h>\n#include <linux/acpi.h>\n#include <linux/platform_device.h>\n\n#define GUID \"C364AC71-36DB-495A-8494-B439D472A505\"\n\n#define TC1100_INSTANCE_WIRELESS\t\t1\n#define TC1100_INSTANCE_JOGDIAL\t\t2\n\nMODULE_AUTHOR(\"Jamey Hicks, Carlos Corbacho\");\nMODULE_DESCRIPTION(\"HP Compaq TC1100 Tablet WMI Extras\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"wmi:C364AC71-36DB-495A-8494-B439D472A505\");\n\nstatic struct platform_device *tc1100_device;\n\nstruct tc1100_data {\n\tu32 wireless;\n\tu32 jogdial;\n};\n\n#ifdef CONFIG_PM\nstatic struct tc1100_data suspend_data;\n#endif\n\n \n\nstatic int get_state(u32 *out, u8 instance)\n{\n\tu32 tmp;\n\tacpi_status status;\n\tstruct acpi_buffer result = { ACPI_ALLOCATE_BUFFER, NULL };\n\tunion acpi_object *obj;\n\n\tif (!out)\n\t\treturn -EINVAL;\n\n\tif (instance > 2)\n\t\treturn -ENODEV;\n\n\tstatus = wmi_query_block(GUID, instance, &result);\n\tif (ACPI_FAILURE(status))\n\t\treturn -ENODEV;\n\n\tobj = (union acpi_object *) result.pointer;\n\tif (obj && obj->type == ACPI_TYPE_INTEGER) {\n\t\ttmp = obj->integer.value;\n\t} else {\n\t\ttmp = 0;\n\t}\n\n\tif (result.length > 0)\n\t\tkfree(result.pointer);\n\n\tswitch (instance) {\n\tcase TC1100_INSTANCE_WIRELESS:\n\t\t*out = (tmp == 3) ? 1 : 0;\n\t\treturn 0;\n\tcase TC1100_INSTANCE_JOGDIAL:\n\t\t*out = (tmp == 1) ? 0 : 1;\n\t\treturn 0;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n}\n\nstatic int set_state(u32 *in, u8 instance)\n{\n\tu32 value;\n\tacpi_status status;\n\tstruct acpi_buffer input;\n\n\tif (!in)\n\t\treturn -EINVAL;\n\n\tif (instance > 2)\n\t\treturn -ENODEV;\n\n\tswitch (instance) {\n\tcase TC1100_INSTANCE_WIRELESS:\n\t\tvalue = (*in) ? 1 : 2;\n\t\tbreak;\n\tcase TC1100_INSTANCE_JOGDIAL:\n\t\tvalue = (*in) ? 0 : 1;\n\t\tbreak;\n\tdefault:\n\t\treturn -ENODEV;\n\t}\n\n\tinput.length = sizeof(u32);\n\tinput.pointer = &value;\n\n\tstatus = wmi_set_block(GUID, instance, &input);\n\tif (ACPI_FAILURE(status))\n\t\treturn -ENODEV;\n\n\treturn 0;\n}\n\n \n\n \n#define show_set_bool(value, instance) \\\nstatic ssize_t \\\nshow_bool_##value(struct device *dev, struct device_attribute *attr, \\\n\tchar *buf) \\\n{ \\\n\tu32 result; \\\n\tacpi_status status = get_state(&result, instance); \\\n\tif (ACPI_SUCCESS(status)) \\\n\t\treturn sprintf(buf, \"%d\\n\", result); \\\n\treturn sprintf(buf, \"Read error\\n\"); \\\n} \\\n\\\nstatic ssize_t \\\nset_bool_##value(struct device *dev, struct device_attribute *attr, \\\n\tconst char *buf, size_t count) \\\n{ \\\n\tu32 tmp = simple_strtoul(buf, NULL, 10); \\\n\tacpi_status status = set_state(&tmp, instance); \\\n\t\tif (ACPI_FAILURE(status)) \\\n\t\t\treturn -EINVAL; \\\n\treturn count; \\\n} \\\nstatic DEVICE_ATTR(value, S_IRUGO | S_IWUSR, \\\n\tshow_bool_##value, set_bool_##value);\n\nshow_set_bool(wireless, TC1100_INSTANCE_WIRELESS);\nshow_set_bool(jogdial, TC1100_INSTANCE_JOGDIAL);\n\nstatic struct attribute *tc1100_attributes[] = {\n\t&dev_attr_wireless.attr,\n\t&dev_attr_jogdial.attr,\n\tNULL\n};\n\nstatic const struct attribute_group tc1100_attribute_group = {\n\t.attrs\t= tc1100_attributes,\n};\n\n \n\nstatic int __init tc1100_probe(struct platform_device *device)\n{\n\treturn sysfs_create_group(&device->dev.kobj, &tc1100_attribute_group);\n}\n\n\nstatic void tc1100_remove(struct platform_device *device)\n{\n\tsysfs_remove_group(&device->dev.kobj, &tc1100_attribute_group);\n}\n\n#ifdef CONFIG_PM\nstatic int tc1100_suspend(struct device *dev)\n{\n\tint ret;\n\n\tret = get_state(&suspend_data.wireless, TC1100_INSTANCE_WIRELESS);\n\tif (ret)\n\t\treturn ret;\n\n\tret = get_state(&suspend_data.jogdial, TC1100_INSTANCE_JOGDIAL);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic int tc1100_resume(struct device *dev)\n{\n\tint ret;\n\n\tret = set_state(&suspend_data.wireless, TC1100_INSTANCE_WIRELESS);\n\tif (ret)\n\t\treturn ret;\n\n\tret = set_state(&suspend_data.jogdial, TC1100_INSTANCE_JOGDIAL);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nstatic const struct dev_pm_ops tc1100_pm_ops = {\n\t.suspend\t= tc1100_suspend,\n\t.resume\t\t= tc1100_resume,\n\t.freeze\t\t= tc1100_suspend,\n\t.restore\t= tc1100_resume,\n};\n#endif\n\nstatic struct platform_driver tc1100_driver = {\n\t.driver = {\n\t\t.name = \"tc1100-wmi\",\n#ifdef CONFIG_PM\n\t\t.pm = &tc1100_pm_ops,\n#endif\n\t},\n\t.remove_new = tc1100_remove,\n};\n\nstatic int __init tc1100_init(void)\n{\n\tint error;\n\n\tif (!wmi_has_guid(GUID))\n\t\treturn -ENODEV;\n\n\ttc1100_device = platform_device_alloc(\"tc1100-wmi\", PLATFORM_DEVID_NONE);\n\tif (!tc1100_device)\n\t\treturn -ENOMEM;\n\n\terror = platform_device_add(tc1100_device);\n\tif (error)\n\t\tgoto err_device_put;\n\n\terror = platform_driver_probe(&tc1100_driver, tc1100_probe);\n\tif (error)\n\t\tgoto err_device_del;\n\n\tpr_info(\"HP Compaq TC1100 Tablet WMI Extras loaded\\n\");\n\treturn 0;\n\n err_device_del:\n\tplatform_device_del(tc1100_device);\n err_device_put:\n\tplatform_device_put(tc1100_device);\n\treturn error;\n}\n\nstatic void __exit tc1100_exit(void)\n{\n\tplatform_device_unregister(tc1100_device);\n\tplatform_driver_unregister(&tc1100_driver);\n}\n\nmodule_init(tc1100_init);\nmodule_exit(tc1100_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}