{
  "module_name": "isst_if_mbox_pci.c",
  "hash_id": "d668101496de85395bd0a905ad1df3b870edd58984c363f47ebd6834487b26fe",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/intel/speed_select_if/isst_if_mbox_pci.c",
  "human_readable_source": "\n \n\n#include <linux/cpufeature.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/sched/signal.h>\n#include <linux/uaccess.h>\n#include <uapi/linux/isst_if.h>\n\n#include \"isst_if_common.h\"\n\n#define PUNIT_MAILBOX_DATA\t\t0xA0\n#define PUNIT_MAILBOX_INTERFACE\t\t0xA4\n#define PUNIT_MAILBOX_BUSY_BIT\t\t31\n\n \n#define OS_MAILBOX_TIMEOUT_AVG_US\t40\n#define OS_MAILBOX_TIMEOUT_MAX_US\t1000\n\nstruct isst_if_device {\n\tstruct mutex mutex;\n};\n\nstatic int isst_if_mbox_cmd(struct pci_dev *pdev,\n\t\t\t    struct isst_if_mbox_cmd *mbox_cmd)\n{\n\ts64 tm_delta = 0;\n\tktime_t tm;\n\tu32 data;\n\tint ret;\n\n\t \n\ttm = ktime_get();\n\tdo {\n\t\tret = pci_read_config_dword(pdev, PUNIT_MAILBOX_INTERFACE,\n\t\t\t\t\t    &data);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (data & BIT_ULL(PUNIT_MAILBOX_BUSY_BIT)) {\n\t\t\tret = -EBUSY;\n\t\t\ttm_delta = ktime_us_delta(ktime_get(), tm);\n\t\t\tif (tm_delta > OS_MAILBOX_TIMEOUT_AVG_US)\n\t\t\t\tcond_resched();\n\t\t\tcontinue;\n\t\t}\n\t\tret = 0;\n\t\tbreak;\n\t} while (tm_delta < OS_MAILBOX_TIMEOUT_MAX_US);\n\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tret = pci_write_config_dword(pdev, PUNIT_MAILBOX_DATA,\n\t\t\t\t     mbox_cmd->req_data);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tdata = BIT_ULL(PUNIT_MAILBOX_BUSY_BIT) |\n\t\t      (mbox_cmd->parameter & GENMASK_ULL(13, 0)) << 16 |\n\t\t      (mbox_cmd->sub_command << 8) |\n\t\t      mbox_cmd->command;\n\n\tret = pci_write_config_dword(pdev, PUNIT_MAILBOX_INTERFACE, data);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\ttm_delta = 0;\n\ttm = ktime_get();\n\tdo {\n\t\tret = pci_read_config_dword(pdev, PUNIT_MAILBOX_INTERFACE,\n\t\t\t\t\t    &data);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tif (data & BIT_ULL(PUNIT_MAILBOX_BUSY_BIT)) {\n\t\t\tret = -EBUSY;\n\t\t\ttm_delta = ktime_us_delta(ktime_get(), tm);\n\t\t\tif (tm_delta > OS_MAILBOX_TIMEOUT_AVG_US)\n\t\t\t\tcond_resched();\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (data & 0xff)\n\t\t\treturn -ENXIO;\n\n\t\tret = pci_read_config_dword(pdev, PUNIT_MAILBOX_DATA, &data);\n\t\tif (ret)\n\t\t\treturn ret;\n\n\t\tmbox_cmd->resp_data = data;\n\t\tret = 0;\n\t\tbreak;\n\t} while (tm_delta < OS_MAILBOX_TIMEOUT_MAX_US);\n\n\treturn ret;\n}\n\nstatic long isst_if_mbox_proc_cmd(u8 *cmd_ptr, int *write_only, int resume)\n{\n\tstruct isst_if_mbox_cmd *mbox_cmd;\n\tstruct isst_if_device *punit_dev;\n\tstruct pci_dev *pdev;\n\tint ret;\n\n\tmbox_cmd = (struct isst_if_mbox_cmd *)cmd_ptr;\n\n\tif (isst_if_mbox_cmd_invalid(mbox_cmd))\n\t\treturn -EINVAL;\n\n\tif (isst_if_mbox_cmd_set_req(mbox_cmd) && !capable(CAP_SYS_ADMIN))\n\t\treturn -EPERM;\n\n\tpdev = isst_if_get_pci_dev(mbox_cmd->logical_cpu, 1, 30, 1);\n\tif (!pdev)\n\t\treturn -EINVAL;\n\n\tpunit_dev = pci_get_drvdata(pdev);\n\tif (!punit_dev)\n\t\treturn -EINVAL;\n\n\t \n\tmutex_lock(&punit_dev->mutex);\n\tret = isst_if_mbox_cmd(pdev, mbox_cmd);\n\tif (!ret && !resume && isst_if_mbox_cmd_set_req(mbox_cmd))\n\t\tret = isst_store_cmd(mbox_cmd->command,\n\t\t\t\t     mbox_cmd->sub_command,\n\t\t\t\t     mbox_cmd->logical_cpu, 1,\n\t\t\t\t     mbox_cmd->parameter,\n\t\t\t\t     mbox_cmd->req_data);\n\tmutex_unlock(&punit_dev->mutex);\n\tif (ret)\n\t\treturn ret;\n\n\t*write_only = 0;\n\n\treturn 0;\n}\n\nstatic const struct pci_device_id isst_if_mbox_ids[] = {\n\t{ PCI_VDEVICE(INTEL, PCI_DEVICE_ID_INTEL_CFG_MBOX_DEVID_0)},\n\t{ PCI_VDEVICE(INTEL, PCI_DEVICE_ID_INTEL_CFG_MBOX_DEVID_1)},\n\t{ 0 },\n};\nMODULE_DEVICE_TABLE(pci, isst_if_mbox_ids);\n\nstatic int isst_if_mbox_probe(struct pci_dev *pdev,\n\t\t\t      const struct pci_device_id *ent)\n{\n\tstruct isst_if_device *punit_dev;\n\tstruct isst_if_cmd_cb cb;\n\tint ret;\n\n\tpunit_dev = devm_kzalloc(&pdev->dev, sizeof(*punit_dev), GFP_KERNEL);\n\tif (!punit_dev)\n\t\treturn -ENOMEM;\n\n\tret = pcim_enable_device(pdev);\n\tif (ret)\n\t\treturn ret;\n\n\tmutex_init(&punit_dev->mutex);\n\tpci_set_drvdata(pdev, punit_dev);\n\n\tmemset(&cb, 0, sizeof(cb));\n\tcb.cmd_size = sizeof(struct isst_if_mbox_cmd);\n\tcb.offset = offsetof(struct isst_if_mbox_cmds, mbox_cmd);\n\tcb.cmd_callback = isst_if_mbox_proc_cmd;\n\tcb.owner = THIS_MODULE;\n\tret = isst_if_cdev_register(ISST_IF_DEV_MBOX, &cb);\n\n\tif (ret)\n\t\tmutex_destroy(&punit_dev->mutex);\n\n\treturn ret;\n}\n\nstatic void isst_if_mbox_remove(struct pci_dev *pdev)\n{\n\tstruct isst_if_device *punit_dev;\n\n\tpunit_dev = pci_get_drvdata(pdev);\n\tisst_if_cdev_unregister(ISST_IF_DEV_MBOX);\n\tmutex_destroy(&punit_dev->mutex);\n}\n\nstatic int __maybe_unused isst_if_resume(struct device *device)\n{\n\tisst_resume_common();\n\treturn 0;\n}\n\nstatic SIMPLE_DEV_PM_OPS(isst_if_pm_ops, NULL, isst_if_resume);\n\nstatic struct pci_driver isst_if_pci_driver = {\n\t.name\t\t\t= \"isst_if_mbox_pci\",\n\t.id_table\t\t= isst_if_mbox_ids,\n\t.probe\t\t\t= isst_if_mbox_probe,\n\t.remove\t\t\t= isst_if_mbox_remove,\n\t.driver.pm\t\t= &isst_if_pm_ops,\n};\n\nmodule_pci_driver(isst_if_pci_driver);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"Intel speed select interface pci mailbox driver\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}