{
  "module_name": "sbl-fw-update.c",
  "hash_id": "9e3998196a714e2aa4fee01245cb7eff2acd4dfb51b1b0109685a4a7dddaad02",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/intel/wmi/sbl-fw-update.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/sysfs.h>\n#include <linux/wmi.h>\n\n#define INTEL_WMI_SBL_GUID  \"44FADEB1-B204-40F2-8581-394BBDC1B651\"\n\nstatic int get_fwu_request(struct device *dev, u32 *out)\n{\n\tstruct acpi_buffer result = {ACPI_ALLOCATE_BUFFER, NULL};\n\tunion acpi_object *obj;\n\tacpi_status status;\n\n\tstatus = wmi_query_block(INTEL_WMI_SBL_GUID, 0, &result);\n\tif (ACPI_FAILURE(status)) {\n\t\tdev_err(dev, \"wmi_query_block failed\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tobj = (union acpi_object *)result.pointer;\n\tif (!obj || obj->type != ACPI_TYPE_INTEGER) {\n\t\tdev_warn(dev, \"wmi_query_block returned invalid value\\n\");\n\t\tkfree(obj);\n\t\treturn -EINVAL;\n\t}\n\n\t*out = obj->integer.value;\n\tkfree(obj);\n\n\treturn 0;\n}\n\nstatic int set_fwu_request(struct device *dev, u32 in)\n{\n\tstruct acpi_buffer input;\n\tacpi_status status;\n\tu32 value;\n\n\tvalue = in;\n\tinput.length = sizeof(u32);\n\tinput.pointer = &value;\n\n\tstatus = wmi_set_block(INTEL_WMI_SBL_GUID, 0, &input);\n\tif (ACPI_FAILURE(status)) {\n\t\tdev_err(dev, \"wmi_set_block failed\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\treturn 0;\n}\n\nstatic ssize_t firmware_update_request_show(struct device *dev,\n\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t    char *buf)\n{\n\tu32 val;\n\tint ret;\n\n\tret = get_fwu_request(dev, &val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn sprintf(buf, \"%d\\n\", val);\n}\n\nstatic ssize_t firmware_update_request_store(struct device *dev,\n\t\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t\t     const char *buf, size_t count)\n{\n\tunsigned int val;\n\tint ret;\n\n\tret = kstrtouint(buf, 0, &val);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tif (val > 1)\n\t\treturn -ERANGE;\n\n\tret = set_fwu_request(dev, val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn count;\n}\nstatic DEVICE_ATTR_RW(firmware_update_request);\n\nstatic struct attribute *firmware_update_attrs[] = {\n\t&dev_attr_firmware_update_request.attr,\n\tNULL\n};\nATTRIBUTE_GROUPS(firmware_update);\n\nstatic int intel_wmi_sbl_fw_update_probe(struct wmi_device *wdev,\n\t\t\t\t\t const void *context)\n{\n\tdev_info(&wdev->dev, \"Slim Bootloader signaling driver attached\\n\");\n\treturn 0;\n}\n\nstatic void intel_wmi_sbl_fw_update_remove(struct wmi_device *wdev)\n{\n\tdev_info(&wdev->dev, \"Slim Bootloader signaling driver removed\\n\");\n}\n\nstatic const struct wmi_device_id intel_wmi_sbl_id_table[] = {\n\t{ .guid_string = INTEL_WMI_SBL_GUID },\n\t{}\n};\nMODULE_DEVICE_TABLE(wmi, intel_wmi_sbl_id_table);\n\nstatic struct wmi_driver intel_wmi_sbl_fw_update_driver = {\n\t.driver = {\n\t\t.name = \"intel-wmi-sbl-fw-update\",\n\t\t.dev_groups = firmware_update_groups,\n\t},\n\t.probe = intel_wmi_sbl_fw_update_probe,\n\t.remove = intel_wmi_sbl_fw_update_remove,\n\t.id_table = intel_wmi_sbl_id_table,\n};\nmodule_wmi_driver(intel_wmi_sbl_fw_update_driver);\n\nMODULE_AUTHOR(\"Jithu Joseph <jithu.joseph@intel.com>\");\nMODULE_DESCRIPTION(\"Slim Bootloader firmware update signaling driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}