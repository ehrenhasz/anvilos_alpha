{
  "module_name": "tgl.c",
  "hash_id": "77f425a19e319a4bd0f3fec46bf23d7bc6cc5d0d0626b2dd1bde90996897d5b5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/intel/pmc/tgl.c",
  "human_readable_source": "\n \n\n#include \"core.h\"\n\n#define ACPI_S0IX_DSM_UUID\t\t\"57a6512e-3979-4e9d-9708-ff13b2508972\"\n#define ACPI_GET_LOW_MODE_REGISTERS\t1\n\nconst struct pmc_bit_map tgl_pfear_map[] = {\n\t{\"PSF9\",\t\tBIT(0)},\n\t{\"RES_66\",\t\tBIT(1)},\n\t{\"RES_67\",\t\tBIT(2)},\n\t{\"RES_68\",\t\tBIT(3)},\n\t{\"RES_69\",\t\tBIT(4)},\n\t{\"RES_70\",\t\tBIT(5)},\n\t{\"TBTLSX\",\t\tBIT(6)},\n\t{}\n};\n\nconst struct pmc_bit_map *ext_tgl_pfear_map[] = {\n\t \n\tcnp_pfear_map,\n\ttgl_pfear_map,\n\tNULL\n};\n\nconst struct pmc_bit_map tgl_clocksource_status_map[] = {\n\t{\"USB2PLL_OFF_STS\",\t\t\tBIT(18)},\n\t{\"PCIe/USB3.1_Gen2PLL_OFF_STS\",\t\tBIT(19)},\n\t{\"PCIe_Gen3PLL_OFF_STS\",\t\tBIT(20)},\n\t{\"OPIOPLL_OFF_STS\",\t\t\tBIT(21)},\n\t{\"OCPLL_OFF_STS\",\t\t\tBIT(22)},\n\t{\"MainPLL_OFF_STS\",\t\t\tBIT(23)},\n\t{\"MIPIPLL_OFF_STS\",\t\t\tBIT(24)},\n\t{\"Fast_XTAL_Osc_OFF_STS\",\t\tBIT(25)},\n\t{\"AC_Ring_Osc_OFF_STS\",\t\t\tBIT(26)},\n\t{\"MC_Ring_Osc_OFF_STS\",\t\t\tBIT(27)},\n\t{\"SATAPLL_OFF_STS\",\t\t\tBIT(29)},\n\t{\"XTAL_USB2PLL_OFF_STS\",\t\tBIT(31)},\n\t{}\n};\n\nconst struct pmc_bit_map tgl_power_gating_status_map[] = {\n\t{\"CSME_PG_STS\",\t\t\t\tBIT(0)},\n\t{\"SATA_PG_STS\",\t\t\t\tBIT(1)},\n\t{\"xHCI_PG_STS\",\t\t\t\tBIT(2)},\n\t{\"UFSX2_PG_STS\",\t\t\tBIT(3)},\n\t{\"OTG_PG_STS\",\t\t\t\tBIT(5)},\n\t{\"SPA_PG_STS\",\t\t\t\tBIT(6)},\n\t{\"SPB_PG_STS\",\t\t\t\tBIT(7)},\n\t{\"SPC_PG_STS\",\t\t\t\tBIT(8)},\n\t{\"SPD_PG_STS\",\t\t\t\tBIT(9)},\n\t{\"SPE_PG_STS\",\t\t\t\tBIT(10)},\n\t{\"SPF_PG_STS\",\t\t\t\tBIT(11)},\n\t{\"LSX_PG_STS\",\t\t\t\tBIT(13)},\n\t{\"P2SB_PG_STS\",\t\t\t\tBIT(14)},\n\t{\"PSF_PG_STS\",\t\t\t\tBIT(15)},\n\t{\"SBR_PG_STS\",\t\t\t\tBIT(16)},\n\t{\"OPIDMI_PG_STS\",\t\t\tBIT(17)},\n\t{\"THC0_PG_STS\",\t\t\t\tBIT(18)},\n\t{\"THC1_PG_STS\",\t\t\t\tBIT(19)},\n\t{\"GBETSN_PG_STS\",\t\t\tBIT(20)},\n\t{\"GBE_PG_STS\",\t\t\t\tBIT(21)},\n\t{\"LPSS_PG_STS\",\t\t\t\tBIT(22)},\n\t{\"MMP_UFSX2_PG_STS\",\t\t\tBIT(23)},\n\t{\"MMP_UFSX2B_PG_STS\",\t\t\tBIT(24)},\n\t{\"FIA_PG_STS\",\t\t\t\tBIT(25)},\n\t{}\n};\n\nconst struct pmc_bit_map tgl_d3_status_map[] = {\n\t{\"ADSP_D3_STS\",\t\t\t\tBIT(0)},\n\t{\"SATA_D3_STS\",\t\t\t\tBIT(1)},\n\t{\"xHCI0_D3_STS\",\t\t\tBIT(2)},\n\t{\"xDCI1_D3_STS\",\t\t\tBIT(5)},\n\t{\"SDX_D3_STS\",\t\t\t\tBIT(6)},\n\t{\"EMMC_D3_STS\",\t\t\t\tBIT(7)},\n\t{\"IS_D3_STS\",\t\t\t\tBIT(8)},\n\t{\"THC0_D3_STS\",\t\t\t\tBIT(9)},\n\t{\"THC1_D3_STS\",\t\t\t\tBIT(10)},\n\t{\"GBE_D3_STS\",\t\t\t\tBIT(11)},\n\t{\"GBE_TSN_D3_STS\",\t\t\tBIT(12)},\n\t{}\n};\n\nconst struct pmc_bit_map tgl_vnn_req_status_map[] = {\n\t{\"GPIO_COM0_VNN_REQ_STS\",\t\tBIT(1)},\n\t{\"GPIO_COM1_VNN_REQ_STS\",\t\tBIT(2)},\n\t{\"GPIO_COM2_VNN_REQ_STS\",\t\tBIT(3)},\n\t{\"GPIO_COM3_VNN_REQ_STS\",\t\tBIT(4)},\n\t{\"GPIO_COM4_VNN_REQ_STS\",\t\tBIT(5)},\n\t{\"GPIO_COM5_VNN_REQ_STS\",\t\tBIT(6)},\n\t{\"Audio_VNN_REQ_STS\",\t\t\tBIT(7)},\n\t{\"ISH_VNN_REQ_STS\",\t\t\tBIT(8)},\n\t{\"CNVI_VNN_REQ_STS\",\t\t\tBIT(9)},\n\t{\"eSPI_VNN_REQ_STS\",\t\t\tBIT(10)},\n\t{\"Display_VNN_REQ_STS\",\t\t\tBIT(11)},\n\t{\"DTS_VNN_REQ_STS\",\t\t\tBIT(12)},\n\t{\"SMBUS_VNN_REQ_STS\",\t\t\tBIT(14)},\n\t{\"CSME_VNN_REQ_STS\",\t\t\tBIT(15)},\n\t{\"SMLINK0_VNN_REQ_STS\",\t\t\tBIT(16)},\n\t{\"SMLINK1_VNN_REQ_STS\",\t\t\tBIT(17)},\n\t{\"CLINK_VNN_REQ_STS\",\t\t\tBIT(20)},\n\t{\"DCI_VNN_REQ_STS\",\t\t\tBIT(21)},\n\t{\"ITH_VNN_REQ_STS\",\t\t\tBIT(22)},\n\t{\"CSME_VNN_REQ_STS\",\t\t\tBIT(24)},\n\t{\"GBE_VNN_REQ_STS\",\t\t\tBIT(25)},\n\t{}\n};\n\nconst struct pmc_bit_map tgl_vnn_misc_status_map[] = {\n\t{\"CPU_C10_REQ_STS_0\",\t\t\tBIT(0)},\n\t{\"PCIe_LPM_En_REQ_STS_3\",\t\tBIT(3)},\n\t{\"ITH_REQ_STS_5\",\t\t\tBIT(5)},\n\t{\"CNVI_REQ_STS_6\",\t\t\tBIT(6)},\n\t{\"ISH_REQ_STS_7\",\t\t\tBIT(7)},\n\t{\"USB2_SUS_PG_Sys_REQ_STS_10\",\t\tBIT(10)},\n\t{\"PCIe_Clk_REQ_STS_12\",\t\t\tBIT(12)},\n\t{\"MPHY_Core_DL_REQ_STS_16\",\t\tBIT(16)},\n\t{\"Break-even_En_REQ_STS_17\",\t\tBIT(17)},\n\t{\"Auto-demo_En_REQ_STS_18\",\t\tBIT(18)},\n\t{\"MPHY_SUS_REQ_STS_22\",\t\t\tBIT(22)},\n\t{\"xDCI_attached_REQ_STS_24\",\t\tBIT(24)},\n\t{}\n};\n\nconst struct pmc_bit_map tgl_signal_status_map[] = {\n\t{\"LSX_Wake0_En_STS\",\t\t\tBIT(0)},\n\t{\"LSX_Wake0_Pol_STS\",\t\t\tBIT(1)},\n\t{\"LSX_Wake1_En_STS\",\t\t\tBIT(2)},\n\t{\"LSX_Wake1_Pol_STS\",\t\t\tBIT(3)},\n\t{\"LSX_Wake2_En_STS\",\t\t\tBIT(4)},\n\t{\"LSX_Wake2_Pol_STS\",\t\t\tBIT(5)},\n\t{\"LSX_Wake3_En_STS\",\t\t\tBIT(6)},\n\t{\"LSX_Wake3_Pol_STS\",\t\t\tBIT(7)},\n\t{\"LSX_Wake4_En_STS\",\t\t\tBIT(8)},\n\t{\"LSX_Wake4_Pol_STS\",\t\t\tBIT(9)},\n\t{\"LSX_Wake5_En_STS\",\t\t\tBIT(10)},\n\t{\"LSX_Wake5_Pol_STS\",\t\t\tBIT(11)},\n\t{\"LSX_Wake6_En_STS\",\t\t\tBIT(12)},\n\t{\"LSX_Wake6_Pol_STS\",\t\t\tBIT(13)},\n\t{\"LSX_Wake7_En_STS\",\t\t\tBIT(14)},\n\t{\"LSX_Wake7_Pol_STS\",\t\t\tBIT(15)},\n\t{\"Intel_Se_IO_Wake0_En_STS\",\t\tBIT(16)},\n\t{\"Intel_Se_IO_Wake0_Pol_STS\",\t\tBIT(17)},\n\t{\"Intel_Se_IO_Wake1_En_STS\",\t\tBIT(18)},\n\t{\"Intel_Se_IO_Wake1_Pol_STS\",\t\tBIT(19)},\n\t{\"Int_Timer_SS_Wake0_En_STS\",\t\tBIT(20)},\n\t{\"Int_Timer_SS_Wake0_Pol_STS\",\t\tBIT(21)},\n\t{\"Int_Timer_SS_Wake1_En_STS\",\t\tBIT(22)},\n\t{\"Int_Timer_SS_Wake1_Pol_STS\",\t\tBIT(23)},\n\t{\"Int_Timer_SS_Wake2_En_STS\",\t\tBIT(24)},\n\t{\"Int_Timer_SS_Wake2_Pol_STS\",\t\tBIT(25)},\n\t{\"Int_Timer_SS_Wake3_En_STS\",\t\tBIT(26)},\n\t{\"Int_Timer_SS_Wake3_Pol_STS\",\t\tBIT(27)},\n\t{\"Int_Timer_SS_Wake4_En_STS\",\t\tBIT(28)},\n\t{\"Int_Timer_SS_Wake4_Pol_STS\",\t\tBIT(29)},\n\t{\"Int_Timer_SS_Wake5_En_STS\",\t\tBIT(30)},\n\t{\"Int_Timer_SS_Wake5_Pol_STS\",\t\tBIT(31)},\n\t{}\n};\n\nconst struct pmc_bit_map *tgl_lpm_maps[] = {\n\ttgl_clocksource_status_map,\n\ttgl_power_gating_status_map,\n\ttgl_d3_status_map,\n\ttgl_vnn_req_status_map,\n\ttgl_vnn_misc_status_map,\n\ttgl_signal_status_map,\n\tNULL\n};\n\nconst struct pmc_reg_map tgl_reg_map = {\n\t.pfear_sts = ext_tgl_pfear_map,\n\t.slp_s0_offset = CNP_PMC_SLP_S0_RES_COUNTER_OFFSET,\n\t.slp_s0_res_counter_step = TGL_PMC_SLP_S0_RES_COUNTER_STEP,\n\t.ltr_show_sts = cnp_ltr_show_map,\n\t.msr_sts = msr_map,\n\t.ltr_ignore_offset = CNP_PMC_LTR_IGNORE_OFFSET,\n\t.regmap_length = CNP_PMC_MMIO_REG_LEN,\n\t.ppfear0_offset = CNP_PMC_HOST_PPFEAR0A,\n\t.ppfear_buckets = ICL_PPFEAR_NUM_ENTRIES,\n\t.pm_cfg_offset = CNP_PMC_PM_CFG_OFFSET,\n\t.pm_read_disable_bit = CNP_PMC_READ_DISABLE_BIT,\n\t.ltr_ignore_max = TGL_NUM_IP_IGN_ALLOWED,\n\t.lpm_num_maps = TGL_LPM_NUM_MAPS,\n\t.lpm_res_counter_step_x2 = TGL_PMC_LPM_RES_COUNTER_STEP_X2,\n\t.lpm_sts_latch_en_offset = TGL_LPM_STS_LATCH_EN_OFFSET,\n\t.lpm_en_offset = TGL_LPM_EN_OFFSET,\n\t.lpm_priority_offset = TGL_LPM_PRI_OFFSET,\n\t.lpm_residency_offset = TGL_LPM_RESIDENCY_OFFSET,\n\t.lpm_sts = tgl_lpm_maps,\n\t.lpm_status_offset = TGL_LPM_STATUS_OFFSET,\n\t.lpm_live_status_offset = TGL_LPM_LIVE_STATUS_OFFSET,\n\t.etr3_offset = ETR3_OFFSET,\n};\n\nvoid pmc_core_get_tgl_lpm_reqs(struct platform_device *pdev)\n{\n\tstruct pmc_dev *pmcdev = platform_get_drvdata(pdev);\n\tstruct pmc *pmc = pmcdev->pmcs[PMC_IDX_MAIN];\n\tconst int num_maps = pmc->map->lpm_num_maps;\n\tu32 lpm_size = LPM_MAX_NUM_MODES * num_maps * 4;\n\tunion acpi_object *out_obj;\n\tstruct acpi_device *adev;\n\tguid_t s0ix_dsm_guid;\n\tu32 *lpm_req_regs, *addr;\n\n\tadev = ACPI_COMPANION(&pdev->dev);\n\tif (!adev)\n\t\treturn;\n\n\tguid_parse(ACPI_S0IX_DSM_UUID, &s0ix_dsm_guid);\n\n\tout_obj = acpi_evaluate_dsm_typed(adev->handle, &s0ix_dsm_guid, 0,\n\t\t\t\t\t  ACPI_GET_LOW_MODE_REGISTERS, NULL, ACPI_TYPE_BUFFER);\n\tif (out_obj) {\n\t\tu32 size = out_obj->buffer.length;\n\n\t\tif (size != lpm_size) {\n\t\t\tacpi_handle_debug(adev->handle,\n\t\t\t\t\"_DSM returned unexpected buffer size, have %u, expect %u\\n\",\n\t\t\t\tsize, lpm_size);\n\t\t\tgoto free_acpi_obj;\n\t\t}\n\t} else {\n\t\tacpi_handle_debug(adev->handle,\n\t\t\t\t  \"_DSM function 0 evaluation failed\\n\");\n\t\tgoto free_acpi_obj;\n\t}\n\n\taddr = (u32 *)out_obj->buffer.pointer;\n\n\tlpm_req_regs = devm_kzalloc(&pdev->dev, lpm_size * sizeof(u32),\n\t\t\t\t     GFP_KERNEL);\n\tif (!lpm_req_regs)\n\t\tgoto free_acpi_obj;\n\n\tmemcpy(lpm_req_regs, addr, lpm_size);\n\tpmc->lpm_req_regs = lpm_req_regs;\n\nfree_acpi_obj:\n\tACPI_FREE(out_obj);\n}\n\nint tgl_core_init(struct pmc_dev *pmcdev)\n{\n\tstruct pmc *pmc = pmcdev->pmcs[PMC_IDX_MAIN];\n\tint ret;\n\n\tpmc->map = &tgl_reg_map;\n\n\tpmcdev->suspend = cnl_suspend;\n\tpmcdev->resume = cnl_resume;\n\n\tret = get_primary_reg_base(pmc);\n\tif (ret)\n\t\treturn ret;\n\n\tpmc_core_get_tgl_lpm_reqs(pmcdev->pdev);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}