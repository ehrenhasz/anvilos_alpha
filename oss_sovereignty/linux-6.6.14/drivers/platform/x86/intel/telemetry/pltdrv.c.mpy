{
  "module_name": "pltdrv.c",
  "hash_id": "01e88ac8f34de93885c05130f0435754a3708c5c628e19a62ea51003b8e5594c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/intel/telemetry/pltdrv.c",
  "human_readable_source": "\n \n\n#include <linux/io.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n\n#include <asm/cpu_device_id.h>\n#include <asm/intel-family.h>\n#include <asm/intel_punit_ipc.h>\n#include <asm/intel_telemetry.h>\n\n#define DRIVER_NAME\t\"intel_telemetry\"\n#define DRIVER_VERSION\t\"1.0.0\"\n\n#define TELEM_TRC_VERBOSITY_MASK\t0x3\n\n#define TELEM_MIN_PERIOD(x)\t\t((x) & 0x7F0000)\n#define TELEM_MAX_PERIOD(x)\t\t((x) & 0x7F000000)\n#define TELEM_SAMPLE_PERIOD_INVALID(x)\t((x) & (BIT(7)))\n#define TELEM_CLEAR_SAMPLE_PERIOD(x)\t((x) &= ~0x7F)\n\n#define TELEM_SAMPLING_DEFAULT_PERIOD\t0xD\n\n#define TELEM_MAX_EVENTS_SRAM\t\t28\n#define TELEM_SSRAM_STARTTIME_OFFSET\t8\n#define TELEM_SSRAM_EVTLOG_OFFSET\t16\n\n#define IOSS_TELEM\t\t\t0xeb\n#define IOSS_TELEM_EVENT_READ\t\t0x0\n#define IOSS_TELEM_EVENT_WRITE\t\t0x1\n#define IOSS_TELEM_INFO_READ\t\t0x2\n#define IOSS_TELEM_TRACE_CTL_READ\t0x5\n#define IOSS_TELEM_TRACE_CTL_WRITE\t0x6\n#define IOSS_TELEM_EVENT_CTL_READ\t0x7\n#define IOSS_TELEM_EVENT_CTL_WRITE\t0x8\n#define IOSS_TELEM_EVT_WRITE_SIZE\t0x3\n\n#define TELEM_INFO_SRAMEVTS_MASK\t0xFF00\n#define TELEM_INFO_SRAMEVTS_SHIFT\t0x8\n#define TELEM_SSRAM_READ_TIMEOUT\t10\n\n#define TELEM_INFO_NENABLES_MASK\t0xFF\n#define TELEM_EVENT_ENABLE\t\t0x8000\n\n#define TELEM_MASK_BIT\t\t\t1\n#define TELEM_MASK_BYTE\t\t\t0xFF\n#define BYTES_PER_LONG\t\t\t8\n#define TELEM_MASK_PCS_STATE\t\t0xF\n\n#define TELEM_DISABLE(x)\t\t((x) &= ~(BIT(31)))\n#define TELEM_CLEAR_EVENTS(x)\t\t((x) |= (BIT(30)))\n#define TELEM_ENABLE_SRAM_EVT_TRACE(x)\t((x) &= ~(BIT(30) | BIT(24)))\n#define TELEM_ENABLE_PERIODIC(x)\t((x) |= (BIT(23) | BIT(31) | BIT(7)))\n#define TELEM_EXTRACT_VERBOSITY(x, y)\t((y) = (((x) >> 27) & 0x3))\n#define TELEM_CLEAR_VERBOSITY_BITS(x)\t((x) &= ~(BIT(27) | BIT(28)))\n#define TELEM_SET_VERBOSITY_BITS(x, y)\t((x) |= ((y) << 27))\n\nenum telemetry_action {\n\tTELEM_UPDATE = 0,\n\tTELEM_ADD,\n\tTELEM_RESET,\n\tTELEM_ACTION_NONE\n};\n\nstruct telem_ssram_region {\n\tu64 timestamp;\n\tu64 start_time;\n\tu64 events[TELEM_MAX_EVENTS_SRAM];\n};\n\nstatic struct telemetry_plt_config *telm_conf;\n\n \nstatic struct telemetry_evtmap\n\ttelemetry_apl_ioss_default_events[TELEM_MAX_OS_ALLOCATED_EVENTS] = {\n\t{\"SOC_S0IX_TOTAL_RES\",\t\t\t0x4800},\n\t{\"SOC_S0IX_TOTAL_OCC\",\t\t\t0x4000},\n\t{\"SOC_S0IX_SHALLOW_RES\",\t\t0x4801},\n\t{\"SOC_S0IX_SHALLOW_OCC\",\t\t0x4001},\n\t{\"SOC_S0IX_DEEP_RES\",\t\t\t0x4802},\n\t{\"SOC_S0IX_DEEP_OCC\",\t\t\t0x4002},\n\t{\"PMC_POWER_GATE\",\t\t\t0x5818},\n\t{\"PMC_D3_STATES\",\t\t\t0x5819},\n\t{\"PMC_D0I3_STATES\",\t\t\t0x581A},\n\t{\"PMC_S0IX_WAKE_REASON_GPIO\",\t\t0x6000},\n\t{\"PMC_S0IX_WAKE_REASON_TIMER\",\t\t0x6001},\n\t{\"PMC_S0IX_WAKE_REASON_VNNREQ\",         0x6002},\n\t{\"PMC_S0IX_WAKE_REASON_LOWPOWER\",       0x6003},\n\t{\"PMC_S0IX_WAKE_REASON_EXTERNAL\",       0x6004},\n\t{\"PMC_S0IX_WAKE_REASON_MISC\",           0x6005},\n\t{\"PMC_S0IX_BLOCKING_IPS_D3_D0I3\",       0x6006},\n\t{\"PMC_S0IX_BLOCKING_IPS_PG\",            0x6007},\n\t{\"PMC_S0IX_BLOCKING_MISC_IPS_PG\",       0x6008},\n\t{\"PMC_S0IX_BLOCK_IPS_VNN_REQ\",          0x6009},\n\t{\"PMC_S0IX_BLOCK_IPS_CLOCKS\",           0x600B},\n};\n\n\nstatic struct telemetry_evtmap\n\ttelemetry_apl_pss_default_events[TELEM_MAX_OS_ALLOCATED_EVENTS] = {\n\t{\"IA_CORE0_C6_RES\",\t\t\t0x0400},\n\t{\"IA_CORE0_C6_CTR\",\t\t\t0x0000},\n\t{\"IA_MODULE0_C7_RES\",\t\t\t0x0410},\n\t{\"IA_MODULE0_C7_CTR\",\t\t\t0x000E},\n\t{\"IA_C0_RES\",\t\t\t\t0x0805},\n\t{\"PCS_LTR\",\t\t\t\t0x2801},\n\t{\"PSTATES\",\t\t\t\t0x2802},\n\t{\"SOC_S0I3_RES\",\t\t\t0x0409},\n\t{\"SOC_S0I3_CTR\",\t\t\t0x000A},\n\t{\"PCS_S0I3_CTR\",\t\t\t0x0009},\n\t{\"PCS_C1E_RES\",\t\t\t\t0x041A},\n\t{\"PCS_IDLE_STATUS\",\t\t\t0x2806},\n\t{\"IA_PERF_LIMITS\",\t\t\t0x280B},\n\t{\"GT_PERF_LIMITS\",\t\t\t0x280C},\n\t{\"PCS_WAKEUP_S0IX_CTR\",\t\t\t0x0030},\n\t{\"PCS_IDLE_BLOCKED\",\t\t\t0x2C00},\n\t{\"PCS_S0IX_BLOCKED\",\t\t\t0x2C01},\n\t{\"PCS_S0IX_WAKE_REASONS\",\t\t0x2C02},\n\t{\"PCS_LTR_BLOCKING\",\t\t\t0x2C03},\n\t{\"PC2_AND_MEM_SHALLOW_IDLE_RES\",\t0x1D40},\n};\n\nstatic struct telemetry_evtmap\n\ttelemetry_glk_pss_default_events[TELEM_MAX_OS_ALLOCATED_EVENTS] = {\n\t{\"IA_CORE0_C6_RES\",\t\t\t0x0400},\n\t{\"IA_CORE0_C6_CTR\",\t\t\t0x0000},\n\t{\"IA_MODULE0_C7_RES\",\t\t\t0x0410},\n\t{\"IA_MODULE0_C7_CTR\",\t\t\t0x000C},\n\t{\"IA_C0_RES\",\t\t\t\t0x0805},\n\t{\"PCS_LTR\",\t\t\t\t0x2801},\n\t{\"PSTATES\",\t\t\t\t0x2802},\n\t{\"SOC_S0I3_RES\",\t\t\t0x0407},\n\t{\"SOC_S0I3_CTR\",\t\t\t0x0008},\n\t{\"PCS_S0I3_CTR\",\t\t\t0x0007},\n\t{\"PCS_C1E_RES\",\t\t\t\t0x0414},\n\t{\"PCS_IDLE_STATUS\",\t\t\t0x2806},\n\t{\"IA_PERF_LIMITS\",\t\t\t0x280B},\n\t{\"GT_PERF_LIMITS\",\t\t\t0x280C},\n\t{\"PCS_WAKEUP_S0IX_CTR\",\t\t\t0x0025},\n\t{\"PCS_IDLE_BLOCKED\",\t\t\t0x2C00},\n\t{\"PCS_S0IX_BLOCKED\",\t\t\t0x2C01},\n\t{\"PCS_S0IX_WAKE_REASONS\",\t\t0x2C02},\n\t{\"PCS_LTR_BLOCKING\",\t\t\t0x2C03},\n\t{\"PC2_AND_MEM_SHALLOW_IDLE_RES\",\t0x1D40},\n};\n\n \nstatic struct telemetry_plt_config telem_apl_config = {\n\t.pss_config = {\n\t\t.telem_evts = telemetry_apl_pss_default_events,\n\t},\n\t.ioss_config = {\n\t\t.telem_evts = telemetry_apl_ioss_default_events,\n\t},\n};\n\n \nstatic struct telemetry_plt_config telem_glk_config = {\n\t.pss_config = {\n\t\t.telem_evts = telemetry_glk_pss_default_events,\n\t},\n\t.ioss_config = {\n\t\t.telem_evts = telemetry_apl_ioss_default_events,\n\t},\n};\n\nstatic const struct x86_cpu_id telemetry_cpu_ids[] = {\n\tX86_MATCH_INTEL_FAM6_MODEL(ATOM_GOLDMONT,\t&telem_apl_config),\n\tX86_MATCH_INTEL_FAM6_MODEL(ATOM_GOLDMONT_PLUS,\t&telem_glk_config),\n\t{}\n};\n\nMODULE_DEVICE_TABLE(x86cpu, telemetry_cpu_ids);\n\nstatic inline int telem_get_unitconfig(enum telemetry_unit telem_unit,\n\t\t\t\t     struct telemetry_unit_config **unit_config)\n{\n\tif (telem_unit == TELEM_PSS)\n\t\t*unit_config = &(telm_conf->pss_config);\n\telse if (telem_unit == TELEM_IOSS)\n\t\t*unit_config = &(telm_conf->ioss_config);\n\telse\n\t\treturn -EINVAL;\n\n\treturn 0;\n\n}\n\nstatic int telemetry_check_evtid(enum telemetry_unit telem_unit,\n\t\t\t\t u32 *evtmap, u8 len,\n\t\t\t\t enum telemetry_action action)\n{\n\tstruct telemetry_unit_config *unit_config;\n\tint ret;\n\n\tret = telem_get_unitconfig(telem_unit, &unit_config);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tswitch (action) {\n\tcase TELEM_RESET:\n\t\tif (len > TELEM_MAX_EVENTS_SRAM)\n\t\t\treturn -EINVAL;\n\n\t\tbreak;\n\n\tcase TELEM_UPDATE:\n\t\tif (len > TELEM_MAX_EVENTS_SRAM)\n\t\t\treturn -EINVAL;\n\n\t\tif ((len > 0) && (evtmap == NULL))\n\t\t\treturn -EINVAL;\n\n\t\tbreak;\n\n\tcase TELEM_ADD:\n\t\tif ((len + unit_config->ssram_evts_used) >\n\t\t    TELEM_MAX_EVENTS_SRAM)\n\t\t\treturn -EINVAL;\n\n\t\tif ((len > 0) && (evtmap == NULL))\n\t\t\treturn -EINVAL;\n\n\t\tbreak;\n\n\tdefault:\n\t\tpr_err(\"Unknown Telemetry action specified %d\\n\", action);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\n\nstatic inline int telemetry_plt_config_ioss_event(u32 evt_id, int index)\n{\n\tu32 write_buf;\n\n\twrite_buf = evt_id | TELEM_EVENT_ENABLE;\n\twrite_buf <<= BITS_PER_BYTE;\n\twrite_buf |= index;\n\n\treturn intel_scu_ipc_dev_command(telm_conf->scu, IOSS_TELEM,\n\t\t\t\t\t IOSS_TELEM_EVENT_WRITE, &write_buf,\n\t\t\t\t\t IOSS_TELEM_EVT_WRITE_SIZE, NULL, 0);\n}\n\nstatic inline int telemetry_plt_config_pss_event(u32 evt_id, int index)\n{\n\tu32 write_buf;\n\tint ret;\n\n\twrite_buf = evt_id | TELEM_EVENT_ENABLE;\n\tret = intel_punit_ipc_command(IPC_PUNIT_BIOS_WRITE_TELE_EVENT,\n\t\t\t\t      index, 0, &write_buf, NULL);\n\n\treturn ret;\n}\n\nstatic int telemetry_setup_iossevtconfig(struct telemetry_evtconfig evtconfig,\n\t\t\t\t\t enum telemetry_action action)\n{\n\tstruct intel_scu_ipc_dev *scu = telm_conf->scu;\n\tu8 num_ioss_evts, ioss_period;\n\tint ret, index, idx;\n\tu32 *ioss_evtmap;\n\tu32 telem_ctrl;\n\n\tnum_ioss_evts = evtconfig.num_evts;\n\tioss_period = evtconfig.period;\n\tioss_evtmap = evtconfig.evtmap;\n\n\t \n\tret = intel_scu_ipc_dev_command(scu, IOSS_TELEM,\n\t\t\t\t    IOSS_TELEM_EVENT_CTL_READ, NULL, 0,\n\t\t\t\t    &telem_ctrl, sizeof(telem_ctrl));\n\tif (ret) {\n\t\tpr_err(\"IOSS TELEM_CTRL Read Failed\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tTELEM_DISABLE(telem_ctrl);\n\n\tret = intel_scu_ipc_dev_command(scu, IOSS_TELEM,\n\t\t\t\t    IOSS_TELEM_EVENT_CTL_WRITE, &telem_ctrl,\n\t\t\t\t    sizeof(telem_ctrl), NULL, 0);\n\tif (ret) {\n\t\tpr_err(\"IOSS TELEM_CTRL Event Disable Write Failed\\n\");\n\t\treturn ret;\n\t}\n\n\n\t \n\tif (action == TELEM_RESET) {\n\t\t \n\t\tTELEM_CLEAR_EVENTS(telem_ctrl);\n\n\t\tret = intel_scu_ipc_dev_command(scu, IOSS_TELEM,\n\t\t\t\t\t    IOSS_TELEM_EVENT_CTL_WRITE,\n\t\t\t\t\t    &telem_ctrl, sizeof(telem_ctrl),\n\t\t\t\t\t    NULL, 0);\n\t\tif (ret) {\n\t\t\tpr_err(\"IOSS TELEM_CTRL Event Disable Write Failed\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\ttelm_conf->ioss_config.ssram_evts_used = 0;\n\n\t\t \n\t\tfor (idx = 0; idx < num_ioss_evts; idx++) {\n\t\t\tif (telemetry_plt_config_ioss_event(\n\t\t\t    telm_conf->ioss_config.telem_evts[idx].evt_id,\n\t\t\t    idx)) {\n\t\t\t\tpr_err(\"IOSS TELEM_RESET Fail for data: %x\\n\",\n\t\t\t\ttelm_conf->ioss_config.telem_evts[idx].evt_id);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\ttelm_conf->ioss_config.ssram_evts_used++;\n\t\t}\n\t}\n\n\t \n\tif (action == TELEM_UPDATE) {\n\t\t \n\t\tTELEM_CLEAR_EVENTS(telem_ctrl);\n\n\t\tret = intel_scu_ipc_dev_command(scu, IOSS_TELEM,\n\t\t\t\t\t    IOSS_TELEM_EVENT_CTL_WRITE,\n\t\t\t\t\t    &telem_ctrl, sizeof(telem_ctrl),\n\t\t\t\t\t    NULL, 0);\n\t\tif (ret) {\n\t\t\tpr_err(\"IOSS TELEM_CTRL Event Disable Write Failed\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\ttelm_conf->ioss_config.ssram_evts_used = 0;\n\n\t\t \n\t\tfor (index = 0; index < num_ioss_evts; index++) {\n\t\t\ttelm_conf->ioss_config.telem_evts[index].evt_id =\n\t\t\tioss_evtmap[index];\n\n\t\t\tif (telemetry_plt_config_ioss_event(\n\t\t\t    telm_conf->ioss_config.telem_evts[index].evt_id,\n\t\t\t    index)) {\n\t\t\t\tpr_err(\"IOSS TELEM_UPDATE Fail for Evt%x\\n\",\n\t\t\t\t\tioss_evtmap[index]);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\ttelm_conf->ioss_config.ssram_evts_used++;\n\t\t}\n\t}\n\n\t \n\tif (action == TELEM_ADD) {\n\t\t \n\t\tfor (index = telm_conf->ioss_config.ssram_evts_used, idx = 0;\n\t\t     idx < num_ioss_evts; index++, idx++) {\n\t\t\ttelm_conf->ioss_config.telem_evts[index].evt_id =\n\t\t\tioss_evtmap[idx];\n\n\t\t\tif (telemetry_plt_config_ioss_event(\n\t\t\t    telm_conf->ioss_config.telem_evts[index].evt_id,\n\t\t\t    index)) {\n\t\t\t\tpr_err(\"IOSS TELEM_ADD Fail for Event %x\\n\",\n\t\t\t\t\tioss_evtmap[idx]);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\ttelm_conf->ioss_config.ssram_evts_used++;\n\t\t}\n\t}\n\n\t \n\tTELEM_CLEAR_SAMPLE_PERIOD(telem_ctrl);\n\tTELEM_ENABLE_SRAM_EVT_TRACE(telem_ctrl);\n\tTELEM_ENABLE_PERIODIC(telem_ctrl);\n\ttelem_ctrl |= ioss_period;\n\n\tret = intel_scu_ipc_dev_command(scu, IOSS_TELEM,\n\t\t\t\t    IOSS_TELEM_EVENT_CTL_WRITE,\n\t\t\t\t    &telem_ctrl, sizeof(telem_ctrl), NULL, 0);\n\tif (ret) {\n\t\tpr_err(\"IOSS TELEM_CTRL Event Enable Write Failed\\n\");\n\t\treturn ret;\n\t}\n\n\ttelm_conf->ioss_config.curr_period = ioss_period;\n\n\treturn 0;\n}\n\n\nstatic int telemetry_setup_pssevtconfig(struct telemetry_evtconfig evtconfig,\n\t\t\t\t\tenum telemetry_action action)\n{\n\tu8 num_pss_evts, pss_period;\n\tint ret, index, idx;\n\tu32 *pss_evtmap;\n\tu32 telem_ctrl;\n\n\tnum_pss_evts = evtconfig.num_evts;\n\tpss_period = evtconfig.period;\n\tpss_evtmap = evtconfig.evtmap;\n\n\t \n\t \n\tret = intel_punit_ipc_command(IPC_PUNIT_BIOS_READ_TELE_EVENT_CTRL,\n\t\t\t\t      0, 0, NULL, &telem_ctrl);\n\tif (ret) {\n\t\tpr_err(\"PSS TELEM_CTRL Read Failed\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tTELEM_DISABLE(telem_ctrl);\n\tret = intel_punit_ipc_command(IPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\n\t\t\t\t      0, 0, &telem_ctrl, NULL);\n\tif (ret) {\n\t\tpr_err(\"PSS TELEM_CTRL Event Disable Write Failed\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tif (action == TELEM_RESET) {\n\t\t \n\t\tTELEM_CLEAR_EVENTS(telem_ctrl);\n\n\t\tret = intel_punit_ipc_command(\n\t\t\t\tIPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\n\t\t\t\t0, 0, &telem_ctrl, NULL);\n\t\tif (ret) {\n\t\t\tpr_err(\"PSS TELEM_CTRL Event Disable Write Failed\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\ttelm_conf->pss_config.ssram_evts_used = 0;\n\t\t \n\t\tfor (idx = 0; idx < num_pss_evts; idx++) {\n\t\t\tif (telemetry_plt_config_pss_event(\n\t\t\t    telm_conf->pss_config.telem_evts[idx].evt_id,\n\t\t\t    idx)) {\n\t\t\t\tpr_err(\"PSS TELEM_RESET Fail for Event %x\\n\",\n\t\t\t\ttelm_conf->pss_config.telem_evts[idx].evt_id);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\ttelm_conf->pss_config.ssram_evts_used++;\n\t\t}\n\t}\n\n\t \n\tif (action == TELEM_UPDATE) {\n\t\t \n\t\tTELEM_CLEAR_EVENTS(telem_ctrl);\n\n\t\tret = intel_punit_ipc_command(\n\t\t\t\tIPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\n\t\t\t\t0, 0, &telem_ctrl, NULL);\n\t\tif (ret) {\n\t\t\tpr_err(\"PSS TELEM_CTRL Event Disable Write Failed\\n\");\n\t\t\treturn ret;\n\t\t}\n\t\ttelm_conf->pss_config.ssram_evts_used = 0;\n\n\t\t \n\t\tfor (index = 0; index < num_pss_evts; index++) {\n\t\t\ttelm_conf->pss_config.telem_evts[index].evt_id =\n\t\t\tpss_evtmap[index];\n\n\t\t\tif (telemetry_plt_config_pss_event(\n\t\t\t    telm_conf->pss_config.telem_evts[index].evt_id,\n\t\t\t    index)) {\n\t\t\t\tpr_err(\"PSS TELEM_UPDATE Fail for Event %x\\n\",\n\t\t\t\t\tpss_evtmap[index]);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\ttelm_conf->pss_config.ssram_evts_used++;\n\t\t}\n\t}\n\n\t \n\tif (action == TELEM_ADD) {\n\t\t \n\t\tfor (index = telm_conf->pss_config.ssram_evts_used, idx = 0;\n\t\t     idx < num_pss_evts; index++, idx++) {\n\n\t\t\ttelm_conf->pss_config.telem_evts[index].evt_id =\n\t\t\tpss_evtmap[idx];\n\n\t\t\tif (telemetry_plt_config_pss_event(\n\t\t\t    telm_conf->pss_config.telem_evts[index].evt_id,\n\t\t\t    index)) {\n\t\t\t\tpr_err(\"PSS TELEM_ADD Fail for Event %x\\n\",\n\t\t\t\t\tpss_evtmap[idx]);\n\t\t\t\tcontinue;\n\t\t\t}\n\t\t\ttelm_conf->pss_config.ssram_evts_used++;\n\t\t}\n\t}\n\n\t \n\tTELEM_CLEAR_SAMPLE_PERIOD(telem_ctrl);\n\tTELEM_ENABLE_SRAM_EVT_TRACE(telem_ctrl);\n\tTELEM_ENABLE_PERIODIC(telem_ctrl);\n\ttelem_ctrl |= pss_period;\n\n\tret = intel_punit_ipc_command(IPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\n\t\t\t\t      0, 0, &telem_ctrl, NULL);\n\tif (ret) {\n\t\tpr_err(\"PSS TELEM_CTRL Event Enable Write Failed\\n\");\n\t\treturn ret;\n\t}\n\n\ttelm_conf->pss_config.curr_period = pss_period;\n\n\treturn 0;\n}\n\nstatic int telemetry_setup_evtconfig(struct telemetry_evtconfig pss_evtconfig,\n\t\t\t\t     struct telemetry_evtconfig ioss_evtconfig,\n\t\t\t\t     enum telemetry_action action)\n{\n\tint ret;\n\n\tmutex_lock(&(telm_conf->telem_lock));\n\n\tif ((action == TELEM_UPDATE) && (telm_conf->telem_in_use)) {\n\t\tret = -EBUSY;\n\t\tgoto out;\n\t}\n\n\tret = telemetry_check_evtid(TELEM_PSS, pss_evtconfig.evtmap,\n\t\t\t\t    pss_evtconfig.num_evts, action);\n\tif (ret)\n\t\tgoto out;\n\n\tret = telemetry_check_evtid(TELEM_IOSS, ioss_evtconfig.evtmap,\n\t\t\t\t    ioss_evtconfig.num_evts, action);\n\tif (ret)\n\t\tgoto out;\n\n\tif (ioss_evtconfig.num_evts) {\n\t\tret = telemetry_setup_iossevtconfig(ioss_evtconfig, action);\n\t\tif (ret)\n\t\t\tgoto out;\n\t}\n\n\tif (pss_evtconfig.num_evts) {\n\t\tret = telemetry_setup_pssevtconfig(pss_evtconfig, action);\n\t\tif (ret)\n\t\t\tgoto out;\n\t}\n\n\tif ((action == TELEM_UPDATE) || (action == TELEM_ADD))\n\t\ttelm_conf->telem_in_use = true;\n\telse\n\t\ttelm_conf->telem_in_use = false;\n\nout:\n\tmutex_unlock(&(telm_conf->telem_lock));\n\treturn ret;\n}\n\nstatic int telemetry_setup(struct platform_device *pdev)\n{\n\tstruct telemetry_evtconfig pss_evtconfig, ioss_evtconfig;\n\tu32 read_buf, events, event_regs;\n\tint ret;\n\n\tret = intel_scu_ipc_dev_command(telm_conf->scu, IOSS_TELEM,\n\t\t\t\t\tIOSS_TELEM_INFO_READ, NULL, 0,\n\t\t\t\t\t&read_buf, sizeof(read_buf));\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"IOSS TELEM_INFO Read Failed\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tevents = (read_buf & TELEM_INFO_SRAMEVTS_MASK) >>\n\t\t  TELEM_INFO_SRAMEVTS_SHIFT;\n\tevent_regs = read_buf & TELEM_INFO_NENABLES_MASK;\n\tif ((events < TELEM_MAX_EVENTS_SRAM) ||\n\t    (event_regs < TELEM_MAX_EVENTS_SRAM)) {\n\t\tdev_err(&pdev->dev, \"IOSS:Insufficient Space for SRAM Trace\\n\");\n\t\tdev_err(&pdev->dev, \"SRAM Events %d; Event Regs %d\\n\",\n\t\t\tevents, event_regs);\n\t\treturn -ENOMEM;\n\t}\n\n\ttelm_conf->ioss_config.min_period = TELEM_MIN_PERIOD(read_buf);\n\ttelm_conf->ioss_config.max_period = TELEM_MAX_PERIOD(read_buf);\n\n\t \n\tret = intel_punit_ipc_command(IPC_PUNIT_BIOS_READ_TELE_INFO, 0, 0,\n\t\t\t\t      NULL, &read_buf);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"PSS TELEM_INFO Read Failed\\n\");\n\t\treturn ret;\n\t}\n\n\t \n\tevents = (read_buf & TELEM_INFO_SRAMEVTS_MASK) >>\n\t\t  TELEM_INFO_SRAMEVTS_SHIFT;\n\tevent_regs = read_buf & TELEM_INFO_SRAMEVTS_MASK;\n\tif ((events < TELEM_MAX_EVENTS_SRAM) ||\n\t    (event_regs < TELEM_MAX_EVENTS_SRAM)) {\n\t\tdev_err(&pdev->dev, \"PSS:Insufficient Space for SRAM Trace\\n\");\n\t\tdev_err(&pdev->dev, \"SRAM Events %d; Event Regs %d\\n\",\n\t\t\tevents, event_regs);\n\t\treturn -ENOMEM;\n\t}\n\n\ttelm_conf->pss_config.min_period = TELEM_MIN_PERIOD(read_buf);\n\ttelm_conf->pss_config.max_period = TELEM_MAX_PERIOD(read_buf);\n\n\tpss_evtconfig.evtmap = NULL;\n\tpss_evtconfig.num_evts = TELEM_MAX_OS_ALLOCATED_EVENTS;\n\tpss_evtconfig.period = TELEM_SAMPLING_DEFAULT_PERIOD;\n\n\tioss_evtconfig.evtmap = NULL;\n\tioss_evtconfig.num_evts = TELEM_MAX_OS_ALLOCATED_EVENTS;\n\tioss_evtconfig.period = TELEM_SAMPLING_DEFAULT_PERIOD;\n\n\tret = telemetry_setup_evtconfig(pss_evtconfig, ioss_evtconfig,\n\t\t\t\t\tTELEM_RESET);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"TELEMETRY Setup Failed\\n\");\n\t\treturn ret;\n\t}\n\treturn 0;\n}\n\nstatic int telemetry_plt_update_events(struct telemetry_evtconfig pss_evtconfig,\n\t\t\t\tstruct telemetry_evtconfig ioss_evtconfig)\n{\n\tint ret;\n\n\tif ((pss_evtconfig.num_evts > 0) &&\n\t    (TELEM_SAMPLE_PERIOD_INVALID(pss_evtconfig.period))) {\n\t\tpr_err(\"PSS Sampling Period Out of Range\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tif ((ioss_evtconfig.num_evts > 0) &&\n\t    (TELEM_SAMPLE_PERIOD_INVALID(ioss_evtconfig.period))) {\n\t\tpr_err(\"IOSS Sampling Period Out of Range\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tret = telemetry_setup_evtconfig(pss_evtconfig, ioss_evtconfig,\n\t\t\t\t\tTELEM_UPDATE);\n\tif (ret)\n\t\tpr_err(\"TELEMETRY Config Failed\\n\");\n\n\treturn ret;\n}\n\n\nstatic int telemetry_plt_set_sampling_period(u8 pss_period, u8 ioss_period)\n{\n\tu32 telem_ctrl = 0;\n\tint ret = 0;\n\n\tmutex_lock(&(telm_conf->telem_lock));\n\tif (ioss_period) {\n\t\tstruct intel_scu_ipc_dev *scu = telm_conf->scu;\n\n\t\tif (TELEM_SAMPLE_PERIOD_INVALID(ioss_period)) {\n\t\t\tpr_err(\"IOSS Sampling Period Out of Range\\n\");\n\t\t\tret = -EINVAL;\n\t\t\tgoto out;\n\t\t}\n\n\t\t \n\t\tret = intel_scu_ipc_dev_command(scu, IOSS_TELEM,\n\t\t\t\t\t    IOSS_TELEM_EVENT_CTL_READ, NULL, 0,\n\t\t\t\t\t    &telem_ctrl, sizeof(telem_ctrl));\n\t\tif (ret) {\n\t\t\tpr_err(\"IOSS TELEM_CTRL Read Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\n\t\t \n\t\tTELEM_DISABLE(telem_ctrl);\n\n\t\tret = intel_scu_ipc_dev_command(scu, IOSS_TELEM,\n\t\t\t\t\t\tIOSS_TELEM_EVENT_CTL_WRITE,\n\t\t\t\t\t\t&telem_ctrl, sizeof(telem_ctrl),\n\t\t\t\t\t\tNULL, 0);\n\t\tif (ret) {\n\t\t\tpr_err(\"IOSS TELEM_CTRL Event Disable Write Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\n\t\t \n\t\tTELEM_CLEAR_SAMPLE_PERIOD(telem_ctrl);\n\t\tTELEM_ENABLE_SRAM_EVT_TRACE(telem_ctrl);\n\t\tTELEM_ENABLE_PERIODIC(telem_ctrl);\n\t\ttelem_ctrl |= ioss_period;\n\n\t\tret = intel_scu_ipc_dev_command(scu, IOSS_TELEM,\n\t\t\t\t\t\tIOSS_TELEM_EVENT_CTL_WRITE,\n\t\t\t\t\t\t&telem_ctrl, sizeof(telem_ctrl),\n\t\t\t\t\t\tNULL, 0);\n\t\tif (ret) {\n\t\t\tpr_err(\"IOSS TELEM_CTRL Event Enable Write Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\t\ttelm_conf->ioss_config.curr_period = ioss_period;\n\t}\n\n\tif (pss_period) {\n\t\tif (TELEM_SAMPLE_PERIOD_INVALID(pss_period)) {\n\t\t\tpr_err(\"PSS Sampling Period Out of Range\\n\");\n\t\t\tret = -EINVAL;\n\t\t\tgoto out;\n\t\t}\n\n\t\t \n\t\tret = intel_punit_ipc_command(\n\t\t\t\tIPC_PUNIT_BIOS_READ_TELE_EVENT_CTRL,\n\t\t\t\t0, 0, NULL, &telem_ctrl);\n\t\tif (ret) {\n\t\t\tpr_err(\"PSS TELEM_CTRL Read Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\n\t\t \n\t\tTELEM_DISABLE(telem_ctrl);\n\t\tret = intel_punit_ipc_command(\n\t\t\t\tIPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\n\t\t\t\t0, 0, &telem_ctrl, NULL);\n\t\tif (ret) {\n\t\t\tpr_err(\"PSS TELEM_CTRL Event Disable Write Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\n\t\t \n\t\tTELEM_CLEAR_SAMPLE_PERIOD(telem_ctrl);\n\t\tTELEM_ENABLE_SRAM_EVT_TRACE(telem_ctrl);\n\t\tTELEM_ENABLE_PERIODIC(telem_ctrl);\n\t\ttelem_ctrl |= pss_period;\n\n\t\tret = intel_punit_ipc_command(\n\t\t\t\tIPC_PUNIT_BIOS_WRITE_TELE_EVENT_CTRL,\n\t\t\t\t0, 0, &telem_ctrl, NULL);\n\t\tif (ret) {\n\t\t\tpr_err(\"PSS TELEM_CTRL Event Enable Write Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\t\ttelm_conf->pss_config.curr_period = pss_period;\n\t}\n\nout:\n\tmutex_unlock(&(telm_conf->telem_lock));\n\treturn ret;\n}\n\n\nstatic int telemetry_plt_get_sampling_period(u8 *pss_min_period,\n\t\t\t\t\t     u8 *pss_max_period,\n\t\t\t\t\t     u8 *ioss_min_period,\n\t\t\t\t\t     u8 *ioss_max_period)\n{\n\t*pss_min_period = telm_conf->pss_config.min_period;\n\t*pss_max_period = telm_conf->pss_config.max_period;\n\t*ioss_min_period = telm_conf->ioss_config.min_period;\n\t*ioss_max_period = telm_conf->ioss_config.max_period;\n\n\treturn 0;\n}\n\n\nstatic int telemetry_plt_reset_events(void)\n{\n\tstruct telemetry_evtconfig pss_evtconfig, ioss_evtconfig;\n\tint ret;\n\n\tpss_evtconfig.evtmap = NULL;\n\tpss_evtconfig.num_evts = TELEM_MAX_OS_ALLOCATED_EVENTS;\n\tpss_evtconfig.period = TELEM_SAMPLING_DEFAULT_PERIOD;\n\n\tioss_evtconfig.evtmap = NULL;\n\tioss_evtconfig.num_evts = TELEM_MAX_OS_ALLOCATED_EVENTS;\n\tioss_evtconfig.period = TELEM_SAMPLING_DEFAULT_PERIOD;\n\n\tret = telemetry_setup_evtconfig(pss_evtconfig, ioss_evtconfig,\n\t\t\t\t\tTELEM_RESET);\n\tif (ret)\n\t\tpr_err(\"TELEMETRY Reset Failed\\n\");\n\n\treturn ret;\n}\n\n\nstatic int telemetry_plt_get_eventconfig(struct telemetry_evtconfig *pss_config,\n\t\t\t\t\tstruct telemetry_evtconfig *ioss_config,\n\t\t\t\t\tint pss_len, int ioss_len)\n{\n\tu32 *pss_evtmap, *ioss_evtmap;\n\tu32 index;\n\n\tpss_evtmap = pss_config->evtmap;\n\tioss_evtmap = ioss_config->evtmap;\n\n\tmutex_lock(&(telm_conf->telem_lock));\n\tpss_config->num_evts = telm_conf->pss_config.ssram_evts_used;\n\tioss_config->num_evts = telm_conf->ioss_config.ssram_evts_used;\n\n\tpss_config->period = telm_conf->pss_config.curr_period;\n\tioss_config->period = telm_conf->ioss_config.curr_period;\n\n\tif ((pss_len < telm_conf->pss_config.ssram_evts_used) ||\n\t    (ioss_len < telm_conf->ioss_config.ssram_evts_used)) {\n\t\tmutex_unlock(&(telm_conf->telem_lock));\n\t\treturn -EINVAL;\n\t}\n\n\tfor (index = 0; index < telm_conf->pss_config.ssram_evts_used;\n\t     index++) {\n\t\tpss_evtmap[index] =\n\t\ttelm_conf->pss_config.telem_evts[index].evt_id;\n\t}\n\n\tfor (index = 0; index < telm_conf->ioss_config.ssram_evts_used;\n\t     index++) {\n\t\tioss_evtmap[index] =\n\t\ttelm_conf->ioss_config.telem_evts[index].evt_id;\n\t}\n\n\tmutex_unlock(&(telm_conf->telem_lock));\n\treturn 0;\n}\n\n\nstatic int telemetry_plt_add_events(u8 num_pss_evts, u8 num_ioss_evts,\n\t\t\t\t    u32 *pss_evtmap, u32 *ioss_evtmap)\n{\n\tstruct telemetry_evtconfig pss_evtconfig, ioss_evtconfig;\n\tint ret;\n\n\tpss_evtconfig.evtmap = pss_evtmap;\n\tpss_evtconfig.num_evts = num_pss_evts;\n\tpss_evtconfig.period = telm_conf->pss_config.curr_period;\n\n\tioss_evtconfig.evtmap = ioss_evtmap;\n\tioss_evtconfig.num_evts = num_ioss_evts;\n\tioss_evtconfig.period = telm_conf->ioss_config.curr_period;\n\n\tret = telemetry_setup_evtconfig(pss_evtconfig, ioss_evtconfig,\n\t\t\t\t\tTELEM_ADD);\n\tif (ret)\n\t\tpr_err(\"TELEMETRY ADD Failed\\n\");\n\n\treturn ret;\n}\n\nstatic int telem_evtlog_read(enum telemetry_unit telem_unit,\n\t\t\t     struct telem_ssram_region *ssram_region, u8 len)\n{\n\tstruct telemetry_unit_config *unit_config;\n\tu64 timestamp_prev, timestamp_next;\n\tint ret, index, timeout = 0;\n\n\tret = telem_get_unitconfig(telem_unit, &unit_config);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (len > unit_config->ssram_evts_used)\n\t\tlen = unit_config->ssram_evts_used;\n\n\tdo {\n\t\ttimestamp_prev = readq(unit_config->regmap);\n\t\tif (!timestamp_prev) {\n\t\t\tpr_err(\"Ssram under update. Please Try Later\\n\");\n\t\t\treturn -EBUSY;\n\t\t}\n\n\t\tssram_region->start_time = readq(unit_config->regmap +\n\t\t\t\t\t\t TELEM_SSRAM_STARTTIME_OFFSET);\n\n\t\tfor (index = 0; index < len; index++) {\n\t\t\tssram_region->events[index] =\n\t\t\treadq(unit_config->regmap + TELEM_SSRAM_EVTLOG_OFFSET +\n\t\t\t      BYTES_PER_LONG*index);\n\t\t}\n\n\t\ttimestamp_next = readq(unit_config->regmap);\n\t\tif (!timestamp_next) {\n\t\t\tpr_err(\"Ssram under update. Please Try Later\\n\");\n\t\t\treturn -EBUSY;\n\t\t}\n\n\t\tif (timeout++ > TELEM_SSRAM_READ_TIMEOUT) {\n\t\t\tpr_err(\"Timeout while reading Events\\n\");\n\t\t\treturn -EBUSY;\n\t\t}\n\n\t} while (timestamp_prev != timestamp_next);\n\n\tssram_region->timestamp = timestamp_next;\n\n\treturn len;\n}\n\nstatic int telemetry_plt_raw_read_eventlog(enum telemetry_unit telem_unit,\n\t\t\t\t\t   struct telemetry_evtlog *evtlog,\n\t\t\t\t\t   int len, int log_all_evts)\n{\n\tint index, idx1, ret, readlen = len;\n\tstruct telem_ssram_region ssram_region;\n\tstruct telemetry_evtmap *evtmap;\n\n\tswitch (telem_unit)\t{\n\tcase TELEM_PSS:\n\t\tevtmap = telm_conf->pss_config.telem_evts;\n\t\tbreak;\n\n\tcase TELEM_IOSS:\n\t\tevtmap = telm_conf->ioss_config.telem_evts;\n\t\tbreak;\n\n\tdefault:\n\t\tpr_err(\"Unknown Telemetry Unit Specified %d\\n\", telem_unit);\n\t\treturn -EINVAL;\n\t}\n\n\tif (!log_all_evts)\n\t\treadlen = TELEM_MAX_EVENTS_SRAM;\n\n\tret = telem_evtlog_read(telem_unit, &ssram_region, readlen);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tif ((!log_all_evts) && (len > ret))\n\t\treturn -EINVAL;\n\n\tif (log_all_evts)\n\t\tfor (index = 0; index < ret; index++) {\n\t\t\tevtlog[index].telem_evtlog = ssram_region.events[index];\n\t\t\tevtlog[index].telem_evtid = evtmap[index].evt_id;\n\t\t}\n\telse\n\t\tfor (index = 0, readlen = 0; (index < ret) && (readlen < len);\n\t\t     index++) {\n\t\t\tfor (idx1 = 0; idx1 < len; idx1++) {\n\t\t\t\t \n\t\t\t\tif (evtmap[index].evt_id ==\n\t\t\t\t    evtlog[idx1].telem_evtid) {\n\t\t\t\t\tevtlog[idx1].telem_evtlog =\n\t\t\t\t\tssram_region.events[index];\n\t\t\t\t\treadlen++;\n\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\treturn readlen;\n}\n\nstatic int telemetry_plt_read_eventlog(enum telemetry_unit telem_unit,\n\t\tstruct telemetry_evtlog *evtlog, int len, int log_all_evts)\n{\n\tint ret;\n\n\tmutex_lock(&(telm_conf->telem_lock));\n\tret = telemetry_plt_raw_read_eventlog(telem_unit, evtlog,\n\t\t\t\t\t      len, log_all_evts);\n\tmutex_unlock(&(telm_conf->telem_lock));\n\n\treturn ret;\n}\n\nstatic int telemetry_plt_get_trace_verbosity(enum telemetry_unit telem_unit,\n\t\t\t\t\t     u32 *verbosity)\n{\n\tu32 temp = 0;\n\tint ret;\n\n\tif (verbosity == NULL)\n\t\treturn -EINVAL;\n\n\tmutex_lock(&(telm_conf->telem_trace_lock));\n\tswitch (telem_unit) {\n\tcase TELEM_PSS:\n\t\tret = intel_punit_ipc_command(\n\t\t\t\tIPC_PUNIT_BIOS_READ_TELE_TRACE_CTRL,\n\t\t\t\t0, 0, NULL, &temp);\n\t\tif (ret) {\n\t\t\tpr_err(\"PSS TRACE_CTRL Read Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\n\t\tbreak;\n\n\tcase TELEM_IOSS:\n\t\tret = intel_scu_ipc_dev_command(telm_conf->scu,\n\t\t\t\tIOSS_TELEM, IOSS_TELEM_TRACE_CTL_READ,\n\t\t\t\tNULL, 0, &temp, sizeof(temp));\n\t\tif (ret) {\n\t\t\tpr_err(\"IOSS TRACE_CTL Read Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\n\t\tbreak;\n\n\tdefault:\n\t\tpr_err(\"Unknown Telemetry Unit Specified %d\\n\", telem_unit);\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\tTELEM_EXTRACT_VERBOSITY(temp, *verbosity);\n\nout:\n\tmutex_unlock(&(telm_conf->telem_trace_lock));\n\treturn ret;\n}\n\nstatic int telemetry_plt_set_trace_verbosity(enum telemetry_unit telem_unit,\n\t\t\t\t\t     u32 verbosity)\n{\n\tu32 temp = 0;\n\tint ret;\n\n\tverbosity &= TELEM_TRC_VERBOSITY_MASK;\n\n\tmutex_lock(&(telm_conf->telem_trace_lock));\n\tswitch (telem_unit) {\n\tcase TELEM_PSS:\n\t\tret = intel_punit_ipc_command(\n\t\t\t\tIPC_PUNIT_BIOS_READ_TELE_TRACE_CTRL,\n\t\t\t\t0, 0, NULL, &temp);\n\t\tif (ret) {\n\t\t\tpr_err(\"PSS TRACE_CTRL Read Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\n\t\tTELEM_CLEAR_VERBOSITY_BITS(temp);\n\t\tTELEM_SET_VERBOSITY_BITS(temp, verbosity);\n\n\t\tret = intel_punit_ipc_command(\n\t\t\t\tIPC_PUNIT_BIOS_WRITE_TELE_TRACE_CTRL,\n\t\t\t\t0, 0, &temp, NULL);\n\t\tif (ret) {\n\t\t\tpr_err(\"PSS TRACE_CTRL Verbosity Set Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\t\tbreak;\n\n\tcase TELEM_IOSS:\n\t\tret = intel_scu_ipc_dev_command(telm_conf->scu, IOSS_TELEM,\n\t\t\t\t\t\tIOSS_TELEM_TRACE_CTL_READ,\n\t\t\t\t\t\tNULL, 0, &temp, sizeof(temp));\n\t\tif (ret) {\n\t\t\tpr_err(\"IOSS TRACE_CTL Read Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\n\t\tTELEM_CLEAR_VERBOSITY_BITS(temp);\n\t\tTELEM_SET_VERBOSITY_BITS(temp, verbosity);\n\n\t\tret = intel_scu_ipc_dev_command(telm_conf->scu, IOSS_TELEM,\n\t\t\t\t\t\tIOSS_TELEM_TRACE_CTL_WRITE,\n\t\t\t\t\t\t&temp, sizeof(temp), NULL, 0);\n\t\tif (ret) {\n\t\t\tpr_err(\"IOSS TRACE_CTL Verbosity Set Failed\\n\");\n\t\t\tgoto out;\n\t\t}\n\t\tbreak;\n\n\tdefault:\n\t\tpr_err(\"Unknown Telemetry Unit Specified %d\\n\", telem_unit);\n\t\tret = -EINVAL;\n\t\tbreak;\n\t}\n\nout:\n\tmutex_unlock(&(telm_conf->telem_trace_lock));\n\treturn ret;\n}\n\nstatic const struct telemetry_core_ops telm_pltops = {\n\t.get_trace_verbosity = telemetry_plt_get_trace_verbosity,\n\t.set_trace_verbosity = telemetry_plt_set_trace_verbosity,\n\t.set_sampling_period = telemetry_plt_set_sampling_period,\n\t.get_sampling_period = telemetry_plt_get_sampling_period,\n\t.raw_read_eventlog = telemetry_plt_raw_read_eventlog,\n\t.get_eventconfig = telemetry_plt_get_eventconfig,\n\t.update_events = telemetry_plt_update_events,\n\t.read_eventlog = telemetry_plt_read_eventlog,\n\t.reset_events = telemetry_plt_reset_events,\n\t.add_events = telemetry_plt_add_events,\n};\n\nstatic int telemetry_pltdrv_probe(struct platform_device *pdev)\n{\n\tconst struct x86_cpu_id *id;\n\tvoid __iomem *mem;\n\tint ret;\n\n\tid = x86_match_cpu(telemetry_cpu_ids);\n\tif (!id)\n\t\treturn -ENODEV;\n\n\ttelm_conf = (struct telemetry_plt_config *)id->driver_data;\n\n\ttelm_conf->pmc = dev_get_drvdata(pdev->dev.parent);\n\n\tmem = devm_platform_ioremap_resource(pdev, 0);\n\tif (IS_ERR(mem))\n\t\treturn PTR_ERR(mem);\n\n\ttelm_conf->pss_config.regmap = mem;\n\n\tmem = devm_platform_ioremap_resource(pdev, 1);\n\tif (IS_ERR(mem))\n\t\treturn PTR_ERR(mem);\n\n\ttelm_conf->ioss_config.regmap = mem;\n\n\ttelm_conf->scu = devm_intel_scu_ipc_dev_get(&pdev->dev);\n\tif (!telm_conf->scu) {\n\t\tret = -EPROBE_DEFER;\n\t\tgoto out;\n\t}\n\n\tmutex_init(&telm_conf->telem_lock);\n\tmutex_init(&telm_conf->telem_trace_lock);\n\n\tret = telemetry_setup(pdev);\n\tif (ret)\n\t\tgoto out;\n\n\tret = telemetry_set_pltdata(&telm_pltops, telm_conf);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"TELEMETRY Set Pltops Failed.\\n\");\n\t\tgoto out;\n\t}\n\n\treturn 0;\n\nout:\n\tdev_err(&pdev->dev, \"TELEMETRY Setup Failed.\\n\");\n\n\treturn ret;\n}\n\nstatic void telemetry_pltdrv_remove(struct platform_device *pdev)\n{\n\ttelemetry_clear_pltdata();\n}\n\nstatic struct platform_driver telemetry_soc_driver = {\n\t.probe\t\t= telemetry_pltdrv_probe,\n\t.remove_new\t= telemetry_pltdrv_remove,\n\t.driver\t\t= {\n\t\t.name\t= DRIVER_NAME,\n\t},\n};\n\nstatic int __init telemetry_module_init(void)\n{\n\treturn platform_driver_register(&telemetry_soc_driver);\n}\n\nstatic void __exit telemetry_module_exit(void)\n{\n\tplatform_driver_unregister(&telemetry_soc_driver);\n}\n\ndevice_initcall(telemetry_module_init);\nmodule_exit(telemetry_module_exit);\n\nMODULE_AUTHOR(\"Souvik Kumar Chakravarty <souvik.k.chakravarty@intel.com>\");\nMODULE_DESCRIPTION(\"Intel SoC Telemetry Platform Driver\");\nMODULE_VERSION(DRIVER_VERSION);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}