{
  "module_name": "debugfs.c",
  "hash_id": "4b13af5010330370703295b4841f75ba062bde50e865a6db7ba90069db8c9474",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/intel/telemetry/debugfs.c",
  "human_readable_source": "\n \n#include <linux/debugfs.h>\n#include <linux/device.h>\n#include <linux/mfd/intel_pmc_bxt.h>\n#include <linux/module.h>\n#include <linux/pci.h>\n#include <linux/seq_file.h>\n#include <linux/suspend.h>\n\n#include <asm/cpu_device_id.h>\n#include <asm/intel-family.h>\n#include <asm/intel_telemetry.h>\n\n#define DRIVER_NAME\t\t\t\"telemetry_soc_debugfs\"\n#define DRIVER_VERSION\t\t\t\"1.0.0\"\n\n \n#define TELEM_APL_PSS_PSTATES_ID\t0x2802\n#define TELEM_APL_PSS_IDLE_ID\t\t0x2806\n#define TELEM_APL_PCS_IDLE_BLOCKED_ID\t0x2C00\n#define TELEM_APL_PCS_S0IX_BLOCKED_ID\t0x2C01\n#define TELEM_APL_PSS_WAKEUP_ID\t\t0x2C02\n#define TELEM_APL_PSS_LTR_BLOCKING_ID\t0x2C03\n\n#define TELEM_APL_S0IX_TOTAL_OCC_ID\t0x4000\n#define TELEM_APL_S0IX_SHLW_OCC_ID\t0x4001\n#define TELEM_APL_S0IX_DEEP_OCC_ID\t0x4002\n#define TELEM_APL_S0IX_TOTAL_RES_ID\t0x4800\n#define TELEM_APL_S0IX_SHLW_RES_ID\t0x4801\n#define TELEM_APL_S0IX_DEEP_RES_ID\t0x4802\n#define TELEM_APL_D0IX_ID\t\t0x581A\n#define TELEM_APL_D3_ID\t\t\t0x5819\n#define TELEM_APL_PG_ID\t\t\t0x5818\n\n#define TELEM_INFO_SRAMEVTS_MASK\t0xFF00\n#define TELEM_INFO_SRAMEVTS_SHIFT\t0x8\n#define TELEM_SSRAM_READ_TIMEOUT\t10\n\n#define TELEM_MASK_BIT\t\t\t1\n#define TELEM_MASK_BYTE\t\t\t0xFF\n#define BYTES_PER_LONG\t\t\t8\n#define TELEM_APL_MASK_PCS_STATE\t0xF\n\n \n#define TELEM_PSS_IDLE_EVTS\t\t25\n#define TELEM_PSS_IDLE_BLOCKED_EVTS\t20\n#define TELEM_PSS_S0IX_BLOCKED_EVTS\t20\n#define TELEM_PSS_S0IX_WAKEUP_EVTS\t20\n#define TELEM_PSS_LTR_BLOCKING_EVTS\t20\n#define TELEM_IOSS_DX_D0IX_EVTS\t\t25\n#define TELEM_IOSS_PG_EVTS\t\t30\n\n#define TELEM_CHECK_AND_PARSE_EVTS(EVTID, EVTNUM, BUF, EVTLOG, EVTDAT, MASK) { \\\n\tif (evtlog[index].telem_evtid == (EVTID)) { \\\n\t\tfor (idx = 0; idx < (EVTNUM); idx++) \\\n\t\t\t(BUF)[idx] = ((EVTLOG) >> (EVTDAT)[idx].bit_pos) & \\\n\t\t\t\t     (MASK); \\\n\tcontinue; \\\n\t} \\\n}\n\n#define TELEM_CHECK_AND_PARSE_CTRS(EVTID, CTR) { \\\n\tif (evtlog[index].telem_evtid == (EVTID)) { \\\n\t\t(CTR) = evtlog[index].telem_evtlog; \\\n\t\tcontinue; \\\n\t} \\\n}\n\nstatic u8 suspend_prep_ok;\nstatic u32 suspend_shlw_ctr_temp, suspend_deep_ctr_temp;\nstatic u64 suspend_shlw_res_temp, suspend_deep_res_temp;\n\nstruct telemetry_susp_stats {\n\tu32 shlw_ctr;\n\tu32 deep_ctr;\n\tu64 shlw_res;\n\tu64 deep_res;\n};\n\n \nstruct telem_pss_idle_stateinfo {\n\tconst char *name;\n\tu32 bit_pos;\n};\n\nstatic struct telem_pss_idle_stateinfo telem_apl_pss_idle_data[] = {\n\t{\"IA_CORE0_C1E\",\t\t0},\n\t{\"IA_CORE1_C1E\",\t\t1},\n\t{\"IA_CORE2_C1E\",\t\t2},\n\t{\"IA_CORE3_C1E\",\t\t3},\n\t{\"IA_CORE0_C6\",\t\t\t16},\n\t{\"IA_CORE1_C6\",\t\t\t17},\n\t{\"IA_CORE2_C6\",\t\t\t18},\n\t{\"IA_CORE3_C6\",\t\t\t19},\n\t{\"IA_MODULE0_C7\",\t\t32},\n\t{\"IA_MODULE1_C7\",\t\t33},\n\t{\"GT_RC6\",\t\t\t40},\n\t{\"IUNIT_PROCESSING_IDLE\",\t41},\n\t{\"FAR_MEM_IDLE\",\t\t43},\n\t{\"DISPLAY_IDLE\",\t\t44},\n\t{\"IUNIT_INPUT_SYSTEM_IDLE\",\t45},\n\t{\"PCS_STATUS\",\t\t\t60},\n};\n\nstruct telem_pcs_blkd_info {\n\tconst char *name;\n\tu32 bit_pos;\n};\n\nstatic struct telem_pcs_blkd_info telem_apl_pcs_idle_blkd_data[] = {\n\t{\"COMPUTE\",\t\t\t0},\n\t{\"MISC\",\t\t\t8},\n\t{\"MODULE_ACTIONS_PENDING\",\t16},\n\t{\"LTR\",\t\t\t\t24},\n\t{\"DISPLAY_WAKE\",\t\t32},\n\t{\"ISP_WAKE\",\t\t\t40},\n\t{\"PSF0_ACTIVE\",\t\t\t48},\n};\n\nstatic struct telem_pcs_blkd_info telem_apl_pcs_s0ix_blkd_data[] = {\n\t{\"LTR\",\t\t\t\t0},\n\t{\"IRTL\",\t\t\t8},\n\t{\"WAKE_DEADLINE_PENDING\",\t16},\n\t{\"DISPLAY\",\t\t\t24},\n\t{\"ISP\",\t\t\t\t32},\n\t{\"CORE\",\t\t\t40},\n\t{\"PMC\",\t\t\t\t48},\n\t{\"MISC\",\t\t\t56},\n};\n\nstruct telem_pss_ltr_info {\n\tconst char *name;\n\tu32 bit_pos;\n};\n\nstatic struct telem_pss_ltr_info telem_apl_pss_ltr_data[] = {\n\t{\"CORE_ACTIVE\",\t\t0},\n\t{\"MEM_UP\",\t\t8},\n\t{\"DFX\",\t\t\t16},\n\t{\"DFX_FORCE_LTR\",\t24},\n\t{\"DISPLAY\",\t\t32},\n\t{\"ISP\",\t\t\t40},\n\t{\"SOUTH\",\t\t48},\n};\n\nstruct telem_pss_wakeup_info {\n\tconst char *name;\n\tu32 bit_pos;\n};\n\nstatic struct telem_pss_wakeup_info telem_apl_pss_wakeup[] = {\n\t{\"IP_IDLE\",\t\t\t0},\n\t{\"DISPLAY_WAKE\",\t\t8},\n\t{\"VOLTAGE_REG_INT\",\t\t16},\n\t{\"DROWSY_TIMER (HOTPLUG)\",\t24},\n\t{\"CORE_WAKE\",\t\t\t32},\n\t{\"MISC_S0IX\",\t\t\t40},\n\t{\"MISC_ABORT\",\t\t\t56},\n};\n\nstruct telem_ioss_d0ix_stateinfo {\n\tconst char *name;\n\tu32 bit_pos;\n};\n\nstatic struct telem_ioss_d0ix_stateinfo telem_apl_ioss_d0ix_data[] = {\n\t{\"CSE\",\t\t0},\n\t{\"SCC2\",\t1},\n\t{\"GMM\",\t\t2},\n\t{\"XDCI\",\t3},\n\t{\"XHCI\",\t4},\n\t{\"ISH\",\t\t5},\n\t{\"AVS\",\t\t6},\n\t{\"PCIE0P1\",\t7},\n\t{\"PECI0P0\",\t8},\n\t{\"LPSS\",\t9},\n\t{\"SCC\",\t\t10},\n\t{\"PWM\",\t\t11},\n\t{\"PCIE1_P3\",    12},\n\t{\"PCIE1_P2\",    13},\n\t{\"PCIE1_P1\",    14},\n\t{\"PCIE1_P0\",    15},\n\t{\"CNV\",\t\t16},\n\t{\"SATA\",\t17},\n\t{\"PRTC\",\t18},\n};\n\nstruct telem_ioss_pg_info {\n\tconst char *name;\n\tu32 bit_pos;\n};\n\nstatic struct telem_ioss_pg_info telem_apl_ioss_pg_data[] = {\n\t{\"LPSS\",\t0},\n\t{\"SCC\",\t\t1},\n\t{\"P2SB\",\t2},\n\t{\"SCC2\",\t3},\n\t{\"GMM\",\t\t4},\n\t{\"PCIE0\",\t5},\n\t{\"XDCI\",\t6},\n\t{\"xHCI\",\t7},\n\t{\"CSE\",\t\t8},\n\t{\"SPI\",\t\t9},\n\t{\"AVSPGD4\",\t10},\n\t{\"AVSPGD3\",\t11},\n\t{\"AVSPGD2\",\t12},\n\t{\"AVSPGD1\",\t13},\n\t{\"ISH\",\t\t14},\n\t{\"EXI\",\t\t15},\n\t{\"NPKVRC\",\t16},\n\t{\"NPKVNN\",\t17},\n\t{\"CUNIT\",\t18},\n\t{\"FUSE_CTRL\",\t19},\n\t{\"PCIE1\",\t20},\n\t{\"CNV\",\t\t21},\n\t{\"LPC\",\t\t22},\n\t{\"SATA\",\t23},\n\t{\"SMB\",\t\t24},\n\t{\"PRTC\",\t25},\n};\n\nstruct telemetry_debugfs_conf {\n\tstruct telemetry_susp_stats suspend_stats;\n\tstruct dentry *telemetry_dbg_dir;\n\n\t \n\tstruct telem_ioss_d0ix_stateinfo *ioss_d0ix_data;\n\tstruct telem_pss_idle_stateinfo *pss_idle_data;\n\tstruct telem_pcs_blkd_info *pcs_idle_blkd_data;\n\tstruct telem_pcs_blkd_info *pcs_s0ix_blkd_data;\n\tstruct telem_pss_wakeup_info *pss_wakeup;\n\tstruct telem_pss_ltr_info *pss_ltr_data;\n\tstruct telem_ioss_pg_info *ioss_pg_data;\n\tu8 pcs_idle_blkd_evts;\n\tu8 pcs_s0ix_blkd_evts;\n\tu8 pss_wakeup_evts;\n\tu8 pss_idle_evts;\n\tu8 pss_ltr_evts;\n\tu8 ioss_d0ix_evts;\n\tu8 ioss_pg_evts;\n\n\t \n\tu16  pss_ltr_blocking_id;\n\tu16  pcs_idle_blkd_id;\n\tu16  pcs_s0ix_blkd_id;\n\tu16  s0ix_total_occ_id;\n\tu16  s0ix_shlw_occ_id;\n\tu16  s0ix_deep_occ_id;\n\tu16  s0ix_total_res_id;\n\tu16  s0ix_shlw_res_id;\n\tu16  s0ix_deep_res_id;\n\tu16  pss_wakeup_id;\n\tu16  ioss_d0ix_id;\n\tu16  pstates_id;\n\tu16  pss_idle_id;\n\tu16  ioss_d3_id;\n\tu16  ioss_pg_id;\n};\n\nstatic struct telemetry_debugfs_conf *debugfs_conf;\n\nstatic struct telemetry_debugfs_conf telem_apl_debugfs_conf = {\n\t.pss_idle_data = telem_apl_pss_idle_data,\n\t.pcs_idle_blkd_data = telem_apl_pcs_idle_blkd_data,\n\t.pcs_s0ix_blkd_data = telem_apl_pcs_s0ix_blkd_data,\n\t.pss_ltr_data = telem_apl_pss_ltr_data,\n\t.pss_wakeup = telem_apl_pss_wakeup,\n\t.ioss_d0ix_data = telem_apl_ioss_d0ix_data,\n\t.ioss_pg_data = telem_apl_ioss_pg_data,\n\n\t.pss_idle_evts = ARRAY_SIZE(telem_apl_pss_idle_data),\n\t.pcs_idle_blkd_evts = ARRAY_SIZE(telem_apl_pcs_idle_blkd_data),\n\t.pcs_s0ix_blkd_evts = ARRAY_SIZE(telem_apl_pcs_s0ix_blkd_data),\n\t.pss_ltr_evts = ARRAY_SIZE(telem_apl_pss_ltr_data),\n\t.pss_wakeup_evts = ARRAY_SIZE(telem_apl_pss_wakeup),\n\t.ioss_d0ix_evts = ARRAY_SIZE(telem_apl_ioss_d0ix_data),\n\t.ioss_pg_evts = ARRAY_SIZE(telem_apl_ioss_pg_data),\n\n\t.pstates_id = TELEM_APL_PSS_PSTATES_ID,\n\t.pss_idle_id = TELEM_APL_PSS_IDLE_ID,\n\t.pcs_idle_blkd_id = TELEM_APL_PCS_IDLE_BLOCKED_ID,\n\t.pcs_s0ix_blkd_id = TELEM_APL_PCS_S0IX_BLOCKED_ID,\n\t.pss_wakeup_id = TELEM_APL_PSS_WAKEUP_ID,\n\t.pss_ltr_blocking_id = TELEM_APL_PSS_LTR_BLOCKING_ID,\n\t.s0ix_total_occ_id = TELEM_APL_S0IX_TOTAL_OCC_ID,\n\t.s0ix_shlw_occ_id = TELEM_APL_S0IX_SHLW_OCC_ID,\n\t.s0ix_deep_occ_id = TELEM_APL_S0IX_DEEP_OCC_ID,\n\t.s0ix_total_res_id = TELEM_APL_S0IX_TOTAL_RES_ID,\n\t.s0ix_shlw_res_id = TELEM_APL_S0IX_SHLW_RES_ID,\n\t.s0ix_deep_res_id = TELEM_APL_S0IX_DEEP_RES_ID,\n\t.ioss_d0ix_id = TELEM_APL_D0IX_ID,\n\t.ioss_d3_id = TELEM_APL_D3_ID,\n\t.ioss_pg_id = TELEM_APL_PG_ID,\n};\n\nstatic const struct x86_cpu_id telemetry_debugfs_cpu_ids[] = {\n\tX86_MATCH_INTEL_FAM6_MODEL(ATOM_GOLDMONT,\t&telem_apl_debugfs_conf),\n\tX86_MATCH_INTEL_FAM6_MODEL(ATOM_GOLDMONT_PLUS,\t&telem_apl_debugfs_conf),\n\t{}\n};\nMODULE_DEVICE_TABLE(x86cpu, telemetry_debugfs_cpu_ids);\n\nstatic int telemetry_debugfs_check_evts(void)\n{\n\tif ((debugfs_conf->pss_idle_evts > TELEM_PSS_IDLE_EVTS) ||\n\t    (debugfs_conf->pcs_idle_blkd_evts > TELEM_PSS_IDLE_BLOCKED_EVTS) ||\n\t    (debugfs_conf->pcs_s0ix_blkd_evts > TELEM_PSS_S0IX_BLOCKED_EVTS) ||\n\t    (debugfs_conf->pss_ltr_evts > TELEM_PSS_LTR_BLOCKING_EVTS) ||\n\t    (debugfs_conf->pss_wakeup_evts > TELEM_PSS_S0IX_WAKEUP_EVTS) ||\n\t    (debugfs_conf->ioss_d0ix_evts > TELEM_IOSS_DX_D0IX_EVTS) ||\n\t    (debugfs_conf->ioss_pg_evts > TELEM_IOSS_PG_EVTS))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic int telem_pss_states_show(struct seq_file *s, void *unused)\n{\n\tstruct telemetry_evtlog evtlog[TELEM_MAX_OS_ALLOCATED_EVENTS];\n\tstruct telemetry_debugfs_conf *conf = debugfs_conf;\n\tconst char *name[TELEM_MAX_OS_ALLOCATED_EVENTS];\n\tu32 pcs_idle_blkd[TELEM_PSS_IDLE_BLOCKED_EVTS],\n\t    pcs_s0ix_blkd[TELEM_PSS_S0IX_BLOCKED_EVTS],\n\t    pss_s0ix_wakeup[TELEM_PSS_S0IX_WAKEUP_EVTS],\n\t    pss_ltr_blkd[TELEM_PSS_LTR_BLOCKING_EVTS],\n\t    pss_idle[TELEM_PSS_IDLE_EVTS];\n\tint index, idx, ret, err = 0;\n\tu64 pstates = 0;\n\n\tret = telemetry_read_eventlog(TELEM_PSS, evtlog,\n\t\t\t\t      TELEM_MAX_OS_ALLOCATED_EVENTS);\n\tif (ret < 0)\n\t\treturn ret;\n\n\terr = telemetry_get_evtname(TELEM_PSS, name,\n\t\t\t\t    TELEM_MAX_OS_ALLOCATED_EVENTS);\n\tif (err < 0)\n\t\treturn err;\n\n\tseq_puts(s, \"\\n----------------------------------------------------\\n\");\n\tseq_puts(s, \"\\tPSS TELEM EVENTLOG (Residency = field/19.2 us\\n\");\n\tseq_puts(s, \"----------------------------------------------------\\n\");\n\tfor (index = 0; index < ret; index++) {\n\t\tseq_printf(s, \"%-32s %llu\\n\",\n\t\t\t   name[index], evtlog[index].telem_evtlog);\n\n\t\t \n\t\tif (evtlog[index].telem_evtid == conf->pss_idle_id) {\n\t\t\tpss_idle[conf->pss_idle_evts - 1] =\n\t\t\t(evtlog[index].telem_evtlog >>\n\t\t\tconf->pss_idle_data[conf->pss_idle_evts - 1].bit_pos) &\n\t\t\tTELEM_APL_MASK_PCS_STATE;\n\t\t}\n\n\t\tTELEM_CHECK_AND_PARSE_EVTS(conf->pss_idle_id,\n\t\t\t\t\t   conf->pss_idle_evts - 1,\n\t\t\t\t\t   pss_idle, evtlog[index].telem_evtlog,\n\t\t\t\t\t   conf->pss_idle_data, TELEM_MASK_BIT);\n\n\t\tTELEM_CHECK_AND_PARSE_EVTS(conf->pcs_idle_blkd_id,\n\t\t\t\t\t   conf->pcs_idle_blkd_evts,\n\t\t\t\t\t   pcs_idle_blkd,\n\t\t\t\t\t   evtlog[index].telem_evtlog,\n\t\t\t\t\t   conf->pcs_idle_blkd_data,\n\t\t\t\t\t   TELEM_MASK_BYTE);\n\n\t\tTELEM_CHECK_AND_PARSE_EVTS(conf->pcs_s0ix_blkd_id,\n\t\t\t\t\t   conf->pcs_s0ix_blkd_evts,\n\t\t\t\t\t   pcs_s0ix_blkd,\n\t\t\t\t\t   evtlog[index].telem_evtlog,\n\t\t\t\t\t   conf->pcs_s0ix_blkd_data,\n\t\t\t\t\t   TELEM_MASK_BYTE);\n\n\t\tTELEM_CHECK_AND_PARSE_EVTS(conf->pss_wakeup_id,\n\t\t\t\t\t   conf->pss_wakeup_evts,\n\t\t\t\t\t   pss_s0ix_wakeup,\n\t\t\t\t\t   evtlog[index].telem_evtlog,\n\t\t\t\t\t   conf->pss_wakeup, TELEM_MASK_BYTE);\n\n\t\tTELEM_CHECK_AND_PARSE_EVTS(conf->pss_ltr_blocking_id,\n\t\t\t\t\t   conf->pss_ltr_evts, pss_ltr_blkd,\n\t\t\t\t\t   evtlog[index].telem_evtlog,\n\t\t\t\t\t   conf->pss_ltr_data, TELEM_MASK_BYTE);\n\n\t\tif (evtlog[index].telem_evtid == debugfs_conf->pstates_id)\n\t\t\tpstates = evtlog[index].telem_evtlog;\n\t}\n\n\tseq_puts(s, \"\\n--------------------------------------\\n\");\n\tseq_puts(s, \"PStates\\n\");\n\tseq_puts(s, \"--------------------------------------\\n\");\n\tseq_puts(s, \"Domain\\t\\t\\t\\tFreq(Mhz)\\n\");\n\tseq_printf(s, \" IA\\t\\t\\t\\t %llu\\n GT\\t\\t\\t\\t %llu\\n\",\n\t\t   (pstates & TELEM_MASK_BYTE)*100,\n\t\t   ((pstates >> 8) & TELEM_MASK_BYTE)*50/3);\n\n\tseq_printf(s, \" IUNIT\\t\\t\\t\\t %llu\\n SA\\t\\t\\t\\t %llu\\n\",\n\t\t   ((pstates >> 16) & TELEM_MASK_BYTE)*25,\n\t\t   ((pstates >> 24) & TELEM_MASK_BYTE)*50/3);\n\n\tseq_puts(s, \"\\n--------------------------------------\\n\");\n\tseq_puts(s, \"PSS IDLE Status\\n\");\n\tseq_puts(s, \"--------------------------------------\\n\");\n\tseq_puts(s, \"Device\\t\\t\\t\\t\\tIDLE\\n\");\n\tfor (index = 0; index < debugfs_conf->pss_idle_evts; index++) {\n\t\tseq_printf(s, \"%-32s\\t%u\\n\",\n\t\t\t   debugfs_conf->pss_idle_data[index].name,\n\t\t\t   pss_idle[index]);\n\t}\n\n\tseq_puts(s, \"\\n--------------------------------------\\n\");\n\tseq_puts(s, \"PSS Idle blkd Status (~1ms saturating bucket)\\n\");\n\tseq_puts(s, \"--------------------------------------\\n\");\n\tseq_puts(s, \"Blocker\\t\\t\\t\\t\\tCount\\n\");\n\tfor (index = 0; index < debugfs_conf->pcs_idle_blkd_evts; index++) {\n\t\tseq_printf(s, \"%-32s\\t%u\\n\",\n\t\t\t   debugfs_conf->pcs_idle_blkd_data[index].name,\n\t\t\t   pcs_idle_blkd[index]);\n\t}\n\n\tseq_puts(s, \"\\n--------------------------------------\\n\");\n\tseq_puts(s, \"PSS S0ix blkd Status (~1ms saturating bucket)\\n\");\n\tseq_puts(s, \"--------------------------------------\\n\");\n\tseq_puts(s, \"Blocker\\t\\t\\t\\t\\tCount\\n\");\n\tfor (index = 0; index < debugfs_conf->pcs_s0ix_blkd_evts; index++) {\n\t\tseq_printf(s, \"%-32s\\t%u\\n\",\n\t\t\t   debugfs_conf->pcs_s0ix_blkd_data[index].name,\n\t\t\t   pcs_s0ix_blkd[index]);\n\t}\n\n\tseq_puts(s, \"\\n--------------------------------------\\n\");\n\tseq_puts(s, \"LTR Blocking Status (~1ms saturating bucket)\\n\");\n\tseq_puts(s, \"--------------------------------------\\n\");\n\tseq_puts(s, \"Blocker\\t\\t\\t\\t\\tCount\\n\");\n\tfor (index = 0; index < debugfs_conf->pss_ltr_evts; index++) {\n\t\tseq_printf(s, \"%-32s\\t%u\\n\",\n\t\t\t   debugfs_conf->pss_ltr_data[index].name,\n\t\t\t   pss_s0ix_wakeup[index]);\n\t}\n\n\tseq_puts(s, \"\\n--------------------------------------\\n\");\n\tseq_puts(s, \"Wakes Status (~1ms saturating bucket)\\n\");\n\tseq_puts(s, \"--------------------------------------\\n\");\n\tseq_puts(s, \"Wakes\\t\\t\\t\\t\\tCount\\n\");\n\tfor (index = 0; index < debugfs_conf->pss_wakeup_evts; index++) {\n\t\tseq_printf(s, \"%-32s\\t%u\\n\",\n\t\t\t   debugfs_conf->pss_wakeup[index].name,\n\t\t\t   pss_ltr_blkd[index]);\n\t}\n\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(telem_pss_states);\n\nstatic int telem_ioss_states_show(struct seq_file *s, void *unused)\n{\n\tstruct telemetry_evtlog evtlog[TELEM_MAX_OS_ALLOCATED_EVENTS];\n\tconst char *name[TELEM_MAX_OS_ALLOCATED_EVENTS];\n\tint index, ret, err;\n\n\tret = telemetry_read_eventlog(TELEM_IOSS, evtlog,\n\t\t\t\t      TELEM_MAX_OS_ALLOCATED_EVENTS);\n\tif (ret < 0)\n\t\treturn ret;\n\n\terr = telemetry_get_evtname(TELEM_IOSS, name,\n\t\t\t\t    TELEM_MAX_OS_ALLOCATED_EVENTS);\n\tif (err < 0)\n\t\treturn err;\n\n\tseq_puts(s, \"--------------------------------------\\n\");\n\tseq_puts(s, \"\\tI0SS TELEMETRY EVENTLOG\\n\");\n\tseq_puts(s, \"--------------------------------------\\n\");\n\tfor (index = 0; index < ret; index++) {\n\t\tseq_printf(s, \"%-32s 0x%llx\\n\",\n\t\t\t   name[index], evtlog[index].telem_evtlog);\n\t}\n\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(telem_ioss_states);\n\nstatic int telem_soc_states_show(struct seq_file *s, void *unused)\n{\n\tu32 d3_sts[TELEM_IOSS_DX_D0IX_EVTS], d0ix_sts[TELEM_IOSS_DX_D0IX_EVTS];\n\tu32 pg_sts[TELEM_IOSS_PG_EVTS], pss_idle[TELEM_PSS_IDLE_EVTS];\n\tstruct telemetry_evtlog evtlog[TELEM_MAX_OS_ALLOCATED_EVENTS];\n\tu32 s0ix_total_ctr = 0, s0ix_shlw_ctr = 0, s0ix_deep_ctr = 0;\n\tu64 s0ix_total_res = 0, s0ix_shlw_res = 0, s0ix_deep_res = 0;\n\tstruct telemetry_debugfs_conf *conf = debugfs_conf;\n\tstruct pci_dev *dev = NULL;\n\tint index, idx, ret;\n\tu32 d3_state;\n\tu16 pmcsr;\n\n\tret = telemetry_read_eventlog(TELEM_IOSS, evtlog,\n\t\t\t\t      TELEM_MAX_OS_ALLOCATED_EVENTS);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tfor (index = 0; index < ret; index++) {\n\t\tTELEM_CHECK_AND_PARSE_EVTS(conf->ioss_d3_id,\n\t\t\t\t\t   conf->ioss_d0ix_evts,\n\t\t\t\t\t   d3_sts, evtlog[index].telem_evtlog,\n\t\t\t\t\t   conf->ioss_d0ix_data,\n\t\t\t\t\t   TELEM_MASK_BIT);\n\n\t\tTELEM_CHECK_AND_PARSE_EVTS(conf->ioss_pg_id, conf->ioss_pg_evts,\n\t\t\t\t\t   pg_sts, evtlog[index].telem_evtlog,\n\t\t\t\t\t   conf->ioss_pg_data, TELEM_MASK_BIT);\n\n\t\tTELEM_CHECK_AND_PARSE_EVTS(conf->ioss_d0ix_id,\n\t\t\t\t\t   conf->ioss_d0ix_evts,\n\t\t\t\t\t   d0ix_sts, evtlog[index].telem_evtlog,\n\t\t\t\t\t   conf->ioss_d0ix_data,\n\t\t\t\t\t   TELEM_MASK_BIT);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_total_occ_id,\n\t\t\t\t\t   s0ix_total_ctr);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_occ_id,\n\t\t\t\t\t   s0ix_shlw_ctr);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_occ_id,\n\t\t\t\t\t   s0ix_deep_ctr);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_total_res_id,\n\t\t\t\t\t   s0ix_total_res);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_res_id,\n\t\t\t\t\t   s0ix_shlw_res);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_res_id,\n\t\t\t\t\t   s0ix_deep_res);\n\t}\n\n\tseq_puts(s, \"\\n---------------------------------------------------\\n\");\n\tseq_puts(s, \"S0IX Type\\t\\t\\t Occurrence\\t\\t Residency(us)\\n\");\n\tseq_puts(s, \"---------------------------------------------------\\n\");\n\n\tseq_printf(s, \"S0IX Shallow\\t\\t\\t %10u\\t %10llu\\n\",\n\t\t   s0ix_shlw_ctr -\n\t\t   conf->suspend_stats.shlw_ctr,\n\t\t   (u64)((s0ix_shlw_res -\n\t\t   conf->suspend_stats.shlw_res)*10/192));\n\n\tseq_printf(s, \"S0IX Deep\\t\\t\\t %10u\\t %10llu\\n\",\n\t\t   s0ix_deep_ctr -\n\t\t   conf->suspend_stats.deep_ctr,\n\t\t   (u64)((s0ix_deep_res -\n\t\t   conf->suspend_stats.deep_res)*10/192));\n\n\tseq_printf(s, \"Suspend(With S0ixShallow)\\t %10u\\t %10llu\\n\",\n\t\t   conf->suspend_stats.shlw_ctr,\n\t\t   (u64)(conf->suspend_stats.shlw_res*10)/192);\n\n\tseq_printf(s, \"Suspend(With S0ixDeep)\\t\\t %10u\\t %10llu\\n\",\n\t\t   conf->suspend_stats.deep_ctr,\n\t\t   (u64)(conf->suspend_stats.deep_res*10)/192);\n\n\tseq_printf(s, \"TOTAL S0IX\\t\\t\\t %10u\\t %10llu\\n\", s0ix_total_ctr,\n\t\t   (u64)(s0ix_total_res*10/192));\n\tseq_puts(s, \"\\n-------------------------------------------------\\n\");\n\tseq_puts(s, \"\\t\\tDEVICE STATES\\n\");\n\tseq_puts(s, \"-------------------------------------------------\\n\");\n\n\tfor_each_pci_dev(dev) {\n\t\tpci_read_config_word(dev, dev->pm_cap + PCI_PM_CTRL, &pmcsr);\n\t\td3_state = ((pmcsr & PCI_PM_CTRL_STATE_MASK) ==\n\t\t\t    (__force int)PCI_D3hot) ? 1 : 0;\n\n\t\tseq_printf(s, \"pci %04x %04X %s %20.20s: \",\n\t\t\t   dev->vendor, dev->device, dev_name(&dev->dev),\n\t\t\t   dev_driver_string(&dev->dev));\n\t\tseq_printf(s, \" d3:%x\\n\", d3_state);\n\t}\n\n\tseq_puts(s, \"\\n--------------------------------------\\n\");\n\tseq_puts(s, \"D3/D0i3 Status\\n\");\n\tseq_puts(s, \"--------------------------------------\\n\");\n\tseq_puts(s, \"Block\\t\\t D3\\t D0i3\\n\");\n\tfor (index = 0; index < conf->ioss_d0ix_evts; index++) {\n\t\tseq_printf(s, \"%-10s\\t %u\\t %u\\n\",\n\t\t\t   conf->ioss_d0ix_data[index].name,\n\t\t\t   d3_sts[index], d0ix_sts[index]);\n\t}\n\n\tseq_puts(s, \"\\n--------------------------------------\\n\");\n\tseq_puts(s, \"South Complex PowerGate Status\\n\");\n\tseq_puts(s, \"--------------------------------------\\n\");\n\tseq_puts(s, \"Device\\t\\t PG\\n\");\n\tfor (index = 0; index < conf->ioss_pg_evts; index++) {\n\t\tseq_printf(s, \"%-10s\\t %u\\n\",\n\t\t\t   conf->ioss_pg_data[index].name,\n\t\t\t   pg_sts[index]);\n\t}\n\n\tevtlog->telem_evtid = conf->pss_idle_id;\n\tret = telemetry_read_events(TELEM_PSS, evtlog, 1);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tseq_puts(s, \"\\n-----------------------------------------\\n\");\n\tseq_puts(s, \"North Idle Status\\n\");\n\tseq_puts(s, \"-----------------------------------------\\n\");\n\tfor (idx = 0; idx < conf->pss_idle_evts - 1; idx++) {\n\t\tpss_idle[idx] =\t(evtlog->telem_evtlog >>\n\t\t\t\tconf->pss_idle_data[idx].bit_pos) &\n\t\t\t\tTELEM_MASK_BIT;\n\t}\n\n\tpss_idle[idx] = (evtlog->telem_evtlog >>\n\t\t\tconf->pss_idle_data[idx].bit_pos) &\n\t\t\tTELEM_APL_MASK_PCS_STATE;\n\n\tfor (index = 0; index < conf->pss_idle_evts; index++) {\n\t\tseq_printf(s, \"%-30s %u\\n\",\n\t\t\t   conf->pss_idle_data[index].name,\n\t\t\t   pss_idle[index]);\n\t}\n\n\tseq_puts(s, \"\\nPCS_STATUS Code\\n\");\n\tseq_puts(s, \"0:C0 1:C1 2:C1_DN_WT_DEV 3:C2 4:C2_WT_DE_MEM_UP\\n\");\n\tseq_puts(s, \"5:C2_WT_DE_MEM_DOWN 6:C2_UP_WT_DEV 7:C2_DN 8:C2_VOA\\n\");\n\tseq_puts(s, \"9:C2_VOA_UP 10:S0IX_PRE 11:S0IX\\n\");\n\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(telem_soc_states);\n\nstatic int telem_s0ix_res_get(void *data, u64 *val)\n{\n\tstruct telemetry_plt_config *plt_config = telemetry_get_pltdata();\n\tu64 s0ix_total_res;\n\tint ret;\n\n\tret = intel_pmc_s0ix_counter_read(plt_config->pmc, &s0ix_total_res);\n\tif (ret) {\n\t\tpr_err(\"Failed to read S0ix residency\");\n\t\treturn ret;\n\t}\n\n\t*val = s0ix_total_res;\n\n\treturn 0;\n}\n\nDEFINE_DEBUGFS_ATTRIBUTE(telem_s0ix_fops, telem_s0ix_res_get, NULL, \"%llu\\n\");\n\nstatic int telem_pss_trc_verb_show(struct seq_file *s, void *unused)\n{\n\tu32 verbosity;\n\tint err;\n\n\terr = telemetry_get_trace_verbosity(TELEM_PSS, &verbosity);\n\tif (err) {\n\t\tpr_err(\"Get PSS Trace Verbosity Failed with Error %d\\n\", err);\n\t\treturn -EFAULT;\n\t}\n\n\tseq_printf(s, \"PSS Trace Verbosity %u\\n\", verbosity);\n\treturn 0;\n}\n\nstatic ssize_t telem_pss_trc_verb_write(struct file *file,\n\t\t\t\t\tconst char __user *userbuf,\n\t\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tu32 verbosity;\n\tint err;\n\n\terr = kstrtou32_from_user(userbuf, count, 0, &verbosity);\n\tif (err)\n\t\treturn err;\n\n\terr = telemetry_set_trace_verbosity(TELEM_PSS, verbosity);\n\tif (err) {\n\t\tpr_err(\"Changing PSS Trace Verbosity Failed. Error %d\\n\", err);\n\t\treturn err;\n\t}\n\n\treturn count;\n}\n\nstatic int telem_pss_trc_verb_open(struct inode *inode, struct file *file)\n{\n\treturn single_open(file, telem_pss_trc_verb_show, inode->i_private);\n}\n\nstatic const struct file_operations telem_pss_trc_verb_ops = {\n\t.open\t\t= telem_pss_trc_verb_open,\n\t.read\t\t= seq_read,\n\t.write\t\t= telem_pss_trc_verb_write,\n\t.llseek\t\t= seq_lseek,\n\t.release\t= single_release,\n};\n\nstatic int telem_ioss_trc_verb_show(struct seq_file *s, void *unused)\n{\n\tu32 verbosity;\n\tint err;\n\n\terr = telemetry_get_trace_verbosity(TELEM_IOSS, &verbosity);\n\tif (err) {\n\t\tpr_err(\"Get IOSS Trace Verbosity Failed with Error %d\\n\", err);\n\t\treturn -EFAULT;\n\t}\n\n\tseq_printf(s, \"IOSS Trace Verbosity %u\\n\", verbosity);\n\treturn 0;\n}\n\nstatic ssize_t telem_ioss_trc_verb_write(struct file *file,\n\t\t\t\t\t const char __user *userbuf,\n\t\t\t\t\t size_t count, loff_t *ppos)\n{\n\tu32 verbosity;\n\tint err;\n\n\terr = kstrtou32_from_user(userbuf, count, 0, &verbosity);\n\tif (err)\n\t\treturn err;\n\n\terr = telemetry_set_trace_verbosity(TELEM_IOSS, verbosity);\n\tif (err) {\n\t\tpr_err(\"Changing IOSS Trace Verbosity Failed. Error %d\\n\", err);\n\t\treturn err;\n\t}\n\n\treturn count;\n}\n\nstatic int telem_ioss_trc_verb_open(struct inode *inode, struct file *file)\n{\n\treturn single_open(file, telem_ioss_trc_verb_show, inode->i_private);\n}\n\nstatic const struct file_operations telem_ioss_trc_verb_ops = {\n\t.open\t\t= telem_ioss_trc_verb_open,\n\t.read\t\t= seq_read,\n\t.write\t\t= telem_ioss_trc_verb_write,\n\t.llseek\t\t= seq_lseek,\n\t.release\t= single_release,\n};\n\nstatic int pm_suspend_prep_cb(void)\n{\n\tstruct telemetry_evtlog evtlog[TELEM_MAX_OS_ALLOCATED_EVENTS];\n\tstruct telemetry_debugfs_conf *conf = debugfs_conf;\n\tint ret, index;\n\n\tret = telemetry_raw_read_eventlog(TELEM_IOSS, evtlog,\n\t\t\tTELEM_MAX_OS_ALLOCATED_EVENTS);\n\tif (ret < 0) {\n\t\tsuspend_prep_ok = 0;\n\t\tgoto out;\n\t}\n\n\tfor (index = 0; index < ret; index++) {\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_occ_id,\n\t\t\t\t\t   suspend_shlw_ctr_temp);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_occ_id,\n\t\t\t\t\t   suspend_deep_ctr_temp);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_res_id,\n\t\t\t\t\t   suspend_shlw_res_temp);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_res_id,\n\t\t\t\t\t   suspend_deep_res_temp);\n\t}\n\tsuspend_prep_ok = 1;\nout:\n\treturn NOTIFY_OK;\n}\n\nstatic int pm_suspend_exit_cb(void)\n{\n\tstruct telemetry_evtlog evtlog[TELEM_MAX_OS_ALLOCATED_EVENTS];\n\tstatic u32 suspend_shlw_ctr_exit, suspend_deep_ctr_exit;\n\tstatic u64 suspend_shlw_res_exit, suspend_deep_res_exit;\n\tstruct telemetry_debugfs_conf *conf = debugfs_conf;\n\tint ret, index;\n\n\tif (!suspend_prep_ok)\n\t\tgoto out;\n\n\tret = telemetry_raw_read_eventlog(TELEM_IOSS, evtlog,\n\t\t\t\t\t  TELEM_MAX_OS_ALLOCATED_EVENTS);\n\tif (ret < 0)\n\t\tgoto out;\n\n\tfor (index = 0; index < ret; index++) {\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_occ_id,\n\t\t\t\t\t   suspend_shlw_ctr_exit);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_occ_id,\n\t\t\t\t\t   suspend_deep_ctr_exit);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_shlw_res_id,\n\t\t\t\t\t   suspend_shlw_res_exit);\n\n\t\tTELEM_CHECK_AND_PARSE_CTRS(conf->s0ix_deep_res_id,\n\t\t\t\t\t   suspend_deep_res_exit);\n\t}\n\n\tif ((suspend_shlw_ctr_exit < suspend_shlw_ctr_temp) ||\n\t    (suspend_deep_ctr_exit < suspend_deep_ctr_temp) ||\n\t    (suspend_shlw_res_exit < suspend_shlw_res_temp) ||\n\t    (suspend_deep_res_exit < suspend_deep_res_temp)) {\n\t\tpr_err(\"Wrong s0ix counters detected\\n\");\n\t\tgoto out;\n\t}\n\n\t \n\tif (suspend_shlw_ctr_exit == suspend_shlw_ctr_temp &&\n\t    suspend_deep_ctr_exit == suspend_deep_ctr_temp) {\n\t\tstruct telemetry_plt_config *plt_config = telemetry_get_pltdata();\n\t\tstruct intel_pmc_dev *pmc = plt_config->pmc;\n\n\t\tret = intel_pmc_gcr_read64(pmc, PMC_GCR_TELEM_SHLW_S0IX_REG,\n\t\t\t\t\t  &suspend_shlw_res_exit);\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\n\t\tret = intel_pmc_gcr_read64(pmc, PMC_GCR_TELEM_DEEP_S0IX_REG,\n\t\t\t\t\t  &suspend_deep_res_exit);\n\t\tif (ret < 0)\n\t\t\tgoto out;\n\n\t\tif (suspend_shlw_res_exit > suspend_shlw_res_temp)\n\t\t\tsuspend_shlw_ctr_exit++;\n\n\t\tif (suspend_deep_res_exit > suspend_deep_res_temp)\n\t\t\tsuspend_deep_ctr_exit++;\n\t}\n\n\tsuspend_shlw_ctr_exit -= suspend_shlw_ctr_temp;\n\tsuspend_deep_ctr_exit -= suspend_deep_ctr_temp;\n\tsuspend_shlw_res_exit -= suspend_shlw_res_temp;\n\tsuspend_deep_res_exit -= suspend_deep_res_temp;\n\n\tif (suspend_shlw_ctr_exit != 0) {\n\t\tconf->suspend_stats.shlw_ctr +=\n\t\tsuspend_shlw_ctr_exit;\n\n\t\tconf->suspend_stats.shlw_res +=\n\t\tsuspend_shlw_res_exit;\n\t}\n\n\tif (suspend_deep_ctr_exit != 0) {\n\t\tconf->suspend_stats.deep_ctr +=\n\t\tsuspend_deep_ctr_exit;\n\n\t\tconf->suspend_stats.deep_res +=\n\t\tsuspend_deep_res_exit;\n\t}\n\nout:\n\tsuspend_prep_ok = 0;\n\treturn NOTIFY_OK;\n}\n\nstatic int pm_notification(struct notifier_block *this,\n\t\t\t   unsigned long event, void *ptr)\n{\n\tswitch (event) {\n\tcase PM_SUSPEND_PREPARE:\n\t\treturn pm_suspend_prep_cb();\n\tcase PM_POST_SUSPEND:\n\t\treturn pm_suspend_exit_cb();\n\t}\n\n\treturn NOTIFY_DONE;\n}\n\nstatic struct notifier_block pm_notifier = {\n\t.notifier_call = pm_notification,\n};\n\nstatic int __init telemetry_debugfs_init(void)\n{\n\tconst struct x86_cpu_id *id;\n\tint err;\n\tstruct dentry *dir;\n\n\t \n\tid = x86_match_cpu(telemetry_debugfs_cpu_ids);\n\tif (!id)\n\t\treturn -ENODEV;\n\n\tdebugfs_conf = (struct telemetry_debugfs_conf *)id->driver_data;\n\n\tif (!telemetry_get_pltdata()) {\n\t\tpr_info(\"Invalid pltconfig, ensure IPC1 device is enabled in BIOS\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\terr = telemetry_debugfs_check_evts();\n\tif (err < 0) {\n\t\tpr_info(\"telemetry_debugfs_check_evts failed\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\tregister_pm_notifier(&pm_notifier);\n\n\tdir = debugfs_create_dir(\"telemetry\", NULL);\n\tdebugfs_conf->telemetry_dbg_dir = dir;\n\n\tdebugfs_create_file(\"pss_info\", S_IFREG | S_IRUGO, dir, NULL,\n\t\t\t    &telem_pss_states_fops);\n\tdebugfs_create_file(\"ioss_info\", S_IFREG | S_IRUGO, dir, NULL,\n\t\t\t    &telem_ioss_states_fops);\n\tdebugfs_create_file(\"soc_states\", S_IFREG | S_IRUGO, dir, NULL,\n\t\t\t    &telem_soc_states_fops);\n\tdebugfs_create_file(\"s0ix_residency_usec\", S_IFREG | S_IRUGO, dir, NULL,\n\t\t\t    &telem_s0ix_fops);\n\tdebugfs_create_file(\"pss_trace_verbosity\", S_IFREG | S_IRUGO, dir, NULL,\n\t\t\t    &telem_pss_trc_verb_ops);\n\tdebugfs_create_file(\"ioss_trace_verbosity\", S_IFREG | S_IRUGO, dir,\n\t\t\t    NULL, &telem_ioss_trc_verb_ops);\n\treturn 0;\n}\n\nstatic void __exit telemetry_debugfs_exit(void)\n{\n\tdebugfs_remove_recursive(debugfs_conf->telemetry_dbg_dir);\n\tdebugfs_conf->telemetry_dbg_dir = NULL;\n\tunregister_pm_notifier(&pm_notifier);\n}\n\nlate_initcall(telemetry_debugfs_init);\nmodule_exit(telemetry_debugfs_exit);\n\nMODULE_AUTHOR(\"Souvik Kumar Chakravarty <souvik.k.chakravarty@intel.com>\");\nMODULE_DESCRIPTION(\"Intel SoC Telemetry debugfs Interface\");\nMODULE_VERSION(DRIVER_VERSION);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}