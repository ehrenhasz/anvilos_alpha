{
  "module_name": "sysfs.c",
  "hash_id": "23d568de30a8236724de723fcab57840c2db3591d80ae6d5c0366123f9a8c71a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/intel/ifs/sysfs.c",
  "human_readable_source": "\n \n\n#include <linux/cpu.h>\n#include <linux/delay.h>\n#include <linux/fs.h>\n#include <linux/semaphore.h>\n#include <linux/slab.h>\n\n#include \"ifs.h\"\n\n \nstatic DEFINE_SEMAPHORE(ifs_sem, 1);\n\n \nstatic ssize_t details_show(struct device *dev,\n\t\t\t    struct device_attribute *attr,\n\t\t\t    char *buf)\n{\n\tstruct ifs_data *ifsd = ifs_get_data(dev);\n\n\treturn sysfs_emit(buf, \"%#llx\\n\", ifsd->scan_details);\n}\n\nstatic DEVICE_ATTR_RO(details);\n\nstatic const char * const status_msg[] = {\n\t[SCAN_NOT_TESTED] = \"untested\",\n\t[SCAN_TEST_PASS] = \"pass\",\n\t[SCAN_TEST_FAIL] = \"fail\"\n};\n\n \nstatic ssize_t status_show(struct device *dev,\n\t\t\t   struct device_attribute *attr,\n\t\t\t   char *buf)\n{\n\tstruct ifs_data *ifsd = ifs_get_data(dev);\n\n\treturn sysfs_emit(buf, \"%s\\n\", status_msg[ifsd->status]);\n}\n\nstatic DEVICE_ATTR_RO(status);\n\n \nstatic ssize_t run_test_store(struct device *dev,\n\t\t\t      struct device_attribute *attr,\n\t\t\t      const char *buf, size_t count)\n{\n\tunsigned int cpu;\n\tint rc;\n\n\trc = kstrtouint(buf, 0, &cpu);\n\tif (rc < 0 || cpu >= nr_cpu_ids)\n\t\treturn -EINVAL;\n\n\tif (down_interruptible(&ifs_sem))\n\t\treturn -EINTR;\n\n\trc = do_core_test(cpu, dev);\n\n\tup(&ifs_sem);\n\n\treturn rc ? rc : count;\n}\n\nstatic DEVICE_ATTR_WO(run_test);\n\nstatic ssize_t current_batch_store(struct device *dev,\n\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t   const char *buf, size_t count)\n{\n\tstruct ifs_data *ifsd = ifs_get_data(dev);\n\tunsigned int cur_batch;\n\tint rc;\n\n\trc = kstrtouint(buf, 0, &cur_batch);\n\tif (rc < 0 || cur_batch > 0xff)\n\t\treturn -EINVAL;\n\n\tif (down_interruptible(&ifs_sem))\n\t\treturn -EINTR;\n\n\tifsd->cur_batch = cur_batch;\n\n\trc = ifs_load_firmware(dev);\n\n\tup(&ifs_sem);\n\n\treturn (rc == 0) ? count : rc;\n}\n\nstatic ssize_t current_batch_show(struct device *dev,\n\t\t\t\t  struct device_attribute *attr, char *buf)\n{\n\tstruct ifs_data *ifsd = ifs_get_data(dev);\n\n\tif (!ifsd->loaded)\n\t\treturn sysfs_emit(buf, \"none\\n\");\n\telse\n\t\treturn sysfs_emit(buf, \"0x%02x\\n\", ifsd->cur_batch);\n}\n\nstatic DEVICE_ATTR_RW(current_batch);\n\n \nstatic ssize_t image_version_show(struct device *dev,\n\t\t\t\t  struct device_attribute *attr, char *buf)\n{\n\tstruct ifs_data *ifsd = ifs_get_data(dev);\n\n\tif (!ifsd->loaded)\n\t\treturn sysfs_emit(buf, \"%s\\n\", \"none\");\n\telse\n\t\treturn sysfs_emit(buf, \"%#x\\n\", ifsd->loaded_version);\n}\n\nstatic DEVICE_ATTR_RO(image_version);\n\n \nstruct attribute *plat_ifs_attrs[] = {\n\t&dev_attr_details.attr,\n\t&dev_attr_status.attr,\n\t&dev_attr_run_test.attr,\n\t&dev_attr_current_batch.attr,\n\t&dev_attr_image_version.attr,\n\tNULL\n};\n\n \nstruct attribute *plat_ifs_array_attrs[] = {\n\t&dev_attr_details.attr,\n\t&dev_attr_status.attr,\n\t&dev_attr_run_test.attr,\n\tNULL\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}