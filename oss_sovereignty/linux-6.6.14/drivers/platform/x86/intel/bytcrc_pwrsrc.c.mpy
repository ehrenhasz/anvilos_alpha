{
  "module_name": "bytcrc_pwrsrc.c",
  "hash_id": "8d290105bba6e6a5b01642a61a1fefb21e2fa0bb5db40c7d171b6bf774e5a40e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/intel/bytcrc_pwrsrc.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/mfd/intel_soc_pmic.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n#define CRYSTALCOVE_SPWRSRC_REG\t\t0x1E\n#define CRYSTALCOVE_RESETSRC0_REG\t0x20\n#define CRYSTALCOVE_RESETSRC1_REG\t0x21\n#define CRYSTALCOVE_WAKESRC_REG\t\t0x22\n\nstruct crc_pwrsrc_data {\n\tstruct regmap *regmap;\n\tstruct dentry *debug_dentry;\n\tunsigned int resetsrc0;\n\tunsigned int resetsrc1;\n\tunsigned int wakesrc;\n};\n\nstatic const char * const pwrsrc_pwrsrc_info[] = {\n\t  \"USB\",\n\t  \"DC in\",\n\t  \"Battery\",\n\tNULL,\n};\n\nstatic const char * const pwrsrc_resetsrc0_info[] = {\n\t  \"SOC reporting a thermal event\",\n\t  \"critical PMIC temperature\",\n\t  \"critical system temperature\",\n\t  \"critical battery temperature\",\n\t  \"VSYS under voltage\",\n\t  \"VSYS over voltage\",\n\t  \"battery removal\",\n\tNULL,\n};\n\nstatic const char * const pwrsrc_resetsrc1_info[] = {\n\t  \"VCRIT threshold\",\n\t  \"BATID reporting battery removal\",\n\t  \"user pressing the power button\",\n\tNULL,\n};\n\nstatic const char * const pwrsrc_wakesrc_info[] = {\n\t  \"user pressing the power button\",\n\t  \"a battery insertion\",\n\t  \"a USB charger insertion\",\n\t  \"an adapter insertion\",\n\tNULL,\n};\n\nstatic void crc_pwrsrc_log(struct seq_file *seq, const char *prefix,\n\t\t\t   const char * const *info, unsigned int reg_val)\n{\n\tint i;\n\n\tfor (i = 0; info[i]; i++) {\n\t\tif (reg_val & BIT(i))\n\t\t\tseq_printf(seq, \"%s by %s\\n\", prefix, info[i]);\n\t}\n}\n\nstatic int pwrsrc_show(struct seq_file *seq, void *unused)\n{\n\tstruct crc_pwrsrc_data *data = seq->private;\n\tunsigned int reg_val;\n\tint ret;\n\n\tret = regmap_read(data->regmap, CRYSTALCOVE_SPWRSRC_REG, &reg_val);\n\tif (ret)\n\t\treturn ret;\n\n\tcrc_pwrsrc_log(seq, \"System powered\", pwrsrc_pwrsrc_info, reg_val);\n\treturn 0;\n}\n\nstatic int resetsrc_show(struct seq_file *seq, void *unused)\n{\n\tstruct crc_pwrsrc_data *data = seq->private;\n\n\tcrc_pwrsrc_log(seq, \"Last shutdown caused\", pwrsrc_resetsrc0_info, data->resetsrc0);\n\tcrc_pwrsrc_log(seq, \"Last shutdown caused\", pwrsrc_resetsrc1_info, data->resetsrc1);\n\treturn 0;\n}\n\nstatic int wakesrc_show(struct seq_file *seq, void *unused)\n{\n\tstruct crc_pwrsrc_data *data = seq->private;\n\n\tcrc_pwrsrc_log(seq, \"Last wake caused\", pwrsrc_wakesrc_info, data->wakesrc);\n\treturn 0;\n}\n\nDEFINE_SHOW_ATTRIBUTE(pwrsrc);\nDEFINE_SHOW_ATTRIBUTE(resetsrc);\nDEFINE_SHOW_ATTRIBUTE(wakesrc);\n\nstatic int crc_pwrsrc_read_and_clear(struct crc_pwrsrc_data *data,\n\t\t\t\t     unsigned int reg, unsigned int *val)\n{\n\tint ret;\n\n\tret = regmap_read(data->regmap, reg, val);\n\tif (ret)\n\t\treturn ret;\n\n\treturn regmap_write(data->regmap, reg, *val);\n}\n\nstatic int crc_pwrsrc_probe(struct platform_device *pdev)\n{\n\tstruct intel_soc_pmic *pmic = dev_get_drvdata(pdev->dev.parent);\n\tstruct crc_pwrsrc_data *data;\n\tint ret;\n\n\tdata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\n\tif (!data)\n\t\treturn -ENOMEM;\n\n\tdata->regmap = pmic->regmap;\n\n\t \n\tret = crc_pwrsrc_read_and_clear(data, CRYSTALCOVE_RESETSRC0_REG, &data->resetsrc0);\n\tif (ret)\n\t\treturn ret;\n\n\tret = crc_pwrsrc_read_and_clear(data, CRYSTALCOVE_RESETSRC1_REG, &data->resetsrc1);\n\tif (ret)\n\t\treturn ret;\n\n\tret = crc_pwrsrc_read_and_clear(data, CRYSTALCOVE_WAKESRC_REG, &data->wakesrc);\n\tif (ret)\n\t\treturn ret;\n\n\tdata->debug_dentry = debugfs_create_dir(KBUILD_MODNAME, NULL);\n\tdebugfs_create_file(\"pwrsrc\", 0444, data->debug_dentry, data, &pwrsrc_fops);\n\tdebugfs_create_file(\"resetsrc\", 0444, data->debug_dentry, data, &resetsrc_fops);\n\tdebugfs_create_file(\"wakesrc\", 0444, data->debug_dentry, data, &wakesrc_fops);\n\n\tplatform_set_drvdata(pdev, data);\n\treturn 0;\n}\n\nstatic int crc_pwrsrc_remove(struct platform_device *pdev)\n{\n\tstruct crc_pwrsrc_data *data = platform_get_drvdata(pdev);\n\n\tdebugfs_remove_recursive(data->debug_dentry);\n\treturn 0;\n}\n\nstatic struct platform_driver crc_pwrsrc_driver = {\n\t.probe = crc_pwrsrc_probe,\n\t.remove = crc_pwrsrc_remove,\n\t.driver = {\n\t\t.name = \"crystal_cove_pwrsrc\",\n\t},\n};\nmodule_platform_driver(crc_pwrsrc_driver);\n\nMODULE_ALIAS(\"platform:crystal_cove_pwrsrc\");\nMODULE_AUTHOR(\"Hans de Goede <hdegoede@redhat.com>\");\nMODULE_DESCRIPTION(\"Power-source driver for Bay Trail Crystal Cove PMIC\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}