{
  "module_name": "mrfld_pwrbtn.c",
  "hash_id": "dbdedf76d965071f801b5efbc25dcfbd72be654417144a1e3c9620ddbeceacc0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/intel/mrfld_pwrbtn.c",
  "human_readable_source": "\n \n\n#include <linux/input.h>\n#include <linux/interrupt.h>\n#include <linux/device.h>\n#include <linux/mfd/intel_soc_pmic.h>\n#include <linux/mfd/intel_soc_pmic_mrfld.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/pm_wakeirq.h>\n#include <linux/slab.h>\n\n#define BCOVE_PBSTATUS\t\t0x27\n#define BCOVE_PBSTATUS_PBLVL\tBIT(4)\t \n\nstatic irqreturn_t mrfld_pwrbtn_interrupt(int irq, void *dev_id)\n{\n\tstruct input_dev *input = dev_id;\n\tstruct device *dev = input->dev.parent;\n\tstruct regmap *regmap = dev_get_drvdata(dev);\n\tunsigned int state;\n\tint ret;\n\n\tret = regmap_read(regmap, BCOVE_PBSTATUS, &state);\n\tif (ret)\n\t\treturn IRQ_NONE;\n\n\tdev_dbg(dev, \"PBSTATUS=0x%x\\n\", state);\n\tinput_report_key(input, KEY_POWER, !(state & BCOVE_PBSTATUS_PBLVL));\n\tinput_sync(input);\n\n\tregmap_update_bits(regmap, BCOVE_MIRQLVL1, BCOVE_LVL1_PWRBTN, 0);\n\treturn IRQ_HANDLED;\n}\n\nstatic int mrfld_pwrbtn_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct intel_soc_pmic *pmic = dev_get_drvdata(dev->parent);\n\tstruct input_dev *input;\n\tint irq, ret;\n\n\tirq = platform_get_irq(pdev, 0);\n\tif (irq < 0)\n\t\treturn irq;\n\n\tinput = devm_input_allocate_device(dev);\n\tif (!input)\n\t\treturn -ENOMEM;\n\tinput->name = pdev->name;\n\tinput->phys = \"power-button/input0\";\n\tinput->id.bustype = BUS_HOST;\n\tinput->dev.parent = dev;\n\tinput_set_capability(input, EV_KEY, KEY_POWER);\n\tret = input_register_device(input);\n\tif (ret)\n\t\treturn ret;\n\n\tdev_set_drvdata(dev, pmic->regmap);\n\n\tret = devm_request_threaded_irq(dev, irq, NULL, mrfld_pwrbtn_interrupt,\n\t\t\t\t\tIRQF_ONESHOT | IRQF_SHARED, pdev->name,\n\t\t\t\t\tinput);\n\tif (ret)\n\t\treturn ret;\n\n\tregmap_update_bits(pmic->regmap, BCOVE_MIRQLVL1, BCOVE_LVL1_PWRBTN, 0);\n\tregmap_update_bits(pmic->regmap, BCOVE_MPBIRQ, BCOVE_PBIRQ_PBTN, 0);\n\n\tdevice_init_wakeup(dev, true);\n\tdev_pm_set_wake_irq(dev, irq);\n\treturn 0;\n}\n\nstatic void mrfld_pwrbtn_remove(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\n\tdev_pm_clear_wake_irq(dev);\n\tdevice_init_wakeup(dev, false);\n}\n\nstatic const struct platform_device_id mrfld_pwrbtn_id_table[] = {\n\t{ .name = \"mrfld_bcove_pwrbtn\" },\n\t{}\n};\nMODULE_DEVICE_TABLE(platform, mrfld_pwrbtn_id_table);\n\nstatic struct platform_driver mrfld_pwrbtn_driver = {\n\t.driver = {\n\t\t.name\t= \"mrfld_bcove_pwrbtn\",\n\t},\n\t.probe\t\t= mrfld_pwrbtn_probe,\n\t.remove_new\t= mrfld_pwrbtn_remove,\n\t.id_table\t= mrfld_pwrbtn_id_table,\n};\nmodule_platform_driver(mrfld_pwrbtn_driver);\n\nMODULE_DESCRIPTION(\"Power-button driver for Basin Cove PMIC\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}