{
  "module_name": "pcengines-apuv2.c",
  "hash_id": "fec56afe377c1ba92d8eb9e8e2b15b6678daccbb5a65228f47898c5dc36ab4af",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/pcengines-apuv2.c",
  "human_readable_source": "\n\n \n\n#define pr_fmt(fmt)\tKBUILD_MODNAME \": \" fmt\n\n#include <linux/dmi.h>\n#include <linux/err.h>\n#include <linux/kernel.h>\n#include <linux/leds.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/gpio_keys.h>\n#include <linux/gpio/machine.h>\n#include <linux/input.h>\n#include <linux/platform_data/gpio/gpio-amd-fch.h>\n\n \n\n \n#define APU2_GPIO_REG_LED1\t\tAMD_FCH_GPIO_REG_GPIO57\n#define APU2_GPIO_REG_LED2\t\tAMD_FCH_GPIO_REG_GPIO58\n#define APU2_GPIO_REG_LED3\t\tAMD_FCH_GPIO_REG_GPIO59_DEVSLP1\n#define APU2_GPIO_REG_MODESW\t\tAMD_FCH_GPIO_REG_GPIO32_GE1\n#define APU2_GPIO_REG_SIMSWAP\t\tAMD_FCH_GPIO_REG_GPIO33_GE2\n#define APU2_GPIO_REG_MPCIE2\t\tAMD_FCH_GPIO_REG_GPIO55_DEVSLP0\n#define APU2_GPIO_REG_MPCIE3\t\tAMD_FCH_GPIO_REG_GPIO51\n\n \n#define APU2_GPIO_LINE_LED1\t\t0\n#define APU2_GPIO_LINE_LED2\t\t1\n#define APU2_GPIO_LINE_LED3\t\t2\n#define APU2_GPIO_LINE_MODESW\t\t3\n#define APU2_GPIO_LINE_SIMSWAP\t\t4\n#define APU2_GPIO_LINE_MPCIE2\t\t5\n#define APU2_GPIO_LINE_MPCIE3\t\t6\n\n \n\nstatic int apu2_gpio_regs[] = {\n\t[APU2_GPIO_LINE_LED1]\t\t= APU2_GPIO_REG_LED1,\n\t[APU2_GPIO_LINE_LED2]\t\t= APU2_GPIO_REG_LED2,\n\t[APU2_GPIO_LINE_LED3]\t\t= APU2_GPIO_REG_LED3,\n\t[APU2_GPIO_LINE_MODESW]\t\t= APU2_GPIO_REG_MODESW,\n\t[APU2_GPIO_LINE_SIMSWAP]\t= APU2_GPIO_REG_SIMSWAP,\n\t[APU2_GPIO_LINE_MPCIE2]\t\t= APU2_GPIO_REG_MPCIE2,\n\t[APU2_GPIO_LINE_MPCIE3]\t\t= APU2_GPIO_REG_MPCIE3,\n};\n\nstatic const char * const apu2_gpio_names[] = {\n\t[APU2_GPIO_LINE_LED1]\t\t= \"front-led1\",\n\t[APU2_GPIO_LINE_LED2]\t\t= \"front-led2\",\n\t[APU2_GPIO_LINE_LED3]\t\t= \"front-led3\",\n\t[APU2_GPIO_LINE_MODESW]\t\t= \"front-button\",\n\t[APU2_GPIO_LINE_SIMSWAP]\t= \"simswap\",\n\t[APU2_GPIO_LINE_MPCIE2]\t\t= \"mpcie2_reset\",\n\t[APU2_GPIO_LINE_MPCIE3]\t\t= \"mpcie3_reset\",\n};\n\nstatic const struct amd_fch_gpio_pdata board_apu2 = {\n\t.gpio_num\t= ARRAY_SIZE(apu2_gpio_regs),\n\t.gpio_reg\t= apu2_gpio_regs,\n\t.gpio_names\t= apu2_gpio_names,\n};\n\n \n\nstatic const struct gpio_led apu2_leds[] = {\n\t{ .name = \"apu:green:1\" },\n\t{ .name = \"apu:green:2\" },\n\t{ .name = \"apu:green:3\" },\n};\n\nstatic const struct gpio_led_platform_data apu2_leds_pdata = {\n\t.num_leds\t= ARRAY_SIZE(apu2_leds),\n\t.leds\t\t= apu2_leds,\n};\n\nstatic struct gpiod_lookup_table gpios_led_table = {\n\t.dev_id = \"leds-gpio\",\n\t.table = {\n\t\tGPIO_LOOKUP_IDX(AMD_FCH_GPIO_DRIVER_NAME, APU2_GPIO_LINE_LED1,\n\t\t\t\tNULL, 0, GPIO_ACTIVE_LOW),\n\t\tGPIO_LOOKUP_IDX(AMD_FCH_GPIO_DRIVER_NAME, APU2_GPIO_LINE_LED2,\n\t\t\t\tNULL, 1, GPIO_ACTIVE_LOW),\n\t\tGPIO_LOOKUP_IDX(AMD_FCH_GPIO_DRIVER_NAME, APU2_GPIO_LINE_LED3,\n\t\t\t\tNULL, 2, GPIO_ACTIVE_LOW),\n\t\t{}  \n\t}\n};\n\n \n\nstatic struct gpio_keys_button apu2_keys_buttons[] = {\n\t{\n\t\t.code\t\t\t= KEY_RESTART,\n\t\t.active_low\t\t= 1,\n\t\t.desc\t\t\t= \"front button\",\n\t\t.type\t\t\t= EV_KEY,\n\t\t.debounce_interval\t= 10,\n\t\t.value\t\t\t= 1,\n\t},\n};\n\nstatic const struct gpio_keys_platform_data apu2_keys_pdata = {\n\t.buttons\t= apu2_keys_buttons,\n\t.nbuttons\t= ARRAY_SIZE(apu2_keys_buttons),\n\t.poll_interval\t= 100,\n\t.rep\t\t= 0,\n\t.name\t\t= \"apu2-keys\",\n};\n\nstatic struct gpiod_lookup_table gpios_key_table = {\n\t.dev_id = \"gpio-keys-polled\",\n\t.table = {\n\t\tGPIO_LOOKUP_IDX(AMD_FCH_GPIO_DRIVER_NAME, APU2_GPIO_LINE_MODESW,\n\t\t\t\tNULL, 0, GPIO_ACTIVE_LOW),\n\t\t{}  \n\t}\n};\n\n \n\n \nstatic const struct dmi_system_id apu_gpio_dmi_table[] __initconst = {\n\n\t \n\t{\n\t\t.ident\t\t= \"apu2\",\n\t\t.matches\t= {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"PC Engines\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"APU2\")\n\t\t},\n\t\t.driver_data\t= (void *)&board_apu2,\n\t},\n\t \n\t{\n\t\t.ident\t\t= \"apu2\",\n\t\t.matches\t= {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"PC Engines\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"apu2\")\n\t\t},\n\t\t.driver_data\t= (void *)&board_apu2,\n\t},\n\t \n\t{\n\t\t.ident\t\t= \"apu2\",\n\t\t.matches\t= {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"PC Engines\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"PC Engines apu2\")\n\t\t},\n\t\t.driver_data\t= (void *)&board_apu2,\n\t},\n\n\t \n\t{\n\t\t.ident\t\t= \"apu3\",\n\t\t.matches\t= {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"PC Engines\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"APU3\")\n\t\t},\n\t\t.driver_data = (void *)&board_apu2,\n\t},\n\t \n\t{\n\t\t.ident       = \"apu3\",\n\t\t.matches     = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"PC Engines\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"apu3\")\n\t\t},\n\t\t.driver_data = (void *)&board_apu2,\n\t},\n\t \n\t{\n\t\t.ident       = \"apu3\",\n\t\t.matches     = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"PC Engines\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"PC Engines apu3\")\n\t\t},\n\t\t.driver_data = (void *)&board_apu2,\n\t},\n\t \n\t{\n\t\t.ident        = \"apu4\",\n\t\t.matches    = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"PC Engines\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"APU4\")\n\t\t},\n\t\t.driver_data = (void *)&board_apu2,\n\t},\n\t \n\t{\n\t\t.ident       = \"apu4\",\n\t\t.matches     = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"PC Engines\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"apu4\")\n\t\t},\n\t\t.driver_data = (void *)&board_apu2,\n\t},\n\t \n\t{\n\t\t.ident       = \"apu4\",\n\t\t.matches     = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"PC Engines\"),\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"PC Engines apu4\")\n\t\t},\n\t\t.driver_data = (void *)&board_apu2,\n\t},\n\t{}\n};\n\nstatic struct platform_device *apu_gpio_pdev;\nstatic struct platform_device *apu_leds_pdev;\nstatic struct platform_device *apu_keys_pdev;\n\nstatic struct platform_device * __init apu_create_pdev(\n\tconst char *name,\n\tconst void *pdata,\n\tsize_t sz)\n{\n\tstruct platform_device *pdev;\n\n\tpdev = platform_device_register_resndata(NULL,\n\t\tname,\n\t\tPLATFORM_DEVID_NONE,\n\t\tNULL,\n\t\t0,\n\t\tpdata,\n\t\tsz);\n\n\tif (IS_ERR(pdev))\n\t\tpr_err(\"failed registering %s: %ld\\n\", name, PTR_ERR(pdev));\n\n\treturn pdev;\n}\n\nstatic int __init apu_board_init(void)\n{\n\tconst struct dmi_system_id *id;\n\n\tid = dmi_first_match(apu_gpio_dmi_table);\n\tif (!id) {\n\t\tpr_err(\"failed to detect APU board via DMI\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tgpiod_add_lookup_table(&gpios_led_table);\n\tgpiod_add_lookup_table(&gpios_key_table);\n\n\tapu_gpio_pdev = apu_create_pdev(\n\t\tAMD_FCH_GPIO_DRIVER_NAME,\n\t\tid->driver_data,\n\t\tsizeof(struct amd_fch_gpio_pdata));\n\n\tapu_leds_pdev = apu_create_pdev(\n\t\t\"leds-gpio\",\n\t\t&apu2_leds_pdata,\n\t\tsizeof(apu2_leds_pdata));\n\n\tapu_keys_pdev = apu_create_pdev(\n\t\t\"gpio-keys-polled\",\n\t\t&apu2_keys_pdata,\n\t\tsizeof(apu2_keys_pdata));\n\n\treturn 0;\n}\n\nstatic void __exit apu_board_exit(void)\n{\n\tgpiod_remove_lookup_table(&gpios_led_table);\n\tgpiod_remove_lookup_table(&gpios_key_table);\n\n\tplatform_device_unregister(apu_keys_pdev);\n\tplatform_device_unregister(apu_leds_pdev);\n\tplatform_device_unregister(apu_gpio_pdev);\n}\n\nmodule_init(apu_board_init);\nmodule_exit(apu_board_exit);\n\nMODULE_AUTHOR(\"Enrico Weigelt, metux IT consult <info@metux.net>\");\nMODULE_DESCRIPTION(\"PC Engines APUv2/APUv3 board GPIO/LEDs/keys driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_DEVICE_TABLE(dmi, apu_gpio_dmi_table);\nMODULE_SOFTDEP(\"pre: platform:\" AMD_FCH_GPIO_DRIVER_NAME \" platform:leds-gpio platform:gpio_keys_polled\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}