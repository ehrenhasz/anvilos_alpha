{
  "module_name": "xo15-ebook.c",
  "hash_id": "9131143691b9abc647b583321e1a447b882ee2516e3e3edc590f6e63567334dc",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/xo15-ebook.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/types.h>\n#include <linux/input.h>\n#include <linux/acpi.h>\n\n#define MODULE_NAME \"xo15-ebook\"\n\n#define XO15_EBOOK_CLASS\t\tMODULE_NAME\n#define XO15_EBOOK_TYPE_UNKNOWN\t0x00\n#define XO15_EBOOK_NOTIFY_STATUS\t0x80\n\n#define XO15_EBOOK_SUBCLASS\t\t\"ebook\"\n#define XO15_EBOOK_HID\t\t\t\"XO15EBK\"\n#define XO15_EBOOK_DEVICE_NAME\t\t\"EBook Switch\"\n\nMODULE_DESCRIPTION(\"OLPC XO-1.5 ebook switch driver\");\nMODULE_LICENSE(\"GPL\");\n\nstatic const struct acpi_device_id ebook_device_ids[] = {\n\t{ XO15_EBOOK_HID, 0 },\n\t{ \"\", 0 },\n};\nMODULE_DEVICE_TABLE(acpi, ebook_device_ids);\n\nstruct ebook_switch {\n\tstruct input_dev *input;\n\tchar phys[32];\t\t\t \n};\n\nstatic int ebook_send_state(struct acpi_device *device)\n{\n\tstruct ebook_switch *button = acpi_driver_data(device);\n\tunsigned long long state;\n\tacpi_status status;\n\n\tstatus = acpi_evaluate_integer(device->handle, \"EBK\", NULL, &state);\n\tif (ACPI_FAILURE(status))\n\t\treturn -EIO;\n\n\t \n\tinput_report_switch(button->input, SW_TABLET_MODE, !state);\n\tinput_sync(button->input);\n\treturn 0;\n}\n\nstatic void ebook_switch_notify(struct acpi_device *device, u32 event)\n{\n\tswitch (event) {\n\tcase ACPI_FIXED_HARDWARE_EVENT:\n\tcase XO15_EBOOK_NOTIFY_STATUS:\n\t\tebook_send_state(device);\n\t\tbreak;\n\tdefault:\n\t\tacpi_handle_debug(device->handle,\n\t\t\t\t  \"Unsupported event [0x%x]\\n\", event);\n\t\tbreak;\n\t}\n}\n\n#ifdef CONFIG_PM_SLEEP\nstatic int ebook_switch_resume(struct device *dev)\n{\n\treturn ebook_send_state(to_acpi_device(dev));\n}\n#endif\n\nstatic SIMPLE_DEV_PM_OPS(ebook_switch_pm, NULL, ebook_switch_resume);\n\nstatic int ebook_switch_add(struct acpi_device *device)\n{\n\tstruct ebook_switch *button;\n\tstruct input_dev *input;\n\tconst char *hid = acpi_device_hid(device);\n\tchar *name, *class;\n\tint error;\n\n\tbutton = kzalloc(sizeof(struct ebook_switch), GFP_KERNEL);\n\tif (!button)\n\t\treturn -ENOMEM;\n\n\tdevice->driver_data = button;\n\n\tbutton->input = input = input_allocate_device();\n\tif (!input) {\n\t\terror = -ENOMEM;\n\t\tgoto err_free_button;\n\t}\n\n\tname = acpi_device_name(device);\n\tclass = acpi_device_class(device);\n\n\tif (strcmp(hid, XO15_EBOOK_HID)) {\n\t\tpr_err(\"Unsupported hid [%s]\\n\", hid);\n\t\terror = -ENODEV;\n\t\tgoto err_free_input;\n\t}\n\n\tstrcpy(name, XO15_EBOOK_DEVICE_NAME);\n\tsprintf(class, \"%s/%s\", XO15_EBOOK_CLASS, XO15_EBOOK_SUBCLASS);\n\n\tsnprintf(button->phys, sizeof(button->phys), \"%s/button/input0\", hid);\n\n\tinput->name = name;\n\tinput->phys = button->phys;\n\tinput->id.bustype = BUS_HOST;\n\tinput->dev.parent = &device->dev;\n\n\tinput->evbit[0] = BIT_MASK(EV_SW);\n\tset_bit(SW_TABLET_MODE, input->swbit);\n\n\terror = input_register_device(input);\n\tif (error)\n\t\tgoto err_free_input;\n\n\tebook_send_state(device);\n\n\tif (device->wakeup.flags.valid) {\n\t\t \n\t\tacpi_enable_gpe(device->wakeup.gpe_device,\n\t\t\t\tdevice->wakeup.gpe_number);\n\t\tdevice_set_wakeup_enable(&device->dev, true);\n\t}\n\n\treturn 0;\n\n err_free_input:\n\tinput_free_device(input);\n err_free_button:\n\tkfree(button);\n\treturn error;\n}\n\nstatic void ebook_switch_remove(struct acpi_device *device)\n{\n\tstruct ebook_switch *button = acpi_driver_data(device);\n\n\tinput_unregister_device(button->input);\n\tkfree(button);\n}\n\nstatic struct acpi_driver xo15_ebook_driver = {\n\t.name = MODULE_NAME,\n\t.class = XO15_EBOOK_CLASS,\n\t.ids = ebook_device_ids,\n\t.ops = {\n\t\t.add = ebook_switch_add,\n\t\t.remove = ebook_switch_remove,\n\t\t.notify = ebook_switch_notify,\n\t},\n\t.drv.pm = &ebook_switch_pm,\n};\nmodule_acpi_driver(xo15_ebook_driver);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}