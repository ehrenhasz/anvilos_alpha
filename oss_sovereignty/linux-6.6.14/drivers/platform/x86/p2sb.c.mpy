{
  "module_name": "p2sb.c",
  "hash_id": "49f1281606901896c314190da5f5971d6d2b19f8faff4d553360eb4397f72c8b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/p2sb.c",
  "human_readable_source": "\n \n\n#include <linux/bits.h>\n#include <linux/export.h>\n#include <linux/pci.h>\n#include <linux/platform_data/x86/p2sb.h>\n\n#include <asm/cpu_device_id.h>\n#include <asm/intel-family.h>\n\n#define P2SBC\t\t\t0xe0\n#define P2SBC_HIDE\t\tBIT(8)\n\n#define P2SB_DEVFN_DEFAULT\tPCI_DEVFN(31, 1)\n\nstatic const struct x86_cpu_id p2sb_cpu_ids[] = {\n\tX86_MATCH_INTEL_FAM6_MODEL(ATOM_GOLDMONT,\tPCI_DEVFN(13, 0)),\n\t{}\n};\n\nstatic int p2sb_get_devfn(unsigned int *devfn)\n{\n\tunsigned int fn = P2SB_DEVFN_DEFAULT;\n\tconst struct x86_cpu_id *id;\n\n\tid = x86_match_cpu(p2sb_cpu_ids);\n\tif (id)\n\t\tfn = (unsigned int)id->driver_data;\n\n\t*devfn = fn;\n\treturn 0;\n}\n\n \nstatic int p2sb_read_bar0(struct pci_dev *pdev, struct resource *mem)\n{\n\tstruct resource *bar0 = &pdev->resource[0];\n\n\t \n\tmemset(mem, 0, sizeof(*mem));\n\n\t \n\tmem->start = bar0->start;\n\tmem->end = bar0->end;\n\tmem->flags = bar0->flags;\n\tmem->desc = bar0->desc;\n\n\treturn 0;\n}\n\nstatic int p2sb_scan_and_read(struct pci_bus *bus, unsigned int devfn, struct resource *mem)\n{\n\tstruct pci_dev *pdev;\n\tint ret;\n\n\tpdev = pci_scan_single_device(bus, devfn);\n\tif (!pdev)\n\t\treturn -ENODEV;\n\n\tret = p2sb_read_bar0(pdev, mem);\n\n\tpci_stop_and_remove_bus_device(pdev);\n\treturn ret;\n}\n\n \nint p2sb_bar(struct pci_bus *bus, unsigned int devfn, struct resource *mem)\n{\n\tstruct pci_dev *pdev_p2sb;\n\tunsigned int devfn_p2sb;\n\tu32 value = P2SBC_HIDE;\n\tint ret;\n\n\t \n\tret = p2sb_get_devfn(&devfn_p2sb);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\tbus = bus ?: pci_find_bus(0, 0);\n\n\t \n\tpci_lock_rescan_remove();\n\n\t \n\tpci_bus_read_config_dword(bus, devfn_p2sb, P2SBC, &value);\n\tif (value & P2SBC_HIDE)\n\t\tpci_bus_write_config_dword(bus, devfn_p2sb, P2SBC, 0);\n\n\tpdev_p2sb = pci_scan_single_device(bus, devfn_p2sb);\n\tif (devfn)\n\t\tret = p2sb_scan_and_read(bus, devfn, mem);\n\telse\n\t\tret = p2sb_read_bar0(pdev_p2sb, mem);\n\tpci_stop_and_remove_bus_device(pdev_p2sb);\n\n\t \n\tif (value & P2SBC_HIDE)\n\t\tpci_bus_write_config_dword(bus, devfn_p2sb, P2SBC, P2SBC_HIDE);\n\n\tpci_unlock_rescan_remove();\n\n\tif (ret)\n\t\treturn ret;\n\n\tif (mem->flags == 0)\n\t\treturn -ENODEV;\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(p2sb_bar);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}