{
  "module_name": "wmi-bmof.c",
  "hash_id": "92e856b83d6eeebfda1a5b3685964ca64c1160f86b3f4a1f86eb87807a594999",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/wmi-bmof.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/acpi.h>\n#include <linux/device.h>\n#include <linux/fs.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/string.h>\n#include <linux/sysfs.h>\n#include <linux/types.h>\n#include <linux/wmi.h>\n\n#define WMI_BMOF_GUID \"05901221-D566-11D1-B2F0-00A0C9062910\"\n\nstruct bmof_priv {\n\tunion acpi_object *bmofdata;\n\tstruct bin_attribute bmof_bin_attr;\n};\n\nstatic ssize_t read_bmof(struct file *filp, struct kobject *kobj, struct bin_attribute *attr,\n\t\t\t char *buf, loff_t off, size_t count)\n{\n\tstruct bmof_priv *priv = container_of(attr, struct bmof_priv, bmof_bin_attr);\n\n\treturn memory_read_from_buffer(buf, count, &off, priv->bmofdata->buffer.pointer,\n\t\t\t\t       priv->bmofdata->buffer.length);\n}\n\nstatic int wmi_bmof_probe(struct wmi_device *wdev, const void *context)\n{\n\tstruct bmof_priv *priv;\n\tint ret;\n\n\tpriv = devm_kzalloc(&wdev->dev, sizeof(struct bmof_priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\tdev_set_drvdata(&wdev->dev, priv);\n\n\tpriv->bmofdata = wmidev_block_query(wdev, 0);\n\tif (!priv->bmofdata) {\n\t\tdev_err(&wdev->dev, \"failed to read Binary MOF\\n\");\n\t\treturn -EIO;\n\t}\n\n\tif (priv->bmofdata->type != ACPI_TYPE_BUFFER) {\n\t\tdev_err(&wdev->dev, \"Binary MOF is not a buffer\\n\");\n\t\tret = -EIO;\n\t\tgoto err_free;\n\t}\n\n\tsysfs_bin_attr_init(&priv->bmof_bin_attr);\n\tpriv->bmof_bin_attr.attr.name = \"bmof\";\n\tpriv->bmof_bin_attr.attr.mode = 0400;\n\tpriv->bmof_bin_attr.read = read_bmof;\n\tpriv->bmof_bin_attr.size = priv->bmofdata->buffer.length;\n\n\tret = device_create_bin_file(&wdev->dev, &priv->bmof_bin_attr);\n\tif (ret)\n\t\tgoto err_free;\n\n\treturn 0;\n\n err_free:\n\tkfree(priv->bmofdata);\n\treturn ret;\n}\n\nstatic void wmi_bmof_remove(struct wmi_device *wdev)\n{\n\tstruct bmof_priv *priv = dev_get_drvdata(&wdev->dev);\n\n\tdevice_remove_bin_file(&wdev->dev, &priv->bmof_bin_attr);\n\tkfree(priv->bmofdata);\n}\n\nstatic const struct wmi_device_id wmi_bmof_id_table[] = {\n\t{ .guid_string = WMI_BMOF_GUID },\n\t{ },\n};\n\nstatic struct wmi_driver wmi_bmof_driver = {\n\t.driver = {\n\t\t.name = \"wmi-bmof\",\n\t},\n\t.probe = wmi_bmof_probe,\n\t.remove = wmi_bmof_remove,\n\t.id_table = wmi_bmof_id_table,\n};\n\nmodule_wmi_driver(wmi_bmof_driver);\n\nMODULE_DEVICE_TABLE(wmi, wmi_bmof_id_table);\nMODULE_AUTHOR(\"Andrew Lutomirski <luto@kernel.org>\");\nMODULE_DESCRIPTION(\"WMI embedded Binary MOF driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}