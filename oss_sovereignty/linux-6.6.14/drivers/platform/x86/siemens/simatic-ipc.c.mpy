{
  "module_name": "simatic-ipc.c",
  "hash_id": "bc6723afab93a8e9613329eb4f3ed3ab5666c6be46f116fe2c9b23e7f57d0a5a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/siemens/simatic-ipc.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/dmi.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_data/x86/simatic-ipc.h>\n#include <linux/platform_device.h>\n\nstatic struct platform_device *ipc_led_platform_device;\nstatic struct platform_device *ipc_wdt_platform_device;\nstatic struct platform_device *ipc_batt_platform_device;\n\nstatic const struct dmi_system_id simatic_ipc_whitelist[] = {\n\t{\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"SIEMENS AG\"),\n\t\t},\n\t},\n\t{}\n};\n\nstatic struct simatic_ipc_platform platform_data;\n\n#define SIMATIC_IPC_MAX_EXTRA_MODULES 2\n\nstatic struct {\n\tu32 station_id;\n\tu8 led_mode;\n\tu8 wdt_mode;\n\tu8 batt_mode;\n\tchar *extra_modules[SIMATIC_IPC_MAX_EXTRA_MODULES];\n} device_modes[] = {\n\t{SIMATIC_IPC_IPC127E,\n\t\tSIMATIC_IPC_DEVICE_127E, SIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_127E,\n\t\t{ \"emc1403\", NULL }},\n\t{SIMATIC_IPC_IPC227D,\n\t\tSIMATIC_IPC_DEVICE_227D, SIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_NONE,\n\t\t{ \"emc1403\", NULL }},\n\t{SIMATIC_IPC_IPC227E,\n\t\tSIMATIC_IPC_DEVICE_427E, SIMATIC_IPC_DEVICE_227E, SIMATIC_IPC_DEVICE_227E,\n\t\t{ \"emc1403\", NULL }},\n\t{SIMATIC_IPC_IPC227G,\n\t\tSIMATIC_IPC_DEVICE_227G, SIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_227G,\n\t\t{ \"nct6775\", \"w83627hf_wdt\" }},\n\t{SIMATIC_IPC_IPC277G,\n\t\tSIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_227G,\n\t\t{ \"nct6775\", \"w83627hf_wdt\" }},\n\t{SIMATIC_IPC_IPC277E,\n\t\tSIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_227E, SIMATIC_IPC_DEVICE_227E,\n\t\t{ \"emc1403\", NULL }},\n\t{SIMATIC_IPC_IPC427D,\n\t\tSIMATIC_IPC_DEVICE_427E, SIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_NONE,\n\t\t{ \"emc1403\", NULL }},\n\t{SIMATIC_IPC_IPC427E,\n\t\tSIMATIC_IPC_DEVICE_427E, SIMATIC_IPC_DEVICE_427E, SIMATIC_IPC_DEVICE_NONE,\n\t\t{ \"emc1403\", NULL }},\n\t{SIMATIC_IPC_IPC477E,\n\t\tSIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_427E, SIMATIC_IPC_DEVICE_NONE,\n\t\t{ \"emc1403\", NULL }},\n\t{SIMATIC_IPC_IPCBX_39A,\n\t\tSIMATIC_IPC_DEVICE_227G, SIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_BX_39A,\n\t\t{ \"nct6775\", \"w83627hf_wdt\" }},\n\t{SIMATIC_IPC_IPCPX_39A,\n\t\tSIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_BX_39A,\n\t\t{ \"nct6775\", \"w83627hf_wdt\" }},\n\t{SIMATIC_IPC_IPCBX_21A,\n\t\tSIMATIC_IPC_DEVICE_BX_21A, SIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_BX_21A,\n\t\t{ \"emc1403\", NULL }},\n\t{SIMATIC_IPC_IPCBX_56A,\n\t\tSIMATIC_IPC_DEVICE_BX_59A, SIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_BX_59A,\n\t\t{ \"emc1403\", \"w83627hf_wdt\" }},\n\t{SIMATIC_IPC_IPCBX_59A,\n\t\tSIMATIC_IPC_DEVICE_BX_59A, SIMATIC_IPC_DEVICE_NONE, SIMATIC_IPC_DEVICE_BX_59A,\n\t\t{ \"emc1403\", \"w83627hf_wdt\" }},\n};\n\nstatic int register_platform_devices(u32 station_id)\n{\n\tu8 ledmode = SIMATIC_IPC_DEVICE_NONE;\n\tu8 wdtmode = SIMATIC_IPC_DEVICE_NONE;\n\tu8 battmode = SIMATIC_IPC_DEVICE_NONE;\n\tchar *pdevname;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(device_modes); i++) {\n\t\tif (device_modes[i].station_id == station_id) {\n\t\t\tledmode = device_modes[i].led_mode;\n\t\t\twdtmode = device_modes[i].wdt_mode;\n\t\t\tbattmode = device_modes[i].batt_mode;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (battmode != SIMATIC_IPC_DEVICE_NONE) {\n\t\tpdevname = KBUILD_MODNAME \"_batt\";\n\t\tif (battmode == SIMATIC_IPC_DEVICE_127E)\n\t\t\tpdevname = KBUILD_MODNAME \"_batt_apollolake\";\n\t\tif (battmode == SIMATIC_IPC_DEVICE_BX_21A)\n\t\t\tpdevname = KBUILD_MODNAME \"_batt_elkhartlake\";\n\t\tif (battmode == SIMATIC_IPC_DEVICE_227G ||\n\t\t    battmode == SIMATIC_IPC_DEVICE_BX_39A ||\n\t\t    battmode == SIMATIC_IPC_DEVICE_BX_59A)\n\t\t\tpdevname = KBUILD_MODNAME \"_batt_f7188x\";\n\t\tplatform_data.devmode = battmode;\n\t\tipc_batt_platform_device =\n\t\t\tplatform_device_register_data(NULL, pdevname,\n\t\t\t\tPLATFORM_DEVID_NONE, &platform_data,\n\t\t\t\tsizeof(struct simatic_ipc_platform));\n\t\tif (IS_ERR(ipc_batt_platform_device))\n\t\t\treturn PTR_ERR(ipc_batt_platform_device);\n\n\t\tpr_debug(\"device=%s created\\n\",\n\t\t\t ipc_batt_platform_device->name);\n\t}\n\n\tif (ledmode != SIMATIC_IPC_DEVICE_NONE) {\n\t\tpdevname = KBUILD_MODNAME \"_leds\";\n\t\tif (ledmode == SIMATIC_IPC_DEVICE_127E)\n\t\t\tpdevname = KBUILD_MODNAME \"_leds_gpio_apollolake\";\n\t\tif (ledmode == SIMATIC_IPC_DEVICE_227G || ledmode == SIMATIC_IPC_DEVICE_BX_59A)\n\t\t\tpdevname = KBUILD_MODNAME \"_leds_gpio_f7188x\";\n\t\tif (ledmode == SIMATIC_IPC_DEVICE_BX_21A)\n\t\t\tpdevname = KBUILD_MODNAME \"_leds_gpio_elkhartlake\";\n\t\tplatform_data.devmode = ledmode;\n\t\tipc_led_platform_device =\n\t\t\tplatform_device_register_data(NULL,\n\t\t\t\tpdevname, PLATFORM_DEVID_NONE,\n\t\t\t\t&platform_data,\n\t\t\t\tsizeof(struct simatic_ipc_platform));\n\t\tif (IS_ERR(ipc_led_platform_device))\n\t\t\treturn PTR_ERR(ipc_led_platform_device);\n\n\t\tpr_debug(\"device=%s created\\n\",\n\t\t\t ipc_led_platform_device->name);\n\t}\n\n\tif (wdtmode != SIMATIC_IPC_DEVICE_NONE) {\n\t\tplatform_data.devmode = wdtmode;\n\t\tipc_wdt_platform_device =\n\t\t\tplatform_device_register_data(NULL,\n\t\t\t\tKBUILD_MODNAME \"_wdt\", PLATFORM_DEVID_NONE,\n\t\t\t\t&platform_data,\n\t\t\t\tsizeof(struct simatic_ipc_platform));\n\t\tif (IS_ERR(ipc_wdt_platform_device))\n\t\t\treturn PTR_ERR(ipc_wdt_platform_device);\n\n\t\tpr_debug(\"device=%s created\\n\",\n\t\t\t ipc_wdt_platform_device->name);\n\t}\n\n\tif (ledmode == SIMATIC_IPC_DEVICE_NONE &&\n\t    wdtmode == SIMATIC_IPC_DEVICE_NONE &&\n\t    battmode == SIMATIC_IPC_DEVICE_NONE) {\n\t\tpr_warn(\"unsupported IPC detected, station id=%08x\\n\",\n\t\t\tstation_id);\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic void request_additional_modules(u32 station_id)\n{\n\tchar **extra_modules = NULL;\n\tint i;\n\n\tfor (i = 0; i < ARRAY_SIZE(device_modes); i++) {\n\t\tif (device_modes[i].station_id == station_id) {\n\t\t\textra_modules = device_modes[i].extra_modules;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (!extra_modules)\n\t\treturn;\n\n\tfor (i = 0; i < SIMATIC_IPC_MAX_EXTRA_MODULES; i++) {\n\t\tif (extra_modules[i])\n\t\t\trequest_module(extra_modules[i]);\n\t\telse\n\t\t\tbreak;\n\t}\n}\n\nstatic int __init simatic_ipc_init_module(void)\n{\n\tconst struct dmi_system_id *match;\n\tu32 station_id;\n\tint err;\n\n\tmatch = dmi_first_match(simatic_ipc_whitelist);\n\tif (!match)\n\t\treturn 0;\n\n\terr = dmi_walk(simatic_ipc_find_dmi_entry_helper, &station_id);\n\n\tif (err || station_id == SIMATIC_IPC_INVALID_STATION_ID) {\n\t\tpr_warn(\"DMI entry %d not found\\n\", SIMATIC_IPC_DMI_ENTRY_OEM);\n\t\treturn 0;\n\t}\n\n\trequest_additional_modules(station_id);\n\n\treturn register_platform_devices(station_id);\n}\n\nstatic void __exit simatic_ipc_exit_module(void)\n{\n\tplatform_device_unregister(ipc_led_platform_device);\n\tipc_led_platform_device = NULL;\n\n\tplatform_device_unregister(ipc_wdt_platform_device);\n\tipc_wdt_platform_device = NULL;\n\n\tplatform_device_unregister(ipc_batt_platform_device);\n\tipc_batt_platform_device = NULL;\n}\n\nmodule_init(simatic_ipc_init_module);\nmodule_exit(simatic_ipc_exit_module);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Gerd Haeussler <gerd.haeussler.ext@siemens.com>\");\nMODULE_ALIAS(\"dmi:*:svnSIEMENSAG:*\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}