{
  "module_name": "nvidia-wmi-ec-backlight.c",
  "hash_id": "78af127650f552a8eb05ae0c173b4e44949a6ea56fcb0f17c657722b99962c7b",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/nvidia-wmi-ec-backlight.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/backlight.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/platform_data/x86/nvidia-wmi-ec-backlight.h>\n#include <linux/types.h>\n#include <linux/wmi.h>\n#include <acpi/video.h>\n\nstatic bool force;\nmodule_param(force, bool, 0444);\nMODULE_PARM_DESC(force, \"Force loading (disable acpi_backlight=xxx checks\");\n\n \nstatic int wmi_brightness_notify(struct wmi_device *w, enum wmi_brightness_method id, enum wmi_brightness_mode mode, u32 *val)\n{\n\tstruct wmi_brightness_args args = {\n\t\t.mode = mode,\n\t\t.val = 0,\n\t\t.ret = 0,\n\t};\n\tstruct acpi_buffer buf = { (acpi_size)sizeof(args), &args };\n\tacpi_status status;\n\n\tif (id < WMI_BRIGHTNESS_METHOD_LEVEL ||\n\t    id >= WMI_BRIGHTNESS_METHOD_MAX ||\n\t    mode < WMI_BRIGHTNESS_MODE_GET || mode >= WMI_BRIGHTNESS_MODE_MAX)\n\t\treturn -EINVAL;\n\n\tif (mode == WMI_BRIGHTNESS_MODE_SET)\n\t\targs.val = *val;\n\n\tstatus = wmidev_evaluate_method(w, 0, id, &buf, &buf);\n\tif (ACPI_FAILURE(status)) {\n\t\tdev_err(&w->dev, \"EC backlight control failed: %s\\n\",\n\t\t\tacpi_format_exception(status));\n\t\treturn -EIO;\n\t}\n\n\tif (mode != WMI_BRIGHTNESS_MODE_SET)\n\t\t*val = args.ret;\n\n\treturn 0;\n}\n\nstatic int nvidia_wmi_ec_backlight_update_status(struct backlight_device *bd)\n{\n\tstruct wmi_device *wdev = bl_get_data(bd);\n\n\treturn wmi_brightness_notify(wdev, WMI_BRIGHTNESS_METHOD_LEVEL,\n\t                             WMI_BRIGHTNESS_MODE_SET,\n\t\t\t             &bd->props.brightness);\n}\n\nstatic int nvidia_wmi_ec_backlight_get_brightness(struct backlight_device *bd)\n{\n\tstruct wmi_device *wdev = bl_get_data(bd);\n\tu32 level;\n\tint ret;\n\n\tret = wmi_brightness_notify(wdev, WMI_BRIGHTNESS_METHOD_LEVEL,\n\t                            WMI_BRIGHTNESS_MODE_GET, &level);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn level;\n}\n\nstatic const struct backlight_ops nvidia_wmi_ec_backlight_ops = {\n\t.update_status = nvidia_wmi_ec_backlight_update_status,\n\t.get_brightness = nvidia_wmi_ec_backlight_get_brightness,\n};\n\nstatic int nvidia_wmi_ec_backlight_probe(struct wmi_device *wdev, const void *ctx)\n{\n\tstruct backlight_properties props = {};\n\tstruct backlight_device *bdev;\n\tint ret;\n\n\t \n\tif (!force && acpi_video_get_backlight_type() != acpi_backlight_nvidia_wmi_ec)\n\t\treturn -ENODEV;\n\n\t \n\tprops.type = BACKLIGHT_FIRMWARE;\n\n\tret = wmi_brightness_notify(wdev, WMI_BRIGHTNESS_METHOD_LEVEL,\n\t                           WMI_BRIGHTNESS_MODE_GET_MAX_LEVEL,\n\t                           &props.max_brightness);\n\tif (ret)\n\t\treturn ret;\n\n\tret = wmi_brightness_notify(wdev, WMI_BRIGHTNESS_METHOD_LEVEL,\n\t                           WMI_BRIGHTNESS_MODE_GET, &props.brightness);\n\tif (ret)\n\t\treturn ret;\n\n\tbdev = devm_backlight_device_register(&wdev->dev,\n\t                                      \"nvidia_wmi_ec_backlight\",\n\t\t\t\t\t      &wdev->dev, wdev,\n\t\t\t\t\t      &nvidia_wmi_ec_backlight_ops,\n\t\t\t\t\t      &props);\n\treturn PTR_ERR_OR_ZERO(bdev);\n}\n\nstatic const struct wmi_device_id nvidia_wmi_ec_backlight_id_table[] = {\n\t{ .guid_string = WMI_BRIGHTNESS_GUID },\n\t{ }\n};\nMODULE_DEVICE_TABLE(wmi, nvidia_wmi_ec_backlight_id_table);\n\nstatic struct wmi_driver nvidia_wmi_ec_backlight_driver = {\n\t.driver = {\n\t\t.name = \"nvidia-wmi-ec-backlight\",\n\t},\n\t.probe = nvidia_wmi_ec_backlight_probe,\n\t.id_table = nvidia_wmi_ec_backlight_id_table,\n};\nmodule_wmi_driver(nvidia_wmi_ec_backlight_driver);\n\nMODULE_AUTHOR(\"Daniel Dadap <ddadap@nvidia.com>\");\nMODULE_DESCRIPTION(\"NVIDIA WMI EC Backlight driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}