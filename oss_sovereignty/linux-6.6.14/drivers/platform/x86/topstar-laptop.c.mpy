{
  "module_name": "topstar-laptop.c",
  "hash_id": "e4522ad8f3ad7e2f91ea10890bf98cc51716354db7ace9b4bb1d26ae80d55033",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/topstar-laptop.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/slab.h>\n#include <linux/acpi.h>\n#include <linux/dmi.h>\n#include <linux/input.h>\n#include <linux/input/sparse-keymap.h>\n#include <linux/leds.h>\n#include <linux/platform_device.h>\n\n#define TOPSTAR_LAPTOP_CLASS \"topstar\"\n\nstruct topstar_laptop {\n\tstruct acpi_device *device;\n\tstruct platform_device *platform;\n\tstruct input_dev *input;\n\tstruct led_classdev led;\n};\n\n \n\nstatic enum led_brightness topstar_led_get(struct led_classdev *led)\n{\n\treturn led->brightness;\n}\n\nstatic int topstar_led_set(struct led_classdev *led,\n\t\tenum led_brightness state)\n{\n\tstruct topstar_laptop *topstar = container_of(led,\n\t\t\tstruct topstar_laptop, led);\n\n\tstruct acpi_object_list params;\n\tunion acpi_object in_obj;\n\tunsigned long long int ret;\n\tacpi_status status;\n\n\tparams.count = 1;\n\tparams.pointer = &in_obj;\n\tin_obj.type = ACPI_TYPE_INTEGER;\n\tin_obj.integer.value = 0x83;\n\n\t \n\tstatus = acpi_evaluate_integer(topstar->device->handle,\n\t\t\t\"GETX\", &params, &ret);\n\tif (ACPI_FAILURE(status))\n\t\treturn -1;\n\n\t \n\tif ((ret == 0x30001 && state == LED_OFF)\n\t\t\t|| (ret == 0x30000 && state != LED_OFF)) {\n\t\tstatus = acpi_execute_simple_method(topstar->device->handle,\n\t\t\t\t\"FNCX\", 0x83);\n\t\tif (ACPI_FAILURE(status))\n\t\t\treturn -1;\n\t}\n\n\treturn 0;\n}\n\nstatic int topstar_led_init(struct topstar_laptop *topstar)\n{\n\ttopstar->led = (struct led_classdev) {\n\t\t.default_trigger = \"rfkill0\",\n\t\t.brightness_get = topstar_led_get,\n\t\t.brightness_set_blocking = topstar_led_set,\n\t\t.name = TOPSTAR_LAPTOP_CLASS \"::wlan\",\n\t};\n\n\treturn led_classdev_register(&topstar->platform->dev, &topstar->led);\n}\n\nstatic void topstar_led_exit(struct topstar_laptop *topstar)\n{\n\tled_classdev_unregister(&topstar->led);\n}\n\n \n\nstatic const struct key_entry topstar_keymap[] = {\n\t{ KE_KEY, 0x80, { KEY_BRIGHTNESSUP } },\n\t{ KE_KEY, 0x81, { KEY_BRIGHTNESSDOWN } },\n\t{ KE_KEY, 0x83, { KEY_VOLUMEUP } },\n\t{ KE_KEY, 0x84, { KEY_VOLUMEDOWN } },\n\t{ KE_KEY, 0x85, { KEY_MUTE } },\n\t{ KE_KEY, 0x86, { KEY_SWITCHVIDEOMODE } },\n\t{ KE_KEY, 0x87, { KEY_F13 } },  \n\t{ KE_KEY, 0x88, { KEY_WLAN } },\n\t{ KE_KEY, 0x8a, { KEY_WWW } },\n\t{ KE_KEY, 0x8b, { KEY_MAIL } },\n\t{ KE_KEY, 0x8c, { KEY_MEDIA } },\n\n\t \n\t{ KE_IGNORE, 0x82, },  \n\t{ KE_IGNORE, 0x8e, },\n\t{ KE_IGNORE, 0x8f, },\n\t{ KE_IGNORE, 0x90, },\n\n\t \n\t{ KE_KEY, 0x96, { KEY_F14 } },\n\t{ KE_KEY, 0x97, { KEY_F14 } },\n\n\t{ KE_END, 0 }\n};\n\nstatic void topstar_input_notify(struct topstar_laptop *topstar, int event)\n{\n\tif (!sparse_keymap_report_event(topstar->input, event, 1, true))\n\t\tpr_info(\"unknown event = 0x%02x\\n\", event);\n}\n\nstatic int topstar_input_init(struct topstar_laptop *topstar)\n{\n\tstruct input_dev *input;\n\tint err;\n\n\tinput = input_allocate_device();\n\tif (!input)\n\t\treturn -ENOMEM;\n\n\tinput->name = \"Topstar Laptop extra buttons\";\n\tinput->phys = TOPSTAR_LAPTOP_CLASS \"/input0\";\n\tinput->id.bustype = BUS_HOST;\n\tinput->dev.parent = &topstar->platform->dev;\n\n\terr = sparse_keymap_setup(input, topstar_keymap, NULL);\n\tif (err) {\n\t\tpr_err(\"Unable to setup input device keymap\\n\");\n\t\tgoto err_free_dev;\n\t}\n\n\terr = input_register_device(input);\n\tif (err) {\n\t\tpr_err(\"Unable to register input device\\n\");\n\t\tgoto err_free_dev;\n\t}\n\n\ttopstar->input = input;\n\treturn 0;\n\nerr_free_dev:\n\tinput_free_device(input);\n\treturn err;\n}\n\nstatic void topstar_input_exit(struct topstar_laptop *topstar)\n{\n\tinput_unregister_device(topstar->input);\n}\n\n \n\nstatic struct platform_driver topstar_platform_driver = {\n\t.driver = {\n\t\t.name = TOPSTAR_LAPTOP_CLASS,\n\t},\n};\n\nstatic int topstar_platform_init(struct topstar_laptop *topstar)\n{\n\tint err;\n\n\ttopstar->platform = platform_device_alloc(TOPSTAR_LAPTOP_CLASS, PLATFORM_DEVID_NONE);\n\tif (!topstar->platform)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(topstar->platform, topstar);\n\n\terr = platform_device_add(topstar->platform);\n\tif (err)\n\t\tgoto err_device_put;\n\n\treturn 0;\n\nerr_device_put:\n\tplatform_device_put(topstar->platform);\n\treturn err;\n}\n\nstatic void topstar_platform_exit(struct topstar_laptop *topstar)\n{\n\tplatform_device_unregister(topstar->platform);\n}\n\n \n\nstatic int topstar_acpi_fncx_switch(struct acpi_device *device, bool state)\n{\n\tacpi_status status;\n\tu64 arg = state ? 0x86 : 0x87;\n\n\tstatus = acpi_execute_simple_method(device->handle, \"FNCX\", arg);\n\tif (ACPI_FAILURE(status)) {\n\t\tpr_err(\"Unable to switch FNCX notifications\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\treturn 0;\n}\n\nstatic void topstar_acpi_notify(struct acpi_device *device, u32 event)\n{\n\tstruct topstar_laptop *topstar = acpi_driver_data(device);\n\tstatic bool dup_evnt[2];\n\tbool *dup;\n\n\t \n\tif (event == 0x83 || event == 0x84) {\n\t\tdup = &dup_evnt[event - 0x83];\n\t\tif (*dup) {\n\t\t\t*dup = false;\n\t\t\treturn;\n\t\t}\n\t\t*dup = true;\n\t}\n\n\ttopstar_input_notify(topstar, event);\n}\n\nstatic int topstar_acpi_init(struct topstar_laptop *topstar)\n{\n\treturn topstar_acpi_fncx_switch(topstar->device, true);\n}\n\nstatic void topstar_acpi_exit(struct topstar_laptop *topstar)\n{\n\ttopstar_acpi_fncx_switch(topstar->device, false);\n}\n\n \nstatic bool led_workaround;\n\nstatic int dmi_led_workaround(const struct dmi_system_id *id)\n{\n\tled_workaround = true;\n\treturn 0;\n}\n\nstatic const struct dmi_system_id topstar_dmi_ids[] = {\n\t{\n\t\t.callback = dmi_led_workaround,\n\t\t.ident = \"Topstar U931/RVP7\",\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_BOARD_NAME, \"U931\"),\n\t\t\tDMI_MATCH(DMI_BOARD_VERSION, \"RVP7\"),\n\t\t},\n\t},\n\t{}\n};\n\nstatic int topstar_acpi_add(struct acpi_device *device)\n{\n\tstruct topstar_laptop *topstar;\n\tint err;\n\n\tdmi_check_system(topstar_dmi_ids);\n\n\ttopstar = kzalloc(sizeof(struct topstar_laptop), GFP_KERNEL);\n\tif (!topstar)\n\t\treturn -ENOMEM;\n\n\tstrcpy(acpi_device_name(device), \"Topstar TPSACPI\");\n\tstrcpy(acpi_device_class(device), TOPSTAR_LAPTOP_CLASS);\n\tdevice->driver_data = topstar;\n\ttopstar->device = device;\n\n\terr = topstar_acpi_init(topstar);\n\tif (err)\n\t\tgoto err_free;\n\n\terr = topstar_platform_init(topstar);\n\tif (err)\n\t\tgoto err_acpi_exit;\n\n\terr = topstar_input_init(topstar);\n\tif (err)\n\t\tgoto err_platform_exit;\n\n\tif (led_workaround) {\n\t\terr = topstar_led_init(topstar);\n\t\tif (err)\n\t\t\tgoto err_input_exit;\n\t}\n\n\treturn 0;\n\nerr_input_exit:\n\ttopstar_input_exit(topstar);\nerr_platform_exit:\n\ttopstar_platform_exit(topstar);\nerr_acpi_exit:\n\ttopstar_acpi_exit(topstar);\nerr_free:\n\tkfree(topstar);\n\treturn err;\n}\n\nstatic void topstar_acpi_remove(struct acpi_device *device)\n{\n\tstruct topstar_laptop *topstar = acpi_driver_data(device);\n\n\tif (led_workaround)\n\t\ttopstar_led_exit(topstar);\n\n\ttopstar_input_exit(topstar);\n\ttopstar_platform_exit(topstar);\n\ttopstar_acpi_exit(topstar);\n\n\tkfree(topstar);\n}\n\nstatic const struct acpi_device_id topstar_device_ids[] = {\n\t{ \"TPS0001\", 0 },\n\t{ \"TPSACPI01\", 0 },\n\t{ \"\", 0 },\n};\nMODULE_DEVICE_TABLE(acpi, topstar_device_ids);\n\nstatic struct acpi_driver topstar_acpi_driver = {\n\t.name = \"Topstar laptop ACPI driver\",\n\t.class = TOPSTAR_LAPTOP_CLASS,\n\t.ids = topstar_device_ids,\n\t.ops = {\n\t\t.add = topstar_acpi_add,\n\t\t.remove = topstar_acpi_remove,\n\t\t.notify = topstar_acpi_notify,\n\t},\n};\n\nstatic int __init topstar_laptop_init(void)\n{\n\tint ret;\n\n\tret = platform_driver_register(&topstar_platform_driver);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = acpi_bus_register_driver(&topstar_acpi_driver);\n\tif (ret < 0)\n\t\tgoto err_driver_unreg;\n\n\tpr_info(\"ACPI extras driver loaded\\n\");\n\treturn 0;\n\nerr_driver_unreg:\n\tplatform_driver_unregister(&topstar_platform_driver);\n\treturn ret;\n}\n\nstatic void __exit topstar_laptop_exit(void)\n{\n\tacpi_bus_unregister_driver(&topstar_acpi_driver);\n\tplatform_driver_unregister(&topstar_platform_driver);\n}\n\nmodule_init(topstar_laptop_init);\nmodule_exit(topstar_laptop_exit);\n\nMODULE_AUTHOR(\"Herton Ronaldo Krzesinski\");\nMODULE_AUTHOR(\"Guillaume Dou\u00e9zan-Grard\");\nMODULE_DESCRIPTION(\"Topstar Laptop ACPI Extras driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}