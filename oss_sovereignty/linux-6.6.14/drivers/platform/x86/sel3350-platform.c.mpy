{
  "module_name": "sel3350-platform.c",
  "hash_id": "5c0d0395f347621746c943e4c4403d2e7a39be2e981cb2d8d78d33a7a4331ef0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/sel3350-platform.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/gpio/consumer.h>\n#include <linux/gpio/machine.h>\n#include <linux/leds.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/power_supply.h>\n\n \n#define BXT_NW \"INT3452:01\"\n#define BXT_W  \"INT3452:02\"\n#define BXT_SW \"INT3452:03\"\n\n#define B2093_GPIO_ACPI_ID \"SEL0003\"\n\n#define SEL_PS_A        \"sel_ps_a\"\n#define SEL_PS_A_DETECT \"sel_ps_a_detect\"\n#define SEL_PS_A_GOOD   \"sel_ps_a_good\"\n#define SEL_PS_B        \"sel_ps_b\"\n#define SEL_PS_B_DETECT \"sel_ps_b_detect\"\n#define SEL_PS_B_GOOD   \"sel_ps_b_good\"\n\n \nstatic const struct gpio_led sel3350_leds[] = {\n\t{ .name = \"sel:green:aux1\" },\n\t{ .name = \"sel:green:aux2\" },\n\t{ .name = \"sel:green:aux3\" },\n\t{ .name = \"sel:green:aux4\" },\n\t{ .name = \"sel:red:alarm\" },\n\t{ .name = \"sel:green:enabled\",\n\t  .default_state = LEDS_GPIO_DEFSTATE_ON },\n\t{ .name = \"sel:red:aux1\" },\n\t{ .name = \"sel:red:aux2\" },\n\t{ .name = \"sel:red:aux3\" },\n\t{ .name = \"sel:red:aux4\" },\n};\n\nstatic const struct gpio_led_platform_data sel3350_leds_pdata = {\n\t.num_leds = ARRAY_SIZE(sel3350_leds),\n\t.leds = sel3350_leds,\n};\n\n \nstatic struct gpiod_lookup_table sel3350_leds_table = {\n\t.dev_id = \"leds-gpio\",\n\t.table = {\n\t\tGPIO_LOOKUP_IDX(BXT_NW, 49, NULL, 0, GPIO_ACTIVE_HIGH),\n\t\tGPIO_LOOKUP_IDX(BXT_NW, 50, NULL, 1, GPIO_ACTIVE_HIGH),\n\t\tGPIO_LOOKUP_IDX(BXT_NW, 51, NULL, 2, GPIO_ACTIVE_HIGH),\n\t\tGPIO_LOOKUP_IDX(BXT_NW, 52, NULL, 3, GPIO_ACTIVE_HIGH),\n\t\tGPIO_LOOKUP_IDX(BXT_W,  20, NULL, 4, GPIO_ACTIVE_HIGH),\n\t\tGPIO_LOOKUP_IDX(BXT_W,  21, NULL, 5, GPIO_ACTIVE_HIGH),\n\t\tGPIO_LOOKUP_IDX(BXT_SW, 37, NULL, 6, GPIO_ACTIVE_HIGH),\n\t\tGPIO_LOOKUP_IDX(BXT_SW, 38, NULL, 7, GPIO_ACTIVE_HIGH),\n\t\tGPIO_LOOKUP_IDX(BXT_SW, 39, NULL, 8, GPIO_ACTIVE_HIGH),\n\t\tGPIO_LOOKUP_IDX(BXT_SW, 40, NULL, 9, GPIO_ACTIVE_HIGH),\n\t\t{},\n\t}\n};\n\n \nstatic struct gpiod_lookup_table sel3350_gpios_table = {\n\t.dev_id = B2093_GPIO_ACPI_ID \":00\",\n\t.table = {\n\t\tGPIO_LOOKUP(BXT_NW, 44, SEL_PS_A_DETECT, GPIO_ACTIVE_LOW),\n\t\tGPIO_LOOKUP(BXT_NW, 45, SEL_PS_A_GOOD,   GPIO_ACTIVE_LOW),\n\t\tGPIO_LOOKUP(BXT_NW, 46, SEL_PS_B_DETECT, GPIO_ACTIVE_LOW),\n\t\tGPIO_LOOKUP(BXT_NW, 47, SEL_PS_B_GOOD,   GPIO_ACTIVE_LOW),\n\t\t{},\n\t}\n};\n\n \n\nstruct sel3350_power_cfg_data {\n\tstruct gpio_desc *ps_detect;\n\tstruct gpio_desc *ps_good;\n};\n\nstatic int sel3350_power_get_property(struct power_supply *psy,\n\t\t\t\t      enum power_supply_property psp,\n\t\t\t\t      union power_supply_propval *val)\n{\n\tstruct sel3350_power_cfg_data *data = power_supply_get_drvdata(psy);\n\n\tswitch (psp) {\n\tcase POWER_SUPPLY_PROP_HEALTH:\n\t\tif (gpiod_get_value(data->ps_detect)) {\n\t\t\tif (gpiod_get_value(data->ps_good))\n\t\t\t\tval->intval = POWER_SUPPLY_HEALTH_GOOD;\n\t\t\telse\n\t\t\t\tval->intval = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\n\t\t} else {\n\t\t\tval->intval = POWER_SUPPLY_HEALTH_UNKNOWN;\n\t\t}\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_PRESENT:\n\t\tval->intval = gpiod_get_value(data->ps_detect);\n\t\tbreak;\n\tcase POWER_SUPPLY_PROP_ONLINE:\n\t\tval->intval = gpiod_get_value(data->ps_good);\n\t\tbreak;\n\tdefault:\n\t\treturn -EINVAL;\n\t}\n\treturn 0;\n}\n\nstatic const enum power_supply_property sel3350_power_properties[] = {\n\tPOWER_SUPPLY_PROP_HEALTH,\n\tPOWER_SUPPLY_PROP_PRESENT,\n\tPOWER_SUPPLY_PROP_ONLINE,\n};\n\nstatic const struct power_supply_desc sel3350_ps_a_desc = {\n\t.name = SEL_PS_A,\n\t.type = POWER_SUPPLY_TYPE_MAINS,\n\t.properties = sel3350_power_properties,\n\t.num_properties = ARRAY_SIZE(sel3350_power_properties),\n\t.get_property = sel3350_power_get_property,\n};\n\nstatic const struct power_supply_desc sel3350_ps_b_desc = {\n\t.name = SEL_PS_B,\n\t.type = POWER_SUPPLY_TYPE_MAINS,\n\t.properties = sel3350_power_properties,\n\t.num_properties = ARRAY_SIZE(sel3350_power_properties),\n\t.get_property = sel3350_power_get_property,\n};\n\nstruct sel3350_data {\n\tstruct platform_device *leds_pdev;\n\tstruct power_supply *ps_a;\n\tstruct power_supply *ps_b;\n\tstruct sel3350_power_cfg_data ps_a_cfg_data;\n\tstruct sel3350_power_cfg_data ps_b_cfg_data;\n};\n\nstatic int sel3350_probe(struct platform_device *pdev)\n{\n\tint rs;\n\tstruct sel3350_data *sel3350;\n\tstruct power_supply_config ps_cfg = {};\n\n\tsel3350 = devm_kzalloc(&pdev->dev, sizeof(struct sel3350_data), GFP_KERNEL);\n\tif (!sel3350)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, sel3350);\n\n\tgpiod_add_lookup_table(&sel3350_leds_table);\n\tgpiod_add_lookup_table(&sel3350_gpios_table);\n\n\tsel3350->leds_pdev = platform_device_register_data(\n\t\t\tNULL,\n\t\t\t\"leds-gpio\",\n\t\t\tPLATFORM_DEVID_NONE,\n\t\t\t&sel3350_leds_pdata,\n\t\t\tsizeof(sel3350_leds_pdata));\n\tif (IS_ERR(sel3350->leds_pdev)) {\n\t\trs = PTR_ERR(sel3350->leds_pdev);\n\t\tdev_err(&pdev->dev, \"Failed registering platform device: %d\\n\", rs);\n\t\tgoto err_platform;\n\t}\n\n\t \n\tsel3350->ps_a_cfg_data.ps_detect = devm_gpiod_get(&pdev->dev,\n\t\t\t\t\t\t\t  SEL_PS_A_DETECT,\n\t\t\t\t\t\t\t  GPIOD_IN);\n\tsel3350->ps_a_cfg_data.ps_good = devm_gpiod_get(&pdev->dev,\n\t\t\t\t\t\t\tSEL_PS_A_GOOD,\n\t\t\t\t\t\t\tGPIOD_IN);\n\tps_cfg.drv_data = &sel3350->ps_a_cfg_data;\n\tsel3350->ps_a = devm_power_supply_register(&pdev->dev,\n\t\t\t\t\t\t   &sel3350_ps_a_desc,\n\t\t\t\t\t\t   &ps_cfg);\n\tif (IS_ERR(sel3350->ps_a)) {\n\t\trs = PTR_ERR(sel3350->ps_a);\n\t\tdev_err(&pdev->dev, \"Failed registering power supply A: %d\\n\", rs);\n\t\tgoto err_ps;\n\t}\n\n\t \n\tsel3350->ps_b_cfg_data.ps_detect = devm_gpiod_get(&pdev->dev,\n\t\t\t\t\t\t\t  SEL_PS_B_DETECT,\n\t\t\t\t\t\t\t  GPIOD_IN);\n\tsel3350->ps_b_cfg_data.ps_good = devm_gpiod_get(&pdev->dev,\n\t\t\t\t\t\t\tSEL_PS_B_GOOD,\n\t\t\t\t\t\t\tGPIOD_IN);\n\tps_cfg.drv_data = &sel3350->ps_b_cfg_data;\n\tsel3350->ps_b = devm_power_supply_register(&pdev->dev,\n\t\t\t\t\t\t   &sel3350_ps_b_desc,\n\t\t\t\t\t\t   &ps_cfg);\n\tif (IS_ERR(sel3350->ps_b)) {\n\t\trs = PTR_ERR(sel3350->ps_b);\n\t\tdev_err(&pdev->dev, \"Failed registering power supply B: %d\\n\", rs);\n\t\tgoto err_ps;\n\t}\n\n\treturn 0;\n\nerr_ps:\n\tplatform_device_unregister(sel3350->leds_pdev);\nerr_platform:\n\tgpiod_remove_lookup_table(&sel3350_gpios_table);\n\tgpiod_remove_lookup_table(&sel3350_leds_table);\n\n\treturn rs;\n}\n\nstatic int sel3350_remove(struct platform_device *pdev)\n{\n\tstruct sel3350_data *sel3350 = platform_get_drvdata(pdev);\n\n\tplatform_device_unregister(sel3350->leds_pdev);\n\tgpiod_remove_lookup_table(&sel3350_gpios_table);\n\tgpiod_remove_lookup_table(&sel3350_leds_table);\n\n\treturn 0;\n}\n\nstatic const struct acpi_device_id sel3350_device_ids[] = {\n\t{ B2093_GPIO_ACPI_ID, 0 },\n\t{ \"\", 0 },\n};\nMODULE_DEVICE_TABLE(acpi, sel3350_device_ids);\n\nstatic struct platform_driver sel3350_platform_driver = {\n\t.probe = sel3350_probe,\n\t.remove = sel3350_remove,\n\t.driver = {\n\t\t.name = \"sel3350-platform\",\n\t\t.acpi_match_table = sel3350_device_ids,\n\t},\n};\nmodule_platform_driver(sel3350_platform_driver);\n\nMODULE_AUTHOR(\"Schweitzer Engineering Laboratories\");\nMODULE_DESCRIPTION(\"SEL-3350 platform driver\");\nMODULE_LICENSE(\"Dual BSD/GPL\");\nMODULE_SOFTDEP(\"pre: pinctrl_broxton leds-gpio\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}