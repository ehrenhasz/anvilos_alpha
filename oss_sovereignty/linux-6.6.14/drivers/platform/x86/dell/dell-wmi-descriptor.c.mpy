{
  "module_name": "dell-wmi-descriptor.c",
  "hash_id": "9052241d2d954eca6d81c56daf82cba4c35214d466c010989b94df81ddc5995a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/dell/dell-wmi-descriptor.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/acpi.h>\n#include <linux/list.h>\n#include <linux/module.h>\n#include <linux/wmi.h>\n#include \"dell-wmi-descriptor.h\"\n\n#define DELL_WMI_DESCRIPTOR_GUID \"8D9DDCBC-A997-11DA-B012-B622A1EF5492\"\n\nstruct descriptor_priv {\n\tstruct list_head list;\n\tu32 interface_version;\n\tu32 size;\n\tu32 hotfix;\n};\nstatic int descriptor_valid = -EPROBE_DEFER;\nstatic LIST_HEAD(wmi_list);\nstatic DEFINE_MUTEX(list_mutex);\n\nint dell_wmi_get_descriptor_valid(void)\n{\n\tif (!wmi_has_guid(DELL_WMI_DESCRIPTOR_GUID))\n\t\treturn -ENODEV;\n\n\treturn descriptor_valid;\n}\nEXPORT_SYMBOL_GPL(dell_wmi_get_descriptor_valid);\n\nbool dell_wmi_get_interface_version(u32 *version)\n{\n\tstruct descriptor_priv *priv;\n\tbool ret = false;\n\n\tmutex_lock(&list_mutex);\n\tpriv = list_first_entry_or_null(&wmi_list,\n\t\t\t\t\tstruct descriptor_priv,\n\t\t\t\t\tlist);\n\tif (priv) {\n\t\t*version = priv->interface_version;\n\t\tret = true;\n\t}\n\tmutex_unlock(&list_mutex);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(dell_wmi_get_interface_version);\n\nbool dell_wmi_get_size(u32 *size)\n{\n\tstruct descriptor_priv *priv;\n\tbool ret = false;\n\n\tmutex_lock(&list_mutex);\n\tpriv = list_first_entry_or_null(&wmi_list,\n\t\t\t\t\tstruct descriptor_priv,\n\t\t\t\t\tlist);\n\tif (priv) {\n\t\t*size = priv->size;\n\t\tret = true;\n\t}\n\tmutex_unlock(&list_mutex);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(dell_wmi_get_size);\n\nbool dell_wmi_get_hotfix(u32 *hotfix)\n{\n\tstruct descriptor_priv *priv;\n\tbool ret = false;\n\n\tmutex_lock(&list_mutex);\n\tpriv = list_first_entry_or_null(&wmi_list,\n\t\t\t\t\tstruct descriptor_priv,\n\t\t\t\t\tlist);\n\tif (priv) {\n\t\t*hotfix = priv->hotfix;\n\t\tret = true;\n\t}\n\tmutex_unlock(&list_mutex);\n\treturn ret;\n}\nEXPORT_SYMBOL_GPL(dell_wmi_get_hotfix);\n\n \nstatic int dell_wmi_descriptor_probe(struct wmi_device *wdev,\n\t\t\t\t     const void *context)\n{\n\tunion acpi_object *obj = NULL;\n\tstruct descriptor_priv *priv;\n\tu32 *buffer;\n\tint ret;\n\n\tobj = wmidev_block_query(wdev, 0);\n\tif (!obj) {\n\t\tdev_err(&wdev->dev, \"failed to read Dell WMI descriptor\\n\");\n\t\tret = -EIO;\n\t\tgoto out;\n\t}\n\n\tif (obj->type != ACPI_TYPE_BUFFER) {\n\t\tdev_err(&wdev->dev, \"Dell descriptor has wrong type\\n\");\n\t\tret = -EINVAL;\n\t\tdescriptor_valid = ret;\n\t\tgoto out;\n\t}\n\n\t \n\tif (obj->buffer.length != 128) {\n\t\tdev_err(&wdev->dev,\n\t\t\t\"Dell descriptor buffer has unexpected length (%d)\\n\",\n\t\t\tobj->buffer.length);\n\t\tret = -EINVAL;\n\t\tdescriptor_valid = ret;\n\t\tgoto out;\n\t}\n\n\tbuffer = (u32 *)obj->buffer.pointer;\n\n\tif (strncmp(obj->string.pointer, \"DELL WMI\", 8) != 0) {\n\t\tdev_err(&wdev->dev, \"Dell descriptor buffer has invalid signature (%8ph)\\n\",\n\t\t\tbuffer);\n\t\tret = -EINVAL;\n\t\tdescriptor_valid = ret;\n\t\tgoto out;\n\t}\n\tdescriptor_valid = 0;\n\n\tif (buffer[2] != 0 && buffer[2] != 1)\n\t\tdev_warn(&wdev->dev, \"Dell descriptor buffer has unknown version (%lu)\\n\",\n\t\t\t(unsigned long) buffer[2]);\n\n\tpriv = devm_kzalloc(&wdev->dev, sizeof(struct descriptor_priv),\n\tGFP_KERNEL);\n\n\tif (!priv) {\n\t\tret = -ENOMEM;\n\t\tgoto out;\n\t}\n\n\tpriv->interface_version = buffer[2];\n\tpriv->size = buffer[3];\n\tpriv->hotfix = buffer[4];\n\tret = 0;\n\tdev_set_drvdata(&wdev->dev, priv);\n\tmutex_lock(&list_mutex);\n\tlist_add_tail(&priv->list, &wmi_list);\n\tmutex_unlock(&list_mutex);\n\n\tdev_dbg(&wdev->dev, \"Detected Dell WMI interface version %lu, buffer size %lu, hotfix %lu\\n\",\n\t\t(unsigned long) priv->interface_version,\n\t\t(unsigned long) priv->size,\n\t\t(unsigned long) priv->hotfix);\n\nout:\n\tkfree(obj);\n\treturn ret;\n}\n\nstatic void dell_wmi_descriptor_remove(struct wmi_device *wdev)\n{\n\tstruct descriptor_priv *priv = dev_get_drvdata(&wdev->dev);\n\n\tmutex_lock(&list_mutex);\n\tlist_del(&priv->list);\n\tmutex_unlock(&list_mutex);\n}\n\nstatic const struct wmi_device_id dell_wmi_descriptor_id_table[] = {\n\t{ .guid_string = DELL_WMI_DESCRIPTOR_GUID },\n\t{ },\n};\n\nstatic struct wmi_driver dell_wmi_descriptor_driver = {\n\t.driver = {\n\t\t.name = \"dell-wmi-descriptor\",\n\t},\n\t.probe = dell_wmi_descriptor_probe,\n\t.remove = dell_wmi_descriptor_remove,\n\t.id_table = dell_wmi_descriptor_id_table,\n};\n\nmodule_wmi_driver(dell_wmi_descriptor_driver);\n\nMODULE_DEVICE_TABLE(wmi, dell_wmi_descriptor_id_table);\nMODULE_AUTHOR(\"Mario Limonciello <mario.limonciello@outlook.com>\");\nMODULE_DESCRIPTION(\"Dell WMI descriptor driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}