{
  "module_name": "dell-wmi-aio.c",
  "hash_id": "22c231ce4f3766c1455d9fe10fa2b40ccbad6e865a1fee101ee358d3502511d0",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/dell/dell-wmi-aio.c",
  "human_readable_source": "\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/init.h>\n#include <linux/types.h>\n#include <linux/input.h>\n#include <linux/input/sparse-keymap.h>\n#include <linux/acpi.h>\n#include <linux/string.h>\n\nMODULE_DESCRIPTION(\"WMI hotkeys driver for Dell All-In-One series\");\nMODULE_LICENSE(\"GPL\");\n\n#define EVENT_GUID1 \"284A0E6B-380E-472A-921F-E52786257FB4\"\n#define EVENT_GUID2 \"02314822-307C-4F66-BF0E-48AEAEB26CC8\"\n\nstruct dell_wmi_event {\n\tu16\tlength;\n\t \n\tu16\ttype;\n\tu16\tevent[];\n};\n\nstatic const char *dell_wmi_aio_guids[] = {\n\tEVENT_GUID1,\n\tEVENT_GUID2,\n\tNULL\n};\n\nMODULE_ALIAS(\"wmi:\"EVENT_GUID1);\nMODULE_ALIAS(\"wmi:\"EVENT_GUID2);\n\nstatic const struct key_entry dell_wmi_aio_keymap[] = {\n\t{ KE_KEY, 0xc0, { KEY_VOLUMEUP } },\n\t{ KE_KEY, 0xc1, { KEY_VOLUMEDOWN } },\n\t{ KE_KEY, 0xe030, { KEY_VOLUMEUP } },\n\t{ KE_KEY, 0xe02e, { KEY_VOLUMEDOWN } },\n\t{ KE_KEY, 0xe020, { KEY_MUTE } },\n\t{ KE_KEY, 0xe027, { KEY_DISPLAYTOGGLE } },\n\t{ KE_KEY, 0xe006, { KEY_BRIGHTNESSUP } },\n\t{ KE_KEY, 0xe005, { KEY_BRIGHTNESSDOWN } },\n\t{ KE_KEY, 0xe00b, { KEY_SWITCHVIDEOMODE } },\n\t{ KE_END, 0 }\n};\n\nstatic struct input_dev *dell_wmi_aio_input_dev;\n\n \nstatic bool dell_wmi_aio_event_check(u8 *buffer, int length)\n{\n\tstruct dell_wmi_event *event = (struct dell_wmi_event *)buffer;\n\n\tif (event == NULL || length < 6)\n\t\treturn false;\n\n\tif ((event->type == 0 || event->type == 0xf) &&\n\t\t\tevent->length >= 2)\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic void dell_wmi_aio_notify(u32 value, void *context)\n{\n\tstruct acpi_buffer response = { ACPI_ALLOCATE_BUFFER, NULL };\n\tunion acpi_object *obj;\n\tstruct dell_wmi_event *event;\n\tacpi_status status;\n\n\tstatus = wmi_get_event_data(value, &response);\n\tif (status != AE_OK) {\n\t\tpr_info(\"bad event status 0x%x\\n\", status);\n\t\treturn;\n\t}\n\n\tobj = (union acpi_object *)response.pointer;\n\tif (obj) {\n\t\tunsigned int scancode = 0;\n\n\t\tswitch (obj->type) {\n\t\tcase ACPI_TYPE_INTEGER:\n\t\t\t \n\t\t\tscancode = obj->integer.value;\n\t\t\tsparse_keymap_report_event(dell_wmi_aio_input_dev,\n\t\t\t\tscancode, 1, true);\n\t\t\tbreak;\n\t\tcase ACPI_TYPE_BUFFER:\n\t\t\tif (dell_wmi_aio_event_check(obj->buffer.pointer,\n\t\t\t\t\t\tobj->buffer.length)) {\n\t\t\t\tevent = (struct dell_wmi_event *)\n\t\t\t\t\tobj->buffer.pointer;\n\t\t\t\tscancode = event->event[0];\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\tif (obj->buffer.pointer &&\n\t\t\t\t\t\tobj->buffer.length > 0)\n\t\t\t\t\tscancode = obj->buffer.pointer[0];\n\t\t\t}\n\t\t\tif (scancode)\n\t\t\t\tsparse_keymap_report_event(\n\t\t\t\t\tdell_wmi_aio_input_dev,\n\t\t\t\t\tscancode, 1, true);\n\t\t\tbreak;\n\t\t}\n\t}\n\tkfree(obj);\n}\n\nstatic int __init dell_wmi_aio_input_setup(void)\n{\n\tint err;\n\n\tdell_wmi_aio_input_dev = input_allocate_device();\n\n\tif (!dell_wmi_aio_input_dev)\n\t\treturn -ENOMEM;\n\n\tdell_wmi_aio_input_dev->name = \"Dell AIO WMI hotkeys\";\n\tdell_wmi_aio_input_dev->phys = \"wmi/input0\";\n\tdell_wmi_aio_input_dev->id.bustype = BUS_HOST;\n\n\terr = sparse_keymap_setup(dell_wmi_aio_input_dev,\n\t\t\tdell_wmi_aio_keymap, NULL);\n\tif (err) {\n\t\tpr_err(\"Unable to setup input device keymap\\n\");\n\t\tgoto err_free_dev;\n\t}\n\terr = input_register_device(dell_wmi_aio_input_dev);\n\tif (err) {\n\t\tpr_info(\"Unable to register input device\\n\");\n\t\tgoto err_free_dev;\n\t}\n\treturn 0;\n\nerr_free_dev:\n\tinput_free_device(dell_wmi_aio_input_dev);\n\treturn err;\n}\n\nstatic const char *dell_wmi_aio_find(void)\n{\n\tint i;\n\n\tfor (i = 0; dell_wmi_aio_guids[i] != NULL; i++)\n\t\tif (wmi_has_guid(dell_wmi_aio_guids[i]))\n\t\t\treturn dell_wmi_aio_guids[i];\n\n\treturn NULL;\n}\n\nstatic int __init dell_wmi_aio_init(void)\n{\n\tint err;\n\tconst char *guid;\n\n\tguid = dell_wmi_aio_find();\n\tif (!guid) {\n\t\tpr_warn(\"No known WMI GUID found\\n\");\n\t\treturn -ENXIO;\n\t}\n\n\terr = dell_wmi_aio_input_setup();\n\tif (err)\n\t\treturn err;\n\n\terr = wmi_install_notify_handler(guid, dell_wmi_aio_notify, NULL);\n\tif (err) {\n\t\tpr_err(\"Unable to register notify handler - %d\\n\", err);\n\t\tinput_unregister_device(dell_wmi_aio_input_dev);\n\t\treturn err;\n\t}\n\n\treturn 0;\n}\n\nstatic void __exit dell_wmi_aio_exit(void)\n{\n\tconst char *guid;\n\n\tguid = dell_wmi_aio_find();\n\twmi_remove_notify_handler(guid);\n\tinput_unregister_device(dell_wmi_aio_input_dev);\n}\n\nmodule_init(dell_wmi_aio_init);\nmodule_exit(dell_wmi_aio_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}