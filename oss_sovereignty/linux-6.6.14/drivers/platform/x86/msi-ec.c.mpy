{
  "module_name": "msi-ec.c",
  "hash_id": "5e112857cab20dfc11ef3affc7bba2c87951c114978be9736edec54cd571621d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/x86/msi-ec.c",
  "human_readable_source": "\n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include \"msi-ec.h\"\n\n#include <acpi/battery.h>\n#include <linux/acpi.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/seq_file.h>\n#include <linux/string.h>\n\n#define SM_ECO_NAME\t\t\"eco\"\n#define SM_COMFORT_NAME\t\t\"comfort\"\n#define SM_SPORT_NAME\t\t\"sport\"\n#define SM_TURBO_NAME\t\t\"turbo\"\n\n#define FM_AUTO_NAME\t\t\"auto\"\n#define FM_SILENT_NAME\t\t\"silent\"\n#define FM_BASIC_NAME\t\t\"basic\"\n#define FM_ADVANCED_NAME\t\"advanced\"\n\nstatic const char * const ALLOWED_FW_0[] __initconst = {\n\t\"14C1EMS1.012\",\n\t\"14C1EMS1.101\",\n\t\"14C1EMS1.102\",\n\tNULL\n};\n\nstatic struct msi_ec_conf CONF0 __initdata = {\n\t.allowed_fw = ALLOWED_FW_0,\n\t.charge_control = {\n\t\t.address      = 0xef,\n\t\t.offset_start = 0x8a,\n\t\t.offset_end   = 0x80,\n\t\t.range_min    = 0x8a,\n\t\t.range_max    = 0xe4,\n\t},\n\t.webcam = {\n\t\t.address       = 0x2e,\n\t\t.block_address = 0x2f,\n\t\t.bit           = 1,\n\t},\n\t.fn_super_swap = {\n\t\t.address = 0xbf,\n\t\t.bit     = 4,\n\t},\n\t.cooler_boost = {\n\t\t.address = 0x98,\n\t\t.bit     = 7,\n\t},\n\t.shift_mode = {\n\t\t.address = 0xf2,\n\t\t.modes = {\n\t\t\t{ SM_ECO_NAME,     0xc2 },\n\t\t\t{ SM_COMFORT_NAME, 0xc1 },\n\t\t\t{ SM_SPORT_NAME,   0xc0 },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.super_battery = {\n\t\t.address = MSI_EC_ADDR_UNKNOWN, \n\t},\n\t.fan_mode = {\n\t\t.address = 0xf4,\n\t\t.modes = {\n\t\t\t{ FM_AUTO_NAME,     0x0d },\n\t\t\t{ FM_SILENT_NAME,   0x1d },\n\t\t\t{ FM_BASIC_NAME,    0x4d },\n\t\t\t{ FM_ADVANCED_NAME, 0x8d },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.cpu = {\n\t\t.rt_temp_address       = 0x68,\n\t\t.rt_fan_speed_address  = 0x71,\n\t\t.rt_fan_speed_base_min = 0x19,\n\t\t.rt_fan_speed_base_max = 0x37,\n\t\t.bs_fan_speed_address  = 0x89,\n\t\t.bs_fan_speed_base_min = 0x00,\n\t\t.bs_fan_speed_base_max = 0x0f,\n\t},\n\t.gpu = {\n\t\t.rt_temp_address      = 0x80,\n\t\t.rt_fan_speed_address = 0x89,\n\t},\n\t.leds = {\n\t\t.micmute_led_address = 0x2b,\n\t\t.mute_led_address    = 0x2c,\n\t\t.bit                 = 2,\n\t},\n\t.kbd_bl = {\n\t\t.bl_mode_address  = 0x2c, \n\t\t.bl_modes         = { 0x00, 0x08 }, \n\t\t.max_mode         = 1, \n\t\t.bl_state_address = 0xf3,\n\t\t.state_base_value = 0x80,\n\t\t.max_state        = 3,\n\t},\n};\n\nstatic const char * const ALLOWED_FW_1[] __initconst = {\n\t\"17F2EMS1.103\",\n\t\"17F2EMS1.104\",\n\t\"17F2EMS1.106\",\n\t\"17F2EMS1.107\",\n\tNULL\n};\n\nstatic struct msi_ec_conf CONF1 __initdata = {\n\t.allowed_fw = ALLOWED_FW_1,\n\t.charge_control = {\n\t\t.address      = 0xef,\n\t\t.offset_start = 0x8a,\n\t\t.offset_end   = 0x80,\n\t\t.range_min    = 0x8a,\n\t\t.range_max    = 0xe4,\n\t},\n\t.webcam = {\n\t\t.address       = 0x2e,\n\t\t.block_address = 0x2f,\n\t\t.bit           = 1,\n\t},\n\t.fn_super_swap = {\n\t\t.address = 0xbf,\n\t\t.bit     = 4,\n\t},\n\t.cooler_boost = {\n\t\t.address = 0x98,\n\t\t.bit     = 7,\n\t},\n\t.shift_mode = {\n\t\t.address = 0xf2,\n\t\t.modes = {\n\t\t\t{ SM_ECO_NAME,     0xc2 },\n\t\t\t{ SM_COMFORT_NAME, 0xc1 },\n\t\t\t{ SM_SPORT_NAME,   0xc0 },\n\t\t\t{ SM_TURBO_NAME,   0xc4 },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.super_battery = {\n\t\t.address = MSI_EC_ADDR_UNKNOWN,\n\t},\n\t.fan_mode = {\n\t\t.address = 0xf4,\n\t\t.modes = {\n\t\t\t{ FM_AUTO_NAME,     0x0d },\n\t\t\t{ FM_BASIC_NAME,    0x4d },\n\t\t\t{ FM_ADVANCED_NAME, 0x8d },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.cpu = {\n\t\t.rt_temp_address       = 0x68,\n\t\t.rt_fan_speed_address  = 0x71,\n\t\t.rt_fan_speed_base_min = 0x19,\n\t\t.rt_fan_speed_base_max = 0x37,\n\t\t.bs_fan_speed_address  = 0x89,\n\t\t.bs_fan_speed_base_min = 0x00,\n\t\t.bs_fan_speed_base_max = 0x0f,\n\t},\n\t.gpu = {\n\t\t.rt_temp_address      = 0x80,\n\t\t.rt_fan_speed_address = 0x89,\n\t},\n\t.leds = {\n\t\t.micmute_led_address = 0x2b,\n\t\t.mute_led_address    = 0x2c,\n\t\t.bit                 = 2,\n\t},\n\t.kbd_bl = {\n\t\t.bl_mode_address  = 0x2c, \n\t\t.bl_modes         = { 0x00, 0x08 }, \n\t\t.max_mode         = 1, \n\t\t.bl_state_address = 0xf3,\n\t\t.state_base_value = 0x80,\n\t\t.max_state        = 3,\n\t},\n};\n\nstatic const char * const ALLOWED_FW_2[] __initconst = {\n\t\"1552EMS1.118\",\n\tNULL\n};\n\nstatic struct msi_ec_conf CONF2 __initdata = {\n\t.allowed_fw = ALLOWED_FW_2,\n\t.charge_control = {\n\t\t.address      = 0xd7,\n\t\t.offset_start = 0x8a,\n\t\t.offset_end   = 0x80,\n\t\t.range_min    = 0x8a,\n\t\t.range_max    = 0xe4,\n\t},\n\t.webcam = {\n\t\t.address       = 0x2e,\n\t\t.block_address = 0x2f,\n\t\t.bit           = 1,\n\t},\n\t.fn_super_swap = {\n\t\t.address = 0xe8,\n\t\t.bit     = 4,\n\t},\n\t.cooler_boost = {\n\t\t.address = 0x98,\n\t\t.bit     = 7,\n\t},\n\t.shift_mode = {\n\t\t.address = 0xf2,\n\t\t.modes = {\n\t\t\t{ SM_ECO_NAME,     0xc2 },\n\t\t\t{ SM_COMFORT_NAME, 0xc1 },\n\t\t\t{ SM_SPORT_NAME,   0xc0 },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.super_battery = {\n\t\t.address = 0xeb,\n\t\t.mask    = 0x0f,\n\t},\n\t.fan_mode = {\n\t\t.address = 0xd4,\n\t\t.modes = {\n\t\t\t{ FM_AUTO_NAME,     0x0d },\n\t\t\t{ FM_SILENT_NAME,   0x1d },\n\t\t\t{ FM_BASIC_NAME,    0x4d },\n\t\t\t{ FM_ADVANCED_NAME, 0x8d },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.cpu = {\n\t\t.rt_temp_address       = 0x68,\n\t\t.rt_fan_speed_address  = 0x71,\n\t\t.rt_fan_speed_base_min = 0x19,\n\t\t.rt_fan_speed_base_max = 0x37,\n\t\t.bs_fan_speed_address  = 0x89,\n\t\t.bs_fan_speed_base_min = 0x00,\n\t\t.bs_fan_speed_base_max = 0x0f,\n\t},\n\t.gpu = {\n\t\t.rt_temp_address      = 0x80,\n\t\t.rt_fan_speed_address = 0x89,\n\t},\n\t.leds = {\n\t\t.micmute_led_address = 0x2c,\n\t\t.mute_led_address    = 0x2d,\n\t\t.bit                 = 1,\n\t},\n\t.kbd_bl = {\n\t\t.bl_mode_address  = 0x2c, \n\t\t.bl_modes         = { 0x00, 0x08 }, \n\t\t.max_mode         = 1, \n\t\t.bl_state_address = 0xd3,\n\t\t.state_base_value = 0x80,\n\t\t.max_state        = 3,\n\t},\n};\n\nstatic const char * const ALLOWED_FW_3[] __initconst = {\n\t\"1592EMS1.111\",\n\tNULL\n};\n\nstatic struct msi_ec_conf CONF3 __initdata = {\n\t.allowed_fw = ALLOWED_FW_3,\n\t.charge_control = {\n\t\t.address      = 0xd7,\n\t\t.offset_start = 0x8a,\n\t\t.offset_end   = 0x80,\n\t\t.range_min    = 0x8a,\n\t\t.range_max    = 0xe4,\n\t},\n\t.webcam = {\n\t\t.address       = 0x2e,\n\t\t.block_address = 0x2f,\n\t\t.bit           = 1,\n\t},\n\t.fn_super_swap = {\n\t\t.address = 0xe8,\n\t\t.bit     = 4,\n\t},\n\t.cooler_boost = {\n\t\t.address = 0x98,\n\t\t.bit     = 7,\n\t},\n\t.shift_mode = {\n\t\t.address = 0xd2,\n\t\t.modes = {\n\t\t\t{ SM_ECO_NAME,     0xc2 },\n\t\t\t{ SM_COMFORT_NAME, 0xc1 },\n\t\t\t{ SM_SPORT_NAME,   0xc0 },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.super_battery = {\n\t\t.address = 0xeb,\n\t\t.mask    = 0x0f,\n\t},\n\t.fan_mode = {\n\t\t.address = 0xd4,\n\t\t.modes = {\n\t\t\t{ FM_AUTO_NAME,     0x0d },\n\t\t\t{ FM_SILENT_NAME,   0x1d },\n\t\t\t{ FM_BASIC_NAME,    0x4d },\n\t\t\t{ FM_ADVANCED_NAME, 0x8d },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.cpu = {\n\t\t.rt_temp_address       = 0x68,\n\t\t.rt_fan_speed_address  = 0xc9,\n\t\t.rt_fan_speed_base_min = 0x19,\n\t\t.rt_fan_speed_base_max = 0x37,\n\t\t.bs_fan_speed_address  = 0x89, \n\t\t.bs_fan_speed_base_min = 0x00,\n\t\t.bs_fan_speed_base_max = 0x0f,\n\t},\n\t.gpu = {\n\t\t.rt_temp_address      = 0x80,\n\t\t.rt_fan_speed_address = 0x89,\n\t},\n\t.leds = {\n\t\t.micmute_led_address = 0x2b,\n\t\t.mute_led_address    = 0x2c,\n\t\t.bit                 = 1,\n\t},\n\t.kbd_bl = {\n\t\t.bl_mode_address  = 0x2c, \n\t\t.bl_modes         = { 0x00, 0x08 }, \n\t\t.max_mode         = 1, \n\t\t.bl_state_address = 0xd3,\n\t\t.state_base_value = 0x80,\n\t\t.max_state        = 3,\n\t},\n};\n\nstatic const char * const ALLOWED_FW_4[] __initconst = {\n\t\"16V4EMS1.114\",\n\tNULL\n};\n\nstatic struct msi_ec_conf CONF4 __initdata = {\n\t.allowed_fw = ALLOWED_FW_4,\n\t.charge_control = {\n\t\t.address      = 0xd7,\n\t\t.offset_start = 0x8a,\n\t\t.offset_end   = 0x80,\n\t\t.range_min    = 0x8a,\n\t\t.range_max    = 0xe4,\n\t},\n\t.webcam = {\n\t\t.address       = 0x2e,\n\t\t.block_address = 0x2f,\n\t\t.bit           = 1,\n\t},\n\t.fn_super_swap = {\n\t\t.address = MSI_EC_ADDR_UNKNOWN, \n\t\t.bit     = 4,\n\t},\n\t.cooler_boost = {\n\t\t.address = 0x98,\n\t\t.bit     = 7,\n\t},\n\t.shift_mode = {\n\t\t.address = 0xd2,\n\t\t.modes = {\n\t\t\t{ SM_ECO_NAME,     0xc2 },\n\t\t\t{ SM_COMFORT_NAME, 0xc1 },\n\t\t\t{ SM_SPORT_NAME,   0xc0 },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.super_battery = { \n\t\t.address = MSI_EC_ADDR_UNKNOWN,\n\t\t.mask    = 0x0f,\n\t},\n\t.fan_mode = {\n\t\t.address = 0xd4,\n\t\t.modes = {\n\t\t\t{ FM_AUTO_NAME,     0x0d },\n\t\t\t{ FM_SILENT_NAME,   0x1d },\n\t\t\t{ FM_ADVANCED_NAME, 0x8d },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.cpu = {\n\t\t.rt_temp_address       = 0x68, \n\t\t.rt_fan_speed_address  = 0x71, \n\t\t.rt_fan_speed_base_min = 0x19,\n\t\t.rt_fan_speed_base_max = 0x37,\n\t\t.bs_fan_speed_address  = MSI_EC_ADDR_UNKNOWN,\n\t\t.bs_fan_speed_base_min = 0x00,\n\t\t.bs_fan_speed_base_max = 0x0f,\n\t},\n\t.gpu = {\n\t\t.rt_temp_address      = 0x80,\n\t\t.rt_fan_speed_address = MSI_EC_ADDR_UNKNOWN,\n\t},\n\t.leds = {\n\t\t.micmute_led_address = MSI_EC_ADDR_UNKNOWN,\n\t\t.mute_led_address    = MSI_EC_ADDR_UNKNOWN,\n\t\t.bit                 = 1,\n\t},\n\t.kbd_bl = {\n\t\t.bl_mode_address  = MSI_EC_ADDR_UNKNOWN, \n\t\t.bl_modes         = { 0x00, 0x08 }, \n\t\t.max_mode         = 1, \n\t\t.bl_state_address = MSI_EC_ADDR_UNSUPP, \n\t\t.state_base_value = 0x80,\n\t\t.max_state        = 3,\n\t},\n};\n\nstatic const char * const ALLOWED_FW_5[] __initconst = {\n\t\"158LEMS1.103\",\n\t\"158LEMS1.105\",\n\t\"158LEMS1.106\",\n\tNULL\n};\n\nstatic struct msi_ec_conf CONF5 __initdata = {\n\t.allowed_fw = ALLOWED_FW_5,\n\t.charge_control = {\n\t\t.address      = 0xef,\n\t\t.offset_start = 0x8a,\n\t\t.offset_end   = 0x80,\n\t\t.range_min    = 0x8a,\n\t\t.range_max    = 0xe4,\n\t},\n\t.webcam = {\n\t\t.address       = 0x2e,\n\t\t.block_address = 0x2f,\n\t\t.bit           = 1,\n\t},\n\t.fn_super_swap = { \n\t\t.address = 0xbf,\n\t\t.bit     = 4,\n\t},\n\t.cooler_boost = {\n\t\t.address = 0x98,\n\t\t.bit     = 7,\n\t},\n\t.shift_mode = {\n\t\t.address = 0xf2,\n\t\t.modes = {\n\t\t\t{ SM_ECO_NAME,     0xc2 },\n\t\t\t{ SM_COMFORT_NAME, 0xc1 },\n\t\t\t{ SM_TURBO_NAME,   0xc4 },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.super_battery = { \n\t\t.address = MSI_EC_ADDR_UNKNOWN,\n\t\t.mask    = 0x0f,\n\t},\n\t.fan_mode = {\n\t\t.address = 0xf4,\n\t\t.modes = {\n\t\t\t{ FM_AUTO_NAME,     0x0d },\n\t\t\t{ FM_SILENT_NAME,   0x1d },\n\t\t\t{ FM_ADVANCED_NAME, 0x8d },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.cpu = {\n\t\t.rt_temp_address       = 0x68, \n\t\t.rt_fan_speed_address  = 0x71, \n\t\t.rt_fan_speed_base_min = 0x19,\n\t\t.rt_fan_speed_base_max = 0x37,\n\t\t.bs_fan_speed_address  = MSI_EC_ADDR_UNSUPP,\n\t\t.bs_fan_speed_base_min = 0x00,\n\t\t.bs_fan_speed_base_max = 0x0f,\n\t},\n\t.gpu = {\n\t\t.rt_temp_address      = MSI_EC_ADDR_UNKNOWN,\n\t\t.rt_fan_speed_address = MSI_EC_ADDR_UNKNOWN,\n\t},\n\t.leds = {\n\t\t.micmute_led_address = 0x2b,\n\t\t.mute_led_address    = 0x2c,\n\t\t.bit                 = 2,\n\t},\n\t.kbd_bl = {\n\t\t.bl_mode_address  = MSI_EC_ADDR_UNKNOWN, \n\t\t.bl_modes         = { 0x00, 0x08 }, \n\t\t.max_mode         = 1, \n\t\t.bl_state_address = MSI_EC_ADDR_UNSUPP, \n\t\t.state_base_value = 0x80,\n\t\t.max_state        = 3,\n\t},\n};\n\nstatic const char * const ALLOWED_FW_6[] __initconst = {\n\t\"1542EMS1.102\",\n\t\"1542EMS1.104\",\n\tNULL\n};\n\nstatic struct msi_ec_conf CONF6 __initdata = {\n\t.allowed_fw = ALLOWED_FW_6,\n\t.charge_control = {\n\t\t.address      = 0xef,\n\t\t.offset_start = 0x8a,\n\t\t.offset_end   = 0x80,\n\t\t.range_min    = 0x8a,\n\t\t.range_max    = 0xe4,\n\t},\n\t.webcam = {\n\t\t.address       = 0x2e,\n\t\t.block_address = MSI_EC_ADDR_UNSUPP,\n\t\t.bit           = 1,\n\t},\n\t.fn_super_swap = {\n\t\t.address = 0xbf, \n\t\t.bit     = 4,\n\t},\n\t.cooler_boost = {\n\t\t.address = 0x98,\n\t\t.bit     = 7,\n\t},\n\t.shift_mode = {\n\t\t.address = 0xf2,\n\t\t.modes = {\n\t\t\t{ SM_ECO_NAME,     0xc2 },\n\t\t\t{ SM_COMFORT_NAME, 0xc1 },\n\t\t\t{ SM_SPORT_NAME,   0xc0 },\n\t\t\t{ SM_TURBO_NAME,   0xc4 },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.super_battery = {\n\t\t.address = 0xd5,\n\t\t.mask    = 0x0f,\n\t},\n\t.fan_mode = {\n\t\t.address = 0xf4,\n\t\t.modes = {\n\t\t\t{ FM_AUTO_NAME,     0x0d },\n\t\t\t{ FM_SILENT_NAME,   0x1d },\n\t\t\t{ FM_ADVANCED_NAME, 0x8d },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.cpu = {\n\t\t.rt_temp_address       = 0x68,\n\t\t.rt_fan_speed_address  = 0xc9,\n\t\t.rt_fan_speed_base_min = 0x19,\n\t\t.rt_fan_speed_base_max = 0x37,\n\t\t.bs_fan_speed_address  = MSI_EC_ADDR_UNSUPP,\n\t\t.bs_fan_speed_base_min = 0x00,\n\t\t.bs_fan_speed_base_max = 0x0f,\n\t},\n\t.gpu = {\n\t\t.rt_temp_address      = 0x80,\n\t\t.rt_fan_speed_address = MSI_EC_ADDR_UNKNOWN,\n\t},\n\t.leds = {\n\t\t.micmute_led_address = MSI_EC_ADDR_UNSUPP,\n\t\t.mute_led_address    = MSI_EC_ADDR_UNSUPP,\n\t\t.bit                 = 2,\n\t},\n\t.kbd_bl = {\n\t\t.bl_mode_address  = MSI_EC_ADDR_UNKNOWN, \n\t\t.bl_modes         = { 0x00, 0x08 }, \n\t\t.max_mode         = 1, \n\t\t.bl_state_address = MSI_EC_ADDR_UNSUPP, \n\t\t.state_base_value = 0x80,\n\t\t.max_state        = 3,\n\t},\n};\n\nstatic const char * const ALLOWED_FW_7[] __initconst = {\n\t\"17FKEMS1.108\",\n\t\"17FKEMS1.109\",\n\t\"17FKEMS1.10A\",\n\tNULL\n};\n\nstatic struct msi_ec_conf CONF7 __initdata = {\n\t.allowed_fw = ALLOWED_FW_7,\n\t.charge_control = {\n\t\t.address      = 0xef,\n\t\t.offset_start = 0x8a,\n\t\t.offset_end   = 0x80,\n\t\t.range_min    = 0x8a,\n\t\t.range_max    = 0xe4,\n\t},\n\t.webcam = {\n\t\t.address       = 0x2e,\n\t\t.block_address = MSI_EC_ADDR_UNSUPP,\n\t\t.bit           = 1,\n\t},\n\t.fn_super_swap = {\n\t\t.address = 0xbf, \n\t\t.bit     = 4,\n\t},\n\t.cooler_boost = {\n\t\t.address = 0x98,\n\t\t.bit     = 7,\n\t},\n\t.shift_mode = {\n\t\t.address = 0xf2,\n\t\t.modes = {\n\t\t\t{ SM_ECO_NAME,     0xc2 },\n\t\t\t{ SM_COMFORT_NAME, 0xc1 },\n\t\t\t{ SM_SPORT_NAME,   0xc0 },\n\t\t\t{ SM_TURBO_NAME,   0xc4 },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.super_battery = {\n\t\t.address = MSI_EC_ADDR_UNKNOWN, \n\t\t.mask    = 0x0f,\n\t},\n\t.fan_mode = {\n\t\t.address = 0xf4,\n\t\t.modes = {\n\t\t\t{ FM_AUTO_NAME,     0x0d }, \n\t\t\t{ FM_SILENT_NAME,   0x1d },\n\t\t\t{ FM_ADVANCED_NAME, 0x8d },\n\t\t\tMSI_EC_MODE_NULL\n\t\t},\n\t},\n\t.cpu = {\n\t\t.rt_temp_address       = 0x68,\n\t\t.rt_fan_speed_address  = 0xc9, \n\t\t.rt_fan_speed_base_min = 0x19,\n\t\t.rt_fan_speed_base_max = 0x37,\n\t\t.bs_fan_speed_address  = MSI_EC_ADDR_UNSUPP,\n\t\t.bs_fan_speed_base_min = 0x00,\n\t\t.bs_fan_speed_base_max = 0x0f,\n\t},\n\t.gpu = {\n\t\t.rt_temp_address      = MSI_EC_ADDR_UNKNOWN,\n\t\t.rt_fan_speed_address = MSI_EC_ADDR_UNKNOWN,\n\t},\n\t.leds = {\n\t\t.micmute_led_address = MSI_EC_ADDR_UNSUPP,\n\t\t.mute_led_address    = 0x2c,\n\t\t.bit                 = 2,\n\t},\n\t.kbd_bl = {\n\t\t.bl_mode_address  = MSI_EC_ADDR_UNKNOWN, \n\t\t.bl_modes         = { 0x00, 0x08 }, \n\t\t.max_mode         = 1, \n\t\t.bl_state_address = 0xf3,\n\t\t.state_base_value = 0x80,\n\t\t.max_state        = 3,\n\t},\n};\n\nstatic struct msi_ec_conf *CONFIGS[] __initdata = {\n\t&CONF0,\n\t&CONF1,\n\t&CONF2,\n\t&CONF3,\n\t&CONF4,\n\t&CONF5,\n\t&CONF6,\n\t&CONF7,\n\tNULL\n};\n\nstatic struct msi_ec_conf conf; \n\n \n\nstatic int ec_read_seq(u8 addr, u8 *buf, u8 len)\n{\n\tint result;\n\n\tfor (u8 i = 0; i < len; i++) {\n\t\tresult = ec_read(addr + i, buf + i);\n\t\tif (result < 0)\n\t\t\treturn result;\n\t}\n\n\treturn 0;\n}\n\nstatic int ec_get_firmware_version(u8 buf[MSI_EC_FW_VERSION_LENGTH + 1])\n{\n\tint result;\n\n\tmemset(buf, 0, MSI_EC_FW_VERSION_LENGTH + 1);\n\tresult = ec_read_seq(MSI_EC_FW_VERSION_ADDRESS,\n\t\t\t     buf,\n\t\t\t     MSI_EC_FW_VERSION_LENGTH);\n\tif (result < 0)\n\t\treturn result;\n\n\treturn MSI_EC_FW_VERSION_LENGTH + 1;\n}\n\n \n\nstatic ssize_t charge_control_threshold_show(u8 offset,\n\t\t\t\t\t     struct device *device,\n\t\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t\t     char *buf)\n{\n\tu8 rdata;\n\tint result;\n\n\tresult = ec_read(conf.charge_control.address, &rdata);\n\tif (result < 0)\n\t\treturn result;\n\n\treturn sysfs_emit(buf, \"%i\\n\", rdata - offset);\n}\n\nstatic ssize_t charge_control_threshold_store(u8 offset,\n\t\t\t\t\t      struct device *dev,\n\t\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t\t      const char *buf, size_t count)\n{\n\tu8 wdata;\n\tint result;\n\n\tresult = kstrtou8(buf, 10, &wdata);\n\tif (result < 0)\n\t\treturn result;\n\n\twdata += offset;\n\tif (wdata < conf.charge_control.range_min ||\n\t    wdata > conf.charge_control.range_max)\n\t\treturn -EINVAL;\n\n\tresult = ec_write(conf.charge_control.address, wdata);\n\tif (result < 0)\n\t\treturn result;\n\n\treturn count;\n}\n\nstatic ssize_t charge_control_start_threshold_show(struct device *device,\n\t\t\t\t\t\t   struct device_attribute *attr,\n\t\t\t\t\t\t   char *buf)\n{\n\treturn charge_control_threshold_show(conf.charge_control.offset_start,\n\t\t\t\t\t     device, attr, buf);\n}\n\nstatic ssize_t charge_control_start_threshold_store(struct device *dev,\n\t\t\t\t\t\t    struct device_attribute *attr,\n\t\t\t\t\t\t    const char *buf, size_t count)\n{\n\treturn charge_control_threshold_store(conf.charge_control.offset_start,\n\t\t\t\t\t      dev, attr, buf, count);\n}\n\nstatic ssize_t charge_control_end_threshold_show(struct device *device,\n\t\t\t\t\t\t struct device_attribute *attr,\n\t\t\t\t\t\t char *buf)\n{\n\treturn charge_control_threshold_show(conf.charge_control.offset_end,\n\t\t\t\t\t     device, attr, buf);\n}\n\nstatic ssize_t charge_control_end_threshold_store(struct device *dev,\n\t\t\t\t\t\t  struct device_attribute *attr,\n\t\t\t\t\t\t  const char *buf, size_t count)\n{\n\treturn charge_control_threshold_store(conf.charge_control.offset_end,\n\t\t\t\t\t      dev, attr, buf, count);\n}\n\nstatic DEVICE_ATTR_RW(charge_control_start_threshold);\nstatic DEVICE_ATTR_RW(charge_control_end_threshold);\n\nstatic struct attribute *msi_battery_attrs[] = {\n\t&dev_attr_charge_control_start_threshold.attr,\n\t&dev_attr_charge_control_end_threshold.attr,\n\tNULL\n};\n\nATTRIBUTE_GROUPS(msi_battery);\n\nstatic int msi_battery_add(struct power_supply *battery,\n\t\t\t   struct acpi_battery_hook *hook)\n{\n\treturn device_add_groups(&battery->dev, msi_battery_groups);\n}\n\nstatic int msi_battery_remove(struct power_supply *battery,\n\t\t\t      struct acpi_battery_hook *hook)\n{\n\tdevice_remove_groups(&battery->dev, msi_battery_groups);\n\treturn 0;\n}\n\nstatic struct acpi_battery_hook battery_hook = {\n\t.add_battery = msi_battery_add,\n\t.remove_battery = msi_battery_remove,\n\t.name = MSI_EC_DRIVER_NAME,\n};\n\n \n\nstatic const struct dmi_system_id msi_dmi_table[] __initconst __maybe_unused = {\n\t{\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"MICRO-STAR INT\"),\n\t\t},\n\t},\n\t{\n\t\t.matches = {\n\t\t\tDMI_MATCH(DMI_SYS_VENDOR, \"Micro-Star International\"),\n\t\t},\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(dmi, msi_dmi_table);\n\nstatic int __init load_configuration(void)\n{\n\tint result;\n\n\tu8 fw_version[MSI_EC_FW_VERSION_LENGTH + 1];\n\n\t \n\tresult = ec_get_firmware_version(fw_version);\n\tif (result < 0)\n\t\treturn result;\n\n\t \n\tfor (int i = 0; CONFIGS[i]; i++) {\n\t\tif (match_string(CONFIGS[i]->allowed_fw, -1, fw_version) != -EINVAL) {\n\t\t\tconf = *CONFIGS[i];\n\t\t\tconf.allowed_fw = NULL;\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\t \n\n\tfor (int i = 0; i < MSI_EC_FW_VERSION_LENGTH; i++) {\n\t\tif (!isgraph(fw_version[i])) {\n\t\t\tpr_warn(\"Unable to find a valid firmware version!\\n\");\n\t\t\treturn -EOPNOTSUPP;\n\t\t}\n\t}\n\n\tpr_warn(\"Firmware version is not supported: '%s'\\n\", fw_version);\n\treturn -EOPNOTSUPP;\n}\n\nstatic int __init msi_ec_init(void)\n{\n\tint result;\n\n\tresult = load_configuration();\n\tif (result < 0)\n\t\treturn result;\n\n\tbattery_hook_register(&battery_hook);\n\treturn 0;\n}\n\nstatic void __exit msi_ec_exit(void)\n{\n\tbattery_hook_unregister(&battery_hook);\n}\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Jose Angel Pastrana <japp0005@red.ujaen.es>\");\nMODULE_AUTHOR(\"Aakash Singh <mail@singhaakash.dev>\");\nMODULE_AUTHOR(\"Nikita Kravets <teackot@gmail.com>\");\nMODULE_DESCRIPTION(\"MSI Embedded Controller\");\n\nmodule_init(msi_ec_init);\nmodule_exit(msi_ec_exit);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}