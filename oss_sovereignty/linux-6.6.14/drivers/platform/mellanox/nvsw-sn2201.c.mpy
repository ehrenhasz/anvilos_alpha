{
  "module_name": "nvsw-sn2201.c",
  "hash_id": "7a0772e3d2a44ce4e8bfac7900a186f575740f81a4555ed856bb64dda89d7f70",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/mellanox/nvsw-sn2201.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/i2c.h>\n#include <linux/interrupt.h>\n#include <linux/irq.h>\n#include <linux/gpio.h>\n#include <linux/module.h>\n#include <linux/platform_data/mlxcpld.h>\n#include <linux/platform_data/mlxreg.h>\n#include <linux/platform_device.h>\n#include <linux/regmap.h>\n\n \n#define NVSW_SN2201_CPLD_LPC_I2C_BASE_ADRR          0x2000\n#define NVSW_SN2201_CPLD_LPC_IO_RANGE               0x100\n#define NVSW_SN2201_HW_VER_ID_OFFSET                0x00\n#define NVSW_SN2201_BOARD_ID_OFFSET                 0x01\n#define NVSW_SN2201_CPLD_VER_OFFSET                 0x02\n#define NVSW_SN2201_CPLD_MVER_OFFSET                0x03\n#define NVSW_SN2201_CPLD_ID_OFFSET                  0x04\n#define NVSW_SN2201_CPLD_PN_OFFSET                  0x05\n#define NVSW_SN2201_CPLD_PN1_OFFSET                 0x06\n#define NVSW_SN2201_PSU_CTRL_OFFSET                 0x0a\n#define NVSW_SN2201_QSFP28_STATUS_OFFSET            0x0b\n#define NVSW_SN2201_QSFP28_INT_STATUS_OFFSET        0x0c\n#define NVSW_SN2201_QSFP28_LP_STATUS_OFFSET         0x0d\n#define NVSW_SN2201_QSFP28_RST_STATUS_OFFSET        0x0e\n#define NVSW_SN2201_SYS_STATUS_OFFSET               0x0f\n#define NVSW_SN2201_FRONT_SYS_LED_CTRL_OFFSET       0x10\n#define NVSW_SN2201_FRONT_PSU_LED_CTRL_OFFSET       0x12\n#define NVSW_SN2201_FRONT_UID_LED_CTRL_OFFSET       0x13\n#define NVSW_SN2201_QSFP28_LED_TEST_STATUS_OFFSET   0x14\n#define NVSW_SN2201_SYS_RST_STATUS_OFFSET           0x15\n#define NVSW_SN2201_SYS_INT_STATUS_OFFSET           0x21\n#define NVSW_SN2201_SYS_INT_MASK_OFFSET             0x22\n#define NVSW_SN2201_ASIC_STATUS_OFFSET              0x24\n#define NVSW_SN2201_ASIC_EVENT_OFFSET               0x25\n#define NVSW_SN2201_ASIC_MAKS_OFFSET                0x26\n#define NVSW_SN2201_THML_STATUS_OFFSET              0x27\n#define NVSW_SN2201_THML_EVENT_OFFSET               0x28\n#define NVSW_SN2201_THML_MASK_OFFSET                0x29\n#define NVSW_SN2201_PS_ALT_STATUS_OFFSET            0x2a\n#define NVSW_SN2201_PS_ALT_EVENT_OFFSET             0x2b\n#define NVSW_SN2201_PS_ALT_MASK_OFFSET              0x2c\n#define NVSW_SN2201_PS_PRSNT_STATUS_OFFSET          0x30\n#define NVSW_SN2201_PS_PRSNT_EVENT_OFFSET           0x31\n#define NVSW_SN2201_PS_PRSNT_MASK_OFFSET            0x32\n#define NVSW_SN2201_PS_DC_OK_STATUS_OFFSET          0x33\n#define NVSW_SN2201_PS_DC_OK_EVENT_OFFSET           0x34\n#define NVSW_SN2201_PS_DC_OK_MASK_OFFSET            0x35\n#define NVSW_SN2201_RST_CAUSE1_OFFSET               0x36\n#define NVSW_SN2201_RST_CAUSE2_OFFSET               0x37\n#define NVSW_SN2201_RST_SW_CTRL_OFFSET              0x38\n#define NVSW_SN2201_FAN_PRSNT_STATUS_OFFSET         0x3a\n#define NVSW_SN2201_FAN_PRSNT_EVENT_OFFSET          0x3b\n#define NVSW_SN2201_FAN_PRSNT_MASK_OFFSET           0x3c\n#define NVSW_SN2201_WD_TMR_OFFSET_LSB               0x40\n#define NVSW_SN2201_WD_TMR_OFFSET_MSB               0x41\n#define NVSW_SN2201_WD_ACT_OFFSET                   0x42\n#define NVSW_SN2201_FAN_LED1_CTRL_OFFSET            0x50\n#define NVSW_SN2201_FAN_LED2_CTRL_OFFSET            0x51\n#define NVSW_SN2201_REG_MAX                         0x52\n\n \n#define NVSW_SN2201_PHY_I2C_BUS_NUM\t\t2\n \n#define NVSW_SN2201_MAIN_MUX_CHNL_NUM\t\t8\n\n#define NVSW_SN2201_MAIN_NR\t\t\t0\n#define NVSW_SN2201_MAIN_MUX_NR\t\t\t1\n#define NVSW_SN2201_MAIN_MUX_DEFER_NR\t\t(NVSW_SN2201_PHY_I2C_BUS_NUM + \\\n\t\t\t\t\t\t NVSW_SN2201_MAIN_MUX_CHNL_NUM - 1)\n\n#define NVSW_SN2201_MAIN_MUX_CH0_NR\tNVSW_SN2201_PHY_I2C_BUS_NUM\n#define NVSW_SN2201_MAIN_MUX_CH1_NR\t(NVSW_SN2201_MAIN_MUX_CH0_NR + 1)\n#define NVSW_SN2201_MAIN_MUX_CH2_NR\t(NVSW_SN2201_MAIN_MUX_CH0_NR + 2)\n#define NVSW_SN2201_MAIN_MUX_CH3_NR\t(NVSW_SN2201_MAIN_MUX_CH0_NR + 3)\n#define NVSW_SN2201_MAIN_MUX_CH5_NR\t(NVSW_SN2201_MAIN_MUX_CH0_NR + 5)\n#define NVSW_SN2201_MAIN_MUX_CH6_NR\t(NVSW_SN2201_MAIN_MUX_CH0_NR + 6)\n#define NVSW_SN2201_MAIN_MUX_CH7_NR\t(NVSW_SN2201_MAIN_MUX_CH0_NR + 7)\n#define NVSW_SN2201_2ND_MUX_CH0_NR\t(NVSW_SN2201_MAIN_MUX_CH7_NR + 1)\n#define NVSW_SN2201_2ND_MUX_CH1_NR\t(NVSW_SN2201_MAIN_MUX_CH7_NR + 2)\n#define NVSW_SN2201_2ND_MUX_CH2_NR\t(NVSW_SN2201_MAIN_MUX_CH7_NR + 3)\n#define NVSW_SN2201_2ND_MUX_CH3_NR\t(NVSW_SN2201_MAIN_MUX_CH7_NR + 4)\n\n#define NVSW_SN2201_CPLD_NR\t\tNVSW_SN2201_MAIN_MUX_CH0_NR\n#define NVSW_SN2201_NR_NONE\t\t-1\n\n \n#define NVSW_SN2201_CPLD_AGGR_ASIC_MASK_DEF\t0xe0\n#define NVSW_SN2201_CPLD_AGGR_PSU_MASK_DEF\t0x04\n#define NVSW_SN2201_CPLD_AGGR_PWR_MASK_DEF\t0x02\n#define NVSW_SN2201_CPLD_AGGR_FAN_MASK_DEF\t0x10\n#define NVSW_SN2201_CPLD_AGGR_MASK_DEF      \\\n\t(NVSW_SN2201_CPLD_AGGR_ASIC_MASK_DEF \\\n\t| NVSW_SN2201_CPLD_AGGR_PSU_MASK_DEF \\\n\t| NVSW_SN2201_CPLD_AGGR_PWR_MASK_DEF \\\n\t| NVSW_SN2201_CPLD_AGGR_FAN_MASK_DEF)\n\n#define NVSW_SN2201_CPLD_ASIC_MASK\t\tGENMASK(3, 1)\n#define NVSW_SN2201_CPLD_PSU_MASK\t\tGENMASK(1, 0)\n#define NVSW_SN2201_CPLD_PWR_MASK\t\tGENMASK(1, 0)\n#define NVSW_SN2201_CPLD_FAN_MASK\t\tGENMASK(3, 0)\n\n#define NVSW_SN2201_CPLD_SYSIRQ\t\t\t26\n#define NVSW_SN2201_LPC_SYSIRQ\t\t\t28\n#define NVSW_SN2201_CPLD_I2CADDR\t\t0x41\n\n#define NVSW_SN2201_WD_DFLT_TIMEOUT\t\t600\n\n \nstruct nvsw_sn2201 {\n\tstruct device *dev;\n\tstruct mlxreg_core_platform_data *io_data;\n\tstruct mlxreg_core_platform_data *led_data;\n\tstruct mlxreg_core_platform_data *wd_data;\n\tstruct mlxreg_core_hotplug_platform_data *hotplug_data;\n\tstruct mlxreg_core_hotplug_platform_data *i2c_data;\n\tstruct platform_device *led;\n\tstruct platform_device *wd;\n\tstruct platform_device *io_regs;\n\tstruct platform_device *pdev_hotplug;\n\tstruct platform_device *pdev_i2c;\n\tstruct mlxreg_hotplug_device *sn2201_devs;\n\tint sn2201_devs_num;\n\tstruct mlxreg_hotplug_device *main_mux_devs;\n\tint main_mux_devs_num;\n\tstruct mlxreg_hotplug_device *cpld_devs;\n\tint cpld_devs_num;\n\tint main_mux_deferred_nr;\n};\n\nstatic bool nvsw_sn2201_writeable_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase NVSW_SN2201_PSU_CTRL_OFFSET:\n\tcase NVSW_SN2201_QSFP28_LP_STATUS_OFFSET:\n\tcase NVSW_SN2201_QSFP28_RST_STATUS_OFFSET:\n\tcase NVSW_SN2201_FRONT_SYS_LED_CTRL_OFFSET:\n\tcase NVSW_SN2201_FRONT_PSU_LED_CTRL_OFFSET:\n\tcase NVSW_SN2201_FRONT_UID_LED_CTRL_OFFSET:\n\tcase NVSW_SN2201_QSFP28_LED_TEST_STATUS_OFFSET:\n\tcase NVSW_SN2201_SYS_RST_STATUS_OFFSET:\n\tcase NVSW_SN2201_SYS_INT_MASK_OFFSET:\n\tcase NVSW_SN2201_ASIC_EVENT_OFFSET:\n\tcase NVSW_SN2201_ASIC_MAKS_OFFSET:\n\tcase NVSW_SN2201_THML_EVENT_OFFSET:\n\tcase NVSW_SN2201_THML_MASK_OFFSET:\n\tcase NVSW_SN2201_PS_ALT_EVENT_OFFSET:\n\tcase NVSW_SN2201_PS_ALT_MASK_OFFSET:\n\tcase NVSW_SN2201_PS_PRSNT_EVENT_OFFSET:\n\tcase NVSW_SN2201_PS_PRSNT_MASK_OFFSET:\n\tcase NVSW_SN2201_PS_DC_OK_EVENT_OFFSET:\n\tcase NVSW_SN2201_PS_DC_OK_MASK_OFFSET:\n\tcase NVSW_SN2201_RST_SW_CTRL_OFFSET:\n\tcase NVSW_SN2201_FAN_PRSNT_EVENT_OFFSET:\n\tcase NVSW_SN2201_FAN_PRSNT_MASK_OFFSET:\n\tcase NVSW_SN2201_WD_TMR_OFFSET_LSB:\n\tcase NVSW_SN2201_WD_TMR_OFFSET_MSB:\n\tcase NVSW_SN2201_WD_ACT_OFFSET:\n\tcase NVSW_SN2201_FAN_LED1_CTRL_OFFSET:\n\tcase NVSW_SN2201_FAN_LED2_CTRL_OFFSET:\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool nvsw_sn2201_readable_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase NVSW_SN2201_HW_VER_ID_OFFSET:\n\tcase NVSW_SN2201_BOARD_ID_OFFSET:\n\tcase NVSW_SN2201_CPLD_VER_OFFSET:\n\tcase NVSW_SN2201_CPLD_MVER_OFFSET:\n\tcase NVSW_SN2201_CPLD_ID_OFFSET:\n\tcase NVSW_SN2201_CPLD_PN_OFFSET:\n\tcase NVSW_SN2201_CPLD_PN1_OFFSET:\n\tcase NVSW_SN2201_PSU_CTRL_OFFSET:\n\tcase NVSW_SN2201_QSFP28_STATUS_OFFSET:\n\tcase NVSW_SN2201_QSFP28_INT_STATUS_OFFSET:\n\tcase NVSW_SN2201_QSFP28_LP_STATUS_OFFSET:\n\tcase NVSW_SN2201_QSFP28_RST_STATUS_OFFSET:\n\tcase NVSW_SN2201_SYS_STATUS_OFFSET:\n\tcase NVSW_SN2201_FRONT_SYS_LED_CTRL_OFFSET:\n\tcase NVSW_SN2201_FRONT_PSU_LED_CTRL_OFFSET:\n\tcase NVSW_SN2201_FRONT_UID_LED_CTRL_OFFSET:\n\tcase NVSW_SN2201_QSFP28_LED_TEST_STATUS_OFFSET:\n\tcase NVSW_SN2201_SYS_RST_STATUS_OFFSET:\n\tcase NVSW_SN2201_RST_CAUSE1_OFFSET:\n\tcase NVSW_SN2201_RST_CAUSE2_OFFSET:\n\tcase NVSW_SN2201_SYS_INT_STATUS_OFFSET:\n\tcase NVSW_SN2201_SYS_INT_MASK_OFFSET:\n\tcase NVSW_SN2201_ASIC_STATUS_OFFSET:\n\tcase NVSW_SN2201_ASIC_EVENT_OFFSET:\n\tcase NVSW_SN2201_ASIC_MAKS_OFFSET:\n\tcase NVSW_SN2201_THML_STATUS_OFFSET:\n\tcase NVSW_SN2201_THML_EVENT_OFFSET:\n\tcase NVSW_SN2201_THML_MASK_OFFSET:\n\tcase NVSW_SN2201_PS_ALT_STATUS_OFFSET:\n\tcase NVSW_SN2201_PS_ALT_EVENT_OFFSET:\n\tcase NVSW_SN2201_PS_ALT_MASK_OFFSET:\n\tcase NVSW_SN2201_PS_PRSNT_STATUS_OFFSET:\n\tcase NVSW_SN2201_PS_PRSNT_EVENT_OFFSET:\n\tcase NVSW_SN2201_PS_PRSNT_MASK_OFFSET:\n\tcase NVSW_SN2201_PS_DC_OK_STATUS_OFFSET:\n\tcase NVSW_SN2201_PS_DC_OK_EVENT_OFFSET:\n\tcase NVSW_SN2201_PS_DC_OK_MASK_OFFSET:\n\tcase NVSW_SN2201_RST_SW_CTRL_OFFSET:\n\tcase NVSW_SN2201_FAN_PRSNT_STATUS_OFFSET:\n\tcase NVSW_SN2201_FAN_PRSNT_EVENT_OFFSET:\n\tcase NVSW_SN2201_FAN_PRSNT_MASK_OFFSET:\n\tcase NVSW_SN2201_WD_TMR_OFFSET_LSB:\n\tcase NVSW_SN2201_WD_TMR_OFFSET_MSB:\n\tcase NVSW_SN2201_WD_ACT_OFFSET:\n\tcase NVSW_SN2201_FAN_LED1_CTRL_OFFSET:\n\tcase NVSW_SN2201_FAN_LED2_CTRL_OFFSET:\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic bool nvsw_sn2201_volatile_reg(struct device *dev, unsigned int reg)\n{\n\tswitch (reg) {\n\tcase NVSW_SN2201_HW_VER_ID_OFFSET:\n\tcase NVSW_SN2201_BOARD_ID_OFFSET:\n\tcase NVSW_SN2201_CPLD_VER_OFFSET:\n\tcase NVSW_SN2201_CPLD_MVER_OFFSET:\n\tcase NVSW_SN2201_CPLD_ID_OFFSET:\n\tcase NVSW_SN2201_CPLD_PN_OFFSET:\n\tcase NVSW_SN2201_CPLD_PN1_OFFSET:\n\tcase NVSW_SN2201_PSU_CTRL_OFFSET:\n\tcase NVSW_SN2201_QSFP28_STATUS_OFFSET:\n\tcase NVSW_SN2201_QSFP28_INT_STATUS_OFFSET:\n\tcase NVSW_SN2201_QSFP28_LP_STATUS_OFFSET:\n\tcase NVSW_SN2201_QSFP28_RST_STATUS_OFFSET:\n\tcase NVSW_SN2201_SYS_STATUS_OFFSET:\n\tcase NVSW_SN2201_FRONT_SYS_LED_CTRL_OFFSET:\n\tcase NVSW_SN2201_FRONT_PSU_LED_CTRL_OFFSET:\n\tcase NVSW_SN2201_FRONT_UID_LED_CTRL_OFFSET:\n\tcase NVSW_SN2201_QSFP28_LED_TEST_STATUS_OFFSET:\n\tcase NVSW_SN2201_SYS_RST_STATUS_OFFSET:\n\tcase NVSW_SN2201_RST_CAUSE1_OFFSET:\n\tcase NVSW_SN2201_RST_CAUSE2_OFFSET:\n\tcase NVSW_SN2201_SYS_INT_STATUS_OFFSET:\n\tcase NVSW_SN2201_SYS_INT_MASK_OFFSET:\n\tcase NVSW_SN2201_ASIC_STATUS_OFFSET:\n\tcase NVSW_SN2201_ASIC_EVENT_OFFSET:\n\tcase NVSW_SN2201_ASIC_MAKS_OFFSET:\n\tcase NVSW_SN2201_THML_STATUS_OFFSET:\n\tcase NVSW_SN2201_THML_EVENT_OFFSET:\n\tcase NVSW_SN2201_THML_MASK_OFFSET:\n\tcase NVSW_SN2201_PS_ALT_STATUS_OFFSET:\n\tcase NVSW_SN2201_PS_ALT_EVENT_OFFSET:\n\tcase NVSW_SN2201_PS_ALT_MASK_OFFSET:\n\tcase NVSW_SN2201_PS_PRSNT_STATUS_OFFSET:\n\tcase NVSW_SN2201_PS_PRSNT_EVENT_OFFSET:\n\tcase NVSW_SN2201_PS_PRSNT_MASK_OFFSET:\n\tcase NVSW_SN2201_PS_DC_OK_STATUS_OFFSET:\n\tcase NVSW_SN2201_PS_DC_OK_EVENT_OFFSET:\n\tcase NVSW_SN2201_PS_DC_OK_MASK_OFFSET:\n\tcase NVSW_SN2201_RST_SW_CTRL_OFFSET:\n\tcase NVSW_SN2201_FAN_PRSNT_STATUS_OFFSET:\n\tcase NVSW_SN2201_FAN_PRSNT_EVENT_OFFSET:\n\tcase NVSW_SN2201_FAN_PRSNT_MASK_OFFSET:\n\tcase NVSW_SN2201_WD_TMR_OFFSET_LSB:\n\tcase NVSW_SN2201_WD_TMR_OFFSET_MSB:\n\tcase NVSW_SN2201_FAN_LED1_CTRL_OFFSET:\n\tcase NVSW_SN2201_FAN_LED2_CTRL_OFFSET:\n\t\treturn true;\n\t}\n\treturn false;\n}\n\nstatic const struct reg_default nvsw_sn2201_regmap_default[] = {\n\t{ NVSW_SN2201_QSFP28_LED_TEST_STATUS_OFFSET, 0x00 },\n\t{ NVSW_SN2201_WD_ACT_OFFSET, 0x00 },\n};\n\n \nstatic const struct regmap_config nvsw_sn2201_regmap_conf = {\n\t.reg_bits = 8,\n\t.val_bits = 8,\n\t.max_register = NVSW_SN2201_REG_MAX,\n\t.cache_type = REGCACHE_FLAT,\n\t.writeable_reg = nvsw_sn2201_writeable_reg,\n\t.readable_reg = nvsw_sn2201_readable_reg,\n\t.volatile_reg = nvsw_sn2201_volatile_reg,\n\t.reg_defaults = nvsw_sn2201_regmap_default,\n\t.num_reg_defaults = ARRAY_SIZE(nvsw_sn2201_regmap_default),\n};\n\n \nstatic const struct resource nvsw_sn2201_lpc_io_resources[] = {\n\t[0] = DEFINE_RES_NAMED(NVSW_SN2201_CPLD_LPC_I2C_BASE_ADRR,\n\t\t\t       NVSW_SN2201_CPLD_LPC_IO_RANGE,\n\t\t\t       \"mlxplat_cpld_lpc_i2c_ctrl\", IORESOURCE_IO),\n};\n\nstatic struct resource nvsw_sn2201_cpld_res[] = {\n\t[0] = DEFINE_RES_IRQ_NAMED(NVSW_SN2201_CPLD_SYSIRQ, \"mlxreg-hotplug\"),\n};\n\nstatic struct resource nvsw_sn2201_lpc_res[] = {\n\t[0] = DEFINE_RES_IRQ_NAMED(NVSW_SN2201_LPC_SYSIRQ, \"i2c-mlxcpld\"),\n};\n\n \nstatic struct mlxreg_core_hotplug_platform_data nvsw_sn2201_i2c_data = {\n\t.irq = NVSW_SN2201_CPLD_SYSIRQ,\n};\n\n \nstatic struct i2c_board_info nvsw_sn2201_cpld_devices[] = {\n\t{\n\t\tI2C_BOARD_INFO(\"nvsw-sn2201\", 0x41),\n\t},\n};\n\n \nstatic struct mlxreg_hotplug_device nvsw_sn2201_cpld_brdinfo[] = {\n\t{\n\t\t.brdinfo = &nvsw_sn2201_cpld_devices[0],\n\t\t.nr = NVSW_SN2201_CPLD_NR,\n\t},\n};\n\n \nstatic struct i2c_board_info nvsw_sn2201_main_mux_devices[] = {\n\t{\n\t\tI2C_BOARD_INFO(\"pca9548\", 0x70),\n\t},\n};\n\n \nstatic struct mlxreg_hotplug_device nvsw_sn2201_main_mux_brdinfo[] = {\n\t{\n\t\t.brdinfo = &nvsw_sn2201_main_mux_devices[0],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_NR,\n\t},\n};\n\n \nstatic struct i2c_board_info nvsw_sn2201_pwr_devices[] = {\n\t{\n\t\tI2C_BOARD_INFO(\"pmbus\", 0x58),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"pmbus\", 0x58),\n\t},\n};\n\n \nstatic struct i2c_board_info nvsw_sn2201_fan_devices[] = {\n\t{\n\t\tI2C_BOARD_INFO(\"24c02\", 0x50),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"24c02\", 0x51),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"24c02\", 0x52),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"24c02\", 0x53),\n\t},\n};\n\n \nstatic struct mlxreg_core_data nvsw_sn2201_psu_items_data[] = {\n\t{\n\t\t.label = \"psu1\",\n\t\t.reg = NVSW_SN2201_PS_PRSNT_STATUS_OFFSET,\n\t\t.mask = BIT(0),\n\t\t.hpdev.nr = NVSW_SN2201_NR_NONE,\n\t},\n\t{\n\t\t.label = \"psu2\",\n\t\t.reg = NVSW_SN2201_PS_PRSNT_STATUS_OFFSET,\n\t\t.mask = BIT(1),\n\t\t.hpdev.nr = NVSW_SN2201_NR_NONE,\n\t},\n};\n\nstatic struct mlxreg_core_data nvsw_sn2201_pwr_items_data[] = {\n\t{\n\t\t.label = \"pwr1\",\n\t\t.reg = NVSW_SN2201_PS_DC_OK_STATUS_OFFSET,\n\t\t.mask = BIT(0),\n\t\t.hpdev.brdinfo = &nvsw_sn2201_pwr_devices[0],\n\t\t.hpdev.nr = NVSW_SN2201_MAIN_MUX_CH1_NR,\n\t},\n\t{\n\t\t.label = \"pwr2\",\n\t\t.reg = NVSW_SN2201_PS_DC_OK_STATUS_OFFSET,\n\t\t.mask = BIT(1),\n\t\t.hpdev.brdinfo = &nvsw_sn2201_pwr_devices[1],\n\t\t.hpdev.nr = NVSW_SN2201_MAIN_MUX_CH2_NR,\n\t},\n};\n\nstatic struct mlxreg_core_data nvsw_sn2201_fan_items_data[] = {\n\t{\n\t\t.label = \"fan1\",\n\t\t.reg = NVSW_SN2201_FAN_PRSNT_STATUS_OFFSET,\n\t\t.mask = BIT(0),\n\t\t.hpdev.brdinfo = &nvsw_sn2201_fan_devices[0],\n\t\t.hpdev.nr = NVSW_SN2201_2ND_MUX_CH0_NR,\n\t},\n\t{\n\t\t.label = \"fan2\",\n\t\t.reg = NVSW_SN2201_FAN_PRSNT_STATUS_OFFSET,\n\t\t.mask = BIT(1),\n\t\t.hpdev.brdinfo = &nvsw_sn2201_fan_devices[1],\n\t\t.hpdev.nr = NVSW_SN2201_2ND_MUX_CH1_NR,\n\t},\n\t{\n\t\t.label = \"fan3\",\n\t\t.reg = NVSW_SN2201_FAN_PRSNT_STATUS_OFFSET,\n\t\t.mask = BIT(2),\n\t\t.hpdev.brdinfo = &nvsw_sn2201_fan_devices[2],\n\t\t.hpdev.nr = NVSW_SN2201_2ND_MUX_CH2_NR,\n\t},\n\t{\n\t\t.label = \"fan4\",\n\t\t.reg = NVSW_SN2201_FAN_PRSNT_STATUS_OFFSET,\n\t\t.mask = BIT(3),\n\t\t.hpdev.brdinfo = &nvsw_sn2201_fan_devices[3],\n\t\t.hpdev.nr = NVSW_SN2201_2ND_MUX_CH3_NR,\n\t},\n};\n\nstatic struct mlxreg_core_data nvsw_sn2201_sys_items_data[] = {\n\t{\n\t\t.label = \"nic_smb_alert\",\n\t\t.reg = NVSW_SN2201_ASIC_STATUS_OFFSET,\n\t\t.mask = BIT(1),\n\t\t.hpdev.nr = NVSW_SN2201_NR_NONE,\n\t},\n\t{\n\t\t.label = \"cpu_sd\",\n\t\t.reg = NVSW_SN2201_ASIC_STATUS_OFFSET,\n\t\t.mask = BIT(2),\n\t\t.hpdev.nr = NVSW_SN2201_NR_NONE,\n\t},\n\t{\n\t\t.label = \"mac_health\",\n\t\t.reg = NVSW_SN2201_ASIC_STATUS_OFFSET,\n\t\t.mask = BIT(3),\n\t\t.hpdev.nr = NVSW_SN2201_NR_NONE,\n\t},\n};\n\nstatic struct mlxreg_core_item nvsw_sn2201_items[] = {\n\t{\n\t\t.data = nvsw_sn2201_psu_items_data,\n\t\t.aggr_mask = NVSW_SN2201_CPLD_AGGR_PSU_MASK_DEF,\n\t\t.reg = NVSW_SN2201_PS_PRSNT_STATUS_OFFSET,\n\t\t.mask = NVSW_SN2201_CPLD_PSU_MASK,\n\t\t.count = ARRAY_SIZE(nvsw_sn2201_psu_items_data),\n\t\t.inversed = 1,\n\t\t.health = false,\n\t},\n\t{\n\t\t.data = nvsw_sn2201_pwr_items_data,\n\t\t.aggr_mask = NVSW_SN2201_CPLD_AGGR_PWR_MASK_DEF,\n\t\t.reg = NVSW_SN2201_PS_DC_OK_STATUS_OFFSET,\n\t\t.mask = NVSW_SN2201_CPLD_PWR_MASK,\n\t\t.count = ARRAY_SIZE(nvsw_sn2201_pwr_items_data),\n\t\t.inversed = 0,\n\t\t.health = false,\n\t},\n\t{\n\t\t.data = nvsw_sn2201_fan_items_data,\n\t\t.aggr_mask = NVSW_SN2201_CPLD_AGGR_FAN_MASK_DEF,\n\t\t.reg = NVSW_SN2201_FAN_PRSNT_STATUS_OFFSET,\n\t\t.mask = NVSW_SN2201_CPLD_FAN_MASK,\n\t\t.count = ARRAY_SIZE(nvsw_sn2201_fan_items_data),\n\t\t.inversed = 1,\n\t\t.health = false,\n\t},\n\t{\n\t\t.data = nvsw_sn2201_sys_items_data,\n\t\t.aggr_mask = NVSW_SN2201_CPLD_AGGR_ASIC_MASK_DEF,\n\t\t.reg = NVSW_SN2201_ASIC_STATUS_OFFSET,\n\t\t.mask = NVSW_SN2201_CPLD_ASIC_MASK,\n\t\t.count = ARRAY_SIZE(nvsw_sn2201_sys_items_data),\n\t\t.inversed = 1,\n\t\t.health = false,\n\t},\n};\n\nstatic\nstruct mlxreg_core_hotplug_platform_data nvsw_sn2201_hotplug = {\n\t.items = nvsw_sn2201_items,\n\t.counter = ARRAY_SIZE(nvsw_sn2201_items),\n\t.cell = NVSW_SN2201_SYS_INT_STATUS_OFFSET,\n\t.mask = NVSW_SN2201_CPLD_AGGR_MASK_DEF,\n};\n\n \nstatic struct i2c_board_info nvsw_sn2201_static_devices[] = {\n\t{\n\t\tI2C_BOARD_INFO(\"24c02\", 0x57),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"lm75\", 0x4b),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"24c64\", 0x56),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"ads1015\", 0x49),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"pca9546\", 0x71),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"emc2305\", 0x4d),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"lm75\", 0x49),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"pca9555\", 0x27),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"powr1014\", 0x37),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"lm75\", 0x4f),\n\t},\n\t{\n\t\tI2C_BOARD_INFO(\"pmbus\", 0x40),\n\t},\n};\n\n \nstatic struct mlxreg_hotplug_device nvsw_sn2201_static_brdinfo[] = {\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[0],\n\t\t.nr = NVSW_SN2201_MAIN_NR,\n\t},\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[1],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_CH0_NR,\n\t},\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[2],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_CH0_NR,\n\t},\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[3],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_CH0_NR,\n\t},\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[4],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_CH3_NR,\n\t},\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[5],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_CH5_NR,\n\t},\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[6],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_CH5_NR,\n\t},\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[7],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_CH5_NR,\n\t},\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[8],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_CH6_NR,\n\t},\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[9],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_CH6_NR,\n\t},\n\t{\n\t\t.brdinfo = &nvsw_sn2201_static_devices[10],\n\t\t.nr = NVSW_SN2201_MAIN_MUX_CH7_NR,\n\t},\n};\n\n \nstatic struct mlxreg_core_data nvsw_sn2201_led_data[] = {\n\t{\n\t\t.label = \"status:green\",\n\t\t.reg = NVSW_SN2201_FRONT_SYS_LED_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 4),\n\t},\n\t{\n\t\t.label = \"status:orange\",\n\t\t.reg = NVSW_SN2201_FRONT_SYS_LED_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 4),\n\t},\n\t{\n\t\t.label = \"psu:green\",\n\t\t.reg = NVSW_SN2201_FRONT_PSU_LED_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 4),\n\t},\n\t{\n\t\t.label = \"psu:orange\",\n\t\t.reg = NVSW_SN2201_FRONT_PSU_LED_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 4),\n\t},\n\t{\n\t\t.label = \"uid:blue\",\n\t\t.reg = NVSW_SN2201_FRONT_UID_LED_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 4),\n\t},\n\t{\n\t\t.label = \"fan1:green\",\n\t\t.reg = NVSW_SN2201_FAN_LED1_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 4),\n\t},\n\t{\n\t\t.label = \"fan1:orange\",\n\t\t.reg = NVSW_SN2201_FAN_LED1_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 4),\n\t},\n\t{\n\t\t.label = \"fan2:green\",\n\t\t.reg = NVSW_SN2201_FAN_LED1_CTRL_OFFSET,\n\t\t.mask = GENMASK(3, 0),\n\t},\n\t{\n\t\t.label = \"fan2:orange\",\n\t\t.reg = NVSW_SN2201_FAN_LED1_CTRL_OFFSET,\n\t\t.mask = GENMASK(3, 0),\n\t},\n\t{\n\t\t.label = \"fan3:green\",\n\t\t.reg = NVSW_SN2201_FAN_LED2_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 4),\n\t},\n\t{\n\t\t.label = \"fan3:orange\",\n\t\t.reg = NVSW_SN2201_FAN_LED2_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 4),\n\t},\n\t{\n\t\t.label = \"fan4:green\",\n\t\t.reg = NVSW_SN2201_FAN_LED2_CTRL_OFFSET,\n\t\t.mask = GENMASK(3, 0),\n\t},\n\t{\n\t\t.label = \"fan4:orange\",\n\t\t.reg = NVSW_SN2201_FAN_LED2_CTRL_OFFSET,\n\t\t.mask = GENMASK(3, 0),\n\t},\n};\n\nstatic struct mlxreg_core_platform_data nvsw_sn2201_led = {\n\t.data = nvsw_sn2201_led_data,\n\t.counter = ARRAY_SIZE(nvsw_sn2201_led_data),\n};\n\n \nstatic struct mlxreg_core_data nvsw_sn2201_io_data[] = {\n\t{\n\t\t.label = \"cpld1_version\",\n\t\t.reg = NVSW_SN2201_CPLD_VER_OFFSET,\n\t\t.bit = GENMASK(7, 0),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"cpld1_version_min\",\n\t\t.reg = NVSW_SN2201_CPLD_MVER_OFFSET,\n\t\t.bit = GENMASK(7, 0),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"cpld1_pn\",\n\t\t.reg = NVSW_SN2201_CPLD_PN_OFFSET,\n\t\t.bit = GENMASK(15, 0),\n\t\t.mode = 0444,\n\t\t.regnum = 2,\n\t},\n\t{\n\t\t.label = \"psu1_on\",\n\t\t.reg = NVSW_SN2201_PSU_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(0),\n\t\t.mode = 0644,\n\t},\n\t{\n\t\t.label = \"psu2_on\",\n\t\t.reg = NVSW_SN2201_PSU_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(1),\n\t\t.mode = 0644,\n\t},\n\t{\n\t\t.label = \"pwr_cycle\",\n\t\t.reg = NVSW_SN2201_PSU_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(2),\n\t\t.mode = 0644,\n\t},\n\t{\n\t\t.label = \"asic_health\",\n\t\t.reg = NVSW_SN2201_SYS_STATUS_OFFSET,\n\t\t.mask = GENMASK(4, 3),\n\t\t.bit = 4,\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"qsfp_pwr_good\",\n\t\t.reg = NVSW_SN2201_SYS_STATUS_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(0),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"phy_reset\",\n\t\t.reg = NVSW_SN2201_SYS_RST_STATUS_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(3),\n\t\t.mode = 0644,\n\t},\n\t{\n\t\t.label = \"mac_reset\",\n\t\t.reg = NVSW_SN2201_SYS_RST_STATUS_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(2),\n\t\t.mode = 0644,\n\t},\n\t{\n\t\t.label = \"pwr_down\",\n\t\t.reg = NVSW_SN2201_RST_SW_CTRL_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(0),\n\t\t.mode = 0644,\n\t},\n\t{\n\t\t.label = \"reset_long_pb\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE1_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(0),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_short_pb\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE1_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(1),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_aux_pwr_or_fu\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE1_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(2),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_swb_dc_dc_pwr_fail\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE1_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(3),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_sw_reset\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE1_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(4),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_fw_reset\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE1_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(5),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_swb_wd\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE1_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(6),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_asic_thermal\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE1_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(7),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_system\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE2_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(1),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_sw_pwr_off\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE2_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(2),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_cpu_pwr_fail_thermal\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE2_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(4),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_reload_bios\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE2_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(5),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"reset_ac_pwr_fail\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE2_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(6),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"psu1\",\n\t\t.reg = NVSW_SN2201_PS_PRSNT_STATUS_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(0),\n\t\t.mode = 0444,\n\t},\n\t{\n\t\t.label = \"psu2\",\n\t\t.reg = NVSW_SN2201_PS_PRSNT_STATUS_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(1),\n\t\t.mode = 0444,\n\t},\n};\n\nstatic struct mlxreg_core_platform_data nvsw_sn2201_regs_io = {\n\t.data = nvsw_sn2201_io_data,\n\t.counter = ARRAY_SIZE(nvsw_sn2201_io_data),\n};\n\n \nstatic struct mlxreg_core_data nvsw_sn2201_wd_data[] = {\n\t{\n\t\t.label = \"action\",\n\t\t.reg = NVSW_SN2201_WD_ACT_OFFSET,\n\t\t.mask = GENMASK(7, 1),\n\t\t.bit = 0,\n\t},\n\t{\n\t\t.label = \"timeout\",\n\t\t.reg = NVSW_SN2201_WD_TMR_OFFSET_LSB,\n\t\t.mask = 0,\n\t\t.health_cntr = NVSW_SN2201_WD_DFLT_TIMEOUT,\n\t},\n\t{\n\t\t.label = \"timeleft\",\n\t\t.reg = NVSW_SN2201_WD_TMR_OFFSET_LSB,\n\t\t.mask = 0,\n\t},\n\t{\n\t\t.label = \"ping\",\n\t\t.reg = NVSW_SN2201_WD_ACT_OFFSET,\n\t\t.mask = GENMASK(7, 1),\n\t\t.bit = 0,\n\t},\n\t{\n\t\t.label = \"reset\",\n\t\t.reg = NVSW_SN2201_RST_CAUSE1_OFFSET,\n\t\t.mask = GENMASK(7, 0) & ~BIT(6),\n\t\t.bit = 6,\n\t},\n};\n\nstatic struct mlxreg_core_platform_data nvsw_sn2201_wd = {\n\t.data = nvsw_sn2201_wd_data,\n\t.counter = ARRAY_SIZE(nvsw_sn2201_wd_data),\n\t.version = MLX_WDT_TYPE3,\n\t.identity = \"mlx-wdt-main\",\n};\n\nstatic int\nnvsw_sn2201_create_static_devices(struct nvsw_sn2201 *nvsw_sn2201,\n\t\t\t\t  struct mlxreg_hotplug_device *devs,\n\t\t\t\t  int size)\n{\n\tstruct mlxreg_hotplug_device *dev = devs;\n\tint ret;\n\tint i;\n\n\t \n\tfor (i = 0; i < size; i++, dev++) {\n\t\tdev->client = i2c_new_client_device(dev->adapter, dev->brdinfo);\n\t\tif (IS_ERR(dev->client)) {\n\t\t\tdev_err(nvsw_sn2201->dev, \"Failed to create client %s at bus %d at addr 0x%02x\\n\",\n\t\t\t\tdev->brdinfo->type,\n\t\t\t\tdev->nr, dev->brdinfo->addr);\n\n\t\t\tdev->adapter = NULL;\n\t\t\tret = PTR_ERR(dev->client);\n\t\t\tgoto fail_create_static_devices;\n\t\t}\n\t}\n\n\treturn 0;\n\nfail_create_static_devices:\n\twhile (--i >= 0) {\n\t\tdev = devs + i;\n\t\ti2c_unregister_device(dev->client);\n\t\tdev->client = NULL;\n\t\tdev->adapter = NULL;\n\t}\n\treturn ret;\n}\n\nstatic void nvsw_sn2201_destroy_static_devices(struct nvsw_sn2201 *nvsw_sn2201,\n\t\t\t\t\t       struct mlxreg_hotplug_device *devs, int size)\n{\n\tstruct mlxreg_hotplug_device *dev = devs;\n\tint i;\n\n\t \n\tfor (i = 0; i < size; i++, dev++) {\n\t\tif (dev->client) {\n\t\t\ti2c_unregister_device(dev->client);\n\t\t\tdev->client = NULL;\n\t\t\ti2c_put_adapter(dev->adapter);\n\t\t\tdev->adapter = NULL;\n\t\t}\n\t}\n}\n\nstatic int nvsw_sn2201_config_post_init(struct nvsw_sn2201 *nvsw_sn2201)\n{\n\tstruct mlxreg_hotplug_device *sn2201_dev;\n\tstruct i2c_adapter *adap;\n\tstruct device *dev;\n\tint i, err;\n\n\tdev = nvsw_sn2201->dev;\n\tadap = i2c_get_adapter(nvsw_sn2201->main_mux_deferred_nr);\n\tif (!adap) {\n\t\tdev_err(dev, \"Failed to get adapter for bus %d\\n\",\n\t\t\tnvsw_sn2201->main_mux_deferred_nr);\n\t\treturn -ENODEV;\n\t}\n\ti2c_put_adapter(adap);\n\n\t \n\tsn2201_dev = nvsw_sn2201->sn2201_devs;\n\tfor (i = 0; i < nvsw_sn2201->sn2201_devs_num; i++, sn2201_dev++) {\n\t\tsn2201_dev->adapter = i2c_get_adapter(sn2201_dev->nr);\n\t\tif (!sn2201_dev->adapter)\n\t\t\treturn -ENODEV;\n\t\ti2c_put_adapter(sn2201_dev->adapter);\n\t}\n\n\terr = nvsw_sn2201_create_static_devices(nvsw_sn2201, nvsw_sn2201->sn2201_devs,\n\t\t\t\t\t\tnvsw_sn2201->sn2201_devs_num);\n\tif (err)\n\t\tdev_err(dev, \"Failed to create static devices\\n\");\n\n\treturn err;\n}\n\nstatic int nvsw_sn2201_config_init(struct nvsw_sn2201 *nvsw_sn2201, void *regmap)\n{\n\tstruct device *dev = nvsw_sn2201->dev;\n\tint err;\n\n\tnvsw_sn2201->io_data = &nvsw_sn2201_regs_io;\n\tnvsw_sn2201->led_data = &nvsw_sn2201_led;\n\tnvsw_sn2201->wd_data = &nvsw_sn2201_wd;\n\tnvsw_sn2201->hotplug_data = &nvsw_sn2201_hotplug;\n\n\t \n\tif (nvsw_sn2201->io_data) {\n\t\tnvsw_sn2201->io_data->regmap = regmap;\n\t\tnvsw_sn2201->io_regs =\n\t\tplatform_device_register_resndata(dev, \"mlxreg-io\", PLATFORM_DEVID_NONE, NULL, 0,\n\t\t\t\t\t\t  nvsw_sn2201->io_data,\n\t\t\t\t\t\t  sizeof(*nvsw_sn2201->io_data));\n\t\tif (IS_ERR(nvsw_sn2201->io_regs)) {\n\t\t\terr = PTR_ERR(nvsw_sn2201->io_regs);\n\t\t\tgoto fail_register_io;\n\t\t}\n\t}\n\n\t \n\tif (nvsw_sn2201->led_data) {\n\t\tnvsw_sn2201->led_data->regmap = regmap;\n\t\tnvsw_sn2201->led =\n\t\tplatform_device_register_resndata(dev, \"leds-mlxreg\", PLATFORM_DEVID_NONE, NULL, 0,\n\t\t\t\t\t\t  nvsw_sn2201->led_data,\n\t\t\t\t\t\t  sizeof(*nvsw_sn2201->led_data));\n\t\tif (IS_ERR(nvsw_sn2201->led)) {\n\t\t\terr = PTR_ERR(nvsw_sn2201->led);\n\t\t\tgoto fail_register_led;\n\t\t}\n\t}\n\n\t \n\tif (nvsw_sn2201->wd_data) {\n\t\tnvsw_sn2201->wd_data->regmap = regmap;\n\t\tnvsw_sn2201->wd =\n\t\tplatform_device_register_resndata(dev, \"mlx-wdt\", PLATFORM_DEVID_NONE, NULL, 0,\n\t\t\t\t\t\t  nvsw_sn2201->wd_data,\n\t\t\t\t\t\t  sizeof(*nvsw_sn2201->wd_data));\n\t\tif (IS_ERR(nvsw_sn2201->wd)) {\n\t\t\terr = PTR_ERR(nvsw_sn2201->wd);\n\t\t\tgoto fail_register_wd;\n\t\t}\n\t}\n\n\t \n\tif (nvsw_sn2201->hotplug_data) {\n\t\tnvsw_sn2201->hotplug_data->regmap = regmap;\n\t\tnvsw_sn2201->pdev_hotplug =\n\t\tplatform_device_register_resndata(dev, \"mlxreg-hotplug\", PLATFORM_DEVID_NONE,\n\t\t\t\t\t\t  nvsw_sn2201_cpld_res,\n\t\t\t\t\t\t  ARRAY_SIZE(nvsw_sn2201_cpld_res),\n\t\t\t\t\t\t  nvsw_sn2201->hotplug_data,\n\t\t\t\t\t\t  sizeof(*nvsw_sn2201->hotplug_data));\n\t\tif (IS_ERR(nvsw_sn2201->pdev_hotplug)) {\n\t\t\terr = PTR_ERR(nvsw_sn2201->pdev_hotplug);\n\t\t\tgoto fail_register_hotplug;\n\t\t}\n\t}\n\n\treturn nvsw_sn2201_config_post_init(nvsw_sn2201);\n\nfail_register_hotplug:\n\tif (nvsw_sn2201->wd)\n\t\tplatform_device_unregister(nvsw_sn2201->wd);\nfail_register_wd:\n\tif (nvsw_sn2201->led)\n\t\tplatform_device_unregister(nvsw_sn2201->led);\nfail_register_led:\n\tif (nvsw_sn2201->io_regs)\n\t\tplatform_device_unregister(nvsw_sn2201->io_regs);\nfail_register_io:\n\n\treturn err;\n}\n\nstatic void nvsw_sn2201_config_exit(struct nvsw_sn2201 *nvsw_sn2201)\n{\n\t \n\tif (nvsw_sn2201->pdev_hotplug)\n\t\tplatform_device_unregister(nvsw_sn2201->pdev_hotplug);\n\t \n\tif (nvsw_sn2201->wd)\n\t\tplatform_device_unregister(nvsw_sn2201->wd);\n\t \n\tif (nvsw_sn2201->led)\n\t\tplatform_device_unregister(nvsw_sn2201->led);\n\t \n\tif (nvsw_sn2201->io_regs)\n\t\tplatform_device_unregister(nvsw_sn2201->io_regs);\n}\n\n \nstatic int nvsw_sn2201_i2c_completion_notify(void *handle, int id)\n{\n\tstruct nvsw_sn2201 *nvsw_sn2201 = handle;\n\tvoid *regmap;\n\tint i, err;\n\n\t \n\tnvsw_sn2201->main_mux_devs->adapter = i2c_get_adapter(nvsw_sn2201->main_mux_devs->nr);\n\tif (!nvsw_sn2201->main_mux_devs->adapter) {\n\t\terr = -ENODEV;\n\t\tdev_err(nvsw_sn2201->dev, \"Failed to get adapter for bus %d\\n\",\n\t\t\tnvsw_sn2201->cpld_devs->nr);\n\t\tgoto i2c_get_adapter_main_fail;\n\t}\n\n\tnvsw_sn2201->main_mux_devs_num = ARRAY_SIZE(nvsw_sn2201_main_mux_brdinfo);\n\terr = nvsw_sn2201_create_static_devices(nvsw_sn2201, nvsw_sn2201->main_mux_devs,\n\t\t\t\t\t\tnvsw_sn2201->main_mux_devs_num);\n\tif (err) {\n\t\tdev_err(nvsw_sn2201->dev, \"Failed to create main mux devices\\n\");\n\t\tgoto nvsw_sn2201_create_static_devices_fail;\n\t}\n\n\tnvsw_sn2201->cpld_devs->adapter = i2c_get_adapter(nvsw_sn2201->cpld_devs->nr);\n\tif (!nvsw_sn2201->cpld_devs->adapter) {\n\t\terr = -ENODEV;\n\t\tdev_err(nvsw_sn2201->dev, \"Failed to get adapter for bus %d\\n\",\n\t\t\tnvsw_sn2201->cpld_devs->nr);\n\t\tgoto i2c_get_adapter_fail;\n\t}\n\n\t \n\tnvsw_sn2201->cpld_devs->client = i2c_new_dummy_device(nvsw_sn2201->cpld_devs->adapter,\n\t\t\t\t\t\t\t      NVSW_SN2201_CPLD_I2CADDR);\n\tif (IS_ERR(nvsw_sn2201->cpld_devs->client)) {\n\t\terr = PTR_ERR(nvsw_sn2201->cpld_devs->client);\n\t\tdev_err(nvsw_sn2201->dev, \"Failed to create %s cpld device at bus %d at addr 0x%02x\\n\",\n\t\t\tnvsw_sn2201->cpld_devs->brdinfo->type, nvsw_sn2201->cpld_devs->nr,\n\t\t\tnvsw_sn2201->cpld_devs->brdinfo->addr);\n\t\tgoto i2c_new_dummy_fail;\n\t}\n\n\tregmap = devm_regmap_init_i2c(nvsw_sn2201->cpld_devs->client, &nvsw_sn2201_regmap_conf);\n\tif (IS_ERR(regmap)) {\n\t\terr = PTR_ERR(regmap);\n\t\tdev_err(nvsw_sn2201->dev, \"Failed to initialise managed register map\\n\");\n\t\tgoto devm_regmap_init_i2c_fail;\n\t}\n\n\t \n\tfor (i = 0; i < nvsw_sn2201_regmap_conf.num_reg_defaults; i++) {\n\t\terr = regmap_write(regmap, nvsw_sn2201_regmap_default[i].reg,\n\t\t\t\t   nvsw_sn2201_regmap_default[i].def);\n\t\tif (err) {\n\t\t\tdev_err(nvsw_sn2201->dev, \"Failed to set register at offset 0x%02x to default value: 0x%02x\\n\",\n\t\t\t\tnvsw_sn2201_regmap_default[i].reg,\n\t\t\t\tnvsw_sn2201_regmap_default[i].def);\n\t\t\tgoto regmap_write_fail;\n\t\t}\n\t}\n\n\t \n\tregcache_mark_dirty(regmap);\n\terr = regcache_sync(regmap);\n\tif (err) {\n\t\tdev_err(nvsw_sn2201->dev, \"Failed to Sync registers with hardware\\n\");\n\t\tgoto regcache_sync_fail;\n\t}\n\n\t \n\terr = nvsw_sn2201_config_init(nvsw_sn2201, regmap);\n\tif (err) {\n\t\tdev_err(nvsw_sn2201->dev, \"Failed to configure board\\n\");\n\t\tgoto nvsw_sn2201_config_init_fail;\n\t}\n\n\treturn 0;\n\nnvsw_sn2201_config_init_fail:\n\tnvsw_sn2201_config_exit(nvsw_sn2201);\nregcache_sync_fail:\nregmap_write_fail:\ndevm_regmap_init_i2c_fail:\ni2c_new_dummy_fail:\n\ti2c_put_adapter(nvsw_sn2201->cpld_devs->adapter);\n\tnvsw_sn2201->cpld_devs->adapter = NULL;\ni2c_get_adapter_fail:\n\t \n\tnvsw_sn2201_destroy_static_devices(nvsw_sn2201, nvsw_sn2201->sn2201_devs,\n\t\t\t\t\t   nvsw_sn2201->sn2201_devs_num);\n\t \n\tnvsw_sn2201_destroy_static_devices(nvsw_sn2201, nvsw_sn2201->main_mux_devs,\n\t\t\t\t\t   nvsw_sn2201->main_mux_devs_num);\nnvsw_sn2201_create_static_devices_fail:\n\ti2c_put_adapter(nvsw_sn2201->main_mux_devs->adapter);\ni2c_get_adapter_main_fail:\n\treturn err;\n}\n\nstatic int nvsw_sn2201_config_pre_init(struct nvsw_sn2201 *nvsw_sn2201)\n{\n\tnvsw_sn2201->i2c_data = &nvsw_sn2201_i2c_data;\n\n\t \n\tnvsw_sn2201->i2c_data->handle = nvsw_sn2201;\n\tnvsw_sn2201->i2c_data->completion_notify = nvsw_sn2201_i2c_completion_notify;\n\tnvsw_sn2201->pdev_i2c = platform_device_register_resndata(nvsw_sn2201->dev, \"i2c_mlxcpld\",\n\t\t\t\t\t\t\t\t  NVSW_SN2201_MAIN_MUX_NR,\n\t\t\t\t\t\t\t\t  nvsw_sn2201_lpc_res,\n\t\t\t\t\t\t\t\t  ARRAY_SIZE(nvsw_sn2201_lpc_res),\n\t\t\t\t\t\t\t\t  nvsw_sn2201->i2c_data,\n\t\t\t\t\t\t\t\t  sizeof(*nvsw_sn2201->i2c_data));\n\tif (IS_ERR(nvsw_sn2201->pdev_i2c))\n\t\treturn PTR_ERR(nvsw_sn2201->pdev_i2c);\n\n\treturn 0;\n}\n\nstatic int nvsw_sn2201_probe(struct platform_device *pdev)\n{\n\tstruct nvsw_sn2201 *nvsw_sn2201;\n\n\tnvsw_sn2201 = devm_kzalloc(&pdev->dev, sizeof(*nvsw_sn2201), GFP_KERNEL);\n\tif (!nvsw_sn2201)\n\t\treturn -ENOMEM;\n\n\tnvsw_sn2201->dev = &pdev->dev;\n\tplatform_set_drvdata(pdev, nvsw_sn2201);\n\tplatform_device_add_resources(pdev, nvsw_sn2201_lpc_io_resources,\n\t\t\t\t      ARRAY_SIZE(nvsw_sn2201_lpc_io_resources));\n\n\tnvsw_sn2201->main_mux_deferred_nr = NVSW_SN2201_MAIN_MUX_DEFER_NR;\n\tnvsw_sn2201->main_mux_devs = nvsw_sn2201_main_mux_brdinfo;\n\tnvsw_sn2201->cpld_devs = nvsw_sn2201_cpld_brdinfo;\n\tnvsw_sn2201->sn2201_devs = nvsw_sn2201_static_brdinfo;\n\tnvsw_sn2201->sn2201_devs_num = ARRAY_SIZE(nvsw_sn2201_static_brdinfo);\n\n\treturn nvsw_sn2201_config_pre_init(nvsw_sn2201);\n}\n\nstatic int nvsw_sn2201_remove(struct platform_device *pdev)\n{\n\tstruct nvsw_sn2201 *nvsw_sn2201 = platform_get_drvdata(pdev);\n\n\t \n\tnvsw_sn2201_config_exit(nvsw_sn2201);\n\n\t \n\tnvsw_sn2201_destroy_static_devices(nvsw_sn2201,\n\t\t\t\t\t   nvsw_sn2201->sn2201_devs,\n\t\t\t\t\t   nvsw_sn2201->sn2201_devs_num);\n\n\ti2c_put_adapter(nvsw_sn2201->cpld_devs->adapter);\n\tnvsw_sn2201->cpld_devs->adapter = NULL;\n\t \n\tnvsw_sn2201_destroy_static_devices(nvsw_sn2201,\n\t\t\t\t\t   nvsw_sn2201->main_mux_devs,\n\t\t\t\t\t   nvsw_sn2201->main_mux_devs_num);\n\n\t \n\tif (nvsw_sn2201->pdev_i2c)\n\t\tplatform_device_unregister(nvsw_sn2201->pdev_i2c);\n\n\treturn 0;\n}\n\nstatic const struct acpi_device_id nvsw_sn2201_acpi_ids[] = {\n\t{\"NVSN2201\", 0},\n\t{}\n};\n\nMODULE_DEVICE_TABLE(acpi, nvsw_sn2201_acpi_ids);\n\nstatic struct platform_driver nvsw_sn2201_driver = {\n\t.probe = nvsw_sn2201_probe,\n\t.remove = nvsw_sn2201_remove,\n\t.driver = {\n\t\t.name = \"nvsw-sn2201\",\n\t.acpi_match_table = nvsw_sn2201_acpi_ids,\n\t},\n};\n\nmodule_platform_driver(nvsw_sn2201_driver);\n\nMODULE_AUTHOR(\"Nvidia\");\nMODULE_DESCRIPTION(\"Nvidia sn2201 platform driver\");\nMODULE_LICENSE(\"Dual BSD/GPL\");\nMODULE_ALIAS(\"platform:nvsw-sn2201\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}