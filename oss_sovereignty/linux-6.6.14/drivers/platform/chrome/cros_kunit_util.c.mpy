{
  "module_name": "cros_kunit_util.c",
  "hash_id": "4168b49b08b48e579a1e310e7af63632e483ec2d9fed90eff36d98fa30744521",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/chrome/cros_kunit_util.c",
  "human_readable_source": "\n \n\n#include <kunit/test.h>\n\n#include <linux/list.h>\n#include <linux/minmax.h>\n#include <linux/platform_data/cros_ec_commands.h>\n#include <linux/platform_data/cros_ec_proto.h>\n\n#include \"cros_ec.h\"\n#include \"cros_kunit_util.h\"\n\nint cros_kunit_ec_xfer_mock_default_result;\nint cros_kunit_ec_xfer_mock_default_ret;\nint cros_kunit_ec_cmd_xfer_mock_called;\nint cros_kunit_ec_pkt_xfer_mock_called;\n\nstatic struct list_head cros_kunit_ec_xfer_mock_in;\nstatic struct list_head cros_kunit_ec_xfer_mock_out;\n\nint cros_kunit_ec_xfer_mock(struct cros_ec_device *ec_dev, struct cros_ec_command *msg)\n{\n\tstruct ec_xfer_mock *mock;\n\n\tmock = list_first_entry_or_null(&cros_kunit_ec_xfer_mock_in, struct ec_xfer_mock, list);\n\tif (!mock) {\n\t\tmsg->result = cros_kunit_ec_xfer_mock_default_result;\n\t\treturn cros_kunit_ec_xfer_mock_default_ret;\n\t}\n\n\tlist_del(&mock->list);\n\n\tmemcpy(&mock->msg, msg, sizeof(*msg));\n\tif (msg->outsize) {\n\t\tmock->i_data = kunit_kzalloc(mock->test, msg->outsize, GFP_KERNEL);\n\t\tif (mock->i_data)\n\t\t\tmemcpy(mock->i_data, msg->data, msg->outsize);\n\t}\n\n\tmsg->result = mock->result;\n\tif (msg->insize)\n\t\tmemcpy(msg->data, mock->o_data, min(msg->insize, mock->o_data_len));\n\n\tlist_add_tail(&mock->list, &cros_kunit_ec_xfer_mock_out);\n\n\treturn mock->ret;\n}\n\nint cros_kunit_ec_cmd_xfer_mock(struct cros_ec_device *ec_dev, struct cros_ec_command *msg)\n{\n\t++cros_kunit_ec_cmd_xfer_mock_called;\n\treturn cros_kunit_ec_xfer_mock(ec_dev, msg);\n}\n\nint cros_kunit_ec_pkt_xfer_mock(struct cros_ec_device *ec_dev, struct cros_ec_command *msg)\n{\n\t++cros_kunit_ec_pkt_xfer_mock_called;\n\treturn cros_kunit_ec_xfer_mock(ec_dev, msg);\n}\n\nstruct ec_xfer_mock *cros_kunit_ec_xfer_mock_add(struct kunit *test, size_t size)\n{\n\treturn cros_kunit_ec_xfer_mock_addx(test, size, EC_RES_SUCCESS, size);\n}\n\nstruct ec_xfer_mock *cros_kunit_ec_xfer_mock_addx(struct kunit *test,\n\t\t\t\t\t\t  int ret, int result, size_t size)\n{\n\tstruct ec_xfer_mock *mock;\n\n\tmock = kunit_kzalloc(test, sizeof(*mock), GFP_KERNEL);\n\tif (!mock)\n\t\treturn NULL;\n\n\tlist_add_tail(&mock->list, &cros_kunit_ec_xfer_mock_in);\n\tmock->test = test;\n\n\tmock->ret = ret;\n\tmock->result = result;\n\tmock->o_data = kunit_kzalloc(test, size, GFP_KERNEL);\n\tif (!mock->o_data)\n\t\treturn NULL;\n\tmock->o_data_len = size;\n\n\treturn mock;\n}\n\nstruct ec_xfer_mock *cros_kunit_ec_xfer_mock_next(void)\n{\n\tstruct ec_xfer_mock *mock;\n\n\tmock = list_first_entry_or_null(&cros_kunit_ec_xfer_mock_out, struct ec_xfer_mock, list);\n\tif (mock)\n\t\tlist_del(&mock->list);\n\n\treturn mock;\n}\n\nint cros_kunit_readmem_mock_offset;\nu8 *cros_kunit_readmem_mock_data;\nint cros_kunit_readmem_mock_ret;\n\nint cros_kunit_readmem_mock(struct cros_ec_device *ec_dev, unsigned int offset,\n\t\t\t    unsigned int bytes, void *dest)\n{\n\tcros_kunit_readmem_mock_offset = offset;\n\n\tmemcpy(dest, cros_kunit_readmem_mock_data, bytes);\n\n\treturn cros_kunit_readmem_mock_ret;\n}\n\nvoid cros_kunit_mock_reset(void)\n{\n\tcros_kunit_ec_xfer_mock_default_result = 0;\n\tcros_kunit_ec_xfer_mock_default_ret = 0;\n\tcros_kunit_ec_cmd_xfer_mock_called = 0;\n\tcros_kunit_ec_pkt_xfer_mock_called = 0;\n\tINIT_LIST_HEAD(&cros_kunit_ec_xfer_mock_in);\n\tINIT_LIST_HEAD(&cros_kunit_ec_xfer_mock_out);\n\n\tcros_kunit_readmem_mock_offset = 0;\n\tcros_kunit_readmem_mock_data = NULL;\n\tcros_kunit_readmem_mock_ret = 0;\n}\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}