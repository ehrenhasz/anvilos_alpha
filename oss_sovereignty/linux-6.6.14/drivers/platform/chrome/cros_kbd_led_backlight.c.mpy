{
  "module_name": "cros_kbd_led_backlight.c",
  "hash_id": "bbf8b3a976170aa1d343c76cc1eff103fcae31d364ece42be390746721e917b5",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/chrome/cros_kbd_led_backlight.c",
  "human_readable_source": "\n\n\n\n\n#include <linux/acpi.h>\n#include <linux/delay.h>\n#include <linux/err.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/leds.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/platform_data/cros_ec_commands.h>\n#include <linux/platform_data/cros_ec_proto.h>\n#include <linux/platform_device.h>\n#include <linux/property.h>\n#include <linux/slab.h>\n\nstruct keyboard_led {\n\tstruct led_classdev cdev;\n\tstruct cros_ec_device *ec;\n};\n\n \nstruct keyboard_led_drvdata {\n\tint (*init)(struct platform_device *pdev);\n\n\tenum led_brightness (*brightness_get)(struct led_classdev *led_cdev);\n\n\tvoid (*brightness_set)(struct led_classdev *led_cdev,\n\t\t\t       enum led_brightness brightness);\n\tint (*brightness_set_blocking)(struct led_classdev *led_cdev,\n\t\t\t\t       enum led_brightness brightness);\n\n\tenum led_brightness max_brightness;\n};\n\n#define KEYBOARD_BACKLIGHT_MAX 100\n\n#ifdef CONFIG_ACPI\n\n \n#define ACPI_KEYBOARD_BACKLIGHT_DEVICE\t\"\\\\_SB.KBLT\"\n#define ACPI_KEYBOARD_BACKLIGHT_READ\tACPI_KEYBOARD_BACKLIGHT_DEVICE \".KBQC\"\n#define ACPI_KEYBOARD_BACKLIGHT_WRITE\tACPI_KEYBOARD_BACKLIGHT_DEVICE \".KBCM\"\n\nstatic void keyboard_led_set_brightness_acpi(struct led_classdev *cdev,\n\t\t\t\t\t     enum led_brightness brightness)\n{\n\tunion acpi_object param;\n\tstruct acpi_object_list input;\n\tacpi_status status;\n\n\tparam.type = ACPI_TYPE_INTEGER;\n\tparam.integer.value = brightness;\n\tinput.count = 1;\n\tinput.pointer = &param;\n\n\tstatus = acpi_evaluate_object(NULL, ACPI_KEYBOARD_BACKLIGHT_WRITE,\n\t\t\t\t      &input, NULL);\n\tif (ACPI_FAILURE(status))\n\t\tdev_err(cdev->dev, \"Error setting keyboard LED value: %d\\n\",\n\t\t\tstatus);\n}\n\nstatic enum led_brightness\nkeyboard_led_get_brightness_acpi(struct led_classdev *cdev)\n{\n\tunsigned long long brightness;\n\tacpi_status status;\n\n\tstatus = acpi_evaluate_integer(NULL, ACPI_KEYBOARD_BACKLIGHT_READ,\n\t\t\t\t       NULL, &brightness);\n\tif (ACPI_FAILURE(status)) {\n\t\tdev_err(cdev->dev, \"Error getting keyboard LED value: %d\\n\",\n\t\t\tstatus);\n\t\treturn -EIO;\n\t}\n\n\treturn brightness;\n}\n\nstatic int keyboard_led_init_acpi(struct platform_device *pdev)\n{\n\tacpi_handle handle;\n\tacpi_status status;\n\n\t \n\tstatus = acpi_get_handle(ACPI_ROOT_OBJECT,\n\t\t\t\t ACPI_KEYBOARD_BACKLIGHT_DEVICE,\n\t\t\t\t &handle);\n\tif (ACPI_FAILURE(status)) {\n\t\tdev_err(&pdev->dev, \"Unable to find ACPI device %s: %d\\n\",\n\t\t\tACPI_KEYBOARD_BACKLIGHT_DEVICE, status);\n\t\treturn -ENXIO;\n\t}\n\n\treturn 0;\n}\n\nstatic const struct keyboard_led_drvdata keyboard_led_drvdata_acpi = {\n\t.init = keyboard_led_init_acpi,\n\t.brightness_set = keyboard_led_set_brightness_acpi,\n\t.brightness_get = keyboard_led_get_brightness_acpi,\n\t.max_brightness = KEYBOARD_BACKLIGHT_MAX,\n};\n\n#endif  \n\n#if IS_ENABLED(CONFIG_CROS_EC)\n\nstatic int\nkeyboard_led_set_brightness_ec_pwm(struct led_classdev *cdev,\n\t\t\t\t   enum led_brightness brightness)\n{\n\tstruct {\n\t\tstruct cros_ec_command msg;\n\t\tstruct ec_params_pwm_set_keyboard_backlight params;\n\t} __packed buf;\n\tstruct ec_params_pwm_set_keyboard_backlight *params = &buf.params;\n\tstruct cros_ec_command *msg = &buf.msg;\n\tstruct keyboard_led *keyboard_led = container_of(cdev, struct keyboard_led, cdev);\n\n\tmemset(&buf, 0, sizeof(buf));\n\n\tmsg->command = EC_CMD_PWM_SET_KEYBOARD_BACKLIGHT;\n\tmsg->outsize = sizeof(*params);\n\n\tparams->percent = brightness;\n\n\treturn cros_ec_cmd_xfer_status(keyboard_led->ec, msg);\n}\n\nstatic enum led_brightness\nkeyboard_led_get_brightness_ec_pwm(struct led_classdev *cdev)\n{\n\tstruct {\n\t\tstruct cros_ec_command msg;\n\t\tstruct ec_response_pwm_get_keyboard_backlight resp;\n\t} __packed buf;\n\tstruct ec_response_pwm_get_keyboard_backlight *resp = &buf.resp;\n\tstruct cros_ec_command *msg = &buf.msg;\n\tstruct keyboard_led *keyboard_led = container_of(cdev, struct keyboard_led, cdev);\n\tint ret;\n\n\tmemset(&buf, 0, sizeof(buf));\n\n\tmsg->command = EC_CMD_PWM_GET_KEYBOARD_BACKLIGHT;\n\tmsg->insize = sizeof(*resp);\n\n\tret = cros_ec_cmd_xfer_status(keyboard_led->ec, msg);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn resp->percent;\n}\n\nstatic int keyboard_led_init_ec_pwm(struct platform_device *pdev)\n{\n\tstruct keyboard_led *keyboard_led = platform_get_drvdata(pdev);\n\n\tkeyboard_led->ec = dev_get_drvdata(pdev->dev.parent);\n\tif (!keyboard_led->ec) {\n\t\tdev_err(&pdev->dev, \"no parent EC device\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\treturn 0;\n}\n\nstatic const __maybe_unused struct keyboard_led_drvdata keyboard_led_drvdata_ec_pwm = {\n\t.init = keyboard_led_init_ec_pwm,\n\t.brightness_set_blocking = keyboard_led_set_brightness_ec_pwm,\n\t.brightness_get = keyboard_led_get_brightness_ec_pwm,\n\t.max_brightness = KEYBOARD_BACKLIGHT_MAX,\n};\n\n#else  \n\nstatic const __maybe_unused struct keyboard_led_drvdata keyboard_led_drvdata_ec_pwm = {};\n\n#endif  \n\nstatic int keyboard_led_probe(struct platform_device *pdev)\n{\n\tconst struct keyboard_led_drvdata *drvdata;\n\tstruct keyboard_led *keyboard_led;\n\tint error;\n\n\tdrvdata = device_get_match_data(&pdev->dev);\n\tif (!drvdata)\n\t\treturn -EINVAL;\n\n\tkeyboard_led = devm_kzalloc(&pdev->dev, sizeof(*keyboard_led), GFP_KERNEL);\n\tif (!keyboard_led)\n\t\treturn -ENOMEM;\n\tplatform_set_drvdata(pdev, keyboard_led);\n\n\tif (drvdata->init) {\n\t\terror = drvdata->init(pdev);\n\t\tif (error)\n\t\t\treturn error;\n\t}\n\n\tkeyboard_led->cdev.name = \"chromeos::kbd_backlight\";\n\tkeyboard_led->cdev.flags |= LED_CORE_SUSPENDRESUME;\n\tkeyboard_led->cdev.max_brightness = drvdata->max_brightness;\n\tkeyboard_led->cdev.brightness_set = drvdata->brightness_set;\n\tkeyboard_led->cdev.brightness_set_blocking = drvdata->brightness_set_blocking;\n\tkeyboard_led->cdev.brightness_get = drvdata->brightness_get;\n\n\terror = devm_led_classdev_register(&pdev->dev, &keyboard_led->cdev);\n\tif (error)\n\t\treturn error;\n\n\treturn 0;\n}\n\n#ifdef CONFIG_ACPI\nstatic const struct acpi_device_id keyboard_led_acpi_match[] = {\n\t{ \"GOOG0002\", (kernel_ulong_t)&keyboard_led_drvdata_acpi },\n\t{ }\n};\nMODULE_DEVICE_TABLE(acpi, keyboard_led_acpi_match);\n#endif\n\n#ifdef CONFIG_OF\nstatic const struct of_device_id keyboard_led_of_match[] = {\n\t{\n\t\t.compatible = \"google,cros-kbd-led-backlight\",\n\t\t.data = &keyboard_led_drvdata_ec_pwm,\n\t},\n\t{}\n};\nMODULE_DEVICE_TABLE(of, keyboard_led_of_match);\n#endif\n\nstatic struct platform_driver keyboard_led_driver = {\n\t.driver\t\t= {\n\t\t.name\t= \"chromeos-keyboard-leds\",\n\t\t.acpi_match_table = ACPI_PTR(keyboard_led_acpi_match),\n\t\t.of_match_table = of_match_ptr(keyboard_led_of_match),\n\t},\n\t.probe\t\t= keyboard_led_probe,\n};\nmodule_platform_driver(keyboard_led_driver);\n\nMODULE_AUTHOR(\"Simon Que <sque@chromium.org>\");\nMODULE_DESCRIPTION(\"ChromeOS Keyboard backlight LED Driver\");\nMODULE_LICENSE(\"GPL\");\nMODULE_ALIAS(\"platform:chromeos-keyboard-leds\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}