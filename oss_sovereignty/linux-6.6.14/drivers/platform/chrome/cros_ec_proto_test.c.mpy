{
  "module_name": "cros_ec_proto_test.c",
  "hash_id": "fb350a8b9786be5426cbd35c098944ed85a400f6f78241a81823389b85136751",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/chrome/cros_ec_proto_test.c",
  "human_readable_source": "\n \n\n#include <kunit/test.h>\n\n#include <asm/unaligned.h>\n\n#include <linux/platform_data/cros_ec_commands.h>\n#include <linux/platform_data/cros_ec_proto.h>\n\n#include \"cros_ec.h\"\n#include \"cros_kunit_util.h\"\n\n#define BUFSIZE 512\n\nstruct cros_ec_proto_test_priv {\n\tstruct cros_ec_device ec_dev;\n\tu8 dout[BUFSIZE];\n\tu8 din[BUFSIZE];\n\tstruct cros_ec_command *msg;\n\tu8 _msg[BUFSIZE];\n};\n\nstatic void cros_ec_proto_test_prepare_tx_legacy_normal(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct cros_ec_command *msg = priv->msg;\n\tint ret, i;\n\tu8 csum;\n\n\tec_dev->proto_version = 2;\n\n\tmsg->command = EC_CMD_HELLO;\n\tmsg->outsize = EC_PROTO2_MAX_PARAM_SIZE;\n\tmsg->data[0] = 0xde;\n\tmsg->data[1] = 0xad;\n\tmsg->data[2] = 0xbe;\n\tmsg->data[3] = 0xef;\n\n\tret = cros_ec_prepare_tx(ec_dev, msg);\n\n\tKUNIT_EXPECT_EQ(test, ret, EC_MSG_TX_PROTO_BYTES + EC_PROTO2_MAX_PARAM_SIZE);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[0], EC_CMD_VERSION0);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[1], EC_CMD_HELLO);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[2], EC_PROTO2_MAX_PARAM_SIZE);\n\tKUNIT_EXPECT_EQ(test, EC_MSG_TX_HEADER_BYTES, 3);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[EC_MSG_TX_HEADER_BYTES + 0], 0xde);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[EC_MSG_TX_HEADER_BYTES + 1], 0xad);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[EC_MSG_TX_HEADER_BYTES + 2], 0xbe);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[EC_MSG_TX_HEADER_BYTES + 3], 0xef);\n\tfor (i = 4; i < EC_PROTO2_MAX_PARAM_SIZE; ++i)\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->dout[EC_MSG_TX_HEADER_BYTES + i], 0);\n\n\tcsum = EC_CMD_VERSION0;\n\tcsum += EC_CMD_HELLO;\n\tcsum += EC_PROTO2_MAX_PARAM_SIZE;\n\tcsum += 0xde;\n\tcsum += 0xad;\n\tcsum += 0xbe;\n\tcsum += 0xef;\n\tKUNIT_EXPECT_EQ(test,\n\t\t\tec_dev->dout[EC_MSG_TX_HEADER_BYTES + EC_PROTO2_MAX_PARAM_SIZE],\n\t\t\tcsum);\n}\n\nstatic void cros_ec_proto_test_prepare_tx_legacy_bad_msg_outsize(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct cros_ec_command *msg = priv->msg;\n\tint ret;\n\n\tec_dev->proto_version = 2;\n\n\tmsg->outsize = EC_PROTO2_MAX_PARAM_SIZE + 1;\n\n\tret = cros_ec_prepare_tx(ec_dev, msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EINVAL);\n}\n\nstatic void cros_ec_proto_test_prepare_tx_normal(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct cros_ec_command *msg = priv->msg;\n\tstruct ec_host_request *request = (struct ec_host_request *)ec_dev->dout;\n\tint ret, i;\n\tu8 csum;\n\n\tmsg->command = EC_CMD_HELLO;\n\tmsg->outsize = 0x88;\n\tmsg->data[0] = 0xde;\n\tmsg->data[1] = 0xad;\n\tmsg->data[2] = 0xbe;\n\tmsg->data[3] = 0xef;\n\n\tret = cros_ec_prepare_tx(ec_dev, msg);\n\n\tKUNIT_EXPECT_EQ(test, ret, sizeof(*request) + 0x88);\n\n\tKUNIT_EXPECT_EQ(test, request->struct_version, EC_HOST_REQUEST_VERSION);\n\tKUNIT_EXPECT_EQ(test, request->command, EC_CMD_HELLO);\n\tKUNIT_EXPECT_EQ(test, request->command_version, 0);\n\tKUNIT_EXPECT_EQ(test, request->data_len, 0x88);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[sizeof(*request) + 0], 0xde);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[sizeof(*request) + 1], 0xad);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[sizeof(*request) + 2], 0xbe);\n\tKUNIT_EXPECT_EQ(test, ec_dev->dout[sizeof(*request) + 3], 0xef);\n\tfor (i = 4; i < 0x88; ++i)\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->dout[sizeof(*request) + i], 0);\n\n\tcsum = EC_HOST_REQUEST_VERSION;\n\tcsum += EC_CMD_HELLO;\n\tcsum += 0x88;\n\tcsum += 0xde;\n\tcsum += 0xad;\n\tcsum += 0xbe;\n\tcsum += 0xef;\n\tKUNIT_EXPECT_EQ(test, request->checksum, (u8)-csum);\n}\n\nstatic void cros_ec_proto_test_prepare_tx_bad_msg_outsize(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct cros_ec_command *msg = priv->msg;\n\tint ret;\n\n\tmsg->outsize = ec_dev->dout_size - sizeof(struct ec_host_request) + 1;\n\n\tret = cros_ec_prepare_tx(ec_dev, msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EINVAL);\n}\n\nstatic void cros_ec_proto_test_check_result(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct cros_ec_command *msg = priv->msg;\n\tint ret, i;\n\tstatic enum ec_status status[] = {\n\t\tEC_RES_SUCCESS,\n\t\tEC_RES_INVALID_COMMAND,\n\t\tEC_RES_ERROR,\n\t\tEC_RES_INVALID_PARAM,\n\t\tEC_RES_ACCESS_DENIED,\n\t\tEC_RES_INVALID_RESPONSE,\n\t\tEC_RES_INVALID_VERSION,\n\t\tEC_RES_INVALID_CHECKSUM,\n\t\tEC_RES_UNAVAILABLE,\n\t\tEC_RES_TIMEOUT,\n\t\tEC_RES_OVERFLOW,\n\t\tEC_RES_INVALID_HEADER,\n\t\tEC_RES_REQUEST_TRUNCATED,\n\t\tEC_RES_RESPONSE_TOO_BIG,\n\t\tEC_RES_BUS_ERROR,\n\t\tEC_RES_BUSY,\n\t\tEC_RES_INVALID_HEADER_VERSION,\n\t\tEC_RES_INVALID_HEADER_CRC,\n\t\tEC_RES_INVALID_DATA_CRC,\n\t\tEC_RES_DUP_UNAVAILABLE,\n\t};\n\n\tfor (i = 0; i < ARRAY_SIZE(status); ++i) {\n\t\tmsg->result = status[i];\n\t\tret = cros_ec_check_result(ec_dev, msg);\n\t\tKUNIT_EXPECT_EQ(test, ret, 0);\n\t}\n\n\tmsg->result = EC_RES_IN_PROGRESS;\n\tret = cros_ec_check_result(ec_dev, msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EAGAIN);\n}\n\nstatic void cros_ec_proto_test_query_all_pretest(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\n\t \n\tec_dev->din = NULL;\n\tec_dev->dout = NULL;\n}\n\nstatic void cros_ec_proto_test_query_all_normal(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->protocol_versions = BIT(3) | BIT(2);\n\t\tdata->max_request_packet_size = 0xbe;\n\t\tdata->max_response_packet_size = 0xef;\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->max_request_packet_size = 0xbf;\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_get_cmd_versions *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_cmd_versions *)mock->o_data;\n\t\tdata->version_mask = BIT(6) | BIT(5);\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_get_cmd_versions *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_cmd_versions *)mock->o_data;\n\t\tdata->version_mask = BIT(1);\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_host_event_mask *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_host_event_mask *)mock->o_data;\n\t\tdata->mask = 0xbeef;\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_request, 0xbe - sizeof(struct ec_host_request));\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_response, 0xef - sizeof(struct ec_host_response));\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->proto_version, 3);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->din_size, 0xef + EC_MAX_RESPONSE_OVERHEAD);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->dout_size, 0xbe + EC_MAX_REQUEST_OVERHEAD);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command,\n\t\t\t\tEC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) |\n\t\t\t\tEC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_passthru, 0xbf - sizeof(struct ec_host_request));\n\t}\n\n\t \n\t{\n\t\tstruct ec_params_get_cmd_versions *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(*data));\n\n\t\tdata = (struct ec_params_get_cmd_versions *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data->cmd, EC_CMD_GET_NEXT_EVENT);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->mkbp_event_supported, 7);\n\t}\n\n\t \n\t{\n\t\tstruct ec_params_get_cmd_versions *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(*data));\n\n\t\tdata = (struct ec_params_get_cmd_versions *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data->cmd, EC_CMD_HOST_SLEEP_EVENT);\n\n\t\tKUNIT_EXPECT_TRUE(test, ec_dev->host_sleep_v1);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HOST_EVENT_GET_WAKE_MASK);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_host_event_mask));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->host_event_wake_mask, 0xbeef);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_no_pd_return_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\tec_dev->max_passthru = 0xbf;\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t \n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->max_request_packet_size = 0xbe;\n\t\tdata->max_response_packet_size = 0xef;\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command,\n\t\t\t\tEC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) |\n\t\t\t\tEC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_passthru, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_no_pd_return0(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\tec_dev->max_passthru = 0xbf;\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t \n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->max_request_packet_size = 0xbe;\n\t\tdata->max_response_packet_size = 0xef;\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command,\n\t\t\t\tEC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) |\n\t\t\t\tEC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_passthru, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_legacy_normal_v3_return_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_hello *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_hello *)mock->o_data;\n\t\tdata->out_data = 0xa1b2c3d4;\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tstruct ec_params_hello *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HELLO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_hello));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(*data));\n\n\t\tdata = (struct ec_params_hello *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data->in_data, 0xa0b0c0d0);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->proto_version, 2);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_request, EC_PROTO2_MAX_PARAM_SIZE);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_response, EC_PROTO2_MAX_PARAM_SIZE);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_passthru, 0);\n\t\tKUNIT_EXPECT_PTR_EQ(test, ec_dev->pkt_xfer, NULL);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->din_size, EC_PROTO2_MSG_BYTES);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->dout_size, EC_PROTO2_MSG_BYTES);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_legacy_normal_v3_return0(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_hello *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_hello *)mock->o_data;\n\t\tdata->out_data = 0xa1b2c3d4;\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tstruct ec_params_hello *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HELLO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_hello));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(*data));\n\n\t\tdata = (struct ec_params_hello *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data->in_data, 0xa0b0c0d0);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->proto_version, 2);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_request, EC_PROTO2_MAX_PARAM_SIZE);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_response, EC_PROTO2_MAX_PARAM_SIZE);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->max_passthru, 0);\n\t\tKUNIT_EXPECT_PTR_EQ(test, ec_dev->pkt_xfer, NULL);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->din_size, EC_PROTO2_MSG_BYTES);\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->dout_size, EC_PROTO2_MSG_BYTES);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_legacy_xfer_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, -EIO, EC_RES_SUCCESS, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, -EIO);\n\tKUNIT_EXPECT_EQ(test, ec_dev->proto_version, EC_PROTO_VERSION_UNKNOWN);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HELLO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_hello));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_hello));\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_legacy_return_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, -EOPNOTSUPP);\n\tKUNIT_EXPECT_EQ(test, ec_dev->proto_version, EC_PROTO_VERSION_UNKNOWN);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HELLO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_hello));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_hello));\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_legacy_data_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_hello *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_hello *)mock->o_data;\n\t\tdata->out_data = 0xbeefbfbf;\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, -EBADMSG);\n\tKUNIT_EXPECT_EQ(test, ec_dev->proto_version, EC_PROTO_VERSION_UNKNOWN);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HELLO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_hello));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_hello));\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_legacy_return0(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, -EPROTO);\n\tKUNIT_EXPECT_EQ(test, ec_dev->proto_version, EC_PROTO_VERSION_UNKNOWN);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HELLO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_hello));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_hello));\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_no_mkbp(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\tec_dev->mkbp_event_supported = 0xbf;\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t \n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->max_request_packet_size = 0xbe;\n\t\tdata->max_response_packet_size = 0xef;\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_get_cmd_versions *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_cmd_versions *)mock->o_data;\n\t\tdata->version_mask = 0;\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command,\n\t\t\t\tEC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) |\n\t\t\t\tEC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tstruct ec_params_get_cmd_versions *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(*data));\n\n\t\tdata = (struct ec_params_get_cmd_versions *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data->cmd, EC_CMD_GET_NEXT_EVENT);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->mkbp_event_supported, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_no_mkbp_return_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\tec_dev->mkbp_event_supported = 0xbf;\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t \n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->max_request_packet_size = 0xbe;\n\t\tdata->max_response_packet_size = 0xef;\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command,\n\t\t\t\tEC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) |\n\t\t\t\tEC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tstruct ec_params_get_cmd_versions *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(*data));\n\n\t\tdata = (struct ec_params_get_cmd_versions *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data->cmd, EC_CMD_GET_NEXT_EVENT);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->mkbp_event_supported, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_no_mkbp_return0(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\tec_dev->mkbp_event_supported = 0xbf;\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t \n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->max_request_packet_size = 0xbe;\n\t\tdata->max_response_packet_size = 0xef;\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command,\n\t\t\t\tEC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) |\n\t\t\t\tEC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tstruct ec_params_get_cmd_versions *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(*data));\n\n\t\tdata = (struct ec_params_get_cmd_versions *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data->cmd, EC_CMD_GET_NEXT_EVENT);\n\n\t\tKUNIT_EXPECT_EQ(test, ec_dev->mkbp_event_supported, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_no_host_sleep(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\tec_dev->host_sleep_v1 = true;\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t \n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->max_request_packet_size = 0xbe;\n\t\tdata->max_response_packet_size = 0xef;\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_get_cmd_versions *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_cmd_versions *)mock->o_data;\n\t\tdata->version_mask = 0;\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command,\n\t\t\t\tEC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) |\n\t\t\t\tEC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_get_cmd_versions));\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_get_cmd_versions));\n\n\t\tKUNIT_EXPECT_FALSE(test, ec_dev->host_sleep_v1);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_no_host_sleep_return0(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\tec_dev->host_sleep_v1 = true;\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t \n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->max_request_packet_size = 0xbe;\n\t\tdata->max_response_packet_size = 0xef;\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_get_cmd_versions *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t \n\t\tdata = (struct ec_response_get_cmd_versions *)mock->o_data;\n\t\tdata->version_mask = 0xbeef;\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command,\n\t\t\t\tEC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) |\n\t\t\t\tEC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_get_cmd_versions));\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_get_cmd_versions));\n\n\t\tKUNIT_EXPECT_FALSE(test, ec_dev->host_sleep_v1);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_default_wake_mask_return_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\tec_dev->host_event_wake_mask = U32_MAX;\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t \n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->max_request_packet_size = 0xbe;\n\t\tdata->max_response_packet_size = 0xef;\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command,\n\t\t\t\tEC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) |\n\t\t\t\tEC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_get_cmd_versions));\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_get_cmd_versions));\n\t}\n\n\t \n\t{\n\t\tu32 mask;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HOST_EVENT_GET_WAKE_MASK);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_host_event_mask));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\n\t\tmask = ec_dev->host_event_wake_mask;\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_LID_CLOSED), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_AC_DISCONNECTED), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_BATTERY_LOW), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_BATTERY_CRITICAL), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_BATTERY), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_PD_MCU), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_BATTERY_STATUS), 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_query_all_default_wake_mask_return0(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\n\t \n\tec_dev->host_event_wake_mask = U32_MAX;\n\n\t \n\t{\n\t\tstruct ec_response_get_protocol_info *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t \n\t\tdata = (struct ec_response_get_protocol_info *)mock->o_data;\n\t\tdata->max_request_packet_size = 0xbe;\n\t\tdata->max_response_packet_size = 0xef;\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tcros_ec_proto_test_query_all_pretest(test);\n\tret = cros_ec_query_all(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command,\n\t\t\t\tEC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) |\n\t\t\t\tEC_CMD_GET_PROTOCOL_INFO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_protocol_info));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_get_cmd_versions));\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_CMD_VERSIONS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_cmd_versions));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(struct ec_params_get_cmd_versions));\n\t}\n\n\t \n\t{\n\t\tu32 mask;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HOST_EVENT_GET_WAKE_MASK);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_host_event_mask));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\n\t\tmask = ec_dev->host_event_wake_mask;\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_LID_CLOSED), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_AC_DISCONNECTED), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_BATTERY_LOW), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_BATTERY_CRITICAL), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_BATTERY), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_PD_MCU), 0);\n\t\tKUNIT_EXPECT_EQ(test, mask & EC_HOST_EVENT_MASK(EC_HOST_EVENT_BATTERY_STATUS), 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_normal(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstruct {\n\t\tstruct cros_ec_command msg;\n\t\tu8 data[0x100];\n\t} __packed buf;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec_dev->max_passthru = 0xdd;\n\n\tbuf.msg.version = 0;\n\tbuf.msg.command = EC_CMD_HELLO;\n\tbuf.msg.insize = 4;\n\tbuf.msg.outsize = 2;\n\tbuf.data[0] = 0x55;\n\tbuf.data[1] = 0xaa;\n\n\t{\n\t\tu8 *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 4);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (u8 *)mock->o_data;\n\t\tdata[0] = 0xaa;\n\t\tdata[1] = 0x55;\n\t\tdata[2] = 0xcc;\n\t\tdata[3] = 0x33;\n\t}\n\n\tret = cros_ec_cmd_xfer(ec_dev, &buf.msg);\n\tKUNIT_EXPECT_EQ(test, ret, 4);\n\n\t{\n\t\tu8 *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HELLO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, 4);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 2);\n\n\t\tdata = (u8 *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data[0], 0x55);\n\t\tKUNIT_EXPECT_EQ(test, data[1], 0xaa);\n\n\t\tKUNIT_EXPECT_EQ(test, buf.data[0], 0xaa);\n\t\tKUNIT_EXPECT_EQ(test, buf.data[1], 0x55);\n\t\tKUNIT_EXPECT_EQ(test, buf.data[2], 0xcc);\n\t\tKUNIT_EXPECT_EQ(test, buf.data[3], 0x33);\n\t}\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_excess_msg_insize(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstruct {\n\t\tstruct cros_ec_command msg;\n\t\tu8 data[0x100];\n\t} __packed buf;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec_dev->max_passthru = 0xdd;\n\n\tbuf.msg.version = 0;\n\tbuf.msg.command = EC_CMD_HELLO;\n\tbuf.msg.insize = 0xee + 1;\n\tbuf.msg.outsize = 2;\n\n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0xcc);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tret = cros_ec_cmd_xfer(ec_dev, &buf.msg);\n\tKUNIT_EXPECT_EQ(test, ret, 0xcc);\n\n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_HELLO);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, 0xee);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 2);\n\t}\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_excess_msg_outsize_without_passthru(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\tstruct {\n\t\tstruct cros_ec_command msg;\n\t\tu8 data[0x100];\n\t} __packed buf;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec_dev->max_passthru = 0xdd;\n\n\tbuf.msg.version = 0;\n\tbuf.msg.command = EC_CMD_HELLO;\n\tbuf.msg.insize = 4;\n\tbuf.msg.outsize = 0xff + 1;\n\n\tret = cros_ec_cmd_xfer(ec_dev, &buf.msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EMSGSIZE);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_excess_msg_outsize_with_passthru(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\tstruct {\n\t\tstruct cros_ec_command msg;\n\t\tu8 data[0x100];\n\t} __packed buf;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec_dev->max_passthru = 0xdd;\n\n\tbuf.msg.version = 0;\n\tbuf.msg.command = EC_CMD_PASSTHRU_OFFSET(CROS_EC_DEV_PD_INDEX) + EC_CMD_HELLO;\n\tbuf.msg.insize = 4;\n\tbuf.msg.outsize = 0xdd + 1;\n\n\tret = cros_ec_cmd_xfer(ec_dev, &buf.msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EMSGSIZE);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_protocol_v3_normal(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\tec_dev->proto_version = 3;\n\tec_dev->cmd_xfer = cros_kunit_ec_cmd_xfer_mock;\n\tec_dev->pkt_xfer = cros_kunit_ec_pkt_xfer_mock;\n\n\tret = cros_ec_cmd_xfer(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\tKUNIT_EXPECT_EQ(test, cros_kunit_ec_cmd_xfer_mock_called, 0);\n\tKUNIT_EXPECT_EQ(test, cros_kunit_ec_pkt_xfer_mock_called, 1);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_protocol_v3_no_op(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\tec_dev->proto_version = 3;\n\tec_dev->cmd_xfer = cros_kunit_ec_cmd_xfer_mock;\n\tec_dev->pkt_xfer = NULL;\n\n\tret = cros_ec_cmd_xfer(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EIO);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_protocol_v2_normal(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\tec_dev->proto_version = 2;\n\tec_dev->cmd_xfer = cros_kunit_ec_cmd_xfer_mock;\n\tec_dev->pkt_xfer = cros_kunit_ec_pkt_xfer_mock;\n\n\tret = cros_ec_cmd_xfer(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\tKUNIT_EXPECT_EQ(test, cros_kunit_ec_cmd_xfer_mock_called, 1);\n\tKUNIT_EXPECT_EQ(test, cros_kunit_ec_pkt_xfer_mock_called, 0);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_protocol_v2_no_op(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\tec_dev->proto_version = 2;\n\tec_dev->cmd_xfer = NULL;\n\tec_dev->pkt_xfer = cros_kunit_ec_pkt_xfer_mock;\n\n\tret = cros_ec_cmd_xfer(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EIO);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_in_progress_normal(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\tec_dev->pkt_xfer = cros_kunit_ec_pkt_xfer_mock;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_IN_PROGRESS, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_get_comms_status *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_comms_status *)mock->o_data;\n\t\tdata->flags = 0;\n\t}\n\n\tret = cros_ec_cmd_xfer(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, sizeof(struct ec_response_get_comms_status));\n\n\tKUNIT_EXPECT_EQ(test, msg.result, EC_RES_SUCCESS);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_COMMS_STATUS);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_comms_status));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n\n\tKUNIT_EXPECT_EQ(test, cros_kunit_ec_pkt_xfer_mock_called, 2);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_in_progress_retries_eagain(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\tec_dev->pkt_xfer = cros_kunit_ec_pkt_xfer_mock;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_IN_PROGRESS, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\tcros_kunit_ec_xfer_mock_default_ret = -EAGAIN;\n\n\tret = cros_ec_cmd_xfer(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EAGAIN);\n\n\t \n\tKUNIT_EXPECT_EQ(test, cros_kunit_ec_pkt_xfer_mock_called, 51);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_in_progress_retries_status_processing(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\tec_dev->pkt_xfer = cros_kunit_ec_pkt_xfer_mock;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_IN_PROGRESS, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tstruct ec_response_get_comms_status *data;\n\t\tint i;\n\n\t\tfor (i = 0; i < 50; ++i) {\n\t\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\t\tdata = (struct ec_response_get_comms_status *)mock->o_data;\n\t\t\tdata->flags |= EC_COMMS_STATUS_PROCESSING;\n\t\t}\n\t}\n\n\tret = cros_ec_cmd_xfer(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EAGAIN);\n\n\t \n\tKUNIT_EXPECT_EQ(test, cros_kunit_ec_pkt_xfer_mock_called, 51);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_in_progress_xfer_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_IN_PROGRESS, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, -EIO, EC_RES_SUCCESS, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tret = cros_ec_cmd_xfer(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EIO);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_in_progress_return_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\tec_dev->pkt_xfer = cros_kunit_ec_pkt_xfer_mock;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_IN_PROGRESS, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_INVALID_COMMAND, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tret = cros_ec_cmd_xfer(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n\n\tKUNIT_EXPECT_EQ(test, msg.result, EC_RES_INVALID_COMMAND);\n\n\tKUNIT_EXPECT_EQ(test, cros_kunit_ec_pkt_xfer_mock_called, 2);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_in_progress_return0(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\tec_dev->pkt_xfer = cros_kunit_ec_pkt_xfer_mock;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, EC_RES_IN_PROGRESS, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tret = cros_ec_cmd_xfer(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EPROTO);\n\n\tKUNIT_EXPECT_EQ(test, cros_kunit_ec_pkt_xfer_mock_called, 2);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_status_normal(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tret = cros_ec_cmd_xfer_status(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_status_xfer_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstruct cros_ec_command msg;\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, -EPROTO, EC_RES_SUCCESS, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tret = cros_ec_cmd_xfer_status(ec_dev, &msg);\n\tKUNIT_EXPECT_EQ(test, ret, -EPROTO);\n}\n\nstatic void cros_ec_proto_test_cmd_xfer_status_return_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret, i;\n\tstruct cros_ec_command msg;\n\tstatic const int map[] = {\n\t\t[EC_RES_SUCCESS] = 0,\n\t\t[EC_RES_INVALID_COMMAND] = -EOPNOTSUPP,\n\t\t[EC_RES_ERROR] = -EIO,\n\t\t[EC_RES_INVALID_PARAM] = -EINVAL,\n\t\t[EC_RES_ACCESS_DENIED] = -EACCES,\n\t\t[EC_RES_INVALID_RESPONSE] = -EPROTO,\n\t\t[EC_RES_INVALID_VERSION] = -ENOPROTOOPT,\n\t\t[EC_RES_INVALID_CHECKSUM] = -EBADMSG,\n\t\t \n\t\t[EC_RES_IN_PROGRESS] = -EPROTO,\n\t\t[EC_RES_UNAVAILABLE] = -ENODATA,\n\t\t[EC_RES_TIMEOUT] = -ETIMEDOUT,\n\t\t[EC_RES_OVERFLOW] = -EOVERFLOW,\n\t\t[EC_RES_INVALID_HEADER] = -EBADR,\n\t\t[EC_RES_REQUEST_TRUNCATED] = -EBADR,\n\t\t[EC_RES_RESPONSE_TOO_BIG] = -EFBIG,\n\t\t[EC_RES_BUS_ERROR] = -EFAULT,\n\t\t[EC_RES_BUSY] = -EBUSY,\n\t\t[EC_RES_INVALID_HEADER_VERSION] = -EBADMSG,\n\t\t[EC_RES_INVALID_HEADER_CRC] = -EBADMSG,\n\t\t[EC_RES_INVALID_DATA_CRC] = -EBADMSG,\n\t\t[EC_RES_DUP_UNAVAILABLE] = -ENODATA,\n\t};\n\n\tmemset(&msg, 0, sizeof(msg));\n\n\tfor (i = 0; i < ARRAY_SIZE(map); ++i) {\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, 0, i, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tret = cros_ec_cmd_xfer_status(ec_dev, &msg);\n\t\tKUNIT_EXPECT_EQ(test, ret, map[i]);\n\t}\n}\n\nstatic void cros_ec_proto_test_get_next_event_no_mkbp_event(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tbool wake_event, more_events;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec_dev->mkbp_event_supported = 0;\n\n\t \n\twake_event = false;\n\tmore_events = true;\n\n\t \n\t{\n\t\tunion ec_response_get_next_data_v1 *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (union ec_response_get_next_data_v1 *)mock->o_data;\n\t\tdata->host_event = 0xbeef;\n\t}\n\n\tret = cros_ec_get_next_event(ec_dev, &wake_event, &more_events);\n\tKUNIT_EXPECT_EQ(test, ret, sizeof(union ec_response_get_next_data_v1));\n\n\tKUNIT_EXPECT_EQ(test, ec_dev->event_data.event_type, EC_MKBP_EVENT_KEY_MATRIX);\n\tKUNIT_EXPECT_EQ(test, ec_dev->event_data.data.host_event, 0xbeef);\n\n\tKUNIT_EXPECT_TRUE(test, wake_event);\n\tKUNIT_EXPECT_FALSE(test, more_events);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_MKBP_STATE);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(union ec_response_get_next_data_v1));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_get_next_event_mkbp_event_ec_suspended(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\n\tec_dev->mkbp_event_supported = 1;\n\tec_dev->suspended = true;\n\n\tret = cros_ec_get_next_event(ec_dev, NULL, NULL);\n\tKUNIT_EXPECT_EQ(test, ret, -EHOSTDOWN);\n}\n\nstatic void cros_ec_proto_test_get_next_event_mkbp_event_version0(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tbool wake_event, more_events;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec_dev->mkbp_event_supported = 1;\n\n\t \n\twake_event = true;\n\tmore_events = false;\n\n\t \n\t{\n\t\tstruct ec_response_get_next_event *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_next_event *)mock->o_data;\n\t\tdata->event_type = EC_MKBP_EVENT_SENSOR_FIFO | EC_MKBP_HAS_MORE_EVENTS;\n\t\tdata->data.sysrq = 0xbeef;\n\t}\n\n\tret = cros_ec_get_next_event(ec_dev, &wake_event, &more_events);\n\tKUNIT_EXPECT_EQ(test, ret, sizeof(struct ec_response_get_next_event));\n\n\tKUNIT_EXPECT_EQ(test, ec_dev->event_data.event_type, EC_MKBP_EVENT_SENSOR_FIFO);\n\tKUNIT_EXPECT_EQ(test, ec_dev->event_data.data.sysrq, 0xbeef);\n\n\tKUNIT_EXPECT_FALSE(test, wake_event);\n\tKUNIT_EXPECT_TRUE(test, more_events);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_NEXT_EVENT);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_get_next_event));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_get_next_event_mkbp_event_version2(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tbool wake_event, more_events;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec_dev->mkbp_event_supported = 3;\n\n\t \n\twake_event = false;\n\tmore_events = true;\n\n\t \n\t{\n\t\tstruct ec_response_get_next_event_v1 *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_next_event_v1 *)mock->o_data;\n\t\tdata->event_type = EC_MKBP_EVENT_FINGERPRINT;\n\t\tdata->data.sysrq = 0xbeef;\n\t}\n\n\tret = cros_ec_get_next_event(ec_dev, &wake_event, &more_events);\n\tKUNIT_EXPECT_EQ(test, ret, sizeof(struct ec_response_get_next_event_v1));\n\n\tKUNIT_EXPECT_EQ(test, ec_dev->event_data.event_type, EC_MKBP_EVENT_FINGERPRINT);\n\tKUNIT_EXPECT_EQ(test, ec_dev->event_data.data.sysrq, 0xbeef);\n\n\tKUNIT_EXPECT_TRUE(test, wake_event);\n\tKUNIT_EXPECT_FALSE(test, more_events);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 2);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_NEXT_EVENT);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_next_event_v1));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_get_next_event_mkbp_event_host_event_rtc(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tbool wake_event;\n\tstruct ec_response_get_next_event_v1 *data;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec_dev->mkbp_event_supported = 3;\n\tec_dev->host_event_wake_mask = U32_MAX;\n\n\t \n\twake_event = true;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test,\n\t\t\t\t\t\t   sizeof(data->event_type) +\n\t\t\t\t\t\t   sizeof(data->data.host_event));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_next_event_v1 *)mock->o_data;\n\t\tdata->event_type = EC_MKBP_EVENT_HOST_EVENT;\n\t\tput_unaligned_le32(EC_HOST_EVENT_MASK(EC_HOST_EVENT_RTC), &data->data.host_event);\n\t}\n\n\tret = cros_ec_get_next_event(ec_dev, &wake_event, NULL);\n\tKUNIT_EXPECT_EQ(test, ret, sizeof(data->event_type) + sizeof(data->data.host_event));\n\n\tKUNIT_EXPECT_EQ(test, ec_dev->event_data.event_type, EC_MKBP_EVENT_HOST_EVENT);\n\n\tKUNIT_EXPECT_FALSE(test, wake_event);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 2);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_NEXT_EVENT);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_next_event_v1));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_get_next_event_mkbp_event_host_event_masked(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tbool wake_event;\n\tstruct ec_response_get_next_event_v1 *data;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec_dev->mkbp_event_supported = 3;\n\tec_dev->host_event_wake_mask = U32_MAX & ~EC_HOST_EVENT_MASK(EC_HOST_EVENT_AC_DISCONNECTED);\n\n\t \n\twake_event = true;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_add(test,\n\t\t\t\t\t\t   sizeof(data->event_type) +\n\t\t\t\t\t\t   sizeof(data->data.host_event));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_next_event_v1 *)mock->o_data;\n\t\tdata->event_type = EC_MKBP_EVENT_HOST_EVENT;\n\t\tput_unaligned_le32(EC_HOST_EVENT_MASK(EC_HOST_EVENT_AC_DISCONNECTED),\n\t\t\t\t   &data->data.host_event);\n\t}\n\n\tret = cros_ec_get_next_event(ec_dev, &wake_event, NULL);\n\tKUNIT_EXPECT_EQ(test, ret, sizeof(data->event_type) + sizeof(data->data.host_event));\n\n\tKUNIT_EXPECT_EQ(test, ec_dev->event_data.event_type, EC_MKBP_EVENT_HOST_EVENT);\n\n\tKUNIT_EXPECT_FALSE(test, wake_event);\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 2);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_NEXT_EVENT);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\tsizeof(struct ec_response_get_next_event_v1));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_get_host_event_no_mkbp_event(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\n\tec_dev->mkbp_event_supported = 0;\n\n\tret = cros_ec_get_host_event(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n}\n\nstatic void cros_ec_proto_test_get_host_event_not_host_event(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\n\tec_dev->mkbp_event_supported = 1;\n\tec_dev->event_data.event_type = EC_MKBP_EVENT_FINGERPRINT;\n\n\tret = cros_ec_get_host_event(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n}\n\nstatic void cros_ec_proto_test_get_host_event_wrong_event_size(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\n\tec_dev->mkbp_event_supported = 1;\n\tec_dev->event_data.event_type = EC_MKBP_EVENT_HOST_EVENT;\n\tec_dev->event_size = 0xff;\n\n\tret = cros_ec_get_host_event(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, 0);\n}\n\nstatic void cros_ec_proto_test_get_host_event_normal(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tint ret;\n\n\tec_dev->mkbp_event_supported = 1;\n\tec_dev->event_data.event_type = EC_MKBP_EVENT_HOST_EVENT;\n\tec_dev->event_size = sizeof(ec_dev->event_data.data.host_event);\n\tput_unaligned_le32(EC_HOST_EVENT_MASK(EC_HOST_EVENT_RTC),\n\t\t\t   &ec_dev->event_data.data.host_event);\n\n\tret = cros_ec_get_host_event(ec_dev);\n\tKUNIT_EXPECT_EQ(test, ret, EC_HOST_EVENT_MASK(EC_HOST_EVENT_RTC));\n}\n\nstatic void cros_ec_proto_test_check_features_cached(struct kunit *test)\n{\n\tint ret, i;\n\tstatic struct cros_ec_dev ec;\n\n\tec.features.flags[0] = EC_FEATURE_MASK_0(EC_FEATURE_FINGERPRINT);\n\tec.features.flags[1] = EC_FEATURE_MASK_0(EC_FEATURE_SCP);\n\n\tfor (i = 0; i < EC_FEATURE_TYPEC_MUX_REQUIRE_AP_ACK; ++i) {\n\t\tret = cros_ec_check_features(&ec, i);\n\t\tswitch (i) {\n\t\tcase EC_FEATURE_FINGERPRINT:\n\t\tcase EC_FEATURE_SCP:\n\t\t\tKUNIT_EXPECT_TRUE(test, ret);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tKUNIT_EXPECT_FALSE(test, ret);\n\t\t\tbreak;\n\t\t}\n\t}\n}\n\nstatic void cros_ec_proto_test_check_features_not_cached(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret, i;\n\tstatic struct cros_ec_dev ec;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec.ec_dev = ec_dev;\n\tec.dev = ec_dev->dev;\n\tec.cmd_offset = 0;\n\tec.features.flags[0] = -1;\n\tec.features.flags[1] = -1;\n\n\t \n\t{\n\t\tstruct ec_response_get_features *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_get_features *)mock->o_data;\n\t\tdata->flags[0] = EC_FEATURE_MASK_0(EC_FEATURE_FINGERPRINT);\n\t\tdata->flags[1] = EC_FEATURE_MASK_0(EC_FEATURE_SCP);\n\t}\n\n\tfor (i = 0; i < EC_FEATURE_TYPEC_MUX_REQUIRE_AP_ACK; ++i) {\n\t\tret = cros_ec_check_features(&ec, i);\n\t\tswitch (i) {\n\t\tcase EC_FEATURE_FINGERPRINT:\n\t\tcase EC_FEATURE_SCP:\n\t\t\tKUNIT_EXPECT_TRUE(test, ret);\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tKUNIT_EXPECT_FALSE(test, ret);\n\t\t\tbreak;\n\t\t}\n\t}\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_GET_FEATURES);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_get_features));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, 0);\n\t}\n}\n\nstatic void cros_ec_proto_test_get_sensor_count_normal(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstatic struct cros_ec_dev ec;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec.ec_dev = ec_dev;\n\tec.dev = ec_dev->dev;\n\tec.cmd_offset = 0;\n\n\t \n\t{\n\t\tstruct ec_response_motion_sense *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, sizeof(*data));\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (struct ec_response_motion_sense *)mock->o_data;\n\t\tdata->dump.sensor_count = 0xbf;\n\t}\n\n\tret = cros_ec_get_sensor_count(&ec);\n\tKUNIT_EXPECT_EQ(test, ret, 0xbf);\n\n\t \n\t{\n\t\tstruct ec_params_motion_sense *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 1);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_MOTION_SENSE_CMD);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_motion_sense));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(*data));\n\n\t\tdata = (struct ec_params_motion_sense *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data->cmd, MOTIONSENSE_CMD_DUMP);\n\t}\n}\n\nstatic void cros_ec_proto_test_get_sensor_count_xfer_error(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tstatic struct cros_ec_dev ec;\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec.ec_dev = ec_dev;\n\tec.dev = ec_dev->dev;\n\tec.cmd_offset = 0;\n\n\t \n\t{\n\t\tmock = cros_kunit_ec_xfer_mock_addx(test, -EPROTO, EC_RES_SUCCESS, 0);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t}\n\n\tret = cros_ec_get_sensor_count(&ec);\n\tKUNIT_EXPECT_EQ(test, ret, -EPROTO);\n\n\t \n\t{\n\t\tstruct ec_params_motion_sense *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 1);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_MOTION_SENSE_CMD);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, sizeof(struct ec_response_motion_sense));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(*data));\n\n\t\tdata = (struct ec_params_motion_sense *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data->cmd, MOTIONSENSE_CMD_DUMP);\n\t}\n}\n\nstatic void cros_ec_proto_test_get_sensor_count_legacy(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret, i;\n\tstatic struct cros_ec_dev ec;\n\tstruct {\n\t\tu8 readmem_data;\n\t\tint expected_result;\n\t} test_data[] = {\n\t\t{ 0, 0 },\n\t\t{ EC_MEMMAP_ACC_STATUS_PRESENCE_BIT, 2 },\n\t};\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\tec_dev->cmd_readmem = cros_kunit_readmem_mock;\n\tec.ec_dev = ec_dev;\n\tec.dev = ec_dev->dev;\n\tec.cmd_offset = 0;\n\n\tfor (i = 0; i < ARRAY_SIZE(test_data); ++i) {\n\t\t \n\t\t{\n\t\t\tmock = cros_kunit_ec_xfer_mock_addx(test, -EPROTO, EC_RES_SUCCESS, 0);\n\t\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\t\t}\n\n\t\t \n\t\t{\n\t\t\tcros_kunit_readmem_mock_data = kunit_kzalloc(test, 1, GFP_KERNEL);\n\t\t\tKUNIT_ASSERT_PTR_NE(test, cros_kunit_readmem_mock_data, NULL);\n\t\t\tcros_kunit_readmem_mock_data[0] = test_data[i].readmem_data;\n\n\t\t\tcros_kunit_ec_xfer_mock_default_ret = 1;\n\t\t}\n\n\t\tret = cros_ec_get_sensor_count(&ec);\n\t\tKUNIT_EXPECT_EQ(test, ret, test_data[i].expected_result);\n\n\t\t \n\t\t{\n\t\t\tstruct ec_params_motion_sense *data;\n\n\t\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 1);\n\t\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, EC_CMD_MOTION_SENSE_CMD);\n\t\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize,\n\t\t\t\t\tsizeof(struct ec_response_motion_sense));\n\t\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, sizeof(*data));\n\n\t\t\tdata = (struct ec_params_motion_sense *)mock->i_data;\n\t\t\tKUNIT_EXPECT_EQ(test, data->cmd, MOTIONSENSE_CMD_DUMP);\n\t\t}\n\n\t\t \n\t\t{\n\t\t\tKUNIT_EXPECT_EQ(test, cros_kunit_readmem_mock_offset, EC_MEMMAP_ACC_STATUS);\n\t\t}\n\t}\n}\n\nstatic void cros_ec_proto_test_ec_cmd(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\tstruct ec_xfer_mock *mock;\n\tint ret;\n\tu8 out[3], in[2];\n\n\tec_dev->max_request = 0xff;\n\tec_dev->max_response = 0xee;\n\n\tout[0] = 0xdd;\n\tout[1] = 0xcc;\n\tout[2] = 0xbb;\n\n\t{\n\t\tu8 *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_add(test, 2);\n\t\tKUNIT_ASSERT_PTR_NE(test, mock, NULL);\n\n\t\tdata = (u8 *)mock->o_data;\n\t\tdata[0] = 0xaa;\n\t\tdata[1] = 0x99;\n\t}\n\n\tret = cros_ec_cmd(ec_dev, 0x88, 0x77, out, ARRAY_SIZE(out), in, ARRAY_SIZE(in));\n\tKUNIT_EXPECT_EQ(test, ret, 2);\n\n\t{\n\t\tu8 *data;\n\n\t\tmock = cros_kunit_ec_xfer_mock_next();\n\t\tKUNIT_EXPECT_PTR_NE(test, mock, NULL);\n\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.version, 0x88);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.command, 0x77);\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.insize, ARRAY_SIZE(in));\n\t\tKUNIT_EXPECT_EQ(test, mock->msg.outsize, ARRAY_SIZE(out));\n\n\t\tdata = (u8 *)mock->i_data;\n\t\tKUNIT_EXPECT_EQ(test, data[0], 0xdd);\n\t\tKUNIT_EXPECT_EQ(test, data[1], 0xcc);\n\t\tKUNIT_EXPECT_EQ(test, data[2], 0xbb);\n\t}\n}\n\nstatic void cros_ec_proto_test_release(struct device *dev)\n{\n}\n\nstatic int cros_ec_proto_test_init(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv;\n\tstruct cros_ec_device *ec_dev;\n\n\tpriv = kunit_kzalloc(test, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\ttest->priv = priv;\n\n\tec_dev = &priv->ec_dev;\n\tec_dev->dout = (u8 *)priv->dout;\n\tec_dev->dout_size = ARRAY_SIZE(priv->dout);\n\tec_dev->din = (u8 *)priv->din;\n\tec_dev->din_size = ARRAY_SIZE(priv->din);\n\tec_dev->proto_version = EC_HOST_REQUEST_VERSION;\n\tec_dev->dev = kunit_kzalloc(test, sizeof(*ec_dev->dev), GFP_KERNEL);\n\tif (!ec_dev->dev)\n\t\treturn -ENOMEM;\n\tdevice_initialize(ec_dev->dev);\n\tdev_set_name(ec_dev->dev, \"cros_ec_proto_test\");\n\tec_dev->dev->release = cros_ec_proto_test_release;\n\tec_dev->cmd_xfer = cros_kunit_ec_xfer_mock;\n\tec_dev->pkt_xfer = cros_kunit_ec_xfer_mock;\n\tmutex_init(&ec_dev->lock);\n\n\tpriv->msg = (struct cros_ec_command *)priv->_msg;\n\n\tcros_kunit_mock_reset();\n\n\treturn 0;\n}\n\nstatic void cros_ec_proto_test_exit(struct kunit *test)\n{\n\tstruct cros_ec_proto_test_priv *priv = test->priv;\n\tstruct cros_ec_device *ec_dev = &priv->ec_dev;\n\n\tput_device(ec_dev->dev);\n}\n\nstatic struct kunit_case cros_ec_proto_test_cases[] = {\n\tKUNIT_CASE(cros_ec_proto_test_prepare_tx_legacy_normal),\n\tKUNIT_CASE(cros_ec_proto_test_prepare_tx_legacy_bad_msg_outsize),\n\tKUNIT_CASE(cros_ec_proto_test_prepare_tx_normal),\n\tKUNIT_CASE(cros_ec_proto_test_prepare_tx_bad_msg_outsize),\n\tKUNIT_CASE(cros_ec_proto_test_check_result),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_normal),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_no_pd_return_error),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_no_pd_return0),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_legacy_normal_v3_return_error),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_legacy_normal_v3_return0),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_legacy_xfer_error),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_legacy_return_error),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_legacy_data_error),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_legacy_return0),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_no_mkbp),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_no_mkbp_return_error),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_no_mkbp_return0),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_no_host_sleep),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_no_host_sleep_return0),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_default_wake_mask_return_error),\n\tKUNIT_CASE(cros_ec_proto_test_query_all_default_wake_mask_return0),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_normal),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_excess_msg_insize),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_excess_msg_outsize_without_passthru),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_excess_msg_outsize_with_passthru),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_protocol_v3_normal),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_protocol_v3_no_op),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_protocol_v2_normal),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_protocol_v2_no_op),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_in_progress_normal),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_in_progress_retries_eagain),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_in_progress_retries_status_processing),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_in_progress_xfer_error),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_in_progress_return_error),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_in_progress_return0),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_status_normal),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_status_xfer_error),\n\tKUNIT_CASE(cros_ec_proto_test_cmd_xfer_status_return_error),\n\tKUNIT_CASE(cros_ec_proto_test_get_next_event_no_mkbp_event),\n\tKUNIT_CASE(cros_ec_proto_test_get_next_event_mkbp_event_ec_suspended),\n\tKUNIT_CASE(cros_ec_proto_test_get_next_event_mkbp_event_version0),\n\tKUNIT_CASE(cros_ec_proto_test_get_next_event_mkbp_event_version2),\n\tKUNIT_CASE(cros_ec_proto_test_get_next_event_mkbp_event_host_event_rtc),\n\tKUNIT_CASE(cros_ec_proto_test_get_next_event_mkbp_event_host_event_masked),\n\tKUNIT_CASE(cros_ec_proto_test_get_host_event_no_mkbp_event),\n\tKUNIT_CASE(cros_ec_proto_test_get_host_event_not_host_event),\n\tKUNIT_CASE(cros_ec_proto_test_get_host_event_wrong_event_size),\n\tKUNIT_CASE(cros_ec_proto_test_get_host_event_normal),\n\tKUNIT_CASE(cros_ec_proto_test_check_features_cached),\n\tKUNIT_CASE(cros_ec_proto_test_check_features_not_cached),\n\tKUNIT_CASE(cros_ec_proto_test_get_sensor_count_normal),\n\tKUNIT_CASE(cros_ec_proto_test_get_sensor_count_xfer_error),\n\tKUNIT_CASE(cros_ec_proto_test_get_sensor_count_legacy),\n\tKUNIT_CASE(cros_ec_proto_test_ec_cmd),\n\t{}\n};\n\nstatic struct kunit_suite cros_ec_proto_test_suite = {\n\t.name = \"cros_ec_proto_test\",\n\t.init = cros_ec_proto_test_init,\n\t.exit = cros_ec_proto_test_exit,\n\t.test_cases = cros_ec_proto_test_cases,\n};\n\nkunit_test_suite(cros_ec_proto_test_suite);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}