{
  "module_name": "keyboard_leds.c",
  "hash_id": "5b42670e95f3e6fc7ea8403ff5d4d21f770c5ca82b49dc2048379bb126338e98",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/chrome/wilco_ec/keyboard_leds.c",
  "human_readable_source": "\n \n\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/leds.h>\n#include <linux/platform_data/wilco-ec.h>\n#include <linux/slab.h>\n\n#define WILCO_EC_COMMAND_KBBL\t\t0x75\n#define WILCO_KBBL_MODE_FLAG_PWM\tBIT(1)\t \n#define WILCO_KBBL_DEFAULT_BRIGHTNESS   0\n\nstruct wilco_keyboard_leds {\n\tstruct wilco_ec_device *ec;\n\tstruct led_classdev keyboard;\n};\n\nenum wilco_kbbl_subcommand {\n\tWILCO_KBBL_SUBCMD_GET_FEATURES = 0x00,\n\tWILCO_KBBL_SUBCMD_GET_STATE    = 0x01,\n\tWILCO_KBBL_SUBCMD_SET_STATE    = 0x02,\n};\n\n \nstruct wilco_keyboard_leds_msg {\n\tu8 command;\n\tu8 status;\n\tu8 subcmd;\n\tu8 reserved3;\n\tu8 mode;\n\tu8 reserved5to8[4];\n\tu8 percent;\n\tu8 reserved10to15[6];\n} __packed;\n\n \nstatic int send_kbbl_msg(struct wilco_ec_device *ec,\n\t\t\t struct wilco_keyboard_leds_msg *request,\n\t\t\t struct wilco_keyboard_leds_msg *response)\n{\n\tstruct wilco_ec_message msg;\n\tint ret;\n\n\tmemset(&msg, 0, sizeof(msg));\n\tmsg.type = WILCO_EC_MSG_LEGACY;\n\tmsg.request_data = request;\n\tmsg.request_size = sizeof(*request);\n\tmsg.response_data = response;\n\tmsg.response_size = sizeof(*response);\n\n\tret = wilco_ec_mailbox(ec, &msg);\n\tif (ret < 0) {\n\t\tdev_err(ec->dev,\n\t\t\t\"Failed sending keyboard LEDs command: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic int set_kbbl(struct wilco_ec_device *ec, enum led_brightness brightness)\n{\n\tstruct wilco_keyboard_leds_msg request;\n\tstruct wilco_keyboard_leds_msg response;\n\tint ret;\n\n\tmemset(&request, 0, sizeof(request));\n\trequest.command = WILCO_EC_COMMAND_KBBL;\n\trequest.subcmd  = WILCO_KBBL_SUBCMD_SET_STATE;\n\trequest.mode    = WILCO_KBBL_MODE_FLAG_PWM;\n\trequest.percent = brightness;\n\n\tret = send_kbbl_msg(ec, &request, &response);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (response.status) {\n\t\tdev_err(ec->dev,\n\t\t\t\"EC reported failure sending keyboard LEDs command: %d\\n\",\n\t\t\tresponse.status);\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n\nstatic int kbbl_exist(struct wilco_ec_device *ec, bool *exists)\n{\n\tstruct wilco_keyboard_leds_msg request;\n\tstruct wilco_keyboard_leds_msg response;\n\tint ret;\n\n\tmemset(&request, 0, sizeof(request));\n\trequest.command = WILCO_EC_COMMAND_KBBL;\n\trequest.subcmd  = WILCO_KBBL_SUBCMD_GET_FEATURES;\n\n\tret = send_kbbl_msg(ec, &request, &response);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t*exists = response.status != 0xFF;\n\n\treturn 0;\n}\n\n \nstatic int kbbl_init(struct wilco_ec_device *ec)\n{\n\tstruct wilco_keyboard_leds_msg request;\n\tstruct wilco_keyboard_leds_msg response;\n\tint ret;\n\n\tmemset(&request, 0, sizeof(request));\n\trequest.command = WILCO_EC_COMMAND_KBBL;\n\trequest.subcmd  = WILCO_KBBL_SUBCMD_GET_STATE;\n\n\tret = send_kbbl_msg(ec, &request, &response);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (response.status) {\n\t\tdev_err(ec->dev,\n\t\t\t\"EC reported failure sending keyboard LEDs command: %d\\n\",\n\t\t\tresponse.status);\n\t\treturn -EIO;\n\t}\n\n\tif (response.mode & WILCO_KBBL_MODE_FLAG_PWM)\n\t\treturn response.percent;\n\n\tret = set_kbbl(ec, WILCO_KBBL_DEFAULT_BRIGHTNESS);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn WILCO_KBBL_DEFAULT_BRIGHTNESS;\n}\n\nstatic int wilco_keyboard_leds_set(struct led_classdev *cdev,\n\t\t\t\t   enum led_brightness brightness)\n{\n\tstruct wilco_keyboard_leds *wkl =\n\t\tcontainer_of(cdev, struct wilco_keyboard_leds, keyboard);\n\treturn set_kbbl(wkl->ec, brightness);\n}\n\nint wilco_keyboard_leds_init(struct wilco_ec_device *ec)\n{\n\tstruct wilco_keyboard_leds *wkl;\n\tbool leds_exist;\n\tint ret;\n\n\tret = kbbl_exist(ec, &leds_exist);\n\tif (ret < 0) {\n\t\tdev_err(ec->dev,\n\t\t\t\"Failed checking keyboard LEDs support: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tif (!leds_exist)\n\t\treturn 0;\n\n\twkl = devm_kzalloc(ec->dev, sizeof(*wkl), GFP_KERNEL);\n\tif (!wkl)\n\t\treturn -ENOMEM;\n\n\twkl->ec = ec;\n\twkl->keyboard.name = \"platform::kbd_backlight\";\n\twkl->keyboard.max_brightness = 100;\n\twkl->keyboard.flags = LED_CORE_SUSPENDRESUME;\n\twkl->keyboard.brightness_set_blocking = wilco_keyboard_leds_set;\n\tret = kbbl_init(ec);\n\tif (ret < 0)\n\t\treturn ret;\n\twkl->keyboard.brightness = ret;\n\n\treturn devm_led_classdev_register(ec->dev, &wkl->keyboard);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}