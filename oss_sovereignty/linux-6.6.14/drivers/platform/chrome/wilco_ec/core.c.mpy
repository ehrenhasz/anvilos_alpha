{
  "module_name": "core.c",
  "hash_id": "4175e87a8ca975bfcd285a05afd44b7eae596e56d55e6ed84169ed554dac9cbb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/platform/chrome/wilco_ec/core.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/device.h>\n#include <linux/ioport.h>\n#include <linux/module.h>\n#include <linux/platform_data/wilco-ec.h>\n#include <linux/platform_device.h>\n\n#include \"../cros_ec_lpc_mec.h\"\n\n#define DRV_NAME \"wilco-ec\"\n\nstatic struct resource *wilco_get_resource(struct platform_device *pdev,\n\t\t\t\t\t   int index)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct resource *res;\n\n\tres = platform_get_resource(pdev, IORESOURCE_IO, index);\n\tif (!res) {\n\t\tdev_dbg(dev, \"Couldn't find IO resource %d\\n\", index);\n\t\treturn res;\n\t}\n\n\treturn devm_request_region(dev, res->start, resource_size(res),\n\t\t\t\t   dev_name(dev));\n}\n\nstatic int wilco_ec_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct wilco_ec_device *ec;\n\tint ret;\n\n\tec = devm_kzalloc(dev, sizeof(*ec), GFP_KERNEL);\n\tif (!ec)\n\t\treturn -ENOMEM;\n\n\tplatform_set_drvdata(pdev, ec);\n\tec->dev = dev;\n\tmutex_init(&ec->mailbox_lock);\n\n\tec->data_size = sizeof(struct wilco_ec_response) + EC_MAILBOX_DATA_SIZE;\n\tec->data_buffer = devm_kzalloc(dev, ec->data_size, GFP_KERNEL);\n\tif (!ec->data_buffer)\n\t\treturn -ENOMEM;\n\n\t \n\tec->io_data = wilco_get_resource(pdev, 0);\t \n\tec->io_command = wilco_get_resource(pdev, 1);\t \n\tec->io_packet = wilco_get_resource(pdev, 2);\t \n\tif (!ec->io_data || !ec->io_command || !ec->io_packet)\n\t\treturn -ENODEV;\n\n\t \n\tcros_ec_lpc_mec_init(ec->io_packet->start,\n\t\t\t     ec->io_packet->start + EC_MAILBOX_DATA_SIZE);\n\n\t \n\tec->debugfs_pdev = platform_device_register_data(dev,\n\t\t\t\t\t\t\t \"wilco-ec-debugfs\",\n\t\t\t\t\t\t\t PLATFORM_DEVID_AUTO,\n\t\t\t\t\t\t\t NULL, 0);\n\n\t \n\tec->rtc_pdev = platform_device_register_data(dev, \"rtc-wilco-ec\",\n\t\t\t\t\t\t     PLATFORM_DEVID_AUTO,\n\t\t\t\t\t\t     NULL, 0);\n\tif (IS_ERR(ec->rtc_pdev)) {\n\t\tdev_err(dev, \"Failed to create RTC platform device\\n\");\n\t\tret = PTR_ERR(ec->rtc_pdev);\n\t\tgoto unregister_debugfs;\n\t}\n\n\t \n\tret = wilco_keyboard_leds_init(ec);\n\tif (ret < 0) {\n\t\tdev_err(dev,\n\t\t\t\"Failed to initialize keyboard LEDs: %d\\n\",\n\t\t\tret);\n\t\tgoto unregister_rtc;\n\t}\n\n\tret = wilco_ec_add_sysfs(ec);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"Failed to create sysfs entries: %d\\n\", ret);\n\t\tgoto unregister_rtc;\n\t}\n\n\t \n\tec->charger_pdev = platform_device_register_data(dev, \"wilco-charger\",\n\t\t\t\t\t\t\t PLATFORM_DEVID_AUTO,\n\t\t\t\t\t\t\t NULL, 0);\n\tif (IS_ERR(ec->charger_pdev)) {\n\t\tdev_err(dev, \"Failed to create charger platform device\\n\");\n\t\tret = PTR_ERR(ec->charger_pdev);\n\t\tgoto remove_sysfs;\n\t}\n\n\t \n\tec->telem_pdev = platform_device_register_data(dev, \"wilco_telem\",\n\t\t\t\t\t\t       PLATFORM_DEVID_AUTO,\n\t\t\t\t\t\t       ec, sizeof(*ec));\n\tif (IS_ERR(ec->telem_pdev)) {\n\t\tdev_err(dev, \"Failed to create telemetry platform device\\n\");\n\t\tret = PTR_ERR(ec->telem_pdev);\n\t\tgoto unregister_charge_config;\n\t}\n\n\treturn 0;\n\nunregister_charge_config:\n\tplatform_device_unregister(ec->charger_pdev);\nremove_sysfs:\n\twilco_ec_remove_sysfs(ec);\nunregister_rtc:\n\tplatform_device_unregister(ec->rtc_pdev);\nunregister_debugfs:\n\tif (ec->debugfs_pdev)\n\t\tplatform_device_unregister(ec->debugfs_pdev);\n\treturn ret;\n}\n\nstatic int wilco_ec_remove(struct platform_device *pdev)\n{\n\tstruct wilco_ec_device *ec = platform_get_drvdata(pdev);\n\n\tplatform_device_unregister(ec->telem_pdev);\n\tplatform_device_unregister(ec->charger_pdev);\n\twilco_ec_remove_sysfs(ec);\n\tplatform_device_unregister(ec->rtc_pdev);\n\tif (ec->debugfs_pdev)\n\t\tplatform_device_unregister(ec->debugfs_pdev);\n\treturn 0;\n}\n\nstatic const struct acpi_device_id wilco_ec_acpi_device_ids[] = {\n\t{ \"GOOG000C\", 0 },\n\t{ }\n};\nMODULE_DEVICE_TABLE(acpi, wilco_ec_acpi_device_ids);\n\nstatic struct platform_driver wilco_ec_driver = {\n\t.driver = {\n\t\t.name = DRV_NAME,\n\t\t.acpi_match_table = wilco_ec_acpi_device_ids,\n\t},\n\t.probe = wilco_ec_probe,\n\t.remove = wilco_ec_remove,\n};\n\nmodule_platform_driver(wilco_ec_driver);\n\nMODULE_AUTHOR(\"Nick Crews <ncrews@chromium.org>\");\nMODULE_AUTHOR(\"Duncan Laurie <dlaurie@chromium.org>\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"ChromeOS Wilco Embedded Controller driver\");\nMODULE_ALIAS(\"platform:\" DRV_NAME);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}