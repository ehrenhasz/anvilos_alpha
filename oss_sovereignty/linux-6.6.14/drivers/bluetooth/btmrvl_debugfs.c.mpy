{
  "module_name": "btmrvl_debugfs.c",
  "hash_id": "29091e3868cd713bf7dcaf4f457ec7b5b657e07d1b0b6daa69db937150ef0093",
  "original_prompt": "Ingested from linux-6.6.14/drivers/bluetooth/btmrvl_debugfs.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/slab.h>\n\n#include <net/bluetooth/bluetooth.h>\n#include <net/bluetooth/hci_core.h>\n\n#include \"btmrvl_drv.h\"\n\nstruct btmrvl_debugfs_data {\n\tstruct dentry *config_dir;\n\tstruct dentry *status_dir;\n};\n\nstatic ssize_t btmrvl_hscfgcmd_write(struct file *file,\n\t\t\tconst char __user *ubuf, size_t count, loff_t *ppos)\n{\n\tstruct btmrvl_private *priv = file->private_data;\n\tlong result, ret;\n\n\tret = kstrtol_from_user(ubuf, count, 10, &result);\n\tif (ret)\n\t\treturn ret;\n\n\tpriv->btmrvl_dev.hscfgcmd = result;\n\n\tif (priv->btmrvl_dev.hscfgcmd) {\n\t\tbtmrvl_prepare_command(priv);\n\t\twake_up_interruptible(&priv->main_thread.wait_q);\n\t}\n\n\treturn count;\n}\n\nstatic ssize_t btmrvl_hscfgcmd_read(struct file *file, char __user *userbuf,\n\t\t\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tstruct btmrvl_private *priv = file->private_data;\n\tchar buf[16];\n\tint ret;\n\n\tret = snprintf(buf, sizeof(buf) - 1, \"%d\\n\",\n\t\t\t\t\t\tpriv->btmrvl_dev.hscfgcmd);\n\n\treturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\n}\n\nstatic const struct file_operations btmrvl_hscfgcmd_fops = {\n\t.read\t= btmrvl_hscfgcmd_read,\n\t.write\t= btmrvl_hscfgcmd_write,\n\t.open\t= simple_open,\n\t.llseek = default_llseek,\n};\n\nstatic ssize_t btmrvl_pscmd_write(struct file *file, const char __user *ubuf,\n\t\t\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tstruct btmrvl_private *priv = file->private_data;\n\tlong result, ret;\n\n\tret = kstrtol_from_user(ubuf, count, 10, &result);\n\tif (ret)\n\t\treturn ret;\n\n\tpriv->btmrvl_dev.pscmd = result;\n\n\tif (priv->btmrvl_dev.pscmd) {\n\t\tbtmrvl_prepare_command(priv);\n\t\twake_up_interruptible(&priv->main_thread.wait_q);\n\t}\n\n\treturn count;\n\n}\n\nstatic ssize_t btmrvl_pscmd_read(struct file *file, char __user *userbuf,\n\t\t\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tstruct btmrvl_private *priv = file->private_data;\n\tchar buf[16];\n\tint ret;\n\n\tret = snprintf(buf, sizeof(buf) - 1, \"%d\\n\", priv->btmrvl_dev.pscmd);\n\n\treturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\n}\n\nstatic const struct file_operations btmrvl_pscmd_fops = {\n\t.read = btmrvl_pscmd_read,\n\t.write = btmrvl_pscmd_write,\n\t.open = simple_open,\n\t.llseek = default_llseek,\n};\n\nstatic ssize_t btmrvl_hscmd_write(struct file *file, const char __user *ubuf,\n\t\t\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tstruct btmrvl_private *priv = file->private_data;\n\tlong result, ret;\n\n\tret = kstrtol_from_user(ubuf, count, 10, &result);\n\tif (ret)\n\t\treturn ret;\n\n\tpriv->btmrvl_dev.hscmd = result;\n\tif (priv->btmrvl_dev.hscmd) {\n\t\tbtmrvl_prepare_command(priv);\n\t\twake_up_interruptible(&priv->main_thread.wait_q);\n\t}\n\n\treturn count;\n}\n\nstatic ssize_t btmrvl_hscmd_read(struct file *file, char __user *userbuf,\n\t\t\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tstruct btmrvl_private *priv = file->private_data;\n\tchar buf[16];\n\tint ret;\n\n\tret = snprintf(buf, sizeof(buf) - 1, \"%d\\n\", priv->btmrvl_dev.hscmd);\n\n\treturn simple_read_from_buffer(userbuf, count, ppos, buf, ret);\n}\n\nstatic const struct file_operations btmrvl_hscmd_fops = {\n\t.read\t= btmrvl_hscmd_read,\n\t.write\t= btmrvl_hscmd_write,\n\t.open\t= simple_open,\n\t.llseek = default_llseek,\n};\n\nvoid btmrvl_debugfs_init(struct hci_dev *hdev)\n{\n\tstruct btmrvl_private *priv = hci_get_drvdata(hdev);\n\tstruct btmrvl_debugfs_data *dbg;\n\n\tif (!hdev->debugfs)\n\t\treturn;\n\n\tdbg = kzalloc(sizeof(*dbg), GFP_KERNEL);\n\tpriv->debugfs_data = dbg;\n\n\tif (!dbg) {\n\t\tBT_ERR(\"Can not allocate memory for btmrvl_debugfs_data.\");\n\t\treturn;\n\t}\n\n\tdbg->config_dir = debugfs_create_dir(\"config\", hdev->debugfs);\n\n\tdebugfs_create_u8(\"psmode\", 0644, dbg->config_dir,\n\t\t\t  &priv->btmrvl_dev.psmode);\n\tdebugfs_create_file(\"pscmd\", 0644, dbg->config_dir,\n\t\t\t    priv, &btmrvl_pscmd_fops);\n\tdebugfs_create_x16(\"gpiogap\", 0644, dbg->config_dir,\n\t\t\t   &priv->btmrvl_dev.gpio_gap);\n\tdebugfs_create_u8(\"hsmode\", 0644, dbg->config_dir,\n\t\t\t  &priv->btmrvl_dev.hsmode);\n\tdebugfs_create_file(\"hscmd\", 0644, dbg->config_dir,\n\t\t\t    priv, &btmrvl_hscmd_fops);\n\tdebugfs_create_file(\"hscfgcmd\", 0644, dbg->config_dir,\n\t\t\t    priv, &btmrvl_hscfgcmd_fops);\n\n\tdbg->status_dir = debugfs_create_dir(\"status\", hdev->debugfs);\n\tdebugfs_create_u8(\"curpsmode\", 0444, dbg->status_dir,\n\t\t\t  &priv->adapter->psmode);\n\tdebugfs_create_u8(\"psstate\", 0444, dbg->status_dir,\n\t\t\t  &priv->adapter->ps_state);\n\tdebugfs_create_u8(\"hsstate\", 0444, dbg->status_dir,\n\t\t\t  &priv->adapter->hs_state);\n\tdebugfs_create_u8(\"txdnldready\", 0444, dbg->status_dir,\n\t\t\t  &priv->btmrvl_dev.tx_dnld_rdy);\n}\n\nvoid btmrvl_debugfs_remove(struct hci_dev *hdev)\n{\n\tstruct btmrvl_private *priv = hci_get_drvdata(hdev);\n\tstruct btmrvl_debugfs_data *dbg = priv->debugfs_data;\n\n\tif (!dbg)\n\t\treturn;\n\n\tdebugfs_remove_recursive(dbg->config_dir);\n\tdebugfs_remove_recursive(dbg->status_dir);\n\n\tkfree(dbg);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}