{
  "module_name": "governor_simpleondemand.c",
  "hash_id": "f1c1095da2c00feacb36ef0a9c3ec7df5355d9fb22be27e036190e5d77869e52",
  "original_prompt": "Ingested from linux-6.6.14/drivers/devfreq/governor_simpleondemand.c",
  "human_readable_source": "\n \n\n#include <linux/errno.h>\n#include <linux/module.h>\n#include <linux/devfreq.h>\n#include <linux/math64.h>\n#include \"governor.h\"\n\n \n#define DFSO_UPTHRESHOLD\t(90)\n#define DFSO_DOWNDIFFERENCTIAL\t(5)\nstatic int devfreq_simple_ondemand_func(struct devfreq *df,\n\t\t\t\t\tunsigned long *freq)\n{\n\tint err;\n\tstruct devfreq_dev_status *stat;\n\tunsigned long long a, b;\n\tunsigned int dfso_upthreshold = DFSO_UPTHRESHOLD;\n\tunsigned int dfso_downdifferential = DFSO_DOWNDIFFERENCTIAL;\n\tstruct devfreq_simple_ondemand_data *data = df->data;\n\n\terr = devfreq_update_stats(df);\n\tif (err)\n\t\treturn err;\n\n\tstat = &df->last_status;\n\n\tif (data) {\n\t\tif (data->upthreshold)\n\t\t\tdfso_upthreshold = data->upthreshold;\n\t\tif (data->downdifferential)\n\t\t\tdfso_downdifferential = data->downdifferential;\n\t}\n\tif (dfso_upthreshold > 100 ||\n\t    dfso_upthreshold < dfso_downdifferential)\n\t\treturn -EINVAL;\n\n\t \n\tif (stat->total_time == 0) {\n\t\t*freq = DEVFREQ_MAX_FREQ;\n\t\treturn 0;\n\t}\n\n\t \n\tif (stat->busy_time >= (1 << 24) || stat->total_time >= (1 << 24)) {\n\t\tstat->busy_time >>= 7;\n\t\tstat->total_time >>= 7;\n\t}\n\n\t \n\tif (stat->busy_time * 100 >\n\t    stat->total_time * dfso_upthreshold) {\n\t\t*freq = DEVFREQ_MAX_FREQ;\n\t\treturn 0;\n\t}\n\n\t \n\tif (stat->current_frequency == 0) {\n\t\t*freq = DEVFREQ_MAX_FREQ;\n\t\treturn 0;\n\t}\n\n\t \n\tif (stat->busy_time * 100 >\n\t    stat->total_time * (dfso_upthreshold - dfso_downdifferential)) {\n\t\t*freq = stat->current_frequency;\n\t\treturn 0;\n\t}\n\n\t \n\ta = stat->busy_time;\n\ta *= stat->current_frequency;\n\tb = div_u64(a, stat->total_time);\n\tb *= 100;\n\tb = div_u64(b, (dfso_upthreshold - dfso_downdifferential / 2));\n\t*freq = (unsigned long) b;\n\n\treturn 0;\n}\n\nstatic int devfreq_simple_ondemand_handler(struct devfreq *devfreq,\n\t\t\t\tunsigned int event, void *data)\n{\n\tswitch (event) {\n\tcase DEVFREQ_GOV_START:\n\t\tdevfreq_monitor_start(devfreq);\n\t\tbreak;\n\n\tcase DEVFREQ_GOV_STOP:\n\t\tdevfreq_monitor_stop(devfreq);\n\t\tbreak;\n\n\tcase DEVFREQ_GOV_UPDATE_INTERVAL:\n\t\tdevfreq_update_interval(devfreq, (unsigned int *)data);\n\t\tbreak;\n\n\tcase DEVFREQ_GOV_SUSPEND:\n\t\tdevfreq_monitor_suspend(devfreq);\n\t\tbreak;\n\n\tcase DEVFREQ_GOV_RESUME:\n\t\tdevfreq_monitor_resume(devfreq);\n\t\tbreak;\n\n\tdefault:\n\t\tbreak;\n\t}\n\n\treturn 0;\n}\n\nstatic struct devfreq_governor devfreq_simple_ondemand = {\n\t.name = DEVFREQ_GOV_SIMPLE_ONDEMAND,\n\t.attrs = DEVFREQ_GOV_ATTR_POLLING_INTERVAL\n\t\t| DEVFREQ_GOV_ATTR_TIMER,\n\t.get_target_freq = devfreq_simple_ondemand_func,\n\t.event_handler = devfreq_simple_ondemand_handler,\n};\n\nstatic int __init devfreq_simple_ondemand_init(void)\n{\n\treturn devfreq_add_governor(&devfreq_simple_ondemand);\n}\nsubsys_initcall(devfreq_simple_ondemand_init);\n\nstatic void __exit devfreq_simple_ondemand_exit(void)\n{\n\tint ret;\n\n\tret = devfreq_remove_governor(&devfreq_simple_ondemand);\n\tif (ret)\n\t\tpr_err(\"%s: failed remove governor %d\\n\", __func__, ret);\n\n\treturn;\n}\nmodule_exit(devfreq_simple_ondemand_exit);\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}