{
  "module_name": "imx-bus.c",
  "hash_id": "c260d53acffdd93e95e70bbb1f81ae263fb9748573e102ee6e2600e52d66b1ed",
  "original_prompt": "Ingested from linux-6.6.14/drivers/devfreq/imx-bus.c",
  "human_readable_source": "\n \n\n#include <linux/clk.h>\n#include <linux/devfreq.h>\n#include <linux/device.h>\n#include <linux/module.h>\n#include <linux/of.h>\n#include <linux/pm_opp.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\nstruct imx_bus {\n\tstruct devfreq_dev_profile profile;\n\tstruct devfreq *devfreq;\n\tstruct clk *clk;\n\tstruct platform_device *icc_pdev;\n};\n\nstatic int imx_bus_target(struct device *dev,\n\t\tunsigned long *freq, u32 flags)\n{\n\tstruct dev_pm_opp *new_opp;\n\tint ret;\n\n\tnew_opp = devfreq_recommended_opp(dev, freq, flags);\n\tif (IS_ERR(new_opp)) {\n\t\tret = PTR_ERR(new_opp);\n\t\tdev_err(dev, \"failed to get recommended opp: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tdev_pm_opp_put(new_opp);\n\n\treturn dev_pm_opp_set_rate(dev, *freq);\n}\n\nstatic int imx_bus_get_cur_freq(struct device *dev, unsigned long *freq)\n{\n\tstruct imx_bus *priv = dev_get_drvdata(dev);\n\n\t*freq = clk_get_rate(priv->clk);\n\n\treturn 0;\n}\n\nstatic void imx_bus_exit(struct device *dev)\n{\n\tstruct imx_bus *priv = dev_get_drvdata(dev);\n\n\tdev_pm_opp_of_remove_table(dev);\n\tplatform_device_unregister(priv->icc_pdev);\n}\n\n \nstatic int imx_bus_init_icc(struct device *dev)\n{\n\tstruct imx_bus *priv = dev_get_drvdata(dev);\n\tconst char *icc_driver_name;\n\n\tif (!of_get_property(dev->of_node, \"#interconnect-cells\", NULL))\n\t\treturn 0;\n\tif (!IS_ENABLED(CONFIG_INTERCONNECT_IMX)) {\n\t\tdev_warn(dev, \"imx interconnect drivers disabled\\n\");\n\t\treturn 0;\n\t}\n\n\ticc_driver_name = of_device_get_match_data(dev);\n\tif (!icc_driver_name) {\n\t\tdev_err(dev, \"unknown interconnect driver\\n\");\n\t\treturn 0;\n\t}\n\n\tpriv->icc_pdev = platform_device_register_data(\n\t\t\tdev, icc_driver_name, -1, NULL, 0);\n\tif (IS_ERR(priv->icc_pdev)) {\n\t\tdev_err(dev, \"failed to register icc provider %s: %ld\\n\",\n\t\t\t\ticc_driver_name, PTR_ERR(priv->icc_pdev));\n\t\treturn PTR_ERR(priv->icc_pdev);\n\t}\n\n\treturn 0;\n}\n\nstatic int imx_bus_probe(struct platform_device *pdev)\n{\n\tstruct device *dev = &pdev->dev;\n\tstruct imx_bus *priv;\n\tconst char *gov = DEVFREQ_GOV_USERSPACE;\n\tint ret;\n\n\tpriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\n\tif (!priv)\n\t\treturn -ENOMEM;\n\n\t \n\tpriv->clk = devm_clk_get(dev, NULL);\n\tif (IS_ERR(priv->clk)) {\n\t\tret = PTR_ERR(priv->clk);\n\t\tdev_err(dev, \"failed to fetch clk: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\tplatform_set_drvdata(pdev, priv);\n\n\tret = dev_pm_opp_of_add_table(dev);\n\tif (ret < 0) {\n\t\tdev_err(dev, \"failed to get OPP table\\n\");\n\t\treturn ret;\n\t}\n\n\tpriv->profile.target = imx_bus_target;\n\tpriv->profile.exit = imx_bus_exit;\n\tpriv->profile.get_cur_freq = imx_bus_get_cur_freq;\n\tpriv->profile.initial_freq = clk_get_rate(priv->clk);\n\n\tpriv->devfreq = devm_devfreq_add_device(dev, &priv->profile,\n\t\t\t\t\t\tgov, NULL);\n\tif (IS_ERR(priv->devfreq)) {\n\t\tret = PTR_ERR(priv->devfreq);\n\t\tdev_err(dev, \"failed to add devfreq device: %d\\n\", ret);\n\t\tgoto err;\n\t}\n\n\tret = imx_bus_init_icc(dev);\n\tif (ret)\n\t\tgoto err;\n\n\treturn 0;\n\nerr:\n\tdev_pm_opp_of_remove_table(dev);\n\treturn ret;\n}\n\nstatic const struct of_device_id imx_bus_of_match[] = {\n\t{ .compatible = \"fsl,imx8mq-noc\", .data = \"imx8mq-interconnect\", },\n\t{ .compatible = \"fsl,imx8mm-noc\", .data = \"imx8mm-interconnect\", },\n\t{ .compatible = \"fsl,imx8mn-noc\", .data = \"imx8mn-interconnect\", },\n\t{ .compatible = \"fsl,imx8mp-noc\", .data = \"imx8mp-interconnect\", },\n\t{ .compatible = \"fsl,imx8m-noc\", },\n\t{ .compatible = \"fsl,imx8m-nic\", },\n\t{   },\n};\nMODULE_DEVICE_TABLE(of, imx_bus_of_match);\n\nstatic struct platform_driver imx_bus_platdrv = {\n\t.probe\t\t= imx_bus_probe,\n\t.driver = {\n\t\t.name\t= \"imx-bus-devfreq\",\n\t\t.of_match_table = imx_bus_of_match,\n\t},\n};\nmodule_platform_driver(imx_bus_platdrv);\n\nMODULE_DESCRIPTION(\"Generic i.MX bus frequency scaling driver\");\nMODULE_AUTHOR(\"Leonard Crestez <leonard.crestez@nxp.com>\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}