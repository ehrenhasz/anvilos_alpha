{
  "module_name": "usb.c",
  "hash_id": "337d8bb557da3f5805a1f7032ce48d48ba152db0da4611aa1bb1ed1885331a26",
  "original_prompt": "Ingested from linux-6.6.14/drivers/gnss/usb.c",
  "human_readable_source": "\n \n\n#include <linux/errno.h>\n#include <linux/gnss.h>\n#include <linux/init.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/slab.h>\n#include <linux/usb.h>\n\n#define GNSS_USB_READ_BUF_LEN\t512\n#define GNSS_USB_WRITE_TIMEOUT\t1000\n\nstatic const struct usb_device_id gnss_usb_id_table[] = {\n\t{ USB_DEVICE(0x1199, 0xb000) },\t\t \n\t{ }\n};\nMODULE_DEVICE_TABLE(usb, gnss_usb_id_table);\n\nstruct gnss_usb {\n\tstruct usb_device *udev;\n\tstruct usb_interface *intf;\n\tstruct gnss_device *gdev;\n\tstruct urb *read_urb;\n\tunsigned int write_pipe;\n};\n\nstatic void gnss_usb_rx_complete(struct urb *urb)\n{\n\tstruct gnss_usb *gusb = urb->context;\n\tstruct gnss_device *gdev = gusb->gdev;\n\tint status = urb->status;\n\tint len;\n\tint ret;\n\n\tswitch (status) {\n\tcase 0:\n\t\tbreak;\n\tcase -ENOENT:\n\tcase -ECONNRESET:\n\tcase -ESHUTDOWN:\n\t\tdev_dbg(&gdev->dev, \"urb stopped: %d\\n\", status);\n\t\treturn;\n\tcase -EPIPE:\n\t\tdev_err(&gdev->dev, \"urb stopped: %d\\n\", status);\n\t\treturn;\n\tdefault:\n\t\tdev_dbg(&gdev->dev, \"nonzero urb status: %d\\n\", status);\n\t\tgoto resubmit;\n\t}\n\n\tlen = urb->actual_length;\n\tif (len == 0)\n\t\tgoto resubmit;\n\n\tret = gnss_insert_raw(gdev, urb->transfer_buffer, len);\n\tif (ret < len)\n\t\tdev_dbg(&gdev->dev, \"dropped %d bytes\\n\", len - ret);\nresubmit:\n\tret = usb_submit_urb(urb, GFP_ATOMIC);\n\tif (ret && ret != -EPERM && ret != -ENODEV)\n\t\tdev_err(&gdev->dev, \"failed to resubmit urb: %d\\n\", ret);\n}\n\nstatic int gnss_usb_open(struct gnss_device *gdev)\n{\n\tstruct gnss_usb *gusb = gnss_get_drvdata(gdev);\n\tint ret;\n\n\tret = usb_submit_urb(gusb->read_urb, GFP_KERNEL);\n\tif (ret) {\n\t\tif (ret != -EPERM && ret != -ENODEV)\n\t\t\tdev_err(&gdev->dev, \"failed to submit urb: %d\\n\", ret);\n\t\treturn ret;\n\t}\n\n\treturn 0;\n}\n\nstatic void gnss_usb_close(struct gnss_device *gdev)\n{\n\tstruct gnss_usb *gusb = gnss_get_drvdata(gdev);\n\n\tusb_kill_urb(gusb->read_urb);\n}\n\nstatic int gnss_usb_write_raw(struct gnss_device *gdev,\n\t\tconst unsigned char *buf, size_t count)\n{\n\tstruct gnss_usb *gusb = gnss_get_drvdata(gdev);\n\tvoid *tbuf;\n\tint ret;\n\n\ttbuf = kmemdup(buf, count, GFP_KERNEL);\n\tif (!tbuf)\n\t\treturn -ENOMEM;\n\n\tret = usb_bulk_msg(gusb->udev, gusb->write_pipe, tbuf, count, NULL,\n\t\t\tGNSS_USB_WRITE_TIMEOUT);\n\tkfree(tbuf);\n\tif (ret)\n\t\treturn ret;\n\n\treturn count;\n}\n\nstatic const struct gnss_operations gnss_usb_gnss_ops = {\n\t.open\t\t= gnss_usb_open,\n\t.close\t\t= gnss_usb_close,\n\t.write_raw\t= gnss_usb_write_raw,\n};\n\nstatic int gnss_usb_probe(struct usb_interface *intf, const struct usb_device_id *id)\n{\n\tstruct usb_device *udev = interface_to_usbdev(intf);\n\tstruct usb_endpoint_descriptor *in, *out;\n\tstruct gnss_device *gdev;\n\tstruct gnss_usb *gusb;\n\tstruct urb *urb;\n\tsize_t buf_len;\n\tvoid *buf;\n\tint ret;\n\n\tret = usb_find_common_endpoints(intf->cur_altsetting, &in, &out, NULL,\n\t\t\tNULL);\n\tif (ret)\n\t\treturn ret;\n\n\tgusb = kzalloc(sizeof(*gusb), GFP_KERNEL);\n\tif (!gusb)\n\t\treturn -ENOMEM;\n\n\tgdev = gnss_allocate_device(&intf->dev);\n\tif (!gdev) {\n\t\tret = -ENOMEM;\n\t\tgoto err_free_gusb;\n\t}\n\n\tgdev->ops = &gnss_usb_gnss_ops;\n\tgdev->type = GNSS_TYPE_NMEA;\n\tgnss_set_drvdata(gdev, gusb);\n\n\turb = usb_alloc_urb(0, GFP_KERNEL);\n\tif (!urb) {\n\t\tret = -ENOMEM;\n\t\tgoto err_put_gdev;\n\t}\n\n\tbuf_len = max(usb_endpoint_maxp(in), GNSS_USB_READ_BUF_LEN);\n\n\tbuf = kzalloc(buf_len, GFP_KERNEL);\n\tif (!buf) {\n\t\tret = -ENOMEM;\n\t\tgoto err_free_urb;\n\t}\n\n\tusb_fill_bulk_urb(urb, udev,\n\t\t\tusb_rcvbulkpipe(udev, usb_endpoint_num(in)),\n\t\t\tbuf, buf_len, gnss_usb_rx_complete, gusb);\n\n\tgusb->intf = intf;\n\tgusb->udev = udev;\n\tgusb->gdev = gdev;\n\tgusb->read_urb = urb;\n\tgusb->write_pipe = usb_sndbulkpipe(udev, usb_endpoint_num(out));\n\n\tret = gnss_register_device(gdev);\n\tif (ret)\n\t\tgoto err_free_buf;\n\n\tusb_set_intfdata(intf, gusb);\n\n\treturn 0;\n\nerr_free_buf:\n\tkfree(buf);\nerr_free_urb:\n\tusb_free_urb(urb);\nerr_put_gdev:\n\tgnss_put_device(gdev);\nerr_free_gusb:\n\tkfree(gusb);\n\n\treturn ret;\n}\n\nstatic void gnss_usb_disconnect(struct usb_interface *intf)\n{\n\tstruct gnss_usb *gusb = usb_get_intfdata(intf);\n\n\tgnss_deregister_device(gusb->gdev);\n\n\tkfree(gusb->read_urb->transfer_buffer);\n\tusb_free_urb(gusb->read_urb);\n\tgnss_put_device(gusb->gdev);\n\tkfree(gusb);\n}\n\nstatic struct usb_driver gnss_usb_driver = {\n\t.name\t\t= \"gnss-usb\",\n\t.probe\t\t= gnss_usb_probe,\n\t.disconnect\t= gnss_usb_disconnect,\n\t.id_table\t= gnss_usb_id_table,\n};\nmodule_usb_driver(gnss_usb_driver);\n\nMODULE_AUTHOR(\"Johan Hovold <johan@kernel.org>\");\nMODULE_DESCRIPTION(\"Generic USB GNSS receiver driver\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}