{
  "module_name": "dm-path-selector.c",
  "hash_id": "a06dfdf644122770ddb1e1daeec442567e6ab92f903871b4f4bbba3e39397f5c",
  "original_prompt": "Ingested from linux-6.6.14/drivers/md/dm-path-selector.c",
  "human_readable_source": "\n \n\n#include <linux/device-mapper.h>\n#include <linux/module.h>\n\n#include \"dm-path-selector.h\"\n\n#include <linux/slab.h>\n\nstruct ps_internal {\n\tstruct path_selector_type pst;\n\tstruct list_head list;\n};\n\n#define pst_to_psi(__pst) container_of((__pst), struct ps_internal, pst)\n\nstatic LIST_HEAD(_path_selectors);\nstatic DECLARE_RWSEM(_ps_lock);\n\nstatic struct ps_internal *__find_path_selector_type(const char *name)\n{\n\tstruct ps_internal *psi;\n\n\tlist_for_each_entry(psi, &_path_selectors, list) {\n\t\tif (!strcmp(name, psi->pst.name))\n\t\t\treturn psi;\n\t}\n\n\treturn NULL;\n}\n\nstatic struct ps_internal *get_path_selector(const char *name)\n{\n\tstruct ps_internal *psi;\n\n\tdown_read(&_ps_lock);\n\tpsi = __find_path_selector_type(name);\n\tif (psi && !try_module_get(psi->pst.module))\n\t\tpsi = NULL;\n\tup_read(&_ps_lock);\n\n\treturn psi;\n}\n\nstruct path_selector_type *dm_get_path_selector(const char *name)\n{\n\tstruct ps_internal *psi;\n\n\tif (!name)\n\t\treturn NULL;\n\n\tpsi = get_path_selector(name);\n\tif (!psi) {\n\t\trequest_module(\"dm-%s\", name);\n\t\tpsi = get_path_selector(name);\n\t}\n\n\treturn psi ? &psi->pst : NULL;\n}\n\nvoid dm_put_path_selector(struct path_selector_type *pst)\n{\n\tstruct ps_internal *psi;\n\n\tif (!pst)\n\t\treturn;\n\n\tdown_read(&_ps_lock);\n\tpsi = __find_path_selector_type(pst->name);\n\tif (!psi)\n\t\tgoto out;\n\n\tmodule_put(psi->pst.module);\nout:\n\tup_read(&_ps_lock);\n}\n\nstatic struct ps_internal *_alloc_path_selector(struct path_selector_type *pst)\n{\n\tstruct ps_internal *psi = kzalloc(sizeof(*psi), GFP_KERNEL);\n\n\tif (psi)\n\t\tpsi->pst = *pst;\n\n\treturn psi;\n}\n\nint dm_register_path_selector(struct path_selector_type *pst)\n{\n\tint r = 0;\n\tstruct ps_internal *psi = _alloc_path_selector(pst);\n\n\tif (!psi)\n\t\treturn -ENOMEM;\n\n\tdown_write(&_ps_lock);\n\n\tif (__find_path_selector_type(pst->name)) {\n\t\tkfree(psi);\n\t\tr = -EEXIST;\n\t} else\n\t\tlist_add(&psi->list, &_path_selectors);\n\n\tup_write(&_ps_lock);\n\n\treturn r;\n}\nEXPORT_SYMBOL_GPL(dm_register_path_selector);\n\nint dm_unregister_path_selector(struct path_selector_type *pst)\n{\n\tstruct ps_internal *psi;\n\n\tdown_write(&_ps_lock);\n\n\tpsi = __find_path_selector_type(pst->name);\n\tif (!psi) {\n\t\tup_write(&_ps_lock);\n\t\treturn -EINVAL;\n\t}\n\n\tlist_del(&psi->list);\n\n\tup_write(&_ps_lock);\n\n\tkfree(psi);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(dm_unregister_path_selector);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}