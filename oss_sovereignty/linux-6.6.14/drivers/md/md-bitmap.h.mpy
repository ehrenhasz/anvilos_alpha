{
  "module_name": "md-bitmap.h",
  "hash_id": "6d1aa81f94a6f74b63f77503e61bf841242aa21542d7417f30724bb5a5ef3e5e",
  "original_prompt": "Ingested from linux-6.6.14/drivers/md/md-bitmap.h",
  "human_readable_source": " \n \n#ifndef BITMAP_H\n#define BITMAP_H 1\n\n#define BITMAP_MAJOR_LO 3\n \n#define BITMAP_MAJOR_HI 4\n#define BITMAP_MAJOR_CLUSTERED 5\n#define\tBITMAP_MAJOR_HOSTENDIAN 3\n\n \n\n#ifdef __KERNEL__\n\n#define PAGE_BITS (PAGE_SIZE << 3)\n#define PAGE_BIT_SHIFT (PAGE_SHIFT + 3)\n\ntypedef __u16 bitmap_counter_t;\n#define COUNTER_BITS 16\n#define COUNTER_BIT_SHIFT 4\n#define COUNTER_BYTE_SHIFT (COUNTER_BIT_SHIFT - 3)\n\n#define NEEDED_MASK ((bitmap_counter_t) (1 << (COUNTER_BITS - 1)))\n#define RESYNC_MASK ((bitmap_counter_t) (1 << (COUNTER_BITS - 2)))\n#define COUNTER_MAX ((bitmap_counter_t) RESYNC_MASK - 1)\n#define NEEDED(x) (((bitmap_counter_t) x) & NEEDED_MASK)\n#define RESYNC(x) (((bitmap_counter_t) x) & RESYNC_MASK)\n#define COUNTER(x) (((bitmap_counter_t) x) & COUNTER_MAX)\n\n \n#define PAGE_COUNTER_RATIO (PAGE_BITS / COUNTER_BITS)\n \n#define PAGE_COUNTER_SHIFT (PAGE_BIT_SHIFT - COUNTER_BIT_SHIFT)\n \n#define PAGE_COUNTER_MASK  (PAGE_COUNTER_RATIO - 1)\n\n#define BITMAP_BLOCK_SHIFT 9\n\n#endif\n\n \n\n#define BITMAP_MAGIC 0x6d746962\n\n \nenum bitmap_state {\n\tBITMAP_STALE\t   = 1,   \n\tBITMAP_WRITE_ERROR = 2,  \n\tBITMAP_HOSTENDIAN  =15,\n};\n\n \ntypedef struct bitmap_super_s {\n\t__le32 magic;         \n\t__le32 version;       \n\t__u8  uuid[16];       \n\t__le64 events;        \n\t__le64 events_cleared; \n\t__le64 sync_size;     \n\t__le32 state;         \n\t__le32 chunksize;     \n\t__le32 daemon_sleep;  \n\t__le32 write_behind;  \n\t__le32 sectors_reserved;  \n\t__le32 nodes;         \n\t__u8 cluster_name[64];  \n\t__u8  pad[256 - 136];  \n} bitmap_super_t;\n\n \n\n#ifdef __KERNEL__\n\n \nstruct bitmap_page {\n\t \n\tchar *map;\n\t \n\tunsigned int hijacked:1;\n\t \n\tunsigned int pending:1;\n\t \n\tunsigned int  count:30;\n};\n\n \nstruct bitmap {\n\n\tstruct bitmap_counts {\n\t\tspinlock_t lock;\n\t\tstruct bitmap_page *bp;\n\t\tunsigned long pages;\t\t \n\t\tunsigned long missing_pages;\t \n\t\tunsigned long chunkshift;\t \n\t\tunsigned long chunks;\t\t \n\t} counts;\n\n\tstruct mddev *mddev;  \n\n\t__u64\tevents_cleared;\n\tint need_sync;\n\n\tstruct bitmap_storage {\n\t\tstruct file *file;\t\t \n\t\tstruct page *sb_page;\t\t \n\t\tunsigned long sb_index;\n\t\tstruct page **filemap;\t\t \n\t\tunsigned long *filemap_attr;\t \n\t\tunsigned long file_pages;\t \n\t\tunsigned long bytes;\t\t \n\t} storage;\n\n\tunsigned long flags;\n\n\tint allclean;\n\n\tatomic_t behind_writes;\n\tunsigned long behind_writes_used;  \n\n\t \n\tunsigned long daemon_lastrun;  \n\tunsigned long last_end_sync;  \n\n\tatomic_t pending_writes;  \n\twait_queue_head_t write_wait;\n\twait_queue_head_t overflow_wait;\n\twait_queue_head_t behind_wait;\n\n\tstruct kernfs_node *sysfs_can_clear;\n\tint cluster_slot;\t\t \n};\n\n \n\n \nstruct bitmap *md_bitmap_create(struct mddev *mddev, int slot);\nint md_bitmap_load(struct mddev *mddev);\nvoid md_bitmap_flush(struct mddev *mddev);\nvoid md_bitmap_destroy(struct mddev *mddev);\n\nvoid md_bitmap_print_sb(struct bitmap *bitmap);\nvoid md_bitmap_update_sb(struct bitmap *bitmap);\nvoid md_bitmap_status(struct seq_file *seq, struct bitmap *bitmap);\n\nint  md_bitmap_setallbits(struct bitmap *bitmap);\nvoid md_bitmap_write_all(struct bitmap *bitmap);\n\nvoid md_bitmap_dirty_bits(struct bitmap *bitmap, unsigned long s, unsigned long e);\n\n \nint md_bitmap_startwrite(struct bitmap *bitmap, sector_t offset,\n\t\t\t unsigned long sectors, int behind);\nvoid md_bitmap_endwrite(struct bitmap *bitmap, sector_t offset,\n\t\t\tunsigned long sectors, int success, int behind);\nint md_bitmap_start_sync(struct bitmap *bitmap, sector_t offset, sector_t *blocks, int degraded);\nvoid md_bitmap_end_sync(struct bitmap *bitmap, sector_t offset, sector_t *blocks, int aborted);\nvoid md_bitmap_close_sync(struct bitmap *bitmap);\nvoid md_bitmap_cond_end_sync(struct bitmap *bitmap, sector_t sector, bool force);\nvoid md_bitmap_sync_with_cluster(struct mddev *mddev,\n\t\t\t\t sector_t old_lo, sector_t old_hi,\n\t\t\t\t sector_t new_lo, sector_t new_hi);\n\nvoid md_bitmap_unplug(struct bitmap *bitmap);\nvoid md_bitmap_unplug_async(struct bitmap *bitmap);\nvoid md_bitmap_daemon_work(struct mddev *mddev);\n\nint md_bitmap_resize(struct bitmap *bitmap, sector_t blocks,\n\t\t     int chunksize, int init);\nstruct bitmap *get_bitmap_from_slot(struct mddev *mddev, int slot);\nint md_bitmap_copy_from_slot(struct mddev *mddev, int slot,\n\t\t\t     sector_t *lo, sector_t *hi, bool clear_bits);\nvoid md_bitmap_free(struct bitmap *bitmap);\nvoid md_bitmap_wait_behind_writes(struct mddev *mddev);\n\nstatic inline bool md_bitmap_enabled(struct bitmap *bitmap)\n{\n\treturn bitmap && bitmap->storage.filemap &&\n\t       !test_bit(BITMAP_STALE, &bitmap->flags);\n}\n\n#endif\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}