{
  "module_name": "dm-verity-loadpin.c",
  "hash_id": "8b1dc382d6ebf7ebc7608f62e3a28f679fed555b90a77dd1f97993d148c73e70",
  "original_prompt": "Ingested from linux-6.6.14/drivers/md/dm-verity-loadpin.c",
  "human_readable_source": "\n\n#include <linux/list.h>\n#include <linux/kernel.h>\n#include <linux/dm-verity-loadpin.h>\n\n#include \"dm.h\"\n#include \"dm-core.h\"\n#include \"dm-verity.h\"\n\n#define DM_MSG_PREFIX\t\"verity-loadpin\"\n\nLIST_HEAD(dm_verity_loadpin_trusted_root_digests);\n\nstatic bool is_trusted_verity_target(struct dm_target *ti)\n{\n\tint verity_mode;\n\tu8 *root_digest;\n\tunsigned int digest_size;\n\tstruct dm_verity_loadpin_trusted_root_digest *trd;\n\tbool trusted = false;\n\n\tif (!dm_is_verity_target(ti))\n\t\treturn false;\n\n\tverity_mode = dm_verity_get_mode(ti);\n\n\tif ((verity_mode != DM_VERITY_MODE_EIO) &&\n\t    (verity_mode != DM_VERITY_MODE_RESTART) &&\n\t    (verity_mode != DM_VERITY_MODE_PANIC))\n\t\treturn false;\n\n\tif (dm_verity_get_root_digest(ti, &root_digest, &digest_size))\n\t\treturn false;\n\n\tlist_for_each_entry(trd, &dm_verity_loadpin_trusted_root_digests, node) {\n\t\tif ((trd->len == digest_size) &&\n\t\t    !memcmp(trd->data, root_digest, digest_size)) {\n\t\t\ttrusted = true;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tkfree(root_digest);\n\n\treturn trusted;\n}\n\n \nbool dm_verity_loadpin_is_bdev_trusted(struct block_device *bdev)\n{\n\tstruct mapped_device *md;\n\tstruct dm_table *table;\n\tstruct dm_target *ti;\n\tint srcu_idx;\n\tbool trusted = false;\n\n\tif (bdev == NULL)\n\t\treturn false;\n\n\tif (list_empty(&dm_verity_loadpin_trusted_root_digests))\n\t\treturn false;\n\n\tmd = dm_get_md(bdev->bd_dev);\n\tif (!md)\n\t\treturn false;\n\n\ttable = dm_get_live_table(md, &srcu_idx);\n\n\tif (table->num_targets != 1)\n\t\tgoto out;\n\n\tti = dm_table_get_target(table, 0);\n\n\tif (is_trusted_verity_target(ti))\n\t\ttrusted = true;\n\nout:\n\tdm_put_live_table(md, srcu_idx);\n\tdm_put(md);\n\n\treturn trusted;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}