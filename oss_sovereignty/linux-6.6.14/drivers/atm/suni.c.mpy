{
  "module_name": "suni.c",
  "hash_id": "6690e207523c1790a19fa60b6c2c167cfc521ce4f36e933973bb60f1369f4a3d",
  "original_prompt": "Ingested from linux-6.6.14/drivers/atm/suni.c",
  "human_readable_source": "\n \n \n \n\n#include <linux/module.h>\n#include <linux/jiffies.h>\n#include <linux/kernel.h>\n#include <linux/mm.h>\n#include <linux/errno.h>\n#include <linux/atmdev.h>\n#include <linux/sonet.h>\n#include <linux/delay.h>\n#include <linux/timer.h>\n#include <linux/init.h>\n#include <linux/capability.h>\n#include <linux/slab.h>\n#include <asm/param.h>\n#include <linux/uaccess.h>\n#include <linux/atomic.h>\n\n#include \"suni.h\"\n\n\n#if 0\n#define DPRINTK(format,args...) printk(KERN_DEBUG format,##args)\n#else\n#define DPRINTK(format,args...)\n#endif\n\n#define PRIV(dev) ((struct suni_priv *) dev->phy_data)\n\n#define PUT(val,reg) dev->ops->phy_put(dev,val,SUNI_##reg)\n#define GET(reg) dev->ops->phy_get(dev,SUNI_##reg)\n#define REG_CHANGE(mask,shift,value,reg) \\\n  PUT((GET(reg) & ~(mask)) | ((value) << (shift)),reg)\n\n\nstatic struct timer_list poll_timer;\nstatic struct suni_priv *sunis = NULL;\nstatic DEFINE_SPINLOCK(sunis_lock);\n\n\n#define ADD_LIMITED(s,v) \\\n    atomic_add((v),&stats->s); \\\n    if (atomic_read(&stats->s) < 0) atomic_set(&stats->s,INT_MAX);\n\n\nstatic void suni_hz(struct timer_list *timer)\n{\n\tstruct suni_priv *walk;\n\tstruct atm_dev *dev;\n\tstruct k_sonet_stats *stats;\n\n\tfor (walk = sunis; walk; walk = walk->next) {\n\t\tdev = walk->dev;\n\t\tstats = &walk->sonet_stats;\n\t\tPUT(0,MRI);  \n\t\tudelay(1);\n\t\tADD_LIMITED(section_bip,(GET(RSOP_SBL) & 0xff) |\n\t\t    ((GET(RSOP_SBM) & 0xff) << 8));\n\t\tADD_LIMITED(line_bip,(GET(RLOP_LBL) & 0xff) |\n\t\t    ((GET(RLOP_LB) & 0xff) << 8) |\n\t\t    ((GET(RLOP_LBM) & 0xf) << 16));\n\t\tADD_LIMITED(path_bip,(GET(RPOP_PBL) & 0xff) |\n\t\t    ((GET(RPOP_PBM) & 0xff) << 8));\n\t\tADD_LIMITED(line_febe,(GET(RLOP_LFL) & 0xff) |\n\t\t    ((GET(RLOP_LF) & 0xff) << 8) |\n\t\t    ((GET(RLOP_LFM) & 0xf) << 16));\n\t\tADD_LIMITED(path_febe,(GET(RPOP_PFL) & 0xff) |\n\t\t    ((GET(RPOP_PFM) & 0xff) << 8));\n\t\tADD_LIMITED(corr_hcs,GET(RACP_CHEC) & 0xff);\n\t\tADD_LIMITED(uncorr_hcs,GET(RACP_UHEC) & 0xff);\n\t\tADD_LIMITED(rx_cells,(GET(RACP_RCCL) & 0xff) |\n\t\t    ((GET(RACP_RCC) & 0xff) << 8) |\n\t\t    ((GET(RACP_RCCM) & 7) << 16));\n\t\tADD_LIMITED(tx_cells,(GET(TACP_TCCL) & 0xff) |\n\t\t    ((GET(TACP_TCC) & 0xff) << 8) |\n\t\t    ((GET(TACP_TCCM) & 7) << 16));\n\t}\n\tif (timer) mod_timer(&poll_timer,jiffies+HZ);\n}\n\n\n#undef ADD_LIMITED\n\n\nstatic int fetch_stats(struct atm_dev *dev,struct sonet_stats __user *arg,int zero)\n{\n\tstruct sonet_stats tmp;\n\tint error = 0;\n\n\tsonet_copy_stats(&PRIV(dev)->sonet_stats,&tmp);\n\tif (arg) error = copy_to_user(arg,&tmp,sizeof(tmp));\n\tif (zero && !error) sonet_subtract_stats(&PRIV(dev)->sonet_stats,&tmp);\n\treturn error ? -EFAULT : 0;\n}\n\n\n#define HANDLE_FLAG(flag,reg,bit) \\\n  if (todo & flag) { \\\n    if (set) PUT(GET(reg) | bit,reg); \\\n    else PUT(GET(reg) & ~bit,reg); \\\n    todo &= ~flag; \\\n  }\n\n\nstatic int change_diag(struct atm_dev *dev,void __user *arg,int set)\n{\n\tint todo;\n\n\tif (get_user(todo,(int __user *)arg)) return -EFAULT;\n\tHANDLE_FLAG(SONET_INS_SBIP,TSOP_DIAG,SUNI_TSOP_DIAG_DBIP8);\n\tHANDLE_FLAG(SONET_INS_LBIP,TLOP_DIAG,SUNI_TLOP_DIAG_DBIP);\n\tHANDLE_FLAG(SONET_INS_PBIP,TPOP_CD,SUNI_TPOP_DIAG_DB3);\n\tHANDLE_FLAG(SONET_INS_FRAME,RSOP_CIE,SUNI_RSOP_CIE_FOOF);\n\tHANDLE_FLAG(SONET_INS_LAIS,TSOP_CTRL,SUNI_TSOP_CTRL_LAIS);\n\tHANDLE_FLAG(SONET_INS_PAIS,TPOP_CD,SUNI_TPOP_DIAG_PAIS);\n\tHANDLE_FLAG(SONET_INS_LOS,TSOP_DIAG,SUNI_TSOP_DIAG_DLOS);\n\tHANDLE_FLAG(SONET_INS_HCS,TACP_CS,SUNI_TACP_CS_DHCS);\n\treturn put_user(todo,(int __user *)arg) ? -EFAULT : 0;\n}\n\n\n#undef HANDLE_FLAG\n\n\nstatic int get_diag(struct atm_dev *dev,void __user *arg)\n{\n\tint set;\n\n\tset = 0;\n\tif (GET(TSOP_DIAG) & SUNI_TSOP_DIAG_DBIP8) set |= SONET_INS_SBIP;\n\tif (GET(TLOP_DIAG) & SUNI_TLOP_DIAG_DBIP) set |= SONET_INS_LBIP;\n\tif (GET(TPOP_CD) & SUNI_TPOP_DIAG_DB3) set |= SONET_INS_PBIP;\n\t \n\tif (GET(TSOP_CTRL) & SUNI_TSOP_CTRL_LAIS) set |= SONET_INS_LAIS;\n\tif (GET(TPOP_CD) & SUNI_TPOP_DIAG_PAIS) set |= SONET_INS_PAIS;\n\tif (GET(TSOP_DIAG) & SUNI_TSOP_DIAG_DLOS) set |= SONET_INS_LOS;\n\tif (GET(TACP_CS) & SUNI_TACP_CS_DHCS) set |= SONET_INS_HCS;\n\treturn put_user(set,(int __user *)arg) ? -EFAULT : 0;\n}\n\n\nstatic int set_loopback(struct atm_dev *dev,int mode)\n{\n\tunsigned char control;\n\tint reg, dle, lle;\n\n\tif (PRIV(dev)->type == SUNI_MRI_TYPE_PM5355) {\n\t\treg = SUNI_MCM;\n\t\tdle = SUNI_MCM_DLE;\n\t\tlle = SUNI_MCM_LLE;\n\t} else {\n\t\treg = SUNI_MCT;\n\t\tdle = SUNI_MCT_DLE;\n\t\tlle = SUNI_MCT_LLE;\n\t}\n\n\tcontrol = dev->ops->phy_get(dev, reg) & ~(dle | lle);\n\tswitch (mode) {\n\t\tcase ATM_LM_NONE:\n\t\t\tbreak;\n\t\tcase ATM_LM_LOC_PHY:\n\t\t\tcontrol |= dle;\n\t\t\tbreak;\n\t\tcase ATM_LM_RMT_PHY:\n\t\t\tcontrol |= lle;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\treturn -EINVAL;\n\t}\n\tdev->ops->phy_put(dev, control, reg);\n\tPRIV(dev)->loop_mode = mode;\n\treturn 0;\n}\n\n \n\nstatic int set_sonet(struct atm_dev *dev)\n{\n\tif (PRIV(dev)->type == SUNI_MRI_TYPE_PM5355) {\n\t\tPUT(GET(RPOP_RC) & ~SUNI_RPOP_RC_ENSS, RPOP_RC);\n\t\tPUT(GET(SSTB_CTRL) & ~SUNI_SSTB_CTRL_LEN16, SSTB_CTRL);\n\t\tPUT(GET(SPTB_CTRL) & ~SUNI_SPTB_CTRL_LEN16, SPTB_CTRL);\n\t}\n\n\tREG_CHANGE(SUNI_TPOP_APM_S, SUNI_TPOP_APM_S_SHIFT,\n\t\t   SUNI_TPOP_S_SONET, TPOP_APM);\n\n\treturn 0;\n}\n\nstatic int set_sdh(struct atm_dev *dev)\n{\n\tif (PRIV(dev)->type == SUNI_MRI_TYPE_PM5355) {\n\t\tPUT(GET(RPOP_RC) | SUNI_RPOP_RC_ENSS, RPOP_RC);\n\t\tPUT(GET(SSTB_CTRL) | SUNI_SSTB_CTRL_LEN16, SSTB_CTRL);\n\t\tPUT(GET(SPTB_CTRL) | SUNI_SPTB_CTRL_LEN16, SPTB_CTRL);\n\t}\n\n\tREG_CHANGE(SUNI_TPOP_APM_S, SUNI_TPOP_APM_S_SHIFT,\n\t\t   SUNI_TPOP_S_SDH, TPOP_APM);\n\n\treturn 0;\n}\n\n\nstatic int get_framing(struct atm_dev *dev, void __user *arg)\n{\n\tint framing;\n\tunsigned char s;\n\n\n\ts = (GET(TPOP_APM) & SUNI_TPOP_APM_S) >> SUNI_TPOP_APM_S_SHIFT;\n\tif (s == SUNI_TPOP_S_SONET)\n\t\tframing = SONET_FRAME_SONET;\n\telse\n\t\tframing = SONET_FRAME_SDH;\n\n\treturn put_user(framing, (int __user *) arg) ? -EFAULT : 0;\n}\n\nstatic int set_framing(struct atm_dev *dev, void __user *arg)\n{\n\tint mode;\n\n\tif (get_user(mode, (int __user *) arg))\n\t\treturn -EFAULT;\n\n\tif (mode == SONET_FRAME_SONET)\n\t\treturn set_sonet(dev);\n\telse if (mode == SONET_FRAME_SDH)\n\t\treturn set_sdh(dev);\n\n\treturn -EINVAL;\n}\n\n\nstatic int suni_ioctl(struct atm_dev *dev,unsigned int cmd,void __user *arg)\n{\n\tswitch (cmd) {\n\t\tcase SONET_GETSTATZ:\n\t\tcase SONET_GETSTAT:\n\t\t\treturn fetch_stats(dev, arg, cmd == SONET_GETSTATZ);\n\t\tcase SONET_SETDIAG:\n\t\t\treturn change_diag(dev,arg,1);\n\t\tcase SONET_CLRDIAG:\n\t\t\treturn change_diag(dev,arg,0);\n\t\tcase SONET_GETDIAG:\n\t\t\treturn get_diag(dev,arg);\n\t\tcase SONET_SETFRAMING:\n\t\t\tif (!capable(CAP_NET_ADMIN))\n\t\t\t\treturn -EPERM;\n\t\t\treturn set_framing(dev, arg);\n\t\tcase SONET_GETFRAMING:\n\t\t\treturn get_framing(dev, arg);\n\t\tcase SONET_GETFRSENSE:\n\t\t\treturn -EINVAL;\n\t\tcase ATM_SETLOOP:\n\t\t\tif (!capable(CAP_NET_ADMIN))\n\t\t\t\treturn -EPERM;\n\t\t\treturn set_loopback(dev,(int)(unsigned long)arg);\n\t\tcase ATM_GETLOOP:\n\t\t\treturn put_user(PRIV(dev)->loop_mode,(int __user *)arg) ?\n\t\t\t    -EFAULT : 0;\n\t\tcase ATM_QUERYLOOP:\n\t\t\treturn put_user(ATM_LM_LOC_PHY | ATM_LM_RMT_PHY,\n\t\t\t    (int __user *) arg) ? -EFAULT : 0;\n\t\tdefault:\n\t\t\treturn -ENOIOCTLCMD;\n\t}\n}\n\n\nstatic void poll_los(struct atm_dev *dev)\n{\n\tatm_dev_signal_change(dev,\n\t\tGET(RSOP_SIS) & SUNI_RSOP_SIS_LOSV ?\n\t\tATM_PHY_SIG_LOST : ATM_PHY_SIG_FOUND);\n}\n\n\nstatic void suni_int(struct atm_dev *dev)\n{\n\tpoll_los(dev);\n\tprintk(KERN_NOTICE \"%s(itf %d): signal %s\\n\",dev->type,dev->number,\n\t    dev->signal == ATM_PHY_SIG_LOST ?  \"lost\" : \"detected again\");\n}\n\n\nstatic int suni_start(struct atm_dev *dev)\n{\n\tunsigned long flags;\n\tint first;\n\n\tspin_lock_irqsave(&sunis_lock,flags);\n\tfirst = !sunis;\n\tPRIV(dev)->next = sunis;\n\tsunis = PRIV(dev);\n\tspin_unlock_irqrestore(&sunis_lock,flags);\n\tmemset(&PRIV(dev)->sonet_stats,0,sizeof(struct k_sonet_stats));\n\tPUT(GET(RSOP_CIE) | SUNI_RSOP_CIE_LOSE,RSOP_CIE);\n\t\t \n\tpoll_los(dev);  \n\tif (dev->signal == ATM_PHY_SIG_LOST)\n\t\tprintk(KERN_WARNING \"%s(itf %d): no signal\\n\",dev->type,\n\t\t    dev->number);\n\tPRIV(dev)->loop_mode = ATM_LM_NONE;\n\tsuni_hz(NULL);  \n\t(void) fetch_stats(dev,NULL,1);  \n\tif (first) {\n\t\ttimer_setup(&poll_timer, suni_hz, 0);\n\t\tpoll_timer.expires = jiffies+HZ;\n#if 0\nprintk(KERN_DEBUG \"[u] p=0x%lx,n=0x%lx\\n\",(unsigned long) poll_timer.list.prev,\n    (unsigned long) poll_timer.list.next);\n#endif\n\t\tadd_timer(&poll_timer);\n\t}\n\treturn 0;\n}\n\n\nstatic int suni_stop(struct atm_dev *dev)\n{\n\tstruct suni_priv **walk;\n\tunsigned long flags;\n\n\t \n\tspin_lock_irqsave(&sunis_lock,flags);\n\tfor (walk = &sunis; *walk != PRIV(dev);\n\t    walk = &PRIV((*walk)->dev)->next);\n\t*walk = PRIV((*walk)->dev)->next;\n\tif (!sunis) del_timer_sync(&poll_timer);\n\tspin_unlock_irqrestore(&sunis_lock,flags);\n\tkfree(PRIV(dev));\n\n\treturn 0;\n}\n\n\nstatic const struct atmphy_ops suni_ops = {\n\t.start\t\t= suni_start,\n\t.ioctl\t\t= suni_ioctl,\n\t.interrupt\t= suni_int,\n\t.stop\t\t= suni_stop,\n};\n\n\nint suni_init(struct atm_dev *dev)\n{\n\tunsigned char mri;\n\n\tif (!(dev->phy_data = kmalloc(sizeof(struct suni_priv),GFP_KERNEL)))\n\t\treturn -ENOMEM;\n\tPRIV(dev)->dev = dev;\n\n\tmri = GET(MRI);  \n\tPRIV(dev)->type = (mri & SUNI_MRI_TYPE) >> SUNI_MRI_TYPE_SHIFT;\n\tPUT(mri | SUNI_MRI_RESET,MRI);\n\tPUT(mri,MRI);\n\tPUT((GET(MT) & SUNI_MT_DS27_53),MT);  \n        set_sonet(dev);\n\tREG_CHANGE(SUNI_TACP_IUCHP_CLP,0,SUNI_TACP_IUCHP_CLP,\n\t    TACP_IUCHP);  \n\tPUT(SUNI_IDLE_PATTERN,TACP_IUCPOP);\n\tdev->phy = &suni_ops;\n\n\treturn 0;\n}\n\nEXPORT_SYMBOL(suni_init);\n\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}