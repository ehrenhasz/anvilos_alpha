{
  "module_name": "hte-tegra194-test.c",
  "hash_id": "37de1bd6141f8ec8da98ece22c5cae45daec94c6f507a49e04836e7ef06d3a20",
  "original_prompt": "Ingested from linux-6.6.14/drivers/hte/hte-tegra194-test.c",
  "human_readable_source": "\n \n\n#include <linux/err.h>\n#include <linux/gpio/consumer.h>\n#include <linux/hte.h>\n#include <linux/interrupt.h>\n#include <linux/mod_devicetable.h>\n#include <linux/module.h>\n#include <linux/platform_device.h>\n#include <linux/timer.h>\n#include <linux/workqueue.h>\n\n \n\nstatic struct tegra_hte_test {\n\tint gpio_in_irq;\n\tstruct device *pdev;\n\tstruct gpio_desc *gpio_in;\n\tstruct gpio_desc *gpio_out;\n\tstruct hte_ts_desc *desc;\n\tstruct timer_list timer;\n\tstruct kobject *kobj;\n} hte;\n\nstatic enum hte_return process_hw_ts(struct hte_ts_data *ts, void *p)\n{\n\tchar *edge;\n\tstruct hte_ts_desc *desc = p;\n\n\tif (!ts || !p)\n\t\treturn HTE_CB_HANDLED;\n\n\tif (ts->raw_level < 0)\n\t\tedge = \"Unknown\";\n\n\tpr_info(\"HW timestamp(%u: %llu): %llu, edge: %s\\n\",\n\t\tdesc->attr.line_id, ts->seq, ts->tsc,\n\t\t(ts->raw_level >= 0) ? ((ts->raw_level == 0) ?\n\t\t\t\t\t\"falling\" : \"rising\") : edge);\n\n\treturn HTE_CB_HANDLED;\n}\n\nstatic void gpio_timer_cb(struct timer_list *t)\n{\n\t(void)t;\n\n\tgpiod_set_value(hte.gpio_out, !gpiod_get_value(hte.gpio_out));\n\tmod_timer(&hte.timer, jiffies + msecs_to_jiffies(8000));\n}\n\nstatic irqreturn_t tegra_hte_test_gpio_isr(int irq, void *data)\n{\n\t(void)irq;\n\t(void)data;\n\n\treturn IRQ_HANDLED;\n}\n\nstatic const struct of_device_id tegra_hte_test_of_match[] = {\n\t{ .compatible = \"nvidia,tegra194-hte-test\"},\n\t{ }\n};\nMODULE_DEVICE_TABLE(of, tegra_hte_test_of_match);\n\nstatic int tegra_hte_test_probe(struct platform_device *pdev)\n{\n\tint ret = 0;\n\tint i, cnt;\n\n\tdev_set_drvdata(&pdev->dev, &hte);\n\thte.pdev = &pdev->dev;\n\n\thte.gpio_out = gpiod_get(&pdev->dev, \"out\", 0);\n\tif (IS_ERR(hte.gpio_out)) {\n\t\tdev_err(&pdev->dev, \"failed to get gpio out\\n\");\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\n\thte.gpio_in = gpiod_get(&pdev->dev, \"in\", 0);\n\tif (IS_ERR(hte.gpio_in)) {\n\t\tdev_err(&pdev->dev, \"failed to get gpio in\\n\");\n\t\tret = -EINVAL;\n\t\tgoto free_gpio_out;\n\t}\n\n\tret = gpiod_direction_output(hte.gpio_out, 0);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to set output\\n\");\n\t\tret = -EINVAL;\n\t\tgoto free_gpio_in;\n\t}\n\n\tret = gpiod_direction_input(hte.gpio_in);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to set input\\n\");\n\t\tret = -EINVAL;\n\t\tgoto free_gpio_in;\n\t}\n\n\tret = gpiod_to_irq(hte.gpio_in);\n\tif (ret < 0) {\n\t\tdev_err(&pdev->dev, \"failed to map GPIO to IRQ: %d\\n\", ret);\n\t\tret = -ENXIO;\n\t\tgoto free_gpio_in;\n\t}\n\n\thte.gpio_in_irq = ret;\n\tret = request_irq(ret, tegra_hte_test_gpio_isr,\n\t\t\t  IRQF_TRIGGER_RISING,\n\t\t\t  \"tegra_hte_gpio_test_isr\", &hte);\n\tif (ret) {\n\t\tdev_err(&pdev->dev, \"failed to acquire IRQ\\n\");\n\t\tret = -ENXIO;\n\t\tgoto free_irq;\n\t}\n\n\tcnt = of_hte_req_count(hte.pdev);\n\tif (cnt < 0) {\n\t\tret = cnt;\n\t\tgoto free_irq;\n\t}\n\n\tdev_info(&pdev->dev, \"Total requested lines:%d\\n\", cnt);\n\n\thte.desc = devm_kzalloc(hte.pdev, sizeof(*hte.desc) * cnt, GFP_KERNEL);\n\tif (!hte.desc) {\n\t\tret = -ENOMEM;\n\t\tgoto free_irq;\n\t}\n\n\tfor (i = 0; i < cnt; i++) {\n\t\tif (i == 0)\n\t\t\t \n\t\t\thte_init_line_attr(&hte.desc[i], 0, 0, NULL,\n\t\t\t\t\t   hte.gpio_in);\n\t\telse\n\t\t\t \n\t\t\thte_init_line_attr(&hte.desc[i], 0, 0, NULL, NULL);\n\n\t\tret = hte_ts_get(hte.pdev, &hte.desc[i], i);\n\t\tif (ret)\n\t\t\tgoto ts_put;\n\n\t\tret = devm_hte_request_ts_ns(hte.pdev, &hte.desc[i],\n\t\t\t\t\t     process_hw_ts, NULL,\n\t\t\t\t\t     &hte.desc[i]);\n\t\tif (ret)  \n\t\t\tgoto free_irq;\n\t}\n\n\ttimer_setup(&hte.timer, gpio_timer_cb, 0);\n\tmod_timer(&hte.timer, jiffies + msecs_to_jiffies(5000));\n\n\treturn 0;\n\nts_put:\n\tcnt = i;\n\tfor (i = 0; i < cnt; i++)\n\t\thte_ts_put(&hte.desc[i]);\nfree_irq:\n\tfree_irq(hte.gpio_in_irq, &hte);\nfree_gpio_in:\n\tgpiod_put(hte.gpio_in);\nfree_gpio_out:\n\tgpiod_put(hte.gpio_out);\nout:\n\n\treturn ret;\n}\n\nstatic int tegra_hte_test_remove(struct platform_device *pdev)\n{\n\t(void)pdev;\n\n\tfree_irq(hte.gpio_in_irq, &hte);\n\tgpiod_put(hte.gpio_in);\n\tgpiod_put(hte.gpio_out);\n\tdel_timer_sync(&hte.timer);\n\n\treturn 0;\n}\n\nstatic struct platform_driver tegra_hte_test_driver = {\n\t.probe = tegra_hte_test_probe,\n\t.remove = tegra_hte_test_remove,\n\t.driver = {\n\t\t.name = \"tegra_hte_test\",\n\t\t.of_match_table = tegra_hte_test_of_match,\n\t},\n};\nmodule_platform_driver(tegra_hte_test_driver);\n\nMODULE_AUTHOR(\"Dipen Patel <dipenp@nvidia.com>\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}