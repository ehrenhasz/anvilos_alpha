{
  "module_name": "proc.c",
  "hash_id": "802125efcbf65f2121fda4889060cedd6581d7321822e19088ab43c84d4cde39",
  "original_prompt": "Ingested from linux-6.6.14/drivers/pnp/pnpbios/proc.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/slab.h>\n#include <linux/types.h>\n#include <linux/proc_fs.h>\n#include <linux/pnp.h>\n#include <linux/seq_file.h>\n#include <linux/init.h>\n\n#include <linux/uaccess.h>\n\n#include \"pnpbios.h\"\n\nstatic struct proc_dir_entry *proc_pnp = NULL;\nstatic struct proc_dir_entry *proc_pnp_boot = NULL;\n\nstatic int pnpconfig_proc_show(struct seq_file *m, void *v)\n{\n\tstruct pnp_isa_config_struc pnps;\n\n\tif (pnp_bios_isapnp_config(&pnps))\n\t\treturn -EIO;\n\tseq_printf(m, \"structure_revision %d\\n\"\n\t\t      \"number_of_CSNs %d\\n\"\n\t\t      \"ISA_read_data_port 0x%x\\n\",\n\t\t   pnps.revision, pnps.no_csns, pnps.isa_rd_data_port);\n\treturn 0;\n}\n\nstatic int escd_info_proc_show(struct seq_file *m, void *v)\n{\n\tstruct escd_info_struc escd;\n\n\tif (pnp_bios_escd_info(&escd))\n\t\treturn -EIO;\n\tseq_printf(m, \"min_ESCD_write_size %d\\n\"\n\t\t\t\"ESCD_size %d\\n\"\n\t\t\t\"NVRAM_base 0x%x\\n\",\n\t\t\tescd.min_escd_write_size,\n\t\t\tescd.escd_size, escd.nv_storage_base);\n\treturn 0;\n}\n\n#define MAX_SANE_ESCD_SIZE (32*1024)\nstatic int escd_proc_show(struct seq_file *m, void *v)\n{\n\tstruct escd_info_struc escd;\n\tchar *tmpbuf;\n\tint escd_size;\n\n\tif (pnp_bios_escd_info(&escd))\n\t\treturn -EIO;\n\n\t \n\tif (escd.escd_size > MAX_SANE_ESCD_SIZE) {\n\t\tprintk(KERN_ERR\n\t\t       \"PnPBIOS: %s: ESCD size reported by BIOS escd_info call is too great\\n\", __func__);\n\t\treturn -EFBIG;\n\t}\n\n\ttmpbuf = kzalloc(escd.escd_size, GFP_KERNEL);\n\tif (!tmpbuf)\n\t\treturn -ENOMEM;\n\n\tif (pnp_bios_read_escd(tmpbuf, escd.nv_storage_base)) {\n\t\tkfree(tmpbuf);\n\t\treturn -EIO;\n\t}\n\n\tescd_size =\n\t    (unsigned char)(tmpbuf[0]) + (unsigned char)(tmpbuf[1]) * 256;\n\n\t \n\tif (escd_size > MAX_SANE_ESCD_SIZE) {\n\t\tprintk(KERN_ERR \"PnPBIOS: %s: ESCD size reported by\"\n\t\t\t\t\" BIOS read_escd call is too great\\n\", __func__);\n\t\tkfree(tmpbuf);\n\t\treturn -EFBIG;\n\t}\n\n\tseq_write(m, tmpbuf, escd_size);\n\tkfree(tmpbuf);\n\treturn 0;\n}\n\nstatic int pnp_legacyres_proc_show(struct seq_file *m, void *v)\n{\n\tvoid *buf;\n\n\tbuf = kmalloc(65536, GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\tif (pnp_bios_get_stat_res(buf)) {\n\t\tkfree(buf);\n\t\treturn -EIO;\n\t}\n\n\tseq_write(m, buf, 65536);\n\tkfree(buf);\n\treturn 0;\n}\n\nstatic int pnp_devices_proc_show(struct seq_file *m, void *v)\n{\n\tstruct pnp_bios_node *node;\n\tu8 nodenum;\n\n\tnode = kzalloc(node_info.max_node_size, GFP_KERNEL);\n\tif (!node)\n\t\treturn -ENOMEM;\n\n\tfor (nodenum = 0; nodenum < 0xff;) {\n\t\tu8 thisnodenum = nodenum;\n\n\t\tif (pnp_bios_get_dev_node(&nodenum, PNPMODE_DYNAMIC, node))\n\t\t\tbreak;\n\t\tseq_printf(m, \"%02x\\t%08x\\t%3phC\\t%04x\\n\",\n\t\t\t     node->handle, node->eisa_id,\n\t\t\t     node->type_code, node->flags);\n\t\tif (nodenum <= thisnodenum) {\n\t\t\tprintk(KERN_ERR\n\t\t\t       \"%s Node number 0x%x is out of sequence following node 0x%x. Aborting.\\n\",\n\t\t\t       \"PnPBIOS: proc_read_devices:\",\n\t\t\t       (unsigned int)nodenum,\n\t\t\t       (unsigned int)thisnodenum);\n\t\t\tbreak;\n\t\t}\n\t}\n\tkfree(node);\n\treturn 0;\n}\n\nstatic int pnpbios_proc_show(struct seq_file *m, void *v)\n{\n\tvoid *data = m->private;\n\tstruct pnp_bios_node *node;\n\tint boot = (long)data >> 8;\n\tu8 nodenum = (long)data;\n\tint len;\n\n\tnode = kzalloc(node_info.max_node_size, GFP_KERNEL);\n\tif (!node)\n\t\treturn -ENOMEM;\n\tif (pnp_bios_get_dev_node(&nodenum, boot, node)) {\n\t\tkfree(node);\n\t\treturn -EIO;\n\t}\n\tlen = node->size - sizeof(struct pnp_bios_node);\n\tseq_write(m, node->data, len);\n\tkfree(node);\n\treturn 0;\n}\n\nstatic int pnpbios_proc_open(struct inode *inode, struct file *file)\n{\n\treturn single_open(file, pnpbios_proc_show, pde_data(inode));\n}\n\nstatic ssize_t pnpbios_proc_write(struct file *file, const char __user *buf,\n\t\t\t\t  size_t count, loff_t *pos)\n{\n\tvoid *data = pde_data(file_inode(file));\n\tstruct pnp_bios_node *node;\n\tint boot = (long)data >> 8;\n\tu8 nodenum = (long)data;\n\tint ret = count;\n\n\tnode = kzalloc(node_info.max_node_size, GFP_KERNEL);\n\tif (!node)\n\t\treturn -ENOMEM;\n\tif (pnp_bios_get_dev_node(&nodenum, boot, node)) {\n\t\tret = -EIO;\n\t\tgoto out;\n\t}\n\tif (count != node->size - sizeof(struct pnp_bios_node)) {\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\tif (copy_from_user(node->data, buf, count)) {\n\t\tret = -EFAULT;\n\t\tgoto out;\n\t}\n\tif (pnp_bios_set_dev_node(node->handle, boot, node) != 0) {\n\t\tret = -EINVAL;\n\t\tgoto out;\n\t}\n\tret = count;\nout:\n\tkfree(node);\n\treturn ret;\n}\n\nstatic const struct proc_ops pnpbios_proc_ops = {\n\t.proc_open\t= pnpbios_proc_open,\n\t.proc_read\t= seq_read,\n\t.proc_lseek\t= seq_lseek,\n\t.proc_release\t= single_release,\n\t.proc_write\t= pnpbios_proc_write,\n};\n\nint pnpbios_interface_attach_device(struct pnp_bios_node *node)\n{\n\tchar name[3];\n\n\tsprintf(name, \"%02x\", node->handle);\n\n\tif (!proc_pnp)\n\t\treturn -EIO;\n\tif (!pnpbios_dont_use_current_config) {\n\t\tproc_create_data(name, 0644, proc_pnp, &pnpbios_proc_ops,\n\t\t\t\t (void *)(long)(node->handle));\n\t}\n\n\tif (!proc_pnp_boot)\n\t\treturn -EIO;\n\tif (proc_create_data(name, 0644, proc_pnp_boot, &pnpbios_proc_ops,\n\t\t\t     (void *)(long)(node->handle + 0x100)))\n\t\treturn 0;\n\treturn -EIO;\n}\n\n \nint __init pnpbios_proc_init(void)\n{\n\tproc_pnp = proc_mkdir(\"bus/pnp\", NULL);\n\tif (!proc_pnp)\n\t\treturn -EIO;\n\tproc_pnp_boot = proc_mkdir(\"boot\", proc_pnp);\n\tif (!proc_pnp_boot)\n\t\treturn -EIO;\n\tproc_create_single(\"devices\", 0, proc_pnp, pnp_devices_proc_show);\n\tproc_create_single(\"configuration_info\", 0, proc_pnp,\n\t\t\tpnpconfig_proc_show);\n\tproc_create_single(\"escd_info\", 0, proc_pnp, escd_info_proc_show);\n\tproc_create_single(\"escd\", S_IRUSR, proc_pnp, escd_proc_show);\n\tproc_create_single(\"legacy_device_resources\", 0, proc_pnp,\n\t\t\tpnp_legacyres_proc_show);\n\treturn 0;\n}\n\nvoid __exit pnpbios_proc_exit(void)\n{\n\tint i;\n\tchar name[3];\n\n\tif (!proc_pnp)\n\t\treturn;\n\n\tfor (i = 0; i < 0xff; i++) {\n\t\tsprintf(name, \"%02x\", i);\n\t\tif (!pnpbios_dont_use_current_config)\n\t\t\tremove_proc_entry(name, proc_pnp);\n\t\tremove_proc_entry(name, proc_pnp_boot);\n\t}\n\tremove_proc_entry(\"legacy_device_resources\", proc_pnp);\n\tremove_proc_entry(\"escd\", proc_pnp);\n\tremove_proc_entry(\"escd_info\", proc_pnp);\n\tremove_proc_entry(\"configuration_info\", proc_pnp);\n\tremove_proc_entry(\"devices\", proc_pnp);\n\tremove_proc_entry(\"boot\", proc_pnp);\n\tremove_proc_entry(\"bus/pnp\", NULL);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}