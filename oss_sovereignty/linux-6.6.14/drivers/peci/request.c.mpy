{
  "module_name": "request.c",
  "hash_id": "ccb365465100df8bd84e582c17a82b87162174e4750988f6454e71b6f399faeb",
  "original_prompt": "Ingested from linux-6.6.14/drivers/peci/request.c",
  "human_readable_source": "\n\n\n#include <linux/bug.h>\n#include <linux/export.h>\n#include <linux/pci.h>\n#include <linux/peci.h>\n#include <linux/slab.h>\n#include <linux/types.h>\n\n#include <asm/unaligned.h>\n\n#include \"internal.h\"\n\n#define PECI_GET_DIB_CMD\t\t0xf7\n#define  PECI_GET_DIB_WR_LEN\t\t1\n#define  PECI_GET_DIB_RD_LEN\t\t8\n\n#define PECI_GET_TEMP_CMD\t\t0x01\n#define  PECI_GET_TEMP_WR_LEN\t\t1\n#define  PECI_GET_TEMP_RD_LEN\t\t2\n\n#define PECI_RDPKGCFG_CMD\t\t0xa1\n#define  PECI_RDPKGCFG_WR_LEN\t\t5\n#define  PECI_RDPKGCFG_RD_LEN_BASE\t1\n#define PECI_WRPKGCFG_CMD\t\t0xa5\n#define  PECI_WRPKGCFG_WR_LEN_BASE\t6\n#define  PECI_WRPKGCFG_RD_LEN\t\t1\n\n#define PECI_RDIAMSR_CMD\t\t0xb1\n#define  PECI_RDIAMSR_WR_LEN\t\t5\n#define  PECI_RDIAMSR_RD_LEN\t\t9\n#define PECI_WRIAMSR_CMD\t\t0xb5\n#define PECI_RDIAMSREX_CMD\t\t0xd1\n#define  PECI_RDIAMSREX_WR_LEN\t\t6\n#define  PECI_RDIAMSREX_RD_LEN\t\t9\n\n#define PECI_RDPCICFG_CMD\t\t0x61\n#define  PECI_RDPCICFG_WR_LEN\t\t6\n#define  PECI_RDPCICFG_RD_LEN\t\t5\n#define  PECI_RDPCICFG_RD_LEN_MAX\t24\n#define PECI_WRPCICFG_CMD\t\t0x65\n\n#define PECI_RDPCICFGLOCAL_CMD\t\t\t0xe1\n#define  PECI_RDPCICFGLOCAL_WR_LEN\t\t5\n#define  PECI_RDPCICFGLOCAL_RD_LEN_BASE\t\t1\n#define PECI_WRPCICFGLOCAL_CMD\t\t\t0xe5\n#define  PECI_WRPCICFGLOCAL_WR_LEN_BASE\t\t6\n#define  PECI_WRPCICFGLOCAL_RD_LEN\t\t1\n\n#define PECI_ENDPTCFG_TYPE_LOCAL_PCI\t\t0x03\n#define PECI_ENDPTCFG_TYPE_PCI\t\t\t0x04\n#define PECI_ENDPTCFG_TYPE_MMIO\t\t\t0x05\n#define PECI_ENDPTCFG_ADDR_TYPE_PCI\t\t0x04\n#define PECI_ENDPTCFG_ADDR_TYPE_MMIO_D\t\t0x05\n#define PECI_ENDPTCFG_ADDR_TYPE_MMIO_Q\t\t0x06\n#define PECI_RDENDPTCFG_CMD\t\t\t0xc1\n#define  PECI_RDENDPTCFG_PCI_WR_LEN\t\t12\n#define  PECI_RDENDPTCFG_MMIO_WR_LEN_BASE\t10\n#define  PECI_RDENDPTCFG_MMIO_D_WR_LEN\t\t14\n#define  PECI_RDENDPTCFG_MMIO_Q_WR_LEN\t\t18\n#define  PECI_RDENDPTCFG_RD_LEN_BASE\t\t1\n#define PECI_WRENDPTCFG_CMD\t\t\t0xc5\n#define  PECI_WRENDPTCFG_PCI_WR_LEN_BASE\t13\n#define  PECI_WRENDPTCFG_MMIO_D_WR_LEN_BASE\t15\n#define  PECI_WRENDPTCFG_MMIO_Q_WR_LEN_BASE\t19\n#define  PECI_WRENDPTCFG_RD_LEN\t\t\t1\n\n \n#define PECI_CC_SUCCESS\t\t\t\t0x40\n#define PECI_CC_NEED_RETRY\t\t\t0x80\n#define PECI_CC_OUT_OF_RESOURCE\t\t\t0x81\n#define PECI_CC_UNAVAIL_RESOURCE\t\t0x82\n#define PECI_CC_INVALID_REQ\t\t\t0x90\n#define PECI_CC_MCA_ERROR\t\t\t0x91\n#define PECI_CC_CATASTROPHIC_MCA_ERROR\t\t0x93\n#define PECI_CC_FATAL_MCA_ERROR\t\t\t0x94\n#define PECI_CC_PARITY_ERR_GPSB_OR_PMSB\t\t0x98\n#define PECI_CC_PARITY_ERR_GPSB_OR_PMSB_IERR\t0x9B\n#define PECI_CC_PARITY_ERR_GPSB_OR_PMSB_MCA\t0x9C\n\n#define PECI_RETRY_BIT\t\t\tBIT(0)\n\n#define PECI_RETRY_TIMEOUT\t\tmsecs_to_jiffies(700)\n#define PECI_RETRY_INTERVAL_MIN\t\tmsecs_to_jiffies(1)\n#define PECI_RETRY_INTERVAL_MAX\t\tmsecs_to_jiffies(128)\n\nstatic u8 peci_request_data_cc(struct peci_request *req)\n{\n\treturn req->rx.buf[0];\n}\n\n \nint peci_request_status(struct peci_request *req)\n{\n\tu8 cc = peci_request_data_cc(req);\n\n\tif (cc != PECI_CC_SUCCESS)\n\t\tdev_dbg(&req->device->dev, \"ret: %#02x\\n\", cc);\n\n\tswitch (cc) {\n\tcase PECI_CC_SUCCESS:\n\t\treturn 0;\n\tcase PECI_CC_NEED_RETRY:\n\tcase PECI_CC_OUT_OF_RESOURCE:\n\tcase PECI_CC_UNAVAIL_RESOURCE:\n\t\treturn -EAGAIN;\n\tcase PECI_CC_INVALID_REQ:\n\t\treturn -EINVAL;\n\tcase PECI_CC_MCA_ERROR:\n\tcase PECI_CC_CATASTROPHIC_MCA_ERROR:\n\tcase PECI_CC_FATAL_MCA_ERROR:\n\tcase PECI_CC_PARITY_ERR_GPSB_OR_PMSB:\n\tcase PECI_CC_PARITY_ERR_GPSB_OR_PMSB_IERR:\n\tcase PECI_CC_PARITY_ERR_GPSB_OR_PMSB_MCA:\n\t\treturn -EIO;\n\t}\n\n\tWARN_ONCE(1, \"Unknown PECI completion code: %#02x\\n\", cc);\n\n\treturn -EIO;\n}\nEXPORT_SYMBOL_NS_GPL(peci_request_status, PECI);\n\nstatic int peci_request_xfer(struct peci_request *req)\n{\n\tstruct peci_device *device = req->device;\n\tstruct peci_controller *controller = to_peci_controller(device->dev.parent);\n\tint ret;\n\n\tmutex_lock(&controller->bus_lock);\n\tret = controller->ops->xfer(controller, device->addr, req);\n\tmutex_unlock(&controller->bus_lock);\n\n\treturn ret;\n}\n\nstatic int peci_request_xfer_retry(struct peci_request *req)\n{\n\tlong wait_interval = PECI_RETRY_INTERVAL_MIN;\n\tstruct peci_device *device = req->device;\n\tstruct peci_controller *controller = to_peci_controller(device->dev.parent);\n\tunsigned long start = jiffies;\n\tint ret;\n\n\t \n\tif (WARN_ON(req->tx.len == 0))\n\t\treturn 0;\n\n\tdo {\n\t\tret = peci_request_xfer(req);\n\t\tif (ret) {\n\t\t\tdev_dbg(&controller->dev, \"xfer error: %d\\n\", ret);\n\t\t\treturn ret;\n\t\t}\n\n\t\tif (peci_request_status(req) != -EAGAIN)\n\t\t\treturn 0;\n\n\t\t \n\t\treq->tx.buf[1] |= PECI_RETRY_BIT;\n\n\t\tif (schedule_timeout_interruptible(wait_interval))\n\t\t\treturn -ERESTARTSYS;\n\n\t\twait_interval = min_t(long, wait_interval * 2, PECI_RETRY_INTERVAL_MAX);\n\t} while (time_before(jiffies, start + PECI_RETRY_TIMEOUT));\n\n\tdev_dbg(&controller->dev, \"request timed out\\n\");\n\n\treturn -ETIMEDOUT;\n}\n\n \nstruct peci_request *peci_request_alloc(struct peci_device *device, u8 tx_len, u8 rx_len)\n{\n\tstruct peci_request *req;\n\n\t \n\tif (WARN_ON_ONCE(tx_len > PECI_REQUEST_MAX_BUF_SIZE || rx_len > PECI_REQUEST_MAX_BUF_SIZE))\n\t\treturn NULL;\n\t \n\treq = kzalloc(sizeof(*req), GFP_KERNEL);\n\tif (!req)\n\t\treturn NULL;\n\n\treq->device = device;\n\treq->tx.len = tx_len;\n\treq->rx.len = rx_len;\n\n\treturn req;\n}\nEXPORT_SYMBOL_NS_GPL(peci_request_alloc, PECI);\n\n \nvoid peci_request_free(struct peci_request *req)\n{\n\tkfree(req);\n}\nEXPORT_SYMBOL_NS_GPL(peci_request_free, PECI);\n\nstruct peci_request *peci_xfer_get_dib(struct peci_device *device)\n{\n\tstruct peci_request *req;\n\tint ret;\n\n\treq = peci_request_alloc(device, PECI_GET_DIB_WR_LEN, PECI_GET_DIB_RD_LEN);\n\tif (!req)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\treq->tx.buf[0] = PECI_GET_DIB_CMD;\n\n\tret = peci_request_xfer(req);\n\tif (ret) {\n\t\tpeci_request_free(req);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\treturn req;\n}\nEXPORT_SYMBOL_NS_GPL(peci_xfer_get_dib, PECI);\n\nstruct peci_request *peci_xfer_get_temp(struct peci_device *device)\n{\n\tstruct peci_request *req;\n\tint ret;\n\n\treq = peci_request_alloc(device, PECI_GET_TEMP_WR_LEN, PECI_GET_TEMP_RD_LEN);\n\tif (!req)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\treq->tx.buf[0] = PECI_GET_TEMP_CMD;\n\n\tret = peci_request_xfer(req);\n\tif (ret) {\n\t\tpeci_request_free(req);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\treturn req;\n}\nEXPORT_SYMBOL_NS_GPL(peci_xfer_get_temp, PECI);\n\nstatic struct peci_request *\n__pkg_cfg_read(struct peci_device *device, u8 index, u16 param, u8 len)\n{\n\tstruct peci_request *req;\n\tint ret;\n\n\treq = peci_request_alloc(device, PECI_RDPKGCFG_WR_LEN, PECI_RDPKGCFG_RD_LEN_BASE + len);\n\tif (!req)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\treq->tx.buf[0] = PECI_RDPKGCFG_CMD;\n\treq->tx.buf[1] = 0;\n\treq->tx.buf[2] = index;\n\tput_unaligned_le16(param, &req->tx.buf[3]);\n\n\tret = peci_request_xfer_retry(req);\n\tif (ret) {\n\t\tpeci_request_free(req);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\treturn req;\n}\n\nstatic u32 __get_pci_addr(u8 bus, u8 dev, u8 func, u16 reg)\n{\n\treturn reg | PCI_DEVID(bus, PCI_DEVFN(dev, func)) << 12;\n}\n\nstatic struct peci_request *\n__pci_cfg_local_read(struct peci_device *device, u8 bus, u8 dev, u8 func, u16 reg, u8 len)\n{\n\tstruct peci_request *req;\n\tu32 pci_addr;\n\tint ret;\n\n\treq = peci_request_alloc(device, PECI_RDPCICFGLOCAL_WR_LEN,\n\t\t\t\t PECI_RDPCICFGLOCAL_RD_LEN_BASE + len);\n\tif (!req)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tpci_addr = __get_pci_addr(bus, dev, func, reg);\n\n\treq->tx.buf[0] = PECI_RDPCICFGLOCAL_CMD;\n\treq->tx.buf[1] = 0;\n\tput_unaligned_le24(pci_addr, &req->tx.buf[2]);\n\n\tret = peci_request_xfer_retry(req);\n\tif (ret) {\n\t\tpeci_request_free(req);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\treturn req;\n}\n\nstatic struct peci_request *\n__ep_pci_cfg_read(struct peci_device *device, u8 msg_type, u8 seg,\n\t\t  u8 bus, u8 dev, u8 func, u16 reg, u8 len)\n{\n\tstruct peci_request *req;\n\tu32 pci_addr;\n\tint ret;\n\n\treq = peci_request_alloc(device, PECI_RDENDPTCFG_PCI_WR_LEN,\n\t\t\t\t PECI_RDENDPTCFG_RD_LEN_BASE + len);\n\tif (!req)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\tpci_addr = __get_pci_addr(bus, dev, func, reg);\n\n\treq->tx.buf[0] = PECI_RDENDPTCFG_CMD;\n\treq->tx.buf[1] = 0;\n\treq->tx.buf[2] = msg_type;\n\treq->tx.buf[3] = 0;\n\treq->tx.buf[4] = 0;\n\treq->tx.buf[5] = 0;\n\treq->tx.buf[6] = PECI_ENDPTCFG_ADDR_TYPE_PCI;\n\treq->tx.buf[7] = seg;  \n\tput_unaligned_le32(pci_addr, &req->tx.buf[8]);\n\n\tret = peci_request_xfer_retry(req);\n\tif (ret) {\n\t\tpeci_request_free(req);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\treturn req;\n}\n\nstatic struct peci_request *\n__ep_mmio_read(struct peci_device *device, u8 bar, u8 addr_type, u8 seg,\n\t       u8 bus, u8 dev, u8 func, u64 offset, u8 tx_len, u8 len)\n{\n\tstruct peci_request *req;\n\tint ret;\n\n\treq = peci_request_alloc(device, tx_len, PECI_RDENDPTCFG_RD_LEN_BASE + len);\n\tif (!req)\n\t\treturn ERR_PTR(-ENOMEM);\n\n\treq->tx.buf[0] = PECI_RDENDPTCFG_CMD;\n\treq->tx.buf[1] = 0;\n\treq->tx.buf[2] = PECI_ENDPTCFG_TYPE_MMIO;\n\treq->tx.buf[3] = 0;  \n\treq->tx.buf[4] = 0;  \n\treq->tx.buf[5] = bar;\n\treq->tx.buf[6] = addr_type;\n\treq->tx.buf[7] = seg;  \n\treq->tx.buf[8] = PCI_DEVFN(dev, func);\n\treq->tx.buf[9] = bus;  \n\n\tif (addr_type == PECI_ENDPTCFG_ADDR_TYPE_MMIO_D)\n\t\tput_unaligned_le32(offset, &req->tx.buf[10]);\n\telse\n\t\tput_unaligned_le64(offset, &req->tx.buf[10]);\n\n\tret = peci_request_xfer_retry(req);\n\tif (ret) {\n\t\tpeci_request_free(req);\n\t\treturn ERR_PTR(ret);\n\t}\n\n\treturn req;\n}\n\nu8 peci_request_data_readb(struct peci_request *req)\n{\n\treturn req->rx.buf[1];\n}\nEXPORT_SYMBOL_NS_GPL(peci_request_data_readb, PECI);\n\nu16 peci_request_data_readw(struct peci_request *req)\n{\n\treturn get_unaligned_le16(&req->rx.buf[1]);\n}\nEXPORT_SYMBOL_NS_GPL(peci_request_data_readw, PECI);\n\nu32 peci_request_data_readl(struct peci_request *req)\n{\n\treturn get_unaligned_le32(&req->rx.buf[1]);\n}\nEXPORT_SYMBOL_NS_GPL(peci_request_data_readl, PECI);\n\nu64 peci_request_data_readq(struct peci_request *req)\n{\n\treturn get_unaligned_le64(&req->rx.buf[1]);\n}\nEXPORT_SYMBOL_NS_GPL(peci_request_data_readq, PECI);\n\nu64 peci_request_dib_read(struct peci_request *req)\n{\n\treturn get_unaligned_le64(&req->rx.buf[0]);\n}\nEXPORT_SYMBOL_NS_GPL(peci_request_dib_read, PECI);\n\ns16 peci_request_temp_read(struct peci_request *req)\n{\n\treturn get_unaligned_le16(&req->rx.buf[0]);\n}\nEXPORT_SYMBOL_NS_GPL(peci_request_temp_read, PECI);\n\n#define __read_pkg_config(x, type) \\\nstruct peci_request *peci_xfer_pkg_cfg_##x(struct peci_device *device, u8 index, u16 param) \\\n{ \\\n\treturn __pkg_cfg_read(device, index, param, sizeof(type)); \\\n} \\\nEXPORT_SYMBOL_NS_GPL(peci_xfer_pkg_cfg_##x, PECI)\n\n__read_pkg_config(readb, u8);\n__read_pkg_config(readw, u16);\n__read_pkg_config(readl, u32);\n__read_pkg_config(readq, u64);\n\n#define __read_pci_config_local(x, type) \\\nstruct peci_request * \\\npeci_xfer_pci_cfg_local_##x(struct peci_device *device, u8 bus, u8 dev, u8 func, u16 reg) \\\n{ \\\n\treturn __pci_cfg_local_read(device, bus, dev, func, reg, sizeof(type)); \\\n} \\\nEXPORT_SYMBOL_NS_GPL(peci_xfer_pci_cfg_local_##x, PECI)\n\n__read_pci_config_local(readb, u8);\n__read_pci_config_local(readw, u16);\n__read_pci_config_local(readl, u32);\n\n#define __read_ep_pci_config(x, msg_type, type) \\\nstruct peci_request * \\\npeci_xfer_ep_pci_cfg_##x(struct peci_device *device, u8 seg, u8 bus, u8 dev, u8 func, u16 reg) \\\n{ \\\n\treturn __ep_pci_cfg_read(device, msg_type, seg, bus, dev, func, reg, sizeof(type)); \\\n} \\\nEXPORT_SYMBOL_NS_GPL(peci_xfer_ep_pci_cfg_##x, PECI)\n\n__read_ep_pci_config(local_readb, PECI_ENDPTCFG_TYPE_LOCAL_PCI, u8);\n__read_ep_pci_config(local_readw, PECI_ENDPTCFG_TYPE_LOCAL_PCI, u16);\n__read_ep_pci_config(local_readl, PECI_ENDPTCFG_TYPE_LOCAL_PCI, u32);\n__read_ep_pci_config(readb, PECI_ENDPTCFG_TYPE_PCI, u8);\n__read_ep_pci_config(readw, PECI_ENDPTCFG_TYPE_PCI, u16);\n__read_ep_pci_config(readl, PECI_ENDPTCFG_TYPE_PCI, u32);\n\n#define __read_ep_mmio(x, y, addr_type, type1, type2) \\\nstruct peci_request *peci_xfer_ep_mmio##y##_##x(struct peci_device *device, u8 bar, u8 seg, \\\n\t\t\t\t\t   u8 bus, u8 dev, u8 func, u64 offset) \\\n{ \\\n\treturn __ep_mmio_read(device, bar, addr_type, seg, bus, dev, func, \\\n\t\t\t      offset, PECI_RDENDPTCFG_MMIO_WR_LEN_BASE + sizeof(type1), \\\n\t\t\t      sizeof(type2)); \\\n} \\\nEXPORT_SYMBOL_NS_GPL(peci_xfer_ep_mmio##y##_##x, PECI)\n\n__read_ep_mmio(readl, 32, PECI_ENDPTCFG_ADDR_TYPE_MMIO_D, u32, u32);\n__read_ep_mmio(readl, 64, PECI_ENDPTCFG_ADDR_TYPE_MMIO_Q, u64, u32);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}