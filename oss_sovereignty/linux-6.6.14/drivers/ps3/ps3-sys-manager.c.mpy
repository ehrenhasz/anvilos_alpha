{
  "module_name": "ps3-sys-manager.c",
  "hash_id": "545d3e8a103a35ba308cc5b569c0eecc2dcb5d19d294facde2e024d50d9a9a5a",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ps3/ps3-sys-manager.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/workqueue.h>\n#include <linux/reboot.h>\n#include <linux/sched/signal.h>\n\n#include <asm/firmware.h>\n#include <asm/lv1call.h>\n#include <asm/ps3.h>\n\n#include \"vuart.h\"\n\n \n\n \n\nstruct ps3_sys_manager_header {\n\t \n\tu8 version;\n\tu8 size;\n\tu16 reserved_1;\n\tu32 payload_size;\n\tu16 service_id;\n\tu16 reserved_2;\n\tu32 request_tag;\n};\n\n#define dump_sm_header(_h) _dump_sm_header(_h, __func__, __LINE__)\nstatic void __maybe_unused _dump_sm_header(\n\tconst struct ps3_sys_manager_header *h, const char *func, int line)\n{\n\tpr_debug(\"%s:%d: version:      %xh\\n\", func, line, h->version);\n\tpr_debug(\"%s:%d: size:         %xh\\n\", func, line, h->size);\n\tpr_debug(\"%s:%d: payload_size: %xh\\n\", func, line, h->payload_size);\n\tpr_debug(\"%s:%d: service_id:   %xh\\n\", func, line, h->service_id);\n\tpr_debug(\"%s:%d: request_tag:  %xh\\n\", func, line, h->request_tag);\n}\n\n \n\nenum {\n\tPS3_SM_RX_MSG_LEN_MIN = 24,\n\tPS3_SM_RX_MSG_LEN_MAX = 32,\n};\n\n \n\nenum ps3_sys_manager_service_id {\n\t \n\tPS3_SM_SERVICE_ID_REQUEST = 1,\n\tPS3_SM_SERVICE_ID_RESPONSE = 2,\n\tPS3_SM_SERVICE_ID_COMMAND = 3,\n\tPS3_SM_SERVICE_ID_EXTERN_EVENT = 4,\n\tPS3_SM_SERVICE_ID_SET_NEXT_OP = 5,\n\tPS3_SM_SERVICE_ID_REQUEST_ERROR = 6,\n\tPS3_SM_SERVICE_ID_SET_ATTR = 8,\n};\n\n \n\nenum ps3_sys_manager_attr {\n\t \n\tPS3_SM_ATTR_POWER = 1,\n\tPS3_SM_ATTR_RESET = 2,\n\tPS3_SM_ATTR_THERMAL = 4,\n\tPS3_SM_ATTR_CONTROLLER = 8,  \n\tPS3_SM_ATTR_ALL = 0x0f,\n};\n\n \n\nenum ps3_sys_manager_event {\n\t \n\tPS3_SM_EVENT_POWER_PRESSED = 3,\n\tPS3_SM_EVENT_POWER_RELEASED = 4,\n\tPS3_SM_EVENT_RESET_PRESSED = 5,\n\tPS3_SM_EVENT_RESET_RELEASED = 6,\n\tPS3_SM_EVENT_THERMAL_ALERT = 7,\n\tPS3_SM_EVENT_THERMAL_CLEARED = 8,\n\t \n};\n\n \n\nenum ps3_sys_manager_button_event {\n\tPS3_SM_BUTTON_EVENT_HARD = 0,\n\tPS3_SM_BUTTON_EVENT_SOFT = 1,\n};\n\n \n\nenum ps3_sys_manager_next_op {\n\t \n\tPS3_SM_NEXT_OP_SYS_SHUTDOWN = 1,\n\tPS3_SM_NEXT_OP_SYS_REBOOT = 2,\n\tPS3_SM_NEXT_OP_LPAR_REBOOT = 0x82,\n};\n\n \n\nenum ps3_sys_manager_wake_source {\n\t \n\tPS3_SM_WAKE_DEFAULT   = 0,\n\tPS3_SM_WAKE_W_O_L     = 0x00000400,\n\tPS3_SM_WAKE_P_O_R     = 0x80000000,\n};\n\n \n\nstatic u32 user_wake_sources = PS3_SM_WAKE_DEFAULT;\n\n \n\nenum ps3_sys_manager_cmd {\n\t \n\tPS3_SM_CMD_SHUTDOWN = 1,  \n};\n\n \n\nstatic unsigned int ps3_sm_force_power_off;\n\n \n\nstatic int ps3_sys_manager_write(struct ps3_system_bus_device *dev,\n\tconst struct ps3_sys_manager_header *header, const void *payload)\n{\n\tint result;\n\n\tBUG_ON(header->version != 1);\n\tBUG_ON(header->size != 16);\n\tBUG_ON(header->payload_size != 8 && header->payload_size != 16);\n\tBUG_ON(header->service_id > 8);\n\n\tresult = ps3_vuart_write(dev, header,\n\t\tsizeof(struct ps3_sys_manager_header));\n\n\tif (!result)\n\t\tresult = ps3_vuart_write(dev, payload, header->payload_size);\n\n\treturn result;\n}\n\n \n\nstatic int ps3_sys_manager_send_attr(struct ps3_system_bus_device *dev,\n\tenum ps3_sys_manager_attr attr)\n{\n\tstruct ps3_sys_manager_header header;\n\tstruct {\n\t\tu8 version;\n\t\tu8 reserved_1[3];\n\t\tu32 attribute;\n\t} payload;\n\n\tBUILD_BUG_ON(sizeof(payload) != 8);\n\n\tdev_dbg(&dev->core, \"%s:%d: %xh\\n\", __func__, __LINE__, attr);\n\n\tmemset(&header, 0, sizeof(header));\n\theader.version = 1;\n\theader.size = 16;\n\theader.payload_size = 16;\n\theader.service_id = PS3_SM_SERVICE_ID_SET_ATTR;\n\n\tmemset(&payload, 0, sizeof(payload));\n\tpayload.version = 1;\n\tpayload.attribute = attr;\n\n\treturn ps3_sys_manager_write(dev, &header, &payload);\n}\n\n \n\nstatic int ps3_sys_manager_send_next_op(struct ps3_system_bus_device *dev,\n\tenum ps3_sys_manager_next_op op,\n\tenum ps3_sys_manager_wake_source wake_source)\n{\n\tstruct ps3_sys_manager_header header;\n\tstruct {\n\t\tu8 version;\n\t\tu8 type;\n\t\tu8 gos_id;\n\t\tu8 reserved_1;\n\t\tu32 wake_source;\n\t\tu8 reserved_2[8];\n\t} payload;\n\n\tBUILD_BUG_ON(sizeof(payload) != 16);\n\n\tdev_dbg(&dev->core, \"%s:%d: (%xh)\\n\", __func__, __LINE__, op);\n\n\tmemset(&header, 0, sizeof(header));\n\theader.version = 1;\n\theader.size = 16;\n\theader.payload_size = 16;\n\theader.service_id = PS3_SM_SERVICE_ID_SET_NEXT_OP;\n\n\tmemset(&payload, 0, sizeof(payload));\n\tpayload.version = 3;\n\tpayload.type = op;\n\tpayload.gos_id = 3;  \n\tpayload.wake_source = wake_source;\n\n\treturn ps3_sys_manager_write(dev, &header, &payload);\n}\n\n \n\nstatic int ps3_sys_manager_send_request_shutdown(\n\tstruct ps3_system_bus_device *dev)\n{\n\tstruct ps3_sys_manager_header header;\n\tstruct {\n\t\tu8 version;\n\t\tu8 type;\n\t\tu8 gos_id;\n\t\tu8 reserved_1[13];\n\t} payload;\n\n\tBUILD_BUG_ON(sizeof(payload) != 16);\n\n\tdev_dbg(&dev->core, \"%s:%d\\n\", __func__, __LINE__);\n\n\tmemset(&header, 0, sizeof(header));\n\theader.version = 1;\n\theader.size = 16;\n\theader.payload_size = 16;\n\theader.service_id = PS3_SM_SERVICE_ID_REQUEST;\n\n\tmemset(&payload, 0, sizeof(payload));\n\tpayload.version = 1;\n\tpayload.type = 1;  \n\tpayload.gos_id = 0;  \n\n\treturn ps3_sys_manager_write(dev, &header, &payload);\n}\n\n \n\nstatic int ps3_sys_manager_send_response(struct ps3_system_bus_device *dev,\n\tu64 status)\n{\n\tstruct ps3_sys_manager_header header;\n\tstruct {\n\t\tu8 version;\n\t\tu8 reserved_1[3];\n\t\tu8 status;\n\t\tu8 reserved_2[11];\n\t} payload;\n\n\tBUILD_BUG_ON(sizeof(payload) != 16);\n\n\tdev_dbg(&dev->core, \"%s:%d: (%s)\\n\", __func__, __LINE__,\n\t\t(status ? \"nak\" : \"ack\"));\n\n\tmemset(&header, 0, sizeof(header));\n\theader.version = 1;\n\theader.size = 16;\n\theader.payload_size = 16;\n\theader.service_id = PS3_SM_SERVICE_ID_RESPONSE;\n\n\tmemset(&payload, 0, sizeof(payload));\n\tpayload.version = 1;\n\tpayload.status = status;\n\n\treturn ps3_sys_manager_write(dev, &header, &payload);\n}\n\n \n\nstatic int ps3_sys_manager_handle_event(struct ps3_system_bus_device *dev)\n{\n\tint result;\n\tstruct {\n\t\tu8 version;\n\t\tu8 type;\n\t\tu8 reserved_1[2];\n\t\tu32 value;\n\t\tu8 reserved_2[8];\n\t} event;\n\n\tBUILD_BUG_ON(sizeof(event) != 16);\n\n\tresult = ps3_vuart_read(dev, &event, sizeof(event));\n\tBUG_ON(result && \"need to retry here\");\n\n\tif (event.version != 1) {\n\t\tdev_dbg(&dev->core, \"%s:%d: unsupported event version (%u)\\n\",\n\t\t\t__func__, __LINE__, event.version);\n\t\treturn -EIO;\n\t}\n\n\tswitch (event.type) {\n\tcase PS3_SM_EVENT_POWER_PRESSED:\n\t\tdev_dbg(&dev->core, \"%s:%d: POWER_PRESSED (%s)\\n\",\n\t\t\t__func__, __LINE__,\n\t\t\t(event.value == PS3_SM_BUTTON_EVENT_SOFT ? \"soft\"\n\t\t\t: \"hard\"));\n\t\tps3_sm_force_power_off = 1;\n\t\t \n\t\twmb();\n\t\tkill_cad_pid(SIGINT, 1);  \n\t\tbreak;\n\tcase PS3_SM_EVENT_POWER_RELEASED:\n\t\tdev_dbg(&dev->core, \"%s:%d: POWER_RELEASED (%u ms)\\n\",\n\t\t\t__func__, __LINE__, event.value);\n\t\tbreak;\n\tcase PS3_SM_EVENT_RESET_PRESSED:\n\t\tdev_dbg(&dev->core, \"%s:%d: RESET_PRESSED (%s)\\n\",\n\t\t\t__func__, __LINE__,\n\t\t\t(event.value == PS3_SM_BUTTON_EVENT_SOFT ? \"soft\"\n\t\t\t: \"hard\"));\n\t\tps3_sm_force_power_off = 0;\n\t\t \n\t\twmb();\n\t\tkill_cad_pid(SIGINT, 1);  \n\t\tbreak;\n\tcase PS3_SM_EVENT_RESET_RELEASED:\n\t\tdev_dbg(&dev->core, \"%s:%d: RESET_RELEASED (%u ms)\\n\",\n\t\t\t__func__, __LINE__, event.value);\n\t\tbreak;\n\tcase PS3_SM_EVENT_THERMAL_ALERT:\n\t\tdev_dbg(&dev->core, \"%s:%d: THERMAL_ALERT (zone %u)\\n\",\n\t\t\t__func__, __LINE__, event.value);\n\t\tpr_info(\"PS3 Thermal Alert Zone %u\\n\", event.value);\n\t\tbreak;\n\tcase PS3_SM_EVENT_THERMAL_CLEARED:\n\t\tdev_dbg(&dev->core, \"%s:%d: THERMAL_CLEARED (zone %u)\\n\",\n\t\t\t__func__, __LINE__, event.value);\n\t\tbreak;\n\tdefault:\n\t\tdev_dbg(&dev->core, \"%s:%d: unknown event (%u)\\n\",\n\t\t\t__func__, __LINE__, event.type);\n\t\treturn -EIO;\n\t}\n\n\treturn 0;\n}\n \n\nstatic int ps3_sys_manager_handle_cmd(struct ps3_system_bus_device *dev)\n{\n\tint result;\n\tstruct {\n\t\tu8 version;\n\t\tu8 type;\n\t\tu8 reserved_1[14];\n\t} cmd;\n\n\tBUILD_BUG_ON(sizeof(cmd) != 16);\n\n\tdev_dbg(&dev->core, \"%s:%d\\n\", __func__, __LINE__);\n\n\tresult = ps3_vuart_read(dev, &cmd, sizeof(cmd));\n\tBUG_ON(result && \"need to retry here\");\n\n\tif (result)\n\t\treturn result;\n\n\tif (cmd.version != 1) {\n\t\tdev_dbg(&dev->core, \"%s:%d: unsupported cmd version (%u)\\n\",\n\t\t\t__func__, __LINE__, cmd.version);\n\t\treturn -EIO;\n\t}\n\n\tif (cmd.type != PS3_SM_CMD_SHUTDOWN) {\n\t\tdev_dbg(&dev->core, \"%s:%d: unknown cmd (%u)\\n\",\n\t\t\t__func__, __LINE__, cmd.type);\n\t\treturn -EIO;\n\t}\n\n\tps3_sys_manager_send_response(dev, 0);\n\treturn 0;\n}\n\n \n\nstatic int ps3_sys_manager_handle_msg(struct ps3_system_bus_device *dev)\n{\n\tint result;\n\tstruct ps3_sys_manager_header header;\n\n\tresult = ps3_vuart_read(dev, &header,\n\t\tsizeof(struct ps3_sys_manager_header));\n\n\tif (result)\n\t\treturn result;\n\n\tif (header.version != 1) {\n\t\tdev_dbg(&dev->core, \"%s:%d: unsupported header version (%u)\\n\",\n\t\t\t__func__, __LINE__, header.version);\n\t\tdump_sm_header(&header);\n\t\tgoto fail_header;\n\t}\n\n\tBUILD_BUG_ON(sizeof(header) != 16);\n\n\tif (header.size != 16 || (header.payload_size != 8\n\t\t&& header.payload_size != 16)) {\n\t\tdump_sm_header(&header);\n\t\tBUG();\n\t}\n\n\tswitch (header.service_id) {\n\tcase PS3_SM_SERVICE_ID_EXTERN_EVENT:\n\t\tdev_dbg(&dev->core, \"%s:%d: EVENT\\n\", __func__, __LINE__);\n\t\treturn ps3_sys_manager_handle_event(dev);\n\tcase PS3_SM_SERVICE_ID_COMMAND:\n\t\tdev_dbg(&dev->core, \"%s:%d: COMMAND\\n\", __func__, __LINE__);\n\t\treturn ps3_sys_manager_handle_cmd(dev);\n\tcase PS3_SM_SERVICE_ID_REQUEST_ERROR:\n\t\tdev_dbg(&dev->core, \"%s:%d: REQUEST_ERROR\\n\", __func__,\n\t\t\t__LINE__);\n\t\tdump_sm_header(&header);\n\t\tbreak;\n\tdefault:\n\t\tdev_dbg(&dev->core, \"%s:%d: unknown service_id (%u)\\n\",\n\t\t\t__func__, __LINE__, header.service_id);\n\t\tbreak;\n\t}\n\tgoto fail_id;\n\nfail_header:\n\tps3_vuart_clear_rx_bytes(dev, 0);\n\treturn -EIO;\nfail_id:\n\tps3_vuart_clear_rx_bytes(dev, header.payload_size);\n\treturn -EIO;\n}\n\nstatic void ps3_sys_manager_fin(struct ps3_system_bus_device *dev)\n{\n\tps3_sys_manager_send_request_shutdown(dev);\n\n\tpr_emerg(\"System Halted, OK to turn off power\\n\");\n\n\twhile (ps3_sys_manager_handle_msg(dev)) {\n\t\t \n\t\tlv1_pause(0);\n\t}\n\n\twhile (1) {\n\t\t \n\t\tlv1_pause(1);\n\t}\n}\n\n \n\nstatic void ps3_sys_manager_final_power_off(struct ps3_system_bus_device *dev)\n{\n\tBUG_ON(!dev);\n\n\tdev_dbg(&dev->core, \"%s:%d\\n\", __func__, __LINE__);\n\n\tps3_vuart_cancel_async(dev);\n\n\tps3_sys_manager_send_next_op(dev, PS3_SM_NEXT_OP_SYS_SHUTDOWN,\n\t\tuser_wake_sources);\n\n\tps3_sys_manager_fin(dev);\n}\n\n \n\nstatic void ps3_sys_manager_final_restart(struct ps3_system_bus_device *dev)\n{\n\tBUG_ON(!dev);\n\n\tdev_dbg(&dev->core, \"%s:%d\\n\", __func__, __LINE__);\n\n\t \n\n\tif (ps3_sm_force_power_off) {\n\t\tdev_dbg(&dev->core, \"%s:%d: forcing poweroff\\n\",\n\t\t\t__func__, __LINE__);\n\t\tps3_sys_manager_final_power_off(dev);\n\t}\n\n\tps3_vuart_cancel_async(dev);\n\n\tps3_sys_manager_send_attr(dev, 0);\n\tps3_sys_manager_send_next_op(dev, PS3_SM_NEXT_OP_SYS_REBOOT,\n\t\tuser_wake_sources);\n\n\tps3_sys_manager_fin(dev);\n}\n\n \n\nint ps3_sys_manager_get_wol(void)\n{\n\tpr_debug(\"%s:%d\\n\", __func__, __LINE__);\n\n\treturn (user_wake_sources & PS3_SM_WAKE_W_O_L) != 0;\n}\nEXPORT_SYMBOL_GPL(ps3_sys_manager_get_wol);\n\n \n\nvoid ps3_sys_manager_set_wol(int state)\n{\n\tstatic DEFINE_MUTEX(mutex);\n\n\tmutex_lock(&mutex);\n\n\tpr_debug(\"%s:%d: %d\\n\", __func__, __LINE__, state);\n\n\tif (state)\n\t\tuser_wake_sources |= PS3_SM_WAKE_W_O_L;\n\telse\n\t\tuser_wake_sources &= ~PS3_SM_WAKE_W_O_L;\n\tmutex_unlock(&mutex);\n}\nEXPORT_SYMBOL_GPL(ps3_sys_manager_set_wol);\n\n \n\nstatic void ps3_sys_manager_work(struct ps3_system_bus_device *dev)\n{\n\tps3_sys_manager_handle_msg(dev);\n\tps3_vuart_read_async(dev, PS3_SM_RX_MSG_LEN_MIN);\n}\n\nstatic int ps3_sys_manager_probe(struct ps3_system_bus_device *dev)\n{\n\tint result;\n\tstruct ps3_sys_manager_ops ops;\n\n\tdev_dbg(&dev->core, \"%s:%d\\n\", __func__, __LINE__);\n\n\tops.power_off = ps3_sys_manager_final_power_off;\n\tops.restart = ps3_sys_manager_final_restart;\n\tops.dev = dev;\n\n\t \n\n\tps3_sys_manager_register_ops(&ops);\n\n\tresult = ps3_sys_manager_send_attr(dev, PS3_SM_ATTR_ALL);\n\tBUG_ON(result);\n\n\tresult = ps3_vuart_read_async(dev, PS3_SM_RX_MSG_LEN_MIN);\n\tBUG_ON(result);\n\n\treturn result;\n}\n\nstatic int ps3_sys_manager_remove(struct ps3_system_bus_device *dev)\n{\n\tdev_dbg(&dev->core, \"%s:%d\\n\", __func__, __LINE__);\n\treturn 0;\n}\n\nstatic void ps3_sys_manager_shutdown(struct ps3_system_bus_device *dev)\n{\n\tdev_dbg(&dev->core, \"%s:%d\\n\", __func__, __LINE__);\n}\n\nstatic struct ps3_vuart_port_driver ps3_sys_manager = {\n\t.core.match_id = PS3_MATCH_ID_SYSTEM_MANAGER,\n\t.core.core.name = \"ps3_sys_manager\",\n\t.probe = ps3_sys_manager_probe,\n\t.remove = ps3_sys_manager_remove,\n\t.shutdown = ps3_sys_manager_shutdown,\n\t.work = ps3_sys_manager_work,\n};\n\nstatic int __init ps3_sys_manager_init(void)\n{\n\tif (!firmware_has_feature(FW_FEATURE_PS3_LV1))\n\t\treturn -ENODEV;\n\n\treturn ps3_vuart_port_driver_register(&ps3_sys_manager);\n}\n\nmodule_init(ps3_sys_manager_init);\n \n\nMODULE_AUTHOR(\"Sony Corporation\");\nMODULE_LICENSE(\"GPL v2\");\nMODULE_DESCRIPTION(\"PS3 System Manager\");\nMODULE_ALIAS(PS3_MODULE_ALIAS_SYSTEM_MANAGER);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}