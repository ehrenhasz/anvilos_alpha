{
  "module_name": "ps3stor_lib.c",
  "hash_id": "0e8d5498be77a71fb049dc8d307765e0897635d3979fbd31d0dbbefb696b2b71",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ps3/ps3stor_lib.c",
  "human_readable_source": "\n \n\n#include <linux/dma-mapping.h>\n#include <linux/module.h>\n\n#include <asm/lv1call.h>\n#include <asm/ps3stor.h>\n\n \n\nstatic struct ps3_flash_workaround {\n\tint flash_open;\n\tint disk_open;\n\tstruct ps3_system_bus_device *disk_sbd;\n} ps3_flash_workaround;\n\nstatic int ps3stor_open_hv_device(struct ps3_system_bus_device *sbd)\n{\n\tint error = ps3_open_hv_device(sbd);\n\n\tif (error)\n\t\treturn error;\n\n\tif (sbd->match_id == PS3_MATCH_ID_STOR_FLASH)\n\t\tps3_flash_workaround.flash_open = 1;\n\n\tif (sbd->match_id == PS3_MATCH_ID_STOR_DISK)\n\t\tps3_flash_workaround.disk_open = 1;\n\n\treturn 0;\n}\n\nstatic int ps3stor_close_hv_device(struct ps3_system_bus_device *sbd)\n{\n\tint error;\n\n\tif (sbd->match_id == PS3_MATCH_ID_STOR_DISK\n\t\t&& ps3_flash_workaround.disk_open\n\t\t&& ps3_flash_workaround.flash_open) {\n\t\tps3_flash_workaround.disk_sbd = sbd;\n\t\treturn 0;\n\t}\n\n\terror = ps3_close_hv_device(sbd);\n\n\tif (error)\n\t\treturn error;\n\n\tif (sbd->match_id == PS3_MATCH_ID_STOR_DISK)\n\t\tps3_flash_workaround.disk_open = 0;\n\n\tif (sbd->match_id == PS3_MATCH_ID_STOR_FLASH) {\n\t\tps3_flash_workaround.flash_open = 0;\n\n\t\tif (ps3_flash_workaround.disk_sbd) {\n\t\t\tps3_close_hv_device(ps3_flash_workaround.disk_sbd);\n\t\t\tps3_flash_workaround.disk_open = 0;\n\t\t\tps3_flash_workaround.disk_sbd = NULL;\n\t\t}\n\t}\n\n\treturn 0;\n}\n\nstatic int ps3stor_probe_access(struct ps3_storage_device *dev)\n{\n\tint res, error;\n\tunsigned int i;\n\tunsigned long n;\n\n\tif (dev->sbd.match_id == PS3_MATCH_ID_STOR_ROM) {\n\t\t \n\t\tdev->accessible_regions = 1;\n\t\treturn 0;\n\t}\n\n\terror = -EPERM;\n\tfor (i = 0; i < dev->num_regions; i++) {\n\t\tdev_dbg(&dev->sbd.core,\n\t\t\t\"%s:%u: checking accessibility of region %u\\n\",\n\t\t\t__func__, __LINE__, i);\n\n\t\tdev->region_idx = i;\n\t\tres = ps3stor_read_write_sectors(dev, dev->bounce_lpar, 0, 1,\n\t\t\t\t\t\t 0);\n\t\tif (res) {\n\t\t\tdev_dbg(&dev->sbd.core, \"%s:%u: read failed, \"\n\t\t\t\t\"region %u is not accessible\\n\", __func__,\n\t\t\t\t__LINE__, i);\n\t\t\tcontinue;\n\t\t}\n\n\t\tdev_dbg(&dev->sbd.core, \"%s:%u: region %u is accessible\\n\",\n\t\t\t__func__, __LINE__, i);\n\t\tset_bit(i, &dev->accessible_regions);\n\n\t\t \n\t\terror = 0;\n\t}\n\tif (error)\n\t\treturn error;\n\n\tn = hweight_long(dev->accessible_regions);\n\tif (n > 1)\n\t\tdev_info(&dev->sbd.core,\n\t\t\t \"%s:%u: %lu accessible regions found. Only the first \"\n\t\t\t \"one will be used\\n\",\n\t\t\t __func__, __LINE__, n);\n\tdev->region_idx = __ffs(dev->accessible_regions);\n\tdev_info(&dev->sbd.core,\n\t\t \"First accessible region has index %u start %llu size %llu\\n\",\n\t\t dev->region_idx, dev->regions[dev->region_idx].start,\n\t\t dev->regions[dev->region_idx].size);\n\n\treturn 0;\n}\n\n\n \nint ps3stor_setup(struct ps3_storage_device *dev, irq_handler_t handler)\n{\n\tint error, res, alignment;\n\tenum ps3_dma_page_size page_size;\n\n\terror = ps3stor_open_hv_device(&dev->sbd);\n\tif (error) {\n\t\tdev_err(&dev->sbd.core,\n\t\t\t\"%s:%u: ps3_open_hv_device failed %d\\n\", __func__,\n\t\t\t__LINE__, error);\n\t\tgoto fail;\n\t}\n\n\terror = ps3_sb_event_receive_port_setup(&dev->sbd, PS3_BINDING_CPU_ANY,\n\t\t\t\t\t\t&dev->irq);\n\tif (error) {\n\t\tdev_err(&dev->sbd.core,\n\t\t\t\"%s:%u: ps3_sb_event_receive_port_setup failed %d\\n\",\n\t\t       __func__, __LINE__, error);\n\t\tgoto fail_close_device;\n\t}\n\n\terror = request_irq(dev->irq, handler, 0,\n\t\t\t    dev->sbd.core.driver->name, dev);\n\tif (error) {\n\t\tdev_err(&dev->sbd.core, \"%s:%u: request_irq failed %d\\n\",\n\t\t\t__func__, __LINE__, error);\n\t\tgoto fail_sb_event_receive_port_destroy;\n\t}\n\n\talignment = min(__ffs(dev->bounce_size),\n\t\t\t__ffs((unsigned long)dev->bounce_buf));\n\tif (alignment < 12) {\n\t\tdev_err(&dev->sbd.core,\n\t\t\t\"%s:%u: bounce buffer not aligned (%lx at 0x%p)\\n\",\n\t\t\t__func__, __LINE__, dev->bounce_size, dev->bounce_buf);\n\t\terror = -EINVAL;\n\t\tgoto fail_free_irq;\n\t} else if (alignment < 16)\n\t\tpage_size = PS3_DMA_4K;\n\telse\n\t\tpage_size = PS3_DMA_64K;\n\tdev->sbd.d_region = &dev->dma_region;\n\tps3_dma_region_init(&dev->sbd, &dev->dma_region, page_size,\n\t\t\t    PS3_DMA_OTHER, dev->bounce_buf, dev->bounce_size);\n\tres = ps3_dma_region_create(&dev->dma_region);\n\tif (res) {\n\t\tdev_err(&dev->sbd.core, \"%s:%u: cannot create DMA region\\n\",\n\t\t\t__func__, __LINE__);\n\t\terror = -ENOMEM;\n\t\tgoto fail_free_irq;\n\t}\n\n\tdev->bounce_lpar = ps3_mm_phys_to_lpar(__pa(dev->bounce_buf));\n\tdev->bounce_dma = dma_map_single(&dev->sbd.core, dev->bounce_buf,\n\t\t\t\t\t dev->bounce_size, DMA_BIDIRECTIONAL);\n\tif (dma_mapping_error(&dev->sbd.core, dev->bounce_dma)) {\n\t\tdev_err(&dev->sbd.core, \"%s:%u: map DMA region failed\\n\",\n\t\t\t__func__, __LINE__);\n\t\terror = -ENODEV;\n\t\tgoto fail_free_dma;\n\t}\n\n\terror = ps3stor_probe_access(dev);\n\tif (error) {\n\t\tdev_err(&dev->sbd.core, \"%s:%u: No accessible regions found\\n\",\n\t\t\t__func__, __LINE__);\n\t\tgoto fail_unmap_dma;\n\t}\n\treturn 0;\n\nfail_unmap_dma:\n\tdma_unmap_single(&dev->sbd.core, dev->bounce_dma, dev->bounce_size,\n\t\t\t DMA_BIDIRECTIONAL);\nfail_free_dma:\n\tps3_dma_region_free(&dev->dma_region);\nfail_free_irq:\n\tfree_irq(dev->irq, dev);\nfail_sb_event_receive_port_destroy:\n\tps3_sb_event_receive_port_destroy(&dev->sbd, dev->irq);\nfail_close_device:\n\tps3stor_close_hv_device(&dev->sbd);\nfail:\n\treturn error;\n}\nEXPORT_SYMBOL_GPL(ps3stor_setup);\n\n\n \nvoid ps3stor_teardown(struct ps3_storage_device *dev)\n{\n\tint error;\n\n\tdma_unmap_single(&dev->sbd.core, dev->bounce_dma, dev->bounce_size,\n\t\t\t DMA_BIDIRECTIONAL);\n\tps3_dma_region_free(&dev->dma_region);\n\n\tfree_irq(dev->irq, dev);\n\n\terror = ps3_sb_event_receive_port_destroy(&dev->sbd, dev->irq);\n\tif (error)\n\t\tdev_err(&dev->sbd.core,\n\t\t\t\"%s:%u: destroy event receive port failed %d\\n\",\n\t\t\t__func__, __LINE__, error);\n\n\terror = ps3stor_close_hv_device(&dev->sbd);\n\tif (error)\n\t\tdev_err(&dev->sbd.core,\n\t\t\t\"%s:%u: ps3_close_hv_device failed %d\\n\", __func__,\n\t\t\t__LINE__, error);\n}\nEXPORT_SYMBOL_GPL(ps3stor_teardown);\n\n\n \nu64 ps3stor_read_write_sectors(struct ps3_storage_device *dev, u64 lpar,\n\t\t\t       u64 start_sector, u64 sectors, int write)\n{\n\tunsigned int region_id = dev->regions[dev->region_idx].id;\n\tconst char *op = write ? \"write\" : \"read\";\n\tint res;\n\n\tdev_dbg(&dev->sbd.core, \"%s:%u: %s %llu sectors starting at %llu\\n\",\n\t\t__func__, __LINE__, op, sectors, start_sector);\n\n\tinit_completion(&dev->done);\n\tres = write ? lv1_storage_write(dev->sbd.dev_id, region_id,\n\t\t\t\t\tstart_sector, sectors, 0, lpar,\n\t\t\t\t\t&dev->tag)\n\t\t    : lv1_storage_read(dev->sbd.dev_id, region_id,\n\t\t\t\t       start_sector, sectors, 0, lpar,\n\t\t\t\t       &dev->tag);\n\tif (res) {\n\t\tdev_dbg(&dev->sbd.core, \"%s:%u: %s failed %d\\n\", __func__,\n\t\t\t__LINE__, op, res);\n\t\treturn -1;\n\t}\n\n\twait_for_completion(&dev->done);\n\tif (dev->lv1_status) {\n\t\tdev_dbg(&dev->sbd.core, \"%s:%u: %s failed 0x%llx\\n\", __func__,\n\t\t\t__LINE__, op, dev->lv1_status);\n\t\treturn dev->lv1_status;\n\t}\n\n\tdev_dbg(&dev->sbd.core, \"%s:%u: %s completed\\n\", __func__, __LINE__,\n\t\top);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(ps3stor_read_write_sectors);\n\n\n \nu64 ps3stor_send_command(struct ps3_storage_device *dev, u64 cmd, u64 arg1,\n\t\t\t u64 arg2, u64 arg3, u64 arg4)\n{\n\tint res;\n\n\tdev_dbg(&dev->sbd.core, \"%s:%u: send device command 0x%llx\\n\", __func__,\n\t\t__LINE__, cmd);\n\n\tinit_completion(&dev->done);\n\n\tres = lv1_storage_send_device_command(dev->sbd.dev_id, cmd, arg1,\n\t\t\t\t\t      arg2, arg3, arg4, &dev->tag);\n\tif (res) {\n\t\tdev_err(&dev->sbd.core,\n\t\t\t\"%s:%u: send_device_command 0x%llx failed %d\\n\",\n\t\t\t__func__, __LINE__, cmd, res);\n\t\treturn -1;\n\t}\n\n\twait_for_completion(&dev->done);\n\tif (dev->lv1_status) {\n\t\tdev_dbg(&dev->sbd.core, \"%s:%u: command 0x%llx failed 0x%llx\\n\",\n\t\t\t__func__, __LINE__, cmd, dev->lv1_status);\n\t\treturn dev->lv1_status;\n\t}\n\n\tdev_dbg(&dev->sbd.core, \"%s:%u: command 0x%llx completed\\n\", __func__,\n\t\t__LINE__, cmd);\n\n\treturn 0;\n}\nEXPORT_SYMBOL_GPL(ps3stor_send_command);\n\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"PS3 Storage Bus Library\");\nMODULE_AUTHOR(\"Sony Corporation\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}