{
  "module_name": "ps3av_cmd.c",
  "hash_id": "ca8eba819af6b758af09e117aa5b48116832e4b1165854b2cdde6bbe1f5388e2",
  "original_prompt": "Ingested from linux-6.6.14/drivers/ps3/ps3av_cmd.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/delay.h>\n\n#include <asm/ps3av.h>\n#include <asm/ps3.h>\n#include <asm/ps3gpu.h>\n\n#include \"vuart.h\"\n\nstatic const struct video_fmt {\n\tu32 format;\n\tu32 order;\n} ps3av_video_fmt_table[] = {\n\t{ PS3AV_CMD_VIDEO_FORMAT_ARGB_8BIT, PS3AV_CMD_VIDEO_ORDER_RGB },\n\t{ PS3AV_CMD_VIDEO_FORMAT_ARGB_8BIT, PS3AV_CMD_VIDEO_ORDER_BGR },\n};\n\nstatic const struct {\n\tint cs;\n\tu32 av;\n\tu32 bl;\n} ps3av_cs_video2av_table[] = {\n\t{\n\t\t.cs = PS3AV_CMD_VIDEO_CS_RGB_8,\n\t\t.av = PS3AV_CMD_AV_CS_RGB_8,\n\t\t.bl = PS3AV_CMD_AV_CS_8\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_RGB_10,\n\t\t.av = PS3AV_CMD_AV_CS_RGB_8,\n\t\t.bl = PS3AV_CMD_AV_CS_8\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_RGB_12,\n\t\t.av = PS3AV_CMD_AV_CS_RGB_8,\n\t\t.bl = PS3AV_CMD_AV_CS_8\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_YUV444_8,\n\t\t.av = PS3AV_CMD_AV_CS_YUV444_8,\n\t\t.bl = PS3AV_CMD_AV_CS_8\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_YUV444_10,\n\t\t.av = PS3AV_CMD_AV_CS_YUV444_8,\n\t\t.bl = PS3AV_CMD_AV_CS_10\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_YUV444_12,\n\t\t.av = PS3AV_CMD_AV_CS_YUV444_8,\n\t\t.bl = PS3AV_CMD_AV_CS_10\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_YUV422_8,\n\t\t.av = PS3AV_CMD_AV_CS_YUV422_8,\n\t\t.bl = PS3AV_CMD_AV_CS_10\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_YUV422_10,\n\t\t.av = PS3AV_CMD_AV_CS_YUV422_8,\n\t\t.bl = PS3AV_CMD_AV_CS_10\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_YUV422_12,\n\t\t.av = PS3AV_CMD_AV_CS_YUV422_8,\n\t\t.bl = PS3AV_CMD_AV_CS_12\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_XVYCC_8,\n\t\t.av = PS3AV_CMD_AV_CS_XVYCC_8,\n\t\t.bl = PS3AV_CMD_AV_CS_12\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_XVYCC_10,\n\t\t.av = PS3AV_CMD_AV_CS_XVYCC_8,\n\t\t.bl = PS3AV_CMD_AV_CS_12\n\t}, {\n\t\t.cs = PS3AV_CMD_VIDEO_CS_XVYCC_12,\n\t\t.av = PS3AV_CMD_AV_CS_XVYCC_8,\n\t\t.bl = PS3AV_CMD_AV_CS_12\n\t}\n};\n\nstatic u32 ps3av_cs_video2av(int cs)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < ARRAY_SIZE(ps3av_cs_video2av_table); i++)\n\t\tif (ps3av_cs_video2av_table[i].cs == cs)\n\t\t\treturn ps3av_cs_video2av_table[i].av;\n\n\treturn PS3AV_CMD_AV_CS_RGB_8;\n}\n\nstatic u32 ps3av_cs_video2av_bitlen(int cs)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < ARRAY_SIZE(ps3av_cs_video2av_table); i++)\n\t\tif (ps3av_cs_video2av_table[i].cs == cs)\n\t\t\treturn ps3av_cs_video2av_table[i].bl;\n\n\treturn PS3AV_CMD_AV_CS_8;\n}\n\nstatic const struct {\n\tint vid;\n\tu32 av;\n} ps3av_vid_video2av_table[] = {\n\t{ PS3AV_CMD_VIDEO_VID_480I, PS3AV_CMD_AV_VID_480I },\n\t{ PS3AV_CMD_VIDEO_VID_480P, PS3AV_CMD_AV_VID_480P },\n\t{ PS3AV_CMD_VIDEO_VID_576I, PS3AV_CMD_AV_VID_576I },\n\t{ PS3AV_CMD_VIDEO_VID_576P, PS3AV_CMD_AV_VID_576P },\n\t{ PS3AV_CMD_VIDEO_VID_1080I_60HZ, PS3AV_CMD_AV_VID_1080I_60HZ },\n\t{ PS3AV_CMD_VIDEO_VID_720P_60HZ, PS3AV_CMD_AV_VID_720P_60HZ },\n\t{ PS3AV_CMD_VIDEO_VID_1080P_60HZ, PS3AV_CMD_AV_VID_1080P_60HZ },\n\t{ PS3AV_CMD_VIDEO_VID_1080I_50HZ, PS3AV_CMD_AV_VID_1080I_50HZ },\n\t{ PS3AV_CMD_VIDEO_VID_720P_50HZ, PS3AV_CMD_AV_VID_720P_50HZ },\n\t{ PS3AV_CMD_VIDEO_VID_1080P_50HZ, PS3AV_CMD_AV_VID_1080P_50HZ },\n\t{ PS3AV_CMD_VIDEO_VID_WXGA, PS3AV_CMD_AV_VID_WXGA },\n\t{ PS3AV_CMD_VIDEO_VID_SXGA, PS3AV_CMD_AV_VID_SXGA },\n\t{ PS3AV_CMD_VIDEO_VID_WUXGA, PS3AV_CMD_AV_VID_WUXGA }\n};\n\nstatic u32 ps3av_vid_video2av(int vid)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < ARRAY_SIZE(ps3av_vid_video2av_table); i++)\n\t\tif (ps3av_vid_video2av_table[i].vid == vid)\n\t\t\treturn ps3av_vid_video2av_table[i].av;\n\n\treturn PS3AV_CMD_AV_VID_480P;\n}\n\nstatic int ps3av_hdmi_range(void)\n{\n\tif (ps3_compare_firmware_version(1, 8, 0) < 0)\n\t\treturn 0;\n\telse\n\t\treturn 1;  \n}\n\nint ps3av_cmd_init(void)\n{\n\tint res;\n\tstruct ps3av_pkt_av_init av_init;\n\tstruct ps3av_pkt_video_init video_init;\n\tstruct ps3av_pkt_audio_init audio_init;\n\n\t \n\tmemset(&video_init, 0, sizeof(video_init));\n\n\tres = ps3av_do_pkt(PS3AV_CID_VIDEO_INIT, sizeof(video_init.send_hdr),\n\t\t\t   sizeof(video_init), &video_init.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&video_init);\n\tif (res) {\n\t\tprintk(KERN_ERR \"PS3AV_CID_VIDEO_INIT: failed %x\\n\", res);\n\t\treturn res;\n\t}\n\n\t \n\tmemset(&audio_init, 0, sizeof(audio_init));\n\n\tres = ps3av_do_pkt(PS3AV_CID_AUDIO_INIT, sizeof(audio_init.send_hdr),\n\t\t\t   sizeof(audio_init), &audio_init.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&audio_init);\n\tif (res) {\n\t\tprintk(KERN_ERR \"PS3AV_CID_AUDIO_INIT: failed %x\\n\", res);\n\t\treturn res;\n\t}\n\n\t \n\tmemset(&av_init, 0, sizeof(av_init));\n\tav_init.event_bit = 0;\n\n\tres = ps3av_do_pkt(PS3AV_CID_AV_INIT, sizeof(av_init), sizeof(av_init),\n\t\t\t   &av_init.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&av_init);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AV_INIT: failed %x\\n\", res);\n\n\treturn res;\n}\n\nint ps3av_cmd_fin(void)\n{\n\tint res;\n\tstruct ps3av_pkt_av_fin av_fin;\n\n\tmemset(&av_fin, 0, sizeof(av_fin));\n\n\tres = ps3av_do_pkt(PS3AV_CID_AV_FIN, sizeof(av_fin.send_hdr),\n\t\t\t   sizeof(av_fin), &av_fin.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&av_fin);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AV_FIN: failed %x\\n\", res);\n\n\treturn res;\n}\n\nint ps3av_cmd_av_video_mute(int num_of_port, u32 *port, u32 mute)\n{\n\tint i, send_len, res;\n\tstruct ps3av_pkt_av_video_mute av_video_mute;\n\n\tif (num_of_port > PS3AV_MUTE_PORT_MAX)\n\t\treturn -EINVAL;\n\n\tmemset(&av_video_mute, 0, sizeof(av_video_mute));\n\tfor (i = 0; i < num_of_port; i++) {\n\t\tav_video_mute.mute[i].avport = port[i];\n\t\tav_video_mute.mute[i].mute = mute;\n\t}\n\n\tsend_len = sizeof(av_video_mute.send_hdr) +\n\t    sizeof(struct ps3av_av_mute) * num_of_port;\n\tres = ps3av_do_pkt(PS3AV_CID_AV_VIDEO_MUTE, send_len,\n\t\t\t   sizeof(av_video_mute), &av_video_mute.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&av_video_mute);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AV_VIDEO_MUTE: failed %x\\n\", res);\n\n\treturn res;\n}\n\nint ps3av_cmd_av_video_disable_sig(u32 port)\n{\n\tint res;\n\tstruct ps3av_pkt_av_video_disable_sig av_video_sig;\n\n\tmemset(&av_video_sig, 0, sizeof(av_video_sig));\n\tav_video_sig.avport = port;\n\n\tres = ps3av_do_pkt(PS3AV_CID_AV_VIDEO_DISABLE_SIG,\n\t\t\t   sizeof(av_video_sig), sizeof(av_video_sig),\n\t\t\t   &av_video_sig.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&av_video_sig);\n\tif (res)\n\t\tprintk(KERN_ERR\n\t\t       \"PS3AV_CID_AV_VIDEO_DISABLE_SIG: failed %x port:%x\\n\",\n\t\t       res, port);\n\n\treturn res;\n}\n\nint ps3av_cmd_av_tv_mute(u32 avport, u32 mute)\n{\n\tint res;\n\tstruct ps3av_pkt_av_tv_mute tv_mute;\n\n\tmemset(&tv_mute, 0, sizeof(tv_mute));\n\ttv_mute.avport = avport;\n\ttv_mute.mute = mute;\n\n\tres = ps3av_do_pkt(PS3AV_CID_AV_TV_MUTE, sizeof(tv_mute),\n\t\t\t   sizeof(tv_mute), &tv_mute.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&tv_mute);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AV_TV_MUTE: failed %x port:%x\\n\",\n\t\t       res, avport);\n\n\treturn res;\n}\n\nint ps3av_cmd_enable_event(void)\n{\n\tint res;\n\tstruct ps3av_pkt_av_event av_event;\n\n\tmemset(&av_event, 0, sizeof(av_event));\n\tav_event.event_bit = PS3AV_CMD_EVENT_BIT_UNPLUGGED |\n\t    PS3AV_CMD_EVENT_BIT_PLUGGED | PS3AV_CMD_EVENT_BIT_HDCP_DONE;\n\n\tres = ps3av_do_pkt(PS3AV_CID_AV_ENABLE_EVENT, sizeof(av_event),\n\t\t\t   sizeof(av_event), &av_event.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&av_event);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AV_ENABLE_EVENT: failed %x\\n\", res);\n\n\treturn res;\n}\n\nint ps3av_cmd_av_hdmi_mode(u8 mode)\n{\n\tint res;\n\tstruct ps3av_pkt_av_hdmi_mode hdmi_mode;\n\n\tmemset(&hdmi_mode, 0, sizeof(hdmi_mode));\n\thdmi_mode.mode = mode;\n\n\tres = ps3av_do_pkt(PS3AV_CID_AV_HDMI_MODE, sizeof(hdmi_mode),\n\t\t\t   sizeof(hdmi_mode), &hdmi_mode.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&hdmi_mode);\n\tif (res && res != PS3AV_STATUS_UNSUPPORTED_HDMI_MODE)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AV_HDMI_MODE: failed %x\\n\", res);\n\n\treturn res;\n}\n\nu32 ps3av_cmd_set_av_video_cs(void *p, u32 avport, int video_vid, int cs_out,\n\t\t\t      int aspect, u32 id)\n{\n\tstruct ps3av_pkt_av_video_cs *av_video_cs;\n\n\tav_video_cs = (struct ps3av_pkt_av_video_cs *)p;\n\tif (video_vid == -1)\n\t\tvideo_vid = PS3AV_CMD_VIDEO_VID_720P_60HZ;\n\tif (cs_out == -1)\n\t\tcs_out = PS3AV_CMD_VIDEO_CS_YUV444_8;\n\tif (aspect == -1)\n\t\taspect = 0;\n\n\tmemset(av_video_cs, 0, sizeof(*av_video_cs));\n\tps3av_set_hdr(PS3AV_CID_AV_VIDEO_CS, sizeof(*av_video_cs),\n\t\t      &av_video_cs->send_hdr);\n\tav_video_cs->avport = avport;\n\t \n\tav_video_cs->av_vid = ps3av_vid_video2av(video_vid);\n\tav_video_cs->av_cs_out = ps3av_cs_video2av(cs_out);\n\t \n\tav_video_cs->av_cs_in = ps3av_cs_video2av(PS3AV_CMD_VIDEO_CS_RGB_8);\n\tav_video_cs->bitlen_out = ps3av_cs_video2av_bitlen(cs_out);\n\tif ((id & PS3AV_MODE_WHITE) && ps3av_hdmi_range())\n\t\tav_video_cs->super_white = PS3AV_CMD_AV_SUPER_WHITE_ON;\n\telse  \n\t\tav_video_cs->super_white = PS3AV_CMD_AV_SUPER_WHITE_OFF;\n\tav_video_cs->aspect = aspect;\n\tif (id & PS3AV_MODE_DITHER) {\n\t\tav_video_cs->dither = PS3AV_CMD_AV_DITHER_ON\n\t\t    | PS3AV_CMD_AV_DITHER_8BIT;\n\t} else {\n\t\t \n\t\tav_video_cs->dither = PS3AV_CMD_AV_DITHER_OFF;\n\t}\n\n\treturn sizeof(*av_video_cs);\n}\n\nu32 ps3av_cmd_set_video_mode(void *p, u32 head, int video_vid, int video_fmt,\n\t\t\t     u32 id)\n{\n\tstruct ps3av_pkt_video_mode *video_mode;\n\tu32 x, y;\n\n\tvideo_mode = (struct ps3av_pkt_video_mode *)p;\n\tif (video_vid == -1)\n\t\tvideo_vid = PS3AV_CMD_VIDEO_VID_720P_60HZ;\n\tif (video_fmt == -1)\n\t\tvideo_fmt = PS3AV_CMD_VIDEO_FMT_X8R8G8B8;\n\n\tif (ps3av_video_mode2res(id, &x, &y))\n\t\treturn 0;\n\n\t \n\tmemset(video_mode, 0, sizeof(*video_mode));\n\tps3av_set_hdr(PS3AV_CID_VIDEO_MODE, sizeof(*video_mode),\n\t\t      &video_mode->send_hdr);\n\tvideo_mode->video_head = head;\n\tif (video_vid == PS3AV_CMD_VIDEO_VID_480I\n\t    && head == PS3AV_CMD_VIDEO_HEAD_B)\n\t\tvideo_mode->video_vid = PS3AV_CMD_VIDEO_VID_480I_A;\n\telse\n\t\tvideo_mode->video_vid = video_vid;\n\tvideo_mode->width = (u16) x;\n\tvideo_mode->height = (u16) y;\n\tvideo_mode->pitch = video_mode->width * 4;\t \n\tvideo_mode->video_out_format = PS3AV_CMD_VIDEO_OUT_FORMAT_RGB_12BIT;\n\tvideo_mode->video_format = ps3av_video_fmt_table[video_fmt].format;\n\tif ((id & PS3AV_MODE_COLOR) && ps3av_hdmi_range())\n\t\tvideo_mode->video_cl_cnv = PS3AV_CMD_VIDEO_CL_CNV_DISABLE_LUT;\n\telse  \n\t\tvideo_mode->video_cl_cnv = PS3AV_CMD_VIDEO_CL_CNV_ENABLE_LUT;\n\tvideo_mode->video_order = ps3av_video_fmt_table[video_fmt].order;\n\n\tpr_debug(\"%s: video_mode:vid:%x width:%d height:%d pitch:%d out_format:%d format:%x order:%x\\n\",\n\t\t__func__, video_vid, video_mode->width, video_mode->height,\n\t\tvideo_mode->pitch, video_mode->video_out_format,\n\t\tvideo_mode->video_format, video_mode->video_order);\n\treturn sizeof(*video_mode);\n}\n\nint ps3av_cmd_video_format_black(u32 head, u32 video_fmt, u32 mute)\n{\n\tint res;\n\tstruct ps3av_pkt_video_format video_format;\n\n\tmemset(&video_format, 0, sizeof(video_format));\n\tvideo_format.video_head = head;\n\tif (mute != PS3AV_CMD_MUTE_OFF)\n\t\tvideo_format.video_format = PS3AV_CMD_VIDEO_FORMAT_BLACK;\n\telse\n\t\tvideo_format.video_format =\n\t\t    ps3av_video_fmt_table[video_fmt].format;\n\tvideo_format.video_order = ps3av_video_fmt_table[video_fmt].order;\n\n\tres = ps3av_do_pkt(PS3AV_CID_VIDEO_FORMAT, sizeof(video_format),\n\t\t\t   sizeof(video_format), &video_format.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&video_format);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_VIDEO_FORMAT: failed %x\\n\", res);\n\n\treturn res;\n}\n\n\nint ps3av_cmd_av_audio_mute(int num_of_port, u32 *port, u32 mute)\n{\n\tint i, res;\n\tstruct ps3av_pkt_av_audio_mute av_audio_mute;\n\n\tif (num_of_port > PS3AV_MUTE_PORT_MAX)\n\t\treturn -EINVAL;\n\n\t \n\tmemset(&av_audio_mute, 0, sizeof(av_audio_mute));\n\tfor (i = 0; i < num_of_port; i++) {\n\t\tav_audio_mute.mute[i].avport = port[i];\n\t\tav_audio_mute.mute[i].mute = mute;\n\t}\n\n\tres = ps3av_do_pkt(PS3AV_CID_AV_AUDIO_MUTE,\n\t\t\t   sizeof(av_audio_mute.send_hdr) +\n\t\t\t   sizeof(struct ps3av_av_mute) * num_of_port,\n\t\t\t   sizeof(av_audio_mute), &av_audio_mute.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&av_audio_mute);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AV_AUDIO_MUTE: failed %x\\n\", res);\n\n\treturn res;\n}\n\nstatic const struct {\n\tu32 fs;\n\tu8 mclk;\n} ps3av_cnv_mclk_table[] = {\n\t{ PS3AV_CMD_AUDIO_FS_44K, PS3AV_CMD_AV_MCLK_512 },\n\t{ PS3AV_CMD_AUDIO_FS_48K, PS3AV_CMD_AV_MCLK_512 },\n\t{ PS3AV_CMD_AUDIO_FS_88K, PS3AV_CMD_AV_MCLK_256 },\n\t{ PS3AV_CMD_AUDIO_FS_96K, PS3AV_CMD_AV_MCLK_256 },\n\t{ PS3AV_CMD_AUDIO_FS_176K, PS3AV_CMD_AV_MCLK_128 },\n\t{ PS3AV_CMD_AUDIO_FS_192K, PS3AV_CMD_AV_MCLK_128 }\n};\n\nstatic u8 ps3av_cnv_mclk(u32 fs)\n{\n\tunsigned int i;\n\n\tfor (i = 0; i < ARRAY_SIZE(ps3av_cnv_mclk_table); i++)\n\t\tif (ps3av_cnv_mclk_table[i].fs == fs)\n\t\t\treturn ps3av_cnv_mclk_table[i].mclk;\n\n\tprintk(KERN_ERR \"%s failed, fs:%x\\n\", __func__, fs);\n\treturn 0;\n}\n\n#define BASE\tPS3AV_CMD_AUDIO_FS_44K\n\nstatic const u32 ps3av_ns_table[][5] = {\n\t\t\t\t\t \n\t[PS3AV_CMD_AUDIO_FS_44K-BASE] =\t{  6272,  6272, 17836, 17836,  8918 },\n\t[PS3AV_CMD_AUDIO_FS_48K-BASE] =\t{  6144,  6144, 11648, 11648,  5824 },\n\t[PS3AV_CMD_AUDIO_FS_88K-BASE] =\t{ 12544, 12544, 35672, 35672, 17836 },\n\t[PS3AV_CMD_AUDIO_FS_96K-BASE] =\t{ 12288, 12288, 23296, 23296, 11648 },\n\t[PS3AV_CMD_AUDIO_FS_176K-BASE] =\t{ 25088, 25088, 71344, 71344, 35672 },\n\t[PS3AV_CMD_AUDIO_FS_192K-BASE] =\t{ 24576, 24576, 46592, 46592, 23296 }\n};\n\nstatic void ps3av_cnv_ns(u8 *ns, u32 fs, u32 video_vid)\n{\n\tu32 av_vid, ns_val;\n\tint d;\n\n\td = ns_val = 0;\n\tav_vid = ps3av_vid_video2av(video_vid);\n\tswitch (av_vid) {\n\tcase PS3AV_CMD_AV_VID_480I:\n\tcase PS3AV_CMD_AV_VID_576I:\n\t\td = 0;\n\t\tbreak;\n\tcase PS3AV_CMD_AV_VID_480P:\n\tcase PS3AV_CMD_AV_VID_576P:\n\t\td = 1;\n\t\tbreak;\n\tcase PS3AV_CMD_AV_VID_1080I_60HZ:\n\tcase PS3AV_CMD_AV_VID_1080I_50HZ:\n\t\td = 2;\n\t\tbreak;\n\tcase PS3AV_CMD_AV_VID_720P_60HZ:\n\tcase PS3AV_CMD_AV_VID_720P_50HZ:\n\t\td = 3;\n\t\tbreak;\n\tcase PS3AV_CMD_AV_VID_1080P_60HZ:\n\tcase PS3AV_CMD_AV_VID_1080P_50HZ:\n\tcase PS3AV_CMD_AV_VID_WXGA:\n\tcase PS3AV_CMD_AV_VID_SXGA:\n\tcase PS3AV_CMD_AV_VID_WUXGA:\n\t\td = 4;\n\t\tbreak;\n\tdefault:\n\t\tprintk(KERN_ERR \"%s failed, vid:%x\\n\", __func__, video_vid);\n\t\tbreak;\n\t}\n\n\tif (fs < PS3AV_CMD_AUDIO_FS_44K || fs > PS3AV_CMD_AUDIO_FS_192K)\n\t\tprintk(KERN_ERR \"%s failed, fs:%x\\n\", __func__, fs);\n\telse\n\t\tns_val = ps3av_ns_table[PS3AV_CMD_AUDIO_FS_44K-BASE][d];\n\n\t*ns++ = ns_val & 0x000000FF;\n\t*ns++ = (ns_val & 0x0000FF00) >> 8;\n\t*ns = (ns_val & 0x00FF0000) >> 16;\n}\n\n#undef BASE\n\nstatic u8 ps3av_cnv_enable(u32 source, const u8 *enable)\n{\n\tu8 ret = 0;\n\n\tif (source == PS3AV_CMD_AUDIO_SOURCE_SPDIF) {\n\t\tret = 0x03;\n\t} else if (source == PS3AV_CMD_AUDIO_SOURCE_SERIAL) {\n\t\tret = ((enable[0] << 4) + (enable[1] << 5) + (enable[2] << 6) +\n\t\t       (enable[3] << 7)) | 0x01;\n\t} else\n\t\tprintk(KERN_ERR \"%s failed, source:%x\\n\", __func__, source);\n\treturn ret;\n}\n\nstatic u8 ps3av_cnv_fifomap(const u8 *map)\n{\n\tu8 ret = 0;\n\n\tret = map[0] + (map[1] << 2) + (map[2] << 4) + (map[3] << 6);\n\treturn ret;\n}\n\nstatic u8 ps3av_cnv_inputlen(u32 word_bits)\n{\n\tu8 ret = 0;\n\n\tswitch (word_bits) {\n\tcase PS3AV_CMD_AUDIO_WORD_BITS_16:\n\t\tret = PS3AV_CMD_AV_INPUTLEN_16;\n\t\tbreak;\n\tcase PS3AV_CMD_AUDIO_WORD_BITS_20:\n\t\tret = PS3AV_CMD_AV_INPUTLEN_20;\n\t\tbreak;\n\tcase PS3AV_CMD_AUDIO_WORD_BITS_24:\n\t\tret = PS3AV_CMD_AV_INPUTLEN_24;\n\t\tbreak;\n\tdefault:\n\t\tprintk(KERN_ERR \"%s failed, word_bits:%x\\n\", __func__,\n\t\t       word_bits);\n\t\tbreak;\n\t}\n\treturn ret;\n}\n\nstatic u8 ps3av_cnv_layout(u32 num_of_ch)\n{\n\tif (num_of_ch > PS3AV_CMD_AUDIO_NUM_OF_CH_8) {\n\t\tprintk(KERN_ERR \"%s failed, num_of_ch:%x\\n\", __func__,\n\t\t       num_of_ch);\n\t\treturn 0;\n\t}\n\n\treturn num_of_ch == PS3AV_CMD_AUDIO_NUM_OF_CH_2 ? 0x0 : 0x1;\n}\n\nstatic void ps3av_cnv_info(struct ps3av_audio_info_frame *info,\n\t\t\t   const struct ps3av_pkt_audio_mode *mode)\n{\n\tinfo->pb1.cc = mode->audio_num_of_ch + 1;\t \n\tinfo->pb1.ct = 0;\n\tinfo->pb2.sf = 0;\n\tinfo->pb2.ss = 0;\n\n\tinfo->pb3 = 0;\t\t \n\tinfo->pb4 = mode->audio_layout;\n\tinfo->pb5.dm = mode->audio_downmix;\n\tinfo->pb5.lsv = mode->audio_downmix_level;\n}\n\nstatic void ps3av_cnv_chstat(u8 *chstat, const u8 *cs_info)\n{\n\tmemcpy(chstat, cs_info, 5);\n}\n\nu32 ps3av_cmd_set_av_audio_param(void *p, u32 port,\n\t\t\t\t const struct ps3av_pkt_audio_mode *audio_mode,\n\t\t\t\t u32 video_vid)\n{\n\tstruct ps3av_pkt_av_audio_param *param;\n\n\tparam = (struct ps3av_pkt_av_audio_param *)p;\n\n\tmemset(param, 0, sizeof(*param));\n\tps3av_set_hdr(PS3AV_CID_AV_AUDIO_PARAM, sizeof(*param),\n\t\t      &param->send_hdr);\n\n\tparam->avport = port;\n\tparam->mclk = ps3av_cnv_mclk(audio_mode->audio_fs) | 0x80;\n\tps3av_cnv_ns(param->ns, audio_mode->audio_fs, video_vid);\n\tparam->enable = ps3av_cnv_enable(audio_mode->audio_source,\n\t\t\t\t\t audio_mode->audio_enable);\n\tparam->swaplr = 0x09;\n\tparam->fifomap = ps3av_cnv_fifomap(audio_mode->audio_map);\n\tparam->inputctrl = 0x49;\n\tparam->inputlen = ps3av_cnv_inputlen(audio_mode->audio_word_bits);\n\tparam->layout = ps3av_cnv_layout(audio_mode->audio_num_of_ch);\n\tps3av_cnv_info(&param->info, audio_mode);\n\tps3av_cnv_chstat(param->chstat, audio_mode->audio_cs_info);\n\n\treturn sizeof(*param);\n}\n\n \nu8 ps3av_mode_cs_info[] = {\n\t0x00, 0x09, 0x00, 0x02, 0x01, 0x00, 0x00, 0x00\n};\nEXPORT_SYMBOL_GPL(ps3av_mode_cs_info);\n\n#define CS_44\t0x00\n#define CS_48\t0x02\n#define CS_88\t0x08\n#define CS_96\t0x0a\n#define CS_176\t0x0c\n#define CS_192\t0x0e\n#define CS_MASK\t0x0f\n#define CS_BIT\t0x40\n\nvoid ps3av_cmd_set_audio_mode(struct ps3av_pkt_audio_mode *audio, u32 avport,\n\t\t\t      u32 ch, u32 fs, u32 word_bits, u32 format,\n\t\t\t      u32 source)\n{\n\tint spdif_through;\n\tint i;\n\n\tif (!(ch | fs | format | word_bits | source)) {\n\t\tch = PS3AV_CMD_AUDIO_NUM_OF_CH_2;\n\t\tfs = PS3AV_CMD_AUDIO_FS_48K;\n\t\tword_bits = PS3AV_CMD_AUDIO_WORD_BITS_16;\n\t\tformat = PS3AV_CMD_AUDIO_FORMAT_PCM;\n\t\tsource = PS3AV_CMD_AUDIO_SOURCE_SERIAL;\n\t}\n\n\t \n\tmemset(audio, 0, sizeof(*audio));\n\tps3av_set_hdr(PS3AV_CID_AUDIO_MODE, sizeof(*audio), &audio->send_hdr);\n\n\taudio->avport = (u8) avport;\n\taudio->mask = 0x0FFF;\t \n\taudio->audio_num_of_ch = ch;\n\taudio->audio_fs = fs;\n\taudio->audio_word_bits = word_bits;\n\taudio->audio_format = format;\n\taudio->audio_source = source;\n\n\tswitch (ch) {\n\tcase PS3AV_CMD_AUDIO_NUM_OF_CH_8:\n\t\taudio->audio_enable[3] = 1;\n\t\tfallthrough;\n\tcase PS3AV_CMD_AUDIO_NUM_OF_CH_6:\n\t\taudio->audio_enable[2] = 1;\n\t\taudio->audio_enable[1] = 1;\n\t\tfallthrough;\n\tcase PS3AV_CMD_AUDIO_NUM_OF_CH_2:\n\tdefault:\n\t\taudio->audio_enable[0] = 1;\n\t}\n\n\t \n\tfor (i = 0; i < 4; i++)\n\t\taudio->audio_swap[i] = PS3AV_CMD_AUDIO_SWAP_0;\t \n\n\t \n\taudio->audio_map[0] = PS3AV_CMD_AUDIO_MAP_OUTPUT_0;\n\taudio->audio_map[1] = PS3AV_CMD_AUDIO_MAP_OUTPUT_1;\n\taudio->audio_map[2] = PS3AV_CMD_AUDIO_MAP_OUTPUT_2;\n\taudio->audio_map[3] = PS3AV_CMD_AUDIO_MAP_OUTPUT_3;\n\n\t \n\tif (avport == PS3AV_CMD_AVPORT_HDMI_0 ||\n\t    avport == PS3AV_CMD_AVPORT_HDMI_1) {\n\t\tswitch (ch) {\n\t\tcase PS3AV_CMD_AUDIO_NUM_OF_CH_8:\n\t\t\taudio->audio_layout = PS3AV_CMD_AUDIO_LAYOUT_8CH;\n\t\t\tbreak;\n\t\tcase PS3AV_CMD_AUDIO_NUM_OF_CH_6:\n\t\t\taudio->audio_layout = PS3AV_CMD_AUDIO_LAYOUT_6CH;\n\t\t\tbreak;\n\t\tcase PS3AV_CMD_AUDIO_NUM_OF_CH_2:\n\t\tdefault:\n\t\t\taudio->audio_layout = PS3AV_CMD_AUDIO_LAYOUT_2CH;\n\t\t\tbreak;\n\t\t}\n\t} else {\n\t\taudio->audio_layout = PS3AV_CMD_AUDIO_LAYOUT_2CH;\n\t}\n\n\t \n\taudio->audio_downmix = PS3AV_CMD_AUDIO_DOWNMIX_PERMITTED;\n\t \n\taudio->audio_downmix_level = 0;\t \n\n\t \n\tfor (i = 0; i < 8; i++)\n\t\taudio->audio_cs_info[i] = ps3av_mode_cs_info[i];\n\n\tswitch (fs) {\n\tcase PS3AV_CMD_AUDIO_FS_44K:\n\t\taudio->audio_cs_info[3] &= ~CS_MASK;\n\t\taudio->audio_cs_info[3] |= CS_44;\n\t\tbreak;\n\tcase PS3AV_CMD_AUDIO_FS_88K:\n\t\taudio->audio_cs_info[3] &= ~CS_MASK;\n\t\taudio->audio_cs_info[3] |= CS_88;\n\t\tbreak;\n\tcase PS3AV_CMD_AUDIO_FS_96K:\n\t\taudio->audio_cs_info[3] &= ~CS_MASK;\n\t\taudio->audio_cs_info[3] |= CS_96;\n\t\tbreak;\n\tcase PS3AV_CMD_AUDIO_FS_176K:\n\t\taudio->audio_cs_info[3] &= ~CS_MASK;\n\t\taudio->audio_cs_info[3] |= CS_176;\n\t\tbreak;\n\tcase PS3AV_CMD_AUDIO_FS_192K:\n\t\taudio->audio_cs_info[3] &= ~CS_MASK;\n\t\taudio->audio_cs_info[3] |= CS_192;\n\t\tbreak;\n\tdefault:\n\t\tbreak;\n\t}\n\n\t \n\tspdif_through = audio->audio_cs_info[0] & 0x02;\n\n\t \n\tif (spdif_through &&\n\t    (avport == PS3AV_CMD_AVPORT_SPDIF_0 ||\n\t     avport == PS3AV_CMD_AVPORT_SPDIF_1 ||\n\t     avport == PS3AV_CMD_AVPORT_HDMI_0 ||\n\t     avport == PS3AV_CMD_AVPORT_HDMI_1)) {\n\t\taudio->audio_word_bits = PS3AV_CMD_AUDIO_WORD_BITS_16;\n\t\taudio->audio_format = PS3AV_CMD_AUDIO_FORMAT_BITSTREAM;\n\t}\n}\n\nint ps3av_cmd_audio_mode(struct ps3av_pkt_audio_mode *audio_mode)\n{\n\tint res;\n\n\tres = ps3av_do_pkt(PS3AV_CID_AUDIO_MODE, sizeof(*audio_mode),\n\t\t\t   sizeof(*audio_mode), &audio_mode->send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(audio_mode);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AUDIO_MODE: failed %x\\n\", res);\n\n\treturn res;\n}\n\nint ps3av_cmd_audio_mute(int num_of_port, u32 *port, u32 mute)\n{\n\tint i, res;\n\tstruct ps3av_pkt_audio_mute audio_mute;\n\n\tif (num_of_port > PS3AV_OPT_PORT_MAX)\n\t\treturn -EINVAL;\n\n\t \n\tmemset(&audio_mute, 0, sizeof(audio_mute));\n\tfor (i = 0; i < num_of_port; i++) {\n\t\taudio_mute.mute[i].avport = port[i];\n\t\taudio_mute.mute[i].mute = mute;\n\t}\n\n\tres = ps3av_do_pkt(PS3AV_CID_AUDIO_MUTE,\n\t\t\t   sizeof(audio_mute.send_hdr) +\n\t\t\t   sizeof(struct ps3av_audio_mute) * num_of_port,\n\t\t\t   sizeof(audio_mute), &audio_mute.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&audio_mute);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AUDIO_MUTE: failed %x\\n\", res);\n\n\treturn res;\n}\n\nint ps3av_cmd_audio_active(int active, u32 port)\n{\n\tint res;\n\tstruct ps3av_pkt_audio_active audio_active;\n\tu32 cid;\n\n\t \n\tmemset(&audio_active, 0, sizeof(audio_active));\n\taudio_active.audio_port = port;\n\tcid = active ? PS3AV_CID_AUDIO_ACTIVE : PS3AV_CID_AUDIO_INACTIVE;\n\n\tres = ps3av_do_pkt(cid, sizeof(audio_active), sizeof(audio_active),\n\t\t\t   &audio_active.send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(&audio_active);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AUDIO_ACTIVE:%x failed %x\\n\", cid,\n\t\t       res);\n\n\treturn res;\n}\n\nint ps3av_cmd_avb_param(struct ps3av_pkt_avb_param *avb, u32 send_len)\n{\n\tint res;\n\n\tmutex_lock(&ps3_gpu_mutex);\n\n\t \n\tres = ps3av_do_pkt(PS3AV_CID_AVB_PARAM, send_len, sizeof(*avb),\n\t\t\t   &avb->send_hdr);\n\tif (res < 0)\n\t\tgoto out;\n\n\tres = get_status(avb);\n\tif (res)\n\t\tpr_debug(\"%s: PS3AV_CID_AVB_PARAM: failed %x\\n\", __func__,\n\t\t\t res);\n\n      out:\n\tmutex_unlock(&ps3_gpu_mutex);\n\treturn res;\n}\n\nint ps3av_cmd_av_get_hw_conf(struct ps3av_pkt_av_get_hw_conf *hw_conf)\n{\n\tint res;\n\n\tmemset(hw_conf, 0, sizeof(*hw_conf));\n\n\tres = ps3av_do_pkt(PS3AV_CID_AV_GET_HW_CONF, sizeof(hw_conf->send_hdr),\n\t\t\t   sizeof(*hw_conf), &hw_conf->send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(hw_conf);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AV_GET_HW_CONF: failed %x\\n\", res);\n\n\treturn res;\n}\n\nint ps3av_cmd_video_get_monitor_info(struct ps3av_pkt_av_get_monitor_info *info,\n\t\t\t\t     u32 avport)\n{\n\tint res;\n\n\tmemset(info, 0, sizeof(*info));\n\tinfo->avport = avport;\n\n\tres = ps3av_do_pkt(PS3AV_CID_AV_GET_MONITOR_INFO,\n\t\t\t   sizeof(info->send_hdr) + sizeof(info->avport) +\n\t\t\t   sizeof(info->reserved),\n\t\t\t   sizeof(*info), &info->send_hdr);\n\tif (res < 0)\n\t\treturn res;\n\n\tres = get_status(info);\n\tif (res)\n\t\tprintk(KERN_ERR \"PS3AV_CID_AV_GET_MONITOR_INFO: failed %x\\n\",\n\t\t       res);\n\n\treturn res;\n}\n\n#define PS3AV_AV_LAYOUT_0 (PS3AV_CMD_AV_LAYOUT_32 \\\n\t\t| PS3AV_CMD_AV_LAYOUT_44 \\\n\t\t| PS3AV_CMD_AV_LAYOUT_48)\n\n#define PS3AV_AV_LAYOUT_1 (PS3AV_AV_LAYOUT_0 \\\n\t\t| PS3AV_CMD_AV_LAYOUT_88 \\\n\t\t| PS3AV_CMD_AV_LAYOUT_96 \\\n\t\t| PS3AV_CMD_AV_LAYOUT_176 \\\n\t\t| PS3AV_CMD_AV_LAYOUT_192)\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}