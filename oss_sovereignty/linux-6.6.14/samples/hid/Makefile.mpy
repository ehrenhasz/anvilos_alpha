{
  "module_name": "Makefile",
  "hash_id": "b6ca2cd0703a63537e01508c03ae20706118689ebf90ae6d85d11c1e866521eb",
  "original_prompt": "Ingested from linux-6.6.14/samples/hid/Makefile",
  "human_readable_source": "# SPDX-License-Identifier: GPL-2.0\n\nHID_SAMPLES_PATH ?= $(abspath $(srctree)/$(src))\nTOOLS_PATH := $(HID_SAMPLES_PATH)/../../tools\n\npound := \\#\n\n# List of programs to build\ntprogs-y += hid_mouse\ntprogs-y += hid_surface_dial\n\n# Libbpf dependencies\nLIBBPF_SRC = $(TOOLS_PATH)/lib/bpf\nLIBBPF_OUTPUT = $(abspath $(HID_SAMPLES_PATH))/libbpf\nLIBBPF_DESTDIR = $(LIBBPF_OUTPUT)\nLIBBPF_INCLUDE = $(LIBBPF_DESTDIR)/include\nLIBBPF = $(LIBBPF_OUTPUT)/libbpf.a\n\nEXTRA_HEADERS := hid_bpf_attach.h\nEXTRA_BPF_HEADERS := hid_bpf_helpers.h\n\nhid_mouse-objs := hid_mouse.o\nhid_surface_dial-objs := hid_surface_dial.o\n\n# Tell kbuild to always build the programs\nalways-y := $(tprogs-y)\n\nifeq ($(ARCH), arm)\n# Strip all except -D__LINUX_ARM_ARCH__ option needed to handle linux\n# headers when arm instruction set identification is requested.\nARM_ARCH_SELECTOR := $(filter -D__LINUX_ARM_ARCH__%, $(KBUILD_CFLAGS))\nBPF_EXTRA_CFLAGS := $(ARM_ARCH_SELECTOR)\nTPROGS_CFLAGS += $(ARM_ARCH_SELECTOR)\nendif\n\nifeq ($(ARCH), mips)\nTPROGS_CFLAGS += -D__SANE_USERSPACE_TYPES__\nifdef CONFIG_MACH_LOONGSON64\nBPF_EXTRA_CFLAGS += -I$(srctree)/arch/mips/include/asm/mach-loongson64\nBPF_EXTRA_CFLAGS += -I$(srctree)/arch/mips/include/asm/mach-generic\nendif\nendif\n\nTPROGS_CFLAGS += -Wall -O2\nTPROGS_CFLAGS += -Wmissing-prototypes\nTPROGS_CFLAGS += -Wstrict-prototypes\n\nTPROGS_CFLAGS += -I$(objtree)/usr/include\nTPROGS_CFLAGS += -I$(LIBBPF_INCLUDE)\nTPROGS_CFLAGS += -I$(srctree)/tools/include\n\nifdef SYSROOT\nTPROGS_CFLAGS += --sysroot=$(SYSROOT)\nTPROGS_LDFLAGS := -L$(SYSROOT)/usr/lib\nendif\n\nTPROGS_LDLIBS\t\t\t+= $(LIBBPF) -lelf -lz\n\n# Allows pointing LLC/CLANG to a LLVM backend with bpf support, redefine on cmdline:\n# make M=samples/bpf LLC=~/git/llvm-project/llvm/build/bin/llc CLANG=~/git/llvm-project/llvm/build/bin/clang\nLLC ?= llc\nCLANG ?= clang\nOPT ?= opt\nLLVM_DIS ?= llvm-dis\nLLVM_OBJCOPY ?= llvm-objcopy\nLLVM_READELF ?= llvm-readelf\nBTF_PAHOLE ?= pahole\n\n# Detect that we're cross compiling and use the cross compiler\nifdef CROSS_COMPILE\nCLANG_ARCH_ARGS = --target=$(notdir $(CROSS_COMPILE:%-=%))\nendif\n\n# Don't evaluate probes and warnings if we need to run make recursively\nifneq ($(src),)\nHDR_PROBE := $(shell printf \"$(pound)include <linux/types.h>\\n struct list_head { int a; }; int main() { return 0; }\" | \\\n\t$(CC) $(TPROGS_CFLAGS) $(TPROGS_LDFLAGS) -x c - \\\n\t-o /dev/null 2>/dev/null && echo okay)\n\nifeq ($(HDR_PROBE),)\n$(warning WARNING: Detected possible issues with include path.)\n$(warning WARNING: Please install kernel headers locally (make headers_install).)\nendif\n\nBTF_LLC_PROBE := $(shell $(LLC) -march=bpf -mattr=help 2>&1 | grep dwarfris)\nBTF_PAHOLE_PROBE := $(shell $(BTF_PAHOLE) --help 2>&1 | grep BTF)\nBTF_OBJCOPY_PROBE := $(shell $(LLVM_OBJCOPY) --help 2>&1 | grep -i 'usage.*llvm')\nBTF_LLVM_PROBE := $(shell echo \"int main() { return 0; }\" | \\\n\t\t\t  $(CLANG) --target=bpf -O2 -g -c -x c - -o ./llvm_btf_verify.o; \\\n\t\t\t  $(LLVM_READELF) -S ./llvm_btf_verify.o | grep BTF; \\\n\t\t\t  /bin/rm -f ./llvm_btf_verify.o)\n\nBPF_EXTRA_CFLAGS += -fno-stack-protector\nifneq ($(BTF_LLVM_PROBE),)\n\tBPF_EXTRA_CFLAGS += -g\nelse\nifneq ($(and $(BTF_LLC_PROBE),$(BTF_PAHOLE_PROBE),$(BTF_OBJCOPY_PROBE)),)\n\tBPF_EXTRA_CFLAGS += -g\n\tLLC_FLAGS += -mattr=dwarfris\n\tDWARF2BTF = y\nendif\nendif\nendif\n\n# Trick to allow make to be run from this directory\nall:\n\t$(MAKE) -C ../../ M=$(CURDIR) HID_SAMPLES_PATH=$(CURDIR)\n\nclean:\n\t$(MAKE) -C ../../ M=$(CURDIR) clean\n\t@find $(CURDIR) -type f -name '*~' -delete\n\t@$(RM) -r $(CURDIR)/libbpf $(CURDIR)/bpftool\n\n$(LIBBPF): $(wildcard $(LIBBPF_SRC)/*.[ch] $(LIBBPF_SRC)/Makefile) | $(LIBBPF_OUTPUT)\n# Fix up variables inherited from Kbuild that tools/ build system won't like\n\t$(MAKE) -C $(LIBBPF_SRC) RM='rm -rf' EXTRA_CFLAGS=\"$(TPROGS_CFLAGS)\" \\\n\t\tLDFLAGS=$(TPROGS_LDFLAGS) srctree=$(HID_SAMPLES_PATH)/../../ \\\n\t\tO= OUTPUT=$(LIBBPF_OUTPUT)/ DESTDIR=$(LIBBPF_DESTDIR) prefix= \\\n\t\t$@ install_headers\n\nBPFTOOLDIR := $(TOOLS_PATH)/bpf/bpftool\nBPFTOOL_OUTPUT := $(abspath $(HID_SAMPLES_PATH))/bpftool\nBPFTOOL := $(BPFTOOL_OUTPUT)/bootstrap/bpftool\n$(BPFTOOL): $(wildcard $(BPFTOOLDIR)/*.[ch] $(BPFTOOLDIR)/Makefile) | $(BPFTOOL_OUTPUT)\n\t$(MAKE) -C $(BPFTOOLDIR) srctree=$(HID_SAMPLES_PATH)/../../ \t\t\\\n\t\tOUTPUT=$(BPFTOOL_OUTPUT)/ bootstrap\n\n$(LIBBPF_OUTPUT) $(BPFTOOL_OUTPUT):\n\t$(call msg,MKDIR,$@)\n\t$(Q)mkdir -p $@\n\nFORCE:\n\n\n# Verify LLVM compiler tools are available and bpf target is supported by llc\n.PHONY: verify_cmds verify_target_bpf $(CLANG) $(LLC)\n\nverify_cmds: $(CLANG) $(LLC)\n\t@for TOOL in $^ ; do \\\n\t\tif ! (which -- \"$${TOOL}\" > /dev/null 2>&1); then \\\n\t\t\techo \"*** ERROR: Cannot find LLVM tool $${TOOL}\" ;\\\n\t\t\texit 1; \\\n\t\telse true; fi; \\\n\tdone\n\nverify_target_bpf: verify_cmds\n\t@if ! (${LLC} -march=bpf -mattr=help > /dev/null 2>&1); then \\\n\t\techo \"*** ERROR: LLVM (${LLC}) does not support 'bpf' target\" ;\\\n\t\techo \"   NOTICE: LLVM version >= 3.7.1 required\" ;\\\n\t\texit 2; \\\n\telse true; fi\n\n$(HID_SAMPLES_PATH)/*.c: verify_target_bpf $(LIBBPF)\n$(src)/*.c: verify_target_bpf $(LIBBPF)\n\nlibbpf_hdrs: $(LIBBPF)\n\n.PHONY: libbpf_hdrs\n\n$(obj)/hid_mouse.o: $(obj)/hid_mouse.skel.h\n$(obj)/hid_surface_dial.o: $(obj)/hid_surface_dial.skel.h\n\n-include $(HID_SAMPLES_PATH)/Makefile.target\n\nVMLINUX_BTF_PATHS ?= $(abspath $(if $(O),$(O)/vmlinux))\t\t\t\t\\\n\t\t     $(abspath $(if $(KBUILD_OUTPUT),$(KBUILD_OUTPUT)/vmlinux))\t\\\n\t\t     $(abspath ./vmlinux)\nVMLINUX_BTF ?= $(abspath $(firstword $(wildcard $(VMLINUX_BTF_PATHS))))\n\n$(obj)/vmlinux.h: $(VMLINUX_BTF) $(BPFTOOL)\nifeq ($(VMLINUX_H),)\nifeq ($(VMLINUX_BTF),)\n\t$(error Cannot find a vmlinux for VMLINUX_BTF at any of \"$(VMLINUX_BTF_PATHS)\",\\\n\t\tbuild the kernel or set VMLINUX_BTF or VMLINUX_H variable)\nendif\n\t$(Q)$(BPFTOOL) btf dump file $(VMLINUX_BTF) format c > $@\nelse\n\t$(Q)cp \"$(VMLINUX_H)\" $@\nendif\n\nclean-files += vmlinux.h\n\n# Get Clang's default includes on this system, as opposed to those seen by\n# '--target=bpf'. This fixes \"missing\" files on some architectures/distros,\n# such as asm/byteorder.h, asm/socket.h, asm/sockios.h, sys/cdefs.h etc.\n#\n# Use '-idirafter': Don't interfere with include mechanics except where the\n# build would have failed anyways.\ndefine get_sys_includes\n$(shell $(1) -v -E - </dev/null 2>&1 \\\n        | sed -n '/<...> search starts here:/,/End of search list./{ s| \\(/.*\\)|-idirafter \\1|p }') \\\n$(shell $(1) -dM -E - </dev/null | grep '#define __riscv_xlen ' | sed 's/#define /-D/' | sed 's/ /=/')\nendef\n\nCLANG_SYS_INCLUDES = $(call get_sys_includes,$(CLANG))\n\nEXTRA_BPF_HEADERS_SRC := $(addprefix $(src)/,$(EXTRA_BPF_HEADERS))\n\n$(obj)/%.bpf.o: $(src)/%.bpf.c $(EXTRA_BPF_HEADERS_SRC) $(obj)/vmlinux.h\n\t@echo \"  CLANG-BPF \" $@\n\t$(Q)$(CLANG) -g -O2 --target=bpf -D__TARGET_ARCH_$(SRCARCH) \\\n\t\t-Wno-compare-distinct-pointer-types -I$(srctree)/include \\\n\t\t-I$(srctree)/samples/bpf -I$(srctree)/tools/include \\\n\t\t-I$(LIBBPF_INCLUDE) $(CLANG_SYS_INCLUDES) \\\n\t\t-c $(filter %.bpf.c,$^) -o $@\n\nLINKED_SKELS := hid_mouse.skel.h hid_surface_dial.skel.h\nclean-files += $(LINKED_SKELS)\n\nhid_mouse.skel.h-deps := hid_mouse.bpf.o hid_bpf_attach.bpf.o\nhid_surface_dial.skel.h-deps := hid_surface_dial.bpf.o hid_bpf_attach.bpf.o\n\nLINKED_BPF_SRCS := $(patsubst %.bpf.o,%.bpf.c,$(foreach skel,$(LINKED_SKELS),$($(skel)-deps)))\n\nBPF_SRCS_LINKED := $(notdir $(wildcard $(src)/*.bpf.c))\nBPF_OBJS_LINKED := $(patsubst %.bpf.c,$(obj)/%.bpf.o, $(BPF_SRCS_LINKED))\nBPF_SKELS_LINKED := $(addprefix $(obj)/,$(LINKED_SKELS))\n\n$(BPF_SKELS_LINKED): $(BPF_OBJS_LINKED) $(BPFTOOL)\n\t@echo \"  BPF GEN-OBJ \" $(@:.skel.h=)\n\t$(Q)$(BPFTOOL) gen object $(@:.skel.h=.lbpf.o) $(addprefix $(obj)/,$($(@F)-deps))\n\t@echo \"  BPF GEN-SKEL\" $(@:.skel.h=)\n\t$(Q)$(BPFTOOL) gen skeleton $(@:.skel.h=.lbpf.o) name $(notdir $(@:.skel.h=)) > $@\n\n# asm/sysreg.h - inline assembly used by it is incompatible with llvm.\n# But, there is no easy way to fix it, so just exclude it since it is\n# useless for BPF samples.\n# below we use long chain of commands, clang | opt | llvm-dis | llc,\n# to generate final object file. 'clang' compiles the source into IR\n# with native target, e.g., x64, arm64, etc. 'opt' does bpf CORE IR builtin\n# processing (llvm12) and IR optimizations. 'llvm-dis' converts\n# 'opt' output to IR, and finally 'llc' generates bpf byte code.\n$(obj)/%.o: $(src)/%.c\n\t@echo \"  CLANG-bpf \" $@\n\t$(Q)$(CLANG) $(NOSTDINC_FLAGS) $(LINUXINCLUDE) $(BPF_EXTRA_CFLAGS) \\\n\t\t-I$(obj) -I$(srctree)/tools/testing/selftests/bpf/ \\\n\t\t-I$(LIBBPF_INCLUDE) \\\n\t\t-D__KERNEL__ -D__BPF_TRACING__ -Wno-unused-value -Wno-pointer-sign \\\n\t\t-D__TARGET_ARCH_$(SRCARCH) -Wno-compare-distinct-pointer-types \\\n\t\t-Wno-gnu-variable-sized-type-not-at-end \\\n\t\t-Wno-address-of-packed-member -Wno-tautological-compare \\\n\t\t-Wno-unknown-warning-option $(CLANG_ARCH_ARGS) \\\n\t\t-fno-asynchronous-unwind-tables \\\n\t\t-I$(srctree)/samples/hid/ \\\n\t\t-O2 -emit-llvm -Xclang -disable-llvm-passes -c $< -o - | \\\n\t\t$(OPT) -O2 -mtriple=bpf-pc-linux | $(LLVM_DIS) | \\\n\t\t$(LLC) -march=bpf $(LLC_FLAGS) -filetype=obj -o $@\nifeq ($(DWARF2BTF),y)\n\t$(BTF_PAHOLE) -J $@\nendif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}