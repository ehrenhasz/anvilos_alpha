{
  "module_name": "ftrace-direct-multi-modify.c",
  "hash_id": "53f662f5571566437bfc0f93689f8194f92892703d1fff974dd4d4da664ca528",
  "original_prompt": "Ingested from linux-6.6.14/samples/ftrace/ftrace-direct-multi-modify.c",
  "human_readable_source": "\n#include <linux/module.h>\n#include <linux/kthread.h>\n#include <linux/ftrace.h>\n#ifndef CONFIG_ARM64\n#include <asm/asm-offsets.h>\n#endif\n\nextern void my_direct_func1(unsigned long ip);\nextern void my_direct_func2(unsigned long ip);\n\nvoid my_direct_func1(unsigned long ip)\n{\n\ttrace_printk(\"my direct func1 ip %lx\\n\", ip);\n}\n\nvoid my_direct_func2(unsigned long ip)\n{\n\ttrace_printk(\"my direct func2 ip %lx\\n\", ip);\n}\n\nextern void my_tramp1(void *);\nextern void my_tramp2(void *);\n\n#ifdef CONFIG_X86_64\n\n#include <asm/ibt.h>\n#include <asm/nospec-branch.h>\n\nasm (\n\"\t.pushsection    .text, \\\"ax\\\", @progbits\\n\"\n\"\t.type\t\tmy_tramp1, @function\\n\"\n\"\t.globl\t\tmy_tramp1\\n\"\n\"   my_tramp1:\"\n\tASM_ENDBR\n\"\tpushq %rbp\\n\"\n\"\tmovq %rsp, %rbp\\n\"\n\tCALL_DEPTH_ACCOUNT\n\"\tpushq %rdi\\n\"\n\"\tmovq 8(%rbp), %rdi\\n\"\n\"\tcall my_direct_func1\\n\"\n\"\tpopq %rdi\\n\"\n\"\tleave\\n\"\n\tASM_RET\n\"\t.size\t\tmy_tramp1, .-my_tramp1\\n\"\n\n\"\t.type\t\tmy_tramp2, @function\\n\"\n\"\t.globl\t\tmy_tramp2\\n\"\n\"   my_tramp2:\"\n\tASM_ENDBR\n\"\tpushq %rbp\\n\"\n\"\tmovq %rsp, %rbp\\n\"\n\tCALL_DEPTH_ACCOUNT\n\"\tpushq %rdi\\n\"\n\"\tmovq 8(%rbp), %rdi\\n\"\n\"\tcall my_direct_func2\\n\"\n\"\tpopq %rdi\\n\"\n\"\tleave\\n\"\n\tASM_RET\n\"\t.size\t\tmy_tramp2, .-my_tramp2\\n\"\n\"\t.popsection\\n\"\n);\n\n#endif  \n\n#ifdef CONFIG_S390\n\nasm (\n\"       .pushsection    .text, \\\"ax\\\", @progbits\\n\"\n\"       .type           my_tramp1, @function\\n\"\n\"       .globl          my_tramp1\\n\"\n\"   my_tramp1:\"\n\"       lgr             %r1,%r15\\n\"\n\"       stmg            %r0,%r5,\"__stringify(__SF_GPRS)\"(%r15)\\n\"\n\"       stg             %r14,\"__stringify(__SF_GPRS+8*8)\"(%r15)\\n\"\n\"       aghi            %r15,\"__stringify(-STACK_FRAME_OVERHEAD)\"\\n\"\n\"       stg             %r1,\"__stringify(__SF_BACKCHAIN)\"(%r15)\\n\"\n\"       lgr             %r2,%r0\\n\"\n\"       brasl           %r14,my_direct_func1\\n\"\n\"       aghi            %r15,\"__stringify(STACK_FRAME_OVERHEAD)\"\\n\"\n\"       lmg             %r0,%r5,\"__stringify(__SF_GPRS)\"(%r15)\\n\"\n\"       lg              %r14,\"__stringify(__SF_GPRS+8*8)\"(%r15)\\n\"\n\"       lgr             %r1,%r0\\n\"\n\"       br              %r1\\n\"\n\"       .size           my_tramp1, .-my_tramp1\\n\"\n\"\\n\"\n\"       .type           my_tramp2, @function\\n\"\n\"       .globl          my_tramp2\\n\"\n\"   my_tramp2:\"\n\"       lgr             %r1,%r15\\n\"\n\"       stmg            %r0,%r5,\"__stringify(__SF_GPRS)\"(%r15)\\n\"\n\"       stg             %r14,\"__stringify(__SF_GPRS+8*8)\"(%r15)\\n\"\n\"       aghi            %r15,\"__stringify(-STACK_FRAME_OVERHEAD)\"\\n\"\n\"       stg             %r1,\"__stringify(__SF_BACKCHAIN)\"(%r15)\\n\"\n\"       lgr             %r2,%r0\\n\"\n\"       brasl           %r14,my_direct_func2\\n\"\n\"       aghi            %r15,\"__stringify(STACK_FRAME_OVERHEAD)\"\\n\"\n\"       lmg             %r0,%r5,\"__stringify(__SF_GPRS)\"(%r15)\\n\"\n\"       lg              %r14,\"__stringify(__SF_GPRS+8*8)\"(%r15)\\n\"\n\"       lgr             %r1,%r0\\n\"\n\"       br              %r1\\n\"\n\"       .size           my_tramp2, .-my_tramp2\\n\"\n\"       .popsection\\n\"\n);\n\n#endif  \n\n#ifdef CONFIG_ARM64\n\nasm (\n\"\t.pushsection    .text, \\\"ax\\\", @progbits\\n\"\n\"\t.type\t\tmy_tramp1, @function\\n\"\n\"\t.globl\t\tmy_tramp1\\n\"\n\"   my_tramp1:\"\n\"\thint\t34\\n\" \n\"\tsub\tsp, sp, #32\\n\"\n\"\tstp\tx9, x30, [sp]\\n\"\n\"\tstr\tx0, [sp, #16]\\n\"\n\"\tmov\tx0, x30\\n\"\n\"\tbl\tmy_direct_func1\\n\"\n\"\tldp\tx30, x9, [sp]\\n\"\n\"\tldr\tx0, [sp, #16]\\n\"\n\"\tadd\tsp, sp, #32\\n\"\n\"\tret\tx9\\n\"\n\"\t.size\t\tmy_tramp1, .-my_tramp1\\n\"\n\n\"\t.type\t\tmy_tramp2, @function\\n\"\n\"\t.globl\t\tmy_tramp2\\n\"\n\"   my_tramp2:\"\n\"\thint\t34\\n\" \n\"\tsub\tsp, sp, #32\\n\"\n\"\tstp\tx9, x30, [sp]\\n\"\n\"\tstr\tx0, [sp, #16]\\n\"\n\"\tmov\tx0, x30\\n\"\n\"\tbl\tmy_direct_func2\\n\"\n\"\tldp\tx30, x9, [sp]\\n\"\n\"\tldr\tx0, [sp, #16]\\n\"\n\"\tadd\tsp, sp, #32\\n\"\n\"\tret\tx9\\n\"\n\"\t.size\t\tmy_tramp2, .-my_tramp2\\n\"\n\"\t.popsection\\n\"\n);\n\n#endif  \n\n#ifdef CONFIG_LOONGARCH\n#include <asm/asm.h>\n\nasm (\n\"\t.pushsection    .text, \\\"ax\\\", @progbits\\n\"\n\"\t.type\t\tmy_tramp1, @function\\n\"\n\"\t.globl\t\tmy_tramp1\\n\"\n\"   my_tramp1:\\n\"\n\"\taddi.d\t$sp, $sp, -32\\n\"\n\"\tst.d\t$a0, $sp, 0\\n\"\n\"\tst.d\t$t0, $sp, 8\\n\"\n\"\tst.d\t$ra, $sp, 16\\n\"\n\"\tmove\t$a0, $t0\\n\"\n\"\tbl\tmy_direct_func1\\n\"\n\"\tld.d\t$a0, $sp, 0\\n\"\n\"\tld.d\t$t0, $sp, 8\\n\"\n\"\tld.d\t$ra, $sp, 16\\n\"\n\"\taddi.d\t$sp, $sp, 32\\n\"\n\"\tjr\t$t0\\n\"\n\"\t.size\t\tmy_tramp1, .-my_tramp1\\n\"\n\n\"\t.type\t\tmy_tramp2, @function\\n\"\n\"\t.globl\t\tmy_tramp2\\n\"\n\"   my_tramp2:\\n\"\n\"\taddi.d\t$sp, $sp, -32\\n\"\n\"\tst.d\t$a0, $sp, 0\\n\"\n\"\tst.d\t$t0, $sp, 8\\n\"\n\"\tst.d\t$ra, $sp, 16\\n\"\n\"\tmove\t$a0, $t0\\n\"\n\"\tbl\tmy_direct_func2\\n\"\n\"\tld.d\t$a0, $sp, 0\\n\"\n\"\tld.d\t$t0, $sp, 8\\n\"\n\"\tld.d\t$ra, $sp, 16\\n\"\n\"\taddi.d\t$sp, $sp, 32\\n\"\n\"\tjr\t$t0\\n\"\n\"\t.size\t\tmy_tramp2, .-my_tramp2\\n\"\n\"\t.popsection\\n\"\n);\n\n#endif  \n\nstatic unsigned long my_tramp = (unsigned long)my_tramp1;\nstatic unsigned long tramps[2] = {\n\t(unsigned long)my_tramp1,\n\t(unsigned long)my_tramp2,\n};\n\nstatic struct ftrace_ops direct;\n\nstatic int simple_thread(void *arg)\n{\n\tstatic int t;\n\tint ret = 0;\n\n\twhile (!kthread_should_stop()) {\n\t\tset_current_state(TASK_INTERRUPTIBLE);\n\t\tschedule_timeout(2 * HZ);\n\n\t\tif (ret)\n\t\t\tcontinue;\n\t\tt ^= 1;\n\t\tret = modify_ftrace_direct(&direct, tramps[t]);\n\t\tif (!ret)\n\t\t\tmy_tramp = tramps[t];\n\t\tWARN_ON_ONCE(ret);\n\t}\n\n\treturn 0;\n}\n\nstatic struct task_struct *simple_tsk;\n\nstatic int __init ftrace_direct_multi_init(void)\n{\n\tint ret;\n\n\tftrace_set_filter_ip(&direct, (unsigned long) wake_up_process, 0, 0);\n\tftrace_set_filter_ip(&direct, (unsigned long) schedule, 0, 0);\n\n\tret = register_ftrace_direct(&direct, my_tramp);\n\n\tif (!ret)\n\t\tsimple_tsk = kthread_run(simple_thread, NULL, \"event-sample-fn\");\n\treturn ret;\n}\n\nstatic void __exit ftrace_direct_multi_exit(void)\n{\n\tkthread_stop(simple_tsk);\n\tunregister_ftrace_direct(&direct, my_tramp, true);\n}\n\nmodule_init(ftrace_direct_multi_init);\nmodule_exit(ftrace_direct_multi_exit);\n\nMODULE_AUTHOR(\"Jiri Olsa\");\nMODULE_DESCRIPTION(\"Example use case of using modify_ftrace_direct()\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}