{
  "module_name": "ftrace-direct.c",
  "hash_id": "909d1da3d589b8ddb6b6dcd863115053e189aa5828648234671486c45a455a61",
  "original_prompt": "Ingested from linux-6.6.14/samples/ftrace/ftrace-direct.c",
  "human_readable_source": "\n#include <linux/module.h>\n\n#include <linux/sched.h>  \n#include <linux/ftrace.h>\n#ifndef CONFIG_ARM64\n#include <asm/asm-offsets.h>\n#endif\n\nextern void my_direct_func(struct task_struct *p);\n\nvoid my_direct_func(struct task_struct *p)\n{\n\ttrace_printk(\"waking up %s-%d\\n\", p->comm, p->pid);\n}\n\nextern void my_tramp(void *);\n\n#ifdef CONFIG_X86_64\n\n#include <asm/ibt.h>\n#include <asm/nospec-branch.h>\n\nasm (\n\"\t.pushsection    .text, \\\"ax\\\", @progbits\\n\"\n\"\t.type\t\tmy_tramp, @function\\n\"\n\"\t.globl\t\tmy_tramp\\n\"\n\"   my_tramp:\"\n\tASM_ENDBR\n\"\tpushq %rbp\\n\"\n\"\tmovq %rsp, %rbp\\n\"\n\tCALL_DEPTH_ACCOUNT\n\"\tpushq %rdi\\n\"\n\"\tcall my_direct_func\\n\"\n\"\tpopq %rdi\\n\"\n\"\tleave\\n\"\n\tASM_RET\n\"\t.size\t\tmy_tramp, .-my_tramp\\n\"\n\"\t.popsection\\n\"\n);\n\n#endif  \n\n#ifdef CONFIG_S390\n\nasm (\n\"\t.pushsection\t.text, \\\"ax\\\", @progbits\\n\"\n\"\t.type\t\tmy_tramp, @function\\n\"\n\"\t.globl\t\tmy_tramp\\n\"\n\"   my_tramp:\"\n\"\tlgr\t\t%r1,%r15\\n\"\n\"\tstmg\t\t%r0,%r5,\"__stringify(__SF_GPRS)\"(%r15)\\n\"\n\"\tstg\t\t%r14,\"__stringify(__SF_GPRS+8*8)\"(%r15)\\n\"\n\"\taghi\t\t%r15,\"__stringify(-STACK_FRAME_OVERHEAD)\"\\n\"\n\"\tstg\t\t%r1,\"__stringify(__SF_BACKCHAIN)\"(%r15)\\n\"\n\"\tbrasl\t\t%r14,my_direct_func\\n\"\n\"\taghi\t\t%r15,\"__stringify(STACK_FRAME_OVERHEAD)\"\\n\"\n\"\tlmg\t\t%r0,%r5,\"__stringify(__SF_GPRS)\"(%r15)\\n\"\n\"\tlg\t\t%r14,\"__stringify(__SF_GPRS+8*8)\"(%r15)\\n\"\n\"\tlgr\t\t%r1,%r0\\n\"\n\"\tbr\t\t%r1\\n\"\n\"\t.size\t\tmy_tramp, .-my_tramp\\n\"\n\"\t.popsection\\n\"\n);\n\n#endif  \n\n#ifdef CONFIG_ARM64\n\nasm (\n\"\t.pushsection\t.text, \\\"ax\\\", @progbits\\n\"\n\"\t.type\t\tmy_tramp, @function\\n\"\n\"\t.globl\t\tmy_tramp\\n\"\n\"   my_tramp:\"\n\"\thint\t34\\n\" \n\"\tsub\tsp, sp, #32\\n\"\n\"\tstp\tx9, x30, [sp]\\n\"\n\"\tstr\tx0, [sp, #16]\\n\"\n\"\tbl\tmy_direct_func\\n\"\n\"\tldp\tx30, x9, [sp]\\n\"\n\"\tldr\tx0, [sp, #16]\\n\"\n\"\tadd\tsp, sp, #32\\n\"\n\"\tret\tx9\\n\"\n\"\t.size\t\tmy_tramp, .-my_tramp\\n\"\n\"\t.popsection\\n\"\n);\n\n#endif  \n\n#ifdef CONFIG_LOONGARCH\n\nasm (\n\"\t.pushsection\t.text, \\\"ax\\\", @progbits\\n\"\n\"\t.type\t\tmy_tramp, @function\\n\"\n\"\t.globl\t\tmy_tramp\\n\"\n\"   my_tramp:\\n\"\n\"\taddi.d\t$sp, $sp, -32\\n\"\n\"\tst.d\t$a0, $sp, 0\\n\"\n\"\tst.d\t$t0, $sp, 8\\n\"\n\"\tst.d\t$ra, $sp, 16\\n\"\n\"\tbl\tmy_direct_func\\n\"\n\"\tld.d\t$a0, $sp, 0\\n\"\n\"\tld.d\t$t0, $sp, 8\\n\"\n\"\tld.d\t$ra, $sp, 16\\n\"\n\"\taddi.d\t$sp, $sp, 32\\n\"\n\"\tjr\t$t0\\n\"\n\"\t.size\t\tmy_tramp, .-my_tramp\\n\"\n\"\t.popsection\\n\"\n);\n\n#endif  \n\nstatic struct ftrace_ops direct;\n\nstatic int __init ftrace_direct_init(void)\n{\n\tftrace_set_filter_ip(&direct, (unsigned long) wake_up_process, 0, 0);\n\n\treturn register_ftrace_direct(&direct, (unsigned long) my_tramp);\n}\n\nstatic void __exit ftrace_direct_exit(void)\n{\n\tunregister_ftrace_direct(&direct, (unsigned long)my_tramp, true);\n}\n\nmodule_init(ftrace_direct_init);\nmodule_exit(ftrace_direct_exit);\n\nMODULE_AUTHOR(\"Steven Rostedt\");\nMODULE_DESCRIPTION(\"Example use case of using register_ftrace_direct()\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}