{
  "module_name": "bytestream-example.c",
  "hash_id": "4180ad0373a864be1b2f743653385db9d5c4e1f3448433d94c33fe026447c913",
  "original_prompt": "Ingested from linux-6.6.14/samples/kfifo/bytestream-example.c",
  "human_readable_source": "\n \n\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/proc_fs.h>\n#include <linux/mutex.h>\n#include <linux/kfifo.h>\n\n \n\n \n#define FIFO_SIZE\t32\n\n \n#define\tPROC_FIFO\t\"bytestream-fifo\"\n\n \nstatic DEFINE_MUTEX(read_access);\n\n \nstatic DEFINE_MUTEX(write_access);\n\n \n#if 0\n#define DYNAMIC\n#endif\n\n#ifdef DYNAMIC\nstatic struct kfifo test;\n#else\nstatic DECLARE_KFIFO(test, unsigned char, FIFO_SIZE);\n#endif\n\nstatic const unsigned char expected_result[FIFO_SIZE] = {\n\t 3,  4,  5,  6,  7,  8,  9,  0,\n\t 1, 20, 21, 22, 23, 24, 25, 26,\n\t27, 28, 29, 30, 31, 32, 33, 34,\n\t35, 36, 37, 38, 39, 40, 41, 42,\n};\n\nstatic int __init testfunc(void)\n{\n\tunsigned char\tbuf[6];\n\tunsigned char\ti, j;\n\tunsigned int\tret;\n\n\tprintk(KERN_INFO \"byte stream fifo test start\\n\");\n\n\t \n\tkfifo_in(&test, \"hello\", 5);\n\n\t \n\tfor (i = 0; i != 10; i++)\n\t\tkfifo_put(&test, i);\n\n\t \n\tprintk(KERN_INFO \"fifo len: %u\\n\", kfifo_len(&test));\n\n\t \n\ti = kfifo_out(&test, buf, 5);\n\tprintk(KERN_INFO \"buf: %.*s\\n\", i, buf);\n\n\t \n\tret = kfifo_out(&test, buf, 2);\n\tprintk(KERN_INFO \"ret: %d\\n\", ret);\n\t \n\tret = kfifo_in(&test, buf, ret);\n\tprintk(KERN_INFO \"ret: %d\\n\", ret);\n\n\t \n\tprintk(KERN_INFO \"skip 1st element\\n\");\n\tkfifo_skip(&test);\n\n\t \n\tfor (i = 20; kfifo_put(&test, i); i++)\n\t\t;\n\n\tprintk(KERN_INFO \"queue len: %u\\n\", kfifo_len(&test));\n\n\t \n\tif (kfifo_peek(&test, &i))\n\t\tprintk(KERN_INFO \"%d\\n\", i);\n\n\t \n\tj = 0;\n\twhile (kfifo_get(&test, &i)) {\n\t\tprintk(KERN_INFO \"item = %d\\n\", i);\n\t\tif (i != expected_result[j++]) {\n\t\t\tprintk(KERN_WARNING \"value mismatch: test failed\\n\");\n\t\t\treturn -EIO;\n\t\t}\n\t}\n\tif (j != ARRAY_SIZE(expected_result)) {\n\t\tprintk(KERN_WARNING \"size mismatch: test failed\\n\");\n\t\treturn -EIO;\n\t}\n\tprintk(KERN_INFO \"test passed\\n\");\n\n\treturn 0;\n}\n\nstatic ssize_t fifo_write(struct file *file, const char __user *buf,\n\t\t\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tint ret;\n\tunsigned int copied;\n\n\tif (mutex_lock_interruptible(&write_access))\n\t\treturn -ERESTARTSYS;\n\n\tret = kfifo_from_user(&test, buf, count, &copied);\n\n\tmutex_unlock(&write_access);\n\tif (ret)\n\t\treturn ret;\n\n\treturn copied;\n}\n\nstatic ssize_t fifo_read(struct file *file, char __user *buf,\n\t\t\t\t\t\tsize_t count, loff_t *ppos)\n{\n\tint ret;\n\tunsigned int copied;\n\n\tif (mutex_lock_interruptible(&read_access))\n\t\treturn -ERESTARTSYS;\n\n\tret = kfifo_to_user(&test, buf, count, &copied);\n\n\tmutex_unlock(&read_access);\n\tif (ret)\n\t\treturn ret;\n\n\treturn copied;\n}\n\nstatic const struct proc_ops fifo_proc_ops = {\n\t.proc_read\t= fifo_read,\n\t.proc_write\t= fifo_write,\n\t.proc_lseek\t= noop_llseek,\n};\n\nstatic int __init example_init(void)\n{\n#ifdef DYNAMIC\n\tint ret;\n\n\tret = kfifo_alloc(&test, FIFO_SIZE, GFP_KERNEL);\n\tif (ret) {\n\t\tprintk(KERN_ERR \"error kfifo_alloc\\n\");\n\t\treturn ret;\n\t}\n#else\n\tINIT_KFIFO(test);\n#endif\n\tif (testfunc() < 0) {\n#ifdef DYNAMIC\n\t\tkfifo_free(&test);\n#endif\n\t\treturn -EIO;\n\t}\n\n\tif (proc_create(PROC_FIFO, 0, NULL, &fifo_proc_ops) == NULL) {\n#ifdef DYNAMIC\n\t\tkfifo_free(&test);\n#endif\n\t\treturn -ENOMEM;\n\t}\n\treturn 0;\n}\n\nstatic void __exit example_exit(void)\n{\n\tremove_proc_entry(PROC_FIFO, NULL);\n#ifdef DYNAMIC\n\tkfifo_free(&test);\n#endif\n}\n\nmodule_init(example_init);\nmodule_exit(example_exit);\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Stefani Seibold <stefani@seibold.net>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}