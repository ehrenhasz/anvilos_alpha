{
  "module_name": "livepatch-shadow-fix2.c",
  "hash_id": "8bfe019948b71fea6ad015f72e161660b0aeb22aaf87c369ddca20d3de5f9052",
  "original_prompt": "Ingested from linux-6.6.14/samples/livepatch/livepatch-shadow-fix2.c",
  "human_readable_source": "\n \n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/module.h>\n#include <linux/kernel.h>\n#include <linux/livepatch.h>\n#include <linux/slab.h>\n\n \n#define SV_LEAK\t\t1\n#define SV_COUNTER\t2\n\nstruct dummy {\n\tstruct list_head list;\n\tunsigned long jiffies_expire;\n};\n\nstatic bool livepatch_fix2_dummy_check(struct dummy *d, unsigned long jiffies)\n{\n\tint *shadow_count;\n\n\t \n\tshadow_count = klp_shadow_get_or_alloc(d, SV_COUNTER,\n\t\t\t\tsizeof(*shadow_count), GFP_NOWAIT,\n\t\t\t\tNULL, NULL);\n\tif (shadow_count)\n\t\t*shadow_count += 1;\n\n\treturn time_after(jiffies, d->jiffies_expire);\n}\n\nstatic void livepatch_fix2_dummy_leak_dtor(void *obj, void *shadow_data)\n{\n\tvoid *d = obj;\n\tint **shadow_leak = shadow_data;\n\n\tpr_info(\"%s: dummy @ %p, prevented leak @ %p\\n\",\n\t\t\t __func__, d, *shadow_leak);\n\tkfree(*shadow_leak);\n}\n\nstatic void livepatch_fix2_dummy_free(struct dummy *d)\n{\n\tint **shadow_leak;\n\tint *shadow_count;\n\n\t \n\tshadow_leak = klp_shadow_get(d, SV_LEAK);\n\tif (shadow_leak)\n\t\tklp_shadow_free(d, SV_LEAK, livepatch_fix2_dummy_leak_dtor);\n\telse\n\t\tpr_info(\"%s: dummy @ %p leaked!\\n\", __func__, d);\n\n\t \n\tshadow_count = klp_shadow_get(d, SV_COUNTER);\n\tif (shadow_count) {\n\t\tpr_info(\"%s: dummy @ %p, check counter = %d\\n\",\n\t\t\t__func__, d, *shadow_count);\n\t\tklp_shadow_free(d, SV_COUNTER, NULL);\n\t}\n\n\tkfree(d);\n}\n\nstatic struct klp_func funcs[] = {\n\t{\n\t\t.old_name = \"dummy_check\",\n\t\t.new_func = livepatch_fix2_dummy_check,\n\t},\n\t{\n\t\t.old_name = \"dummy_free\",\n\t\t.new_func = livepatch_fix2_dummy_free,\n\t}, { }\n};\n\nstatic struct klp_object objs[] = {\n\t{\n\t\t.name = \"livepatch_shadow_mod\",\n\t\t.funcs = funcs,\n\t}, { }\n};\n\nstatic struct klp_patch patch = {\n\t.mod = THIS_MODULE,\n\t.objs = objs,\n};\n\nstatic int livepatch_shadow_fix2_init(void)\n{\n\treturn klp_enable_patch(&patch);\n}\n\nstatic void livepatch_shadow_fix2_exit(void)\n{\n\t \n\tklp_shadow_free_all(SV_COUNTER, NULL);\n}\n\nmodule_init(livepatch_shadow_fix2_init);\nmodule_exit(livepatch_shadow_fix2_exit);\nMODULE_LICENSE(\"GPL\");\nMODULE_INFO(livepatch, \"Y\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}