{
  "module_name": "kset-example.c",
  "hash_id": "322466d9ee36d9df0bdb7f7fd1f15b78c03522e6d66984de047ebd0212f21d82",
  "original_prompt": "Ingested from linux-6.6.14/samples/kobject/kset-example.c",
  "human_readable_source": "\n \n#include <linux/kobject.h>\n#include <linux/string.h>\n#include <linux/sysfs.h>\n#include <linux/slab.h>\n#include <linux/module.h>\n#include <linux/init.h>\n\n \n\n\n \nstruct foo_obj {\n\tstruct kobject kobj;\n\tint foo;\n\tint baz;\n\tint bar;\n};\n#define to_foo_obj(x) container_of(x, struct foo_obj, kobj)\n\n \nstruct foo_attribute {\n\tstruct attribute attr;\n\tssize_t (*show)(struct foo_obj *foo, struct foo_attribute *attr, char *buf);\n\tssize_t (*store)(struct foo_obj *foo, struct foo_attribute *attr, const char *buf, size_t count);\n};\n#define to_foo_attr(x) container_of(x, struct foo_attribute, attr)\n\n \nstatic ssize_t foo_attr_show(struct kobject *kobj,\n\t\t\t     struct attribute *attr,\n\t\t\t     char *buf)\n{\n\tstruct foo_attribute *attribute;\n\tstruct foo_obj *foo;\n\n\tattribute = to_foo_attr(attr);\n\tfoo = to_foo_obj(kobj);\n\n\tif (!attribute->show)\n\t\treturn -EIO;\n\n\treturn attribute->show(foo, attribute, buf);\n}\n\n \nstatic ssize_t foo_attr_store(struct kobject *kobj,\n\t\t\t      struct attribute *attr,\n\t\t\t      const char *buf, size_t len)\n{\n\tstruct foo_attribute *attribute;\n\tstruct foo_obj *foo;\n\n\tattribute = to_foo_attr(attr);\n\tfoo = to_foo_obj(kobj);\n\n\tif (!attribute->store)\n\t\treturn -EIO;\n\n\treturn attribute->store(foo, attribute, buf, len);\n}\n\n \nstatic const struct sysfs_ops foo_sysfs_ops = {\n\t.show = foo_attr_show,\n\t.store = foo_attr_store,\n};\n\n \nstatic void foo_release(struct kobject *kobj)\n{\n\tstruct foo_obj *foo;\n\n\tfoo = to_foo_obj(kobj);\n\tkfree(foo);\n}\n\n \nstatic ssize_t foo_show(struct foo_obj *foo_obj, struct foo_attribute *attr,\n\t\t\tchar *buf)\n{\n\treturn sysfs_emit(buf, \"%d\\n\", foo_obj->foo);\n}\n\nstatic ssize_t foo_store(struct foo_obj *foo_obj, struct foo_attribute *attr,\n\t\t\t const char *buf, size_t count)\n{\n\tint ret;\n\n\tret = kstrtoint(buf, 10, &foo_obj->foo);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn count;\n}\n\n \nstatic struct foo_attribute foo_attribute =\n\t__ATTR(foo, 0664, foo_show, foo_store);\n\n \nstatic ssize_t b_show(struct foo_obj *foo_obj, struct foo_attribute *attr,\n\t\t      char *buf)\n{\n\tint var;\n\n\tif (strcmp(attr->attr.name, \"baz\") == 0)\n\t\tvar = foo_obj->baz;\n\telse\n\t\tvar = foo_obj->bar;\n\treturn sysfs_emit(buf, \"%d\\n\", var);\n}\n\nstatic ssize_t b_store(struct foo_obj *foo_obj, struct foo_attribute *attr,\n\t\t       const char *buf, size_t count)\n{\n\tint var, ret;\n\n\tret = kstrtoint(buf, 10, &var);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tif (strcmp(attr->attr.name, \"baz\") == 0)\n\t\tfoo_obj->baz = var;\n\telse\n\t\tfoo_obj->bar = var;\n\treturn count;\n}\n\nstatic struct foo_attribute baz_attribute =\n\t__ATTR(baz, 0664, b_show, b_store);\nstatic struct foo_attribute bar_attribute =\n\t__ATTR(bar, 0664, b_show, b_store);\n\n \nstatic struct attribute *foo_default_attrs[] = {\n\t&foo_attribute.attr,\n\t&baz_attribute.attr,\n\t&bar_attribute.attr,\n\tNULL,\t \n};\nATTRIBUTE_GROUPS(foo_default);\n\n \nstatic const struct kobj_type foo_ktype = {\n\t.sysfs_ops = &foo_sysfs_ops,\n\t.release = foo_release,\n\t.default_groups = foo_default_groups,\n};\n\nstatic struct kset *example_kset;\nstatic struct foo_obj *foo_obj;\nstatic struct foo_obj *bar_obj;\nstatic struct foo_obj *baz_obj;\n\nstatic struct foo_obj *create_foo_obj(const char *name)\n{\n\tstruct foo_obj *foo;\n\tint retval;\n\n\t \n\tfoo = kzalloc(sizeof(*foo), GFP_KERNEL);\n\tif (!foo)\n\t\treturn NULL;\n\n\t \n\tfoo->kobj.kset = example_kset;\n\n\t \n\tretval = kobject_init_and_add(&foo->kobj, &foo_ktype, NULL, \"%s\", name);\n\tif (retval) {\n\t\tkobject_put(&foo->kobj);\n\t\treturn NULL;\n\t}\n\n\t \n\tkobject_uevent(&foo->kobj, KOBJ_ADD);\n\n\treturn foo;\n}\n\nstatic void destroy_foo_obj(struct foo_obj *foo)\n{\n\tkobject_put(&foo->kobj);\n}\n\nstatic int __init example_init(void)\n{\n\t \n\texample_kset = kset_create_and_add(\"kset_example\", NULL, kernel_kobj);\n\tif (!example_kset)\n\t\treturn -ENOMEM;\n\n\t \n\tfoo_obj = create_foo_obj(\"foo\");\n\tif (!foo_obj)\n\t\tgoto foo_error;\n\n\tbar_obj = create_foo_obj(\"bar\");\n\tif (!bar_obj)\n\t\tgoto bar_error;\n\n\tbaz_obj = create_foo_obj(\"baz\");\n\tif (!baz_obj)\n\t\tgoto baz_error;\n\n\treturn 0;\n\nbaz_error:\n\tdestroy_foo_obj(bar_obj);\nbar_error:\n\tdestroy_foo_obj(foo_obj);\nfoo_error:\n\tkset_unregister(example_kset);\n\treturn -EINVAL;\n}\n\nstatic void __exit example_exit(void)\n{\n\tdestroy_foo_obj(baz_obj);\n\tdestroy_foo_obj(bar_obj);\n\tdestroy_foo_obj(foo_obj);\n\tkset_unregister(example_kset);\n}\n\nmodule_init(example_init);\nmodule_exit(example_exit);\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Greg Kroah-Hartman <greg@kroah.com>\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}