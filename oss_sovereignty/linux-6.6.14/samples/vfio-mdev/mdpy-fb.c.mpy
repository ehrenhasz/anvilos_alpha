{
  "module_name": "mdpy-fb.c",
  "hash_id": "524f1413b02a5703639e13ebb2a985326da6e951808d51372d051f44d0285526",
  "original_prompt": "Ingested from linux-6.6.14/samples/vfio-mdev/mdpy-fb.c",
  "human_readable_source": "\n \n#include <linux/errno.h>\n#include <linux/fb.h>\n#include <linux/io.h>\n#include <linux/pci.h>\n#include <linux/module.h>\n#include <drm/drm_fourcc.h>\n#include \"mdpy-defs.h\"\n\nstatic const struct fb_fix_screeninfo mdpy_fb_fix = {\n\t.id\t\t= \"mdpy-fb\",\n\t.type\t\t= FB_TYPE_PACKED_PIXELS,\n\t.visual\t\t= FB_VISUAL_TRUECOLOR,\n\t.accel\t\t= FB_ACCEL_NONE,\n};\n\nstatic const struct fb_var_screeninfo mdpy_fb_var = {\n\t.height\t\t= -1,\n\t.width\t\t= -1,\n\t.activate\t= FB_ACTIVATE_NOW,\n\t.vmode\t\t= FB_VMODE_NONINTERLACED,\n\n\t.bits_per_pixel = 32,\n\t.transp.offset\t= 24,\n\t.red.offset\t= 16,\n\t.green.offset\t= 8,\n\t.blue.offset\t= 0,\n\t.transp.length\t= 8,\n\t.red.length\t= 8,\n\t.green.length\t= 8,\n\t.blue.length\t= 8,\n};\n\n#define PSEUDO_PALETTE_SIZE 16\n\nstruct mdpy_fb_par {\n\tu32 palette[PSEUDO_PALETTE_SIZE];\n};\n\nstatic int mdpy_fb_setcolreg(u_int regno, u_int red, u_int green, u_int blue,\n\t\t\t      u_int transp, struct fb_info *info)\n{\n\tu32 *pal = info->pseudo_palette;\n\tu32 cr = red >> (16 - info->var.red.length);\n\tu32 cg = green >> (16 - info->var.green.length);\n\tu32 cb = blue >> (16 - info->var.blue.length);\n\tu32 value, mask;\n\n\tif (regno >= PSEUDO_PALETTE_SIZE)\n\t\treturn -EINVAL;\n\n\tvalue = (cr << info->var.red.offset) |\n\t\t(cg << info->var.green.offset) |\n\t\t(cb << info->var.blue.offset);\n\tif (info->var.transp.length > 0) {\n\t\tmask = (1 << info->var.transp.length) - 1;\n\t\tmask <<= info->var.transp.offset;\n\t\tvalue |= mask;\n\t}\n\tpal[regno] = value;\n\n\treturn 0;\n}\n\nstatic void mdpy_fb_destroy(struct fb_info *info)\n{\n\tif (info->screen_base)\n\t\tiounmap(info->screen_base);\n}\n\nstatic const struct fb_ops mdpy_fb_ops = {\n\t.owner\t\t= THIS_MODULE,\n\tFB_DEFAULT_IOMEM_OPS,\n\t.fb_destroy\t= mdpy_fb_destroy,\n\t.fb_setcolreg\t= mdpy_fb_setcolreg,\n};\n\nstatic int mdpy_fb_probe(struct pci_dev *pdev,\n\t\t\t const struct pci_device_id *ent)\n{\n\tstruct fb_info *info;\n\tstruct mdpy_fb_par *par;\n\tu32 format, width, height;\n\tint ret;\n\n\tret = pci_enable_device(pdev);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = pci_request_regions(pdev, \"mdpy-fb\");\n\tif (ret < 0)\n\t\tgoto err_disable_dev;\n\n\tpci_read_config_dword(pdev, MDPY_FORMAT_OFFSET, &format);\n\tpci_read_config_dword(pdev, MDPY_WIDTH_OFFSET,\t&width);\n\tpci_read_config_dword(pdev, MDPY_HEIGHT_OFFSET, &height);\n\tif (format != DRM_FORMAT_XRGB8888) {\n\t\tpci_err(pdev, \"format mismatch (0x%x != 0x%x)\\n\",\n\t\t\tformat, DRM_FORMAT_XRGB8888);\n\t\tret = -EINVAL;\n\t\tgoto err_release_regions;\n\t}\n\tif (width < 100\t || width > 10000) {\n\t\tpci_err(pdev, \"width (%d) out of range\\n\", width);\n\t\tret = -EINVAL;\n\t\tgoto err_release_regions;\n\t}\n\tif (height < 100 || height > 10000) {\n\t\tpci_err(pdev, \"height (%d) out of range\\n\", height);\n\t\tret = -EINVAL;\n\t\tgoto err_release_regions;\n\t}\n\tpci_info(pdev, \"mdpy found: %dx%d framebuffer\\n\",\n\t\t width, height);\n\n\tinfo = framebuffer_alloc(sizeof(struct mdpy_fb_par), &pdev->dev);\n\tif (!info) {\n\t\tret = -ENOMEM;\n\t\tgoto err_release_regions;\n\t}\n\tpci_set_drvdata(pdev, info);\n\tpar = info->par;\n\n\tinfo->fix = mdpy_fb_fix;\n\tinfo->fix.smem_start = pci_resource_start(pdev, 0);\n\tinfo->fix.smem_len = pci_resource_len(pdev, 0);\n\tinfo->fix.line_length = width * 4;\n\n\tinfo->var = mdpy_fb_var;\n\tinfo->var.xres = width;\n\tinfo->var.yres = height;\n\tinfo->var.xres_virtual = width;\n\tinfo->var.yres_virtual = height;\n\n\tinfo->screen_size = info->fix.smem_len;\n\tinfo->screen_base = ioremap(info->fix.smem_start,\n\t\t\t\t    info->screen_size);\n\tif (!info->screen_base) {\n\t\tpci_err(pdev, \"ioremap(pcibar) failed\\n\");\n\t\tret = -EIO;\n\t\tgoto err_release_fb;\n\t}\n\n\tinfo->fbops = &mdpy_fb_ops;\n\tinfo->pseudo_palette = par->palette;\n\n\tret = register_framebuffer(info);\n\tif (ret < 0) {\n\t\tpci_err(pdev, \"mdpy-fb device register failed: %d\\n\", ret);\n\t\tgoto err_unmap;\n\t}\n\n\tpci_info(pdev, \"fb%d registered\\n\", info->node);\n\treturn 0;\n\nerr_unmap:\n\tiounmap(info->screen_base);\n\nerr_release_fb:\n\tframebuffer_release(info);\n\nerr_release_regions:\n\tpci_release_regions(pdev);\n\nerr_disable_dev:\n\tpci_disable_device(pdev);\n\n\treturn ret;\n}\n\nstatic void mdpy_fb_remove(struct pci_dev *pdev)\n{\n\tstruct fb_info *info = pci_get_drvdata(pdev);\n\n\tunregister_framebuffer(info);\n\tiounmap(info->screen_base);\n\tframebuffer_release(info);\n\tpci_release_regions(pdev);\n\tpci_disable_device(pdev);\n}\n\nstatic struct pci_device_id mdpy_fb_pci_table[] = {\n\t{\n\t\t.vendor\t   = MDPY_PCI_VENDOR_ID,\n\t\t.device\t   = MDPY_PCI_DEVICE_ID,\n\t\t.subvendor = MDPY_PCI_SUBVENDOR_ID,\n\t\t.subdevice = MDPY_PCI_SUBDEVICE_ID,\n\t}, {\n\t\t \n\t}\n};\n\nstatic struct pci_driver mdpy_fb_pci_driver = {\n\t.name\t\t= \"mdpy-fb\",\n\t.id_table\t= mdpy_fb_pci_table,\n\t.probe\t\t= mdpy_fb_probe,\n\t.remove\t\t= mdpy_fb_remove,\n};\n\nstatic int __init mdpy_fb_init(void)\n{\n\tint ret;\n\n\tret = pci_register_driver(&mdpy_fb_pci_driver);\n\tif (ret)\n\t\treturn ret;\n\n\treturn 0;\n}\n\nmodule_init(mdpy_fb_init);\n\nMODULE_DEVICE_TABLE(pci, mdpy_fb_pci_table);\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}