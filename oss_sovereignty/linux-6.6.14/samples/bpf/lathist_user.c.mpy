{
  "module_name": "lathist_user.c",
  "hash_id": "2f362f46c193648495cbb7c01c3ebdc24af7e5c31371b5256321894f92235102",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/lathist_user.c",
  "human_readable_source": "\n \n#include <stdio.h>\n#include <unistd.h>\n#include <stdlib.h>\n#include <signal.h>\n#include <bpf/libbpf.h>\n#include <bpf/bpf.h>\n\n#define MAX_ENTRIES\t20\n#define MAX_CPU\t\t4\n#define MAX_STARS\t40\n\nstruct cpu_hist {\n\tlong data[MAX_ENTRIES];\n\tlong max;\n};\n\nstatic struct cpu_hist cpu_hist[MAX_CPU];\n\nstatic void stars(char *str, long val, long max, int width)\n{\n\tint i;\n\n\tfor (i = 0; i < (width * val / max) - 1 && i < width - 1; i++)\n\t\tstr[i] = '*';\n\tif (val > max)\n\t\tstr[i - 1] = '+';\n\tstr[i] = '\\0';\n}\n\nstatic void print_hist(void)\n{\n\tchar starstr[MAX_STARS];\n\tstruct cpu_hist *hist;\n\tint i, j;\n\n\t \n\tprintf(\"\\033[2J\");\n\n\tfor (j = 0; j < MAX_CPU; j++) {\n\t\thist = &cpu_hist[j];\n\n\t\t \n\t\tif (hist->max == 0)\n\t\t\tcontinue;\n\n\t\tprintf(\"CPU %d\\n\", j);\n\t\tprintf(\"      latency        : count     distribution\\n\");\n\t\tfor (i = 1; i <= MAX_ENTRIES; i++) {\n\t\t\tstars(starstr, hist->data[i - 1], hist->max, MAX_STARS);\n\t\t\tprintf(\"%8ld -> %-8ld : %-8ld |%-*s|\\n\",\n\t\t\t\t(1l << i) >> 1, (1l << i) - 1,\n\t\t\t\thist->data[i - 1], MAX_STARS, starstr);\n\t\t}\n\t}\n}\n\nstatic void get_data(int fd)\n{\n\tlong key, value;\n\tint c, i;\n\n\tfor (i = 0; i < MAX_CPU; i++)\n\t\tcpu_hist[i].max = 0;\n\n\tfor (c = 0; c < MAX_CPU; c++) {\n\t\tfor (i = 0; i < MAX_ENTRIES; i++) {\n\t\t\tkey = c * MAX_ENTRIES + i;\n\t\t\tbpf_map_lookup_elem(fd, &key, &value);\n\n\t\t\tcpu_hist[c].data[i] = value;\n\t\t\tif (value > cpu_hist[c].max)\n\t\t\t\tcpu_hist[c].max = value;\n\t\t}\n\t}\n}\n\nint main(int argc, char **argv)\n{\n\tstruct bpf_link *links[2];\n\tstruct bpf_program *prog;\n\tstruct bpf_object *obj;\n\tchar filename[256];\n\tint map_fd, i = 0;\n\n\tsnprintf(filename, sizeof(filename), \"%s_kern.o\", argv[0]);\n\tobj = bpf_object__open_file(filename, NULL);\n\tif (libbpf_get_error(obj)) {\n\t\tfprintf(stderr, \"ERROR: opening BPF object file failed\\n\");\n\t\treturn 0;\n\t}\n\n\t \n\tif (bpf_object__load(obj)) {\n\t\tfprintf(stderr, \"ERROR: loading BPF object file failed\\n\");\n\t\tgoto cleanup;\n\t}\n\n\tmap_fd = bpf_object__find_map_fd_by_name(obj, \"my_lat\");\n\tif (map_fd < 0) {\n\t\tfprintf(stderr, \"ERROR: finding a map in obj file failed\\n\");\n\t\tgoto cleanup;\n\t}\n\n\tbpf_object__for_each_program(prog, obj) {\n\t\tlinks[i] = bpf_program__attach(prog);\n\t\tif (libbpf_get_error(links[i])) {\n\t\t\tfprintf(stderr, \"ERROR: bpf_program__attach failed\\n\");\n\t\t\tlinks[i] = NULL;\n\t\t\tgoto cleanup;\n\t\t}\n\t\ti++;\n\t}\n\n\twhile (1) {\n\t\tget_data(map_fd);\n\t\tprint_hist();\n\t\tsleep(5);\n\t}\n\ncleanup:\n\tfor (i--; i >= 0; i--)\n\t\tbpf_link__destroy(links[i]);\n\n\tbpf_object__close(obj);\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}