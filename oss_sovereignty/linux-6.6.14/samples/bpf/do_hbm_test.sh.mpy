{
  "module_name": "do_hbm_test.sh",
  "hash_id": "666beaf3299210a30911f612e88b172a1e1c19bfc7e75ae614b9fed8fdef7990",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/do_hbm_test.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n#\n# Copyright (c) 2019 Facebook\n#\n# This program is free software; you can redistribute it and/or\n# modify it under the terms of version 2 of the GNU General Public\n# License as published by the Free Software Foundation.\n\nUsage() {\n  echo \"Script for testing HBM (Host Bandwidth Manager) framework.\"\n  echo \"It creates a cgroup to use for testing and load a BPF program to limit\"\n  echo \"egress or ingress bandwidth. It then uses iperf3 or netperf to create\"\n  echo \"loads. The output is the goodput in Mbps (unless -D was used).\"\n  echo \"\"\n  echo \"USAGE: $name [out] [-b=<prog>|--bpf=<prog>] [-c=<cc>|--cc=<cc>]\"\n  echo \"             [-D] [-d=<delay>|--delay=<delay>] [--debug] [-E] [--edt]\"\n  echo \"             [-f=<#flows>|--flows=<#flows>] [-h] [-i=<id>|--id=<id >]\"\n  echo \"             [-l] [-N] [--no_cn] [-p=<port>|--port=<port>] [-P]\"\n  echo \"             [-q=<qdisc>] [-R] [-s=<server>|--server=<server]\"\n  echo \"             [-S|--stats] -t=<time>|--time=<time>] [-w] [cubic|dctcp]\"\n  echo \"  Where:\"\n  echo \"    out               egress (default)\"\n  echo \"    -b or --bpf       BPF program filename to load and attach.\"\n  echo \"                      Default is hbm_out_kern.o for egress,\"\n  echo \"    -c or -cc         TCP congestion control (cubic or dctcp)\"\n  echo \"    --debug           print BPF trace buffer\"\n  echo \"    -d or --delay     add a delay in ms using netem\"\n  echo \"    -D                In addition to the goodput in Mbps, it also outputs\"\n  echo \"                      other detailed information. This information is\"\n  echo \"                      test dependent (i.e. iperf3 or netperf).\"\n  echo \"    -E                enable ECN (not required for dctcp)\"\n  echo \"    --edt             use fq's Earliest Departure Time (requires fq)\"\n  echo \"    -f or --flows     number of concurrent flows (default=1)\"\n  echo \"    -i or --id        cgroup id (an integer, default is 1)\"\n  echo \"    -N                use netperf instead of iperf3\"\n  echo \"    --no_cn           Do not return CN notifications\"\n  echo \"    -l                do not limit flows using loopback\"\n  echo \"    -h                Help\"\n  echo \"    -p or --port      iperf3 port (default is 5201)\"\n  echo \"    -P                use an iperf3 instance for each flow\"\n  echo \"    -q                use the specified qdisc\"\n  echo \"    -r or --rate      rate in Mbps (default 1s 1Gbps)\"\n  echo \"    -R                Use TCP_RR for netperf. 1st flow has req\"\n  echo \"                      size of 10KB, rest of 1MB. Reply in all\"\n  echo \"                      cases is 1 byte.\"\n  echo \"                      More detailed output for each flow can be found\"\n  echo \"                      in the files netperf.<cg>.<flow>, where <cg> is the\"\n  echo \"                      cgroup id as specified with the -i flag, and <flow>\"\n  echo \"                      is the flow id starting at 1 and increasing by 1 for\"\n  echo \"                      flow (as specified by -f).\"\n  echo \"    -s or --server    hostname of netperf server. Used to create netperf\"\n  echo \"                      test traffic between to hosts (default is within host)\"\n  echo \"                      netserver must be running on the host.\"\n  echo \"    -S or --stats     whether to update hbm stats (default is yes).\"\n  echo \"    -t or --time      duration of iperf3 in seconds (default=5)\"\n  echo \"    -w                Work conserving flag. cgroup can increase its\"\n  echo \"                      bandwidth beyond the rate limit specified\"\n  echo \"                      while there is available bandwidth. Current\"\n  echo \"                      implementation assumes there is only one NIC\"\n  echo \"                      (eth0), but can be extended to support multiple\"\n  echo \"                       NICs.\"\n  echo \"    cubic or dctcp    specify which TCP CC to use\"\n  echo \" \"\n  exit\n}\n\n#set -x\n\ndebug_flag=0\nargs=\"$@\"\nname=\"$0\"\nnetem=0\ncc=x\ndir=\"-o\"\ndir_name=\"out\"\ndur=5\nflows=1\nid=1\nprog=\"\"\nport=5201\nrate=1000\nmulti_iperf=0\nflow_cnt=1\nuse_netperf=0\nrr=0\necn=0\ndetails=0\nserver=\"\"\nqdisc=\"\"\nflags=\"\"\ndo_stats=0\n\nBPFFS=/sys/fs/bpf\nfunction config_bpffs () {\n\tif mount | grep $BPFFS > /dev/null; then\n\t\techo \"bpffs already mounted\"\n\telse\n\t\techo \"bpffs not mounted. Mounting...\"\n\t\tmount -t bpf none $BPFFS\n\tfi\n}\n\nfunction start_hbm () {\n  rm -f hbm.out\n  echo \"./hbm $dir -n $id -r $rate -t $dur $flags $dbg $prog\" > hbm.out\n  echo \" \" >> hbm.out\n  ./hbm $dir -n $id -r $rate -t $dur $flags $dbg $prog >> hbm.out 2>&1  &\n  echo $!\n}\n\nprocessArgs () {\n  for i in $args ; do\n    case $i in\n    # Support for upcomming ingress rate limiting\n    #in)         # support for upcoming ingress rate limiting\n    #  dir=\"-i\"\n    #  dir_name=\"in\"\n    #  ;;\n    out)\n      dir=\"-o\"\n      dir_name=\"out\"\n      ;;\n    -b=*|--bpf=*)\n      prog=\"${i#*=}\"\n      ;;\n    -c=*|--cc=*)\n      cc=\"${i#*=}\"\n      ;;\n    --no_cn)\n      flags=\"$flags --no_cn\"\n      ;;\n    --debug)\n      flags=\"$flags -d\"\n      debug_flag=1\n      ;;\n    -d=*|--delay=*)\n      netem=\"${i#*=}\"\n      ;;\n    -D)\n      details=1\n      ;;\n    -E)\n      ecn=1\n      ;;\n    --edt)\n      flags=\"$flags --edt\"\n      qdisc=\"fq\"\n     ;;\n    -f=*|--flows=*)\n      flows=\"${i#*=}\"\n      ;;\n    -i=*|--id=*)\n      id=\"${i#*=}\"\n      ;;\n    -l)\n      flags=\"$flags -l\"\n      ;;\n    -N)\n      use_netperf=1\n      ;;\n    -p=*|--port=*)\n      port=\"${i#*=}\"\n      ;;\n    -P)\n      multi_iperf=1\n      ;;\n    -q=*)\n      qdisc=\"${i#*=}\"\n      ;;\n    -r=*|--rate=*)\n      rate=\"${i#*=}\"\n      ;;\n    -R)\n      rr=1\n      ;;\n    -s=*|--server=*)\n      server=\"${i#*=}\"\n      ;;\n    -S|--stats)\n      flags=\"$flags -s\"\n      do_stats=1\n      ;;\n    -t=*|--time=*)\n      dur=\"${i#*=}\"\n      ;;\n    -w)\n      flags=\"$flags -w\"\n      ;;\n    cubic)\n      cc=cubic\n      ;;\n    dctcp)\n      cc=dctcp\n      ;;\n    *)\n      echo \"Unknown arg:$i\"\n      Usage\n      ;;\n    esac\n  done\n}\n\nprocessArgs\nconfig_bpffs\n\nif [ $debug_flag -eq 1 ] ; then\n  rm -f hbm_out.log\nfi\n\nhbm_pid=$(start_hbm)\nusleep 100000\n\nhost=`hostname`\ncg_base_dir=/sys/fs/cgroup/unified\ncg_dir=\"$cg_base_dir/cgroup-test-work-dir/hbm$id\"\n\necho $$ >> $cg_dir/cgroup.procs\n\nulimit -l unlimited\n\nrm -f ss.out\nrm -f hbm.[0-9]*.$dir_name\nif [ $ecn -ne 0 ] ; then\n  sysctl -w -q -n net.ipv4.tcp_ecn=1\nfi\n\nif [ $use_netperf -eq 0 ] ; then\n  cur_cc=`sysctl -n net.ipv4.tcp_congestion_control`\n  if [ \"$cc\" != \"x\" ] ; then\n    sysctl -w -q -n net.ipv4.tcp_congestion_control=$cc\n  fi\nfi\n\nif [ \"$netem\" -ne \"0\" ] ; then\n  if [ \"$qdisc\" != \"\" ] ; then\n    echo \"WARNING: Ignoring -q options because -d option used\"\n  fi\n  tc qdisc del dev lo root > /dev/null 2>&1\n  tc qdisc add dev lo root netem delay $netem\\ms > /dev/null 2>&1\nelif [ \"$qdisc\" != \"\" ] ; then\n  tc qdisc del dev eth0 root > /dev/null 2>&1\n  tc qdisc add dev eth0 root $qdisc > /dev/null 2>&1\nfi\n\nn=0\nm=$[$dur * 5]\nhn=\"::1\"\nif [ $use_netperf -ne 0 ] ; then\n  if [ \"$server\" != \"\" ] ; then\n    hn=$server\n  fi\nfi\n\n( ping6 -i 0.2 -c $m $hn > ping.out 2>&1 ) &\n\nif [ $use_netperf -ne 0 ] ; then\n  begNetserverPid=`ps ax | grep netserver | grep --invert-match \"grep\" | \\\n                   awk '{ print $1 }'`\n  if [ \"$begNetserverPid\" == \"\" ] ; then\n    if [ \"$server\" == \"\" ] ; then\n      ( ./netserver > /dev/null 2>&1) &\n      usleep 100000\n    fi\n  fi\n  flow_cnt=1\n  if [ \"$server\" == \"\" ] ; then\n    np_server=$host\n  else\n    np_server=$server\n  fi\n  if [ \"$cc\" == \"x\" ] ; then\n    np_cc=\"\"\n  else\n    np_cc=\"-K $cc,$cc\"\n  fi\n  replySize=1\n  while [ $flow_cnt -le $flows ] ; do\n    if [ $rr -ne 0 ] ; then\n      reqSize=1M\n      if [ $flow_cnt -eq 1 ] ; then\n        reqSize=10K\n      fi\n      if [ \"$dir\" == \"-i\" ] ; then\n        replySize=$reqSize\n        reqSize=1\n      fi\n      ( ./netperf -H $np_server -l $dur -f m -j -t TCP_RR  -- -r $reqSize,$replySize $np_cc -k P50_lATENCY,P90_LATENCY,LOCAL_TRANSPORT_RETRANS,REMOTE_TRANSPORT_RETRANS,LOCAL_SEND_THROUGHPUT,LOCAL_RECV_THROUGHPUT,REQUEST_SIZE,RESPONSE_SIZE > netperf.$id.$flow_cnt ) &\n    else\n      if [ \"$dir\" == \"-i\" ] ; then\n        ( ./netperf -H $np_server -l $dur -f m -j -t TCP_RR -- -r 1,10M $np_cc -k P50_LATENCY,P90_LATENCY,LOCAL_TRANSPORT_RETRANS,LOCAL_SEND_THROUGHPUT,REMOTE_TRANSPORT_RETRANS,REMOTE_SEND_THROUGHPUT,REQUEST_SIZE,RESPONSE_SIZE > netperf.$id.$flow_cnt ) &\n      else\n        ( ./netperf -H $np_server -l $dur -f m -j -t TCP_STREAM -- $np_cc -k P50_lATENCY,P90_LATENCY,LOCAL_TRANSPORT_RETRANS,LOCAL_SEND_THROUGHPUT,REQUEST_SIZE,RESPONSE_SIZE > netperf.$id.$flow_cnt ) &\n      fi\n    fi\n    flow_cnt=$[flow_cnt+1]\n  done\n\n# sleep for duration of test (plus some buffer)\n  n=$[dur+2]\n  sleep $n\n\n# force graceful termination of netperf\n  pids=`pgrep netperf`\n  for p in $pids ; do\n    kill -SIGALRM $p\n  done\n\n  flow_cnt=1\n  rate=0\n  if [ $details -ne 0 ] ; then\n    echo \"\"\n    echo \"Details for HBM in cgroup $id\"\n    if [ $do_stats -eq 1 ] ; then\n      if [ -e hbm.$id.$dir_name ] ; then\n        cat hbm.$id.$dir_name\n      fi\n    fi\n  fi\n  while [ $flow_cnt -le $flows ] ; do\n    if [ \"$dir\" == \"-i\" ] ; then\n      r=`cat netperf.$id.$flow_cnt | grep -o \"REMOTE_SEND_THROUGHPUT=[0-9]*\" | grep -o \"[0-9]*\"`\n    else\n      r=`cat netperf.$id.$flow_cnt | grep -o \"LOCAL_SEND_THROUGHPUT=[0-9]*\" | grep -o \"[0-9]*\"`\n    fi\n    echo \"rate for flow $flow_cnt: $r\"\n    rate=$[rate+r]\n    if [ $details -ne 0 ] ; then\n      echo \"-----\"\n      echo \"Details for cgroup $id, flow $flow_cnt\"\n      cat netperf.$id.$flow_cnt\n    fi\n    flow_cnt=$[flow_cnt+1]\n  done\n  if [ $details -ne 0 ] ; then\n    echo \"\"\n    delay=`grep \"avg\" ping.out | grep -o \"= [0-9.]*/[0-9.]*\" | grep -o \"[0-9.]*$\"`\n    echo \"PING AVG DELAY:$delay\"\n    echo \"AGGREGATE_GOODPUT:$rate\"\n  else\n    echo $rate\n  fi\nelif [ $multi_iperf -eq 0 ] ; then\n  (iperf3 -s -p $port -1 > /dev/null 2>&1) &\n  usleep 100000\n  iperf3 -c $host -p $port -i 0 -P $flows -f m -t $dur > iperf.$id\n  rates=`grep receiver iperf.$id | grep -o \"[0-9.]* Mbits\" | grep -o \"^[0-9]*\"`\n  rate=`echo $rates | grep -o \"[0-9]*$\"`\n\n  if [ $details -ne 0 ] ; then\n    echo \"\"\n    echo \"Details for HBM in cgroup $id\"\n    if [ $do_stats -eq 1 ] ; then\n      if [ -e hbm.$id.$dir_name ] ; then\n        cat hbm.$id.$dir_name\n      fi\n    fi\n    delay=`grep \"avg\" ping.out | grep -o \"= [0-9.]*/[0-9.]*\" | grep -o \"[0-9.]*$\"`\n    echo \"PING AVG DELAY:$delay\"\n    echo \"AGGREGATE_GOODPUT:$rate\"\n  else\n    echo $rate\n  fi\nelse\n  flow_cnt=1\n  while [ $flow_cnt -le $flows ] ; do\n    (iperf3 -s -p $port -1 > /dev/null 2>&1) &\n    ( iperf3 -c $host -p $port -i 0 -P 1 -f m -t $dur | grep receiver | grep -o \"[0-9.]* Mbits\" | grep -o \"^[0-9]*\" | grep -o \"[0-9]*$\" > iperf3.$id.$flow_cnt ) &\n    port=$[port+1]\n    flow_cnt=$[flow_cnt+1]\n  done\n  n=$[dur+1]\n  sleep $n\n  flow_cnt=1\n  rate=0\n  if [ $details -ne 0 ] ; then\n    echo \"\"\n    echo \"Details for HBM in cgroup $id\"\n    if [ $do_stats -eq 1 ] ; then\n      if [ -e hbm.$id.$dir_name ] ; then\n        cat hbm.$id.$dir_name\n      fi\n    fi\n  fi\n\n  while [ $flow_cnt -le $flows ] ; do\n    r=`cat iperf3.$id.$flow_cnt`\n#    echo \"rate for flow $flow_cnt: $r\"\n  if [ $details -ne 0 ] ; then\n    echo \"Rate for cgroup $id, flow $flow_cnt LOCAL_SEND_THROUGHPUT=$r\"\n  fi\n    rate=$[rate+r]\n    flow_cnt=$[flow_cnt+1]\n  done\n  if [ $details -ne 0 ] ; then\n    delay=`grep \"avg\" ping.out | grep -o \"= [0-9.]*/[0-9.]*\" | grep -o \"[0-9.]*$\"`\n    echo \"PING AVG DELAY:$delay\"\n    echo \"AGGREGATE_GOODPUT:$rate\"\n  else\n    echo $rate\n  fi\nfi\n\nif [ $use_netperf -eq 0 ] ; then\n  sysctl -w -q -n net.ipv4.tcp_congestion_control=$cur_cc\nfi\nif [ $ecn -ne 0 ] ; then\n  sysctl -w -q -n net.ipv4.tcp_ecn=0\nfi\nif [ \"$netem\" -ne \"0\" ] ; then\n  tc qdisc del dev lo root > /dev/null 2>&1\nfi\nif [ \"$qdisc\" != \"\" ] ; then\n  tc qdisc del dev eth0 root > /dev/null 2>&1\nfi\nsleep 2\n\nhbmPid=`ps ax | grep \"hbm \" | grep --invert-match \"grep\" | awk '{ print $1 }'`\nif [ \"$hbmPid\" == \"$hbm_pid\" ] ; then\n  kill $hbm_pid\nfi\n\nsleep 1\n\n# Detach any pinned BPF programs that may have lingered\nrm -rf $BPFFS/hbm*\n\nif [ $use_netperf -ne 0 ] ; then\n  if [ \"$server\" == \"\" ] ; then\n    if [ \"$begNetserverPid\" == \"\" ] ; then\n      netserverPid=`ps ax | grep netserver | grep --invert-match \"grep\" | awk '{ print $1 }'`\n      if [ \"$netserverPid\" != \"\" ] ; then\n        kill $netserverPid\n      fi\n    fi\n  fi\nfi\nexit\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}