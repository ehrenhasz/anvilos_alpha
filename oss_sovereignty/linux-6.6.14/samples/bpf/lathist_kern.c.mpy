{
  "module_name": "lathist_kern.c",
  "hash_id": "3b7e34c6593123836b6e78c2a60fda9eac1e238058b2f0426699ecc90669bf9c",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/lathist_kern.c",
  "human_readable_source": " \n#include <linux/version.h>\n#include <linux/ptrace.h>\n#include <uapi/linux/bpf.h>\n#include <bpf/bpf_helpers.h>\n\n#define MAX_ENTRIES\t20\n#define MAX_CPU\t\t4\n\n \n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_ARRAY);\n\t__type(key, int);\n\t__type(value, u64);\n\t__uint(max_entries, MAX_CPU);\n} my_map SEC(\".maps\");\n\nSEC(\"kprobe/trace_preempt_off\")\nint bpf_prog1(struct pt_regs *ctx)\n{\n\tint cpu = bpf_get_smp_processor_id();\n\tu64 *ts = bpf_map_lookup_elem(&my_map, &cpu);\n\n\tif (ts)\n\t\t*ts = bpf_ktime_get_ns();\n\n\treturn 0;\n}\n\nstatic unsigned int log2(unsigned int v)\n{\n\tunsigned int r;\n\tunsigned int shift;\n\n\tr = (v > 0xFFFF) << 4; v >>= r;\n\tshift = (v > 0xFF) << 3; v >>= shift; r |= shift;\n\tshift = (v > 0xF) << 2; v >>= shift; r |= shift;\n\tshift = (v > 0x3) << 1; v >>= shift; r |= shift;\n\tr |= (v >> 1);\n\n\treturn r;\n}\n\nstatic unsigned int log2l(unsigned long v)\n{\n\tunsigned int hi = v >> 32;\n\n\tif (hi)\n\t\treturn log2(hi) + 32;\n\telse\n\t\treturn log2(v);\n}\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_ARRAY);\n\t__type(key, int);\n\t__type(value, long);\n\t__uint(max_entries, MAX_CPU * MAX_ENTRIES);\n} my_lat SEC(\".maps\");\n\nSEC(\"kprobe/trace_preempt_on\")\nint bpf_prog2(struct pt_regs *ctx)\n{\n\tu64 *ts, cur_ts, delta;\n\tint key, cpu;\n\tlong *val;\n\n\tcpu = bpf_get_smp_processor_id();\n\tts = bpf_map_lookup_elem(&my_map, &cpu);\n\tif (!ts)\n\t\treturn 0;\n\n\tcur_ts = bpf_ktime_get_ns();\n\tdelta = log2l(cur_ts - *ts);\n\n\tif (delta > MAX_ENTRIES - 1)\n\t\tdelta = MAX_ENTRIES - 1;\n\n\tkey = cpu * MAX_ENTRIES + delta;\n\tval = bpf_map_lookup_elem(&my_lat, &key);\n\tif (val)\n\t\t__sync_fetch_and_add((long *)val, 1);\n\n\treturn 0;\n\n}\n\nchar _license[] SEC(\"license\") = \"GPL\";\nu32 _version SEC(\"version\") = LINUX_VERSION_CODE;\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}