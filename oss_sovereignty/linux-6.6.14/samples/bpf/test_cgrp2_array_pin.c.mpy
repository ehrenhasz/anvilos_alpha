{
  "module_name": "test_cgrp2_array_pin.c",
  "hash_id": "4b08298e84c92fe23fdfea85e05ce148dd93661419ed8aa9942904275e760d7f",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/test_cgrp2_array_pin.c",
  "human_readable_source": "\n \n#include <linux/unistd.h>\n#include <linux/bpf.h>\n\n#include <stdio.h>\n#include <stdint.h>\n#include <unistd.h>\n#include <string.h>\n#include <errno.h>\n#include <fcntl.h>\n\n#include <bpf/bpf.h>\n\nstatic void usage(void)\n{\n\tprintf(\"Usage: test_cgrp2_array_pin [...]\\n\");\n\tprintf(\"       -F <file>   File to pin an BPF cgroup array\\n\");\n\tprintf(\"       -U <file>   Update an already pinned BPF cgroup array\\n\");\n\tprintf(\"       -v <value>  Full path of the cgroup2\\n\");\n\tprintf(\"       -h          Display this help\\n\");\n}\n\nint main(int argc, char **argv)\n{\n\tconst char *pinned_file = NULL, *cg2 = NULL;\n\tint create_array = 1;\n\tint array_key = 0;\n\tint array_fd = -1;\n\tint cg2_fd = -1;\n\tint ret = -1;\n\tint opt;\n\n\twhile ((opt = getopt(argc, argv, \"F:U:v:\")) != -1) {\n\t\tswitch (opt) {\n\t\t \n\t\tcase 'F':\n\t\t\tpinned_file = optarg;\n\t\t\tbreak;\n\t\tcase 'U':\n\t\t\tpinned_file = optarg;\n\t\t\tcreate_array = 0;\n\t\t\tbreak;\n\t\tcase 'v':\n\t\t\tcg2 = optarg;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tusage();\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tif (!cg2 || !pinned_file) {\n\t\tusage();\n\t\tgoto out;\n\t}\n\n\tcg2_fd = open(cg2, O_RDONLY);\n\tif (cg2_fd < 0) {\n\t\tfprintf(stderr, \"open(%s,...): %s(%d)\\n\",\n\t\t\tcg2, strerror(errno), errno);\n\t\tgoto out;\n\t}\n\n\tif (create_array) {\n\t\tarray_fd = bpf_map_create(BPF_MAP_TYPE_CGROUP_ARRAY, NULL,\n\t\t\t\t\t  sizeof(uint32_t), sizeof(uint32_t),\n\t\t\t\t\t  1, NULL);\n\t\tif (array_fd < 0) {\n\t\t\tfprintf(stderr,\n\t\t\t\t\"bpf_create_map(BPF_MAP_TYPE_CGROUP_ARRAY,...): %s(%d)\\n\",\n\t\t\t\tstrerror(errno), errno);\n\t\t\tgoto out;\n\t\t}\n\t} else {\n\t\tarray_fd = bpf_obj_get(pinned_file);\n\t\tif (array_fd < 0) {\n\t\t\tfprintf(stderr, \"bpf_obj_get(%s): %s(%d)\\n\",\n\t\t\t\tpinned_file, strerror(errno), errno);\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tret = bpf_map_update_elem(array_fd, &array_key, &cg2_fd, 0);\n\tif (ret) {\n\t\tperror(\"bpf_map_update_elem\");\n\t\tgoto out;\n\t}\n\n\tif (create_array) {\n\t\tret = bpf_obj_pin(array_fd, pinned_file);\n\t\tif (ret) {\n\t\t\tfprintf(stderr, \"bpf_obj_pin(..., %s): %s(%d)\\n\",\n\t\t\t\tpinned_file, strerror(errno), errno);\n\t\t\tgoto out;\n\t\t}\n\t}\n\nout:\n\tif (array_fd != -1)\n\t\tclose(array_fd);\n\tif (cg2_fd != -1)\n\t\tclose(cg2_fd);\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}