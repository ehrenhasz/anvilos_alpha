{
  "module_name": "xdp_adjust_tail_user.c",
  "hash_id": "90bffb870f959fa93d35ff47b58cf15cad809afe4479d9d6a3503cd183cf47fb",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/xdp_adjust_tail_user.c",
  "human_readable_source": " \n#include <linux/bpf.h>\n#include <linux/if_link.h>\n#include <assert.h>\n#include <errno.h>\n#include <signal.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <net/if.h>\n#include <arpa/inet.h>\n#include <netinet/ether.h>\n#include <unistd.h>\n#include <time.h>\n#include <bpf/bpf.h>\n#include <bpf/libbpf.h>\n\n#define STATS_INTERVAL_S 2U\n#define MAX_PCKT_SIZE 600\n\nstatic int ifindex = -1;\nstatic __u32 xdp_flags = XDP_FLAGS_UPDATE_IF_NOEXIST;\nstatic __u32 prog_id;\n\nstatic void int_exit(int sig)\n{\n\t__u32 curr_prog_id = 0;\n\n\tif (ifindex > -1) {\n\t\tif (bpf_xdp_query_id(ifindex, xdp_flags, &curr_prog_id)) {\n\t\t\tprintf(\"bpf_xdp_query_id failed\\n\");\n\t\t\texit(1);\n\t\t}\n\t\tif (prog_id == curr_prog_id)\n\t\t\tbpf_xdp_detach(ifindex, xdp_flags, NULL);\n\t\telse if (!curr_prog_id)\n\t\t\tprintf(\"couldn't find a prog id on a given iface\\n\");\n\t\telse\n\t\t\tprintf(\"program on interface changed, not removing\\n\");\n\t}\n\texit(0);\n}\n\n \nstatic void poll_stats(unsigned int map_fd, unsigned int kill_after_s)\n{\n\ttime_t started_at = time(NULL);\n\t__u64 value = 0;\n\tint key = 0;\n\n\n\twhile (!kill_after_s || time(NULL) - started_at <= kill_after_s) {\n\t\tsleep(STATS_INTERVAL_S);\n\n\t\tassert(bpf_map_lookup_elem(map_fd, &key, &value) == 0);\n\n\t\tprintf(\"icmp \\\"packet too big\\\" sent: %10llu pkts\\n\", value);\n\t}\n}\n\nstatic void usage(const char *cmd)\n{\n\tprintf(\"Start a XDP prog which send ICMP \\\"packet too big\\\" \\n\"\n\t\t\"messages if ingress packet is bigger then MAX_SIZE bytes\\n\");\n\tprintf(\"Usage: %s [...]\\n\", cmd);\n\tprintf(\"    -i <ifname|ifindex> Interface\\n\");\n\tprintf(\"    -T <stop-after-X-seconds> Default: 0 (forever)\\n\");\n\tprintf(\"    -P <MAX_PCKT_SIZE> Default: %u\\n\", MAX_PCKT_SIZE);\n\tprintf(\"    -S use skb-mode\\n\");\n\tprintf(\"    -N enforce native mode\\n\");\n\tprintf(\"    -F force loading prog\\n\");\n\tprintf(\"    -h Display this help\\n\");\n}\n\nint main(int argc, char **argv)\n{\n\tunsigned char opt_flags[256] = {};\n\tconst char *optstr = \"i:T:P:SNFh\";\n\tstruct bpf_prog_info info = {};\n\t__u32 info_len = sizeof(info);\n\tunsigned int kill_after_s = 0;\n\tint i, prog_fd, map_fd, opt;\n\tstruct bpf_program *prog;\n\tstruct bpf_object *obj;\n\t__u32 max_pckt_size = 0;\n\t__u32 key = 0;\n\tchar filename[256];\n\tint err;\n\n\tfor (i = 0; i < strlen(optstr); i++)\n\t\tif (optstr[i] != 'h' && 'a' <= optstr[i] && optstr[i] <= 'z')\n\t\t\topt_flags[(unsigned char)optstr[i]] = 1;\n\n\twhile ((opt = getopt(argc, argv, optstr)) != -1) {\n\n\t\tswitch (opt) {\n\t\tcase 'i':\n\t\t\tifindex = if_nametoindex(optarg);\n\t\t\tif (!ifindex)\n\t\t\t\tifindex = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'T':\n\t\t\tkill_after_s = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'P':\n\t\t\tmax_pckt_size = atoi(optarg);\n\t\t\tbreak;\n\t\tcase 'S':\n\t\t\txdp_flags |= XDP_FLAGS_SKB_MODE;\n\t\t\tbreak;\n\t\tcase 'N':\n\t\t\t \n\t\t\tbreak;\n\t\tcase 'F':\n\t\t\txdp_flags &= ~XDP_FLAGS_UPDATE_IF_NOEXIST;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tusage(argv[0]);\n\t\t\treturn 1;\n\t\t}\n\t\topt_flags[opt] = 0;\n\t}\n\n\tif (!(xdp_flags & XDP_FLAGS_SKB_MODE))\n\t\txdp_flags |= XDP_FLAGS_DRV_MODE;\n\n\tfor (i = 0; i < strlen(optstr); i++) {\n\t\tif (opt_flags[(unsigned int)optstr[i]]) {\n\t\t\tfprintf(stderr, \"Missing argument -%c\\n\", optstr[i]);\n\t\t\tusage(argv[0]);\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\tif (!ifindex) {\n\t\tfprintf(stderr, \"Invalid ifname\\n\");\n\t\treturn 1;\n\t}\n\n\tsnprintf(filename, sizeof(filename), \"%s_kern.o\", argv[0]);\n\n\tobj = bpf_object__open_file(filename, NULL);\n\tif (libbpf_get_error(obj))\n\t\treturn 1;\n\n\tprog = bpf_object__next_program(obj, NULL);\n\tbpf_program__set_type(prog, BPF_PROG_TYPE_XDP);\n\n\terr = bpf_object__load(obj);\n\tif (err)\n\t\treturn 1;\n\n\tprog_fd = bpf_program__fd(prog);\n\n\t \n\tif (max_pckt_size) {\n\t\tmap_fd = bpf_object__find_map_fd_by_name(obj, \"xdp_adju.data\");\n\t\tif (map_fd < 0) {\n\t\t\tprintf(\"finding a max_pcktsz map in obj file failed\\n\");\n\t\t\treturn 1;\n\t\t}\n\t\tbpf_map_update_elem(map_fd, &key, &max_pckt_size, BPF_ANY);\n\t}\n\n\t \n\tmap_fd = bpf_object__find_map_fd_by_name(obj, \"icmpcnt\");\n\tif (map_fd < 0) {\n\t\tprintf(\"finding a icmpcnt map in obj file failed\\n\");\n\t\treturn 1;\n\t}\n\n\tsignal(SIGINT, int_exit);\n\tsignal(SIGTERM, int_exit);\n\n\tif (bpf_xdp_attach(ifindex, prog_fd, xdp_flags, NULL) < 0) {\n\t\tprintf(\"link set xdp fd failed\\n\");\n\t\treturn 1;\n\t}\n\n\terr = bpf_prog_get_info_by_fd(prog_fd, &info, &info_len);\n\tif (err) {\n\t\tprintf(\"can't get prog info - %s\\n\", strerror(errno));\n\t\treturn 1;\n\t}\n\tprog_id = info.id;\n\n\tpoll_stats(map_fd, kill_after_s);\n\tint_exit(0);\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}