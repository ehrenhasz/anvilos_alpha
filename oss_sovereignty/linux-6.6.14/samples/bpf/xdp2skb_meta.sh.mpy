{
  "module_name": "xdp2skb_meta.sh",
  "hash_id": "5eb49ec8c6abe50fa7c9da7dcbb9a4b67c451b20b1509a7933ed846c2326f22f",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/xdp2skb_meta.sh",
  "human_readable_source": "#!/bin/bash\n#\n# SPDX-License-Identifier: GPL-2.0\n# Copyright (c) 2018 Jesper Dangaard Brouer, Red Hat Inc.\n#\n# Bash-shell example on using iproute2 tools 'tc' and 'ip' to load\n# eBPF programs, both for XDP and clsbpf.  Shell script function\n# wrappers and even long options parsing is illustrated, for ease of\n# use.\n#\n# Related to sample/bpf/xdp2skb_meta_kern.c, which contains BPF-progs\n# that need to collaborate between XDP and TC hooks.  Thus, it is\n# convenient that the same tool load both programs that need to work\n# together.\n#\nBPF_FILE=xdp2skb_meta_kern.o\nDIR=$(dirname $0)\n\n[ -z \"$TC\" ] && TC=tc\n[ -z \"$IP\" ] && IP=ip\n\nfunction usage() {\n    echo \"\"\n    echo \"Usage: $0 [-vfh] --dev ethX\"\n    echo \"  -d | --dev     :             Network device (required)\"\n    echo \"  --flush        :             Cleanup flush TC and XDP progs\"\n    echo \"  --list         : (\\$LIST)     List TC and XDP progs\"\n    echo \"  -v | --verbose : (\\$VERBOSE)  Verbose\"\n    echo \"  --dry-run      : (\\$DRYRUN)   Dry-run only (echo commands)\"\n    echo \"\"\n}\n\n## -- General shell logging cmds --\nfunction err() {\n    local exitcode=$1\n    shift\n    echo \"ERROR: $@\" >&2\n    exit $exitcode\n}\n\nfunction info() {\n    if [[ -n \"$VERBOSE\" ]]; then\n\techo \"# $@\"\n    fi\n}\n\n## -- Helper function calls --\n\n# Wrapper call for TC and IP\n# - Will display the offending command on failure\nfunction _call_cmd() {\n    local cmd=\"$1\"\n    local allow_fail=\"$2\"\n    shift 2\n    if [[ -n \"$VERBOSE\" ]]; then\n\techo \"$cmd $@\"\n    fi\n    if [[ -n \"$DRYRUN\" ]]; then\n\treturn\n    fi\n    $cmd \"$@\"\n    local status=$?\n    if (( $status != 0 )); then\n\tif [[ \"$allow_fail\" == \"\" ]]; then\n\t    err 2 \"Exec error($status) occurred cmd: \\\"$cmd $@\\\"\"\n\tfi\n    fi\n}\nfunction call_tc() {\n    _call_cmd \"$TC\" \"\" \"$@\"\n}\nfunction call_tc_allow_fail() {\n    _call_cmd \"$TC\" \"allow_fail\" \"$@\"\n}\nfunction call_ip() {\n    _call_cmd \"$IP\" \"\" \"$@\"\n}\n\n##  --- Parse command line arguments / parameters ---\n# Using external program \"getopt\" to get --long-options\nOPTIONS=$(getopt -o vfhd: \\\n    --long verbose,flush,help,list,dev:,dry-run -- \"$@\")\nif (( $? != 0 )); then\n    err 4 \"Error calling getopt\"\nfi\neval set -- \"$OPTIONS\"\n\nunset DEV\nunset FLUSH\nwhile true; do\n    case \"$1\" in\n\t-d | --dev ) # device\n\t    DEV=$2\n\t    info \"Device set to: DEV=$DEV\" >&2\n\t    shift 2\n\t    ;;\n\t-v | --verbose)\n\t    VERBOSE=yes\n\t    # info \"Verbose mode: VERBOSE=$VERBOSE\" >&2\n\t    shift\n\t    ;;\n\t--dry-run )\n\t    DRYRUN=yes\n\t    VERBOSE=yes\n\t    info \"Dry-run mode: enable VERBOSE and don't call TC+IP\" >&2\n\t    shift\n            ;;\n\t-f | --flush )\n\t    FLUSH=yes\n\t    shift\n\t    ;;\n\t--list )\n\t    LIST=yes\n\t    shift\n\t    ;;\n\t-- )\n\t    shift\n\t    break\n\t    ;;\n\t-h | --help )\n\t    usage;\n\t    exit 0\n\t    ;;\n\t* )\n\t    shift\n\t    break\n\t    ;;\n    esac\ndone\n\nFILE=\"$DIR/$BPF_FILE\"\nif [[ ! -e $FILE ]]; then\n    err 3 \"Missing BPF object file ($FILE)\"\nfi\n\nif [[ -z $DEV ]]; then\n    usage\n    err 2 \"Please specify network device -- required option --dev\"\nfi\n\n## -- Function calls --\n\nfunction list_tc()\n{\n    local device=\"$1\"\n    shift\n    info \"Listing current TC ingress rules\"\n    call_tc filter show dev $device ingress\n}\n\nfunction list_xdp()\n{\n    local device=\"$1\"\n    shift\n    info \"Listing current XDP device($device) setting\"\n    call_ip link show dev $device | grep --color=auto xdp\n}\n\nfunction flush_tc()\n{\n    local device=\"$1\"\n    shift\n    info \"Flush TC on device: $device\"\n    call_tc_allow_fail filter del dev $device ingress\n    call_tc_allow_fail qdisc del dev $device clsact\n}\n\nfunction flush_xdp()\n{\n    local device=\"$1\"\n    shift\n    info \"Flush XDP on device: $device\"\n    call_ip link set dev $device xdp off\n}\n\nfunction attach_tc_mark()\n{\n    local device=\"$1\"\n    local file=\"$2\"\n    local prog=\"tc_mark\"\n    shift 2\n\n    # Re-attach clsact to clear/flush existing role\n    call_tc_allow_fail qdisc del dev $device clsact 2> /dev/null\n    call_tc            qdisc add dev $device clsact\n\n    # Attach BPF prog\n    call_tc filter add dev $device ingress \\\n\t    prio 1 handle 1 bpf da obj $file sec $prog\n}\n\nfunction attach_xdp_mark()\n{\n    local device=\"$1\"\n    local file=\"$2\"\n    local prog=\"xdp_mark\"\n    shift 2\n\n    # Remove XDP prog in-case it's already loaded\n    # TODO: Need ip-link option to override/replace existing XDP prog\n    flush_xdp $device\n\n    # Attach XDP/BPF prog\n    call_ip link set dev $device xdp obj $file sec $prog\n}\n\nif [[ -n $FLUSH ]]; then\n    flush_tc  $DEV\n    flush_xdp $DEV\n    exit 0\nfi\n\nif [[ -n $LIST ]]; then\n    list_tc  $DEV\n    list_xdp $DEV\n    exit 0\nfi\n\nattach_tc_mark  $DEV $FILE\nattach_xdp_mark $DEV $FILE\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}