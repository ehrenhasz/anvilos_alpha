{
  "module_name": "tc_l2_redirect.sh",
  "hash_id": "15b193b008337b0039a66351fa2bea7709be84a8e67ad580c22effe1b6bd8163",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/tc_l2_redirect.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n[[ -z $TC ]] && TC='tc'\n[[ -z $IP ]] && IP='ip'\n\nREDIRECT_USER='./tc_l2_redirect'\nREDIRECT_BPF='./tc_l2_redirect_kern.o'\n\nRP_FILTER=$(< /proc/sys/net/ipv4/conf/all/rp_filter)\nIPV6_DISABLED=$(< /proc/sys/net/ipv6/conf/all/disable_ipv6)\nIPV6_FORWARDING=$(< /proc/sys/net/ipv6/conf/all/forwarding)\n\nfunction config_common {\n\tlocal tun_type=$1\n\n\t$IP netns add ns1\n\t$IP netns add ns2\n\t$IP link add ve1 type veth peer name vens1\n\t$IP link add ve2 type veth peer name vens2\n\t$IP link set dev ve1 up\n\t$IP link set dev ve2 up\n\t$IP link set dev ve1 mtu 1500\n\t$IP link set dev ve2 mtu 1500\n\t$IP link set dev vens1 netns ns1\n\t$IP link set dev vens2 netns ns2\n\n\t$IP -n ns1 link set dev lo up\n\t$IP -n ns1 link set dev vens1 up\n\t$IP -n ns1 addr add 10.1.1.101/24 dev vens1\n\t$IP -n ns1 addr add 2401:db01::65/64 dev vens1 nodad\n\t$IP -n ns1 route add default via 10.1.1.1 dev vens1\n\t$IP -n ns1 route add default via 2401:db01::1 dev vens1\n\n\t$IP -n ns2 link set dev lo up\n\t$IP -n ns2 link set dev vens2 up\n\t$IP -n ns2 addr add 10.2.1.102/24 dev vens2\n\t$IP -n ns2 addr add 2401:db02::66/64 dev vens2 nodad\n\t$IP -n ns2 addr add 10.10.1.102 dev lo\n\t$IP -n ns2 addr add 2401:face::66/64 dev lo nodad\n\t$IP -n ns2 link add ipt2 type ipip local 10.2.1.102 remote 10.2.1.1\n\t$IP -n ns2 link add ip6t2 type ip6tnl mode any local 2401:db02::66 remote 2401:db02::1\n\t$IP -n ns2 link set dev ipt2 up\n\t$IP -n ns2 link set dev ip6t2 up\n\t$IP netns exec ns2 $TC qdisc add dev vens2 clsact\n\t$IP netns exec ns2 $TC filter add dev vens2 ingress bpf da obj $REDIRECT_BPF sec drop_non_tun_vip\n\tif [[ $tun_type == \"ipip\" ]]; then\n\t\t$IP -n ns2 route add 10.1.1.0/24 dev ipt2\n\t\t$IP netns exec ns2 sysctl -q -w net.ipv4.conf.all.rp_filter=0\n\t\t$IP netns exec ns2 sysctl -q -w net.ipv4.conf.ipt2.rp_filter=0\n\telse\n\t\t$IP -n ns2 route add 10.1.1.0/24 dev ip6t2\n\t\t$IP -n ns2 route add 2401:db01::/64 dev ip6t2\n\t\t$IP netns exec ns2 sysctl -q -w net.ipv4.conf.all.rp_filter=0\n\t\t$IP netns exec ns2 sysctl -q -w net.ipv4.conf.ip6t2.rp_filter=0\n\tfi\n\n\t$IP addr add 10.1.1.1/24 dev ve1\n\t$IP addr add 2401:db01::1/64 dev ve1 nodad\n\t$IP addr add 10.2.1.1/24 dev ve2\n\t$IP addr add 2401:db02::1/64 dev ve2 nodad\n\n\t$TC qdisc add dev ve2 clsact\n\t$TC filter add dev ve2 ingress bpf da obj $REDIRECT_BPF sec l2_to_iptun_ingress_forward\n\n\tsysctl -q -w net.ipv4.conf.all.rp_filter=0\n\tsysctl -q -w net.ipv6.conf.all.forwarding=1\n\tsysctl -q -w net.ipv6.conf.all.disable_ipv6=0\n}\n\nfunction cleanup {\n\tset +e\n\t[[ -z $DEBUG ]] || set +x\n\t$IP netns delete ns1 >& /dev/null\n\t$IP netns delete ns2 >& /dev/null\n\t$IP link del ve1 >& /dev/null\n\t$IP link del ve2 >& /dev/null\n\t$IP link del ipt >& /dev/null\n\t$IP link del ip6t >& /dev/null\n\tsysctl -q -w net.ipv4.conf.all.rp_filter=$RP_FILTER\n\tsysctl -q -w net.ipv6.conf.all.forwarding=$IPV6_FORWARDING\n\tsysctl -q -w net.ipv6.conf.all.disable_ipv6=$IPV6_DISABLED\n\trm -f /sys/fs/bpf/tc/globals/tun_iface\n\t[[ -z $DEBUG ]] || set -x\n\tset -e\n}\n\nfunction l2_to_ipip {\n\techo -n \"l2_to_ipip $1: \"\n\n\tlocal dir=$1\n\n\tconfig_common ipip\n\n\t$IP link add ipt type ipip external\n\t$IP link set dev ipt up\n\tsysctl -q -w net.ipv4.conf.ipt.rp_filter=0\n\tsysctl -q -w net.ipv4.conf.ipt.forwarding=1\n\n\tif [[ $dir == \"egress\" ]]; then\n\t\t$IP route add 10.10.1.0/24 via 10.2.1.102 dev ve2\n\t\t$TC filter add dev ve2 egress bpf da obj $REDIRECT_BPF sec l2_to_iptun_ingress_redirect\n\t\tsysctl -q -w net.ipv4.conf.ve1.forwarding=1\n\telse\n\t\t$TC qdisc add dev ve1 clsact\n\t\t$TC filter add dev ve1 ingress bpf da obj $REDIRECT_BPF sec l2_to_iptun_ingress_redirect\n\tfi\n\n\t$REDIRECT_USER -U /sys/fs/bpf/tc/globals/tun_iface -i $(< /sys/class/net/ipt/ifindex)\n\n\t$IP netns exec ns1 ping -c1 10.10.1.102 >& /dev/null\n\n\tif [[ $dir == \"egress\" ]]; then\n\t\t# test direct egress to ve2 (i.e. not forwarding from\n\t\t# ve1 to ve2).\n\t\tping -c1 10.10.1.102 >& /dev/null\n\tfi\n\n\tcleanup\n\n\techo \"OK\"\n}\n\nfunction l2_to_ip6tnl {\n\techo -n \"l2_to_ip6tnl $1: \"\n\n\tlocal dir=$1\n\n\tconfig_common ip6tnl\n\n\t$IP link add ip6t type ip6tnl mode any external\n\t$IP link set dev ip6t up\n\tsysctl -q -w net.ipv4.conf.ip6t.rp_filter=0\n\tsysctl -q -w net.ipv4.conf.ip6t.forwarding=1\n\n\tif [[ $dir == \"egress\" ]]; then\n\t\t$IP route add 10.10.1.0/24 via 10.2.1.102 dev ve2\n\t\t$IP route add 2401:face::/64 via 2401:db02::66 dev ve2\n\t\t$TC filter add dev ve2 egress bpf da obj $REDIRECT_BPF sec l2_to_ip6tun_ingress_redirect\n\t\tsysctl -q -w net.ipv4.conf.ve1.forwarding=1\n\telse\n\t\t$TC qdisc add dev ve1 clsact\n\t\t$TC filter add dev ve1 ingress bpf da obj $REDIRECT_BPF sec l2_to_ip6tun_ingress_redirect\n\tfi\n\n\t$REDIRECT_USER -U /sys/fs/bpf/tc/globals/tun_iface -i $(< /sys/class/net/ip6t/ifindex)\n\n\t$IP netns exec ns1 ping -c1 10.10.1.102 >& /dev/null\n\t$IP netns exec ns1 ping -6 -c1 2401:face::66 >& /dev/null\n\n\tif [[ $dir == \"egress\" ]]; then\n\t\t# test direct egress to ve2 (i.e. not forwarding from\n\t\t# ve1 to ve2).\n\t\tping -c1 10.10.1.102 >& /dev/null\n\t\tping -6 -c1 2401:face::66 >& /dev/null\n\tfi\n\n\tcleanup\n\n\techo \"OK\"\n}\n\ncleanup\ntest_names=\"l2_to_ipip l2_to_ip6tnl\"\ntest_dirs=\"ingress egress\"\nif [[ $# -ge 2 ]]; then\n\ttest_names=$1\n\ttest_dirs=$2\nelif [[ $# -ge 1 ]]; then\n\ttest_names=$1\nfi\n\nfor t in $test_names; do\n\tfor d in $test_dirs; do\n\t\t$t $d\n\tdone\ndone\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}