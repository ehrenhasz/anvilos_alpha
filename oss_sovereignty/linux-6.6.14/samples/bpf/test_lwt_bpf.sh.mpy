{
  "module_name": "test_lwt_bpf.sh",
  "hash_id": "ea51026e36c0da41f25b8cab3be3bb55a3e4afe870940265b95cbd4d306ae074",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/test_lwt_bpf.sh",
  "human_readable_source": "#!/bin/bash\n# SPDX-License-Identifier: GPL-2.0\n\n# Uncomment to see generated bytecode\n#VERBOSE=verbose\n\nNS1=lwt_ns1\nNS2=lwt_ns2\nVETH0=tst_lwt1a\nVETH1=tst_lwt1b\nVETH2=tst_lwt2a\nVETH3=tst_lwt2b\nIPVETH0=\"192.168.254.1\"\nIPVETH1=\"192.168.254.2\"\nIPVETH1b=\"192.168.254.3\"\n\nIPVETH2=\"192.168.111.1\"\nIPVETH3=\"192.168.111.2\"\n\nIP_LOCAL=\"192.168.99.1\"\n\nPROG_SRC=\"test_lwt_bpf.c\"\nBPF_PROG=\"test_lwt_bpf.o\"\nTRACE_ROOT=/sys/kernel/tracing\nCONTEXT_INFO=$(cat ${TRACE_ROOT}/trace_options | grep context)\n\nfunction lookup_mac()\n{\n\tset +x\n\tif [ ! -z \"$2\" ]; then\n\t\tMAC=$(ip netns exec $2 ip link show $1 | grep ether | awk '{print $2}')\n\telse\n\t\tMAC=$(ip link show $1 | grep ether | awk '{print $2}')\n\tfi\n\tMAC=\"${MAC//:/}\"\n\techo \"0x${MAC:10:2}${MAC:8:2}${MAC:6:2}${MAC:4:2}${MAC:2:2}${MAC:0:2}\"\n\tset -x\n}\n\nfunction cleanup {\n\tset +ex\n\trm $BPF_PROG 2> /dev/null\n\tip link del $VETH0 2> /dev/null\n\tip link del $VETH1 2> /dev/null\n\tip link del $VETH2 2> /dev/null\n\tip link del $VETH3 2> /dev/null\n\tip netns exec $NS1 killall netserver\n\tip netns delete $NS1 2> /dev/null\n\tip netns delete $NS2 2> /dev/null\n\tset -ex\n}\n\nfunction setup_one_veth {\n\tip netns add $1\n\tip link add $2 type veth peer name $3\n\tip link set dev $2 up\n\tip addr add $4/24 dev $2\n\tip link set $3 netns $1\n\tip netns exec $1 ip link set dev $3 up\n\tip netns exec $1 ip addr add $5/24 dev $3\n\n\tif [ \"$6\" ]; then\n\t\tip netns exec $1 ip addr add $6/32 dev $3\n\tfi\n}\n\nfunction get_trace {\n\tset +x\n\tcat ${TRACE_ROOT}/trace | grep -v '^#'\n\tset -x\n}\n\nfunction cleanup_routes {\n\tip route del ${IPVETH1}/32 dev $VETH0 2> /dev/null || true\n\tip route del table local local ${IP_LOCAL}/32 dev lo 2> /dev/null || true\n}\n\nfunction install_test {\n\tcleanup_routes\n\tcp /dev/null ${TRACE_ROOT}/trace\n\n\tOPTS=\"encap bpf headroom 14 $1 obj $BPF_PROG section $2 $VERBOSE\"\n\n\tif [ \"$1\" == \"in\" ];  then\n\t\tip route add table local local ${IP_LOCAL}/32 $OPTS dev lo\n\telse\n\t\tip route add ${IPVETH1}/32 $OPTS dev $VETH0\n\tfi\n}\n\nfunction remove_prog {\n\tif [ \"$1\" == \"in\" ];  then\n\t\tip route del table local local ${IP_LOCAL}/32 dev lo\n\telse\n\t\tip route del ${IPVETH1}/32 dev $VETH0\n\tfi\n}\n\nfunction filter_trace {\n\t# Add newline to allow starting EXPECT= variables on newline\n\tNL=$'\\n'\n\techo \"${NL}$*\" | sed -e 's/bpf_trace_printk: //g'\n}\n\nfunction expect_fail {\n\tset +x\n\techo \"FAIL:\"\n\techo \"Expected: $1\"\n\techo \"Got: $2\"\n\tset -x\n\texit 1\n}\n\nfunction match_trace {\n\tset +x\n\tRET=0\n\tTRACE=$1\n\tEXPECT=$2\n\tGOT=\"$(filter_trace \"$TRACE\")\"\n\n\t[ \"$GOT\" != \"$EXPECT\" ] && {\n\t\texpect_fail \"$EXPECT\" \"$GOT\"\n\t\tRET=1\n\t}\n\tset -x\n\treturn $RET\n}\n\nfunction test_start {\n\tset +x\n\techo \"----------------------------------------------------------------\"\n\techo \"Starting test: $*\"\n\techo \"----------------------------------------------------------------\"\n\tset -x\n}\n\nfunction failure {\n\tget_trace\n\techo \"FAIL: $*\"\n\texit 1\n}\n\nfunction test_ctx_xmit {\n\ttest_start \"test_ctx on lwt xmit\"\n\tinstall_test xmit test_ctx\n\tping -c 3 $IPVETH1 || {\n\t\tfailure \"test_ctx xmit: packets are dropped\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 0 ifindex $DST_IFINDEX\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 0 ifindex $DST_IFINDEX\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 0 ifindex $DST_IFINDEX\" || exit 1\n\tremove_prog xmit\n}\n\nfunction test_ctx_out {\n\ttest_start \"test_ctx on lwt out\"\n\tinstall_test out test_ctx\n\tping -c 3 $IPVETH1 || {\n\t\tfailure \"test_ctx out: packets are dropped\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 0 ifindex 0\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 0 ifindex 0\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 0 ifindex 0\" || exit 1\n\tremove_prog out\n}\n\nfunction test_ctx_in {\n\ttest_start \"test_ctx on lwt in\"\n\tinstall_test in test_ctx\n\tping -c 3 $IP_LOCAL || {\n\t\tfailure \"test_ctx out: packets are dropped\"\n\t}\n\t# We will both request & reply packets as the packets will\n\t# be from $IP_LOCAL => $IP_LOCAL\n\tmatch_trace \"$(get_trace)\" \"\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 1 ifindex 1\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 1 ifindex 1\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 1 ifindex 1\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 1 ifindex 1\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 1 ifindex 1\nlen 84 hash 0 protocol 8\ncb 1234 ingress_ifindex 1 ifindex 1\" || exit 1\n\tremove_prog in\n}\n\nfunction test_data {\n\ttest_start \"test_data on lwt $1\"\n\tinstall_test $1 test_data\n\tping -c 3 $IPVETH1 || {\n\t\tfailure \"test_data ${1}: packets are dropped\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\nsrc: 1fea8c0 dst: 2fea8c0\nsrc: 1fea8c0 dst: 2fea8c0\nsrc: 1fea8c0 dst: 2fea8c0\" || exit 1\n\tremove_prog $1\n}\n\nfunction test_data_in {\n\ttest_start \"test_data on lwt in\"\n\tinstall_test in test_data\n\tping -c 3 $IP_LOCAL || {\n\t\tfailure \"test_data in: packets are dropped\"\n\t}\n\t# We will both request & reply packets as the packets will\n\t# be from $IP_LOCAL => $IP_LOCAL\n\tmatch_trace \"$(get_trace)\" \"\nsrc: 163a8c0 dst: 163a8c0\nsrc: 163a8c0 dst: 163a8c0\nsrc: 163a8c0 dst: 163a8c0\nsrc: 163a8c0 dst: 163a8c0\nsrc: 163a8c0 dst: 163a8c0\nsrc: 163a8c0 dst: 163a8c0\" || exit 1\n\tremove_prog in\n}\n\nfunction test_cb {\n\ttest_start \"test_cb on lwt $1\"\n\tinstall_test $1 test_cb\n\tping -c 3 $IPVETH1 || {\n\t\tfailure \"test_cb ${1}: packets are dropped\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\ncb0: 0 cb1: 0 cb2: 0\ncb3: 0 cb4: 0\ncb0: 0 cb1: 0 cb2: 0\ncb3: 0 cb4: 0\ncb0: 0 cb1: 0 cb2: 0\ncb3: 0 cb4: 0\" || exit 1\n\tremove_prog $1\n}\n\nfunction test_cb_in {\n\ttest_start \"test_cb on lwt in\"\n\tinstall_test in test_cb\n\tping -c 3 $IP_LOCAL || {\n\t\tfailure \"test_cb in: packets are dropped\"\n\t}\n\t# We will both request & reply packets as the packets will\n\t# be from $IP_LOCAL => $IP_LOCAL\n\tmatch_trace \"$(get_trace)\" \"\ncb0: 0 cb1: 0 cb2: 0\ncb3: 0 cb4: 0\ncb0: 0 cb1: 0 cb2: 0\ncb3: 0 cb4: 0\ncb0: 0 cb1: 0 cb2: 0\ncb3: 0 cb4: 0\ncb0: 0 cb1: 0 cb2: 0\ncb3: 0 cb4: 0\ncb0: 0 cb1: 0 cb2: 0\ncb3: 0 cb4: 0\ncb0: 0 cb1: 0 cb2: 0\ncb3: 0 cb4: 0\" || exit 1\n\tremove_prog in\n}\n\nfunction test_drop_all {\n\ttest_start \"test_drop_all on lwt $1\"\n\tinstall_test $1 drop_all\n\tping -c 3 $IPVETH1 && {\n\t\tfailure \"test_drop_all ${1}: Unexpected success of ping\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\ndropping with: 2\ndropping with: 2\ndropping with: 2\" || exit 1\n\tremove_prog $1\n}\n\nfunction test_drop_all_in {\n\ttest_start \"test_drop_all on lwt in\"\n\tinstall_test in drop_all\n\tping -c 3 $IP_LOCAL && {\n\t\tfailure \"test_drop_all in: Unexpected success of ping\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\ndropping with: 2\ndropping with: 2\ndropping with: 2\" || exit 1\n\tremove_prog in\n}\n\nfunction test_push_ll_and_redirect {\n\ttest_start \"test_push_ll_and_redirect on lwt xmit\"\n\tinstall_test xmit push_ll_and_redirect\n\tping -c 3 $IPVETH1 || {\n\t\tfailure \"Redirected packets appear to be dropped\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\nredirected to $DST_IFINDEX\nredirected to $DST_IFINDEX\nredirected to $DST_IFINDEX\" || exit 1\n\tremove_prog xmit\n}\n\nfunction test_no_l2_and_redirect {\n\ttest_start \"test_no_l2_and_redirect on lwt xmit\"\n\tinstall_test xmit fill_garbage_and_redirect\n\tping -c 3 $IPVETH1 && {\n\t\tfailure \"Unexpected success despite lack of L2 header\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\nredirected to $DST_IFINDEX\nredirected to $DST_IFINDEX\nredirected to $DST_IFINDEX\" || exit 1\n\tremove_prog xmit\n}\n\nfunction test_rewrite {\n\ttest_start \"test_rewrite on lwt xmit\"\n\tinstall_test xmit test_rewrite\n\tping -c 3 $IPVETH1 || {\n\t\tfailure \"Rewritten packets appear to be dropped\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\nout: rewriting from 2fea8c0 to 3fea8c0\nout: rewriting from 2fea8c0 to 3fea8c0\nout: rewriting from 2fea8c0 to 3fea8c0\" || exit 1\n\tremove_prog out\n}\n\nfunction test_fill_garbage {\n\ttest_start \"test_fill_garbage on lwt xmit\"\n\tinstall_test xmit fill_garbage\n\tping -c 3 $IPVETH1 && {\n\t\tfailure \"test_drop_all ${1}: Unexpected success of ping\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\nSet initial 96 bytes of header to FF\nSet initial 96 bytes of header to FF\nSet initial 96 bytes of header to FF\" || exit 1\n\tremove_prog xmit\n}\n\nfunction test_netperf_nop {\n\ttest_start \"test_netperf_nop on lwt xmit\"\n\tinstall_test xmit nop\n\tnetperf -H $IPVETH1 -t TCP_STREAM || {\n\t\tfailure \"packets appear to be dropped\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\"|| exit 1\n\tremove_prog xmit\n}\n\nfunction test_netperf_redirect {\n\ttest_start \"test_netperf_redirect on lwt xmit\"\n\tinstall_test xmit push_ll_and_redirect_silent\n\tnetperf -H $IPVETH1 -t TCP_STREAM || {\n\t\tfailure \"Rewritten packets appear to be dropped\"\n\t}\n\tmatch_trace \"$(get_trace)\" \"\"|| exit 1\n\tremove_prog xmit\n}\n\ncleanup\nsetup_one_veth $NS1 $VETH0 $VETH1 $IPVETH0 $IPVETH1 $IPVETH1b\nsetup_one_veth $NS2 $VETH2 $VETH3 $IPVETH2 $IPVETH3\nip netns exec $NS1 netserver\necho 1 > ${TRACE_ROOT}/tracing_on\necho nocontext-info > ${TRACE_ROOT}/trace_options\n\nDST_MAC=$(lookup_mac $VETH1 $NS1)\nSRC_MAC=$(lookup_mac $VETH0)\nDST_IFINDEX=$(cat /sys/class/net/$VETH0/ifindex)\n\nCLANG_OPTS=\"-O2 --target=bpf -I ../include/\"\nCLANG_OPTS+=\" -DSRC_MAC=$SRC_MAC -DDST_MAC=$DST_MAC -DDST_IFINDEX=$DST_IFINDEX\"\nclang $CLANG_OPTS -c $PROG_SRC -o $BPF_PROG\n\ntest_ctx_xmit\ntest_ctx_out\ntest_ctx_in\ntest_data \"xmit\"\ntest_data \"out\"\ntest_data_in\ntest_cb \"xmit\"\ntest_cb \"out\"\ntest_cb_in\ntest_drop_all \"xmit\"\ntest_drop_all \"out\"\ntest_drop_all_in\ntest_rewrite\ntest_push_ll_and_redirect\ntest_no_l2_and_redirect\ntest_fill_garbage\ntest_netperf_nop\ntest_netperf_redirect\n\ncleanup\necho 0 > ${TRACE_ROOT}/tracing_on\necho $CONTEXT_INFO > ${TRACE_ROOT}/trace_options\nexit 0\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}