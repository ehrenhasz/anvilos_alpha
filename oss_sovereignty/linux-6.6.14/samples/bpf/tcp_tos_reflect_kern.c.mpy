{
  "module_name": "tcp_tos_reflect_kern.c",
  "hash_id": "adeb349291f4c2df052af04f5335fd3036b02d6c0384b36feb1f4c9fba3f3d29",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/tcp_tos_reflect_kern.c",
  "human_readable_source": "\n \n\n#include <uapi/linux/bpf.h>\n#include <uapi/linux/tcp.h>\n#include <uapi/linux/if_ether.h>\n#include <uapi/linux/if_packet.h>\n#include <uapi/linux/ip.h>\n#include <uapi/linux/ipv6.h>\n#include <uapi/linux/in.h>\n#include <linux/socket.h>\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_endian.h>\n\n#define DEBUG 1\n\nSEC(\"sockops\")\nint bpf_basertt(struct bpf_sock_ops *skops)\n{\n\tchar header[sizeof(struct ipv6hdr)];\n\tstruct ipv6hdr *hdr6;\n\tstruct iphdr *hdr;\n\tint hdr_size = 0;\n\tint save_syn = 1;\n\tint tos = 0;\n\tint rv = 0;\n\tint op;\n\n\top = (int) skops->op;\n\n#ifdef DEBUG\n\tbpf_printk(\"BPF command: %d\\n\", op);\n#endif\n\tswitch (op) {\n\tcase BPF_SOCK_OPS_TCP_LISTEN_CB:\n\t\trv = bpf_setsockopt(skops, SOL_TCP, TCP_SAVE_SYN,\n\t\t\t\t   &save_syn, sizeof(save_syn));\n\t\tbreak;\n\tcase BPF_SOCK_OPS_PASSIVE_ESTABLISHED_CB:\n\t\tif (skops->family == AF_INET)\n\t\t\thdr_size = sizeof(struct iphdr);\n\t\telse\n\t\t\thdr_size = sizeof(struct ipv6hdr);\n\t\trv = bpf_getsockopt(skops, SOL_TCP, TCP_SAVED_SYN,\n\t\t\t\t    header, hdr_size);\n\t\tif (!rv) {\n\t\t\tif (skops->family == AF_INET) {\n\t\t\t\thdr = (struct iphdr *) header;\n\t\t\t\ttos = hdr->tos;\n\t\t\t\tif (tos != 0)\n\t\t\t\t\tbpf_setsockopt(skops, SOL_IP, IP_TOS,\n\t\t\t\t\t\t       &tos, sizeof(tos));\n\t\t\t} else {\n\t\t\t\thdr6 = (struct ipv6hdr *) header;\n\t\t\t\ttos = ((hdr6->priority) << 4 |\n\t\t\t\t       (hdr6->flow_lbl[0]) >>  4);\n\t\t\t\tif (tos)\n\t\t\t\t\tbpf_setsockopt(skops, SOL_IPV6,\n\t\t\t\t\t\t       IPV6_TCLASS,\n\t\t\t\t\t\t       &tos, sizeof(tos));\n\t\t\t}\n\t\t\trv = 0;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\trv = -1;\n\t}\n#ifdef DEBUG\n\tbpf_printk(\"Returning %d\\n\", rv);\n#endif\n\tskops->reply = rv;\n\treturn 1;\n}\nchar _license[] SEC(\"license\") = \"GPL\";\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}