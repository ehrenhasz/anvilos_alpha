{
  "module_name": "sock_example.c",
  "hash_id": "c43c2e229817568613bb260625415add3cb69a0fa37689d4d09244f554015ffc",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/sock_example.c",
  "human_readable_source": " \n#include <stdio.h>\n#include <unistd.h>\n#include <assert.h>\n#include <linux/bpf.h>\n#include <string.h>\n#include <stdlib.h>\n#include <errno.h>\n#include <sys/socket.h>\n#include <arpa/inet.h>\n#include <linux/if_ether.h>\n#include <linux/ip.h>\n#include <stddef.h>\n#include <bpf/bpf.h>\n#include \"bpf_insn.h\"\n#include \"sock_example.h\"\n#include \"bpf_util.h\"\n\nchar bpf_log_buf[BPF_LOG_BUF_SIZE];\n\nstatic int test_sock(void)\n{\n\tint sock = -1, map_fd, prog_fd, i, key;\n\tlong long value = 0, tcp_cnt, udp_cnt, icmp_cnt;\n\n\tmap_fd = bpf_map_create(BPF_MAP_TYPE_ARRAY, NULL, sizeof(key), sizeof(value),\n\t\t\t\t256, NULL);\n\tif (map_fd < 0) {\n\t\tprintf(\"failed to create map '%s'\\n\", strerror(errno));\n\t\tgoto cleanup;\n\t}\n\n\tstruct bpf_insn prog[] = {\n\t\tBPF_MOV64_REG(BPF_REG_6, BPF_REG_1),\n\t\tBPF_LD_ABS(BPF_B, ETH_HLEN + offsetof(struct iphdr, protocol)  ),\n\t\tBPF_STX_MEM(BPF_W, BPF_REG_10, BPF_REG_0, -4),  \n\t\tBPF_MOV64_REG(BPF_REG_2, BPF_REG_10),\n\t\tBPF_ALU64_IMM(BPF_ADD, BPF_REG_2, -4),  \n\t\tBPF_LD_MAP_FD(BPF_REG_1, map_fd),\n\t\tBPF_RAW_INSN(BPF_JMP | BPF_CALL, 0, 0, 0, BPF_FUNC_map_lookup_elem),\n\t\tBPF_JMP_IMM(BPF_JEQ, BPF_REG_0, 0, 2),\n\t\tBPF_MOV64_IMM(BPF_REG_1, 1),  \n\t\tBPF_ATOMIC_OP(BPF_DW, BPF_ADD, BPF_REG_0, BPF_REG_1, 0),\n\t\tBPF_MOV64_IMM(BPF_REG_0, 0),  \n\t\tBPF_EXIT_INSN(),\n\t};\n\tsize_t insns_cnt = ARRAY_SIZE(prog);\n\tLIBBPF_OPTS(bpf_prog_load_opts, opts,\n\t\t.log_buf = bpf_log_buf,\n\t\t.log_size = BPF_LOG_BUF_SIZE,\n\t);\n\n\tprog_fd = bpf_prog_load(BPF_PROG_TYPE_SOCKET_FILTER, NULL, \"GPL\",\n\t\t\t\tprog, insns_cnt, &opts);\n\tif (prog_fd < 0) {\n\t\tprintf(\"failed to load prog '%s'\\n\", strerror(errno));\n\t\tgoto cleanup;\n\t}\n\n\tsock = open_raw_sock(\"lo\");\n\n\tif (setsockopt(sock, SOL_SOCKET, SO_ATTACH_BPF, &prog_fd,\n\t\t       sizeof(prog_fd)) < 0) {\n\t\tprintf(\"setsockopt %s\\n\", strerror(errno));\n\t\tgoto cleanup;\n\t}\n\n\tfor (i = 0; i < 10; i++) {\n\t\tkey = IPPROTO_TCP;\n\t\tassert(bpf_map_lookup_elem(map_fd, &key, &tcp_cnt) == 0);\n\n\t\tkey = IPPROTO_UDP;\n\t\tassert(bpf_map_lookup_elem(map_fd, &key, &udp_cnt) == 0);\n\n\t\tkey = IPPROTO_ICMP;\n\t\tassert(bpf_map_lookup_elem(map_fd, &key, &icmp_cnt) == 0);\n\n\t\tprintf(\"TCP %lld UDP %lld ICMP %lld packets\\n\",\n\t\t       tcp_cnt, udp_cnt, icmp_cnt);\n\t\tsleep(1);\n\t}\n\ncleanup:\n\t \n\treturn 0;\n}\n\nint main(void)\n{\n\tFILE *f;\n\n\tf = popen(\"ping -4 -c5 localhost\", \"r\");\n\t(void)f;\n\n\treturn test_sock();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}