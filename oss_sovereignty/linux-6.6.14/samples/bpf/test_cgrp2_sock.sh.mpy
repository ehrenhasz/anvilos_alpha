{
  "module_name": "test_cgrp2_sock.sh",
  "hash_id": "a0d054a581ac50030201ee00447735f069e2da2f551464cae30edc9cce674b83",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/test_cgrp2_sock.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n\n# Test various socket options that can be set by attaching programs to cgroups.\n\nMY_DIR=$(dirname $0)\nTEST=$MY_DIR/test_cgrp2_sock\nCGRP_MNT=\"/tmp/cgroupv2-test_cgrp2_sock\"\n\n################################################################################\n#\nprint_result()\n{\n\tlocal rc=$1\n\tlocal status=\" OK \"\n\n\t[ $rc -ne 0 ] && status=\"FAIL\"\n\n\tprintf \"%-50s    [%4s]\\n\" \"$2\" \"$status\"\n}\n\ncheck_sock()\n{\n\tout=$($TEST)\n\techo $out | grep -q \"$1\"\n\tif [ $? -ne 0 ]; then\n\t\tprint_result 1 \"IPv4: $2\"\n\t\techo \"    expected: $1\"\n\t\techo \"        have: $out\"\n\t\trc=1\n\telse\n\t\tprint_result 0 \"IPv4: $2\"\n\tfi\n}\n\ncheck_sock6()\n{\n\tout=$($TEST -6)\n\techo $out | grep -q \"$1\"\n\tif [ $? -ne 0 ]; then\n\t\tprint_result 1 \"IPv6: $2\"\n\t\techo \"    expected: $1\"\n\t\techo \"        have: $out\"\n\t\trc=1\n\telse\n\t\tprint_result 0 \"IPv6: $2\"\n\tfi\n}\n\n################################################################################\n#\n\ncleanup()\n{\n\techo $$ >> ${CGRP_MNT}/cgroup.procs\n\trmdir ${CGRP_MNT}/sockopts\n}\n\ncleanup_and_exit()\n{\n\tlocal rc=$1\n\tlocal msg=\"$2\"\n\n\t[ -n \"$msg\" ] && echo \"ERROR: $msg\"\n\n\t$TEST -d ${CGRP_MNT}/sockopts\n\tip li del cgrp2_sock\n\tumount ${CGRP_MNT}\n\n\texit $rc\n}\n\n\n################################################################################\n# main\n\nrc=0\n\nip li add cgrp2_sock type dummy 2>/dev/null\n\nset -e\nmkdir -p ${CGRP_MNT}\nmount -t cgroup2 none ${CGRP_MNT}\nset +e\n\n\n# make sure we have a known start point\ncleanup 2>/dev/null\n\nmkdir -p ${CGRP_MNT}/sockopts\n[ $? -ne 0 ] && cleanup_and_exit 1 \"Failed to create cgroup hierarchy\"\n\n\n# set pid into cgroup\necho $$ > ${CGRP_MNT}/sockopts/cgroup.procs\n\n# no bpf program attached, so socket should show no settings\ncheck_sock \"dev , mark 0, priority 0\" \"No programs attached\"\ncheck_sock6 \"dev , mark 0, priority 0\" \"No programs attached\"\n\n# verify device is set\n#\n$TEST -b cgrp2_sock ${CGRP_MNT}/sockopts\nif [ $? -ne 0 ]; then\n\tcleanup_and_exit 1 \"Failed to install program to set device\"\nfi\ncheck_sock \"dev cgrp2_sock, mark 0, priority 0\" \"Device set\"\ncheck_sock6 \"dev cgrp2_sock, mark 0, priority 0\" \"Device set\"\n\n# verify mark is set\n#\n$TEST -m 666 ${CGRP_MNT}/sockopts\nif [ $? -ne 0 ]; then\n\tcleanup_and_exit 1 \"Failed to install program to set mark\"\nfi\ncheck_sock \"dev , mark 666, priority 0\" \"Mark set\"\ncheck_sock6 \"dev , mark 666, priority 0\" \"Mark set\"\n\n# verify priority is set\n#\n$TEST -p 123 ${CGRP_MNT}/sockopts\nif [ $? -ne 0 ]; then\n\tcleanup_and_exit 1 \"Failed to install program to set priority\"\nfi\ncheck_sock \"dev , mark 0, priority 123\" \"Priority set\"\ncheck_sock6 \"dev , mark 0, priority 123\" \"Priority set\"\n\n# all 3 at once\n#\n$TEST -b cgrp2_sock -m 666 -p 123 ${CGRP_MNT}/sockopts\nif [ $? -ne 0 ]; then\n\tcleanup_and_exit 1 \"Failed to install program to set device, mark and priority\"\nfi\ncheck_sock \"dev cgrp2_sock, mark 666, priority 123\" \"Priority set\"\ncheck_sock6 \"dev cgrp2_sock, mark 666, priority 123\" \"Priority set\"\n\ncleanup_and_exit $rc\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}