{
  "module_name": "tracex3.bpf.c",
  "hash_id": "42e0d3b80a9ecdbaab930952b7597f4b1d6ce9e46fe21c2b94f90a46f31d6d39",
  "original_prompt": "Ingested from linux-6.6.14/samples/bpf/tracex3.bpf.c",
  "human_readable_source": " \n#include \"vmlinux.h\"\n#include <linux/version.h>\n#include <bpf/bpf_helpers.h>\n#include <bpf/bpf_tracing.h>\n\nstruct start_key {\n\tdev_t dev;\n\tu32 _pad;\n\tsector_t sector;\n};\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_HASH);\n\t__type(key, long);\n\t__type(value, u64);\n\t__uint(max_entries, 4096);\n} my_map SEC(\".maps\");\n\n \nSEC(\"tracepoint/block/block_io_start\")\nint bpf_prog1(struct trace_event_raw_block_rq *ctx)\n{\n\tu64 val = bpf_ktime_get_ns();\n\tstruct start_key key = {\n\t\t.dev = ctx->dev,\n\t\t.sector = ctx->sector\n\t};\n\n\tbpf_map_update_elem(&my_map, &key, &val, BPF_ANY);\n\treturn 0;\n}\n\nstatic unsigned int log2l(unsigned long long n)\n{\n#define S(k) if (n >= (1ull << k)) { i += k; n >>= k; }\n\tint i = -(n == 0);\n\tS(32); S(16); S(8); S(4); S(2); S(1);\n\treturn i;\n#undef S\n}\n\n#define SLOTS 100\n\nstruct {\n\t__uint(type, BPF_MAP_TYPE_PERCPU_ARRAY);\n\t__uint(key_size, sizeof(u32));\n\t__uint(value_size, sizeof(u64));\n\t__uint(max_entries, SLOTS);\n} lat_map SEC(\".maps\");\n\n \nSEC(\"tracepoint/block/block_io_done\")\nint bpf_prog2(struct trace_event_raw_block_rq *ctx)\n{\n\tstruct start_key key = {\n\t\t.dev = ctx->dev,\n\t\t.sector = ctx->sector\n\t};\n\n\tu64 *value, l, base;\n\tu32 index;\n\n\tvalue = bpf_map_lookup_elem(&my_map, &key);\n\tif (!value)\n\t\treturn 0;\n\n\tu64 cur_time = bpf_ktime_get_ns();\n\tu64 delta = cur_time - *value;\n\n\tbpf_map_delete_elem(&my_map, &key);\n\n\t \n\tl = log2l(delta);\n\tbase = 1ll << l;\n\tindex = (l * 64 + (delta - base) * 64 / base) * 3 / 64;\n\n\tif (index >= SLOTS)\n\t\tindex = SLOTS - 1;\n\n\tvalue = bpf_map_lookup_elem(&lat_map, &index);\n\tif (value)\n\t\t*value += 1;\n\n\treturn 0;\n}\nchar _license[] SEC(\"license\") = \"GPL\";\nu32 _version SEC(\"version\") = LINUX_VERSION_CODE;\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}