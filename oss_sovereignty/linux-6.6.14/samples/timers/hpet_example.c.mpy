{
  "module_name": "hpet_example.c",
  "hash_id": "a1cdc6420965ecf0728f690c49002d438af032d3172f172e02d4c751f53c4cf7",
  "original_prompt": "Ingested from linux-6.6.14/samples/timers/hpet_example.c",
  "human_readable_source": "\n#include <stdio.h>\n#include <stdlib.h>\n#include <unistd.h>\n#include <fcntl.h>\n#include <string.h>\n#include <memory.h>\n#include <malloc.h>\n#include <time.h>\n#include <ctype.h>\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <signal.h>\n#include <errno.h>\n#include <sys/time.h>\n#include <linux/hpet.h>\n\n\nextern void hpet_open_close(int, const char **);\nextern void hpet_info(int, const char **);\nextern void hpet_poll(int, const char **);\nextern void hpet_fasync(int, const char **);\nextern void hpet_read(int, const char **);\n\n#include <sys/poll.h>\n#include <sys/ioctl.h>\n\nstruct hpet_command {\n\tchar\t\t*command;\n\tvoid\t\t(*func)(int argc, const char ** argv);\n} hpet_command[] = {\n\t{\n\t\t\"open-close\",\n\t\thpet_open_close\n\t},\n\t{\n\t\t\"info\",\n\t\thpet_info\n\t},\n\t{\n\t\t\"poll\",\n\t\thpet_poll\n\t},\n\t{\n\t\t\"fasync\",\n\t\thpet_fasync\n\t},\n};\n\nint\nmain(int argc, const char ** argv)\n{\n\tunsigned int\ti;\n\n\targc--;\n\targv++;\n\n\tif (!argc) {\n\t\tfprintf(stderr, \"-hpet: requires command\\n\");\n\t\treturn -1;\n\t}\n\n\n\tfor (i = 0; i < (sizeof (hpet_command) / sizeof (hpet_command[0])); i++)\n\t\tif (!strcmp(argv[0], hpet_command[i].command)) {\n\t\t\targc--;\n\t\t\targv++;\n\t\t\tfprintf(stderr, \"-hpet: executing %s\\n\",\n\t\t\t\thpet_command[i].command);\n\t\t\thpet_command[i].func(argc, argv);\n\t\t\treturn 0;\n\t\t}\n\n\tfprintf(stderr, \"do_hpet: command %s not implemented\\n\", argv[0]);\n\n\treturn -1;\n}\n\nvoid\nhpet_open_close(int argc, const char **argv)\n{\n\tint\tfd;\n\n\tif (argc != 1) {\n\t\tfprintf(stderr, \"hpet_open_close: device-name\\n\");\n\t\treturn;\n\t}\n\n\tfd = open(argv[0], O_RDONLY);\n\tif (fd < 0)\n\t\tfprintf(stderr, \"hpet_open_close: open failed\\n\");\n\telse\n\t\tclose(fd);\n\n\treturn;\n}\n\nvoid\nhpet_info(int argc, const char **argv)\n{\n\tstruct hpet_info\tinfo;\n\tint\t\t\tfd;\n\n\tif (argc != 1) {\n\t\tfprintf(stderr, \"hpet_info: device-name\\n\");\n\t\treturn;\n\t}\n\n\tfd = open(argv[0], O_RDONLY);\n\tif (fd < 0) {\n\t\tfprintf(stderr, \"hpet_info: open of %s failed\\n\", argv[0]);\n\t\treturn;\n\t}\n\n\tif (ioctl(fd, HPET_INFO, &info) < 0) {\n\t\tfprintf(stderr, \"hpet_info: failed to get info\\n\");\n\t\tgoto out;\n\t}\n\n\tfprintf(stderr, \"hpet_info: hi_irqfreq 0x%lx hi_flags 0x%lx \",\n\t\tinfo.hi_ireqfreq, info.hi_flags);\n\tfprintf(stderr, \"hi_hpet %d hi_timer %d\\n\",\n\t\tinfo.hi_hpet, info.hi_timer);\n\nout:\n\tclose(fd);\n\treturn;\n}\n\nvoid\nhpet_poll(int argc, const char **argv)\n{\n\tunsigned long\t\tfreq;\n\tint\t\t\titerations, i, fd;\n\tstruct pollfd\t\tpfd;\n\tstruct hpet_info\tinfo;\n\tstruct timeval\t\tstv, etv;\n\tstruct timezone\t\ttz;\n\tlong\t\t\tusec;\n\n\tif (argc != 3) {\n\t\tfprintf(stderr, \"hpet_poll: device-name freq iterations\\n\");\n\t\treturn;\n\t}\n\n\tfreq = atoi(argv[1]);\n\titerations = atoi(argv[2]);\n\n\tfd = open(argv[0], O_RDONLY);\n\n\tif (fd < 0) {\n\t\tfprintf(stderr, \"hpet_poll: open of %s failed\\n\", argv[0]);\n\t\treturn;\n\t}\n\n\tif (ioctl(fd, HPET_IRQFREQ, freq) < 0) {\n\t\tfprintf(stderr, \"hpet_poll: HPET_IRQFREQ failed\\n\");\n\t\tgoto out;\n\t}\n\n\tif (ioctl(fd, HPET_INFO, &info) < 0) {\n\t\tfprintf(stderr, \"hpet_poll: failed to get info\\n\");\n\t\tgoto out;\n\t}\n\n\tfprintf(stderr, \"hpet_poll: info.hi_flags 0x%lx\\n\", info.hi_flags);\n\n\tif (info.hi_flags && (ioctl(fd, HPET_EPI, 0) < 0)) {\n\t\tfprintf(stderr, \"hpet_poll: HPET_EPI failed\\n\");\n\t\tgoto out;\n\t}\n\n\tif (ioctl(fd, HPET_IE_ON, 0) < 0) {\n\t\tfprintf(stderr, \"hpet_poll, HPET_IE_ON failed\\n\");\n\t\tgoto out;\n\t}\n\n\tpfd.fd = fd;\n\tpfd.events = POLLIN;\n\n\tfor (i = 0; i < iterations; i++) {\n\t\tpfd.revents = 0;\n\t\tgettimeofday(&stv, &tz);\n\t\tif (poll(&pfd, 1, -1) < 0)\n\t\t\tfprintf(stderr, \"hpet_poll: poll failed\\n\");\n\t\telse {\n\t\t\tlong \tdata;\n\n\t\t\tgettimeofday(&etv, &tz);\n\t\t\tusec = stv.tv_sec * 1000000 + stv.tv_usec;\n\t\t\tusec = (etv.tv_sec * 1000000 + etv.tv_usec) - usec;\n\n\t\t\tfprintf(stderr,\n\t\t\t\t\"hpet_poll: expired time = 0x%lx\\n\", usec);\n\n\t\t\tfprintf(stderr, \"hpet_poll: revents = 0x%x\\n\",\n\t\t\t\tpfd.revents);\n\n\t\t\tif (read(fd, &data, sizeof(data)) != sizeof(data)) {\n\t\t\t\tfprintf(stderr, \"hpet_poll: read failed\\n\");\n\t\t\t}\n\t\t\telse\n\t\t\t\tfprintf(stderr, \"hpet_poll: data 0x%lx\\n\",\n\t\t\t\t\tdata);\n\t\t}\n\t}\n\nout:\n\tclose(fd);\n\treturn;\n}\n\nstatic int hpet_sigio_count;\n\nstatic void\nhpet_sigio(int val)\n{\n\tfprintf(stderr, \"hpet_sigio: called\\n\");\n\thpet_sigio_count++;\n}\n\nvoid\nhpet_fasync(int argc, const char **argv)\n{\n\tunsigned long\t\tfreq;\n\tint\t\t\titerations, i, fd, value;\n\tsig_t\t\t\toldsig;\n\tstruct hpet_info\tinfo;\n\n\thpet_sigio_count = 0;\n\tfd = -1;\n\n\tif ((oldsig = signal(SIGIO, hpet_sigio)) == SIG_ERR) {\n\t\tfprintf(stderr, \"hpet_fasync: failed to set signal handler\\n\");\n\t\treturn;\n\t}\n\n\tif (argc != 3) {\n\t\tfprintf(stderr, \"hpet_fasync: device-name freq iterations\\n\");\n\t\tgoto out;\n\t}\n\n\tfd = open(argv[0], O_RDONLY);\n\n\tif (fd < 0) {\n\t\tfprintf(stderr, \"hpet_fasync: failed to open %s\\n\", argv[0]);\n\t\treturn;\n\t}\n\n\n\tif ((fcntl(fd, F_SETOWN, getpid()) == 1) ||\n\t\t((value = fcntl(fd, F_GETFL)) == 1) ||\n\t\t(fcntl(fd, F_SETFL, value | O_ASYNC) == 1)) {\n\t\tfprintf(stderr, \"hpet_fasync: fcntl failed\\n\");\n\t\tgoto out;\n\t}\n\n\tfreq = atoi(argv[1]);\n\titerations = atoi(argv[2]);\n\n\tif (ioctl(fd, HPET_IRQFREQ, freq) < 0) {\n\t\tfprintf(stderr, \"hpet_fasync: HPET_IRQFREQ failed\\n\");\n\t\tgoto out;\n\t}\n\n\tif (ioctl(fd, HPET_INFO, &info) < 0) {\n\t\tfprintf(stderr, \"hpet_fasync: failed to get info\\n\");\n\t\tgoto out;\n\t}\n\n\tfprintf(stderr, \"hpet_fasync: info.hi_flags 0x%lx\\n\", info.hi_flags);\n\n\tif (info.hi_flags && (ioctl(fd, HPET_EPI, 0) < 0)) {\n\t\tfprintf(stderr, \"hpet_fasync: HPET_EPI failed\\n\");\n\t\tgoto out;\n\t}\n\n\tif (ioctl(fd, HPET_IE_ON, 0) < 0) {\n\t\tfprintf(stderr, \"hpet_fasync, HPET_IE_ON failed\\n\");\n\t\tgoto out;\n\t}\n\n\tfor (i = 0; i < iterations; i++) {\n\t\t(void) pause();\n\t\tfprintf(stderr, \"hpet_fasync: count = %d\\n\", hpet_sigio_count);\n\t}\n\nout:\n\tsignal(SIGIO, oldsig);\n\n\tif (fd >= 0)\n\t\tclose(fd);\n\n\treturn;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}