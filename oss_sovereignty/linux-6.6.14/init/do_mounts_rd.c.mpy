{
  "module_name": "do_mounts_rd.c",
  "hash_id": "0373e2b0e51e4b9bc14b38947591aeef897a7c1261f1c1cfd117e340fee84ea4",
  "original_prompt": "Ingested from linux-6.6.14/init/do_mounts_rd.c",
  "human_readable_source": "\n#include <linux/kernel.h>\n#include <linux/fs.h>\n#include <linux/minix_fs.h>\n#include <linux/ext2_fs.h>\n#include <linux/romfs_fs.h>\n#include <uapi/linux/cramfs_fs.h>\n#include <linux/initrd.h>\n#include <linux/string.h>\n#include <linux/slab.h>\n\n#include \"do_mounts.h\"\n#include \"../fs/squashfs/squashfs_fs.h\"\n\n#include <linux/decompress/generic.h>\n\nstatic struct file *in_file, *out_file;\nstatic loff_t in_pos, out_pos;\n\nstatic int __init prompt_ramdisk(char *str)\n{\n\tpr_warn(\"ignoring the deprecated prompt_ramdisk= option\\n\");\n\treturn 1;\n}\n__setup(\"prompt_ramdisk=\", prompt_ramdisk);\n\nint __initdata rd_image_start;\t\t \n\nstatic int __init ramdisk_start_setup(char *str)\n{\n\trd_image_start = simple_strtol(str,NULL,0);\n\treturn 1;\n}\n__setup(\"ramdisk_start=\", ramdisk_start_setup);\n\nstatic int __init crd_load(decompress_fn deco);\n\n \nstatic int __init\nidentify_ramdisk_image(struct file *file, loff_t pos,\n\t\tdecompress_fn *decompressor)\n{\n\tconst int size = 512;\n\tstruct minix_super_block *minixsb;\n\tstruct romfs_super_block *romfsb;\n\tstruct cramfs_super *cramfsb;\n\tstruct squashfs_super_block *squashfsb;\n\tint nblocks = -1;\n\tunsigned char *buf;\n\tconst char *compress_name;\n\tunsigned long n;\n\tint start_block = rd_image_start;\n\n\tbuf = kmalloc(size, GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\tminixsb = (struct minix_super_block *) buf;\n\tromfsb = (struct romfs_super_block *) buf;\n\tcramfsb = (struct cramfs_super *) buf;\n\tsquashfsb = (struct squashfs_super_block *) buf;\n\tmemset(buf, 0xe5, size);\n\n\t \n\tpos = start_block * BLOCK_SIZE;\n\tkernel_read(file, buf, size, &pos);\n\n\t*decompressor = decompress_method(buf, size, &compress_name);\n\tif (compress_name) {\n\t\tprintk(KERN_NOTICE \"RAMDISK: %s image found at block %d\\n\",\n\t\t       compress_name, start_block);\n\t\tif (!*decompressor)\n\t\t\tprintk(KERN_EMERG\n\t\t\t       \"RAMDISK: %s decompressor not configured!\\n\",\n\t\t\t       compress_name);\n\t\tnblocks = 0;\n\t\tgoto done;\n\t}\n\n\t \n\tif (romfsb->word0 == ROMSB_WORD0 &&\n\t    romfsb->word1 == ROMSB_WORD1) {\n\t\tprintk(KERN_NOTICE\n\t\t       \"RAMDISK: romfs filesystem found at block %d\\n\",\n\t\t       start_block);\n\t\tnblocks = (ntohl(romfsb->size)+BLOCK_SIZE-1)>>BLOCK_SIZE_BITS;\n\t\tgoto done;\n\t}\n\n\tif (cramfsb->magic == CRAMFS_MAGIC) {\n\t\tprintk(KERN_NOTICE\n\t\t       \"RAMDISK: cramfs filesystem found at block %d\\n\",\n\t\t       start_block);\n\t\tnblocks = (cramfsb->size + BLOCK_SIZE - 1) >> BLOCK_SIZE_BITS;\n\t\tgoto done;\n\t}\n\n\t \n\tif (le32_to_cpu(squashfsb->s_magic) == SQUASHFS_MAGIC) {\n\t\tprintk(KERN_NOTICE\n\t\t       \"RAMDISK: squashfs filesystem found at block %d\\n\",\n\t\t       start_block);\n\t\tnblocks = (le64_to_cpu(squashfsb->bytes_used) + BLOCK_SIZE - 1)\n\t\t\t >> BLOCK_SIZE_BITS;\n\t\tgoto done;\n\t}\n\n\t \n\tpos = start_block * BLOCK_SIZE + 0x200;\n\tkernel_read(file, buf, size, &pos);\n\n\tif (cramfsb->magic == CRAMFS_MAGIC) {\n\t\tprintk(KERN_NOTICE\n\t\t       \"RAMDISK: cramfs filesystem found at block %d\\n\",\n\t\t       start_block);\n\t\tnblocks = (cramfsb->size + BLOCK_SIZE - 1) >> BLOCK_SIZE_BITS;\n\t\tgoto done;\n\t}\n\n\t \n\tpos = (start_block + 1) * BLOCK_SIZE;\n\tkernel_read(file, buf, size, &pos);\n\n\t \n\tif (minixsb->s_magic == MINIX_SUPER_MAGIC ||\n\t    minixsb->s_magic == MINIX_SUPER_MAGIC2) {\n\t\tprintk(KERN_NOTICE\n\t\t       \"RAMDISK: Minix filesystem found at block %d\\n\",\n\t\t       start_block);\n\t\tnblocks = minixsb->s_nzones << minixsb->s_log_zone_size;\n\t\tgoto done;\n\t}\n\n\t \n\tn = ext2_image_size(buf);\n\tif (n) {\n\t\tprintk(KERN_NOTICE\n\t\t       \"RAMDISK: ext2 filesystem found at block %d\\n\",\n\t\t       start_block);\n\t\tnblocks = n;\n\t\tgoto done;\n\t}\n\n\tprintk(KERN_NOTICE\n\t       \"RAMDISK: Couldn't find valid RAM disk image starting at %d.\\n\",\n\t       start_block);\n\ndone:\n\tkfree(buf);\n\treturn nblocks;\n}\n\nstatic unsigned long nr_blocks(struct file *file)\n{\n\tstruct inode *inode = file->f_mapping->host;\n\n\tif (!S_ISBLK(inode->i_mode))\n\t\treturn 0;\n\treturn i_size_read(inode) >> 10;\n}\n\nint __init rd_load_image(char *from)\n{\n\tint res = 0;\n\tunsigned long rd_blocks, devblocks;\n\tint nblocks, i;\n\tchar *buf = NULL;\n\tunsigned short rotate = 0;\n\tdecompress_fn decompressor = NULL;\n#if !defined(CONFIG_S390)\n\tchar rotator[4] = { '|' , '/' , '-' , '\\\\' };\n#endif\n\n\tout_file = filp_open(\"/dev/ram\", O_RDWR, 0);\n\tif (IS_ERR(out_file))\n\t\tgoto out;\n\n\tin_file = filp_open(from, O_RDONLY, 0);\n\tif (IS_ERR(in_file))\n\t\tgoto noclose_input;\n\n\tin_pos = rd_image_start * BLOCK_SIZE;\n\tnblocks = identify_ramdisk_image(in_file, in_pos, &decompressor);\n\tif (nblocks < 0)\n\t\tgoto done;\n\n\tif (nblocks == 0) {\n\t\tif (crd_load(decompressor) == 0)\n\t\t\tgoto successful_load;\n\t\tgoto done;\n\t}\n\n\t \n\trd_blocks = nr_blocks(out_file);\n\tif (nblocks > rd_blocks) {\n\t\tprintk(\"RAMDISK: image too big! (%dKiB/%ldKiB)\\n\",\n\t\t       nblocks, rd_blocks);\n\t\tgoto done;\n\t}\n\n\t \n\tif (strcmp(from, \"/initrd.image\") == 0)\n\t\tdevblocks = nblocks;\n\telse\n\t\tdevblocks = nr_blocks(in_file);\n\n\tif (devblocks == 0) {\n\t\tprintk(KERN_ERR \"RAMDISK: could not determine device size\\n\");\n\t\tgoto done;\n\t}\n\n\tbuf = kmalloc(BLOCK_SIZE, GFP_KERNEL);\n\tif (!buf) {\n\t\tprintk(KERN_ERR \"RAMDISK: could not allocate buffer\\n\");\n\t\tgoto done;\n\t}\n\n\tprintk(KERN_NOTICE \"RAMDISK: Loading %dKiB [%ld disk%s] into ram disk... \",\n\t\tnblocks, ((nblocks-1)/devblocks)+1, nblocks>devblocks ? \"s\" : \"\");\n\tfor (i = 0; i < nblocks; i++) {\n\t\tif (i && (i % devblocks == 0)) {\n\t\t\tpr_cont(\"done disk #1.\\n\");\n\t\t\trotate = 0;\n\t\t\tfput(in_file);\n\t\t\tbreak;\n\t\t}\n\t\tkernel_read(in_file, buf, BLOCK_SIZE, &in_pos);\n\t\tkernel_write(out_file, buf, BLOCK_SIZE, &out_pos);\n#if !defined(CONFIG_S390)\n\t\tif (!(i % 16)) {\n\t\t\tpr_cont(\"%c\\b\", rotator[rotate & 0x3]);\n\t\t\trotate++;\n\t\t}\n#endif\n\t}\n\tpr_cont(\"done.\\n\");\n\nsuccessful_load:\n\tres = 1;\ndone:\n\tfput(in_file);\nnoclose_input:\n\tfput(out_file);\nout:\n\tkfree(buf);\n\tinit_unlink(\"/dev/ram\");\n\treturn res;\n}\n\nint __init rd_load_disk(int n)\n{\n\tcreate_dev(\"/dev/root\", ROOT_DEV);\n\tcreate_dev(\"/dev/ram\", MKDEV(RAMDISK_MAJOR, n));\n\treturn rd_load_image(\"/dev/root\");\n}\n\nstatic int exit_code;\nstatic int decompress_error;\n\nstatic long __init compr_fill(void *buf, unsigned long len)\n{\n\tlong r = kernel_read(in_file, buf, len, &in_pos);\n\tif (r < 0)\n\t\tprintk(KERN_ERR \"RAMDISK: error while reading compressed data\");\n\telse if (r == 0)\n\t\tprintk(KERN_ERR \"RAMDISK: EOF while reading compressed data\");\n\treturn r;\n}\n\nstatic long __init compr_flush(void *window, unsigned long outcnt)\n{\n\tlong written = kernel_write(out_file, window, outcnt, &out_pos);\n\tif (written != outcnt) {\n\t\tif (decompress_error == 0)\n\t\t\tprintk(KERN_ERR\n\t\t\t       \"RAMDISK: incomplete write (%ld != %ld)\\n\",\n\t\t\t       written, outcnt);\n\t\tdecompress_error = 1;\n\t\treturn -1;\n\t}\n\treturn outcnt;\n}\n\nstatic void __init error(char *x)\n{\n\tprintk(KERN_ERR \"%s\\n\", x);\n\texit_code = 1;\n\tdecompress_error = 1;\n}\n\nstatic int __init crd_load(decompress_fn deco)\n{\n\tint result;\n\n\tif (!deco) {\n\t\tpr_emerg(\"Invalid ramdisk decompression routine.  \"\n\t\t\t \"Select appropriate config option.\\n\");\n\t\tpanic(\"Could not decompress initial ramdisk image.\");\n\t}\n\n\tresult = deco(NULL, 0, compr_fill, compr_flush, NULL, NULL, error);\n\tif (decompress_error)\n\t\tresult = 1;\n\treturn result;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}