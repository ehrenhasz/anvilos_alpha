{
  "module_name": "do_mounts_initrd.c",
  "hash_id": "e427dfcbfb5308ab16ee796266fbee6143630562fe245292edfc64e3f46d9d46",
  "original_prompt": "Ingested from linux-6.6.14/init/do_mounts_initrd.c",
  "human_readable_source": "\n#include <linux/unistd.h>\n#include <linux/kernel.h>\n#include <linux/fs.h>\n#include <linux/minix_fs.h>\n#include <linux/romfs_fs.h>\n#include <linux/initrd.h>\n#include <linux/sched.h>\n#include <linux/freezer.h>\n#include <linux/kmod.h>\n#include <uapi/linux/mount.h>\n\n#include \"do_mounts.h\"\n\nunsigned long initrd_start, initrd_end;\nint initrd_below_start_ok;\nstatic unsigned int real_root_dev;\t \nstatic int __initdata mount_initrd = 1;\n\nphys_addr_t phys_initrd_start __initdata;\nunsigned long phys_initrd_size __initdata;\n\n#ifdef CONFIG_SYSCTL\nstatic struct ctl_table kern_do_mounts_initrd_table[] = {\n\t{\n\t\t.procname       = \"real-root-dev\",\n\t\t.data           = &real_root_dev,\n\t\t.maxlen         = sizeof(int),\n\t\t.mode           = 0644,\n\t\t.proc_handler   = proc_dointvec,\n\t},\n\t{ }\n};\n\nstatic __init int kernel_do_mounts_initrd_sysctls_init(void)\n{\n\tregister_sysctl_init(\"kernel\", kern_do_mounts_initrd_table);\n\treturn 0;\n}\nlate_initcall(kernel_do_mounts_initrd_sysctls_init);\n#endif  \n\nstatic int __init no_initrd(char *str)\n{\n\tmount_initrd = 0;\n\treturn 1;\n}\n\n__setup(\"noinitrd\", no_initrd);\n\nstatic int __init early_initrdmem(char *p)\n{\n\tphys_addr_t start;\n\tunsigned long size;\n\tchar *endp;\n\n\tstart = memparse(p, &endp);\n\tif (*endp == ',') {\n\t\tsize = memparse(endp + 1, NULL);\n\n\t\tphys_initrd_start = start;\n\t\tphys_initrd_size = size;\n\t}\n\treturn 0;\n}\nearly_param(\"initrdmem\", early_initrdmem);\n\nstatic int __init early_initrd(char *p)\n{\n\treturn early_initrdmem(p);\n}\nearly_param(\"initrd\", early_initrd);\n\nstatic int __init init_linuxrc(struct subprocess_info *info, struct cred *new)\n{\n\tksys_unshare(CLONE_FS | CLONE_FILES);\n\tconsole_on_rootfs();\n\t \n\tinit_chdir(\"/root\");\n\tinit_mount(\".\", \"/\", NULL, MS_MOVE, NULL);\n\tinit_chroot(\".\");\n\tksys_setsid();\n\treturn 0;\n}\n\nstatic void __init handle_initrd(char *root_device_name)\n{\n\tstruct subprocess_info *info;\n\tstatic char *argv[] = { \"linuxrc\", NULL, };\n\textern char *envp_init[];\n\tint error;\n\n\tpr_warn(\"using deprecated initrd support, will be removed in 2021.\\n\");\n\n\treal_root_dev = new_encode_dev(ROOT_DEV);\n\tcreate_dev(\"/dev/root.old\", Root_RAM0);\n\t \n\tmount_root_generic(\"/dev/root.old\", root_device_name,\n\t\t\t   root_mountflags & ~MS_RDONLY);\n\tinit_mkdir(\"/old\", 0700);\n\tinit_chdir(\"/old\");\n\n\tinfo = call_usermodehelper_setup(\"/linuxrc\", argv, envp_init,\n\t\t\t\t\t GFP_KERNEL, init_linuxrc, NULL, NULL);\n\tif (!info)\n\t\treturn;\n\tcall_usermodehelper_exec(info, UMH_WAIT_PROC|UMH_FREEZABLE);\n\n\t \n\tinit_mount(\"..\", \".\", NULL, MS_MOVE, NULL);\n\t \n\tinit_chroot(\"..\");\n\n\tif (new_decode_dev(real_root_dev) == Root_RAM0) {\n\t\tinit_chdir(\"/old\");\n\t\treturn;\n\t}\n\n\tinit_chdir(\"/\");\n\tROOT_DEV = new_decode_dev(real_root_dev);\n\tmount_root(root_device_name);\n\n\tprintk(KERN_NOTICE \"Trying to move old root to /initrd ... \");\n\terror = init_mount(\"/old\", \"/root/initrd\", NULL, MS_MOVE, NULL);\n\tif (!error)\n\t\tprintk(\"okay\\n\");\n\telse {\n\t\tif (error == -ENOENT)\n\t\t\tprintk(\"/initrd does not exist. Ignored.\\n\");\n\t\telse\n\t\t\tprintk(\"failed\\n\");\n\t\tprintk(KERN_NOTICE \"Unmounting old root\\n\");\n\t\tinit_umount(\"/old\", MNT_DETACH);\n\t}\n}\n\nbool __init initrd_load(char *root_device_name)\n{\n\tif (mount_initrd) {\n\t\tcreate_dev(\"/dev/ram\", Root_RAM0);\n\t\t \n\t\tif (rd_load_image(\"/initrd.image\") && ROOT_DEV != Root_RAM0) {\n\t\t\tinit_unlink(\"/initrd.image\");\n\t\t\thandle_initrd(root_device_name);\n\t\t\treturn true;\n\t\t}\n\t}\n\tinit_unlink(\"/initrd.image\");\n\treturn false;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}