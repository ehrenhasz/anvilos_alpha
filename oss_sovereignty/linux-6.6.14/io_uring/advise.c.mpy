{
  "module_name": "advise.c",
  "hash_id": "d78954ef3bc4effba9996b0d7d05be3218361218804bd362973a4ba30632bdf3",
  "original_prompt": "Ingested from linux-6.6.14/io_uring/advise.c",
  "human_readable_source": "\n#include <linux/kernel.h>\n#include <linux/errno.h>\n#include <linux/fs.h>\n#include <linux/file.h>\n#include <linux/mm.h>\n#include <linux/slab.h>\n#include <linux/namei.h>\n#include <linux/io_uring.h>\n\n#include <uapi/linux/fadvise.h>\n#include <uapi/linux/io_uring.h>\n\n#include \"io_uring.h\"\n#include \"advise.h\"\n\nstruct io_fadvise {\n\tstruct file\t\t\t*file;\n\tu64\t\t\t\toffset;\n\tu32\t\t\t\tlen;\n\tu32\t\t\t\tadvice;\n};\n\nstruct io_madvise {\n\tstruct file\t\t\t*file;\n\tu64\t\t\t\taddr;\n\tu32\t\t\t\tlen;\n\tu32\t\t\t\tadvice;\n};\n\nint io_madvise_prep(struct io_kiocb *req, const struct io_uring_sqe *sqe)\n{\n#if defined(CONFIG_ADVISE_SYSCALLS) && defined(CONFIG_MMU)\n\tstruct io_madvise *ma = io_kiocb_to_cmd(req, struct io_madvise);\n\n\tif (sqe->buf_index || sqe->off || sqe->splice_fd_in)\n\t\treturn -EINVAL;\n\n\tma->addr = READ_ONCE(sqe->addr);\n\tma->len = READ_ONCE(sqe->len);\n\tma->advice = READ_ONCE(sqe->fadvise_advice);\n\treq->flags |= REQ_F_FORCE_ASYNC;\n\treturn 0;\n#else\n\treturn -EOPNOTSUPP;\n#endif\n}\n\nint io_madvise(struct io_kiocb *req, unsigned int issue_flags)\n{\n#if defined(CONFIG_ADVISE_SYSCALLS) && defined(CONFIG_MMU)\n\tstruct io_madvise *ma = io_kiocb_to_cmd(req, struct io_madvise);\n\tint ret;\n\n\tWARN_ON_ONCE(issue_flags & IO_URING_F_NONBLOCK);\n\n\tret = do_madvise(current->mm, ma->addr, ma->len, ma->advice);\n\tio_req_set_res(req, ret, 0);\n\treturn IOU_OK;\n#else\n\treturn -EOPNOTSUPP;\n#endif\n}\n\nstatic bool io_fadvise_force_async(struct io_fadvise *fa)\n{\n\tswitch (fa->advice) {\n\tcase POSIX_FADV_NORMAL:\n\tcase POSIX_FADV_RANDOM:\n\tcase POSIX_FADV_SEQUENTIAL:\n\t\treturn false;\n\tdefault:\n\t\treturn true;\n\t}\n}\n\nint io_fadvise_prep(struct io_kiocb *req, const struct io_uring_sqe *sqe)\n{\n\tstruct io_fadvise *fa = io_kiocb_to_cmd(req, struct io_fadvise);\n\n\tif (sqe->buf_index || sqe->addr || sqe->splice_fd_in)\n\t\treturn -EINVAL;\n\n\tfa->offset = READ_ONCE(sqe->off);\n\tfa->len = READ_ONCE(sqe->len);\n\tfa->advice = READ_ONCE(sqe->fadvise_advice);\n\tif (io_fadvise_force_async(fa))\n\t\treq->flags |= REQ_F_FORCE_ASYNC;\n\treturn 0;\n}\n\nint io_fadvise(struct io_kiocb *req, unsigned int issue_flags)\n{\n\tstruct io_fadvise *fa = io_kiocb_to_cmd(req, struct io_fadvise);\n\tint ret;\n\n\tWARN_ON_ONCE(issue_flags & IO_URING_F_NONBLOCK && io_fadvise_force_async(fa));\n\n\tret = vfs_fadvise(req->file, fa->offset, fa->len, fa->advice);\n\tif (ret < 0)\n\t\treq_set_fail(req);\n\tio_req_set_res(req, ret, 0);\n\treturn IOU_OK;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}