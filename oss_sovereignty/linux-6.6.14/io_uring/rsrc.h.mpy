{
  "module_name": "rsrc.h",
  "hash_id": "b79f335521e2def2c676580c0855a7da598cb078fa74f2a564b8a71f8bc50150",
  "original_prompt": "Ingested from linux-6.6.14/io_uring/rsrc.h",
  "human_readable_source": "\n#ifndef IOU_RSRC_H\n#define IOU_RSRC_H\n\n#include <net/af_unix.h>\n\n#include \"alloc_cache.h\"\n\n#define IO_NODE_ALLOC_CACHE_MAX 32\n\n#define IO_RSRC_TAG_TABLE_SHIFT\t(PAGE_SHIFT - 3)\n#define IO_RSRC_TAG_TABLE_MAX\t(1U << IO_RSRC_TAG_TABLE_SHIFT)\n#define IO_RSRC_TAG_TABLE_MASK\t(IO_RSRC_TAG_TABLE_MAX - 1)\n\nenum {\n\tIORING_RSRC_FILE\t\t= 0,\n\tIORING_RSRC_BUFFER\t\t= 1,\n};\n\nstruct io_rsrc_put {\n\tu64 tag;\n\tunion {\n\t\tvoid *rsrc;\n\t\tstruct file *file;\n\t\tstruct io_mapped_ubuf *buf;\n\t};\n};\n\ntypedef void (rsrc_put_fn)(struct io_ring_ctx *ctx, struct io_rsrc_put *prsrc);\n\nstruct io_rsrc_data {\n\tstruct io_ring_ctx\t\t*ctx;\n\n\tu64\t\t\t\t**tags;\n\tunsigned int\t\t\tnr;\n\tu16\t\t\t\trsrc_type;\n\tbool\t\t\t\tquiesce;\n};\n\nstruct io_rsrc_node {\n\tunion {\n\t\tstruct io_cache_entry\t\tcache;\n\t\tstruct io_ring_ctx\t\t*ctx;\n\t};\n\tint\t\t\t\trefs;\n\tbool\t\t\t\tempty;\n\tu16\t\t\t\ttype;\n\tstruct list_head\t\tnode;\n\tstruct io_rsrc_put\t\titem;\n};\n\nstruct io_mapped_ubuf {\n\tu64\t\tubuf;\n\tu64\t\tubuf_end;\n\tunsigned int\tnr_bvecs;\n\tunsigned long\tacct_pages;\n\tstruct bio_vec\tbvec[] __counted_by(nr_bvecs);\n};\n\nvoid io_rsrc_node_ref_zero(struct io_rsrc_node *node);\nvoid io_rsrc_node_destroy(struct io_ring_ctx *ctx, struct io_rsrc_node *ref_node);\nstruct io_rsrc_node *io_rsrc_node_alloc(struct io_ring_ctx *ctx);\nint io_queue_rsrc_removal(struct io_rsrc_data *data, unsigned idx, void *rsrc);\n\nint io_import_fixed(int ddir, struct iov_iter *iter,\n\t\t\t   struct io_mapped_ubuf *imu,\n\t\t\t   u64 buf_addr, size_t len);\n\nvoid __io_sqe_buffers_unregister(struct io_ring_ctx *ctx);\nint io_sqe_buffers_unregister(struct io_ring_ctx *ctx);\nint io_sqe_buffers_register(struct io_ring_ctx *ctx, void __user *arg,\n\t\t\t    unsigned int nr_args, u64 __user *tags);\nvoid __io_sqe_files_unregister(struct io_ring_ctx *ctx);\nint io_sqe_files_unregister(struct io_ring_ctx *ctx);\nint io_sqe_files_register(struct io_ring_ctx *ctx, void __user *arg,\n\t\t\t  unsigned nr_args, u64 __user *tags);\n\nint __io_scm_file_account(struct io_ring_ctx *ctx, struct file *file);\n\nstatic inline bool io_file_need_scm(struct file *filp)\n{\n\treturn false;\n}\n\nstatic inline int io_scm_file_account(struct io_ring_ctx *ctx,\n\t\t\t\t      struct file *file)\n{\n\tif (likely(!io_file_need_scm(file)))\n\t\treturn 0;\n\treturn __io_scm_file_account(ctx, file);\n}\n\nint io_register_files_update(struct io_ring_ctx *ctx, void __user *arg,\n\t\t\t     unsigned nr_args);\nint io_register_rsrc_update(struct io_ring_ctx *ctx, void __user *arg,\n\t\t\t    unsigned size, unsigned type);\nint io_register_rsrc(struct io_ring_ctx *ctx, void __user *arg,\n\t\t\tunsigned int size, unsigned int type);\n\nstatic inline void io_put_rsrc_node(struct io_ring_ctx *ctx, struct io_rsrc_node *node)\n{\n\tlockdep_assert_held(&ctx->uring_lock);\n\n\tif (node && !--node->refs)\n\t\tio_rsrc_node_ref_zero(node);\n}\n\nstatic inline void io_req_put_rsrc_locked(struct io_kiocb *req,\n\t\t\t\t\t  struct io_ring_ctx *ctx)\n{\n\tio_put_rsrc_node(ctx, req->rsrc_node);\n}\n\nstatic inline void io_charge_rsrc_node(struct io_ring_ctx *ctx,\n\t\t\t\t       struct io_rsrc_node *node)\n{\n\tnode->refs++;\n}\n\nstatic inline void io_req_set_rsrc_node(struct io_kiocb *req,\n\t\t\t\t\tstruct io_ring_ctx *ctx,\n\t\t\t\t\tunsigned int issue_flags)\n{\n\tif (!req->rsrc_node) {\n\t\tio_ring_submit_lock(ctx, issue_flags);\n\n\t\tlockdep_assert_held(&ctx->uring_lock);\n\n\t\treq->rsrc_node = ctx->rsrc_node;\n\t\tio_charge_rsrc_node(ctx, ctx->rsrc_node);\n\t\tio_ring_submit_unlock(ctx, issue_flags);\n\t}\n}\n\nstatic inline u64 *io_get_tag_slot(struct io_rsrc_data *data, unsigned int idx)\n{\n\tunsigned int off = idx & IO_RSRC_TAG_TABLE_MASK;\n\tunsigned int table_idx = idx >> IO_RSRC_TAG_TABLE_SHIFT;\n\n\treturn &data->tags[table_idx][off];\n}\n\nstatic inline int io_rsrc_init(struct io_ring_ctx *ctx)\n{\n\tctx->rsrc_node = io_rsrc_node_alloc(ctx);\n\treturn ctx->rsrc_node ? 0 : -ENOMEM;\n}\n\nint io_files_update(struct io_kiocb *req, unsigned int issue_flags);\nint io_files_update_prep(struct io_kiocb *req, const struct io_uring_sqe *sqe);\n\nint __io_account_mem(struct user_struct *user, unsigned long nr_pages);\n\nstatic inline void __io_unaccount_mem(struct user_struct *user,\n\t\t\t\t      unsigned long nr_pages)\n{\n\tatomic_long_sub(nr_pages, &user->locked_vm);\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}