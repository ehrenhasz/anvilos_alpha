{
  "module_name": "tick-oneshot.c",
  "hash_id": "e9ed25618d70c44dfa863ee15b78d0470af769358d9cdf07c008d74f28220baa",
  "original_prompt": "Ingested from linux-6.6.14/kernel/time/tick-oneshot.c",
  "human_readable_source": "\n \n#include <linux/cpu.h>\n#include <linux/err.h>\n#include <linux/hrtimer.h>\n#include <linux/interrupt.h>\n#include <linux/percpu.h>\n#include <linux/profile.h>\n#include <linux/sched.h>\n\n#include \"tick-internal.h\"\n\n \nint tick_program_event(ktime_t expires, int force)\n{\n\tstruct clock_event_device *dev = __this_cpu_read(tick_cpu_device.evtdev);\n\n\tif (unlikely(expires == KTIME_MAX)) {\n\t\t \n\t\tclockevents_switch_state(dev, CLOCK_EVT_STATE_ONESHOT_STOPPED);\n\t\tdev->next_event = KTIME_MAX;\n\t\treturn 0;\n\t}\n\n\tif (unlikely(clockevent_state_oneshot_stopped(dev))) {\n\t\t \n\t\tclockevents_switch_state(dev, CLOCK_EVT_STATE_ONESHOT);\n\t}\n\n\treturn clockevents_program_event(dev, expires, force);\n}\n\n \nvoid tick_resume_oneshot(void)\n{\n\tstruct clock_event_device *dev = __this_cpu_read(tick_cpu_device.evtdev);\n\n\tclockevents_switch_state(dev, CLOCK_EVT_STATE_ONESHOT);\n\tclockevents_program_event(dev, ktime_get(), true);\n}\n\n \nvoid tick_setup_oneshot(struct clock_event_device *newdev,\n\t\t\tvoid (*handler)(struct clock_event_device *),\n\t\t\tktime_t next_event)\n{\n\tnewdev->event_handler = handler;\n\tclockevents_switch_state(newdev, CLOCK_EVT_STATE_ONESHOT);\n\tclockevents_program_event(newdev, next_event, true);\n}\n\n \nint tick_switch_to_oneshot(void (*handler)(struct clock_event_device *))\n{\n\tstruct tick_device *td = this_cpu_ptr(&tick_cpu_device);\n\tstruct clock_event_device *dev = td->evtdev;\n\n\tif (!dev || !(dev->features & CLOCK_EVT_FEAT_ONESHOT) ||\n\t\t    !tick_device_is_functional(dev)) {\n\n\t\tpr_info(\"Clockevents: could not switch to one-shot mode:\");\n\t\tif (!dev) {\n\t\t\tpr_cont(\" no tick device\\n\");\n\t\t} else {\n\t\t\tif (!tick_device_is_functional(dev))\n\t\t\t\tpr_cont(\" %s is not functional.\\n\", dev->name);\n\t\t\telse\n\t\t\t\tpr_cont(\" %s does not support one-shot mode.\\n\",\n\t\t\t\t\tdev->name);\n\t\t}\n\t\treturn -EINVAL;\n\t}\n\n\ttd->mode = TICKDEV_MODE_ONESHOT;\n\tdev->event_handler = handler;\n\tclockevents_switch_state(dev, CLOCK_EVT_STATE_ONESHOT);\n\ttick_broadcast_switch_to_oneshot();\n\treturn 0;\n}\n\n \nint tick_oneshot_mode_active(void)\n{\n\tunsigned long flags;\n\tint ret;\n\n\tlocal_irq_save(flags);\n\tret = __this_cpu_read(tick_cpu_device.mode) == TICKDEV_MODE_ONESHOT;\n\tlocal_irq_restore(flags);\n\n\treturn ret;\n}\n\n#ifdef CONFIG_HIGH_RES_TIMERS\n \nint tick_init_highres(void)\n{\n\treturn tick_switch_to_oneshot(hrtimer_interrupt);\n}\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}