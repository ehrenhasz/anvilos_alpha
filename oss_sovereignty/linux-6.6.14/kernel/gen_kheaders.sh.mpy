{
  "module_name": "gen_kheaders.sh",
  "hash_id": "f71cbd00e79b2cd4eb63b871b734d84318cb071aa82c2ed50659e07323d0bf1e",
  "original_prompt": "Ingested from linux-6.6.14/kernel/gen_kheaders.sh",
  "human_readable_source": "#!/bin/sh\n# SPDX-License-Identifier: GPL-2.0\n\n# This script generates an archive consisting of kernel headers\n# for CONFIG_IKHEADERS.\nset -e\nsfile=\"$(readlink -f \"$0\")\"\noutdir=\"$(pwd)\"\ntarfile=$1\ncpio_dir=$outdir/${tarfile%/*}/.tmp_cpio_dir\n\ndir_list=\"\ninclude/\narch/$SRCARCH/include/\n\"\n\ntype cpio > /dev/null\n\n# Support incremental builds by skipping archive generation\n# if timestamps of files being archived are not changed.\n\n# This block is useful for debugging the incremental builds.\n# Uncomment it for debugging.\n# if [ ! -f /tmp/iter ]; then iter=1; echo 1 > /tmp/iter;\n# else iter=$(($(cat /tmp/iter) + 1)); echo $iter > /tmp/iter; fi\n# find $all_dirs -name \"*.h\" | xargs ls -l > /tmp/ls-$iter\n\nall_dirs=\nif [ \"$building_out_of_srctree\" ]; then\n\tfor d in $dir_list; do\n\t\tall_dirs=\"$all_dirs $srctree/$d\"\n\tdone\nfi\nall_dirs=\"$all_dirs $dir_list\"\n\n# include/generated/utsversion.h is ignored because it is generated after this\n# script is executed. (utsversion.h is unneeded for kheaders)\n#\n# When Kconfig regenerates include/generated/autoconf.h, its timestamp is\n# updated, but the contents might be still the same. When any CONFIG option is\n# changed, Kconfig touches the corresponding timestamp file include/config/*.\n# Hence, the md5sum detects the configuration change anyway. We do not need to\n# check include/generated/autoconf.h explicitly.\n#\n# Ignore them for md5 calculation to avoid pointless regeneration.\nheaders_md5=\"$(find $all_dirs -name \"*.h\"\t\t\t|\n\t\tgrep -v \"include/generated/utsversion.h\"\t|\n\t\tgrep -v \"include/generated/autoconf.h\"\t|\n\t\txargs ls -l | md5sum | cut -d ' ' -f1)\"\n\n# Any changes to this script will also cause a rebuild of the archive.\nthis_file_md5=\"$(ls -l $sfile | md5sum | cut -d ' ' -f1)\"\nif [ -f $tarfile ]; then tarfile_md5=\"$(md5sum $tarfile | cut -d ' ' -f1)\"; fi\nif [ -f kernel/kheaders.md5 ] &&\n\t[ \"$(head -n 1 kernel/kheaders.md5)\" = \"$headers_md5\" ] &&\n\t[ \"$(head -n 2 kernel/kheaders.md5 | tail -n 1)\" = \"$this_file_md5\" ] &&\n\t[ \"$(tail -n 1 kernel/kheaders.md5)\" = \"$tarfile_md5\" ]; then\n\t\texit\nfi\n\necho \"  GEN     $tarfile\"\n\nrm -rf $cpio_dir\nmkdir $cpio_dir\n\nif [ \"$building_out_of_srctree\" ]; then\n\t(\n\t\tcd $srctree\n\t\tfor f in $dir_list\n\t\t\tdo find \"$f\" -name \"*.h\";\n\t\tdone | cpio --quiet -pd $cpio_dir\n\t)\nfi\n\n# The second CPIO can complain if files already exist which can happen with out\n# of tree builds having stale headers in srctree. Just silence CPIO for now.\nfor f in $dir_list;\n\tdo find \"$f\" -name \"*.h\";\ndone | cpio --quiet -pdu $cpio_dir >/dev/null 2>&1\n\n# Remove comments except SDPX lines\nfind $cpio_dir -type f -print0 |\n\txargs -0 -P8 -n1 perl -pi -e 'BEGIN {undef $/;}; s/\\/\\*((?!SPDX).)*?\\*\\///smg;'\n\n# Create archive and try to normalize metadata for reproducibility.\ntar \"${KBUILD_BUILD_TIMESTAMP:+--mtime=$KBUILD_BUILD_TIMESTAMP}\" \\\n    --owner=0 --group=0 --sort=name --numeric-owner \\\n    -I $XZ -cf $tarfile -C $cpio_dir/ . > /dev/null\n\necho $headers_md5 > kernel/kheaders.md5\necho \"$this_file_md5\" >> kernel/kheaders.md5\necho \"$(md5sum $tarfile | cut -d ' ' -f1)\" >> kernel/kheaders.md5\n\nrm -rf $cpio_dir\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}