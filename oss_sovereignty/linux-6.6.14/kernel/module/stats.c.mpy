{
  "module_name": "stats.c",
  "hash_id": "cd09d6e45876c24e408e566be365cccb0e35334b446b9e76843cec1db54b61bb",
  "original_prompt": "Ingested from linux-6.6.14/kernel/module/stats.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <uapi/linux/module.h>\n#include <linux/string.h>\n#include <linux/printk.h>\n#include <linux/slab.h>\n#include <linux/list.h>\n#include <linux/debugfs.h>\n#include <linux/rculist.h>\n#include <linux/math.h>\n\n#include \"internal.h\"\n\n \n\n \nstatic LIST_HEAD(dup_failed_modules);\n\n \n\natomic_long_t total_mod_size;\natomic_long_t total_text_size;\natomic_long_t invalid_kread_bytes;\natomic_long_t invalid_decompress_bytes;\nstatic atomic_long_t invalid_becoming_bytes;\nstatic atomic_long_t invalid_mod_bytes;\natomic_t modcount;\natomic_t failed_kreads;\natomic_t failed_decompress;\nstatic atomic_t failed_becoming;\nstatic atomic_t failed_load_modules;\n\nstatic const char *mod_fail_to_str(struct mod_fail_load *mod_fail)\n{\n\tif (test_bit(FAIL_DUP_MOD_BECOMING, &mod_fail->dup_fail_mask) &&\n\t    test_bit(FAIL_DUP_MOD_LOAD, &mod_fail->dup_fail_mask))\n\t\treturn \"Becoming & Load\";\n\tif (test_bit(FAIL_DUP_MOD_BECOMING, &mod_fail->dup_fail_mask))\n\t\treturn \"Becoming\";\n\tif (test_bit(FAIL_DUP_MOD_LOAD, &mod_fail->dup_fail_mask))\n\t\treturn \"Load\";\n\treturn \"Bug-on-stats\";\n}\n\nvoid mod_stat_bump_invalid(struct load_info *info, int flags)\n{\n\tatomic_long_add(info->len * 2, &invalid_mod_bytes);\n\tatomic_inc(&failed_load_modules);\n#if defined(CONFIG_MODULE_DECOMPRESS)\n\tif (flags & MODULE_INIT_COMPRESSED_FILE)\n\t\tatomic_long_add(info->compressed_len, &invalid_mod_bytes);\n#endif\n}\n\nvoid mod_stat_bump_becoming(struct load_info *info, int flags)\n{\n\tatomic_inc(&failed_becoming);\n\tatomic_long_add(info->len, &invalid_becoming_bytes);\n#if defined(CONFIG_MODULE_DECOMPRESS)\n\tif (flags & MODULE_INIT_COMPRESSED_FILE)\n\t\tatomic_long_add(info->compressed_len, &invalid_becoming_bytes);\n#endif\n}\n\nint try_add_failed_module(const char *name, enum fail_dup_mod_reason reason)\n{\n\tstruct mod_fail_load *mod_fail;\n\n\tlist_for_each_entry_rcu(mod_fail, &dup_failed_modules, list,\n\t\t\t\tlockdep_is_held(&module_mutex)) {\n\t\tif (!strcmp(mod_fail->name, name)) {\n\t\t\tatomic_long_inc(&mod_fail->count);\n\t\t\t__set_bit(reason, &mod_fail->dup_fail_mask);\n\t\t\tgoto out;\n\t\t}\n\t}\n\n\tmod_fail = kzalloc(sizeof(*mod_fail), GFP_KERNEL);\n\tif (!mod_fail)\n\t\treturn -ENOMEM;\n\tmemcpy(mod_fail->name, name, strlen(name));\n\t__set_bit(reason, &mod_fail->dup_fail_mask);\n\tatomic_long_inc(&mod_fail->count);\n\tlist_add_rcu(&mod_fail->list, &dup_failed_modules);\nout:\n\treturn 0;\n}\n\n \n#define MAX_PREAMBLE 1024\n#define MAX_FAILED_MOD_PRINT 112\n#define MAX_BYTES_PER_MOD 64\nstatic ssize_t read_file_mod_stats(struct file *file, char __user *user_buf,\n\t\t\t\t   size_t count, loff_t *ppos)\n{\n\tstruct mod_fail_load *mod_fail;\n\tunsigned int len, size, count_failed = 0;\n\tchar *buf;\n\tint ret;\n\tu32 live_mod_count, fkreads, fdecompress, fbecoming, floads;\n\tunsigned long total_size, text_size, ikread_bytes, ibecoming_bytes,\n\t\tidecompress_bytes, imod_bytes, total_virtual_lost;\n\n\tlive_mod_count = atomic_read(&modcount);\n\tfkreads = atomic_read(&failed_kreads);\n\tfdecompress = atomic_read(&failed_decompress);\n\tfbecoming = atomic_read(&failed_becoming);\n\tfloads = atomic_read(&failed_load_modules);\n\n\ttotal_size = atomic_long_read(&total_mod_size);\n\ttext_size = atomic_long_read(&total_text_size);\n\tikread_bytes = atomic_long_read(&invalid_kread_bytes);\n\tidecompress_bytes = atomic_long_read(&invalid_decompress_bytes);\n\tibecoming_bytes = atomic_long_read(&invalid_becoming_bytes);\n\timod_bytes = atomic_long_read(&invalid_mod_bytes);\n\n\ttotal_virtual_lost = ikread_bytes + idecompress_bytes + ibecoming_bytes + imod_bytes;\n\n\tsize = MAX_PREAMBLE + min((unsigned int)(floads + fbecoming),\n\t\t\t\t  (unsigned int)MAX_FAILED_MOD_PRINT) * MAX_BYTES_PER_MOD;\n\tbuf = kzalloc(size, GFP_KERNEL);\n\tif (buf == NULL)\n\t\treturn -ENOMEM;\n\n\t \n\tlen = scnprintf(buf, size, \"%25s\\t%u\\n\", \"Mods ever loaded\", live_mod_count);\n\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%u\\n\", \"Mods failed on kread\", fkreads);\n\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%u\\n\", \"Mods failed on decompress\",\n\t\t\t fdecompress);\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%u\\n\", \"Mods failed on becoming\", fbecoming);\n\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%u\\n\", \"Mods failed on load\", floads);\n\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Total module size\", total_size);\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Total mod text size\", text_size);\n\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Failed kread bytes\", ikread_bytes);\n\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Failed decompress bytes\",\n\t\t\t idecompress_bytes);\n\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Failed becoming bytes\", ibecoming_bytes);\n\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Failed kmod bytes\", imod_bytes);\n\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Virtual mem wasted bytes\", total_virtual_lost);\n\n\tif (live_mod_count && total_size) {\n\t\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Average mod size\",\n\t\t\t\t DIV_ROUND_UP(total_size, live_mod_count));\n\t}\n\n\tif (live_mod_count && text_size) {\n\t\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Average mod text size\",\n\t\t\t\t DIV_ROUND_UP(text_size, live_mod_count));\n\t}\n\n\t \n\n\tWARN_ON_ONCE(ikread_bytes && !fkreads);\n\tif (fkreads && ikread_bytes) {\n\t\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Avg fail kread bytes\",\n\t\t\t\t DIV_ROUND_UP(ikread_bytes, fkreads));\n\t}\n\n\tWARN_ON_ONCE(ibecoming_bytes && !fbecoming);\n\tif (fbecoming && ibecoming_bytes) {\n\t\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Avg fail becoming bytes\",\n\t\t\t\t DIV_ROUND_UP(ibecoming_bytes, fbecoming));\n\t}\n\n\tWARN_ON_ONCE(idecompress_bytes && !fdecompress);\n\tif (fdecompress && idecompress_bytes) {\n\t\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Avg fail decomp bytes\",\n\t\t\t\t DIV_ROUND_UP(idecompress_bytes, fdecompress));\n\t}\n\n\tWARN_ON_ONCE(imod_bytes && !floads);\n\tif (floads && imod_bytes) {\n\t\tlen += scnprintf(buf + len, size - len, \"%25s\\t%lu\\n\", \"Average fail load bytes\",\n\t\t\t\t DIV_ROUND_UP(imod_bytes, floads));\n\t}\n\n\t \n\n\t \n\tWARN_ON_ONCE(len >= MAX_PREAMBLE);\n\n\tif (list_empty(&dup_failed_modules))\n\t\tgoto out;\n\n\tlen += scnprintf(buf + len, size - len, \"Duplicate failed modules:\\n\");\n\tlen += scnprintf(buf + len, size - len, \"%25s\\t%15s\\t%25s\\n\",\n\t\t\t \"Module-name\", \"How-many-times\", \"Reason\");\n\tmutex_lock(&module_mutex);\n\n\n\tlist_for_each_entry_rcu(mod_fail, &dup_failed_modules, list) {\n\t\tif (WARN_ON_ONCE(++count_failed >= MAX_FAILED_MOD_PRINT))\n\t\t\tgoto out_unlock;\n\t\tlen += scnprintf(buf + len, size - len, \"%25s\\t%15lu\\t%25s\\n\", mod_fail->name,\n\t\t\t\t atomic_long_read(&mod_fail->count), mod_fail_to_str(mod_fail));\n\t}\nout_unlock:\n\tmutex_unlock(&module_mutex);\nout:\n\tret = simple_read_from_buffer(user_buf, count, ppos, buf, len);\n\tkfree(buf);\n\treturn ret;\n}\n#undef MAX_PREAMBLE\n#undef MAX_FAILED_MOD_PRINT\n#undef MAX_BYTES_PER_MOD\n\nstatic const struct file_operations fops_mod_stats = {\n\t.read = read_file_mod_stats,\n\t.open = simple_open,\n\t.owner = THIS_MODULE,\n\t.llseek = default_llseek,\n};\n\n#define mod_debug_add_ulong(name) debugfs_create_ulong(#name, 0400, mod_debugfs_root, (unsigned long *) &name.counter)\n#define mod_debug_add_atomic(name) debugfs_create_atomic_t(#name, 0400, mod_debugfs_root, &name)\nstatic int __init module_stats_init(void)\n{\n\tmod_debug_add_ulong(total_mod_size);\n\tmod_debug_add_ulong(total_text_size);\n\tmod_debug_add_ulong(invalid_kread_bytes);\n\tmod_debug_add_ulong(invalid_decompress_bytes);\n\tmod_debug_add_ulong(invalid_becoming_bytes);\n\tmod_debug_add_ulong(invalid_mod_bytes);\n\n\tmod_debug_add_atomic(modcount);\n\tmod_debug_add_atomic(failed_kreads);\n\tmod_debug_add_atomic(failed_decompress);\n\tmod_debug_add_atomic(failed_becoming);\n\tmod_debug_add_atomic(failed_load_modules);\n\n\tdebugfs_create_file(\"stats\", 0400, mod_debugfs_root, mod_debugfs_root, &fops_mod_stats);\n\n\treturn 0;\n}\n#undef mod_debug_add_ulong\n#undef mod_debug_add_atomic\nmodule_init(module_stats_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}