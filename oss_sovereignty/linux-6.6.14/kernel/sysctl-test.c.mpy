{
  "module_name": "sysctl-test.c",
  "hash_id": "e0a37a37505db9fd82023e0b58f33b5157e182e67d65db7a5bdc88ab09788d19",
  "original_prompt": "Ingested from linux-6.6.14/kernel/sysctl-test.c",
  "human_readable_source": "\n \n\n#include <kunit/test.h>\n#include <linux/sysctl.h>\n\n#define KUNIT_PROC_READ 0\n#define KUNIT_PROC_WRITE 1\n\n \nstatic void sysctl_test_api_dointvec_null_tbl_data(struct kunit *test)\n{\n\tstruct ctl_table null_data_table = {\n\t\t.procname = \"foo\",\n\t\t \n\t\t.data\t\t= NULL,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE_HUNDRED,\n\t};\n\t \n\tvoid __user *buffer = (void __user *)kunit_kzalloc(test, sizeof(int),\n\t\t\t\t\t\t\t   GFP_USER);\n\tsize_t len;\n\tloff_t pos;\n\n\t \n\tlen = 1234;\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&null_data_table,\n\t\t\t\t\t       KUNIT_PROC_READ, buffer, &len,\n\t\t\t\t\t       &pos));\n\tKUNIT_EXPECT_EQ(test, 0, len);\n\n\t \n\tlen = 1234;\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&null_data_table,\n\t\t\t\t\t       KUNIT_PROC_WRITE, buffer, &len,\n\t\t\t\t\t       &pos));\n\tKUNIT_EXPECT_EQ(test, 0, len);\n}\n\n \nstatic void sysctl_test_api_dointvec_table_maxlen_unset(struct kunit *test)\n{\n\tint data = 0;\n\tstruct ctl_table data_maxlen_unset_table = {\n\t\t.procname = \"foo\",\n\t\t.data\t\t= &data,\n\t\t \n\t\t.maxlen\t\t= 0,\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE_HUNDRED,\n\t};\n\tvoid __user *buffer = (void __user *)kunit_kzalloc(test, sizeof(int),\n\t\t\t\t\t\t\t   GFP_USER);\n\tsize_t len;\n\tloff_t pos;\n\n\t \n\tlen = 1234;\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&data_maxlen_unset_table,\n\t\t\t\t\t       KUNIT_PROC_READ, buffer, &len,\n\t\t\t\t\t       &pos));\n\tKUNIT_EXPECT_EQ(test, 0, len);\n\n\t \n\tlen = 1234;\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&data_maxlen_unset_table,\n\t\t\t\t\t       KUNIT_PROC_WRITE, buffer, &len,\n\t\t\t\t\t       &pos));\n\tKUNIT_EXPECT_EQ(test, 0, len);\n}\n\n \nstatic void sysctl_test_api_dointvec_table_len_is_zero(struct kunit *test)\n{\n\tint data = 0;\n\t \n\tstruct ctl_table table = {\n\t\t.procname = \"foo\",\n\t\t.data\t\t= &data,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE_HUNDRED,\n\t};\n\tvoid __user *buffer = (void __user *)kunit_kzalloc(test, sizeof(int),\n\t\t\t\t\t\t\t   GFP_USER);\n\t \n\tsize_t len = 0;\n\tloff_t pos;\n\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&table, KUNIT_PROC_READ, buffer,\n\t\t\t\t\t       &len, &pos));\n\tKUNIT_EXPECT_EQ(test, 0, len);\n\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&table, KUNIT_PROC_WRITE, buffer,\n\t\t\t\t\t       &len, &pos));\n\tKUNIT_EXPECT_EQ(test, 0, len);\n}\n\n \nstatic void sysctl_test_api_dointvec_table_read_but_position_set(\n\t\tstruct kunit *test)\n{\n\tint data = 0;\n\t \n\tstruct ctl_table table = {\n\t\t.procname = \"foo\",\n\t\t.data\t\t= &data,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE_HUNDRED,\n\t};\n\tvoid __user *buffer = (void __user *)kunit_kzalloc(test, sizeof(int),\n\t\t\t\t\t\t\t   GFP_USER);\n\t \n\tsize_t len = 1234;\n\t \n\tloff_t pos = 1;\n\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&table, KUNIT_PROC_READ, buffer,\n\t\t\t\t\t       &len, &pos));\n\tKUNIT_EXPECT_EQ(test, 0, len);\n}\n\n \nstatic void sysctl_test_dointvec_read_happy_single_positive(struct kunit *test)\n{\n\tint data = 0;\n\t \n\tstruct ctl_table table = {\n\t\t.procname = \"foo\",\n\t\t.data\t\t= &data,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE_HUNDRED,\n\t};\n\tsize_t len = 4;\n\tloff_t pos = 0;\n\tchar *buffer = kunit_kzalloc(test, len, GFP_USER);\n\tchar __user *user_buffer = (char __user *)buffer;\n\t \n\t*((int *)table.data) = 13;\n\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&table, KUNIT_PROC_READ,\n\t\t\t\t\t       user_buffer, &len, &pos));\n\tKUNIT_ASSERT_EQ(test, 3, len);\n\tbuffer[len] = '\\0';\n\t \n\tKUNIT_EXPECT_STREQ(test, \"13\\n\", buffer);\n}\n\n \nstatic void sysctl_test_dointvec_read_happy_single_negative(struct kunit *test)\n{\n\tint data = 0;\n\t \n\tstruct ctl_table table = {\n\t\t.procname = \"foo\",\n\t\t.data\t\t= &data,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE_HUNDRED,\n\t};\n\tsize_t len = 5;\n\tloff_t pos = 0;\n\tchar *buffer = kunit_kzalloc(test, len, GFP_USER);\n\tchar __user *user_buffer = (char __user *)buffer;\n\t*((int *)table.data) = -16;\n\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&table, KUNIT_PROC_READ,\n\t\t\t\t\t       user_buffer, &len, &pos));\n\tKUNIT_ASSERT_EQ(test, 4, len);\n\tbuffer[len] = '\\0';\n\tKUNIT_EXPECT_STREQ(test, \"-16\\n\", buffer);\n}\n\n \nstatic void sysctl_test_dointvec_write_happy_single_positive(struct kunit *test)\n{\n\tint data = 0;\n\t \n\tstruct ctl_table table = {\n\t\t.procname = \"foo\",\n\t\t.data\t\t= &data,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE_HUNDRED,\n\t};\n\tchar input[] = \"9\";\n\tsize_t len = sizeof(input) - 1;\n\tloff_t pos = 0;\n\tchar *buffer = kunit_kzalloc(test, len, GFP_USER);\n\tchar __user *user_buffer = (char __user *)buffer;\n\n\tmemcpy(buffer, input, len);\n\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&table, KUNIT_PROC_WRITE,\n\t\t\t\t\t       user_buffer, &len, &pos));\n\tKUNIT_EXPECT_EQ(test, sizeof(input) - 1, len);\n\tKUNIT_EXPECT_EQ(test, sizeof(input) - 1, pos);\n\tKUNIT_EXPECT_EQ(test, 9, *((int *)table.data));\n}\n\n \nstatic void sysctl_test_dointvec_write_happy_single_negative(struct kunit *test)\n{\n\tint data = 0;\n\tstruct ctl_table table = {\n\t\t.procname = \"foo\",\n\t\t.data\t\t= &data,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE_HUNDRED,\n\t};\n\tchar input[] = \"-9\";\n\tsize_t len = sizeof(input) - 1;\n\tloff_t pos = 0;\n\tchar *buffer = kunit_kzalloc(test, len, GFP_USER);\n\tchar __user *user_buffer = (char __user *)buffer;\n\n\tmemcpy(buffer, input, len);\n\n\tKUNIT_EXPECT_EQ(test, 0, proc_dointvec(&table, KUNIT_PROC_WRITE,\n\t\t\t\t\t       user_buffer, &len, &pos));\n\tKUNIT_EXPECT_EQ(test, sizeof(input) - 1, len);\n\tKUNIT_EXPECT_EQ(test, sizeof(input) - 1, pos);\n\tKUNIT_EXPECT_EQ(test, -9, *((int *)table.data));\n}\n\n \nstatic void sysctl_test_api_dointvec_write_single_less_int_min(\n\t\tstruct kunit *test)\n{\n\tint data = 0;\n\tstruct ctl_table table = {\n\t\t.procname = \"foo\",\n\t\t.data\t\t= &data,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE_HUNDRED,\n\t};\n\tsize_t max_len = 32, len = max_len;\n\tloff_t pos = 0;\n\tchar *buffer = kunit_kzalloc(test, max_len, GFP_USER);\n\tchar __user *user_buffer = (char __user *)buffer;\n\tunsigned long abs_of_less_than_min = (unsigned long)INT_MAX\n\t\t\t\t\t     - (INT_MAX + INT_MIN) + 1;\n\n\t \n\tKUNIT_ASSERT_LT(test,\n\t\t\t(size_t)snprintf(buffer, max_len, \"-%lu\",\n\t\t\t\t\t abs_of_less_than_min),\n\t\t\tmax_len);\n\n\tKUNIT_EXPECT_EQ(test, -EINVAL, proc_dointvec(&table, KUNIT_PROC_WRITE,\n\t\t\t\t\t\t     user_buffer, &len, &pos));\n\tKUNIT_EXPECT_EQ(test, max_len, len);\n\tKUNIT_EXPECT_EQ(test, 0, *((int *)table.data));\n}\n\n \nstatic void sysctl_test_api_dointvec_write_single_greater_int_max(\n\t\tstruct kunit *test)\n{\n\tint data = 0;\n\tstruct ctl_table table = {\n\t\t.procname = \"foo\",\n\t\t.data\t\t= &data,\n\t\t.maxlen\t\t= sizeof(int),\n\t\t.mode\t\t= 0644,\n\t\t.proc_handler\t= proc_dointvec,\n\t\t.extra1\t\t= SYSCTL_ZERO,\n\t\t.extra2         = SYSCTL_ONE_HUNDRED,\n\t};\n\tsize_t max_len = 32, len = max_len;\n\tloff_t pos = 0;\n\tchar *buffer = kunit_kzalloc(test, max_len, GFP_USER);\n\tchar __user *user_buffer = (char __user *)buffer;\n\tunsigned long greater_than_max = (unsigned long)INT_MAX + 1;\n\n\tKUNIT_ASSERT_GT(test, greater_than_max, (unsigned long)INT_MAX);\n\tKUNIT_ASSERT_LT(test, (size_t)snprintf(buffer, max_len, \"%lu\",\n\t\t\t\t\t       greater_than_max),\n\t\t\tmax_len);\n\tKUNIT_EXPECT_EQ(test, -EINVAL, proc_dointvec(&table, KUNIT_PROC_WRITE,\n\t\t\t\t\t\t     user_buffer, &len, &pos));\n\tKUNIT_ASSERT_EQ(test, max_len, len);\n\tKUNIT_EXPECT_EQ(test, 0, *((int *)table.data));\n}\n\nstatic struct kunit_case sysctl_test_cases[] = {\n\tKUNIT_CASE(sysctl_test_api_dointvec_null_tbl_data),\n\tKUNIT_CASE(sysctl_test_api_dointvec_table_maxlen_unset),\n\tKUNIT_CASE(sysctl_test_api_dointvec_table_len_is_zero),\n\tKUNIT_CASE(sysctl_test_api_dointvec_table_read_but_position_set),\n\tKUNIT_CASE(sysctl_test_dointvec_read_happy_single_positive),\n\tKUNIT_CASE(sysctl_test_dointvec_read_happy_single_negative),\n\tKUNIT_CASE(sysctl_test_dointvec_write_happy_single_positive),\n\tKUNIT_CASE(sysctl_test_dointvec_write_happy_single_negative),\n\tKUNIT_CASE(sysctl_test_api_dointvec_write_single_less_int_min),\n\tKUNIT_CASE(sysctl_test_api_dointvec_write_single_greater_int_max),\n\t{}\n};\n\nstatic struct kunit_suite sysctl_test_suite = {\n\t.name = \"sysctl_test\",\n\t.test_cases = sysctl_test_cases,\n};\n\nkunit_test_suites(&sysctl_test_suite);\n\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}