{
  "module_name": "kdb_keyboard.c",
  "hash_id": "0ea87a07fc5bf678804d01a7c7e51a2116bbd2ef050213d26ba3b59ae7d07745",
  "original_prompt": "Ingested from linux-6.6.14/kernel/debug/kdb/kdb_keyboard.c",
  "human_readable_source": " \n\n#include <linux/kdb.h>\n#include <linux/keyboard.h>\n#include <linux/ctype.h>\n#include <linux/io.h>\n\n#include \"kdb_private.h\"\n\n \n\n#define KBD_STATUS_REG\t\t0x64\t \n#define KBD_DATA_REG\t\t0x60\t \n\n \n\n#define KBD_STAT_OBF \t\t0x01\t \n#define KBD_STAT_MOUSE_OBF\t0x20\t \n\nstatic int kbd_exists;\nstatic int kbd_last_ret;\n\n \nint kdb_get_kbd_char(void)\n{\n\tint scancode, scanstatus;\n\tstatic int shift_lock;\t \n\tstatic int shift_key;\t \n\tstatic int ctrl_key;\n\tu_short keychar;\n\n\tif (KDB_FLAG(NO_I8042) || KDB_FLAG(NO_VT_CONSOLE) ||\n\t    (inb(KBD_STATUS_REG) == 0xff && inb(KBD_DATA_REG) == 0xff)) {\n\t\tkbd_exists = 0;\n\t\treturn -1;\n\t}\n\tkbd_exists = 1;\n\n\tif ((inb(KBD_STATUS_REG) & KBD_STAT_OBF) == 0)\n\t\treturn -1;\n\n\t \n\tscancode = inb(KBD_DATA_REG);\n\tscanstatus = inb(KBD_STATUS_REG);\n\n\t \n\tif (scanstatus & KBD_STAT_MOUSE_OBF)\n\t\treturn -1;\n\n\t \n\n\tif (((scancode&0x7f) == 0x2a) || ((scancode&0x7f) == 0x36)) {\n\t\t \n\t\tif ((scancode & 0x80) == 0)\n\t\t\tshift_key = 1;\n\t\telse\n\t\t\tshift_key = 0;\n\t\treturn -1;\n\t}\n\n\tif ((scancode&0x7f) == 0x1d) {\n\t\t \n\t\tif ((scancode & 0x80) == 0)\n\t\t\tctrl_key = 1;\n\t\telse\n\t\t\tctrl_key = 0;\n\t\treturn -1;\n\t}\n\n\tif ((scancode & 0x80) != 0) {\n\t\tif (scancode == 0x9c)\n\t\t\tkbd_last_ret = 0;\n\t\treturn -1;\n\t}\n\n\tscancode &= 0x7f;\n\n\t \n\n\tif (scancode == 0x3a) {\n\t\t \n\t\tshift_lock ^= 1;\n\n#ifdef\tKDB_BLINK_LED\n\t\tkdb_toggleled(0x4);\n#endif\n\t\treturn -1;\n\t}\n\n\tif (scancode == 0x0e) {\n\t\t \n\t\treturn 8;\n\t}\n\n\t \n\tswitch (scancode) {\n\tcase 0xF:  \n\t\treturn 9;\n\tcase 0x53:  \n\t\treturn 4;\n\tcase 0x47:  \n\t\treturn 1;\n\tcase 0x4F:  \n\t\treturn 5;\n\tcase 0x4B:  \n\t\treturn 2;\n\tcase 0x48:  \n\t\treturn 16;\n\tcase 0x50:  \n\t\treturn 14;\n\tcase 0x4D:  \n\t\treturn 6;\n\t}\n\n\tif (scancode == 0xe0)\n\t\treturn -1;\n\n\t \n\tif (scancode == 0x73)\n\t\tscancode = 0x59;\n\telse if (scancode == 0x7d)\n\t\tscancode = 0x7c;\n\n\tif (!shift_lock && !shift_key && !ctrl_key) {\n\t\tkeychar = plain_map[scancode];\n\t} else if ((shift_lock || shift_key) && key_maps[1]) {\n\t\tkeychar = key_maps[1][scancode];\n\t} else if (ctrl_key && key_maps[4]) {\n\t\tkeychar = key_maps[4][scancode];\n\t} else {\n\t\tkeychar = 0x0020;\n\t\tkdb_printf(\"Unknown state/scancode (%d)\\n\", scancode);\n\t}\n\tkeychar &= 0x0fff;\n\tif (keychar == '\\t')\n\t\tkeychar = ' ';\n\tswitch (KTYP(keychar)) {\n\tcase KT_LETTER:\n\tcase KT_LATIN:\n\t\tif (isprint(keychar))\n\t\t\tbreak;\t\t \n\t\tfallthrough;\n\tcase KT_SPEC:\n\t\tif (keychar == K_ENTER)\n\t\t\tbreak;\n\t\tfallthrough;\n\tdefault:\n\t\treturn -1;\t \n\t}\n\n\tif (scancode == 0x1c) {\n\t\tkbd_last_ret = 1;\n\t\treturn 13;\n\t}\n\n\treturn keychar & 0xff;\n}\nEXPORT_SYMBOL_GPL(kdb_get_kbd_char);\n\n \nvoid kdb_kbd_cleanup_state(void)\n{\n\tint scancode, scanstatus;\n\n\t \n\tif (!kbd_last_ret)\n\t\treturn;\n\n\tkbd_last_ret = 0;\n\t \n\n\twhile (1) {\n\t\twhile ((inb(KBD_STATUS_REG) & KBD_STAT_OBF) == 0)\n\t\t\tcpu_relax();\n\n\t\t \n\t\tscancode = inb(KBD_DATA_REG);\n\t\tscanstatus = inb(KBD_STATUS_REG);\n\n\t\t \n\t\tif (scanstatus & KBD_STAT_MOUSE_OBF)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (scancode != 0x9c)\n\t\t\tcontinue;\n\n\t\treturn;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}