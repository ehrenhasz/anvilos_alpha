{
  "module_name": "printk_ringbuffer.h",
  "hash_id": "2f48addbd5e1594c7453a9429f9430541ba6f0d298158ced46d41ea6a75a9494",
  "original_prompt": "Ingested from linux-6.6.14/kernel/printk/printk_ringbuffer.h",
  "human_readable_source": " \n\n#ifndef _KERNEL_PRINTK_RINGBUFFER_H\n#define _KERNEL_PRINTK_RINGBUFFER_H\n\n#include <linux/atomic.h>\n#include <linux/dev_printk.h>\n\n \nstruct printk_info {\n\tu64\tseq;\t\t \n\tu64\tts_nsec;\t \n\tu16\ttext_len;\t \n\tu8\tfacility;\t \n\tu8\tflags:5;\t \n\tu8\tlevel:3;\t \n\tu32\tcaller_id;\t \n\n\tstruct dev_printk_info\tdev_info;\n};\n\n \nstruct printk_record {\n\tstruct printk_info\t*info;\n\tchar\t\t\t*text_buf;\n\tunsigned int\t\ttext_buf_size;\n};\n\n \nstruct prb_data_blk_lpos {\n\tunsigned long\tbegin;\n\tunsigned long\tnext;\n};\n\n \nstruct prb_desc {\n\tatomic_long_t\t\t\tstate_var;\n\tstruct prb_data_blk_lpos\ttext_blk_lpos;\n};\n\n \nstruct prb_data_ring {\n\tunsigned int\tsize_bits;\n\tchar\t\t*data;\n\tatomic_long_t\thead_lpos;\n\tatomic_long_t\ttail_lpos;\n};\n\n \nstruct prb_desc_ring {\n\tunsigned int\t\tcount_bits;\n\tstruct prb_desc\t\t*descs;\n\tstruct printk_info\t*infos;\n\tatomic_long_t\t\thead_id;\n\tatomic_long_t\t\ttail_id;\n\tatomic_long_t\t\tlast_finalized_id;\n};\n\n \nstruct printk_ringbuffer {\n\tstruct prb_desc_ring\tdesc_ring;\n\tstruct prb_data_ring\ttext_data_ring;\n\tatomic_long_t\t\tfail;\n};\n\n \nstruct prb_reserved_entry {\n\tstruct printk_ringbuffer\t*rb;\n\tunsigned long\t\t\tirqflags;\n\tunsigned long\t\t\tid;\n\tunsigned int\t\t\ttext_space;\n};\n\n \nenum desc_state {\n\tdesc_miss\t=  -1,\t \n\tdesc_reserved\t= 0x0,\t \n\tdesc_committed\t= 0x1,\t \n\tdesc_finalized\t= 0x2,\t \n\tdesc_reusable\t= 0x3,\t \n};\n\n#define _DATA_SIZE(sz_bits)\t(1UL << (sz_bits))\n#define _DESCS_COUNT(ct_bits)\t(1U << (ct_bits))\n#define DESC_SV_BITS\t\t(sizeof(unsigned long) * 8)\n#define DESC_FLAGS_SHIFT\t(DESC_SV_BITS - 2)\n#define DESC_FLAGS_MASK\t\t(3UL << DESC_FLAGS_SHIFT)\n#define DESC_STATE(sv)\t\t(3UL & (sv >> DESC_FLAGS_SHIFT))\n#define DESC_SV(id, state)\t(((unsigned long)state << DESC_FLAGS_SHIFT) | id)\n#define DESC_ID_MASK\t\t(~DESC_FLAGS_MASK)\n#define DESC_ID(sv)\t\t((sv) & DESC_ID_MASK)\n#define FAILED_LPOS\t\t0x1\n#define NO_LPOS\t\t\t0x3\n\n#define FAILED_BLK_LPOS\t\\\n{\t\t\t\t\\\n\t.begin\t= FAILED_LPOS,\t\\\n\t.next\t= FAILED_LPOS,\t\\\n}\n\n \n\n \n#define BLK0_LPOS(sz_bits)\t(-(_DATA_SIZE(sz_bits)))\n#define DESC0_ID(ct_bits)\tDESC_ID(-(_DESCS_COUNT(ct_bits) + 1))\n#define DESC0_SV(ct_bits)\tDESC_SV(DESC0_ID(ct_bits), desc_reusable)\n\n \n#define _DEFINE_PRINTKRB(name, descbits, avgtextbits, text_buf)\t\t\t\\\nstatic struct prb_desc _##name##_descs[_DESCS_COUNT(descbits)] = {\t\t\t\t\\\n\t \t\t\t\t\t\t\t\t\\\n\t[_DESCS_COUNT(descbits) - 1] = {\t\t\t\t\t\t\t\\\n\t\t \t\t\t\t\t\t\t\t\t\\\n\t\t.state_var\t= ATOMIC_INIT(DESC0_SV(descbits)),\t\t\t\t\\\n\t\t \t\t\t\t\t\t\t\\\n\t\t.text_blk_lpos\t= FAILED_BLK_LPOS,\t\t\t\t\t\t\\\n\t},\t\t\t\t\t\t\t\t\t\t\t\\\n};\t\t\t\t\t\t\t\t\t\t\t\t\\\nstatic struct printk_info _##name##_infos[_DESCS_COUNT(descbits)] = {\t\t\t\t\\\n\t \t\t\t\t\\\n\t[0] = {\t\t\t\t\t\t\t\t\t\t\t\\\n\t\t \t\t\t\t\\\n\t\t.seq = -(u64)_DESCS_COUNT(descbits),\t\t\t\t\t\t\\\n\t},\t\t\t\t\t\t\t\t\t\t\t\\\n\t \t\t\t\t\t\t\t\t\\\n\t[_DESCS_COUNT(descbits) - 1] = {\t\t\t\t\t\t\t\\\n\t\t \t\t\t\\\n\t\t.seq = 0,\t\t\t\t\t\t\t\t\t\\\n\t},\t\t\t\t\t\t\t\t\t\t\t\\\n};\t\t\t\t\t\t\t\t\t\t\t\t\\\nstatic struct printk_ringbuffer name = {\t\t\t\t\t\t\t\\\n\t.desc_ring = {\t\t\t\t\t\t\t\t\t\t\\\n\t\t.count_bits\t= descbits,\t\t\t\t\t\t\t\\\n\t\t.descs\t\t= &_##name##_descs[0],\t\t\t\t\t\t\\\n\t\t.infos\t\t= &_##name##_infos[0],\t\t\t\t\t\t\\\n\t\t.head_id\t= ATOMIC_INIT(DESC0_ID(descbits)),\t\t\t\t\\\n\t\t.tail_id\t= ATOMIC_INIT(DESC0_ID(descbits)),\t\t\t\t\\\n\t\t.last_finalized_id = ATOMIC_INIT(DESC0_ID(descbits)),\t\t\t\t\\\n\t},\t\t\t\t\t\t\t\t\t\t\t\\\n\t.text_data_ring = {\t\t\t\t\t\t\t\t\t\\\n\t\t.size_bits\t= (avgtextbits) + (descbits),\t\t\t\t\t\\\n\t\t.data\t\t= text_buf,\t\t\t\t\t\t\t\\\n\t\t.head_lpos\t= ATOMIC_LONG_INIT(BLK0_LPOS((avgtextbits) + (descbits))),\t\\\n\t\t.tail_lpos\t= ATOMIC_LONG_INIT(BLK0_LPOS((avgtextbits) + (descbits))),\t\\\n\t},\t\t\t\t\t\t\t\t\t\t\t\\\n\t.fail\t\t\t= ATOMIC_LONG_INIT(0),\t\t\t\t\t\t\\\n}\n\n \n#define DEFINE_PRINTKRB(name, descbits, avgtextbits)\t\t\t\t\\\nstatic char _##name##_text[1U << ((avgtextbits) + (descbits))]\t\t\t\\\n\t\t\t__aligned(__alignof__(unsigned long));\t\t\t\\\n_DEFINE_PRINTKRB(name, descbits, avgtextbits, &_##name##_text[0])\n\n \n\n \nstatic inline void prb_rec_init_wr(struct printk_record *r,\n\t\t\t\t   unsigned int text_buf_size)\n{\n\tr->info = NULL;\n\tr->text_buf = NULL;\n\tr->text_buf_size = text_buf_size;\n}\n\nbool prb_reserve(struct prb_reserved_entry *e, struct printk_ringbuffer *rb,\n\t\t struct printk_record *r);\nbool prb_reserve_in_last(struct prb_reserved_entry *e, struct printk_ringbuffer *rb,\n\t\t\t struct printk_record *r, u32 caller_id, unsigned int max_size);\nvoid prb_commit(struct prb_reserved_entry *e);\nvoid prb_final_commit(struct prb_reserved_entry *e);\n\nvoid prb_init(struct printk_ringbuffer *rb,\n\t      char *text_buf, unsigned int text_buf_size,\n\t      struct prb_desc *descs, unsigned int descs_count_bits,\n\t      struct printk_info *infos);\nunsigned int prb_record_text_space(struct prb_reserved_entry *e);\n\n \n\n \nstatic inline void prb_rec_init_rd(struct printk_record *r,\n\t\t\t\t   struct printk_info *info,\n\t\t\t\t   char *text_buf, unsigned int text_buf_size)\n{\n\tr->info = info;\n\tr->text_buf = text_buf;\n\tr->text_buf_size = text_buf_size;\n}\n\n \n#define prb_for_each_record(from, rb, s, r) \\\nfor ((s) = from; prb_read_valid(rb, s, r); (s) = (r)->info->seq + 1)\n\n \n#define prb_for_each_info(from, rb, s, i, lc) \\\nfor ((s) = from; prb_read_valid_info(rb, s, i, lc); (s) = (i)->seq + 1)\n\nbool prb_read_valid(struct printk_ringbuffer *rb, u64 seq,\n\t\t    struct printk_record *r);\nbool prb_read_valid_info(struct printk_ringbuffer *rb, u64 seq,\n\t\t\t struct printk_info *info, unsigned int *line_count);\n\nu64 prb_first_valid_seq(struct printk_ringbuffer *rb);\nu64 prb_next_seq(struct printk_ringbuffer *rb);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}