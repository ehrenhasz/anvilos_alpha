{
  "module_name": "index.c",
  "hash_id": "64857f05dad1212de29f2c04f756ae168c0e554265fb44d70b3121f5c74ab0ac",
  "original_prompt": "Ingested from linux-6.6.14/kernel/printk/index.c",
  "human_readable_source": "\n \n\n#include <linux/debugfs.h>\n#include <linux/module.h>\n#include <linux/printk.h>\n#include <linux/slab.h>\n#include <linux/string_helpers.h>\n\n#include \"internal.h\"\n\nextern struct pi_entry *__start_printk_index[];\nextern struct pi_entry *__stop_printk_index[];\n\n \nstatic struct dentry *dfs_index;\n\nstatic struct pi_entry *pi_get_entry(const struct module *mod, loff_t pos)\n{\n\tstruct pi_entry **entries;\n\tunsigned int nr_entries;\n\n#ifdef CONFIG_MODULES\n\tif (mod) {\n\t\tentries = mod->printk_index_start;\n\t\tnr_entries = mod->printk_index_size;\n\t} else\n#endif\n\t{\n\t\t \n\t\tentries = __start_printk_index;\n\t\tnr_entries = __stop_printk_index - __start_printk_index;\n\t}\n\n\tif (pos >= nr_entries)\n\t\treturn NULL;\n\n\treturn entries[pos];\n}\n\nstatic void *pi_next(struct seq_file *s, void *v, loff_t *pos)\n{\n\tconst struct module *mod = s->file->f_inode->i_private;\n\tstruct pi_entry *entry = pi_get_entry(mod, *pos);\n\n\t(*pos)++;\n\n\treturn entry;\n}\n\nstatic void *pi_start(struct seq_file *s, loff_t *pos)\n{\n\t \n\tif (*pos == 0)\n\t\treturn SEQ_START_TOKEN;\n\n\treturn pi_next(s, NULL, pos);\n}\n\n \n#define seq_escape_printf_format(s, src) \\\n\tseq_escape_str(s, src, ESCAPE_ANY | ESCAPE_NAP | ESCAPE_APPEND, \"\\\"\\\\\")\n\nstatic int pi_show(struct seq_file *s, void *v)\n{\n\tconst struct pi_entry *entry = v;\n\tint level = LOGLEVEL_DEFAULT;\n\tenum printk_info_flags flags = 0;\n\tu16 prefix_len = 0;\n\n\tif (v == SEQ_START_TOKEN) {\n\t\tseq_puts(s, \"# <level/flags> filename:line function \\\"format\\\"\\n\");\n\t\treturn 0;\n\t}\n\n\tif (!entry->fmt)\n\t\treturn 0;\n\n\tif (entry->level)\n\t\tprintk_parse_prefix(entry->level, &level, &flags);\n\telse\n\t\tprefix_len = printk_parse_prefix(entry->fmt, &level, &flags);\n\n\n\tif (flags & LOG_CONT) {\n\t\t \n\t\tif (level == LOGLEVEL_DEFAULT)\n\t\t\tseq_puts(s, \"<c>\");\n\t\telse\n\t\t\tseq_printf(s, \"<%d,c>\", level);\n\t} else\n\t\tseq_printf(s, \"<%d>\", level);\n\n\tseq_printf(s, \" %s:%d %s \\\"\", entry->file, entry->line, entry->func);\n\tif (entry->subsys_fmt_prefix)\n\t\tseq_escape_printf_format(s, entry->subsys_fmt_prefix);\n\tseq_escape_printf_format(s, entry->fmt + prefix_len);\n\tseq_puts(s, \"\\\"\\n\");\n\n\treturn 0;\n}\n\nstatic void pi_stop(struct seq_file *p, void *v) { }\n\nstatic const struct seq_operations dfs_index_sops = {\n\t.start = pi_start,\n\t.next  = pi_next,\n\t.show  = pi_show,\n\t.stop  = pi_stop,\n};\n\nDEFINE_SEQ_ATTRIBUTE(dfs_index);\n\n#ifdef CONFIG_MODULES\nstatic const char *pi_get_module_name(struct module *mod)\n{\n\treturn mod ? mod->name : \"vmlinux\";\n}\n#else\nstatic const char *pi_get_module_name(struct module *mod)\n{\n\treturn \"vmlinux\";\n}\n#endif\n\nstatic void pi_create_file(struct module *mod)\n{\n\tdebugfs_create_file(pi_get_module_name(mod), 0444, dfs_index,\n\t\t\t\t       mod, &dfs_index_fops);\n}\n\n#ifdef CONFIG_MODULES\nstatic void pi_remove_file(struct module *mod)\n{\n\tdebugfs_lookup_and_remove(pi_get_module_name(mod), dfs_index);\n}\n\nstatic int pi_module_notify(struct notifier_block *nb, unsigned long op,\n\t\t\t    void *data)\n{\n\tstruct module *mod = data;\n\n\tswitch (op) {\n\tcase MODULE_STATE_COMING:\n\t\tpi_create_file(mod);\n\t\tbreak;\n\tcase MODULE_STATE_GOING:\n\t\tpi_remove_file(mod);\n\t\tbreak;\n\tdefault:  \n\t\tbreak;\n\t}\n\n\treturn NOTIFY_OK;\n}\n\nstatic struct notifier_block module_printk_fmts_nb = {\n\t.notifier_call = pi_module_notify,\n};\n\nstatic void __init pi_setup_module_notifier(void)\n{\n\tregister_module_notifier(&module_printk_fmts_nb);\n}\n#else\nstatic inline void __init pi_setup_module_notifier(void) { }\n#endif\n\nstatic int __init pi_init(void)\n{\n\tstruct dentry *dfs_root = debugfs_create_dir(\"printk\", NULL);\n\n\tdfs_index = debugfs_create_dir(\"index\", dfs_root);\n\tpi_setup_module_notifier();\n\tpi_create_file(NULL);\n\n\treturn 0;\n}\n\n \npostcore_initcall(pi_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}