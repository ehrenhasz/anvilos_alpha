{
  "module_name": "completion.c",
  "hash_id": "16a9b2c199fafdc2f6dc2b29d0c26b95bd1366b0507c2cdc8ee601adc75d3d32",
  "original_prompt": "Ingested from linux-6.6.14/kernel/sched/completion.c",
  "human_readable_source": "\n\n \n\nstatic void complete_with_flags(struct completion *x, int wake_flags)\n{\n\tunsigned long flags;\n\n\traw_spin_lock_irqsave(&x->wait.lock, flags);\n\n\tif (x->done != UINT_MAX)\n\t\tx->done++;\n\tswake_up_locked(&x->wait, wake_flags);\n\traw_spin_unlock_irqrestore(&x->wait.lock, flags);\n}\n\nvoid complete_on_current_cpu(struct completion *x)\n{\n\treturn complete_with_flags(x, WF_CURRENT_CPU);\n}\n\n \nvoid complete(struct completion *x)\n{\n\tcomplete_with_flags(x, 0);\n}\nEXPORT_SYMBOL(complete);\n\n \nvoid complete_all(struct completion *x)\n{\n\tunsigned long flags;\n\n\tlockdep_assert_RT_in_threaded_ctx();\n\n\traw_spin_lock_irqsave(&x->wait.lock, flags);\n\tx->done = UINT_MAX;\n\tswake_up_all_locked(&x->wait);\n\traw_spin_unlock_irqrestore(&x->wait.lock, flags);\n}\nEXPORT_SYMBOL(complete_all);\n\nstatic inline long __sched\ndo_wait_for_common(struct completion *x,\n\t\t   long (*action)(long), long timeout, int state)\n{\n\tif (!x->done) {\n\t\tDECLARE_SWAITQUEUE(wait);\n\n\t\tdo {\n\t\t\tif (signal_pending_state(state, current)) {\n\t\t\t\ttimeout = -ERESTARTSYS;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t__prepare_to_swait(&x->wait, &wait);\n\t\t\t__set_current_state(state);\n\t\t\traw_spin_unlock_irq(&x->wait.lock);\n\t\t\ttimeout = action(timeout);\n\t\t\traw_spin_lock_irq(&x->wait.lock);\n\t\t} while (!x->done && timeout);\n\t\t__finish_swait(&x->wait, &wait);\n\t\tif (!x->done)\n\t\t\treturn timeout;\n\t}\n\tif (x->done != UINT_MAX)\n\t\tx->done--;\n\treturn timeout ?: 1;\n}\n\nstatic inline long __sched\n__wait_for_common(struct completion *x,\n\t\t  long (*action)(long), long timeout, int state)\n{\n\tmight_sleep();\n\n\tcomplete_acquire(x);\n\n\traw_spin_lock_irq(&x->wait.lock);\n\ttimeout = do_wait_for_common(x, action, timeout, state);\n\traw_spin_unlock_irq(&x->wait.lock);\n\n\tcomplete_release(x);\n\n\treturn timeout;\n}\n\nstatic long __sched\nwait_for_common(struct completion *x, long timeout, int state)\n{\n\treturn __wait_for_common(x, schedule_timeout, timeout, state);\n}\n\nstatic long __sched\nwait_for_common_io(struct completion *x, long timeout, int state)\n{\n\treturn __wait_for_common(x, io_schedule_timeout, timeout, state);\n}\n\n \nvoid __sched wait_for_completion(struct completion *x)\n{\n\twait_for_common(x, MAX_SCHEDULE_TIMEOUT, TASK_UNINTERRUPTIBLE);\n}\nEXPORT_SYMBOL(wait_for_completion);\n\n \nunsigned long __sched\nwait_for_completion_timeout(struct completion *x, unsigned long timeout)\n{\n\treturn wait_for_common(x, timeout, TASK_UNINTERRUPTIBLE);\n}\nEXPORT_SYMBOL(wait_for_completion_timeout);\n\n \nvoid __sched wait_for_completion_io(struct completion *x)\n{\n\twait_for_common_io(x, MAX_SCHEDULE_TIMEOUT, TASK_UNINTERRUPTIBLE);\n}\nEXPORT_SYMBOL(wait_for_completion_io);\n\n \nunsigned long __sched\nwait_for_completion_io_timeout(struct completion *x, unsigned long timeout)\n{\n\treturn wait_for_common_io(x, timeout, TASK_UNINTERRUPTIBLE);\n}\nEXPORT_SYMBOL(wait_for_completion_io_timeout);\n\n \nint __sched wait_for_completion_interruptible(struct completion *x)\n{\n\tlong t = wait_for_common(x, MAX_SCHEDULE_TIMEOUT, TASK_INTERRUPTIBLE);\n\n\tif (t == -ERESTARTSYS)\n\t\treturn t;\n\treturn 0;\n}\nEXPORT_SYMBOL(wait_for_completion_interruptible);\n\n \nlong __sched\nwait_for_completion_interruptible_timeout(struct completion *x,\n\t\t\t\t\t  unsigned long timeout)\n{\n\treturn wait_for_common(x, timeout, TASK_INTERRUPTIBLE);\n}\nEXPORT_SYMBOL(wait_for_completion_interruptible_timeout);\n\n \nint __sched wait_for_completion_killable(struct completion *x)\n{\n\tlong t = wait_for_common(x, MAX_SCHEDULE_TIMEOUT, TASK_KILLABLE);\n\n\tif (t == -ERESTARTSYS)\n\t\treturn t;\n\treturn 0;\n}\nEXPORT_SYMBOL(wait_for_completion_killable);\n\nint __sched wait_for_completion_state(struct completion *x, unsigned int state)\n{\n\tlong t = wait_for_common(x, MAX_SCHEDULE_TIMEOUT, state);\n\n\tif (t == -ERESTARTSYS)\n\t\treturn t;\n\treturn 0;\n}\nEXPORT_SYMBOL(wait_for_completion_state);\n\n \nlong __sched\nwait_for_completion_killable_timeout(struct completion *x,\n\t\t\t\t     unsigned long timeout)\n{\n\treturn wait_for_common(x, timeout, TASK_KILLABLE);\n}\nEXPORT_SYMBOL(wait_for_completion_killable_timeout);\n\n \nbool try_wait_for_completion(struct completion *x)\n{\n\tunsigned long flags;\n\tbool ret = true;\n\n\t \n\tif (!READ_ONCE(x->done))\n\t\treturn false;\n\n\traw_spin_lock_irqsave(&x->wait.lock, flags);\n\tif (!x->done)\n\t\tret = false;\n\telse if (x->done != UINT_MAX)\n\t\tx->done--;\n\traw_spin_unlock_irqrestore(&x->wait.lock, flags);\n\treturn ret;\n}\nEXPORT_SYMBOL(try_wait_for_completion);\n\n \nbool completion_done(struct completion *x)\n{\n\tunsigned long flags;\n\n\tif (!READ_ONCE(x->done))\n\t\treturn false;\n\n\t \n\traw_spin_lock_irqsave(&x->wait.lock, flags);\n\traw_spin_unlock_irqrestore(&x->wait.lock, flags);\n\treturn true;\n}\nEXPORT_SYMBOL(completion_done);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}