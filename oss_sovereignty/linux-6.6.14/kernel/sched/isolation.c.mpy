{
  "module_name": "isolation.c",
  "hash_id": "a5dc586c6c047ecc7de3b625a4c1fd5dbfe5313e1521dd0eab0cbd5fcff67d3a",
  "original_prompt": "Ingested from linux-6.6.14/kernel/sched/isolation.c",
  "human_readable_source": "\n \n\nenum hk_flags {\n\tHK_FLAG_TIMER\t\t= BIT(HK_TYPE_TIMER),\n\tHK_FLAG_RCU\t\t= BIT(HK_TYPE_RCU),\n\tHK_FLAG_MISC\t\t= BIT(HK_TYPE_MISC),\n\tHK_FLAG_SCHED\t\t= BIT(HK_TYPE_SCHED),\n\tHK_FLAG_TICK\t\t= BIT(HK_TYPE_TICK),\n\tHK_FLAG_DOMAIN\t\t= BIT(HK_TYPE_DOMAIN),\n\tHK_FLAG_WQ\t\t= BIT(HK_TYPE_WQ),\n\tHK_FLAG_MANAGED_IRQ\t= BIT(HK_TYPE_MANAGED_IRQ),\n\tHK_FLAG_KTHREAD\t\t= BIT(HK_TYPE_KTHREAD),\n};\n\nDEFINE_STATIC_KEY_FALSE(housekeeping_overridden);\nEXPORT_SYMBOL_GPL(housekeeping_overridden);\n\nstruct housekeeping {\n\tcpumask_var_t cpumasks[HK_TYPE_MAX];\n\tunsigned long flags;\n};\n\nstatic struct housekeeping housekeeping;\n\nbool housekeeping_enabled(enum hk_type type)\n{\n\treturn !!(housekeeping.flags & BIT(type));\n}\nEXPORT_SYMBOL_GPL(housekeeping_enabled);\n\nint housekeeping_any_cpu(enum hk_type type)\n{\n\tint cpu;\n\n\tif (static_branch_unlikely(&housekeeping_overridden)) {\n\t\tif (housekeeping.flags & BIT(type)) {\n\t\t\tcpu = sched_numa_find_closest(housekeeping.cpumasks[type], smp_processor_id());\n\t\t\tif (cpu < nr_cpu_ids)\n\t\t\t\treturn cpu;\n\n\t\t\treturn cpumask_any_and(housekeeping.cpumasks[type], cpu_online_mask);\n\t\t}\n\t}\n\treturn smp_processor_id();\n}\nEXPORT_SYMBOL_GPL(housekeeping_any_cpu);\n\nconst struct cpumask *housekeeping_cpumask(enum hk_type type)\n{\n\tif (static_branch_unlikely(&housekeeping_overridden))\n\t\tif (housekeeping.flags & BIT(type))\n\t\t\treturn housekeeping.cpumasks[type];\n\treturn cpu_possible_mask;\n}\nEXPORT_SYMBOL_GPL(housekeeping_cpumask);\n\nvoid housekeeping_affine(struct task_struct *t, enum hk_type type)\n{\n\tif (static_branch_unlikely(&housekeeping_overridden))\n\t\tif (housekeeping.flags & BIT(type))\n\t\t\tset_cpus_allowed_ptr(t, housekeeping.cpumasks[type]);\n}\nEXPORT_SYMBOL_GPL(housekeeping_affine);\n\nbool housekeeping_test_cpu(int cpu, enum hk_type type)\n{\n\tif (static_branch_unlikely(&housekeeping_overridden))\n\t\tif (housekeeping.flags & BIT(type))\n\t\t\treturn cpumask_test_cpu(cpu, housekeeping.cpumasks[type]);\n\treturn true;\n}\nEXPORT_SYMBOL_GPL(housekeeping_test_cpu);\n\nvoid __init housekeeping_init(void)\n{\n\tenum hk_type type;\n\n\tif (!housekeeping.flags)\n\t\treturn;\n\n\tstatic_branch_enable(&housekeeping_overridden);\n\n\tif (housekeeping.flags & HK_FLAG_TICK)\n\t\tsched_tick_offload_init();\n\n\tfor_each_set_bit(type, &housekeeping.flags, HK_TYPE_MAX) {\n\t\t \n\t\tWARN_ON_ONCE(cpumask_empty(housekeeping.cpumasks[type]));\n\t}\n}\n\nstatic void __init housekeeping_setup_type(enum hk_type type,\n\t\t\t\t\t   cpumask_var_t housekeeping_staging)\n{\n\n\talloc_bootmem_cpumask_var(&housekeeping.cpumasks[type]);\n\tcpumask_copy(housekeeping.cpumasks[type],\n\t\t     housekeeping_staging);\n}\n\nstatic int __init housekeeping_setup(char *str, unsigned long flags)\n{\n\tcpumask_var_t non_housekeeping_mask, housekeeping_staging;\n\tint err = 0;\n\n\tif ((flags & HK_FLAG_TICK) && !(housekeeping.flags & HK_FLAG_TICK)) {\n\t\tif (!IS_ENABLED(CONFIG_NO_HZ_FULL)) {\n\t\t\tpr_warn(\"Housekeeping: nohz unsupported.\"\n\t\t\t\t\" Build with CONFIG_NO_HZ_FULL\\n\");\n\t\t\treturn 0;\n\t\t}\n\t}\n\n\talloc_bootmem_cpumask_var(&non_housekeeping_mask);\n\tif (cpulist_parse(str, non_housekeeping_mask) < 0) {\n\t\tpr_warn(\"Housekeeping: nohz_full= or isolcpus= incorrect CPU range\\n\");\n\t\tgoto free_non_housekeeping_mask;\n\t}\n\n\talloc_bootmem_cpumask_var(&housekeeping_staging);\n\tcpumask_andnot(housekeeping_staging,\n\t\t       cpu_possible_mask, non_housekeeping_mask);\n\n\tif (!cpumask_intersects(cpu_present_mask, housekeeping_staging)) {\n\t\t__cpumask_set_cpu(smp_processor_id(), housekeeping_staging);\n\t\t__cpumask_clear_cpu(smp_processor_id(), non_housekeeping_mask);\n\t\tif (!housekeeping.flags) {\n\t\t\tpr_warn(\"Housekeeping: must include one present CPU, \"\n\t\t\t\t\"using boot CPU:%d\\n\", smp_processor_id());\n\t\t}\n\t}\n\n\tif (!housekeeping.flags) {\n\t\t \n\t\tenum hk_type type;\n\n\t\tfor_each_set_bit(type, &flags, HK_TYPE_MAX)\n\t\t\thousekeeping_setup_type(type, housekeeping_staging);\n\t} else {\n\t\t \n\t\tenum hk_type type;\n\t\tunsigned long iter_flags = flags & housekeeping.flags;\n\n\t\tfor_each_set_bit(type, &iter_flags, HK_TYPE_MAX) {\n\t\t\tif (!cpumask_equal(housekeeping_staging,\n\t\t\t\t\t   housekeeping.cpumasks[type])) {\n\t\t\t\tpr_warn(\"Housekeeping: nohz_full= must match isolcpus=\\n\");\n\t\t\t\tgoto free_housekeeping_staging;\n\t\t\t}\n\t\t}\n\n\t\titer_flags = flags & ~housekeeping.flags;\n\n\t\tfor_each_set_bit(type, &iter_flags, HK_TYPE_MAX)\n\t\t\thousekeeping_setup_type(type, housekeeping_staging);\n\t}\n\n\tif ((flags & HK_FLAG_TICK) && !(housekeeping.flags & HK_FLAG_TICK))\n\t\ttick_nohz_full_setup(non_housekeeping_mask);\n\n\thousekeeping.flags |= flags;\n\terr = 1;\n\nfree_housekeeping_staging:\n\tfree_bootmem_cpumask_var(housekeeping_staging);\nfree_non_housekeeping_mask:\n\tfree_bootmem_cpumask_var(non_housekeeping_mask);\n\n\treturn err;\n}\n\nstatic int __init housekeeping_nohz_full_setup(char *str)\n{\n\tunsigned long flags;\n\n\tflags = HK_FLAG_TICK | HK_FLAG_WQ | HK_FLAG_TIMER | HK_FLAG_RCU |\n\t\tHK_FLAG_MISC | HK_FLAG_KTHREAD;\n\n\treturn housekeeping_setup(str, flags);\n}\n__setup(\"nohz_full=\", housekeeping_nohz_full_setup);\n\nstatic int __init housekeeping_isolcpus_setup(char *str)\n{\n\tunsigned long flags = 0;\n\tbool illegal = false;\n\tchar *par;\n\tint len;\n\n\twhile (isalpha(*str)) {\n\t\tif (!strncmp(str, \"nohz,\", 5)) {\n\t\t\tstr += 5;\n\t\t\tflags |= HK_FLAG_TICK;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (!strncmp(str, \"domain,\", 7)) {\n\t\t\tstr += 7;\n\t\t\tflags |= HK_FLAG_DOMAIN;\n\t\t\tcontinue;\n\t\t}\n\n\t\tif (!strncmp(str, \"managed_irq,\", 12)) {\n\t\t\tstr += 12;\n\t\t\tflags |= HK_FLAG_MANAGED_IRQ;\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tfor (par = str, len = 0; *str && *str != ','; str++, len++) {\n\t\t\tif (!isalpha(*str) && *str != '_')\n\t\t\t\tillegal = true;\n\t\t}\n\n\t\tif (illegal) {\n\t\t\tpr_warn(\"isolcpus: Invalid flag %.*s\\n\", len, par);\n\t\t\treturn 0;\n\t\t}\n\n\t\tpr_info(\"isolcpus: Skipped unknown flag %.*s\\n\", len, par);\n\t\tstr++;\n\t}\n\n\t \n\tif (!flags)\n\t\tflags |= HK_FLAG_DOMAIN;\n\n\treturn housekeeping_setup(str, flags);\n}\n__setup(\"isolcpus=\", housekeeping_isolcpus_setup);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}