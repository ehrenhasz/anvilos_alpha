{
  "module_name": "trace_sched_switch.c",
  "hash_id": "259b95d7ad93991de5d6ec78255951b0973a5fab009fb709243a6758c820ea56",
  "original_prompt": "Ingested from linux-6.6.14/kernel/trace/trace_sched_switch.c",
  "human_readable_source": "\n \n#include <linux/module.h>\n#include <linux/kallsyms.h>\n#include <linux/uaccess.h>\n#include <linux/ftrace.h>\n#include <trace/events/sched.h>\n\n#include \"trace.h\"\n\n#define RECORD_CMDLINE\t1\n#define RECORD_TGID\t2\n\nstatic int\t\tsched_cmdline_ref;\nstatic int\t\tsched_tgid_ref;\nstatic DEFINE_MUTEX(sched_register_mutex);\n\nstatic void\nprobe_sched_switch(void *ignore, bool preempt,\n\t\t   struct task_struct *prev, struct task_struct *next,\n\t\t   unsigned int prev_state)\n{\n\tint flags;\n\n\tflags = (RECORD_TGID * !!sched_tgid_ref) +\n\t\t(RECORD_CMDLINE * !!sched_cmdline_ref);\n\n\tif (!flags)\n\t\treturn;\n\ttracing_record_taskinfo_sched_switch(prev, next, flags);\n}\n\nstatic void\nprobe_sched_wakeup(void *ignore, struct task_struct *wakee)\n{\n\tint flags;\n\n\tflags = (RECORD_TGID * !!sched_tgid_ref) +\n\t\t(RECORD_CMDLINE * !!sched_cmdline_ref);\n\n\tif (!flags)\n\t\treturn;\n\ttracing_record_taskinfo_sched_switch(current, wakee, flags);\n}\n\nstatic int tracing_sched_register(void)\n{\n\tint ret;\n\n\tret = register_trace_sched_wakeup(probe_sched_wakeup, NULL);\n\tif (ret) {\n\t\tpr_info(\"wakeup trace: Couldn't activate tracepoint\"\n\t\t\t\" probe to kernel_sched_wakeup\\n\");\n\t\treturn ret;\n\t}\n\n\tret = register_trace_sched_wakeup_new(probe_sched_wakeup, NULL);\n\tif (ret) {\n\t\tpr_info(\"wakeup trace: Couldn't activate tracepoint\"\n\t\t\t\" probe to kernel_sched_wakeup_new\\n\");\n\t\tgoto fail_deprobe;\n\t}\n\n\tret = register_trace_sched_switch(probe_sched_switch, NULL);\n\tif (ret) {\n\t\tpr_info(\"sched trace: Couldn't activate tracepoint\"\n\t\t\t\" probe to kernel_sched_switch\\n\");\n\t\tgoto fail_deprobe_wake_new;\n\t}\n\n\treturn ret;\nfail_deprobe_wake_new:\n\tunregister_trace_sched_wakeup_new(probe_sched_wakeup, NULL);\nfail_deprobe:\n\tunregister_trace_sched_wakeup(probe_sched_wakeup, NULL);\n\treturn ret;\n}\n\nstatic void tracing_sched_unregister(void)\n{\n\tunregister_trace_sched_switch(probe_sched_switch, NULL);\n\tunregister_trace_sched_wakeup_new(probe_sched_wakeup, NULL);\n\tunregister_trace_sched_wakeup(probe_sched_wakeup, NULL);\n}\n\nstatic void tracing_start_sched_switch(int ops)\n{\n\tbool sched_register;\n\n\tmutex_lock(&sched_register_mutex);\n\tsched_register = (!sched_cmdline_ref && !sched_tgid_ref);\n\n\tswitch (ops) {\n\tcase RECORD_CMDLINE:\n\t\tsched_cmdline_ref++;\n\t\tbreak;\n\n\tcase RECORD_TGID:\n\t\tsched_tgid_ref++;\n\t\tbreak;\n\t}\n\n\tif (sched_register && (sched_cmdline_ref || sched_tgid_ref))\n\t\ttracing_sched_register();\n\tmutex_unlock(&sched_register_mutex);\n}\n\nstatic void tracing_stop_sched_switch(int ops)\n{\n\tmutex_lock(&sched_register_mutex);\n\n\tswitch (ops) {\n\tcase RECORD_CMDLINE:\n\t\tsched_cmdline_ref--;\n\t\tbreak;\n\n\tcase RECORD_TGID:\n\t\tsched_tgid_ref--;\n\t\tbreak;\n\t}\n\n\tif (!sched_cmdline_ref && !sched_tgid_ref)\n\t\ttracing_sched_unregister();\n\tmutex_unlock(&sched_register_mutex);\n}\n\nvoid tracing_start_cmdline_record(void)\n{\n\ttracing_start_sched_switch(RECORD_CMDLINE);\n}\n\nvoid tracing_stop_cmdline_record(void)\n{\n\ttracing_stop_sched_switch(RECORD_CMDLINE);\n}\n\nvoid tracing_start_tgid_record(void)\n{\n\ttracing_start_sched_switch(RECORD_TGID);\n}\n\nvoid tracing_stop_tgid_record(void)\n{\n\ttracing_stop_sched_switch(RECORD_TGID);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}