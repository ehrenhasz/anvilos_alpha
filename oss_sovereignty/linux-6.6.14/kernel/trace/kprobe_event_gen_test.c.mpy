{
  "module_name": "kprobe_event_gen_test.c",
  "hash_id": "821f8bb2276ae6690c9d1b34342de823c2b80f24ab135e57fff41fab37d70deb",
  "original_prompt": "Ingested from linux-6.6.14/kernel/trace/kprobe_event_gen_test.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/trace_events.h>\n\n \n\nstatic struct trace_event_file *gen_kprobe_test;\nstatic struct trace_event_file *gen_kretprobe_test;\n\n#define KPROBE_GEN_TEST_FUNC\t\"do_sys_open\"\n\n \n#if defined(CONFIG_X86_64) || defined(CONFIG_X86_32)\n#define KPROBE_GEN_TEST_ARG0\t\"dfd=%ax\"\n#define KPROBE_GEN_TEST_ARG1\t\"filename=%dx\"\n#define KPROBE_GEN_TEST_ARG2\t\"flags=%cx\"\n#define KPROBE_GEN_TEST_ARG3\t\"mode=+4($stack)\"\n\n \n#elif defined(CONFIG_ARM64)\n#define KPROBE_GEN_TEST_ARG0\t\"dfd=%x0\"\n#define KPROBE_GEN_TEST_ARG1\t\"filename=%x1\"\n#define KPROBE_GEN_TEST_ARG2\t\"flags=%x2\"\n#define KPROBE_GEN_TEST_ARG3\t\"mode=%x3\"\n\n \n#elif defined(CONFIG_ARM)\n#define KPROBE_GEN_TEST_ARG0\t\"dfd=%r0\"\n#define KPROBE_GEN_TEST_ARG1\t\"filename=%r1\"\n#define KPROBE_GEN_TEST_ARG2\t\"flags=%r2\"\n#define KPROBE_GEN_TEST_ARG3\t\"mode=%r3\"\n\n \n#elif defined(CONFIG_RISCV)\n#define KPROBE_GEN_TEST_ARG0\t\"dfd=%a0\"\n#define KPROBE_GEN_TEST_ARG1\t\"filename=%a1\"\n#define KPROBE_GEN_TEST_ARG2\t\"flags=%a2\"\n#define KPROBE_GEN_TEST_ARG3\t\"mode=%a3\"\n\n \n#else\n#define KPROBE_GEN_TEST_ARG0\tNULL\n#define KPROBE_GEN_TEST_ARG1\tNULL\n#define KPROBE_GEN_TEST_ARG2\tNULL\n#define KPROBE_GEN_TEST_ARG3\tNULL\n#endif\n\nstatic bool trace_event_file_is_valid(struct trace_event_file *input)\n{\n\treturn input && !IS_ERR(input);\n}\n\n \nstatic int __init test_gen_kprobe_cmd(void)\n{\n\tstruct dynevent_cmd cmd;\n\tchar *buf;\n\tint ret;\n\n\t \n\tbuf = kzalloc(MAX_DYNEVENT_CMD_LEN, GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\t \n\tkprobe_event_cmd_init(&cmd, buf, MAX_DYNEVENT_CMD_LEN);\n\n\t \n\tret = kprobe_event_gen_cmd_start(&cmd, \"gen_kprobe_test\",\n\t\t\t\t\t KPROBE_GEN_TEST_FUNC,\n\t\t\t\t\t KPROBE_GEN_TEST_ARG0, KPROBE_GEN_TEST_ARG1);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\n\tret = kprobe_event_add_fields(&cmd, KPROBE_GEN_TEST_ARG2, KPROBE_GEN_TEST_ARG3);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = kprobe_event_gen_cmd_end(&cmd);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tgen_kprobe_test = trace_get_event_file(NULL, \"kprobes\",\n\t\t\t\t\t       \"gen_kprobe_test\");\n\tif (IS_ERR(gen_kprobe_test)) {\n\t\tret = PTR_ERR(gen_kprobe_test);\n\t\tgoto delete;\n\t}\n\n\t \n\tret = trace_array_set_clr_event(gen_kprobe_test->tr,\n\t\t\t\t\t\"kprobes\", \"gen_kprobe_test\", true);\n\tif (ret) {\n\t\ttrace_put_event_file(gen_kprobe_test);\n\t\tgoto delete;\n\t}\n out:\n\tkfree(buf);\n\treturn ret;\n delete:\n\tif (trace_event_file_is_valid(gen_kprobe_test))\n\t\tgen_kprobe_test = NULL;\n\t \n\tkprobe_event_delete(\"gen_kprobe_test\");\n\tgoto out;\n}\n\n \nstatic int __init test_gen_kretprobe_cmd(void)\n{\n\tstruct dynevent_cmd cmd;\n\tchar *buf;\n\tint ret;\n\n\t \n\tbuf = kzalloc(MAX_DYNEVENT_CMD_LEN, GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\t \n\tkprobe_event_cmd_init(&cmd, buf, MAX_DYNEVENT_CMD_LEN);\n\n\t \n\tret = kretprobe_event_gen_cmd_start(&cmd, \"gen_kretprobe_test\",\n\t\t\t\t\t    KPROBE_GEN_TEST_FUNC,\n\t\t\t\t\t    \"$retval\");\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = kretprobe_event_gen_cmd_end(&cmd);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tgen_kretprobe_test = trace_get_event_file(NULL, \"kprobes\",\n\t\t\t\t\t\t  \"gen_kretprobe_test\");\n\tif (IS_ERR(gen_kretprobe_test)) {\n\t\tret = PTR_ERR(gen_kretprobe_test);\n\t\tgoto delete;\n\t}\n\n\t \n\tret = trace_array_set_clr_event(gen_kretprobe_test->tr,\n\t\t\t\t\t\"kprobes\", \"gen_kretprobe_test\", true);\n\tif (ret) {\n\t\ttrace_put_event_file(gen_kretprobe_test);\n\t\tgoto delete;\n\t}\n out:\n\tkfree(buf);\n\treturn ret;\n delete:\n\tif (trace_event_file_is_valid(gen_kretprobe_test))\n\t\tgen_kretprobe_test = NULL;\n\t \n\tkprobe_event_delete(\"gen_kretprobe_test\");\n\tgoto out;\n}\n\nstatic int __init kprobe_event_gen_test_init(void)\n{\n\tint ret;\n\n\tret = test_gen_kprobe_cmd();\n\tif (ret)\n\t\treturn ret;\n\n\tret = test_gen_kretprobe_cmd();\n\tif (ret) {\n\t\tif (trace_event_file_is_valid(gen_kretprobe_test)) {\n\t\t\tWARN_ON(trace_array_set_clr_event(gen_kretprobe_test->tr,\n\t\t\t\t\t\t\t  \"kprobes\",\n\t\t\t\t\t\t\t  \"gen_kretprobe_test\", false));\n\t\t\ttrace_put_event_file(gen_kretprobe_test);\n\t\t}\n\t\tWARN_ON(kprobe_event_delete(\"gen_kretprobe_test\"));\n\t}\n\n\treturn ret;\n}\n\nstatic void __exit kprobe_event_gen_test_exit(void)\n{\n\tif (trace_event_file_is_valid(gen_kprobe_test)) {\n\t\t \n\t\tWARN_ON(trace_array_set_clr_event(gen_kprobe_test->tr,\n\t\t\t\t\t\t  \"kprobes\",\n\t\t\t\t\t\t  \"gen_kprobe_test\", false));\n\n\t\t \n\t\ttrace_put_event_file(gen_kprobe_test);\n\t}\n\n\n\t \n\tWARN_ON(kprobe_event_delete(\"gen_kprobe_test\"));\n\n\tif (trace_event_file_is_valid(gen_kretprobe_test)) {\n\t\t \n\t\tWARN_ON(trace_array_set_clr_event(gen_kretprobe_test->tr,\n\t\t\t\t\t\t  \"kprobes\",\n\t\t\t\t\t\t  \"gen_kretprobe_test\", false));\n\n\t\t \n\t\ttrace_put_event_file(gen_kretprobe_test);\n\t}\n\n\n\t \n\tWARN_ON(kprobe_event_delete(\"gen_kretprobe_test\"));\n}\n\nmodule_init(kprobe_event_gen_test_init)\nmodule_exit(kprobe_event_gen_test_exit)\n\nMODULE_AUTHOR(\"Tom Zanussi\");\nMODULE_DESCRIPTION(\"kprobe event generation test\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}