{
  "module_name": "trace_clock.c",
  "hash_id": "7e958ee97697d80ff777a96449f20ebc3ddbefbb004cebb4352a4dce63813d7f",
  "original_prompt": "Ingested from linux-6.6.14/kernel/trace/trace_clock.c",
  "human_readable_source": "\n \n#include <linux/spinlock.h>\n#include <linux/irqflags.h>\n#include <linux/hardirq.h>\n#include <linux/module.h>\n#include <linux/percpu.h>\n#include <linux/sched.h>\n#include <linux/sched/clock.h>\n#include <linux/ktime.h>\n#include <linux/trace_clock.h>\n\n \nu64 notrace trace_clock_local(void)\n{\n\tu64 clock;\n\n\t \n\tpreempt_disable_notrace();\n\tclock = sched_clock();\n\tpreempt_enable_notrace();\n\n\treturn clock;\n}\nEXPORT_SYMBOL_GPL(trace_clock_local);\n\n \nu64 notrace trace_clock(void)\n{\n\treturn local_clock();\n}\nEXPORT_SYMBOL_GPL(trace_clock);\n\n \nu64 notrace trace_clock_jiffies(void)\n{\n\treturn jiffies_64_to_clock_t(jiffies_64 - INITIAL_JIFFIES);\n}\nEXPORT_SYMBOL_GPL(trace_clock_jiffies);\n\n \n\n \nstatic struct {\n\tu64 prev_time;\n\tarch_spinlock_t lock;\n} trace_clock_struct ____cacheline_aligned_in_smp =\n\t{\n\t\t.lock = (arch_spinlock_t)__ARCH_SPIN_LOCK_UNLOCKED,\n\t};\n\nu64 notrace trace_clock_global(void)\n{\n\tunsigned long flags;\n\tint this_cpu;\n\tu64 now, prev_time;\n\n\traw_local_irq_save(flags);\n\n\tthis_cpu = raw_smp_processor_id();\n\n\t \n\tsmp_rmb();\n\tprev_time = READ_ONCE(trace_clock_struct.prev_time);\n\tnow = sched_clock_cpu(this_cpu);\n\n\t \n\tif ((s64)(now - prev_time) < 0)\n\t\tnow = prev_time;\n\n\t \n\tif (unlikely(in_nmi()))\n\t\tgoto out;\n\n\t \n\tif (arch_spin_trylock(&trace_clock_struct.lock)) {\n\t\t \n\t\tprev_time = READ_ONCE(trace_clock_struct.prev_time);\n\t\tif ((s64)(now - prev_time) < 0)\n\t\t\tnow = prev_time;\n\n\t\ttrace_clock_struct.prev_time = now;\n\n\t\t \n\t\tarch_spin_unlock(&trace_clock_struct.lock);\n\t}\n out:\n\traw_local_irq_restore(flags);\n\n\treturn now;\n}\nEXPORT_SYMBOL_GPL(trace_clock_global);\n\nstatic atomic64_t trace_counter;\n\n \nu64 notrace trace_clock_counter(void)\n{\n\treturn atomic64_add_return(1, &trace_counter);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}