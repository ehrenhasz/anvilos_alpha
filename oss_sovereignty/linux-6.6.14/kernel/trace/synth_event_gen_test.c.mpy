{
  "module_name": "synth_event_gen_test.c",
  "hash_id": "396a5c28bb9768d677da31fc4f03c1b3e76925169f1b7ff502191db1ee519ef8",
  "original_prompt": "Ingested from linux-6.6.14/kernel/trace/synth_event_gen_test.c",
  "human_readable_source": "\n \n\n#include <linux/module.h>\n#include <linux/trace_events.h>\n\n \n\nstatic struct trace_event_file *create_synth_test;\nstatic struct trace_event_file *empty_synth_test;\nstatic struct trace_event_file *gen_synth_test;\n\n \nstatic int __init test_gen_synth_cmd(void)\n{\n\tstruct dynevent_cmd cmd;\n\tu64 vals[7];\n\tchar *buf;\n\tint ret;\n\n\t \n\tbuf = kzalloc(MAX_DYNEVENT_CMD_LEN, GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\t \n\tsynth_event_cmd_init(&cmd, buf, MAX_DYNEVENT_CMD_LEN);\n\n\t \n\tret = synth_event_gen_cmd_start(&cmd, \"gen_synth_test\", THIS_MODULE,\n\t\t\t\t\t\"pid_t\", \"next_pid_field\",\n\t\t\t\t\t\"char[16]\", \"next_comm_field\",\n\t\t\t\t\t\"u64\", \"ts_ns\",\n\t\t\t\t\t\"u64\", \"ts_ms\");\n\tif (ret)\n\t\tgoto free;\n\n\t \n\n\tret = synth_event_add_field(&cmd, \"unsigned int\", \"cpu\");\n\tif (ret)\n\t\tgoto free;\n\n\tret = synth_event_add_field(&cmd, \"char[64]\", \"my_string_field\");\n\tif (ret)\n\t\tgoto free;\n\n\tret = synth_event_add_field(&cmd, \"int\", \"my_int_field\");\n\tif (ret)\n\t\tgoto free;\n\n\tret = synth_event_gen_cmd_end(&cmd);\n\tif (ret)\n\t\tgoto free;\n\n\t \n\tgen_synth_test = trace_get_event_file(NULL, \"synthetic\",\n\t\t\t\t\t      \"gen_synth_test\");\n\tif (IS_ERR(gen_synth_test)) {\n\t\tret = PTR_ERR(gen_synth_test);\n\t\tgoto delete;\n\t}\n\n\t \n\tret = trace_array_set_clr_event(gen_synth_test->tr,\n\t\t\t\t\t\"synthetic\", \"gen_synth_test\", true);\n\tif (ret) {\n\t\ttrace_put_event_file(gen_synth_test);\n\t\tgoto delete;\n\t}\n\n\t \n\n\tvals[0] = 777;\t\t\t \n\tvals[1] = (u64)(long)\"hula hoops\";\t \n\tvals[2] = 1000000;\t\t \n\tvals[3] = 1000;\t\t\t \n\tvals[4] = raw_smp_processor_id();  \n\tvals[5] = (u64)(long)\"thneed\";\t \n\tvals[6] = 598;\t\t\t \n\n\t \n\tret = synth_event_trace_array(gen_synth_test, vals, ARRAY_SIZE(vals));\n free:\n\tkfree(buf);\n\treturn ret;\n delete:\n\t \n\tsynth_event_delete(\"gen_synth_test\");\n\tgoto free;\n}\n\n \nstatic int __init test_empty_synth_event(void)\n{\n\tstruct dynevent_cmd cmd;\n\tu64 vals[7];\n\tchar *buf;\n\tint ret;\n\n\t \n\tbuf = kzalloc(MAX_DYNEVENT_CMD_LEN, GFP_KERNEL);\n\tif (!buf)\n\t\treturn -ENOMEM;\n\n\t \n\tsynth_event_cmd_init(&cmd, buf, MAX_DYNEVENT_CMD_LEN);\n\n\t \n\tret = synth_event_gen_cmd_start(&cmd, \"empty_synth_test\", THIS_MODULE);\n\tif (ret)\n\t\tgoto free;\n\n\t \n\n\tret = synth_event_add_field(&cmd, \"pid_t\", \"next_pid_field\");\n\tif (ret)\n\t\tgoto free;\n\n\tret = synth_event_add_field(&cmd, \"char[16]\", \"next_comm_field\");\n\tif (ret)\n\t\tgoto free;\n\n\tret = synth_event_add_field(&cmd, \"u64\", \"ts_ns\");\n\tif (ret)\n\t\tgoto free;\n\n\tret = synth_event_add_field(&cmd, \"u64\", \"ts_ms\");\n\tif (ret)\n\t\tgoto free;\n\n\tret = synth_event_add_field(&cmd, \"unsigned int\", \"cpu\");\n\tif (ret)\n\t\tgoto free;\n\n\tret = synth_event_add_field(&cmd, \"char[64]\", \"my_string_field\");\n\tif (ret)\n\t\tgoto free;\n\n\tret = synth_event_add_field(&cmd, \"int\", \"my_int_field\");\n\tif (ret)\n\t\tgoto free;\n\n\t \n\n\tret = synth_event_gen_cmd_end(&cmd);\n\tif (ret)\n\t\tgoto free;\n\n\t \n\tempty_synth_test = trace_get_event_file(NULL, \"synthetic\",\n\t\t\t\t\t\t\"empty_synth_test\");\n\tif (IS_ERR(empty_synth_test)) {\n\t\tret = PTR_ERR(empty_synth_test);\n\t\tgoto delete;\n\t}\n\n\t \n\tret = trace_array_set_clr_event(empty_synth_test->tr,\n\t\t\t\t\t\"synthetic\", \"empty_synth_test\", true);\n\tif (ret) {\n\t\ttrace_put_event_file(empty_synth_test);\n\t\tgoto delete;\n\t}\n\n\t \n\n\tvals[0] = 777;\t\t\t \n\tvals[1] = (u64)(long)\"tiddlywinks\";\t \n\tvals[2] = 1000000;\t\t \n\tvals[3] = 1000;\t\t\t \n\tvals[4] = raw_smp_processor_id();  \n\tvals[5] = (u64)(long)\"thneed_2.0\";\t \n\tvals[6] = 399;\t\t\t \n\n\t \n\tret = synth_event_trace_array(empty_synth_test, vals, ARRAY_SIZE(vals));\n free:\n\tkfree(buf);\n\treturn ret;\n delete:\n\t \n\tsynth_event_delete(\"empty_synth_test\");\n\tgoto free;\n}\n\nstatic struct synth_field_desc create_synth_test_fields[] = {\n\t{ .type = \"pid_t\",\t\t.name = \"next_pid_field\" },\n\t{ .type = \"char[16]\",\t\t.name = \"next_comm_field\" },\n\t{ .type = \"u64\",\t\t.name = \"ts_ns\" },\n\t{ .type = \"char[]\",\t\t.name = \"dynstring_field_1\" },\n\t{ .type = \"u64\",\t\t.name = \"ts_ms\" },\n\t{ .type = \"unsigned int\",\t.name = \"cpu\" },\n\t{ .type = \"char[64]\",\t\t.name = \"my_string_field\" },\n\t{ .type = \"char[]\",\t\t.name = \"dynstring_field_2\" },\n\t{ .type = \"int\",\t\t.name = \"my_int_field\" },\n};\n\n \nstatic int __init test_create_synth_event(void)\n{\n\tu64 vals[9];\n\tint ret;\n\n\t \n\tret = synth_event_create(\"create_synth_test\",\n\t\t\t\t create_synth_test_fields,\n\t\t\t\t ARRAY_SIZE(create_synth_test_fields),\n\t\t\t\t THIS_MODULE);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tcreate_synth_test = trace_get_event_file(NULL, \"synthetic\",\n\t\t\t\t\t\t \"create_synth_test\");\n\tif (IS_ERR(create_synth_test)) {\n\t\tret = PTR_ERR(create_synth_test);\n\t\tgoto delete;\n\t}\n\n\t \n\tret = trace_array_set_clr_event(create_synth_test->tr,\n\t\t\t\t\t\"synthetic\", \"create_synth_test\", true);\n\tif (ret) {\n\t\ttrace_put_event_file(create_synth_test);\n\t\tgoto delete;\n\t}\n\n\t \n\n\tvals[0] = 777;\t\t\t \n\tvals[1] = (u64)(long)\"tiddlywinks\";\t \n\tvals[2] = 1000000;\t\t \n\tvals[3] = (u64)(long)\"xrayspecs\";\t \n\tvals[4] = 1000;\t\t\t \n\tvals[5] = raw_smp_processor_id();  \n\tvals[6] = (u64)(long)\"thneed\";\t \n\tvals[7] = (u64)(long)\"kerplunk\";\t \n\tvals[8] = 398;\t\t\t \n\n\t \n\tret = synth_event_trace_array(create_synth_test, vals, ARRAY_SIZE(vals));\n out:\n\treturn ret;\n delete:\n\t \n\tsynth_event_delete(\"create_synth_test\");\n\n\tgoto out;\n}\n\n \nstatic int __init test_add_next_synth_val(void)\n{\n\tstruct synth_event_trace_state trace_state;\n\tint ret;\n\n\t \n\tret = synth_event_trace_start(gen_synth_test, &trace_state);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\n\t \n\tret = synth_event_add_next_val(777, &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = synth_event_add_next_val((u64)(long)\"slinky\", &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = synth_event_add_next_val(1000000, &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = synth_event_add_next_val(1000, &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = synth_event_add_next_val(raw_smp_processor_id(), &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = synth_event_add_next_val((u64)(long)\"thneed_2.01\", &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\t \n\tret = synth_event_add_next_val(395, &trace_state);\n out:\n\t \n\tret = synth_event_trace_end(&trace_state);\n\n\treturn ret;\n}\n\n \nstatic int __init test_add_synth_val(void)\n{\n\tstruct synth_event_trace_state trace_state;\n\tint ret;\n\n\t \n\tret = synth_event_trace_start(gen_synth_test, &trace_state);\n\tif (ret)\n\t\treturn ret;\n\n\t \n\n\tret = synth_event_add_val(\"ts_ns\", 1000000, &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\tret = synth_event_add_val(\"ts_ms\", 1000, &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\tret = synth_event_add_val(\"cpu\", raw_smp_processor_id(), &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\tret = synth_event_add_val(\"next_pid_field\", 777, &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\tret = synth_event_add_val(\"next_comm_field\", (u64)(long)\"silly putty\",\n\t\t\t\t  &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\tret = synth_event_add_val(\"my_string_field\", (u64)(long)\"thneed_9\",\n\t\t\t\t  &trace_state);\n\tif (ret)\n\t\tgoto out;\n\n\tret = synth_event_add_val(\"my_int_field\", 3999, &trace_state);\n out:\n\t \n\tret = synth_event_trace_end(&trace_state);\n\n\treturn ret;\n}\n\n \nstatic int __init test_trace_synth_event(void)\n{\n\tint ret;\n\n\t \n\tret = synth_event_trace(create_synth_test, 9,\t \n\t\t\t\t(u64)444,\t\t \n\t\t\t\t(u64)(long)\"clackers\",\t \n\t\t\t\t(u64)1000000,\t\t \n\t\t\t\t(u64)(long)\"viewmaster\", \n\t\t\t\t(u64)1000,\t\t \n\t\t\t\t(u64)raw_smp_processor_id(),  \n\t\t\t\t(u64)(long)\"Thneed\",\t \n\t\t\t\t(u64)(long)\"yoyos\",\t \n\t\t\t\t(u64)999);\t\t \n\treturn ret;\n}\n\nstatic int __init synth_event_gen_test_init(void)\n{\n\tint ret;\n\n\tret = test_gen_synth_cmd();\n\tif (ret)\n\t\treturn ret;\n\n\tret = test_empty_synth_event();\n\tif (ret) {\n\t\tWARN_ON(trace_array_set_clr_event(gen_synth_test->tr,\n\t\t\t\t\t\t  \"synthetic\",\n\t\t\t\t\t\t  \"gen_synth_test\", false));\n\t\ttrace_put_event_file(gen_synth_test);\n\t\tWARN_ON(synth_event_delete(\"gen_synth_test\"));\n\t\tgoto out;\n\t}\n\n\tret = test_create_synth_event();\n\tif (ret) {\n\t\tWARN_ON(trace_array_set_clr_event(gen_synth_test->tr,\n\t\t\t\t\t\t  \"synthetic\",\n\t\t\t\t\t\t  \"gen_synth_test\", false));\n\t\ttrace_put_event_file(gen_synth_test);\n\t\tWARN_ON(synth_event_delete(\"gen_synth_test\"));\n\n\t\tWARN_ON(trace_array_set_clr_event(empty_synth_test->tr,\n\t\t\t\t\t\t  \"synthetic\",\n\t\t\t\t\t\t  \"empty_synth_test\", false));\n\t\ttrace_put_event_file(empty_synth_test);\n\t\tWARN_ON(synth_event_delete(\"empty_synth_test\"));\n\t\tgoto out;\n\t}\n\n\tret = test_add_next_synth_val();\n\tWARN_ON(ret);\n\n\tret = test_add_synth_val();\n\tWARN_ON(ret);\n\n\tret = test_trace_synth_event();\n\tWARN_ON(ret);\n\n\t \n\ttrace_array_set_clr_event(gen_synth_test->tr,\n\t\t\t\t  \"synthetic\",\n\t\t\t\t  \"gen_synth_test\", false);\n\ttrace_array_set_clr_event(empty_synth_test->tr,\n\t\t\t\t  \"synthetic\",\n\t\t\t\t  \"empty_synth_test\", false);\n\ttrace_array_set_clr_event(create_synth_test->tr,\n\t\t\t\t  \"synthetic\",\n\t\t\t\t  \"create_synth_test\", false);\n out:\n\treturn ret;\n}\n\nstatic void __exit synth_event_gen_test_exit(void)\n{\n\t \n\tWARN_ON(trace_array_set_clr_event(gen_synth_test->tr,\n\t\t\t\t\t  \"synthetic\",\n\t\t\t\t\t  \"gen_synth_test\", false));\n\n\t \n\ttrace_put_event_file(gen_synth_test);\n\n\t \n\tWARN_ON(synth_event_delete(\"gen_synth_test\"));\n\n\t \n\tWARN_ON(trace_array_set_clr_event(empty_synth_test->tr,\n\t\t\t\t\t  \"synthetic\",\n\t\t\t\t\t  \"empty_synth_test\", false));\n\n\t \n\ttrace_put_event_file(empty_synth_test);\n\n\t \n\tWARN_ON(synth_event_delete(\"empty_synth_test\"));\n\n\t \n\tWARN_ON(trace_array_set_clr_event(create_synth_test->tr,\n\t\t\t\t\t  \"synthetic\",\n\t\t\t\t\t  \"create_synth_test\", false));\n\n\t \n\ttrace_put_event_file(create_synth_test);\n\n\t \n\tWARN_ON(synth_event_delete(\"create_synth_test\"));\n}\n\nmodule_init(synth_event_gen_test_init)\nmodule_exit(synth_event_gen_test_exit)\n\nMODULE_AUTHOR(\"Tom Zanussi\");\nMODULE_DESCRIPTION(\"synthetic event generation test\");\nMODULE_LICENSE(\"GPL v2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}