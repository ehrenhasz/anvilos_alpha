{
  "module_name": "headers_check.pl",
  "hash_id": "55b9cb93792749519228e1e466bc1ac3413f4b8da763a5b5db7751260c675606",
  "original_prompt": "Ingested from linux-6.6.14/usr/include/headers_check.pl",
  "human_readable_source": "#!/usr/bin/env perl\n# SPDX-License-Identifier: GPL-2.0\n#\n# headers_check.pl execute a number of trivial consistency checks\n#\n# Usage: headers_check.pl dir arch [files...]\n# dir:   dir to look for included files\n# arch:  architecture\n# files: list of files to check\n#\n# The script reads the supplied files line by line and:\n#\n# 1) for each include statement it checks if the\n#    included file actually exists.\n#    Only include files located in asm* and linux* are checked.\n#    The rest are assumed to be system include files.\n#\n# 2) It is checked that prototypes does not use \"extern\"\n#\n# 3) Check for leaked CONFIG_ symbols\n\nuse warnings;\nuse strict;\nuse File::Basename;\n\nmy ($dir, $arch, @files) = @ARGV;\n\nmy $ret = 0;\nmy $line;\nmy $lineno = 0;\nmy $filename;\n\nforeach my $file (@files) {\n\t$filename = $file;\n\n\topen(my $fh, '<', $filename)\n\t\tor die \"$filename: $!\\n\";\n\t$lineno = 0;\n\twhile ($line = <$fh>) {\n\t\t$lineno++;\n\t\t&check_include();\n\t\t&check_asm_types();\n\t\t&check_sizetypes();\n\t\t&check_declarations();\n\t\t# Dropped for now. Too much noise &check_config();\n\t}\n\tclose $fh;\n}\nexit $ret;\n\nsub check_include\n{\n\tif ($line =~ m/^\\s*#\\s*include\\s+<((asm|linux).*)>/) {\n\t\tmy $inc = $1;\n\t\tmy $found;\n\t\t$found = stat($dir . \"/\" . $inc);\n\t\tif (!$found) {\n\t\t\t$inc =~ s#asm/#asm-$arch/#;\n\t\t\t$found = stat($dir . \"/\" . $inc);\n\t\t}\n\t\tif (!$found) {\n\t\t\tprintf STDERR \"$filename:$lineno: included file '$inc' is not exported\\n\";\n\t\t\t$ret = 1;\n\t\t}\n\t}\n}\n\nsub check_declarations\n{\n\t# soundcard.h is what it is\n\tif ($line =~ m/^void seqbuf_dump\\(void\\);/) {\n\t\treturn;\n\t}\n\t# drm headers are being C++ friendly\n\tif ($line =~ m/^extern \"C\"/) {\n\t\treturn;\n\t}\n\tif ($line =~ m/^(\\s*extern|unsigned|char|short|int|long|void)\\b/) {\n\t\tprintf STDERR \"$filename:$lineno: \" .\n\t\t\t      \"userspace cannot reference function or \" .\n\t\t\t      \"variable defined in the kernel\\n\";\n\t}\n}\n\nsub check_config\n{\n\tif ($line =~ m/[^a-zA-Z0-9_]+CONFIG_([a-zA-Z0-9_]+)[^a-zA-Z0-9_]/) {\n\t\tprintf STDERR \"$filename:$lineno: leaks CONFIG_$1 to userspace where it is not valid\\n\";\n\t}\n}\n\nmy $linux_asm_types;\nsub check_asm_types\n{\n\tif ($filename =~ /types.h|int-l64.h|int-ll64.h/o) {\n\t\treturn;\n\t}\n\tif ($lineno == 1) {\n\t\t$linux_asm_types = 0;\n\t} elsif ($linux_asm_types >= 1) {\n\t\treturn;\n\t}\n\tif ($line =~ m/^\\s*#\\s*include\\s+<asm\\/types.h>/) {\n\t\t$linux_asm_types = 1;\n\t\tprintf STDERR \"$filename:$lineno: \" .\n\t\t\"include of <linux/types.h> is preferred over <asm/types.h>\\n\"\n\t\t# Warn until headers are all fixed\n\t\t#$ret = 1;\n\t}\n}\n\nmy $linux_types;\nmy %import_stack = ();\nsub check_include_typesh\n{\n\tmy $path = $_[0];\n\tmy $import_path;\n\n\tmy $fh;\n\tmy @file_paths = ($path, $dir . \"/\" .  $path, dirname($filename) . \"/\" . $path);\n\tfor my $possible ( @file_paths ) {\n\t    if (not $import_stack{$possible} and open($fh, '<', $possible)) {\n\t\t$import_path = $possible;\n\t\t$import_stack{$import_path} = 1;\n\t\tlast;\n\t    }\n\t}\n\tif (eof $fh) {\n\t    return;\n\t}\n\n\tmy $line;\n\twhile ($line = <$fh>) {\n\t\tif ($line =~ m/^\\s*#\\s*include\\s+<linux\\/types.h>/) {\n\t\t\t$linux_types = 1;\n\t\t\tlast;\n\t\t}\n\t\tif (my $included = ($line =~ /^\\s*#\\s*include\\s+[<\"](\\S+)[>\"]/)[0]) {\n\t\t\tcheck_include_typesh($included);\n\t\t}\n\t}\n\tclose $fh;\n\tdelete $import_stack{$import_path};\n}\n\nsub check_sizetypes\n{\n\tif ($filename =~ /types.h|int-l64.h|int-ll64.h/o) {\n\t\treturn;\n\t}\n\tif ($lineno == 1) {\n\t\t$linux_types = 0;\n\t} elsif ($linux_types >= 1) {\n\t\treturn;\n\t}\n\tif ($line =~ m/^\\s*#\\s*include\\s+<linux\\/types.h>/) {\n\t\t$linux_types = 1;\n\t\treturn;\n\t}\n\tif (my $included = ($line =~ /^\\s*#\\s*include\\s+[<\"](\\S+)[>\"]/)[0]) {\n\t\tcheck_include_typesh($included);\n\t}\n\tif ($line =~ m/__[us](8|16|32|64)\\b/) {\n\t\tprintf STDERR \"$filename:$lineno: \" .\n\t\t              \"found __[us]{8,16,32,64} type \" .\n\t\t              \"without #include <linux/types.h>\\n\";\n\t\t$linux_types = 2;\n\t\t# Warn until headers are all fixed\n\t\t#$ret = 1;\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}