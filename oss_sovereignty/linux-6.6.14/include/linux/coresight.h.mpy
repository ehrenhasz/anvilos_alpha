{
  "module_name": "coresight.h",
  "hash_id": "bb2d4b3ea3eac8d35b5b87195495530d2da51ac3038213167e8461150488fb1a",
  "original_prompt": "Ingested from linux-6.6.14/include/linux/coresight.h",
  "human_readable_source": " \n \n\n#ifndef _LINUX_CORESIGHT_H\n#define _LINUX_CORESIGHT_H\n\n#include <linux/amba/bus.h>\n#include <linux/clk.h>\n#include <linux/device.h>\n#include <linux/io.h>\n#include <linux/perf_event.h>\n#include <linux/sched.h>\n\n \n#define CORESIGHT_PERIPHIDR4\t0xfd0\n#define CORESIGHT_PERIPHIDR5\t0xfd4\n#define CORESIGHT_PERIPHIDR6\t0xfd8\n#define CORESIGHT_PERIPHIDR7\t0xfdC\n#define CORESIGHT_PERIPHIDR0\t0xfe0\n#define CORESIGHT_PERIPHIDR1\t0xfe4\n#define CORESIGHT_PERIPHIDR2\t0xfe8\n#define CORESIGHT_PERIPHIDR3\t0xfeC\n \n#define CORESIGHT_COMPIDR0\t0xff0\n#define CORESIGHT_COMPIDR1\t0xff4\n#define CORESIGHT_COMPIDR2\t0xff8\n#define CORESIGHT_COMPIDR3\t0xffC\n\n#define ETM_ARCH_V3_3\t\t0x23\n#define ETM_ARCH_V3_5\t\t0x25\n#define PFT_ARCH_V1_0\t\t0x30\n#define PFT_ARCH_V1_1\t\t0x31\n\n#define CORESIGHT_UNLOCK\t0xc5acce55\n\nextern struct bus_type coresight_bustype;\n\nenum coresight_dev_type {\n\tCORESIGHT_DEV_TYPE_SINK,\n\tCORESIGHT_DEV_TYPE_LINK,\n\tCORESIGHT_DEV_TYPE_LINKSINK,\n\tCORESIGHT_DEV_TYPE_SOURCE,\n\tCORESIGHT_DEV_TYPE_HELPER,\n\tCORESIGHT_DEV_TYPE_MAX\n};\n\nenum coresight_dev_subtype_sink {\n\tCORESIGHT_DEV_SUBTYPE_SINK_DUMMY,\n\tCORESIGHT_DEV_SUBTYPE_SINK_PORT,\n\tCORESIGHT_DEV_SUBTYPE_SINK_BUFFER,\n\tCORESIGHT_DEV_SUBTYPE_SINK_SYSMEM,\n\tCORESIGHT_DEV_SUBTYPE_SINK_PERCPU_SYSMEM,\n};\n\nenum coresight_dev_subtype_link {\n\tCORESIGHT_DEV_SUBTYPE_LINK_MERG,\n\tCORESIGHT_DEV_SUBTYPE_LINK_SPLIT,\n\tCORESIGHT_DEV_SUBTYPE_LINK_FIFO,\n};\n\nenum coresight_dev_subtype_source {\n\tCORESIGHT_DEV_SUBTYPE_SOURCE_PROC,\n\tCORESIGHT_DEV_SUBTYPE_SOURCE_BUS,\n\tCORESIGHT_DEV_SUBTYPE_SOURCE_SOFTWARE,\n\tCORESIGHT_DEV_SUBTYPE_SOURCE_OTHERS,\n};\n\nenum coresight_dev_subtype_helper {\n\tCORESIGHT_DEV_SUBTYPE_HELPER_CATU,\n\tCORESIGHT_DEV_SUBTYPE_HELPER_ECT_CTI\n};\n\n \nunion coresight_dev_subtype {\n\t \n\tstruct {\n\t\tenum coresight_dev_subtype_sink sink_subtype;\n\t\tenum coresight_dev_subtype_link link_subtype;\n\t};\n\tenum coresight_dev_subtype_source source_subtype;\n\tenum coresight_dev_subtype_helper helper_subtype;\n};\n\n \nstruct coresight_platform_data {\n\tint nr_inconns;\n\tint nr_outconns;\n\tstruct coresight_connection **out_conns;\n\tstruct coresight_connection **in_conns;\n};\n\n \nstruct csdev_access {\n\tbool io_mem;\n\tunion {\n\t\tvoid __iomem *base;\n\t\tstruct {\n\t\t\tu64 (*read)(u32 offset, bool relaxed, bool _64bit);\n\t\t\tvoid (*write)(u64 val, u32 offset, bool relaxed,\n\t\t\t\t      bool _64bit);\n\t\t};\n\t};\n};\n\n#define CSDEV_ACCESS_IOMEM(_addr)\t\t\\\n\t((struct csdev_access)\t{\t\t\\\n\t\t.io_mem\t\t= true,\t\t\\\n\t\t.base\t\t= (_addr),\t\\\n\t})\n\n \nstruct coresight_desc {\n\tenum coresight_dev_type type;\n\tunion coresight_dev_subtype subtype;\n\tconst struct coresight_ops *ops;\n\tstruct coresight_platform_data *pdata;\n\tstruct device *dev;\n\tconst struct attribute_group **groups;\n\tconst char *name;\n\tstruct csdev_access access;\n};\n\n \nstruct coresight_connection {\n\tint src_port;\n\tint dest_port;\n\tstruct fwnode_handle *dest_fwnode;\n\tstruct coresight_device *dest_dev;\n\tstruct coresight_sysfs_link *link;\n\tstruct coresight_device *src_dev;\n\tatomic_t src_refcnt;\n\tatomic_t dest_refcnt;\n};\n\n \nstruct coresight_sysfs_link {\n\tstruct coresight_device *orig;\n\tconst char *orig_name;\n\tstruct coresight_device *target;\n\tconst char *target_name;\n};\n\n \nstruct coresight_device {\n\tstruct coresight_platform_data *pdata;\n\tenum coresight_dev_type type;\n\tunion coresight_dev_subtype subtype;\n\tconst struct coresight_ops *ops;\n\tstruct csdev_access access;\n\tstruct device dev;\n\tatomic_t refcnt;\n\tbool orphan;\n\tbool enable;\t \n\t \n\tbool activated;\t \n\tstruct dev_ext_attribute *ea;\n\tstruct coresight_device *def_sink;\n\t \n\tint nr_links;\n\tbool has_conns_grp;\n\t \n\tstruct list_head feature_csdev_list;\n\tstruct list_head config_csdev_list;\n\tspinlock_t cscfg_csdev_lock;\n\tvoid *active_cscfg_ctxt;\n};\n\n \nstruct coresight_dev_list {\n\tint\t\t\tnr_idx;\n\tconst char\t\t*pfx;\n\tstruct fwnode_handle\t**fwnode_list;\n};\n\n#define DEFINE_CORESIGHT_DEVLIST(var, dev_pfx)\t\t\t\t\\\nstatic struct coresight_dev_list (var) = {\t\t\t\t\\\n\t\t\t\t\t\t.pfx = dev_pfx,\t\t\\\n\t\t\t\t\t\t.nr_idx = 0,\t\t\\\n\t\t\t\t\t\t.fwnode_list = NULL,\t\\\n}\n\n#define to_coresight_device(d) container_of(d, struct coresight_device, dev)\n\nenum cs_mode {\n\tCS_MODE_DISABLED,\n\tCS_MODE_SYSFS,\n\tCS_MODE_PERF,\n};\n\n#define source_ops(csdev)\tcsdev->ops->source_ops\n#define sink_ops(csdev)\t\tcsdev->ops->sink_ops\n#define link_ops(csdev)\t\tcsdev->ops->link_ops\n#define helper_ops(csdev)\tcsdev->ops->helper_ops\n#define ect_ops(csdev)\t\tcsdev->ops->ect_ops\n\n \nstruct coresight_ops_sink {\n\tint (*enable)(struct coresight_device *csdev, enum cs_mode mode,\n\t\t      void *data);\n\tint (*disable)(struct coresight_device *csdev);\n\tvoid *(*alloc_buffer)(struct coresight_device *csdev,\n\t\t\t      struct perf_event *event, void **pages,\n\t\t\t      int nr_pages, bool overwrite);\n\tvoid (*free_buffer)(void *config);\n\tunsigned long (*update_buffer)(struct coresight_device *csdev,\n\t\t\t      struct perf_output_handle *handle,\n\t\t\t      void *sink_config);\n};\n\n \nstruct coresight_ops_link {\n\tint (*enable)(struct coresight_device *csdev,\n\t\t      struct coresight_connection *in,\n\t\t      struct coresight_connection *out);\n\tvoid (*disable)(struct coresight_device *csdev,\n\t\t\tstruct coresight_connection *in,\n\t\t\tstruct coresight_connection *out);\n};\n\n \nstruct coresight_ops_source {\n\tint (*cpu_id)(struct coresight_device *csdev);\n\tint (*enable)(struct coresight_device *csdev, struct perf_event *event,\n\t\t      enum cs_mode mode);\n\tvoid (*disable)(struct coresight_device *csdev,\n\t\t\tstruct perf_event *event);\n};\n\n \nstruct coresight_ops_helper {\n\tint (*enable)(struct coresight_device *csdev, enum cs_mode mode,\n\t\t      void *data);\n\tint (*disable)(struct coresight_device *csdev, void *data);\n};\n\nstruct coresight_ops {\n\tconst struct coresight_ops_sink *sink_ops;\n\tconst struct coresight_ops_link *link_ops;\n\tconst struct coresight_ops_source *source_ops;\n\tconst struct coresight_ops_helper *helper_ops;\n};\n\n#if IS_ENABLED(CONFIG_CORESIGHT)\n\nstatic inline u32 csdev_access_relaxed_read32(struct csdev_access *csa,\n\t\t\t\t\t      u32 offset)\n{\n\tif (likely(csa->io_mem))\n\t\treturn readl_relaxed(csa->base + offset);\n\n\treturn csa->read(offset, true, false);\n}\n\n#define CORESIGHT_CIDRn(i)\t(0xFF0 + ((i) * 4))\n\nstatic inline u32 coresight_get_cid(void __iomem *base)\n{\n\tu32 i, cid = 0;\n\n\tfor (i = 0; i < 4; i++)\n\t\tcid |= readl(base + CORESIGHT_CIDRn(i)) << (i * 8);\n\n\treturn cid;\n}\n\nstatic inline bool is_coresight_device(void __iomem *base)\n{\n\tu32 cid = coresight_get_cid(base);\n\n\treturn cid == CORESIGHT_CID;\n}\n\n \nstatic inline struct clk *coresight_get_enable_apb_pclk(struct device *dev)\n{\n\tstruct clk *pclk;\n\tint ret;\n\n\tpclk = clk_get(dev, \"apb_pclk\");\n\tif (IS_ERR(pclk))\n\t\treturn NULL;\n\n\tret = clk_prepare_enable(pclk);\n\tif (ret) {\n\t\tclk_put(pclk);\n\t\treturn ERR_PTR(ret);\n\t}\n\treturn pclk;\n}\n\n#define CORESIGHT_PIDRn(i)\t(0xFE0 + ((i) * 4))\n\nstatic inline u32 coresight_get_pid(struct csdev_access *csa)\n{\n\tu32 i, pid = 0;\n\n\tfor (i = 0; i < 4; i++)\n\t\tpid |= csdev_access_relaxed_read32(csa, CORESIGHT_PIDRn(i)) << (i * 8);\n\n\treturn pid;\n}\n\nstatic inline u64 csdev_access_relaxed_read_pair(struct csdev_access *csa,\n\t\t\t\t\t\t u32 lo_offset, u32 hi_offset)\n{\n\tif (likely(csa->io_mem)) {\n\t\treturn readl_relaxed(csa->base + lo_offset) |\n\t\t\t((u64)readl_relaxed(csa->base + hi_offset) << 32);\n\t}\n\n\treturn csa->read(lo_offset, true, false) | (csa->read(hi_offset, true, false) << 32);\n}\n\nstatic inline void csdev_access_relaxed_write_pair(struct csdev_access *csa, u64 val,\n\t\t\t\t\t\t   u32 lo_offset, u32 hi_offset)\n{\n\tif (likely(csa->io_mem)) {\n\t\twritel_relaxed((u32)val, csa->base + lo_offset);\n\t\twritel_relaxed((u32)(val >> 32), csa->base + hi_offset);\n\t} else {\n\t\tcsa->write((u32)val, lo_offset, true, false);\n\t\tcsa->write((u32)(val >> 32), hi_offset, true, false);\n\t}\n}\n\nstatic inline u32 csdev_access_read32(struct csdev_access *csa, u32 offset)\n{\n\tif (likely(csa->io_mem))\n\t\treturn readl(csa->base + offset);\n\n\treturn csa->read(offset, false, false);\n}\n\nstatic inline void csdev_access_relaxed_write32(struct csdev_access *csa,\n\t\t\t\t\t\tu32 val, u32 offset)\n{\n\tif (likely(csa->io_mem))\n\t\twritel_relaxed(val, csa->base + offset);\n\telse\n\t\tcsa->write(val, offset, true, false);\n}\n\nstatic inline void csdev_access_write32(struct csdev_access *csa, u32 val, u32 offset)\n{\n\tif (likely(csa->io_mem))\n\t\twritel(val, csa->base + offset);\n\telse\n\t\tcsa->write(val, offset, false, false);\n}\n\n#ifdef CONFIG_64BIT\n\nstatic inline u64 csdev_access_relaxed_read64(struct csdev_access *csa,\n\t\t\t\t\t      u32 offset)\n{\n\tif (likely(csa->io_mem))\n\t\treturn readq_relaxed(csa->base + offset);\n\n\treturn csa->read(offset, true, true);\n}\n\nstatic inline u64 csdev_access_read64(struct csdev_access *csa, u32 offset)\n{\n\tif (likely(csa->io_mem))\n\t\treturn readq(csa->base + offset);\n\n\treturn csa->read(offset, false, true);\n}\n\nstatic inline void csdev_access_relaxed_write64(struct csdev_access *csa,\n\t\t\t\t\t\tu64 val, u32 offset)\n{\n\tif (likely(csa->io_mem))\n\t\twriteq_relaxed(val, csa->base + offset);\n\telse\n\t\tcsa->write(val, offset, true, true);\n}\n\nstatic inline void csdev_access_write64(struct csdev_access *csa, u64 val, u32 offset)\n{\n\tif (likely(csa->io_mem))\n\t\twriteq(val, csa->base + offset);\n\telse\n\t\tcsa->write(val, offset, false, true);\n}\n\n#else\t \n\nstatic inline u64 csdev_access_relaxed_read64(struct csdev_access *csa,\n\t\t\t\t\t      u32 offset)\n{\n\tWARN_ON(1);\n\treturn 0;\n}\n\nstatic inline u64 csdev_access_read64(struct csdev_access *csa, u32 offset)\n{\n\tWARN_ON(1);\n\treturn 0;\n}\n\nstatic inline void csdev_access_relaxed_write64(struct csdev_access *csa,\n\t\t\t\t\t\tu64 val, u32 offset)\n{\n\tWARN_ON(1);\n}\n\nstatic inline void csdev_access_write64(struct csdev_access *csa, u64 val, u32 offset)\n{\n\tWARN_ON(1);\n}\n#endif\t \n\nstatic inline bool coresight_is_percpu_source(struct coresight_device *csdev)\n{\n\treturn csdev && (csdev->type == CORESIGHT_DEV_TYPE_SOURCE) &&\n\t       (csdev->subtype.source_subtype == CORESIGHT_DEV_SUBTYPE_SOURCE_PROC);\n}\n\nstatic inline bool coresight_is_percpu_sink(struct coresight_device *csdev)\n{\n\treturn csdev && (csdev->type == CORESIGHT_DEV_TYPE_SINK) &&\n\t       (csdev->subtype.sink_subtype == CORESIGHT_DEV_SUBTYPE_SINK_PERCPU_SYSMEM);\n}\n\nextern struct coresight_device *\ncoresight_register(struct coresight_desc *desc);\nextern void coresight_unregister(struct coresight_device *csdev);\nextern int coresight_enable(struct coresight_device *csdev);\nextern void coresight_disable(struct coresight_device *csdev);\nextern int coresight_timeout(struct csdev_access *csa, u32 offset,\n\t\t\t     int position, int value);\n\nextern int coresight_claim_device(struct coresight_device *csdev);\nextern int coresight_claim_device_unlocked(struct coresight_device *csdev);\n\nextern void coresight_disclaim_device(struct coresight_device *csdev);\nextern void coresight_disclaim_device_unlocked(struct coresight_device *csdev);\nextern char *coresight_alloc_device_name(struct coresight_dev_list *devs,\n\t\t\t\t\t struct device *dev);\n\nextern bool coresight_loses_context_with_cpu(struct device *dev);\n\nu32 coresight_relaxed_read32(struct coresight_device *csdev, u32 offset);\nu32 coresight_read32(struct coresight_device *csdev, u32 offset);\nvoid coresight_write32(struct coresight_device *csdev, u32 val, u32 offset);\nvoid coresight_relaxed_write32(struct coresight_device *csdev,\n\t\t\t       u32 val, u32 offset);\nu64 coresight_relaxed_read64(struct coresight_device *csdev, u32 offset);\nu64 coresight_read64(struct coresight_device *csdev, u32 offset);\nvoid coresight_relaxed_write64(struct coresight_device *csdev,\n\t\t\t       u64 val, u32 offset);\nvoid coresight_write64(struct coresight_device *csdev, u64 val, u32 offset);\n\n#else\nstatic inline struct coresight_device *\ncoresight_register(struct coresight_desc *desc) { return NULL; }\nstatic inline void coresight_unregister(struct coresight_device *csdev) {}\nstatic inline int\ncoresight_enable(struct coresight_device *csdev) { return -ENOSYS; }\nstatic inline void coresight_disable(struct coresight_device *csdev) {}\n\nstatic inline int coresight_timeout(struct csdev_access *csa, u32 offset,\n\t\t\t\t    int position, int value)\n{\n\treturn 1;\n}\n\nstatic inline int coresight_claim_device_unlocked(struct coresight_device *csdev)\n{\n\treturn -EINVAL;\n}\n\nstatic inline int coresight_claim_device(struct coresight_device *csdev)\n{\n\treturn -EINVAL;\n}\n\nstatic inline void coresight_disclaim_device(struct coresight_device *csdev) {}\nstatic inline void coresight_disclaim_device_unlocked(struct coresight_device *csdev) {}\n\nstatic inline bool coresight_loses_context_with_cpu(struct device *dev)\n{\n\treturn false;\n}\n\nstatic inline u32 coresight_relaxed_read32(struct coresight_device *csdev, u32 offset)\n{\n\tWARN_ON_ONCE(1);\n\treturn 0;\n}\n\nstatic inline u32 coresight_read32(struct coresight_device *csdev, u32 offset)\n{\n\tWARN_ON_ONCE(1);\n\treturn 0;\n}\n\nstatic inline void coresight_write32(struct coresight_device *csdev, u32 val, u32 offset)\n{\n}\n\nstatic inline void coresight_relaxed_write32(struct coresight_device *csdev,\n\t\t\t\t\t     u32 val, u32 offset)\n{\n}\n\nstatic inline u64 coresight_relaxed_read64(struct coresight_device *csdev,\n\t\t\t\t\t   u32 offset)\n{\n\tWARN_ON_ONCE(1);\n\treturn 0;\n}\n\nstatic inline u64 coresight_read64(struct coresight_device *csdev, u32 offset)\n{\n\tWARN_ON_ONCE(1);\n\treturn 0;\n}\n\nstatic inline void coresight_relaxed_write64(struct coresight_device *csdev,\n\t\t\t\t\t     u64 val, u32 offset)\n{\n}\n\nstatic inline void coresight_write64(struct coresight_device *csdev, u64 val, u32 offset)\n{\n}\n\n#endif\t\t \n\nextern int coresight_get_cpu(struct device *dev);\n\nstruct coresight_platform_data *coresight_get_platform_data(struct device *dev);\nstruct coresight_connection *\ncoresight_add_out_conn(struct device *dev,\n\t\t       struct coresight_platform_data *pdata,\n\t\t       const struct coresight_connection *new_conn);\nint coresight_add_in_conn(struct coresight_connection *conn);\nstruct coresight_device *\ncoresight_find_input_type(struct coresight_platform_data *pdata,\n\t\t\t  enum coresight_dev_type type,\n\t\t\t  union coresight_dev_subtype subtype);\nstruct coresight_device *\ncoresight_find_output_type(struct coresight_platform_data *pdata,\n\t\t\t   enum coresight_dev_type type,\n\t\t\t   union coresight_dev_subtype subtype);\n\n#endif\t\t \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}