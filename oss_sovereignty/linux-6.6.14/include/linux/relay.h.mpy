{
  "module_name": "relay.h",
  "hash_id": "9c869133cd41505e849d86aeb8003b628e869e7a5a0d6b42e8a137717af4dc46",
  "original_prompt": "Ingested from linux-6.6.14/include/linux/relay.h",
  "human_readable_source": " \n \n\n#ifndef _LINUX_RELAY_H\n#define _LINUX_RELAY_H\n\n#include <linux/types.h>\n#include <linux/sched.h>\n#include <linux/timer.h>\n#include <linux/wait.h>\n#include <linux/list.h>\n#include <linux/irq_work.h>\n#include <linux/bug.h>\n#include <linux/fs.h>\n#include <linux/poll.h>\n#include <linux/kref.h>\n#include <linux/percpu.h>\n\n \n#define RELAYFS_CHANNEL_VERSION\t\t7\n\n \nstruct rchan_buf\n{\n\tvoid *start;\t\t\t \n\tvoid *data;\t\t\t \n\tsize_t offset;\t\t\t \n\tsize_t subbufs_produced;\t \n\tsize_t subbufs_consumed;\t \n\tstruct rchan *chan;\t\t \n\twait_queue_head_t read_wait;\t \n\tstruct irq_work wakeup_work;\t \n\tstruct dentry *dentry;\t\t \n\tstruct kref kref;\t\t \n\tstruct page **page_array;\t \n\tunsigned int page_count;\t \n\tunsigned int finalized;\t\t \n\tsize_t *padding;\t\t \n\tsize_t prev_padding;\t\t \n\tsize_t bytes_consumed;\t\t \n\tsize_t early_bytes;\t\t \n\tunsigned int cpu;\t\t \n} ____cacheline_aligned;\n\n \nstruct rchan\n{\n\tu32 version;\t\t\t \n\tsize_t subbuf_size;\t\t \n\tsize_t n_subbufs;\t\t \n\tsize_t alloc_size;\t\t \n\tconst struct rchan_callbacks *cb;  \n\tstruct kref kref;\t\t \n\tvoid *private_data;\t\t \n\tsize_t last_toobig;\t\t \n\tstruct rchan_buf * __percpu *buf;  \n\tint is_global;\t\t\t \n\tstruct list_head list;\t\t \n\tstruct dentry *parent;\t\t \n\tint has_base_filename;\t\t \n\tchar base_filename[NAME_MAX];\t \n};\n\n \nstruct rchan_callbacks\n{\n\t \n\tint (*subbuf_start) (struct rchan_buf *buf,\n\t\t\t     void *subbuf,\n\t\t\t     void *prev_subbuf,\n\t\t\t     size_t prev_padding);\n\n\t \n\tstruct dentry *(*create_buf_file)(const char *filename,\n\t\t\t\t\t  struct dentry *parent,\n\t\t\t\t\t  umode_t mode,\n\t\t\t\t\t  struct rchan_buf *buf,\n\t\t\t\t\t  int *is_global);\n\n\t \n\tint (*remove_buf_file)(struct dentry *dentry);\n};\n\n \n\nstruct rchan *relay_open(const char *base_filename,\n\t\t\t struct dentry *parent,\n\t\t\t size_t subbuf_size,\n\t\t\t size_t n_subbufs,\n\t\t\t const struct rchan_callbacks *cb,\n\t\t\t void *private_data);\nextern int relay_late_setup_files(struct rchan *chan,\n\t\t\t\t  const char *base_filename,\n\t\t\t\t  struct dentry *parent);\nextern void relay_close(struct rchan *chan);\nextern void relay_flush(struct rchan *chan);\nextern void relay_subbufs_consumed(struct rchan *chan,\n\t\t\t\t   unsigned int cpu,\n\t\t\t\t   size_t consumed);\nextern void relay_reset(struct rchan *chan);\nextern int relay_buf_full(struct rchan_buf *buf);\n\nextern size_t relay_switch_subbuf(struct rchan_buf *buf,\n\t\t\t\t  size_t length);\n\n \nstatic inline void relay_write(struct rchan *chan,\n\t\t\t       const void *data,\n\t\t\t       size_t length)\n{\n\tunsigned long flags;\n\tstruct rchan_buf *buf;\n\n\tlocal_irq_save(flags);\n\tbuf = *this_cpu_ptr(chan->buf);\n\tif (unlikely(buf->offset + length > chan->subbuf_size))\n\t\tlength = relay_switch_subbuf(buf, length);\n\tmemcpy(buf->data + buf->offset, data, length);\n\tbuf->offset += length;\n\tlocal_irq_restore(flags);\n}\n\n \nstatic inline void __relay_write(struct rchan *chan,\n\t\t\t\t const void *data,\n\t\t\t\t size_t length)\n{\n\tstruct rchan_buf *buf;\n\n\tbuf = *get_cpu_ptr(chan->buf);\n\tif (unlikely(buf->offset + length > buf->chan->subbuf_size))\n\t\tlength = relay_switch_subbuf(buf, length);\n\tmemcpy(buf->data + buf->offset, data, length);\n\tbuf->offset += length;\n\tput_cpu_ptr(chan->buf);\n}\n\n \nstatic inline void *relay_reserve(struct rchan *chan, size_t length)\n{\n\tvoid *reserved = NULL;\n\tstruct rchan_buf *buf = *get_cpu_ptr(chan->buf);\n\n\tif (unlikely(buf->offset + length > buf->chan->subbuf_size)) {\n\t\tlength = relay_switch_subbuf(buf, length);\n\t\tif (!length)\n\t\t\tgoto end;\n\t}\n\treserved = buf->data + buf->offset;\n\tbuf->offset += length;\n\nend:\n\tput_cpu_ptr(chan->buf);\n\treturn reserved;\n}\n\n \nstatic inline void subbuf_start_reserve(struct rchan_buf *buf,\n\t\t\t\t\tsize_t length)\n{\n\tBUG_ON(length >= buf->chan->subbuf_size - 1);\n\tbuf->offset = length;\n}\n\n \nextern const struct file_operations relay_file_operations;\n\n#ifdef CONFIG_RELAY\nint relay_prepare_cpu(unsigned int cpu);\n#else\n#define relay_prepare_cpu     NULL\n#endif\n\n#endif  \n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}