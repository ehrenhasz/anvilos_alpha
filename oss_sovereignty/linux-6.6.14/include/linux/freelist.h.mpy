{
  "module_name": "freelist.h",
  "hash_id": "f29d0b05cc1b87f3ab34f2a6fec8b341386ef6c9898e1f2eb9aa0380d26b1045",
  "original_prompt": "Ingested from linux-6.6.14/include/linux/freelist.h",
  "human_readable_source": " \n#ifndef FREELIST_H\n#define FREELIST_H\n\n#include <linux/atomic.h>\n\n \n\nstruct freelist_node {\n\tatomic_t\t\trefs;\n\tstruct freelist_node\t*next;\n};\n\nstruct freelist_head {\n\tstruct freelist_node\t*head;\n};\n\n#define REFS_ON_FREELIST 0x80000000\n#define REFS_MASK\t 0x7FFFFFFF\n\nstatic inline void __freelist_add(struct freelist_node *node, struct freelist_head *list)\n{\n\t \n\tstruct freelist_node *head = READ_ONCE(list->head);\n\n\tfor (;;) {\n\t\tWRITE_ONCE(node->next, head);\n\t\tatomic_set_release(&node->refs, 1);\n\n\t\tif (!try_cmpxchg_release(&list->head, &head, node)) {\n\t\t\t \n\t\t\tif (atomic_fetch_add_release(REFS_ON_FREELIST - 1, &node->refs) == 1)\n\t\t\t\tcontinue;\n\t\t}\n\t\treturn;\n\t}\n}\n\nstatic inline void freelist_add(struct freelist_node *node, struct freelist_head *list)\n{\n\t \n\tif (!atomic_fetch_add_release(REFS_ON_FREELIST, &node->refs)) {\n\t\t \n\t\t__freelist_add(node, list);\n\t}\n}\n\nstatic inline struct freelist_node *freelist_try_get(struct freelist_head *list)\n{\n\tstruct freelist_node *prev, *next, *head = smp_load_acquire(&list->head);\n\tunsigned int refs;\n\n\twhile (head) {\n\t\tprev = head;\n\t\trefs = atomic_read(&head->refs);\n\t\tif ((refs & REFS_MASK) == 0 ||\n\t\t    !atomic_try_cmpxchg_acquire(&head->refs, &refs, refs+1)) {\n\t\t\thead = smp_load_acquire(&list->head);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tnext = READ_ONCE(head->next);\n\t\tif (try_cmpxchg_acquire(&list->head, &head, next)) {\n\t\t\t \n\t\t\tWARN_ON_ONCE(atomic_read(&head->refs) & REFS_ON_FREELIST);\n\n\t\t\t \n\t\t\tatomic_fetch_add(-2, &head->refs);\n\n\t\t\treturn head;\n\t\t}\n\n\t\t \n\t\trefs = atomic_fetch_add(-1, &prev->refs);\n\t\tif (refs == REFS_ON_FREELIST + 1)\n\t\t\t__freelist_add(prev, list);\n\t}\n\n\treturn NULL;\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}