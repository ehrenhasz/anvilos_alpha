{
  "module_name": "kfifo.h",
  "hash_id": "94b90b64ad23f8396fa6204223b93bc0e2fb3ec6b93210548a3022edab023bfe",
  "original_prompt": "Ingested from linux-6.6.14/include/linux/kfifo.h",
  "human_readable_source": " \n \n\n#ifndef _LINUX_KFIFO_H\n#define _LINUX_KFIFO_H\n\n \n\n \n\n#include <linux/kernel.h>\n#include <linux/spinlock.h>\n#include <linux/stddef.h>\n#include <linux/scatterlist.h>\n\nstruct __kfifo {\n\tunsigned int\tin;\n\tunsigned int\tout;\n\tunsigned int\tmask;\n\tunsigned int\tesize;\n\tvoid\t\t*data;\n};\n\n#define __STRUCT_KFIFO_COMMON(datatype, recsize, ptrtype) \\\n\tunion { \\\n\t\tstruct __kfifo\tkfifo; \\\n\t\tdatatype\t*type; \\\n\t\tconst datatype\t*const_type; \\\n\t\tchar\t\t(*rectype)[recsize]; \\\n\t\tptrtype\t\t*ptr; \\\n\t\tptrtype const\t*ptr_const; \\\n\t}\n\n#define __STRUCT_KFIFO(type, size, recsize, ptrtype) \\\n{ \\\n\t__STRUCT_KFIFO_COMMON(type, recsize, ptrtype); \\\n\ttype\t\tbuf[((size < 2) || (size & (size - 1))) ? -1 : size]; \\\n}\n\n#define STRUCT_KFIFO(type, size) \\\n\tstruct __STRUCT_KFIFO(type, size, 0, type)\n\n#define __STRUCT_KFIFO_PTR(type, recsize, ptrtype) \\\n{ \\\n\t__STRUCT_KFIFO_COMMON(type, recsize, ptrtype); \\\n\ttype\t\tbuf[0]; \\\n}\n\n#define STRUCT_KFIFO_PTR(type) \\\n\tstruct __STRUCT_KFIFO_PTR(type, 0, type)\n\n \nstruct kfifo __STRUCT_KFIFO_PTR(unsigned char, 0, void);\n\n#define STRUCT_KFIFO_REC_1(size) \\\n\tstruct __STRUCT_KFIFO(unsigned char, size, 1, void)\n\n#define STRUCT_KFIFO_REC_2(size) \\\n\tstruct __STRUCT_KFIFO(unsigned char, size, 2, void)\n\n \nstruct kfifo_rec_ptr_1 __STRUCT_KFIFO_PTR(unsigned char, 1, void);\nstruct kfifo_rec_ptr_2 __STRUCT_KFIFO_PTR(unsigned char, 2, void);\n\n \n#define\t__is_kfifo_ptr(fifo) \\\n\t(sizeof(*fifo) == sizeof(STRUCT_KFIFO_PTR(typeof(*(fifo)->type))))\n\n \n#define DECLARE_KFIFO_PTR(fifo, type)\tSTRUCT_KFIFO_PTR(type) fifo\n\n \n#define DECLARE_KFIFO(fifo, type, size)\tSTRUCT_KFIFO(type, size) fifo\n\n \n#define INIT_KFIFO(fifo) \\\n(void)({ \\\n\ttypeof(&(fifo)) __tmp = &(fifo); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t__kfifo->in = 0; \\\n\t__kfifo->out = 0; \\\n\t__kfifo->mask = __is_kfifo_ptr(__tmp) ? 0 : ARRAY_SIZE(__tmp->buf) - 1;\\\n\t__kfifo->esize = sizeof(*__tmp->buf); \\\n\t__kfifo->data = __is_kfifo_ptr(__tmp) ?  NULL : __tmp->buf; \\\n})\n\n \n#define DEFINE_KFIFO(fifo, type, size) \\\n\tDECLARE_KFIFO(fifo, type, size) = \\\n\t(typeof(fifo)) { \\\n\t\t{ \\\n\t\t\t{ \\\n\t\t\t.in\t= 0, \\\n\t\t\t.out\t= 0, \\\n\t\t\t.mask\t= __is_kfifo_ptr(&(fifo)) ? \\\n\t\t\t\t  0 : \\\n\t\t\t\t  ARRAY_SIZE((fifo).buf) - 1, \\\n\t\t\t.esize\t= sizeof(*(fifo).buf), \\\n\t\t\t.data\t= __is_kfifo_ptr(&(fifo)) ? \\\n\t\t\t\tNULL : \\\n\t\t\t\t(fifo).buf, \\\n\t\t\t} \\\n\t\t} \\\n\t}\n\n\nstatic inline unsigned int __must_check\n__kfifo_uint_must_check_helper(unsigned int val)\n{\n\treturn val;\n}\n\nstatic inline int __must_check\n__kfifo_int_must_check_helper(int val)\n{\n\treturn val;\n}\n\n \n#define kfifo_initialized(fifo) ((fifo)->kfifo.mask)\n\n \n#define kfifo_esize(fifo)\t((fifo)->kfifo.esize)\n\n \n#define kfifo_recsize(fifo)\t(sizeof(*(fifo)->rectype))\n\n \n#define kfifo_size(fifo)\t((fifo)->kfifo.mask + 1)\n\n \n#define kfifo_reset(fifo) \\\n(void)({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\t__tmp->kfifo.in = __tmp->kfifo.out = 0; \\\n})\n\n \n#define kfifo_reset_out(fifo)\t\\\n(void)({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\t__tmp->kfifo.out = __tmp->kfifo.in; \\\n})\n\n \n#define kfifo_len(fifo) \\\n({ \\\n\ttypeof((fifo) + 1) __tmpl = (fifo); \\\n\t__tmpl->kfifo.in - __tmpl->kfifo.out; \\\n})\n\n \n#define\tkfifo_is_empty(fifo) \\\n({ \\\n\ttypeof((fifo) + 1) __tmpq = (fifo); \\\n\t__tmpq->kfifo.in == __tmpq->kfifo.out; \\\n})\n\n \n#define kfifo_is_empty_spinlocked(fifo, lock) \\\n({ \\\n\tunsigned long __flags; \\\n\tbool __ret; \\\n\tspin_lock_irqsave(lock, __flags); \\\n\t__ret = kfifo_is_empty(fifo); \\\n\tspin_unlock_irqrestore(lock, __flags); \\\n\t__ret; \\\n})\n\n \n#define kfifo_is_empty_spinlocked_noirqsave(fifo, lock) \\\n({ \\\n\tbool __ret; \\\n\tspin_lock(lock); \\\n\t__ret = kfifo_is_empty(fifo); \\\n\tspin_unlock(lock); \\\n\t__ret; \\\n})\n\n \n#define\tkfifo_is_full(fifo) \\\n({ \\\n\ttypeof((fifo) + 1) __tmpq = (fifo); \\\n\tkfifo_len(__tmpq) > __tmpq->kfifo.mask; \\\n})\n\n \n#define\tkfifo_avail(fifo) \\\n__kfifo_uint_must_check_helper( \\\n({ \\\n\ttypeof((fifo) + 1) __tmpq = (fifo); \\\n\tconst size_t __recsize = sizeof(*__tmpq->rectype); \\\n\tunsigned int __avail = kfifo_size(__tmpq) - kfifo_len(__tmpq); \\\n\t(__recsize) ? ((__avail <= __recsize) ? 0 : \\\n\t__kfifo_max_r(__avail - __recsize, __recsize)) : \\\n\t__avail; \\\n}) \\\n)\n\n \n#define\tkfifo_skip(fifo) \\\n(void)({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\tif (__recsize) \\\n\t\t__kfifo_skip_r(__kfifo, __recsize); \\\n\telse \\\n\t\t__kfifo->out++; \\\n})\n\n \n#define kfifo_peek_len(fifo) \\\n__kfifo_uint_must_check_helper( \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t(!__recsize) ? kfifo_len(__tmp) * sizeof(*__tmp->type) : \\\n\t__kfifo_len_r(__kfifo, __recsize); \\\n}) \\\n)\n\n \n#define kfifo_alloc(fifo, size, gfp_mask) \\\n__kfifo_int_must_check_helper( \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t__is_kfifo_ptr(__tmp) ? \\\n\t__kfifo_alloc(__kfifo, size, sizeof(*__tmp->type), gfp_mask) : \\\n\t-EINVAL; \\\n}) \\\n)\n\n \n#define kfifo_free(fifo) \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\tif (__is_kfifo_ptr(__tmp)) \\\n\t\t__kfifo_free(__kfifo); \\\n})\n\n \n#define kfifo_init(fifo, buffer, size) \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t__is_kfifo_ptr(__tmp) ? \\\n\t__kfifo_init(__kfifo, buffer, size, sizeof(*__tmp->type)) : \\\n\t-EINVAL; \\\n})\n\n \n#define\tkfifo_put(fifo, val) \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\ttypeof(*__tmp->const_type) __val = (val); \\\n\tunsigned int __ret; \\\n\tsize_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\tif (__recsize) \\\n\t\t__ret = __kfifo_in_r(__kfifo, &__val, sizeof(__val), \\\n\t\t\t__recsize); \\\n\telse { \\\n\t\t__ret = !kfifo_is_full(__tmp); \\\n\t\tif (__ret) { \\\n\t\t\t(__is_kfifo_ptr(__tmp) ? \\\n\t\t\t((typeof(__tmp->type))__kfifo->data) : \\\n\t\t\t(__tmp->buf) \\\n\t\t\t)[__kfifo->in & __tmp->kfifo.mask] = \\\n\t\t\t\t*(typeof(__tmp->type))&__val; \\\n\t\t\tsmp_wmb(); \\\n\t\t\t__kfifo->in++; \\\n\t\t} \\\n\t} \\\n\t__ret; \\\n})\n\n \n#define\tkfifo_get(fifo, val) \\\n__kfifo_uint_must_check_helper( \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\ttypeof(__tmp->ptr) __val = (val); \\\n\tunsigned int __ret; \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\tif (__recsize) \\\n\t\t__ret = __kfifo_out_r(__kfifo, __val, sizeof(*__val), \\\n\t\t\t__recsize); \\\n\telse { \\\n\t\t__ret = !kfifo_is_empty(__tmp); \\\n\t\tif (__ret) { \\\n\t\t\t*(typeof(__tmp->type))__val = \\\n\t\t\t\t(__is_kfifo_ptr(__tmp) ? \\\n\t\t\t\t((typeof(__tmp->type))__kfifo->data) : \\\n\t\t\t\t(__tmp->buf) \\\n\t\t\t\t)[__kfifo->out & __tmp->kfifo.mask]; \\\n\t\t\tsmp_wmb(); \\\n\t\t\t__kfifo->out++; \\\n\t\t} \\\n\t} \\\n\t__ret; \\\n}) \\\n)\n\n \n#define\tkfifo_peek(fifo, val) \\\n__kfifo_uint_must_check_helper( \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\ttypeof(__tmp->ptr) __val = (val); \\\n\tunsigned int __ret; \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\tif (__recsize) \\\n\t\t__ret = __kfifo_out_peek_r(__kfifo, __val, sizeof(*__val), \\\n\t\t\t__recsize); \\\n\telse { \\\n\t\t__ret = !kfifo_is_empty(__tmp); \\\n\t\tif (__ret) { \\\n\t\t\t*(typeof(__tmp->type))__val = \\\n\t\t\t\t(__is_kfifo_ptr(__tmp) ? \\\n\t\t\t\t((typeof(__tmp->type))__kfifo->data) : \\\n\t\t\t\t(__tmp->buf) \\\n\t\t\t\t)[__kfifo->out & __tmp->kfifo.mask]; \\\n\t\t\tsmp_wmb(); \\\n\t\t} \\\n\t} \\\n\t__ret; \\\n}) \\\n)\n\n \n#define\tkfifo_in(fifo, buf, n) \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\ttypeof(__tmp->ptr_const) __buf = (buf); \\\n\tunsigned long __n = (n); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t(__recsize) ?\\\n\t__kfifo_in_r(__kfifo, __buf, __n, __recsize) : \\\n\t__kfifo_in(__kfifo, __buf, __n); \\\n})\n\n \n#define\tkfifo_in_spinlocked(fifo, buf, n, lock) \\\n({ \\\n\tunsigned long __flags; \\\n\tunsigned int __ret; \\\n\tspin_lock_irqsave(lock, __flags); \\\n\t__ret = kfifo_in(fifo, buf, n); \\\n\tspin_unlock_irqrestore(lock, __flags); \\\n\t__ret; \\\n})\n\n \n#define kfifo_in_spinlocked_noirqsave(fifo, buf, n, lock) \\\n({ \\\n\tunsigned int __ret; \\\n\tspin_lock(lock); \\\n\t__ret = kfifo_in(fifo, buf, n); \\\n\tspin_unlock(lock); \\\n\t__ret; \\\n})\n\n \n#define kfifo_in_locked(fifo, buf, n, lock) \\\n\t\tkfifo_in_spinlocked(fifo, buf, n, lock)\n\n \n#define\tkfifo_out(fifo, buf, n) \\\n__kfifo_uint_must_check_helper( \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\ttypeof(__tmp->ptr) __buf = (buf); \\\n\tunsigned long __n = (n); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t(__recsize) ?\\\n\t__kfifo_out_r(__kfifo, __buf, __n, __recsize) : \\\n\t__kfifo_out(__kfifo, __buf, __n); \\\n}) \\\n)\n\n \n#define\tkfifo_out_spinlocked(fifo, buf, n, lock) \\\n__kfifo_uint_must_check_helper( \\\n({ \\\n\tunsigned long __flags; \\\n\tunsigned int __ret; \\\n\tspin_lock_irqsave(lock, __flags); \\\n\t__ret = kfifo_out(fifo, buf, n); \\\n\tspin_unlock_irqrestore(lock, __flags); \\\n\t__ret; \\\n}) \\\n)\n\n \n#define kfifo_out_spinlocked_noirqsave(fifo, buf, n, lock) \\\n__kfifo_uint_must_check_helper( \\\n({ \\\n\tunsigned int __ret; \\\n\tspin_lock(lock); \\\n\t__ret = kfifo_out(fifo, buf, n); \\\n\tspin_unlock(lock); \\\n\t__ret; \\\n}) \\\n)\n\n \n#define kfifo_out_locked(fifo, buf, n, lock) \\\n\t\tkfifo_out_spinlocked(fifo, buf, n, lock)\n\n \n#define\tkfifo_from_user(fifo, from, len, copied) \\\n__kfifo_uint_must_check_helper( \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\tconst void __user *__from = (from); \\\n\tunsigned int __len = (len); \\\n\tunsigned int *__copied = (copied); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t(__recsize) ? \\\n\t__kfifo_from_user_r(__kfifo, __from, __len,  __copied, __recsize) : \\\n\t__kfifo_from_user(__kfifo, __from, __len, __copied); \\\n}) \\\n)\n\n \n#define\tkfifo_to_user(fifo, to, len, copied) \\\n__kfifo_int_must_check_helper( \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\tvoid __user *__to = (to); \\\n\tunsigned int __len = (len); \\\n\tunsigned int *__copied = (copied); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t(__recsize) ? \\\n\t__kfifo_to_user_r(__kfifo, __to, __len, __copied, __recsize) : \\\n\t__kfifo_to_user(__kfifo, __to, __len, __copied); \\\n}) \\\n)\n\n \n#define\tkfifo_dma_in_prepare(fifo, sgl, nents, len) \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\tstruct scatterlist *__sgl = (sgl); \\\n\tint __nents = (nents); \\\n\tunsigned int __len = (len); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t(__recsize) ? \\\n\t__kfifo_dma_in_prepare_r(__kfifo, __sgl, __nents, __len, __recsize) : \\\n\t__kfifo_dma_in_prepare(__kfifo, __sgl, __nents, __len); \\\n})\n\n \n#define kfifo_dma_in_finish(fifo, len) \\\n(void)({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\tunsigned int __len = (len); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\tif (__recsize) \\\n\t\t__kfifo_dma_in_finish_r(__kfifo, __len, __recsize); \\\n\telse \\\n\t\t__kfifo->in += __len / sizeof(*__tmp->type); \\\n})\n\n \n#define\tkfifo_dma_out_prepare(fifo, sgl, nents, len) \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo);  \\\n\tstruct scatterlist *__sgl = (sgl); \\\n\tint __nents = (nents); \\\n\tunsigned int __len = (len); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t(__recsize) ? \\\n\t__kfifo_dma_out_prepare_r(__kfifo, __sgl, __nents, __len, __recsize) : \\\n\t__kfifo_dma_out_prepare(__kfifo, __sgl, __nents, __len); \\\n})\n\n \n#define kfifo_dma_out_finish(fifo, len) \\\n(void)({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\tunsigned int __len = (len); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\tif (__recsize) \\\n\t\t__kfifo_dma_out_finish_r(__kfifo, __recsize); \\\n\telse \\\n\t\t__kfifo->out += __len / sizeof(*__tmp->type); \\\n})\n\n \n#define\tkfifo_out_peek(fifo, buf, n) \\\n__kfifo_uint_must_check_helper( \\\n({ \\\n\ttypeof((fifo) + 1) __tmp = (fifo); \\\n\ttypeof(__tmp->ptr) __buf = (buf); \\\n\tunsigned long __n = (n); \\\n\tconst size_t __recsize = sizeof(*__tmp->rectype); \\\n\tstruct __kfifo *__kfifo = &__tmp->kfifo; \\\n\t(__recsize) ? \\\n\t__kfifo_out_peek_r(__kfifo, __buf, __n, __recsize) : \\\n\t__kfifo_out_peek(__kfifo, __buf, __n); \\\n}) \\\n)\n\nextern int __kfifo_alloc(struct __kfifo *fifo, unsigned int size,\n\tsize_t esize, gfp_t gfp_mask);\n\nextern void __kfifo_free(struct __kfifo *fifo);\n\nextern int __kfifo_init(struct __kfifo *fifo, void *buffer,\n\tunsigned int size, size_t esize);\n\nextern unsigned int __kfifo_in(struct __kfifo *fifo,\n\tconst void *buf, unsigned int len);\n\nextern unsigned int __kfifo_out(struct __kfifo *fifo,\n\tvoid *buf, unsigned int len);\n\nextern int __kfifo_from_user(struct __kfifo *fifo,\n\tconst void __user *from, unsigned long len, unsigned int *copied);\n\nextern int __kfifo_to_user(struct __kfifo *fifo,\n\tvoid __user *to, unsigned long len, unsigned int *copied);\n\nextern unsigned int __kfifo_dma_in_prepare(struct __kfifo *fifo,\n\tstruct scatterlist *sgl, int nents, unsigned int len);\n\nextern unsigned int __kfifo_dma_out_prepare(struct __kfifo *fifo,\n\tstruct scatterlist *sgl, int nents, unsigned int len);\n\nextern unsigned int __kfifo_out_peek(struct __kfifo *fifo,\n\tvoid *buf, unsigned int len);\n\nextern unsigned int __kfifo_in_r(struct __kfifo *fifo,\n\tconst void *buf, unsigned int len, size_t recsize);\n\nextern unsigned int __kfifo_out_r(struct __kfifo *fifo,\n\tvoid *buf, unsigned int len, size_t recsize);\n\nextern int __kfifo_from_user_r(struct __kfifo *fifo,\n\tconst void __user *from, unsigned long len, unsigned int *copied,\n\tsize_t recsize);\n\nextern int __kfifo_to_user_r(struct __kfifo *fifo, void __user *to,\n\tunsigned long len, unsigned int *copied, size_t recsize);\n\nextern unsigned int __kfifo_dma_in_prepare_r(struct __kfifo *fifo,\n\tstruct scatterlist *sgl, int nents, unsigned int len, size_t recsize);\n\nextern void __kfifo_dma_in_finish_r(struct __kfifo *fifo,\n\tunsigned int len, size_t recsize);\n\nextern unsigned int __kfifo_dma_out_prepare_r(struct __kfifo *fifo,\n\tstruct scatterlist *sgl, int nents, unsigned int len, size_t recsize);\n\nextern void __kfifo_dma_out_finish_r(struct __kfifo *fifo, size_t recsize);\n\nextern unsigned int __kfifo_len_r(struct __kfifo *fifo, size_t recsize);\n\nextern void __kfifo_skip_r(struct __kfifo *fifo, size_t recsize);\n\nextern unsigned int __kfifo_out_peek_r(struct __kfifo *fifo,\n\tvoid *buf, unsigned int len, size_t recsize);\n\nextern unsigned int __kfifo_max_r(unsigned int len, size_t recsize);\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}