{
  "module_name": "spinand.h",
  "hash_id": "3576c8033dc598c9a1f8e17d87c461ed697440bb74b5f459bb515ea19deb0d5b",
  "original_prompt": "Ingested from linux-6.6.14/include/linux/mtd/spinand.h",
  "human_readable_source": " \n \n#ifndef __LINUX_MTD_SPINAND_H\n#define __LINUX_MTD_SPINAND_H\n\n#include <linux/mutex.h>\n#include <linux/bitops.h>\n#include <linux/device.h>\n#include <linux/mtd/mtd.h>\n#include <linux/mtd/nand.h>\n#include <linux/spi/spi.h>\n#include <linux/spi/spi-mem.h>\n\n \n\n#define SPINAND_RESET_OP\t\t\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0xff, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_ADDR,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DATA)\n\n#define SPINAND_WR_EN_DIS_OP(enable)\t\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD((enable) ? 0x06 : 0x04, 1),\t\t\\\n\t\t   SPI_MEM_OP_NO_ADDR,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DATA)\n\n#define SPINAND_READID_OP(naddr, ndummy, buf, len)\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0x9f, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(naddr, 0, 1),\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 1))\n\n#define SPINAND_SET_FEATURE_OP(reg, valptr)\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0x1f, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(1, reg, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_OUT(1, valptr, 1))\n\n#define SPINAND_GET_FEATURE_OP(reg, valptr)\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0x0f, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(1, reg, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(1, valptr, 1))\n\n#define SPINAND_BLK_ERASE_OP(addr)\t\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0xd8, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(3, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DATA)\n\n#define SPINAND_PAGE_READ_OP(addr)\t\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0x13, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(3, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DATA)\n\n#define SPINAND_PAGE_READ_FROM_CACHE_OP(fast, addr, ndummy, buf, len)\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(fast ? 0x0b : 0x03, 1),\t\t\\\n\t\t   SPI_MEM_OP_ADDR(2, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 1))\n\n#define SPINAND_PAGE_READ_FROM_CACHE_OP_3A(fast, addr, ndummy, buf, len) \\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(fast ? 0x0b : 0x03, 1),\t\t\\\n\t\t   SPI_MEM_OP_ADDR(3, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 1))\n\n#define SPINAND_PAGE_READ_FROM_CACHE_X2_OP(addr, ndummy, buf, len)\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0x3b, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(2, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 2))\n\n#define SPINAND_PAGE_READ_FROM_CACHE_X2_OP_3A(addr, ndummy, buf, len)\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0x3b, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(3, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 2))\n\n#define SPINAND_PAGE_READ_FROM_CACHE_X4_OP(addr, ndummy, buf, len)\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0x6b, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(2, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 4))\n\n#define SPINAND_PAGE_READ_FROM_CACHE_X4_OP_3A(addr, ndummy, buf, len)\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0x6b, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(3, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 4))\n\n#define SPINAND_PAGE_READ_FROM_CACHE_DUALIO_OP(addr, ndummy, buf, len)\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0xbb, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(2, addr, 2),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 2),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 2))\n\n#define SPINAND_PAGE_READ_FROM_CACHE_DUALIO_OP_3A(addr, ndummy, buf, len) \\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0xbb, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(3, addr, 2),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 2),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 2))\n\n#define SPINAND_PAGE_READ_FROM_CACHE_QUADIO_OP(addr, ndummy, buf, len)\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0xeb, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(2, addr, 4),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 4),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 4))\n\n#define SPINAND_PAGE_READ_FROM_CACHE_QUADIO_OP_3A(addr, ndummy, buf, len) \\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0xeb, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(3, addr, 4),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DUMMY(ndummy, 4),\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_IN(len, buf, 4))\n\n#define SPINAND_PROG_EXEC_OP(addr)\t\t\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(0x10, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_ADDR(3, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DATA)\n\n#define SPINAND_PROG_LOAD(reset, addr, buf, len)\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(reset ? 0x02 : 0x84, 1),\t\t\\\n\t\t   SPI_MEM_OP_ADDR(2, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_OUT(len, buf, 1))\n\n#define SPINAND_PROG_LOAD_X4(reset, addr, buf, len)\t\t\t\\\n\tSPI_MEM_OP(SPI_MEM_OP_CMD(reset ? 0x32 : 0x34, 1),\t\t\\\n\t\t   SPI_MEM_OP_ADDR(2, addr, 1),\t\t\t\t\\\n\t\t   SPI_MEM_OP_NO_DUMMY,\t\t\t\t\t\\\n\t\t   SPI_MEM_OP_DATA_OUT(len, buf, 4))\n\n \n#define SPINAND_CMD_PROG_LOAD_X4\t\t0x32\n#define SPINAND_CMD_PROG_LOAD_RDM_DATA_X4\t0x34\n\n \n#define REG_BLOCK_LOCK\t\t0xa0\n#define BL_ALL_UNLOCKED\t\t0x00\n\n \n#define REG_CFG\t\t\t0xb0\n#define CFG_OTP_ENABLE\t\tBIT(6)\n#define CFG_ECC_ENABLE\t\tBIT(4)\n#define CFG_QUAD_ENABLE\t\tBIT(0)\n\n \n#define REG_STATUS\t\t0xc0\n#define STATUS_BUSY\t\tBIT(0)\n#define STATUS_ERASE_FAILED\tBIT(2)\n#define STATUS_PROG_FAILED\tBIT(3)\n#define STATUS_ECC_MASK\t\tGENMASK(5, 4)\n#define STATUS_ECC_NO_BITFLIPS\t(0 << 4)\n#define STATUS_ECC_HAS_BITFLIPS\t(1 << 4)\n#define STATUS_ECC_UNCOR_ERROR\t(2 << 4)\n\nstruct spinand_op;\nstruct spinand_device;\n\n#define SPINAND_MAX_ID_LEN\t4\n \n#define SPINAND_READ_INITIAL_DELAY_US\t6\n#define SPINAND_READ_POLL_DELAY_US\t5\n#define SPINAND_RESET_INITIAL_DELAY_US\t5\n#define SPINAND_RESET_POLL_DELAY_US\t5\n#define SPINAND_WRITE_INITIAL_DELAY_US\t75\n#define SPINAND_WRITE_POLL_DELAY_US\t15\n#define SPINAND_ERASE_INITIAL_DELAY_US\t250\n#define SPINAND_ERASE_POLL_DELAY_US\t50\n\n#define SPINAND_WAITRDY_TIMEOUT_MS\t400\n\n \nstruct spinand_id {\n\tu8 data[SPINAND_MAX_ID_LEN];\n\tint len;\n};\n\nenum spinand_readid_method {\n\tSPINAND_READID_METHOD_OPCODE,\n\tSPINAND_READID_METHOD_OPCODE_ADDR,\n\tSPINAND_READID_METHOD_OPCODE_DUMMY,\n};\n\n \nstruct spinand_devid {\n\tconst u8 *id;\n\tconst u8 len;\n\tconst enum spinand_readid_method method;\n};\n\n \nstruct spinand_manufacturer_ops {\n\tint (*init)(struct spinand_device *spinand);\n\tvoid (*cleanup)(struct spinand_device *spinand);\n};\n\n \nstruct spinand_manufacturer {\n\tu8 id;\n\tchar *name;\n\tconst struct spinand_info *chips;\n\tconst size_t nchips;\n\tconst struct spinand_manufacturer_ops *ops;\n};\n\n \nextern const struct spinand_manufacturer alliancememory_spinand_manufacturer;\nextern const struct spinand_manufacturer ato_spinand_manufacturer;\nextern const struct spinand_manufacturer esmt_c8_spinand_manufacturer;\nextern const struct spinand_manufacturer gigadevice_spinand_manufacturer;\nextern const struct spinand_manufacturer macronix_spinand_manufacturer;\nextern const struct spinand_manufacturer micron_spinand_manufacturer;\nextern const struct spinand_manufacturer paragon_spinand_manufacturer;\nextern const struct spinand_manufacturer toshiba_spinand_manufacturer;\nextern const struct spinand_manufacturer winbond_spinand_manufacturer;\nextern const struct spinand_manufacturer xtx_spinand_manufacturer;\n\n \nstruct spinand_op_variants {\n\tconst struct spi_mem_op *ops;\n\tunsigned int nops;\n};\n\n#define SPINAND_OP_VARIANTS(name, ...)\t\t\t\t\t\\\n\tconst struct spinand_op_variants name = {\t\t\t\\\n\t\t.ops = (struct spi_mem_op[]) { __VA_ARGS__ },\t\t\\\n\t\t.nops = sizeof((struct spi_mem_op[]){ __VA_ARGS__ }) /\t\\\n\t\t\tsizeof(struct spi_mem_op),\t\t\t\\\n\t}\n\n \nstruct spinand_ecc_info {\n\tint (*get_status)(struct spinand_device *spinand, u8 status);\n\tconst struct mtd_ooblayout_ops *ooblayout;\n};\n\n#define SPINAND_HAS_QE_BIT\t\tBIT(0)\n#define SPINAND_HAS_CR_FEAT_BIT\t\tBIT(1)\n\n \nstruct spinand_ondie_ecc_conf {\n\tu8 status;\n};\n\n \nstruct spinand_info {\n\tconst char *model;\n\tstruct spinand_devid devid;\n\tu32 flags;\n\tstruct nand_memory_organization memorg;\n\tstruct nand_ecc_props eccreq;\n\tstruct spinand_ecc_info eccinfo;\n\tstruct {\n\t\tconst struct spinand_op_variants *read_cache;\n\t\tconst struct spinand_op_variants *write_cache;\n\t\tconst struct spinand_op_variants *update_cache;\n\t} op_variants;\n\tint (*select_target)(struct spinand_device *spinand,\n\t\t\t     unsigned int target);\n};\n\n#define SPINAND_ID(__method, ...)\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.id = (const u8[]){ __VA_ARGS__ },\t\t\t\\\n\t\t.len = sizeof((u8[]){ __VA_ARGS__ }),\t\t\t\\\n\t\t.method = __method,\t\t\t\t\t\\\n\t}\n\n#define SPINAND_INFO_OP_VARIANTS(__read, __write, __update)\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.read_cache = __read,\t\t\t\t\t\\\n\t\t.write_cache = __write,\t\t\t\t\t\\\n\t\t.update_cache = __update,\t\t\t\t\\\n\t}\n\n#define SPINAND_ECCINFO(__ooblayout, __get_status)\t\t\t\\\n\t.eccinfo = {\t\t\t\t\t\t\t\\\n\t\t.ooblayout = __ooblayout,\t\t\t\t\\\n\t\t.get_status = __get_status,\t\t\t\t\\\n\t}\n\n#define SPINAND_SELECT_TARGET(__func)\t\t\t\t\t\\\n\t.select_target = __func,\n\n#define SPINAND_INFO(__model, __id, __memorg, __eccreq, __op_variants,\t\\\n\t\t     __flags, ...)\t\t\t\t\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\t.model = __model,\t\t\t\t\t\\\n\t\t.devid = __id,\t\t\t\t\t\t\\\n\t\t.memorg = __memorg,\t\t\t\t\t\\\n\t\t.eccreq = __eccreq,\t\t\t\t\t\\\n\t\t.op_variants = __op_variants,\t\t\t\t\\\n\t\t.flags = __flags,\t\t\t\t\t\\\n\t\t__VA_ARGS__\t\t\t\t\t\t\\\n\t}\n\nstruct spinand_dirmap {\n\tstruct spi_mem_dirmap_desc *wdesc;\n\tstruct spi_mem_dirmap_desc *rdesc;\n\tstruct spi_mem_dirmap_desc *wdesc_ecc;\n\tstruct spi_mem_dirmap_desc *rdesc_ecc;\n};\n\n \nstruct spinand_device {\n\tstruct nand_device base;\n\tstruct spi_mem *spimem;\n\tstruct mutex lock;\n\tstruct spinand_id id;\n\tu32 flags;\n\n\tstruct {\n\t\tconst struct spi_mem_op *read_cache;\n\t\tconst struct spi_mem_op *write_cache;\n\t\tconst struct spi_mem_op *update_cache;\n\t} op_templates;\n\n\tstruct spinand_dirmap *dirmaps;\n\n\tint (*select_target)(struct spinand_device *spinand,\n\t\t\t     unsigned int target);\n\tunsigned int cur_target;\n\n\tstruct spinand_ecc_info eccinfo;\n\n\tu8 *cfg_cache;\n\tu8 *databuf;\n\tu8 *oobbuf;\n\tu8 *scratchbuf;\n\tconst struct spinand_manufacturer *manufacturer;\n\tvoid *priv;\n};\n\n \nstatic inline struct spinand_device *mtd_to_spinand(struct mtd_info *mtd)\n{\n\treturn container_of(mtd_to_nanddev(mtd), struct spinand_device, base);\n}\n\n \nstatic inline struct mtd_info *spinand_to_mtd(struct spinand_device *spinand)\n{\n\treturn nanddev_to_mtd(&spinand->base);\n}\n\n \nstatic inline struct spinand_device *nand_to_spinand(struct nand_device *nand)\n{\n\treturn container_of(nand, struct spinand_device, base);\n}\n\n \nstatic inline struct nand_device *\nspinand_to_nand(struct spinand_device *spinand)\n{\n\treturn &spinand->base;\n}\n\n \nstatic inline void spinand_set_of_node(struct spinand_device *spinand,\n\t\t\t\t       struct device_node *np)\n{\n\tnanddev_set_of_node(&spinand->base, np);\n}\n\nint spinand_match_and_init(struct spinand_device *spinand,\n\t\t\t   const struct spinand_info *table,\n\t\t\t   unsigned int table_size,\n\t\t\t   enum spinand_readid_method rdid_method);\n\nint spinand_upd_cfg(struct spinand_device *spinand, u8 mask, u8 val);\nint spinand_select_target(struct spinand_device *spinand, unsigned int target);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}