{
  "module_name": "kernfs.h",
  "hash_id": "614ae78d71af90e1ea49855090b1f139509ff165b892deba1767ca71753e168b",
  "original_prompt": "Ingested from linux-6.6.14/include/linux/kernfs.h",
  "human_readable_source": " \n \n\n#ifndef __LINUX_KERNFS_H\n#define __LINUX_KERNFS_H\n\n#include <linux/err.h>\n#include <linux/list.h>\n#include <linux/mutex.h>\n#include <linux/idr.h>\n#include <linux/lockdep.h>\n#include <linux/rbtree.h>\n#include <linux/atomic.h>\n#include <linux/bug.h>\n#include <linux/types.h>\n#include <linux/uidgid.h>\n#include <linux/wait.h>\n#include <linux/rwsem.h>\n#include <linux/cache.h>\n\nstruct file;\nstruct dentry;\nstruct iattr;\nstruct seq_file;\nstruct vm_area_struct;\nstruct vm_operations_struct;\nstruct super_block;\nstruct file_system_type;\nstruct poll_table_struct;\nstruct fs_context;\n\nstruct kernfs_fs_context;\nstruct kernfs_open_node;\nstruct kernfs_iattrs;\n\n \n#ifdef CONFIG_SMP\n#define NR_KERNFS_LOCK_BITS (2 * (ilog2(NR_CPUS < 32 ? NR_CPUS : 32)))\n#else\n#define NR_KERNFS_LOCK_BITS     1\n#endif\n\n#define NR_KERNFS_LOCKS     (1 << NR_KERNFS_LOCK_BITS)\n\n \nstruct kernfs_global_locks {\n\tstruct mutex open_file_mutex[NR_KERNFS_LOCKS];\n};\n\nenum kernfs_node_type {\n\tKERNFS_DIR\t\t= 0x0001,\n\tKERNFS_FILE\t\t= 0x0002,\n\tKERNFS_LINK\t\t= 0x0004,\n};\n\n#define KERNFS_TYPE_MASK\t\t0x000f\n#define KERNFS_FLAG_MASK\t\t~KERNFS_TYPE_MASK\n#define KERNFS_MAX_USER_XATTRS\t\t128\n#define KERNFS_USER_XATTR_SIZE_LIMIT\t(128 << 10)\n\nenum kernfs_node_flag {\n\tKERNFS_ACTIVATED\t= 0x0010,\n\tKERNFS_NS\t\t= 0x0020,\n\tKERNFS_HAS_SEQ_SHOW\t= 0x0040,\n\tKERNFS_HAS_MMAP\t\t= 0x0080,\n\tKERNFS_LOCKDEP\t\t= 0x0100,\n\tKERNFS_HIDDEN\t\t= 0x0200,\n\tKERNFS_SUICIDAL\t\t= 0x0400,\n\tKERNFS_SUICIDED\t\t= 0x0800,\n\tKERNFS_EMPTY_DIR\t= 0x1000,\n\tKERNFS_HAS_RELEASE\t= 0x2000,\n\tKERNFS_REMOVING\t\t= 0x4000,\n};\n\n \nenum kernfs_root_flag {\n\t \n\tKERNFS_ROOT_CREATE_DEACTIVATED\t\t= 0x0001,\n\n\t \n\tKERNFS_ROOT_EXTRA_OPEN_PERM_CHECK\t= 0x0002,\n\n\t \n\tKERNFS_ROOT_SUPPORT_EXPORTOP\t\t= 0x0004,\n\n\t \n\tKERNFS_ROOT_SUPPORT_USER_XATTR\t\t= 0x0008,\n};\n\n \nstruct kernfs_elem_dir {\n\tunsigned long\t\tsubdirs;\n\t \n\tstruct rb_root\t\tchildren;\n\n\t \n\tstruct kernfs_root\t*root;\n\t \n\tunsigned long\t\trev;\n};\n\nstruct kernfs_elem_symlink {\n\tstruct kernfs_node\t*target_kn;\n};\n\nstruct kernfs_elem_attr {\n\tconst struct kernfs_ops\t*ops;\n\tstruct kernfs_open_node __rcu\t*open;\n\tloff_t\t\t\tsize;\n\tstruct kernfs_node\t*notify_next;\t \n};\n\n \nstruct kernfs_node {\n\tatomic_t\t\tcount;\n\tatomic_t\t\tactive;\n#ifdef CONFIG_DEBUG_LOCK_ALLOC\n\tstruct lockdep_map\tdep_map;\n#endif\n\t \n\tstruct kernfs_node\t*parent;\n\tconst char\t\t*name;\n\n\tstruct rb_node\t\trb;\n\n\tconst void\t\t*ns;\t \n\tunsigned int\t\thash;\t \n\tunion {\n\t\tstruct kernfs_elem_dir\t\tdir;\n\t\tstruct kernfs_elem_symlink\tsymlink;\n\t\tstruct kernfs_elem_attr\t\tattr;\n\t};\n\n\tvoid\t\t\t*priv;\n\n\t \n\tu64\t\t\tid;\n\n\tunsigned short\t\tflags;\n\tumode_t\t\t\tmode;\n\tstruct kernfs_iattrs\t*iattr;\n};\n\n \nstruct kernfs_syscall_ops {\n\tint (*show_options)(struct seq_file *sf, struct kernfs_root *root);\n\n\tint (*mkdir)(struct kernfs_node *parent, const char *name,\n\t\t     umode_t mode);\n\tint (*rmdir)(struct kernfs_node *kn);\n\tint (*rename)(struct kernfs_node *kn, struct kernfs_node *new_parent,\n\t\t      const char *new_name);\n\tint (*show_path)(struct seq_file *sf, struct kernfs_node *kn,\n\t\t\t struct kernfs_root *root);\n};\n\nstruct kernfs_node *kernfs_root_to_node(struct kernfs_root *root);\n\nstruct kernfs_open_file {\n\t \n\tstruct kernfs_node\t*kn;\n\tstruct file\t\t*file;\n\tstruct seq_file\t\t*seq_file;\n\tvoid\t\t\t*priv;\n\n\t \n\tstruct mutex\t\tmutex;\n\tstruct mutex\t\tprealloc_mutex;\n\tint\t\t\tevent;\n\tstruct list_head\tlist;\n\tchar\t\t\t*prealloc_buf;\n\n\tsize_t\t\t\tatomic_write_len;\n\tbool\t\t\tmmapped:1;\n\tbool\t\t\treleased:1;\n\tconst struct vm_operations_struct *vm_ops;\n};\n\nstruct kernfs_ops {\n\t \n\tint (*open)(struct kernfs_open_file *of);\n\tvoid (*release)(struct kernfs_open_file *of);\n\n\t \n\tint (*seq_show)(struct seq_file *sf, void *v);\n\n\tvoid *(*seq_start)(struct seq_file *sf, loff_t *ppos);\n\tvoid *(*seq_next)(struct seq_file *sf, void *v, loff_t *ppos);\n\tvoid (*seq_stop)(struct seq_file *sf, void *v);\n\n\tssize_t (*read)(struct kernfs_open_file *of, char *buf, size_t bytes,\n\t\t\tloff_t off);\n\n\t \n\tsize_t atomic_write_len;\n\t \n\tbool prealloc;\n\tssize_t (*write)(struct kernfs_open_file *of, char *buf, size_t bytes,\n\t\t\t loff_t off);\n\n\t__poll_t (*poll)(struct kernfs_open_file *of,\n\t\t\t struct poll_table_struct *pt);\n\n\tint (*mmap)(struct kernfs_open_file *of, struct vm_area_struct *vma);\n};\n\n \nstruct kernfs_fs_context {\n\tstruct kernfs_root\t*root;\t\t \n\tvoid\t\t\t*ns_tag;\t \n\tunsigned long\t\tmagic;\t\t \n\n\t \n\tbool\t\t\tnew_sb_created;\t \n};\n\n#ifdef CONFIG_KERNFS\n\nstatic inline enum kernfs_node_type kernfs_type(struct kernfs_node *kn)\n{\n\treturn kn->flags & KERNFS_TYPE_MASK;\n}\n\nstatic inline ino_t kernfs_id_ino(u64 id)\n{\n\t \n\tif (sizeof(ino_t) >= sizeof(u64))\n\t\treturn id;\n\telse\n\t\treturn (u32)id;\n}\n\nstatic inline u32 kernfs_id_gen(u64 id)\n{\n\t \n\tif (sizeof(ino_t) >= sizeof(u64))\n\t\treturn 1;\n\telse\n\t\treturn id >> 32;\n}\n\nstatic inline ino_t kernfs_ino(struct kernfs_node *kn)\n{\n\treturn kernfs_id_ino(kn->id);\n}\n\nstatic inline ino_t kernfs_gen(struct kernfs_node *kn)\n{\n\treturn kernfs_id_gen(kn->id);\n}\n\n \nstatic inline void kernfs_enable_ns(struct kernfs_node *kn)\n{\n\tWARN_ON_ONCE(kernfs_type(kn) != KERNFS_DIR);\n\tWARN_ON_ONCE(!RB_EMPTY_ROOT(&kn->dir.children));\n\tkn->flags |= KERNFS_NS;\n}\n\n \nstatic inline bool kernfs_ns_enabled(struct kernfs_node *kn)\n{\n\treturn kn->flags & KERNFS_NS;\n}\n\nint kernfs_name(struct kernfs_node *kn, char *buf, size_t buflen);\nint kernfs_path_from_node(struct kernfs_node *root_kn, struct kernfs_node *kn,\n\t\t\t  char *buf, size_t buflen);\nvoid pr_cont_kernfs_name(struct kernfs_node *kn);\nvoid pr_cont_kernfs_path(struct kernfs_node *kn);\nstruct kernfs_node *kernfs_get_parent(struct kernfs_node *kn);\nstruct kernfs_node *kernfs_find_and_get_ns(struct kernfs_node *parent,\n\t\t\t\t\t   const char *name, const void *ns);\nstruct kernfs_node *kernfs_walk_and_get_ns(struct kernfs_node *parent,\n\t\t\t\t\t   const char *path, const void *ns);\nvoid kernfs_get(struct kernfs_node *kn);\nvoid kernfs_put(struct kernfs_node *kn);\n\nstruct kernfs_node *kernfs_node_from_dentry(struct dentry *dentry);\nstruct kernfs_root *kernfs_root_from_sb(struct super_block *sb);\nstruct inode *kernfs_get_inode(struct super_block *sb, struct kernfs_node *kn);\n\nstruct dentry *kernfs_node_dentry(struct kernfs_node *kn,\n\t\t\t\t  struct super_block *sb);\nstruct kernfs_root *kernfs_create_root(struct kernfs_syscall_ops *scops,\n\t\t\t\t       unsigned int flags, void *priv);\nvoid kernfs_destroy_root(struct kernfs_root *root);\n\nstruct kernfs_node *kernfs_create_dir_ns(struct kernfs_node *parent,\n\t\t\t\t\t const char *name, umode_t mode,\n\t\t\t\t\t kuid_t uid, kgid_t gid,\n\t\t\t\t\t void *priv, const void *ns);\nstruct kernfs_node *kernfs_create_empty_dir(struct kernfs_node *parent,\n\t\t\t\t\t    const char *name);\nstruct kernfs_node *__kernfs_create_file(struct kernfs_node *parent,\n\t\t\t\t\t const char *name, umode_t mode,\n\t\t\t\t\t kuid_t uid, kgid_t gid,\n\t\t\t\t\t loff_t size,\n\t\t\t\t\t const struct kernfs_ops *ops,\n\t\t\t\t\t void *priv, const void *ns,\n\t\t\t\t\t struct lock_class_key *key);\nstruct kernfs_node *kernfs_create_link(struct kernfs_node *parent,\n\t\t\t\t       const char *name,\n\t\t\t\t       struct kernfs_node *target);\nvoid kernfs_activate(struct kernfs_node *kn);\nvoid kernfs_show(struct kernfs_node *kn, bool show);\nvoid kernfs_remove(struct kernfs_node *kn);\nvoid kernfs_break_active_protection(struct kernfs_node *kn);\nvoid kernfs_unbreak_active_protection(struct kernfs_node *kn);\nbool kernfs_remove_self(struct kernfs_node *kn);\nint kernfs_remove_by_name_ns(struct kernfs_node *parent, const char *name,\n\t\t\t     const void *ns);\nint kernfs_rename_ns(struct kernfs_node *kn, struct kernfs_node *new_parent,\n\t\t     const char *new_name, const void *new_ns);\nint kernfs_setattr(struct kernfs_node *kn, const struct iattr *iattr);\n__poll_t kernfs_generic_poll(struct kernfs_open_file *of,\n\t\t\t     struct poll_table_struct *pt);\nvoid kernfs_notify(struct kernfs_node *kn);\n\nint kernfs_xattr_get(struct kernfs_node *kn, const char *name,\n\t\t     void *value, size_t size);\nint kernfs_xattr_set(struct kernfs_node *kn, const char *name,\n\t\t     const void *value, size_t size, int flags);\n\nconst void *kernfs_super_ns(struct super_block *sb);\nint kernfs_get_tree(struct fs_context *fc);\nvoid kernfs_free_fs_context(struct fs_context *fc);\nvoid kernfs_kill_sb(struct super_block *sb);\n\nvoid kernfs_init(void);\n\nstruct kernfs_node *kernfs_find_and_get_node_by_id(struct kernfs_root *root,\n\t\t\t\t\t\t   u64 id);\n#else\t \n\nstatic inline enum kernfs_node_type kernfs_type(struct kernfs_node *kn)\n{ return 0; }\t \n\nstatic inline void kernfs_enable_ns(struct kernfs_node *kn) { }\n\nstatic inline bool kernfs_ns_enabled(struct kernfs_node *kn)\n{ return false; }\n\nstatic inline int kernfs_name(struct kernfs_node *kn, char *buf, size_t buflen)\n{ return -ENOSYS; }\n\nstatic inline int kernfs_path_from_node(struct kernfs_node *root_kn,\n\t\t\t\t\tstruct kernfs_node *kn,\n\t\t\t\t\tchar *buf, size_t buflen)\n{ return -ENOSYS; }\n\nstatic inline void pr_cont_kernfs_name(struct kernfs_node *kn) { }\nstatic inline void pr_cont_kernfs_path(struct kernfs_node *kn) { }\n\nstatic inline struct kernfs_node *kernfs_get_parent(struct kernfs_node *kn)\n{ return NULL; }\n\nstatic inline struct kernfs_node *\nkernfs_find_and_get_ns(struct kernfs_node *parent, const char *name,\n\t\t       const void *ns)\n{ return NULL; }\nstatic inline struct kernfs_node *\nkernfs_walk_and_get_ns(struct kernfs_node *parent, const char *path,\n\t\t       const void *ns)\n{ return NULL; }\n\nstatic inline void kernfs_get(struct kernfs_node *kn) { }\nstatic inline void kernfs_put(struct kernfs_node *kn) { }\n\nstatic inline struct kernfs_node *kernfs_node_from_dentry(struct dentry *dentry)\n{ return NULL; }\n\nstatic inline struct kernfs_root *kernfs_root_from_sb(struct super_block *sb)\n{ return NULL; }\n\nstatic inline struct inode *\nkernfs_get_inode(struct super_block *sb, struct kernfs_node *kn)\n{ return NULL; }\n\nstatic inline struct kernfs_root *\nkernfs_create_root(struct kernfs_syscall_ops *scops, unsigned int flags,\n\t\t   void *priv)\n{ return ERR_PTR(-ENOSYS); }\n\nstatic inline void kernfs_destroy_root(struct kernfs_root *root) { }\n\nstatic inline struct kernfs_node *\nkernfs_create_dir_ns(struct kernfs_node *parent, const char *name,\n\t\t     umode_t mode, kuid_t uid, kgid_t gid,\n\t\t     void *priv, const void *ns)\n{ return ERR_PTR(-ENOSYS); }\n\nstatic inline struct kernfs_node *\n__kernfs_create_file(struct kernfs_node *parent, const char *name,\n\t\t     umode_t mode, kuid_t uid, kgid_t gid,\n\t\t     loff_t size, const struct kernfs_ops *ops,\n\t\t     void *priv, const void *ns, struct lock_class_key *key)\n{ return ERR_PTR(-ENOSYS); }\n\nstatic inline struct kernfs_node *\nkernfs_create_link(struct kernfs_node *parent, const char *name,\n\t\t   struct kernfs_node *target)\n{ return ERR_PTR(-ENOSYS); }\n\nstatic inline void kernfs_activate(struct kernfs_node *kn) { }\n\nstatic inline void kernfs_remove(struct kernfs_node *kn) { }\n\nstatic inline bool kernfs_remove_self(struct kernfs_node *kn)\n{ return false; }\n\nstatic inline int kernfs_remove_by_name_ns(struct kernfs_node *kn,\n\t\t\t\t\t   const char *name, const void *ns)\n{ return -ENOSYS; }\n\nstatic inline int kernfs_rename_ns(struct kernfs_node *kn,\n\t\t\t\t   struct kernfs_node *new_parent,\n\t\t\t\t   const char *new_name, const void *new_ns)\n{ return -ENOSYS; }\n\nstatic inline int kernfs_setattr(struct kernfs_node *kn,\n\t\t\t\t const struct iattr *iattr)\n{ return -ENOSYS; }\n\nstatic inline __poll_t kernfs_generic_poll(struct kernfs_open_file *of,\n\t\t\t\t\t   struct poll_table_struct *pt)\n{ return -ENOSYS; }\n\nstatic inline void kernfs_notify(struct kernfs_node *kn) { }\n\nstatic inline int kernfs_xattr_get(struct kernfs_node *kn, const char *name,\n\t\t\t\t   void *value, size_t size)\n{ return -ENOSYS; }\n\nstatic inline int kernfs_xattr_set(struct kernfs_node *kn, const char *name,\n\t\t\t\t   const void *value, size_t size, int flags)\n{ return -ENOSYS; }\n\nstatic inline const void *kernfs_super_ns(struct super_block *sb)\n{ return NULL; }\n\nstatic inline int kernfs_get_tree(struct fs_context *fc)\n{ return -ENOSYS; }\n\nstatic inline void kernfs_free_fs_context(struct fs_context *fc) { }\n\nstatic inline void kernfs_kill_sb(struct super_block *sb) { }\n\nstatic inline void kernfs_init(void) { }\n\n#endif\t \n\n \nstatic inline int kernfs_path(struct kernfs_node *kn, char *buf, size_t buflen)\n{\n\treturn kernfs_path_from_node(kn, NULL, buf, buflen);\n}\n\nstatic inline struct kernfs_node *\nkernfs_find_and_get(struct kernfs_node *kn, const char *name)\n{\n\treturn kernfs_find_and_get_ns(kn, name, NULL);\n}\n\nstatic inline struct kernfs_node *\nkernfs_walk_and_get(struct kernfs_node *kn, const char *path)\n{\n\treturn kernfs_walk_and_get_ns(kn, path, NULL);\n}\n\nstatic inline struct kernfs_node *\nkernfs_create_dir(struct kernfs_node *parent, const char *name, umode_t mode,\n\t\t  void *priv)\n{\n\treturn kernfs_create_dir_ns(parent, name, mode,\n\t\t\t\t    GLOBAL_ROOT_UID, GLOBAL_ROOT_GID,\n\t\t\t\t    priv, NULL);\n}\n\nstatic inline int kernfs_remove_by_name(struct kernfs_node *parent,\n\t\t\t\t\tconst char *name)\n{\n\treturn kernfs_remove_by_name_ns(parent, name, NULL);\n}\n\nstatic inline int kernfs_rename(struct kernfs_node *kn,\n\t\t\t\tstruct kernfs_node *new_parent,\n\t\t\t\tconst char *new_name)\n{\n\treturn kernfs_rename_ns(kn, new_parent, new_name, NULL);\n}\n\n#endif\t \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}