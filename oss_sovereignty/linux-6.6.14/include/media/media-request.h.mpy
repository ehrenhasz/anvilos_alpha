{
  "module_name": "media-request.h",
  "hash_id": "f80ef9c37b5f22c6410470290c2a1afe2426d1d1482f23c0b2d34517c5cf620d",
  "original_prompt": "Ingested from linux-6.6.14/include/media/media-request.h",
  "human_readable_source": "\n \n\n#ifndef MEDIA_REQUEST_H\n#define MEDIA_REQUEST_H\n\n#include <linux/list.h>\n#include <linux/slab.h>\n#include <linux/spinlock.h>\n#include <linux/refcount.h>\n\n#include <media/media-device.h>\n\n \nenum media_request_state {\n\tMEDIA_REQUEST_STATE_IDLE,\n\tMEDIA_REQUEST_STATE_VALIDATING,\n\tMEDIA_REQUEST_STATE_QUEUED,\n\tMEDIA_REQUEST_STATE_COMPLETE,\n\tMEDIA_REQUEST_STATE_CLEANING,\n\tMEDIA_REQUEST_STATE_UPDATING,\n\tNR_OF_MEDIA_REQUEST_STATE,\n};\n\nstruct media_request_object;\n\n \nstruct media_request {\n\tstruct media_device *mdev;\n\tstruct kref kref;\n\tchar debug_str[TASK_COMM_LEN + 11];\n\tenum media_request_state state;\n\tunsigned int updating_count;\n\tunsigned int access_count;\n\tstruct list_head objects;\n\tunsigned int num_incomplete_objects;\n\twait_queue_head_t poll_wait;\n\tspinlock_t lock;\n};\n\n#ifdef CONFIG_MEDIA_CONTROLLER\n\n \nstatic inline int __must_check\nmedia_request_lock_for_access(struct media_request *req)\n{\n\tunsigned long flags;\n\tint ret = -EBUSY;\n\n\tspin_lock_irqsave(&req->lock, flags);\n\tif (req->state == MEDIA_REQUEST_STATE_COMPLETE) {\n\t\treq->access_count++;\n\t\tret = 0;\n\t}\n\tspin_unlock_irqrestore(&req->lock, flags);\n\n\treturn ret;\n}\n\n \nstatic inline void media_request_unlock_for_access(struct media_request *req)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&req->lock, flags);\n\tif (!WARN_ON(!req->access_count))\n\t\treq->access_count--;\n\tspin_unlock_irqrestore(&req->lock, flags);\n}\n\n \nstatic inline int __must_check\nmedia_request_lock_for_update(struct media_request *req)\n{\n\tunsigned long flags;\n\tint ret = 0;\n\n\tspin_lock_irqsave(&req->lock, flags);\n\tif (req->state == MEDIA_REQUEST_STATE_IDLE ||\n\t    req->state == MEDIA_REQUEST_STATE_UPDATING) {\n\t\treq->state = MEDIA_REQUEST_STATE_UPDATING;\n\t\treq->updating_count++;\n\t} else {\n\t\tret = -EBUSY;\n\t}\n\tspin_unlock_irqrestore(&req->lock, flags);\n\n\treturn ret;\n}\n\n \nstatic inline void media_request_unlock_for_update(struct media_request *req)\n{\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&req->lock, flags);\n\tWARN_ON(req->updating_count <= 0);\n\tif (!--req->updating_count)\n\t\treq->state = MEDIA_REQUEST_STATE_IDLE;\n\tspin_unlock_irqrestore(&req->lock, flags);\n}\n\n \nstatic inline void media_request_get(struct media_request *req)\n{\n\tkref_get(&req->kref);\n}\n\n \nvoid media_request_put(struct media_request *req);\n\n \nstruct media_request *\nmedia_request_get_by_fd(struct media_device *mdev, int request_fd);\n\n \nint media_request_alloc(struct media_device *mdev,\n\t\t\tint *alloc_fd);\n\n#else\n\nstatic inline void media_request_get(struct media_request *req)\n{\n}\n\nstatic inline void media_request_put(struct media_request *req)\n{\n}\n\nstatic inline struct media_request *\nmedia_request_get_by_fd(struct media_device *mdev, int request_fd)\n{\n\treturn ERR_PTR(-EBADR);\n}\n\n#endif\n\n \nstruct media_request_object_ops {\n\tint (*prepare)(struct media_request_object *object);\n\tvoid (*unprepare)(struct media_request_object *object);\n\tvoid (*queue)(struct media_request_object *object);\n\tvoid (*unbind)(struct media_request_object *object);\n\tvoid (*release)(struct media_request_object *object);\n};\n\n \nstruct media_request_object {\n\tconst struct media_request_object_ops *ops;\n\tvoid *priv;\n\tstruct media_request *req;\n\tstruct list_head list;\n\tstruct kref kref;\n\tbool completed;\n};\n\n#ifdef CONFIG_MEDIA_CONTROLLER\n\n \nstatic inline void media_request_object_get(struct media_request_object *obj)\n{\n\tkref_get(&obj->kref);\n}\n\n \nvoid media_request_object_put(struct media_request_object *obj);\n\n \nstruct media_request_object *\nmedia_request_object_find(struct media_request *req,\n\t\t\t  const struct media_request_object_ops *ops,\n\t\t\t  void *priv);\n\n \nvoid media_request_object_init(struct media_request_object *obj);\n\n \nint media_request_object_bind(struct media_request *req,\n\t\t\t      const struct media_request_object_ops *ops,\n\t\t\t      void *priv, bool is_buffer,\n\t\t\t      struct media_request_object *obj);\n\n \nvoid media_request_object_unbind(struct media_request_object *obj);\n\n \nvoid media_request_object_complete(struct media_request_object *obj);\n\n#else\n\nstatic inline int __must_check\nmedia_request_lock_for_access(struct media_request *req)\n{\n\treturn -EINVAL;\n}\n\nstatic inline void media_request_unlock_for_access(struct media_request *req)\n{\n}\n\nstatic inline int __must_check\nmedia_request_lock_for_update(struct media_request *req)\n{\n\treturn -EINVAL;\n}\n\nstatic inline void media_request_unlock_for_update(struct media_request *req)\n{\n}\n\nstatic inline void media_request_object_get(struct media_request_object *obj)\n{\n}\n\nstatic inline void media_request_object_put(struct media_request_object *obj)\n{\n}\n\nstatic inline struct media_request_object *\nmedia_request_object_find(struct media_request *req,\n\t\t\t  const struct media_request_object_ops *ops,\n\t\t\t  void *priv)\n{\n\treturn NULL;\n}\n\nstatic inline void media_request_object_init(struct media_request_object *obj)\n{\n\tobj->ops = NULL;\n\tobj->req = NULL;\n}\n\nstatic inline int media_request_object_bind(struct media_request *req,\n\t\t\t       const struct media_request_object_ops *ops,\n\t\t\t       void *priv, bool is_buffer,\n\t\t\t       struct media_request_object *obj)\n{\n\treturn 0;\n}\n\nstatic inline void media_request_object_unbind(struct media_request_object *obj)\n{\n}\n\nstatic inline void media_request_object_complete(struct media_request_object *obj)\n{\n}\n\n#endif\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}