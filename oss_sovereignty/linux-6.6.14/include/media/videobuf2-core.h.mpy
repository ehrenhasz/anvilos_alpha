{
  "module_name": "videobuf2-core.h",
  "hash_id": "53a09383a6684f4210e53324993df52b2ec92dbd6fe47cbaa39ab9f25d8d04a3",
  "original_prompt": "Ingested from linux-6.6.14/include/media/videobuf2-core.h",
  "human_readable_source": " \n#ifndef _MEDIA_VIDEOBUF2_CORE_H\n#define _MEDIA_VIDEOBUF2_CORE_H\n\n#include <linux/mm_types.h>\n#include <linux/mutex.h>\n#include <linux/poll.h>\n#include <linux/dma-buf.h>\n#include <linux/bitops.h>\n#include <media/media-request.h>\n#include <media/frame_vector.h>\n\n#define VB2_MAX_FRAME\t(32)\n#define VB2_MAX_PLANES\t(8)\n\n \nenum vb2_memory {\n\tVB2_MEMORY_UNKNOWN\t= 0,\n\tVB2_MEMORY_MMAP\t\t= 1,\n\tVB2_MEMORY_USERPTR\t= 2,\n\tVB2_MEMORY_DMABUF\t= 4,\n};\n\nstruct vb2_fileio_data;\nstruct vb2_threadio_data;\nstruct vb2_buffer;\n\n \nstruct vb2_mem_ops {\n\tvoid\t\t*(*alloc)(struct vb2_buffer *vb,\n\t\t\t\t  struct device *dev,\n\t\t\t\t  unsigned long size);\n\tvoid\t\t(*put)(void *buf_priv);\n\tstruct dma_buf *(*get_dmabuf)(struct vb2_buffer *vb,\n\t\t\t\t      void *buf_priv,\n\t\t\t\t      unsigned long flags);\n\n\tvoid\t\t*(*get_userptr)(struct vb2_buffer *vb,\n\t\t\t\t\tstruct device *dev,\n\t\t\t\t\tunsigned long vaddr,\n\t\t\t\t\tunsigned long size);\n\tvoid\t\t(*put_userptr)(void *buf_priv);\n\n\tvoid\t\t(*prepare)(void *buf_priv);\n\tvoid\t\t(*finish)(void *buf_priv);\n\n\tvoid\t\t*(*attach_dmabuf)(struct vb2_buffer *vb,\n\t\t\t\t\t  struct device *dev,\n\t\t\t\t\t  struct dma_buf *dbuf,\n\t\t\t\t\t  unsigned long size);\n\tvoid\t\t(*detach_dmabuf)(void *buf_priv);\n\tint\t\t(*map_dmabuf)(void *buf_priv);\n\tvoid\t\t(*unmap_dmabuf)(void *buf_priv);\n\n\tvoid\t\t*(*vaddr)(struct vb2_buffer *vb, void *buf_priv);\n\tvoid\t\t*(*cookie)(struct vb2_buffer *vb, void *buf_priv);\n\n\tunsigned int\t(*num_users)(void *buf_priv);\n\n\tint\t\t(*mmap)(void *buf_priv, struct vm_area_struct *vma);\n};\n\n \nstruct vb2_plane {\n\tvoid\t\t\t*mem_priv;\n\tstruct dma_buf\t\t*dbuf;\n\tunsigned int\t\tdbuf_mapped;\n\tunsigned int\t\tbytesused;\n\tunsigned int\t\tlength;\n\tunsigned int\t\tmin_length;\n\tunion {\n\t\tunsigned int\toffset;\n\t\tunsigned long\tuserptr;\n\t\tint\t\tfd;\n\t} m;\n\tunsigned int\t\tdata_offset;\n};\n\n \nenum vb2_io_modes {\n\tVB2_MMAP\t= BIT(0),\n\tVB2_USERPTR\t= BIT(1),\n\tVB2_READ\t= BIT(2),\n\tVB2_WRITE\t= BIT(3),\n\tVB2_DMABUF\t= BIT(4),\n};\n\n \nenum vb2_buffer_state {\n\tVB2_BUF_STATE_DEQUEUED,\n\tVB2_BUF_STATE_IN_REQUEST,\n\tVB2_BUF_STATE_PREPARING,\n\tVB2_BUF_STATE_QUEUED,\n\tVB2_BUF_STATE_ACTIVE,\n\tVB2_BUF_STATE_DONE,\n\tVB2_BUF_STATE_ERROR,\n};\n\nstruct vb2_queue;\n\n \nstruct vb2_buffer {\n\tstruct vb2_queue\t*vb2_queue;\n\tunsigned int\t\tindex;\n\tunsigned int\t\ttype;\n\tunsigned int\t\tmemory;\n\tunsigned int\t\tnum_planes;\n\tu64\t\t\ttimestamp;\n\tstruct media_request\t*request;\n\tstruct media_request_object\treq_obj;\n\n\t \n\tenum vb2_buffer_state\tstate;\n\tunsigned int\t\tsynced:1;\n\tunsigned int\t\tprepared:1;\n\tunsigned int\t\tcopied_timestamp:1;\n\tunsigned int\t\tskip_cache_sync_on_prepare:1;\n\tunsigned int\t\tskip_cache_sync_on_finish:1;\n\n\tstruct vb2_plane\tplanes[VB2_MAX_PLANES];\n\tstruct list_head\tqueued_entry;\n\tstruct list_head\tdone_entry;\n#ifdef CONFIG_VIDEO_ADV_DEBUG\n\t \n\tu32\t\tcnt_mem_alloc;\n\tu32\t\tcnt_mem_put;\n\tu32\t\tcnt_mem_get_dmabuf;\n\tu32\t\tcnt_mem_get_userptr;\n\tu32\t\tcnt_mem_put_userptr;\n\tu32\t\tcnt_mem_prepare;\n\tu32\t\tcnt_mem_finish;\n\tu32\t\tcnt_mem_attach_dmabuf;\n\tu32\t\tcnt_mem_detach_dmabuf;\n\tu32\t\tcnt_mem_map_dmabuf;\n\tu32\t\tcnt_mem_unmap_dmabuf;\n\tu32\t\tcnt_mem_vaddr;\n\tu32\t\tcnt_mem_cookie;\n\tu32\t\tcnt_mem_num_users;\n\tu32\t\tcnt_mem_mmap;\n\n\tu32\t\tcnt_buf_out_validate;\n\tu32\t\tcnt_buf_init;\n\tu32\t\tcnt_buf_prepare;\n\tu32\t\tcnt_buf_finish;\n\tu32\t\tcnt_buf_cleanup;\n\tu32\t\tcnt_buf_queue;\n\tu32\t\tcnt_buf_request_complete;\n\n\t \n\tu32\t\tcnt_buf_done;\n#endif\n};\n\n \nstruct vb2_ops {\n\tint (*queue_setup)(struct vb2_queue *q,\n\t\t\t   unsigned int *num_buffers, unsigned int *num_planes,\n\t\t\t   unsigned int sizes[], struct device *alloc_devs[]);\n\n\tvoid (*wait_prepare)(struct vb2_queue *q);\n\tvoid (*wait_finish)(struct vb2_queue *q);\n\n\tint (*buf_out_validate)(struct vb2_buffer *vb);\n\tint (*buf_init)(struct vb2_buffer *vb);\n\tint (*buf_prepare)(struct vb2_buffer *vb);\n\tvoid (*buf_finish)(struct vb2_buffer *vb);\n\tvoid (*buf_cleanup)(struct vb2_buffer *vb);\n\n\tint (*prepare_streaming)(struct vb2_queue *q);\n\tint (*start_streaming)(struct vb2_queue *q, unsigned int count);\n\tvoid (*stop_streaming)(struct vb2_queue *q);\n\tvoid (*unprepare_streaming)(struct vb2_queue *q);\n\n\tvoid (*buf_queue)(struct vb2_buffer *vb);\n\n\tvoid (*buf_request_complete)(struct vb2_buffer *vb);\n};\n\n \nstruct vb2_buf_ops {\n\tint (*verify_planes_array)(struct vb2_buffer *vb, const void *pb);\n\tvoid (*init_buffer)(struct vb2_buffer *vb);\n\tvoid (*fill_user_buffer)(struct vb2_buffer *vb, void *pb);\n\tint (*fill_vb2_buffer)(struct vb2_buffer *vb, struct vb2_plane *planes);\n\tvoid (*copy_timestamp)(struct vb2_buffer *vb, const void *pb);\n};\n\n \n \nstruct vb2_queue {\n\tunsigned int\t\t\ttype;\n\tunsigned int\t\t\tio_modes;\n\tstruct device\t\t\t*dev;\n\tunsigned long\t\t\tdma_attrs;\n\tunsigned int\t\t\tbidirectional:1;\n\tunsigned int\t\t\tfileio_read_once:1;\n\tunsigned int\t\t\tfileio_write_immediately:1;\n\tunsigned int\t\t\tallow_zero_bytesused:1;\n\tunsigned int\t\t   quirk_poll_must_check_waiting_for_buffers:1;\n\tunsigned int\t\t\tsupports_requests:1;\n\tunsigned int\t\t\trequires_requests:1;\n\tunsigned int\t\t\tuses_qbuf:1;\n\tunsigned int\t\t\tuses_requests:1;\n\tunsigned int\t\t\tallow_cache_hints:1;\n\tunsigned int\t\t\tnon_coherent_mem:1;\n\n\tstruct mutex\t\t\t*lock;\n\tvoid\t\t\t\t*owner;\n\n\tconst struct vb2_ops\t\t*ops;\n\tconst struct vb2_mem_ops\t*mem_ops;\n\tconst struct vb2_buf_ops\t*buf_ops;\n\n\tvoid\t\t\t\t*drv_priv;\n\tu32\t\t\t\tsubsystem_flags;\n\tunsigned int\t\t\tbuf_struct_size;\n\tu32\t\t\t\ttimestamp_flags;\n\tgfp_t\t\t\t\tgfp_flags;\n\tu32\t\t\t\tmin_buffers_needed;\n\n\tstruct device\t\t\t*alloc_devs[VB2_MAX_PLANES];\n\n\t \n\tstruct mutex\t\t\tmmap_lock;\n\tunsigned int\t\t\tmemory;\n\tenum dma_data_direction\t\tdma_dir;\n\tstruct vb2_buffer\t\t*bufs[VB2_MAX_FRAME];\n\tunsigned int\t\t\tnum_buffers;\n\n\tstruct list_head\t\tqueued_list;\n\tunsigned int\t\t\tqueued_count;\n\n\tatomic_t\t\t\towned_by_drv_count;\n\tstruct list_head\t\tdone_list;\n\tspinlock_t\t\t\tdone_lock;\n\twait_queue_head_t\t\tdone_wq;\n\n\tunsigned int\t\t\tstreaming:1;\n\tunsigned int\t\t\tstart_streaming_called:1;\n\tunsigned int\t\t\terror:1;\n\tunsigned int\t\t\twaiting_for_buffers:1;\n\tunsigned int\t\t\twaiting_in_dqbuf:1;\n\tunsigned int\t\t\tis_multiplanar:1;\n\tunsigned int\t\t\tis_output:1;\n\tunsigned int\t\t\tcopy_timestamp:1;\n\tunsigned int\t\t\tlast_buffer_dequeued:1;\n\n\tstruct vb2_fileio_data\t\t*fileio;\n\tstruct vb2_threadio_data\t*threadio;\n\n\tchar\t\t\t\tname[32];\n\n#ifdef CONFIG_VIDEO_ADV_DEBUG\n\t \n\tu32\t\t\t\tcnt_queue_setup;\n\tu32\t\t\t\tcnt_wait_prepare;\n\tu32\t\t\t\tcnt_wait_finish;\n\tu32\t\t\t\tcnt_prepare_streaming;\n\tu32\t\t\t\tcnt_start_streaming;\n\tu32\t\t\t\tcnt_stop_streaming;\n\tu32\t\t\t\tcnt_unprepare_streaming;\n#endif\n};\n\n \nstatic inline bool vb2_queue_allows_cache_hints(struct vb2_queue *q)\n{\n\treturn q->allow_cache_hints && q->memory == VB2_MEMORY_MMAP;\n}\n\n \nvoid *vb2_plane_vaddr(struct vb2_buffer *vb, unsigned int plane_no);\n\n \nvoid *vb2_plane_cookie(struct vb2_buffer *vb, unsigned int plane_no);\n\n \nvoid vb2_buffer_done(struct vb2_buffer *vb, enum vb2_buffer_state state);\n\n \nvoid vb2_discard_done(struct vb2_queue *q);\n\n \nint vb2_wait_for_all_buffers(struct vb2_queue *q);\n\n \nvoid vb2_core_querybuf(struct vb2_queue *q, unsigned int index, void *pb);\n\n \nint vb2_core_reqbufs(struct vb2_queue *q, enum vb2_memory memory,\n\t\t     unsigned int flags, unsigned int *count);\n\n \nint vb2_core_create_bufs(struct vb2_queue *q, enum vb2_memory memory,\n\t\t\t unsigned int flags, unsigned int *count,\n\t\t\t unsigned int requested_planes,\n\t\t\t const unsigned int requested_sizes[]);\n\n \nint vb2_core_prepare_buf(struct vb2_queue *q, unsigned int index, void *pb);\n\n \nint vb2_core_qbuf(struct vb2_queue *q, unsigned int index, void *pb,\n\t\t  struct media_request *req);\n\n \nint vb2_core_dqbuf(struct vb2_queue *q, unsigned int *pindex, void *pb,\n\t\t   bool nonblocking);\n\n \nint vb2_core_streamon(struct vb2_queue *q, unsigned int type);\n\n \nint vb2_core_streamoff(struct vb2_queue *q, unsigned int type);\n\n \nint vb2_core_expbuf(struct vb2_queue *q, int *fd, unsigned int type,\n\t\tunsigned int index, unsigned int plane, unsigned int flags);\n\n \nint vb2_core_queue_init(struct vb2_queue *q);\n\n \nvoid vb2_core_queue_release(struct vb2_queue *q);\n\n \nvoid vb2_queue_error(struct vb2_queue *q);\n\n \nint vb2_mmap(struct vb2_queue *q, struct vm_area_struct *vma);\n\n#ifndef CONFIG_MMU\n \nunsigned long vb2_get_unmapped_area(struct vb2_queue *q,\n\t\t\t\t    unsigned long addr,\n\t\t\t\t    unsigned long len,\n\t\t\t\t    unsigned long pgoff,\n\t\t\t\t    unsigned long flags);\n#endif\n\n \n__poll_t vb2_core_poll(struct vb2_queue *q, struct file *file,\n\t\t\t   poll_table *wait);\n\n \nsize_t vb2_read(struct vb2_queue *q, char __user *data, size_t count,\n\t\tloff_t *ppos, int nonblock);\n \nsize_t vb2_write(struct vb2_queue *q, const char __user *data, size_t count,\n\t\tloff_t *ppos, int nonblock);\n\n \ntypedef int (*vb2_thread_fnc)(struct vb2_buffer *vb, void *priv);\n\n \nint vb2_thread_start(struct vb2_queue *q, vb2_thread_fnc fnc, void *priv,\n\t\t     const char *thread_name);\n\n \nint vb2_thread_stop(struct vb2_queue *q);\n\n \nstatic inline bool vb2_is_streaming(struct vb2_queue *q)\n{\n\treturn q->streaming;\n}\n\n \nstatic inline bool vb2_fileio_is_active(struct vb2_queue *q)\n{\n\treturn q->fileio;\n}\n\n \nstatic inline bool vb2_is_busy(struct vb2_queue *q)\n{\n\treturn (q->num_buffers > 0);\n}\n\n \nstatic inline void *vb2_get_drv_priv(struct vb2_queue *q)\n{\n\treturn q->drv_priv;\n}\n\n \nstatic inline void vb2_set_plane_payload(struct vb2_buffer *vb,\n\t\t\t\t unsigned int plane_no, unsigned long size)\n{\n\t \n\tif (plane_no < vb->num_planes) {\n\t\tif (WARN_ON_ONCE(size > vb->planes[plane_no].length))\n\t\t\tsize = vb->planes[plane_no].length;\n\t\tvb->planes[plane_no].bytesused = size;\n\t}\n}\n\n \nstatic inline unsigned long vb2_get_plane_payload(struct vb2_buffer *vb,\n\t\t\t\t unsigned int plane_no)\n{\n\tif (plane_no < vb->num_planes)\n\t\treturn vb->planes[plane_no].bytesused;\n\treturn 0;\n}\n\n \nstatic inline unsigned long\nvb2_plane_size(struct vb2_buffer *vb, unsigned int plane_no)\n{\n\tif (plane_no < vb->num_planes)\n\t\treturn vb->planes[plane_no].length;\n\treturn 0;\n}\n\n \nstatic inline bool vb2_start_streaming_called(struct vb2_queue *q)\n{\n\treturn q->start_streaming_called;\n}\n\n \nstatic inline void vb2_clear_last_buffer_dequeued(struct vb2_queue *q)\n{\n\tq->last_buffer_dequeued = false;\n}\n\n \nstatic inline struct vb2_buffer *vb2_get_buffer(struct vb2_queue *q,\n\t\t\t\t\t\tunsigned int index)\n{\n\tif (index < q->num_buffers)\n\t\treturn q->bufs[index];\n\treturn NULL;\n}\n\n \n\n \nbool vb2_buffer_in_use(struct vb2_queue *q, struct vb2_buffer *vb);\n\n \nint vb2_verify_memory_type(struct vb2_queue *q,\n\t\tenum vb2_memory memory, unsigned int type);\n\n \nbool vb2_request_object_is_buffer(struct media_request_object *obj);\n\n \nunsigned int vb2_request_buffer_cnt(struct media_request *req);\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}