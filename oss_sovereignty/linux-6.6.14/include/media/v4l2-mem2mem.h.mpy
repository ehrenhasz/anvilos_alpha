{
  "module_name": "v4l2-mem2mem.h",
  "hash_id": "c5a6567916ed169a16ae8d0a3102dd04f3e72bfa0c4c0f00416dab8444ed206f",
  "original_prompt": "Ingested from linux-6.6.14/include/media/v4l2-mem2mem.h",
  "human_readable_source": " \n \n\n#ifndef _MEDIA_V4L2_MEM2MEM_H\n#define _MEDIA_V4L2_MEM2MEM_H\n\n#include <media/videobuf2-v4l2.h>\n\n \nstruct v4l2_m2m_ops {\n\tvoid (*device_run)(void *priv);\n\tint (*job_ready)(void *priv);\n\tvoid (*job_abort)(void *priv);\n};\n\nstruct video_device;\nstruct v4l2_m2m_dev;\n\n \n\nstruct v4l2_m2m_queue_ctx {\n\tstruct vb2_queue\tq;\n\n\tstruct list_head\trdy_queue;\n\tspinlock_t\t\trdy_spinlock;\n\tu8\t\t\tnum_rdy;\n\tbool\t\t\tbuffered;\n};\n\n \nstruct v4l2_m2m_ctx {\n\t \n\tstruct mutex\t\t\t*q_lock;\n\n\tbool\t\t\t\tnew_frame;\n\n\tbool\t\t\t\tis_draining;\n\tstruct vb2_v4l2_buffer\t\t*last_src_buf;\n\tbool\t\t\t\tnext_buf_last;\n\tbool\t\t\t\thas_stopped;\n\n\t \n\tstruct v4l2_m2m_dev\t\t*m2m_dev;\n\n\tstruct v4l2_m2m_queue_ctx\tcap_q_ctx;\n\n\tstruct v4l2_m2m_queue_ctx\tout_q_ctx;\n\n\t \n\tstruct list_head\t\tqueue;\n\tunsigned long\t\t\tjob_flags;\n\twait_queue_head_t\t\tfinished;\n\n\tvoid\t\t\t\t*priv;\n};\n\n \nstruct v4l2_m2m_buffer {\n\tstruct vb2_v4l2_buffer\tvb;\n\tstruct list_head\tlist;\n};\n\n \nvoid *v4l2_m2m_get_curr_priv(struct v4l2_m2m_dev *m2m_dev);\n\n \nstruct vb2_queue *v4l2_m2m_get_vq(struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t\t       enum v4l2_buf_type type);\n\n \nvoid v4l2_m2m_try_schedule(struct v4l2_m2m_ctx *m2m_ctx);\n\n \nvoid v4l2_m2m_job_finish(struct v4l2_m2m_dev *m2m_dev,\n\t\t\t struct v4l2_m2m_ctx *m2m_ctx);\n\n \nvoid v4l2_m2m_buf_done_and_job_finish(struct v4l2_m2m_dev *m2m_dev,\n\t\t\t\t      struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t\t      enum vb2_buffer_state state);\n\nstatic inline void\nv4l2_m2m_buf_done(struct vb2_v4l2_buffer *buf, enum vb2_buffer_state state)\n{\n\tvb2_buffer_done(&buf->vb2_buf, state);\n}\n\n \nstatic inline void\nv4l2_m2m_clear_state(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\tm2m_ctx->next_buf_last = false;\n\tm2m_ctx->is_draining = false;\n\tm2m_ctx->has_stopped = false;\n}\n\n \nstatic inline void\nv4l2_m2m_mark_stopped(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\tm2m_ctx->next_buf_last = false;\n\tm2m_ctx->is_draining = false;\n\tm2m_ctx->has_stopped = true;\n}\n\n \nstatic inline bool\nv4l2_m2m_dst_buf_is_last(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\treturn m2m_ctx->is_draining && m2m_ctx->next_buf_last;\n}\n\n \nstatic inline bool\nv4l2_m2m_has_stopped(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\treturn m2m_ctx->has_stopped;\n}\n\n \nstatic inline bool\nv4l2_m2m_is_last_draining_src_buf(struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t\t  struct vb2_v4l2_buffer *vbuf)\n{\n\treturn m2m_ctx->is_draining && vbuf == m2m_ctx->last_src_buf;\n}\n\n \nvoid v4l2_m2m_last_buffer_done(struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t       struct vb2_v4l2_buffer *vbuf);\n\n \nvoid v4l2_m2m_suspend(struct v4l2_m2m_dev *m2m_dev);\n\n \nvoid v4l2_m2m_resume(struct v4l2_m2m_dev *m2m_dev);\n\n \nint v4l2_m2m_reqbufs(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t     struct v4l2_requestbuffers *reqbufs);\n\n \nint v4l2_m2m_querybuf(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t      struct v4l2_buffer *buf);\n\n \nint v4l2_m2m_qbuf(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t  struct v4l2_buffer *buf);\n\n \nint v4l2_m2m_dqbuf(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t   struct v4l2_buffer *buf);\n\n \nint v4l2_m2m_prepare_buf(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t struct v4l2_buffer *buf);\n\n \nint v4l2_m2m_create_bufs(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t struct v4l2_create_buffers *create);\n\n \nint v4l2_m2m_expbuf(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t   struct v4l2_exportbuffer *eb);\n\n \nint v4l2_m2m_streamon(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t      enum v4l2_buf_type type);\n\n \nint v4l2_m2m_streamoff(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t       enum v4l2_buf_type type);\n\n \nvoid v4l2_m2m_update_start_streaming_state(struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t\t\t   struct vb2_queue *q);\n\n \nvoid v4l2_m2m_update_stop_streaming_state(struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t\t\t  struct vb2_queue *q);\n\n \nint v4l2_m2m_encoder_cmd(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t struct v4l2_encoder_cmd *ec);\n\n \nint v4l2_m2m_decoder_cmd(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t struct v4l2_decoder_cmd *dc);\n\n \n__poll_t v4l2_m2m_poll(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t   struct poll_table_struct *wait);\n\n \nint v4l2_m2m_mmap(struct file *file, struct v4l2_m2m_ctx *m2m_ctx,\n\t\t  struct vm_area_struct *vma);\n\n#ifndef CONFIG_MMU\nunsigned long v4l2_m2m_get_unmapped_area(struct file *file, unsigned long addr,\n\t\t\t\t\t unsigned long len, unsigned long pgoff,\n\t\t\t\t\t unsigned long flags);\n#endif\n \nstruct v4l2_m2m_dev *v4l2_m2m_init(const struct v4l2_m2m_ops *m2m_ops);\n\n#if defined(CONFIG_MEDIA_CONTROLLER)\nvoid v4l2_m2m_unregister_media_controller(struct v4l2_m2m_dev *m2m_dev);\nint v4l2_m2m_register_media_controller(struct v4l2_m2m_dev *m2m_dev,\n\t\t\tstruct video_device *vdev, int function);\n#else\nstatic inline void\nv4l2_m2m_unregister_media_controller(struct v4l2_m2m_dev *m2m_dev)\n{\n}\n\nstatic inline int\nv4l2_m2m_register_media_controller(struct v4l2_m2m_dev *m2m_dev,\n\t\tstruct video_device *vdev, int function)\n{\n\treturn 0;\n}\n#endif\n\n \nvoid v4l2_m2m_release(struct v4l2_m2m_dev *m2m_dev);\n\n \nstruct v4l2_m2m_ctx *v4l2_m2m_ctx_init(struct v4l2_m2m_dev *m2m_dev,\n\t\tvoid *drv_priv,\n\t\tint (*queue_init)(void *priv, struct vb2_queue *src_vq, struct vb2_queue *dst_vq));\n\nstatic inline void v4l2_m2m_set_src_buffered(struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t\t\t     bool buffered)\n{\n\tm2m_ctx->out_q_ctx.buffered = buffered;\n}\n\nstatic inline void v4l2_m2m_set_dst_buffered(struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t\t\t     bool buffered)\n{\n\tm2m_ctx->cap_q_ctx.buffered = buffered;\n}\n\n \nvoid v4l2_m2m_ctx_release(struct v4l2_m2m_ctx *m2m_ctx);\n\n \nvoid v4l2_m2m_buf_queue(struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\tstruct vb2_v4l2_buffer *vbuf);\n\n \nstatic inline\nunsigned int v4l2_m2m_num_src_bufs_ready(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\tunsigned int num_buf_rdy;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&m2m_ctx->out_q_ctx.rdy_spinlock, flags);\n\tnum_buf_rdy = m2m_ctx->out_q_ctx.num_rdy;\n\tspin_unlock_irqrestore(&m2m_ctx->out_q_ctx.rdy_spinlock, flags);\n\n\treturn num_buf_rdy;\n}\n\n \nstatic inline\nunsigned int v4l2_m2m_num_dst_bufs_ready(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\tunsigned int num_buf_rdy;\n\tunsigned long flags;\n\n\tspin_lock_irqsave(&m2m_ctx->cap_q_ctx.rdy_spinlock, flags);\n\tnum_buf_rdy = m2m_ctx->cap_q_ctx.num_rdy;\n\tspin_unlock_irqrestore(&m2m_ctx->cap_q_ctx.rdy_spinlock, flags);\n\n\treturn num_buf_rdy;\n}\n\n \nstruct vb2_v4l2_buffer *v4l2_m2m_next_buf(struct v4l2_m2m_queue_ctx *q_ctx);\n\n \nstatic inline struct vb2_v4l2_buffer *\nv4l2_m2m_next_src_buf(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\treturn v4l2_m2m_next_buf(&m2m_ctx->out_q_ctx);\n}\n\n \nstatic inline struct vb2_v4l2_buffer *\nv4l2_m2m_next_dst_buf(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\treturn v4l2_m2m_next_buf(&m2m_ctx->cap_q_ctx);\n}\n\n \nstruct vb2_v4l2_buffer *v4l2_m2m_last_buf(struct v4l2_m2m_queue_ctx *q_ctx);\n\n \nstatic inline struct vb2_v4l2_buffer *\nv4l2_m2m_last_src_buf(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\treturn v4l2_m2m_last_buf(&m2m_ctx->out_q_ctx);\n}\n\n \nstatic inline struct vb2_v4l2_buffer *\nv4l2_m2m_last_dst_buf(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\treturn v4l2_m2m_last_buf(&m2m_ctx->cap_q_ctx);\n}\n\n \n#define v4l2_m2m_for_each_dst_buf(m2m_ctx, b)\t\\\n\tlist_for_each_entry(b, &m2m_ctx->cap_q_ctx.rdy_queue, list)\n\n \n#define v4l2_m2m_for_each_src_buf(m2m_ctx, b)\t\\\n\tlist_for_each_entry(b, &m2m_ctx->out_q_ctx.rdy_queue, list)\n\n \n#define v4l2_m2m_for_each_dst_buf_safe(m2m_ctx, b, n)\t\\\n\tlist_for_each_entry_safe(b, n, &m2m_ctx->cap_q_ctx.rdy_queue, list)\n\n \n#define v4l2_m2m_for_each_src_buf_safe(m2m_ctx, b, n)\t\\\n\tlist_for_each_entry_safe(b, n, &m2m_ctx->out_q_ctx.rdy_queue, list)\n\n \nstatic inline\nstruct vb2_queue *v4l2_m2m_get_src_vq(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\treturn &m2m_ctx->out_q_ctx.q;\n}\n\n \nstatic inline\nstruct vb2_queue *v4l2_m2m_get_dst_vq(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\treturn &m2m_ctx->cap_q_ctx.q;\n}\n\n \nstruct vb2_v4l2_buffer *v4l2_m2m_buf_remove(struct v4l2_m2m_queue_ctx *q_ctx);\n\n \nstatic inline struct vb2_v4l2_buffer *\nv4l2_m2m_src_buf_remove(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\treturn v4l2_m2m_buf_remove(&m2m_ctx->out_q_ctx);\n}\n\n \nstatic inline struct vb2_v4l2_buffer *\nv4l2_m2m_dst_buf_remove(struct v4l2_m2m_ctx *m2m_ctx)\n{\n\treturn v4l2_m2m_buf_remove(&m2m_ctx->cap_q_ctx);\n}\n\n \nvoid v4l2_m2m_buf_remove_by_buf(struct v4l2_m2m_queue_ctx *q_ctx,\n\t\t\t\tstruct vb2_v4l2_buffer *vbuf);\n\n \nstatic inline void v4l2_m2m_src_buf_remove_by_buf(struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t\t\t\t  struct vb2_v4l2_buffer *vbuf)\n{\n\tv4l2_m2m_buf_remove_by_buf(&m2m_ctx->out_q_ctx, vbuf);\n}\n\n \nstatic inline void v4l2_m2m_dst_buf_remove_by_buf(struct v4l2_m2m_ctx *m2m_ctx,\n\t\t\t\t\t\t  struct vb2_v4l2_buffer *vbuf)\n{\n\tv4l2_m2m_buf_remove_by_buf(&m2m_ctx->cap_q_ctx, vbuf);\n}\n\nstruct vb2_v4l2_buffer *\nv4l2_m2m_buf_remove_by_idx(struct v4l2_m2m_queue_ctx *q_ctx, unsigned int idx);\n\nstatic inline struct vb2_v4l2_buffer *\nv4l2_m2m_src_buf_remove_by_idx(struct v4l2_m2m_ctx *m2m_ctx, unsigned int idx)\n{\n\treturn v4l2_m2m_buf_remove_by_idx(&m2m_ctx->out_q_ctx, idx);\n}\n\nstatic inline struct vb2_v4l2_buffer *\nv4l2_m2m_dst_buf_remove_by_idx(struct v4l2_m2m_ctx *m2m_ctx, unsigned int idx)\n{\n\treturn v4l2_m2m_buf_remove_by_idx(&m2m_ctx->cap_q_ctx, idx);\n}\n\n \nvoid v4l2_m2m_buf_copy_metadata(const struct vb2_v4l2_buffer *out_vb,\n\t\t\t\tstruct vb2_v4l2_buffer *cap_vb,\n\t\t\t\tbool copy_frame_flags);\n\n \n\nvoid v4l2_m2m_request_queue(struct media_request *req);\n\n \n\nint v4l2_m2m_ioctl_reqbufs(struct file *file, void *priv,\n\t\t\t\tstruct v4l2_requestbuffers *rb);\nint v4l2_m2m_ioctl_create_bufs(struct file *file, void *fh,\n\t\t\t\tstruct v4l2_create_buffers *create);\nint v4l2_m2m_ioctl_querybuf(struct file *file, void *fh,\n\t\t\t\tstruct v4l2_buffer *buf);\nint v4l2_m2m_ioctl_expbuf(struct file *file, void *fh,\n\t\t\t\tstruct v4l2_exportbuffer *eb);\nint v4l2_m2m_ioctl_qbuf(struct file *file, void *fh,\n\t\t\t\tstruct v4l2_buffer *buf);\nint v4l2_m2m_ioctl_dqbuf(struct file *file, void *fh,\n\t\t\t\tstruct v4l2_buffer *buf);\nint v4l2_m2m_ioctl_prepare_buf(struct file *file, void *fh,\n\t\t\t       struct v4l2_buffer *buf);\nint v4l2_m2m_ioctl_streamon(struct file *file, void *fh,\n\t\t\t\tenum v4l2_buf_type type);\nint v4l2_m2m_ioctl_streamoff(struct file *file, void *fh,\n\t\t\t\tenum v4l2_buf_type type);\nint v4l2_m2m_ioctl_encoder_cmd(struct file *file, void *fh,\n\t\t\t       struct v4l2_encoder_cmd *ec);\nint v4l2_m2m_ioctl_decoder_cmd(struct file *file, void *fh,\n\t\t\t       struct v4l2_decoder_cmd *dc);\nint v4l2_m2m_ioctl_try_encoder_cmd(struct file *file, void *fh,\n\t\t\t\t   struct v4l2_encoder_cmd *ec);\nint v4l2_m2m_ioctl_try_decoder_cmd(struct file *file, void *fh,\n\t\t\t\t   struct v4l2_decoder_cmd *dc);\nint v4l2_m2m_ioctl_stateless_try_decoder_cmd(struct file *file, void *fh,\n\t\t\t\t\t     struct v4l2_decoder_cmd *dc);\nint v4l2_m2m_ioctl_stateless_decoder_cmd(struct file *file, void *priv,\n\t\t\t\t\t struct v4l2_decoder_cmd *dc);\nint v4l2_m2m_fop_mmap(struct file *file, struct vm_area_struct *vma);\n__poll_t v4l2_m2m_fop_poll(struct file *file, poll_table *wait);\n\n#endif  \n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}