{
  "module_name": "ring.h",
  "hash_id": "ba01fa7128cbf5c9db498a9bd71fc5c95e75396c2ce4e41169a3e5e9df191a7e",
  "original_prompt": "Ingested from linux-6.6.14/include/xen/interface/io/ring.h",
  "human_readable_source": " \n \n\n#ifndef __XEN_PUBLIC_IO_RING_H__\n#define __XEN_PUBLIC_IO_RING_H__\n\n \n\n#include <xen/interface/grant_table.h>\n\ntypedef unsigned int RING_IDX;\n\n \n#define __RD2(_x)  (((_x) & 0x00000002) ? 0x2                  : ((_x) & 0x1))\n#define __RD4(_x)  (((_x) & 0x0000000c) ? __RD2((_x)>>2)<<2    : __RD2(_x))\n#define __RD8(_x)  (((_x) & 0x000000f0) ? __RD4((_x)>>4)<<4    : __RD4(_x))\n#define __RD16(_x) (((_x) & 0x0000ff00) ? __RD8((_x)>>8)<<8    : __RD8(_x))\n#define __RD32(_x) (((_x) & 0xffff0000) ? __RD16((_x)>>16)<<16 : __RD16(_x))\n\n \n#define __CONST_RING_SIZE(_s, _sz) \\\n    (__RD32(((_sz) - offsetof(struct _s##_sring, ring)) / \\\n\t    sizeof(((struct _s##_sring *)0)->ring[0])))\n \n#define __RING_SIZE(_s, _sz) \\\n    (__RD32(((_sz) - (long)(_s)->ring + (long)(_s)) / sizeof((_s)->ring[0])))\n\n \n\n#define DEFINE_RING_TYPES(__name, __req_t, __rsp_t)                     \\\n                                                                        \\\n                                                  \\\nunion __name##_sring_entry {                                            \\\n    __req_t req;                                                        \\\n    __rsp_t rsp;                                                        \\\n};                                                                      \\\n                                                                        \\\n                                                   \\\nstruct __name##_sring {                                                 \\\n    RING_IDX req_prod, req_event;                                       \\\n    RING_IDX rsp_prod, rsp_event;                                       \\\n    uint8_t __pad[48];                                                  \\\n    union __name##_sring_entry ring[1];             \\\n};                                                                      \\\n                                                                        \\\n                                    \\\nstruct __name##_front_ring {                                            \\\n    RING_IDX req_prod_pvt;                                              \\\n    RING_IDX rsp_cons;                                                  \\\n    unsigned int nr_ents;                                               \\\n    struct __name##_sring *sring;                                       \\\n};                                                                      \\\n                                                                        \\\n                                     \\\nstruct __name##_back_ring {                                             \\\n    RING_IDX rsp_prod_pvt;                                              \\\n    RING_IDX req_cons;                                                  \\\n    unsigned int nr_ents;                                               \\\n    struct __name##_sring *sring;                                       \\\n};                                                                      \\\n                                                                        \\\n \n\n \n#define SHARED_RING_INIT(_s) do {                                       \\\n    (_s)->req_prod  = (_s)->rsp_prod  = 0;                              \\\n    (_s)->req_event = (_s)->rsp_event = 1;                              \\\n    (void)memset((_s)->__pad, 0, sizeof((_s)->__pad));                  \\\n} while(0)\n\n#define FRONT_RING_ATTACH(_r, _s, _i, __size) do {                      \\\n    (_r)->req_prod_pvt = (_i);                                          \\\n    (_r)->rsp_cons = (_i);                                              \\\n    (_r)->nr_ents = __RING_SIZE(_s, __size);                            \\\n    (_r)->sring = (_s);                                                 \\\n} while (0)\n\n#define FRONT_RING_INIT(_r, _s, __size) FRONT_RING_ATTACH(_r, _s, 0, __size)\n\n#define XEN_FRONT_RING_INIT(r, s, size) do {                            \\\n    SHARED_RING_INIT(s);                                                \\\n    FRONT_RING_INIT(r, s, size);                                        \\\n} while (0)\n\n#define BACK_RING_ATTACH(_r, _s, _i, __size) do {                       \\\n    (_r)->rsp_prod_pvt = (_i);                                          \\\n    (_r)->req_cons = (_i);                                              \\\n    (_r)->nr_ents = __RING_SIZE(_s, __size);                            \\\n    (_r)->sring = (_s);                                                 \\\n} while (0)\n\n#define BACK_RING_INIT(_r, _s, __size) BACK_RING_ATTACH(_r, _s, 0, __size)\n\n \n#define RING_SIZE(_r)                                                   \\\n    ((_r)->nr_ents)\n\n \n#define RING_FREE_REQUESTS(_r)                                          \\\n    (RING_SIZE(_r) - ((_r)->req_prod_pvt - (_r)->rsp_cons))\n\n \n#define RING_FULL(_r)                                                   \\\n    (RING_FREE_REQUESTS(_r) == 0)\n\n \n#define XEN_RING_NR_UNCONSUMED_RESPONSES(_r)                            \\\n    ((_r)->sring->rsp_prod - (_r)->rsp_cons)\n\n#define XEN_RING_NR_UNCONSUMED_REQUESTS(_r) ({                          \\\n    unsigned int req = (_r)->sring->req_prod - (_r)->req_cons;          \\\n    unsigned int rsp = RING_SIZE(_r) -                                  \\\n        ((_r)->req_cons - (_r)->rsp_prod_pvt);                          \\\n    req < rsp ? req : rsp;                                              \\\n})\n\n#define RING_HAS_UNCONSUMED_RESPONSES(_r) \\\n    (!!XEN_RING_NR_UNCONSUMED_RESPONSES(_r))\n#define RING_HAS_UNCONSUMED_REQUESTS(_r)  \\\n    (!!XEN_RING_NR_UNCONSUMED_REQUESTS(_r))\n\n \n#define RING_GET_REQUEST(_r, _idx)                                      \\\n    (&((_r)->sring->ring[((_idx) & (RING_SIZE(_r) - 1))].req))\n\n#define RING_GET_RESPONSE(_r, _idx)                                     \\\n    (&((_r)->sring->ring[((_idx) & (RING_SIZE(_r) - 1))].rsp))\n\n \n#define RING_COPY_(type, r, idx, dest) do {\t\t\t\t\\\n\t \t\t\t\\\n\t*(dest) = *(volatile typeof(dest))RING_GET_##type(r, idx);\t\\\n} while (0)\n\n#define RING_COPY_REQUEST(r, idx, req)  RING_COPY_(REQUEST, r, idx, req)\n#define RING_COPY_RESPONSE(r, idx, rsp) RING_COPY_(RESPONSE, r, idx, rsp)\n\n \n#define RING_REQUEST_CONS_OVERFLOW(_r, _cons)                           \\\n    (((_cons) - (_r)->rsp_prod_pvt) >= RING_SIZE(_r))\n\n \n#define RING_REQUEST_PROD_OVERFLOW(_r, _prod)                           \\\n    (((_prod) - (_r)->rsp_prod_pvt) > RING_SIZE(_r))\n\n \n#define RING_RESPONSE_PROD_OVERFLOW(_r, _prod)                          \\\n    (((_prod) - (_r)->rsp_cons) > RING_SIZE(_r))\n\n#define RING_PUSH_REQUESTS(_r) do {                                     \\\n    virt_wmb();  \\\n    (_r)->sring->req_prod = (_r)->req_prod_pvt;                         \\\n} while (0)\n\n#define RING_PUSH_RESPONSES(_r) do {                                    \\\n    virt_wmb();    \\\n    (_r)->sring->rsp_prod = (_r)->rsp_prod_pvt;                         \\\n} while (0)\n\n \n\n#define RING_PUSH_REQUESTS_AND_CHECK_NOTIFY(_r, _notify) do {           \\\n    RING_IDX __old = (_r)->sring->req_prod;                             \\\n    RING_IDX __new = (_r)->req_prod_pvt;                                \\\n    virt_wmb();  \\\n    (_r)->sring->req_prod = __new;                                      \\\n    virt_mb();   \\\n    (_notify) = ((RING_IDX)(__new - (_r)->sring->req_event) <           \\\n                 (RING_IDX)(__new - __old));                            \\\n} while (0)\n\n#define RING_PUSH_RESPONSES_AND_CHECK_NOTIFY(_r, _notify) do {          \\\n    RING_IDX __old = (_r)->sring->rsp_prod;                             \\\n    RING_IDX __new = (_r)->rsp_prod_pvt;                                \\\n    virt_wmb();    \\\n    (_r)->sring->rsp_prod = __new;                                      \\\n    virt_mb();     \\\n    (_notify) = ((RING_IDX)(__new - (_r)->sring->rsp_event) <           \\\n                 (RING_IDX)(__new - __old));                            \\\n} while (0)\n\n#define RING_FINAL_CHECK_FOR_REQUESTS(_r, _work_to_do) do {             \\\n    (_work_to_do) = RING_HAS_UNCONSUMED_REQUESTS(_r);                   \\\n    if (_work_to_do) break;                                             \\\n    (_r)->sring->req_event = (_r)->req_cons + 1;                        \\\n    virt_mb();                                                          \\\n    (_work_to_do) = RING_HAS_UNCONSUMED_REQUESTS(_r);                   \\\n} while (0)\n\n#define RING_FINAL_CHECK_FOR_RESPONSES(_r, _work_to_do) do {            \\\n    (_work_to_do) = RING_HAS_UNCONSUMED_RESPONSES(_r);                  \\\n    if (_work_to_do) break;                                             \\\n    (_r)->sring->rsp_event = (_r)->rsp_cons + 1;                        \\\n    virt_mb();                                                          \\\n    (_work_to_do) = RING_HAS_UNCONSUMED_RESPONSES(_r);                  \\\n} while (0)\n\n\n \n\n#ifndef XEN_PAGE_SHIFT\n \n#define XEN_PAGE_SHIFT 12\n#endif\n#define XEN_FLEX_RING_SIZE(order)                                             \\\n    (1UL << ((order) + XEN_PAGE_SHIFT - 1))\n\n#define DEFINE_XEN_FLEX_RING(name)                                            \\\nstatic inline RING_IDX name##_mask(RING_IDX idx, RING_IDX ring_size)          \\\n{                                                                             \\\n    return idx & (ring_size - 1);                                             \\\n}                                                                             \\\n                                                                              \\\nstatic inline unsigned char *name##_get_ring_ptr(unsigned char *buf,          \\\n                                                 RING_IDX idx,                \\\n                                                 RING_IDX ring_size)          \\\n{                                                                             \\\n    return buf + name##_mask(idx, ring_size);                                 \\\n}                                                                             \\\n                                                                              \\\nstatic inline void name##_read_packet(void *opaque,                           \\\n                                      const unsigned char *buf,               \\\n                                      size_t size,                            \\\n                                      RING_IDX masked_prod,                   \\\n                                      RING_IDX *masked_cons,                  \\\n                                      RING_IDX ring_size)                     \\\n{                                                                             \\\n    if (*masked_cons < masked_prod ||                                         \\\n        size <= ring_size - *masked_cons) {                                   \\\n        memcpy(opaque, buf + *masked_cons, size);                             \\\n    } else {                                                                  \\\n        memcpy(opaque, buf + *masked_cons, ring_size - *masked_cons);         \\\n        memcpy((unsigned char *)opaque + ring_size - *masked_cons, buf,       \\\n               size - (ring_size - *masked_cons));                            \\\n    }                                                                         \\\n    *masked_cons = name##_mask(*masked_cons + size, ring_size);               \\\n}                                                                             \\\n                                                                              \\\nstatic inline void name##_write_packet(unsigned char *buf,                    \\\n                                       const void *opaque,                    \\\n                                       size_t size,                           \\\n                                       RING_IDX *masked_prod,                 \\\n                                       RING_IDX masked_cons,                  \\\n                                       RING_IDX ring_size)                    \\\n{                                                                             \\\n    if (*masked_prod < masked_cons ||                                         \\\n        size <= ring_size - *masked_prod) {                                   \\\n        memcpy(buf + *masked_prod, opaque, size);                             \\\n    } else {                                                                  \\\n        memcpy(buf + *masked_prod, opaque, ring_size - *masked_prod);         \\\n        memcpy(buf, (unsigned char *)opaque + (ring_size - *masked_prod),     \\\n               size - (ring_size - *masked_prod));                            \\\n    }                                                                         \\\n    *masked_prod = name##_mask(*masked_prod + size, ring_size);               \\\n}                                                                             \\\n                                                                              \\\nstatic inline RING_IDX name##_queued(RING_IDX prod,                           \\\n                                     RING_IDX cons,                           \\\n                                     RING_IDX ring_size)                      \\\n{                                                                             \\\n    RING_IDX size;                                                            \\\n                                                                              \\\n    if (prod == cons)                                                         \\\n        return 0;                                                             \\\n                                                                              \\\n    prod = name##_mask(prod, ring_size);                                      \\\n    cons = name##_mask(cons, ring_size);                                      \\\n                                                                              \\\n    if (prod == cons)                                                         \\\n        return ring_size;                                                     \\\n                                                                              \\\n    if (prod > cons)                                                          \\\n        size = prod - cons;                                                   \\\n    else                                                                      \\\n        size = ring_size - (cons - prod);                                     \\\n    return size;                                                              \\\n}                                                                             \\\n                                                                              \\\nstruct name##_data {                                                          \\\n    unsigned char *in;                             \\\n    unsigned char *out;                            \\\n}\n\n#define DEFINE_XEN_FLEX_RING_AND_INTF(name)                                   \\\nstruct name##_data_intf {                                                     \\\n    RING_IDX in_cons, in_prod;                                                \\\n                                                                              \\\n    uint8_t pad1[56];                                                         \\\n                                                                              \\\n    RING_IDX out_cons, out_prod;                                              \\\n                                                                              \\\n    uint8_t pad2[56];                                                         \\\n                                                                              \\\n    RING_IDX ring_order;                                                      \\\n    grant_ref_t ref[];                                                        \\\n};                                                                            \\\nDEFINE_XEN_FLEX_RING(name)\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}