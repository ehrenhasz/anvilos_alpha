{
  "module_name": "reg_compare.c",
  "hash_id": "2b38fab9db996e66222e7cf2310f8f7523d241458be25ede1f939f39f6b8cf3c",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/math-emu/reg_compare.c",
  "human_readable_source": "\n \n\n \n\n#include \"fpu_system.h\"\n#include \"exception.h\"\n#include \"fpu_emu.h\"\n#include \"control_w.h\"\n#include \"status_w.h\"\n\nstatic int compare(FPU_REG const *b, int tagb)\n{\n\tint diff, exp0, expb;\n\tu_char st0_tag;\n\tFPU_REG *st0_ptr;\n\tFPU_REG x, y;\n\tu_char st0_sign, signb = getsign(b);\n\n\tst0_ptr = &st(0);\n\tst0_tag = FPU_gettag0();\n\tst0_sign = getsign(st0_ptr);\n\n\tif (tagb == TAG_Special)\n\t\ttagb = FPU_Special(b);\n\tif (st0_tag == TAG_Special)\n\t\tst0_tag = FPU_Special(st0_ptr);\n\n\tif (((st0_tag != TAG_Valid) && (st0_tag != TW_Denormal))\n\t    || ((tagb != TAG_Valid) && (tagb != TW_Denormal))) {\n\t\tif (st0_tag == TAG_Zero) {\n\t\t\tif (tagb == TAG_Zero)\n\t\t\t\treturn COMP_A_eq_B;\n\t\t\tif (tagb == TAG_Valid)\n\t\t\t\treturn ((signb ==\n\t\t\t\t\t SIGN_POS) ? COMP_A_lt_B : COMP_A_gt_B);\n\t\t\tif (tagb == TW_Denormal)\n\t\t\t\treturn ((signb ==\n\t\t\t\t\t SIGN_POS) ? COMP_A_lt_B : COMP_A_gt_B)\n\t\t\t\t    | COMP_Denormal;\n\t\t} else if (tagb == TAG_Zero) {\n\t\t\tif (st0_tag == TAG_Valid)\n\t\t\t\treturn ((st0_sign ==\n\t\t\t\t\t SIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B);\n\t\t\tif (st0_tag == TW_Denormal)\n\t\t\t\treturn ((st0_sign ==\n\t\t\t\t\t SIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B)\n\t\t\t\t    | COMP_Denormal;\n\t\t}\n\n\t\tif (st0_tag == TW_Infinity) {\n\t\t\tif ((tagb == TAG_Valid) || (tagb == TAG_Zero))\n\t\t\t\treturn ((st0_sign ==\n\t\t\t\t\t SIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B);\n\t\t\telse if (tagb == TW_Denormal)\n\t\t\t\treturn ((st0_sign ==\n\t\t\t\t\t SIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B)\n\t\t\t\t    | COMP_Denormal;\n\t\t\telse if (tagb == TW_Infinity) {\n\t\t\t\t \n\t\t\t\treturn (st0_sign == signb) ? COMP_A_eq_B :\n\t\t\t\t    ((st0_sign ==\n\t\t\t\t      SIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B);\n\t\t\t}\n\t\t\t \n\t\t} else if (tagb == TW_Infinity) {\n\t\t\tif ((st0_tag == TAG_Valid) || (st0_tag == TAG_Zero))\n\t\t\t\treturn ((signb ==\n\t\t\t\t\t SIGN_POS) ? COMP_A_lt_B : COMP_A_gt_B);\n\t\t\tif (st0_tag == TW_Denormal)\n\t\t\t\treturn ((signb ==\n\t\t\t\t\t SIGN_POS) ? COMP_A_lt_B : COMP_A_gt_B)\n\t\t\t\t    | COMP_Denormal;\n\t\t\t \n\t\t}\n\n\t\t \n\t\tif ((st0_tag == TW_NaN) || (tagb == TW_NaN)) {\n\t\t\tint signalling = 0, unsupported = 0;\n\t\t\tif (st0_tag == TW_NaN) {\n\t\t\t\tsignalling =\n\t\t\t\t    (st0_ptr->sigh & 0xc0000000) == 0x80000000;\n\t\t\t\tunsupported = !((exponent(st0_ptr) == EXP_OVER)\n\t\t\t\t\t\t&& (st0_ptr->\n\t\t\t\t\t\t    sigh & 0x80000000));\n\t\t\t}\n\t\t\tif (tagb == TW_NaN) {\n\t\t\t\tsignalling |=\n\t\t\t\t    (b->sigh & 0xc0000000) == 0x80000000;\n\t\t\t\tunsupported |= !((exponent(b) == EXP_OVER)\n\t\t\t\t\t\t && (b->sigh & 0x80000000));\n\t\t\t}\n\t\t\tif (signalling || unsupported)\n\t\t\t\treturn COMP_No_Comp | COMP_SNaN | COMP_NaN;\n\t\t\telse\n\t\t\t\t \n\t\t\t\treturn COMP_No_Comp | COMP_NaN;\n\t\t}\n\n\t\tEXCEPTION(EX_Invalid);\n\t}\n\n\tif (st0_sign != signb) {\n\t\treturn ((st0_sign == SIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B)\n\t\t    | (((st0_tag == TW_Denormal) || (tagb == TW_Denormal)) ?\n\t\t       COMP_Denormal : 0);\n\t}\n\n\tif ((st0_tag == TW_Denormal) || (tagb == TW_Denormal)) {\n\t\tFPU_to_exp16(st0_ptr, &x);\n\t\tFPU_to_exp16(b, &y);\n\t\tst0_ptr = &x;\n\t\tb = &y;\n\t\texp0 = exponent16(st0_ptr);\n\t\texpb = exponent16(b);\n\t} else {\n\t\texp0 = exponent(st0_ptr);\n\t\texpb = exponent(b);\n\t}\n\n#ifdef PARANOID\n\tif (!(st0_ptr->sigh & 0x80000000))\n\t\tEXCEPTION(EX_Invalid);\n\tif (!(b->sigh & 0x80000000))\n\t\tEXCEPTION(EX_Invalid);\n#endif  \n\n\tdiff = exp0 - expb;\n\tif (diff == 0) {\n\t\tdiff = st0_ptr->sigh - b->sigh;\t \n\t\tif (diff == 0) {\n\t\t\tdiff = st0_ptr->sigl > b->sigl;\n\t\t\tif (diff == 0)\n\t\t\t\tdiff = -(st0_ptr->sigl < b->sigl);\n\t\t}\n\t}\n\n\tif (diff > 0) {\n\t\treturn ((st0_sign == SIGN_POS) ? COMP_A_gt_B : COMP_A_lt_B)\n\t\t    | (((st0_tag == TW_Denormal) || (tagb == TW_Denormal)) ?\n\t\t       COMP_Denormal : 0);\n\t}\n\tif (diff < 0) {\n\t\treturn ((st0_sign == SIGN_POS) ? COMP_A_lt_B : COMP_A_gt_B)\n\t\t    | (((st0_tag == TW_Denormal) || (tagb == TW_Denormal)) ?\n\t\t       COMP_Denormal : 0);\n\t}\n\n\treturn COMP_A_eq_B\n\t    | (((st0_tag == TW_Denormal) || (tagb == TW_Denormal)) ?\n\t       COMP_Denormal : 0);\n\n}\n\n \nint FPU_compare_st_data(FPU_REG const *loaded_data, u_char loaded_tag)\n{\n\tint f, c;\n\n\tc = compare(loaded_data, loaded_tag);\n\n\tif (c & COMP_NaN) {\n\t\tEXCEPTION(EX_Invalid);\n\t\tf = SW_C3 | SW_C2 | SW_C0;\n\t} else\n\t\tswitch (c & 7) {\n\t\tcase COMP_A_lt_B:\n\t\t\tf = SW_C0;\n\t\t\tbreak;\n\t\tcase COMP_A_eq_B:\n\t\t\tf = SW_C3;\n\t\t\tbreak;\n\t\tcase COMP_A_gt_B:\n\t\t\tf = 0;\n\t\t\tbreak;\n\t\tcase COMP_No_Comp:\n\t\t\tf = SW_C3 | SW_C2 | SW_C0;\n\t\t\tbreak;\n\t\tdefault:\n#ifdef PARANOID\n\t\t\tEXCEPTION(EX_INTERNAL | 0x121);\n#endif  \n\t\t\tf = SW_C3 | SW_C2 | SW_C0;\n\t\t\tbreak;\n\t\t}\n\tsetcc(f);\n\tif (c & COMP_Denormal) {\n\t\treturn denormal_operand() < 0;\n\t}\n\treturn 0;\n}\n\nstatic int compare_st_st(int nr)\n{\n\tint f, c;\n\tFPU_REG *st_ptr;\n\n\tif (!NOT_EMPTY(0) || !NOT_EMPTY(nr)) {\n\t\tsetcc(SW_C3 | SW_C2 | SW_C0);\n\t\t \n\t\tEXCEPTION(EX_StackUnder);\n\t\treturn !(control_word & CW_Invalid);\n\t}\n\n\tst_ptr = &st(nr);\n\tc = compare(st_ptr, FPU_gettagi(nr));\n\tif (c & COMP_NaN) {\n\t\tsetcc(SW_C3 | SW_C2 | SW_C0);\n\t\tEXCEPTION(EX_Invalid);\n\t\treturn !(control_word & CW_Invalid);\n\t} else\n\t\tswitch (c & 7) {\n\t\tcase COMP_A_lt_B:\n\t\t\tf = SW_C0;\n\t\t\tbreak;\n\t\tcase COMP_A_eq_B:\n\t\t\tf = SW_C3;\n\t\t\tbreak;\n\t\tcase COMP_A_gt_B:\n\t\t\tf = 0;\n\t\t\tbreak;\n\t\tcase COMP_No_Comp:\n\t\t\tf = SW_C3 | SW_C2 | SW_C0;\n\t\t\tbreak;\n\t\tdefault:\n#ifdef PARANOID\n\t\t\tEXCEPTION(EX_INTERNAL | 0x122);\n#endif  \n\t\t\tf = SW_C3 | SW_C2 | SW_C0;\n\t\t\tbreak;\n\t\t}\n\tsetcc(f);\n\tif (c & COMP_Denormal) {\n\t\treturn denormal_operand() < 0;\n\t}\n\treturn 0;\n}\n\nstatic int compare_i_st_st(int nr)\n{\n\tint f, c;\n\tFPU_REG *st_ptr;\n\n\tif (!NOT_EMPTY(0) || !NOT_EMPTY(nr)) {\n\t\tFPU_EFLAGS |= (X86_EFLAGS_ZF | X86_EFLAGS_PF | X86_EFLAGS_CF);\n\t\t \n\t\tEXCEPTION(EX_StackUnder);\n\t\treturn !(control_word & CW_Invalid);\n\t}\n\n\tpartial_status &= ~SW_C0;\n\tst_ptr = &st(nr);\n\tc = compare(st_ptr, FPU_gettagi(nr));\n\tif (c & COMP_NaN) {\n\t\tFPU_EFLAGS |= (X86_EFLAGS_ZF | X86_EFLAGS_PF | X86_EFLAGS_CF);\n\t\tEXCEPTION(EX_Invalid);\n\t\treturn !(control_word & CW_Invalid);\n\t}\n\n\tswitch (c & 7) {\n\tcase COMP_A_lt_B:\n\t\tf = X86_EFLAGS_CF;\n\t\tbreak;\n\tcase COMP_A_eq_B:\n\t\tf = X86_EFLAGS_ZF;\n\t\tbreak;\n\tcase COMP_A_gt_B:\n\t\tf = 0;\n\t\tbreak;\n\tcase COMP_No_Comp:\n\t\tf = X86_EFLAGS_ZF | X86_EFLAGS_PF | X86_EFLAGS_CF;\n\t\tbreak;\n\tdefault:\n#ifdef PARANOID\n\t\tEXCEPTION(EX_INTERNAL | 0x122);\n#endif  \n\t\tf = 0;\n\t\tbreak;\n\t}\n\tFPU_EFLAGS = (FPU_EFLAGS & ~(X86_EFLAGS_ZF | X86_EFLAGS_PF | X86_EFLAGS_CF)) | f;\n\tif (c & COMP_Denormal) {\n\t\treturn denormal_operand() < 0;\n\t}\n\treturn 0;\n}\n\nstatic int compare_u_st_st(int nr)\n{\n\tint f = 0, c;\n\tFPU_REG *st_ptr;\n\n\tif (!NOT_EMPTY(0) || !NOT_EMPTY(nr)) {\n\t\tsetcc(SW_C3 | SW_C2 | SW_C0);\n\t\t \n\t\tEXCEPTION(EX_StackUnder);\n\t\treturn !(control_word & CW_Invalid);\n\t}\n\n\tst_ptr = &st(nr);\n\tc = compare(st_ptr, FPU_gettagi(nr));\n\tif (c & COMP_NaN) {\n\t\tsetcc(SW_C3 | SW_C2 | SW_C0);\n\t\tif (c & COMP_SNaN) {\t \n\t\t\tEXCEPTION(EX_Invalid);\n\t\t\treturn !(control_word & CW_Invalid);\n\t\t}\n\t\treturn 0;\n\t} else\n\t\tswitch (c & 7) {\n\t\tcase COMP_A_lt_B:\n\t\t\tf = SW_C0;\n\t\t\tbreak;\n\t\tcase COMP_A_eq_B:\n\t\t\tf = SW_C3;\n\t\t\tbreak;\n\t\tcase COMP_A_gt_B:\n\t\t\tf = 0;\n\t\t\tbreak;\n\t\tcase COMP_No_Comp:\n\t\t\tf = SW_C3 | SW_C2 | SW_C0;\n\t\t\tbreak;\n#ifdef PARANOID\n\t\tdefault:\n\t\t\tEXCEPTION(EX_INTERNAL | 0x123);\n\t\t\tf = SW_C3 | SW_C2 | SW_C0;\n\t\t\tbreak;\n#endif  \n\t\t}\n\tsetcc(f);\n\tif (c & COMP_Denormal) {\n\t\treturn denormal_operand() < 0;\n\t}\n\treturn 0;\n}\n\nstatic int compare_ui_st_st(int nr)\n{\n\tint f = 0, c;\n\tFPU_REG *st_ptr;\n\n\tif (!NOT_EMPTY(0) || !NOT_EMPTY(nr)) {\n\t\tFPU_EFLAGS |= (X86_EFLAGS_ZF | X86_EFLAGS_PF | X86_EFLAGS_CF);\n\t\t \n\t\tEXCEPTION(EX_StackUnder);\n\t\treturn !(control_word & CW_Invalid);\n\t}\n\n\tpartial_status &= ~SW_C0;\n\tst_ptr = &st(nr);\n\tc = compare(st_ptr, FPU_gettagi(nr));\n\tif (c & COMP_NaN) {\n\t\tFPU_EFLAGS |= (X86_EFLAGS_ZF | X86_EFLAGS_PF | X86_EFLAGS_CF);\n\t\tif (c & COMP_SNaN) {\t \n\t\t\tEXCEPTION(EX_Invalid);\n\t\t\treturn !(control_word & CW_Invalid);\n\t\t}\n\t\treturn 0;\n\t}\n\n\tswitch (c & 7) {\n\tcase COMP_A_lt_B:\n\t\tf = X86_EFLAGS_CF;\n\t\tbreak;\n\tcase COMP_A_eq_B:\n\t\tf = X86_EFLAGS_ZF;\n\t\tbreak;\n\tcase COMP_A_gt_B:\n\t\tf = 0;\n\t\tbreak;\n\tcase COMP_No_Comp:\n\t\tf = X86_EFLAGS_ZF | X86_EFLAGS_PF | X86_EFLAGS_CF;\n\t\tbreak;\n#ifdef PARANOID\n\tdefault:\n\t\tEXCEPTION(EX_INTERNAL | 0x123);\n\t\tf = 0;\n\t\tbreak;\n#endif  \n\t}\n\tFPU_EFLAGS = (FPU_EFLAGS & ~(X86_EFLAGS_ZF | X86_EFLAGS_PF | X86_EFLAGS_CF)) | f;\n\tif (c & COMP_Denormal) {\n\t\treturn denormal_operand() < 0;\n\t}\n\treturn 0;\n}\n\n \n\nvoid fcom_st(void)\n{\n\t \n\tcompare_st_st(FPU_rm);\n}\n\nvoid fcompst(void)\n{\n\t \n\tif (!compare_st_st(FPU_rm))\n\t\tFPU_pop();\n}\n\nvoid fcompp(void)\n{\n\t \n\tif (FPU_rm != 1) {\n\t\tFPU_illegal();\n\t\treturn;\n\t}\n\tif (!compare_st_st(1))\n\t\tpoppop();\n}\n\nvoid fucom_(void)\n{\n\t \n\tcompare_u_st_st(FPU_rm);\n\n}\n\nvoid fucomp(void)\n{\n\t \n\tif (!compare_u_st_st(FPU_rm))\n\t\tFPU_pop();\n}\n\nvoid fucompp(void)\n{\n\t \n\tif (FPU_rm == 1) {\n\t\tif (!compare_u_st_st(1))\n\t\t\tpoppop();\n\t} else\n\t\tFPU_illegal();\n}\n\n \n\nvoid fcomi_(void)\n{\n\t \n\tcompare_i_st_st(FPU_rm);\n}\n\nvoid fcomip(void)\n{\n\t \n\tif (!compare_i_st_st(FPU_rm))\n\t\tFPU_pop();\n}\n\nvoid fucomi_(void)\n{\n\t \n\tcompare_ui_st_st(FPU_rm);\n}\n\nvoid fucomip(void)\n{\n\t \n\tif (!compare_ui_st_st(FPU_rm))\n\t\tFPU_pop();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}