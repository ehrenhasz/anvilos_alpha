{
  "module_name": "reg_add_sub.c",
  "hash_id": "0bcd24d074b25fc08ed4e39913a91d8e4562f6be60fc02ca42dd9316a05cfc5b",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/math-emu/reg_add_sub.c",
  "human_readable_source": "\n \n\n \n\n#include \"exception.h\"\n#include \"reg_constant.h\"\n#include \"fpu_emu.h\"\n#include \"control_w.h\"\n#include \"fpu_system.h\"\n\nstatic\nint add_sub_specials(FPU_REG const *a, u_char taga, u_char signa,\n\t\t     FPU_REG const *b, u_char tagb, u_char signb,\n\t\t     FPU_REG * dest, int deststnr, int control_w);\n\n \nint FPU_add(FPU_REG const *b, u_char tagb, int deststnr, int control_w)\n{\n\tFPU_REG *a = &st(0);\n\tFPU_REG *dest = &st(deststnr);\n\tu_char signb = getsign(b);\n\tu_char taga = FPU_gettag0();\n\tu_char signa = getsign(a);\n\tu_char saved_sign = getsign(dest);\n\tint diff, tag, expa, expb;\n\n\tif (!(taga | tagb)) {\n\t\texpa = exponent(a);\n\t\texpb = exponent(b);\n\n\t      valid_add:\n\t\t \n\t\tif (!(signa ^ signb)) {\n\t\t\t \n\t\t\ttag =\n\t\t\t    FPU_u_add(a, b, dest, control_w, signa, expa, expb);\n\t\t} else {\n\t\t\t \n\t\t\tdiff = expa - expb;\n\t\t\tif (!diff) {\n\t\t\t\tdiff = a->sigh - b->sigh;\t \n\t\t\t\tif (!diff) {\n\t\t\t\t\tdiff = a->sigl > b->sigl;\n\t\t\t\t\tif (!diff)\n\t\t\t\t\t\tdiff = -(a->sigl < b->sigl);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tif (diff > 0) {\n\t\t\t\ttag =\n\t\t\t\t    FPU_u_sub(a, b, dest, control_w, signa,\n\t\t\t\t\t      expa, expb);\n\t\t\t} else if (diff < 0) {\n\t\t\t\ttag =\n\t\t\t\t    FPU_u_sub(b, a, dest, control_w, signb,\n\t\t\t\t\t      expb, expa);\n\t\t\t} else {\n\t\t\t\tFPU_copy_to_regi(&CONST_Z, TAG_Zero, deststnr);\n\t\t\t\t \n\t\t\t\tsetsign(dest, ((control_w & CW_RC) != RC_DOWN)\n\t\t\t\t\t? SIGN_POS : SIGN_NEG);\n\t\t\t\treturn TAG_Zero;\n\t\t\t}\n\t\t}\n\n\t\tif (tag < 0) {\n\t\t\tsetsign(dest, saved_sign);\n\t\t\treturn tag;\n\t\t}\n\t\tFPU_settagi(deststnr, tag);\n\t\treturn tag;\n\t}\n\n\tif (taga == TAG_Special)\n\t\ttaga = FPU_Special(a);\n\tif (tagb == TAG_Special)\n\t\ttagb = FPU_Special(b);\n\n\tif (((taga == TAG_Valid) && (tagb == TW_Denormal))\n\t    || ((taga == TW_Denormal) && (tagb == TAG_Valid))\n\t    || ((taga == TW_Denormal) && (tagb == TW_Denormal))) {\n\t\tFPU_REG x, y;\n\n\t\tif (denormal_operand() < 0)\n\t\t\treturn FPU_Exception;\n\n\t\tFPU_to_exp16(a, &x);\n\t\tFPU_to_exp16(b, &y);\n\t\ta = &x;\n\t\tb = &y;\n\t\texpa = exponent16(a);\n\t\texpb = exponent16(b);\n\t\tgoto valid_add;\n\t}\n\n\tif ((taga == TW_NaN) || (tagb == TW_NaN)) {\n\t\tif (deststnr == 0)\n\t\t\treturn real_2op_NaN(b, tagb, deststnr, a);\n\t\telse\n\t\t\treturn real_2op_NaN(a, taga, deststnr, a);\n\t}\n\n\treturn add_sub_specials(a, taga, signa, b, tagb, signb,\n\t\t\t\tdest, deststnr, control_w);\n}\n\n \nint FPU_sub(int flags, int rm, int control_w)\n{\n\tFPU_REG const *a, *b;\n\tFPU_REG *dest;\n\tu_char taga, tagb, signa, signb, saved_sign, sign;\n\tint diff, tag = 0, expa, expb, deststnr;\n\n\ta = &st(0);\n\ttaga = FPU_gettag0();\n\n\tdeststnr = 0;\n\tif (flags & LOADED) {\n\t\tb = (FPU_REG *) rm;\n\t\ttagb = flags & 0x0f;\n\t} else {\n\t\tb = &st(rm);\n\t\ttagb = FPU_gettagi(rm);\n\n\t\tif (flags & DEST_RM)\n\t\t\tdeststnr = rm;\n\t}\n\n\tsigna = getsign(a);\n\tsignb = getsign(b);\n\n\tif (flags & REV) {\n\t\tsigna ^= SIGN_NEG;\n\t\tsignb ^= SIGN_NEG;\n\t}\n\n\tdest = &st(deststnr);\n\tsaved_sign = getsign(dest);\n\n\tif (!(taga | tagb)) {\n\t\texpa = exponent(a);\n\t\texpb = exponent(b);\n\n\t      valid_subtract:\n\t\t \n\n\t\tdiff = expa - expb;\n\n\t\tif (!diff) {\n\t\t\tdiff = a->sigh - b->sigh;\t \n\t\t\tif (!diff) {\n\t\t\t\tdiff = a->sigl > b->sigl;\n\t\t\t\tif (!diff)\n\t\t\t\t\tdiff = -(a->sigl < b->sigl);\n\t\t\t}\n\t\t}\n\n\t\tswitch ((((int)signa) * 2 + signb) / SIGN_NEG) {\n\t\tcase 0:\t \n\t\tcase 3:\t \n\t\t\tif (diff > 0) {\n\t\t\t\t \n\t\t\t\ttag =\n\t\t\t\t    FPU_u_sub(a, b, dest, control_w, signa,\n\t\t\t\t\t      expa, expb);\n\t\t\t} else if (diff == 0) {\n\t\t\t\tFPU_copy_to_regi(&CONST_Z, TAG_Zero, deststnr);\n\n\t\t\t\t \n\t\t\t\tsetsign(dest, ((control_w & CW_RC) != RC_DOWN)\n\t\t\t\t\t? SIGN_POS : SIGN_NEG);\n\t\t\t\treturn TAG_Zero;\n\t\t\t} else {\n\t\t\t\tsign = signa ^ SIGN_NEG;\n\t\t\t\ttag =\n\t\t\t\t    FPU_u_sub(b, a, dest, control_w, sign, expb,\n\t\t\t\t\t      expa);\n\t\t\t}\n\t\t\tbreak;\n\t\tcase 1:\t \n\t\t\ttag =\n\t\t\t    FPU_u_add(a, b, dest, control_w, SIGN_POS, expa,\n\t\t\t\t      expb);\n\t\t\tbreak;\n\t\tcase 2:\t \n\t\t\ttag =\n\t\t\t    FPU_u_add(a, b, dest, control_w, SIGN_NEG, expa,\n\t\t\t\t      expb);\n\t\t\tbreak;\n#ifdef PARANOID\n\t\tdefault:\n\t\t\tEXCEPTION(EX_INTERNAL | 0x111);\n\t\t\treturn -1;\n#endif\n\t\t}\n\t\tif (tag < 0) {\n\t\t\tsetsign(dest, saved_sign);\n\t\t\treturn tag;\n\t\t}\n\t\tFPU_settagi(deststnr, tag);\n\t\treturn tag;\n\t}\n\n\tif (taga == TAG_Special)\n\t\ttaga = FPU_Special(a);\n\tif (tagb == TAG_Special)\n\t\ttagb = FPU_Special(b);\n\n\tif (((taga == TAG_Valid) && (tagb == TW_Denormal))\n\t    || ((taga == TW_Denormal) && (tagb == TAG_Valid))\n\t    || ((taga == TW_Denormal) && (tagb == TW_Denormal))) {\n\t\tFPU_REG x, y;\n\n\t\tif (denormal_operand() < 0)\n\t\t\treturn FPU_Exception;\n\n\t\tFPU_to_exp16(a, &x);\n\t\tFPU_to_exp16(b, &y);\n\t\ta = &x;\n\t\tb = &y;\n\t\texpa = exponent16(a);\n\t\texpb = exponent16(b);\n\n\t\tgoto valid_subtract;\n\t}\n\n\tif ((taga == TW_NaN) || (tagb == TW_NaN)) {\n\t\tFPU_REG const *d1, *d2;\n\t\tif (flags & REV) {\n\t\t\td1 = b;\n\t\t\td2 = a;\n\t\t} else {\n\t\t\td1 = a;\n\t\t\td2 = b;\n\t\t}\n\t\tif (flags & LOADED)\n\t\t\treturn real_2op_NaN(b, tagb, deststnr, d1);\n\t\tif (flags & DEST_RM)\n\t\t\treturn real_2op_NaN(a, taga, deststnr, d2);\n\t\telse\n\t\t\treturn real_2op_NaN(b, tagb, deststnr, d2);\n\t}\n\n\treturn add_sub_specials(a, taga, signa, b, tagb, signb ^ SIGN_NEG,\n\t\t\t\tdest, deststnr, control_w);\n}\n\nstatic\nint add_sub_specials(FPU_REG const *a, u_char taga, u_char signa,\n\t\t     FPU_REG const *b, u_char tagb, u_char signb,\n\t\t     FPU_REG * dest, int deststnr, int control_w)\n{\n\tif (((taga == TW_Denormal) || (tagb == TW_Denormal))\n\t    && (denormal_operand() < 0))\n\t\treturn FPU_Exception;\n\n\tif (taga == TAG_Zero) {\n\t\tif (tagb == TAG_Zero) {\n\t\t\t \n\t\t\tu_char different_signs = signa ^ signb;\n\n\t\t\tFPU_copy_to_regi(a, TAG_Zero, deststnr);\n\t\t\tif (different_signs) {\n\t\t\t\t \n\t\t\t\t \n\t\t\t\tsetsign(dest, ((control_w & CW_RC) != RC_DOWN)\n\t\t\t\t\t? SIGN_POS : SIGN_NEG);\n\t\t\t} else\n\t\t\t\tsetsign(dest, signa);\t \n\t\t\treturn TAG_Zero;\n\t\t} else {\n\t\t\treg_copy(b, dest);\n\t\t\tif ((tagb == TW_Denormal) && (b->sigh & 0x80000000)) {\n\t\t\t\t \n\t\t\t\taddexponent(dest, 1);\n\t\t\t\ttagb = TAG_Valid;\n\t\t\t} else if (tagb > TAG_Empty)\n\t\t\t\ttagb = TAG_Special;\n\t\t\tsetsign(dest, signb);\t \n\t\t\tFPU_settagi(deststnr, tagb);\n\t\t\treturn tagb;\n\t\t}\n\t} else if (tagb == TAG_Zero) {\n\t\treg_copy(a, dest);\n\t\tif ((taga == TW_Denormal) && (a->sigh & 0x80000000)) {\n\t\t\t \n\t\t\taddexponent(dest, 1);\n\t\t\ttaga = TAG_Valid;\n\t\t} else if (taga > TAG_Empty)\n\t\t\ttaga = TAG_Special;\n\t\tsetsign(dest, signa);\t \n\t\tFPU_settagi(deststnr, taga);\n\t\treturn taga;\n\t} else if (taga == TW_Infinity) {\n\t\tif ((tagb != TW_Infinity) || (signa == signb)) {\n\t\t\tFPU_copy_to_regi(a, TAG_Special, deststnr);\n\t\t\tsetsign(dest, signa);\t \n\t\t\treturn taga;\n\t\t}\n\t\t \n\t\treturn arith_invalid(deststnr);\n\t} else if (tagb == TW_Infinity) {\n\t\tFPU_copy_to_regi(b, TAG_Special, deststnr);\n\t\tsetsign(dest, signb);\t \n\t\treturn tagb;\n\t}\n#ifdef PARANOID\n\tEXCEPTION(EX_INTERNAL | 0x101);\n#endif\n\n\treturn FPU_Exception;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}