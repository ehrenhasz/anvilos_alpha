{
  "module_name": "head_64.S",
  "hash_id": "7d159185a8ff697c53e61c2323a5b0e662b87c0d343d3511f2bfba7522a5c5cf",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/head_64.S",
  "human_readable_source": " \n \n\n\n#include <linux/linkage.h>\n#include <linux/threads.h>\n#include <linux/init.h>\n#include <linux/pgtable.h>\n#include <asm/segment.h>\n#include <asm/page.h>\n#include <asm/msr.h>\n#include <asm/cache.h>\n#include <asm/processor-flags.h>\n#include <asm/percpu.h>\n#include <asm/nops.h>\n#include \"../entry/calling.h\"\n#include <asm/export.h>\n#include <asm/nospec-branch.h>\n#include <asm/apicdef.h>\n#include <asm/fixmap.h>\n#include <asm/smp.h>\n\n \n#define l4_index(x)\t(((x) >> 39) & 511)\n#define pud_index(x)\t(((x) >> PUD_SHIFT) & (PTRS_PER_PUD-1))\n\nL4_PAGE_OFFSET = l4_index(__PAGE_OFFSET_BASE_L4)\nL4_START_KERNEL = l4_index(__START_KERNEL_map)\n\nL3_START_KERNEL = pud_index(__START_KERNEL_map)\n\n\t.text\n\t__HEAD\n\t.code64\nSYM_CODE_START_NOALIGN(startup_64)\n\tUNWIND_HINT_END_OF_STACK\n\t \n\tmov\t%rsi, %r15\n\n\t \n\tleaq\t(__end_init_task - PTREGS_SIZE)(%rip), %rsp\n\n\tleaq\t_text(%rip), %rdi\n\n\t \n\tmovl\t$MSR_GS_BASE, %ecx\n\tleaq\tINIT_PER_CPU_VAR(fixed_percpu_data)(%rip), %rdx\n\tmovl\t%edx, %eax\n\tshrq\t$32,  %rdx\n\twrmsr\n\n\tcall\tstartup_64_setup_env\n\n\t \n\tpushq\t$__KERNEL_CS\n\tleaq\t.Lon_kernel_cs(%rip), %rax\n\tpushq\t%rax\n\tlretq\n\n.Lon_kernel_cs:\n\tUNWIND_HINT_END_OF_STACK\n\n#ifdef CONFIG_AMD_MEM_ENCRYPT\n\t \n\tmovq\t%r15, %rdi\n\tcall\tsme_enable\n#endif\n\n\t \n\tcall verify_cpu\n\n\t \n\tleaq\t_text(%rip), %rdi\n\tmovq\t%r15, %rsi\n\tcall\t__startup_64\n\n\t \n\taddq\t$(early_top_pgt - __START_KERNEL_map), %rax\n\tjmp 1f\nSYM_CODE_END(startup_64)\n\nSYM_CODE_START(secondary_startup_64)\n\tUNWIND_HINT_END_OF_STACK\n\tANNOTATE_NOENDBR\n\t \n\n\t \n\tcall verify_cpu\n\n\t \nSYM_INNER_LABEL(secondary_startup_64_no_verify, SYM_L_GLOBAL)\n\tUNWIND_HINT_END_OF_STACK\n\tANNOTATE_NOENDBR\n\n\t \n\txorq\t%r15, %r15\n\n\t \n#ifdef CONFIG_AMD_MEM_ENCRYPT\n\tmovq\tsme_me_mask, %rax\n#else\n\txorq\t%rax, %rax\n#endif\n\n\t \n\taddq\t$(init_top_pgt - __START_KERNEL_map), %rax\n1:\n\n#ifdef CONFIG_X86_MCE\n\t \n\tmovq\t%cr4, %rcx\n\tandl\t$X86_CR4_MCE, %ecx\n#else\n\tmovl\t$0, %ecx\n#endif\n\n\t \n\torl\t$(X86_CR4_PAE | X86_CR4_PGE), %ecx\n#ifdef CONFIG_X86_5LEVEL\n\ttestl\t$1, __pgtable_l5_enabled(%rip)\n\tjz\t1f\n\torl\t$X86_CR4_LA57, %ecx\n1:\n#endif\n\tmovq\t%rcx, %cr4\n\n\t \n\taddq\tphys_base(%rip), %rax\n\n\t \n\tmovq\t%rax, %rdi\n\tcall\tsev_verify_cbit\n\n\t \n\tmovq\t%rax, %cr3\n\n\t \n\tmovq\t%cr4, %rcx\n\tmovq\t%rcx, %rax\n\txorq\t$X86_CR4_PGE, %rcx\n\tmovq\t%rcx, %cr4\n\tmovq\t%rax, %cr4\n\n\t \n\tmovq\t$1f, %rax\n\tANNOTATE_RETPOLINE_SAFE\n\tjmp\t*%rax\n1:\n\tUNWIND_HINT_END_OF_STACK\n\tANNOTATE_NOENDBR  \n\n#ifdef CONFIG_SMP\n\t \n\tmovl\tsmpboot_control(%rip), %ecx\n\ttestl\t$STARTUP_READ_APICID, %ecx\n\tjnz\t.Lread_apicid\n\t \n\tandl\t$(~STARTUP_PARALLEL_MASK), %ecx\n\tjmp\t.Lsetup_cpu\n\n.Lread_apicid:\n\t \n\tmov\t$MSR_IA32_APICBASE, %ecx\n\trdmsr\n\ttestl\t$X2APIC_ENABLE, %eax\n\tjnz\t.Lread_apicid_msr\n\n#ifdef CONFIG_X86_X2APIC\n\t \n\tcmpl\t$0, x2apic_mode(%rip)\n\tjz\t.Lread_apicid_mmio\n\n\t \n\torl\t$X2APIC_ENABLE, %eax\n\twrmsr\n\tjmp\t.Lread_apicid_msr\n#endif\n\n.Lread_apicid_mmio:\n\t \n\tmovq\tapic_mmio_base(%rip), %rcx\n\taddq\t$APIC_ID, %rcx\n\tmovl\t(%rcx), %eax\n\tshr\t$24, %eax\n\tjmp\t.Llookup_AP\n\n.Lread_apicid_msr:\n\tmov\t$APIC_X2APIC_ID_MSR, %ecx\n\trdmsr\n\n.Llookup_AP:\n\t \n\txorq\t%rcx, %rcx\n\tleaq\tcpuid_to_apicid(%rip), %rbx\n\n.Lfind_cpunr:\n\tcmpl\t(%rbx,%rcx,4), %eax\n\tjz\t.Lsetup_cpu\n\tinc\t%ecx\n#ifdef CONFIG_FORCE_NR_CPUS\n\tcmpl\t$NR_CPUS, %ecx\n#else\n\tcmpl\tnr_cpu_ids(%rip), %ecx\n#endif\n\tjb\t.Lfind_cpunr\n\n\t \n\tmovq\ttrampoline_lock(%rip), %rax\n\tmovl\t$0, (%rax)\n\n1:\tcli\n\thlt\n\tjmp\t1b\n\n.Lsetup_cpu:\n\t \n\tmovq\t__per_cpu_offset(,%rcx,8), %rdx\n#else\n\txorl\t%edx, %edx  \n#endif  \n\n\t \n\tmovq\tpcpu_hot + X86_current_task(%rdx), %rax\n\tmovq\tTASK_threadsp(%rax), %rsp\n\n\t \n\tmovq\ttrampoline_lock(%rip), %rax\n\ttestq\t%rax, %rax\n\tjz\t.Lsetup_gdt\n\tmovl\t$0, (%rax)\n\n.Lsetup_gdt:\n\t \n\tsubq\t$16, %rsp\n\tmovw\t$(GDT_SIZE-1), (%rsp)\n\tleaq\tgdt_page(%rdx), %rax\n\tmovq\t%rax, 2(%rsp)\n\tlgdt\t(%rsp)\n\taddq\t$16, %rsp\n\n\t \n\txorl %eax,%eax\n\tmovl %eax,%ds\n\tmovl %eax,%ss\n\tmovl %eax,%es\n\n\t \n\tmovl %eax,%fs\n\tmovl %eax,%gs\n\n\t \n\tmovl\t$MSR_GS_BASE,%ecx\n#ifndef CONFIG_SMP\n\tleaq\tINIT_PER_CPU_VAR(fixed_percpu_data)(%rip), %rdx\n#endif\n\tmovl\t%edx, %eax\n\tshrq\t$32, %rdx\n\twrmsr\n\n\t \n\tcall\tearly_setup_idt\n\n\t \n\tmovl\t$0x80000001, %eax\n\tcpuid\n\tmovl\t%edx,%edi\n\n\t \n\tmovl\t$MSR_EFER, %ecx\n\trdmsr\n\t \n\tmovl    %eax, %edx\n\tbtsl\t$_EFER_SCE, %eax\t \n\tbtl\t$20,%edi\t\t \n\tjnc     1f\n\tbtsl\t$_EFER_NX, %eax\n\tbtsq\t$_PAGE_BIT_NX,early_pmd_flags(%rip)\n\n\t \n1:\tcmpl\t%edx, %eax\n\tje\t1f\n\txor\t%edx, %edx\n\twrmsr\t\t\t\t \n1:\n\t \n\tmovl\t$CR0_STATE, %eax\n\t \n\tmovq\t%rax, %cr0\n\n\t \n\tpushq $0\n\tpopfq\n\n\t \n\tmovq\t%r15, %rdi\n\n.Ljump_to_C_code:\n\t \n\tpushq\t$.Lafter_lret\t# put return address on stack for unwinder\n\txorl\t%ebp, %ebp\t# clear frame pointer\n\tmovq\tinitial_code(%rip), %rax\n\tpushq\t$__KERNEL_CS\t# set correct cs\n\tpushq\t%rax\t\t# target address in negative space\n\tlretq\n.Lafter_lret:\n\tANNOTATE_NOENDBR\nSYM_CODE_END(secondary_startup_64)\n\n#include \"verify_cpu.S\"\n#include \"sev_verify_cbit.S\"\n\n#if defined(CONFIG_HOTPLUG_CPU) && defined(CONFIG_AMD_MEM_ENCRYPT)\n \nSYM_CODE_START(soft_restart_cpu)\n\tANNOTATE_NOENDBR\n\tUNWIND_HINT_END_OF_STACK\n\n\t \n\tmovq\tPER_CPU_VAR(pcpu_hot) + X86_current_task, %rcx\n\tmovq\tTASK_threadsp(%rcx), %rsp\n\n\tjmp\t.Ljump_to_C_code\nSYM_CODE_END(soft_restart_cpu)\n#endif\n\n#ifdef CONFIG_AMD_MEM_ENCRYPT\n \nSYM_CODE_START_NOALIGN(vc_boot_ghcb)\n\tUNWIND_HINT_IRET_REGS offset=8\n\tENDBR\n\n\t \n\tPUSH_AND_CLEAR_REGS\n\n\t \n\tmovq    %rsp, %rdi\n\tmovq\tORIG_RAX(%rsp), %rsi\n\tmovq\tinitial_vc_handler(%rip), %rax\n\tANNOTATE_RETPOLINE_SAFE\n\tcall\t*%rax\n\n\t \n\tPOP_REGS\n\n\t \n\taddq    $8, %rsp\n\n\tiretq\nSYM_CODE_END(vc_boot_ghcb)\n#endif\n\n\t \n\t__REFDATA\n\t.balign\t8\nSYM_DATA(initial_code,\t.quad x86_64_start_kernel)\n#ifdef CONFIG_AMD_MEM_ENCRYPT\nSYM_DATA(initial_vc_handler,\t.quad handle_vc_boot_ghcb)\n#endif\n\nSYM_DATA(trampoline_lock, .quad 0);\n\t__FINITDATA\n\n\t__INIT\nSYM_CODE_START(early_idt_handler_array)\n\ti = 0\n\t.rept NUM_EXCEPTION_VECTORS\n\t.if ((EXCEPTION_ERRCODE_MASK >> i) & 1) == 0\n\t\tUNWIND_HINT_IRET_REGS\n\t\tENDBR\n\t\tpushq $0\t# Dummy error code, to make stack frame uniform\n\t.else\n\t\tUNWIND_HINT_IRET_REGS offset=8\n\t\tENDBR\n\t.endif\n\tpushq $i\t\t# 72(%rsp) Vector number\n\tjmp early_idt_handler_common\n\tUNWIND_HINT_IRET_REGS\n\ti = i + 1\n\t.fill early_idt_handler_array + i*EARLY_IDT_HANDLER_SIZE - ., 1, 0xcc\n\t.endr\nSYM_CODE_END(early_idt_handler_array)\n\tANNOTATE_NOENDBR  \n\nSYM_CODE_START_LOCAL(early_idt_handler_common)\n\tUNWIND_HINT_IRET_REGS offset=16\n\t \n\tcld\n\n\tincl early_recursion_flag(%rip)\n\n\t \n\tpushq %rsi\t\t\t\t \n\tmovq 8(%rsp), %rsi\t\t\t \n\tmovq %rdi, 8(%rsp)\t\t\t \n\tpushq %rdx\t\t\t\t \n\tpushq %rcx\t\t\t\t \n\tpushq %rax\t\t\t\t \n\tpushq %r8\t\t\t\t \n\tpushq %r9\t\t\t\t \n\tpushq %r10\t\t\t\t \n\tpushq %r11\t\t\t\t \n\tpushq %rbx\t\t\t\t \n\tpushq %rbp\t\t\t\t \n\tpushq %r12\t\t\t\t \n\tpushq %r13\t\t\t\t \n\tpushq %r14\t\t\t\t \n\tpushq %r15\t\t\t\t \n\tUNWIND_HINT_REGS\n\n\tmovq %rsp,%rdi\t\t \n\tcall do_early_exception\n\n\tdecl early_recursion_flag(%rip)\n\tjmp restore_regs_and_return_to_kernel\nSYM_CODE_END(early_idt_handler_common)\n\n#ifdef CONFIG_AMD_MEM_ENCRYPT\n \nSYM_CODE_START_NOALIGN(vc_no_ghcb)\n\tUNWIND_HINT_IRET_REGS offset=8\n\tENDBR\n\n\t \n\tPUSH_AND_CLEAR_REGS\n\n\t \n\tmovq    %rsp, %rdi\n\tmovq\tORIG_RAX(%rsp), %rsi\n\tcall    do_vc_no_ghcb\n\n\t \n\tPOP_REGS\n\n\t \n\taddq    $8, %rsp\n\n\t \n\tiretq\nSYM_CODE_END(vc_no_ghcb)\n#endif\n\n#define SYM_DATA_START_PAGE_ALIGNED(name)\t\t\t\\\n\tSYM_START(name, SYM_L_GLOBAL, .balign PAGE_SIZE)\n\n#ifdef CONFIG_PAGE_TABLE_ISOLATION\n \n#define PTI_USER_PGD_FILL\t512\n \n#define SYM_DATA_START_PTI_ALIGNED(name) \\\n\tSYM_START(name, SYM_L_GLOBAL, .balign 2 * PAGE_SIZE)\n#else\n#define SYM_DATA_START_PTI_ALIGNED(name) \\\n\tSYM_DATA_START_PAGE_ALIGNED(name)\n#define PTI_USER_PGD_FILL\t0\n#endif\n\n \n#define PMDS(START, PERM, COUNT)\t\t\t\\\n\ti = 0 ;\t\t\t\t\t\t\\\n\t.rept (COUNT) ;\t\t\t\t\t\\\n\t.quad\t(START) + (i << PMD_SHIFT) + (PERM) ;\t\\\n\ti = i + 1 ;\t\t\t\t\t\\\n\t.endr\n\n\t__INITDATA\n\t.balign 4\n\nSYM_DATA_START_PTI_ALIGNED(early_top_pgt)\n\t.fill\t512,8,0\n\t.fill\tPTI_USER_PGD_FILL,8,0\nSYM_DATA_END(early_top_pgt)\n\nSYM_DATA_START_PAGE_ALIGNED(early_dynamic_pgts)\n\t.fill\t512*EARLY_DYNAMIC_PAGE_TABLES,8,0\nSYM_DATA_END(early_dynamic_pgts)\n\nSYM_DATA(early_recursion_flag, .long 0)\n\n\t.data\n\n#if defined(CONFIG_XEN_PV) || defined(CONFIG_PVH)\nSYM_DATA_START_PTI_ALIGNED(init_top_pgt)\n\t.quad   level3_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE_NOENC\n\t.org    init_top_pgt + L4_PAGE_OFFSET*8, 0\n\t.quad   level3_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE_NOENC\n\t.org    init_top_pgt + L4_START_KERNEL*8, 0\n\t \n\t.quad   level3_kernel_pgt - __START_KERNEL_map + _PAGE_TABLE_NOENC\n\t.fill\tPTI_USER_PGD_FILL,8,0\nSYM_DATA_END(init_top_pgt)\n\nSYM_DATA_START_PAGE_ALIGNED(level3_ident_pgt)\n\t.quad\tlevel2_ident_pgt - __START_KERNEL_map + _KERNPG_TABLE_NOENC\n\t.fill\t511, 8, 0\nSYM_DATA_END(level3_ident_pgt)\nSYM_DATA_START_PAGE_ALIGNED(level2_ident_pgt)\n\t \n\tPMDS(0, __PAGE_KERNEL_IDENT_LARGE_EXEC, PTRS_PER_PMD)\nSYM_DATA_END(level2_ident_pgt)\n#else\nSYM_DATA_START_PTI_ALIGNED(init_top_pgt)\n\t.fill\t512,8,0\n\t.fill\tPTI_USER_PGD_FILL,8,0\nSYM_DATA_END(init_top_pgt)\n#endif\n\n#ifdef CONFIG_X86_5LEVEL\nSYM_DATA_START_PAGE_ALIGNED(level4_kernel_pgt)\n\t.fill\t511,8,0\n\t.quad\tlevel3_kernel_pgt - __START_KERNEL_map + _PAGE_TABLE_NOENC\nSYM_DATA_END(level4_kernel_pgt)\n#endif\n\nSYM_DATA_START_PAGE_ALIGNED(level3_kernel_pgt)\n\t.fill\tL3_START_KERNEL,8,0\n\t \n\t.quad\tlevel2_kernel_pgt - __START_KERNEL_map + _KERNPG_TABLE_NOENC\n\t.quad\tlevel2_fixmap_pgt - __START_KERNEL_map + _PAGE_TABLE_NOENC\nSYM_DATA_END(level3_kernel_pgt)\n\nSYM_DATA_START_PAGE_ALIGNED(level2_kernel_pgt)\n\t \n\tPMDS(0, __PAGE_KERNEL_LARGE_EXEC, KERNEL_IMAGE_SIZE/PMD_SIZE)\nSYM_DATA_END(level2_kernel_pgt)\n\nSYM_DATA_START_PAGE_ALIGNED(level2_fixmap_pgt)\n\t.fill\t(512 - 4 - FIXMAP_PMD_NUM),8,0\n\tpgtno = 0\n\t.rept (FIXMAP_PMD_NUM)\n\t.quad level1_fixmap_pgt + (pgtno << PAGE_SHIFT) - __START_KERNEL_map \\\n\t\t+ _PAGE_TABLE_NOENC;\n\tpgtno = pgtno + 1\n\t.endr\n\t \n\t.fill\t4,8,0\nSYM_DATA_END(level2_fixmap_pgt)\n\nSYM_DATA_START_PAGE_ALIGNED(level1_fixmap_pgt)\n\t.rept (FIXMAP_PMD_NUM)\n\t.fill\t512,8,0\n\t.endr\nSYM_DATA_END(level1_fixmap_pgt)\n\n#undef PMDS\n\n\t.data\n\t.align 16\n\nSYM_DATA(smpboot_control,\t\t.long 0)\n\n\t.align 16\n \nSYM_DATA(phys_base, .quad 0x0)\nEXPORT_SYMBOL(phys_base)\n\n#include \"../../x86/xen/xen-head.S\"\n\n\t__PAGE_ALIGNED_BSS\nSYM_DATA_START_PAGE_ALIGNED(empty_zero_page)\n\t.skip PAGE_SIZE\nSYM_DATA_END(empty_zero_page)\nEXPORT_SYMBOL(empty_zero_page)\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}