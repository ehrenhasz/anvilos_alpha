{
  "module_name": "relocate_kernel_32.S",
  "hash_id": "cca5338151db22b3a7f86105f91fe0beb44346e16465d8befa3029e731a1ac52",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/relocate_kernel_32.S",
  "human_readable_source": " \n \n\n#include <linux/linkage.h>\n#include <asm/page_types.h>\n#include <asm/kexec.h>\n#include <asm/nospec-branch.h>\n#include <asm/processor-flags.h>\n\n \n\n#define PTR(x) (x << 2)\n\n \n#define DATA(offset)\t\t(KEXEC_CONTROL_CODE_MAX_SIZE+(offset))\n\n \n#define ESP\t\t\tDATA(0x0)\n#define CR0\t\t\tDATA(0x4)\n#define CR3\t\t\tDATA(0x8)\n#define CR4\t\t\tDATA(0xc)\n\n \n#define CP_VA_CONTROL_PAGE\tDATA(0x10)\n#define CP_PA_PGD\t\tDATA(0x14)\n#define CP_PA_SWAP_PAGE\t\tDATA(0x18)\n#define CP_PA_BACKUP_PAGES_MAP\tDATA(0x1c)\n\n\t.text\nSYM_CODE_START_NOALIGN(relocate_kernel)\n\t \n\n\tpushl\t%ebx\n\tpushl\t%esi\n\tpushl\t%edi\n\tpushl\t%ebp\n\tpushf\n\n\tmovl\t20+8(%esp), %ebp  \n\tmovl\tPTR(VA_CONTROL_PAGE)(%ebp), %edi\n\tmovl\t%esp, ESP(%edi)\n\tmovl\t%cr0, %eax\n\tmovl\t%eax, CR0(%edi)\n\tmovl\t%cr3, %eax\n\tmovl\t%eax, CR3(%edi)\n\tmovl\t%cr4, %eax\n\tmovl\t%eax, CR4(%edi)\n\n\t \n\tmovl  20+4(%esp), %ebx  \n\tmovl  20+8(%esp), %ebp  \n\tmovl  20+12(%esp), %edx  \n\tmovl  20+16(%esp), %ecx  \n\tmovl  20+20(%esp), %esi  \n\n\t \n\tpushl $0\n\tpopfl\n\n\t \n\tmovl\tPTR(VA_CONTROL_PAGE)(%ebp), %edi\n\tmovl\t%edi, CP_VA_CONTROL_PAGE(%edi)\n\tmovl\tPTR(PA_PGD)(%ebp), %eax\n\tmovl\t%eax, CP_PA_PGD(%edi)\n\tmovl\tPTR(PA_SWAP_PAGE)(%ebp), %eax\n\tmovl\t%eax, CP_PA_SWAP_PAGE(%edi)\n\tmovl\t%ebx, CP_PA_BACKUP_PAGES_MAP(%edi)\n\n\t \n\tmovl\tPTR(PA_CONTROL_PAGE)(%ebp), %edi\n\n\t \n\tmovl\tPTR(PA_PGD)(%ebp), %eax\n\tmovl\t%eax, %cr3\n\n\t \n\tlea\tPAGE_SIZE(%edi), %esp\n\n\t \n\tmovl    %edi, %eax\n\taddl    $(identity_mapped - relocate_kernel), %eax\n\tpushl   %eax\n\tANNOTATE_UNRET_SAFE\n\tret\n\tint3\nSYM_CODE_END(relocate_kernel)\n\nSYM_CODE_START_LOCAL_NOALIGN(identity_mapped)\n\t \n\tpushl\t$0\n\t \n\tpushl   %edx\n\n\t \n\tmovl\t%cr0, %eax\n\tandl\t$~(X86_CR0_PG | X86_CR0_AM | X86_CR0_WP | X86_CR0_TS | X86_CR0_EM), %eax\n\torl\t$(X86_CR0_PE), %eax\n\tmovl\t%eax, %cr0\n\n\t \n\ttestl\t%ecx, %ecx\n\tjz\t1f\n\t \n\txorl\t%eax, %eax\n\tmovl\t%eax, %cr4\n\n\tjmp 1f\n1:\n\n\t \n\txorl\t%eax, %eax\n\tmovl\t%eax, %cr3\n\n\tmovl\tCP_PA_SWAP_PAGE(%edi), %eax\n\tpushl\t%eax\n\tpushl\t%ebx\n\tcall\tswap_pages\n\taddl\t$8, %esp\n\n\t \n\txorl\t%eax, %eax\n\tmovl\t%eax, %cr3\n\n\t \n\n\ttestl\t%esi, %esi\n\tjnz 1f\n\txorl\t%edi, %edi\n\txorl\t%eax, %eax\n\txorl\t%ebx, %ebx\n\txorl    %ecx, %ecx\n\txorl    %edx, %edx\n\txorl    %esi, %esi\n\txorl    %ebp, %ebp\n\tANNOTATE_UNRET_SAFE\n\tret\n\tint3\n1:\n\tpopl\t%edx\n\tmovl\tCP_PA_SWAP_PAGE(%edi), %esp\n\taddl\t$PAGE_SIZE, %esp\n2:\n\tANNOTATE_RETPOLINE_SAFE\n\tcall\t*%edx\n\n\t \n\tmovl\t0(%esp), %ebp\n\tcall\t1f\n1:\n\tpopl\t%ebx\n\tsubl\t$(1b - relocate_kernel), %ebx\n\tmovl\tCP_VA_CONTROL_PAGE(%ebx), %edi\n\tlea\tPAGE_SIZE(%ebx), %esp\n\tmovl\tCP_PA_SWAP_PAGE(%ebx), %eax\n\tmovl\tCP_PA_BACKUP_PAGES_MAP(%ebx), %edx\n\tpushl\t%eax\n\tpushl\t%edx\n\tcall\tswap_pages\n\taddl\t$8, %esp\n\tmovl\tCP_PA_PGD(%ebx), %eax\n\tmovl\t%eax, %cr3\n\tmovl\t%cr0, %eax\n\torl\t$X86_CR0_PG, %eax\n\tmovl\t%eax, %cr0\n\tlea\tPAGE_SIZE(%edi), %esp\n\tmovl\t%edi, %eax\n\taddl\t$(virtual_mapped - relocate_kernel), %eax\n\tpushl\t%eax\n\tANNOTATE_UNRET_SAFE\n\tret\n\tint3\nSYM_CODE_END(identity_mapped)\n\nSYM_CODE_START_LOCAL_NOALIGN(virtual_mapped)\n\tmovl\tCR4(%edi), %eax\n\tmovl\t%eax, %cr4\n\tmovl\tCR3(%edi), %eax\n\tmovl\t%eax, %cr3\n\tmovl\tCR0(%edi), %eax\n\tmovl\t%eax, %cr0\n\tmovl\tESP(%edi), %esp\n\tmovl\t%ebp, %eax\n\n\tpopf\n\tpopl\t%ebp\n\tpopl\t%edi\n\tpopl\t%esi\n\tpopl\t%ebx\n\tANNOTATE_UNRET_SAFE\n\tret\n\tint3\nSYM_CODE_END(virtual_mapped)\n\n\t \nSYM_CODE_START_LOCAL_NOALIGN(swap_pages)\n\tmovl\t8(%esp), %edx\n\tmovl\t4(%esp), %ecx\n\tpushl\t%ebp\n\tpushl\t%ebx\n\tpushl\t%edi\n\tpushl\t%esi\n\tmovl\t%ecx, %ebx\n\tjmp\t1f\n\n0:\t \n\tmovl\t(%ebx), %ecx\n\taddl\t$4, %ebx\n1:\n\ttestb\t$0x1, %cl      \n\tjz\t2f\n\tmovl\t%ecx,\t%edi\n\tandl\t$0xfffff000, %edi\n\tjmp     0b\n2:\n\ttestb\t$0x2, %cl     \n\tjz\t2f\n\tmovl\t%ecx,\t%ebx\n\tandl\t$0xfffff000, %ebx\n\tjmp     0b\n2:\n\ttestb   $0x4, %cl     \n\tjz      2f\n\tjmp     3f\n2:\n\ttestb   $0x8, %cl     \n\tjz      0b\t      \n\tmovl    %ecx,   %esi  \n\tandl    $0xfffff000, %esi\n\n\tmovl\t%edi, %eax\n\tmovl\t%esi, %ebp\n\n\tmovl\t%edx, %edi\n\tmovl    $1024, %ecx\n\trep ; movsl\n\n\tmovl\t%ebp, %edi\n\tmovl\t%eax, %esi\n\tmovl\t$1024, %ecx\n\trep ; movsl\n\n\tmovl\t%eax, %edi\n\tmovl\t%edx, %esi\n\tmovl\t$1024, %ecx\n\trep ; movsl\n\n\tlea\tPAGE_SIZE(%ebp), %esi\n\tjmp     0b\n3:\n\tpopl\t%esi\n\tpopl\t%edi\n\tpopl\t%ebx\n\tpopl\t%ebp\n\tANNOTATE_UNRET_SAFE\n\tret\n\tint3\nSYM_CODE_END(swap_pages)\n\n\t.globl kexec_control_code_size\n.set kexec_control_code_size, . - relocate_kernel\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}