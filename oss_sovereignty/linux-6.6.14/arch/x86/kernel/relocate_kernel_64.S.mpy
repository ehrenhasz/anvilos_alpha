{
  "module_name": "relocate_kernel_64.S",
  "hash_id": "7ed2cceebe5005af3ffdffcbb3e9cae78b7ce4e9fc1b35aa2f9fa75c02b45432",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/relocate_kernel_64.S",
  "human_readable_source": " \n \n\n#include <linux/linkage.h>\n#include <asm/page_types.h>\n#include <asm/kexec.h>\n#include <asm/processor-flags.h>\n#include <asm/pgtable_types.h>\n#include <asm/nospec-branch.h>\n#include <asm/unwind_hints.h>\n\n \n\n#define PTR(x) (x << 3)\n#define PAGE_ATTR (_PAGE_PRESENT | _PAGE_RW | _PAGE_ACCESSED | _PAGE_DIRTY)\n\n \n#define DATA(offset)\t\t(KEXEC_CONTROL_CODE_MAX_SIZE+(offset))\n\n \n#define RSP\t\t\tDATA(0x0)\n#define CR0\t\t\tDATA(0x8)\n#define CR3\t\t\tDATA(0x10)\n#define CR4\t\t\tDATA(0x18)\n\n \n#define CP_PA_TABLE_PAGE\tDATA(0x20)\n#define CP_PA_SWAP_PAGE\t\tDATA(0x28)\n#define CP_PA_BACKUP_PAGES_MAP\tDATA(0x30)\n\n\t.text\n\t.align PAGE_SIZE\n\t.code64\nSYM_CODE_START_NOALIGN(relocate_range)\nSYM_CODE_START_NOALIGN(relocate_kernel)\n\tUNWIND_HINT_END_OF_STACK\n\tANNOTATE_NOENDBR\n\t \n\n\t \n\tpushq %rbx\n\tpushq %rbp\n\tpushq %r12\n\tpushq %r13\n\tpushq %r14\n\tpushq %r15\n\tpushf\n\n\tmovq\tPTR(VA_CONTROL_PAGE)(%rsi), %r11\n\tmovq\t%rsp, RSP(%r11)\n\tmovq\t%cr0, %rax\n\tmovq\t%rax, CR0(%r11)\n\tmovq\t%cr3, %rax\n\tmovq\t%rax, CR3(%r11)\n\tmovq\t%cr4, %rax\n\tmovq\t%rax, CR4(%r11)\n\n\t \n\tmovq\t%rax, %r13\n\n\t \n\tpushq $0\n\tpopfq\n\n\t \n\tmovq\t%r8, %r12\n\n\t \n\tmovq\tPTR(PA_CONTROL_PAGE)(%rsi), %r8\n\n\t \n\tmovq\tPTR(PA_TABLE_PAGE)(%rsi), %r9\n\n\t \n\tmovq\tPTR(PA_SWAP_PAGE)(%rsi), %r10\n\n\t \n\tmovq\t%r9, CP_PA_TABLE_PAGE(%r11)\n\tmovq\t%r10, CP_PA_SWAP_PAGE(%r11)\n\tmovq\t%rdi, CP_PA_BACKUP_PAGES_MAP(%r11)\n\n\t \n\tmovq\t%r9, %cr3\n\n\t \n\tlea\tPAGE_SIZE(%r8), %rsp\n\n\t \n\taddq\t$(identity_mapped - relocate_kernel), %r8\n\tpushq\t%r8\n\tANNOTATE_UNRET_SAFE\n\tret\n\tint3\nSYM_CODE_END(relocate_kernel)\n\nSYM_CODE_START_LOCAL_NOALIGN(identity_mapped)\n\tUNWIND_HINT_END_OF_STACK\n\t \n\tpushq\t$0\n\t \n\tpushq   %rdx\n\n\t \n\tmovq\t%cr4, %rax\n\tandq\t$~(X86_CR4_CET), %rax\n\tmovq\t%rax, %cr4\n\n\t \n\tmovq\t%cr0, %rax\n\tandq\t$~(X86_CR0_AM | X86_CR0_WP | X86_CR0_TS | X86_CR0_EM), %rax\n\torl\t$(X86_CR0_PG | X86_CR0_PE), %eax\n\tmovq\t%rax, %cr0\n\n\t \n\tmovl\t$X86_CR4_PAE, %eax\n\ttestq\t$X86_CR4_LA57, %r13\n\tjz\t1f\n\torl\t$X86_CR4_LA57, %eax\n1:\n\tmovq\t%rax, %cr4\n\n\tjmp 1f\n1:\n\n\t \n\tmovq\t%r9, %cr3\n\n\t \n\ttestq\t%r12, %r12\n\tjz 1f\n\twbinvd\n1:\n\n\tmovq\t%rcx, %r11\n\tcall\tswap_pages\n\n\t \n\tmovq\t%cr3, %rax\n\tmovq\t%rax, %cr3\n\n\t \n\n\ttestq\t%r11, %r11\n\tjnz 1f\n\txorl\t%eax, %eax\n\txorl\t%ebx, %ebx\n\txorl    %ecx, %ecx\n\txorl    %edx, %edx\n\txorl    %esi, %esi\n\txorl    %edi, %edi\n\txorl    %ebp, %ebp\n\txorl\t%r8d, %r8d\n\txorl\t%r9d, %r9d\n\txorl\t%r10d, %r10d\n\txorl\t%r11d, %r11d\n\txorl\t%r12d, %r12d\n\txorl\t%r13d, %r13d\n\txorl\t%r14d, %r14d\n\txorl\t%r15d, %r15d\n\n\tANNOTATE_UNRET_SAFE\n\tret\n\tint3\n\n1:\n\tpopq\t%rdx\n\tleaq\tPAGE_SIZE(%r10), %rsp\n\tANNOTATE_RETPOLINE_SAFE\n\tcall\t*%rdx\n\n\t \n\tmovq\t0(%rsp), %rbp\n\tleaq\trelocate_kernel(%rip), %r8\n\tmovq\tCP_PA_SWAP_PAGE(%r8), %r10\n\tmovq\tCP_PA_BACKUP_PAGES_MAP(%r8), %rdi\n\tmovq\tCP_PA_TABLE_PAGE(%r8), %rax\n\tmovq\t%rax, %cr3\n\tlea\tPAGE_SIZE(%r8), %rsp\n\tcall\tswap_pages\n\tmovq\t$virtual_mapped, %rax\n\tpushq\t%rax\n\tANNOTATE_UNRET_SAFE\n\tret\n\tint3\nSYM_CODE_END(identity_mapped)\n\nSYM_CODE_START_LOCAL_NOALIGN(virtual_mapped)\n\tUNWIND_HINT_END_OF_STACK\n\tANNOTATE_NOENDBR  \n\tmovq\tRSP(%r8), %rsp\n\tmovq\tCR4(%r8), %rax\n\tmovq\t%rax, %cr4\n\tmovq\tCR3(%r8), %rax\n\tmovq\tCR0(%r8), %r8\n\tmovq\t%rax, %cr3\n\tmovq\t%r8, %cr0\n\tmovq\t%rbp, %rax\n\n\tpopf\n\tpopq\t%r15\n\tpopq\t%r14\n\tpopq\t%r13\n\tpopq\t%r12\n\tpopq\t%rbp\n\tpopq\t%rbx\n\tANNOTATE_UNRET_SAFE\n\tret\n\tint3\nSYM_CODE_END(virtual_mapped)\n\n\t \nSYM_CODE_START_LOCAL_NOALIGN(swap_pages)\n\tUNWIND_HINT_END_OF_STACK\n\tmovq\t%rdi, %rcx\t \n\txorl\t%edi, %edi\n\txorl\t%esi, %esi\n\tjmp\t1f\n\n0:\t \n\n\tmovq\t(%rbx), %rcx\n\taddq\t$8,\t%rbx\n1:\n\ttestb\t$0x1,\t%cl    \n\tjz\t2f\n\tmovq\t%rcx,\t%rdi\n\tandq\t$0xfffffffffffff000, %rdi\n\tjmp\t0b\n2:\n\ttestb\t$0x2,\t%cl    \n\tjz\t2f\n\tmovq\t%rcx,   %rbx\n\tandq\t$0xfffffffffffff000, %rbx\n\tjmp\t0b\n2:\n\ttestb\t$0x4,\t%cl    \n\tjz\t2f\n\tjmp\t3f\n2:\n\ttestb\t$0x8,\t%cl    \n\tjz\t0b\t       \n\tmovq\t%rcx,   %rsi   \n\tandq\t$0xfffffffffffff000, %rsi\n\n\tmovq\t%rdi, %rdx\n\tmovq\t%rsi, %rax\n\n\tmovq\t%r10, %rdi\n\tmovl\t$512, %ecx\n\trep ; movsq\n\n\tmovq\t%rax, %rdi\n\tmovq\t%rdx, %rsi\n\tmovl\t$512, %ecx\n\trep ; movsq\n\n\tmovq\t%rdx, %rdi\n\tmovq\t%r10, %rsi\n\tmovl\t$512, %ecx\n\trep ; movsq\n\n\tlea\tPAGE_SIZE(%rax), %rsi\n\tjmp\t0b\n3:\n\tANNOTATE_UNRET_SAFE\n\tret\n\tint3\nSYM_CODE_END(swap_pages)\n\n\t.skip KEXEC_CONTROL_CODE_MAX_SIZE - (. - relocate_kernel), 0xcc\nSYM_CODE_END(relocate_range);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}