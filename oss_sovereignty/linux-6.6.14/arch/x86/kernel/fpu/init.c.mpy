{
  "module_name": "init.c",
  "hash_id": "6a52678df7aafc4c6bfb725de68677002afb3131ae9d9e382e9c087dc4d108cf",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/fpu/init.c",
  "human_readable_source": "\n \n#include <asm/fpu/api.h>\n#include <asm/tlbflush.h>\n#include <asm/setup.h>\n\n#include <linux/sched.h>\n#include <linux/sched/task.h>\n#include <linux/init.h>\n\n#include \"internal.h\"\n#include \"legacy.h\"\n#include \"xstate.h\"\n\n \nstatic void fpu__init_cpu_generic(void)\n{\n\tunsigned long cr0;\n\tunsigned long cr4_mask = 0;\n\n\tif (boot_cpu_has(X86_FEATURE_FXSR))\n\t\tcr4_mask |= X86_CR4_OSFXSR;\n\tif (boot_cpu_has(X86_FEATURE_XMM))\n\t\tcr4_mask |= X86_CR4_OSXMMEXCPT;\n\tif (cr4_mask)\n\t\tcr4_set_bits(cr4_mask);\n\n\tcr0 = read_cr0();\n\tcr0 &= ~(X86_CR0_TS|X86_CR0_EM);  \n\tif (!boot_cpu_has(X86_FEATURE_FPU))\n\t\tcr0 |= X86_CR0_EM;\n\twrite_cr0(cr0);\n\n\t \n#ifdef CONFIG_MATH_EMULATION\n\tif (!boot_cpu_has(X86_FEATURE_FPU))\n\t\tfpstate_init_soft(&current->thread.fpu.fpstate->regs.soft);\n\telse\n#endif\n\t\tasm volatile (\"fninit\");\n}\n\n \nvoid fpu__init_cpu(void)\n{\n\tfpu__init_cpu_generic();\n\tfpu__init_cpu_xstate();\n}\n\nstatic bool __init fpu__probe_without_cpuid(void)\n{\n\tunsigned long cr0;\n\tu16 fsw, fcw;\n\n\tfsw = fcw = 0xffff;\n\n\tcr0 = read_cr0();\n\tcr0 &= ~(X86_CR0_TS | X86_CR0_EM);\n\twrite_cr0(cr0);\n\n\tasm volatile(\"fninit ; fnstsw %0 ; fnstcw %1\" : \"+m\" (fsw), \"+m\" (fcw));\n\n\tpr_info(\"x86/fpu: Probing for FPU: FSW=0x%04hx FCW=0x%04hx\\n\", fsw, fcw);\n\n\treturn fsw == 0 && (fcw & 0x103f) == 0x003f;\n}\n\nstatic void __init fpu__init_system_early_generic(void)\n{\n\tif (!boot_cpu_has(X86_FEATURE_CPUID) &&\n\t    !test_bit(X86_FEATURE_FPU, (unsigned long *)cpu_caps_cleared)) {\n\t\tif (fpu__probe_without_cpuid())\n\t\t\tsetup_force_cpu_cap(X86_FEATURE_FPU);\n\t\telse\n\t\t\tsetup_clear_cpu_cap(X86_FEATURE_FPU);\n\t}\n\n#ifndef CONFIG_MATH_EMULATION\n\tif (!test_cpu_cap(&boot_cpu_data, X86_FEATURE_FPU)) {\n\t\tpr_emerg(\"x86/fpu: Giving up, no FPU found and no math emulation present\\n\");\n\t\tfor (;;)\n\t\t\tasm volatile(\"hlt\");\n\t}\n#endif\n}\n\n \nunsigned int mxcsr_feature_mask __ro_after_init = 0xffffffffu;\nEXPORT_SYMBOL_GPL(mxcsr_feature_mask);\n\nstatic void __init fpu__init_system_mxcsr(void)\n{\n\tunsigned int mask = 0;\n\n\tif (boot_cpu_has(X86_FEATURE_FXSR)) {\n\t\t \n\t\tstatic struct fxregs_state fxregs __initdata;\n\n\t\tasm volatile(\"fxsave %0\" : \"+m\" (fxregs));\n\n\t\tmask = fxregs.mxcsr_mask;\n\n\t\t \n\t\tif (mask == 0)\n\t\t\tmask = 0x0000ffbf;\n\t}\n\tmxcsr_feature_mask &= mask;\n}\n\n \nstatic void __init fpu__init_system_generic(void)\n{\n\t \n\tfpstate_init_user(&init_fpstate);\n\n\tfpu__init_system_mxcsr();\n}\n\n \n#define CHECK_MEMBER_AT_END_OF(TYPE, MEMBER) \\\n\tBUILD_BUG_ON(sizeof(TYPE) !=         \\\n\t\t     ALIGN(offsetofend(TYPE, MEMBER), _Alignof(TYPE)))\n\n \nstatic void __init fpu__init_task_struct_size(void)\n{\n\tint task_size = sizeof(struct task_struct);\n\n\t \n\ttask_size -= sizeof(current->thread.fpu.__fpstate.regs);\n\n\t \n\ttask_size += fpu_kernel_cfg.default_size;\n\n\t \n\tCHECK_MEMBER_AT_END_OF(struct fpu, __fpstate);\n\tCHECK_MEMBER_AT_END_OF(struct thread_struct, fpu);\n\tCHECK_MEMBER_AT_END_OF(struct task_struct, thread);\n\n\tarch_task_struct_size = task_size;\n}\n\n \nstatic void __init fpu__init_system_xstate_size_legacy(void)\n{\n\tunsigned int size;\n\n\t \n\tif (!cpu_feature_enabled(X86_FEATURE_FPU)) {\n\t\tsize = sizeof(struct swregs_state);\n\t} else if (cpu_feature_enabled(X86_FEATURE_FXSR)) {\n\t\tsize = sizeof(struct fxregs_state);\n\t\tfpu_user_cfg.legacy_features = XFEATURE_MASK_FPSSE;\n\t} else {\n\t\tsize = sizeof(struct fregs_state);\n\t\tfpu_user_cfg.legacy_features = XFEATURE_MASK_FP;\n\t}\n\n\tfpu_kernel_cfg.max_size = size;\n\tfpu_kernel_cfg.default_size = size;\n\tfpu_user_cfg.max_size = size;\n\tfpu_user_cfg.default_size = size;\n\tfpstate_reset(&current->thread.fpu);\n}\n\n \nvoid __init fpu__init_system(void)\n{\n\tfpstate_reset(&current->thread.fpu);\n\tfpu__init_system_early_generic();\n\n\t \n\tfpu__init_cpu();\n\n\tfpu__init_system_generic();\n\tfpu__init_system_xstate_size_legacy();\n\tfpu__init_system_xstate(fpu_kernel_cfg.max_size);\n\tfpu__init_task_struct_size();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}