{
  "module_name": "rethook.c",
  "hash_id": "d0880bd0941e84b4b238967b9909987522e4b658454577b90a70cea99a696ae5",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/rethook.c",
  "human_readable_source": "\n \n#include <linux/bug.h>\n#include <linux/rethook.h>\n#include <linux/kprobes.h>\n#include <linux/objtool.h>\n\n#include \"kprobes/common.h\"\n\n__visible void arch_rethook_trampoline_callback(struct pt_regs *regs);\n\n#ifndef ANNOTATE_NOENDBR\n#define ANNOTATE_NOENDBR\n#endif\n\n \nasm(\n\t\".text\\n\"\n\t\".global arch_rethook_trampoline\\n\"\n\t\".type arch_rethook_trampoline, @function\\n\"\n\t\"arch_rethook_trampoline:\\n\"\n#ifdef CONFIG_X86_64\n\tANNOTATE_NOENDBR\t \n\t \n\t\"\tpushq $arch_rethook_trampoline\\n\"\n\tUNWIND_HINT_FUNC\n\t\"       pushq $\" __stringify(__KERNEL_DS) \"\\n\"\n\t \n\t\"\tpushq %rsp\\n\"\n\t\"\tpushfq\\n\"\n\tSAVE_REGS_STRING\n\t\"\tmovq %rsp, %rdi\\n\"\n\t\"\tcall arch_rethook_trampoline_callback\\n\"\n\tRESTORE_REGS_STRING\n\t \n\t\"\taddq $16, %rsp\\n\"\n\t\"\tpopfq\\n\"\n#else\n\t \n\t\"\tpushl $arch_rethook_trampoline\\n\"\n\tUNWIND_HINT_FUNC\n\t\"\tpushl %ss\\n\"\n\t \n\t\"\tpushl %esp\\n\"\n\t\"\tpushfl\\n\"\n\tSAVE_REGS_STRING\n\t\"\tmovl %esp, %eax\\n\"\n\t\"\tcall arch_rethook_trampoline_callback\\n\"\n\tRESTORE_REGS_STRING\n\t \n\t\"\taddl $8, %esp\\n\"\n\t\"\tpopfl\\n\"\n#endif\n\tASM_RET\n\t\".size arch_rethook_trampoline, .-arch_rethook_trampoline\\n\"\n);\nNOKPROBE_SYMBOL(arch_rethook_trampoline);\n\n \n__used __visible void arch_rethook_trampoline_callback(struct pt_regs *regs)\n{\n\tunsigned long *frame_pointer;\n\n\t \n\tregs->cs = __KERNEL_CS;\n#ifdef CONFIG_X86_32\n\tregs->gs = 0;\n#endif\n\tregs->ip = (unsigned long)&arch_rethook_trampoline;\n\tregs->orig_ax = ~0UL;\n\tregs->sp += 2*sizeof(long);\n\tframe_pointer = (long *)(regs + 1);\n\n\t \n\trethook_trampoline_handler(regs, (unsigned long)frame_pointer);\n\n\t \n\t*(unsigned long *)&regs->ss = regs->flags;\n}\nNOKPROBE_SYMBOL(arch_rethook_trampoline_callback);\n\n \nSTACK_FRAME_NON_STANDARD_FP(arch_rethook_trampoline);\n\n \nvoid arch_rethook_fixup_return(struct pt_regs *regs,\n\t\t\t       unsigned long correct_ret_addr)\n{\n\tunsigned long *frame_pointer = (void *)(regs + 1);\n\n\t \n\t*frame_pointer = correct_ret_addr;\n}\nNOKPROBE_SYMBOL(arch_rethook_fixup_return);\n\nvoid arch_rethook_prepare(struct rethook_node *rh, struct pt_regs *regs, bool mcount)\n{\n\tunsigned long *stack = (unsigned long *)regs->sp;\n\n\trh->ret_addr = stack[0];\n\trh->frame = regs->sp;\n\n\t \n\tstack[0] = (unsigned long) arch_rethook_trampoline;\n}\nNOKPROBE_SYMBOL(arch_rethook_prepare);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}