{
  "module_name": "nmi_selftest.c",
  "hash_id": "4ad2bb41c61fc248a2e5f8b2323122335d3cb013d345b56470d2472fdbeedc6e",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/nmi_selftest.c",
  "human_readable_source": "\n \n\n#include <linux/smp.h>\n#include <linux/cpumask.h>\n#include <linux/delay.h>\n#include <linux/init.h>\n#include <linux/percpu.h>\n\n#include <asm/apic.h>\n#include <asm/nmi.h>\n\n#define SUCCESS\t\t0\n#define FAILURE\t\t1\n#define TIMEOUT\t\t2\n\nstatic int __initdata nmi_fail;\n\n \nstatic DECLARE_BITMAP(nmi_ipi_mask, NR_CPUS) __initdata;\n\nstatic int __initdata testcase_total;\nstatic int __initdata testcase_successes;\nstatic int __initdata expected_testcase_failures;\nstatic int __initdata unexpected_testcase_failures;\nstatic int __initdata unexpected_testcase_unknowns;\n\nstatic int __init nmi_unk_cb(unsigned int val, struct pt_regs *regs)\n{\n\tunexpected_testcase_unknowns++;\n\treturn NMI_HANDLED;\n}\n\nstatic void __init init_nmi_testsuite(void)\n{\n\t \n\tregister_nmi_handler(NMI_UNKNOWN, nmi_unk_cb, 0, \"nmi_selftest_unk\",\n\t\t\t__initdata);\n}\n\nstatic void __init cleanup_nmi_testsuite(void)\n{\n\tunregister_nmi_handler(NMI_UNKNOWN, \"nmi_selftest_unk\");\n}\n\nstatic int __init test_nmi_ipi_callback(unsigned int val, struct pt_regs *regs)\n{\n        int cpu = raw_smp_processor_id();\n\n        if (cpumask_test_and_clear_cpu(cpu, to_cpumask(nmi_ipi_mask)))\n                return NMI_HANDLED;\n\n        return NMI_DONE;\n}\n\nstatic void __init test_nmi_ipi(struct cpumask *mask)\n{\n\tunsigned long timeout;\n\n\tif (register_nmi_handler(NMI_LOCAL, test_nmi_ipi_callback,\n\t\t\t\t NMI_FLAG_FIRST, \"nmi_selftest\", __initdata)) {\n\t\tnmi_fail = FAILURE;\n\t\treturn;\n\t}\n\n\t \n\twmb();\n\n\t__apic_send_IPI_mask(mask, NMI_VECTOR);\n\n\t \n\ttimeout = USEC_PER_SEC;\n\twhile (!cpumask_empty(mask) && --timeout)\n\t        udelay(1);\n\n\t \n\tunregister_nmi_handler(NMI_LOCAL, \"nmi_selftest\");\n\n\tif (!timeout)\n\t\tnmi_fail = TIMEOUT;\n\treturn;\n}\n\nstatic void __init remote_ipi(void)\n{\n\tcpumask_copy(to_cpumask(nmi_ipi_mask), cpu_online_mask);\n\tcpumask_clear_cpu(smp_processor_id(), to_cpumask(nmi_ipi_mask));\n\tif (!cpumask_empty(to_cpumask(nmi_ipi_mask)))\n\t\ttest_nmi_ipi(to_cpumask(nmi_ipi_mask));\n}\n\nstatic void __init local_ipi(void)\n{\n\tcpumask_clear(to_cpumask(nmi_ipi_mask));\n\tcpumask_set_cpu(smp_processor_id(), to_cpumask(nmi_ipi_mask));\n\ttest_nmi_ipi(to_cpumask(nmi_ipi_mask));\n}\n\nstatic void __init reset_nmi(void)\n{\n\tnmi_fail = 0;\n}\n\nstatic void __init dotest(void (*testcase_fn)(void), int expected)\n{\n\ttestcase_fn();\n\t \n\tif (nmi_fail != expected) {\n\t\tunexpected_testcase_failures++;\n\n\t\tif (nmi_fail == FAILURE)\n\t\t\tprintk(KERN_CONT \"FAILED |\");\n\t\telse if (nmi_fail == TIMEOUT)\n\t\t\tprintk(KERN_CONT \"TIMEOUT|\");\n\t\telse\n\t\t\tprintk(KERN_CONT \"ERROR  |\");\n\t\tdump_stack();\n\t} else {\n\t\ttestcase_successes++;\n\t\tprintk(KERN_CONT \"  ok  |\");\n\t}\n\ttestcase_total++;\n\n\treset_nmi();\n}\n\nstatic inline void __init print_testname(const char *testname)\n{\n\tprintk(\"%12s:\", testname);\n}\n\nvoid __init nmi_selftest(void)\n{\n\tinit_nmi_testsuite();\n\n         \n\tprintk(\"----------------\\n\");\n\tprintk(\"| NMI testsuite:\\n\");\n\tprintk(\"--------------------\\n\");\n\n\tprint_testname(\"remote IPI\");\n\tdotest(remote_ipi, SUCCESS);\n\tprintk(KERN_CONT \"\\n\");\n\tprint_testname(\"local IPI\");\n\tdotest(local_ipi, SUCCESS);\n\tprintk(KERN_CONT \"\\n\");\n\n\tcleanup_nmi_testsuite();\n\n\tif (unexpected_testcase_failures) {\n\t\tprintk(\"--------------------\\n\");\n\t\tprintk(\"BUG: %3d unexpected failures (out of %3d) - debugging disabled! |\\n\",\n\t\t\tunexpected_testcase_failures, testcase_total);\n\t\tprintk(\"-----------------------------------------------------------------\\n\");\n\t} else if (expected_testcase_failures && testcase_successes) {\n\t\tprintk(\"--------------------\\n\");\n\t\tprintk(\"%3d out of %3d testcases failed, as expected. |\\n\",\n\t\t\texpected_testcase_failures, testcase_total);\n\t\tprintk(\"----------------------------------------------------\\n\");\n\t} else if (expected_testcase_failures && !testcase_successes) {\n\t\tprintk(\"--------------------\\n\");\n\t\tprintk(\"All %3d testcases failed, as expected. |\\n\",\n\t\t\texpected_testcase_failures);\n\t\tprintk(\"----------------------------------------\\n\");\n\t} else {\n\t\tprintk(\"--------------------\\n\");\n\t\tprintk(\"Good, all %3d testcases passed! |\\n\",\n\t\t\ttestcase_successes);\n\t\tprintk(\"---------------------------------\\n\");\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}