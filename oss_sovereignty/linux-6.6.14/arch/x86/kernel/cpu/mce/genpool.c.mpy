{
  "module_name": "genpool.c",
  "hash_id": "6ca4922464025c7bc7d085b1cafd4fb20514d5e1b4b40db92a82158e9add7396",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/cpu/mce/genpool.c",
  "human_readable_source": "\n \n#include <linux/smp.h>\n#include <linux/mm.h>\n#include <linux/genalloc.h>\n#include <linux/llist.h>\n#include \"internal.h\"\n\n \n#define MCE_POOLSZ\t(2 * PAGE_SIZE)\n\nstatic struct gen_pool *mce_evt_pool;\nstatic LLIST_HEAD(mce_event_llist);\nstatic char gen_pool_buf[MCE_POOLSZ];\n\n \nstatic bool is_duplicate_mce_record(struct mce_evt_llist *t, struct mce_evt_llist *l)\n{\n\tstruct mce_evt_llist *node;\n\tstruct mce *m1, *m2;\n\n\tm1 = &t->mce;\n\n\tllist_for_each_entry(node, &l->llnode, llnode) {\n\t\tm2 = &node->mce;\n\n\t\tif (!mce_cmp(m1, m2))\n\t\t\treturn true;\n\t}\n\treturn false;\n}\n\n \nstruct llist_node *mce_gen_pool_prepare_records(void)\n{\n\tstruct llist_node *head;\n\tLLIST_HEAD(new_head);\n\tstruct mce_evt_llist *node, *t;\n\n\thead = llist_del_all(&mce_event_llist);\n\tif (!head)\n\t\treturn NULL;\n\n\t \n\tllist_for_each_entry_safe(node, t, head, llnode) {\n\t\tif (!is_duplicate_mce_record(node, t))\n\t\t\tllist_add(&node->llnode, &new_head);\n\t}\n\n\treturn new_head.first;\n}\n\nvoid mce_gen_pool_process(struct work_struct *__unused)\n{\n\tstruct llist_node *head;\n\tstruct mce_evt_llist *node, *tmp;\n\tstruct mce *mce;\n\n\thead = llist_del_all(&mce_event_llist);\n\tif (!head)\n\t\treturn;\n\n\thead = llist_reverse_order(head);\n\tllist_for_each_entry_safe(node, tmp, head, llnode) {\n\t\tmce = &node->mce;\n\t\tblocking_notifier_call_chain(&x86_mce_decoder_chain, 0, mce);\n\t\tgen_pool_free(mce_evt_pool, (unsigned long)node, sizeof(*node));\n\t}\n}\n\nbool mce_gen_pool_empty(void)\n{\n\treturn llist_empty(&mce_event_llist);\n}\n\nint mce_gen_pool_add(struct mce *mce)\n{\n\tstruct mce_evt_llist *node;\n\n\tif (filter_mce(mce))\n\t\treturn -EINVAL;\n\n\tif (!mce_evt_pool)\n\t\treturn -EINVAL;\n\n\tnode = (void *)gen_pool_alloc(mce_evt_pool, sizeof(*node));\n\tif (!node) {\n\t\tpr_warn_ratelimited(\"MCE records pool full!\\n\");\n\t\treturn -ENOMEM;\n\t}\n\n\tmemcpy(&node->mce, mce, sizeof(*mce));\n\tllist_add(&node->llnode, &mce_event_llist);\n\n\treturn 0;\n}\n\nstatic int mce_gen_pool_create(void)\n{\n\tstruct gen_pool *tmpp;\n\tint ret = -ENOMEM;\n\n\ttmpp = gen_pool_create(ilog2(sizeof(struct mce_evt_llist)), -1);\n\tif (!tmpp)\n\t\tgoto out;\n\n\tret = gen_pool_add(tmpp, (unsigned long)gen_pool_buf, MCE_POOLSZ, -1);\n\tif (ret) {\n\t\tgen_pool_destroy(tmpp);\n\t\tgoto out;\n\t}\n\n\tmce_evt_pool = tmpp;\n\nout:\n\treturn ret;\n}\n\nint mce_gen_pool_init(void)\n{\n\t \n\tif (mce_evt_pool)\n\t\treturn 0;\n\n\treturn mce_gen_pool_create();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}