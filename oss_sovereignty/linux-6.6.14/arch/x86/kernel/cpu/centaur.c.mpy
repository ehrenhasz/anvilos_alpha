{
  "module_name": "centaur.c",
  "hash_id": "17d7996b6837efd55be84affc06d03d1a04da340bd2031c6c64cfab3f26a4f2d",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/cpu/centaur.c",
  "human_readable_source": "\n\n#include <linux/sched.h>\n#include <linux/sched/clock.h>\n\n#include <asm/cpu.h>\n#include <asm/cpufeature.h>\n#include <asm/e820/api.h>\n#include <asm/mtrr.h>\n#include <asm/msr.h>\n\n#include \"cpu.h\"\n\n#define ACE_PRESENT\t(1 << 6)\n#define ACE_ENABLED\t(1 << 7)\n#define ACE_FCR\t\t(1 << 28)\t \n\n#define RNG_PRESENT\t(1 << 2)\n#define RNG_ENABLED\t(1 << 3)\n#define RNG_ENABLE\t(1 << 6)\t \n\nstatic void init_c3(struct cpuinfo_x86 *c)\n{\n\tu32  lo, hi;\n\n\t \n\tif (cpuid_eax(0xC0000000) >= 0xC0000001) {\n\t\tu32 tmp = cpuid_edx(0xC0000001);\n\n\t\t \n\t\tif ((tmp & (ACE_PRESENT | ACE_ENABLED)) == ACE_PRESENT) {\n\t\t\trdmsr(MSR_VIA_FCR, lo, hi);\n\t\t\tlo |= ACE_FCR;\t\t \n\t\t\twrmsr(MSR_VIA_FCR, lo, hi);\n\t\t\tpr_info(\"CPU: Enabled ACE h/w crypto\\n\");\n\t\t}\n\n\t\t \n\t\tif ((tmp & (RNG_PRESENT | RNG_ENABLED)) == RNG_PRESENT) {\n\t\t\trdmsr(MSR_VIA_RNG, lo, hi);\n\t\t\tlo |= RNG_ENABLE;\t \n\t\t\twrmsr(MSR_VIA_RNG, lo, hi);\n\t\t\tpr_info(\"CPU: Enabled h/w RNG\\n\");\n\t\t}\n\n\t\t \n\t\tc->x86_capability[CPUID_C000_0001_EDX] = cpuid_edx(0xC0000001);\n\t}\n#ifdef CONFIG_X86_32\n\t \n\tif (c->x86_model >= 6 && c->x86_model <= 13) {\n\t\trdmsr(MSR_VIA_FCR, lo, hi);\n\t\tlo |= (1<<1 | 1<<7);\n\t\twrmsr(MSR_VIA_FCR, lo, hi);\n\t\tset_cpu_cap(c, X86_FEATURE_CX8);\n\t}\n\n\t \n\tif (c->x86_model >= 6 && c->x86_model < 9)\n\t\tset_cpu_cap(c, X86_FEATURE_3DNOW);\n#endif\n\tif (c->x86 == 0x6 && c->x86_model >= 0xf) {\n\t\tc->x86_cache_alignment = c->x86_clflush_size * 2;\n\t\tset_cpu_cap(c, X86_FEATURE_REP_GOOD);\n\t}\n\n\tif (c->x86 >= 7)\n\t\tset_cpu_cap(c, X86_FEATURE_REP_GOOD);\n}\n\nenum {\n\t\tECX8\t\t= 1<<1,\n\t\tEIERRINT\t= 1<<2,\n\t\tDPM\t\t= 1<<3,\n\t\tDMCE\t\t= 1<<4,\n\t\tDSTPCLK\t\t= 1<<5,\n\t\tELINEAR\t\t= 1<<6,\n\t\tDSMC\t\t= 1<<7,\n\t\tDTLOCK\t\t= 1<<8,\n\t\tEDCTLB\t\t= 1<<8,\n\t\tEMMX\t\t= 1<<9,\n\t\tDPDC\t\t= 1<<11,\n\t\tEBRPRED\t\t= 1<<12,\n\t\tDIC\t\t= 1<<13,\n\t\tDDC\t\t= 1<<14,\n\t\tDNA\t\t= 1<<15,\n\t\tERETSTK\t\t= 1<<16,\n\t\tE2MMX\t\t= 1<<19,\n\t\tEAMD3D\t\t= 1<<20,\n};\n\nstatic void early_init_centaur(struct cpuinfo_x86 *c)\n{\n#ifdef CONFIG_X86_32\n\t \n\tif (c->x86 == 5)\n\t\tset_cpu_cap(c, X86_FEATURE_CENTAUR_MCR);\n#endif\n\tif ((c->x86 == 6 && c->x86_model >= 0xf) ||\n\t    (c->x86 >= 7))\n\t\tset_cpu_cap(c, X86_FEATURE_CONSTANT_TSC);\n\n#ifdef CONFIG_X86_64\n\tset_cpu_cap(c, X86_FEATURE_SYSENTER32);\n#endif\n\tif (c->x86_power & (1 << 8)) {\n\t\tset_cpu_cap(c, X86_FEATURE_CONSTANT_TSC);\n\t\tset_cpu_cap(c, X86_FEATURE_NONSTOP_TSC);\n\t}\n}\n\nstatic void init_centaur(struct cpuinfo_x86 *c)\n{\n#ifdef CONFIG_X86_32\n\tchar *name;\n\tu32  fcr_set = 0;\n\tu32  fcr_clr = 0;\n\tu32  lo, hi, newlo;\n\tu32  aa, bb, cc, dd;\n\n\t \n\tclear_cpu_cap(c, 0*32+31);\n#endif\n\tearly_init_centaur(c);\n\tinit_intel_cacheinfo(c);\n\tdetect_num_cpu_cores(c);\n#ifdef CONFIG_X86_32\n\tdetect_ht(c);\n#endif\n\n\tif (c->cpuid_level > 9) {\n\t\tunsigned int eax = cpuid_eax(10);\n\n\t\t \n\t\tif ((eax & 0xff) && (((eax >> 8) & 0xff) > 1))\n\t\t\tset_cpu_cap(c, X86_FEATURE_ARCH_PERFMON);\n\t}\n\n#ifdef CONFIG_X86_32\n\tif (c->x86 == 5) {\n\t\tswitch (c->x86_model) {\n\t\tcase 4:\n\t\t\tname = \"C6\";\n\t\t\tfcr_set = ECX8|DSMC|EDCTLB|EMMX|ERETSTK;\n\t\t\tfcr_clr = DPDC;\n\t\t\tpr_notice(\"Disabling bugged TSC.\\n\");\n\t\t\tclear_cpu_cap(c, X86_FEATURE_TSC);\n\t\t\tbreak;\n\t\tcase 8:\n\t\t\tswitch (c->x86_stepping) {\n\t\t\tdefault:\n\t\t\tname = \"2\";\n\t\t\t\tbreak;\n\t\t\tcase 7 ... 9:\n\t\t\t\tname = \"2A\";\n\t\t\t\tbreak;\n\t\t\tcase 10 ... 15:\n\t\t\t\tname = \"2B\";\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tfcr_set = ECX8|DSMC|DTLOCK|EMMX|EBRPRED|ERETSTK|\n\t\t\t\t  E2MMX|EAMD3D;\n\t\t\tfcr_clr = DPDC;\n\t\t\tbreak;\n\t\tcase 9:\n\t\t\tname = \"3\";\n\t\t\tfcr_set = ECX8|DSMC|DTLOCK|EMMX|EBRPRED|ERETSTK|\n\t\t\t\t  E2MMX|EAMD3D;\n\t\t\tfcr_clr = DPDC;\n\t\t\tbreak;\n\t\tdefault:\n\t\t\tname = \"??\";\n\t\t}\n\n\t\trdmsr(MSR_IDT_FCR1, lo, hi);\n\t\tnewlo = (lo|fcr_set) & (~fcr_clr);\n\n\t\tif (newlo != lo) {\n\t\t\tpr_info(\"Centaur FCR was 0x%X now 0x%X\\n\",\n\t\t\t\tlo, newlo);\n\t\t\twrmsr(MSR_IDT_FCR1, newlo, hi);\n\t\t} else {\n\t\t\tpr_info(\"Centaur FCR is 0x%X\\n\", lo);\n\t\t}\n\t\t \n\t\tset_cpu_cap(c, X86_FEATURE_CENTAUR_MCR);\n\t\t \n\t\tset_cpu_cap(c, X86_FEATURE_CX8);\n\t\t \n\t\tif (c->x86_model >= 8)\n\t\t\tset_cpu_cap(c, X86_FEATURE_3DNOW);\n\t\t \n\t\tif (cpuid_eax(0x80000000) >= 0x80000005) {\n\t\t\t \n\t\t\tcpuid(0x80000005, &aa, &bb, &cc, &dd);\n\t\t\t \n\t\t\tc->x86_cache_size = (cc>>24)+(dd>>24);\n\t\t}\n\t\tsprintf(c->x86_model_id, \"WinChip %s\", name);\n\t}\n#endif\n\tif (c->x86 == 6 || c->x86 >= 7)\n\t\tinit_c3(c);\n#ifdef CONFIG_X86_64\n\tset_cpu_cap(c, X86_FEATURE_LFENCE_RDTSC);\n#endif\n\n\tinit_ia32_feat_ctl(c);\n}\n\n#ifdef CONFIG_X86_32\nstatic unsigned int\ncentaur_size_cache(struct cpuinfo_x86 *c, unsigned int size)\n{\n\t \n\tif ((c->x86 == 6) && ((c->x86_model == 7) || (c->x86_model == 8)))\n\t\tsize >>= 8;\n\n\t \n\tif ((c->x86 == 6) && (c->x86_model == 9) &&\n\t\t\t\t(c->x86_stepping == 1) && (size == 65))\n\t\tsize -= 1;\n\treturn size;\n}\n#endif\n\nstatic const struct cpu_dev centaur_cpu_dev = {\n\t.c_vendor\t= \"Centaur\",\n\t.c_ident\t= { \"CentaurHauls\" },\n\t.c_early_init\t= early_init_centaur,\n\t.c_init\t\t= init_centaur,\n#ifdef CONFIG_X86_32\n\t.legacy_cache_size = centaur_size_cache,\n#endif\n\t.c_x86_vendor\t= X86_VENDOR_CENTAUR,\n};\n\ncpu_dev_register(centaur_cpu_dev);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}