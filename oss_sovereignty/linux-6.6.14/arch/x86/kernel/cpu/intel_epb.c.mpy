{
  "module_name": "intel_epb.c",
  "hash_id": "1ae6cb52620fcb5253f0b69835db7882275ffbc5510a14f8d4433559a1dbfd41",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/cpu/intel_epb.c",
  "human_readable_source": "\n \n\n#include <linux/cpuhotplug.h>\n#include <linux/cpu.h>\n#include <linux/device.h>\n#include <linux/kernel.h>\n#include <linux/string.h>\n#include <linux/syscore_ops.h>\n#include <linux/pm.h>\n\n#include <asm/cpu_device_id.h>\n#include <asm/cpufeature.h>\n#include <asm/msr.h>\n\n \n\nstatic DEFINE_PER_CPU(u8, saved_epb);\n\n#define EPB_MASK\t0x0fULL\n#define EPB_SAVED\t0x10ULL\n#define MAX_EPB\t\tEPB_MASK\n\nenum energy_perf_value_index {\n\tEPB_INDEX_PERFORMANCE,\n\tEPB_INDEX_BALANCE_PERFORMANCE,\n\tEPB_INDEX_NORMAL,\n\tEPB_INDEX_BALANCE_POWERSAVE,\n\tEPB_INDEX_POWERSAVE,\n};\n\nstatic u8 energ_perf_values[] = {\n\t[EPB_INDEX_PERFORMANCE] = ENERGY_PERF_BIAS_PERFORMANCE,\n\t[EPB_INDEX_BALANCE_PERFORMANCE] = ENERGY_PERF_BIAS_BALANCE_PERFORMANCE,\n\t[EPB_INDEX_NORMAL] = ENERGY_PERF_BIAS_NORMAL,\n\t[EPB_INDEX_BALANCE_POWERSAVE] = ENERGY_PERF_BIAS_BALANCE_POWERSAVE,\n\t[EPB_INDEX_POWERSAVE] = ENERGY_PERF_BIAS_POWERSAVE,\n};\n\nstatic int intel_epb_save(void)\n{\n\tu64 epb;\n\n\trdmsrl(MSR_IA32_ENERGY_PERF_BIAS, epb);\n\t \n\tthis_cpu_write(saved_epb, (epb & EPB_MASK) | EPB_SAVED);\n\n\treturn 0;\n}\n\nstatic void intel_epb_restore(void)\n{\n\tu64 val = this_cpu_read(saved_epb);\n\tu64 epb;\n\n\trdmsrl(MSR_IA32_ENERGY_PERF_BIAS, epb);\n\tif (val) {\n\t\tval &= EPB_MASK;\n\t} else {\n\t\t \n\t\tval = epb & EPB_MASK;\n\t\tif (val == ENERGY_PERF_BIAS_PERFORMANCE) {\n\t\t\tval = energ_perf_values[EPB_INDEX_NORMAL];\n\t\t\tpr_warn_once(\"ENERGY_PERF_BIAS: Set to 'normal', was 'performance'\\n\");\n\t\t}\n\t}\n\twrmsrl(MSR_IA32_ENERGY_PERF_BIAS, (epb & ~EPB_MASK) | val);\n}\n\nstatic struct syscore_ops intel_epb_syscore_ops = {\n\t.suspend = intel_epb_save,\n\t.resume = intel_epb_restore,\n};\n\nstatic const char * const energy_perf_strings[] = {\n\t[EPB_INDEX_PERFORMANCE] = \"performance\",\n\t[EPB_INDEX_BALANCE_PERFORMANCE] = \"balance-performance\",\n\t[EPB_INDEX_NORMAL] = \"normal\",\n\t[EPB_INDEX_BALANCE_POWERSAVE] = \"balance-power\",\n\t[EPB_INDEX_POWERSAVE] = \"power\",\n};\n\nstatic ssize_t energy_perf_bias_show(struct device *dev,\n\t\t\t\t     struct device_attribute *attr,\n\t\t\t\t     char *buf)\n{\n\tunsigned int cpu = dev->id;\n\tu64 epb;\n\tint ret;\n\n\tret = rdmsrl_on_cpu(cpu, MSR_IA32_ENERGY_PERF_BIAS, &epb);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn sprintf(buf, \"%llu\\n\", epb);\n}\n\nstatic ssize_t energy_perf_bias_store(struct device *dev,\n\t\t\t\t      struct device_attribute *attr,\n\t\t\t\t      const char *buf, size_t count)\n{\n\tunsigned int cpu = dev->id;\n\tu64 epb, val;\n\tint ret;\n\n\tret = __sysfs_match_string(energy_perf_strings,\n\t\t\t\t   ARRAY_SIZE(energy_perf_strings), buf);\n\tif (ret >= 0)\n\t\tval = energ_perf_values[ret];\n\telse if (kstrtou64(buf, 0, &val) || val > MAX_EPB)\n\t\treturn -EINVAL;\n\n\tret = rdmsrl_on_cpu(cpu, MSR_IA32_ENERGY_PERF_BIAS, &epb);\n\tif (ret < 0)\n\t\treturn ret;\n\n\tret = wrmsrl_on_cpu(cpu, MSR_IA32_ENERGY_PERF_BIAS,\n\t\t\t    (epb & ~EPB_MASK) | val);\n\tif (ret < 0)\n\t\treturn ret;\n\n\treturn count;\n}\n\nstatic DEVICE_ATTR_RW(energy_perf_bias);\n\nstatic struct attribute *intel_epb_attrs[] = {\n\t&dev_attr_energy_perf_bias.attr,\n\tNULL\n};\n\nstatic const struct attribute_group intel_epb_attr_group = {\n\t.name = power_group_name,\n\t.attrs =  intel_epb_attrs\n};\n\nstatic int intel_epb_online(unsigned int cpu)\n{\n\tstruct device *cpu_dev = get_cpu_device(cpu);\n\n\tintel_epb_restore();\n\tif (!cpuhp_tasks_frozen)\n\t\tsysfs_merge_group(&cpu_dev->kobj, &intel_epb_attr_group);\n\n\treturn 0;\n}\n\nstatic int intel_epb_offline(unsigned int cpu)\n{\n\tstruct device *cpu_dev = get_cpu_device(cpu);\n\n\tif (!cpuhp_tasks_frozen)\n\t\tsysfs_unmerge_group(&cpu_dev->kobj, &intel_epb_attr_group);\n\n\tintel_epb_save();\n\treturn 0;\n}\n\nstatic const struct x86_cpu_id intel_epb_normal[] = {\n\tX86_MATCH_INTEL_FAM6_MODEL(ALDERLAKE_L,\n\t\t\t\t   ENERGY_PERF_BIAS_NORMAL_POWERSAVE),\n\tX86_MATCH_INTEL_FAM6_MODEL(ATOM_GRACEMONT,\n\t\t\t\t   ENERGY_PERF_BIAS_NORMAL_POWERSAVE),\n\tX86_MATCH_INTEL_FAM6_MODEL(RAPTORLAKE_P,\n\t\t\t\t   ENERGY_PERF_BIAS_NORMAL_POWERSAVE),\n\t{}\n};\n\nstatic __init int intel_epb_init(void)\n{\n\tconst struct x86_cpu_id *id = x86_match_cpu(intel_epb_normal);\n\tint ret;\n\n\tif (!boot_cpu_has(X86_FEATURE_EPB))\n\t\treturn -ENODEV;\n\n\tif (id)\n\t\tenerg_perf_values[EPB_INDEX_NORMAL] = id->driver_data;\n\n\tret = cpuhp_setup_state(CPUHP_AP_X86_INTEL_EPB_ONLINE,\n\t\t\t\t\"x86/intel/epb:online\", intel_epb_online,\n\t\t\t\tintel_epb_offline);\n\tif (ret < 0)\n\t\tgoto err_out_online;\n\n\tregister_syscore_ops(&intel_epb_syscore_ops);\n\treturn 0;\n\nerr_out_online:\n\tcpuhp_remove_state(CPUHP_AP_X86_INTEL_EPB_ONLINE);\n\treturn ret;\n}\nsubsys_initcall(intel_epb_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}