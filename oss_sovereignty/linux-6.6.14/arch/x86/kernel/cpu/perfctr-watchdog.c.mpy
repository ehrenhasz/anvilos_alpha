{
  "module_name": "perfctr-watchdog.c",
  "hash_id": "b0a1b7855368c03adc97c47a18f7d7533c35e4ff5f28427a1ac2a519dfb578ff",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/cpu/perfctr-watchdog.c",
  "human_readable_source": "\n \n\n#include <linux/percpu.h>\n#include <linux/export.h>\n#include <linux/kernel.h>\n#include <linux/bitops.h>\n#include <linux/smp.h>\n#include <asm/nmi.h>\n#include <linux/kprobes.h>\n\n#include <asm/apic.h>\n#include <asm/perf_event.h>\n\n \n#define NMI_MAX_COUNTER_BITS 66\n\n \nstatic DECLARE_BITMAP(perfctr_nmi_owner, NMI_MAX_COUNTER_BITS);\nstatic DECLARE_BITMAP(evntsel_nmi_owner, NMI_MAX_COUNTER_BITS);\n\n \nstatic inline unsigned int nmi_perfctr_msr_to_bit(unsigned int msr)\n{\n\t \n\tswitch (boot_cpu_data.x86_vendor) {\n\tcase X86_VENDOR_HYGON:\n\tcase X86_VENDOR_AMD:\n\t\tif (msr >= MSR_F15H_PERF_CTR)\n\t\t\treturn (msr - MSR_F15H_PERF_CTR) >> 1;\n\t\treturn msr - MSR_K7_PERFCTR0;\n\tcase X86_VENDOR_INTEL:\n\t\tif (cpu_has(&boot_cpu_data, X86_FEATURE_ARCH_PERFMON))\n\t\t\treturn msr - MSR_ARCH_PERFMON_PERFCTR0;\n\n\t\tswitch (boot_cpu_data.x86) {\n\t\tcase 6:\n\t\t\treturn msr - MSR_P6_PERFCTR0;\n\t\tcase 11:\n\t\t\treturn msr - MSR_KNC_PERFCTR0;\n\t\tcase 15:\n\t\t\treturn msr - MSR_P4_BPU_PERFCTR0;\n\t\t}\n\t\tbreak;\n\tcase X86_VENDOR_ZHAOXIN:\n\tcase X86_VENDOR_CENTAUR:\n\t\treturn msr - MSR_ARCH_PERFMON_PERFCTR0;\n\t}\n\treturn 0;\n}\n\n \nstatic inline unsigned int nmi_evntsel_msr_to_bit(unsigned int msr)\n{\n\t \n\tswitch (boot_cpu_data.x86_vendor) {\n\tcase X86_VENDOR_HYGON:\n\tcase X86_VENDOR_AMD:\n\t\tif (msr >= MSR_F15H_PERF_CTL)\n\t\t\treturn (msr - MSR_F15H_PERF_CTL) >> 1;\n\t\treturn msr - MSR_K7_EVNTSEL0;\n\tcase X86_VENDOR_INTEL:\n\t\tif (cpu_has(&boot_cpu_data, X86_FEATURE_ARCH_PERFMON))\n\t\t\treturn msr - MSR_ARCH_PERFMON_EVENTSEL0;\n\n\t\tswitch (boot_cpu_data.x86) {\n\t\tcase 6:\n\t\t\treturn msr - MSR_P6_EVNTSEL0;\n\t\tcase 11:\n\t\t\treturn msr - MSR_KNC_EVNTSEL0;\n\t\tcase 15:\n\t\t\treturn msr - MSR_P4_BSU_ESCR0;\n\t\t}\n\t\tbreak;\n\tcase X86_VENDOR_ZHAOXIN:\n\tcase X86_VENDOR_CENTAUR:\n\t\treturn msr - MSR_ARCH_PERFMON_EVENTSEL0;\n\t}\n\treturn 0;\n\n}\n\nint reserve_perfctr_nmi(unsigned int msr)\n{\n\tunsigned int counter;\n\n\tcounter = nmi_perfctr_msr_to_bit(msr);\n\t \n\tif (counter > NMI_MAX_COUNTER_BITS)\n\t\treturn 1;\n\n\tif (!test_and_set_bit(counter, perfctr_nmi_owner))\n\t\treturn 1;\n\treturn 0;\n}\nEXPORT_SYMBOL(reserve_perfctr_nmi);\n\nvoid release_perfctr_nmi(unsigned int msr)\n{\n\tunsigned int counter;\n\n\tcounter = nmi_perfctr_msr_to_bit(msr);\n\t \n\tif (counter > NMI_MAX_COUNTER_BITS)\n\t\treturn;\n\n\tclear_bit(counter, perfctr_nmi_owner);\n}\nEXPORT_SYMBOL(release_perfctr_nmi);\n\nint reserve_evntsel_nmi(unsigned int msr)\n{\n\tunsigned int counter;\n\n\tcounter = nmi_evntsel_msr_to_bit(msr);\n\t \n\tif (counter > NMI_MAX_COUNTER_BITS)\n\t\treturn 1;\n\n\tif (!test_and_set_bit(counter, evntsel_nmi_owner))\n\t\treturn 1;\n\treturn 0;\n}\nEXPORT_SYMBOL(reserve_evntsel_nmi);\n\nvoid release_evntsel_nmi(unsigned int msr)\n{\n\tunsigned int counter;\n\n\tcounter = nmi_evntsel_msr_to_bit(msr);\n\t \n\tif (counter > NMI_MAX_COUNTER_BITS)\n\t\treturn;\n\n\tclear_bit(counter, evntsel_nmi_owner);\n}\nEXPORT_SYMBOL(release_evntsel_nmi);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}