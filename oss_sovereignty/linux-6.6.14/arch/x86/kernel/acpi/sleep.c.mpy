{
  "module_name": "sleep.c",
  "hash_id": "a6f89802ba3b03bedb7341e2415c6a69579828080c89f0c93112419c4c31931d",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/acpi/sleep.c",
  "human_readable_source": "\n \n\n#include <linux/acpi.h>\n#include <linux/memblock.h>\n#include <linux/dmi.h>\n#include <linux/cpumask.h>\n#include <linux/pgtable.h>\n#include <asm/segment.h>\n#include <asm/desc.h>\n#include <asm/cacheflush.h>\n#include <asm/realmode.h>\n#include <asm/hypervisor.h>\n#include <asm/smp.h>\n\n#include <linux/ftrace.h>\n#include \"../../realmode/rm/wakeup.h\"\n#include \"sleep.h\"\n\nunsigned long acpi_realmode_flags;\n\n#if defined(CONFIG_SMP) && defined(CONFIG_64BIT)\nstatic char temp_stack[4096];\n#endif\n\n \nunsigned long acpi_get_wakeup_address(void)\n{\n\treturn ((unsigned long)(real_mode_header->wakeup_start));\n}\n\n \nasmlinkage acpi_status __visible x86_acpi_enter_sleep_state(u8 state)\n{\n\treturn acpi_enter_sleep_state(state);\n}\n\n \nint x86_acpi_suspend_lowlevel(void)\n{\n\tstruct wakeup_header *header =\n\t\t(struct wakeup_header *) __va(real_mode_header->wakeup_header);\n\n\tif (header->signature != WAKEUP_HEADER_SIGNATURE) {\n\t\tprintk(KERN_ERR \"wakeup header does not match\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\theader->video_mode = saved_video_mode;\n\n\theader->pmode_behavior = 0;\n\n#ifndef CONFIG_64BIT\n\tnative_store_gdt((struct desc_ptr *)&header->pmode_gdt);\n\n\t \n\tif (!rdmsr_safe(MSR_EFER,\n\t\t\t&header->pmode_efer_low,\n\t\t\t&header->pmode_efer_high) &&\n\t    !wrmsr_safe(MSR_EFER,\n\t\t\theader->pmode_efer_low,\n\t\t\theader->pmode_efer_high))\n\t\theader->pmode_behavior |= (1 << WAKEUP_BEHAVIOR_RESTORE_EFER);\n#endif  \n\n\theader->pmode_cr0 = read_cr0();\n\tif (__this_cpu_read(cpu_info.cpuid_level) >= 0) {\n\t\theader->pmode_cr4 = __read_cr4();\n\t\theader->pmode_behavior |= (1 << WAKEUP_BEHAVIOR_RESTORE_CR4);\n\t}\n\tif (!rdmsr_safe(MSR_IA32_MISC_ENABLE,\n\t\t\t&header->pmode_misc_en_low,\n\t\t\t&header->pmode_misc_en_high) &&\n\t    !wrmsr_safe(MSR_IA32_MISC_ENABLE,\n\t\t\theader->pmode_misc_en_low,\n\t\t\theader->pmode_misc_en_high))\n\t\theader->pmode_behavior |=\n\t\t\t(1 << WAKEUP_BEHAVIOR_RESTORE_MISC_ENABLE);\n\theader->realmode_flags = acpi_realmode_flags;\n\theader->real_magic = 0x12345678;\n\n#ifndef CONFIG_64BIT\n\theader->pmode_entry = (u32)&wakeup_pmode_return;\n\theader->pmode_cr3 = (u32)__pa_symbol(initial_page_table);\n\tsaved_magic = 0x12345678;\n#else  \n#ifdef CONFIG_SMP\n\t \n\tcurrent->thread.sp = (unsigned long)temp_stack + sizeof(temp_stack);\n\t \n\tif (!(smpboot_control & STARTUP_PARALLEL_MASK))\n\t\tsmpboot_control = smp_processor_id();\n#endif\n\tinitial_code = (unsigned long)wakeup_long64;\n\tsaved_magic = 0x123456789abcdef0L;\n#endif  \n\n\t \n\tpause_graph_tracing();\n\tdo_suspend_lowlevel();\n\tunpause_graph_tracing();\n\treturn 0;\n}\n\nstatic int __init acpi_sleep_setup(char *str)\n{\n\twhile ((str != NULL) && (*str != '\\0')) {\n\t\tif (strncmp(str, \"s3_bios\", 7) == 0)\n\t\t\tacpi_realmode_flags |= 1;\n\t\tif (strncmp(str, \"s3_mode\", 7) == 0)\n\t\t\tacpi_realmode_flags |= 2;\n\t\tif (strncmp(str, \"s3_beep\", 7) == 0)\n\t\t\tacpi_realmode_flags |= 4;\n#ifdef CONFIG_HIBERNATION\n\t\tif (strncmp(str, \"s4_hwsig\", 8) == 0)\n\t\t\tacpi_check_s4_hw_signature = 1;\n\t\tif (strncmp(str, \"s4_nohwsig\", 10) == 0)\n\t\t\tacpi_check_s4_hw_signature = 0;\n#endif\n\t\tif (strncmp(str, \"nonvs\", 5) == 0)\n\t\t\tacpi_nvs_nosave();\n\t\tif (strncmp(str, \"nonvs_s3\", 8) == 0)\n\t\t\tacpi_nvs_nosave_s3();\n\t\tif (strncmp(str, \"old_ordering\", 12) == 0)\n\t\t\tacpi_old_suspend_ordering();\n\t\tif (strncmp(str, \"nobl\", 4) == 0)\n\t\t\tacpi_sleep_no_blacklist();\n\t\tstr = strchr(str, ',');\n\t\tif (str != NULL)\n\t\t\tstr += strspn(str, \", \\t\");\n\t}\n\treturn 1;\n}\n\n__setup(\"acpi_sleep=\", acpi_sleep_setup);\n\n#if defined(CONFIG_HIBERNATION) && defined(CONFIG_HYPERVISOR_GUEST)\nstatic int __init init_s4_sigcheck(void)\n{\n\t \n\tif (acpi_check_s4_hw_signature == -1 &&\n\t    !hypervisor_is_type(X86_HYPER_NATIVE))\n\t\tacpi_check_s4_hw_signature = 1;\n\n\treturn 0;\n}\n \narch_initcall(init_s4_sigcheck);\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}