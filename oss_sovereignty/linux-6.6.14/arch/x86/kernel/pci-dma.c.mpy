{
  "module_name": "pci-dma.c",
  "hash_id": "add0e3fbbae4657b84c29849f72a8291073dba6c6688b1a66005b1e81678d2f5",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/pci-dma.c",
  "human_readable_source": "\n#include <linux/dma-map-ops.h>\n#include <linux/dma-direct.h>\n#include <linux/iommu.h>\n#include <linux/dmar.h>\n#include <linux/export.h>\n#include <linux/memblock.h>\n#include <linux/gfp.h>\n#include <linux/pci.h>\n#include <linux/amd-iommu.h>\n\n#include <asm/proto.h>\n#include <asm/dma.h>\n#include <asm/iommu.h>\n#include <asm/gart.h>\n#include <asm/x86_init.h>\n\n#include <xen/xen.h>\n#include <xen/swiotlb-xen.h>\n\nstatic bool disable_dac_quirk __read_mostly;\n\nconst struct dma_map_ops *dma_ops;\nEXPORT_SYMBOL(dma_ops);\n\n#ifdef CONFIG_IOMMU_DEBUG\nint panic_on_overflow __read_mostly = 1;\nint force_iommu __read_mostly = 1;\n#else\nint panic_on_overflow __read_mostly = 0;\nint force_iommu __read_mostly = 0;\n#endif\n\nint iommu_merge __read_mostly = 0;\n\nint no_iommu __read_mostly;\n \nint iommu_detected __read_mostly = 0;\n\n#ifdef CONFIG_SWIOTLB\nbool x86_swiotlb_enable;\nstatic unsigned int x86_swiotlb_flags;\n\nstatic void __init pci_swiotlb_detect(void)\n{\n\t \n\tif (!no_iommu && max_possible_pfn > MAX_DMA32_PFN)\n\t\tx86_swiotlb_enable = true;\n\n\t \n\tif (cc_platform_has(CC_ATTR_HOST_MEM_ENCRYPT))\n\t\tx86_swiotlb_enable = true;\n\n\t \n\tif (cc_platform_has(CC_ATTR_GUEST_MEM_ENCRYPT)) {\n\t\tx86_swiotlb_enable = true;\n\t\tx86_swiotlb_flags |= SWIOTLB_FORCE;\n\t}\n}\n#else\nstatic inline void __init pci_swiotlb_detect(void)\n{\n}\n#define x86_swiotlb_flags 0\n#endif  \n\n#ifdef CONFIG_SWIOTLB_XEN\nstatic bool xen_swiotlb_enabled(void)\n{\n\treturn xen_initial_domain() || x86_swiotlb_enable ||\n\t\t(IS_ENABLED(CONFIG_XEN_PCIDEV_FRONTEND) && xen_pv_pci_possible);\n}\n\nstatic void __init pci_xen_swiotlb_init(void)\n{\n\tif (!xen_swiotlb_enabled())\n\t\treturn;\n\tx86_swiotlb_enable = true;\n\tx86_swiotlb_flags |= SWIOTLB_ANY;\n\tswiotlb_init_remap(true, x86_swiotlb_flags, xen_swiotlb_fixup);\n\tdma_ops = &xen_swiotlb_dma_ops;\n\tif (IS_ENABLED(CONFIG_PCI))\n\t\tpci_request_acs();\n}\n#else\nstatic inline void __init pci_xen_swiotlb_init(void)\n{\n}\n#endif  \n\nvoid __init pci_iommu_alloc(void)\n{\n\tif (xen_pv_domain()) {\n\t\tpci_xen_swiotlb_init();\n\t\treturn;\n\t}\n\tpci_swiotlb_detect();\n\tgart_iommu_hole_init();\n\tamd_iommu_detect();\n\tdetect_intel_iommu();\n\tswiotlb_init(x86_swiotlb_enable, x86_swiotlb_flags);\n}\n\n \nstatic __init int iommu_setup(char *p)\n{\n\tiommu_merge = 1;\n\n\tif (!p)\n\t\treturn -EINVAL;\n\n\twhile (*p) {\n\t\tif (!strncmp(p, \"off\", 3))\n\t\t\tno_iommu = 1;\n\t\t \n\t\tif (!strncmp(p, \"force\", 5))\n\t\t\tforce_iommu = 1;\n\t\tif (!strncmp(p, \"noforce\", 7)) {\n\t\t\tiommu_merge = 0;\n\t\t\tforce_iommu = 0;\n\t\t}\n\n\t\tif (!strncmp(p, \"biomerge\", 8)) {\n\t\t\tiommu_merge = 1;\n\t\t\tforce_iommu = 1;\n\t\t}\n\t\tif (!strncmp(p, \"panic\", 5))\n\t\t\tpanic_on_overflow = 1;\n\t\tif (!strncmp(p, \"nopanic\", 7))\n\t\t\tpanic_on_overflow = 0;\n\t\tif (!strncmp(p, \"merge\", 5)) {\n\t\t\tiommu_merge = 1;\n\t\t\tforce_iommu = 1;\n\t\t}\n\t\tif (!strncmp(p, \"nomerge\", 7))\n\t\t\tiommu_merge = 0;\n\t\tif (!strncmp(p, \"forcesac\", 8))\n\t\t\tpr_warn(\"forcesac option ignored.\\n\");\n\t\tif (!strncmp(p, \"allowdac\", 8))\n\t\t\tpr_warn(\"allowdac option ignored.\\n\");\n\t\tif (!strncmp(p, \"nodac\", 5))\n\t\t\tpr_warn(\"nodac option ignored.\\n\");\n\t\tif (!strncmp(p, \"usedac\", 6)) {\n\t\t\tdisable_dac_quirk = true;\n\t\t\treturn 1;\n\t\t}\n#ifdef CONFIG_SWIOTLB\n\t\tif (!strncmp(p, \"soft\", 4))\n\t\t\tx86_swiotlb_enable = true;\n#endif\n\t\tif (!strncmp(p, \"pt\", 2))\n\t\t\tiommu_set_default_passthrough(true);\n\t\tif (!strncmp(p, \"nopt\", 4))\n\t\t\tiommu_set_default_translated(true);\n\n\t\tgart_parse_options(p);\n\n\t\tp += strcspn(p, \",\");\n\t\tif (*p == ',')\n\t\t\t++p;\n\t}\n\treturn 0;\n}\nearly_param(\"iommu\", iommu_setup);\n\nstatic int __init pci_iommu_init(void)\n{\n\tx86_init.iommu.iommu_init();\n\n#ifdef CONFIG_SWIOTLB\n\t \n\tif (x86_swiotlb_enable) {\n\t\tpr_info(\"PCI-DMA: Using software bounce buffering for IO (SWIOTLB)\\n\");\n\t\tswiotlb_print_info();\n\t} else {\n\t\tswiotlb_exit();\n\t}\n#endif\n\n\treturn 0;\n}\n \nrootfs_initcall(pci_iommu_init);\n\n#ifdef CONFIG_PCI\n \n\nstatic int via_no_dac_cb(struct pci_dev *pdev, void *data)\n{\n\tpdev->dev.bus_dma_limit = DMA_BIT_MASK(32);\n\treturn 0;\n}\n\nstatic void via_no_dac(struct pci_dev *dev)\n{\n\tif (!disable_dac_quirk) {\n\t\tdev_info(&dev->dev, \"disabling DAC on VIA PCI bridge\\n\");\n\t\tpci_walk_bus(dev->subordinate, via_no_dac_cb, NULL);\n\t}\n}\nDECLARE_PCI_FIXUP_CLASS_FINAL(PCI_VENDOR_ID_VIA, PCI_ANY_ID,\n\t\t\t\tPCI_CLASS_BRIDGE_PCI, 8, via_no_dac);\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}