{
  "module_name": "perf_regs.c",
  "hash_id": "e8ec99fa3ee15ec4321cf2e6805cb896338919f7b2242fc16ef1835c3cb27634",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/perf_regs.c",
  "human_readable_source": "\n#include <linux/errno.h>\n#include <linux/kernel.h>\n#include <linux/sched.h>\n#include <linux/sched/task_stack.h>\n#include <linux/perf_event.h>\n#include <linux/bug.h>\n#include <linux/stddef.h>\n#include <asm/perf_regs.h>\n#include <asm/ptrace.h>\n\n#ifdef CONFIG_X86_32\n#define PERF_REG_X86_MAX PERF_REG_X86_32_MAX\n#else\n#define PERF_REG_X86_MAX PERF_REG_X86_64_MAX\n#endif\n\n#define PT_REGS_OFFSET(id, r) [id] = offsetof(struct pt_regs, r)\n\nstatic unsigned int pt_regs_offset[PERF_REG_X86_MAX] = {\n\tPT_REGS_OFFSET(PERF_REG_X86_AX, ax),\n\tPT_REGS_OFFSET(PERF_REG_X86_BX, bx),\n\tPT_REGS_OFFSET(PERF_REG_X86_CX, cx),\n\tPT_REGS_OFFSET(PERF_REG_X86_DX, dx),\n\tPT_REGS_OFFSET(PERF_REG_X86_SI, si),\n\tPT_REGS_OFFSET(PERF_REG_X86_DI, di),\n\tPT_REGS_OFFSET(PERF_REG_X86_BP, bp),\n\tPT_REGS_OFFSET(PERF_REG_X86_SP, sp),\n\tPT_REGS_OFFSET(PERF_REG_X86_IP, ip),\n\tPT_REGS_OFFSET(PERF_REG_X86_FLAGS, flags),\n\tPT_REGS_OFFSET(PERF_REG_X86_CS, cs),\n\tPT_REGS_OFFSET(PERF_REG_X86_SS, ss),\n#ifdef CONFIG_X86_32\n\tPT_REGS_OFFSET(PERF_REG_X86_DS, ds),\n\tPT_REGS_OFFSET(PERF_REG_X86_ES, es),\n\tPT_REGS_OFFSET(PERF_REG_X86_FS, fs),\n\tPT_REGS_OFFSET(PERF_REG_X86_GS, gs),\n#else\n\t \n\t(unsigned int) -1,\n\t(unsigned int) -1,\n\t(unsigned int) -1,\n\t(unsigned int) -1,\n#endif\n#ifdef CONFIG_X86_64\n\tPT_REGS_OFFSET(PERF_REG_X86_R8, r8),\n\tPT_REGS_OFFSET(PERF_REG_X86_R9, r9),\n\tPT_REGS_OFFSET(PERF_REG_X86_R10, r10),\n\tPT_REGS_OFFSET(PERF_REG_X86_R11, r11),\n\tPT_REGS_OFFSET(PERF_REG_X86_R12, r12),\n\tPT_REGS_OFFSET(PERF_REG_X86_R13, r13),\n\tPT_REGS_OFFSET(PERF_REG_X86_R14, r14),\n\tPT_REGS_OFFSET(PERF_REG_X86_R15, r15),\n#endif\n};\n\nu64 perf_reg_value(struct pt_regs *regs, int idx)\n{\n\tstruct x86_perf_regs *perf_regs;\n\n\tif (idx >= PERF_REG_X86_XMM0 && idx < PERF_REG_X86_XMM_MAX) {\n\t\tperf_regs = container_of(regs, struct x86_perf_regs, regs);\n\t\tif (!perf_regs->xmm_regs)\n\t\t\treturn 0;\n\t\treturn perf_regs->xmm_regs[idx - PERF_REG_X86_XMM0];\n\t}\n\n\tif (WARN_ON_ONCE(idx >= ARRAY_SIZE(pt_regs_offset)))\n\t\treturn 0;\n\n\treturn regs_get_register(regs, pt_regs_offset[idx]);\n}\n\n#define PERF_REG_X86_RESERVED\t(((1ULL << PERF_REG_X86_XMM0) - 1) & \\\n\t\t\t\t ~((1ULL << PERF_REG_X86_MAX) - 1))\n\n#ifdef CONFIG_X86_32\n#define REG_NOSUPPORT ((1ULL << PERF_REG_X86_R8) | \\\n\t\t       (1ULL << PERF_REG_X86_R9) | \\\n\t\t       (1ULL << PERF_REG_X86_R10) | \\\n\t\t       (1ULL << PERF_REG_X86_R11) | \\\n\t\t       (1ULL << PERF_REG_X86_R12) | \\\n\t\t       (1ULL << PERF_REG_X86_R13) | \\\n\t\t       (1ULL << PERF_REG_X86_R14) | \\\n\t\t       (1ULL << PERF_REG_X86_R15))\n\nint perf_reg_validate(u64 mask)\n{\n\tif (!mask || (mask & (REG_NOSUPPORT | PERF_REG_X86_RESERVED)))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nu64 perf_reg_abi(struct task_struct *task)\n{\n\treturn PERF_SAMPLE_REGS_ABI_32;\n}\n\nvoid perf_get_regs_user(struct perf_regs *regs_user,\n\t\t\tstruct pt_regs *regs)\n{\n\tregs_user->regs = task_pt_regs(current);\n\tregs_user->abi = perf_reg_abi(current);\n}\n#else  \n#define REG_NOSUPPORT ((1ULL << PERF_REG_X86_DS) | \\\n\t\t       (1ULL << PERF_REG_X86_ES) | \\\n\t\t       (1ULL << PERF_REG_X86_FS) | \\\n\t\t       (1ULL << PERF_REG_X86_GS))\n\nint perf_reg_validate(u64 mask)\n{\n\tif (!mask || (mask & (REG_NOSUPPORT | PERF_REG_X86_RESERVED)))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nu64 perf_reg_abi(struct task_struct *task)\n{\n\tif (!user_64bit_mode(task_pt_regs(task)))\n\t\treturn PERF_SAMPLE_REGS_ABI_32;\n\telse\n\t\treturn PERF_SAMPLE_REGS_ABI_64;\n}\n\nstatic DEFINE_PER_CPU(struct pt_regs, nmi_user_regs);\n\nvoid perf_get_regs_user(struct perf_regs *regs_user,\n\t\t\tstruct pt_regs *regs)\n{\n\tstruct pt_regs *regs_user_copy = this_cpu_ptr(&nmi_user_regs);\n\tstruct pt_regs *user_regs = task_pt_regs(current);\n\n\tif (!in_nmi()) {\n\t\tregs_user->regs = user_regs;\n\t\tregs_user->abi = perf_reg_abi(current);\n\t\treturn;\n\t}\n\n\t \n\tif (regs->sp > (unsigned long)&user_regs->r11 &&\n\t    regs->sp <= (unsigned long)(user_regs + 1)) {\n\t\tregs_user->abi = PERF_SAMPLE_REGS_ABI_NONE;\n\t\tregs_user->regs = NULL;\n\t\treturn;\n\t}\n\n\t \n\tregs_user_copy->ip = user_regs->ip;\n\tregs_user_copy->ax = user_regs->ax;\n\tregs_user_copy->cx = user_regs->cx;\n\tregs_user_copy->dx = user_regs->dx;\n\tregs_user_copy->si = user_regs->si;\n\tregs_user_copy->di = user_regs->di;\n\tregs_user_copy->r8 = user_regs->r8;\n\tregs_user_copy->r9 = user_regs->r9;\n\tregs_user_copy->r10 = user_regs->r10;\n\tregs_user_copy->r11 = user_regs->r11;\n\tregs_user_copy->orig_ax = user_regs->orig_ax;\n\tregs_user_copy->flags = user_regs->flags;\n\tregs_user_copy->sp = user_regs->sp;\n\tregs_user_copy->cs = user_regs->cs;\n\tregs_user_copy->ss = user_regs->ss;\n\t \n\tregs_user_copy->bp = user_regs->bp;\n\n\tregs_user_copy->bx = -1;\n\tregs_user_copy->r12 = -1;\n\tregs_user_copy->r13 = -1;\n\tregs_user_copy->r14 = -1;\n\tregs_user_copy->r15 = -1;\n\t \n\tregs_user->abi = user_64bit_mode(user_regs) ?\n\t\tPERF_SAMPLE_REGS_ABI_64 : PERF_SAMPLE_REGS_ABI_32;\n\n\tregs_user->regs = regs_user_copy;\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}