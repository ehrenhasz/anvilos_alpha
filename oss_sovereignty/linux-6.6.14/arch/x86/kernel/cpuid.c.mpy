{
  "module_name": "cpuid.c",
  "hash_id": "5b7aed17405e8927d57b8850f2ba7b49a974d3ee2265a39a5f9ab7e5f581da17",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/cpuid.c",
  "human_readable_source": "\n \n\n \n\n#include <linux/module.h>\n\n#include <linux/types.h>\n#include <linux/errno.h>\n#include <linux/fcntl.h>\n#include <linux/init.h>\n#include <linux/poll.h>\n#include <linux/smp.h>\n#include <linux/major.h>\n#include <linux/fs.h>\n#include <linux/device.h>\n#include <linux/cpu.h>\n#include <linux/notifier.h>\n#include <linux/uaccess.h>\n#include <linux/gfp.h>\n#include <linux/completion.h>\n\n#include <asm/processor.h>\n#include <asm/msr.h>\n\nstatic enum cpuhp_state cpuhp_cpuid_state;\n\nstruct cpuid_regs_done {\n\tstruct cpuid_regs regs;\n\tstruct completion done;\n};\n\nstatic void cpuid_smp_cpuid(void *cmd_block)\n{\n\tstruct cpuid_regs_done *cmd = cmd_block;\n\n\tcpuid_count(cmd->regs.eax, cmd->regs.ecx,\n\t\t    &cmd->regs.eax, &cmd->regs.ebx,\n\t\t    &cmd->regs.ecx, &cmd->regs.edx);\n\n\tcomplete(&cmd->done);\n}\n\nstatic ssize_t cpuid_read(struct file *file, char __user *buf,\n\t\t\t  size_t count, loff_t *ppos)\n{\n\tchar __user *tmp = buf;\n\tstruct cpuid_regs_done cmd;\n\tint cpu = iminor(file_inode(file));\n\tu64 pos = *ppos;\n\tssize_t bytes = 0;\n\tint err = 0;\n\n\tif (count % 16)\n\t\treturn -EINVAL;\t \n\n\tinit_completion(&cmd.done);\n\tfor (; count; count -= 16) {\n\t\tcall_single_data_t csd;\n\n\t\tINIT_CSD(&csd, cpuid_smp_cpuid, &cmd);\n\n\t\tcmd.regs.eax = pos;\n\t\tcmd.regs.ecx = pos >> 32;\n\n\t\terr = smp_call_function_single_async(cpu, &csd);\n\t\tif (err)\n\t\t\tbreak;\n\t\twait_for_completion(&cmd.done);\n\t\tif (copy_to_user(tmp, &cmd.regs, 16)) {\n\t\t\terr = -EFAULT;\n\t\t\tbreak;\n\t\t}\n\t\ttmp += 16;\n\t\tbytes += 16;\n\t\t*ppos = ++pos;\n\t\treinit_completion(&cmd.done);\n\t}\n\n\treturn bytes ? bytes : err;\n}\n\nstatic int cpuid_open(struct inode *inode, struct file *file)\n{\n\tunsigned int cpu;\n\tstruct cpuinfo_x86 *c;\n\n\tcpu = iminor(file_inode(file));\n\tif (cpu >= nr_cpu_ids || !cpu_online(cpu))\n\t\treturn -ENXIO;\t \n\n\tc = &cpu_data(cpu);\n\tif (c->cpuid_level < 0)\n\t\treturn -EIO;\t \n\n\treturn 0;\n}\n\n \nstatic const struct file_operations cpuid_fops = {\n\t.owner = THIS_MODULE,\n\t.llseek = no_seek_end_llseek,\n\t.read = cpuid_read,\n\t.open = cpuid_open,\n};\n\nstatic char *cpuid_devnode(const struct device *dev, umode_t *mode)\n{\n\treturn kasprintf(GFP_KERNEL, \"cpu/%u/cpuid\", MINOR(dev->devt));\n}\n\nstatic const struct class cpuid_class = {\n\t.name\t\t= \"cpuid\",\n\t.devnode\t= cpuid_devnode,\n};\n\nstatic int cpuid_device_create(unsigned int cpu)\n{\n\tstruct device *dev;\n\n\tdev = device_create(&cpuid_class, NULL, MKDEV(CPUID_MAJOR, cpu), NULL,\n\t\t\t    \"cpu%d\", cpu);\n\treturn PTR_ERR_OR_ZERO(dev);\n}\n\nstatic int cpuid_device_destroy(unsigned int cpu)\n{\n\tdevice_destroy(&cpuid_class, MKDEV(CPUID_MAJOR, cpu));\n\treturn 0;\n}\n\nstatic int __init cpuid_init(void)\n{\n\tint err;\n\n\tif (__register_chrdev(CPUID_MAJOR, 0, NR_CPUS,\n\t\t\t      \"cpu/cpuid\", &cpuid_fops)) {\n\t\tprintk(KERN_ERR \"cpuid: unable to get major %d for cpuid\\n\",\n\t\t       CPUID_MAJOR);\n\t\treturn -EBUSY;\n\t}\n\terr = class_register(&cpuid_class);\n\tif (err)\n\t\tgoto out_chrdev;\n\n\terr = cpuhp_setup_state(CPUHP_AP_ONLINE_DYN, \"x86/cpuid:online\",\n\t\t\t\tcpuid_device_create, cpuid_device_destroy);\n\tif (err < 0)\n\t\tgoto out_class;\n\n\tcpuhp_cpuid_state = err;\n\treturn 0;\n\nout_class:\n\tclass_unregister(&cpuid_class);\nout_chrdev:\n\t__unregister_chrdev(CPUID_MAJOR, 0, NR_CPUS, \"cpu/cpuid\");\n\treturn err;\n}\nmodule_init(cpuid_init);\n\nstatic void __exit cpuid_exit(void)\n{\n\tcpuhp_remove_state(cpuhp_cpuid_state);\n\tclass_unregister(&cpuid_class);\n\t__unregister_chrdev(CPUID_MAJOR, 0, NR_CPUS, \"cpu/cpuid\");\n}\nmodule_exit(cpuid_exit);\n\nMODULE_AUTHOR(\"H. Peter Anvin <hpa@zytor.com>\");\nMODULE_DESCRIPTION(\"x86 generic CPUID driver\");\nMODULE_LICENSE(\"GPL\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}