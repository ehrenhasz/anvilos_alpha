{
  "module_name": "x2apic_phys.c",
  "hash_id": "88087f71a678e778383692bb8bd572a570a4a1bc8683d7ba31c7897932582c69",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/apic/x2apic_phys.c",
  "human_readable_source": "\n\n#include <linux/cpumask.h>\n#include <linux/acpi.h>\n\n#include \"local.h\"\n\nint x2apic_phys;\n\nstatic struct apic apic_x2apic_phys;\nu32 x2apic_max_apicid __ro_after_init = UINT_MAX;\n\nvoid __init x2apic_set_max_apicid(u32 apicid)\n{\n\tx2apic_max_apicid = apicid;\n\tif (apic->x2apic_set_max_apicid)\n\t\tapic->max_apic_id = apicid;\n}\n\nstatic int __init set_x2apic_phys_mode(char *arg)\n{\n\tx2apic_phys = 1;\n\treturn 0;\n}\nearly_param(\"x2apic_phys\", set_x2apic_phys_mode);\n\nstatic bool x2apic_fadt_phys(void)\n{\n#ifdef CONFIG_ACPI\n\tif ((acpi_gbl_FADT.header.revision >= FADT2_REVISION_ID) &&\n\t\t(acpi_gbl_FADT.flags & ACPI_FADT_APIC_PHYSICAL)) {\n\t\tprintk(KERN_DEBUG \"System requires x2apic physical mode\\n\");\n\t\treturn true;\n\t}\n#endif\n\treturn false;\n}\n\nstatic int x2apic_acpi_madt_oem_check(char *oem_id, char *oem_table_id)\n{\n\treturn x2apic_enabled() && (x2apic_phys || x2apic_fadt_phys());\n}\n\nstatic void x2apic_send_IPI(int cpu, int vector)\n{\n\tu32 dest = per_cpu(x86_cpu_to_apicid, cpu);\n\n\t \n\tweak_wrmsr_fence();\n\t__x2apic_send_IPI_dest(dest, vector, APIC_DEST_PHYSICAL);\n}\n\nstatic void\n__x2apic_send_IPI_mask(const struct cpumask *mask, int vector, int apic_dest)\n{\n\tunsigned long query_cpu;\n\tunsigned long this_cpu;\n\tunsigned long flags;\n\n\t \n\tweak_wrmsr_fence();\n\n\tlocal_irq_save(flags);\n\n\tthis_cpu = smp_processor_id();\n\tfor_each_cpu(query_cpu, mask) {\n\t\tif (apic_dest == APIC_DEST_ALLBUT && this_cpu == query_cpu)\n\t\t\tcontinue;\n\t\t__x2apic_send_IPI_dest(per_cpu(x86_cpu_to_apicid, query_cpu),\n\t\t\t\t       vector, APIC_DEST_PHYSICAL);\n\t}\n\tlocal_irq_restore(flags);\n}\n\nstatic void x2apic_send_IPI_mask(const struct cpumask *mask, int vector)\n{\n\t__x2apic_send_IPI_mask(mask, vector, APIC_DEST_ALLINC);\n}\n\nstatic void\n x2apic_send_IPI_mask_allbutself(const struct cpumask *mask, int vector)\n{\n\t__x2apic_send_IPI_mask(mask, vector, APIC_DEST_ALLBUT);\n}\n\nstatic void __x2apic_send_IPI_shorthand(int vector, u32 which)\n{\n\tunsigned long cfg = __prepare_ICR(which, vector, 0);\n\n\t \n\tweak_wrmsr_fence();\n\tnative_x2apic_icr_write(cfg, 0);\n}\n\nvoid x2apic_send_IPI_allbutself(int vector)\n{\n\t__x2apic_send_IPI_shorthand(vector, APIC_DEST_ALLBUT);\n}\n\nvoid x2apic_send_IPI_all(int vector)\n{\n\t__x2apic_send_IPI_shorthand(vector, APIC_DEST_ALLINC);\n}\n\nvoid x2apic_send_IPI_self(int vector)\n{\n\tapic_write(APIC_SELF_IPI, vector);\n}\n\nvoid __x2apic_send_IPI_dest(unsigned int apicid, int vector, unsigned int dest)\n{\n\tunsigned long cfg = __prepare_ICR(0, vector, dest);\n\tnative_x2apic_icr_write(cfg, apicid);\n}\n\nstatic int x2apic_phys_probe(void)\n{\n\tif (!x2apic_mode)\n\t\treturn 0;\n\n\tif (x2apic_phys || x2apic_fadt_phys())\n\t\treturn 1;\n\n\treturn apic == &apic_x2apic_phys;\n}\n\nunsigned int x2apic_get_apic_id(unsigned long id)\n{\n\treturn id;\n}\n\nu32 x2apic_set_apic_id(unsigned int id)\n{\n\treturn id;\n}\n\nint x2apic_phys_pkg_id(int initial_apicid, int index_msb)\n{\n\treturn initial_apicid >> index_msb;\n}\n\nstatic struct apic apic_x2apic_phys __ro_after_init = {\n\n\t.name\t\t\t\t= \"physical x2apic\",\n\t.probe\t\t\t\t= x2apic_phys_probe,\n\t.acpi_madt_oem_check\t\t= x2apic_acpi_madt_oem_check,\n\n\t.delivery_mode\t\t\t= APIC_DELIVERY_MODE_FIXED,\n\t.dest_mode_logical\t\t= false,\n\n\t.disable_esr\t\t\t= 0,\n\n\t.cpu_present_to_apicid\t\t= default_cpu_present_to_apicid,\n\t.phys_pkg_id\t\t\t= x2apic_phys_pkg_id,\n\n\t.max_apic_id\t\t\t= UINT_MAX,\n\t.x2apic_set_max_apicid\t\t= true,\n\t.get_apic_id\t\t\t= x2apic_get_apic_id,\n\t.set_apic_id\t\t\t= x2apic_set_apic_id,\n\n\t.calc_dest_apicid\t\t= apic_default_calc_apicid,\n\n\t.send_IPI\t\t\t= x2apic_send_IPI,\n\t.send_IPI_mask\t\t\t= x2apic_send_IPI_mask,\n\t.send_IPI_mask_allbutself\t= x2apic_send_IPI_mask_allbutself,\n\t.send_IPI_allbutself\t\t= x2apic_send_IPI_allbutself,\n\t.send_IPI_all\t\t\t= x2apic_send_IPI_all,\n\t.send_IPI_self\t\t\t= x2apic_send_IPI_self,\n\n\t.read\t\t\t\t= native_apic_msr_read,\n\t.write\t\t\t\t= native_apic_msr_write,\n\t.eoi\t\t\t\t= native_apic_msr_eoi,\n\t.icr_read\t\t\t= native_x2apic_icr_read,\n\t.icr_write\t\t\t= native_x2apic_icr_write,\n};\n\napic_driver(apic_x2apic_phys);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}