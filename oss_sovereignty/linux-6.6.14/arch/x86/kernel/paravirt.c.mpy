{
  "module_name": "paravirt.c",
  "hash_id": "2b8f226ac09ed2cc77f7db7d00f4cb0e03605a89c00d65fe0c06cbd0abe9cb81",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kernel/paravirt.c",
  "human_readable_source": "\n \n\n#include <linux/errno.h>\n#include <linux/init.h>\n#include <linux/export.h>\n#include <linux/efi.h>\n#include <linux/bcd.h>\n#include <linux/highmem.h>\n#include <linux/kprobes.h>\n#include <linux/pgtable.h>\n#include <linux/static_call.h>\n\n#include <asm/bug.h>\n#include <asm/paravirt.h>\n#include <asm/debugreg.h>\n#include <asm/desc.h>\n#include <asm/setup.h>\n#include <asm/time.h>\n#include <asm/pgalloc.h>\n#include <asm/irq.h>\n#include <asm/delay.h>\n#include <asm/fixmap.h>\n#include <asm/apic.h>\n#include <asm/tlbflush.h>\n#include <asm/timer.h>\n#include <asm/special_insns.h>\n#include <asm/tlb.h>\n#include <asm/io_bitmap.h>\n#include <asm/gsseg.h>\n\n \nDEFINE_PARAVIRT_ASM(_paravirt_nop, \"\", .entry.text);\n\n \nDEFINE_PARAVIRT_ASM(paravirt_ret0, \"xor %eax,%eax\", .entry.text);\n\nvoid __init default_banner(void)\n{\n\tprintk(KERN_INFO \"Booting paravirtualized kernel on %s\\n\",\n\t       pv_info.name);\n}\n\n \nnoinstr void paravirt_BUG(void)\n{\n\tBUG();\n}\n\nstatic unsigned paravirt_patch_call(void *insn_buff, const void *target,\n\t\t\t\t    unsigned long addr, unsigned len)\n{\n\t__text_gen_insn(insn_buff, CALL_INSN_OPCODE,\n\t\t\t(void *)addr, target, CALL_INSN_SIZE);\n\treturn CALL_INSN_SIZE;\n}\n\n#ifdef CONFIG_PARAVIRT_XXL\nDEFINE_PARAVIRT_ASM(_paravirt_ident_64, \"mov %rdi, %rax\", .text);\nDEFINE_PARAVIRT_ASM(pv_native_save_fl, \"pushf; pop %rax\", .noinstr.text);\nDEFINE_PARAVIRT_ASM(pv_native_irq_disable, \"cli\", .noinstr.text);\nDEFINE_PARAVIRT_ASM(pv_native_irq_enable, \"sti\", .noinstr.text);\nDEFINE_PARAVIRT_ASM(pv_native_read_cr2, \"mov %cr2, %rax\", .noinstr.text);\n#endif\n\nDEFINE_STATIC_KEY_TRUE(virt_spin_lock_key);\n\nvoid __init native_pv_lock_init(void)\n{\n\tif (IS_ENABLED(CONFIG_PARAVIRT_SPINLOCKS) &&\n\t    !boot_cpu_has(X86_FEATURE_HYPERVISOR))\n\t\tstatic_branch_disable(&virt_spin_lock_key);\n}\n\nstatic void native_tlb_remove_table(struct mmu_gather *tlb, void *table)\n{\n\ttlb_remove_page(tlb, table);\n}\n\nunsigned int paravirt_patch(u8 type, void *insn_buff, unsigned long addr,\n\t\t\t    unsigned int len)\n{\n\t \n\tvoid *opfunc = *((void **)&pv_ops + type);\n\tunsigned ret;\n\n\tif (opfunc == NULL)\n\t\t \n\t\tret = paravirt_patch_call(insn_buff, paravirt_BUG, addr, len);\n\telse if (opfunc == _paravirt_nop)\n\t\tret = 0;\n\telse\n\t\t \n\t\tret = paravirt_patch_call(insn_buff, opfunc, addr, len);\n\n\treturn ret;\n}\n\nstruct static_key paravirt_steal_enabled;\nstruct static_key paravirt_steal_rq_enabled;\n\nstatic u64 native_steal_clock(int cpu)\n{\n\treturn 0;\n}\n\nDEFINE_STATIC_CALL(pv_steal_clock, native_steal_clock);\nDEFINE_STATIC_CALL(pv_sched_clock, native_sched_clock);\n\nvoid paravirt_set_sched_clock(u64 (*func)(void))\n{\n\tstatic_call_update(pv_sched_clock, func);\n}\n\n \nstatic struct resource reserve_ioports = {\n\t.start = 0,\n\t.end = IO_SPACE_LIMIT,\n\t.name = \"paravirt-ioport\",\n\t.flags = IORESOURCE_IO | IORESOURCE_BUSY,\n};\n\n \nint paravirt_disable_iospace(void)\n{\n\treturn request_resource(&ioport_resource, &reserve_ioports);\n}\n\n#ifdef CONFIG_PARAVIRT_XXL\nstatic noinstr void pv_native_write_cr2(unsigned long val)\n{\n\tnative_write_cr2(val);\n}\n\nstatic noinstr unsigned long pv_native_get_debugreg(int regno)\n{\n\treturn native_get_debugreg(regno);\n}\n\nstatic noinstr void pv_native_set_debugreg(int regno, unsigned long val)\n{\n\tnative_set_debugreg(regno, val);\n}\n\nnoinstr void pv_native_wbinvd(void)\n{\n\tnative_wbinvd();\n}\n\nstatic noinstr void pv_native_safe_halt(void)\n{\n\tnative_safe_halt();\n}\n#endif\n\nstruct pv_info pv_info = {\n\t.name = \"bare hardware\",\n#ifdef CONFIG_PARAVIRT_XXL\n\t.extra_user_64bit_cs = __USER_CS,\n#endif\n};\n\n \n#define PTE_IDENT\t__PV_IS_CALLEE_SAVE(_paravirt_ident_64)\n\nstruct paravirt_patch_template pv_ops = {\n\t \n\t.cpu.io_delay\t\t= native_io_delay,\n\n#ifdef CONFIG_PARAVIRT_XXL\n\t.cpu.cpuid\t\t= native_cpuid,\n\t.cpu.get_debugreg\t= pv_native_get_debugreg,\n\t.cpu.set_debugreg\t= pv_native_set_debugreg,\n\t.cpu.read_cr0\t\t= native_read_cr0,\n\t.cpu.write_cr0\t\t= native_write_cr0,\n\t.cpu.write_cr4\t\t= native_write_cr4,\n\t.cpu.wbinvd\t\t= pv_native_wbinvd,\n\t.cpu.read_msr\t\t= native_read_msr,\n\t.cpu.write_msr\t\t= native_write_msr,\n\t.cpu.read_msr_safe\t= native_read_msr_safe,\n\t.cpu.write_msr_safe\t= native_write_msr_safe,\n\t.cpu.read_pmc\t\t= native_read_pmc,\n\t.cpu.load_tr_desc\t= native_load_tr_desc,\n\t.cpu.set_ldt\t\t= native_set_ldt,\n\t.cpu.load_gdt\t\t= native_load_gdt,\n\t.cpu.load_idt\t\t= native_load_idt,\n\t.cpu.store_tr\t\t= native_store_tr,\n\t.cpu.load_tls\t\t= native_load_tls,\n\t.cpu.load_gs_index\t= native_load_gs_index,\n\t.cpu.write_ldt_entry\t= native_write_ldt_entry,\n\t.cpu.write_gdt_entry\t= native_write_gdt_entry,\n\t.cpu.write_idt_entry\t= native_write_idt_entry,\n\n\t.cpu.alloc_ldt\t\t= paravirt_nop,\n\t.cpu.free_ldt\t\t= paravirt_nop,\n\n\t.cpu.load_sp0\t\t= native_load_sp0,\n\n#ifdef CONFIG_X86_IOPL_IOPERM\n\t.cpu.invalidate_io_bitmap\t= native_tss_invalidate_io_bitmap,\n\t.cpu.update_io_bitmap\t\t= native_tss_update_io_bitmap,\n#endif\n\n\t.cpu.start_context_switch\t= paravirt_nop,\n\t.cpu.end_context_switch\t\t= paravirt_nop,\n\n\t \n\t.irq.save_fl\t\t= __PV_IS_CALLEE_SAVE(pv_native_save_fl),\n\t.irq.irq_disable\t= __PV_IS_CALLEE_SAVE(pv_native_irq_disable),\n\t.irq.irq_enable\t\t= __PV_IS_CALLEE_SAVE(pv_native_irq_enable),\n\t.irq.safe_halt\t\t= pv_native_safe_halt,\n\t.irq.halt\t\t= native_halt,\n#endif  \n\n\t \n\t.mmu.flush_tlb_user\t= native_flush_tlb_local,\n\t.mmu.flush_tlb_kernel\t= native_flush_tlb_global,\n\t.mmu.flush_tlb_one_user\t= native_flush_tlb_one_user,\n\t.mmu.flush_tlb_multi\t= native_flush_tlb_multi,\n\t.mmu.tlb_remove_table\t= native_tlb_remove_table,\n\n\t.mmu.exit_mmap\t\t= paravirt_nop,\n\t.mmu.notify_page_enc_status_changed\t= paravirt_nop,\n\n#ifdef CONFIG_PARAVIRT_XXL\n\t.mmu.read_cr2\t\t= __PV_IS_CALLEE_SAVE(pv_native_read_cr2),\n\t.mmu.write_cr2\t\t= pv_native_write_cr2,\n\t.mmu.read_cr3\t\t= __native_read_cr3,\n\t.mmu.write_cr3\t\t= native_write_cr3,\n\n\t.mmu.pgd_alloc\t\t= __paravirt_pgd_alloc,\n\t.mmu.pgd_free\t\t= paravirt_nop,\n\n\t.mmu.alloc_pte\t\t= paravirt_nop,\n\t.mmu.alloc_pmd\t\t= paravirt_nop,\n\t.mmu.alloc_pud\t\t= paravirt_nop,\n\t.mmu.alloc_p4d\t\t= paravirt_nop,\n\t.mmu.release_pte\t= paravirt_nop,\n\t.mmu.release_pmd\t= paravirt_nop,\n\t.mmu.release_pud\t= paravirt_nop,\n\t.mmu.release_p4d\t= paravirt_nop,\n\n\t.mmu.set_pte\t\t= native_set_pte,\n\t.mmu.set_pmd\t\t= native_set_pmd,\n\n\t.mmu.ptep_modify_prot_start\t= __ptep_modify_prot_start,\n\t.mmu.ptep_modify_prot_commit\t= __ptep_modify_prot_commit,\n\n\t.mmu.set_pud\t\t= native_set_pud,\n\n\t.mmu.pmd_val\t\t= PTE_IDENT,\n\t.mmu.make_pmd\t\t= PTE_IDENT,\n\n\t.mmu.pud_val\t\t= PTE_IDENT,\n\t.mmu.make_pud\t\t= PTE_IDENT,\n\n\t.mmu.set_p4d\t\t= native_set_p4d,\n\n#if CONFIG_PGTABLE_LEVELS >= 5\n\t.mmu.p4d_val\t\t= PTE_IDENT,\n\t.mmu.make_p4d\t\t= PTE_IDENT,\n\n\t.mmu.set_pgd\t\t= native_set_pgd,\n#endif  \n\n\t.mmu.pte_val\t\t= PTE_IDENT,\n\t.mmu.pgd_val\t\t= PTE_IDENT,\n\n\t.mmu.make_pte\t\t= PTE_IDENT,\n\t.mmu.make_pgd\t\t= PTE_IDENT,\n\n\t.mmu.enter_mmap\t\t= paravirt_nop,\n\n\t.mmu.lazy_mode = {\n\t\t.enter\t\t= paravirt_nop,\n\t\t.leave\t\t= paravirt_nop,\n\t\t.flush\t\t= paravirt_nop,\n\t},\n\n\t.mmu.set_fixmap\t\t= native_set_fixmap,\n#endif  \n\n#if defined(CONFIG_PARAVIRT_SPINLOCKS)\n\t \n#ifdef CONFIG_SMP\n\t.lock.queued_spin_lock_slowpath\t= native_queued_spin_lock_slowpath,\n\t.lock.queued_spin_unlock\t=\n\t\t\t\tPV_CALLEE_SAVE(__native_queued_spin_unlock),\n\t.lock.wait\t\t\t= paravirt_nop,\n\t.lock.kick\t\t\t= paravirt_nop,\n\t.lock.vcpu_is_preempted\t\t=\n\t\t\t\tPV_CALLEE_SAVE(__native_vcpu_is_preempted),\n#endif  \n#endif\n};\n\n#ifdef CONFIG_PARAVIRT_XXL\nNOKPROBE_SYMBOL(native_load_idt);\n#endif\n\nEXPORT_SYMBOL(pv_ops);\nEXPORT_SYMBOL_GPL(pv_info);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}