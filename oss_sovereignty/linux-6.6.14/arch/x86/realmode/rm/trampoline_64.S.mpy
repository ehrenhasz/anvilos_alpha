{
  "module_name": "trampoline_64.S",
  "hash_id": "1ec410c11f6c713b86907e7966f024e7e840fe1752d524864bf903552b4d4fa4",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/realmode/rm/trampoline_64.S",
  "human_readable_source": " \n \n\n#include <linux/linkage.h>\n#include <asm/pgtable_types.h>\n#include <asm/page_types.h>\n#include <asm/msr.h>\n#include <asm/segment.h>\n#include <asm/processor-flags.h>\n#include <asm/realmode.h>\n#include \"realmode.h\"\n\n\t.text\n\t.code16\n\n.macro LOCK_AND_LOAD_REALMODE_ESP lock_pa=0\n\t \n.Llock_rm\\@:\n\t.if \\lock_pa\n        lock btsl       $0, pa_tr_lock\n\t.else\n        lock btsl       $0, tr_lock\n\t.endif\n        jnc             2f\n        pause\n        jmp             .Llock_rm\\@\n2:\n\t# Setup stack\n\tmovl\t$rm_stack_end, %esp\n.endm\n\n\t.balign\tPAGE_SIZE\nSYM_CODE_START(trampoline_start)\n\tcli\t\t\t# We should be safe anyway\n\twbinvd\n\n\tLJMPW_RM(1f)\n1:\n\tmov\t%cs, %ax\t# Code and data in the same place\n\tmov\t%ax, %ds\n\tmov\t%ax, %es\n\tmov\t%ax, %ss\n\n\tLOCK_AND_LOAD_REALMODE_ESP\n\n\tcall\tverify_cpu\t\t# Verify the cpu supports long mode\n\ttestl   %eax, %eax\t\t# Check for return code\n\tjnz\tno_longmode\n\n.Lswitch_to_protected:\n\t \n\n\tlidtl\ttr_idt\t# load idt with 0, 0\n\tlgdtl\ttr_gdt\t# load gdt with whatever is appropriate\n\n\tmovw\t$__KERNEL_DS, %dx\t# Data segment descriptor\n\n\t# Enable protected mode\n\tmovl\t$(CR0_STATE & ~X86_CR0_PG), %eax\n\tmovl\t%eax, %cr0\t\t# into protected mode\n\n\t# flush prefetch and jump to startup_32\n\tljmpl\t$__KERNEL32_CS, $pa_startup_32\n\nno_longmode:\n\thlt\n\tjmp no_longmode\nSYM_CODE_END(trampoline_start)\n\n#ifdef CONFIG_AMD_MEM_ENCRYPT\n \nSYM_CODE_START(sev_es_trampoline_start)\n\tcli\t\t\t# We should be safe anyway\n\n\tLJMPW_RM(1f)\n1:\n\tmov\t%cs, %ax\t# Code and data in the same place\n\tmov\t%ax, %ds\n\tmov\t%ax, %es\n\tmov\t%ax, %ss\n\n\tLOCK_AND_LOAD_REALMODE_ESP\n\n\tjmp\t.Lswitch_to_protected\nSYM_CODE_END(sev_es_trampoline_start)\n#endif\t \n\n#include \"../kernel/verify_cpu.S\"\n\n\t.section \".text32\",\"ax\"\n\t.code32\n\t.balign 4\nSYM_CODE_START(startup_32)\n\tmovl\t%edx, %ss\n\taddl\t$pa_real_mode_base, %esp\n\tmovl\t%edx, %ds\n\tmovl\t%edx, %es\n\tmovl\t%edx, %fs\n\tmovl\t%edx, %gs\n\n\t \n\tbtl\t$TH_FLAGS_SME_ACTIVE_BIT, pa_tr_flags\n\tjnc\t.Ldone\n\tmovl\t$MSR_AMD64_SYSCFG, %ecx\n\trdmsr\n\tbts\t$MSR_AMD64_SYSCFG_MEM_ENCRYPT_BIT, %eax\n\tjc\t.Ldone\n\n\t \n\twrmsr\n.Ldone:\n\n\tmovl\tpa_tr_cr4, %eax\n\tmovl\t%eax, %cr4\t\t# Enable PAE mode\n\n\t# Setup trampoline 4 level pagetables\n\tmovl\t$pa_trampoline_pgd, %eax\n\tmovl\t%eax, %cr3\n\n\t# Set up EFER\n\tmovl\t$MSR_EFER, %ecx\n\trdmsr\n\t \n\tcmp\tpa_tr_efer, %eax\n\tjne\t.Lwrite_efer\n\tcmp\tpa_tr_efer + 4, %edx\n\tje\t.Ldone_efer\n.Lwrite_efer:\n\tmovl\tpa_tr_efer, %eax\n\tmovl\tpa_tr_efer + 4, %edx\n\twrmsr\n\n.Ldone_efer:\n\t# Enable paging and in turn activate Long Mode.\n\tmovl\t$CR0_STATE, %eax\n\tmovl\t%eax, %cr0\n\n\t \n\tljmpl\t$__KERNEL_CS, $pa_startup_64\nSYM_CODE_END(startup_32)\n\nSYM_CODE_START(pa_trampoline_compat)\n\t \n\tLOCK_AND_LOAD_REALMODE_ESP lock_pa=1\n\tmovw\t$__KERNEL_DS, %dx\n\n\tmovl\t$(CR0_STATE & ~X86_CR0_PG), %eax\n\tmovl\t%eax, %cr0\n\tljmpl   $__KERNEL32_CS, $pa_startup_32\nSYM_CODE_END(pa_trampoline_compat)\n\n\t.section \".text64\",\"ax\"\n\t.code64\n\t.balign 4\nSYM_CODE_START(startup_64)\n\t# Now jump into the kernel using virtual addresses\n\tjmpq\t*tr_start(%rip)\nSYM_CODE_END(startup_64)\n\nSYM_CODE_START(trampoline_start64)\n\t \n\tlidt\ttr_idt(%rip)\n\tlgdt\ttr_gdt64(%rip)\n\n\tljmpl\t*tr_compat(%rip)\nSYM_CODE_END(trampoline_start64)\n\n\t.section \".rodata\",\"a\"\n\t# Duplicate the global descriptor table\n\t# so the kernel can live anywhere\n\t.balign\t16\nSYM_DATA_START(tr_gdt)\n\t.short\ttr_gdt_end - tr_gdt - 1\t# gdt limit\n\t.long\tpa_tr_gdt\n\t.short\t0\n\t.quad\t0x00cf9b000000ffff\t# __KERNEL32_CS\n\t.quad\t0x00af9b000000ffff\t# __KERNEL_CS\n\t.quad\t0x00cf93000000ffff\t# __KERNEL_DS\nSYM_DATA_END_LABEL(tr_gdt, SYM_L_LOCAL, tr_gdt_end)\n\nSYM_DATA_START(tr_gdt64)\n\t.short\ttr_gdt_end - tr_gdt - 1\t# gdt limit\n\t.long\tpa_tr_gdt\n\t.long\t0\nSYM_DATA_END(tr_gdt64)\n\nSYM_DATA_START(tr_compat)\n\t.long\tpa_trampoline_compat\n\t.short\t__KERNEL32_CS\nSYM_DATA_END(tr_compat)\n\n\t.bss\n\t.balign\tPAGE_SIZE\nSYM_DATA(trampoline_pgd, .space PAGE_SIZE)\n\n\t.balign\t8\nSYM_DATA_START(trampoline_header)\n\tSYM_DATA_LOCAL(tr_start,\t.space 8)\n\tSYM_DATA(tr_efer,\t\t.space 8)\n\tSYM_DATA(tr_cr4,\t\t.space 4)\n\tSYM_DATA(tr_flags,\t\t.space 4)\n\tSYM_DATA(tr_lock,\t\t.space 4)\nSYM_DATA_END(trampoline_header)\n\n#include \"trampoline_common.S\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}