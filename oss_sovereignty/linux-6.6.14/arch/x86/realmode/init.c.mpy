{
  "module_name": "init.c",
  "hash_id": "c36e8707a2c49d1cead4d56458630a03261236c7a4d42841b29062eae4df965a",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/realmode/init.c",
  "human_readable_source": "\n#include <linux/io.h>\n#include <linux/slab.h>\n#include <linux/memblock.h>\n#include <linux/cc_platform.h>\n#include <linux/pgtable.h>\n\n#include <asm/set_memory.h>\n#include <asm/realmode.h>\n#include <asm/tlbflush.h>\n#include <asm/crash.h>\n#include <asm/sev.h>\n\nstruct real_mode_header *real_mode_header;\nu32 *trampoline_cr4_features;\n\n \npgd_t trampoline_pgd_entry;\n\nvoid load_trampoline_pgtable(void)\n{\n#ifdef CONFIG_X86_32\n\tload_cr3(initial_page_table);\n#else\n\t \n\tif (boot_cpu_has(X86_FEATURE_PCID))\n\t\tcr4_clear_bits(X86_CR4_PCIDE);\n\n\twrite_cr3(real_mode_header->trampoline_pgd);\n#endif\n\n\t \n\t__flush_tlb_all();\n}\n\nvoid __init reserve_real_mode(void)\n{\n\tphys_addr_t mem;\n\tsize_t size = real_mode_size_needed();\n\n\tif (!size)\n\t\treturn;\n\n\tWARN_ON(slab_is_available());\n\n\t \n\tmem = memblock_phys_alloc_range(size, PAGE_SIZE, 0, 1<<20);\n\tif (!mem)\n\t\tpr_info(\"No sub-1M memory is available for the trampoline\\n\");\n\telse\n\t\tset_real_mode_mem(mem);\n\n\t \n\tmemblock_reserve(0, SZ_1M);\n}\n\nstatic void __init sme_sev_setup_real_mode(struct trampoline_header *th)\n{\n#ifdef CONFIG_AMD_MEM_ENCRYPT\n\tif (cc_platform_has(CC_ATTR_HOST_MEM_ENCRYPT))\n\t\tth->flags |= TH_FLAGS_SME_ACTIVE;\n\n\tif (cc_platform_has(CC_ATTR_GUEST_STATE_ENCRYPT)) {\n\t\t \n\t\tth->start = (u64) secondary_startup_64_no_verify;\n\n\t\tif (sev_es_setup_ap_jump_table(real_mode_header))\n\t\t\tpanic(\"Failed to get/update SEV-ES AP Jump Table\");\n\t}\n#endif\n}\n\nstatic void __init setup_real_mode(void)\n{\n\tu16 real_mode_seg;\n\tconst u32 *rel;\n\tu32 count;\n\tunsigned char *base;\n\tunsigned long phys_base;\n\tstruct trampoline_header *trampoline_header;\n\tsize_t size = PAGE_ALIGN(real_mode_blob_end - real_mode_blob);\n#ifdef CONFIG_X86_64\n\tu64 *trampoline_pgd;\n\tu64 efer;\n\tint i;\n#endif\n\n\tbase = (unsigned char *)real_mode_header;\n\n\t \n\tif (cc_platform_has(CC_ATTR_HOST_MEM_ENCRYPT))\n\t\tset_memory_decrypted((unsigned long)base, size >> PAGE_SHIFT);\n\n\tmemcpy(base, real_mode_blob, size);\n\n\tphys_base = __pa(base);\n\treal_mode_seg = phys_base >> 4;\n\n\trel = (u32 *) real_mode_relocs;\n\n\t \n\tcount = *rel++;\n\twhile (count--) {\n\t\tu16 *seg = (u16 *) (base + *rel++);\n\t\t*seg = real_mode_seg;\n\t}\n\n\t \n\tcount = *rel++;\n\twhile (count--) {\n\t\tu32 *ptr = (u32 *) (base + *rel++);\n\t\t*ptr += phys_base;\n\t}\n\n\t \n\ttrampoline_header = (struct trampoline_header *)\n\t\t__va(real_mode_header->trampoline_header);\n\n#ifdef CONFIG_X86_32\n\ttrampoline_header->start = __pa_symbol(startup_32_smp);\n\ttrampoline_header->gdt_limit = __BOOT_DS + 7;\n\ttrampoline_header->gdt_base = __pa_symbol(boot_gdt);\n#else\n\t \n\trdmsrl(MSR_EFER, efer);\n\ttrampoline_header->efer = efer & ~EFER_LMA;\n\n\ttrampoline_header->start = (u64) secondary_startup_64;\n\ttrampoline_cr4_features = &trampoline_header->cr4;\n\t*trampoline_cr4_features = mmu_cr4_features;\n\n\ttrampoline_header->flags = 0;\n\n\ttrampoline_lock = &trampoline_header->lock;\n\t*trampoline_lock = 0;\n\n\ttrampoline_pgd = (u64 *) __va(real_mode_header->trampoline_pgd);\n\n\t \n\ttrampoline_pgd[0] = trampoline_pgd_entry.pgd;\n\n\t \n\tfor (i = pgd_index(__PAGE_OFFSET); i < PTRS_PER_PGD; i++)\n\t\ttrampoline_pgd[i] = init_top_pgt[i].pgd;\n#endif\n\n\tsme_sev_setup_real_mode(trampoline_header);\n}\n\n \nstatic void __init set_real_mode_permissions(void)\n{\n\tunsigned char *base = (unsigned char *) real_mode_header;\n\tsize_t size = PAGE_ALIGN(real_mode_blob_end - real_mode_blob);\n\n\tsize_t ro_size =\n\t\tPAGE_ALIGN(real_mode_header->ro_end) -\n\t\t__pa(base);\n\n\tsize_t text_size =\n\t\tPAGE_ALIGN(real_mode_header->ro_end) -\n\t\treal_mode_header->text_start;\n\n\tunsigned long text_start =\n\t\t(unsigned long) __va(real_mode_header->text_start);\n\n\tset_memory_nx((unsigned long) base, size >> PAGE_SHIFT);\n\tset_memory_ro((unsigned long) base, ro_size >> PAGE_SHIFT);\n\tset_memory_x((unsigned long) text_start, text_size >> PAGE_SHIFT);\n}\n\nvoid __init init_real_mode(void)\n{\n\tif (!real_mode_header)\n\t\tpanic(\"Real mode trampoline was not allocated\");\n\n\tsetup_real_mode();\n\tset_real_mode_permissions();\n}\n\nstatic int __init do_init_real_mode(void)\n{\n\tx86_platform.realmode_init();\n\treturn 0;\n}\nearly_initcall(do_init_real_mode);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}