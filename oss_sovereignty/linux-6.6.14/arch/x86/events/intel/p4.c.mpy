{
  "module_name": "p4.c",
  "hash_id": "3c9b611d117c404dea7688c1e3ee65ebc5ba2e094cc6fd4ccfec5d16f78c4e6d",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/events/intel/p4.c",
  "human_readable_source": " \n\n#include <linux/perf_event.h>\n\n#include <asm/perf_event_p4.h>\n#include <asm/hardirq.h>\n#include <asm/apic.h>\n\n#include \"../perf_event.h\"\n\n#define P4_CNTR_LIMIT 3\n \nstruct p4_event_bind {\n\tunsigned int opcode;\t\t\t \n\tunsigned int escr_msr[2];\t\t \n\tunsigned int escr_emask;\t\t \n\tunsigned int shared;\t\t\t \n\tsigned char cntr[2][P4_CNTR_LIMIT];\t \n};\n\nstruct p4_pebs_bind {\n\tunsigned int metric_pebs;\n\tunsigned int metric_vert;\n};\n\n \n#define P4_GEN_PEBS_BIND(name, pebs, vert)\t\t\t\\\n\t[P4_PEBS_METRIC__##name] = {\t\t\t\t\\\n\t\t.metric_pebs = pebs | P4_PEBS_ENABLE_UOP_TAG,\t\\\n\t\t.metric_vert = vert,\t\t\t\t\\\n\t}\n\n \nstatic struct p4_pebs_bind p4_pebs_bind_map[] = {\n\tP4_GEN_PEBS_BIND(1stl_cache_load_miss_retired,\t0x0000001, 0x0000001),\n\tP4_GEN_PEBS_BIND(2ndl_cache_load_miss_retired,\t0x0000002, 0x0000001),\n\tP4_GEN_PEBS_BIND(dtlb_load_miss_retired,\t0x0000004, 0x0000001),\n\tP4_GEN_PEBS_BIND(dtlb_store_miss_retired,\t0x0000004, 0x0000002),\n\tP4_GEN_PEBS_BIND(dtlb_all_miss_retired,\t\t0x0000004, 0x0000003),\n\tP4_GEN_PEBS_BIND(tagged_mispred_branch,\t\t0x0018000, 0x0000010),\n\tP4_GEN_PEBS_BIND(mob_load_replay_retired,\t0x0000200, 0x0000001),\n\tP4_GEN_PEBS_BIND(split_load_retired,\t\t0x0000400, 0x0000001),\n\tP4_GEN_PEBS_BIND(split_store_retired,\t\t0x0000400, 0x0000002),\n};\n\n \nstatic struct p4_event_bind p4_event_bind_map[] = {\n\t[P4_EVENT_TC_DELIVER_MODE] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_TC_DELIVER_MODE),\n\t\t.escr_msr\t= { MSR_P4_TC_ESCR0, MSR_P4_TC_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_TC_DELIVER_MODE, DD)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_TC_DELIVER_MODE, DB)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_TC_DELIVER_MODE, DI)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_TC_DELIVER_MODE, BD)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_TC_DELIVER_MODE, BB)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_TC_DELIVER_MODE, BI)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_TC_DELIVER_MODE, ID),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {4, 5, -1}, {6, 7, -1} },\n\t},\n\t[P4_EVENT_BPU_FETCH_REQUEST] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_BPU_FETCH_REQUEST),\n\t\t.escr_msr\t= { MSR_P4_BPU_ESCR0, MSR_P4_BPU_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BPU_FETCH_REQUEST, TCMISS),\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_ITLB_REFERENCE] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_ITLB_REFERENCE),\n\t\t.escr_msr\t= { MSR_P4_ITLB_ESCR0, MSR_P4_ITLB_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_ITLB_REFERENCE, HIT)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_ITLB_REFERENCE, MISS)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_ITLB_REFERENCE, HIT_UK),\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_MEMORY_CANCEL] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_MEMORY_CANCEL),\n\t\t.escr_msr\t= { MSR_P4_DAC_ESCR0, MSR_P4_DAC_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MEMORY_CANCEL, ST_RB_FULL)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MEMORY_CANCEL, 64K_CONF),\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_MEMORY_COMPLETE] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_MEMORY_COMPLETE),\n\t\t.escr_msr\t= { MSR_P4_SAAT_ESCR0 , MSR_P4_SAAT_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MEMORY_COMPLETE, LSC)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MEMORY_COMPLETE, SSC),\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_LOAD_PORT_REPLAY] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_LOAD_PORT_REPLAY),\n\t\t.escr_msr\t= { MSR_P4_SAAT_ESCR0, MSR_P4_SAAT_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_LOAD_PORT_REPLAY, SPLIT_LD),\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_STORE_PORT_REPLAY] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_STORE_PORT_REPLAY),\n\t\t.escr_msr\t= { MSR_P4_SAAT_ESCR0 ,  MSR_P4_SAAT_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_STORE_PORT_REPLAY, SPLIT_ST),\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_MOB_LOAD_REPLAY] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_MOB_LOAD_REPLAY),\n\t\t.escr_msr\t= { MSR_P4_MOB_ESCR0, MSR_P4_MOB_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MOB_LOAD_REPLAY, NO_STA)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MOB_LOAD_REPLAY, NO_STD)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MOB_LOAD_REPLAY, PARTIAL_DATA)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MOB_LOAD_REPLAY, UNALGN_ADDR),\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_PAGE_WALK_TYPE] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_PAGE_WALK_TYPE),\n\t\t.escr_msr\t= { MSR_P4_PMH_ESCR0, MSR_P4_PMH_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_PAGE_WALK_TYPE, DTMISS)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_PAGE_WALK_TYPE, ITMISS),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_BSQ_CACHE_REFERENCE] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_BSQ_CACHE_REFERENCE),\n\t\t.escr_msr\t= { MSR_P4_BSU_ESCR0, MSR_P4_BSU_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_2ndL_HITS)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_2ndL_HITE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_2ndL_HITM)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_3rdL_HITS)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_3rdL_HITE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_3rdL_HITM)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_2ndL_MISS)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_3rdL_MISS)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, WR_2ndL_MISS),\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_IOQ_ALLOCATION] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_IOQ_ALLOCATION),\n\t\t.escr_msr\t= { MSR_P4_FSB_ESCR0, MSR_P4_FSB_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, DEFAULT)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, ALL_READ)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, ALL_WRITE)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, MEM_UC)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, MEM_WC)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, MEM_WT)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, MEM_WP)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, MEM_WB)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, OWN)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, OTHER)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ALLOCATION, PREFETCH),\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_IOQ_ACTIVE_ENTRIES] = {\t \n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_IOQ_ACTIVE_ENTRIES),\n\t\t.escr_msr\t= { MSR_P4_FSB_ESCR1,  MSR_P4_FSB_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, DEFAULT)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, ALL_READ)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, ALL_WRITE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, MEM_UC)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, MEM_WC)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, MEM_WT)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, MEM_WP)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, MEM_WB)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, OWN)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, OTHER)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_IOQ_ACTIVE_ENTRIES, PREFETCH),\n\t\t.cntr\t\t= { {2, -1, -1}, {3, -1, -1} },\n\t},\n\t[P4_EVENT_FSB_DATA_ACTIVITY] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_FSB_DATA_ACTIVITY),\n\t\t.escr_msr\t= { MSR_P4_FSB_ESCR0, MSR_P4_FSB_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_FSB_DATA_ACTIVITY, DRDY_DRV)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_FSB_DATA_ACTIVITY, DRDY_OWN)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_FSB_DATA_ACTIVITY, DRDY_OTHER)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_FSB_DATA_ACTIVITY, DBSY_DRV)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_FSB_DATA_ACTIVITY, DBSY_OWN)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_FSB_DATA_ACTIVITY, DBSY_OTHER),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_BSQ_ALLOCATION] = {\t\t \n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_BSQ_ALLOCATION),\n\t\t.escr_msr\t= { MSR_P4_BSU_ESCR0, MSR_P4_BSU_ESCR0 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, REQ_TYPE0)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, REQ_TYPE1)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, REQ_LEN0)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, REQ_LEN1)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, REQ_IO_TYPE)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, REQ_LOCK_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, REQ_CACHE_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, REQ_SPLIT_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, REQ_DEM_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, REQ_ORD_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, MEM_TYPE0)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, MEM_TYPE1)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ALLOCATION, MEM_TYPE2),\n\t\t.cntr\t\t= { {0, -1, -1}, {1, -1, -1} },\n\t},\n\t[P4_EVENT_BSQ_ACTIVE_ENTRIES] = {\t \n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_BSQ_ACTIVE_ENTRIES),\n\t\t.escr_msr\t= { MSR_P4_BSU_ESCR1 , MSR_P4_BSU_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, REQ_TYPE0)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, REQ_TYPE1)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, REQ_LEN0)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, REQ_LEN1)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, REQ_IO_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, REQ_LOCK_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, REQ_CACHE_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, REQ_SPLIT_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, REQ_DEM_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, REQ_ORD_TYPE)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, MEM_TYPE0)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, MEM_TYPE1)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_ACTIVE_ENTRIES, MEM_TYPE2),\n\t\t.cntr\t\t= { {2, -1, -1}, {3, -1, -1} },\n\t},\n\t[P4_EVENT_SSE_INPUT_ASSIST] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_SSE_INPUT_ASSIST),\n\t\t.escr_msr\t= { MSR_P4_FIRM_ESCR0, MSR_P4_FIRM_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_SSE_INPUT_ASSIST, ALL),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_PACKED_SP_UOP] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_PACKED_SP_UOP),\n\t\t.escr_msr\t= { MSR_P4_FIRM_ESCR0, MSR_P4_FIRM_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_PACKED_SP_UOP, ALL),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_PACKED_DP_UOP] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_PACKED_DP_UOP),\n\t\t.escr_msr\t= { MSR_P4_FIRM_ESCR0, MSR_P4_FIRM_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_PACKED_DP_UOP, ALL),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_SCALAR_SP_UOP] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_SCALAR_SP_UOP),\n\t\t.escr_msr\t= { MSR_P4_FIRM_ESCR0, MSR_P4_FIRM_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_SCALAR_SP_UOP, ALL),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_SCALAR_DP_UOP] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_SCALAR_DP_UOP),\n\t\t.escr_msr\t= { MSR_P4_FIRM_ESCR0, MSR_P4_FIRM_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_SCALAR_DP_UOP, ALL),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_64BIT_MMX_UOP] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_64BIT_MMX_UOP),\n\t\t.escr_msr\t= { MSR_P4_FIRM_ESCR0, MSR_P4_FIRM_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_64BIT_MMX_UOP, ALL),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_128BIT_MMX_UOP] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_128BIT_MMX_UOP),\n\t\t.escr_msr\t= { MSR_P4_FIRM_ESCR0, MSR_P4_FIRM_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_128BIT_MMX_UOP, ALL),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_X87_FP_UOP] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_X87_FP_UOP),\n\t\t.escr_msr\t= { MSR_P4_FIRM_ESCR0, MSR_P4_FIRM_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_X87_FP_UOP, ALL),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_TC_MISC] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_TC_MISC),\n\t\t.escr_msr\t= { MSR_P4_TC_ESCR0, MSR_P4_TC_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_TC_MISC, FLUSH),\n\t\t.cntr\t\t= { {4, 5, -1}, {6, 7, -1} },\n\t},\n\t[P4_EVENT_GLOBAL_POWER_EVENTS] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_GLOBAL_POWER_EVENTS),\n\t\t.escr_msr\t= { MSR_P4_FSB_ESCR0, MSR_P4_FSB_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_GLOBAL_POWER_EVENTS, RUNNING),\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_TC_MS_XFER] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_TC_MS_XFER),\n\t\t.escr_msr\t= { MSR_P4_MS_ESCR0, MSR_P4_MS_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_TC_MS_XFER, CISC),\n\t\t.cntr\t\t= { {4, 5, -1}, {6, 7, -1} },\n\t},\n\t[P4_EVENT_UOP_QUEUE_WRITES] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_UOP_QUEUE_WRITES),\n\t\t.escr_msr\t= { MSR_P4_MS_ESCR0, MSR_P4_MS_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_UOP_QUEUE_WRITES, FROM_TC_BUILD)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_UOP_QUEUE_WRITES, FROM_TC_DELIVER)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_UOP_QUEUE_WRITES, FROM_ROM),\n\t\t.cntr\t\t= { {4, 5, -1}, {6, 7, -1} },\n\t},\n\t[P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE),\n\t\t.escr_msr\t= { MSR_P4_TBPU_ESCR0 , MSR_P4_TBPU_ESCR0 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE, CONDITIONAL)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE, CALL)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE, RETURN)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_MISPRED_BRANCH_TYPE, INDIRECT),\n\t\t.cntr\t\t= { {4, 5, -1}, {6, 7, -1} },\n\t},\n\t[P4_EVENT_RETIRED_BRANCH_TYPE] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_RETIRED_BRANCH_TYPE),\n\t\t.escr_msr\t= { MSR_P4_TBPU_ESCR0 , MSR_P4_TBPU_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_BRANCH_TYPE, CONDITIONAL)\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_BRANCH_TYPE, CALL)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_BRANCH_TYPE, RETURN)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_BRANCH_TYPE, INDIRECT),\n\t\t.cntr\t\t= { {4, 5, -1}, {6, 7, -1} },\n\t},\n\t[P4_EVENT_RESOURCE_STALL] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_RESOURCE_STALL),\n\t\t.escr_msr\t= { MSR_P4_ALF_ESCR0, MSR_P4_ALF_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RESOURCE_STALL, SBFULL),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_WC_BUFFER] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_WC_BUFFER),\n\t\t.escr_msr\t= { MSR_P4_DAC_ESCR0, MSR_P4_DAC_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_WC_BUFFER, WCB_EVICTS)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_WC_BUFFER, WCB_FULL_EVICTS),\n\t\t.shared\t\t= 1,\n\t\t.cntr\t\t= { {8, 9, -1}, {10, 11, -1} },\n\t},\n\t[P4_EVENT_B2B_CYCLES] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_B2B_CYCLES),\n\t\t.escr_msr\t= { MSR_P4_FSB_ESCR0, MSR_P4_FSB_ESCR1 },\n\t\t.escr_emask\t= 0,\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_BNR] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_BNR),\n\t\t.escr_msr\t= { MSR_P4_FSB_ESCR0, MSR_P4_FSB_ESCR1 },\n\t\t.escr_emask\t= 0,\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_SNOOP] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_SNOOP),\n\t\t.escr_msr\t= { MSR_P4_FSB_ESCR0, MSR_P4_FSB_ESCR1 },\n\t\t.escr_emask\t= 0,\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_RESPONSE] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_RESPONSE),\n\t\t.escr_msr\t= { MSR_P4_FSB_ESCR0, MSR_P4_FSB_ESCR1 },\n\t\t.escr_emask\t= 0,\n\t\t.cntr\t\t= { {0, -1, -1}, {2, -1, -1} },\n\t},\n\t[P4_EVENT_FRONT_END_EVENT] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_FRONT_END_EVENT),\n\t\t.escr_msr\t= { MSR_P4_CRU_ESCR2, MSR_P4_CRU_ESCR3 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_FRONT_END_EVENT, NBOGUS)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_FRONT_END_EVENT, BOGUS),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_EXECUTION_EVENT] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_EXECUTION_EVENT),\n\t\t.escr_msr\t= { MSR_P4_CRU_ESCR2, MSR_P4_CRU_ESCR3 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, NBOGUS0)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, NBOGUS1)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, NBOGUS2)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, NBOGUS3)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, BOGUS0)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, BOGUS1)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, BOGUS2)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, BOGUS3),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_REPLAY_EVENT] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_REPLAY_EVENT),\n\t\t.escr_msr\t= { MSR_P4_CRU_ESCR2, MSR_P4_CRU_ESCR3 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_REPLAY_EVENT, NBOGUS)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_REPLAY_EVENT, BOGUS),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_INSTR_RETIRED] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_INSTR_RETIRED),\n\t\t.escr_msr\t= { MSR_P4_CRU_ESCR0, MSR_P4_CRU_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_INSTR_RETIRED, NBOGUSNTAG)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_INSTR_RETIRED, NBOGUSTAG)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_INSTR_RETIRED, BOGUSNTAG)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_INSTR_RETIRED, BOGUSTAG),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_UOPS_RETIRED] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_UOPS_RETIRED),\n\t\t.escr_msr\t= { MSR_P4_CRU_ESCR0, MSR_P4_CRU_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_UOPS_RETIRED, NBOGUS)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_UOPS_RETIRED, BOGUS),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_UOP_TYPE] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_UOP_TYPE),\n\t\t.escr_msr\t= { MSR_P4_RAT_ESCR0, MSR_P4_RAT_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_UOP_TYPE, TAGLOADS)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_UOP_TYPE, TAGSTORES),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_BRANCH_RETIRED] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_BRANCH_RETIRED),\n\t\t.escr_msr\t= { MSR_P4_CRU_ESCR2, MSR_P4_CRU_ESCR3 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BRANCH_RETIRED, MMNP)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BRANCH_RETIRED, MMNM)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BRANCH_RETIRED, MMTP)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BRANCH_RETIRED, MMTM),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_MISPRED_BRANCH_RETIRED] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_MISPRED_BRANCH_RETIRED),\n\t\t.escr_msr\t= { MSR_P4_CRU_ESCR0, MSR_P4_CRU_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MISPRED_BRANCH_RETIRED, NBOGUS),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_X87_ASSIST] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_X87_ASSIST),\n\t\t.escr_msr\t= { MSR_P4_CRU_ESCR2, MSR_P4_CRU_ESCR3 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_X87_ASSIST, FPSU)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_X87_ASSIST, FPSO)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_X87_ASSIST, POAO)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_X87_ASSIST, POAU)\t\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_X87_ASSIST, PREA),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_MACHINE_CLEAR] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_MACHINE_CLEAR),\n\t\t.escr_msr\t= { MSR_P4_CRU_ESCR2, MSR_P4_CRU_ESCR3 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MACHINE_CLEAR, CLEAR)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MACHINE_CLEAR, MOCLEAR)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MACHINE_CLEAR, SMCLEAR),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n\t[P4_EVENT_INSTR_COMPLETED] = {\n\t\t.opcode\t\t= P4_OPCODE(P4_EVENT_INSTR_COMPLETED),\n\t\t.escr_msr\t= { MSR_P4_CRU_ESCR0, MSR_P4_CRU_ESCR1 },\n\t\t.escr_emask\t=\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_INSTR_COMPLETED, NBOGUS)\t\t|\n\t\t\tP4_ESCR_EMASK_BIT(P4_EVENT_INSTR_COMPLETED, BOGUS),\n\t\t.cntr\t\t= { {12, 13, 16}, {14, 15, 17} },\n\t},\n};\n\n#define P4_GEN_CACHE_EVENT(event, bit, metric)\t\t\t\t  \\\n\tp4_config_pack_escr(P4_ESCR_EVENT(event)\t\t\t| \\\n\t\t\t    P4_ESCR_EMASK_BIT(event, bit))\t\t| \\\n\tp4_config_pack_cccr(metric\t\t\t\t\t| \\\n\t\t\t    P4_CCCR_ESEL(P4_OPCODE_ESEL(P4_OPCODE(event))))\n\nstatic __initconst const u64 p4_hw_cache_event_ids\n\t\t\t\t[PERF_COUNT_HW_CACHE_MAX]\n\t\t\t\t[PERF_COUNT_HW_CACHE_OP_MAX]\n\t\t\t\t[PERF_COUNT_HW_CACHE_RESULT_MAX] =\n{\n [ C(L1D ) ] = {\n\t[ C(OP_READ) ] = {\n\t\t[ C(RESULT_ACCESS) ] = 0x0,\n\t\t[ C(RESULT_MISS)   ] = P4_GEN_CACHE_EVENT(P4_EVENT_REPLAY_EVENT, NBOGUS,\n\t\t\t\t\t\tP4_PEBS_METRIC__1stl_cache_load_miss_retired),\n\t},\n },\n [ C(LL  ) ] = {\n\t[ C(OP_READ) ] = {\n\t\t[ C(RESULT_ACCESS) ] = 0x0,\n\t\t[ C(RESULT_MISS)   ] = P4_GEN_CACHE_EVENT(P4_EVENT_REPLAY_EVENT, NBOGUS,\n\t\t\t\t\t\tP4_PEBS_METRIC__2ndl_cache_load_miss_retired),\n\t},\n},\n [ C(DTLB) ] = {\n\t[ C(OP_READ) ] = {\n\t\t[ C(RESULT_ACCESS) ] = 0x0,\n\t\t[ C(RESULT_MISS)   ] = P4_GEN_CACHE_EVENT(P4_EVENT_REPLAY_EVENT, NBOGUS,\n\t\t\t\t\t\tP4_PEBS_METRIC__dtlb_load_miss_retired),\n\t},\n\t[ C(OP_WRITE) ] = {\n\t\t[ C(RESULT_ACCESS) ] = 0x0,\n\t\t[ C(RESULT_MISS)   ] = P4_GEN_CACHE_EVENT(P4_EVENT_REPLAY_EVENT, NBOGUS,\n\t\t\t\t\t\tP4_PEBS_METRIC__dtlb_store_miss_retired),\n\t},\n },\n [ C(ITLB) ] = {\n\t[ C(OP_READ) ] = {\n\t\t[ C(RESULT_ACCESS) ] = P4_GEN_CACHE_EVENT(P4_EVENT_ITLB_REFERENCE, HIT,\n\t\t\t\t\t\tP4_PEBS_METRIC__none),\n\t\t[ C(RESULT_MISS)   ] = P4_GEN_CACHE_EVENT(P4_EVENT_ITLB_REFERENCE, MISS,\n\t\t\t\t\t\tP4_PEBS_METRIC__none),\n\t},\n\t[ C(OP_WRITE) ] = {\n\t\t[ C(RESULT_ACCESS) ] = -1,\n\t\t[ C(RESULT_MISS)   ] = -1,\n\t},\n\t[ C(OP_PREFETCH) ] = {\n\t\t[ C(RESULT_ACCESS) ] = -1,\n\t\t[ C(RESULT_MISS)   ] = -1,\n\t},\n },\n [ C(NODE) ] = {\n\t[ C(OP_READ) ] = {\n\t\t[ C(RESULT_ACCESS) ] = -1,\n\t\t[ C(RESULT_MISS)   ] = -1,\n\t},\n\t[ C(OP_WRITE) ] = {\n\t\t[ C(RESULT_ACCESS) ] = -1,\n\t\t[ C(RESULT_MISS)   ] = -1,\n\t},\n\t[ C(OP_PREFETCH) ] = {\n\t\t[ C(RESULT_ACCESS) ] = -1,\n\t\t[ C(RESULT_MISS)   ] = -1,\n\t},\n },\n};\n\n \nstatic struct p4_event_alias {\n\tu64 original;\n\tu64 alternative;\n} p4_event_aliases[] = {\n\t{\n\t\t \n\t.original\t=\n\t\tp4_config_pack_escr(P4_ESCR_EVENT(P4_EVENT_GLOBAL_POWER_EVENTS)\t\t|\n\t\t\t\t    P4_ESCR_EMASK_BIT(P4_EVENT_GLOBAL_POWER_EVENTS, RUNNING)),\n\t.alternative\t=\n\t\tp4_config_pack_escr(P4_ESCR_EVENT(P4_EVENT_EXECUTION_EVENT)\t\t|\n\t\t\t\t    P4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, NBOGUS0)|\n\t\t\t\t    P4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, NBOGUS1)|\n\t\t\t\t    P4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, NBOGUS2)|\n\t\t\t\t    P4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, NBOGUS3)|\n\t\t\t\t    P4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, BOGUS0)\t|\n\t\t\t\t    P4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, BOGUS1)\t|\n\t\t\t\t    P4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, BOGUS2)\t|\n\t\t\t\t    P4_ESCR_EMASK_BIT(P4_EVENT_EXECUTION_EVENT, BOGUS3))|\n\t\tp4_config_pack_cccr(P4_CCCR_THRESHOLD(15) | P4_CCCR_COMPLEMENT\t\t|\n\t\t\t\t    P4_CCCR_COMPARE),\n\t},\n};\n\nstatic u64 p4_get_alias_event(u64 config)\n{\n\tu64 config_match;\n\tint i;\n\n\t \n\tif (!(config & P4_CONFIG_ALIASABLE))\n\t\treturn 0;\n\n\tconfig_match = config & P4_CONFIG_EVENT_ALIAS_MASK;\n\n\tfor (i = 0; i < ARRAY_SIZE(p4_event_aliases); i++) {\n\t\tif (config_match == p4_event_aliases[i].original) {\n\t\t\tconfig_match = p4_event_aliases[i].alternative;\n\t\t\tbreak;\n\t\t} else if (config_match == p4_event_aliases[i].alternative) {\n\t\t\tconfig_match = p4_event_aliases[i].original;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tif (i >= ARRAY_SIZE(p4_event_aliases))\n\t\treturn 0;\n\n\treturn config_match | (config & P4_CONFIG_EVENT_ALIAS_IMMUTABLE_BITS);\n}\n\nstatic u64 p4_general_events[PERF_COUNT_HW_MAX] = {\n   \n  [PERF_COUNT_HW_CPU_CYCLES] =\n\tp4_config_pack_escr(P4_ESCR_EVENT(P4_EVENT_GLOBAL_POWER_EVENTS)\t\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_GLOBAL_POWER_EVENTS, RUNNING))\t|\n\t\tP4_CONFIG_ALIASABLE,\n\n   \n  [PERF_COUNT_HW_INSTRUCTIONS] =\n\tp4_config_pack_escr(P4_ESCR_EVENT(P4_EVENT_INSTR_RETIRED)\t\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_INSTR_RETIRED, NBOGUSNTAG)\t\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_INSTR_RETIRED, BOGUSNTAG)),\n\n   \n  [PERF_COUNT_HW_CACHE_REFERENCES] =\n\tp4_config_pack_escr(P4_ESCR_EVENT(P4_EVENT_BSQ_CACHE_REFERENCE)\t\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_2ndL_HITS)\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_2ndL_HITE)\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_2ndL_HITM)\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_3rdL_HITS)\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_3rdL_HITE)\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_3rdL_HITM)),\n\n   \n  [PERF_COUNT_HW_CACHE_MISSES] =\n\tp4_config_pack_escr(P4_ESCR_EVENT(P4_EVENT_BSQ_CACHE_REFERENCE)\t\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_2ndL_MISS)\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, RD_3rdL_MISS)\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_BSQ_CACHE_REFERENCE, WR_2ndL_MISS)),\n\n   \n  [PERF_COUNT_HW_BRANCH_INSTRUCTIONS] =\n\tp4_config_pack_escr(P4_ESCR_EVENT(P4_EVENT_RETIRED_BRANCH_TYPE)\t\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_BRANCH_TYPE, CONDITIONAL)\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_BRANCH_TYPE, CALL)\t\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_BRANCH_TYPE, RETURN)\t\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_RETIRED_BRANCH_TYPE, INDIRECT)),\n\n   \n  [PERF_COUNT_HW_BRANCH_MISSES]\t=\n\tp4_config_pack_escr(P4_ESCR_EVENT(P4_EVENT_MISPRED_BRANCH_RETIRED)\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_MISPRED_BRANCH_RETIRED, NBOGUS)),\n\n   \n  [PERF_COUNT_HW_BUS_CYCLES] =\n\tp4_config_pack_escr(P4_ESCR_EVENT(P4_EVENT_FSB_DATA_ACTIVITY)\t\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_FSB_DATA_ACTIVITY, DRDY_DRV)\t\t|\n\t\tP4_ESCR_EMASK_BIT(P4_EVENT_FSB_DATA_ACTIVITY, DRDY_OWN))\t|\n\tp4_config_pack_cccr(P4_CCCR_EDGE | P4_CCCR_COMPARE),\n};\n\nstatic struct p4_event_bind *p4_config_get_bind(u64 config)\n{\n\tunsigned int evnt = p4_config_unpack_event(config);\n\tstruct p4_event_bind *bind = NULL;\n\n\tif (evnt < ARRAY_SIZE(p4_event_bind_map))\n\t\tbind = &p4_event_bind_map[evnt];\n\n\treturn bind;\n}\n\nstatic u64 p4_pmu_event_map(int hw_event)\n{\n\tstruct p4_event_bind *bind;\n\tunsigned int esel;\n\tu64 config;\n\n\tconfig = p4_general_events[hw_event];\n\tbind = p4_config_get_bind(config);\n\tesel = P4_OPCODE_ESEL(bind->opcode);\n\tconfig |= p4_config_pack_cccr(P4_CCCR_ESEL(esel));\n\n\treturn config;\n}\n\n \nstatic bool p4_event_match_cpu_model(unsigned int event_idx)\n{\n\t \n\tif (event_idx == P4_EVENT_INSTR_COMPLETED) {\n\t\tif (boot_cpu_data.x86_model != 3 &&\n\t\t\tboot_cpu_data.x86_model != 4 &&\n\t\t\tboot_cpu_data.x86_model != 6)\n\t\t\treturn false;\n\t}\n\n\t \n\n\treturn true;\n}\n\nstatic int p4_validate_raw_event(struct perf_event *event)\n{\n\tunsigned int v, emask;\n\n\t \n\tv = p4_config_unpack_event(event->attr.config);\n\tif (v >= ARRAY_SIZE(p4_event_bind_map))\n\t\treturn -EINVAL;\n\n\t \n\tif (!p4_event_match_cpu_model(v))\n\t\treturn -EINVAL;\n\n\t \n\n\t \n\tif (p4_ht_active() && p4_event_bind_map[v].shared) {\n\t\tv = perf_allow_cpu(&event->attr);\n\t\tif (v)\n\t\t\treturn v;\n\t}\n\n\t \n\temask = p4_config_unpack_escr(event->attr.config) & P4_ESCR_EVENTMASK_MASK;\n\tif (emask & ~p4_event_bind_map[v].escr_emask)\n\t\treturn -EINVAL;\n\n\t \n\tif (p4_config_pebs_has(event->attr.config, P4_PEBS_CONFIG_ENABLE))\n\t\treturn -EINVAL;\n\n\tv = p4_config_unpack_metric(event->attr.config);\n\tif (v >= ARRAY_SIZE(p4_pebs_bind_map))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\nstatic int p4_hw_config(struct perf_event *event)\n{\n\tint cpu = get_cpu();\n\tint rc = 0;\n\tu32 escr, cccr;\n\n\t \n\n\tcccr = p4_default_cccr_conf(cpu);\n\tescr = p4_default_escr_conf(cpu, event->attr.exclude_kernel,\n\t\t\t\t\t event->attr.exclude_user);\n\tevent->hw.config = p4_config_pack_escr(escr) |\n\t\t\t   p4_config_pack_cccr(cccr);\n\n\tif (p4_ht_active() && p4_ht_thread(cpu))\n\t\tevent->hw.config = p4_set_ht_bit(event->hw.config);\n\n\tif (event->attr.type == PERF_TYPE_RAW) {\n\t\tstruct p4_event_bind *bind;\n\t\tunsigned int esel;\n\t\t \n\t\tevent->attr.config &= P4_CONFIG_MASK;\n\n\t\trc = p4_validate_raw_event(event);\n\t\tif (rc)\n\t\t\tgoto out;\n\n\t\t \n\t\tevent->hw.config |= event->attr.config;\n\t\tbind = p4_config_get_bind(event->attr.config);\n\t\tif (!bind) {\n\t\t\trc = -EINVAL;\n\t\t\tgoto out;\n\t\t}\n\t\tesel = P4_OPCODE_ESEL(bind->opcode);\n\t\tevent->hw.config |= p4_config_pack_cccr(P4_CCCR_ESEL(esel));\n\t}\n\n\trc = x86_setup_perfctr(event);\nout:\n\tput_cpu();\n\treturn rc;\n}\n\nstatic inline int p4_pmu_clear_cccr_ovf(struct hw_perf_event *hwc)\n{\n\tu64 v;\n\n\t \n\trdmsrl(hwc->config_base, v);\n\tif (v & P4_CCCR_OVF) {\n\t\twrmsrl(hwc->config_base, v & ~P4_CCCR_OVF);\n\t\treturn 1;\n\t}\n\n\t \n\trdmsrl(hwc->event_base, v);\n\tif (!(v & ARCH_P4_UNFLAGGED_BIT))\n\t\treturn 1;\n\n\treturn 0;\n}\n\nstatic void p4_pmu_disable_pebs(void)\n{\n\t \n}\n\nstatic inline void p4_pmu_disable_event(struct perf_event *event)\n{\n\tstruct hw_perf_event *hwc = &event->hw;\n\n\t \n\t(void)wrmsrl_safe(hwc->config_base,\n\t\tp4_config_unpack_cccr(hwc->config) & ~P4_CCCR_ENABLE & ~P4_CCCR_OVF & ~P4_CCCR_RESERVED);\n}\n\nstatic void p4_pmu_disable_all(void)\n{\n\tstruct cpu_hw_events *cpuc = this_cpu_ptr(&cpu_hw_events);\n\tint idx;\n\n\tfor (idx = 0; idx < x86_pmu.num_counters; idx++) {\n\t\tstruct perf_event *event = cpuc->events[idx];\n\t\tif (!test_bit(idx, cpuc->active_mask))\n\t\t\tcontinue;\n\t\tp4_pmu_disable_event(event);\n\t}\n\n\tp4_pmu_disable_pebs();\n}\n\n \nstatic void p4_pmu_enable_pebs(u64 config)\n{\n\tstruct p4_pebs_bind *bind;\n\tunsigned int idx;\n\n\tBUILD_BUG_ON(P4_PEBS_METRIC__max > P4_PEBS_CONFIG_METRIC_MASK);\n\n\tidx = p4_config_unpack_metric(config);\n\tif (idx == P4_PEBS_METRIC__none)\n\t\treturn;\n\n\tbind = &p4_pebs_bind_map[idx];\n\n\t(void)wrmsrl_safe(MSR_IA32_PEBS_ENABLE,\t(u64)bind->metric_pebs);\n\t(void)wrmsrl_safe(MSR_P4_PEBS_MATRIX_VERT,\t(u64)bind->metric_vert);\n}\n\nstatic void __p4_pmu_enable_event(struct perf_event *event)\n{\n\tstruct hw_perf_event *hwc = &event->hw;\n\tint thread = p4_ht_config_thread(hwc->config);\n\tu64 escr_conf = p4_config_unpack_escr(p4_clear_ht_bit(hwc->config));\n\tunsigned int idx = p4_config_unpack_event(hwc->config);\n\tstruct p4_event_bind *bind;\n\tu64 escr_addr, cccr;\n\n\tbind = &p4_event_bind_map[idx];\n\tescr_addr = bind->escr_msr[thread];\n\n\t \n\tWARN_ON_ONCE(p4_is_event_cascaded(hwc->config));\n\tWARN_ON_ONCE(hwc->idx == 1);\n\n\t \n\tescr_conf &= ~P4_ESCR_EVENT_MASK;\n\tescr_conf |= P4_ESCR_EVENT(P4_OPCODE_EVNT(bind->opcode));\n\n\tcccr = p4_config_unpack_cccr(hwc->config);\n\n\t \n\tp4_pmu_enable_pebs(hwc->config);\n\n\t(void)wrmsrl_safe(escr_addr, escr_conf);\n\t(void)wrmsrl_safe(hwc->config_base,\n\t\t\t\t(cccr & ~P4_CCCR_RESERVED) | P4_CCCR_ENABLE);\n}\n\nstatic DEFINE_PER_CPU(unsigned long [BITS_TO_LONGS(X86_PMC_IDX_MAX)], p4_running);\n\nstatic void p4_pmu_enable_event(struct perf_event *event)\n{\n\tint idx = event->hw.idx;\n\n\t__set_bit(idx, per_cpu(p4_running, smp_processor_id()));\n\t__p4_pmu_enable_event(event);\n}\n\nstatic void p4_pmu_enable_all(int added)\n{\n\tstruct cpu_hw_events *cpuc = this_cpu_ptr(&cpu_hw_events);\n\tint idx;\n\n\tfor (idx = 0; idx < x86_pmu.num_counters; idx++) {\n\t\tstruct perf_event *event = cpuc->events[idx];\n\t\tif (!test_bit(idx, cpuc->active_mask))\n\t\t\tcontinue;\n\t\t__p4_pmu_enable_event(event);\n\t}\n}\n\nstatic int p4_pmu_set_period(struct perf_event *event)\n{\n\tstruct hw_perf_event *hwc = &event->hw;\n\ts64 left = this_cpu_read(pmc_prev_left[hwc->idx]);\n\tint ret;\n\n\tret = x86_perf_event_set_period(event);\n\n\tif (hwc->event_base) {\n\t\t \n\t\twrmsrl(hwc->event_base, (u64)(-left) & x86_pmu.cntval_mask);\n\t}\n\n\treturn ret;\n}\n\nstatic int p4_pmu_handle_irq(struct pt_regs *regs)\n{\n\tstruct perf_sample_data data;\n\tstruct cpu_hw_events *cpuc;\n\tstruct perf_event *event;\n\tstruct hw_perf_event *hwc;\n\tint idx, handled = 0;\n\tu64 val;\n\n\tcpuc = this_cpu_ptr(&cpu_hw_events);\n\n\tfor (idx = 0; idx < x86_pmu.num_counters; idx++) {\n\t\tint overflow;\n\n\t\tif (!test_bit(idx, cpuc->active_mask)) {\n\t\t\t \n\t\t\tif (__test_and_clear_bit(idx, per_cpu(p4_running, smp_processor_id())))\n\t\t\t\thandled++;\n\t\t\tcontinue;\n\t\t}\n\n\t\tevent = cpuc->events[idx];\n\t\thwc = &event->hw;\n\n\t\tWARN_ON_ONCE(hwc->idx != idx);\n\n\t\t \n\t\toverflow = p4_pmu_clear_cccr_ovf(hwc);\n\n\t\tval = x86_perf_event_update(event);\n\t\tif (!overflow && (val & (1ULL << (x86_pmu.cntval_bits - 1))))\n\t\t\tcontinue;\n\n\t\thandled += overflow;\n\n\t\t \n\t\tperf_sample_data_init(&data, 0, hwc->last_period);\n\n\t\tif (!static_call(x86_pmu_set_period)(event))\n\t\t\tcontinue;\n\n\n\t\tif (perf_event_overflow(event, &data, regs))\n\t\t\tx86_pmu_stop(event, 0);\n\t}\n\n\tif (handled)\n\t\tinc_irq_stat(apic_perf_irqs);\n\n\t \n\tapic_write(APIC_LVTPC, APIC_DM_NMI);\n\n\treturn handled;\n}\n\n \nstatic void p4_pmu_swap_config_ts(struct hw_perf_event *hwc, int cpu)\n{\n\tu32 escr, cccr;\n\n\t \n\tif (!p4_should_swap_ts(hwc->config, cpu))\n\t\treturn;\n\n\t \n\n\tescr = p4_config_unpack_escr(hwc->config);\n\tcccr = p4_config_unpack_cccr(hwc->config);\n\n\tif (p4_ht_thread(cpu)) {\n\t\tcccr &= ~P4_CCCR_OVF_PMI_T0;\n\t\tcccr |= P4_CCCR_OVF_PMI_T1;\n\t\tif (escr & P4_ESCR_T0_OS) {\n\t\t\tescr &= ~P4_ESCR_T0_OS;\n\t\t\tescr |= P4_ESCR_T1_OS;\n\t\t}\n\t\tif (escr & P4_ESCR_T0_USR) {\n\t\t\tescr &= ~P4_ESCR_T0_USR;\n\t\t\tescr |= P4_ESCR_T1_USR;\n\t\t}\n\t\thwc->config  = p4_config_pack_escr(escr);\n\t\thwc->config |= p4_config_pack_cccr(cccr);\n\t\thwc->config |= P4_CONFIG_HT;\n\t} else {\n\t\tcccr &= ~P4_CCCR_OVF_PMI_T1;\n\t\tcccr |= P4_CCCR_OVF_PMI_T0;\n\t\tif (escr & P4_ESCR_T1_OS) {\n\t\t\tescr &= ~P4_ESCR_T1_OS;\n\t\t\tescr |= P4_ESCR_T0_OS;\n\t\t}\n\t\tif (escr & P4_ESCR_T1_USR) {\n\t\t\tescr &= ~P4_ESCR_T1_USR;\n\t\t\tescr |= P4_ESCR_T0_USR;\n\t\t}\n\t\thwc->config  = p4_config_pack_escr(escr);\n\t\thwc->config |= p4_config_pack_cccr(cccr);\n\t\thwc->config &= ~P4_CONFIG_HT;\n\t}\n}\n\n \n\n#define P4_ESCR_MSR_BASE\t\t0x000003a0\n#define P4_ESCR_MSR_MAX\t\t\t0x000003e1\n#define P4_ESCR_MSR_TABLE_SIZE\t\t(P4_ESCR_MSR_MAX - P4_ESCR_MSR_BASE + 1)\n#define P4_ESCR_MSR_IDX(msr)\t\t(msr - P4_ESCR_MSR_BASE)\n#define P4_ESCR_MSR_TABLE_ENTRY(msr)\t[P4_ESCR_MSR_IDX(msr)] = msr\n\nstatic const unsigned int p4_escr_table[P4_ESCR_MSR_TABLE_SIZE] = {\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_ALF_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_ALF_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_BPU_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_BPU_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_BSU_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_BSU_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_CRU_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_CRU_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_CRU_ESCR2),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_CRU_ESCR3),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_CRU_ESCR4),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_CRU_ESCR5),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_DAC_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_DAC_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_FIRM_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_FIRM_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_FLAME_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_FLAME_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_FSB_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_FSB_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_IQ_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_IQ_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_IS_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_IS_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_ITLB_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_ITLB_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_IX_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_IX_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_MOB_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_MOB_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_MS_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_MS_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_PMH_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_PMH_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_RAT_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_RAT_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_SAAT_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_SAAT_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_SSU_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_SSU_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_TBPU_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_TBPU_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_TC_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_TC_ESCR1),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_U2L_ESCR0),\n\tP4_ESCR_MSR_TABLE_ENTRY(MSR_P4_U2L_ESCR1),\n};\n\nstatic int p4_get_escr_idx(unsigned int addr)\n{\n\tunsigned int idx = P4_ESCR_MSR_IDX(addr);\n\n\tif (unlikely(idx >= P4_ESCR_MSR_TABLE_SIZE\t||\n\t\t\t!p4_escr_table[idx]\t\t||\n\t\t\tp4_escr_table[idx] != addr)) {\n\t\tWARN_ONCE(1, \"P4 PMU: Wrong address passed: %x\\n\", addr);\n\t\treturn -1;\n\t}\n\n\treturn idx;\n}\n\nstatic int p4_next_cntr(int thread, unsigned long *used_mask,\n\t\t\tstruct p4_event_bind *bind)\n{\n\tint i, j;\n\n\tfor (i = 0; i < P4_CNTR_LIMIT; i++) {\n\t\tj = bind->cntr[thread][i];\n\t\tif (j != -1 && !test_bit(j, used_mask))\n\t\t\treturn j;\n\t}\n\n\treturn -1;\n}\n\nstatic int p4_pmu_schedule_events(struct cpu_hw_events *cpuc, int n, int *assign)\n{\n\tunsigned long used_mask[BITS_TO_LONGS(X86_PMC_IDX_MAX)];\n\tunsigned long escr_mask[BITS_TO_LONGS(P4_ESCR_MSR_TABLE_SIZE)];\n\tint cpu = smp_processor_id();\n\tstruct hw_perf_event *hwc;\n\tstruct p4_event_bind *bind;\n\tunsigned int i, thread, num;\n\tint cntr_idx, escr_idx;\n\tu64 config_alias;\n\tint pass;\n\n\tbitmap_zero(used_mask, X86_PMC_IDX_MAX);\n\tbitmap_zero(escr_mask, P4_ESCR_MSR_TABLE_SIZE);\n\n\tfor (i = 0, num = n; i < n; i++, num--) {\n\n\t\thwc = &cpuc->event_list[i]->hw;\n\t\tthread = p4_ht_thread(cpu);\n\t\tpass = 0;\n\nagain:\n\t\t \n\t\tif (pass > 2)\n\t\t\tgoto done;\n\n\t\tbind = p4_config_get_bind(hwc->config);\n\t\tescr_idx = p4_get_escr_idx(bind->escr_msr[thread]);\n\t\tif (unlikely(escr_idx == -1))\n\t\t\tgoto done;\n\n\t\tif (hwc->idx != -1 && !p4_should_swap_ts(hwc->config, cpu)) {\n\t\t\tcntr_idx = hwc->idx;\n\t\t\tif (assign)\n\t\t\t\tassign[i] = hwc->idx;\n\t\t\tgoto reserve;\n\t\t}\n\n\t\tcntr_idx = p4_next_cntr(thread, used_mask, bind);\n\t\tif (cntr_idx == -1 || test_bit(escr_idx, escr_mask)) {\n\t\t\t \n\t\t\tconfig_alias = p4_get_alias_event(hwc->config);\n\t\t\tif (!config_alias)\n\t\t\t\tgoto done;\n\t\t\thwc->config = config_alias;\n\t\t\tpass++;\n\t\t\tgoto again;\n\t\t}\n\t\t \n\t\tif (p4_should_swap_ts(hwc->config, cpu))\n\t\t\thwc->idx = -1;\n\t\tp4_pmu_swap_config_ts(hwc, cpu);\n\t\tif (assign)\n\t\t\tassign[i] = cntr_idx;\nreserve:\n\t\tset_bit(cntr_idx, used_mask);\n\t\tset_bit(escr_idx, escr_mask);\n\t}\n\ndone:\n\treturn num ? -EINVAL : 0;\n}\n\nPMU_FORMAT_ATTR(cccr, \"config:0-31\" );\nPMU_FORMAT_ATTR(escr, \"config:32-62\");\nPMU_FORMAT_ATTR(ht,   \"config:63\"   );\n\nstatic struct attribute *intel_p4_formats_attr[] = {\n\t&format_attr_cccr.attr,\n\t&format_attr_escr.attr,\n\t&format_attr_ht.attr,\n\tNULL,\n};\n\nstatic __initconst const struct x86_pmu p4_pmu = {\n\t.name\t\t\t= \"Netburst P4/Xeon\",\n\t.handle_irq\t\t= p4_pmu_handle_irq,\n\t.disable_all\t\t= p4_pmu_disable_all,\n\t.enable_all\t\t= p4_pmu_enable_all,\n\t.enable\t\t\t= p4_pmu_enable_event,\n\t.disable\t\t= p4_pmu_disable_event,\n\n\t.set_period\t\t= p4_pmu_set_period,\n\n\t.eventsel\t\t= MSR_P4_BPU_CCCR0,\n\t.perfctr\t\t= MSR_P4_BPU_PERFCTR0,\n\t.event_map\t\t= p4_pmu_event_map,\n\t.max_events\t\t= ARRAY_SIZE(p4_general_events),\n\t.get_event_constraints\t= x86_get_event_constraints,\n\t \n\t.num_counters\t\t= ARCH_P4_MAX_CCCR,\n\t.apic\t\t\t= 1,\n\t.cntval_bits\t\t= ARCH_P4_CNTRVAL_BITS,\n\t.cntval_mask\t\t= ARCH_P4_CNTRVAL_MASK,\n\t.max_period\t\t= (1ULL << (ARCH_P4_CNTRVAL_BITS - 1)) - 1,\n\t.hw_config\t\t= p4_hw_config,\n\t.schedule_events\t= p4_pmu_schedule_events,\n\n\t.format_attrs\t\t= intel_p4_formats_attr,\n};\n\n__init int p4_pmu_init(void)\n{\n\tunsigned int low, high;\n\tint i, reg;\n\n\t \n\tBUILD_BUG_ON(ARCH_P4_MAX_CCCR > INTEL_PMC_MAX_GENERIC);\n\n\trdmsr(MSR_IA32_MISC_ENABLE, low, high);\n\tif (!(low & (1 << 7))) {\n\t\tpr_cont(\"unsupported Netburst CPU model %d \",\n\t\t\tboot_cpu_data.x86_model);\n\t\treturn -ENODEV;\n\t}\n\n\tmemcpy(hw_cache_event_ids, p4_hw_cache_event_ids,\n\t\tsizeof(hw_cache_event_ids));\n\n\tpr_cont(\"Netburst events, \");\n\n\tx86_pmu = p4_pmu;\n\n\t \n\tfor (i = 0; i < x86_pmu.num_counters; i++) {\n\t\treg = x86_pmu_config_addr(i);\n\t\twrmsrl_safe(reg, 0ULL);\n\t}\n\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}