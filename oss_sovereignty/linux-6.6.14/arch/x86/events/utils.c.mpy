{
  "module_name": "utils.c",
  "hash_id": "bcddb818f426b94491bffaea8c3fe83384f233ef74916d34a7d848b86e545383",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/events/utils.c",
  "human_readable_source": "\n#include <asm/insn.h>\n#include <linux/mm.h>\n\n#include \"perf_event.h\"\n\nstatic int decode_branch_type(struct insn *insn)\n{\n\tint ext;\n\n\tif (insn_get_opcode(insn))\n\t\treturn X86_BR_ABORT;\n\n\tswitch (insn->opcode.bytes[0]) {\n\tcase 0xf:\n\t\tswitch (insn->opcode.bytes[1]) {\n\t\tcase 0x05:  \n\t\tcase 0x34:  \n\t\t\treturn X86_BR_SYSCALL;\n\t\tcase 0x07:  \n\t\tcase 0x35:  \n\t\t\treturn X86_BR_SYSRET;\n\t\tcase 0x80 ... 0x8f:  \n\t\t\treturn X86_BR_JCC;\n\t\t}\n\t\treturn X86_BR_NONE;\n\tcase 0x70 ... 0x7f:  \n\t\treturn X86_BR_JCC;\n\tcase 0xc2:  \n\tcase 0xc3:  \n\tcase 0xca:  \n\tcase 0xcb:  \n\t\treturn X86_BR_RET;\n\tcase 0xcf:  \n\t\treturn X86_BR_IRET;\n\tcase 0xcc ... 0xce:  \n\t\treturn X86_BR_INT;\n\tcase 0xe8:  \n\t\tif (insn_get_immediate(insn) || insn->immediate1.value == 0) {\n\t\t\t \n\t\t\treturn X86_BR_ZERO_CALL;\n\t\t}\n\t\tfallthrough;\n\tcase 0x9a:  \n\t\treturn X86_BR_CALL;\n\tcase 0xe0 ... 0xe3:  \n\t\treturn X86_BR_JCC;\n\tcase 0xe9 ... 0xeb:  \n\t\treturn X86_BR_JMP;\n\tcase 0xff:  \n\t\tif (insn_get_modrm(insn))\n\t\t\treturn X86_BR_ABORT;\n\n\t\text = (insn->modrm.bytes[0] >> 3) & 0x7;\n\t\tswitch (ext) {\n\t\tcase 2:  \n\t\tcase 3:  \n\t\t\treturn X86_BR_IND_CALL;\n\t\tcase 4:\n\t\tcase 5:\n\t\t\treturn X86_BR_IND_JMP;\n\t\t}\n\t\treturn X86_BR_NONE;\n\t}\n\n\treturn X86_BR_NONE;\n}\n\n \nstatic int get_branch_type(unsigned long from, unsigned long to, int abort,\n\t\t\t   bool fused, int *offset)\n{\n\tstruct insn insn;\n\tvoid *addr;\n\tint bytes_read, bytes_left, insn_offset;\n\tint ret = X86_BR_NONE;\n\tint to_plm, from_plm;\n\tu8 buf[MAX_INSN_SIZE];\n\tint is64 = 0;\n\n\t \n\tif (offset)\n\t\t*offset = 0;\n\n\tto_plm = kernel_ip(to) ? X86_BR_KERNEL : X86_BR_USER;\n\tfrom_plm = kernel_ip(from) ? X86_BR_KERNEL : X86_BR_USER;\n\n\t \n\tif (from == 0 || to == 0)\n\t\treturn X86_BR_NONE;\n\n\tif (abort)\n\t\treturn X86_BR_ABORT | to_plm;\n\n\tif (from_plm == X86_BR_USER) {\n\t\t \n\t\tif (!current->mm)\n\t\t\treturn X86_BR_NONE;\n\n\t\t \n\t\tbytes_left = copy_from_user_nmi(buf, (void __user *)from,\n\t\t\t\t\t\tMAX_INSN_SIZE);\n\t\tbytes_read = MAX_INSN_SIZE - bytes_left;\n\t\tif (!bytes_read)\n\t\t\treturn X86_BR_NONE;\n\n\t\taddr = buf;\n\t} else {\n\t\t \n\t\tif (kernel_text_address(from) && !in_gate_area_no_mm(from)) {\n\t\t\taddr = (void *)from;\n\t\t\t \n\t\t\tbytes_read = MAX_INSN_SIZE;\n\t\t} else {\n\t\t\treturn X86_BR_NONE;\n\t\t}\n\t}\n\n\t \n#ifdef CONFIG_X86_64\n\tis64 = kernel_ip((unsigned long)addr) || any_64bit_mode(current_pt_regs());\n#endif\n\tinsn_init(&insn, addr, bytes_read, is64);\n\tret = decode_branch_type(&insn);\n\tinsn_offset = 0;\n\n\t \n\twhile (fused && ret == X86_BR_NONE) {\n\t\t \n\t\tif (insn_get_length(&insn) || !insn.length)\n\t\t\tbreak;\n\n\t\tinsn_offset += insn.length;\n\t\tbytes_read -= insn.length;\n\t\tif (bytes_read < 0)\n\t\t\tbreak;\n\n\t\tinsn_init(&insn, addr + insn_offset, bytes_read, is64);\n\t\tret = decode_branch_type(&insn);\n\t}\n\n\tif (offset)\n\t\t*offset = insn_offset;\n\n\t \n\tif (from_plm == X86_BR_USER && to_plm == X86_BR_KERNEL\n\t    && ret != X86_BR_SYSCALL && ret != X86_BR_INT)\n\t\tret = X86_BR_IRQ;\n\n\t \n\tif (ret != X86_BR_NONE)\n\t\tret |= to_plm;\n\n\treturn ret;\n}\n\nint branch_type(unsigned long from, unsigned long to, int abort)\n{\n\treturn get_branch_type(from, to, abort, false, NULL);\n}\n\nint branch_type_fused(unsigned long from, unsigned long to, int abort,\n\t\t      int *offset)\n{\n\treturn get_branch_type(from, to, abort, true, offset);\n}\n\n#define X86_BR_TYPE_MAP_MAX\t16\n\nstatic int branch_map[X86_BR_TYPE_MAP_MAX] = {\n\tPERF_BR_CALL,\t\t \n\tPERF_BR_RET,\t\t \n\tPERF_BR_SYSCALL,\t \n\tPERF_BR_SYSRET,\t\t \n\tPERF_BR_UNKNOWN,\t \n\tPERF_BR_ERET,\t\t \n\tPERF_BR_COND,\t\t \n\tPERF_BR_UNCOND,\t\t \n\tPERF_BR_IRQ,\t\t \n\tPERF_BR_IND_CALL,\t \n\tPERF_BR_UNKNOWN,\t \n\tPERF_BR_UNKNOWN,\t \n\tPERF_BR_NO_TX,\t\t \n\tPERF_BR_CALL,\t\t \n\tPERF_BR_UNKNOWN,\t \n\tPERF_BR_IND,\t\t \n};\n\nint common_branch_type(int type)\n{\n\tint i;\n\n\ttype >>= 2;  \n\n\tif (type) {\n\t\ti = __ffs(type);\n\t\tif (i < X86_BR_TYPE_MAP_MAX)\n\t\t\treturn branch_map[i];\n\t}\n\n\treturn PERF_BR_UNKNOWN;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}