{
  "module_name": "hyperv.c",
  "hash_id": "0ba7adfe889b124fd744f40bb6c4c328d432aa6351614ef90564c85092131e4c",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/kvm/vmx/hyperv.c",
  "human_readable_source": "\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/errno.h>\n#include <linux/smp.h>\n\n#include \"../cpuid.h\"\n#include \"hyperv.h\"\n#include \"nested.h\"\n#include \"vmcs.h\"\n#include \"vmx.h\"\n#include \"trace.h\"\n\n#define CC KVM_NESTED_VMENTER_CONSISTENCY_CHECK\n\n \n#define EVMCS1_SUPPORTED_PINCTRL\t\t\t\t\t\\\n\t(PIN_BASED_ALWAYSON_WITHOUT_TRUE_MSR |\t\t\t\t\\\n\t PIN_BASED_EXT_INTR_MASK |\t\t\t\t\t\\\n\t PIN_BASED_NMI_EXITING |\t\t\t\t\t\\\n\t PIN_BASED_VIRTUAL_NMIS)\n\n#define EVMCS1_SUPPORTED_EXEC_CTRL\t\t\t\t\t\\\n\t(CPU_BASED_ALWAYSON_WITHOUT_TRUE_MSR |\t\t\t\t\\\n\t CPU_BASED_HLT_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_CR3_LOAD_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_CR3_STORE_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_UNCOND_IO_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_MOV_DR_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_USE_TSC_OFFSETTING |\t\t\t\t\t\\\n\t CPU_BASED_MWAIT_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_MONITOR_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_INVLPG_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_RDPMC_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_INTR_WINDOW_EXITING |\t\t\t\t\\\n\t CPU_BASED_CR8_LOAD_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_CR8_STORE_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_RDTSC_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_TPR_SHADOW |\t\t\t\t\t\t\\\n\t CPU_BASED_USE_IO_BITMAPS |\t\t\t\t\t\\\n\t CPU_BASED_MONITOR_TRAP_FLAG |\t\t\t\t\t\\\n\t CPU_BASED_USE_MSR_BITMAPS |\t\t\t\t\t\\\n\t CPU_BASED_NMI_WINDOW_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_PAUSE_EXITING |\t\t\t\t\t\\\n\t CPU_BASED_ACTIVATE_SECONDARY_CONTROLS)\n\n#define EVMCS1_SUPPORTED_2NDEXEC\t\t\t\t\t\\\n\t(SECONDARY_EXEC_VIRTUALIZE_X2APIC_MODE |\t\t\t\\\n\t SECONDARY_EXEC_WBINVD_EXITING |\t\t\t\t\\\n\t SECONDARY_EXEC_ENABLE_VPID |\t\t\t\t\t\\\n\t SECONDARY_EXEC_ENABLE_EPT |\t\t\t\t\t\\\n\t SECONDARY_EXEC_UNRESTRICTED_GUEST |\t\t\t\t\\\n\t SECONDARY_EXEC_DESC |\t\t\t\t\t\t\\\n\t SECONDARY_EXEC_ENABLE_RDTSCP |\t\t\t\t\t\\\n\t SECONDARY_EXEC_ENABLE_INVPCID |\t\t\t\t\\\n\t SECONDARY_EXEC_ENABLE_XSAVES |\t\t\t\t\t\\\n\t SECONDARY_EXEC_RDSEED_EXITING |\t\t\t\t\\\n\t SECONDARY_EXEC_RDRAND_EXITING |\t\t\t\t\\\n\t SECONDARY_EXEC_TSC_SCALING |\t\t\t\t\t\\\n\t SECONDARY_EXEC_ENABLE_USR_WAIT_PAUSE |\t\t\t\t\\\n\t SECONDARY_EXEC_PT_USE_GPA |\t\t\t\t\t\\\n\t SECONDARY_EXEC_PT_CONCEAL_VMX |\t\t\t\t\\\n\t SECONDARY_EXEC_BUS_LOCK_DETECTION |\t\t\t\t\\\n\t SECONDARY_EXEC_NOTIFY_VM_EXITING |\t\t\t\t\\\n\t SECONDARY_EXEC_ENCLS_EXITING)\n\n#define EVMCS1_SUPPORTED_3RDEXEC (0ULL)\n\n#define EVMCS1_SUPPORTED_VMEXIT_CTRL\t\t\t\t\t\\\n\t(VM_EXIT_ALWAYSON_WITHOUT_TRUE_MSR |\t\t\t\t\\\n\t VM_EXIT_SAVE_DEBUG_CONTROLS |\t\t\t\t\t\\\n\t VM_EXIT_ACK_INTR_ON_EXIT |\t\t\t\t\t\\\n\t VM_EXIT_HOST_ADDR_SPACE_SIZE |\t\t\t\t\t\\\n\t VM_EXIT_LOAD_IA32_PERF_GLOBAL_CTRL |\t\t\t\t\\\n\t VM_EXIT_SAVE_IA32_PAT |\t\t\t\t\t\\\n\t VM_EXIT_LOAD_IA32_PAT |\t\t\t\t\t\\\n\t VM_EXIT_SAVE_IA32_EFER |\t\t\t\t\t\\\n\t VM_EXIT_LOAD_IA32_EFER |\t\t\t\t\t\\\n\t VM_EXIT_CLEAR_BNDCFGS |\t\t\t\t\t\\\n\t VM_EXIT_PT_CONCEAL_PIP |\t\t\t\t\t\\\n\t VM_EXIT_CLEAR_IA32_RTIT_CTL)\n\n#define EVMCS1_SUPPORTED_VMENTRY_CTRL\t\t\t\t\t\\\n\t(VM_ENTRY_ALWAYSON_WITHOUT_TRUE_MSR |\t\t\t\t\\\n\t VM_ENTRY_LOAD_DEBUG_CONTROLS |\t\t\t\t\t\\\n\t VM_ENTRY_IA32E_MODE |\t\t\t\t\t\t\\\n\t VM_ENTRY_LOAD_IA32_PERF_GLOBAL_CTRL |\t\t\t\t\\\n\t VM_ENTRY_LOAD_IA32_PAT |\t\t\t\t\t\\\n\t VM_ENTRY_LOAD_IA32_EFER |\t\t\t\t\t\\\n\t VM_ENTRY_LOAD_BNDCFGS |\t\t\t\t\t\\\n\t VM_ENTRY_PT_CONCEAL_PIP |\t\t\t\t\t\\\n\t VM_ENTRY_LOAD_IA32_RTIT_CTL)\n\n#define EVMCS1_SUPPORTED_VMFUNC (0)\n\n#define EVMCS1_OFFSET(x) offsetof(struct hv_enlightened_vmcs, x)\n#define EVMCS1_FIELD(number, name, clean_field)[ROL16(number, 6)] = \\\n\t\t{EVMCS1_OFFSET(name), clean_field}\n\nconst struct evmcs_field vmcs_field_to_evmcs_1[] = {\n\t \n\tEVMCS1_FIELD(GUEST_RIP, guest_rip,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\tEVMCS1_FIELD(GUEST_RSP, guest_rsp,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_BASIC),\n\tEVMCS1_FIELD(GUEST_RFLAGS, guest_rflags,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_BASIC),\n\tEVMCS1_FIELD(HOST_IA32_PAT, host_ia32_pat,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_IA32_EFER, host_ia32_efer,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_IA32_PERF_GLOBAL_CTRL, host_ia32_perf_global_ctrl,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_CR0, host_cr0,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_CR3, host_cr3,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_CR4, host_cr4,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_IA32_SYSENTER_ESP, host_ia32_sysenter_esp,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_IA32_SYSENTER_EIP, host_ia32_sysenter_eip,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_RIP, host_rip,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(IO_BITMAP_A, io_bitmap_a,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_IO_BITMAP),\n\tEVMCS1_FIELD(IO_BITMAP_B, io_bitmap_b,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_IO_BITMAP),\n\tEVMCS1_FIELD(MSR_BITMAP, msr_bitmap,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_MSR_BITMAP),\n\tEVMCS1_FIELD(GUEST_ES_BASE, guest_es_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_CS_BASE, guest_cs_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_SS_BASE, guest_ss_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_DS_BASE, guest_ds_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_FS_BASE, guest_fs_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_GS_BASE, guest_gs_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_LDTR_BASE, guest_ldtr_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_TR_BASE, guest_tr_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_GDTR_BASE, guest_gdtr_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_IDTR_BASE, guest_idtr_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(TSC_OFFSET, tsc_offset,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_GRP2),\n\tEVMCS1_FIELD(VIRTUAL_APIC_PAGE_ADDR, virtual_apic_page_addr,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_GRP2),\n\tEVMCS1_FIELD(VMCS_LINK_POINTER, vmcs_link_pointer,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_IA32_DEBUGCTL, guest_ia32_debugctl,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_IA32_PAT, guest_ia32_pat,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_IA32_EFER, guest_ia32_efer,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_IA32_PERF_GLOBAL_CTRL, guest_ia32_perf_global_ctrl,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_PDPTR0, guest_pdptr0,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_PDPTR1, guest_pdptr1,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_PDPTR2, guest_pdptr2,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_PDPTR3, guest_pdptr3,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_PENDING_DBG_EXCEPTIONS, guest_pending_dbg_exceptions,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_SYSENTER_ESP, guest_sysenter_esp,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_SYSENTER_EIP, guest_sysenter_eip,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(CR0_GUEST_HOST_MASK, cr0_guest_host_mask,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CRDR),\n\tEVMCS1_FIELD(CR4_GUEST_HOST_MASK, cr4_guest_host_mask,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CRDR),\n\tEVMCS1_FIELD(CR0_READ_SHADOW, cr0_read_shadow,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CRDR),\n\tEVMCS1_FIELD(CR4_READ_SHADOW, cr4_read_shadow,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CRDR),\n\tEVMCS1_FIELD(GUEST_CR0, guest_cr0,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CRDR),\n\tEVMCS1_FIELD(GUEST_CR3, guest_cr3,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CRDR),\n\tEVMCS1_FIELD(GUEST_CR4, guest_cr4,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CRDR),\n\tEVMCS1_FIELD(GUEST_DR7, guest_dr7,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CRDR),\n\tEVMCS1_FIELD(HOST_FS_BASE, host_fs_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_POINTER),\n\tEVMCS1_FIELD(HOST_GS_BASE, host_gs_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_POINTER),\n\tEVMCS1_FIELD(HOST_TR_BASE, host_tr_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_POINTER),\n\tEVMCS1_FIELD(HOST_GDTR_BASE, host_gdtr_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_POINTER),\n\tEVMCS1_FIELD(HOST_IDTR_BASE, host_idtr_base,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_POINTER),\n\tEVMCS1_FIELD(HOST_RSP, host_rsp,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_POINTER),\n\tEVMCS1_FIELD(EPT_POINTER, ept_pointer,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_XLAT),\n\tEVMCS1_FIELD(GUEST_BNDCFGS, guest_bndcfgs,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(XSS_EXIT_BITMAP, xss_exit_bitmap,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_GRP2),\n\tEVMCS1_FIELD(ENCLS_EXITING_BITMAP, encls_exiting_bitmap,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_GRP2),\n\tEVMCS1_FIELD(TSC_MULTIPLIER, tsc_multiplier,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_GRP2),\n\t \n\n\t \n\tEVMCS1_FIELD(GUEST_PHYSICAL_ADDRESS, guest_physical_address,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\tEVMCS1_FIELD(EXIT_QUALIFICATION, exit_qualification,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\t \n\tEVMCS1_FIELD(GUEST_LINEAR_ADDRESS, guest_linear_address,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\n\t \n\tEVMCS1_FIELD(VM_EXIT_MSR_STORE_ADDR, vm_exit_msr_store_addr,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_ALL),\n\tEVMCS1_FIELD(VM_EXIT_MSR_LOAD_ADDR, vm_exit_msr_load_addr,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_ALL),\n\tEVMCS1_FIELD(VM_ENTRY_MSR_LOAD_ADDR, vm_entry_msr_load_addr,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_ALL),\n\n\t \n\tEVMCS1_FIELD(TPR_THRESHOLD, tpr_threshold,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\tEVMCS1_FIELD(GUEST_INTERRUPTIBILITY_INFO, guest_interruptibility_info,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_BASIC),\n\tEVMCS1_FIELD(CPU_BASED_VM_EXEC_CONTROL, cpu_based_vm_exec_control,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_PROC),\n\tEVMCS1_FIELD(EXCEPTION_BITMAP, exception_bitmap,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_EXCPN),\n\tEVMCS1_FIELD(VM_ENTRY_CONTROLS, vm_entry_controls,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_ENTRY),\n\tEVMCS1_FIELD(VM_ENTRY_INTR_INFO_FIELD, vm_entry_intr_info_field,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_EVENT),\n\tEVMCS1_FIELD(VM_ENTRY_EXCEPTION_ERROR_CODE,\n\t\t     vm_entry_exception_error_code,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_EVENT),\n\tEVMCS1_FIELD(VM_ENTRY_INSTRUCTION_LEN, vm_entry_instruction_len,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_EVENT),\n\tEVMCS1_FIELD(HOST_IA32_SYSENTER_CS, host_ia32_sysenter_cs,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(PIN_BASED_VM_EXEC_CONTROL, pin_based_vm_exec_control,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_GRP1),\n\tEVMCS1_FIELD(VM_EXIT_CONTROLS, vm_exit_controls,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_GRP1),\n\tEVMCS1_FIELD(SECONDARY_VM_EXEC_CONTROL, secondary_vm_exec_control,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_GRP1),\n\tEVMCS1_FIELD(GUEST_ES_LIMIT, guest_es_limit,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_CS_LIMIT, guest_cs_limit,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_SS_LIMIT, guest_ss_limit,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_DS_LIMIT, guest_ds_limit,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_FS_LIMIT, guest_fs_limit,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_GS_LIMIT, guest_gs_limit,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_LDTR_LIMIT, guest_ldtr_limit,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_TR_LIMIT, guest_tr_limit,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_GDTR_LIMIT, guest_gdtr_limit,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_IDTR_LIMIT, guest_idtr_limit,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_ES_AR_BYTES, guest_es_ar_bytes,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_CS_AR_BYTES, guest_cs_ar_bytes,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_SS_AR_BYTES, guest_ss_ar_bytes,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_DS_AR_BYTES, guest_ds_ar_bytes,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_FS_AR_BYTES, guest_fs_ar_bytes,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_GS_AR_BYTES, guest_gs_ar_bytes,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_LDTR_AR_BYTES, guest_ldtr_ar_bytes,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_TR_AR_BYTES, guest_tr_ar_bytes,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_ACTIVITY_STATE, guest_activity_state,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\tEVMCS1_FIELD(GUEST_SYSENTER_CS, guest_sysenter_cs,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP1),\n\n\t \n\tEVMCS1_FIELD(VM_INSTRUCTION_ERROR, vm_instruction_error,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\tEVMCS1_FIELD(VM_EXIT_REASON, vm_exit_reason,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\tEVMCS1_FIELD(VM_EXIT_INTR_INFO, vm_exit_intr_info,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\tEVMCS1_FIELD(VM_EXIT_INTR_ERROR_CODE, vm_exit_intr_error_code,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\tEVMCS1_FIELD(IDT_VECTORING_INFO_FIELD, idt_vectoring_info_field,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\tEVMCS1_FIELD(IDT_VECTORING_ERROR_CODE, idt_vectoring_error_code,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\tEVMCS1_FIELD(VM_EXIT_INSTRUCTION_LEN, vm_exit_instruction_len,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\tEVMCS1_FIELD(VMX_INSTRUCTION_INFO, vmx_instruction_info,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_NONE),\n\n\t \n\tEVMCS1_FIELD(PAGE_FAULT_ERROR_CODE_MASK, page_fault_error_code_mask,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_ALL),\n\tEVMCS1_FIELD(PAGE_FAULT_ERROR_CODE_MATCH, page_fault_error_code_match,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_ALL),\n\tEVMCS1_FIELD(CR3_TARGET_COUNT, cr3_target_count,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_ALL),\n\tEVMCS1_FIELD(VM_EXIT_MSR_STORE_COUNT, vm_exit_msr_store_count,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_ALL),\n\tEVMCS1_FIELD(VM_EXIT_MSR_LOAD_COUNT, vm_exit_msr_load_count,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_ALL),\n\tEVMCS1_FIELD(VM_ENTRY_MSR_LOAD_COUNT, vm_entry_msr_load_count,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_ALL),\n\n\t \n\tEVMCS1_FIELD(HOST_ES_SELECTOR, host_es_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_CS_SELECTOR, host_cs_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_SS_SELECTOR, host_ss_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_DS_SELECTOR, host_ds_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_FS_SELECTOR, host_fs_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_GS_SELECTOR, host_gs_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(HOST_TR_SELECTOR, host_tr_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_HOST_GRP1),\n\tEVMCS1_FIELD(GUEST_ES_SELECTOR, guest_es_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_CS_SELECTOR, guest_cs_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_SS_SELECTOR, guest_ss_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_DS_SELECTOR, guest_ds_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_FS_SELECTOR, guest_fs_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_GS_SELECTOR, guest_gs_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_LDTR_SELECTOR, guest_ldtr_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(GUEST_TR_SELECTOR, guest_tr_selector,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_GUEST_GRP2),\n\tEVMCS1_FIELD(VIRTUAL_PROCESSOR_ID, virtual_processor_id,\n\t\t     HV_VMX_ENLIGHTENED_CLEAN_FIELD_CONTROL_XLAT),\n};\nconst unsigned int nr_evmcs_1_fields = ARRAY_SIZE(vmcs_field_to_evmcs_1);\n\nu64 nested_get_evmptr(struct kvm_vcpu *vcpu)\n{\n\tstruct kvm_vcpu_hv *hv_vcpu = to_hv_vcpu(vcpu);\n\n\tif (unlikely(kvm_hv_get_assist_page(vcpu)))\n\t\treturn EVMPTR_INVALID;\n\n\tif (unlikely(!hv_vcpu->vp_assist_page.enlighten_vmentry))\n\t\treturn EVMPTR_INVALID;\n\n\treturn hv_vcpu->vp_assist_page.current_nested_vmcs;\n}\n\nuint16_t nested_get_evmcs_version(struct kvm_vcpu *vcpu)\n{\n\t \n\tif (kvm_cpu_cap_get(X86_FEATURE_VMX) &&\n\t    (!vcpu || to_vmx(vcpu)->nested.enlightened_vmcs_enabled))\n\t\treturn (KVM_EVMCS_VERSION << 8) | 1;\n\n\treturn 0;\n}\n\nenum evmcs_revision {\n\tEVMCSv1_LEGACY,\n\tNR_EVMCS_REVISIONS,\n};\n\nenum evmcs_ctrl_type {\n\tEVMCS_EXIT_CTRLS,\n\tEVMCS_ENTRY_CTRLS,\n\tEVMCS_EXEC_CTRL,\n\tEVMCS_2NDEXEC,\n\tEVMCS_3RDEXEC,\n\tEVMCS_PINCTRL,\n\tEVMCS_VMFUNC,\n\tNR_EVMCS_CTRLS,\n};\n\nstatic const u32 evmcs_supported_ctrls[NR_EVMCS_CTRLS][NR_EVMCS_REVISIONS] = {\n\t[EVMCS_EXIT_CTRLS] = {\n\t\t[EVMCSv1_LEGACY] = EVMCS1_SUPPORTED_VMEXIT_CTRL,\n\t},\n\t[EVMCS_ENTRY_CTRLS] = {\n\t\t[EVMCSv1_LEGACY] = EVMCS1_SUPPORTED_VMENTRY_CTRL,\n\t},\n\t[EVMCS_EXEC_CTRL] = {\n\t\t[EVMCSv1_LEGACY] = EVMCS1_SUPPORTED_EXEC_CTRL,\n\t},\n\t[EVMCS_2NDEXEC] = {\n\t\t[EVMCSv1_LEGACY] = EVMCS1_SUPPORTED_2NDEXEC & ~SECONDARY_EXEC_TSC_SCALING,\n\t},\n\t[EVMCS_3RDEXEC] = {\n\t\t[EVMCSv1_LEGACY] = EVMCS1_SUPPORTED_3RDEXEC,\n\t},\n\t[EVMCS_PINCTRL] = {\n\t\t[EVMCSv1_LEGACY] = EVMCS1_SUPPORTED_PINCTRL,\n\t},\n\t[EVMCS_VMFUNC] = {\n\t\t[EVMCSv1_LEGACY] = EVMCS1_SUPPORTED_VMFUNC,\n\t},\n};\n\nstatic u32 evmcs_get_supported_ctls(enum evmcs_ctrl_type ctrl_type)\n{\n\tenum evmcs_revision evmcs_rev = EVMCSv1_LEGACY;\n\n\treturn evmcs_supported_ctrls[ctrl_type][evmcs_rev];\n}\n\nstatic bool evmcs_has_perf_global_ctrl(struct kvm_vcpu *vcpu)\n{\n\tstruct kvm_vcpu_hv *hv_vcpu = to_hv_vcpu(vcpu);\n\n\t \n\tif (WARN_ON_ONCE(!hv_vcpu))\n\t\treturn false;\n\n\treturn hv_vcpu->cpuid_cache.nested_ebx & HV_X64_NESTED_EVMCS1_PERF_GLOBAL_CTRL;\n}\n\nvoid nested_evmcs_filter_control_msr(struct kvm_vcpu *vcpu, u32 msr_index, u64 *pdata)\n{\n\tu32 ctl_low = (u32)*pdata;\n\tu32 ctl_high = (u32)(*pdata >> 32);\n\tu32 supported_ctrls;\n\n\t \n\tswitch (msr_index) {\n\tcase MSR_IA32_VMX_EXIT_CTLS:\n\tcase MSR_IA32_VMX_TRUE_EXIT_CTLS:\n\t\tsupported_ctrls = evmcs_get_supported_ctls(EVMCS_EXIT_CTRLS);\n\t\tif (!evmcs_has_perf_global_ctrl(vcpu))\n\t\t\tsupported_ctrls &= ~VM_EXIT_LOAD_IA32_PERF_GLOBAL_CTRL;\n\t\tctl_high &= supported_ctrls;\n\t\tbreak;\n\tcase MSR_IA32_VMX_ENTRY_CTLS:\n\tcase MSR_IA32_VMX_TRUE_ENTRY_CTLS:\n\t\tsupported_ctrls = evmcs_get_supported_ctls(EVMCS_ENTRY_CTRLS);\n\t\tif (!evmcs_has_perf_global_ctrl(vcpu))\n\t\t\tsupported_ctrls &= ~VM_ENTRY_LOAD_IA32_PERF_GLOBAL_CTRL;\n\t\tctl_high &= supported_ctrls;\n\t\tbreak;\n\tcase MSR_IA32_VMX_PROCBASED_CTLS:\n\tcase MSR_IA32_VMX_TRUE_PROCBASED_CTLS:\n\t\tctl_high &= evmcs_get_supported_ctls(EVMCS_EXEC_CTRL);\n\t\tbreak;\n\tcase MSR_IA32_VMX_PROCBASED_CTLS2:\n\t\tctl_high &= evmcs_get_supported_ctls(EVMCS_2NDEXEC);\n\t\tbreak;\n\tcase MSR_IA32_VMX_TRUE_PINBASED_CTLS:\n\tcase MSR_IA32_VMX_PINBASED_CTLS:\n\t\tctl_high &= evmcs_get_supported_ctls(EVMCS_PINCTRL);\n\t\tbreak;\n\tcase MSR_IA32_VMX_VMFUNC:\n\t\tctl_low &= evmcs_get_supported_ctls(EVMCS_VMFUNC);\n\t\tbreak;\n\t}\n\n\t*pdata = ctl_low | ((u64)ctl_high << 32);\n}\n\nstatic bool nested_evmcs_is_valid_controls(enum evmcs_ctrl_type ctrl_type,\n\t\t\t\t\t   u32 val)\n{\n\treturn !(val & ~evmcs_get_supported_ctls(ctrl_type));\n}\n\nint nested_evmcs_check_controls(struct vmcs12 *vmcs12)\n{\n\tif (CC(!nested_evmcs_is_valid_controls(EVMCS_PINCTRL,\n\t\t\t\t\t       vmcs12->pin_based_vm_exec_control)))\n\t\treturn -EINVAL;\n\n\tif (CC(!nested_evmcs_is_valid_controls(EVMCS_EXEC_CTRL,\n\t\t\t\t\t       vmcs12->cpu_based_vm_exec_control)))\n\t\treturn -EINVAL;\n\n\tif (CC(!nested_evmcs_is_valid_controls(EVMCS_2NDEXEC,\n\t\t\t\t\t       vmcs12->secondary_vm_exec_control)))\n\t\treturn -EINVAL;\n\n\tif (CC(!nested_evmcs_is_valid_controls(EVMCS_EXIT_CTRLS,\n\t\t\t\t\t       vmcs12->vm_exit_controls)))\n\t\treturn -EINVAL;\n\n\tif (CC(!nested_evmcs_is_valid_controls(EVMCS_ENTRY_CTRLS,\n\t\t\t\t\t       vmcs12->vm_entry_controls)))\n\t\treturn -EINVAL;\n\n\t \n\tif (WARN_ON_ONCE(vmcs12->vm_function_control >> 32))\n\t\treturn -EINVAL;\n\n\tif (CC(!nested_evmcs_is_valid_controls(EVMCS_VMFUNC,\n\t\t\t\t\t       vmcs12->vm_function_control)))\n\t\treturn -EINVAL;\n\n\treturn 0;\n}\n\n#if IS_ENABLED(CONFIG_HYPERV)\nDEFINE_STATIC_KEY_FALSE(__kvm_is_using_evmcs);\n\n \n#define evmcs_check_vmcs_conf(field, ctrl)\t\t\t\t\t\\\n\tdo {\t\t\t\t\t\t\t\t\t\\\n\t\ttypeof(vmcs_conf->field) unsupported;\t\t\t\t\\\n\t\t\t\t\t\t\t\t\t\t\\\n\t\tunsupported = vmcs_conf->field & ~EVMCS1_SUPPORTED_ ## ctrl;\t\\\n\t\tif (unsupported) {\t\t\t\t\t\t\\\n\t\t\tpr_warn_once(#field \" unsupported with eVMCS: 0x%llx\\n\",\\\n\t\t\t\t     (u64)unsupported);\t\t\t\t\\\n\t\t\tvmcs_conf->field &= EVMCS1_SUPPORTED_ ## ctrl;\t\t\\\n\t\t}\t\t\t\t\t\t\t\t\\\n\t}\t\t\t\t\t\t\t\t\t\\\n\twhile (0)\n\nvoid evmcs_sanitize_exec_ctrls(struct vmcs_config *vmcs_conf)\n{\n\tevmcs_check_vmcs_conf(cpu_based_exec_ctrl, EXEC_CTRL);\n\tevmcs_check_vmcs_conf(pin_based_exec_ctrl, PINCTRL);\n\tevmcs_check_vmcs_conf(cpu_based_2nd_exec_ctrl, 2NDEXEC);\n\tevmcs_check_vmcs_conf(cpu_based_3rd_exec_ctrl, 3RDEXEC);\n\tevmcs_check_vmcs_conf(vmentry_ctrl, VMENTRY_CTRL);\n\tevmcs_check_vmcs_conf(vmexit_ctrl, VMEXIT_CTRL);\n}\n#endif\n\nint nested_enable_evmcs(struct kvm_vcpu *vcpu,\n\t\t\tuint16_t *vmcs_version)\n{\n\tstruct vcpu_vmx *vmx = to_vmx(vcpu);\n\n\tvmx->nested.enlightened_vmcs_enabled = true;\n\n\tif (vmcs_version)\n\t\t*vmcs_version = nested_get_evmcs_version(vcpu);\n\n\treturn 0;\n}\n\nbool nested_evmcs_l2_tlb_flush_enabled(struct kvm_vcpu *vcpu)\n{\n\tstruct kvm_vcpu_hv *hv_vcpu = to_hv_vcpu(vcpu);\n\tstruct vcpu_vmx *vmx = to_vmx(vcpu);\n\tstruct hv_enlightened_vmcs *evmcs = vmx->nested.hv_evmcs;\n\n\tif (!hv_vcpu || !evmcs)\n\t\treturn false;\n\n\tif (!evmcs->hv_enlightenments_control.nested_flush_hypercall)\n\t\treturn false;\n\n\treturn hv_vcpu->vp_assist_page.nested_control.features.directhypercall;\n}\n\nvoid vmx_hv_inject_synthetic_vmexit_post_tlb_flush(struct kvm_vcpu *vcpu)\n{\n\tnested_vmx_vmexit(vcpu, HV_VMX_SYNTHETIC_EXIT_REASON_TRAP_AFTER_FLUSH, 0, 0);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}