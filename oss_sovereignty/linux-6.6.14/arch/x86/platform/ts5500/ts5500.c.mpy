{
  "module_name": "ts5500.c",
  "hash_id": "33436682ba84b0557f50cb1b2412cd91d0e7e8de639843ddb71f8daf2e6f1f3f",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/platform/ts5500/ts5500.c",
  "human_readable_source": "\n \n\n#include <linux/delay.h>\n#include <linux/io.h>\n#include <linux/kernel.h>\n#include <linux/leds.h>\n#include <linux/init.h>\n#include <linux/platform_data/max197.h>\n#include <linux/platform_device.h>\n#include <linux/slab.h>\n\n \n#define TS5500_PRODUCT_CODE_ADDR\t0x74\n#define TS5500_PRODUCT_CODE\t\t0x60\t \n#define TS5400_PRODUCT_CODE\t\t0x40\t \n\n \n#define TS5500_SRAM_RS485_ADC_ADDR\t0x75\n#define TS5500_SRAM\t\t\tBIT(0)\t \n#define TS5500_RS485\t\t\tBIT(1)\t \n#define TS5500_ADC\t\t\tBIT(2)\t \n#define TS5500_RS485_RTS\t\tBIT(6)\t \n#define TS5500_RS485_AUTO\t\tBIT(7)\t \n\n \n#define TS5500_ERESET_ITR_ADDR\t\t0x76\n#define TS5500_ERESET\t\t\tBIT(0)\t \n#define TS5500_ITR\t\t\tBIT(1)\t \n\n \n#define TS5500_LED_JP_ADDR\t\t0x77\n#define TS5500_LED\t\t\tBIT(0)\t \n#define TS5500_JP1\t\t\tBIT(1)\t \n#define TS5500_JP2\t\t\tBIT(2)\t \n#define TS5500_JP3\t\t\tBIT(3)\t \n#define TS5500_JP4\t\t\tBIT(4)\t \n#define TS5500_JP5\t\t\tBIT(5)\t \n#define TS5500_JP6\t\t\tBIT(6)\t \n#define TS5500_JP7\t\t\tBIT(7)\t \n\n \n#define TS5500_ADC_CONV_BUSY_ADDR\t0x195\t \n#define TS5500_ADC_CONV_BUSY\t\tBIT(0)\n#define TS5500_ADC_CONV_INIT_LSB_ADDR\t0x196\t \n#define TS5500_ADC_CONV_MSB_ADDR\t0x197\t \n#define TS5500_ADC_CONV_DELAY\t\t12\t \n\n \nstruct ts5500_sbc {\n\tconst char *name;\n\tint\tid;\n\tbool\tsram;\n\tbool\trs485;\n\tbool\tadc;\n\tbool\tereset;\n\tbool\titr;\n\tu8\tjumpers;\n};\n\n \nstatic const struct {\n\tconst char * const string;\n\tconst ssize_t offset;\n} ts5500_signatures[] __initconst = {\n\t{ \"TS-5x00 AMD Elan\", 0xb14 },\n};\n\nstatic int __init ts5500_check_signature(void)\n{\n\tvoid __iomem *bios;\n\tint i, ret = -ENODEV;\n\n\tbios = ioremap(0xf0000, 0x10000);\n\tif (!bios)\n\t\treturn -ENOMEM;\n\n\tfor (i = 0; i < ARRAY_SIZE(ts5500_signatures); i++) {\n\t\tif (check_signature(bios + ts5500_signatures[i].offset,\n\t\t\t\t    ts5500_signatures[i].string,\n\t\t\t\t    strlen(ts5500_signatures[i].string))) {\n\t\t\tret = 0;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tiounmap(bios);\n\treturn ret;\n}\n\nstatic int __init ts5500_detect_config(struct ts5500_sbc *sbc)\n{\n\tu8 tmp;\n\tint ret = 0;\n\n\tif (!request_region(TS5500_PRODUCT_CODE_ADDR, 4, \"ts5500\"))\n\t\treturn -EBUSY;\n\n\tsbc->id = inb(TS5500_PRODUCT_CODE_ADDR);\n\tif (sbc->id == TS5500_PRODUCT_CODE) {\n\t\tsbc->name = \"TS-5500\";\n\t} else if (sbc->id == TS5400_PRODUCT_CODE) {\n\t\tsbc->name = \"TS-5400\";\n\t} else {\n\t\tpr_err(\"ts5500: unknown product code 0x%x\\n\", sbc->id);\n\t\tret = -ENODEV;\n\t\tgoto cleanup;\n\t}\n\n\ttmp = inb(TS5500_SRAM_RS485_ADC_ADDR);\n\tsbc->sram = tmp & TS5500_SRAM;\n\tsbc->rs485 = tmp & TS5500_RS485;\n\tsbc->adc = tmp & TS5500_ADC;\n\n\ttmp = inb(TS5500_ERESET_ITR_ADDR);\n\tsbc->ereset = tmp & TS5500_ERESET;\n\tsbc->itr = tmp & TS5500_ITR;\n\n\ttmp = inb(TS5500_LED_JP_ADDR);\n\tsbc->jumpers = tmp & ~TS5500_LED;\n\ncleanup:\n\trelease_region(TS5500_PRODUCT_CODE_ADDR, 4);\n\treturn ret;\n}\n\nstatic ssize_t name_show(struct device *dev, struct device_attribute *attr,\n\t\tchar *buf)\n{\n\tstruct ts5500_sbc *sbc = dev_get_drvdata(dev);\n\n\treturn sprintf(buf, \"%s\\n\", sbc->name);\n}\nstatic DEVICE_ATTR_RO(name);\n\nstatic ssize_t id_show(struct device *dev, struct device_attribute *attr,\n\t\tchar *buf)\n{\n\tstruct ts5500_sbc *sbc = dev_get_drvdata(dev);\n\n\treturn sprintf(buf, \"0x%.2x\\n\", sbc->id);\n}\nstatic DEVICE_ATTR_RO(id);\n\nstatic ssize_t jumpers_show(struct device *dev, struct device_attribute *attr,\n\t\tchar *buf)\n{\n\tstruct ts5500_sbc *sbc = dev_get_drvdata(dev);\n\n\treturn sprintf(buf, \"0x%.2x\\n\", sbc->jumpers >> 1);\n}\nstatic DEVICE_ATTR_RO(jumpers);\n\n#define TS5500_ATTR_BOOL(_field)\t\t\t\t\t\\\n\tstatic ssize_t _field##_show(struct device *dev,\t\t\\\n\t\t\tstruct device_attribute *attr, char *buf)\t\\\n\t{\t\t\t\t\t\t\t\t\\\n\t\tstruct ts5500_sbc *sbc = dev_get_drvdata(dev);\t\t\\\n\t\t\t\t\t\t\t\t\t\\\n\t\treturn sprintf(buf, \"%d\\n\", sbc->_field);\t\t\\\n\t}\t\t\t\t\t\t\t\t\\\n\tstatic DEVICE_ATTR_RO(_field)\n\nTS5500_ATTR_BOOL(sram);\nTS5500_ATTR_BOOL(rs485);\nTS5500_ATTR_BOOL(adc);\nTS5500_ATTR_BOOL(ereset);\nTS5500_ATTR_BOOL(itr);\n\nstatic struct attribute *ts5500_attributes[] = {\n\t&dev_attr_id.attr,\n\t&dev_attr_name.attr,\n\t&dev_attr_jumpers.attr,\n\t&dev_attr_sram.attr,\n\t&dev_attr_rs485.attr,\n\t&dev_attr_adc.attr,\n\t&dev_attr_ereset.attr,\n\t&dev_attr_itr.attr,\n\tNULL\n};\n\nstatic const struct attribute_group ts5500_attr_group = {\n\t.attrs = ts5500_attributes,\n};\n\nstatic struct resource ts5500_dio1_resource[] = {\n\tDEFINE_RES_IRQ_NAMED(7, \"DIO1 interrupt\"),\n};\n\nstatic struct platform_device ts5500_dio1_pdev = {\n\t.name = \"ts5500-dio1\",\n\t.id = -1,\n\t.resource = ts5500_dio1_resource,\n\t.num_resources = 1,\n};\n\nstatic struct resource ts5500_dio2_resource[] = {\n\tDEFINE_RES_IRQ_NAMED(6, \"DIO2 interrupt\"),\n};\n\nstatic struct platform_device ts5500_dio2_pdev = {\n\t.name = \"ts5500-dio2\",\n\t.id = -1,\n\t.resource = ts5500_dio2_resource,\n\t.num_resources = 1,\n};\n\nstatic void ts5500_led_set(struct led_classdev *led_cdev,\n\t\t\t   enum led_brightness brightness)\n{\n\toutb(!!brightness, TS5500_LED_JP_ADDR);\n}\n\nstatic enum led_brightness ts5500_led_get(struct led_classdev *led_cdev)\n{\n\treturn (inb(TS5500_LED_JP_ADDR) & TS5500_LED) ? LED_FULL : LED_OFF;\n}\n\nstatic struct led_classdev ts5500_led_cdev = {\n\t.name = \"ts5500:green:\",\n\t.brightness_set = ts5500_led_set,\n\t.brightness_get = ts5500_led_get,\n};\n\nstatic int ts5500_adc_convert(u8 ctrl)\n{\n\tu8 lsb, msb;\n\n\t \n\toutb(ctrl & 0x1f, TS5500_ADC_CONV_INIT_LSB_ADDR);\n\n\t \n\tudelay(TS5500_ADC_CONV_DELAY);\n\tif (inb(TS5500_ADC_CONV_BUSY_ADDR) & TS5500_ADC_CONV_BUSY)\n\t\treturn -EBUSY;\n\n\t \n\tlsb = inb(TS5500_ADC_CONV_INIT_LSB_ADDR);\n\tmsb = inb(TS5500_ADC_CONV_MSB_ADDR);\n\n\treturn (msb << 8) | lsb;\n}\n\nstatic struct max197_platform_data ts5500_adc_pdata = {\n\t.convert = ts5500_adc_convert,\n};\n\nstatic struct platform_device ts5500_adc_pdev = {\n\t.name = \"max197\",\n\t.id = -1,\n\t.dev = {\n\t\t.platform_data = &ts5500_adc_pdata,\n\t},\n};\n\nstatic int __init ts5500_init(void)\n{\n\tstruct platform_device *pdev;\n\tstruct ts5500_sbc *sbc;\n\tint err;\n\n\t \n\terr = ts5500_check_signature();\n\tif (err)\n\t\treturn err;\n\n\tpdev = platform_device_register_simple(\"ts5500\", -1, NULL, 0);\n\tif (IS_ERR(pdev))\n\t\treturn PTR_ERR(pdev);\n\n\tsbc = devm_kzalloc(&pdev->dev, sizeof(struct ts5500_sbc), GFP_KERNEL);\n\tif (!sbc) {\n\t\terr = -ENOMEM;\n\t\tgoto error;\n\t}\n\n\terr = ts5500_detect_config(sbc);\n\tif (err)\n\t\tgoto error;\n\n\tplatform_set_drvdata(pdev, sbc);\n\n\terr = sysfs_create_group(&pdev->dev.kobj, &ts5500_attr_group);\n\tif (err)\n\t\tgoto error;\n\n\tif (sbc->id == TS5500_PRODUCT_CODE) {\n\t\tts5500_dio1_pdev.dev.parent = &pdev->dev;\n\t\tif (platform_device_register(&ts5500_dio1_pdev))\n\t\t\tdev_warn(&pdev->dev, \"DIO1 block registration failed\\n\");\n\t\tts5500_dio2_pdev.dev.parent = &pdev->dev;\n\t\tif (platform_device_register(&ts5500_dio2_pdev))\n\t\t\tdev_warn(&pdev->dev, \"DIO2 block registration failed\\n\");\n\t}\n\n\tif (led_classdev_register(&pdev->dev, &ts5500_led_cdev))\n\t\tdev_warn(&pdev->dev, \"LED registration failed\\n\");\n\n\tif (sbc->adc) {\n\t\tts5500_adc_pdev.dev.parent = &pdev->dev;\n\t\tif (platform_device_register(&ts5500_adc_pdev))\n\t\t\tdev_warn(&pdev->dev, \"ADC registration failed\\n\");\n\t}\n\n\treturn 0;\nerror:\n\tplatform_device_unregister(pdev);\n\treturn err;\n}\ndevice_initcall(ts5500_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}