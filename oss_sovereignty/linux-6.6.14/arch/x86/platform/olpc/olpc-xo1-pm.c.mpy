{
  "module_name": "olpc-xo1-pm.c",
  "hash_id": "e54db030e741d1d8b463ce5bccd07a765404565bda7b3cde272f197ee24d0153",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/platform/olpc/olpc-xo1-pm.c",
  "human_readable_source": "\n \n\n#include <linux/cs5535.h>\n#include <linux/platform_device.h>\n#include <linux/export.h>\n#include <linux/pm.h>\n#include <linux/suspend.h>\n#include <linux/olpc-ec.h>\n\n#include <asm/io.h>\n#include <asm/olpc.h>\n\n#define DRV_NAME \"olpc-xo1-pm\"\n\nstatic unsigned long acpi_base;\nstatic unsigned long pms_base;\n\nstatic u16 wakeup_mask = CS5536_PM_PWRBTN;\n\nstatic struct {\n\tunsigned long address;\n\tunsigned short segment;\n} ofw_bios_entry = { 0xF0000 + PAGE_OFFSET, __KERNEL_CS };\n\n \nvoid olpc_xo1_pm_wakeup_set(u16 value)\n{\n\twakeup_mask |= value;\n}\nEXPORT_SYMBOL_GPL(olpc_xo1_pm_wakeup_set);\n\n \nvoid olpc_xo1_pm_wakeup_clear(u16 value)\n{\n\twakeup_mask &= ~value;\n}\nEXPORT_SYMBOL_GPL(olpc_xo1_pm_wakeup_clear);\n\nstatic int xo1_power_state_enter(suspend_state_t pm_state)\n{\n\tunsigned long saved_sci_mask;\n\n\t \n\tif (pm_state != PM_SUSPEND_MEM)\n\t\treturn -EINVAL;\n\n\t \n\tsaved_sci_mask = inl(acpi_base + CS5536_PM1_STS);\n\tsaved_sci_mask &= 0xffff0000;\n\n\t \n\tdo_olpc_suspend_lowlevel();\n\n\t \n\n\t \n\toutl(saved_sci_mask, acpi_base + CS5536_PM1_STS);\n\n\treturn 0;\n}\n\nasmlinkage __visible int xo1_do_sleep(u8 sleep_state)\n{\n\tvoid *pgd_addr = __va(read_cr3_pa());\n\n\t \n\toutl(wakeup_mask << 16, acpi_base + CS5536_PM1_STS);\n\n\t__asm__(\"movl %0,%%eax\" : : \"r\" (pgd_addr));\n\t__asm__(\"call *(%%edi); cld\"\n\t\t: : \"D\" (&ofw_bios_entry));\n\t__asm__(\"movb $0x34, %al\\n\\t\"\n\t\t\"outb %al, $0x70\\n\\t\"\n\t\t\"movb $0x30, %al\\n\\t\"\n\t\t\"outb %al, $0x71\\n\\t\");\n\treturn 0;\n}\n\nstatic void xo1_power_off(void)\n{\n\tprintk(KERN_INFO \"OLPC XO-1 power off sequence...\\n\");\n\n\t \n\toutl(0x40000000, pms_base + CS5536_PM_SCLK);\n\toutl(0x40000000, pms_base + CS5536_PM_IN_SLPCTL);\n\toutl(0x40000000, pms_base + CS5536_PM_WKXD);\n\toutl(0x40000000, pms_base + CS5536_PM_WKD);\n\n\t \n\toutl(0x0002ffff, pms_base  + CS5536_PM_SSC);\n\toutl(0xffffffff, acpi_base + CS5536_PM_GPE0_STS);\n\n\t \n\toutl(0x00002000, acpi_base + CS5536_PM1_CNT);\n}\n\nstatic int xo1_power_state_valid(suspend_state_t pm_state)\n{\n\t \n\treturn pm_state == PM_SUSPEND_MEM;\n}\n\nstatic const struct platform_suspend_ops xo1_suspend_ops = {\n\t.valid = xo1_power_state_valid,\n\t.enter = xo1_power_state_enter,\n};\n\nstatic int xo1_pm_probe(struct platform_device *pdev)\n{\n\tstruct resource *res;\n\n\t \n\tif (!machine_is_olpc())\n\t\treturn -ENODEV;\n\n\tres = platform_get_resource(pdev, IORESOURCE_IO, 0);\n\tif (!res) {\n\t\tdev_err(&pdev->dev, \"can't fetch device resource info\\n\");\n\t\treturn -EIO;\n\t}\n\tif (strcmp(pdev->name, \"cs5535-pms\") == 0)\n\t\tpms_base = res->start;\n\telse if (strcmp(pdev->name, \"olpc-xo1-pm-acpi\") == 0)\n\t\tacpi_base = res->start;\n\n\t \n\tif (pms_base && acpi_base) {\n\t\tsuspend_set_ops(&xo1_suspend_ops);\n\t\tpm_power_off = xo1_power_off;\n\t\tprintk(KERN_INFO \"OLPC XO-1 support registered\\n\");\n\t}\n\n\treturn 0;\n}\n\nstatic int xo1_pm_remove(struct platform_device *pdev)\n{\n\tif (strcmp(pdev->name, \"cs5535-pms\") == 0)\n\t\tpms_base = 0;\n\telse if (strcmp(pdev->name, \"olpc-xo1-pm-acpi\") == 0)\n\t\tacpi_base = 0;\n\n\tpm_power_off = NULL;\n\treturn 0;\n}\n\nstatic struct platform_driver cs5535_pms_driver = {\n\t.driver = {\n\t\t.name = \"cs5535-pms\",\n\t},\n\t.probe = xo1_pm_probe,\n\t.remove = xo1_pm_remove,\n};\n\nstatic struct platform_driver cs5535_acpi_driver = {\n\t.driver = {\n\t\t.name = \"olpc-xo1-pm-acpi\",\n\t},\n\t.probe = xo1_pm_probe,\n\t.remove = xo1_pm_remove,\n};\n\nstatic int __init xo1_pm_init(void)\n{\n\tint r;\n\n\tr = platform_driver_register(&cs5535_pms_driver);\n\tif (r)\n\t\treturn r;\n\n\tr = platform_driver_register(&cs5535_acpi_driver);\n\tif (r)\n\t\tplatform_driver_unregister(&cs5535_pms_driver);\n\n\treturn r;\n}\narch_initcall(xo1_pm_init);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}