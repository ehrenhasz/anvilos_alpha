{
  "module_name": "olpc_dt.c",
  "hash_id": "f7f7ba57d80427c4fe2eaa660c33202e4a02f928e34687943fbb3c1982bf8547",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/platform/olpc/olpc_dt.c",
  "human_readable_source": "\n \n\n#include <linux/kernel.h>\n#include <linux/memblock.h>\n#include <linux/of.h>\n#include <linux/of_pdt.h>\n#include <asm/olpc.h>\n#include <asm/olpc_ofw.h>\n\nstatic phandle __init olpc_dt_getsibling(phandle node)\n{\n\tconst void *args[] = { (void *)node };\n\tvoid *res[] = { &node };\n\n\tif ((s32)node == -1)\n\t\treturn 0;\n\n\tif (olpc_ofw(\"peer\", args, res) || (s32)node == -1)\n\t\treturn 0;\n\n\treturn node;\n}\n\nstatic phandle __init olpc_dt_getchild(phandle node)\n{\n\tconst void *args[] = { (void *)node };\n\tvoid *res[] = { &node };\n\n\tif ((s32)node == -1)\n\t\treturn 0;\n\n\tif (olpc_ofw(\"child\", args, res) || (s32)node == -1) {\n\t\tpr_err(\"PROM: %s: fetching child failed!\\n\", __func__);\n\t\treturn 0;\n\t}\n\n\treturn node;\n}\n\nstatic int __init olpc_dt_getproplen(phandle node, const char *prop)\n{\n\tconst void *args[] = { (void *)node, prop };\n\tint len;\n\tvoid *res[] = { &len };\n\n\tif ((s32)node == -1)\n\t\treturn -1;\n\n\tif (olpc_ofw(\"getproplen\", args, res)) {\n\t\tpr_err(\"PROM: %s: getproplen failed!\\n\", __func__);\n\t\treturn -1;\n\t}\n\n\treturn len;\n}\n\nstatic int __init olpc_dt_getproperty(phandle node, const char *prop,\n\t\tchar *buf, int bufsize)\n{\n\tint plen;\n\n\tplen = olpc_dt_getproplen(node, prop);\n\tif (plen > bufsize || plen < 1) {\n\t\treturn -1;\n\t} else {\n\t\tconst void *args[] = { (void *)node, prop, buf, (void *)plen };\n\t\tvoid *res[] = { &plen };\n\n\t\tif (olpc_ofw(\"getprop\", args, res)) {\n\t\t\tpr_err(\"PROM: %s: getprop failed!\\n\", __func__);\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\treturn plen;\n}\n\nstatic int __init olpc_dt_nextprop(phandle node, char *prev, char *buf)\n{\n\tconst void *args[] = { (void *)node, prev, buf };\n\tint success;\n\tvoid *res[] = { &success };\n\n\tbuf[0] = '\\0';\n\n\tif ((s32)node == -1)\n\t\treturn -1;\n\n\tif (olpc_ofw(\"nextprop\", args, res) || success != 1)\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic int __init olpc_dt_pkg2path(phandle node, char *buf,\n\t\tconst int buflen, int *len)\n{\n\tconst void *args[] = { (void *)node, buf, (void *)buflen };\n\tvoid *res[] = { len };\n\n\tif ((s32)node == -1)\n\t\treturn -1;\n\n\tif (olpc_ofw(\"package-to-path\", args, res) || *len < 1)\n\t\treturn -1;\n\n\treturn 0;\n}\n\nstatic unsigned int prom_early_allocated __initdata;\n\nvoid * __init prom_early_alloc(unsigned long size)\n{\n\tstatic u8 *mem;\n\tstatic size_t free_mem;\n\tvoid *res;\n\n\tif (free_mem < size) {\n\t\tconst size_t chunk_size = max(PAGE_SIZE, size);\n\n\t\t \n\t\tres = memblock_alloc(chunk_size, SMP_CACHE_BYTES);\n\t\tif (!res)\n\t\t\tpanic(\"%s: Failed to allocate %zu bytes\\n\", __func__,\n\t\t\t      chunk_size);\n\t\tBUG_ON(!res);\n\t\tprom_early_allocated += chunk_size;\n\t\tmemset(res, 0, chunk_size);\n\t\tfree_mem = chunk_size;\n\t\tmem = res;\n\t}\n\n\t \n\tfree_mem -= size;\n\tres = mem;\n\tmem += size;\n\treturn res;\n}\n\nstatic struct of_pdt_ops prom_olpc_ops __initdata = {\n\t.nextprop = olpc_dt_nextprop,\n\t.getproplen = olpc_dt_getproplen,\n\t.getproperty = olpc_dt_getproperty,\n\t.getchild = olpc_dt_getchild,\n\t.getsibling = olpc_dt_getsibling,\n\t.pkg2path = olpc_dt_pkg2path,\n};\n\nstatic phandle __init olpc_dt_finddevice(const char *path)\n{\n\tphandle node;\n\tconst void *args[] = { path };\n\tvoid *res[] = { &node };\n\n\tif (olpc_ofw(\"finddevice\", args, res)) {\n\t\tpr_err(\"olpc_dt: finddevice failed!\\n\");\n\t\treturn 0;\n\t}\n\n\tif ((s32) node == -1)\n\t\treturn 0;\n\n\treturn node;\n}\n\nstatic int __init olpc_dt_interpret(const char *words)\n{\n\tint result;\n\tconst void *args[] = { words };\n\tvoid *res[] = { &result };\n\n\tif (olpc_ofw(\"interpret\", args, res)) {\n\t\tpr_err(\"olpc_dt: interpret failed!\\n\");\n\t\treturn -1;\n\t}\n\n\treturn result;\n}\n\n \nstatic u32 __init olpc_dt_get_board_revision(void)\n{\n\tphandle node;\n\t__be32 rev;\n\tint r;\n\n\tnode = olpc_dt_finddevice(\"/\");\n\tif (!node)\n\t\treturn 0;\n\n\tr = olpc_dt_getproperty(node, \"board-revision-int\",\n\t\t\t\t(char *) &rev, sizeof(rev));\n\tif (r < 0)\n\t\treturn 0;\n\n\treturn be32_to_cpu(rev);\n}\n\nstatic int __init olpc_dt_compatible_match(phandle node, const char *compat)\n{\n\tchar buf[64], *p;\n\tint plen, len;\n\n\tplen = olpc_dt_getproperty(node, \"compatible\", buf, sizeof(buf));\n\tif (plen <= 0)\n\t\treturn 0;\n\n\tlen = strlen(compat);\n\tfor (p = buf; p < buf + plen; p += strlen(p) + 1) {\n\t\tif (strcmp(p, compat) == 0)\n\t\t\treturn 1;\n\t}\n\n\treturn 0;\n}\n\nstatic void __init olpc_dt_fixup(void)\n{\n\tphandle node;\n\tu32 board_rev;\n\n\tnode = olpc_dt_finddevice(\"/battery@0\");\n\tif (!node)\n\t\treturn;\n\n\tboard_rev = olpc_dt_get_board_revision();\n\tif (!board_rev)\n\t\treturn;\n\n\tif (board_rev >= olpc_board_pre(0xd0)) {\n\t\t \n\n\t\tif (olpc_dt_compatible_match(node, \"olpc,xo1.5-battery\"))\n\t\t\treturn;\n\n\t\t \n\t\tolpc_dt_interpret(\"\\\" /battery@0\\\" find-device\");\n\t\tolpc_dt_interpret(\"  \\\" olpc,xo1.5-battery\\\" +compatible\");\n\t\tolpc_dt_interpret(\"device-end\");\n\n\t\tif (olpc_dt_compatible_match(node, \"olpc,xo1-battery\")) {\n\t\t\t \n\t\t\treturn;\n\t\t}\n\n\t\t \n\t\tolpc_dt_interpret(\"\\\" /pci/display@1\\\" find-device\");\n\t\tolpc_dt_interpret(\"  new-device\");\n\t\tolpc_dt_interpret(\"    \\\" dcon\\\" device-name\");\n\t\tolpc_dt_interpret(\"    \\\" olpc,xo1-dcon\\\" +compatible\");\n\t\tolpc_dt_interpret(\"  finish-device\");\n\t\tolpc_dt_interpret(\"device-end\");\n\t} else {\n\t\t \n\n\t\tif (olpc_dt_compatible_match(node, \"olpc,xo1-battery\")) {\n\t\t\t \n\t\t\treturn;\n\t\t}\n\n\t\t \n\t\tolpc_dt_interpret(\"\\\" /pci/display@1,1\\\" find-device\");\n\t\tolpc_dt_interpret(\"  new-device\");\n\t\tolpc_dt_interpret(\"    \\\" dcon\\\" device-name\");\n\t\tolpc_dt_interpret(\"    \\\" olpc,xo1-dcon\\\" +compatible\");\n\t\tolpc_dt_interpret(\"  finish-device\");\n\t\tolpc_dt_interpret(\"device-end\");\n\n\t\tolpc_dt_interpret(\"\\\" /rtc\\\" find-device\");\n\t\tolpc_dt_interpret(\" \\\" olpc,xo1-rtc\\\" +compatible\");\n\t\tolpc_dt_interpret(\"device-end\");\n\t}\n\n\t \n\tolpc_dt_interpret(\"\\\" /battery@0\\\" find-device\");\n\tolpc_dt_interpret(\"  \\\" olpc,xo1-battery\\\" +compatible\");\n\tolpc_dt_interpret(\"device-end\");\n}\n\nvoid __init olpc_dt_build_devicetree(void)\n{\n\tphandle root;\n\n\tif (!olpc_ofw_is_installed())\n\t\treturn;\n\n\tolpc_dt_fixup();\n\n\troot = olpc_dt_getsibling(0);\n\tif (!root) {\n\t\tpr_err(\"PROM: unable to get root node from OFW!\\n\");\n\t\treturn;\n\t}\n\tof_pdt_build_devicetree(root, &prom_olpc_ops);\n\n\tpr_info(\"PROM DT: Built device tree with %u bytes of memory.\\n\",\n\t\t\tprom_early_allocated);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}