{
  "module_name": "enlighten.c",
  "hash_id": "1ff7d29f0ed38b86c6922397bdbfcba427d1e9f6045bfbaa7005ffbec25af96f",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/platform/pvh/enlighten.c",
  "human_readable_source": "\n#include <linux/acpi.h>\n\n#include <xen/hvc-console.h>\n\n#include <asm/io_apic.h>\n#include <asm/hypervisor.h>\n#include <asm/e820/api.h>\n#include <asm/x86_init.h>\n\n#include <asm/xen/interface.h>\n\n#include <xen/xen.h>\n#include <xen/interface/hvm/start_info.h>\n\n \nstruct boot_params __initdata pvh_bootparams;\nstruct hvm_start_info __initdata pvh_start_info;\n\nconst unsigned int __initconst pvh_start_info_sz = sizeof(pvh_start_info);\n\nstatic u64 __init pvh_get_root_pointer(void)\n{\n\treturn pvh_start_info.rsdp_paddr;\n}\n\n \nvoid __init __weak mem_map_via_hcall(struct boot_params *ptr __maybe_unused)\n{\n\txen_raw_printk(\"Error: Could not find memory map\\n\");\n\tBUG();\n}\n\nstatic void __init init_pvh_bootparams(bool xen_guest)\n{\n\tif ((pvh_start_info.version > 0) && (pvh_start_info.memmap_entries)) {\n\t\tstruct hvm_memmap_table_entry *ep;\n\t\tint i;\n\n\t\tep = __va(pvh_start_info.memmap_paddr);\n\t\tpvh_bootparams.e820_entries = pvh_start_info.memmap_entries;\n\n\t\tfor (i = 0; i < pvh_bootparams.e820_entries ; i++, ep++) {\n\t\t\tpvh_bootparams.e820_table[i].addr = ep->addr;\n\t\t\tpvh_bootparams.e820_table[i].size = ep->size;\n\t\t\tpvh_bootparams.e820_table[i].type = ep->type;\n\t\t}\n\t} else if (xen_guest) {\n\t\tmem_map_via_hcall(&pvh_bootparams);\n\t} else {\n\t\t \n\t\tBUG();\n\t}\n\n\tif (pvh_bootparams.e820_entries < E820_MAX_ENTRIES_ZEROPAGE - 1) {\n\t\tpvh_bootparams.e820_table[pvh_bootparams.e820_entries].addr =\n\t\t\tISA_START_ADDRESS;\n\t\tpvh_bootparams.e820_table[pvh_bootparams.e820_entries].size =\n\t\t\tISA_END_ADDRESS - ISA_START_ADDRESS;\n\t\tpvh_bootparams.e820_table[pvh_bootparams.e820_entries].type =\n\t\t\tE820_TYPE_RESERVED;\n\t\tpvh_bootparams.e820_entries++;\n\t} else\n\t\txen_raw_printk(\"Warning: Can fit ISA range into e820\\n\");\n\n\tpvh_bootparams.hdr.cmd_line_ptr =\n\t\tpvh_start_info.cmdline_paddr;\n\n\t \n\tif (pvh_start_info.nr_modules) {\n\t\tstruct hvm_modlist_entry *modaddr =\n\t\t\t__va(pvh_start_info.modlist_paddr);\n\t\tpvh_bootparams.hdr.ramdisk_image = modaddr->paddr;\n\t\tpvh_bootparams.hdr.ramdisk_size = modaddr->size;\n\t}\n\n\t \n\tpvh_bootparams.hdr.version = (2 << 8) | 12;\n\tpvh_bootparams.hdr.type_of_loader = ((xen_guest ? 0x9 : 0xb) << 4) | 0;\n\n\tx86_init.acpi.get_root_pointer = pvh_get_root_pointer;\n}\n\n \nvoid __init __weak xen_pvh_init(struct boot_params *boot_params)\n{\n\txen_raw_printk(\"Error: Missing xen PVH initialization\\n\");\n\tBUG();\n}\n\nstatic void __init hypervisor_specific_init(bool xen_guest)\n{\n\tif (xen_guest)\n\t\txen_pvh_init(&pvh_bootparams);\n}\n\n \nvoid __init xen_prepare_pvh(void)\n{\n\n\tu32 msr = xen_cpuid_base();\n\tbool xen_guest = !!msr;\n\n\tif (pvh_start_info.magic != XEN_HVM_START_MAGIC_VALUE) {\n\t\txen_raw_printk(\"Error: Unexpected magic value (0x%08x)\\n\",\n\t\t\t\tpvh_start_info.magic);\n\t\tBUG();\n\t}\n\n\tmemset(&pvh_bootparams, 0, sizeof(pvh_bootparams));\n\n\thypervisor_specific_init(xen_guest);\n\n\tinit_pvh_bootparams(xen_guest);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}