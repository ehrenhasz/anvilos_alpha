{
  "module_name": "hibernate.c",
  "hash_id": "5a1d1b5875a5efa9dd1a97dd74a0c3f40fb1754c2961b78fb11efe26df4fa955",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/power/hibernate.c",
  "human_readable_source": "\n \n#include <linux/gfp.h>\n#include <linux/smp.h>\n#include <linux/suspend.h>\n#include <linux/scatterlist.h>\n#include <linux/kdebug.h>\n#include <linux/cpu.h>\n#include <linux/pgtable.h>\n#include <linux/types.h>\n#include <linux/crc32.h>\n\n#include <asm/e820/api.h>\n#include <asm/init.h>\n#include <asm/proto.h>\n#include <asm/page.h>\n#include <asm/mtrr.h>\n#include <asm/sections.h>\n#include <asm/suspend.h>\n#include <asm/tlbflush.h>\n\n \nunsigned long restore_jump_address __visible;\nunsigned long jump_address_phys;\n\n \nunsigned long restore_cr3 __visible;\nunsigned long temp_pgt __visible;\nunsigned long relocated_restore_code __visible;\n\n \nint pfn_is_nosave(unsigned long pfn)\n{\n\tunsigned long nosave_begin_pfn;\n\tunsigned long nosave_end_pfn;\n\n\tnosave_begin_pfn = __pa_symbol(&__nosave_begin) >> PAGE_SHIFT;\n\tnosave_end_pfn = PAGE_ALIGN(__pa_symbol(&__nosave_end)) >> PAGE_SHIFT;\n\n\treturn pfn >= nosave_begin_pfn && pfn < nosave_end_pfn;\n}\n\nstruct restore_data_record {\n\tunsigned long jump_address;\n\tunsigned long jump_address_phys;\n\tunsigned long cr3;\n\tunsigned long magic;\n\tunsigned long e820_checksum;\n};\n\n \nstatic inline u32 compute_e820_crc32(struct e820_table *table)\n{\n\tint size = offsetof(struct e820_table, entries) +\n\t\tsizeof(struct e820_entry) * table->nr_entries;\n\n\treturn ~crc32_le(~0, (unsigned char const *)table, size);\n}\n\n#ifdef CONFIG_X86_64\n#define RESTORE_MAGIC\t0x23456789ABCDEF02UL\n#else\n#define RESTORE_MAGIC\t0x12345679UL\n#endif\n\n \nint arch_hibernation_header_save(void *addr, unsigned int max_size)\n{\n\tstruct restore_data_record *rdr = addr;\n\n\tif (max_size < sizeof(struct restore_data_record))\n\t\treturn -EOVERFLOW;\n\trdr->magic = RESTORE_MAGIC;\n\trdr->jump_address = (unsigned long)restore_registers;\n\trdr->jump_address_phys = __pa_symbol(restore_registers);\n\n\t \n\trdr->cr3 = restore_cr3 & ~CR3_PCID_MASK;\n\n\trdr->e820_checksum = compute_e820_crc32(e820_table_firmware);\n\treturn 0;\n}\n\n \nint arch_hibernation_header_restore(void *addr)\n{\n\tstruct restore_data_record *rdr = addr;\n\n\tif (rdr->magic != RESTORE_MAGIC) {\n\t\tpr_crit(\"Unrecognized hibernate image header format!\\n\");\n\t\treturn -EINVAL;\n\t}\n\n\trestore_jump_address = rdr->jump_address;\n\tjump_address_phys = rdr->jump_address_phys;\n\trestore_cr3 = rdr->cr3;\n\n\tif (rdr->e820_checksum != compute_e820_crc32(e820_table_firmware)) {\n\t\tpr_crit(\"Hibernate inconsistent memory map detected!\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\treturn 0;\n}\n\nint relocate_restore_code(void)\n{\n\tpgd_t *pgd;\n\tp4d_t *p4d;\n\tpud_t *pud;\n\tpmd_t *pmd;\n\tpte_t *pte;\n\n\trelocated_restore_code = get_safe_page(GFP_ATOMIC);\n\tif (!relocated_restore_code)\n\t\treturn -ENOMEM;\n\n\t__memcpy((void *)relocated_restore_code, core_restore_code, PAGE_SIZE);\n\n\t \n\tpgd = (pgd_t *)__va(read_cr3_pa()) +\n\t\tpgd_index(relocated_restore_code);\n\tp4d = p4d_offset(pgd, relocated_restore_code);\n\tif (p4d_large(*p4d)) {\n\t\tset_p4d(p4d, __p4d(p4d_val(*p4d) & ~_PAGE_NX));\n\t\tgoto out;\n\t}\n\tpud = pud_offset(p4d, relocated_restore_code);\n\tif (pud_large(*pud)) {\n\t\tset_pud(pud, __pud(pud_val(*pud) & ~_PAGE_NX));\n\t\tgoto out;\n\t}\n\tpmd = pmd_offset(pud, relocated_restore_code);\n\tif (pmd_large(*pmd)) {\n\t\tset_pmd(pmd, __pmd(pmd_val(*pmd) & ~_PAGE_NX));\n\t\tgoto out;\n\t}\n\tpte = pte_offset_kernel(pmd, relocated_restore_code);\n\tset_pte(pte, __pte(pte_val(*pte) & ~_PAGE_NX));\nout:\n\t__flush_tlb_all();\n\treturn 0;\n}\n\nint arch_resume_nosmt(void)\n{\n\tint ret = 0;\n\t \n\tcpu_hotplug_enable();\n\tif (cpu_smt_control == CPU_SMT_DISABLED ||\n\t\t\tcpu_smt_control == CPU_SMT_FORCE_DISABLED) {\n\t\tenum cpuhp_smt_control old = cpu_smt_control;\n\n\t\tret = cpuhp_smt_enable();\n\t\tif (ret)\n\t\t\tgoto out;\n\t\tret = cpuhp_smt_disable(old);\n\t\tif (ret)\n\t\t\tgoto out;\n\t}\nout:\n\tcpu_hotplug_disable();\n\treturn ret;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}