{
  "module_name": "efi.c",
  "hash_id": "98cbf17c4f7052588969ca23488fd67aad7b9e556fa760817d746a1d044b4666",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/xen/efi.c",
  "human_readable_source": "\n \n\n#include <linux/bitops.h>\n#include <linux/efi.h>\n#include <linux/init.h>\n#include <linux/string.h>\n\n#include <xen/xen.h>\n#include <xen/xen-ops.h>\n#include <xen/interface/platform.h>\n\n#include <asm/page.h>\n#include <asm/setup.h>\n#include <asm/xen/hypercall.h>\n\n#include \"xen-ops.h\"\n\nstatic efi_char16_t vendor[100] __initdata;\n\nstatic efi_system_table_t efi_systab_xen __initdata = {\n\t.hdr = {\n\t\t.signature\t= EFI_SYSTEM_TABLE_SIGNATURE,\n\t\t.revision\t= 0,  \n\t\t.headersize\t= 0,  \n\t\t.crc32\t\t= 0,  \n\t\t.reserved\t= 0\n\t},\n\t.fw_vendor\t= EFI_INVALID_TABLE_ADDR,  \n\t.fw_revision\t= 0,\t\t\t   \n\t.con_in_handle\t= EFI_INVALID_TABLE_ADDR,  \n\t.con_in\t\t= NULL,\t\t\t   \n\t.con_out_handle\t= EFI_INVALID_TABLE_ADDR,  \n\t.con_out\t= NULL, \t\t   \n\t.stderr_handle\t= EFI_INVALID_TABLE_ADDR,  \n\t.stderr\t\t= EFI_INVALID_TABLE_ADDR,  \n\t.runtime\t= (efi_runtime_services_t *)EFI_INVALID_TABLE_ADDR,\n\t\t\t\t\t\t   \n\t.boottime\t= (efi_boot_services_t *)EFI_INVALID_TABLE_ADDR,\n\t\t\t\t\t\t   \n\t.nr_tables\t= 0,\t\t\t   \n\t.tables\t\t= EFI_INVALID_TABLE_ADDR   \n};\n\nstatic efi_system_table_t __init *xen_efi_probe(void)\n{\n\tstruct xen_platform_op op = {\n\t\t.cmd = XENPF_firmware_info,\n\t\t.u.firmware_info = {\n\t\t\t.type = XEN_FW_EFI_INFO,\n\t\t\t.index = XEN_FW_EFI_CONFIG_TABLE\n\t\t}\n\t};\n\tunion xenpf_efi_info *info = &op.u.firmware_info.u.efi_info;\n\n\tif (!xen_initial_domain() || HYPERVISOR_platform_op(&op) < 0)\n\t\treturn NULL;\n\n\t \n\txen_efi_runtime_setup();\n\n\tefi_systab_xen.tables = info->cfg.addr;\n\tefi_systab_xen.nr_tables = info->cfg.nent;\n\n\top.cmd = XENPF_firmware_info;\n\top.u.firmware_info.type = XEN_FW_EFI_INFO;\n\top.u.firmware_info.index = XEN_FW_EFI_VENDOR;\n\tinfo->vendor.bufsz = sizeof(vendor);\n\tset_xen_guest_handle(info->vendor.name, vendor);\n\n\tif (HYPERVISOR_platform_op(&op) == 0) {\n\t\tefi_systab_xen.fw_vendor = __pa_symbol(vendor);\n\t\tefi_systab_xen.fw_revision = info->vendor.revision;\n\t} else\n\t\tefi_systab_xen.fw_vendor = __pa_symbol(L\"UNKNOWN\");\n\n\top.cmd = XENPF_firmware_info;\n\top.u.firmware_info.type = XEN_FW_EFI_INFO;\n\top.u.firmware_info.index = XEN_FW_EFI_VERSION;\n\n\tif (HYPERVISOR_platform_op(&op) == 0)\n\t\tefi_systab_xen.hdr.revision = info->version;\n\n\top.cmd = XENPF_firmware_info;\n\top.u.firmware_info.type = XEN_FW_EFI_INFO;\n\top.u.firmware_info.index = XEN_FW_EFI_RT_VERSION;\n\n\tif (HYPERVISOR_platform_op(&op) == 0)\n\t\tefi.runtime_version = info->version;\n\n\treturn &efi_systab_xen;\n}\n\n \nstatic enum efi_secureboot_mode xen_efi_get_secureboot(void)\n{\n\tstatic efi_guid_t shim_guid = EFI_SHIM_LOCK_GUID;\n\tenum efi_secureboot_mode mode;\n\tefi_status_t status;\n\tu8 moksbstate;\n\tunsigned long size;\n\n\tmode = efi_get_secureboot_mode(efi.get_variable);\n\tif (mode == efi_secureboot_mode_unknown) {\n\t\tpr_err(\"Could not determine UEFI Secure Boot status.\\n\");\n\t\treturn efi_secureboot_mode_unknown;\n\t}\n\tif (mode != efi_secureboot_mode_enabled)\n\t\treturn mode;\n\n\t \n\tsize = sizeof(moksbstate);\n\tstatus = efi.get_variable(L\"MokSBStateRT\", &shim_guid,\n\t\t\t\t  NULL, &size, &moksbstate);\n\n\t \n\tif (status != EFI_SUCCESS)\n\t\tgoto secure_boot_enabled;\n\n\tif (moksbstate == 1)\n\t\treturn efi_secureboot_mode_disabled;\n\n secure_boot_enabled:\n\tpr_info(\"UEFI Secure Boot is enabled.\\n\");\n\treturn efi_secureboot_mode_enabled;\n}\n\nvoid __init xen_efi_init(struct boot_params *boot_params)\n{\n\tefi_system_table_t *efi_systab_xen;\n\n\tefi_systab_xen = xen_efi_probe();\n\n\tif (efi_systab_xen == NULL)\n\t\treturn;\n\n\tstrscpy((char *)&boot_params->efi_info.efi_loader_signature, \"Xen\",\n\t\t\tsizeof(boot_params->efi_info.efi_loader_signature));\n\tboot_params->efi_info.efi_systab = (__u32)__pa(efi_systab_xen);\n\tboot_params->efi_info.efi_systab_hi = (__u32)(__pa(efi_systab_xen) >> 32);\n\n\tboot_params->secure_boot = xen_efi_get_secureboot();\n\n\tset_bit(EFI_BOOT, &efi.flags);\n\tset_bit(EFI_PARAVIRT, &efi.flags);\n\tset_bit(EFI_64BIT, &efi.flags);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}