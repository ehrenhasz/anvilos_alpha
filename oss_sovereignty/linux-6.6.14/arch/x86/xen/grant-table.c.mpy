{
  "module_name": "grant-table.c",
  "hash_id": "f91a8949ed6f8ba934bbe0f21cbe2e584a4da02b1780b4bb96eb17fd530916a4",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/xen/grant-table.c",
  "human_readable_source": "\n \n\n#include <linux/sched.h>\n#include <linux/mm.h>\n#include <linux/slab.h>\n#include <linux/vmalloc.h>\n\n#include <xen/interface/xen.h>\n#include <xen/page.h>\n#include <xen/grant_table.h>\n#include <xen/xen.h>\n\n\nstatic struct gnttab_vm_area {\n\tstruct vm_struct *area;\n\tpte_t **ptes;\n\tint idx;\n} gnttab_shared_vm_area, gnttab_status_vm_area;\n\nint arch_gnttab_map_shared(unsigned long *frames, unsigned long nr_gframes,\n\t\t\t   unsigned long max_nr_gframes,\n\t\t\t   void **__shared)\n{\n\tvoid *shared = *__shared;\n\tunsigned long addr;\n\tunsigned long i;\n\n\tif (shared == NULL)\n\t\t*__shared = shared = gnttab_shared_vm_area.area->addr;\n\n\taddr = (unsigned long)shared;\n\n\tfor (i = 0; i < nr_gframes; i++) {\n\t\tset_pte_at(&init_mm, addr, gnttab_shared_vm_area.ptes[i],\n\t\t\t   mfn_pte(frames[i], PAGE_KERNEL));\n\t\taddr += PAGE_SIZE;\n\t}\n\n\treturn 0;\n}\n\nint arch_gnttab_map_status(uint64_t *frames, unsigned long nr_gframes,\n\t\t\t   unsigned long max_nr_gframes,\n\t\t\t   grant_status_t **__shared)\n{\n\tgrant_status_t *shared = *__shared;\n\tunsigned long addr;\n\tunsigned long i;\n\n\tif (shared == NULL)\n\t\t*__shared = shared = gnttab_status_vm_area.area->addr;\n\n\taddr = (unsigned long)shared;\n\n\tfor (i = 0; i < nr_gframes; i++) {\n\t\tset_pte_at(&init_mm, addr, gnttab_status_vm_area.ptes[i],\n\t\t\t   mfn_pte(frames[i], PAGE_KERNEL));\n\t\taddr += PAGE_SIZE;\n\t}\n\n\treturn 0;\n}\n\nvoid arch_gnttab_unmap(void *shared, unsigned long nr_gframes)\n{\n\tpte_t **ptes;\n\tunsigned long addr;\n\tunsigned long i;\n\n\tif (shared == gnttab_status_vm_area.area->addr)\n\t\tptes = gnttab_status_vm_area.ptes;\n\telse\n\t\tptes = gnttab_shared_vm_area.ptes;\n\n\taddr = (unsigned long)shared;\n\n\tfor (i = 0; i < nr_gframes; i++) {\n\t\tset_pte_at(&init_mm, addr, ptes[i], __pte(0));\n\t\taddr += PAGE_SIZE;\n\t}\n}\n\nstatic int gnttab_apply(pte_t *pte, unsigned long addr, void *data)\n{\n\tstruct gnttab_vm_area *area = data;\n\n\tarea->ptes[area->idx++] = pte;\n\treturn 0;\n}\n\nstatic int arch_gnttab_valloc(struct gnttab_vm_area *area, unsigned nr_frames)\n{\n\tarea->ptes = kmalloc_array(nr_frames, sizeof(*area->ptes), GFP_KERNEL);\n\tif (area->ptes == NULL)\n\t\treturn -ENOMEM;\n\tarea->area = get_vm_area(PAGE_SIZE * nr_frames, VM_IOREMAP);\n\tif (!area->area)\n\t\tgoto out_free_ptes;\n\tif (apply_to_page_range(&init_mm, (unsigned long)area->area->addr,\n\t\t\tPAGE_SIZE * nr_frames, gnttab_apply, area))\n\t\tgoto out_free_vm_area;\n\treturn 0;\nout_free_vm_area:\n\tfree_vm_area(area->area);\nout_free_ptes:\n\tkfree(area->ptes);\n\treturn -ENOMEM;\n}\n\nstatic void arch_gnttab_vfree(struct gnttab_vm_area *area)\n{\n\tfree_vm_area(area->area);\n\tkfree(area->ptes);\n}\n\nint arch_gnttab_init(unsigned long nr_shared, unsigned long nr_status)\n{\n\tint ret;\n\n\tif (!xen_pv_domain())\n\t\treturn 0;\n\n\tret = arch_gnttab_valloc(&gnttab_shared_vm_area, nr_shared);\n\tif (ret < 0)\n\t\treturn ret;\n\n\t \n\tret = arch_gnttab_valloc(&gnttab_status_vm_area, nr_status);\n\tif (ret < 0)\n\t\tgoto err;\n\n\treturn 0;\nerr:\n\tarch_gnttab_vfree(&gnttab_shared_vm_area);\n\treturn -ENOMEM;\n}\n\n#ifdef CONFIG_XEN_PVH\n#include <xen/events.h>\n#include <xen/xen-ops.h>\nstatic int __init xen_pvh_gnttab_setup(void)\n{\n\tif (!xen_pvh_domain())\n\t\treturn -ENODEV;\n\n\txen_auto_xlat_grant_frames.count = gnttab_max_grant_frames();\n\n\treturn xen_xlate_map_ballooned_pages(&xen_auto_xlat_grant_frames.pfn,\n\t\t\t\t\t     &xen_auto_xlat_grant_frames.vaddr,\n\t\t\t\t\t     xen_auto_xlat_grant_frames.count);\n}\n \ncore_initcall(xen_pvh_gnttab_setup);\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}