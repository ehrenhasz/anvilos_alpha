{
  "module_name": "platform-pci-unplug.c",
  "hash_id": "980e513fc0721722c0f3663ec8f9751d87681773286c3cdff56cb3260fe56550",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/xen/platform-pci-unplug.c",
  "human_readable_source": "\n\n \n\n#define pr_fmt(fmt) KBUILD_MODNAME \": \" fmt\n\n#include <linux/init.h>\n#include <linux/io.h>\n#include <linux/export.h>\n\n#include <xen/xen.h>\n#include <xen/platform_pci.h>\n#include \"xen-ops.h\"\n\n#define XEN_PLATFORM_ERR_MAGIC -1\n#define XEN_PLATFORM_ERR_PROTOCOL -2\n#define XEN_PLATFORM_ERR_BLACKLIST -3\n\n \nstatic int xen_platform_pci_unplug;\nstatic int xen_emul_unplug;\n\nstatic int check_platform_magic(void)\n{\n\tshort magic;\n\tchar protocol;\n\n\tmagic = inw(XEN_IOPORT_MAGIC);\n\tif (magic != XEN_IOPORT_MAGIC_VAL) {\n\t\tpr_err(\"Xen Platform PCI: unrecognised magic value\\n\");\n\t\treturn XEN_PLATFORM_ERR_MAGIC;\n\t}\n\n\tprotocol = inb(XEN_IOPORT_PROTOVER);\n\n\tpr_debug(\"Xen Platform PCI: I/O protocol version %d\\n\",\n\t\t\tprotocol);\n\n\tswitch (protocol) {\n\tcase 1:\n\t\toutw(XEN_IOPORT_LINUX_PRODNUM, XEN_IOPORT_PRODNUM);\n\t\toutl(XEN_IOPORT_LINUX_DRVVER, XEN_IOPORT_DRVVER);\n\t\tif (inw(XEN_IOPORT_MAGIC) != XEN_IOPORT_MAGIC_VAL) {\n\t\t\tpr_err(\"Xen Platform: blacklisted by host\\n\");\n\t\t\treturn XEN_PLATFORM_ERR_BLACKLIST;\n\t\t}\n\t\tbreak;\n\tdefault:\n\t\tpr_warn(\"Xen Platform PCI: unknown I/O protocol version\\n\");\n\t\treturn XEN_PLATFORM_ERR_PROTOCOL;\n\t}\n\n\treturn 0;\n}\n\nbool xen_has_pv_devices(void)\n{\n\tif (!xen_domain())\n\t\treturn false;\n\n\t \n\tif (xen_pv_domain() || xen_pvh_domain())\n\t\treturn true;\n\n\t \n\tif (xen_platform_pci_unplug == 0)\n\t\treturn false;\n\n\tif (xen_platform_pci_unplug & XEN_UNPLUG_NEVER)\n\t\treturn false;\n\n\tif (xen_platform_pci_unplug & XEN_UNPLUG_ALL)\n\t\treturn true;\n\n\t \n\tif (xen_platform_pci_unplug & XEN_UNPLUG_UNNECESSARY)\n\t\treturn true;\n\n\t \n\treturn false;\n}\nEXPORT_SYMBOL_GPL(xen_has_pv_devices);\n\nstatic bool __xen_has_pv_device(int state)\n{\n\t \n\tif (xen_hvm_domain() && (xen_platform_pci_unplug & state))\n\t\treturn true;\n\n\treturn xen_has_pv_devices();\n}\n\nbool xen_has_pv_nic_devices(void)\n{\n\treturn __xen_has_pv_device(XEN_UNPLUG_ALL_NICS | XEN_UNPLUG_ALL);\n}\nEXPORT_SYMBOL_GPL(xen_has_pv_nic_devices);\n\nbool xen_has_pv_disk_devices(void)\n{\n\treturn __xen_has_pv_device(XEN_UNPLUG_ALL_IDE_DISKS |\n\t\t\t\t   XEN_UNPLUG_AUX_IDE_DISKS | XEN_UNPLUG_ALL);\n}\nEXPORT_SYMBOL_GPL(xen_has_pv_disk_devices);\n\n \nbool xen_has_pv_and_legacy_disk_devices(void)\n{\n\tif (!xen_domain())\n\t\treturn false;\n\n\t \n\tif (xen_pv_domain())\n\t\treturn false;\n\n\tif (xen_platform_pci_unplug & XEN_UNPLUG_UNNECESSARY)\n\t\treturn true;\n\n\treturn false;\n}\nEXPORT_SYMBOL_GPL(xen_has_pv_and_legacy_disk_devices);\n\nvoid xen_unplug_emulated_devices(void)\n{\n\tint r;\n\n\t \n\tif (xen_pvh_domain())\n\t\treturn;\n\n\t \n\tif (xen_emul_unplug & XEN_UNPLUG_NEVER)\n\t\treturn;\n\t \n\tr = check_platform_magic();\n\t \n\tif (r && !(r == XEN_PLATFORM_ERR_MAGIC &&\n\t\t\t(xen_emul_unplug & XEN_UNPLUG_UNNECESSARY)))\n\t\treturn;\n\t \n\tif (!xen_emul_unplug) {\n\t\tif (xen_must_unplug_nics()) {\n\t\t\tpr_info(\"Netfront and the Xen platform PCI driver have \"\n\t\t\t\t\t\"been compiled for this kernel: unplug emulated NICs.\\n\");\n\t\t\txen_emul_unplug |= XEN_UNPLUG_ALL_NICS;\n\t\t}\n\t\tif (xen_must_unplug_disks()) {\n\t\t\tpr_info(\"Blkfront and the Xen platform PCI driver have \"\n\t\t\t\t\t\"been compiled for this kernel: unplug emulated disks.\\n\"\n\t\t\t\t\t\"You might have to change the root device\\n\"\n\t\t\t\t\t\"from /dev/hd[a-d] to /dev/xvd[a-d]\\n\"\n\t\t\t\t\t\"in your root= kernel command line option\\n\");\n\t\t\txen_emul_unplug |= XEN_UNPLUG_ALL_IDE_DISKS;\n\t\t}\n\t}\n\t \n\tif (!(xen_emul_unplug & XEN_UNPLUG_UNNECESSARY))\n\t\toutw(xen_emul_unplug, XEN_IOPORT_UNPLUG);\n\txen_platform_pci_unplug = xen_emul_unplug;\n}\n\nstatic int __init parse_xen_emul_unplug(char *arg)\n{\n\tchar *p, *q;\n\tint l;\n\n\tfor (p = arg; p; p = q) {\n\t\tq = strchr(p, ',');\n\t\tif (q) {\n\t\t\tl = q - p;\n\t\t\tq++;\n\t\t} else {\n\t\t\tl = strlen(p);\n\t\t}\n\t\tif (!strncmp(p, \"all\", l))\n\t\t\txen_emul_unplug |= XEN_UNPLUG_ALL;\n\t\telse if (!strncmp(p, \"ide-disks\", l))\n\t\t\txen_emul_unplug |= XEN_UNPLUG_ALL_IDE_DISKS;\n\t\telse if (!strncmp(p, \"aux-ide-disks\", l))\n\t\t\txen_emul_unplug |= XEN_UNPLUG_AUX_IDE_DISKS;\n\t\telse if (!strncmp(p, \"nics\", l))\n\t\t\txen_emul_unplug |= XEN_UNPLUG_ALL_NICS;\n\t\telse if (!strncmp(p, \"unnecessary\", l))\n\t\t\txen_emul_unplug |= XEN_UNPLUG_UNNECESSARY;\n\t\telse if (!strncmp(p, \"never\", l))\n\t\t\txen_emul_unplug |= XEN_UNPLUG_NEVER;\n\t\telse\n\t\t\tpr_warn(\"unrecognised option '%s' \"\n\t\t\t\t \"in parameter 'xen_emul_unplug'\\n\", p);\n\t}\n\treturn 0;\n}\nearly_param(\"xen_emul_unplug\", parse_xen_emul_unplug);\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}