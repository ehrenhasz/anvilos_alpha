{
  "module_name": "cpuflags.c",
  "hash_id": "aaec067798b027459beb461f83e84f4abdc8f9c3380e1a99f9cdcab13941e676",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/boot/cpuflags.c",
  "human_readable_source": "\n#include <linux/types.h>\n#include \"bitops.h\"\n\n#include <asm/processor-flags.h>\n#include <asm/required-features.h>\n#include <asm/msr-index.h>\n#include \"cpuflags.h\"\n\nstruct cpu_features cpu;\nu32 cpu_vendor[3];\n\nstatic bool loaded_flags;\n\nstatic int has_fpu(void)\n{\n\tu16 fcw = -1, fsw = -1;\n\tunsigned long cr0;\n\n\tasm volatile(\"mov %%cr0,%0\" : \"=r\" (cr0));\n\tif (cr0 & (X86_CR0_EM|X86_CR0_TS)) {\n\t\tcr0 &= ~(X86_CR0_EM|X86_CR0_TS);\n\t\tasm volatile(\"mov %0,%%cr0\" : : \"r\" (cr0));\n\t}\n\n\tasm volatile(\"fninit ; fnstsw %0 ; fnstcw %1\"\n\t\t     : \"+m\" (fsw), \"+m\" (fcw));\n\n\treturn fsw == 0 && (fcw & 0x103f) == 0x003f;\n}\n\n \n#ifdef __x86_64__\n#define PUSHF \"pushfq\"\n#define POPF \"popfq\"\n#else\n#define PUSHF \"pushfl\"\n#define POPF \"popfl\"\n#endif\n\nint has_eflag(unsigned long mask)\n{\n\tunsigned long f0, f1;\n\n\tasm volatile(PUSHF \"\t\\n\\t\"\n\t\t     PUSHF \"\t\\n\\t\"\n\t\t     \"pop %0\t\\n\\t\"\n\t\t     \"mov %0,%1\t\\n\\t\"\n\t\t     \"xor %2,%1\t\\n\\t\"\n\t\t     \"push %1\t\\n\\t\"\n\t\t     POPF \"\t\\n\\t\"\n\t\t     PUSHF \"\t\\n\\t\"\n\t\t     \"pop %1\t\\n\\t\"\n\t\t     POPF\n\t\t     : \"=&r\" (f0), \"=&r\" (f1)\n\t\t     : \"ri\" (mask));\n\n\treturn !!((f0^f1) & mask);\n}\n\nvoid cpuid_count(u32 id, u32 count, u32 *a, u32 *b, u32 *c, u32 *d)\n{\n\tasm volatile(\"cpuid\"\n\t\t     : \"=a\" (*a), \"=b\" (*b), \"=c\" (*c), \"=d\" (*d)\n\t\t     : \"0\" (id), \"2\" (count)\n\t);\n}\n\n#define cpuid(id, a, b, c, d) cpuid_count(id, 0, a, b, c, d)\n\nvoid get_cpuflags(void)\n{\n\tu32 max_intel_level, max_amd_level;\n\tu32 tfms;\n\tu32 ignored;\n\n\tif (loaded_flags)\n\t\treturn;\n\tloaded_flags = true;\n\n\tif (has_fpu())\n\t\tset_bit(X86_FEATURE_FPU, cpu.flags);\n\n\tif (has_eflag(X86_EFLAGS_ID)) {\n\t\tcpuid(0x0, &max_intel_level, &cpu_vendor[0], &cpu_vendor[2],\n\t\t      &cpu_vendor[1]);\n\n\t\tif (max_intel_level >= 0x00000001 &&\n\t\t    max_intel_level <= 0x0000ffff) {\n\t\t\tcpuid(0x1, &tfms, &ignored, &cpu.flags[4],\n\t\t\t      &cpu.flags[0]);\n\t\t\tcpu.level = (tfms >> 8) & 15;\n\t\t\tcpu.family = cpu.level;\n\t\t\tcpu.model = (tfms >> 4) & 15;\n\t\t\tif (cpu.level >= 6)\n\t\t\t\tcpu.model += ((tfms >> 16) & 0xf) << 4;\n\t\t}\n\n\t\tif (max_intel_level >= 0x00000007) {\n\t\t\tcpuid_count(0x00000007, 0, &ignored, &ignored,\n\t\t\t\t\t&cpu.flags[16], &ignored);\n\t\t}\n\n\t\tcpuid(0x80000000, &max_amd_level, &ignored, &ignored,\n\t\t      &ignored);\n\n\t\tif (max_amd_level >= 0x80000001 &&\n\t\t    max_amd_level <= 0x8000ffff) {\n\t\t\tcpuid(0x80000001, &ignored, &ignored, &cpu.flags[6],\n\t\t\t      &cpu.flags[1]);\n\t\t}\n\t}\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}