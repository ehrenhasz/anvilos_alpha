{
  "module_name": "a20.c",
  "hash_id": "61e648f6d0fc1c1441069fe8a8bd33c0534180ba552471e16e27cae1bca0a04a",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/boot/a20.c",
  "human_readable_source": "\n \n\n \n\n#include \"boot.h\"\n\n#define MAX_8042_LOOPS\t100000\n#define MAX_8042_FF\t32\n\nstatic int empty_8042(void)\n{\n\tu8 status;\n\tint loops = MAX_8042_LOOPS;\n\tint ffs   = MAX_8042_FF;\n\n\twhile (loops--) {\n\t\tio_delay();\n\n\t\tstatus = inb(0x64);\n\t\tif (status == 0xff) {\n\t\t\t \n\t\t\tif (!--ffs)\n\t\t\t\treturn -1;  \n\t\t}\n\t\tif (status & 1) {\n\t\t\t \n\t\t\tio_delay();\n\t\t\t(void)inb(0x60);\n\t\t} else if (!(status & 2)) {\n\t\t\t \n\t\t\treturn 0;\n\t\t}\n\t}\n\n\treturn -1;\n}\n\n \n\n#define A20_TEST_ADDR\t(4*0x80)\n#define A20_TEST_SHORT  32\n#define A20_TEST_LONG\t2097152\t \n\nstatic int a20_test(int loops)\n{\n\tint ok = 0;\n\tint saved, ctr;\n\n\tset_fs(0x0000);\n\tset_gs(0xffff);\n\n\tsaved = ctr = rdfs32(A20_TEST_ADDR);\n\n\twhile (loops--) {\n\t\twrfs32(++ctr, A20_TEST_ADDR);\n\t\tio_delay();\t \n\t\tok = rdgs32(A20_TEST_ADDR+0x10) ^ ctr;\n\t\tif (ok)\n\t\t\tbreak;\n\t}\n\n\twrfs32(saved, A20_TEST_ADDR);\n\treturn ok;\n}\n\n \nstatic int a20_test_short(void)\n{\n\treturn a20_test(A20_TEST_SHORT);\n}\n\n \nstatic int a20_test_long(void)\n{\n\treturn a20_test(A20_TEST_LONG);\n}\n\nstatic void enable_a20_bios(void)\n{\n\tstruct biosregs ireg;\n\n\tinitregs(&ireg);\n\tireg.ax = 0x2401;\n\tintcall(0x15, &ireg, NULL);\n}\n\nstatic void enable_a20_kbc(void)\n{\n\tempty_8042();\n\n\toutb(0xd1, 0x64);\t \n\tempty_8042();\n\n\toutb(0xdf, 0x60);\t \n\tempty_8042();\n\n\toutb(0xff, 0x64);\t \n\tempty_8042();\n}\n\nstatic void enable_a20_fast(void)\n{\n\tu8 port_a;\n\n\tport_a = inb(0x92);\t \n\tport_a |=  0x02;\t \n\tport_a &= ~0x01;\t \n\toutb(port_a, 0x92);\n}\n\n \n\n#define A20_ENABLE_LOOPS 255\t \n\nint enable_a20(void)\n{\n       int loops = A20_ENABLE_LOOPS;\n       int kbc_err;\n\n       while (loops--) {\n\t        \n\t       if (a20_test_short())\n\t\t       return 0;\n\t       \n\t        \n\t       enable_a20_bios();\n\t       if (a20_test_short())\n\t\t       return 0;\n\t       \n\t        \n\t       kbc_err = empty_8042();\n\n\t       if (a20_test_short())\n\t\t       return 0;  \n\t\n\t       if (!kbc_err) {\n\t\t       enable_a20_kbc();\n\t\t       if (a20_test_long())\n\t\t\t       return 0;\n\t       }\n\t       \n\t        \n\t       enable_a20_fast();\n\t       if (a20_test_long())\n\t\t       return 0;\n       }\n       \n       return -1;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}