{
  "module_name": "video-vesa.c",
  "hash_id": "acd9e9255b637e647163d295dfc46692450a9de460830a696f7d18a3a2b4d5ba",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/boot/video-vesa.c",
  "human_readable_source": "\n \n\n \n\n#include \"boot.h\"\n#include \"video.h\"\n#include \"vesa.h\"\n#include \"string.h\"\n\n \nstatic struct vesa_general_info vginfo;\nstatic struct vesa_mode_info vminfo;\n\nstatic __videocard video_vesa;\n\n#ifndef _WAKEUP\nstatic void vesa_store_mode_params_graphics(void);\n#else  \nstatic inline void vesa_store_mode_params_graphics(void) {}\n#endif  \n\nstatic int vesa_probe(void)\n{\n\tstruct biosregs ireg, oreg;\n\tu16 mode;\n\taddr_t mode_ptr;\n\tstruct mode_info *mi;\n\tint nmodes = 0;\n\n\tvideo_vesa.modes = GET_HEAP(struct mode_info, 0);\n\n\tinitregs(&ireg);\n\tireg.ax = 0x4f00;\n\tireg.di = (size_t)&vginfo;\n\tintcall(0x10, &ireg, &oreg);\n\n\tif (oreg.ax != 0x004f ||\n\t    vginfo.signature != VESA_MAGIC ||\n\t    vginfo.version < 0x0102)\n\t\treturn 0;\t \n\n\tset_fs(vginfo.video_mode_ptr.seg);\n\tmode_ptr = vginfo.video_mode_ptr.off;\n\n\twhile ((mode = rdfs16(mode_ptr)) != 0xffff) {\n\t\tmode_ptr += 2;\n\n\t\tif (!heap_free(sizeof(struct mode_info)))\n\t\t\tbreak;\t \n\n\t\tif (mode & ~0x1ff)\n\t\t\tcontinue;\n\n\t\tmemset(&vminfo, 0, sizeof(vminfo));  \n\n\t\tireg.ax = 0x4f01;\n\t\tireg.cx = mode;\n\t\tireg.di = (size_t)&vminfo;\n\t\tintcall(0x10, &ireg, &oreg);\n\n\t\tif (oreg.ax != 0x004f)\n\t\t\tcontinue;\n\n\t\tif ((vminfo.mode_attr & 0x15) == 0x05) {\n\t\t\t \n\t\t\tmi = GET_HEAP(struct mode_info, 1);\n\t\t\tmi->mode  = mode + VIDEO_FIRST_VESA;\n\t\t\tmi->depth = 0;  \n\t\t\tmi->x     = vminfo.h_res;\n\t\t\tmi->y     = vminfo.v_res;\n\t\t\tnmodes++;\n\t\t} else if ((vminfo.mode_attr & 0x99) == 0x99 &&\n\t\t\t   (vminfo.memory_layout == 4 ||\n\t\t\t    vminfo.memory_layout == 6) &&\n\t\t\t   vminfo.memory_planes == 1) {\n#ifdef CONFIG_BOOT_VESA_SUPPORT\n\t\t\t \n\t\t\tmi = GET_HEAP(struct mode_info, 1);\n\t\t\tmi->mode = mode + VIDEO_FIRST_VESA;\n\t\t\tmi->depth = vminfo.bpp;\n\t\t\tmi->x = vminfo.h_res;\n\t\t\tmi->y = vminfo.v_res;\n\t\t\tnmodes++;\n#endif\n\t\t}\n\t}\n\n\treturn nmodes;\n}\n\nstatic int vesa_set_mode(struct mode_info *mode)\n{\n\tstruct biosregs ireg, oreg;\n\tint is_graphic;\n\tu16 vesa_mode = mode->mode - VIDEO_FIRST_VESA;\n\n\tmemset(&vminfo, 0, sizeof(vminfo));  \n\n\tinitregs(&ireg);\n\tireg.ax = 0x4f01;\n\tireg.cx = vesa_mode;\n\tireg.di = (size_t)&vminfo;\n\tintcall(0x10, &ireg, &oreg);\n\n\tif (oreg.ax != 0x004f)\n\t\treturn -1;\n\n\tif ((vminfo.mode_attr & 0x15) == 0x05) {\n\t\t \n\t\tis_graphic = 0;\n#ifdef CONFIG_BOOT_VESA_SUPPORT\n\t} else if ((vminfo.mode_attr & 0x99) == 0x99) {\n\t\t \n\t\tis_graphic = 1;\n\t\tvesa_mode |= 0x4000;  \n#endif\n\t} else {\n\t\treturn -1;\t \n\t}\n\n\n\tinitregs(&ireg);\n\tireg.ax = 0x4f02;\n\tireg.bx = vesa_mode;\n\tintcall(0x10, &ireg, &oreg);\n\n\tif (oreg.ax != 0x004f)\n\t\treturn -1;\n\n\tgraphic_mode = is_graphic;\n\tif (!is_graphic) {\n\t\t \n\t\tforce_x = mode->x;\n\t\tforce_y = mode->y;\n\t\tdo_restore = 1;\n\t} else {\n\t\t \n\t\tvesa_store_mode_params_graphics();\n\t}\n\n\treturn 0;\n}\n\n\n#ifndef _WAKEUP\n\n \nstatic void vesa_dac_set_8bits(void)\n{\n\tstruct biosregs ireg, oreg;\n\tu8 dac_size = 6;\n\n\t \n\tif (vginfo.capabilities & 1) {\n\t\tinitregs(&ireg);\n\t\tireg.ax = 0x4f08;\n\t\tireg.bh = 0x08;\n\t\tintcall(0x10, &ireg, &oreg);\n\t\tif (oreg.ax == 0x004f)\n\t\t\tdac_size = oreg.bh;\n\t}\n\n\t \n\tboot_params.screen_info.red_size   = dac_size;\n\tboot_params.screen_info.green_size = dac_size;\n\tboot_params.screen_info.blue_size  = dac_size;\n\tboot_params.screen_info.rsvd_size  = dac_size;\n\n\tboot_params.screen_info.red_pos    = 0;\n\tboot_params.screen_info.green_pos  = 0;\n\tboot_params.screen_info.blue_pos   = 0;\n\tboot_params.screen_info.rsvd_pos   = 0;\n}\n\n \nstatic void vesa_store_pm_info(void)\n{\n\tstruct biosregs ireg, oreg;\n\n\tinitregs(&ireg);\n\tireg.ax = 0x4f0a;\n\tintcall(0x10, &ireg, &oreg);\n\n\tif (oreg.ax != 0x004f)\n\t\treturn;\n\n\tboot_params.screen_info.vesapm_seg = oreg.es;\n\tboot_params.screen_info.vesapm_off = oreg.di;\n}\n\n \nstatic void vesa_store_mode_params_graphics(void)\n{\n\t \n\tboot_params.screen_info.orig_video_isVGA = VIDEO_TYPE_VLFB;\n\n\t \n\tboot_params.screen_info.vesa_attributes = vminfo.mode_attr;\n\tboot_params.screen_info.lfb_linelength = vminfo.logical_scan;\n\tboot_params.screen_info.lfb_width = vminfo.h_res;\n\tboot_params.screen_info.lfb_height = vminfo.v_res;\n\tboot_params.screen_info.lfb_depth = vminfo.bpp;\n\tboot_params.screen_info.pages = vminfo.image_planes;\n\tboot_params.screen_info.lfb_base = vminfo.lfb_ptr;\n\tmemcpy(&boot_params.screen_info.red_size,\n\t       &vminfo.rmask, 8);\n\n\t \n\tboot_params.screen_info.lfb_size = vginfo.total_memory;\n\n\tif (vminfo.bpp <= 8)\n\t\tvesa_dac_set_8bits();\n\n\tvesa_store_pm_info();\n}\n\n \nvoid vesa_store_edid(void)\n{\n#ifdef CONFIG_FIRMWARE_EDID\n\tstruct biosregs ireg, oreg;\n\n\t \n\tmemset(&boot_params.edid_info, 0x13, sizeof(boot_params.edid_info));\n\n\tif (vginfo.version < 0x0200)\n\t\treturn;\t\t \n\n\tinitregs(&ireg);\n\tireg.ax = 0x4f15;\t\t \n\t \t\t \n\t \t\t \n\tireg.es = 0;\t\t\t \n\tintcall(0x10, &ireg, &oreg);\n\n\tif (oreg.ax != 0x004f)\n\t\treturn;\t\t \n\n\t \n\t \n\n\tireg.ax = 0x4f15;\t\t \n\tireg.bx = 0x0001;\t\t \n\t \t\t \n\t \t\t \n\tireg.es = ds();\n\tireg.di =(size_t)&boot_params.edid_info;  \n\tintcall(0x10, &ireg, &oreg);\n#endif  \n}\n\n#endif  \n\nstatic __videocard video_vesa =\n{\n\t.card_name\t= \"VESA\",\n\t.probe\t\t= vesa_probe,\n\t.set_mode\t= vesa_set_mode,\n\t.xmode_first\t= VIDEO_FIRST_VESA,\n\t.xmode_n\t= 0x200,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}