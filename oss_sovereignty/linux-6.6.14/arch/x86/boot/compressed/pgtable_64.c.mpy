{
  "module_name": "pgtable_64.c",
  "hash_id": "35e14af640fda839bd68af99a3567a09dc645594bb3af9152681dcad8f7e494b",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/boot/compressed/pgtable_64.c",
  "human_readable_source": "\n#include \"misc.h\"\n#include <asm/e820/types.h>\n#include <asm/processor.h>\n#include \"pgtable.h\"\n#include \"../string.h\"\n#include \"efi.h\"\n\n#define BIOS_START_MIN\t\t0x20000U\t \n#define BIOS_START_MAX\t\t0x9f000U\t \n\n#ifdef CONFIG_X86_5LEVEL\n \nunsigned int __section(\".data\") __pgtable_l5_enabled;\nunsigned int __section(\".data\") pgdir_shift = 39;\nunsigned int __section(\".data\") ptrs_per_p4d = 1;\n#endif\n\n \nstatic char trampoline_save[TRAMPOLINE_32BIT_SIZE];\n\n \nunsigned long *trampoline_32bit __section(\".data\");\n\nextern struct boot_params *boot_params;\nint cmdline_find_option_bool(const char *option);\n\nstatic unsigned long find_trampoline_placement(void)\n{\n\tunsigned long bios_start = 0, ebda_start = 0;\n\tstruct boot_e820_entry *entry;\n\tchar *signature;\n\tint i;\n\n\t \n\n\t \n\tsignature = (char *)&boot_params->efi_info.efi_loader_signature;\n\tif (strncmp(signature, EFI32_LOADER_SIGNATURE, 4) &&\n\t    strncmp(signature, EFI64_LOADER_SIGNATURE, 4)) {\n\t\tebda_start = *(unsigned short *)0x40e << 4;\n\t\tbios_start = *(unsigned short *)0x413 << 10;\n\t}\n\n\tif (bios_start < BIOS_START_MIN || bios_start > BIOS_START_MAX)\n\t\tbios_start = BIOS_START_MAX;\n\n\tif (ebda_start > BIOS_START_MIN && ebda_start < bios_start)\n\t\tbios_start = ebda_start;\n\n\tbios_start = round_down(bios_start, PAGE_SIZE);\n\n\t \n\tfor (i = boot_params->e820_entries - 1; i >= 0; i--) {\n\t\tunsigned long new = bios_start;\n\n\t\tentry = &boot_params->e820_table[i];\n\n\t\t \n\t\tif (bios_start <= entry->addr)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (entry->type != E820_TYPE_RAM)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (bios_start > entry->addr + entry->size)\n\t\t\tnew = entry->addr + entry->size;\n\n\t\t \n\t\tnew = round_down(new, PAGE_SIZE);\n\n\t\t \n\t\tif (new - TRAMPOLINE_32BIT_SIZE < entry->addr)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (new - TRAMPOLINE_32BIT_SIZE > bios_start)\n\t\t\tbreak;\n\n\t\tbios_start = new;\n\t\tbreak;\n\t}\n\n\t \n\treturn bios_start - TRAMPOLINE_32BIT_SIZE;\n}\n\nasmlinkage void configure_5level_paging(struct boot_params *bp, void *pgtable)\n{\n\tvoid (*toggle_la57)(void *cr3);\n\tbool l5_required = false;\n\n\t \n\tboot_params = bp;\n\n\t \n\tif (IS_ENABLED(CONFIG_X86_5LEVEL) &&\n\t\t\t!cmdline_find_option_bool(\"no5lvl\") &&\n\t\t\tnative_cpuid_eax(0) >= 7 &&\n\t\t\t(native_cpuid_ecx(7) & (1 << (X86_FEATURE_LA57 & 31)))) {\n\t\tl5_required = true;\n\n\t\t \n\t\t__pgtable_l5_enabled = 1;\n\t\tpgdir_shift = 48;\n\t\tptrs_per_p4d = 512;\n\t}\n\n\t \n\tif (l5_required == !!(native_read_cr4() & X86_CR4_LA57))\n\t\treturn;\n\n\ttrampoline_32bit = (unsigned long *)find_trampoline_placement();\n\n\t \n\tmemcpy(trampoline_save, trampoline_32bit, TRAMPOLINE_32BIT_SIZE);\n\n\t \n\tmemset(trampoline_32bit, 0, TRAMPOLINE_32BIT_SIZE);\n\n\t \n\ttoggle_la57 = memcpy(trampoline_32bit +\n\t\t\tTRAMPOLINE_32BIT_CODE_OFFSET / sizeof(unsigned long),\n\t\t\t&trampoline_32bit_src, TRAMPOLINE_32BIT_CODE_SIZE);\n\n\t \n\t*(u32 *)((u8 *)toggle_la57 + trampoline_ljmp_imm_offset) +=\n\t\t\t\t\t\t(unsigned long)toggle_la57;\n\n\t \n\n\tif (l5_required) {\n\t\t \n\t\t*trampoline_32bit = __native_read_cr3() | _PAGE_TABLE_NOENC;\n\t} else {\n\t\tunsigned long src;\n\n\t\t \n\t\tsrc = *(unsigned long *)__native_read_cr3() & PAGE_MASK;\n\t\tmemcpy(trampoline_32bit, (void *)src, PAGE_SIZE);\n\t}\n\n\ttoggle_la57(trampoline_32bit);\n\n\t \n\tmemcpy(pgtable, trampoline_32bit, PAGE_SIZE);\n\tnative_write_cr3((unsigned long)pgtable);\n\n\t \n\tmemcpy(trampoline_32bit, trampoline_save, TRAMPOLINE_32BIT_SIZE);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}