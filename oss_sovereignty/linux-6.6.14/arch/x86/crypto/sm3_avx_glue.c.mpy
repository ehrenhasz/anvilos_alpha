{
  "module_name": "sm3_avx_glue.c",
  "hash_id": "77abbc7f584a2409dff3afba48c1122f120035fc3beab3baaf9cf6794333cfd3",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/crypto/sm3_avx_glue.c",
  "human_readable_source": " \n \n\n#define pr_fmt(fmt)\tKBUILD_MODNAME \": \" fmt\n\n#include <crypto/internal/hash.h>\n#include <crypto/internal/simd.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/types.h>\n#include <crypto/sm3.h>\n#include <crypto/sm3_base.h>\n#include <asm/simd.h>\n\nasmlinkage void sm3_transform_avx(struct sm3_state *state,\n\t\t\tconst u8 *data, int nblocks);\n\nstatic int sm3_avx_update(struct shash_desc *desc, const u8 *data,\n\t\t\t unsigned int len)\n{\n\tstruct sm3_state *sctx = shash_desc_ctx(desc);\n\n\tif (!crypto_simd_usable() ||\n\t\t\t(sctx->count % SM3_BLOCK_SIZE) + len < SM3_BLOCK_SIZE) {\n\t\tsm3_update(sctx, data, len);\n\t\treturn 0;\n\t}\n\n\t \n\tBUILD_BUG_ON(offsetof(struct sm3_state, state) != 0);\n\n\tkernel_fpu_begin();\n\tsm3_base_do_update(desc, data, len, sm3_transform_avx);\n\tkernel_fpu_end();\n\n\treturn 0;\n}\n\nstatic int sm3_avx_finup(struct shash_desc *desc, const u8 *data,\n\t\t      unsigned int len, u8 *out)\n{\n\tif (!crypto_simd_usable()) {\n\t\tstruct sm3_state *sctx = shash_desc_ctx(desc);\n\n\t\tif (len)\n\t\t\tsm3_update(sctx, data, len);\n\n\t\tsm3_final(sctx, out);\n\t\treturn 0;\n\t}\n\n\tkernel_fpu_begin();\n\tif (len)\n\t\tsm3_base_do_update(desc, data, len, sm3_transform_avx);\n\tsm3_base_do_finalize(desc, sm3_transform_avx);\n\tkernel_fpu_end();\n\n\treturn sm3_base_finish(desc, out);\n}\n\nstatic int sm3_avx_final(struct shash_desc *desc, u8 *out)\n{\n\tif (!crypto_simd_usable()) {\n\t\tsm3_final(shash_desc_ctx(desc), out);\n\t\treturn 0;\n\t}\n\n\tkernel_fpu_begin();\n\tsm3_base_do_finalize(desc, sm3_transform_avx);\n\tkernel_fpu_end();\n\n\treturn sm3_base_finish(desc, out);\n}\n\nstatic struct shash_alg sm3_avx_alg = {\n\t.digestsize\t=\tSM3_DIGEST_SIZE,\n\t.init\t\t=\tsm3_base_init,\n\t.update\t\t=\tsm3_avx_update,\n\t.final\t\t=\tsm3_avx_final,\n\t.finup\t\t=\tsm3_avx_finup,\n\t.descsize\t=\tsizeof(struct sm3_state),\n\t.base\t\t=\t{\n\t\t.cra_name\t=\t\"sm3\",\n\t\t.cra_driver_name =\t\"sm3-avx\",\n\t\t.cra_priority\t=\t300,\n\t\t.cra_blocksize\t=\tSM3_BLOCK_SIZE,\n\t\t.cra_module\t=\tTHIS_MODULE,\n\t}\n};\n\nstatic int __init sm3_avx_mod_init(void)\n{\n\tconst char *feature_name;\n\n\tif (!boot_cpu_has(X86_FEATURE_AVX)) {\n\t\tpr_info(\"AVX instruction are not detected.\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (!boot_cpu_has(X86_FEATURE_BMI2)) {\n\t\tpr_info(\"BMI2 instruction are not detected.\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\tif (!cpu_has_xfeatures(XFEATURE_MASK_SSE | XFEATURE_MASK_YMM,\n\t\t\t\t&feature_name)) {\n\t\tpr_info(\"CPU feature '%s' is not supported.\\n\", feature_name);\n\t\treturn -ENODEV;\n\t}\n\n\treturn crypto_register_shash(&sm3_avx_alg);\n}\n\nstatic void __exit sm3_avx_mod_exit(void)\n{\n\tcrypto_unregister_shash(&sm3_avx_alg);\n}\n\nmodule_init(sm3_avx_mod_init);\nmodule_exit(sm3_avx_mod_exit);\n\nMODULE_LICENSE(\"GPL v2\");\nMODULE_AUTHOR(\"Tianjia Zhang <tianjia.zhang@linux.alibaba.com>\");\nMODULE_DESCRIPTION(\"SM3 Secure Hash Algorithm, AVX assembler accelerated\");\nMODULE_ALIAS_CRYPTO(\"sm3\");\nMODULE_ALIAS_CRYPTO(\"sm3-avx\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}