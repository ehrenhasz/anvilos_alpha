{
  "module_name": "sha512_ssse3_glue.c",
  "hash_id": "476f0b2523fc58892022b6d7b7dadadc4c3c30dd1c5004455d6d0888c8ca0af1",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/crypto/sha512_ssse3_glue.c",
  "human_readable_source": " \n\n#define pr_fmt(fmt)\tKBUILD_MODNAME \": \" fmt\n\n#include <crypto/internal/hash.h>\n#include <crypto/internal/simd.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/mm.h>\n#include <linux/string.h>\n#include <linux/types.h>\n#include <crypto/sha2.h>\n#include <crypto/sha512_base.h>\n#include <asm/cpu_device_id.h>\n#include <asm/simd.h>\n\nasmlinkage void sha512_transform_ssse3(struct sha512_state *state,\n\t\t\t\t       const u8 *data, int blocks);\n\nstatic int sha512_update(struct shash_desc *desc, const u8 *data,\n\t\t       unsigned int len, sha512_block_fn *sha512_xform)\n{\n\tstruct sha512_state *sctx = shash_desc_ctx(desc);\n\n\tif (!crypto_simd_usable() ||\n\t    (sctx->count[0] % SHA512_BLOCK_SIZE) + len < SHA512_BLOCK_SIZE)\n\t\treturn crypto_sha512_update(desc, data, len);\n\n\t \n\tBUILD_BUG_ON(offsetof(struct sha512_state, state) != 0);\n\n\tkernel_fpu_begin();\n\tsha512_base_do_update(desc, data, len, sha512_xform);\n\tkernel_fpu_end();\n\n\treturn 0;\n}\n\nstatic int sha512_finup(struct shash_desc *desc, const u8 *data,\n\t      unsigned int len, u8 *out, sha512_block_fn *sha512_xform)\n{\n\tif (!crypto_simd_usable())\n\t\treturn crypto_sha512_finup(desc, data, len, out);\n\n\tkernel_fpu_begin();\n\tif (len)\n\t\tsha512_base_do_update(desc, data, len, sha512_xform);\n\tsha512_base_do_finalize(desc, sha512_xform);\n\tkernel_fpu_end();\n\n\treturn sha512_base_finish(desc, out);\n}\n\nstatic int sha512_ssse3_update(struct shash_desc *desc, const u8 *data,\n\t\t       unsigned int len)\n{\n\treturn sha512_update(desc, data, len, sha512_transform_ssse3);\n}\n\nstatic int sha512_ssse3_finup(struct shash_desc *desc, const u8 *data,\n\t      unsigned int len, u8 *out)\n{\n\treturn sha512_finup(desc, data, len, out, sha512_transform_ssse3);\n}\n\n \nstatic int sha512_ssse3_final(struct shash_desc *desc, u8 *out)\n{\n\treturn sha512_ssse3_finup(desc, NULL, 0, out);\n}\n\nstatic struct shash_alg sha512_ssse3_algs[] = { {\n\t.digestsize\t=\tSHA512_DIGEST_SIZE,\n\t.init\t\t=\tsha512_base_init,\n\t.update\t\t=\tsha512_ssse3_update,\n\t.final\t\t=\tsha512_ssse3_final,\n\t.finup\t\t=\tsha512_ssse3_finup,\n\t.descsize\t=\tsizeof(struct sha512_state),\n\t.base\t\t=\t{\n\t\t.cra_name\t=\t\"sha512\",\n\t\t.cra_driver_name =\t\"sha512-ssse3\",\n\t\t.cra_priority\t=\t150,\n\t\t.cra_blocksize\t=\tSHA512_BLOCK_SIZE,\n\t\t.cra_module\t=\tTHIS_MODULE,\n\t}\n},  {\n\t.digestsize\t=\tSHA384_DIGEST_SIZE,\n\t.init\t\t=\tsha384_base_init,\n\t.update\t\t=\tsha512_ssse3_update,\n\t.final\t\t=\tsha512_ssse3_final,\n\t.finup\t\t=\tsha512_ssse3_finup,\n\t.descsize\t=\tsizeof(struct sha512_state),\n\t.base\t\t=\t{\n\t\t.cra_name\t=\t\"sha384\",\n\t\t.cra_driver_name =\t\"sha384-ssse3\",\n\t\t.cra_priority\t=\t150,\n\t\t.cra_blocksize\t=\tSHA384_BLOCK_SIZE,\n\t\t.cra_module\t=\tTHIS_MODULE,\n\t}\n} };\n\nstatic int register_sha512_ssse3(void)\n{\n\tif (boot_cpu_has(X86_FEATURE_SSSE3))\n\t\treturn crypto_register_shashes(sha512_ssse3_algs,\n\t\t\tARRAY_SIZE(sha512_ssse3_algs));\n\treturn 0;\n}\n\nstatic void unregister_sha512_ssse3(void)\n{\n\tif (boot_cpu_has(X86_FEATURE_SSSE3))\n\t\tcrypto_unregister_shashes(sha512_ssse3_algs,\n\t\t\tARRAY_SIZE(sha512_ssse3_algs));\n}\n\nasmlinkage void sha512_transform_avx(struct sha512_state *state,\n\t\t\t\t     const u8 *data, int blocks);\nstatic bool avx_usable(void)\n{\n\tif (!cpu_has_xfeatures(XFEATURE_MASK_SSE | XFEATURE_MASK_YMM, NULL)) {\n\t\tif (boot_cpu_has(X86_FEATURE_AVX))\n\t\t\tpr_info(\"AVX detected but unusable.\\n\");\n\t\treturn false;\n\t}\n\n\treturn true;\n}\n\nstatic int sha512_avx_update(struct shash_desc *desc, const u8 *data,\n\t\t       unsigned int len)\n{\n\treturn sha512_update(desc, data, len, sha512_transform_avx);\n}\n\nstatic int sha512_avx_finup(struct shash_desc *desc, const u8 *data,\n\t      unsigned int len, u8 *out)\n{\n\treturn sha512_finup(desc, data, len, out, sha512_transform_avx);\n}\n\n \nstatic int sha512_avx_final(struct shash_desc *desc, u8 *out)\n{\n\treturn sha512_avx_finup(desc, NULL, 0, out);\n}\n\nstatic struct shash_alg sha512_avx_algs[] = { {\n\t.digestsize\t=\tSHA512_DIGEST_SIZE,\n\t.init\t\t=\tsha512_base_init,\n\t.update\t\t=\tsha512_avx_update,\n\t.final\t\t=\tsha512_avx_final,\n\t.finup\t\t=\tsha512_avx_finup,\n\t.descsize\t=\tsizeof(struct sha512_state),\n\t.base\t\t=\t{\n\t\t.cra_name\t=\t\"sha512\",\n\t\t.cra_driver_name =\t\"sha512-avx\",\n\t\t.cra_priority\t=\t160,\n\t\t.cra_blocksize\t=\tSHA512_BLOCK_SIZE,\n\t\t.cra_module\t=\tTHIS_MODULE,\n\t}\n},  {\n\t.digestsize\t=\tSHA384_DIGEST_SIZE,\n\t.init\t\t=\tsha384_base_init,\n\t.update\t\t=\tsha512_avx_update,\n\t.final\t\t=\tsha512_avx_final,\n\t.finup\t\t=\tsha512_avx_finup,\n\t.descsize\t=\tsizeof(struct sha512_state),\n\t.base\t\t=\t{\n\t\t.cra_name\t=\t\"sha384\",\n\t\t.cra_driver_name =\t\"sha384-avx\",\n\t\t.cra_priority\t=\t160,\n\t\t.cra_blocksize\t=\tSHA384_BLOCK_SIZE,\n\t\t.cra_module\t=\tTHIS_MODULE,\n\t}\n} };\n\nstatic int register_sha512_avx(void)\n{\n\tif (avx_usable())\n\t\treturn crypto_register_shashes(sha512_avx_algs,\n\t\t\tARRAY_SIZE(sha512_avx_algs));\n\treturn 0;\n}\n\nstatic void unregister_sha512_avx(void)\n{\n\tif (avx_usable())\n\t\tcrypto_unregister_shashes(sha512_avx_algs,\n\t\t\tARRAY_SIZE(sha512_avx_algs));\n}\n\nasmlinkage void sha512_transform_rorx(struct sha512_state *state,\n\t\t\t\t      const u8 *data, int blocks);\n\nstatic int sha512_avx2_update(struct shash_desc *desc, const u8 *data,\n\t\t       unsigned int len)\n{\n\treturn sha512_update(desc, data, len, sha512_transform_rorx);\n}\n\nstatic int sha512_avx2_finup(struct shash_desc *desc, const u8 *data,\n\t      unsigned int len, u8 *out)\n{\n\treturn sha512_finup(desc, data, len, out, sha512_transform_rorx);\n}\n\n \nstatic int sha512_avx2_final(struct shash_desc *desc, u8 *out)\n{\n\treturn sha512_avx2_finup(desc, NULL, 0, out);\n}\n\nstatic struct shash_alg sha512_avx2_algs[] = { {\n\t.digestsize\t=\tSHA512_DIGEST_SIZE,\n\t.init\t\t=\tsha512_base_init,\n\t.update\t\t=\tsha512_avx2_update,\n\t.final\t\t=\tsha512_avx2_final,\n\t.finup\t\t=\tsha512_avx2_finup,\n\t.descsize\t=\tsizeof(struct sha512_state),\n\t.base\t\t=\t{\n\t\t.cra_name\t=\t\"sha512\",\n\t\t.cra_driver_name =\t\"sha512-avx2\",\n\t\t.cra_priority\t=\t170,\n\t\t.cra_blocksize\t=\tSHA512_BLOCK_SIZE,\n\t\t.cra_module\t=\tTHIS_MODULE,\n\t}\n},  {\n\t.digestsize\t=\tSHA384_DIGEST_SIZE,\n\t.init\t\t=\tsha384_base_init,\n\t.update\t\t=\tsha512_avx2_update,\n\t.final\t\t=\tsha512_avx2_final,\n\t.finup\t\t=\tsha512_avx2_finup,\n\t.descsize\t=\tsizeof(struct sha512_state),\n\t.base\t\t=\t{\n\t\t.cra_name\t=\t\"sha384\",\n\t\t.cra_driver_name =\t\"sha384-avx2\",\n\t\t.cra_priority\t=\t170,\n\t\t.cra_blocksize\t=\tSHA384_BLOCK_SIZE,\n\t\t.cra_module\t=\tTHIS_MODULE,\n\t}\n} };\n\nstatic bool avx2_usable(void)\n{\n\tif (avx_usable() && boot_cpu_has(X86_FEATURE_AVX2) &&\n\t\t    boot_cpu_has(X86_FEATURE_BMI2))\n\t\treturn true;\n\n\treturn false;\n}\n\nstatic int register_sha512_avx2(void)\n{\n\tif (avx2_usable())\n\t\treturn crypto_register_shashes(sha512_avx2_algs,\n\t\t\tARRAY_SIZE(sha512_avx2_algs));\n\treturn 0;\n}\nstatic const struct x86_cpu_id module_cpu_ids[] = {\n\tX86_MATCH_FEATURE(X86_FEATURE_AVX2, NULL),\n\tX86_MATCH_FEATURE(X86_FEATURE_AVX, NULL),\n\tX86_MATCH_FEATURE(X86_FEATURE_SSSE3, NULL),\n\t{}\n};\nMODULE_DEVICE_TABLE(x86cpu, module_cpu_ids);\n\nstatic void unregister_sha512_avx2(void)\n{\n\tif (avx2_usable())\n\t\tcrypto_unregister_shashes(sha512_avx2_algs,\n\t\t\tARRAY_SIZE(sha512_avx2_algs));\n}\n\nstatic int __init sha512_ssse3_mod_init(void)\n{\n\tif (!x86_match_cpu(module_cpu_ids))\n\t\treturn -ENODEV;\n\n\tif (register_sha512_ssse3())\n\t\tgoto fail;\n\n\tif (register_sha512_avx()) {\n\t\tunregister_sha512_ssse3();\n\t\tgoto fail;\n\t}\n\n\tif (register_sha512_avx2()) {\n\t\tunregister_sha512_avx();\n\t\tunregister_sha512_ssse3();\n\t\tgoto fail;\n\t}\n\n\treturn 0;\nfail:\n\treturn -ENODEV;\n}\n\nstatic void __exit sha512_ssse3_mod_fini(void)\n{\n\tunregister_sha512_avx2();\n\tunregister_sha512_avx();\n\tunregister_sha512_ssse3();\n}\n\nmodule_init(sha512_ssse3_mod_init);\nmodule_exit(sha512_ssse3_mod_fini);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"SHA512 Secure Hash Algorithm, Supplemental SSE3 accelerated\");\n\nMODULE_ALIAS_CRYPTO(\"sha512\");\nMODULE_ALIAS_CRYPTO(\"sha512-ssse3\");\nMODULE_ALIAS_CRYPTO(\"sha512-avx\");\nMODULE_ALIAS_CRYPTO(\"sha512-avx2\");\nMODULE_ALIAS_CRYPTO(\"sha384\");\nMODULE_ALIAS_CRYPTO(\"sha384-ssse3\");\nMODULE_ALIAS_CRYPTO(\"sha384-avx\");\nMODULE_ALIAS_CRYPTO(\"sha384-avx2\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}