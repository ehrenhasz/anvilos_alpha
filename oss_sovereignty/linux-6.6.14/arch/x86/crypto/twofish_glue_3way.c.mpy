{
  "module_name": "twofish_glue_3way.c",
  "hash_id": "75a9dc6d4dc5acdef68535a76649ba9718aea01689d2fd194b86f165e15b7a61",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/crypto/twofish_glue_3way.c",
  "human_readable_source": "\n \n\n#include <crypto/algapi.h>\n#include <crypto/twofish.h>\n#include <linux/crypto.h>\n#include <linux/init.h>\n#include <linux/module.h>\n#include <linux/types.h>\n\n#include \"twofish.h\"\n#include \"ecb_cbc_helpers.h\"\n\nEXPORT_SYMBOL_GPL(__twofish_enc_blk_3way);\nEXPORT_SYMBOL_GPL(twofish_dec_blk_3way);\n\nstatic int twofish_setkey_skcipher(struct crypto_skcipher *tfm,\n\t\t\t\t   const u8 *key, unsigned int keylen)\n{\n\treturn twofish_setkey(&tfm->base, key, keylen);\n}\n\nstatic inline void twofish_enc_blk_3way(const void *ctx, u8 *dst, const u8 *src)\n{\n\t__twofish_enc_blk_3way(ctx, dst, src, false);\n}\n\nvoid twofish_dec_blk_cbc_3way(const void *ctx, u8 *dst, const u8 *src)\n{\n\tu8 buf[2][TF_BLOCK_SIZE];\n\tconst u8 *s = src;\n\n\tif (dst == src)\n\t\ts = memcpy(buf, src, sizeof(buf));\n\ttwofish_dec_blk_3way(ctx, dst, src);\n\tcrypto_xor(dst + TF_BLOCK_SIZE, s, sizeof(buf));\n\n}\nEXPORT_SYMBOL_GPL(twofish_dec_blk_cbc_3way);\n\nstatic int ecb_encrypt(struct skcipher_request *req)\n{\n\tECB_WALK_START(req, TF_BLOCK_SIZE, -1);\n\tECB_BLOCK(3, twofish_enc_blk_3way);\n\tECB_BLOCK(1, twofish_enc_blk);\n\tECB_WALK_END();\n}\n\nstatic int ecb_decrypt(struct skcipher_request *req)\n{\n\tECB_WALK_START(req, TF_BLOCK_SIZE, -1);\n\tECB_BLOCK(3, twofish_dec_blk_3way);\n\tECB_BLOCK(1, twofish_dec_blk);\n\tECB_WALK_END();\n}\n\nstatic int cbc_encrypt(struct skcipher_request *req)\n{\n\tCBC_WALK_START(req, TF_BLOCK_SIZE, -1);\n\tCBC_ENC_BLOCK(twofish_enc_blk);\n\tCBC_WALK_END();\n}\n\nstatic int cbc_decrypt(struct skcipher_request *req)\n{\n\tCBC_WALK_START(req, TF_BLOCK_SIZE, -1);\n\tCBC_DEC_BLOCK(3, twofish_dec_blk_cbc_3way);\n\tCBC_DEC_BLOCK(1, twofish_dec_blk);\n\tCBC_WALK_END();\n}\n\nstatic struct skcipher_alg tf_skciphers[] = {\n\t{\n\t\t.base.cra_name\t\t= \"ecb(twofish)\",\n\t\t.base.cra_driver_name\t= \"ecb-twofish-3way\",\n\t\t.base.cra_priority\t= 300,\n\t\t.base.cra_blocksize\t= TF_BLOCK_SIZE,\n\t\t.base.cra_ctxsize\t= sizeof(struct twofish_ctx),\n\t\t.base.cra_module\t= THIS_MODULE,\n\t\t.min_keysize\t\t= TF_MIN_KEY_SIZE,\n\t\t.max_keysize\t\t= TF_MAX_KEY_SIZE,\n\t\t.setkey\t\t\t= twofish_setkey_skcipher,\n\t\t.encrypt\t\t= ecb_encrypt,\n\t\t.decrypt\t\t= ecb_decrypt,\n\t}, {\n\t\t.base.cra_name\t\t= \"cbc(twofish)\",\n\t\t.base.cra_driver_name\t= \"cbc-twofish-3way\",\n\t\t.base.cra_priority\t= 300,\n\t\t.base.cra_blocksize\t= TF_BLOCK_SIZE,\n\t\t.base.cra_ctxsize\t= sizeof(struct twofish_ctx),\n\t\t.base.cra_module\t= THIS_MODULE,\n\t\t.min_keysize\t\t= TF_MIN_KEY_SIZE,\n\t\t.max_keysize\t\t= TF_MAX_KEY_SIZE,\n\t\t.ivsize\t\t\t= TF_BLOCK_SIZE,\n\t\t.setkey\t\t\t= twofish_setkey_skcipher,\n\t\t.encrypt\t\t= cbc_encrypt,\n\t\t.decrypt\t\t= cbc_decrypt,\n\t},\n};\n\nstatic bool is_blacklisted_cpu(void)\n{\n\tif (boot_cpu_data.x86_vendor != X86_VENDOR_INTEL)\n\t\treturn false;\n\n\tif (boot_cpu_data.x86 == 0x06 &&\n\t\t(boot_cpu_data.x86_model == 0x1c ||\n\t\t boot_cpu_data.x86_model == 0x26 ||\n\t\t boot_cpu_data.x86_model == 0x36)) {\n\t\t \n\t\treturn true;\n\t}\n\n\tif (boot_cpu_data.x86 == 0x0f) {\n\t\t \n\t\treturn true;\n\t}\n\n\treturn false;\n}\n\nstatic int force;\nmodule_param(force, int, 0);\nMODULE_PARM_DESC(force, \"Force module load, ignore CPU blacklist\");\n\nstatic int __init twofish_3way_init(void)\n{\n\tif (!force && is_blacklisted_cpu()) {\n\t\tprintk(KERN_INFO\n\t\t\t\"twofish-x86_64-3way: performance on this CPU \"\n\t\t\t\"would be suboptimal: disabling \"\n\t\t\t\"twofish-x86_64-3way.\\n\");\n\t\treturn -ENODEV;\n\t}\n\n\treturn crypto_register_skciphers(tf_skciphers,\n\t\t\t\t\t ARRAY_SIZE(tf_skciphers));\n}\n\nstatic void __exit twofish_3way_fini(void)\n{\n\tcrypto_unregister_skciphers(tf_skciphers, ARRAY_SIZE(tf_skciphers));\n}\n\nmodule_init(twofish_3way_init);\nmodule_exit(twofish_3way_fini);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_DESCRIPTION(\"Twofish Cipher Algorithm, 3-way parallel asm optimized\");\nMODULE_ALIAS_CRYPTO(\"twofish\");\nMODULE_ALIAS_CRYPTO(\"twofish-asm\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}