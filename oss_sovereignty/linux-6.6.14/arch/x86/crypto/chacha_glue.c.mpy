{
  "module_name": "chacha_glue.c",
  "hash_id": "d4abf5240567b883535c88dd5fca1eb675e2844ab94e0c38ba0955eedcee0496",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/crypto/chacha_glue.c",
  "human_readable_source": "\n \n\n#include <crypto/algapi.h>\n#include <crypto/internal/chacha.h>\n#include <crypto/internal/simd.h>\n#include <crypto/internal/skcipher.h>\n#include <linux/kernel.h>\n#include <linux/module.h>\n#include <linux/sizes.h>\n#include <asm/simd.h>\n\nasmlinkage void chacha_block_xor_ssse3(u32 *state, u8 *dst, const u8 *src,\n\t\t\t\t       unsigned int len, int nrounds);\nasmlinkage void chacha_4block_xor_ssse3(u32 *state, u8 *dst, const u8 *src,\n\t\t\t\t\tunsigned int len, int nrounds);\nasmlinkage void hchacha_block_ssse3(const u32 *state, u32 *out, int nrounds);\n\nasmlinkage void chacha_2block_xor_avx2(u32 *state, u8 *dst, const u8 *src,\n\t\t\t\t       unsigned int len, int nrounds);\nasmlinkage void chacha_4block_xor_avx2(u32 *state, u8 *dst, const u8 *src,\n\t\t\t\t       unsigned int len, int nrounds);\nasmlinkage void chacha_8block_xor_avx2(u32 *state, u8 *dst, const u8 *src,\n\t\t\t\t       unsigned int len, int nrounds);\n\nasmlinkage void chacha_2block_xor_avx512vl(u32 *state, u8 *dst, const u8 *src,\n\t\t\t\t\t   unsigned int len, int nrounds);\nasmlinkage void chacha_4block_xor_avx512vl(u32 *state, u8 *dst, const u8 *src,\n\t\t\t\t\t   unsigned int len, int nrounds);\nasmlinkage void chacha_8block_xor_avx512vl(u32 *state, u8 *dst, const u8 *src,\n\t\t\t\t\t   unsigned int len, int nrounds);\n\nstatic __ro_after_init DEFINE_STATIC_KEY_FALSE(chacha_use_simd);\nstatic __ro_after_init DEFINE_STATIC_KEY_FALSE(chacha_use_avx2);\nstatic __ro_after_init DEFINE_STATIC_KEY_FALSE(chacha_use_avx512vl);\n\nstatic unsigned int chacha_advance(unsigned int len, unsigned int maxblocks)\n{\n\tlen = min(len, maxblocks * CHACHA_BLOCK_SIZE);\n\treturn round_up(len, CHACHA_BLOCK_SIZE) / CHACHA_BLOCK_SIZE;\n}\n\nstatic void chacha_dosimd(u32 *state, u8 *dst, const u8 *src,\n\t\t\t  unsigned int bytes, int nrounds)\n{\n\tif (IS_ENABLED(CONFIG_AS_AVX512) &&\n\t    static_branch_likely(&chacha_use_avx512vl)) {\n\t\twhile (bytes >= CHACHA_BLOCK_SIZE * 8) {\n\t\t\tchacha_8block_xor_avx512vl(state, dst, src, bytes,\n\t\t\t\t\t\t   nrounds);\n\t\t\tbytes -= CHACHA_BLOCK_SIZE * 8;\n\t\t\tsrc += CHACHA_BLOCK_SIZE * 8;\n\t\t\tdst += CHACHA_BLOCK_SIZE * 8;\n\t\t\tstate[12] += 8;\n\t\t}\n\t\tif (bytes > CHACHA_BLOCK_SIZE * 4) {\n\t\t\tchacha_8block_xor_avx512vl(state, dst, src, bytes,\n\t\t\t\t\t\t   nrounds);\n\t\t\tstate[12] += chacha_advance(bytes, 8);\n\t\t\treturn;\n\t\t}\n\t\tif (bytes > CHACHA_BLOCK_SIZE * 2) {\n\t\t\tchacha_4block_xor_avx512vl(state, dst, src, bytes,\n\t\t\t\t\t\t   nrounds);\n\t\t\tstate[12] += chacha_advance(bytes, 4);\n\t\t\treturn;\n\t\t}\n\t\tif (bytes) {\n\t\t\tchacha_2block_xor_avx512vl(state, dst, src, bytes,\n\t\t\t\t\t\t   nrounds);\n\t\t\tstate[12] += chacha_advance(bytes, 2);\n\t\t\treturn;\n\t\t}\n\t}\n\n\tif (static_branch_likely(&chacha_use_avx2)) {\n\t\twhile (bytes >= CHACHA_BLOCK_SIZE * 8) {\n\t\t\tchacha_8block_xor_avx2(state, dst, src, bytes, nrounds);\n\t\t\tbytes -= CHACHA_BLOCK_SIZE * 8;\n\t\t\tsrc += CHACHA_BLOCK_SIZE * 8;\n\t\t\tdst += CHACHA_BLOCK_SIZE * 8;\n\t\t\tstate[12] += 8;\n\t\t}\n\t\tif (bytes > CHACHA_BLOCK_SIZE * 4) {\n\t\t\tchacha_8block_xor_avx2(state, dst, src, bytes, nrounds);\n\t\t\tstate[12] += chacha_advance(bytes, 8);\n\t\t\treturn;\n\t\t}\n\t\tif (bytes > CHACHA_BLOCK_SIZE * 2) {\n\t\t\tchacha_4block_xor_avx2(state, dst, src, bytes, nrounds);\n\t\t\tstate[12] += chacha_advance(bytes, 4);\n\t\t\treturn;\n\t\t}\n\t\tif (bytes > CHACHA_BLOCK_SIZE) {\n\t\t\tchacha_2block_xor_avx2(state, dst, src, bytes, nrounds);\n\t\t\tstate[12] += chacha_advance(bytes, 2);\n\t\t\treturn;\n\t\t}\n\t}\n\n\twhile (bytes >= CHACHA_BLOCK_SIZE * 4) {\n\t\tchacha_4block_xor_ssse3(state, dst, src, bytes, nrounds);\n\t\tbytes -= CHACHA_BLOCK_SIZE * 4;\n\t\tsrc += CHACHA_BLOCK_SIZE * 4;\n\t\tdst += CHACHA_BLOCK_SIZE * 4;\n\t\tstate[12] += 4;\n\t}\n\tif (bytes > CHACHA_BLOCK_SIZE) {\n\t\tchacha_4block_xor_ssse3(state, dst, src, bytes, nrounds);\n\t\tstate[12] += chacha_advance(bytes, 4);\n\t\treturn;\n\t}\n\tif (bytes) {\n\t\tchacha_block_xor_ssse3(state, dst, src, bytes, nrounds);\n\t\tstate[12]++;\n\t}\n}\n\nvoid hchacha_block_arch(const u32 *state, u32 *stream, int nrounds)\n{\n\tif (!static_branch_likely(&chacha_use_simd) || !crypto_simd_usable()) {\n\t\thchacha_block_generic(state, stream, nrounds);\n\t} else {\n\t\tkernel_fpu_begin();\n\t\thchacha_block_ssse3(state, stream, nrounds);\n\t\tkernel_fpu_end();\n\t}\n}\nEXPORT_SYMBOL(hchacha_block_arch);\n\nvoid chacha_init_arch(u32 *state, const u32 *key, const u8 *iv)\n{\n\tchacha_init_generic(state, key, iv);\n}\nEXPORT_SYMBOL(chacha_init_arch);\n\nvoid chacha_crypt_arch(u32 *state, u8 *dst, const u8 *src, unsigned int bytes,\n\t\t       int nrounds)\n{\n\tif (!static_branch_likely(&chacha_use_simd) || !crypto_simd_usable() ||\n\t    bytes <= CHACHA_BLOCK_SIZE)\n\t\treturn chacha_crypt_generic(state, dst, src, bytes, nrounds);\n\n\tdo {\n\t\tunsigned int todo = min_t(unsigned int, bytes, SZ_4K);\n\n\t\tkernel_fpu_begin();\n\t\tchacha_dosimd(state, dst, src, todo, nrounds);\n\t\tkernel_fpu_end();\n\n\t\tbytes -= todo;\n\t\tsrc += todo;\n\t\tdst += todo;\n\t} while (bytes);\n}\nEXPORT_SYMBOL(chacha_crypt_arch);\n\nstatic int chacha_simd_stream_xor(struct skcipher_request *req,\n\t\t\t\t  const struct chacha_ctx *ctx, const u8 *iv)\n{\n\tu32 state[CHACHA_STATE_WORDS] __aligned(8);\n\tstruct skcipher_walk walk;\n\tint err;\n\n\terr = skcipher_walk_virt(&walk, req, false);\n\n\tchacha_init_generic(state, ctx->key, iv);\n\n\twhile (walk.nbytes > 0) {\n\t\tunsigned int nbytes = walk.nbytes;\n\n\t\tif (nbytes < walk.total)\n\t\t\tnbytes = round_down(nbytes, walk.stride);\n\n\t\tif (!static_branch_likely(&chacha_use_simd) ||\n\t\t    !crypto_simd_usable()) {\n\t\t\tchacha_crypt_generic(state, walk.dst.virt.addr,\n\t\t\t\t\t     walk.src.virt.addr, nbytes,\n\t\t\t\t\t     ctx->nrounds);\n\t\t} else {\n\t\t\tkernel_fpu_begin();\n\t\t\tchacha_dosimd(state, walk.dst.virt.addr,\n\t\t\t\t      walk.src.virt.addr, nbytes,\n\t\t\t\t      ctx->nrounds);\n\t\t\tkernel_fpu_end();\n\t\t}\n\t\terr = skcipher_walk_done(&walk, walk.nbytes - nbytes);\n\t}\n\n\treturn err;\n}\n\nstatic int chacha_simd(struct skcipher_request *req)\n{\n\tstruct crypto_skcipher *tfm = crypto_skcipher_reqtfm(req);\n\tstruct chacha_ctx *ctx = crypto_skcipher_ctx(tfm);\n\n\treturn chacha_simd_stream_xor(req, ctx, req->iv);\n}\n\nstatic int xchacha_simd(struct skcipher_request *req)\n{\n\tstruct crypto_skcipher *tfm = crypto_skcipher_reqtfm(req);\n\tstruct chacha_ctx *ctx = crypto_skcipher_ctx(tfm);\n\tu32 state[CHACHA_STATE_WORDS] __aligned(8);\n\tstruct chacha_ctx subctx;\n\tu8 real_iv[16];\n\n\tchacha_init_generic(state, ctx->key, req->iv);\n\n\tif (req->cryptlen > CHACHA_BLOCK_SIZE && crypto_simd_usable()) {\n\t\tkernel_fpu_begin();\n\t\thchacha_block_ssse3(state, subctx.key, ctx->nrounds);\n\t\tkernel_fpu_end();\n\t} else {\n\t\thchacha_block_generic(state, subctx.key, ctx->nrounds);\n\t}\n\tsubctx.nrounds = ctx->nrounds;\n\n\tmemcpy(&real_iv[0], req->iv + 24, 8);\n\tmemcpy(&real_iv[8], req->iv + 16, 8);\n\treturn chacha_simd_stream_xor(req, &subctx, real_iv);\n}\n\nstatic struct skcipher_alg algs[] = {\n\t{\n\t\t.base.cra_name\t\t= \"chacha20\",\n\t\t.base.cra_driver_name\t= \"chacha20-simd\",\n\t\t.base.cra_priority\t= 300,\n\t\t.base.cra_blocksize\t= 1,\n\t\t.base.cra_ctxsize\t= sizeof(struct chacha_ctx),\n\t\t.base.cra_module\t= THIS_MODULE,\n\n\t\t.min_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.max_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.ivsize\t\t\t= CHACHA_IV_SIZE,\n\t\t.chunksize\t\t= CHACHA_BLOCK_SIZE,\n\t\t.setkey\t\t\t= chacha20_setkey,\n\t\t.encrypt\t\t= chacha_simd,\n\t\t.decrypt\t\t= chacha_simd,\n\t}, {\n\t\t.base.cra_name\t\t= \"xchacha20\",\n\t\t.base.cra_driver_name\t= \"xchacha20-simd\",\n\t\t.base.cra_priority\t= 300,\n\t\t.base.cra_blocksize\t= 1,\n\t\t.base.cra_ctxsize\t= sizeof(struct chacha_ctx),\n\t\t.base.cra_module\t= THIS_MODULE,\n\n\t\t.min_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.max_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.ivsize\t\t\t= XCHACHA_IV_SIZE,\n\t\t.chunksize\t\t= CHACHA_BLOCK_SIZE,\n\t\t.setkey\t\t\t= chacha20_setkey,\n\t\t.encrypt\t\t= xchacha_simd,\n\t\t.decrypt\t\t= xchacha_simd,\n\t}, {\n\t\t.base.cra_name\t\t= \"xchacha12\",\n\t\t.base.cra_driver_name\t= \"xchacha12-simd\",\n\t\t.base.cra_priority\t= 300,\n\t\t.base.cra_blocksize\t= 1,\n\t\t.base.cra_ctxsize\t= sizeof(struct chacha_ctx),\n\t\t.base.cra_module\t= THIS_MODULE,\n\n\t\t.min_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.max_keysize\t\t= CHACHA_KEY_SIZE,\n\t\t.ivsize\t\t\t= XCHACHA_IV_SIZE,\n\t\t.chunksize\t\t= CHACHA_BLOCK_SIZE,\n\t\t.setkey\t\t\t= chacha12_setkey,\n\t\t.encrypt\t\t= xchacha_simd,\n\t\t.decrypt\t\t= xchacha_simd,\n\t},\n};\n\nstatic int __init chacha_simd_mod_init(void)\n{\n\tif (!boot_cpu_has(X86_FEATURE_SSSE3))\n\t\treturn 0;\n\n\tstatic_branch_enable(&chacha_use_simd);\n\n\tif (boot_cpu_has(X86_FEATURE_AVX) &&\n\t    boot_cpu_has(X86_FEATURE_AVX2) &&\n\t    cpu_has_xfeatures(XFEATURE_MASK_SSE | XFEATURE_MASK_YMM, NULL)) {\n\t\tstatic_branch_enable(&chacha_use_avx2);\n\n\t\tif (IS_ENABLED(CONFIG_AS_AVX512) &&\n\t\t    boot_cpu_has(X86_FEATURE_AVX512VL) &&\n\t\t    boot_cpu_has(X86_FEATURE_AVX512BW))  \n\t\t\tstatic_branch_enable(&chacha_use_avx512vl);\n\t}\n\treturn IS_REACHABLE(CONFIG_CRYPTO_SKCIPHER) ?\n\t\tcrypto_register_skciphers(algs, ARRAY_SIZE(algs)) : 0;\n}\n\nstatic void __exit chacha_simd_mod_fini(void)\n{\n\tif (IS_REACHABLE(CONFIG_CRYPTO_SKCIPHER) && boot_cpu_has(X86_FEATURE_SSSE3))\n\t\tcrypto_unregister_skciphers(algs, ARRAY_SIZE(algs));\n}\n\nmodule_init(chacha_simd_mod_init);\nmodule_exit(chacha_simd_mod_fini);\n\nMODULE_LICENSE(\"GPL\");\nMODULE_AUTHOR(\"Martin Willi <martin@strongswan.org>\");\nMODULE_DESCRIPTION(\"ChaCha and XChaCha stream ciphers (x64 SIMD accelerated)\");\nMODULE_ALIAS_CRYPTO(\"chacha20\");\nMODULE_ALIAS_CRYPTO(\"chacha20-simd\");\nMODULE_ALIAS_CRYPTO(\"xchacha20\");\nMODULE_ALIAS_CRYPTO(\"xchacha20-simd\");\nMODULE_ALIAS_CRYPTO(\"xchacha12\");\nMODULE_ALIAS_CRYPTO(\"xchacha12-simd\");\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}