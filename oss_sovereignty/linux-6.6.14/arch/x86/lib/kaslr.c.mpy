{
  "module_name": "kaslr.c",
  "hash_id": "e445d2ef8a2f22756fe7732f80fc5409fb9587004dc2996fa0a02ae09211dd49",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/lib/kaslr.c",
  "human_readable_source": "\n \n#include <asm/asm.h>\n#include <asm/kaslr.h>\n#include <asm/msr.h>\n#include <asm/archrandom.h>\n#include <asm/e820/api.h>\n#include <asm/shared/io.h>\n\n \n#ifndef KASLR_COMPRESSED_BOOT\n#include <asm/cpufeature.h>\n#include <asm/setup.h>\n\n#define debug_putstr(v) early_printk(\"%s\", v)\n#define has_cpuflag(f) boot_cpu_has(f)\n#define get_boot_seed() kaslr_offset()\n#endif\n\n#define I8254_PORT_CONTROL\t0x43\n#define I8254_PORT_COUNTER0\t0x40\n#define I8254_CMD_READBACK\t0xC0\n#define I8254_SELECT_COUNTER0\t0x02\n#define I8254_STATUS_NOTREADY\t0x40\nstatic inline u16 i8254(void)\n{\n\tu16 status, timer;\n\n\tdo {\n\t\toutb(I8254_CMD_READBACK | I8254_SELECT_COUNTER0,\n\t\t     I8254_PORT_CONTROL);\n\t\tstatus = inb(I8254_PORT_COUNTER0);\n\t\ttimer  = inb(I8254_PORT_COUNTER0);\n\t\ttimer |= inb(I8254_PORT_COUNTER0) << 8;\n\t} while (status & I8254_STATUS_NOTREADY);\n\n\treturn timer;\n}\n\nunsigned long kaslr_get_random_long(const char *purpose)\n{\n#ifdef CONFIG_X86_64\n\tconst unsigned long mix_const = 0x5d6008cbf3848dd3UL;\n#else\n\tconst unsigned long mix_const = 0x3f39e593UL;\n#endif\n\tunsigned long raw, random = get_boot_seed();\n\tbool use_i8254 = true;\n\n\tif (purpose) {\n\t\tdebug_putstr(purpose);\n\t\tdebug_putstr(\" KASLR using\");\n\t}\n\n\tif (has_cpuflag(X86_FEATURE_RDRAND)) {\n\t\tif (purpose)\n\t\t\tdebug_putstr(\" RDRAND\");\n\t\tif (rdrand_long(&raw)) {\n\t\t\trandom ^= raw;\n\t\t\tuse_i8254 = false;\n\t\t}\n\t}\n\n\tif (has_cpuflag(X86_FEATURE_TSC)) {\n\t\tif (purpose)\n\t\t\tdebug_putstr(\" RDTSC\");\n\t\traw = rdtsc();\n\n\t\trandom ^= raw;\n\t\tuse_i8254 = false;\n\t}\n\n\tif (use_i8254) {\n\t\tif (purpose)\n\t\t\tdebug_putstr(\" i8254\");\n\t\trandom ^= i8254();\n\t}\n\n\t \n\tasm(_ASM_MUL \"%3\"\n\t    : \"=a\" (random), \"=d\" (raw)\n\t    : \"a\" (random), \"rm\" (mix_const));\n\trandom += raw;\n\n\tif (purpose)\n\t\tdebug_putstr(\"...\\n\");\n\n\treturn random;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}