{
  "module_name": "msr.c",
  "hash_id": "6cbffdd9f661d741ab20700006b934e111df76683f2475345a4276c4cade8a6d",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/lib/msr.c",
  "human_readable_source": "\n#include <linux/export.h>\n#include <linux/percpu.h>\n#include <linux/preempt.h>\n#include <asm/msr.h>\n#define CREATE_TRACE_POINTS\n#include <asm/msr-trace.h>\n\nstruct msr *msrs_alloc(void)\n{\n\tstruct msr *msrs = NULL;\n\n\tmsrs = alloc_percpu(struct msr);\n\tif (!msrs) {\n\t\tpr_warn(\"%s: error allocating msrs\\n\", __func__);\n\t\treturn NULL;\n\t}\n\n\treturn msrs;\n}\nEXPORT_SYMBOL(msrs_alloc);\n\nvoid msrs_free(struct msr *msrs)\n{\n\tfree_percpu(msrs);\n}\nEXPORT_SYMBOL(msrs_free);\n\n \nstatic int msr_read(u32 msr, struct msr *m)\n{\n\tint err;\n\tu64 val;\n\n\terr = rdmsrl_safe(msr, &val);\n\tif (!err)\n\t\tm->q = val;\n\n\treturn err;\n}\n\n \nstatic int msr_write(u32 msr, struct msr *m)\n{\n\treturn wrmsrl_safe(msr, m->q);\n}\n\nstatic inline int __flip_bit(u32 msr, u8 bit, bool set)\n{\n\tstruct msr m, m1;\n\tint err = -EINVAL;\n\n\tif (bit > 63)\n\t\treturn err;\n\n\terr = msr_read(msr, &m);\n\tif (err)\n\t\treturn err;\n\n\tm1 = m;\n\tif (set)\n\t\tm1.q |=  BIT_64(bit);\n\telse\n\t\tm1.q &= ~BIT_64(bit);\n\n\tif (m1.q == m.q)\n\t\treturn 0;\n\n\terr = msr_write(msr, &m1);\n\tif (err)\n\t\treturn err;\n\n\treturn 1;\n}\n\n \nint msr_set_bit(u32 msr, u8 bit)\n{\n\treturn __flip_bit(msr, bit, true);\n}\n\n \nint msr_clear_bit(u32 msr, u8 bit)\n{\n\treturn __flip_bit(msr, bit, false);\n}\n\n#ifdef CONFIG_TRACEPOINTS\nvoid do_trace_write_msr(unsigned int msr, u64 val, int failed)\n{\n\ttrace_write_msr(msr, val, failed);\n}\nEXPORT_SYMBOL(do_trace_write_msr);\nEXPORT_TRACEPOINT_SYMBOL(write_msr);\n\nvoid do_trace_read_msr(unsigned int msr, u64 val, int failed)\n{\n\ttrace_read_msr(msr, val, failed);\n}\nEXPORT_SYMBOL(do_trace_read_msr);\nEXPORT_TRACEPOINT_SYMBOL(read_msr);\n\nvoid do_trace_rdpmc(unsigned counter, u64 val, int failed)\n{\n\ttrace_rdpmc(counter, val, failed);\n}\nEXPORT_SYMBOL(do_trace_rdpmc);\nEXPORT_TRACEPOINT_SYMBOL(rdpmc);\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}