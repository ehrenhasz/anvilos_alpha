{
  "module_name": "futex.h",
  "hash_id": "8ec358c88c9e3a1f2e948a638899cdf37b9310d43f153f4009d403c4d0212c89",
  "original_prompt": "Ingested from linux-6.6.14/arch/x86/include/asm/futex.h",
  "human_readable_source": " \n#ifndef _ASM_X86_FUTEX_H\n#define _ASM_X86_FUTEX_H\n\n#ifdef __KERNEL__\n\n#include <linux/futex.h>\n#include <linux/uaccess.h>\n\n#include <asm/asm.h>\n#include <asm/errno.h>\n#include <asm/processor.h>\n#include <asm/smap.h>\n\n#define unsafe_atomic_op1(insn, oval, uaddr, oparg, label)\t\\\ndo {\t\t\t\t\t\t\t\t\\\n\tint oldval = 0, ret;\t\t\t\t\t\\\n\tasm volatile(\"1:\\t\" insn \"\\n\"\t\t\t\t\\\n\t\t     \"2:\\n\"\t\t\t\t\t\\\n\t\t     _ASM_EXTABLE_TYPE_REG(1b, 2b, EX_TYPE_EFAULT_REG, %1) \\\n\t\t     : \"=r\" (oldval), \"=r\" (ret), \"+m\" (*uaddr)\t\\\n\t\t     : \"0\" (oparg), \"1\" (0));\t\\\n\tif (ret)\t\t\t\t\t\t\\\n\t\tgoto label;\t\t\t\t\t\\\n\t*oval = oldval;\t\t\t\t\t\t\\\n} while(0)\n\n\n#define unsafe_atomic_op2(insn, oval, uaddr, oparg, label)\t\\\ndo {\t\t\t\t\t\t\t\t\\\n\tint oldval = 0, ret, tem;\t\t\t\t\\\n\tasm volatile(\"1:\\tmovl\t%2, %0\\n\"\t\t\t\\\n\t\t     \"2:\\tmovl\\t%0, %3\\n\"\t\t\t\\\n\t\t     \"\\t\" insn \"\\n\"\t\t\t\t\\\n\t\t     \"3:\\t\" LOCK_PREFIX \"cmpxchgl %3, %2\\n\"\t\\\n\t\t     \"\\tjnz\\t2b\\n\"\t\t\t\t\\\n\t\t     \"4:\\n\"\t\t\t\t\t\\\n\t\t     _ASM_EXTABLE_TYPE_REG(1b, 4b, EX_TYPE_EFAULT_REG, %1) \\\n\t\t     _ASM_EXTABLE_TYPE_REG(3b, 4b, EX_TYPE_EFAULT_REG, %1) \\\n\t\t     : \"=&a\" (oldval), \"=&r\" (ret),\t\t\\\n\t\t       \"+m\" (*uaddr), \"=&r\" (tem)\t\t\\\n\t\t     : \"r\" (oparg), \"1\" (0));\t\t\t\\\n\tif (ret)\t\t\t\t\t\t\\\n\t\tgoto label;\t\t\t\t\t\\\n\t*oval = oldval;\t\t\t\t\t\t\\\n} while(0)\n\nstatic __always_inline int arch_futex_atomic_op_inuser(int op, int oparg, int *oval,\n\t\tu32 __user *uaddr)\n{\n\tif (!user_access_begin(uaddr, sizeof(u32)))\n\t\treturn -EFAULT;\n\n\tswitch (op) {\n\tcase FUTEX_OP_SET:\n\t\tunsafe_atomic_op1(\"xchgl %0, %2\", oval, uaddr, oparg, Efault);\n\t\tbreak;\n\tcase FUTEX_OP_ADD:\n\t\tunsafe_atomic_op1(LOCK_PREFIX \"xaddl %0, %2\", oval,\n\t\t\t\t   uaddr, oparg, Efault);\n\t\tbreak;\n\tcase FUTEX_OP_OR:\n\t\tunsafe_atomic_op2(\"orl %4, %3\", oval, uaddr, oparg, Efault);\n\t\tbreak;\n\tcase FUTEX_OP_ANDN:\n\t\tunsafe_atomic_op2(\"andl %4, %3\", oval, uaddr, ~oparg, Efault);\n\t\tbreak;\n\tcase FUTEX_OP_XOR:\n\t\tunsafe_atomic_op2(\"xorl %4, %3\", oval, uaddr, oparg, Efault);\n\t\tbreak;\n\tdefault:\n\t\tuser_access_end();\n\t\treturn -ENOSYS;\n\t}\n\tuser_access_end();\n\treturn 0;\nEfault:\n\tuser_access_end();\n\treturn -EFAULT;\n}\n\nstatic inline int futex_atomic_cmpxchg_inatomic(u32 *uval, u32 __user *uaddr,\n\t\t\t\t\t\tu32 oldval, u32 newval)\n{\n\tint ret = 0;\n\n\tif (!user_access_begin(uaddr, sizeof(u32)))\n\t\treturn -EFAULT;\n\tasm volatile(\"\\n\"\n\t\t\"1:\\t\" LOCK_PREFIX \"cmpxchgl %3, %2\\n\"\n\t\t\"2:\\n\"\n\t\t_ASM_EXTABLE_TYPE_REG(1b, 2b, EX_TYPE_EFAULT_REG, %0) \\\n\t\t: \"+r\" (ret), \"=a\" (oldval), \"+m\" (*uaddr)\n\t\t: \"r\" (newval), \"1\" (oldval)\n\t\t: \"memory\"\n\t);\n\tuser_access_end();\n\t*uval = oldval;\n\treturn ret;\n}\n\n#endif\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}