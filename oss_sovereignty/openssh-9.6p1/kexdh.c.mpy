{
  "module_name": "kexdh.c",
  "hash_id": "552aef12993ddd2681de64a86e03c30ac08159448deaed3ef463c4d4678a6eee",
  "original_prompt": "Ingested from openssh-9.6p1/kexdh.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#ifdef WITH_OPENSSL\n\n#include <sys/types.h>\n\n#include <stdio.h>\n#include <string.h>\n#include <signal.h>\n\n#include \"openbsd-compat/openssl-compat.h\"\n#include <openssl/dh.h>\n\n#include \"sshkey.h\"\n#include \"kex.h\"\n#include \"sshbuf.h\"\n#include \"digest.h\"\n#include \"ssherr.h\"\n#include \"dh.h\"\n#include \"log.h\"\n\nint\nkex_dh_keygen(struct kex *kex)\n{\n\tswitch (kex->kex_type) {\n\tcase KEX_DH_GRP1_SHA1:\n\t\tkex->dh = dh_new_group1();\n\t\tbreak;\n\tcase KEX_DH_GRP14_SHA1:\n\tcase KEX_DH_GRP14_SHA256:\n\t\tkex->dh = dh_new_group14();\n\t\tbreak;\n\tcase KEX_DH_GRP16_SHA512:\n\t\tkex->dh = dh_new_group16();\n\t\tbreak;\n\tcase KEX_DH_GRP18_SHA512:\n\t\tkex->dh = dh_new_group18();\n\t\tbreak;\n\tdefault:\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\t}\n\tif (kex->dh == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\treturn (dh_gen_key(kex->dh, kex->we_need * 8));\n}\n\nint\nkex_dh_compute_key(struct kex *kex, BIGNUM *dh_pub, struct sshbuf *out)\n{\n\tBIGNUM *shared_secret = NULL;\n\tu_char *kbuf = NULL;\n\tsize_t klen = 0;\n\tint kout, r;\n\n#ifdef DEBUG_KEXDH\n\tfprintf(stderr, \"dh_pub= \");\n\tBN_print_fp(stderr, dh_pub);\n\tfprintf(stderr, \"\\n\");\n\tdebug(\"bits %d\", BN_num_bits(dh_pub));\n\tDHparams_print_fp(stderr, kex->dh);\n\tfprintf(stderr, \"\\n\");\n#endif\n\n\tif (!dh_pub_is_valid(kex->dh, dh_pub)) {\n\t\tr = SSH_ERR_MESSAGE_INCOMPLETE;\n\t\tgoto out;\n\t}\n\tklen = DH_size(kex->dh);\n\tif ((kbuf = malloc(klen)) == NULL ||\n\t    (shared_secret = BN_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((kout = DH_compute_key(kbuf, dh_pub, kex->dh)) < 0 ||\n\t    BN_bin2bn(kbuf, kout, shared_secret) == NULL) {\n\t\tr = SSH_ERR_LIBCRYPTO_ERROR;\n\t\tgoto out;\n\t}\n#ifdef DEBUG_KEXDH\n\tdump_digest(\"shared secret\", kbuf, kout);\n#endif\n\tr = sshbuf_put_bignum2(out, shared_secret);\n out:\n\tfreezero(kbuf, klen);\n\tBN_clear_free(shared_secret);\n\treturn r;\n}\n\nint\nkex_dh_keypair(struct kex *kex)\n{\n\tconst BIGNUM *pub_key;\n\tstruct sshbuf *buf = NULL;\n\tint r;\n\n\tif ((r = kex_dh_keygen(kex)) != 0)\n\t\treturn r;\n\tDH_get0_key(kex->dh, &pub_key, NULL);\n\tif ((buf = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_put_bignum2(buf, pub_key)) != 0 ||\n\t    (r = sshbuf_get_u32(buf, NULL)) != 0)\n\t\tgoto out;\n#ifdef DEBUG_KEXDH\n\tDHparams_print_fp(stderr, kex->dh);\n\tfprintf(stderr, \"pub= \");\n\tBN_print_fp(stderr, pub_key);\n\tfprintf(stderr, \"\\n\");\n#endif\n\tkex->client_pub = buf;\n\tbuf = NULL;\n out:\n\tsshbuf_free(buf);\n\treturn r;\n}\n\nint\nkex_dh_enc(struct kex *kex, const struct sshbuf *client_blob,\n    struct sshbuf **server_blobp, struct sshbuf **shared_secretp)\n{\n\tconst BIGNUM *pub_key;\n\tstruct sshbuf *server_blob = NULL;\n\tint r;\n\n\t*server_blobp = NULL;\n\t*shared_secretp = NULL;\n\n\tif ((r = kex_dh_keygen(kex)) != 0)\n\t\tgoto out;\n\tDH_get0_key(kex->dh, &pub_key, NULL);\n\tif ((server_blob = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = sshbuf_put_bignum2(server_blob, pub_key)) != 0 ||\n\t    (r = sshbuf_get_u32(server_blob, NULL)) != 0)\n\t\tgoto out;\n\tif ((r = kex_dh_dec(kex, client_blob, shared_secretp)) != 0)\n\t\tgoto out;\n\t*server_blobp = server_blob;\n\tserver_blob = NULL;\n out:\n\tDH_free(kex->dh);\n\tkex->dh = NULL;\n\tsshbuf_free(server_blob);\n\treturn r;\n}\n\nint\nkex_dh_dec(struct kex *kex, const struct sshbuf *dh_blob,\n    struct sshbuf **shared_secretp)\n{\n\tstruct sshbuf *buf = NULL;\n\tBIGNUM *dh_pub = NULL;\n\tint r;\n\n\t*shared_secretp = NULL;\n\n\tif ((buf = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = sshbuf_put_stringb(buf, dh_blob)) != 0 ||\n\t    (r = sshbuf_get_bignum2(buf, &dh_pub)) != 0)\n\t\tgoto out;\n\tsshbuf_reset(buf);\n\tif ((r = kex_dh_compute_key(kex, dh_pub, buf)) != 0)\n\t\tgoto out;\n\t*shared_secretp = buf;\n\tbuf = NULL;\n out:\n\tBN_free(dh_pub);\n\tDH_free(kex->dh);\n\tkex->dh = NULL;\n\tsshbuf_free(buf);\n\treturn r;\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}