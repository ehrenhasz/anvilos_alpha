{
  "module_name": "auth-rhosts.c",
  "hash_id": "0c2b34c3691e983dc9970131ad6db016296c930d9a651f6da9259b973f5d0948",
  "original_prompt": "Ingested from openssh-9.6p1/auth-rhosts.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <sys/stat.h>\n\n#include <errno.h>\n#include <fcntl.h>\n#ifdef HAVE_NETGROUP_H\n# include <netgroup.h>\n#endif\n#include <pwd.h>\n#include <stdio.h>\n#include <string.h>\n#include <stdarg.h>\n#include <stdlib.h>\n#include <unistd.h>\n\n#include \"packet.h\"\n#include \"uidswap.h\"\n#include \"pathnames.h\"\n#include \"log.h\"\n#include \"misc.h\"\n#include \"xmalloc.h\"\n#include \"sshbuf.h\"\n#include \"sshkey.h\"\n#include \"servconf.h\"\n#include \"canohost.h\"\n#include \"hostfile.h\"\n#include \"auth.h\"\n\n \nextern ServerOptions options;\nextern int use_privsep;\n\n \n\nstatic int\ncheck_rhosts_file(const char *filename, const char *hostname,\n\t\t  const char *ipaddr, const char *client_user,\n\t\t  const char *server_user)\n{\n\tFILE *f;\n#define RBUFLN 1024\n\tchar buf[RBUFLN]; \n\tint fd;\n\tstruct stat st;\n\n\t \n\tif ((fd = open(filename, O_RDONLY|O_NONBLOCK)) == -1)\n\t\treturn 0;\n\tif (fstat(fd, &st) == -1) {\n\t\tclose(fd);\n\t\treturn 0;\n\t}\n\tif (!S_ISREG(st.st_mode)) {\n\t\tlogit(\"User %s hosts file %s is not a regular file\",\n\t\t    server_user, filename);\n\t\tclose(fd);\n\t\treturn 0;\n\t}\n\tunset_nonblock(fd);\n\tif ((f = fdopen(fd, \"r\")) == NULL) {\n\t\tclose(fd);\n\t\treturn 0;\n\t}\n\twhile (fgets(buf, sizeof(buf), f)) {\n\t\t \n\t\tchar hostbuf[RBUFLN], userbuf[RBUFLN], dummy[RBUFLN];\n\t\tchar *host, *user, *cp;\n\t\tint negated;\n\n\t\tfor (cp = buf; *cp == ' ' || *cp == '\\t'; cp++)\n\t\t\t;\n\t\tif (*cp == '#' || *cp == '\\n' || !*cp)\n\t\t\tcontinue;\n\n\t\t \n\t\tif (strncmp(cp, \"NO_PLUS\", 7) == 0)\n\t\t\tcontinue;\n\n\t\t \n\t\tswitch (sscanf(buf, \"%1023s %1023s %1023s\", hostbuf, userbuf,\n\t\t    dummy)) {\n\t\tcase 0:\n\t\t\tauth_debug_add(\"Found empty line in %.100s.\", filename);\n\t\t\tcontinue;\n\t\tcase 1:\n\t\t\t \n\t\t\tstrlcpy(userbuf, server_user, sizeof(userbuf));\n\t\t\tbreak;\n\t\tcase 2:\n\t\t\t \n\t\t\tbreak;\n\t\tcase 3:\n\t\t\tauth_debug_add(\"Found garbage in %.100s.\", filename);\n\t\t\tcontinue;\n\t\tdefault:\n\t\t\t \n\t\t\tcontinue;\n\t\t}\n\n\t\thost = hostbuf;\n\t\tuser = userbuf;\n\t\tnegated = 0;\n\n\t\t \n\t\tif (host[0] == '-') {\n\t\t\tnegated = 1;\n\t\t\thost++;\n\t\t} else if (host[0] == '+')\n\t\t\thost++;\n\n\t\tif (user[0] == '-') {\n\t\t\tnegated = 1;\n\t\t\tuser++;\n\t\t} else if (user[0] == '+')\n\t\t\tuser++;\n\n\t\t \n\t\tif (!host[0] || !user[0]) {\n\t\t\t \n\t\t\tauth_debug_add(\"Ignoring wild host/user names \"\n\t\t\t    \"in %.100s.\", filename);\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\tif (host[0] == '@') {\n\t\t\tif (!innetgr(host + 1, hostname, NULL, NULL) &&\n\t\t\t    !innetgr(host + 1, ipaddr, NULL, NULL))\n\t\t\t\tcontinue;\n\t\t} else if (strcasecmp(host, hostname) &&\n\t\t    strcmp(host, ipaddr) != 0)\n\t\t\tcontinue;\t \n\n\t\t \n\t\tif (user[0] == '@') {\n\t\t\tif (!innetgr(user + 1, NULL, client_user, NULL))\n\t\t\t\tcontinue;\n\t\t} else if (strcmp(user, client_user) != 0)\n\t\t\tcontinue;\t \n\n\t\t \n\t\tfclose(f);\n\n\t\t \n\t\tif (negated) {\n\t\t\tauth_debug_add(\"Matched negative entry in %.100s.\",\n\t\t\t    filename);\n\t\t\treturn 0;\n\t\t}\n\t\t \n\t\treturn 1;\n\t}\n\n\t \n\tfclose(f);\n\treturn 0;\n}\n\n \nint\nauth_rhosts2(struct passwd *pw, const char *client_user, const char *hostname,\n    const char *ipaddr)\n{\n\tchar *path = NULL;\n\tstruct stat st;\n\tstatic const char * const rhosts_files[] = {\".shosts\", \".rhosts\", NULL};\n\tu_int rhosts_file_index;\n\tint r;\n\n\tdebug2_f(\"clientuser %s hostname %s ipaddr %s\",\n\t    client_user, hostname, ipaddr);\n\n\t \n\ttemporarily_use_uid(pw);\n\t \n\tfor (rhosts_file_index = 0; rhosts_files[rhosts_file_index];\n\t    rhosts_file_index++) {\n\t\t \n\t\txasprintf(&path, \"%s/%s\",\n\t\t    pw->pw_dir, rhosts_files[rhosts_file_index]);\n\t\tr = stat(path, &st);\n\t\tfree(path);\n\t\tif (r >= 0)\n\t\t\tbreak;\n\t}\n\t \n\trestore_uid();\n\n\t \n\tif (!rhosts_files[rhosts_file_index] &&\n\t    stat(_PATH_RHOSTS_EQUIV, &st) == -1 &&\n\t    stat(_PATH_SSH_HOSTS_EQUIV, &st) == -1) {\n\t\tdebug3_f(\"no hosts access files exist\");\n\t\treturn 0;\n\t}\n\n\t \n\tif (pw->pw_uid == 0)\n\t\tdebug3_f(\"root user, ignoring system hosts files\");\n\telse {\n\t\tif (check_rhosts_file(_PATH_RHOSTS_EQUIV, hostname, ipaddr,\n\t\t    client_user, pw->pw_name)) {\n\t\t\tauth_debug_add(\"Accepted for %.100s [%.100s] by \"\n\t\t\t    \"/etc/hosts.equiv.\", hostname, ipaddr);\n\t\t\treturn 1;\n\t\t}\n\t\tif (check_rhosts_file(_PATH_SSH_HOSTS_EQUIV, hostname, ipaddr,\n\t\t    client_user, pw->pw_name)) {\n\t\t\tauth_debug_add(\"Accepted for %.100s [%.100s] by \"\n\t\t\t    \"%.100s.\", hostname, ipaddr, _PATH_SSH_HOSTS_EQUIV);\n\t\t\treturn 1;\n\t\t}\n\t}\n\n\t \n\tif (stat(pw->pw_dir, &st) == -1) {\n\t\tlogit(\"Rhosts authentication refused for %.100s: \"\n\t\t    \"no home directory %.200s\", pw->pw_name, pw->pw_dir);\n\t\tauth_debug_add(\"Rhosts authentication refused for %.100s: \"\n\t\t    \"no home directory %.200s\", pw->pw_name, pw->pw_dir);\n\t\treturn 0;\n\t}\n\tif (options.strict_modes &&\n\t    ((st.st_uid != 0 && st.st_uid != pw->pw_uid) ||\n\t    (st.st_mode & 022) != 0)) {\n\t\tlogit(\"Rhosts authentication refused for %.100s: \"\n\t\t    \"bad ownership or modes for home directory.\", pw->pw_name);\n\t\tauth_debug_add(\"Rhosts authentication refused for %.100s: \"\n\t\t    \"bad ownership or modes for home directory.\", pw->pw_name);\n\t\treturn 0;\n\t}\n\t \n\ttemporarily_use_uid(pw);\n\n\t \n\tfor (rhosts_file_index = 0; rhosts_files[rhosts_file_index];\n\t    rhosts_file_index++) {\n\t\t \n\t\txasprintf(&path, \"%s/%s\",\n\t\t    pw->pw_dir, rhosts_files[rhosts_file_index]);\n\t\tif (stat(path, &st) == -1) {\n\t\t\tdebug3_f(\"stat %s: %s\", path, strerror(errno));\n\t\t\tfree(path);\n\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif (options.strict_modes &&\n\t\t    ((st.st_uid != 0 && st.st_uid != pw->pw_uid) ||\n\t\t    (st.st_mode & 022) != 0)) {\n\t\t\tlogit(\"Rhosts authentication refused for %.100s: \"\n\t\t\t    \"bad modes for %.200s\", pw->pw_name, path);\n\t\t\tauth_debug_add(\"Bad file modes for %.200s\", path);\n\t\t\tfree(path);\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\tif (options.ignore_rhosts == IGNORE_RHOSTS_YES ||\n\t\t    (options.ignore_rhosts == IGNORE_RHOSTS_SHOSTS &&\n\t\t    strcmp(rhosts_files[rhosts_file_index], \".shosts\") != 0)) {\n\t\t\tauth_debug_add(\"Server has been configured to \"\n\t\t\t    \"ignore %.100s.\", rhosts_files[rhosts_file_index]);\n\t\t\tfree(path);\n\t\t\tcontinue;\n\t\t}\n\t\t \n\t\tif (check_rhosts_file(path, hostname, ipaddr,\n\t\t    client_user, pw->pw_name)) {\n\t\t\tauth_debug_add(\"Accepted by %.100s.\",\n\t\t\t    rhosts_files[rhosts_file_index]);\n\t\t\t \n\t\t\trestore_uid();\n\t\t\tauth_debug_add(\"Accepted host %s ip %s client_user \"\n\t\t\t    \"%s server_user %s\", hostname, ipaddr,\n\t\t\t    client_user, pw->pw_name);\n\t\t\tfree(path);\n\t\t\treturn 1;\n\t\t}\n\t\tfree(path);\n\t}\n\n\t \n\trestore_uid();\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}