{
  "module_name": "digest-openssl.c",
  "hash_id": "cea9a38bae632b064ce800da2bfcac1692ebb455341b0ecf16833d8fc7b26fa6",
  "original_prompt": "Ingested from openssh-9.6p1/digest-openssl.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#ifdef WITH_OPENSSL\n\n#include <sys/types.h>\n#include <limits.h>\n#include <stdlib.h>\n#include <string.h>\n\n#include <openssl/evp.h>\n\n#include \"openbsd-compat/openssl-compat.h\"\n\n#include \"sshbuf.h\"\n#include \"digest.h\"\n#include \"ssherr.h\"\n\n#ifndef HAVE_EVP_SHA256\n# define EVP_sha256 NULL\n#endif\n#ifndef HAVE_EVP_SHA384\n# define EVP_sha384 NULL\n#endif\n#ifndef HAVE_EVP_SHA512\n# define EVP_sha512 NULL\n#endif\n\nstruct ssh_digest_ctx {\n\tint alg;\n\tEVP_MD_CTX *mdctx;\n};\n\nstruct ssh_digest {\n\tint id;\n\tconst char *name;\n\tsize_t digest_len;\n\tconst EVP_MD *(*mdfunc)(void);\n};\n\n \nconst struct ssh_digest digests[] = {\n\t{ SSH_DIGEST_MD5,\t\"MD5\",\t\t16,\tEVP_md5 },\n\t{ SSH_DIGEST_SHA1,\t\"SHA1\",\t\t20,\tEVP_sha1 },\n\t{ SSH_DIGEST_SHA256,\t\"SHA256\",\t32,\tEVP_sha256 },\n\t{ SSH_DIGEST_SHA384,\t\"SHA384\",\t48,\tEVP_sha384 },\n\t{ SSH_DIGEST_SHA512,\t\"SHA512\",\t64,\tEVP_sha512 },\n\t{ -1,\t\t\tNULL,\t\t0,\tNULL },\n};\n\nstatic const struct ssh_digest *\nssh_digest_by_alg(int alg)\n{\n\tif (alg < 0 || alg >= SSH_DIGEST_MAX)\n\t\treturn NULL;\n\tif (digests[alg].id != alg)  \n\t\treturn NULL;\n\tif (digests[alg].mdfunc == NULL)\n\t\treturn NULL;\n\treturn &(digests[alg]);\n}\n\nint\nssh_digest_alg_by_name(const char *name)\n{\n\tint alg;\n\n\tfor (alg = 0; digests[alg].id != -1; alg++) {\n\t\tif (strcasecmp(name, digests[alg].name) == 0)\n\t\t\treturn digests[alg].id;\n\t}\n\treturn -1;\n}\n\nconst char *\nssh_digest_alg_name(int alg)\n{\n\tconst struct ssh_digest *digest = ssh_digest_by_alg(alg);\n\n\treturn digest == NULL ? NULL : digest->name;\n}\n\nsize_t\nssh_digest_bytes(int alg)\n{\n\tconst struct ssh_digest *digest = ssh_digest_by_alg(alg);\n\n\treturn digest == NULL ? 0 : digest->digest_len;\n}\n\nsize_t\nssh_digest_blocksize(struct ssh_digest_ctx *ctx)\n{\n\treturn EVP_MD_CTX_block_size(ctx->mdctx);\n}\n\nstruct ssh_digest_ctx *\nssh_digest_start(int alg)\n{\n\tconst struct ssh_digest *digest = ssh_digest_by_alg(alg);\n\tstruct ssh_digest_ctx *ret;\n\n\tif (digest == NULL || ((ret = calloc(1, sizeof(*ret))) == NULL))\n\t\treturn NULL;\n\tret->alg = alg;\n\tif ((ret->mdctx = EVP_MD_CTX_new()) == NULL) {\n\t\tfree(ret);\n\t\treturn NULL;\n\t}\n\tif (EVP_DigestInit_ex(ret->mdctx, digest->mdfunc(), NULL) != 1) {\n\t\tssh_digest_free(ret);\n\t\treturn NULL;\n\t}\n\treturn ret;\n}\n\nint\nssh_digest_copy_state(struct ssh_digest_ctx *from, struct ssh_digest_ctx *to)\n{\n\tif (from->alg != to->alg)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\t \n\tif (!EVP_MD_CTX_copy_ex(to->mdctx, from->mdctx))\n\t\treturn SSH_ERR_LIBCRYPTO_ERROR;\n\treturn 0;\n}\n\nint\nssh_digest_update(struct ssh_digest_ctx *ctx, const void *m, size_t mlen)\n{\n\tif (EVP_DigestUpdate(ctx->mdctx, m, mlen) != 1)\n\t\treturn SSH_ERR_LIBCRYPTO_ERROR;\n\treturn 0;\n}\n\nint\nssh_digest_update_buffer(struct ssh_digest_ctx *ctx, const struct sshbuf *b)\n{\n\treturn ssh_digest_update(ctx, sshbuf_ptr(b), sshbuf_len(b));\n}\n\nint\nssh_digest_final(struct ssh_digest_ctx *ctx, u_char *d, size_t dlen)\n{\n\tconst struct ssh_digest *digest = ssh_digest_by_alg(ctx->alg);\n\tu_int l = dlen;\n\n\tif (digest == NULL || dlen > UINT_MAX)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tif (dlen < digest->digest_len)  \n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tif (EVP_DigestFinal_ex(ctx->mdctx, d, &l) != 1)\n\t\treturn SSH_ERR_LIBCRYPTO_ERROR;\n\tif (l != digest->digest_len)  \n\t\treturn SSH_ERR_INTERNAL_ERROR;\n\treturn 0;\n}\n\nvoid\nssh_digest_free(struct ssh_digest_ctx *ctx)\n{\n\tif (ctx == NULL)\n\t\treturn;\n\tEVP_MD_CTX_free(ctx->mdctx);\n\tfreezero(ctx, sizeof(*ctx));\n}\n\nint\nssh_digest_memory(int alg, const void *m, size_t mlen, u_char *d, size_t dlen)\n{\n\tconst struct ssh_digest *digest = ssh_digest_by_alg(alg);\n\tu_int mdlen;\n\n\tif (digest == NULL)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tif (dlen > UINT_MAX)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tif (dlen < digest->digest_len)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tmdlen = dlen;\n\tif (!EVP_Digest(m, mlen, d, &mdlen, digest->mdfunc(), NULL))\n\t\treturn SSH_ERR_LIBCRYPTO_ERROR;\n\treturn 0;\n}\n\nint\nssh_digest_buffer(int alg, const struct sshbuf *b, u_char *d, size_t dlen)\n{\n\treturn ssh_digest_memory(alg, sshbuf_ptr(b), sshbuf_len(b), d, dlen);\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}