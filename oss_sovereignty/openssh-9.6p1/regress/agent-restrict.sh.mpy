{
  "module_name": "agent-restrict.sh",
  "hash_id": "6cb90862c26c5089d167136a34204db9481da5b5e1968b3d7e860a9e537dbbcd",
  "original_prompt": "Ingested from openssh-9.6p1/regress/agent-restrict.sh",
  "human_readable_source": "#\t$OpenBSD: agent-restrict.sh,v 1.6 2023/03/01 09:29:32 dtucker Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"agent restrictions\"\n\nSSH_AUTH_SOCK=\"$OBJ/agent.sock\"\nexport SSH_AUTH_SOCK\nrm -f $SSH_AUTH_SOCK $OBJ/agent.log $OBJ/host_[abcdex]* $OBJ/user_[abcdex]*\nrm -f $OBJ/sshd_proxy_host* $OBJ/ssh_output* $OBJ/expect_*\nrm -f $OBJ/ssh_proxy[._]* $OBJ/command\n\nverbose \"generate keys\"\nfor h in a b c d e x ca ; do\n\t$SSHKEYGEN -q -t ed25519 -C host_$h -N '' -f $OBJ/host_$h || \\\n\t\tfatal \"ssh-keygen hostkey failed\"\n\t$SSHKEYGEN -q -t ed25519 -C user_$h -N '' -f $OBJ/user_$h || \\\n\t\tfatal \"ssh-keygen userkey failed\"\ndone\n\n# Make some hostcerts\nfor h in d e ; do\n\tid=\"host_$h\"\n\t$SSHKEYGEN -q -s $OBJ/host_ca -I $id -n $id -h $OBJ/host_${h}.pub || \\\n\t\tfatal \"ssh-keygen certify failed\"\ndone\n\nverbose \"prepare client config\"\negrep -vi '(identityfile|hostname|hostkeyalias|proxycommand)' \\\n\t$OBJ/ssh_proxy > $OBJ/ssh_proxy.bak\ncat << _EOF > $OBJ/ssh_proxy\nIdentitiesOnly yes\nForwardAgent yes\nExitOnForwardFailure yes\n_EOF\ncp $OBJ/ssh_proxy $OBJ/ssh_proxy_noid\nfor h in a b c d e ; do\n\tcat << _EOF >> $OBJ/ssh_proxy\nHost host_$h\n\tHostname host_$h\n\tHostkeyAlias host_$h\n\tIdentityFile $OBJ/user_$h\n\tProxyCommand ${SUDO} env SSH_SK_HELPER=\\\"$SSH_SK_HELPER\\\" ${OBJ}/sshd-log-wrapper.sh -i -f $OBJ/sshd_proxy_host_$h\n_EOF\n\t# Variant with no specified keys.\n\tcat << _EOF >> $OBJ/ssh_proxy_noid\nHost host_$h\n\tHostname host_$h\n\tHostkeyAlias host_$h\n\tProxyCommand ${SUDO} env SSH_SK_HELPER=\\\"$SSH_SK_HELPER\\\" ${OBJ}/sshd-log-wrapper.sh -i -f $OBJ/sshd_proxy_host_$h\n_EOF\ndone\ncat $OBJ/ssh_proxy.bak >> $OBJ/ssh_proxy\ncat $OBJ/ssh_proxy.bak >> $OBJ/ssh_proxy_noid\n\nLC_ALL=C\nexport LC_ALL\necho \"SetEnv LC_ALL=${LC_ALL}\" >> sshd_proxy\n\nverbose \"prepare known_hosts\"\nrm -f $OBJ/known_hosts\nfor h in a b c x ; do\n\t(printf \"host_$h \" ; cat $OBJ/host_${h}.pub) >> $OBJ/known_hosts\ndone\n(printf \"@cert-authority host_* \" ; cat $OBJ/host_ca.pub) >> $OBJ/known_hosts\n\nverbose \"prepare server configs\"\negrep -vi '(hostkey|pidfile)' $OBJ/sshd_proxy \\\n\t> $OBJ/sshd_proxy.bak\nfor h in a b c d e; do\n\tcp $OBJ/sshd_proxy.bak $OBJ/sshd_proxy_host_$h\n\tcat << _EOF >> $OBJ/sshd_proxy_host_$h\nExposeAuthInfo yes\nPidFile none\nHostkey $OBJ/host_$h\n_EOF\ndone\nfor h in d e ; do\n\techo \"HostCertificate $OBJ/host_${h}-cert.pub\" \\\n\t\t>> $OBJ/sshd_proxy_host_$h\ndone\n# Create authorized_keys with canned command.\nreset_keys() {\n\t_whichcmd=\"$1\"\n\t_command=\"\"\n\tcase \"$_whichcmd\" in\n\tauthinfo)\t_command=\"cat \\$SSH_USER_AUTH\" ;;\n\tkeylist)\t\t_command=\"$SSHADD -L | cut -d' ' -f-2 | sort\" ;;\n\t*)\t\tfatal \"unsupported command $_whichcmd\" ;;\n\tesac\n\ttrace \"reset keys\"\n\t>$OBJ/authorized_keys_$USER\n\tfor h in e d c b a; do\n\t\t(printf \"%s\" \"restrict,agent-forwarding,command=\\\"$_command\\\" \";\n\t\t cat $OBJ/user_$h.pub) >> $OBJ/authorized_keys_$USER\n\tdone\n}\n# Prepare a key for comparison with ExposeAuthInfo/$SSH_USER_AUTH.\nexpect_key() {\n\t_key=\"$OBJ/${1}.pub\"\n\t_file=\"$OBJ/$2\"\n\t(printf \"publickey \" ; cut -d' ' -f-2 $_key) > $_file\n}\n# Prepare expect_* files to compare against authinfo forced command to ensure\n# keys used for authentication match.\nreset_expect_keys() {\n\tfor u in a b c d e; do\n\t\texpect_key user_$u expect_$u\n\tdone\n}\n# ssh to host, expecting success and that output matched expectation for\n# that host (expect_$h file).\nexpect_succeed() {\n\t_id=\"$1\"\n\t_case=\"$2\"\n\tshift; shift; _extra=\"$@\"\n\t_host=\"host_$_id\"\n\ttrace \"connect $_host expect success\"\n\trm -f $OBJ/ssh_output\n\t${SSH} $_extra -F $OBJ/ssh_proxy $_host true > $OBJ/ssh_output\n\t_s=$?\n\ttest $_s -eq 0 || fail \"host $_host $_case fail, exit status $_s\"\n\tdiff $OBJ/ssh_output $OBJ/expect_${_id} ||\n\t\tfail \"unexpected ssh output\"\n}\n# ssh to host using explicit key, expecting success and that the key was\n# actually used for authentication.\nexpect_succeed_key() {\n\t_id=\"$1\"\n\t_key=\"$2\"\n\t_case=\"$3\"\n\tshift; shift; shift; _extra=\"$@\"\n\t_host=\"host_$_id\"\n\ttrace \"connect $_host expect success, with key $_key\"\n\t_keyfile=\"$OBJ/$_key\"\n\trm -f $OBJ/ssh_output\n\t${SSH} $_extra -F $OBJ/ssh_proxy_noid \\\n\t    -oIdentityFile=$_keyfile $_host true > $OBJ/ssh_output\n\t_s=$?\n\ttest $_s -eq 0 || fail \"host $_host $_key $_case fail, exit status $_s\"\n\texpect_key $_key expect_key\n\tdiff $OBJ/ssh_output $OBJ/expect_key ||\n\t\tfail \"incorrect key used for authentication\"\n}\n# ssh to a host, expecting it to fail.\nexpect_fail() {\n\t_host=\"$1\"\n\t_case=\"$2\"\n\tshift; shift; _extra=\"$@\"\n\ttrace \"connect $_host expect failure\"\n\t${SSH} $_extra -F $OBJ/ssh_proxy $_host true >/dev/null && \\\n\t\tfail \"host $_host $_case succeeded unexpectedly\"\n}\n# ssh to a host using an explicit key, expecting it to fail.\nexpect_fail_key() {\n\t_id=\"$1\"\n\t_key=\"$2\"\n\t_case=\"$3\"\n\tshift; shift; shift; _extra=\"$@\"\n\t_host=\"host_$_id\"\n\ttrace \"connect $_host expect failure, with key $_key\"\n\t_keyfile=\"$OBJ/$_key\"\n\t${SSH} $_extra -F $OBJ/ssh_proxy_noid -oIdentityFile=$_keyfile \\\n\t    $_host true > $OBJ/ssh_output && \\\n\t\tfail \"host $_host $_key $_case succeeded unexpectedly\"\n}\n# Move the private key files out of the way to force use of agent-hosted keys.\nhide_privatekeys() {\n\ttrace \"hide private keys\"\n\tfor u in a b c d e x; do\n\t\tmv $OBJ/user_$u $OBJ/user_x$u || fatal \"hide privkey $u\"\n\tdone\n}\n# Put the private key files back.\nrestore_privatekeys() {\n\ttrace \"restore private keys\"\n\tfor u in a b c d e x; do\n\t\tmv $OBJ/user_x$u $OBJ/user_$u || fatal \"restore privkey $u\"\n\tdone\n}\nclear_agent() {\n\t${SSHADD} -D > /dev/null 2>&1 || fatal \"clear agent failed\"\n}\n\nreset_keys authinfo\nreset_expect_keys\n\nverbose \"authentication w/o agent\"\nfor h in a b c d e ; do\n\texpect_succeed $h \"w/o agent\"\n\twrongkey=user_e\n\ttest \"$h\" = \"e\" && wrongkey=user_a\n\texpect_succeed_key $h $wrongkey \"\\\"wrong\\\" key w/o agent\"\ndone\nhide_privatekeys\nfor h in a b c d e ; do\n\texpect_fail $h \"w/o agent\"\ndone\nrestore_privatekeys\n\nverbose \"start agent\"\n${SSHAGENT} ${EXTRA_AGENT_ARGS} -d -a $SSH_AUTH_SOCK > $OBJ/agent.log 2>&1 &\nAGENT_PID=$!\ntrap \"kill $AGENT_PID\" EXIT\nsleep 4 # Give it a chance to start\n# Check that it's running.\n${SSHADD} -l > /dev/null 2>&1\nif [ $? -ne 1 ]; then\n\tfail \"ssh-add -l did not fail with exit code 1\"\nfi\n\nverbose \"authentication with agent (no restrict)\"\nfor u in a b c d e x; do\n\t$SSHADD -q $OBJ/user_$u || fatal \"add key $u unrestricted\"\ndone\nhide_privatekeys\nfor h in a b c d e ; do\n\texpect_succeed $h \"with agent\"\n\twrongkey=user_e\n\ttest \"$h\" = \"e\" && wrongkey=user_a\n\texpect_succeed_key $h $wrongkey \"\\\"wrong\\\" key with agent\"\ndone\n\nverbose \"unrestricted keylist\"\nreset_keys keylist\nrm -f $OBJ/expect_list.pre\n# List of keys from agent should contain everything.\nfor u in a b c d e x; do\n\tcut -d \" \" -f-2 $OBJ/user_${u}.pub >> $OBJ/expect_list.pre\ndone\nsort $OBJ/expect_list.pre > $OBJ/expect_list\nfor h in a b c d e; do\n\tcp $OBJ/expect_list $OBJ/expect_$h\n\texpect_succeed $h \"unrestricted keylist\"\ndone\nrestore_privatekeys\n\nverbose \"authentication with agent (basic restrict)\"\nreset_keys authinfo\nreset_expect_keys\nfor h in a b c d e; do\n\t$SSHADD -h host_$h -H $OBJ/known_hosts -q $OBJ/user_$h \\\n\t\t|| fatal \"add key $u basic restrict\"\ndone\n# One more, unrestricted\n$SSHADD -q $OBJ/user_x || fatal \"add unrestricted key\"\nhide_privatekeys\n# Authentication to host with expected key should work.\nfor h in a b c d e ; do\n\texpect_succeed $h \"with agent\"\ndone\n# Authentication to host with incorrect key should fail.\nverbose \"authentication with agent incorrect key (basic restrict)\"\nfor h in a b c d e ; do\n\twrongkey=user_e\n\ttest \"$h\" = \"e\" && wrongkey=user_a\n\texpect_fail_key $h $wrongkey \"wrong key with agent (basic restrict)\"\ndone\n\nverbose \"keylist (basic restrict)\"\nreset_keys keylist\n# List from forwarded agent should contain only user_x - the unrestricted key.\ncut -d \" \" -f-2 $OBJ/user_x.pub > $OBJ/expect_list\nfor h in a b c d e; do\n\tcp $OBJ/expect_list $OBJ/expect_$h\n\texpect_succeed $h \"keylist (basic restrict)\"\ndone\nrestore_privatekeys\n\nverbose \"username\"\nreset_keys authinfo\nreset_expect_keys\nfor h in a b c d e; do\n\t$SSHADD -h \"${USER}@host_$h\" -H $OBJ/known_hosts -q $OBJ/user_$h \\\n\t\t|| fatal \"add key $u basic restrict\"\ndone\nhide_privatekeys\nfor h in a b c d e ; do\n\texpect_succeed $h \"wildcard user\"\ndone\nrestore_privatekeys\n\nverbose \"username wildcard\"\nreset_keys authinfo\nreset_expect_keys\nfor h in a b c d e; do\n\t$SSHADD -h \"*@host_$h\" -H $OBJ/known_hosts -q $OBJ/user_$h \\\n\t\t|| fatal \"add key $u basic restrict\"\ndone\nhide_privatekeys\nfor h in a b c d e ; do\n\texpect_succeed $h \"wildcard user\"\ndone\nrestore_privatekeys\n\nverbose \"username incorrect\"\nreset_keys authinfo\nreset_expect_keys\nfor h in a b c d e; do\n\t$SSHADD -h \"--BADUSER@host_$h\" -H $OBJ/known_hosts -q $OBJ/user_$h \\\n\t\t|| fatal \"add key $u basic restrict\"\ndone\nhide_privatekeys\nfor h in a b c d e ; do\n\texpect_fail $h \"incorrect user\"\ndone\nrestore_privatekeys\n\n\nverbose \"agent restriction honours certificate principal\"\nreset_keys authinfo\nreset_expect_keys\nclear_agent\n$SSHADD -h host_e -H $OBJ/known_hosts -q $OBJ/user_d || fatal \"add key\"\nhide_privatekeys\nexpect_fail d \"restricted agent w/ incorrect cert principal\"\nrestore_privatekeys\n\n# Prepares the script used to drive chained ssh connections for the\n# multihop tests. Believe me, this is easier than getting the escaping\n# right for 5 hops on the command-line...\nprepare_multihop_script() {\n\tMULTIHOP_RUN=$OBJ/command\n\tcat << _EOF > $MULTIHOP_RUN\n#!/bin/sh\n#set -x\nme=\"\\$1\" ; shift\nnext=\"\\$1\"\nif test ! -z \"\\$me\" ; then \n\trm -f $OBJ/done\n\techo \"HOSTNAME host_\\$me\"\n\techo \"AUTHINFO\"\n\tcat \\$SSH_USER_AUTH\nfi\necho AGENT\n$SSHADD -L | egrep \"^ssh\" | cut -d\" \" -f-2 | sort\nif test -z \"\\$next\" ; then \n\ttouch $OBJ/done\n\techo \"FINISH\"\n\te=0\nelse\n\techo NEXT\n\t${SSH} -F $OBJ/ssh_proxy_noid -oIdentityFile=$OBJ/user_a \\\n\t\thost_\\$next $MULTIHOP_RUN \"\\$@\"\n\te=\\$?\nfi\necho \"COMPLETE \\\"\\$me\\\"\"\nif test ! -z \"\\$me\" ; then \n\tif test ! -f $OBJ/done ; then\n\t\techo \"DONE MARKER MISSING\"\n\t\ttest \\$e -eq 0 && e=63\n\tfi\nfi\nexit \\$e\n_EOF\n\tchmod u+x $MULTIHOP_RUN\n}\n\n# Prepare expected output for multihop tests at expect_a\nprepare_multihop_expected() {\n\t_keys=\"$1\"\n\t_hops=\"a b c d e\"\n\ttest -z \"$2\" || _hops=\"$2\"\n\t_revhops=$(echo \"$_hops\" | rev)\n\t_lasthop=$(echo \"$_hops\" | sed 's/.* //')\n\n\trm -f $OBJ/expect_keys\n\tfor h in a b c d e; do\n\t\tcut -d\" \" -f-2 $OBJ/user_${h}.pub >> $OBJ/expect_keys\n\tdone\n\trm -f $OBJ/expect_a\n\techo \"AGENT\" >> $OBJ/expect_a\n\ttest \"x$_keys\" = \"xnone\" || sort $OBJ/expect_keys >> $OBJ/expect_a\n\techo \"NEXT\" >> $OBJ/expect_a\n\tfor h in $_hops ; do \n\t\techo \"HOSTNAME host_$h\" >> $OBJ/expect_a\n\t\techo \"AUTHINFO\" >> $OBJ/expect_a\n\t\t(printf \"publickey \" ; cut -d\" \" -f-2 $OBJ/user_a.pub) >> $OBJ/expect_a\n\t\techo \"AGENT\" >> $OBJ/expect_a\n\t\tif test \"x$_keys\" = \"xall\" ; then\n\t\t\tsort $OBJ/expect_keys >> $OBJ/expect_a\n\t\tfi\n\t\tif test \"x$h\" != \"x$_lasthop\" ; then\n\t\t\tif test \"x$_keys\" = \"xfiltered\" ; then\n\t\t\t\tcut -d\" \" -f-2 $OBJ/user_a.pub >> $OBJ/expect_a\n\t\t\tfi\n\t\t\techo \"NEXT\" >> $OBJ/expect_a\n\t\tfi\n\tdone\n\techo \"FINISH\" >> $OBJ/expect_a\n\tfor h in $_revhops \"\" ; do \n\t\techo \"COMPLETE \\\"$h\\\"\" >> $OBJ/expect_a\n\tdone\n}\n\nprepare_multihop_script\ncp $OBJ/user_a.pub $OBJ/authorized_keys_$USER # only one key used.\n\nverbose \"multihop without agent\"\nclear_agent\nprepare_multihop_expected none\n$MULTIHOP_RUN \"\" a b c d e > $OBJ/ssh_output || fail \"multihop no agent ssh failed\"\ndiff $OBJ/ssh_output $OBJ/expect_a || fail \"unexpected ssh output\"\n\nverbose \"multihop agent unrestricted\"\nclear_agent\n$SSHADD -q $OBJ/user_[abcde]\nprepare_multihop_expected all\n$MULTIHOP_RUN \"\" a b c d e > $OBJ/ssh_output || fail \"multihop no agent ssh failed\"\ndiff $OBJ/ssh_output $OBJ/expect_a || fail \"unexpected ssh output\"\n\nverbose \"multihop restricted\"\nclear_agent\nprepare_multihop_expected filtered\n# Add user_a, with permission to connect through the whole chain.\n$SSHADD -h host_a -h \"host_a>host_b\" -h \"host_b>host_c\" \\\n\t-h \"host_c>host_d\" -h \"host_d>host_e\" \\\n\t-H $OBJ/known_hosts -q $OBJ/user_a \\\n\t|| fatal \"add key user_a multihop\"\n# Add the other keys, bound to a unused host.\n$SSHADD -q -h host_x -H $OBJ/known_hosts $OBJ/user_[bcde] || fail \"add keys\"\nhide_privatekeys\n$MULTIHOP_RUN \"\" a b c d e > $OBJ/ssh_output || fail \"multihop ssh failed\"\ndiff $OBJ/ssh_output $OBJ/expect_a || fail \"unexpected ssh output\"\nrestore_privatekeys\n\nverbose \"multihop username\"\n$SSHADD -h host_a -h \"host_a>${USER}@host_b\" -h \"host_b>${USER}@host_c\" \\\n\t-h \"host_c>${USER}@host_d\"  -h \"host_d>${USER}@host_e\" \\\n\t-H $OBJ/known_hosts -q $OBJ/user_a || fatal \"add key user_a multihop\"\nhide_privatekeys\n$MULTIHOP_RUN \"\" a b c d e > $OBJ/ssh_output || fail \"multihop w/ user ssh failed\"\ndiff $OBJ/ssh_output $OBJ/expect_a || fail \"unexpected ssh output\"\nrestore_privatekeys\n\nverbose \"multihop wildcard username\"\n$SSHADD -h host_a -h \"host_a>*@host_b\" -h \"host_b>*@host_c\" \\\n\t-h \"host_c>*@host_d\"  -h \"host_d>*@host_e\" \\\n\t-H $OBJ/known_hosts -q $OBJ/user_a || fatal \"add key user_a multihop\"\nhide_privatekeys\n$MULTIHOP_RUN \"\" a b c d e > $OBJ/ssh_output || fail \"multihop w/ user ssh failed\"\ndiff $OBJ/ssh_output $OBJ/expect_a || fail \"unexpected ssh output\"\nrestore_privatekeys\n\nverbose \"multihop wrong username\"\n$SSHADD -h host_a -h \"host_a>*@host_b\" -h \"host_b>*@host_c\" \\\n\t-h \"host_c>--BADUSER@host_d\"  -h \"host_d>*@host_e\" \\\n\t-H $OBJ/known_hosts -q $OBJ/user_a || fatal \"add key user_a multihop\"\nhide_privatekeys\n$MULTIHOP_RUN \"\" a b c d e > $OBJ/ssh_output && \\\n\tfail \"multihop with wrong user succeeded unexpectedly\"\nrestore_privatekeys\n\nverbose \"multihop cycle no agent\"\nclear_agent\nprepare_multihop_expected none \"a b a a c d e\"\n$MULTIHOP_RUN \"\" a b a a c d e > $OBJ/ssh_output || \\\n\tfail \"multihop cycle no-agent fail\"\ndiff $OBJ/ssh_output $OBJ/expect_a || fail \"unexpected ssh output\"\n\nverbose \"multihop cycle agent unrestricted\"\nclear_agent\n$SSHADD -q $OBJ/user_[abcde] || fail \"add keys\"\nprepare_multihop_expected all \"a b a a c d e\"\n$MULTIHOP_RUN \"\" a b a a c d e > $OBJ/ssh_output || \\\n\tfail \"multihop cycle agent ssh failed\"\ndiff $OBJ/ssh_output $OBJ/expect_a || fail \"unexpected ssh output\"\n\nverbose \"multihop cycle restricted deny\"\nclear_agent\n$SSHADD -q -h host_x -H $OBJ/known_hosts $OBJ/user_[bcde] || fail \"add keys\"\n$SSHADD -h host_a -h \"host_a>host_b\" -h \"host_b>host_c\" \\\n\t-h \"host_c>host_d\" -h \"host_d>host_e\" \\\n\t-H $OBJ/known_hosts -q $OBJ/user_a \\\n\t|| fatal \"add key user_a multihop\"\nprepare_multihop_expected filtered \"a b a a c d e\"\nhide_privatekeys\n$MULTIHOP_RUN \"\" a b a a c d e > $OBJ/ssh_output && \\\n\tfail \"multihop cycle restricted deny succeded unexpectedly\"\nrestore_privatekeys\n\nverbose \"multihop cycle restricted allow\"\nclear_agent\n$SSHADD -q -h host_x -H $OBJ/known_hosts $OBJ/user_[bcde] || fail \"add keys\"\n$SSHADD -h host_a -h \"host_a>host_b\" -h \"host_b>host_c\" \\\n\t-h \"host_c>host_d\" -h \"host_d>host_e\" \\\n\t-h \"host_b>host_a\" -h \"host_a>host_a\" -h \"host_a>host_c\" \\\n\t-H $OBJ/known_hosts -q $OBJ/user_a \\\n\t|| fatal \"add key user_a multihop\"\nprepare_multihop_expected filtered \"a b a a c d e\"\nhide_privatekeys\n$MULTIHOP_RUN \"\" a b a a c d e > $OBJ/ssh_output || \\\n\tfail \"multihop cycle restricted allow failed\"\ndiff $OBJ/ssh_output $OBJ/expect_a || fail \"unexpected ssh output\"\nrestore_privatekeys\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}