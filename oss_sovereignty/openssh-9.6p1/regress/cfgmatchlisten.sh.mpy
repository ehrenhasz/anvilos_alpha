{
  "module_name": "cfgmatchlisten.sh",
  "hash_id": "b9f184254067cd84457b7efc6d53e1a414297329c38c919380664a182516506b",
  "original_prompt": "Ingested from openssh-9.6p1/regress/cfgmatchlisten.sh",
  "human_readable_source": "#\t$OpenBSD: cfgmatchlisten.sh,v 1.3 2018/07/02 14:13:30 dtucker Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"sshd_config matchlisten\"\n\npidfile=$OBJ/remote_pid\nfwdport=3301\nfwdspec=\"localhost:${fwdport}\"\nfwd=\"-R $fwdport:127.0.0.1:$PORT\"\n\necho \"ExitOnForwardFailure=yes\" >> $OBJ/ssh_config\necho \"ExitOnForwardFailure=yes\" >> $OBJ/ssh_proxy\n\nstart_client()\n{\n\trm -f $pidfile\n\t${SSH} -vvv $fwd \"$@\" somehost true >>$TEST_REGRESS_LOGFILE 2>&1\n\tr=$?\n\tif [ $r -ne 0 ]; then\n\t\treturn $r\n\tfi\n\t${SSH} -vvv $fwd \"$@\" somehost \\\n\t    exec sh -c \\'\"echo \\$\\$ > $pidfile; exec sleep 100\"\\' \\\n\t    >>$TEST_REGRESS_LOGFILE 2>&1 &\n\tclient_pid=$!\n\t# Wait for remote end\n\tn=0\n\twhile test ! -f $pidfile ; do\n\t\tsleep 1\n\t\tn=`expr $n + 1`\n\t\tif test $n -gt 60; then\n\t\t\tkill $client_pid\n\t\t\tfatal \"timeout waiting for background ssh\"\n\t\tfi\n\tdone\n\treturn $r\n}\n\nexpect_client_ok()\n{\n\tstart_client \"$@\" ||\n\t    fail \"client did not start\"\n}\n\nexpect_client_fail()\n{\n\tlocal failmsg=\"$1\"\n\tshift\n\tstart_client \"$@\" &&\n\t    fail $failmsg\n}\n\nstop_client()\n{\n\tpid=`cat $pidfile`\n\tif [ ! -z \"$pid\" ]; then\n\t\tkill $pid\n\tfi\n\twait\n}\n\ncp $OBJ/sshd_proxy $OBJ/sshd_proxy_bak\necho \"PermitListen 127.0.0.1:1\" >>$OBJ/sshd_config\necho \"Match Address 127.0.0.1\" >>$OBJ/sshd_config\necho \"PermitListen 127.0.0.1:2 127.0.0.1:3 $fwdspec\" >>$OBJ/sshd_config\n\ngrep -v AuthorizedKeysFile $OBJ/sshd_proxy_bak > $OBJ/sshd_proxy\necho \"AuthorizedKeysFile /dev/null\" >>$OBJ/sshd_proxy\necho \"PermitListen 127.0.0.1:1\" >>$OBJ/sshd_proxy\necho \"Match user $USER\" >>$OBJ/sshd_proxy\necho \"AuthorizedKeysFile /dev/null $OBJ/authorized_keys_%u\" >>$OBJ/sshd_proxy\necho \"Match Address 127.0.0.1\" >>$OBJ/sshd_proxy\necho \"PermitListen 127.0.0.1:2 127.0.0.1:3 $fwdspec\" >>$OBJ/sshd_proxy\n\nstart_sshd\n\n#set -x\n\n# Test Match + PermitListen in sshd_config.  This should be permitted\ntrace \"match permitlisten localhost\"\nexpect_client_ok -F $OBJ/ssh_config\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true || \\\n    fail \"match permitlisten permit\"\nstop_client\n\n# Same but from different source.  This should not be permitted\ntrace \"match permitlisten proxy\"\nexpect_client_fail \"match permitlisten deny\" \\\n    -F $OBJ/ssh_proxy\n\n# Retry previous with key option, should also be denied.\ncp /dev/null $OBJ/authorized_keys_$USER\nfor t in ${SSH_KEYTYPES}; do\n\tprintf 'permitlisten=\"'$fwdspec'\" ' >> $OBJ/authorized_keys_$USER\n\tcat $OBJ/$t.pub >> $OBJ/authorized_keys_$USER\ndone\ntrace \"match permitlisten proxy w/key opts\"\nexpect_client_fail \"match permitlisten deny w/key opt\"\\\n    -F $OBJ/ssh_proxy\n\n# Test both sshd_config and key options permitting the same dst/port pair.\n# Should be permitted.\ntrace \"match permitlisten localhost\"\nexpect_client_ok -F $OBJ/ssh_config\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true || \\\n    fail \"match permitlisten permit\"\nstop_client\n\n# Test that a bare port number is accepted in PermitListen\ncp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\necho \"PermitListen 127.0.0.1:1 $fwdport 127.0.0.2:2\" >>$OBJ/sshd_proxy\ntrace \"match permitlisten bare\"\nexpect_client_ok -F $OBJ/ssh_config\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true || \\\n    fail \"match permitlisten bare\"\nstop_client\n\n# Test that an incorrect bare port number is denied as expected\ncp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\necho \"PermitListen 1 2 99\" >>$OBJ/sshd_proxy\ntrace \"match permitlisten bare\"\nexpect_client_fail -F $OBJ/ssh_config\n\ncp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\necho \"PermitListen 127.0.0.1:1 $fwdspec 127.0.0.2:2\" >>$OBJ/sshd_proxy\necho \"Match User $USER\" >>$OBJ/sshd_proxy\necho \"PermitListen 127.0.0.1:1 127.0.0.1:2\" >>$OBJ/sshd_proxy\n\n# Test that a Match overrides a PermitListen in the global section\ntrace \"match permitlisten proxy w/key opts\"\nexpect_client_fail \"match override permitlisten\" \\\n    -F $OBJ/ssh_proxy\n\ncp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\necho \"PermitListen 127.0.0.1:1 $fwdspec 127.0.0.2:2\" >>$OBJ/sshd_proxy\necho \"Match User NoSuchUser\" >>$OBJ/sshd_proxy\necho \"PermitListen 127.0.0.1:1 127.0.0.1:2\" >>$OBJ/sshd_proxy\n\n# Test that a rule that doesn't match doesn't override, plus test a\n# PermitListen entry that's not at the start of the list\ntrace \"nomatch permitlisten proxy w/key opts\"\nexpect_client_ok -F $OBJ/ssh_proxy\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true || \\\n    fail \"nomatch override permitlisten\"\nstop_client\n\n# bind to 127.0.0.1 instead of default localhost\nfwdspec2=\"127.0.0.1:${fwdport}\"\nfwd=\"-R ${fwdspec2}:127.0.0.1:$PORT\"\n\n# first try w/ old fwdspec both in server config and key opts\ncp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\necho \"PermitListen 127.0.0.1:1 $fwdspec 127.0.0.2:2\" >>$OBJ/sshd_proxy\ncp /dev/null $OBJ/authorized_keys_$USER\nfor t in ${SSH_KEYTYPES}; do\n\tprintf 'permitlisten=\"'$fwdspec'\" ' >> $OBJ/authorized_keys_$USER\n\tcat $OBJ/$t.pub >> $OBJ/authorized_keys_$USER\ndone\ntrace \"nomatch permitlisten 127.0.0.1 server config and userkey\"\nexpect_client_fail \"nomatch 127.0.0.1 server config and userkey\" \\\n    -F $OBJ/ssh_config\n\n# correct server config, denied by key opts\ncp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\necho \"PermitListen 127.0.0.1:1 ${fwdspec2} 127.0.0.2:2\" >>$OBJ/sshd_proxy\ntrace \"nomatch permitlisten 127.0.0.1 w/key opts\"\nexpect_client_fail \"nomatch 127.0.0.1 w/key opts\" \\\n    -F $OBJ/ssh_config\n\n# fix key opts\ncp /dev/null $OBJ/authorized_keys_$USER\nfor t in ${SSH_KEYTYPES}; do\n\tprintf 'permitlisten=\"'$fwdspec2'\" ' >> $OBJ/authorized_keys_$USER\n\tcat $OBJ/$t.pub >> $OBJ/authorized_keys_$USER\ndone\ntrace \"match permitlisten 127.0.0.1 server config w/key opts\"\nexpect_client_ok -F $OBJ/ssh_proxy\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true || \\\n    fail \"match 127.0.0.1 server config w/key opts\"\nstop_client\n\n# key opts with bare port number\ncp /dev/null $OBJ/authorized_keys_$USER\nfor t in ${SSH_KEYTYPES}; do\n\tprintf 'permitlisten=\"'$fwdport'\" ' >> $OBJ/authorized_keys_$USER\n\tcat $OBJ/$t.pub >> $OBJ/authorized_keys_$USER\ndone\ntrace \"match permitlisten 127.0.0.1 server config w/key opts (bare)\"\nexpect_client_ok -F $OBJ/ssh_proxy\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true || \\\n    fail \"match 127.0.0.1 server config w/key opts (bare)\"\nstop_client\n\n# key opts with incorrect bare port number\ncp /dev/null $OBJ/authorized_keys_$USER\nfor t in ${SSH_KEYTYPES}; do\n\tprintf 'permitlisten=\"99\" ' >> $OBJ/authorized_keys_$USER\n\tcat $OBJ/$t.pub >> $OBJ/authorized_keys_$USER\ndone\ntrace \"match permitlisten 127.0.0.1 server config w/key opts (wrong bare)\"\nexpect_client_fail \"nomatch 127.0.0.1 w/key opts (wrong bare)\" \\\n    -F $OBJ/ssh_config\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}