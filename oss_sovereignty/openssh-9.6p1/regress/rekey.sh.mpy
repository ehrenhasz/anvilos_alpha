{
  "module_name": "rekey.sh",
  "hash_id": "fe916eab59a046fb2a14bcf27ddbe6aac5e85b43583793b6dd719e54fe47b5f8",
  "original_prompt": "Ingested from openssh-9.6p1/regress/rekey.sh",
  "human_readable_source": "#\t$OpenBSD: rekey.sh,v 1.19 2021/07/19 05:08:54 dtucker Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"rekey\"\n\nLOG=${TEST_SSH_LOGFILE}\n\nrm -f ${LOG}\ncp $OBJ/sshd_proxy $OBJ/sshd_proxy_bak\n\n# Test rekeying based on data volume only.\n# Arguments will be passed to ssh.\nssh_data_rekeying()\n{\n\t_kexopt=$1 ; shift\n\t_opts=\"$@\"\n\tif ! test -z \"$_kexopts\" ; then\n\t\tcp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\n\t\techo \"$_kexopt\" >> $OBJ/sshd_proxy\n\t\t_opts=\"$_opts -o$_kexopt\"\n\tfi\n\trm -f ${COPY} ${LOG}\n\t_opts=\"$_opts -oCompression=no\"\n\t${SSH} <${DATA} $_opts -v -F $OBJ/ssh_proxy somehost \"cat > ${COPY}\"\n\tif [ $? -ne 0 ]; then\n\t\tfail \"ssh failed ($@)\"\n\tfi\n\tcmp ${DATA} ${COPY}\t\t|| fail \"corrupted copy ($@)\"\n\tn=`grep 'NEWKEYS sent' ${LOG} | wc -l`\n\tn=`expr $n - 1`\n\ttrace \"$n rekeying(s)\"\n\tif [ $n -lt 1 ]; then\n\t\tfail \"no rekeying occurred ($@)\"\n\tfi\n}\n\nincrease_datafile_size 300\n\nopts=\"\"\nfor i in `${SSH} -Q kex`; do\n\topts=\"$opts KexAlgorithms=$i\"\ndone\nfor i in `${SSH} -Q cipher`; do\n\topts=\"$opts Ciphers=$i\"\ndone\nfor i in `${SSH} -Q mac`; do\n\topts=\"$opts MACs=$i\"\ndone\n\nfor opt in $opts; do\n\tverbose \"client rekey $opt\"\n\tssh_data_rekeying \"$opt\" -oRekeyLimit=256k\ndone\n\n# AEAD ciphers are magical so test with all KexAlgorithms\nif ${SSH} -Q cipher-auth | grep '^.*$' >/dev/null 2>&1 ; then\n  for c in `${SSH} -Q cipher-auth`; do\n    for kex in `${SSH} -Q kex`; do\n\tverbose \"client rekey $c $kex\"\n\tssh_data_rekeying \"KexAlgorithms=$kex\" -oRekeyLimit=256k -oCiphers=$c\n    done\n  done\nfi\n\nfor s in 16 1k 128k 256k; do\n\tverbose \"client rekeylimit ${s}\"\n\tssh_data_rekeying \"\" -oCompression=no -oRekeyLimit=$s\ndone\n\nfor s in 5 10; do\n\tverbose \"client rekeylimit default ${s}\"\n\trm -f ${COPY} ${LOG}\n\t${SSH} < ${DATA} -oCompression=no -oRekeyLimit=\"default $s\" -F \\\n\t\t$OBJ/ssh_proxy somehost \"cat >${COPY};sleep $s;sleep 10\"\n\tif [ $? -ne 0 ]; then\n\t\tfail \"ssh failed\"\n\tfi\n\tcmp ${DATA} ${COPY}\t\t|| fail \"corrupted copy\"\n\tn=`grep 'NEWKEYS sent' ${LOG} | wc -l`\n\tn=`expr $n - 1`\n\ttrace \"$n rekeying(s)\"\n\tif [ $n -lt 1 ]; then\n\t\tfail \"no rekeying occurred\"\n\tfi\ndone\n\nfor s in 5 10; do\n\tverbose \"client rekeylimit default ${s} no data\"\n\trm -f ${COPY} ${LOG}\n\t${SSH} -oCompression=no -oRekeyLimit=\"default $s\" -F \\\n\t\t$OBJ/ssh_proxy somehost \"sleep $s;sleep 10\"\n\tif [ $? -ne 0 ]; then\n\t\tfail \"ssh failed\"\n\tfi\n\tn=`grep 'NEWKEYS sent' ${LOG} | wc -l`\n\tn=`expr $n - 1`\n\ttrace \"$n rekeying(s)\"\n\tif [ $n -lt 1 ]; then\n\t\tfail \"no rekeying occurred\"\n\tfi\ndone\n\nfor s in 16 1k 128k 256k; do\n\tverbose \"server rekeylimit ${s}\"\n\tcp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\n\techo \"rekeylimit ${s}\" >>$OBJ/sshd_proxy\n\trm -f ${COPY} ${LOG}\n\t${SSH} -oCompression=no -F $OBJ/ssh_proxy somehost \"cat ${DATA}\" \\\n\t    > ${COPY}\n\tif [ $? -ne 0 ]; then\n\t\tfail \"ssh failed\"\n\tfi\n\tcmp ${DATA} ${COPY}\t\t|| fail \"corrupted copy\"\n\tn=`grep 'NEWKEYS sent' ${LOG} | wc -l`\n\tn=`expr $n - 1`\n\ttrace \"$n rekeying(s)\"\n\tif [ $n -lt 1 ]; then\n\t\tfail \"no rekeying occurred\"\n\tfi\ndone\n\nfor s in 5 10; do\n\tverbose \"server rekeylimit default ${s} no data\"\n\tcp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\n\techo \"rekeylimit default ${s}\" >>$OBJ/sshd_proxy\n\trm -f ${COPY} ${LOG}\n\t${SSH} -oCompression=no -F $OBJ/ssh_proxy somehost \"sleep $s;sleep 10\"\n\tif [ $? -ne 0 ]; then\n\t\tfail \"ssh failed\"\n\tfi\n\tn=`grep 'NEWKEYS sent' ${LOG} | wc -l`\n\tn=`expr $n - 1`\n\ttrace \"$n rekeying(s)\"\n\tif [ $n -lt 1 ]; then\n\t\tfail \"no rekeying occurred\"\n\tfi\ndone\n\nverbose \"rekeylimit parsing\"\nfor size in 16 1k 1K 1m 1M 1g 1G 4G 8G; do\n    for time in 1 1m 1M 1h 1H 1d 1D 1w 1W; do\n\tcase $size in\n\t\t16)\tbytes=16 ;;\n\t\t1k|1K)\tbytes=1024 ;;\n\t\t1m|1M)\tbytes=1048576 ;;\n\t\t1g|1G)\tbytes=1073741824 ;;\n\t\t4g|4G)\tbytes=4294967296 ;;\n\t\t8g|8G)\tbytes=8589934592 ;;\n\tesac\n\tcase $time in\n\t\t1)\tseconds=1 ;;\n\t\t1m|1M)\tseconds=60 ;;\n\t\t1h|1H)\tseconds=3600 ;;\n\t\t1d|1D)\tseconds=86400 ;;\n\t\t1w|1W)\tseconds=604800 ;;\n\tesac\n\n\tb=`$SUDO ${SSHD} -T -o \"rekeylimit $size $time\" -f $OBJ/sshd_proxy | \\\n\t    awk '/rekeylimit/{print $2}'`\n\ts=`$SUDO ${SSHD} -T -o \"rekeylimit $size $time\" -f $OBJ/sshd_proxy | \\\n\t    awk '/rekeylimit/{print $3}'`\n\n\tif [ \"$bytes\" != \"$b\" ]; then\n\t\tfatal \"rekeylimit size: expected $bytes bytes got $b\"\n\tfi\n\tif [ \"$seconds\" != \"$s\" ]; then\n\t\tfatal \"rekeylimit time: expected $time seconds got $s\"\n\tfi\n    done\ndone\n\nrm -f ${COPY} ${DATA}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}