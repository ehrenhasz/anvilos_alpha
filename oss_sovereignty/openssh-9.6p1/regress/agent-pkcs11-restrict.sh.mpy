{
  "module_name": "agent-pkcs11-restrict.sh",
  "hash_id": "5e27d44139d7701ee98dec82f20ce1015b10b9fb85869afef840e4690751f78a",
  "original_prompt": "Ingested from openssh-9.6p1/regress/agent-pkcs11-restrict.sh",
  "human_readable_source": "#\t$OpenBSD: agent-pkcs11-restrict.sh,v 1.1 2023/12/18 14:49:39 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"pkcs11 agent constraint test\"\n\np11_setup || skip \"No PKCS#11 library found\"\n\nrm -f $SSH_AUTH_SOCK $OBJ/agent.log $OBJ/host_[abcx]* $OBJ/user_[abcx]*\nrm -f $OBJ/sshd_proxy_host* $OBJ/ssh_output* $OBJ/expect_*\nrm -f $OBJ/ssh_proxy[._]* $OBJ/command $OBJ/authorized_keys_*\n\ntrace \"generate host keys\"\nfor h in a b x ca ; do\n\t$SSHKEYGEN -q -t ed25519 -C host_$h -N '' -f $OBJ/host_$h || \\\n\t\tfatal \"ssh-keygen hostkey failed\"\ndone\n\n# XXX test CA hostcerts too.\n\nkey_for() {\n\tcase $h in\n\ta) K=\"${SSH_SOFTHSM_DIR}/RSA.pub\" ;;\n\tb) K=\"${SSH_SOFTHSM_DIR}/EC.pub\" ;;\n\t*) K=\"\" ;;\n\tesac\n\texport K\n}\n\nSSH_AUTH_SOCK=\"$OBJ/agent.sock\"\nexport SSH_AUTH_SOCK\nrm -f $SSH_AUTH_SOCK\ntrace \"start agent\"\n${SSHAGENT} ${EXTRA_AGENT_ARGS} -d -a $SSH_AUTH_SOCK > $OBJ/agent.log 2>&1 &\nAGENT_PID=$!\ntrap \"kill $AGENT_PID\" EXIT\nfor x in 0 1 2 3 4 ; do\n\t# Give it a chance to start\n\t${SSHADD} -l > /dev/null 2>&1\n\tr=$?\n\ttest $r -eq 1 && break\n\tsleep 1\ndone\nif [ $r -ne 1 ]; then\n\tfatal \"ssh-add -l did not fail with exit code 1 (got $r)\"\nfi\n\n# XXX a lot of this is a copy of agent-restrict.sh, but I couldn't see a nice\n# way to factor it out -djm\n\ntrace \"prepare client config\"\negrep -vi '(identityfile|hostname|hostkeyalias|proxycommand)' \\\n\t$OBJ/ssh_proxy > $OBJ/ssh_proxy.bak\ncat << _EOF > $OBJ/ssh_proxy\nIdentitiesOnly yes\nForwardAgent yes\nExitOnForwardFailure yes\n_EOF\ncp $OBJ/ssh_proxy $OBJ/ssh_proxy_noid\nfor h in a b ; do\n\tkey_for $h\n\tcat << _EOF >> $OBJ/ssh_proxy\nHost host_$h\n\tHostname host_$h\n\tHostkeyAlias host_$h\n\tIdentityFile $K\n\tProxyCommand ${SUDO} env SSH_SK_HELPER=\\\"$SSH_SK_HELPER\\\" ${OBJ}/sshd-log-wrapper.sh -i -f $OBJ/sshd_proxy_host_$h\n_EOF\n\t# Variant with no specified keys.\n\tcat << _EOF >> $OBJ/ssh_proxy_noid\nHost host_$h\n\tHostname host_$h\n\tHostkeyAlias host_$h\n\tProxyCommand ${SUDO} env SSH_SK_HELPER=\\\"$SSH_SK_HELPER\\\" ${OBJ}/sshd-log-wrapper.sh -i -f $OBJ/sshd_proxy_host_$h\n_EOF\ndone\ncat $OBJ/ssh_proxy.bak >> $OBJ/ssh_proxy\ncat $OBJ/ssh_proxy.bak >> $OBJ/ssh_proxy_noid\n\nLC_ALL=C\nexport LC_ALL\necho \"SetEnv LC_ALL=${LC_ALL}\" >> sshd_proxy\n\ntrace \"prepare known_hosts\"\nrm -f $OBJ/known_hosts\nfor h in a b x ; do\n\t(printf \"host_$h \" ; cat $OBJ/host_${h}.pub) >> $OBJ/known_hosts\ndone\n\ntrace \"prepare server configs\"\negrep -vi '(hostkey|pidfile)' $OBJ/sshd_proxy \\\n\t> $OBJ/sshd_proxy.bak\nfor h in a b ; do\n\tcp $OBJ/sshd_proxy.bak $OBJ/sshd_proxy_host_$h\n\tcat << _EOF >> $OBJ/sshd_proxy_host_$h\nExposeAuthInfo yes\nHostkey $OBJ/host_$h\n_EOF\n\tcp $OBJ/sshd_proxy_host_$h $OBJ/sshd_proxy_host_${h}.bak\ndone\n\ntrace \"prepare authorized_keys\"\ncat >> $OBJ/command << EOF\n#!/bin/sh\necho USERAUTH\ncat \\$SSH_USER_AUTH\necho AGENT\nif $SSHADD -ql >/dev/null 2>&1 ; then\n\t$SSHADD -L | cut -d' ' -f1-2 | sort\nelse\n\techo NONE\nfi\nEOF\nchmod a+x $OBJ/command\n>$OBJ/authorized_keys_$USER\nfor h in a b ; do\n\tkey_for $h\n\t(printf \"%s\" \"restrict,agent-forwarding,command=\\\"$OBJ/command\\\" \";\n\t cat $K) >> $OBJ/authorized_keys_$USER\ndone\n\ntrace \"unrestricted keys\"\n$SSHADD -qD >/dev/null || fatal \"clear agent failed\"\np11_ssh_add -qs ${TEST_SSH_PKCS11} ||\n\tfatal \"failed to add keys\"\nfor h in a b ; do\n\tkey_for $h\n\techo USERAUTH > $OBJ/expect_$h\n\tprintf \"publickey \" >> $OBJ/expect_$h\n\tcat $K >> $OBJ/expect_$h\n\techo AGENT >> $OBJ/expect_$h\n\t$SSHADD -L | cut -d' ' -f1-2 | sort >> $OBJ/expect_$h\n\t${SSH} -F $OBJ/ssh_proxy -oIdentityFile=$K \\\n\t    host_$h true > $OBJ/ssh_output || fatal \"test ssh $h failed\"\n\tcmp $OBJ/expect_$h $OBJ/ssh_output || fatal \"unexpected output\"\ndone\n\ntrace \"restricted to different host\"\n$SSHADD -qD >/dev/null || fatal \"clear agent failed\"\np11_ssh_add -q -h host_x -s ${TEST_SSH_PKCS11} -H $OBJ/known_hosts ||\n\tfatal \"failed to add keys\"\nfor h in a b ; do\n\tkey_for $h\n\t${SSH} -F $OBJ/ssh_proxy -oIdentityFile=$K \\\n\t    host_$h true > $OBJ/ssh_output && fatal \"test ssh $h succeeded\"\ndone\n\ntrace \"restricted to destination host\"\n$SSHADD -qD >/dev/null || fatal \"clear agent failed\"\np11_ssh_add -q -h host_a -h host_b -s ${TEST_SSH_PKCS11} -H $OBJ/known_hosts ||\n\tfatal \"failed to add keys\"\nfor h in a b ; do\n\tkey_for $h\n\techo USERAUTH > $OBJ/expect_$h\n\tprintf \"publickey \" >> $OBJ/expect_$h\n\tcat $K >> $OBJ/expect_$h\n\techo AGENT >> $OBJ/expect_$h\n\techo NONE >> $OBJ/expect_$h\n\t${SSH} -F $OBJ/ssh_proxy -oIdentityFile=$K \\\n\t    host_$h true > $OBJ/ssh_output || fatal \"test ssh $h failed\"\n\tcmp $OBJ/expect_$h $OBJ/ssh_output || fatal \"unexpected output\"\ndone\n\ntrace \"restricted multihop\"\n$SSHADD -qD >/dev/null || fatal \"clear agent failed\"\np11_ssh_add -q -h host_a -h \"host_a>host_b\" \\\n    -s ${TEST_SSH_PKCS11} -H $OBJ/known_hosts || fatal \"failed to add keys\"\nkey_for a\nAK=$K\nkey_for b\nBK=$K\n# Prepare authorized_keys file to additionally ssh to host_b\n_command=\"echo LOCAL ; ${OBJ}/command ; echo REMOTE; ${SSH} -AF $OBJ/ssh_proxy -oIdentityFile=$BK host_b\"\n(printf \"%s\" \"restrict,agent-forwarding,command=\\\"$_command\\\" \";\n cat $BK) > $OBJ/authorized_keys_a\ngrep -vi AuthorizedKeysFile $OBJ/sshd_proxy_host_a.bak > $OBJ/sshd_proxy_host_a\necho \"AuthorizedKeysFile $OBJ/authorized_keys_a\" >> $OBJ/sshd_proxy_host_a\n# Prepare expected output from both hosts.\necho LOCAL > $OBJ/expect_a\necho USERAUTH >> $OBJ/expect_a\nprintf \"publickey \" >> $OBJ/expect_a\ncat $AK >> $OBJ/expect_a\necho AGENT >> $OBJ/expect_a\n$SSHADD -L | cut -d' ' -f1-2 | sort >> $OBJ/expect_a\necho REMOTE >> $OBJ/expect_a\necho USERAUTH >> $OBJ/expect_a\nprintf \"publickey \" >> $OBJ/expect_a\ncat $BK >> $OBJ/expect_a\necho AGENT >> $OBJ/expect_a\necho NONE >> $OBJ/expect_a\n${SSH} -AF $OBJ/ssh_proxy -oIdentityFile=$AK \\\n    host_a whatever > $OBJ/ssh_output || fatal \"test ssh $h failed\"\ncmp $OBJ/expect_a $OBJ/ssh_output || fatal \"unexpected output\"\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}