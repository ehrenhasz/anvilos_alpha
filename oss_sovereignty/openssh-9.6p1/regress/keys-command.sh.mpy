{
  "module_name": "keys-command.sh",
  "hash_id": "627300801fc24959139b8c0dedcdf6cd71b2c00812ed129f3d5fc22f4a669752",
  "original_prompt": "Ingested from openssh-9.6p1/regress/keys-command.sh",
  "human_readable_source": "#\t$OpenBSD: keys-command.sh,v 1.8 2021/09/30 04:22:50 dtucker Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"authorized keys from command\"\n\nif [ -z \"$SUDO\" -a ! -w /var/run ]; then\n\tskip \"need SUDO to create file in /var/run, test won't work without\"\nfi\n\nrm -f $OBJ/keys-command-args\n\ntouch $OBJ/keys-command-args\nchmod a+rw $OBJ/keys-command-args\n\nexpected_key_text=`awk '{ print $2 }' < $OBJ/ssh-ed25519.pub`\nexpected_key_fp=`$SSHKEYGEN -lf $OBJ/ssh-ed25519.pub | awk '{ print $2 }'`\n\n# Establish a AuthorizedKeysCommand in /var/run where it will have\n# acceptable directory permissions.\nKEY_COMMAND=\"/var/run/keycommand_${LOGNAME}.$$\"\ntrap \"${SUDO} rm -f ${KEY_COMMAND}\" 0\ncat << _EOF | $SUDO sh -c \"rm -f '$KEY_COMMAND' ; cat > '$KEY_COMMAND'\"\n#!/bin/sh\necho args: \"\\$@\" >> $OBJ/keys-command-args\necho \"$PATH\" | grep -q mekmitasdigoat && exit 7\ntest \"x\\$1\" != \"x${LOGNAME}\" && exit 1\nif test $# -eq 6 ; then\n\ttest \"x\\$2\" != \"xblah\" && exit 2\n\ttest \"x\\$3\" != \"x${expected_key_text}\" && exit 3\n\ttest \"x\\$4\" != \"xssh-rsa\" && exit 4\n\ttest \"x\\$5\" != \"x${expected_key_fp}\" && exit 5\n\ttest \"x\\$6\" != \"xblah\" && exit 6\nfi\nexec cat \"$OBJ/authorized_keys_${LOGNAME}\"\n_EOF\n$SUDO chmod 0755 \"$KEY_COMMAND\"\n\nif ! $OBJ/check-perm -m keys-command $KEY_COMMAND ; then\n\techo \"skipping: $KEY_COMMAND is unsuitable as AuthorizedKeysCommand\"\n\t$SUDO rm -f $KEY_COMMAND\n\texit 0\nfi\n\nif [ -x $KEY_COMMAND ]; then\n\tcp $OBJ/sshd_proxy $OBJ/sshd_proxy.bak\n\n\tverbose \"AuthorizedKeysCommand with arguments\"\n\t(\n\t\tgrep -vi AuthorizedKeysFile $OBJ/sshd_proxy.bak\n\t\techo AuthorizedKeysFile none\n\t\techo AuthorizedKeysCommand $KEY_COMMAND %u blah %k %t %f blah\n\t\techo AuthorizedKeysCommandUser ${LOGNAME}\n\t) > $OBJ/sshd_proxy\n\n\t# Ensure that $PATH is sanitised in sshd\n\tenv PATH=$PATH:/sbin/mekmitasdigoat \\\n\t    ${SSH} -F $OBJ/ssh_proxy somehost true\n\tif [ $? -ne 0 ]; then\n\t\tfail \"connect failed\"\n\tfi\n\n\tverbose \"AuthorizedKeysCommand without arguments\"\n\t# Check legacy behavior of no-args resulting in username being passed.\n\t(\n\t\tgrep -vi AuthorizedKeysFile $OBJ/sshd_proxy.bak\n\t\techo AuthorizedKeysFile none\n\t\techo AuthorizedKeysCommand $KEY_COMMAND\n\t\techo AuthorizedKeysCommandUser ${LOGNAME}\n\t) > $OBJ/sshd_proxy\n\n\t# Ensure that $PATH is sanitised in sshd\n\tenv PATH=$PATH:/sbin/mekmitasdigoat \\\n\t    ${SSH} -F $OBJ/ssh_proxy somehost true\n\tif [ $? -ne 0 ]; then\n\t\tfail \"connect failed\"\n\tfi\nelse\n\tskip \"$KEY_COMMAND not executable (/var/run mounted noexec?)\"\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}