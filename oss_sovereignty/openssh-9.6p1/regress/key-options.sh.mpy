{
  "module_name": "key-options.sh",
  "hash_id": "f7a9e9d65f80ed14b74136450b2e85be0adae647b9eb04b35127bf63f7f0bea4",
  "original_prompt": "Ingested from openssh-9.6p1/regress/key-options.sh",
  "human_readable_source": "#\t$OpenBSD: key-options.sh,v 1.9 2018/07/03 13:53:26 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"key options\"\n\norigkeys=\"$OBJ/authkeys_orig\"\nauthkeys=\"$OBJ/authorized_keys_${USER}\"\ncp $authkeys $origkeys\n\n# Allocating ptys can require privileges on some platforms.\nskip_pty=\"\"\nif ! config_defined HAVE_OPENPTY && [ \"x$SUDO\" = \"x\" ]; then\n\tskip_pty=\"no openpty(3) and SUDO not set\"\nfi\n\n# Test command= forced command\nfor c in 'command=\"echo bar\"' 'no-pty,command=\"echo bar\"'; do\n\tsed \"s/.*/$c &/\" $origkeys >$authkeys\n\tverbose \"key option $c\"\n\tr=`${SSH} -q -F $OBJ/ssh_proxy somehost echo foo`\n\tif [ \"$r\" = \"foo\" ]; then\n\t\tfail \"key option forced command not restricted\"\n\tfi\n\tif [ \"$r\" != \"bar\" ]; then\n\t\tfail \"key option forced command not executed\"\n\tfi\ndone\n\n# Test no-pty\nexpect_pty_succeed() {\n\twhich=$1\n\topts=$2\n\trm -f $OBJ/data\n\tsed \"s/.*/$opts &/\" $origkeys >$authkeys\n\tverbose \"key option pty $which\"\n\t[ \"x$skip_pty\" != \"x\" ] && verbose \"skipped because $skip_pty\" && return\n\t${SSH} -ttq -F $OBJ/ssh_proxy somehost \"tty > $OBJ/data; exit 0\"\n\tif [ $? -ne 0 ] ; then\n\t\tfail \"key option failed $which\"\n\telse\n\t\tr=`cat $OBJ/data`\n\t\tcase \"$r\" in\n\t\t/dev/*) ;;\n\t\t*)\tfail \"key option failed $which (pty $r)\" ;;\n\t\tesac\n\tfi\n}\nexpect_pty_fail() {\n\twhich=$1\n\topts=$2\n\trm -f $OBJ/data\n\tsed \"s/.*/$opts &/\" $origkeys >$authkeys\n\tverbose \"key option pty $which\"\n\t[ \"x$skip_pty\" != \"x\" ] && verbose \"skipped because $skip_pty\" && return\n\t${SSH} -ttq -F $OBJ/ssh_proxy somehost \"tty > $OBJ/data; exit 0\"\n\tif [ $? -eq 0 ]; then\n\t\tr=`cat $OBJ/data`\n\t\tif [ -e \"$r\" ]; then\n\t\t\tfail \"key option failed $which (pty $r)\"\n\t\tfi\n\t\tcase \"$r\" in\n\t\t/dev/*)\tfail \"key option failed $which (pty $r)\" ;;\n\t\t*)\t;;\n\t\tesac\n\tfi\n}\n# First ensure that we can allocate a pty by default.\nexpect_pty_succeed \"default\" \"\"\nexpect_pty_fail \"no-pty\" \"no-pty\"\nexpect_pty_fail \"restrict\" \"restrict\"\nexpect_pty_succeed \"restrict,pty\" \"restrict,pty\"\n\n# Test environment=\n# XXX this can fail if ~/.ssh/environment exists for the user running the test\necho 'PermitUserEnvironment yes' >> $OBJ/sshd_proxy\nsed 's/.*/environment=\"FOO=bar\" &/' $origkeys >$authkeys\nverbose \"key option environment\"\nr=`${SSH} -q -F $OBJ/ssh_proxy somehost 'echo $FOO'`\nif [ \"$r\" != \"bar\" ]; then\n\tfail \"key option environment not set\"\nfi\n\n# Test from= restriction\nstart_sshd\nfor f in 127.0.0.1 '127.0.0.0\\/8'; do\n\tcat  $origkeys >$authkeys\n\t${SSH} -q -F $OBJ/ssh_proxy somehost true\n\tif [ $? -ne 0 ]; then\n\t\tfail \"key option failed without restriction\"\n\tfi\n\n\tsed 's/.*/from=\"'\"$f\"'\" &/' $origkeys >$authkeys\n\tfrom=`head -1 $authkeys | cut -f1 -d ' '`\n\tverbose \"key option $from\"\n\tr=`${SSH} -q -F $OBJ/ssh_proxy somehost 'echo true'`\n\tif [ \"$r\" = \"true\" ]; then\n\t\tfail \"key option $from not restricted\"\n\tfi\n\n\tr=`${SSH} -q -F $OBJ/ssh_config somehost 'echo true'`\n\tif [ \"$r\" != \"true\" ]; then\n\t\tfail \"key option $from not allowed but should be\"\n\tfi\ndone\n\ncheck_valid_before() {\n\twhich=$1\n\topts=$2\n\texpect=$3\n\tsed \"s/.*/$opts &/\" $origkeys >$authkeys\n\tverbose \"key option expiry-time $which\"\n\t${SSH} -q -F $OBJ/ssh_proxy somehost true\n\tr=$?\n\tcase \"$expect\" in\n\tfail)\ttest $r -eq 0 && fail \"key option succeeded $which\" ;;\n\tpass)\ttest $r -ne 0 && fail \"key option failed $which\" ;;\n\t*)\tfatal \"unknown expectation $expect\" ;;\n\tesac\n}\ncheck_valid_before \"default\"\t\"\"\t\t\t\t\"pass\"\ncheck_valid_before \"invalid\"\t'expiry-time=\"INVALID\"'\t\t\"fail\"\ncheck_valid_before \"expired\"\t'expiry-time=\"19990101\"'\t\"fail\"\ncheck_valid_before \"valid\"\t'expiry-time=\"20380101\"'\t\"pass\"\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}