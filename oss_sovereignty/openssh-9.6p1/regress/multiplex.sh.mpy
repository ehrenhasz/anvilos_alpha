{
  "module_name": "multiplex.sh",
  "hash_id": "eeb2974c00328239fde6a5d2b5490cfe6a16ff5307988309bd8c6672165924d3",
  "original_prompt": "Ingested from openssh-9.6p1/regress/multiplex.sh",
  "human_readable_source": "#\t$OpenBSD: multiplex.sh,v 1.36 2023/03/01 09:29:32 dtucker Exp $\n#\tPlaced in the Public Domain.\n\nmake_tmpdir\nCTL=${SSH_REGRESS_TMP}/ctl-sock\n\ntid=\"connection multiplexing\"\n\ntrace \"will use ProxyCommand $proxycmd\"\nif config_defined DISABLE_FD_PASSING ; then\n\techo \"skipped (not supported on this platform)\"\n\texit 0\nfi\n\nP=3301  # test port\n\nwait_for_mux_master_ready()\n{\n\tfor i in 1 2 3 4 5 6 7 8 9; do\n\t\t${SSH} -F $OBJ/ssh_config -S $CTL -Ocheck otherhost \\\n\t\t    >/dev/null 2>&1 && return 0\n\t\tsleep $i\n\tdone\n\tfatal \"mux master never becomes ready\"\n}\n\nmaybe_add_scp_path_to_sshd\nstart_sshd\n\nstart_mux_master()\n{\n\ttrace \"start master, fork to background\"\n\t${SSH} -Nn2 -MS$CTL -F $OBJ/ssh_config -oSendEnv=\"_XXX_TEST\" somehost \\\n\t    -E $TEST_REGRESS_LOGFILE 2>&1 &\n\t# NB. $SSH_PID will be killed by test-exec.sh:cleanup on fatal errors.\n\tSSH_PID=$!\n\twait_for_mux_master_ready\n}\n\nstart_mux_master\n\nverbose \"test $tid: setenv\"\ntrace \"setenv over multiplexed connection\"\n_XXX_TEST=blah ${SSH} -F $OBJ/ssh_config -oSendEnv=\"_XXX_TEST\" -S$CTL otherhost sh << 'EOF'\n\ttest X\"$_XXX_TEST\" = X\"blah\"\nEOF\nif [ $? -ne 0 ]; then\n\tfail \"environment not found\"\nfi\n\nverbose \"test $tid: envpass\"\ntrace \"env passing over multiplexed connection\"\n${SSH} -F $OBJ/ssh_config -oSetEnv=\"_XXX_TEST=foo\" -S$CTL otherhost sh << 'EOF'\n\ttest X\"$_XXX_TEST\" = X\"foo\"\nEOF\nif [ $? -ne 0 ]; then\n\tfail \"environment not found\"\nfi\n\n\nverbose \"test $tid: transfer\"\nrm -f ${COPY}\ntrace \"ssh transfer over multiplexed connection and check result\"\n${SSH} -F $OBJ/ssh_config -S$CTL otherhost cat ${DATA} > ${COPY}\ntest -f ${COPY}\t\t\t|| fail \"ssh -Sctl: failed copy ${DATA}\" \ncmp ${DATA} ${COPY}\t\t|| fail \"ssh -Sctl: corrupted copy of ${DATA}\"\n\nrm -f ${COPY}\ntrace \"ssh transfer over multiplexed connection and check result\"\n${SSH} -F $OBJ/ssh_config -S $CTL otherhost cat ${DATA} > ${COPY}\ntest -f ${COPY}\t\t\t|| fail \"ssh -S ctl: failed copy ${DATA}\" \ncmp ${DATA} ${COPY}\t\t|| fail \"ssh -S ctl: corrupted copy of ${DATA}\"\n\nrm -f ${COPY}\ntrace \"sftp transfer over multiplexed connection and check result\"\necho \"get ${DATA} ${COPY}\" | \\\n\t${SFTP} -S ${SSH} -F $OBJ/ssh_config -oControlPath=$CTL otherhost >>$TEST_REGRESS_LOGFILE 2>&1\ntest -f ${COPY}\t\t\t|| fail \"sftp: failed copy ${DATA}\" \ncmp ${DATA} ${COPY}\t\t|| fail \"sftp: corrupted copy of ${DATA}\"\n\nrm -f ${COPY}\ntrace \"scp transfer over multiplexed connection and check result\"\n${SCP} -S ${SSH} -F $OBJ/ssh_config -oControlPath=$CTL otherhost:${DATA} ${COPY} >>$TEST_REGRESS_LOGFILE 2>&1\ntest -f ${COPY}\t\t\t|| fail \"scp: failed copy ${DATA}\" \ncmp ${DATA} ${COPY}\t\t|| fail \"scp: corrupted copy of ${DATA}\"\n\nrm -f ${COPY}\nverbose \"test $tid: forward\"\ntrace \"forward over TCP/IP and check result\"\n$NC -N -l 127.0.0.1 $((${PORT} + 1)) < ${DATA} >`ssh_logfile nc` &\nnetcat_pid=$!\n${SSH} -F $OBJ/ssh_config -S $CTL -Oforward -L127.0.0.1:$((${PORT} + 2)):127.0.0.1:$((${PORT} + 1)) otherhost >>$TEST_SSH_LOGFILE 2>&1\nsleep 1  # XXX remove once race fixed\n$NC 127.0.0.1 $((${PORT} + 2)) < /dev/null > ${COPY}\ncmp ${DATA} ${COPY}\t\t|| fail \"ssh: corrupted copy of ${DATA}\"\nkill $netcat_pid 2>/dev/null\nrm -f ${COPY} $OBJ/unix-[123].fwd\n\ntrace \"forward over UNIX and check result\"\n$NC -N -Ul $OBJ/unix-1.fwd < ${DATA} > /dev/null &\nnetcat_pid=$!\n${SSH} -F $OBJ/ssh_config -S $CTL -Oforward -L$OBJ/unix-2.fwd:$OBJ/unix-1.fwd otherhost >>$TEST_SSH_LOGFILE 2>&1\n${SSH} -F $OBJ/ssh_config -S $CTL -Oforward -R$OBJ/unix-3.fwd:$OBJ/unix-2.fwd otherhost >>$TEST_SSH_LOGFILE 2>&1\nsleep 1  # XXX remove once race fixed\n$NC -U $OBJ/unix-3.fwd < /dev/null > ${COPY}\ncmp ${DATA} ${COPY}\t\t|| fail \"ssh: corrupted copy of ${DATA}\"\nkill $netcat_pid 2>/dev/null\nrm -f ${COPY} $OBJ/unix-[123].fwd\n\nfor s in 0 1 4 5 44; do\n   for mode in \"\" \"-Oproxy\"; do\n\ttrace \"exit status $s over multiplexed connection ($mode)\"\n\tverbose \"test $tid: status $s ($mode)\"\n\t${SSH} -F $OBJ/ssh_config -S $CTL $mode otherhost exit $s\n\tr=$?\n\tif [ $r -ne $s ]; then\n\t\tfail \"exit code mismatch: $r != $s\"\n\tfi\n\n\t# same with early close of stdout/err\n\ttrace \"exit status $s with early close over multiplexed connection ($mode)\"\n\t${SSH} -F $OBJ/ssh_config -S $CTL -n $mode otherhost \\\n                exec sh -c \\'\"sleep 2; exec > /dev/null 2>&1; sleep 3; exit $s\"\\'\n\tr=$?\n\tif [ $r -ne $s ]; then\n\t\tfail \"exit code (with sleep) mismatch: $r != $s\"\n\tfi\n   done\ndone\n\nverbose \"test $tid: cmd check\"\n${SSH} -F $OBJ/ssh_config -S $CTL -Ocheck otherhost >>$TEST_REGRESS_LOGFILE 2>&1 \\\n    || fail \"check command failed\" \n\nverbose \"test $tid: cmd forward local (TCP)\"\n${SSH} -F $OBJ/ssh_config -S $CTL -Oforward -L $P:localhost:$PORT otherhost \\\n     || fail \"request local forward failed\"\nsleep 1  # XXX remove once race fixed\n${SSH} -F $OBJ/ssh_config -p$P otherhost true \\\n     || fail \"connect to local forward port failed\"\n${SSH} -F $OBJ/ssh_config -S $CTL -Ocancel -L $P:localhost:$PORT otherhost \\\n     || fail \"cancel local forward failed\"\n${SSH} -F $OBJ/ssh_config -p$P otherhost true \\\n     && fail \"local forward port still listening\"\n\nverbose \"test $tid: cmd forward remote (TCP)\"\n${SSH} -F $OBJ/ssh_config -S $CTL -Oforward -R $P:localhost:$PORT otherhost \\\n     || fail \"request remote forward failed\"\nsleep 1  # XXX remove once race fixed\n${SSH} -F $OBJ/ssh_config -p$P otherhost true \\\n     || fail \"connect to remote forwarded port failed\"\n${SSH} -F $OBJ/ssh_config -S $CTL -Ocancel -R $P:localhost:$PORT otherhost \\\n     || fail \"cancel remote forward failed\"\n${SSH} -F $OBJ/ssh_config -p$P otherhost true \\\n     && fail \"remote forward port still listening\"\n\nverbose \"test $tid: cmd forward local (UNIX)\"\n${SSH} -F $OBJ/ssh_config -S $CTL -Oforward -L $OBJ/unix-1.fwd:localhost:$PORT otherhost \\\n     || fail \"request local forward failed\"\nsleep 1  # XXX remove once race fixed\necho \"\" | $NC -U $OBJ/unix-1.fwd | \\\n    grep \"Invalid SSH identification string\" >/dev/null 2>&1 \\\n     || fail \"connect to local forward path failed\"\n${SSH} -F $OBJ/ssh_config -S $CTL -Ocancel -L $OBJ/unix-1.fwd:localhost:$PORT otherhost \\\n     || fail \"cancel local forward failed\"\nN=$(echo \"xyzzy\" | $NC -U $OBJ/unix-1.fwd 2>&1 | grep \"xyzzy\" | wc -l)\ntest ${N} -eq 0 || fail \"local forward path still listening\"\nrm -f $OBJ/unix-1.fwd\n\nverbose \"test $tid: cmd forward remote (UNIX)\"\n${SSH} -F $OBJ/ssh_config -S $CTL -Oforward -R $OBJ/unix-1.fwd:localhost:$PORT otherhost \\\n     || fail \"request remote forward failed\"\nsleep 1  # XXX remove once race fixed\necho \"\" | $NC -U $OBJ/unix-1.fwd | \\\n    grep \"Invalid SSH identification string\" >/dev/null 2>&1 \\\n     || fail \"connect to remote forwarded path failed\"\n${SSH} -F $OBJ/ssh_config -S $CTL -Ocancel -R $OBJ/unix-1.fwd:localhost:$PORT otherhost \\\n     || fail \"cancel remote forward failed\"\nN=$(echo \"xyzzy\" | $NC -U $OBJ/unix-1.fwd 2>&1 | grep \"xyzzy\" | wc -l)\ntest ${N} -eq 0 || fail \"remote forward path still listening\"\nrm -f $OBJ/unix-1.fwd\n\nverbose \"test $tid: cmd exit\"\n${SSH} -F $OBJ/ssh_config -S $CTL -Oexit otherhost >>$TEST_REGRESS_LOGFILE 2>&1 \\\n    || fail \"send exit command failed\" \n\n# Wait for master to exit\nwait $SSH_PID\nkill -0 $SSH_PID >/dev/null 2>&1 && fail \"exit command failed\"\n\n# Restart master and test -O stop command with master using -N\nverbose \"test $tid: cmd stop\"\ntrace \"restart master, fork to background\"\nstart_mux_master\n\n# start a long-running command then immediately request a stop\n${SSH} -F $OBJ/ssh_config -S $CTL otherhost \"sleep 10; exit 0\" \\\n     >>$TEST_REGRESS_LOGFILE 2>&1 &\nSLEEP_PID=$!\n${SSH} -F $OBJ/ssh_config -S $CTL -Ostop otherhost >>$TEST_REGRESS_LOGFILE 2>&1 \\\n    || fail \"send stop command failed\"\n\n# wait until both long-running command and master have exited.\nwait $SLEEP_PID\n[ $! != 0 ] || fail \"waiting for concurrent command\"\nwait $SSH_PID\n[ $! != 0 ] || fail \"waiting for master stop\"\nkill -0 $SSH_PID >/dev/null 2>&1 && fatal \"stop command failed\"\nSSH_PID=\"\" # Already gone, so don't kill in cleanup\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}