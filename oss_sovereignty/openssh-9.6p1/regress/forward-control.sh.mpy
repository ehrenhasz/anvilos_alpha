{
  "module_name": "forward-control.sh",
  "hash_id": "2d2435a78218b88719c766204b00908e5ed3435a7dc3ef4c69e22d375dad78ef",
  "original_prompt": "Ingested from openssh-9.6p1/regress/forward-control.sh",
  "human_readable_source": "#\t$OpenBSD: forward-control.sh,v 1.12 2023/07/28 05:33:15 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"sshd control of local and remote forwarding\"\n\nLFWD_PORT=3320\nRFWD_PORT=3321\nCTL=$OBJ/ctl-sock\nWAIT_SECONDS=20\n\nwait_for_process_to_exit() {\n\t_pid=$1\n\t_n=0\n\twhile kill -0 $_pid 2>/dev/null ; do\n\t\ttest $_n -eq 1 && trace \"waiting for $_pid to exit\"\n\t\t_n=`expr $_n + 1`\n\t\ttest $_n -ge $WAIT_SECONDS && return 1\n\t\tsleep 1\n\tdone\n\treturn 0\n}\n\nmux_cmd() {\n\t${SSH} -F $OBJ/ssh_proxy -S $CTL -O $1 host 2>&1\n}\n\ncontrolmaster_pid() {\n\tmux_cmd check | cut -f2 -d= | cut -f1 -d')'\n}\n\n# usage: check_lfwd Y|N message\ncheck_lfwd() {\n\t_expected=$1\n\t_message=$2\n\t${SSH} -F $OBJ/ssh_proxy \\\n\t    -L$LFWD_PORT:127.0.0.1:$PORT \\\n\t    -o ExitOnForwardFailure=yes \\\n\t    -MS $CTL -o ControlPersist=yes \\\n\t    -Nf host\n\tmux_cmd check >/dev/null || fatal \"check_lfwd ssh fail: $_message\"\n\t${SSH} -F $OBJ/ssh_config -p $LFWD_PORT \\\n\t    -oConnectionAttempts=10 host true >/dev/null 2>&1\n\t_result=$?\n\t_sshpid=`controlmaster_pid`\n\tmux_cmd exit >/dev/null\n\twait_for_process_to_exit $_sshpid\n\tif test \"x$_expected\" = \"xY\" -a $_result -ne 0 ; then\n\t\tfail \"check_lfwd failed (expecting success): $_message\"\n\telif test \"x$_expected\" = \"xN\" -a $_result -eq 0 ; then\n\t\tfail \"check_lfwd succeeded (expecting failure): $_message\"\n\telif test \"x$_expected\" != \"xY\" -a \"x$_expected\" != \"xN\" ; then\n\t\tfatal \"check_lfwd invalid argument \\\"$_expected\\\"\"\n\telse\n\t\tverbose \"check_lfwd done (expecting $_expected): $_message\"\n\tfi\n}\n\n# usage: check_rfwd Y|N message\ncheck_rfwd() {\n\t_expected=$1\n\t_message=$2\n\t${SSH} -F $OBJ/ssh_proxy \\\n\t    -R127.0.0.1:$RFWD_PORT:127.0.0.1:$PORT \\\n\t    -o ExitOnForwardFailure=yes \\\n\t    -MS $CTL -o ControlPersist=yes \\\n\t    -Nf host\n\tmux_cmd check >/dev/null\n\t_result=$?\n\t_sshpid=`controlmaster_pid`\n\tif test $_result -eq 0; then\n\t\t${SSH} -F $OBJ/ssh_config -p $RFWD_PORT \\\n\t\t    -oConnectionAttempts=10 host true >/dev/null 2>&1\n\t\t_result=$?\n\t\tmux_cmd exit >/dev/null\n\t\twait_for_process_to_exit $_sshpid\n\tfi\n\tif test \"x$_expected\" = \"xY\" -a $_result -ne 0 ; then\n\t\tfail \"check_rfwd failed (expecting success): $_message\"\n\telif test \"x$_expected\" = \"xN\" -a $_result -eq 0 ; then\n\t\tfail \"check_rfwd succeeded (expecting failure): $_message\"\n\telif test \"x$_expected\" != \"xY\" -a \"x$_expected\" != \"xN\" ; then\n\t\tfatal \"check_rfwd invalid argument \\\"$_expected\\\"\"\n\telse\n\t\tverbose \"check_rfwd done (expecting $_expected): $_message\"\n\tfi\n}\n\nstart_sshd\ncp ${OBJ}/sshd_proxy ${OBJ}/sshd_proxy.bak\ncp ${OBJ}/authorized_keys_${USER} ${OBJ}/authorized_keys_${USER}.bak\n\n# Sanity check: ensure the default config allows forwarding\ncheck_lfwd Y \"default configuration\"\ncheck_rfwd Y \"default configuration\"\n\n# Usage: lperm_tests yes|local|remote|no Y|N Y|N Y|N Y|N Y|N Y|N\nlperm_tests() {\n\t_tcpfwd=$1\n\t_plain_lfwd=$2\n\t_plain_rfwd=$3\n\t_nopermit_lfwd=$4\n\t_nopermit_rfwd=$5\n\t_permit_lfwd=$6\n\t_permit_rfwd=$7\n\t_badfwd1=127.0.0.1:22\n\t_badfwd2=127.0.0.2:22\n\t_goodfwd=127.0.0.1:${PORT}\n\tcp ${OBJ}/authorized_keys_${USER}.bak  ${OBJ}/authorized_keys_${USER}\n\t_prefix=\"AllowTcpForwarding=$_tcpfwd\"\n\n\t# No PermitOpen\n\t( cat ${OBJ}/sshd_proxy.bak ;\n\t  echo \"AllowTcpForwarding $_tcpfwd\" ) \\\n\t    > ${OBJ}/sshd_proxy\n\tcheck_lfwd $_plain_lfwd \"$_prefix\"\n\tcheck_rfwd $_plain_rfwd \"$_prefix\"\n\n\t# PermitOpen via sshd_config that doesn't match\n\t( cat ${OBJ}/sshd_proxy.bak ;\n\t  echo \"AllowTcpForwarding $_tcpfwd\" ;\n\t  echo \"PermitOpen $_badfwd1 $_badfwd2\" ) \\\n\t    > ${OBJ}/sshd_proxy\n\tcheck_lfwd $_nopermit_lfwd \"$_prefix, !PermitOpen\"\n\tcheck_rfwd $_nopermit_rfwd \"$_prefix, !PermitOpen\"\n\t# PermitOpen via sshd_config that does match\n\t( cat ${OBJ}/sshd_proxy.bak ;\n\t  echo \"AllowTcpForwarding $_tcpfwd\" ;\n\t  echo \"PermitOpen $_badfwd1 $_goodfwd $_badfwd2\" ) \\\n\t    > ${OBJ}/sshd_proxy\n\tcheck_lfwd $_plain_lfwd \"$_prefix, PermitOpen\"\n\tcheck_rfwd $_plain_rfwd \"$_prefix, PermitOpen\"\n\n\t# permitopen keys option.\n\t# NB. permitopen via authorized_keys should have same\n\t# success/fail as via sshd_config\n\t# permitopen via authorized_keys that doesn't match\n\tsed \"s/^/permitopen=\\\"$_badfwd1\\\",permitopen=\\\"$_badfwd2\\\" /\" \\\n\t    < ${OBJ}/authorized_keys_${USER}.bak \\\n\t    > ${OBJ}/authorized_keys_${USER} || fatal \"sed 1 fail\"\n\t( cat ${OBJ}/sshd_proxy.bak ;\n\t  echo \"AllowTcpForwarding $_tcpfwd\" ) \\\n\t    > ${OBJ}/sshd_proxy\n\tcheck_lfwd $_nopermit_lfwd \"$_prefix, !permitopen\"\n\tcheck_rfwd $_nopermit_rfwd \"$_prefix, !permitopen\"\n\t# permitopen via authorized_keys that does match\n\tsed \"s/^/permitopen=\\\"$_badfwd1\\\",permitopen=\\\"$_goodfwd\\\" /\" \\\n\t    < ${OBJ}/authorized_keys_${USER}.bak \\\n\t    > ${OBJ}/authorized_keys_${USER} || fatal \"sed 2 fail\"\n\t( cat ${OBJ}/sshd_proxy.bak ;\n\t  echo \"AllowTcpForwarding $_tcpfwd\" ) \\\n\t    > ${OBJ}/sshd_proxy\n\tcheck_lfwd $_permit_lfwd \"$_prefix, permitopen\"\n\tcheck_rfwd $_permit_rfwd \"$_prefix, permitopen\"\n\n\t# Check port-forwarding flags in authorized_keys.\n\t# These two should refuse all.\n\tsed \"s/^/no-port-forwarding /\" \\\n\t    < ${OBJ}/authorized_keys_${USER}.bak \\\n\t    > ${OBJ}/authorized_keys_${USER} || fatal \"sed 3 fail\"\n\t( cat ${OBJ}/sshd_proxy.bak ;\n\t  echo \"AllowTcpForwarding $_tcpfwd\" ) \\\n\t    > ${OBJ}/sshd_proxy\n\tcheck_lfwd N \"$_prefix, no-port-forwarding\"\n\tcheck_rfwd N \"$_prefix, no-port-forwarding\"\n\tsed \"s/^/restrict /\" \\\n\t    < ${OBJ}/authorized_keys_${USER}.bak \\\n\t    > ${OBJ}/authorized_keys_${USER} || fatal \"sed 4 fail\"\n\t( cat ${OBJ}/sshd_proxy.bak ;\n\t  echo \"AllowTcpForwarding $_tcpfwd\" ) \\\n\t    > ${OBJ}/sshd_proxy\n\tcheck_lfwd N \"$_prefix, restrict\"\n\tcheck_rfwd N \"$_prefix, restrict\"\n\t# This should pass the same cases as _nopermit*\n\tsed \"s/^/restrict,port-forwarding /\" \\\n\t    < ${OBJ}/authorized_keys_${USER}.bak \\\n\t    > ${OBJ}/authorized_keys_${USER} || fatal \"sed 5 fail\"\n\t( cat ${OBJ}/sshd_proxy.bak ;\n\t  echo \"AllowTcpForwarding $_tcpfwd\" ) \\\n\t    > ${OBJ}/sshd_proxy\n\tcheck_lfwd $_plain_lfwd \"$_prefix, restrict,port-forwarding\"\n\tcheck_rfwd $_plain_rfwd \"$_prefix, restrict,port-forwarding\"\n}\n\n#          permit-open      none          mismatch         match\n#   AllowTcpForwarding  local remote    local remote    local remote\nlperm_tests     yes     Y     Y         N     Y         Y     Y\nlperm_tests   local     Y     N         N     N         Y     N\nlperm_tests  remote     N     Y         N     Y         N     Y\nlperm_tests      no     N     N         N     N         N     N\n\n# Usage: rperm_tests yes|local|remote|no Y|N Y|N Y|N Y|N Y|N Y|N\nrperm_tests() {\n\t_tcpfwd=$1\n\t_plain_lfwd=$2\n\t_plain_rfwd=$3\n\t_nopermit_lfwd=$4\n\t_nopermit_rfwd=$5\n\t_permit_lfwd=$6\n\t_permit_rfwd=$7\n\t_badfwd1=127.0.0.1:22\n\t_badfwd2=127.0.0.2:${RFWD_PORT}\n\t_goodfwd=127.0.0.1:${RFWD_PORT}\n\tcp ${OBJ}/authorized_keys_${USER}.bak  ${OBJ}/authorized_keys_${USER}\n\t_prefix=\"AllowTcpForwarding=$_tcpfwd\"\n\n\t# PermitListen via sshd_config that doesn't match\n\t( cat ${OBJ}/sshd_proxy.bak ;\n\t  echo \"AllowTcpForwarding $_tcpfwd\" ;\n\t  echo \"PermitListen $_badfwd1 $_badfwd2\" ) \\\n\t    > ${OBJ}/sshd_proxy\n\tcheck_lfwd $_nopermit_lfwd \"$_prefix, !PermitListen\"\n\tcheck_rfwd $_nopermit_rfwd \"$_prefix, !PermitListen\"\n\t# PermitListen via sshd_config that does match\n\t( cat ${OBJ}/sshd_proxy.bak ;\n\t  echo \"AllowTcpForwarding $_tcpfwd\" ;\n\t  echo \"PermitListen $_badfwd1 $_goodfwd $_badfwd2\" ) \\\n\t    > ${OBJ}/sshd_proxy\n\tcheck_lfwd $_plain_lfwd \"$_prefix, PermitListen\"\n\tcheck_rfwd $_plain_rfwd \"$_prefix, PermitListen\"\n}\n\n#   permit-remote-open      none          mismatch         match\n#   AllowTcpForwarding  local remote    local remote    local remote\nrperm_tests     yes     Y     Y         Y     N         Y     Y\nrperm_tests   local     Y     N         Y     N         Y     N\nrperm_tests  remote     N     Y         N     N         N     Y\nrperm_tests      no     N     N         N     N         N     N\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}