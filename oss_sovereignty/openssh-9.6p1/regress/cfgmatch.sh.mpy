{
  "module_name": "cfgmatch.sh",
  "hash_id": "83d7a9605aa1877f48f4cac103b14d7ea729db12f547969468861e8988b448c0",
  "original_prompt": "Ingested from openssh-9.6p1/regress/cfgmatch.sh",
  "human_readable_source": "#\t$OpenBSD: cfgmatch.sh,v 1.13 2021/06/08 06:52:43 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"sshd_config match\"\n\npidfile=$OBJ/remote_pid\nfwdport=3301\nfwd=\"-L $fwdport:127.0.0.1:$PORT\"\n\necho \"ExitOnForwardFailure=yes\" >> $OBJ/ssh_config\necho \"ExitOnForwardFailure=yes\" >> $OBJ/ssh_proxy\n\nstart_client()\n{\n\trm -f $pidfile\n\t${SSH} -q $fwd \"$@\" somehost \\\n\t    exec sh -c \\'\"echo \\$\\$ > $pidfile; exec sleep 100\"\\' \\\n\t    >>$TEST_REGRESS_LOGFILE 2>&1 &\n\tclient_pid=$!\n\t# Wait for remote end\n\tn=0\n\twhile test ! -f $pidfile ; do\n\t\tsleep 1\n\t\tn=`expr $n + 1`\n\t\tif test $n -gt 60; then\n\t\t\tkill $client_pid\n\t\t\tfatal \"timeout waiting for background ssh\"\n\t\tfi\n\tdone\t\n}\n\nstop_client()\n{\n\tpid=`cat $pidfile`\n\tif [ ! -z \"$pid\" ]; then\n\t\tkill $pid\n\tfi\n\twait\n}\n\ncp $OBJ/sshd_proxy $OBJ/sshd_proxy_bak\necho \"PermitOpen 127.0.0.1:1 # comment\" >>$OBJ/sshd_config\necho \"Match Address 127.0.0.1\" >>$OBJ/sshd_config\necho \"PermitOpen 127.0.0.1:2 127.0.0.1:3 127.0.0.1:$PORT\" >>$OBJ/sshd_config\n\ngrep -v AuthorizedKeysFile $OBJ/sshd_proxy_bak > $OBJ/sshd_proxy\necho \"AuthorizedKeysFile /dev/null # comment\" >>$OBJ/sshd_proxy\necho \"PermitOpen 127.0.0.1:1\" >>$OBJ/sshd_proxy\necho \"Match user $USER\" >>$OBJ/sshd_proxy\necho \"AuthorizedKeysFile /dev/null $OBJ/authorized_keys_%u\" >>$OBJ/sshd_proxy\necho \"Match Address 127.0.0.1 # comment\" >>$OBJ/sshd_proxy\necho \"PermitOpen 127.0.0.1:2 127.0.0.1:3 127.0.0.1:$PORT\" >>$OBJ/sshd_proxy\n\n${SUDO} ${SSHD} -f $OBJ/sshd_config -T >/dev/null || \\\n    fail \"config w/match fails config test\"\n\nstart_sshd\n\n# Test Match + PermitOpen in sshd_config.  This should be permitted\ntrace \"match permitopen localhost\"\nstart_client -F $OBJ/ssh_config\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true || \\\n    fail \"match permitopen permit\"\nstop_client\n\n# Same but from different source.  This should not be permitted\ntrace \"match permitopen proxy\"\nstart_client -F $OBJ/ssh_proxy\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true && \\\n    fail \"match permitopen deny\"\nstop_client\n\n# Retry previous with key option, should also be denied.\ncp /dev/null $OBJ/authorized_keys_$USER\nfor t in ${SSH_KEYTYPES}; do\n\tprintf 'permitopen=\"127.0.0.1:'$PORT'\" ' >> $OBJ/authorized_keys_$USER\n\tcat $OBJ/$t.pub >> $OBJ/authorized_keys_$USER\ndone\ntrace \"match permitopen proxy w/key opts\"\nstart_client -F $OBJ/ssh_proxy\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true && \\\n    fail \"match permitopen deny w/key opt\"\nstop_client\n\n# Test both sshd_config and key options permitting the same dst/port pair.\n# Should be permitted.\ntrace \"match permitopen localhost\"\nstart_client -F $OBJ/ssh_config\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true || \\\n    fail \"match permitopen permit\"\nstop_client\n\ncp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\necho \"PermitOpen 127.0.0.1:1 127.0.0.1:$PORT 127.0.0.2:2\" >>$OBJ/sshd_proxy\necho \"Match User $USER\" >>$OBJ/sshd_proxy\necho \"PermitOpen 127.0.0.1:1 127.0.0.1:2\" >>$OBJ/sshd_proxy\n\n# Test that a Match overrides a PermitOpen in the global section\ntrace \"match permitopen proxy w/key opts\"\nstart_client -F $OBJ/ssh_proxy\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true && \\\n    fail \"match override permitopen\"\nstop_client\n\ncp $OBJ/sshd_proxy_bak $OBJ/sshd_proxy\necho \"PermitOpen 127.0.0.1:1 127.0.0.1:$PORT 127.0.0.2:2\" >>$OBJ/sshd_proxy\necho \"Match User NoSuchUser\" >>$OBJ/sshd_proxy\necho \"PermitOpen 127.0.0.1:1 127.0.0.1:2\" >>$OBJ/sshd_proxy\n\n# Test that a rule that doesn't match doesn't override, plus test a\n# PermitOpen entry that's not at the start of the list\ntrace \"nomatch permitopen proxy w/key opts\"\nstart_client -F $OBJ/ssh_proxy\n${SSH} -q -p $fwdport -F $OBJ/ssh_config somehost true || \\\n    fail \"nomatch override permitopen\"\nstop_client\n\n# Test parsing of available Match criteria (with the exception of Group which\n# requires knowledge of actual group memberships user running the test).\nparams=\"user:user:u1 host:host:h1 address:addr:1.2.3.4 \\\n    localaddress:laddr:5.6.7.8 rdomain:rdomain:rdom1\"\ncp $OBJ/sshd_proxy_bak $OBJ/sshd_config\necho 'Banner /nomatch' >>$OBJ/sshd_config\nfor i in $params; do\n\tconfig=`echo $i | cut -f1 -d:`\n\tcriteria=`echo $i | cut -f2 -d:`\n\tvalue=`echo $i | cut -f3 -d:`\n\tcat >>$OBJ/sshd_config <<EOD\n\t    Match $config $value\n\t      Banner /$value\nEOD\ndone\n\n${SUDO} ${SSHD} -f $OBJ/sshd_config -T >/dev/null || \\\n    fail \"validate config for w/out spec\"\n\n# Test matching each criteria.\nfor i in $params; do\n\ttestcriteria=`echo $i | cut -f2 -d:`\n\texpected=/`echo $i | cut -f3 -d:`\n\tspec=\"\"\n\tfor j in $params; do\n\t\tconfig=`echo $j | cut -f1 -d:`\n\t\tcriteria=`echo $j | cut -f2 -d:`\n\t\tvalue=`echo $j | cut -f3 -d:`\n\t\tif [ \"$criteria\" = \"$testcriteria\" ]; then\n\t\t\tspec=\"$criteria=$value,$spec\"\n\t\telse\n\t\t\tspec=\"$criteria=1$value,$spec\"\n\t\tfi\n\tdone\n\ttrace \"test spec $spec\"\n\tresult=`${SUDO} ${SSHD} -f $OBJ/sshd_config -T -C \"$spec\" | \\\n\t    awk '$1==\"banner\"{print $2}'`\n\tif [ \"$result\" != \"$expected\" ]; then\n\t\tfail \"match $config expected $expected got $result\"\n\tfi\ndone\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}