{
  "module_name": "agent-pkcs11-cert.sh",
  "hash_id": "4253a76af0bbeade149e7226dff6a755629818c74fba2800f908c28e4b8fde7d",
  "original_prompt": "Ingested from openssh-9.6p1/regress/agent-pkcs11-cert.sh",
  "human_readable_source": "#\t$OpenBSD: agent-pkcs11-cert.sh,v 1.1 2023/12/18 14:50:08 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"pkcs11 agent certificate test\"\n\nSSH_AUTH_SOCK=\"$OBJ/agent.sock\"\nexport SSH_AUTH_SOCK\nLC_ALL=C\nexport LC_ALL\np11_setup || skip \"No PKCS#11 library found\"\n\nrm -f $SSH_AUTH_SOCK $OBJ/agent.log\nrm -f $OBJ/output_* $OBJ/expect_*\nrm -f $OBJ/ca*\n\ntrace \"generate CA key and certify keys\"\n$SSHKEYGEN -q -t ed25519 -C ca -N '' -f $OBJ/ca ||  fatal \"ssh-keygen CA failed\"\n$SSHKEYGEN -qs $OBJ/ca -I \"ecdsa_key\" -n $USER -z 1 ${SSH_SOFTHSM_DIR}/EC.pub ||\n\tfatal \"certify ECDSA key failed\"\n$SSHKEYGEN -qs $OBJ/ca -I \"rsa_key\" -n $USER -z 2 ${SSH_SOFTHSM_DIR}/RSA.pub ||\n\tfatal \"certify RSA key failed\"\n$SSHKEYGEN -qs $OBJ/ca -I \"ca_ca\" -n $USER -z 3 $OBJ/ca.pub ||\n\tfatal \"certify CA key failed\"\n\nrm -f $SSH_AUTH_SOCK\ntrace \"start agent\"\n${SSHAGENT} ${EXTRA_AGENT_ARGS} -d -a $SSH_AUTH_SOCK > $OBJ/agent.log 2>&1 &\nAGENT_PID=$!\ntrap \"kill $AGENT_PID\" EXIT\nfor x in 0 1 2 3 4 ; do\n\t# Give it a chance to start\n\t${SSHADD} -l > /dev/null 2>&1\n\tr=$?\n\ttest $r -eq 1 && break\n\tsleep 1\ndone\nif [ $r -ne 1 ]; then\n\tfatal \"ssh-add -l did not fail with exit code 1 (got $r)\"\nfi\n\ntrace \"load pkcs11 keys and certs\"\n# Note: deliberately contains non-cert keys and non-matching cert on commandline\np11_ssh_add -qs ${TEST_SSH_PKCS11} \\\n    $OBJ/ca.pub \\\n    ${SSH_SOFTHSM_DIR}/EC.pub \\\n    ${SSH_SOFTHSM_DIR}/EC-cert.pub \\\n    ${SSH_SOFTHSM_DIR}/RSA.pub \\\n    ${SSH_SOFTHSM_DIR}/RSA-cert.pub ||\n\tfatal \"failed to add keys\"\n# Verify their presence\ncut -d' ' -f1-2 \\\n    ${SSH_SOFTHSM_DIR}/EC.pub \\\n    ${SSH_SOFTHSM_DIR}/RSA.pub \\\n    ${SSH_SOFTHSM_DIR}/EC-cert.pub \\\n    ${SSH_SOFTHSM_DIR}/RSA-cert.pub | sort > $OBJ/expect_list\n$SSHADD -L | cut -d' ' -f1-2 | sort > $OBJ/output_list\ndiff $OBJ/expect_list $OBJ/output_list\n\n# Verify that all can perform signatures.\nfor x in ${SSH_SOFTHSM_DIR}/EC.pub ${SSH_SOFTHSM_DIR}/RSA.pub \\\n    ${SSH_SOFTHSM_DIR}/EC-cert.pub ${SSH_SOFTHSM_DIR}/RSA-cert.pub ; do\n\t$SSHADD -T $x || fail \"Signing failed for $x\"\ndone\n\n# Delete plain keys.\n$SSHADD -qd ${SSH_SOFTHSM_DIR}/EC.pub ${SSH_SOFTHSM_DIR}/RSA.pub\n# Verify that certs can still perform signatures.\nfor x in ${SSH_SOFTHSM_DIR}/EC-cert.pub ${SSH_SOFTHSM_DIR}/RSA-cert.pub ; do\n\t$SSHADD -T $x || fail \"Signing failed for $x\"\ndone\n\n$SSHADD -qD >/dev/null || fatal \"clear agent failed\"\n\ntrace \"load pkcs11 certs only\"\np11_ssh_add -qCs ${TEST_SSH_PKCS11} \\\n    $OBJ/ca.pub \\\n    ${SSH_SOFTHSM_DIR}/EC.pub \\\n    ${SSH_SOFTHSM_DIR}/EC-cert.pub \\\n    ${SSH_SOFTHSM_DIR}/RSA.pub \\\n    ${SSH_SOFTHSM_DIR}/RSA-cert.pub ||\n\tfatal \"failed to add keys\"\n# Verify their presence\ncut -d' ' -f1-2 \\\n    ${SSH_SOFTHSM_DIR}/EC-cert.pub \\\n    ${SSH_SOFTHSM_DIR}/RSA-cert.pub | sort > $OBJ/expect_list\n$SSHADD -L | cut -d' ' -f1-2 | sort > $OBJ/output_list\ndiff $OBJ/expect_list $OBJ/output_list\n\n# Verify that certs can perform signatures.\nfor x in ${SSH_SOFTHSM_DIR}/EC-cert.pub ${SSH_SOFTHSM_DIR}/RSA-cert.pub ; do\n\t$SSHADD -T $x || fail \"Signing failed for $x\"\ndone\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}