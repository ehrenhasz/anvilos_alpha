{
  "module_name": "sshsig.sh",
  "hash_id": "894d5848e373328e8c27b412527134af4a48428962de9129601f197bd9808a38",
  "original_prompt": "Ingested from openssh-9.6p1/regress/sshsig.sh",
  "human_readable_source": "#\t$OpenBSD: sshsig.sh,v 1.15 2023/10/12 03:51:08 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"sshsig\"\n\nDATA2=$OBJ/${DATANAME}.2\ncat ${DATA} ${DATA} > ${DATA2}\n\nrm -f $OBJ/sshsig-*.sig $OBJ/wrong-key* $OBJ/sigca-key*\n\nsig_namespace=\"test-$$\"\nsig_principal=\"user-$$@example.com\"\n\n# Make a \"wrong key\"\n${SSHKEYGEN} -q -t ed25519 -f $OBJ/wrong-key \\\n\t-C \"wrong trousers, Grommit\" -N '' \\\n\t|| fatal \"couldn't generate key\"\nWRONG=$OBJ/wrong-key.pub\n\n# Make a CA key.\n${SSHKEYGEN} -q -t ed25519 -f $OBJ/sigca-key -C \"CA\" -N '' \\\n\t|| fatal \"couldn't generate key\"\nCA_PRIV=$OBJ/sigca-key\nCA_PUB=$OBJ/sigca-key.pub\n\ntrace \"start agent\"\neval `${SSHAGENT} ${EXTRA_AGENT_ARGS} -s` > /dev/null\nr=$?\nif [ $r -ne 0 ]; then\n\tfatal \"could not start ssh-agent: exit code $r\"\nfi\n\nSIGNKEYS=\"$SSH_KEYTYPES\"\nverbose \"$tid: make certificates\"\nfor t in $SSH_KEYTYPES ; do\n\t${SSHKEYGEN} -q -s $CA_PRIV -z $$ \\\n\t    -I \"regress signature key for $USER\" \\\n\t\t-V \"19840101:19860101\" \\\n\t    -n $sig_principal $OBJ/${t} || \\\n\t\tfatal \"couldn't sign ${t}\"\n\tSIGNKEYS=\"$SIGNKEYS ${t}-cert.pub\"\ndone\n\nfor t in $SIGNKEYS; do\n\tverbose \"$tid: check signature for $t\"\n\tkeybase=`basename $t .pub`\n\tprivkey=${OBJ}/`basename $t -cert.pub`\n\tsigfile=${OBJ}/sshsig-${keybase}.sig\n\tsigfile_agent=${OBJ}/sshsig-agent-${keybase}.sig\n\tpubkey=${OBJ}/${keybase}.pub\n\tcert=${OBJ}/${keybase}-cert.pub\n\tsigfile_cert=${OBJ}/sshsig-${keybase}-cert.sig\n\n\ttrace \"$tid: key type $t check bad hashlg\"\n\t${SSHKEYGEN} -vvv -Y sign -f ${OBJ}/$t -n $sig_namespace \\\n\t    -Ohashalg=sha1 < $DATA > $sigfile 2>/dev/null && \\\n\t\tfail \"sign using $t with bad hash algorithm succeeded\"\n\n\tfor h in default sha256 sha512 ; do\n\t\tcase \"$h\" in\n\t\tdefault) hashalg_arg=\"\" ;;\n\t\t*) hashalg_arg=\"-Ohashalg=$h\" ;;\n\t\tesac\n\t\ttrace \"$tid: key type $t sign with hash $h\"\n\t\t${SSHKEYGEN} -vvv -Y sign -f ${OBJ}/$t -n $sig_namespace \\\n\t\t    $hashalg_arg < $DATA > $sigfile 2>/dev/null || \\\n\t\t\tfail \"sign using $t / $h failed\"\n\t\t(printf \"$sig_principal \" ; cat $pubkey) > $OBJ/allowed_signers\n\t\ttrace \"$tid: key type $t verify with hash $h\"\n\t\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t    -I $sig_principal -f $OBJ/allowed_signers \\\n\t\t    < $DATA >/dev/null 2>&1 || \\\n\t\t\tfail \"failed signature for $t / $h key\"\n\tdone\n\n\ttrace \"$tid: key type $t verify with limited namespace\"\n\t(printf \"$sig_principal namespaces=\\\"$sig_namespace,whatever\\\" \";\n\t cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 || \\\n\t\tfail \"failed signature for $t key w/ limited namespace\"\n\n\ttrace \"$tid: key type $t print-pubkey\"\n\t(printf \"$sig_principal namespaces=\\\"$sig_namespace,whatever\\\" \";\n\t cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -q -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-O print-pubkey \\\n\t\t< $DATA | cut -d' ' -f1-2 > ${OBJ}/${keybase}-fromsig.pub || \\\n\t\tfail \"failed signature for $t key w/ print-pubkey\"\n\tcut -d' ' -f1-2 ${OBJ}/${keybase}.pub > ${OBJ}/${keybase}-strip.pub\n\tdiff -r ${OBJ}/${keybase}-strip.pub ${OBJ}/${keybase}-fromsig.pub || \\\n\t\tfail \"print-pubkey differs from signature key\"\n\n\t# Invalid option\n\ttrace \"$tid: key type $t verify with bad signers\"\n\t(printf \"$sig_principal octopus \" ; cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t key with bad signers option\"\n\n\t# Wrong key trusted.\n\ttrace \"$tid: key type $t verify with wrong key\"\n\t(printf \"$sig_principal \" ; cat $WRONG) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t key with wrong key trusted\"\n\n\t# incorrect data\n\ttrace \"$tid: key type $t verify with wrong data\"\n\t(printf \"$sig_principal \" ; cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA2 >/dev/null 2>&1 && \\\n\t\tfail \"passed signature for wrong data with $t key\"\n\n\t# wrong principal in signers\n\ttrace \"$tid: key type $t verify with wrong principal\"\n\t(printf \"josef.k@example.com \" ; cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t key with wrong principal\"\n\n\t# wrong namespace\n\ttrace \"$tid: key type $t verify with wrong namespace\"\n\t(printf \"$sig_principal \" ; cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n COWS_COWS_COWS \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t key with wrong namespace\"\n\n\t# namespace excluded by option\n\ttrace \"$tid: key type $t verify with excluded namespace\"\n\t(printf \"$sig_principal namespaces=\\\"whatever\\\" \" ;\n\t cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t key with excluded namespace\"\n\n\t( printf \"$sig_principal \" ;\n\t  printf \"valid-after=\\\"19800101\\\",valid-before=\\\"19900101\\\" \" ;\n\t  cat $pubkey) > $OBJ/allowed_signers\n\n\t# key lifespan valid\n\ttrace \"$tid: key type $t verify with valid lifespan\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19850101 \\\n\t\t< $DATA >/dev/null 2>&1 || \\\n\t\tfail \"failed signature for $t key with valid expiry interval\"\n\t# key not yet valid\n\ttrace \"$tid: key type $t verify with not-yet-valid lifespan\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19790101 \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"failed signature for $t not-yet-valid key\"\n\t# key expired\n\ttrace \"$tid: key type $t verify with expired lifespan\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19910101 \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"failed signature for $t with expired key\"\n\t# NB. assumes we're not running this test in the 1980s\n\ttrace \"$tid: key type $t verify with expired lifespan (now)\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"failed signature for $t with expired key\"\n\n\t# key lifespan valid\n\ttrace \"$tid: key type $t find-principals with valid lifespan\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=\"19850101\" \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 || \\\n\t\tfail \"failed find-principals for $t key with valid expiry interval\"\n\t# key not yet valid\n\ttrace \"$tid: key type $t find principals with not-yet-valid lifespan\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=\"19790101\" \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 && \\\n\t\tfail \"failed find-principals for $t not-yet-valid key\"\n\t# key expired\n\ttrace \"$tid: key type $t find-principals with expired lifespan\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=\"19990101\" \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 && \\\n\t\tfail \"failed find-principals for $t with expired key\"\n\t# NB. assumes we're not running this test in the 1980s\n\ttrace \"$tid: key type $t find-principals with expired lifespan (now)\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 && \\\n\t\tfail \"failed find-principals for $t with expired key\"\n\n\t# public key in revoked keys file\n\ttrace \"$tid: key type $t verify with revoked key\"\n\tcat $pubkey > $OBJ/revoked_keys\n\t(printf \"$sig_principal namespaces=\\\"whatever\\\" \" ;\n\t cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-r $OBJ/revoked_keys \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t key, but key is in revoked_keys\"\n\n\t# public key not revoked, but others are present in revoked_keysfile\n\ttrace \"$tid: key type $t verify with unrevoked key\"\n\tcat $WRONG > $OBJ/revoked_keys\n\t(printf \"$sig_principal \" ; cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-r $OBJ/revoked_keys \\\n\t\t< $DATA >/dev/null 2>&1 || \\\n\t\tfail \"couldn't verify signature for $t key, but key not in revoked_keys\"\n\n\t# check-novalidate with valid data\n\ttrace \"$tid: key type $t check-novalidate with valid data\"\n\t${SSHKEYGEN} -vvv -Y check-novalidate -s $sigfile -n $sig_namespace \\\n\t\t< $DATA >/dev/null 2>&1 || \\\n\t\tfail \"failed to check valid signature for $t key\"\n\n\t# check-novalidate with invalid data\n\ttrace \"$tid: key type $t check-novalidate with invalid data\"\n\t${SSHKEYGEN} -vvv -Y check-novalidate -s $sigfile -n $sig_namespace \\\n\t\t< $DATA2 >/dev/null 2>&1 && \\\n\t\tfail \"succeeded checking signature for $t key with invalid data\"\n\n\t# find-principals with valid public key\n\ttrace \"$tid: key type $t find-principals with valid key\"\n\t(printf \"$sig_principal \" ; cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile -f $OBJ/allowed_signers >/dev/null 2>&1 || \\\n\t\tfail \"failed to find valid principals in allowed_signers\"\n\n\t# find-principals with wrong key not in allowed_signers\n\ttrace \"$tid: key type $t find-principals with wrong key\"\n\t(printf \"$sig_principal \" ; cat $WRONG) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile -f $OBJ/allowed_signers >/dev/null 2>&1 && \\\n\t\tfail \"succeeded finding principal with invalid signers file\"\n\n\t# find-principals with a configured namespace but none on command-line\n\ttrace \"$tid: key type $t find-principals with missing namespace\"\n\t(printf \"$sig_principal \" ;\n\t printf \"namespaces=\\\"test1,test2\\\" \";\n\t cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t    -f $OBJ/allowed_signers >/dev/null 2>&1 || \\\n\t\tfail \"failed finding principal when namespaces are configured\"\n\n\t# Check signing keys using ssh-agent.\n\ttrace \"$tid: key type $t prepare agent\"\n\t${SSHADD} -D >/dev/null 2>&1 # Remove all previously-loaded keys.\n\t${SSHADD} ${privkey} > /dev/null 2>&1 || fail \"ssh-add failed\"\n\n\t# Move private key to ensure agent key is used\n\tmv ${privkey} ${privkey}.tmp\n\n\ttrace \"$tid: key type $t sign with agent\"\n\t${SSHKEYGEN} -vvv -Y sign -f $pubkey -n $sig_namespace \\\n\t\t< $DATA > $sigfile_agent 2>/dev/null || \\\n\t\tfail \"ssh-agent based sign using $pubkey failed\"\n\ttrace \"$tid: key type $t check signature w/ agent\"\n\t${SSHKEYGEN} -vvv -Y check-novalidate -s $sigfile_agent \\\n\t\t-n $sig_namespace < $DATA >/dev/null 2>&1 || \\\n\t\tfail \"failed to check valid signature for $t key\"\n\t(printf \"$sig_principal namespaces=\\\"$sig_namespace,whatever\\\" \";\n\t cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile_agent -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 || \\\n\t\tfail \"failed signature for $t key w/ limited namespace\"\n\n\t# Move private key back\n\tmv ${privkey}.tmp ${privkey}\n\n\t# Duplicate principals & keys in allowed_signers but with different validities\n\t( printf \"$sig_principal \" ;\n\t  printf \"valid-after=\\\"19800101\\\",valid-before=\\\"19900101\\\" \" ;\n\t  cat $pubkey;\n\t  printf \"${sig_principal} \" ;\n\t  printf \"valid-after=\\\"19850101\\\",valid-before=\\\"20000101\\\" \" ;\n\t  cat $pubkey) > $OBJ/allowed_signers\n\n\t# find-principals outside of any validity lifespan\n\ttrace \"$tid: key type $t find principals outside multiple validities\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=\"20100101\" \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 && \\\n\t\tfail \"succeeded find-principals for $t verify-time outside of validity\"\n\t# find-principals matching only the first lifespan\n\ttrace \"$tid: key type $t find principals matching one validity (1st)\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=\"19830101\" \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 || \\\n\t\tfail \"failed find-principals for $t verify-time within first span\"\n\t# find-principals matching both lifespans\n\ttrace \"$tid: key type $t find principals matching two validities\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=\"19880101\" \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 || \\\n\t\tfail \"failed find-principals for $t verify-time within both spans\"\n\t# find-principals matching only the second lifespan\n\ttrace \"$tid: key type $t find principals matching one validity (2nd)\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=\"19950101\" \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 || \\\n\t\tfail \"failed find-principals for $t verify-time within second span\"\n\n\t# verify outside of any validity lifespan\n\ttrace \"$tid: key type $t verify outside multiple validities\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-Overify-time=\"20100101\" -I $sig_principal \\\n\t\t-r $OBJ/revoked_keys -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"succeeded verify for $t verify-time outside of validity\"\n\t# verify matching only the first lifespan\n\ttrace \"$tid: key type $t verify matching one validity (1st)\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-Overify-time=\"19830101\" -I $sig_principal \\\n\t\t-r $OBJ/revoked_keys -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 || \\\n\t\tfail \"failed verify for $t verify-time within first span\"\n\t# verify matching both lifespans\n\ttrace \"$tid: key type $t verify matching two validities\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-Overify-time=\"19880101\" -I $sig_principal \\\n\t\t-r $OBJ/revoked_keys -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 || \\\n\t\tfail \"failed verify for $t verify-time within both spans\"\n\t# verify matching only the second lifespan\n\ttrace \"$tid: key type $t verify matching one validity (2nd)\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-Overify-time=\"19950101\" -I $sig_principal \\\n\t\t-r $OBJ/revoked_keys -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 || \\\n\t\tfail \"failed verify for $t verify-time within second span\"\n\n\t# Remaining tests are for certificates only.\n\tcase \"$keybase\" in\n\t\t*-cert) ;;\n\t\t*) continue ;;\n\tesac\n\n\t# Check key lifespan on find-principals when using the CA\n\t( printf \"$sig_principal \" ;\n\t  printf \"cert-authority,valid-after=\\\"19800101\\\",valid-before=\\\"19900101\\\" \";\n\t  cat $CA_PUB) > $OBJ/allowed_signers\n\t# key lifespan valid\n\ttrace \"$tid: key type $t find-principals cert lifetime valid\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=\"19850101\" \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 || \\\n\t\tfail \"failed find-principals for $t key with valid expiry interval\"\n\t# key not yet valid\n\ttrace \"$tid: key type $t find-principals cert lifetime not-yet-valid\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=\"19790101\" \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 && \\\n\t\tfail \"failed find-principals for $t not-yet-valid key\"\n\t# key expired\n\ttrace \"$tid: key type $t find-principals cert lifetime expired\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=\"19990101\" \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 && \\\n\t\tfail \"failed find-principals for $t with expired key\"\n\t# NB. assumes we're not running this test in the 1980s\n\ttrace \"$tid: key type $t find-principals cert lifetime expired (now)\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 && \\\n\t\tfail \"failed find-principals for $t with expired key\"\n\n\t# correct CA key\n\ttrace \"$tid: key type $t verify cert good CA\"\n\t(printf \"$sig_principal cert-authority \" ;\n\t cat $CA_PUB) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19850101 \\\n\t\t< $DATA >/dev/null 2>&1 || \\\n\t\tfail \"failed signature for $t cert\"\n\n\t# find-principals\n\ttrace \"$tid: key type $t find-principals cert good CA\"\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=19850101 \\\n\t\t-f $OBJ/allowed_signers >/dev/null 2>&1 || \\\n\t\tfail \"failed find-principals for $t with ca key\"\n\n\t# CA with wildcard principal\n\ttrace \"$tid: key type $t find-principals cert good wildcard CA\"\n\t(printf \"*@example.com cert-authority \" ;\n\t cat $CA_PUB) > $OBJ/allowed_signers\n\t# find-principals CA with wildcard principal\n\t${SSHKEYGEN} -vvv -Y find-principals -s $sigfile \\\n\t\t-Overify-time=19850101 \\\n\t\t-f $OBJ/allowed_signers 2>/dev/null | \\\n\t\tfgrep \"$sig_principal\" >/dev/null || \\\n\t\tfail \"failed find-principals for $t with ca key using wildcard principal\"\n\n\t# verify CA with wildcard principal\n\ttrace \"$tid: key type $t verify cert good wildcard CA\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19850101 \\\n\t\t< $DATA >/dev/null 2>&1 || \\\n\t\tfail \"failed signature for $t cert using wildcard principal\"\n\n\t# signing key listed as cert-authority\n\ttrace \"$tid: key type $t verify signing key listed as CA\"\n\t(printf \"$sig_principal cert-authority \" ;\n\t cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature with $t key listed as CA\"\n\n\t# CA key not flagged cert-authority\n\ttrace \"$tid: key type $t verify key not marked as CA\"\n\t(printf \"$sig_principal \" ; cat $CA_PUB) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t cert with CA not marked\"\n\n\t# mismatch between cert principal and file\n\ttrace \"$tid: key type $t verify cert with wrong principal\"\n\t(printf \"josef.k@example.com cert-authority \" ;\n\t cat $CA_PUB) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t cert with wrong principal\"\n\n\t# Cert valid but CA revoked\n\ttrace \"$tid: key type $t verify cert with revoked CA\"\n\tcat $CA_PUB > $OBJ/revoked_keys\n\t(printf \"$sig_principal \" ; cat $pubkey) > $OBJ/allowed_signers\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-r $OBJ/revoked_keys \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t key, but CA key in revoked_keys\"\n\n\t# Set lifespan of CA key and verify signed user certs behave accordingly\n\t( printf \"$sig_principal \" ;\n\t  printf \"cert-authority,valid-after=\\\"19800101\\\",valid-before=\\\"19900101\\\" \" ;\n\t  cat $CA_PUB) > $OBJ/allowed_signers\n\n\t# CA key lifespan valid\n\ttrace \"$tid: key type $t verify cert valid CA lifespan\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19850101 \\\n\t\t< $DATA >/dev/null 2>&1 >/dev/null 2>&1 || \\\n\t\tfail \"failed signature for $t key with valid CA expiry interval\"\n\t# CA lifespan is valid but user key not yet valid\n\ttrace \"$tid: key type $t verify cert valid CA lifespan, not-yet-valid cert\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19810101 \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t key with valid CA expiry interval but not yet valid cert\"\n\t# CA lifespan is valid but user key expired\n\ttrace \"$tid: key type $t verify cert valid CA lifespan, expired cert\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19890101 \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t key with valid CA expiry interval but expired cert\"\n\t# CA key not yet valid\n\ttrace \"$tid: key type $t verify cert CA not-yet-valid\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19790101 \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t not-yet-valid CA key\"\n\t# CA key expired\n\ttrace \"$tid: key type $t verify cert CA expired\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19910101 \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t with expired CA key\"\n\t# NB. assumes we're not running this test in the 1980s\n\ttrace \"$tid: key type $t verify cert CA expired (now)\"\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t with expired CA key\"\n\n\t# Set lifespan of CA outside of the cert validity\n\ttrace \"$tid: key type $t verify CA/cert lifespan mismatch\"\n\t( printf \"$sig_principal \" ;\n\t  printf \"cert-authority,valid-after=\\\"19800101\\\",valid-before=\\\"19820101\\\" \" ;\n\t  cat $CA_PUB) > $OBJ/allowed_signers\n\t# valid cert validity but expired CA\n\t${SSHKEYGEN} -vvv -Y verify -s $sigfile -n $sig_namespace \\\n\t\t-I $sig_principal -f $OBJ/allowed_signers \\\n\t\t-Overify-time=19840101 \\\n\t\t< $DATA >/dev/null 2>&1 && \\\n\t\tfail \"accepted signature for $t key with expired CA but valid cert\"\n\ndone\n\n# Test key independant match-principals\n(\n\tprintf \"principal1 \" ; cat $pubkey;\n\tprintf \"princi* \" ; cat $pubkey;\n\tprintf \"unique \" ; cat $pubkey;\n) > $OBJ/allowed_signers\n\nverbose \"$tid: match principals\"\n${SSHKEYGEN} -Y match-principals -f $OBJ/allowed_signers -I \"unique\" | \\\n    fgrep \"unique\" >/dev/null || \\\n\tfail \"failed to match static principal\"\n\ntrace \"$tid: match principals wildcard\"\n${SSHKEYGEN} -Y match-principals -f $OBJ/allowed_signers -I \"princip\" | \\\n    fgrep \"princi*\" >/dev/null || \\\n\tfail \"failed to match wildcard principal\"\n\ntrace \"$tid: match principals static/wildcard\"\n${SSHKEYGEN} -Y match-principals -f $OBJ/allowed_signers -I \"principal1\" | \\\n    fgrep -e \"principal1\" -e \"princi*\" >/dev/null || \\\n\tfail \"failed to match static and wildcard principal\"\nverbose \"$tid: nomatch principals\"\nfor x in princ prince unknown ; do\n\t${SSHKEYGEN} -Y match-principals -f $OBJ/allowed_signers \\\n\t    -I $x >/dev/null 2>&1 && \\\n\t\tfail \"succeeded to match unknown principal \\\"$x\\\"\"\ndone\n\ntrace \"kill agent\"\n${SSHAGENT} -k > /dev/null\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}