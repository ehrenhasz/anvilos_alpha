{
  "module_name": "hostkey-agent.sh",
  "hash_id": "8b4baf813aea5e4accf43b5364c649f916d9502fc222ee7cb81ef7223f63c259",
  "original_prompt": "Ingested from openssh-9.6p1/regress/hostkey-agent.sh",
  "human_readable_source": "#\t$OpenBSD: hostkey-agent.sh,v 1.13 2021/09/30 05:20:08 dtucker Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"hostkey agent\"\n\nrm -f $OBJ/agent-key.* $OBJ/ssh_proxy.orig $OBJ/known_hosts.orig $OBJ/agent-ca*\n\ntrace \"start agent\"\neval `${SSHAGENT} ${EXTRA_AGENT_ARGS} -s` > /dev/null\nr=$?\n[ $r -ne 0 ] && fatal \"could not start ssh-agent: exit code $r\"\n\ngrep -vi 'hostkey' $OBJ/sshd_proxy > $OBJ/sshd_proxy.orig\necho \"HostKeyAgent $SSH_AUTH_SOCK\" >> $OBJ/sshd_proxy.orig\n\ntrace \"make CA key\"\n\n${SSHKEYGEN} -qt ed25519 -f $OBJ/agent-ca -N '' || fatal \"ssh-keygen CA\"\n\ntrace \"load hostkeys\"\nfor k in $SSH_KEYTYPES ; do\n\t${SSHKEYGEN} -qt $k -f $OBJ/agent-key.$k -N '' || fatal \"ssh-keygen $k\"\n\t${SSHKEYGEN} -s $OBJ/agent-ca -qh -n localhost-with-alias \\\n\t\t-I localhost-with-alias $OBJ/agent-key.$k.pub || \\\n\t\tfatal \"sign $k\"\n\t${SSHADD} -k $OBJ/agent-key.$k >/dev/null 2>&1 || \\\n\t\tfatal \"couldn't load key $OBJ/agent-key.$k\"\n\t# Remove private key so the server can't use it.\n\trm $OBJ/agent-key.$k || fatal \"couldn't rm $OBJ/agent-key.$k\"\ndone\nrm $OBJ/agent-ca # Don't need CA private any more either\n\nunset SSH_AUTH_SOCK\n\nfor k in $SSH_KEYTYPES ; do\n\tverbose \"key type $k\"\n\tcp $OBJ/sshd_proxy.orig $OBJ/sshd_proxy\n\techo \"HostKeyAlgorithms $k\" >> $OBJ/sshd_proxy\n\techo \"Hostkey $OBJ/agent-key.${k}\" >> $OBJ/sshd_proxy\n\topts=\"-oHostKeyAlgorithms=$k -F $OBJ/ssh_proxy\"\n\t( printf 'localhost-with-alias,127.0.0.1,::1 ' ;\n\t  cat $OBJ/agent-key.$k.pub) > $OBJ/known_hosts\n\tSSH_CONNECTION=`${SSH} $opts host 'echo $SSH_CONNECTION'`\n\tif [ $? -ne 0 ]; then\n\t\tfail \"keytype $k failed\"\n\tfi\n\tif [ \"$SSH_CONNECTION\" != \"UNKNOWN 65535 UNKNOWN 65535\" ]; then\n\t\tfail \"bad SSH_CONNECTION key type $k\"\n\tfi\ndone\n\nSSH_CERTTYPES=`ssh -Q key-sig | grep 'cert-v01@openssh.com'`\n\n# Prepare sshd_proxy for certificates.\ncp $OBJ/sshd_proxy.orig $OBJ/sshd_proxy\nHOSTKEYALGS=\"\"\nfor k in $SSH_CERTTYPES ; do\n\ttest -z \"$HOSTKEYALGS\" || HOSTKEYALGS=\"${HOSTKEYALGS},\"\n\tHOSTKEYALGS=\"${HOSTKEYALGS}${k}\"\ndone\nfor k in $SSH_KEYTYPES ; do\n\techo \"Hostkey $OBJ/agent-key.${k}.pub\" >> $OBJ/sshd_proxy\n\techo \"HostCertificate $OBJ/agent-key.${k}-cert.pub\" >> $OBJ/sshd_proxy\n\ttest -f $OBJ/agent-key.${k}.pub || fatal \"no $k key\"\n\ttest -f $OBJ/agent-key.${k}-cert.pub || fatal \"no $k cert\"\ndone\necho \"HostKeyAlgorithms $HOSTKEYALGS\" >> $OBJ/sshd_proxy\n\n# Add only CA trust anchor to known_hosts.\n( printf '@cert-authority localhost-with-alias ' ;\n  cat $OBJ/agent-ca.pub) > $OBJ/known_hosts\n\nfor k in $SSH_CERTTYPES ; do\n\tverbose \"cert type $k\"\n\topts=\"-oHostKeyAlgorithms=$k -F $OBJ/ssh_proxy\"\n\tSSH_CONNECTION=`${SSH} $opts host 'echo $SSH_CONNECTION'`\n\tif [ $? -ne 0 ]; then\n\t\tfail \"cert type $k failed\"\n\tfi\n\tif [ \"$SSH_CONNECTION\" != \"UNKNOWN 65535 UNKNOWN 65535\" ]; then\n\t\tfail \"bad SSH_CONNECTION key type $k\"\n\tfi\ndone\n\ntrace \"kill agent\"\n${SSHAGENT} -k > /dev/null\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}