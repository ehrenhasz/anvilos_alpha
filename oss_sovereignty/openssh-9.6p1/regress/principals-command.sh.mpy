{
  "module_name": "principals-command.sh",
  "hash_id": "e9898072efe6c0e0e0955a55879c94690b324b8a6c662aa5b88d25ec03fe5f92",
  "original_prompt": "Ingested from openssh-9.6p1/regress/principals-command.sh",
  "human_readable_source": "#\t$OpenBSD: principals-command.sh,v 1.14 2021/09/30 05:26:26 dtucker Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"authorized principals command\"\n\nrm -f $OBJ/user_ca_key* $OBJ/cert_user_key*\ncp $OBJ/sshd_proxy $OBJ/sshd_proxy_bak\n\nif [ -z \"$SUDO\" -a ! -w /var/run ]; then\n\tskip \"need SUDO to create file in /var/run, test won't work without\"\nfi\n\ncase \"$SSH_KEYTYPES\" in\n\t*ssh-rsa*)\tuserkeytype=rsa ;;\n\t*)\t\tuserkeytype=ed25519 ;;\nesac\n\nSERIAL=$$\n\n# Create a CA key and a user certificate.\n${SSHKEYGEN} -q -N '' -t ed25519  -f $OBJ/user_ca_key || \\\n\tfatal \"ssh-keygen of user_ca_key failed\"\n${SSHKEYGEN} -q -N '' -t ${userkeytype} -f $OBJ/cert_user_key || \\\n\tfatal \"ssh-keygen of cert_user_key failed\"\n${SSHKEYGEN} -q -s $OBJ/user_ca_key -I \"Joanne User\" \\\n    -z $$ -n ${USER},mekmitasdigoat $OBJ/cert_user_key || \\\n\tfatal \"couldn't sign cert_user_key\"\n\nCERT_BODY=`cat $OBJ/cert_user_key-cert.pub | awk '{ print $2 }'`\nCA_BODY=`cat $OBJ/user_ca_key.pub | awk '{ print $2 }'`\nCERT_FP=`${SSHKEYGEN} -lf $OBJ/cert_user_key-cert.pub | awk '{ print $2 }'`\nCA_FP=`${SSHKEYGEN} -lf $OBJ/user_ca_key.pub | awk '{ print $2 }'`\n\n# Establish a AuthorizedPrincipalsCommand in /var/run where it will have\n# acceptable directory permissions.\nPRINCIPALS_COMMAND=\"/var/run/principals_command_${LOGNAME}.$$\"\ntrap \"$SUDO rm -f ${PRINCIPALS_COMMAND}\" 0\ncat << _EOF | $SUDO sh -c \"cat > '$PRINCIPALS_COMMAND'\"\n#!/bin/sh\ntest \"x\\$1\" != \"x${LOGNAME}\" && exit 1\ntest \"x\\$2\" != \"xssh-${userkeytype}-cert-v01@openssh.com\" && exit 1\ntest \"x\\$3\" != \"xssh-ed25519\" && exit 1\ntest \"x\\$4\" != \"xJoanne User\" && exit 1\ntest \"x\\$5\" != \"x${SERIAL}\" && exit 1\ntest \"x\\$6\" != \"x${CA_FP}\" && exit 1\ntest \"x\\$7\" != \"x${CERT_FP}\" && exit 1\ntest \"x\\$8\" != \"x${CERT_BODY}\" && exit 1\ntest \"x\\$9\" != \"x${CA_BODY}\" && exit 1\ntest -f \"$OBJ/authorized_principals_${LOGNAME}\" &&\n\texec cat \"$OBJ/authorized_principals_${LOGNAME}\"\n_EOF\ntest $? -eq 0 || fatal \"couldn't prepare principals command\"\n$SUDO chmod 0755 \"$PRINCIPALS_COMMAND\"\n\nif ! $OBJ/check-perm -m keys-command $PRINCIPALS_COMMAND ; then\n\techo \"skipping: $PRINCIPALS_COMMAND is unsuitable as \" \\\n\t    \"AuthorizedPrincipalsCommand\"\n\t$SUDO rm -f $PRINCIPALS_COMMAND\n\texit 0\nfi\n\nif [ ! -x $PRINCIPALS_COMMAND ]; then\n\tskip \"$PRINCIPALS_COMMAND not executable \" \\\n\t    \"(/var/run mounted noexec?)\"\nfi\n\n# Test explicitly-specified principals\n# Setup for AuthorizedPrincipalsCommand\nrm -f $OBJ/authorized_keys_$USER\n(\n\tcat $OBJ/sshd_proxy_bak\n\techo \"AuthorizedKeysFile none\"\n\techo \"AuthorizedPrincipalsCommand $PRINCIPALS_COMMAND\" \\\n\t    \"%u %t %T %i %s %F %f %k %K\"\n\techo \"AuthorizedPrincipalsCommandUser ${LOGNAME}\"\n\techo \"TrustedUserCAKeys $OBJ/user_ca_key.pub\"\n) > $OBJ/sshd_proxy\n\n# XXX test missing command\n# XXX test failing command\n\n# Empty authorized_principals\nverbose \"$tid: empty authorized_principals\"\necho > $OBJ/authorized_principals_$USER\n${SSH} -i $OBJ/cert_user_key \\\n    -F $OBJ/ssh_proxy somehost true >/dev/null 2>&1\nif [ $? -eq 0 ]; then\n\tfail \"ssh cert connect succeeded unexpectedly\"\nfi\n\n# Wrong authorized_principals\nverbose \"$tid: wrong authorized_principals\"\necho gregorsamsa > $OBJ/authorized_principals_$USER\n${SSH} -i $OBJ/cert_user_key \\\n    -F $OBJ/ssh_proxy somehost true >/dev/null 2>&1\nif [ $? -eq 0 ]; then\n\tfail \"ssh cert connect succeeded unexpectedly\"\nfi\n\n# Correct authorized_principals\nverbose \"$tid: correct authorized_principals\"\necho mekmitasdigoat > $OBJ/authorized_principals_$USER\n${SSH} -i $OBJ/cert_user_key \\\n    -F $OBJ/ssh_proxy somehost true >/dev/null 2>&1\nif [ $? -ne 0 ]; then\n\tfail \"ssh cert connect failed\"\nfi\n\n# authorized_principals with bad key option\nverbose \"$tid: authorized_principals bad key opt\"\necho 'blah mekmitasdigoat' > $OBJ/authorized_principals_$USER\n${SSH} -i $OBJ/cert_user_key \\\n    -F $OBJ/ssh_proxy somehost true >/dev/null 2>&1\nif [ $? -eq 0 ]; then\n\tfail \"ssh cert connect succeeded unexpectedly\"\nfi\n\n# authorized_principals with command=false\nverbose \"$tid: authorized_principals command=false\"\necho 'command=\"false\" mekmitasdigoat' > \\\n    $OBJ/authorized_principals_$USER\n${SSH} -i $OBJ/cert_user_key \\\n    -F $OBJ/ssh_proxy somehost true >/dev/null 2>&1\nif [ $? -eq 0 ]; then\n\tfail \"ssh cert connect succeeded unexpectedly\"\nfi\n\n\n# authorized_principals with command=true\nverbose \"$tid: authorized_principals command=true\"\necho 'command=\"true\" mekmitasdigoat' > \\\n    $OBJ/authorized_principals_$USER\n${SSH} -i $OBJ/cert_user_key \\\n    -F $OBJ/ssh_proxy somehost false >/dev/null 2>&1\nif [ $? -ne 0 ]; then\n\tfail \"ssh cert connect failed\"\nfi\n\n# Setup for principals= key option\n# TODO: remove?\nrm -f $OBJ/authorized_principals_$USER\n(\n\tcat $OBJ/sshd_proxy_bak\n) > $OBJ/sshd_proxy\n\n# Wrong principals list\nverbose \"$tid: wrong principals key option\"\n(\n\tprintf 'cert-authority,principals=\"gregorsamsa\" '\n\tcat $OBJ/user_ca_key.pub\n) > $OBJ/authorized_keys_$USER\n${SSH} -i $OBJ/cert_user_key \\\n    -F $OBJ/ssh_proxy somehost true >/dev/null 2>&1\nif [ $? -eq 0 ]; then\n\tfail \"ssh cert connect succeeded unexpectedly\"\nfi\n\n# Correct principals list\nverbose \"$tid: correct principals key option\"\n(\n\tprintf 'cert-authority,principals=\"mekmitasdigoat\" '\n\tcat $OBJ/user_ca_key.pub\n) > $OBJ/authorized_keys_$USER\n${SSH} -i $OBJ/cert_user_key \\\n    -F $OBJ/ssh_proxy somehost true >/dev/null 2>&1\nif [ $? -ne 0 ]; then\n\tfail \"ssh cert connect failed\"\nfi\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}