{
  "module_name": "krl.sh",
  "hash_id": "c6350c2a0f8813454044746e23c97fd192ac5afd4d244c9e0830cce984d4c973",
  "original_prompt": "Ingested from openssh-9.6p1/regress/krl.sh",
  "human_readable_source": "#\t$OpenBSD: krl.sh,v 1.12 2023/01/16 04:11:29 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"key revocation lists\"\n\n# Use ed25519 by default since it's fast and it's supported when building\n# w/out OpenSSL.  Populate ktype[2-4] with the other types if supported.\nktype1=ed25519; ktype2=ed25519; ktype3=ed25519;\nktype4=ed25519; ktype5=ed25519; ktype6=ed25519;\nfor t in $SSH_KEYTYPES; do\n\tcase \"$t\" in\n\t\tecdsa*)\t\tktype2=ecdsa ;;\n\t\tssh-rsa)\tktype3=rsa ;;\n\t\tssh-dss)\tktype4=dsa ;;\n\t\tsk-ssh-ed25519@openssh.com)\t\tktype5=ed25519-sk ;;\n\t\tsk-ecdsa-sha2-nistp256@openssh.com)\tktype6=ecdsa-sk ;;\n\tesac\ndone\n\n# Do most testing with ssh-keygen; it uses the same verification code as sshd.\n\n# Old keys will interfere with ssh-keygen.\nrm -f $OBJ/revoked-* $OBJ/krl-*\n\n# Generate a CA key\n$SSHKEYGEN -t $ktype1 -f $OBJ/revoked-ca  -C \"\" -N \"\" > /dev/null ||\n\tfatal \"$SSHKEYGEN CA failed\"\n$SSHKEYGEN -t $ktype2 -f $OBJ/revoked-ca2  -C \"\" -N \"\" > /dev/null ||\n\tfatal \"$SSHKEYGEN CA2 failed\"\n\n# A specification that revokes some certificates by serial numbers\n# The serial pattern is chosen to ensure the KRL includes list, range and\n# bitmap sections.\ncat << EOF >> $OBJ/revoked-serials\nserial: 1-4\nserial: 10\nserial: 15\nserial: 30\nserial: 50\nserial: 90\nserial: 999\n# The following sum to 500-799\nserial: 500\nserial: 501\nserial: 502\nserial: 503-600\nserial: 700-797\nserial: 798\nserial: 799\nserial: 599-701\n# Some multiple consecutive serial number ranges\nserial: 10000-20000\nserial: 30000-40000\nEOF\n\n# A specification that revokes some certificated by key ID.\ntouch $OBJ/revoked-keyid\nfor n in 1 2 3 4 10 15 30 50 90 `jot 500 300` 999 1000 1001 1002; do\n\ttest \"x$n\" = \"x499\" && continue\n\t# Fill in by-ID revocation spec.\n\techo \"id: revoked $n\" >> $OBJ/revoked-keyid\ndone\n\nkeygen() {\n\tN=$1\n\tf=$OBJ/revoked-`printf \"%04d\" $N`\n\t# Vary the keytype. We use mostly ed25519 since this is fast and well\n\t# supported.\n\tkeytype=$ktype1\n\tcase $N in\n\t2  | 10 | 510 | 1001)\tkeytype=$ktype2 ;;\n\t4  | 30 | 520 | 1002)\tkeytype=$ktype3 ;;\n\t8  | 50 | 530 | 1003)\tkeytype=$ktype4 ;;\n\t16 | 70 | 540 | 1004)\tkeytype=$ktype5 ;;\n\t32 | 90 | 550 | 1005)\tkeytype=$ktype6 ;;\n\tesac\n\t$SSHKEYGEN -t $keytype -f $f -C \"\" -N \"\" > /dev/null \\\n\t\t|| fatal \"$SSHKEYGEN failed\"\n\t# Sign cert\n\t$SSHKEYGEN -s $OBJ/revoked-ca -z $n -I \"revoked $N\" $f >/dev/null 2>&1 \\\n\t\t|| fatal \"$SSHKEYGEN sign failed\"\n\techo $f\n}\n\n# Generate some keys.\nverbose \"$tid: generating test keys\"\nREVOKED_SERIALS=\"1 4 10 50 90 500 510 520 550 799 999\"\nfor n in $REVOKED_SERIALS ; do\n\tf=`keygen $n`\n\tRKEYS=\"$RKEYS ${f}.pub\"\n\tRCERTS=\"$RCERTS ${f}-cert.pub\"\ndone\nUNREVOKED_SERIALS=\"5 9 14 16 29 49 51 499 800 1010 1011\"\nUNREVOKED=\"\"\nfor n in $UNREVOKED_SERIALS ; do\n\tf=`keygen $n`\n\tUKEYS=\"$UKEYS ${f}.pub\"\n\tUCERTS=\"$UCERTS ${f}-cert.pub\"\ndone\n\n# Specifications that revoke keys by hash.\ntouch $OBJ/revoked-sha1 $OBJ/revoked-sha256 $OBJ/revoked-hash\nfor rkey in $RKEYS; do\n\t(printf \"sha1: \"; cat $rkey) >> $OBJ/revoked-sha1\n\t(printf \"sha256: \"; cat $rkey) >> $OBJ/revoked-sha256\n\t(printf \"hash: \"; $SSHKEYGEN -lf $rkey | \\\n\t\tawk '{ print $2 }') >> $OBJ/revoked-hash\ndone\n\ngenkrls() {\n\tOPTS=$1\n$SSHKEYGEN $OPTS -kf $OBJ/krl-empty - </dev/null \\\n\t>/dev/null || fatal \"$SSHKEYGEN KRL failed\"\n$SSHKEYGEN $OPTS -kf $OBJ/krl-keys $RKEYS \\\n\t>/dev/null || fatal \"$SSHKEYGEN KRL failed\"\n$SSHKEYGEN $OPTS -kf $OBJ/krl-cert $RCERTS \\\n\t>/dev/null || fatal \"$SSHKEYGEN KRL failed\"\n$SSHKEYGEN $OPTS -kf $OBJ/krl-all $RKEYS $RCERTS \\\n\t>/dev/null || fatal \"$SSHKEYGEN KRL failed\"\n$SSHKEYGEN $OPTS -kf $OBJ/krl-ca $OBJ/revoked-ca.pub \\\n\t>/dev/null || fatal \"$SSHKEYGEN KRL failed\"\n$SSHKEYGEN $OPTS -kf $OBJ/krl-sha1 $OBJ/revoked-sha1 \\\n\t>/dev/null 2>&1 || fatal \"$SSHKEYGEN KRL failed\"\n$SSHKEYGEN $OPTS -kf $OBJ/krl-sha256 $OBJ/revoked-sha256 \\\n\t>/dev/null 2>&1 || fatal \"$SSHKEYGEN KRL failed\"\n$SSHKEYGEN $OPTS -kf $OBJ/krl-hash $OBJ/revoked-hash \\\n\t>/dev/null 2>&1 || fatal \"$SSHKEYGEN KRL failed\"\n# This should fail as KRLs from serial/key-id spec need the CA specified.\n$SSHKEYGEN $OPTS -kf $OBJ/krl-serial $OBJ/revoked-serials \\\n\t>/dev/null 2>&1 && fatal \"$SSHKEYGEN KRL succeeded unexpectedly\"\n$SSHKEYGEN $OPTS -kf $OBJ/krl-keyid $OBJ/revoked-keyid \\\n\t>/dev/null 2>&1 && fatal \"$SSHKEYGEN KRL succeeded unexpectedly\"\n# These should succeed; they specify an explicit CA key.\n$SSHKEYGEN $OPTS -kf $OBJ/krl-serial -s $OBJ/revoked-ca \\\n\t$OBJ/revoked-serials >/dev/null || fatal \"$SSHKEYGEN KRL failed\"\n$SSHKEYGEN $OPTS -kf $OBJ/krl-keyid -s $OBJ/revoked-ca.pub \\\n\t$OBJ/revoked-keyid >/dev/null || fatal \"$SSHKEYGEN KRL failed\"\n# These should succeed; they specify an wildcard CA key.\n$SSHKEYGEN $OPTS -kf $OBJ/krl-serial-wild -s NONE $OBJ/revoked-serials \\\n\t>/dev/null || fatal \"$SSHKEYGEN KRL failed\"\n$SSHKEYGEN $OPTS -kf $OBJ/krl-keyid-wild -s NONE $OBJ/revoked-keyid \\\n\t>/dev/null || fatal \"$SSHKEYGEN KRL failed\"\n# Revoke the same serials with the second CA key to ensure a multi-CA\n# KRL is generated.\n$SSHKEYGEN $OPTS -kf $OBJ/krl-serial -u -s $OBJ/revoked-ca2 \\\n\t$OBJ/revoked-serials >/dev/null || fatal \"$SSHKEYGEN KRL failed\"\n}\n\n## XXX dump with trace and grep for set cert serials\n## XXX test ranges near (u64)-1, etc.\n\nverbose \"$tid: generating KRLs\"\ngenkrls\n\ncheck_krl() {\n\tKEY=$1\n\tKRL=$2\n\tEXPECT_REVOKED=$3\n\tTAG=$4\n\t$SSHKEYGEN -Qf $KRL $KEY >/dev/null\n\tresult=$?\n\tif test \"x$EXPECT_REVOKED\" = \"xy\" -a $result -eq 0 ; then\n\t\tfatal \"key $KEY not revoked by KRL $KRL: $TAG\"\n\telif test \"x$EXPECT_REVOKED\" = \"xn\" -a $result -ne 0 ; then\n\t\tfatal \"key $KEY unexpectedly revoked by KRL $KRL: $TAG\"\n\tfi\n}\ntest_rev() {\n\tFILES=$1\n\tTAG=$2\n\tKEYS_RESULT=$3\n\tALL_RESULT=$4\n\tHASH_RESULT=$5\n\tSERIAL_RESULT=$6\n\tKEYID_RESULT=$7\n\tCERTS_RESULT=$8\n\tCA_RESULT=$9\n\tSERIAL_WRESULT=${10}\n\tKEYID_WRESULT=${11}\n\tverbose \"$tid: checking revocations for $TAG\"\n\tfor f in $FILES ; do\n\t\tcheck_krl $f $OBJ/krl-empty\t\tno\t\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-keys\t\t$KEYS_RESULT\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-all\t\t$ALL_RESULT\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-sha1\t\t$HASH_RESULT\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-sha256\t\t$HASH_RESULT\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-hash\t\t$HASH_RESULT\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-serial\t\t$SERIAL_RESULT\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-keyid\t\t$KEYID_RESULT\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-cert\t\t$CERTS_RESULT\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-ca\t\t$CA_RESULT\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-serial-wild\t$SERIAL_WRESULT\t\"$TAG\"\n\t\tcheck_krl $f $OBJ/krl-keyid-wild\t$KEYID_WRESULT\t\"$TAG\"\n\tdone\n}\n\ntest_all() {\n\t#                                                           wildcard\n\t#                                 keys all hash sr# ID cert  CA srl ID\n\ttest_rev \"$RKEYS\"     \"revoked keys\" y   y    y   n  n    n   n   n  n\n\ttest_rev \"$UKEYS\"   \"unrevoked keys\" n   n    n   n  n    n   n   n  n\n\ttest_rev \"$RCERTS\"   \"revoked certs\" y   y    y   y  y    y   y   y  y\n\ttest_rev \"$UCERTS\" \"unrevoked certs\" n   n    n   n  n    n   y   n  n\n}\n\ntest_all\n\n# Check update. Results should be identical.\nverbose \"$tid: testing KRL update\"\nfor f in $OBJ/krl-keys $OBJ/krl-cert $OBJ/krl-all \\\n    $OBJ/krl-ca $OBJ/krl-serial $OBJ/krl-keyid \\\n    $OBJ/krl-serial-wild $OBJ/krl-keyid-wild; do\n\tcp -f $OBJ/krl-empty $f\n\tgenkrls -u\ndone\n\ntest_all\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}