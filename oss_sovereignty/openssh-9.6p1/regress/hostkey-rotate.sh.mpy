{
  "module_name": "hostkey-rotate.sh",
  "hash_id": "c990cbbab85bca0de26baa01f8871b566f3f9026ff0629c73a2fa94ccde5492a",
  "original_prompt": "Ingested from openssh-9.6p1/regress/hostkey-rotate.sh",
  "human_readable_source": "#\t$OpenBSD: hostkey-rotate.sh,v 1.10 2022/01/05 08:25:05 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"hostkey rotate\"\n\n#\n# GNU (f)grep <=2.18, as shipped by FreeBSD<=12 and NetBSD<=9 will occasionally\n# fail to find ssh host keys in the hostkey-rotate test.  If we have those\n# versions, use awk instead.\n# See # https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=258616\n#\ncase `grep --version 2>&1 | awk '/GNU grep/{print $4}'` in\n2.19)\t\t\tfgrep=good ;;\n1.*|2.?|2.?.?|2.1?)\tfgrep=bad ;;\t# stock GNU grep\n2.5.1*)\t\t\tfgrep=bad ;;\t# FreeBSD and NetBSD\n*)\t\t\tfgrep=good ;;\nesac\nif test \"x$fgrep\" = \"xbad\"; then\n\tfgrep()\n{\n\tawk 'BEGIN{e=1} {if (index($0,\"'$1'\")>0){e=0;print}} END{exit e}' $2\n}\nfi\n\nrm -f $OBJ/hkr.* $OBJ/ssh_proxy.orig $OBJ/ssh_proxy.orig\n\ngrep -vi 'hostkey' $OBJ/sshd_proxy > $OBJ/sshd_proxy.orig\nmv $OBJ/ssh_proxy $OBJ/ssh_proxy.orig\ngrep -vi 'globalknownhostsfile' $OBJ/ssh_proxy.orig > $OBJ/ssh_proxy\necho \"UpdateHostkeys=yes\" >> $OBJ/ssh_proxy\necho \"GlobalKnownHostsFile=none\" >> $OBJ/ssh_proxy\nrm $OBJ/known_hosts\n\n# The \"primary\" key type is ed25519 since it's supported even when built\n# without OpenSSL.  The secondary is RSA if it's supported.\nprimary=\"ssh-ed25519\"\nsecondary=\"$primary\"\n\ntrace \"prepare hostkeys\"\nnkeys=0\nall_algs=\"\"\nfor k in $SSH_HOSTKEY_TYPES; do\n\t${SSHKEYGEN} -qt $k -f $OBJ/hkr.$k -N '' || fatal \"ssh-keygen $k\"\n\techo \"Hostkey $OBJ/hkr.${k}\" >> $OBJ/sshd_proxy.orig\n\tnkeys=`expr $nkeys + 1`\n\ttest \"x$all_algs\" = \"x\" || all_algs=\"${all_algs},\"\n\tcase \"$k\" in\n\tssh-rsa)\n\t\tsecondary=\"ssh-rsa\"\n\t\tall_algs=\"${all_algs}rsa-sha2-256,rsa-sha2-512,$k\"\n\t\t;;\n\t*)\n\t\tall_algs=\"${all_algs}$k\"\n\t\t;;\n\tesac\ndone\n\ndossh() {\n\t# All ssh should succeed in this test\n\t${SSH} -F $OBJ/ssh_proxy \"$@\" x true || fail \"ssh $@ failed\"\n}\n\nexpect_nkeys() {\n\t_expected=$1\n\t_message=$2\n\t_n=`wc -l $OBJ/known_hosts | awk '{ print $1 }'` || fatal \"wc failed\"\n\t[ \"x$_n\" = \"x$_expected\" ] || fail \"$_message (got $_n wanted $_expected)\"\n}\n\ncheck_key_present() {\n\t_type=$1\n\t_kfile=$2\n\ttest \"x$_kfile\" = \"x\" && _kfile=\"$OBJ/hkr.${_type}.pub\"\n\t_kpub=`awk \"/$_type /\"' { print $2 }' < $_kfile` || \\\n\t\tfatal \"awk failed\"\n\tfgrep \"$_kpub\" $OBJ/known_hosts > /dev/null\n}\n\ncp $OBJ/sshd_proxy.orig $OBJ/sshd_proxy\n\n# Connect to sshd with StrictHostkeyChecking=no\nverbose \"learn hostkey with StrictHostKeyChecking=no\"\n>$OBJ/known_hosts\ndossh -oHostKeyAlgorithms=$primary -oStrictHostKeyChecking=no\n# Verify no additional keys learned\nexpect_nkeys 1 \"unstrict connect keys\"\ncheck_key_present $primary || fail \"unstrict didn't learn key\"\n\n# Connect to sshd as usual\nverbose \"learn additional hostkeys\"\ndossh -oStrictHostKeyChecking=yes -oHostKeyAlgorithms=$all_algs\n# Check that other keys learned\nexpect_nkeys $nkeys \"learn hostkeys\"\nfor k in $SSH_HOSTKEY_TYPES; do\n\tcheck_key_present $k || fail \"didn't learn keytype $k\"\ndone\n\n# Check each key type\nfor k in $SSH_HOSTKEY_TYPES; do\n\tcase \"$k\" in\n\tssh-rsa) alg=\"rsa-sha2-256,rsa-sha2-512,ssh-rsa\" ;;\n\t*) alg=\"$k\" ;;\n\tesac\n\tverbose \"learn additional hostkeys, type=$k\"\n\tdossh -oStrictHostKeyChecking=yes -oHostKeyAlgorithms=$alg,$all_algs\n\texpect_nkeys $nkeys \"learn hostkeys $k\"\n\tcheck_key_present $k || fail \"didn't learn $k correctly\"\ndone\n\n# Change one hostkey (non primary) and relearn\nif [ \"$primary\" != \"$secondary\" ]; then\n\tverbose \"learn changed non-primary hostkey type=${secondary}\"\n\tmv $OBJ/hkr.${secondary}.pub $OBJ/hkr.${secondary}.pub.old\n\trm -f $OBJ/hkr.${secondary}\n\t${SSHKEYGEN} -qt ${secondary} -f $OBJ/hkr.${secondary} -N '' || \\\n\t    fatal \"ssh-keygen $secondary\"\n\tdossh -oStrictHostKeyChecking=yes -oHostKeyAlgorithms=$all_algs\n\t# Check that the key was replaced\n\texpect_nkeys $nkeys \"learn hostkeys\"\n\tcheck_key_present ${secondary} $OBJ/hkr.${secondary}.pub.old && \\\n\t    fail \"old key present\"\n\tcheck_key_present ${secondary} || fail \"didn't learn changed key\"\nfi\n\n# Add new hostkey (primary type) to sshd and connect\nverbose \"learn new primary hostkey\"\n${SSHKEYGEN} -qt ${primary} -f $OBJ/hkr.${primary}-new -N '' || fatal \"ssh-keygen ed25519\"\n( cat $OBJ/sshd_proxy.orig ; echo HostKey $OBJ/hkr.${primary}-new ) \\\n    > $OBJ/sshd_proxy\n# Check new hostkey added\ndossh -oStrictHostKeyChecking=yes -oHostKeyAlgorithms=${primary},$all_algs\nexpect_nkeys `expr $nkeys + 1` \"learn hostkeys\"\ncheck_key_present ${primary} || fail \"current key missing\"\ncheck_key_present ${primary} $OBJ/hkr.${primary}-new.pub || fail \"new key missing\"\n\n# Remove old hostkey (primary type) from sshd\nverbose \"rotate primary hostkey\"\ncp $OBJ/sshd_proxy.orig $OBJ/sshd_proxy\nmv $OBJ/hkr.${primary}.pub $OBJ/hkr.${primary}.pub.old\nmv $OBJ/hkr.${primary}-new.pub $OBJ/hkr.${primary}.pub\nmv $OBJ/hkr.${primary}-new $OBJ/hkr.${primary}\n# Check old hostkey removed\ndossh -oStrictHostKeyChecking=yes -oHostKeyAlgorithms=${primary},$all_algs\nexpect_nkeys $nkeys \"learn hostkeys\"\ncheck_key_present ${primary} $OBJ/hkr.${primary}.pub.old && fail \"old key present\"\ncheck_key_present ${primary} || fail \"didn't learn changed key\"\n\n# Connect again, forcing rotated key\nverbose \"check rotate primary hostkey\"\ndossh -oStrictHostKeyChecking=yes -oHostKeyAlgorithms=${primary}\nexpect_nkeys 1 \"learn hostkeys\"\ncheck_key_present ${primary} || fail \"didn't learn changed key\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}