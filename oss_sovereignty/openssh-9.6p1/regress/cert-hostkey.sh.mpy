{
  "module_name": "cert-hostkey.sh",
  "hash_id": "12a62fbd9a60cafd0add12e6e2d8057d12333c22ba1410d58a0f72bd5381ea31",
  "original_prompt": "Ingested from openssh-9.6p1/regress/cert-hostkey.sh",
  "human_readable_source": "#\t$OpenBSD: cert-hostkey.sh,v 1.27 2021/09/30 05:26:26 dtucker Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"certified host keys\"\n\nrm -f $OBJ/known_hosts-cert* $OBJ/host_ca_key* $OBJ/host_revoked_*\nrm -f $OBJ/cert_host_key* $OBJ/host_krl_*\n\n# Allow all hostkey/pubkey types, prefer certs for the client\nrsa=0\ntypes=\"\"\nfor i in `$SSH -Q key | maybe_filter_sk`; do\n\tif [ -z \"$types\" ]; then\n\t\ttypes=\"$i\"\n\t\tcontinue\n\tfi\n\tcase \"$i\" in\n\t# Special treatment for RSA keys.\n\t*rsa*cert*)\n\t\ttypes=\"rsa-sha2-256-cert-v01@openssh.com,$i,$types\"\n\t\ttypes=\"rsa-sha2-512-cert-v01@openssh.com,$types\";;\n\t*rsa*)\n\t\trsa=1\n\t\ttypes=\"$types,rsa-sha2-512,rsa-sha2-256,$i\";;\n\t# Prefer certificate to plain keys.\n\t*cert*)\ttypes=\"$i,$types\";;\n\t*)\ttypes=\"$types,$i\";;\n\tesac\ndone\n(\n\techo \"HostKeyAlgorithms ${types}\"\n\techo \"PubkeyAcceptedAlgorithms *\"\n) >> $OBJ/ssh_proxy\ncp $OBJ/sshd_proxy $OBJ/sshd_proxy_bak\n(\n\techo \"HostKeyAlgorithms *\"\n\techo \"PubkeyAcceptedAlgorithms *\"\n) >> $OBJ/sshd_proxy_bak\n\nHOSTS='localhost-with-alias,127.0.0.1,::1'\n\nkh_ca() {\n\tfor k in \"$@\" ; do\n\t\tprintf \"@cert-authority $HOSTS \"\n\t\tcat $OBJ/$k || fatal \"couldn't cat $k\"\n\tdone\n}\nkh_revoke() {\n\tfor k in \"$@\" ; do\n\t\tprintf \"@revoked * \"\n\t\tcat $OBJ/$k || fatal \"couldn't cat $k\"\n\tdone\n}\n\n# Create a CA key and add it to known hosts. Ed25519 chosen for speed.\n# RSA for testing RSA/SHA2 signatures if supported.\nktype2=ed25519\n[ \"x$rsa\" = \"x1\" ] && ktype2=rsa\n${SSHKEYGEN} -q -N '' -t ed25519  -f $OBJ/host_ca_key ||\\\n\tfail \"ssh-keygen of host_ca_key failed\"\n${SSHKEYGEN} -q -N '' -t $ktype2  -f $OBJ/host_ca_key2 ||\\\n\tfail \"ssh-keygen of host_ca_key failed\"\n\nkh_ca host_ca_key.pub host_ca_key2.pub > $OBJ/known_hosts-cert.orig\ncp $OBJ/known_hosts-cert.orig $OBJ/known_hosts-cert\n\n# Plain text revocation files\ntouch $OBJ/host_revoked_empty\ntouch $OBJ/host_revoked_plain\ntouch $OBJ/host_revoked_cert\ncat $OBJ/host_ca_key.pub $OBJ/host_ca_key2.pub > $OBJ/host_revoked_ca\n\nPLAIN_TYPES=`echo \"$SSH_KEYTYPES\" | sed 's/^ssh-dss/ssh-dsa/g;s/^ssh-//'`\n\nif echo \"$PLAIN_TYPES\" | grep '^rsa$' >/dev/null 2>&1 ; then\n\tPLAIN_TYPES=\"$PLAIN_TYPES rsa-sha2-256 rsa-sha2-512\"\nfi\n\n# Prepare certificate, plain key and CA KRLs\n${SSHKEYGEN} -kf $OBJ/host_krl_empty || fatal \"KRL init failed\"\n${SSHKEYGEN} -kf $OBJ/host_krl_plain || fatal \"KRL init failed\"\n${SSHKEYGEN} -kf $OBJ/host_krl_cert || fatal \"KRL init failed\"\n${SSHKEYGEN} -kf $OBJ/host_krl_ca $OBJ/host_ca_key.pub $OBJ/host_ca_key2.pub \\\n\t|| fatal \"KRL init failed\"\n\n# Generate and sign host keys\nserial=1\nfor ktype in $PLAIN_TYPES ; do\n\tverbose \"$tid: sign host ${ktype} cert\"\n\t# Generate and sign a host key\n\t${SSHKEYGEN} -q -N '' -t ${ktype} \\\n\t    -f $OBJ/cert_host_key_${ktype} || \\\n\t\tfatal \"ssh-keygen of cert_host_key_${ktype} failed\"\n\t${SSHKEYGEN} -ukf $OBJ/host_krl_plain \\\n\t    $OBJ/cert_host_key_${ktype}.pub || fatal \"KRL update failed\"\n\tcat $OBJ/cert_host_key_${ktype}.pub >> $OBJ/host_revoked_plain\n\tcase $ktype in\n\trsa-sha2-*)\ttflag=\"-t $ktype\"; ca=\"$OBJ/host_ca_key2\" ;;\n\t*)\t\ttflag=\"\"; ca=\"$OBJ/host_ca_key\" ;;\n\tesac\n\t${SSHKEYGEN} -h -q -s $ca -z $serial $tflag \\\n\t    -I \"regress host key for $USER\" \\\n\t    -n $HOSTS $OBJ/cert_host_key_${ktype} ||\n\t\tfatal \"couldn't sign cert_host_key_${ktype}\"\n\t${SSHKEYGEN} -ukf $OBJ/host_krl_cert \\\n\t    $OBJ/cert_host_key_${ktype}-cert.pub || \\\n\t\tfatal \"KRL update failed\"\n\tcat $OBJ/cert_host_key_${ktype}-cert.pub >> $OBJ/host_revoked_cert\n\tserial=`expr $serial + 1`\ndone\n\nattempt_connect() {\n\t_ident=\"$1\"\n\t_expect_success=\"$2\"\n\tshift; shift\n\tverbose \"$tid: $_ident expect success $_expect_success\"\n\tcp $OBJ/known_hosts-cert.orig $OBJ/known_hosts-cert\n\t${SSH} -oUserKnownHostsFile=$OBJ/known_hosts-cert \\\n\t    -oGlobalKnownHostsFile=$OBJ/known_hosts-cert \\\n\t    \"$@\" -F $OBJ/ssh_proxy somehost true\n\t_r=$?\n\tif [ \"x$_expect_success\" = \"xyes\" ] ; then\n\t\tif [ $_r -ne 0 ]; then\n\t\t\tfail \"ssh cert connect $_ident failed\"\n\t\tfi\n\telse\n\t\tif [ $_r -eq 0 ]; then\n\t\t\tfail \"ssh cert connect $_ident succeeded unexpectedly\"\n\t\tfi\n\tfi\n}\n\n# Basic connect and revocation tests.\nfor ktype in $PLAIN_TYPES ; do\n\tverbose \"$tid: host ${ktype} cert connect\"\n\t(\n\t\tcat $OBJ/sshd_proxy_bak\n\t\techo HostKey $OBJ/cert_host_key_${ktype}\n\t\techo HostCertificate $OBJ/cert_host_key_${ktype}-cert.pub\n\t) > $OBJ/sshd_proxy\n\n\t#               test name                         expect success\n\tattempt_connect \"$ktype basic connect\"\t\t\t\"yes\"\n\tattempt_connect \"$ktype empty KRL\"\t\t\t\"yes\" \\\n\t    -oRevokedHostKeys=$OBJ/host_krl_empty\n\tattempt_connect \"$ktype KRL w/ plain key revoked\"\t\"no\" \\\n\t    -oRevokedHostKeys=$OBJ/host_krl_plain\n\tattempt_connect \"$ktype KRL w/ cert revoked\"\t\t\"no\" \\\n\t    -oRevokedHostKeys=$OBJ/host_krl_cert\n\tattempt_connect \"$ktype KRL w/ CA revoked\"\t\t\"no\" \\\n\t    -oRevokedHostKeys=$OBJ/host_krl_ca\n\tattempt_connect \"$ktype empty plaintext revocation\"\t\"yes\" \\\n\t    -oRevokedHostKeys=$OBJ/host_revoked_empty\n\tattempt_connect \"$ktype plain key plaintext revocation\"\t\"no\" \\\n\t    -oRevokedHostKeys=$OBJ/host_revoked_plain\n\tattempt_connect \"$ktype cert plaintext revocation\"\t\"no\" \\\n\t    -oRevokedHostKeys=$OBJ/host_revoked_cert\n\tattempt_connect \"$ktype CA plaintext revocation\"\t\"no\" \\\n\t    -oRevokedHostKeys=$OBJ/host_revoked_ca\ndone\n\n# Revoked certificates with key present\nkh_ca host_ca_key.pub host_ca_key2.pub > $OBJ/known_hosts-cert.orig\nfor ktype in $PLAIN_TYPES ; do\n\ttest -f \"$OBJ/cert_host_key_${ktype}.pub\" || fatal \"no pubkey\"\n\tkh_revoke cert_host_key_${ktype}.pub >> $OBJ/known_hosts-cert.orig\ndone\ncp $OBJ/known_hosts-cert.orig $OBJ/known_hosts-cert\nfor ktype in $PLAIN_TYPES ; do\n\tverbose \"$tid: host ${ktype} revoked cert\"\n\t(\n\t\tcat $OBJ/sshd_proxy_bak\n\t\techo HostKey $OBJ/cert_host_key_${ktype}\n\t\techo HostCertificate $OBJ/cert_host_key_${ktype}-cert.pub\n\t) > $OBJ/sshd_proxy\n\n\tcp $OBJ/known_hosts-cert.orig $OBJ/known_hosts-cert\n\t${SSH} -oUserKnownHostsFile=$OBJ/known_hosts-cert \\\n\t    -oGlobalKnownHostsFile=$OBJ/known_hosts-cert \\\n\t\t-F $OBJ/ssh_proxy somehost true >/dev/null 2>&1\n\tif [ $? -eq 0 ]; then\n\t\tfail \"ssh cert connect succeeded unexpectedly\"\n\tfi\ndone\n\n# Revoked CA\nkh_ca host_ca_key.pub host_ca_key2.pub > $OBJ/known_hosts-cert.orig\nkh_revoke host_ca_key.pub host_ca_key2.pub >> $OBJ/known_hosts-cert.orig\ncp $OBJ/known_hosts-cert.orig $OBJ/known_hosts-cert\nfor ktype in $PLAIN_TYPES ; do\n\tverbose \"$tid: host ${ktype} revoked cert\"\n\t(\n\t\tcat $OBJ/sshd_proxy_bak\n\t\techo HostKey $OBJ/cert_host_key_${ktype}\n\t\techo HostCertificate $OBJ/cert_host_key_${ktype}-cert.pub\n\t) > $OBJ/sshd_proxy\n\tcp $OBJ/known_hosts-cert.orig $OBJ/known_hosts-cert\n\t${SSH} -oUserKnownHostsFile=$OBJ/known_hosts-cert \\\n\t    -oGlobalKnownHostsFile=$OBJ/known_hosts-cert \\\n\t\t-F $OBJ/ssh_proxy somehost true >/dev/null 2>&1\n\tif [ $? -eq 0 ]; then\n\t\tfail \"ssh cert connect succeeded unexpectedly\"\n\tfi\ndone\n\n# Create a CA key and add it to known hosts\nkh_ca host_ca_key.pub host_ca_key2.pub > $OBJ/known_hosts-cert.orig\ncp $OBJ/known_hosts-cert.orig $OBJ/known_hosts-cert\n\ntest_one() {\n\tident=$1\n\tresult=$2\n\tsign_opts=$3\n\n\tfor kt in $PLAIN_TYPES; do\n\t\tcase $ktype in\n\t\trsa-sha2-*)\ttflag=\"-t $ktype\"; ca=\"$OBJ/host_ca_key2\" ;;\n\t\t*)\t\ttflag=\"\"; ca=\"$OBJ/host_ca_key\" ;;\n\t\tesac\n\t\t${SSHKEYGEN} -q -s $ca $tflag -I \"regress host key for $USER\" \\\n\t\t    $sign_opts $OBJ/cert_host_key_${kt} ||\n\t\t\tfatal \"couldn't sign cert_host_key_${kt}\"\n\t\t(\n\t\t\tcat $OBJ/sshd_proxy_bak\n\t\t\techo HostKey $OBJ/cert_host_key_${kt}\n\t\t\techo HostCertificate $OBJ/cert_host_key_${kt}-cert.pub\n\t\t) > $OBJ/sshd_proxy\n\n\t\tcp $OBJ/known_hosts-cert.orig $OBJ/known_hosts-cert\n\t\t${SSH} -oUserKnownHostsFile=$OBJ/known_hosts-cert \\\n\t\t    -oGlobalKnownHostsFile=$OBJ/known_hosts-cert \\\n\t\t    -F $OBJ/ssh_proxy somehost true >/dev/null 2>&1\n\t\trc=$?\n\t\tif [ \"x$result\" = \"xsuccess\" ] ; then\n\t\t\tif [ $rc -ne 0 ]; then\n\t\t\t\tfail \"ssh cert connect $ident failed unexpectedly\"\n\t\t\tfi\n\t\telse\n\t\t\tif [ $rc -eq 0 ]; then\n\t\t\t\tfail \"ssh cert connect $ident succeeded unexpectedly\"\n\t\t\tfi\n\t\tfi\n\tdone\n}\n\ntest_one \"user-certificate\"\tfailure \"-n $HOSTS\"\ntest_one \"empty principals\"\tsuccess \"-h\"\ntest_one \"wrong principals\"\tfailure \"-h -n foo\"\ntest_one \"cert not yet valid\"\tfailure \"-h -V20300101:20320101\"\ntest_one \"cert expired\"\t\tfailure \"-h -V19800101:19900101\"\ntest_one \"cert valid interval\"\tsuccess \"-h -V-1w:+2w\"\ntest_one \"cert has constraints\"\tfailure \"-h -Oforce-command=false\"\n\n# Check downgrade of cert to raw key when no CA found\nfor ktype in $PLAIN_TYPES ; do\n\trm -f $OBJ/known_hosts-cert $OBJ/cert_host_key*\n\tverbose \"$tid: host ${ktype} ${v} cert downgrade to raw key\"\n\t# Generate and sign a host key\n\t${SSHKEYGEN} -q -N '' -t ${ktype} -f $OBJ/cert_host_key_${ktype} || \\\n\t\tfail \"ssh-keygen of cert_host_key_${ktype} failed\"\n\tcase $ktype in\n\trsa-sha2-*)\ttflag=\"-t $ktype\"; ca=\"$OBJ/host_ca_key2\" ;;\n\t*)\t\ttflag=\"\"; ca=\"$OBJ/host_ca_key\" ;;\n\tesac\n\t${SSHKEYGEN} -h -q $tflag -s $ca $tflag \\\n\t    -I \"regress host key for $USER\" \\\n\t    -n $HOSTS $OBJ/cert_host_key_${ktype} ||\n\t\tfatal \"couldn't sign cert_host_key_${ktype}\"\n\t(\n\t\tprintf \"$HOSTS \"\n\t\tcat $OBJ/cert_host_key_${ktype}.pub\n\t) > $OBJ/known_hosts-cert\n\t(\n\t\tcat $OBJ/sshd_proxy_bak\n\t\techo HostKey $OBJ/cert_host_key_${ktype}\n\t\techo HostCertificate $OBJ/cert_host_key_${ktype}-cert.pub\n\t) > $OBJ/sshd_proxy\n\n\t${SSH} -oUserKnownHostsFile=$OBJ/known_hosts-cert \\\n\t    -oGlobalKnownHostsFile=none -F $OBJ/ssh_proxy somehost true\n\tif [ $? -ne 0 ]; then\n\t\tfail \"ssh cert connect failed\"\n\tfi\n\t# Also check that it works when the known_hosts file is not in the\n\t# first array position.\n\t${SSH} -oUserKnownHostsFile=\"/dev/null $OBJ/known_hosts-cert\" \\\n\t    -oGlobalKnownHostsFile=none -F $OBJ/ssh_proxy somehost true\n\tif [ $? -ne 0 ]; then\n\t\tfail \"ssh cert connect failed known_hosts 2nd\"\n\tfi\ndone\n\n# Wrong certificate\nkh_ca host_ca_key.pub host_ca_key2.pub > $OBJ/known_hosts-cert.orig\ncp $OBJ/known_hosts-cert.orig $OBJ/known_hosts-cert\nfor kt in $PLAIN_TYPES ; do\n\tverbose \"$tid: host ${kt} connect wrong cert\"\n\trm -f $OBJ/cert_host_key*\n\t# Self-sign key\n\t${SSHKEYGEN} -q -N '' -t ${kt} -f $OBJ/cert_host_key_${kt} || \\\n\t\tfail \"ssh-keygen of cert_host_key_${kt} failed\"\n\tcase $kt in\n\trsa-sha2-*)\ttflag=\"-t $kt\" ;;\n\t*)\t\ttflag=\"\" ;;\n\tesac\n\t${SSHKEYGEN} $tflag -h -q -s $OBJ/cert_host_key_${kt} \\\n\t    -I \"regress host key for $USER\" \\\n\t    -n $HOSTS $OBJ/cert_host_key_${kt} ||\n\t\tfatal \"couldn't sign cert_host_key_${kt}\"\n\t(\n\t\tcat $OBJ/sshd_proxy_bak\n\t\techo HostKey $OBJ/cert_host_key_${kt}\n\t\techo HostCertificate $OBJ/cert_host_key_${kt}-cert.pub\n\t) > $OBJ/sshd_proxy\n\n\tcp $OBJ/known_hosts-cert.orig $OBJ/known_hosts-cert\n\t${SSH} -oUserKnownHostsFile=$OBJ/known_hosts-cert \\\n\t    -oGlobalKnownHostsFile=$OBJ/known_hosts-cert \\\n\t\t-F $OBJ/ssh_proxy -q somehost true >/dev/null 2>&1\n\tif [ $? -eq 0 ]; then\n\t\tfail \"ssh cert connect $ident succeeded unexpectedly\"\n\tfi\ndone\n\nrm -f $OBJ/known_hosts-cert* $OBJ/host_ca_key* $OBJ/cert_host_key*\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}