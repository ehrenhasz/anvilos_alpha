{
  "module_name": "keygen-knownhosts.sh",
  "hash_id": "063c777396592f9176c5c0aff0904722a8625475b9db80c403d12ebc3cb239dc",
  "original_prompt": "Ingested from openssh-9.6p1/regress/keygen-knownhosts.sh",
  "human_readable_source": "#\t$OpenBSD: keygen-knownhosts.sh,v 1.4 2018/06/01 03:52:37 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"ssh-keygen known_hosts\"\n\nrm -f $OBJ/kh.*\n\n# Generate some keys for testing (just ed25519 for speed) and make a hosts file.\nfor x in host-a host-b host-c host-d host-e host-f host-a2 host-b2; do\n\t${SSHKEYGEN} -qt ed25519 -f $OBJ/kh.$x -C \"$x\" -N \"\" || \\\n\t\tfatal \"ssh-keygen failed\"\n\t# Add a comment that we expect should be preserved.\n\techo \"# $x\" >> $OBJ/kh.hosts\n\t(\n\t\tcase \"$x\" in\n\t\thost-a|host-b)\tprintf \"$x \" ;;\n\t\thost-c)\t\tprintf \"@cert-authority $x \" ;;\n\t\thost-d)\t\tprintf \"@revoked $x \" ;;\n\t\thost-e)\t\tprintf \"host-e* \" ;;\n\t\thost-f)\t\tprintf \"host-f,host-g,host-h \" ;;\n\t\thost-a2)\tprintf \"host-a \" ;;\n\t\thost-b2)\tprintf \"host-b \" ;;\n\t\tesac\n\t\tcat $OBJ/kh.${x}.pub\n\t\t# Blank line should be preserved.\n\t\techo \"\" >> $OBJ/kh.hosts\n\t) >> $OBJ/kh.hosts\ndone\n\n# Generate a variant with an invalid line. We'll use this for most tests,\n# because keygen should be able to cope and it should be preserved in any\n# output file.\ncat $OBJ/kh.hosts >> $OBJ/kh.invalid\necho \"host-i \" >> $OBJ/kh.invalid\n\ncp $OBJ/kh.invalid $OBJ/kh.invalid.orig\ncp $OBJ/kh.hosts $OBJ/kh.hosts.orig\n\nexpect_key() {\n\t_host=$1\n\t_hosts=$2\n\t_key=$3\n\t_line=$4\n\t_mark=$5\n\t_marker=\"\"\n\ttest \"x$_mark\" = \"xCA\" && _marker=\"@cert-authority \"\n\ttest \"x$_mark\" = \"xREVOKED\" && _marker=\"@revoked \"\n\ttest \"x$_line\" != \"x\" &&\n\t    echo \"# Host $_host found: line $_line $_mark\" >> $OBJ/kh.expect\n\tprintf \"${_marker}$_hosts \" >> $OBJ/kh.expect\n\tcat $OBJ/kh.${_key}.pub >> $OBJ/kh.expect ||\n\t    fatal \"${_key}.pub missing\"\n}\n\ncheck_find() {\n\t_host=$1\n\t_name=$2\n\tshift; shift\n\t${SSHKEYGEN} \"$@\" -f $OBJ/kh.invalid -F $_host > $OBJ/kh.result\n\tif ! diff -w $OBJ/kh.expect $OBJ/kh.result ; then\n\t\tfail \"didn't find $_name\"\n\tfi\n}\n\ncheck_find_exit_code() {\n\t_host=$1\n\t_name=$2\n\t_keygenopt=$3\n\t_exp_exit_code=$4\n\t${SSHKEYGEN} $_keygenopt -f $OBJ/kh.invalid -F $_host > /dev/null\n\tif [ \"$?\" != \"$_exp_exit_code\" ] ; then\n\t    fail \"Unexpected exit code $_name\"\n\tfi\n}\n\n# Find key\nrm -f $OBJ/kh.expect\nexpect_key host-a host-a host-a 2\nexpect_key host-a host-a host-a2 20\ncheck_find host-a \"simple find\"\n\n# find CA key\nrm -f $OBJ/kh.expect\nexpect_key host-c host-c host-c 8 CA\ncheck_find host-c \"find CA key\"\n\n# find revoked key\nrm -f $OBJ/kh.expect\nexpect_key host-d host-d host-d 11 REVOKED\ncheck_find host-d \"find revoked key\"\n\n# find key with wildcard\nrm -f $OBJ/kh.expect\nexpect_key host-e.somedomain \"host-e*\" host-e 14\ncheck_find host-e.somedomain \"find wildcard key\"\n\n# find key among multiple hosts\nrm -f $OBJ/kh.expect\nexpect_key host-h \"host-f,host-g,host-h \" host-f 17\ncheck_find host-h \"find multiple hosts\"\n\n# Check exit code, known host\ncheck_find_exit_code host-a \"known host\" \"-q\" \"0\"\n\n# Check exit code, unknown host\ncheck_find_exit_code host-aa \"unknown host\" \"-q\" \"1\"\n\n# Check exit code, the hash mode, known host\ncheck_find_exit_code host-a \"known host\" \"-q -H\" \"0\"\n\n# Check exit code, the hash mode, unknown host\ncheck_find_exit_code host-aa \"unknown host\" \"-q -H\" \"1\"\n\ncheck_hashed_find() {\n\t_host=$1\n\t_name=$2\n\t_file=$3\n\ttest \"x$_file\" = \"x\" && _file=$OBJ/kh.invalid\n\t${SSHKEYGEN} -f $_file -HF $_host | grep '|1|' | \\\n\t    sed \"s/^[^ ]*/$_host/\" > $OBJ/kh.result\n\tif ! diff -w $OBJ/kh.expect $OBJ/kh.result ; then\n\t\tfail \"didn't find $_name\"\n\tfi\n}\n\n# Find key and hash\nrm -f $OBJ/kh.expect\nexpect_key host-a host-a host-a\nexpect_key host-a host-a host-a2\ncheck_hashed_find host-a \"find simple and hash\"\n\n# Find CA key and hash\nrm -f $OBJ/kh.expect\nexpect_key host-c host-c host-c \"\" CA\n# CA key output is not hashed.\ncheck_find host-c \"find simple and hash\" -Hq\n\n# Find revoked key and hash\nrm -f $OBJ/kh.expect\nexpect_key host-d host-d host-d \"\" REVOKED\n# Revoked key output is not hashed.\ncheck_find host-d \"find simple and hash\" -Hq\n\n# find key with wildcard and hash\nrm -f $OBJ/kh.expect\nexpect_key host-e \"host-e*\" host-e \"\"\n# Key with wildcard hostname should not be hashed.\ncheck_find host-e \"find wildcard key\" -Hq\n\n# find key among multiple hosts\nrm -f $OBJ/kh.expect\n# Comma-separated hostnames should be expanded and hashed.\nexpect_key host-f \"host-h \" host-f\nexpect_key host-g \"host-h \" host-f\nexpect_key host-h \"host-h \" host-f\ncheck_hashed_find host-h \"find multiple hosts\"\n\n# Attempt remove key on invalid file.\ncp $OBJ/kh.invalid.orig $OBJ/kh.invalid\n${SSHKEYGEN} -qf $OBJ/kh.invalid -R host-a 2>/dev/null\ndiff $OBJ/kh.invalid $OBJ/kh.invalid.orig || fail \"remove on invalid succeeded\"\n\n# Remove key\ncp $OBJ/kh.hosts.orig $OBJ/kh.hosts\n${SSHKEYGEN} -qf $OBJ/kh.hosts -R host-a 2>/dev/null\ngrep -v \"^host-a \" $OBJ/kh.hosts.orig > $OBJ/kh.expect\ndiff $OBJ/kh.hosts $OBJ/kh.expect || fail \"remove simple\"\n\n# Remove CA key\ncp $OBJ/kh.hosts.orig $OBJ/kh.hosts\n${SSHKEYGEN} -qf $OBJ/kh.hosts -R host-c 2>/dev/null\n# CA key should not be removed.\ndiff $OBJ/kh.hosts $OBJ/kh.hosts.orig || fail \"remove CA\"\n\n# Remove revoked key\ncp $OBJ/kh.hosts.orig $OBJ/kh.hosts\n${SSHKEYGEN} -qf $OBJ/kh.hosts -R host-d 2>/dev/null\n# revoked key should not be removed.\ndiff $OBJ/kh.hosts $OBJ/kh.hosts.orig || fail \"remove revoked\"\n\n# Remove wildcard\ncp $OBJ/kh.hosts.orig $OBJ/kh.hosts\n${SSHKEYGEN} -qf $OBJ/kh.hosts -R host-e.blahblah 2>/dev/null\ngrep -v \"^host-e[*] \" $OBJ/kh.hosts.orig > $OBJ/kh.expect\ndiff $OBJ/kh.hosts $OBJ/kh.expect || fail \"remove wildcard\"\n\n# Remove multiple\ncp $OBJ/kh.hosts.orig $OBJ/kh.hosts\n${SSHKEYGEN} -qf $OBJ/kh.hosts -R host-h 2>/dev/null\ngrep -v \"^host-f,\" $OBJ/kh.hosts.orig > $OBJ/kh.expect\ndiff $OBJ/kh.hosts $OBJ/kh.expect || fail \"remove wildcard\"\n\n# Attempt hash on invalid file\ncp $OBJ/kh.invalid.orig $OBJ/kh.invalid\n${SSHKEYGEN} -qf $OBJ/kh.invalid -H 2>/dev/null && fail \"hash invalid succeeded\"\ndiff $OBJ/kh.invalid $OBJ/kh.invalid.orig || fail \"invalid file modified\"\n\n# Hash valid file\ncp $OBJ/kh.hosts.orig $OBJ/kh.hosts\n${SSHKEYGEN} -qf $OBJ/kh.hosts -H 2>/dev/null || fail \"hash failed\"\ndiff $OBJ/kh.hosts.old $OBJ/kh.hosts.orig || fail \"backup differs\"\ngrep \"^host-[abfgh]\" $OBJ/kh.hosts && fail \"original hostnames persist\"\n\ncp $OBJ/kh.hosts $OBJ/kh.hashed.orig\n\n# Test lookup\nrm -f $OBJ/kh.expect\nexpect_key host-a host-a host-a\nexpect_key host-a host-a host-a2\ncheck_hashed_find host-a \"find simple in hashed\" $OBJ/kh.hosts\n\n# Test multiple expanded\nrm -f $OBJ/kh.expect\nexpect_key host-h host-h host-f\ncheck_hashed_find host-h \"find simple in hashed\" $OBJ/kh.hosts\n\n# Test remove\ncp $OBJ/kh.hashed.orig $OBJ/kh.hashed\n${SSHKEYGEN} -qf $OBJ/kh.hashed -R host-a 2>/dev/null\n${SSHKEYGEN} -qf $OBJ/kh.hashed -F host-a && fail \"found key after hashed remove\"\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}