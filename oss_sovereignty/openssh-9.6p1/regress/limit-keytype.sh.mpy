{
  "module_name": "limit-keytype.sh",
  "hash_id": "a7985dfd827f2eefd17bc0f166bb2c6d3479403a6b067075fba96f27d8cf6eb1",
  "original_prompt": "Ingested from openssh-9.6p1/regress/limit-keytype.sh",
  "human_readable_source": "#\t$OpenBSD: limit-keytype.sh,v 1.10 2021/02/25 03:27:34 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"restrict pubkey type\"\n\n# XXX sk-* keys aren't actually tested ATM.\n\nrm -f $OBJ/authorized_keys_$USER $OBJ/user_ca_key* $OBJ/user_key*\nrm -f $OBJ/authorized_principals_$USER $OBJ/cert_user_key*\n\nmv $OBJ/sshd_proxy $OBJ/sshd_proxy.orig\nmv $OBJ/ssh_proxy $OBJ/ssh_proxy.orig\n\nktype1=ed25519; ktype2=ed25519; ktype3=ed25519;\nktype4=ed25519; ktype5=ed25519; ktype6=ed25519;\nfor t in $SSH_KEYTYPES ; do \n\tcase \"$t\" in\n\t\tssh-rsa)\tktype2=rsa ;;\n\t\tecdsa*)\t\tktype3=ecdsa ;;  # unused\n\t\tssh-dss)\tktype4=dsa ;;\n\t\tsk-ssh-ed25519@openssh.com)\t\tktype5=ed25519-sk ;;\n\t\tsk-ecdsa-sha2-nistp256@openssh.com)\tktype6=ecdsa-sk ;;\n\tesac\ndone\n\n# Create a CA key\n${SSHKEYGEN} -q -N '' -t $ktype1 -f $OBJ/user_ca_key ||\\\n\tfatal \"ssh-keygen failed\"\n\n# Make some keys and a certificate.\n${SSHKEYGEN} -q -N '' -t $ktype1 -f $OBJ/user_key1 || \\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -N '' -t $ktype2 -f $OBJ/user_key2 || \\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -N '' -t $ktype2 -f $OBJ/user_key3 || \\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -N '' -t $ktype4 -f $OBJ/user_key4 || \\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -N '' -t $ktype5 -f $OBJ/user_key5 || \\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -N '' -t $ktype6 -f $OBJ/user_key6 || \\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -s $OBJ/user_ca_key -I \"regress user key for $USER\" \\\n\t-z $$ -n ${USER},mekmitasdigoat $OBJ/user_key3 ||\n\t\tfatal \"couldn't sign user_key1\"\n# Copy the private key alongside the cert to allow better control of when\n# it is offered.\nmv $OBJ/user_key3-cert.pub $OBJ/cert_user_key3.pub\n\ngrep -v IdentityFile $OBJ/ssh_proxy.orig > $OBJ/ssh_proxy\n\nopts=\"-oProtocol=2 -F $OBJ/ssh_proxy -oIdentitiesOnly=yes\"\ncertopts=\"$opts -i $OBJ/user_key3 -oCertificateFile=$OBJ/cert_user_key3.pub\"\n\necho mekmitasdigoat > $OBJ/authorized_principals_$USER\ncat $OBJ/user_key1.pub > $OBJ/authorized_keys_$USER\ncat $OBJ/user_key2.pub >> $OBJ/authorized_keys_$USER\n\nprepare_config() {\n\t(\n\t\tgrep -v \"Protocol\"  $OBJ/sshd_proxy.orig\n\t\techo \"Protocol 2\"\n\t\techo \"AuthenticationMethods publickey\"\n\t\techo \"TrustedUserCAKeys $OBJ/user_ca_key.pub\"\n\t\techo \"AuthorizedPrincipalsFile $OBJ/authorized_principals_%u\"\n\t\tfor x in \"$@\" ; do\n\t\t\techo \"$x\"\n\t\tdone\n \t) > $OBJ/sshd_proxy\n}\n\n# Return the required parameter for PubkeyAcceptedAlgorithms corresponding to\n# the supplied key type.\nkeytype() {\n\tcase \"$1\" in\n\t\tecdsa)\t\tprintf \"ecdsa-sha2-*\" ;;\n\t\ted25519)\tprintf \"ssh-ed25519\" ;;\n\t\tdsa)\t\tprintf \"ssh-dss\" ;;\n\t\trsa)\t\tprintf \"rsa-sha2-256,rsa-sha2-512,ssh-rsa\" ;;\n\t\tsk-ecdsa)\tprintf \"sk-ecdsa-*\" ;;\n\t\tsk-ssh-ed25519)\tprintf \"sk-ssh-ed25519-*\" ;;\n\tesac\n}\n\nprepare_config\n\n# Check we can log in with all key types.\n${SSH} $certopts proxy true || fatal \"cert failed\"\n${SSH} $opts -i $OBJ/user_key1 proxy true || fatal \"key1 failed\"\n${SSH} $opts -i $OBJ/user_key2 proxy true || fatal \"key2 failed\"\n\n# Allow plain Ed25519 and RSA. The certificate should fail.\nverbose \"allow $ktype2,$ktype1\"\nprepare_config \\\n\t\"PubkeyAcceptedAlgorithms `keytype $ktype2`,`keytype $ktype1`\"\n${SSH} $certopts proxy true && fatal \"cert succeeded\"\n${SSH} $opts -i $OBJ/user_key1 proxy true || fatal \"key1 failed\"\n${SSH} $opts -i $OBJ/user_key2 proxy true || fatal \"key2 failed\"\n\n# Allow Ed25519 only.\nverbose \"allow $ktype1\"\nprepare_config \"PubkeyAcceptedAlgorithms `keytype $ktype1`\"\n${SSH} $certopts proxy true && fatal \"cert succeeded\"\n${SSH} $opts -i $OBJ/user_key1 proxy true || fatal \"key1 failed\"\nif [ \"$ktype1\" != \"$ktype2\" ]; then\n\t${SSH} $opts -i $OBJ/user_key2 proxy true && fatal \"key2 succeeded\"\nfi\n\n# Allow all certs. Plain keys should fail.\nverbose \"allow cert only\"\nprepare_config \"PubkeyAcceptedAlgorithms *-cert-v01@openssh.com\"\n${SSH} $certopts proxy true || fatal \"cert failed\"\n${SSH} $opts -i $OBJ/user_key1 proxy true && fatal \"key1 succeeded\"\n${SSH} $opts -i $OBJ/user_key2 proxy true && fatal \"key2 succeeded\"\n\n# Allow RSA in main config, Ed25519 for non-existent user.\nverbose \"match w/ no match\"\nprepare_config \"PubkeyAcceptedAlgorithms `keytype $ktype2`\" \\\n\t\"Match user x$USER\" \"PubkeyAcceptedAlgorithms +`keytype $ktype1`\"\n${SSH} $certopts proxy true && fatal \"cert succeeded\"\nif [ \"$ktype1\" != \"$ktype2\" ]; then\n\t${SSH} $opts -i $OBJ/user_key1 proxy true && fatal \"key1 succeeded\"\nfi\n${SSH} $opts -i $OBJ/user_key2 proxy true || fatal \"key2 failed\"\n\n# Allow only DSA in main config, Ed25519 for user.\nverbose \"match w/ matching\"\nprepare_config \"PubkeyAcceptedAlgorithms `keytype $ktype4`\" \\\n\t\"Match user $USER\" \"PubkeyAcceptedAlgorithms +`keytype $ktype1`\"\n${SSH} $certopts proxy true || fatal \"cert failed\"\n${SSH} $opts -i $OBJ/user_key1 proxy true || fatal \"key1 failed\"\n${SSH} $opts -i $OBJ/user_key4 proxy true && fatal \"key4 succeeded\"\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}