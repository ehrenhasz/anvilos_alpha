{
  "module_name": "cert-file.sh",
  "hash_id": "e6fe43c295c765fe47e5b2e0336a2d1564eff43f8ca6dff980b90381d3549e7f",
  "original_prompt": "Ingested from openssh-9.6p1/regress/cert-file.sh",
  "human_readable_source": "#\t$OpenBSD: cert-file.sh,v 1.8 2019/11/26 23:43:10 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"ssh with certificates\"\n\nrm -f $OBJ/user_ca_key* $OBJ/user_key*\nrm -f $OBJ/cert_user_key*\n\n# Create a CA key\n${SSHKEYGEN} -q -N '' -t ed25519 -f $OBJ/user_ca_key1 ||\\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -N '' -t ed25519  -f $OBJ/user_ca_key2 ||\\\n\tfatal \"ssh-keygen failed\"\n\n# Make some keys and certificates.\n${SSHKEYGEN} -q -N '' -t ed25519 -f $OBJ/user_key1 || \\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -N '' -t ed25519 -f $OBJ/user_key2 || \\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -N '' -t ed25519 -f $OBJ/user_key3 || \\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -N '' -t ed25519 -f $OBJ/user_key4 || \\\n\tfatal \"ssh-keygen failed\"\n${SSHKEYGEN} -q -N '' -t ed25519 -f $OBJ/user_key5 || \\\n\tfatal \"ssh-keygen failed\"\n\n# Move the certificate to a different address to better control\n# when it is offered.\n${SSHKEYGEN} -q -s $OBJ/user_ca_key1 -I \"regress user key for $USER\" \\\n\t-z $$ -n ${USER} $OBJ/user_key1 ||\n\t\tfatal \"couldn't sign user_key1 with user_ca_key1\"\nmv $OBJ/user_key1-cert.pub $OBJ/cert_user_key1_1.pub\n${SSHKEYGEN} -q -s $OBJ/user_ca_key2 -I \"regress user key for $USER\" \\\n\t-z $$ -n ${USER} $OBJ/user_key1 ||\n\t\tfatal \"couldn't sign user_key1 with user_ca_key2\"\nmv $OBJ/user_key1-cert.pub $OBJ/cert_user_key1_2.pub\n${SSHKEYGEN} -q -s $OBJ/user_ca_key1 -I \"regress user key for $USER\" \\\n\t-z $$ -n ${USER} $OBJ/user_key3 ||\n\t\tfatal \"couldn't sign user_key3 with user_ca_key1\"\nrm $OBJ/user_key3.pub # to test use of private key w/o public half.\n${SSHKEYGEN} -q -s $OBJ/user_ca_key1 -I \"regress user key for $USER\" \\\n\t-z $$ -n ${USER} $OBJ/user_key4 ||\n\t\tfatal \"couldn't sign user_key4 with user_ca_key1\"\nrm $OBJ/user_key4 $OBJ/user_key4.pub # to test no matching pub/private key case.\n\ntrace 'try with identity files'\nopts=\"-F $OBJ/ssh_proxy -oIdentitiesOnly=yes\"\nopts2=\"$opts -i $OBJ/user_key1 -i $OBJ/user_key2\"\necho \"cert-authority $(cat $OBJ/user_ca_key1.pub)\" > $OBJ/authorized_keys_$USER\n\n# Make a clean config that doesn't have any pre-added identities.\ncat $OBJ/ssh_proxy | grep -v IdentityFile > $OBJ/no_identity_config\n\n# XXX: verify that certificate used was what we expect. Needs exposure of\n# keys via environment variable or similar.\n\n\t# Key with no .pub should work - finding the equivalent *-cert.pub.\nverbose \"identity cert with no plain public file\"\n${SSH} -F $OBJ/no_identity_config -oIdentitiesOnly=yes \\\n    -i $OBJ/user_key3 somehost exit 52\n[ $? -ne 52 ] && fail \"ssh failed\"\n\n# CertificateFile matching private key with no .pub file should work.\nverbose \"CertificateFile with no plain public file\"\n${SSH} -F $OBJ/no_identity_config -oIdentitiesOnly=yes \\\n    -oCertificateFile=$OBJ/user_key3-cert.pub \\\n    -i $OBJ/user_key3 somehost exit 52\n[ $? -ne 52 ] && fail \"ssh failed\"\n\n# Just keys should fail\nverbose \"plain keys\"\n${SSH} $opts2 somehost exit 52\nr=$?\nif [ $r -eq 52 ]; then\n\tfail \"ssh succeeded with no certs\"\nfi\n\n# Keys with untrusted cert should fail.\nverbose \"untrusted cert\"\nopts3=\"$opts2 -oCertificateFile=$OBJ/cert_user_key1_2.pub\"\n${SSH} $opts3 somehost exit 52\nr=$?\nif [ $r -eq 52 ]; then\n\tfail \"ssh succeeded with bad cert\"\nfi\n\n# Good cert with bad key should fail.\nverbose \"good cert, bad key\"\nopts3=\"$opts -i $OBJ/user_key2\"\nopts3=\"$opts3 -oCertificateFile=$OBJ/cert_user_key1_1.pub\"\n${SSH} $opts3 somehost exit 52\nr=$?\nif [ $r -eq 52 ]; then\n\tfail \"ssh succeeded with no matching key\"\nfi\n\n# Keys with one trusted cert, should succeed.\nverbose \"single trusted\"\nopts3=\"$opts2 -oCertificateFile=$OBJ/cert_user_key1_1.pub\"\n${SSH} $opts3 somehost exit 52\nr=$?\nif [ $r -ne 52 ]; then\n\tfail \"ssh failed with trusted cert and key\"\nfi\n\n# Multiple certs and keys, with one trusted cert, should succeed.\nverbose \"multiple trusted\"\nopts3=\"$opts2 -oCertificateFile=$OBJ/cert_user_key1_2.pub\"\nopts3=\"$opts3 -oCertificateFile=$OBJ/cert_user_key1_1.pub\"\n${SSH} $opts3 somehost exit 52\nr=$?\nif [ $r -ne 52 ]; then\n\tfail \"ssh failed with multiple certs\"\nfi\n\n#next, using an agent in combination with the keys\nSSH_AUTH_SOCK=/nonexistent ${SSHADD} -l > /dev/null 2>&1\nif [ $? -ne 2 ]; then\n\tfatal \"ssh-add -l did not fail with exit code 2\"\nfi\n\ntrace \"start agent\"\neval `${SSHAGENT} ${EXTRA_AGENT_ARGS} -s` > /dev/null\nr=$?\nif [ $r -ne 0 ]; then\n\tfatal \"could not start ssh-agent: exit code $r\"\nfi\n\n# add private keys to agent\n${SSHADD} -k $OBJ/user_key2 > /dev/null 2>&1\nif [ $? -ne 0 ]; then\n\tfatal \"ssh-add did not succeed with exit code 0\"\nfi\n${SSHADD} -k $OBJ/user_key1 > /dev/null 2>&1\nif [ $? -ne 0 ]; then\n\tfatal \"ssh-add did not succeed with exit code 0\"\nfi\n\n# try ssh with the agent and certificates\nopts=\"-F $OBJ/ssh_proxy\"\n# with no certificates, should fail\n${SSH} $opts somehost exit 52\nif [ $? -eq 52 ]; then\n\tfail \"ssh connect with agent in succeeded with no cert\"\nfi\n\n#with an untrusted certificate, should fail\nopts=\"$opts -oCertificateFile=$OBJ/cert_user_key1_2.pub\"\n${SSH} $opts somehost exit 52\nif [ $? -eq 52 ]; then\n\tfail \"ssh connect with agent in succeeded with bad cert\"\nfi\n\n#with an additional trusted certificate, should succeed\nopts=\"$opts -oCertificateFile=$OBJ/cert_user_key1_1.pub\"\n${SSH} $opts somehost exit 52\nif [ $? -ne 52 ]; then\n\tfail \"ssh connect with agent in failed with good cert\"\nfi\n\ntrace \"kill agent\"\n${SSHAGENT} -k > /dev/null\n\n#cleanup\nrm -f $OBJ/user_ca_key* $OBJ/user_key*\nrm -f $OBJ/cert_user_key*\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}