{
  "module_name": "sftp-perm.sh",
  "hash_id": "5f881a3b31add3bc8cb3e640d281296b7a021f336c8760f2a87154d0e2f98d56",
  "original_prompt": "Ingested from openssh-9.6p1/regress/sftp-perm.sh",
  "human_readable_source": "#\t$OpenBSD: sftp-perm.sh,v 1.3 2021/03/31 21:59:26 djm Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"sftp permissions\"\n\nSERVER_LOG=${OBJ}/sftp-server.log\nCLIENT_LOG=${OBJ}/sftp.log\nTEST_SFTP_SERVER=${OBJ}/sftp-server.sh\n\nprepare_server() {\n\tprintf \"#!/bin/sh\\nexec $SFTPSERVER -el debug3 $* 2>$SERVER_LOG\\n\" \\\n\t> $TEST_SFTP_SERVER\n\tchmod a+x $TEST_SFTP_SERVER\n}\n\nrun_client() {\n\techo \"$@\" | ${SFTP} -D ${TEST_SFTP_SERVER} -vvvb - >$CLIENT_LOG 2>&1\n}\n\nprepare_files() {\n\t_prep=\"$1\"\n\trm -f ${COPY} ${COPY}.1\n\ttest -d ${COPY}.dd && { rmdir ${COPY}.dd || fatal \"rmdir ${COPY}.dd\"; }\n\ttest -z \"$_prep\" && return\n\tsh -c \"$_prep\" || fail \"preparation failed: \\\"$_prep\\\"\"\n}\n\npostcondition() {\n\t_title=\"$1\"\n\t_check=\"$2\"\n\ttest -z \"$_check\" && return\n\t${TEST_SHELL} -c \"$_check\" || fail \"postcondition check failed: $_title\"\n}\n\nro_test() {\n\t_desc=$1\n\t_cmd=\"$2\"\n\t_prep=\"$3\"\n\t_expect_success_post=\"$4\"\n\t_expect_fail_post=\"$5\"\n\tverbose \"$tid: read-only $_desc\"\n\t# Plain (no options, mostly to test that _cmd is good)\n\tprepare_files \"$_prep\"\n\tprepare_server\n\trun_client \"$_cmd\" || fail \"plain $_desc failed\"\n\tpostcondition \"$_desc no-readonly\" \"$_expect_success_post\"\n\t# Read-only enabled\n\tprepare_files \"$_prep\"\n\tprepare_server -R\n\trun_client \"$_cmd\" && fail \"read-only $_desc succeeded\"\n\tpostcondition \"$_desc readonly\" \"$_expect_fail_post\"\n}\n\nperm_test() {\n\t_op=$1\n\t_whitelist_ops=$2\n\t_cmd=\"$3\"\n\t_prep=\"$4\"\n\t_expect_success_post=\"$5\"\n\t_expect_fail_post=\"$6\"\n\tverbose \"$tid: explicit $_op\"\n\t# Plain (no options, mostly to test that _cmd is good)\n\tprepare_files \"$_prep\"\n\tprepare_server\n\trun_client \"$_cmd\" || fail \"plain $_op failed\"\n\tpostcondition \"$_op no white/blacklists\" \"$_expect_success_post\"\n\t# Whitelist\n\tprepare_files \"$_prep\"\n\tprepare_server -p $_op,$_whitelist_ops\n\trun_client \"$_cmd\" || fail \"whitelisted $_op failed\"\n\tpostcondition \"$_op whitelisted\" \"$_expect_success_post\"\n\t# Blacklist\n\tprepare_files \"$_prep\"\n\tprepare_server -P $_op\n\trun_client \"$_cmd\" && fail \"blacklisted $_op succeeded\"\n\tpostcondition \"$_op blacklisted\" \"$_expect_fail_post\"\n\t# Whitelist with op missing.\n\tprepare_files \"$_prep\"\n\tprepare_server -p $_whitelist_ops\n\trun_client \"$_cmd\" && fail \"no whitelist $_op succeeded\"\n\tpostcondition \"$_op not in whitelist\" \"$_expect_fail_post\"\n}\n\nro_test \\\n\t\"upload\" \\\n\t\"put $DATA $COPY\" \\\n\t\"\" \\\n\t\"cmp $DATA $COPY\" \\\n\t\"test ! -f $COPY\"\n\nro_test \\\n\t\"setstat\" \\\n\t\"chmod 0700 $COPY\" \\\n\t\"touch $COPY; chmod 0400 $COPY\" \\\n\t\"test -x $COPY\" \\\n\t\"test ! -x $COPY\"\n\nro_test \\\n\t\"rm\" \\\n\t\"rm $COPY\" \\\n\t\"touch $COPY\" \\\n\t\"test ! -f $COPY\" \\\n\t\"test -f $COPY\"\n\nro_test \\\n\t\"mkdir\" \\\n\t\"mkdir ${COPY}.dd\" \\\n\t\"\" \\\n\t\"test -d ${COPY}.dd\" \\\n\t\"test ! -d ${COPY}.dd\"\n\nro_test \\\n\t\"rmdir\" \\\n\t\"rmdir ${COPY}.dd\" \\\n\t\"mkdir ${COPY}.dd\" \\\n\t\"test ! -d ${COPY}.dd\" \\\n\t\"test -d ${COPY}.dd\"\n\nro_test \\\n\t\"posix-rename\" \\\n\t\"rename $COPY ${COPY}.1\" \\\n\t\"touch $COPY\" \\\n\t\"test -f ${COPY}.1 -a ! -f $COPY\" \\\n\t\"test -f $COPY -a ! -f ${COPY}.1\"\n\nro_test \\\n\t\"oldrename\" \\\n\t\"rename -l $COPY ${COPY}.1\" \\\n\t\"touch $COPY\" \\\n\t\"test -f ${COPY}.1 -a ! -f $COPY\" \\\n\t\"test -f $COPY -a ! -f ${COPY}.1\"\n\nro_test \\\n\t\"symlink\" \\\n\t\"ln -s $COPY ${COPY}.1\" \\\n\t\"touch $COPY\" \\\n\t\"test -h ${COPY}.1\" \\\n\t\"test ! -h ${COPY}.1\"\n\nro_test \\\n\t\"hardlink\" \\\n\t\"ln $COPY ${COPY}.1\" \\\n\t\"touch $COPY\" \\\n\t\"test -f ${COPY}.1\" \\\n\t\"test ! -f ${COPY}.1\"\n\n# Test explicit permissions\n\nperm_test \\\n\t\"open\" \\\n\t\"realpath,stat,lstat,read,close\" \\\n\t\"get $DATA $COPY\" \\\n\t\"\" \\\n\t\"cmp $DATA $COPY\" \\\n\t\"! cmp $DATA $COPY 2>/dev/null\"\n\nperm_test \\\n\t\"read\" \\\n\t\"realpath,stat,lstat,open,close\" \\\n\t\"get $DATA $COPY\" \\\n\t\"\" \\\n\t\"cmp $DATA $COPY\" \\\n\t\"! cmp $DATA $COPY 2>/dev/null\"\n\nperm_test \\\n\t\"write\" \\\n\t\"realpath,stat,lstat,open,close\" \\\n\t\"put $DATA $COPY\" \\\n\t\"\" \\\n\t\"cmp $DATA $COPY\" \\\n\t\"! cmp $DATA $COPY 2>/dev/null\"\n\nperm_test \\\n\t\"lstat\" \\\n\t\"realpath,stat,open,read,close\" \\\n\t\"get $DATA $COPY\" \\\n\t\"\" \\\n\t\"cmp $DATA $COPY\" \\\n\t\"! cmp $DATA $COPY 2>/dev/null\"\n\nperm_test \\\n\t\"opendir\" \\\n\t\"realpath,readdir,stat,lstat\" \\\n\t\"ls -ln $OBJ\"\n\nperm_test \\\n\t\"readdir\" \\\n\t\"realpath,opendir,stat,lstat\" \\\n\t\"ls -ln $OBJ\"\n\nperm_test \\\n\t\"setstat\" \\\n\t\"realpath,stat,lstat\" \\\n\t\"chmod 0700 $COPY\" \\\n\t\"touch $COPY; chmod 0400 $COPY\" \\\n\t\"test -x $COPY\" \\\n\t\"test ! -x $COPY\"\n\nperm_test \\\n\t\"remove\" \\\n\t\"realpath,stat,lstat\" \\\n\t\"rm $COPY\" \\\n\t\"touch $COPY\" \\\n\t\"test ! -f $COPY\" \\\n\t\"test -f $COPY\"\n\nperm_test \\\n\t\"mkdir\" \\\n\t\"realpath,stat,lstat\" \\\n\t\"mkdir ${COPY}.dd\" \\\n\t\"\" \\\n\t\"test -d ${COPY}.dd\" \\\n\t\"test ! -d ${COPY}.dd\"\n\nperm_test \\\n\t\"rmdir\" \\\n\t\"realpath,stat,lstat\" \\\n\t\"rmdir ${COPY}.dd\" \\\n\t\"mkdir ${COPY}.dd\" \\\n\t\"test ! -d ${COPY}.dd\" \\\n\t\"test -d ${COPY}.dd\"\n\n# Can't readily test this because the client falls back to traditional rename.\n# XXX maybe there is a behaviorial difference we can test for?\n#perm_test \\\n#\t\"posix-rename\" \\\n#\t\"realpath,stat,lstat\" \\\n#\t\"rename $COPY ${COPY}.1\" \\\n#\t\"touch $COPY\" \\\n#\t\"test -f ${COPY}.1 -a ! -f $COPY\" \\\n#\t\"test -f $COPY -a ! -f ${COPY}.1\"\n\nperm_test \\\n\t\"rename\" \\\n\t\"realpath,stat,lstat\" \\\n\t\"rename -l $COPY ${COPY}.1\" \\\n\t\"touch $COPY\" \\\n\t\"test -f ${COPY}.1 -a ! -f $COPY\" \\\n\t\"test -f $COPY -a ! -f ${COPY}.1\"\n\nperm_test \\\n\t\"symlink\" \\\n\t\"realpath,stat,lstat\" \\\n\t\"ln -s $COPY ${COPY}.1\" \\\n\t\"touch $COPY\" \\\n\t\"test -h ${COPY}.1\" \\\n\t\"test ! -h ${COPY}.1\"\n\nperm_test \\\n\t\"hardlink\" \\\n\t\"realpath,stat,lstat\" \\\n\t\"ln $COPY ${COPY}.1\" \\\n\t\"touch $COPY\" \\\n\t\"test -f ${COPY}.1\" \\\n\t\"test ! -f ${COPY}.1\"\n\nperm_test \\\n\t\"statvfs\" \\\n\t\"realpath,stat,lstat\" \\\n\t\"df /\"\n\n# XXX need good tests for:\n# fstat\n# fsetstat\n# realpath\n# stat\n# readlink\n# fstatvfs\n\nrm -rf ${COPY} ${COPY}.1 ${COPY}.dd\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}