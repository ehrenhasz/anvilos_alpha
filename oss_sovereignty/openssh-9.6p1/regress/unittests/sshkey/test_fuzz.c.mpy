{
  "module_name": "test_fuzz.c",
  "hash_id": "9f2ff60bc5e85cdd9c9febe00a182e3146363b14b5405f28881f03b9fe95a4ec",
  "original_prompt": "Ingested from openssh-9.6p1/regress/unittests/sshkey/test_fuzz.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <fcntl.h>\n#include <stdio.h>\n#ifdef HAVE_STDINT_H\n#include <stdint.h>\n#endif\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n\n#ifdef WITH_OPENSSL\n#include <openssl/bn.h>\n#include <openssl/rsa.h>\n#include <openssl/dsa.h>\n#include <openssl/objects.h>\n#ifdef OPENSSL_HAS_NISTP256\n# include <openssl/ec.h>\n#endif\n#endif\n\n#include \"../test_helper/test_helper.h\"\n\n#include \"ssherr.h\"\n#include \"authfile.h\"\n#include \"sshkey.h\"\n#include \"sshbuf.h\"\n\n#include \"common.h\"\n\nvoid sshkey_fuzz_tests(void);\n\nstatic void\nonerror(void *fuzz)\n{\n\tfprintf(stderr, \"Failed during fuzz:\\n\");\n\tfuzz_dump((struct fuzz *)fuzz);\n}\n\nstatic void\npublic_fuzz(struct sshkey *k)\n{\n\tstruct sshkey *k1;\n\tstruct sshbuf *buf;\n\tstruct fuzz *fuzz;\n\tu_int fuzzers = FUZZ_1_BIT_FLIP | FUZZ_1_BYTE_FLIP |\n\t    FUZZ_TRUNCATE_START | FUZZ_TRUNCATE_END;\n\n\tif (test_is_fast())\n\t\tfuzzers &= ~FUZZ_1_BIT_FLIP;\n\tif (test_is_slow())\n\t\tfuzzers |= FUZZ_2_BIT_FLIP | FUZZ_2_BYTE_FLIP;\n\tASSERT_PTR_NE(buf = sshbuf_new(), NULL);\n\tASSERT_INT_EQ(sshkey_putb(k, buf), 0);\n\tfuzz = fuzz_begin(fuzzers, sshbuf_mutable_ptr(buf), sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_from_blob(sshbuf_ptr(buf), sshbuf_len(buf),\n\t    &k1), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\tif (sshkey_from_blob(fuzz_ptr(fuzz), fuzz_len(fuzz), &k1) == 0)\n\t\t\tsshkey_free(k1);\n\t}\n\tfuzz_cleanup(fuzz);\n}\n\nstatic void\nsig_fuzz(struct sshkey *k, const char *sig_alg)\n{\n\tstruct fuzz *fuzz;\n\tu_char *sig, c[] = \"some junk to be signed\";\n\tsize_t l;\n\tu_int fuzzers = FUZZ_1_BIT_FLIP | FUZZ_1_BYTE_FLIP | FUZZ_2_BYTE_FLIP |\n\t    FUZZ_TRUNCATE_START | FUZZ_TRUNCATE_END;\n\n\tif (test_is_fast())\n\t\tfuzzers &= ~FUZZ_2_BYTE_FLIP;\n\tif (test_is_slow())\n\t\tfuzzers |= FUZZ_2_BIT_FLIP;\n\n\tASSERT_INT_EQ(sshkey_sign(k, &sig, &l, c, sizeof(c),\n\t    sig_alg, NULL, NULL, 0), 0);\n\tASSERT_SIZE_T_GT(l, 0);\n\tfuzz = fuzz_begin(fuzzers, sig, l);\n\tASSERT_INT_EQ(sshkey_verify(k, sig, l, c, sizeof(c), NULL, 0, NULL), 0);\n\tfree(sig);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(; !fuzz_done(fuzz); fuzz_next(fuzz)) {\n\t\t \n\t\tif (fuzz_matches_original(fuzz))\n\t\t\tcontinue;\n\t\tASSERT_INT_NE(sshkey_verify(k, fuzz_ptr(fuzz), fuzz_len(fuzz),\n\t\t    c, sizeof(c), NULL, 0, NULL), 0);\n\t}\n\tfuzz_cleanup(fuzz);\n}\n\n#define NUM_FAST_BASE64_TESTS\t1024\n\nvoid\nsshkey_fuzz_tests(void)\n{\n\tstruct sshkey *k1;\n\tstruct sshbuf *buf, *fuzzed;\n\tstruct fuzz *fuzz;\n\tint r, i;\n\n#ifdef WITH_OPENSSL\n\tTEST_START(\"fuzz RSA private\");\n\tbuf = load_file(\"rsa_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(i = 0; !fuzz_done(fuzz); i++, fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t\tif (test_is_fast() && i >= NUM_FAST_BASE64_TESTS)\n\t\t\tbreak;\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA new-format private\");\n\tbuf = load_file(\"rsa_n\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(i = 0; !fuzz_done(fuzz); i++, fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t\tif (test_is_fast() && i >= NUM_FAST_BASE64_TESTS)\n\t\t\tbreak;\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA private\");\n\tbuf = load_file(\"dsa_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(i = 0; !fuzz_done(fuzz); i++, fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t\tif (test_is_fast() && i >= NUM_FAST_BASE64_TESTS)\n\t\t\tbreak;\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA new-format private\");\n\tbuf = load_file(\"dsa_n\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(i = 0; !fuzz_done(fuzz); i++, fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t\tif (test_is_fast() && i >= NUM_FAST_BASE64_TESTS)\n\t\t\tbreak;\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"fuzz ECDSA private\");\n\tbuf = load_file(\"ecdsa_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(i = 0; !fuzz_done(fuzz); i++, fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t\tif (test_is_fast() && i >= NUM_FAST_BASE64_TESTS)\n\t\t\tbreak;\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz ECDSA new-format private\");\n\tbuf = load_file(\"ecdsa_n\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(i = 0; !fuzz_done(fuzz); i++, fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t\tif (test_is_fast() && i >= NUM_FAST_BASE64_TESTS)\n\t\t\tbreak;\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n#endif  \n#endif  \n\n\tTEST_START(\"fuzz Ed25519 private\");\n\tbuf = load_file(\"ed25519_1\");\n\tfuzz = fuzz_begin(FUZZ_BASE64, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf));\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshkey_free(k1);\n\tsshbuf_free(buf);\n\tASSERT_PTR_NE(fuzzed = sshbuf_new(), NULL);\n\tTEST_ONERROR(onerror, fuzz);\n\tfor(i = 0; !fuzz_done(fuzz); i++, fuzz_next(fuzz)) {\n\t\tr = sshbuf_put(fuzzed, fuzz_ptr(fuzz), fuzz_len(fuzz));\n\t\tASSERT_INT_EQ(r, 0);\n\t\tif (sshkey_parse_private_fileblob(fuzzed, \"\", &k1, NULL) == 0)\n\t\t\tsshkey_free(k1);\n\t\tsshbuf_reset(fuzzed);\n\t\tif (test_is_fast() && i >= NUM_FAST_BASE64_TESTS)\n\t\t\tbreak;\n\t}\n\tsshbuf_free(fuzzed);\n\tfuzz_cleanup(fuzz);\n\tTEST_DONE();\n\n#ifdef WITH_OPENSSL\n\tTEST_START(\"fuzz RSA public\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"rsa_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA public\");\n\tbuf = load_file(\"dsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"dsa_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"fuzz ECDSA public\");\n\tbuf = load_file(\"ecdsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz ECDSA cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"ecdsa_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif  \n#endif  \n\n\tTEST_START(\"fuzz Ed25519 public\");\n\tbuf = load_file(\"ed25519_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz Ed25519 cert\");\n\tASSERT_INT_EQ(sshkey_load_cert(test_data_file(\"ed25519_1\"), &k1), 0);\n\tpublic_fuzz(k1);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef WITH_OPENSSL\n\tTEST_START(\"fuzz RSA sig\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, \"ssh-rsa\");\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA SHA256 sig\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, \"rsa-sha2-256\");\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz RSA SHA512 sig\");\n\tbuf = load_file(\"rsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, \"rsa-sha2-512\");\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n\tTEST_START(\"fuzz DSA sig\");\n\tbuf = load_file(\"dsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n#ifdef OPENSSL_HAS_ECC\n\tTEST_START(\"fuzz ECDSA sig\");\n\tbuf = load_file(\"ecdsa_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n#endif  \n#endif  \n\n\tTEST_START(\"fuzz Ed25519 sig\");\n\tbuf = load_file(\"ed25519_1\");\n\tASSERT_INT_EQ(sshkey_parse_private_fileblob(buf, \"\", &k1, NULL), 0);\n\tsshbuf_free(buf);\n\tsig_fuzz(k1, NULL);\n\tsshkey_free(k1);\n\tTEST_DONE();\n\n \n \n\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}