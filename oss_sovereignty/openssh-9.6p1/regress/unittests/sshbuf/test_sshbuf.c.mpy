{
  "module_name": "test_sshbuf.c",
  "hash_id": "d0efb25bc00f47d200ffb56962c4a978b64a0880a846678dbe3ff217534cd355",
  "original_prompt": "Ingested from openssh-9.6p1/regress/unittests/sshbuf/test_sshbuf.c",
  "human_readable_source": " \n \n\n#define SSHBUF_INTERNAL 1\t \n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <stdio.h>\n#ifdef HAVE_STDINT_H\n# include <stdint.h>\n#endif\n#include <stdlib.h>\n#include <string.h>\n\n#include \"../test_helper/test_helper.h\"\n\n#include \"ssherr.h\"\n#include \"sshbuf.h\"\n\nvoid sshbuf_tests(void);\n\n#ifndef roundup\n#define roundup(x, y)   ((((x)+((y)-1))/(y))*(y))\n#endif\n\nvoid\nsshbuf_tests(void)\n{\n\tstruct sshbuf *p1;\n\tconst u_char *cdp;\n\tu_char *dp;\n\tsize_t sz;\n\tint r;\n\n\tTEST_START(\"allocate sshbuf\");\n\tp1 = sshbuf_new();\n\tASSERT_PTR_NE(p1, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"max size on fresh buffer\");\n\tASSERT_SIZE_T_GT(sshbuf_max_size(p1), 0);\n\tTEST_DONE();\n\n\tTEST_START(\"available on fresh buffer\");\n\tASSERT_SIZE_T_GT(sshbuf_avail(p1), 0);\n\tTEST_DONE();\n\n\tTEST_START(\"len = 0 on empty buffer\");\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 0);\n\tTEST_DONE();\n\n\tTEST_START(\"set valid max size\");\n\tASSERT_INT_EQ(sshbuf_set_max_size(p1, 65536), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_max_size(p1), 65536);\n\tTEST_DONE();\n\n\tTEST_START(\"available on limited buffer\");\n\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), 65536);\n\tTEST_DONE();\n\n\tTEST_START(\"free\");\n\tsshbuf_free(p1);\n\tTEST_DONE();\n\n\tTEST_START(\"consume on empty buffer\");\n\tp1 = sshbuf_new();\n\tASSERT_PTR_NE(p1, NULL);\n\tASSERT_INT_EQ(sshbuf_consume(p1, 0), 0);\n\tASSERT_INT_EQ(sshbuf_consume(p1, 1), SSH_ERR_MESSAGE_INCOMPLETE);\n\tsshbuf_free(p1);\n\tTEST_DONE();\n\n\tTEST_START(\"consume_end on empty buffer\");\n\tp1 = sshbuf_new();\n\tASSERT_PTR_NE(p1, NULL);\n\tASSERT_INT_EQ(sshbuf_consume_end(p1, 0), 0);\n\tASSERT_INT_EQ(sshbuf_consume_end(p1, 1), SSH_ERR_MESSAGE_INCOMPLETE);\n\tsshbuf_free(p1);\n\tTEST_DONE();\n\n\tTEST_START(\"reserve space\");\n\tp1 = sshbuf_new();\n\tASSERT_PTR_NE(p1, NULL);\n\tr = sshbuf_reserve(p1, 1, &dp);\n\tASSERT_INT_EQ(r, 0);\n\tASSERT_PTR_NE(dp, NULL);\n\t*dp = 0x11;\n\tr = sshbuf_reserve(p1, 3, &dp);\n\tASSERT_INT_EQ(r, 0);\n\tASSERT_PTR_NE(dp, NULL);\n\t*dp++ = 0x22;\n\t*dp++ = 0x33;\n\t*dp++ = 0x44;\n\tTEST_DONE();\n\n\tTEST_START(\"sshbuf_len on filled buffer\");\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 4);\n\tTEST_DONE();\n\n\tTEST_START(\"sshbuf_ptr on filled buffer\");\n\tcdp = sshbuf_ptr(p1);\n\tASSERT_PTR_NE(cdp, NULL);\n\tASSERT_U8_EQ(cdp[0], 0x11);\n\tASSERT_U8_EQ(cdp[1], 0x22);\n\tASSERT_U8_EQ(cdp[2], 0x33);\n\tASSERT_U8_EQ(cdp[3], 0x44);\n\tTEST_DONE();\n\n\tTEST_START(\"consume on filled buffer\");\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 4);\n\tASSERT_INT_EQ(sshbuf_consume(p1, 0), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 4);\n\tr = sshbuf_consume(p1, 64);\n\tASSERT_INT_EQ(r, SSH_ERR_MESSAGE_INCOMPLETE);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 4);\n\tASSERT_INT_EQ(sshbuf_consume(p1, 1), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 3);\n\tcdp = sshbuf_ptr(p1);\n\tASSERT_PTR_NE(p1, NULL);\n\tASSERT_U8_EQ(cdp[0], 0x22);\n\tASSERT_INT_EQ(sshbuf_consume(p1, 2), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 1);\n\tcdp = sshbuf_ptr(p1);\n\tASSERT_PTR_NE(p1, NULL);\n\tASSERT_U8_EQ(cdp[0], 0x44);\n\tr = sshbuf_consume(p1, 2);\n\tASSERT_INT_EQ(r, SSH_ERR_MESSAGE_INCOMPLETE);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 1);\n\tASSERT_INT_EQ(sshbuf_consume(p1, 1), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 0);\n\tr = sshbuf_consume(p1, 1);\n\tASSERT_INT_EQ(r, SSH_ERR_MESSAGE_INCOMPLETE);\n\tsshbuf_free(p1);\n\tTEST_DONE();\n\n\tTEST_START(\"consume_end on filled buffer\");\n\tp1 = sshbuf_new();\n\tASSERT_PTR_NE(p1, NULL);\n\tr = sshbuf_reserve(p1, 4, &dp);\n\tASSERT_INT_EQ(r, 0);\n\tASSERT_PTR_NE(dp, NULL);\n\t*dp++ = 0x11;\n\t*dp++ = 0x22;\n\t*dp++ = 0x33;\n\t*dp++ = 0x44;\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 4);\n\tr = sshbuf_consume_end(p1, 5);\n\tASSERT_INT_EQ(r, SSH_ERR_MESSAGE_INCOMPLETE);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 4);\n\tASSERT_INT_EQ(sshbuf_consume_end(p1, 3), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 1);\n\tcdp = sshbuf_ptr(p1);\n\tASSERT_PTR_NE(cdp, NULL);\n\tASSERT_U8_EQ(*cdp, 0x11);\n\tr = sshbuf_consume_end(p1, 2);\n\tASSERT_INT_EQ(r, SSH_ERR_MESSAGE_INCOMPLETE);\n\tASSERT_INT_EQ(sshbuf_consume_end(p1, 1), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 0);\n\tsshbuf_free(p1);\n\tTEST_DONE();\n\n\tTEST_START(\"fill limited buffer\");\n\tp1 = sshbuf_new();\n\tASSERT_PTR_NE(p1, NULL);\n\tASSERT_INT_EQ(sshbuf_set_max_size(p1, 1223), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_max_size(p1), 1223);\n\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), 1223);\n\tr = sshbuf_reserve(p1, 1223, &dp);\n\tASSERT_INT_EQ(r, 0);\n\tASSERT_PTR_NE(dp, NULL);\n\tmemset(dp, 0xd7, 1223);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 1223);\n\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), 0);\n\tr = sshbuf_reserve(p1, 1, &dp);\n\tASSERT_INT_EQ(r, SSH_ERR_NO_BUFFER_SPACE);\n\tASSERT_PTR_EQ(dp, NULL);\n\tTEST_DONE();\n\n\tTEST_START(\"consume and force compaction\");\n\tASSERT_INT_EQ(sshbuf_consume(p1, 223), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 1000);\n\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), 223);\n\tr = sshbuf_reserve(p1, 224, &dp);\n\tASSERT_INT_EQ(r, SSH_ERR_NO_BUFFER_SPACE);\n\tASSERT_PTR_EQ(dp, NULL);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 1000);\n\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), 223);\n\tr = sshbuf_reserve(p1, 223, &dp);\n\tASSERT_INT_EQ(r, 0);\n\tASSERT_PTR_NE(dp, NULL);\n\tmemset(dp, 0x7d, 223);\n\tcdp = sshbuf_ptr(p1);\n\tASSERT_PTR_NE(cdp, NULL);\n\tASSERT_MEM_FILLED_EQ(cdp, 0xd7, 1000);\n\tASSERT_MEM_FILLED_EQ(cdp + 1000, 0x7d, 223);\n\tTEST_DONE();\n\n\tTEST_START(\"resize full buffer\");\n\tr = sshbuf_set_max_size(p1, 1000);\n\tASSERT_INT_EQ(r, SSH_ERR_NO_BUFFER_SPACE);\n\tsz = roundup(1223 + SSHBUF_SIZE_INC * 3, SSHBUF_SIZE_INC);\n\tASSERT_INT_EQ(sshbuf_set_max_size(p1, sz), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_max_size(p1), sz);\n\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), sz - 1223);\n\tASSERT_INT_EQ(sshbuf_len(p1), 1223);\n\tTEST_DONE();\n\n\t \n\tTEST_START(\"alloc chunking\");\n\tr = sshbuf_reserve(p1, 1, &dp);\n\tASSERT_INT_EQ(r, 0);\n\tASSERT_PTR_NE(dp, NULL);\n\t*dp = 0xff;\n\tcdp = sshbuf_ptr(p1);\n\tASSERT_PTR_NE(cdp, NULL);\n\tASSERT_MEM_FILLED_EQ(cdp, 0xd7, 1000);\n\tASSERT_MEM_FILLED_EQ(cdp + 1000, 0x7d, 223);\n\tASSERT_MEM_FILLED_EQ(cdp + 1223, 0xff, 1);\n\tASSERT_SIZE_T_EQ(sshbuf_alloc(p1) % SSHBUF_SIZE_INC, 0);\n\tsshbuf_free(p1);\n\tTEST_DONE();\n\n\tTEST_START(\"reset buffer\");\n\tp1 = sshbuf_new();\n\tASSERT_PTR_NE(p1, NULL);\n\tASSERT_INT_EQ(sshbuf_set_max_size(p1, 1223), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_max_size(p1), 1223);\n\tr = sshbuf_reserve(p1, 1223, &dp);\n\tASSERT_INT_EQ(r, 0);\n\tASSERT_PTR_NE(dp, NULL);\n\tmemset(dp, 0xd7, 1223);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 1223);\n\tsshbuf_reset(p1);\n\tASSERT_SIZE_T_EQ(sshbuf_max_size(p1), 1223);\n\tASSERT_SIZE_T_EQ(sshbuf_len(p1), 0);\n\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), 1223);\n\tsshbuf_free(p1);\n\tTEST_DONE();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}