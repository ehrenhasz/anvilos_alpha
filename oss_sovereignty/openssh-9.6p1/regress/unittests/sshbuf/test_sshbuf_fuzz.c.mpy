{
  "module_name": "test_sshbuf_fuzz.c",
  "hash_id": "0fa89cbcbde59f9e3a291b3e537a6125e7d94a9abbbe498011b3377f6d14d59b",
  "original_prompt": "Ingested from openssh-9.6p1/regress/unittests/sshbuf/test_sshbuf_fuzz.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <stdio.h>\n#ifdef HAVE_STDINT_H\n# include <stdint.h>\n#endif\n#include <stdlib.h>\n#include <string.h>\n\n#include \"../test_helper/test_helper.h\"\n\n#include \"ssherr.h\"\n#include \"sshbuf.h\"\n\n#define NUM_FUZZ_TESTS (1 << 18)\n\nvoid sshbuf_fuzz_tests(void);\n\nvoid\nsshbuf_fuzz_tests(void)\n{\n\tstruct sshbuf *p1;\n\tu_char *dp;\n\tsize_t sz, sz2, i, ntests = NUM_FUZZ_TESTS;\n\tu_int32_t r;\n\tint ret;\n\n\tif (test_is_fast())\n\t\tntests >>= 2;\n\tif (test_is_slow())\n\t\tntests <<= 2;\n\n\t \n\tTEST_START(\"fuzz alloc/dealloc\");\n\tp1 = sshbuf_new();\n\tASSERT_INT_EQ(sshbuf_set_max_size(p1, 16 * 1024), 0);\n\tASSERT_PTR_NE(p1, NULL);\n\tASSERT_PTR_NE(sshbuf_ptr(p1), NULL);\n\tASSERT_MEM_ZERO_NE(sshbuf_ptr(p1), sshbuf_len(p1));\n\tfor (i = 0; i < ntests; i++) {\n\t\tr = arc4random_uniform(10);\n\t\tif (r == 0) {\n\t\t\t \n\t\t\tr = arc4random_uniform(10);\n fuzz_reserve:\n\t\t\tsz = sshbuf_avail(p1);\n\t\t\tsz2 = sshbuf_len(p1);\n\t\t\tret = sshbuf_reserve(p1, r, &dp);\n\t\t\tif (ret < 0) {\n\t\t\t\tASSERT_PTR_EQ(dp, NULL);\n\t\t\t\tASSERT_SIZE_T_LT(sz, r);\n\t\t\t\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), sz);\n\t\t\t\tASSERT_SIZE_T_EQ(sshbuf_len(p1), sz2);\n\t\t\t} else {\n\t\t\t\tASSERT_PTR_NE(dp, NULL);\n\t\t\t\tASSERT_SIZE_T_GE(sz, r);\n\t\t\t\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), sz - r);\n\t\t\t\tASSERT_SIZE_T_EQ(sshbuf_len(p1), sz2 + r);\n\t\t\t\tmemset(dp, arc4random_uniform(255) + 1, r);\n\t\t\t}\n\t\t} else if (r < 3) {\n\t\t\t \n\t\t\tr = arc4random_uniform(8 * 1024);\n\t\t\tgoto fuzz_reserve;\n\t\t} else if (r == 3) {\n\t\t\t \n\t\t\tr = arc4random_uniform(10);\n fuzz_consume:\n\t\t\tsz = sshbuf_avail(p1);\n\t\t\tsz2 = sshbuf_len(p1);\n\t\t\t \n\t\t\tret = ((arc4random() & 1) ?\n\t\t\t    sshbuf_consume : sshbuf_consume_end)(p1, r);\n\t\t\tif (ret < 0) {\n\t\t\t\tASSERT_SIZE_T_LT(sz2, r);\n\t\t\t\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), sz);\n\t\t\t\tASSERT_SIZE_T_EQ(sshbuf_len(p1), sz2);\n\t\t\t} else {\n\t\t\t\tASSERT_SIZE_T_GE(sz2, r);\n\t\t\t\tASSERT_SIZE_T_EQ(sshbuf_avail(p1), sz + r);\n\t\t\t\tASSERT_SIZE_T_EQ(sshbuf_len(p1), sz2 - r);\n\t\t\t}\n\t\t} else if (r < 8) {\n\t\t\t \n\t\t\tr = arc4random_uniform(2 * 1024);\n\t\t\tgoto fuzz_consume;\n\t\t} else if (r == 8) {\n\t\t\t \n\t\t\tr = arc4random_uniform(16 * 1024);\n\t\t\tsz = sshbuf_max_size(p1);\n\t\t\tif (sshbuf_set_max_size(p1, r) < 0)\n\t\t\t\tASSERT_SIZE_T_EQ(sshbuf_max_size(p1), sz);\n\t\t\telse\n\t\t\t\tASSERT_SIZE_T_EQ(sshbuf_max_size(p1), r);\n\t\t} else {\n\t\t\tif (arc4random_uniform(8192) == 0) {\n\t\t\t\t \n\t\t\t\tASSERT_PTR_NE(sshbuf_ptr(p1), NULL);\n\t\t\t\tASSERT_MEM_ZERO_NE(sshbuf_ptr(p1), sshbuf_len(p1));\n\t\t\t\tsshbuf_free(p1);\n\t\t\t\tp1 = sshbuf_new();\n\t\t\t\tASSERT_PTR_NE(p1, NULL);\n\t\t\t\tASSERT_INT_EQ(sshbuf_set_max_size(p1,\n\t\t\t\t    16 * 1024), 0);\n\t\t\t} else {\n\t\t\t\t \n\t\t\t\t \n\t\t\t\tarc4random_buf(&r, sizeof(r));\n\t\t\t\twhile (r < SSHBUF_SIZE_MAX / 2) {\n\t\t\t\t\tr <<= 1;\n\t\t\t\t\tr |= arc4random() & 1;\n\t\t\t\t}\n\t\t\t\tgoto fuzz_reserve;\n\t\t\t}\n\t\t}\n\t\tASSERT_PTR_NE(sshbuf_ptr(p1), NULL);\n\t\tASSERT_SIZE_T_LE(sshbuf_max_size(p1), 16 * 1024);\n\t}\n\tASSERT_PTR_NE(sshbuf_ptr(p1), NULL);\n\tASSERT_MEM_ZERO_NE(sshbuf_ptr(p1), sshbuf_len(p1));\n\tsshbuf_free(p1);\n\tTEST_DONE();\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}