{
  "module_name": "agent.sh",
  "hash_id": "35559ad6846323f770bfd535bb23e298d07c71718fdd98997b2b5fb3e3bee619",
  "original_prompt": "Ingested from openssh-9.6p1/regress/agent.sh",
  "human_readable_source": "#\t$OpenBSD: agent.sh,v 1.21 2023/03/01 09:29:32 dtucker Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"simple agent test\"\n\nSSH_AUTH_SOCK=/nonexistent ${SSHADD} -l > /dev/null 2>&1\nif [ $? -ne 2 ]; then\n\tfail \"ssh-add -l did not fail with exit code 2\"\nfi\n\ntrace \"start agent, args ${EXTRA_AGENT_ARGS} -s\"\neval `${SSHAGENT} ${EXTRA_AGENT_ARGS} -s` >`ssh_logfile ssh-agent`\nr=$?\nif [ $r -ne 0 ]; then\n\tfatal \"could not start ssh-agent: exit code $r\"\nfi\n\neval `${SSHAGENT} ${EXTRA_AGENT_ARGS} -s | sed 's/SSH_/FW_SSH_/g'` > /dev/null\nr=$?\nif [ $r -ne 0 ]; then\n\tfatal \"could not start second ssh-agent: exit code $r\"\nfi\n\n${SSHADD} -l > /dev/null 2>&1\nif [ $? -ne 1 ]; then\n\tfail \"ssh-add -l did not fail with exit code 1\"\nfi\n\nrm -f $OBJ/user_ca_key $OBJ/user_ca_key.pub\n${SSHKEYGEN} -q -N '' -t ed25519 -f $OBJ/user_ca_key \\\n\t|| fatal \"ssh-keygen failed\"\n\ntrace \"overwrite authorized keys\"\nprintf '' > $OBJ/authorized_keys_$USER\n\nfor t in ${SSH_KEYTYPES}; do\n\t# generate user key for agent\n\trm -f $OBJ/$t-agent $OBJ/$t-agent.pub*\n\t${SSHKEYGEN} -q -N '' -t $t -f $OBJ/$t-agent ||\\\n\t\t fatal \"ssh-keygen for $t-agent failed\"\n\t# Make a certificate for each too.\n\t${SSHKEYGEN} -qs $OBJ/user_ca_key -I \"$t cert\" \\\n\t\t-n estragon $OBJ/$t-agent.pub || fatal \"ca sign failed\"\n\n\t# add to authorized keys\n\tcat $OBJ/$t-agent.pub >> $OBJ/authorized_keys_$USER\n\t# add private key to agent\n\t${SSHADD} $OBJ/$t-agent > /dev/null 2>&1\n\tif [ $? -ne 0 ]; then\n\t\tfail \"ssh-add failed exit code $?\"\n\tfi\n\t# add private key to second agent\n\tSSH_AUTH_SOCK=$FW_SSH_AUTH_SOCK ${SSHADD} $OBJ/$t-agent > /dev/null 2>&1\n\tif [ $? -ne 0 ]; then\n\t\tfail \"ssh-add failed exit code $?\"\n\tfi\n\t# Move private key to ensure that we aren't accidentally using it.\n\t# Keep the corresponding public keys/certs around for later use.\n\tmv -f $OBJ/$t-agent $OBJ/$t-agent-private\n\tcp -f $OBJ/$t-agent.pub $OBJ/$t-agent-private.pub\n\tcp -f $OBJ/$t-agent-cert.pub $OBJ/$t-agent-private-cert.pub\ndone\n\n# Remove explicit identity directives from ssh_proxy\nmv $OBJ/ssh_proxy $OBJ/ssh_proxy_bak\ngrep -vi identityfile $OBJ/ssh_proxy_bak > $OBJ/ssh_proxy\n\n${SSHADD} -l > /dev/null 2>&1\nr=$?\nif [ $r -ne 0 ]; then\n\tfail \"ssh-add -l failed: exit code $r\"\nfi\n# the same for full pubkey output\n${SSHADD} -L > /dev/null 2>&1\nr=$?\nif [ $r -ne 0 ]; then\n\tfail \"ssh-add -L failed: exit code $r\"\nfi\n\ntrace \"simple connect via agent\"\n${SSH} -F $OBJ/ssh_proxy somehost exit 52\nr=$?\nif [ $r -ne 52 ]; then\n\tfail \"ssh connect with failed (exit code $r)\"\nfi\n\nfor t in ${SSH_KEYTYPES}; do\n\ttrace \"connect via agent using $t key\"\n\tif [ \"$t\" = \"ssh-dss\" ]; then\n\t\techo \"PubkeyAcceptedAlgorithms +ssh-dss\" >> $OBJ/ssh_proxy\n\t\techo \"PubkeyAcceptedAlgorithms +ssh-dss\" >> $OBJ/sshd_proxy\n\tfi\n\t${SSH} -F $OBJ/ssh_proxy -i $OBJ/$t-agent.pub -oIdentitiesOnly=yes \\\n\t\tsomehost exit 52\n\tr=$?\n\tif [ $r -ne 52 ]; then\n\t\tfail \"ssh connect with failed (exit code $r)\"\n\tfi\ndone\n\ntrace \"agent forwarding\"\n${SSH} -A -F $OBJ/ssh_proxy somehost ${SSHADD} -l > /dev/null 2>&1\nr=$?\nif [ $r -ne 0 ]; then\n\tfail \"ssh-add -l via agent fwd failed (exit code $r)\"\nfi\n${SSH} \"-oForwardAgent=$SSH_AUTH_SOCK\" -F $OBJ/ssh_proxy somehost ${SSHADD} -l > /dev/null 2>&1\nr=$?\nif [ $r -ne 0 ]; then\n\tfail \"ssh-add -l via agent path fwd failed (exit code $r)\"\nfi\n${SSH} -A -F $OBJ/ssh_proxy somehost \\\n\t\"${SSH} -F $OBJ/ssh_proxy somehost exit 52\"\nr=$?\nif [ $r -ne 52 ]; then\n\tfail \"agent fwd failed (exit code $r)\"\nfi\n\ntrace \"agent forwarding different agent\"\n${SSH} \"-oForwardAgent=$FW_SSH_AUTH_SOCK\" -F $OBJ/ssh_proxy somehost ${SSHADD} -l > /dev/null 2>&1\nr=$?\nif [ $r -ne 0 ]; then\n\tfail \"ssh-add -l via agent path fwd of different agent failed (exit code $r)\"\nfi\n${SSH} '-oForwardAgent=$FW_SSH_AUTH_SOCK' -F $OBJ/ssh_proxy somehost ${SSHADD} -l > /dev/null 2>&1\nr=$?\nif [ $r -ne 0 ]; then\n\tfail \"ssh-add -l via agent path env fwd of different agent failed (exit code $r)\"\nfi\n\n# Remove keys from forwarded agent, ssh-add on remote machine should now fail.\nSSH_AUTH_SOCK=$FW_SSH_AUTH_SOCK ${SSHADD} -D > /dev/null 2>&1\nr=$?\nif [ $r -ne 0 ]; then\n\tfail \"ssh-add -D failed: exit code $r\"\nfi\n${SSH} '-oForwardAgent=$FW_SSH_AUTH_SOCK' -F $OBJ/ssh_proxy somehost ${SSHADD} -l > /dev/null 2>&1\nr=$?\nif [ $r -ne 1 ]; then\n\tfail \"ssh-add -l with different agent did not fail with exit code 1 (exit code $r)\"\nfi\n\n(printf 'cert-authority,principals=\"estragon\" '; cat $OBJ/user_ca_key.pub) \\\n\t> $OBJ/authorized_keys_$USER\nfor t in ${SSH_KEYTYPES}; do\n    if [ \"$t\" != \"ssh-dss\" ]; then\n\ttrace \"connect via agent using $t key\"\n\t${SSH} -F $OBJ/ssh_proxy -i $OBJ/$t-agent.pub \\\n\t\t-oCertificateFile=$OBJ/$t-agent-cert.pub \\\n\t\t-oIdentitiesOnly=yes somehost exit 52\n\tr=$?\n\tif [ $r -ne 52 ]; then\n\t\tfail \"ssh connect with failed (exit code $r)\"\n\tfi\n    fi\ndone\n\n## Deletion tests.\n\ntrace \"delete all agent keys\"\n${SSHADD} -D > /dev/null 2>&1\nr=$?\nif [ $r -ne 0 ]; then\n\tfail \"ssh-add -D failed: exit code $r\"\nfi\n# make sure they're gone\n${SSHADD} -l > /dev/null 2>&1\nr=$?\nif [ $r -ne 1 ]; then\n\tfail \"ssh-add -l returned unexpected exit code: $r\"\nfi\ntrace \"readd keys\"\n# re-add keys/certs to agent\nfor t in ${SSH_KEYTYPES}; do\n\t${SSHADD} $OBJ/$t-agent-private >/dev/null 2>&1 || \\\n\t\tfail \"ssh-add failed exit code $?\"\ndone\n# make sure they are there\n${SSHADD} -l > /dev/null 2>&1\nr=$?\nif [ $r -ne 0 ]; then\n\tfail \"ssh-add -l failed: exit code $r\"\nfi\n\ncheck_key_absent() {\n\t${SSHADD} -L | grep \"^$1 \" >/dev/null\n\tif [ $? -eq 0 ]; then\n\t\tfail \"$1 key unexpectedly present\"\n\tfi\n}\ncheck_key_present() {\n\t${SSHADD} -L | grep \"^$1 \" >/dev/null\n\tif [ $? -ne 0 ]; then\n\t\tfail \"$1 key missing from agent\"\n\tfi\n}\n\n# delete the ed25519 key\ntrace \"delete single key by file\"\n${SSHADD} -qdk $OBJ/ssh-ed25519-agent || fail \"ssh-add -d ed25519 failed\"\ncheck_key_absent ssh-ed25519\ncheck_key_present ssh-ed25519-cert-v01@openssh.com\n# Put key/cert back.\n${SSHADD} $OBJ/ssh-ed25519-agent-private >/dev/null 2>&1 || \\\n\tfail \"ssh-add failed exit code $?\"\ncheck_key_present ssh-ed25519\n# Delete both key and certificate.\ntrace \"delete key/cert by file\"\n${SSHADD} -qd $OBJ/ssh-ed25519-agent || fail \"ssh-add -d ed25519 failed\"\ncheck_key_absent ssh-ed25519\ncheck_key_absent ssh-ed25519-cert-v01@openssh.com\n# Put key/cert back.\n${SSHADD} $OBJ/ssh-ed25519-agent-private >/dev/null 2>&1 || \\\n\tfail \"ssh-add failed exit code $?\"\ncheck_key_present ssh-ed25519\n# Delete certificate via stdin\n${SSHADD} -qd - < $OBJ/ssh-ed25519-agent-cert.pub || fail \"ssh-add -d - failed\"\ncheck_key_present ssh-ed25519\ncheck_key_absent ssh-ed25519-cert-v01@openssh.com\n# Delete key via stdin\n${SSHADD} -qd - < $OBJ/ssh-ed25519-agent.pub || fail \"ssh-add -d - failed\"\ncheck_key_absent ssh-ed25519\ncheck_key_absent ssh-ed25519-cert-v01@openssh.com\n\ntrace \"kill agent\"\n${SSHAGENT} -k > /dev/null\nSSH_AGENT_PID=$FW_SSH_AGENT_PID ${SSHAGENT} -k > /dev/null\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}