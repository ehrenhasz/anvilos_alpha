{
  "module_name": "dynamic-forward.sh",
  "hash_id": "6cf2e7c2afc256e7e2ae3123292b7bc5a34d303f8be397474654ac1d29909f57",
  "original_prompt": "Ingested from openssh-9.6p1/regress/dynamic-forward.sh",
  "human_readable_source": "#\t$OpenBSD: dynamic-forward.sh,v 1.15 2023/01/06 08:50:33 dtucker Exp $\n#\tPlaced in the Public Domain.\n\ntid=\"dynamic forwarding\"\n\n# This is a reasonable proxy for IPv6 support.\nif ! config_defined HAVE_STRUCT_IN6_ADDR ; then\n\tSKIP_IPV6=yes\nfi\n\nFWDPORT=`expr $PORT + 1`\nmake_tmpdir\nCTL=${SSH_REGRESS_TMP}/ctl-sock\ncp $OBJ/ssh_config $OBJ/ssh_config.orig\nproxycmd=\"$OBJ/netcat -x 127.0.0.1:$FWDPORT -X\"\ntrace \"will use ProxyCommand $proxycmd\"\n\nstart_ssh() {\n\tdirection=\"$1\"\n\targ=\"$2\"\n\tn=0\n\terror=\"1\"\n\ttrace \"start dynamic -$direction forwarding, fork to background\"\n\t(cat $OBJ/ssh_config.orig ; echo \"$arg\") > $OBJ/ssh_config\n\t${REAL_SSH} -vvvnNfF $OBJ/ssh_config -E$TEST_SSH_LOGFILE \\\n\t    -$direction $FWDPORT -oExitOnForwardFailure=yes \\\n\t    -oControlMaster=yes -oControlPath=$CTL somehost\n\tr=$?\n\ttest $r -eq 0 || fatal \"failed to start dynamic forwarding $r\"\n\tif ! ${REAL_SSH} -qF$OBJ/ssh_config -O check \\\n\t     -oControlPath=$CTL somehost >/dev/null 2>&1 ; then\n\t\tfatal \"forwarding ssh process unresponsive\"\n\tfi\n}\n\nstop_ssh() {\n\ttest -S $CTL || return\n\tif ! ${REAL_SSH} -qF$OBJ/ssh_config -O exit \\\n\t     -oControlPath=$CTL >/dev/null somehost >/dev/null ; then\n\t\tfatal \"forwarding ssh process did not respond to close\"\n\tfi\n\tn=0\n\twhile [ \"$n\" -lt 20 ] ; do\n\t\ttest -S $CTL || break\n\t\tsleep 1\n\t\tn=`expr $n + 1`\n\tdone\n\tif test -S $CTL ; then\n\t\tfatal \"forwarding ssh process did not exit\"\n\tfi\n}\n\ncheck_socks() {\n\tdirection=$1\n\texpect_success=$2\n\tfor s in 4 5; do\n\t    for h in 127.0.0.1 localhost; do\n\t\ttrace \"testing ssh socks version $s host $h (-$direction)\"\n\t\t${REAL_SSH} -q -F $OBJ/ssh_config \\\n\t\t\t-o \"ProxyCommand ${proxycmd}${s} $h $PORT 2>/dev/null\" \\\n\t\t\tsomehost cat ${DATA} > ${COPY}\n\t\tr=$?\n\t\tif [ \"x$expect_success\" = \"xY\" ] ; then\n\t\t\tif [ $r -ne 0 ] ; then\n\t\t\t\tfail \"ssh failed with exit status $r\"\n\t\t\tfi\n\t\t\ttest -f ${COPY}\t || fail \"failed copy ${DATA}\"\n\t\t\tcmp ${DATA} ${COPY} || fail \"corrupted copy of ${DATA}\"\n\t\telif [ $r -eq 0 ] ; then\n\t\t\tfail \"ssh unexpectedly succeeded\"\n\t\tfi\n\t    done\n\tdone\n}\n\nstart_sshd\ntrap \"stop_ssh\" EXIT\n\nfor d in D R; do\n\tverbose \"test -$d forwarding\"\n\tstart_ssh $d\n\tcheck_socks $d Y\n\tstop_ssh\n\ttest \"x$d\" = \"xR\" || continue\n\t\n\t# Test PermitRemoteOpen\n\tverbose \"PermitRemoteOpen=any\"\n\tstart_ssh $d PermitRemoteOpen=any\n\tcheck_socks $d Y\n\tstop_ssh\n\n\tverbose \"PermitRemoteOpen=none\"\n\tstart_ssh $d PermitRemoteOpen=none\n\tcheck_socks $d N\n\tstop_ssh\n\n\tverbose \"PermitRemoteOpen=explicit\"\n\tpermit=\"127.0.0.1:$PORT [::1]:$PORT localhost:$PORT\"\n\ttest -z \"$SKIP_IPV6\" || permit=\"127.0.0.1:$PORT localhost:$PORT\"\n\tstart_ssh $d PermitRemoteOpen=\"$permit\"\n\tcheck_socks $d Y\n\tstop_ssh\n\n\tverbose \"PermitRemoteOpen=disallowed\"\n\tpermit=\"127.0.0.1:1 [::1]:1 localhost:1\"\n\ttest -z \"$SKIP_IPV6\" || permit=\"127.0.0.1:1 localhost:1\"\n\tstart_ssh $d PermitRemoteOpen=\"$permit\"\n\tcheck_socks $d N\n\tstop_ssh\ndone\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}