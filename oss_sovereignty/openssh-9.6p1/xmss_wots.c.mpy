{
  "module_name": "xmss_wots.c",
  "hash_id": "f96a4e271ddc7b9cfed7c632e9eda8ba2007757391e18c58fb8adaad258b2320",
  "original_prompt": "Ingested from openssh-9.6p1/xmss_wots.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n#ifdef WITH_XMSS\n\n#include <stdlib.h>\n#ifdef HAVE_STDINT_H\n# include <stdint.h>\n#endif\n#include <limits.h>\n#include \"xmss_commons.h\"\n#include \"xmss_hash.h\"\n#include \"xmss_wots.h\"\n#include \"xmss_hash_address.h\"\n\n\n \nstatic inline int\nwots_log2(uint32_t v)\n{\n  int      b;\n\n  for (b = sizeof (v) * CHAR_BIT - 1; b >= 0; b--) {\n    if ((1U << b) & v) {\n      return b;\n    }\n  }\n  return 0;\n}\n\nvoid\nwots_set_params(wots_params *params, int n, int w)\n{\n  params->n = n;\n  params->w = w;\n  params->log_w = wots_log2(params->w);\n  params->len_1 = (CHAR_BIT * n) / params->log_w;\n  params->len_2 = (wots_log2(params->len_1 * (w - 1)) / params->log_w) + 1;\n  params->len = params->len_1 + params->len_2;\n  params->keysize = params->len * params->n;\n}\n\n \nstatic void expand_seed(unsigned char *outseeds, const unsigned char *inseed, const wots_params *params)\n{\n  uint32_t i = 0;\n  unsigned char ctr[32];\n  for(i = 0; i < params->len; i++){\n    to_byte(ctr, i, 32);\n    prf((outseeds + (i*params->n)), ctr, inseed, params->n);\n  }\n}\n\n \nstatic void gen_chain(unsigned char *out, const unsigned char *in, unsigned int start, unsigned int steps, const wots_params *params, const unsigned char *pub_seed, uint32_t addr[8])\n{\n  uint32_t i, j;\n  for (j = 0; j < params->n; j++)\n    out[j] = in[j];\n\n  for (i = start; i < (start+steps) && i < params->w; i++) {\n    setHashADRS(addr, i);\n    hash_f(out, out, pub_seed, addr, params->n);\n  }\n}\n\n \nstatic void base_w(int *output, const int out_len, const unsigned char *input, const wots_params *params)\n{\n  int in = 0;\n  int out = 0;\n  uint32_t total = 0;\n  int bits = 0;\n  int consumed = 0;\n\n  for (consumed = 0; consumed < out_len; consumed++) {\n    if (bits == 0) {\n      total = input[in];\n      in++;\n      bits += 8;\n    }\n    bits -= params->log_w;\n    output[out] = (total >> bits) & (params->w - 1);\n    out++;\n  }\n}\n\nvoid wots_pkgen(unsigned char *pk, const unsigned char *sk, const wots_params *params, const unsigned char *pub_seed, uint32_t addr[8])\n{\n  uint32_t i;\n  expand_seed(pk, sk, params);\n  for (i=0; i < params->len; i++) {\n    setChainADRS(addr, i);\n    gen_chain(pk+i*params->n, pk+i*params->n, 0, params->w-1, params, pub_seed, addr);\n  }\n}\n\n\nint wots_sign(unsigned char *sig, const unsigned char *msg, const unsigned char *sk, const wots_params *params, const unsigned char *pub_seed, uint32_t addr[8])\n{\n  \n  int csum = 0;\n  uint32_t i = 0;\n  int *basew = calloc(params->len, sizeof(int));\n  if (basew == NULL)\n    return -1;\n\n  base_w(basew, params->len_1, msg, params);\n\n  for (i=0; i < params->len_1; i++) {\n    csum += params->w - 1 - basew[i];\n  }\n\n  csum = csum << (8 - ((params->len_2 * params->log_w) % 8));\n\n  int len_2_bytes = ((params->len_2 * params->log_w) + 7) / 8;\n\n  unsigned char csum_bytes[len_2_bytes];\n  to_byte(csum_bytes, csum, len_2_bytes);\n\n  int csum_basew[params->len_2];\n  base_w(csum_basew, params->len_2, csum_bytes, params);\n\n  for (i = 0; i < params->len_2; i++) {\n    basew[params->len_1 + i] = csum_basew[i];\n  }\n\n  expand_seed(sig, sk, params);\n\n  for (i = 0; i < params->len; i++) {\n    setChainADRS(addr, i);\n    gen_chain(sig+i*params->n, sig+i*params->n, 0, basew[i], params, pub_seed, addr);\n  }\n  free(basew);\n  return 0;\n}\n\nint wots_pkFromSig(unsigned char *pk, const unsigned char *sig, const unsigned char *msg, const wots_params *params, const unsigned char *pub_seed, uint32_t addr[8])\n{\n  int csum = 0;\n  uint32_t i = 0;\n  int *basew = calloc(params->len, sizeof(int));\n  if (basew == NULL)\n    return -1;\n\n  base_w(basew, params->len_1, msg, params);\n\n  for (i=0; i < params->len_1; i++) {\n    csum += params->w - 1 - basew[i];\n  }\n\n  csum = csum << (8 - ((params->len_2 * params->log_w) % 8));\n\n  int len_2_bytes = ((params->len_2 * params->log_w) + 7) / 8;\n\n  unsigned char csum_bytes[len_2_bytes];\n  to_byte(csum_bytes, csum, len_2_bytes);\n\n  int csum_basew[params->len_2];\n  base_w(csum_basew, params->len_2, csum_bytes, params);\n\n  for (i = 0; i < params->len_2; i++) {\n    basew[params->len_1 + i] = csum_basew[i];\n  }\n  for (i=0; i < params->len; i++) {\n    setChainADRS(addr, i);\n    gen_chain(pk+i*params->n, sig+i*params->n, basew[i], params->w-1-basew[i], params, pub_seed, addr);\n  }\n  free(basew);\n  return 0;\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}