{
  "module_name": "ssh-ed25519.c",
  "hash_id": "4c220d7856a47af3f903096ea452b78a77532649af1f9a793614674e6f0adff2",
  "original_prompt": "Ingested from openssh-9.6p1/ssh-ed25519.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <limits.h>\n\n#include \"crypto_api.h\"\n\n#include <string.h>\n#include <stdarg.h>\n\n#include \"log.h\"\n#include \"sshbuf.h\"\n#define SSHKEY_INTERNAL\n#include \"sshkey.h\"\n#include \"ssherr.h\"\n#include \"ssh.h\"\n\nstatic void\nssh_ed25519_cleanup(struct sshkey *k)\n{\n\tfreezero(k->ed25519_pk, ED25519_PK_SZ);\n\tfreezero(k->ed25519_sk, ED25519_SK_SZ);\n\tk->ed25519_pk = NULL;\n\tk->ed25519_sk = NULL;\n}\n\nstatic int\nssh_ed25519_equal(const struct sshkey *a, const struct sshkey *b)\n{\n\tif (a->ed25519_pk == NULL || b->ed25519_pk == NULL)\n\t\treturn 0;\n\tif (memcmp(a->ed25519_pk, b->ed25519_pk, ED25519_PK_SZ) != 0)\n\t\treturn 0;\n\treturn 1;\n}\n\nstatic int\nssh_ed25519_serialize_public(const struct sshkey *key, struct sshbuf *b,\n    enum sshkey_serialize_rep opts)\n{\n\tint r;\n\n\tif (key->ed25519_pk == NULL)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tif ((r = sshbuf_put_string(b, key->ed25519_pk, ED25519_PK_SZ)) != 0)\n\t\treturn r;\n\n\treturn 0;\n}\n\nstatic int\nssh_ed25519_serialize_private(const struct sshkey *key, struct sshbuf *b,\n    enum sshkey_serialize_rep opts)\n{\n\tint r;\n\n\tif ((r = sshbuf_put_string(b, key->ed25519_pk, ED25519_PK_SZ)) != 0 ||\n\t    (r = sshbuf_put_string(b, key->ed25519_sk, ED25519_SK_SZ)) != 0)\n\t\treturn r;\n\n\treturn 0;\n}\n\nstatic int\nssh_ed25519_generate(struct sshkey *k, int bits)\n{\n\tif ((k->ed25519_pk = malloc(ED25519_PK_SZ)) == NULL ||\n\t    (k->ed25519_sk = malloc(ED25519_SK_SZ)) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tcrypto_sign_ed25519_keypair(k->ed25519_pk, k->ed25519_sk);\n\treturn 0;\n}\n\nstatic int\nssh_ed25519_copy_public(const struct sshkey *from, struct sshkey *to)\n{\n\tif (from->ed25519_pk == NULL)\n\t\treturn 0;  \n\tif ((to->ed25519_pk = malloc(ED25519_PK_SZ)) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tmemcpy(to->ed25519_pk, from->ed25519_pk, ED25519_PK_SZ);\n\treturn 0;\n}\n\nstatic int\nssh_ed25519_deserialize_public(const char *ktype, struct sshbuf *b,\n    struct sshkey *key)\n{\n\tu_char *pk = NULL;\n\tsize_t len = 0;\n\tint r;\n\n\tif ((r = sshbuf_get_string(b, &pk, &len)) != 0)\n\t\treturn r;\n\tif (len != ED25519_PK_SZ) {\n\t\tfreezero(pk, len);\n\t\treturn SSH_ERR_INVALID_FORMAT;\n\t}\n\tkey->ed25519_pk = pk;\n\treturn 0;\n}\n\nstatic int\nssh_ed25519_deserialize_private(const char *ktype, struct sshbuf *b,\n    struct sshkey *key)\n{\n\tint r;\n\tsize_t sklen = 0;\n\tu_char *ed25519_sk = NULL;\n\n\tif ((r = ssh_ed25519_deserialize_public(NULL, b, key)) != 0)\n\t\tgoto out;\n\tif ((r = sshbuf_get_string(b, &ed25519_sk, &sklen)) != 0)\n\t\tgoto out;\n\tif (sklen != ED25519_SK_SZ) {\n\t\tr = SSH_ERR_INVALID_FORMAT;\n\t\tgoto out;\n\t}\n\tkey->ed25519_sk = ed25519_sk;\n\ted25519_sk = NULL;  \n\t \n\tr = 0;\n out:\n\tfreezero(ed25519_sk, sklen);\n\treturn r;\n}\n\nstatic int\nssh_ed25519_sign(struct sshkey *key,\n    u_char **sigp, size_t *lenp,\n    const u_char *data, size_t datalen,\n    const char *alg, const char *sk_provider, const char *sk_pin, u_int compat)\n{\n\tu_char *sig = NULL;\n\tsize_t slen = 0, len;\n\tunsigned long long smlen;\n\tint r, ret;\n\tstruct sshbuf *b = NULL;\n\n\tif (lenp != NULL)\n\t\t*lenp = 0;\n\tif (sigp != NULL)\n\t\t*sigp = NULL;\n\n\tif (key == NULL ||\n\t    sshkey_type_plain(key->type) != KEY_ED25519 ||\n\t    key->ed25519_sk == NULL ||\n\t    datalen >= INT_MAX - crypto_sign_ed25519_BYTES)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tsmlen = slen = datalen + crypto_sign_ed25519_BYTES;\n\tif ((sig = malloc(slen)) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\n\tif ((ret = crypto_sign_ed25519(sig, &smlen, data, datalen,\n\t    key->ed25519_sk)) != 0 || smlen <= datalen) {\n\t\tr = SSH_ERR_INVALID_ARGUMENT;  \n\t\tgoto out;\n\t}\n\t \n\tif ((b = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = sshbuf_put_cstring(b, \"ssh-ed25519\")) != 0 ||\n\t    (r = sshbuf_put_string(b, sig, smlen - datalen)) != 0)\n\t\tgoto out;\n\tlen = sshbuf_len(b);\n\tif (sigp != NULL) {\n\t\tif ((*sigp = malloc(len)) == NULL) {\n\t\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\t\tgoto out;\n\t\t}\n\t\tmemcpy(*sigp, sshbuf_ptr(b), len);\n\t}\n\tif (lenp != NULL)\n\t\t*lenp = len;\n\t \n\tr = 0;\n out:\n\tsshbuf_free(b);\n\tif (sig != NULL)\n\t\tfreezero(sig, slen);\n\n\treturn r;\n}\n\nstatic int\nssh_ed25519_verify(const struct sshkey *key,\n    const u_char *sig, size_t siglen,\n    const u_char *data, size_t dlen, const char *alg, u_int compat,\n    struct sshkey_sig_details **detailsp)\n{\n\tstruct sshbuf *b = NULL;\n\tchar *ktype = NULL;\n\tconst u_char *sigblob;\n\tu_char *sm = NULL, *m = NULL;\n\tsize_t len;\n\tunsigned long long smlen = 0, mlen = 0;\n\tint r, ret;\n\n\tif (key == NULL ||\n\t    sshkey_type_plain(key->type) != KEY_ED25519 ||\n\t    key->ed25519_pk == NULL ||\n\t    dlen >= INT_MAX - crypto_sign_ed25519_BYTES ||\n\t    sig == NULL || siglen == 0)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\n\tif ((b = sshbuf_from(sig, siglen)) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_get_cstring(b, &ktype, NULL)) != 0 ||\n\t    (r = sshbuf_get_string_direct(b, &sigblob, &len)) != 0)\n\t\tgoto out;\n\tif (strcmp(\"ssh-ed25519\", ktype) != 0) {\n\t\tr = SSH_ERR_KEY_TYPE_MISMATCH;\n\t\tgoto out;\n\t}\n\tif (sshbuf_len(b) != 0) {\n\t\tr = SSH_ERR_UNEXPECTED_TRAILING_DATA;\n\t\tgoto out;\n\t}\n\tif (len > crypto_sign_ed25519_BYTES) {\n\t\tr = SSH_ERR_INVALID_FORMAT;\n\t\tgoto out;\n\t}\n\tif (dlen >= SIZE_MAX - len) {\n\t\tr = SSH_ERR_INVALID_ARGUMENT;\n\t\tgoto out;\n\t}\n\tsmlen = len + dlen;\n\tmlen = smlen;\n\tif ((sm = malloc(smlen)) == NULL || (m = malloc(mlen)) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tmemcpy(sm, sigblob, len);\n\tmemcpy(sm+len, data, dlen);\n\tif ((ret = crypto_sign_ed25519_open(m, &mlen, sm, smlen,\n\t    key->ed25519_pk)) != 0) {\n\t\tdebug2_f(\"crypto_sign_ed25519_open failed: %d\", ret);\n\t}\n\tif (ret != 0 || mlen != dlen) {\n\t\tr = SSH_ERR_SIGNATURE_INVALID;\n\t\tgoto out;\n\t}\n\t \n\t \n\tr = 0;\n out:\n\tif (sm != NULL)\n\t\tfreezero(sm, smlen);\n\tif (m != NULL)\n\t\tfreezero(m, smlen);  \n\tsshbuf_free(b);\n\tfree(ktype);\n\treturn r;\n}\n\n \nconst struct sshkey_impl_funcs sshkey_ed25519_funcs = {\n\t \t\tNULL,\n\t \t\tNULL,\n\t \tssh_ed25519_cleanup,\n\t \t\tssh_ed25519_equal,\n\t  ssh_ed25519_serialize_public,\n\t  ssh_ed25519_deserialize_public,\n\t  ssh_ed25519_serialize_private,\n\t  ssh_ed25519_deserialize_private,\n\t \tssh_ed25519_generate,\n\t \tssh_ed25519_copy_public,\n\t \t\tssh_ed25519_sign,\n\t \t\tssh_ed25519_verify,\n};\n\nconst struct sshkey_impl sshkey_ed25519_impl = {\n\t \t\t\"ssh-ed25519\",\n\t \t\"ED25519\",\n\t \t\tNULL,\n\t \t\tKEY_ED25519,\n\t \t\t0,\n\t \t\t0,\n\t \t0,\n\t \t256,\n\t \t\t&sshkey_ed25519_funcs,\n};\n\nconst struct sshkey_impl sshkey_ed25519_cert_impl = {\n\t \t\t\"ssh-ed25519-cert-v01@openssh.com\",\n\t \t\"ED25519-CERT\",\n\t \t\tNULL,\n\t \t\tKEY_ED25519_CERT,\n\t \t\t0,\n\t \t\t1,\n\t \t0,\n\t \t256,\n\t \t\t&sshkey_ed25519_funcs,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}