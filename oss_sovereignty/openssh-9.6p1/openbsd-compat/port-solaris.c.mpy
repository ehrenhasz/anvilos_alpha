{
  "module_name": "port-solaris.c",
  "hash_id": "c116b7d976fecfa1cb14f1a234385b1702eba62d65975059613080ade3ea5bd8",
  "original_prompt": "Ingested from openssh-9.6p1/openbsd-compat/port-solaris.c",
  "human_readable_source": " \n\n#include \"config.h\"\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <sys/stat.h>\n\n#include <errno.h>\n#ifdef HAVE_FCNTL_H\n# include <fcntl.h>\n#endif\n#include <stdarg.h>\n#include <string.h>\n#include <unistd.h>\n\n#include \"log.h\"\n\n#ifdef USE_SOLARIS_PROCESS_CONTRACTS\n\n#include <libcontract.h>\n#include <sys/contract/process.h>\n#include <sys/ctfs.h>\n\n#define CT_TEMPLATE\tCTFS_ROOT \"/process/template\"\n#define CT_LATEST\tCTFS_ROOT \"/process/latest\"\n\nstatic int tmpl_fd = -1;\n\n \nstatic ctid_t\nget_active_process_contract_id(void)\n{\n\tint stat_fd;\n\tctid_t ctid = -1;\n\tct_stathdl_t stathdl;\n\n\tif ((stat_fd = open64(CT_LATEST, O_RDONLY)) == -1) {\n\t\terror(\"%s: Error opening 'latest' process \"\n\t\t    \"contract: %s\", __func__, strerror(errno));\n\t\treturn -1;\n\t}\n\tif (ct_status_read(stat_fd, CTD_COMMON, &stathdl) != 0) {\n\t\terror(\"%s: Error reading process contract \"\n\t\t    \"status: %s\", __func__, strerror(errno));\n\t\tgoto out;\n\t}\n\tif ((ctid = ct_status_get_id(stathdl)) < 0) {\n\t\terror(\"%s: Error getting process contract id: %s\",\n\t\t    __func__, strerror(errno));\n\t\tgoto out;\n\t}\n\n\tct_status_free(stathdl);\n out:\n\tclose(stat_fd);\n\treturn ctid;\n}\n\nvoid\nsolaris_contract_pre_fork(void)\n{\n\tif ((tmpl_fd = open64(CT_TEMPLATE, O_RDWR)) == -1) {\n\t\terror(\"%s: open %s: %s\", __func__,\n\t\t    CT_TEMPLATE, strerror(errno));\n\t\treturn;\n\t}\n\n\tdebug2(\"%s: setting up process contract template on fd %d\",\n\t    __func__, tmpl_fd);\n\n\t \n\tif (ct_pr_tmpl_set_param(tmpl_fd, CT_PR_PGRPONLY) != 0) {\n\t\terror(\"%s: Error setting process contract parameter set \"\n\t\t    \"(pgrponly): %s\", __func__, strerror(errno));\n\t\tgoto fail;\n\t}\n\tif (ct_pr_tmpl_set_fatal(tmpl_fd, CT_PR_EV_HWERR) != 0) {\n\t\terror(\"%s: Error setting process contract template \"\n\t\t    \"fatal events: %s\", __func__, strerror(errno));\n\t\tgoto fail;\n\t}\n\tif (ct_tmpl_set_critical(tmpl_fd, 0) != 0) {\n\t\terror(\"%s: Error setting process contract template \"\n\t\t    \"critical events: %s\", __func__, strerror(errno));\n\t\tgoto fail;\n\t}\n\tif (ct_tmpl_set_informative(tmpl_fd, CT_PR_EV_HWERR) != 0) {\n\t\terror(\"%s: Error setting process contract template \"\n\t\t    \"informative events: %s\", __func__, strerror(errno));\n\t\tgoto fail;\n\t}\n\n\t \n\tif (ct_tmpl_activate(tmpl_fd) != 0) {\n\t\terror(\"%s: Error activating process contract \"\n\t\t    \"template: %s\", __func__, strerror(errno));\n\t\tgoto fail;\n\t}\n\treturn;\n\n fail:\n\tif (tmpl_fd != -1) {\n\t\tclose(tmpl_fd);\n\t\ttmpl_fd = -1;\n\t}\n}\n\nvoid\nsolaris_contract_post_fork_child()\n{\n\tdebug2(\"%s: clearing process contract template on fd %d\",\n\t    __func__, tmpl_fd);\n\n\t \n\tif (ct_tmpl_clear(tmpl_fd) != 0)\n\t\terror(\"%s: Error clearing active process contract \"\n\t\t    \"template: %s\", __func__, strerror(errno));\n\n\tclose(tmpl_fd);\n\ttmpl_fd = -1;\n}\n\nvoid\nsolaris_contract_post_fork_parent(pid_t pid)\n{\n\tctid_t ctid;\n\tchar ctl_path[256];\n\tint r, ctl_fd = -1, stat_fd = -1;\n\n\tdebug2(\"%s: clearing template (fd %d)\", __func__, tmpl_fd);\n\n\tif (tmpl_fd == -1)\n\t\treturn;\n\n\t \n\tif ((r = ct_tmpl_clear(tmpl_fd)) != 0)\n\t\terror(\"%s: Error clearing active process contract \"\n\t\t    \"template: %s\", __func__, strerror(errno));\n\n\tclose(tmpl_fd);\n\ttmpl_fd = -1;\n\n\t \n\tif (r != 0 || pid <= 0)\n\t\treturn;\n\n\t \n\tctid = get_active_process_contract_id();\n\n\tdebug2(\"%s: abandoning contract id %ld\", __func__, ctid);\n\n\tsnprintf(ctl_path, sizeof(ctl_path),\n\t    CTFS_ROOT \"/process/%ld/ctl\", ctid);\n\tif ((ctl_fd = open64(ctl_path, O_WRONLY)) < 0) {\n\t\terror(\"%s: Error opening process contract \"\n\t\t    \"ctl file: %s\", __func__, strerror(errno));\n\t\tgoto fail;\n\t}\n\tif (ct_ctl_abandon(ctl_fd) < 0) {\n\t\terror(\"%s: Error abandoning process contract: %s\",\n\t\t    __func__, strerror(errno));\n\t\tgoto fail;\n\t}\n\tclose(ctl_fd);\n\treturn;\n\n fail:\n\tif (tmpl_fd != -1) {\n\t\tclose(tmpl_fd);\n\t\ttmpl_fd = -1;\n\t}\n\tif (stat_fd != -1)\n\t\tclose(stat_fd);\n\tif (ctl_fd != -1)\n\t\tclose(ctl_fd);\n}\n#endif\n\n#ifdef USE_SOLARIS_PROJECTS\n#include <sys/task.h>\n#include <project.h>\n\n \nvoid\nsolaris_set_default_project(struct passwd *pw)\n{\n\tstruct project  *defaultproject;\n\tstruct project   tempproject;\n\tchar buf[1024];\n\n\t \n\tif ((defaultproject = getdefaultproj(pw->pw_name, &tempproject, &buf,\n\t    sizeof(buf))) != NULL) {\n\t\t \n\t\tif (setproject(defaultproject->pj_name, pw->pw_name,\n\t\t    TASK_NORMAL) != 0)\n\t\t\tdebug(\"setproject(%s): %s\", defaultproject->pj_name,\n\t\t\t    strerror(errno));\n\t} else {\n\t\t \n\t\tdebug(\"getdefaultproj(%s): %s\", pw->pw_name, strerror(errno));\n\t}\n}\n#endif  \n\n#ifdef USE_SOLARIS_PRIVS\n# ifdef HAVE_PRIV_H\n#  include <priv.h>\n# endif\n\npriv_set_t *\nsolaris_basic_privset(void)\n{\n\tpriv_set_t *pset;\n\n#ifdef HAVE_PRIV_BASICSET\n\tif ((pset = priv_allocset()) == NULL) {\n\t\terror(\"priv_allocset: %s\", strerror(errno));\n\t\treturn NULL;\n\t}\n\tpriv_basicset(pset);\n#else\n\tif ((pset = priv_str_to_set(\"basic\", \",\", NULL)) == NULL) {\n\t\terror(\"priv_str_to_set: %s\", strerror(errno));\n\t\treturn NULL;\n\t}\n#endif\n\treturn pset;\n}\n\nvoid\nsolaris_drop_privs_pinfo_net_fork_exec(void)\n{\n\tpriv_set_t *pset = NULL, *npset = NULL;\n\n\t \n\n\tif ((pset = priv_allocset()) == NULL)\n\t\tfatal(\"priv_allocset: %s\", strerror(errno));\n\tif ((npset = solaris_basic_privset()) == NULL)\n\t\tfatal(\"solaris_basic_privset: %s\", strerror(errno));\n\n\tif (priv_addset(npset, PRIV_FILE_CHOWN) != 0 ||\n\t    priv_addset(npset, PRIV_FILE_DAC_READ) != 0 ||\n\t    priv_addset(npset, PRIV_FILE_DAC_SEARCH) != 0 ||\n\t    priv_addset(npset, PRIV_FILE_DAC_WRITE) != 0 ||\n\t    priv_addset(npset, PRIV_FILE_OWNER) != 0)\n\t\tfatal(\"priv_addset: %s\", strerror(errno));\n\n\tif (priv_delset(npset, PRIV_PROC_EXEC) != 0 ||\n#ifdef PRIV_NET_ACCESS\n\t    priv_delset(npset, PRIV_NET_ACCESS) != 0 ||\n#endif\n\t    priv_delset(npset, PRIV_PROC_FORK) != 0 ||\n\t    priv_delset(npset, PRIV_PROC_INFO) != 0 ||\n\t    priv_delset(npset, PRIV_PROC_SESSION) != 0)\n\t\tfatal(\"priv_delset: %s\", strerror(errno));\n\n#ifdef PRIV_XPOLICY\n\t \n\tif (getpflags(PRIV_XPOLICY) == 1) {\n\t\tif (getppriv(PRIV_LIMIT, pset) != 0)\n\t\t\tfatal(\"getppriv: %s\", strerror(errno));\n\t\tpriv_intersect(pset, npset);\n\t\tif (setppriv(PRIV_SET, PRIV_LIMIT, npset) != 0)\n\t\t\tfatal(\"setppriv: %s\", strerror(errno));\n\t} else\n#endif\n\t{\n\t\t \n\t\tpriv_emptyset(pset);\n\t\tif (setppriv(PRIV_SET, PRIV_LIMIT, pset) != 0)\n\t\t\tfatal(\"setppriv: %s\", strerror(errno));\n\t}\n\n\tif (getppriv(PRIV_PERMITTED, pset) != 0)\n\t\tfatal(\"getppriv: %s\", strerror(errno));\n\n\tpriv_intersect(pset, npset);\n\n\tif (setppriv(PRIV_SET, PRIV_PERMITTED, npset) != 0 ||\n\t    setppriv(PRIV_SET, PRIV_INHERITABLE, npset) != 0)\n\t\tfatal(\"setppriv: %s\", strerror(errno));\n\n\tpriv_freeset(pset);\n\tpriv_freeset(npset);\n}\n\nvoid\nsolaris_drop_privs_root_pinfo_net(void)\n{\n\tpriv_set_t *pset = NULL;\n\n\t \n\tif ((pset = solaris_basic_privset()) == NULL)\n\t\tfatal(\"solaris_basic_privset: %s\", strerror(errno));\n\n\tif (priv_delset(pset, PRIV_FILE_LINK_ANY) != 0 ||\n#ifdef PRIV_NET_ACCESS\n\t    priv_delset(pset, PRIV_NET_ACCESS) != 0 ||\n#endif\n\t    priv_delset(pset, PRIV_PROC_INFO) != 0 ||\n\t    priv_delset(pset, PRIV_PROC_SESSION) != 0)\n\t\tfatal(\"priv_delset: %s\", strerror(errno));\n\n\tif (setppriv(PRIV_SET, PRIV_PERMITTED, pset) != 0 ||\n\t    setppriv(PRIV_SET, PRIV_LIMIT, pset) != 0 ||\n\t    setppriv(PRIV_SET, PRIV_INHERITABLE, pset) != 0)\n\t\tfatal(\"setppriv: %s\", strerror(errno));\n\n\tpriv_freeset(pset);\n}\n\nvoid\nsolaris_drop_privs_root_pinfo_net_exec(void)\n{\n\tpriv_set_t *pset = NULL;\n\n\n\t \n\tif ((pset = solaris_basic_privset()) == NULL)\n\t\tfatal(\"solaris_basic_privset: %s\", strerror(errno));\n\n\tif (priv_delset(pset, PRIV_FILE_LINK_ANY) != 0 ||\n#ifdef PRIV_NET_ACCESS\n\t    priv_delset(pset, PRIV_NET_ACCESS) != 0 ||\n#endif\n\t    priv_delset(pset, PRIV_PROC_EXEC) != 0 ||\n\t    priv_delset(pset, PRIV_PROC_INFO) != 0)\n\t\tfatal(\"priv_delset: %s\", strerror(errno));\n\n\tif (setppriv(PRIV_SET, PRIV_PERMITTED, pset) != 0 ||\n\t    setppriv(PRIV_SET, PRIV_LIMIT, pset) != 0 ||\n\t    setppriv(PRIV_SET, PRIV_INHERITABLE, pset) != 0)\n\t\tfatal(\"setppriv: %s\", strerror(errno));\n\n\tpriv_freeset(pset);\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}