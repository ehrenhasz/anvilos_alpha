{
  "module_name": "bsd-openpty.c",
  "hash_id": "36eaf074b59b1dda7140b5328ff4175af993803cf2e1ebf7518528fd40c2d76c",
  "original_prompt": "Ingested from openssh-9.6p1/openbsd-compat/bsd-openpty.c",
  "human_readable_source": " \n\n \n\n \n\n#include \"includes.h\"\n#if !defined(HAVE_OPENPTY)\n\n#include <sys/types.h>\n\n#include <stdlib.h>\n\n#ifdef HAVE_SYS_STAT_H\n# include <sys/stat.h>\n#endif\n#ifdef HAVE_SYS_IOCTL_H\n# include <sys/ioctl.h>\n#endif\n\n#ifdef HAVE_FCNTL_H\n# include <fcntl.h>\n#endif\n\n#ifdef HAVE_UTIL_H\n# include <util.h>\n#endif  \n\n#ifdef HAVE_PTY_H\n# include <pty.h>\n#endif\n#if defined(HAVE_DEV_PTMX) && defined(HAVE_SYS_STROPTS_H)\n# include <sys/stropts.h>\n#endif\n\n#include <signal.h>\n#include <string.h>\n#include <unistd.h>\n\n#include \"misc.h\"\n#include \"log.h\"\n\n#ifndef O_NOCTTY\n#define O_NOCTTY 0\n#endif\n\n#if defined(HAVE_DEV_PTMX) && !defined(HAVE__GETPTY)\nstatic int\nopenpty_streams(int *amaster, int *aslave)\n{\n\t \n\tint ptm;\n\tchar *pts;\n\tsshsig_t old_signal;\n\n\tif ((ptm = open(\"/dev/ptmx\", O_RDWR | O_NOCTTY)) == -1)\n\t\treturn (-1);\n\n\t \n\told_signal = ssh_signal(SIGCHLD, SIG_DFL);\n\tif (grantpt(ptm) < 0)\n\t\treturn (-1);\n\tssh_signal(SIGCHLD, old_signal);\n\n\tif (unlockpt(ptm) < 0)\n\t\treturn (-1);\n\n\tif ((pts = ptsname(ptm)) == NULL)\n\t\treturn (-1);\n\t*amaster = ptm;\n\n\t \n\tif ((*aslave = open(pts, O_RDWR | O_NOCTTY)) == -1) {\n\t\tclose(*amaster);\n\t\treturn (-1);\n\t}\n\n# if defined(I_FIND) && defined(__SVR4)\n\t \n\tif (ioctl(*aslave, I_FIND, \"ptem\") != 0)\n\t\treturn 0;\n# endif\n\n\t \n\tioctl(*aslave, I_PUSH, \"ptem\");\n\tioctl(*aslave, I_PUSH, \"ldterm\");\n# ifndef __hpux\n\tioctl(*aslave, I_PUSH, \"ttcompat\");\n# endif  \n\treturn (0);\n}\n#endif\n\nint\nopenpty(int *amaster, int *aslave, char *name, struct termios *termp,\n   struct winsize *winp)\n{\n#if defined(HAVE__GETPTY)\n\t \n\tchar *slave;\n\n\tif ((slave = _getpty(amaster, O_RDWR, 0622, 0)) == NULL)\n\t\treturn (-1);\n\n\t \n\tif ((*aslave = open(slave, O_RDWR | O_NOCTTY)) == -1) {\n\t\tclose(*amaster);\n\t\treturn (-1);\n\t}\n\treturn (0);\n\n#elif defined(HAVE_DEV_PTMX)\n\n#ifdef SSHD_ACQUIRES_CTTY\n\t \n\tint r, fd;\n\tstatic int junk_ptyfd = -1, junk_ttyfd;\n\n\tr = openpty_streams(amaster, aslave);\n\tif (junk_ptyfd == -1 && (fd = open(_PATH_TTY, O_RDWR|O_NOCTTY)) >= 0) {\n\t\tclose(fd);\n\t\tjunk_ptyfd = *amaster;\n\t\tjunk_ttyfd = *aslave;\n\t\tdebug(\"STREAMS bug workaround pty %d tty %d name %s\",\n\t\t    junk_ptyfd, junk_ttyfd, ttyname(junk_ttyfd));\n        } else\n\t\treturn r;\n#endif\n\n\treturn openpty_streams(amaster, aslave);\n\n#elif defined(HAVE_DEV_PTS_AND_PTC)\n\t \n\tconst char *ttname;\n\n\tif ((*amaster = open(\"/dev/ptc\", O_RDWR | O_NOCTTY)) == -1)\n\t\treturn (-1);\n\tif ((ttname = ttyname(*amaster)) == NULL)\n\t\treturn (-1);\n\tif ((*aslave = open(ttname, O_RDWR | O_NOCTTY)) == -1) {\n\t\tclose(*amaster);\n\t\treturn (-1);\n\t}\n\treturn (0);\n\n#else\n\t \n\tchar ptbuf[64], ttbuf[64];\n\tint i;\n\tconst char *ptymajors = \"pqrstuvwxyzabcdefghijklmno\"\n\t    \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\";\n\tconst char *ptyminors = \"0123456789abcdef\";\n\tint num_minors = strlen(ptyminors);\n\tint num_ptys = strlen(ptymajors) * num_minors;\n\tstruct termios tio;\n\n\tfor (i = 0; i < num_ptys; i++) {\n\t\tsnprintf(ptbuf, sizeof(ptbuf), \"/dev/pty%c%c\",\n\t\t    ptymajors[i / num_minors], ptyminors[i % num_minors]);\n\t\tsnprintf(ttbuf, sizeof(ttbuf), \"/dev/tty%c%c\",\n\t\t    ptymajors[i / num_minors], ptyminors[i % num_minors]);\n\n\t\tif ((*amaster = open(ptbuf, O_RDWR | O_NOCTTY)) == -1) {\n\t\t\t \n\t\t\tsnprintf(ptbuf, sizeof(ptbuf), \"/dev/ptyp%d\", i);\n\t\t\tsnprintf(ttbuf, sizeof(ttbuf), \"/dev/ttyp%d\", i);\n\t\t\tif ((*amaster = open(ptbuf, O_RDWR | O_NOCTTY)) == -1)\n\t\t\t\tcontinue;\n\t\t}\n\n\t\t \n\t\tif ((*aslave = open(ttbuf, O_RDWR | O_NOCTTY)) == -1) {\n\t\t\tclose(*amaster);\n\t\t\treturn (-1);\n\t\t}\n\t\t \n\t\tif (tcgetattr(*amaster, &tio) != -1) {\n\t\t\ttio.c_lflag |= (ECHO | ISIG | ICANON);\n\t\t\ttio.c_oflag |= (OPOST | ONLCR);\n\t\t\ttio.c_iflag |= ICRNL;\n\t\t\ttcsetattr(*amaster, TCSANOW, &tio);\n\t\t}\n\n\t\treturn (0);\n\t}\n\treturn (-1);\n#endif\n}\n\n#endif  \n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}