{
  "module_name": "mktemp.c",
  "hash_id": "3ce7f53c7d37d03d2cc8f750db4964eec8beb42eee23bf0ea2987cfc81d280c6",
  "original_prompt": "Ingested from openssh-9.6p1/openbsd-compat/mktemp.c",
  "human_readable_source": " \n \n\n \n \n\n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <sys/stat.h>\n#include <errno.h>\n#include <fcntl.h>\n#include <limits.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <ctype.h>\n#include <unistd.h>\n\n#ifdef mkstemp\n#undef mkstemp\n#endif\nint mkstemp(char *);\n\n \nint\n_ssh_mkstemp(char *template)\n{\n\tmode_t mask;\n\tint ret;\n\n\tmask = umask(0177);\n\tret = mkstemp(template);\n\t(void)umask(mask);\n\treturn ret;\n}\n\n#if !defined(HAVE_MKDTEMP)\n\n#define MKTEMP_NAME\t0\n#define MKTEMP_FILE\t1\n#define MKTEMP_DIR\t2\n\n#define TEMPCHARS\t\"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789\"\n#define NUM_CHARS\t(sizeof(TEMPCHARS) - 1)\n\nstatic int\nmktemp_internal(char *path, int slen, int mode)\n{\n\tchar *start, *cp, *ep;\n\tconst char *tempchars = TEMPCHARS;\n\tunsigned int r, tries;\n\tstruct stat sb;\n\tsize_t len;\n\tint fd;\n\n\tlen = strlen(path);\n\tif (len == 0 || slen < 0 || (size_t)slen >= len) {\n\t\terrno = EINVAL;\n\t\treturn(-1);\n\t}\n\tep = path + len - slen;\n\n\ttries = 1;\n\tfor (start = ep; start > path && start[-1] == 'X'; start--) {\n\t\tif (tries < INT_MAX / NUM_CHARS)\n\t\t\ttries *= NUM_CHARS;\n\t}\n\ttries *= 2;\n\n\tdo {\n\t\tfor (cp = start; cp != ep; cp++) {\n\t\t\tr = arc4random_uniform(NUM_CHARS);\n\t\t\t*cp = tempchars[r];\n\t\t}\n\n\t\tswitch (mode) {\n\t\tcase MKTEMP_NAME:\n\t\t\tif (lstat(path, &sb) != 0)\n\t\t\t\treturn(errno == ENOENT ? 0 : -1);\n\t\t\tbreak;\n\t\tcase MKTEMP_FILE:\n\t\t\tfd = open(path, O_CREAT|O_EXCL|O_RDWR, S_IRUSR|S_IWUSR);\n\t\t\tif (fd != -1 || errno != EEXIST)\n\t\t\t\treturn(fd);\n\t\t\tbreak;\n\t\tcase MKTEMP_DIR:\n\t\t\tif (mkdir(path, S_IRUSR|S_IWUSR|S_IXUSR) == 0)\n\t\t\t\treturn(0);\n\t\t\tif (errno != EEXIST)\n\t\t\t\treturn(-1);\n\t\t\tbreak;\n\t\t}\n\t} while (--tries);\n\n\terrno = EEXIST;\n\treturn(-1);\n}\n\n#if 0\nchar *_mktemp(char *);\n\nchar *\n_mktemp(char *path)\n{\n\tif (mktemp_internal(path, 0, MKTEMP_NAME) == -1)\n\t\treturn(NULL);\n\treturn(path);\n}\n\n__warn_references(mktemp,\n    \"warning: mktemp() possibly used unsafely; consider using mkstemp()\");\n\nchar *\nmktemp(char *path)\n{\n\treturn(_mktemp(path));\n}\n#endif\n\nint\nmkstemp(char *path)\n{\n\treturn(mktemp_internal(path, 0, MKTEMP_FILE));\n}\n\nint\nmkstemps(char *path, int slen)\n{\n\treturn(mktemp_internal(path, slen, MKTEMP_FILE));\n}\n\nchar *\nmkdtemp(char *path)\n{\n\tint error;\n\n\terror = mktemp_internal(path, 0, MKTEMP_DIR);\n\treturn(error ? NULL : path);\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}