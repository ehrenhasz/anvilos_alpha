{
  "module_name": "kexgexc.c",
  "hash_id": "e7c032bfc9e530630e6873c730e7733d468eb37addee1ac42489d59155169d88",
  "original_prompt": "Ingested from openssh-9.6p1/kexgexc.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#ifdef WITH_OPENSSL\n\n#include <sys/types.h>\n\n#include <openssl/dh.h>\n\n#include <stdarg.h>\n#include <stdio.h>\n#include <string.h>\n#include <signal.h>\n\n#include \"openbsd-compat/openssl-compat.h\"\n\n#include \"sshkey.h\"\n#include \"cipher.h\"\n#include \"digest.h\"\n#include \"kex.h\"\n#include \"log.h\"\n#include \"packet.h\"\n#include \"dh.h\"\n#include \"ssh2.h\"\n#include \"compat.h\"\n#include \"dispatch.h\"\n#include \"ssherr.h\"\n#include \"sshbuf.h\"\n#include \"misc.h\"\n\nstatic int input_kex_dh_gex_group(int, u_int32_t, struct ssh *);\nstatic int input_kex_dh_gex_reply(int, u_int32_t, struct ssh *);\n\nint\nkexgex_client(struct ssh *ssh)\n{\n\tstruct kex *kex = ssh->kex;\n\tint r;\n\tu_int nbits;\n\n\tnbits = dh_estimate(kex->dh_need * 8);\n\n\tkex->min = DH_GRP_MIN;\n\tkex->max = DH_GRP_MAX;\n\tkex->nbits = nbits;\n\tif (ssh->compat & SSH_BUG_DHGEX_LARGE)\n\t\tkex->nbits = MINIMUM(kex->nbits, 4096);\n\t \n\tif ((r = sshpkt_start(ssh, SSH2_MSG_KEX_DH_GEX_REQUEST)) != 0 ||\n\t    (r = sshpkt_put_u32(ssh, kex->min)) != 0 ||\n\t    (r = sshpkt_put_u32(ssh, kex->nbits)) != 0 ||\n\t    (r = sshpkt_put_u32(ssh, kex->max)) != 0 ||\n\t    (r = sshpkt_send(ssh)) != 0)\n\t\tgoto out;\n\tdebug(\"SSH2_MSG_KEX_DH_GEX_REQUEST(%u<%u<%u) sent\",\n\t    kex->min, kex->nbits, kex->max);\n#ifdef DEBUG_KEXDH\n\tfprintf(stderr, \"\\nmin = %d, nbits = %d, max = %d\\n\",\n\t    kex->min, kex->nbits, kex->max);\n#endif\n\tdebug(\"expecting SSH2_MSG_KEX_DH_GEX_GROUP\");\n\tssh_dispatch_set(ssh, SSH2_MSG_KEX_DH_GEX_GROUP,\n\t    &input_kex_dh_gex_group);\n\tr = 0;\n out:\n\treturn r;\n}\n\nstatic int\ninput_kex_dh_gex_group(int type, u_int32_t seq, struct ssh *ssh)\n{\n\tstruct kex *kex = ssh->kex;\n\tBIGNUM *p = NULL, *g = NULL;\n\tconst BIGNUM *pub_key;\n\tint r, bits;\n\n\tdebug(\"SSH2_MSG_KEX_DH_GEX_GROUP received\");\n\tssh_dispatch_set(ssh, SSH2_MSG_KEX_DH_GEX_GROUP, &kex_protocol_error);\n\n\tif ((r = sshpkt_get_bignum2(ssh, &p)) != 0 ||\n\t    (r = sshpkt_get_bignum2(ssh, &g)) != 0 ||\n\t    (r = sshpkt_get_end(ssh)) != 0)\n\t\tgoto out;\n\tif ((bits = BN_num_bits(p)) < 0 ||\n\t    (u_int)bits < kex->min || (u_int)bits > kex->max) {\n\t\tr = SSH_ERR_DH_GEX_OUT_OF_RANGE;\n\t\tgoto out;\n\t}\n\tif ((kex->dh = dh_new_group(g, p)) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tp = g = NULL;  \n\n\t \n\tif ((r = dh_gen_key(kex->dh, kex->we_need * 8)) != 0)\n\t\tgoto out;\n\tDH_get0_key(kex->dh, &pub_key, NULL);\n\tif ((r = sshpkt_start(ssh, SSH2_MSG_KEX_DH_GEX_INIT)) != 0 ||\n\t    (r = sshpkt_put_bignum2(ssh, pub_key)) != 0 ||\n\t    (r = sshpkt_send(ssh)) != 0)\n\t\tgoto out;\n\tdebug(\"SSH2_MSG_KEX_DH_GEX_INIT sent\");\n#ifdef DEBUG_KEXDH\n\tDHparams_print_fp(stderr, kex->dh);\n\tfprintf(stderr, \"pub= \");\n\tBN_print_fp(stderr, pub_key);\n\tfprintf(stderr, \"\\n\");\n#endif\n\tdebug(\"expecting SSH2_MSG_KEX_DH_GEX_REPLY\");\n\tssh_dispatch_set(ssh, SSH2_MSG_KEX_DH_GEX_REPLY, &input_kex_dh_gex_reply);\n\tr = 0;\nout:\n\tBN_clear_free(p);\n\tBN_clear_free(g);\n\treturn r;\n}\n\nstatic int\ninput_kex_dh_gex_reply(int type, u_int32_t seq, struct ssh *ssh)\n{\n\tstruct kex *kex = ssh->kex;\n\tBIGNUM *dh_server_pub = NULL;\n\tconst BIGNUM *pub_key, *dh_p, *dh_g;\n\tstruct sshbuf *shared_secret = NULL;\n\tstruct sshbuf *tmp = NULL, *server_host_key_blob = NULL;\n\tstruct sshkey *server_host_key = NULL;\n\tu_char *signature = NULL;\n\tu_char hash[SSH_DIGEST_MAX_LENGTH];\n\tsize_t slen, hashlen;\n\tint r;\n\n\tdebug(\"SSH2_MSG_KEX_DH_GEX_REPLY received\");\n\tssh_dispatch_set(ssh, SSH2_MSG_KEX_DH_GEX_REPLY, &kex_protocol_error);\n\n\t \n\tif ((r = sshpkt_getb_froms(ssh, &server_host_key_blob)) != 0)\n\t\tgoto out;\n\t \n\tif ((tmp = sshbuf_fromb(server_host_key_blob)) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = sshkey_fromb(tmp, &server_host_key)) != 0 ||\n\t    (r = kex_verify_host_key(ssh, server_host_key)) != 0)\n\t\tgoto out;\n\t \n\tif ((r = sshpkt_get_bignum2(ssh, &dh_server_pub)) != 0 ||\n\t    (r = sshpkt_get_string(ssh, &signature, &slen)) != 0 ||\n\t    (r = sshpkt_get_end(ssh)) != 0)\n\t\tgoto out;\n\tif ((shared_secret = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = kex_dh_compute_key(kex, dh_server_pub, shared_secret)) != 0)\n\t\tgoto out;\n\tif (ssh->compat & SSH_OLD_DHGEX)\n\t\tkex->min = kex->max = -1;\n\n\t \n\tDH_get0_key(kex->dh, &pub_key, NULL);\n\tDH_get0_pqg(kex->dh, &dh_p, NULL, &dh_g);\n\thashlen = sizeof(hash);\n\tif ((r = kexgex_hash(\n\t    kex->hash_alg,\n\t    kex->client_version,\n\t    kex->server_version,\n\t    kex->my,\n\t    kex->peer,\n\t    server_host_key_blob,\n\t    kex->min, kex->nbits, kex->max,\n\t    dh_p, dh_g,\n\t    pub_key,\n\t    dh_server_pub,\n\t    sshbuf_ptr(shared_secret), sshbuf_len(shared_secret),\n\t    hash, &hashlen)) != 0)\n\t\tgoto out;\n\n\tif ((r = sshkey_verify(server_host_key, signature, slen, hash,\n\t    hashlen, kex->hostkey_alg, ssh->compat, NULL)) != 0)\n\t\tgoto out;\n\n\tif ((r = kex_derive_keys(ssh, hash, hashlen, shared_secret)) != 0 ||\n\t    (r = kex_send_newkeys(ssh)) != 0)\n\t\tgoto out;\n\n\t \n\tif ((kex->flags & KEX_INITIAL) != 0) {\n\t\tif (kex->initial_hostkey != NULL || kex->initial_sig != NULL) {\n\t\t\tr = SSH_ERR_INTERNAL_ERROR;\n\t\t\tgoto out;\n\t\t}\n\t\tif ((kex->initial_sig = sshbuf_new()) == NULL) {\n\t\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\t\tgoto out;\n\t\t}\n\t\tif ((r = sshbuf_put(kex->initial_sig, signature, slen)) != 0)\n\t\t\tgoto out;\n\t\tkex->initial_hostkey = server_host_key;\n\t\tserver_host_key = NULL;\n\t}\n\t \n out:\n\texplicit_bzero(hash, sizeof(hash));\n\tDH_free(kex->dh);\n\tkex->dh = NULL;\n\tBN_clear_free(dh_server_pub);\n\tsshbuf_free(shared_secret);\n\tsshkey_free(server_host_key);\n\tsshbuf_free(tmp);\n\tsshbuf_free(server_host_key_blob);\n\tfree(signature);\n\treturn r;\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}