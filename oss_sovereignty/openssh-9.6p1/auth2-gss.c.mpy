{
  "module_name": "auth2-gss.c",
  "hash_id": "d26177bd45732530e8ab1debd948a7b723788ebbc627d1213bed7361a3f266db",
  "original_prompt": "Ingested from openssh-9.6p1/auth2-gss.c",
  "human_readable_source": " \n\n \n\n#include \"includes.h\"\n\n#ifdef GSSAPI\n\n#include <sys/types.h>\n\n#include <stdarg.h>\n\n#include \"xmalloc.h\"\n#include \"sshkey.h\"\n#include \"hostfile.h\"\n#include \"auth.h\"\n#include \"ssh2.h\"\n#include \"log.h\"\n#include \"dispatch.h\"\n#include \"sshbuf.h\"\n#include \"ssherr.h\"\n#include \"misc.h\"\n#include \"servconf.h\"\n#include \"packet.h\"\n#include \"kex.h\"\n#include \"ssh-gss.h\"\n#include \"monitor_wrap.h\"\n\n#define SSH_GSSAPI_MAX_MECHS\t2048\n\nextern ServerOptions options;\n\nstatic int input_gssapi_token(int type, u_int32_t plen, struct ssh *ssh);\nstatic int input_gssapi_mic(int type, u_int32_t plen, struct ssh *ssh);\nstatic int input_gssapi_exchange_complete(int type, u_int32_t plen, struct ssh *ssh);\nstatic int input_gssapi_errtok(int, u_int32_t, struct ssh *);\n\n \nstatic int\nuserauth_gssapi(struct ssh *ssh, const char *method)\n{\n\tAuthctxt *authctxt = ssh->authctxt;\n\tgss_OID_desc goid = {0, NULL};\n\tGssctxt *ctxt = NULL;\n\tint r, present;\n\tu_int mechs;\n\tOM_uint32 ms;\n\tsize_t len;\n\tu_char *doid = NULL;\n\n\tif ((r = sshpkt_get_u32(ssh, &mechs)) != 0)\n\t\tfatal_fr(r, \"parse packet\");\n\n\tif (mechs == 0) {\n\t\tlogit_f(\"mechanism negotiation is not supported\");\n\t\treturn (0);\n\t} else if (mechs > SSH_GSSAPI_MAX_MECHS) {\n\t\tlogit_f(\"too many mechanisms requested %u > %u\", mechs,\n\t\t    SSH_GSSAPI_MAX_MECHS);\n\t\treturn (0);\n\t}\n\n\tdo {\n\t\tmechs--;\n\n\t\tfree(doid);\n\n\t\tpresent = 0;\n\t\tif ((r = sshpkt_get_string(ssh, &doid, &len)) != 0)\n\t\t\tfatal_fr(r, \"parse oid\");\n\n\t\tif (len > 2 && doid[0] == SSH_GSS_OIDTYPE &&\n\t\t    doid[1] == len - 2) {\n\t\t\tgoid.elements = doid + 2;\n\t\t\tgoid.length   = len - 2;\n\t\t\tssh_gssapi_test_oid_supported(&ms, &goid, &present);\n\t\t} else {\n\t\t\tlogit_f(\"badly formed OID received\");\n\t\t}\n\t} while (mechs > 0 && !present);\n\n\tif (!present) {\n\t\tfree(doid);\n\t\tauthctxt->server_caused_failure = 1;\n\t\treturn (0);\n\t}\n\n\tif (!authctxt->valid || authctxt->user == NULL) {\n\t\tdebug2_f(\"disabled because of invalid user\");\n\t\tfree(doid);\n\t\treturn (0);\n\t}\n\n\tif (GSS_ERROR(PRIVSEP(ssh_gssapi_server_ctx(&ctxt, &goid)))) {\n\t\tif (ctxt != NULL)\n\t\t\tssh_gssapi_delete_ctx(&ctxt);\n\t\tfree(doid);\n\t\tauthctxt->server_caused_failure = 1;\n\t\treturn (0);\n\t}\n\n\tauthctxt->methoddata = (void *)ctxt;\n\n\t \n\tif ((r = sshpkt_start(ssh, SSH2_MSG_USERAUTH_GSSAPI_RESPONSE)) != 0 ||\n\t    (r = sshpkt_put_string(ssh, doid, len)) != 0 ||\n\t    (r = sshpkt_send(ssh)) != 0)\n\t\tfatal_fr(r, \"send packet\");\n\n\tfree(doid);\n\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_TOKEN, &input_gssapi_token);\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_ERRTOK, &input_gssapi_errtok);\n\tauthctxt->postponed = 1;\n\n\treturn (0);\n}\n\nstatic int\ninput_gssapi_token(int type, u_int32_t plen, struct ssh *ssh)\n{\n\tAuthctxt *authctxt = ssh->authctxt;\n\tGssctxt *gssctxt;\n\tgss_buffer_desc send_tok = GSS_C_EMPTY_BUFFER;\n\tgss_buffer_desc recv_tok;\n\tOM_uint32 maj_status, min_status, flags;\n\tu_char *p;\n\tsize_t len;\n\tint r;\n\n\tif (authctxt == NULL || (authctxt->methoddata == NULL && !use_privsep))\n\t\tfatal(\"No authentication or GSSAPI context\");\n\n\tgssctxt = authctxt->methoddata;\n\tif ((r = sshpkt_get_string(ssh, &p, &len)) != 0 ||\n\t    (r = sshpkt_get_end(ssh)) != 0)\n\t\tfatal_fr(r, \"parse packet\");\n\n\trecv_tok.value = p;\n\trecv_tok.length = len;\n\tmaj_status = PRIVSEP(ssh_gssapi_accept_ctx(gssctxt, &recv_tok,\n\t    &send_tok, &flags));\n\n\tfree(p);\n\n\tif (GSS_ERROR(maj_status)) {\n\t\tif (send_tok.length != 0) {\n\t\t\tif ((r = sshpkt_start(ssh,\n\t\t\t    SSH2_MSG_USERAUTH_GSSAPI_ERRTOK)) != 0 ||\n\t\t\t    (r = sshpkt_put_string(ssh, send_tok.value,\n\t\t\t    send_tok.length)) != 0 ||\n\t\t\t    (r = sshpkt_send(ssh)) != 0)\n\t\t\t\tfatal_fr(r, \"send ERRTOK packet\");\n\t\t}\n\t\tauthctxt->postponed = 0;\n\t\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_TOKEN, NULL);\n\t\tuserauth_finish(ssh, 0, \"gssapi-with-mic\", NULL);\n\t} else {\n\t\tif (send_tok.length != 0) {\n\t\t\tif ((r = sshpkt_start(ssh,\n\t\t\t    SSH2_MSG_USERAUTH_GSSAPI_TOKEN)) != 0 ||\n\t\t\t    (r = sshpkt_put_string(ssh, send_tok.value,\n\t\t\t    send_tok.length)) != 0 ||\n\t\t\t    (r = sshpkt_send(ssh)) != 0)\n\t\t\t\tfatal_fr(r, \"send TOKEN packet\");\n\t\t}\n\t\tif (maj_status == GSS_S_COMPLETE) {\n\t\t\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_TOKEN, NULL);\n\t\t\tif (flags & GSS_C_INTEG_FLAG)\n\t\t\t\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_MIC,\n\t\t\t\t    &input_gssapi_mic);\n\t\t\telse\n\t\t\t\tssh_dispatch_set(ssh,\n\t\t\t\t    SSH2_MSG_USERAUTH_GSSAPI_EXCHANGE_COMPLETE,\n\t\t\t\t    &input_gssapi_exchange_complete);\n\t\t}\n\t}\n\n\tgss_release_buffer(&min_status, &send_tok);\n\treturn 0;\n}\n\nstatic int\ninput_gssapi_errtok(int type, u_int32_t plen, struct ssh *ssh)\n{\n\tAuthctxt *authctxt = ssh->authctxt;\n\tGssctxt *gssctxt;\n\tgss_buffer_desc send_tok = GSS_C_EMPTY_BUFFER;\n\tgss_buffer_desc recv_tok;\n\tOM_uint32 maj_status;\n\tint r;\n\tu_char *p;\n\tsize_t len;\n\n\tif (authctxt == NULL || (authctxt->methoddata == NULL && !use_privsep))\n\t\tfatal(\"No authentication or GSSAPI context\");\n\n\tgssctxt = authctxt->methoddata;\n\tif ((r = sshpkt_get_string(ssh, &p, &len)) != 0 ||\n\t    (r = sshpkt_get_end(ssh)) != 0)\n\t\tfatal_fr(r, \"parse packet\");\n\trecv_tok.value = p;\n\trecv_tok.length = len;\n\n\t \n\tmaj_status = PRIVSEP(ssh_gssapi_accept_ctx(gssctxt, &recv_tok,\n\t    &send_tok, NULL));\n\n\tfree(recv_tok.value);\n\n\t \n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_TOKEN, NULL);\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_ERRTOK, NULL);\n\n\t \n\n\tgss_release_buffer(&maj_status, &send_tok);\n\treturn 0;\n}\n\n \n\nstatic int\ninput_gssapi_exchange_complete(int type, u_int32_t plen, struct ssh *ssh)\n{\n\tAuthctxt *authctxt = ssh->authctxt;\n\tint r, authenticated;\n\tconst char *displayname;\n\n\tif (authctxt == NULL || (authctxt->methoddata == NULL && !use_privsep))\n\t\tfatal(\"No authentication or GSSAPI context\");\n\n\t \n\n\tif ((r = sshpkt_get_end(ssh)) != 0)\n\t\tfatal_fr(r, \"parse packet\");\n\n\tauthenticated = PRIVSEP(ssh_gssapi_userok(authctxt->user));\n\n\tif ((!use_privsep || mm_is_monitor()) &&\n\t    (displayname = ssh_gssapi_displayname()) != NULL)\n\t\tauth2_record_info(authctxt, \"%s\", displayname);\n\n\tauthctxt->postponed = 0;\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_TOKEN, NULL);\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_ERRTOK, NULL);\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_MIC, NULL);\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_EXCHANGE_COMPLETE, NULL);\n\tuserauth_finish(ssh, authenticated, \"gssapi-with-mic\", NULL);\n\treturn 0;\n}\n\nstatic int\ninput_gssapi_mic(int type, u_int32_t plen, struct ssh *ssh)\n{\n\tAuthctxt *authctxt = ssh->authctxt;\n\tGssctxt *gssctxt;\n\tint r, authenticated = 0;\n\tstruct sshbuf *b;\n\tgss_buffer_desc mic, gssbuf;\n\tconst char *displayname;\n\tu_char *p;\n\tsize_t len;\n\n\tif (authctxt == NULL || (authctxt->methoddata == NULL && !use_privsep))\n\t\tfatal(\"No authentication or GSSAPI context\");\n\n\tgssctxt = authctxt->methoddata;\n\n\tif ((r = sshpkt_get_string(ssh, &p, &len)) != 0)\n\t\tfatal_fr(r, \"parse packet\");\n\tif ((b = sshbuf_new()) == NULL)\n\t\tfatal_f(\"sshbuf_new failed\");\n\tmic.value = p;\n\tmic.length = len;\n\tssh_gssapi_buildmic(b, authctxt->user, authctxt->service,\n\t    \"gssapi-with-mic\", ssh->kex->session_id);\n\n\tif ((gssbuf.value = sshbuf_mutable_ptr(b)) == NULL)\n\t\tfatal_f(\"sshbuf_mutable_ptr failed\");\n\tgssbuf.length = sshbuf_len(b);\n\n\tif (!GSS_ERROR(PRIVSEP(ssh_gssapi_checkmic(gssctxt, &gssbuf, &mic))))\n\t\tauthenticated = PRIVSEP(ssh_gssapi_userok(authctxt->user));\n\telse\n\t\tlogit(\"GSSAPI MIC check failed\");\n\n\tsshbuf_free(b);\n\tfree(mic.value);\n\n\tif ((!use_privsep || mm_is_monitor()) &&\n\t    (displayname = ssh_gssapi_displayname()) != NULL)\n\t\tauth2_record_info(authctxt, \"%s\", displayname);\n\n\tauthctxt->postponed = 0;\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_TOKEN, NULL);\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_ERRTOK, NULL);\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_MIC, NULL);\n\tssh_dispatch_set(ssh, SSH2_MSG_USERAUTH_GSSAPI_EXCHANGE_COMPLETE, NULL);\n\tuserauth_finish(ssh, authenticated, \"gssapi-with-mic\", NULL);\n\treturn 0;\n}\n\nAuthmethod method_gssapi = {\n\t\"gssapi-with-mic\",\n\tNULL,\n\tuserauth_gssapi,\n\t&options.gss_authentication\n};\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}