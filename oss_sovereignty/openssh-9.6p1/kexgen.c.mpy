{
  "module_name": "kexgen.c",
  "hash_id": "72ab1cda9d0146b00ee1748cb01f411bbc1e80d01c91978726d69095cf462288",
  "original_prompt": "Ingested from openssh-9.6p1/kexgen.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n\n#include <stdarg.h>\n#include <stdio.h>\n#include <string.h>\n#include <signal.h>\n\n#include \"sshkey.h\"\n#include \"kex.h\"\n#include \"log.h\"\n#include \"packet.h\"\n#include \"ssh2.h\"\n#include \"sshbuf.h\"\n#include \"digest.h\"\n#include \"ssherr.h\"\n\nstatic int input_kex_gen_init(int, u_int32_t, struct ssh *);\nstatic int input_kex_gen_reply(int type, u_int32_t seq, struct ssh *ssh);\n\nstatic int\nkex_gen_hash(\n    int hash_alg,\n    const struct sshbuf *client_version,\n    const struct sshbuf *server_version,\n    const struct sshbuf *client_kexinit,\n    const struct sshbuf *server_kexinit,\n    const struct sshbuf *server_host_key_blob,\n    const struct sshbuf *client_pub,\n    const struct sshbuf *server_pub,\n    const struct sshbuf *shared_secret,\n    u_char *hash, size_t *hashlen)\n{\n\tstruct sshbuf *b;\n\tint r;\n\n\tif (*hashlen < ssh_digest_bytes(hash_alg))\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tif ((b = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_put_stringb(b, client_version)) != 0 ||\n\t    (r = sshbuf_put_stringb(b, server_version)) != 0 ||\n\t     \n\t    (r = sshbuf_put_u32(b, sshbuf_len(client_kexinit) + 1)) != 0 ||\n\t    (r = sshbuf_put_u8(b, SSH2_MSG_KEXINIT)) != 0 ||\n\t    (r = sshbuf_putb(b, client_kexinit)) != 0 ||\n\t    (r = sshbuf_put_u32(b, sshbuf_len(server_kexinit) + 1)) != 0 ||\n\t    (r = sshbuf_put_u8(b, SSH2_MSG_KEXINIT)) != 0 ||\n\t    (r = sshbuf_putb(b, server_kexinit)) != 0 ||\n\t    (r = sshbuf_put_stringb(b, server_host_key_blob)) != 0 ||\n\t    (r = sshbuf_put_stringb(b, client_pub)) != 0 ||\n\t    (r = sshbuf_put_stringb(b, server_pub)) != 0 ||\n\t    (r = sshbuf_putb(b, shared_secret)) != 0) {\n\t\tsshbuf_free(b);\n\t\treturn r;\n\t}\n#ifdef DEBUG_KEX\n\tsshbuf_dump(b, stderr);\n#endif\n\tif (ssh_digest_buffer(hash_alg, b, hash, *hashlen) != 0) {\n\t\tsshbuf_free(b);\n\t\treturn SSH_ERR_LIBCRYPTO_ERROR;\n\t}\n\tsshbuf_free(b);\n\t*hashlen = ssh_digest_bytes(hash_alg);\n#ifdef DEBUG_KEX\n\tdump_digest(\"hash\", hash, *hashlen);\n#endif\n\treturn 0;\n}\n\nint\nkex_gen_client(struct ssh *ssh)\n{\n\tstruct kex *kex = ssh->kex;\n\tint r;\n\n\tswitch (kex->kex_type) {\n#ifdef WITH_OPENSSL\n\tcase KEX_DH_GRP1_SHA1:\n\tcase KEX_DH_GRP14_SHA1:\n\tcase KEX_DH_GRP14_SHA256:\n\tcase KEX_DH_GRP16_SHA512:\n\tcase KEX_DH_GRP18_SHA512:\n\t\tr = kex_dh_keypair(kex);\n\t\tbreak;\n\tcase KEX_ECDH_SHA2:\n\t\tr = kex_ecdh_keypair(kex);\n\t\tbreak;\n#endif\n\tcase KEX_C25519_SHA256:\n\t\tr = kex_c25519_keypair(kex);\n\t\tbreak;\n\tcase KEX_KEM_SNTRUP761X25519_SHA512:\n\t\tr = kex_kem_sntrup761x25519_keypair(kex);\n\t\tbreak;\n\tdefault:\n\t\tr = SSH_ERR_INVALID_ARGUMENT;\n\t\tbreak;\n\t}\n\tif (r != 0)\n\t\treturn r;\n\tif ((r = sshpkt_start(ssh, SSH2_MSG_KEX_ECDH_INIT)) != 0 ||\n\t    (r = sshpkt_put_stringb(ssh, kex->client_pub)) != 0 ||\n\t    (r = sshpkt_send(ssh)) != 0)\n\t\treturn r;\n\tdebug(\"expecting SSH2_MSG_KEX_ECDH_REPLY\");\n\tssh_dispatch_set(ssh, SSH2_MSG_KEX_ECDH_REPLY, &input_kex_gen_reply);\n\treturn 0;\n}\n\nstatic int\ninput_kex_gen_reply(int type, u_int32_t seq, struct ssh *ssh)\n{\n\tstruct kex *kex = ssh->kex;\n\tstruct sshkey *server_host_key = NULL;\n\tstruct sshbuf *shared_secret = NULL;\n\tstruct sshbuf *server_blob = NULL;\n\tstruct sshbuf *tmp = NULL, *server_host_key_blob = NULL;\n\tu_char *signature = NULL;\n\tu_char hash[SSH_DIGEST_MAX_LENGTH];\n\tsize_t slen, hashlen;\n\tint r;\n\n\tdebug(\"SSH2_MSG_KEX_ECDH_REPLY received\");\n\tssh_dispatch_set(ssh, SSH2_MSG_KEX_ECDH_REPLY, &kex_protocol_error);\n\n\t \n\tif ((r = sshpkt_getb_froms(ssh, &server_host_key_blob)) != 0)\n\t\tgoto out;\n\t \n\tif ((tmp = sshbuf_fromb(server_host_key_blob)) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = sshkey_fromb(tmp, &server_host_key)) != 0)\n\t\tgoto out;\n\tif ((r = kex_verify_host_key(ssh, server_host_key)) != 0)\n\t\tgoto out;\n\n\t \n\t \n\tif ((r = sshpkt_getb_froms(ssh, &server_blob)) != 0 ||\n\t    (r = sshpkt_get_string(ssh, &signature, &slen)) != 0 ||\n\t    (r = sshpkt_get_end(ssh)) != 0)\n\t\tgoto out;\n\n\t \n\tswitch (kex->kex_type) {\n#ifdef WITH_OPENSSL\n\tcase KEX_DH_GRP1_SHA1:\n\tcase KEX_DH_GRP14_SHA1:\n\tcase KEX_DH_GRP14_SHA256:\n\tcase KEX_DH_GRP16_SHA512:\n\tcase KEX_DH_GRP18_SHA512:\n\t\tr = kex_dh_dec(kex, server_blob, &shared_secret);\n\t\tbreak;\n\tcase KEX_ECDH_SHA2:\n\t\tr = kex_ecdh_dec(kex, server_blob, &shared_secret);\n\t\tbreak;\n#endif\n\tcase KEX_C25519_SHA256:\n\t\tr = kex_c25519_dec(kex, server_blob, &shared_secret);\n\t\tbreak;\n\tcase KEX_KEM_SNTRUP761X25519_SHA512:\n\t\tr = kex_kem_sntrup761x25519_dec(kex, server_blob,\n\t\t    &shared_secret);\n\t\tbreak;\n\tdefault:\n\t\tr = SSH_ERR_INVALID_ARGUMENT;\n\t\tbreak;\n\t}\n\tif (r !=0 )\n\t\tgoto out;\n\n\t \n\thashlen = sizeof(hash);\n\tif ((r = kex_gen_hash(\n\t    kex->hash_alg,\n\t    kex->client_version,\n\t    kex->server_version,\n\t    kex->my,\n\t    kex->peer,\n\t    server_host_key_blob,\n\t    kex->client_pub,\n\t    server_blob,\n\t    shared_secret,\n\t    hash, &hashlen)) != 0)\n\t\tgoto out;\n\n\tif ((r = sshkey_verify(server_host_key, signature, slen, hash, hashlen,\n\t    kex->hostkey_alg, ssh->compat, NULL)) != 0)\n\t\tgoto out;\n\n\tif ((r = kex_derive_keys(ssh, hash, hashlen, shared_secret)) != 0 ||\n\t    (r = kex_send_newkeys(ssh)) != 0)\n\t\tgoto out;\n\n\t \n\tif ((kex->flags & KEX_INITIAL) != 0) {\n\t\tif (kex->initial_hostkey != NULL || kex->initial_sig != NULL) {\n\t\t\tr = SSH_ERR_INTERNAL_ERROR;\n\t\t\tgoto out;\n\t\t}\n\t\tif ((kex->initial_sig = sshbuf_new()) == NULL) {\n\t\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\t\tgoto out;\n\t\t}\n\t\tif ((r = sshbuf_put(kex->initial_sig, signature, slen)) != 0)\n\t\t\tgoto out;\n\t\tkex->initial_hostkey = server_host_key;\n\t\tserver_host_key = NULL;\n\t}\n\t \nout:\n\texplicit_bzero(hash, sizeof(hash));\n\texplicit_bzero(kex->c25519_client_key, sizeof(kex->c25519_client_key));\n\texplicit_bzero(kex->sntrup761_client_key,\n\t    sizeof(kex->sntrup761_client_key));\n\tsshbuf_free(server_host_key_blob);\n\tfree(signature);\n\tsshbuf_free(tmp);\n\tsshkey_free(server_host_key);\n\tsshbuf_free(server_blob);\n\tsshbuf_free(shared_secret);\n\tsshbuf_free(kex->client_pub);\n\tkex->client_pub = NULL;\n\treturn r;\n}\n\nint\nkex_gen_server(struct ssh *ssh)\n{\n\tdebug(\"expecting SSH2_MSG_KEX_ECDH_INIT\");\n\tssh_dispatch_set(ssh, SSH2_MSG_KEX_ECDH_INIT, &input_kex_gen_init);\n\treturn 0;\n}\n\nstatic int\ninput_kex_gen_init(int type, u_int32_t seq, struct ssh *ssh)\n{\n\tstruct kex *kex = ssh->kex;\n\tstruct sshkey *server_host_private, *server_host_public;\n\tstruct sshbuf *shared_secret = NULL;\n\tstruct sshbuf *server_pubkey = NULL;\n\tstruct sshbuf *client_pubkey = NULL;\n\tstruct sshbuf *server_host_key_blob = NULL;\n\tu_char *signature = NULL, hash[SSH_DIGEST_MAX_LENGTH];\n\tsize_t slen, hashlen;\n\tint r;\n\n\tdebug(\"SSH2_MSG_KEX_ECDH_INIT received\");\n\tssh_dispatch_set(ssh, SSH2_MSG_KEX_ECDH_INIT, &kex_protocol_error);\n\n\tif ((r = kex_load_hostkey(ssh, &server_host_private,\n\t    &server_host_public)) != 0)\n\t\tgoto out;\n\n\tif ((r = sshpkt_getb_froms(ssh, &client_pubkey)) != 0 ||\n\t    (r = sshpkt_get_end(ssh)) != 0)\n\t\tgoto out;\n\n\t \n\tswitch (kex->kex_type) {\n#ifdef WITH_OPENSSL\n\tcase KEX_DH_GRP1_SHA1:\n\tcase KEX_DH_GRP14_SHA1:\n\tcase KEX_DH_GRP14_SHA256:\n\tcase KEX_DH_GRP16_SHA512:\n\tcase KEX_DH_GRP18_SHA512:\n\t\tr = kex_dh_enc(kex, client_pubkey, &server_pubkey,\n\t\t    &shared_secret);\n\t\tbreak;\n\tcase KEX_ECDH_SHA2:\n\t\tr = kex_ecdh_enc(kex, client_pubkey, &server_pubkey,\n\t\t    &shared_secret);\n\t\tbreak;\n#endif\n\tcase KEX_C25519_SHA256:\n\t\tr = kex_c25519_enc(kex, client_pubkey, &server_pubkey,\n\t\t    &shared_secret);\n\t\tbreak;\n\tcase KEX_KEM_SNTRUP761X25519_SHA512:\n\t\tr = kex_kem_sntrup761x25519_enc(kex, client_pubkey,\n\t\t    &server_pubkey, &shared_secret);\n\t\tbreak;\n\tdefault:\n\t\tr = SSH_ERR_INVALID_ARGUMENT;\n\t\tbreak;\n\t}\n\tif (r !=0 )\n\t\tgoto out;\n\n\t \n\tif ((server_host_key_blob = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = sshkey_putb(server_host_public, server_host_key_blob)) != 0)\n\t\tgoto out;\n\thashlen = sizeof(hash);\n\tif ((r = kex_gen_hash(\n\t    kex->hash_alg,\n\t    kex->client_version,\n\t    kex->server_version,\n\t    kex->peer,\n\t    kex->my,\n\t    server_host_key_blob,\n\t    client_pubkey,\n\t    server_pubkey,\n\t    shared_secret,\n\t    hash, &hashlen)) != 0)\n\t\tgoto out;\n\n\t \n\tif ((r = kex->sign(ssh, server_host_private, server_host_public,\n\t    &signature, &slen, hash, hashlen, kex->hostkey_alg)) != 0)\n\t\tgoto out;\n\n\t \n\tif ((r = sshpkt_start(ssh, SSH2_MSG_KEX_ECDH_REPLY)) != 0 ||\n\t    (r = sshpkt_put_stringb(ssh, server_host_key_blob)) != 0 ||\n\t    (r = sshpkt_put_stringb(ssh, server_pubkey)) != 0 ||\n\t    (r = sshpkt_put_string(ssh, signature, slen)) != 0 ||\n\t    (r = sshpkt_send(ssh)) != 0)\n\t\tgoto out;\n\n\tif ((r = kex_derive_keys(ssh, hash, hashlen, shared_secret)) != 0 ||\n\t    (r = kex_send_newkeys(ssh)) != 0)\n\t\tgoto out;\n\t \n\tif (kex->initial_hostkey == NULL &&\n\t    (r = sshkey_from_private(server_host_public,\n\t    &kex->initial_hostkey)) != 0)\n\t\tgoto out;\n\t \nout:\n\texplicit_bzero(hash, sizeof(hash));\n\tsshbuf_free(server_host_key_blob);\n\tfree(signature);\n\tsshbuf_free(shared_secret);\n\tsshbuf_free(client_pubkey);\n\tsshbuf_free(server_pubkey);\n\treturn r;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}