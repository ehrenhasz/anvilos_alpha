{
  "module_name": "sftp-glob.c",
  "hash_id": "570e615e1d82046f5b5d4e05afb956a765674e40733c012c83fa120a543d5528",
  "original_prompt": "Ingested from openssh-9.6p1/sftp-glob.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#ifdef HAVE_SYS_STAT_H\n# include <sys/stat.h>\n#endif\n\n#include <dirent.h>\n#include <stdlib.h>\n#include <string.h>\n#include <stdarg.h>\n\n#include \"xmalloc.h\"\n#include \"sftp.h\"\n#include \"sftp-common.h\"\n#include \"sftp-client.h\"\n\nint sftp_glob(struct sftp_conn *, const char *, int,\n    int (*)(const char *, int), glob_t *);\n\nstruct SFTP_OPENDIR {\n\tSFTP_DIRENT **dir;\n\tint offset;\n};\n\nstatic struct {\n\tstruct sftp_conn *conn;\n} cur;\n\nstatic void *\nfudge_opendir(const char *path)\n{\n\tstruct SFTP_OPENDIR *r;\n\n\tr = xcalloc(1, sizeof(*r));\n\n\tif (sftp_readdir(cur.conn, path, &r->dir)) {\n\t\tfree(r);\n\t\treturn(NULL);\n\t}\n\n\tr->offset = 0;\n\n\treturn((void *)r);\n}\n\nstatic struct dirent *\nfudge_readdir(struct SFTP_OPENDIR *od)\n{\n\t \n\tstatic char buf[sizeof(struct dirent) + MAXPATHLEN];\n\tstruct dirent *ret = (struct dirent *)buf;\n#ifdef __GNU_LIBRARY__\n\tstatic int inum = 1;\n#endif  \n\n\tif (od->dir[od->offset] == NULL)\n\t\treturn(NULL);\n\n\tmemset(buf, 0, sizeof(buf));\n\n\t \n#ifdef BROKEN_ONE_BYTE_DIRENT_D_NAME\n\tstrlcpy(ret->d_name, od->dir[od->offset++]->filename, MAXPATHLEN);\n#else\n\tstrlcpy(ret->d_name, od->dir[od->offset++]->filename,\n\t    sizeof(ret->d_name));\n#endif\n#ifdef __GNU_LIBRARY__\n\t \n\tret->d_ino = inum++;\n\tif (!inum)\n\t\tinum = 1;\n#endif  \n\n\treturn(ret);\n}\n\nstatic void\nfudge_closedir(struct SFTP_OPENDIR *od)\n{\n\tsftp_free_dirents(od->dir);\n\tfree(od);\n}\n\nstatic int\nfudge_lstat(const char *path, struct stat *st)\n{\n\tAttrib a;\n\n\tif (sftp_lstat(cur.conn, path, 1, &a) != 0)\n\t\treturn -1;\n\n\tattrib_to_stat(&a, st);\n\n\treturn 0;\n}\n\nstatic int\nfudge_stat(const char *path, struct stat *st)\n{\n\tAttrib a;\n\n\tif (sftp_stat(cur.conn, path, 1, &a) != 0)\n\t\treturn -1;\n\n\tattrib_to_stat(&a, st);\n\n\treturn(0);\n}\n\nint\nsftp_glob(struct sftp_conn *conn, const char *pattern, int flags,\n    int (*errfunc)(const char *, int), glob_t *pglob)\n{\n\tint r;\n\tsize_t l;\n\tchar *s;\n\tstruct stat sb;\n\n\tpglob->gl_opendir = fudge_opendir;\n\tpglob->gl_readdir = (struct dirent *(*)(void *))fudge_readdir;\n\tpglob->gl_closedir = (void (*)(void *))fudge_closedir;\n\tpglob->gl_lstat = fudge_lstat;\n\tpglob->gl_stat = fudge_stat;\n\n\tmemset(&cur, 0, sizeof(cur));\n\tcur.conn = conn;\n\n\tif ((r = glob(pattern, flags | GLOB_ALTDIRFUNC, errfunc, pglob)) != 0)\n\t\treturn r;\n\t \n\tif ((flags & (GLOB_NOCHECK|GLOB_MARK)) == (GLOB_NOCHECK|GLOB_MARK) &&\n\t    pglob->gl_matchc == 0 && pglob->gl_offs == 0 &&\n\t    pglob->gl_pathc == 1 && (s = pglob->gl_pathv[0]) != NULL &&\n\t    (l = strlen(s)) > 0 && s[l-1] != '/') {\n\t\tif (fudge_stat(s, &sb) == 0 && S_ISDIR(sb.st_mode)) {\n\t\t\t \n\t\t\tif ((s = realloc(s, l + 2)) != NULL) {\n\t\t\t\tmemcpy(s + l, \"/\", 2);\n\t\t\t\tpglob->gl_pathv[0] = s;\n\t\t\t}\n\t\t}\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}