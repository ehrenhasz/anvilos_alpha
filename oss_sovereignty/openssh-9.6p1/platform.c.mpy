{
  "module_name": "platform.c",
  "hash_id": "73e574ada540acd8881af2f45e518aea823daf113144cba15ddda45c89110080",
  "original_prompt": "Ingested from openssh-9.6p1/platform.c",
  "human_readable_source": " \n\n#include \"includes.h\"\n\n#include <stdarg.h>\n#include <stdio.h>\n#include <string.h>\n#include <unistd.h>\n\n#include \"log.h\"\n#include \"misc.h\"\n#include \"servconf.h\"\n#include \"sshkey.h\"\n#include \"hostfile.h\"\n#include \"auth.h\"\n#include \"auth-pam.h\"\n#include \"platform.h\"\n\n#include \"openbsd-compat/openbsd-compat.h\"\n\nextern int use_privsep;\nextern ServerOptions options;\n\nvoid\nplatform_pre_listen(void)\n{\n#ifdef LINUX_OOM_ADJUST\n\t \n\toom_adjust_setup();\n#endif\n}\n\nvoid\nplatform_pre_fork(void)\n{\n#ifdef USE_SOLARIS_PROCESS_CONTRACTS\n\tsolaris_contract_pre_fork();\n#endif\n}\n\nvoid\nplatform_pre_restart(void)\n{\n#ifdef LINUX_OOM_ADJUST\n\toom_adjust_restore();\n#endif\n}\n\nvoid\nplatform_post_fork_parent(pid_t child_pid)\n{\n#ifdef USE_SOLARIS_PROCESS_CONTRACTS\n\tsolaris_contract_post_fork_parent(child_pid);\n#endif\n}\n\nvoid\nplatform_post_fork_child(void)\n{\n#ifdef USE_SOLARIS_PROCESS_CONTRACTS\n\tsolaris_contract_post_fork_child();\n#endif\n#ifdef LINUX_OOM_ADJUST\n\toom_adjust_restore();\n#endif\n}\n\n \nint\nplatform_privileged_uidswap(void)\n{\n#ifdef HAVE_CYGWIN\n\t \n\treturn 1;\n#else\n\treturn (getuid() == 0 || geteuid() == 0);\n#endif\n}\n\n \nvoid\nplatform_setusercontext(struct passwd *pw)\n{\n#ifdef WITH_SELINUX\n\t \n\t(void)ssh_selinux_enabled();\n#endif\n\n#ifdef USE_SOLARIS_PROJECTS\n\t \n\tif (!options.use_pam && (getuid() == 0 || geteuid() == 0))\n\t\tsolaris_set_default_project(pw);\n#endif\n\n#if defined(HAVE_LOGIN_CAP) && defined (__bsdi__)\n\tif (getuid() == 0 || geteuid() == 0)\n\t\tsetpgid(0, 0);\n# endif\n\n#if defined(HAVE_LOGIN_CAP) && defined(USE_PAM)\n\t \n\tif (getuid() == 0 || geteuid() == 0) {\n\t\tif (options.use_pam) {\n\t\t\tdo_pam_setcred(use_privsep);\n\t\t}\n\t}\n# endif  \n\n#if !defined(HAVE_LOGIN_CAP) && defined(HAVE_GETLUID) && defined(HAVE_SETLUID)\n\tif (getuid() == 0 || geteuid() == 0) {\n\t\t \n\t\tif (getluid() == -1 && setluid(pw->pw_uid) == -1)\n\t\t\terror(\"setluid: %s\", strerror(errno));\n\t}\n#endif\n}\n\n \nvoid\nplatform_setusercontext_post_groups(struct passwd *pw)\n{\n#if !defined(HAVE_LOGIN_CAP) && defined(USE_PAM)\n\t \n\tif (options.use_pam) {\n\t\tdo_pam_setcred(use_privsep);\n\t}\n#endif  \n\n#if !defined(HAVE_LOGIN_CAP) && (defined(WITH_IRIX_PROJECT) || \\\n    defined(WITH_IRIX_JOBS) || defined(WITH_IRIX_ARRAY))\n\tirix_setusercontext(pw);\n#endif  \n\n#ifdef _AIX\n\taix_usrinfo(pw);\n#endif  \n\n#ifdef HAVE_SETPCRED\n\t \n\t{\n\t\tchar **creds = NULL, *chroot_creds[] =\n\t\t    { \"REAL_USER=root\", NULL };\n\n\t\tif (options.chroot_directory != NULL &&\n\t\t    strcasecmp(options.chroot_directory, \"none\") != 0)\n\t\t\tcreds = chroot_creds;\n\n\t\tif (setpcred(pw->pw_name, creds) == -1)\n\t\t\tfatal(\"Failed to set process credentials\");\n\t}\n#endif  \n#ifdef WITH_SELINUX\n\tssh_selinux_setup_exec_context(pw->pw_name);\n#endif\n}\n\nchar *\nplatform_krb5_get_principal_name(const char *pw_name)\n{\n#ifdef USE_AIX_KRB_NAME\n\treturn aix_krb5_get_principal_name(pw_name);\n#else\n\treturn NULL;\n#endif\n}\n\n \nint\nplatform_locked_account(struct passwd *pw)\n{\n\tint locked = 0;\n\tchar *passwd = pw->pw_passwd;\n#ifdef USE_SHADOW\n\tstruct spwd *spw = NULL;\n#ifdef USE_LIBIAF\n\tchar *iaf_passwd = NULL;\n#endif\n\n\tspw = getspnam(pw->pw_name);\n#ifdef HAS_SHADOW_EXPIRE\n\tif (spw != NULL && auth_shadow_acctexpired(spw))\n\t\treturn 1;\n#endif  \n\n\tif (spw != NULL)\n#ifdef USE_LIBIAF\n\t\tiaf_passwd = passwd = get_iaf_password(pw);\n#else\n\t\tpasswd = spw->sp_pwdp;\n#endif  \n#endif\n\n\t \n\tif (passwd && *passwd) {\n#ifdef LOCKED_PASSWD_STRING\n\t\tif (strcmp(passwd, LOCKED_PASSWD_STRING) == 0)\n\t\t\tlocked = 1;\n#endif\n#ifdef LOCKED_PASSWD_PREFIX\n\t\tif (strncmp(passwd, LOCKED_PASSWD_PREFIX,\n\t\t    strlen(LOCKED_PASSWD_PREFIX)) == 0)\n\t\t\tlocked = 1;\n#endif\n#ifdef LOCKED_PASSWD_SUBSTR\n\t\tif (strstr(passwd, LOCKED_PASSWD_SUBSTR))\n\t\t\tlocked = 1;\n#endif\n\t}\n#ifdef USE_LIBIAF\n\tif (iaf_passwd != NULL)\n\t\tfreezero(iaf_passwd, strlen(iaf_passwd));\n#endif  \n\n\treturn locked;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}