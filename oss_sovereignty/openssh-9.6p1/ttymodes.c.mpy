{
  "module_name": "ttymodes.c",
  "hash_id": "9bc7e9bdb7fdac8384aeaa4be41b52df707f93ea564106f64d149bf0baa43414",
  "original_prompt": "Ingested from openssh-9.6p1/ttymodes.c",
  "human_readable_source": " \n \n\n \n\n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n\n#include <errno.h>\n#include <string.h>\n#include <termios.h>\n#include <stdarg.h>\n\n#include \"packet.h\"\n#include \"log.h\"\n#include \"compat.h\"\n#include \"sshbuf.h\"\n#include \"ssherr.h\"\n\n#define TTY_OP_END\t\t0\n \n#define TTY_OP_ISPEED\t128\n#define TTY_OP_OSPEED\t129\n\n \nstatic int\nspeed_to_baud(speed_t speed)\n{\n\tswitch (speed) {\n\tcase B0:\n\t\treturn 0;\n\tcase B50:\n\t\treturn 50;\n\tcase B75:\n\t\treturn 75;\n\tcase B110:\n\t\treturn 110;\n\tcase B134:\n\t\treturn 134;\n\tcase B150:\n\t\treturn 150;\n\tcase B200:\n\t\treturn 200;\n\tcase B300:\n\t\treturn 300;\n\tcase B600:\n\t\treturn 600;\n\tcase B1200:\n\t\treturn 1200;\n\tcase B1800:\n\t\treturn 1800;\n\tcase B2400:\n\t\treturn 2400;\n\tcase B4800:\n\t\treturn 4800;\n\tcase B9600:\n\t\treturn 9600;\n\n#ifdef B19200\n\tcase B19200:\n\t\treturn 19200;\n#else  \n#ifdef EXTA\n\tcase EXTA:\n\t\treturn 19200;\n#endif  \n#endif  \n\n#ifdef B38400\n\tcase B38400:\n\t\treturn 38400;\n#else  \n#ifdef EXTB\n\tcase EXTB:\n\t\treturn 38400;\n#endif  \n#endif  \n\n#ifdef B7200\n\tcase B7200:\n\t\treturn 7200;\n#endif  \n#ifdef B14400\n\tcase B14400:\n\t\treturn 14400;\n#endif  \n#ifdef B28800\n\tcase B28800:\n\t\treturn 28800;\n#endif  \n#ifdef B57600\n\tcase B57600:\n\t\treturn 57600;\n#endif  \n#ifdef B76800\n\tcase B76800:\n\t\treturn 76800;\n#endif  \n#ifdef B115200\n\tcase B115200:\n\t\treturn 115200;\n#endif  \n#ifdef B230400\n\tcase B230400:\n\t\treturn 230400;\n#endif  \n\tdefault:\n\t\treturn 9600;\n\t}\n}\n\n \nstatic speed_t\nbaud_to_speed(int baud)\n{\n\tswitch (baud) {\n\tcase 0:\n\t\treturn B0;\n\tcase 50:\n\t\treturn B50;\n\tcase 75:\n\t\treturn B75;\n\tcase 110:\n\t\treturn B110;\n\tcase 134:\n\t\treturn B134;\n\tcase 150:\n\t\treturn B150;\n\tcase 200:\n\t\treturn B200;\n\tcase 300:\n\t\treturn B300;\n\tcase 600:\n\t\treturn B600;\n\tcase 1200:\n\t\treturn B1200;\n\tcase 1800:\n\t\treturn B1800;\n\tcase 2400:\n\t\treturn B2400;\n\tcase 4800:\n\t\treturn B4800;\n\tcase 9600:\n\t\treturn B9600;\n\n#ifdef B19200\n\tcase 19200:\n\t\treturn B19200;\n#else  \n#ifdef EXTA\n\tcase 19200:\n\t\treturn EXTA;\n#endif  \n#endif  \n\n#ifdef B38400\n\tcase 38400:\n\t\treturn B38400;\n#else  \n#ifdef EXTB\n\tcase 38400:\n\t\treturn EXTB;\n#endif  \n#endif  \n\n#ifdef B7200\n\tcase 7200:\n\t\treturn B7200;\n#endif  \n#ifdef B14400\n\tcase 14400:\n\t\treturn B14400;\n#endif  \n#ifdef B28800\n\tcase 28800:\n\t\treturn B28800;\n#endif  \n#ifdef B57600\n\tcase 57600:\n\t\treturn B57600;\n#endif  \n#ifdef B76800\n\tcase 76800:\n\t\treturn B76800;\n#endif  \n#ifdef B115200\n\tcase 115200:\n\t\treturn B115200;\n#endif  \n#ifdef B230400\n\tcase 230400:\n\t\treturn B230400;\n#endif  \n\tdefault:\n\t\treturn B9600;\n\t}\n}\n\n \nstatic u_int\nspecial_char_encode(cc_t c)\n{\n#ifdef _POSIX_VDISABLE\n\tif (c == _POSIX_VDISABLE)\n\t\treturn 255;\n#endif  \n\treturn c;\n}\n\n \nstatic cc_t\nspecial_char_decode(u_int c)\n{\n#ifdef _POSIX_VDISABLE\n\tif (c == 255)\n\t\treturn _POSIX_VDISABLE;\n#endif  \n\treturn c;\n}\n\n \nvoid\nssh_tty_make_modes(struct ssh *ssh, int fd, struct termios *tiop)\n{\n\tstruct termios tio;\n\tstruct sshbuf *buf;\n\tint r, ibaud, obaud;\n\n\tif ((buf = sshbuf_new()) == NULL)\n\t\tfatal_f(\"sshbuf_new failed\");\n\n\tif (tiop == NULL) {\n\t\tif (fd == -1) {\n\t\t\tdebug_f(\"no fd or tio\");\n\t\t\tgoto end;\n\t\t}\n\t\tif (tcgetattr(fd, &tio) == -1) {\n\t\t\tlogit(\"tcgetattr: %.100s\", strerror(errno));\n\t\t\tgoto end;\n\t\t}\n\t} else\n\t\ttio = *tiop;\n\n\t \n\tobaud = speed_to_baud(cfgetospeed(&tio));\n\tibaud = speed_to_baud(cfgetispeed(&tio));\n\tif ((r = sshbuf_put_u8(buf, TTY_OP_OSPEED)) != 0 ||\n\t    (r = sshbuf_put_u32(buf, obaud)) != 0 ||\n\t    (r = sshbuf_put_u8(buf, TTY_OP_ISPEED)) != 0 ||\n\t    (r = sshbuf_put_u32(buf, ibaud)) != 0)\n\t\tfatal_fr(r, \"compose\");\n\n\t \n#define TTYCHAR(NAME, OP) \\\n\tif ((r = sshbuf_put_u8(buf, OP)) != 0 || \\\n\t    (r = sshbuf_put_u32(buf, \\\n\t    special_char_encode(tio.c_cc[NAME]))) != 0) \\\n\t\tfatal_fr(r, \"compose %s\", #NAME);\n\n#define SSH_TTYMODE_IUTF8 42   \n\n#define TTYMODE(NAME, FIELD, OP) \\\n\tif (OP == SSH_TTYMODE_IUTF8 && (ssh->compat & SSH_BUG_UTF8TTYMODE)) { \\\n\t\tdebug3_f(\"SSH_BUG_UTF8TTYMODE\"); \\\n\t} else if ((r = sshbuf_put_u8(buf, OP)) != 0 || \\\n\t    (r = sshbuf_put_u32(buf, ((tio.FIELD & NAME) != 0))) != 0) \\\n\t\tfatal_fr(r, \"compose %s\", #NAME);\n\n#include \"ttymodes.h\"\n\n#undef TTYCHAR\n#undef TTYMODE\n\nend:\n\t \n\tif ((r = sshbuf_put_u8(buf, TTY_OP_END)) != 0 ||\n\t    (r = sshpkt_put_stringb(ssh, buf)) != 0)\n\t\tfatal_fr(r, \"compose end\");\n\tsshbuf_free(buf);\n}\n\n \nvoid\nssh_tty_parse_modes(struct ssh *ssh, int fd)\n{\n\tstruct termios tio;\n\tstruct sshbuf *buf;\n\tconst u_char *data;\n\tu_char opcode;\n\tu_int baud, u;\n\tint r, failure = 0;\n\tsize_t len;\n\n\tif ((r = sshpkt_get_string_direct(ssh, &data, &len)) != 0)\n\t\tfatal_fr(r, \"parse\");\n\tif (len == 0)\n\t\treturn;\n\tif ((buf = sshbuf_from(data, len)) == NULL) {\n\t\terror_f(\"sshbuf_from failed\");\n\t\treturn;\n\t}\n\n\t \n\tif (tcgetattr(fd, &tio) == -1) {\n\t\tlogit(\"tcgetattr: %.100s\", strerror(errno));\n\t\tfailure = -1;\n\t}\n\n\twhile (sshbuf_len(buf) > 0) {\n\t\tif ((r = sshbuf_get_u8(buf, &opcode)) != 0)\n\t\t\tfatal_fr(r, \"parse opcode\");\n\t\tswitch (opcode) {\n\t\tcase TTY_OP_END:\n\t\t\tgoto set;\n\n\t\tcase TTY_OP_ISPEED:\n\t\t\tif ((r = sshbuf_get_u32(buf, &baud)) != 0)\n\t\t\t\tfatal_fr(r, \"parse ispeed\");\n\t\t\tif (failure != -1 &&\n\t\t\t    cfsetispeed(&tio, baud_to_speed(baud)) == -1)\n\t\t\t\terror(\"cfsetispeed failed for %d\", baud);\n\t\t\tbreak;\n\n\t\tcase TTY_OP_OSPEED:\n\t\t\tif ((r = sshbuf_get_u32(buf, &baud)) != 0)\n\t\t\t\tfatal_fr(r, \"parse ospeed\");\n\t\t\tif (failure != -1 &&\n\t\t\t    cfsetospeed(&tio, baud_to_speed(baud)) == -1)\n\t\t\t\terror(\"cfsetospeed failed for %d\", baud);\n\t\t\tbreak;\n\n#define TTYCHAR(NAME, OP) \\\n\t\tcase OP: \\\n\t\t\tif ((r = sshbuf_get_u32(buf, &u)) != 0) \\\n\t\t\t\tfatal_fr(r, \"parse %s\", #NAME); \\\n\t\t\ttio.c_cc[NAME] = special_char_decode(u); \\\n\t\t\tbreak;\n#define TTYMODE(NAME, FIELD, OP) \\\n\t\tcase OP: \\\n\t\t\tif ((r = sshbuf_get_u32(buf, &u)) != 0) \\\n\t\t\t\tfatal_fr(r, \"parse %s\", #NAME); \\\n\t\t\tif (u) \\\n\t\t\t\ttio.FIELD |= NAME; \\\n\t\t\telse \\\n\t\t\t\ttio.FIELD &= ~NAME; \\\n\t\t\tbreak;\n\n#include \"ttymodes.h\"\n\n#undef TTYCHAR\n#undef TTYMODE\n\n\t\tdefault:\n\t\t\tdebug(\"Ignoring unsupported tty mode opcode %d (0x%x)\",\n\t\t\t    opcode, opcode);\n\t\t\t \n\t\t\tif (opcode > 0 && opcode < 160) {\n\t\t\t\tif ((r = sshbuf_get_u32(buf, NULL)) != 0)\n\t\t\t\t\tfatal_fr(r, \"parse arg\");\n\t\t\t\tbreak;\n\t\t\t} else {\n\t\t\t\tlogit_f(\"unknown opcode %d\", opcode);\n\t\t\t\tgoto set;\n\t\t\t}\n\t\t}\n\t}\n\nset:\n\tlen = sshbuf_len(buf);\n\tsshbuf_free(buf);\n\tif (len > 0) {\n\t\tlogit_f(\"%zu bytes left\", len);\n\t\treturn;\t\t \n\t}\n\tif (failure == -1)\n\t\treturn;\t\t \n\n\t \n\tif (tcsetattr(fd, TCSANOW, &tio) == -1)\n\t\tlogit(\"Setting tty modes failed: %.100s\", strerror(errno));\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}