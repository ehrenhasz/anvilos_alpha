{
  "module_name": "authfd.c",
  "hash_id": "fb90441c11e80fe86dca8416c9f656ad82e7247b5bdbefda305fdbb38b9b4452",
  "original_prompt": "Ingested from openssh-9.6p1/authfd.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <sys/un.h>\n#include <sys/socket.h>\n\n#include <fcntl.h>\n#include <stdlib.h>\n#include <signal.h>\n#include <string.h>\n#include <stdarg.h>\n#include <unistd.h>\n#include <errno.h>\n\n#include \"xmalloc.h\"\n#include \"ssh.h\"\n#include \"sshbuf.h\"\n#include \"sshkey.h\"\n#include \"authfd.h\"\n#include \"cipher.h\"\n#include \"log.h\"\n#include \"atomicio.h\"\n#include \"misc.h\"\n#include \"ssherr.h\"\n\n#define MAX_AGENT_IDENTITIES\t2048\t\t \n#define MAX_AGENT_REPLY_LEN\t(256 * 1024)\t \n\n \n#define agent_failed(x) \\\n    ((x == SSH_AGENT_FAILURE) || \\\n    (x == SSH_COM_AGENT2_FAILURE) || \\\n    (x == SSH2_AGENT_FAILURE))\n\n \nstatic int\ndecode_reply(u_char type)\n{\n\tif (agent_failed(type))\n\t\treturn SSH_ERR_AGENT_FAILURE;\n\telse if (type == SSH_AGENT_SUCCESS)\n\t\treturn 0;\n\telse\n\t\treturn SSH_ERR_INVALID_FORMAT;\n}\n\n \nint\nssh_get_authentication_socket_path(const char *authsocket, int *fdp)\n{\n\tint sock, oerrno;\n\tstruct sockaddr_un sunaddr;\n\n\tdebug3_f(\"path '%s'\", authsocket);\n\tmemset(&sunaddr, 0, sizeof(sunaddr));\n\tsunaddr.sun_family = AF_UNIX;\n\tstrlcpy(sunaddr.sun_path, authsocket, sizeof(sunaddr.sun_path));\n\n\tif ((sock = socket(AF_UNIX, SOCK_STREAM, 0)) == -1)\n\t\treturn SSH_ERR_SYSTEM_ERROR;\n\n\t \n\tif (fcntl(sock, F_SETFD, FD_CLOEXEC) == -1 ||\n\t    connect(sock, (struct sockaddr *)&sunaddr, sizeof(sunaddr)) == -1) {\n\t\toerrno = errno;\n\t\tclose(sock);\n\t\terrno = oerrno;\n\t\treturn SSH_ERR_SYSTEM_ERROR;\n\t}\n\tif (fdp != NULL)\n\t\t*fdp = sock;\n\telse\n\t\tclose(sock);\n\treturn 0;\n}\n\n \nint\nssh_get_authentication_socket(int *fdp)\n{\n\tconst char *authsocket;\n\n\tif (fdp != NULL)\n\t\t*fdp = -1;\n\n\tauthsocket = getenv(SSH_AUTHSOCKET_ENV_NAME);\n\tif (authsocket == NULL || *authsocket == '\\0')\n\t\treturn SSH_ERR_AGENT_NOT_PRESENT;\n\n\treturn ssh_get_authentication_socket_path(authsocket, fdp);\n}\n\n \nstatic int\nssh_request_reply(int sock, struct sshbuf *request, struct sshbuf *reply)\n{\n\tint r;\n\tsize_t l, len;\n\tchar buf[1024];\n\n\t \n\tlen = sshbuf_len(request);\n\tPOKE_U32(buf, len);\n\n\t \n\tif (atomicio(vwrite, sock, buf, 4) != 4 ||\n\t    atomicio(vwrite, sock, sshbuf_mutable_ptr(request),\n\t    sshbuf_len(request)) != sshbuf_len(request))\n\t\treturn SSH_ERR_AGENT_COMMUNICATION;\n\t \n\tif (atomicio(read, sock, buf, 4) != 4)\n\t    return SSH_ERR_AGENT_COMMUNICATION;\n\n\t \n\tlen = PEEK_U32(buf);\n\tif (len > MAX_AGENT_REPLY_LEN)\n\t\treturn SSH_ERR_INVALID_FORMAT;\n\n\t \n\tsshbuf_reset(reply);\n\twhile (len > 0) {\n\t\tl = len;\n\t\tif (l > sizeof(buf))\n\t\t\tl = sizeof(buf);\n\t\tif (atomicio(read, sock, buf, l) != l)\n\t\t\treturn SSH_ERR_AGENT_COMMUNICATION;\n\t\tif ((r = sshbuf_put(reply, buf, l)) != 0)\n\t\t\treturn r;\n\t\tlen -= l;\n\t}\n\treturn 0;\n}\n\n \nstatic int\nssh_request_reply_decode(int sock, struct sshbuf *request)\n{\n\tstruct sshbuf *reply;\n\tint r;\n\tu_char type;\n\n\tif ((reply = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = ssh_request_reply(sock, request, reply)) != 0 ||\n\t    (r = sshbuf_get_u8(reply, &type)) != 0 ||\n\t    (r = decode_reply(type)) != 0)\n\t\tgoto out;\n\t \n\tr = 0;\n out:\n\tsshbuf_free(reply);\n\treturn r;\n}\n\n \nvoid\nssh_close_authentication_socket(int sock)\n{\n\tif (getenv(SSH_AUTHSOCKET_ENV_NAME))\n\t\tclose(sock);\n}\n\n \nint\nssh_lock_agent(int sock, int lock, const char *password)\n{\n\tint r;\n\tu_char type = lock ? SSH_AGENTC_LOCK : SSH_AGENTC_UNLOCK;\n\tstruct sshbuf *msg;\n\n\tif ((msg = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_put_u8(msg, type)) != 0 ||\n\t    (r = sshbuf_put_cstring(msg, password)) != 0 ||\n\t    (r = ssh_request_reply_decode(sock, msg)) != 0)\n\t\tgoto out;\n\t \n\tr = 0;\n out:\n\tsshbuf_free(msg);\n\treturn r;\n}\n\n\nstatic int\ndeserialise_identity2(struct sshbuf *ids, struct sshkey **keyp, char **commentp)\n{\n\tint r;\n\tchar *comment = NULL;\n\tconst u_char *blob;\n\tsize_t blen;\n\n\tif ((r = sshbuf_get_string_direct(ids, &blob, &blen)) != 0 ||\n\t    (r = sshbuf_get_cstring(ids, &comment, NULL)) != 0)\n\t\tgoto out;\n\tif ((r = sshkey_from_blob(blob, blen, keyp)) != 0)\n\t\tgoto out;\n\tif (commentp != NULL) {\n\t\t*commentp = comment;\n\t\tcomment = NULL;\n\t}\n\tr = 0;\n out:\n\tfree(comment);\n\treturn r;\n}\n\n \nint\nssh_fetch_identitylist(int sock, struct ssh_identitylist **idlp)\n{\n\tu_char type;\n\tu_int32_t num, i;\n\tstruct sshbuf *msg;\n\tstruct ssh_identitylist *idl = NULL;\n\tint r;\n\n\t \n\tif ((msg = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_put_u8(msg, SSH2_AGENTC_REQUEST_IDENTITIES)) != 0)\n\t\tgoto out;\n\n\tif ((r = ssh_request_reply(sock, msg, msg)) != 0)\n\t\tgoto out;\n\n\t \n\tif ((r = sshbuf_get_u8(msg, &type)) != 0)\n\t\tgoto out;\n\tif (agent_failed(type)) {\n\t\tr = SSH_ERR_AGENT_FAILURE;\n\t\tgoto out;\n\t} else if (type != SSH2_AGENT_IDENTITIES_ANSWER) {\n\t\tr = SSH_ERR_INVALID_FORMAT;\n\t\tgoto out;\n\t}\n\n\t \n\tif ((r = sshbuf_get_u32(msg, &num)) != 0)\n\t\tgoto out;\n\tif (num > MAX_AGENT_IDENTITIES) {\n\t\tr = SSH_ERR_INVALID_FORMAT;\n\t\tgoto out;\n\t}\n\tif (num == 0) {\n\t\tr = SSH_ERR_AGENT_NO_IDENTITIES;\n\t\tgoto out;\n\t}\n\n\t \n\tif ((idl = calloc(1, sizeof(*idl))) == NULL ||\n\t    (idl->keys = calloc(num, sizeof(*idl->keys))) == NULL ||\n\t    (idl->comments = calloc(num, sizeof(*idl->comments))) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tfor (i = 0; i < num;) {\n\t\tif ((r = deserialise_identity2(msg, &(idl->keys[i]),\n\t\t    &(idl->comments[i]))) != 0) {\n\t\t\tif (r == SSH_ERR_KEY_TYPE_UNKNOWN) {\n\t\t\t\t \n\t\t\t\tnum--;\n\t\t\t\tcontinue;\n\t\t\t} else\n\t\t\t\tgoto out;\n\t\t}\n\t\ti++;\n\t}\n\tidl->nkeys = num;\n\t*idlp = idl;\n\tidl = NULL;\n\tr = 0;\n out:\n\tsshbuf_free(msg);\n\tif (idl != NULL)\n\t\tssh_free_identitylist(idl);\n\treturn r;\n}\n\nvoid\nssh_free_identitylist(struct ssh_identitylist *idl)\n{\n\tsize_t i;\n\n\tif (idl == NULL)\n\t\treturn;\n\tfor (i = 0; i < idl->nkeys; i++) {\n\t\tif (idl->keys != NULL)\n\t\t\tsshkey_free(idl->keys[i]);\n\t\tif (idl->comments != NULL)\n\t\t\tfree(idl->comments[i]);\n\t}\n\tfree(idl->keys);\n\tfree(idl->comments);\n\tfree(idl);\n}\n\n \nint\nssh_agent_has_key(int sock, const struct sshkey *key)\n{\n\tint r, ret = SSH_ERR_KEY_NOT_FOUND;\n\tsize_t i;\n\tstruct ssh_identitylist *idlist = NULL;\n\n\tif ((r = ssh_fetch_identitylist(sock, &idlist)) != 0) {\n\t\treturn r;\n\t}\n\n\tfor (i = 0; i < idlist->nkeys; i++) {\n\t\tif (sshkey_equal_public(idlist->keys[i], key)) {\n\t\t\tret = 0;\n\t\t\tbreak;\n\t\t}\n\t}\n\n\tssh_free_identitylist(idlist);\n\treturn ret;\n}\n\n \n\n\n \nstatic u_int\nagent_encode_alg(const struct sshkey *key, const char *alg)\n{\n\tif (alg != NULL && sshkey_type_plain(key->type) == KEY_RSA) {\n\t\tif (strcmp(alg, \"rsa-sha2-256\") == 0 ||\n\t\t    strcmp(alg, \"rsa-sha2-256-cert-v01@openssh.com\") == 0)\n\t\t\treturn SSH_AGENT_RSA_SHA2_256;\n\t\tif (strcmp(alg, \"rsa-sha2-512\") == 0 ||\n\t\t    strcmp(alg, \"rsa-sha2-512-cert-v01@openssh.com\") == 0)\n\t\t\treturn SSH_AGENT_RSA_SHA2_512;\n\t}\n\treturn 0;\n}\n\n \nint\nssh_agent_sign(int sock, const struct sshkey *key,\n    u_char **sigp, size_t *lenp,\n    const u_char *data, size_t datalen, const char *alg, u_int compat)\n{\n\tstruct sshbuf *msg;\n\tu_char *sig = NULL, type = 0;\n\tsize_t len = 0;\n\tu_int flags = 0;\n\tint r = SSH_ERR_INTERNAL_ERROR;\n\n\t*sigp = NULL;\n\t*lenp = 0;\n\n\tif (datalen > SSH_KEY_MAX_SIGN_DATA_SIZE)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tif ((msg = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tflags |= agent_encode_alg(key, alg);\n\tif ((r = sshbuf_put_u8(msg, SSH2_AGENTC_SIGN_REQUEST)) != 0 ||\n\t    (r = sshkey_puts(key, msg)) != 0 ||\n\t    (r = sshbuf_put_string(msg, data, datalen)) != 0 ||\n\t    (r = sshbuf_put_u32(msg, flags)) != 0)\n\t\tgoto out;\n\tif ((r = ssh_request_reply(sock, msg, msg)) != 0)\n\t\tgoto out;\n\tif ((r = sshbuf_get_u8(msg, &type)) != 0)\n\t\tgoto out;\n\tif (agent_failed(type)) {\n\t\tr = SSH_ERR_AGENT_FAILURE;\n\t\tgoto out;\n\t} else if (type != SSH2_AGENT_SIGN_RESPONSE) {\n\t\tr = SSH_ERR_INVALID_FORMAT;\n\t\tgoto out;\n\t}\n\tif ((r = sshbuf_get_string(msg, &sig, &len)) != 0)\n\t\tgoto out;\n\t \n\tif ((r = sshkey_check_sigtype(sig, len, alg)) != 0)\n\t\tgoto out;\n\t \n\t*sigp = sig;\n\t*lenp = len;\n\tsig = NULL;\n\tlen = 0;\n\tr = 0;\n out:\n\tfreezero(sig, len);\n\tsshbuf_free(msg);\n\treturn r;\n}\n\n \n\nstatic int\nencode_dest_constraint_hop(struct sshbuf *m,\n    const struct dest_constraint_hop *dch)\n{\n\tstruct sshbuf *b;\n\tu_int i;\n\tint r;\n\n\tif ((b = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_put_cstring(b, dch->user)) != 0 ||\n\t    (r = sshbuf_put_cstring(b, dch->hostname)) != 0 ||\n\t    (r = sshbuf_put_string(b, NULL, 0)) != 0)  \n\t\tgoto out;\n\tfor (i = 0; i < dch->nkeys; i++) {\n\t\tif ((r = sshkey_puts(dch->keys[i], b)) != 0 ||\n\t\t    (r = sshbuf_put_u8(b, dch->key_is_ca[i] != 0)) != 0)\n\t\t\tgoto out;\n\t}\n\tif ((r = sshbuf_put_stringb(m, b)) != 0)\n\t\tgoto out;\n\t \n\tr = 0;\n out:\n\tsshbuf_free(b);\n\treturn r;\n}\n\nstatic int\nencode_dest_constraint(struct sshbuf *m, const struct dest_constraint *dc)\n{\n\tstruct sshbuf *b;\n\tint r;\n\n\tif ((b = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = encode_dest_constraint_hop(b, &dc->from)) != 0 ||\n\t    (r = encode_dest_constraint_hop(b, &dc->to)) != 0 ||\n\t    (r = sshbuf_put_string(b, NULL, 0)) != 0)  \n\t\tgoto out;\n\tif ((r = sshbuf_put_stringb(m, b)) != 0)\n\t\tgoto out;\n\t \n\tr = 0;\n out:\n\tsshbuf_free(b);\n\treturn r;\n}\n\nstatic int\nencode_constraints(struct sshbuf *m, u_int life, u_int confirm,\n    u_int maxsign, const char *provider,\n    struct dest_constraint **dest_constraints, size_t ndest_constraints,\n    int cert_only, struct sshkey **certs, size_t ncerts)\n{\n\tint r;\n\tstruct sshbuf *b = NULL;\n\tsize_t i;\n\n\tif (life != 0) {\n\t\tif ((r = sshbuf_put_u8(m, SSH_AGENT_CONSTRAIN_LIFETIME)) != 0 ||\n\t\t    (r = sshbuf_put_u32(m, life)) != 0)\n\t\t\tgoto out;\n\t}\n\tif (confirm != 0) {\n\t\tif ((r = sshbuf_put_u8(m, SSH_AGENT_CONSTRAIN_CONFIRM)) != 0)\n\t\t\tgoto out;\n\t}\n\tif (maxsign != 0) {\n\t\tif ((r = sshbuf_put_u8(m, SSH_AGENT_CONSTRAIN_MAXSIGN)) != 0 ||\n\t\t    (r = sshbuf_put_u32(m, maxsign)) != 0)\n\t\t\tgoto out;\n\t}\n\tif (provider != NULL) {\n\t\tif ((r = sshbuf_put_u8(m,\n\t\t    SSH_AGENT_CONSTRAIN_EXTENSION)) != 0 ||\n\t\t    (r = sshbuf_put_cstring(m,\n\t\t    \"sk-provider@openssh.com\")) != 0 ||\n\t\t    (r = sshbuf_put_cstring(m, provider)) != 0)\n\t\t\tgoto out;\n\t}\n\tif (dest_constraints != NULL && ndest_constraints > 0) {\n\t\tif ((b = sshbuf_new()) == NULL) {\n\t\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\t\tgoto out;\n\t\t}\n\t\tfor (i = 0; i < ndest_constraints; i++) {\n\t\t\tif ((r = encode_dest_constraint(b,\n\t\t\t    dest_constraints[i])) != 0)\n\t\t\t\tgoto out;\n\t\t}\n\t\tif ((r = sshbuf_put_u8(m,\n\t\t    SSH_AGENT_CONSTRAIN_EXTENSION)) != 0 ||\n\t\t    (r = sshbuf_put_cstring(m,\n\t\t    \"restrict-destination-v00@openssh.com\")) != 0 ||\n\t\t    (r = sshbuf_put_stringb(m, b)) != 0)\n\t\t\tgoto out;\n\t\tsshbuf_free(b);\n\t\tb = NULL;\n\t}\n\tif (ncerts != 0) {\n\t\tif ((b = sshbuf_new()) == NULL) {\n\t\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\t\tgoto out;\n\t\t}\n\t\tfor (i = 0; i < ncerts; i++) {\n\t\t\tif ((r = sshkey_puts(certs[i], b)) != 0)\n\t\t\t\tgoto out;\n\t\t}\n\t\tif ((r = sshbuf_put_u8(m,\n\t\t    SSH_AGENT_CONSTRAIN_EXTENSION)) != 0 ||\n\t\t    (r = sshbuf_put_cstring(m,\n\t\t    \"associated-certs-v00@openssh.com\")) != 0 ||\n\t\t    (r = sshbuf_put_u8(m, cert_only != 0)) != 0 ||\n\t\t    (r = sshbuf_put_stringb(m, b)) != 0)\n\t\t\tgoto out;\n\t\tsshbuf_free(b);\n\t\tb = NULL;\n\t}\n\tr = 0;\n out:\n\tsshbuf_free(b);\n\treturn r;\n}\n\n \nint\nssh_add_identity_constrained(int sock, struct sshkey *key,\n    const char *comment, u_int life, u_int confirm, u_int maxsign,\n    const char *provider, struct dest_constraint **dest_constraints,\n    size_t ndest_constraints)\n{\n\tstruct sshbuf *msg;\n\tint r, constrained = (life || confirm || maxsign ||\n\t    provider || dest_constraints);\n\tu_char type;\n\n\tif ((msg = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\n\tswitch (key->type) {\n#ifdef WITH_OPENSSL\n\tcase KEY_RSA:\n\tcase KEY_RSA_CERT:\n\tcase KEY_DSA:\n\tcase KEY_DSA_CERT:\n\tcase KEY_ECDSA:\n\tcase KEY_ECDSA_CERT:\n\tcase KEY_ECDSA_SK:\n\tcase KEY_ECDSA_SK_CERT:\n#endif\n\tcase KEY_ED25519:\n\tcase KEY_ED25519_CERT:\n\tcase KEY_ED25519_SK:\n\tcase KEY_ED25519_SK_CERT:\n\tcase KEY_XMSS:\n\tcase KEY_XMSS_CERT:\n\t\ttype = constrained ?\n\t\t    SSH2_AGENTC_ADD_ID_CONSTRAINED :\n\t\t    SSH2_AGENTC_ADD_IDENTITY;\n\t\tif ((r = sshbuf_put_u8(msg, type)) != 0 ||\n\t\t    (r = sshkey_private_serialize_maxsign(key, msg, maxsign,\n\t\t    0)) != 0 ||\n\t\t    (r = sshbuf_put_cstring(msg, comment)) != 0)\n\t\t\tgoto out;\n\t\tbreak;\n\tdefault:\n\t\tr = SSH_ERR_INVALID_ARGUMENT;\n\t\tgoto out;\n\t}\n\tif (constrained &&\n\t    (r = encode_constraints(msg, life, confirm, maxsign,\n\t    provider, dest_constraints, ndest_constraints, 0, NULL, 0)) != 0)\n\t\tgoto out;\n\tif ((r = ssh_request_reply_decode(sock, msg)) != 0)\n\t\tgoto out;\n\t \n\tr = 0;\n out:\n\tsshbuf_free(msg);\n\treturn r;\n}\n\n \nint\nssh_remove_identity(int sock, const struct sshkey *key)\n{\n\tstruct sshbuf *msg;\n\tint r;\n\tu_char *blob = NULL;\n\tsize_t blen;\n\n\tif ((msg = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\n\tif (key->type != KEY_UNSPEC) {\n\t\tif ((r = sshkey_to_blob(key, &blob, &blen)) != 0)\n\t\t\tgoto out;\n\t\tif ((r = sshbuf_put_u8(msg,\n\t\t    SSH2_AGENTC_REMOVE_IDENTITY)) != 0 ||\n\t\t    (r = sshbuf_put_string(msg, blob, blen)) != 0)\n\t\t\tgoto out;\n\t} else {\n\t\tr = SSH_ERR_INVALID_ARGUMENT;\n\t\tgoto out;\n\t}\n\tif ((r = ssh_request_reply_decode(sock, msg)) != 0)\n\t\tgoto out;\n\t \n\tr = 0;\n out:\n\tif (blob != NULL)\n\t\tfreezero(blob, blen);\n\tsshbuf_free(msg);\n\treturn r;\n}\n\n \nint\nssh_update_card(int sock, int add, const char *reader_id, const char *pin,\n    u_int life, u_int confirm,\n    struct dest_constraint **dest_constraints, size_t ndest_constraints,\n    int cert_only, struct sshkey **certs, size_t ncerts)\n{\n\tstruct sshbuf *msg;\n\tint r, constrained = (life || confirm || dest_constraints || certs);\n\tu_char type;\n\n\tif (add) {\n\t\ttype = constrained ?\n\t\t    SSH_AGENTC_ADD_SMARTCARD_KEY_CONSTRAINED :\n\t\t    SSH_AGENTC_ADD_SMARTCARD_KEY;\n\t} else\n\t\ttype = SSH_AGENTC_REMOVE_SMARTCARD_KEY;\n\n\tif ((msg = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_put_u8(msg, type)) != 0 ||\n\t    (r = sshbuf_put_cstring(msg, reader_id)) != 0 ||\n\t    (r = sshbuf_put_cstring(msg, pin)) != 0)\n\t\tgoto out;\n\tif (constrained &&\n\t    (r = encode_constraints(msg, life, confirm, 0, NULL,\n\t    dest_constraints, ndest_constraints,\n\t    cert_only, certs, ncerts)) != 0)\n\t\tgoto out;\n\tif ((r = ssh_request_reply_decode(sock, msg)) != 0)\n\t\tgoto out;\n\t \n\tr = 0;\n out:\n\tsshbuf_free(msg);\n\treturn r;\n}\n\n \nint\nssh_remove_all_identities(int sock, int version)\n{\n\tstruct sshbuf *msg;\n\tu_char type = (version == 1) ?\n\t    SSH_AGENTC_REMOVE_ALL_RSA_IDENTITIES :\n\t    SSH2_AGENTC_REMOVE_ALL_IDENTITIES;\n\tint r;\n\n\tif ((msg = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_put_u8(msg, type)) != 0)\n\t\tgoto out;\n\tif ((r = ssh_request_reply_decode(sock, msg)) != 0)\n\t\tgoto out;\n\t \n\tr = 0;\n out:\n\tsshbuf_free(msg);\n\treturn r;\n}\n\n \nint\nssh_agent_bind_hostkey(int sock, const struct sshkey *key,\n    const struct sshbuf *session_id, const struct sshbuf *signature,\n    int forwarding)\n{\n\tstruct sshbuf *msg;\n\tint r;\n\n\tif (key == NULL || session_id == NULL || signature == NULL)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tif ((msg = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_put_u8(msg, SSH_AGENTC_EXTENSION)) != 0 ||\n\t    (r = sshbuf_put_cstring(msg, \"session-bind@openssh.com\")) != 0 ||\n\t    (r = sshkey_puts(key, msg)) != 0 ||\n\t    (r = sshbuf_put_stringb(msg, session_id)) != 0 ||\n\t    (r = sshbuf_put_stringb(msg, signature)) != 0 ||\n\t    (r = sshbuf_put_u8(msg, forwarding ? 1 : 0)) != 0)\n\t\tgoto out;\n\tif ((r = ssh_request_reply_decode(sock, msg)) != 0)\n\t\tgoto out;\n\t \n\tr = 0;\n out:\n\tsshbuf_free(msg);\n\treturn r;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}