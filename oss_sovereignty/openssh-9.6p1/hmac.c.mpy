{
  "module_name": "hmac.c",
  "hash_id": "1e97e38007398c063120f45ed3998854e140be85cc8aa4b45ed6d6023ff84201",
  "original_prompt": "Ingested from openssh-9.6p1/hmac.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n\n#include <stdlib.h>\n#include <string.h>\n\n#include \"sshbuf.h\"\n#include \"digest.h\"\n#include \"hmac.h\"\n\nstruct ssh_hmac_ctx {\n\tint\t\t\t alg;\n\tstruct ssh_digest_ctx\t*ictx;\n\tstruct ssh_digest_ctx\t*octx;\n\tstruct ssh_digest_ctx\t*digest;\n\tu_char\t\t\t*buf;\n\tsize_t\t\t\t buf_len;\n};\n\nsize_t\nssh_hmac_bytes(int alg)\n{\n\treturn ssh_digest_bytes(alg);\n}\n\nstruct ssh_hmac_ctx *\nssh_hmac_start(int alg)\n{\n\tstruct ssh_hmac_ctx\t*ret;\n\n\tif ((ret = calloc(1, sizeof(*ret))) == NULL)\n\t\treturn NULL;\n\tret->alg = alg;\n\tif ((ret->ictx = ssh_digest_start(alg)) == NULL ||\n\t    (ret->octx = ssh_digest_start(alg)) == NULL ||\n\t    (ret->digest = ssh_digest_start(alg)) == NULL)\n\t\tgoto fail;\n\tret->buf_len = ssh_digest_blocksize(ret->ictx);\n\tif ((ret->buf = calloc(1, ret->buf_len)) == NULL)\n\t\tgoto fail;\n\treturn ret;\nfail:\n\tssh_hmac_free(ret);\n\treturn NULL;\n}\n\nint\nssh_hmac_init(struct ssh_hmac_ctx *ctx, const void *key, size_t klen)\n{\n\tsize_t i;\n\n\t \n\tif (key != NULL) {\n\t\t \n\t\tif (klen <= ctx->buf_len)\n\t\t\tmemcpy(ctx->buf, key, klen);\n\t\telse if (ssh_digest_memory(ctx->alg, key, klen, ctx->buf,\n\t\t    ctx->buf_len) < 0)\n\t\t\treturn -1;\n\t\tfor (i = 0; i < ctx->buf_len; i++)\n\t\t\tctx->buf[i] ^= 0x36;\n\t\tif (ssh_digest_update(ctx->ictx, ctx->buf, ctx->buf_len) < 0)\n\t\t\treturn -1;\n\t\tfor (i = 0; i < ctx->buf_len; i++)\n\t\t\tctx->buf[i] ^= 0x36 ^ 0x5c;\n\t\tif (ssh_digest_update(ctx->octx, ctx->buf, ctx->buf_len) < 0)\n\t\t\treturn -1;\n\t\texplicit_bzero(ctx->buf, ctx->buf_len);\n\t}\n\t \n\tif (ssh_digest_copy_state(ctx->ictx, ctx->digest) < 0)\n\t\treturn -1;\n\treturn 0;\n}\n\nint\nssh_hmac_update(struct ssh_hmac_ctx *ctx, const void *m, size_t mlen)\n{\n\treturn ssh_digest_update(ctx->digest, m, mlen);\n}\n\nint\nssh_hmac_update_buffer(struct ssh_hmac_ctx *ctx, const struct sshbuf *b)\n{\n\treturn ssh_digest_update_buffer(ctx->digest, b);\n}\n\nint\nssh_hmac_final(struct ssh_hmac_ctx *ctx, u_char *d, size_t dlen)\n{\n\tsize_t len;\n\n\tlen = ssh_digest_bytes(ctx->alg);\n\tif (dlen < len ||\n\t    ssh_digest_final(ctx->digest, ctx->buf, len))\n\t\treturn -1;\n\t \n\tif (ssh_digest_copy_state(ctx->octx, ctx->digest) < 0 ||\n\t    ssh_digest_update(ctx->digest, ctx->buf, len) < 0 ||\n\t    ssh_digest_final(ctx->digest, d, dlen) < 0)\n\t\treturn -1;\n\treturn 0;\n}\n\nvoid\nssh_hmac_free(struct ssh_hmac_ctx *ctx)\n{\n\tif (ctx != NULL) {\n\t\tssh_digest_free(ctx->ictx);\n\t\tssh_digest_free(ctx->octx);\n\t\tssh_digest_free(ctx->digest);\n\t\tif (ctx->buf) {\n\t\t\texplicit_bzero(ctx->buf, ctx->buf_len);\n\t\t\tfree(ctx->buf);\n\t\t}\n\t\tfreezero(ctx, sizeof(*ctx));\n\t}\n}\n\n#ifdef TEST\n\n \nstatic void\nhmac_test(void *key, size_t klen, void *m, size_t mlen, u_char *e, size_t elen)\n{\n\tstruct ssh_hmac_ctx\t*ctx;\n\tsize_t\t\t\t i;\n\tu_char\t\t\t digest[16];\n\n\tif ((ctx = ssh_hmac_start(SSH_DIGEST_MD5)) == NULL)\n\t\tprintf(\"ssh_hmac_start failed\");\n\tif (ssh_hmac_init(ctx, key, klen) < 0 ||\n\t    ssh_hmac_update(ctx, m, mlen) < 0 ||\n\t    ssh_hmac_final(ctx, digest, sizeof(digest)) < 0)\n\t\tprintf(\"ssh_hmac_xxx failed\");\n\tssh_hmac_free(ctx);\n\n\tif (memcmp(e, digest, elen)) {\n\t\tfor (i = 0; i < elen; i++)\n\t\t\tprintf(\"[%zu] %2.2x %2.2x\\n\", i, e[i], digest[i]);\n\t\tprintf(\"mismatch\\n\");\n\t} else\n\t\tprintf(\"ok\\n\");\n}\n\nint\nmain(int argc, char **argv)\n{\n\t \n\n\tu_char key1[16] = {\n\t    0xb, 0xb, 0xb, 0xb, 0xb, 0xb, 0xb, 0xb,\n\t    0xb, 0xb, 0xb, 0xb, 0xb, 0xb, 0xb, 0xb };\n\tu_char *data1 = \"Hi There\";\n\tu_char dig1[16] = {\n\t    0x92, 0x94, 0x72, 0x7a, 0x36, 0x38, 0xbb, 0x1c,\n\t    0x13, 0xf4, 0x8e, 0xf8, 0x15, 0x8b, 0xfc, 0x9d };\n\n\tu_char *key2 = \"Jefe\";\n\tu_char *data2 = \"what do ya want for nothing?\";\n\tu_char dig2[16] = {\n\t    0x75, 0x0c, 0x78, 0x3e, 0x6a, 0xb0, 0xb5, 0x03,\n\t    0xea, 0xa8, 0x6e, 0x31, 0x0a, 0x5d, 0xb7, 0x38 };\n\n\tu_char key3[16];\n\tu_char data3[50];\n\tu_char dig3[16] = {\n\t    0x56, 0xbe, 0x34, 0x52, 0x1d, 0x14, 0x4c, 0x88,\n\t    0xdb, 0xb8, 0xc7, 0x33, 0xf0, 0xe8, 0xb3, 0xf6 };\n\tmemset(key3, 0xaa, sizeof(key3));\n\tmemset(data3, 0xdd, sizeof(data3));\n\n\thmac_test(key1, sizeof(key1), data1, strlen(data1), dig1, sizeof(dig1));\n\thmac_test(key2, strlen(key2), data2, strlen(data2), dig2, sizeof(dig2));\n\thmac_test(key3, sizeof(key3), data3, sizeof(data3), dig3, sizeof(dig3));\n\n\treturn 0;\n}\n\n#endif\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}