{
  "module_name": "auth-krb5.c",
  "hash_id": "6cc7b9c839361584d9ee1b353021448854b8247fffa0e067f63bcaf78b3c07f6",
  "original_prompt": "Ingested from openssh-9.6p1/auth-krb5.c",
  "human_readable_source": " \n \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <pwd.h>\n#include <stdarg.h>\n\n#include \"xmalloc.h\"\n#include \"ssh.h\"\n#include \"packet.h\"\n#include \"log.h\"\n#include \"sshbuf.h\"\n#include \"sshkey.h\"\n#include \"misc.h\"\n#include \"servconf.h\"\n#include \"uidswap.h\"\n#include \"hostfile.h\"\n#include \"auth.h\"\n\n#ifdef KRB5\n#include <errno.h>\n#include <unistd.h>\n#include <string.h>\n#include <krb5.h>\n\nextern ServerOptions\t options;\n\nstatic int\nkrb5_init(void *context)\n{\n\tAuthctxt *authctxt = (Authctxt *)context;\n\tkrb5_error_code problem;\n\n\tif (authctxt->krb5_ctx == NULL) {\n\t\tproblem = krb5_init_context(&authctxt->krb5_ctx);\n\t\tif (problem)\n\t\t\treturn (problem);\n\t}\n\treturn (0);\n}\n\nint\nauth_krb5_password(Authctxt *authctxt, const char *password)\n{\n#ifndef HEIMDAL\n\tkrb5_creds creds;\n\tkrb5_principal server;\n#endif\n\tkrb5_error_code problem;\n\tkrb5_ccache ccache = NULL;\n\tint len;\n\tchar *client, *platform_client;\n\tconst char *errmsg;\n\n\t \n\tplatform_client = platform_krb5_get_principal_name(authctxt->pw->pw_name);\n\tclient = platform_client ? platform_client : authctxt->pw->pw_name;\n\n\ttemporarily_use_uid(authctxt->pw);\n\n\tproblem = krb5_init(authctxt);\n\tif (problem)\n\t\tgoto out;\n\n\tproblem = krb5_parse_name(authctxt->krb5_ctx, client,\n\t\t    &authctxt->krb5_user);\n\tif (problem)\n\t\tgoto out;\n\n#ifdef HEIMDAL\n# ifdef HAVE_KRB5_CC_NEW_UNIQUE\n\tproblem = krb5_cc_new_unique(authctxt->krb5_ctx,\n\t    krb5_mcc_ops.prefix, NULL, &ccache);\n# else\n\tproblem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_mcc_ops, &ccache);\n# endif\n\tif (problem)\n\t\tgoto out;\n\n\tproblem = krb5_cc_initialize(authctxt->krb5_ctx, ccache,\n\t\tauthctxt->krb5_user);\n\tif (problem)\n\t\tgoto out;\n\n\trestore_uid();\n\n\tproblem = krb5_verify_user(authctxt->krb5_ctx, authctxt->krb5_user,\n\t    ccache, password, 1, NULL);\n\n\ttemporarily_use_uid(authctxt->pw);\n\n\tif (problem)\n\t\tgoto out;\n\n# ifdef HAVE_KRB5_CC_NEW_UNIQUE\n\tproblem = krb5_cc_new_unique(authctxt->krb5_ctx,\n\t    krb5_fcc_ops.prefix, NULL, &authctxt->krb5_fwd_ccache);\n# else\n\tproblem = krb5_cc_gen_new(authctxt->krb5_ctx, &krb5_fcc_ops,\n\t    &authctxt->krb5_fwd_ccache);\n# endif\n\tif (problem)\n\t\tgoto out;\n\n\tproblem = krb5_cc_copy_cache(authctxt->krb5_ctx, ccache,\n\t    authctxt->krb5_fwd_ccache);\n\tkrb5_cc_destroy(authctxt->krb5_ctx, ccache);\n\tccache = NULL;\n\tif (problem)\n\t\tgoto out;\n\n#else\n\tproblem = krb5_get_init_creds_password(authctxt->krb5_ctx, &creds,\n\t    authctxt->krb5_user, (char *)password, NULL, NULL, 0, NULL, NULL);\n\tif (problem)\n\t\tgoto out;\n\n\tproblem = krb5_sname_to_principal(authctxt->krb5_ctx, NULL, NULL,\n\t    KRB5_NT_SRV_HST, &server);\n\tif (problem)\n\t\tgoto out;\n\n\trestore_uid();\n\tproblem = krb5_verify_init_creds(authctxt->krb5_ctx, &creds, server,\n\t    NULL, NULL, NULL);\n\tkrb5_free_principal(authctxt->krb5_ctx, server);\n\ttemporarily_use_uid(authctxt->pw);\n\tif (problem)\n\t\tgoto out;\n\n\tif (!krb5_kuserok(authctxt->krb5_ctx, authctxt->krb5_user,\n\t    authctxt->pw->pw_name)) {\n\t\tproblem = -1;\n\t\tgoto out;\n\t}\n\n\tproblem = ssh_krb5_cc_gen(authctxt->krb5_ctx,\n\t    &authctxt->krb5_fwd_ccache);\n\tif (problem)\n\t\tgoto out;\n\n\tproblem = krb5_cc_initialize(authctxt->krb5_ctx,\n\t    authctxt->krb5_fwd_ccache, authctxt->krb5_user);\n\tif (problem)\n\t\tgoto out;\n\n\tproblem = krb5_cc_store_cred(authctxt->krb5_ctx,\n\t    authctxt->krb5_fwd_ccache, &creds);\n\tif (problem)\n\t\tgoto out;\n#endif\n\n\tauthctxt->krb5_ticket_file = (char *)krb5_cc_get_name(authctxt->krb5_ctx, authctxt->krb5_fwd_ccache);\n\n\tlen = strlen(authctxt->krb5_ticket_file) + 6;\n\tauthctxt->krb5_ccname = xmalloc(len);\n\tsnprintf(authctxt->krb5_ccname, len, \"FILE:%s\",\n\t    authctxt->krb5_ticket_file);\n\n#ifdef USE_PAM\n\tif (options.use_pam)\n\t\tdo_pam_putenv(\"KRB5CCNAME\", authctxt->krb5_ccname);\n#endif\n\n out:\n\trestore_uid();\n\t\n\tfree(platform_client);\n\n\tif (problem) {\n\t\tif (ccache)\n\t\t\tkrb5_cc_destroy(authctxt->krb5_ctx, ccache);\n\n\t\tif (authctxt->krb5_ctx != NULL && problem!=-1) {\n\t\t\terrmsg = krb5_get_error_message(authctxt->krb5_ctx,\n\t\t\t    problem);\n\t\t\tdebug(\"Kerberos password authentication failed: %s\",\n\t\t\t    errmsg);\n\t\t\tkrb5_free_error_message(authctxt->krb5_ctx, errmsg);\n\t\t} else\n\t\t\tdebug(\"Kerberos password authentication failed: %d\",\n\t\t\t    problem);\n\n\t\tkrb5_cleanup_proc(authctxt);\n\n\t\tif (options.kerberos_or_local_passwd)\n\t\t\treturn (-1);\n\t\telse\n\t\t\treturn (0);\n\t}\n\treturn (authctxt->valid ? 1 : 0);\n}\n\nvoid\nkrb5_cleanup_proc(Authctxt *authctxt)\n{\n\tdebug(\"krb5_cleanup_proc called\");\n\tif (authctxt->krb5_fwd_ccache) {\n\t\tkrb5_cc_destroy(authctxt->krb5_ctx, authctxt->krb5_fwd_ccache);\n\t\tauthctxt->krb5_fwd_ccache = NULL;\n\t}\n\tif (authctxt->krb5_user) {\n\t\tkrb5_free_principal(authctxt->krb5_ctx, authctxt->krb5_user);\n\t\tauthctxt->krb5_user = NULL;\n\t}\n\tif (authctxt->krb5_ctx) {\n\t\tkrb5_free_context(authctxt->krb5_ctx);\n\t\tauthctxt->krb5_ctx = NULL;\n\t}\n}\n\n#ifndef HEIMDAL\nkrb5_error_code\nssh_krb5_cc_gen(krb5_context ctx, krb5_ccache *ccache) {\n\tint tmpfd, ret, oerrno;\n\tchar ccname[40];\n\tmode_t old_umask;\n\n\tret = snprintf(ccname, sizeof(ccname),\n\t    \"FILE:/tmp/krb5cc_%d_XXXXXXXXXX\", geteuid());\n\tif (ret < 0 || (size_t)ret >= sizeof(ccname))\n\t\treturn ENOMEM;\n\n\told_umask = umask(0177);\n\ttmpfd = mkstemp(ccname + strlen(\"FILE:\"));\n\toerrno = errno;\n\tumask(old_umask);\n\tif (tmpfd == -1) {\n\t\tlogit(\"mkstemp(): %.100s\", strerror(oerrno));\n\t\treturn oerrno;\n\t}\n\n\tif (fchmod(tmpfd,S_IRUSR | S_IWUSR) == -1) {\n\t\toerrno = errno;\n\t\tlogit(\"fchmod(): %.100s\", strerror(oerrno));\n\t\tclose(tmpfd);\n\t\treturn oerrno;\n\t}\n\tclose(tmpfd);\n\n\treturn (krb5_cc_resolve(ctx, ccname, ccache));\n}\n#endif  \n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}