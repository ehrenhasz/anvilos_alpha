{
  "module_name": "ssh-ed25519-sk.c",
  "hash_id": "f1d2bb1568c35a6e0dde5576a6faea3d97d5306672989e69219ddd94f8918f0e",
  "original_prompt": "Ingested from openssh-9.6p1/ssh-ed25519-sk.c",
  "human_readable_source": " \n \n\n \n\n#include \"includes.h\"\n\n#define SSHKEY_INTERNAL\n#include <sys/types.h>\n#include <limits.h>\n\n#include \"crypto_api.h\"\n\n#include <string.h>\n#include <stdarg.h>\n\n#include \"log.h\"\n#include \"sshbuf.h\"\n#include \"sshkey.h\"\n#include \"ssherr.h\"\n#include \"ssh.h\"\n#include \"digest.h\"\n\n \nextern struct sshkey_impl_funcs sshkey_ed25519_funcs;\n\nstatic void\nssh_ed25519_sk_cleanup(struct sshkey *k)\n{\n\tsshkey_sk_cleanup(k);\n\tsshkey_ed25519_funcs.cleanup(k);\n}\n\nstatic int\nssh_ed25519_sk_equal(const struct sshkey *a, const struct sshkey *b)\n{\n\tif (!sshkey_sk_fields_equal(a, b))\n\t\treturn 0;\n\tif (!sshkey_ed25519_funcs.equal(a, b))\n\t\treturn 0;\n\treturn 1;\n}\n\nstatic int\nssh_ed25519_sk_serialize_public(const struct sshkey *key, struct sshbuf *b,\n    enum sshkey_serialize_rep opts)\n{\n\tint r;\n\n\tif ((r = sshkey_ed25519_funcs.serialize_public(key, b, opts)) != 0)\n\t\treturn r;\n\tif ((r = sshkey_serialize_sk(key, b)) != 0)\n\t\treturn r;\n\n\treturn 0;\n}\n\nstatic int\nssh_ed25519_sk_serialize_private(const struct sshkey *key, struct sshbuf *b,\n    enum sshkey_serialize_rep opts)\n{\n\tint r;\n\n\tif ((r = sshkey_ed25519_funcs.serialize_public(key, b, opts)) != 0)\n\t\treturn r;\n\tif ((r = sshkey_serialize_private_sk(key, b)) != 0)\n\t\treturn r;\n\n\treturn 0;\n}\n\nstatic int\nssh_ed25519_sk_copy_public(const struct sshkey *from, struct sshkey *to)\n{\n\tint r;\n\n\tif ((r = sshkey_ed25519_funcs.copy_public(from, to)) != 0)\n\t\treturn r;\n\tif ((r = sshkey_copy_public_sk(from, to)) != 0)\n\t\treturn r;\n\treturn 0;\n}\n\nstatic int\nssh_ed25519_sk_deserialize_public(const char *ktype, struct sshbuf *b,\n    struct sshkey *key)\n{\n\tint r;\n\n\tif ((r = sshkey_ed25519_funcs.deserialize_public(ktype, b, key)) != 0)\n\t\treturn r;\n\tif ((r = sshkey_deserialize_sk(b, key)) != 0)\n\t\treturn r;\n\treturn 0;\n}\n\nstatic int\nssh_ed25519_sk_deserialize_private(const char *ktype, struct sshbuf *b,\n    struct sshkey *key)\n{\n\tint r;\n\n\tif ((r = sshkey_ed25519_funcs.deserialize_public(ktype, b, key)) != 0)\n\t\treturn r;\n\tif ((r = sshkey_private_deserialize_sk(b, key)) != 0)\n\t\treturn r;\n\treturn 0;\n}\n\nstatic int\nssh_ed25519_sk_verify(const struct sshkey *key,\n    const u_char *sig, size_t siglen,\n    const u_char *data, size_t dlen, const char *alg, u_int compat,\n    struct sshkey_sig_details **detailsp)\n{\n\tstruct sshbuf *b = NULL;\n\tstruct sshbuf *encoded = NULL;\n\tchar *ktype = NULL;\n\tconst u_char *sigblob;\n\tconst u_char *sm;\n\tu_char *m = NULL;\n\tu_char apphash[32];\n\tu_char msghash[32];\n\tu_char sig_flags;\n\tu_int sig_counter;\n\tsize_t len;\n\tunsigned long long smlen = 0, mlen = 0;\n\tint r = SSH_ERR_INTERNAL_ERROR;\n\tint ret;\n\tstruct sshkey_sig_details *details = NULL;\n\n\tif (detailsp != NULL)\n\t\t*detailsp = NULL;\n\n\tif (key == NULL ||\n\t    sshkey_type_plain(key->type) != KEY_ED25519_SK ||\n\t    key->ed25519_pk == NULL ||\n\t    sig == NULL || siglen == 0)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\n\tif ((b = sshbuf_from(sig, siglen)) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif (sshbuf_get_cstring(b, &ktype, NULL) != 0 ||\n\t    sshbuf_get_string_direct(b, &sigblob, &len) != 0 ||\n\t    sshbuf_get_u8(b, &sig_flags) != 0 ||\n\t    sshbuf_get_u32(b, &sig_counter) != 0) {\n\t\tr = SSH_ERR_INVALID_FORMAT;\n\t\tgoto out;\n\t}\n#ifdef DEBUG_SK\n\tfprintf(stderr, \"%s: data:\\n\", __func__);\n\t \n\tfprintf(stderr, \"%s: sigblob:\\n\", __func__);\n\tsshbuf_dump_data(sigblob, len, stderr);\n\tfprintf(stderr, \"%s: sig_flags = 0x%02x, sig_counter = %u\\n\",\n\t    __func__, sig_flags, sig_counter);\n#endif\n\tif (strcmp(sshkey_ssh_name_plain(key), ktype) != 0) {\n\t\tr = SSH_ERR_KEY_TYPE_MISMATCH;\n\t\tgoto out;\n\t}\n\tif (sshbuf_len(b) != 0) {\n\t\tr = SSH_ERR_UNEXPECTED_TRAILING_DATA;\n\t\tgoto out;\n\t}\n\tif (len > crypto_sign_ed25519_BYTES) {\n\t\tr = SSH_ERR_INVALID_FORMAT;\n\t\tgoto out;\n\t}\n\tif (ssh_digest_memory(SSH_DIGEST_SHA256, key->sk_application,\n\t    strlen(key->sk_application), apphash, sizeof(apphash)) != 0 ||\n\t    ssh_digest_memory(SSH_DIGEST_SHA256, data, dlen,\n\t    msghash, sizeof(msghash)) != 0) {\n\t\tr = SSH_ERR_INVALID_ARGUMENT;\n\t\tgoto out;\n\t}\n#ifdef DEBUG_SK\n\tfprintf(stderr, \"%s: hashed application:\\n\", __func__);\n\tsshbuf_dump_data(apphash, sizeof(apphash), stderr);\n\tfprintf(stderr, \"%s: hashed message:\\n\", __func__);\n\tsshbuf_dump_data(msghash, sizeof(msghash), stderr);\n#endif\n\tif ((details = calloc(1, sizeof(*details))) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tdetails->sk_counter = sig_counter;\n\tdetails->sk_flags = sig_flags;\n\tif ((encoded = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif (sshbuf_put(encoded, sigblob, len) != 0 ||\n\t    sshbuf_put(encoded, apphash, sizeof(apphash)) != 0 ||\n\t    sshbuf_put_u8(encoded, sig_flags) != 0 ||\n\t    sshbuf_put_u32(encoded, sig_counter) != 0 ||\n\t    sshbuf_put(encoded, msghash, sizeof(msghash)) != 0) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n#ifdef DEBUG_SK\n\tfprintf(stderr, \"%s: signed buf:\\n\", __func__);\n\tsshbuf_dump(encoded, stderr);\n#endif\n\tsm = sshbuf_ptr(encoded);\n\tsmlen = sshbuf_len(encoded);\n\tmlen = smlen;\n\tif ((m = malloc(smlen)) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((ret = crypto_sign_ed25519_open(m, &mlen, sm, smlen,\n\t    key->ed25519_pk)) != 0) {\n\t\tdebug2_f(\"crypto_sign_ed25519_open failed: %d\", ret);\n\t}\n\tif (ret != 0 || mlen != smlen - len) {\n\t\tr = SSH_ERR_SIGNATURE_INVALID;\n\t\tgoto out;\n\t}\n\t \n\t \n\tr = 0;\n\tif (detailsp != NULL) {\n\t\t*detailsp = details;\n\t\tdetails = NULL;\n\t}\n out:\n\tif (m != NULL)\n\t\tfreezero(m, smlen);  \n\tsshkey_sig_details_free(details);\n\tsshbuf_free(b);\n\tsshbuf_free(encoded);\n\tfree(ktype);\n\treturn r;\n}\n\nstatic const struct sshkey_impl_funcs sshkey_ed25519_sk_funcs = {\n\t \t\tNULL,\n\t \t\tNULL,\n\t \tssh_ed25519_sk_cleanup,\n\t \t\tssh_ed25519_sk_equal,\n\t  ssh_ed25519_sk_serialize_public,\n\t  ssh_ed25519_sk_deserialize_public,\n\t  ssh_ed25519_sk_serialize_private,\n\t  ssh_ed25519_sk_deserialize_private,\n\t \tNULL,\n\t \tssh_ed25519_sk_copy_public,\n\t \t\tNULL,\n\t \t\tssh_ed25519_sk_verify,\n};\n\nconst struct sshkey_impl sshkey_ed25519_sk_impl = {\n\t \t\t\"sk-ssh-ed25519@openssh.com\",\n\t \t\"ED25519-SK\",\n\t \t\tNULL,\n\t \t\tKEY_ED25519_SK,\n\t \t\t0,\n\t \t\t0,\n\t \t0,\n\t \t256,\n\t \t\t&sshkey_ed25519_sk_funcs,\n};\n\nconst struct sshkey_impl sshkey_ed25519_sk_cert_impl = {\n\t \t\t\"sk-ssh-ed25519-cert-v01@openssh.com\",\n\t \t\"ED25519-SK-CERT\",\n\t \t\tNULL,\n\t \t\tKEY_ED25519_SK_CERT,\n\t \t\t0,\n\t \t\t1,\n\t \t0,\n\t \t256,\n\t \t\t&sshkey_ed25519_sk_funcs,\n};\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}