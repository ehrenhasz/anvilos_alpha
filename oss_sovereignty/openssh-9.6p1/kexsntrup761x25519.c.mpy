{
  "module_name": "kexsntrup761x25519.c",
  "hash_id": "aefd1b1e009b0d93e596796db6400ad3e51ca6039978454de7cdf4878338a160",
  "original_prompt": "Ingested from openssh-9.6p1/kexsntrup761x25519.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#ifdef USE_SNTRUP761X25519\n\n#include <sys/types.h>\n\n#include <stdio.h>\n#include <string.h>\n#include <signal.h>\n\n#include \"sshkey.h\"\n#include \"kex.h\"\n#include \"sshbuf.h\"\n#include \"digest.h\"\n#include \"ssherr.h\"\n\nint\nkex_kem_sntrup761x25519_keypair(struct kex *kex)\n{\n\tstruct sshbuf *buf = NULL;\n\tu_char *cp = NULL;\n\tsize_t need;\n\tint r;\n\n\tif ((buf = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tneed = crypto_kem_sntrup761_PUBLICKEYBYTES + CURVE25519_SIZE;\n\tif ((r = sshbuf_reserve(buf, need, &cp)) != 0)\n\t\tgoto out;\n\tcrypto_kem_sntrup761_keypair(cp, kex->sntrup761_client_key);\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"client public key sntrup761:\", cp,\n\t    crypto_kem_sntrup761_PUBLICKEYBYTES);\n#endif\n\tcp += crypto_kem_sntrup761_PUBLICKEYBYTES;\n\tkexc25519_keygen(kex->c25519_client_key, cp);\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"client public key c25519:\", cp, CURVE25519_SIZE);\n#endif\n\tkex->client_pub = buf;\n\tbuf = NULL;\n out:\n\tsshbuf_free(buf);\n\treturn r;\n}\n\nint\nkex_kem_sntrup761x25519_enc(struct kex *kex,\n   const struct sshbuf *client_blob, struct sshbuf **server_blobp,\n   struct sshbuf **shared_secretp)\n{\n\tstruct sshbuf *server_blob = NULL;\n\tstruct sshbuf *buf = NULL;\n\tconst u_char *client_pub;\n\tu_char *kem_key, *ciphertext, *server_pub;\n\tu_char server_key[CURVE25519_SIZE];\n\tu_char hash[SSH_DIGEST_MAX_LENGTH];\n\tsize_t need;\n\tint r;\n\n\t*server_blobp = NULL;\n\t*shared_secretp = NULL;\n\n\t \n\tneed = crypto_kem_sntrup761_PUBLICKEYBYTES + CURVE25519_SIZE;\n\tif (sshbuf_len(client_blob) != need) {\n\t\tr = SSH_ERR_SIGNATURE_INVALID;\n\t\tgoto out;\n\t}\n\tclient_pub = sshbuf_ptr(client_blob);\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"client public key sntrup761:\", client_pub,\n\t    crypto_kem_sntrup761_PUBLICKEYBYTES);\n\tdump_digest(\"client public key 25519:\",\n\t    client_pub + crypto_kem_sntrup761_PUBLICKEYBYTES,\n\t    CURVE25519_SIZE);\n#endif\n\t \n\t \n\tif ((buf = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = sshbuf_reserve(buf, crypto_kem_sntrup761_BYTES,\n\t    &kem_key)) != 0)\n\t\tgoto out;\n\t \n\tif ((server_blob = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tneed = crypto_kem_sntrup761_CIPHERTEXTBYTES + CURVE25519_SIZE;\n\tif ((r = sshbuf_reserve(server_blob, need, &ciphertext)) != 0)\n\t\tgoto out;\n\t \n\tcrypto_kem_sntrup761_enc(ciphertext, kem_key, client_pub);\n\t \n\tserver_pub = ciphertext + crypto_kem_sntrup761_CIPHERTEXTBYTES;\n\tkexc25519_keygen(server_key, server_pub);\n\t \n\tclient_pub += crypto_kem_sntrup761_PUBLICKEYBYTES;\n\tif ((r = kexc25519_shared_key_ext(server_key, client_pub, buf, 1)) < 0)\n\t\tgoto out;\n\tif ((r = ssh_digest_buffer(kex->hash_alg, buf, hash, sizeof(hash))) != 0)\n\t\tgoto out;\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"server public key 25519:\", server_pub, CURVE25519_SIZE);\n\tdump_digest(\"server cipher text:\", ciphertext,\n\t    crypto_kem_sntrup761_CIPHERTEXTBYTES);\n\tdump_digest(\"server kem key:\", kem_key, crypto_kem_sntrup761_BYTES);\n\tdump_digest(\"concatenation of KEM key and ECDH shared key:\",\n\t    sshbuf_ptr(buf), sshbuf_len(buf));\n#endif\n\t \n\tsshbuf_reset(buf);\n\tif ((r = sshbuf_put_string(buf, hash,\n\t    ssh_digest_bytes(kex->hash_alg))) != 0)\n\t\tgoto out;\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"encoded shared secret:\", sshbuf_ptr(buf), sshbuf_len(buf));\n#endif\n\t*server_blobp = server_blob;\n\t*shared_secretp = buf;\n\tserver_blob = NULL;\n\tbuf = NULL;\n out:\n\texplicit_bzero(hash, sizeof(hash));\n\texplicit_bzero(server_key, sizeof(server_key));\n\tsshbuf_free(server_blob);\n\tsshbuf_free(buf);\n\treturn r;\n}\n\nint\nkex_kem_sntrup761x25519_dec(struct kex *kex,\n    const struct sshbuf *server_blob, struct sshbuf **shared_secretp)\n{\n\tstruct sshbuf *buf = NULL;\n\tu_char *kem_key = NULL;\n\tconst u_char *ciphertext, *server_pub;\n\tu_char hash[SSH_DIGEST_MAX_LENGTH];\n\tsize_t need;\n\tint r, decoded;\n\n\t*shared_secretp = NULL;\n\n\tneed = crypto_kem_sntrup761_CIPHERTEXTBYTES + CURVE25519_SIZE;\n\tif (sshbuf_len(server_blob) != need) {\n\t\tr = SSH_ERR_SIGNATURE_INVALID;\n\t\tgoto out;\n\t}\n\tciphertext = sshbuf_ptr(server_blob);\n\tserver_pub = ciphertext + crypto_kem_sntrup761_CIPHERTEXTBYTES;\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"server cipher text:\", ciphertext,\n\t    crypto_kem_sntrup761_CIPHERTEXTBYTES);\n\tdump_digest(\"server public key c25519:\", server_pub, CURVE25519_SIZE);\n#endif\n\t \n\tif ((buf = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = sshbuf_reserve(buf, crypto_kem_sntrup761_BYTES,\n\t    &kem_key)) != 0)\n\t\tgoto out;\n\tdecoded = crypto_kem_sntrup761_dec(kem_key, ciphertext,\n\t    kex->sntrup761_client_key);\n\tif ((r = kexc25519_shared_key_ext(kex->c25519_client_key, server_pub,\n\t    buf, 1)) < 0)\n\t\tgoto out;\n\tif ((r = ssh_digest_buffer(kex->hash_alg, buf, hash, sizeof(hash))) != 0)\n\t\tgoto out;\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"client kem key:\", kem_key, crypto_kem_sntrup761_BYTES);\n\tdump_digest(\"concatenation of KEM key and ECDH shared key:\",\n\t    sshbuf_ptr(buf), sshbuf_len(buf));\n#endif\n\tsshbuf_reset(buf);\n\tif ((r = sshbuf_put_string(buf, hash,\n\t    ssh_digest_bytes(kex->hash_alg))) != 0)\n\t\tgoto out;\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"encoded shared secret:\", sshbuf_ptr(buf), sshbuf_len(buf));\n#endif\n\tif (decoded != 0) {\n\t\tr = SSH_ERR_SIGNATURE_INVALID;\n\t\tgoto out;\n\t}\n\t*shared_secretp = buf;\n\tbuf = NULL;\n out:\n\texplicit_bzero(hash, sizeof(hash));\n\tsshbuf_free(buf);\n\treturn r;\n}\n\n#else\n\n#include \"ssherr.h\"\n\nstruct kex;\nstruct sshbuf;\nstruct sshkey;\n\nint\nkex_kem_sntrup761x25519_keypair(struct kex *kex)\n{\n\treturn SSH_ERR_SIGN_ALG_UNSUPPORTED;\n}\n\nint\nkex_kem_sntrup761x25519_enc(struct kex *kex,\n   const struct sshbuf *client_blob, struct sshbuf **server_blobp,\n   struct sshbuf **shared_secretp)\n{\n\treturn SSH_ERR_SIGN_ALG_UNSUPPORTED;\n}\n\nint\nkex_kem_sntrup761x25519_dec(struct kex *kex,\n    const struct sshbuf *server_blob, struct sshbuf **shared_secretp)\n{\n\treturn SSH_ERR_SIGN_ALG_UNSUPPORTED;\n}\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}