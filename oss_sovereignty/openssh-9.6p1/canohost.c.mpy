{
  "module_name": "canohost.c",
  "hash_id": "c01ef01f150648ccd1ab5b17a3a77c5254aa9ad877d4fce9676b72d445c833f7",
  "original_prompt": "Ingested from openssh-9.6p1/canohost.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <sys/socket.h>\n#include <sys/un.h>\n\n#include <netinet/in.h>\n#include <arpa/inet.h>\n\n#include <errno.h>\n#include <netdb.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <stdarg.h>\n#include <unistd.h>\n\n#include \"xmalloc.h\"\n#include \"packet.h\"\n#include \"log.h\"\n#include \"canohost.h\"\n#include \"misc.h\"\n\nvoid\nipv64_normalise_mapped(struct sockaddr_storage *addr, socklen_t *len)\n{\n\tstruct sockaddr_in6 *a6 = (struct sockaddr_in6 *)addr;\n\tstruct sockaddr_in *a4 = (struct sockaddr_in *)addr;\n\tstruct in_addr inaddr;\n\tu_int16_t port;\n\n\tif (addr->ss_family != AF_INET6 ||\n\t    !IN6_IS_ADDR_V4MAPPED(&a6->sin6_addr))\n\t\treturn;\n\n\tdebug3(\"Normalising mapped IPv4 in IPv6 address\");\n\n\tmemcpy(&inaddr, ((char *)&a6->sin6_addr) + 12, sizeof(inaddr));\n\tport = a6->sin6_port;\n\n\tmemset(a4, 0, sizeof(*a4));\n\n\ta4->sin_family = AF_INET;\n\t*len = sizeof(*a4);\n\tmemcpy(&a4->sin_addr, &inaddr, sizeof(inaddr));\n\ta4->sin_port = port;\n}\n\n \nstatic char *\nget_socket_address(int sock, int remote, int flags)\n{\n\tstruct sockaddr_storage addr;\n\tsocklen_t addrlen;\n\tchar ntop[NI_MAXHOST];\n\tint r;\n\n\tif (sock < 0)\n\t\treturn NULL;\n\n\t \n\taddrlen = sizeof(addr);\n\tmemset(&addr, 0, sizeof(addr));\n\n\tif (remote) {\n\t\tif (getpeername(sock, (struct sockaddr *)&addr, &addrlen) != 0)\n\t\t\treturn NULL;\n\t} else {\n\t\tif (getsockname(sock, (struct sockaddr *)&addr, &addrlen) != 0)\n\t\t\treturn NULL;\n\t}\n\n\t \n\tif (addr.ss_family == AF_INET6) {\n\t\taddrlen = sizeof(struct sockaddr_in6);\n\t\tipv64_normalise_mapped(&addr, &addrlen);\n\t}\n\n\tswitch (addr.ss_family) {\n\tcase AF_INET:\n\tcase AF_INET6:\n\t\t \n\t\tif ((r = getnameinfo((struct sockaddr *)&addr, addrlen, ntop,\n\t\t    sizeof(ntop), NULL, 0, flags)) != 0) {\n\t\t\terror_f(\"getnameinfo %d failed: %s\",\n\t\t\t    flags, ssh_gai_strerror(r));\n\t\t\treturn NULL;\n\t\t}\n\t\treturn xstrdup(ntop);\n\tcase AF_UNIX:\n\t\t \n\t\treturn xstrdup(((struct sockaddr_un *)&addr)->sun_path);\n\tdefault:\n\t\t \n\t\treturn NULL;\n\t}\n}\n\nchar *\nget_peer_ipaddr(int sock)\n{\n\tchar *p;\n\n\tif ((p = get_socket_address(sock, 1, NI_NUMERICHOST)) != NULL)\n\t\treturn p;\n\treturn xstrdup(\"UNKNOWN\");\n}\n\nchar *\nget_local_ipaddr(int sock)\n{\n\tchar *p;\n\n\tif ((p = get_socket_address(sock, 0, NI_NUMERICHOST)) != NULL)\n\t\treturn p;\n\treturn xstrdup(\"UNKNOWN\");\n}\n\nchar *\nget_local_name(int fd)\n{\n\tchar *host, myname[NI_MAXHOST];\n\n\t \n\tif ((host = get_socket_address(fd, 0, NI_NAMEREQD)) != NULL)\n\t\treturn host;\n\n\t \n\tif (gethostname(myname, sizeof(myname)) == -1) {\n\t\tverbose_f(\"gethostname: %s\", strerror(errno));\n\t\thost = xstrdup(\"UNKNOWN\");\n\t} else {\n\t\thost = xstrdup(myname);\n\t}\n\n\treturn host;\n}\n\n \n\nstatic int\nget_sock_port(int sock, int local)\n{\n\tstruct sockaddr_storage from;\n\tsocklen_t fromlen;\n\tchar strport[NI_MAXSERV];\n\tint r;\n\n\tif (sock < 0)\n\t\treturn -1;\n\t \n\tfromlen = sizeof(from);\n\tmemset(&from, 0, sizeof(from));\n\tif (local) {\n\t\tif (getsockname(sock, (struct sockaddr *)&from, &fromlen) == -1) {\n\t\t\terror(\"getsockname failed: %.100s\", strerror(errno));\n\t\t\treturn 0;\n\t\t}\n\t} else {\n\t\tif (getpeername(sock, (struct sockaddr *)&from, &fromlen) == -1) {\n\t\t\tdebug(\"getpeername failed: %.100s\", strerror(errno));\n\t\t\treturn -1;\n\t\t}\n\t}\n\n\t \n\tif (from.ss_family == AF_INET6)\n\t\tfromlen = sizeof(struct sockaddr_in6);\n\n\t \n\tif (from.ss_family != AF_INET && from.ss_family != AF_INET6)\n\t\treturn 0;\n\n\t \n\tif ((r = getnameinfo((struct sockaddr *)&from, fromlen, NULL, 0,\n\t    strport, sizeof(strport), NI_NUMERICSERV)) != 0)\n\t\tfatal_f(\"getnameinfo NI_NUMERICSERV failed: %s\",\n\t\t    ssh_gai_strerror(r));\n\treturn atoi(strport);\n}\n\nint\nget_peer_port(int sock)\n{\n\treturn get_sock_port(sock, 0);\n}\n\nint\nget_local_port(int sock)\n{\n\treturn get_sock_port(sock, 1);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}