{
  "module_name": "logintest.c",
  "hash_id": "24700653126881c38faba05d957f8a3586e2d9007f593b6255b3485d85ea715b",
  "original_prompt": "Ingested from openssh-9.6p1/logintest.c",
  "human_readable_source": " \n\n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <sys/wait.h>\n#include <sys/socket.h>\n\n#include <netinet/in.h>\n\n#include <unistd.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <string.h>\n#include <pwd.h>\n#include <netdb.h>\n#ifdef HAVE_TIME_H\n#include <time.h>\n#endif\n\n#include \"loginrec.h\"\n\nextern char *__progname;\n\n#define PAUSE_BEFORE_LOGOUT 3\n\nint nologtest = 0;\nint compile_opts_only = 0;\nint be_verbose = 0;\n\n\n \nvoid\ndump_logininfo(struct logininfo *li, char *descname)\n{\n\t \n\tprintf(\"struct logininfo %s = {\\n\\t\"\n\t    \"progname\\t'%s'\\n\\ttype\\t\\t%d\\n\\t\"\n\t    \"pid\\t\\t%d\\n\\tuid\\t\\t%d\\n\\t\"\n\t    \"line\\t\\t'%s'\\n\\tusername\\t'%s'\\n\\t\"\n\t    \"hostname\\t'%s'\\n\\texit\\t\\t%d\\n\\ttermination\\t%d\\n\\t\"\n\t    \"tv_sec\\t%d\\n\\ttv_usec\\t%d\\n\\t\"\n\t    \"struct login_netinfo hostaddr {\\n\\t\\t\"\n\t    \"struct sockaddr sa {\\n\"\n\t    \"\\t\\t\\tfamily\\t%d\\n\\t\\t}\\n\"\n\t    \"\\t}\\n\"\n\t    \"}\\n\",\n\t    descname, li->progname, li->type,\n\t    li->pid, li->uid, li->line,\n\t    li->username, li->hostname, li->exit,\n\t    li->termination, li->tv_sec, li->tv_usec,\n\t    li->hostaddr.sa.sa_family);\n}\n\n\nint\ntestAPI()\n{\n\tstruct logininfo *li1;\n\tstruct passwd *pw;\n\tstruct hostent *he;\n\tstruct sockaddr_in sa_in4;\n\tchar cmdstring[256], stripline[8];\n\tchar username[32];\n#ifdef HAVE_TIME_H\n\ttime_t t0, t1, t2, logintime, logouttime;\n\tchar s_t0[64],s_t1[64],s_t2[64];\n\tchar s_logintime[64], s_logouttime[64];  \n#endif\n\n\tprintf(\"**\\n** Testing the API...\\n**\\n\");\n\n\tpw = getpwuid(getuid());\n\tstrlcpy(username, pw->pw_name, sizeof(username));\n\n\t \n\n\tprintf(\"login_alloc_entry test (no host info):\\n\");\n\n\t \n\tli1 = login_alloc_entry((int)getpid(), username, NULL, ttyname(0));\n\tstrlcpy(li1->progname, \"OpenSSH-logintest\", sizeof(li1->progname));\n\n\tif (be_verbose)\n\t\tdump_logininfo(li1, \"li1\");\n\n\tprintf(\"Setting host address info for 'localhost' (may call out):\\n\");\n\tif (! (he = gethostbyname(\"localhost\"))) {\n\t\tprintf(\"Couldn't set hostname(lookup failed)\\n\");\n\t} else {\n\t\t \n\t\tmemcpy((void *)&(sa_in4.sin_addr), (void *)&(he->h_addr_list[0][0]),\n\t\t    sizeof(struct in_addr));\n\t\tlogin_set_addr(li1, (struct sockaddr *) &sa_in4, sizeof(sa_in4));\n\t\tstrlcpy(li1->hostname, \"localhost\", sizeof(li1->hostname));\n\t}\n\tif (be_verbose)\n\t\tdump_logininfo(li1, \"li1\");\n\n\tif ((int)geteuid() != 0) {\n\t\tprintf(\"NOT RUNNING LOGIN TESTS - you are not root!\\n\");\n\t\treturn 1;\n\t}\n\n\tif (nologtest)\n\t\treturn 1;\n\n\tline_stripname(stripline, li1->line, sizeof(stripline));\n\n\tprintf(\"Performing an invalid login attempt (no type field)\\n--\\n\");\n\tlogin_write(li1);\n\tprintf(\"--\\n(Should have written errors to stderr)\\n\");\n\n#ifdef HAVE_TIME_H\n\t(void)time(&t0);\n\tstrlcpy(s_t0, ctime(&t0), sizeof(s_t0));\n\tt1 = login_get_lastlog_time(getuid());\n\tstrlcpy(s_t1, ctime(&t1), sizeof(s_t1));\n\tprintf(\"Before logging in:\\n\\tcurrent time is %d - %s\\t\"\n\t    \"lastlog time is %d - %s\\n\",\n\t    (int)t0, s_t0, (int)t1, s_t1);\n#endif\n\n\tprintf(\"Performing a login on line %s \", stripline);\n#ifdef HAVE_TIME_H\n\t(void)time(&logintime);\n\tstrlcpy(s_logintime, ctime(&logintime), sizeof(s_logintime));\n\tprintf(\"at %d - %s\", (int)logintime, s_logintime);\n#endif\n\tprintf(\"--\\n\");\n\tlogin_login(li1);\n\n\tsnprintf(cmdstring, sizeof(cmdstring), \"who | grep '%s '\",\n\t\t stripline);\n\tsystem(cmdstring);\n\n\tprintf(\"--\\nPausing for %d second(s)...\\n\", PAUSE_BEFORE_LOGOUT);\n\tsleep(PAUSE_BEFORE_LOGOUT);\n\n\tprintf(\"Performing a logout \");\n#ifdef HAVE_TIME_H\n\t(void)time(&logouttime);\n\tstrlcpy(s_logouttime, ctime(&logouttime), sizeof(s_logouttime));\n\tprintf(\"at %d - %s\", (int)logouttime, s_logouttime);\n#endif\n\tprintf(\"\\nThe root login shown above should be gone.\\n\"\n\t    \"If the root login hasn't gone, but another user on the same\\n\"\n\t    \"pty has, this is OK - we're hacking it here, and there\\n\"\n\t    \"shouldn't be two users on one pty in reality...\\n\"\n\t    \"-- ('who' output follows)\\n\");\n\tlogin_logout(li1);\n\n\tsystem(cmdstring);\n\tprintf(\"-- ('who' output ends)\\n\");\n\n#ifdef HAVE_TIME_H\n\tt2 = login_get_lastlog_time(getuid());\n\tstrlcpy(s_t2, ctime(&t2), sizeof(s_t2));\n\tprintf(\"After logging in, lastlog time is %d - %s\\n\", (int)t2, s_t2);\n\tif (t1 == t2)\n\t\tprintf(\"The lastlog times before and after logging in are the \"\n\t\t    \"same.\\nThis indicates that lastlog is ** NOT WORKING \"\n\t\t    \"CORRECTLY **\\n\");\n\telse if (t0 != t2)\n\t\t \n\t\tprintf(\"** The login time and the lastlog time differ.\\n\"\n\t\t    \"** This indicates that lastlog is either recording the \"\n\t\t    \"wrong time,\\n** or retrieving the wrong entry.\\n\"\n\t\t    \"If it's off by less than %d second(s) \"\n\t\t    \"run the test again.\\n\", PAUSE_BEFORE_LOGOUT);\n\telse\n\t\tprintf(\"lastlog agrees with the login time. This is a good thing.\\n\");\n\n#endif\n\n\tprintf(\"--\\nThe output of 'last' shown next should have \"\n\t    \"an entry for root \\n  on %s for the time shown above:\\n--\\n\",\n\t    stripline);\n\tsnprintf(cmdstring, sizeof(cmdstring), \"last | grep '%s ' | head -3\",\n\t\t stripline);\n\tsystem(cmdstring);\n\n\tprintf(\"--\\nEnd of login test.\\n\");\n\n\tlogin_free_entry(li1);\n\n\treturn 1;\n}  \n\n\nvoid\ntestLineName(char *line)\n{\n\t \n\tchar full[17], strip[9], abbrev[5];\n\n\tmemset(full, '\\0', sizeof(full));\n\tmemset(strip, '\\0', sizeof(strip));\n\tmemset(abbrev, '\\0', sizeof(abbrev));\n\n\tline_fullname(full, line, sizeof(full)-1);\n\tline_stripname(strip, full, sizeof(strip)-1);\n\tline_abbrevname(abbrev, full, sizeof(abbrev)-1);\n\tprintf(\"%s: %s, %s, %s\\n\", line, full, strip, abbrev);\n\n}  \n\n\nint\ntestOutput()\n{\n\tprintf(\"**\\n** Testing linename functions\\n**\\n\");\n\ttestLineName(\"/dev/pts/1\");\n\ttestLineName(\"pts/1\");\n\ttestLineName(\"pts/999\");\n\ttestLineName(\"/dev/ttyp00\");\n\ttestLineName(\"ttyp00\");\n\n\treturn 1;\n}  \n\n\n \nvoid\nshowOptions(void)\n{\n\tprintf(\"**\\n** Compile-time options\\n**\\n\");\n\n\tprintf(\"login recording methods selected:\\n\");\n#ifdef USE_LOGIN\n\tprintf(\"\\tUSE_LOGIN\\n\");\n#endif\n#ifdef USE_UTMP\n\tprintf(\"\\tUSE_UTMP (UTMP_FILE=%s)\\n\", UTMP_FILE);\n#endif\n#ifdef USE_UTMPX\n\tprintf(\"\\tUSE_UTMPX\\n\");\n#endif\n#ifdef USE_WTMP\n\tprintf(\"\\tUSE_WTMP (WTMP_FILE=%s)\\n\", WTMP_FILE);\n#endif\n#ifdef USE_WTMPX\n\tprintf(\"\\tUSE_WTMPX (WTMPX_FILE=%s)\\n\", WTMPX_FILE);\n#endif\n#ifdef USE_LASTLOG\n\tprintf(\"\\tUSE_LASTLOG (LASTLOG_FILE=%s)\\n\", LASTLOG_FILE);\n#endif\n\tprintf(\"\\n\");\n\n}  \n\n\nint\nmain(int argc, char *argv[])\n{\n\tprintf(\"Platform-independent login recording test driver\\n\");\n\n\t__progname = ssh_get_progname(argv[0]);\n\tif (argc == 2) {\n\t\tif (strncmp(argv[1], \"-i\", 3) == 0)\n\t\t\tcompile_opts_only = 1;\n\t\telse if (strncmp(argv[1], \"-v\", 3) == 0)\n\t\t\tbe_verbose=1;\n\t}\n\n\tif (!compile_opts_only) {\n\t\tif (be_verbose && !testOutput())\n\t\t\treturn 1;\n\n\t\tif (!testAPI())\n\t\t\treturn 1;\n\t}\n\n\tshowOptions();\n\n\treturn 0;\n}  \n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}