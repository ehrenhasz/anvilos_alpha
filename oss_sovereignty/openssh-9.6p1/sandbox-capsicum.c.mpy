{
  "module_name": "sandbox-capsicum.c",
  "hash_id": "af68b5ff75a2137b79cb8ee31c7a02a2bbebe64312c1bdcdabc901fd3106b1a5",
  "original_prompt": "Ingested from openssh-9.6p1/sandbox-capsicum.c",
  "human_readable_source": " \n\n#include \"includes.h\"\n\n#ifdef SANDBOX_CAPSICUM\n\n#include <sys/types.h>\n#include <sys/time.h>\n#include <sys/resource.h>\n#include <sys/capsicum.h>\n\n#include <errno.h>\n#include <stdarg.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <unistd.h>\n#ifdef HAVE_CAPSICUM_HELPERS_H\n#include <capsicum_helpers.h>\n#endif\n\n#include \"log.h\"\n#include \"monitor.h\"\n#include \"ssh-sandbox.h\"\n#include \"xmalloc.h\"\n\n \n\nstruct ssh_sandbox {\n\tstruct monitor *monitor;\n\tpid_t child_pid;\n};\n\nstruct ssh_sandbox *\nssh_sandbox_init(struct monitor *monitor)\n{\n\tstruct ssh_sandbox *box;\n\n\t \n\tdebug3(\"%s: preparing capsicum sandbox\", __func__);\n\tbox = xcalloc(1, sizeof(*box));\n\tbox->monitor = monitor;\n\tbox->child_pid = 0;\n\n\treturn box;\n}\n\nvoid\nssh_sandbox_child(struct ssh_sandbox *box)\n{\n\tstruct rlimit rl_zero;\n\tcap_rights_t rights;\n\n#ifdef HAVE_CAPH_CACHE_TZDATA\n\tcaph_cache_tzdata();\n#endif\n\n\trl_zero.rlim_cur = rl_zero.rlim_max = 0;\n\n\tif (setrlimit(RLIMIT_FSIZE, &rl_zero) == -1)\n\t\tfatal(\"%s: setrlimit(RLIMIT_FSIZE, { 0, 0 }): %s\",\n\t\t\t__func__, strerror(errno));\n#ifndef SANDBOX_SKIP_RLIMIT_NOFILE\n\tif (setrlimit(RLIMIT_NOFILE, &rl_zero) == -1)\n\t\tfatal(\"%s: setrlimit(RLIMIT_NOFILE, { 0, 0 }): %s\",\n\t\t\t__func__, strerror(errno));\n#endif\n\tif (setrlimit(RLIMIT_NPROC, &rl_zero) == -1)\n\t\tfatal(\"%s: setrlimit(RLIMIT_NPROC, { 0, 0 }): %s\",\n\t\t\t__func__, strerror(errno));\n\n\tcap_rights_init(&rights);\n\n\tif (cap_rights_limit(STDIN_FILENO, &rights) < 0 && errno != ENOSYS)\n\t\tfatal(\"can't limit stdin: %m\");\n\tif (cap_rights_limit(STDOUT_FILENO, &rights) < 0 && errno != ENOSYS)\n\t\tfatal(\"can't limit stdout: %m\");\n\tif (cap_rights_limit(STDERR_FILENO, &rights) < 0 && errno != ENOSYS)\n\t\tfatal(\"can't limit stderr: %m\");\n\n\tcap_rights_init(&rights, CAP_READ, CAP_WRITE);\n\tif (cap_rights_limit(box->monitor->m_recvfd, &rights) < 0 &&\n\t    errno != ENOSYS)\n\t\tfatal(\"%s: failed to limit the network socket\", __func__);\n\tcap_rights_init(&rights, CAP_WRITE);\n\tif (cap_rights_limit(box->monitor->m_log_sendfd, &rights) < 0 &&\n\t    errno != ENOSYS)\n\t\tfatal(\"%s: failed to limit the logging socket\", __func__);\n\tif (cap_enter() < 0 && errno != ENOSYS)\n\t\tfatal(\"%s: failed to enter capability mode\", __func__);\n\n}\n\nvoid\nssh_sandbox_parent_finish(struct ssh_sandbox *box)\n{\n\tfree(box);\n\tdebug3(\"%s: finished\", __func__);\n}\n\nvoid\nssh_sandbox_parent_preauth(struct ssh_sandbox *box, pid_t child_pid)\n{\n\tbox->child_pid = child_pid;\n}\n\n#endif  \n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}