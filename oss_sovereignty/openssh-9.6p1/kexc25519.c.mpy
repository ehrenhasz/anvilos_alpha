{
  "module_name": "kexc25519.c",
  "hash_id": "269ae49ddc18794cfa3922daeafb7ecfa0e0bd5bdcc26327d6a8dae1f62a325a",
  "original_prompt": "Ingested from openssh-9.6p1/kexc25519.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n\n#include <stdio.h>\n#include <string.h>\n#include <signal.h>\n\n#include \"sshkey.h\"\n#include \"kex.h\"\n#include \"sshbuf.h\"\n#include \"digest.h\"\n#include \"ssherr.h\"\n#include \"ssh2.h\"\n\nextern int crypto_scalarmult_curve25519(u_char a[CURVE25519_SIZE],\n    const u_char b[CURVE25519_SIZE], const u_char c[CURVE25519_SIZE])\n\t__attribute__((__bounded__(__minbytes__, 1, CURVE25519_SIZE)))\n\t__attribute__((__bounded__(__minbytes__, 2, CURVE25519_SIZE)))\n\t__attribute__((__bounded__(__minbytes__, 3, CURVE25519_SIZE)));\n\nvoid\nkexc25519_keygen(u_char key[CURVE25519_SIZE], u_char pub[CURVE25519_SIZE])\n{\n\tstatic const u_char basepoint[CURVE25519_SIZE] = {9};\n\n\tarc4random_buf(key, CURVE25519_SIZE);\n\tcrypto_scalarmult_curve25519(pub, key, basepoint);\n}\n\nint\nkexc25519_shared_key_ext(const u_char key[CURVE25519_SIZE],\n    const u_char pub[CURVE25519_SIZE], struct sshbuf *out, int raw)\n{\n\tu_char shared_key[CURVE25519_SIZE];\n\tu_char zero[CURVE25519_SIZE];\n\tint r;\n\n\tcrypto_scalarmult_curve25519(shared_key, key, pub);\n\n\t \n\texplicit_bzero(zero, CURVE25519_SIZE);\n\tif (timingsafe_bcmp(zero, shared_key, CURVE25519_SIZE) == 0)\n\t\treturn SSH_ERR_KEY_INVALID_EC_VALUE;\n\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"shared secret\", shared_key, CURVE25519_SIZE);\n#endif\n\tif (raw)\n\t\tr = sshbuf_put(out, shared_key, CURVE25519_SIZE);\n\telse\n\t\tr = sshbuf_put_bignum2_bytes(out, shared_key, CURVE25519_SIZE);\n\texplicit_bzero(shared_key, CURVE25519_SIZE);\n\treturn r;\n}\n\nint\nkexc25519_shared_key(const u_char key[CURVE25519_SIZE],\n    const u_char pub[CURVE25519_SIZE], struct sshbuf *out)\n{\n\treturn kexc25519_shared_key_ext(key, pub, out, 0);\n}\n\nint\nkex_c25519_keypair(struct kex *kex)\n{\n\tstruct sshbuf *buf = NULL;\n\tu_char *cp = NULL;\n\tint r;\n\n\tif ((buf = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_reserve(buf, CURVE25519_SIZE, &cp)) != 0)\n\t\tgoto out;\n\tkexc25519_keygen(kex->c25519_client_key, cp);\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"client public key c25519:\", cp, CURVE25519_SIZE);\n#endif\n\tkex->client_pub = buf;\n\tbuf = NULL;\n out:\n\tsshbuf_free(buf);\n\treturn r;\n}\n\nint\nkex_c25519_enc(struct kex *kex, const struct sshbuf *client_blob,\n   struct sshbuf **server_blobp, struct sshbuf **shared_secretp)\n{\n\tstruct sshbuf *server_blob = NULL;\n\tstruct sshbuf *buf = NULL;\n\tconst u_char *client_pub;\n\tu_char *server_pub;\n\tu_char server_key[CURVE25519_SIZE];\n\tint r;\n\n\t*server_blobp = NULL;\n\t*shared_secretp = NULL;\n\n\tif (sshbuf_len(client_blob) != CURVE25519_SIZE) {\n\t\tr = SSH_ERR_SIGNATURE_INVALID;\n\t\tgoto out;\n\t}\n\tclient_pub = sshbuf_ptr(client_blob);\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"client public key 25519:\", client_pub, CURVE25519_SIZE);\n#endif\n\t \n\tif ((server_blob = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = sshbuf_reserve(server_blob, CURVE25519_SIZE, &server_pub)) != 0)\n\t\tgoto out;\n\tkexc25519_keygen(server_key, server_pub);\n\t \n\tif ((buf = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = kexc25519_shared_key_ext(server_key, client_pub, buf, 0)) < 0)\n\t\tgoto out;\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"server public key 25519:\", server_pub, CURVE25519_SIZE);\n\tdump_digest(\"encoded shared secret:\", sshbuf_ptr(buf), sshbuf_len(buf));\n#endif\n\t*server_blobp = server_blob;\n\t*shared_secretp = buf;\n\tserver_blob = NULL;\n\tbuf = NULL;\n out:\n\texplicit_bzero(server_key, sizeof(server_key));\n\tsshbuf_free(server_blob);\n\tsshbuf_free(buf);\n\treturn r;\n}\n\nint\nkex_c25519_dec(struct kex *kex, const struct sshbuf *server_blob,\n    struct sshbuf **shared_secretp)\n{\n\tstruct sshbuf *buf = NULL;\n\tconst u_char *server_pub;\n\tint r;\n\n\t*shared_secretp = NULL;\n\n\tif (sshbuf_len(server_blob) != CURVE25519_SIZE) {\n\t\tr = SSH_ERR_SIGNATURE_INVALID;\n\t\tgoto out;\n\t}\n\tserver_pub = sshbuf_ptr(server_blob);\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"server public key c25519:\", server_pub, CURVE25519_SIZE);\n#endif\n\t \n\tif ((buf = sshbuf_new()) == NULL) {\n\t\tr = SSH_ERR_ALLOC_FAIL;\n\t\tgoto out;\n\t}\n\tif ((r = kexc25519_shared_key_ext(kex->c25519_client_key, server_pub,\n\t    buf, 0)) < 0)\n\t\tgoto out;\n#ifdef DEBUG_KEXECDH\n\tdump_digest(\"encoded shared secret:\", sshbuf_ptr(buf), sshbuf_len(buf));\n#endif\n\t*shared_secretp = buf;\n\tbuf = NULL;\n out:\n\tsshbuf_free(buf);\n\treturn r;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}