{
  "module_name": "sftp-common.c",
  "hash_id": "05ed5bddcc719e4b7bb2b2325044f1d169102dc8858d781188a1ac8c1b2b7a20",
  "original_prompt": "Ingested from openssh-9.6p1/sftp-common.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <sys/stat.h>\n\n#include <grp.h>\n#include <pwd.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n#include <time.h>\n#include <stdarg.h>\n#include <unistd.h>\n#ifdef HAVE_UTIL_H\n#include <util.h>\n#endif\n\n#include \"xmalloc.h\"\n#include \"ssherr.h\"\n#include \"sshbuf.h\"\n#include \"log.h\"\n#include \"misc.h\"\n\n#include \"sftp.h\"\n#include \"sftp-common.h\"\n\n \nvoid\nattrib_clear(Attrib *a)\n{\n\ta->flags = 0;\n\ta->size = 0;\n\ta->uid = 0;\n\ta->gid = 0;\n\ta->perm = 0;\n\ta->atime = 0;\n\ta->mtime = 0;\n}\n\n \nvoid\nstat_to_attrib(const struct stat *st, Attrib *a)\n{\n\tattrib_clear(a);\n\ta->flags = 0;\n\ta->flags |= SSH2_FILEXFER_ATTR_SIZE;\n\ta->size = st->st_size;\n\ta->flags |= SSH2_FILEXFER_ATTR_UIDGID;\n\ta->uid = st->st_uid;\n\ta->gid = st->st_gid;\n\ta->flags |= SSH2_FILEXFER_ATTR_PERMISSIONS;\n\ta->perm = st->st_mode;\n\ta->flags |= SSH2_FILEXFER_ATTR_ACMODTIME;\n\ta->atime = st->st_atime;\n\ta->mtime = st->st_mtime;\n}\n\n \nvoid\nattrib_to_stat(const Attrib *a, struct stat *st)\n{\n\tmemset(st, 0, sizeof(*st));\n\n\tif (a->flags & SSH2_FILEXFER_ATTR_SIZE)\n\t\tst->st_size = a->size;\n\tif (a->flags & SSH2_FILEXFER_ATTR_UIDGID) {\n\t\tst->st_uid = a->uid;\n\t\tst->st_gid = a->gid;\n\t}\n\tif (a->flags & SSH2_FILEXFER_ATTR_PERMISSIONS)\n\t\tst->st_mode = a->perm;\n\tif (a->flags & SSH2_FILEXFER_ATTR_ACMODTIME) {\n\t\tst->st_atime = a->atime;\n\t\tst->st_mtime = a->mtime;\n\t}\n}\n\n \nint\ndecode_attrib(struct sshbuf *b, Attrib *a)\n{\n\tint r;\n\n\tattrib_clear(a);\n\tif ((r = sshbuf_get_u32(b, &a->flags)) != 0)\n\t\treturn r;\n\tif (a->flags & SSH2_FILEXFER_ATTR_SIZE) {\n\t\tif ((r = sshbuf_get_u64(b, &a->size)) != 0)\n\t\t\treturn r;\n\t}\n\tif (a->flags & SSH2_FILEXFER_ATTR_UIDGID) {\n\t\tif ((r = sshbuf_get_u32(b, &a->uid)) != 0 ||\n\t\t    (r = sshbuf_get_u32(b, &a->gid)) != 0)\n\t\t\treturn r;\n\t}\n\tif (a->flags & SSH2_FILEXFER_ATTR_PERMISSIONS) {\n\t\tif ((r = sshbuf_get_u32(b, &a->perm)) != 0)\n\t\t\treturn r;\n\t}\n\tif (a->flags & SSH2_FILEXFER_ATTR_ACMODTIME) {\n\t\tif ((r = sshbuf_get_u32(b, &a->atime)) != 0 ||\n\t\t    (r = sshbuf_get_u32(b, &a->mtime)) != 0)\n\t\t\treturn r;\n\t}\n\t \n\tif (a->flags & SSH2_FILEXFER_ATTR_EXTENDED) {\n\t\tchar *type;\n\t\tu_char *data;\n\t\tsize_t dlen;\n\t\tu_int i, count;\n\n\t\tif ((r = sshbuf_get_u32(b, &count)) != 0)\n\t\t\treturn r;\n\t\tif (count > 0x100000)\n\t\t\treturn SSH_ERR_INVALID_FORMAT;\n\t\tfor (i = 0; i < count; i++) {\n\t\t\tif ((r = sshbuf_get_cstring(b, &type, NULL)) != 0 ||\n\t\t\t    (r = sshbuf_get_string(b, &data, &dlen)) != 0)\n\t\t\t\treturn r;\n\t\t\tdebug3(\"Got file attribute \\\"%.100s\\\" len %zu\",\n\t\t\t    type, dlen);\n\t\t\tfree(type);\n\t\t\tfree(data);\n\t\t}\n\t}\n\treturn 0;\n}\n\n \nint\nencode_attrib(struct sshbuf *b, const Attrib *a)\n{\n\tint r;\n\n\tif ((r = sshbuf_put_u32(b, a->flags)) != 0)\n\t\treturn r;\n\tif (a->flags & SSH2_FILEXFER_ATTR_SIZE) {\n\t\tif ((r = sshbuf_put_u64(b, a->size)) != 0)\n\t\t\treturn r;\n\t}\n\tif (a->flags & SSH2_FILEXFER_ATTR_UIDGID) {\n\t\tif ((r = sshbuf_put_u32(b, a->uid)) != 0 ||\n\t\t    (r = sshbuf_put_u32(b, a->gid)) != 0)\n\t\t\treturn r;\n\t}\n\tif (a->flags & SSH2_FILEXFER_ATTR_PERMISSIONS) {\n\t\tif ((r = sshbuf_put_u32(b, a->perm)) != 0)\n\t\t\treturn r;\n\t}\n\tif (a->flags & SSH2_FILEXFER_ATTR_ACMODTIME) {\n\t\tif ((r = sshbuf_put_u32(b, a->atime)) != 0 ||\n\t\t    (r = sshbuf_put_u32(b, a->mtime)) != 0)\n\t\t\treturn r;\n\t}\n\treturn 0;\n}\n\n \nconst char *\nfx2txt(int status)\n{\n\tswitch (status) {\n\tcase SSH2_FX_OK:\n\t\treturn(\"No error\");\n\tcase SSH2_FX_EOF:\n\t\treturn(\"End of file\");\n\tcase SSH2_FX_NO_SUCH_FILE:\n\t\treturn(\"No such file or directory\");\n\tcase SSH2_FX_PERMISSION_DENIED:\n\t\treturn(\"Permission denied\");\n\tcase SSH2_FX_FAILURE:\n\t\treturn(\"Failure\");\n\tcase SSH2_FX_BAD_MESSAGE:\n\t\treturn(\"Bad message\");\n\tcase SSH2_FX_NO_CONNECTION:\n\t\treturn(\"No connection\");\n\tcase SSH2_FX_CONNECTION_LOST:\n\t\treturn(\"Connection lost\");\n\tcase SSH2_FX_OP_UNSUPPORTED:\n\t\treturn(\"Operation unsupported\");\n\tdefault:\n\t\treturn(\"Unknown status\");\n\t}\n\t \n}\n\n \nchar *\nls_file(const char *name, const struct stat *st, int remote, int si_units,\n    const char *user, const char *group)\n{\n\tint ulen, glen, sz = 0;\n\tstruct tm *ltime = localtime(&st->st_mtime);\n\tchar buf[1024], lc[8], mode[11+1], tbuf[12+1], ubuf[11+1], gbuf[11+1];\n\tchar sbuf[FMT_SCALED_STRSIZE];\n\ttime_t now;\n\n\tstrmode(st->st_mode, mode);\n\tif (remote) {\n\t\tif (user == NULL) {\n\t\t\tsnprintf(ubuf, sizeof ubuf, \"%u\", (u_int)st->st_uid);\n\t\t\tuser = ubuf;\n\t\t}\n\t\tif (group == NULL) {\n\t\t\tsnprintf(gbuf, sizeof gbuf, \"%u\", (u_int)st->st_gid);\n\t\t\tgroup = gbuf;\n\t\t}\n\t\tstrlcpy(lc, \"?\", sizeof(lc));\n\t} else {\n\t\tuser = user_from_uid(st->st_uid, 0);\n\t\tgroup = group_from_gid(st->st_gid, 0);\n\t\tsnprintf(lc, sizeof(lc), \"%u\", (u_int)st->st_nlink);\n\t}\n\tif (ltime != NULL) {\n\t\tnow = time(NULL);\n\t\tif (now - (365*24*60*60)/2 < st->st_mtime &&\n\t\t    now >= st->st_mtime)\n\t\t\tsz = strftime(tbuf, sizeof tbuf, \"%b %e %H:%M\", ltime);\n\t\telse\n\t\t\tsz = strftime(tbuf, sizeof tbuf, \"%b %e  %Y\", ltime);\n\t}\n\tif (sz == 0)\n\t\ttbuf[0] = '\\0';\n\tulen = MAXIMUM(strlen(user), 8);\n\tglen = MAXIMUM(strlen(group), 8);\n\tif (si_units) {\n\t\tfmt_scaled((long long)st->st_size, sbuf);\n\t\tsnprintf(buf, sizeof buf, \"%s %3s %-*s %-*s %8s %s %s\",\n\t\t    mode, lc, ulen, user, glen, group,\n\t\t    sbuf, tbuf, name);\n\t} else {\n\t\tsnprintf(buf, sizeof buf, \"%s %3s %-*s %-*s %8llu %s %s\",\n\t\t    mode, lc, ulen, user, glen, group,\n\t\t    (unsigned long long)st->st_size, tbuf, name);\n\t}\n\treturn xstrdup(buf);\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}