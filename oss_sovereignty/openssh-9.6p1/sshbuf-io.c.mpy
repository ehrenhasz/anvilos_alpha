{
  "module_name": "sshbuf-io.c",
  "hash_id": "f39d0c30205c33b0924b1bc9a6fc6d4911e79345af5878fddf4ddb93c3b849a0",
  "original_prompt": "Ingested from openssh-9.6p1/sshbuf-io.c",
  "human_readable_source": " \n \n\n#include \"includes.h\"\n\n#include <sys/types.h>\n#include <sys/stat.h>\n\n#include <errno.h>\n#include <fcntl.h>\n#include <unistd.h>\n#include <string.h>\n\n#include \"ssherr.h\"\n#include \"sshbuf.h\"\n#include \"atomicio.h\"\n\n \nint\nsshbuf_load_fd(int fd, struct sshbuf **blobp)\n{\n\tu_char buf[4096];\n\tsize_t len;\n\tstruct stat st;\n\tint r;\n\tstruct sshbuf *blob;\n\n\t*blobp = NULL;\n\n\tif (fstat(fd, &st) == -1)\n\t\treturn SSH_ERR_SYSTEM_ERROR;\n\tif ((st.st_mode & (S_IFSOCK|S_IFCHR|S_IFIFO)) == 0 &&\n\t    st.st_size > SSHBUF_SIZE_MAX)\n\t\treturn SSH_ERR_INVALID_FORMAT;\n\tif ((blob = sshbuf_new()) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tfor (;;) {\n\t\tif ((len = atomicio(read, fd, buf, sizeof(buf))) == 0) {\n\t\t\tif (errno == EPIPE)\n\t\t\t\tbreak;\n\t\t\tr = SSH_ERR_SYSTEM_ERROR;\n\t\t\tgoto out;\n\t\t}\n\t\tif ((r = sshbuf_put(blob, buf, len)) != 0)\n\t\t\tgoto out;\n\t\tif (sshbuf_len(blob) > SSHBUF_SIZE_MAX) {\n\t\t\tr = SSH_ERR_INVALID_FORMAT;\n\t\t\tgoto out;\n\t\t}\n\t}\n\tif ((st.st_mode & (S_IFSOCK|S_IFCHR|S_IFIFO)) == 0 &&\n\t    st.st_size != (off_t)sshbuf_len(blob)) {\n\t\tr = SSH_ERR_FILE_CHANGED;\n\t\tgoto out;\n\t}\n\t \n\t*blobp = blob;\n\tblob = NULL;  \n\tr = 0;\n out:\n\texplicit_bzero(buf, sizeof(buf));\n\tsshbuf_free(blob);\n\treturn r;\n}\n\nint\nsshbuf_load_file(const char *path, struct sshbuf **bufp)\n{\n\tint r, fd, oerrno;\n\n\t*bufp = NULL;\n\tif ((fd = open(path, O_RDONLY)) == -1)\n\t\treturn SSH_ERR_SYSTEM_ERROR;\n\tif ((r = sshbuf_load_fd(fd, bufp)) != 0)\n\t\tgoto out;\n\t \n\tr = 0;\n out:\n\toerrno = errno;\n\tclose(fd);\n\tif (r != 0)\n\t\terrno = oerrno;\n\treturn r;\n}\n\nint\nsshbuf_write_file(const char *path, struct sshbuf *buf)\n{\n\tint fd, oerrno;\n\n\tif ((fd = open(path, O_WRONLY | O_CREAT | O_TRUNC, 0644)) == -1)\n\t\treturn SSH_ERR_SYSTEM_ERROR;\n\tif (atomicio(vwrite, fd, sshbuf_mutable_ptr(buf),\n\t    sshbuf_len(buf)) != sshbuf_len(buf) || close(fd) != 0) {\n\t\toerrno = errno;\n\t\tclose(fd);\n\t\tunlink(path);\n\t\terrno = oerrno;\n\t\treturn SSH_ERR_SYSTEM_ERROR;\n\t}\n\treturn 0;\n}\n\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}