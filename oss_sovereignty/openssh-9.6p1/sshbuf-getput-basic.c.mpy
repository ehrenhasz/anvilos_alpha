{
  "module_name": "sshbuf-getput-basic.c",
  "hash_id": "a3fa643359a33aae77d694705bbdf13daa6e28e42524dbfa97cc49e2f24e6ae7",
  "original_prompt": "Ingested from openssh-9.6p1/sshbuf-getput-basic.c",
  "human_readable_source": " \n \n\n#define SSHBUF_INTERNAL\n#include \"includes.h\"\n\n#include <sys/types.h>\n\n#include <stdarg.h>\n#include <stdlib.h>\n#include <stdio.h>\n#include <string.h>\n#ifdef HAVE_STDINT_H\n# include <stdint.h>\n#endif\n\n#include \"ssherr.h\"\n#include \"sshbuf.h\"\n\nint\nsshbuf_get(struct sshbuf *buf, void *v, size_t len)\n{\n\tconst u_char *p = sshbuf_ptr(buf);\n\tint r;\n\n\tif ((r = sshbuf_consume(buf, len)) < 0)\n\t\treturn r;\n\tif (v != NULL && len != 0)\n\t\tmemcpy(v, p, len);\n\treturn 0;\n}\n\nint\nsshbuf_get_u64(struct sshbuf *buf, u_int64_t *valp)\n{\n\tconst u_char *p = sshbuf_ptr(buf);\n\tint r;\n\n\tif ((r = sshbuf_consume(buf, 8)) < 0)\n\t\treturn r;\n\tif (valp != NULL)\n\t\t*valp = PEEK_U64(p);\n\treturn 0;\n}\n\nint\nsshbuf_get_u32(struct sshbuf *buf, u_int32_t *valp)\n{\n\tconst u_char *p = sshbuf_ptr(buf);\n\tint r;\n\n\tif ((r = sshbuf_consume(buf, 4)) < 0)\n\t\treturn r;\n\tif (valp != NULL)\n\t\t*valp = PEEK_U32(p);\n\treturn 0;\n}\n\nint\nsshbuf_get_u16(struct sshbuf *buf, u_int16_t *valp)\n{\n\tconst u_char *p = sshbuf_ptr(buf);\n\tint r;\n\n\tif ((r = sshbuf_consume(buf, 2)) < 0)\n\t\treturn r;\n\tif (valp != NULL)\n\t\t*valp = PEEK_U16(p);\n\treturn 0;\n}\n\nint\nsshbuf_get_u8(struct sshbuf *buf, u_char *valp)\n{\n\tconst u_char *p = sshbuf_ptr(buf);\n\tint r;\n\n\tif ((r = sshbuf_consume(buf, 1)) < 0)\n\t\treturn r;\n\tif (valp != NULL)\n\t\t*valp = (u_int8_t)*p;\n\treturn 0;\n}\n\nstatic int\ncheck_offset(const struct sshbuf *buf, int wr, size_t offset, size_t len)\n{\n\tif (sshbuf_ptr(buf) == NULL)  \n\t\treturn SSH_ERR_INTERNAL_ERROR;\n\tif (offset >= SIZE_MAX - len)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\tif (offset + len > sshbuf_len(buf)) {\n\t\treturn wr ?\n\t\t    SSH_ERR_NO_BUFFER_SPACE : SSH_ERR_MESSAGE_INCOMPLETE;\n\t}\n\treturn 0;\n}\n\nstatic int\ncheck_roffset(const struct sshbuf *buf, size_t offset, size_t len,\n    const u_char **p)\n{\n\tint r;\n\n\t*p = NULL;\n\tif ((r = check_offset(buf, 0, offset, len)) != 0)\n\t\treturn r;\n\t*p = sshbuf_ptr(buf) + offset;\n\treturn 0;\n}\n\nint\nsshbuf_peek_u64(const struct sshbuf *buf, size_t offset, u_int64_t *valp)\n{\n\tconst u_char *p = NULL;\n\tint r;\n\n\tif (valp != NULL)\n\t\t*valp = 0;\n\tif ((r = check_roffset(buf, offset, 8, &p)) != 0)\n\t\treturn r;\n\tif (valp != NULL)\n\t\t*valp = PEEK_U64(p);\n\treturn 0;\n}\n\nint\nsshbuf_peek_u32(const struct sshbuf *buf, size_t offset, u_int32_t *valp)\n{\n\tconst u_char *p = NULL;\n\tint r;\n\n\tif (valp != NULL)\n\t\t*valp = 0;\n\tif ((r = check_roffset(buf, offset, 4, &p)) != 0)\n\t\treturn r;\n\tif (valp != NULL)\n\t\t*valp = PEEK_U32(p);\n\treturn 0;\n}\n\nint\nsshbuf_peek_u16(const struct sshbuf *buf, size_t offset, u_int16_t *valp)\n{\n\tconst u_char *p = NULL;\n\tint r;\n\n\tif (valp != NULL)\n\t\t*valp = 0;\n\tif ((r = check_roffset(buf, offset, 2, &p)) != 0)\n\t\treturn r;\n\tif (valp != NULL)\n\t\t*valp = PEEK_U16(p);\n\treturn 0;\n}\n\nint\nsshbuf_peek_u8(const struct sshbuf *buf, size_t offset, u_char *valp)\n{\n\tconst u_char *p = NULL;\n\tint r;\n\n\tif (valp != NULL)\n\t\t*valp = 0;\n\tif ((r = check_roffset(buf, offset, 1, &p)) != 0)\n\t\treturn r;\n\tif (valp != NULL)\n\t\t*valp = *p;\n\treturn 0;\n}\n\nint\nsshbuf_get_string(struct sshbuf *buf, u_char **valp, size_t *lenp)\n{\n\tconst u_char *val;\n\tsize_t len;\n\tint r;\n\n\tif (valp != NULL)\n\t\t*valp = NULL;\n\tif (lenp != NULL)\n\t\t*lenp = 0;\n\tif ((r = sshbuf_get_string_direct(buf, &val, &len)) < 0)\n\t\treturn r;\n\tif (valp != NULL) {\n\t\tif ((*valp = malloc(len + 1)) == NULL) {\n\t\t\tSSHBUF_DBG((\"SSH_ERR_ALLOC_FAIL\"));\n\t\t\treturn SSH_ERR_ALLOC_FAIL;\n\t\t}\n\t\tif (len != 0)\n\t\t\tmemcpy(*valp, val, len);\n\t\t(*valp)[len] = '\\0';\n\t}\n\tif (lenp != NULL)\n\t\t*lenp = len;\n\treturn 0;\n}\n\nint\nsshbuf_get_string_direct(struct sshbuf *buf, const u_char **valp, size_t *lenp)\n{\n\tsize_t len;\n\tconst u_char *p;\n\tint r;\n\n\tif (valp != NULL)\n\t\t*valp = NULL;\n\tif (lenp != NULL)\n\t\t*lenp = 0;\n\tif ((r = sshbuf_peek_string_direct(buf, &p, &len)) < 0)\n\t\treturn r;\n\tif (valp != NULL)\n\t\t*valp = p;\n\tif (lenp != NULL)\n\t\t*lenp = len;\n\tif (sshbuf_consume(buf, len + 4) != 0) {\n\t\t \n\t\tSSHBUF_DBG((\"SSH_ERR_INTERNAL_ERROR\"));\n\t\tSSHBUF_ABORT();\n\t\treturn SSH_ERR_INTERNAL_ERROR;\n\t}\n\treturn 0;\n}\n\nint\nsshbuf_peek_string_direct(const struct sshbuf *buf, const u_char **valp,\n    size_t *lenp)\n{\n\tu_int32_t len;\n\tconst u_char *p = sshbuf_ptr(buf);\n\n\tif (valp != NULL)\n\t\t*valp = NULL;\n\tif (lenp != NULL)\n\t\t*lenp = 0;\n\tif (sshbuf_len(buf) < 4) {\n\t\tSSHBUF_DBG((\"SSH_ERR_MESSAGE_INCOMPLETE\"));\n\t\treturn SSH_ERR_MESSAGE_INCOMPLETE;\n\t}\n\tlen = PEEK_U32(p);\n\tif (len > SSHBUF_SIZE_MAX - 4) {\n\t\tSSHBUF_DBG((\"SSH_ERR_STRING_TOO_LARGE\"));\n\t\treturn SSH_ERR_STRING_TOO_LARGE;\n\t}\n\tif (sshbuf_len(buf) - 4 < len) {\n\t\tSSHBUF_DBG((\"SSH_ERR_MESSAGE_INCOMPLETE\"));\n\t\treturn SSH_ERR_MESSAGE_INCOMPLETE;\n\t}\n\tif (valp != NULL)\n\t\t*valp = p + 4;\n\tif (lenp != NULL)\n\t\t*lenp = len;\n\treturn 0;\n}\n\nint\nsshbuf_get_cstring(struct sshbuf *buf, char **valp, size_t *lenp)\n{\n\tsize_t len;\n\tconst u_char *p, *z;\n\tint r;\n\n\tif (valp != NULL)\n\t\t*valp = NULL;\n\tif (lenp != NULL)\n\t\t*lenp = 0;\n\tif ((r = sshbuf_peek_string_direct(buf, &p, &len)) != 0)\n\t\treturn r;\n\t \n\tif (len > 0 &&\n\t    (z = memchr(p , '\\0', len)) != NULL && z < p + len - 1) {\n\t\tSSHBUF_DBG((\"SSH_ERR_INVALID_FORMAT\"));\n\t\treturn SSH_ERR_INVALID_FORMAT;\n\t}\n\tif ((r = sshbuf_skip_string(buf)) != 0)\n\t\treturn -1;\n\tif (valp != NULL) {\n\t\tif ((*valp = malloc(len + 1)) == NULL) {\n\t\t\tSSHBUF_DBG((\"SSH_ERR_ALLOC_FAIL\"));\n\t\t\treturn SSH_ERR_ALLOC_FAIL;\n\t\t}\n\t\tif (len != 0)\n\t\t\tmemcpy(*valp, p, len);\n\t\t(*valp)[len] = '\\0';\n\t}\n\tif (lenp != NULL)\n\t\t*lenp = (size_t)len;\n\treturn 0;\n}\n\nint\nsshbuf_get_stringb(struct sshbuf *buf, struct sshbuf *v)\n{\n\tu_int32_t len;\n\tu_char *p;\n\tint r;\n\n\t \n\tif ((r = sshbuf_peek_string_direct(buf, NULL, NULL)) != 0 ||\n\t    (r = sshbuf_get_u32(buf, &len)) != 0 ||\n\t    (r = sshbuf_reserve(v, len, &p)) != 0 ||\n\t    (r = sshbuf_get(buf, p, len)) != 0)\n\t\treturn r;\n\treturn 0;\n}\n\nint\nsshbuf_put(struct sshbuf *buf, const void *v, size_t len)\n{\n\tu_char *p;\n\tint r;\n\n\tif ((r = sshbuf_reserve(buf, len, &p)) < 0)\n\t\treturn r;\n\tif (len != 0)\n\t\tmemcpy(p, v, len);\n\treturn 0;\n}\n\nint\nsshbuf_putb(struct sshbuf *buf, const struct sshbuf *v)\n{\n\tif (v == NULL)\n\t\treturn 0;\n\treturn sshbuf_put(buf, sshbuf_ptr(v), sshbuf_len(v));\n}\n\nint\nsshbuf_putf(struct sshbuf *buf, const char *fmt, ...)\n{\n\tva_list ap;\n\tint r;\n\n\tva_start(ap, fmt);\n\tr = sshbuf_putfv(buf, fmt, ap);\n\tva_end(ap);\n\treturn r;\n}\n\nint\nsshbuf_putfv(struct sshbuf *buf, const char *fmt, va_list ap)\n{\n\tva_list ap2;\n\tint r, len;\n\tu_char *p;\n\n\tVA_COPY(ap2, ap);\n\tif ((len = vsnprintf(NULL, 0, fmt, ap2)) < 0) {\n\t\tr = SSH_ERR_INVALID_ARGUMENT;\n\t\tgoto out;\n\t}\n\tif (len == 0) {\n\t\tr = 0;\n\t\tgoto out;  \n\t}\n\tva_end(ap2);\n\tVA_COPY(ap2, ap);\n\tif ((r = sshbuf_reserve(buf, (size_t)len + 1, &p)) < 0)\n\t\tgoto out;\n\tif ((r = vsnprintf((char *)p, len + 1, fmt, ap2)) != len) {\n\t\tr = SSH_ERR_INTERNAL_ERROR;\n\t\tgoto out;  \n\t}\n\t \n\tif ((r = sshbuf_consume_end(buf, 1)) != 0)\n\t\tgoto out;\n\tr = 0;\n out:\n\tva_end(ap2);\n\treturn r;\n}\n\nint\nsshbuf_put_u64(struct sshbuf *buf, u_int64_t val)\n{\n\tu_char *p;\n\tint r;\n\n\tif ((r = sshbuf_reserve(buf, 8, &p)) < 0)\n\t\treturn r;\n\tPOKE_U64(p, val);\n\treturn 0;\n}\n\nint\nsshbuf_put_u32(struct sshbuf *buf, u_int32_t val)\n{\n\tu_char *p;\n\tint r;\n\n\tif ((r = sshbuf_reserve(buf, 4, &p)) < 0)\n\t\treturn r;\n\tPOKE_U32(p, val);\n\treturn 0;\n}\n\nint\nsshbuf_put_u16(struct sshbuf *buf, u_int16_t val)\n{\n\tu_char *p;\n\tint r;\n\n\tif ((r = sshbuf_reserve(buf, 2, &p)) < 0)\n\t\treturn r;\n\tPOKE_U16(p, val);\n\treturn 0;\n}\n\nint\nsshbuf_put_u8(struct sshbuf *buf, u_char val)\n{\n\tu_char *p;\n\tint r;\n\n\tif ((r = sshbuf_reserve(buf, 1, &p)) < 0)\n\t\treturn r;\n\tp[0] = val;\n\treturn 0;\n}\n\nstatic int\ncheck_woffset(struct sshbuf *buf, size_t offset, size_t len, u_char **p)\n{\n\tint r;\n\n\t*p = NULL;\n\tif ((r = check_offset(buf, 1, offset, len)) != 0)\n\t\treturn r;\n\tif (sshbuf_mutable_ptr(buf) == NULL)\n\t\treturn SSH_ERR_BUFFER_READ_ONLY;\n\t*p = sshbuf_mutable_ptr(buf) + offset;\n\treturn 0;\n}\n\nint\nsshbuf_poke_u64(struct sshbuf *buf, size_t offset, u_int64_t val)\n{\n\tu_char *p = NULL;\n\tint r;\n\n\tif ((r = check_woffset(buf, offset, 8, &p)) != 0)\n\t\treturn r;\n\tPOKE_U64(p, val);\n\treturn 0;\n}\n\nint\nsshbuf_poke_u32(struct sshbuf *buf, size_t offset, u_int32_t val)\n{\n\tu_char *p = NULL;\n\tint r;\n\n\tif ((r = check_woffset(buf, offset, 4, &p)) != 0)\n\t\treturn r;\n\tPOKE_U32(p, val);\n\treturn 0;\n}\n\nint\nsshbuf_poke_u16(struct sshbuf *buf, size_t offset, u_int16_t val)\n{\n\tu_char *p = NULL;\n\tint r;\n\n\tif ((r = check_woffset(buf, offset, 2, &p)) != 0)\n\t\treturn r;\n\tPOKE_U16(p, val);\n\treturn 0;\n}\n\nint\nsshbuf_poke_u8(struct sshbuf *buf, size_t offset, u_char val)\n{\n\tu_char *p = NULL;\n\tint r;\n\n\tif ((r = check_woffset(buf, offset, 1, &p)) != 0)\n\t\treturn r;\n\t*p = val;\n\treturn 0;\n}\n\nint\nsshbuf_poke(struct sshbuf *buf, size_t offset, void *v, size_t len)\n{\n\tu_char *p = NULL;\n\tint r;\n\n\tif ((r = check_woffset(buf, offset, len, &p)) != 0)\n\t\treturn r;\n\tmemcpy(p, v, len);\n\treturn 0;\n}\n\nint\nsshbuf_put_string(struct sshbuf *buf, const void *v, size_t len)\n{\n\tu_char *d;\n\tint r;\n\n\tif (len > SSHBUF_SIZE_MAX - 4) {\n\t\tSSHBUF_DBG((\"SSH_ERR_NO_BUFFER_SPACE\"));\n\t\treturn SSH_ERR_NO_BUFFER_SPACE;\n\t}\n\tif ((r = sshbuf_reserve(buf, len + 4, &d)) < 0)\n\t\treturn r;\n\tPOKE_U32(d, len);\n\tif (len != 0)\n\t\tmemcpy(d + 4, v, len);\n\treturn 0;\n}\n\nint\nsshbuf_put_cstring(struct sshbuf *buf, const char *v)\n{\n\treturn sshbuf_put_string(buf, v, v == NULL ? 0 : strlen(v));\n}\n\nint\nsshbuf_put_stringb(struct sshbuf *buf, const struct sshbuf *v)\n{\n\tif (v == NULL)\n\t\treturn sshbuf_put_string(buf, NULL, 0);\n\n\treturn sshbuf_put_string(buf, sshbuf_ptr(v), sshbuf_len(v));\n}\n\nint\nsshbuf_froms(struct sshbuf *buf, struct sshbuf **bufp)\n{\n\tconst u_char *p;\n\tsize_t len;\n\tstruct sshbuf *ret;\n\tint r;\n\n\tif (buf == NULL || bufp == NULL)\n\t\treturn SSH_ERR_INVALID_ARGUMENT;\n\t*bufp = NULL;\n\tif ((r = sshbuf_peek_string_direct(buf, &p, &len)) != 0)\n\t\treturn r;\n\tif ((ret = sshbuf_from(p, len)) == NULL)\n\t\treturn SSH_ERR_ALLOC_FAIL;\n\tif ((r = sshbuf_consume(buf, len + 4)) != 0 ||   \n\t    (r = sshbuf_set_parent(ret, buf)) != 0) {\n\t\tsshbuf_free(ret);\n\t\treturn r;\n\t}\n\t*bufp = ret;\n\treturn 0;\n}\n\nint\nsshbuf_put_bignum2_bytes(struct sshbuf *buf, const void *v, size_t len)\n{\n\tu_char *d;\n\tconst u_char *s = (const u_char *)v;\n\tint r, prepend;\n\n\tif (len > SSHBUF_SIZE_MAX - 5) {\n\t\tSSHBUF_DBG((\"SSH_ERR_NO_BUFFER_SPACE\"));\n\t\treturn SSH_ERR_NO_BUFFER_SPACE;\n\t}\n\t \n\tfor (; len > 0 && *s == 0; len--, s++)\n\t\t;\n\t \n\tprepend = len > 0 && (s[0] & 0x80) != 0;\n\tif ((r = sshbuf_reserve(buf, len + 4 + prepend, &d)) < 0)\n\t\treturn r;\n\tPOKE_U32(d, len + prepend);\n\tif (prepend)\n\t\td[4] = 0;\n\tif (len != 0)\n\t\tmemcpy(d + 4 + prepend, s, len);\n\treturn 0;\n}\n\nint\nsshbuf_get_bignum2_bytes_direct(struct sshbuf *buf,\n    const u_char **valp, size_t *lenp)\n{\n\tconst u_char *d;\n\tsize_t len, olen;\n\tint r;\n\n\tif ((r = sshbuf_peek_string_direct(buf, &d, &olen)) < 0)\n\t\treturn r;\n\tlen = olen;\n\t \n\tif ((len != 0 && (*d & 0x80) != 0))\n\t\treturn SSH_ERR_BIGNUM_IS_NEGATIVE;\n\t \n\tif (len > SSHBUF_MAX_BIGNUM + 1 ||\n\t    (len == SSHBUF_MAX_BIGNUM + 1 && *d != 0))\n\t\treturn SSH_ERR_BIGNUM_TOO_LARGE;\n\t \n\twhile (len > 0 && *d == 0x00) {\n\t\td++;\n\t\tlen--;\n\t}\n\tif (valp != NULL)\n\t\t*valp = d;\n\tif (lenp != NULL)\n\t\t*lenp = len;\n\tif (sshbuf_consume(buf, olen + 4) != 0) {\n\t\t \n\t\tSSHBUF_DBG((\"SSH_ERR_INTERNAL_ERROR\"));\n\t\tSSHBUF_ABORT();\n\t\treturn SSH_ERR_INTERNAL_ERROR;\n\t}\n\treturn 0;\n}\n",
  "logic_map": {},
  "failure_modes": [],
  "crash_correlation_map": {}
}